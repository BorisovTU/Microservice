<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
          http://www.liquibase.org/xml/ns/dbchangelog
          http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.22.xsd">

    <changeSet id="release-1.0.0_create_trade_events" author="Borisov-AAlek">

        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="trade_events"/>
            </not>
        </preConditions>

        <createTable tableName="trade_events" remarks="Таблица для хранения обогащённых сделок FX">
            <column name="id" type="UUID" defaultValueComputed="gen_random_uuid()" remarks="Первичный ключ">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="received_at" type="TIMESTAMP" remarks="Время получения">
                <constraints nullable="false"/>
            </column>

            <column name="kafka_topic" type="TEXT" remarks="Топик источника">
                <constraints nullable="false"/>
            </column>

            <column name="kafka_partition" type="INTEGER" remarks="Kafka partition">
                <constraints nullable="false"/>
            </column>

            <column name="kafka_offset" type="BIGINT" remarks="Kafka offset">
                <constraints nullable="false"/>
            </column>

            <column name="external_code" type="TEXT" remarks="Внешний/биржевой идентификатор (externalOrderId)"/>

            <column name="payload" type="JSONB" remarks="Обогащённый JSON">
                <constraints nullable="false"/>
            </column>

            <column name="linked_fk" type="UUID" remarks="Ссылка на TRADES.ID">
                <constraints nullable="true"/>
            </column>

            <column name="status" type="TEXT" defaultValue="new" remarks="Статус обработки: new / processed / failed">
                <constraints nullable="false" checkConstraint="status IN ('new', 'processed', 'failed')"/>
            </column>

            <column name="checksum" type="TEXT" remarks="Хеш SHA256 payload для идемпотентности"/>
        </createTable>

        <createIndex indexName="idx_trade_events_external_code" tableName="trade_events">
            <column name="external_code"/>
        </createIndex>

        <createIndex indexName="idx_trade_events_checksum" tableName="trade_events" unique="true">
            <column name="checksum"/>
        </createIndex>

        <createIndex indexName="idx_trade_events_status" tableName="trade_events">
            <column name="status"/>
        </createIndex>

        <createIndex indexName="idx_trade_events_linked_fk" tableName="trade_events">
            <column name="linked_fk"/>
        </createIndex>

        <rollback>
            <dropTable tableName="trade_events"/>
        </rollback>
    </changeSet>

</databaseChangeLog>