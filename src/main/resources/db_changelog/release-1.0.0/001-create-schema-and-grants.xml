<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.9.xsd">

    <!-- Создание схемы -->
    <changeSet id="001-1" author="borisov-tyur">
        <sql>
            create schema if not exists ${default.schema}
        </sql>
    </changeSet>

    <!-- Установка search_path для текущей сессии -->
    <changeSet id="001-2" author="borisov-tyur">
        <sql>ALTER DATABASE corp_action SET search_path TO ${default.schema}, public;</sql>
        <comment>Установка search_path для базы данных</comment>
    </changeSet>

    <!-- Выдача прав пользователю -->
    <changeSet id="001-3" author="borisov-tyur">
        <sql>
            GRANT USAGE ON SCHEMA ${default.schema} TO ${app.username};
            GRANT CREATE ON SCHEMA ${default.schema} TO ${app.username};
            GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA ${default.schema} TO ${app.username};
            GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA ${default.schema} TO ${app.username};

            -- Права на будущие объекты
            ALTER DEFAULT PRIVILEGES IN SCHEMA ${default.schema} GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO ${app.username};
            ALTER DEFAULT PRIVILEGES IN SCHEMA ${default.schema} GRANT USAGE, SELECT ON SEQUENCES TO ${app.username};
        </sql>
        <comment>Выдача прав пользователю ${app.username} на схему ${default.schema}</comment>
    </changeSet>

</databaseChangeLog>