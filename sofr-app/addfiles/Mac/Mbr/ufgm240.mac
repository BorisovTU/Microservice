/*
  $Name:         ufgm240.mac
  $Module:       Межбанковские расчеты
  $Description:  описание
*/
/****************************************************************************/
/*                   R-Style SoftLab, RS-Bank 6.0                           */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/* Генерация сообщения ED240 транспорта УФЭБС                               */
/*                                                                          */
/*  Имя файла: ufgm240.mac                                                  */
/*  Создан:    04.03.09                                                     */
/****************************************************************************/

import OprInter, BankInter, "ufgenmes.mac", "wluftool.mac";

var ver_st = 1;

const code10 = "/ExTCode1/", 
      code20 = "/ExTCode2/";
const ZeroDate = date(0,0,0);

/* Проверка на содержание нечисловых символов в строке */
macro IsDigitStr( Str )

  var stat = 0, i = 1, ch, DigitString = "0123456789";

      while( (not stat) and (i <= strlen(Str)) )
        ch = SubStr( Str, i, 1 );
        if( not Index( DigitString, ch ))
          stat = 1; 
        end;
        i = i + 1;
      end;

  return stat;

end;

macro GetTypeCodeAndSessionID(Строка, TypeCode);
   var Найдено = 0, type;
   if  ( Index(Строка, code10))
      type = "1";
   elif( Index(Строка, code20))
      type = "2";   
  else
     return false;
  end;

   setParm(1, type);
   return true;
end;
 
macro GenMes( addrMes, addrReq )
  var field_value, TypeCode, SessionID, MesForm;

  SetBuff( wlmes, addrMes );
  SetBuff( wlReq, addrReq );

  var xml:object = ActiveX("Microsoft.XMLDOM");  
  var mes:object;
  var elem:object;

  mes = xml.createElement("ED240");
  mes.setAttribute("xmlns", "urn:cbr-ru:ed:v2.0");

  var ed_nda = NULL;
  ed_nda = EDNoDateAuthor();
  ed_nda.ConstructByTrn(wlmes.TRN);

  mes.setAttribute("EDNo",       ed_nda.EDNo );
  mes.setAttribute("EDDate",     YYYYMMDD(ed_nda.EDDate));
  mes.setAttribute("EDAuthor",   ed_nda.EDAuthor );  
  
  
  if(not GetTypeCodeAndSessionID(wlReq.Queries, TypeCode))
      std.msg("Ошибка: Для формы ED240 в поле 'Сообщение' необходимо |ввести один из фиксированных кодов из справочника");
      return false;
  end;

  mes.setAttribute("ExchangeTypeCode", TypeCode );

  if( strlen(wlreq.InitFormMes) )
    mes.setAttribute( "EDTypeNo", wlreq.InitFormMes );
  end;
  
  if( wlreq.InitDateMes != ZeroDate )
    mes.setAttribute("InquiryDate", YYYYMMDD(wlreq.InitDateMes));
  end;

  var IndexCutStart = 0, IndexCutEnd = 0, ARMNo, Temp;
  if  ( Index(wlReq.Queries, "ARMNo:") )
    
    IndexCutStart = Index(wlReq.Queries, "ARMNo:");
    
    Temp = SubStr( wlReq.Queries, IndexCutStart + 6); 
    
    if( IndexCutEnd = Index(Temp, "\n") )
      Temp = SubStr( Temp, 1, IndexCutEnd);
    end;
    ARMNo = Trim( Temp );
    
    if( (StrLen( ARMNo ) == 2) AND (IsDigitStr( ARMNo ) == 0) )
      mes.setAttribute("ARMNo", ARMNo );
    else
      MsgBoxEx( "Неверно задан номер АРМ получателя (отправителя). Поле ARMNo сообщения заполнено не будет", 0);
    end;
  end;
  
  //Не заполнять
  /*elem = xml.createElement("TimeFromTo");
  elem.setAttribute( "TimeFrom", "" );
  elem.setAttribute( "TimeTo", "" );
  mes.appendChild(elem);
  elem = null;*/
  
  if(TypeCode == "2")
    var data;
    var rs = execSQLSelect( "Select DBMS_LOB.SUBSTR(t_fmtblobdata_xxxx, 1000, 1) from dwlreq_dbt where t_ReqID = :ReqID ", MakeArray(SQLParam("ReqID", wlreq.reqID)));
  
    if( rs and rs.moveNext())
      data = rs.value(0);
    end;
  
  
    var SubPos = Index(data, "/SessID");
    if( (SubStr(data, SubPos, 1) == "/") and (SubStr(data, SubPos+8, 1) == "/"))
      SessionID = int(SubStr(data, SubPos+7, 1));
    end;
  
    if( SessionID and (SessionID >= 1) and (SessionID <= 3) )
      elem = xml.createElement("Session");
      var elem2 = xml.createElement("SessionID");
      elem2.appendChild(xml.createTextNode(SessionID));
      elem.appendChild(elem2);
      mes.appendChild(elem);
    end;
  end;
  
 

  ЗаписатьПолеЛог( "xml", mes.xml, TRUE );
  
  return TRUE; /* Успешное завершение */

  OnError( er ) /* обработка ошибок */
    std.msg(String(er.Message, "|Модуль: ", er.Module, " Строка: ", er.Line));
    return FALSE; 
end;
