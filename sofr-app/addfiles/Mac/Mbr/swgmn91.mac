/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 5.1                      */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/* Генерация сообщения по SWIFT MTn91                                       */
/*                                                                          */
/*  Имя файла: swgmn91.mac                                                  */
/*  Создан:  22.09.00                                         Бабин А.П.    */
/****************************************************************************/

import "swgenmes.mac";

macro GenMes( addrMes, addrPm )
  var field_value, Narrative, Tag;
  SetBuff( wlmes,  addrMes );
  SetBuff( wlpmpaym, addrPm );  

  PrintLog(2,"Генерация сообщения по МТn91");
  
  var RsPaym = RsbPayment( wlpmpaym.PaymentID );
  /* Закомментировано по запросу 25686 - без платежа запрос по форме n91 генерить можно
  
  if ( not СчитатьСвязьЗапросаСУчетнымОбъектом(wlreq.ReqID) )
     std.msg("Запрос по форме n91 можно формировать только по платежу");
     return FALSE;
  end;
  
  */
  
  /* 20 - номер транзакции (документа) */
  ЗаписатьПолеЛог( TransactionReferenceNumberField, wlmes.TRN );

  /* 21 - ссылка */
  ЗаписатьПолеЛог( RelatedReferenceField, "NONREF" );    

  /* 32B - дата валютирования, код валюты, сумма */
  field_value = FillCurrencyOriginalOrderedAmountField( RsPaym );    
  ЗаписатьПолеЛог( ValueDateCurrencyCodeAmountField_B, field_value );      

  /* 52a - банк приказодателя */
  field_value = FillPayerBankField(RsPaym, Tag);
  ЗаписатьПолеВБлокКонтекст0( OrderingInstitutionField+Tag, "52a", field_value);

  /* Восстанавливаем нулевой контекст блока */
  if( not УстановитьКонтекстБлока() )
    RunError("|Ошибка при установке нулевого контекста блока");
    end;

  /* 57a - банк держатель счета */
  field_value = FillAccountWithInstitutionField_n91(RsPaym, Tag);
  ЗаписатьПолеВБлокКонтекст0( AccountWithInstitutionField+Tag, "57a", field_value);

  /* Восстанавливаем нулевой контекст блока */
  if( not УстановитьКонтекстБлока() )
    RunError("|Ошибка при установке нулевого контекста блока");
  end;
  
  /* 71B  - расходы */  
  StrChangeRusXSet( RsPaym.Ground, field_value );
  StrMultyToFormat( field_value, field_value, 35, 6 );
  ЗаписатьПолеЛог( DetailsOfChargesField_B, field_value );

  return TRUE; /* Успешное завершение */

  OnError(er) /* обработка ошибок */
    ExeptionMessage(er);
    return FALSE;
end;