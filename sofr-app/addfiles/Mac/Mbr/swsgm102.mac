/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank v6                       */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/* Генерация сообщения по SWIFT-SB MT102                                    */
/*                                                                          */
/*  Имя файла: swsgm102.mac                                                 */
/*  Создан:  18.03.04                                        Панов А.Б.     */
/****************************************************************************/
import "swsbgmes.mac";

record Party(party);

FILE PaymMulty( pmpaym ) key 6;
FILE RlsMulty ( wlmesrls ) key 0 ;
FILE FormMulty( wlmesfrm ) key 0 ;

var subTRN;

/* Ключевой фильтр на сводные платежи */
macro OneStepMultyPaym( FirstDocMulty, rs:RsdRecordset )
  if( FirstDocMulty )
     return rs.moveFirst;
  else
     return rs.moveNext;
  end;
end;

macro СформироватьРеференсТранзакции(count)
  return string("S102/", subTRN, "/", count);
end;

/* Формирование повторяющихся последовательностей */
macro ЗаписатьПлатежиСводного( publicCharges, publicRate, TotalSum, TotalRecCharges, Is52Present )
  var IsFirst = TRUE, count = 0, field_value, Tag;
  var RsPaym;
  RECORD rcv( pmroute );

  var select;
  var params:TArray = TArray();
  var rs:RsdRecordset;

  select = "select link.t_PurposePayment from dpmlink_dbt link where link.t_InitialPayment = :PaymentID and link.t_LinkKind = :LinkKind";
  params = makeArray(SQLParam( "PaymentID", wlpmpaym.PaymentID ),
                     SQLParam( "LinkKind",  PMLINK_KIND_MULTYPM ));

  rs = execSQLselect( select, params, TRUE );

  while( rs.moveNext )
    IsFirst = FALSE;
    count = count + 1;

    RsPaym = RsbPayment( rs.value(0) );
    
    /* 21 - номер транзакции */
    field_value = СформироватьРеференсТранзакции(count);
    ЗаписатьПолеЛог(RelatedReferenceField, String(field_value));

    /* 32B - код валюты, сумма */
    field_value = FillCurrencyOriginalOrderedAmountField( RsPaym );
    ЗаписатьПолеЛог( ValueDateCurrencyCodeAmountField_B, field_value );


    /* 50a - приказодатель */
    /* 50A - приказодатель */
        /* Устанавливаем контекст блока '50a' */
        if( not УстановитьКонтекстБлока( "50a" ) )
          RunError("|Ошибка при установке контекста блока '50a'");
        end;
    field_value = FillOrderingCustomerField103_A(RsPaym);
    /* 50K - приказодатель */
    if (field_value == "")
      field_value = FillOrderingCustomerField_SB( RsPaym, NULL );  
      if (field_value=="")
        std.out( 2, "PaymentID: " + RsPaym.PaymentID );
        RunError( "|Не найден плательщик" );
      end;
        ЗаписатьПолеЛог( OrderingCustomerField_K, field_value );    
      else
        ЗаписатьПолеЛог( OrderingCustomerField_A, field_value );    
      end;
      /* Восстанавливаем контекст блока 'Sequence B' */
      if( not УстановитьКонтекстБлока( ".." ) )
        RunError("|Ошибка при установке контекста блока 'Sequence B' ");
      end;

  
    /* 52a - банк приказодателя */
      if (not УстановитьКонтекстБлока("52a"))
        RunError("|Ошибка при установке контекста блока '52a'");
      end;
    field_value = FillOrderingInstitutionFieldA_SB(RsPaym, Tag );
    if (field_value == "")
      field_value = FillOrderingInstitutionFieldB_SB(RsPaym, Tag );
    end;
      ЗаписатьПолеЛог(OrderingInstitutionField+Tag, field_value);
    /* Восстанавливаем контекст блока 'Sequence B' */
      if (not УстановитьКонтекстБлока(".."))
        RunError("|Ошибка при установке контекста блока 'Sequence B'");
      end;

    /* 57a - банк бенефициара */
    if( ПолучитьУзелПолучателяПлатежа(PaymMulty.PaymentID,rcv) AND
        ПолучитьСамыйДальнийУзелПлатежа(PaymMulty.PaymentID, RTDIR_OUT, Route) AND
        (rcv.RouteID!=Route.RouteID) )    
      if ( Route.CodeKind==PTCK_SWIFT )
         ЗаписатьПолеМаршрутаЛог_SB( AccountWithInstitutionField, "57a", Route, SWIFT_Tag_A );
      else
         ЗаписатьПолеМаршрутаЛог_SB( AccountWithInstitutionField, "57a", Route, SWIFT_Tag_C );
      end;
      /* Восстанавливаем контекст блока 'Sequence B' */
      if( not УстановитьКонтекстБлока( ".." ) )
        RunError("|Ошибка при установке контекста блока 'Sequence B' ");
      end;
    end;
    
    /* 59a - бенефициар */
      if( not УстановитьКонтекстБлока( "59a" ) )
        RunError("|Ошибка при установке контекста блока '59a'");
      end;
    field_value = FillBeneficiaryCustomerFieldA_SB( RsPaym );/*59A*/
    if (field_value == "")
      field_value = FillBeneficiaryCustomerField_SB( RsPaym , NULL, true);/*59*/
      if ( field_value=="" )
        std.out( 2, "PaymentID: " + RsPaym.PaymentID );
        RunError( "|Не найден получатель" );
      end;
      ЗаписатьПолеЛог( BeneficiaryCustomerField, field_value );
    else
      ЗаписатьПолеЛог( BeneficiaryCustomerField_A, field_value );
    end;
    /* Восстанавливаем контекст блока 'Sequence B' */
    if( not УстановитьКонтекстБлока( ".." ) )
      RunError("|Ошибка при установке контекста блока 'Sequence B' ");
    end;

    /* 70  - информация для бенефициара */
    field_value = FillDetailsOfPaymentField( RsPaym, ALLOWCODES70_MT102_STANDART );
    ЗаписатьПолеЛог( DetailsOfPaymentField, field_value );

    /* 33B - Инструктируемая сумма, валюта */
    if( (RsPaym.OrderAmount != 0) and ((RsPaym.OrderAmount != RsPaym.FutureBaseAmount) or 
                                       (RsPaym.OrderFIID != RsPaym.BaseFIID)) 
      )

      field_value = ПолучитьКодВалютыЛог( RsPaym.OrderFIID ) + GetSWIFTAmount( RsPaym.OrderAmount );
      ЗаписатьПолеЛог( CurrencyOriginalOrderedAmountField, field_value );
    end;

    /* 71A - расходы */
   
    field_value = GetCommisCode (RsPaym.ComissCharges);
         ЗаписатьПолеЛог( DetailsOfChargesField_A, field_value ) ;

    /* 71F */
    if( field_value == CHARGES_BEN )
      field_value = ПолучитьКодВалютыЛог( RsPaym.ReceiverFIID ) + "0";
      if( not УстановитьКонтекстБлока( "71F" ) )
        RunError("|Ошибка при установке контекста блока '71F'");
      end;
      ЗаписатьПолеЛог( SendersChargesField, field_value);
      /* Восстанавливаем контекст блока 'Sequence B' */
      if( not УстановитьКонтекстБлока( ".." ) )
        RunError("|Ошибка при установке контекста блока 'Sequence B' ");
         end;
      end;

      end;
   end;  


macro GenMes( addrMes, addrPm )
  var field_value, field72, error, SumOfAmount, TotalRecCharges, publicCharges, 
      publicRate, publicBankOperationCode, field52Present = false, Tag;
  var RsPaym = RsbPayment( wlpmpaym.PaymentID );  
  RECORD rcv( pmroute );
  RECORD ocb(pmroute);

  SetBuff( wlmes,  addrMes );
  SetBuff( wlpmpaym, addrPm );

  PrintLog(2,"Генерация сообщения по МТ102");

  /* Ищем валютные свойства */
  if( FindPayment( wlpmpaym.PaymentID, 0, 0, 0, 0, true, wlpmpaym, wlpmpropdeb, wlpmpropcred, wlpmrmprop ) != 0 )
    std.out( 2, "PaymentID: " + wlpmpaym.PaymentID );
    RunError( "|Не найден платеж" );
  end;

  SB_CheckFIID( wlpmpaym.BaseFIID );

  /* SN - уникальный системный номер сообщения в СМФР */
  ЗаписатьПолеЛог(УникальныйНомерСообщенияСМФР, wlmes.TRN);

  /* 20 - номер транзакции (документа) */
  ЗаписатьПолеЛог(TransactionReferenceNumberField, wlmes.TRN);
  subTRN = substr(wlmes.TRN, strlen(wlmes.TRN)-5);
 
  /* 23 */
  ЗаписатьПолеЛог(BankOperationCodeField, BANKOPERCODE_CREDIT);
  /* Устанавливаем контекст блока */
  if( not УстановитьКонтекстБлока( "Sequence B" ) )
    RunError("|Ошибка при установке контекста блока 'Sequence B'");
  end;

  ЗаписатьПлатежиСводного( publicCharges, publicRate, SumOfAmount, TotalRecCharges, field52Present );

  /* Восстанавливаем нулевой контекст блока */
  if( not УстановитьКонтекстБлока() )
    RunError("|Ошибка при установке нулевого контекста блока");
  end;

  /* 32A - дата валютирования, код валюты, сумма */
  field_value = GetSWIFTDate( wlpmpaym.OutTransferDate ) +
                FillCurrencyOriginalOrderedAmountField( RsPaym );
  ЗаписатьПолеЛог( ValueDateCurrencyCodeAmountField_A, field_value );
  
  return TRUE; /* Успешное завершение */

  OnError(er) /* обработка ошибок */
    ExeptionMessage(er);
    return FALSE;
end;

