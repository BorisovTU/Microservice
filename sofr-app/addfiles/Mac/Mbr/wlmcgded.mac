/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 5.1                      */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/*                                                                          */
/*  Отказы МЦИ                                                              */
/*                                                                          */
/*  Создан:     03.10.00                                                    */
/*  Программист Бурцев А.А.                                                 */
/****************************************************************************/

import RMInter, wlmcgd, wlmctool, wlfindpm;

macro GenDoc( addrMes )

  var Строка, Причина;

  SetBuff( wlmes, addrMes );

  PrintLog( 2, "Генерация подтверждения отзыва" );

  ClearRecord( wlconf );

  if( not СчитатьПоле( FormFldE57, Строка ) )
    return FALSE;
  end;

  wlconf.Cancel     = KVIT_CALL_BACK;
  wlconf.Number     = wlmes.TRN;
  wlconf.RelatedRef = substr(Строка, 1, 6);
  wlconf.Account    = Свой_Корсчет;

  /* Ищем платеж, на который пришло подтверждение */
  if ( not WldFindPmByTRN( true, wlconf.RelatedRef, wlmes.OutsideAbonentID, СчитатьДату( Строка, 7 ) ) )
     std.msg("Не найден исходящий платеж");
     return false;
  end;

  wlconf.Sum       = wlpmpaym.PayAmount;
  wlconf.DateValue = wlpmpaym.ValueDate;
  wlconf.DKFlag = WL_CREDIT;

  if( СчитатьПоле( FormFldDsc, Причина ) )
     wlconf.Description = Причина;
  end;

  if( not ВставитьПодтверждение( wlconf ) )
    std.msg( "Ошибка при вставке подтверждения" );
    return FALSE;
  end;

  return true;

  OnError(er) /* Обработка ошибок времени выполонения */
    ExeptionMessage(er);
    return FALSE;


end;
