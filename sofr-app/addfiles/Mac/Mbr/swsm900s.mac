/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank v6                       */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/* Генерация сообщения по SWIFT-SB MT900S                                   */
/*                                                                          */
/*  Имя файла: swsm900s.mac                                                 */
/*  Создан:  18.03.04                                        Панов А.Б.     */
/****************************************************************************/
import "swsbgmes.mac";

macro GenMes( addrMes, addrConf )
  var field_value, mes_id:integer, mes_date:date, mes_direct:string;

  SetBuff( wlmes,  addrMes );
  SetBuff( wlconf, addrConf );

  SB_CheckFIID( wlconf.FIID );

  PrintLog(2,"Генерация подтверждения дебета по МТ900S");

  /* SN - уникальный системный номер сообщения в СМФР */
  ЗаписатьПолеЛог(УникальныйНомерСообщенияСМФР, wlmes.TRN);

  /* RN - уникальный системный номер исходного сообщения в СМФР */
  ЗаписатьНомерСвязанногоСообщения_SB( wlconf.RelatedRef, mes_id, mes_date, mes_direct, false );

  /* RT - тип и подтип исходного сообщения */
  field_value = ПолучитьНазваниеФормыСвязаногоСообщенияSB( mes_id );
  if( field_value == "" )
    RunError( String("|Не определен тип и подтип исходного сообщения с референсом: ", wlconf.RelatedRef) );
  end;
  ЗаписатьПолеЛог(ТипИПодтипСообщения, field_value );

  /* 20 - номер транзакции (документа) */
  ЗаписатьПолеЛог(TransactionReferenceNumberField, wlmes.TRN);

  /* 21 Related Reference */
  ЗаписатьПолеЛог(RelatedReferenceField, wlconf.RelatedRef);

  /* 25D - дебетуемый счет */
  ЗаписатьПолеЛог(DebitAccountIdentificationField, wlconf.Account);

  /* 32A - дата валютирования, код валюты, сумма */
  field_value = ДатаПоУмолчанию +
                ПолучитьКодВалютыЛог( wlconf.FIID ) +
                GetSWIFTAmount( wlconf.Sum );
  ЗаписатьПолеЛог( ValueDateCurrencyCodeAmountField_A, field_value );  

  /* MFIELDS */
  СчитатьЗаполненныеПоля( mes_id, field_value);
  ЗаписатьПолеЛог(CopyMandatoryFields, field_value);

  return TRUE; /* успешное завершение */

  OnError(er) /* обработка ошибок */
    ExeptionMessage(er);
    return false;
end;