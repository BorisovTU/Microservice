/*
 $Name:   swgd320.mac
 $Module: MBR
 $Description: Генерация подтверждений МБК по сообщениям SWIFT MT320
*/

/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 5.1                      */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/* Генерация подтверждений МБК по сообщениям SWIFT MT320                    */
/*                                                                          */
/*  Имя файла: swgd320.mac                                                  */
/*  Создан:    29.03.01                                      Алешин А.В.    */
/****************************************************************************/

import "swgendoc.mac";

const BLOCK_A = "A",
      BLOCK_B = "B",
      BLOCK_C = "C",
      BLOCK_D = "D",
      BLOCK_E = "E",
      BLOCK_F = "F",
      BLOCK_G = "G",
      BLOCK_H = "H",
      BLOCK_I = "I";

/* Виды базисов RS-Bank */
const RS_BASIS_30360  = 1,    /* 360 дней в году, 30 в месяце */
      RS_BASIS_ACTACT = 4,    /* в году и в месяце по календарю */
      RS_BASIS_ACT360 = 2,    /* 360 дней в году, в месяце по календ. */
      RS_BASIS_ACT365 = 8,    /* в году и в месяце по календарю без учета високосности */
      RS_BASIS_31360  = 1001; /* 360 дней в году, 31 в месяце */

class DepositConfirmation
 var
  ContextBlock                :string,      /* Контекст блока */
  TRF                         :string,      /* Ссылочный номер операции */
  RelatedRef                  :string,      /* Ссылка */
  ContractNumber              :string,      /* Номер контракта у отправителя */
  CommonRef                   :string,      /* Общий референс операции */
  ValueDate                   :date,        /* Дата валютирования */
  TradeDate                   :date,        /*  */
  MaturityDate                :date,        /*  */
  Currency                    :string,      /* Код валюты */
  Principal                   :moneyl,      /* Сумма перевода */
  Cost                        :moneyl,      /*  */
  TypeOperation               :string,      /*  */
  TypeEvent                   :string,      /*  */
  
  DeliveryAgentAmountPartyA   :Bank,        /*  */
  IntermediaryAmountPartyA    :Bank,        /*  */
  ReceivingAgentAmountPartyA  :Bank,        /*  */
                                          
  DeliveryAgentAmountPartyB   :Bank,        /*  */
  IntermediaryAmountPartyB    :Bank,        /*  */
  ReceivingAgentAmountPartyB  :Bank,        /*  */
                                          
  DeliveryAgentPercentPartyA  :Bank,        /*  */ 
  IntermediaryPercentPartyA   :Bank,        /*  */
  ReceivingAgentPartyA        :Bank,        /*  */
  ReceivingAgentPercentPartyA :Bank,
  
  DeliveryAgentPercentPartyB  :Bank,        /*  */
  IntermediaryPercentPartyB   :Bank,        /*  */
  ReceivingAgentPercentPartyB :Bank,        /*  */
  
  PartyA                      :Bank,        /* Отправитель */
  PartyB                      :Bank,        /* Банк-держатель счета */

  Type                        :integer,     /* тип сделки: размещения/привлечения */
  InterestRate                :string,     /*  */
  Basis                       :string,      /*  */
  RcvInfo                     :TRcvInfo100; /* Информация Получателю поле 72 */

  ContextBlock                = "";
  TRF                         = "";
  CommonRef                   = "";
  ValueDate                   = date(0,0,0);
  TradeDate                   = date(0,0,0);
  MaturityDate                = date(0,0,0);
  Currency                    = "";
  Principal                   = $0;
  Cost                        = $0;
  TypeOperation               = "";
  TypeEvent                   = "";
  
  Type                        = 0;
  InterestRate                = "";
  Basis                       = "";
                            
  RelatedRef                  = "";
  ContractNumber              = "";
end; /* class DepositConfirmation */

var MT320 : DepositConfirmation;

macro Fill20( TRF )
  MT320.TRF = TRF;
  return TRUE;
end;

macro Fill21( RelatedRef )
  MT320.RelatedRef = RelatedRef;
  return TRUE;
end;

macro Fill21N( ContractNumber )
  MT320.ContractNumber = ContractNumber;
  return TRUE;
end;

macro Fill22A( Code )
  MT320.TypeOperation = Code;
  return TRUE;
end;

macro Fill22B( Code )
  MT320.TypeEvent = Code;
  return TRUE;
end;

macro Fill22C( CommonRef )
  MT320.CommonRef = CommonRef;
  return TRUE;
end;

macro Fill32B( Cur, Principal )
  MT320.Currency  = Cur;
  MT320.Principal = moneyl(Principal);
  return TRUE;
end;

macro Fill34E( Cur, Amount, Negative )
  MT320.Cost = moneyl(Amount);
  return TRUE;
end;

macro Fill17R( Symb )
  if( Symb == PARTYS_ROLE_BORROWER )
    MT320.Type = 2305;
  else
    MT320.Type = 2300;
  end;
  return TRUE;
end;

macro Fill30T( Date )
  MT320.TradeDate = Date;
  return TRUE;
end;

macro Fill30V( Date )
  MT320.ValueDate = Date;
  return TRUE;
end;

macro Fill30P( Date )
  MT320.MaturityDate = Date;
  return TRUE;
end;

macro Fill37G( Rate, Symb, Str )
  MT320.InterestRate = Str;
  return TRUE;
end;

macro Fill14D( Basis )
  MT320.Basis = Basis;
  return TRUE;
end;                               

macro Fill53A( BIC, Account, System, Code )
  if( MT320.ContextBlock == BLOCK_C )
    MT320.DeliveryAgentAmountPartyA = Bank( BIC, "", "", Account, System, Code );
  elif( MT320.ContextBlock == BLOCK_D )
    MT320.DeliveryAgentAmountPartyB = Bank( BIC, "", "", Account, System, Code );
  elif( MT320.ContextBlock == BLOCK_E )
    MT320.DeliveryAgentPercentPartyA = Bank( BIC, "", "", Account, System, Code );
  else
    MT320.DeliveryAgentPercentPartyB = Bank( BIC, "", "", Account, System, Code );
  end;
  return TRUE;
end;

macro Fill53D( Address, Account, System, Code )
  if( MT320.ContextBlock == BLOCK_C )
    MT320.DeliveryAgentAmountPartyA = Bank( "", Address, "", Account, System, Code );
  elif( MT320.ContextBlock == BLOCK_D )
    MT320.DeliveryAgentAmountPartyB = Bank( "", Address, "", Account, System, Code );
  elif( MT320.ContextBlock == BLOCK_E )
    MT320.DeliveryAgentPercentPartyA = Bank( "", Address, "", Account, System, Code );
  else
    MT320.DeliveryAgentPercentPartyB = Bank( "", Address, "", Account, System, Code );
  end;
  return TRUE;
end;

macro Fill53J( BIC, Name, Account, System, Code )
  if( MT320.ContextBlock == BLOCK_C )
    MT320.DeliveryAgentAmountPartyA = Bank( BIC, Name, "", Account, System, Code ); 
  elif( MT320.ContextBlock == BLOCK_D )
    MT320.DeliveryAgentAmountPartyB = Bank( BIC, Name, "", Account, System, Code ); 
  elif( MT320.ContextBlock == BLOCK_E )
    MT320.DeliveryAgentPercentPartyA = Bank( BIC, Name, "", Account, System, Code ); 
  else
    MT320.DeliveryAgentPercentPartyB = Bank( BIC, Name, "", Account, System, Code );
  end;
  return TRUE;
end;

macro Fill56A( BIC, Account, System, Code )
  if( MT320.ContextBlock == BLOCK_C )
    MT320.IntermediaryAmountPartyA = Bank( BIC, "", "", Account, System, Code );
  elif( MT320.ContextBlock == BLOCK_D )
    MT320.IntermediaryAmountPartyB = Bank( BIC, "", "", Account, System, Code );
  elif( MT320.ContextBlock == BLOCK_E )
    MT320.IntermediaryPercentPartyA = Bank( BIC, "", "", Account, System, Code );
  else
    MT320.IntermediaryPercentPartyB = Bank( BIC, "", "", Account, System, Code );
  end;
  return TRUE;
end;

macro Fill56D( Address, Account, System, Code )
  if( MT320.ContextBlock == BLOCK_C )
    MT320.IntermediaryAmountPartyA = Bank( "", Address, "", Account, System, Code );
  elif( MT320.ContextBlock == BLOCK_D )
    MT320.IntermediaryAmountPartyB = Bank( "", Address, "", Account, System, Code );
  elif( MT320.ContextBlock == BLOCK_E )
    MT320.IntermediaryPercentPartyA = Bank( "", Address, "", Account, System, Code );
  else
    MT320.IntermediaryPercentPartyB = Bank( "", Address, "", Account, System, Code );
  end;
  return TRUE;
end;

macro Fill56J( BIC, Name, Account, System, Code )
  if( MT320.ContextBlock == BLOCK_C )
    MT320.IntermediaryAmountPartyA = Bank( BIC, Name, "", Account, System, Code ); 
  elif( MT320.ContextBlock == BLOCK_D )
    MT320.IntermediaryAmountPartyB = Bank( BIC, Name, "", Account, System, Code ); 
  elif( MT320.ContextBlock == BLOCK_E )
    MT320.IntermediaryPercentPartyA = Bank( BIC, Name, "", Account, System, Code ); 
  else
    MT320.IntermediaryPercentPartyB = Bank( BIC, Name, "", Account, System, Code );
  end;
  return TRUE;
end;

macro Fill57A( BIC, Account, System, Code )
  if( MT320.ContextBlock == BLOCK_C )
    MT320.ReceivingAgentAmountPartyA = Bank( BIC, "", "", Account, System, Code );
  elif( MT320.ContextBlock == BLOCK_D )
    MT320.ReceivingAgentAmountPartyB = Bank( BIC, "", "", Account, System, Code );
  elif( MT320.ContextBlock == BLOCK_E )
    MT320.ReceivingAgentPercentPartyA = Bank( BIC, "", "", Account, System, Code );
  else
    MT320.ReceivingAgentPercentPartyB = Bank( BIC, "", "", Account, System, Code );
  end;
  return TRUE;
end;

macro Fill57D( Address, Account, System, Code )
  if( MT320.ContextBlock == BLOCK_C )
    MT320.ReceivingAgentAmountPartyA = Bank( "", Address, "", Account, System, Code );
  elif( MT320.ContextBlock == BLOCK_D )
    MT320.ReceivingAgentAmountPartyB = Bank( "", Address, "", Account, System, Code );
  elif( MT320.ContextBlock == BLOCK_E )
    MT320.ReceivingAgentPercentPartyA = Bank( "", Address, "", Account, System, Code );
  else
    MT320.ReceivingAgentPercentPartyB = Bank( "", Address, "", Account, System, Code );
  end;
  return TRUE;
end;

macro Fill57J( BIC, Name, Account, System, Code )
  if( MT320.ContextBlock == BLOCK_C )
    MT320.ReceivingAgentAmountPartyA = Bank( BIC, Name, "", Account, System, Code ); 
  elif( MT320.ContextBlock == BLOCK_D )
    MT320.ReceivingAgentAmountPartyB = Bank( BIC, Name, "", Account, System, Code ); 
  elif( MT320.ContextBlock == BLOCK_E )
    MT320.ReceivingAgentPercentPartyA = Bank( BIC, Name, "", Account, System, Code ); 
  else
    MT320.ReceivingAgentPercentPartyB = Bank( BIC, Name, "", Account, System, Code );
  end;
  return TRUE;
end;

macro Fill82A( BIC, Account, System, Code )
  MT320.PartyA = Bank( BIC, "", "", Account, System, Code );
  return TRUE;
end;

macro Fill82D( Address, Account, System, Code )
  MT320.PartyA = Bank( "", Address, "", Account, System, Code );
  return TRUE;
end;

macro Fill82J( BIC, Name, Account, System, Code )
  MT320.PartyA = Bank( BIC, Name, "", Account, System, Code );
  return TRUE;
end;

macro Fill87A( BIC, Account, System, Code )
  MT320.PartyB = Bank( BIC, "", "", Account, System, Code );
  return TRUE;
end;

macro Fill87D( Address, Account, System, Code )
  MT320.PartyB = Bank( "", Address, "", Account, System, Code );
  return TRUE;
end;

macro Fill87J( BIC, Name, Account, System, Code )
  MT320.PartyB = Bank( BIC, Name, "", Account, System, Code );
  return TRUE;
end;

macro Fill72( Str, Narrative )
  MT320.RcvInfo = TRcvInfo100( Str, Narrative );
  return TRUE;
end;

macro SetBlockA() MT320.ContextBlock = BLOCK_A; return TRUE; end;
macro SetBlockB() MT320.ContextBlock = BLOCK_B; return TRUE; end;
macro SetBlockC() MT320.ContextBlock = BLOCK_C; return TRUE; end;
macro SetBlockD() MT320.ContextBlock = BLOCK_D; return TRUE; end;
macro SetBlockE() MT320.ContextBlock = BLOCK_E; return TRUE; end;
macro SetBlockF() MT320.ContextBlock = BLOCK_F; return TRUE; end;
macro SetBlockG() MT320.ContextBlock = BLOCK_G; return TRUE; end;
macro SetBlockH() MT320.ContextBlock = BLOCK_H; return TRUE; end;
macro SetBlockI() MT320.ContextBlock = BLOCK_I; return TRUE; end;

/* Заполнение списка полей формы  MT320*/
var /* Sequence A */
 Fld15A  = ТПолеФормы( "15A",  FIELD_MANDATORY, "",             "",        "SetBlockA" ),
 Fld20   = ТПолеФормы( "20",   FIELD_MANDATORY, "ReadTRF",      "Fill20",  "" ),
 Fld21   = ТПолеФормы( "21",   FIELD_OPTIONAL,  "ReadTRF",      "Fill21",  "" ),
 Fld22A  = ТПолеФормы( "22A",  FIELD_MANDATORY, "ReadCode",     "Fill22A", "" ),
 Fld94A  = ТПолеФормы( "94A",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld22B  = ТПолеФормы( "22B",  FIELD_MANDATORY, "ReadCode",     "Fill22B", "" ),
 Fld22C  = ТПолеФормы( "22C",  FIELD_MANDATORY, "ReadTRF",      "Fill22C", "" ),
 Fld21N  = ТПолеФормы( "21N",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld82AA = ТПолеФормы( "82A",  FIELD_OPTIONAL,  "ReadA",        "Fill82A", "" ),
 Fld82DA = ТПолеФормы( "82D",  FIELD_OPTIONAL,  "ReadD",        "Fill82D", "" ),
 Fld82JA = ТПолеФормы( "82J",  FIELD_OPTIONAL,  "ReadJ",        "Fill82J", "" ),
 Fld87AA = ТПолеФормы( "87A",  FIELD_OPTIONAL,  "ReadA",        "Fill87A", "" ),
 Fld87DA = ТПолеФормы( "87D",  FIELD_OPTIONAL,  "ReadD",        "Fill87D", "" ),
 Fld87JA = ТПолеФормы( "87J",  FIELD_OPTIONAL,  "ReadJ",        "Fill87J", "" ),
 Fld83AA = ТПолеФормы( "83A",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld83DA = ТПолеФормы( "83D",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld83JA = ТПолеФормы( "83J",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld77D  = ТПолеФормы( "77D",  FIELD_OPTIONAL,  "",             "",        "" ),
 /* Sequence B */
 Fld15B  = ТПолеФормы( "15B",  FIELD_MANDATORY, "",             "",        "SetBlockB" ),
 Fld17R  = ТПолеФормы( "17R",  FIELD_MANDATORY, "ReadSymbol",   "Fill17R", "" ),
 Fld32T  = ТПолеФормы( "30T",  FIELD_MANDATORY, "ReadFullDate", "Fill30T", "" ),
 Fld32V  = ТПолеФормы( "30V",  FIELD_MANDATORY, "ReadFullDate", "Fill30V", "" ),
 Fld32P  = ТПолеФормы( "30P",  FIELD_MANDATORY, "ReadFullDate", "Fill30P", "" ),
 Fld32B  = ТПолеФормы( "32B",  FIELD_MANDATORY, "Read32B",      "Fill32B", "" ),
 Fld32H  = ТПолеФормы( "32H",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld30X  = ТПолеФормы( "30X",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld34E  = ТПолеФормы( "34E",  FIELD_MANDATORY, "ReadCurSum",   "Fill34E", "" ),
 Fld37G  = ТПолеФормы( "37G",  FIELD_MANDATORY, "ReadRate",     "Fill37G", "" ),
 Fld14D  = ТПолеФормы( "14D",  FIELD_MANDATORY, "ReadCode7",    "Fill14D", "" ),
 Fld30F  = ТПолеФормы( "30F",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld38J  = ТПолеФормы( "38J",  FIELD_OPTIONAL,  "",             "",        "" ),
 /* Sequence C */
 Fld15C  = ТПолеФормы( "15C",  FIELD_MANDATORY, "",             "",        "SetBlockC" ),
 Fld53AC = ТПолеФормы( "53A",  FIELD_OPTIONAL,  "ReadA",        "Fill53A", "" ),
 Fld53DC = ТПолеФормы( "53D",  FIELD_OPTIONAL,  "ReadD",        "Fill53D", "" ),
 Fld53JC = ТПолеФормы( "53J",  FIELD_OPTIONAL,  "ReadJ",        "Fill53J", "" ),
 Fld86AC = ТПолеФормы( "86A",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld86DC = ТПолеФормы( "86D",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld86JC = ТПолеФормы( "86J",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld56AC = ТПолеФормы( "56A",  FIELD_OPTIONAL,  "ReadA",        "Fill56A", "" ),
 Fld56DC = ТПолеФормы( "56D",  FIELD_OPTIONAL,  "ReadD",        "Fill56D", "" ),
 Fld56JC = ТПолеФормы( "56J",  FIELD_OPTIONAL,  "ReadJ",        "Fill56J", "" ),
 Fld57AC = ТПолеФормы( "57A",  FIELD_OPTIONAL,  "ReadA",        "Fill57A", "" ),
 Fld57DC = ТПолеФормы( "57D",  FIELD_OPTIONAL,  "ReadD",        "Fill57D", "" ),
 Fld57JC = ТПолеФормы( "57J",  FIELD_OPTIONAL,  "ReadJ",        "Fill57J", "" ),
 Fld58AC = ТПолеФормы( "58A",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld58DC = ТПолеФормы( "58D",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld58JC = ТПолеФормы( "58J",  FIELD_OPTIONAL,  "",             "",        "" ),
 /* Sequence D */
 Fld15D  = ТПолеФормы( "15D",  FIELD_MANDATORY, "",             "",        "SetBlockD" ),
 Fld53AD = ТПолеФормы( "53A",  FIELD_OPTIONAL,  "ReadA",        "Fill53A", "" ),
 Fld53DD = ТПолеФормы( "53D",  FIELD_OPTIONAL,  "ReadD",        "Fill53D", "" ),
 Fld53JD = ТПолеФормы( "53J",  FIELD_OPTIONAL,  "ReadJ",        "Fill53J", "" ),
 Fld86AD = ТПолеФормы( "86A",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld86DD = ТПолеФормы( "86D",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld86JD = ТПолеФормы( "86J",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld56AD = ТПолеФормы( "56A",  FIELD_OPTIONAL,  "ReadA",        "Fill56A", "" ),
 Fld56DD = ТПолеФормы( "56D",  FIELD_OPTIONAL,  "ReadD",        "Fill56D", "" ),
 Fld56JD = ТПолеФормы( "56J",  FIELD_OPTIONAL,  "ReadJ",        "Fill56J", "" ),
 Fld57AD = ТПолеФормы( "57A",  FIELD_OPTIONAL,  "ReadA",        "Fill57A", "" ),
 Fld57DD = ТПолеФормы( "57D",  FIELD_OPTIONAL,  "ReadD",        "Fill57D", "" ),
 Fld57JD = ТПолеФормы( "57J",  FIELD_OPTIONAL,  "ReadJ",        "Fill57J", "" ),
 Fld58AD = ТПолеФормы( "58A",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld58DD = ТПолеФормы( "58D",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld58JD = ТПолеФормы( "58J",  FIELD_OPTIONAL,  "",             "",        "" ),
 /* Sequence E */
 Fld15E  = ТПолеФормы( "15E",  FIELD_OPTIONAL,  "",             "",        "SetBlockE" ),
 Fld53AE = ТПолеФормы( "53A",  FIELD_OPTIONAL,  "ReadA",        "Fill53A", "" ),
 Fld53DE = ТПолеФормы( "53D",  FIELD_OPTIONAL,  "ReadD",        "Fill53D", "" ),
 Fld53JE = ТПолеФормы( "53J",  FIELD_OPTIONAL,  "ReadJ",        "Fill53J", "" ),
 Fld86AE = ТПолеФормы( "86A",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld86DE = ТПолеФормы( "86D",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld86JE = ТПолеФормы( "86J",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld56AE = ТПолеФормы( "56A",  FIELD_OPTIONAL,  "ReadA",        "Fill56A", "" ),
 Fld56DE = ТПолеФормы( "56D",  FIELD_OPTIONAL,  "ReadD",        "Fill56D", "" ),
 Fld56JE = ТПолеФормы( "56J",  FIELD_OPTIONAL,  "ReadJ",        "Fill56J", "" ),
 Fld57AE = ТПолеФормы( "57A",  FIELD_OPTIONAL,  "ReadA",        "Fill57A", "" ),
 Fld57DE = ТПолеФормы( "57D",  FIELD_OPTIONAL,  "ReadD",        "Fill57D", "" ),
 Fld57JE = ТПолеФормы( "57J",  FIELD_OPTIONAL,  "ReadJ",        "Fill57J", "" ),
 Fld58AE = ТПолеФормы( "58A",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld58DE = ТПолеФормы( "58D",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld58JE = ТПолеФормы( "58J",  FIELD_OPTIONAL,  "",             "",        "" ),
 /* Sequence F */
 Fld15F  = ТПолеФормы( "15F",  FIELD_OPTIONAL,  "",             "",        "SetBlockF" ),
 Fld53AF = ТПолеФормы( "53A",  FIELD_OPTIONAL,  "ReadA",        "Fill53A", "" ),
 Fld53DF = ТПолеФормы( "53D",  FIELD_OPTIONAL,  "ReadD",        "Fill53D", "" ),
 Fld53JF = ТПолеФормы( "53J",  FIELD_OPTIONAL,  "ReadJ",        "Fill53J", "" ),
 Fld86AF = ТПолеФормы( "86A",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld86DF = ТПолеФормы( "86D",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld86JF = ТПолеФормы( "86J",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld56AF = ТПолеФормы( "56A",  FIELD_OPTIONAL,  "ReadA",        "Fill56A", "" ),
 Fld56DF = ТПолеФормы( "56D",  FIELD_OPTIONAL,  "ReadD",        "Fill56D", "" ),
 Fld56JF = ТПолеФормы( "56J",  FIELD_OPTIONAL,  "ReadJ",        "Fill56J", "" ),
 Fld57AF = ТПолеФормы( "57A",  FIELD_OPTIONAL,  "ReadA",        "Fill57A", "" ),
 Fld57DF = ТПолеФормы( "57D",  FIELD_OPTIONAL,  "ReadD",        "Fill57D", "" ),
 Fld57JF = ТПолеФормы( "57J",  FIELD_OPTIONAL,  "ReadJ",        "Fill57J", "" ),
 Fld58AF = ТПолеФормы( "58A",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld58DF = ТПолеФормы( "58D",  FIELD_OPTIONAL,  "",             "",        "" ),
 Fld58JF = ТПолеФормы( "58J",  FIELD_OPTIONAL,  "",             "",        "" ),
 /* Sequence G */
 Fld15G  = ТПолеФормы( "15G",  FIELD_OPTIONAL, "",              "",        "SetBlockG" ),
 Fld37L  = ТПолеФормы( "37L",  FIELD_OPTIONAL, "",              "",        "" ),
 Fld33B  = ТПолеФормы( "33B",  FIELD_OPTIONAL, "",              "",        "" ),
 Fld36   = ТПолеФормы( "36",   FIELD_OPTIONAL, "",              "",        "" ),
 Fld33E  = ТПолеФормы( "33E",  FIELD_OPTIONAL, "",              "",        "" ),
 /* Sequence H */                                                        
 Fld15H  = ТПолеФормы( "15H",  FIELD_OPTIONAL, "",              "",        "SetBlockH" ),
 Fld29A  = ТПолеФормы( "29A",  FIELD_OPTIONAL, "",              "",        "" ),
 Fld24D  = ТПолеФормы( "24D",  FIELD_OPTIONAL, "",              "",        "" ),
 Fld84AG = ТПолеФормы( "84A",  FIELD_OPTIONAL, "",              "",        "" ),
 Fld84BG = ТПолеФормы( "84B",  FIELD_OPTIONAL, "",              "",        "" ),
 Fld84DG = ТПолеФормы( "84D",  FIELD_OPTIONAL, "",              "",        "" ),
 Fld84JG = ТПолеФормы( "84J",  FIELD_OPTIONAL, "",              "",        "" ),
 Fld85AG = ТПолеФормы( "85A",  FIELD_OPTIONAL, "",              "",        "" ),
 Fld85BG = ТПолеФормы( "85B",  FIELD_OPTIONAL, "",              "",        "" ),
 Fld85DG = ТПолеФормы( "85D",  FIELD_OPTIONAL, "",              "",        "" ),
 Fld85JG = ТПолеФормы( "85J",  FIELD_OPTIONAL, "",              "",        "" ),
 Fld88AG = ТПолеФормы( "88A",  FIELD_OPTIONAL, "",              "",        "" ),
 Fld88BG = ТПолеФормы( "88B",  FIELD_OPTIONAL, "",              "",        "" ),
 Fld88DG = ТПолеФормы( "88D",  FIELD_OPTIONAL, "",              "",        "" ),
 Fld88JG = ТПолеФормы( "88J",  FIELD_OPTIONAL, "",              "",        "" ),
 Fld71F  = ТПолеФормы( "71F",  FIELD_OPTIONAL, "",              "",        "" ),
 Fld26H  = ТПолеФормы( "26H",  FIELD_OPTIONAL, "",              "",        "" ),
 Fld21G  = ТПолеФормы( "21G",  FIELD_OPTIONAL, "",              "",        "" ),
 Fld72   = ТПолеФормы( "72",   FIELD_OPTIONAL, "",              "",        "" ),

 /* Sequence I */                                                        
 Fld15I  = ТПолеФормы( "15I",  FIELD_OPTIONAL, "",              "",        "SetBlockI" ),
 FldI18A  = ТПолеФормы( "18A",  FIELD_OPTIONAL, "",              "",        "" ),
 FldI30F  = ТПолеФормы( "30F",  FIELD_OPTIONAL, "",              "",        "" ),
 FldI32H  = ТПолеФормы( "32H",  FIELD_OPTIONAL, "",              "",        "" ),
 FldI53AG = ТПолеФормы( "53A",  FIELD_OPTIONAL, "",              "",        "" ),
 FldI53DG = ТПолеФормы( "53D",  FIELD_OPTIONAL, "",              "",        "" ),
 FldI53JG = ТПолеФормы( "53J",  FIELD_OPTIONAL, "",              "",        "" ),
 FldI86AG = ТПолеФормы( "86A",  FIELD_OPTIONAL, "",              "",        "" ),
 FldI86DG = ТПолеФормы( "86D",  FIELD_OPTIONAL, "",              "",        "" ),
 FldI86JG = ТПолеФормы( "86J",  FIELD_OPTIONAL, "",              "",        "" ),
 FldI56AG = ТПолеФормы( "56A",  FIELD_OPTIONAL, "",              "",        "" ),
 FldI56DG = ТПолеФормы( "56D",  FIELD_OPTIONAL, "",              "",        "" ),
 FldI56JG = ТПолеФормы( "56J",  FIELD_OPTIONAL, "",              "",        "" ),
 FldI57AG = ТПолеФормы( "57A",  FIELD_OPTIONAL, "",              "",        "" ),
 FldI57DG = ТПолеФормы( "57D",  FIELD_OPTIONAL, "",              "",        "" ),
 FldI57JG = ТПолеФормы( "57J",  FIELD_OPTIONAL, "",              "",        "" );

macro ConstructMT320( RespID )
  var field_name, field_value, loop = 1, count = 0, wasRead = 1,
      result = TRUE, error, fld, BankCode;

  /* Последовательно считываем поля и заполняем лексемы */
  while( loop )
    fld = ПоляФормы.Value(count);
    if( wasRead AND (not СчитатьПоле( field_name, field_value )) )
      loop = 0;
    else
      /* MsgBox( " field_name :",  field_name, "fld.Name :", fld.Name ); */
      if( (field_name != fld.Name) )
        if( fld.ПолеОбязательно )
          std.msg( "Не указано обязательное поле " + fld.Name );
          result = FALSE;
          loop = 0;
        else
          /* Пропускаем необязательные поля */
          wasRead = 0;
        end;
      else
        if( fld.ОбработатьПолеФормы( field_value ) )
          if( fld.ВыполнитьФункцияБлока  )
            wasRead = 1;
          else
            std.msg("Ошибка при выполнении функции блока " + fld.Name);
            result = FALSE;
            loop = 0;
          end;
        else
          std.msg("Ошибка при обработке поля формы " + fld.Name);
          result = FALSE;
          loop = 0;
        end;
      end;
      count = count + 1;
    end;
  end;

  if( result == FALSE )
    return result;
  end;

  return TRUE;
end; /* ConstructMT320 */


private macro GetDealCode()
var Query,QueryStr = "";
    QueryStr = "select t_value from dwlmesval_dbt                                  "+
                        "where t_mesid =                                                    "+
                        "(select max(t_mesid) from dwlmesval_dbt)  and                      "+
                        "t_fieldid = 1704                                                   ";

    Query = TRsbDataSet(QueryStr);
        if (Query.MoveNext())
       return Query.value;
        end;
        return "";
end;


macro GenDoc( addrMes )
  var error, CorBankID;
  MT320 = DepositConfirmation();
  
  SetBuff( wlmes, addrMes );

  PrintLog(2,"Генерация платежа по МТ320");

  ClearRecord(wldlmm);

  if( not ConstructMT320( wlmes.OutsideAbonentID ) )
    return FALSE;
  end;

  /* Заполнение учетных буферов */
  wldlmm.Principal  = MT320.Principal;
  wldlmm.Cost       = MT320.Cost;
  wldlmm.DealDate   = MT320.TradeDate;
  wldlmm.Start      = MT320.ValueDate;
  wldlmm.Maturity   = MT320.MaturityDate;
  wldlmm.DealCodePS = MT320.CommonRef;

  wldlmm.DealCode   = MT320.ContractNumber;
  wldlmm.DealType   = MT320.Type; 
  wldlmm.Duration   = MT320.MaturityDate - MT320.ValueDate;
  wldlmm.DealCode   = GetDealCode();
  wldlmm.Point      = StrLen( (SubStr(MT320.InterestRate, Index(MT320.InterestRate, ".") + 1 )) );
  if( wldlmm.Point < 4 ) wldlmm.Point = 4; end;
  wldlmm.Price      = Round(DoubleL(MT320.InterestRate) * pow(10, wldlmm.Point),0); 

  /* Тип подтверждения */
  if( MT320.TypeEvent == TYPE_EVENT_CONF )
    wldlmm.Type = DLMM_TYPE_CONF;
  elif( MT320.TypeEvent == TYPE_EVENT_MATU )
    wldlmm.Type = DLMM_TYPE_MATU;
  else
    wldlmm.Type = DLMM_TYPE_ROLL;
  end;

  /* 14D Day Count Fraction */
  if( MT320.Basis == SWIFT_BASIS_360_360 )   
    wldlmm.Basis = RS_BASIS_30360;            /* 360 дней в году, 30 в месяце */
  elif( MT320.Basis == SWIFT_BASIS_ACT_365 )  
    wldlmm.Basis = RS_BASIS_ACTACT;           /* в году и в месяце по календарю */
  elif(MT320.Basis == SWIFT_BASIS_ACT_360)  
    wldlmm.Basis = RS_BASIS_ACT360;           /* 360 дней в году, в месяце по календ. */
  elif(MT320.Basis == SWIFT_BASIS_ACT_360)    
    wldlmm.Basis = RS_BASIS_ACT360;           /* в году и в месяце по календарю без учета високосности */
  else                                   
    MT320.Basis = RS_BASIS_31360;             /* 360 дней в году, 31 в месяце */
  end;

  /* Подтверждение пришло по транспорту SWIFT */
  wldlmm.ConfTpID   = TRANSP_SWIFT; 
 
  if( not ПолучитьФинИнПоISO( MT320.Currency, wlfininstr ) )
    std.msg( "Не определена валюта сообщения по коду ISO: " +  MT320.Currency );
    return FALSE;
  end;

  wldlmm.PFI     = wlfininstr.FIID;
  wldlmm.PartyID = MT320.PartyA.PartyID;
  /* Если не определили, то проставляем респондента */
  if( wldlmm.PartyID == -1 )
    wldlmm.PartyID = wlmes.OutsideAbonentID;
  end;

  /* Платежные инструкции */

  if( MT320.DeliveryAgentAmountPartyB.IsSet() )
    wldlmm.PrincCorrCodeKind = MT320.DeliveryAgentAmountPartyB.CodeKind;
    wldlmm.PrincCorrCode     = MT320.DeliveryAgentAmountPartyB.CodeBank;
    wldlmm.PrincCorrName     = MT320.DeliveryAgentAmountPartyB.Name;
    wldlmm.PrincCorrAccount  = MT320.DeliveryAgentAmountPartyB.Account;
  end;

  if( MT320.IntermediaryAmountPartyA.IsSet() )
    wldlmm.PrincBankCodeKind = MT320.IntermediaryAmountPartyB.CodeKind;
    wldlmm.PrincBankCode     = MT320.IntermediaryAmountPartyB.CodeBank;
    wldlmm.PrincBankName     = MT320.IntermediaryAmountPartyB.Name;
    wldlmm.PrincAccount      = MT320.IntermediaryAmountPartyB.Account;
  end;

  if( MT320.ReceivingAgentAmountPartyA.IsSet() )
    wldlmm.PrincCodeKind     = MT320.ReceivingAgentAmountPartyB.CodeKind;
    wldlmm.PrincCode         = MT320.ReceivingAgentAmountPartyB.CodeBank;
    wldlmm.PrincName         = MT320.ReceivingAgentAmountPartyB.Name;
  end;

  if( MT320.DeliveryAgentAmountPartyA.IsSet() )
    wldlmm.PrincRetCorrCodeKind = MT320.DeliveryAgentAmountPartyA.CodeKind;
    wldlmm.PrincRetCorrCode     = MT320.DeliveryAgentAmountPartyA.CodeBank;
    wldlmm.PrincRetCorrName     = MT320.DeliveryAgentAmountPartyA.Name;
    wldlmm.PrincRetCorrAccount  = MT320.DeliveryAgentAmountPartyA.Account;
  end;

  if( MT320.IntermediaryAmountPartyA.IsSet() )
    wldlmm.PrincRetBankCodeKind = MT320.IntermediaryAmountPartyA.CodeKind;
    wldlmm.PrincRetBankCode     = MT320.IntermediaryAmountPartyA.CodeBank;
    wldlmm.PrincRetBankName     = MT320.IntermediaryAmountPartyA.Name;
    wldlmm.PrincRetAccount      = MT320.IntermediaryAmountPartyA.Account;
  end;

  if( MT320.ReceivingAgentAmountPartyA.IsSet() )
    wldlmm.PrincRetCodeKind     = MT320.ReceivingAgentAmountPartyA.CodeKind;
    wldlmm.PrincRetCode         = MT320.ReceivingAgentAmountPartyA.CodeBank;
    wldlmm.PrincRetName         = MT320.ReceivingAgentAmountPartyA.Name;
  end;

  if( MT320.Type == 2305 )
    if( MT320.DeliveryAgentPercentPartyB.IsSet() )
      wldlmm.PercentCorrCodeKind  = MT320.DeliveryAgentPercentPartyB.CodeKind;
      wldlmm.PercentCorrCode      = MT320.DeliveryAgentPercentPartyB.CodeBank;
      wldlmm.PercentCorrName      = MT320.DeliveryAgentPercentPartyB.Name;
      wldlmm.PercentCorrAccount   = MT320.DeliveryAgentPercentPartyB.Account;
    end;
    
    if( MT320.IntermediaryPercentPartyB.IsSet() )
      wldlmm.PercentBankCodeKind  = MT320.IntermediaryPercentPartyB.CodeKind;
      wldlmm.PercentBankCode      = MT320.IntermediaryPercentPartyB.CodeBank;
      wldlmm.PercentBankName      = MT320.IntermediaryPercentPartyB.Name;
      wldlmm.PercentAccount       = MT320.IntermediaryPercentPartyB.Account;
    end;

    if( MT320.ReceivingAgentPercentPartyB.IsSet() )
      wldlmm.PercentCodeKind      = MT320.ReceivingAgentPercentPartyB.CodeKind;
      wldlmm.PercentCode          = MT320.ReceivingAgentPercentPartyB.CodeBank;
      wldlmm.PercentName          = MT320.ReceivingAgentPercentPartyB.Name;
    end;                          
  else
    if( MT320.DeliveryAgentPercentPartyA.IsSet() )
      wldlmm.PercentCorrCodeKind  = MT320.DeliveryAgentPercentPartyA.CodeKind;
      wldlmm.PercentCorrCode      = MT320.DeliveryAgentPercentPartyA.CodeBank;
      wldlmm.PercentCorrName      = MT320.DeliveryAgentPercentPartyA.Name;
      wldlmm.PercentCorrAccount   = MT320.DeliveryAgentPercentPartyA.Account;
    end;

    if( MT320.IntermediaryPercentPartyB.IsSet() )
      wldlmm.PercentBankCodeKind  = MT320.IntermediaryPercentPartyA.CodeKind;
      wldlmm.PercentBankCode      = MT320.IntermediaryPercentPartyA.CodeBank;
      wldlmm.PercentBankName      = MT320.IntermediaryPercentPartyA.Name;
      wldlmm.PercentAccount       = MT320.IntermediaryPercentPartyA.Account;
    end;

    if( MT320.ReceivingAgentPercentPartyB.IsSet() )
      wldlmm.PercentCodeKind      = MT320.ReceivingAgentPercentPartyA.CodeKind;
      wldlmm.PercentCode          = MT320.ReceivingAgentPercentPartyA.CodeBank;
      wldlmm.PercentName          = MT320.ReceivingAgentPercentPartyA.Name;
    end;                          
  end;

  if( not ВставитьПодтверждениеМБК( wldlmm ) )
    std.msg("Ошибка при сохранении подтверждения МБК");
    return FALSE;
  end;

  return TRUE;

  OnError(er) /* обработка ошибок времени выполнения */
    ExeptionMessage(er);
    return FALSE;
end;

