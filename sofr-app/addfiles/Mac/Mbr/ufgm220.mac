/*
  $Name:         ufgm220.mac
  $Module:       Межбанковские расчеты
  $Description:  Генерация сообщения ED220 транспорта УФЭБС
*/
/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 5.1                      */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/* Генерация сообщения ED220 транспорта УФЭБС                               */
/*                                                                          */
/*  Имя файла: ufgm220.mac                                                  */
/*  Создан:    29.09.04                                  Фомченкова Л.Н.    */
/****************************************************************************/

import OprInter, BankInter, "ufgenmes.mac", "wluftool.mac";

var ver_st = 1;

private macro GetED220Code( Code )
  var rs = execSQLSelect( " Select t_Code "
                          "   From dwlcodes_dbt "
                          "  Where t_AlgNum = :AlgNum "
                          "    and Instr( t_Code, :Code ) > 0 ",
                          MakeArray( SQLParam("AlgNum", 33),
                                     SQLParam("Code", Code)));

  if( rs and rs.MoveNext())
    return rs.value("t_Code");
  else
    return "";   
   end;
end;
 
macro GenMes( addrMes, addrReq )

  var field_value, Период, Тип;

  SetBuff( wlmes,  addrMes );
  SetBuff( wlReq, addrReq );

  var xml:object = ActiveX("Microsoft.XMLDOM");  
  var mes:object;

  mes = xml.createElement("ED220");

  if(ver_st == 1)
     mes.setAttribute("xmlns", "urn:cbr-ru:ed:v1.1");
  else
     mes.setAttribute("xmlns", "urn:cbr-ru:ed:v2.0");
  end;

  var ed_nda = NULL;
  ed_nda = EDNoDateAuthor();
  ed_nda.ConstructByTrn(wlmes.TRN);

  mes.setAttribute("EDNo",       ed_nda.EDNo );
  mes.setAttribute("EDDate",     YYYYMMDD(ed_nda.EDDate));
  mes.setAttribute("EDAuthor",   ed_nda.EDAuthor );  

  mes.setAttribute("EDReceiver", GetEDReceiver(wlreq.RecipientID, wlreq.RecipientcodeKind, wlreq.RecipientCode) );
  var Code = GetED220Code(wlreq.Queries);
  if(strlen(Code) > 0)
    mes.setAttribute("InquiryPeriodCode", substr(Code, 4, 1) );
    mes.setAttribute("EDTypeCode", substr(Code, 5, 1) );
  else
      std.msg("Ошибка: Для формы ED220 в поле 'Сообщение' необходимо |ввести один из фиксированных кодов из справочника");
      return false;
  end;

  ЗаписатьПолеЛог( "xml", mes.xml, TRUE );
  
  return TRUE; /* Успешное завершение */

  OnError( er ) /* обработка ошибок */
    std.msg(String(er.Message, "|Модуль: ", er.Module, " Строка: ", er.Line));
    return FALSE; 
end;

macro GenMesV2( addrMes, addrReq )
  ver_st = 2;
  return GenMes( addrMes, addrReq );
end;
