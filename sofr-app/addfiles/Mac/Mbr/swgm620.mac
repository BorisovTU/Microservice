/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 5.1                      */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/*  Генерация сообщения по SWIFT MT320                                      */
/*                                                                          */
/*  Имя файла: swgm320.mac                                                  */
/*  Создан:  11.04.01                                        Алешин А.В.    */
/****************************************************************************/

import "wlgenmes.mac",funk, "swtools.mac", "wltools.mac", OprInter,fx_globals,dl_prol,dl_lib;
IMPORT BankInter,rsexts, Календарь,FIInter,"osfile.d32", PTinter,"cb_sql.mac",funk;    
import "dlquery.mac";  //SVE
                     
Var pmprop   = TBFile ( "pmprop.dbt", "w" );




 private var СделкаПривлечения = TRUE; /* Тип сделки: размещение/привлечение */
   private var que,aa,ss,ss2,rs4,ss1,su,znach,osu,su1,rs1, rs,rs2,rs3,rs0 ,OurCorAcc,tipss=0;
   private var i,jjj,dd1,D1,D2,kod,error,ldepo,idsd,lkonv,zag,FLL,,nam,u10,u11,u22,u33,u44,u21,u31,u01,u02;


FILE ПодтвержденияМБК( wldlmm ) key 1;

/* Виды базисов RS-Bank */
const RS_BASIS_30360  = 1,    /* 360 дней в году, 30 в месяце */
      RS_BASIS_ACTACT = 4,    /* в году и в месяце по календарю */
      RS_BASIS_ACT360 = 2,    /* 360 дней в году, в месяце по календ. */
      RS_BASIS_ACT365 = 8,    /* в году и в месяце по календарю без учета високосности */
      RS_BASIS_31360  = 1001; /* 360 дней в году, 31 в месяце */


Var pmprop2   = TBFile ( "pmprop.dbt", "w" );

macro ОпределитьГенСоглашение(DealID)
  var rs:object;
  var select:string;
  var params:TArray;
  select = "select ga.t_code, to_char(ga.t_start,'dd.mm.yyyy') from ddl_genagr_dbt ga, ddl_tick_dbt tick " +
            " where ga.t_genagrid = tick.t_genagrid and tick.t_dealid = :DEALID";
  params = makeArray(SQLParam("DealID", DealID));
  rs = execSQLselect(select, params, FALSE);
  
  if( rs.moveNext() )
    if (rs.value(0) == "б/н")
       return rs.value(0);
    else
       return rs.value(0) + " " + rs.value(1);
    end;
  else
    return NULL; 
  end;
end;

macro GetTrans(dealid)
   var query = DL_RSDCommand("select t_conftpid from ddl_tick_dbt where t_dealid = ?");
   query.AddParam(dealid);
   var data = query.Execute();
   if (data.MoveNext() )
      return data.conftpid;
   end;
   return null;
end;

macro GetPercDate(DealID)
    var rs = TRsbDataSet("select t_ValueDate from dpmpaym_dbt where " +
                     "t_DocKind = 102 and t_DocumentID = " + DealID +
                     " and t_Purpose = 11 and t_PaymStatus in (0, 1000) order by t_SubPurpose");

    if (rs.MoveNext())
        return date(rs.ValueDate);
    else
        return date(0,0,0);
    end;
end;

macro GetPaymBaseamount(dealid, purpose)  //SVE получение суммы платежа для корректного расчета поля 32H 
   var sql, data;
   sql = DL_RSDCommand("select t_baseamount from dpmpaym_dbt where t_documentid = ? and t_dockind = 102 and t_purpose = ?");
   sql.AddParam(dealid);
   sql.AddParam(purpose);
   data = sql.Execute;
   if ( data.MoveNext() )
      return data.baseamount;
   end;
   return 0;
end;

macro IsNostro(corrid, fiid)
  var sql = DL_RSDCommand("select t_isnostro from dcorschem_dbt where t_corrid = ? and t_fiid = ?");
  sql.AddParam(corrid);
  sql.AddParam(fiid);
  var data = sql.Execute;
  if ( data.MoveNext() )
     if (data.isnostro == "X")
        return true;
     end;
  end;
  return false;
end;

macro IsResident(partyid)
  var query = DL_RSDCommand("select t_notresident from dparty_dbt where t_partyid = ?");
  query.AddParam(partyid);
  var data = query.Execute();
  if (data.MoveNext() )
     if (data.notresident == "X")
        return false;
     end;
  end;
  return true;
end;

/* Определение типа операции */
macro ОпределитьТипОперации( dlmmbuf, Sending )
  var Found = FALSE;
  record LastDlMM( wldlmm );
 
  /* Определяем, были ли уже отосланы подтверждения c данным типом, ищем последнее из них */
  ПодтвержденияМБК.DealID = dlmmbuf.DealID;
  ПодтвержденияМБК.Direct = dlmmbuf.Direct;     /* Ищем исходящие */ 
  if( not GetEQ( ПодтвержденияМБК ) ) /* Вообще ничего не отсылалось */
    return TYPE_OPERATION_NEWT; /* Тип - новое подтверждение */
  end;

  /* Что-то уже отсылали, проверяем тип */
  if( ПодтвержденияМБК.Type ==  dlmmbuf.Type )
    Found = TRUE;
    Copy( LastDlMM, ПодтвержденияМБК );
  end;
  /* Перебираем остальные */
  while( (Next(ПодтвержденияМБК)  == TRUE)           AND 
	         (ПодтвержденияМБК.DealID == dlmmbuf.DealID) AND 
         (ПодтвержденияМБК.Direct == dlmmbuf.Direct) AND
         (ПодтвержденияМБК.Type   == dlmmbuf.Type) ) 
    Found = TRUE;
    Copy( LastDlMM, ПодтвержденияМБК );
  end;

  setparm( 1, TRUE ); /* Были любые отсылки - нужно заполнять поле 21 */

  if( not Found ) /* С данным типом еще ничего не отсылали */
    return TYPE_OPERATION_NEWT; /* Тип - новое подтверждение */
  end;
/*
  /* Если изменились существенные параметры сделки, считаем что это поправки */
  if( (LastDlMM.DealCodePS != dlmmbuf.DealCodePS) OR
      (LastDlMM.PartyID    != dlmmbuf.PartyID)    OR
      (LastDlMM.DealDate   != dlmmbuf.DealDate)   OR
      (LastDlMM.PFI        != dlmmbuf.PFI)        OR
      (LastDlMM.CFI        != dlmmbuf.CFI)        OR
      (LastDlMM.Start      != dlmmbuf.Start)      OR
      (LastDlMM.Maturity   != dlmmbuf.Maturity)   OR
      (LastDlMM.Expiry     != dlmmbuf.Expiry)     OR
      (LastDlMM.Principal  != dlmmbuf.Principal)  OR
      (LastDlMM.Price      != dlmmbuf.Price)      OR
      (LastDlMM.Basis      != dlmmbuf.Basis)      OR
      (LastDlMM.Duration   != dlmmbuf.Duration)   OR
      (LastDlMM.Pitch      != dlmmbuf.Pitch)      OR
      (LastDlMM.Cost       != dlmmbuf.Cost) )
    return TYPE_OPERATION_AMND;
  end;
*/
  return TYPE_OPERATION_DUPL; /* Иначе считаем, что дубликат */
end;

/* Записать поле */
macro ЗаписатьБанкЛог( BlockName, PartyID, CodeKind, CodeValue, BankName, CorrAccount )
  var field_value = "", Tag, tempv, ID, BankCode, error;
       jjj=jjj+1;

  /* Только по наименованию пока банк не заполняем */
  if( (PartyID != 0) OR ((CodeKind != 0) AND (CodeValue != "")) )
    if( (CodeKind != 0) AND (CodeValue != "") )
      ID = ПолучитьКодСубъекта( CodeValue, CodeKind, error );
      if( error ) RunError( "|Не найден банк c кодом: " + CodeValue + " и видом кода: " + CodeKind ); end;
    else
      ID = PartyID;
    end;

    /* Ищем для субъекта SWIFT-код. Если не нашли - отваливаем,   */
    /* так как настоятельно рекомендуется использовать именно его */
    BankCode = ПолучитьКодСубъекта( ID, PTCK_SWIFT, error );
    if( error ) RunError( "|Не найден SWIFT-код для банка с кодом: "+ CodeValue + " и видом кода: " + CodeKind ); end;
    CodeKind = PTCK_SWIFT;
    
    if( not УстановитьКонтекстБлока( BlockName ) )
      RunError("|Ошибка при установке контекста блока " + BlockName);
    end;
    if (BankCode == "NBRKKZKX" )
        // CorrAccount="316904768 CODE 103";
    end;



    if( (BankCode != "") AND (CodeKind == PTCK_SWIFT) )
      Tag = SWIFT_Tag_A;
    else
      Tag = SWIFT_Tag_D;
    end;

    if( Tag == SWIFT_Tag_A )
//      if( CorrAccount != "" )
        if(strlen(CorrAccount) > 1)
        field_value = field_value + SYMB_SLASH + CorrAccount + SYMB_ENDL;
      end;
      field_value = field_value + BankCode;

      if ((jjj > 2 ) and (FLL == 1 ))
       field_value=field_value+SYMB_ENDL;
       field_value=field_value+zag;
      end;

      ЗаписатьПолеЛог( SubStr( BlockName, 1, 2 ) + Tag, field_value );
    else
      if(strlen(CorrAccount) > 1)
//    if(CorrAccount != "")
        field_value = field_value + SYMB_SLASH + CorrAccount + SYMB_ENDL;
      end;
      if( BankName != "" )      
        StrChangeRusXSet( BankName, tempv );
        StrMultyToFormat( tempv, tempv, 35, 4 );
        field_value = field_value + tempv;
      end;
      if ((jjj > 2 ) and (FLL == 1 ))
       field_value=field_value+SYMB_ENDL;
       field_value=field_value+zag;
      end;

      ЗаписатьПолеЛог( SubStr( BlockName, 1, 2 ) + Tag, field_value );
    end;

    if( not УстановитьКонтекстБлока( ".." ) )
      RunError("|Ошибка при установке контекста блока '..'");
    end;
  end;

end;


macro KSxem(par1,par2)
  private var que,rs01;

    u01=0;
    u02="0";
    que="select b.t_corrid,t_coraccount from dpmprop_dbt a , dcorschem_dbt b  where a.t_paymentid="+par1+" and a.t_debetcredit="+par2+" and b.t_number=a.t_corschem ";
    rs01 = LnGetRecordSet(que);
    if(rs01 != null)
      if (rs01.moveNext) 
          u01=rs01.value(0);
          u02=rs01.value(1);
       end;	
    end;
    return;
end;

macro IsPrevMesFirst(RelatedRef)  //SVE
   var query = DL_RSDCommand("select t_relatedref from dwlmes_dbt where t_trn = ?");
   query.AddParam(RelatedRef);
   var data = query.Execute();
   if (data.MoveNext() )
      if (data.RelatedRef == "")
          return true;
      end;
   end;
   return false;
end;

/* Непосредственно генерация МТ620 */

macro GenMes2( addrMes, addrWlDlMm )
private  var field_value, error, gr, Sending = FALSE, Letter = "",fflag,pplid, 
      PriceStr,u1,PROL,zprol,RS3,u2, ID,i2, IntPart, FactPart, BankCode;
private var que,rs01,rs02;


array mmm;

  SetBuff( wlmes,  addrMes );
  SetBuff( wldlmm, addrWlDlMm );


  PrintLog(2,"Генерация сообщения по МТ320 ");
      zag=" ";
      FLL=0;
        jjj=1;
        idsd=0;

    ss=string(wldlmm.dealcode);
    que = "select t_dealid,t_dealtype  from ddl_tick_dbt  where t_bofficekind=102 and t_dealcode='"+ss+"'";
    rs = LnGetRecordset(que);
                 if(rs != null)
                  if (rs.moveNext)
                      idsd=rs.value(0);
                      tipss=rs.value(1);
                       // plat(rs.value(0),"9",9,u10,u11,u22,u33,u44);
                         
                        /*
                            fflag=execmacrofile("dl_mt.mac", "Kontr320",rs.value(0)) ;
			    if (fflag == 0 )
                                msgbox("Выход без подтверждения !");
                                return FALSE;
                            end;
                        */ 

                        if ( rs.value(1) == 12300 )
                            u11=execmacrofile("dl_mt.mac", "mm_par",rs.value(0),9,"receiverbankid") ;
                            u22=execmacrofile("dl_mt.mac", "mm_par",rs.value(0),9,"receiveraccount") ;

                            u33=execmacrofile("dl_mt.mac", "mm_par",rs.value(0),10,"receiverbankid") ;
                            u44=execmacrofile("dl_mt.mac", "mm_par",rs.value(0),10,"receiveraccount") ;
                        end;



                        if ( rs.value(1) == 12305 )

                            u11=execmacrofile("dl_mt.mac", "mm_par",rs.value(0),9,"receiverbankid") ;
                            u22=execmacrofile("dl_mt.mac", "mm_par",rs.value(0),9,"receiveraccount") ;
                            u33=execmacrofile("dl_mt.mac", "mm_par",rs.value(0),9,"payerbankid") ;
                            u44=execmacrofile("dl_mt.mac", "mm_par",rs.value(0),10,"receiveraccount") ;

                        end;

                          if (u10 == 14 )
			     MSGBOX(" ВЫХОД БЕЗ ПОДТВЕРЖДЕНИЯ ! ");
  				  return FALSE;
  			  else
  			      u21=ПолучитьКодСубъекта( u11, 6);
  			      u31=ПолучитьКодСубъекта( u33, 6);
    		              // msgbox(u21,"-",u22,"-",u31,"-",u44);
			  end;

 		 end;
	        end;



  if( isSale( getOperationGroup( wldlmm.DealType ) ) )
    СделкаПривлечения = FALSE;  /* Это сделка размещения */
    Letter = NEGATIVE_SYMB;
  end;

          wldlmm.PrincRetbankCodeKind=6;
          wldlmm.PrincbankCodeKind=6;




  /* Блок Sequence A */
  УстановитьКонтекстБлокаЛог( "Sequence A" );

  /* 15A New Sequence */
  ЗаписатьПолеЛог( "15A", "" );

  /* 20 Sender's Reference */
//  ЗаписатьПолеЛог( "20", wlmes.TRN );
  ЗаписатьПолеЛог( "20", wldlmm.Dealcode );


  /* Определяем тип операции */
  field_value = ОпределитьТипОперации( wldlmm, Sending );

  /* 21 Related Reference */
//  if( (Sending == TRUE) AND (wlmes.RelatedRef != "") )


  if( wldlmm.Type == DLMM_TYPE_MATU ) /* Ликвидация (завершение) */
  else                  
   //  prol=ПРОЛОНГАЦИЯ(idsd);
     prol=0;
     ss=string(PROL);
    que = "select t_dealcode  from ddl_tick_dbt  where  t_dealid='"+ss+"'";
   rs3 = LnGetRecordset(que);
                 if(rs3 != null)
                  if (rs3.moveNext)
                      prol=string(rs3.value(0));
                      ЗаписатьПолеЛог( "21", prol );
                  end;
                 end;
  end;

  if (field_value == "DUPL")
      field_value="NEWT";
  end;

  /* 22A - Type of Operation */
  ЗаписатьПолеЛог( "22A", field_value );

  zprol=0;

  /* 22B - Type of Event - этап сделки*/
  if( wldlmm.Type == DLMM_TYPE_CONF )   /* Ввод */
    ЗаписатьПолеЛог( "22B", TYPE_EVENT_CONF );
       if( СделкаПривлечения ) 
       else
 //     FLL=1;
       end;
  elif( wldlmm.Type == DLMM_TYPE_MATU ) /* Ликвидация (завершение) */
    ЗаписатьПолеЛог( "22B", TYPE_EVENT_MATU );
  else                                  /* Пролонгация */
    ЗаписатьПолеЛог( "22B", TYPE_EVENT_ROLL );
    zprol=1;
  end;


  /* 22C Common Reference */

  field_value = ПолучитьКодСубъекта( wldlmm.PartyID, PTCK_SWIFT, error );
  if( error ) RunError( "|Не найден SWIFT-код банка-контрагента по сделке" ); end;
  u1 = SubStr(field_value,1,4) + SubStr(field_value,7,2);


   field_value = wldlmm.Price;
  u2=(string(field_value/100));
  u2=int(u2);
  u2=string(u2);
  i2=strlen(u2);
  if (substr(u2,i2,1) == "0")
   u2=substr(u2,1,i2-1);
   i2=i2-1;
      if (substr(u2,i2,1) == "0")
       u2=substr(u2,1,i2-1);
       i2=i2-1;
       end;
  end;
  u2="0000"+u2;
  i2=i2+4;
  u2=substr(u2,i2-3,4);

  u1="EURIKA" + u2 + u1;
//  ЗаписатьПолеЛог( "22C", u1 );



  /* 21N Contract Number Party A */
  // ЗаписатьПолеЛог( "21N", wldlmm.DealCode );
     ЗаписатьПолеЛог( "21N", "" );



  /* 82a Party A */
  BankCode = ПолучитьКодСубъекта( _SelfID, PTCK_SWIFT, error );
  if( error ) RunError( "|Не найден SWIFT-код банка нашего банка" ); end;
  УстановитьКонтекстБлокаЛог( "82a" ); 
  ЗаписатьПолеЛог( "82A", BankCode );

  /* 87a Party B */
  BankCode = ПолучитьКодСубъекта( wldlmm.PartyID, PTCK_SWIFT, error );
  if( error ) RunError( "|Не найден SWIFT-код банка-контрагента по сделке" ); end;
  УстановитьКонтекстБлокаЛог( ".." );  /* Возвращаемся в контекст блока 'Sequence A' */
  УстановитьКонтекстБлокаЛог( "87a" );
  ЗаписатьПолеЛог( "87A", BankCode );

  que="select count(*) from DDL_GENAGR_DBT where t_partyid="+wldlmm.PartyID;
  rs01 = LnGetRecordSet(que);
    if(rs01 != null)
      if (rs01.moveNext) 
        if (int(rs01.value(0)) > 0 )
            que="select t_code from DDL_GENAGR_DBT where t_partyid="+wldlmm.PartyID;
            rs02 = LnGetRecordSet(que);
            if(rs02 != null)
              if (rs02.moveNext) 
                УстановитьКонтекстБлокаЛог( ".." );  /* Возвращаемся в контекст блока 'Sequence A' */
                ЗаписатьПолеЛог( "77D", rs02.value(0));
              end;
            end;
        end;
      end;
    end;


  /* Блок Sequence B*/
  УстановитьКонтекстБлокаЛог( "" );
  УстановитьКонтекстБлокаЛог( "Sequence B" );

  /* 15B New Sequence */
  ЗаписатьПолеЛог( "15B", "" );

  /* 17R Party's A Role */
  if( СделкаПривлечения )
    field_value = PARTYS_ROLE_BORROWER; 
  else
    field_value = PARTYS_ROLE_LENDER;   
  end;
  ЗаписатьПолеЛог( "17R", field_value );

  /* 30T Trade Date */
  ЗаписатьПолеЛог( "30T", GetSWIFTDateFull(wldlmm.DealDate) );

  /* 30V Value Date */
  ЗаписатьПолеЛог( "30V", GetSWIFTDateFull(wldlmm.Start) );

  /* 30P Maturity Date */
  ЗаписатьПолеЛог( "30P", GetSWIFTDateFull(wldlmm.Maturity) );
//  ЗаписатьПолеЛог( "30X", GetSWIFTDateFull(wldlmm.Maturity) );

  /* 32A Currency and Principal Amount */
  field_value = ПолучитьКодВалютыЛог( wldlmm.PFI ) +
                GetSWIFTAmount( wldlmm.Principal );
  ЗаписатьПолеЛог( "32A", field_value );

/*
  /* 32H - Amount ti be Settled */
  if( wldlmm.Type == DLMM_TYPE_MATU )
    field_value = Letter;
    field_value = field_value + ПолучитьКодВалютыЛог( wldlmm.PFI ) +
    "0";
    //              GetSWIFTAmount( wldlmm.Principal + wldlmm.Cost );
        ЗаписатьПолеЛог( "32H", field_value );
        ЗаписатьПолеЛог( "32X", "ROLL" );
  end;
*/

  if( wldlmm.Type == DLMM_TYPE_CONF )   /* Ввод */
  elif( wldlmm.Type == DLMM_TYPE_MATU ) /* Ликвидация (завершение) */
  else                                  /* Пролонгация */
    field_value = ПолучитьКодВалютыЛог( wldlmm.PFI ) + GetSWIFTAmount( wldlmm.Principal); //SVE 488081
    //"0,";
                                                                                                         
    ЗаписатьПолеЛог( "32H", field_value );
  end;

  ЗаписатьПолеЛог( "30X", GetSWIFTDateFull(wldlmm.Maturity) );


  /* 34A Currency and Interest Amount */
  field_value = Letter;
  field_value = ПолучитьКодВалютыЛог( wldlmm.PFI ) +
                GetSWIFTAmount( wldlmm.Cost );
  ЗаписатьПолеЛог( "34A", field_value );

  /* 37G Interest Rate - записываем значение с учетом того, что ставка хранится в двух полях */
  PriceStr = SubStr( String(wldlmm.Price), 1, Index( String(wldlmm.Price), "." ) - 1 );
  if( wldlmm.Point < StrLen(PriceStr) )
    IntPart = SubStr( PriceStr, 1, StrLen(PriceStr) - wldlmm.Point );
  else
    IntPart = "0";
  end;
  if( (wldlmm.Point + 1) > StrLen(PriceStr) )
    FactPart = MkStr( "0", wldlmm.Point - StrLen(PriceStr)) + PriceStr;
  else
    FactPart = SubStr( PriceStr, StrLen(PriceStr)-wldlmm.Point + 1 );
  end;
  ЗаписатьПолеЛог( "37G", GetSWIFTRate( String(IntPart, ",", FactPart) ) );

  /* 14D Day Count Fraction */
  if( wldlmm.Basis == RS_BASIS_30360 )   /* 360 дней в году, 30 в месяце */
    field_value = SWIFT_BASIS_360_360;
  elif(wldlmm.Basis == RS_BASIS_ACTACT)  /* в году и в месяце по календарю */
    field_value = SWIFT_BASIS_ACT_365;
  elif(wldlmm.Basis == RS_BASIS_ACT360)  /* 360 дней в году, в месяце по календ. */
    field_value = SWIFT_BASIS_ACT_360;
  elif(wldlmm.Basis == RS_BASIS_ACT360)  /* в году и в месяце по календарю без учета високосности */
    field_value = SWIFT_BASIS_ACT_360;
  else                                   /* 360 дней в году, 31 в месяце */
    field_value = SWIFT_BASIS_360_360;
  end;

   if(wldlmm.Basis == 8)  /* в году и в месяце по календарю */
    field_value = SWIFT_BASIS_ACT_365;
   end;

  ЗаписатьПолеЛог( "14D", field_value );

  /* Блок Sequence C - инструкции по (поставке) оплате сумы сделки стороной A */
  УстановитьКонтекстБлокаЛог( "" );
  УстановитьКонтекстБлокаЛог( "Sequence C" );

  /* 15C New Sequence */
  ЗаписатьПолеЛог( "15C", "" );

  if( СделкаПривлечения )

    /* 57a - Receiving Agent - куда наш контрагент получит свои деньги */



      ЗаписатьБанкЛог( "57a", wldlmm.PartyID, wldlmm.PrincbankCodeKind, u31, "",u44 );

  else

      IF (zprol == 1 )
        if( not УстановитьКонтекстБлока("57a") )
          MSGBOX("Ошибка при установке контекста блока " );
         end;

 
      ЗаписатьПолеЛог( "57D", "ROLL" );
       УстановитьКонтекстБлокаЛог( "" );

      ELSE
    /* 57a - Receiving Agent - куда наш контрагент получит свои деньги */
      ЗаписатьБанкЛог( "57a", wldlmm.PartyID, wldlmm.PrincRetbankCodeKind, u21, "",u22 );
      END;

  end;




  /* Блок Sequence D - инструкции по (поставке) оплате сумы сделки стороной B */
  УстановитьКонтекстБлокаЛог( "" );
  УстановитьКонтекстБлокаЛог( "Sequence D" );

  /* 15D New Sequence */
  ЗаписатьПолеЛог( "15D", "" );
  
  if( СделкаПривлечения )

      IF (zprol == 1 )
        if( not УстановитьКонтекстБлока("57a") )
          MSGBOX("Ошибка при установке контекста блока " );
         end;

 
      ЗаписатьПолеЛог( "57D", "ROLL" );
       УстановитьКонтекстБлокаЛог( "" );



      ELSE

    /* 57a - Receiving Agent - куда мы хотим получить деньги */
    ЗаписатьБанкЛог( "57a", _SelfID, wldlmm.PrincRetbankCodeKind, u21, "", u22 );
      END;

  else


   /* 57a - Receiving Agent - куда мы хотим получить деньги */
       ЗаписатьБанкЛог( "57a", _SelfID, wldlmm.PrincbankCodeKind, u31, "", u44 );
  end;

  /* Платежные инструкции по оплате процентов */
  /* Заполняем только если не совпадают с инструкцией по оплате ОД сделки */
  if( ((wldlmm.PercentCodeKind     !=  0) AND (wldlmm.PercentCodeKind     != wldlmm.PrincRetCodeKind     )) OR
      ((wldlmm.PercentCode         != "") AND (wldlmm.PercentCode         != wldlmm.PrincRetCode         )) OR
      ((wldlmm.PercentBankCodeKind !=  0) AND (wldlmm.PercentBankCodeKind != wldlmm.PrincRetBankCodeKind )) OR
      ((wldlmm.PercentBankCode     != "") AND (wldlmm.PercentBankCode     != wldlmm.PrincRetBankCode     )) OR
      ((wldlmm.PercentCorrCodeKind !=  0) AND (wldlmm.PercentCorrCodeKind != wldlmm.PrincRetCorrCodeKind )) OR
      ((wldlmm.PercentCorrCode     != "") AND (wldlmm.PercentCorrCode     != wldlmm.PrincRetCorrCode     )) )

/*
    if( СделкаПривлечения )
      /* Блок Sequence E - платежные инструкции по оплате процентов стороной A */
      УстановитьКонтекстБлокаЛог( "" );
      УстановитьКонтекстБлокаЛог( "Sequence E" );

      /* 15E New Sequence */
      ЗаписатьПолеЛог( "15E", "" );
    else
      /* Блок Sequence F - инструкции по оплате процентов стороной B */      
      УстановитьКонтекстБлокаЛог( "" );
      УстановитьКонтекстБлокаЛог( "Sequence F" );

      /* 15F New Sequence */
      ЗаписатьПолеЛог( "15F", "" );
    end;
        
    if( (wldlmm.PercentCorrCodeKind != 0) AND (wldlmm.PercentCorrCode != "") )
      /* 53a Delivery Agent - через кого контрагент получит проценты */
      ЗаписатьБанкЛог( "53a", 0, wldlmm.PercentCorrCodeKind, wldlmm.PercentCorrCode, wldlmm.PercentCorrName, wldlmm.PercentCorrAccount );

      /* 56a Intermediary */ 
      ЗаписатьБанкЛог( "56a", 0, wldlmm.PercentBankCodeKind, wldlmm.PercentBankCode, wldlmm.PercentBankName, wldlmm.PercentAccount );
    end;


    /* 57a - Receiving Agent - куда банк хочет получить свои проценты */
    if( СделкаПривлечения )
      ID = wldlmm.PartyID;
    else
      ID = _SelfID;
    end;
    ЗаписатьБанкЛог( "57a", ID, wldlmm.PercentCodeKind, wldlmm.PercentCode, "", "" );
*/
  end;

  que="select count(*) from DDL_GENAGR_DBT where t_tax_amount > 0 and t_partyid="+wldlmm.PartyID;
  rs01 = LnGetRecordSet(que);
    if(rs01 != null)
      if (rs01.moveNext) 
        if (int(rs01.value(0)) > 0 )
            que="select t_tax_amount from DDL_GENAGR_DBT where t_partyid="+wldlmm.PartyID;
            rs02 = LnGetRecordSet(que);
            if(rs02 != null)
              if (rs02.moveNext) 
                УстановитьКонтекстБлокаЛог( "" );
                УстановитьКонтекстБлокаЛог( "Sequence G" );
                // УстановитьКонтекстБлокаЛог( ".." );  /* Возвращаемся в контекст блока 'Sequence A' */
                if (rs02.value(0) > 0 )
                ЗаписатьПолеЛог( "37L", string(rs02.value(0)));
                end;
              end;
            end;
        end;
      end;
    end;

    if (wldlmm.PFI == 0 )
       fll=0;
     end;


  return TRUE; /* Успешное завершение */

  OnError(er) /* обработка ошибок */
    ExeptionMessage(er);
    return FALSE;
end;

