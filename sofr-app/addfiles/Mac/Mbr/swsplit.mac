import likepy;

/* Коррекция начала строки по стандарту SWIFT */
/* Первым символом не может быть ":" или "-", */
/* В этом случае в начале надо добавить " "   */
macro SwiftPrepareLineBegin( source:string ):string
  if( source and InList( SubStr(source, 1, 1), ":", "-" ) )
    return " " + source;
  end;
  return source;
end;

/* Разбиение строки на несколько строк заданной ширины  */
/* по правилам SWIFT                                    */
/*   source - разбиваемая строка                        */
/*   width  - ширина поля                               */
/*   height - высота поля (допустимое количество строк) */
/*   DelEndl - заменить переносы пробелами              */
/*   rest   - разбитый по тем же правилам остаток       */
/* Возвращает строку с расставленными переносами строки */
macro SwiftStrSplit( source:string, width:integer, height:integer, DelEndl:bool, rest:@string ):string

  /* Разделяем то, что уже разбито на строки */
  var initial_lines:TArray;
  var initial_line:string;
  var lines:TArray = TArray();
  var line:string = "";

  if((valtype(DelEndl) != V_UNDEF) and DelEndl == true )
    source = StrSubst(source, "\n", " ");
    source = StrSubst(source, "\t", " ");
  end;
  initial_lines = map( split( source, "\n" ), @SwiftPrepareLineBegin );

  /* Теперь каждую из этих строк разбиваем ещё на строки заданной ширины */
  for( initial_line, initial_lines )

    /* Сначала разделяем строчку на слова */
    var words:TArray = split( initial_line, " " );
    var word:string;
    var delim:string = "";

    line = "";

    for( word, words )
      if(word != "")

        if( (not line) and word and (not delim) )
          word = SwiftPrepareLineBegin( word );
        end;

        /* Очередное слово просто помещается в текущую строку */
        if( ( StrLen( line ) + StrLen( delim ) + StrLen( word ) ) <= width )
          
          line = line + delim + word;
          delim = " ";

        /* Слово не помещается */
        else

         /*   /* Два варианта: */
          /* 1. Слово меньше заданной ширины, тогда его целиком на следующую строку */
          if( StrLen( SwiftPrepareLineBegin( word ) ) <= width )

            lines.value( lines.size ) = line;
            line = SwiftPrepareLineBegin( word );
            delim = " ";

          /* 2. Слово больше заданной ширины, тогда его надо разделять на куски */
            else */
            
            while( word )
              if( not line )
                word = SwiftPrepareLineBegin( word );
              end;
              var nsymbols:integer = width - StrLen( line ) - StrLen( delim );
              line = line + delim + SubStr( word, 1, nsymbols );
              word = SubStr( word, nsymbols + 1 );
              delim = " ";
              if( StrLen(line) >= (width - 1) )
                lines.value( lines.size ) = line;
                delim = "";
                line = "";
              end;
            end;
          /*  end;*/      
        end;

        if( StrLen(line) >= (width - 1) )
          lines.value( lines.size ) = line;
          delim = "";
          line = "";
        end;
      end;
    end;

    if( line )
      lines.value( lines.size ) = line;
      delim = "";
      line = "";
    end;

  end;

  if( lines.size <= height )
    rest = "";
    return join( lines, "\n" );
  else
    /*если не влезло, попробуем убрать переносы, если этого ещё не делали*/
    if((valtype(DelEndl) != V_UNDEF) or DelEndl == false )
      return SwiftStrSplit( source, width, height, true, @rest ); 
    else
      rest = join( subArray( lines, height ), "\n" );
      return join( subArray( lines, 0, height-1 ), "\n" );
    end;
  end;

end;
