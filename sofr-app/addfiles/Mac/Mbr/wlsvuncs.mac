/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 5.1                      */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/*   Отчет о переносе на счет незавершенных                                 */
/*                                                                          */
/*  Имя файла: wlsvuncs.mac                                                 */
/*  Создан:    16.01.04                                       Бабин А.П.    */
/****************************************************************************/

import rsd, "wldoc.mac",likepy,oralib;

var n_err:integer = 0, n_exec:integer = 0;

macro PrintHead( crdate:date )
  [Отчет о помещении платежей на счет незавершенных];
  [Дата помещения платежей на счет незавершенных: ########## ](crdate:z);
  [];
  [+-------------+---------------+-----------------+------------+--------+---------------------------------------------------------+];
  [|      ID     |       №       |      Сумма      |   Дата     |   №    |                      Сообщение                          |];
  [|   платежа   |    платежа    |     платежа     |  платежа   | ошибки |                                                         |];
  [+-------------+---------------+-----------------+------------+--------+---------------------------------------------------------+];  
  n_err = 0;
  n_exec = 0;
end;

macro PrintLine( p_paym, err, message )
   var i, Number;
   var select:string;
   var params:TArray;
   var rs:object;

   array StringArray;

   setbuff (wlpmpaym, p_paym);

   if ( err==0 )
      message = "Помещение на счет незавершенных выполнено успешно";
      n_exec = n_exec + 1;
   else
      n_err = n_err + 1;
   end;   

   select = "select rm.t_Number, rm.t_Date from dpmrmprop_dbt rm where rm.t_PaymentID=:wlpmpaym_PaymentID";
   params = makeArray( SQLParam("wlpmpaym_PaymentID", wlpmpaym.PaymentID));
   rs = execSQLselect( select, params, FALSE );
   rs.moveNext();

   if ( rs.value(0)=="" )
      Number="";
   else
      Number=rs.value(0);
   end;

   StrSplit(StrSubst(message, "|", " " ), StringArray, 56);

         i = 1;
[|############ |############## |################ |############|########| ########################################################|](wlpmpaym.PaymentID:r,Number:r, wlpmpaym.PayAmount:r, substr(string(rs.value(1)),1,10):c, err:c, StringArray(0):l);         
while ( StrLen(StringArray(i) ) > 0)
[|             |               |                 |            |        | ########################################################|](StringArray(i));
           i = i + 1;
         end;

end;

macro PrintFloor
   [+-------------+---------------+-----------------+------------+--------+---------------------------------------------------------+];  
   [              ];
   [Ошибок     - ######](n_err);
   [Обработано - ######](n_exec);
   [Всего      - ######](n_err+n_exec);
end;
