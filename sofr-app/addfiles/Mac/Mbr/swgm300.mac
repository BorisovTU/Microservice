/*
$Name: swgm300.mac
$Module: Межбанковские расчеты
$Description: Генерация сообщения по SWIFT MT300
*/
/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 5.1                      */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/*  Генерация сообщения по SWIFT MT300                                      */
/*                                                                          */
/*  Имя файла: swgm300.mac                                                  */
/*  Создан:  23.09.02                                        Алешин А.В.    */
/****************************************************************************/

import "wlgenmes.mac", "swtools.mac", "wltools.mac", OprInter, FxInter, oralib, likepy, "fxlb.mac", "swgenmes.mac", funk,"dv_categ.mac",dv_lib;
const SWIFT_Tag_J = "J";/*CHVA*/
var СделкаПривлечения = TRUE; /* Тип сделки: размещение/привлечение */
//mda 20.02.2019 если отсутствует счет , выводим это
const NOACC:string = "ACC YOUR INSTRUCTIONS";

/* Определение типа операции */
macro ОпределитьТипОперации( ObjType, ObjID, Sending )
  var rs:object;
  var select:string;
  var params:TArray;
  select = " select lnk.t_ObjID " +
           "   from dwlmeslnk_dbt lnk " +
           " where lnk.t_ObjID   = :ObjID and "+
           "       lnk.t_ObjKind = :ObjType and "+
           "       lnk.t_Direct  = chr(0) ";
  params = makeArray( SQLParam("ObjID",   ObjID),
                      SQLParam("ObjType", ObjType) );
  rs = execSQLselect( select, params, FALSE );

  if( rs.moveNext() )
     SetParm(2, TRUE);
     return TYPE_OPERATION_AMND;
  else
     return TYPE_OPERATION_NEWT; 
  end;
end;

/*PNV 506389*/
PRIVATE MACRO IsCorschem_LORO (corrid, FIid)

        FILE crs(corschem) key 1;
        crs.Number  = corrid;
        crs.FI_Kind = 1;
        crs.FIid = FIid;
        if( getEQ(crs) )
            if (crs.ISNOSTRO == SET_CHAR)
                return false;
            else
                return true;
            end;
        else
            return false;
        end;
END;
/*PNV 506389*/ 

macro ОпределитьГенСоглашение( DealID )
  var rs:object;
  var select:string;
  var params:TArray;
  select = " select ga.t_code " +
           "   from ddl_genagr_dbt ga, ddl_tick_dbt tick " +
           "  where ga.t_genagrid = tick.t_genagrid and tick.t_dealid = :DEALID";
  params = makeArray(SQLParam("DealID", DealID));
  rs = execSQLselect(select, params, FALSE);
  
  if( rs.moveNext() )
    return rs.value(0);
  else
    return NULL; 
  end;
end;

private macro GetLValueCode( iList, iElement ): string
  var rs:object;
  var select:string;
  var params:TArray;
  select = "select lval.t_code " +
           " from dllvalues_dbt lval " +
           " where lval.t_List = :iList and lval.t_Element = :iElement";
  params = makeArray( SQLParam("iList", iList),
                      SQLParam("iLement", iElement) );
  rs = execSQLselect(select, params, FALSE);
  
  if( rs.moveNext() )
    return rs.value(0);
  else
    return ""; 
  end;
end;

private macro GetGenAgrType( DealID )
  var rs:object;
  var select:string;
  var params:TArray;
  select = " select ga.t_type_gs " +
           "   from ddl_genagr_dbt ga, ddl_tick_dbt tick " +
           "  where ga.t_genagrid = tick.t_genagrid and tick.t_dealid = :DEALID";
  params = makeArray(SQLParam("DealID", DealID));
  rs = execSQLselect(select, params, FALSE);
  
  if( rs.moveNext() )
    return rs.value(0);
  else
    return -1; 
  end;
end;

macro ОпределитьДатуГенСоглашения(DealID)
  var rs:object;
  var select:string;
  var params:TArray;
  var day, mon, year;
  var yyyymmdd:string;
  select = "select ga.t_date_genagr " +
           "  from ddl_genagr_dbt ga, ddl_tick_dbt tick " +
           " where ga.t_genagrid = tick.t_genagrid and tick.t_dealid = :DEALID";
  params = makeArray(SQLParam("DealID", DealID));
  rs = execSQLselect(select, params, FALSE);
  if(rs.moveNext())
    return GetSWIFTDateFull(date(rs.value(0)));
  else
    return NULL; 
  end;
end;

private macro PartyIsNotResident( PartyID )
   var PartyObj:RsbParty = RsbParty( PartyID );
   return PartyObj.IsNotResident;
end;
/* Записать поле */
macro ЗаписатьБанкЛог( BlockName, PartyID, CodeKind, CodeValue, BankName, CorrAccount, FIID, Netting )
  FILE bankdprt(bankdprt) key 0;
  record RecordAdress ( adress );

  var field_value = "", Tag, tempv, ID, BankCode, error, INN = "", KPP = "", isNetting;
  
  /*Проверим пришел ли параметр неттинга*/
  GetParm(7, isNetting);
  if (ValType(isNetting) == V_UNDEF)
    isNetting = "";
  end;

  /* Только по наименованию пока банк не заполняем */
  if( (PartyID != 0) OR ((CodeKind != 0) AND (CodeValue != "")) )
    if( (CodeKind != 0) AND (CodeValue != "") )
      ID = ПолучитьКодСубъекта( CodeValue, CodeKind, error );
      if( error ) RunError( "|Не найден банк c кодом: " + CodeValue + " и видом кода: " + CodeKind ); end;
    else
      ID = PartyID;
    end;

    if( not УстановитьКонтекстБлока( BlockName ) )
      RunError("|Ошибка при установке контекста блока " + BlockName);
    end;

    if( FIID != NATCUR )
      BankCode = ПолучитьКодСубъекта( ID, PTCK_SWIFT, error );
      CodeKind = PTCK_SWIFT;
      if( (BankCode != "") AND (CodeKind == PTCK_SWIFT) )
        Tag = SWIFT_Tag_A;
      else
        Tag = SWIFT_Tag_J;/*SWIFT_Tag_D;*/
      end;
    else
      BankCode = ПолучитьКодСубъекта( ID, PTCK_BIC, error );
      CodeKind = PTCK_BIC;
      if( (BankCode != "") AND (CodeKind == PTCK_BIC) )
        Tag = SWIFT_Tag_J;
      else
        BankCode = ПолучитьКодСубъекта( ID, PTCK_SWIFT, error );
        CodeKind = PTCK_SWIFT;
        if( (BankCode != "") AND (CodeKind == PTCK_SWIFT) )
          Tag = SWIFT_Tag_A;
        else
          Tag =SWIFT_Tag_J;/* SWIFT_Tag_D;*/
        end;
      end;
    end;
    
    if (isNetting == "X")
      Tag = SWIFT_Tag_J;/*SWIFT_Tag_D;*/
    end;  

    if( Tag == SWIFT_Tag_A )
      if( CorrAccount != "" )
        field_value = field_value + SYMB_SLASH + CorrAccount + SYMB_ENDL;
      /*mda 20.02.19 Если счет пустой , то NOACC*/
      else
        field_value = field_value + SYMB_SLASH + NOACC + SYMB_ENDL;
      end;
      field_value = field_value + BankCode;
      ЗаписатьПолеЛог( SubStr( BlockName, 1, 2 ) + Tag, field_value );
    else
      /*Chesnokov D.S. 08.02.2019 Нужно обыграть неттинг в 57D делай так*/
      if(isNetting == "X")
        field_value = "/NOSI/NETS";//"NETTING";
      else
        if( (BankName == "") and ( not ПолучитьСубъекта(PartyID, wlparty) ) )
          BankName = wlparty.ShortName;
        end;
        
        if( (BankCode != "") AND (CodeKind == PTCK_BIC) )        
          bankdprt.PartyID = ID;
          GetEQ(bankdprt);
          field_value = "//RU" + BankCode;
          
          if(bankdprt.CorAcc != "")
            field_value = String(field_value, ".", bankdprt.CorAcc, SYMB_ENDL);
          else
            field_value = field_value + SYMB_ENDL;
          end;
          
          INN = RemoveKPP( GetPartyINN( ID, 1 ) );
          KPP = RemoveINN( GetPartyINN( ID, 1 ) );
          if( INN != "" )
            field_value = String(field_value, "INN", INN);
            if ( KPP != "")
              field_value = String(field_value, ".KPP", KPP);
            end;
            field_value = String(field_value, SYMB_ENDL);
          end;
          
          if( BankName != "" )      
            if( (bankdprt.PlaceName!="") AND (Index(strUpr(BankName), strUpr(trim(bankdprt.PlaceName)))==0) )          
              BankName = string( BankName, SYMB_ENDL, trim(bankdprt.Place),trim(bankdprt.PlaceName) );
            end;
            StrChangeRusXSet( BankName, tempv );
            StrMultyToFormat( tempv, tempv, 35, 3 );
            field_value = field_value + tempv;
          end;
        
        else
          if(CorrAccount != "")
            field_value = field_value + SYMB_SLASH + CorrAccount + SYMB_ENDL;
          /*mda 20.02.19 Если счет пустой , то NOACC*/
          else
            field_value = field_value + SYMB_SLASH + NOACC + SYMB_ENDL;
          end;
        
          if( (ID) AND НайтиЮридическийАдресСубъекта(ID,RecordAdress) AND
           (RecordAdress.Place!="") AND (Index(strUpr(BankName), strUpr(trim(RecordAdress.Place)))==0) )          
            if(RecordAdress.CodePlace!="")
              BankName = string( BankName, SYMB_ENDL, trim(RecordAdress.CodePlace),".",trim(RecordAdress.Place) );
            else
              BankName = string( BankName, SYMB_ENDL, trim(RecordAdress.Place) );
            end;
          end;
          StrChangeRusXSet( BankName, tempv );
          StrMultyToFormat( tempv, tempv, 35, 4 );
          field_value = field_value + tempv;
        end;
      end;
      ЗаписатьПолеЛог( SubStr( BlockName, 1, 2 ) + Tag, field_value );  
    end;

    if( not УстановитьКонтекстБлока( ".." ) )
      RunError("|Ошибка при установке контекста блока '..'");
    end;
  end;

end;

macro ПереместитьТочу( CCnvDeal, IsDealSwap, IsDealReverse, Value )
  var cmd, point, i=1;

  cmd = "select T_POINT from ddl_leg_dbt where (T_DEALID = "+ String(CCnvDeal.DealID) + ")and";

  if( (IsDealSwap == TRUE) AND (IsDealReverse == TRUE) )
     cmd = cmd + "(T_LEGID = 1)";
  else
     cmd = cmd + "(T_LEGID = 0)";
  end;

  point = execSQLselect(cmd, NULL, FALSE);

  point.moveNext();

  while( i <= point.fld(0).value )
     i = i+1;
     Value = Value / 10;  
  end;  
      
  return Value;
end;

macro DeleteFakeSymbols( Str ):string
  var resstr = "", symb, i=0;

  for( i, 1, StrLen(str) )
     symb = SubStr(str, i, 1);
     if( (symb != ",") and (symb != ".") )
        resstr = resstr + symb;
     end;
  end;

  return resstr;
end;

macro MakeCommonRef( BIC_A, BIC_B, Rate:string )
  var CommonRef, Bank1, Place1, RefCode, Bank2, Place2, LastNonZero, i, symb;
 
  if( StrLen(BIC_A) < 8 )
     RunError("|SWIFT-код банка нашего банка меньше 8 символов");
  end;

  if( StrLen(BIC_B) < 8 )
     RunError("|SWIFT-код банка-контрагента по сделке меньше 8 символов");
  end;

  if( BIC_A > BIC_B )
     Bank1  = SubStr(BIC_B, 1, 4);
     Place1 = SubStr(BIC_B, 7, 2);
     Bank2  = SubStr(BIC_A, 1, 4);
     Place2 = SubStr(BIC_A, 7, 2);
  else
     Bank1  = SubStr(BIC_A, 1, 4);
     Place1 = SubStr(BIC_A, 7, 2);
     Bank2  = SubStr(BIC_B, 1, 4);
     Place2 = SubStr(BIC_B, 7, 2);
  end;

  Rate = DeleteFakeSymbols(Rate);

  LastNonZero = 0;
  for( i, 1, StrLen(Rate) )
     symb = SubStr(Rate, i, 1);
     if( (symb != "0") and (symb != ",") and (symb != ".") )
        LastNonZero = i;
     end;
  end;

  if( LastNonZero >=4 )
     RefCode = SubStr(Rate, LastNonZero-3, 4);
  else 
     RefCode = SubStr(Rate, 1, LastNonZero);
     while( StrLen(RefCode) < 4 )
        RefCode = "0" + RefCode;
     end;
  end;

  CommonRef = Bank1 + Place1 + RefCode + Bank2 + Place2;

  return CommonRef;
END;

/* Формирование референса сделки:
   DDMMYY CCCC T SSSSS

 CCCC  - код контрагента вида 103 (Кондор),
 T     - тип (0 - одночастная сделка, 1 - первая часть свопа, 2 - вторая часть свопа),
 SSSSS - последние 5 знаков номера сделки
*/
macro СформироватьПоле20(DealDate, PartyID, DealCodePS, IsDealSWAP, IsDealReverse);
   var day, mon, year, СтрокаИтого, s, err;

   СтрокаИтого = "";

   DateSplit(DealDate, day, mon, year);
   СтрокаИтого = СтрокаИтого + string(day:2:o, mon:2:o, SubStr(String(year),3));

   s = ПолучитьКодСубъекта(PartyID, 103, err);
   if(err)
      s = "UNDF";
   else
      s = SubStr(s, 1, 4);
   end;
   СтрокаИтого = СтрокаИтого + s;

   if(IsDealSWAP)
      if(IsDealReverse)
         s = "2";
      else
         s = "1";
      end;
   else
      s = "0";
   end;
   СтрокаИтого = СтрокаИтого + s;

   s = SubStr(DealCodePS, StrLen(DealCodePS) - 4); /* Последние 5 символов номера сделки */
   СтрокаИтого = СтрокаИтого + s;

   return СтрокаИтого
end;


/* Непосредственно генерация МТ300 */
macro GenMes( addrMes, addrDeal, addrOldMes, ObjKind )
  
  FILE crs(corschem) key 1;
  var field_value, error, Sending = FALSE, CCnvDeal, DemandPayment,
      LiabilityPayment, IsDealSWAP, IsDealReverse, PartyID, ObjID, DealCodePS, DealDate,genagrid,
      PartyABIC, PartyBBIC, SwiftRate, IsSale = FALSE, CorrID = 0, CorrAcc = "", Netting = "";
  private var que,rs01,rs02;
  var IsPFI; /* ВР */
  private var tempv;/*CHVA*/

  record Account(account);

  SetBuff(wlmes, addrMes);
  SetBuff(wlndeal, addrDeal);

  PrintLog(2, "Генерация сообщения по МТ300");

  IsDealReverse = IsDealReverseMode();

  if( ObjKind == OBJTYPE_OUTOPER_DV )

     CCnvDeal = DVFirstDocNDeal(wlndeal.DocKind, wlndeal, IIF(IsDealReverse, 2, 1));

     //DemandPayment    = CCnvDeal.ПлатежТреб.rec;
     //LiabilityPayment = CCnvDeal.ПлатежОб.rec;

     DemandPayment    = RsbPayment(CCnvDeal.ПлатежТреб.rec.PaymentID);
     LiabilityPayment = RsbPayment(CCnvDeal.ПлатежОб.rec.PaymentID);

     IsDealSWAP = CCnvDeal.IsSWAP();
     IsSale     = CCnvDeal.IsSale();
     PartyID    = wlndeal.Contractor;
     ObjID      = wlndeal.ID;
/*
     DealCodePS = wlndeal.DealCodePS;
  ВР
*/
     DealCodePS = wlndeal.Code;
     IsPFI      = wlndeal.IsPFI;

     DealDate   = wlndeal.Date;
     /*Chesnokov D.S. Определяем неттинг*/
     Netting    = CCnvDeal.deal.rec.netting;

     if (CCnvDeal.NFI_baseactiv.rec.type == 2)/*PNV если вторая часть проверяем галочку неттинг2*/
         Netting    = CCnvDeal.deal.rec.netting2;
     end;

  elif( ObjKind == OBJTYPE_FXOPER_DV )

     CCnvDeal = DVFirstDocFXDeal(DL_DVFXDEAL, wlndeal, IIF(IsDealReverse, 2, 1));

     DemandPayment    = RsbPayment(CCnvDeal.ПлатежТреб.rec.PaymentID);
     LiabilityPayment = RsbPayment(CCnvDeal.ПлатежОб.rec.PaymentID);

     IsDealSWAP = CCnvDeal.IsSWAP();
     IsSale     = CCnvDeal.IsSale();
     PartyID    = wlndeal.Contractor;
     ObjID      = wlndeal.ID;
/*
     DealCodePS = wlndeal.DealCodePS;
  ВР
*/
     DealCodePS = wlndeal.Code;
     IsPFI      = wlndeal.IsPFI;

     DealDate   = wlndeal.Date;
     /*Chesnokov D.S. Определяем неттинг*/
     Netting    = CCnvDeal.deal.rec.netting;

     if (CCnvDeal.NFI.rec.type == 2)/*PNV если вторая часть проверяем галочку неттинг2*/
         Netting    = CCnvDeal.deal.rec.netting2;
     end;
  else

     IsDealSWAP = IsSWAP(GetOperationGroup(wldeal.DealType));

     if( IsDealSWAP == FALSE )
        CCnvDeal         = RsbConvDeal( wldeal.DealID );
        DemandPayment    = CCnvDeal.DemandPayment;
        LiabilityPayment = CCnvDeal.LiabilityPayment;
     else
        CCnvDeal = RsbSwapDeal( wldeal.DealID );
        if( IsDealReverse == FALSE )
           DemandPayment    = CCnvDeal.DemandPayment;
           LiabilityPayment = CCnvDeal.LiabilityPayment;
        else
           DemandPayment    = CCnvDeal.ReverseDemandPayment;
           LiabilityPayment = CCnvDeal.ReverseLiabilityPayment;
        end;
     end;

     if( FX_IsSale(wldeal.TypeDoc) )
        IsSale = TRUE;
     end;

     PartyID    = wldeal.PartyID;
     ObjID      = wldeal.DealID;
     DealCodePS = wlndeal.Code;
     IsPFI      = wlndeal.IsPFI;

     DealDate   = wldeal.DealDate;
  end;

/*  ВР. Сторона А - всегда наш банк
  if( not IsSale )
*/
     PartyABIC = ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT, error);
     if( error )
        RunError("|Не найден SWIFT-код банка нашего банка");
     end;

     PartyBBIC = ПолучитьКодСубъекта(PartyID, PTCK_SWIFT, error);
     if( error )
        RunError("|Не найден SWIFT-код банка-контрагента по сделке");
     end;
/*
  else
     PartyBBIC = ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT, error);
     if( error )
        RunError("|Не найден SWIFT-код банка нашего банка");
     end;

     PartyABIC = ПолучитьКодСубъекта(PartyID, PTCK_SWIFT, error);
     if( error )
        RunError("|Не найден SWIFT-код банка-контрагента по сделке");
     end;
  end;
*/

  if( ObjKind == OBJTYPE_OUTOPER_DV )
     SwiftRate = GetSWIFTRate(CCnvDeal.nFI_().rec.Price);
  elif( ObjKind == OBJTYPE_FXOPER_DV )
     SwiftRate = GetSWIFTRate(CCnvDeal.nFI.rec.Price);
  else
     if( (IsDealSWAP == TRUE) AND (IsDealReverse == TRUE) )
        field_value = CCnvDeal.ReverseLeg.Rate.asDouble;
     else
        field_value = CCnvDeal.Leg.Rate.asDouble;
     end;
     field_value = ПереместитьТочу(CCnvDeal, IsDealSWAP, IsDealReverse, field_value);
     SwiftRate = GetSWIFTRate( field_value );
  end;

  /* Блок Sequence A */
  УстановитьКонтекстБлокаЛог("Sequence A");

  /* 15A New Sequence */
  ЗаписатьПолеЛог("15A", "");

  var sGenType = "";

  /* 20 Sender's Reference */
/*
  ЗаписатьПолеЛог("20", wlmes.TRN);
  ВР
  ЗаписатьПолеЛог("20", DealCodePS);
*/
  field_value = СформироватьПоле20(DealDate, PartyID, DealCodePS, IsDealSWAP, IsDealReverse);
  StrChangeRusXSet(field_value, sGenType); /* Транслитерация */
  ЗаписатьПолеЛог("20", sGenType);

  /* Определяем тип операции */
  if( IsDealSWAP == TRUE )
     field_value = TYPE_OPERATION_NEWT;
  else
     field_value = ОпределитьТипОперации(ObjKind, ObjID, Sending);
  end;

  /* 21 Related Reference */
  if( (IsDealSWAP == FALSE) AND (Sending == TRUE) AND (wlmes.RelatedRef != "") )
    ЗаписатьПолеЛог("21", wlmes.RelatedRef);
  end;

  /* 22A - Type of Operation */
  ЗаписатьПолеЛог("22A", field_value);

  /* 94A - Scope of Operation */
  ЗаписатьПолеЛог("94A", "BILA");

  /* 22C Common Reference */
/*
  if( IsDealSWAP )
     if( IsDealReverse == false )
        if( DealCodePS == "" )
           field_value = MakeCommonRef(PartyABIC, PartyBBIC, SwiftRate);
        else
           field_value = DealCodePS;
        end;
     else
        field_value = MakeCommonRef(PartyABIC, PartyBBIC, SwiftRate);
     end;
  else
     if( DealCodePS == "" )
        field_value = MakeCommonRef(PartyABIC, PartyBBIC, SwiftRate);
     else
        field_value = DealCodePS;
     end;
  end;
  ВР.
*/
  field_value = MakeCommonRef(PartyABIC, PartyBBIC, SwiftRate);
  ЗаписатьПолеЛог("22C", field_value);

  /* 82a Party A */
  УстановитьКонтекстБлокаЛог("82a");
  ЗаписатьПолеЛог("82A", PartyABIC);

  /* 87a Party B */
  УстановитьКонтекстБлокаЛог("..");  /* Возвращаемся в контекст блока 'Sequence A' */
  УстановитьКонтекстБлокаЛог("87a");
  ЗаписатьПолеЛог("87A", PartyBBIC);

  /* 77D Party A */
  var day, mon, year;
/*
  if( ObjKind == OBJTYPE_OUTOPER_DV )
      sGenType = GetLValueCode(/*OBJTYPE_GENAGR_TYPE*/4017, CCnvDeal.GenAgr().rec.type_gs );
      DateSplit(CCnvDeal.GenAgr().rec.date_genagr,   day, mon, year);

      field_value = sGenType + string(" ", year:4:o, mon:2:o, day:2:o); //CCnvDeal.GetGenAgrCode();
  else
     sGenType = GetLValueCode( /*OBJTYPE_GENAGR_TYPE*/4017, GetGenAgrType(ObjID) );
     DateSplit( ОпределитьДатуГенСоглашения(ObjID),  day, mon, year );

     field_value = sGenType + string(" ", year:4:o, mon:2:o, day:2:o); // ОпределитьГенСоглашение(ObjID);
  end;
  if( ValType(field_value) == V_STRING )
     УстановитьКонтекстБлокаЛог("..");  /* Возвращаемся в контекст блока 'Sequence A' */
     ЗаписатьПолеЛог("77D", field_value);
  end;
*/

  sGenType = "";
  field_value = "";
  genagrid = fx_sd(wlndeal.ID, "genagrid");
  if ( genagrid > 0 )
    que = "select count(*) from DDL_GENAGR_DBT where  t_partyid="+PartyID+" and t_genagrid ="+genagrid;
    rs01 = LnGetRecordSet(que);
    if(rs01 != null)
      if (rs01.moveNext) 
        if (int(rs01.value(0)) > 0 )
          que = "select t_code,to_char(t_date_genagr,'dd.mm.yyyy') from DDL_GENAGR_DBT where t_partyid="+PartyID+" and t_genagrid ="+genagrid;
          rs02 = LnGetRecordSet(que);
          if(rs02 != null)
            if (rs02.moveNext) 
              StrChangeRusXSet(rs02.value(0) + " " + rs02.value(1), sGenType); /* ВР. Транслитерация номера ГС */
            end;
          end;
        end;
      end;
    end;
  end;
  УстановитьКонтекстБлокаЛог( ".." );  /* Возвращаемся в контекст блока 'Sequence A' */
  if(IsPFI)
     field_value = "DERIVATIVE" + SYMB_ENDL;
  end;
  field_value = field_value + sGenType;
  ЗаписатьПолеЛог( "77D", field_value);

/*
  if( ObjKind == OBJTYPE_OUTOPER_DV )
     field_value = GetSWIFTDateFull(CCnvDeal.ДатаСделки());
  else
     field_value = ОпределитьДатуГенСоглашения(ObjID);
  end;
  if( ValType(field_value) == V_STRING )
     ЗаписатьПолеЛог("78D", field_value );
  end;
*/
  /* Блок Sequence B*/
  УстановитьКонтекстБлокаЛог("");
  УстановитьКонтекстБлокаЛог("Sequence B");

  /* 15B New Sequence */
  ЗаписатьПолеЛог("15B", "");

  /* 30T Trade Date */
  ЗаписатьПолеЛог("30T", GetSWIFTDateFull(DealDate));

  /* 30V Value Date */
  if( ObjKind == OBJTYPE_OUTOPER_DV )
     field_value = CCnvDeal.ДатаИсполнения();
  elif( ObjKind == OBJTYPE_FXOPER_DV )
     field_value = CCnvDeal.ДатаИсполнения();
  else
     if( (IsDealSWAP == TRUE) AND (IsDealReverse == TRUE) )
        field_value = CCnvDeal.ReverseValueDate;
     else
        field_value = CCnvDeal.ValueDate;
     end;
  end;
  ЗаписатьПолеЛог("30V", GetSWIFTDateFull(field_value));

  /* 36 Exchange Rate - записываем значение с учетом того, что ставка хранится в двух полях */
  /*
  if( ObjKind == OBJTYPE_OUTOPER_DV )
     SwiftRate = GetSWIFTRate(CCnvDeal.nFI_().rec.Price);
  elif( ObjKind == OBJTYPE_FXOPER_DV )
     ПолучитьСтрокуЗначенияКурса(CCnvDeal.Leg.rec.Price, CCnvDeal.Leg.rec.Point, field_value);
     SwiftRate = GetSWIFTRate(field_value);
  else
     if( (IsDealSWAP == TRUE) AND (IsDealReverse == TRUE) )
       field_value = CCnvDeal.ReverseLeg.Rate.asDouble;
     else
       field_value = CCnvDeal.Leg.Rate.asDouble;
     end;
     field_value = ПереместитьТочу(CCnvDeal ,IsDealSWAP, IsDealReverse, field_value);
     SWIFTRate = GetSWIFTRate( field_value );
  end;
  */
  ЗаписатьПолеЛог("36", SWIFTRate);

  /* Subsequence B1 Amount Bought */
  УстановитьКонтекстБлокаЛог("B1");

  /* 32B Currency, Amount */
  field_value = ПолучитьКодВалютыЛог(DemandPayment.BaseFIID) + GetSWIFTAmount(DemandPayment.BaseAmount);
  ЗаписатьПолеЛог("32B", field_value);

  crs.Number  = DemandPayment.OutCorschem;
  crs.FI_Kind = 1;
  crs.FIID    = DemandPayment.BaseFIID;
  if( getEQ(crs) )
     CorrID  = crs.CorrID;
     CorrAcc = crs.CorAccount;
  else
     CorrID = 0;
  end;
  if((Netting != "X") and ( DemandPayment.BaseFIID != 0 ))/*PNV*/
    /* 56a Intermediary */ 
    ЗаписатьБанкЛог("56a", 0, DemandPayment.ReceiverBankCorrCodeKind, DemandPayment.ReceiverBankCorrCode, DemandPayment.ReceiverBankCorrName, 
                              DemandPayment.ReceiverBankCorrAcc, DemandPayment.BaseFIID);
  end;

  if ( DemandPayment.BaseFIID == 0 )
    УстановитьКонтекстБлокаЛог("57a");
    /*Chesnokov D.S. 08.02.2019 Нужно обыграть неттинг в 57D делай так*/
    if(Netting == "X")
      field_value = "/NOSI/NETS";//"NETTING";
      ЗаписатьПолеЛог("57J", field_value);/*CHVA изменено с D на J*/
    else
      /* ВР. */
      //OBJTYPE_OUTOPER_DV
      //mda 19.02.19 Добавим внебиржу
      if( (ObjKind == OBJTYPE_FXOPER_DV ) or ( ObjKind == OBJTYPE_OUTOPER_DV ) )
           if( ObjKind == OBJTYPE_FXOPER_DV )
               if( (not CCnvDeal.IsExistAccount("+Форвард, расчеты0", null, true, FIROLE_FIREQ, Account, null, DealDate, DemandPayment.BaseFIID)) and
                   (not CCnvDeal.OpenAccount("+Форвард, расчеты0", null, false, FIROLE_FIREQ, Account, DealDate, DemandPayment.BaseFIID)) )
                    RunError("|Ошибка при определении счета по категории '+Форвард, расчеты0'");
               end;
          else
              if( (not CCnvDeal.IsExistAccount("+Форвард, расчеты0", null, true, FIROLE_FIREQ, Account, null, DealDate, DemandPayment.BaseFIID)) and
                  (not CCnvDeal.OpenAccount("+Форвард, расчеты0", null, false, FIROLE_FIREQ, Account, DealDate, DemandPayment.BaseFIID)) )
                   RunError("|Ошибка при определении счета по категории '+Форвард, расчеты0'");
              end;
          end;
      /*              CHVA  500623            */
            field_value = "/ABIC/"+PartyABIC+SYMB_ENDL; 
               StrChangeRusXSet(  DemandPayment.ReceiverName, tempv );

             field_value =field_value +  "/NAME/ " + tempv +SYMB_ENDL; 
             field_value =field_value +  "/TXID/"; 
             field_value = field_value + "INN " + {INN_Bank} ; 
             field_value = field_value + " BIC " + {MFO_Bank} + SYMB_ENDL; 
             field_value = field_value + "/ACCT/ " + IIF(strlen(Account.Account) > 1,Account.Account,NOACC) + SYMB_ENDL;
       /*CHVA *********/

        ЗаписатьПолеЛог("57J", field_value);
      else
        if (strlen(DemandPayment.ReceiverAccount) > 1 )
          field_value="/"+DemandPayment.ReceiverAccount+SYMB_ENDL;
          field_value=field_value+ПолучитьКодСубъекта(DemandPayment.Receiver, PTCK_SWIFT, error)+SYMB_ENDL;
          ЗаписатьПолеЛог("57A", field_value);
        else
          ЗаписатьПолеЛог("57A", ПолучитьКодСубъекта(DemandPayment.Receiver, PTCK_SWIFT, error));
        end;
      end;
    end;
    УстановитьКонтекстБлока("..")
  else
    /* 57a - Receiving Agent  */
    crs.Number  = DemandPayment.inCorschem;
    crs.FI_Kind = 1;
    crs.FIID    = DemandPayment.BaseFIID;
    if( getEQ(crs) )
        CorrID  = crs.CorrID;
        CorrAcc = crs.coraccount;
    else
        CorrID = 0;
    end;
    if (ObjKind == OBJTYPE_FXOPER_DV)
        //Rogl 22.04.2019 
        if ((DemandPayment.PayerBankID == {Ourbank})  and (DemandPayment.ReceiverBankID == {Ourbank}))
           if (DemandPayment.ReceiverAccount != "")
              Account.Account = DemandPayment.ReceiverAccount;
           elif ( (not CCnvDeal.IsExistAccount("+Форвард, расчеты0", null, true, FIROLE_FIREQ, Account, null, DealDate, DemandPayment.BaseFIID)) and
                  (not CCnvDeal.OpenAccount("+Форвард, расчеты0", null, false, FIROLE_FIREQ, Account, DealDate, DemandPayment.BaseFIID)) )
              RunError("|Ошибка при определении счета по категории '+Форвард, расчеты0'");
           end;
           ЗаписатьБанкЛог("57a", DemandPayment.ReceiverBankID, DemandPayment.ReceiverBankCodeKind, DemandPayment.ReceiverBankCode, DemandPayment.ReceiverBankName, Account.Account, DemandPayment.BaseFIID, Netting);
        elif ( (CorrID!=0) and ( IsCorschem_LORO (DemandPayment.inCorschem, DemandPayment.BaseFIID) ) )  
           ЗаписатьБанкЛог("57a", DemandPayment.ReceiverBankID, DemandPayment.ReceiverBankCodeKind, DemandPayment.ReceiverBankCode, DemandPayment.ReceiverBankName, DemandPayment.ReceiverAccount, DemandPayment.BaseFIID, Netting);
        elif( (CorrID!=0) and (DemandPayment.PayerBankID != {Ourbank}) and DemandPayment.IsExternal )
           ЗаписатьБанкЛог("57a", CorrID, DemandPayment.ReceiverBankCorrCodeKind, DemandPayment.ReceiverBankCorrCode, DemandPayment.ReceiverBankCorrName, CorrAcc, DemandPayment.BaseFIID, Netting);
        end;
    else/*PNV*/
       /*PNV 506389 если расчеты ЛОРО - проверяем кор.схему, то должен быть НАШ счет, бик и банк, иначе - счет и бик стороннего банка*/ 
        if ( (CorrID!=0) and ( not IsCorschem_LORO (DemandPayment.inCorschem, DemandPayment.BaseFIID) ) )  
           ЗаписатьБанкЛог("57a", CorrID, DemandPayment.ReceiverBankCorrCodeKind, DemandPayment.ReceiverBankCorrCode, DemandPayment.ReceiverBankCorrName, CorrAcc, DemandPayment.BaseFIID, Netting);                
        elif( (CorrID != 0) and (DemandPayment.PayerBankID != {Ourbank}) and (DemandPayment.ReceiverBankID != {Ourbank}) and DemandPayment.IsExternal ) /*PNV i-support 501080*/
            ЗаписатьБанкЛог("57a", CorrID, DemandPayment.ReceiverBankCorrCodeKind, DemandPayment.ReceiverBankCorrCode, DemandPayment.ReceiverBankCorrName, CorrAcc, DemandPayment.BaseFIID, Netting);
        else
            ЗаписатьБанкЛог("57a", DemandPayment.ReceiverBankID, DemandPayment.ReceiverBankCodeKind, DemandPayment.ReceiverBankCode, DemandPayment.ReceiverBankName, DemandPayment.ReceiverAccount, DemandPayment.BaseFIID, Netting);
        end; 
    end;
  end;

  /* Выходим из контекста блока B1 */
  if( not УстановитьКонтекстБлока("..") )
     RunError("|Ошибка при установке контекста блока '..'");
  end;

  /* Subsequence B2 Amount Sold */
  УстановитьКонтекстБлокаЛог("B2");

  /* 33B Currency, Amount */
  field_value = ПолучитьКодВалютыЛог(LiabilityPayment.BaseFIID) + GetSWIFTAmount(LiabilityPayment.BaseAmount);
  ЗаписатьПолеЛог("33B", field_value);

  if((Netting != "X") and ( LiabilityPayment.BaseFIID != 0))/*PNV*/
    /* 56a Intermediary */ 
    ЗаписатьБанкЛог("56a", 0, LiabilityPayment.ReceiverBankCorrCodeKind, LiabilityPayment.ReceiverBankCorrCode, LiabilityPayment.ReceiverBankCorrName, LiabilityPayment.ReceiverBankCorrAcc, LiabilityPayment.BaseFIID);
  end;

  /* 57a - Receiving Agent */
  if ( LiabilityPayment.BaseFIID == 0 )
      УстановитьКонтекстБлокаЛог("57a");
      if(Netting == "X")
        field_value = "/NOSI/NETS";//"NETTING";
        ЗаписатьПолеЛог("57J", field_value);
      else
        //mda 20.02.19 Формируем 57D для блока
        if (strlen(LiabilityPayment.ReceiverAccount) > 1 )
            if (PartyIsNotResident(PartyID) == false)
           /*CHVA  500623*/
              field_value = "/ABIC/"+PartyBBIC+SYMB_ENDL; 

              StrChangeRusXSet(  LiabilityPayment.ReceiverName, tempv );

             field_value =field_value +  "/NAME/ " + tempv/*LiabilityPayment.PayerName*/+SYMB_ENDL; 
             field_value =field_value +  "/TXID/"; 
               if (strlen(LiabilityPayment.ReceiverINN) > 1)
                field_value = field_value + "INN " + IIF(strlen(LiabilityPayment.ReceiverINN) > 10,SubStr(LiabilityPayment.ReceiverINN,1,10),LiabilityPayment.ReceiverINN) ;
              end;  
               if (strlen(LiabilityPayment.ReceiverBankCode) > 1)
                field_value = field_value + " BIC " + LiabilityPayment.ReceiverBankCode + SYMB_ENDL;
              end; 
              field_value=field_value + "/ACCT/"+LiabilityPayment.ReceiverAccount+SYMB_ENDL;
         /*CHVA****************************/
              ЗаписатьПолеЛог("57J", field_value);
            else
              field_value = "/"+LiabilityPayment.ReceiverAccount+SYMB_ENDL;

              //Rogl 22.04.19 Отдельно рассмотрен случай, когда счет контрагента открыт в балансе РСХБ
              //              Например, такое может быть в случае, когда исходящая схема расчетов - ЛОРО
              if ( LiabilityPayment.ReceiverBankID == {Ourbank})  
                 field_value=field_value+ПолучитьКодСубъекта({Ourbank}, PTCK_SWIFT, error)+SYMB_ENDL;
              else
                 field_value=field_value+ПолучитьКодСубъекта(LiabilityPayment.ReceiverBankID, PTCK_SWIFT, error)+SYMB_ENDL;/*CHVA  500942*/
              end;
              ЗаписатьПолеЛог("57A", field_value);

            end;
           /*field_value="/"+LiabilityPayment.ReceiverAccount+SYMB_ENDL;
           field_value=field_value+ПолучитьКодСубъекта(LiabilityPayment.Receiver, PTCK_SWIFT, error)+SYMB_ENDL;
           /*Chesnokov D.S. 08.02.2019 Нужно обыграть неттинг в 57D делай так*/
             ЗаписатьПолеЛог("57A", field_value);*/
        else
          if (PartyIsNotResident(PartyID) == false)
            field_value = "/"+NOACC+SYMB_ENDL;
            if (strlen(LiabilityPayment.ReceiverBankCode) > 1)
              field_value = field_value + "BIC " + LiabilityPayment.ReceiverBankCode + SYMB_ENDL;
            end; 
            if (strlen(LiabilityPayment.ReceiverCorrAccNostro) > 1)
              field_value = field_value + "CA " + LiabilityPayment.ReceiverCorrAccNostro + SYMB_ENDL; 
            end;
            if (strlen(LiabilityPayment.ReceiverINN) > 1)
              field_value = field_value + "INN " + IIF(strlen(LiabilityPayment.ReceiverINN) > 10,SubStr(LiabilityPayment.ReceiverINN,1,10),LiabilityPayment.ReceiverINN) + SYMB_ENDL;
            end; 
            /*CHVA  500623*/
              field_value = "/ABIC/"+PartyBBIC+SYMB_ENDL; 

              StrChangeRusXSet(  LiabilityPayment.ReceiverName, tempv );

             field_value =field_value +  "/NAME/ " + tempv/*LiabilityPayment.PayerName*/+SYMB_ENDL; 
             field_value =field_value +  "/TXID/"; 
               if (strlen(LiabilityPayment.ReceiverINN) > 1)
                field_value = field_value + "INN " + IIF(strlen(LiabilityPayment.ReceiverINN) > 10,SubStr(LiabilityPayment.ReceiverINN,1,10),LiabilityPayment.ReceiverINN) ;
              end;  
               if (strlen(LiabilityPayment.ReceiverBankCode) > 1)
                field_value = field_value + " BIC " + LiabilityPayment.ReceiverBankCode + SYMB_ENDL;
              end; 
              field_value=field_value + "/ACCT/"+LiabilityPayment.ReceiverAccount+SYMB_ENDL;
         /*CHVA****************************/

            ЗаписатьПолеЛог("57J", field_value);
          else
            field_value = "/"+NOACC+SYMB_ENDL;
            field_value = field_value + ПолучитьКодСубъекта(LiabilityPayment.Receiver, PTCK_SWIFT, error) + SYMB_ENDL;
            ЗаписатьПолеЛог("57A", field_value);
          end;
        end;
     end;

  else
    ЗаписатьБанкЛог("57a", LiabilityPayment.ReceiverBankID, LiabilityPayment.ReceiverBankCodeKind, LiabilityPayment.ReceiverBankCode, LiabilityPayment.ReceiverBankName, LiabilityPayment.ReceiverAccount, LiabilityPayment.BaseFIID, Netting);
  end;
  return TRUE; /* Успешное завершение */

  OnError(er) /* обработка ошибок */
    ExeptionMessage(er);
    return FALSE;
end;
