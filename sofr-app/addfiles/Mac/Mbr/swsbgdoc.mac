
/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank v6                       */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/*                 Константы и вспомогательные функции                      */
/*          для генерации учетных объектов по сообщениям SWIFT-SB           */
/*                                                                          */
/*  Имя файла: swsbgdoc.mac                                                 */
/*  Создан:  18.03.04                                        Панов А.Б.     */
/****************************************************************************/

import "swgendoc.mac", "swsbsign.mac", "swsbpars.mac", cryptdlm, oralib, likepy;

const CONTEXTID_CHECK_SIGN_SWSB = "ТранспортМБР|8|Обработка_сообщения";

/* Контроль сообщений SWIFT-SB */ 
macro CheckMesKey( wlmes )
  var StrForSign = "", CryptoAPI = RsCryptoAPI(), rsms; 

  /* Выполняем проверку ЭЦП если существует настройка */
  if( CryptoAPI.IsCryptoActionNeeded( CONTEXTID_CHECK_SIGN_SWSB, 370 ) )

    /* Конструируем объект сообщение */
    rsms = RsbMessage( wlmes.MesID );

    /* Формирование блока данных */     
    if( not ФормированиеБлокаДанных( rsms, StrForSign ) )
      std.msg( "Ошибка при формировании блока данных для проверки ключа сообщения" );
      return FALSE;
    end; 

    /* В целях экономии времени записываем в объект БЦИ, чтобы он повторно не рассчитывался */
    rsms.PIB = StrForSign;

    /* Проверяем ЭЦП сообщения */
    if( not CryptoAPI.ExecCryptoAction( CONTEXTID_CHECK_SIGN_SWSB, rsms ))
      std.msg( String("Ошибка при проверке ЭЦП сообщения|", + GetErrMsg()) );
      return false;
    end;
  end;

  return TRUE;

  OnError(er) /* Обработка ошибок времени выполнения */
    ExeptionMessage(er);
    return false;
end;
       
/* Поиск корсхемы для заданного корреспонденат в заданной валюте */
macro НайтиКорсхемуПоКонтрагентуИВалюте(CorrID, Number, FIID)
   var rs:object;
   var select:string;
   var params:TArray;

   select = "select cors.t_number "+
                            "from dcorschem_dbt cors where "+
                            "cors.t_CorrID = :CorrID and cors.t_FIID =:FIID";
   params = makeArray( SQLParam("CorrID", CorrID),
                       SQLParam("FIID", FIID));
   rs = execSQLselect( select, params, FALSE );

   if (not rs.moveNext())
     return false;
   end;

   Number = rs.value(0);
   setParm(1, Number);

   return true;
end;
