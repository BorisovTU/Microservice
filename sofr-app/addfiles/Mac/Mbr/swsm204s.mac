/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank v6                       */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/* Генерация сообщения по SWIFT-SB MT204S                                   */
/*                                                                          */
/*  Имя файла: swsm204s.mac                                                 */
/*  Создан:  18.03.04                                        Панов А.Б.     */
/****************************************************************************/
import "swsbgmes.mac";

macro GenMes( addrMes, addrPm )
  var field_value, Tag, Tag1, PaymentDetails, TerBankID;
  var RsPaym;
  RECORD rcv(pmroute);
  RECORD ocb(pmroute);
  RECORD irb(pmroute);

  SetBuff( wlmes,  addrMes );
  SetBuff( wlpmpaym, addrPm );

  PrintLog(2,"Генерация сообщения по МТ204S");

  RsPaym = RsbPayment( wlpmpaym.PaymentID );
  SB_CheckFIID( wlpmpaym.BaseFIID );

  /* SN - уникальный системный номер сообщения в СМФР */
  ЗаписатьПолеЛог(УникальныйНомерСообщенияСМФР, wlmes.TRN);

  /* 20 - номер транзакции (документа) */
  ЗаписатьПолеЛог( TransactionReferenceNumberField, wlmes.TRN );

  /* 32A - дата валютирования, код валюты, сумма */
    field_value = ДатаПоУмолчанию +
                FillCurrencyOriginalOrderedAmountField( RsPaym );
  ЗаписатьПолеЛог( ValueDateCurrencyCodeAmountField_A, field_value );

  /* 52a - банк приказодателя */
  if (wlpmpaym.PayerAccount != "")
     field_value = FillOrderingInstitutionFieldD_SB(RsPaym, Tag, true, ST_NONTR, true);
  else
     field_value = FillOrderingInstitutionFieldA_SB(RsPaym, Tag, ST_NONTR);
  end;
    if (field_value == "")
      std.out(2, "PaymentID: " + RsPaym.PaymentID);
      RunError("|Не найден банк приказодателя");
    end;
  ЗаписатьПолеВБлокКонтекст0(OrderingInstitutionField+Tag, "52a", field_value);

  /* Восстанавливаем нулевой контекст блока */  
  if( not УстановитьКонтекстБлока() )
    RunError("|Ошибка при установке нулевого контекста блока");
  end;

  /* 57a - банк бенефициара */
  Tag = "";
  Tag1= "";
  TerBankID = НайтиТерБанк(RsPaym.PayerBankID);

  if( RsPaym.ReceiverBankID == НайтиТерБанк(RsPaym.ReceiverBankID))
  
    field_value = FillAccountWithInstitutionField_SB(RsPaym, Tag, ST_NONTR);
    ЗаписатьПолеВБлокКонтекст0( AccountWithInstitutionField+Tag, "57a", field_value );
  
  else
    if( (TerBankID != НайтиТерБанк(RsPaym.ReceiverBankID)) and not(TerBankID<0) )
  field_value = FillIntermediaryField_SB(RsPaym, Tag, ST_NONTR );
    else
      field_value = FillAccountWithInstitutionField_SB(RsPaym, Tag);  
    end;
  ЗаписатьПолеВБлокКонтекст0( AccountWithInstitutionField+Tag, "57a", field_value );

    /* Восстанавливаем нулевой контекст блока */
    if( not УстановитьКонтекстБлока() )
      RunError("|Ошибка при установке нулевого контекста блока");
    end;

  /* 58a - банк-бенефициар */
  Tag = "";
    field_value = FillBeneficiaryInstitutionField_SB(RsPaym, Tag, ST_NONTR);
  if (field_value == "")
    std.out(2, "PaymentID: " + RsPaym.PaymentID);
    RunError("|Не найден банк-бенефициар");
  end;
  ЗаписатьПолеВБлокКонтекст0( BeneficiaryInstitutionField+Tag, "58a", field_value );
  end;
  
  /* Восстанавливаем нулевой контекст блока */  
  if( not УстановитьКонтекстБлока() )
    RunError("|Ошибка при установке нулевого контекста блока");
  end;
  
  /* 72 - информация для банка-получателя */
  PaymentDetails = "";
  StrChangeRusXSet(RsPaym.Ground, PaymentDetails, ST_NONTR);
  field_value = FillInformationOfPaymentField_SB(RsPaym, ALLOWCODES_MT202_STANDART, PaymentDetails, ST_NONTR);
  if (field_value == "")
    std.out(2, "PaymentID: " + RsPaym.PaymentID);
    RunError("|Не найдена информация для банка-получателя");
  end;
  ЗаписатьПолеЛог( SenderToReceiverInformationField, field_value );

  return TRUE; /* Успешное завершение */

  OnError(er) /* обработка ошибок */
    ExeptionMessage(er);
    return FALSE;
end;

