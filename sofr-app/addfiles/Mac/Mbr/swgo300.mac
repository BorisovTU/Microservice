/*
$Name: swgo300.mac
$Module: Межбанковские расчеты
$Description: Генерация сообщения по SWIFT MT300
*/
/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 5.1                      */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/* Генерация подтверждений Forex по сообщениям SWIFT MT300                  */
/*                                                                          */
/*  Имя файла: swgo300.mac                                                  */
/*  Создан:    24.09.02                                      Алешин А.В.    */
/****************************************************************************/

import "wlglobal.mac", "swparser.mac", FXInter;

class FxScrolObj()
var PartyID,	
    DealDate,	
    DemandAmount,	
    DemandFIID,	
    LiabilityAmount,	
    LiabilityFIID,	
    ValueDate,	
    DealCodePS,	
    ConfTpID;	
end;

class FxBank( pBIC, pName, pBranch, pAccount, pCliringSystem, pCliringCode )

 var PartyID       :integer,  /* Ссылка на банк */
     CodeKind      :integer,  /* Вид кода субъекта */
     CodeBank      :string,   /* Код банка */
     Account       :string,   /* Счет */
     Name          :string,   /* Name and Address */
     Branch        :string,   /* Код филиала */
     CliringSystem :string,   /* Клиринговая система */
     CliringCode   :string,   /* Код клиринга */
     error;

  /* инициализация */
  if(valtype(pBIC)==V_STRING)
    CodeBank = pBIC;
  else
    CodeBank = "";
  end;
  if(valtype(pAccount)==V_STRING)
    Account = pAccount;
  else
    Account = "";
  end;
  if(valtype(pName)==V_STRING)
    Name = pName;
  else
    Name = "";
  end;
  if(valtype(pBranch)==V_STRING)
    Branch = pBranch;
  else
    Branch = "";
  end;
  if(valtype(pCliringSystem)==V_STRING)
    CliringSystem = pCliringSystem;
  else
    CliringSystem = "";
  end;
  if(valtype(pCliringCode)==V_STRING)
    CliringCode = pCliringCode;
  else
    CliringCode = "";
  end;
  PartyID  = -1;
  CodeKind =  0;

  if( CodeBank != "" )
    PartyID = ПолучитьКодСубъекта( CodeBank, PTCK_SWIFT, error );
    if( error == 0 )
      CodeKind = PTCK_SWIFT;
    else
      PartyID = -1;
    end;
  elif( CliringCode != "" )
    if ( CliringSystem == CODEWORLD_FEDWIRE )
       PartyID = ПолучитьКодСубъекта( CliringCode, PTCK_ABA, error );
    else
       PartyID = ПолучитьКодСубъекта( CliringCode, PTCK_CHIPS, error );
    end;
    if( error == 0 )
      CodeBank = CliringCode;
      if ( CliringSystem == CODEWORLD_FEDWIRE )
         Codekind = PTCK_ABA;
      else
         Codekind = PTCK_CHIPS;
      end;
    else
      PartyID = -1;
    end;
  end;

  macro IsSet()
    return NOT((CodeBank=="")AND(Account=="")AND(Name=="")AND(Branch=="")AND(CliringSystem==""));
  end;

end;

const BLOCK_A  = "A",
      BLOCK_B  = "B",
      BLOCK_B1 = "B1",
      BLOCK_B2 = "B2",
      BLOCK_C  = "C",
      BLOCK_D    = "D",
      BLOCK_E    = "E",
      BLOCK_E1   = "E1",
      BLOCK_E1a  = "E1a",
      BLOCK_E1a1 = "E1a1";

class ForexConfirmation
 var
  ContextBlock                :string,      /* Контекст блока */
  TRF                         :string,      /* Ссылочный номер операции */
  RelatedRef                  :string,      /* Ссылка */
  CommonRef                   :string,      /* Общий референс операции */
  ValueDate                   :date,        /* Дата валютирования */
  TradeDate                   :date,        /* Дата сделки */
  Bought_Currency             :string,      /* Контрагент: купленная сумма */
  Bought_Amount               :moneyl,      /* Контрагент: купленная валюта */
  Sold_Currency               :string,      /* Наш банк: купленная сумма */
  Sold_Amount                 :moneyl,      /* Наш банк: купленная валюта */
  TypeOperation               :string,      /* Тип операции */
  ExchangeRate                :double,      /* Курс пересчета */
  
  DeliveryAgentAmountPartyA   :FxBank,      /* Конрагент: откуда поcтупят деньги */
  IntermediaryAmountPartyA    :FxBank,      /* Конрагент: через кого*/
  ReceivingAgentAmountPartyA  :FxBank,      /* Конрагент: куда */
                                          
  DeliveryAgentAmountPartyB   :FxBank,      /* Наш банк: откуда поcтупят деньги */
  IntermediaryAmountPartyB    :FxBank,      /* Наш банк: через кого*/             
  ReceivingAgentAmountPartyB  :FxBank,      /* Наш банк: куда */                  
                                          
  PartyA                      :FxBank,      /* Отправитель */
  PartyB                      :FxBank,      /* Контрагент */

  RcvInfo                     :TRcvInfo100; /* Информация Получателю поле 72 */

  ContextBlock                = "";
  TRF                         = "";
  CommonRef                   = "";
  ValueDate                   = date(0,0,0);
  TradeDate                   = date(0,0,0);
  Bought_Currency             = "";
  Sold_Currency          = "";
  Bought_Amount               = $0;
  Sold_Amount            = $0;
  TypeOperation               = "";  
  RelatedRef                  = "";
  ExchangeRate                = 0.0;
end; /* class ForexConfirmation */

var MT300 = ForexConfirmation;

macro Fill20( TRF )
  MT300.TRF = TRF;
  return TRUE;
end;

macro Fill21( RelatedRef )
  MT300.RelatedRef = RelatedRef;
  return TRUE;
end;

macro Fill22A( Code )
  MT300.TypeOperation = Code;
  return TRUE;
end;

macro Fill22C( CommonRef )
  MT300.CommonRef = CommonRef;
  return TRUE;
end;

macro Fill32B( Cur, Amount )
  MT300.Bought_Currency  = Cur;
  MT300.Bought_Amount = moneyl(Amount);
  return TRUE;
end;

macro Fill33B( Cur, Amount )
  MT300.Sold_Currency  = Cur;
  MT300.Sold_Amount = moneyl(Amount);
  return TRUE;
end;

macro Fill17T( Symb )
  return TRUE;
end;

macro Fill17U( Symb )
  return TRUE;
end;

macro Fill30T( Date )
  MT300.TradeDate = Date;
  return TRUE;
end;

macro Fill30V( Date )
  MT300.ValueDate = Date;
  return TRUE;
end;

macro Fill36( Rate )
  MT300.ExchangeRate = Rate;
  return TRUE;
end;

macro Fill53A( BIC, Account, System, Code )
  if( MT300.ContextBlock == BLOCK_B1 )
    MT300.DeliveryAgentAmountPartyA = FxBank( BIC, "", "", Account, System, Code );
  else
    MT300.DeliveryAgentAmountPartyB = FxBank( BIC, "", "", Account, System, Code );
  end;
  return TRUE;
end;

macro Fill53D( Address, Account, System, Code )
  if( MT300.ContextBlock == BLOCK_B1 )
    MT300.DeliveryAgentAmountPartyA = FxBank( "", Address, "", Account, System, Code );
  else
    MT300.DeliveryAgentAmountPartyB = FxBank( "", Address, "", Account, System, Code );
  end;
  return TRUE;
end;

macro Fill53J( BIC, Name, Account, System, Code )
  if( MT300.ContextBlock == BLOCK_B1 )
    MT300.DeliveryAgentAmountPartyA = FxBank( BIC, Name, "", Account, System, Code ); 
  else
    MT300.DeliveryAgentAmountPartyB = FxBank( BIC, Name, "", Account, System, Code ); 
  end;
  return TRUE;
end;

macro Fill56A( BIC, Account, System, Code )
  if( MT300.ContextBlock == BLOCK_B1 )
    MT300.IntermediaryAmountPartyA = FxBank( BIC, "", "", Account, System, Code );
  else
    MT300.IntermediaryAmountPartyB = FxBank( BIC, "", "", Account, System, Code );
  end;
  return TRUE;
end;

macro Fill56D( Address, Account, System, Code )
  if( MT300.ContextBlock == BLOCK_B1 )
    MT300.IntermediaryAmountPartyA = FxBank( "", Address, "", Account, System, Code );
  else
    MT300.IntermediaryAmountPartyB = FxBank( "", Address, "", Account, System, Code );
  end;
  return TRUE;
end;

macro Fill56J( BIC, Name, Account, System, Code )
  if( MT300.ContextBlock == BLOCK_B1 )
    MT300.IntermediaryAmountPartyA = FxBank( BIC, Name, "", Account, System, Code ); 
  else
    MT300.IntermediaryAmountPartyB = FxBank( BIC, Name, "", Account, System, Code ); 
  end;
  return TRUE;
end;

macro Fill57A( BIC, Account, System, Code )
  if( MT300.ContextBlock == BLOCK_B1 )
    MT300.ReceivingAgentAmountPartyA = FxBank( BIC, "", "", Account, System, Code );
  else
    MT300.ReceivingAgentAmountPartyB = FxBank( BIC, "", "", Account, System, Code );
  end;
  return TRUE;
end;

macro Fill57D( Address, Account, System, Code )
  if( MT300.ContextBlock == BLOCK_B1 )
    MT300.ReceivingAgentAmountPartyA = FxBank( "", Address, "", Account, System, Code );
  else
    MT300.ReceivingAgentAmountPartyB = FxBank( "", Address, "", Account, System, Code );
  end;
  return TRUE;
end;

macro Fill57J( BIC, Name, Account, System, Code )
  if( MT300.ContextBlock == BLOCK_B1 )
    MT300.ReceivingAgentAmountPartyA = FxBank( BIC, Name, "", Account, System, Code ); 
  else
    MT300.ReceivingAgentAmountPartyB = FxBank( BIC, Name, "", Account, System, Code ); 
  end;
  return TRUE;
end;

macro Fill82A( BIC, Account, System, Code )
  MT300.PartyA = FxBank( BIC, "", "", Account, System, Code );
  return TRUE;
end;

macro Fill82D( Address, Account, System, Code )
  MT300.PartyA = FxBank( "", Address, "", Account, System, Code );
  return TRUE;
end;

macro Fill82J( BIC, Name, Account, System, Code )
  MT300.PartyA = FxBank( BIC, Name, "", Account, System, Code );
  return TRUE;
end;

macro Fill87A( BIC, Account, System, Code )
  MT300.PartyB = FxBank( BIC, "", "", Account, System, Code );
  return TRUE;
end;

macro Fill87D( Address, Account, System, Code )
  MT300.PartyB = FxBank( "", Address, "", Account, System, Code );
  return TRUE;
end;

macro Fill87J( BIC, Name, Account, System, Code )
  MT300.PartyB = FxBank( BIC, Name, "", Account, System, Code );
  return TRUE;
end;

macro Fill72( Str, Narrative )
  MT300.RcvInfo = TRcvInfo100( Str, Narrative );
  return TRUE;
end;

macro SetBlockA()  MT300.ContextBlock = BLOCK_A;  return TRUE; end;
macro SetBlockB()  MT300.ContextBlock = BLOCK_B;  return TRUE; end;
macro SetBlockB1() MT300.ContextBlock = BLOCK_B1; return TRUE; end;
macro SetBlockB2() MT300.ContextBlock = BLOCK_B2; return TRUE; end;
macro SetBlockC()  MT300.ContextBlock = BLOCK_C;  return TRUE; end;
macro SetBlockD()  MT300.ContextBlock = BLOCK_D;  return TRUE; end;
macro SetBlockE()    MT300.ContextBlock = BLOCK_E;  return TRUE; end;
macro SetBlockE1()   MT300.ContextBlock = BLOCK_E1;  return TRUE; end;
macro SetBlockE1a()  MT300.ContextBlock = BLOCK_E1a;  return TRUE; end;
macro SetBlockE1a1() MT300.ContextBlock = BLOCK_E1a1;  return TRUE; end;

/* Заполнение списка полей формы  MT300*/
macro MakeListFldMT300()

  /* Очищаем список полей сообщения */ 
  ПоляФормы = Tarray;
  
  /* Sequence A */
  GenObject( "ТПолеФормы", "15A",  FIELD_MANDATORY, "",             "",        "SetBlockA" );
  GenObject( "ТПолеФормы", "20",   FIELD_MANDATORY, "ReadTRF",      "Fill20",  "" );
  GenObject( "ТПолеФормы", "21",   FIELD_OPTIONAL,  "ReadTRF",      "Fill21",  "" );
  GenObject( "ТПолеФормы", "22A",  FIELD_MANDATORY, "ReadCode",     "Fill22A", "" );
  GenObject( "ТПолеФормы", "94A",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "22C",  FIELD_MANDATORY, "ReadTRF",      "Fill22C", "" );
  GenObject( "ТПолеФормы", "17T",  FIELD_OPTIONAL,  "ReadSymbol",   "Fill17T", "" );
  GenObject( "ТПолеФормы", "17U",  FIELD_OPTIONAL,  "ReadSymbol",   "Fill17U", "" );
  GenObject( "ТПолеФормы", "17I",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "82A",  FIELD_OPTIONAL,  "ReadA",        "Fill82A", "" );
  GenObject( "ТПолеФормы", "82D",  FIELD_OPTIONAL,  "ReadD",        "Fill82D", "" );
  GenObject( "ТПолеФормы", "82J",  FIELD_OPTIONAL,  "ReadJ",        "Fill82J", "" );
  GenObject( "ТПолеФормы", "87A",  FIELD_OPTIONAL,  "ReadA",        "Fill87A", "" );
  GenObject( "ТПолеФормы", "87D",  FIELD_OPTIONAL,  "ReadD",        "Fill87D", "" );
  GenObject( "ТПолеФормы", "87J",  FIELD_OPTIONAL,  "ReadJ",        "Fill87J", "" );
  GenObject( "ТПолеФормы", "83A",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "83D",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "83J",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "77H",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "77D",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "14C",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "17F",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "17O",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "32E",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "30U",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "14S",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "26K",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "21A",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "14E",  FIELD_OPTIONAL,  "",             "",        "" );
  
  /* Sequence B */
  GenObject( "ТПолеФормы", "15B",  FIELD_MANDATORY, "",             "",        "SetBlockB" );
  GenObject( "ТПолеФормы", "30T",  FIELD_MANDATORY, "ReadFullDate", "Fill30T", "" );
  GenObject( "ТПолеФормы", "30V",  FIELD_MANDATORY, "ReadFullDate", "Fill30V", "" );
  GenObject( "ТПолеФормы", "36",   FIELD_MANDATORY, "ReadRate",     "Fill36",  "" );    

  /* Subsequnce B1 */
  GenObject( "ТПолеФормы", "32B",  FIELD_MANDATORY, "Read32B",      "Fill32B", "SetBlockB1" );
  GenObject( "ТПолеФормы", "53A",  FIELD_OPTIONAL,  "ReadA",        "Fill53A", "" );
  GenObject( "ТПолеФормы", "53D",  FIELD_OPTIONAL,  "ReadD",        "Fill53D", "" );
  GenObject( "ТПолеФормы", "53J",  FIELD_OPTIONAL,  "ReadJ",        "Fill53J", "" );
  GenObject( "ТПолеФормы", "56A",  FIELD_OPTIONAL,  "ReadA",        "Fill56A", "" );
  GenObject( "ТПолеФормы", "56D",  FIELD_OPTIONAL,  "ReadD",        "Fill56D", "" );
  GenObject( "ТПолеФормы", "56J",  FIELD_OPTIONAL,  "ReadJ",        "Fill56J", "" );
  GenObject( "ТПолеФормы", "57A",  FIELD_OPTIONAL,  "ReadA",        "Fill57A", "" );
  GenObject( "ТПолеФормы", "57D",  FIELD_OPTIONAL,  "ReadD",        "Fill57D", "" );
  GenObject( "ТПолеФормы", "57J",  FIELD_OPTIONAL,  "ReadJ",        "Fill57J", "" );

  /* Subsequnce B2 */
  GenObject( "ТПолеФормы", "33B",  FIELD_OPTIONAL,  "Read32B",      "Fill33B", "SetBlockB2" );
  GenObject( "ТПолеФормы", "53A",  FIELD_OPTIONAL,  "ReadA",        "Fill53A", "" );
  GenObject( "ТПолеФормы", "53D",  FIELD_OPTIONAL,  "ReadD",        "Fill53D", "" );
  GenObject( "ТПолеФормы", "53J",  FIELD_OPTIONAL,  "ReadJ",        "Fill53J", "" );
  GenObject( "ТПолеФормы", "56A",  FIELD_OPTIONAL,  "ReadA",        "Fill56A", "" );
  GenObject( "ТПолеФормы", "56D",  FIELD_OPTIONAL,  "ReadD",        "Fill56D", "" );
  GenObject( "ТПолеФормы", "56J",  FIELD_OPTIONAL,  "ReadJ",        "Fill56J", "" );
  GenObject( "ТПолеФормы", "57A",  FIELD_OPTIONAL,  "ReadA",        "Fill57A", "" );
  GenObject( "ТПолеФормы", "57D",  FIELD_OPTIONAL,  "ReadD",        "Fill57D", "" );
  GenObject( "ТПолеФормы", "57J",  FIELD_OPTIONAL,  "ReadJ",        "Fill57J", "" );
  GenObject( "ТПолеФормы", "58A",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "58D",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "58J",  FIELD_OPTIONAL,  "",             "",        "" );

  /* Sequence C */
  GenObject( "ТПолеФормы", "15C",  FIELD_OPTIONAL,  "",             "",        "SetBlockC" );
  GenObject( "ТПолеФормы", "29A",  FIELD_OPTIONAL,  "",              "",        "" );
  GenObject( "ТПолеФормы", "24D",  FIELD_OPTIONAL,  "",              "",        "" );
  GenObject( "ТПолеФормы", "84A",  FIELD_OPTIONAL,  "",              "",        "" );
  GenObject( "ТПолеФормы", "84B",  FIELD_OPTIONAL,  "",              "",        "" );
  GenObject( "ТПолеФормы", "84D",  FIELD_OPTIONAL,  "",              "",        "" );
  GenObject( "ТПолеФормы", "84J",  FIELD_OPTIONAL,  "",              "",        "" );
  GenObject( "ТПолеФормы", "85A",  FIELD_OPTIONAL,  "",              "",        "" );
  GenObject( "ТПолеФормы", "85B",  FIELD_OPTIONAL,  "",              "",        "" );
  GenObject( "ТПолеФормы", "85D",  FIELD_OPTIONAL,  "",              "",        "" );
  GenObject( "ТПолеФормы", "85J",  FIELD_OPTIONAL,  "",              "",        "" );
  GenObject( "ТПолеФормы", "88A",  FIELD_OPTIONAL,  "",              "",        "" );
  GenObject( "ТПолеФормы", "88B",  FIELD_OPTIONAL,  "",              "",        "" );
  GenObject( "ТПолеФормы", "88D",  FIELD_OPTIONAL,  "",              "",        "" );
  GenObject( "ТПолеФормы", "88J",  FIELD_OPTIONAL,  "",              "",        "" );
  GenObject( "ТПолеФормы", "71F",  FIELD_OPTIONAL,  "",              "",        "" );
  GenObject( "ТПолеФормы", "26H",  FIELD_OPTIONAL,  "",              "",        "" );
  GenObject( "ТПолеФормы", "21G",  FIELD_OPTIONAL,  "",              "",        "" );
  GenObject( "ТПолеФормы", "72",   FIELD_OPTIONAL,  "",              "",        "" );
                        
  /* Sequence D */
  GenObject( "ТПолеФормы", "15D",  FIELD_OPTIONAL,  "",             "",        "SetBlockD" );
  GenObject( "ТПолеФормы", "17A",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "32B",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "53A",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "53D",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "53J",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "56A",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "56D",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "56J",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "57A",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "57D",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "57J",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "58A",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "58D",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "58J",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "16A",  FIELD_OPTIONAL,  "",             "",        "" );

  /* Sequence E */
  GenObject( "ТПолеФормы", "15E",  FIELD_OPTIONAL,  "",             "",        "SetBlockE" );

  GenObject( "ТПолеФормы", "22L",  FIELD_OPTIONAL,  "",             "",        "SetBlockE1" );
  GenObject( "ТПолеФормы", "91A",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "91D",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "91J",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "22M",  FIELD_OPTIONAL,  "",             "",        "SetBlockE1a" );
  GenObject( "ТПолеФормы", "22N",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "22P",  FIELD_OPTIONAL,  "",             "",        "SetBlockE1a1" );
  GenObject( "ТПолеФормы", "22R",  FIELD_OPTIONAL,  "",             "",        "" );

  GenObject( "ТПолеФормы", "22L",  FIELD_OPTIONAL,  "",             "",        "SetBlockE1" );
  GenObject( "ТПолеФормы", "91A",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "91D",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "91J",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "22M",  FIELD_OPTIONAL,  "",             "",        "SetBlockE1a" );
  GenObject( "ТПолеФормы", "22N",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "22P",  FIELD_OPTIONAL,  "",             "",        "SetBlockE1a1" );
  GenObject( "ТПолеФормы", "22R",  FIELD_OPTIONAL,  "",             "",        "" );

  GenObject( "ТПолеФормы", "22L",  FIELD_OPTIONAL,  "",             "",        "SetBlockE1" );
  GenObject( "ТПолеФормы", "91A",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "91D",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "91J",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "22M",  FIELD_OPTIONAL,  "",             "",        "SetBlockE1a" );
  GenObject( "ТПолеФормы", "22N",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "22P",  FIELD_OPTIONAL,  "",             "",        "SetBlockE1a1" );
  GenObject( "ТПолеФормы", "22R",  FIELD_OPTIONAL,  "",             "",        "" );

  GenObject( "ТПолеФормы", "81A",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "81D",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "81J",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "89A",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "89D",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "89J",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "96A",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "96D",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "96J",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "22S",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "22T",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "17E",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "22U",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "35B",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "17H",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "17P",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "22V",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "98D",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "17W",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "22W",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "17L",  FIELD_OPTIONAL,  "",             "",        "" );
  GenObject( "ТПолеФормы", "77A",  FIELD_OPTIONAL,  "",             "",        "" );
end;

/* Разбор сообщения */
macro ConstructMT300( RespID )
  var field_name, field_value, loop = 1, count = 0, wasRead = 1,
      result = TRUE, error, fld, BankCode;

  /* Формирование списка полей сообщения МТ300 */
  MakeListFldMT300();

  /* Последовательно считываем поля и заполняем лексемы */  
  while( loop )
    fld = ПоляФормы.Value(count);
    if( wasRead AND (not СчитатьПоле( field_name, field_value )) )
      loop = 0;
    else
      if( (field_name != fld.Name) )
        if( fld.ПолеОбязательно )
          std.msg( "Не указано обязательное поле: " + fld.Name );
          result = FALSE;
          loop = 0;
        else
          wasRead = 0;
        end;
      else
        if( fld.ОбработатьПолеФормы( field_value ) )
          if( fld.ВыполнитьФункцияБлока  )
            wasRead = 1;
          else
            std.msg("Ошибка при выполнении функции блока " + fld.Name);
            result = FALSE;
            loop = 0;
          end;
        else
          std.msg("Ошибка при обработке поля формы " + fld.Name);
          result = FALSE;
          loop = 0;
        end;
      end;
      count = count + 1;
    end;
  end;
  
  if( result == FALSE )
    return result;
  end;

  return TRUE;
end; /* ConstructMT300 */

/* Собственно сама генерация */
//В приведенной ниже функции закоментированым оказалось много полей, т.к. 
//непонятно для чего они нужны, достаточно и тех, что открыты.
//Возможно они будут использоваться при просмотре полей пдтверждения,
//но даннаый функционал в сишнике не реализован!!!!!!!!!!! А вдруг,
//когда-нибудь это случиться, и ВОТ ОНО уже почти реализовано здесь.
macro GenObj( addrMes )
  var CCnvDeal = FxScrolObj;//RsbConvDeal, CRate;

  SetBuff( wlmes, addrMes );
  PrintLog(2,"Генерация подтверждения сделки Forex по МТ300");

  if( not ConstructMT300( wlmes.OutsideAbonentID ) )
    return FALSE;
  end;
  
  /* Заполняем объект сделки  */
  CCnvDeal.DealCodePS      = MT300.CommonRef;
  CCnvDeal.DealDate        = MT300.TradeDate;
  CCnvDeal.ValueDate       = MT300.ValueDate;

//  /* Курс */
//  CRate = RsbRate( MT300.ExchangeRate, 1, 4 );
//  CCnvDeal.Leg.Rate            = CRate;
//
  /* Подтверждение пришло по транспорту SWIFT */
  CCnvDeal.ConfTpID        = TRANSP_SWIFT;

  /* Наш банк: купленная валюта */
  CCnvDeal.DemandAmount    = MT300.Sold_Amount;
  if( not ПолучитьФинИнПоISO( MT300.Sold_Currency, wlfininstr ) )
    std.msg( "Не определена валюта сообщения по коду ISO: " +  MT300.Sold_Currency );
    return FALSE;
  end;
  CCnvDeal.DemandFIID      = wlfininstr.FIID;

  /* Контрагент: купленная валюта */
  CCnvDeal.LiabilityAmount = MT300.Bought_Amount;
  if( not ПолучитьФинИнПоISO( MT300.Bought_Currency, wlfininstr ) )
    std.msg( "Не определена валюта сообщения по коду ISO: " +  MT300.Bought_Currency );
    return FALSE;
  end;
  CCnvDeal.LiabilityFIID   = wlfininstr.FIID;

  CCnvDeal.PartyID = MT300.PartyA.PartyID;
  
//  /* Если не определили, то проставляем респондента */
//  if( CCnvDeal.PartyID == -1 )
//    CCnvDeal.PartyID = wlmes.OutsideAbonentID;
//  end;
//
//  /* Заполняем ПИ */
//  /* Наш банк: откуда поcтупят деньги */                                      
//  if( MT300.DeliveryAgentAmountPartyB.IsSet() )
//    CCnvDeal.DemandPayment.PayerBankID       = MT300.DeliveryAgentAmountPartyB.PartyID;
//    CCnvDeal.DemandPayment.PayerBankCodeKind = MT300.DeliveryAgentAmountPartyB.CodeKind;
//    CCnvDeal.DemandPayment.PayerBankCode     = MT300.DeliveryAgentAmountPartyB.CodeBank;
//    CCnvDeal.DemandPayment.PayerBankName     = MT300.DeliveryAgentAmountPartyB.Name;
//    CCnvDeal.DemandPayment.PayerAccount      = MT300.DeliveryAgentAmountPartyB.Account;
//  end;         
//
//  /* Наш банк: через кого*/             
//  if( MT300.IntermediaryAmountPartyB.IsSet() )
//    CCnvDeal.DemandPayment.ReceiverBankCorrCodeKind = MT300.IntermediaryAmountPartyB.CodeKind;
//    CCnvDeal.DemandPayment.ReceiverBankCorrCode     = MT300.IntermediaryAmountPartyB.CodeBank;
//    CCnvDeal.DemandPayment.ReceiverBankCorrName     = MT300.IntermediaryAmountPartyB.Name;
//    CCnvDeal.DemandPayment.ReceiverCorrAcc          = MT300.IntermediaryAmountPartyB.Account;
//  end;          
//  
//  /* Наш банк: куда */                  
//  if( MT300.ReceivingAgentAmountPartyB.IsSet() )
//    CCnvDeal.DemandPayment.ReceiverBankID       = MT300.ReceivingAgentAmountPartyB.PartyID;
//    CCnvDeal.DemandPayment.ReceiverBankCodeKind = MT300.ReceivingAgentAmountPartyB.CodeKind;
//    CCnvDeal.DemandPayment.ReceiverBankCode     = MT300.ReceivingAgentAmountPartyB.CodeBank;
//    CCnvDeal.DemandPayment.ReceiverBankName     = MT300.ReceivingAgentAmountPartyB.Name;
//    CCnvDeal.DemandPayment.ReceiverAccount      = MT300.ReceivingAgentAmountPartyB.Account;
//  end;        
//
//  /* Конрагент: откуда поcтупят деньги */
//  if( MT300.DeliveryAgentAmountPartyA.IsSet() )
//    CCnvDeal.LiabilityPayment.PayerBankID       = MT300.DeliveryAgentAmountPartyA.PartyID;
//    CCnvDeal.LiabilityPayment.PayerBankCodeKind = MT300.DeliveryAgentAmountPartyA.CodeKind;
//    CCnvDeal.LiabilityPayment.PayerBankCode     = MT300.DeliveryAgentAmountPartyA.CodeBank;
//    CCnvDeal.LiabilityPayment.PayerBankName     = MT300.DeliveryAgentAmountPartyA.Name;
//    CCnvDeal.LiabilityPayment.PayerAccount      = MT300.DeliveryAgentAmountPartyA.Account;
//  end;      
//  
//  /* Конрагент: через кого*/
//  if( MT300.IntermediaryAmountPartyA.IsSet() )
//    CCnvDeal.LiabilityPayment.ReceiverBankCorrCodeKind  = MT300.IntermediaryAmountPartyA.CodeKind;
//    CCnvDeal.LiabilityPayment.ReceiverBankCorrCode      = MT300.IntermediaryAmountPartyA.CodeBank;
//    CCnvDeal.LiabilityPayment.ReceiverBankCorrName      = MT300.IntermediaryAmountPartyA.Name;
//    CCnvDeal.LiabilityPayment.ReceiverCorrAcc           = MT300.IntermediaryAmountPartyA.Account;
//  end;        
//  
//  /* Конрагент: куда */
//  if( MT300.ReceivingAgentAmountPartyA.IsSet() )
//    CCnvDeal.LiabilityPayment.ReceiverBankID       = MT300.ReceivingAgentAmountPartyA.PartyID;
//    CCnvDeal.LiabilityPayment.ReceiverBankCodeKind = MT300.ReceivingAgentAmountPartyA.CodeKind;
//    CCnvDeal.LiabilityPayment.ReceiverBankCode     = MT300.ReceivingAgentAmountPartyA.CodeBank;
//    CCnvDeal.LiabilityPayment.ReceiverBankName     = MT300.ReceivingAgentAmountPartyA.Name;
//    CCnvDeal.LiabilityPayment.ReceiverAccount      = MT300.ReceivingAgentAmountPartyA.Account;
//  end;      

  /*
  MsgBox( " DealCodePS: ", CCnvDeal.DealCodePS,
          "|DealDate: ", CCnvDeal.DealDate,
          "|ValueDate: ", CCnvDeal.ValueDate,
          "|Rate: ", CCnvDeal.Rate.asDouble,
          "|DemandAmount: ", CCnvDeal.DemandAmount,
          "|DemandFIID: ", CCnvDeal.DemandFIID,
          "|LiabilityAmount: ", CCnvDeal.LiabilityAmount,
          "|LiabilityFIID: ", CCnvDeal.LiabilityFIID,
          "|PartyID :", CCnvDeal.PartyID,
          "|DemandPayment.PayerBankCode: ", CCnvDeal.DemandPayment.PayerBankCode,
          "|DemandPayment.ReceiverBankCorrCode: ", CCnvDeal.DemandPayment.ReceiverBankCorrCode,
          "|DemandPayment.ReceiverBankCode: ", CCnvDeal.DemandPayment.ReceiverBankCode,
          "|LiabilityPayment.PayerBankCode: ", CCnvDeal.LiabilityPayment.PayerBankCode,
          "|LiabilityPayment.ReceiverBankCorrCode: ", CCnvDeal.LiabilityPayment.ReceiverBankCorrCode,
          "|LiabilityPayment.ReceiverBankCode: ", CCnvDeal.LiabilityPayment.ReceiverBankCode );
  */

  /* Возвращаем заполненный объект */
  if( not УстановитьОбъект( CCnvDeal ) )
    std.msg("Ошибка при обработке объекта сделки");
  end;

  return TRUE;
  OnError(er) /* обработка ошибок времени выполнения */
    ExeptionMessage(er);
    return FALSE;
end;

