/*
 $Name:        ofkgmpck.mac
 $Module:      MBR
 $Description: Генерация сообщения по PACKAGE
*/
/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 6.0                      */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/* Генерация сообщения по PACKAGE                                           */
/*                                                                          */
/*  Имя файла: ofkgmpck.mac                                                 */
/*  Создан:  16.04.16                                    Тимонин Д.В.       */
/****************************************************************************/

import xmlmestools;

private macro GetPackageID( ReqID ):string
  var query = " SELECT sess.t_OutsideAbonentInfo "
              "   FROM dwlsess_dbt sess, dwlreqlnk_dbt lnk, dwlreq_dbt req "
              "  WHERE sess.t_SessionID = lnk.t_ObjID "
              "    AND lnk.t_ObjKind = :OBJTYPE_SESS "
              "    AND lnk.t_ReqID = req.t_ReqID "
              "    AND req.t_ReqID = :ReqID ";
  var rs:RsdRecordset = execSQLselect(query, makeArray(SQLParam("OBJTYPE_SESS", OBJTYPE_SESS), SQLParam("ReqID", ReqID)), FALSE );
  if( rs and rs.moveNext() )
    return rs.value(0);
  end;
  return "";
end;

macro GenMes( addrMes, addrReq )
  record wlreq(wlreq);
  SetBuff(wlreq, addrReq);

  PrintLog(2,"Генерация сообщения по PACKAGE");

  УстановитьКонтекстБлокаЛог( "PackageStatusRequest" );
  ЗаписатьПолеЛог( beginField, "PackageStatusRequest" );
//    ЗаписатьПолеЛог( "PackageID", GetPackageID(wlreq.ReqID) );
    ЗаписатьПолеЛог( "PackageID",  pyOR(GetCachedVar("OUTSIDEABONENTINFO"), "") );
  ЗаписатьПолеЛог( endField, "PackageStatusRequest" );

  return TRUE;
end;
