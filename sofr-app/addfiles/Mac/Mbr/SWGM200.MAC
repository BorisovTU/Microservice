/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 5.1                      */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/* Генерация сообщения по SWIFT MT200                                       */
/*                                                                          */
/*  Имя файла: swgm200.mac                                                  */
/*  Создан:  24.01.00                                        Алешин А.В.    */
/****************************************************************************/

import "swgenmes.mac";

macro GenMes( addrMes, addrPm )
  var field_value, DKFlag, Tag, PaymentDetails;
  var RsPaym;
  SetBuff( wlmes,  addrMes );
  SetBuff( wlpmpaym, addrPm );

  PrintLog(2,"Генерация сообщения по МТ200");
  RsPaym = RsbPayment( wlpmpaym.PaymentID );

  /* 20 - номер транзакции (документа) */
  ЗаписатьПолеЛог( TransactionReferenceNumberField, wlmes.TRN );

  /* 32A - дата валютирования, код валюты, сумма */
  field_value = GetSWIFTDate( RsPaym.OutTransferDate ) +
                FillCurrencyOriginalOrderedAmountField( RsPaym );
  ЗаписатьПолеЛог( ValueDateCurrencyCodeAmountField_A, field_value );

  /* 53B - корреспондент отправителя */
  Tag = SWIFT_Tag_B;
  field_value = FillSenderCorrespondentField(RsPaym, Tag );
  ЗаписатьПолеВБлокКонтекст0( Sender_sCorrespondentField+Tag, "", field_value );

  /* 56a - банк посредник */
  Tag = "";
  field_value = FillIntermediaryField(RsPaym, Tag );
  ЗаписатьПолеВБлокКонтекст0( IntermediaryField+Tag, "56a", field_value );  

  /* 57a - банк бенефициара */
  Tag = "";
  field_value = FillAccountWithInstitutionField(RsPaym, Tag, true );
  ЗаписатьПолеВБлокКонтекст0( AccountWithInstitutionField+Tag, "57a", field_value );    

  /* 72 - информация для банка-получателя */
  if( not УстановитьКонтекстБлока() )
     RunError("|Ошибка при установке нулевого контекста блока");
  end;
  PaymentDetails = "";
  StrChangeRusXSet(RsPaym.Ground, PaymentDetails);
  field_value = FillInformationOfPaymentField(RsPaym, ALLOWCODES_MT200_STANDART, PaymentDetails);    
  ЗаписатьПолеЛог( SenderToReceiverInformationField, field_value );

  return TRUE; /* успешное завершение */

  OnError(er) /* обработка ошибок */
    ExeptionMessage(er);
    return false;
end;


