/*
  $Name:         ufgm464.mac
  $Module:       Межбанковские расчеты
  $Description:  Генерация сообщения по ED464
*/

// Генерация сообщения по форме ED464 Запрос об отзыве/аннулировании ЭСИС (пакета ЭСИС)

import "ufgenmes.mac";

private macro GenOrgBIC( mes, CorschemNumber, FIID )
  
  var rs = execSQLSelect( " Select ptcode.t_Code "
                          "   From dpartcode_dbt ptcode, dcorschem_dbt cor, ddp_dep_dbt dep "
                          "  Where cor.t_Number = :Corschem "
                          "    and cor.t_FIID = :FIID "
                          "    and dep.t_Code = cor.t_Department "
                          "    and dep.t_PartyID = ptcode.t_PartyID "
                          "    and ptcode.t_CodeKind = :CodeKind ",
                          MakeArray( SQLParam("Corschem", CorschemNumber),
                                     SQLParam("FIID", FIID),
                                     SQLParam("CodeKind", PTCK_BIC)));
                                     
  if( rs and rs.MoveNext )
    ЗаписатьПолеЛог("OrgBIC", rs.value("t_Code"));
  end;
  
end;

macro GenMes( addrMes, addrReq )
  SetBuff( wlmes,  addrMes );
  SetBuff( wlreq,  addrReq );
  
  var strXml;
  var InitMesId:integer = 0;
  var IsRequestPacket:bool = false;
  var NoInitMes:bool = false;
  var xml:object = ActiveX("Microsoft.XMLDOM");  
  var mes:object, elem: object;
  var iXml:object = ActiveX("Microsoft.XMLDOM");  
  
  var rs:object;
  var select:string;
  var params:TArray;
  var ObjID:integer, ObjKind:integer;

  var ed_nda = NULL;
  ed_nda = EDNoDateAuthor();
  ed_nda.ConstructByTrn(wlmes.TRN);

  ЗаписатьПолеЛог("EDNo",       ed_nda.EDNo );
  ЗаписатьПолеЛог("EDDate",     YYYYMMDD(ed_nda.EDDate));
  ЗаписатьПолеЛог("EDAuthor",   ed_nda.EDAuthor );  

  var EDReceiver = GetEDReceiver(wlreq.RecipientID, wlreq.RecipientcodeKind, wlreq.RecipientCode, null, true);
  if( strlen(EDReceiver) > 0 )
    ЗаписатьПолеЛог("EDReceiver", EDReceiver );
  end;
  
  GenOrgBIC(mes, wlreq.Corschem, wlreq.FIID);
  
  if( wlreq.RecipientCodeKind == PTCK_BIC )
    ЗаписатьПолеЛог("BICPBR", wlreq.RecipientCode);
  else
    ЗаписатьПолеЛог("BICPBR", ПолучитьКодСубъекта(wlreq.RecipientID, PTCK_BIC));
  end;
  
  if( wlreq.RelatedRef != "" )
    StartBlockLogXML("EDRefID");
    ed_nda = NULL;
    ed_nda = EDNoDateAuthor();
    ed_nda.ConstructByTrn(wlreq.RelatedRef);
    
    ЗаписатьПолеЛог("EDNo",       ed_nda.EDNo );
    ЗаписатьПолеЛог("EDDate",     YYYYMMDD(ed_nda.EDDate));
    ЗаписатьПолеЛог("EDAuthor",   ed_nda.EDAuthor );  
    
    FinishBlockLogXML("EDRefID");
  end;
  
  return true;
  
end;