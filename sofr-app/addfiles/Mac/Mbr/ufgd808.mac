/*
  $Name:         ufgd808.mac
  $Module:       Межбанковские расчеты
  $Description:  Генерация УО "Информационное сообщение" по сообщениям УФЭБС ED808
*/

import "ufgendoc.mac", PTInter, likepy, oralib, "pmlib.mac", wltools, bnk_dttmfrmt, bnk_dirfile, bnk_common;
import "ufgd808_class.mac";


macro GenDoc( addrMes )
  var FileDirectory = Bnk_GetTxtFileDir();
  var Narrative : string = "";
  var XmlObj : object = ActiveX("Microsoft.XMLDOM");
  var stat = 0;
  SetBuff( wlmes, addrMes );
  ClearRecord( wlinfo );
  PrintLog( 2, "Генерация информационного сообшения по ED808" );
  
  var ImageID = 0;
  var sWlMesID : string = makeObjectID( OBJTYPE_MES, null, wlmes );

  ImageID = Bnk_GetImageID( OBJTYPE_MES, sWlMesID, WLD_MES_IMGTYPE_XML_FILE );

  if( ImageID )
    /* Записываем прикрепленный ED807 во временный XML-файл */
    var tmpXMLFileName = FileDirectory + "\\" + wlmes.TRN + ".xml";
    stat = WEB_ShowImageByID( ImageID, tmpXMLFileName );
    if( not stat )
      XmlObj = null;
    else
      if ( not XmlObj.load( tmpXMLFileName ) )
        std.msg( "Неверный формат сообщения" );
        return FALSE;
      end;
    end;
    /* Удаляем временный XML-файл с ED807 */
    RemoveFile( tmpXMLFileName );
  else
    XmlObj = null;
  end;

  var ED808MessageFields = TED808MessageFields();
  ReadED808MessageFields( @ED808MessageFields, XmlObj );

  var tmpPartyID = 0;
  
  wlinfo.TRN                = wlmes.Trn;
  wlinfo.RelatedRef         = wlmes.RelatedRef;
  wlinfo.Direct             = "X"; /*WLD_MES_IN*/

  wlinfo.OriginatorCode     = ED808MessageFields.EDAuthor;
  wlinfo.OriginatorCodeKind = PTCK_UIS; 
  tmpPartyID = 0;
  tmpPartyID = GetCodeOwnerID( wlinfo.OriginatorCodeKind, wlinfo.OriginatorCode );
  if( tmpPartyID > 0 )
    wlinfo.OriginatorID       = tmpPartyID;
    wlinfo.OriginatorName     = Bnk_GetPartyName( wlinfo.OriginatorID );
  end;

  wlinfo.RecipientCode      = wlmes.InsideAbonentCode;
  wlinfo.RecipientCodeKind  = wlmes.InsideAbonentCodeKind;
  tmpPartyID = 0;
  tmpPartyID = GetCodeOwnerID( wlinfo.RecipientCodeKind, wlinfo.RecipientCode ); 
  if( tmpPartyID > 0 )
    wlinfo.RecipientID        = tmpPartyID;
    wlinfo.RecipientName      = Bnk_GetPartyName( wlinfo.RecipientID );
  end;
  
  var CreationDate = "", CreationTime = "";
  DivideYYYY_MM_DDThhmmssZToDateTime( ED808MessageFields.CreationDateTime, @CreationDate, @CreationTime );
  
  Narrative = "CreationDate (дата создания ЭС): " + CreationDate + " CreationTime (время создания ЭС): " + CreationTime + "\n";
  
  Narrative = Narrative + "InfoTypeCode (вид информации): " + ED808MessageFields.InfoTypeCode + " " + 
                          GetWlcodeDescription( TYPE_CODE_UFBS_ED801_INFOTYPECODE, string( "/" + ED808MessageFields.InfoTypeCode + "/" ) ) + "\n";
  var i = 0;
  var j = 0;
  
  while( i < ED808MessageFields.CreationReason.CreationReasonCode.size )
    Narrative = Narrative + "CreationReasonCode (Код причины формирования ED808): " + ED808MessageFields.CreationReason.CreationReasonCode[i] + " " +
                            GetWlcodeDescription(TYPE_CODE_UFBS_ED808_CREATIONREASONCODE, ED808MessageFields.CreationReason.CreationReasonCode[i]) + "\n";
    i = i + 1;
  end;
  
  i = 0;
  
  var llvalueName = "";
  
  if(CheckObjectElem( ED808MessageFields, "BICDirectoryEntry.ParticipantInfo.RstrList"))
    while( i < ED808MessageFields.BICDirectoryEntry.ParticipantInfo.RstrList.size )
      GetElementAndNoteLLVALUES(4056, ED808MessageFields.BICDirectoryEntry.ParticipantInfo.RstrList[i].Rstr, null, null, llvalueName);
      Narrative = Narrative + "Rstr (Код ограничения, наложенного на участника): " + ED808MessageFields.BICDirectoryEntry.ParticipantInfo.RstrList[i].Rstr + " " +
                              llvaluename + "\n";
                              
      i = i + 1;
    end;
  end;
  
  i = 0;
  
  if(CheckObjectElem( ED808MessageFields, "BICDirectoryEntry.Accounts"))
    while( i < ED808MessageFields.BICDirectoryEntry.Accounts.size )
      j = 0;
      if(CheckObjectElem( ED808MessageFields.BICDirectoryEntry.Accounts[i], "AccRstrList"))
        while( j < ED808MessageFields.BICDirectoryEntry.Accounts[i].AccRstrList.size)
          GetElementAndNoteLLVALUES(4059, ED808MessageFields.BICDirectoryEntry.Accounts[i].AccRstrList[j].AccRstr, null, null, llvalueName);
          Narrative = Narrative + "AccRstr (Код ограничения операций по счету): " + ED808MessageFields.BICDirectoryEntry.Accounts[i].AccRstrList[j].AccRstr + " " +
                                  llvaluename + "\n";
          j = j + 1;
        end;
      end;
                              
      i = i + 1;
    end;
  end;
  
  i = 0;
  j = 0;
  
  if(CheckObjectElem( ED808MessageFields, "ParticipantProfile.ParticipantProfileInfo.IntradayRestrictions.StopUrgentFTS.Applied"))  
    if(ED808MessageFields.ParticipantProfile.ParticipantProfileInfo.IntradayRestrictions.StopUrgentFTS.Applied == "1")
      Narrative = Narrative + "StopUrgentFTS (Ограничение предоставления сервиса срочного перевода): Да\n";
    end;
  end;
  
  if(CheckObjectElem( ED808MessageFields, "ParticipantProfile.ParticipantProfileInfo.IntradayRestrictions.StopSendFTI.Applied"))
    if(ED808MessageFields.ParticipantProfile.ParticipantProfileInfo.IntradayRestrictions.StopSendFTI.Applied == "1")
      Narrative = Narrative + "StopSendFTI (Ограничение направления распоряжений): Да\n";
    end;
  end;
  
  if(CheckObjectElem( ED808MessageFields, "ParticipantProfile.ParticipantProfileInfo.IntradayRestrictions.StopSendRecvEM.Applied"))
    if(ED808MessageFields.ParticipantProfile.ParticipantProfileInfo.IntradayRestrictions.StopSendRecvEM.Applied == "1")
      Narrative = Narrative + "StopSendRecvEM (Ограничение направления и получения ЭС): Да\n";
    end;
  end;
  
  if(CheckObjectElem( ED808MessageFields, "ParticipantProfile.ParticipantProfileInfo.IntradayRestrictions.StopSendEM.Applied"))
    if(ED808MessageFields.ParticipantProfile.ParticipantProfileInfo.IntradayRestrictions.StopSendEM.Applied == "1")
      Narrative = Narrative + "StopSendEM (Ограничение направления ЭС): Да\n";
    end;
  end;
  
  if(CheckObjectElem( ED808MessageFields, "ParticipantProfile.ParticipantProfileInfo.IntradayRestrictions.PendingDeletion.Applied"))
    if(ED808MessageFields.ParticipantProfile.ParticipantProfileInfo.IntradayRestrictions.PendingDeletion.Applied == "1")
      Narrative = Narrative + "PendingDeletion (В ожидании удаления): Да\n";
    end;
  end;
  if(CheckObjectElem( ED808MessageFields, "ParticipantProfile.AccountsInfo"))
    while( i < ED808MessageFields.ParticipantProfile.AccountsInfo.size)
      if( ED808MessageFields.ParticipantProfile.AccountsInfo[i].AccountType == "CRSA" )
        
        if(CheckObjectElem( ED808MessageFields.ParticipantProfile.AccountsInfo[i], "AccIntradayRestrictions.StopDebits.Applied"))
          if(ED808MessageFields.ParticipantProfile.AccountsInfo[i].AccIntradayRestrictions.StopDebits.Applied == "1")
            Narrative = Narrative + "StopDebits (Остановка списания с корсчета): Да\n";
          end;
        end;
        
        if(CheckObjectElem( ED808MessageFields.ParticipantProfile.AccountsInfo[i], "AccIntradayRestrictions.StopCredits.Applied"))
          if(ED808MessageFields.ParticipantProfile.AccountsInfo[i].AccIntradayRestrictions.StopCredits.Applied == "1")
            Narrative = Narrative + "StopCredits (Остановка зачисления на корсчет): Да\n";
          end;
        end;
        
        if(CheckObjectElem( ED808MessageFields.ParticipantProfile.AccountsInfo[i], "AccIntradayRestrictions.StopUrgentFTS.Applied"))
          if(ED808MessageFields.ParticipantProfile.AccountsInfo[i].AccIntradayRestrictions.StopUrgentFTS.Applied == "1")
            Narrative = Narrative + "StopUrgentFTS (Остановка предоставления сервиса срочного перевода по корсчету): Да\n";
          end;
        end;
        
        if(CheckObjectElem( ED808MessageFields.ParticipantProfile.AccountsInfo[i], "AccIntradayRestrictions.PendingDeletion.Applied"))
          if(ED808MessageFields.ParticipantProfile.AccountsInfo[i].AccIntradayRestrictions.PendingDeletion.Applied == "1")
            Narrative = Narrative + "PendingDeletion (Корсчет в ожидании удаления): Да\n";
          end;
        end;
        
        if(CheckObjectElem( ED808MessageFields.ParticipantProfile.AccountsInfo[i], "AccIntradayRestrictions.RouteToCBR.Applied"))
          if(ED808MessageFields.ParticipantProfile.AccountsInfo[i].AccIntradayRestrictions.RouteToCBR.Applied == "1")
            Narrative = Narrative + "RouteToCBR (Контроль КБР перед зачислением): Да\n";
          end;
        end;
        
        if(CheckObjectElem( ED808MessageFields.ParticipantProfile.AccountsInfo[i], "AccIntradayRestrictions.ManualVerifMode.Applied"))
          if(ED808MessageFields.ParticipantProfile.AccountsInfo[i].AccIntradayRestrictions.ManualVerifMode.Applied == "1")
            Narrative = Narrative + "ManualVerifMode (Предварительный контроль ПБР): Да\n";
          end;
        end;
        
        if(CheckObjectElem( ED808MessageFields.ParticipantProfile.AccountsInfo[i], "AccIntradayRestrictions.Arrest.Applied"))
          if(ED808MessageFields.ParticipantProfile.AccountsInfo[i].AccIntradayRestrictions.Arrest.Applied == "1")
            Narrative = Narrative + "Arrest (Арест или ограничение на неопределенную сумму): Да\n";
          end;
        end;
        
        if(CheckObjectElem( ED808MessageFields.ParticipantProfile.AccountsInfo[i], "AccIntradayRestrictions.SpecialMode.Applied"))
          if(ED808MessageFields.ParticipantProfile.AccountsInfo[i].AccIntradayRestrictions.SpecialMode.Applied == "1")
            Narrative = Narrative + "SpecialMode (Наличие к счету очереди неисполненных в срок распоряжений): Да\n";
          end;
        end;
        
        
        j = 0;
        var IndeterminateAmountFlag = false;
        if(CheckObjectElem( ED808MessageFields.ParticipantProfile.AccountsInfo[i], "ArrestsInfo.ArrestDetailedInfo")) 
          while( (j < ED808MessageFields.ParticipantProfile.AccountsInfo[i].ArrestsInfo.ArrestDetailedInfo.size) and (not IndeterminateAmountFlag))
            if(ED808MessageFields.ParticipantProfile.AccountsInfo[i].ArrestsInfo.ArrestDetailedInfo[j].IndeterminateAmountFlag == "1")
              IndeterminateAmountFlag = true;
            end;
            j = j + 1;
          end;
        end;
        
        j = 0;
        
        if(IndeterminateAmountFlag)
          Narrative = Narrative + "ArrestsInfo (Наличие к счету арестов и\\или ограничений без суммы): Да\n";
        end;
        
        if(CheckObjectElem( ED808MessageFields.ParticipantProfile.AccountsInfo[i], "ArrestsInfo.ArrestDetailedInfo")) 
          while( j < ED808MessageFields.ParticipantProfile.AccountsInfo[i].ArrestsInfo.ArrestDetailedInfo.size)
            if( (ValType( ED808MessageFields.ParticipantProfile.AccountsInfo[i].ArrestsInfo.ArrestDetailedInfo[j].IndeterminateAmountFlag) != V_UNDEF)
            and (ED808MessageFields.ParticipantProfile.AccountsInfo[i].ArrestsInfo.ArrestDetailedInfo[j].IndeterminateAmountFlag != "1")
            and (ValType(ED808MessageFields.ParticipantProfile.AccountsInfo[i].ArrestsInfo.ArrestDetailedInfo[j].ArrestAmount) != V_UNDEF)
            and (ED808MessageFields.ParticipantProfile.AccountsInfo[i].ArrestsInfo.ArrestDetailedInfo[j].ArrestAmount != ""))
              Narrative = Narrative + "ArrestsInfo (Наличие к счету арестов и\\или ограничений на сумму): " + 
              money(ED808MessageFields.ParticipantProfile.AccountsInfo[i].ArrestsInfo.ArrestDetailedInfo[j].ArrestAmount)/100 +  "\n";
            end;
            j = j + 1;
          end;
        end;
      end;
      i = i + 1;
    end;
  end;
  
  i = 0;
  j = 0;
  
  
  
  if( not ВставитьИнфСообщение( wlinfo, Narrative ) )
    std.msg( "Ошибка при генерации УО по сообщению ED808" );
    return FALSE;
  end;

  return TRUE;

  OnError(er) /* Обработка ошибок времени выполнения */
    std.msg(String(er.Message, "|Модуль: ", er.Module, " Строка: ", er.Line));
    return FALSE;
end;