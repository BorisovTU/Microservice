import "swdpgmes.mac";

RECORD Corschem( corschem );


macro GenMes( addrMes, addrbuf )
  RECORD DpBuf( dpmsginf );
  var msginf, msgLink, msgParty;  

  SetBuff( wlmes,  addrMes );
  SetBuff( DpBuf,  addrbuf );

  msginf = RsbDepoInfoMessage(DpBuf.MessageID);
  if ( valtype(msginf)==V_UNDEF )
     RunError( "|Не определен объект класса" );
  end;

  /* Блок GENL (начало) */
  ЗаписатьПолеЛогВБлок( GENL_Block, StartOfBlock, GENL_Block );
    if ( msginf.SenderReference=="" )
       RunError( "|Не заполнен номер исходящего сообщения" );
    end;
  /*   28E */
//  ЗаписатьПолеЛог( StatementSequnceNumberEField, string(substr(msginf.PageNumber,strlen(msginf.PageNumber)-4), "/", msginf.PageKind) );
  /*  13A */
  /*  20C */
  if ( msginf.ProcessingCode!="" )
     ЗаписатьПолеЛог( SendersReferenceField, ":SEME//"+msginf.ProcessingCode ) ;
  end;

  /*  23G   */
  ЗаписатьПолеЛог( FunctionMessageField, GetMessageFunction(msginf) ) ;
  /*   A/98a/PREP  */

  if ( msginf.PreparationDate!=date(0,0,0) )
    if( not УстановитьКонтекстБлока( "98a" ) )
      RunError("|Ошибка при установке контекста блока 98a");
    end;
    ЗаписатьПолеЛог( PreperationDateTimeField, ":PREP//"+GetSWIFTDateFull(msginf.PreparationDate)+
                                                         GetSWIFTTimeFull(msginf.PreparationTime) );  
    if( not УстановитьКонтекстБлока( ".." ) )
      RunError("|Ошибка при установке контекста блока ..");
    end;
  end;
  /*   A/98a/STAT  */
  if ( msginf.SettlementDate!=date(0,0,0) )
    if( not УстановитьКонтекстБлока( "98a" ) )
      RunError("|Ошибка при установке контекста блока 98a");
    end;
    ЗаписатьПолеЛог( PreperationDateTimeField, ":STAT//"+GetSWIFTDateFull(msginf.SettlementDate)+
                                                         GetSWIFTTimeFull(msginf.SettlementTime) );  
    if( not УстановитьКонтекстБлока( ".." ) )
      RunError("|Ошибка при установке контекста блока ..");
    end;
  end;

  if (msginf.ReportPeriod )
    if( not УстановитьКонтекстБлока( "22" ) )
     RunError("|Ошибка при установке контекста блока 22");
    end;                                               
    ЗаписатьПолеЛог( IndicatorField, ":SFRE//"+GetllValueElement(OBJTYPE_MSGTRANS, msginf.ReportPeriod, NULL));
    if( not УстановитьКонтекстБлока( ".." ) )
         RunError("|Ошибка при установке контекста блока ..");
    end;
  end;

  if( not УстановитьКонтекстБлока( "22" ) )
   RunError("|Ошибка при установке контекста блока 22");
  end;                                               
  ЗаписатьПолеЛог( IndicatorField, ":CODE//"+GetllValueElement(OBJTYPE_MSGTRANS, msginf.FullReport, NULL) );
  if( not УстановитьКонтекстБлока( ".." ) )
       RunError("|Ошибка при установке контекста блока ..");
  end;

  if( not УстановитьКонтекстБлока( "22" ) )
   RunError("|Ошибка при установке контекста блока 22");
  end;                                               
  ЗаписатьПолеЛог( IndicatorField, ":STTY//"+GetllValueElement(OBJTYPE_MSGTRANS, msginf.FullReport, NULL) );

  if( not УстановитьКонтекстБлока( ".." ) )
       RunError("|Ошибка при установке контекста блока ..");
  end;
   /* Блок LINK (начало) */
  if( not УстановитьКонтекстБлока( LINK_Block ) )
    RunError("|Ошибка при установке контекста блока " + LINK_Block);
  end;
    if ( GetMessageFunction(msginf)=="CANC" )
       msginf.RewindLinkedMessage();
       msgLink = msginf.GetLinkedMessage();
       if ( valtype(msgLink)==V_UNDEF )
          RunError("|Отсутствует обязательная последовательность связок (блок LINK)");
       end;
       while( valtype(msgLink)!=V_UNDEF )
          ЗаписатьПолеЛог( StartOfBlock, LINK_Block );
          ЗаписатьПолеЛог( LinkedTransactionField, ":LINK//541");
          ЗаписатьПолеЛог( SendersReferenceField, ":RELA//"+msgLink.ReceiverReference ) ;
          ЗаписатьПолеЛог( EndOfBlock, LINK_Block );
          ЗаписатьПолеЛог( StartOfBlock, LINK_Block );
          msgLink = msginf.GetLinkedMessage();
       end;
    end;
  if( not УстановитьКонтекстБлока( ".." ) )
    RunError("|Ошибка при установке контекста блока ..");
  end;
 /* Блок LINK (конец) */


 ЗаписатьПолеЛог( EndOfBlock, GENL_Block ) ;
 /* Блок GENL (конец) */

   /*----------------------------------------------------------------*/

  /*   SUBSAFE_Block   начало       
  ЗаписатьПолеЛогВБлок( SUBSAFE_Block, StartOfBlock, SUBSAFE_Block );
  /*  B/97A/SAFE */
  if( not УстановитьКонтекстБлока( "97a" ) )
    RunError("|Ошибка при установке контекста блока 97a");
  end;
  if ( (msginf.Account!="") and (msginf.Partition!="") )
     ЗаписатьПолеЛог( AccountAField, ":SAFE//"+msginf.Account+"/KRZD/"+msginf.Partition);
  else
     RunError("|Не задан счет/раздел депо продавца");
  end;
  if( not УстановитьКонтекстБлока( ".." ) )
    RunError("|Ошибка при установке контекста блока ..");
  end;
  /*  17B  */
  /*   FIN_Block  начало 
  УстановитьКонтекстБлока( FIN_Block );
  ЗаписатьПолеЛог( StartOfBlock, FIN_Block );*/
  /*   35B */
  ЗаписатьПолеЛог( IdentificationOfSecuritiesField, CreateIdentificationOfSecurities(msginf) );

  УстановитьКонтекстБлока( FIA_Block );
  ЗаписатьПолеЛог( StartOfBlock, FIA_Block );   /* По ТЗ блок FIA пустой  */
  ЗаписатьПолеЛог( EndOfBlock, FIA_Block ) ;
  if( not УстановитьКонтекстБлока( ".." ) )
    RunError("|Ошибка при установке контекста блока ..");
  end;

//  ЗаписатьПолеЛог(AggregateBalanceSum, string ("AGGR//",СуммарноПоВсемОстаткам(msginf)));
  /*   SUBBAL_Block  начало 
  УстановитьКонтекстБлока( SUBBAL_Block );
  ЗаписатьПолеЛог( StartOfBlock, SUBBAL_Block );   */
  if( not УстановитьКонтекстБлока( "93a" ) )
    RunError("|Ошибка при установке контекста блока ..");
  end;

//  ЗаписатьПолеЛог(AggregateBalanceSum, string ("TAVI//", msginf.GetMessageFi().Rest) );  
  if( not УстановитьКонтекстБлока( ".." ) )
    RunError("|Ошибка при установке контекста блока ..");
  end;

//  ЗаписатьПолеЛог( EndOfBlock, SUBBAL_Block ) ;
    /*   SUBBAL_Block  конец */
  if( not УстановитьКонтекстБлока( ".." ) )
    RunError("|Ошибка при установке контекста блока ..");
  end;
//  ЗаписатьПолеЛог( EndOfBlock, FIN_Block ) ;
   /*   FIN_Block  Конец */
  if( not УстановитьКонтекстБлока( ".." ) )
    RunError("|Ошибка при установке контекста блока ..");
  end;
  ЗаписатьПолеЛог( EndOfBlock, SUBSAFE_Block ) ;
      SUBSAFE_Block  Конец */ 

  /* -------------------------------------------------------------------------*/
  /*   ADDINFO_Block  начало 
  ЗаписатьПолеЛогВБлок( ADDINFO_Block, StartOfBlock, ADDINFO_Block );
  ЗаписатьИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_MEOR,msgParty); 
  ЗаписатьИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_MERE,msgParty);
  ЗаписатьПолеЛог( EndOfBlock, ADDINFO_Block ) ;
                             */
  return TRUE; /* Успешное завершение */

  OnError(er) /* обработка ошибок */
    ExeptionMessage(er);
    return FALSE;
end;
