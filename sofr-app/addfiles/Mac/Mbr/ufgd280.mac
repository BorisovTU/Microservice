/*
$Name:         ufgd280.mac
$Module:       Межбанковские расчеты
$Description:  Генерация учетного объекта ED280
*/

// ED280 Извещение о получении ЭС

import "ufgendoc.mac";

macro GenDoc( addrMes )
  var xml:object = ActiveX( "MSXML.DOMDocument" );
  var EDNo, EDDate, EDAuthor, EDReceiver, EDCreationTime, OrgBIC, BICPBR, NameClient, InitialED, InitEDNo, InitEDDate, InitEDAuthor;
  
  SetBuff( wlmes, addrMes );

  PrintLog( 2, "Генерация информационного сообшения по ED280" );

  var FieldName, FieldValue, BlockName;
  while(СчитатьПоле(FieldName, FieldValue, BlockName))
      if( BlockName == "" )
        if( FieldName == "EDNo" )
          EDNo = FieldValue;
        elif( FieldName == "EDDate")
          EDDate = FieldValue;
        elif( FieldName == "EDAuthor" )
          EDAuthor = FieldValue;
        elif( FieldName == "EDReceiver" )
          EDReceiver = FieldValue;
        elif( FieldName == "EDCreationTime" )
          EDCreationTime = FieldValue;
        elif( FieldName == "OrgBIC" )
          OrgBIC = FieldValue;
        elif( FieldName == "BICPBR" )
          BICPBR = FieldValue;
        end;
      elif( BlockName == "NameClient")
        if( FieldName == "NameClient")
          NameClient = FieldValue;
        end;
      elif( BlockName == "InitialED" )
        if( (FieldName == "EDNo") and (BlockName == "InitialED") )
          InitEDNo = FieldValue;
        elif( (FieldName == "EDDate") and (BlockName == "InitialED") )
          InitEDDate = FieldValue;
        elif( (FieldName == "EDAuthor") and (BlockName == InitialED) )
          InitEDAuthor = FieldValue;
        end;
      end;
  end;

  if( strlen(wlmes.RelatedRef) == 0 )
    RunError("Не найдено исходящее сообщение");
  end;
  
  var rs = execSQLSelect( " Select out.t_MesID "
                          "   From dwlmes_dbt out, dwlmesrls_dbt rls, dwlmesfrm_dbt frm  "
                          "  Where out.t_Trn = :RelatedRef "
                          "    and out.t_Direct = chr(0) "
                          "    and out.t_RlsFormID = rls.t_RlsFormID "
                          "    and rls.t_FormID = frm.t_FormID "
                          "    and frm.t_TpID = :TpID ",
                          MakeArray( SQLParam("RelatedRef", wlmes.RelatedRef),
                                     SQLParam("TpID", 9)));
  if( not (rs and rs.MoveNext()) )
    RunError("Не найдено исходящее сообщение № " + InitEDNo + " от " + InitEDDate);
  else
    ВставитьПодтверждениеОДоставке( rs.value("t_MesID"), null, null, string("Сообщение № " + InitEDNo + " от " + InitEDDate + " успешно прошло регламентный контроль у контрагента"), true, 0, 40, null, null, null, 100 );
  end;
  
  while( rs.MoveNext() )
    ВставитьПодтверждениеОДоставке( rs.value("t_MesID"), null, null, string("Сообщение № " + InitEDNo + " от " + InitEDDate + " успешно прошло регламентный контроль у контрагента"), true, 0, 40, null, null, null, 100 );;
  end;

  return TRUE;

  OnError(er) /* Обработка ошибок времени выполнения */
    std.msg(String(er.Message, "|Модуль: ", er.Module, " Строка: ", er.Line));
    return FALSE;

end;

macro GenDocV2( addrMes )
   return GenDoc( addrMes );
end;
