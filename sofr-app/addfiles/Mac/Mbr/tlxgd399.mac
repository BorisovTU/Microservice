/*
  $Name:         swgd399.mac
  $Module:       МБР
  $Description:  Генерация учетных объектов ообщениям SWIFT MT399
*/

/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 5.1                      */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/*          Генерация учетных объектов ообщениям SWIFT MT399                */
/*                                                                          */
/*  Имя файла: swgd399.mac                                                  */
/*  Создан: 15.04.03                                          Панов А.Б.    */
/****************************************************************************/

import "wldoc.mac", BankInter, CTInter;
/*ищем в 79 поле BANKNOTES CONFIRMATION, если нашли, значит сообщение по банкнотной сделке*/
macro IsBanknote( MesID )
  var select = "select *"+
                 "from dwlmesval_dbt "+ 
                "where t_MesID =: MesID "+
                  "and t_FieldID = 1899 "+
                  "and t_TpFieldID = 42 " +
                  "and lower(T_VALUE) LIKE 'banknote%' " 
                  ;
  var params = makeArray( SQLParam("MesID", MesID));
  var rs = execSQLselect( select, params, FALSE );
  return rs.moveNext();
end;

/* Собственно сама генерация */
macro GenDoc( addrMes )

  SetBuff( wlmes, addrMes );
  var type = OBJTYPE_NETTING;
  var text ="Генерация подтверждения сделки неттинга по МТ399";
  if( IsBanknote(wlmes.MesID) )
    type = OBJTYPE_FXOPER_DV;
    text ="Генерация подтверждения банкнотной сделки по МТ399";
  end;
  PrintLog( 2, text);

  /* На этапе генерации по МТ399 никаких учетных объектов не вставляем
     Создаётся фиктивная связь сообщения с нулевым объектом */
  var stat:integer = ConnectMessageToObject( wlmes.MesID, "X", type, 0 );
  if( stat )
    std.msg( GetErrMsg() );
  end;
  return (stat == 0);

  OnError(er) /* обработка ошибок времени выполнения */
    ExeptionMessage(er);
    return FALSE;
end;

