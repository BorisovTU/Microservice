/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 5.1                      */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/* Генерация подтверждений о доставке SWIFT                                 */
/*                                                                          */
/*  Имя файла: swgdACK.mac                                                  */
/*  Создан:    04.06.04                                       Бабин А.П.    */
/****************************************************************************/

import "swgendoc.mac", rsd, oralib, likepy;

/* Релиз ACK */
macro GenDoc( addrMes )
  var field_name, field_value;
  var rs:object;
  var select:string;
  var params:TArray;

  SetBuff( wlmes, addrMes );

  PrintLog(2,"Генерация подтверждения о доставке по форме ACK");

  select = "select t_mesID, t_state from dwlmes_dbt where t_direct=chr(0) and T_TRN= :RelatedRef and T_Department = :OperD";
  params = makeArray( SQLParam("RelatedRef",wlmes.RelatedRef ),
                      SQLParam("OperD", {OperDprt}));
  rs = execSQLselect( select, params, FALSE );
  if ( not rs.MoveNext() )
     std.msg( string("|Не найдено исходящее сообщение ", wlmes.RelatedRef) );
     return false;
  end;

  if ( rs.value(1)>30 )
     return true;
  elif ( rs.value(1)<30 )
     std.msg( string("|Исходящее сообщение ", wlmes.RelatedRef, " не отправлено") );
     return false;
  end;

  if ( not ВставитьПодтверждениеОДоставке(rs.value(0)) )
     std.msg( string("|Ошибка при переносе в доставленные сообшения ", wlmes.RelatedRef) ); 
     return false;
  end;

  return true;

  OnError(er) /* Обработка ошибок времени выполонения */
    ExeptionMessage(er);
    return FALSE;
end;