/*
  $Name: ufpr245.mac
  $Module: Œ¥¦¡ ­ª®¢áª¨¥ à áç¥âë
  $Description: ¥ç â­ ï ä®à¬  á®®¡é¥­¨ï ED245 âà ­á¯®àâ  “”‘
*/


import oralib, MesInter, ufgd245, wltools;

private class TFoundMesFields
  var Type,
      IMGroupQuantity : integer,
      ReceiverTypeCode,
      IMInfoEDNo,
      IMInfoEDDate,
      IMInfoEDAuthor,
      RefEDNo,
      RefEDDate,
      RefEDAuthor,
      RefTrn,
      SessID,
      SessDate,
      SessType;
end;

private macro CreateTrn( EDNo, EDDate, EDAuthor)
  var Trn = "";
  var rs = execSQLSelect( " select TO_CHAR( :EDDate, 'YYMMDD') || :EDAuthor || :EDNo as t_Trn from dual ",
                          MakeArray(SQLParam("EDDate", EDDate),
                                    SQLParam("EDAuthor", EDAuthor),
                                    SQLParam("EDNo", EDNo)));
                                    
  if( rs and rs.MoveNext)
    Trn = rs.value("t_Trn");
  end;
  
  return Trn;
end;

private macro PrintHeader(ED245Mes : TED245MessageFields, wlmes)
  
  var rs = execSQLSelect( " Select info.t_OriginatorCode, info.t_OriginatorName, info.t_RecipientCode, info.t_RecipientName, info.t_OfficeCode, pt.t_Name "
                          "   From dwlinfo_dbt info, dwlmeslnk_dbt lnk, dparty_dbt pt "
                          "  Where lnk.t_MesID   = :MesID "
                          "    and lnk.t_ObjKind = :ObjKind "
                          "    and info.t_InfoID = lnk.t_ObjID "
                          "    and pt.t_PartyID(+)  = info.t_OfficeID ",
                          MakeArray( SQLParam("MesID",   wlmes.MesID),
                                     SQLParam("ObjKind", OBJTYPE_INFO) 
                                   )
                        );
                          
  var OriginatorCode : string = "",
      OriginatorName : string = "",
      RecipientCode  : string = "",
      RecipientName  : string = "",
      OfficeCode     : string = "",
      OfficeName     : string = "";
      
  if( rs and rs.MoveNext() )
    OriginatorCode = rs.value("t_OriginatorCode");
    OriginatorName = rs.value("t_OriginatorName");
    RecipientCode = rs.value("t_RecipientCode");
    RecipientName = rs.value("t_RecipientName");
    OfficeCode = rs.value("t_OfficeCode");
    if( valtype(rs.value("t_Name")) == V_STRING )
      OfficeName = rs.value("t_Name");
    end;
  end;
  
  [
    ED245 âç¥â ¤«ï ¢ë¢¥àª¨ ¨­ä®à¬ æ¨®­­ëå ‘ˆ‘

    ®¬¥à C:      #########
    „ â  C:       ##########
    ‘®áâ ¢¨â¥«ì:   ########## ##################################################
    ®«ãç â¥«ì:    ########## ##################################################
    ®¤à §¤¥«¥­¨¥: ########## ##################################################
    
    ¡é¥¥ ª®«¨ç¥áâ¢® á®®¡é¥­¨© ¢ ®âç¥â¥: #########
  ]( ED245Mes.EDNo,
     DDpMMpYYYY(ED245Mes.EDDate), 
     OriginatorCode, OriginatorName,
     RecipientCode, RecipientName,
     OfficeCode, OfficeName,
     ED245Mes.IMQuantity
   );
end;

private macro FoundMesTableTitle( ReceiverTypeCode : string )
  [ 
    ################################################    
  ](GetWlcodeDescription(TYPE_CODE_UFBS_ED245_RECEIVERTYPECODE, ReceiverTypeCode));
end;

private macro FoundMesTableHeader(Type : string)
  var rs = execSQLSelect( " Select frm.t_Description "
                          "   from dwlmesfrm_dbt frm "
                          "  Where frm.t_TpID = 9 "
                          "    and frm.t_Name = :FormName ",
                          MakeArray(SQLParam("FormName", Type)));
  var Description = "";
  
  if( rs and rs.MoveNext() )
    Description = rs.value("t_Description");
  end;
                                                                                                                                                            
  [   
    ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
    ³ ® â¨¯ã á®®¡é¥­¨ï: ##### - ########################################################################################################################## ³
    ÃÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
    ³           ³                           ‚ ®âç¥â¥ ED245                                  ³                      ‚ RS-Bank V.6                            ³
    ³   ®¬¥à   ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
    ³    ¯/¯    ³        ˆ¤¥­â¨ä¨ª â®àë ‘ˆ‘          ³      ˆ¤¥­â¨ä¨ª â®àë ¯ ª¥â  ‘ˆ‘     ³         ¥ä¥à¥­á          ³               ‘¥ ­á               ³
    ³           ÃÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄ´    ­ ©¤¥­®£® á®®¡é¥­¨ï    ÃÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ´
    ³           ³   ®¬¥à   ³    „ â     ³‘®áâ ¢¨â¥«ì ³   ®¬¥à   ³    „ â     ³‘®áâ ¢¨â¥«ì ³                           ³   ®¬¥à   ³   „ â      ³   ’¨¯    ³
    ÃÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄ´
  ](Type, Description:w);
end;

private macro FoundMesTableBottom(Type : string, NumMes : integer, NumFoundMes : integer)

  [ ÃÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ³
    ³   ˆâ®£®   ³ #####, ãª § ­­ëå ¢ ®âç¥â¥: #####                                          ³  ©¤¥­­ëå #####: #####                                        ³
    ÀÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
  ](Type, NumMes, Type, NumFoundMes);
end;

private macro FoundMesTableElem( TableFields : TFoundMesFields, NumMes, NumFoundMes : @integer )
  var Trn = "", SessNumber = "", SessDate = "", SessType = "";
  var rs = execSQLSelect( " Select mes.t_Trn, sess.t_Number, sess.t_BankDate, " +
                          " case " +
                          "   when sess.t_Direct = chr(0) then " +
                          "     'â¯à ¢ª ' " +
                          "   when sess.t_Direct = 'X' then " +
                          "     'à¨¥¬' " +
                          "   else " +
                          "     chr(1) " +
                          " end as t_DirectName " +
                          "   From dwlmes_dbt mes, dwlsess_dbt sess " +
                          "  Where mes.t_Trn = TO_CHAR( TO_DATE(:EDDate, 'dd.mm.yyyy'), 'YYMMDD') || :EDAuthor || :EDNo " +
                          "    and sess.t_SessionID = mes.t_SessionID ",
                          MakeArray(SQLParam("EDDate", TableFields.IMInfoEDDate),
                                    SQLParam("EDAuthor", TableFields.IMInfoEDAuthor),
                                    SQLParam("EDNo", TableFields.IMInfoEDNo)));
  if( rs and rs.MoveNext() )
    NumFoundMes = NumFoundMes + 1;
    Trn = rs.value("t_Trn");
    SessNumber = rs.value("t_Number");
    SessDate = substr(string(rs.value("t_BankDate")), 1, 10);
    SessType = rs.value("t_DirectName");
  end;
                                    
  [ ³ ######### ³ ######### ³ ########## ³ ########## ³ ######### ³ ########## ³ ########## ³ ######################### ³ ######### ³ ########## ³ ######## ³]
    (NumMes,
    IfThenElse( TableFields.IMInfoEDNo == 0, "", TableFields.IMInfoEDNo ),
    StrSubst ( TableFields.IMInfoEDDate, " ", "0" ),
    TableFields.IMInfoEDAuthor,
    IfThenElse( TableFields.RefEDNo == 0, "", TableFields.RefEDNo ),
    StrSubst ( TableFields.RefEDDate, " ", "0" ),
    TableFields.RefEDAuthor,
    Trn,
    SessNumber,
    StrSubst ( SessDate, " ", "0" ),
    SessType);
end;

private macro PrintFoundMes( ED245Mes : TED245MessageFields, wlmes )
  if( ED245Mes.IMQuantity == 0 )
    return;
  end;

  var rs = execSQLSelect( " Select tbl.t_Type, tbl.t_IMGroupQuantity, tbl.t_Number, tbl.t_ReceiverTypeCode, "
                          "        tbl.t_IMInfoEDNo, tbl.t_IMInfoEDDate, tbl.t_IMInfoEDAuthor, "
                          "        tbl.t_RefEDNo, tbl.t_RefEDDate, tbl.t_RefEDAuthor "
                          "  from TABLE(WLD_ED245REP.GetRepTable(:MesID)) tbl "
                          " ORDER BY tbl.t_ReceiverTypeCode ASC, tbl.t_Type ASC, "
                          "          tbl.t_RefEDNo DESC, tbl.t_RefEDDate DESC, tbl.t_RefEDAuthor DESC, tbl.t_IMInfoEDNo ASC ",
                          MakeArray(SQLParam("MesID", wlmes.MesID)));
  
  if( rs and rs.MoveNext() )
    
    var ReceiverTypeCode = rs.value("t_ReceiverTypeCode");
    var Type = "";
    var NumMes = 1;
    var NumFoundMes = 0;
    
    var TableFields = TFoundMesFields();
    
    TableFields.Type = rs.value("t_Type");
    TableFields.IMGroupQuantity = rs.value("t_IMGroupQuantity");
    TableFields.ReceiverTypeCode = rs.value("t_ReceiverTypeCode");
    TableFields.IMInfoEDNo = rs.value("t_IMInfoEDNo");
    TableFields.IMInfoEDDate = substr(string(rs.value("t_IMInfoEDDate")), 1, 10);
    TableFields.IMInfoEDAuthor = rs.value("t_IMInfoEDAuthor");
    TableFields.RefEDNo = rs.value("t_RefEDNo");
    TableFields.RefEDDate = substr(string(rs.value("t_RefEDDate")), 1, 10);
    TableFields.RefEDAuthor = rs.value("t_RefEDAuthor");
    FoundMesTableTitle(TableFields.ReceiverTypeCode);
    if( Type != TableFields.Type )
      Type = TableFields.Type;
      FoundMesTableHeader(TableFields.Type);
    end;
    
    FoundMesTableElem(TableFields, NumMes, @NumFoundMes);
    
    while( rs.MoveNext() )
      TableFields.Type = rs.value("t_Type");
      TableFields.IMGroupQuantity = rs.value("t_IMGroupQuantity");
      TableFields.ReceiverTypeCode = rs.value("t_ReceiverTypeCode");
      TableFields.IMInfoEDNo = rs.value("t_IMInfoEDNo");
      TableFields.IMInfoEDDate = substr(string(rs.value("t_IMInfoEDDate")), 1, 10);
      TableFields.IMInfoEDAuthor = rs.value("t_IMInfoEDAuthor");
      TableFields.RefEDNo = rs.value("t_RefEDNo");
      TableFields.RefEDDate = substr(string(rs.value("t_RefEDDate")), 1, 10);
      TableFields.RefEDAuthor = rs.value("t_RefEDAuthor");
      if( Type != TableFields.Type )
        FoundMesTableBottom(Type, TableFields.IMGroupQuantity, NumFoundMes);
        Type = TableFields.Type;
        NumMes = 0;
        NumFoundMes = 0;
        if( ReceiverTypeCode != TableFields.ReceiverTypeCode )
          FoundMesTableTitle(TableFields.ReceiverTypeCode);
          ReceiverTypeCode = TableFields.ReceiverTypeCode;
        end;
        
        FoundMesTableHeader(TableFields.Type);
      end;
      NumMes = NumMes + 1;
      FoundMesTableElem(TableFields, NumMes, @NumFoundMes);
    end;
    FoundMesTableBottom(TableFields.Type, TableFields.IMGroupQuantity, NumFoundMes);    
  end;
  
end;

private macro SpareFoundMesTable(ED245Mes : TED245MessageFields)
  var FormList = string( "(" + Bnk_GetRegistryValue( "Œ…†€Š‚‘Šˆ… €‘—…’›\\“”‘\\ED245_”Œ›_‘™…ˆ‰", V_STRING, "") + ")");
  var TrnList = "";
  var i = 0;
  var j = 0;
  var NumMes = 0;
  if( ED245Mes.IMGroupInfo.size != 0 )
    while( i < ED245Mes.IMGroupInfo.size)
      j = 0;
      while( j < ED245Mes.IMGroupInfo[i].IMInfo.size )
        if(strlen(TrnList) > 0)
           TrnList = TrnList + ", ";
        end;
        TrnList = TrnList + "'" + CreateTrn(ED245Mes.IMGroupInfo[i].IMInfo[j].EDNo, ED245Mes.IMGroupInfo[i].IMInfo[j].EDDate, ED245Mes.IMGroupInfo[i].IMInfo[j].EDAuthor) + "'";
        j = j + 1;
      end;
      i = i + 1;
    end;
    
  end;
  if( strlen(TrnList) > 0 )
    TrnList = string( "(" + TrnList + ")");
    TrnList = "    and mes.t_Trn not in " + TrnList;
  end;
  var rs = execSQLSelect( " Select sess.t_Number, sess.t_BankDate, frm.t_Name, mes.t_Trn, "
                          " case " +
                          "   when sess.t_Direct = chr(0) then " +
                          "     'â¯à ¢ª ' " +
                          "   when sess.t_Direct = 'X' then " +
                          "     'à¨¥¬' " +
                          "   else " +
                          "     chr(1) " +
                          " end as t_DirectName " +
                          "   From dwlmes_dbt mes, dwlmesrls_dbt rls, dwlsess_dbt sess, dwlmesfrm_dbt frm "
                          "  Where mes.t_Direct = chr(0) "
                          "    and mes.t_State >= :State "
                          "    and mes.t_SessionID = sess.t_SessionID "
                          "    and sess.t_BankDate = :EDDate "
                          "    and sess.t_TpID = 9 "
                          "    and sess.t_Direct = chr(0) "
                          "    and sess.t_State = :SessState "
                          "    and mes.t_RlsFormID = rls.t_RlsFormID "
                          "    and rls.t_FormID = frm.t_FormID "
                          "    and RSI_RSB_MASK.CompareStringWithMask(RSB_Common.GetRegStrValue('Œ…†€Š‚‘Šˆ… €‘—…’›\\“”‘\\ED245_”Œ›_‘™…ˆ‰'), frm.t_Name ) = 1 "
                          + TrnList,
                          MakeArray(SQLParam("State", WLD_STATUS_MES_DEFECT),
                                    SQLParam("EDDate", ED245Mes.EDDate),
                                    SQLParam("SessState", WLD_STATUS_SESS_COMPLETE)
                                   )
                        );
                                    
  if( rs and rs.moveNext() )
    [
      ‚ RS-Bank V.6 ­ ©¤¥­ë ‘ˆ‘, ­¥ ¯®¯ ¢è¨¥ ¢ ®âç¥â:
      
    ];
    
    [ ÚÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
      ³   ®¬¥à   ³      ˆ­ä®à¬ æ¨ï ®¡ ‘ˆ‘,      ³       ˆ­ä®à¬ æ¨ï ® á¥ ­á¥         ³
      ³    ¯/¯    ³   ­¥ ¯®¯ ¢è¥¬ ¢ ®âç¥â ED245   ³         ­ ©¤¥­­®£® ‘ˆ‘           ³
      ÃÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ´
      ³           ³  ’¨¯  ³       ¥ä¥à¥­á        ³   ®¬¥à   ³   „ â      ³   ’¨¯    ³
      ÃÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄ´
    ];
    NumMes = NumMes + 1;
    [ ³ ######### ³ ##### ³ ##################### ³ ######### ³ ########## ³ ######## ³]
    (NumMes, rs.value("t_Name"), rs.value("t_Trn"), rs.value("t_Number"), StrSubst ( substr(string(rs.value("t_BankDate")), 1, 10), " ", "0" ), rs.value("t_DirectName"));
  else
    return;
  end;
  
  while( rs and rs.MoveNext() )
    NumMes = NumMes + 1;
    [ ³ ######### ³ ##### ³ ##################### ³ ######### ³ ########## ³ ######## ³]
    (NumMes, rs.value("t_Name"), rs.value("t_Trn"), rs.value("t_Number"), StrSubst ( substr(string(rs.value("t_BankDate")), 1, 10), " ", "0" ), rs.value("t_DirectName"));
  end;
  [ ÀÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÙ
  ]
end;


macro PrintForm( addrMes, MassCopy )

  SetBuff( wlmes, addrMes );
  FILE MsgTmpFile() txt;
  var MsgTmpFileName, OldName;
  
  // ¥à¥­ ¯à ¢«ï¥¬ ¢ë¢®¤ á®®¡é¥­¨ï ¢ ä ©«, çâ®¡ë ¯à¨ ¬­®£®ªà â­®© ¯¥ç â¨ ¨á¯®«ì§®¢ âì ¤ ­­ë¥
  //------------------------------------------ 
  MsgTmpFileName = GetTxtFileName("tmpmsprn");
  OldName = SetOutPut( MsgTmpFileName );

  if( not open(MsgTmpFile, MsgTmpFileName) )
    std.msg( String("” ©« ­¥ ®âªàëâ:", "|", MsgTmpFileName) );
    return FALSE;
  end;
  
  
  var ED245Mes = TED245MessageFields();

  ReadED245MessageFields( @ED245Mes );
  
  
  PrintHeader( ED245Mes, wlmes );
  PrintFoundMes( ED245Mes, wlmes );
  SpareFoundMesTable( ED245Mes, wlmes);
  
  // ¥à¥­ ¯à ¢«ï¥¬ ¢ë¢®¤ ®¡à â­®
  //------------------------------------------
  SetOutPut( OldName, true ); 
  while( MassCopy != 0 )
    rewind( MsgTmpFile );
    while( next(MsgTmpFile) )
      println( MsgTmpFile.str );
    end;
    MassCopy = MassCopy - 1;
  end;
  close( MsgTmpFile ); 

  return true;                                                               

  OnError(er)
    ExeptionMessage(er);
    return false;
end;
