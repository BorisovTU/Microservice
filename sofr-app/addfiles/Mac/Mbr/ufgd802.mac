/*
  $Name:         ufgd802.mac
  $Module:       Межбанковские расчеты
  $Description:  Генерация УО "Ответ" по сообщениям УФЭБС ED802
*/

import "ufgendoc.mac", PTInter, likepy, oralib, "pmlib.mac", wltools, bnk_dttmfrmt, bnk_dirfile, bnk_ptlib, wluftool;



private class TInitialED
  var EDNo:       integer,   /*Номер ЭС в течение опердня для исходного ЭСИС*/
      EDDate:     date,      /*Дата составления ЭС для исходного ЭСИС*/
      EDAuthor:   string;    /*Уникальный идентификатор составителя ЭС для исходного ЭСИС*/

  macro Construct()
    EDNo = 0;
    EDDate = date(0,0,0);
    EDAuthor = "";
  end;
  
  Construct();
end;

private class TAccountModeChanges /*Изменения в режиме работы счета*/
  var AccountChangeType : string; /*Тип изменения режима работы счета*/

  macro Construct()
    AccountChangeType = "";
  end;

  Construct();
end;

private class TLimitInfo /*Значение и использование лимита*/
  var LimitType:       string, /*Тип лимита*/
      Value:           variant, /*Устанавливаемое значение лимита*/
      Utilization:     variant, /*Текущее использование лимита*/
      BIC:             string, /*БИК подчиненного участника пула ликвидности*/
      Account:         string, /*Счет подчиненного участника пула ликвидности*/
      UID:             string, /*УИС уполномоченного составителя требований*/
      ClearingCircuit: string; /*Клиринговая схема*/

  macro Construct()
    Utilization = Value = null;
    LimitType = BIC = Account = UID = ClearingCircuit = "";
  end;

  Construct();
end;

private class TLiquidityInfo /*Информация о ликвидности*/
  var Balance               : variant, /*Остаток на счете*/
      NetAvailableLiquidity : variant; /*Чистая доступная ликвидность*/

  macro Construct()
    Balance = NetAvailableLiquidity = null;
  end;

  Construct();
end;

private class TReservationInfo /*Информация о резервированиях*/
  var NonCashReservedSum : variant, /*Сумма резервирования ликвидности по счету (за исключением на выдачу наличных)*/
      CashReservedSum    : variant; /*Сумма резервирования ликвидности по счету на выдачу наличных*/

  macro Construct()
    NonCashReservedSum = CashReservedSum = null;
  end;

  Construct();
end;

private class TRestrictionBasisDoc /*Основание для установления ограничения/ареста*/
  var DocDate     : date,   /*Дата документа*/
      DocNumber   : string, /*Номер документа*/
      Description : string; /*Описание документа*/

  macro Construct()
    DocDate = date(0,0,0);
    DocNumber = Description = "";
  end;

  Construct();
end;

private class TArrestDetailedInfo  /*Список арестов и/или ограничений*/
  var ArrestID                : string, /*Идентификатор ареста/ограничения*/
      IndeterminateAmountFlag : string, /*Признак документа, приостанавливающего операции по счету без указания суммы*/
      ArrestAmount            : variant, /*Сумма ареста/ограничения*/
      OutstandingAmount       : variant, /*Сумма установленного ареста/ограничения, за исключением суммы распоряжений, исполненных за счет арестованных средств*/
      RestrictionBasisDoc     : variant; /*Основание для установления ограничения/ареста*/

  macro Construct()
    IndeterminateAmountFlag = ArrestID = "";
    OutstandingAmount = ArrestAmount = null;
    RestrictionBasisDoc = null;
  end;

  Construct();
end;

private class TArrestInfo /*Информация об арестах (ограничениях)*/
  var TotalAmount             : variant, /*Общая сумма арестов и/или ограничений по счету*/
      ArrestedAmount          : variant, /*Общая сумма средств, зарезервированная при исполнении документов об аресте*/
      OutstandingAmount       : variant, /*Общая сумма установленных арестов, за исключением сумм распоряжений, исполненных за счет арестованных средств*/  
      IndeterminateAmountFlag : string, /*Признак приостановления операций по счету без указания суммы*/ 
      ArrestDetailedInfoArr   : TArray; /*Список арестов и/или ограничений*/

  macro Construct()
    TotalAmount = ArrestedAmount = OutstandingAmount = null;
    IndeterminateAmountFlag = "";
    ArrestDetailedInfoArr = TArray();
  end;

  Construct();
end;

private class TByCreditAccount /*Распоряжения на списание во внутридневной очереди по счетам зачисления*/
  var BIC     : string,  /*БИК банка или ПБР, обслуживающего счет для зачисления*/
      Account : string,  /*Номер счета для зачисления средств*/
      Cnt     : integer, /*Количество распоряжений*/
      Amount  : variant;  /*Сумма распоряжений*/

  macro Construct()
    Amount = null;
    Cnt = 0;
    BIC = Account = "";
  end;

  Construct();
end;

private class TDebitQueuedGroup /*Распоряжения на списание во внутридневной очереди по группам*/
  var GroupCode          : string, /*Код группы*/
      Cnt                : integer, /*Количество распоряжений*/
      Amount             : variant, /*Сумма распоряжений*/
      ByCreditAccountArr : TArray; /*Распоряжения на списание во внутридневной очереди по счетам зачисления*/

  macro Construct()
    Amount = null;
    GroupCode = "";
    Cnt = 0;
    ByCreditAccountArr = TArray();
  end;

  Construct();
end;

private class TDebitQueuedPayments /*Информация о находящихся в очередях распоряжениях на списание средств со счета*/
  var DebitQueuedGroupArr : TArray; /*Распоряжения на списание во внутридневной очереди по группам*/

  macro Construct()
    DebitQueuedGroupArr = TArray();
  end;

  Construct();
end;

private class TByDebitAccount /*Распоряжения на зачисление во внутридневной очереди по счетам списания*/
  var BIC     : string,  /*БИК банка или ПБР, обслуживающего счет для зачисления*/
      Account : string,  /*Номер счета для списания средств*/
      Amount  : variant;  /*Сумма распоряжений*/

  macro Construct()
    Amount = null;
    BIC = Account = "";
  end;

  Construct();
end;

private class TCreditQueuedGroup /*Распоряжения на зачисление во внутридневной очереди по группам*/
  var GroupCode         : string, /*Код группы*/
      Amount            : variant, /*Сумма распоряжений*/
      ByDebitAccountArr : TArray; /*Распоряжения на зачисление во внутридневной очереди по счетам списания*/

  macro Construct()
    Amount = null;
    GroupCode = "";
    ByDebitAccountArr = TArray();
  end;

  Construct();
end;

private class TCreditQueuedPayments /*Информация о находящихся в очередях распоряжениях на зачисление средств на счет*/
  var CreditQueuedGroup : variant; /*Распоряжения на зачисление во внутридневной очереди по группам*/

  macro Construct()
    CreditQueuedGroup = null;
  end;

  Construct();
end;

class TAccount /*Информации о ликвидности по счету участника*/
  var BIC                   : string,  /*БИК участника*/
      Account               : string,  /*Номер счета участника*/
      SpecialModeIndicator  : integer, /*Признак наличия очереди не исполненных в срок распоряжений*/
      AccountModeChangesArr : TArray,  /*Изменения в режиме работы счета*/
      LimitInfoArr          : TArray,  /*Значение и использование лимита*/
      LiquidityInfo         : variant, /*Информация о ликвидности*/
      ReservationInfo       : variant, /*Информация о резервированиях*/
      ArrestInfo            : variant, /*Информация об арестах (ограничениях)*/
      DebitQueuedPayments   : variant, /*Информация о находящихся в очередях распоряжениях на списание средств со счета*/
      CreditQueuedPayments  : variant;  /*Информация о находящихся в очередях распоряжениях на зачисление средств на счет*/

  macro Construct()
    BIC = Account = "";
    SpecialModeIndicator = 0;
    LiquidityInfo = ReservationInfo = ArrestInfo = DebitQueuedPayments = CreditQueuedPayments = null;
    AccountModeChangesArr = TArray();
    LimitInfoArr = TArray();
  end;

  Construct();
end;

private class TLPInfo /*Информация о пуле ликвидности*/

  macro Construct()

  end;

  Construct();
end;

class TED802MessageFields /*Поля сообщения ED802*/
  var isXMLExists:        bool; /*Флаг наличия данных из прикрепленного XML-файла*/

  var EDNo             : integer, /*Номер ЭПД в течение опердня*/
      EDDate           : date,    /*Дата составления ЭПД*/
      EDAuthor         : string,  /*Уникальный идентификатор составителя ЭПД*/
      EDReceiver       : string,  /*Уникальный идентификатор получателя ЭС*/
      InfoTypeCode     : string,  /*Вид представления информации*/
      CreationReason   : string,  /*Код причины формирования ЭСИС*/
      CreationDateTime : string,  /*Дата и время создания ЭС в формате YYYY-MM-DDThh:mm:ssZ*/
      PoolInfoFlag     : string,  /*Признак предоставления информации по всем счетам пула ликвидности*/
      LPInfo           : variant, /*Информация о пуле ликвидности*/
      AccountArr       : TArray,  /*Информации о ликвидности по счету участника*/
      InitialED        : variant; /*Идентификаторы исходного ЭСИС*/


  macro Construct()
    isXMLExists = false;
    EDNo = 0;
    EDDate = date(0,0,0);
    EDAuthor = EDReceiver = CreationReason = InfoTypeCode = CreationDateTime = PoolInfoFlag = "";
    AccountArr = TArray();
    LPInfo = null;
    InitialED = null;
  end; 

  Construct();
end;






// Макрос чтения полей сообщения ED802
// Входные параметры: ED802MessageFields - структура полей сообщения ED802
macro ReadED802MessageFields( ED802MessageFields:@TED802MessageFields, xml ) : bool
  var fieldname = "", fieldvalue = "", blockname = "";
  var isNeedXMLParse : bool = false;
  var stat : bool = false;
  if( valtype(xml) != V_UNDEF )
    isNeedXMLParse = true;
  end;

  /*Считываем только то, что хранится в полях релиза*/
  if( not isNeedXMLParse )

    while( СчитатьПоле(fieldname, fieldvalue, blockname) )
      if(blockname == "")
        if(fieldname == "EDNo")
          ED802MessageFields.EDNo = int( fieldvalue );
        elif(fieldname == "EDDate")
          ED802MessageFields.EDDate = ToDate( fieldvalue );
        elif(fieldname == "EDAuthor")
          ED802MessageFields.EDAuthor = fieldvalue;
        elif(fieldname == "EDReceiver")
          ED802MessageFields.EDReceiver = fieldvalue;
        elif(fieldname == "InfoTypeCode")
          ED802MessageFields.InfoTypeCode = fieldvalue;
        elif(fieldname == "CreationReason")
          ED802MessageFields.CreationReason = fieldvalue;
        elif(fieldname == "CreationDateTime")
          ED802MessageFields.CreationDateTime = fieldvalue;
        elif(fieldname == "PoolInfoFlag")
          ED802MessageFields.PoolInfoFlag = fieldvalue;
        end;
      elif(blockname == "LPInfo")

      elif(blockname == "Account")
        if(fieldname == beginField)
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size] = TAccount();
        elif(fieldname == "BIC")
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].BIC = fieldvalue;
        elif(fieldname == "Account")
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].Account = fieldvalue;
        elif(fieldname == "SpecialModeIndicator")
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].SpecialModeIndicator = int( fieldvalue );
        end;
      elif(blockname == "Account\\AccountModeChanges")
        if(fieldname == beginField)
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].AccountModeChangesArr[
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].AccountModeChangesArr.size] = TAccountModeChanges();
        elif(fieldname == "AccountChangeType")
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].AccountModeChangesArr[
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].AccountModeChangesArr.size - 1].AccountChangeType = fieldvalue;
        end;
      elif(blockname == "Account\\LimitInfo")
        if(fieldname == beginField)
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LimitInfoArr[
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LimitInfoArr.size] = TLimitInfo();
        elif(fieldname == "LimitType")
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LimitInfoArr[
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LimitInfoArr.size - 1].LimitType = fieldvalue;
        elif(fieldname == "Value")
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LimitInfoArr[
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LimitInfoArr.size - 1].Value = moneyL( fieldvalue );
        elif(fieldname == "Utilization")
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LimitInfoArr[
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LimitInfoArr.size - 1].Utilization = moneyL( fieldvalue );
        end;
      elif(blockname == "Account\\LiquidityInfo")
        if(fieldname == beginField)
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LiquidityInfo = TLiquidityInfo();
        elif(fieldname == "Balance")
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LiquidityInfo.Balance = moneyL( fieldvalue );
        elif((fieldname == "NetAvailableLiquidity") or (fieldname == "NetAvailableLiquidit"))
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LiquidityInfo.NetAvailableLiquidity = moneyL( fieldvalue );
        end;
      elif(blockname == "Account\\ReservationInfo")
        if(fieldname == beginField)
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ReservationInfo = TReservationInfo();
        elif(fieldname == "NonCashReservedSum")
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ReservationInfo.NonCashReservedSum = moneyL( fieldvalue );
        elif(fieldname == "CashReservedSum")
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ReservationInfo.CashReservedSum = moneyL( fieldvalue );
        end;
      elif(blockname == "Account\\ArrestInfo")
        if(fieldname == beginField)
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo = TArrestInfo();
        elif(fieldname == "TotalAmount")
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo.TotalAmount = moneyL( fieldvalue );
        elif(fieldname == "ArrestedAmount")
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo.ArrestedAmount = moneyL( fieldvalue );
        elif(fieldname == "OutstandingAmount")
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo.OutstandingAmount = moneyL( fieldvalue );
        elif((fieldname == "IndeterminateAmountFlag") or (fieldname == "IndeterminateAmountF"))
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo.IndeterminateAmountFlag = fieldvalue;
        end;
      elif(blockname == "Account\\DebitQueuedPayments")
        if(fieldname == beginField)
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments = TDebitQueuedPayments();
        end;
      elif(blockname == "Account\\DebitQueuedPayments\\DebitQueuedGroup")
        if(fieldname == beginField)
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr[
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr.size] = TDebitQueuedGroup();
        elif(fieldname == "GroupCode")
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr[
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr.size - 1].GroupCode = fieldvalue;
        elif(fieldname == "Cnt")
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr[
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr.size - 1].Cnt = int( fieldvalue );
        elif(fieldname == "Amount")
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr[
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr.size - 1].Amount = moneyL( fieldvalue );
        end;
      elif(blockname == "Account\\CreditQueuedPayments")
        if(fieldname == beginField)
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].CreditQueuedPayments = TCreditQueuedPayments();
        end;
      elif(blockname == "Account\\CreditQueuedPayments\\CreditQueuedGroup")
        if(fieldname == beginField)
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].CreditQueuedPayments.CreditQueuedGroup = TCreditQueuedGroup();
        elif(fieldname == "GroupCode")
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].CreditQueuedPayments.CreditQueuedGroup.GroupCode = fieldvalue;
        elif(fieldname == "Amount")
          ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].CreditQueuedPayments.CreditQueuedGroup.Amount = moneyL( fieldvalue );
        end;
      elif(blockname == "InitialED")
        if(fieldname == beginField)
          ED802MessageFields.InitialED = TInitialED();    
        elif(fieldname == "EDNo")
          ED802MessageFields.InitialED.EDNo = int( fieldvalue );
        elif(fieldname == "EDDate")
          ED802MessageFields.InitialED.EDDate = ToDate( fieldvalue );
        elif(fieldname == "EDAuthor")
          ED802MessageFields.InitialED.EDAuthor = fieldvalue;
        end;
      end; 
    end; // while ( СчитатьПоле(fieldname, fieldvalue, blockname) )
            
  else /*Считываем данные прикрепленного XML-файла, если он есть*/

    var XmlAttrsElemsArray : TArray;
    stat = GetXMLElementsAndAttributesArray( xml, @XmlAttrsElemsArray, NodeED802 );
    if( stat )
      ED802MessageFields.isXMLExists = true;
      for( var XmlAttrElem, XmlAttrsElemsArray )
        if(XmlAttrElem.BlockName == "")
          if(XmlAttrElem.FieldName == "EDNo")
            ED802MessageFields.EDNo = int( XmlAttrElem.FieldValue );
          elif(XmlAttrElem.FieldName == "EDDate")
            ED802MessageFields.EDDate = ToDate( XmlAttrElem.FieldValue );
          elif(XmlAttrElem.FieldName == "EDAuthor")
            ED802MessageFields.EDAuthor = XmlAttrElem.FieldValue;
          elif(XmlAttrElem.FieldName == "EDReceiver")
            ED802MessageFields.EDReceiver = XmlAttrElem.FieldValue;
          elif(XmlAttrElem.FieldName == "InfoTypeCode")
            ED802MessageFields.InfoTypeCode = XmlAttrElem.FieldValue;
          elif(XmlAttrElem.FieldName == "CreationReason")
            ED802MessageFields.CreationReason = XmlAttrElem.FieldValue;
          elif(XmlAttrElem.FieldName == "CreationDateTime")
            ED802MessageFields.CreationDateTime = XmlAttrElem.FieldValue;
          elif(XmlAttrElem.FieldName == "PoolInfoFlag")
            ED802MessageFields.PoolInfoFlag = XmlAttrElem.FieldValue;
          end;
        elif(XmlAttrElem.BlockName == "LPInfo")

        elif(XmlAttrElem.BlockName == "Account")
          if(XmlAttrElem.FieldName == beginField)
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size] = TAccount();
          elif(XmlAttrElem.FieldName == "BIC")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].BIC = XmlAttrElem.FieldValue;
          elif(XmlAttrElem.FieldName == "Account")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].Account = XmlAttrElem.FieldValue;
          elif(XmlAttrElem.FieldName == "SpecialModeIndicator")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].SpecialModeIndicator = int( XmlAttrElem.FieldValue );
          end;
        elif(XmlAttrElem.BlockName == "Account\\AccountModeChanges")
          if(XmlAttrElem.FieldName == beginField)
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].AccountModeChangesArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].AccountModeChangesArr.size] = TAccountModeChanges();
          elif(XmlAttrElem.FieldName == "AccountChangeType")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].AccountModeChangesArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].AccountModeChangesArr.size - 1].AccountChangeType = XmlAttrElem.FieldValue;
          end;
        elif(XmlAttrElem.BlockName == "Account\\LimitInfo")
          if(XmlAttrElem.FieldName == beginField)
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LimitInfoArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LimitInfoArr.size] = TLimitInfo();
          elif(XmlAttrElem.FieldName == "LimitType")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LimitInfoArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LimitInfoArr.size - 1].LimitType = XmlAttrElem.FieldValue;
          elif(XmlAttrElem.FieldName == "Value")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LimitInfoArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LimitInfoArr.size - 1].Value = moneyL( XmlAttrElem.FieldValue );
          elif(XmlAttrElem.FieldName == "Utilization")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LimitInfoArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LimitInfoArr.size - 1].Utilization = moneyL( XmlAttrElem.FieldValue );
          elif(XmlAttrElem.FieldName == "BIC")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LimitInfoArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LimitInfoArr.size - 1].BIC = XmlAttrElem.FieldValue;
          elif(XmlAttrElem.FieldName == "Account")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LimitInfoArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LimitInfoArr.size - 1].Account = XmlAttrElem.FieldValue;
          elif(XmlAttrElem.FieldName == "UID")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LimitInfoArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LimitInfoArr.size - 1].UID = XmlAttrElem.FieldValue;
          elif(XmlAttrElem.FieldName == "ClearingCircuit")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LimitInfoArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LimitInfoArr.size - 1].ClearingCircuit = XmlAttrElem.FieldValue;
          end;
        elif(XmlAttrElem.BlockName == "Account\\LiquidityInfo")
          if(XmlAttrElem.FieldName == beginField)
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LiquidityInfo = TLiquidityInfo();
          elif(XmlAttrElem.FieldName == "Balance")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LiquidityInfo.Balance = moneyL( XmlAttrElem.FieldValue );
          elif((XmlAttrElem.FieldName == "NetAvailableLiquidity") or (XmlAttrElem.FieldName == "NetAvailableLiquidit"))
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].LiquidityInfo.NetAvailableLiquidity = moneyL( XmlAttrElem.FieldValue );
          end;
        elif(XmlAttrElem.BlockName == "Account\\ReservationInfo")
          if(XmlAttrElem.FieldName == beginField)
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ReservationInfo = TReservationInfo();
          elif(XmlAttrElem.FieldName == "NonCashReservedSum")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ReservationInfo.NonCashReservedSum = moneyL( XmlAttrElem.FieldValue );
          elif(XmlAttrElem.FieldName == "CashReservedSum")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ReservationInfo.CashReservedSum = moneyL( XmlAttrElem.FieldValue );
          end;
        elif(XmlAttrElem.BlockName == "Account\\ArrestInfo")
          if(XmlAttrElem.FieldName == beginField)
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo = TArrestInfo();
          elif(XmlAttrElem.FieldName == "TotalAmount")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo.TotalAmount = moneyL( XmlAttrElem.FieldValue );
          elif(XmlAttrElem.FieldName == "ArrestedAmount")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo.ArrestedAmount = moneyL( XmlAttrElem.FieldValue );
          elif(XmlAttrElem.FieldName == "OutstandingAmount")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo.OutstandingAmount = moneyL( XmlAttrElem.FieldValue );
          elif((XmlAttrElem.FieldName == "IndeterminateAmountFlag") or (XmlAttrElem.FieldName == "IndeterminateAmountF"))
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo.IndeterminateAmountFlag = XmlAttrElem.FieldValue;
          end;
        elif(XmlAttrElem.BlockName == "Account\\ArrestInfo\\ArrestDetailedInfo")
          if(XmlAttrElem.FieldName == beginField)
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo.ArrestDetailedInfoArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo.ArrestDetailedInfoArr.size] = TArrestDetailedInfo();
          elif(XmlAttrElem.FieldName == "ArrestID")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo.ArrestDetailedInfoArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo.ArrestDetailedInfoArr.size - 1].ArrestID = XmlAttrElem.FieldValue;
          elif((XmlAttrElem.FieldName == "IndeterminateAmountFlag") or (XmlAttrElem.FieldName == "IndeterminateAmountF"))
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo.ArrestDetailedInfoArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo.ArrestDetailedInfoArr.size - 1].IndeterminateAmountFlag = XmlAttrElem.FieldValue;
          elif(XmlAttrElem.FieldName == "ArrestAmount")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo.ArrestDetailedInfoArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo.ArrestDetailedInfoArr.size - 1].ArrestAmount = moneyL( XmlAttrElem.FieldValue );
          elif(XmlAttrElem.FieldName == "OutstandingAmount")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo.ArrestDetailedInfoArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo.ArrestDetailedInfoArr.size - 1].OutstandingAmount = moneyL( XmlAttrElem.FieldValue );
          end;
        elif(XmlAttrElem.BlockName == "Account\\ArrestInfo\\ArrestDetailedInfo\\RestrictionBasisDoc")
          if(XmlAttrElem.FieldName == beginField)
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo.ArrestDetailedInfoArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo.ArrestDetailedInfoArr.size - 1].RestrictionBasisDoc = TRestrictionBasisDoc();
          elif(XmlAttrElem.FieldName == "DocDate")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo.ArrestDetailedInfoArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo.ArrestDetailedInfoArr.size - 1].RestrictionBasisDoc.DocDate = ToDate( XmlAttrElem.FieldValue );
          elif(XmlAttrElem.FieldName == "DocNumber")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo.ArrestDetailedInfoArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo.ArrestDetailedInfoArr.size - 1].RestrictionBasisDoc.DocNumber = XmlAttrElem.FieldValue;
          elif(XmlAttrElem.FieldName == "Description")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo.ArrestDetailedInfoArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].ArrestInfo.ArrestDetailedInfoArr.size - 1].RestrictionBasisDoc.Description = XmlAttrElem.FieldValue;
          end;
        elif(XmlAttrElem.BlockName == "Account\\DebitQueuedPayments")
          if(XmlAttrElem.FieldName == beginField)
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments = TDebitQueuedPayments();
          end;
        elif(XmlAttrElem.BlockName == "Account\\DebitQueuedPayments\\DebitQueuedGroup")
          if(XmlAttrElem.FieldName == beginField)
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr.size] = TDebitQueuedGroup();
          elif(XmlAttrElem.FieldName == "GroupCode")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr.size - 1].GroupCode = XmlAttrElem.FieldValue;
          elif(XmlAttrElem.FieldName == "Cnt")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr.size - 1].Cnt = int( XmlAttrElem.FieldValue );
          elif(XmlAttrElem.FieldName == "Amount")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr.size - 1].Amount = moneyL( XmlAttrElem.FieldValue );
          end;
        elif(XmlAttrElem.BlockName == "Account\\DebitQueuedPayments\\DebitQueuedGroup\\ByCreditAccount")
          if(XmlAttrElem.FieldName == beginField)
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr.size - 1].ByCreditAccountArr[
                ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr[
                  ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr.size - 1].ByCreditAccountArr.size] 
                    = TByCreditAccount();
          elif(XmlAttrElem.FieldName == "BIC")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr.size - 1].ByCreditAccountArr[
                ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr[
                  ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr.size - 1].ByCreditAccountArr.size - 1].BIC 
                    = XmlAttrElem.FieldValue;
          elif(XmlAttrElem.FieldName == "Account")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr.size - 1].ByCreditAccountArr[
                ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr[
                  ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr.size - 1].ByCreditAccountArr.size - 1].Account 
                    = XmlAttrElem.FieldValue;
          elif(XmlAttrElem.FieldName == "Cnt")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr.size - 1].ByCreditAccountArr[
                ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr[
                  ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr.size - 1].ByCreditAccountArr.size - 1].Cnt 
                    = int( XmlAttrElem.FieldValue );
          elif(XmlAttrElem.FieldName == "Amount")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr.size - 1].ByCreditAccountArr[
                ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr[
                  ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].DebitQueuedPayments.DebitQueuedGroupArr.size - 1].ByCreditAccountArr.size - 1].Amount 
                    = moneyL( XmlAttrElem.FieldValue );
          end;
        elif(XmlAttrElem.BlockName == "Account\\CreditQueuedPayments")
          if(XmlAttrElem.FieldName == beginField)
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].CreditQueuedPayments = TCreditQueuedPayments();
          end;
        elif(XmlAttrElem.BlockName == "Account\\CreditQueuedPayments\\CreditQueuedGroup")
          if(XmlAttrElem.FieldName == beginField)
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].CreditQueuedPayments.CreditQueuedGroup = TCreditQueuedGroup();
          elif(XmlAttrElem.FieldName == "GroupCode")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].CreditQueuedPayments.CreditQueuedGroup.GroupCode = XmlAttrElem.FieldValue;
          elif(XmlAttrElem.FieldName == "Amount")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].CreditQueuedPayments.CreditQueuedGroup.Amount = moneyL( XmlAttrElem.FieldValue );
          end;
        elif(XmlAttrElem.BlockName == "Account\\CreditQueuedPayments\\CreditQueuedGroup\\ByDebitAccount")
          if(XmlAttrElem.FieldName == beginField)
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].CreditQueuedPayments.CreditQueuedGroup.ByDebitAccountArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].CreditQueuedPayments.CreditQueuedGroup.ByDebitAccountArr.size] 
                = TByDebitAccount();
          elif(XmlAttrElem.FieldName == "BIC")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].CreditQueuedPayments.CreditQueuedGroup.ByDebitAccountArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].CreditQueuedPayments.CreditQueuedGroup.ByDebitAccountArr.size - 1].BIC 
                = XmlAttrElem.FieldValue;
          elif(XmlAttrElem.FieldName == "Account")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].CreditQueuedPayments.CreditQueuedGroup.ByDebitAccountArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].CreditQueuedPayments.CreditQueuedGroup.ByDebitAccountArr.size - 1].Account 
                = XmlAttrElem.FieldValue;
          elif(XmlAttrElem.FieldName == "Amount")
            ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].CreditQueuedPayments.CreditQueuedGroup.ByDebitAccountArr[
              ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].CreditQueuedPayments.CreditQueuedGroup.ByDebitAccountArr.size - 1].Amount 
                = moneyL( XmlAttrElem.FieldValue );
          end;
        elif(XmlAttrElem.BlockName == "InitialED")
          if(XmlAttrElem.FieldName == beginField)
            ED802MessageFields.InitialED = TInitialED();    
          elif(XmlAttrElem.FieldName == "EDNo")
            ED802MessageFields.InitialED.EDNo = int( XmlAttrElem.FieldValue );
          elif(XmlAttrElem.FieldName == "EDDate")
            ED802MessageFields.InitialED.EDDate = ToDate( XmlAttrElem.FieldValue );
          elif(XmlAttrElem.FieldName == "EDAuthor")
            ED802MessageFields.InitialED.EDAuthor = XmlAttrElem.FieldValue;
          end;
        end;      
      end;
    else
      isNeedXMLParse = false;
    end;

  end;

  return TRUE;
end;

private macro IsAccountEqBankDprtCorAcc( Account : string, BIC : string ):bool
  var stat : bool = false;
  var PartyID = -1;

  PartyID = ПолучитьКодСубъекта( BIC, PTCK_BIC );
  if( PartyID > 0 )
    var query : string = " SELECT 1 " + 
                         "   FROM dbankdprt_dbt " + 
                         "  WHERE t_PartyID = :PartyID " + 
                         "    AND t_CorAcc = :Account ";

    var params:TArray = makeArray( SQLParam( "PartyID", PartyID ),
                                   SQLParam( "Account", Account ) );

    var rs : RsdRecordset = execSQLselect( query, params );

    if( rs and rs.moveNext() )
      stat = true;
    end;
  end;

  return stat;
end;

private macro MakeQueriesPartForAccount( Account : TAccount, Queries : @string )
  var tmpQueries : string = "";
  var Sum  :  money;
  var Sum1 :  money;
  var Sum2 :  money;
  tmpQueries = "Информация о ликвидности по счету " + Account.Account + ":\n";
  if( Account.SpecialModeIndicator == 1 )
    tmpQueries = tmpQueries + "К счету имеется очередь не исполненных в срок распоряжений.\n";
  end;

  for( var AccountModeChanges, Account.AccountModeChangesArr )
    tmpQueries = tmpQueries + "Изменен режим работы счета, причина - " + AccountModeChanges.AccountChangeType + " " + 
                 GetWlcodeDescription( TYPE_CODE_UFBS_ED802_ACCOUNTCHANGETYPE, AccountModeChanges.AccountChangeType ) + ".\n";
  end;
  
  for( var LimitInfo, Account.LimitInfoArr )
    tmpQueries = tmpQueries + "Лимиту " + LimitInfo.LimitType + " " + 
                              GetWlcodeDescription( TYPE_CODE_UFBS_ED8NN_LIMITTYPE, LimitInfo.LimitType ) + " установлено значение " + string( LimitInfo.Value / 100 ) + ".";
    if( (LimitInfo.Utilization != NULL) and (LimitInfo.Utilization != moneyL(0)) )
      tmpQueries = tmpQueries + " Текущее использование лимита " + string( LimitInfo.Utilization / 100 ) + ".\n";
    else 
      tmpQueries = tmpQueries + "\n";
    end;
  end;

  if( Account.LiquidityInfo != null )
    if( Account.LiquidityInfo.Balance != null)
    tmpQueries = tmpQueries + "Остаток на счете " + string( Account.LiquidityInfo.Balance / 100 ) + ".";
    end;
    if( (Account.LiquidityInfo.NetAvailableLiquidity != null) and (Account.LiquidityInfo.NetAvailableLiquidity != moneyL(0)) )
      tmpQueries = tmpQueries + " Чистая доступная ликвидность " + string( Account.LiquidityInfo.NetAvailableLiquidity / 100 ) + ".\n";
    else
      tmpQueries = tmpQueries + "\n";
    end;
  end;

  if( Account.ReservationInfo != null )
    sum = IfThenElse(Account.ReservationInfo.NonCashReservedSum == NULL, 0, Account.ReservationInfo.NonCashReservedSum);
    sum1 = IfThenElse(Account.ReservationInfo.CashReservedSum == NULL, 0,Account.ReservationInfo.CashReservedSum);
    tmpQueries = tmpQueries + "Сумма резервирования ликвидности по счету " + string( Sum / 100 ) + 
                              ". Резервирование в связи со снятием наличных денежных средств со счета " + string( Sum1 / 100 ) + ".\n"; 
  end;

  if( Account.ArrestInfo != null )
    if( Account.ArrestInfo.IndeterminateAmountFlag == "1" )
      tmpQueries = tmpQueries + "Исполнено решение налогового органа о приостановлении операций по счету (без указания суммы).\n";
    else
      sum = IfThenElse(Account.ArrestInfo.TotalAmount == NULL, 0, Account.ArrestInfo.TotalAmount);
      sum1 = IfThenElse(Account.ArrestInfo.ArrestedAmount == NULL, 0, Account.ArrestInfo.ArrestedAmount);
      sum2 = IfThenElse(Account.ArrestInfo.OutstandingAmount == NULL, 0,Account.ArrestInfo.OutstandingAmount);

      tmpQueries = tmpQueries + "Общая сумма документов о наложении ареста (ограничения) = " + string( Sum / 100 ) + 
                                ". Фактически арестовано средств " + string( Sum1 / 100 ) + 
                                ". Сумма установленных арестов за вычетом сумм распоряжений, исполненных за счет арестованных средств " + string( Sum2 / 100 ) + 
                                ".\n"; 
    end;
  end;

  if( Account.DebitQueuedPayments != null )
    for( var DebitQueuedGroup, Account.DebitQueuedPayments.DebitQueuedGroupArr )
      sum = IfThenElse(DebitQueuedGroup.Amount == NULL, 0, DebitQueuedGroup.Amount);
      tmpQueries = tmpQueries + "В группе " + DebitQueuedGroup.GroupCode + " " + 
                                GetWlcodeDescription( TYPE_CODE_UFBS_ED802_GROUPCODE, DebitQueuedGroup.GroupCode ) + " " + 
                                DebitQueuedGroup.Cnt + " распоряжений на списание на общую сумму " + string( Sum / 100 ) + ".\n";
    end;
  end;

  if( (Account.CreditQueuedPayments != null) and (Account.CreditQueuedPayments.CreditQueuedGroup != null) )
    sum = IfThenElse(Account.CreditQueuedPayments.CreditQueuedGroup.Amount == NULL, 0, Account.CreditQueuedPayments.CreditQueuedGroup.Amount);
    tmpQueries = tmpQueries + "В группе " + Account.CreditQueuedPayments.CreditQueuedGroup.GroupCode + " " + 
                              GetWlcodeDescription( TYPE_CODE_UFBS_ED802_GROUPCODE, Account.CreditQueuedPayments.CreditQueuedGroup.GroupCode ) +
                              " находятся распоряжения на зачисление на общую сумму " + string( Sum / 100 ) + ".\n";
  end;

  Queries = Queries + tmpQueries;

end;


macro GenDoc( addrMes )
  var Narrative : string = "";
  SetBuff( wlmes, addrMes );
  PrintLog( 2, "Генерация информационного сообшения по ED802" );


  var tmpPartyID = 0;
      
  var ED802MessageFields = TED802MessageFields();
  ReadED802MessageFields( @ED802MessageFields );

  var RsbWldRequestObj : RsbWlRequest = RsbWlRequest(0); // Создаём новый Rsb-объект

  RsbWldRequestObj.Trn = wlmes.Trn;
  RsbWldRequestObj.RelatedRef = wlmes.RelatedRef;
  RsbWldRequestObj.Direct = "X"; /*WLD_MES_IN*/
  RsbWldRequestObj.Kind = MESKIND_ANSWER; /*Создаем ответ*/

  RsbWldRequestObj.OriginatorCode = ED802MessageFields.EDAuthor;
  RsbWldRequestObj.OriginatorCodeKind = PTCK_UIS;
  tmpPartyID = 0;
  tmpPartyID = GetCodeOwnerID( RsbWldRequestObj.OriginatorCodeKind, RsbWldRequestObj.OriginatorCode );
  if( tmpPartyID > 0 )
    RsbWldRequestObj.OriginatorID   = tmpPartyID;
    RsbWldRequestObj.OriginatorName = Bnk_GetPartyName( RsbWldRequestObj.OriginatorID );
  end;
 
  RsbWldRequestObj.RecipientCode      = wlmes.InsideAbonentCode;
  RsbWldRequestObj.RecipientCodeKind  = wlmes.InsideAbonentCodeKind;
  RsbWldRequestObj.RecipientID        = wlmes.InsideAbonentID;
  RsbWldRequestObj.RecipientName      = Bnk_GetPartyName( RsbWldRequestObj.RecipientID );

  if( ED802MessageFields.AccountArr.size == 1 )
    var BICForCors = "", AccountForCors = "";
    BICForCors = ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].BIC;
    AccountForCors = ED802MessageFields.AccountArr[ED802MessageFields.AccountArr.size - 1].Account;
    FindCorschemIsUBR( BICForCors, AccountForCors, @RsbWldRequestObj.Corschem, @RsbWldRequestObj.FIID );
  end;

  var FirstPartQueries : string = "";
  var SecondPartQueries : string = "";
  var Queries : string = "";

  for( var Account, ED802MessageFields.AccountArr )
    if( IsAccountEqBankDprtCorAcc( Account.Account, Account.BIC ) )
      MakeQueriesPartForAccount( Account, @FirstPartQueries );
    else
      MakeQueriesPartForAccount( Account, @SecondPartQueries );
    end;
  end;
  Queries = FirstPartQueries + SecondPartQueries;
  RsbWldRequestObj.Queries = substr( Queries, 1, 2000 );

  Narrative = "InfoTypeCode (вид представления информации): " + ED802MessageFields.InfoTypeCode + " " + 
              GetWlcodeDescription( TYPE_CODE_UFBS_ED801_INFOTYPECODE, string( "/" + ED802MessageFields.InfoTypeCode + "/" )) + "\n";
                                                 
  Narrative = Narrative + "CreationReason (код причины формирования ЭС): " + ED802MessageFields.CreationReason + " " + 
              GetWlcodeDescription( TYPE_CODE_UFBS_ED802_CREATIONREASON, ED802MessageFields.CreationReason ) + "\n";

  var CreationDate = "", CreationTime = "";
  DivideYYYY_MM_DDThhmmssZToDateTime( ED802MessageFields.CreationDateTime, @CreationDate, @CreationTime );
  Narrative = Narrative + "CreationDate (дата создания ЭС): " + CreationDate + " " + 
                          "CreationTime (время создания ЭС): " + CreationTime + "\n";

  RsbWldRequestObj.Narrative = Narrative + WLD_REQ_SEPARATE;

  RsbWldRequestObj.ChangeState( WLD_STATUS_REQ_RECEIV );

  RsbWldRequestObj.SaveChanges();

  /*Создаем связь документа с входящим сообщением*/
  var meslnk = TRecHandler("wlmeslnk.dbt");
  meslnk.rec.MesID   = wlmes.MesID;
  meslnk.rec.Direct  = "X";/*WLD_MES_IN*/
  meslnk.rec.ObjID   = RsbWldRequestObj.ReqID;
  meslnk.rec.ObjKind = OBJTYPE_REQ;
  var MesLnkObj = RsbWldRequestObj.InWlmesLnk();
  MesLnkObj.Insert( meslnk );
  MesLnkObj.Save();

  /*Вставка подтверждения о доставке*/
  if( ED802MessageFields.InitialED != null)
    var ReqMesID = FindReqOutMesID( RsbWldRequestObj.RelatedRef, wlmes.TpSchemID );
    if( ReqMesID > 0 )
      ВставитьПодтверждениеОДоставке( ReqMesID, null, null, null, false, null, WLD_STATUS_MES_CLOSED );
    end;
  end;

  return TRUE;

  OnError(er) /* Обработка ошибок времени выполнения */
    std.msg(String(er.Message, "|Модуль: ", er.Module, " Строка: ", er.Line));
    return FALSE;
end;
