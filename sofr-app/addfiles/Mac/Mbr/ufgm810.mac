/*
  $Name:         ufgm810.mac
  $Module:       Межбанковские расчеты
  $Description:  Генерация сообщения ED810 транспорта УФЭБС
*/

import BankInter, CTInter, oralib, MesInter, WldInter, ufgenmes, bnk_ptlib, bnk_common;

const RegPath_ЛИМИТ_УЧАСТНИКА = "МЕЖБАНКОВСКИЕ РАСЧЕТЫ\\УФЭБС\\ЛИМИТ_УЧАСТНИКА";

private macro GetWlLimitInfoType( ReqID : integer ):string
  var Type : string = "";

  var query : string = " SELECT t_Type " +
                       " FROM dwllimitinfo_dbt " +
                       " WHERE t_ReqID = :ReqID ";

  var rs : RsdRecordset = execSQLselectPrm( query, SQLParam( "ReqID", ReqID ) );

  if( rs and rs.moveNext() )
    Type = rs.value( "t_Type" );
  end;

  return Type;
end;

private macro GetWlLimitInfoChangeType( ReqID : integer ):string
  var ChangeType : string = "";

  var query : string = " SELECT t_ChangeType " +
                       " FROM dwllimitinfo_dbt " +
                       " WHERE t_ReqID = :ReqID ";

  var rs : RsdRecordset = execSQLselectPrm( query, SQLParam( "ReqID", ReqID ) );

  if( rs and rs.moveNext() )
    ChangeType = rs.value( "t_ChangeType" );
  end;

  return ChangeType;
end;

private macro GetWlLimitInfoStartDate( ReqID : integer ):date
  var StartDate : date = date(0,0,0);

  var query : string = " SELECT t_StartDate " +
                       " FROM dwllimitinfo_dbt " +
                       " WHERE t_ReqID = :ReqID ";

  var rs : RsdRecordset = execSQLselectPrm( query, SQLParam( "ReqID", ReqID ) );

  if( rs and rs.moveNext() )
    StartDate = rs.value( "t_StartDate" );
  end;

  return StartDate;
end;

private macro GetWlLimitInfoValue( ReqID : integer ):moneyL
  var Value : moneyL = moneyL(0);

  var query : string = " SELECT t_Value " +
                       " FROM dwllimitinfo_dbt " +
                       " WHERE t_ReqID = :ReqID ";

  var rs : RsdRecordset = execSQLselectPrm( query, SQLParam( "ReqID", ReqID ) );

  if( rs and rs.moveNext() )
    Value = rs.value( "t_Value" );
  end;

  return Value;
end;

private macro GetWlLimitInfoClearSchem( ReqID : integer ):string
  var ClearSchem : string = "";

  var query : string = " SELECT t_ClearSchem " +
                       " FROM dwllimitinfo_dbt " +
                       " WHERE t_ReqID = :ReqID ";

  var rs : RsdRecordset = execSQLselectPrm( query, SQLParam( "ReqID", ReqID ) );

  if( rs and rs.moveNext() )
    ClearSchem = rs.value( "t_ClearSchem" );
  end;

  return ClearSchem;
end;

private macro GetWlLimitInfoClaimOriginatorID( ReqID : integer ):integer
  var ClaimOriginatorID : integer = 0;

  var query : string = " SELECT t_ClaimOriginatorID " +
                       " FROM dwllimitinfo_dbt " +
                       " WHERE t_ReqID = :ReqID ";

  var rs : RsdRecordset = execSQLselectPrm( query, SQLParam( "ReqID", ReqID ) );

  if( rs and rs.moveNext() )
    ClaimOriginatorID = rs.value( "t_ClaimOriginatorID" );
  end;

  return ClaimOriginatorID;
end;

private macro GetLimitInfoBIC( ReqID : integer, Date : date )

  var BIC = "";
  
  var rs = execSQLSelect( " Select code.t_Code as t_BIC "
                          "   from dwllimitinfo_dbt lim, dobjcode_dbt code "
                          "  Where lim.t_ReqID = :ReqID "
                          "    and code.t_ObjectID = lim.t_ClaimOriginatorID "
                          "    and :ToDate < DECODE(code.t_BankCloseDate, TO_DATE('01010001', 'DDMMYYYY'), TO_DATE('31129999', 'DDMMYYYY'), code.t_BankCloseDate) "
                          "    and code.t_CodeKind = :CodeKind "
                          "    and code.t_ObjectType = 3 ", 
                          MakeArray( SQLParam("ReqID", ReqID),
                                     SQLParam("ToDate", Date),
                                     SQLParam("CodeKind", PTCK_BIC)));
  
  if( rs and rs.MoveNext )
    BIC = rs.value("t_BIC");
  end;
  
  return BIC;
      
end;

macro GenMes( addrMes, addrReq )

  record wlmes(wlmes);
  record wlReq(wlreq);
  
  SetBuff( wlReq, addrReq );
  SetBuff( wlmes, addrMes );

  var ed_nda = NULL;
  ed_nda = EDNoDateAuthor();
  ed_nda.ConstructByTrn(wlmes.TRN);
  
  ЗаписатьПолеЛог( "EDNo",     ed_nda.EDNo, TRUE );
  ЗаписатьПолеЛог( "EDDate",   YYYYMMDD(ed_nda.EDDate), TRUE );
  ЗаписатьПолеЛог( "EDAuthor", ed_nda.EDAuthor, TRUE );
  
  var BIC : string = "";
  GetPartyCodeEx( GetDprtPartyID( Bnk_GetCorschemDepartment( wlReq.Corschem, wlReq.FIID ) ), PTCK_BIC, @BIC );
  ЗаписатьПолеЛог( "BIC", BIC, TRUE );


  var wlLimitInfoType = GetWlLimitInfoType( wlReq.ReqID );                           
  var PartLimit = Bnk_GetRegistryValue( RegPath_ЛИМИТ_УЧАСТНИКА, V_STRING, "" );
  if( not index( PartLimit, wlLimitInfoType ) )
    var CorAccount : string = Bnk_GetCorschemCorAccount( wlReq.Corschem, wlReq.FIID );
    ЗаписатьПолеЛог( "Acc", CorAccount, TRUE );
  end;

  var LimitChangeType = GetWlLimitInfoChangeType( wlReq.ReqID );
  ЗаписатьПолеЛог( "LimitChangeType", LimitChangeType, TRUE );

  var LimitActivationDate = GetWlLimitInfoStartDate( wlReq.ReqID );
  if( LimitActivationDate != date(0,0,0) )
    ЗаписатьПолеЛог( "LimitActivationDate",   YYYYMMDD( LimitActivationDate ), TRUE );
  end;
  
  /*Блок LimitInfo*/
  УстановитьКонтекстБлокаЛог( "LimitInfo" );
    ЗаписатьПолеЛог( beginField, "LimitInfo" );
    ЗаписатьПолеЛог( "LimitType", wlLimitInfoType, TRUE );
    if( LimitChangeType != "DELL" )
      var liValue = MoneyToStrUFBS( GetWlLimitInfoValue( wlReq.ReqID ) );
      ЗаписатьПолеЛог( "Value", liValue, TRUE );
    end;
    ЗаписатьПолеЛог( "BIC", GetLimitInfoBIC(wlReq.ReqID, ed_nda.EDDate));
    var UID : string = "";
    GetPartyCodeEx( GetWlLimitInfoClaimOriginatorID( wlReq.ReqID ), PTCK_UIS, @UID );
    ЗаписатьПолеЛог( "UID", UID, TRUE );
    //ЗаписатьПолеЛог( "ClearingCircuit", GetWlLimitInfoClearSchem( wlReq.ReqID ), TRUE );  
    ЗаписатьПолеЛог( endField, "LimitInfo" );
  УстановитьКонтекстБлокаЛог( ".." );

  return true; /*Успешное завершение*/
  
  OnError(er)
    std.msg(String(RsbGetError(er), "|Модуль: ", er.Module, " Строка: ", er.Line));
    return FALSE;
end;