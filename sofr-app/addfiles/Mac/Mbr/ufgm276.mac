 /*
 $Name: ufgm276.mac
 $Module: Межбанковские расчеты
 $Description: Генерация сообщения ED276 транспорта УФЭБС
 */

/****************************************************************************/
/*                   R-Style SoftLab, RS-Bank 6.0                           */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/* Генерация сообщения ED276 транспорта УФЭБС                               */
/*                                                                          */
/*  Имя файла: ufgm276.mac                                                  */
/*  Создан:    15.10.13                                Chukina T.           */
/****************************************************************************/

import WldInter, "ufgenmes.mac", "wluftool.mac", "rsberror.mac";

macro GenMes( addrMes, addrReq )

  record wlmes(wlmes);
  record wlReq(wlreq);

  SetBuff( wlmes, addrMes );
  SetBuff( wlReq, addrReq );

  var RelatedRef : string = GetRelatedRefFromWlreq(wlReq, "EDRefID", "Не найдена ссылка на исходный ЭПД. Нужно или заполнить поле 'Ссылка', или заполнить EDRefID в поле 'Сообщение'");

  // Заполнение атрибутов поля "xml" сообщения
  var xml:object = ActiveX("Microsoft.XMLDOM");  
  var mes:object = xml.createElement("ED276");
  mes.setAttribute("xmlns", "urn:cbr-ru:ed:v2.0");
  
  FillEDNoDateAuthorByRef_XMLField(mes, wlmes.TRN);

  mes.setAttribute("EDReceiver", GetEDReceiverForWlreq(wlReq, RelatedRef));

  var InfoCode : string = getFldValFromQueries(wlReq.Queries, "InfoCode:");
  if(not InfoCode)
    RunError("Не заполнен атрибут InfoCode");
  elif(not InList(InfoCode, "1", "2"))
    RunError("Не корректно заполнен атрибут InfoCode");
  end;
  mes.setAttribute("InfoCode", InfoCode);

  var elem : object = null;      

  var InitialED : string = getFldValFromQueries(wlReq.Queries, "InitialED:");
  if(not InitialED)
    RunError("Не заполнен атрибут InitialED");
  end;
  elem = xml.createElement("InitialED");  
  FillEDNoDateAuthorByRef_XMLField(elem, InitialED);
  elem.appendChild(xml.createTextNode(""));
  mes.appendChild(elem);
  
  elem = xml.createElement("EDRefID");  
  FillEDNoDateAuthorByRef_XMLField(elem, RelatedRef);
  elem.appendChild(xml.createTextNode(""));
  mes.appendChild(elem);

  ЗаписатьПолеЛог( "xml", mes.xml, TRUE );
  
  return TRUE; // Успешное завершение

  OnError( er ) // обработка ошибок
    std.msg(String(RsbGetError(er), "|Модуль: ", er.Module, " Строка: ", er.Line));
    return FALSE; 
end;
