
//   Файл:       u_wlkvit.mac
//   Назначение: Отчет о квитовке в массовом режиме
//   Создан:     26.06.2008

import "pmmaslog.mac", "oralib.mac";
MACRO PrintReportUnkvitConf(NeedHeader)
  var select;
  VAR rs:RsdRecordset;
  var i=1, all:integer;
  array StringArray;
  var Сообщение, Дата:date;

  if(NeedHeader)
    [                                                  ];
    [   Отчет о массовой квитовке                      ];
    [                                                  ];
  end;
  
  select = " select conf.T_RELATEDREF, conf.T_DATEVALUE, conf.T_SUM, kvtlnk.T_STATE, kvtlnk.t_PaymentID , kvtlnk.t_ParentWlPmID "+
             " from dwlkvtlnk_tmp kvtlnk, dwlconf_dbt conf"+
            " where kvtlnk.T_CONFID  = conf.T_CONFID"+
              " and ( kvtlnk.t_PaymentID = 0 or kvtlnk.t_ParentWlPmID <> 0)";

  rs = execSQLselect( select, NULL, TRUE );

    [                                                                               ];
    [   Подтверждения, по которым квитовка не выполнялась                           ];
    [                                                                               ];
    [┌─────────────────────┬─────────────┬─────────────────┬────────┬────────────────────────────────────────┐ ];
    [│       Ссылка        │    Дата     │      Сумма      │ Номер  │ Сообщение                              │ ];
    [│                     │  значения   │                 │ ошибки │                                        │ ];
    [├─────────────────────┼─────────────┼─────────────────┼────────┼────────────────────────────────────────┤ ];
  
  while(rs.moveNext())

    MemoryError( rs.value(3) );
    Сообщение = GetErrMsg();
    Дата = rs.value(1);
    i = 1;
    StrSplit(StrSubst(Сообщение, "│", " " ), StringArray, 40);
    [│#####################│#############│#################│########│########################################│ ](rs.value(0):r,Дата,rs.value(2):r,rs.value(3):r,StringArray(0));
    while ( StrLen(StringArray(i) ) > 0)
    [│                     │             │                 │        │########################################│ ](StringArray(i));
    i = i + 1;
    end;  
  end;  
 
    [└─────────────────────┴─────────────┴─────────────────┴────────┴────────────────────────────────────────┘];

  select = " select count(*)"+
             " from dwlkvtlnk_tmp ";  
  rs = execSQLselect( select, NULL, TRUE );
  rs.moveNext();
  all = rs.value(0);
    [                           ];
    [Всего подтверждений: ##### ](all:l);
end;

macro PrintReportKvitConf()
    [                                                  ];
    [   Отчет о массовой квитовке                      ];
    [                                                  ];
    [   Подтверждения, по которым выполнялась квитовка ];

  PM_ShowMassExecuteLog();
end;