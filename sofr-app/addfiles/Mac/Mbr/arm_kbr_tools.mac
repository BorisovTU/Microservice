/*
  $Name: arm_kbr_tools.mac
  $Module: Œ
  $Description: Ž¡é¨¥ äã­ªæ¨¨ ­¥®¡å®¤¨¬ë¥ ¤«ï à¥ «¨§ æ¨¨ €Œ Š
*/

import globals, oralib, likepy, bnk_common;

/* ®«ãç¨âì ¯à¨§­ ª ¯®¤¯¨á¨ ¨§ âà ­á¯®àâ­®© áå¥¬ë */
macro GetTpSchemSign( tp_shem_id : integer ) : bool
  var query_sign = 
                  " SELECT 1 " +
                  "   FROM dwltpshem_dbt wltpshem " +                  
                  " WHERE wltpshem.t_TpShemID = :TpShemID and wltpshem.t_Sign = :Sign";

  var rs_sign = execSQLselect( query_sign, makeArray(
                                                    SQLParam("TpShemID", tp_shem_id),
                                                    SQLParam("Sign", "X" )
                                                  ), false );
 
  if( rs_sign and  rs_sign.moveNext() )
    return true;
  end;

  return false;
end;

/* ®«ãç¨âì ãá«®¢¨ï ¨á¯®«­¥­¨ï ¤«ï ¢ë§®¢  ï¤¥à­ëå ¯à®æ¥¤ãà */
macro GetConditions( session_id:integer, start_department:integer, department:integer ) : string

  var query = 
      " SELECT wltpshem.t_ProtectMode, NVL(llvalues.t_Note, chr(1)) " +
      "     FROM dllvalues_dbt llvalues, " +
      "          dwlmes_dbt    wlmes, " +
      "          dwlsess_dbt   wlsess, " +
      "          dwltpshem_dbt wltpshem " +
      "    WHERE     wlmes.t_TpSchemID = wltpshem.t_TpShemID " +
      "          AND wlmes.t_SessionID = wlsess.t_SessionID " +
      "          AND llvalues.t_Code(+) = wltpshem.t_DirectionChange " +
      "          AND wlsess.t_SessionID = :SessionID " +
      "          AND llvalues.t_List(+) = :List "; // OBJTYPE_DIRECT_PSBR
      
  var rs = execSQLselect( query, makeArray(SQLParam("SessionID", session_id),
                                           SQLParam("List", 2122 )
                                           ), false ); 
  
  var protvar = Bnk_GetRegistryValue("Œ…†€ŠŽ‚‘Šˆ… €‘—…’›\\“”‘\\‡€™ˆ’€ ‘\\‚€ˆ€’_‡€™ˆ’›_‘", V_INTEGER, 0);
  var dest = "koi";
  
  if(rs and rs.moveNext())
    if(rs.value(0) != 0)
      protvar = rs.value(0);
    end;

    if(rs.value(1) != "")
      dest = rs.value(1);
    end;
  end;

  var conditions =  "user=" + {oper} + ";" +
                    "branch=" + IfThenElse(Bnk_GetRegistryValue("Œ…†€ŠŽ‚‘Šˆ… €‘—…’›\\“”‘\\‡€™ˆ’€ ‘\\”ˆ‹ˆ€‹_", V_INTEGER, 0) == 0, start_department, department )  + ";"
                    "protvar=" + protvar + ";" +
                    "dir=send;" +
                    "exec=" + IfThenElse(IsShedulerRunning, "automat", "manual") + ";" +
                    "dest=" + dest + ";";
                    
  return conditions;
end;

/*‘®åà ­¨âì ¤ ­­ë¥ ¢ ¯à¨¢ï§ª¥ ª á¥ ­áã*/
macro saveXMLInSessionData( xml_string:string, session_id:integer ) : integer
    var size = strlen(xml_string);
    var idx = 1;
    var result = 0;
    
    var size_of_blob = 29999; /*  §¬¥à BLOB-  c-áâàãªâãàë - 1*/
    
    while((size > 0) and (not result))
      var cmd = RsdCommand(
                            " DECLARE " +
                            "    l_blob          BLOB; " +
                            "    l_clob          CLOB := ?; " +
                            "    l_amt           INTEGER := DBMS_LOB.lobmaxsize; " +
                            "    l_dest_offset   INTEGER := 1; " +
                            "    l_src_offset    INTEGER := 1; " +
                            "    l_csid          INTEGER := DBMS_LOB.default_csid; " +
                            "    l_ctx           INTEGER := DBMS_LOB.default_lang_ctx; " +
                            "    l_warn          INTEGER; " +
                            " BEGIN " +
                            "    DBMS_LOB.createTemporary (l_blob, FALSE); " +
                            "    DBMS_LOB.convertToBlob (l_blob, " +
                            "                            l_clob, " +
                            "                            l_amt, " +
                            "                            l_dest_offset, " +
                            "                            l_src_offset, " +
                            "                            l_csid, " +
                            "                            l_ctx, " +
                            "                            l_warn); " +
                            "    INSERT INTO dwlsesspr_dbt (t_SessionID, " +
                            "                               t_SessionNum, " +
                            "                               t_State, " +
                            "                               t_BankDate, " +
                            "                               t_UserID, " +
                            "                               t_SysDate, " +
                            "                               t_SysTime, " +
                            "                               T_FMTBLOBDATA_XXXX) " +
                            "         VALUES (?, " +
                            "                 ?, " +
                            "                 ?, " +
                            "                 ?, " +
                            "                 ?, " +
                            "                 ?, " +
                            "                 ?, " +
                            "                 l_blob); " +
                            " END; ");
                            

      var str = SubStr(xml_string, (idx - 1 ) * size_of_blob + 1, size_of_blob);

      cmd.addParam("", RSDBP_IN, str );
      cmd.addParam("", RSDBP_IN, session_id );
      cmd.addParam("", RSDBP_IN, idx );
      cmd.addParam("", RSDBP_IN, 1 );
      cmd.addParam("", RSDBP_IN, {curdate} );
      cmd.addParam("", RSDBP_IN, {oper} );
      cmd.addParam("", RSDBP_IN, Date() );
      cmd.addParam("", RSDBP_IN, Time() );
      
      result = cmd.execute();
      
      idx = idx + 1;
      size = size - size_of_blob;
    end;
    
    return result;
end;