/*
  $Name:         ufgd244.mac
  $Module:       МБР
  $Description:  Генерация ответа по сообщению ED244
*/

/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 6.0                      */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/* Генерация ответа по сообщению ED244                                      */
/*                                                                          */
/*  Имя файла: ufgd244.mac                                                  */
/*  Создан:    17.06.11                                  Chukina T.         */
/****************************************************************************/

import BankInter, "ufgendoc.mac", "uf243244.mac", "ufgo244.mac", "ufNtfCar_lib.mac";

var ver_st = 2;

private macro НайтиКодРежима(strcode: string) :string

  var result = "Неизвестный код режима: " + strcode;
  var rs:object;
  var select:string;
  var params:TArray;

  select = "select t_description from dwlcodes_dbt where t_algnum = 52 and t_code=:code";
  
  params = makeArray( SQLParam("code", strcode));
  rs = execSQLselect( select, params, FALSE );
  if ( rs and rs.MoveNext() )
     result = rs.value(0);
  end;
        
  return result;
end;
/* РЕЛИЗ ЗАКРЫТ
macro GenDoc( addrMes )
  SetBuff( wlmes, addrMes );
  
  PrintLog(2,"Генерация ответа по ED244");

  ClearRecord(wlreq);
  
  var error = 0, i = 0;
    
  /* Заполнение учетных буферов */
  wlreq.Trn                      = wlmes.Trn;
  wlreq.RelatedRef               = wlmes.RelatedRef;
  wlreq.Direct                   = "X";  
  wlreq.Kind                     = MESKIND_ANSWER;
  
  wlreq.InitFormIDMes            = НайтиФормуСообщенияПоРеференсу(wlreq.RelatedRef, TRANSP_UFBS);
  
  wlreq.RecipientCode            = {MFO_Bank};
  wlreq.RecipientCodeKind        = PTCK_BIC;
  wlreq.RecipientID              = {OurBank};
  wlreq.RecipientName            = {Name_Bank};
  
  var fieldname = "", fieldvalue = "", blockname = "", EDDefineAnswerCode = "";
  FILE party(party) key 0;

  while ( СчитатьПоле(fieldname, fieldvalue, blockname) )
    if ( (fieldname == "EDAuthor") and (blockname == "") )
      wlreq.OriginatorID         = ToRespID(fieldvalue);
      wlreq.OriginatorCodeKind   = PTCK_BIC;
      wlreq.OriginatorCode       = ПолучитьКодСубъекта(wlreq.OriginatorID, wlreq.OriginatorCodeKind, error);

      party.PartyID = wlreq.OriginatorID;
      if(GetEQ(party))
        wlreq.OriginatorName     = party.Name;
      end;
    end;

    if ( (fieldname == "EDDate") and (blockname == "OriginalEPD") )
      wlreq.InitDateMes          = ToDate(fieldvalue);
    end;
  
    if (fieldname == "EDDefineAnswerCode")
      EDDefineAnswerCode = fieldvalue;
      wlreq.Queries              = "/ОТ"+EDDefineAnswerCode+"/";
    end;

    // wlreq.Queries ------------------------------------------------- 
    if (blockname == "EDDefineAnswerInfo")
      if ( ( (fieldname == "AccDocDate") or (fieldname == "AccDocNo") or 
             (fieldname == "PayerAcc") or (fieldname == "PayeeAcc") or
             (fieldname == "PayerINN") or (fieldname == "PayeeINN") or (fieldname == "Sum")
           ) and (fieldvalue) 
         )
        wlreq.Queries            = wlreq.Queries + string("\n", fieldname, ": ", fieldvalue);
      end;      
    end;
    if ( ( (fieldname == "PayerLongName") or (fieldname == "PayeeLongName") or
           (fieldname == "Purpose") or (fieldname == "Address") 
         ) and (fieldvalue) 
       )
      wlreq.Queries              = wlreq.Queries + string("\n", fieldname, ": ", fieldvalue);
    end;
                      
    if (blockname == "EDDefineAnswerInfo\\AccDocAddInfo")
      if ( ( (fieldname == "PayerINN") or (fieldname == "PayeeINN") or 
             (fieldname == "DrawerStatus") or (fieldname == "PayerKPP") or 
             (fieldname == "PayeeKPP") or (fieldname == "CBC") or
             (fieldname == "OKATO") or (fieldname == "PaytReason") or 
             (fieldname == "TaxiPeriod") or (fieldname == "DocNo") or
             (fieldname == "DocDate") or (fieldname == "TaxPaytKind")
           ) and (fieldvalue) 
         )
        wlreq.Queries            = wlreq.Queries + string("\n", fieldname, ": ", fieldvalue);
      end;      
    end;
    // wlreq.Queries -------------------------------------------------
  end;

  var Description                = НайтиКодРежима("/ОТ"+EDDefineAnswerCode+"/");

  if( not ВставитьОтвет( wlreq, Description ) )
    std.msg("Ошибка при вводе ответа");
    return FALSE;
  end;

  return TRUE;

  OnError(er) /* Обработка ошибок времени выполонения */
    std.msg(String(er.Message, "|Модуль: ", er.Module, " Строка: ", er.Line));
    return FALSE;
end;
*/

macro GenDoc259( addrMes )
  SetBuff( wlmes, addrMes );

  var FormName : string = "ED244";
  
  PrintLog(2, "Генерация ответа по " + FormName);

  ClearRecord(wlreq);
  
  var error = 0, i = 0;
    
  /* Заполнение учетных буферов */
  wlreq.Trn             = wlmes.Trn;
  wlreq.RelatedRef      = wlmes.RelatedRef;
  wlreq.Direct          = "X";  
  wlreq.Kind            = MESKIND_ANSWER;
  
  wlreq.InitFormIDMes   = НайтиФормуСообщенияПоРеференсу(wlreq.RelatedRef, TRANSP_UFBS);
  
  var fieldname = "", fieldvalue = "", blockname = "", 
      EDDefineAnswerCode : string = "",
      EDDefineRequestCode : string = "",
      AddFldsInfo : TAddFldsInfo = TAddFldsInfo(),
      Narrative : string = "";

  while ( СчитатьПоле(fieldname, fieldvalue, blockname) )
    if ( (fieldname == "EDAuthor") and (blockname == "") )
      FillPartyByUIS_PTCK_UIS(fieldvalue, @wlreq.OriginatorID, 
                                          @wlreq.OriginatorCodeKind, 
                                          @wlreq.OriginatorCode, 
                                          @wlreq.OriginatorName );
    end;

    if ( (fieldname == "EDReceiver") and (blockname == "") )
      FillPartyByUIS_PTCK_UIS(fieldvalue, @wlreq.RecipientID, 
                                          @wlreq.RecipientCodeKind, 
                                          @wlreq.RecipientCode, 
                                          @wlreq.RecipientName );
    end;

    if ( (fieldname == "EDDate") and (blockname == "OriginalEPD") )
      wlreq.InitDateMes = ToDate(fieldvalue);
    end;

    if (fieldname == "EDDefineAnswerCode")
      EDDefineAnswerCode = fieldvalue;
      wlreq.Queries   = "/ОТ"+EDDefineAnswerCode+"/";
    end;

    if (fieldname == "EDDefineRequestCode")
      EDDefineRequestCode = fieldvalue;
      AddFldsInfo.ExplanatoryFields[ AddFldsInfo.ExplanatoryFields.size ] = TMesField("RequestCode", EDDefineRequestCode);
    end;

    // EDDefineAnswerInfo
    ReadEDDefineReqAnsInfoFld( FormName, blockname, fieldname, fieldvalue, 
                               AddFldsInfo, @Narrative );
  end;

  // Объект RsbAddFld должен существовать и быть заполнен к моменту вставки запроса/ответа
  var AddFlds : RsbAddFld = RsbAddFld(wlreq.ReqID);
  InsertAddFldsInfoToObj( FormName, AddFldsInfo, AddFlds );

  if( not ВставитьОтвет( wlreq, Narrative ) )
    std.msg("Ошибка при вводе ответа");
    return FALSE;
  end;


  return TRUE;

  OnError(er) /* Обработка ошибок времени выполонения */
    std.msg(String(er.Message, "|Модуль: ", er.Module, " Строка: ", er.Line));
    return FALSE;
end;
