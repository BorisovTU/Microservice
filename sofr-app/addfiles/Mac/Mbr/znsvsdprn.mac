 /*
 $Name: znsvsdprn.mac
 $Module: МБР
 $Description: Печать выписки об операциях по вкладам (депозитам)
 */
import "fnsprzall.mac";

// нумерация полей в массиве реквизитов проводки
private const OprDate   =  0, Shifr     =  1, Number    =  2, DocDate   =  3, CorrAcc   =  4, BankName  =  5,
              BIC       =  6, ClientID  =  7, ClName    =  8, NumAcc    =  9, AmountD   = 10, AmountC   = 11,
              Ground    = 12, INN       = 13, KPP       = 14;

private macro printCarryes( Account:string, FIID:integer, D1:date, D2:date )
  private var select = " SELECT d.t_Date_Carry,                                                                    "+
                       "        ( case when NVL (pd.t_paymentid, 0) <> 0                                           "+
                       "          then ( case when pm.t_DocKind in (430,440)                                       "+
                       "                 then chr(1)                                                               "+
                       "                 else rm.t_ShifrOper                                                       "+
                       "                 end)                                                                      "+
                       "          else d.t_Shifr_Oper                                                              "+
                       "          end ) as t_ShifrOper,                                                            "+
                       "        ( case when NVL (pd.t_paymentid, 0) <> 0                                           "+
                       "          then rm.t_Number                                                                 "+
                       "          else d.t_Numb_Document                                                           "+
                       "          end ) as t_Number,                                                               "+
                       "        ( case when NVL (pd.t_paymentid, 0) <> 0                                           "+
                       "          then rm.t_Date                                                                   "+
                       "          else d.t_Date_Carry                                                              "+
                       "          end ) as t_DocDate,                                                              "+
                       "        ( case when NVL (pd.t_paymentid, 0) <> 0                                           "+
                       "          then ( case when d.t_Account_Payer = :Account1                                   "+
                       "                 then rm.t_ReceiverCorrAccNostro                                           "+
                       "                 else rm.t_PayerCorrAccNostro                                              "+
                       "                 end)                                                                      "+
                       "          else chr(1)                                                                      "+
                       "          end ) as t_CorAcc,                                                               "+
                       "        ( case when NVL (pd.t_paymentid, 0) <> 0                                           "+
                       "          then ( case when d.t_Account_Payer = :Account2                                   "+
                       "                 then rm.t_ReceiverBankName                                                "+
                       "                 else rm.t_PayerBankName                                                   "+
                       "                 end)                                                                      "+
                       "          else chr(1)                                                                      "+
                       "          end ) as t_BankName,                                                             "+
                       "        ( case when NVL (pd.t_paymentid, 0) <> 0                                           "+
                       "          then ( case when d.t_Account_Payer = :Account3                                   "+
                       "                 then cr.t_BankCode                                                        "+
                       "                 else db.t_BankCode                                                        "+
                       "                 end)                                                                      "+
                       "          else chr(1)                                                                      "+
                       "          end ) as t_BIC,                                                                  "+
                       "        ( case when NVL (pd.t_paymentid, 0) <> 0                                           "+
                       "          then ( case when d.t_Account_Payer = :Account4                                   "+
                       "                 then pm.t_Receiver                                                        "+
                       "                 else pm.t_Payer                                                           "+
                       "                 end)                                                                      "+
                       "          else ( case when d.t_Account_Payer = :Account5                                   "+
                       "                 then (select t_Client                                                     "+
                       "                         from daccount_dbt                                                 "+
                       "                        where t_Account = d.t_Account_Receiver                             "+
                       "                          and t_Code_Currency = d.t_FIID_Payer                             "+
                       "                      )                                                                    "+
                       "                 else (select t_Client                                                     "+
                       "                         from daccount_dbt                                                 "+
                       "                        where t_Account = d.t_Account_Payer                                "+
                       "                          and t_Code_Currency = d.t_FIID_Receiver                          "+
                       "                      )                                                                    "+
                       "                 end)                                                                      "+
                       "          end ) as t_ClientID,                                                             "+
                       "        ( case when NVL (pd.t_paymentid, 0) <> 0                                           "+
                       "          then ( case when d.t_Account_Payer = :Account6                                   "+
                       "                 then rm.t_ReceiverName                                                    "+
                       "                 else rm.t_PayerName                                                       "+
                       "                 end)                                                                      "+
                       "          else chr(1)                                                                      "+
                       "          end ) as t_ClName,                                                               "+
                       "        ( case when NVL (pd.t_paymentid, 0) <> 0 and d.t_Result_Carry <> 71                "+
                       "          then ( case when d.t_Account_Payer = :Account7                                   "+
                       "                 then pm.t_ReceiverAccount                                                 "+
                       "                 else pm.t_PayerAccount                                                    "+
                       "                 end)                                                                      "+
                       "          else ( case when d.t_Account_Payer = :Account8                                   "+
                       "                 then d.t_Account_Receiver                                                 "+
                       "                 else d.t_Account_Payer                                                    "+
                       "                 end)                                                                      "+
                       "          end ) as t_Account,                                                              "+
                       "        ( case when d.t_Account_Payer = :Account9                                          "+
                       "          then d.t_Sum_Payer                                                               "+
                       "          else 0                                                                           "+
                       "          end ) as t_AmountD,                                                              "+
                       "        ( case when d.t_Account_Receiver = :Account10                                      "+
                       "          then d.t_Sum_Receiver                                                            "+
                       "          else 0                                                                           "+
                       "          end ) as t_AmountC,                                                              "+
                       "        ( case when NVL (pd.t_paymentid, 0) <> 0                                           "+
                       "          then rm.t_Ground                                                                 "+
                       "          else d.t_Ground                                                                  "+
                       "          end ) as t_Ground, NVL (pd.t_paymentid, 0) AS t_PaymentID,                       "+
                       "        ( case when NVL (pd.t_paymentid, 0) <> 0                                           "+
                       "          then ( case when d.t_Account_Payer = :Account11                                  "+
                       "                 then rm.t_ReceiverINN                                                     "+
                       "                 else rm.t_PayerINN                                                        "+
                       "                 end)                                                                      "+
                       "          else ( case when d.t_Account_Payer = :Account12                                  "+
                       "               then  (select t_code                                                        "+
                       "                      from  dpartcode_dbt par                                              "+
                       "                       where par.t_partyid = d.t_accountid_receiver                        "+
                       "                       and par.t_codekind = :PINN1)                                        "+
                       "               else (select t_code                                                         "+
                       "                       from  dpartcode_dbt par                                             "+
                       "                       where par.t_partyid = d.t_accountid_payer                           "+
                       "                       and par.t_codekind = :PINN2)                                        "+
                       "               end)                                                                        "+
                       "          end ) as t_FullINN                                                               "+
                       "   FROM dpmdocs_dbt pd,                                                                    "+
                       "        dacctrn_dbt     d,                                                                 "+
                       "        dpmpaym_dbt     pm,                                                                "+
                       "        dpmrmprop_dbt   rm,                                                                "+
                       "        dpmprop_dbt     db,                                                                "+
                       "        dpmprop_dbt     cr                                                                 "+
                       "   WHERE d.t_date_carry between :Date1 and :Date2                                          "+
                       "     AND d.t_chapter = 1                                                                   "+
                       "     AND d.t_state = 1                                                                     "+
                       "     AND ( d.t_Account_Payer    = :Account13 AND d.t_FIID_Payer    = :FIID1 OR             "+
                       "           d.t_Account_Receiver = :Account14 AND d.t_FIID_Receiver = :FIID2 )              "+
                       "     AND d.t_acctrnid = pd.t_acctrnid(+)                                                   "+
                       "     AND pm.t_PaymentID(+) = pd.t_PaymentID                                                "+
                       "     AND rm.t_PaymentID(+) = pd.t_PaymentID                                                "+
                       "     AND db.t_PaymentID(+) = pd.t_PaymentID                                                "+
                       "     AND db.t_DebetCredit(+) = 0                                                           "+
                       "     AND cr.t_PaymentID(+) = pd.t_PaymentID                                                "+
                       "     AND cr.t_DebetCredit(+) = 1                                                           "+
                       "  ORDER BY d.t_Date_Carry                                                                  ";

  private var params = makeArray( SQLParam( "Account1" , Account   ),  SQLParam( "Account2" , Account   ),
                                  SQLParam( "Account3" , Account   ),  SQLParam( "Account4" , Account   ),
                                  SQLParam( "Account5" , Account   ),  SQLParam( "Account6" , Account   ),
                                  SQLParam( "Account7" , Account   ),  SQLParam( "Account8" , Account   ),
                                  SQLParam( "Account9" , Account   ),  SQLParam( "Account10", Account   ),
                                  SQLParam( "Account11", Account   ),  SQLParam( "Account12", Account   ),
                                  SQLParam( "PINN1"    , PTCK_INN  ),  SQLParam( "PINN2"    , PTCK_INN  ),
                                  SQLParam( "Date1"    , D1        ),  SQLParam( "Date2"    , D2        ),
                                  SQLParam( "Account13", Account   ),  SQLParam( "FIID1"    , FIID      ),
                                  SQLParam( "Account14", Account   ),  SQLParam( "FIID2"    , FIID      ) );      

  var rs = execSQLselect( select, params, FALSE );
  
  var i = 1;
  while( ( rs.moveNext() ) )
   //│    │  дата    │ вид  │номер │   дата   │номер корресп.счета │наименовани│   БИК   │Наимено- │  ИНН / КИО │   КПП    │    номер счета     │  по дебету│ по кредиту│основание  │
   [ │####│##########│######│######│##########│####################│###########│#########│#########│############│##########│####################│###########│###########│###########│]
   (string(i):c,  pyOr(string( rs.value(OprDate ) ), "-"):c, pyOr(rs.value(Shifr   ), "-"):c, pyOr(rs.value(Number  ), "-"):w, 
                  pyOr(string( rs.value(DocDate ) ), "-"):c, pyOr(IfThenElse( rs.value( 13 ) == 0, {CORAC_Bank}, rs.value(CorrAcc ) ), "-"):c, 
                  pyOr(IfThenElse( rs.value( 13 ) == 0, {Name_Bank} , rs.value(BankName) ), "-"):w, 
                  pyOr(IfThenElse( rs.value( 13 ) == 0, {MFO_Bank}  , rs.value(BIC     ) ), "-"):c, 
                  pyOr(rs.value(ClName  ), "-"):w, pyOr(RemoveKPP(rs.value("t_FullINN")), "-"):c, 
                  pyOr(RemoveINN(rs.value("t_FullINN")), "-"):c, 
                  pyOr(rs.value(NumAcc  ), "-"):c, IfThenElse( rs.value(AmountD) == 0, "-", StrSubst(string( rs.value(AmountD ):16:2 ), ".", "-" )):r, 
                  IfThenElse( rs.value(AmountC) == 0, "-", StrSubst(string( rs.value(AmountC ):16:2 ), ".", "-" )):r, pyOr(rs.value(Ground  ), "-"):w );
    i = i + 1;
  end;
  return i - 1;
end;

private macro ВыпискаПоСчету( index: integer, this: FNSPrint, Account: TRecHandler, StateDate:date )

  var FICode = GetFICode( Account.rec.FIID );
  var ПроводкиПоСчету:Object;
  array Acc;
  StrSplit( Account.rec.Account, Acc, 1, 1, 20 );            

  var D1 = StateDate, D2 = {curdate};
  if( ( this.НачалоПериода != date( 0, 0, 0 ) ) or ( this.КонецПериода != date( 0, 0, 0 ) ) ) 
    D1 = this.НачалоПериода;
    D2 = this.КонецПериода;
  end;
  [

                                                       ┌─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┐
    а) #                                            б) │#│#│#│#│#│#│#│#│#│#│#│#│#│#│#│#│#│#│#│#│            в) #
       __________                                      └─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┘               _____________________________________________
         № п/п                                                     № вклада (депозита)                         вклад (депозит) срочный или до востребования
                                                                                                                     или описание иных условий возврата
                                                                                          
    г) ##########                                   д) ##########                                           е) ##########
       ──────────                                      ──────────                                              __________
      дата открытия вклада (депозита)(дд.мм.гг)       дата истечения действия вклада (депозита)(дд.мм.гг)     дата закрытия вклада (депозита)(дд.мм.гг)

                                                                                                               ┌─┬─┬─┐                                      
    ж) #############################################################                                        з) │#│#│#│ - цифровой код валюты вклада
       ─────────────────────────────────────────────────────────────                                           └─┴─┴─┘  (депозита)
       дата изменения реквизитов вклада (депозита) (дд.мм.гг); № измененного счета
             по вкладу(депозиту) (до изменения / после изменения)
    

    и) ##########                                                                     к) ##########                                
       ───────────────────────────────────────────────────────────────                   ──────────────────────────────────────────────────────────────────
       дата начала периода, за который представлена выписка (дд.мм.гг)                   дата окончания периода, за который представлена выписка (дд.мм.гг)

    Таблица 1
    ┌───────────────────────────────┬──────────────────────────────────────┬─────────────────────────────────────┬────────────────────────────────┐    │остаток по вкладу (депозиту) на│ сумма по дебету вклада (депозита) за │сумма по кредиту вклада (депозита) за│ остаток по вкладу (депозиту)   │
    │         на начало периода     │                период                │               период                │      на конец периода          │
    │         (руб., коп./вал.)     │           (руб., коп./вал.)          │          (руб., коп./вал.)          │      (руб., коп./вал.)         │
    ├───────────────────────────────┼──────────────────────────────────────┼─────────────────────────────────────┼────────────────────────────────┤
    │               1               │                     2                │                   3                 │              4                 │
    ├───────────────────────────────┼──────────────────────────────────────┼─────────────────────────────────────┼────────────────────────────────┤
    │###############################│######################################│#####################################│################################│ 
    └───────────────────────────────┴──────────────────────────────────────┴─────────────────────────────────────┴────────────────────────────────┘

    Таблица 2
    ┌────┬──────────┬───────────────────────┬─────────────────────────────────────────────┬───────────────────────────────────────────────────────┬───────────────────┬────────────┐
    │    │          │ реквизиты документа,  │    реквизиты банка плательщика/получателя   │            реквизиты плательщика/получателя           │  сумма операции   │            │
    │    │   дата   │ на основании которого │               денежных средств              │                    денежных средств                   │     по вкладу     │            │
    │    │ соверше- │была совершена операция│                                             │                                                       │    (депозиту)     │            │
    │ №  │   ния    │  по вкладу (депозиту) │                                             │                                                       │ (руб., коп./вал.) │            │
    │п/п │ операции │                       │                                             │                                                       │                   │ назначение │
    │    │(дд.мм.гг)├──────┬─────┬──────────┼────────────────────┬──────────────┬─────────┼─────────────┬──────────┬─────────┬────────────────────┼─────────┬─────────┤   платежа  │
    │    │          │      │     │          │        №           │              │         │             │          │         │      № счета       │         │         │            │
    │    │          │ вид  │номер│   дата   │ корреспондентского │ наименование │   БИК   │наименование/│ ИНН/КИО  │   КПП   │  (специального     │   по    │   по    │            │
    │    │          │(шифр)│     │          │        счета       │              │         │    Ф.И.О    │          │         │ банковского счета) │ дебету  │ кредиту │            │
    ├────┼──────────┼──────┼─────┼──────────┼────────────────────┼──────────────┼─────────┼─────────────┼──────────┼─────────┼────────────────────┼─────────┼─────────┼────────────┤
    │ 1  │    2     │  3   │  4  │    5     │         6          │       7      │    8    │      9      │    10    │    11   │        12          │   13    │   14    │      15    │
    ├────┼──────────┼──────┼─────┼──────────┼────────────────────┼──────────────┼─────────┼─────────────┼──────────┼─────────┼────────────────────┼─────────┼─────────┼────────────┤
  ]                                                                                               
   ( Index,
     Acc(0), Acc(1), Acc(2), Acc(3), Acc(4), Acc(5), Acc(6), Acc(7), Acc(8), Acc(9),
     Acc(10), Acc(11), Acc(12), Acc(13), Acc(14), Acc(15), Acc(16), Acc(17), Acc(18), Acc(19),
     Account.rec.typeacc,
     Account.rec.DateOpen:c,
     Account.rec.DepositDateEnd:c,
     Account.rec.DateClose:c,
     Changes[Index-1],
     SubStr(FICode ,  1, 1), SubStr(FICode ,  2, 1), SubStr(FICode ,  3, 1), D1, D2,
     Account.rec.RestIn,
     Account.rec.DebetTurn,
     Account.rec.CreditTurn,
     Account.rec.RestOut );

   if( printCarryes( Account.rec.Account, Account.rec.FIID, D1, D2 ) == 0 )
  [ │  - │    -     │  -   │  -  │     -    │         -          │     -        │    -    │      -      │     -    │    -    │          -         │    -    │    -    │      -     │]
   end;

  [ └────┴──────────┴──────┴─────┴──────────┴────────────────────┴──────────────┴─────────┴─────────────┴──────────┴─────────┴────────────────────┴─────────┴─────────┴────────────┘];

end;

macro PrintReportStatementOprAccounts( this: FNSPrint, ReqDate:date )
  var i = 0, j = -1;                                         
  var PrnAccounts:TArray = TArray();// сюда переносим счета из Accounts, которые есть в ReqAccounts
  Array Text, Buttons, Acc;
  var ErrMsg = "";
  var rs;
  rs = execSQLSelect("select t_Code from ddp_dep_dbt where t_PartyID = " + int(this.RepBankID));
  rs.moveNext();
  var Department = rs.value(0);

  if( this.WlRegDecID <= 0 )
    var Accounts:TArray = this.ВыбратьСчетаКлиента( ReqDate );
    while( i < Accounts.Size )
      while( j < this.Счет.Size )
        j = j + 1;
        if( ( this.Счет.Size == 0 ) or
            ( ( j < this.Счет.Size ) and  
              ( this.Счет[j] == Accounts(i).rec.Account ) and ( GetFICode( Accounts[i].rec.Code_Currency ) == SubStr( this.Счет[j], 6, 3 ) ) ) )
          PrnAccounts[PrnAccounts.Size] = Accounts[i];
          if( j < this.Счет.Size )
            this.Счет[j] = "";
          end;
        end;
      end;
      j = -1;
      i = i + 1;
    end;

    // какие-то из счетов не были найдены
    if( PrnAccounts.Size <= 0 )
      MsgBox( "Не найдено ни одного открытого счета клиента" );
      return 1;
    elif( PrnAccounts.Size < this.Счет.Size )
      j = 0;
      while( j < this.Счет.Size )         
        if( ErrMsg == "" )
          ErrMsg = "Не найден(ы) счет(а) ";
        end;
        if( this.Счет[j] != "" )
          Text(0) = string("Не найден счет № ", this.Счет[j], ".|Продолжить печать?");
          Buttons( 0 ) = "Да";
          Buttons( 1 ) = "Нет";
          if( GetDialogFlag() )
            if( ConfWin( Text, Buttons ) == 1 )
              return 0; // при отказе от печати не должно быть сообщения об ошибке выполнения макроса
            end;
          else
            // запомним все ненайденные счета через ","
            ErrMsg = ErrMsg + IfThenElse( StrBrk( ErrMsg, "0123456789" ),  ", ", "" ) + this.Счет[j];
          end;
        end;
        j = j + 1;
      end;
      if( not GetDialogFlag() and
          ( StrBrk( ErrMsg, "0123456789" ) ) )
        SetMNSWarning( ErrMsg );
      end;
    end;
    Accounts = null;
  else
    PrnAccounts = TArray(this.Счет);
  end;
  i = 0;  
  if( PrnAccounts.Size <= 0 )
    MsgBox( "Не найдено ни одного открытого счета клиента" );
    return 1;
  end;
    ЗаголовокСправки_ММ_3_06_178("1114313");
    [
                                           Выписка
                                по операциям по вкладу (депозиту)
    ];
  
  //YES
  var Errors = 0;
  for(i, 0, PrnAccounts.size - 1)
    var Description = GetError(PrnAccounts(i).rec.Account, WlRegDecID);
    if(Description) 
      Errors = Errors + 1;
    end;
  end;
  i = 0;
  if(GetYes(PrnAccounts, WlRegDecID) or (Errors < PrnAccounts.size))
    ДанныеБанкаИ_Клиента();
    [                                                                                                     ┌───┐
      по операциям по вкладам (депозитам) действовавшим                                                   │ X │
                                                                                                          └───┘ ]
    (GetYes(PrnAccounts, WlRegDecID));
    
    while( i < PrnAccounts.Size )
      if( strlen(GetError(PrnAccounts(i).rec.Account, WlRegDecID)) == 0 )
    this.ДанныеФилиала(1, 1, PrnAccounts(i).rec.Department, ReqDate);
    ВыпискаПоСчету( i + 1, this, PrnAccounts(i), ReqDate );
      end;
    end;
  end;

  // OP
  var Op = GetOp(PrnAccounts, this.WlRegDecID);
  if(Op)
    [                                                                                                                                                                          ┌───┐
      об отсутствии следующих вкладов (депозитов) указанного лица, действовавших ################# в:                                                                          │ X │ 
                                                                                 ─────────────────                                                                             └───┘

    ]( string( "\"", substr(YYYYMMDD(ReqDate),7,2), "\" ",
                     Месяца(substr(YYYYMMDD(ReqDate),5,2)):c, " ",
                     substr(YYYYMMDD(ReqDate),1,4), " г." ));
    i = 0;
    var SeqNumber : Integer = 1;
    while(i < PrnAccounts.size )
      if( isAccNotFound(PrnAccounts(i).rec.Account, this.WlRegDecID))
        StrSplit( PrnAccounts(i).rec.Account, Acc, 1, 1, 20 );   
        [
            ┌─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┐
      ##  № │#│#│#│#│#│#│#│#│#│#│#│#│#│#│#│#│#│#│#│#│
                └─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┘
          владелец счета ####################################################################################################
                         ────────────────────────────────────────────────────────────────────────────────────────────────────
        ]( SeqNumber,
       Acc(0), Acc(1), Acc(2), Acc(3), Acc(4), Acc(5), Acc(6), Acc(7), Acc(8), Acc(9),
       Acc(10), Acc(11), Acc(12), Acc(13), Acc(14), Acc(15), Acc(16), Acc(17), Acc(18), Acc(19),
           this.GetAccName( PrnAccounts(i).rec.Client )        // AccOwner
     );
        SeqNumber = SeqNumber + 1;
      end;
      i = i + 1;
    end;
  end;
  
  //NO
  Errors = 0;
  for(i, 0, PrnAccounts.size - 1)
    Description = GetError(PrnAccounts(i).rec.Account, WlRegDecID);
    if( (Description) and (SubStr(strlwr(Description), 1, strlen("Счет не найден")) != strlwr("Счет не найден"))) 
      Errors = Errors + 1;
    end;
  end;
  if( Errors or (PrnAccounts.size == 0) )
    [                                                                                                                                                                          ┌───┐
      об отсутствии вкладов (депозитов) указанного лица, действовавших                                                                                                         │ X │        
                                                                                                                                                                               └───┘];
     this.ДанныеФилиала(1, 1, PrnAccounts(0).rec.Department, ReqDate);
  end;
  //PS
  if(this.Ps)
    [
                                                                                                                                                                               ┌───┐
      выписка по операциям на счете (специальном банковском счете) в части информации следующих филиалов банка будет представлена ими самостоятельно:                          │ # │
                                                                                                                                                                               └───┘]
    (this.Ps);
    this.ДанныеФилиала(1, 1, PrnAccounts(0).rec.Department, ReqDate);
  end;

    ДатаПодписьПредставителяБанка();
    [];
  
  
  return 0;
end;
