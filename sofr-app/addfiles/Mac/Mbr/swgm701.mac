// --------------------------------------------------------------------
//         Автоматизированная банковская система RS-Bank v6.0
//                 Copyright (c) R-Style Software Lab
//
//  Описание    : Генерация сообщения по SWIFT MT701
//
//  Программист : Чукина Т.А.
//
//  Создан      : 25.07.2013
//
// --------------------------------------------------------------------

import "swgenmes.mac", LCInter;

macro GenMes( addrMes, addrLcdoc, addrOldMes )

  var Recreate = false;
  Record oldMes(wlmes);
  Record wllcdoc(lcdoc);

  SetBuff( wlmes,   addrMes );
  SetBuff( wllcdoc, addrLcdoc );
  
  if( ValType(AddrOldMes) == V_MEMADDR )
    SetBuff( oldmes, addrOldMes );
    Recreate = true;
  end;

  PrintLog(2, "Генерация сообщения по МТ701");
  var LcObj : RsbLetterOfCredit = RsbLetterOfCredit( wllcdoc.LcdocID ),
      field_value : string = "";

  // 27 - номер по порядку
  WriteFieldEx( SequenceOfTotalField, LcObj.NumMes+"/"+LcObj.CountMes, Recreate, oldMes );

  // 20 - номер транзакции (документа)
  ЗаписатьПолеЛог( TransactionReferenceNumberField, wllcdoc.Number );

  // 45B - Описание товаров/услуг
  if(LcObj.Flag45 == "X")
    SWIFTWriteFieldExNM( "45b", "45B", LcObj.DescGoods, Recreate, oldMes, 100, 65 );
  end;

  // 46B - Требуемые документы
  if(LcObj.Flag46 == "X")
    SWIFTWriteFieldExNM( "46b", "46B", LcObj.DocReq, Recreate, oldMes, 100, 65 );
  end;

  // 47B - Дополнительные условия аккредитива
  if(LcObj.Flag47 == "X")
    SWIFTWriteFieldExNM( "47b", "47B", LcObj.AddCond, Recreate, oldMes, 100, 65 );
  end;

  return TRUE; /* Успешное завершение */

  OnError(er) /* обработка ошибок */
    ExeptionMessage(er);
    return FALSE;
end;
