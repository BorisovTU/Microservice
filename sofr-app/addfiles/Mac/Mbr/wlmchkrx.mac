/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 5.1                      */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/* Проверка платежей по сообщениям МЦИ макета R (документы)                 */
/*                                                                          */
/* Имя файла: wlmcchkr.mac                                                  */
/* Создан:    30.12.02                                             BARS     */
/****************************************************************************/
import "wlmcgd.mac", "wlmcgm.mac", FIInter, "wltreas.mac", "wlchmes.mac";

macro RMaketCheck( addrMes )

   var Сумма, Account;

   SetBuff( wlmes, addrMes );

   if( not СчитатьПоле( FormFldDoc, Строка ) )
      return FALSE;
   end;

   if ( not FillBuffPayment(wlmes) )
      std.msg( "Не найдена связь сообщения с платежем" );
      return false;
   end;

   if ( not CheckMessagesPayment(wlpm) )
      std.msg( "Платежу соответствует несколько одинаковых сообщений|Откатите выгрузку в МБР данного платежа и попробуйте снова." );
      return false;
   end;

   Сумма = substr( Строка, 100, 18 );

   if ( wlpmpaym.PayAmount!=moneyL(doubleL(Сумма)/100) )
     std.msg( string( "Сумма сообщения не соответствует платежу.|Откатите выгрузку в МБР данного платежа и попробуйте снова.") );
     return false;
   end;   

   Account = "";
   Account = Форматный_вывод_в_строку( Account, wlpmpaym.PayerAccount, 20, Числовое_Поле );
   if ( Account!=substr(Строка, 80, 20) )
      std.msg( string( "Счет плательщика сообщения не соответствует платежу.|Откатите выгрузку в МБР данного платежа и попробуйте снова.") );
      return false;
   end;

   Account = "";
   Account = Форматный_вывод_в_строку( Account, wlpmpaym.ReceiverAccount, 20, Числовое_Поле );
   if ( Account!=substr(Строка, 147, 20) )
      std.msg( string( "Счет получателя сообщения не соответствует платежу.|Откатите выгрузку в МБР данного платежа и попробуйте снова.") );
      return false;
   end;

   return true;
end;
