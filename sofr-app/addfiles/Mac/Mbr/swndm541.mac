import "swdpgmes.mac";

RECORD Corschem( corschem );


macro GenMes( addrMes, addrbuf )
  RECORD DpBuf( dpmsginf );
  var msginf, msgLink, msgParty;  

  SetBuff( wlmes,  addrMes );
  SetBuff( DpBuf,  addrbuf );
  
  msginf = RsbDepoInfoMessage(DpBuf.MessageID);

  if ( valtype(msginf)==V_UNDEF )
     RunError( "|Не определен объект класса" );
  end;

  /* Блок GENL (начало) */
  ЗаписатьПолеЛогВБлок( GENL_Block, StartOfBlock, GENL_Block );
    if ( msginf.SenderReference=="" )
       RunError( "|Не заполнен номер исходящего сообщения" );
    end;
  /*  A/20C/SEME   */
  ЗаписатьПолеЛог( SendersReferenceField, ":SEME//"+msginf.SenderReference ) ;

  /*  23G   */
  ЗаписатьПолеЛог( FunctionMessageField, GetMessageFunction(msginf) ) ;
  /*   A/98a/PREP  */
  if ( msginf.PreparationDate!=date(0,0,0) )
    if( not УстановитьКонтекстБлока( "98a" ) )
      RunError("|Ошибка при установке контекста блока 98a");
    end;
    ЗаписатьПолеЛог( PreperationDateTimeField, ":PREP//"+GetSWIFTDateFull(msginf.PreparationDate)+
                                                      GetSWIFTTimeFull(msginf.PreparationTime) );  
    if( not УстановитьКонтекстБлока( ".." ) )
      RunError("|Ошибка при установке контекста блока ..");
    end;
  end;
 
  /* Блок LINK (начало) */
  if( not УстановитьКонтекстБлока( LINK_Block ) )
    RunError("|Ошибка при установке контекста блока " + LINK_Block);
  end;
    if ( GetMessageFunction(msginf)=="CANC" )
       msginf.RewindLinkedMessage();
       msgLink = msginf.GetLinkedMessage();
       if ( valtype(msgLink)==V_UNDEF )
          RunError("|Отсутствует обязательная последовательность связок (блок LINK)");
       end;
       while( valtype(msgLink)!=V_UNDEF )
          ЗаписатьПолеЛог( StartOfBlock, LINK_Block );
          ЗаписатьПолеЛог( IndicatorField, ":BEFO//" + GetLikageType(msgLink.LinkageType) );
          ЗаписатьПолеЛог( LinkedTransactionField, ":LINK//541");
          ЗаписатьПолеЛог( SendersReferenceField, ":PREV//"+msgLink.SenderReference ) ;
          ЗаписатьПолеЛог( EndOfBlock, LINK_Block );
          ЗаписатьПолеЛог( StartOfBlock, LINK_Block );
          ЗаписатьПолеЛог( IndicatorField, ":BEFO//" + GetLikageType(msgLink.LinkageType) );
          ЗаписатьПолеЛог( SendersReferenceField, ":RELA//"+msgLink.ReceiverReference ) ;
          ЗаписатьПолеЛог( EndOfBlock, LINK_Block );
          ЗаписатьПолеЛог( StartOfBlock, LINK_Block );
          ЗаписатьПолеЛог( SendersReferenceField, ":TRRF//"+msginf.TradeNumber  ) ;
          ЗаписатьПолеЛог( EndOfBlock, LINK_Block );
          msgLink = msginf.GetLinkedMessage();
       end;
    end;
  if( not УстановитьКонтекстБлока( ".." ) )
    RunError("|Ошибка при установке контекста блока ..");
  end;
 /* Блок LINK (конец) */
 ЗаписатьПолеЛог( EndOfBlock, GENL_Block ) ;
 /* Блок GENL (конец) */
/*-------------------Подпоследователь-ность "A1"--------Связи-------------------------------*/
/* ----------------xxxxxx---------------- xxxxxx ----------------xxxxxx---------------------*/
/*-------------------Последовательность "B"--------Детали операции/сделки-------------------*/

  /* Блок TRADDET (начало) */
  ЗаписатьПолеЛогВБлок( TRADDET_Block, StartOfBlock, TRADDET_Block );

  /* B/98a/SETT */
  if( not УстановитьКонтекстБлока( "98a" ) )
    RunError("|Ошибка при установке контекста блока 98a");
  end;
  if ( msginf.SettlementDate==date(0,0,0) )
     RunError("|Не заполнена дата начала периода использования поручения");
  end;
  ЗаписатьПолеЛог( PreperationDateTimeField, ":SETT//"+GetSWIFTDateFull(msginf.SettlementDate)
                                                      +GetSWIFTTimeFull(msginf.SettlementTime) );

  if ( msginf.TradeDate!=date(0,0,0) )
     ЗаписатьПолеЛог( PreperationDateTimeField, ":TRAD//"+GetSWIFTDateFull(msginf.TradeDate)
                                                         +GetSWIFTTimeFull(msginf.TradeTime) );
  end;
  if( not УстановитьКонтекстБлока( ".." ) )
    RunError("|Ошибка при установке контекста блока ..");
  end;
  
  /*35B*/
  ЗаписатьПолеЛог( IdentificationOfSecuritiesField, CreateIdentificationOfSecurities(msginf, true) );

  if(msginf.NeedBlock == true)
  /*  B/22F/TTCO */
    if( not УстановитьКонтекстБлока( "22a" ) )
      RunError("|Ошибка при установке контекста блока ..");
    end;
    ЗаписатьПолеЛог( IndicatorField, ":TTCO//GTDL" );
    if( not УстановитьКонтекстБлока( ".." ) )
       RunError("|Ошибка при установке контекста блока ..");
    end;
  end;

  ЗаписатьПолеЛог( EndOfBlock, TRADDET_Block ) ;

  /* Блок TRADDET (конец) */
/*-------------------Последовательность "B"--------Детали операции/сделки-------------------*/

  /* Блок FIAC (начало) */
  ЗаписатьПолеЛогВБлок( FIAC_Block, StartOfBlock, FIAC_Block );
  /* C/36B/SETT */                                           
  ЗаписатьПолеЛог( QuantityOfFIField, ":SETT//UNIT/"+GetNDCAmount(msginf.QuantityToBeSettled) );
  /*  C/97a/SAFE*/ 
  if( not УстановитьКонтекстБлока( "97a" ) )
    RunError("|Ошибка при установке контекста блока 97a");
  end;
  if ( (msginf.Account!="") and (msginf.Partition!="") )
     ЗаписатьПолеЛог( AccountAField, ":SAFE//"+msginf.Account+"/KRZD/"+msginf.Partition);
  else
     RunError("|Не задан счет/раздел депо продавца");
  end;

  if( not УстановитьКонтекстБлока( ".." ) )
    RunError("|Ошибка при установке контекста блока ..");
  end;
  /*  End Block */
  ЗаписатьПолеЛог( EndOfBlock, FIAC_Block ) ;
  /* Блок FIAC (конец) */


  /* Блок SETDET (начало) */
  ЗаписатьПолеЛогВБлок( SETDET_Block, StartOfBlock, SETDET_Block );
  /*  E/22F/SETR */
  if( not УстановитьКонтекстБлока( "22a" ) )
    RunError("|Ошибка при установке контекста блока 22a");
  end;
  ЗаписатьПолеЛог( IndicatorField, ":SETR//"+GetSettlementTRNType(msginf) );
  if( not УстановитьКонтекстБлока( ".." ) )
    RunError("|Ошибка при установке контекста блока ..");
  end;


  /* Блок SETPRTY (начало)        Отправитель ценных бумаг  */
  ЗаписатьПолеЛогВБлок( SETDET_Block+"/"+SETPRTY_Block, StartOfBlock, SETPRTY_Block );
  /*  E1/95a/DEAG */
  if( not ЗаписатьИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_DEAG, NULL, true) )
     RunError("|Отсутствует информация об идентификаторе стороны (DEAG)");
  end;
  /*  E1/97a/SAFE */
  if( not ЗаписатьСчетИРазделИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_DEAG) )
     RunError("|Отсутствует информация о счете идентификатора стороны (DEAG)");
  end;
  ЗаписатьПолеЛог( EndOfBlock, SETPRTY_Block ) ;
  if( not УстановитьКонтекстБлока( ".." ) )
     RunError("|Ошибка при установке контекста блока ..");
  end;
  /* Блок SETPRTY (конец)         Отправитель ценных бумаг  */


  /* Блок SETPRTY (начало)       Место проведения расчетов  */
  ЗаписатьПолеЛогВБлок( SETDET_Block+"/"+SETPRTY_Block, StartOfBlock, SETPRTY_Block );
  /*  E1/95a/PSET */
  if( not ЗаписатьИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_PSET, NULL, true) )
     RunError("|Отсутствует информация об идентификаторе стороны (PSET)");
  end;
  /*  End bloack */
  ЗаписатьПолеЛог( EndOfBlock, SETPRTY_Block ) ;
  if( not УстановитьКонтекстБлока( ".." ) )
     RunError("|Ошибка при установке контекста блока ..");
  end;
  /* Блок SETPRTY (конец)              Место проведения расчетов  */


  /* Блок CSHPRTY (начало)              Кредитная организация Отправителя денежных средств */
  msgParty = GetMessageParty(msginf,DPMSGPAT_CURRENCIES ,OBJTYPE_MSGPATYTP_PAYE);
  if ( valtype(msgParty)!=V_UNDEF )
    ЗаписатьПолеЛогВБлок( SETDET_Block+"/"+CSHPRTY_Block, StartOfBlock, CSHPRTY_Block );
    /*95a*/
    if( ЗаписатьИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_PAYE,msgParty, true) )
       /*97a*/
      if( not ЗаписатьСчетИРазделИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_PAYE, msgParty) )
         RunError("|Отсутствует информация о счете идентификатора стороны (PAYE)");
      end;
    end;
    ЗаписатьПолеЛог( EndOfBlock, CSHPRTY_Block ) ;
    if( not УстановитьКонтекстБлока( ".." ) )
       RunError("|Ошибка при установке контекста блока ..");
    end;
  end;
  /* Блок CSHPRTY (конец)               Кредитная организация Отправителя денежных средств */
                                
  /* Блок CSHPRTY (начало) Кредитная организация получателя денежных средств (б/ бенефец.) */
  msgParty = GetMessageParty(msginf,DPMSGPAT_CURRENCIES,OBJTYPE_MSGPATYTP_ACCW);
  if ( valtype(msgParty)!=V_UNDEF )
    ЗаписатьПолеЛогВБлок( SETDET_Block+"/"+CSHPRTY_Block, StartOfBlock, CSHPRTY_Block );
    /*95a*/
    if( ЗаписатьИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_ACCW,msgParty, true) )
      /*97a*/
      if( not ЗаписатьСчетИРазделИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_ACCW, msgParty) )
         RunError("|Отсутствует информация о счете идентификатора стороны (ACCW)");
      end;
    end;
    ЗаписатьПолеЛог( EndOfBlock, CSHPRTY_Block ) ;
    
    if( not УстановитьКонтекстБлока( ".." ) )
       RunError("|Ошибка при установке контекста блока ..");
    end;
    
  end;
  /* Блок CSHPRTY (начало) Кредитная организация получателя денежных средств (б/ бенефец.) */


  /* Блок AMT (начало)             Суммы  */
  ЗаписатьПолеЛогВБлок( SETDET_Block+"/"+AMT_Block, StartOfBlock, AMT_Block );
     if( not УстановитьКонтекстБлока( "19a" ) )
        RunError("|Ошибка при установке контекста блока 19a");
     end;
     FillSumOfAmountAField( msginf, true, true );
     if( not УстановитьКонтекстБлока( ".." ) )
        RunError("|Ошибка при установке контекста блока ..");
     end;
  ЗаписатьПолеЛог( EndOfBlock, AMT_Block );      
  /* Блок AMT (конец)             Суммы */

  if( not УстановитьКонтекстБлока( ".." ) )
     RunError("|Ошибка при установке контекста блока ..");
  end;
  ЗаписатьПолеЛог( EndOfBlock, SETDET_Block ) ;
  /* Блок SETDET (конец) */

  /*-----------------------------------------------------------------------*/

  msgParty = GetMessageParty(msginf,DPMSGPAT_OTHER,OBJTYPE_MSGPATYTP_MEOR);
  if ( (valtype(msgParty)!=V_UNDEF) )
     /* Блок OTHRPRTY (начало) */
     ЗаписатьПолеЛогВБлок( OTHRPRTY_Block, StartOfBlock, OTHRPRTY_Block );

     /*95a*/
     if( not ЗаписатьИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_MEOR, msgParty, true) )
        RunError("|Отсутствует информация об инициаторе поручения");
     end;

     ЗаписатьПолеЛог( EndOfBlock, OTHRPRTY_Block );
     /* Блок OTHRPRTY (конец) */
  end;

 
  /*-----------------------------------------------------------------------*/
  /* Блок OTHRPRTY (начало)    Конечный получатель сообщения S.W.I.F.T.  */
  msgParty = GetMessageParty(msginf,DPMSGPAT_OTHER,OBJTYPE_MSGPATYTP_MERE);
  if ( (valtype(msgParty)!=V_UNDEF) )
     /* Блок OTHRPRTY (начало) */
     ЗаписатьПолеЛогВБлок( OTHRPRTY_Block, StartOfBlock, OTHRPRTY_Block );

     /*95a*/
     if( not ЗаписатьИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_MERE, msgParty, true) )
        RunError("|Отсутствует информация о получателе сообщения");
     end;

     /*70E*/
     ЗаписатьПереченьДокументов( msginf, true );

     /*70C*/
     if( not УстановитьКонтекстБлока( "70a" ) )
        RunError("|Ошибка при установке контекста блока 70a");
     end;
     if ( msginf.EffectiveSettlementDate!=date(0,0,0) )                                                          
        ЗаписатьПолеЛог( FIANarrativeCField, ":PACO//XX/CORP/NADC//SEND/"+ GetSWIFTDateFull(msginf.EffectiveSettlementDate) ) ;
     end;

     if( not УстановитьКонтекстБлока( ".." ) )
        RunError("|Ошибка при установке контекста блока ..");
     end;
     /*20C*/                                             
     if ( msginf.ProcessingCode!="" )
        ЗаписатьПолеЛог( SendersReferenceField, ":PROC//TRNC/"+msginf.ProcessingCode ) ;
     end;
     ЗаписатьПолеЛог( EndOfBlock, OTHRPRTY_Block );
  end;
  /* Блок OTHRPRTY (конец)    Конечный получатель сообщения S.W.I.F.T.  */

  /* Блок OTHRPRTY (начало) Депонент (владелец) счета депо, если он не является инициатором поручения*/
  msgParty = GetMessageParty(msginf,DPMSGPAT_OTHER,OBJTYPE_MSGPATYTP_INVE);
  if ( (valtype(msgParty)!=V_UNDEF) )
     ЗаписатьПолеЛогВБлок( OTHRPRTY_Block, StartOfBlock, OTHRPRTY_Block );
     /*95a*/
     if( not ЗаписатьИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_INVE, msgParty, true) )
        RunError("|Отсутствует информация об инициаторе поручения");
     end;
     ЗаписатьПолеЛог( EndOfBlock, OTHRPRTY_Block );
  end;
  /* Блок OTHRPRTY (конец) Депонент (владелец) счета депо, если он не является инициатором поручения*/

  return TRUE; /* Успешное завершение */

  OnError(er) /* обработка ошибок */
    ExeptionMessage(er);
    return FALSE;
end;


