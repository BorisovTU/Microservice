/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 5.1                      */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/*  Возврат платежа на дальнейшую обработку в АРМ позиционера               */
/*  Имя файла: w110_220.mac                                                 */
/*  Создан:  17.10.00                                         Бабин А.П.    */
/****************************************************************************/

import InsCarryDoc, OprInter, BankInter, RMInter, "wldoc.mac", "wlkvit.mac", "cbsttls.mac";

RECORD Corschem( corschem );

var PaymentObj:RsbPayment;

const Menu1 = "Поместить в картотеку";
const Menu2 = "Вернуть отправителю";
const Menu3 = "Вернуть на повторную обработку";
const ActionName = "Действие:";

macro ExecuteStep( doc, first )
  var stat:integer = 0, KvitType, Cancel:string, menu_item;

     Cancel=KVIT_NORMAL;

  if ( Cancel==KVIT_NORMAL )
     if ( УстановитьСтатусыПлатежа(OPR_PAYM_DO, OPR_PM_ST_ENTER) )
        MsgBox("Возникла ошибка при смене статусов операции платежа");
        return 1;
     end;     
     
     PaymentObj.PropStatus = PM_PROP_KVITED;
  else
     /* Была квитовка отказом */
     if ( (Corschem.IsNostro="X") and GetCorAcc(Corschem.FIID, Corschem.Number, CORS_ACC_CARDFILE) )
        menu_item = Opr_MakeChoice(Menu1, Menu2, Menu3, ActionName);
     else
        menu_item = Opr_MakeChoice(Menu2, Menu3, ActionName);
        if ( menu_item>=0 )
           menu_item = menu_item + 1;
        end;
     end;
     PaymentObj.PropStatus = PM_PROP_CORREJECTED;
     if ( menu_item==0 ) /* Поместить в картотеку */
/*       if ( УстановитьСтатусыПлатежа(OPR_PAYM_DO, OPR_PM_ST_CARD) )
          MsgBox("Возникла ошибка при смене статусов операции платежа");
          return 1;
       end;*/
     elif ( menu_item==1 ) /* Вернуть отправителю */
       if ( УстановитьСтатусыПлатежа(OPR_PAYM_DO, OPR_PM_ST_RETURN) )
          MsgBox("Возникла ошибка при смене статусов операции платежа");
          return 1;
       end;
     elif ( menu_item==2 ) /* Вернуть на повторную обработку */
       PaymentObj.PropStatus = PM_PROP_READY;
       if ( УстановитьСтатусыПлатежа(OPR_PAYM_DO, OPR_PM_ST_POS) )
          MsgBox("Возникла ошибка при смене статусов операции платежа");
          return 1;
       end;
     else
       return 1;
     end;
  end;

  return 0 ;
end ;

