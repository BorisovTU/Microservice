/*
$Name: openFile.mac
$Module: МБР
$Description: открытие файла сеанса
*/


import likepy, oralib, rsd, WldInter;

PRIVATE FILE txt_file() txt write;

private macro ExtractXMLFile(SessionID:integer) : string
  
  var stat = 0;

  var idx = 1;
  var xml_string = "";  
  
  while(true)
    var cmd = RsdCommand(
                          " DECLARE " +
                          "    l_clob           CLOB := CHR(1);" +
                          "    l_blob           BLOB;" +
                          "    l_dest_offsset   INTEGER := 1;" +
                          "    l_src_offsset    INTEGER := 1;" +
                          "    l_lang_context   INTEGER := DBMS_LOB.default_lang_ctx;" +
                          "    l_warning        INTEGER;" +
                          " BEGIN" +
                          "    SELECT T_FMTBLOBDATA_XXXX" +
                          "      INTO l_blob" +
                          "      FROM dwlsesspr_dbt" +
                          "     WHERE T_SessionID = ? AND T_SessionNum = ? ;" +
                          "    IF l_blob IS NOT NULL" +
                          "    THEN" +
                          "       DBMS_LOB.createTemporary (l_clob, FALSE);" +
                          "       DBMS_LOB.converttoclob (l_clob," +
                          "                               l_blob," +
                          "                               DBMS_LOB.lobmaxsize," +
                          "                               l_dest_offsset," +
                          "                               l_src_offsset," +
                          "                               DBMS_LOB.default_csid," +
                          "                               l_lang_context," +
                          "                               l_warning);" +
                          "       ? := l_clob;" +
                          "    END IF;" +
                          " EXCEPTION " +
                          " WHEN NO_DATA_FOUND THEN " +
                          "   ? := 1; " +
                          " END; "
                        );
                        
    cmd.addParam("", RSDBP_IN, SessionID );
    cmd.addParam("", RSDBP_IN, idx );
    cmd.addParam("", RSDBP_OUT, V_STRING, 30000);
    cmd.addParam("", RSDBP_OUT, V_INTEGER);
    
    cmd.execute();
    
    if(cmd.value(3) == 0)
      xml_string = xml_string + cmd.value(2);
    else
      break;
    end;
    
    idx = idx + 1;
  end;

  return xml_string;
end;

macro ShowFile( SessionID:integer ) : integer


  var isXML : bool = false;

  var query = " select wltpfrmt.t_FormatFile Format, " +
              " wlsess.t_TpID Tp, " +
              " wlsess.t_MessageType MessageType " +
              " from dwltpfrmt_dbt wltpfrmt " +
              " inner join dwlsess_dbt wlsess " +
              " ON wlsess.t_TpFrmtID = wltpfrmt.t_TpFrmtID " +
              " WHERE wlsess.t_SessionID = :SessionID ";
              

  var rs:RsdRecordset = execSQLselect(query, makeArray(SQLParam("SessionID", SessionID)), true);

  if(rs and rs.moveNext() and (rs.value("Format") == WLD_FORMAT_XML) )
    isXML = true;
  end;

  var fileName = "..\\txtfile\\wlsesspr_" + SessionID + IfThenElse( isXML, ".xml", ".txt" );
  var stat = 0;

  var xml_string = ExtractXMLFile(SessionID:integer);  

  if(xml_string == "")
    return 4773;
  end;

  stat = Bnk_decodeXML( xml_string );

  if( (not stat) and (rs.value("MessageType") == "ED503"))
    stat = Bnk_decodeXML( xml_string, "SWIFTDocument" );
  end;

  if(not stat)
  
    if(open(txt_file, fileName ))
      insert(txt_file,  xml_string);

      close(txt_file);
    else
      stat = 1;
    end;  

    if(not stat)
      stat = Bnk_StartExtViewer(fileName);     
    end;

  end;
  
  return 0;

end;