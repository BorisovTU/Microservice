/*
  $Name: ufpr107.mac
  $Module: Межбанковские расчеты
  $Description: Печатная форма сообщения ED107 транспорта УФЭБС
*/

import MesInter, "wlglobal.mac", "wluftool.mac", "WLTOOLS.mac", "ufgd107.mac";

class TMessageRequisites
  var RequisiteNumber: string,
      RequisiteName: string,
      RequisiteValue: string;
  macro Construct()
    RequisiteNumber = RequisiteName = RequisiteValue = "";
  end;
  Construct();
end;

private macro MakeRightSum( sum:moneyL ):string
  var tmpSum: string = sum;
  var resultSum = "";
  var tmpStr = "";
  var pntpos = Index( tmpSum, "." );
  if( pntpos )
    resultSum = Substr( tmpSum, 1, pntpos - 1 );
    resultSum = resultSum + "-";
    tmpStr = Substr( tmpSum, pntpos + 1 );
    if( Strlen( tmpStr ) == 2 )
      resultSum = resultSum + tmpStr;
    elif( Strlen( tmpStr ) == 1 )
      resultSum = resultSum + tmpStr + "0";
    end;
    resultSum = resultSum + " RUB"
  else
    resultSum = tmpSum + "-" + "00" + " RUB";  
  end;
  return resultSum;
end;

private macro FindSubjectOnCode( BIC:string, SWBIC:string ):string
  var ObjectID = 0;
  var PartyName = "";

  if( BIC != "" )
    var bicselect = " select t_ObjectID " +  
                    " from dobjcode_dbt " +  
                    " where t_Code = :Code" + 
                    "   and t_CodeKind = :CodeKind"; 

    var bicparams = makeArray( SQLParam( "Code",     BIC ),
                               SQLParam( "CodeKind", PTCK_BIC ) );
                          
    var bicrs = execSQLselect( bicselect, bicparams );
    
    if( bicrs and bicrs.moveNext() )
      ObjectID = int(bicrs.value(0));
    end;
  end;

  if( ( ObjectID == 0 ) and ( SWBIC != "" ) )
    var swiftselect = " select t_ObjectID " +  
                      " from dobjcode_dbt " +  
                      " where t_Code = :Code" + 
                      "   and t_CodeKind = :CodeKind"; 

    var swiftparams = makeArray( SQLParam( "Code",     SWBIC ),
                                 SQLParam( "CodeKind", PTCK_SWIFT ) );
                          
    var swiftrs = execSQLselect( swiftselect, swiftparams );
    
    if( swiftrs and swiftrs.moveNext() )
      ObjectID = int(swiftrs.value(0));
    end;
  end;

  if( ObjectID != 0 )
    var prtyselect = " select t_Name " + 
                     " from dparty_dbt " +
                     " where t_PartyID = :PartyID ";
    var prtyparams = makeArray( SQLParam( "PartyID", ObjectID ) );
    var prtyrs = execSQLselect( prtyselect, prtyparams );
    
    if( prtyrs and prtyrs.moveNext() )
      PartyName = prtyrs.value(0);
    end;
  end;

  return PartyName;
end;

class TED107Report
  var PageNumber: integer,
      PageCount:  integer,
      LineNumber: integer,
      ED107MessageFields: TED107MessageFields,
      MessageRequisites: TArray;
  const MaxLinesOnPage = 85;
  const MaxRequisiteLength = 55;
  const LinesForHead = 4;
  const LinesForElement = 2/*3*/;
  const LinesForTableInfo = 6;
  const LinesForTableBottom = 1;
  const LinesForBankMarks = 4;

  private macro FillRequisitesForReport()
    MessageRequisites[MessageRequisites.size] = TMessageRequisites();
    MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "3";
    MessageRequisites[MessageRequisites.size - 1].RequisiteName = "N";
    MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.EDNo;
    MessageRequisites[MessageRequisites.size] = TMessageRequisites();
    MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "4";
    MessageRequisites[MessageRequisites.size - 1].RequisiteName = "Дата";
    MessageRequisites[MessageRequisites.size - 1].RequisiteValue = DDpMMpYYYY(ED107MessageFields.EDDate);
    if( ED107MessageFields.PaytKind != "" )
      MessageRequisites[MessageRequisites.size] = TMessageRequisites();
      MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "5";
      MessageRequisites[MessageRequisites.size - 1].RequisiteName = "Вид платежа";
      MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.PaytKind;
    end;
    MessageRequisites[MessageRequisites.size] = TMessageRequisites();
    MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "7";
    MessageRequisites[MessageRequisites.size - 1].RequisiteName = "Сумма";
    MessageRequisites[MessageRequisites.size - 1].RequisiteValue = MakeRightSum(ED107MessageFields.Sum/100);
    if( ED107MessageFields.OrderingBank != null )
      MessageRequisites[MessageRequisites.size] = TMessageRequisites();
      MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "81.1";
      MessageRequisites[MessageRequisites.size - 1].RequisiteName = "Банк-плательщик";
      if( ED107MessageFields.OrderingBank.Name == "" )
        MessageRequisites[MessageRequisites.size - 1].RequisiteValue = FindSubjectOnCode( ED107MessageFields.OrderingBank.BIC, ED107MessageFields.OrderingBank.SWBIC );
      else
        MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.OrderingBank.Name;
      end;
      if( ED107MessageFields.OrderingBank.BIC != 0 )
        MessageRequisites[MessageRequisites.size] = TMessageRequisites();
        MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "81.2";
        MessageRequisites[MessageRequisites.size - 1].RequisiteName = "БИК";
        MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.OrderingBank.BIC;
      end;
      if( ED107MessageFields.OrderingBank.SWBIC != "" )
        MessageRequisites[MessageRequisites.size] = TMessageRequisites();
        MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "81.3";
        MessageRequisites[MessageRequisites.size - 1].RequisiteName = "BIC";
        MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.OrderingBank.SWBIC;
      end;
      if( ED107MessageFields.OrderingBank.BankAccount != "" )
        MessageRequisites[MessageRequisites.size] = TMessageRequisites();
        MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "81.4";
        MessageRequisites[MessageRequisites.size - 1].RequisiteName = "Сч.N";
        MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.OrderingBank.BankAccount;
      end;
    end;
    if( ED107MessageFields.PrevInstrAgent != null )
      MessageRequisites[MessageRequisites.size] = TMessageRequisites();
      MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "82.1";
      MessageRequisites[MessageRequisites.size - 1].RequisiteName = "Предыдущий инструктирующий банк";
      if( ED107MessageFields.PrevInstrAgent.Name == "" )
        MessageRequisites[MessageRequisites.size - 1].RequisiteValue = FindSubjectOnCode( ED107MessageFields.PrevInstrAgent.BIC, ED107MessageFields.PrevInstrAgent.SWBIC );
      else
        MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.PrevInstrAgent.Name;
      end;
      if( ED107MessageFields.PrevInstrAgent.BIC != 0 )
        MessageRequisites[MessageRequisites.size] = TMessageRequisites();
        MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "82.2";
        MessageRequisites[MessageRequisites.size - 1].RequisiteName = "БИК";
        MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.PrevInstrAgent.BIC;
      end;
      if( ED107MessageFields.PrevInstrAgent.SWBIC != "" )
        MessageRequisites[MessageRequisites.size] = TMessageRequisites();
        MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "82.3";
        MessageRequisites[MessageRequisites.size - 1].RequisiteName = "BIC";
        MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.PrevInstrAgent.SWBIC;
      end;
      if( ED107MessageFields.PrevInstrAgent.BankAccount != "" )
        MessageRequisites[MessageRequisites.size] = TMessageRequisites();
        MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "82.4";
        MessageRequisites[MessageRequisites.size - 1].RequisiteName = "Сч.N";
        MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.PrevInstrAgent.BankAccount;
      end;
    end;  
    MessageRequisites[MessageRequisites.size] = TMessageRequisites();
    MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "83.1";
    MessageRequisites[MessageRequisites.size - 1].RequisiteName = "Банк-отправитель";
    MessageRequisites[MessageRequisites.size - 1].RequisiteValue = FindSubjectOnCode( ED107MessageFields.InstructingAgent.BIC, ED107MessageFields.InstructingAgent.SWBIC );
    MessageRequisites[MessageRequisites.size] = TMessageRequisites();
    MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "83.2";
    MessageRequisites[MessageRequisites.size - 1].RequisiteName = "БИК";
    MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.InstructingAgent.BIC;
    if( ED107MessageFields.InstructingAgent.SWBIC != "" )
      MessageRequisites[MessageRequisites.size] = TMessageRequisites();
      MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "83.3";
      MessageRequisites[MessageRequisites.size - 1].RequisiteName = "BIC";
      MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.InstructingAgent.SWBIC;
    end;
    MessageRequisites[MessageRequisites.size] = TMessageRequisites();
    MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "83.4";
    MessageRequisites[MessageRequisites.size - 1].RequisiteName = "Сч.N";
    MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.InstructingAgent.CorrespAcc;
    MessageRequisites[MessageRequisites.size] = TMessageRequisites();
    MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "84.1";
    MessageRequisites[MessageRequisites.size - 1].RequisiteName = "Банк-исполнитель";
    MessageRequisites[MessageRequisites.size - 1].RequisiteValue = FindSubjectOnCode( ED107MessageFields.InstructedAgent.BIC, ED107MessageFields.InstructedAgent.SWBIC );
    MessageRequisites[MessageRequisites.size] = TMessageRequisites();
    MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "84.2";
    MessageRequisites[MessageRequisites.size - 1].RequisiteName = "БИК";
    MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.InstructedAgent.BIC;
    if( ED107MessageFields.InstructedAgent.SWBIC != "" )
      MessageRequisites[MessageRequisites.size] = TMessageRequisites();
      MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "84.3";
      MessageRequisites[MessageRequisites.size - 1].RequisiteName = "BIC";
      MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.InstructedAgent.SWBIC;
    end;
    MessageRequisites[MessageRequisites.size] = TMessageRequisites();
    MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "84.4";
    MessageRequisites[MessageRequisites.size - 1].RequisiteName = "Сч.N";
    MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.InstructedAgent.CorrespAcc;

    if( ED107MessageFields.AcctWithInst != null )
      MessageRequisites[MessageRequisites.size] = TMessageRequisites();
      MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "85.1";
      MessageRequisites[MessageRequisites.size - 1].RequisiteName = "Агент банка-получателя";
      if( ED107MessageFields.AcctWithInst.Name == "" )
        MessageRequisites[MessageRequisites.size - 1].RequisiteValue = FindSubjectOnCode( ED107MessageFields.AcctWithInst.BIC, ED107MessageFields.AcctWithInst.SWBIC );
      else
        MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.AcctWithInst.Name;
      end;
      if( ED107MessageFields.AcctWithInst.BIC != 0 )
        MessageRequisites[MessageRequisites.size] = TMessageRequisites();
        MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "85.2";
        MessageRequisites[MessageRequisites.size - 1].RequisiteName = "БИК";
        MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.AcctWithInst.BIC;
      end;
      if( ED107MessageFields.AcctWithInst.SWBIC != "" )
        MessageRequisites[MessageRequisites.size] = TMessageRequisites();
        MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "85.3";
        MessageRequisites[MessageRequisites.size - 1].RequisiteName = "BIC";
        MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.AcctWithInst.SWBIC;
      end;
      if( ED107MessageFields.AcctWithInst.BankAccount != "" )
        MessageRequisites[MessageRequisites.size] = TMessageRequisites();
        MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "85.4";
        MessageRequisites[MessageRequisites.size - 1].RequisiteName = "Сч.N";
        MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.AcctWithInst.BankAccount;
      end;
    end;

    if( ED107MessageFields.Beneficiary != null )
      MessageRequisites[MessageRequisites.size] = TMessageRequisites();
      MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "86.1";
      MessageRequisites[MessageRequisites.size - 1].RequisiteName = "Банк-получатель";
      if( ED107MessageFields.Beneficiary.Name == "" )
        MessageRequisites[MessageRequisites.size - 1].RequisiteValue = FindSubjectOnCode( ED107MessageFields.Beneficiary.BIC, ED107MessageFields.Beneficiary.SWBIC );
      else
        MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.Beneficiary.Name;
      end;
      if( ED107MessageFields.Beneficiary.BIC != 0 )
        MessageRequisites[MessageRequisites.size] = TMessageRequisites();
        MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "86.2";
        MessageRequisites[MessageRequisites.size - 1].RequisiteName = "БИК";
        MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.Beneficiary.BIC;
      end;
      if( ED107MessageFields.Beneficiary.SWBIC != "" )
        MessageRequisites[MessageRequisites.size] = TMessageRequisites();
        MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "86.3";
        MessageRequisites[MessageRequisites.size - 1].RequisiteName = "BIC";
        MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.Beneficiary.SWBIC;
      end;
      if( ED107MessageFields.Beneficiary.BankAccount != "" )
        MessageRequisites[MessageRequisites.size] = TMessageRequisites();
        MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "86.4";
        MessageRequisites[MessageRequisites.size - 1].RequisiteName = "Сч.N";
        MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.Beneficiary.BankAccount;
      end;
    end;

    MessageRequisites[MessageRequisites.size] = TMessageRequisites();
    MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "18";
    MessageRequisites[MessageRequisites.size - 1].RequisiteName = "Вид. оп";
    MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.TransKind;

    MessageRequisites[MessageRequisites.size] = TMessageRequisites();
    MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "21";
    MessageRequisites[MessageRequisites.size - 1].RequisiteName = "Очер. плат";
    MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.Priority;
    
    if( ED107MessageFields.PaymentID != "" )
      MessageRequisites[MessageRequisites.size] = TMessageRequisites();
      MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "22";
      MessageRequisites[MessageRequisites.size - 1].RequisiteName = "Код";
      MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.PaymentID;
    end;

    if( ED107MessageFields.Sndr2RecvrInfo != "" )
      MessageRequisites[MessageRequisites.size] = TMessageRequisites();
      MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "74";
      MessageRequisites[MessageRequisites.size - 1].RequisiteName = "Банковская информация";
      MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.Sndr2RecvrInfo;
    end;

    MessageRequisites[MessageRequisites.size] = TMessageRequisites();
    MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "78";
    MessageRequisites[MessageRequisites.size - 1].RequisiteName = "Номер исходного документа";
    MessageRequisites[MessageRequisites.size - 1].RequisiteValue = ED107MessageFields.AccDocNo;

    MessageRequisites[MessageRequisites.size] = TMessageRequisites();
    MessageRequisites[MessageRequisites.size - 1].RequisiteNumber = "79";
    MessageRequisites[MessageRequisites.size - 1].RequisiteName = "Дата исходного документа";
    MessageRequisites[MessageRequisites.size - 1].RequisiteValue = DDpMMpYYYY(ED107MessageFields.AccDocDate);

  end;

  macro CalculatePageNumber()
    var tmpLines = LinesForHead + (LinesForElement*MessageRequisites.size) + LinesForTableInfo + LinesForTableBottom;
    for( var tmpreq, MessageRequisites )
      if( strlen(tmpreq.RequisiteValue) > MaxRequisiteLength )
        var tmpReqValArr:TArray = StrSplit2( tmpreq.RequisiteValue, MaxRequisiteLength );
        tmpLines = tmpLines + tmpReqValArr.size;    
      end;  
    end;
    var tmpnum = mod( tmpLines, MaxLinesOnPage );
    if( (tmpnum == tmpLines) or (tmpnum == 0) )
      PageCount = 1;
    else
      PageCount = int(tmpLines/MaxLinesOnPage) + 1    
    end;
  end;

  macro Construct()
    PageNumber = 1;
    LineNumber = 1;
    MessageRequisites = TArray();
    ED107MessageFields = TED107MessageFields();
    ReadED107MessageFields( @ED107MessageFields );
    FillRequisitesForReport();
    CalculatePageNumber();
  end;

  macro PrintTableHead()
    [
      ┌─────────┬───────────────────────────────┬───────────────────────────────────────────────────────┐
      │  Номер  │     Наименование реквизита    │                  Значение реквизита                   │
      │реквизита│                               │                                                       │
    ];
    LineNumber = LineNumber + LinesForHead;
  end;

  macro PrintTableInfo()
    [
                   Подписи                            Страница   ##          Всего страниц       ##        
    
        ─────────────────────────────

        ─────────────────────────────
    ]( PageNumber:c, PageCount:c );
  end;

  macro PrintBankMarks()
    [ ├─────────┼───────────────────────────────┼───────────────────────────────────────────────────────┤
      │         │                               │                                                       │
      │  #####  │###############################│                                                       │
      │         │                               │                                                       │      
    ]( "45" :c, "Отметки банка" :l );
    LineNumber = LineNumber + LinesForBankMarks;
  end;  

  macro PrintTableBottom()
    [ └─────────┴───────────────────────────────┴───────────────────────────────────────────────────────┘ ];
  end;

  private macro PrintTableElement( RequisiteNumber, RequisiteName, RequisiteValue ) 
    if( (LineNumber + LinesForElement + LinesForTableInfo + LinesForTableBottom + LinesForBankMarks) > MaxLinesOnPage )
      PrintTableBottom();
      PrintTableInfo();
      PrintLn("\f");
      LineNumber = 1;
      PageNumber = PageNumber + 1;  
    else
      if( LineNumber == 1 )
        [ ┌─────────┬───────────────────────────────┬───────────────────────────────────────────────────────┐ ]
      else
        [ ├─────────┼───────────────────────────────┼───────────────────────────────────────────────────────┤ ];
      end;

      if( strlen( RequisiteValue ) <= MaxRequisiteLength )
        [ │  #####  │###############################│#######################################################│      
        ](  RequisiteNumber :c,
            RequisiteName :l,
            RequisiteValue :l );

        LineNumber = LineNumber + LinesForElement;
      else
        var tmpReqValArr:TArray = StrSplit2( RequisiteValue, MaxRequisiteLength );
        var arrItr = 0;
        while( arrItr < tmpReqValArr.size )
          if( arrItr == 0 )
            [ │  #####  │###############################│#######################################################│      
            ](  RequisiteNumber :c,
                RequisiteName :l,
                tmpReqValArr[ArrItr] :l );
            LineNumber = LineNumber + LinesForElement;
          else
            [ │         │                               │#######################################################│      
            ](  tmpReqValArr[ArrItr] :l );
            LineNumber = LineNumber + 1;
          end;
          arrItr = arrItr + 1;
        end;
      end;
    end;
  end;

  macro PrintTableElements()
    for( var req, MessageRequisites )
      PrintTableElement( req.RequisiteNumber, req.RequisiteName, req.RequisiteValue )
    end;
  end;
  
  macro PrintReport()
    PrintTableHead();
    PrintTableElements();
    PrintBankMarks();
    PrintTableBottom();
    PrintTableInfo();
  end;

  Construct();

end;

macro PrintForm( addrMes, MassCopy )
  SetBuff( wlmes, addrMes );
  
  FILE MsgTmpFile() txt;
  var MsgTmpFileName, OldName;
  
  // Перенаправляем вывод сообщения в файл, чтобы при многократной печати использовать данные
  //------------------------------------------ 
  MsgTmpFileName = GetTxtFileName("tmpmsprn");
  OldName = SetOutPut( MsgTmpFileName );

  if( not open(MsgTmpFile, MsgTmpFileName) )
    std.msg( String("Файл не открыт:", "|", MsgTmpFileName) );
    return FALSE;
  end;

  /*Печать отчета*/
  var ED107Report = TED107Report();
  ED107Report.PrintReport();

  // Перенаправляем вывод обратно
  //------------------------------------------
  SetOutPut( OldName, true ); 
  while( MassCopy != 0 )
    rewind( MsgTmpFile );
    while( next(MsgTmpFile) )
      println( MsgTmpFile.str );
    end;
    MassCopy = MassCopy - 1;
  end;
  close( MsgTmpFile ); 

  return true;                                                               

  OnError(er)
    ExeptionMessage(er);
    return false;
end;
