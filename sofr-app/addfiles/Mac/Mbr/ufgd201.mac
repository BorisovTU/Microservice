/*
  $Name:         ufgd201.mac
  $Module:       Межбанковские расчеты
  $Description:  Генерация сообщений о логической ошибке по сообщениям УФЭБС ED201
*/

import "ufgendoc.mac", "cb_sql.mac", rsd, oralib, likepy, "wluftool.mac";

macro GenDoc( addrMes )
  var xml:object = ActiveX( "MSXML.DOMDocument" );
  var Error, CtrlCode;
  var Строка;

  SetBuff( wlmes, addrMes );

  PrintLog( 2, "Генерация сообщения о логической ошибке по ED201" );

  if( not СчитатьПоле( XMLField, Строка ) )
    return FALSE;
  end;

  if ( not xml.loadXML(Строка) )
     println( string( "Неверный формат сообщения по форме ED201" ) );
     return false;
  end;

  CtrlCode = int( ReadAttribute(xml, "CtrlCode") );

  var RefTrn = EDNoDateAuthor();
  
  RefTRN.EDNo  = ReadOptinalAttribute(xml, "EDNo", "EDRefID");
  if ( RefTRN.EDNo!="" )
     RefTRN.EDDate = ToDate(ReadAttribute(xml, "EDDate", "EDRefID"));
     RefTRN.EDAuthor = ReadAttribute(xml, "EDAuthor", "EDRefID");
     return ОбработатьКакED201(RefTRN.EDDate, RefTRN.GetTrn(), CtrlCode);
  else
     return TRUE;
  end;

  OnError(er) /* Обработка ошибок времени выполонения */
    std.msg(String(er.Message, "|Модуль: ", er.Module, " Строка: ", er.Line));
    return FALSE;
end;

macro GenDocV2( addrMes )
   return GenDoc( addrMes );
end;
