/*
$Name: verificreport.mac
$Module: МБР
$Description: отчет верификации сообщений
*/

import oralib, likepy, PaymInter, WldInter, CTInter, globals, "bnk_dirfile.mac", "bnk_dttmfrmt.mac",
       "bnk_common.mac";

const VerificationManual : integer = 1;
const VerificationPayments : integer = 2;
       
macro PrintVerificationReport(SessionID:integer, XMLMessages:integer, VerificationType:integer)


  var query = "     SELECT wlsess.t_Number      SessionNumber, " +
              "            wlsess.t_MessageType MessageType, " +
              "            NVL(LISTAGG (verinfo.t_ErrorMessage, CHR(10) || '  ') " +
              "               WITHIN GROUP (ORDER BY verinfo.t_ErrorMessage), CHR(1)) ErrorMessage, " +
              "            (SELECT COUNT(*) FROM dwlmes_dbt wlmes WHERE wlmes.t_sessionID = :SessionID3) Messages, " + 
              "            CASE " +
              IfThenElse( VerificationType != VerificationManual,
              "              WHEN COUNT (CASE WHEN verinfo.t_PaymentID > 0 AND verinfo.t_MesAttrName IS NOT NULL " +
              "       AND verinfo.t_PayAttrName IS NOT NULL THEN 1 END )  > 0 " +
              "              THEN " +
              "                 2 ", "") +
              "              WHEN LENGTH ( " +
              "                         LISTAGG (verinfo.t_ErrorMessage) " +
              "                            WITHIN GROUP (ORDER BY verinfo.t_ErrorMessage) " +
              "                            ) > 0 " +
              "              THEN " +
              "                 1 " +
              "              ELSE "
              "                 0 " +
              "           END Attention " +
              "      FROM TABLE (WLD_EXPREP.GetVerificationInformation (:SessionID1)) verinfo" +
              "           LEFT OUTER JOIN dwlsess_dbt wlsess " +
              "            ON wlsess.t_SessionID = :SessionID2 " +
              "      GROUP BY wlsess.t_SessionID, wlsess.t_Number, wlsess.t_MessageType ";

              
  var rs:RsdRecordset = execSQLselect(query, makeArray(SQLParam("SessionID1", SessionID), 
                                                       SQLParam("SessionID2", SessionID),
                                                       SQLParam("SessionID3", SessionID)), true);
  
  if(rs and rs.MoveNext())

    [ Отчет по сообщениям сеанса #

      Операционист       ###### #
      Дата               #
      Время              #
      Сеанс N            #
      Тип сообщения      #
      Сообщений в сеансе ######
      ЭС в xml-сообщении ######]
    ( IfThenElse(VerificationType == VerificationPayments, "(верификация по платежам)", "(ручная верификация)"), 
      {oper}:l, 
      {Name_Oper}, 
      date():f, 
      time():f, 
      rs.value("SessionNumber"):l,
      rs.value("MessageType"):l,
      int(rs.value("Messages")):l,
      XMLMessages:l);

  println("");
  println("");

  var result:bool = true;
  var att = int(rs.value("Attention"));

  //Ошибки или расхождения реквизитов
  if( att != 0 )
    [ ВНИМАНИЕ! ];    

    if( rs.value("ErrorMessage") != "")
      println("  " + rs.value("ErrorMessage"));
    end;
       
    // Расхождения в реквизитах
    if( att == 2 )

      println("");
      println("");
      
      var diffQuery = 
                        " SELECT NVL(verinfo.t_EDNo, CHR(1))                             EDNo,          " +
                        "        NVL(verinfo.t_EDDate, CHR(1))                           EDDate,        " +
                        "        NVL(verinfo.t_EDAuthor, CHR(1)                          EDAuthor,      " +
                        "        verinfo.t_MesAttrName                                   MesAttrName,   " +
                        "        NVL(verinfo.t_MesAttrValue, CHR(1))                     MesAttrValue,  " +
                        "        verinfo.t_PayAttrName                                   PayAttrName,   " +
                        "        NVL(verinfo.t_PayAttrValue, CHR(1))                     PayAttrValue,  " +
                        "        pmrmprop.t_Number                                       \"Number\",    " +
                        "        pmrmprop.t_Date                                         \"Date\",      " +
                        "        pmpaym.t_BaseAmount                                     BaseAmount,    " +
                        "        NVL(verinfo.t_PaymentID, 0)                             PaymentID,     " +
                        "        LAG(NVL(verinfo.t_PaymentID, 0)) OVER(ORDER BY verinfo.t_PaymentID ) PreviousPaymentID " +              
                        " FROM TABLE (WLD_EXPREP.GetVerificationInformation (:SessionID)) verinfo               " +              
                        "      LEFT OUTER JOIN dpmpaym_dbt pmpaym                                       " +
                        "        ON pmpaym.t_PaymentID = verinfo.t_PaymentID                            " +
                        "      LEFT OUTER JOIN dpmrmprop_dbt pmrmprop                                   " +
                        "        ON pmpaym.t_PaymentID = pmrmprop.t_PaymentID                           " +
                        " WHERE NVL(verinfo.t_PaymentID, 0) <> 0  " +
                        "       AND verinfo.t_MesAttrName IS NOT NULL " +                        
                        "       AND verinfo.t_PayAttrName IS NOT NULL ";                        
                        
    var rsDiff:RsdRecordset = execSQLselect(diffQuery, makeArray(SQLParam("SessionID", SessionID)), true);
    
    result = rsDiff.MoveNext();

    
      while( result )      
        [ РАСХОЖДЕНИЯ В РЕКВИЗИТАХ ПЛАТЕЖЕЙ И СООБЩЕНИЙ
          ЭС EDNo  ######## EDDate ########## EDAuthor #
          Платеж № ######## ОТ     ########## на сумму ########## руб.]
        (
          rsDiff.value("EDNo"):r,
          rsDiff.value("EDDate"),
          rsDiff.value("EDAuthor"),
          rsDiff.value("Number"):r,
          string(rsDiff.value("Date")),
          rsDiff.value("BaseAmount"):f
        );
        
        [ ┌──────────────────────────────────────────────────┬─────────────────────────────────────────────────┐
          │                 Сообщение                        │                   Платеж                        │
          ├─────────────────────────┬────────────────────────┼────────────────────────┬────────────────────────┤
          │        Реквизит         │        Значение        │       Реквизит         │        Значение        │
          ├─────────────────────────┼────────────────────────┼────────────────────────┼────────────────────────┤
        ];
        
        while(result)
          [ │#########################│########################│########################│########################│
          ]
          (
            rsDiff.value("MesAttrName"),
            rsDiff.value("MesAttrValue"),
            rsDiff.value("PayAttrName"),
            rsDiff.value("PayAttrValue")
          );
      
        result = rsDiff.MoveNext();
        
        if((not result) or (rsDiff.value("PaymentID") != rsDiff.value("PreviousPaymentID")))
          [ └─────────────────────────┴────────────────────────┴────────────────────────┴────────────────────────┘
          ];
          break;
        end;
        
        end;
      end;   
    end;
    
  elif(VerificationType == VerificationPayments)
    [ Расхождений не обнаружено ];

  end;

  if(VerificationType == VerificationManual)
    var mQuery = 
                        " SELECT verinfo.t_PaymentID                                     PaymentID, " +
                        "        NVL(verinfo.t_EDNo, CHR(1))                             EDNo,          " +
                        "        NVL(verinfo.t_EDDate, CHR(1))                           EDDate,        " +
                        "        NVL(verinfo.t_EDAuthor, CHR(1))                         EDAuthor,       " +
                        "        NVL(verinfo.t_TRN, CHR(1))                              TRN, "
                        "        pmrmprop.t_Number                                       \"Number\",    " +
                        "        pmrmprop.t_Date                                         \"Date\",      " +
                        "        pmpaym.t_BaseAmount                                     BaseAmount    " +
                        " FROM TABLE (WLD_EXPREP.GetVerificationInformation (:SessionID)) verinfo      " +                                      
                        "      LEFT OUTER JOIN dpmpaym_dbt pmpaym                                       " +
                        "        ON pmpaym.t_PaymentID = verinfo.t_PaymentID                            " +
                        "      LEFT OUTER JOIN dpmrmprop_dbt pmrmprop                                   " +
                        "        ON pmpaym.t_PaymentID = pmrmprop.t_PaymentID                           " +
                        " WHERE ((verinfo.t_PaymentID <> 0 or " +
                        "       (verinfo.t_EDNo IS NOT NULL                                             " +
                        "        AND verinfo.t_EDDate  IS NOT NULL " +
                        "        AND verinfo.t_EDAuthor  IS NOT NULL )) " + 
                        "   AND ( verinfo.t_MesAttrName IS NULL " +                        
                        "        AND verinfo.t_PayAttrName IS NULL ) ) ";

    var rsM:RsdRecordset = execSQLselect(mQuery, makeArray(SQLParam("SessionID", SessionID)), true);


    while(rsM and rsM.MoveNext())

      println("");
      println("");

      if(rsM.value("TRN") == "")
      [   ЭС EDNo  ######## EDDate ########## EDAuthor # ]
        (
          rsM.value("EDNo"):r,
          rsM.value("EDDate"),
          rsM.value("EDAuthor")          
        );
      else
      [   Референс сообщения ########################################################################## ]
      ( rsM.value("TRN") );
      end;

      if(rsM.value("PaymentID") != 0)

        [   Платеж № ######## ОТ     ########## на сумму ########## руб.]
          (           
            rsM.value("Number"):r,
            string(rsM.value("Date")),
            rsM.value("BaseAmount"):f
          );

        print(GetPrintFormPayment(rsM.value("PaymentID")));      

      else        

        var TRN = IfThenElse( rsM.value("TRN") != "", rsM.value("TRN"), SubStr(rsM.value("EDDate"), 3, 2) 
                + SubStr(rsM.value("EDDate"), 6, 2) 
                + SubStr(rsM.value("EDDate"), 9, 2) 
                + rsM.value("EDAuthor")
                + rsM.value("EDNo") );

        print(GetPrintFormMessage(TRN));      
      end;
    end;
  end;
  
  end;
  
  return 0;

end;