/*
  $Name:         ufgd245.mac
  $Module:       МБР
  $Description:  Генерация информационного сообщения ED244
*/

import BankInter;
import "ufgendoc.mac", "xmlmestools.mac";

class TRefPackedEID
  var EDNo: integer,
      EDDate: date,
      EDAuthor: string;
  macro Construct()
    EDNo = 0;
    EDDate = date(0,0,0);
    EDAuthor = "";
  end;
  
  Construct();
end;

class TIMInfo
  var EDNo: integer,
      EDDate: date,
      EDAuthor: string,
      RefPackedEID: TArray;
  
  macro Construct()
    EDNo = 0;
    EDDate = date(0,0,0);
    EDAuthor = "";
    RefPackedEID = TArray();
  end;
  
  Construct();
end;  

class TIMGroupInfo
  var EDTypeNo: string,
      ReceiverTypeCode: integer,
      IMGroupQuantity: integer,
      IMInfo: TArray;
      
  macro Construct()
    EDTypeNo = "";
    ReceiverTypeCode = 0;
    IMGroupQuantity = 0;
    IMInfo = TArray();
  end;
  
  Construct();
end;

class TED245MessageFields
  var EDNo: integer,
      EDDate: date,
      EDAuthor: string,
      EDReceiver: string,
      IMQuantity: integer,
      IMGroupInfo: TArray;
      
  macro Construct()
    EDNo = 0;
    EDDate = date(0,0,0);
    EDAuthor = "";
    EDReceiver = "";
    IMQuantity = 0;
    IMGroupInfo = TArray();
  end;
  
  Construct();
end;

macro ReadED245MessageFields( ED245MessageFields:@TED245MessageFields )
  var fieldname = "", fieldvalue = "", blockname = "";
  while( СчитатьПоле(fieldname, fieldvalue, blockname) )
    if(blockname == "")
      if(fieldname == "EDNo")
        ED245MessageFields.EDNo = int(fieldvalue);
      elif(fieldname == "EDDate")
        ED245MessageFields.EDDate = ToDate( fieldvalue );
      elif(fieldname == "EDAuthor")
        ED245MessageFields.EDAuthor = fieldvalue;
      elif(fieldname == "EDReceiver")
        ED245MessageFields.EDReceiver = fieldvalue;
      elif(fieldname == "IMQuantity")
        ED245MessageFields.IMQuantity = int(fieldvalue);
      end;
    elif(blockname == "IMGroupInfo")
      if(fieldname == beginField)
        ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size] = TIMGroupInfo();
      elif(fieldname == "EDTypeNo")
        ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].EDTypeNo = fieldvalue;
      elif(fieldname == "ReceiverTypeCode")
        ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].ReceiverTypeCode = int(fieldvalue);
      elif(fieldname == "IMGroupQuantity")
        ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMGroupQuantity = int(fieldvalue);
      end;
    elif(blockname == "IMGroupInfo\\IMInfo")
      if(fieldname == beginField)
        ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo[
      ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo.size] = TIMInfo();
      elif(fieldname == "EDNo")
        ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo[
      ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo.size - 1].EDNo = int(fieldvalue);
      elif(fieldname == "EDDate")
        ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo[
      ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo.size - 1].EDDate = ToDate( fieldvalue );
      elif(fieldname == "EDAuthor")
        ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo[
      ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo.size - 1].EDAuthor = fieldvalue;
      end;
    elif(blockname == "IMGroupInfo\\IMInfo\\RefPackedEID")
      if(fieldname == beginField)
        ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo[
      ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo.size - 1].RefPackedEID[
      ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo[
      ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo.size - 1].RefPackedEID.size] = TRefPackedEID();
      elif(fieldname == "EDNo")
        ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo[
      ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo.size - 1].RefPackedEID[
      ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo[
      ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo.size - 1].RefPackedEID.size - 1].EDNo = int(fieldvalue);
      elif(fieldname == "EDDate")
        ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo[
      ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo.size - 1].RefPackedEID[
      ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo[
      ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo.size - 1].RefPackedEID.size - 1].EDDate = ToDate( fieldvalue );
      elif(fieldname == "EDAuthor")
        ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo[
      ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo.size - 1].RefPackedEID[
      ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo[
      ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo.size - 1].RefPackedEID.size - 1].EDNo = int(fieldvalue);
      elif(fieldname == "EDDate")
        ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo[
      ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo.size - 1].RefPackedEID[
      ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo[
      ED245MessageFields.IMGroupInfo[ED245MessageFields.IMGroupInfo.size - 1].IMInfo.size - 1].RefPackedEID.size - 1].EDAuthor = fieldvalue;
      end;
    end;
  end;      
end;

macro GenDoc( addrMes )
  SetBuff( wlmes, addrMes );
  
  PrintLog(2,"Генерация информационного сообщения ED244");

  ClearRecord(wlinfo);
  
  var ED245Mes = TED245MessageFields();
  
  ReadED245MessageFields(ED245Mes);
  
  wlinfo.Trn = wlmes.Trn;
  wlinfo.RelatedRef = wlmes.RelatedRef;
  wlinfo.Direct = "";
  var OriginatorID, OriginatorCodeKind, OriginatorCode, OriginatorName;
  
  FillPartyByUIS_PTCK_UIS(ED245Mes.EDAuthor, @OriginatorID, @OriginatorCodeKind, @OriginatorCode, @OriginatorName);
  
  wlinfo.OriginatorID = OriginatorID;
  wlinfo.OriginatorCodeKind = OriginatorCodeKind;
  wlinfo.OriginatorCode = OriginatorCode;
  wlinfo.OriginatorName = OriginatorName;
  
  wlinfo.RecipientID = GetDprtPartyID(wlmes.Department);
  
  var RecipientCodeKind = PTCK_UIS;
  var RecipientCode = "";
  var RecipientCodeOwner = 0;
  
  GetPartyCodeEx( wlinfo.RecipientID, RecipientCodeKind, @RecipientCode, @RecipientCodeOwner );
  
  if( strlen(RecipientCode) == 0 )
    RecipientCodeKind = PTCK_BIC;
    GetPartyCodeEx( wlinfo.RecipientID, RecipientCodeKind, @RecipientCode, @RecipientCodeOwner );
  end;
  
  wlinfo.RecipientCode = RecipientCode;
  wlinfo.RecipientCodeKind = RecipientCodeKind;
  
  wlinfo.RecipientName = Bnk_GetPartyName(wlinfo.RecipientID);
  
  wlinfo.OfficeCode = ED245Mes.EDReceiver;
  wlinfo.OfficeCodeKind = PTCK_UIS;
  if( wlinfo.OfficeCode != "" )
    wlinfo.OfficeID = GetCodeOwnerID(wlinfo.OfficeCodeKind, wlinfo.OfficeCode);
  end;
  
  var i = 0;
  var Narrative = "";
  
  if( (ED245Mes.IMGroupInfo.size != 0) and (ED245Mes.IMQuantity != 0) )
    Narrative = Narrative + "Количество ЭСИС в отчете: " + ED245Mes.IMQuantity + ". ";
    Narrative = Narrative + "Из них: ";
    while(i < ED245Mes.IMGroupInfo.size)
      Narrative = Narrative + ED245Mes.IMGroupInfo[i].EDTypeNo + " - " + ED245Mes.IMGroupInfo[i].IMGroupQuantity + IfThenElse( i == ED245Mes.IMGroupInfo.size - 1, ".", "; " );
      i = i + 1;
    end;
  else
    Narrative = Narrative + "Количество ЭСИС в отчете: " + ED245Mes.IMQuantity + ".";
  end;
  
  if( not ВставитьИнфСообщение( wlinfo, Narrative ) )
    std.msg( "Ошибка при генерации УО по сообщению ED245" );
    return FALSE;
  end;
  
  return TRUE;

  OnError(er) /* Обработка ошибок времени выполонения */
    std.msg(String(er.Message, "|Модуль: ", er.Module, " Строка: ", er.Line));
    return FALSE;
end;
