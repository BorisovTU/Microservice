/*
 $Name:        ofkgminp.mac
 $Module:      MBR
 $Description: Генерация сообщения по INFP
*/
/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 6.0                      */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/* Генерация сообщения по INFP                                              */
/*                                                                          */
/*  Имя файла: ofkgminp.mac                                                 */
/*  Создан:  17.12.12                                    Лазаренко М.       */
/****************************************************************************/

import "wlgenmes.mac", FIInter, OprInter, WldInter, PaymInter, "xmlmestools.mac",
       "bnk_ptlib.mac", "pmlib.mac", "fm_util.mac", "pm_tools.mac";

FILE pspaydem( "pspaydem.dbt" ) key 0;

private macro ЗаписатьПолеЛогОгр(name, value, len)
  if( len and (len > 0) and (strlen(value) > len) )
    value = substr(value, 1, len);
  end;
  ЗаписатьПолеЛог(name, value);
end;
   
// получить системную дату
macro GetSysDate():string
  var day, mon, year, str;

  DateSplit( date(), day, mon, year );
  if( day < 10 )
    day = "0"+string( day );
  else
    day = string( day );
  end;

  if ( mon < 10 )
    mon = "0"+string( mon );
  else
    mon = string( mon );
  end;
  str = SubStr( string(year), 3 ) + mon + day ;
  return str;
end;

// сформировать ID платежа
private macro FormPaymentID( BIC:string, OperNode:string, ObjKind:integer, ObjID:integer ):string

  var PaymentID:string = "",
      refer:string = "";
  
  PaymentID = "1" + BIC;
  if( StrLen(OperNode) > 6 )
    PaymentID = PaymentID + substr( OperNode, StrLen(OperNode) - 5 );
  else
    PaymentID = PaymentID + strLpad( OperNode, 6, "0" );
  end;
  GetGGPaymentRefer( 232, refer, ObjKind, ObjID );
  PaymentID = PaymentID + refer;
  
  return PaymentID;
end;

// формат даты ДДММГГГГ
private macro ДатаДДММГГГГ( Дата )
  if( Дата == date(0,0,0) )
    return "";
  end;
  var День, Месяц, Год;
  
  datesplit( Дата, День, Месяц, Год );
  if( День  < 10 )   День  = String( "0", день  );  end;
  if( Месяц < 10 )   Месяц = String( "0", месяц );  end;

  return String( Год, "-", Месяц, "-", День  );
end;

private macro GetFieldFromText( text:string, field:string ):string

  var temp:string = "";
  var symbnum:integer = 0;
  var textlen:integer = 0;

  symbnum = Index(text, field + ":");  
  temp = subStr( text, symbnum );
  textlen = Index( temp, "\n") - Index(temp, field + ":") - StrLen(field) - 1; 
  temp = substr( temp, Index(temp, field + ":") + StrLen(field) + 1, textlen );
  
  return  Trim( temp );

end;

// найти код субъекта по ID и виду кода
private macro FindPartCode( PartyID:integer, CodeKind:integer ):string

  var query = "select part.t_Code part" +
              "  from dpartcode_dbt part " +
              " where part.t_PartyID = " + PartyID +
              "   and part.t_CodeKind = " + CodeKind;
  var rs:RsdRecordset = execSQLselect(query);
  if (rs and rs.moveNext() )
    return rs.value(0);
  end;
end;

private macro GetShifrOperByCoverPaymID( CoverPaymID )
  var ShifrOper = "";
  var query = "select t_ShifrOper" +
              "  from dpmrmprop_dbt " +
              " where t_PaymentID = " + CoverPaymID;
  var rs : RsdRecordset = execSQLselect( query );
  if( rs and rs.moveNext() )
    ShifrOper = rs.value( "t_ShifrOper" );
  end;
  return ShifrOper;
end;
          
// Сменить референс сообщения в примечании платежа при регенерации
private macro ChangeGGMesRefNote( PaymentID, NewReference )
  var RefNote = readNoteForObject( OBJTYPE_PAYMENT, PaymentID, PM_NOTEKIND_PAYM_GGMESREFER );
  RefNote = ChangeStrAfterLastSpace( RefNote, NewReference );
  addNoteForObject( OBJTYPE_PAYMENT, PaymentID, PM_NOTEKIND_PAYM_GGMESREFER, RefNote );
end;
        
macro GenMes( addrMes, addrPaym, addrOldMes )
  record OldMes(wlmes);
  record Pmpaym(pmpaym);
  record bdtransf("bdtransf.dbt");

  SetBuff( wlmes, addrMes );
  SetBuff( OldMes, addrOldMes );
  var isPayment = false;
  if( WlGGisPayment() == true )
  SetBuff( pmpaym, addrPaym );
    isPayment = true;
  else
  SetBuff( bdtransf, addrPaym );
    isPayment = false;
  end;
  var BIK:string = "";
  var IsRecreate:bool = GetKindActionGG()==4; //Перегенерация?
  var note = "";

  PrintLog(2,"Генерация сообщения по INFP");

  var text:string = "",
      tmpstr:string = "";  

  var pmprop_debet = Tbfile ("pmprop.dbt");
  ClearRecord( pmprop_debet.rec );
  pmprop_debet.rec.PaymentID = pmpaym.PaymentID;
  pmprop_debet.rec.DebetCredit = 0;
  pmprop_debet.getEQ ();
  
  var pmprop_credit = Tbfile ("pmprop.dbt");
  ClearRecord( pmprop_credit.rec );
  pmprop_credit.rec.PaymentID = pmpaym.PaymentID;
  pmprop_credit.rec.DebetCredit = 1;
  pmprop_credit.getEQ ();
  
  var pmrmprop = Tbfile ("pmrmprop.dbt");
  ClearRecord( pmrmprop.rec );
  pmrmprop.rec.PaymentID = pmpaym.PaymentID;
  pmrmprop.getEQ ();

  var wlmes_xml:object = ActiveX( "MSXML.DOMDocument" );

  // UnifoTransferMsg -------------------------------------------
  УстановитьКонтекстБлокаЛог( "UnifoTransferMsg" );
  ЗаписатьПолеЛог( beginField, "n1:UnifoTransferMsg" );
  
   // Message -------------------------------------------
   УстановитьКонтекстБлокаЛог( "Message" );
   ЗаписатьПолеЛог( beginField, "smev:Message" );  

    // Sender -------------------------------------------
    УстановитьКонтекстБлокаЛог( "Sender" );
    ЗаписатьПолеЛог( beginField, "smev:Sender" );  

     if( wlmes.InsideAbonentCode != "" )
       ЗаписатьПолеЛог( "Code", wlmes.InsideAbonentCode );
     else 
       WlGGSetRepError( "Для отправителя сообщения БИК" + FindPartCode( pmpaym.PayerBankID, 3 ) + 
                        " не указан код информационной системы в СМЭВ. Задайте код вида ""Код ИС в СМЭВ"" в справочнике субъектов и повторите выгрузку сообщений" );
       return false;
     end;
     ЗаписатьПолеЛог( "Name", Bnk_GetPartyName( wlmes.InsideAbonentID ) );
  
    ЗаписатьПолеЛог( endField, "smev:Sender" ) ;
    УстановитьКонтекстБлокаЛог( ".." );
    // Sender -------------------------------------------

    // Recipient -------------------------------------------
    УстановитьКонтекстБлокаЛог( "Recipient" );
    ЗаписатьПолеЛог( beginField, "smev:Recipient" );  

     if( wlmes.OutsideAbonentCode != "" )
       ЗаписатьПолеЛог( "Code", wlmes.OutsideAbonentCode );
     else
       WlGGSetRepError( "Для получателя сообщения не указан код информационной системы в СМЭВ. Задайте код получателя и повторите выгрузку сообщений" );
       return false;
     end;
     
    if( IsRecreate ) // перегенерация
      tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "Name", "Recipient" );
    elif( GetKindActionGG() != 0 )
      tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "Name", "Recipient" );
    else
      tmpstr = GetRecipientName( wlmes.Department );
    end;
    ЗаписатьПолеЛог( "Name", tmpstr );

    ЗаписатьПолеЛог( endField, "smev:Recipient" ) ;
    УстановитьКонтекстБлокаЛог( ".." );
    // Recipient -------------------------------------------

    if( IsRecreate ) // перегенерация
      tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "TypeCode" );
    elif( GetKindActionGG() != 0 )
      tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "TypeCode" );
    else
    tmpstr = GetTypeCode( wlmes.Department );
    end;
    ЗаписатьПолеЛог( "TypeCode", tmpstr );

    if( IsRecreate ) // перегенерация
      tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "Status" );
    elif( GetKindActionGG() != 0 )
      tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "Status" );
    else
    tmpstr = GetStatus( wlmes.Department );
    end;
    ЗаписатьПолеЛог( "Status", tmpstr );
    ЗаписатьПолеЛог( "Date", " " );

    if( IsRecreate ) // перегенерация
      tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "ExchangeType" );
    elif( GetKindActionGG() != 0 )
      tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "ExchangeType" );
    else
    tmpstr = GetExchangeType( wlmes.Department );
    end;
    ЗаписатьПолеЛог( "ExchangeType", tmpstr );

   ЗаписатьПолеЛог( endField, "smev:Message" ) ;
   УстановитьКонтекстБлокаЛог( ".." );
   // Message -------------------------------------------

   // MessageData -------------------------------------------
   УстановитьКонтекстБлокаЛог( "MessageData" );
   ЗаписатьПолеЛог( beginField, "smev:MessageData" );
   
    // AppData -------------------------------------------
    УстановитьКонтекстБлокаЛог( "AppData" );
    ЗаписатьПолеЛог( beginField, "smev:AppData" );

     // ImportData -------------------------------------------
     УстановитьКонтекстБлокаЛог( "ImportData" );
     ЗаписатьПолеЛог( beginField, "unifo:ImportData" );

      // ImportRequest -------------------------------------------
      УстановитьКонтекстБлокаЛог( "ImportRequest" );
      ЗаписатьПолеЛог( beginField, "pirq:ImportRequest" );  

       // PostBlock -------------------------------------------
       УстановитьКонтекстБлокаЛог( "PostBlock" );
       ЗаписатьПолеЛог( beginField, "PostBlock" );
  
        if( IsRecreate ) // перегенерация
          tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "ID" );
        elif( GetKindActionGG() != 0 ) // перегенерация
          tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "ID" );
        else
          tmpstr = execStoredFunc( "sys_guid", V_STRING );  
        end;
        ЗаписатьПолеЛог( "ID", tmpstr ); 
        ЗаписатьПолеЛог( "TimeStamp", " " );

        if( IsRecreate ) // перегенерация
          tmpstr = WlMes_GetFieldValue( OldMes.MesID, "SenderIdentifier" );
        elif( GetKindActionGG() != 0 ) // перегенерация
         tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "SenderIdentifier" ); 
        else
          tmpstr = GetSenderIdentifier( wlmes.Department );
        end;
        ЗаписатьПолеЛог( "SenderIdentifier", tmpstr );

       ЗаписатьПолеЛог( endField, "PostBlock" ) ;
       УстановитьКонтекстБлокаЛог( ".." );
       // PostBlock -------------------------------------------

        // FinalPayment -------------------------------------------
        УстановитьКонтекстБлокаЛог( "FinalPayment" );
        ЗаписатьПолеЛог( beginField, "FinalPayment" );
       
         if( isPayment )  
           if( pmrmprop.rec.UIN != "" )
             ЗаписатьПолеЛог( "SupplierBillID", pmrmprop.rec.UIN );  
           else
             ЗаписатьПолеЛог( "SupplierBillID", "0" );
           end;
         else
           if( bdtransf.UIN )
             ЗаписатьПолеЛог( "SupplierBillID", bdtransf.UIN );
           else    
             ЗаписатьПолеЛог( "SupplierBillID", "0" );
           end;
         end;

         if( isPayment )
           if( StrLen( pmrmprop.rec.Ground ) == 0 )
             ЗаписатьПолеЛог( "Narrative", "0" );
           elif( StrLen( pmrmprop.rec.Ground ) <= 255 )
             ЗаписатьПолеЛог( "Narrative", pmrmprop.rec.Ground );
           else
             ЗаписатьПолеЛог( "Narrative", SubStr(pmrmprop.rec.Ground, 1, 255 ) );
           end;
         else
           if( StrLen( bdtransf.Ground ) == 0 )
             ЗаписатьПолеЛог( "Narrative", "0" );
           else
             ЗаписатьПолеЛог( "Narrative", bdtransf.Ground );
           end;
         end;

         if( GetKindActionGG() == 2 )
           ЗаписатьПолеЛог( "Amount", "0" );
         elif( isPayment ) 
           ЗаписатьПолеЛог( "Amount", string((pmpaym.Amount * 100):0:0) );    
         else
           ЗаписатьПолеЛог( "Amount", string((bdtransf.Amount * 100):0:0) );    
         end;

         if( isPayment )
           note = readNoteForObject(OBJTYPE_PAYMENT, makeObjectID(OBJTYPE_PAYMENT, NULL, pmpaym), PM_NOTEKIND_PAYM_ACCEPTUATEDATE );
           if( note != "" )
             ЗаписатьПолеЛог( "PaymentDate",  note );
           else
             ЗаписатьПолеЛог( "PaymentDate", ДатаДДММГГГГ( pmpaym.ValueDate ) );
           end;
         else
           ЗаписатьПолеЛог( "PaymentDate", ДатаДДММГГГГ( bdtransf.Date ) );
         end;

         // BudgetIndex -------------------------------------------
         УстановитьКонтекстБлокаЛог( "BudgetIndex" );
         ЗаписатьПолеЛог( beginField, "BudgetIndex" );

          if( isPayment )
            tmpstr = pmrmprop.rec.TaxAuthorState;
          else 
            tmpstr = bdtransf.TaxAuthorState; 
          end;
          if( StrLen( tmpstr ) > 0 ) 
            ЗаписатьПолеЛог( "Status", tmpstr ); 
          else
            ЗаписатьПолеЛог( "Status", "0" );
          end;
          
          if( isPayment )
            if( pmrmprop.rec.TaxPmType != "" )
              ЗаписатьПолеЛог( "PaymentType", pmrmprop.rec.TaxPmType );
            else
              ЗаписатьПолеЛог( "PaymentType", "0" );
            end;
          else
            if( bdtransf.TaxPmType != "" )
              ЗаписатьПолеЛог( "PaymentType", bdtransf.TaxPmType );
            else
              ЗаписатьПолеЛог( "PaymentType", "0" );
            end;
          end;

          if( isPayment )
            tmpstr = pmrmprop.rec.TaxPmGround; 
          else
            tmpstr = bdtransf.TaxPmGround; 
          end;
          if( StrLen( tmpstr ) > 0 ) 
            ЗаписатьПолеЛог( "Purpose", tmpstr ); 
          else
            ЗаписатьПолеЛог( "Purpose", "0" );
          end;
         
          if( isPayment )
            if( pmrmprop.rec.TaxPmPeriod != "" )
              ЗаписатьПолеЛог( "TaxPeriod", pmrmprop.rec.TaxPmPeriod );
             else 
               ЗаписатьПолеЛог( "TaxPeriod", "0" );
             end;
          else 
            if( bdtransf.TaxPmPeriod != "" )
              ЗаписатьПолеЛог( "TaxPeriod", bdtransf.TaxPmPeriod );
            else 
              ЗаписатьПолеЛог( "TaxPeriod", "0" );
            end;
          end;

          if( isPayment )
            if( pmrmprop.rec.TaxPmNumber != "" ) 
              ЗаписатьПолеЛог( "TaxDocNumber", pmrmprop.rec.TaxPmNumber );
            else 
              ЗаписатьПолеЛог( "TaxDocNumber", "0" );
            end;
          else
            if( bdtransf.TaxPmNumber != "" ) 
              ЗаписатьПолеЛог( "TaxDocNumber", bdtransf.TaxPmNumber );
            else 
              ЗаписатьПолеЛог( "TaxDocNumber", "0" );
            end;
          end;
          
          if( isPayment )
            if( pmrmprop.rec.TaxPmDate != date( 0, 0, 0 ) ) 
              ЗаписатьПолеЛог( "TaxDocDate", pmrmprop.rec.TaxPmDate );
            else
             ЗаписатьПолеЛог( "TaxDocDate", "0" ); 
            end;
          else
            if( bdtransf.TaxPmDate != date( 0, 0, 0 ) ) 
              ЗаписатьПолеЛог( "TaxDocDate", bdtransf.TaxPmDate );
            else
             ЗаписатьПолеЛог( "TaxDocDate", "0" ); 
            end;
          end;

         ЗаписатьПолеЛог( endField, "BudgetIndex" ) ;
         УстановитьКонтекстБлокаЛог( ".." );
         // BudgetIndex ------------------------------------------- 

         // PaymentIdentificatio -------------------------------------------
         УстановитьКонтекстБлокаЛог( "PaymentIdentificatio" );
         ЗаписатьПолеЛог( beginField, "PaymentIdentificationData" );

          // Bank -------------------------------------------
          УстановитьКонтекстБлокаЛог( "Bank" );
          ЗаписатьПолеЛог( beginField, "Bank" );

           if( isPayment )
             ЗаписатьПолеЛог( "Name", pmrmprop.rec.PayerBankName );
             ЗаписатьПолеЛог( "CorrespondentBankAcc", pmrmprop.rec.PayerCorrAccNostro );
      
             if( pmprop_debet.rec.CodeKind == 3 )
               BIK = pmprop_debet.rec.Bankcode;
             else
               BIK = FindPartCode( pmpaym.PayerBankID, 3 );
             end;

             ЗаписатьПолеЛог( "BIK", BIK  );
           else
             var query1 = "select party.t_Name, bnkdprt.t_CorAcc, party.t_PartyID "   +
                 "  from dparty_dbt party, ddp_dep_dbt  dep, dbankdprt_dbt bnkdprt " +
                 " where party.t_PartyID = dep.t_PartyID "   +
                 "   and bnkdprt.t_PartyID = dep.t_PartyID " +
                 "   and dep.t_Code = " + bdtransf.Department;

             var rs_bank:RsdRecordset = execSQLselect(query1);
             if( rs_bank.moveNext() )

               ЗаписатьПолеЛог( "Name", rs_bank.Value(0) );
               ЗаписатьПолеЛог( "CorrespondentBankAcc", rs_bank.Value(1) );
                  
               BIK = FindPartCode( rs_bank.Value(2), 3 );
               ЗаписатьПолеЛог( "BIK", BIK  );
             end;
           end;

           var query = "select * " +
                 "  from dadress_dbt adr "        +
                 " where adr.t_PartyID = "    + pmpaym.PayerBankID +
                 "   and adr.t_Adress <> CHR(1) "  +                          
                 " order by adr.t_Type ";
           var rs_adress:RsdRecordset = execSQLselect(query);
           if( rs_adress.moveNext() )
    
             // Adress -------------------------------------------
             УстановитьКонтекстБлокаЛог( "Address" );
             ЗаписатьПолеЛог( beginField, "Address" );

             ЗаписатьПолеЛог( "kind", string(rs_adress.value( "t_Type" )) );
              ЗаписатьПолеЛог( "View", rs_adress.value( "t_Adress" ) );
        
             ЗаписатьПолеЛог( endField, "Address" ) ;
             УстановитьКонтекстБлокаЛог( ".." );
             // Adress -------------------------------------------

           end; // if Adress
          ЗаписатьПолеЛог( endField, "Bank" ) ;
          УстановитьКонтекстБлокаЛог( ".." );
          // Bank -------------------------------------------

         if( IsRecreate ) // перегенерация
          tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "SystemIdentifier" );
         elif( GetKindActionGG() != 0 ) // перегенерация
           tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "SystemIdentifier" ); 
         else
           var dep = Tbfile ("dp_dep.dbt");
           ClearRecord( dep.rec );
           if( isPayment )
             dep.rec.Code = pmpaym.OperNode;
           else
             dep.rec.Code = bdtransf.Department; 
           end;
           dep.getEQ ();

           if( isPayment )
             tmpstr = FormPaymentID( BIK, dep.rec.Name, OBJTYPE_PAYMENT, pmpaym.PaymentID );
           else
             tmpstr = FormPaymentID( BIK, dep.rec.Name, OBJTYPE_BDTRANSF, bdtransf.BdTransfID );
           end;
         end;
         ЗаписатьПолеЛог( "SystemIdentifier", tmpstr );

         ЗаписатьПолеЛог( endField, "PaymentIdentificationData" ) ;
         УстановитьКонтекстБлокаЛог( ".." );
         // PaymentIdentificatio -------------------------------------------

         if( isPayment )
           tmpstr = PayerIDForm( pmpaym.Payer, pmrmprop.rec.TaxPmNumber );
         else
           tmpstr = bdtransf.TaxPersonRef;
         end;
         if( tmpstr != "" )
           ЗаписатьПолеЛог( "PayerIdentifier", tmpstr );
         else
           ЗаписатьПолеЛог( "PayerIdentifier", "0" );
         end;
         
         if( isPayment )
           if( StrLen( pmpaym.PayerAccount ) > 0 )
             ЗаписатьПолеЛог( "PayerPA", pmpaym.PayerAccount );
           end;
         else
           if( StrLen( bdtransf.PayerAccount ) > 0 )
             ЗаписатьПолеЛог( "PayerPA", bdtransf.PayerAccount );
           end;
         end;
         // PayeeBankAcc -------------------------------------------
         УстановитьКонтекстБлокаЛог( "PayeeBankAcc" );
         ЗаписатьПолеЛог( beginField, "PayeeBankAcc" );

          if( isPayment )
            if( pmprop_credit.rec.CodeKind == 3 )
              ЗаписатьПолеЛог( "BIK", pmprop_credit.rec.BankCode );
            else
              tmpstr = FindPartCode( pmpaym.ReceiverBankID, 3 );
              ЗаписатьПолеЛог( "BIK", tmpstr );
            end;
          else
            ЗаписатьПолеЛог( "BIK", bdtransf.ReceiverBankCode );
          end;

          if( isPayment ) 
            ЗаписатьПолеЛог( "AccountNumber", pmpaym.ReceiverAccount );
          else
            ЗаписатьПолеЛог( "AccountNumber", bdtransf.ReceiverAccount );
          end;

         ЗаписатьПолеЛог( endField, "PayeeBankAcc" ) ;
         УстановитьКонтекстБлокаЛог( ".." );
         // PayeeBankAcc -------------------------------------------

         ЗаписатьПолеЛог( "Version", "1.15" );

         if( IsRecreate ) // перегенерация
           tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "ChangeStatus" );
           ЗаписатьПолеЛог( "ChangeStatus", tmpstr );
         elif( GetKindActionGG() != 0 ) // перегенерация
           ЗаписатьПолеЛог( "ChangeStatus", "2" );
         else
           ЗаписатьПолеЛог( "ChangeStatus", "1" );
         end;

         if( pmrmprop.rec.ReceiverINN != "" )
           if( isPayment )
             tmpstr = RemoveKPP( pmrmprop.rec.ReceiverINN );
           else
             tmpstr = RemoveKPP( bdtransf.ReceiverINN );
           end;
           if( tmpstr != "" )
             ЗаписатьПолеЛог( "payeeINN", tmpstr );
           else
             ЗаписатьПолеЛог( "payeeINN", "0000000000" );
           end;
           if( isPayment )
             tmpstr = RemoveINN( pmrmprop.rec.ReceiverINN );
           else
             tmpstr = RemoveINN( bdtransf.ReceiverINN );
           end;
           if( tmpstr != "" )
             ЗаписатьПолеЛог( "payeeKPP", tmpstr );
           else 
             ЗаписатьПолеЛог( "payeeKPP", "000000000" );
           end;
         else 
           ЗаписатьПолеЛог( "payeeINN", "0000000000" );
           ЗаписатьПолеЛог( "payeeKPP", "000000000" );
         end;
        
         if( isPayment )
           if( StrLen( pmrmprop.rec.BTTTICode ) > 0 )
             ЗаписатьПолеЛог( "KBK", pmrmprop.rec.BTTTICode );
           else
             ЗаписатьПолеЛог( "KBK", " " );
           end;
           if( StrLen( pmrmprop.rec.OKATOCode ) > 0 )
             ЗаписатьПолеЛог( "OKATO", strRpad( pmrmprop.rec.OKATOCode, 11, "-" ) );
           else
             ЗаписатьПолеЛог( "OKATO", " " );
           end;
         else
           if( StrLen( bdtransf.BTTTICode ) > 0 )
             ЗаписатьПолеЛог( "KBK", bdtransf.BTTTICode );
           else
             ЗаписатьПолеЛог( "KBK", " " );
           end;
           if( StrLen( bdtransf.OKATOCode ) > 0 )
             ЗаписатьПолеЛог( "OKATO", strRpad( bdtransf.OKATOCode, 11, "-" ) );
           else
             ЗаписатьПолеЛог( "OKATO", " " );
           end;
         end;
        ЗаписатьПолеЛог( endField, "FinalPayment" ) ;
        УстановитьКонтекстБлокаЛог( ".." );
        // FinalPayment -------------------------------------------

      ЗаписатьПолеЛог( endField, "pirq:ImportRequest" ) ;
      УстановитьКонтекстБлокаЛог( ".." );
      // ImportRequest -------------------------------------------

     ЗаписатьПолеЛог( endField, "unifo:ImportData" ) ;
     УстановитьКонтекстБлокаЛог( ".." );
     // ImportData -------------------------------------------

    ЗаписатьПолеЛог( endField, "smev:AppData" ) ;
    УстановитьКонтекстБлокаЛог( ".." );
    // AppData -------------------------------------------

   ЗаписатьПолеЛог( endField, "smev:MessageData" ) ;
   УстановитьКонтекстБлокаЛог( ".." );
   // MessageData -------------------------------------------

  ЗаписатьПолеЛог( endField, "n1:UnifoTransferMsg" ) ;
  УстановитьКонтекстБлокаЛог( ".." );
  // UnifoTransferMsg -------------------------------------------
              
  if( IsRecreate and isPayment )
    var PaymID = makeObjectID( OBJTYPE_PAYMENT, NULL, pmpaym );
    ChangeGGMesRefNote( PaymID, wlmes.Trn )
  end;
           
  return TRUE; /* Успешное завершение */
end;

// INFP 1.15.1              

private macro GetAccountType( ReceiverAccount:string ):string
  
  var query = "select acc.t_Type_Account " +
              "  from daccount_dbt acc " +
              " where acc.t_Account = '" + ReceiverAccount + "'";
  var rs:RsdRecordset = execSQLselect( query );
  if( rs and rs.moveNext() )
    if( ( Index(rs.value(0),"Ч") ) or ( Index(rs.value(0),"Х") ) )
      return "1";
    elif( ( Index(rs.value(0),"W") )  and ( (not Index(rs.value(0),"Ч")) 
                                        and (not Index(rs.value(0),"Х")) 
                                        and (not Index(rs.value(0),"К")) ) )
      return "2";
    elif( ( Index(rs.value(0),"К") )  and ( (not Index(rs.value(0),"Ч")) 
                                        and (not Index(rs.value(0),"Х")) ) )
      return "3";
    end;
  end;
  return "";
end;

macro GenMes1_15_1( addrMes, addrPaym )
  record OldMes(wlmes);
  ClearRecord(OldMes);
  record Pmpaym(pmpaym);
  record bdtransf("bdtransf.dbt");

  SetBuff( wlmes, addrMes );
  var isPayment = false;
  if( WlGGisPayment() == true )
  SetBuff( pmpaym, addrPaym );
    isPayment = true;
  else
  SetBuff( bdtransf, addrPaym );
    isPayment = false;
  end;
  var BIK:string = "";
  var note = "";
  var IsRecreate:bool = GetKindActionGG()==4; //Перегенерация?

  PrintLog(2,"Генерация сообщения по INFP1.15.1");

  var text:string = "",
      tmpstr:string = "";  

  var pmprop_debet = Tbfile ("pmprop.dbt");
  ClearRecord( pmprop_debet.rec );
  pmprop_debet.rec.PaymentID = pmpaym.PaymentID;
  pmprop_debet.rec.DebetCredit = 0;
  pmprop_debet.getEQ ();
  
  var pmprop_credit = Tbfile ("pmprop.dbt");
  ClearRecord( pmprop_credit.rec );
  pmprop_credit.rec.PaymentID = pmpaym.PaymentID;
  pmprop_credit.rec.DebetCredit = 1;
  pmprop_credit.getEQ ();
  
  var pmrmprop = Tbfile ("pmrmprop.dbt");
  ClearRecord( pmrmprop.rec );
  pmrmprop.rec.PaymentID = pmpaym.PaymentID;
  pmrmprop.getEQ ();

  var wlmes_xml:object = ActiveX( "MSXML.DOMDocument" );

  // UnifoTransferMsg -------------------------------------------
  УстановитьКонтекстБлокаЛог( "UnifoTransferMsg" );
  ЗаписатьПолеЛог( beginField, "n1:UnifoTransferMsg" );
  
   // Message -------------------------------------------
   УстановитьКонтекстБлокаЛог( "Message" );
   ЗаписатьПолеЛог( beginField, "smev:Message" );  

    // Sender -------------------------------------------
    УстановитьКонтекстБлокаЛог( "Sender" );
    ЗаписатьПолеЛог( beginField, "smev:Sender" );  

     if( wlmes.InsideAbonentCode != "" )
       ЗаписатьПолеЛог( "Code", wlmes.InsideAbonentCode );
     else 
       ЗаписатьПолеЛог( "Code", " " );
     end;
     ЗаписатьПолеЛог( "Name", Bnk_GetPartyName( wlmes.InsideAbonentID ) );
  
    ЗаписатьПолеЛог( endField, "smev:Sender" ) ;
    УстановитьКонтекстБлокаЛог( ".." );
    // Sender -------------------------------------------

    // Recipient -------------------------------------------
    УстановитьКонтекстБлокаЛог( "Recipient" );
    ЗаписатьПолеЛог( beginField, "smev:Recipient" );  

     if( wlmes.OutsideAbonentCode != "" )
       ЗаписатьПолеЛог( "Code", wlmes.OutsideAbonentCode );
     else
       WlGGSetRepError( "Для получателя сообщения не указан код информационной системы в СМЭВ. Задайте код получателя и повторите выгрузку сообщений" );
       return false;
     end;
     
    if( IsRecreate ) // перегенерация
      tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "Name", "Recipient" );
    elif( GetKindActionGG() != 0 )
      tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "Name", "Recipient" );
    else
      tmpstr = GetRecipientName( wlmes.Department );
    end;
      ЗаписатьПолеЛог( "Name", tmpstr );

    ЗаписатьПолеЛог( endField, "smev:Recipient" ) ;
    УстановитьКонтекстБлокаЛог( ".." );
    // Recipient -------------------------------------------

    if( IsRecreate ) // перегенерация
      tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "TypeCode" );
    elif( GetKindActionGG() != 0 )
      tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "TypeCode" );
    else
      tmpstr = GetTypeCode( wlmes.Department );
    end;
    ЗаписатьПолеЛог( "TypeCode", tmpstr );

    if( IsRecreate ) // перегенерация
      tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "Status" );
    elif( GetKindActionGG() != 0 )
      tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "Status" );
    else
      tmpstr = GetStatus( wlmes.Department );
    end;
    ЗаписатьПолеЛог( "Status", tmpstr );
    ЗаписатьПолеЛог( "Date", " " );

    if( IsRecreate ) // перегенерация
      tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "ExchangeType" );
    elif( GetKindActionGG() != 0 )
      tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "ExchangeType" );
    else
      tmpstr = GetExchangeType( wlmes.Department );
    end;
    ЗаписатьПолеЛог( "ExchangeType", tmpstr );

   ЗаписатьПолеЛог( endField, "smev:Message" ) ;
   УстановитьКонтекстБлокаЛог( ".." );
   // Message -------------------------------------------

   // MessageData -------------------------------------------
   УстановитьКонтекстБлокаЛог( "MessageData" );
   ЗаписатьПолеЛог( beginField, "smev:MessageData" );
   
    // AppData -------------------------------------------
    УстановитьКонтекстБлокаЛог( "AppData" );
    ЗаписатьПолеЛог( beginField, "smev:AppData" );

     // ImportData -------------------------------------------
     УстановитьКонтекстБлокаЛог( "ImportData" );
     ЗаписатьПолеЛог( beginField, "unifo:ImportData" );

      // ImportRequest -------------------------------------------
      УстановитьКонтекстБлокаЛог( "ImportRequest" );
      ЗаписатьПолеЛог( beginField, "pirq:ImportRequest" );  

       // PostBlock -------------------------------------------
       УстановитьКонтекстБлокаЛог( "PostBlock" );
       ЗаписатьПолеЛог( beginField, "PostBlock" );
  
       if( IsRecreate ) // перегенерация
         tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "ID" );
       elif( GetKindActionGG() != 0 ) // перегенерация
         tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "ID" );
       else
         tmpstr = execStoredFunc( "sys_guid", V_STRING ); 
       end;
       ЗаписатьПолеЛог( "ID", tmpstr );
       ЗаписатьПолеЛог( "TimeStamp", " " );

       if( IsRecreate ) // перегенерация
         tmpstr = WlMes_GetFieldValue( OldMes.MesID, "SenderIdentifier" );
       elif( GetKindActionGG() != 0 ) // перегенерация
         tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "SenderIdentifier" ); 
       else
         tmpstr = GetSenderIdentifier( wlmes.Department );
       end;
       ЗаписатьПолеЛог( "SenderIdentifier", tmpstr );

       ЗаписатьПолеЛог( endField, "PostBlock" ) ;
       УстановитьКонтекстБлокаЛог( ".." );
       // PostBlock -------------------------------------------

        // FinalPayment -------------------------------------------
        УстановитьКонтекстБлокаЛог( "FinalPayment" );
        ЗаписатьПолеЛог( beginField, "FinalPayment" );
       
         if( isPayment )
           if( pmrmprop.rec.UIN != "" )
             ЗаписатьПолеЛог( "SupplierBillID", pmrmprop.rec.UIN );  
           else
             ЗаписатьПолеЛог( "SupplierBillID", "0" );
           end;
         else
           if( bdtransf.UIN )
             ЗаписатьПолеЛог( "SupplierBillID", bdtransf.UIN );
           else    
             ЗаписатьПолеЛог( "SupplierBillID", "0" );
           end;
         end;

         if( isPayment )
           if( StrLen( pmrmprop.rec.Ground ) == 0 )
             ЗаписатьПолеЛог( "Narrative", "0" );
           elif( StrLen( pmrmprop.rec.Ground ) <= 255 )
             ЗаписатьПолеЛог( "Narrative", pmrmprop.rec.Ground );
           else
             ЗаписатьПолеЛог( "Narrative", SubStr(pmrmprop.rec.Ground, 1, 255 ) );
           end;
         else
           if( StrLen( bdtransf.Ground ) == 0 )
             ЗаписатьПолеЛог( "Narrative", "0" );
           else
             ЗаписатьПолеЛог( "Narrative", bdtransf.Ground );
           end;
         end;

         if( GetKindActionGG() == 2 )
           ЗаписатьПолеЛог( "Amount", "0" );
         elif( isPayment ) 
           ЗаписатьПолеЛог( "Amount", string((pmpaym.Amount * 100):0:0));    
         else
           ЗаписатьПолеЛог( "Amount", string((bdtransf.Amount * 100):0:0));    
         end;

         if( isPayment )
           note = readNoteForObject(OBJTYPE_PAYMENT, makeObjectID(OBJTYPE_PAYMENT, NULL, pmpaym), PM_NOTEKIND_PAYM_ACCEPTUATEDATE );
           if( note != "" )
             ЗаписатьПолеЛог( "PaymentDate", note );  
           else
             ЗаписатьПолеЛог( "PaymentDate", ДатаДДММГГГГ( pmpaym.ValueDate ) );
           end;
         else
           ЗаписатьПолеЛог( "PaymentDate", ДатаДДММГГГГ( bdtransf.Date ) );
         end;

         // BudgetIndex -------------------------------------------
         УстановитьКонтекстБлокаЛог( "BudgetIndex" );
         ЗаписатьПолеЛог( beginField, "BudgetIndex" );

          if( isPayment )
            tmpstr = pmrmprop.rec.TaxAuthorState;
          else 
            tmpstr = bdtransf.TaxAuthorState; 
          end;
          if( StrLen( tmpstr ) > 0 ) 
            ЗаписатьПолеЛог( "Status", tmpstr ); 
          else
            ЗаписатьПолеЛог( "Status", "0" );
          end;
          
          if( isPayment )
            if( pmrmprop.rec.TaxPmType != "" )
              ЗаписатьПолеЛог( "PaymentType", pmrmprop.rec.TaxPmType );
            else
              ЗаписатьПолеЛог( "PaymentType", "0" );
            end;
          else
            if( bdtransf.TaxPmType != "" )
              ЗаписатьПолеЛог( "PaymentType", bdtransf.TaxPmType );
            else
              ЗаписатьПолеЛог( "PaymentType", "0" );
            end;
          end;

          if( isPayment )
            tmpstr = pmrmprop.rec.TaxPmGround; 
          else
            tmpstr = bdtransf.TaxPmGround; 
          end;
          if( StrLen( tmpstr ) > 0 ) 
            ЗаписатьПолеЛог( "Purpose", tmpstr ); 
          else
            ЗаписатьПолеЛог( "Purpose", "0" );
          end;
         
          if( isPayment )
            if( pmrmprop.rec.TaxPmPeriod != "" )
              ЗаписатьПолеЛог( "TaxPeriod", pmrmprop.rec.TaxPmPeriod );
             else 
               ЗаписатьПолеЛог( "TaxPeriod", "0" );
             end;
          else 
            if( bdtransf.TaxPmPeriod != "" )
              ЗаписатьПолеЛог( "TaxPeriod", bdtransf.TaxPmPeriod );
            else 
              ЗаписатьПолеЛог( "TaxPeriod", "0" );
            end;
          end;

          if( isPayment )
            if( pmrmprop.rec.TaxPmNumber != "" ) 
              ЗаписатьПолеЛог( "TaxDocNumber", pmrmprop.rec.TaxPmNumber );
            else 
              ЗаписатьПолеЛог( "TaxDocNumber", "0" );
            end;
          else
            if( bdtransf.TaxPmNumber != "" ) 
              ЗаписатьПолеЛог( "TaxDocNumber", bdtransf.TaxPmNumber );
            else 
              ЗаписатьПолеЛог( "TaxDocNumber", "0" );
            end;
          end;
          
          if( isPayment )
            if( pmrmprop.rec.TaxPmDate != date( 0, 0, 0 ) ) 
              ЗаписатьПолеЛог( "TaxDocDate", pmrmprop.rec.TaxPmDate );
            else
             ЗаписатьПолеЛог( "TaxDocDate", "0" ); 
            end;
          else
            if( bdtransf.TaxPmDate != date( 0, 0, 0 ) ) 
              ЗаписатьПолеЛог( "TaxDocDate", bdtransf.TaxPmDate );
            else
             ЗаписатьПолеЛог( "TaxDocDate", "0" ); 
            end;
          end;

         ЗаписатьПолеЛог( endField, "BudgetIndex" ) ;
         УстановитьКонтекстБлокаЛог( ".." );
         // BudgetIndex ------------------------------------------- 

         // PaymentIdentificatio -------------------------------------------
         УстановитьКонтекстБлокаЛог( "PaymentIdentificatio" );
         ЗаписатьПолеЛог( beginField, "PaymentIdentificationData" );

          // Bank -------------------------------------------
          УстановитьКонтекстБлокаЛог( "Bank" );
          ЗаписатьПолеЛог( beginField, "Bank" );

           if( isPayment )
             ЗаписатьПолеЛог( "Name", pmrmprop.rec.PayerBankName );
             ЗаписатьПолеЛог( "CorrespondentBankAcc", pmrmprop.rec.PayerCorrAccNostro );
      
             if( pmprop_debet.rec.CodeKind == 3 )
               BIK = pmprop_debet.rec.Bankcode;
             else
               BIK = FindPartCode( pmpaym.PayerBankID, 3 );
             end;

             ЗаписатьПолеЛог( "BIK", BIK  );
           else
             var query1 = "select party.t_Name, bnkdprt.t_CorAcc, party.t_PartyID "   +
                 "  from dparty_dbt party, ddp_dep_dbt  dep, dbankdprt_dbt bnkdprt " +
                 " where party.t_PartyID = dep.t_PartyID "   +
                 "   and bnkdprt.t_PartyID = dep.t_PartyID " +
                 "   and dep.t_Code = " + bdtransf.Department;

             var rs_bank:RsdRecordset = execSQLselect(query1);
             if( rs_bank.moveNext() )

               ЗаписатьПолеЛог( "Name", rs_bank.Value(0) );
               ЗаписатьПолеЛог( "CorrespondentBankAcc", rs_bank.Value(1) );
                  
               BIK = FindPartCode( rs_bank.Value(3), 3 );
               ЗаписатьПолеЛог( "BIK", BIK  );
             end;
           end;

           var query = "select * " +
                 "  from dadress_dbt adr "        +
                 " where adr.t_PartyID = "    + pmpaym.PayerBankID +
                 "   and adr.t_Adress <> CHR(1) "  +                          
                 " order by adr.t_Type ";
           var rs_adress:RsdRecordset = execSQLselect(query);
           if( rs_adress.moveNext() )
    
             // Adress -------------------------------------------
             УстановитьКонтекстБлокаЛог( "Address" );
             ЗаписатьПолеЛог( beginField, "Address" );

             ЗаписатьПолеЛог( "kind", string(rs_adress.value( "t_Type" )) );
              ЗаписатьПолеЛог( "View", rs_adress.value( "t_Adress" ) );
        
             ЗаписатьПолеЛог( endField, "Address" ) ;
             УстановитьКонтекстБлокаЛог( ".." );
             // Adress -------------------------------------------

           end; // if Adress
          ЗаписатьПолеЛог( endField, "Bank" ) ;
          УстановитьКонтекстБлокаЛог( ".." );
          // Bank -------------------------------------------

         if( GetKindActionGG() != 0 ) // перегенерация
           tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "SystemIdentifier" ); 
           ЗаписатьПолеЛог( "SystemIdentifier", tmpstr );
         else
           var dep = Tbfile ("dp_dep.dbt");
           ClearRecord( dep.rec );
           if( isPayment )
             dep.rec.Code = pmpaym.OperNode;
           else
             dep.rec.Code = bdtransf.Department; 
           end;
           dep.getEQ ();

           if( isPayment )
             tmpstr = FormPaymentID( BIK, dep.rec.Name, OBJTYPE_PAYMENT, pmpaym.PaymentID );
           else
             tmpstr = FormPaymentID( BIK, dep.rec.Name, OBJTYPE_BDTRANSF, bdtransf.BdTransfID );
           end;
           ЗаписатьПолеЛог( "SystemIdentifier", tmpstr );
         end;

         ЗаписатьПолеЛог( endField, "PaymentIdentificationData" ) ;
         УстановитьКонтекстБлокаЛог( ".." );
         // PaymentIdentificatio -------------------------------------------
  
         if( isPayment )
           tmpstr = PayerIDForm( pmpaym.Payer, pmrmprop.rec.TaxPmNumber );
         else
           tmpstr = bdtransf.TaxPersonRef;
         end;
         if( tmpstr != "" )
           ЗаписатьПолеЛог( "PayerIdentifier", tmpstr );
         else
           ЗаписатьПолеЛог( "PayerIdentifier", "0" );
         end;
         
         if( isPayment )
           if( StrLen( pmpaym.PayerAccount ) > 0 )
             ЗаписатьПолеЛог( "PayerPA", pmpaym.PayerAccount );
           end;
         else
           if( StrLen( bdtransf.PayerAccount ) > 0 )
             ЗаписатьПолеЛог( "PayerPA", bdtransf.PayerAccount );
           end;
         end;
         // PayeeBankAcc -------------------------------------------
         УстановитьКонтекстБлокаЛог( "PayeeBankAcc" );
         ЗаписатьПолеЛог( beginField, "PayeeBankAcc" );

          if( isPayment and ( pmprop_credit.rec.Group != PAYMENTS_GROUP_EXTERNAL ) )  
            tmpstr = GetAccountType( pmpaym.ReceiverAccount );
            if( tmpstr != "" )
              ЗаписатьПолеЛог( "kind", tmpstr );
            end;
          end;

          if( isPayment )
            tmpstr = pmpaym.ReceiverAccount;
          else
            tmpstr = bdtransf.ReceiverAccount;
          end;          
          if( tmpstr != "" )
            ЗаписатьПолеЛог( "Account", tmpstr );
          else
            ЗаписатьПолеЛог( "Account", "00000000000000000000" );
          end;

          // Bank ------------------------------------------------------
          УстановитьКонтекстБлокаЛог( "Bank" );
          ЗаписатьПолеЛог( beginField, "Bank" ); 

           if( isPayment )
             ЗаписатьПолеЛог( "Name", pmrmprop.rec.ReceiverBankName );
             ЗаписатьПолеЛог( "CorrespondentBankAcc", pmrmprop.rec.ReceiverCorrAccNostro );
           else
             var query_recbank = "select party.t_Name, bnkdprt.t_CorAcc "   +
                                 "  from dparty_dbt party, dbankdprt_dbt bnkdprt, dpartcode_dbt code " +
                                 " where code.t_PartyID = party.t_PartyID "  +
                                 "   and code.t_CodeKind = 3 " +
                                 "   and code.t_Code = " + bdtransf.ReceiverBankCode +
                                 "   and bnkdprt.t_PartyID = code.t_PartyID ";

             var rs_recbank:RsdRecordset = execSQLselect(query1);
             if( rs_recbank.moveNext() )
               ЗаписатьПолеЛог( "Name", rs_recbank.Value(0) );
               ЗаписатьПолеЛог( "CorrespondentBankAcc", rs_recbank.Value(1) );
             end;
           end;

           if( isPayment )
            if( pmprop_credit.rec.CodeKind == 3 )
              ЗаписатьПолеЛог( "BIK", pmprop_credit.rec.BankCode );
            else
              tmpstr = FindPartCode( pmpaym.ReceiverBankID, 3 );
              ЗаписатьПолеЛог( "BIK", tmpstr );
            end;
          else
            ЗаписатьПолеЛог( "BIK", bdtransf.ReceiverBankCode );
          end;

          ЗаписатьПолеЛог( endField, "Bank" );
          УстановитьКонтекстБлокаЛог( ".." );
          // PayeeBankAcc -------------------------------------------

         ЗаписатьПолеЛог( endField, "PayeeBankAcc" ) ;
         УстановитьКонтекстБлокаЛог( ".." );
         // PayeeBankAcc -------------------------------------------

         ЗаписатьПолеЛог( "Version", "1.15" );

         if( IsRecreate ) // перегенерация
           tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "ChangeStatus" );
           ЗаписатьПолеЛог( "ChangeStatus", tmpstr );
         elif( GetKindActionGG() != 0 ) // перегенерация
           ЗаписатьПолеЛог( "ChangeStatus", "2" );
         else
           ЗаписатьПолеЛог( "ChangeStatus", "1" );
         end;

         if( pmrmprop.rec.ReceiverINN != "" )
           if( isPayment )
             tmpstr = RemoveKPP( pmrmprop.rec.ReceiverINN );
           else
             tmpstr = RemoveKPP( bdtransf.ReceiverINN );
           end;
           if( tmpstr != "" )
             ЗаписатьПолеЛог( "payeeINN", tmpstr );
           else
             ЗаписатьПолеЛог( "payeeINN", "0000000000" );
           end;
           if( isPayment )
             tmpstr = RemoveINN( pmrmprop.rec.ReceiverINN );
           else
             tmpstr = RemoveINN( bdtransf.ReceiverINN );
           end;
           if( tmpstr != "" )
             ЗаписатьПолеЛог( "payeeKPP", tmpstr );
           else 
             ЗаписатьПолеЛог( "payeeKPP", "000000000" );
           end;
         else 
           ЗаписатьПолеЛог( "payeeINN", "0000000000" );
           ЗаписатьПолеЛог( "payeeKPP", "000000000" );
         end;
        
         if( isPayment )
           if( StrLen( pmrmprop.rec.BTTTICode ) > 0 )
             ЗаписатьПолеЛог( "KBK", pmrmprop.rec.BTTTICode );
           else
             ЗаписатьПолеЛог( "KBK", " " );
           end;
           if( StrLen( pmrmprop.rec.OKATOCode ) > 0 )
             ЗаписатьПолеЛог( "OKATO", strRpad( pmrmprop.rec.OKATOCode, 11, "-" ) );
           else
             ЗаписатьПолеЛог( "OKATO", " " );
           end;
         else
           if( StrLen( bdtransf.BTTTICode ) > 0 )
             ЗаписатьПолеЛог( "KBK", bdtransf.BTTTICode );
           else
             ЗаписатьПолеЛог( "KBK", " " );
           end;
           if( StrLen( bdtransf.OKATOCode ) > 0 )
             ЗаписатьПолеЛог( "OKATO", strRpad( bdtransf.OKATOCode, 11, "-" ) );
           else
             ЗаписатьПолеЛог( "OKATO", " " );
           end;
         end;
        ЗаписатьПолеЛог( endField, "FinalPayment" ) ;
        УстановитьКонтекстБлокаЛог( ".." );
        // FinalPayment -------------------------------------------

      ЗаписатьПолеЛог( endField, "pirq:ImportRequest" ) ;
      УстановитьКонтекстБлокаЛог( ".." );
      // ImportRequest -------------------------------------------

     ЗаписатьПолеЛог( endField, "unifo:ImportData" ) ;
     УстановитьКонтекстБлокаЛог( ".." );
     // ImportData -------------------------------------------

    ЗаписатьПолеЛог( endField, "smev:AppData" ) ;
    УстановитьКонтекстБлокаЛог( ".." );
    // AppData -------------------------------------------

   ЗаписатьПолеЛог( endField, "smev:MessageData" ) ;
   УстановитьКонтекстБлокаЛог( ".." );
   // MessageData -------------------------------------------

  ЗаписатьПолеЛог( endField, "n1:UnifoTransferMsg" ) ;
  УстановитьКонтекстБлокаЛог( ".." );
  // UnifoTransferMsg -------------------------------------------
             
  if( IsRecreate and isPayment )
    var PaymID = makeObjectID( OBJTYPE_PAYMENT, NULL, pmpaym );
    ChangeGGMesRefNote( PaymID, wlmes.Trn )
  end;
             
  return TRUE; /* Успешное завершение */
end;

private macro GetStrDateTimeUTC( ID ):string
  var query = " select trn.t_Date_Carry, trn.t_SystemTime " +
    "   from dpmdocs_dbt doc, dacctrn_dbt trn "
              "  where doc.t_PaymentID = " + ID +
    "    and doc.t_AccTrnID = trn.t_AccTrnID "
    "    and trn.t_Chapter = 1 "
              "  order by t_AutoKey asc ";
  var rs:RsdRecordset = execSQLselect(query);
  var sdate = "";
  if( rs.moveNext() )
    sdate = ДатаДДММГГГГ(date(rs.value("t_Date_Carry"))) + "T" + trim( string( rs.value("t_SystemTime") ) );
  end;

  var query_zone = "select tz_offset(to_char(DBTIMEZONE)) from dual";
  var rs_zone:RsdRecordset = execSQLselect(query_zone);
  if (rs_zone and rs_zone.moveNext() )
    sdate = sdate + trim( string( rs_zone.value(0) ) );
  end;
  
  return sdate;
end;

private macro GetPaydem(PaymentID : integer)
  pspaydem.OrderId = PaymentID;
  getEQ(pspaydem);
end;

private macro GetDocKind(PaymentID : integer) : integer
  var q = "select t_DocKind " +
          "  from dpspayord_dbt " +
          " where t_OrderID = :PaymentID ";
  var rs = execSQLselect(q, makeArray( SQLParam("PaymentID", PaymentID) ) );
  if(rs and rs.moveNext())
    return rs.value("t_DocKind");
  end;

  return 0;
end;

private macro GetTransKind( TransKind ):string
  if( not InList( TransKind, "01", "06", "16"  ) )
    return "";
  end;
  return TransKind;
end;

private macro GetCorrAcc( val, IsPayment ):string
  file bank("bankdprt") key 0;
  file dp_dep("dp_dep") key 0;
  if( val != null )
    var PartyID = val;
    if( not IsPayment )
      dp_dep.Code = val;
      GetEQ(dp_dep);
      PartyID = dp_dep.PartyID;
    end;
    bank.PartyID = PartyID;
    GetEQ(bank);
    return bank.CorAcc;
  end;
  return 0;
end;

private macro MakeAndGetID():string
  var mean:string="", stat=0;

  if( GetKindActionGG() != 0 ) // перегенерация
    mean = WlMes_GetFieldValue( GetOldGGMessageID(), "ID" ); 
  else
    GetRegistryValue( "МЕЖБАНКОВСКИЕ РАСЧЕТЫ\\ГИС ГМП\\SymbolPaymentID", V_STRING, mean, stat );
    var ID = execStoredFunc( "sys_guid", V_STRING );
    if( (stat == 0) AND mean )
      mean = SubStr( mean, 1, 1 ) + "_" + SubStr( ID, 1,  8 ) + "-" +
                                          SubStr( ID, 9,  4 ) + "-" +
                                          SubStr( ID, 13, 4 ) + "-" +
                                          SubStr( ID, 17, 4 ) + "-" +
                                          SubStr( ID, 21 ); // symbol + GUID
    else
      mean = ID;
    end;
  end;

  return mean;
end;

private macro GetPaymType( type )
  if( type == "0" )
    return "0";
  elif( InList( strlen(type), 1, 2 ) )
    return type;
  end;
  return "";
end;

private macro GetPriority( Priority )
  if( (Priority < 0) or (Priority > 6) )
    return "";
  end;
  return string(Priority);
end;

macro GenMes1_16( addrMes, addrPaym, addrOldMes )
  record wlmes(wlmes);
  record OldMes(wlmes);
  ClearRecord(wlmes);
  ClearRecord(OldMes);
  record pmpaym(pmpaym);
  record bdtransf("bdtransf.dbt");

  SetBuff( wlmes, addrMes );
  SetBuff( OldMes, addrOldMes );
  var isPayment = false;
  if( WlGGisPayment() == true )
    SetBuff( pmpaym, addrPaym );
    isPayment = true;
  else
    SetBuff( bdtransf, addrPaym );
    isPayment = false;
  end;
  var BIK:string = "";
  var note = "";
  var IsRecreate:bool = GetKindActionGG()==4; //Перегенерация?
  var KindActionGG = GetKindActionGG();

  PrintLog(2, "Генерация сообщения по INFP1.16.1");

  var text:string = "",
      tmpstr:string = "";  

  var pmprop_debet = Tbfile ("pmprop.dbt");
  ClearRecord( pmprop_debet.rec );
  pmprop_debet.rec.PaymentID = pmpaym.PaymentID;
  pmprop_debet.rec.DebetCredit = 0;
  pmprop_debet.getEQ ();
  
  var pmprop_credit = Tbfile ("pmprop.dbt");
  ClearRecord( pmprop_credit.rec );
  pmprop_credit.rec.PaymentID = pmpaym.PaymentID;
  pmprop_credit.rec.DebetCredit = 1;
  pmprop_credit.getEQ ();
  
  var pmrmprop = Tbfile ("pmrmprop.dbt");
  ClearRecord( pmrmprop.rec );
  pmrmprop.rec.PaymentID = pmpaym.PaymentID;
  pmrmprop.getEQ ();

  var wlmes_xml:object = ActiveX( "MSXML.DOMDocument" );

  // Document -------------------------------------------
  УстановитьКонтекстБлокаЛог( "Document" );
    ЗаписатьПолеЛогОгр( beginField, "Document" );
    if( isPayment )
      ЗаписатьПолеЛогОгр( "originatorID", IfThenElse( pmpaym.StartDepartment != wlmes.Department, 
                                         GetCodeParty( GetDprtPartyID(pmpaym.StartDepartment), 61/*УРН (ГИС ГМП)*/ ),
                                         ""), 6 );
    else
      ЗаписатьПолеЛогОгр( "originatorID", "" );
    end;

    // FinalPayment -------------------------------------------
    УстановитьКонтекстБлокаЛог( "FinalPayment" );
      ЗаписатьПолеЛогОгр( beginField, "FinalPayment" );

      var tmpID = "";
      if( not IsRecreate )
        tmpID = MakeAndGetID();
      else
        if( not KindActionGG )
          tmpID = WlMes_GetFieldValue( OldMes.MesID, "SenderIdentifier" );
        else
          tmpID = WlMes_GetFieldValue( GetOldGGMessageID(), "ID" );
        end;
      end;

      ЗаписатьПолеЛогОгр( "ID", tmpID, 50 );
      
      if( isPayment )
        if( pmrmprop.rec.UIN )
          ЗаписатьПолеЛогОгр( "SupplierBillID", pmrmprop.rec.UIN, 25 );
        elif( CompareStrWithMasks( "40302*", pmpaym.ReceiverAccount ) )
          ЗаписатьПолеЛогОгр( "SupplierBillID", "0" );
        end;
        ЗаписатьПолеЛогОгр( "Narrative"     , pyOR( pmrmprop.rec.Ground, "0" ), 210 );
        ЗаписатьПолеЛогОгр( "Amount"        , string( (pmpaym.BaseAmount * 100):0:0 ), 20 );
      else
        if( bdtransf.UIN )
          ЗаписатьПолеЛогОгр( "SupplierBillID", bdtransf.UIN, 25 );
        elif( CompareStrWithMasks( "40302*", bdtransf.ReceiverAccount ) )
          ЗаписатьПолеЛогОгр( "SupplierBillID", "0" );
        end;
        ЗаписатьПолеЛогОгр( "Narrative"     , pyOR( SubStr( bdtransf.Ground, 1, 210 ), "0" ), 210 );
        ЗаписатьПолеЛогОгр( "Amount"        , string( (bdtransf.Amount * 100):0:0 ), 20 );
      end;

      if( isPayment )
        note = readNoteForObject(OBJTYPE_PAYMENT, makeObjectID(OBJTYPE_PAYMENT, NULL, pmpaym), PM_NOTEKIND_PAYM_ACCEPTUATEDATE );
        
        if(note == "")
          note = GetStrDateTimeUTC( pmpaym.PaymentID );
        end;

        if( date() >= date(2, 10, 2017) )
          note = substr(note, 1, 10);
        end;
       
        ЗаписатьПолеЛогОгр( "PaymentDate", note, 50 );
       
        ЗаписатьПолеЛогОгр( "ReceiptDate"   , pyOR( ДатаДДММГГГГ(pmpaym.PayerBankEnterDate), "" ) );
      else

        ЗаписатьПолеЛогОгр( "PaymentDate", IfThenElse( 
                                            date() >= date(2, 10, 2017), 
                                            ДатаДДММГГГГ( bdtransf.Date ), 
                                            GetStrDateTimeUTC( bdtransf.bdtransfID )), 50 );

        ЗаписатьПолеЛогОгр( "ReceiptDate"   , pyOR( ДатаДДММГГГГ(bdtransf.Date), "" ) );
      end;

      // BudgetIndex -------------------------------------------
      var isNeedPaymentBudgetIndexField = true; // Записывать ли данный блок в сообщение по платежу
      var isNeedTransferBudgetIndexField = true; // Записывать ли данный блок в сообщение по переводу в бюджет
      if( isPayment )
        if( (CompareStrWithMasks( "40302*", pmpaym.ReceiverAccount ) == 0)
         and ( (not pmrmprop.rec.TaxAuthorState) or (pmrmprop.rec.TaxAuthorState and (pmrmprop.rec.TaxAuthorState == "0")) ) 
         and ( (not pmrmprop.rec.TaxPmGround)    or (pmrmprop.rec.TaxPmGround    and (pmrmprop.rec.TaxPmGround    == "0")) )
         and ( (not pmrmprop.rec.TaxPmPeriod)    or (pmrmprop.rec.TaxPmPeriod    and (pmrmprop.rec.TaxPmPeriod    == "0")) )
         and ( (not pmrmprop.rec.TaxPmNumber)    or (pmrmprop.rec.TaxPmNumber    and (pmrmprop.rec.TaxPmNumber    == "0")) )
         and ( (not pmrmprop.rec.TaxPmDate)      or (pmrmprop.rec.TaxPmDate      and (pmrmprop.rec.TaxPmDate      == "0")) )       
         and ( (not pmrmprop.rec.TaxPmType)      or (pmrmprop.rec.TaxPmType      and (pmrmprop.rec.TaxPmType      == "0")) ) )
          isNeedPaymentBudgetIndexField = false;  
        end;
      else
        if( (CompareStrWithMasks( "40302*", bdtransf.ReceiverAccount ) == 0)
         and ( (not bdtransf.TaxAuthorState) or (bdtransf.TaxAuthorState and (bdtransf.TaxAuthorState == "0")) ) 
         and ( (not bdtransf.TaxPmGround)    or (bdtransf.TaxPmGround    and (bdtransf.TaxPmGround    == "0")) )
         and ( (not bdtransf.TaxPmPeriod)    or (bdtransf.TaxPmPeriod    and (bdtransf.TaxPmPeriod    == "0")) )
         and ( (not bdtransf.TaxPmNumber)    or (bdtransf.TaxPmNumber    and (bdtransf.TaxPmNumber    == "0")) )
/*дата*/ and ( (not bdtransf.TaxPmDate)      or (bdtransf.TaxPmDate      and (bdtransf.TaxPmDate      == date(0,0,0))) )       
         and ( (not bdtransf.TaxPmType)      or (bdtransf.TaxPmType      and (bdtransf.TaxPmType      == "0")) ) )
          isNeedTransferBudgetIndexField = false;  
        end;
      end;
      if( isPayment )
        if( isNeedPaymentBudgetIndexField )
          УстановитьКонтекстБлокаЛог( "BudgetIndex" );
            ЗаписатьПолеЛогОгр( beginField, "BudgetIndex" );
            ЗаписатьПолеЛогОгр( "Status"       , IfThenElse( pmrmprop.rec.TaxAuthorState and (pmrmprop.rec.TaxAuthorState != "0"), strLpad(pmrmprop.rec.TaxAuthorState,2,"0"), "0" ), 2 ); // "0" - invalid mean, valid: enumeration 01-26
            ЗаписатьПолеЛогОгр( "Purpose"      , pyOR( pmrmprop.rec.TaxPmGround,    "0" ), 2 );
            ЗаписатьПолеЛогОгр( "TaxPeriod"    , IfThenElse( pmrmprop.rec.TaxPmPeriod and (pmrmprop.rec.TaxPmPeriod != "0"), strLpad(pmrmprop.rec.TaxPmPeriod,2,"0"), "0" ), 10 );
            ЗаписатьПолеЛогОгр( "TaxDocNumber" , pyOR( pmrmprop.rec.TaxPmNumber,    "0" ), 15 );
  /*строка*/ЗаписатьПолеЛогОгр( "TaxDocDate"   , pyOR( pmrmprop.rec.TaxPmDate,      "0" ), 10 );
            ЗаписатьПолеЛогОгр( "PaymentType"  , GetPaymType( pmrmprop.rec.TaxPmType ), 2 );
          ЗаписатьПолеЛогОгр( endField, "BudgetIndex" );
          УстановитьКонтекстБлокаЛог( ".." );
        end;
      else
        if( isNeedTransferBudgetIndexField )
          УстановитьКонтекстБлокаЛог( "BudgetIndex" );
          ЗаписатьПолеЛогОгр( beginField, "BudgetIndex" );
            ЗаписатьПолеЛогОгр( "Status"       , IfThenElse( bdtransf.TaxAuthorState and (bdtransf.TaxAuthorState != "0"), strLpad(bdtransf.TaxAuthorState,2,"0"), "0" ), 2 ); // "0" - invalid mean, valid: enumeration 01-26
            ЗаписатьПолеЛогОгр( "Purpose"      , pyOR( bdtransf.TaxPmGround,    "0" ), 2 );
            ЗаписатьПолеЛогОгр( "TaxPeriod"    , IfThenElse( bdtransf.TaxPmPeriod and (bdtransf.TaxPmPeriod != "0"), strLpad(bdtransf.TaxPmPeriod,2,"0"), "0" ), 10 );
            ЗаписатьПолеЛогОгр( "TaxDocNumber" , pyOR( bdtransf.TaxPmNumber,    "0" ), 15 );
  /*дата*/  ЗаписатьПолеЛогОгр( "TaxDocDate"   , pyOR( ДатаДДММГГГГ(bdtransf.TaxPmDate),      "0" ), 10 );
            ЗаписатьПолеЛогОгр( "PaymentType"  , GetPaymType( pmrmprop.rec.TaxPmType ), 2 );
          ЗаписатьПолеЛогОгр( endField, "BudgetIndex" );
          УстановитьКонтекстБлокаЛог( ".." );
        end;
      end;

      // PaymentIdentificatio -------------------------------------------
      УстановитьКонтекстБлокаЛог( "PaymentIdentificatio" );
        ЗаписатьПолеЛогОгр( beginField, "PaymentIdentificatio" );

        // Bank -------------------------------------------
        УстановитьКонтекстБлокаЛог( "Bank" );
          ЗаписатьПолеЛогОгр( beginField, "Bank" );
          if( isPayment )
            ЗаписатьПолеЛогОгр( "Name", pmrmprop.rec.PayerBankName, 200 );
            var d_Code = " ";
            GetPartyCodeEx( pmpaym.PayerBankID, PTCK_BIC, @d_Code );
            ЗаписатьПолеЛогОгр( "BIK",  IfThenElse( pmprop_debet.rec.CodeKind == PTCK_BIC, pmprop_debet.rec.Bankcode, d_Code ), 9 );
            ЗаписатьПолеЛогОгр( "CorrespondentBankAcc",  GetCorrAcc(pmpaym.PayerBankID,true/*payment*/), 20 );
          else
            var PartyID = 0, PartyName = " ";
            var select = "select party.t_Name, party.t_PartyID from dparty_dbt party, ddp_dep_dbt dp_dep "
                         " where party.t_PartyID = dp_dep.t_PartyID "
                         "   and dp_dep.t_Code = :Department ";
            
            var params = makeArray( SQLParam( "Department", bdtransf.Department ) );
            var rs:RSDRecordSet = execSQLselect( select, params, FALSE );

            if( rs.moveNext() )
              PartyName = rs.value(0);
              PartyID = rs.value(1);
            end;
            ЗаписатьПолеЛогОгр( "Name", PartyName, 200 );
            d_Code = " ";
            GetPartyCodeEx( PartyID, PTCK_BIC, @d_Code );
            ЗаписатьПолеЛогОгр( "BIK", d_Code, 9 );
            ЗаписатьПолеЛогОгр( "CorrespondentBankAcc",  GetCorrAcc(bdtransf.Department,false/*transfer*/), 20 );
          end;
        ЗаписатьПолеЛогОгр( endField, "Bank" );
        УстановитьКонтекстБлокаЛог( ".." );

        if( KindActionGG != 0 ) // перегенерация
          tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "SystemIdentifier" ); 
          ЗаписатьПолеЛогОгр( "SystemIdentifier", strLpad(tmpstr, 32, "0"), 32 );
        else
          var dep = Tbfile ("dp_dep.dbt");
          ClearRecord( dep.rec );
          if( isPayment )
            dep.rec.Code = pmpaym.OperNode;
          else
            dep.rec.Code = bdtransf.Department; 
          end;
          dep.getEQ ();

          GetPartyCodeEx( pmpaym.PayerBankID, PTCK_BIC, @BIK );
          if( isPayment )
            tmpstr = FormPaymentID( BIK, dep.rec.Name, OBJTYPE_PAYMENT, pmpaym.PaymentID );
          else
            tmpstr = FormPaymentID( BIK, dep.rec.Name, OBJTYPE_BDTRANSF, bdtransf.BdTransfID );
          end;
          ЗаписатьПолеЛогОгр( "SystemIdentifier", strLpad(tmpstr, 32, "0"), 32 );
        end;
      ЗаписатьПолеЛогОгр( endField, "PaymentIdentificatio" );
      УстановитьКонтекстБлокаЛог( ".." );

      // AccDoc -------------------------------------------
      УстановитьКонтекстБлокаЛог( "AccDoc" );
        ЗаписатьПолеЛогОгр( beginField, "AccDoc" );
        var accdocno = "";
        if( isPayment )
          accdocno = string( pmrmprop.rec.Number );
          accdocno = IfThenElse(strlen(accdocno) > 6, substr(accdocno, strlen(accdocno)-6+1), accdocno);
          ЗаписатьПолеЛогОгр( "AccDocNo", accdocno, 6 ); // ???? СЕРВИС ГЛЮЧИТ / изменили на 3 цифры
          ЗаписатьПолеЛогОгр( "AccDocDate", ДатаДДММГГГГ(pmrmprop.rec.Date) );
        else
          accdocno = string( bdtransf.Number ); // 31.12.2014 ГИС не пропускает этот элемент
          accdocno = IfThenElse(strlen(accdocno) > 6, substr(accdocno, strlen(accdocno)-6+1), accdocno);
          ЗаписатьПолеЛогОгр( "AccDocNo", accdocno, 6 ); // ???? СЕРВИС ГЛЮЧИТ / изменили на 3 цифры
          ЗаписатьПолеЛогОгр( "AccDocDate", ДатаДДММГГГГ(bdtransf.Date) );
        end;
      ЗаписатьПолеЛогОгр( endField, "AccDoc" );
      УстановитьКонтекстБлокаЛог( ".." );

      // Payer -------------------------------------------
      var isNeedPaymentPayerField = true; // Записывать ли данный блок в сообщение по платежу
      var isNeedTransferPayerField = true; // Записывать ли данный блок в сообщение по переводу в бюджет
      var PayerIdentifier = "";

      PayerIdentifier = IfThenElse( isPayment, PayerIDForm( pmpaym.Payer, pmrmprop.rec.TaxPmNumber ), bdtransf.TaxPersonRef );

      if( isPayment )
        if( (CompareStrWithMasks( "40302*", pmpaym.ReceiverAccount ) == 0)
         and ( PayerIdentifier == "" ) 
         and ( (not pmrmprop.rec.PayerName) or (pmrmprop.rec.PayerName and (pmrmprop.rec.PayerName == "0")) )
         and ( (not pmpaym.PayerAccount)    or (pmpaym.PayerAccount    and (pmpaym.PayerAccount    == "0")) ) )
          isNeedPaymentPayerField = false;  
        end;
      else
        if( (CompareStrWithMasks( "40302*", bdtransf.ReceiverAccount ) == 0)
         and ( bdtransf.TaxPersonRef == "" ) 
         and ( (not bdtransf.PayerName)    or (bdtransf.PayerName    and (bdtransf.PayerName    == "0")) )
         and ( (not bdtransf.PayerAccount) or (bdtransf.PayerAccount and (bdtransf.PayerAccount == "0")) ) )
          isNeedTransferPayerField = false;  
        end;
      end;

      if( isPayment )
        if( isNeedPaymentPayerField )
          УстановитьКонтекстБлокаЛог( "Payer" );
          ЗаписатьПолеЛогОгр( beginField, "Payer" );
            if( PayerIdentifier )
              ЗаписатьПолеЛогОгр( "PayerIdentifier", PayerIdentifier, 25 );
            elif( CompareStrWithMasks( "40302*", pmpaym.ReceiverAccount ) )
              ЗаписатьПолеЛогОгр( "PayerIdentifier", "0" );
            end;
            if( IsPartyInst( pmpaym.Payer ) )
              ЗаписатьПолеЛогОгр( "PayerName",       pyOR( pmrmprop.rec.PayerName, "" ), 160 );
            end;
            ЗаписатьПолеЛогОгр( "PayerAccount",    pyOR( pmpaym.PayerAccount, "" ), 20 );
          ЗаписатьПолеЛогОгр( endField, "Payer" );
          УстановитьКонтекстБлокаЛог( ".." );
        end;
      else
        if( isNeedTransferPayerField )
          УстановитьКонтекстБлокаЛог( "Payer" );
          ЗаписатьПолеЛогОгр( beginField, "Payer" );
            if( bdtransf.TaxPersonRef )
              ЗаписатьПолеЛогОгр( "PayerIdentifier", bdtransf.TaxPersonRef, 25 );
            elif( CompareStrWithMasks( "40302*", bdtransf.ReceiverAccount ) )
              ЗаписатьПолеЛогОгр( "PayerIdentifier", "0" );
            end;
            if( IsPartyInst( bdtransf.BdTransfID ) )
              ЗаписатьПолеЛогОгр( "PayerName",       pyOR( bdtransf.PayerName, "" ), 160 );
            end;
            ЗаписатьПолеЛогОгр( "PayerAccount",    pyOR( bdtransf.PayerAccount, "" ), 20 );
          ЗаписатьПолеЛогОгр( endField, "Payer" );
          УстановитьКонтекстБлокаЛог( ".." );
        end;
      end;

      // Payee -------------------------------------------
      УстановитьКонтекстБлокаЛог( "Payee" );
        ЗаписатьПолеЛогОгр( beginField, "Payee" );
        var PayeeKPP = "";
        if( isPayment )
          ЗаписатьПолеЛогОгр( "PayeeName", pmrmprop.rec.ReceiverName, 160 );
          ЗаписатьПолеЛогОгр( "payeeINN",  RemoveKPP(pmrmprop.rec.ReceiverINN), 10 );
          PayeeKPP = RemoveINN(pmrmprop.rec.ReceiverINN);
          ЗаписатьПолеЛогОгр( "payeeKPP", IfThenElse( PayeeKPP == "", "0", PayeeKPP ) , 9 );
        else
          ЗаписатьПолеЛогОгр( "PayeeName", bdtransf.ReceiverName, 160 );
          ЗаписатьПолеЛогОгр( "payeeINN",  RemoveKPP(bdtransf.ReceiverINN), 10 );
          PayeeKPP = RemoveINN(bdtransf.ReceiverINN);
          ЗаписатьПолеЛогОгр( "payeeKPP",  IfThenElse( PayeeKPP == "", "0", PayeeKPP ), 9 );
        end;
        // PayeeBankAcc -------------------------------------------
        УстановитьКонтекстБлокаЛог( "PayeeBankAcc" );
          ЗаписатьПолеЛогОгр( beginField, "PayeeBankAcc" );
          if( isPayment )
            ЗаписатьПолеЛогОгр( "Account", pyOR( pmpaym.ReceiverAccount,   strLpad("", 20, "0") ), 20 );
          else
            ЗаписатьПолеЛогОгр( "Account", pyOR( bdtransf.ReceiverAccount, strLpad("", 20, "0") ), 20 );
          end;
          // Bank -------------------------------------------
          УстановитьКонтекстБлокаЛог( "Bank" );
            ЗаписатьПолеЛогОгр( beginField, "Bank" );
            if( isPayment )
              ЗаписатьПолеЛогОгр( "Name", pyOR( pmrmprop.rec.ReceiverBankName, "" ), 200 );
              var c_Code = "";
              GetPartyCodeEx( pmpaym.ReceiverBankID, PTCK_BIC, @c_Code );
              ЗаписатьПолеЛогОгр( "BIK",  IfThenElse( pmprop_credit.rec.CodeKind == PTCK_BIC, pmprop_credit.rec.Bankcode, c_Code ), 9 );
              ЗаписатьПолеЛогОгр( "CorrespondentBankAcc",  GetCorrAcc(pmpaym.ReceiverBankID,true/*payment*/), 20 );
            else
              ЗаписатьПолеЛогОгр( "Name", pyOR( bdtransf.ReceiverName, "" ), 200 );
              ЗаписатьПолеЛогОгр( "BIK",  bdtransf.ReceiverBankcode, 9 );

              var makeParams = makeArray( SQLParam( "ReceiverBankCode", bdtransf.ReceiverBankcode ) );
              var execQuery = execSQLselect( "select t_PartyID from dpartcode_dbt where t_Code = :ReceiverBankCode and t_CodeKind = 3", makeParams, FALSE );
              var _PartyID = 0;
              if ( execQuery and execQuery.moveNext() )
                _PartyID = execQuery.value(0);
              end;
              ЗаписатьПолеЛогОгр( "CorrespondentBankAcc", GetCorrAcc(_PartyID,true/*transfer*/), 20 );
            end;
          ЗаписатьПолеЛогОгр( endField, "Bank" );
          УстановитьКонтекстБлокаЛог( ".." );

        ЗаписатьПолеЛогОгр( endField, "PayeeBankAcc" );
        УстановитьКонтекстБлокаЛог( ".." );

      ЗаписатьПолеЛогОгр( endField, "Payee" );
      УстановитьКонтекстБлокаЛог( ".." );           

      // ChangeStatus -------------------------------------------
      УстановитьКонтекстБлокаЛог( "ChangeStatus" );
        ЗаписатьПолеЛогОгр( beginField, "ChangeStatus" );
        var reason = "";
        if( KindActionGG == KIND_ACTION_GG_NULL )
          reason = GetCachedVar( WLD_CONTEXTANNULREASON );
        elif( KindActionGG == KIND_ACTION_GG_CORRECT )
          reason = GetCachedVar( WLD_CONTEXTCORRECTREASON );
        end;
        var tmpMeaning = "";
        if( isPayment )
          if( IsRecreate ) // перегенерация
            tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "meaning" ); 
            ЗаписатьПолеЛогОгр( "meaning", tmpstr, 1 );
            tmpstr = WlMes_GetFieldValue( GetOldGGMessageID(), "Reason" ); 
            ЗаписатьПолеЛогОгр( "Reason", pyOR( tmpstr, "" ), 512 );
          else
            tmpMeaning = IfThenElse( KindActionGG == 1, "2", IfThenElse( KindActionGG == 2, "3", "1" ) );
            ЗаписатьПолеЛогОгр( "meaning", tmpMeaning, 1 );
            ЗаписатьПолеЛогОгр( "Reason",  string( pyOR( reason, "" ) ), 512 ); // Заполняем при выполнении процедуры аннулирования или уточнения информации о платеже.
          end;
        else
          tmpMeaning = IfThenElse( KindActionGG != 0, "3", "1" );
          ЗаписатьПолеЛогОгр( "meaning", tmpMeaning, 1 );
          ЗаписатьПолеЛогОгр( "Reason",  string( pyOR( reason, "" ) ), 512 ); // Заполняем при выполнении процедуры аннулирования или уточнения информации о платеже.
        end;
      ЗаписатьПолеЛогОгр( endField, "ChangeStatus" );
      УстановитьКонтекстБлокаЛог( ".." );

      if( isPayment )
         // pmpaym.PaymentID, not DocumentID ?
        var isClientRequirement:bool = GetDocKind( pmpaym.PaymentID ) == 2/*$(Клиентское требование)???*/;
        GetPaydem( pmpaym.PaymentID );
        if( pmrmprop.rec.BTTTICode )
          ЗаписатьПолеЛогОгр( "KBK", pmrmprop.rec.BTTTICode, 20 );
        elif( CompareStrWithMasks( "40302*", pmpaym.ReceiverAccount ) )
          ЗаписатьПолеЛогОгр( "KBK", "0" );
        end;                                   
        ЗаписатьПолеЛогОгр( "TransKind",       GetTransKind( string(pmrmprop.rec.ShifrOper) ), 2 );
        ЗаписатьПолеЛогОгр( "TransContent",    IfThenElse( pmpaym.PartPaymNumber, GetContentOperationString( pmpaym.ContentOperation, pmpaym, false ), "" ), 16 );
        ЗаписатьПолеЛогОгр( "PaytCondition",   IfThenElse( isClientRequirement, IfThenElse( pspaydem.AcceptTerm!=0, "1", "2" ), "" ), 1 );
        ЗаписатьПолеЛогОгр( "AcptTerm",        IfThenElse( isClientRequirement, string(pspaydem.AcceptPeriod),                  "" ), 5 );
        ЗаписатьПолеЛогОгр( "MaturityDate",    IfThenElse( isClientRequirement, ДатаДДММГГГГ(pspaydem.AcceptDate),              "" ) );
        ЗаписатьПолеЛогОгр( "DocDispatchDate", ДатаДДММГГГГ( pmrmprop.rec.DocDispatchDate ) );
      else
        if( bdtransf.BTTTICode )
          ЗаписатьПолеЛогОгр( "KBK", bdtransf.BTTTICode, 20 );
        elif( CompareStrWithMasks( "40302*", bdtransf.ReceiverAccount ) )
          ЗаписатьПолеЛогОгр( "KBK", "0" );
        end;
        ЗаписатьПолеЛогОгр( "TransKind",       GetTransKind( GetShifrOperByCoverPaymID( bdtransf.CoverPaymentID ) ), 2 );
        ЗаписатьПолеЛогОгр( "TransContent",    ""  );
        ЗаписатьПолеЛогОгр( "PaytCondition",   ""  );
        ЗаписатьПолеЛогОгр( "AcptTerm",        ""  );
        ЗаписатьПолеЛогОгр( "MaturityDate",    ""  );
        ЗаписатьПолеЛогОгр( "DocDispatchDate", ""  );
      end;

      // PartialPayt -------------------------------------------
      if( isPayment and (pmpaym.PartPaymNumber > 0) )
        УстановитьКонтекстБлокаЛог( "PartialPayt" );
          ЗаписатьПолеЛогОгр( beginField, "PartialPayt" );
          ЗаписатьПолеЛогОгр( "PaytNo",          string(pmpaym.PartPaymNumber), 3 );
          ЗаписатьПолеЛогОгр( "TransKind",       GetTransKind( string(pmpaym.PartPaymShifrMain) ), 2 );
          ЗаписатьПолеЛогОгр( "SumResidualPayt", pyOR( string( (pmpaym.PartPaymRestAmountMain * 100):0:0 ), "" ), 18 );

          // AccDoc -------------------------------------------
          УстановитьКонтекстБлокаЛог( "AccDoc" );
            ЗаписатьПолеЛогОгр( beginField, "AccDoc" );
            accdocno = string( pmpaym.PartPaymNumMain );
            accdocno = IfThenElse(strlen(accdocno) > 6, substr(accdocno, strlen(accdocno)-6+1), accdocno);
            ЗаписатьПолеЛогОгр( "AccDocNo", accdocno, 6 );
            ЗаписатьПолеЛогОгр( "AccDocDate", ДатаДДММГГГГ(pmpaym.PartPaymDateMain) );
          ЗаписатьПолеЛогОгр( endField, "AccDoc" );
          УстановитьКонтекстБлокаЛог( ".." );
        ЗаписатьПолеЛогОгр( endField, "PartialPayt" );
        УстановитьКонтекстБлокаЛог( ".." );
      end;

      if( isPayment )
        ЗаписатьПолеЛогОгр( "Priority",  GetPriority(pmrmprop.rec.Priority), 1 );
        if( pmrmprop.rec.OKATOCode )
          ЗаписатьПолеЛогОгр( "OKTMO"    , pmrmprop.rec.OKATOCode, 11 );
        elif( (CompareStrWithMasks( "40101*", pmpaym.ReceiverAccount ) == 0) and (pmpaym.PayType != BPT_CUSTOM) )
          ЗаписатьПолеЛогОгр( "OKTMO"    , "0" );
        end;
      else
        ЗаписатьПолеЛогОгр( "Priority",  GetPriority(bdtransf.Priority), 1 );
        if( bdtransf.OKATOCode )
          ЗаписатьПолеЛогОгр( "OKTMO"    , bdtransf.OKATOCode, 11 );
        elif( CompareStrWithMasks( "40101*", bdtransf.ReceiverAccount ) == 0 )
          ЗаписатьПолеЛогОгр( "OKTMO"    , "0" );
        end;
      end;

      // AdditionalData -------------------------------------------
      if( isPayment )
        note = readNoteForObject(OBJTYPE_PAYMENT, makeObjectID(OBJTYPE_PAYMENT, NULL, pmpaym), PM_NOTEKIND_PAYM_ESIA_ID );

        if((note != "") and (StrIsNumber(note)) )
          УстановитьКонтекстБлокаЛог( "AdditionalData" );
          ЗаписатьПолеЛогОгр( beginField, "AdditionalData", 20 );        
          ЗаписатьПолеЛогОгр( "Name", "ESIA_ID", 100 );
          ЗаписатьПолеЛогОгр( "Value", note, 255 );
          ЗаписатьПолеЛогОгр( endField, "AdditionalData", 20 );
          УстановитьКонтекстБлокаЛог( ".." );
        end;

      elif( ( bdtransf.ESIAPersonRef != "" ) and ( StrIsNumber( bdtransf.ESIAPersonRef ) ) )
          УстановитьКонтекстБлокаЛог( "AdditionalData" );
          ЗаписатьПолеЛогОгр( beginField, "AdditionalData", 20 );        
          ЗаписатьПолеЛогОгр( "Name", "ESIA_ID", 100 );
          ЗаписатьПолеЛогОгр( "Value", bdtransf.ESIAPersonRef, 255 );
          ЗаписатьПолеЛогОгр( endField, "AdditionalData", 20 );
          УстановитьКонтекстБлокаЛог( ".." );        
      end;

      ЗаписатьПолеЛогОгр( "Signature", "" );

    ЗаписатьПолеЛогОгр( endField, "FinalPayment" );
    УстановитьКонтекстБлокаЛог( ".." );

  ЗаписатьПолеЛогОгр( endField, "Document" );
                 
  if( IsRecreate and isPayment )
    var PaymID = makeObjectID( OBJTYPE_PAYMENT, NULL, pmpaym );
    ChangeGGMesRefNote( PaymID, wlmes.Trn )    
  end;
               
  return true;
end;
