/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank v6                       */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/* Генерация сообщения по SWIFT-SB MT920S                                   */
/*                                                                          */
/*  Имя файла: swsm920s.mac                                                 */
/*  Создан:  18.03.04                                        Панов А.Б.     */
/****************************************************************************/
import "swsbgmes.mac";

macro GenMes(addrMes, addrReq)
  var field_value, Narrative, Descript;

  SetBuff(wlmes, addrMes);
  SetBuff(wlReq, addrReq);

  SB_CheckFIID( wlReq.FIID );

  PrintLog(2,"Генерация сообщения по МТ920S");

  /* SN - уникальный системный номер сообщения в СМФР */
  ЗаписатьПолеЛог(УникальныйНомерСообщенияСМФР, wlmes.TRN);

  /* 20 - номер транзакции (документа) */
  ЗаписатьПолеЛог(TransactionReferenceNumberField, wlmes.TRN);

  if( not УстановитьКонтекстБлока("Sequence A") )
    RunError("|Ошибка при установке контекста блока Sequence A");
  end;

  /* 12 - Тип собственного сообщения */
  ЗаписатьПолеЛог(SubMessageType, "950");

  /* 32E - Фин. инструмент */
  if( wlReq.FIID == 0 )
    RunError( "|Недопустимо запрашивать выписку по рублевым счетам МФР,|только в инвалюте" );
  end;
  ЗаписатьПолеЛог(CurrencyOrQuantityOfMetalField, ПолучитьКодВалютыЛог(wlReq.FIID));

  if( not УстановитьКонтекстБлока() )
    RunError("|Ошибка при установке нулевого контекста блока");
  end;
  
  return TRUE; /* успешное завершение */

  OnError(er) /* обработка ошибок */
    ExeptionMessage(er);
    return false;
end;