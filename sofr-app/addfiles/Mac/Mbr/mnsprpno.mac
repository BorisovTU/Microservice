 /*
 $Name: mnsprpno.mac
 $Module: МБР
 $Description: Печатная форма сообщения PNO
 */
/************************************************************************/
/*         Автоматизированная банковская система RS-Bank                */
/*                 Copyright (c) R-Style Software Lab 2014              */
/*                                                                      */
/*  Имя файла      : mnsgdpno.mac                                       */
/*                                                                      */
/*  Описание       : Печать инкассового поручения                       */
/*                   (PNO). Вызов из си.                                */
/*                                                                      */
/*  Программист    : TDV                                                */
/*                                                                      */
/*  Создан         : 31.07.2014                                         */
/*                                                                      */
/************************************************************************/

/* Печать инкассового поручения */
import mnsgdpno, prpm;

macro PrintDoc( addrMes, MassCopy ):bool
  record mes(wlmes);
  SetBuff( mes, addrMes );

  if( mes.Kind != MESKIND_MNS );
    MsgBox("Данный вид документа не поддерживается макросом");
    return FALSE;
  end;

  /*number fields of the PRJ_000173*/
  var F62="",   F71="",   F4="",   F3="",   F5="",  F101="", 
      F6_1="",  F6_2="",  F6_3="", 
      F7="", 
      F8_1="",  F8_2="",  F8_3="", F8_4="", 
      F9="", 
      F10_1="", F10_2="", F10_3="",
      F11="",   F12="", 
      F13_1="", F13_2="", F13_3="", 
      F14="",   F15="", 
      F61="",   F103="",  F17="", 
      F16_1="", F16_2="", F16_3="", F16_4="", 
      F18="",   F21="",   F20="",   F22="", F23="", F104="", F105="", F106="", F107="", F108="", F109="", F110="", 
      F24_1="", F24_2="", F24_3="", 
      F48="",   F46="",   F47="",   F63="", F64="", F65="",  F66="",  F67="",  F68="",  F69="",  F45="",  F60="",  F102="";

  var field_name, field_value, flen,
      maxLenF6  = 82, // width field  F6
      maxLenF8  = 52, // width fields F8,F10,F13,F16
      maxLenF24 = 90; // width field  F24
  
  while( СчитатьПоле( field_name, field_value ) )
    if( field_name == "НомПоруч" )
      F3 = field_value;
    end;
    if( field_name == "ДатаПоруч" )
      F4 = StrToDate(field_value);
    end;
    if( field_name == "ВидПлат" )
      F5 = field_value;
    end;
    if( field_name == "Статус" )
      F101 = field_value;
    end;
    if( field_name == "СумПоруч" )
      var mon = moneyL( strSubst(field_value, "-", "") ) / 100;
      F6_1 = RubToStrAlt( mon );
      flen = strlen(F6_1);
      if( (F6_1) AND (flen > maxLenF6) )
        F6_2 = SubStr( F6_1, maxLenF6+1, flen );
        flen = strlen(F6_2);
      end;
      if( (F6_2) AND (flen > maxLenF6) )
        F6_3 = SubStr( F6_2, maxLenF6+1, flen );
      end;
    end;
    if( field_name == "ИНННП" )
      F60 = field_value;
    end;
    if( field_name == "КППНП" )
      F102 = field_value;
    end;
    if( field_name == "ИННПол" )
      F103 = field_value;
    end;
    if( field_name == "СумПоруч" )
      F7 = moneyL( strSubst(field_value, "-", "") ) / 100;
    end;
    if( field_name == "Плательщ" )
      F8_1 = field_value;
      flen = strlen(F8_1);
      if( (F8_1) AND (flen > maxLenF8) )
        F8_2 = SubStr( F8_1, maxLenF8+1, flen );
        flen = strlen(F8_2);
      end;
      if( (F8_2) AND (flen > maxLenF8) )
        F8_3 = SubStr( F8_2, maxLenF8+1, flen );
        flen = strlen(F8_3);
      end;
      if( (F8_3) AND (flen > maxLenF8) )
        F8_4 = SubStr( F8_3, maxLenF8+1, flen );
      end;
    end;
    if( (field_name == "НомСчПл") AND (field_value != "") )
      F9 = field_value;
    else
      F9 = "";
    end;

    if( (field_name == "НомСчБПл") AND (field_value != "") )
      F12 = field_value;
    end;
    if( (field_name == "НомСчБПол") AND (field_value != "") )
      F15 = field_value;
    end;

    if( field_name == "БанкПл" )
      F10_1 = field_value;
      flen = strlen(F10_1);
      if( (F10_1) AND (flen > maxLenF8) )
        F10_2 = SubStr( F10_1, maxLenF8+1, flen );
        flen = strlen(F10_2);
      end;
      if( (F10_2) AND (flen > maxLenF8) )
        F10_3 = SubStr( F10_2, maxLenF8+1, flen );
      end;
    end;
    if( field_name == "БанкПол" )
      F13_1 = field_value;
      flen = strlen(F13_1);
      if( (F13_1) AND (flen > maxLenF8) )
        F13_2 = SubStr( F13_1, maxLenF8+1, flen );
        flen = strlen(F13_2);
      end;
      if( (F13_2) AND (flen > maxLenF8) )
        F13_3 = SubStr( F13_2, maxLenF8+1, flen );
      end;
    end;
    if( field_name == "БИКБПол" )
      F14 = field_value;
    end;
    if( field_name == "БИКБПл" )
      F11 = field_value;
    end;
    if( field_name == "ИННПол" )
      F61 = field_value;
    end;
    if( field_name == "НаимПол" )
      F16_1 = field_value;
      flen = strlen(F16_1);
      if( (F16_1) AND (flen > maxLenF8) )
        F16_2 = SubStr( F16_1, maxLenF8+1, flen );
        flen = strlen(F16_2);
      end;
      if( (F16_2) AND (flen > maxLenF8) )
        F16_3 = SubStr( F16_2, maxLenF8+1, flen );
        flen = strlen(F16_3);
      end;
      if( (F16_3) AND (flen > maxLenF8) )
        F16_4 = SubStr( F16_3, maxLenF8+1, flen );
      end;
    end;
    if( field_name == "ВидОп" )
      F18 = field_value;
    end;
    if( field_name == "НазнПлКод" )
      F20 = field_value;
    end;
    if( field_name == "ОчерПл" )
      F21 = field_value;
    end;
    if( field_name == "КодПл" )
      F22 = field_value;
    end;
    if( field_name == "РезПоле" )
      F23 = field_value;
    end;
    if( field_name == "КБК" )
      F104 = field_value;
    end;
    if( field_name == "ОКАТО" )
      F105 = field_value;
    end;
    if( field_name == "ОснПл" )
      F106 = field_value;
    end;
    if( field_name == "СрокУплТр" )
      F107 = field_value;
    end;
    if( field_name == "НомТреб" )
      F108 = field_value;
    end;
    if( field_name == "ДатаТреб" )
      F109 = field_value;
    end;
    if( field_name == "ТипПл" )
      F110 = field_value;
    end;
    if( field_name == "НазнПл" )
      F24_1 = field_value;
      flen = strlen(F24_1);
      if( (F24_1) AND (flen > maxLenF24) )
        F24_2 = SubStr( F24_1, maxLenF24+1, flen );
        flen = strlen(F24_2);
      end;
      if( (F24_2) AND (flen > maxLenF24) )
        F24_3 = SubStr( F24_2, maxLenF24+1, flen );
      end;
    end;
  end;

  F62 = GetBankDate( mes.SessionID );

  if( not ( StrLen( F12 ) > 0 ) )
    if( mes.insideAbonentID > 0 )
      F12 = GetCorrAcc( mes.insideAbonentID );
    else
      F12 = GetCorrAcc( mes.agentID );
    end;
  end;  
  
  if( (not ( StrLen( F11 ) > 0) ) or ( not ( ПолучитьКодСубъекта( F11, PTCK_BIC ) > 0 ) ) )
    if( mes.insideAbonentID > 0 )
      F11 = ПолучитьКодСубъекта( mes.insideAbonentID, mes.insideAbonentCodeKind );
    else
      F11 = ПолучитьКодСубъекта( mes.insideAbonentID, mes.agentCodekind );
    end;
  end;

  if( F14 != "" )
    var ID = ПолучитьКодСубъекта( F14, PTCK_BIC );
    if( not ( StrLen( F15 ) > 0 ) )    
      F15 = GetCorrAcc( ID );
    end;
  end;

    [
                                                                                     ┌─────────┐
                                                                                     │ 0401071 │
         ############            ##########                                          └─────────┘
      ───────────────────    ────────────────────
      Поступ. в банк плат.   Списано со сч. плат.

                                                          ##########  #############       ┌────┐
      ИНКАССОВОЕ ПОРУЧЕНИЕ N #######################      ──────────  ─────────────       │ ## │
                                                            (Дата)    (Вид платежа)       └────┘

      Сумма   │##################################################################################
      прописью│##################################################################################
              │##################################################################################
     ─────────┴────────┬──────────────────────────────────┬───────┬──────────────────────────────
      ИНН ############ │ КПП #########                    │ СУММА │##############################
     ──────────────────┴──────────────────────────────────┤       │
      ####################################################│       │
      ####################################################├───────┼──────────────────────────────
      ####################################################│ Сч.N. │##############################
      ####################################################│       │
      ПЛАТЕЛЬЩИК                                          │       │
     ─────────────────────────────────────────────────────┼───────┤
      ####################################################│ БИК   │##############################
      ####################################################├───────┤
      ####################################################│ Сч.N. │##############################
      БАНК ПЛАТЕЛЬЩИКА                                    │       │
     ─────────────────────────────────────────────────────┼───────┼──────────────────────────────
      ####################################################│ БИК   │##############################
      ####################################################├───────┤
      ####################################################│ Сч.N. │##############################
      БАНК ПОЛУЧАТЕЛЯ                                     │       │
     ──────────────────┬──────────────────────────────────┼───────┤
      ИНН ############ │ КПП #########                    │ Сч.N. │##############################
     ──────────────────┴──────────────────────────────────┤       │
      ####################################################├───────┼─────────────┬──────────┬─────
      ####################################################│Вид Оп.│#########    │ Очер.пл. │ ###
      ####################################################├───────┤             │          │ 
      ####################################################│Наз.пл.│#############├──────────┤
                                                          ├───────┤             │          │
      ПОЛУЧАТЕЛЬ                                          │ Код   │#############│ Рез.поле │ ###
     ─────────────────────┬─────────────┬────┬────────────┼───────┴─────────┬───┴────────┬─┴─────
      ####################│ ########### │ ## │ ########## │ ############### │ ########## │ ##
     ─────────────────────┴─────────────┴────┴────────────┴─────────────────┴────────────┴───────
      ##########################################################################################
      ##########################################################################################
      ##########################################################################################
      Назначение платежа:                                                               
     ────────────────────────────────────────────────────────────────────────────────────────────
                                    Подписи                          Отметки банка получателя
                                                                             ##########
         ##########               ##########                                           
            М.П.         ───────────────────────────────                          
                                                                                   
                         ───────────────────────────────                           
                                                                                   

      ───────┬────────────┬────────────┬──────────────┬─────────────┬───────────   
       N ч.  │   N плат.  │  Дата      │  Сумма       │   Сумма     │ Подпись     Дата помещения  
       плат. │   ордера   │  плат.     │  частичного  │   остатка   │             в картотеку     
             │            │  ордера    │  платежа     │   платежа   │             ##########     
      ───────┼────────────┼────────────┼──────────────┼─────────────┼───────────                                                                                            
             │            │            │              │             │             Отметки банка  
             │            │            │              │             │             плательщика    
       ##### │ ########## │ ########## │ ############ │ ########### │             ##########     
    ]
     (F62:f:c, F71:c, F4:f:c, F5:c, F3:l,
      F101:l, F6_1,F6_2,F6_3, F60, F102, F7:l, F8_1:l,F8_2:l,F8_3:l,F9,F8_4:l, F10_1,F11,F10_2,F10_3, F12, F13_1,F14,F13_2,F13_3, F15, 
      F61, F103, F17, F16_1,F16_2,F18, F21,F16_3,F16_4, F20, F22, F23, 
      F104, F105, F106, F107, F108, F109, F110, F24_1,F24_2,F24_3, F48, F46, F47, F63, /*по проекту не заполняются*/F64, F65, F66, F67, F68, F45);

  PrintEOF();

  return TRUE;
END;
