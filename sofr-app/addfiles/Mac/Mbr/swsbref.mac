/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank v6                       */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/*             Формирование референсов сообщений SWIFT-SB                   */
/*                                                                          */
/*  Имя файла: swsbref.mac                                                  */
/*  Создан:  18.03.04                                        Панов А.Б.     */
/****************************************************************************/
import CTInter, PTInter, "globals.mac";

record swsbrefpmpaym(pmpaym);
record swsbrefwlinfo(wlinfo);
record swsbrefwlconf(wlconf);

/* Код отправителя сообщения по умолчанию (если не найден) */
const CodePayerMesBankDefault = "0000";

macro GetRefOutMes( SeqValue, ObjKind, ObjAddr )
  var refer, dd, mm, yy, PayerMesID = {OurBank}, CodePayerMesBank, CodeClir, error;
  
  if (ObjKind==OBJTYPE_PAYMENT)
    SetBuff(swsbrefpmpaym,  ObjAddr);
    PayerMesID = swsbrefpmpaym.PayerMesBankID;
  elif (ObjKind == OBJTYPE_CONF)
    SetBuff(swsbrefwlconf,  ObjAddr);
    PayerMesID = swsbrefwlconf.BankID;
  elif (ObjKind == OBJTYPE_INFO)
    SetBuff(swsbrefwlinfo,  ObjAddr);
    PayerMesID = swsbrefwlinfo.OfficeID;
  end;

  CodePayerMesBank = ПолучитьКодСубъекта(PayerMesID, PTCK_SMFR, Error);
  if (error != 0)
    CodePayerMesBank = CodePayerMesBankDefault;
  end;

  /* Формируем 16-символьный уникальный идентификатор */
  datesplit({curdate}, dd, mm, yy);
  refer = String("S", CodePayerMesBank, (yy - int(yy/1000)*1000):2, mm:2, dd:2, SeqValue:5);
  refer = StrSubst( refer, " ", "0" );

  return refer;
end;