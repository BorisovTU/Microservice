import "swdpgmes.mac";

RECORD Corschem( corschem );


macro GenMes( addrMes, addrbuf )
  RECORD DpBuf( dpmsginf );
  var msginf, msgLink, msgParty;  

  SetBuff( wlmes,  addrMes );
  SetBuff( DpBuf,  addrbuf );
  
  msginf = RsbDepoInfoMessage(DpBuf.MessageID);

  if ( valtype(msginf)==V_UNDEF )
     RunError( "|Не определен объект класса" );
  end;

  /* Блок GENL (начало) */
  ЗаписатьПолеЛогВБлок( GENL_Block, StartOfBlock, GENL_Block );
    if ( msginf.SenderReference=="" )
       RunError( "|Не заполнен номер исходящего сообщения" );
    end;
  /*  A/20C/SEME   */
  ЗаписатьПолеЛог( SendersReferenceField, ":SEME//"+msginf.SenderReference ) ;

  /*  23G   */
  ЗаписатьПолеЛог( FunctionMessageField, GetMessageFunction(msginf) ) ;
  /*   A/98a/PREP  */
  if ( msginf.PreparationDate!=date(0,0,0) )
    if( not УстановитьКонтекстБлока( "98a" ) )
      RunError("|Ошибка при установке контекста блока 98a");
    end;
    ЗаписатьПолеЛог( PreperationDateTimeField, ":PREP//"+GetSWIFTDateFull(msginf.PreparationDate)+
                                                      GetSWIFTTimeFull(msginf.PreparationTime) );  
    if( not УстановитьКонтекстБлока( ".." ) )
      RunError("|Ошибка при установке контекста блока ..");
    end;
  end;
  /*    A/99B/SETT   */
  if ( msginf.TotalOfLinkedMessages )
    if( not УстановитьКонтекстБлока( "99a" ) )
      RunError("|Ошибка при установке контекста блока 99a");
    end; 
    ЗаписатьПолеЛог( NumberCountField, ":SETT//"+AlignNumberRight(msginf.CurrentMessageNumber,3) );
    ЗаписатьПолеЛог( NumberCountField, ":TOSE//"+AlignNumberRight(msginf.TotalOfLinkedMessages,3) );
    if( not УстановитьКонтекстБлока( ".." ) )
      RunError("|Ошибка при установке контекста блока ..");
    end;
  end;

/*-------------------Подпоследователь-ность "A1"--------Связи-------------------------------*/
  /* Блок LINK (начало) */
  if( not УстановитьКонтекстБлока( LINK_Block ) )
    RunError("|Ошибка при установке контекста блока " + LINK_Block);
  end;
    if ( GetMessageFunction(msginf)=="CANC" )
       msginf.RewindLinkedMessage();
       msgLink = msginf.GetLinkedMessage();
       if ( valtype(msgLink)==V_UNDEF )
          RunError("|Отсутствует обязательная последовательность связок (блок LINK)");
       end;
       while( valtype(msgLink)!=V_UNDEF )
          ЗаписатьПолеЛог( StartOfBlock, LINK_Block );
          ЗаписатьПолеЛог( IndicatorField, ":BEFO//" + GetLikageType(msgLink.LinkageType) );
          ЗаписатьПолеЛог( LinkedTransactionField, ":LINK//541");
          ЗаписатьПолеЛог( SendersReferenceField, ":PREV//"+msgLink.SenderReference ) ;
          ЗаписатьПолеЛог( EndOfBlock, LINK_Block );
          ЗаписатьПолеЛог( StartOfBlock, LINK_Block );
          ЗаписатьПолеЛог( IndicatorField, ":BEFO//" + GetLikageType(msgLink.LinkageType) );
          ЗаписатьПолеЛог( SendersReferenceField, ":RELA//"+msgLink.ReceiverReference ) ;
          ЗаписатьПолеЛог( EndOfBlock, LINK_Block );
          msgLink = msginf.GetLinkedMessage();
       end;
    end;
  if( not УстановитьКонтекстБлока( ".." ) )
    RunError("|Ошибка при установке контекста блока ..");
  end;
 /* Блок LINK (конец) */
 ЗаписатьПолеЛог( EndOfBlock, GENL_Block ) ;
 /* Блок GENL (конец) */
/*-------------------Подпоследователь-ность "A1"--------Связи-------------------------------*/
/* ----------------xxxxxx---------------- xxxxxx ----------------xxxxxx---------------------*/
/*-------------------Последовательность "B"--------Детали операции/сделки-------------------*/

  /* Блок TRADDET (начало) */
  ЗаписатьПолеЛогВБлок( TRADDET_Block, StartOfBlock, TRADDET_Block );

  /*  B/94B/TRAD */
  if ( (msginf.TradePlaceCode!="") and (GetTradePlaceType(msginf)=="EXCH") )
     ЗаписатьПолеЛог( PlaceOfTradeField, ":TRAD//"+GetTradePlaceType(msginf)+"/"+msginf.TradePlaceCode ) ;
  elif (GetTradePlaceType(msginf)=="OTCO")
     ЗаписатьПолеЛог( PlaceOfTradeField, ":TRAD//OTCO" );
  end;
  
  if( not УстановитьКонтекстБлока( "98a" ) )
    RunError("|Ошибка при установке контекста блока 98a");
  end;
  /* B/98a/SETT */
  if ( msginf.SettlementDate==date(0,0,0) )
     RunError("|Не заполнена дата начала периода использования поручения");
  end;
  ЗаписатьПолеЛог( PreperationDateTimeField, ":SETT//"+GetSWIFTDateFull(msginf.SettlementDate)
                                                      +GetSWIFTTimeFull(msginf.SettlementTime) );
  /*  B/98a/TRAD */
  if ( msginf.TradeDate!=date(0,0,0) )
     ЗаписатьПолеЛог( PreperationDateTimeField, ":TRAD//"+GetSWIFTDateFull(msginf.TradeDate)
                                                         +GetSWIFTTimeFull(msginf.TradeTime) );
  end;

  if( not УстановитьКонтекстБлока( ".." ) )
    RunError("|Ошибка при установке контекста блока ..");
  end;
  /* B/90a/DEAL */   
  /* .....  Неизвестна реализация   */ 
  /* B/99A/DAAC */
  /* .....  Неизвестна реализация   */ 

  ЗаписатьПолеЛог( IdentificationOfSecuritiesField, CreateIdentificationOfSecurities(msginf) );



  /* Блок FIA (начало) */
  if ( msginf.HasCharge )
    if( not УстановитьКонтекстБлока( FIA_Block ) )
      RunError("|Ошибка при установке контекста блока "+FIA_Block);
    end;
    ЗаписатьПолеЛог( StartOfBlock, FIA_Block ) ;
    /*  B1/70E/FIAN */
    ЗаписатьПолеЛог( FIANarrativeEField, ":FIAN//XX/CORP/"+
                     ПолучитьВнутреннийКод(OBJTYPE_AVOIRISS,
                     msginf.ReceiverID,msginf.SecurityCodeKind) +"//PLDG/Y" );

    ЗаписатьПолеЛог( EndOfBlock, FIA_Block ) ;
    if( not УстановитьКонтекстБлока( ".." ) )
      RunError("|Ошибка при установке контекста блока ..");
    end;
  end;
  /* Блок FIA (конец) */
  /*  B/22F/TTCO */
 if( not УстановитьКонтекстБлока( "22a" ) )
  RunError("|Ошибка при установке контекста блока ..");
 end;
 ЗаписатьПолеЛог( IndicatorField, ":SETR//"+GetSettlementTRNType(msginf) );
 if( not УстановитьКонтекстБлока( ".." ) )
      RunError("|Ошибка при установке контекста блока ..");
 end;

  if ( msginf.NeedCounterDraft )
    if( not УстановитьКонтекстБлока( "70a" ) )
       RunError("|Ошибка при установке контекста блока 70a" );
    end;
    /* B/70E/SPRO */
    ЗаписатьПолеЛог( FIANarrativeEField, ":SPRO//XX/CORP/"+
                     ПолучитьВнутреннийКод(OBJTYPE_AVOIRISS,msginf.ReceiverID,msginf.SecurityCodeKind)+
                     "//MACH/Y" );
    if( not УстановитьКонтекстБлока( ".." ) )
       RunError("|Ошибка при установке контекста блока .." );
    end;
  end;

  ЗаписатьПолеЛог( EndOfBlock, TRADDET_Block ) ;
  /* Блок TRADDET (конец) */
/*-------------------Последовательность "B"--------Детали операции/сделки-------------------*/

  /* Блок FIAC (начало) */
  ЗаписатьПолеЛогВБлок( FIAC_Block, StartOfBlock, FIAC_Block );
  /* C/36B/SETT */                                           
  ЗаписатьПолеЛог( QuantityOfFIField, ":SETT//UNIT/"+GetSWIFTAmount(msginf.QuantityToBeSettled) );
  /*  C/19A/SETT */
  /*  C/70D/DENC */
  /*  C/13B/CERT */
  /*  C/97a/SAFE*/ 
  if( not УстановитьКонтекстБлока( "97a" ) )
    RunError("|Ошибка при установке контекста блока 97a");
  end;
  if ( (msginf.Account!="") and (msginf.Partition!="") )
     ЗаписатьПолеЛог( AccountAField, ":SAFE//"+msginf.Account+"/KRZD/"+msginf.Partition);
  else
     RunError("|Не задан счет/раздел депо продавца");
  end;

  if( not УстановитьКонтекстБлока( ".." ) )
    RunError("|Ошибка при установке контекста блока ..");
  end;
  /*  C/94a */
  /*  End Block */
  ЗаписатьПолеЛог( EndOfBlock, FIAC_Block ) ;
  /* Блок FIAC (конец) */

  /*-----------------------------------------------------------------------*/

  /* Блок REPO (начало) */
  /* Функциональность блока неизвестна */
  /*ЗаписатьПолеЛогВБлок( REPO_Block, StartOfBlock, REPO_Block );
  ЗаписатьПолеЛог( EndOfBlock, REPO_Block ) ;*/
  /* Блок REPO (конец) */

  /*-----------------------------------------------------------------------*/

  /* Блок SETDET (начало) */
  ЗаписатьПолеЛогВБлок( SETDET_Block, StartOfBlock, SETDET_Block );
  /*  E/22F/SETR */
  if( not УстановитьКонтекстБлока( "22a" ) )
    RunError("|Ошибка при установке контекста блока 22a");
  end;
  ЗаписатьПолеЛог( IndicatorField, ":SETR//"+GetSettlementTRNType(msginf) );
  if( not УстановитьКонтекстБлока( ".." ) )
    RunError("|Ошибка при установке контекста блока ..");
  end;
  /*  E/22F/RTGS */
  /*  E/17B      */
  /* SETPRTY-начало    Продавец - конечный отправитель ц/б  */
  msgParty = GetMessageParty(msginf,DPMSGPAT_SECURITIES,OBJTYPE_MSGPATYTP_SELL);
  if ( valtype(msgParty)!=V_UNDEF )
    /* Блок SETPRTY (начало) */
    ЗаписатьПолеЛогВБлок( SETDET_Block+"/"+SETPRTY_Block, StartOfBlock, SETPRTY_Block );
    /* E1/95a/SELL */
    if( ЗаписатьИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_SELL,msgParty) )
      /* E1/97a/SAFE */
      ЗаписатьСчетИРазделИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_SELL,msgParty);
    end;
    /* E1/98a/PROC */
    /* E1/20C/PROC */
    /* E1/70a      */
    /* End Block   */
    ЗаписатьПолеЛог( EndOfBlock, SETPRTY_Block ) ;
    if( not УстановитьКонтекстБлока( ".." ) )
       RunError("|Ошибка при установке контекста блока ..");
    end;
  end;
  /* SETPRTY-конец    Продавец - конечный отправитель ц/б  */

  /* Блок SETPRTY (начало)        Отправитель ценных бумаг  */
  ЗаписатьПолеЛогВБлок( SETDET_Block+"/"+SETPRTY_Block, StartOfBlock, SETPRTY_Block );

  /*  E1/95a/DEAG */
  if( not ЗаписатьИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_DEAG) )
     RunError("|Отсутствует информация об идентификаторе стороны (DEAG)");
  end;

  /*  E1/97a/SAFE */
  ЗаписатьСчетИРазделИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_DEAG);
  /*  E1/70a    */
  /*  End block */
  ЗаписатьПолеЛог( EndOfBlock, SETPRTY_Block ) ;
  if( not УстановитьКонтекстБлока( ".." ) )
     RunError("|Ошибка при установке контекста блока ..");
  end;
  /* Блок SETPRTY (конец)         Отправитель ценных бумаг  */

  /* Блок SETPRTY (начало)       Место проведения расчетов  */
  ЗаписатьПолеЛогВБлок( SETDET_Block+"/"+SETPRTY_Block, StartOfBlock, SETPRTY_Block );

  /*  E1/95a/PSET */
  if( not ЗаписатьИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_PSET) )
     RunError("|Отсутствует информация об идентификаторе стороны (PSET)");
  end;
  /*  E1/98a/PROC */
  msgParty = GetMessageParty(msginf,DPMSGPAT_SECURITIES,OBJTYPE_MSGPATYTP_PSET);
  if ( msgParty.ProcessingDate!=date(0,0,0) )
     if( not УстановитьКонтекстБлока( "98a" ) )
       RunError("|Ошибка при установке контекста блока 98a");
     end;         
           ЗаписатьПолеЛог( PreperationDateTimeField, ":PROC//"+GetSWIFTDateFull(msgParty.ProcessingDate)
                                                               +GetSWIFTTimeFull(msgParty.ProcessingTime) );
     if( not УстановитьКонтекстБлока( ".." ) )
       RunError("|Ошибка при установке контекста блока ..");
     end;
  end;
  /*  E1/20C/PROC */
  if ( msgParty.ProcessingReference!="" )
     ЗаписатьПолеЛог( SendersReferenceField, ":PROC//"+msgParty.ProcessingReference ) ;
  /*  E1/70a */
  elif ( msgParty.HasInformation==true )
     if( not УстановитьКонтекстБлока( "70a" ) )
        RunError("|Ошибка при установке контекста блока 70a");
     end;
     ЗаписатьПолеЛог( FIANarrativeDField, ":PART//XX/CORP/"+
                      ПолучитьВнутреннийКод(OBJTYPE_PARTY,msginf.ReceiverID,
                                            msgParty.DepoPartyCodeKind) + "//PROC/Y" ) ;
     if( not УстановитьКонтекстБлока( ".." ) )
        RunError("|Ошибка при установке контекста блока ..");
     end;
  end;
  /*  End bloack */
  ЗаписатьПолеЛог( EndOfBlock, SETPRTY_Block ) ;
  if( not УстановитьКонтекстБлока( ".." ) )
     RunError("|Ошибка при установке контекста блока ..");
  end;
  /* Блок SETPRTY (конец)              Место проведения расчетов  */

  /* Блок SETPRTY (начало)             Получатель ценных бумаг*/
  msgParty = GetMessageParty(msginf,DPMSGPAT_SECURITIES,OBJTYPE_MSGPATYTP_REAG);
  if ( valtype(msgParty)!=V_UNDEF )
    ЗаписатьПолеЛогВБлок( SETDET_Block+"/"+SETPRTY_Block, StartOfBlock, SETPRTY_Block );
    /*  E1/95a/REAG */
    if( ЗаписатьИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_REAG,msgParty) )
      /*  E1/97a/SAFE */
      ЗаписатьСчетИРазделИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_REAG,msgParty) ;
    end;
    ЗаписатьПолеЛог( EndOfBlock, SETPRTY_Block ) ;
    if( not УстановитьКонтекстБлока( ".." ) )
       RunError("|Ошибка при установке контекста блока ..");
    end;
  end;
  /* Блок SETPRTY (конец)               Получатель ценных бумаг    */

  /* Блок SETPRTY (начало)              Покупатель - конечный получатель ценных бумаг */
  msgParty = GetMessageParty(msginf,DPMSGPAT_SECURITIES,OBJTYPE_MSGPATYTP_BUYR);
  if ( valtype(msgParty)!=V_UNDEF )
     ЗаписатьПолеЛогВБлок( SETDET_Block+"/"+SETPRTY_Block, StartOfBlock, SETPRTY_Block );
     /*95a*/
     if( ЗаписатьИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_BUYR,msgParty) )
        /*97a*/
        ЗаписатьСчетИРазделИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_BUYR,msgParty);
     end;
     ЗаписатьПолеЛог( EndOfBlock, SETPRTY_Block ) ;
     if( not УстановитьКонтекстБлока( ".." ) )
        RunError("|Ошибка при установке контекста блока ..");
     end;
  end;
  /* Блок SETPRTY (конец)               Покупатель - конечный получатель ценных бумаг */

  /* Блок CSHPRTY (начало)              Кредитная организация Отправителя денежных средств */
  msgParty = GetMessageParty(msginf,DPMSGPAT_CURRENCIES,OBJTYPE_MSGPATYTP_PAYE);
  if ( valtype(msgParty)!=V_UNDEF )
    ЗаписатьПолеЛогВБлок( SETDET_Block+"/"+CSHPRTY_Block, StartOfBlock, CSHPRTY_Block );
    /*95a*/
    if( ЗаписатьИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_PAYE,msgParty) )
       /*97a*/
       if( not ЗаписатьСчетИРазделИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_PAYE,msgParty) )
          RunError("|Отсутствует информация о счете идентификатора стороны (PAYE)");
       end;
    end;
    ЗаписатьПолеЛог( EndOfBlock, CSHPRTY_Block ) ;
    if( not УстановитьКонтекстБлока( ".." ) )
       RunError("|Ошибка при установке контекста блока ..");
    end;
  end;
  /* Блок CSHPRTY (конец)               Кредитная организация Отправителя денежных средств */
                                
  /* Блок CSHPRTY (начало) Кредитная организация получателя денежных средств (б/ бенефец.) */
  msgParty = GetMessageParty(msginf,DPMSGPAT_CURRENCIES,OBJTYPE_MSGPATYTP_ACCW);
  if ( valtype(msgParty)!=V_UNDEF )
    ЗаписатьПолеЛогВБлок( SETDET_Block+"/"+CSHPRTY_Block, StartOfBlock, CSHPRTY_Block );
    /*95a*/
    if( ЗаписатьИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_ACCW,msgParty) )
       /*97a*/
       if( not ЗаписатьСчетИРазделИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_ACCW,msgParty) )
          RunError("|Отсутствует информация о счете идентификатора стороны (ACCW)");
       end;
    end;
    ЗаписатьПолеЛог( EndOfBlock, CSHPRTY_Block ) ;
    if( not УстановитьКонтекстБлока( ".." ) )
       RunError("|Ошибка при установке контекста блока ..");
    end;
  end;
  /* Блок CSHPRTY (начало) Кредитная организация получателя денежных средств (б/ бенефец.) */

  /* Блок CSHPRTY (начало) Кредитная организация получателя денежных средств (бенефец.) */
  msgParty = GetMessageParty(msginf,DPMSGPAT_CURRENCIES,OBJTYPE_MSGPATYTP_BENM);
  if ( valtype(msgParty)!=V_UNDEF )
    ЗаписатьПолеЛогВБлок( SETDET_Block+"/"+CSHPRTY_Block, StartOfBlock, CSHPRTY_Block );
    /*95a*/
    if( ЗаписатьИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_BENM,msgParty) )
       /*97a*/
       if( not ЗаписатьСчетИРазделИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_BENM,msgParty) )
          RunError("|Отсутствует информация о счете идентификатора стороны (BENM)");
       end;
    end;
    ЗаписатьПолеЛог( EndOfBlock, CSHPRTY_Block ) ;
    if( not УстановитьКонтекстБлока( ".." ) )
       RunError("|Ошибка при установке контекста блока ..");
    end;
  end;
  /* Блок CSHPRTY (начало) Кредитная организация получателя денежных средств (бенефец.) */


  /* Блок AMT (начало)             Суммы  */
  ЗаписатьПолеЛогВБлок( SETDET_Block+"/"+AMT_Block, StartOfBlock, AMT_Block );
     if( not УстановитьКонтекстБлока( "19a" ) )
        RunError("|Ошибка при установке контекста блока 19a");
     end;
     if( GetMessageFunction(msginf) == "CANC")
       FillSumOfAmountAField( msginf, false );
     else
     FillSumOfAmountAField( msginf, true );
     end;
     if( not УстановитьКонтекстБлока( ".." ) )
        RunError("|Ошибка при установке контекста блока ..");
     end;
  ЗаписатьПолеЛог( EndOfBlock, AMT_Block );      
  /* Блок AMT (конец)             Суммы */

  if( not УстановитьКонтекстБлока( ".." ) )
     RunError("|Ошибка при установке контекста блока ..");
  end;
  ЗаписатьПолеЛог( EndOfBlock, SETDET_Block ) ;
  /* Блок SETDET (конец) */

  /*-----------------------------------------------------------------------*/

  msgParty = GetMessageParty(msginf,DPMSGPAT_OTHER,OBJTYPE_MSGPATYTP_MEOR);
  if ( (valtype(msgParty)!=V_UNDEF) )
     /* Блок OTHRPRTY (начало) */
     ЗаписатьПолеЛогВБлок( OTHRPRTY_Block, StartOfBlock, OTHRPRTY_Block );

     /*95a*/
     if( not ЗаписатьИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_MEOR, msgParty) )
        RunError("|Отсутствует информация об инициаторе поручения");
     end;

     ЗаписатьПолеЛог( EndOfBlock, OTHRPRTY_Block );
     /* Блок OTHRPRTY (конец) */
  end;

  /*-----------------------------------------------------------------------*/
 /* Блок OTHRPRTY (начало)    Отправитель поручения депо, в случае ели если он 
    не является от-правителем сообщения S.W.I.F.T.                            */

  msgParty = GetMessageParty(msginf,DPMSGPAT_OTHER,OBJTYPE_MSGPATYTP_MEOR);
  if ( (valtype(msgParty)!=V_UNDEF) )
     /* Блок OTHRPRTY (начало) */
     ЗаписатьПолеЛогВБлок( OTHRPRTY_Block, StartOfBlock, OTHRPRTY_Block );

     /*95a*/
     if( not ЗаписатьИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_MEOR, msgParty) )
        RunError("|Отсутствует информация об инициаторе поручения");
     end;

     ЗаписатьПолеЛог( EndOfBlock, OTHRPRTY_Block );
  end;
  /* Блок OTHRPRTY (конец)    Отправитель поручения депо, в случае ели если он 
    не является от-правителем сообщения S.W.I.F.T.                            */

  /*-----------------------------------------------------------------------*/
  /* Блок OTHRPRTY (начало)    Конечный получатель сообщения S.W.I.F.T.  */
  msgParty = GetMessageParty(msginf,DPMSGPAT_OTHER,OBJTYPE_MSGPATYTP_MERE);
  if ( (valtype(msgParty)!=V_UNDEF) )
     /* Блок OTHRPRTY (начало) */
     ЗаписатьПолеЛогВБлок( OTHRPRTY_Block, StartOfBlock, OTHRPRTY_Block );

     /*95a*/
     if( not ЗаписатьИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_MERE, msgParty) )
        RunError("|Отсутствует информация о получателе сообщения");
     end;

     /*70E*/
     ЗаписатьПереченьДокументов( msginf );

     if( not УстановитьКонтекстБлока( "70a" ) )
        RunError("|Ошибка при установке контекста блока 70a");
     end;
     /*70D*/
     if ( msginf.EffectiveSettlementDate!=date(0,0,0) )
                                                            
        ЗаписатьПолеЛог( FIANarrativeDField, ":PART//XX/CORP/"+
                         ПолучитьВнутреннийКод(OBJTYPE_AVOIRISS,msginf.ReceiverID,msginf.SecurityCodeKind)+
                         "//SEND/"+ GetSWIFTDateFull(msginf.EffectiveSettlementDate) ) ;
     end;
     if( not УстановитьКонтекстБлока( ".." ) )
        RunError("|Ошибка при установке контекста блока ..");
     end;
     /*20C*/                                             
     if ( msginf.ProcessingCode!="" )
        ЗаписатьПолеЛог( SendersReferenceField, ":PROC//TRNC/"+msginf.ProcessingCode) ;
     end;
     ЗаписатьПолеЛог( EndOfBlock, OTHRPRTY_Block );
  end;
  /* Блок OTHRPRTY (конец)    Конечный получатель сообщения S.W.I.F.T.  */

  /* Блок OTHRPRTY (начало) Депонент (владелец) счета депо, если он не является инициатором поручения*/
  msgParty = GetMessageParty(msginf,DPMSGPAT_OTHER,OBJTYPE_MSGPATYTP_INVE);
  if ( (valtype(msgParty)!=V_UNDEF) )
     ЗаписатьПолеЛогВБлок( OTHRPRTY_Block, StartOfBlock, OTHRPRTY_Block );
     /*95a*/
     if( not ЗаписатьИдентификатораСтороны(msginf,OBJTYPE_MSGPATYTP_INVE, msgParty) )
        RunError("|Отсутствует информация об инициаторе поручения");
     end;
     ЗаписатьПолеЛог( EndOfBlock, OTHRPRTY_Block );
  end;
  /* Блок OTHRPRTY (конец) Депонент (владелец) счета депо, если он не является инициатором поручения*/

  return TRUE; /* Успешное завершение */

  OnError(er) /* обработка ошибок */
    ExeptionMessage(er);
    return FALSE;
end;
