/*
  $Name:         gginfpmsendrep.mac
  $Module:       Œ¥¦¡ ­ª®¢áª¨¥ à áç¥âë
  $Description:  à®â®ª®«ë ¢§ ¨¬®¤¥©áâ¢¨ï RS-Banking á RS-Connect ¯® á®®¡é¥­¨ï¬ ¢ ƒˆ‘ ƒŒ
*/

//-----------------------------------------------------------------------------
//          €¢â®¬ â¨§¨à®¢ ­­ ï ¡ ­ª®¢áª ï á¨áâ¥¬  RS-Bank               
//                 Copyright (c) R-Style Software Lab
//
// ®¤á¨áâ¥¬    : Œ¥¦¡ ­ª®¢áª¨¥ à áç¥âë
//
// ¯¨á ­¨¥     : à®â®ª®«ë ¢§ ¨¬®¤¥©áâ¢¨ï RS-Banking á RS-Connect ¯® á®®¡é¥­¨ï¬ ¢ ƒˆ‘ ƒŒ
//
// à®£à ¬¬¨áâ  : Kolyakin V.V.
//
// ‘®§¤ ­       : 30.08.2018
//
//-----------------------------------------------------------------------------

import globals, oralib, likepy, WldInter, MesInter, CTInter, bnk_dirfile, bnk_common, bnk_dttmfrmt, SwitchOutput, gginfpmsendconst;

private macro GetOperName( Oper : integer ):string
  var OperName:string = "";

  var query : string = " select t_Name " +
                       " from dperson_dbt " +
                       " where t_Oper = :Oper ";

  var rs : RsdRecordset = execSQLselectPrm( query, SQLParam( "Oper", Oper ) );

  if( rs and rs.moveNext() )
    OperName = rs.value( "t_Name" );
  end;

  return OperName;
end;


/********************************************************************************************************************
 à®â®ª®« ¢ë¯®«­¥­¨ï ¯à®æ¥¤ãàë ä®à¬¨à®¢ ­¨ï § ¯à®á®¢ ¤«ï ¯¥à¥¤ ç¨ ¨­ä®à¬ æ¨¨ ¤«ï ƒˆ‘ ƒŒ ¢ RS-Connect
*********************************************************************************************************************/

class TGGPIPmSendReqsGeneratingReport( _RepType )
  var RepType : integer;
  var ReportFileName : string;

  private macro GetRsdRecordSet():RsdRecordSet
    var query = "( "
                " select ggrep.t_Department as t_Dep, party_dep.t_Name as t_DepName, ggrep.t_Branch as t_Branch, party_br.t_Name as t_BranchName, " +
                "        ggrep.t_ObjectID as t_PayID, objects.t_Name as t_Kind, ggrep.t_MesID as t_ReqID, pmsend.t_ExtObjectID as t_MessID, ggrep.t_Result as t_Result, " +
                "        rm.t_Number as t_Number, rm.t_Date as t_Date, pm.t_PayerAccount as t_PayerAcc, prop.t_BankCode as t_RecBIC, " +
                "        pm.t_ReceiverAccount as t_ReceiverAcc, pm.t_BaseAmount as t_Amount, rm.t_Ground as t_Ground, ggrep.t_ObjectType as t_ObjectType " +
                " from dggrep_tmp ggrep, dobjects_dbt objects, dpmpaym_dbt pm, dpmrmprop_dbt rm, dpmprop_dbt prop, dpmsend_dbt pmsend, " +
                "      ddp_dep_dbt dp_dep_dep, ddp_dep_dbt dp_dep_br, dparty_dbt party_dep, dparty_dbt party_br " +
                " where ggrep.t_ObjectType = 501/*OBJTYPE_PAYMENT*/ " +
                "   and pm.t_PaymentID = ggrep.t_ObjectID " +
                "   and rm.t_PaymentID = pm.t_PaymentID " +
                "   and prop.t_PaymentID = pm.t_PaymentID " +
                "   and prop.t_DebetCredit = 1/*PRT_CREDIT*/ " +
                "   and ggrep.t_ObjectType = objects.t_ObjectType " +
                "   and pmsend.t_ID = ggrep.t_MesID " +
                "   and dp_dep_dep.t_Code(+) = ggrep.t_Department " +
                "   and party_dep.t_PartyID(+) = dp_dep_dep.t_PartyID " +
                "   and dp_dep_br.t_Code(+) = ggrep.t_Branch " +
                "   and party_br.t_PartyID(+) = dp_dep_br.t_PartyID " +
                ") " +
                " union " +
                "( " +
                " select ggrep.t_Department as t_Dep, party_dep.t_Name as t_DepName, ggrep.t_Branch as t_Branch, party_br.t_Name as t_BranchName, " +
                "        ggrep.t_ObjectID as t_PayID, objects.t_Name as t_Kind, ggrep.t_MesID as t_ReqID, pmsend.t_ExtObjectID as t_MessID, ggrep.t_Result as t_Result, " +
                "        bdtransf.t_Number as t_Number, bdtransf.t_Date as t_Date, bdtransf.t_PayerAccount as t_PayerAcc, bdtransf.t_ReceiverBankCode as t_RecBIC, " +
                "        bdtransf.t_ReceiverAccount as t_ReceiverAcc, bdtransf.t_Amount as t_Amount, bdtransf.t_Ground as t_Ground, ggrep.t_ObjectType as t_ObjectType " +
                " from dggrep_tmp ggrep, dobjects_dbt objects, dbdtransf_dbt bdtransf, dpmsend_dbt pmsend,  " +
                "      ddp_dep_dbt dp_dep_dep, ddp_dep_dbt dp_dep_br, dparty_dbt party_dep, dparty_dbt party_br " +
                " where ggrep.t_ObjectType = 536/*OBJTYPE_BDTRANSF*/ " +
                "   and bdtransf.t_BdTransfID = ggrep.t_ObjectID " +
                "   and ggrep.t_ObjectType = objects.t_ObjectType " +
                "   and pmsend.t_ID = ggrep.t_MesID " +
                "   and dp_dep_dep.t_Code(+) = ggrep.t_Department " +
                "   and party_dep.t_PartyID(+) = dp_dep_dep.t_PartyID " +
                "   and dp_dep_br.t_Code(+) = ggrep.t_Branch " +
                "   and party_br.t_PartyID(+) = dp_dep_br.t_PartyID " +
                ") " +
                " order by t_Dep, t_Branch, t_ObjectType, t_ReqID ";                                                      
    var rs:RsdRecordset = execSQLselect(query);

    return rs;
  end;

  private macro GetRepDescr():string
    var RepDescr : string = "";
    if( RepType == GGPIPmSendReqsGeneratingReportType_Generating )
      RepDescr = "ä®à¬¨à®¢ ­¨ï § ¯à®á®¢, ª®â®àë¥ ¤®«¦­ë ¡ëâì ¯¥à¥¤ ­ë ¢ RS-Connect ¤«ï ƒˆ‘ ƒŒ";
    elif( RepType == GGPIPmSendReqsGeneratingReportType_Transfer )
      RepDescr = "¯¥à¥¤ ç¨ á¢¥¤¥­¨© ¢ RS-Connect ¤«ï ƒˆ‘ ƒŒ";
    end;
    return RepDescr;
  end;

  macro Construct( _RepType )
    RepType = _RepType;
    var Directory : string = Bnk_GetRegistryValue( RegPath_RepDir, V_STRING, "..\\txtfile\\RS_Connect\\GIS GMP" );
    CreateDirectory(Directory);
    if( RepType == GGPIPmSendReqsGeneratingReportType_Generating )
      ReportFileName = Directory + "\\REP_GISGMP_" + DDMMYY( date() ) + "_" + TimeToStr(time(), "HHMISS") + ".txt";
      // ¥á«¨ ­ §¢ ­¨¥ á®¢¯ ¤¥â á â®ç­®áâìî ¤® á¥ªã­¤ë, ¯à®¡ã¥¬ ¥é¥ à §
      while( FileExists( ReportFileName ) )
        ReportFileName = Directory + "\\REP_GISGMP_" + DDMMYY( date() ) + "_" + TimeToStr(time(), "HHMISS") + ".txt";
      end;
    elif( RepType == GGPIPmSendReqsGeneratingReportType_Transfer )
      ReportFileName = Directory + "\\REP_GISGMP_CONNECT_" + DDMMYY( date() ) + "_" + TimeToStr(time(), "HHMISS") + ".txt";
      // ¥á«¨ ­ §¢ ­¨¥ á®¢¯ ¤¥â á â®ç­®áâìî ¤® á¥ªã­¤ë, ¯à®¡ã¥¬ ¥é¥ à §
      while( FileExists( ReportFileName ) )
        ReportFileName = Directory + "\\REP_GISGMP_CONNECT_" + DDMMYY( date() ) + "_" + TimeToStr(time(), "HHMISS") + ".txt";
      end;
    end;
  end;

  macro PrintHeader()
    [
     âç¥â ® à¥§ã«ìâ â å ################################################################################

     ˆá¯®«­¨â¥«ì ##### ##################################################
     „ â  ®âç¥â  ##########

     
    ]( GetRepDescr(), {oper}, GetOperName( {oper} ), {curdate} );
  end;

  macro PrintTableHeader( Department:string, DepartmentName:string )
    [ ”¨«¨ « ########## ####################################################################################################
    ]( Department, DepartmentName );
    if( RepType == GGPIPmSendReqsGeneratingReportType_Generating )
      [
       ÚÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
       ³  N  ³   „ â    ³      ‚¨¤      ³ ID ¤®ª-â  ³    ‘ç¥â ¯« â¥«ìé¨ª      ³            ®«ãç â¥«ì             ³               ³                                                  ³    ID     ³                                                  ³
       ³ ¤®ª ³  ¤®ªã¬.  ³     ¤®ªã¬.    ³           ³                         ÃÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´     ‘ã¬¬      ³                §­ ç¥­¨¥ ¯« â¥¦                  ³  § ¯à®á   ³              ¥§ã«ìâ â ®¡à ¡®âª¨                 ³
       ³     ³          ³               ³           ³                         ³   ˆŠ   ³           ‘ç¥â          ³               ³                                                  ³           ³                                                  ³
       ÃÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
      ]
    else
      [
       ÚÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
       ³  N  ³   „ â    ³      ‚¨¤      ³ ID ¤®ª-â  ³    ‘ç¥â ¯« â¥«ìé¨ª      ³            ®«ãç â¥«ì             ³               ³                                                  ³    ID     ³                                      ³                                                  ³
       ³ ¤®ª ³  ¤®ªã¬.  ³     ¤®ªã¬.    ³           ³                         ÃÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´     ‘ã¬¬      ³                §­ ç¥­¨¥ ¯« â¥¦                  ³  § ¯à®á   ³       ID ¨§¢¥é¥­¨ï ¢ RS-Connect      ³               ¥§ã«ìâ â ®¡à ¡®âª¨                ³
       ³     ³          ³               ³           ³                         ³   ˆŠ   ³           ‘ç¥â          ³               ³                                                  ³           ³                                      ³                                                  ³
       ÃÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
      ]
    end;
  end;
    
  macro PrintBranch( Branch:string, BranchName:string )
    if( RepType == GGPIPmSendReqsGeneratingReportType_Generating )
      [ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
       ³ ‚‘ ########## ####################################################################################################                                                                                                                        ³
       ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´]
      ( Branch, BranchName ); 
    else
      [ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
       ³ ‚‘ ########## ####################################################################################################                                                                                                                                                               ³
       ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´]
      ( Branch, BranchName ); 
    end;
  end;

  macro PrintData( rs:RsdRecordSet )
    if( RepType == GGPIPmSendReqsGeneratingReportType_Generating )
      [³#####³##########³###############³###########³#########################³#########³#########################³###############³##################################################³###########³##################################################³
      ]( rs.Value("t_Number"), 
         date(rs.Value("t_Date")), 
         rs.Value("t_Kind"), 
         rs.Value("t_PayID"), 
         rs.Value("t_PayerAcc"), 
         rs.Value("t_RecBIC"), 
         rs.Value("t_ReceiverAcc"), 
         rs.Value("t_Amount"),
         rs.Value("t_Ground"):w, 
         rs.Value("t_ReqID"), 
         rs.Value("t_Result"):w );
    else
      [³#####³##########³###############³###########³#########################³#########³#########################³###############³##################################################³###########³######################################³##################################################³
      ]( rs.Value("t_Number"), 
         date(rs.Value("t_Date")), 
         rs.Value("t_Kind"), 
         rs.Value("t_PayID"), 
         rs.Value("t_PayerAcc"), 
         rs.Value("t_RecBIC"), 
         rs.Value("t_ReceiverAcc"), 
         rs.Value("t_Amount"),
         rs.Value("t_Ground"):w, 
         rs.Value("t_ReqID"),
         rs.Value("t_MessID"), 
         rs.Value("t_Result"):w );
    end;
  end;

  macro PrintBottom()
    if( RepType == GGPIPmSendReqsGeneratingReportType_Generating )
      [ÀÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
      ]
    else
      [ÀÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
      ]
    end;
  end;

  macro PrintReport()
    var DepPrev:integer = 0;
    PrintHeader();
    var rs = GetRsdRecordSet();
    var isData = false;
    while( rs and rs.moveNext() )
      isData = true;
      if( rs.Value("t_Dep") != DepPrev )
        PrintTableHeader( rs.Value("t_Dep"), rs.Value("t_DepName") );
        DepPrev = rs.Value("t_Dep");      
      end;
      if( rs.Value("t_Branch") != rs.Value("t_Dep") )
        PrintBranch( rs.Value("t_Branch"), rs.Value("t_BranchName") );
      end;
      PrintData( rs );
    end;
    if( isData )
      PrintBottom();
    else
      [ ¥ ­ ©¤¥­ë á¢¥¤¥­¨ï, ª®â®àë¥ ­¥®¡å®¤¨¬® ¯¥à¥¤ âì ¢ RS-Connect ¤«ï ƒˆ‘ ƒŒ
      ];
    end;
  end;

  macro GetReportFileName():string
    return ReportFileName;
  end;

  Construct( _RepType );
end;


/********************************************************************************************************************
 à®â®ª®« ¢ë¯®«­¥­¨ï ¯à®æ¥¤ãàë § ¯à®á  áâ âãá  ¨§¢¥é¥­¨ï ¢ RS-Connect
*********************************************************************************************************************/

class TGGPmSendNotificationStatusRequestReport()
  var ReportFileName : string;

  private macro GetRsdRecordSet():RsdRecordSet
    var query = "( "
                " select ggrep.t_Department as t_Dep, party_dep.t_Name as t_DepName, ggrep.t_Branch as t_Branch, party_br.t_Name as t_BranchName, " +
                "        ggrep.t_ObjectID as t_PayID, objects.t_Name as t_Kind, ggrep.t_MesID as t_ReqID, pmsend.t_ExtObjectID as t_MessID, llvalues_state.t_Name as t_MessStatus, " +
                "        pmsend.t_ExtStateDescr as t_MessStatusText, ggrep.t_Result as t_Result, rm.t_Number as t_Number, rm.t_Date as t_Date, ggrep.t_ObjectType as t_ObjectType, " +
                "        llvalues_act.t_Name as t_ServKind " +
                " from dggrep_tmp ggrep, dobjects_dbt objects, dpmpaym_dbt pm, dpmrmprop_dbt rm, dpmprop_dbt prop, dpmsend_dbt pmsend, " +
                "      ddp_dep_dbt dp_dep_dep, ddp_dep_dbt dp_dep_br, dparty_dbt party_dep, dparty_dbt party_br, dllvalues_dbt llvalues_state, dllvalues_dbt llvalues_act " +
                " where ggrep.t_ObjectType = 501/*OBJTYPE_PAYMENT*/ " +
                "   and pm.t_PaymentID = ggrep.t_ObjectID " +
                "   and rm.t_PaymentID = pm.t_PaymentID " +
                "   and prop.t_PaymentID = pm.t_PaymentID " +
                "   and prop.t_DebetCredit = 1/*PRT_CREDIT*/ " +
                "   and ggrep.t_ObjectType = objects.t_ObjectType " +
                "   and pmsend.t_ID = ggrep.t_MesID " +
                "   and dp_dep_dep.t_Code = ggrep.t_Department " +
                "   and party_dep.t_PartyID = dp_dep_dep.t_PartyID " +
                "   and dp_dep_br.t_Code = ggrep.t_Branch " +
                "   and party_br.t_PartyID = dp_dep_br.t_PartyID " +
                "   and llvalues_state.t_Code(+) = pmsend.t_ExtState " +
                "   and llvalues_state.t_List(+) = 2125/*OBJTYPE_GISGMP_MSGSTATE*/ " +
                "   and llvalues_act.t_Element(+) = pmsend.t_Action " +
                "   and llvalues_act.t_List(+) = 2124/*OBJTYPE_ES_KINDSERVISES*/ " +
                ") " +
                " union " +
                "( " +
                " select ggrep.t_Department as t_Dep, party_dep.t_Name as t_DepName, ggrep.t_Branch as t_Branch, party_br.t_Name as t_BranchName, " +
                "        ggrep.t_ObjectID as t_PayID, objects.t_Name as t_Kind, ggrep.t_MesID as t_ReqID, pmsend.t_ExtObjectID as t_MessID, llvalues_state.t_Name as t_MessStatus, " +
                "        pmsend.t_ExtStateDescr as t_MessStatusText, ggrep.t_Result as t_Result, bdtransf.t_Number as t_Number, bdtransf.t_Date as t_Date, ggrep.t_ObjectType as t_ObjectType, " +
                "        llvalues_act.t_Name as t_ServKind " +
                " from dggrep_tmp ggrep, dobjects_dbt objects, dbdtransf_dbt bdtransf, dpmsend_dbt pmsend,  " +
                "      ddp_dep_dbt dp_dep_dep, ddp_dep_dbt dp_dep_br, dparty_dbt party_dep, dparty_dbt party_br, dllvalues_dbt llvalues_state, dllvalues_dbt llvalues_act " +
                " where ggrep.t_ObjectType = 536/*OBJTYPE_BDTRANSF*/ " +
                "   and bdtransf.t_BdTransfID = ggrep.t_ObjectID " +
                "   and ggrep.t_ObjectType = objects.t_ObjectType " +
                "   and pmsend.t_ID = ggrep.t_MesID " +
                "   and dp_dep_dep.t_Code = ggrep.t_Department " +
                "   and party_dep.t_PartyID = dp_dep_dep.t_PartyID " +
                "   and dp_dep_br.t_Code = ggrep.t_Branch " +
                "   and party_br.t_PartyID = dp_dep_br.t_PartyID " +
                "   and llvalues_state.t_Code(+) = pmsend.t_ExtState " +
                "   and llvalues_state.t_List(+) = 2125/*OBJTYPE_GISGMP_MSGSTATE*/ " +
                "   and llvalues_act.t_Element(+) = pmsend.t_Action " +
                "   and llvalues_act.t_List(+) = 2124/*OBJTYPE_ES_KINDSERVISES*/ " +
                ") " +
                " order by t_Dep, t_Branch, t_ObjectType, t_ReqID ";                                                      
    var rs:RsdRecordset = execSQLselect(query);

    return rs;
  end;
  
  macro Construct()
    var Directory : string = Bnk_GetRegistryValue( RegPath_RepDir, V_STRING, "..\\txtfile\\RS_Connect\\GIS GMP" );
    CreateDirectory(Directory);
    ReportFileName = Directory + "\\REPSTATUS_GISGMP_CONNECT_" + DDMMYY( date() ) + "_" + TimeToStr(time(), "HHMISS") + ".txt";
    // ¥á«¨ ­ §¢ ­¨¥ á®¢¯ ¤¥â á â®ç­®áâìî ¤® á¥ªã­¤ë, ¯à®¡ã¥¬ ¥é¥ à §
    while( FileExists( ReportFileName ) )
      ReportFileName = Directory + "\\REPSTATUS_GISGMP_CONNECT_" + DDMMYY( date() ) + "_" + TimeToStr(time(), "HHMISS") + ".txt";
    end;
  end;
    
  macro PrintHeader()
    [
     âç¥â ® à¥§ã«ìâ â å § ¯à®á  áâ âãá  ¨§¢¥é¥­¨© ¯® ¯« â¥¦ ¬ ¢ RS-Connect

     ˆá¯®«­¨â¥«ì ##### ##################################################
     „ â  ®âç¥â  ##########

     
    ]( {oper}, GetOperName( {oper} ), {curdate} );
  end;

  macro PrintTableHeader( Department:string, DepartmentName:string )
    [ ”¨«¨ « ########## ####################################################################################################
    ]( Department, DepartmentName );

    [
     ÚÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
     ³       ³    „ â     ³                 ³            ³                      ³            ³                                       ³                      ³                                                    ³                                                    ³
     ³ N ¤®ª ³   ¤®ªã¬.   ³    ‚¨¤ ¤®ªã¬.   ³ ID ¤®ª-â   ³     ‚¨¤ á¢¥¤¥­¨©     ³ ID § ¯à®á  ³       ID ¨§¢¥é¥­¨ï ¢ RS-Connect       ³   ‘â âãá ¨§¢¥é¥­¨ï   ³                  ¯¨á ­¨¥ áâ âãá                   ³                ¥§ã«ìâ â ®¡à ¡®âª¨                 ³
     ³       ³            ³                 ³            ³                      ³            ³                                       ³                      ³                                                    ³                                                    ³
     ÃÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
    ];                                                                                                                                                                                                           
  end;
    
  macro PrintBranch( Branch:string, BranchName:string )
    [ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
     ³ ‚‘ ########## ####################################################################################################                                                                                                                                            ³
     ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´]
    ( Branch, BranchName ); 
  end;

  macro PrintData( rs:RsdRecordSet )
    var isStateUpdated = Index( rs.Value("t_Result"), "‘â âãá ¨§¢¥é¥­¨ï ¢ RS-Connect ­¥ ¡ë« ®¡­®¢«¥­" );
    [³ ##### ³ ########## ³ ############### ³ ########## ³ #################### ³ ########## ³ ##################################### ³ #################### ³ ################################################## ³ ################################################## ³
    ]( rs.Value("t_Number"), 
       date(rs.Value("t_Date")), 
       rs.Value("t_Kind"), 
       rs.Value("t_PayID"), 
       rs.Value("t_ServKind"), 
       rs.Value("t_ReqID"), 
       rs.Value("t_MessID"), 
       IfThenElse( isStateUpdated == 0, rs.Value("t_MessStatus"), " "),
       IfThenElse( isStateUpdated == 0, rs.Value("t_MessStatusText"), " "):w, 
       rs.Value("t_Result"):w );
  end;

  macro PrintBottom()
    [ÀÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
    ]
  end;

  macro PrintReport()
    var DepPrev:integer = 0;
    PrintHeader();
    var rs = GetRsdRecordSet();
    var isData = false;
    while( rs and rs.moveNext() )
      isData = true;
      if( rs.Value("t_Dep") != DepPrev )
        PrintTableHeader( rs.Value("t_Dep"), rs.Value("t_DepName") );
        DepPrev = rs.Value("t_Dep");      
      end;
      if( rs.Value("t_Branch") != rs.Value("t_Dep") )
        PrintBranch( rs.Value("t_Branch"), rs.Value("t_BranchName") );
      end;
      PrintData( rs );
    end;
    if( isData )
      PrintBottom();
    else
      [ ¥ ­ ©¤¥­ë á¢¥¤¥­¨ï, ¯® ª®â®àë¬ âà¥¡ã¥âáï § ¯à®á¨âì áâ âãá ¨§¢¥é¥­¨ï ¢ RS-Connect
      ];
    end;
  end;

  macro GetReportFileName():string
    return ReportFileName;
  end;

  Construct();
end;

class (TSwitchOutput) TSwitchOutputGisGmp( ReportFileName )
  InitTSwitchOutput( ReportFileName );
end;