/*
  $Name:         mnssbcal.mac
  $Module:       МБР
  $Description:  Функции для сообщений SBC
*/

//-----------------------------------------------------------------------------
//          Автоматизированная банковская система RS-Bank               
//                 Copyright (c) R-Style Software Lab
//
// Подсистема   : Межбанковские расчеты
//
// Описание     : Функции для сообщений SBC
//
// Программист  : Чукина Т.А.
//
// Создан       : 13.05.2014
//
//-----------------------------------------------------------------------------

import oralib, likepy, CTInter, PTInter, "bnk_common.mac", "xmlmestools.mac", 
       "adress.mac", "bnk_ptlib.mac", "wlmnstls.mac", PSInter, FIInter, BankInter,
       "fnsgenmesx.mac", "fnsaccmsg_lib.mac", pm_tools;

// Формирование поля  "ВидСч"
private macro GetAccKindFld
( AccClient : integer, 
  Type_Account : string, 
  buff, 
  AccMsgKind : integer

) : string

  var AccKindName : string = "";

  if( GetKindActionFNS() == KIND_ACTION_FNS_NULL )
    AccKindName = ПолучитьПолеДляАннул( "ВидСч" );

  elif( buff.Origin != REQ_ACC_ORIGIN_PS )
    AccKindName = GetAccKindFld_BO(buff, AccMsgKind);

  else
    AccKindName = GetAccKindNameGK(AccClient, Type_Account);

  end;

  return AccKindName;
end;

// true - удалось заполнить поля, false - не удалось
private macro WriteTaxPayerRusOrg
( BlockName : string, 
  AccMsgKind : integer,
  INN : string, 
  KPP : string, 
  OGRN : string, 
  OrgName : string,
  ErrMsg : @string

) : bool

  // Check
  if(not INN)
    ErrMsg = "Не задан ИНН для субъекта \"" + OrgName + "\"";
    return FALSE;
  end;
  if(not IsGoodINN_Org(INN))
    ErrMsg = "Неверное значение ИНН: " + INN;
    return FALSE;
  end;

  if(KPP)
    if(not IsGoodKPP(KPP))
      ErrMsg = "Неверное значение КПП: " + KPP;
      return FALSE;
    end;
  elif(AccMsgKind == ACCMSG_KIND_OPEN)
    // Обязательно заполняется в сообщении об открытии счета
    ErrMsg = "Не задан КПП для субъекта \"" + OrgName + "\"";
    return FALSE;
  end;

  if(OGRN)
    if(not IsGoodOGRN_Org(OGRN))
      ErrMsg = "Неверное значение ОГРН: " + OGRN;
      return FALSE;
    end;
  end;

  // write
  StartBlockLogXML(BlockName);

  ЗаписатьПолеЛог("ИННРО", INN);
  
  if(KPP)
    ЗаписатьПолеЛог("КПП", KPP);
  end;

  if(OGRN)
    ЗаписатьПолеЛог("ОГРН", OGRN);
  end;

  ЗаписатьПолеЛог("НаимОрг", OrgName);

  FinishBlockLogXML(BlockName);

  return TRUE;
end;

// Российская организация (НПРОТип)
// true - удалось заполнить поля, false - не удалось
macro WriteRusOrg
( PartyID : integer, 
  BlockName : string, 
  AccMsgKind : integer,
  ErrMsg : @string,
  reqchnga,
  reqopena,
  reqclosa

) : bool

  var INN : string = "", KPP : string = "", OGRN : string = "", OrgName : string;

  // get INN, KPP, OGRN, OrgName
  if( (reqchnga != NULL) AND (reqchnga.ClientName) )
    OrgName = reqchnga.ClientName;
  else
    OrgName = Bnk_GetPartyName(PartyID);
  end;

  if(not OrgName)
    ErrMsg = "Не задано наименование для субъекта " + PartyID;
    return FALSE;
  end;

  if( (reqchnga != NULL) AND (reqchnga.ClientINN) )
    INN = RemoveKPP(reqchnga.ClientINN);
    KPP = RemoveINN(reqchnga.ClientINN);
  elif( (reqopena != NULL) AND (reqopena.ClientINN) )
    INN = RemoveKPP(reqopena.ClientINN);
    KPP = RemoveINN(reqopena.ClientINN);
  elif( (reqclosa != NULL) AND (reqclosa.ClientINN) )
    INN = RemoveKPP(reqclosa.ClientINN);
    KPP = RemoveINN(reqclosa.ClientINN);
  else
    GetINN_KPP(PartyID, @INN, @KPP);
  end;

  if( (reqchnga != NULL) AND (reqchnga.ClientOGRN) )
    OGRN = reqchnga.ClientOGRN;
  elif( (reqopena != NULL) AND (reqopena.ClientOGRN) )
    OGRN = reqopena.ClientOGRN;
  elif( (reqclosa != NULL) AND (reqclosa.ClientOGRN) )
    OGRN = reqclosa.ClientOGRN;
  else
    OGRN = ПолучитьКодСубъекта(PartyID, PTCK_OGRN);
  end;

  // check and write fields
  return WriteTaxPayerRusOrg( BlockName, AccMsgKind, INN, KPP, OGRN, OrgName, @ErrMsg );
end;

// Реквизиты юридического лица до изменения (ИзмНПЮЛТип)
// true - удалось заполнить поля, false - не удалось
macro WriteRusOrgBeforeChng
( PartyID : integer, 
  BlockName : string, 
  ДатаИзмНП : date,
  ErrMsg : @string,
  reqchnga

) : bool

  var INN : string = "", KPP : string = "", OGRN : string = "", OrgName : string;
  var dt : date = ДатаИзмНП - 1;

  // get INN, KPP, OGRN, OrgName
  OrgName = reqchnga.ClientNameOld;

  if(not OrgName)
    ErrMsg = "Не задано наименование для субъекта " + PartyID;
    return FALSE;
  end;
  
  var FullINN : string = reqchnga.ClientINNOld;
  if(not FullINN)
    ErrMsg = "Не задан ИНН для субъекта \"" + OrgName + "\"";
    return FALSE;
  end;
  SplitFullINN(FullINN, INN, KPP);

  OGRN = reqchnga.ClientOGRNOld;

  // check and write fields
  return WriteTaxPayerRusOrg( BlockName, ACCMSG_KIND_CHNG, INN, KPP, OGRN, OrgName, @ErrMsg );
end;

// true - удалось заполнить поля, false - не удалось
private macro WriteTaxPayerIndEmployer
( 
  PartyID : integer,
  BlockName : string, 
  AccMsgKind : integer,
  EntityCode : string,
  INN : string, 
  OGRN : string, 
  SurName : string,
  Name : string,
  ParentName : string,
  ErrMsg : @string

) : bool

  // Check
  var FullName : string = SurName + " " + Name + " " + ParentName;

  if(not INN)
    ErrMsg = "Не задан ИНН для субъекта " + FullName;
    return FALSE;
  end;
  if(not IsGoodINN_Ind(INN))
    ErrMsg = "Неверное значение ИНН: " + INN;
    return FALSE;
  end;

  if(OGRN)
    if(not IsGoodOGRN_IndEmpl(OGRN))
      ErrMsg = "Неверное значение ОГРН: " + OGRN;
      return FALSE;
    end;
  end;

  // write
  StartBlockLogXML(BlockName);

  ЗаписатьПолеЛог("ИННИП", INN);
  
  if(OGRN)
    ЗаписатьПолеЛог("ОГРНИП", OGRN);
  elif( (AccMsgKind == ACCMSG_KIND_OPEN) and
        (not InList(EntityCode, "3", "4", "5"))
      )
    ErrMsg = "Не задан ОГРН для субъекта " + FullName;
    return FALSE;
  end;

  WriteFIO("ФИОИП", SurName, Name, ParentName);

  FinishBlockLogXML(BlockName);

  return TRUE;
end;

// Индивидуальный предприниматель, нотариус, адвокат (НПИПТип)
// true - удалось заполнить поля, false - не удалось
macro WriteIndEmployer
( PartyID : integer, 
  BlockName : string, 
  AccMsgKind : integer,
  EntityCode : string,
  ErrMsg : @string,
  reqchnga,
  reqopena,
  reqclosa

) : bool

  var INN : string = "", OGRN : string = "", 
      SurName : string = "", Name : string = "", ParentName : string = "";

  // get INN, OGRN, SurName, Name, ParentName
  if( not GetDataFIO(PartyID, @SurName, @Name, @ParentName, @ErrMsg, reqchnga, reqopena, reqclosa ) )
    return FALSE;
  end;

  if( reqchnga != NULL )
    INN = RemoveKPP( reqchnga.ClientINN );
    OGRN = reqchnga.ClientOGRN;
  elif( reqopena != NULL )
    INN = RemoveKPP( reqopena.ClientINN );
    OGRN = reqopena.ClientOGRN;
  elif( reqclosa != NULL )
    INN = RemoveKPP( reqclosa.ClientINN );
    OGRN = reqclosa.ClientOGRN;
  else
    INN = GetOnlyINN(PartyID);
    OGRN = ПолучитьКодСубъекта(PartyID, PTCK_OGRN);
  end;

  // check and write fields
  return WriteTaxPayerIndEmployer( PartyID, BlockName, AccMsgKind, EntityCode, INN, OGRN, SurName, Name, ParentName, @ErrMsg );
end;

// Индивидуальный предприниматель, нотариус, адвокат до изменения реквизитов (ИзмНПИПТип)
// true - удалось заполнить поля, false - не удалось
macro WriteIndEmployerBeforeChng
( PartyID : integer, 
  BlockName : string, 
  ДатаИзмНП : date,
  EntityCode : string,
  ErrMsg : @string,
  reqchnga
) : bool

  var INN : string = "", OGRN : string = "", 
      SurName : string = "", Name : string = "", ParentName : string = "";
  var dt : date = ДатаИзмНП - 1;

  // get INN, OGRN, SurName, Name, ParentName
  if( reqchnga != NULL )
    var NameIO = SubStr( reqchnga.ClientName, Index(reqchnga.ClientName, "," ) + 1 );
    SurName = SubStr( reqchnga.ClientName, 1, Index(reqchnga.ClientName, "," ) );
    Name = SubStr( NameIO, 1, Index( NameIO, "," ) );
    ParentName = SubStr( NameIO, Index( NameIO, "," ) + 1 );
  else
    ErrMsg = "Ошибка при получении данных для субъекта " + PartyID;
    return FALSE;
  end;
  
  var FullINN : string = reqchnga.ClientINNOld;
  INN = RemoveKPP(FullINN);

  OGRN = reqchnga.ClientOGRNOld;

  // check and write fields
  return WriteTaxPayerIndEmployer( PartyID, BlockName, ACCMSG_KIND_CHNG, EntityCode, INN, OGRN, SurName, Name, ParentName, @ErrMsg );
end;

// Иностранная организация (НПИОТип)
// true - удалось заполнить поля, false - не удалось
macro WriteForeignOrg
( PartyID : integer, 
  BlockName : string, 
  ErrMsg : @string,
  reqchnga,
  reqopena,
  reqclosa

) : bool

  var INN : string = "", KPP : string = "", OGRN : string = "", OrgName : string;

  // get INN, KPP, OGRN, OrgName
  if(reqchnga != NULL)
    OrgName = reqchnga.ClientName;
  elif(reqopena != NULL)
    OrgName = reqopena.ClientName;
  elif(reqclosa != NULL)
    OrgName = reqclosa.ClientName;
  else
    OrgName = Bnk_GetPartyName(PartyID);  
  end;
  
  if(not OrgName)
    ErrMsg = "Не задано наименование для субъекта " + PartyID;
    return FALSE;
  end;

  if( (reqchnga != NULL) AND (reqchnga.ClientINN) )
    INN = RemoveKPP(reqchnga.ClientINN);
    KPP = RemoveINN(reqchnga.ClientINN);
  elif( (reqopena != NULL) AND (reqopena.ClientINN) )
    INN = RemoveKPP(reqopena.ClientINN);
    KPP = RemoveINN(reqopena.ClientINN);
  elif( (reqclosa != NULL) AND (reqclosa.ClientINN) )
    INN = RemoveKPP(reqclosa.ClientINN);
    KPP = RemoveINN(reqclosa.ClientINN);  
  else
    GetINN_KPP(PartyID, @INN, @KPP);
  end;
  
  if( (reqchnga != NULL) AND (reqchnga.ClientOGRN) )
    OGRN = reqchnga.ClientOGRN;
  elif( (reqopena != NULL) AND (reqopena.ClientOGRN) )
    OGRN = reqopena.ClientOGRN;
  elif( (reqclosa != NULL) AND (reqclosa.ClientOGRN) )
    OGRN = reqclosa.ClientOGRN;
  else
    OGRN = ПолучитьКодСубъекта(PartyID, PTCK_OGRN);
  end;

  // check
  if(OGRN)
    if(not IsGoodOGRN_Org(OGRN))
      ErrMsg = "Неверное значение ОГРН: " + OGRN;
      return FALSE;
    end;
  end;

  if(KPP)
    if(not IsGoodKPP(KPP))
      ErrMsg = "Неверное значение КПП: " + KPP;
      return FALSE;
    end;
  end;

  if(not INN)
    ErrMsg = "Не задан ИНН или КИО для субъекта \"" + OrgName + "\"";
    return FALSE;
  end;
  if( strlen(INN) == 5 )
    if(not IsGoodKIO(INN))
      ErrMsg = "Неверное значение КИО: " + INN;
      return FALSE;
    end;
  else
    if(not IsGoodINN_Org(INN))
      ErrMsg = "Неверное значение ИНН: " + INN;
      return FALSE;
    end;
  end;

  // write fields
  StartBlockLogXML(BlockName);

  ЗаписатьПолеЛог("НаимОрг", OrgName);
  if(OGRN)
    ЗаписатьПолеЛог("ОГРН", OGRN);
  end;
  if(KPP)
    ЗаписатьПолеЛог("КПП", KPP);
  end;
  if( strlen(INN) == 5 )
    WriteFieldLogXML("КИО", INN, true);
  else
    WriteFieldLogXML("ИННИО", INN, true);
  end;

  FinishBlockLogXML(BlockName);

  return TRUE;
end;

// Лицо без ИНН (НетИННТип)
// true - удалось заполнить поля, false - не удалось
macro WritePartyNoINN
( PartyID : integer, 
  BlockName : string, 
  ErrMsg : @string,
  reqchnga,
  reqopena,
  reqclosa
) : bool

  var IsLegalFormPersn : bool = IsPerson(PartyID), 
      OGRN : string = "",
      OrgName : string = "", 
      SurName : string = "", Name : string = "", ParentName : string = "";

  if(IsLegalFormPersn)
    if( not GetDataFIO(PartyID, @SurName, @Name, @ParentName, @ErrMsg) )
      return FALSE;
    end;
  else
    if(reqchnga != NULL)
      OrgName = reqchnga.ClientName;
    elif(reqopena != NULL)
      OrgName = reqopena.ClientName;
    elif(reqclosa != NULL)
      OrgName = reqclosa.ClientName;
    else
      OrgName = Bnk_GetPartyName(PartyID);  
    end;
    
    if(not OrgName)
      ErrMsg = "Не задано наименование для субъекта " + PartyID;
      return FALSE;
    end;
  end;

  // write
  StartBlockLogXML(BlockName);

  if( (reqchnga != NULL) AND (reqchnga.ClientOGRN) )
    OGRN = reqchnga.ClientOGRN;
  elif( (reqopena != NULL) AND (reqopena.ClientOGRN) )
    OGRN = reqopena.ClientOGRN;
  elif( (reqclosa != NULL) AND (reqclosa.ClientOGRN) )
    OGRN = reqclosa.ClientOGRN;
  else
    OGRN = ПолучитьКодСубъекта(PartyID, PTCK_OGRN);
  end; 

  if(OGRN)
    ЗаписатьПолеЛог("ОГРН", OGRN);
  end;

  if(IsLegalFormPersn)
    WriteFIO("ФИОИП", SurName, Name, ParentName);
  else
    ЗаписатьПолеЛог("НаимОрг", OrgName);
  end;

  FinishBlockLogXML(BlockName);

  return TRUE;
end;

private macro WriteTaxRegistration(TaxPayer : integer, FieldName : string)

  if( GetKindActionFNS() == KIND_ACTION_FNS_NULL )
    ЗаписатьПолеДляАннул( FieldName, GetOldfnsMessageID() );
  else
    var Серия : string = "", Номер : string = "", RegDocKind : integer = 0, 
        ДатаРегистрации : date = date(), RegDocKindName : string = "";

    if(FieldName == "СвидНУ")
      RegDocKind = СвидетельствоОПостановкеНаУчет;
      RegDocKindName = "Свидетельство о постановке на учет";
    else // "СвидГР"
      RegDocKind = СвидетельствоГосРегистрации;
      RegDocKindName = "Свидетельство о госрегистрации";
    end;

    var ИДГНИКлиента = ПолучитьИДГНИ(TaxPayer, Серия, Номер, ДатаРегистрации, RegDocKind);

    if( (Серия != "") and (Номер != "") )
      if( (strlen(Серия) != 2) or not StrIsNumber(Серия) )
        RsbThrow("В документе регистрации \"" + RegDocKindName + "\" неверное значение серии");
      end;

      var NumLen : integer = strlen(Номер);
      if( (NumLen < 7) or (NumLen > 9) or not StrIsNumber(Номер) )
        RsbThrow("В документе регистрации \"" + RegDocKindName + "\" неверное значение номера");
      end;

      ЗаписатьПолеЛог( FieldName, string(Серия, ",", Номер) );
    end;
  end;

end;

private macro ЗаполнятьСвидГР(NotResident : string, AttrPartyType : integer) : bool
  if( (NotResident == "X") or
      (AttrPartyType == PARTY_ATTR_PTTYPE_NOTARIUS) or
      (AttrPartyType == PARTY_ATTR_PTTYPE_ADVOCAT)
    )
    return FALSE; // не заполняется
  end;

  return TRUE;
end;

private macro IsNotINN
( ClientID : integer,
  LegalForm : integer,
  NotResident : string,
  IsIndividEmployer : bool,
  AttrPartyType : integer,
  AccOpenDate : date

) : bool

  var INN : string = GetOnlyINN(ClientID);
  if(INN)
    return FALSE;
  end;

  if( (NotResident != "X") and 
      (LegalForm == PTLEGF_INST) and 
      (AccOpenDate < date(22, 9, 1994))
    )
    return TRUE;
  end;

  if( (NotResident != "X") and 

      ( (LegalForm == PTLEGF_INST) or
        (LegalForm == PTLEGF_PERSN) and IsIndividEmployer or
        (LegalForm == PTLEGF_PERSN) and (AttrPartyType == PARTY_ATTR_PTTYPE_NOTARIUS) or
        (LegalForm == PTLEGF_PERSN) and (AttrPartyType == PARTY_ATTR_PTTYPE_KFH)
      ) and

      (AccOpenDate < date(22, 9, 1996))
    )
    return TRUE;
  end;

  if( (LegalForm == PTLEGF_PERSN) and (AttrPartyType == PARTY_ATTR_PTTYPE_ADVOCAT) and
      (AccOpenDate < date(1, 1, 2004))
    )
    return TRUE;
  end;

  return FALSE;
end;

// Выбрать блок, который будем заполнять в элементе СвНП
private macro GetTaxPayerChoice
( EntityCode : string, 
  AccMsgKind : integer,
  ClientID : integer, 
  LegalForm : integer, 
  NotResident : string, 
  IsIndividEmployer : bool, 
  AttrPartyType : integer, 
  AccOpenDate : date

) : string

  var Code : integer = int(EntityCode);

  if(Code == 1)
    return "НПРО";

  elif((Code >= 2) and (Code <= 5))

    if( (AccMsgKind == ACCMSG_KIND_CLOSE) and 
        IsNotINN(ClientID, LegalForm, NotResident, IsIndividEmployer, AttrPartyType, AccOpenDate)
      )
      return "НетИНН";
    else
      return "НПИП";
    end;

  elif(Code == 6)
    return "НПИО";
  end;

  RunError("Ошибка программирования: неверное значение параметра EntityCode");
end;

// Сведения о налогоплательщике (СвНП)
macro WriteTaxPayerInfo
( ClientID : integer, 
  AccMsgKind : integer, 
  AccOpenDate : date, 
  ClientType311 : string,
  EntityCode : @string,
  reqchnga,
  reqopena,
  reqclosa
)

  var BlockName : string = "СвНП", ErrMsg : string = "";

  var LegalForm : integer = PTLEGF_ALL,
      IsIndividEmployer : bool = false,
      NotResident : string = "",
      AttrPartyType : integer = 0; // значение категории "Тип субъекта"

  if( ClientID > 0 )
    if( not GetTaxPayerPartyData(ClientID, @LegalForm, @IsIndividEmployer, @AttrPartyType, @NotResident) )
      RunError("Не найден субъект " + ClientID);
    end;
  end;

  EntityCode = GetEntityCodeFld
    ( LegalForm, 
      NotResident, 
      IsIndividEmployer, 
      AttrPartyType, 
      ClientType311 );

  StartBlockLogXML(BlockName);

  ЗаписатьПолеЛог("КодЛица", EntityCode);

  if( (AccMsgKind == ACCMSG_KIND_OPEN) or (AccMsgKind == ACCMSG_KIND_CLOSE) )
    WriteTaxRegistration(ClientID, "СвидНУ");
  end;

  var Choice : string = GetTaxPayerChoice( EntityCode, AccMsgKind,
                                           ClientID, LegalForm, NotResident, 
                                           IsIndividEmployer, AttrPartyType, AccOpenDate
                                         );
  if(Choice == "НПРО")
    if( not WriteRusOrg(ClientID, "НПРО", AccMsgKind, @ErrMsg, reqchnga, reqopena, reqclosa) )
      RunError(ErrMsg);
    end;
  elif(Choice == "НПИП")
    if( not WriteIndEmployer(ClientID, "НПИП", AccMsgKind, EntityCode, @ErrMsg, reqchnga, reqopena, reqclosa ) )
      RunError(ErrMsg);
    end;
  elif(Choice == "НПИО")
    if( not WriteForeignOrg(ClientID, "НПИО", @ErrMsg, reqchnga, reqopena, reqclosa) )
      RunError(ErrMsg);
    end;
  elif(Choice == "НЕТИНН")
    if( not WritePartyNoINN(ClientID, "НЕТИНН", @ErrMsg, reqchnga, reqopena, reqclosa) )
      RunError(ErrMsg);
    end;
  else
    RunError("Ошибка программирования: функция GetTaxPayerChoice вернула неверное значение");
  end;

  FinishBlockLogXML(BlockName);
end;

macro ПолучитьСчетСВалютой(buff, Открытие, Счет, Валюта )
  record AccIn(account);
  record AccOut(account);
  FILE reqlinka(reqlinka) key 0;

  Var ТипСчета; 
  var rs:object;
  var select:string;
  var params:TArray;

  ТипСчета = GetAccountType();
  if(ТипСчета == -1)
    SetParm(2, buff.Account);
    SetParm(3, buff.Code_Currency);
    return;
  end;
  if(not Открытие)/*закрыт*/
     AccIn.Chapter = 1;
     AccIn.Account = buff.Account;
     AccIn.Code_Currency = buff.Code_Currency;
     select = "select t_AttrID from dobjlink_dbt where t_ObjectType = :OBJTYPE_ACCOUNT"+
                    " and t_ObjectID = :OBID"
                    " and t_GroupID = :TypeScore and t_AttrType = :OBJTYPE_ACCOUNT"; 

     params = makeArray( SQLParam("OBJTYPE_ACCOUNT", OBJTYPE_ACCOUNT),
                         SQLParam("OBID",UniID( AccIn, OBJTYPE_ACCOUNT )),
                         SQLParam("TypeScore",ТипСчета ));
     rs = execSQLselect( select, params, FALSE );
     if( rs.MoveNext())
        RestoreFromUniID(rs.Value(0), AccOut, OBJTYPE_ACCOUNT);
        SetParm(2, AccOut.Account);
        SetParm(3, AccOut.Code_Currency);
     else
        RunError("Не найден связанный счет");
     end;
  else
     ClearRecord(reqlinka);
     reqlinka.DocKind   = PS_REQOPENA;
     reqlinka.RequestID = buff.RequestID;
     reqlinka.GroupID   = ТипСчета;
     reqlinka.Action    = 0;
     if(not getEQ(reqlinka))
        RunError("Не найден связанный счет");
     else
        SetParm(2, reqlinka.Account);
        SetParm(3, reqlinka.Code_Currency);
        if( ТипСчета == 6 )
          buff.Type_Account = "Y";
        end;
     end;
  end;
end;

// ДатаОткрСч
macro GetAccOpenDateFldVal( Счет : string, Валюта : integer, AccOpenDate : date, 
                            buff, AccMsgKind : integer ) : string

  var OpenDateStr : string = "";

  if( GetKindActionFNS() == KIND_ACTION_FNS_NULL )
    OpenDateStr = ПолучитьПолеДляАннул( "ДатаОткрСч" );

  elif( buff.Origin != REQ_ACC_ORIGIN_PS )
    OpenDateStr = GetAccOpenDateFldVal_BO(buff, AccMsgKind);

  else
    var OpenDate : date = date(0,0,0);

    var Note : string = ReadNoteForAccount(Счет, Валюта, 42); //42 = ACC_NOTE_KIND_DATE_CHANGE_TO_SETTLEMENT
    if(Note != "") 
      OpenDate = date(StrSubst(Note, " ", "0"));
    else
      if( AccOpenDate != date(0,0,0) )
        OpenDate = AccOpenDate;
      else
        OpenDate = {curdate};
      end;
    end;

    OpenDateStr = DDpMMpYYYY(OpenDate);
  end;

  return OpenDateStr;
end;

// атрибуты элемента СвСчет
macro WriteAccInfoAttrs(Счет : string, Валюта : integer, GenAcc, buff, AccMsgKind : integer)
  WriteFieldWithCheckAnnul( "НомСч", Счет );
  ЗаписатьПолеЛог( "ДатаОткрСч", GetAccOpenDateFldVal(Счет, Валюта, GenAcc.Open_Date, buff, AccMsgKind) );
  ЗаписатьПолеЛог( "ВидСч", GetAccKindFld(GenAcc.Client, GenAcc.Type_Account, buff, AccMsgKind) );
  ЗаписатьПолеЛог( "ВалСч", GetAccCurFldVal(Валюта) );
end;

// ДатаЗаклДог
macro ЗаписатьПоле_ДатаЗаклДог( DateOpen : date, UnionContrID : integer, 
                                Счет : string, Валюта : integer, buff )

  record SfCntr(sfcontr);

  if( GetKindActionFNS() == KIND_ACTION_FNS_NULL )
    ЗаписатьПолеДляАннул("ДатаЗаклДог", GetOldfnsMessageID());
  elif( buff.Origin == REQ_ACC_ORIGIN_LOANS )
    ЗаписатьПолеЛог( "ДатаЗаклДог", DDpMMpYYYY( buff.SfContrDate ) );
  else
    var ContractDate : date = DateOpen;

    if( UnionContrID != 0 )
      var select = "select t_DateConc from dsfunioncontr_dbt sfcontr" +                           //если у договора обслуживания счета есть связанный сводный договор,
                   " where sfcontr.t_unioncontrid = :UNIONCONTRID";                               //то заполняем ДатаРастДог датой заключения сводного договора

      var params = makeArray( SQLParam("UNIONCONTRID", UnionContrID) );
      var rs = execSQLselect( select, params );

      if( rs and rs.MoveNext() )
        ContractDate = date(rs.Value(0));
      end;
    elif( ПолучитьДоговорОбслуживания(Валюта, Счет, SfCntr) == 0 )
      ContractDate = SfCntr.DateConc;
    end;

    ЗаписатьПолеЛог( "ДатаЗаклДог", DDpMMpYYYY( ContractDate ) );
  end;
end;

macro ЗаписатьПоле_ДатаЗакрСч(AccCloseDate : date)

  if( GetKindActionFNS() == KIND_ACTION_FNS_NULL )
    ЗаписатьПолеДляАннул( "ДатаЗакрСч", GetOldfnsMessageID() );
  else
    var CloseDate : date = AccCloseDate;

    if( CloseDate == date(0,0,0) )
      CloseDate = {curdate};
    end;

    ЗаписатьПолеЛог( "ДатаЗакрСч", DDpMMpYYYY(CloseDate) );
  end;

end;

macro GetSfUnionContrCloseDate
(
  UnionContrID : integer, 
  SfUnionContrCloseDate : @date

) : bool

  if(UnionContrID != 0)                                                     
                                                                                   
    var select : string = 
             "select t_DateClose from dsfunioncontr_dbt sfcontr"+ 
             " where sfcontr.t_unioncontrid = :UNIONCONTRID";

    var params : TArray = makeArray( SQLParam("UNIONCONTRID", UnionContrID) );
    var rs : RsdRecordset = execSQLselect( select, params );
  
    if( rs and rs.MoveNext() )
      SfUnionContrCloseDate = date( rs.value("t_DateClose") );
      return TRUE;
    end;

  end;

  return FALSE;
end;

private macro AllContractsAreClosed(UnionContrID : integer) : bool
  var select = "select t_DateClose "+
               "  from dsfcontr_dbt sfcontr"+ 
               " where sfcontr.t_unioncontrid = :UNIONCONTRID"+
               "   and sfcontr.t_DateClose = :ZeroDate ";
    
  var params = makeArray( SQLParam("UNIONCONTRID", UnionContrID),
                          SQLParam("ZeroDate", date(0, 0, 0)) );
  if( existsSQLselect(select, params) )
    return FALSE;
  end;

  return TRUE;
end;

private macro GetContractCloseDate
( reqclosa, 
  SfCntrBuf, 
  IsSfUnionContr : bool, // необязательный
  SfUnionContrCloseDate : date // необязательный

) : date
  
  // Если у счета нет договора об-служивания, то заполняется 
  // датой заявления на закрытие счета (заявление от).
  if(SfCntrBuf == null)
    return reqclosa.Date;
  end;

  record SfCntr(sfcontr);
  Copy(SfCntr, SfCntrBuf);

  if(SfCntr.DateClose == date(0, 0, 0))
    return date(0, 0, 0); // договор не закрыт
  end;

  // Проверяем сводный договор
  if( (IsSfUnionContr == null) or (SfUnionContrCloseDate == null) )
    IsSfUnionContr = GetSfUnionContrCloseDate( SfCntr.UnionContrID, 
                                              @SfUnionContrCloseDate );
  end;

  if( // Договор обслуживания счета не связан со сводным договором
      not IsSfUnionContr or

      // Договор обслуживания счета связан со сводным договором и 
      // этот сводный договор закрыт
      (SfUnionContrCloseDate != date(0, 0, 0)) or

      // Договор обслуживания связан с незакрытым сводным договором и  
      // все индивидуальные договоры по этому счету закрыты
      AllContractsAreClosed(SfCntr.UnionContrID)
    )

    // Заполняется датой закрытия договора обслуживания
    return SfCntr.DateClose;
  end;

  return date(0, 0, 0);
end;

macro ЗаписатьПоле_ДатаРастДог( reqclosa, SfCntrBuf, vers : integer, 
                               IsSfUnionContr : bool, SfUnionContrCloseDate : date // могут быть не переданы
                             )

  var FieldValue : string = "";
  var DateClose : date = GetContractCloseDate(reqclosa, SfCntrBuf, IsSfUnionContr, SfUnionContrCloseDate);

  if( DateClose != date(0, 0, 0) )
    FieldValue = DDpMMpYYYY(DateClose);
  else
    if(vers < 510)
      FieldValue = " "; // предписанное поле
    end;
  end;

  if(FieldValue)
    ЗаписатьПолеЛог( "ДатаРастДог", FieldValue );
  end;

end;

//--------------------------------------------------------------------------
// Предварительная проверка учетного объекта перед генерацией сообщения
//--------------------------------------------------------------------------
private macro AllSymbolsAreEqual(s : string) : bool
  var FirstSymbol : string = substr(s, 1, 1),
      Len : integer = strlen(s);

  var i : integer = 2;

  while(i <= Len)
    if( substr(s, i, 1) != FirstSymbol )
      return FALSE;
    end;

    i = i + 1;
  end;

  return TRUE;
end;

private macro CheckAddress( PartyID : integer, PartyName : string )
  record adress(adress);
  if( not НайтиЮридическийАдресСубъекта(PartyID, adress) )
    RsbThrow(string("Для банка (филиала) ", PartyName, " не задан юридический адрес"));
  end;

  // В адресе банка (филиала) задан индекс
  if( not strlen(trim(adress.PostIndex)) )
    RsbThrow(string("В адресе банка (филиала) ", PartyName, " не указан почтовый индекс"));
  end;

  // Количество символов в индексе из адреса банка (филиала) 
  if( strlen(adress.PostIndex) != 6 )
    RsbThrow(string("Почтовый индекс, указанный в адресе банка (филиала) ", PartyName, 
                    ", должен содержать 6 символов"));
  end;

  var КодСтраны = adress.Country;

  if( (КодСтраны == "RUS") or (not КодСтраны) )

    // В адресе банка (филиала) задан код региона
    if( not trim(adress.RegionNum) )
      RsbThrow(string("В адресе банка (филиала) ", PartyName, " не указан код региона"));
    end;

    // Количество символов в коде региона из адреса банка (филиала)
    if( strlen(adress.RegionNum) != 2 )
      RsbThrow(string("Код региона, указанный в адресе банка (филиала) ", PartyName, 
                      ", должен содержать 2 символа"));
    end;

    // Код региона из адреса банка есть в справочнике
    if( not existsSQLselect( "select 1 from dptregion_dbt where t_CodeRegion = :CodeReg ",
                             makeArray( SQLParam("CodeReg", adress.RegionNum) ) )
      )
      RsbThrow(string("Код региона, указанный в адресе банка (филиала) ", PartyName, 
                      ", отсутствует в справочнике регионов"));
    end;
  end;

  var IsRegionCapital : bool = ( (adress.RegionNum == "77") or 
                                 (adress.RegionNum == "78") or
                                 (adress.RegionNum == "92") );

  // В адресе банка (филиала) задан город или населенный пункт
  if(not IsRegionCapital and not adress.District and not adress.Place)
    RsbThrow(string("В адресе банка (филиала) ", PartyName, 
                    " должен быть заполнен либо город, либо населенный пункт"));
  end;

  // В адресе филиала счета типа $(юридический) есть индекс address.postindex 
  // и код региона address.region и хотя бы один необязательный элемент адреса
  if( not ( strlen(trim(adress.PostIndex)) 
            and
            (strlen(trim(adress.RegionNum)) or (КодСтраны != "RUS")) 
            and
            ( strlen(adress.District) or
              (strlen(adress.Province) and not IsRegionCapital ) or 
              strlen(adress.Place) or
              strlen(adress.Street) or
              strlen(adress.House) or
              strlen(adress.NumCorps) or
              strlen(adress.Flat)
            )
          )
    )
    msgbox(string("В юридическом адресе банка (филиала)| ", PartyName, "| недостаточно данных для корректного заполнения реквизита сообщения \"АдрКО\". |Должны быть указаны индекс, код региона и еще один из элементов."));
  end;

end;

private macro HaveFIO(req)
  if((index(req.ClientName, " ") > 0) or (index(req.ClientName, ",") > 0))
    return true;
  else
    return false;
  end;
end;

private macro GetFieldByName(name):string
  var select = " SELECT T_VALUE, T_TPFIELDID FROM DWLMESVAL_TMP "
               "  WHERE T_TPFIELDID = (SELECT T_TPFIELDID FROM DWLTPFLD_DBT "
               "                        WHERE T_NAME = ?) ";
  var rs = execSQLselect( select, makeArray( SQLParam("", name) ), FALSE );
  if( rs.moveNext )
    return rs.value(0);
  end;
  return "";
end;

private macro GetFieldArrayByName(name):TArray
  var result : TArray = TArray();
  
  var select = " SELECT T_VALUE, T_TPFIELDID FROM DWLMESVAL_TMP "
               "  WHERE T_TPFIELDID = (SELECT T_TPFIELDID FROM DWLTPFLD_DBT "
               "                        WHERE T_NAME = ?) ";
  var rs = execSQLselect( select, makeArray( SQLParam("", name) ), FALSE );
  var i = 0;
  while( rs.moveNext )
    result(i) = rs.value(0);
    i = i + 1;
  end;
  return result;
end;

private macro GetCodeAndPartyName(PartyID, code:@string):string
  var select = " select t_PartyName, t_Code from dp_dep "
               "  where t_Parentcode = 0 and t_PartyID = ? ";
  var rs = execSQLselect( select, makeArray(SQLParam("",PartyID)), FALSE );
  code = ПолучитьКодСубъекта(PartyID, PTCK_CONTR);
  if( rs.moveNext )
    if( code == "" )
      code = rs.value(1);
    end;
    return rs.value(0);
  end;
  return "";
end;

private macro IsNotHeadOrg(PartyID)
  var select = " select count(1) from ddp_dep_dbt "
               "  where t_Parentcode <> 0 and t_PartyID = ? ";
  var rs = execSQLselect( select, makeArray(SQLParam("",PartyID)), FALSE );
  if( rs.moveNext )
    if( rs.value(0) != 0)
      return true;
    else
      return false;
    end;
  end;
  return false;
end;

private macro CheckSameSymb(KPP):bool
  var res = false;
  var ar = StrSplit2( KPP, 1 );
  var t = ar[0];
  for( var i, 1, ar.size-1 )
    if( t != ar[i] )
      res = true;
      break;
    end;
  end;
  return res;
end;

// CHECK FIELDS: РегНом; НомФ, НаимКО, ИННКО, КППКО, ОГРН, Индекс, КодРегион, Город, НаселПункт, ДатаИзмБанк;
macro CheckMes(Party, err:@string)
  err = "";
  var РегНом          = GetFieldArrayByName("РегНом"),
      ИННКО           = GetFieldArrayByName("ИННКО"),
      КППКО           = GetFieldArrayByName("КППКО"),
      БИК             = GetFieldArrayByName("БИК"),
      НаимКО          = GetFieldArrayByName("НаимКО"),
      ОГРНКО          = GetFieldArrayByName("ОГРНКО"),
      НомФ            = GetFieldArrayByName("НомФ"),
      Индекс          = GetFieldArrayByName("Индекс"),
      КодРегион       = GetFieldArrayByName("КодРегион"),
      Город           = GetFieldArrayByName("Город"),
      НаселПункт      = GetFieldArrayByName("НаселПункт"); 
      
  var PartyIDBefore   = GetCodeOwnerID(PTCK_BIC, БИК(1)),
      PartyIDAfter    = GetCodeOwnerID(PTCK_BIC, БИК(0)),
      isNotHeadBefore = IsNotHeadOrg(PartyIDBefore),
      isNotHeadAfter  = IsNotHeadOrg(PartyIDAfter),
      PartyNameBefore = Bnk_GetPartyName(PartyIDBefore),
      PartyNameAfter  = Bnk_GetPartyName(PartyIDAfter);
      
  var code;
     
  // Проверки для реквизитов банка ПОСЛЕ изменений    
  if ( not РегНом(0) )
    err = "Для " + PartyNameAfter + " не задан регистрационный номер кредитной организации";
  elif( isNotHeadAfter and ( (НомФ(0) == "") or (НомФ(0) == "0") ) )
    err = "Для " + PartyNameAfter + " не задан порядковый номер филиала";
  elif( НаимКО(0) == "" )
    code = 0;
    if( isNotHeadAfter and (GetCodeAndPartyName(Party.PartyID, @code) == "") )
      err = "Для " + code + " не задано наименование";
    end;
  elif( ИННКО(0) == "" )
    err = "Для " + PartyNameAfter + " не задан ИНН";
  elif( strlen(ИННКО(0)) != 10 )
    err = "Для " + PartyNameAfter + " задано неверное значение ИНН";
  elif( КППКО(0) == "" )
    err = "Для " + PartyNameAfter + " не задан КПП";
  elif( strlen(КППКО(0)) != 9  )
    err = "Для " + PartyNameAfter + " задано неверное значение КПП";
  elif( not CheckSameSymb(КППКО(0))          )
    err = "КПП банка (филиала) " + PartyNameAfter + " не должен состоять из одинаковых цифр";
  elif( ОГРНКО(0) == ""          )
    err = "Для " + PartyNameAfter + " не задан ОГРН";
  elif( strlen(ОГРНКО(0)) != 13                )
    err = "Для " + PartyNameAfter + " задано неверное значение ОГРН";
  elif( (Индекс(0) == "") or (КодРегион(0) == "") )
    if( Индекс(0) == "" )
      err = "В адресе " + PartyNameAfter + " не указаны обязательные элементы: Индекс";
    end;
    if( КодРегион(0) == "" )
      if( err )
        err = err + " КодРегиона";
      else
        err = "В адресе " + PartyNameAfter + " не указаны обязательные элементы: КодРегиона";
      end;
    end;
  elif( (not InList(КодРегион(0),"77", "78", "92")) and ((Город(0) == "") or (НаселПункт(0) == "")) )
    err = "В адресе банка (филиала) " + PartyNameAfter + " должен быть заполнен либо город, либо населенный пункт.";
  
  // Проверки для реквизитов банка ДО изменений    
  elif ( not РегНом(1) )
    err = "Для " + PartyNameBefore + " не задан регистрационный номер кредитной организации";
  elif( isNotHeadBefore and ( (НомФ(1) == "") or (НомФ(1) == "0") ) )
    err = "Для " + PartyNameBefore + " не задан порядковый номер филиала";
  elif( НаимКО(1) == "" )
    code = 0;
    if( isNotHeadAfter and (GetCodeAndPartyName(Party.PartyID, @code) == "") )
      err = "Для " + code + " не задано наименование";
    end;
  elif( ИННКО(1) == "" )
    err = "Для " + PartyNameBefore + " не задан ИНН";
  elif( strlen(ИННКО(1)) != 10 )
    err = "Для " + PartyNameBefore + " задано неверное значение ИНН";
  elif( КППКО(1) == "" )
    err = "Для " + PartyNameBefore + " не задан КПП";
  elif( strlen(КППКО(1)) != 9  )
    err = "Для " + PartyNameBefore + " задано неверное значение КПП";
  elif( not CheckSameSymb(КППКО(1))          )
    err = "КПП банка (филиала) " + PartyNameBefore + " не должен состоять из одинаковых цифр";
  elif( ОГРНКО(1) == ""          )
    err = "Для " + PartyNameBefore + " не задан ОГРН";
  elif( strlen(ОГРНКО(1)) != 13                )
    err = "Для " + PartyNameBefore + " задано неверное значение ОГРН";
  elif( (Индекс(1) == "") or (КодРегион(1) == "") )
    if( Индекс(1) == "" )
      err = "В адресе " + PartyNameBefore + " не указаны обязательные элементы: Индекс";
    end;
    if( КодРегион(1) == "" )
      if( err )
        err = err + " КодРегиона";
      else
        err = "В адресе " + PartyNameBefore + " не указаны обязательные элементы: КодРегиона";
      end;
    end;
  elif( (not InList(КодРегион(1),"77", "78", "92")) and ((Город(1) == "") or (НаселПункт(1) == "")) )
    err = "В адресе банка (филиала) " + PartyNameBefore + " должен быть заполнен либо город, либо населенный пункт.";
  
  //Проверка даты изменения
  elif( date(GetFieldByName("ДатаИзмБанк")) == date(0,0,0) )
    err = "Не указана дата изменения реквизитов банка";
  end;
  
  if( strlen(err) )
    return false;
  else
    return true;
  end;
  
end;

macro MNS_CheckObj_Common( Req, kind, ClientID : @integer, КодНОБ : @string )
  var PartyID, PartyName, ИНН, КПП, Error, ParentPartyID = 0, Code = "", Name = "", ИДГНИКлиента, Серия = "" , Номер = "", ДатаРегистрации = date(), OldfnsMessageID, fldval;
  var Нотариус, Адвокат, УпрТоварищ, ИП, OpenDate = date(0,0,0);
  var Department;
  FILE adress(adress) key 0;
  FILE dp_dep( dp_dep ) key 0;
  FILE party( party ) key 0;
  record Acc(account);
  record OldAcc(account);

  if( kind == ACCMSG_KIND_CLOSE )
    if(Req.Origin == REQ_ACC_ORIGIN_PS)
      ПолучитьСчет(Req.Code_Currency, Req.Account, Acc );
    else
      ПолучитьСчет_БО(Req.Code_Currency, Req.Account, Req, OBJTYPE_REQCLOSA, Acc);
    end;

    OpenDate = Acc.Open_Date;
  elif( kind == ACCMSG_KIND_CHNG )
    if(Req.Origin == REQ_ACC_ORIGIN_PS)
      ПолучитьСчет(Req.NewAccountFIID, Req.NewAccount, Acc );
      ПолучитьСчет(Req.OldAccountFIID, Req.OldAccount, OldAcc );
    else
      ПолучитьСчет_БО(Req.NewAccountFIID, Req.NewAccount, Req, OBJTYPE_REQCHANGE, Acc);
      ПолучитьСчет_БО(Req.OldAccountFIID, Req.OldAccount, Req, OBJTYPE_REQCHANGE, OldAcc);
    end;
  end;
  
  ClientID = 0;
  if( kind == ACCMSG_KIND_OPEN )
    ClientID = Req.ClientID;
    Department = Req.AccountDepartment;
  elif( kind == ACCMSG_KIND_CLOSE )
    ClientID = Acc.Client;
    Department = Acc.Department;
    OpenDate = Acc.Open_Date;
  elif( kind == ACCMSG_KIND_CHNG )
    ClientID = Acc.Client;
    Department = OldAcc.Department;
  end;

  /*Наименование банка*/
  dp_dep.Code = Department;
  if( GetEQ( dp_dep ) )
    party.PartyID = dp_dep.PartyID;
    if( GetEQ( party ) )
      PartyID = party.PartyID;
      PartyName = party.Name;
      if( party.Name == "" )
        RsbThrow( string( "У субъекта, связанного с филиалом ", dp_dep.Name, " не задано наименование" ) );
      end;
    else
      RsbThrow( string( "Не найден субъект, связанный с филиалом ", dp_dep.Name ) );
    end;
  else
    RsbThrow( string( "Не найден филиал с кодом ", Department ) );
  end;

  if( kind == ACCMSG_KIND_CHNGBNK )
    var err;
    CheckMes(Req, @err);
    if( err )
      RsbThrow(err);
    end;
  end;

  if( dp_dep.ParentCode != 0 )
    dp_dep.Code = dp_dep.ParentCode;
    if( GetEQ( dp_dep ) )
      party.PartyID = dp_dep.PartyID;
      ParentPartyID = party.PartyID;
      if( GetEQ( party ) )
        if( party.Name == "" )
          RsbThrow( string( "У субъекта, связанного с филиалом ", dp_dep.Name, " не задано наименование" ) );
        end;
      else
        RsbThrow( string( "Не найден субъект, связанный с филиалом ", dp_dep.Name ) );
      end;
    else
      RsbThrow( string( "Не найден филиал с кодом ", dp_dep.Code ) );
    end;
  end;

  /*ФИО клиента*/
  if( (party.legalform == PTLEGF_PERSN) and not HaveFIO(req) )
    RsbThrow(string("Для клиента ", ClientID, " не заданы фамилия и\\или имя"));    
  end;
  
  /*ИНН банка*/
  ИНН = RemoveKPP( ПолучитьКодСубъекта( PartyID, PTCK_INN, Error, 0) );
  if( Error or (ИНН == "") )
    RsbThrow(string("Для ", PartyName, " не задан ИНН"));
  end;
  /*Количество символов в ИНН банка*/
  if(strlen(ИНН) != 10)
    RsbThrow( string( "Для ", PartyName, " задано неверное значение ИНН" ) );
  end;
  
  /*КПП банка*/
  КПП = RemoveINN(GetPartyINN( PartyID, 1) );
  if( КПП == "" )
    RsbThrow(string("Для  ",partyname," не задан КПП"));
  end;

  /*Количество символов в КПП банка*/
  if(strlen(КПП) != 9)
    RsbThrow(string("Для ",partyname," задано неверное значение КПП"));
  end;

  // Символы в КПП банка
  if( AllSymbolsAreEqual(КПП) )
    RsbThrow("КПП банка (филиала) " + PartyName + " не должен состоять из одинаковых цифр");
  end;

  /*Задана налоговая инспекция банка*/
  /*У налоговой инспекции банка есть код НО*/
  КодНОБ = GetCodeNOBWithChecks(PartyID);

  /*Адрес банка*/
  CheckAddress(PartyID, PartyName);

  /*Регистрационный номер банка*/
  Code = ПолучитьКодСубъекта( PartyID, PTCK_BANKREGNUM, Error);
  if(Error)
    RsbThrow(string("Для ",partyname," не задан регистрационный номер кредитной организации"));
  end;

  if( ParentPartyID != 0 )
    if( not ( ( Index( Code,"/") != 0 ) and (strlen(SubStr(Code, Index( Code,"/")+1)) != 0) ) )
      RsbThrow(string("Для ",partyname," не задан порядковый номер филиала"));
    end;

  end;
  
  /*БИК банка*/
  ПолучитьКодСубъекта( PartyID, PTCK_BIC, Error, 1, 1);
  if(Error)
    RsbThrow(string("Для ",partyname," не задан БИК"));
  end;

  /*ОГРН банка*/ 
  var OGRN : string = ПолучитьКодСубъекта( PartyID, PTCK_OGRN, Error);
  if(Error or not OGRN)
    RsbThrow(string("Для ", partyname ," не задан ОГРН"));
  end;

  // Количество символов в ОГРН банка
  if( strlen(OGRN) != 13 )
    RsbThrow(string("Для ", partyname ," задано неверное значение ОГРН"));
  end;

  /*Наименование клиента*/
  if( (req.ClientName=="") and (req.clientType == PTLEGF_INST) )
    RsbThrow(string("Не найден налогоплательщик ", ClientID));
  end;

  if(party.Name == "")
    RsbThrow(string("Для клиента c ИД ",party.PartyID," не задано наименование"));
  end;

  ИП = IsIndividualEmployer(party.PartyID);
  var sClientID : string = UniID( party, OBJTYPE_PARTY );
  CheckObjAttrPresence( Нотариус, OBJTYPE_PARTY, sClientID, 
                        PARTY_ATTR_GROUP_PTTYPE, null, "", ТипСубъекта_Нотариус ); 
  CheckObjAttrPresence( Адвокат,  OBJTYPE_PARTY, sClientID, 
                        PARTY_ATTR_GROUP_PTTYPE, null, "", ТипСубъекта_Адвокат );
  CheckObjAttrPresence( УпрТоварищ, OBJTYPE_PARTY, sClientID, PARTY_ATTR_GROUP_PTTYPE, PARTY_ATTR_PTTYPE_MANAGPARTNER);

   /*ИНН клиента*/
  var INN_KPP_Client:string = GetPartyINN( party.PartyID, 1);
  var INN_Client:string = RemoveKPP( INN_KPP_Client );
  if( INN_Client == "" )
    if( (kind == ACCMSG_KIND_CLOSE) and 
        ( 
          (( OpenDate < date(22,9,1994)) and (party.LegalForm == PTLEGF_INST) and (party.NotResident != "X")) or
          (( OpenDate < date(22,9,1996)) and ((party.LegalForm == PTLEGF_INST) and (party.NotResident == "X") or ИП or Нотариус)) or
          (( OpenDate < date(1,1,2004)) and  (Адвокат))
        )
      ) 
      // проверку считать пройденной
    else
      RsbThrow(string("Для ", party.Name, " не задан ИНН"));
    end;
  end;

  /*Количество символов в ИНН клиента*/
  if(((party.LegalForm == PTLEGF_INST) and (party.NotResident != "X") and (strlen(INN_Client) != 10 )) or 
     ((party.LegalForm == PTLEGF_INST) and (party.NotResident == "X") and (strlen(INN_Client) != 5 ) and (strlen(INN_Client) != 10)) or 
     ((party.LegalForm != PTLEGF_INST) and (strlen(INN_Client) != 12)))
    RsbThrow(string("Для ",party.Name," задано неверное значение ИНН"));
  end;

  /*КПП клиента*/
  var KPP_Client:string = RemoveINN( INN_KPP_Client );
  if( strlen( INN_Client ) == 10 )
    if( (KPP_Client == "") and (req.ClientType != PTLEGF_INST))
      RsbThrow(string("Для  ",party.Name," не задан КПП"));
    end;

   /*Количество символов в КПП клиента*/
    if((strlen(KPP_Client) != 9) and (kind == ACCMSG_KIND_OPEN))
      RsbThrow(string("Для ",party.Name," задано неверное значение КПП"));
    end;
  end;
  // Символы в КПП клиента не совпадают
  if( (strlen(KPP_Client) > 1) and AllSymbolsAreEqual(KPP_Client) )
    RsbThrow(string("КПП ",party.Name," не должен состоять из одинаковых цифр"));
  end;

  /*Номер договора*/
  /*Тип счета*/ 
  if( kind == ACCMSG_KIND_OPEN )
    if(Req.SfContrNum == "")
      RsbThrow(string("Не задан номер договора счета"));
    end;

    if( (Req.Type_Account == "") and (not ReadNoteForObject(OBJTYPE_REQOPENA, UniID(Req, OBJTYPE_REQOPENA), REQOPENA_NOTE_KIND_ACCKIND)) )
      RsbThrow(string("Не задан вид счета в соответствии с Инструкцией Банка России 28-И"));
    end;
    
  end;

  /* Проверка наличиа ОГРН у клиента
   * ( у нерезидента, адвоката, нотариуса и упр.товарища ОГРН быть не обязан )
   */
  var OGRN_Client:string = "";
  if( (party.NotResident != "X") and (not Адвокат) and (not Нотариус) and (not УпрТоварищ) )
    OGRN_Client = ПолучитьКодСубъекта(party.PartyID, PTCK_OGRN, Error, 0, 1 );
    if( Error or ( not OGRN_Client ) )
      RsbThrow( string( "Для ", party.Name, " не задан ОГРН" ) );
    end;
  end;

  /* Проверка длины ОГРН клиента */
  if( OGRN_Client )
    if( ( strlen( INN_Client ) == 10 ) and ( strlen( OGRN_Client ) != 13 ) )
      RsbThrow( string( "Для ", party.Name, " задано неверное значение ОГРН.|Длина ОГРН должна быть 13 символов." ) );
    elif( ( strlen( INN_Client ) == 12 ) and ( strlen( OGRN_Client ) != 15 ) )
      RsbThrow( string( "Для ", party.Name, " задано неверное значение ОГРН.|Длина ОГРН должна быть 15 символов." ) );
    end;
  end;

  /*Сотрудник, подписывающий сообщение*/

  Error = GetRegValForOPENAC("ИМНС_ФИО", V_STRING, Name);
  if( Error or (Name == ""))
    RsbThrow(string("Не заданы ФИО сотрудника, подписывающего сообщения в ФНС"));
  end;
  
  /*Код документа удостоверяющего личность (ДУЛ)*/
  if(ИП and (req.ClientCardType == ""))
    RsbThrow( string( "Для ", req.ClientName, " не задан код документа, удостоверяющего личность" ) );
  end;

  /*Количество символов в коде ДУЛ*/
  if( ИП and (strlen(req.ClientCardType) != 2) )
    RsbThrow( string( "Для клиента ", req.ClientName, " задан неверный код документа, удостоверяющего личность" ) );
  end;

  /*Серия и номер ДУЛ*/
  if(ИП and (req.ClientCardNum == ""))
    RsbThrow( string( "Для ", req.ClientName, " не заданы серия и/или номер документа, удостоверяющего личность" ) );    
  end;

  /*Дата выдачи ДУЛ*/
  if(ИП and ((req.ClientCardDate == nullval) or (req.ClienCardDate == ZeroDate)))
    RsbThrow( string( "Для ", req.ClientName, " не задана дата выдачи документа, удостоверяющего личность" ) );          
  end;

  /*Не совпадают реквизиты клиента до и после изменения*/
  if(ИП and ((req.ClientCardDate == nullval) or (req.ClienCardDate == ZeroDate)))
    RsbThrow( string( "Для ", req.ClientName, " не задана дата выдачи документа, удостоверяющего личность" ) );          
  end;

  /*Не совпадают реквизиты клиента до и после изменения*/
  if(kind == ACCMSG_KIND_CHNG)
    if(req.ClientChange == "X")
      if( ПроверкаИдентичности(acc, oldacc) )
        RsbThrow( string("Совпадают актуальные реквизиты клиента и реквизиты до изменения. В сообщение не будет включен блок, содержащий реквизиты клиента до изменения.") );            
      end;
    end;
  end;
  
  return true;
end;

macro CheckCorrectMes(ClientID : integer, КодНОБ : string, kind : integer) : bool

  if( GetKindActionFNS() ==  KIND_ACTION_FNS_CORRECT )
    var OldfnsMessageID : integer = GetOldfnsMessageID(),
        Error : integer = 0,
        fldval : string = "";
    
    /*ОГРННП*/
    var Code : string = ПолучитьКодСубъекта(ClientID, PTCK_OGRN, Error, 0, 1 );
    fldval = GetFldValue( OldfnsMessageID, "ОГРННП" );
    if ((fldval != "") and (fldval != Code))
      if(not AskCorrectAction("ОГРННП"))
        return false;
      end;
    end;    
    /*ИНННП*/     
    var ИНН : string = RemoveKPP(GetPartyINN( ClientID, 1) );
    fldval = GetFldValue( OldfnsMessageID, "ИНННП" );
    if (fldval != ИНН)
      if(not AskCorrectAction("ИНННП"))
        return false;
      end;
    end;    
    /*ИННКО*/
    ИНН = RemoveKPP(GetPartyINN( {OurBank}, 1) );
    fldval = GetFldValue( OldfnsMessageID, "ИННКО" );
    if(fldval != ИНН)
      if(not AskCorrectAction("ИННКО"))
        return false; 
      end;
    end;    
    /*КодНОБ*/
    fldval = GetFldValue( OldfnsMessageID, "КодНОБ" );
    if(fldval != КодНОБ)
      if(not AskCorrectAction("КодНОБ"))
        return false;
      end;

    end;

    if(kind == ACCMSG_KIND_CHNG)           
      /*ПризнИзмСч*/
      fldval = GetFldValue( OldfnsMessageID, "ПризнИзмНСч" );
      if( (fldval != "") and (fldval != "0"))
        if(not AskCorrectAction("ПризнИзмНСч"))
          return false;
        end;
      end;
      
      /*ПризнИзмКО*/
      fldval = GetFldValue( OldfnsMessageID, "ПризнИзмКО" );
      if( (fldval != "") and (fldval != "0"))
        if(not AskCorrectAction("ПризнИзмКО"))
          return false;
        end;
      end;      

    end;
  end;

  return true;
end;

macro MNS_CheckObj( Req, kind )
  var КодНОБ : string = "", ClientID : integer = 0;

  if( not MNS_CheckObj_Common(Req, kind, @ClientID, @КодНОБ) )
    return FALSE;
  end;

  if( not CheckCorrectMes(ClientID, КодНОБ, kind) )
    return FALSE;
  end;

  return TRUE;

  OnError(er) /* обработка ошибок */
    ExeptionMessage(er);
    return FALSE;

end;

private macro GetAccDprt( Req, kind ) : integer
  var AccDprt : integer = 0;

  record Acc(account);
  if(kind == ACCMSG_KIND_OPEN)
    AccDprt = Req.AccountDepartment;
  elif(kind == ACCMSG_KIND_CLOSE)
    var Счет : string, Валюта : integer;
    ПолучитьСчетСВалютой(Req, 0 /*Закрытие*/, Счет, Валюта);

    if(Req.Origin == REQ_ACC_ORIGIN_PS)
      ПолучитьСчет(Валюта, Счет, Acc );
    else
      ПолучитьСчет_БО(Валюта, Счет, Req, OBJTYPE_REQCLOSA, Acc);
    end;

    AccDprt = Acc.Department;
  elif(kind == ACCMSG_KIND_CHNG)
    if(Req.Origin == REQ_ACC_ORIGIN_PS)
      ПолучитьСчет(Req.OldAccountFIID, Req.OldAccount, Acc );
    else
      ПолучитьСчет_БО(Req.OldAccountFIID, Req.OldAccount, Req, OBJTYPE_REQCHANGE, Acc);
    end;

    AccDprt = Acc.Department;
  end;

  return AccDprt;
end;

macro MNS_CheckObj510( Req, kind )
  var КодНОБ : string = "", ClientID : integer = 0;

  if( not MNS_CheckObj_Common(Req, kind, @ClientID, @КодНОБ) )
    return FALSE;
  end;

  var MesSender : integer = GetDprtPartyID( GetAccDprt(Req, kind) );
  if(MesSender <= 0)
    RunError("Не найден связанный субъект филиала счета заявления");
  end;

  var Bank : TBankInfoAccMsg = TBankInfoAccMsg();
  var ErrMsg : string = "";
  if( not Bank.Fill(MesSender, @ErrMsg) )
    RsbThrow(ErrMsg);
  end;
  var CorrectMesObj : TCorrectMesFNS = TCorrectMesFNS();
  CorrectMesObj.КодНОБ = КодНОБ;
  CorrectMesObj.ИННКО = Bank.ИННКО;
  CorrectMesObj.РегНом = Bank.РегНом;
  CorrectMesObj.НомФ = Bank.НомФ;
  if( not CorrectMesObj.Check1() )
    return FALSE;
  end;

  return TRUE;

  OnError(er) /* обработка ошибок */
    ExeptionMessage(er);
    return FALSE;

end;
