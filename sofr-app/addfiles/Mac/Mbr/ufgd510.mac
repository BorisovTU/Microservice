/*
$Name:         ufgd510.mac
$Module:       Межбанковские расчеты
$Description:  Генерация учетного объекта ED510
*/

// ED510 Информация об услугах, предоставленных Банком России пользователю СПФС

import "ufgendoc.mac";

private class TPayServicesCodeList
  var ServicesCode = TArray(),
      ReceiverSWIFTBIC = TArray(),
      ServicesDate = TArray(),
      ServicesQuantity = TArray(),
      ServicesRate = TArray(),
      Sum = TArray();
end;

macro GenDoc( addrMes )
  var xml:object = ActiveX( "MSXML.DOMDocument" );
  
  SetBuff( wlmes, addrMes );
  
  ClearRecord( wlinfo );

  PrintLog( 2, "Генерация информационного сообшения по ED510" );
  
  var FieldName, FieldValue, BlockName;
  var EDNo, EDDate, EDAuthor, EDReceiver, RegisterNo, TotalSum, PayServicesCodeList = TPayServicesCodeList();
  
  while( СчитатьПоле(FieldName, FieldValue, BlockName) )
    if( BlockName == "" )
      if( FieldName == "EDNo" )
        EDNo = FieldValue;
      elif( FieldName == "EDDate" )
        EDDate = FieldValue;
      elif( FieldName == "EDAuthor" )
        EDAuthor = FieldValue;
      elif( FieldName == "EDReceiver" )
        EDReceiver = FieldValue;
      elif( FieldName == "RegisterNo" )
        RegisterNo = FieldValue;
      elif( FieldName == "TotalSum" )
        TotalSum = FieldValue;
      end;
    elif( BlockName == "PayServicesCodeList" )
      if( FieldName == "ServicesCode" )
        PayServicesCodeList.ServicesCode[PayServicesCodeList.ServicesCode.size] = FieldValue;
      elif( FieldName == "ReceiverSWIFTBIC" )
        PayServicesCodeList.ReceiverSWIFTBIC[PayServicesCodeList.ReceiverSWIFTBIC.size] = FieldValue;
      elif( FieldName == "ServicesDate" )
        PayServicesCodeList.ServicesDate[PayServicesCodeList.ServicesDate.size] = FieldValue;
      elif( FieldName == "ServicesQuantity" )
        PayServicesCodeList.ServicesQuantity[PayServicesCodeList.ServicesQuantity.size] = FieldValue;
      elif( FieldName == "ServicesRate" )
        PayServicesCodeList.ServicesRate[PayServicesCodeList.ServicesRate.size] = FieldValue;
      elif( FieldName == "Sum" )
        PayServicesCodeList.Sum[PayServicesCodeList.Sum.size] = FieldValue;
      end;     
    end;
  end;

  wlinfo.Trn = wlmes.Trn;
  wlinfo.RelatedRef = wlmes.RelatedRef;
  wlinfo.Direct = "X"; //WLD_MES_IN
  wlinfo.OriginatorCode = wlmes.OutsideAbonentCode;
  wlinfo.OriginatorCodeKind = wlmes.OutsideAbonentCodeKind;
  wlinfo.OriginatorID = wlmes.OutsideAbonentID;
  wlinfo.OriginatorName = Bnk_GetPartyName(wlinfo.OriginatorID);
  if( strlen(EDReceiver) > 0 )
    wlinfo.RecipientCode = EDReceiver;
  end;
  wlinfo.RecipientCodeKind = PTCK_UIS;
  wlinfo.RecipientID = GetCodeOwnerID(PTCK_UIS, wlinfo.RecipientCode);
  wlinfo.RecipientName = Bnk_GetPartyName(wlinfo.RecipientID);
  wlinfo.OfficeID = wlinfo.RecipientID;
  wlinfo.OfficeCodeKind = wlinfo.RecipientCodeKind;
  wlinfo.OfficeCode = wlinfo.RecipientCode;
  
  var ServicesDateBegin,
      ServicesDateEnd;
      
  var Narrative = "Информация об услугах, предоставленных участнику СПФС, за период с " + ServicesDateBegin +
                  " по " + ServicesDateEnd + " на общую сумму " + money(int(TotalSum)/100) + ". Реестр № " + RegisterNo + ".";
                  
  ВставитьИнфСообщение( wlinfo, Narrative );
  
  
  return TRUE;

  OnError(er) /* Обработка ошибок времени выполнения */
    std.msg(String(er.Message, "|Модуль: ", er.Module, " Строка: ", er.Line));
    return FALSE;
  

end;

