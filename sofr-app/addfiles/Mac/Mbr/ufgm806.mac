/*
  $Name:         ufgm806.mac
  $Module:       Межбанковские расчеты
  $Description:  Генерация сообщения ED806 транспорта УФЭБС
*/

import BankInter, CTInter, oralib, MesInter, WldInter, ufgenmes;

private macro GetRequestCode( Queries )
  var RequestCode : string = "";

  var select = " select REGEXP_SUBSTR( :Queries, '\\/\\w{4}\\/' ) as t_RequestCode from dual ";

  var params = makeArray( SQLParam( "Queries", Queries ) );
                        
  var rs = execSQLselect( select, params );
  
  if( rs and rs.moveNext() )
    RequestCode = rs.value("t_RequestCode");
  end;

  if( (strlen( RequestCode ) == 6) and Index( RequestCode, "/" ) )
    RequestCode = SubStr( RequestCode, 2, strlen( RequestCode ) - 2 );
  else
    RequestCode = "";
  end;

  return RequestCode;
end;

macro GenMes( addrMes, addrReq )


  record wlmes(wlmes);
  record wlReq(wlreq);
  
  SetBuff( wlReq, addrReq );
  SetBuff( wlmes, addrMes );
  
  var xml:object = ActiveX( "Microsoft.XMLDOM" );  
  var mes:object, elem: object; 
  var AuthorID, BIC = "", err;
  mes = xml.createElement( "ED806" );  
  mes.setAttribute( "xmlns", "urn:cbr-ru:ed:v2.0" );
  
  var ed_nda = NULL;
  ed_nda = EDNoDateAuthor();
  ed_nda.ConstructByTrn(wlmes.TRN);
  
  mes.setAttribute( "EDNo",     ed_nda.EDNo );
  ЗаписатьПолеЛог ( "EDNo",     ed_nda.EDNo, TRUE );
  mes.setAttribute( "EDDate",   YYYYMMDD(ed_nda.EDDate) );
  ЗаписатьПолеЛог ( "EDDate",   YYYYMMDD(ed_nda.EDDate), TRUE );
  mes.setAttribute( "EDAuthor", ed_nda.EDAuthor );  
  ЗаписатьПолеЛог ( "EDAuthor", ed_nda.EDAuthor, TRUE );

  var RequestCode = GetRequestCode( wlreq.Queries );
  if( RequestCode == "" )
    RunError("Не задан вид запроса информации. Выберите нужное значение из справочника в поле <Сообщение>");       
  else
    mes.setAttribute( "RequestCode", RequestCode );
    ЗаписатьПолеЛог ( "RequestCode", RequestCode, TRUE );
  end;

  /* ParticipantID */

  if (RequestCode == "PROF")
    УстановитьКонтекстБлокаЛог( "ParticipantID" );
      ЗаписатьПолеЛог( beginField, "ParticipantID" );
      AuthorID = GetCodeParty(ed_nda.EDAuthor, PTCK_UIS, err);
      if(err == 0)
        GetPartyCodeEx(AuthorID, PTCK_BIC, @BIC);
      end;
      if(BIC != "")
        УстановитьКонтекстБлокаЛог( "BIC" );
          ЗаписатьПолеЛог( beginField, "BIC" );
          ЗаписатьПолеЛог( "BIC", BIC);
          ЗаписатьПолеЛог( endField, "BIC" );
        УстановитьКонтекстБлокаЛог( ".." );
      else
        УстановитьКонтекстБлокаЛог( "UID" );
          ЗаписатьПолеЛог( beginField, "UID" );
          ЗаписатьПолеЛог( "UID", ed_nda.EDAuthor);
          ЗаписатьПолеЛог( endField, "UID" );
        УстановитьКонтекстБлокаЛог( ".." );
      end;
      ЗаписатьПолеЛог( endField, "ParticipantID" );
    УстановитьКонтекстБлокаЛог( ".." );
  end;
  
  return true; /*Успешное завершение*/
  
  OnError(er)
    std.msg(String(RsbGetError(er), "|Модуль: ", er.Module, " Строка: ", er.Line));
    return FALSE;
end;