/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 5.1                      */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/*  Выполняется проводка со счета списания с клиентских счетов  на          */
/*  корреспондентскихй счет, на который был спозиционирован платеж          */
/*  Имя файла: w110_370.mac                                                 */
/*  Создан:  20.01.03                                        Бабин А.П.     */
/****************************************************************************/

import InsCarryDoc, OprInter, BankInter, RMInter, "wldoc.mac", "cbsttls.mac", "rmtools.mac";

RECORD Corschem( corschem );
var PaymentObj:RsbPayment;

var DEBET = "Д", KREDIT = "К" ;

macro ExecuteStep( doc, first )
  var err, DKFlag = "", FlagTrans = 0, stat, KvitType, Cancel;
  var paymtr:RsbPaymTransaction = PaymentObj.MakeTransaction();

  if ( PaymentObj.IsCredit() )
     DKFlag = KREDIT;
  else 
     DKFlag = DEBET;
  end;

  FlagTrans = PaymentObj.IsTransit();  


  if ( not CarryPlanDocuments(PaymentObj.PaymentID) )
     MsgBox("Ошибка при помещении планируемой проводки в проведенные");
     return 1;
  end;

  paymtr.Sum = PaymentObj.ReceiverAmount;
  paymtr.Chapter = 1 ;
  paymtr.FIIDPayer = PaymentObj.ReceiverFIID ;
  
  paymtr.ResultCarry = 1 ;

  paymtr.Kind_Oper  = " 1" ;
  paymtr.Shifr_Oper = "09" ;

  /* Реальные счета и коды банков */
       if( DKFlag == KREDIT )
         paymtr.AccountPayer      = PaymentObj.FuturePayerAccount;
         paymtr.AccountReceiver   = PaymentObj.FutureReceiverAccount;
       else
         paymtr.AccountPayer      = PaymentObj.FuturePayerAccount;
         paymtr.AccountReceiver   = PaymentObj.FutureReceiverAccount;
       end ;

  if ( paymtr.AccountPayer==paymtr.AccountReceiver ) 
     /* Делаем платеж закрытым */
     if ( УстановитьСтатусыПлатежа(OPR_PAYM_STATE, OPR_PM_ST_CLOSE) )
        MsgBox("Возникла ошибка при смене статусов операции платежа");
        return 1;
     end;     
     return 0;
  end;

  paymtr.Date_Carry = PaymentObj.ValueDate ;
  paymtr.Department = PaymentObj.Department ;

  paymtr.Ground        = PaymentObj.Ground;
  paymtr.Numb_Document = PaymentObj.Number;    

     if( not paymtr.Carry() )
       MsgBox("Ошибка при актуализации платежа");
       return 1;
     end;

  if ( УстановитьСтатусыПлатежа(OPR_PAYM_STATE, OPR_PM_ST_CLOSE) )
     MsgBox("Возникла ошибка при смене статусов операции платежа");
     return 1;
  end;     
  return 0 ;
end ;