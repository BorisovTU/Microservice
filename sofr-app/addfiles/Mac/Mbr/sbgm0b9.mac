/*
$Name: sbgm0B9.mac
$Module: Межбанковские расчеты
$Description: Генерация выписки SBRF3 0B9 
*/

import Календарь;
import "sbgenmes.mac", "swgenmes.mac";

private const WLD_TYPE_EXTRACT_CUMULATIVE = 1,
      CHAPT1 = 1,
      KA_A   = "А",
      KA_P   = "П",
      OBJTYPE_WLD_MES = 502,
      EXECSTEP = "X", 
      WLD_STATUS_MES_RECEIV = 50,
      WLD_STATUS_MES_DELIV = 40,
      WLD_STATUS_TYPE_INFO = 5,
      WLD_TRNP_SMBR = 4;     
      
private macro RestAccaunt(ca: String, dt: Date): Money
   var Rest: Money,
       rs: RsdRecordset, Query: string, params: TArray;

   if( (wlhead.PrevAccumHeadID != 0) And (wlhead.type == WLD_TYPE_EXTRACT_CUMULATIVE))
      Query = "SELECT h.t_dateout FROM dwlhead_dbt h WHERE h.t_headid = :prevhead";
      params = makeArray( SQLParam( "prevhead", wlhead.PrevAccumHeadID )); 
      rs = execSQLselect( Query, params, false );
      rs.MoveNext();
      Rest = RestA(ca, rs.value(0) );
   else 
      Rest = RestA(ca, dt ); 
   end;

   return Rest;
end;

macro ВыровнятьВправо(val, len, zap): String
   var str = String(val);
   
   if(ValType(zap) == V_UNDEF)
      zap = " ";
   end;

   return MkStr(zap, len - StrLen(str) ) + str;
end;

macro ВыровнятьВлево(val, len, zap): String
   var str = String(val);
   
   if(ValType(zap) == V_UNDEF)
      zap = " ";
   end;

   return str + MkStr(zap, len - StrLen(str) );
end; 

private macro InSaldo(ca: String): String
   var DK:string, Rest: Money, StrRest:string;
   
   Rest = RestAccaunt(ca, wlhead.DateIn - 1);
   StrRest = String( Abs(Rest) );
   if (Rest >= 0) DK = "0 " else DK = "1 " end;

   return DK + ВыровнятьВправо(StrRest, 18);
end;

private macro OutSaldo(ca: String, dam: Double, kam: Double, kindacc: String): String
   var DK:string, Rest: Money, StrRest:string;
   
   Rest = RestAccaunt(ca, wlhead.DateOut);
   
   /*if(kindacc == "А")   //Ариметические нюансы или как хорошо жилось без минусов
      kam = - kam;
      dam = - dam;
   end;*/
   if(RestAccaunt(ca, wlhead.DateIn) != RestAccaunt(ca, wlhead.DateIn-1) + kam - dam )
      if(MsgBoxEx( "Расхождение вычисленного и реального исходящего остатка"+
                  " по счету №" + ca + ". Продолжить формирование?", 
                  MB_YES + MB_NO ) != MB_OK)
         return "";
      end;
   end;

   StrRest = String( Abs(Rest) );
   if (Rest >= 0) DK = "0 " else DK = "1 " end;

   return DK + ВыровнятьВправо(StrRest, 18);
end;

macro TypeDoc(documentid:integer, dk:integer, df:integer): String
   var type = MkStr(" ", 3), RsPaym = RsbPayment( documentid ), form = "", WlpmID, FormID,
       rs: RsdRecordset, Query: string, params: TArray,
       rs2:RsdRecordset, Query2:string, params2:TArray;
   
   if(RsPaym.WlpmID)
      WlpmID = RsPaym.WlpmID;
   elif(RsPaym.OutWlpmID)
      WlpmID = RsPaym.OutWlpmID;
   else
      WlpmID = RsPaym.InWlpmID;
   end;
   
   Query = " SELECT   r.T_NAME                                                 "+
           " FROM dwlmes_dbt m, dwlpm_dbt p, dwlmesrls_dbt r, dwlmeslnk_dbt l  "+
           " WHERE p.t_wlpmid = :wlpmid                                        "+
           " AND l.t_mesid = m.t_mesid                                         "+
           " AND l.t_objid = p.t_wlpmid                                        "+
           " AND l.t_objkind = :payment                                        "+
           " AND r.t_rlsformid = m.t_rlsformid                                 "+
           " ORDER BY m.t_mesid DESC                                           ";
      
   Query = StrSubst(Query, "      ", " ");                                                                                   
   
   params = makeArray( SQLParam( "wlpmid",  WlpmID   ),
                       SQLParam( "payment", OBJTYPE_PAYMENT ) ); 
   
   rs = execSQLselect( Query, params, false );

   if  ((dk == DLDOC_MEMORIALORDER) And (df==1) )
      type = "104";
   elif((dk == DLDOC_MEMORIALORDER) And (df==0) )
      type = "105";
   else
      if(rs.MoveNext())
         form = rs.value(0);
      elif(RsPaym.IsExternal And (Not RsPaym.IsExternalIncoming))
         if(DefineRlsForm(RsPaym,NULL,NULL,FormID))
            Query2 =" SELECT f.T_NAME FROM dwlmesfrm_dbt f "+
                    " WHERE f.t_formid = :formid     ";
            params2 = makeArray( SQLParam( "formid",  FormID )); 

            rs2 = execSQLselect( Query2, params2, false );
            rs2.MoveNext();
            form = rs2.value(0);
         end;
      end;
      if  ( form == sign_0B1) 
         type = "001";
      elif( form == sign_0B2) 
         type = "002";
      elif( form == sign_0B3)
         type = "003";
      elif( form == sign_0B4)
         type = "004";
      elif( form == sign_0B5)
         type = "005";
      elif( form == sign_0B7)
         type = "007";
      elif( form == sign_0BF)
         type = "070";
      end;
   end;

   return type;
end;

macro TypeDoc2(form:string): String
   var type = MkStr(" ", 3);

   if  ( form == sign_0B1)
      type = "001";
   elif( form == sign_0B2)
      type = "002";
   elif( form == sign_0B3)
      type = "003";
   elif( form == sign_0B4)
      type = "004";
   elif( form == sign_0B5)
      type = "005";
   elif( form == sign_0B7)
      type = "007";
   elif( form == sign_0BF)
      type = "070";
   end;

   return type;
end;

macro Cliring10(bankid:integer): String
  var error, CliringCode = MkStr(" ", 10);
  
  CliringCode = ПолучитьКодСубъекта( bankid, PTCK_CLIRING, error );

  if( error )
    CliringCode = MkStr(" ", 10);
  end;
  
  return CliringCode;
end;

macro ВзятьДокументВыписки(kindacc:string, coraccount, corrid): bool
   
   var Query, params, rs: RsdRecordset;
   var ismemorder: integer; 

   Query =" SELECT s.t_account ca, s.t_corrid ci                          "+
          "  FROM daccount_dbt a, dcorschem_dbt s                         "+
          " WHERE s.t_number = :corschem                                  "+
          "   AND s.t_fiid = :fiid                                        "+
          "   AND a.t_chapter = :chapter                                  "+
          "   AND a.t_account = s.t_account                               "+
          "   AND a.t_kind_account = :kind_account                        "+
          "   AND (EXISTS (                                               "+ 
          "           SELECT 1                                            "+ 
          "             FROM dwlmes_dbt m, dwlpm_dbt p, dwlmeslnk_dbt l   "+ 
          "            WHERE p.t_paymentid = :PAYMENTID                   "+ 
          "              AND l.t_mesid = m.t_mesid                        "+ 
          "              AND l.t_objid = p.t_wlpmid                       "+ 
          "              AND l.t_objkind = :PAYMENT) OR :ISMEMORDER <> 0 )"; 

   Query = StrSubst(Query, "      ", " ");                                                                                   
          
   while(ПолучитьДокументВыписки(wlConf))
      if(wlConf.DocKind == DLDOC_MEMORIALORDER)
         ismemorder = 1;
      else
         ismemorder = 0;
      end;
      
      params = makeArray( SQLParam( "CORSCHEM",   wlConf.corschem    ),
                          SQLParam( "FIID"    ,   wlhead.FIID        ),
                          SQLParam( "CHAPTER" ,     CHAPT1         ),
                          SQLParam( "KIND_ACCOUNT", kindacc        ),
                          SQLParam( "PAYMENTID",  wlConf.documentid),
                          SQLParam( "PAYMENT",    OBJTYPE_PAYMENT  ),
                          SQLParam( "ISMEMORDER", ismemorder  )
                          ); 
      rs = execSQLselect( Query, params, false );
      if( rs.MoveNext() )
         if(ValType(coraccount) == V_STRING )
            SetParm(1, rs.value("ca"));
         end;
         if(ValType(corrid)     == V_INTEGER)
            SetParm(2, rs.value("ci"));
         end;
         return true;
      end;
   end;

   return false;
end;

macro DKF(val) 
   if(val == 2)
      return 0;  
   else
      return 1;
   end;   
end;

private macro DateFormat(dat):string
   var день:integer, месяц:integer, год:integer;

   DateSplit(dat, день, месяц, год);
   /*год = Mod(год, 100 );*/

   return ВыровнятьВправо(день,  2, "0") + "/" + 
          ВыровнятьВправо(месяц, 2, "0") + "/" + 
          ВыровнятьВправо(год,   4, "0");  
end;

private macro TimeFormat(tim):string
   var час:integer, минута:integer;

   TimeSplit(tim, час, минута, NULL);

   return ВыровнятьВправо(час,    2, "0") + ":" + 
          ВыровнятьВправо(минута, 2, "0");  
end;

macro IsMemberBlockC(ch1, ch2, sd, st):bool

   var Query, params, rs: RsdRecordset;

   Query = "SELECT TO_CHAR (shi.q_sysdate, 'DD/MM/YYYY') sd,                                "+           
           "       TO_CHAR (shi.q_systime, 'HH24:MI')    st                                 "+
           "  FROM dpmpaym_dbt pm,                                                          "+
           "       dpmprop_dbt pp,                                                          "+
           "       (SELECT   MIN (hi.t_sysdate) q_sysdate,                                  "+
           "                 MIN (hi.t_systime)KEEP (DENSE_RANK FIRST ORDER BY hi.t_sysdate)"+
           "                                                                    q_systime,  "+
           "                 hi.t_paymentid                                                 "+
           "            FROM dpmhist_dbt hi                                                 "+
           "        GROUP BY hi.t_paymentid) shi                                            "+
           " WHERE pm.t_paymentid = :DOCUMENTID                                             "+
           "   AND pm.t_paymentid = pp.t_paymentid                                          "+
           "   AND pm.t_paymentid = shi.t_paymentid                                         "+
           "   AND pp.t_group     = :PGROUP                                                 "+
           "   AND pp.t_issender  <> :RECEIVER                                              "+    
           "   AND NOT EXISTS (                                                             "+ 
           "          SELECT 1                                                              "+
           "            FROM dwlmes_dbt m, dwlpm_dbt p, dwlmeslnk_dbt l                     "+
           "           WHERE p.t_paymentid = pm.t_paymentid                                 "+
           "             AND l.t_mesid     = m.t_mesid                                      "+
           "             AND l.t_objid     = p.t_wlpmid                                     "+    
           "             AND l.t_objkind   = :PAYMENT)                                      ";

   Query = StrSubst(Query, "      ", " ");                                                                                   

   params = makeArray( SQLParam( "DOCUMENTID", wlconf.documentid ),
                       SQLParam( "PGROUP",     PAYMENTS_GROUP_EXTERNAL ),
                       SQLParam( "RECEIVER",   "X" ),
                       SQLParam( "PAYMENT",    OBJTYPE_PAYMENT )); 
 
   rs = execSQLselect( Query, params, false );

   if(rs.MoveNext())
      SetParm(2, rs.value("sd"));
      SetParm(3, rs.value("st"));
      return true;
   end;
                    
   return false;
end;

/* Генерация информационного сообщения */
macro GenMesExec( Parm )
  var field_value, error, CodeKind, PartyID: integer, RecipID: integer = 0, 
      n, kam:Money, dam:Money, knum, dnum, num, am:Money, isfirst, 
      corracc1: string = "", corracc2: string = "", 
      isNoPassiv = false, isNoActiv = false, ch1, ch2, 
      rs: RsdRecordset, Query: string, params: TArray;

  var so, dn, td, ac, ra, df, su:Money, nu, di, dk, bi, dv, de, sd, st;

      
  /* Тип документа */
  f_wlmesrls.RlsFormID = wlmes.RlsFormID;
  if(not GetEQ(f_wlmesrls))
    std.msg("Ошибка поиска релиза формы: "+string(wlmes.RlsFormID));
    return false;
  end;
  
  f_wlmesfrm.FormID = f_wlmesrls.FormID;
  if( not GetEQ(f_wlmesfrm) )
    std.msg("Ошибка поиска формы: "+string(f_wlmesrls.FormID));
    return false;
  end;

  CodeKind = PTCK_CLIRING;

  /* Участник-отправитель, он же банк-создатель телеграммы */
  if(wlhead.OriginatorID == 0)
     PartyID = {OurBank};
  else
     PartyID = wlhead.OriginatorID;
  end;
  
  field_value = ПолучитьКодСубъекта( PartyID, CodeKind, error );
  if( error != 0 )
    /* Не найден такой код */
    RunError( "|Для банка-создателя не найден код с видом кода: " + CodeKind );
  end;
  SB_ЗаписатьПолеЛог( "PA", CB_StrSubst0( String(field_value:10) ), Parm );

  /*Вот такой нессиметричный код для сиссетричных вещей :(**/
  УстановитьФильтрДокументовВыписки(wlhead.HeadID);        //
  if(ВзятьДокументВыписки(KA_P, corracc1, RecipID) )       //
     ch1 = wlConf.Corschem;                                //
  else                                                     //
     УстановитьФильтрДокументовВыписки(wlhead.HeadID);     //
     ВзятьДокументВыписки(KA_A, corracc2, RecipID);        //
     ch2 = wlConf.Corschem;                                //
     ch1 = ch2;                                            //
     isNoPassiv = true;                                    //
  end;                                                     //
                                                           //
  if(not isNoPassiv)                                       //
     УстановитьФильтрДокументовВыписки(wlhead.HeadID);     //
     if(ВзятьДокументВыписки(KA_A, corracc2))              //
        ch2 = wlConf.Corschem;                             //
     else                                                  //
        ch2 = ch1;                                         //
        isNoActiv = true;                                  //
     end;                                                  //
  end;                                                     //
  /*********************************************************/

  if( wlhead.RecipientID != 0 )                         
     RecipID = wlhead.RecipientID;                      
  else
     RecipID = wlmes.OutsideAbonentID;
  end;                                                  
  
  field_value = ПолучитьКодСубъекта( RecipID, CodeKind, error );
  if( error != 0 )
    /* Не найден такой код */
    RunError( "|Для банка-получателя не найден код с видом кода: " + CodeKind );
  end;
  SB_ЗаписатьПолеЛог( "RC", CB_StrSubst0( String(field_value:10) ), Parm );

  /* Тип выписки */
  SB_ЗаписатьПолеЛог( "VT", wlhead.type, Parm );
  
  /* Код выписки */
  if( wlhead.SubKind == 0 )
     field_value = "019";
  elif( wlhead.SubKind == 1 )
     field_value = "020";  
  else
     RunError( "Неизвестный код выписки" );
  end;
  SB_ЗаписатьПолеЛог( "VCODE", field_value, Parm );
  
  /*Номер выписки*/  
  if(SubStr(wlhead.Number,20,1) == "0")
     field_value= SubStr(wlhead.Number,21,2);
  else
     RunError( "Номер выписки больше 100" );
  end;
  SB_ЗаписатьПолеЛог( "VNUM", field_value, Parm );

  if( wlhead.FIID != NATCUR )
     RunError( "Выписка по счетам МФР может был только в рублях" );
  end;
  SB_ЗаписатьПолеЛог( "CU", "RUR", Parm );

  SB_ЗаписатьПолеЛог(  "DATEIN" , DateFormat(wlhead.DateIn) , Parm );
  SB_ЗаписатьПолеЛог(  "DATEOUT", DateFormat(wlhead.DateOut), Parm );

  /*Дата предыдущей выписки.********************************* 
  Алгоритм:                                                //
     1. Ищется вторая корсхема для данной выписки.         //
     2. Ищутся все исходящие выписки по двум корсхемам.    //
     3. Берется максимальное значение wlhead.SysDate       //
        из полученного списка.                             //
  И его реализация: */                                     //
                                                           //
  Query =" SELECT TO_CHAR(MAX(h.t_sysdate), 'DD/MM/YYYY')"+//
         " FROM dwlhead_dbt h                   "+         //
         " WHERE h.t_fiid = :FIID AND           "+         //
         "       h.t_corschem in ( :CH1, :CH2 ) ";         //
                                                           //
  params = makeArray( SQLParam( "FIID", wlhead.FIID ),     //
                      SQLParam( "CH1" , ch1 ),             //
                      SQLParam( "CH2" , ch2 ) );           //
                                                           //
  rs = execSQLselect( Query, params, false );              //
  rs.MoveNext();                                           //
  /*********************************************************/
  if( rs.value(0) == "" )
    SB_ЗаписатьПолеЛог( "PVB", rs.value(0), Parm );
  else
    SB_ЗаписатьПолеЛог( "PVB", GetDateAfterWorkDays({CurDate},-1), Parm );
  end;

  /*Дата и время формирования выписки*/          
  SB_ЗаписатьПолеЛог( "VDATE", DateFormat(Date())/*wlhead.SysDate*/, Parm );
  SB_ЗаписатьПолеЛог( "VTIME", TimeFormat(Time())/*wlhead.SysTime*/, Parm );

  /*********************** Заполняем блок А **************************/
  if( not isNoPassiv )
     УстановитьФильтрДокументовВыписки(wlhead.HeadID);
     
     SB_ЗаписатьПолеЛогВБлок( "A", "ACC" , ВыровнятьВлево (corracc1, 20), Parm );
     SB_ЗаписатьПолеЛогВБлок( "A", "INBL", InSaldo(corracc1)            , Parm );

     n = 1;
     dnum = knum = 0;        
     dam = kam = 0; 
     while( ВзятьДокументВыписки(KA_P) )
        so = wlConf.shifroper; 
        dn = wlConf.docnumber;
        td = DateFormat(wlConf.transferdate);
        ac = wlConf.account;            
        ra = wlConf.receiveraccount;
        df = DKF(wlConf.dkflag);
        su = wlConf.sum; 
        nu = ВыровнятьВлево(wlConf.number, 22); 
        di = wlConf.documentid;
        dk = wlConf.dockind;
        bi = wlConf.bankid;        
        dv = DateFormat(wlConf.datevalue);
        de = wlConf.description;            
        
        SB_ЗаписатьПолеЛогВБлок( "A/DOC", "DOC", String(
          ВыровнятьВправо(String(n), 6, "0" ), " ",                          /*Num*/
          ВыровнятьВправо(so, 7 ),             " ",                          /*Kind*/
          ВыровнятьВлево(SubStr(dn, 1, 6 ), 6)," ",                          /*ClNum*/
          td,                                  " ",                          /*ClDate*/
          ВыровнятьВлево(ac, 20),              " ",                          /*CorrAcc*/
          ВыровнятьВлево(ra, 20),              " ",                          /*Acc*/
          df,                                  "   ",                        /*D/K*/
          ВыровнятьВправо(String(su), 18),     " ",                          /*Sum*/
          SubStr( nu, 1, 6 ), " ",
             SubStr( nu, 7, 10 )," ", 
                SubStr( nu, 17 ),              " ",                          /*TRN*/
          TypeDoc(di, dk, df),                 "  ",                         /*Type*/
          Cliring10(bi),                       " ",                          /*ResipientID*/
          dv,                                  " ",                          /*CDate*/
          de                                                                 /*Descr*/
        ),
        Parm );
        
        n = n + 1;

        if(df == 1)
           dnum = dnum + 1;
           dam = dam + su;
        else
           knum = knum + 1;
           kam = kam + su;
        end;
     end;

     if( n==1 ) УстановитьКонтекстБлокаЛог(".."); end;
     
     SB_ЗаписатьПолеЛогВБлок( "A", "DAM" , ВыровнятьВправо(String(dam), 18),        Parm );
     SB_ЗаписатьПолеЛогВБлок( "A", "DNUM", ВыровнятьВправо(String(dnum), 6),  Parm );
     SB_ЗаписатьПолеЛогВБлок( "A", "KAM" , ВыровнятьВправо(String(kam), 18),        Parm );
     SB_ЗаписатьПолеЛогВБлок( "A", "KNUM", ВыровнятьВправо(String(knum), 6),  Parm );

     field_value = OutSaldo(corracc1, dam, kam, KA_P);
     if( field_value == "" )
        return FALSE;
     end;
     SB_ЗаписатьПолеЛогВБлок( "A", "OUTBL", field_value, Parm );

     УстановитьКонтекстБлокаЛог("");
  end;
  /*******************************************************************/
  /*********************** Заполняем блок B **************************/
  if( not isNoActiv )
     УстановитьФильтрДокументовВыписки(wlhead.HeadID);
     
     SB_ЗаписатьПолеЛогВБлок( "B", "ACC" , ВыровнятьВлево( corracc2, 20), Parm, true );
     SB_ЗаписатьПолеЛогВБлок( "B", "INBL", InSaldo(corracc2)        , Parm );

     n = 1;
     dnum = knum = 0;        
     dam = kam = 0; 
     while( ВзятьДокументВыписки(KA_A) )
        so = wlConf.shifroper; 
        dn = wlConf.docnumber;
        td = DateFormat(wlConf.transferdate);
        ac = wlConf.account;            
        ra = wlConf.receiveraccount;
        df = DKF(wlConf.dkflag);
        su = wlConf.sum; 
        nu = ВыровнятьВлево(wlConf.number, 22); 
        di = wlConf.documentid;
        dk = wlConf.dockind;
        bi = wlConf.bankid;        
        dv = DateFormat(wlConf.datevalue);
        de = wlConf.description;            
        
        SB_ЗаписатьПолеЛогВБлок( "B/DOC", "DOC", String(
          ВыровнятьВправо(String(n), 6, "0" ), " ",                          /*Num*/
          ВыровнятьВправо(so, 7 ),             " ",                          /*Kind*/
          ВыровнятьВлево(SubStr(dn, 1, 6 ), 6)," ",                          /*ClNum*/
          td,                                  " ",                          /*ClDate*/
          ВыровнятьВлево(ac, 20),              " ",                          /*CorrAcc*/
          ВыровнятьВлево(ra, 20),              " ",                          /*Acc*/
          df,                                  "   ",                        /*D/K*/
          ВыровнятьВправо(String(su), 18),     " ",                          /*Sum*/
          SubStr( nu, 1, 6 ), " ",
             SubStr( nu, 7, 10 )," ", 
                SubStr( nu, 17 ),              " ",                          /*TRN*/
          TypeDoc(di, dk, df),                 "  ",                         /*Type*/
          Cliring10(bi),                       " ",                          /*ResipientID*/
          dv,                                  " ",                          /*CDate*/
          de                                                           /*Descr*/
        ),
        Parm );
        
        n = n + 1;

        if(df == 1)
           dnum = dnum + 1;
           dam = dam + su;
        else
           knum = knum + 1;
           kam = kam + su;
        end;
     end;

     if( n==1 ) УстановитьКонтекстБлокаЛог(".."); end;
     
     SB_ЗаписатьПолеЛогВБлок( "B", "DAM" , ВыровнятьВправо(String(dam), 18),        Parm );
     SB_ЗаписатьПолеЛогВБлок( "B", "DNUM", ВыровнятьВправо(String(dnum), 6),  Parm );
     SB_ЗаписатьПолеЛогВБлок( "B", "KAM" , ВыровнятьВправо(String(kam), 18),        Parm );
     SB_ЗаписатьПолеЛогВБлок( "B", "KNUM", ВыровнятьВправо(String(knum), 6),  Parm );

     field_value = OutSaldo(corracc2, dam, kam, KA_A);
     if( field_value == "" )
        return FALSE;
     end;
     SB_ЗаписатьПолеЛогВБлок( "B", "OUTBL", field_value, Parm );
  
     УстановитьКонтекстБлокаЛог("");
  end;
  /*******************************************************************/
  /*********************** Заполняем блок C **************************/
  Query = 
  "SELECT TO_CHAR (NVL (sm.q_sysdate, oo.t_syst_date), 'DD/MM/YYYY') sd,           "+
  "       TO_CHAR (NVL (sm.q_systime, oo.t_syst_time), 'HH24:MI') st,              "+
  "       pr.t_number dn, TO_CHAR (pm.t_valuedate, 'DD/MM/YYYY') td,               "+
  "       DECODE (pp.t_debetcredit, 0, 1, 1, 0) df, pm.t_payamount su,             "+
  "       NVL (sm.t_trn, CHR (0)) nu, pm.t_paymentid di, pm.t_dockind dk,          "+
  "       CHR (0) de                                                               "+
  "  FROM dpmpaym_dbt pm,                                                          "+
  "       dpmprop_dbt pp,                                                          "+
  "       dpmrmprop_dbt pr,                                                        "+
  "       doproper_dbt oo,                                                         "+
  "       (SELECT   m.t_trn, p.t_paymentid, MIN (hr.t_sysdate) q_sysdate,          "+
  "                 MIN (hr.t_systime)KEEP (DENSE_RANK FIRST ORDER BY hr.t_sysdate)"+
  "                                                                    q_systime   "+
  "            FROM dwlmes_dbt m, dwlpm_dbt p, dwlmeslnk_dbt l, dwlhistor_dbt hr   "+
  "           WHERE l.t_mesid = m.t_mesid                                          "+
  "             AND l.t_objid = p.t_wlpmid                                         "+
  "             AND l.t_objkind = :PAYMENT                                         "+
  "             AND hr.t_objid = m.t_mesid                                         "+
  "             AND hr.t_objkind = :MESSAGE                                        "+
  "        GROUP BY hr.t_objid, hr.t_objkind, m.t_trn, p.t_paymentid) sm,          "+
  "       (SELECT oo.t_documentid, oc.t_statuskindid, os.t_numvalue                "+
  "          FROM doproper_dbt oo, doprcurst_dbt oc, doprstval_dbt os              "+
  "         WHERE oc.t_id_operation(+) = oo.t_id_operation                         "+
  "           AND oc.t_statuskindid(+) = :PAYMACCEPT                               "+
  "           AND os.t_numvalue(+) = oc.t_numvalue                                 "+
  "           AND os.t_statuskindid(+) = oc.t_statuskindid                         "+
  "           AND os.t_numvalue = :STATACCEPT) so                                  "+
  " /*Платеж является входящим*/                                                   "+
  "WHERE  pp.t_group = :PGROUP                                                     "+
  "   AND pp.t_issender = :SENDER                                                  "+
  "   AND pm.t_paymentid = pp.t_paymentid                                          "+
  "   AND pm.t_paymentid = pr.t_paymentid                                          "+
  "   AND oo.t_dockind =                                                           "+
  "                  DECODE (pm.t_primdockind,                                     "+
  "                          0, pm.t_dockind,                                      "+
  "                          pm.t_primdockind                                      "+
  "                         )                                                      "+
  "   AND oo.t_documentid = LPAD (TO_CHAR (pm.t_paymentid), 34, '0')               "+
  "   /*Дата платежа входит в период выписки*/                                     "+
  "   AND pm.t_valuedate BETWEEN :DATEIN AND :DATEOUT                              "+
  "   /*Корсхема платежа соответствует одной из парных корсхем выписки*/           "+
  "   AND pp.t_corschem IN (:SHEM1, :SHEM2)                                        "+
  "   /*К платежу не привязано проводок*/                                          "+
  "   AND NOT EXISTS (SELECT 1                                                     "+
  "                     FROM dpmdocs_dbt pd                                        "+
  "                    WHERE pd.t_paymentid = pm.t_paymentid)                      "+
  "   /*Сегмент статуса платежа 'Акцепт' равен 'Не требуется'*/                    "+
  "   AND so.t_documentid = LPAD (TO_CHAR (pm.t_paymentid), 34, '0')               "+
  "   /*подзапрос для mesid*/                                                      "+
  "   AND pm.t_paymentid = sm.t_paymentid(+)                                       ";

  Query = StrSubst(Query, "      ", " ");                                                                                   

  params  = makeArray( SQLParam( "PAYMENT",    OBJTYPE_PAYMENT ),
                       SQLParam( "MESSAGE",    OBJTYPE_WLD_MES ),
                       SQLParam( "PAYMACCEPT", OPR_PAYM_ACCEPT ),
                       SQLParam( "STATACCEPT", OPR_PAYM_ST_ACPT_NONE ),
                       SQLParam( "PGROUP",     PAYMENTS_GROUP_EXTERNAL ),
                       SQLParam( "SENDER",     "X" ), 
                       SQLParam( "DATEIN",     wlhead.DATEIN ),
                       SQLParam( "DATEOUT",    wlhead.DATEOUT),
                       SQLParam( "SHEM1",      ch1 ),
                       SQLParam( "SHEM2",      ch2 )); 
  
  if( not ((wlhead.DateIn > {curdate}) or (wlhead.DateOut < {curdate})) )
     n = 1;
     dnum = knum = 0;        
     dam = kam = 0; 
     УстановитьФильтрДокументовВыписки(wlhead.HeadID);
     
     while(ПолучитьДокументВыписки(wlConf))
        if(IsMemberBlockC(ch1, ch2, sd, st))
           dn = wlConf.docnumber;
           td = DateFormat(wlConf.transferdate);
           df = DKF(wlConf.dkflag);
           su = wlConf.sum; 
           nu = ВыровнятьВлево(wlConf.number, 22); 
           di = wlConf.documentid;
           dk = wlConf.dockind;
           de = wlConf.description;            
           
           SB_ЗаписатьПолеЛогВБлок( "C/DOC", "DOC", String(
             ВыровнятьВправо(String(n), 6, "0"),            " ",            /*Num*/
             sd,                                            "  ",           /*EDate*/
             st,                                            " ",            /*ETime*/
             ВыровнятьВлево(SubStr( dn, 1, 6 ), 6),         " ",            /*ClNum*/
             td,                                            " ",            /*ClDate*/
             df,                                            "   ",          /*D/K*/
             ВыровнятьВправо(su ,18 ),                      " ",            /*Sum*/
             SubStr( nu, 1, 6 ), " ", 
                SubStr( nu, 7, 10 ), " ", SubStr( nu, 17 ), " ",            /*TRN*/
             TypeDoc(di, dk, df),                           "  ",           /*Type*/
             de                                                             /*Descr*/
           ),
           Parm );
           
           n = n + 1;
           
           if(df == 1)
              dnum = dnum + 1;
              dam = dam + su;
           else
              knum = knum + 1;
              kam = kam + su;
           end;
        end;
     end;
     rs = execSQLselect( Query, params, false );
     while( rs.MoveNext() )
        nu = ВыровнятьВлево(rs.value("nu"), 22);
        SB_ЗаписатьПолеЛогВБлок( "C/DOC", "DOC", String(
          ВыровнятьВправо(String(n), 6, "0"),               " ",            /*Num*/
          rs.value("sd"),                                   "  ",           /*EDate*/
          rs.value("st"),                                   " ",            /*ETime*/
          ВыровнятьВлево(SubStr( rs.value("dn"), 1, 6 ), 6)," ",            /*ClNum*/
          rs.value("td"),                                   " ",            /*ClDate*/
          rs.value("df"),                                   "   ",          /*D/K*/
          ВыровнятьВправо(rs.value("su"), 18 ),             " ",            /*Sum*/
          SubStr( nu, 1, 6 ), " ", 
               SubStr( nu, 7, 10 ), " ", SubStr( nu, 17 ),  " ",            /*TRN*/
          TypeDoc(rs.value("di"), 
                           rs.value("dk"), rs.value("df")), "  ",           /*Type*/
          rs.value("de")                                                    /*Descr*/
        ),
        Parm );
        
        n = n + 1;

        if(rs.value("df") == 1)
           dnum = dnum + 1;
           dam = dam + rs.value("su");
        else
           knum = knum + 1;
           kam = kam + rs.value("su");
        end;
     end;

     if( n==1 ) УстановитьКонтекстБлокаЛог(".."); end;

     SB_ЗаписатьПолеЛогВБлок( "C", "DAM" , ВыровнятьВправо( String(dam),  18),     Parm );
     SB_ЗаписатьПолеЛогВБлок( "C", "DNUM", ВыровнятьВправо( String(dnum),  6), Parm );
     SB_ЗаписатьПолеЛогВБлок( "C", "KAM" , ВыровнятьВправо( String(kam),  18),    Parm );
     SB_ЗаписатьПолеЛогВБлок( "C", "KNUM", ВыровнятьВправо( String(knum),  6), Parm );
  
     УстановитьКонтекстБлокаЛог("");
  end;
  
  /*******************************************************************/
  /*********************** Заполняем блок D **************************/
  Query ="SELECT TO_CHAR ((sos.q_sysdate), 'DD/MM/YYYY') sd,                              "+
         "       TO_CHAR ((sos.q_systime), 'HH24:MI') st, pr.t_number dn,                 "+
         "       TO_CHAR (pm.t_valuedate, 'DD/MM/YYYY') td,                               "+
         "       DECODE (pp.t_debetcredit, 0, 1, 1, 0) df, pm.t_payamount su,             "+
         "       NVL (sm.t_trn, CHR (0)) nu, pm.t_paymentid di, pm.t_dockind dk           "+
         "  FROM dpmpaym_dbt pm,                                                          "+
         "       dpmprop_dbt pp,                                                          "+
         "       dpmrmprop_dbt pr,                                                        "+
         "       doproper_dbt oo,                                                         "+
         "       (SELECT   t_id_operation,                                                "+
         "                 MAX (t_syst_date)KEEP (DENSE_RANK LAST ORDER BY t_id_step)     "+
         "                                                                    q_sysdate,  "+
         "                 MAX (t_syst_time)KEEP (DENSE_RANK LAST ORDER BY t_id_step)     "+
         "                                                                    q_systime   "+
         "            FROM doprstep_dbt os                                                "+
         "        GROUP BY t_id_operation, t_isexecute                                    "+
         "          HAVING t_isexecute = :EXECSTEP) sos,                                  "+
         "       (SELECT   m.t_trn, p.t_paymentid, MIN (hr.t_sysdate) q_sysdate,          "+
         "                 MIN (hr.t_systime)KEEP (DENSE_RANK FIRST ORDER BY hr.t_sysdate)"+
         "                                                                    q_systime   "+
         "            FROM dwlmes_dbt m, dwlpm_dbt p, dwlmeslnk_dbt l, dwlhistor_dbt hr   "+
         "           WHERE l.t_mesid = m.t_mesid                                          "+
         "             AND l.t_objid = p.t_wlpmid                                         "+
         "             AND l.t_objkind = :PAYMENT                                         "+
         "             AND hr.t_objid = m.t_mesid                                         "+
         "             AND hr.t_objkind = :MESSAGE                                        "+
         "        GROUP BY hr.t_objid, hr.t_objkind, m.t_trn, p.t_paymentid) sm,          "+
         "       (SELECT oo.t_documentid, oc.t_statuskindid, os.t_numvalue                "+
         "          FROM doproper_dbt oo, doprcurst_dbt oc, doprstval_dbt os              "+
         "         WHERE (    oc.t_id_operation(+) = oo.t_id_operation                    "+
         "                AND oc.t_statuskindid(+) = :PAYMSTATE                           "+
         "                AND os.t_numvalue(+) = oc.t_numvalue                            "+
         "                AND os.t_statuskindid(+) = oc.t_statuskindid                    "+
         "                AND os.t_numvalue = :STATSTATE                                  "+
         "               )                                                                "+
         "        UNION                                                                   "+
         "        SELECT oo.t_documentid, oc.t_statuskindid, os.t_numvalue                "+
         "          FROM doproper_dbt oo, doprcurst_dbt oc, doprstval_dbt os              "+
         "         WHERE (    oc.t_id_operation(+) = oo.t_id_operation                    "+
         "                AND oc.t_statuskindid(+) = :PAYMACCEPT                          "+
         "                AND os.t_numvalue(+) = oc.t_numvalue                            "+
         "                AND os.t_statuskindid(+) = oc.t_statuskindid                    "+
         "                AND os.t_numvalue = :STATACCEPT                                 "+
         "               )) so                                                            "+
         " /*Платеж является входящим*/                                                   "+
         "WHERE  pp.t_group = :PGROUP                                                     "+
         "   AND pp.t_issender = :SENDER                                                  "+
         "   AND pm.t_paymentid = pp.t_paymentid                                          "+
         "   AND pm.t_paymentid = pr.t_paymentid                                          "+
         "   AND oo.t_dockind =                                                           "+
         "                  DECODE (pm.t_primdockind,                                     "+
         "                          0, pm.t_dockind,                                      "+
         "                          pm.t_primdockind                                      "+
         "                         )                                                      "+
         "   AND oo.t_documentid = LPAD (TO_CHAR (pm.t_paymentid), 34, '0')               "+
         "   /*Дата платежа входит в период выписки*/                                     "+
         "    AND pm.t_valuedate BETWEEN :DATEIN AND :DATEOUT                             "+ 
         "    /*Корсхема платежа соответствует одной из парных корсхем выписки*/          "+ 
         "    AND pp.t_corschem IN (:SHEM1, :SHEM2)                                       "+    
         "    /*Сегмент статуса платежа 'Состояние платежа' равен 'Отвергнут'*/           "+    
         "    /*или сегмент статуса платежа 'Акцепт' равен 'Отказ от акцепта'*/           "+    
         "    AND so.t_documentid = LPAD (pm.t_paymentid, 34, '0')                        "+    
         "    /*подзапрос для mesid*/                                                     "+    
         "    AND pm.t_paymentid = sm.t_paymentid(+)                                      "+    
         "    /*выполненные шаги платежа*/                                                "+    
         "    AND sos.t_id_operation = oo.t_id_operation                                  ";    

  Query = StrSubst(Query, "      ", " ");                                                                                   
         
  params = makeArray( SQLParam( "EXECSTEP",   EXECSTEP ),
                      SQLParam( "PAYMENT",    OBJTYPE_PAYMENT ),
                      SQLParam( "MESSAGE",    OBJTYPE_WLD_MES  ),
                      SQLParam( "PAYMSTATE",  OPR_PAYM_STATE ),
                      SQLParam( "STATSTATE",  OPR_PM_ST_REJECT ),
                      SQLParam( "PAYMACCEPT", OPR_PAYM_ACCEPT  ),
                      SQLParam( "STATACCEPT", OPR_PAYM_ST_ACPT_REJECTED ),
                      SQLParam( "PGROUP",     PAYMENTS_GROUP_EXTERNAL ),
                      SQLParam( "SENDER",     "X" ),
                      SQLParam( "DATEIN",     wlhead.DATEIN ),
                      SQLParam( "DATEOUT",    wlhead.DATEOUT),
                      SQLParam( "SHEM1",      ch1 ),
                      SQLParam( "SHEM2",      ch2 )); 
  
  rs = execSQLselect( Query, params, false );
  
  n = 1; 
  num = 0;
  am = 0; 
  while( rs.MoveNext() )
     nu = ВыровнятьВлево(rs.value("nu"), 22);
     SB_ЗаписатьПолеЛогВБлок( "D/DOC", "DOC", String(
       ВыровнятьВправо(String(n), 6, "0"),             " ",                  /*Num*/
       rs.value("sd"),                                 "  ",                 /*EDate*/
       rs.value("st"),                                 " ",                  /*ETime*/
       ВыровнятьВлево(SubStr(rs.value("dn"), 1, 6 ),6)," ",                  /*ClNum*/
       rs.value("td"),                                 " ",                  /*ClDate*/
       rs.value("df"),                                 "   ",                /*D/K*/
       ВыровнятьВправо(String(rs.value("su")), 18),    " ",                  /*Sum*/
       SubStr( nu, 1, 6 ), " ", 
            SubStr( nu, 7, 10 ), " ", SubStr( nu, 17 )," ",                  /*TRN*/
       TypeDoc(rs.value("di"), rs.value("dk"), rs.value("df"))               /*Type*/
     ),
     Parm );
     
     n = n + 1;

     num = num + 1;
     am = am + rs.value("su");
  end;

  if( n==1 ) УстановитьКонтекстБлокаЛог(".."); end;


  SB_ЗаписатьПолеЛогВБлок( "D", "AM" , ВыровнятьВправо( String(am), 18), Parm );
  SB_ЗаписатьПолеЛогВБлок( "D", "NUM", ВыровнятьВправо( String(num), 6), Parm );

  УстановитьКонтекстБлокаЛог("");
  /*******************************************************************/
  /*********************** Заполняем блок E **************************/
  Query ="SELECT TO_CHAR ((sos.q_sysdate), 'DD/MM/YYYY') sd,                              "+
         "       TO_CHAR ((sos.q_systime), 'HH24:MI') st,                                 "+
         "       pr.t_number dn, TO_CHAR (pm.t_valuedate, 'DD/MM/YYYY') td,               "+
         "       DECODE (pp.t_debetcredit, 0, 1, 1, 0) df, pm.t_payamount su,             "+
         "       NVL (sm.t_trn, CHR (0)) nu                                               "+
         "  FROM dpmpaym_dbt pm,                                                          "+
         "       dpmprop_dbt pp,                                                          "+
         "       dpmrmprop_dbt pr,                                                        "+
         "       dpmdemand_dbt pd,                                                        "+
         "      doproper_dbt oo,                                                          "+
         "       (SELECT   t_id_operation,                                                "+
         "                 MAX (t_syst_date)KEEP (DENSE_RANK LAST ORDER BY t_id_step)     "+
         "                                                                    q_sysdate,  "+
         "                 MAX (t_syst_time)KEEP (DENSE_RANK LAST ORDER BY t_id_step)     "+
         "                                                                    q_systime   "+
         "            FROM doprstep_dbt os                                                "+
         "        GROUP BY t_id_operation, t_isexecute                                    "+
         "          HAVING t_isexecute = :EXECSTEP) sos,                                  "+
         "       (SELECT   m.t_trn, p.t_paymentid, MIN (hr.t_sysdate) q_sysdate,          "+
         "                 MIN (hr.t_systime)KEEP (DENSE_RANK FIRST ORDER BY hr.t_sysdate)"+
         "                                                                    q_systime   "+
         "            FROM dwlmes_dbt m, dwlpm_dbt p, dwlmeslnk_dbt l, dwlhistor_dbt hr   "+
         "           WHERE l.t_mesid = m.t_mesid                                          "+
         "             AND l.t_objid = p.t_wlpmid                                         "+
         "             AND l.t_objkind = :PAYMENT                                         "+
         "             AND hr.t_objid = m.t_mesid                                         "+
         "             AND hr.t_objkind = :MESSAGE                                        "+
         "        GROUP BY hr.t_objid, hr.t_objkind, m.t_trn, p.t_paymentid) sm,          "+
         "       (SELECT oo.t_documentid, oc.t_statuskindid, os.t_numvalue                "+
         "          FROM doproper_dbt oo, doprcurst_dbt oc, doprstval_dbt os              "+
         "         WHERE (    oc.t_id_operation = oo.t_id_operation                       "+
         "                AND oc.t_statuskindid = :PAYMSTATE                              "+
         "                AND os.t_numvalue = oc.t_numvalue                               "+
         "                AND os.t_statuskindid = oc.t_statuskindid                       "+
         "                AND os.t_numvalue = :STATSTATE                                  "+
         "               )) so,                                                           "+
         "       (SELECT oo.t_documentid, oc.t_statuskindid, os.t_numvalue                "+
         "          FROM doproper_dbt oo, doprcurst_dbt oc, doprstval_dbt os              "+
         "         WHERE (    oc.t_id_operation = oo.t_id_operation                       "+
         "                AND oc.t_statuskindid = :PAYMACCEPT                             "+
         "                AND os.t_numvalue = oc.t_numvalue                               "+
         "                AND os.t_statuskindid = oc.t_statuskindid                       "+
         "                AND os.t_numvalue = :STATACCEPT                                 "+
         "               )) so2                                                           "+
         " /*Платеж является внешним*/                                                    "+
         "WHERE  pp.t_group = :PGROUP                                                     "+
         "   AND pm.t_paymentid = pp.t_paymentid                                          "+
         "   AND pm.t_paymentid = pr.t_paymentid                                          "+ 
         "   AND oo.t_dockind =                                                           "+ 
         "                  DECODE (pm.t_primdockind,                                     "+ 
         "                          0, pm.t_dockind,                                      "+ 
         "                          pm.t_primdockind                                      "+ 
         "                         )                                                      "+ 
         "   AND oo.t_documentid = LPAD (TO_CHAR (pm.t_paymentid), 34, '0')               "+ 
         "   /*Для платежа имеется запись в таблице pmdemand.dbt*/                        "+ 
         "   AND pm.t_paymentid = pd.t_paymentid                                          "+ 
         "   /*Дата платежа входит в период выписки*/                                     "+ 
         "   AND pm.t_valuedate BETWEEN :DATEIN AND :DATEOUT                              "+ 
         "   /*Корсхема платежа соответствует одной из парных корсхем выписки*/           "+ 
         "   AND pp.t_corschem IN (:SHEM1, :SHEM2)                                        "+ 
         "   /*Сегмент статуса платежа 'Состояние платежа' равен 'Закрыт'*/               "+ 
         "   AND so.t_documentid = LPAD (pm.t_paymentid, 34, '0')                         "+ 
         "   /*Сегмент статуса платежа 'Акцепт' равен 'Акцептован'*/                      "+ 
         "   AND so2.t_documentid = LPAD (pm.t_paymentid, 34, '0')                        "+ 
         "   /*подзапрос для mesid*/                                                      "+ 
         "   AND pm.t_paymentid = sm.t_paymentid(+)                                       "+ 
         "   /*выполненные шаги платежа*/                                                 "+ 
         "   AND sos.t_id_operation = oo.t_id_operation                                   "; 
                                                                               
  Query = StrSubst(Query, "      ", " ");                                                                                   

  params = makeArray( SQLParam( "EXECSTEP",   EXECSTEP ),
                      SQLParam( "PAYMENT",    OBJTYPE_PAYMENT ),               
                      SQLParam( "MESSAGE",    OBJTYPE_WLD_MES  ),
                      SQLParam( "PAYMSTATE",  OPR_PAYM_STATE ),
                      SQLParam( "STATSTATE",  OPR_PM_ST_CLOSE ),
                      SQLParam( "PAYMACCEPT", OPR_PAYM_ACCEPT  ),
                      SQLParam( "STATACCEPT", OPR_PAYM_ST_ACPT_ACCEPTED ),
                      SQLParam( "PGROUP",     PAYMENTS_GROUP_EXTERNAL ),
                      SQLParam( "DATEIN",     wlhead.DATEIN ),
                      SQLParam( "DATEOUT",    wlhead.DATEOUT),
                      SQLParam( "SHEM1",      ch1 ),
                      SQLParam( "SHEM2",      ch2 )); 
  
  rs = execSQLselect( Query, params, false );
  
  n = 1; 
  num = 0; 
  am = 0; 
  while( rs.MoveNext() )
     nu = ВыровнятьВлево(rs.value("nu"), 22);
     SB_ЗаписатьПолеЛогВБлок( "E/DOC", "DOC", String(
       ВыровнятьВправо(String(n), 6, "0"),             " ",                  /*Num*/
       rs.value("sd"),                                 "  ",                 /*EDate*/
       rs.value("st"),                                 " ",                  /*ETime*/
       ВыровнятьВлево(SubStr(rs.value("dn"), 1, 6 ),6)," ",                  /*ClNum*/
       rs.value("td"),                                 " ",                  /*ClDate*/
       rs.value("df"),                                 "   ",                /*D/K*/
       ВыровнятьВправо(String(rs.value("su")), 18),    " ",                  /*Sum*/
       SubStr( nu, 1, 6 ), " ", 
            SubStr( nu, 7, 10 ), " ", SubStr( nu, 17 )                       /*TRN*/
     ),
     Parm );
     
     n = n + 1;

     num = num + 1;
     am = am + rs.value("su");
  end;

  if(n == 1) УстановитьКонтекстБлокаЛог("..") end;

  SB_ЗаписатьПолеЛогВБлок( "E", "AM" , ВыровнятьВправо(String(am), 18),     Parm );
  SB_ЗаписатьПолеЛогВБлок( "E", "NUM", ВыровнятьВправо(String(num), 6), Parm);

  УстановитьКонтекстБлокаЛог("");
  /*******************************************************************/
  /*********************** Заполняем блок F **************************/
  Query ="SELECT TO_CHAR (wlinfo.t_sysdate, 'DD/MM/YYYY') sd,                 "+
         "       TO_CHAR (wlinfo.t_systime, 'HH24:MI') st, wlinfo.t_trn nu,   "+
         "       wlinfo.t_recipientid bi, mesfrm.t_name fn                    "+
         "  FROM dwlinfo_dbt wlinfo,                                          "+
         "       dwlmeslnk_dbt meslnk,                                        "+
         "       dwlmes_dbt wlmes,                                            "+
         "       dwlmesrls_dbt mesrls,                                        "+
         "       dwlmesfrm_dbt mesfrm                                         "+
         " WHERE (   (    wlinfo.t_direct = 'X'                               "+
         "            AND wlinfo.t_originatorid = :RECIPIENTID                "+
         "            AND wlinfo.t_state = :WLD_STATUS_MES_RECEIV             "+
         "           )                                                        "+
         "        OR (    wlinfo.t_direct = CHR (0)                           "+
         "            AND wlinfo.t_recipientid = :RECIPIENTID2                 "+
         "            AND wlinfo.t_state = :WLD_STATUS_MES_DELIV              "+
         "           )                                                        "+
         "       )                                                            "+
         "   AND meslnk.t_objid = wlinfo.t_infoid                             "+
         "   AND meslnk.t_objkind = :WLD_STATUS_TYPE_INFO                     "+
         "   AND wlmes.t_mesid = meslnk.t_mesid                               "+
         "   AND mesrls.t_rlsformid = wlmes.t_rlsformid                       "+
         "   AND mesfrm.t_formid = mesrls.t_formid                            "+
         "   AND mesfrm.t_tpid = :WLD_TRNP_SMBR                               ";

  Query = StrSubst(Query, "      ", " ");                                                                                   
  
  params = makeArray( SQLParam( "RECIPIENTID",           RecipID ),
                      SQLParam( "WLD_STATUS_MES_RECEIV", WLD_STATUS_MES_RECEIV ),
                      SQLParam( "RECIPIENTID2",          RecipID ),
                      SQLParam( "WLD_STATUS_MES_DELIV",  WLD_STATUS_MES_DELIV ),
                      SQLParam( "WLD_STATUS_TYPE_INFO",  WLD_STATUS_TYPE_INFO ),
                      SQLParam( "WLD_TRNP_SMBR",         WLD_TRNP_SMBR ) ); 
  
  rs = execSQLselect( Query, params, false );
  
  n = 1; 
  num = 0; 
  while( rs.MoveNext() )
     SB_ЗаписатьПолеЛогВБлок( "F/DOC", "DOC", String(
       ВыровнятьВправо(String(n), 6, "0"),             " ",         /*Num*/
       rs.value("sd"),                                 "  ",        /*EDate*/
       rs.value("st"),                                 " ",         /*ETime*/
       SubStr( rs.value("nu"), 1, 6 ), " ", 
            SubStr( rs.value("nu"), 7, 10 ), " ",
                 SubStr( rs.value("nu"), 17 ),         " ",         /*TRN*/
       Cliring10(rs.value("bi")),                      " ",         /*ResipientID*/
       TypeDoc2(rs.value("fn"))                                     /*Type*/
     ),
     Parm );
     
     n = n + 1;

     num = num + 1;
  end;

  if(n == 1) УстановитьКонтекстБлокаЛог("..") end;

  SB_ЗаписатьПолеЛогВБлок( "F", "NUM", ВыровнятьВправо( String(num), 6),  Parm );
             
  УстановитьКонтекстБлокаЛог("");
  
  SetParm( 1, Parm );

  return TRUE; /* Успешное завершение */

  OnError(er) /* обработка ошибок */
    ExeptionMessage(er);
    return FALSE;
end;

/* Релиз 0B9 */
macro GenMes( addrMes, addrHead )
  var format = true;

  SetBuff( wlmes,  addrMes );
  SetBuff(wlhead, addrHead);

  PrintLog(2,"Генерация сообщения по SBRF3, релиз 0B9");    

  return GenMesExec( format );

  OnError(er) /* обработка ошибок */
    ExeptionMessage(er);
    return false;
end;
