/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 5.1                      */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/* Генерация сообщения по SWIFT MTn96                                       */
/*                                                                          */
/*  Имя файла: swgmn96.mac                                                  */
/*  Создан:  29.08.00                                        Бабин А.П.     */
/****************************************************************************/

import "swgenmes.mac";

macro GenMes( addrMes, addrReq )
  var field_value, Narrative, Descript;

  SetBuff( wlmes,  addrMes );
  SetBuff( wlReq, addrReq );

  PrintLog(2,"Генерация сообщения по МТn96");

  /* 20 - номер транзакции (документа) */
  ЗаписатьПолеЛог( TransactionReferenceNumberField, wlmes.TRN );

  /* 21 Related Reference */
  ЗаписатьПолеЛог( RelatedReferenceField, wlReq.RelatedRef );  

  StrChangeRusXSet( wlReq.Queries, field_value );
  StrMultyToFormat( field_value, field_value, 35, 6 );
  ЗаписатьПолеЛог( AnswersField, field_value );

  ПрочитатьТекстЗапроса_Ответа( wlReq, Narrative, Descript );

  StrChangeRusXSet( Narrative, field_value );
  StrMultyToFormat( field_value, field_value, 35, 20 );
  ЗаписатьПолеЛог( NarrativeField, field_value );  
  
  if ( wlReq.InitFormIDMes )
     f_wlmesfrm.FormID = wlReq.InitFormIDMes;
     if( GetEQ(f_wlmesfrm) )     
       field_value = substr( string(f_wlmesfrm.Name), 1, 3 ) + "\n" + GetSWIFTDate( wlReq.InitDateMes );
     ЗаписатьПолеЛогВБлок( "11a", MTandDateOriginalMessage_RField, field_value );
     if( not УстановитьКонтекстБлока( "" ) )
        RunError("|Ошибка при установке пустого контекста блока");
     end;
  end;
  end;

  StrChangeRusXSet( Descript, field_value );
  StrMultyToFormat( field_value, field_value, 50, 35 );
  ЗаписатьПолеЛог( NarrativeDescriptionField, field_value );  

  return TRUE; /* успешное завершение */

  OnError(er) /* обработка ошибок */
    ExeptionMessage(er);
    return false;
end;