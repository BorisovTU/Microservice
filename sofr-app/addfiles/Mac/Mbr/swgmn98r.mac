/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 5.1                      */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/* Генерация сообщения по SWIFT MTn98 стандарт RUR5                         */
/*                                                                          */
/*  Имя файла: swgmn98r.mac                                                 */
/*  Создан:  22.09.00                                         Бабин А.П.    */
/****************************************************************************/

import "swgenmes.mac";

record Party(party);

macro GenMes( addrMes, addrPm )
  var field_value;
  var RsPaym;
  SetBuff( wlmes,  addrMes );
  SetBuff( wlpmpaym, addrPm );

  PrintLog(2,"Генерация сообщения по МТn98 стандарт RUR5");
  RsPaym = RsbPayment( wlpmpaym.PaymentID );
  /* 20 - номер транзакции (документа) */
  ЗаписатьПолеЛог( TransactionReferenceNumberField, wlmes.TRN );

  /* 12 - Тип собственного сообщения */
  ЗаписатьПолеЛог( SubMessageType, "100" );

  /* 77E - Сообщение в собственном формате */
  /* Здесь следует записать необходимые поля платежа в поле 77E в согласованном
     с банком-корреспондентом формате                                           */
  /* Пока в это поле записаны только детали платежа */
  if ( RsPaym.Ground!="" )
     field_value = "     " + RsPaym.Ground;
     StrChangeRusXSet( field_value, field_value, ST_RUR5 );
     StrMultyToFormat( field_value, field_value, 78, int(floor(strlen(field_value)/78)+1) );
     field_value = substr( field_value, 6 );
     ЗаписатьПолеЛог( ProprietaryMessage, field_value );  
  end;

  return TRUE; /* Успешное завершение */

  OnError(er) /* обработка ошибок */
    ExeptionMessage(er);
    return FALSE;
end;