/*
$Name:             swtools.mac
$Module:           МБР
$Description:      Константы и вспомогательные функции для работы с сообщениями SWIFT
*/
import PaymInter, oralib, "bnk_common.mac";
/* Поддерживаемые виды терминалов */
const TPFRMT_TURBOSWIFT = "TURBO SWIFT",  /* Turbo SWIFT */
      TPFRMT_PCC        = "DOS-PCC",      /* The DOS message file is in ST200 PC Connect format */
      TPFRMT_RJE        = "RJE";          /* The RJE message file is a UNIX file in ST200 RJE format */

const BANK_TIME_ZONE = "+0300"; /* Временная зона банка. По умолчанию для Москвы */

const КодНачалаБлока              = "{",
      КодКонцаБлока               = "}",
      НомерБлокаBasicHeader       = "1",
      НомерБлокаApplicationHeader = "2",
      НомерБлокаUserHeader        = "3",
      НомерБлокаText              = "4",
      НомерБлокаTrailer           = "5",
      НомерБлокаTrailerIFT        = "S",
      КодРазделительНомера        = ":",
      КодНачалаПоля               = ":",
      КодПриложенияFIN            = "F",
      НомерПриложенияFIN          = "01",
      НомерПриложенияFINСервис    = "21",
      НомерТерминалаПоУмолчанию   = "X",
      НомерСессииПоУмолчанию      = "0000",
      ISNПоУмолчанию              = "000000",
      КодИсходящего               = "I",
      КодВходящего                = "O",
      КодПриоритетНормальный      = "N",
      КодПриоритетСрочный         = "U",
      СимволBICПоУмолчанию        = "X",
      КодОтделенияПоУмолчанию     = "XXX",
      НомерПоляMUR                = "108",
      НомерПоляStandart           = "113",
      НомерПоляSTP                = "119",
      ЗначениеSTP                 = "STP",
      НомерПоля177                = "177",
      НомерПоля451                = "451",
      НомерПоля405                = "405",
      FieldNumberUETETR           = "121",
      FieldNumberSTI              = "111",
      КодПоля451ACK               = "0",
      КодПоля451NAK               = "1",
      НазваниеФормы103Plus        = "103+",
      НазваниеФормы103Plus_CHAR   = "+",
      ЗначениеMURПоУмолчанию      = "RS-BANK",
      ЗначениеRUR6                = "RUR6",
      ЗначениеRUR5                = "RUR5",
      ЗначениеRUR4                = "RUR4",
      RUR6_CHAR                   = "+",
      RUR5_CHAR                   = "+",
      RUR4_CHAR                   = "'",
      КодКонцаТекстовогоБлока     = "-",
      КодРазделительСообщений     = "$",
      КодНачалаСообщения          = StrFor(1),
      КодКонцаСообщения           = StrFor(3),
      FormatCode                  = "0000",
      FieldNameMDG                = "MDG";

/* длины Bank Identifier Code (BIC) */
const Len_BIC_BankCode      = 4,
      Len_BIC_CountryCode   = 2,
      Len_BIC_LocationCode  = 2,
      Len_BIC_BranchCode    = 3,
      Len_BIC_LTCode        = 1,
      Len_BIC_Destination   = Len_BIC_BankCode+Len_BIC_CountryCode+Len_BIC_LocationCode,
      Len_BIC_LogicalTerminal = Len_BIC_Destination+Len_BIC_LTCode,
      Len_BIC_Address         = Len_BIC_LogicalTerminal+Len_BIC_BranchCode;

// длины полей
const SW_Len_RelatedReference = 16;

const СсылкаОтсутствует      = "NONREF";

/* Список полей транспорта SWIFT */
const GENL_Block                           = "GENL",
      LINK_Block                           = "LINK",
      TRADDET_Block                        = "TRADDET",
      FIAC_Block                           = "FIAC",
      FIA_Block                            = "FIA",
      REPO_Block                           = "REPO",
      SETDET_Block                         = "SETDET",
      SETPRTY_Block                        = "SETPRTY",
      CSHPRTY_Block                        = "CSHPRTY", /*!!!*/
      AMT_Block                            = "AMT",
      OTHRPRTY_Block                       = "OTHRPRTY",
      SETTRAN_Block                        = "SETTRAN",
      MTandDateOriginalMessage_SField      = "11S",
      MTandDateOriginalMessage_RField      = "11R",
      SubMessageType                       = "12",
      DateTimeIndicatorField               = "13",
      LinkedTransactionField               = "13A",
      TimeIndicationField                  = "13C",
      DateTimeIndicationField              = "13D",
      StartOfBlock                         = "16R",
      EndOfBlock                           = "16S",
      SumOfAmountField                     = "19",
      SumOfAmountAField                    = "19A",
      TransactionReferenceNumberField      = "20",
      IndicatorField                       = "22F",
      SendersReferenceField                = "20C",
      RelatedReferenceField                = "21",
      BankOperationCodeField               = "23",
      FunctionMessageField                 = "23G",
      BankOperationCodeField_B             = "23B",
      InstructionCodeField                 = "23E",
      AccountIdentificationField           = "25",
      TransactionTypeCodeField             = "26T",
      SequenceOfTotalField                 = "27",
      StatementSequnceNumberField          = "28",
      StatementSequnceNumberCField         = "28C",
      ValueDateField                       = "30",
      DateOfIssueField                     = "31C",
      DateAndPlaceOfExpiryField            = "31D",
      ValueDateCurrencyCodeAmountField_A   = "32A",
      ValueDateCurrencyCodeAmountField_B   = "32B",
      ValueDateCurrencyCodeAmountField_C   = "32C",
      ValueDateCurrencyCodeAmountField_D   = "32D",
      CurrencyOriginalOrderedAmountField   = "33B",
      FloorLimitIndicatorField             = "34F",
      IdentificationOfSecuritiesField      = "35B",
      ExchangeRateField                    = "36",
      QuantityOfFIField                    = "36B",
      PercentageCreditAmountToleranceField = "39A",
      MaximumCreditAmountField             = "39B",
      AdditionalAmountsCoveredField        = "39C",
      FormOfDocumentaryCreditField         = "40A",
      ApplicableRulesField_E               = "40E",
      ApplicableRulesField_F               = "40F",
      AvailableWithByField                 = "41",
      AvailableWithByField_A               = "41A",  
      AvailableWithByField_D               = "41D",
      DraftsAtField                        = "42C",
      DraweeField                          = "42",
      DraweeField_A                        = "42A",
      DraweeField_D                        = "42D",
      MixedPaymentDetailsField             = "42M",
      DeferredPaymentDetailsField          = "42P",
      PartialShipmentsField                = "43P",
      TransshipmentField                   = "43T",
      PlaceOfTakingInChargeField           = "44A",
      PlaceOfFinalDestinationField         = "44B",
      LatestDateOfShipmentField            = "44C",
      ShipmentPeriodField                  = "44D",
      PortOfDepartureField                 = "44E",
      PortOfDestinationField               = "44F",
      PeriodForPresentationField           = "48",
      ConfirmationInstructionsField        = "49",
      OrderingCustomerField                = "50",
      OrderingCustomerField_A              = "50A",  
      OrderingCustomerField_C              = "50C", 
      OrderingCustomerField_K              = "50K",
      OrderingCustomerField_F              = "50F",
      SendingInstitutionField              = "51", 
      SendingInstitutionField_A            = "51A", 
      SendingInstitutionField_D            = "51D",
      OrderingInstitutionField             = "52",
      OrderingInstitutionField_A           = "52A",
      OrderingInstitutionField_B           = "52B",
      OrderingInstitutionField_C           = "52C",
      OrderingInstitutionField_D           = "52D",
      Sender_sCorrespondentField           = "53",
      Sender_sCorrespondentField_A         = "53A",
      Sender_sCorrespondentField_B         = "53B",
      Sender_sCorrespondentField_C         = "53C",
      Sender_sCorrespondentField_D         = "53D",
      Receiver_sCorrespondentField         = "54",
      Receiver_sCorrespondentField_A       = "54A",
      Receiver_sCorrespondentField_B       = "54B",
      Receiver_sCorrespondentField_C       = "54C",
      Receiver_sCorrespondentField_D       = "54D",
      ThirdReimbursementInstitutionField   = "55",
      ThirdReimbursementInstitutionField_A = "55A",
      ThirdReimbursementInstitutionField_B = "55B",
      ThirdReimbursementInstitutionField_D = "55D",
      IntermediaryField                    = "56",
      IntermediaryField_A                  = "56A",
      IntermediaryField_C                  = "56C",
      IntermediaryField_D                  = "56D",
      AccountWithInstitutionField          = "57",
      AccountWithInstitutionField_A        = "57A",
      AccountWithInstitutionField_B        = "57B",
      AccountWithInstitutionField_C        = "57C",
      AccountWithInstitutionField_D        = "57D",
      BeneficiaryInstitutionField          = "58",
      BeneficiaryInstitutionField_A        = "58A",
      BeneficiaryInstitutionField_D        = "58D",
      BeneficiaryCustomerField             = "59",
      BeneficiaryCustomerField_A           = "59A",
      BeneficiaryCustomerField_F           = "59F",
      OpeningBalanceField_F                = "60F",
      OpeningBalanceField_M                = "60M",
      StatementLineField                   = "61",
      ClosingBalanceField_F                = "62F",
      ClosingBalanceField_M                = "62M",
      ClosingAvailableBalanceField         = "64",
      ForwardAvailableBalanceField         = "65",
      DetailsOfPaymentField                = "70",
      FIANarrativeEField                   = "70E",
      FIANarrativeCField                   = "70C",
      FIANarrativeDField                   = "70D",
      DetailsOfChargesField_A              = "71A",
      DetailsOfChargesField_B              = "71B",
      SendersChargesField                  = "71F",
      ReceiversChargesField                = "71G",
      SenderToReceiverInformationField     = "72",
      ChargesAddedField                    = "73",
      QueriesField                         = "75",
      AnswersField                         = "76",
      NarrativeField                       = "77A",
      RegulatoryReportingField             = "77B",
      ProprietaryMessage                   = "77E",
      EnvelopeContentsField                = "77T",
      InstructionsToPayingAcceptingNegotiationBankField = "78",
      NarrativeDescriptionField            = "79",
      InformationToAccountOwnerField       = "86",
      NumberSumCreditEntriesField          = "90C",
      NumberSumDebetEntriesField           = "90D",
      PlaceOfTradeField                    = "94B",
      PartyCField                          = "95C",
      PartySField                          = "95S",
      PartyPField                          = "95P",
      PartyRField                          = "95R",
      PartyQField                          = "95Q",
      AccountAField                        = "97A",
      AccountBField                        = "97B",
      AccountCField                        = "97C",
      PreperationDateField                 = "98A",
      PreperationDateTimeField             = "98C",
      NumberCountField                     = "99B",
/* Поля, не регламентированные SWIFT-ом, но необходимые */
/* для внутреннего использования */
      CopyMandatoryFields                  = "MFIELDS",
      CurrencyCodeField                    = "CUR";

/* Обрабатываемые коды поля 72 */
const Field72CodesACC                    = "ACC",
      Field72CodesINS                    = "INS",
      Field72CodesINT                    = "INT",
      Field72CodesRCB                    = "RCB",
      Field72CodesNZP                    = "NZP",
      Field72CodesRPP                    = "RPP",
      Field72CodesREC                    = "REC",
      Field72CodesBENONLY                = "BENONLY",
      Field72CodesCHEQUE                 = "CHEQUE",
      Field72CodesCORPTRAD               = "CORPTRAD",
      Field72CodesHOLD                   = "HOLD",
      Field72CodesINTRACOM               = "INTRACOM",
      Field72CodesPHONBEN                = "PHONBEN",
      Field72CodesPHONIBK                = "PHONIBK",
      Field72CodesTELE                   = "TELE",
      Field72CodesTELEBEN                = "TELEBEN",
      Field72CodesTELEIBK                = "TELEIBK",
      Field72CodesEARLY                  = "EARLY",
      Field72CodesUIP                    = "UIP",
      /* Коды характерные для RUR4 */
      Field72CodesELEC                   = "ELEC",
      Field72CodesPHON                   = "PHON",
      Field72CodesTELEX                  = "TELEX",
      /* Коды характерные для RUR6 */
      Field72CodesDAS                    = "DAS",
      Field72CodesBNF                    = "BNF",
      Field72CodesRPO                    = "RPO";

/* Кодовые слова поля 70 */
const Field70CodesINV                    = "INV",
      Field70CodesRFB                    = "RFB",
      Field70CodesROC                    = "ROC",
      Field70CodesIPI                    = "IPI";

const OptionJCodesABIC                   = "ABIC",
      OptionJCodesACCT                   = "ACCT",
      OptionJCodesNAME                   = "NAME",
      OptionJCodesUSFW                   = "USFW",
      OptionJCodesUSCH                   = "USCH";

const CodeUnknownBIC                     = "UKWN";

const StatLine_TypeOperField_SWIFTTag    = "S",
      StatLine_TypeOperField_FirstTag    = "F",
      StatLine_TypeOperField_NonSWIFTTag = "N";

const SWIFT_Tag_A = "A",
      SWIFT_Tag_B = "B",
      SWIFT_Tag_C = "C",
      SWIFT_Tag_D = "D",
      SWIFT_Tag_F = "F",
      SWIFT_Tag_K = "K",
      SWIFT_Tag_0 = "0"; // без опции

/* Константы сообщений SWIFT */
const CREDIT_ACCOUNT = "C",
      DEBET_ACCOUNT  = "D",
      CHARGES_BEN    = "BEN",
      CHARGES_OUR    = "OUR",
      CHARGES_SHA    = "SHA",

      FIELD_MANDATORY = "M",
      FIELD_OPTIONAL  = "O",

      NEGATIVE_SYMB   = "N";

const BNC_INFO_SEPARATOR = "\n"; /* разделитель добавочных строк в Информации Бенефициару 72:/BNF/ */

const CODEWORLD_FEDWIRE = "FW"; /* Кодовое слово кода Fedwire */

/* Реально нет такого ключеого слова, просто мы так отличаем систему межфилиальных расчетов Сбербанка */
const CODEWORLD_SMFRSBRF = "SMFR"; /* Кодовое слово для вида кода 14 */

const CODEWORLD_BIC = "RU"; /* Кодовое слово для вида кода БИК */
const CODEWORLD_CHIPS = "CH"; /* Кодовое слово для вида кода CHIPS */

 /* Типы операций SWIFT */
const BillOfExchange      = "BOE",   /* переводной вексель (тратта) */
      BrokerageFee        = "BRF",   /* комиссионное вознаграждение маклеру */
      ChargesExpenses     = "CHG",   /* расходы/прочие издержки */
      Cheques             = "CHK",   /* банковские чеки */
      CashLetter          = "CLR",   /* кассовое письмо/римесса - плат. док. в ин. валюте для погашения задолженности */
      Collections         = "COL",   /* инкассо */
      Commission          = "COM",   /* комиссия */
      DocumentaryCredit   = "DCR",   /* документальный кредит */
      Dividends           = "DIV",   /* свидетельство на получение дивиденда */
      EquivalentAmount    = "EQA",   /* эквивалентная сумма */
      Eurocheques         = "ECK",   /* еврочеки */
      ForeignExchange     = "FEX",   /* иностранная валюта/форексная сделка */
      Interest            = "INT",   /* доход/проценты на капитал */
      LockBox             = "LBX",   /* сейф/абонированный почтовый ящик */
      LoanDeposit         = "LDP",   /* заемный депозит */
      Miscellaneous       = "MSC",   /* разное/прочее */
      Purchase            = "PCH",   /* покупка */
      ReturnedItem        = "RTI",   /* возвращенная статья */
      Sale                = "SAL",   /* продажа */
      Securities          = "SEC",   /* ценные бумаги */
      StandingOrder       = "STO",   /* постоянная инструкция/наряд-заказ на производство изделия */
      TravellersCheques   = "TCK",   /* дорожный чек */
      Transfer            = "TRF",   /* перечисление/перевод */
      CoverMessage        = "COV",   /* сообщения с покрытием */
      ValueDateAdjustment = "VDA";   /* уведомление об изменении даты валютирования */

/* 23 - Bank Operation Code */
const BANKOPERCODE_CREDIT = "CREDIT", /* credit transfer without Service Level */
      BANKOPERCODE_CRTST = "CRTST";

/* 23B - Bank Operation Code */
const BANKOPERCODE_CRED = "CRED", /* credit transfer without Service Level */
      BANKOPERCODE_SPRI = "SPRI", /* Priority Service Level */
      BANKOPERCODE_SSTD = "SSTD", /* Standart Service Level */
      BANKOPERCODE_SPAY = "SPAY", /* SWIFTPay Service Level */
      BANKOPERCODE_CRTS = "CRTS"; /* credit transfer for test purposes. Non FIN */

/* 23E - Institution Code */
const INSTITUTIONCODE_SDVA = "SDVA",
      INSTITUTIONCODE_INTC = "INTC",
      INSTITUTIONCODE_REPA = "REPA",
      INSTITUTIONCODE_CORT = "CORT",
      INSTITUTIONCODE_BONL = "BONL",
      INSTITUTIONCODE_HOLD = "HOLD",
      INSTITUTIONCODE_CHQB = "CHQB",
      INSTITUTIONCODE_PHOB = "PHOB",
      INSTITUTIONCODE_TELB = "TELB",
      INSTITUTIONCODE_PHON = "PHON",
      INSTITUTIONCODE_TELE = "TELE",
      INSTITUTIONCODE_PHOI = "PHOI",
      INSTITUTIONCODE_TELI = "TELI";

const NOTEXT_VALUE = "NOTEXT";


const PARTYS_ROLE_BORROWER = "B",
      PARTYS_ROLE_LENDER   = "L";

const TYPE_EVENT_CONF      = "CONF",
      TYPE_EVENT_MATU      = "MATU",
      TYPE_EVENT_ROLL      = "ROLL";

const TYPE_OPERATION_AMND  = "AMND",
      TYPE_OPERATION_CANC  = "CANC",
      TYPE_OPERATION_DUPL  = "DUPL",
      TYPE_OPERATION_NEWT  = "NEWT";

const SWIFT_BASIS_ACT_365 = "ACT/365",
      SWIFT_BASIS_AFI_365 = "AFI/365",
      SWIFT_BASIS_ACT_360 = "ACT/360",
      SWIFT_BASIS_360_360 = "360/360",
      SWIFT_BASIS_30E_360 = "30E/360";

/*Совместимость нац.клиринговых кодов с опциями*/
const SWIFT_NCSC_TAG_A = "SC PT IT IN IE HK GR FW ES CC BL AU AT",
      SWIFT_NCSC_TAG_C = "AT AU BL CC CH CP ES FW GR HK IE IN IT NZ PT RU SC SW SW ZA",
      SWIFT_NCSC_TAG_D = "AT AU BL CC CH CP ES FW GR HK IE IN IT NZ PT RU SC SW SW ZA";
/* Получить дату в формате SWIFT YYMMDD */
macro GetSWIFTDate( usual_date )
  var dd, mm, yyyy, SWIFTdate;

  if(usual_date == Date(0, 0 ,0))
    return "000000";
  end;
  
  datesplit( usual_date, dd, mm, yyyy );
  SWIFTdate = string( substr( string( yyyy ), 3, 2 ), mm:2, dd:2 );
  /* Заменяем пробелы нулями */
  return StrSubst( SWIFTdate, " ", "0" );
end;

/* Получить дату в формате SWIFT YYYYMMDD */
macro GetSWIFTDateFull( usual_date )
  var dd, mm, yyyy, SWIFTdate;

  datesplit( usual_date, dd, mm, yyyy );
  SWIFTdate = string( yyyy:4, mm:2, dd:2 );
  /* Заменяем пробелы нулями */
  return StrSubst( SWIFTdate, " ", "0" );
end;

/* Получить сумму в формате SWIFT */
macro GetSWIFTAmount( sum )
  var SWIFTAmount, pos;

  SWIFTAmount = string( sum );

  pos = index( SWIFTAmount, "." );
  strset( SWIFTAmount, pos, ",");
  /* лишние нули в конце - обрезаем */
  if( int( substr( SWIFTAmount, pos+1 ) ) == 0 )
    SWIFTAmount = substr( SWIFTAmount, 1, pos );
  end;

  return SWIFTAmount;
end;

/* Получить курс в формате SWIFT */
macro GetSWIFTRate( Rate )
/*
  var SWIFTRate = String(Rate);
  var RateD = Double(Rate);
  var SWIFTRate, RateD;
  ВР. Тип Numeric некорректно преобразуется в String - обрезается дробная часть
*/
  var SWIFTRate, RateD;
  SetDefPrec(12);
  RateD = Double(Rate);
  SWIFTRate = String(RateD);

  if( index( SWIFTRate, "." ) )
/*
    SWIFTRate = GetSWIFTAmount( Rate );
  ВР.
*/
    SWIFTRate = GetSWIFTAmount( RateD );
  end;
  
  /* Обрезаем все нули справа */
  while( SubStr( SWIFTRate, StrLen(SWIFTRate), 1 ) == "0" )    
    SWIFTRate = substr( SWIFTRate, 1, StrLen(SWIFTRate)-1 );
  end;
  
  return SWIFTRate;
end;

/* Получить время в формате SWIFT */
macro GetSWIFTTime( time )
 var Час, Минута;

 TimeSplit( time, Час, Минута );

 return StrSubst(string(Час:2, Минута:2), " ", "0");
end;

macro GetSWIFTTimeFull( time )
 var Час, Минута, Секунда;

 TimeSplit( time, Час, Минута, Секунда );

 return StrSubst(string(Час:2, Минута:2, Секунда:2), " ", "0");
end;

const digits = "1234567890,";

macro СчитатьСтрокуЦифр( str )
   var digitStr="";
   var character;
   var continue0;
   var length;
   var pos;

   length = StrLen( str );
   if( length == 0 )   return digitStr; end;

   pos = StrBrk( str, digits );
   if( pos != 1  ) return digitStr; end;

   continue0 = 1;
   while( continue0 )
      character = SubStr( str, pos, 1 );
      if( Index( digits, character ) )
         digitStr = String( digitStr, character );
         pos = pos + 1;
         if( pos > length ) continue0 = 0; end;
      else   continue0 = 0;
      end;
   end;

   return digitStr;
end;

/* Получить код получателя комиссии (OUR, BEN, SHA) по номеру */
macro GetCommisCode (CommisCharges)
  if( CommisCharges == PM_CHRG_OUR )
    return CHARGES_OUR;
  end; 
  if( CommisCharges == PM_CHRG_SHA )
    return CHARGES_SHA;
  end; 
  if( CommisCharges == PM_CHRG_BEN )
    return CHARGES_BEN;
  end; 
end;

macro GetCommisNum (CommisChargesCode)
  if( CommisChargesCode == CHARGES_OUR )
    return PM_CHRG_OUR;
  end; 
  if( CommisChargesCode == CHARGES_SHA )
    return PM_CHRG_SHA;
  end; 
  if( CommisChargesCode == CHARGES_BEN )
    return PM_CHRG_BEN;
  end;
  return 0;
end;

macro GetSessTimeZone()
  var rs;
  var time = "";

  var query = "select SESSIONTIMEZONE from dual";
  
  rs = execSQLselect(query);

  if(rs.movenext())
    time = StrSubst(rs.value(0), ":", "");  
  end;

  return time;          
end;

macro FillDebetCreditFIID(wlpmpaym, wlpmpropdeb, wlpmpropcred)  
  record party("party.dbt");
  var FIID;
  var ClientID;
  if(wlpmpaym.PayerAccount != "" )  
    ClientID = ПолучитьКодСубъекта(wlpmpropdeb.BankCode, wlpmpropdeb.CodeKind, null, 0, 1);
    if(ClientID)
      ПолучитьСубъекта(ClientID, party);
    end;

    if(party.NotResident != "X")
      FIID = GetFIIDByCodeInAccount(substr(wlpmpaym.PayerAccount,6,3));
      if(FIID and (FIID != wlpmpaym.FIID))
        wlpmpaym.FIID = FIID;
        wlpmpaym.Amount = 0;
      end;
    end;
  end;

  if(wlpmpaym.ReceiverAccount != "" )  
      
    ClientID = ПолучитьКодСубъекта(wlpmpropcred.BankCode, wlpmpropcred.CodeKind, null, 0, 1);
    if(ClientID)
      ПолучитьСубъекта(ClientID, party);
    end;

    if(party.NotResident != "X")
      FIID = GetFIIDByCodeInAccount(substr(wlpmpaym.ReceiverAccount,6,3));
      if(FIID and (FIID != wlpmpaym.PayFIID))
        wlpmpaym.PayFIID = FIID;
        wlpmpaym.PayAmount = 0;
      end;
    end;
  end;
end;