/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank v6                       */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/* Генерация сообщения по SWIFT-SB MT202S                                   */
/*                                                                          */
/*  Имя файла: swsm202s.mac                                                 */
/*  Создан:  18.03.04                                        Панов А.Б.     */
/****************************************************************************/
import "swsbgmes.mac";
const  Relise = "202S";
macro GenMes( addrMes, addrPm,  addrOldMes )
  var field_value, Tag, PaymentDetails;
  var Recreate = false;
  var RsPaym;
  RECORD rcv(pmroute);
  RECORD ocb(pmroute);
  RECORD irb(pmroute);
  Record oldwlMes (wlmes);

  SetBuff( wlmes,  addrMes );
  SetBuff( wlpmpaym, addrPm );
  if( ValType(AddrOldMes) == V_MEMADDR )
     SetBuff( oldwlmes,  addrOldMes );
     Recreate = true;
  end;

  PrintLog(2,"Генерация сообщения по МТ202S");

  RsPaym = RsbPayment( wlpmpaym.PaymentID );
  SB_CheckFIID( wlpmpaym.BaseFIID );

  /* SN - уникальный системный номер сообщения в СМФР */
  ЗаписатьПолеЛог(УникальныйНомерСообщенияСМФР, wlmes.TRN);

  /* RN - уникальный системный номер исходного сообщения в СМФР */
  if (wlmes.RelatedRef != "")
    ЗаписатьПолеЛог(НомерСвязанногоСообщенияСМФР, wlmes.RelatedRef);
  end;

  /* 20 - номер транзакции (документа) */
  ЗаписатьПолеЛог(TransactionReferenceNumberField, wlmes.TRN);

  /* 21 - Ссылка на документ или сделку */
  if (wlmes.RelatedRef != "")
    WriteFieldEx  (RelatedReferenceField, field_value, Recreate, OldwlMes );
/*    ЗаписатьПолеЛог(RelatedReferenceField, wlmes.RelatedRef); */
  else
      WriteFieldEx  (RelatedReferenceField, СсылкаОтсутствует, Recreate, OldwlMes );
/*    ЗаписатьПолеЛог(RelatedReferenceField, СсылкаОтсутствует);*/
  end;

  /* 32A - дата валютирования, код валюты, сумма */
  // Транзитный документ (сам транзитный или порожден транзитным)
    field_value = ДатаПоУмолчанию +
                  FillCurrencyOriginalOrderedAmountField( RsPaym );
  WriteFieldEx  (ValueDateCurrencyCodeAmountField_A, field_value, Recreate, OldwlMes );
/*  ЗаписатьПолеЛог( ValueDateCurrencyCodeAmountField_A, field_value );*/

  /* 72 - информация для банка-получателя */
  PaymentDetails = "";
  StrChangeRusXSet(RsPaym.Ground, PaymentDetails, ST_NONTR);
  field_value = FillInformationOfPaymentField_SB(RsPaym, ALLOWCODES_MT202_STANDART, PaymentDetails, ST_NONTR);      
  WriteFieldEx  (SenderToReceiverInformationField, field_value, Recreate, OldwlMes );
/*  ЗаписатьПолеЛог( SenderToReceiverInformationField, field_value );*/

     /* 52a - банк приказодателя */
  field_value = FillOrderingInstitutionFieldA_SB(RsPaym, Tag, ST_NONTR);
     if (field_value == "")
    field_value = FillOrderingInstitutionFieldD_SB(RsPaym, Tag, ST_NONTR);
       if (field_value == "")
         std.out(2, "PaymentID: " + RsPaym.PaymentID);
         RunError("|Не найден банк приказодателя");
       end;
     end;
     ЗаписатьПолеВБлокКонтекст0(OrderingInstitutionField+Tag, "52a", field_value, Recreate, OldwlMes);

  if( IsPmCoverMode() == FALSE )

     /* 53a - корреспондент отправителя */
     Tag = SWIFT_Tag_A;
     field_value = FillSenderCorrespondentField_SB(RsPaym, Tag, ST_NONTR );     
     ЗаписатьПолеВБлокКонтекст0( Sender_sCorrespondentField+Tag, "53a", field_value, Recreate, OldwlMes );     

     /* 57a - банк бенефициара */
     Tag = "";
     field_value = FillIntermediaryField_SB(RsPaym, Tag, ST_NONTR );
     if (field_value != "")
     ЗаписатьПолеВБлокКонтекст0( AccountWithInstitutionField+Tag, "57a", field_value, Recreate, OldwlMes );
     end;

     /* 58a - банк-бенефициар */
     Tag = "";
     field_value = FillBeneficiaryInstitutionField_SB(RsPaym, Tag, ST_NONTR );
     ЗаписатьПолеВБлокКонтекст0( BeneficiaryInstitutionField+Tag, "58a", field_value, Recreate, OldwlMes );
  else /* покрытие */
     /* корреспондент получателя -> банк бенефициара */
     if( ПолучитьУзелПолучателяПлатежа(RsPaym.PaymentID, rcv) AND 
         ПолучитьБлижайшийУзелПлатежа(RsPaym.PaymentID, RTDIR_OUT, ocb) AND
         (rcv.RouteID!=ocb.RouteID) AND
         ПерейтиНаБолееДальнийУзел(RTDIR_OUT, Route) AND
         (rcv.RouteID!=Route.RouteID) )
        ЗаписатьПолеМаршрутаКонтекст0Лог_SB( AccountWithInstitutionField, "57a", Route, NULL, NULL, ST_NONTR, Recreate, OldwlMes );
     end;

     /* банк получатель -> банк-бенефициар */
     Tag = "";
     field_value = FillBeneficiaryInstitutionField_SB(RsPaym, Tag, ST_NONTR );
     ЗаписатьПолеВБлокКонтекст0( BeneficiaryInstitutionField+Tag, "58a", field_value, Recreate, OldwlMes );
  end;

  return TRUE; /* Успешное завершение */

  OnError(er) /* обработка ошибок */
    ExeptionMessage(er);
    return FALSE;
end;

