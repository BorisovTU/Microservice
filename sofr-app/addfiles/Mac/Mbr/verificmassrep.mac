/*
$Name: verificmassrep.mac
$Module: Œ
$Description: ®âç¥â ¬ áá®¢®© ®â¯à ¢ª¨ & ¢¥à¨ä¨ª æ¨¨ á®®¡é¥­¨©
*/

import oralib, likepy, PaymInter, WldInter, CTInter, globals, "bnk_dirfile.mac", "bnk_dttmfrmt.mac",
       "bnk_common.mac";

const Sending : integer = 0;
const VerificationManual : integer = 1;
const VerificationPayments : integer = 2;
const VerificationAuto : integer = 3;

private class Pair(_ID, _Department)
  var SessionID:integer = _ID;
  var Department:integer = _Department;
end;

private macro PrintSucceedSessions(sFlg:bool)

      var query =  
"  SELECT /*+ LEADING(verreport wlsess wlmes wlmeslnk wlpm pmpaym) USE_NL(verreport wlsess wlmes wlmeslnk wlpm pmpaym)*/  " +
"        COUNT (wlmes.t_mesID) MesCount,                                                                                  " +
"         wlsess.t_MessageType MessageType,                                                                               " +
"         wlsess.t_Number \"Number\",                                                                                     " +
"         SUBSTR (wlsess.t_filename,                                                                                      " +
"                   INSTR (wlsess.t_filename,                                                                             " +
"                          '\\',                                                                                          " +
"                          -1,                                                                                            " +
"                          1)                                                                                             " +
"                 + 1)                                                                                                    " +
"            FileName,                                                                                                    " +
"         NVL (SUM (pmpaym.t_BaseAmount), 0) \"Sum\",                                                                     " +
"         verreport.t_Department Department,                                                                              " +
"         NVL (                                                                                                           " +
"            LEAD (verreport.t_Department)                                                                                " +
"               OVER (ORDER BY verreport.t_Department),                                                                   " +
"            -1)                                                                                                          " +
"            NextDepartment,                                                                                              " +
"         NVL (                                                                                                           " +
"            LAG (verreport.t_Department) OVER (ORDER BY verreport.t_Department),                                         " +
"            -1)                                                                                                          " +
"            PreviousDepartment,                                                                                          " +
"         COUNT (verreport.t_SessionID)                                                                                   " +
"            OVER (PARTITION BY verreport.t_Department)                                                                   " +
"            SessDepartment,                                                                                              " +
"         NVL (                                                                                                           " +
"            SUM (SUM (pmpaym.t_BaseAmount))                                                                              " +
"               OVER (PARTITION BY verreport.t_Department),                                                               " +
"            0)                                                                                                           " +
"            SumDepartment,                                                                                               " +
"         SUM (COUNT (wlmes.t_MesID)) OVER (PARTITION BY verreport.t_Department)                                          " +
"            MesCountDepartment,                                                                                          " +
"         SUM (COUNT (pmpaym.t_PaymentID))                                                                                " +
"            OVER (PARTITION BY verreport.t_Department)                                                                   " +
"            PaymCountDepartment,                                                                                         " +
"         COUNT (verreport.t_SessionID) OVER () TotalSess,                                                                " +
"         NVL (SUM (SUM (pmpaym.t_BaseAmount)) OVER (), 0) TotalSum,                                                      " +
"         SUM (COUNT (pmpaym.t_PaymentID)) OVER () TotalPaym,                                                             " +
"         SUM (COUNT (wlmes.t_MesID)) OVER () TotalMes                                                                    " +
"    FROM (SELECT t.*,                                                                                                    " +
"                 PM_SCRHLP.GetStartDprtOrDprtForWldSess (t.t_SessionID)                                                  " +
"                    AS t_Department                                                                                      " +
"            FROM TABLE (WLD_EXPREP.GetVerificationReport ()) t) verreport                                                " +
"         INNER JOIN dwlsess_dbt wlsess                                                                                   " +
"            ON wlsess.t_SessionID = verreport.t_SessionID                                                                " +
"         LEFT OUTER JOIN dwlmes_dbt wlmes                                                                                " +
"            ON wlmes.t_SessionID = wlsess.t_SessionID                                                                    " +
"         LEFT OUTER JOIN dwlmeslnk_dbt wlmeslnk                                                                          " +
"            ON wlmeslnk.t_MesID = wlmes.t_MesID AND wlmeslnk.t_ObjKind = 501                                             " +
"         LEFT OUTER JOIN                                                                                                 " +
"         dwlpm_dbt wlpm                                                                                                  " +
"            ON     wlpm.t_WlpmID = wlmeslnk.t_ObjID                                                                      " +
"               AND wlpm.t_Direct = CHR (0)                                                                               " +
"               AND wlpm.t_WlpmNum = 0                                                                                    " +
"         LEFT OUTER JOIN dpmpaym_dbt pmpaym                                                                              " +
"            ON pmpaym.t_PaymentID = wlpm.t_PaymentID                                                                     " +
"   WHERE wlsess.t_State = :state AND verreport.t_Stat = 0                                                                " +
"GROUP BY verreport.t_SessionID,                                                                                          " +
"         wlsess.t_MessageType,                                                                                           " +
"         wlsess.t_Number,                                                                                                " +
"         wlsess.t_FileName,                                                                                              " +
"         verreport.t_Department                                                                                          " +
"ORDER BY verreport.t_Department;                                                                                         " ;

    var rs:RsdRecordset = execSQLselect(query, makeArray(SQLParam("state", IfThenElse(sFlg, 50, 35))), true);
    
    if(rs and rs.moveNext())
    [ ‘¥ ­áë, ãá¯¥è­® ®¡à ¡®â ­­ë¥ ¯à®æ¥¤ãà®©
       ÚÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
       ³ ”¨«¨ « ³ Š®«-¢® ³    ’¨¯    ³     ‘ã¬¬      ³®¬¥à ³                      ˆ¬ï ä ©«                        ³
       ³        ³ á®®¡é. ³ á®®¡é¥­¨ï ³               ³á¥ ­á ³                                                      ³
       ³        ³¢ ä ©«¥ ³           ³               ³      ³                                                      ³];    
    
    var next = true;
    
    while(next)     
     
     while(next)
     
     if((rs.value("PreviousDepartment") != -1) and (rs.value("PreviousDepartment") != rs.value("Department")))
      [  ÃÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
     else
      [  ÃÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ³];
     end;     
     
    [  ³########³########³###########³###############³######³######################################################³]
     (
      int(rs.value("Department")),
      int(rs.value("MesCount")),
      rs.value("MessageType"),
      IfThenElse( rs.value("Sum") == 0, "", rs.value("Sum")):0:2,
      rs.value("Number") : r,
      rs.value("FileName") : r
     );
       if(rs.value("NextDepartment") == rs.value("Department"))
        next = rs.MoveNext();     
       else
        break;
       end;
     end;
     
     if(rs.value("NextDepartment") != rs.value("Department"))
    [  ÃÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
       ³ˆâ®£® ¯®³á¥ ­á®¢: ########                                                                                 ³
       ³ä¨«¨ «ã ³¤®ªã¬¥­â®¢: #########                                                                             ³
       ³        ³¨§ ­¨å ¯« â¥¦¥©: ######## ­  áã¬¬ã: ############                                                  ³]
     (
      int(rs.value("SessDepartment")),
      int(rs.value("MesCountDepartment")),
      int(rs.value("PaymCountDepartment")),
      rs.value("SumDepartment"):0:2
     );
     
     if(rs.value("NextDepartment") == -1)
    [  ÃÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
       ³ˆâ®£® ¯®³á¥ ­á®¢: ########                                                                                 ³
       ³¡ ­ªã   ³¤®ªã¬¥­â®¢: ########                                                                              ³
       ³        ³¨§ ­¨å ¯« â¥¦¥©: ######## ­  áã¬¬ã: ############                                                  ³
       ÀÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ]
    (
      int(rs.value("TotalSess")),
      int(rs.value("TotalMes")),
      int(rs.value("TotalPaym")),
      rs.value("TotalSum"):0:2
    );
      next = false;
    else
      next = rs.MoveNext();   
    end;

  end;  
  end;
  
  end;
  
end;

private macro PrintUnSucceedSessions(sFlg:bool, sessions:TArray)
  
  var query =  
"  SELECT /*+ LEADING(verreport wlsess wlmes wlmeslnk wlpm pmpaym) USE_NL(verreport wlsess wlmes wlmeslnk wlpm pmpaym)*/    " +
"         COUNT (wlmes.t_mesID) MesCount,                                                                                   " +
"         wlsess.t_MessageType MessageType,                                                                                 " + 
"         wlsess.t_Number \"Number\",                                                                                       " +
"         SUBSTR (wlsess.t_filename,                                                                                        " +
"                   INSTR (wlsess.t_filename,                                                                               " +
"                          '\\',                                                                                            " +
"                          -1,                                                                                              " +
"                          1)                                                                                               " +
"                 + 1)                                                                                                      " +
"            FileName,                                                                                                      " +
"         NVL (SUM (pmpaym.t_BaseAmount), 0) \"Sum\",                                                                       " +
"         verreport.t_Department Department,                                                                                " +
"         NVL (                                                                                                             " +
"            LEAD (verreport.t_Department)                                                                                  " +
"               OVER (ORDER BY verreport.t_Department),                                                                     " +
"            -1)                                                                                                            " +
"            NextDepartment,                                                                                                " +
"         NVL (                                                                                                             " +
"            LAG (verreport.t_Department) OVER (ORDER BY verreport.t_Department),                                           " +
"            -1)                                                                                                            " +
"            PreviousDepartment,                                                                                            " +
"         COUNT (verreport.t_SessionID)                                                                                     " +
"            OVER (PARTITION BY verreport.t_Department)                                                                     " +
"            SessDepartment,                                                                                                " +
"         NVL (                                                                                                             " +
"            SUM (SUM (pmpaym.t_BaseAmount))                                                                                " +
"               OVER (PARTITION BY verreport.t_Department),                                                                 " +
"            0)                                                                                                             " +
"            SumDepartment,                                                                                                 " +
"         SUM (COUNT (wlmes.t_MesID)) OVER (PARTITION BY verreport.t_Department)                                            " +
"            MesCountDepartment,                                                                                            " +
"         SUM (COUNT (pmpaym.t_PaymentID))                                                                                  " +
"            OVER (PARTITION BY verreport.t_Department)                                                                     " +
"            PaymCountDepartment,                                                                                           " +
"         COUNT (verreport.t_SessionID) OVER () TotalSess,                                                                  " +
"         NVL (SUM (SUM (pmpaym.t_BaseAmount)) OVER (), 0) TotalSum,                                                        " +
"         SUM (COUNT (pmpaym.t_PaymentID)) OVER () TotalPaym,                                                               " +
"         SUM (COUNT (wlmes.t_MesID)) OVER () TotalMes,                                                                     " +
"         CASE                                                                                                              " +
"            WHEN    verreport.t_ErrorMessage IS NULL                                                                       " +
"                 OR verreport.t_ErrorMessage IN (CHR (1), CHR (0))                                                         " +
"            THEN                                                                                                           " +
"               PM_COMMON.GetNoteTextStr (verreport.t_SessionID, /*OBJTYPE_WLD_SESS*/                                       " +
"                                         513,                                                                              " +
"                                         4        /*NOTEKIND_SESS_ERRMESSAGE*/                                             " +
"                                          ,                                                                                " +
"                                         :date1)                                                                           " +
"            ELSE                                                                                                           " +
"               verreport.t_ErrorMessage                                                                                    " +
"         END                                                                                                               " +
"            ErrorMessage,                                                                                                  " +
"         verreport.t_FileObject FileObject,                                                                                " +
"         verreport.t_SessionID SessionID                                                                                   " +
"    FROM (SELECT t.*,                                                                                                      " +
"                 PM_SCRHLP.GetStartDprtOrDprtForWldSess (t.t_SessionID)                                                    " +
"                    AS t_Department                                                                                        " +
"            FROM TABLE (WLD_EXPREP.GetVerificationReport ()) t) verreport                                                  " +
"         INNER JOIN dwlsess_dbt wlsess                                                                                     " +
"            ON wlsess.t_SessionID = verreport.t_SessionID                                                                  " +
"         LEFT OUTER JOIN dwlmes_dbt wlmes                                                                                  " +
"            ON wlmes.t_SessionID = wlsess.t_SessionID                                                                      " +
"         LEFT OUTER JOIN dwlmeslnk_dbt wlmeslnk                                                                            " +
"            ON wlmeslnk.t_MesID = wlmes.t_MesID AND wlmeslnk.t_ObjKind = 501                                               " +
"         LEFT OUTER JOIN                                                                                                   " +
"         dwlpm_dbt wlpm                                                                                                    " +
"            ON     wlpm.t_WlpmID = wlmeslnk.t_ObjID                                                                        " +
"               AND wlpm.t_Direct = CHR (0)                                                                                 " +
"               AND wlpm.t_WlpmNum = 0                                                                                      " +
"         LEFT OUTER JOIN dpmpaym_dbt pmpaym                                                                                " +
"            ON pmpaym.t_PaymentID = wlpm.t_PaymentID                                                                       " +
"   WHERE wlsess.t_state <> :state OR verreport.t_Stat <> 0                                                                 " +
"GROUP BY verreport.t_SessionID,                                                                                            " +
"         wlsess.t_MessageType,                                                                                             " +
"         wlsess.t_Number,                                                                                                  " +
"         wlsess.t_FileName,                                                                                                " +
"         verreport.t_FileObject,                                                                                           " +
"         verreport.t_Department,                                                                                           " +
"         verreport.t_ErrorMessage                                                                                          " +
"ORDER BY verreport.t_Department                                                                                            " ;
                                                                                                                            

    var rs:RsdRecordset = execSQLselect(query, makeArray(SQLParam("date1", {curdate}), 
                                                         SQLParam("state", IfThenElse(sFlg, 50, 35))), true);
    
    if(rs and rs.moveNext())
    [ ‘¥ ­áë, ®¡à ¡®âª  ª®â®àëå § ¢¥àè¨« áì á ®è¨¡ª®©

       ÚÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
       ³ ”¨«¨ « ³ Š®«-¢® ³ Š®«-¢® ³   ’¨¯    ³   ‘ã¬¬        ³®¬¥à ³             à¨ç¨­  ®â¡à ª®¢ª¨               ³
       ³        ³ á®®¡é. ³ á®®¡é. ³  á®®¡é.  ³               ³á¥ ­á ³                                              ³
       ³        ³¢ á¥ ­á¥³¢ ä ©«¥ ³          ³               ³      ³                                              ³];   
    
    var next = true;    
    
    while(next)     
     
     while(next)
     
     if((rs.value("PreviousDepartment") != -1) and (rs.value("PreviousDepartment") != rs.value("Department")))
      [  ÃÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
     else
      [  ÃÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
     end;     
     
      [  ³########³########³########³##########³###############³######³##############################################³]
     (
      int(rs.value("Department")),
      int(rs.value("MesCount")),
      int(rs.value("FileObject")),
      rs.value("MessageType"),
      IfThenElse( rs.value("Sum") == 0, "", rs.value("Sum")):0:2,
      rs.value("Number") : r,
      rs.value("ErrorMessage") : w
     );
     
     sessions[sessions.Size] = Pair(rs.value("SessionID"), rs.value("Department"));
     
       if(rs.value("NextDepartment") == rs.value("Department"))
        next = rs.MoveNext();        
       else
        break;
       end;
     end;
     
     if(rs.value("NextDepartment") != rs.value("Department"))
    [  ÃÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
       ³ˆâ®£® ¯®³á¥ ­á®¢: ########                                                                                 ³
       ³ä¨«¨ «ã ³¤®ªã¬¥­â®¢: #########                                                                             ³
       ³        ³¨§ ­¨å ¯« â¥¦¥©: ######## ­  áã¬¬ã: ############                                                  ³]
     (
      int(rs.value("SessDepartment")),
      int(rs.value("MesCountDepartment")),
      int(rs.value("PaymCountDepartment")),
      rs.value("SumDepartment"):0:2
     );
     
     if(rs.value("NextDepartment") == -1)
    [  ÃÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
       ³ˆâ®£® ¯®³á¥ ­á®¢: ########                                                                                 ³
       ³¡ ­ªã   ³¤®ªã¬¥­â®¢: ########                                                                              ³
       ³        ³¨§ ­¨å ¯« â¥¦¥©: ######## ­  áã¬¬ã: ############                                                  ³
       ÀÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ]
    (
      int(rs.value("TotalSess")),
      int(rs.value("TotalMes")),
      int(rs.value("TotalPaym")),
      rs.value("TotalSum"):0:2
    );
      next = false;
    else
      next = rs.MoveNext();   
    end;

  end;
  
  end;
  
  end;
end;

private macro PrintPaymentDifference(sessions:TArray)
    
    var session;
    var Department : integer = -1;
    var SessionID : integer = -1;
    for(session, sessions)  

      var query =       
                    " SELECT verinfo.t_EDNo                                          EDNo,          " +
                    "        verinfo.t_EDDate                                        EDDate,        " +
                    "        verinfo.t_EDAuthor                                      EDAuthor,      " +
                    "        verinfo.t_MesAttrName                                   MesAttrName,   " +
                    "        NVL(verinfo.t_MesAttrValue, CHR(1))                     MesAttrValue,  " +
                    "        verinfo.t_PayAttrName                                   PayAttrName,   " +
                    "        NVL(verinfo.t_PayAttrValue, CHR(1))                     PayAttrValue,  " +
                    "        pmrmprop.t_Number                                       \"Number\",    " +
                    "        pmrmprop.t_Date                                         \"Date\",      " +
                    "        pmpaym.t_BaseAmount                                     BaseAmount,    " +
                    "        NVL(verinfo.t_PaymentID, 0)                             PaymentID,     " +
                    "        LAG(NVL(verinfo.t_PaymentID, 0)) OVER(ORDER BY verinfo.t_PaymentID ) PreviousPaymentID, " +   
                    "        LEAD(NVL(verinfo.t_PaymentID, 0)) OVER(ORDER BY verinfo.t_PaymentID ) NextPaymentID,    " +   
                    "        wlsess.t_Number                                         SessionNumber,  " +
                    "        TRUNC(wlsess.t_SysDate)                                 SessionDate,    " +
                    "        wlsess.t_SysTime                                        SessionTime     " +
                    " FROM TABLE (WLD_EXPREP.GetVerificationInformation (:SessionID1)) verinfo       " +              
                    "      LEFT OUTER JOIN dpmpaym_dbt pmpaym                                       " +
                    "        ON pmpaym.t_PaymentID = verinfo.t_PaymentID                            " +
                    "      LEFT OUTER JOIN dpmrmprop_dbt pmrmprop                                   " +
                    "        ON pmpaym.t_PaymentID = pmrmprop.t_PaymentID                           " +
                    "      LEFT OUTER JOIN dwlsess_dbt wlsess                                       " +
                    "        ON wlsess.t_SessionID = :SessionID2                                    " +
                    " WHERE NVL(verinfo.t_PaymentID, 0) <> 0                                        " +
                    "       AND verinfo.t_MesAttrName IS NOT NULL                                   " +                    
                    "       AND verinfo.t_PayAttrName IS NOT NULL                                   ";
                   
                    
          var rs:RsdRecordset = execSQLselect(query, makeArray(SQLParam("SessionID1", session.SessionID), SQLParam("SessionID2", session.SessionID)));
          
          while( rs and rs.MoveNext())
          
            if(Department != session.Department)      
              [  €‘•†„…ˆŸ ‚ …Š‚ˆ‡ˆ’€• ‹€’…†…‰ ˆ ‘™…ˆ‰  ‘…€‘€Œ ”ˆ‹ˆ€‹€ ###### ]
              (
                session.Department
              );
              
              Department = session.Department;
            end;
            
            if(SessionID != session.SessionID)      
            [    
                ‘¥ ­á ###### ¤ â  á¥ ­á  ########## ¢à¥¬ï á¥ ­á  ########]
              (
                rs.value("SessionNumber"),
                string(rs.value("SessionDate")),
                string(rs.value("SessionTime"))
              );
              
              SessionID = session.SessionID;
            end;
            
            
            
            if(rs.value("PaymentID") != rs.value("PreviousPaymentID") )
              [   ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
                  ³‘®®¡é¥­¨¥ EDNo ######## EDDate ########## EDAuthor ########## ³ « â¥¦ ü ######## ’ ########## ­  áã¬¬ã #############  ³
                  ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
                  ³          ¥ª¢¨§¨â          ³            ‡­ ç¥­¨¥             ³          ¥ª¢¨§¨â         ³           ‡­ ç¥­¨¥          ³
                  ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´]
                (
                  rs.value("EDNo"),
                  rs.value("EDDate"),
                  rs.value("EDAuthor"),
                  rs.value("Number"),
                  string(rs.value("Date")),
                  rs.value("BaseAmount")
                );
            end;
            
             [   ³############################³#################################³###########################³#############################³]
             (
             rs.value("MesAttrName"),
             rs.value("MesAttrValue"),
             rs.value("PayAttrName"),
             rs.value("PayAttrValue")
             );
             
             if(rs.value("PaymentID") != rs.value("NextPaymentID") )
              [   ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
             else
              [   ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
             end;
            
          end;
      end;
end;


MACRO PrintMassReport(VerificationType:integer)
  

    var procedureType : string;
    var sFlg : bool = false;

    var vType = 0;

    if(VerificationType == Sending )
      vType = Bnk_GetRegistryValue("Œ…†€Š‚‘Šˆ… €‘—…’›\\“”‘\\‡€™ˆ’€ ‘\\’€‚Š€_‚…ˆ”ˆŠ€–ˆŸ", V_INTEGER, 0);

      if(vType == 0)
        procedureType = "( ®â¯à ¢ª  ";
      else
        VerificationType  = vType;
      end;

      sFlg = true;
      
    end;

    if(VerificationType == VerificationManual)
      procedureType = "( àãç­ ï ¢¥à¨ä¨ª æ¨ï";
    elif(VerificationType == VerificationPayments)
      procedureType = "( ¢¥à¨ä¨ª æ¨ï ¯® ¯« â¥¦ ¬";
    elif(VerificationType == VerificationAuto)    
      procedureType = "(  ¢â®¬ â¨ç¥áª ï ¢¥à¨ä¨ª æ¨ï";
    end;

    if(vType != 0)
      procedureType =  procedureType + " ¨ ®â¯à ¢ª  )";
    else
      procedureType =  procedureType + " )";
    end; 

    [  âç¥â ¯® á®®¡é¥­¨ï¬ á¥ ­á  #     
    
    
       ¯¥à æ¨®­¨áâ  ###### #
       „ â           #
       ‚à¥¬ï         #]
    ( procedureType,
      {oper},
      {Name_Oper},
      date:f,
      time
    ); 


    printLn("");

    PrintSucceedSessions(sFlg);

    printLn("");
    
    var sessions:TArray = TArray();

    PrintUnSucceedSessions(sFlg, sessions);

    if(VerificationType == VerificationAuto)
      printLn("");
      PrintPaymentDifference(sessions);
    end;   

  return 0;
end;
