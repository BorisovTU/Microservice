 /*
 $Name: prcrgdec.mac
 $Module: Banking
 $Description: à®â®ª®« ®¡à ¡®âª¨ ®â«®¦¥­­®£® “ "‘¯à ¢ª  ”‘"
 */

/*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : prcrgdec.mac
  Created     : 19.10.2011
  Programmer  : Popova O.
  Description : à®â®ª®« ®¡à ¡®âª¨ ®â«®¦¥­­®£® “ "‘¯à ¢ª  ”‘"

ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*/
import globals, oralib, likepy, WldInter, MesInter, CTInter;

/* ‚á¯®¬®£ â¥«ì­®¥ */
private macro GetRegDecType( type:integer ):string

  var rset:RsdRecordset = execSQLselect( "SELECT t_note FROM dllvalues_dbt WHERE t_element = :type and t_list = :list", makeArray( SQLParam( "type", type ), SQLParam( "list", OBJTYPE_TYPE_WLDECISION ) ), TRUE );

  if( rset and rset.moveNext() )
    return rset.value(0);
  end;
  return "";
end;

private macro GetMesProps( MesID:integer, Referense:@string, Form:@string, StatusName:@string )

  var rset:RsdRecordset = execSQLselect( "SELECT mes.t_TRN, form.t_Name, stat.t_Name "+
                                         "  FROM dwlmeslnk_dbt lnk, dwlmes_dbt mes, dwlmesrls_dbt rls, dwlmesfrm_dbt form, dwlstatus_dbt stat "+
                                         " WHERE lnk.t_ObjID = :ID AND lnk.t_ObjKind = :ObjKind "+
                                         "   AND lnk.t_MesID = mes.t_MesID "+
                                         "   AND mes.t_RlsFormID = rls.t_RlsFormID " +
                                         "   AND rls.t_FormID = form.t_FormID "+
                                         "   AND stat.t_State = mes.t_State AND stat.t_TypeState = 1 ", 
                                         makeArray( SQLParam( "ID", MesID ), SQLParam( "ObjKind", OBJTYPE_FNSINFO ) ), TRUE );

  if( rset and rset.moveNext() )
    Referense   = rset.value(0);
    Form        = rset.value(1);
    StatusName  = rset.value(2);
  end;
end;

private macro GetOperName():string

  var rset:RsdRecordset = execSQLselect( "SELECT t_name FROM dperson_dbt WHERE t_Oper = :Oper ", makeArray( SQLParam( "Oper", {Oper} ) ), TRUE );

  if( rset and rset.moveNext() )
    return rset.value(0);
  end;
  return "";
end;
/* ’¥ªãé ï â ¡«¨æ  */
private var CurTable = 0;

/* „ ­­ë¥ á¯à ¢ª¨ ¤«ï ®âç¥â  */
private class ( TbFile ) CFNSInfoProcRepData( _ID:integer )
  private var DocType     :string = "";
  private var StatusName  :string = "";
  private var AcDescrEmpty:bool   = true;
  private var AccList     :object = NULL;
  private var recWlAcc    :TRecHandler = TRecHandler( "wlacclnk.dbt" );
  private var Referens    :string = "";
  private var Form        :string = "";
  InitTbFile( "greqdec.tmp", "bank.def" );
  rec.ID = _ID;
  if( GetEQ( this ) )
    AccList = RsbWlAccLnk( rec.DecisionID, OBJTYPE_FNSINFO );
    DocType = GetRegDecType( rec.Type );
    GetMesProps( rec.DecisionID, @Referens, @Form, @StatusName );

    if( AccList.First( recWlAcc ) == 0 )
      AcDescrEmpty = ( recWlAcc.rec.Description == "" );
    end;
    while( ( AcDescrEmpty == true ) and ( AccList.Next( recWlAcc ) == 0 ) )
      AcDescrEmpty = ( recWlAcc.rec.Description == "" );
    end;
  end;
  /* ‚ë¢¥áâ¨ áâà®ªã ®âç¥â  */
  private macro PrintStr( i:integer )
    var _Date = "";
    if( i == 0 )
      _Date = rec.Date;
    elif( ( i == 1 ) and ( rec.Type == WLD_TYPE_REGDEC_IVS ) )
      _Date = rec.EndDate;
    end;
    var Note = "";
    if( AcDescrEmpty == true )
      Note = rec.Description;
    else
      Note = recWlAcc.rec.Description;
    end;
[³#########################³##########³############³############################³#######################³##################³#####³############³#################################³]
( IfThenElse( i == 0, DocType             , "" ), 
  _Date                                         ,
  IfThenElse( i == 0, rec.ClientINN       , "" ),
  IfThenElse( i == 0, rec.ClientName      , "" ),
  recWlAcc.rec.Account                          ,
  IfThenElse( i == 0, Referens            , "" ),
  IfThenElse( i == 0, Form                , "" ),
  IfThenElse( i == 0, StatusName          , "" ),
  IfThenElse( i == 0, Note                , recWlAcc.rec.Description ):w );
  end;
  /* ‚ë¢¥áâ¨ ¤®ªã¬¥­â */
  macro PrintDoc()
    var i = 0;
    if( AccList.First( recWlAcc ) == 0 )
      PrintStr( i ); 
      i = i + 1;
      while( AccList.Next( recWlAcc ) == 0 ) 
        PrintStr( i );
        i = i + 1;
      end;
    else
      PrintStr( 0 );
    end; 
  end;

end;

/* à®â®ª®« ®¡à ¡®âª¨ ®â«®¦¥­­ëå á¯à ¢®ª ¨ ¢ë¯¨á®ª */
macro  WldPrintReportProcFNSInfo(InitialRgdStatus : string)
[
à®â®ª®« ¯à®æ¥¤ãàë ®¡à ¡®âª¨ ############### á¯à ¢®ª ¨ ¢ë¯¨á®ª

„ â  ®âç¥â : ##########
ˆá¯®«­¨â¥«ì: #### #                           

ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
³   ‚¨¤ ¤®ªã¬¥­â          ³   „ â    ³                Š«¨¥­â                   ³      ®¬¥à áç¥â       ³           ‘®®¡é¥­¨¥                 ³         à¨¬¥ç ­¨¥              ³
³                         ³          ÃÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´                       ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄ´                                 ³
³                         ³          ³    ˆ     ³         ¨¬¥­®¢ ­¨¥        ³                       ³    ¥ä¥à¥­á      ³”®à¬ ³    ‘â âãá  ³                                 ³
ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´]

( InitialRgdStatus, {curdate}, {Oper}, GetOperName() );

  var rset:RsdRecordset = execSQLselect( "SELECT t_ID, t_Type FROM dgreqdec_tmp ORDER BY t_Type, t_Date", NULL, TRUE );
  if( rset )
    while( rset.moveNext() )
      CFNSInfoProcRepData( rset.value(0) ).PrintDoc();
    end;
[ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
  end;
  return 0;
end;

