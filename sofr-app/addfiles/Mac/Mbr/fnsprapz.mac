/*
$Name:          fnsprapz.mac
$Module:        МБ Расчеты
$Description:   Печать сообщения APZ - отзыв неисполненных поручений  НО
*/

import "wldoc.mac", "fnsprapall.mac", "fnsreadmall.mac";

class ( MessageReader ) PrintAPZ
  var НомРеш = "",
      ДатаРеш = "",
      НаимНо = "",
      БанкПл = "",
      БИКБПл = "",
      Фамилия = " ",
      Имя = " ",
      Отчество = "",
      FIO = "",
      ВидПоруч = "",
      ДатаПоруч = "",
      НомПоруч = "",
      ИНННП = "",
      КППНП = "",
      КласЧин = "",
      НаимБ = "",
      СумПлат = "",
      
  ListReg = TArray(),
  AccKindList = TArray(),
  AccList = TArray();
      
  macro ВидСч( value )
    AccKindList[AccKindList.size] = value;
  end;
  
  macro НомСчПл( value )
    AccList[AccList.size] = value;
  end;
  
  macro _ConvertBlock_( name )
    if ( name == "Руководитель" )
      FIO = Фамилия + " " + Имя + " " + Отчество;
    end;
    
    if( name == "ОтозвПоруч" )
    var TempStr = "";
      if( ВидПоруч == 1 )
        TempStr = "на списание и перечисление денежных средств со счетов налогоплательщика (плательщика сбора," + 
                 " плательщика страховых взносов, налогового агента) в бюджетную систему Российской Федерации";
      elif( ВидПоруч == 2 )
        TempStr = "на перевод электронных денежных средств со счетов налогоплательщика (плательщика сбора, " +
                 "плательщика страховых взносов, налогового агента) в бюджетную систему Российской Федерации"
      end;
      TempStr = TempStr + " от " + ДатаПоруч + " N " + НомПоруч;
      
      ListReg[ListReg.Size] = TempStr; 
      
    end;
    
    
  end;
  
  macro _Normalize_()
    if (ДатаРеш == "")
      ДатаРеш = DDpMMpYYYY( ToDateYYYY_MM_DD(ДатаРеш) );
    end;
    
    
    
  end;
  
  
end;

macro Draw( APZ : PrintAPZ, mesId : integer, kind : integer )

  [
                                                        Решение N #
                                                                 ───────
                             об отзыве неисполненных поручений на списание и перечисление денежных
                               средств со счетов налогоплательщика (плательщика сбора, плательщика
                               страховых взносов, налогового агента), а также на перевод электронных
                               денежных средств налогоплательщика (плательщика сбора, плательщика
                                    страховых взносов, налогового агента) в бюджетную систему
                                                      Российской Федерации

                                                   от "##" ######### #### г.
                                                      ───────────────────
  ]
  (
    APZ.НомРеш,
    substr( APZ.ДатаРеш, 9, 2),
    Месяца( substr( APZ.ДатаРеш, 6, 2 ) ):c,
    substr( APZ.ДатаРеш, 1, 4 )
  );
  
  PrintTaxNameHead ( APZ );
  
  
  [                                        РЕШИЛ:
     
    Отозвать из банка ###########################################################################################################  
                      ───────────────────────────────────────────────────────────────────────────────────────────────────────────
                                            (полное наименование банка, БИК)
                                            
  ]
  (
    APZ.БанкПл + ", " + APZ.БИКБПл
  );
  
  PrintBodyAP( APZ, mesId, kind );
  
  return true;

end; 


macro PrintDoc( addrMes, MassCopy )
  var field_name, field_value;
  var MsgTmpFileName, OldName;
  FILE MsgTmpFile() txt;


  SetBuff( wlmes, addrMes );

  /* Перенаправляем вывод сообщения в файл, чтобы при многократной печати использовать данные */
  MsgTmpFileName = GetTxtFileName("tmpfnsprnAPZ");
  OldName = SetOutPut( MsgTmpFileName );

  if( not open(MsgTmpFile, MsgTmpFileName) )
    std.msg( String("Файл не открыт:", "|", MsgTmpFileName) );
    return FALSE;
  end;

  var APZ = PrintAPZ();
  APZ.ReadMessage();

  Draw( APZ, wlmes.MESID, wlmes.KIND );

  close( MsgTmpFile );
  SetOutPut( OldName, true ); /* Перенаправляем вывод обратно */

  while( MassCopy != 0 )
    rewind( MsgTmpFile );
    while( next(MsgTmpFile) )
      println( MsgTmpFile.str );
    end;
    MassCopy = MassCopy - 1;
  end;

  return true;

OnError(er) /* обработка ошибок времени выполнения */
  ExeptionMessage( er );
  return false;
end;