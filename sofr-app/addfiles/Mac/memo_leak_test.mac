import memhelper, DealsInter, rcw;

macro FormatBytes(bytes)
  if (bytes < 1024) 
    return string(bytes) + " B";
  end;
  var exp = Int((Log(bytes)/Log(1024)));
  var pre = SubStr("KMGTPE",exp,1);
  var result = bytes / Pow(1024,exp);
  return String(result:0:2) + " " + pre + "B";
end;
 
macro RunTest()
  var linuxPid = DLM_GetLinuxPID();
  var memBeforeBytes = DLM_GetMemoryUsage_Smaps_Private(linuxPid);
  println("Память до теста: " + FormatBytes(memBeforeBytes));
  var i = -1;

  while ((i=i+1) < 2000)
    DL_RunMacroOnCBnkRunMac("setposprm.mac","SetAddParamPositioning");
  end; 
  var memAfterBytes =  DLM_GetMemoryUsage_Smaps_Private(linuxPid);
  println("Память после теста: " + FormatBytes(memAfterBytes));

  var bytesDiff = memAfterBytes - memBeforeBytes;

  var desc = "";
  if (bytesDiff > (5 * 1024 * 1024))
    desc = "Разница значительна - утечка памяти.";
  else
    desc = "Разница незначительна. Погрешность работы приложения";
  end;

  println();
  println("Разница в " +  FormatBytes(bytesDiff) + ". " + desc);
end;

RunTest();