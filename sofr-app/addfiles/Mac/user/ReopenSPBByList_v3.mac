import RSD;
import OprInter, PTInter, PaymInter, CTInter, SPInter, sp_class, "dpimp.mac" , "spRepFun.mac";
import RsbDataSet;
import sfinter, rsd, sp_car, activex, or_rep_h;
import "dlcontrmsg.mac";

private macro FindDBO(DBO_NUM:string, DBO_ID:@integer)
   var sqls = String( "select dlc.t_dlcontrid   \n"
                     ,"  from ddlcontr_dbt dlc, dsfcontr_dbt sfc   \n"
                     ," where sfc.t_id = dlc.t_sfcontrid   \n"
                     ,"   and sfc.t_number = ?   and sfc.t_dateclose = to_date('01010001','ddmmyyyy')\n");
   var cmd = RSDCommand(sqls);
       cmd.AddParam("", rsdbp_in, DBO_NUM);
   var rs = RSDRecordset(cmd, 1, 1);
       if(rs.movenext)
          DBO_ID = rs.value("t_dlcontrid");
          return 1;
       end;
   return 0;
end;

private macro FindCloseSPB(dbo_id:integer, sf_id:@integer)
   var sqls = String( "select sfc.t_id   \n"
                     ,"  from ddlcontrmp_dbt mp, dsfcontr_dbt sfc   \n"
                     ," where sfc.t_id = mp.t_sfcontrid   \n"
                     ,"   and mp.t_dlcontrid = ?   \n"
                     ,"   and mp.t_marketid = 151337   \n"
                     ,"   and sfc.t_dateclose != to_date('01010001', 'ddmmyyyy')   \n");
   var cmd = RSDCommand(sqls);
       cmd.AddParam("", rsdbp_in, dbo_id);
   var rs = RSDRecordset(cmd, 1, 1);
       if(rs.movenext)
          sf_id = rs.value("t_id");
          return 1;
       end;
   return 0;
end;

private macro FindOpenSPB(dbo_id:integer, sf_id:@integer)
   var sqls = String( "select sfc.t_id   \n"
                     ,"  from ddlcontrmp_dbt mp, dsfcontr_dbt sfc   \n"
                     ," where sfc.t_id = mp.t_sfcontrid   \n"
                     ,"   and mp.t_dlcontrid = ?   \n"
                     ,"   and mp.t_marketid = 151337   \n"
                     ,"   and sfc.t_dateclose = to_date('01010001', 'ddmmyyyy')   \n");
   var cmd = RSDCommand(sqls);
       cmd.AddParam("", rsdbp_in, dbo_id);
   var rs = RSDRecordset(cmd, 1, 1);
       if(rs.movenext)
          sf_id = rs.value("t_id");
          return 1;
       end;
   return 0;
end;

private macro ExistNotProcCloseMSG(dboid)
    var sqls = String( "select t_sendmesstate   \n"
                  ,"  from ddlcontrmsg_dbt   \n"
                  ," where t_dlcontrid = ?   \n"
                  ,"   and t_marketid = 151337   \n"
                  ,"   and t_kind = 3   \n" );
   var cmd = RSDCommand(sqls);
       cmd.AddParam("", rsdbp_in, dboid);
   var rs = RSDRecordset(cmd, 1, 1);
       while(rs.movenext)
          if(rs.value("t_sendmesstate") != 310 )
            return 1;
          end;
       end;
   return 0;
end;

private macro SaveOldMSG(dboid)
   var sqls = String( "update ddlcontrmsg_dbt   \n"
                  ,"   set t_kind = to_number('999' || to_char(t_kind))   \n"
                  ," where t_dlcontrid = ?   \n"
                  ,"   and t_marketid = 151337   \n"
                  ,"   and t_kind in (2, 3, 9, 10)   \n");
   var cmd = RSDCommand(sqls);
       cmd.AddParam("", rsdbp_in, dboid);
       cmd.execute;
   return 1;
onerror(err)
  return 0;
end;

private macro RefreshCloseDate(dboid, spbsfcloseid)
  var sqls = String( "update dsfcontr_dbt sfc   \n"
                ,"   set sfc.t_dateclose = to_date('01010001', 'ddmmyyyy')   \n"
                ," where t_id = ?;   \n");
   var cmd = RSDCommand(sqls);
       cmd.AddParam("", rsdbp_in, spbsfcloseid);
       cmd.execute;

  sqls = String( "update ddlcontrmp_dbt mp   \n"
              ,"   set mp.t_mpclosedate = to_date('01010001', 'ddmmyyyy')   \n"
              ," where mp.t_dlcontrid = ?   \n"
              ,"   and mp.t_sfcontrid = ?   \n" );
    cmd = RSDCommand(sqls);
       cmd.AddParam("", rsdbp_in, dboid);
       cmd.AddParam("", rsdbp_in, spbsfcloseid);
       cmd.execute;


   return 1;
onerror(err)
  return 0;


end;


private macro CloseKUT(dboid)
  var sqls = String( " update ddlobjcode_dbt code set T_BANKCLOSEDATE = ?   \n"
                ,"where code.t_objectid = ?   \n"
                ,"  and code.t_codekind = 2;   \n"  );
   var cmd = RSDCommand(sqls);
       cmd.AddParam("", rsdbp_in, {curdate});
       cmd.AddParam("", rsdbp_in, dboid);
       cmd.execute;


   return 1;
onerror(err)
  return 0;

  
end;

private macro NeedSetTP(dboID, SFID, sfplanid:@integer)
  var sqls = String( "select sfc.t_id,   \n"
                ,"       plan.t_sfplanid,   \n"
                ,"       (select plan_s.t_sfplanid   \n"
                ,"          from dsfcontrplan_dbt plan_s   \n"
                ,"         where plan_s.t_sfcontrid = ?  \n"
                ,"           and t_begin <= ?   \n"
                ,"           and (t_end >= ? or t_end = to_date('01010001', 'ddmmyyyy'))) as t_sfplanid_s   \n"
                ,"  from ddlcontr_dbt dlc, dsfcontr_dbt sfc   \n"
                ,"  left join dsfcontrplan_dbt plan   \n"
                ,"    on plan.t_sfcontrid = sfc.t_id   \n"
                ,"   and t_begin <= ?   \n"
                ,"   and (t_end >= ? or t_end = to_date('01010001', 'ddmmyyyy'))   \n"
                ," where dlc.t_sfcontrid = sfc.t_id   \n"
                ,"   and dlc.t_dlcontrid = ?   \n");
   var cmd = RSDCommand(sqls);
       cmd.AddParam("", rsdbp_in, SFID);
       cmd.AddParam("", rsdbp_in, {curdate});
       cmd.AddParam("", rsdbp_in, {curdate});
       cmd.AddParam("", rsdbp_in, {curdate});
       cmd.AddParam("", rsdbp_in, {curdate});
       cmd.AddParam("", rsdbp_in, dboid);
       var rs = RSDRecordset(cmd,1,1);
       if(rs.movenext)
          sfplanid = rs.value("t_sfplanid"); 
          if (rs.value("t_sfplanid_s") == rs.value("t_sfplanid"))
            return 0;
          end;
       end;
   return 1;
end;

private macro ChangeTP(sfcontrid,NewTarifId)

   var sql = " DECLARE "
       + "   v_FuncobjID dfuncobj_dbt.t_ID%TYPE; "   
       + " BEGIN "
       + "   for c in (select 209 as t_kind, ? as t_id from dual)  loop "
       + "     INSERT INTO dfuncobj_dbt (t_ObjectType, t_ObjectID, t_FuncID, t_Param, t_Priority, t_Oper) "
       + "                       VALUES (c.t_Kind, c.t_ID, 7777,   to_char(c.t_ID)||';'||to_char(?)||';'|| to_char(?, 'DD.MM.YYYY'), 55, ?) " 
       + "     RETURNING t_ID INTO v_FuncobjID; "
       + "     INSERT INTO ddl_differentid_tmp (t_ID) VALUES (v_FuncobjID); "
       + "   END LOOP; "   
       + " END; ";

   var cmd = RSDCommand(sql);
       cmd.addParam("", RSDBP_IN, sfcontrid);
       cmd.addParam("", RSDBP_IN, NewTarifId);
       cmd.addParam("", RSDBP_IN, {curdate});
       cmd.addParam("", RSDBP_IN, {oper});
       cmd.execute();

end;


var err, errstr;
var FullNameFile = "", file_xlsx, pFileName  ,ExtName, DirName, Sheet, range, i = 1, j = 1, cnt = 0, SF_NUM = "", number = "", InputDir = "";

println ("Подготовка: " + err + " " + errstr);


if (not err)

    InputDir = "..\\Import\\";
    if(not SelectFile(FullNameFile, InputDir + "CheckSPB_*.xls*", "Выберите файл для загрузки", 0, true))
      MsgBox("Отказ от загрузки");
      return false;
    else
       splitfile(FullNameFile, pFileName, ExtName);
       pFileName = pFileName + ExtName;
       println ("Обработка файла: " + pFileName);
       DirName = substr(FullNameFile, 1, index(FullNameFile, pFileName) - 1);

       if(not OpenExcelFile(pFileName, false, true, DirName))
         MsgBox("Ошибка открытия файла \"" + FullNameFile + "\"");
         return false;
       end;

       j = 1;
       while(j <= ExcelApplication.Sheets.Count)

          Sheet = ExcelApplication.Sheets(j);
          i = 1;

          while (ValType(Sheet.Cells(i, 1).Value) != V_UNDEF)

            SF_NUM = string(Sheet.Cells(i, 1).Value:0:0);
            var dboid = 0;
            if (FindDBO(SF_NUM, @dboid))
               [Обработка договора: #############  : #################################################################################################]( SF_NUM,"Договор найден");
               err = 0;
            else 
               err = 1;
            end;

            var spbsfcloseid = 0; 
            var spbsfopenid = 0; 
            if (not err)
              if(FindCloseSPB(dboid, @spbsfcloseid)) 
                 if (not FindOpenSPB(dboid, @spbsfopenid))
                 else
                   [                    #############  : #################################################################################################]( SF_NUM,"Ошибка. Для ДБО существует открытая площадка на СПБ");
                   err = 1;
                 end;
              else
                 [                    #############  : #################################################################################################]( SF_NUM,"Ошибка. Не найдена закрытая площадка на СПБ");
                 err = 1;
              end;
            end;

            if(not err)
            // обновление дат
              RefreshCloseDate(dboid, spbsfcloseid);
              [                    #############  : #################################################################################################]( SF_NUM,"ОК. Обновление даты закрытия площадки");
            end;

            if (not err)
               var tpid = 0;
               var state;
               if((NeedSetTP(dboid, spbsfcloseid, @tpid)) and (tpid !=0)) 
                 state  = SfContrChangeSfPlan(spbsfcloseid, tpid, date(), false);
                 if(state != 0)
                   [                    #############  : #################################################################################################]( SF_NUM,"Ошибка смены ТП.");
                 else 
                   [                    #############  : #################################################################################################]( SF_NUM,"ОК. ТП установлен.");
                 end;
               else
                 [                    #############  : #################################################################################################]( SF_NUM,"ОК. Смена ТП не требуется");

               end;
            end;

            if(not err)
               if(ExistNotProcCloseMSG(dboid))
                 [                    #############  : #################################################################################################]( SF_NUM,"Ошибка. Найдено неподтвержденное сообщение о закрытии СПБ.");
                 err = 1;
               else
                 if(not SaveOldMSG(dboid))
                   err = 1;
                   [                    #############  : #################################################################################################]( SF_NUM,"Ошибка бекапа старых сообщений");
                 else
                   [                    #############  : #################################################################################################]( SF_NUM,"ОК. Сохранение старых сообщений");
                 end;
               end;
            end;

            if(not err)
            // Обнуление КУТ
              CloseKUT(dboid);
              [                    #############  : #################################################################################################]( SF_NUM,"ОК. Обновление даты закрытия площадки");
            end;

            if (not err)
              // подготовка бронирования
              var dlcontr = TRecHandler("dlcontr.dbt");
              if(DL_GetRecHandler(dlcontr, "SELECT DLCONTR.* FROM DDLCONTR_DBT DLCONTR WHERE DLCONTR.T_DLCONTRID = ?", dboid))
                ExecMacroFile("recreatDlcontrmsg.mac","recreatDlcontrMessage", dlcontr, OBJTYPE_DLCONTRMSG_BIDCODE, 151337); 
                [                    #############  : #################################################################################################]( SF_NUM,"ОК. Бронирование выполнено");
              else
                [                    #############  : #################################################################################################]( SF_NUM,"Ошибка подготовки бронирования");
              end;
            end;


            [                    #############  : #################################################################################################]( SF_NUM,"Обработка завершена");

            i = i + 1;
          end;
          j = j+1;
       end;



    end;




end;
