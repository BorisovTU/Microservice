// отправка сообщений для клиентов 

import dbo_message_vtb;

var sql_str, rs;
var cnt = 0;
var pf, v_error;

println(time());

sql_str = 
"select dl_o.t_dlcontrid, sf.t_number, sf.t_datebegin from "+
"            ddlcontr_dbt dl, "+
"            dsfcontr_dbt sf, "+
"            dnotetext_dbt n, "+
"            ddlcontr_dbt dl_o, "+
"            dsfcontr_dbt sf_o "+
"        where sf.t_id = dl.t_sfcontrid "+
"        and sf.t_dateclose > to_date('01010001','ddmmyyyy') "+
"        and n.t_objecttype = 207 and n.t_notekind = 135 and n.t_documentid = lpad(dl.t_dlcontrid,34,'0') "+
"        and sf_o.t_partyid = sf.t_partyid "+
"        and sf_o.t_dateclose = to_date('01010001','ddmmyyyy') "+
"        and sf_o.t_id = dl_o.t_sfcontrid "+
"        and not exists (select 1 from ddlcontrmsg_dbt m "+
"                         where m.t_kind = 500 and m.t_dlcontrid = dl_o.t_dlcontrid "+
"                           and m.t_createdate > sf.t_dateclose and m.t_createdate = to_date('13.05.2022','dd.mm.yyyy'))"+
"        and exists (select 1 from ddlcontrmsg_dbt m "+                                              
"                     where m.t_kind = 500 and m.t_dlcontrid = dl.t_dlcontrid)";  

InitProgress(-1);

  rs = RSDRecordSet(sql_str);
  while (rs.movenext)
SetDialogFlag(0);
      pf = dboMessage(rs.value("t_dlcontrid")).CreateMessage(true,true,true);
      println(pf.NumberDBO+" "+pf.Prt_Fnam +" "+ pf.statMes);
SetDialogFlag(1);

      cnt = cnt+1;
      pf = null;
      UseProgress(cnt);
  end;
  RemProgress();
println(time());

  if (cnt > 0)
     msgbox("Отправлено: "+cnt+" сообщений.");
  else 
     msgbox("Нет записей");
  end;


exit(0);


