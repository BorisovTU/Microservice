import PTinter,RSBDataSet,dl_plib,dlgCommon,funk,dl_kvlib; 
private  var d0,pId22,rs0,cmd22,{curdate},sql0,flag,rs05,que; 
private  var col22 = TArray();
private  var v_DealId = TArray(), v_count;




Macro bsdel()


     d0={curdate};
     sql0="select a.t_id pId22,b.t_valuedate dealdate,  e.t_shortname nam, a.t_code dealcode, a.t_extcode dealcodets, (case when b.t_payer != 1 then TO_CHAR(b.t_baseamount,'9,999,999,999.00') else (select  TO_CHAR(bb.t_baseamount,'9,999,999,999.00')   from dpmpaym_dbt bb where bb.t_dockind=b.t_dockind and  ";
     sql0=sql0+"  bb.t_documentid=b.t_documentid and bb.t_purpose=b.t_purpose+1)  end) su1, (case when b.t_payer = 1 then TO_CHAR(b.t_baseamount,'9,999,999,999.00') else  (select  TO_CHAR(bb.t_baseamount,'9,999,999,999.00')   from dpmpaym_dbt bb where bb.t_dockind=b.t_dockind and  bb.t_documentid=b.t_documentid and bb.t_purpose=b.t_purpose+1 ) end) su2, ";

     sql0=sql0+" (case when b.t_payer != 1 then (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid=b.t_fiid) else (select  (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid=bb.t_fiid)   from dpmpaym_dbt bb where bb.t_dockind=b.t_dockind and ";
     sql0=sql0+" bb.t_documentid=b.t_documentid and bb.t_purpose=2)  end) fiid1, (case when b.t_payer = 1 then (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid=b.t_fiid) else ";
     sql0=sql0+"  (select  (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid=bb.t_fiid)   from dpmpaym_dbt bb where bb.t_dockind=b.t_dockind and  bb.t_documentid=b.t_documentid and bb.t_purpose=b.t_purpose+1)  end) fiid2, 'В обработке' sta ";
     sql0=sql0+" from ddvndeal_dbt a , dpmpaym_dbt b, dparty_dbt e  where a.t_contractor=2   and  (a.t_kind=22730 or a.t_kind=2730  or a.t_kind=2740)  and b.t_dockind= 4813 and b.t_documentid=a.t_id and (b.t_purpose=1 or  b.t_purpose=3)  and  (to_char(b.t_valuedate,'dd.mm.yyyy') = '"+СДАТ(d0)+"' or  to_char(a.t_date,'dd.mm.yyyy') = '"+СДАТ(d0)+"') and e.t_partyid=a.t_contractor  order by b.t_paymstatus, b.t_valuedate ";

      // msgbox(sql0);

      cmd22 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );



  macro EvProc22 (rs0, cmd22, id, key )
     if (cmd22 == DLG_INIT)	// Инициализация
        if (pId22 != "0")  // Надо найти запись
           v_count = 0;

           while ( (rs0.value ("pId22") != pId22) And (Not rs0.EOF) )  
		if (ValType(rs0.value ("pId22")) == 26)
			v_DealId(v_count) = 0;
		else
			v_DealId(v_count)= rs0.value ("pId22");
		end;
                rs0.Move(1, RELATIVE);
		v_count = v_count + 1;
            end;

        end;
        GoToScroll(rs0, true);
     elif (cmd22 == DLG_KEY)
        pId22=rs0.value ("pId22");
        if(DLG_KEY_ENTER == Key)
           return CM_SELECT;
        elif(DLG_KEY_F5 == Key) 
           return CM_SELECT;

        end;
     end;
  end;




  AddCol (col22, 0, "nam","Контрагент", 16);
  AddCol (col22, 1, "dealdate","Дата ", 10);
  AddCol (col22, 2, "dealcode","№ сделки", 10);
  AddCol (col22, 3, "dealcodets","№ сделки(вн)", 10);
  AddCol (col22, 4, "su1","Cумма требований", 15);                                                                                                                                                                                                          AddCol (col22, 5, "su2","Сумма обязательств", 15);
  AddCol (col22, 5, "fiid1","Валюта", 6);
  AddCol (col22, 6, "su2","Cумма обязательств", 15);     
  AddCol (col22, 7, "fiid2","Валюта", 6);
  AddCol (col22, 8, "sta","Статус обработки сделки", 20);

   while(RunScroll(cmd22, 9, col22, null, @EvProc22,"Монитор обработки сделок FX ММВБ за "+СДАТ(d0)," ESC- Выход ", null, 10, 10) )
     cmd22 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );

   end;

   exit(1);
end;



