//----------------------------------------------------------------------------------------------------------
// 
// Алгоритм взимания комиссии ФИССиКО. Организация исполнения поставочного фьючерсного/ опционного контракта.
// 
//----------------------------------------------------------------------------------------------------------
import sfinter, RSD, RsbDataSet, "spserv.mac";
macro CalcServiceSum( sfcontr_addr:MEMADDR, BeginDate:DATE, EndDate:DATE, sfalg_adr:MEMADDR )
   VAR rComiss  = TRecHandler( "sfcomiss.dbt" ), 
       rContr   = TRecHandler( "sfcontr.dbt" ),
       rAlgBase = TRecHandler( "sfcalcal.dbt" );       
   VAR PeriodComm, sum = 0.00;
   record  rBaseSum( "sfbassum.str" );
   var Error = 0;
   const CategClose = 101;
   Var rs, cmd, rs1, cmd1, amount = 0, amountdif = 0, delta = 0, DealType = "";
   rContr.SetRecordAddr( sfcontr_addr );
   rAlgBase.SetRecordAddr( sfalg_adr );
        cmd = RSDCommand("  SELECT deal.* "
                          +" FROM ddvdeal_dbt deal"
                          +" WHERE     deal.t_client = ? "
                          +" AND deal.t_clientcontr = ? "
                          +" AND deal.t_date = ? "
                          +" AND deal.t_type = 'E' ");

        cmd.addParam( "", RSDBP_IN,  rContr.rec.partyid);
        cmd.addParam( "", RSDBP_IN,  rContr.rec.id);
        cmd.addParam( "", RSDBP_IN,  EndDate);
        cmd.addParam( "", RSDBP_IN,  CategClose);
        cmd.execute();
        rs = TRsbDataSet( cmd );
        while(rs.MoveNext())
              rBaseSum.baseType    = 2;
              rBaseSum.baseType2   = 2;
              rBaseSum.baseQuont   = rs.amount; 
              rBaseSum.baseQuont2  = rs.amount;
              rBaseSum.BaseObjectType = OBJTYPE_OPER_DV;
              rBaseSum.BaseObjectID   = rs.id;
              if(InsertSumList(rBaseSum) )
                  Error = 1;
                  MsgBox("Ошибка при вставке базовой суммы");
              end;
        End;//eow

   return;

end;
