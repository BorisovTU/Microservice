/*
*/
//IMPORT Global, RsbFormsInter, "cb_sql.mac", PTInter, "dlquery.mac", rsd;
IMPORT "qracctools.mac";
//IMPORT "role_model.mac";//‡Æ´•¢†Ô ¨Æ§•´Ï

import RsbFormsInter,activex, oralib, likepy, BankInter, DVInter, globals, rsd,RsbDataSet, PTInter,CTInter, "cb_sql.mac";
import "u_common_email_utils.mac", "dlquery.mac";

private const PARTY_ATTR_GROUP_RISKCATEG = 95,
              CONTRACT_ATTR_GROUP_RISKCATEG = 103; /*ì‡Æ¢•≠Ï ‡®·™†*/
 

private macro iif(a,b,c)
    if(a)
        return b;
    else
        return c;
    end;
end;



macro unSetCateg(partyID)
  var err;
  DisconnectObjAttr( OBJTYPE_PARTY, string(PartyID:o:10), PARTY_ATTR_GROUP_RISKCATEG ); 
end;

macro SetCateg(partyid,risk_val, _date)
  var err;
  if   ((not DisconnectObjAttr( OBJTYPE_PARTY, string(PartyID:o:10), PARTY_ATTR_GROUP_RISKCATEG )) or (not ConnectObjAttr( Err, OBJTYPE_PARTY,string(PartyID:o:10), PARTY_ATTR_GROUP_RISKCATEG, null,"", string(risk_val), _date ))  OR  ( Err != 0 ))
    return 0;
  end;
  return 1;
end;

   macro RepHeader(dt, tm)
       var str;
       str =     "                             éíóÖí èêéñÖÑìêõ çÄóÄãúçéâ ìëíÄçéÇäà ìäÄíÖÉéêàâ êàëäÄ \n";
       str = str+"\n";
       str = str+"Ñ†‚† ß†£‡„ß™®  : "+dt+"\n";
       str = str+"Ç‡•¨Ô ß†£‡„ß™® : "+tm+"\n";
       str = str+"⁄ƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n";
       str = str+"≥ ≥ä´®•≠‚                      ≥ëÆ£´†Ë•≠®•        ≥ ë‚†‚„· ‡®·™†     ≥ Ñ†‚† „·‚†≠Æ¢™®≥äÆ¨¨•≠‚†‡®©                                                                              ≥\n";
       str = str+"√ƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";
       //toRep1(str);                                                                                                   
       println(str);                                                                                                   
    end;
    macro RepStr(_err,_client, _ca,_risk,_daterisk,_comm)
        var status;
        var str = "≥"+string(_err :1)   +"≥"+
                  string(_client  :28:l)+"≥"+
                  string(_ca      :18:l)+"≥"+
                  string(_risk    :18:l)+"≥"+
                 string(_daterisk :15:l)+"≥"+
                  string(_comm   :89:l) +"≥";
       return println(str);
    end;
    macro RepFooter(suc, er, tot)                                                       
       var str = "¿ƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ\n";
       str = str+"á†£‡„¶•≠Æ „·Ø•Ë≠Æ: "+suc+"\n";               
       str = str+"ç• ß†£‡„¶•≠Æ     : "+er+"\n";
       str = str+"Ç·•£Æ            : "+tot+"\n";
      println(str);
    end;
 

class Logger()


    macro RepHeader(dt, tm)
       var str;
       str =     "                             éíóÖí Æ ¢Î£‡„ß™• ëë §´Ô ·§•´Æ™ èîà \n";
       str = str+"\n";
       str = str+"Ñ†‚† ß†£‡„ß™®  : "+dt+"\n";
       str = str+"Ç‡•¨Ô ß†£‡„ß™® : "+tm+"\n";
       str = str+"⁄ƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n";
       str = str+"≥ ≥ë§•´™†                      ≥ëØ‡†¢. ·‚Æ®¨Æ·‚Ï  ≥Ñ†‚† ëë           ≥ë‚†‚„· ß†£‡„ß™®≥äÆ¨¨•≠‚†‡®©                                                                              ≥\n";
       str = str+"√ƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";
       //toRep1(str);                                                                                                   
       println(str);                                                                                                   
    end;
                                                                                                                                                                     
    macro RepFooter(suc, er, tot)                                                       
       var str = "¿ƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ\n";
       str = str+"á†£‡„¶•≠Æ „·Ø•Ë≠Æ: "+suc+"\n";               
       str = str+"ç• ß†£‡„¶•≠Æ     : "+er+"\n";
       str = str+"Ç·•£Æ            : "+tot+"\n";
      println(str);
    end;

    macro RepStr(_err,_code, _ss,_datess,_stat,_comm)
        var status;
        if (_stat == false)
            status = "á†£‡„¶•≠†";
        else
            status = "ç• ß†£‡„¶•≠†";
        end;
        var str = "≥"+string(_err   :1)   +"≥"+
                  string(_code    :28:l)+"≥"+
                  string(_ss      :18:l)+"≥"+
                  string(_datess  :18:l)+"≥"+
                  string(status    :15:l)+"≥"+
                  string(_comm   :89:l) +"≥";
       return println(str);
    end;

end;
macro getPatyRisk(partyid)

      var tsql = "SELECT a.t_attrid, a.\* " +
                 "  FROM dobjatcor_dbt t, dobjattr_dbt a " +
                 " WHERE     T.T_OBJECT = LPAD (?, 10, '0') " +
                 "       AND t.t_groupid = 95 " +
                 "       AND t.t_objecttype = 3 " +
                 "       AND t.t_groupid = a.t_groupid " +
                 "       AND t.t_objecttype = a.t_objecttype " +
                 "       AND a.t_attrid = t.t_attrid " +
                 "       AND TO_DATE ('20112020', 'ddmmyyyy') BETWEEN t.t_validfromdate " +
                 "                                                AND t.t_validtodate; " ;
      var tcmd = RSDCommand(tsql);
      tcmd.addparam("partyid", rsdbp_in, partyid);
      tcmd.addparam("date", rsdbp_in, {CurDate}); 
      var trs  = RSDRecordset(tcmd);   
      if(trs.movenext())
        return trs.value("t_attrid");
       end;
      return 0;
end;

 macro OpTransferRisk()
  var sql, cmd, rs;
  var cntrec;
  var n = 0;
  record pt_attr("objattr.dbt");
  var Pt_Categ;
  var pt_risk_val;
  record dlc_attr("objattr.dbt");
  var dlc_categ;
  var dlc_risk_val;
  var dt = StrSubSt(string(Date()),".","");
  var tm = StrSubSt(string(time()),":","");
  var InfoLogFileName = GetTxtFileName( "transfer_kpur_"+dt+"_"+tm);
  var ErrStr = "",ErrStat = false, err = 0, suc = 0;
  var StRec;
  var new_risk_val: integer, new_risk_val_str = "";
  var date_risk_connect:date;
  var PartyRisk;
  if (msgboxex("á†Ø„·‚®‚Ï „·‚†≠Æ¢™„ Ø‡®ß≠†™† äëìê §´Ô ™´®•≠‚Æ¢?", mb_yes + mb_no, ind_no, "ì·‚†≠Æ¢™† Ø‡®ß≠†™† äëìê.", "ì·‚†≠Æ¢™† Ø‡®ß≠†™† äëìê.") == ind_yes)
     sql = " SELECT dt.t_dlcontrid, " +
           "         dt.T_SFCONTRID, " +
           "         dt.T_IIS, " +
           "         dt.T_PARTYID, " +
           "         dt.T_LEGALFORM, " +
           "         dt.T_NAME, " +
           "         dt.T_SHORTNAME, " +
           "         dt.PT_RISK, " +
           "         dt.T_NUMBER, " +
           "         dt.T_DATEBEGIN, dt.t_dateclose," +
           "         dt.SF_RISK, " +
           "         dt.T_VALIDFROMDATE_SF " +
           "    FROM (SELECT dlc.t_dlcontrid, " +
           "                 dlc.t_sfcontrid, " +
           "                 dlc.t_iis, " +
           "                 dsf.t_partyid, " +
           "                 P.T_LEGALFORM, " +
           "                 dsf.t_name, " +
           "                 p.t_shortname, " +
           "                 NVL ( " +
           "                    (SELECT a.t_attrid " +
           "                       FROM dobjatcor_dbt t, dobjattr_dbt a " +
           "                      WHERE     T.T_OBJECT = LPAD (dsf.t_partyid, 10, '0') " +
           "                            AND t.t_groupid = 95 " +
           "                            AND t.t_objecttype = 3 " +
           "                            AND t.t_groupid = a.t_groupid " +
           "                            AND t.t_objecttype = a.t_objecttype " +
           "                            AND a.t_attrid = t.t_attrid " +
           "                            AND ? BETWEEN t. " +
           "                                                                          t_validfromdate " +
           "                                                                     AND t. " +
           "                                                                          t_validtodate), " +
           "                    0) " +
           "                    pt_risk, " +
           "                 dsf.t_number, " +
           "                 dsf.t_datebegin, dsf.t_dateclose," +
           "                 NVL ( " +
           "                    (SELECT a.t_attrid " +
           "                       FROM dobjatcor_dbt t, dobjattr_dbt a " +
           "                      WHERE     T.T_OBJECT = LPAD (dlc.t_dlcontrid, 34, '0') " +
           "                            AND t.t_groupid = 103 " +
           "                            AND t.t_objecttype = 207 " +
           "                            AND t.t_groupid = a.t_groupid " +
           "                            AND t.t_objecttype = a.t_objecttype " +
           "                            AND a.t_attrid = t.t_attrid), " +
           "                    0) " +
           "                    sf_risk, " +
           "                 (SELECT t.t_validfromdate " +
           "                    FROM dobjatcor_dbt t, dobjattr_dbt a " +
           "                   WHERE     T.T_OBJECT = LPAD (dlc.t_dlcontrid, 34, '0') " +
           "                         AND t.t_groupid = 103 " +
           "                         AND t.t_objecttype = 207 " +
           "                         AND t.t_groupid = a.t_groupid " +
           "                         AND t.t_objecttype = a.t_objecttype " +
           "                         AND a.t_attrid = t.t_attrid) " +
           "                    t_validfromdate_sf " +
           "            FROM ddlcontr_dbt dlc, dsfcontr_dbt dsf, dparty_dbt p " +
           "           WHERE dlc.t_sfcontrid = dsf.t_id AND p.t_partyid = dsf.t_partyid) dt where (dt.t_dateclose = to_date('01010001','ddmmyyyy') or dt.t_dateclose >  ?)  " +
           "ORDER BY dt.t_partyid, dt.sf_risk ASC " ;


//              ," and p.t_partyid = dsf.t_partyid )   \n");

    cmd = RSDCommand("Select count(1) countrec from (" + sql + ")"); 
    cmd.AddParam("pDatebegin", rsdbp_in, {CurDate});
    cmd.AddParam("pDateclose", rsdbp_in, {CurDate});

    rs = RSDRecordset(cmd, rsdval_client, rsdval_static);
    if(rs.movenext())
      cntrec = int(rs.value("countrec"));
      rs = null; cmd = null;
      if(cntrec)

       SetOutput( InfoLogFileName, true ); //è®Ë•¨ ´Æ£ ¢ ‰†©´. ç†Á†´Æ
       RepHeader(date(),time());
        cmd = RSDCommand(sql); 
        cmd.AddParam("pDate", rsdbp_in, {CurDate});
       cmd.AddParam("pDateclose", rsdbp_in, {CurDate});
        rs = RSDRecordset(cmd, rsdval_client, rsdval_static);

        InitProgress (int(cntrec));
        while (rs.movenext())

          n = n + 1;
          new_risk_val = 0;
          date_risk_connect = {CurDate};
//         unSetCateg(rs.value("t_partyid"));
          if ((rs.value("sf_risk") != 0) and (rs.value("pt_risk") != (rs.value("sf_risk"))))
             date_risk_connect = rs.value("t_validfromdate_sf"); 
             if (date_risk_connect < rs.value("t_datebegin"))
               date_risk_connect = rs.value("t_datebegin");
               ErrStr = "Ñ†‚† „·‚†≠Æ¢™® ≠•™Æ‡‡•™‚≠†, ß†¨•≠•≠† ≠† ‚•™„È„Ó. "
             end;
               partyRisk = getPatyRisk(rs.value("t_partyid"));
               if  ((rs.value("sf_risk") == 1/*äèìê ≠† §Æ£Æ¢Æ‡•*/)  and (partyRisk != 3)/*äéìê ≠† ™´®•≠‚•*/)  
                   new_risk_val = 2; //äèìê ≠† ™´®•≠‚• 
                   ErrStr = string(ErrStr, "ì·‚†≠Æ¢´•≠† ™†‚•£Æ‡®Ô · §Æ£Æ¢Æ‡†");  
               elif((rs.value("sf_risk") == 2/*äëìê ≠† §Æ£Æ¢Æ‡•*/) and (partyRisk != 3/*äéìê ≠† ™´®•≠‚•*/) and (partyRisk != 2)/*äèìê ≠† ™´®•≠‚•*/)
                   new_risk_val = 1; //äëìê ≠† ™´®•≠‚•
                   ErrStr = string(ErrStr, "ì·‚†≠Æ¢´•≠† ™†‚•£Æ‡®Ô · §Æ£Æ¢Æ‡†");   
               elif(rs.value("sf_risk") == 3) //äéìê ≠† §Æ£Æ¢Æ‡•
                   new_risk_val = 3; //ä0ìê ≠† ™´®•≠‚•
                   ErrStr = string(ErrStr, "ì·‚†≠Æ¢´•≠† ™†‚•£Æ‡®Ô · §Æ£Æ¢Æ‡†"); 
               elif(rs.value("sf_risk") == 4) //äçìê ≠† §Æ£Æ¢Æ‡•
                   new_risk_val = 4; //äçìê ≠† ™´®•≠‚•
                   ErrStr = string(ErrStr, "ì·‚†≠Æ¢´•≠† ™†‚•£Æ‡®Ô · §Æ£Æ¢Æ‡†");  
               end;
         
          end;
         if(new_risk_val==0)
           new_risk_val_str="";
         elif(new_risk_val==1)
           new_risk_val_str="äëìê";
         elif(new_risk_val==2)
           new_risk_val_str="äèìê";
         elif(new_risk_val==3)
           new_risk_val_str="äéìê";
         elif(new_risk_val==4)
           new_risk_val_str="äçìê";
         end;

          if ((new_risk_val) and (new_risk_val != 0))
            if (not  SetCateg(rs.value("t_partyid"), new_risk_val, date_risk_connect ))
              errstat = true;
              ErrStr = "éË®°™† „·‚†≠Æ¢™® ™†‚•£Æ‡®®";
            end;
          end;

         if(ErrStat)
           RepStr("X",rs.value("t_shortname"), rs.value("t_number"), new_risk_val_str, date_risk_connect, ErrStr);
           err = err + 1;

         else
           RepStr("",rs.value("t_shortname"), rs.value("t_number"), new_risk_val_str, date_risk_connect, ErrStr); 
           suc = suc + 1;

         end;
  
          UseProgress (n);   

          ErrStr = "";
          ErrStat = false;
          STrec = null;


        end;
        RemProgress (n);
        RepFooter(suc,err, cntrec);
        SetOutput( NULL, true ); //è®Ë•¨ ´Æ£ ¢ ‰†©´. äÆ≠•Ê
        ViewFile( InfoLogFileName );
      end;
    end; 
  else
    msgbox("ì·‚†≠Æ¢™† Æ‚¨•≠•≠†."); 
  end;
End;

OpTransferRisk();