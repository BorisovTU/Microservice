/*
$Module:      Производные инструменты
$Description: Расчеты по производным инструментам на валютном рынке/рынке СПФИ. Шаг "Сводные проводки"
*/
  import "dv_carsm.mac",funk,fx_globals;
  record oper(dvoper);


macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )

  SetBuff(oper, FDoc);

  var FD_Oper = DVFirstDocOper(DL_DVOPER, oper);

  return nett(FD_Oper, doc, oper.Date);

  // return 0;

end;


MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -откат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */  

   var rs51,rs2,que,npack,da;

  SetBuff(oper, FirstDoc);
  da=DV_SDAT(oper.Date);
  npack=35;//((ID_Step*10000)+ID_Operation);

  if ( CommitOrRollback == 1 )
     if (kind_operation!=12602)
     que="select  b.t_paymentid FROM ddvndeal_dbt a  , dpmpaym_dbt b where a.t_netting='X' and a.t_contractor="+_NKC/*_BIR*/+" and  b.t_dockind=4813  and b.t_documentid=a.t_id  and b.t_numberpack=0 and b.t_paymstatus!= 32000  and b.t_valuedate='"+da+"'";
     rs51 = LnGetRecordSet(que);
     if(rs51 != null)
       while(rs51.moveNext())
         que="update  dpmpaym_dbt set t_paymstatus=32000 , t_numberpack="+npack+"  where t_paymentid ="+ rs51.value(0);
         rs2 = LnGetRecordSet(que);
       end;
     end;
     end;
  elif ( CommitOrRollback == 2 )
    if (kind_operation!=12602)
     que="select  b.t_paymentid FROM ddvndeal_dbt a  , dpmpaym_dbt b where a.t_netting='X' and a.t_contractor="+_NKC/*_BIR*/+" and  b.t_dockind=4813  and b.t_documentid=a.t_id  and b.t_numberpack="+npack+" and b.t_paymstatus = 32000  and b.t_valuedate='"+da+"'";
     rs51 = LnGetRecordSet(que);
     if(rs51 != null)
       while(rs51.moveNext())
         que="update  dpmpaym_dbt set t_paymstatus=1000 , t_numberpack=0  where t_paymentid ="+ rs51.value(0);
         rs2 = LnGetRecordSet(que);
       end;
     end;
    else
    //teg сменим статус
     que=" update DSTD_BSKOM_DBT set t_status=0   where t_status=1  and t_vdate="+GetSQLDate(oper.Date);
     rs51 = LnGetRecordSet(que);
    end;
  end;
  

  return 0;
END;
