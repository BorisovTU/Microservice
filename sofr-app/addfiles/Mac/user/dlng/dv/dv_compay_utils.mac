import OprInter, globals, likepy, cb_sql, DVInter, dlmisc, dv_car, dv_compay_carry, DebtSumOp_Common;

CONST DVCOMPAY_BEGDATE_FIND = date(01,11,2021);

macro DVComPayFindAndInsert(_begdate, _clientid, _oldcalcid)
  var begDate = null;
  var clientId = null;
  if (ValType(_clientid) == V_INTEGER)
    clientId = _clientid;
  end;
  if (ValType(_begdate) == V_DATE)
    begDate = _begdate;
  end;
  if ((clientId == null) and (begDate == null))
    begDate = DVCOMPAY_BEGDATE_FIND;
    if (not getDate(begDate,"Введите начало период поиска неоплаченных требований:"))
      return null;
    end;
  elif (clientId != null)
    //если передан clientId то значит мы хотим получить обновленные данные по этому договору и перерисовать в текущем скроллинге
    var rsBegDate =
      ExecSQLSelect("select T_BEGDATE from U_COMPAY_DBT where t_clientid = ? and T_CALCID = ?",
                     MakeArray(SQLParam("clientId", clientId), SQLParam("calcid", _oldcalcid)), false);
    if (rsBegDate.MoveNext())
      begDate = SQL_ConvTypeDate(rsBegDate.value("t_BegDate"));
    end;
  end;
  var query = 
    " DECLARE "
   +"    v_newCalcId   NUMBER (30); "
   +"    v_newCalcDate DATE := TRUNC (SYSDATE); "
   +" BEGIN "
   +"    SELECT U_COMPAY_DBT_SEQ_CALCID.NEXTVAL INTO v_newCalcId FROM DUAL; "
   /*строка для случая если основной запрос ничего не вернёт, тогда max(t_calcid) поменяется*/
   +"    INSERT INTO U_COMPAY_DBT (t_calcid, t_calcdate) values (v_newCalcId, v_newCalcDate); "
   +"  "
   +"    INSERT INTO U_COMPAY_DBT (t_calcid, "
   +"                              t_begdate, "
   +"                              t_calcdate, "
   +"                              t_ekk, "
   +"                              t_dlcontrid, "
   +"                              t_sfcontrid, "
   +"                              t_clientid, "
   +"                              t_dealid,"
   +"                              t_dockind,"
   +"                              t_fiid,"
   +"                              t_number, "
   +"                              t_contrDate, "
   +"                              t_clientname, "
   +"                              t_sum, "
   +"                              t_reqSum, "
   +"                              t_payed_pm, "
   +"                              t_payed_tr, "
   +"                              t_acc306, "
   +"                              t_rest306, "
   +"                              t_acc47423, "
   +"                              t_rest47423, "
   +"                              t_acc458, "
   +"                              t_rest458, "
   +"                              t_acc306_outmarket, "
   +"                              t_rest306_outmarket, "
   +"                              t_minlim, "
   +"                              t_sysdate) "
   +"       SELECT v_newCalcId, "
   +"              ?, "
   +"              v_newCalcDate, "
   +"              mainQ1.t_ekk, "
   +"              mainQ1.t_dlcontrid, "
   +"              mainQ1.t_sfcontrid, "
   +"              mainQ1.t_partyid, "
   +"              mainQ1.t_dealid, "
   +"              mainQ1.t_dockind, "
   +"              mainQ1.T_FIID_COMM, "
   +"              mainQ1.T_NUMBER, "
   +"              mainQ1.t_contrDate, "
   +"              mainQ1.T_SHORTNAME, "
   +"              mainQ1.T_SUM, "
   +"              mainQ1.T_SUM - mainQ1.T_PAYED_PM AS t_reqsum, "
   +"              mainQ1.T_PAYED_PM, "
   +"              mainQ1.T_PAYED_TR, "
   +"              mainQ1.T_ACC306, "
   +"              mainQ1.T_REST306, "
   +"              mainQ1.T_ACC47423, "
   +"              mainQ1.t_rest47423, "
   +"              mainQ1.t_acc458, "
   +"              mainQ1.t_rest458, "
   +"              mainQ1.t_acc306_outmarket, "
   +"              mainQ1.t_rest306_outmarket, "
   +"              NULL, "
   +"              TRUNC (SYSDATE) "
   +"         FROM (SELECT dlcontr.t_dlcontrid, "
   +"                      dlcontr.t_sfcontrid, "
   +"                      q2.t_dealid, "
   +"                      q2.t_dockind, "
   +"                      dsfcontr.t_partyid, "
   +"                      dsfcontr_main.t_number AS t_number, "
   +"                      dsfcontr_main.t_datebegin as t_contrDate, "
   +"                      party.t_shortname, "
   +"                      (select dob.t_code "
   +"                         from ddlobjcode_dbt dob "
   +"                        where dob.t_codekind = 1 "
   +"                          and dob.t_objecttype = 207 "
   +"                          and dob.t_bankclosedate = TO_DATE('01.01.0001', 'DD.MM.YYYY') "
   +"                          and dob.t_objectid = dlcontr.t_dlcontrid) as t_ekk, "
   +"                      q2.t_comsum AS t_sum, "
   +"                      q2.t_payed_pm, "
   +"                      q2.T_FIID_COMM, "
   +"                      NVL (q2.t_acc306, 'Cчет не найден') "
   +"                         AS t_acc306, "
   +"                      NVL (q2.t_acc47423, 'Cчет не найден') "
   +"                         AS t_acc47423, "
   +"                      NVL (q2.t_acc458, 'Cчет не найден') "
   +"                         AS t_acc458, "
   +"                      NVL (q2.t_acc306_outmarket, 'Cчет не найден') "
   +"                         AS t_acc306_outmarket, "
   +"                      NVL ( "
   +"                         (SELECT SUM (tr.t_sum_payer) "
   +"                            FROM dacctrn_dbt tr "
   +"                           WHERE (tr.t_account_payer = q2.t_acc306 "
   +"                                  OR tr.t_account_payer = q2.t_acc306_outmarket) "
   +"                                 AND tr.t_date_carry >= ? "
   +"                                 AND tr.t_account_receiver like '458%' "
   +"                                 AND (tr.t_ground LIKE "
   +"                                         'Оплата комиссии по сделк%' "
   +"                                      OR tr.t_ground LIKE "
   +"                                            'Оплаты комиссии по сделк%') "
   +"                                 AND NOT EXISTS "
   +"                                            (SELECT 1 "
   +"                                               FROM doprdocs_dbt oprdocs "
   +"                                              WHERE oprdocs.t_acctrnid = "
   +"                                                       tr.t_acctrnid) "
   +"                                 AND NOT EXISTS "
   +"                                        (SELECT 1 "
   +"                                           FROM U_COMPAY_TR_DBT comTrn "
   +"                                          WHERE comTrn.t_acctrnid = tr.t_acctrnid)), "
   +"                         0) "
   +"                         AS t_payed_tr, "
   +"                      rsb_account.restac (q2.t_acc306, "
   +"                                          q2.T_FIID_COMM, "
   +"                                          SYSDATE, "
   +"                                          1, "
   +"                                          NULL) "
   +"                         AS t_rest306, "
   +"                      rsb_account.restac (q2.t_acc47423, "
   +"                                          q2.T_FIID_COMM, "
   +"                                          SYSDATE, "
   +"                                          1, "
   +"                                          NULL) "
   +"                         AS t_rest47423, "
   +"                      rsb_account.restac (q2.t_acc458, "
   +"                                          q2.T_FIID_COMM, "
   +"                                          SYSDATE, "
   +"                                          1, "
   +"                                          NULL) "
   +"                         AS t_rest458, "
   +"                      rsb_account.restac (q2.t_acc306_outmarket, "
   +"                                          q2.T_FIID_COMM, "
   +"                                          SYSDATE, "
   +"                                          1, "
   +"                                          NULL) "
   +"                         AS t_rest306_outmarket "
   +"                 FROM (SELECT q1.*, "
   +"                              (SELECT NVL (SUM (pm.t_amount), 0) "
   +"                                 FROM dpmpaym_dbt pm "
   +"                                WHERE     pm.t_dockind = q1.t_dockind "
   +"                                      AND pm.t_documentid = q1.t_dealid "
   +"                                      AND pm.t_purpose = 72 "
   +"                                      AND pm.t_payer = q1.t_client "
   +"                                      AND pm.t_fiid = q1.T_FIID_COMM) "
   +"                                 AS t_payed_pm, "
   +"                              (SELECT       /*+index(dmac DMCACCDOC_DBT_USR5)*/ "
   +"                                     dmac.t_account "
   +"                                 FROM dmcaccdoc_dbt dmac "
   +"                                WHERE     dmac.t_catid = 70 "
   +"                                      AND dmac.t_iscommon = CHR (88) "
   +"                                      AND dmac.t_owner = q1.t_client "
   +"                                      AND dmac.t_clientcontrid = q1.T_CLIENTCONTR "
   +"                                      AND dmac.t_currency = q1.T_FIID_COMM "
   +"                                      AND ROWNUM = 1) "
   +"                                 AS t_acc306, "
   +"                              (SELECT       /*+index(dmac DMCACCDOC_DBT_USR5)*/ "
   +"                                     dmac.t_account "
   +"                                 FROM dmcaccdoc_dbt dmac "
   +"                                WHERE     dmac.t_catid = 818 "
   +"                                      AND dmac.t_iscommon = CHR (88) "
   +"                                      AND dmac.t_owner = q1.t_client "
   +"                                      AND dmac.t_clientcontrid = q1.T_CLIENTCONTR "
   +"                                      AND dmac.t_currency = q1.T_FIID_COMM "
   +"                                      AND ROWNUM = 1) "
   +"                                 AS t_acc47423, "
   +"                              (SELECT       /*+index(dmac DMCACCDOC_DBT_USR5)*/ "
   +"                                     dmac.t_account "
   +"                                 FROM dmcaccdoc_dbt dmac "
   +"                                WHERE     dmac.t_catid = (SELECT t_ID FROM dmccateg_dbt WHERE t_LevelType = 1 AND t_Code = 'Треб. с н.с. брок') "
   +"                                      AND dmac.t_iscommon = CHR (88) "
   +"                                      AND dmac.t_owner = q1.t_client "
   +"                                      AND dmac.t_clientcontrid = q1.T_CLIENTCONTR "
   +"                                      AND dmac.t_currency = q1.T_FIID_COMM "
   +"                                      AND ROWNUM = 1) "
   +"                                 AS t_acc458, "
   +"                              (SELECT       /*+index(dmac DMCACCDOC_DBT_USR5)*/ "
   +"                                     dmac.t_account "
   +"                                 FROM dmcaccdoc_dbt dmac, ddlcontrmp_dbt mp, ddlcontrmp_dbt mp1, dsfcontr_dbt sf "
   +"                                WHERE     dmac.t_catid = (SELECT t_ID FROM dmccateg_dbt WHERE t_LevelType = 1 AND t_Code = 'ДС клиента, ц/б') "
   +"                                      AND dmac.t_iscommon = CHR (88) "
   +"                                      AND dmac.t_owner = q1.t_client "
   +"                                      AND dmac.t_clientcontrid = sf.t_id "
   +"                                      AND dmac.t_currency = q1.T_FIID_COMM "
   +"                                      AND mp.t_sfcontrid = q1.T_CLIENTCONTR " 
   +"                                      AND mp1.t_dlcontrid = mp.t_dlcontrid " 
   +"                                      AND sf.t_id = mp1.t_sfcontrid "
   +"                                      AND sf.t_servkindsub = 9 "
   +"                                      AND sf.t_dateclose = to_date('01010001', 'ddmmyyyy') "
   +"                                      AND ROWNUM = 1) "
   +"                                 AS t_acc306_outmarket "
   +"                         FROM (  SELECT /*+index(comm DDLCOMIS_DBT_IDX1) index(sfc DSFCOMISS_DBT_IDX0) index(ndeal DDVNDEAL_DBT_IDX6) */ "
   +"                                        ndeal.t_id AS t_dealid, "
   +"                                        ndeal.t_dockind, "
   +"                                        ndeal.t_client, "
   +"                                        ndeal.T_CLIENTCONTR, "
   +"                                        sfc.T_FIID_COMM, "
   +"                                        SUM (comm.T_SUM) AS t_comsum "
   +"                                   FROM ddvndeal_dbt ndeal, "
   +"                                        ddlcomis_dbt comm, "
   +"                                        dsfcomiss_dbt sfc "
   +"                                  WHERE ndeal.t_dockind IN ("+DL_DVFXDEAL+", "+DL_DVNDEAL+") "
   +"                                        AND ndeal.t_date >= ? "
   +"                                        AND ndeal.t_state = " + DVDEAL_CLOSE
   +"                                        AND comm.t_docid = ndeal.t_id "
   +"                                        AND comm.t_dockind = ndeal.t_dockind "
   +"                                        AND comm.t_isbankexpenses <> CHR (88) "
   +"                                        AND comm.T_CLIENTCONTRID > 0 "
   +"                                        AND sfc.t_number = comm.t_comnumber "
   +"                                        AND sfc.T_FEETYPE = comm.T_FEETYPE "
   +"                                        AND sfc.t_receiverid IN "
   +"                                               (SELECT d.t_PartyID "
   +"                                                  FROM ddp_dep_dbt d) "
   +"                               GROUP BY ndeal.t_id, "
   +"                                        ndeal.t_dockind, "
   +"                                        ndeal.t_client, "
   +"                                        ndeal.T_CLIENTCONTR, "
   +"                                        sfc.T_FIID_COMM) q1 "
   +"                        WHERE "
   //если clientId == null, то как обычно ищем только с неоплаченными требованиями
   //если же clientId != null, то перерисовываем все данные по clientId
   +IIF(clientId == null, 
        " q1.t_comsum > "
       +" (SELECT NVL (SUM (pm.t_amount), 0) "
       +"    FROM dpmpaym_dbt pm "
       +"   WHERE     pm.t_dockind = q1.t_dockind "
       +"         AND pm.t_documentid = q1.t_dealid "
       +"         AND pm.t_purpose = 72 "
       +"         AND pm.t_payer = q1.t_client "
       +"         AND pm.t_fiid = q1.T_FIID_COMM) ",
       "q1.t_client = " + string(clientId))
   +") q2,"
   +"                      ddlcontrmp_dbt mpcontr, "
   +"                      dsfcontr_dbt dsfcontr, "
   +"                      ddlcontr_dbt dlcontr, "
   +"                      dsfcontr_dbt dsfcontr_main, "
   +"                      dparty_dbt party "
   +"                WHERE     mpcontr.T_SFCONTRID = q2.T_CLIENTCONTR "
   +"                      AND DSFCONTR.T_ID = MPCONTR.T_SFCONTRID "
   +"                      AND DLCONTR.T_DLCONTRID = MPCONTR.T_DLCONTRID "
   +"                      AND DSFCONTR_MAIN.T_ID = DLCONTR.T_SFCONTRID "
   +"                      AND PARTY.T_PARTYID = DSFCONTR_MAIN.T_PARTYID) mainQ1; "
   +"   :p_newCalcID := v_newCalcId; "
   +"   :P_newCalcDate := v_newCalcDate; "
   +" END; ";
  var cmd = RSDCommand(query);
  cmd.AddParam("p_begDate1", RSDBP_IN, begDate);
  cmd.AddParam("p_begDate2", RSDBP_IN, begDate);
  cmd.AddParam("p_begDate3", RSDBP_IN, begDate);
  cmd.AddParam("p_newCalcID", RSDBP_OUT, V_INTEGER);
  cmd.AddParam("p_newCalcDate", RSDBP_OUT, V_DATE);
  BegAction(2000, "Поиск и построение неоплаченных требований", false);
  cmd.execute();
  EndAction();
  return DL_KeyPair(SQL_ConvTypeInteger(cmd.Value("p_newCalcID")), SQL_ConvTypeDate(cmd.Value("p_newCalcDate")));
end;

macro DVComPayGetMaxCalcIdAndDate()
  var cmd = DL_RSDCommand("select t_calcdate, t_calcid from U_COMPAY_DBT where t_calcid = "
                         +"(select max(t_calcid) from U_COMPAY_DBT)");
  var dataSet = cmd.Execute();
  if (dataSet.MoveNext())
    return DL_KeyPair(SQL_ConvTypeInteger(dataSet.CalcId),SQL_ConvTypeDate(dataSet.CalcDate));
  end;
  return null;
end;




class DVComPayScrollBase()
  var Columns = TArray();
  var rs = null;
  var NumColumns = 0;

  /* атрибуты полей */
  macro AddColumn( ind, fld, head, width )
     Columns.value( ind * 6 + 0 ) = fld;  // fieldName
     Columns.value( ind * 6 + 1 ) = head; // header 
     Columns.value( ind * 6 + 2 ) = width; // width
     Columns.value( ind * 6 + 3 ) = 2;    // fldType (2 = FBT)
     Columns.value( ind * 6 + 4 ) = null; // decPoint
     Columns.value( ind * 6 + 5 ) = 0;    // reserv
     NumColumns = NumColumns + 1;
  end;

  macro BuildSQL()
    return "";
  end;

  macro BuildRS()
    return null;
  end;
end;

macro DVComPayGenerateFD(DocKind,ID)
  var retFD = NULL;
  var className = "";
  if ( (DocKind == DL_DVNDEAL) or 
       (DocKind == DL_DVDEALT3) or
       (DocKind == DL_DVFXDEAL) or
       (DocKind == DL_DVOPER) or
       (DocKind == DL_DVCURMARKET) or
       (DocKind == DL_SETTLEMENTFCURM))
    className = "DVFirstDocNDeal";
    if (DocKind == DL_DVFXDEAL)
      className = "DVFirstDocFXDeal";
    elif (DocKind == DL_DVOPER)
      className = "DVFirstDocOper";
    elif ((DocKind == DL_DVCURMARKET) or (DocKind == DL_SETTLEMENTFCURM))
      className = "DVFirstDocDLCOMM";
    end;
    retFD = GenObject ( className, DocKind, ID);
  end;
  return retFD;
end;

macro DVComPayGetOperationId (dealId, docKind, operKind)
  var sql = " select t_id_operation from dOprOper_dbt where t_kind_operation = :operKind and t_docKind = :docKind and lpad(:dealId, 34, '0') = t_documentId ";
  var params = MakeArray(SQLParam("operKind", operKind), SQLParam("docKind", docKind), SQLParam("dealId", dealId)); 
  var rs = ExecSQLSelect(sql, params, false);
 
  if(not rs.MoveNext())
    RunError("Не найден id операции по сделке "+dealId);
    return -1;
  end;

  return SQL_ConvTypeInteger(rs.value("t_id_operation"));
end;

macro DVComPayCheckCarryExists (accountPayer, accountReceiver, sum, fiid)
  var sql = 
    "SELECT 1 "
   +"  FROM DUAL "
   +" WHERE EXISTS "
   +"          (SELECT 1 "
   +"             FROM dacctrn_dbt "
   +"            WHERE     t_account_payer = ? "
   +"                  AND t_account_receiver = ? "
   +"                  AND t_sum_payer = ? "
   +"                  AND T_FIID_PAYER = ?) ";
  var params = MakeArray(
    SQLParam("accountPayer", accountPayer),
    SQLParam("accountReceiver", accountReceiver),
    SQLParam("sum", sum),
    SQLParam("fiid", fiid)
  ); 
  var rs = ExecSQLSelect(sql, params, false);

  return rs.MoveNext() == true;
end;

macro DVComPayGetTrnDate (accTrnId)
  var rsOprDate = ExecSQLSelect("select T_DATE_CARRY from dacctrn_dbt where t_acctrnid = ?",
                                MakeArray(SQLParam("acctrnid", accTrnId)), false);
  if (rsOprDate.MoveNext())
    return SQL_ConvTypeDate(rsOprDate.value("T_DATE_CARRY"));
  end;
  return date(0,0,0);
end;

macro DVComPayUpdateCalcIdByNewCalc(newCalcId, oldCalcId, clientId)
  var query =
    " UPDATE U_COMPAY_DBT t1 "
   +"    SET (t1.T_SUM, "
   +"         t1.T_REQSUM, "
   +"         t1.T_PAYED_PM, "
   +"         t1.T_PAYED_TR, "
   +"         t1.T_REST306, "
   +"         t1.T_REST47423, "
   +"         t1.T_REST458, "
   +"         t1.T_REST306_OUTMARKET) = "
   +"           (SELECT t2.T_SUM, "
   +"                   t2.T_REQSUM, "
   +"                   t2.T_PAYED_PM, "
   +"                   t2.T_PAYED_TR, "
   +"                   t2.T_REST306, "
   +"                   t2.T_REST47423, "
   +"                   t2.T_REST458, "
   +"                   t2.T_REST306_OUTMARKET "
   +"              FROM U_COMPAY_DBT t2 "
   +"             WHERE     t2.T_CALCID = ? "
   +"                   AND t1.T_EKK = t2.T_EKK "
   +"                   AND t1.T_DLCONTRID = t2.T_DLCONTRID "
   +"                   AND t1.T_SFCONTRID = t2.T_SFCONTRID "
   +"                   AND t1.T_CLIENTID = t2.T_CLIENTID "
   +"                   AND t1.T_DEALID = t2.T_DEALID "
   +"                   AND t1.T_DOCKIND = t2.T_DOCKIND) "
   +"  WHERE t1.T_CALCID = ? AND T_CLIENTID = ? ";
  var cmd = RSDCommand(query);
  cmd.addParam("", RSDBP_IN, newCalcId);
  cmd.addParam("", RSDBP_IN, oldCalcId);
  cmd.addParam("", RSDBP_IN, clientId);
  cmd.execute();
end;

macro DVComPayDeleteCalcId(calcId)
  var query = " delete from U_COMPAY_DBT where t_calcId = ? ";
  var cmd = RSDCommand(query);
  cmd.addParam("", RSDBP_IN, calcId);
  cmd.execute();
end;

macro DVComPayMakeTrnLinkId(ID_Operation, StepSymb, TrnId)
  var query =
    " INSERT INTO doprdocs_dbt (T_DOCKIND, "
   +"                           T_DOCUMENTID, "
   +"                           T_ID_OPERATION, "
   +"                           T_ID_STEP, "
   +"                           T_PART, "
   +"                           T_STATUS, "
   +"                           T_ORIGIN, "
   +"                           T_SERVDOCKIND, "
   +"                           T_SERVDOCID, "
   +"                           T_ACCTRNID) "
   +"      VALUES (1, "
   +"              CHR (1), "
   +"              ?, "
   +"(SELECT T_ID_STEP "
   +"   FROM DOPRSTEP_DBT step "
   +"  WHERE STEP.T_ID_OPERATION = ? AND STEP.T_SYMBOL = ? AND ROWNUM = 1), "
   +"              1, "
   +"              0, "
   +"              0, "
   +"              0, "
   +"              0, "
   +"              ?); ";
  var cmd = RSDCommand(query);
  cmd.addParam("", RSDBP_IN, ID_Operation);
  cmd.addParam("", RSDBP_IN, ID_Operation);
  cmd.addParam("", RSDBP_IN, StepSymb);
  cmd.addParam("", RSDBP_IN, TrnId);
  cmd.execute();
end;


Macro DVComPayShowError(errObj)
  ErrorMessage(errObj);
  if(GetDialogFlag())
    var errMes = GetErrMsg();
    if ((ValType(errMes) == V_STRING) and (errMes != ""))
      MsgBox(errMes);
    end;
  end;
end;

Macro DVComPayCreatePaymentAndTrnAndGetFD(_DealDate, _DealCode, _ClientId, _DocKind, _ID, _Amount, _FiidCom, _boTrnId, _AccountCFT, _CarryDate)
  var ClientAcc306 = TRecHandler("account");
  var ClientAcc458 = TRecHandler("account");
  var DebAccBY = TRecHandler("account");
  var KredAccBY = TRecHandler("account");
  var trnId = 0;

  var FD, Ground, GroundBY, PaymentObj:RsbPayment;
  var StepSymb = "";

  var AccTrnId = 0, InAccTrnId = 0, PaymentId = 0;

  //если существует boTrnId, то значит мы досоздаём проводку ВУ и платеж
  //т.е. проводку БУ создавать не надо
  var boTrnId = IIF(ValType(_boTrnId) != V_INTEGER, null, _boTrnId);

  var AccountCFT = IIF(ValType(_AccountCFT) != V_STRING, null, _AccountCFT);
  var CarryDate = IIF(ValType(_CarryDate) != V_DATE, null, _CarryDate);

  FD = DVComPayGenerateFD(_DocKind, _ID);

  if (IsEqClass("DVFirstDocNDeal", FD))
    StepSymb = "т"
  elif (IsEqClass("DVFirstDocFXDeal", FD))
    StepSymb = "Т"
  end;

  var idOperation = DVComPayGetOperationId(_ID, _DocKind, FD.Kind_Operation());

  var oprDate = {curdate};
  var Amount = _Amount;
  var Fiid = _FiidCom;
  var ClientName = "";

  //если boTrnId существует, то дата платежа должна быть равна дате проводки
  if (boTrnId != null)
    oprDate = DVComPayGetTrnDate(boTrnId);
  elif (CarryDate != null)
    oprDate = CarryDate;
  end;

  var Client = TBfile("party.dbt");
  if(ПолучитьСубъекта(FD.Deal.rec.Client, Client) == 0)
    ClientName = client.rec.ShortName;
  end;

  if(AccountCFT != null)
    Ground = "Безакцептное списание задолженности по комиссии брокера, согласно п. 5.8 Регламента 15-Р. " +
             "по сделке № " + FD.DealCode() + " от " + string(FD.ДатаСделки():f) + 
             " Соглашение № " + FD.ClientDBOContrName() + " от " + string(FD.ClientDBOContrDate():f) + ". НДС не облагается.";
  else
    Ground = "Оплата комиссии по сделке "  + IIF(FD.Kind==DL_DVFXDEAL,"","СВОП ") + "N " + FD.DealCode() + 
             " в рамках Соглашения об оказании брокерских услуг N " + FD.ClientDBOContrName() + " от " + FD.ClientDBOContrDate() + ". Клиент - " + ClientName;
  end; 

  var SubContrFD = DL_SubContrFD(FD.Deal.rec.ClientContr);

  if (not SubContrFD.OpenAccount( "ДС клиента, ц/б", NULL, NULL, ClientAcc306, oprDate, Fiid ))
    RunError("Ошибка получения счета денежных средств по сделке "+_ID);
  end;

  if(not OpenDebtAccount(SubContrFD, oprDate, Fiid, ClientAcc458))
    RunError("Ошибка получения счета по категории \"Треб. с н.с. брок\" по сделке "+_ID);
  end;

  if( DVND_CreatePayment( FD, PM_PURP_COMMBANK, FD.Kind, FD.ID,
                          oprDate,
                          IIF(FD.IsClient(), FD.Deal.rec.Client, {ourbank}), {ourbank},
                          {ourbank}, {ourbank},
                          Amount, Fiid,
                          Ground,
                          ClientAcc306, ClientAcc458,
                          FD.Deal.rec.Department, NULL, NULL,
                          @PaymentObj
                        ) != 0
    )
    RunError("Ошибка создания платежа по сделке "+_ID);
  end;

  trnId = 0;

  //только если не передана проводка БУ
  if (boTrnId == null)
    if( not DVComPayCarryOnPayment(FD, PaymentObj, @trnId, AccountCFT) )
      RunError("Ошибка выполнения проводки по платежу по сделке "+_ID);
    end;
    AccTrnId = trnId;
  else
    AccTrnId = boTrnId;
  end;
  if( trnId > 0)
    DVComPayMakeTrnLinkId(idOperation, StepSymb, trnId);
  end;

  if( ПИ_ИсполнитьПлатеж(PaymentObj) )
    RunError("Ошибка исполнения платежа по сделке "+_ID);
  end;

  PaymentObj.Update();

  PaymentId = PaymentObj.PaymentID;

  if( ПИ_ВестиВнутреннийУчет() and (boTrnId == null) and (AccountCFT == null))
    GroundBY = FD.ВУ_ОснованиеПроводки(8, false);

    if( not FD.OpenAccount(FD.ВУ_ПолучитьКатегориюДебет(8, false), null, null, FD.ВУ_ПолучитьРольФИ(8, true, false), DebAccBY, oprDate, Fiid) )
       RunError("Ошибка получения счета ВУ по сделке "+_ID);
    end;
    if( not FD.OpenAccount(FD.ВУ_ПолучитьКатегориюКредит(8, false), null, null, FD.ВУ_ПолучитьРольФИ(8, true, false), KredAccBY, oprDate, Fiid) ) 
       RunError("Ошибка получения счета ВУ по сделке "+_ID);
    end;

    trnId = 0;
    if( (not DVComPayCarry( FD, 
                             DebAccBY, KredAccBY,
                             oprDate,
                             FD.ВУ_ОпределениеГлавы(Fiid),
                             Fiid,
                             Amount,
                             null, 
                             INPCARRY,
                             "",
                             "",
                             GroundBY,
                             0, null, null, @trnId,
                             Fiid, Fiid,
                             null, null, null, null,
                             true,
                             8
                           ))
      )
      RunError("Ошибка выполнения проводки ВУ по сделке "+_ID);
    end;
    DVComPayMakeTrnLinkId(idOperation, StepSymb, trnId);
    InAccTrnId = trnId;

  end;

  var query =
    " INSERT INTO U_COMPAY_TR_DBT ( "
    "    T_DEALID, T_DEALDATE, T_DEALCODE,  "
    "    T_CLIENTID, T_ACCOUNT_PAYER, T_ACCOUNT_RECEIVER,  "
    "    T_FIID, T_AMOUNT, T_ACCTRNID,  "
    "    T_INACCTRNID, T_PAYMENTID, T_OPER,  "
    "    T_SYSDATE)  "
    " VALUES (?,?,?,?,?,?,?,?,?,?,?,?,SYSDATE); ";
  execSql(
    query, 
    makeArray(
      SQLParam("dealId", _ID),
      SQLParam("dealDate", _DealDate),
      SQLParam("dealCode", _DealCode),
      SQLParam("clientId", _ClientId),
      SQLParam("accountPayer", IIF(AccountCFT != null, AccountCFT, ClientAcc306.rec.account)),
      SQLParam("accountReceiver", ClientAcc458.rec.account),
      SQLParam("fiid", Fiid),
      SQLParam("amount", Amount),
      SQLParam("accTrnId", AccTrnId),
      SQLParam("inAccTrnId", InAccTrnId),
      SQLParam("paymentId", PaymentId),
      SQLParam("oper", {Oper})
    ),
    true
  );

  return FD;
end;