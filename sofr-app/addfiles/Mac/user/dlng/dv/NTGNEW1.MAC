/*PNV за такой макрос нужно руки оторвать, знать бы еще кому...
За селекты в одну строчку, за непараметризованные запросы, за забитые "гвоздями" схемы расчетов, за полное отсутствие знаний функционала ФИССиКО, за Tab-ы
Для работы с платежами есть RsbPayment!!
i-support 503559 - макрос "причесан", исправлен алгоритм отбора платежей*/

IMPORT funk, dl_plib, fx_globals, dv_lib;
IMPORT "gtconst.inc", dlref, dealInfo;

PRIVATE VAR j, ii2, es0, zz, xx, jk2, bb, fet = " ", var0, ES, vsd, Comment, mm, partyid, kk = 0, i, ii, su, rs0, val, 
            {curdate}, dat, nettDate, rs, jj = 0, que, spartyid, payer, receiver, baseamount, dealcode;
ARRAY mmas, mmas0, mmas2, mmas1, mmas3, mmas4, masi, masiv, mab, ma;

MACRO kol_nett(da)
 PRIVATE VAR ij, rs11, que, rs10, rez, koli, nda, sda, koko;
 sda = СДАТ(da);   
 nda = substr(sda, 9, 2) + substr(sda, 4, 2) + substr(sda, 1, 2);
 rez = "NETT";
 que = "select count(*) from ddl_nett_dbt where T_SIGNINGDATE = '" + sda + "'";
 ES = que;
 rs10 = LnGetRecordset(que);
 if(rs10 != null)
    if (rs10.moveNext) 
        koli = rs10.value(0);
        rez = substr(string(1001 + int(koli)),2);
        rez = "NETT" + rez + "/" + nda;
        ij = 0;

        while (ij < 4 )
               que = "select count(*) from ddl_nett_dbt where t_dealnumber = '" + rez + "'";
               rs11 = LnGetRecordset(que);
               if(rs11 != null)
                  if (rs11.moveNext) 
                      koko = rs11.value(0);
                  end;
               end;
               if (koko > 0)
                   koli = koli + 1;
                   rez = substr(string(1001 + int(koli)),2);
                   rez = "NETT" + rez + "/" + nda;
               else
                   ij = 5;
               end;
               ij = ij + 1;
        end;
    end;
 end;
 return rez;
END;

MACRO SDEL(S,KS)
  PRIVATE VAR SW = "                                                                                                      ";
  S = SUBSTR(S + SW, 1, KS);
  RETURN(S);
END;

MACRO Corr_sx(pa1)
   private var que, rs10, rez = 0;
   que="select c.t_number from dsettacc_dbt a, dpmautoac_dbt b , dcorschem_dbt c WHERE  rownum = 1 and b.t_fikind = 1 and b.t_servicekind = 2 and a.T_SETTACCID = b.T_SETTACCID and a.T_partyid = 1  and a.t_fiid = " + pa1 + "  and c.t_fiid = a.t_fiid and c.t_corrid = a.t_bankid ";
   rs10 = LnGetRecordset(que);
   if(rs10 != null)
     if (rs10.moveNext) 
       rez = rs10.value(0);
     end;
   end;
   return rez;
END;

// Функция вставки сделки НЕТТИНГА
//
MACRO CreateNewNett_old()
   var forexdeal = Tbfile( "dl_nett.dbt", "W" );
   var pmlink    = Tbfile( "pmlink.dbt", "W" );
   var spdrprop  = Tbfile( "spdrprop.dbt", "W" );
   var pmlink2    = Tbfile( "pmlink.dbt", "W" );
   var spdrprop2  = Tbfile( "spdrprop.dbt", "W" );
   var pmlink3    = Tbfile( "pmlink.dbt", "W" );
   var spdrprop3  = Tbfile( "spdrprop.dbt", "W" );
   var pmlink4    = Tbfile( "pmlink.dbt", "W" );
   var spdrprop4  = Tbfile( "spdrprop.dbt", "W" );



   var paym      = Tbfile( "pmpaym.dbt", "W" );
   var paymprop  = Tbfile( "pmprop.dbt", "W" );
   var pmrmprop  = Tbfile( "pmrmprop.dbt", "W" );

   var paym2      = Tbfile( "pmpaym.dbt", "W" );
   var paymprop2  = Tbfile( "pmprop.dbt", "W" );
   var pmrmprop2  = Tbfile( "pmrmprop.dbt", "W" );

   var paym3      = Tbfile( "pmpaym.dbt", "W" );
   var paymprop3  = Tbfile( "pmprop.dbt", "W" );
   var pmrmprop3  = Tbfile( "pmrmprop.dbt", "W" );

   var paym4      = Tbfile( "pmpaym.dbt", "W" );
   var paymprop4  = Tbfile( "pmprop.dbt", "W" );
   var pmrmprop4  = Tbfile( "pmrmprop.dbt", "W" );

   var type:integer;
   var stat = 0, refe, jk, valu, su;
   var Payercodekind, ReceiverCodeKind; 

  if(GenerateReference(53, refe) != 0)
    msgbox("Ошибка при генерации референса");
  end;

  forexdeal.rec.DOCKIND = 140;
  forexdeal.rec.DEALNUMBER = kol_nett(Dat);  
  forexdeal.rec.SIGNINGDATE = Dat;    
  forexdeal.rec.REGISTERDATE = Dat;
  forexdeal.rec.ORIGIN = 0;
  forexdeal.rec.VALUEDATE = Dat;
  forexdeal.rec.CONTRACTOR = partyid;
  forexdeal.rec.COMMUNICATIONLINK = 0;
  forexdeal.rec.CONFIRMTRANSPORT = 2;
  forexdeal.rec.CONFIRMCODE = "";
  forexdeal.rec.CONFIRMDATE = Dat;
  forexdeal.rec.OPER = {oper};
  forexdeal.rec.DEPARTMENT = 1;
  forexdeal.rec.KIND_OPERATION = 11080;
  forexdeal.rec.STATUS = 10;
  forexdeal.rec.CLOSINGDATE = date("01.01.0001");
  forexdeal.rec.FI_KIND = 0; /*pnv было FI_KIND = 1 i-support 500881 в неттинге закрываются еще и металлы!!*/
  forexdeal.rec.BASEFIID = -1;
  forexdeal.rec.PAYFIID = -1;
  forexdeal.rec.EXTCODE = fet;
  forexdeal.rec.OVERTRANSITACCOUNT = "";
  forexdeal.rec.INCLUDEONEWAYPAYMENT = "";
  forexdeal.rec.RESERV = vsd;
  forexdeal.rec.IDENTPROGRAM = 12;
   
  //пытаемся вставить запись   
  stat = forexdeal.insert;
  if (not stat)
      RunError( "Ошибка при создании новой сделки." );
  end;

  //Сформируем платежи pmpaym.dbt
  jk = 1;
  jk2 = 0;
     
  su = (masi(jk));
  if (su == 0 )
      jk = jk + 1;    
      su = (masi(jk));
  end;

  if ( su < 0)
       RECEIVER = partyid;
       PAYER = _BANK0;
  else
       RECEIVER = _BANK0;
       PAYER = partyid;
  end;

  valu = masiv(jk);
  su = abs(masi(jk));

  paym.rec.DOCKIND = 140;
  paym.rec.DOCUMENTID = forexdeal.rec.NETTINGID;
  paym.rec.PURPOSE = 39;    
  paym.rec.SUBPURPOSE = jk2; 
  jk2 = jk2 + 1;
  paym.rec.FIID = valu;
  paym.rec.PAYFIID = valu;
  paym.rec.RECEIVER = RECEIVER;
  paym.rec.PAYER = PAYER;
  PayerCodeKind    = 6;
  ReceiverCodeKind = 6;

  paym.rec.PayerCode = ПолучитьКодСубъекта( paym.rec.Payer, PayerCodeKind );
  if(paym.rec.PayerCode == "")
     PayerCodeKind = 1;
     paym.rec.PayerCode = ПолучитьКодСубъекта( paym.rec.Payer, PayerCodeKind );
  end;
  paym.rec.RECEIVERCODE = ПолучитьКодСубъекта( paym.rec.RECEIVER, ReceiverCodeKind );
  if(paym.rec.RECEIVERCODE == "")
     ReceiverCodeKind = 1;
     paym.rec.RECEIVERCODE = ПолучитьКодСубъекта( paym.rec.RECEIVER, ReceiverCodeKind );
  end;
        
  paym.rec.PAYERBANKID = {OurBank};
  paym.rec.RECEIVERBANKID = {OurBank};     
  paym.rec.VALUEDATE = Dat;
    
  paym.rec.DEPARTMENT = {NumDprt};
  paym.rec.CHAPTER = 1;
  paym.rec.ISPLANPAYM = "X";
  paym.rec.PAYERCODEKIND = PayerCodeKind;
  paym.rec.RECEIVERCODEKIND = ReceiverCodeKind;
  paym.rec.FIID_FUTUREPAYACC = valu;
  paym.rec.FIID_FUTURERECACC = valu;
  paym.rec.BASEAMOUNT = su;
  paym.rec.orderamount = su;
  paym.rec.AMOUNT = paym.rec.BASEAMOUNT;
  paym.rec.payamount = paym.rec.BASEAMOUNT;
  paym.rec.BASEFIID = valu;
  paym.rec.ORDERFIID = valu;
  paym.rec.PAYERDPBLOCK = -1;
  paym.rec.RECEIVERDPBLOCK = -1;
  paym.rec.OPER = {oper};
  paym.rec.ORIGIN = 3;
  paym.rec.STARTDEPARTMENT = {NumDprt};
  paym.rec.ENDDEPARTMENT = {NumDprt};
  paym.rec.PRIMDOCKIND = 140;
  paym.rec.COMISSFIID = -1;
  paym.rec.NETTING  = "";
  stat = paym.insert;
  if (not stat)
      RunError( "Ошибка при создании новой сделки." );
  end;

  //debet
  paymprop.rec.PAYMENTID = paym.rec.PAYMENTID;
  paymprop.rec.DEBETCREDIT = 0;
  paymprop.rec.CODEKIND = 3;
  paymprop.rec.CODENAME = "БИК";
  paymprop.rec.BANKCODE = ПолучитьКодСубъекта( {OurBank}, 1 );
  paymprop.rec.CORSCHEM = -1;
  paymprop.rec.ISSENDER = "X";
  paymprop.rec.TRANSFERDATE = paym.rec.VALUEDATE;
  paymprop.rec.CORRID = -1;
  paymprop.rec.OURCORRID = -1;
  paymprop.rec.GROUP = 2;
  stat = paymprop.insert;
  if (not stat)
      RunError( "Ошибка при создании новой сделки." );
  end;
  //credit
  paymprop.rec.PAYMENTID = paym.rec.PAYMENTID ;
  paymprop.rec.DEBETCREDIT = 1;
  paymprop.rec.CODEKIND = 3;
  paymprop.rec.CODENAME = "БИК";
  paymprop.rec.BANKCODE = ПолучитьКодСубъекта( {OurBank}, 1 );
  paymprop.rec.ISSENDER = "";
  paymprop.rec.TRANSFERDATE = paym.rec.VALUEDATE;
  paymprop.rec.CORRID = -1;
  paymprop.rec.OURCORRID = -1;

  paymprop.rec.PAYFIID = valu; 
  paymprop.rec.CORSCHEM = Corr_sx(valu);
  paymprop.rec.TPID  = 2;
  paymprop.rec.GROUP = 1;
  paymprop.rec.TPSCHEMID = 51;
  paymprop.rec.RLSFORMID = 139;

  stat = paymprop.insert;
  if (not stat)
      RunError( "Ошибка при создании новой сделки." );
  end;

  //Реквизиты платежа         
  pmrmprop.rec.PAYMENTID = paym.rec.PAYMENTID ;
  pmrmprop.rec.NUMBER = 0;
  pmrmprop.rec.DATE = Dat;
  pmrmprop.rec.PAYMENTKIND = "Э";
  pmrmprop.rec.PAYERBANKNAME = NAMI ({OurBank});

  if (payer  != _BANK0 )
      pmrmprop.rec.PAYERNAME = NAMI (PARTYID);
      pmrmprop.rec.RECEIVERNAME = NAMI ({OurBank});
  elif (receiver != _BANK0 )
      pmrmprop.rec.PAYERNAME = NAMI ({OurBank});
      pmrmprop.rec.RECEIVERNAME = NAMI (PARTYID);
  end;            
  pmrmprop.rec.RECEIVERBANKNAME = pmrmprop.rec.PAYERBANKNAME;
  pmrmprop.rec.PAYDATE = Dat;
  pmrmprop.rec.CLIENTDATE = Dat;
  stat = pmrmprop.insert;
  if (not stat)
      RunError( "Ошибка при создании новой сделки." );
  end;

  pmlink.rec.LINKKIND = 1;
  pmlink.rec.INITIALPAYMENT = paym.rec.PAYMENTID;
  pmlink.rec.PURPOSEPAYMENT = paym.rec.PAYMENTID;
  pmlink.rec.FIID          = valu;
  pmlink.rec.AMOUNT        = su;
  pmlink.rec.IPSIGN        = "-";
  pmlink.rec.PPSIGN        = "-";
  pmlink.rec.DOCKIND       = 140;
  pmlink.rec.DOCUMENTID    = forexdeal.rec.NETTINGID;
  pmlink.rec.CONTRNVERSION = 0 ;
  pmlink.rec.RESERV        = " ";

  stat = pmlink.insert;
  if (not stat)
      RunError( "Ошибка при создании новой сделки." );
  end;
  jk = jk + 1;    

  //Сформируем платежи pmpaym2.dbt

  if ( jk < ii )  
       su = (masi(jk));
       if (su == 0 )
           jk = jk + 1;    
       end;

       if (( jk < ii ) and (masi(jk) != 0 )) 
             su = (masi(jk));
             if ( su < 0)
                  RECEIVER = partyid;
                  PAYER = _BANK0;
             else
                  RECEIVER = _BANK0;
                  PAYER = partyid;
             end;

             valu = masiv(jk);
             su = abs(masi(jk));

             paym2.rec.DOCKIND = 140;
             paym2.rec.DOCUMENTID = forexdeal.rec.NETTINGID;
             paym2.rec.PURPOSE = 39;    
             paym2.rec.SUBPURPOSE = jk2;    
             jk2 = jk2 + 1;

             paym2.rec.FIID = valu;
             paym2.rec.PAYFIID = valu;
             paym2.rec.RECEIVER = RECEIVER;
             paym2.rec.PAYER = PAYER;
             PayerCodeKind    = 6;
             ReceiverCodeKind = 6;

             paym2.rec.PayerCode = ПолучитьКодСубъекта( paym2.rec.Payer, PayerCodeKind );
             if(paym2.rec.PayerCode == "")
                PayerCodeKind = 1;
                paym2.rec.PayerCode = ПолучитьКодСубъекта( paym2.rec.Payer, PayerCodeKind );
             end;
             paym2.rec.RECEIVERCODE = ПолучитьКодСубъекта( paym2.rec.RECEIVER, ReceiverCodeKind );
             if(paym2.rec.RECEIVERCODE == "")
                ReceiverCodeKind = 1;
                paym2.rec.RECEIVERCODE = ПолучитьКодСубъекта( paym2.rec.RECEIVER, ReceiverCodeKind );
             end;
        
             paym2.rec.PAYERBANKID = {OurBank};
             paym2.rec.RECEIVERBANKID = {OurBank};
             paym2.rec.VALUEDATE = Dat;
    
             paym2.rec.DEPARTMENT = {NumDprt};
             paym2.rec.CHAPTER = 1;
             paym2.rec.ISPLANPAYM = "X";
             paym2.rec.PAYERCODEKIND = PayerCodeKind;
             paym2.rec.RECEIVERCODEKIND = ReceiverCodeKind;
             paym2.rec.FIID_FUTUREPAYACC = valu;
             paym2.rec.FIID_FUTURERECACC = valu;
             paym2.rec.BASEAMOUNT = su;
             paym2.rec.orderamount = su;
             paym2.rec.AMOUNT = paym2.rec.BASEAMOUNT;
             paym2.rec.payamount = paym2.rec.BASEAMOUNT;
             paym2.rec.BASEFIID = valu;
             paym2.rec.ORDERFIID = valu;

             paym2.rec.PAYERDPBLOCK = -1;
             paym2.rec.RECEIVERDPBLOCK = -1;
             paym2.rec.OPER = {oper};
             paym2.rec.ORIGIN = 3;
             paym2.rec.STARTDEPARTMENT = {NumDprt};
             paym2.rec.ENDDEPARTMENT = {NumDprt};
             paym2.rec.PRIMDOCKIND = 140;
             paym2.rec.COMISSFIID = -1;
             paym2.rec.NETTING  = "";
             stat = paym2.insert;
             if (not stat)
                RunError( "Ошибка при создании новой сделки." );
             end;

             //debet
             paymprop2.rec.PAYMENTID = paym2.rec.PAYMENTID;
             paymprop2.rec.DEBETCREDIT = 0;
             paymprop2.rec.CODEKIND = 3;
             paymprop2.rec.CODENAME = "БИК";
             paymprop2.rec.BANKCODE = ПолучитьКодСубъекта( {OurBank}, 1 );
             paymprop2.rec.CORSCHEM = -1;
             paymprop2.rec.ISSENDER = "X";
             paymprop2.rec.TRANSFERDATE = paym2.rec.VALUEDATE;
             paymprop2.rec.CORRID = -1;
             paymprop2.rec.OURCORRID = -1;
             paymprop2.rec.GROUP = 2;
             stat = paymprop2.insert;
             if (not stat)
                 RunError( "Ошибка при создании новой сделки." );
             end;
             //credit
             paymprop2.rec.PAYMENTID = paym2.rec.PAYMENTID ;
             paymprop2.rec.DEBETCREDIT = 1;
             paymprop2.rec.CODEKIND = 3;
             paymprop2.rec.CODENAME = "БИК";
             paymprop2.rec.BANKCODE = ПолучитьКодСубъекта( {OurBank}, 1 );
             paymprop2.rec.ISSENDER = "";
             paymprop2.rec.TRANSFERDATE = paym2.rec.VALUEDATE;
             paymprop2.rec.CORRID = -1;
             paymprop2.rec.OURCORRID = -1;

             paymprop2.rec.PAYFIID = valu; 
             paymprop2.rec.CORSCHEM = Corr_sx(valu);
             paymprop2.rec.TPID  = 2;
             paymprop2.rec.GROUP = 1;
             paymprop2.rec.TPSCHEMID = 51;
             paymprop2.rec.RLSFORMID = 139;
             stat = paymprop2.insert;
             if (not stat)
                 RunError( "Ошибка при создании новой сделки." );
             end;
             //Реквизиты платежа         
             pmrmprop2.rec.PAYMENTID = paym2.rec.PAYMENTID ;
             pmrmprop2.rec.NUMBER = 0;
             pmrmprop2.rec.DATE = Dat;
             pmrmprop2.rec.PAYMENTKIND = "Э";
             pmrmprop2.rec.PAYERBANKNAME = NAMI ({OurBank});
             if (payer  != _BANK0 )
                 pmrmprop2.rec.PAYERNAME = NAMI (PARTYID);
                 pmrmprop2.rec.RECEIVERNAME = NAMI ({OurBank});
             elif (receiver != _BANK0 )
                 pmrmprop2.rec.PAYERNAME = NAMI ({OurBank});
                 pmrmprop2.rec.RECEIVERNAME = NAMI (PARTYID);
             end;            
             pmrmprop2.rec.RECEIVERBANKNAME = pmrmprop2.rec.PAYERBANKNAME;
             pmrmprop2.rec.PAYDATE = Dat;
             pmrmprop2.rec.CLIENTDATE = Dat;
             stat = pmrmprop2.insert;
             if (not stat)
                 RunError( "Ошибка при создании новой сделки." );
             end;
             pmlink2.rec.LINKKIND =1;
             pmlink2.rec.INITIALPAYMENT = paym2.rec.PAYMENTID;
             pmlink2.rec.PURPOSEPAYMENT = paym2.rec.PAYMENTID;
             pmlink2.rec.FIID          = valu;
             pmlink2.rec.AMOUNT        = su;
             pmlink2.rec.IPSIGN        = "-";
             pmlink2.rec.PPSIGN        = "-";
             pmlink2.rec.DOCKIND       = 140;
             pmlink2.rec.DOCUMENTID    = forexdeal.rec.NETTINGID;
             pmlink2.rec.CONTRNVERSION = 0 ;
             pmlink2.rec.RESERV        = " ";
             stat = pmlink2.insert;
             if (not stat)
                RunError( "Ошибка при создании новой сделки." );
             end;
       end;
  end;
  jk = jk + 1;    
  //Сформируем платежи pmpaym3.dbt

  if ( jk < ii )  
       su = (masi(jk));
       if (su == 0 )
           jk = jk + 1;    
       end;
       if (( jk < ii ) and (masi(jk) != 0 )) 
          su = (masi(jk));
          if ( su < 0)
               RECEIVER = partyid;
               PAYER = _BANK0;
          else
               RECEIVER = _BANK0;
               PAYER = partyid;
          end;

          valu = masiv(jk);
          su = abs(masi(jk));

          paym3.rec.DOCKIND = 140;
          paym3.rec.DOCUMENTID = forexdeal.rec.NETTINGID;
          paym3.rec.PURPOSE = 39;    
          paym3.rec.SUBPURPOSE = jk2; 
          jk2 = jk2 + 1; 

          paym3.rec.FIID = valu;
          paym3.rec.PAYFIID = valu;
          paym3.rec.RECEIVER = RECEIVER;
          paym3.rec.PAYER = PAYER;
          PayerCodeKind    = 6;
          ReceiverCodeKind = 6;
          paym3.rec.PayerCode = ПолучитьКодСубъекта( paym3.rec.Payer, PayerCodeKind );
          
          if(paym3.rec.PayerCode == "")
             PayerCodeKind = 1;
             paym3.rec.PayerCode = ПолучитьКодСубъекта( paym3.rec.Payer, PayerCodeKind );
          end;
          paym3.rec.RECEIVERCODE = ПолучитьКодСубъекта( paym3.rec.RECEIVER, ReceiverCodeKind );
          if(paym3.rec.RECEIVERCODE == "")
             ReceiverCodeKind = 1;
             paym3.rec.RECEIVERCODE = ПолучитьКодСубъекта( paym3.rec.RECEIVER, ReceiverCodeKind );
          end;
         
          paym3.rec.PAYERBANKID = {OurBank};
          paym3.rec.RECEIVERBANKID = {OurBank};
          paym3.rec.VALUEDATE = Dat;
    
          paym3.rec.DEPARTMENT = {NumDprt};
          paym3.rec.CHAPTER = 1;
          paym3.rec.ISPLANPAYM = "X";
          paym3.rec.PAYERCODEKIND = PayerCodeKind;
          paym3.rec.RECEIVERCODEKIND = ReceiverCodeKind;
          paym3.rec.FIID_FUTUREPAYACC = valu;
          paym3.rec.FIID_FUTURERECACC = valu;
          paym3.rec.BASEAMOUNT = su;
          paym3.rec.orderamount = su;
          paym3.rec.AMOUNT = paym3.rec.BASEAMOUNT;
          paym3.rec.payamount = paym3.rec.BASEAMOUNT;
          paym3.rec.BASEFIID = valu;
          paym3.rec.ORDERFIID = valu;
        
          paym3.rec.PAYERDPBLOCK = -1;
          paym3.rec.RECEIVERDPBLOCK = -1;
          paym3.rec.OPER = {oper};
          paym3.rec.ORIGIN = 3;
          paym3.rec.STARTDEPARTMENT = {NumDprt};
          paym3.rec.ENDDEPARTMENT = {NumDprt};
          paym3.rec.PRIMDOCKIND = 140;
          paym3.rec.COMISSFIID = -1;
          paym3.rec.NETTING  = "";

          stat = paym3.insert;
          if (not stat)
              RunError( "Ошибка при создании новой сделки." );
          end;

          //debet
          paymprop3.rec.PAYMENTID = paym3.rec.PAYMENTID;
          paymprop3.rec.DEBETCREDIT = 0;
          paymprop3.rec.CODEKIND = 3;
          paymprop3.rec.CODENAME = "БИК";
          paymprop3.rec.BANKCODE = ПолучитьКодСубъекта( {OurBank}, 1 );
          paymprop3.rec.CORSCHEM = -1;
          paymprop3.rec.ISSENDER = "X";
          paymprop3.rec.TRANSFERDATE = paym3.rec.VALUEDATE;
          paymprop3.rec.CORRID = -1;
          paymprop3.rec.OURCORRID = -1;
          paymprop3.rec.GROUP = 2;
          stat = paymprop3.insert;
          if (not stat)
              RunError( "Ошибка при создании новой сделки." );
          end;
          //credit
          paymprop3.rec.PAYMENTID = paym3.rec.PAYMENTID ;
          paymprop3.rec.DEBETCREDIT = 1;
          paymprop3.rec.CODEKIND = 3;
          paymprop3.rec.CODENAME = "БИК";
          paymprop3.rec.BANKCODE = ПолучитьКодСубъекта( {OurBank}, 1 );
          paymprop3.rec.ISSENDER = "";
          paymprop3.rec.TRANSFERDATE = paym3.rec.VALUEDATE;
          paymprop3.rec.CORRID = -1;
          paymprop3.rec.OURCORRID = -1;
          paymprop3.rec.PAYFIID = valu; 
          paymprop3.rec.CORSCHEM = Corr_sx(valu);
          paymprop3.rec.TPID  = 2;
          paymprop3.rec.GROUP = 1;
          paymprop3.rec.TPSCHEMID = 51;
          paymprop3.rec.RLSFORMID = 139;
          stat = paymprop3.insert;
          if (not stat)
              RunError( "Ошибка при создании новой сделки." );
          end;
          
          //Реквизиты платежа         
          pmrmprop3.rec.PAYMENTID = paym3.rec.PAYMENTID ;
          pmrmprop3.rec.NUMBER = 0;
          pmrmprop3.rec.DATE = Dat;
          pmrmprop3.rec.PAYMENTKIND = "Э";
          pmrmprop3.rec.PAYERBANKNAME = NAMI ({OurBank});
          if (payer  != _BANK0 )
              pmrmprop3.rec.PAYERNAME = NAMI (PARTYID);
              pmrmprop3.rec.RECEIVERNAME = NAMI ({OurBank});
          elif (receiver != _BANK0 )
              pmrmprop3.rec.PAYERNAME = NAMI ({OurBank});
              pmrmprop3.rec.RECEIVERNAME = NAMI (PARTYID);
          end;            
          pmrmprop3.rec.RECEIVERBANKNAME = pmrmprop3.rec.PAYERBANKNAME;
          pmrmprop3.rec.PAYDATE = Dat;
          pmrmprop3.rec.CLIENTDATE = Dat;
          stat = pmrmprop3.insert;
          if (not stat)
              RunError( "Ошибка при создании новой сделки." );
          end;

          pmlink3.rec.LINKKIND =1;
          pmlink3.rec.INITIALPAYMENT = paym3.rec.PAYMENTID;
          pmlink3.rec.PURPOSEPAYMENT = paym3.rec.PAYMENTID;
          pmlink3.rec.FIID          = valu;
          pmlink3.rec.AMOUNT        = su;
          pmlink3.rec.IPSIGN        = "-";
          pmlink3.rec.PPSIGN        = "-";
          pmlink3.rec.DOCKIND       = 140;
          pmlink3.rec.DOCUMENTID    = forexdeal.rec.NETTINGID;
          pmlink3.rec.CONTRNVERSION = 0 ;
          pmlink3.rec.RESERV        = " ";
          stat = pmlink3.insert;
          if (not stat)
               RunError( "Ошибка при создании новой сделки." );
          end;
       end;
  end;

  jk = jk + 1;    
  //Сформируем платежи pmpaym4.dbt

  if (( jk < ii ) and (masi(jk) != 0 ))
     su = (masi(jk));
     if (su == 0 )
        jk = jk + 1;    
        su = (masi(jk));
     end;

     if ( su < 0)
       RECEIVER = partyid;
       PAYER = _BANK0;
     else
       RECEIVER = _BANK0;
       PAYER = partyid;
     end;

     valu = masiv(jk);
     su = abs(masi(jk));

     paym4.rec.DOCKIND = 140;
     paym4.rec.DOCUMENTID = forexdeal.rec.NETTINGID;
     paym4.rec.PURPOSE = 39;    
     paym4.rec.SUBPURPOSE = jk2;
     jk2 = jk2 + 1; 

     paym4.rec.FIID = valu;
     paym4.rec.PAYFIID = valu;
     paym4.rec.RECEIVER = RECEIVER;
     paym4.rec.PAYER=PAYER;
     PayerCodeKind    = 6;
     ReceiverCodeKind = 6;

     paym4.rec.PayerCode = ПолучитьКодСубъекта( paym4.rec.Payer, PayerCodeKind );
     if(paym4.rec.PayerCode == "")
        PayerCodeKind = 1;
        paym4.rec.PayerCode = ПолучитьКодСубъекта( paym4.rec.Payer, PayerCodeKind );
     end;
     paym4.rec.RECEIVERCODE = ПолучитьКодСубъекта( paym4.rec.RECEIVER, ReceiverCodeKind );
     if(paym4.rec.RECEIVERCODE == "")
        ReceiverCodeKind = 1;
        paym4.rec.RECEIVERCODE = ПолучитьКодСубъекта( paym4.rec.RECEIVER, ReceiverCodeKind );
     end;       
     paym4.rec.PAYERBANKID = {OurBank};
     paym4.rec.RECEIVERBANKID = {OurBank};
     paym4.rec.VALUEDATE= Dat;
    
     paym4.rec.DEPARTMENT = {NumDprt};
     paym4.rec.CHAPTER = 1;
     paym4.rec.ISPLANPAYM = "X";
     paym4.rec.PAYERCODEKIND = PayerCodeKind;
     paym4.rec.RECEIVERCODEKIND = ReceiverCodeKind;
     paym4.rec.FIID_FUTUREPAYACC = valu;
     paym4.rec.FIID_FUTURERECACC = valu;
     paym4.rec.BASEAMOUNT = su;
     paym4.rec.orderamount = su;
     paym4.rec.AMOUNT = paym4.rec.BASEAMOUNT;
     paym4.rec.payamount = paym4.rec.BASEAMOUNT;
     paym4.rec.BASEFIID = valu;
     paym4.rec.ORDERFIID = valu;

     paym4.rec.PAYERDPBLOCK = -1;
     paym4.rec.RECEIVERDPBLOCK = -1;
     paym4.rec.OPER = {oper};
     paym4.rec.ORIGIN = 3;
     paym4.rec.STARTDEPARTMENT = {NumDprt};
     paym4.rec.ENDDEPARTMENT = {NumDprt};
     paym4.rec.PRIMDOCKIND = 140;
     paym4.rec.COMISSFIID = -1;

     paym4.rec.NETTING  = "";
     stat = paym4.insert;
     if (not stat)
         RunError( "Ошибка при создании новой сделки." );
     end;
     //debet
     paymprop4.rec.PAYMENTID = paym4.rec.PAYMENTID;
     paymprop4.rec.DEBETCREDIT = 0;
     paymprop4.rec.CODEKIND = 3;
     paymprop4.rec.CODENAME = "БИК";
     paymprop4.rec.BANKCODE = ПолучитьКодСубъекта( {OurBank}, 1 );
     paymprop4.rec.CORSCHEM = -1;
     paymprop4.rec.ISSENDER = "X";
     paymprop4.rec.TRANSFERDATE = paym4.rec.VALUEDATE;
     paymprop4.rec.CORRID = -1;
     paymprop4.rec.OURCORRID = -1;
     paymprop4.rec.GROUP = 2;
     stat = paymprop4.insert;
     if (not stat)
         RunError( "Ошибка при создании новой сделки." );
     end;
     //credit
     paymprop4.rec.PAYMENTID = paym4.rec.PAYMENTID ;
     paymprop4.rec.DEBETCREDIT = 1;
     paymprop4.rec.CODEKIND = 3;
     paymprop4.rec.CODENAME = "БИК";
     paymprop4.rec.BANKCODE = ПолучитьКодСубъекта( {OurBank}, 1 );
     paymprop4.rec.ISSENDER = "";
     paymprop4.rec.TRANSFERDATE = paym4.rec.VALUEDATE;
     paymprop4.rec.CORRID = -1;
     paymprop4.rec.OURCORRID = -1;

     paymprop4.rec.PAYFIID = valu; 
     paymprop4.rec.CORSCHEM = Corr_sx(valu);
     paymprop4.rec.TPID  = 2;
     paymprop4.rec.GROUP = 1;
     paymprop4.rec.TPSCHEMID = 51;
     paymprop4.rec.RLSFORMID = 139;

     stat = paymprop4.insert;
     if (not stat)
         RunError( "Ошибка при создании новой сделки." );
     end;
     //Реквизиты платежа         
     pmrmprop4.rec.PAYMENTID = paym4.rec.PAYMENTID ;
     pmrmprop4.rec.NUMBER = 0;
     pmrmprop4.rec.DATE = Dat;
     pmrmprop4.rec.PAYMENTKIND = "Э";
     pmrmprop4.rec.PAYERBANKNAME = NAMI ({OurBank});
     if (payer  != _BANK0 )
         pmrmprop4.rec.PAYERNAME = NAMI (PARTYID);
         pmrmprop4.rec.RECEIVERNAME = NAMI ({OurBank});
     elif (receiver != _BANK0 )
         pmrmprop4.rec.PAYERNAME = NAMI ({OurBank});
         pmrmprop4.rec.RECEIVERNAME = NAMI (PARTYID);
     end;            
     pmrmprop4.rec.RECEIVERBANKNAME = pmrmprop4.rec.PAYERBANKNAME;
     pmrmprop4.rec.PAYDATE = Dat;
     pmrmprop4.rec.CLIENTDATE = Dat;
     stat = pmrmprop4.insert;
     if (not stat)
         RunError( "Ошибка при создании новой сделки." );
     end;

     pmlink4.rec.LINKKIND =1;
     pmlink4.rec.INITIALPAYMENT = paym4.rec.PAYMENTID;
     pmlink4.rec.PURPOSEPAYMENT = paym4.rec.PAYMENTID;
     pmlink4.rec.FIID          = valu;
     pmlink4.rec.AMOUNT        = su;
     pmlink4.rec.IPSIGN        = "-";
     pmlink4.rec.PPSIGN        = "-";
     pmlink4.rec.DOCKIND       = 140;
     pmlink4.rec.DOCUMENTID    = forexdeal.rec.NETTINGID;
     pmlink4.rec.CONTRNVERSION = 0 ;
     pmlink4.rec.RESERV        = " ";
     stat = pmlink4.insert;
     if (not stat)
         RunError( "Ошибка при создании новой сделки." );
     end;
 end;
//-----------------------------------------------------------------------------
 OnError( RslErrObj ) //А если ошибка - заполняем коммент
 Comment = RslErrObj.Message;
 AbortTrn();

END;

//TEG универсальная функция по сбору неттинга
// Функция вставки сделки НЕТТИНГА
//
MACRO CreateNettingOper()
   var forexdeal = Tbfile( "dl_nett.dbt", "W" );
   var type:integer;
   var stat = 0,refe;
   if(GenerateReference(53, refe) != 0)
     msgbox("Ошибка при генерации референса");
   end;

    forexdeal.rec.DOCKIND = 140;
    forexdeal.rec.DEALNUMBER = kol_nett(Dat); 
    forexdeal.rec.SIGNINGDATE = Dat;    
    forexdeal.rec.REGISTERDATE = Dat;
    forexdeal.rec.ORIGIN = 0;
    forexdeal.rec.VALUEDATE = Dat;
    forexdeal.rec.CONTRACTOR = partyid;
    forexdeal.rec.COMMUNICATIONLINK = 0;
    forexdeal.rec.CONFIRMTRANSPORT = 2;
    forexdeal.rec.CONFIRMCODE = "";
    forexdeal.rec.CONFIRMDATE = Dat;
    forexdeal.rec.OPER = {oper};
    forexdeal.rec.DEPARTMENT = 1;
    forexdeal.rec.KIND_OPERATION = 11080;
    forexdeal.rec.STATUS = 10;
    forexdeal.rec.CLOSINGDATE = date("01.01.0001");
    forexdeal.rec.FI_KIND = 0; /*pnv было FI_KIND = 1 i-support 500881 в неттинге закрываются еще и металлы!!*/
    forexdeal.rec.BASEFIID = -1;
    forexdeal.rec.PAYFIID = -1;
    forexdeal.rec.EXTCODE = fet;
    forexdeal.rec.OVERTRANSITACCOUNT = "";
    forexdeal.rec.INCLUDEONEWAYPAYMENT = "";
    forexdeal.rec.RESERV = "";
    forexdeal.rec.IDENTPROGRAM = 12;
    //пытаемся вставить запись   
    stat = forexdeal.insert;
    if (not stat)
        RunError( "Ошибка при создании операции неттинга." );
    end;
    return  forexdeal.rec.NETTINGID; //вернем идентификатор нэттинга
    //-----------------------------------------------------------------------------
    OnError( RslErrObj ) //А если ошибка - заполняем коммент
    Comment = RslErrObj.Message;
    AbortTrn(); 
    return 0;
END;

MACRO CreateNettPaym (iIdNett, iSummPay, iFiidPay, iSubPurpose)
  var type:integer;
  var stat = 0, summNetting;
  var Payercodekind, ReceiverCodeKind;
  var pmlink    = Tbfile( "pmlink.dbt", "W"   );
  var spdrprop  = Tbfile( "spdrprop.dbt", "W" );
  var paym      = Tbfile( "pmpaym.dbt", "W"   );
  var paymprop  = Tbfile( "pmprop.dbt", "W"   );
  var pmrmprop  = Tbfile( "pmrmprop.dbt", "W" );

  //Сформируем платежи pmpaym.dbt
  if ( iSummPay < 0)
    RECEIVER = partyid;
    PAYER = _BANK0;
  else
    RECEIVER = _BANK0;
    PAYER = partyid;
  end;
  summNetting = abs(iSummPay);

  paym.rec.DOCKIND = 140;
  paym.rec.DOCUMENTID = iIdNett;
  paym.rec.PURPOSE = 39;    
  paym.rec.SUBPURPOSE = iSubPurpose; 
  paym.rec.FIID = iFiidPay;
  paym.rec.PAYFIID = iFiidPay;
  paym.rec.RECEIVER = RECEIVER;
  paym.rec.PAYER=PAYER;
  PayerCodeKind    = 6;
  ReceiverCodeKind = 6;
  paym.rec.PayerCode = ПолучитьКодСубъекта( paym.rec.Payer, PayerCodeKind );
  if(paym.rec.PayerCode == "")
      PayerCodeKind = 1;
      paym.rec.PayerCode = ПолучитьКодСубъекта( paym.rec.Payer, PayerCodeKind );
  end;
  paym.rec.RECEIVERCODE = ПолучитьКодСубъекта( paym.rec.RECEIVER, ReceiverCodeKind );
  if(paym.rec.RECEIVERCODE == "")
     ReceiverCodeKind = 1;
     paym.rec.RECEIVERCODE = ПолучитьКодСубъекта( paym.rec.RECEIVER, ReceiverCodeKind );
  end;
  paym.rec.PAYERBANKID = {OurBank};
  paym.rec.RECEIVERBANKID = {OurBank};
  paym.rec.VALUEDATE= Dat;
  paym.rec.DEPARTMENT = {NumDprt};
  paym.rec.CHAPTER = 1;
  paym.rec.ISPLANPAYM = "X";
  paym.rec.PAYERCODEKIND = PayerCodeKind;
  paym.rec.RECEIVERCODEKIND = ReceiverCodeKind;
  paym.rec.FIID_FUTUREPAYACC = iFiidPay;
  paym.rec.FIID_FUTURERECACC = iFiidPay;
  paym.rec.BASEAMOUNT = summNetting;
  paym.rec.orderamount = summNetting;
  paym.rec.AMOUNT = paym.rec.BASEAMOUNT;
  paym.rec.payamount = paym.rec.BASEAMOUNT;
  paym.rec.BASEFIID = iFiidPay;
  paym.rec.ORDERFIID = iFiidPay;
  paym.rec.PAYERDPBLOCK = -1;
  paym.rec.RECEIVERDPBLOCK = -1;
  paym.rec.OPER = {oper};
  paym.rec.ORIGIN = 3;
  paym.rec.STARTDEPARTMENT = {NumDprt};
  paym.rec.ENDDEPARTMENT = {NumDprt};
  paym.rec.PRIMDOCKIND = 140;
  paym.rec.COMISSFIID = -1;
  paym.rec.NETTING  = "";
  stat = paym.insert;
  if (not stat)
      RunError( "Ошибка при создании платежа." );
  end;
  //debet
  paymprop.rec.PAYMENTID = paym.rec.PAYMENTID;
  paymprop.rec.DEBETCREDIT = 0;
  paymprop.rec.CODEKIND = 3;
  paymprop.rec.CODENAME = "БИК";
  paymprop.rec.BANKCODE = ПолучитьКодСубъекта( {OurBank}, 1 );
  paymprop.rec.CORSCHEM = -1;
  paymprop.rec.ISSENDER = "X";
  paymprop.rec.TRANSFERDATE = paym.rec.VALUEDATE;
  paymprop.rec.CORRID = -1;
  paymprop.rec.OURCORRID = -1;
  paymprop.rec.GROUP = 2;
  stat = paymprop.insert;

  if (not stat)
      RunError( "Ошибка при создании информаци о дебете платежа." );
  end;
  //credit
  paymprop.rec.PAYMENTID = paym.rec.PAYMENTID ;
  paymprop.rec.DEBETCREDIT = 1;
  paymprop.rec.CODEKIND = 3;
  paymprop.rec.CODENAME = "БИК";
  paymprop.rec.BANKCODE = ПолучитьКодСубъекта( {OurBank}, 1 );
  paymprop.rec.ISSENDER = "";
  paymprop.rec.TRANSFERDATE = paym.rec.VALUEDATE;
  paymprop.rec.CORRID = -1;
  paymprop.rec.OURCORRID = -1;
  paymprop.rec.PAYFIID = iFiidPay; 
  paymprop.rec.CORSCHEM = Corr_sx(iFiidPay);
  paymprop.rec.TPID  = 2;
  paymprop.rec.GROUP = 1;
  paymprop.rec.TPSCHEMID = 51;
  paymprop.rec.RLSFORMID = 139;
  stat = paymprop.insert;
  if (not stat)
      RunError( "Ошибка при создании информаци о кредете платежа." );
  end;
  //Реквизиты платежа         
  pmrmprop.rec.PAYMENTID = paym.rec.PAYMENTID ;
  pmrmprop.rec.NUMBER = 0;
  pmrmprop.rec.DATE = Dat;
  pmrmprop.rec.PAYMENTKIND = "Э";
  pmrmprop.rec.PAYERBANKNAME = NAMI ({OurBank});
  if (payer != _BANK0 )
      pmrmprop.rec.PAYERNAME = NAMI (PARTYID);
      pmrmprop.rec.RECEIVERNAME = NAMI ({OurBank});
  elif (receiver != _BANK0 )
      pmrmprop.rec.PAYERNAME = NAMI ({OurBank});
      pmrmprop.rec.RECEIVERNAME = NAMI (PARTYID);
  end;
  pmrmprop.rec.RECEIVERBANKNAME = pmrmprop.rec.PAYERBANKNAME;
  pmrmprop.rec.PAYDATE = Dat;
  pmrmprop.rec.CLIENTDATE = Dat;
  //TEG платежи должны иметь строго определенное назначение
  if (iFiidPay == 0)
      pmrmprop.rec.GROUND = "Перечисление средств обеспечения ОРК00485. НДС не облагается.";
  else
      pmrmprop.rec.GROUND = "PMT FOR FX TRADE SETTLEMENT. CODE UVR00485 DD " + StrSubSt(String(paym.rec.VALUEDATE:f), ".", "/");
  end;
  stat = pmrmprop.insert;
  if (not stat)
      RunError( "Ошибка при создании реквизитов платежа." );
  end;
  return paym.rec.PAYMENTID;
  //-----------------------------------------------------------------------------
  OnError( RslErrObj ) //А если ошибка - заполняем коммент
  Comment = RslErrObj.Message;
  AbortTrn();
  return 0;
END;

// привязыват платеж к неттингу
MACRO LinkPaymToNett (iIdNett, iIdPaym, iIDNettPay) 
  var type:integer;
  var stat = 0, sign ;
  var pmlink    = Tbfile( "pmlink.dbt", "W"   );
  var paym      = Tbfile( "pmpaym.dbt" );

  paym.KeyNum = 0;
  paym.rec.PAYMENTID=iIdPaym;
  if( not GetEq(paym) )
     RunError( "Ошибка поиска платежа ." );
  end;
  
  if (paym.rec.payer==_BANK0) 
    sign = "-";
  else 
    sign = "+";
  end;
  pmlink.rec.LINKKIND = 1;
  pmlink.rec.INITIALPAYMENT = paym.rec.PAYMENTID;
  pmlink.rec.PURPOSEPAYMENT = iIDNettPay; // идентификатор итогового платежа
  pmlink.rec.FIID          = paym.rec.FIID;
  pmlink.rec.AMOUNT        = paym.rec.AMOUNT;
  pmlink.rec.IPSIGN        = sign;
  pmlink.rec.PPSIGN        = sign;
  pmlink.rec.DOCKIND       = 140;
  pmlink.rec.DOCUMENTID    = iIdNett;
  pmlink.rec.CONTRNVERSION = 0 ;
  pmlink.rec.RESERV        = " ";
  stat = pmlink.insert;
  if (not stat)
      RunError( "Ошибка првязки платежа к неттингу." );
  end;
  return true; //если нет ошибки веренем хоршо
  //-----------------------------------------------------------------------------
  OnError( RslErrObj ) //А если ошибка - заполняем коммент
  Comment = RslErrObj.Message;
  AbortTrn();
  return false; //веренем плохо
END;

MACRO CreateNewNett()
  var select, selPaym, resSel, resPaym, countNett = 0;
  var IDNett = 0;
  var IDPаym = 0;
  // проверим что есть неттинг
  // допущение, считаем что у нас в момент исполнения неттинга не будет других операций, которые могут повлиять
  select ="select t_fiid, t_ramount- t_pamount payamount from dstd_bs_dbt where t_vdate = " + nettDate + " and t_status = 0";
  resSel = LnGetRecordset(select);
  if(resSel != null)
    while(resSel.moveNext())
      countNett = countNett + 1;
      if (countNett == 1)//первый прогон, заведем операцию неттинга
          // сделаем операцию неттинга
          IDNett = CreateNettingOper();
          if (IDNett == 0)
              return false;
          end;
      end;
      // создадим платеж
      IDPаym = CreateNettPaym (IDNett, resSel.value(1), resSel.value(0), countNett - 1);
      if (IDPаym == 0)
         return false;
      end;
      // привяжем платежи к неттингу 
      selPaym = " select b.t_paymentid  from ddvndeal_dbt a, dpmpaym_dbt b where a.t_contractor = " + _NKC 
               +"    and a.t_netting = 'X' and (b.t_dockind = 4813 or  b.t_dockind = 4815 or  b.t_dockind = 199) "
               +"    and b.t_documentid = a.t_id " 
               +"    and b.t_valuedate = " + nettDate + " and b.t_basefiid = " + resSel.value(0) 
               +"    and a.t_sector ='X'";/*CHVA 497078 */
      resPaym = LnGetRecordset(selPaym);     
      if(resPaym != null)
         while(resPaym.moveNext())
               if (not LinkPaymToNett (IDNett, resPaym.value(0), IDPаym))
                   return false;
               end;
         end;
      end;
    end;

  end;
  
  /*PNV проверим платежи на бирже, которые НЕ привязались к неттингу*/
  if ( IDNett != 0)
       IDPаym = 0;
      // привяжем платежи к неттингу 
      selPaym = " select NVL(SUM(case when T_RECEIVER = 1181 then B.T_BASEAMOUNT else 0 end),0) receiverAMOUNT, "
               +"        NVL(SUM(case when T_PAYER = 1181 then B.T_BASEAMOUNT else 0 end ),0) PAYERAMOUNT, B.T_BASEFIID "
               +"  from ddvndeal_dbt a, dpmpaym_dbt b where a.t_contractor = " + _NKC 
               +"    and a.t_netting = 'X' and (b.t_dockind = 4813 or  b.t_dockind = 4815 or  b.t_dockind = 199) "
               +"    and b.t_documentid = a.t_id " 
               +"    and b.t_valuedate = " + nettDate
               +"    and B.T_PAYMENTID not in (select LINK.T_INITIALPAYMENT from   DPMLINK_DBT link where LINK.T_DOCKIND = 140 ) "
               +"    and a.t_sector ='X'"
               +"  group by B.T_BASEFIID ";
      resPaym = LnGetRecordset(selPaym);     
      if(resPaym != null)
         while(resPaym.moveNext())
               IDPаym = CreateNettPaym (IDNett, (resPaym.value(0)-resPaym.value(1)), resPaym.value(2), countNett - 1);
               if (IDPаym == 0)
                   return false;
               end;
         end;
      end;
      selPaym = " select b.t_paymentid "
               +"  from ddvndeal_dbt a, dpmpaym_dbt b where a.t_contractor = " + _NKC 
               +"    and a.t_netting = 'X' and (b.t_dockind = 4813 or  b.t_dockind = 4815 or  b.t_dockind = 199) "
               +"    and b.t_documentid = a.t_id " 
               +"    and b.t_valuedate = " + nettDate
               +"    and B.T_PAYMENTID not in (select LINK.T_INITIALPAYMENT from   DPMLINK_DBT link where LINK.T_DOCKIND = 140 ) "
               +"    and a.t_sector ='X'";
      resPaym = LnGetRecordset(selPaym);     
      if(resPaym != null)
         while(resPaym.moveNext())
               if (not LinkPaymToNett (IDNett, resPaym.value(0), IDPаym))
                 return false;
               end;
         end;
     end; 
  end;    
  /*PNV*/
  
  return true;
END;

MACRO sdelnett() 
   if (ProcessTrn(0,"CreateNewNett"))
      return 0;
   else        
      msgbox("Ошибка при обработке нэттинга ", Comment);
      return 1;
   end;
END;       

MACRO Newnett();
      dat = {curdate};
      NettDate = GetSqlDate(dat);
      partyid = _NKC;
      if (sdelnett() == 0) // успешная обработка 
          que = "update dstd_bs_dbt set t_status = 10  where t_vdate = " + NettDate + " and t_status = 0";
          rs = LnGetRecordset(que);
     end;
END;
