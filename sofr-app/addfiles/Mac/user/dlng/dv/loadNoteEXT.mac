/*
Добавление примечания в заявки клиента на сделку
*/
import activex, oralib, likepy, BankInter, DVInter, globals, rsd,RsbDataSet, PTInter,CTinter;

private const DEALID    = 1,
              VALUE_    = 2;

private macro iif(a,b,c)
    if(a)
        return b;
    else
        return c;
    end;
end;

//Заполняется буферная таблица данными из Excel
macro Load_Note()
  var DealID_Excel:string;
  var DealCode:string = "";
  var FullNameFile = "";
  var FileName = "";
  var TermPath = GetCurDir(true) + "\\TxtFile";
  var Userpath = "";
  var DirName = "";
  var ExtName = "";
  var frow = 1;
  var row = 1;
  var sheet, sql, query_insert, query_check, query_update;
  var valuedate:date =  Date(0, 0, 0);
  var ss = $0;
  var str;
  var DealID,FrVal = 0;
  var day = date();
  var ErrStr = "",ErrStat = false,IsOption = false;
  var all = 0,suc = 0, err = 0;
  var dt = StrSubSt(string(Date()),".","");
  var InfoLogFileName = GetTxtFileName( "load_ss_"+dt);
  var cmd,cmd1;
  var result,result1;
  var Request   = TRecHandler("dl_req.dbt");
  var dvdeal    = TRecHandler("dvdeal.dbt");
  Request.Clear();

  /*Выбираем файл для обработки*/
  //if(not SelectFile(FullNameFile, "$D:\\*.xls*", "Выберите файл для загрузки", 0, true))
  //  MsgBox("Отказ от загрузки");
  //  return 0;
  //end;

  //Отделяем путь файла от имени
  ///splitfile(FullNameFile, FileName, ExtName);
  //FileName = FileName + ExtName;
  //DirName = substr(FullNameFile, 1, index(FullNameFile, FileName) - 1);

  //if (not copyfile("$" + DirName + FileName, "$" + TermPath + "\\" + FileName) )
  //  MsgBox("Ошибка при передаче файла на терминал");
  //end;

  /*Открываем файл*/
  //BegAction(1, "Обработка файла \"" +FullNameFile + "\". Ждите...");

  //if(not OpenExcelFile(FileName, false, true, DirName))
  //  MsgBox("Ошибка открытия файла \"" + DirName + "\\" + FileName + "\"");
  //  EndAction(1);
  //  return 0;
  //end;

  //sheet = ExcelApplication.Sheets(1);

 // SetOutput( InfoLogFileName, true ); //Пишем лог в файл. Начало
 // log.RepHeader(date(),time());
  /*Ищем первую строку*/
  //while(frow <= 5)
  //  if((valtype(sheet.cells(frow, DEALID).value) != V_UNDEF) and  ((strupr(sheet.cells(frow, DEALID).value) == "ID_DEAL")))
  //    break;
  //  end;
  //  frow = frow + 1;
  //end;
  //frow = frow + 1;
  //row = frow;
  //Бежим по файлу
  InitProgress(-1);
  row=0;
 // while (valtype(sheet.cells(row, DEALID).value) != V_UNDEF) 
 //   DealID_Excel = sheet.cells(row, DEALID).value;
 //   ss = sheet.cells(row, VALUE_).value;

   cmd1 = RSDCommand( "  SELECT  "+
 " (SELECT t1.t_stringval FROM dgtrecprm_dbt t1 WHERE t1.t_recordid= req.t_recordid AND t1.t_koprmid=104 ) iddeal, "+
 " (SELECT t2.t_stringval FROM dgtrecprm_dbt t2 WHERE t2.t_recordid= req.t_recordid AND t2.t_koprmid=703 ) extcode "+
 " FROM             "+ 
 " (SELECT /*+FIRST_ROWS*/ t.t_recordid    "+
 " FROM dgtrecord_dbt t, dgtobject_dbt gt_objsc,  "+
 " dgtkact_dbt gtkact, dgtkobj_dbt gtkobj, dgtstatus_dbt gtstatus,  "+
 " dgtrsbankcode_dbt RsCode, dgtapp_dbt Src, dgtapp_dbt Tgt    "+
 " WHERE  ( gtkobj.t_Code=86 ) AND  (t.t_APPLICATIONID_TO=11 AND t.t_StatusID=gtstatus.t_StatusID(+)  "+
 " AND t.t_ActionID=gtkact.t_ActionID(+) AND t.t_ObjectID=gt_objsc.t_ObjectID(+)   "+
 " AND gt_objsc.t_ObjectKind=gtkobj.t_ObjectKind(+) AND t.t_ApplicationID_From=Src.t_ApplicationID(+)   "+
 " AND t.t_ApplicationID_To=Tgt.t_ApplicationID(+) AND t.t_ObjectID=RsCode.t_ObjectID(+))) req  "+
 " WHERE  NVL( (SELECT t3.t_stringval FROM dgtrecprm_dbt t3 WHERE t3.t_recordid= req.t_recordid AND t3.t_koprmid=703 ),'0')<>'0' "
                      );
   cmd1.execute();
   result1 = TRsbDataSet(cmd1);

  while (result1.movenext())
    UseProgress(row);
    cmd = RSDCommand( "  SELECT dvdeal.*  "+
                      "   FROM ddvdeal_dbt DVDeal  "+
                      "   WHERE  DVDeal.t_Extcode=TRIM(:extCod) ");
    cmd.addParam( "extCod", RSDBP_IN, result1.value(0));
    cmd.execute();
    result = TRsbDataSet(cmd);

    if (result.movenext())
      result.Getrecord().Copyto(dvdeal.rec);
         if( addNoteForObject( 140,
                               UniID(dvdeal, 140),
                               101,
                               result1.value(1),
                               dvdeal.rec.Date )
           )
             Println("Ошибка при установке примечания \"Номер заявки на бирже\" для объекта " + result1.value(0));
             
         end;
    end;  
     dvdeal.Clear();  
    all = all + 1;
    row = row + 1;
  end;
  RemProgress();
//  ExcelApplication.ActiveWorkbook.Close;
  EndAction(1);
onerror()
  //if (valtype(ExcelApplication) != V_UNDEF)
  //  ExcelApplication.ActiveWorkbook.Close;
  //end;
  EndAction(1);
End;

load_note();