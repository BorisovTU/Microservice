/*
$Name:        dvnop125.mac
$Module:      Производные инструменты
$Description: сделки ПФИ . Шаг "Списание СС"
*/

import InsCarryDoc, "dv_categ.mac", "dv_car.mac", "dv_period.mac";
PRIVATE MACRO ExistZeroFairVal(FD, ДатаИсполненияШага)
    var que, rs;  

    que = "SELECT * " +
    "  FROM dgtrecprm_dbt dc_sum " +
    " WHERE     dc_sum.t_recordid IN " +
    "               (SELECT dc.t_recordid " +
    "                  FROM dgtcode_dbt    gc, " +
    "                       dgtrecord_dbt  rec, " +
    "                       dgtobject_dbt  obj, " +
    "                       dgtrecprm_dbt  dc " +
    "                 WHERE     dc.t_recordid = rec.t_recordid " +
    "                       AND rec.t_objectid = obj.t_objectid " +
    "                       AND dc.t_koprmid IN " +
    "                               (SELECT kopr_ext.t_koprmid " +
    "                                  FROM dgtkoprm_dbt kopr_ext " +
    "                                 WHERE kopr_ext.t_name = 'RGDVNDL_EXTCODE') " +
    "                       AND obj.t_objectkind = 98 " +
    "                       AND OBJ.T_OBJECTID = gc.t_objectid " +
    "                       AND dc.T_STRINGVAL = ? " +
    "                       AND EXISTS " +
    "                               (SELECT * " +
    "                                  FROM dgtrecprm_dbt dc_date " +
    "                                 WHERE     dc_date.t_recordid = dc.t_recordid " +
    "                                       AND dc_date.t_koprmid IN " +
    "                                               (SELECT kopr_date.t_koprmid " +
    "                                                  FROM dgtkoprm_dbt kopr_date " +
    "                                                 WHERE kopr_date.t_name = " +
    "                                                       'RGDVNDL_FAIRVAL_DATE') " +
    "                                       AND dc_date.t_dateval = ?)) " +
    "       AND dc_sum.t_koprmid IN " +
    "               (SELECT kopr_ext.t_koprmid " +
    "                  FROM dgtkoprm_dbt kopr_ext " +
    "                 WHERE kopr_ext.t_name = 'RGDVNDL_FAIRVAL_AMOUNT') " +
    "       AND dc_sum.T_MONEYVAL = 0 ";
    rs = RSDCommand(que);
    rs.addParam( "", RSDBP_IN, FD.Deal.rec.ExtCode );
    rs.addParam( "", RSDBP_IN, ДатаИсполненияШага );
    rs.execute();
    var DataSet = TRsbDataSet(rs);
    if( DataSet.movenext )    
        return true;   
    end;
    return false;
END;

private macro ПроводкиСпсССОпционаВДатуИсп(FD:DVFirstDocNDeal,Doc,ДатаИсполненияШага,ПФИКатегория:string)
   var СчетПФИ = TRecHandler("account"),
       ОстатокПФИ = $0,
       debet:variant, credit:variant;

   if( not FD.OpenAccount( ПФИКатегория, null, false, FIROLE_UNDEF, СчетПФИ, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_MANUAL ) )
      return 1;
   end;
   ОстатокПФИ = GetRestAccountTRH(СчетПФИ, ДатаИсполненияШага);

   if( ОстатокПФИ > $0. )
      debet  = СчетПФИ;
      credit = "Выбытие ПФИ";
   elif( ОстатокПФИ < $0. )
      debet  = "Выбытие ПФИ";
      credit = СчетПФИ;
   end;

   if( abs(ОстатокПФИ) > $0. )
      if( not ПроводкаПоКатегориямУчета( FD, 
                                         debet,                                                                      /* Деб */
                                         credit,                                                                     /* Кредит */
                                         ДатаИсполненияШага,                                                             /* Дата */
                                         1,                                                                          /* Глава */
                                         NATCUR,                                                                     /* Валюта */
                                         abs(ОстатокПФИ),                                                            /* Сумма */
                                         Doc,                                                                        /* Документ */
                                         INPCARRY,                                                                   /* Result_Carry */
                                         "",                                                                         /* Kind_Oper */
                                         "",                                                                         /* Numb_Document */
                                         FD.GetGround(1014),                                                         /* Ground */
                                         NULL, NULL, NULL,
                                         NATCUR, NATCUR
                                       )
        )
          return 1;
      end;
   end;

   return 0;
end;

private macro СписаниеССПрцСвоп( FD, doc, ДатаИсполненияШага )
  var DebAccBuf  = TRecHandler("account");
  var CredAccBuf = TRecHandler("account");

  var DebAccBuf2  = TRecHandler("account");
  var CredAccBuf2 = TRecHandler("account");

  var PlusPFIAccBuf = TRecHandler("account");
  var MinusPFIAccBuf = TRecHandler("account");

  var Sum:money = $0.0;
  var Sum2:money = $0.0;
  var restAccPlusPFI: money = $0.0;
  var restAccMinusPFI: money = $0.0;
  var ground,categ,curr;
  
  IIF( StrUpr(GenClassName(FD)) == "DVFIRSTDOCNDEAL",ground = FD.GetGround(8) ,ground="Списание справедливой стоимости по сделке "+FD.DealCode());

  if((not FD.OpenAccount("+ПФИ", null, null, FIROLE_UNDEF, PlusPFIAccBuf,  ДатаИсполненияШага, NATCUR, null, null)) or
     (not FD.OpenAccount("-ПФИ", null, null, FIROLE_UNDEF, MinusPFIAccBuf, ДатаИсполненияШага, NATCUR, null, null))
    )
     return 1;  
  end; 

  restAccPlusPFI  = GetRestAccountTRH(PlusPFIAccBuf, ДатаИсполненияШага);
  restAccMinusPFI = GetRestAccountTRH(MinusPFIAccBuf, ДатаИсполненияШага);

  var IsSumEqDebet = null;
  var IsSumEqDebet2 = null;

  if (FD.БивалютнаяСделка())
    categ = ПИ_КатегорияПлФорвардРПИ();
    curr = FD.ВалютаТребования();
  else
    //if ( (FD.ВалютаОбязательства() == NATCUR) and (FD.ВалютаТребования != NATCUR) )
      categ = "Выбытие ПФИ";
      curr = NATCUR;
    /*else
      categ = ПИ_КатегорияМнФорвардРПИ();
      curr = FD.ВалютаОбязательства();
    end;*/
  end;

  if( (restAccPlusPFI < 0) or (restAccMinusPFI < 0) ) 
    if( ((not FD.IsExistAccount(categ, null, true, FIROLE_UNDEF, DebAccBuf, null, ДатаИсполненияШага, curr)) and 
         (not FD.OpenAccount( categ, null, null, FIROLE_UNDEF, DebAccBuf,  ДатаИсполненияШага, curr, null, null, MC_PAIRACCMODE_MANUAL ) )) OR
                    (not FD.OpenAccount( "+ПФИ",          null, null, FIROLE_UNDEF, CredAccBuf, ДатаИсполненияШага, NATCUR, null, null ) ) )
      return 1;
    end;

    if (curr == NATCUR)
        IsSumEqDebet = null;
    else
        IsSumEqDebet = true;
    end;

    Sum = abs( IIF((restAccPlusPFI < 0), restAccPlusPFI, restAccMinusPFI) );
  end;

  if( (restAccPlusPFI > 0) or (restAccMinusPFI > 0) )   
    if( (not FD.OpenAccount( "-ПФИ",          null, null, FIROLE_UNDEF, DebAccBuf2,  ДатаИсполненияШага, NATCUR, null, null ) ) OR
        ((not FD.IsExistAccount(categ, null, true, FIROLE_UNDEF, CredAccBuf2, null, ДатаИсполненияШага, curr)) and 
        (not FD.OpenAccount( categ, null, null, FIROLE_UNDEF, CredAccBuf2, ДатаИсполненияШага, curr, null, null, MC_PAIRACCMODE_MANUAL ) )) )
         return 1;
    end;
    if (curr == NATCUR)
        IsSumEqDebet = null;
    else
        IsSumEqDebet2 = false;
    end;
    Sum2 = abs( IIF((restAccPlusPFI > 0), restAccPlusPFI, restAccMinusPFI) );
  end;

  if( Sum > 0.0 )
     if( not ПроводкаПоКатегориямУчета( FD,
                                        DebAccBuf, CredAccBuf,
                                        ДатаИсполненияШага, 1,
                                        NATCUR, Sum,
                                        doc,
                                        INPCARRY,"", "",
                                        Ground,// "Списание справедливой стоимости по сделке "+FD.DealCode(),
                                        NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL, IsSumEqDebet
                                      )
       )
        return 1;
     end;
  end;


  if( Sum2 > 0.0 )
     if( not ПроводкаПоКатегориямУчета( FD,
                                        DebAccBuf2, CredAccBuf2,
                                        ДатаИсполненияШага, 1,
                                        NATCUR, Sum2,
                                        doc,
                                        INPCARRY,"", "",
                                        Ground,//"Списание справедливой стоимостипо сделке "+FD.DealCode(),
                                        NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL, IsSumEqDebet2
                                      )
       )
        return 1;
     end;
  end;

return 0;

end;

private macro ОтнесениеФинРезультатаПрцСвоп( FD, Doc, ДатаИсполненияШага )

  var FrValSum:money = FD.GetLastFrValSum();
  var Data,PaySum = $0,RecSum = $0,NatSum =$0;
  var SumEqCB = $0,SumEqDeal = $0,SumFinRez = $0;
  var categ,curr;
  var AccBuf = TRecHandler("account"); 
  var IsSumEqDebet = null; /*PNV*/

  var Query = RSDCommand(" SELECT d.t_sum_natcur as sum_natcur,d.t_sum_payer as sum_payer,d.t_sum_receiver as sum_receiver FROM dacctrn_dbt d "+
  " WHERE d.t_date_carry = ? AND " +
  " ( (substr(d.t_account_payer,1,5) = '47408') AND (substr(d.t_account_receiver,1,5) = '47407') ) "+
  " AND  d.t_acctrnid IN ( "+
  " SELECT t.t_acctrnid FROM doprdocs_dbt t "+
  " WHERE t.t_dockind = 1 AND t.t_id_operation IN ( "+
  " SELECT t.t_id_operation FROM doproper_dbt t, ddvndeal_dbt d WHERE t.t_dockind = 199 "+
  " AND d.t_id = ltrim(t.t_documentid,'0') AND d.t_id = ? "+
  " )) ");

  Query.NullConversion = true;
  Query.addParam("", RSDBP_IN, ДатаИсполненияШага );
  Query.addParam("", RSDBP_IN, FD.deal.rec.id );
  Query.execute();

  Data = TRsbDataSet(Query);

  if( Data.MoveNext() )
     NatSum = Data.sum_natcur;
     PaySum = Data.sum_payer;
     RecSum = Data.sum_receiver;
  end;

  if  ( (NatSum == $0) and (PaySum == $0) and (RecSum == $0) )
    return 1;
  end;

  if ((FD.ВалютаТребования() == NATCUR) and (FD.ВалютаОбязательства() !=NATCUR))
    if( not DV_SmartConvertSum(SumEqCB, RecSum, ДатаИсполненияШага,FD.ВалютаОбязательства(), NATCUR, false) )
      return 1;
    end;
  else
    if( not DV_SmartConvertSum(SumEqCB, PaySum , ДатаИсполненияШага, FD.ВалютаТребования(), NATCUR, false) )
      return 1;
    end;
  end;

  if (SumEqCB == $0)
    return 1;
  end;

  if (max(SumEqCB,NatSum) != (abs(FrValSum) + min(SumEqCB,NatSum)))
    SumFinRez = max(SumEqCB,NatSum) - min(SumEqCB,NatSum) - FrValSum;

    if ( (FD.ВалютаОбязательства() == NATCUR) and (FD.ВалютаТребования != NATCUR) )
      categ = ПИ_КатегорияПлФорвардРПИ();
      curr = FD.ВалютаТребования();
    else
      categ = ПИ_КатегорияМнФорвардРПИ();
      curr = FD.ВалютаОбязательства();
    end;

    if (not FD.OpenAccount( categ, null, null, FIROLE_UNDEF, AccBuf,  ДатаИсполненияШага, curr, null, null, MC_PAIRACCMODE_MANUAL ) )
      return 1;
    end;

    /*PNV*/
    if (curr == NATCUR)
        IsSumEqDebet = null;
    else
        IsSumEqDebet = true;
    end;
    /*PNV*/
   
    if ( (categ == ПИ_КатегорияПлФорвардРПИ()) and (SumFinRez < 0) )
      if( not ПроводкаПоКатегориямУчета( FD,
                                        "Расходы ПФИ", AccBuf,
                                        ДатаИсполненияШага, 1,
                                        NATCUR, abs(SumFinRez),
                                        doc,
                                        INPCARRY,"", "",
                                        "Отнесение финансового результата по сделке "+FD.DealCode()+" от "+StrSubSt(String(FD.ДатаСделки():f), ".", "/")+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*///"Отнесение фин. результата на доходы",   /* Ground */
                                        NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL, IsSumEqDebet
                                      )
       )
        return 1;
      end;
    elif ( (categ == ПИ_КатегорияПлФорвардРПИ()) and (SumFinRez > 0) )
      if( not ПроводкаПоКатегориямУчета( FD,
                                        AccBuf,"Доходы ПФИ",
                                        ДатаИсполненияШага, 1,
                                        NATCUR, abs(SumFinRez),
                                        doc,
                                        INPCARRY,"", "",
                                        "Отнесение финансового результата по сделке "+FD.DealCode()+" от "+StrSubSt(String(FD.ДатаСделки():f), ".", "/")+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*///"Отнесение фин. результата на доходы",   /* Ground */
                                        NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL, IsSumEqDebet
                                      )
       )
        return 1;
      end;

    elif ( (categ == ПИ_КатегорияМнФорвардРПИ()) and (SumFinRez > 0) )
      if( not ПроводкаПоКатегориямУчета( FD,
                                        AccBuf,"Расходы ПФИ",
                                        ДатаИсполненияШага, 1,
                                        NATCUR, abs(SumFinRez),
                                        doc,
                                        INPCARRY,"", "",
                                        "Отнесение финансового результата по сделке "+FD.DealCode()+" от "+StrSubSt(String(FD.ДатаСделки():f), ".", "/")+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*///"Отнесение фин. результата на доходы",   /* Ground */
                                        NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL, IsSumEqDebet
                                      )
       )
        return 1;
      end;
    elif ( (categ == ПИ_КатегорияМнФорвардРПИ()) and (SumFinRez > 0) )
      if( not ПроводкаПоКатегориямУчета( FD,
                                        AccBuf,"Доходы ПФИ",
                                        ДатаИсполненияШага, 1,
                                        NATCUR, abs(SumFinRez),
                                        doc,
                                        INPCARRY,"", "",
                                        "Отнесение финансового результата по сделке "+FD.DealCode()+" от "+StrSubSt(String(FD.ДатаСделки():f), ".", "/")+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*///"Отнесение фин. результата на доходы",   /* Ground */
                                        NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL, IsSumEqDebet
                                      )
       )
        return 1;
      end;
    end;


  end;


  return 0;
END;


macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )

  RECORD ndeal(dvndeal);
  VAR ДатаИсполненияШага, FD;
  SetBuff( ndeal, FDoc );
  var СчетПФИ = TRecHandler("account");

  FD = DVFirstDocNDeal(DocKind, ndeal);
  if (FD.Биржевая() AND ((not FD.IsPctSWAP()) and (not (FD.IsForward() and (not FD.ПоставочныйКонтракт()))))) //Для биржи (кроме процентного СВОПа) списываем в шаге постановки на баланс 
    return 0;
  end;

  ДатаИсполненияШага = DV_GetPlanDateStep(ID_Operation, ID_Step);
  if( ДатаИсполненияШага == date(0,0,0) )
     ДатаИсполненияШага = FD.ДатаИсполнения();
  end;


  if( (not FD.IsClient()) and (not FD.ВыполненаПереоценкаСС(ДатаИсполненияШага)) and (not ExistZeroFairVal(FD, ДатаИсполненияШага)) )
     MsgBox( "Не выполнена переоценка справедливой стоимости ! Продолжение невозможно.");
     return 1;
  end;
  if (FD.IsPctSWAP())
    if( СписаниеССПрцСвоп( FD, doc, ДатаИсполненияШага ) != 0 )
     return 1;
    end;
    if (GetDateAfterWorkDays(FD.ДатаИсполнения(),0,FD.ПолучитьКалендСвязанный()) != ДатаИсполненияШага)
    if( ОтнесениеФинРезультатаПрцСвоп( FD, doc, ДатаИсполненияШага ) != 0 )
     msgbox("Не удалось получить фин.результат по процентному свопу");
     return 0;
    end;
    end;

  else
    if ( (FD.IsOption() and (FD.ПоставочныйКонтракт() == false)) or ((FD.IsForward() and (FD.ПоставочныйКонтракт() == false))) )
      if( ПроводкиСпсССОпционаВДатуИсп(FD, Doc, ДатаИсполненияШага,"-ПФИ") )
        return 1;
      end;
      if( ПроводкиСпсССОпционаВДатуИсп(FD, Doc, ДатаИсполненияШага,"+ПФИ") )
        return 1;
      end;
	  if (FD.IsForward() and (FD.ПоставочныйКонтракт() == false))
        if( ОтнесениеФинРезультата( FD, doc, ДатаИсполненияШага ) != 0 )
          return 1;
        end;
      end;
    elif (FD.IsForward())
        if ( (not FD.IsExistAccount("Выбытие ПФИ", null, null, FIROLE_FICOM, СчетПФИ, null, ДатаИсполненияШага, NATCUR)) and 
        ( not FD.OpenAccount("Выбытие ПФИ", null, null, FIROLE_FICOM, СчетПФИ, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_MANUAL) ))
            return 1;
        end;
        if (abs(GetRestAccountTRH(СчетПФИ, ДатаИсполненияШага)) > 0)
            if( ПроводкиСпсССОпционаВДатуИсп(FD, Doc, ДатаИсполненияШага,"-ПФИ") )
                return 1;
            end;
            if( ПроводкиСпсССОпционаВДатуИсп(FD, Doc, ДатаИсполненияШага,"+ПФИ") )
                return 1;
            end;
        else
           if( СписаниеСправедливойСтоимости( FD, doc, ДатаИсполненияШага ) != 0 )
               return 1;
           end;
        end; 
    else
      if( СписаниеСправедливойСтоимости( FD, doc, ДатаИсполненияШага ) != 0 )
         return 1;
      end;
    end;
  end;

  if( not InsertOprStatus(FD.DV_OPERSTATUS_DOC(), DV_OPERSTATUS_DOC_CLOSE) )
    MsgBox("Ошибка при установке статуса <Документооборот> по операции.");
    return 1;
  end;

  return 0;

end;