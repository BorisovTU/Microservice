 import funk,dl_plib,fx_globals,dv_lib;
 import "gtconst.inc", dlref, dealInfo;


  private var j,ii2,es0,zz,xx,jk2,fet="FLAT",var0,ES,vsd,Comment,mm,partyid,kk=0,i,ii,su,rs0,val,{curdate},d0,sd0,rs,jj=0,que,spartyid, payer, receiver,baseamount,dealcode;

  array mmas,mmas0,mmas2,mmas1,mmas3,mmas4,masi,masiv,mab,ma;

macro kol_nett(da)
 private var ij,rs11,que,rs10,rez,koli,nda,sda,koko;


           sda=СДАТ(da);   
           nda=substr(sda,9,2)+substr(sda,4,2)+substr(sda,1,2);

            rez="NETT";

            que="select count(*) from ddl_nett_dbt where T_SIGNINGDATE = '"+sda+"'";
            ES=que;
 	    rs10 = LnGetRecordset(que);
            if(rs10 != null)
              if (rs10.moveNext) 
                 koli=rs10.value(0);
                 rez=substr(string(1001+int(koli)),2);
                 rez="NETT"+rez+"/"+nda;
                 ij = 0;

                 while (ij < 4 )
                   que="select count(*) from ddl_nett_dbt where t_dealnumber = '"+rez+"'";
                   rs11 = LnGetRecordset(que);
                   if(rs11 != null)
                    if (rs11.moveNext) 
                     koko=rs11.value(0);
                    end;
                   end;
                   if (koko > 0)
                     koli=koli+1;
                     rez=substr(string(1001+int(koli)),2);
                     rez="NETT"+rez+"/"+nda;
                   else
                     ij=5;
                   end;
                   ij=ij+1;
                  end;

              end;
            end;
            return rez;
end;

MACRO SDEL(S,KS)
  PRIVATE VAR SW="                                                                                                      ";
  S=SUBSTR(S+SW,1,KS);
  RETURN(S);
END;

// Функция вставки сделки НЕТТИНГА
//
macro CreateNewNett()
   var forexdeal = Tbfile( "dl_nett.dbt", "W" );
   var pmlink    = Tbfile( "pmlink.dbt", "W" );
   var spdrprop  = Tbfile( "spdrprop.dbt", "W" );
   var pmlink2    = Tbfile( "pmlink.dbt", "W" );
   var spdrprop2  = Tbfile( "spdrprop.dbt", "W" );
   var pmlink3    = Tbfile( "pmlink.dbt", "W" );
   var spdrprop3  = Tbfile( "spdrprop.dbt", "W" );
   var pmlink4    = Tbfile( "pmlink.dbt", "W" );
   var spdrprop4  = Tbfile( "spdrprop.dbt", "W" );



   var paym      = Tbfile( "pmpaym.dbt", "W" );
   var paymprop  = Tbfile( "pmprop.dbt", "W" );
   var pmrmprop  = Tbfile( "pmrmprop.dbt", "W" );

   var paym2      = Tbfile( "pmpaym.dbt", "W" );
   var paymprop2  = Tbfile( "pmprop.dbt", "W" );
   var pmrmprop2  = Tbfile( "pmrmprop.dbt", "W" );

   var paym3      = Tbfile( "pmpaym.dbt", "W" );
   var paymprop3  = Tbfile( "pmprop.dbt", "W" );
   var pmrmprop3  = Tbfile( "pmrmprop.dbt", "W" );

   var paym4      = Tbfile( "pmpaym.dbt", "W" );
   var paymprop4  = Tbfile( "pmprop.dbt", "W" );
   var pmrmprop4  = Tbfile( "pmrmprop.dbt", "W" );

   var type:integer;
   var stat=0,refe,jk,valu,su;
   var Payercodekind, ReceiverCodeKind;
   
   

  if(GenerateReference(53, refe) != 0)
    msgbox("Ошибка при генерации референса");
  end;


//  forexdeal.rec.NETTINGID=0;
  forexdeal.rec.DOCKIND = 140;
  forexdeal.rec.DEALNUMBER=kol_nett(d0);   // string(refe);
  forexdeal.rec.SIGNINGDATE=d0;    
  forexdeal.rec.REGISTERDATE =d0;
  forexdeal.rec.ORIGIN =0;
  forexdeal.rec.VALUEDATE =d0;
  forexdeal.rec.CONTRACTOR =partyid;
  // forexdeal.rec.DEALER =95136864;
  forexdeal.rec.COMMUNICATIONLINK=0;
  forexdeal.rec.CONFIRMTRANSPORT =2;
  forexdeal.rec.CONFIRMCODE="";
  forexdeal.rec.CONFIRMDATE=d0;
  forexdeal.rec.OPER ={oper};
  forexdeal.rec.DEPARTMENT=1;
  forexdeal.rec.KIND_OPERATION=11080;
  forexdeal.rec.STATUS=10;
  forexdeal.rec.CLOSINGDATE=date("01.01.0001");
  forexdeal.rec.FI_KIND =1;
  forexdeal.rec.BASEFIID =-1;
  forexdeal.rec.PAYFIID =-1;
  forexdeal.rec.EXTCODE=fet;
  forexdeal.rec.OVERTRANSITACCOUNT="";
  forexdeal.rec.INCLUDEONEWAYPAYMENT="";
  forexdeal.rec.RESERV =vsd;
  forexdeal.rec.IDENTPROGRAM =12;

   
//пытаемся вставить запись   
   stat = forexdeal.insert;
        if (not stat)
                RunError( "Ошибка при создании новой сделки." );
    end;

//Сформируем платежи pmpaym.dbt

   jk=1;
   jk2=0;
     
     su=(masi(jk));
     if (su == 0 )
        jk=jk+1;    
        su=(masi(jk));
     end;


     if ( su < 0)
       RECEIVER=partyid;
       PAYER =_BANK0;
     else
       RECEIVER=_BANK0;
       PAYER =partyid;
     end;

     valu=masiv(jk);
     su=abs(masi(jk));

    paym.rec.DOCKIND = 140;
    paym.rec.DOCUMENTID = forexdeal.rec.NETTINGID;
    paym.rec.PURPOSE = 39;    
    paym.rec.SUBPURPOSE = jk2; 
    jk2=jk2+1;

    paym.rec.FIID = valu;
    paym.rec.PAYFIID = valu;

   paym.rec.RECEIVER = RECEIVER;
   paym.rec.PAYER=PAYER;


//    paym.rec.deliveryKind = g_delivery;

      PayerCodeKind    = 6;

      ReceiverCodeKind = 6;

    paym.rec.PayerCode = ПолучитьКодСубъекта( paym.rec.Payer, PayerCodeKind );
    if(paym.rec.PayerCode == "")
      PayerCodeKind = 1;
      paym.rec.PayerCode = ПолучитьКодСубъекта( paym.rec.Payer, PayerCodeKind );
    end;
    paym.rec.RECEIVERCODE = ПолучитьКодСубъекта( paym.rec.RECEIVER, ReceiverCodeKind );
    if(paym.rec.RECEIVERCODE == "")
      ReceiverCodeKind = 1;
      paym.rec.RECEIVERCODE = ПолучитьКодСубъекта( paym.rec.RECEIVER, ReceiverCodeKind );
    end;

        
   paym.rec.PAYERBANKID = {OurBank};
   paym.rec.RECEIVERBANKID = {OurBank};
        
    paym.rec.VALUEDATE= d0;
    
    paym.rec.DEPARTMENT = {NumDprt};
    paym.rec.CHAPTER = 1;
    paym.rec.ISPLANPAYM = "X";
    paym.rec.PAYERCODEKIND = PayerCodeKind;
    paym.rec.RECEIVERCODEKIND = ReceiverCodeKind;
    paym.rec.FIID_FUTUREPAYACC = valu;
    paym.rec.FIID_FUTURERECACC = valu;
    paym.rec.BASEAMOUNT = su;
    paym.rec.orderamount = su;
    paym.rec.AMOUNT = paym.rec.BASEAMOUNT;
    paym.rec.payamount = paym.rec.BASEAMOUNT;
    paym.rec.BASEFIID = valu;
    paym.rec.ORDERFIID = valu;
    paym.rec.PAYERDPBLOCK = -1;
    paym.rec.RECEIVERDPBLOCK = -1;
    paym.rec.OPER = {oper};
    paym.rec.ORIGIN = 3;
    paym.rec.STARTDEPARTMENT = {NumDprt};
    paym.rec.ENDDEPARTMENT = {NumDprt};
    paym.rec.PRIMDOCKIND = 140;
    paym.rec.COMISSFIID = -1;

       paym.rec.NETTING  = "";

        stat = paym.insert;
        if (not stat)
                RunError( "Ошибка при создании новой сделки." );
        end;

  


//debet
                paymprop.rec.PAYMENTID = paym.rec.PAYMENTID;
                paymprop.rec.DEBETCREDIT = 0;
                paymprop.rec.CODEKIND = 3;
                paymprop.rec.CODENAME = "БИК";
                paymprop.rec.BANKCODE = ПолучитьКодСубъекта( {OurBank}, 1 );
                paymprop.rec.CORSCHEM = -1;
                paymprop.rec.ISSENDER = "X";
                paymprop.rec.TRANSFERDATE = paym.rec.VALUEDATE;
                paymprop.rec.CORRID = -1;
                paymprop.rec.OURCORRID = -1;
                paymprop.rec.GROUP = 2;
                stat = paymprop.insert;
                if (not stat)
                        RunError( "Ошибка при создании новой сделки." );
            end;
//credit
                paymprop.rec.PAYMENTID = paym.rec.PAYMENTID ;
                paymprop.rec.DEBETCREDIT = 1;
                paymprop.rec.CODEKIND = 3;
                paymprop.rec.CODENAME = "БИК";
                paymprop.rec.BANKCODE = ПолучитьКодСубъекта( {OurBank}, 1 );
                paymprop.rec.CORSCHEM = -1;
                paymprop.rec.ISSENDER = "";
                paymprop.rec.TRANSFERDATE = paym.rec.VALUEDATE;
                paymprop.rec.CORRID = -1;
                paymprop.rec.OURCORRID = -1;
                paymprop.rec.GROUP = 2;
                stat = paymprop.insert;
                if (not stat)
                        RunError( "Ошибка при создании новой сделки." );
            end;


//Реквизиты платежа         
            pmrmprop.rec.PAYMENTID = paym.rec.PAYMENTID ;
            pmrmprop.rec.NUMBER = 0;
            pmrmprop.rec.DATE = d0;
            pmrmprop.rec.PAYMENTKIND = "Э";
            pmrmprop.rec.PAYERBANKNAME = NAMI ({OurBank});

                if (payer  != _BANK0 )
                    pmrmprop.rec.PAYERNAME = NAMI (PARTYID);
                    pmrmprop.rec.RECEIVERNAME = NAMI ({OurBank});
                elif (receiver != _BANK0 )
                    pmrmprop.rec.PAYERNAME = NAMI ({OurBank});
                    pmrmprop.rec.RECEIVERNAME = NAMI (PARTYID);
                end;            
            pmrmprop.rec.RECEIVERBANKNAME = pmrmprop.rec.PAYERBANKNAME;
            pmrmprop.rec.PAYDATE = d0;
            pmrmprop.rec.CLIENTDATE = d0;
                stat = pmrmprop.insert;
                if (not stat)
                        RunError( "Ошибка при создании новой сделки." );
                end;

//        T_PAYMLINKID     NUMBER(10) not null,
	  pmlink.rec.LINKKIND =1;
	  pmlink.rec.INITIALPAYMENT =paym.rec.PAYMENTID;
	  pmlink.rec.PURPOSEPAYMENT =paym.rec.PAYMENTID;
	  pmlink.rec.FIID          = valu;
	  pmlink.rec.AMOUNT        = su;
	  pmlink.rec.IPSIGN        ="-";
	  pmlink.rec.PPSIGN        ="-";
	  pmlink.rec.DOCKIND       =140;
	  pmlink.rec.DOCUMENTID    =forexdeal.rec.NETTINGID;
	  pmlink.rec.CONTRNVERSION =0 ;
	  pmlink.rec.RESERV        =" ";

	   stat = pmlink.insert;
           if (not stat)
                RunError( "Ошибка при создании новой сделки." );
           end;
/*
	  spdrprop.rec.PAYMENTID=paym.rec.PAYMENTID;
	  spdrprop.rec.DRAFTID =0;
	  spdrprop.rec.DEBACCOUNT =" ";
	  spdrprop.rec.CREDACCOUNT=" ";
	  spdrprop.rec.DOCUMENTID =forexdeal.rec.NETTINGID;
	  spdrprop.rec.DOCUMENTKIND =140;
	  spdrprop.rec.ISMAIN       ="";
	  spdrprop.rec.MODE         =0;
	   stat = spdrprop.insert;
           if (not stat)
                RunError( "Ошибка при создании новой сделки." );
           end;
*/

     jk=jk+1;    



//Сформируем платежи pmpaym2.dbt


 if ( jk < ii )  

     su=(masi(jk));
     if (su == 0 )
        jk=jk+1;    
     end;

  if (( jk < ii ) and (masi(jk) != 0 )) 

     su=(masi(jk));
     if ( su < 0)
       RECEIVER=partyid;
       PAYER =_BANK0;
     else
       RECEIVER=_BANK0;
       PAYER =partyid;
     end;

     valu=masiv(jk);
     su=abs(masi(jk));

    paym2.rec.DOCKIND = 140;
    paym2.rec.DOCUMENTID = forexdeal.rec.NETTINGID;
    paym2.rec.PURPOSE = 39;    
    paym2.rec.SUBPURPOSE = jk2;    
    jk2=jk2+1;


    paym2.rec.FIID = valu;
    paym2.rec.PAYFIID = valu;

   paym2.rec.RECEIVER = RECEIVER;
   paym2.rec.PAYER=PAYER;


//    paym2.rec.deliveryKind = g_delivery;

      PayerCodeKind    = 6;

      ReceiverCodeKind = 6;

    paym2.rec.PayerCode = ПолучитьКодСубъекта( paym2.rec.Payer, PayerCodeKind );
    if(paym2.rec.PayerCode == "")
      PayerCodeKind = 1;
      paym2.rec.PayerCode = ПолучитьКодСубъекта( paym2.rec.Payer, PayerCodeKind );
    end;
    paym2.rec.RECEIVERCODE = ПолучитьКодСубъекта( paym2.rec.RECEIVER, ReceiverCodeKind );
    if(paym2.rec.RECEIVERCODE == "")
      ReceiverCodeKind = 1;
      paym2.rec.RECEIVERCODE = ПолучитьКодСубъекта( paym2.rec.RECEIVER, ReceiverCodeKind );
    end;

        
   paym2.rec.PAYERBANKID = {OurBank};
   paym2.rec.RECEIVERBANKID = {OurBank};
        
    paym2.rec.VALUEDATE= d0;
    
    paym2.rec.DEPARTMENT = {NumDprt};
    paym2.rec.CHAPTER = 1;
    paym2.rec.ISPLANPAYM = "X";
    paym2.rec.PAYERCODEKIND = PayerCodeKind;
    paym2.rec.RECEIVERCODEKIND = ReceiverCodeKind;
    paym2.rec.FIID_FUTUREPAYACC = valu;
    paym2.rec.FIID_FUTURERECACC = valu;
    paym2.rec.BASEAMOUNT = su;
    paym2.rec.orderamount = su;
    paym2.rec.AMOUNT = paym2.rec.BASEAMOUNT;
    paym2.rec.payamount = paym2.rec.BASEAMOUNT;
    paym2.rec.BASEFIID = valu;
    paym2.rec.ORDERFIID = valu;

    paym2.rec.PAYERDPBLOCK = -1;
    paym2.rec.RECEIVERDPBLOCK = -1;
    paym2.rec.OPER = {oper};
    paym2.rec.ORIGIN = 3;
    paym2.rec.STARTDEPARTMENT = {NumDprt};
    paym2.rec.ENDDEPARTMENT = {NumDprt};
    paym2.rec.PRIMDOCKIND = 140;
    paym2.rec.COMISSFIID = -1;

       paym2.rec.NETTING  = "";

        stat = paym2.insert;
        if (not stat)
                RunError( "Ошибка при создании новой сделки." );
        end;

  


//debet
                paymprop2.rec.PAYMENTID = paym2.rec.PAYMENTID;
                paymprop2.rec.DEBETCREDIT = 0;
                paymprop2.rec.CODEKIND = 3;
                paymprop2.rec.CODENAME = "БИК";
                paymprop2.rec.BANKCODE = ПолучитьКодСубъекта( {OurBank}, 1 );
                paymprop2.rec.CORSCHEM = -1;
                paymprop2.rec.ISSENDER = "X";
                paymprop2.rec.TRANSFERDATE = paym2.rec.VALUEDATE;
                paymprop2.rec.CORRID = -1;
                paymprop2.rec.OURCORRID = -1;
                paymprop2.rec.GROUP = 2;
                stat = paymprop2.insert;
                if (not stat)
                        RunError( "Ошибка при создании новой сделки." );
            end;
//credit
                paymprop2.rec.PAYMENTID = paym2.rec.PAYMENTID ;
                paymprop2.rec.DEBETCREDIT = 1;
                paymprop2.rec.CODEKIND = 3;
                paymprop2.rec.CODENAME = "БИК";
                paymprop2.rec.BANKCODE = ПолучитьКодСубъекта( {OurBank}, 1 );
                paymprop2.rec.CORSCHEM = -1;
                paymprop2.rec.ISSENDER = "";
                paymprop2.rec.TRANSFERDATE = paym2.rec.VALUEDATE;
                paymprop2.rec.CORRID = -1;
                paymprop2.rec.OURCORRID = -1;
                paymprop2.rec.GROUP = 2;
                stat = paymprop2.insert;
                if (not stat)
                        RunError( "Ошибка при создании новой сделки." );
            end;


//Реквизиты платежа         
            pmrmprop2.rec.PAYMENTID = paym2.rec.PAYMENTID ;
            pmrmprop2.rec.NUMBER = 0;
            pmrmprop2.rec.DATE = d0;
            pmrmprop2.rec.PAYMENTKIND = "Э";
            pmrmprop2.rec.PAYERBANKNAME = NAMI ({OurBank});

                if (payer  != _BANK0 )
                    pmrmprop2.rec.PAYERNAME = NAMI (PARTYID);
                    pmrmprop2.rec.RECEIVERNAME = NAMI ({OurBank});
                elif (receiver != _BANK0 )
                    pmrmprop2.rec.PAYERNAME = NAMI ({OurBank});
                    pmrmprop2.rec.RECEIVERNAME = NAMI (PARTYID);
                end;            
            pmrmprop2.rec.RECEIVERBANKNAME = pmrmprop2.rec.PAYERBANKNAME;
            pmrmprop2.rec.PAYDATE = d0;
            pmrmprop2.rec.CLIENTDATE = d0;
                stat = pmrmprop2.insert;
                if (not stat)
                        RunError( "Ошибка при создании новой сделки." );
            end;

	  pmlink2.rec.LINKKIND =1;
	  pmlink2.rec.INITIALPAYMENT =paym2.rec.PAYMENTID;
	  pmlink2.rec.PURPOSEPAYMENT =paym2.rec.PAYMENTID;
	  pmlink2.rec.FIID          = valu;
	  pmlink2.rec.AMOUNT        = su;
	  pmlink2.rec.IPSIGN        ="-";
	  pmlink2.rec.PPSIGN        ="-";
	  pmlink2.rec.DOCKIND       =140;
	  pmlink2.rec.DOCUMENTID    =forexdeal.rec.NETTINGID;
	  pmlink2.rec.CONTRNVERSION =0 ;
	  pmlink2.rec.RESERV        =" ";
	   stat = pmlink2.insert;
           if (not stat)
                RunError( "Ошибка при создании новой сделки." );
           end;
/*
	  spdrprop2.rec.PAYMENTID=paym2.rec.PAYMENTID;
	  spdrprop2.rec.DRAFTID =0;
	  spdrprop2.rec.DEBACCOUNT =" ";
	  spdrprop2.rec.CREDACCOUNT=" ";
	  spdrprop2.rec.DOCUMENTID =forexdeal.rec.NETTINGID;
	  spdrprop2.rec.DOCUMENTKIND =140;
	  spdrprop2.rec.ISMAIN       ="";
	  spdrprop2.rec.MODE         =0;
	   stat = spdrprop2.insert;
           if (not stat)
                RunError( "Ошибка при создании новой сделки." );
           end;
*/


   end;
  end;

     jk=jk+1;    

//Сформируем платежи pmpaym3.dbt

 if ( jk < ii )  
     su=(masi(jk));
     if (su == 0 )
        jk=jk+1;    
     end;
  if (( jk < ii ) and (masi(jk) != 0 )) 
     su=(masi(jk));

     if ( su < 0)
       RECEIVER=partyid;
       PAYER =_BANK0;
     else
       RECEIVER=_BANK0;
       PAYER =partyid;
     end;

     valu=masiv(jk);
     su=abs(masi(jk));

    paym3.rec.DOCKIND = 140;
    paym3.rec.DOCUMENTID = forexdeal.rec.NETTINGID;
    paym3.rec.PURPOSE = 39;    
    paym3.rec.SUBPURPOSE = jk2; 
    jk2=jk2+1;

   

    paym3.rec.FIID = valu;
    paym3.rec.PAYFIID = valu;

   paym3.rec.RECEIVER = RECEIVER;
   paym3.rec.PAYER=PAYER;


//    paym3.rec.deliveryKind = g_delivery;

      PayerCodeKind    = 6;

      ReceiverCodeKind = 6;

    paym3.rec.PayerCode = ПолучитьКодСубъекта( paym3.rec.Payer, PayerCodeKind );
    if(paym3.rec.PayerCode == "")
      PayerCodeKind = 1;
      paym3.rec.PayerCode = ПолучитьКодСубъекта( paym3.rec.Payer, PayerCodeKind );
    end;
    paym3.rec.RECEIVERCODE = ПолучитьКодСубъекта( paym3.rec.RECEIVER, ReceiverCodeKind );
    if(paym3.rec.RECEIVERCODE == "")
      ReceiverCodeKind = 1;
      paym3.rec.RECEIVERCODE = ПолучитьКодСубъекта( paym3.rec.RECEIVER, ReceiverCodeKind );
    end;

        
   paym3.rec.PAYERBANKID = {OurBank};
   paym3.rec.RECEIVERBANKID = {OurBank};
        
    paym3.rec.VALUEDATE= d0;
    
    paym3.rec.DEPARTMENT = {NumDprt};
    paym3.rec.CHAPTER = 1;
    paym3.rec.ISPLANPAYM = "X";
    paym3.rec.PAYERCODEKIND = PayerCodeKind;
    paym3.rec.RECEIVERCODEKIND = ReceiverCodeKind;
    paym3.rec.FIID_FUTUREPAYACC = valu;
    paym3.rec.FIID_FUTURERECACC = valu;
    paym3.rec.BASEAMOUNT = su;
    paym3.rec.orderamount = su;
    paym3.rec.AMOUNT = paym3.rec.BASEAMOUNT;
    paym3.rec.payamount = paym3.rec.BASEAMOUNT;
    paym3.rec.BASEFIID = valu;
    paym3.rec.ORDERFIID = valu;

    paym3.rec.PAYERDPBLOCK = -1;
    paym3.rec.RECEIVERDPBLOCK = -1;
    paym3.rec.OPER = {oper};
    paym3.rec.ORIGIN = 3;
    paym3.rec.STARTDEPARTMENT = {NumDprt};
    paym3.rec.ENDDEPARTMENT = {NumDprt};
    paym3.rec.PRIMDOCKIND = 140;
    paym3.rec.COMISSFIID = -1;

       paym3.rec.NETTING  = "";

        stat = paym3.insert;
        if (not stat)
                RunError( "Ошибка при создании новой сделки." );
        end;

  


//debet
                paymprop3.rec.PAYMENTID = paym3.rec.PAYMENTID;
                paymprop3.rec.DEBETCREDIT = 0;
                paymprop3.rec.CODEKIND = 3;
                paymprop3.rec.CODENAME = "БИК";
                paymprop3.rec.BANKCODE = ПолучитьКодСубъекта( {OurBank}, 1 );
                paymprop3.rec.CORSCHEM = -1;
                paymprop3.rec.ISSENDER = "X";
                paymprop3.rec.TRANSFERDATE = paym3.rec.VALUEDATE;
                paymprop3.rec.CORRID = -1;
                paymprop3.rec.OURCORRID = -1;
                paymprop3.rec.GROUP = 2;
                stat = paymprop3.insert;
                if (not stat)
                        RunError( "Ошибка при создании новой сделки." );
            end;
//credit
                paymprop3.rec.PAYMENTID = paym3.rec.PAYMENTID ;
                paymprop3.rec.DEBETCREDIT = 1;
                paymprop3.rec.CODEKIND = 3;
                paymprop3.rec.CODENAME = "БИК";
                paymprop3.rec.BANKCODE = ПолучитьКодСубъекта( {OurBank}, 1 );
                paymprop3.rec.CORSCHEM = -1;
                paymprop3.rec.ISSENDER = "";
                paymprop3.rec.TRANSFERDATE = paym3.rec.VALUEDATE;
                paymprop3.rec.CORRID = -1;
                paymprop3.rec.OURCORRID = -1;
                paymprop3.rec.GROUP = 2;
                stat = paymprop3.insert;
                if (not stat)
                        RunError( "Ошибка при создании новой сделки." );
            end;


//Реквизиты платежа         
            pmrmprop3.rec.PAYMENTID = paym3.rec.PAYMENTID ;
            pmrmprop3.rec.NUMBER = 0;
            pmrmprop3.rec.DATE = d0;
            pmrmprop3.rec.PAYMENTKIND = "Э";
            pmrmprop3.rec.PAYERBANKNAME = NAMI ({OurBank});

                if (payer  != _BANK0 )
                    pmrmprop3.rec.PAYERNAME = NAMI (PARTYID);
                    pmrmprop3.rec.RECEIVERNAME = NAMI ({OurBank});
                elif (receiver != _BANK0 )
                    pmrmprop3.rec.PAYERNAME = NAMI ({OurBank});
                    pmrmprop3.rec.RECEIVERNAME = NAMI (PARTYID);
                end;            
            pmrmprop3.rec.RECEIVERBANKNAME = pmrmprop3.rec.PAYERBANKNAME;
            pmrmprop3.rec.PAYDATE = d0;
            pmrmprop3.rec.CLIENTDATE = d0;
                stat = pmrmprop3.insert;
                if (not stat)
                        RunError( "Ошибка при создании новой сделки." );
            end;

	  pmlink3.rec.LINKKIND =1;
	  pmlink3.rec.INITIALPAYMENT =paym3.rec.PAYMENTID;
	  pmlink3.rec.PURPOSEPAYMENT =paym3.rec.PAYMENTID;
	  pmlink3.rec.FIID          = valu;
	  pmlink3.rec.AMOUNT        = su;
	  pmlink3.rec.IPSIGN        ="-";
	  pmlink3.rec.PPSIGN        ="-";
	  pmlink3.rec.DOCKIND       =140;
	  pmlink3.rec.DOCUMENTID    =forexdeal.rec.NETTINGID;
	  pmlink3.rec.CONTRNVERSION =0 ;
	  pmlink3.rec.RESERV        =" ";
	   stat = pmlink3.insert;
           if (not stat)
                RunError( "Ошибка при создании новой сделки." );
           end;
/*
	  spdrprop3.rec.PAYMENTID=paym3.rec.PAYMENTID;
	  spdrprop3.rec.DRAFTID =0;
	  spdrprop3.rec.DEBACCOUNT =" ";
	  spdrprop3.rec.CREDACCOUNT=" ";
	  spdrprop3.rec.DOCUMENTID =forexdeal.rec.NETTINGID;
	  spdrprop3.rec.DOCUMENTKIND =140;
	  spdrprop3.rec.ISMAIN       ="";
	  spdrprop3.rec.MODE         =0;
	   stat = spdrprop3.insert;
           if (not stat)
                RunError( "Ошибка при создании новой сделки." );
           end;
*/



  end;
 end;

     jk=jk+1;    

 //Сформируем платежи pmpaym4.dbt

 if (( jk < ii ) and (masi(jk) != 0 ))
     su=(masi(jk));
     if (su == 0 )
        jk=jk+1;    
        su=(masi(jk));
     end;

     if ( su < 0)
       RECEIVER=partyid;
       PAYER =_BANK0;
     else
       RECEIVER=_BANK0;
       PAYER =partyid;
     end;

     valu=masiv(jk);
     su=abs(masi(jk));

    paym4.rec.DOCKIND = 140;
    paym4.rec.DOCUMENTID = forexdeal.rec.NETTINGID;
    paym4.rec.PURPOSE = 39;    
    paym4.rec.SUBPURPOSE = jk2;
    jk2=jk2+1;

    

    paym4.rec.FIID = valu;
    paym4.rec.PAYFIID = valu;

   paym4.rec.RECEIVER = RECEIVER;
   paym4.rec.PAYER=PAYER;


//    paym4.rec.deliveryKind = g_delivery;

      PayerCodeKind    = 6;

      ReceiverCodeKind = 6;

    paym4.rec.PayerCode = ПолучитьКодСубъекта( paym4.rec.Payer, PayerCodeKind );
    if(paym4.rec.PayerCode == "")
      PayerCodeKind = 1;
      paym4.rec.PayerCode = ПолучитьКодСубъекта( paym4.rec.Payer, PayerCodeKind );
    end;
    paym4.rec.RECEIVERCODE = ПолучитьКодСубъекта( paym4.rec.RECEIVER, ReceiverCodeKind );
    if(paym4.rec.RECEIVERCODE == "")
      ReceiverCodeKind = 1;
      paym4.rec.RECEIVERCODE = ПолучитьКодСубъекта( paym4.rec.RECEIVER, ReceiverCodeKind );
    end;

        
   paym4.rec.PAYERBANKID = {OurBank};
   paym4.rec.RECEIVERBANKID = {OurBank};
        
    paym4.rec.VALUEDATE= d0;
    
    paym4.rec.DEPARTMENT = {NumDprt};
    paym4.rec.CHAPTER = 1;
    paym4.rec.ISPLANPAYM = "X";
    paym4.rec.PAYERCODEKIND = PayerCodeKind;
    paym4.rec.RECEIVERCODEKIND = ReceiverCodeKind;
    paym4.rec.FIID_FUTUREPAYACC = valu;
    paym4.rec.FIID_FUTURERECACC = valu;
    paym4.rec.BASEAMOUNT = su;
    paym4.rec.orderamount = su;
    paym4.rec.AMOUNT = paym4.rec.BASEAMOUNT;
    paym4.rec.payamount = paym4.rec.BASEAMOUNT;
    paym4.rec.BASEFIID = valu;
    paym4.rec.ORDERFIID = valu;

    paym4.rec.PAYERDPBLOCK = -1;
    paym4.rec.RECEIVERDPBLOCK = -1;
    paym4.rec.OPER = {oper};
    paym4.rec.ORIGIN = 3;
    paym4.rec.STARTDEPARTMENT = {NumDprt};
    paym4.rec.ENDDEPARTMENT = {NumDprt};
    paym4.rec.PRIMDOCKIND = 140;
    paym4.rec.COMISSFIID = -1;

       paym4.rec.NETTING  = "";

        stat = paym4.insert;
        if (not stat)
                RunError( "Ошибка при создании новой сделки." );
        end;

  


//debet
                paymprop4.rec.PAYMENTID = paym4.rec.PAYMENTID;
                paymprop4.rec.DEBETCREDIT = 0;
                paymprop4.rec.CODEKIND = 3;
                paymprop4.rec.CODENAME = "БИК";
                paymprop4.rec.BANKCODE = ПолучитьКодСубъекта( {OurBank}, 1 );
                paymprop4.rec.CORSCHEM = -1;
                paymprop4.rec.ISSENDER = "X";
                paymprop4.rec.TRANSFERDATE = paym4.rec.VALUEDATE;
                paymprop4.rec.CORRID = -1;
                paymprop4.rec.OURCORRID = -1;
                paymprop4.rec.GROUP = 2;
                stat = paymprop4.insert;
                if (not stat)
                        RunError( "Ошибка при создании новой сделки." );
            end;
//credit
                paymprop4.rec.PAYMENTID = paym4.rec.PAYMENTID ;
                paymprop4.rec.DEBETCREDIT = 1;
                paymprop4.rec.CODEKIND = 3;
                paymprop4.rec.CODENAME = "БИК";
                paymprop4.rec.BANKCODE = ПолучитьКодСубъекта( {OurBank}, 1 );
                paymprop4.rec.CORSCHEM = -1;
                paymprop4.rec.ISSENDER = "";
                paymprop4.rec.TRANSFERDATE = paym4.rec.VALUEDATE;
                paymprop4.rec.CORRID = -1;
                paymprop4.rec.OURCORRID = -1;
                paymprop4.rec.GROUP = 2;
                stat = paymprop4.insert;
                if (not stat)
                        RunError( "Ошибка при создании новой сделки." );
            end;


//Реквизиты платежа         
            pmrmprop4.rec.PAYMENTID = paym4.rec.PAYMENTID ;
            pmrmprop4.rec.NUMBER = 0;
            pmrmprop4.rec.DATE = d0;
            pmrmprop4.rec.PAYMENTKIND = "Э";
            pmrmprop4.rec.PAYERBANKNAME = NAMI ({OurBank});

                if (payer  != _BANK0 )
                    pmrmprop4.rec.PAYERNAME = NAMI (PARTYID);
                    pmrmprop4.rec.RECEIVERNAME = NAMI ({OurBank});
                elif (receiver != _BANK0 )
                    pmrmprop4.rec.PAYERNAME = NAMI ({OurBank});
                    pmrmprop4.rec.RECEIVERNAME = NAMI (PARTYID);
                end;            
            pmrmprop4.rec.RECEIVERBANKNAME = pmrmprop4.rec.PAYERBANKNAME;
            pmrmprop4.rec.PAYDATE = d0;
            pmrmprop4.rec.CLIENTDATE = d0;
                stat = pmrmprop4.insert;
                if (not stat)
                        RunError( "Ошибка при создании новой сделки." );
            end;

	  pmlink4.rec.LINKKIND =1;
	  pmlink4.rec.INITIALPAYMENT =paym4.rec.PAYMENTID;
	  pmlink4.rec.PURPOSEPAYMENT =paym4.rec.PAYMENTID;
	  pmlink4.rec.FIID          = valu;
	  pmlink4.rec.AMOUNT        = su;
	  pmlink4.rec.IPSIGN        ="-";
	  pmlink4.rec.PPSIGN        ="-";
	  pmlink4.rec.DOCKIND       =140;
	  pmlink4.rec.DOCUMENTID    =forexdeal.rec.NETTINGID;
	  pmlink4.rec.CONTRNVERSION =0 ;
	  pmlink4.rec.RESERV        =" ";
	   stat = pmlink4.insert;
           if (not stat)
                RunError( "Ошибка при создании новой сделки." );
           end;
/*
	  spdrprop4.rec.PAYMENTID=paym4.rec.PAYMENTID;
	  spdrprop4.rec.DRAFTID =0;
	  spdrprop4.rec.DEBACCOUNT =" ";

	  spdrprop4.rec.CREDACCOUNT=" ";
	  spdrprop4.rec.DOCUMENTID =forexdeal.rec.NETTINGID;
	  spdrprop4.rec.DOCUMENTKIND =140;
	  spdrprop4.rec.ISMAIN       ="";
	  spdrprop4.rec.MODE         =0;
	   stat = spdrprop4.insert;
           if (not stat)
                RunError( "Ошибка при создании новой сделки." );
           end;
*/


 end;

//-----------------------------------------------------------------------------



    OnError( RslErrObj ) //А если ошибка - заполняем коммент
        Comment = RslErrObj.Message;
      //  Comment=string(valu)+" "+string(su);
    AbortTrn();



end;



macro sdelnett() 

 
   if (ProcessTrn(0,"CreateNewNett"))

      return 0;
   else        
      msgbox("Сделка не загружена ", Comment);
      return 1;
   end;


end;

 MACRO Newnett();


    asize(mmas,0);
    asize(mmas0,0);
    asize(mmas1,0);
    asize(mmas2,0);
    asize(mmas3,0);
    asize(mmas4,0);
    asize(masi,0);
    asize(masiv,0);
    asize(mab,0);



      jj=0;
      while (jj < 30 )
        mmas1(jj)=" ";
        mmas2(jj)=" ";
        mmas3(jj)=" ";
        mmas4(jj)=" ";
        jj=jj+1;
      end;

      d0={curdate};
      // getdate(d0,"Введите дату неттинга:",10);
      sd0=СДАТ(d0);
      jj=0;


      que="select count(*) from ddvndeal_dbt a, dpmpaym_dbt b where a.t_netting='X' and (b.t_dockind=4813 or  b.t_dockind = 4815) and b.t_documentid=a.t_id "; 
      que=que+" and b.t_valuedate='"+sd0+"'";
       rs = LnGetRecordset(que);
                 if(rs != null)
                   while(rs.moveNext())
                      if (rs.value(0)  == 0 )
                       msgbox("За выбранную итоговых неттингов нет !");
                       return;
                      end;
                   end;
                 end;


      que="select unique(a.t_contractor) from ddvndeal_dbt a, dpmpaym_dbt b where a.t_netting='X' and (b.t_dockind=4813 or  b.t_dockind = 4815) and b.t_documentid=a.t_id "; 
      que=que+" and b.t_valuedate='"+sd0+"'";
       rs = LnGetRecordset(que);
                 if(rs != null)
                   while(rs.moveNext())
                       mmas(jj)=rs.value(0);
                       mmas0(jj)=nami(rs.value(0));
                       jj=jj+1;
                   end;
                 end;

         mmas0(0)=mmas0(0)+"              ";
         jj=menu(mmas0,"Вибиртие контрагента по НЕТТИНГУ :","Вибиртие контрагента по НЕТТИНГУ :");
         if ( mmas(jj) == _BIR )
             partyid=_NKC;
         else
            partyid=mmas(jj);
         end;
         spartyid=string(mmas(jj));
         var0 = 0;

      vsd="";
      que="select unique(a.t_id) from ddvndeal_dbt a, dpmpaym_dbt b where a.t_contractor="+spartyid+" and a.t_netting='X' and (b.t_dockind=4813 or  b.t_dockind = 4815) and b.t_documentid=a.t_id "; 
      que=que+" and b.t_valuedate='"+sd0+"'";
      rs = LnGetRecordset(que);
                 if(rs != null)
                   while(rs.moveNext())
                     vsd=vsd+string(rs.value(0))+";";
                   end;
                 end;


         asize(mmas,0);
         mmas(0)="                        ";
         ii=0;
         kk=0;

      que="select unique(b.t_fiid) from ddvndeal_dbt a, dpmpaym_dbt b where a.t_contractor="+spartyid+" and a.t_netting='X' and (b.t_dockind=4813 or  b.t_dockind = 4815) and b.t_documentid=a.t_id "; 
      que=que+" and b.t_valuedate='"+sd0+"'";
      rs = LnGetRecordset(que);
      if(rs != null)
        while(rs.moveNext())
          ii=ii+1;
          val=string(rs.value(0));
             masiv(ii)=val;
             if ( ii == 1 )
               mmas1(0)= N_fiid(val) ;
             elif ( ii == 2 )
               mmas2(0)= N_fiid(val) ;
             elif ( ii == 3 )
               mmas3(0)= N_fiid(val) ;
             elif ( ii == 4 )
               mmas4(0)= N_fiid(val) ;
             end;
          i=1;
          su=0;

          que="select b.t_payer,b.t_receiver,(case when b.t_baseamount=0.01 then 0 else b.t_baseamount end),a.t_code  from ddvndeal_dbt a, dpmpaym_dbt b where a.t_contractor="+spartyid+" and a.t_netting='X' and (b.t_dockind=4813 or  b.t_dockind = 4815) and b.t_documentid=a.t_id "; 
          que=que+" and b.t_valuedate='"+sd0+"' and b.t_fiid="+val;
          rs0 = LnGetRecordset(que);
          if(rs0 != null)
           while(rs0.moveNext())
             payer =rs0.value(0);
             receiver=rs0.value(1);
             baseamount=rs0.value(2);
             dealcode=SDEL(rs0.value(3),14);
             if ( ii == 1 )
               if (payer != _BANK0 )
                 su=su+baseamount;
                 mmas1(i)=dealcode+"  +"+string(baseamount:a);
               elif (receiver != _BANK0 )
                 su=su-baseamount;
                 mmas1(i)=dealcode+"  -"+string(baseamount:a);
               end;
             elif ( ii == 2 )
               if (payer != _BANK0 )
                 su=su+baseamount;
                 mmas2(i)=dealcode+"  +"+string(baseamount:a);
               elif (receiver != _BANK0 )
                 su=su-baseamount;
                 mmas2(i)=dealcode+"  -"+string(baseamount:a);
               end;

             elif ( ii == 3 )
               if (payer != _BANK0 )
                 su=su+baseamount;
                 mmas3(i)=dealcode+"  +"+string(baseamount:a);
               elif (receiver != _BANK0 )
                 su=su-baseamount;
                 mmas3(i)=dealcode+"  -"+string(baseamount:a);
               end;
             elif ( ii == 4 )
               if (payer != _BANK0 )
                 su=su+baseamount;
                 mmas4(i)=dealcode+"  +"+string(baseamount:a);
               elif (receiver != _BANK0 )
                 su=su-baseamount;
                 mmas4(i)=dealcode+"  -"+string(baseamount:a);
               end;
             end;
 
             i=i+1;
           end;
          end;

         if ( kk < i )
            kk=i;
         end;
          masi(ii)=su;
        end;
      end;

      ii=ii+1;
      kk=kk+1;
      jj=0;
      i=1;

      while (jj < kk )

        mmas(jj)=SDEL(mmas1(jj),30);
        i=i+1;
        if (ii > 2 )
          mmas(jj)=mmas(jj)+SDEL(mmas2(jj),30);
          i=i+1;
        end;


        if (ii > 3 )
          mmas(jj)=mmas(jj)+SDEL(mmas3(jj),30);
          i=i+1;
        end;
        if (ii > 4 )
          mmas(jj)=mmas(jj)+SDEL(mmas4(jj),30);
          i=i+1;
        end;

        jj=jj+1;
      end;


       i=1;
       mmas(jj)=" ";
       mmas(jj+1)=" ";
       while ( i < ii )
           mm=masi(i);
           mm=string(mm:a);
           mmas(jj)=mmas(jj)+"------------------------------";
             if ( i < 4 )
              mmas(jj+1)=mmas(jj+1)+SDEL("               "+mm,30);
             else
              mmas(jj+1)=mmas(jj+1)+mm;
             end;
             if (masi(i) == 0 )
                fet=fet+" "+N_fiid(masiv(i));
             end;

        i=i+1;
       end;

       ma(1)=8;
       zz=2;

       asize(mmas0,0);
       asize(mmas1,0);
       ii2=ii;
       jj=1;
       j=1;
       while ( j < ii ) 

         i=0;
         es0=0;
         while (i < ii) 
           if (masiv(j) == ma(i) )
              es0=1;
           end;
           i=i+1;
         end;
         if ( es0 == 1 )
           mmas0(jj)=masiv(j);
           mmas1(jj)=masi(j);
           jj=jj+1;
         end;
         j=j+1;
       end;

       j=1;
       while ( j < jj ) 
          masiv(j)=mmas0(j);
          masi(j)=mmas1(j);
         j=j+1;
       end;

       ii=jj;
       sdelnett();

end;





