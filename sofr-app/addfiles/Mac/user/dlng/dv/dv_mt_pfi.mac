import "dv_categ.mac","dv_car.mac","dvswift.mac","dvswiftMT300.mac"
;

const TRANSP_SPFSCBR = 51; //А.Киселев 29.03.2019 пользовательский транспорт СПФСЦБРФ

private macro IsBank(pid) //Является ли контрагент банком
  var sql,rs;
  sql = "select 1 from dpartyown_dbt n where n.t_partyid = "+pid+" and n.t_partykind = 2";
  rs = ExecSqlSelect(sql);

  if (rs.MoveNext())
    if (rs.value(0) == 1)
      return true;
    else
      return false;
    end;
  end;
  return false;
end;

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )
  record ndeal(dvndeal);
  var FD;

  SetBuff( ndeal, FDoc );
  FD = DVFirstDocNDeal(DocKind, ndeal);

  /*PNV*/
  if (FD.Биржевая())
    return 0;
  end;
  /*PNV*/

  if (IsBank(FD.deal.rec.contractor)) 
    if (FD.IsOption() and (FD.deal.rec.contractor != {OurBank})) /*DAN Для опционов с БИО контрагентом выступает Наш Банк. В этом случае отправка сообщения не требуется*/
      if (FD.ВидБазовогоАктива() == FIKIND_AVOIRISS)
        msgbox("Базовым активом в сделке является ценная бумага. Сообщение не будет создано.");
        return 0;
      elif (FD.BaseFI().rec.FI_Kind == FIKIND_INDEX)
        msgbox("Базовым активом в сделке является индекс. Сообщение не будет создано.");
        return 0;
      end; 
      DV_MsgSWIFT_MT305(FD.deal.rec.Id);
      //DV_DealsGenMes(ndeal.docKind,ndeal.ID,300);
      return 0;
    elif (FD.IsPctSWAP())
      if (FD.БазовыеВалютыРавны())
        DV_MsgSWIFT_MT360(FD.deal.rec.Id);
      else
        DV_MsgSWIFT_MT361(FD.deal.rec.Id);
      end;
      return 0;
    //А.Киселев 05.04.2019
    elif ( (FD.IsForward() or FD.IsSWAP() or (FD.deal.rec.kind == 12730)) /*and (FD.deal.rec.CONFTPID == 2)*/) //Если установлен в сделке транспорт - SWIFT //TEG 10.02.19 добавил тип документа для формирования 300
      /* ВР. Для расчётного контракта ПФИ платежи пока не создаются. Подтверждение cформировать невозможно */ 
      if((FD.Kind == DL_DVNDEAL) and (FD.NFI_BaseActiv.rec.ExecType == 0))
        //return 0;
      end;

      /*PNV*/
      if (FD.ВидБазовогоАктива() == FIKIND_METAL)
        msgbox("Базовым активом в сделке является металл. Сообщение не будет создано.");
        return 0;
      end; 
      /*PNV*/
      if( (ndeal.ConfTpId == TRANSP_SWIFT) or (ndeal.ConfTpId == TRANSP_TELEX))
        DV_DealsGenMes(ndeal.docKind, ndeal.ID, 300, TRANSP_SWIFT);
      elif((ndeal.ConfTpId == TRANSP_SPFSCBR))
        if( (ndeal.TYPE == 1) or (ndeal.TYPE == 2) or (ndeal.TYPE == 6) or (ndeal.TYPE == 5) )
          DV_DealsGenMesMT300Paym( ndeal.ID, ndeal.docKind);
        end; 
      end;
      return 0;
    else
      return 0;
    end;
  end; 

  return 0;
end;

MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -откат шага*/
                errTrn,           /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,         /* Указатель на первичный документ */
                ID_Operation,     /* Номер экземпляра операции */
                Num_Step,         /* Номер шага операции(из настроек) */
                Kind_Operation,   /* Вид операции */
                KindDoc,          /* Вид первичного документа */
                KindStep,         /* Вид шага операции */
                ID_Step)          /* Номер шага операции */  

  record ndeal(dvndeal);
  var FD,sql,rs;
  
  SetBuff( ndeal, FirstDoc );
  FD = DVFirstDocNDeal(Kind_Operation, ndeal);

  if ( CommitOrRollback == 1 )
    if (FD.IsOption())
      //sql = "UPDATE ddvndeal_dbt d SET d.t_conftpid = 2 WHERE d.t_id = "+FD.deal.rec.id;
      //rs = ExecSql(sql);
    end;
  end;

  return 0;
END;
