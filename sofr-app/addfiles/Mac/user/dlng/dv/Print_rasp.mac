/*
$Name:         
$Module:       ФИССиКО
$Description:  Печать распоряжений по сделкам ФИССиКО
               Петрушина Н.
*/
IMPORT RsbDataSet, dlquery, "dv_car.mac", dlwreps;

/*вытащить из комментария номер подтверждения*/
PRIVATE MACRO Get_Num_Doc (str)
  var str1 = "", str2 = "", str3 = "";

  if (index (str, "подтверждение") > 0) 
      str1 = trim(substr(str, index (str, "подтверждение") + strlen("подтверждение "), 9999));
  elif (index (str, "Подтверждение") > 0) 
      str1 = trim(substr(str, index (str, "Подтверждение") + strlen("Подтверждение "), 9999));
  else
      str1 = "";
  end;
  str2 = substr(str1, index (str1, " "));
  str3 = substr( str1, 1, strlen(str1) - strlen(substr(str1, index (str1, " "))));
  return ( str3);
END;

PRIVATE MACRO Get_NumToStr(num:money, fiid:integer)
  var rub :string = "",
      kop :string = "",
      s1  :string;

  var cmd :object = NULL,
  rs  :object = NULL;

  cmd = RsdCommand("select * from dfininstr_dbt where t_fiid = ?");
  cmd.addParam("fiid", RSDBP_IN, fiid);
  cmd.execute;
  rs = RsdRecordset(cmd);

  if (not rs.movenext())
    return "";
  end;

  s1 = CurToStrAlt(num, rub, kop, int(rs.value("t_iso_number")));
  s1 = trim(StrSubSt(s1, rub, ""));
  s1 = trim(StrSubSt(s1, SubStr(s1, index(s1, kop)), ""));

  return num + " " + s1;
END;

PRIVATE MACRO get_party_name_HasInvalidSymbol(partyid)
  var cmd, rs;
//cmd = RsdCommand("select distinct Substr(REGEXP_REPLACE (T_SHORTNAME, '[/\+="":;,?*<>|<]' ), 0, 100) partyname from dparty_dbt where t_partyid = ?");/*[^а-яА-Я ]*/
  cmd = RsdCommand("select distinct Substr(REGEXP_REPLACE (T_SHORTNAME, '[/\+=:;,?*<>|<]' ), 0, 100) partyname from dparty_dbt where t_partyid = ?");/*[^а-яА-Я ]*/

  cmd.addParam("partyid", RSDBP_IN, partyid);
  cmd.execute;
  rs = TRsbDataSet(cmd);

  if (not rs.movenext())
    return "";
  else
    return trim(StrSubst ( rs.partyname, "\"", "" )); 
  end;
END;

MACRO СформироватьРаспоряжение(ДатаШага, FD, Платеж, Шаблон)
//    var FileName = "", TempFile = "", ArchFileName = "C:\\SOFR\\EXPORT\\Распоряжения\\" + "Распоряжение " + get_party_name_HasInvalidSymbol(Платеж.rec.payer) + FD.deal.rec.id + ".docx";
    var FileName = "", TempFile = "", ArchFileName = "C:\\SOFR\\EXPORT\\Распоряжения\\" + "Распоряжение " + get_party_name_HasInvalidSymbol(Платеж.rec.payer) +" по сделке "+ StrSubst(FD.deal.rec.Code,":"," ") + ".docx";
        SetOutput(NULL, false);  
        TempFile = string("..\\TxtFile\\Rasp_Konv." + StrSubst(String(time), ":", ""));
        SetOutPut(TempFile, false);
        println(Шаблон); //Имя файла-шаблона
        println( "PN", FD.deal.rec.id );
        //println("Rasp_Konv");

        [~M0];
   	println(FD.GenAgr().rec.code);
   	[~M1];
   	println(StrSubSt(String(date(FD.GenAgr().rec.start):f ), ".", "/"));
   	[~M2];
   	println(DV_GetPartyName(Платеж.rec.payerbankid));
   	[~M3];
   	println(DV_GetPartyName(Платеж.rec.payer));
   	[~M4];
   	println(FD.deal.rec.code);
   	[~M5];
   	println(StrSubSt(String(FD.deal.rec.date:f ), ".", "/"));
   	[~M6];
   	println(Get_NumToStr(Платеж.rec.baseamount, Платеж.rec.basefiid));
   	[~M7];
   	println(StrSubSt(CB_GetFormattedAcnt(1, Платеж.rec.payeraccount), ".", " "));
   	[~M8];
   	println(StrSubSt(String(Платеж.rec.valuedate:f ), ".", "/"));
   	[~M9];
   	println(StrSubSt(CB_GetFormattedAcnt(1, Платеж.rec.receiveraccount), ".", " "));
   	[~M10];
   	println(StrSubSt(String(FD.deal.rec.date:f ), ".", "/"));
   	[~M11];
   	println(Get_Num_Doc (String(FD.deal.rec.comment)));
   	[~M12];
   	println(StrSubSt(String(FD.deal.rec.date:f ), ".", "/"));
   	[~M13];
   	println(FD.GenAgr().rec.code);
   	[~M14];
   	println(StrSubSt(String(date(FD.GenAgr().rec.start):f ), ".", "/"));
 
       TempFile = SetOutput(null, false);
       /* Завершение вывода */

       if( MsgBoxEx( "Открыть Распоряжение?", MB_YES+MB_NO, IND_NO ) == IND_NO )           
           DLWREPS_PrintReportFromTagFile (TempFile, @FileName, true, true  );
/*
          if(IsStandAlone) /*Двухзвенка*/
             RemoveFile ( ArchFileName );
             if(not CopyFile(FileName, ArchFileName))
                msgbox("Ошибка при копировании файла|" + FileName + "|в каталог архива|" + ArchFileName);
             end;
          else /*Трехзвенка*/
             RemoveFile ("$" + ArchFileName);
             if(not CopyFile("$" + FileName,"$" +  ArchFileName))
                msgbox("Ошибка при копировании файла|" + FileName + "|в каталог архива|" + ArchFileName);
             end;
          end;
*/
       else
//           DLWREPS_PrintReportFromTagFile (TempFile);
           DLWREPS_PrintReportFromTagFile (TempFile, @FileName, false, true  );
       end;                         

       if(IsStandAlone) /*Двухзвенка*/
          RemoveFile ( ArchFileName );
          if(not CopyFile(FileName, ArchFileName))
             msgbox("Ошибка при копировании файла|" + FileName + "|в каталог архива|" + ArchFileName);
          end;
       else /*Трехзвенка*/
          RemoveFile ("$" + ArchFileName);
          if(not CopyFile(FileName,"$" +  ArchFileName))
             msgbox("Ошибка при копировании файла|" + FileName + "|в каталог архива|" + ArchFileName);
          end;
       end;

 END;
