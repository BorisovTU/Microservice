/*
2018.11.19 
№ задачи РСХБ - 615
обработка биржевых свидетельств
ipgem
*/
IMPORT rsexts, oralib;
var scd;

private macro dtToddmmyy(dt)
  private var retval=string(dt);
  retval = trim(substr(retval,1,2)+"."+substr(retval,4,2)+"."+substr(retval,9,2));
  if(strlen(retval)==7)
    retval = "0"+retval;
  end;
  return retval;
end;


private macro dtToddmmyyyy(dt)
  private var retval;
  retval=trim(substr(string(dt),1,10));
  if (substr(retval,3,1) != "." )
     retval="0"+retval;
  end; 
  return retval;
end;


private macro AddCol (ar,ind, fld, head, width, fldType,decPoint)
  ar.value (ind * 6)      = fld;
  ar.value (ind * 6 + 1)  = head;
  ar.value (ind * 6 + 2)  = width;
  ar.value (ind * 6 + 3 ) = fldType; 
  ar.value (ind * 6 + 4 ) = decPoint;
  ar.value (ind * 6 + 5 ) = 0;   // reserv
end;

//загрузить данные по биржевым свидетельствам DSTD_BS_DBT
class TYSTD_BS()
  var 
      selzag    = "Данные по биржевым свидетельствам",
      selpodv   = "ESC - Выход; F8 - Удалить; F9-Загрузить",
      revers    = 0,
      cd        = dtToddmmyy(date()),
      withQue   = false,
      withMes   = true,
      withrelo  = false,
      //inDir     = "..\\Import\\VRMICEX",
      //inDirArh  = "..\\Import\\VRMICEX\\ARH",
      inDir     = "\\\\sgo-fc01-r03.go.rshbank.ru\\sofr_for_etl\\inbox\\MMVB\\VRMICEX",
      inDirArh  = "\\\\sgo-fc01-r03.go.rshbank.ru\\sofr_for_etl\\inbox\\MMVB\\VRMICEX\\ARH",
      flMask    = "MB01347_CCX4P_*.xml",
      t_vdate   = date(0,0,0),
      CURRENCY  = TArray(),
      t_number  = "",
      t_status  = 0;

  class tycur()
    var 
      withQue   = false,
      withMes   = true,
      withrelo  = false,
      t_vdate   = date(0,0,0),
      t_fiid    = -1,
      curId     = "",
      t_pamount = money(0),
      t_ramount = money(0),
      t_debetVM = money(0),
      t_kredetVM = money(0),
      DataType  = "",
      t_number  = "",
      t_status  = 0;

    macro check_STD_BS()
      private var sql;
      sql = "select nvl(count(*),0) from DSTD_BS_DBT where t_fiid="+t_fiid+" and t_vdate=to_date('"+t_vdate+"','dd.mm.yyyy')";
      sql = RsdRecordset(sql);
      if(sql.moveNext)
        if(sql.value(0)>0)
          sql = null;
          return true;
        end;
      end;
      sql = null;
      return false;
    onerror
      return false;
    end;
  
    macro ins_STD_BS()
      private var sql,isdo=false;
      if((t_fiid>=0) and (t_vdate>date(0,0,0)))
        if(check_STD_BS())
          isdo = false;
          if(withQue)
            if(getTrue(false,"Валюта "+curId+" за "+t_vdate+" присутствует в таблице. Добавить?"))
              isdo=true;
            end;
          elif(withrelo)
            isdo=true;
          end;
        else
          isdo=true;
        end;
        if(isdo)
          // sql = "insert into DSTD_BS_DBT (t_id,t_vdate,t_fiid,t_pamount,t_ramount,t_status) values (0,to_date('"+t_vdate+"','dd.mm.yyyy'),"+t_fiid+","+t_pamount+","+t_ramount+","+t_status+")";
          sql = "insert into DSTD_BS_DBT (t_id,t_vdate,t_fiid,t_pamount,t_ramount,t_debetvm,t_kredetvm,t_status)"+
                " values (0,to_date('"+scd+"','dd.mm.yyyy'),"+t_fiid+","+t_pamount+","+t_ramount+","+t_debetVM+","+t_kredetVM+","+t_status+")";
          sql = RSDCommand(sql);
          sql.execute();
          sql = null;
        end;
      end;
    onerror
      if(withMes)
        println("Ошибка вставки записи в DSTD_BS_DBT для t_fiid="+t_fiid+" и t_vdate="+t_vdate);
      end;
      return false;
    end;

  end;

  macro getFIId(fin)
    private var sql,retval=-1;
    private var CCY;
    if ((trim(fin) == "GLD") or (trim(fin) == "SLV"))
    if (trim(fin) == "GLD")
          CCY="XAU";
       elif  (trim(fin) == "SLV")
          CCY="XAG";
       end;   
       sql = "select t_fiid from dfininstr_dbt where T_CCY='"+CCY+"' and t_fi_kind=6";
    else
      sql = "select t_fiid from dfininstr_dbt where upper(T_CCY) like '"+strupr(fin)+"'";
    end;
    sql = RsdRecordset(sql);
    if(sql.moveNext)
      retval = sql.value("t_fiid");
    end;
    sql = null;
    return retval;
  onerror
    return retval;
  end;

  macro loadOneFl(fln)
    private var xml:object = ActiveX( "MSXML.DOMDocument" ),NodeList,i,k,l,sql;
    if(xml.load(fln))
      NodeList = xml.selectNodes("MICEX_DOC");
      if(NodeList.length>0)
        NodeList = NodeList.item(0).selectNodes("CCX04");
        if(NodeList.length>0)
          NodeList = NodeList.item(0);
          if(NodeList.attributes.length>0)
            i = 0;
            while(i<NodeList.attributes.length)
              if(NodeList.attributes.item(i).nodeName=="ReportDate")
                t_vdate = NodeList.attributes.item(i).nodeValue;
                t_vdate = date(int(substr(t_vdate,9,2)),int(substr(t_vdate,6,2)),int(substr(t_vdate,1,4)));
              elif(NodeList.attributes.item(i).nodeName=="ClearingFirmId")
                t_number = NodeList.attributes.item(i).nodeValue;
              end;
              i = i+1;
            end;
          else
            if(withMes)
              println("Ошибка нахождения атрибутов у тэга CCX04");
              return false;
            end;
          end;
          NodeList = NodeList.selectNodes("SETTLE");
          if(NodeList.length>0)
            NodeList = NodeList.item(0);
            NodeList = NodeList.selectNodes("CURRENCY");
            if(NodeList.length>0)
              i = 0;
              CURRENCY             = null;
              CURRENCY             = TArray();
              while(i<NodeList.length)
                CURRENCY[i]          = tycur();
                CURRENCY[i].withQue  = withQue;
                CURRENCY[i].withrelo = withrelo;
                CURRENCY[i].withMes  = withMes;
                CURRENCY[i].t_vdate  = t_vdate;
                CURRENCY[i].t_number = t_number;
                if(NodeList.item(i).attributes.length>0)
                  k = 0;
                  while(k<NodeList.item(i).attributes.length)
                    if(NodeList.item(i).attributes(k).nodeName=="CurrencyId")
                      CURRENCY[i].curId  = NodeList.item(i).attributes(k).nodeValue;
                      CURRENCY[i].t_fiid = getFIId(CURRENCY[i].curId);
                      if(CURRENCY[i].t_fiid<0)
                        if(withMes)
                          println("Ошибка нахождения финансового инструмента по коду "+CURRENCY[i].curId);
                        end;
                      end;
                    end;
                    k = k+1;
                  end;
                else
                  if(withMes)
                    println("Ошибка нахождения атрибутов у тэга CURRENCY, id: "+i);
                  end;
                end;
                if(CURRENCY[i].t_fiid>=0)
                  if(NodeList.item(i).selectNodes("RECORDS").length>0)
                    k = 0;
                    while(k<NodeList.item(i).selectNodes("RECORDS").length)
                      if(NodeList.item(i).selectNodes("RECORDS").item(k).attributes.length>0)
                        l = 0;
                        var VM=0;
                        while(l<NodeList.item(i).selectNodes("RECORDS").item(k).attributes.length)
                          if(NodeList.item(i).selectNodes("RECORDS").item(k).attributes(l).nodeName=="DataType")
                             CURRENCY[i].DataType = NodeList.item(i).selectNodes("RECORDS").item(k).attributes(l).nodeValue;
                             if (CURRENCY[i].DataType=="FX_VM") // для определения того вармаржа или остальное
                                VM=1;
                             else    
                                VM=0;
                             end;
                          elif(NodeList.item(i).selectNodes("RECORDS").item(k).attributes(l).nodeName=="Debit")
                             if (VM==1)
                                CURRENCY[i].t_debetVM = CURRENCY[i].t_debetVM+money(NodeList.item(i).selectNodes("RECORDS").item(k).attributes(l).nodeValue);
                             else
                                CURRENCY[i].t_pamount = CURRENCY[i].t_pamount+money(NodeList.item(i).selectNodes("RECORDS").item(k).attributes(l).nodeValue);
                             end; 
                          elif(NodeList.item(i).selectNodes("RECORDS").item(k).attributes(l).nodeName=="Credit")
                             if (vm==1)
                                CURRENCY[i].t_kredetVM  = CURRENCY[i].t_kredetVM+money(NodeList.item(i).selectNodes("RECORDS").item(k).attributes(l).nodeValue);
                             else
                                CURRENCY[i].t_ramount = CURRENCY[i].t_ramount+money(NodeList.item(i).selectNodes("RECORDS").item(k).attributes(l).nodeValue);
                             end;
                          end;
                          l = l+1;
                        end;
                      else
                        if(withMes)
                          println("Ошибка нахождения атрибутов у тэга RECORDS, i: "+i+", k: "+k);
                        end;
                      end;
                      k = k+1;
                    end;
                  else
                    if(withMes)
                      println("Ошибка нахождения потомка RECORDS у тэга CURRENCY, i: "+i);
                    end;
                  end;
                end;
                i = i+1;
              end;
              i = 0;
              while(i<CURRENCY.size)
                CURRENCY[i].ins_STD_BS();
                i = i+1;
              end;
            else
              if(withMes)
                println("Ошибка нахождения тэга CURRENCY");
                return false;
              end;
            end;
          else
            if(withMes)
              println("Ошибка нахождения тэга SETTLE");
              return false;
            end;
          end;
        else
          if(withMes)
            println("Ошибка нахождения тэга CCX04");
            return false;
          end;
        end;
      else
        if(withMes)
          println("Ошибка нахождения тэга MICEX_DOC");
          return false;
        end;
      end;
      NodeList = null;
    end;
    xml = null;
    return true;
  onerror
    if(withMes)
      println("Ошибка загрузки xml-файла: "+fln);
    end;
    return false;
  end;

  macro loadFromDir()
    private var ninDir,ninDirArh,cdir,files,i=0;
    if(ExistFile(inDir+"\\"+cd))
      ninDir = inDir+"\\"+cd;
      cdir   = ninDir+"\\"+flMask;
      files  = TDirList(cdir);
      InitProgress(files.count,"Ждите. Идет загрузка файлов...","Ждите. Идет загрузка файлов...");
      if(files.count>2)
        while(i<files.count)
          if(not files.isDir(i))
            if(loadOneFl(ninDir+"\\"+files.name(i)))
              if(ExistFile(inDirArh))
                ninDirArh = inDirArh+"\\"+cd;
                if(not ExistFile(ninDirArh))
                  MakeDir(ninDirArh);
                end;
                if(ExistFile(ninDirArh))
                  if(not copyFile(ninDir+"\\"+files.name(i),ninDirArh+"\\"+files.name(i)))
                    if(withMes)
                      println("Ошибка копирования файла "+files.name(i)+" в директорию архива"+ninDirArh);
                    end;
                  else
                    if(not RemoveFile(ninDir+"\\"+files.name(i)))
                      if(withMes)
                        println("Ошибка удаления исходного файла "+files.name(i)+" после архивации");
                      end;
                    end;
                  end;
                else
                  if(withMes)
                    println("Отсутствует директория для архивирования "+ninDirArh+" исходного файла "+files.name(i));
                  end;
                end;
              else
                if(withMes)
                  println("Отсутствует директория для архивирования "+inDirArh+" исходного файла "+files.name(i));
                end;
              end;
            end;
          end;
          i = i+1;
          UseProgress(i);
        end;
      else
        if(withMes)
          println("Отсутствуют файлы в каталоге "+ninDir);
        end;
      end;
      RemProgress(i);
      files = null;
    else
      if(withMes)
        println("Отсутствуют каталог импорта "+inDir+"\\"+cd);
      end;
    end;
  onerror
    if(withMes)
      println("Ошибка сканирования входного каталога: "+inDir+"\\"+cd+", маска: "+flMask);
    end;
  end;

  macro AProc (rs, cmd, id, key )
    private var sql,pv;
    if(cmd == DLG_KEY)
      if(key == 13)/*Enter*/
        return CM_SELECT;
      elif(key == 32)/*ESC*/
        return CM_CANCEL;
      elif(key == 322)/*F8*/
        if(GetTrue(false,"Вы действительно хотите удалить запись?"))
          sql = "delete from dstd_bs_dbt where t_id="+rs.value("t_id");
          sql = RSDCommand(sql);
          sql.execute();
          this.revers = 1;
          sql = null;
          return CM_SELECT;
        end;
        return CM_IGNORE;
      elif(key == 323)/*F9*/
        if(GetTrue(false,"Загрузить файлы?"))
          pv      = withQue;
          withQue = true;
          flMask  = "MB01347_CCX4P_*.xml";
          loadFromDir();
          flMask  = "MB01347_CCX04_*.xml";
          loadFromDir();
          revers  = 1;
          withQue = pv;
          return CM_SELECT;
        end;
        return CM_IGNORE;
      end;
    end;
  onerror
    Msgbox("Ошибка выполнения действия обрботчика скроллинга!!!");
    return CM_IGNORE;
  end;

  macro select(visual,dop)
    private var rs,issel=1;
    private var cr=TArray;

    AddCol (cr , 0, "t_vdate"   , "Дата"         ,  9, 1);
    AddCol (cr , 1, "val"       , "Вал"          ,  4, 1);
    AddCol (cr , 2, "t_pamount" , "Дебет"        , 14, 2);
    AddCol (cr , 3, "t_ramount" , "Кредит"       , 14, 2);

    rs = "select s.t_id,s.t_vdate,(select T_CCY from dfininstr_dbt where t_fiid=s.t_fiid) val,s.t_pamount,s.t_ramount from dstd_bs_dbt s where s.t_id>=0 "+dop+" order by s.t_id desc";
    rs = ExecSQLSelect(rs, null, false, RSDVAL_CLIENT, RSDVAL_STATIC);
    if(visual)
      if(not RunScroll(rs,4,cr,null,R2M(this,"AProc"),selzag,selpodv,false,5,2,48,15))
        issel=0;
      else
        if(revers==1)
          revers=0;
          this.select(visual,dop);
        end;
      end;
    end;
    if(issel)
      return true;
    end;
    return false;
  end;

end;

//загрузить данные по комиссиям DSTD_BSKOM_DBT
class TYSTD_BSKOM()
  var 
      selzag   = "Данные по комиссиям",
      selpodv  = "ESC - Выход; F8 - Удалить; F9-Загрузить",
      revers   = 0,
      cd       = dtToddmmyy(date()),
      withQue  = false,
      withMes  = true,
      withrelo = false,
     // inDir    = "..\\Import\\VRMICEX",
     // inDirArh = "..\\Import\\VRMICEX\\ARH",
        inDir     = "\\\\sgo-fc01-r03.go.rshbank.ru\\sofr_for_etl\\inbox\\MMVB\\VRMICEX",
        inDirArh  = "\\\\sgo-fc01-r03.go.rshbank.ru\\sofr_for_etl\\inbox\\MMVB\\VRMICEX\\ARH",
      flMask   = "MB01347_CCX10_*.xml",
      CURline  = TArray();

  class tycur()
    var 
      withQue  = false,
      withMes  = true,
      withrelo = false,
      t_vdate  = date(0,0,0),
      t_number = 0,
      t_name   = "",
      t_amount = money(0),
      t_type   = 0;

    macro check_STD_BSKOM()
      private var sql;
      sql = "select nvl(count(*),0) from DSTD_BSKOM_DBT where t_number="+t_number+" and t_vdate=to_date('"+t_vdate+"','dd.mm.yyyy')";
      sql = RsdRecordset(sql);
      if(sql.moveNext)
        if(sql.value(0)>0)
          sql = null;
          return true;
        end;
      end;
      sql = null;
      return false;
    onerror
      return false;
    end;
  
    macro ins_STD_BSKOM()
      private var sql,isdo=false;
      if((t_number>0) and (t_vdate>date(0,0,0)))
        if(check_STD_BSKOM())
          isdo = false;
          if(withQue)
            if(getTrue(false,"Комиссия "+t_number+" за "+t_vdate+" присутствует в таблице. Добавить?"))
              isdo=true;
            end;
          elif(withrelo)
            isdo=true;
          end;
        else
          isdo=true;
        end;
        if(isdo)
          // sql = "insert into DSTD_BSKOM_DBT (t_id,t_vdate,t_number,t_name,t_amount) values (0,to_date('"+t_vdate+"','dd.mm.yyyy'),"+t_number+",'"+t_name+"',"+t_amount+")";
          sql = "insert into DSTD_BSKOM_DBT (t_id,t_vdate,t_number,t_name,t_amount,t_typecom) values (0,to_date('"+scd+"','dd.mm.yyyy'),"+t_number+",'"+t_name+"',"+t_amount+","+t_type+")";
          sql = RSDCommand(sql);
          sql.execute();
        end;
      end;
    onerror
      if(withMes)
        println("Ошибка вставки записи в DSTD_BSKOM_DBT для t_number="+t_number+" и t_vdate="+t_vdate);
      end;
      return false;
    end;

  end;

  macro loadOneFl(fln)
    private var xml:object = ActiveX( "MSXML.DOMDocument" ),NodeList,i,k,l,sql,curli=0,typecom;
    if(xml.load(fln))
      NodeList = xml.selectNodes("MICEX_DOC");
      if(NodeList.length>0)
        NodeList = NodeList.item(0).selectNodes("CCX10");
        if(NodeList.length>0)
          NodeList = NodeList.item(0);
          NodeList = NodeList.selectNodes("SETTLE1");
          if(NodeList.length>0)
            NodeList = NodeList.item(0);
            NodeList = NodeList.selectNodes("TYPE");
            if(NodeList.length>0)
              curli    = 0;
              CURline  = null;
              CURline  = TArray();
              i = 0;
              while(i<NodeList.length)
                if(NodeList.item(i).selectNodes("RECORDS").length>0)
                  k = 0;
                  while(k<NodeList.item(i).selectNodes("RECORDS").length)
                    CURline[curli]          = tycur();
                    CURline[curli].withQue  = withQue;
                    CURline[curli].withrelo = withQue;
                    CURline[curli].withMes  = withMes;
                    CURline[curli].t_type = NodeList.item(i).attributes(0).nodeValue;
                    if(NodeList.item(i).selectNodes("RECORDS").item(k).attributes.length>0)
                      l = 0;
                      while(l<NodeList.item(i).selectNodes("RECORDS").item(k).attributes.length)
                        if(NodeList.item(i).selectNodes("RECORDS").item(k).attributes(l).nodeName=="CommisType")
                          CURline[curli].t_number = NodeList.item(i).selectNodes("RECORDS").item(k).attributes(l).nodeValue;
                        elif(NodeList.item(i).selectNodes("RECORDS").item(k).attributes(l).nodeName=="CommisName")
                          //CURline[curli].t_name = substr(NodeList.item(i).selectNodes("RECORDS").item(k).attributes(l).nodeValue,1,40);
                          CURline[curli].t_name = NodeList.item(i).selectNodes("RECORDS").item(k).attributes(l).nodeValue;
                        elif(NodeList.item(i).selectNodes("RECORDS").item(k).attributes(l).nodeName=="DateFrom")
                          CURline[curli].t_vdate = NodeList.item(i).selectNodes("RECORDS").item(k).attributes(l).nodeValue;
                          CURline[curli].t_vdate = date(int(substr(CURline[curli].t_vdate,9,2)),int(substr(CURline[curli].t_vdate,6,2)),int(substr(CURline[curli].t_vdate,1,4)));
                        elif(NodeList.item(i).selectNodes("RECORDS").item(k).attributes(l).nodeName=="Comm")
                          CURline[curli].t_amount = money(NodeList.item(i).selectNodes("RECORDS").item(k).attributes(l).nodeValue);
                        end;
                        l = l+1;
                      end;
                    else
                      if(withMes)
                        println("Ошибка нахождения атрибутов у тэга RECORDS, i: "+i+", k: "+k);
                      end;
                    end;
                    k = k+1;
                    curli = curli+1;
                  end;
                else
                  if(withMes)
                    println("Ошибка нахождения потомка RECORDS у тэга TYPE, i: "+i);
                  end;
                end;
                i = i+1;
              end;
              i = 0;
              while(i<CURline.size)
                CURline[i].ins_STD_BSKOM();
                i = i+1;
              end;
            else
              if(withMes)
                println("Ошибка нахождения тэга TYPE");
                return false;
              end;
            end;
          else
            if(withMes)
              println("Ошибка нахождения тэга SETTLE1");
              return false;
            end;
          end;
        else
          if(withMes)
            println("Ошибка нахождения тэга CCX10");
            return false;
          end;
        end;
      else
        if(withMes)
          println("Ошибка нахождения тэга MICEX_DOC");
          return false;
        end;
      end;
    end;
    return true;
  onerror
    if(withMes)
      println("Ошибка загрузки xml-файла: "+fln);
    end;
    return false;
  end;

  macro loadFromDir()
    private var ninDir,ninDirArh,cdir,files,i=0;
    if(ExistFile(inDir+"\\"+cd))
      ninDir = inDir+"\\"+cd;
      cdir   = ninDir+"\\"+flMask;
      files  = TDirList(cdir);
      InitProgress(files.count,"Ждите. Идет загрузка файлов...","Ждите. Идет загрузка файлов...");
      if(files.count>2)
        while(i<files.count)
          if(not files.isDir(i))
            if(loadOneFl(ninDir+"\\"+files.name(i)))
              if(ExistFile(inDirArh))
                ninDirArh = inDirArh+"\\"+cd;
                if(not ExistFile(ninDirArh))
                  MakeDir(ninDirArh);
                end;
                if(ExistFile(ninDirArh))
                  if(not copyFile(ninDir+"\\"+files.name(i),ninDirArh+"\\"+files.name(i)))
                    if(withMes)
                      println("Ошибка копирования файла "+files.name(i)+" в директорию архива"+ninDirArh);
                    end;
                  else
                    if(not RemoveFile(ninDir+"\\"+files.name(i)))
                      if(withMes)
                        println("Ошибка удаления исходного файла "+files.name(i)+" после архивации");
                      end;
                    end;
                  end;
                else
                  if(withMes)
                    println("Отсутствует директория для архивирования "+ninDirArh+" исходного файла "+files.name(i));
                  end;
                end;
              else
                if(withMes)
                  println("Отсутствует директория для архивирования "+inDirArh+" исходного файла "+files.name(i));
                end;
              end;
            end;
          end;
          i = i+1;
          UseProgress(i);
        end;
      else
        if(withMes)
          println("Отсутствуют файлы в каталоге "+ninDir);
        end;
      end;
      RemProgress(i);
      files = null;
    else
      if(withMes)
        println("Отсутствуют каталог импорта "+inDir+"\\"+cd);
      end;
         msgboxex("Отсутствуют каталог импорта "+inDir+"\\"+cd); 
    end;
  onerror
    if(withMes)
      println("Ошибка сканирования входного каталога: "+inDir+"\\"+cd+", маска: "+flMask);
    end;
  end;

  macro AProc (rs, cmd, id, key )
    private var sql,pv;
    if(cmd == DLG_KEY)
      if(key == 13)/*Enter*/
        return CM_SELECT;
      elif(key == 32)/*ESC*/
        return CM_CANCEL;
      elif(key == 322)/*F8*/
        if(GetTrue(false,"Вы действительно хотите удалить запись?"))
          sql = "delete dstd_bskom_dbt from where t_id="+rs.value("t_id");
          sql = RSDCommand(sql);
          sql.execute();
          this.revers = 1;
          sql = null;
          return CM_SELECT;
        end;
        return CM_IGNORE;
      elif(key == 323)/*F9*/
        if(GetTrue(false,"Загрузить файлы?"))
          pv          = withQue;
          withQue     = true;
          loadFromDir();
          this.revers = 1;
          withQue     = pv;
          return CM_SELECT;
        end;
        return CM_IGNORE;
      end;
    end;
  onerror
    Msgbox("Ошибка выполнения действия обрботчика скроллинга!!!");
    return CM_IGNORE;
  end;

  macro select(visual,dop)
    private var rs,issel=1;
    private var cr=TArray;

    AddCol (cr , 0, "t_vdate"  , "Дата"         ,  9, 1);
    AddCol (cr , 1, "t_number" , "Тип"          ,  4, 1);
    AddCol (cr , 2, "t_amount" , "Сумма"        , 14, 2);
    AddCol (cr , 3, "t_name"   , "Наименование" , 50, 1);

    rs = "select t_vdate,t_number,t_name,t_amount from dstd_bskom_dbt where t_id>=0 "+dop+" order by t_id desc";
    rs = ExecSQLSelect(rs, null, false, RSDVAL_CLIENT, RSDVAL_STATIC);
    if(visual)
      if(not RunScroll(rs,4,cr,null,R2M(this,"AProc"),selzag,selpodv,false,5,2,84,15))
        issel=0;
      else
        if(revers==1)
          revers=0;
          this.select(visual,dop);
        end;
      end;
    end;
    if(issel)
      return true;
    end;
    return false;
  end;

end;

//основная функция загрузки файлов по НЭТТИНГу
macro LoadNettingFile()
private var k,{curdate},cd,wm=false;
cd = {curdate};
// cd = date(2,2,2018);
getdate(cd,"Укажите дату загрузки биржевого свидетельства");
scd       = dtToddmmyyyy(cd);
    if (Msgboxex("Загрузка информации по биржевым свидетельствам за  "+scd, MB_CANCEL+MB_OK,IND_OK) == IND_OK) 
k = TYSTD_BS();
k.cd       = dtToddmmyy(cd);
k.withQue  = false;//будум задвать вопросы при выполнении?
k.withrelo = false;//будум добавлять дулирующие записи?
k.withMes  = wm;//будум выводить сообщения при выполнения, включая ошибки в отчет?
k.flMask   = "MB01347_CCX4P_*.xml";
k.loadFromDir();
k.flMask   = "MB01347_CCX04_*.xml";
k.loadFromDir();
//k.select(true,"");
k = null;
k = TYSTD_BSKOM();
k.cd       = dtToddmmyy(cd);
k.withQue  = false;//будум задвать вопросы при выполнении?
k.withrelo = false;//будум добавлять дулирующие записи?   
k.withMes  = wm;//будум выводить сообщения при выполнения, включая ошибки в отчет?
k.flMask = "MB01347_CCX10_*.xml";
k.loadFromDir();
//k.select(true,"");
k = null;
        Msgboxex("Загрузка информации по биржевым свидетельствам за  "+scd+" завершена.");
     end;   
// execmacrofile("ntgnew1", "Newnett") ;
   // if(not wm)
   //   exit(1);
   // end;
end;
/*
DROP TABLE RSHB_SEC_DEMO52_20181018.DSTD_BS_DBT CASCADE CONSTRAINTS;

CREATE TABLE RSHB_SEC_DEMO52_20181018.DSTD_BS_DBT
(
  T_ID       NUMBER(10)                         NOT NULL,
  T_VDATE    DATE,
  T_FIID     NUMBER(10)                         NOT NULL,
  T_PAMOUNT  NUMBER(32,12),
  T_RAMOUNT  NUMBER(32,12),
  T_NUMBER   VARCHAR2(20 BYTE),
  T_STATUS   NUMBER(10)
)
TABLESPACE USERS
RESULT_CACHE (MODE DEFAULT)
PCTUSED    0
PCTFREE    10
INITRANS   1
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MAXSIZE          UNLIMITED
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
            FLASH_CACHE      DEFAULT
            CELL_FLASH_CACHE DEFAULT
           )
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE INDEX RSHB_SEC_DEMO52_20181018.DSTD_BS ON RSHB_SEC_DEMO52_20181018.DSTD_BS_DBT
(T_VDATE, T_FIID)
LOGGING
TABLESPACE INDX
PCTFREE    10
INITRANS   2
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MAXSIZE          UNLIMITED
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
            FLASH_CACHE      DEFAULT
            CELL_FLASH_CACHE DEFAULT
           )
NOPARALLEL;


CREATE OR REPLACE TRIGGER RSHB_SEC_DEMO52_20181018.DSTD_BS_DBT_T0_AINC
BEFORE INSERT OR UPDATE
OF T_ID
ON RSHB_SEC_DEMO52_20181018.DSTD_BS_DBT
REFERENCING NEW AS NEW OLD AS OLD
FOR EACH ROW
DECLARE
 v_id INTEGER;
BEGIN
 IF (:new.t_id = 0 OR :new.t_id IS NULL) THEN
 SELECT dstd_bs_dbt_seq.nextval INTO :new.t_id FROM dual;
 ELSE
 select last_number into v_id from user_sequences where sequence_name = upper ('dstd_bs_dbt_SEQ');
 IF :new.t_id >= v_id THEN
 RAISE DUP_VAL_ON_INDEX;
 END IF;
 END IF;
END;
/

DROP TABLE RSHB_SEC_DEMO52_20181018.DSTD_BSKOM_DBT CASCADE CONSTRAINTS;

CREATE TABLE RSHB_SEC_DEMO52_20181018.DSTD_BSKOM_DBT
(
  T_ID       NUMBER(10)                         NOT NULL,
  T_VDATE    DATE,
  T_NUMBER   NUMBER(10),
  T_NAME     VARCHAR2(256 BYTE),
  T_AMOUNT   NUMBER(32,12),
  T_RESERVE  VARCHAR2(20 BYTE)
)
TABLESPACE USERS
RESULT_CACHE (MODE DEFAULT)
PCTUSED    0
PCTFREE    10
INITRANS   1
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MAXSIZE          UNLIMITED
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
            FLASH_CACHE      DEFAULT
            CELL_FLASH_CACHE DEFAULT
           )
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE INDEX RSHB_SEC_DEMO52_20181018.DSTD_BSKOM ON RSHB_SEC_DEMO52_20181018.DSTD_BSKOM_DBT
(T_VDATE, T_NUMBER)
LOGGING
TABLESPACE INDX
PCTFREE    10
INITRANS   2
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MAXSIZE          UNLIMITED
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
            FLASH_CACHE      DEFAULT
            CELL_FLASH_CACHE DEFAULT
           )
NOPARALLEL;


CREATE OR REPLACE TRIGGER RSHB_SEC_DEMO52_20181018.DSTD_BSKOM_DBT_T0_AINC
BEFORE INSERT OR UPDATE
OF T_ID
ON RSHB_SEC_DEMO52_20181018.DSTD_BSKOM_DBT
REFERENCING NEW AS NEW OLD AS OLD
FOR EACH ROW
DECLARE
 v_id INTEGER;
BEGIN
 IF (:new.t_id = 0 OR :new.t_id IS NULL) THEN
 SELECT dstd_bskom_dbt_seq.nextval INTO :new.t_id FROM dual;
 ELSE
 select last_number into v_id from user_sequences where sequence_name = upper ('dstd_bskom_dbt_SEQ');
 IF :new.t_id >= v_id THEN
 RAISE DUP_VAL_ON_INDEX;
 END IF;
 END IF;
END;
/

DROP SEQUENCE RSHB_SEC_DEMO52_20181018.DSTD_BS_DBT_SEQ;

CREATE SEQUENCE RSHB_SEC_DEMO52_20181018.DSTD_BS_DBT_SEQ
  START WITH 1
  MAXVALUE 999999999999999999999999999
  MINVALUE 1
  NOCYCLE
  NOCACHE
  NOORDER;

DROP SEQUENCE RSHB_SEC_DEMO52_20181018.DSTD_BSKOM_DBT_SEQ;

CREATE SEQUENCE RSHB_SEC_DEMO52_20181018.DSTD_BSKOM_DBT_SEQ
  START WITH 1
  MAXVALUE 999999999999999999999999999
  MINVALUE 1
  NOCYCLE
  NOCACHE
  NOORDER;
*/