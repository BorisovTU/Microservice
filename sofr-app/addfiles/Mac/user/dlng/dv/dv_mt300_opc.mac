import "dv_categ.mac","dv_car.mac","dvswift.mac";

const TRANSP_SPFSCBR = 51; //А.Киселев 29.03.2019 пользовательский транспорт СПФСЦБРФ

private macro IsBank(pid)
//Яв-ся ли контрагент банком
  var sql,rs;
  sql = "select 1 from dpartyown_dbt n where n.t_partyid = "+pid+" and n.t_partykind = 2";
  rs = ExecSqlSelect(sql);

  if (rs.MoveNext())
    if (rs.value(0) == 1)
      return true;
    else
      return false;
    end;
  end;
  return false;
end;

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )
  record ndeal(dvndeal);
  var FD,sql,rs;
  SetBuff( ndeal, FDoc );
  FD = DVFirstDocNDeal(DocKind, ndeal);

  if (IsBank(FD.deal.rec.contractor))
    if ( FD.ПоставочныйКонтракт() )      
       if(not ndeal.ConfTpId)
          MsgBox("Невозможно сформировать сообщение МТ300: не задан транспорт подтверждения");
          return 1;
       elif( (ndeal.ConfTpId == TRANSP_SWIFT) or (ndeal.ConfTpId == TRANSP_TELEX) or (ndeal.ConfTpId == TRANSP_SPFSCBR) )//А.Киселев 25.04.2019
          DV_DealsGenMes(ndeal.docKind,ndeal.ID,300, TRANSP_SWIFT);
       else
          DV_DealsGenMes(ndeal.docKind,ndeal.ID,300);
       end;
    else
      MsgBox("Для расчетного типа сделки, MT300 временно не формируются.");
    end;
  end; 

  return 0;
end;