/*
$Name:        dvsw145.mac
$Module:      Производные инструменты
$Description: Валютный СВОП. Шаг "Списание СС"
*/

import InsCarryDoc, "dv_categ.mac", "dv_car.mac", "dv_period.mac";

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )

  RECORD ndeal(dvndeal);
  VAR ДатаИсполненияШага, FD;
  SetBuff( ndeal, FDoc );

  FD = DVFirstDocNDeal(DocKind, ndeal, 2);

  if (FD.Биржевая()) //Для биржи списываем в шаге постановки на баланс
    return 0;
  end;

  ДатаИсполненияШага = DV_GetPlanDateStep(ID_Operation, ID_Step);
  if( ДатаИсполненияШага == date(0,0,0) )
     ДатаИсполненияШага = FD.ДатаИсполнения();
  end;


  if( (not FD.IsClient()) and (not FD.ВыполненаПереоценкаСС(ДатаИсполненияШага)) )
     MsgBox( "Не выполнена переоценка справедливой стоимости ! Продолжение невозможно.");
     return 1;
  end;

  if( СписаниеСправедливойСтоимости( FD, doc, ДатаИсполненияШага ) != 0 )
     return 1;
  end;

  

  return 0;

end;