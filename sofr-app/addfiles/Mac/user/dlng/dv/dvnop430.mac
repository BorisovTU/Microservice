import InsCarryDoc, "dv_categ.mac", "dv_car.mac", "mccatacf.mac", "cb_sql.mac";

  var CalcgGp;

    CalcgGp = getGlobalParameter("CalcSt", false);

  var Payment:RsbPayment;
  var PaymentID:integer = 0;
 

private macro ПоставитьНаПросрочку( FD, doc, ДатаИсполненияШага ):integer

  if( CalcgGp == 1 )

     if( not ПроводкаПоКатегориямУчета( FD,  
                                        "-Форвард, РПИ", "Обяз. с н.с.",
                                        ДатаИсполненияШага,
                                        1,
                                        FD.ВалютаОбязательства(),
                                        Payment.PayerAmount,
                                        doc,
                                        INPCARRY, FD.kind, "",
                                        "Просроченные обязательства по сделке " + FD.DealCode(),
                                        null, null,
                                        FD.ВалютаОбязательства(), FD.ВалютаОбязательства(),
                                        FD.ВалютаОбязательства(), Payment.PayerAmount
                                      )
       )
        return 1;
     end;

    return 0;
  
  elif ( CalcgGp == 2 )

     if( not ПроводкаПоКатегориямУчета( FD,
                                        "Треб. с н.с.", "+Форвард, РПИ",
                                        ДатаИсполненияШага,
                                        1,
                                        FD.ВалютаТребования(),
                                        Payment.PayerAmount,
                                        doc,
                                        INPCARRY, FD.kind, "",
                                        "Просроченные требования по сделке " + FD.DealCode(),
                                        null, null,
                                        FD.ВалютаТребования(), FD.ВалютаТребования(),
                                        FD.ВалютаТребования(), Payment.PayerAmount
                                      )
       )
        return 1;
     end;

    return 0;

  end;

end;


macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )


  record ndeal(dvndeal);
  SetBuff( ndeal, FDoc );
  var FD = DVFirstDocNDeal(DocKind, ndeal);
  var ДатаИсполненияШага:date;


  ДатаИсполненияШага = FD.ДатаИсполнения();

  if( (DV_FindPaymentID(DocKind, ndeal.ID, PM_PURP_MARGA, 0, ДатаИсполненияШага, @PaymentID) == true) and (PaymentID > 0) )
      Payment = RsbPayment(PaymentID);

      if( Payment.PaymentID > 0 )
        if( ПИ_УстановитьСтатусПлатежа(Payment, PM_OVERDUE) )
           MsgBox( "Ошибка при утановке платежу статуса \"Просрочен\"" );
           return 1;
        end;
      end;

  end;

  if( ПоставитьНаПросрочку(FD, doc, ДатаИсполненияШага) != 0 )
     return 1;
  end;

  return 0;
 
end;
