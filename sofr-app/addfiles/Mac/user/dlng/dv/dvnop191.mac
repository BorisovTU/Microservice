/*
$Name:        dvnop191.mac
$Module:      ФИССиКО
$Description: Внебиржевая операция. Шаг: Списание справедливой стоимости.
/*PNV i-support 487746 - списание СС вынести на отдельный шаг по аналогии с внебиржевыми СВОП*/
*/
IMPORT InsCarryDoc, "dv_categ.mac", "dv_car.mac";

MACRO ВыполненаПереоценкаПоИзменениям_USR (dealid, ДатаИсполненияШага)
    var RetAcc:string = "";
  var rs, cmd, str;

  str = " SELECT * from DDVNFRVAL_DBT where t_dealid = ? and t_date = ? " ;

  cmd = RsdCommand(str);
  cmd.addParam("dealid", RSDBP_IN, dealid);
  cmd.addParam("date",   RSDBP_IN, ДатаИсполненияШага);

  rs = RsdRecordset(cmd);
  if (rs and rs.MoveNext())
    return true;
  end;

  return false;
END;

MACRO ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )
  record ndeal(dvndeal);
  SetBuff( ndeal, FDoc );
  var FD = DVFirstDocNDeal(DocKind, ndeal);
  var ДатаИсполненияШага:date;
  var OutPFIBuf = TRecHandler("account");
  var RestOutPFI;

  ДатаИсполненияШага = DV_GetPlanDateStep(ID_Operation, ID_Step);

  if ( (FD.IsPctSWAP())and (GetDateAfterWorkDays(FD.ДатаИсполнения(),0,FD.ПолучитьКалендСвязанный()) == ДатаИсполненияШага))
     return 0;
  end; 

  if( not ВыполненаПереоценкаПоИзменениям_USR(FD.Deal.rec.Id, ДатаИсполненияШага) )
     MsgBoxEx( "Не найдена запись по изменению справедливой стоимости за указанную дату! Продолжение невозможно");
     return 1;
  end;

  //mda 17/02/19 А вот теперь финрез!
  if( ( not FD.IsExistAccount("Выбытие ПФИ", null, true, FIROLE_UNDEF, OutPFIBuf, null, ДатаИсполненияШага, NATCUR)) and 
      ( not FD.OpenAccount( "Выбытие ПФИ", null, false, FIROLE_UNDEF, OutPFIBuf, ДатаИсполненияШага, NATCUR, null, null ) ))
      MsgBoxEx("Счет категории  \"Выбытие ПФИ\" неопределен или недоступен в данной операции");
  end;

  RestOutPFI = GetRestAccountTRH(OutPFIBuf,ДатаИсполненияШага );
  if (RestOutPFI > 0)
      if( not ПроводкаПоКатегориямУчета( FD, 
                                         "Выбытие ПФИ",                      /* Деб */
                                         "Доходы ПФИ",                       /* Кредит */
                                         ДатаИсполненияШага,                 /* Дата */
                                         1,                                  /* Глава */
                                         NATCUR,                             /* Валюта */
                                         abs(RestOutPFI),                    /* Сумма */
                                         Doc,                                /* Документ */
                                         INPCARRY,                           /* Result_Carry */
                                         "",                                 /* Kind_Oper */
                                         "",                                 /* Numb_Document */
                                         "ПФИ (" + FD.PctSwapTypeName(true) + "). Отнесение финансового результата по сделке "+FD.DealCode()+" от "+StrSubSt(String(FD.ДатаСделки():f), ".", "/") + ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*///"Отражение финансового результата", /* Ground */
                                         NULL, NULL, NULL,
                                         NATCUR, NATCUR
                                        )
       )
        return 1;
      end;
  elif (RestOutPFI < 0)
      if( not ПроводкаПоКатегориямУчета( FD, 
                                         "Расходы ПФИ",                      /* Деб */
                                         "Выбытие ПФИ",                      /* Кредит */
                                         ДатаИсполненияШага,                 /* Дата */
                                         1,                                  /* Глава */
                                         NATCUR,                             /* Валюта */
                                         abs(RestOutPFI),                    /* Сумма */
                                         Doc,                                /* Документ */
                                         INPCARRY,                           /* Result_Carry */
                                         "",                                 /* Kind_Oper */
                                         "",                                 /* Numb_Document */
                                         "ПФИ (" + FD.PctSwapTypeName(true) + "). Отнесение финансового результата по сделке "+FD.DealCode()+" от "+StrSubSt(String(FD.ДатаСделки():f), ".", "/")+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*///"Отражение финансового результата", /* Ground */
                                         NULL, NULL, NULL,
                                         NATCUR, NATCUR
                                         )
          )
            return 1;
      end;
  end;

  return 0;
END;
