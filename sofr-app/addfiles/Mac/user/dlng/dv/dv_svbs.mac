import RSBDataSet, dlgCommon;
import FIInter,rsexts,oralib,likepy;
import "gtconst.inc" , calculate, funk, "cb_sql.mac", dl_plib, globals,dv_lib ;

file Report1  () txt 1024 write;   // Вывод предварительных результатов

var nsdel,ssu0,bir="MICEX SELT & FORTS";


macro fx_fiid(pa1)

    private var que,srez=0,rs51;
    srez=" ";
    que="select t_fiid from dfininstr_dbt  where t_ccy='"+pa1+"'" ;
    rs51 = LnGetRecordSet(que);
    if(rs51 != null)
      if (rs51.moveNext) 
        srez=int(rs51.value(0));
      end;
    end;
    return srez;
end;


macro fx_sdel(pa1)

    private var que,srez=0,rs51,panew,ii;
    srez=" ";


    que="select count(*) from ddvndeal_dbt  where  t_code='"+pa1+"' and t_contractor =  1181";
    rs51 = LnGetRecordSet(que);
    if(rs51 != null)
      if (rs51.moveNext) 
        srez=int(rs51.value(0));
      end;
    end;


    if ( srez > 0 )

      que="select t_id from ddvndeal_dbt  where  t_code='"+pa1+"' and t_contractor =  1181";
      rs51 = LnGetRecordSet(que);
      if(rs51 != null)
        if (rs51.moveNext) 
          srez=int(rs51.value(0));
        end;
      end;

    else

      // SWP:35986    
      ii=index(pa1,":");
      if ( ii > 0 )
         // panew="SWP:"+substr(pa1,ii+1);

         panew=substr(pa1,ii+1);

         que="select count(*) from ddvndeal_dbt  where  substr(t_code,5)='"+panew+"' and t_contractor =  1181";
         rs51 = LnGetRecordSet(que);
         if(rs51 != null)
           if (rs51.moveNext) 
             srez=int(rs51.value(0));
           end;
         end;
         if ( srez > 0 )
           que="select t_id,t_code from ddvndeal_dbt  where  substr(t_code,5)='"+panew+"' and t_contractor =  1181";
           rs51 = LnGetRecordSet(que);
           if(rs51 != null)
             if (rs51.moveNext) 
               srez=int(rs51.value(0));
               nsdel=rs51.value(1);
             end;
           end;

         end;

      end;

    end;




    

    return srez;
end;



macro fx_plat(pa1,pa2,pa3,pa4)

    private var que,srez=0,rs51;

    ssu0=" ";
    srez=" ";
    que="select count(*) from dpmpaym_dbt  where (t_dockind = 4813 or  t_dockind = 4815) and t_documentid="+pa1+" and t_fiid="+pa2+" and to_char(t_valuedate,'dd.mm.yyyy')='"+pa4+"' and t_baseamount="+pa3;
    rs51 = LnGetRecordSet(que);
    if(rs51 != null)
      if (rs51.moveNext) 
        srez=int(rs51.value(0));
      end;
    end;
     

    if ( srez == 0 )
      que="select t_baseamount from dpmpaym_dbt  where (t_dockind = 4813 or  t_dockind = 4815) and t_documentid="+pa1+" and t_fiid="+pa2+" and to_char(t_valuedate,'dd.mm.yyyy')='"+pa4+"'";
      // msgbox(que);

      rs51 = LnGetRecordSet(que);
      if(rs51 != null)
        if (rs51.moveNext) 
          ssu0=string(rs51.value(0):a);
        end;
      end;


    end;


    return srez;
end;



//точка входа

     private var nach_tabl=6; // до строки 6 - "шапка" таблицы
     private var sql0, sql, pdir, xltfile, file_out, par0, ob,ii=1,jj=3, str, ind_cl_pos,{curdate},dat;
     private var irez,nmes,ngod,rs12, npaymentid,dat2,kol,is2,valuedate,dat3,kindop;
     var u, v,j01,is1,par9,POZ,que0,que,rs4,rs45,sparty,srate,ratecov=0,samount1,samount2,spfi,scfi,d00; 
     var obj = CreateObject("rsax", "TRsAxServer", "RsAxServer", false); 


     var ProcDate     = DV_SDAT({curdate});
     var ProcTime     = Time();
     var ProcTimeFile;
     var DealArr = TArray();

     d00= {curdate};
     getdate(d00);
     ProcDate=DV_SDAT(d00);


   var CDfnMask, CDfn, DirImport,DirArch, fname, fext,isobr,su1,su2,da1,da2,fi1,fi2,su4,dealid, ff1,ff2,tip;

   macro main()
      var file_out,jj,ii;
      file_out=CDfn;
      ob = obj.CreateComObject("Excel.Application");
      ob.Workbooks.Open(file_out);
      ob.Sheets("micex").Select;


      jj=8;
      ii=0;
       InitProgress( 1000, "Сверка биржевых сделок" );  


      while( ii < 5000 )

        nsdel=(ob.Cells(jj,1).Value);

//-------
        tip= (ob.Cells(jj,8).Value);
                                          if (tip == bir )

      if (ob.Cells(jj,2).Value == "FxSwapDeals");
/*
        msgbox(ob.Cells(jj,9).Value);
        msgbox(ob.Cells(jj,10).Value);
        msgbox(ob.Cells(jj,22).Value);
        msgbox(ob.Cells(jj,23).Value);
        msgbox(ob.Cells(jj,24).Value);
        msgbox(ob.Cells(jj,25).Value);
        msgbox(ob.Cells(jj,27).Value);
*/

        nsdel=(ob.Cells(jj,1).Value);
        da1=DV_SDAT(ob.Cells(jj,9).Value);
        da2=DV_SDAT(ob.Cells(jj,10).Value);


                              if (( da1 == ProcDate ) or ( da2 == ProcDate ))



        su1=abs(ob.Cells(jj,22).Value);
        fi1=fx_fiid(ob.Cells(jj,23).Value);
        fi2=fx_fiid(ob.Cells(jj,24).Value);
        ff1=(ob.Cells(jj,23).Value);
        ff2=(ob.Cells(jj,24).Value);

        su2=su1*(ob.Cells(jj,27).Value);

        su4=su1*(ob.Cells(jj,25).Value);

        dealid=fx_sdel(nsdel);
        if ( dealid == 0 )
            println("Не найдена сделка"+nsdel);
            println(da1,"=",su1,"-",ff1,"=",su4,"=",ff2);
        end;


            if (( da1 == ProcDate )  and  (dealid > 0))
        su1=abs(ob.Cells(jj,22).Value);
        fi1=fx_fiid(ob.Cells(jj,23).Value);
        fi2=fx_fiid(ob.Cells(jj,24).Value);
        su2=su1*(ob.Cells(jj,27).Value);

        if ( fx_plat(dealid,fi1,su1,da1)  == 0 )
            println("Неверно загружена сделка "+nsdel);
            println(da1,"=",string(su1:a),"-",ff1,"=",string(su2:a),"=",ff2);
            println(ssu0);
        else

           if ( fx_plat(dealid,fi2,su2,da1)  == 0 )
            println("Неверно загружена сделка "+nsdel);
            println(da1,"=",string(su1:a),"-",ff1,"=",string(su2:a),"=",ff2);
            println(ssu0);
           else
            //  println("Cделка загружена "+nsdel);
           end;
        end;

            end;


            if (( da2 == ProcDate )  and  (dealid > 0))


        if ( fx_plat(dealid,fi1,su1,da2)  == 0 )
            println("Неверно загружена сделка "+nsdel);
            println(da2,"=",string(su1:a),"-",fi1,"=",string(su4:a),"=",fi2);
            println(ssu0);
        else

           if ( fx_plat(dealid,fi2,su4,da2)  == 0 )
            println("Неверно загружена сделка "+nsdel);
            println(da1,"=",string(su1:a),"-",fi1,"=",string(su4:a),"=",fi2);
            println(ssu0);
           else
              println("Cделка загружена "+nsdel);
           end;
        end;

            end;

                              end;


     else

// SPT:2293803=14.09.2018=14000.0000-8=1119860.0000=0

        nsdel=(ob.Cells(jj,1).Value);
        dealid=fx_sdel(nsdel);
        da1=DV_SDAT(ob.Cells(jj,9).Value);

        ff1=(ob.Cells(jj,23).Value);
        ff2=(ob.Cells(jj,24).Value);

                              if ( da1 == ProcDate )

        if ( dealid == 0 )
            println("Не найдена сделка "+nsdel);
            println(da1,"=",su1,"-",ff1,"=",su4,"=",ff2);
        end;

        da1=DV_SDAT(ob.Cells(jj,9).Value);
            if (( da1 == ProcDate )  and  (dealid > 0))


        su1=abs(ob.Cells(jj,22).Value);
        fi1=fx_fiid(ob.Cells(jj,23).Value);
        fi2=fx_fiid(ob.Cells(jj,24).Value);


        su2=su1*(ob.Cells(jj,27).Value);

        if ( fx_plat(dealid,fi1,su1,da1)  == 0 )
            println("Неверно загружена сделка "+nsdel);
            println(da1,"=",string(su1:a),"-",ff1,"=",string(su2:a),"=",ff2);
            println(ssu0);

        else

           if ( fx_plat(dealid,fi2,su2,da1)  == 0 )
            println("Неверно загружена сделка "+nsdel);
            println(da1,"=",string(su1:a),"-",ff1,"=",string(su2:a),"=",ff2);
            println(ssu0);

           else
            //  println("Cделка загружена "+nsdel);
           end;
        end;

            end;
                              end;
     end;

// -----------
                                                   end;


        jj=jj+1;
        ii=ii+1;
        useprogress(jj);


        if ( ValType (nsdel) == V_UNDEF  )
          ii=10000;
        end;
     end;
      ob.DisplayAlerts = false;
      // ob.ActiveWorkbook.SaveAs(file_out);
      ob.ActiveWorkbook.Close(file_out);
       ob         = null;

        RemProgress; 



  end;





    DirImport = "..\\Import\\radis\\";
    CDfnMask = DirImport+"*.xlsb";
    if(
      SelectFile( CDfn,  CDfnMask, "Выберите исходный файл СДЕЛОК"           ) and 
      Open      ( Report1 , CDfn+"."+ProcDate+"-"+ProcTimeFile+".rep"     )  )
      isobr = 0;
    else
      msgbox("Файл не выбран!");
      return false;
    end;
       //    msgbox(CDfn);
       //    isobr=1;

    Main();

    if(isobr==1)
      DirArch = SplitFile(CDfn, fname, fext) + "old\\";
      MakeDir(DirArch);
    
      if(CopyFile(CDfn, DirArch+fname+fext))
        RemoveFile(CDfn);
      else
        msgbox("Ошибка при перемещении файла " + CDfn + " в папку " + DirArch);
      end;
    
      msgbox("Распоряжение обработано !");
    end;

   println("Реестр сделок обработан ");

   // exit(1);
