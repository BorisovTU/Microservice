import InsCarryDoc, "dv_categ.mac", "dv_car.mac", "mccatacf.mac";

private macro ПоставитьНаПросрочку( FD, doc, ДатаИсполненияШага ):integer

     if( not ПроводкаПоКатегориямУчета( FD,  
                                        "-Форвард, РПИ", "Обяз. с н.с.",
                                        ДатаИсполненияШага,
                                        1,
                                        FD.ВалютаОбязательства(),
                                        FD.СуммаОбязательства(),
                                        doc,
                                        INPCARRY, FD.kind, "",
                                        "Просроченные обязательства по сделке " + FD.DealCode(),
                                        null, null, FIROLE_FIREQ,
                                        FD.ВалютаОбязательства(), FD.ВалютаОбязательства(),
                                        FD.ВалютаОбязательства(), FD.СуммаОбязательства()
                                       )
       )
        return 1;
     end;

    return 0;

end;

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )

  record deal(dvndeal);
  var FD;
  var ДатаИсполненияШага:date;

  SetBuff(deal, FDoc);
  FD = DVFirstDocFXDeal(DL_DVFXDEAL, deal);

  GetOprDate(DV_FXDEAL_OPRDATE_OBL, ДатаИсполненияШага);

  var ПлатежОб = RsbPayment( FD.ПлатежОб.rec.PaymentID );

  ДатаИсполненияШага = FD.ДатаИсполнения();

  if( ПоставитьНаПросрочку(FD, doc, ДатаИсполненияШага) != 0 )
     return 1;
  end;

  if( FD.ПлатежОб.rec.PaymentID > 0 )

     if( ПИ_УстановитьСтатусПлатежа(ПлатежОб, PM_OVERDUE) )
        MsgBox( "Ошибка при утановке платежу статуса \"Просрочен\"" );
        return 1;
     end;
  end;

  return 0;

end;

