import RSD;

macro GetTypeMessage4Cancel(p_DealID, msg_type:@string)

  Macro AddCol (ar,ind, fld, head, width, fldType,decPoint)
     ar.value (ind * 6)      = fld;
     ar.value (ind * 6 + 1)  = head;
     ar.value (ind * 6 + 2)  = width;
     ar.value (ind * 6 + 3 ) = fldType; 
     ar.value (ind * 6 + 4 ) = decPoint;
     ar.value (ind * 6 + 5 ) = 0; 
  End;

  macro EvList (rs, cmd, id, key)
     if(cmd == DLG_KEY)
        if(key == 13) 
           msg_type = rs.value ("t_type");
           return CM_CANCEL;
        elif (key == 27) 
           msg_type = "";
           return false;
        elif ((key == 322) or (key == 323))
           return CM_IGNORE;
        end;
     end;
  end;
  var sql = "select distinct to_char(mt.type) as t_type" +
            "  from mtrec mt, paym p" + 
            "  where p.id_paym = mt.id_paym" + 
            "    and p.id_sstate in (63,571,576,577)" + 
            "    and mt.id_paym in (select distinct pass.id_paym" + 
            "                          from payass pass" + 
            "                          where pass.associate = to_char(:p_DealID));";
  var cmd = RSDCommand(sql);
      cmd.AddParam("p_DealID", rsdbp_in, p_DealID);
  var rs = RSDRecordset (cmd, rsdval_client, rsdval_static);

  var col = TArray;
      
      AddCol (col , 0, "t_type", "Тип",      25,  2, null);

      RunScroll (rs,1,col,null,@EvList,"Отправленные сообщения","ENTER-Выбор ESC-Отмена",false/*,xo,yo,40,zo*/);
  
      return(msg_type);
end;

/*    var msg_type;
    if(GetTypeMessage4Cancel(225200, @msg_type))
      msgbox( msg_type);
    end;
  */