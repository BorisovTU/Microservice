// IMPORT "dvserv.mac", "mc_lib.mac", "dlcarry.inc",funk, "dv_ground.mac", "dvrepfun2.mac", "dl_car.mac", "dv_categ.mac", "dvservop.mac", "dv_voop.mac", "dv_carsf.mac", "nutxfun.mac";/*
IMPORT CurrInter,dv_car,dv_lib ;

/*
PRIVATE VAR isPlanMode = false;
PRIVATE VAR PlanInAccData = TArray();
PRIVATE VAR CheckCatArr = TArray();
*/

MACRO PDM (FD, ДатаИсполненияШага, doc):integer

  var AccPlus = TRecHandler("account");
  var AccMinus = TRecHandler("account");
  var AccountC = TRecHandler("account");

   var AccountN = TBFile( "account" );
   VAR ВалютаТребования,ВалютаОбязательства, СуммаОбязательства, СуммаТребования ;


  private var Sкр = $0, SumEq_Payer = $0, SumEq_Receiver = $0,acc5,rs9;
  private var que,rs1,su24,su21,ground;

   // su24=100;
   // acc5="30119A98900000000001";


      acc5=(account_corr9(FD.ВалютаТребования()));

      
      AccountN.Clear();
      AccountN.rec.account = acc5;
      AccountN.rec.Chapter = 1;
      AccountN.rec.Code_Currency =FD.ВалютаТребования();
      if( AccountN.GetEQ() == false )
      end;

      que="select t_cost from ddvnfi_dbt where t_dealid ="+FD.id;
      rs9 = LnGetRecordSet(que);
      if(rs9 != null)
        while(rs9.moveNext())
           su24=(rs9.value(0));
        end;
      end;
            ground="Платеж по сделке № "+fx_sd(FD.id,"code");


                    ВалютаТребования=FD.ВалютаТребования();
                    СуммаТребования= FD.СуммаТребования();
                    ВалютаОбязательства=FD.ВалютаОбязательства();
                    СуммаОбязательства=FD.СуммаОбязательства();

                    if (fx_sd(FD.id,"type") == 2)
                        ВалютаОбязательства=ВалютаТребования;
                        СуммаОбязательства=СуммаТребования;
                    else
                        ВалютаТребования=ВалютаОбязательства;
                        СуммаТребования= СуммаОбязательства;
                    end;




            if( not FD.OpenAccount("Выбытие ДМ", null, false, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccMinus, ДатаИсполненияШага, 0, null, null, MC_PAIRACCMODE_AUTO) )
              return 1;
            end;



            if( not FD.OpenAccount("+Форвард, расчеты0", null, false, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccountC, ДатаИсполненияШага, ВалютаТребования, null, null, MC_PAIRACCMODE_AUTO) )
              return 1;
            end;

           Sкр=su24;
/* Filippov
           if( not ПроводкаПоКатегориямУчета( FD,
                                              AccMinus, AccountC,
                                              ДатаИсполненияШага,
                                              1,
                                              ВалютаТребования, abs(Sкр),
                                              doc,
                                              INPCARRY, "", "",
                                              Ground,
                                              null,
                                              null, null
                                              // null, null,
                                              //null, null,
                                              // null, null, null, null, null, null, null, null, iif(AccountC.rec.Code_Currency!=NATCUR,false,null)
                                            )
             )
              return 1;
           end;
*/

      que="select t_amount from ddvnfi_dbt where t_dealid ="+FD.id;
      rs9 = LnGetRecordSet(que);
      if(rs9 != null)
        while(rs9.moveNext())
           su24=(rs9.value(0));
        end;
      end;

           if( not ПроводкаПоКатегориямУчета( FD,
                                              AccountN, AccountC,
                                              // AccMinus, AccountC,
                                              ДатаИсполненияШага,
                                              1,
                                              FD.ВалютаТребования(), abs(su24),
                                              doc,
                                              INPCARRY, "", "",
                                              Ground,
                                              null,
                                              null, null
                                              // null, null,
                                              //null, null,
                                              // null, null, null, null, null, null, null, null, iif(AccountC.rec.Code_Currency!=NATCUR,false,null)
                                            )
             )
              return 1;
           end;

               

  return 0;
End;


MACRO PDM2 (FD, ДатаИсполненияШага, doc):integer

  var AccPlus = TRecHandler("account");
  var AccMinus = TRecHandler("account");
  var AccountC = TRecHandler("account");

   var AccountN = TBFile( "account" );
   VAR ВалютаТребования,ВалютаОбязательства, СуммаОбязательства, СуммаТребования ;


  private var Sкр = $0, SumEq_Payer = $0, SumEq_Receiver = $0,acc5,rs9;
  private var que,rs1,su24,su21,ground;

   // su24=100;
   // acc5="30119A98900000000001";


      acc5=(account_corr9(FD.ВалютаОбязательства()));
      
      AccountN.Clear();
      AccountN.rec.account = acc5;
      AccountN.rec.Chapter = 1;
      AccountN.rec.Code_Currency =FD.ВалютаОбязательства();
      if( AccountN.GetEQ() == false )
      end;

      que="select t_cost from ddvnfi_dbt where t_dealid ="+FD.id;
      rs9 = LnGetRecordSet(que);
      if(rs9 != null)
        while(rs9.moveNext())
           su24=(rs9.value(0));
        end;
      end;
            ground="Платеж по сделке № "+fx_sd(FD.id,"code");


                    ВалютаТребования=FD.ВалютаТребования();
                    СуммаТребования= FD.СуммаТребования();
                    ВалютаОбязательства=FD.ВалютаОбязательства();
                    СуммаОбязательства=FD.СуммаОбязательства();

                    if (fx_sd(FD.id,"type") == 2)
                        ВалютаОбязательства=ВалютаТребования;
                        СуммаОбязательства=СуммаТребования;
                    else
                        ВалютаТребования=ВалютаОбязательства;
                        СуммаТребования= СуммаОбязательства;
                    end;




            if( not FD.OpenAccount("Выбытие ДМ", null, false, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccMinus, ДатаИсполненияШага, 0, null, null, MC_PAIRACCMODE_AUTO) )
              return 1;
            end;



            if( not FD.OpenAccount("-Форвард, расчеты0", null, false, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccountC, ДатаИсполненияШага, ВалютаТребования, null, null, MC_PAIRACCMODE_AUTO) )
              return 1;
            end;

           Sкр=su24;
           if( not ПроводкаПоКатегориямУчета( FD,
                                              AccountC,AccMinus, 
                                              ДатаИсполненияШага,
                                              1,
                                              ВалютаТребования, abs(Sкр),
                                              doc,
                                              INPCARRY, "", "",
                                              Ground,
                                              null,
                                              null, null
                                              // null, null,
                                              //null, null,
                                              // null, null, null, null, null, null, null, null, iif(AccountC.rec.Code_Currency!=NATCUR,false,null)
                                            )
             )
              return 1;
           end;


      que="select t_amount from ddvnfi_dbt where t_dealid ="+FD.id;
      rs9 = LnGetRecordSet(que);
      if(rs9 != null)
        while(rs9.moveNext())
           su24=(rs9.value(0));
        end;
      end;

           if( not ПроводкаПоКатегориямУчета( FD,
                                              AccMinus,AccountN,
                                              // AccMinus, AccountC,
                                              ДатаИсполненияШага,
                                              1,
                                              FD.ВалютаОбязательства(), abs(su24),
                                              doc,
                                              INPCARRY, "", "",
                                              Ground,
                                              null,
                                              null, null
                                              // null, null,
                                              //null, null,
                                              // null, null, null, null, null, null, null, null, iif(AccountC.rec.Code_Currency!=NATCUR,false,null)
                                            )
             )
              return 1;
           end;

               

  return 0;
End;




