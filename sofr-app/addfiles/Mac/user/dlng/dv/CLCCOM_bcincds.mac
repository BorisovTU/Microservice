/*
$Name:         CLCCOM_bcincds.mac 
$Module:       ФИССиКО
$Description:  Получение базовой суммы для комиссии за вывод средств
*/
import BankINter, SfInter;
import sp_car, dlcontrfunc, dvserv;

VAR MacroError :INTEGER = 0;

PRIVATE MACRO GetAccount(FD, CatCode, FIRole, recAccount:@variant, ActionDate, FIID)
  var stat = true;
  var findAccount = "";

  ClearRecord(recAccount);
  stat = FD.OpenAccount( CatCode,
                         null,
                         null,
                         FIRole,
                         recAccount,
                         ActionDate,
                         FIID);

  return stat;
END;

// согласно пункта Ж тарифов. Сумма операции учитывается в комиссии, если валюта отличается от Основной и были операции в этой валюте за последние 15 дней.
private macro calc_base_sum(deal, p_bas_fi:@integer, p_bas_sm:@money)
   var sqls, rsdc, v_sum = 0;
   sqls = String( 
         "DECLARE   \n"
        ,"   v_Opr  Dnptxop_Dbt.t_Id%TYPE := :p_Opr;   \n"
        ,"   r_Opr  Dnptxop_Dbt%ROWTYPE;   \n"
        ,"   r_Sfc  Dsfcontr_Dbt%ROWTYPE;   \n"
        ,"   v_Err  VARCHAR2(2000);   \n"
        ,"   v_Sum  Dnptxop_Dbt.t_Outsum%TYPE := 0;   \n"
        ,"   v_Bfс VARCHAR2(50);   \n"
        ,"   v_Bfi  Dfininstr_Dbt.t_Fiid%TYPE;   \n"
        ,"   Ex_Ok EXCEPTION;   \n"
        ,"   Ex_Er EXCEPTION;   \n"
        ,"BEGIN   \n"
        ,"   BEGIN   \n"
        ,"      NULL;   \n"
        ,"      -- получить запись операции   \n"
        ,"      BEGIN   \n"
        ,"         SELECT * INTO r_Opr FROM Dnptxop_Dbt t WHERE t.t_Id = v_Opr;   \n"
        ,"      EXCEPTION   \n"
        ,"         WHEN OTHERS THEN   \n"
        ,"            RAISE Ex_Ok;   \n"
        ,"      END;   \n"
        ,"      -- получить запись договора   \n"
        ,"      BEGIN   \n"
        ,"         SELECT * INTO r_Sfc FROM Dsfcontr_Dbt t WHERE t.t_Id = r_Opr.t_Contract;   \n"
        ,"      EXCEPTION   \n"
        ,"         WHEN OTHERS THEN   \n"
        ,"            v_Err := 'Для операции ' || r_Opr.t_Code || ' от ' || To_Char(r_Opr.t_Operdate, 'DD.MM.YYYY') ||   \n"
        ,"                     ' не найден договор';   \n"
        ,"            RAISE Ex_Er;   \n"
        ,"      END;   \n"
        ,"      -- определить базовую валюту договора   \n"
        ,"      v_Bfс := TRIM(Chr(0) FROM Rsb_Struct.Getstring(Rsi_Rsb_Kernel.Getnote(Objtype  => Cnst.Objtype_Sfcontr   \n"
        ,"                                                               ,Objid    => Lpad(r_Opr.t_Contract, 10, '0')   \n"
        ,"                                                               ,Notekind => 102   \n"
        ,"                                                               ,Dat      => r_Opr.t_Operdate)));   \n"
        ,"      IF v_Bfс IS NULL THEN   \n"
        ,"         v_Err := 'Для договора ' || r_Sfc.t_Number || ' не указана базовая валюта';   \n"
        ,"         RAISE Ex_Er;   \n"
        ,"      END IF;   \n"
        ,"      BEGIN   \n"
        ,"         SELECT t.t_Fiid INTO v_Bfi FROM Dfininstr_Dbt t WHERE t.t_Ccy = v_Bfс;   \n"
        ,"      EXCEPTION   \n"
        ,"         WHEN OTHERS THEN   \n"
        ,"            v_Err := 'Для договора ' || r_Sfc.t_Number || ' указана базовая валюта ' || v_Bfс ||   \n"
        ,"                     ' отсутсвует в справочнике валют';   \n"
        ,"            RAISE Ex_Er;   \n"
        ,"      END;   \n"
        ,"      IF v_Bfi = r_Opr.t_Currency THEN   \n"
        ,"         RAISE Ex_Ok;   \n"
        ,"      END IF;   \n"
        ,"      v_Sum := r_Opr.t_Outsum;   \n"
        ,"   EXCEPTION   \n"
        ,"      WHEN Ex_Ok THEN   \n"
        ,"         v_Err := '';   \n"
        ,"         v_Sum := 0;   \n"
        ,"      WHEN OTHERS THEN   \n"
        ,"         v_Sum := 0;   \n"
        ,"         v_Err := Nvl(v_Err, Dbms_Utility.Format_Error_Stack || ' ' || Dbms_Utility.Format_Error_Backtrace);   \n"
        ,"   END;   \n"
        ,"   :p_Err := v_Err;   \n"
        ,"   :p_Sum := v_Sum;   \n"
        ,"END;   \n"
       );
   rsdc = rsdcommand(sqls);
   rsdc.AddParam("p_opr", RSDBP_IN , deal.ID);
   rsdc.AddParam("p_err", RSDBP_OUT, v_string, 2000);
   rsdc.AddParam("p_sum", RSDBP_OUT, v_double);
   rsdc.Execute;
   sqls = rsdc.Value("p_Err");
   p_bas_sm = rsdc.Value("p_Sum");
   rsdc = null;
   if ((sqls != null) and (sqls != nullval))
      RunError(sqls, sqls); 
   end;   
   p_bas_fi = deal.Currency;
end;
/*CHVA  507198 тоже самое делаем для  РОВУ*/
private macro calc_base_sum_inacc(deal, ContrID: integer, p_bas_fi:@integer, p_bas_sm:@money)
   var sqls, rsdc, v_sum = 0;
   sqls = String( 
         "DECLARE   \n"
        ,"   v_Opr  ddl_acc_dbt.t_Id%TYPE := :p_Opr;   \n"
        ,"   r_Opr  ddl_acc_dbt%ROWTYPE;   \n"
        ,"   r_Sfc  Dsfcontr_Dbt%ROWTYPE;   \n"
        ,"   v_Err  VARCHAR2(2000);   \n"
        ,"   v_Sum  ddl_acc_dbt.t_Sum%TYPE := 0;   \n"
        ,"   v_Bfс VARCHAR2(50);   \n"
        ,"   v_Bfi  Dfininstr_Dbt.t_Fiid%TYPE;   \n"
        ,"   Ex_Ok EXCEPTION;   \n"
        ,"   Ex_Er EXCEPTION;   \n"
        ,"BEGIN   \n"
        ,"   BEGIN   \n"
        ,"      NULL;   \n"
        ,"      -- получить запись операции   \n"
        ,"      BEGIN   \n"
        ,"         SELECT * INTO r_Opr FROM ddl_acc_dbt t WHERE t.t_Id = v_Opr;   \n"
        ,"      EXCEPTION   \n"
        ,"         WHEN OTHERS THEN   \n"
        ,"            RAISE Ex_Ok;   \n"
        ,"      END;   \n"
        ,"      -- получить запись договора   \n"
        ,"      BEGIN   \n"
        ,"         SELECT * INTO r_Sfc FROM Dsfcontr_Dbt t WHERE t.t_Id = :p_ContrId/*r_Opr.t_ClientContr*/;   \n"/*  Если в РОВУ  зачисляются деньги на валютный рынок, то надо брать r_Sfc так как в r_Opr id договора по фондовому рынку , а нужен валютный для комиссии */
        ,"      EXCEPTION   \n"
        ,"         WHEN OTHERS THEN   \n"
        ,"            v_Err := 'Для операции ' || r_Opr.t_Code || ' от ' || To_Char(r_Opr.t_Valuedate, 'DD.MM.YYYY') ||   \n"
        ,"                     ' не найден договор';   \n"
        ,"            RAISE Ex_Er;   \n"
        ,"      END;   \n"
        ,"      -- определить базовую валюту договора   \n"
        ,"      v_Bfс := TRIM(Chr(0) FROM Rsb_Struct.Getstring(Rsi_Rsb_Kernel.Getnote(Objtype  => Cnst.Objtype_Sfcontr   \n"
        ,"                                                               ,Objid    => Lpad(r_Sfc.t_id/*r_Opr.t_ClientContr*/, 10, '0')   \n" /* Если в РОВУ  зачисляются деньги на валютный рынок, то надо брать r_Sfc так как в r_Opr хранится id договора по фондовому рынку , а нужен валютный для комиссии */
        ,"                                                               ,Notekind => 102   \n"
        ,"                                                               ,Dat      => r_Opr.t_Valuedate)));   \n"
        ,"      IF v_Bfс IS NULL THEN   \n"
        ,"         v_Err := 'Для договора ' || r_Sfc.t_Number || ' не указана базовая валюта';   \n"
        ,"         RAISE Ex_Er;   \n"
        ,"      END IF;   \n"
        ,"      BEGIN   \n"
        ,"         SELECT t.t_Fiid INTO v_Bfi FROM Dfininstr_Dbt t WHERE t.t_Ccy = v_Bfс;   \n"
        ,"      EXCEPTION   \n"
        ,"         WHEN OTHERS THEN   \n"
        ,"            v_Err := 'Для договора ' || r_Sfc.t_Number || ' указана базовая валюта ' || v_Bfс ||   \n"
        ,"                     ' отсутсвует в справочнике валют';   \n"
        ,"            RAISE Ex_Er;   \n"
        ,"      END;   \n"
        ,"      IF v_Bfi = r_Opr.t_FIID THEN   \n"
        ,"         RAISE Ex_Ok;   \n"
        ,"      END IF;   \n"
        ,"         v_Sum := r_Opr.t_Sum;   \n"
        ,"   EXCEPTION   \n"
        ,"      WHEN Ex_Ok THEN   \n"
        ,"         v_Err := '';   \n"
        ,"         v_Sum := 0;   \n"
        ,"      WHEN OTHERS THEN   \n"
        ,"         v_Sum := 0;   \n"
        ,"         v_Err := Nvl(v_Err, Dbms_Utility.Format_Error_Stack || ' ' || Dbms_Utility.Format_Error_Backtrace);   \n"
        ,"   END;   \n"
        ,"   :p_Err := v_Err;   \n"
        ,"   :p_Sum := v_Sum;   \n"
        ,"END;   \n"
       );
   rsdc = rsdcommand(sqls);
   rsdc.AddParam("p_opr", RSDBP_IN , deal.ID);
   rsdc.AddParam("p_ContrId", RSDBP_IN , ContrID);
   rsdc.AddParam("p_err", RSDBP_OUT, v_string, 2000);
   rsdc.AddParam("p_sum", RSDBP_OUT, v_double);
   rsdc.Execute;
   sqls = rsdc.Value("p_Err");
   p_bas_sm = rsdc.Value("p_Sum");
   rsdc = null;
   if ((sqls != null) and (sqls != nullval))
      RunError(sqls, sqls); 
   end;   
   p_bas_fi = deal.FIID;
end;
/*CHVA 507198*/
// рассчитать сумму комиссии
macro CalcCommissionSum( docKind, Doc, sfalg_adr, sfcontr_adr )
   var bassum = TRecHandler( "sfbassum.str" ), bas_sm = $0, bas_fi = 0;
   record rDeal(nptxop); 
   record rContr(sfcontr);
   record rDeal2(dl_acc);/*CHVA*/

   SetBuff( rContr, sfcontr_adr );
    /*CHVA 507198*/
   if (docKind ==159)
   SetBuff(rDeal2, Doc);
 
     calc_base_sum_inacc(rDeal2,rContr.ID, @bas_fi, @bas_sm);
     // пока отладка возвращаем тестовую сумму
     //bas_sm = 1000.00;
     bassum.Clear();
     bassum.rec.baseType        = 1;
     bassum.rec.baseType2       = bassum.rec.baseType;
     bassum.rec.baseSum         = bas_sm;
     bassum.rec.FIID_baseSum    = bas_fi;
     bassum.rec.baseSum2        = bassum.rec.baseSum;
     bassum.rec.FIID_baseSum2   = bassum.rec.FIID_baseSum;
     bassum.rec.BaseObjectType  = docKind;
     bassum.rec.BaseObjectID    = rDeal2.ID;
     if (InsertSumList( bassum ))
      MsgBox( "Ошибка при вставке базовой суммы по сделке.\n" + GetErrMsg() );
      MacroError = 1;
     end;
    
    else /*CHVA 507198*/
   SetBuff(rDeal, Doc);
   SetBuff( rContr, sfcontr_adr );
   if (rdeal.SubKind_Operation == 20)
      return; 
   end;
   calc_base_sum(rDeal, @bas_fi, @bas_sm);
   // пока отладка возвращаем тестовую сумму
   //bas_sm = 1000.00;
   bassum.Clear();
   bassum.rec.baseType        = 1;
   bassum.rec.baseType2       = bassum.rec.baseType;
   bassum.rec.baseSum         = bas_sm;
   bassum.rec.FIID_baseSum    = bas_fi;
   bassum.rec.baseSum2        = bassum.rec.baseSum;
   bassum.rec.FIID_baseSum2   = bassum.rec.FIID_baseSum;
   bassum.rec.BaseObjectType  = docKind;
   bassum.rec.BaseObjectID    = rDeal.ID;
   if (InsertSumList( bassum ))
      MsgBox( "Ошибка при вставке базовой суммы по сделке.\n" + GetErrMsg() );
      MacroError = 1;
   end;
end;
end;

// сформировать документы комиссии
macro make_comission_doc(r_doc, r_coms)
   var Acc306XX = TRecHandler("account");
   var Acc47423 = TRecHandler("account");
   var Acc706XX = TRecHandler("account");
   record DebAcc ("account.dbt");
   record KredAcc ("account.dbt");

   var SFD, msg = "", FD;

   SetDialogFlag(0);
   SFD = DL_SubContrFD(r_doc.Contract);
   if (strlen(trim(r_coms.Coms_Ku)) == 0)
      r_coms.Coms_Ku = "+КВ, ц/б";
   end;
 
   if (not SFD.OpenAccount( "+РасчетыКомисс1", NULL, NULL, Acc47423, r_doc.OperDate/*SFD.GetSubContr().rec.DateBegin*/, r_Doc.Currency))/*DEF-31387*/
      msg =  "Ошибка получения счета 47423 (категория \"+РасчетыКомисс1\") для договора " + SFD.GetSubContr().rec.Number + " " + GetErrMsg();  
      runerror(msg, msg);
   end;
   r_coms.Coms_Dbt = Acc47423.rec.Account;
    if( (Acc47423.rec.code_currency ==NATCUR) and (r_coms.Coms_Fi == NATCUR ))/*CHVA 515749*/
      SFD.currencyAcc47423 = 0;
    end;
     /*PNV 524270*/
     FD = DLFirstDocNPTXOP(r_doc);
     //if (not FD.OpenAccount( r_coms.Coms_Ku, NULL, NULL, Acc706XX, r_Doc.OperDate, NATCUR))
     if (not FD.OpenAccount( r_coms.Coms_Ku, NULL, NULL, NULL, Acc706XX, r_Doc.OperDate, NATCUR)) 
      msg = "Ошибка получения счета 706 (категория \"r_coms.Coms_Ku\") для договора " + SFD.GetSubContr().rec.Number + " - " + GetErrMsg();
      runerror(msg, msg);
   end;
   r_coms.Coms_Crd = Acc706XX.rec.Account;
   if (not SFD.OpenAccount( "ДС клиента, ц/б", NULL, NULL, Acc306XX, r_doc.OperDate/*SFD.GetSubContr().rec.DateBegin*/, r_Doc.Currency))/*DEF-31387*/
      msg =  "Ошибка получения счета 306 (категория \"ДС клиента, ц/б\") для договора " + SFD.GetSubContr().rec.Number + " " + GetErrMsg();  
      runerror(msg, msg);
   end;
   //сделать платежи и проводки      
   FD = DLFirstDocNPTXOP(r_doc);
   msg =  ПроводкаПоКатегориямУчета(FD,                  // Первичный документ
                                   Acc47423,             // КатегДеб
                                   Acc706XX,             // КатегКредит
                                   r_doc.OperDate,       // Дата 
                                   1,                    // Глава 
                                   r_coms.Coms_Fi,       // Валюта 
                                   r_coms.Coms_Sm,       // Сумма  
                                   null,
                                   INPCARRY,             // Result_Carry 
                                   " 1",                 // Kind_Oper 
                                   "",                   // Numb_Document 
                                   "Комиссия за зачисление денежных средств на Брокерский счет по Соглашению об оказании брокерских услуг № " + SFD.GetSubContr().rec.Number + " от " + string(SFD.GetSubContr().rec.DateBegin:f),
                                   0,                    // PaymentID
                                   null,
                                   FIROLE_COMISS_CLIENT, //FIRoleReceiver
                                   Acc47423.rec.Code_Currency, // валюта счета: Дт   
                                   Acc706XX.rec.Code_Currency, // валюта счета: Кд    
                                   null,
                                   null,
                                   null,
                                   true                  //IsSummaryCarry
                                 );
   if (valtype(msg) == v_string)
      runerror(msg, msg);
   end;   
   msg = ПроводкаПоКатегориямУчета( FD,          //FIROLE_COMISS_CLIENT
                                   Acc306XX,             // КатегДеб
                                   Acc47423,             // КатегКредит
                                   r_doc.OperDate,       // Дата 
                                   1,                    // Глава 
                                   r_coms.Coms_Fi,       // Валюта
                                   r_coms.Coms_Sm,       // Сумма  
                                   null,
                                   INPCARRY,             // Result_Carry 
                                   " 1",                 // Kind_Oper 
                                   "",                   // Numb_Document 
                                   "Комиссия за зачисление денежных средств на Брокерский счет по Соглашению об оказании брокерских услуг № " + SFD.GetSubContr().rec.Number + " от " + string(SFD.GetSubContr().rec.DateBegin:f),
                                   0,                    // PaymentID
                                   null,
                                   FIROLE_COMISS_CLIENT, //FIRoleReceiver
                                   Acc306XX.rec.Code_Currency, // валюта счета: Дт 
                                   Acc306XX.rec.Code_Currency, // валюта счета: Кд     
                                   null,
                                   null,
                                   null,
                                   true                  //IsSummaryCarry
                                 );
   if (valtype(msg) == v_string)
      runerror(msg, msg);
   end;   
   var ВидРО = 102, IsOut = true;

   if( ПИ_ВестиВнутреннийУчет() )
      if( GetAccount(FD, FD.ВУ_ПолучитьКатегориюДебет(ВидРО, IsOut), FD.ВУ_ПолучитьРольФИ(ВидРО, true, IsOut), DebAcc, r_doc.OperDate, Acc306XX.rec.Code_Currency) == false )
         return false;
      end;
      if( GetAccount(FD, FD.ВУ_ПолучитьКатегориюКредит(ВидРО, IsOut), FD.ВУ_ПолучитьРольФИ(ВидРО, false, IsOut), KredAcc, r_doc.OperDate, Acc306XX.rec.Code_Currency) == false )
         return false;
      end;
  
      if( not ПроводкаПоКатегориямУчета( FD, 
                                         DebAcc, 
                                         KredAcc,
                                         r_doc.OperDate,
                                         FD.ВУ_ОпределениеГлавы(Acc306XX.rec.Code_Currency),
                                         r_coms.Coms_Fi,
                                         r_coms.Coms_Sm,
                                         doc,
                                         INPCARRY,
                                         "",
                                         "",
                                         FD.ВУ_ОснованиеПроводки(ВидРО, IsOut),
                                         0,
                                         null, 
                                         null,
                                         Acc306XX.rec.Code_Currency, Acc306XX.rec.Code_Currency,
                                         null, null, NULL, null,
                                         true,
                                         ВидРО
                                       )
        )
         return false;
      end;
   end;


   SetDialogFlag(1);
onerror(err); 
   if ((err.Err != null) and (err.err != nullval)) 
      r_coms.Coms_Err =  err.Err;  
   else   
      r_coms.Coms_Err =  err.Message;  
   end;
   SetDialogFlag(1);
end;


//CHVA 507198 сформировать документы комиссии РОВУ
macro make_comission_doc_inacc(r_doc, r_coms)
   var Acc306XX = TRecHandler("account");
   var Acc47423 = TRecHandler("account");
   var Acc706XX = TRecHandler("account");
   record DebAcc ("account.dbt");
   record KredAcc ("account.dbt");


   var SFD, msg = "", FD;
   SetDialogFlag(0);
   SFD = DL_SubContrFD(r_coms.ContrId);/*передаем id договора по валютному рынку для корректного определения счетов по комиссии*/
   if (strlen(trim(r_coms.Coms_Ku)) == 0)
      r_coms.Coms_Ku = "+КВ, ц/б";
   end;

   /*CHVA*/
  var rComiss  = TRecHandler( "sfcomiss.dbt" );
  SfGetComiss( r_coms.coms_tp, r_coms.coms_nm, rComiss );
     if (r_coms.Coms_Fi == 0 )
       r_coms.Coms_Ku = "+КВ, ц/б осн.вал"; 
     end;

     if (rComiss.rec.paynds != 1 ) 
      r_coms.Coms_Ku = "+КВ, ц/б nds";     
     end;
   /*CHVA*/

   if (not SFD.OpenAccount( r_coms.Coms_Ku, NULL, NULL, Acc706XX, r_Doc.ValueDate, NATCUR))
      msg = "Ошибка получения счета 706 (категория \"r_coms.Coms_Ku\") для договора " + SFD.GetSubContr().rec.Number + " - " + GetErrMsg();
      runerror(msg, msg);
   end;
   r_coms.Coms_Crd = Acc706XX.rec.Account;
   if (not SFD.OpenAccount( "+РасчетыКомисс1", NULL, NULL, Acc47423, SFD.GetSubContr().rec.DateBegin, r_Doc.FIID))
      msg =  "Ошибка получения счета 47423 (категория \"+РасчетыКомисс1\") для договора " + SFD.GetSubContr().rec.Number + " " + GetErrMsg();  
      runerror(msg, msg);
   end;
   r_coms.Coms_Dbt = Acc47423.rec.Account;
   if (not SFD.OpenAccount( "ДС клиента, ц/б", NULL, NULL, Acc306XX, SFD.GetSubContr().rec.DateBegin, r_Doc.FIID))
      msg =  "Ошибка получения счета 306 (категория \"ДС клиента, ц/б\") для договора " + SFD.GetSubContr().rec.Number + " " + GetErrMsg();  
      runerror(msg, msg);
   end;
   //сделать платежи и проводки      
   FD = DLFirstDocDL_ACC(r_doc);
   msg =  ПроводкаПоКатегориямУчета(FD,                  // Первичный документ
                                   Acc47423,             // КатегДеб
                                   Acc706XX,             // КатегКредит
                                   r_doc.ValueDate,       // Дата 
                                   1,                    // Глава 
                                   r_coms.Coms_Fi,       // Валюта 
                                   r_coms.Coms_Sm,       // Сумма  
                                   null,
                                   INPCARRY,             // Result_Carry 
                                   " 1",                 // Kind_Oper 
                                   "",                   // Numb_Document 
                                   "Комиссия за вывод денежных средств с Брокерского счета по Соглашению об оказании брокерских услуг № " + SFD.GetSubContr().rec.Number + " от " + string(SFD.GetSubContr().rec.DateBegin:f),
                                   0,                    // PaymentID
                                   null,
                                   FIROLE_COMISS_CLIENT, //FIRoleReceiver
                                   Acc47423.rec.Code_Currency, // валюта счета: Дт   
                                   Acc706XX.rec.Code_Currency, // валюта счета: Кд    
                                   null,
                                   null,
                                   null,
                                   true                  //IsSummaryCarry
                                 );
   if (valtype(msg) == v_string)
      runerror(msg, msg);
   end;   
   msg = ПроводкаПоКатегориямУчета( FD,          //FIROLE_COMISS_CLIENT
                                   Acc306XX,             // КатегДеб
                                   Acc47423,             // КатегКредит
                                   r_doc.ValueDate,       // Дата 
                                   1,                    // Глава 
                                   r_coms.Coms_Fi,       // Валюта
                                   r_coms.Coms_Sm,       // Сумма  
                                   null,
                                   INPCARRY,             // Result_Carry 
                                   " 1",                 // Kind_Oper 
                                   "",                   // Numb_Document 
                                   "Комиссия за вывод денежных средств с Брокерского счета по Соглашению об оказании брокерских услуг № " + SFD.GetSubContr().rec.Number + " от " + string(SFD.GetSubContr().rec.DateBegin:f),
                                   0,                    // PaymentID
                                   null,
                                   FIROLE_COMISS_CLIENT, //FIRoleReceiver
                                   Acc306XX.rec.Code_Currency, // валюта счета: Дт 
                                   Acc306XX.rec.Code_Currency, // валюта счета: Кд     
                                   null,
                                   null,
                                   null,
                                   true                  //IsSummaryCarry
                                 );
   if (valtype(msg) == v_string)
      runerror(msg, msg);
   end;   
/*CHVA 507198*/

   SetDialogFlag(1);
onerror(err); 
   if ((err.Err != null) and (err.err != nullval)) 
      r_coms.Coms_Err =  err.Err;  
   else   
      r_coms.Coms_Err =  err.Message;  
   end;
   SetDialogFlag(1);
end;