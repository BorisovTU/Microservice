IMPORT PTinter, RSBDataSet, dl_plib, dlgCommon, funk, dl_kvlib, fx_globals; 
PRIVATE VAR d0, pId2, rs0, cmd2, {curdate}, sql0, flag, rs05, que; 

PRIVATE VAR col2 = TArray();
PRIVATE VAR v_DealId = TArray(), v_count;

//teg 13.01.19
PRIVATE MACRO write_log(messLog)
    var cmd;
        cmd = RsdCommand( "begin rshb_brkrep.InsertLog(?); end;" );
        cmd.addParam( "mes", RSDBP_IN, messLog );
        cmd.execute();
END;

d0 = {curdate};
sql0 = "select a.t_id pId2 , a.t_fiid  fiid,  (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = a.t_fiid) fiid1, ";
sql0 = sql0 + " to_char(a.t_pamount,'999,999,999,999.00') su2, to_char(a.t_ramount,'999,999,999,999.00') su1,  ";
sql0 = sql0 + " to_char(a.t_kredetvm - a.t_debetvm,'999,999,999,999.00') SumVM, ";

sql0 = sql0 + " (select to_char(bb.t_baseamount,'999,999,999,999.00') from ddl_nett_dbt aa , dpmpaym_dbt bb where aa.t_contractor= " + _NKC + " and aa.t_dockind = 140 ";
sql0 = sql0 + "      and bb.t_dockind=aa.t_dockind and bb.t_documentid = aa.t_nettingid and bb.t_valuedate = a.T_VDATE and bb.t_basefiid=a.t_fiid and bb.t_payer = " + _BANK0 + " ) su4,";

sql0 = sql0 + " (select to_char(bb.t_baseamount,'999,999,999,999.00') from ddl_nett_dbt aa , dpmpaym_dbt bb where aa.t_contractor = " + _NKC + " and aa.t_dockind = 140 ";
sql0 = sql0 + "      and bb.t_dockind = aa.t_dockind and bb.t_documentid = aa.t_nettingid and bb.t_valuedate = a.T_VDATE and bb.t_basefiid = a.t_fiid and bb.t_payer!= " + _BANK0 + "  ) su3,";

sql0 = sql0 + " (select to_char(  (select nvl(sum(b.t_baseamount),0) from ddvndeal_dbt a, dpmpaym_dbt b  ";
sql0 = sql0 + " where a.t_contractor = 1181 and a.t_netting = 'X' and b.t_valuedate = a.T_VDATE and ";
sql0 = sql0 + " (b.t_dockind = 4813 or  b.t_dockind = 4815 or b.t_dockind = 199) and b.t_documentid=a.t_id  and b.t_basefiid = a.t_fiid and b.t_payer=1  ) - ";
sql0 = sql0 + "  (select nvl(sum(b.t_baseamount),0) from ddvndeal_dbt a, dpmpaym_dbt b ";
sql0 = sql0 + " where a.t_contractor = 1181 and a.t_netting = 'X' and b.t_valuedate = a.T_VDATE and ";
sql0 = sql0 + " (b.t_dockind = 4813 or  b.t_dockind = 4815 or b.t_dockind = 199) and b.t_documentid = a.t_id  and b.t_basefiid = a.t_fiid and b.t_payer!=1 )  ,'999,999,999,999.99')   from dual )  su0, "; 

sql0 = sql0 + " (select to_char(  (select nvl(sum(b.t_baseamount),0) from ddvndeal_dbt a, dpmpaym_dbt b  ";
sql0 = sql0 + " where a.t_contractor = 1181 and a.t_netting = 'X' and b.t_valuedate = a.T_VDATE and ";
sql0 = sql0 + " (b.t_dockind = 4813 or  b.t_dockind = 4815 or b.t_dockind = 199) and b.t_documentid = a.t_id  and b.t_basefiid = a.t_fiid and b.t_payer = 1 and b.t_purpose not in (41) ) - ";
sql0 = sql0 + "  (select nvl(sum(b.t_baseamount),0) from ddvndeal_dbt a, dpmpaym_dbt b ";
sql0 = sql0 + " where a.t_contractor = 1181 and a.t_netting = 'X' and b.t_valuedate = a.T_VDATE and ";
sql0 = sql0 + " (b.t_dockind = 4813 or  b.t_dockind = 4815 or b.t_dockind = 199) and b.t_documentid = a.t_id  and b.t_basefiid = a.t_fiid and b.t_payer != 1 and b.t_purpose not in (41)  ) - a.t_pamount + a.t_ramount  ,'999,999,999,999.99')   from dual )  su9, "; 

sql0 = sql0 + " (case when ";
sql0 = sql0 + " (select bb.t_paymstatus from ddl_nett_dbt aa , dpmpaym_dbt bb where aa.t_contractor = " + _NKC + " and aa.t_dockind = 140 ";
sql0 = sql0 + "      and bb.t_dockind = aa.t_dockind and bb.t_documentid = aa.t_nettingid and bb.t_valuedate = a.T_VDATE and bb.t_fiid = a.t_fiid and bb.t_payer = " + _BANK0 + "  ) ";
sql0 = sql0 + " = 3000 then 'Сформирован' else ";

sql0 = sql0 + " (case when ";
sql0 = sql0 + " (select bb.t_paymstatus from ddl_nett_dbt aa , dpmpaym_dbt bb where aa.t_contractor= " + _NKC + " and aa.t_dockind = 140 ";
sql0 = sql0 + "      and bb.t_dockind = aa.t_dockind and bb.t_documentid = aa.t_nettingid and bb.t_valuedate = a.T_VDATE and bb.t_fiid = a.t_fiid and bb.t_payer = " + _BANK0 + "  ) ";
sql0 = sql0 + " = 32000 then 'Исполнен' else ' ' end ) ";
sql0 = sql0 + " end )  sta2,";

sql0 = sql0 + " (case when ";
sql0 = sql0 + " (select bb.t_paymstatus from ddl_nett_dbt aa , dpmpaym_dbt bb where aa.t_contractor = " + _NKC + " and aa.t_dockind = 140 ";
sql0 = sql0 + "      and bb.t_dockind = aa.t_dockind and bb.t_documentid = aa.t_nettingid and bb.t_valuedate = a.T_VDATE and bb.t_fiid = a.t_fiid and bb.t_payer != " + _BANK0 + "  ) ";
sql0 = sql0 + " = 3000 then 'Сформирован' else ";
sql0 = sql0 + " (case when ";
sql0 = sql0 + " (select bb.t_paymstatus from ddl_nett_dbt aa , dpmpaym_dbt bb where aa.t_contractor = " + _NKC + " and aa.t_dockind = 140 ";
sql0 = sql0 + "      and bb.t_dockind = aa.t_dockind and bb.t_documentid = aa.t_nettingid and bb.t_valuedate = a.T_VDATE and bb.t_fiid = a.t_fiid and bb.t_payer != " + _BANK0 + "  ) ";
sql0 = sql0 + " = 32000 then 'Обработан' else ' ' end ) ";
sql0 = sql0 + "  end )  sta1";

sql0 = sql0 + " from  DSTD_BS_DBT a where a.T_VDATE = '" + СДАТ(d0) + "' order by a.t_id desc";
//  msgbox(sql0);

cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );

MACRO EvProc2 (rs0, cmd2, id, key )
     if (cmd2 == DLG_INIT)	// Инициализация
        if (pId2 != "0")  // Надо найти запись
            v_count = 0;
            while ( (rs0.value ("pId2") != pId2) And (Not rs0.EOF) )  
		             if (ValType(rs0.value ("pId2")) == 26)
			             v_DealId(v_count) = 0;
		             else
			             v_DealId(v_count)= rs0.value ("pId2");
		             end;
                     rs0.Move(1, RELATIVE);
		             v_count = v_count + 1;
            end;
        end;
        GoToScroll(rs0, true);
     elif (cmd2 == DLG_KEY)
        pId2 = rs0.value ("pId2");
        if(DLG_KEY_ENTER == Key)
           return CM_SELECT;
        elif(DLG_KEY_F12 == Key) 
           execmacrofile("dv_fiid.mac", "bfiid");
           return CM_SELECT;
        elif(DLG_KEY_F11 == Key) 
           execmacrofile("dv_bsdel.mac", "bsdelv", rs0.value ("fiid") );
           return CM_SELECT;
        elif(DLG_KEY_F8 == Key) 
           que = " update DSTD_BS_DBT set t_status = 0 where t_id = " + rs0.value ("pId2");
           rs05 = LnGetRecordSet(que);
           return CM_SELECT;
        elif(DLG_KEY_F6 == Key) 
           execmacrofile("dv_pmbo", "pmfissiko");
           return CM_SELECT;
        elif(DLG_KEY_F2 == Key) 
           execmacrofile("ntgnew1", "Newnett");
           return CM_SELECT;
        elif(DLG_KEY_F3 == Key) 
           execmacrofile("dv_bkom.mac", "bkom");
           return CM_SELECT;
        elif(DLG_KEY_F4 == Key) 
           execmacrofile("dv_avbs.mac", "LoadNettingFile");
           return CM_SELECT;
        elif(DLG_KEY_F10 == Key) 
           execmacrofile("dv_bsdel.mac", "bsdel");
           return CM_SELECT;
        end;
     end;
  end;

  AddCol (col2, 0, "fiid1","Валюта ", 5);
  AddCol (col2, 1, "su1","Cумма требований по БС", 25);
  AddCol (col2, 2, "su2","Сумма обязательств по БС", 20);
  AddCol (col2, 3, "SumVM","Сумма Вар.Маржи", 20);
  AddCol (col2, 4, "su0","Итого по сделкам", 20);
  AddCol (col2, 5, "su9","Разность БС/итоги по сделкам", 25);
  AddCol (col2, 6, "su3","Cумма требований в неттинге", 20);
  AddCol (col2, 7, "su4","Сумма обязательств в неттинге", 25);
  AddCol (col2, 8, "sta1","Статус платежа по требованиям", 25);
  AddCol (col2, 9, "sta2","Статус платежа по обязательствам ", 25);

   while(RunScroll(cmd2, 9, col2, null, @EvProc2, "Монитор по БИРЖЕВЫМ СВИДЕТЕЛЬСТВАМ  за " + СДАТ(d0), "F2- Неттинг F3- Комиссии F4- Загрузить F5- Вар. маржа F6- Контроль платежей F8- Отвязать неттинг F10- Сделки F11- Cделки по валюте F12- Настройки ESC- Выход", null, 0, 0) )
     cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );
   end;
   exit(1);
END;
