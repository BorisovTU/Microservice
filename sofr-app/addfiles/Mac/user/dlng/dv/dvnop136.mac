/*
$Name:        dvnop136.mac
$Module:      ФИССиКО
$Description: Внебиржевая операция. Процентный СВОП. Шаг: Исполнение 2ч. Отражение финансового результата.
*/
IMPORT InsCarryDoc, "dv_categ.mac", "dv_car.mac";

MACRO ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )
  record ndeal(dvndeal);
  SetBuff( ndeal, FDoc );
  var FD = DVFirstDocNDeal(DocKind, ndeal);
  var ДатаИсполненияШага:date;
  var OutPFIBuf = TRecHandler("account");
  var RestOutPFI;

  ДатаИсполненияШага = DV_GetPlanDateStep(ID_Operation, ID_Step);

  if ( (FD.IsPctSWAP()) and ((FD.Deal.rec.SwapType == DLSWAP_XCCY) OR (FD.Deal.rec.SwapType == DLSWAP_OIS))) //Списание фин. реза только для валютно-процентных СВОПов.
  else
     return 0;
  end; 

  if ( ( not FD.IsExistAccount("Выбытие ПФИ", null, true, FIROLE_UNDEF, OutPFIBuf, null, ДатаИсполненияШага, NATCUR)) and 
       ( not FD.OpenAccount( "Выбытие ПФИ", null, false, FIROLE_UNDEF, OutPFIBuf, ДатаИсполненияШага, NATCUR, null, null ) ))
      MsgBoxEx("Счет категории  \"Выбытие ПФИ\" неопределен или недоступен в данной операции");
  end;

  RestOutPFI = GetRestAccountTRH(OutPFIBuf,ДатаИсполненияШага );
  if (RestOutPFI > 0)
      if( not ПроводкаПоКатегориямУчета( FD, 
                                         "Выбытие ПФИ",                      /* Деб */
                                         "Доходы ПФИ",                       /* Кредит */
                                         ДатаИсполненияШага,                 /* Дата */
                                         1,                                  /* Глава */
                                         NATCUR,                             /* Валюта */
                                         abs(RestOutPFI),                    /* Сумма */
                                         Doc,                                /* Документ */
                                         INPCARRY,                           /* Result_Carry */
                                         "",                                 /* Kind_Oper */
                                         "",                                 /* Numb_Document */
                                         "Отнесение фин. рез-а на доходы по сделке "+FD.DealCode()+" от "+StrSubSt(String(FD.ДатаСделки():f), ".", "/") + ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*///"Отражение финансового результата", /* Ground */
                                         NULL, NULL, NULL,
                                         NATCUR, NATCUR
                                        )
       )
        return 1;
      end;
  elif (RestOutPFI < 0)
      if( not ПроводкаПоКатегориямУчета( FD, 
                                         "Расходы ПФИ",                      /* Деб */
                                         "Выбытие ПФИ",                      /* Кредит */
                                         ДатаИсполненияШага,                 /* Дата */
                                         1,                                  /* Глава */
                                         NATCUR,                             /* Валюта */
                                         abs(RestOutPFI),                    /* Сумма */
                                         Doc,                                /* Документ */
                                         INPCARRY,                           /* Result_Carry */
                                         "",                                 /* Kind_Oper */
                                         "",                                 /* Numb_Document */
                                         "Отнесение фин. рез-а на расходы по сделке "+FD.DealCode()+" от "+StrSubSt(String(FD.ДатаСделки():f), ".", "/")+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*///"Отражение финансового результата", /* Ground */
                                         NULL, NULL, NULL,
                                         NATCUR, NATCUR
                                         )
          )
            return 1;
      end;
  end;

  return 0;
END;
