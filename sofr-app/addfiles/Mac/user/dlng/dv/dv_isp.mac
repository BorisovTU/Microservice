import DVInter,dv_lib,fx_globals;
import InsCarryDoc, "dv_categ.mac", "dv_car.mac",funk;

   private var que,rs9,ii,{curdate},da,dealid,rs5,zz,dd,j9;
   var nn,snn,d2,d0,kind,dealcode;

   dd={curdate};
   getdate(dd,"ВВОД");
   da=DV_SDAT(dd);
   // da=DV_SDAT({curdate});


   que="select count(*) from ddvndeal_dbt a  where a.t_contractor="+_NKC+"  and (a.t_kind=22730 or a.t_kind=2730 or a.t_kind=2740)  and to_char(t_date,'dd.mm.yyyy') = '"+da+"'";
   rs9 = LnGetRecordSet(que);
   if(rs9 != null)
     while(rs9.moveNext())
       zz=int(rs9.value(0));
     end;
   end;


   InitProgress( zz, "Обработка сделок FX " );  

   j9=1;
   que="select t_id,t_kind,to_char(t_date,'dd.mm.yyyy'),t_code  from ddvndeal_dbt a  where a.t_contractor="+_NKC+"  and (a.t_kind=22730 or a.t_kind=2730 or a.t_kind=2740)  and to_char(t_date,'dd.mm.yyyy') = '"+da+"'";
   rs9 = LnGetRecordSet(que);
   if(rs9 != null)
     while(rs9.moveNext())
            j9=j9+1;
            useprogress(j9);
            dealid=int(rs9.value(0));
            kind=rs9.value(1);
            dealcode=rs9.value(3);

 
    if (kind == 2740 )
      snn=3;
    else
      snn=1;
    end;

    d0=DV_DAT(rs9.value(2));
    d2=DV_DAT(d0);
    que="select to_char(t_valuedate,'dd.mm.yyyy') from dpmpaym_dbt a  where a.t_dockind=4813 and a.t_documentid ="+dealid+" and a.t_purpose="+snn; 
    rs5 = LnGetRecordSet(que);
    if(rs5 != null)
     if (rs5.moveNext) 
        d2=DV_DAT(rs5.value(0));
     end;
    end;
    if ( d0 != d2)
      snn=workdays(d0,d2)-1;
      // msgbox(dealcode);
      que="update ddvndeal_dbt set t_periodcls="+snn+"  where t_id="+dealid;
      rs5 = LnGetRecordSet(que);
    end;




     end;
   end;

   RemProgress; 
   exit(1);

END;