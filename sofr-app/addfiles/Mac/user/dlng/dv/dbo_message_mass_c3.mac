import RSD, globals;
import BankInter, dlquery, cb_sql, oralib, likepy;
import dbo_message_main_c3;

const K_ENTER   = 13;
//const K_ESC     = 27;
const K_F3      = 317;
const K_F2      = 316;
const K_F8      = 322;
const K_F9      = 323;

private class CLog;
   private macro PrepareLog()
      if ( execSqlSelect ("select 1 from user_tables where upper(table_name) = upper('RSHB_CloseAccLog')").moveNext () )
        /*  if ( not execSql ("truncate table RSHB_CloseAccLog") )
              return false;
          end;*/
      else
          if ( not execSql ("create table RSHB_CloseAccLog (t_kind number not null, t_account varchar2(25),  t_text varchar2(4000), t_timestamp timestamp, t_oper number, t_operdate date) ") )
              return false;
          end;
      end;
      return true;
   end;

   Macro add ( kind, account, text )
       execSql ("insert into RSHB_CloseAccLog values (:1, :2, :3, systimestamp, :4, :5)", makeArray (sqlParam ("1", kind), sqlParam ("2", account), sqlParam ("3", text),sqlParam ("4", {oper}),sqlParam ("5", {curdate})));
   End;

   if (not PrepareLog() );
      msgbox("Ошибка инициализации логирования");
      exit(1);
   end;
end;

private macro FillTmpTable()
var cmd = RsdCommand(" truncate table dbo_message_tmp ");
    cmd.execute();
    cmd = null;
var sql = 
          "insert into dbo_message_tmp " +
          "  SELECT d.T_dlcontrID, " +
          "         DECODE (avrexch.t_id, NULL, CHR (0), CHR (88)) avrexch, " +
          "         DECODE (outexch.t_id, NULL, CHR (0), CHR (88)) outexch, " +
          "         DECODE (dvexch.t_id, NULL, CHR (0), CHR (88)) dvexch, " +
          "         DECODE (moneyexch.t_id, NULL, CHR (0), CHR (88)) moneyexch, " +
          "         s.t_name, " +
          "         S.T_PARTYID, " +
          "         s.t_number, " +
          "         s.t_datebegin, " +
          "         (                                                                                                        " +
          "           select o.t_name from dobjatcor_dbt at, dobjattr_dbt o where at.t_objecttype = 207 and at.t_groupid = 101 " +
          "           and at.t_objecttype = o.t_objecttype  AND sysdate between AT.T_VALIDfromDATE and AT.T_VALIDTODATE and at.t_groupid = o.t_groupid and at.t_attrid = o.t_attrid and at.t_object = lpad(d.t_dlcontrid,34,'0')),chr(1), " +
          "         case when (m.t_senddate is null) or (m.t_senddate = TO_DATE ('01010001', 'ddmmyyyy')) then chr(0) else CHR (88) end issend, " +
          "         0 countsend, " +
          "         m.t_createdate, " +
          "         M.T_SENDDATE, " +
          "         D.T_EMAIL, " +
          "         CHR (0) resend " +
          "    FROM dsfcontr_dbt s, ddlcontr_dbt d " +
          "                  LEFT JOIN dsfcontr_dbt avrexch ON     avrexch.t_servkind = 1 AND avrexch.t_servkindsub = 8 " +
          "                     AND avrexch.t_id IN (SELECT t_sfcontrid FROM ddlcontrmp_dbt WHERE t_dlcontrid = d.t_dlcontrid) " +
          "               LEFT JOIN dsfcontr_dbt outexch ON     outexch.t_servkind = 1 AND outexch.t_servkindsub = 9  " +
          "                    AND outexch.t_id IN (SELECT t_sfcontrid FROM ddlcontrmp_dbt WHERE t_dlcontrid = d.t_dlcontrid) " +
          "            LEFT JOIN dsfcontr_dbt dvexch ON dvexch.t_servkind = 15 " +
          "               AND dvexch.t_id IN (SELECT t_sfcontrid FROM ddlcontrmp_dbt WHERE t_dlcontrid = d.t_dlcontrid) " +
          "         LEFT JOIN dsfcontr_dbt moneyexch ON moneyexch.t_servkind = 21 " +
          "            AND moneyexch.t_id IN (SELECT t_sfcontrid FROM ddlcontrmp_dbt WHERE t_dlcontrid = d.t_dlcontrid) " +
//          "         left join ddlcontrmsg_dbt m on M.T_DLCONTRID = d.t_dlcontrid and m.t_kind = 500  " +
//                " AND M.T_ID = (SELECT MAX(T_ID) FROM DDLCONTRMSG_DBT MM WHERE M.T_DLCONTRID = MM.t_dlcontrid and m.t_kind = MM.T_KIND) " +
" left join ( select * from ddlcontrmsg_dbt m1  " +
"          where M1.T_ID = (SELECT MAX(T_ID) FROM DDLCONTRMSG_DBT MM WHERE M1.T_DLCONTRID = MM.t_dlcontrid and m1.t_kind = MM.T_KIND)) m  " +
"          on M.T_DLCONTRID = d.t_dlcontrid and m.t_kind = 500                                                                             " +
          "   WHERE     d.t_sfcontrid = s.t_id and s.t_dateclose = to_date('01010001','ddmmyyyy') and s.t_partyid <> 1 " +
//          "         AND M.T_DLCONTRID = d.t_dlcontrid " +
//          "         AND S.T_DATEBEGIN > ? " +
          "ORDER BY m.t_senddate " ;
    cmd = RsdCommand(sql);
    cmd.addParam("", RSDBP_IN, date(1,1,2019));
    cmd.execute();

end;

PRIVATE MACRO AddCol (ar, fld, head, width, rdonly, ty, dp)
   var ind = ar.size;
   if (ind > 0) ind = ar.size / 6 ; end;
   ar.value (ind * 6)     = fld;
   ar.value (ind * 6 + 1) = head;
   ar.value (ind * 6 + 2) = width;
   ar.value (ind * 6 + 3 ) = rdonly;   // fldType
   ar.value (ind * 6 + 4 ) = dp;//   decPoint
   ar.value (ind * 6 + 5 ) = 0;   // reserv
END;

private macro _SetMessage(cm)
/*  CM_MSEL_STOP_CLEARALL    : RSLX                : INTEGER   : 5
  CM_MSEL_STOP_CLEAR       : RSLX                : INTEGER   : 4
  CM_MSEL_STOP_KEEP        : RSLX                : INTEGER   : 3
  CM_MSEL_CONT_CLEAR       : RSLX                : INTEGER   : 2
  DLG_MSELEND              : RSLX                : INTEGER   : 14
  DLG_MSEL                 : RSLX                : INTEGER   : 13
  DLG_MSELSTART            : RSLX                : INTEGER   : 12
  CM_UPDATE_ADDSCROLL      : RSLX                : INTEGER   : 6
  CM_SELECT                : RSLX                : INTEGER   : 4
  CM_IGNORE                : RSLX                : INTEGER   : 3
  CM_CANCEL                : RSLX                : INTEGER   : 2
  CM_SAVE                  : RSLX                : INTEGER   : 1
  CM_DEFAULT               : RSLX                : INTEGER   : 0
  DLG_MAKE                 : RSLX                : INTEGER   : 19
  DLG_OUTREC               : RSLX                : INTEGER   : 11
  DLG_INREC                : RSLX                : INTEGER   : 10
  DLG_TIMER                : RSLX                : INTEGER   : 9
  DLG_MOUSE                : RSLX                : INTEGER   : 8
  DLG_KEY                  : RSLX                : INTEGER   : 7
  DLG_BUTTON               : RSLX                : INTEGER   : 6
  DLG_SETFOCUS             : RSLX                : INTEGER   : 5
  DLG_REMFOCUS             : RSLX                : INTEGER   : 4
  DLG_DESTROY              : RSLX                : INTEGER   : 3
  DLG_SAVE                 : RSLX                : INTEGER   : 2
  DLG_INIT                 : RSLX                : INTEGER   : 1
  DLG_PREINIT              : RSLX                : INTEGER   : 15
  DLG_OUTLOOP              : RSLX                : INTEGER   : 17
  DLG_INLOOP               : RSLX                : INTEGER   : 16
  DLG_SWITCH               : RSLX                : INTEGER   : 18
  CM_INSERT                : RSLX                : INTEGER   : 5  */
var msg = string(cm);
if (cm == 0)     msg = cm;
elif (cm == 1)   msg = "DLG_INIT";
elif (cm == 2)   msg = "DLG_SAVE";
elif (cm == 3)   msg = "DLG_DESTROY";
elif (cm == 4)   msg = "DLG_REMFOCUS";
elif (cm == 5)   msg = "DLG_SETFOCUS";
elif (cm == 6)   msg = "DLG_BUTTON";
elif (cm == 7)   msg = "DLG_KEY";
elif (cm == 8)   msg = "DLG_MOUSE";
elif (cm == 9)   msg = "DLG_TIMER";
elif (cm == 10)   msg = "DLG_INREC";
elif (cm == 11)   msg = "DLG_OUTREC";
elif (cm == 12)   msg = "DLG_MSELSTART";
elif (cm == 13)   msg = "DLG_MSEL";
elif (cm == 14)   msg = "DLG_MSELEND";
elif (cm == 15)   msg = "DLG_PREINIT";
elif (cm == 16)   msg = "DLG_INLOOP";
elif (cm == 17)   msg = "DLG_OUTLOOP";
elif (cm == 18)   msg = "DLG_SWITCH";
elif (cm == 19)   msg = "DLG_MAKE";
end;
message(msg);msgbox(msg);
end;

macro DboScroll
   var sql, cmd1, rs1, col1, need = true,Column = TArray(),i, ColumnValue, ColumnName, NumColumns = 0, cond = "";
   var dbo_msg;

   var ErrAr = TArray(), inprocess, inprocessprogress = 0, SaveNum = 0, Log = CLog();

   macro EvProc(rs, cmd, id, key)
     var  CM_DEFAULT = null, err;
    //    _setmessage(cmd);
//msgbox(key);
      if (cmd == DLG_INIT)
         /*Позиционируемся*/
         if(SaveNum > 0)
           while(rs.movenext)
             if(SaveNum == rs.value("rownum"))
               GoToScroll(rs);
               break;
             end;
           end;
         end;

          AddMultiAction(rs, 316/*F2*/);
      //elif (cmd == DLG_MAKE ) //после массовой обработки

         //return CM_SELECT;
      elif(cmd == DLG_MSELSTART)
         if(key == 316)
           if(msgboxex("Отправить уведомления по выделенным записям?", MB_YES + MB_NO, IND_YES) == IND_YES)
             inprocess = true;
             inprocessprogress = 0;
             InitProgress(int(GetMultiCount()), "Ждите...", " Формирование и отправка");
             SetDialogFlag(0);
             ErrAr = TArray();
            else
             return CM_IGNORE;  
           end;
         end;
      elif(cmd == DLG_MSELEND)
        if(key == 316)
          if(inprocess)
            SetDialogFlag(1);
            inprocess = false;
            RemProgress();
            msgboxex("Обработка завершена");
            rs.Update();
            return CM_SELECT;
         end;
        end;
      elif(cmd == DLG_MSEL)
        if(key == 316)
           dbo_msg = dboMessage(rs.Value("t_dlid")).CreateMessage(true,true, true, false, rs.Value("t_email"));
           if (dbo_msg.statsend != -1)
         //     rs.value("t_issend") = StrFor(88);
           //   rs.value("t_message") =  "Успешно";
              sql_execute("update dbo_message_tmp set t_issend = chr(88), t_message = 'Успешно' where t_dlid = " + rs.value("t_dlid"));
           else
//              rs.value("t_message") = dbo_msg.statmes;
              sql_execute("update dbo_message_tmp set t_message = '"+dbo_msg.statmes+"' where t_dlid = " + rs.value("t_dlid"));
           end;
           UseProgress(inprocessprogress = inprocessprogress + 1);
//           rs.Update();
           return CM_MSEL_CONT_CLEAR;
        end;
      elif ((cmd == DLG_KEY) and (key == K_F2))
         if (ValType(rs.Value("t_email")) != 26)
            if (msgboxex("Отправить уведомление?", MB_YES + MB_NO, IND_YES) == IND_YES)
               BegAction();
               dbo_msg = dboMessage(rs.Value("t_dlid")).CreateMessage(true,true, true, false, rs.Value("t_email"));
               EndAction();
               SaveNum = rs.value("rownum");
               msgbox(dbo_msg.statmes);
               if (dbo_msg.statsend != -1)
   //               rs.value("t_issend") = StrFor(88);
     //             rs.value("t_message") = "Успешно";
                 sql_execute("update dbo_message_tmp set t_issend = chr(88), t_message = 'Успешно' where t_dlid = " + rs.value("t_dlid"));
               else
//                  rs.value("t_message") = dbo_msg.statmes;
              sql_execute("update dbo_message_tmp set t_message = '"+dbo_msg.statmes+"' where t_dlid = " + rs.value("t_dlid"));
               end;
       //        rs.Update();
               return CM_SELECT;
            end;
         end;
         return CM_IGNORE;
      elif ((cmd == DLG_KEY)and(key == 18))
            SaveNum = rs.value("rownum");
            return CM_SELECT;

      elif ((cmd == DLG_KEY)and(key == K_ESC))
         return 2;
      end;

     return CM_DEFAULT;
   end;

   col1 = TArray;   

   AddCol (col1,  "t_number",    "Номер",        18,  2);
   AddCol (col1,  "T_name",      "Наименование ",25,  2);
   AddCol (col1,  "T_state",     "Статус договора ",10,  2);
   AddCol (col1,  "T_message",   "Ошибка отправки",25,  2);
   AddCol (col1,  "t_avrexch",   "Фонд ",        5 ,  2);
   AddCol (col1,  "t_outexch",   "Внеб",         5 ,  2);
   AddCol (col1,  "t_dvexch",    "Срочн",        5 ,  2);
   AddCol (col1,  "t_moneyexch", "Валют",        5 ,  2);
   AddCol (col1,  "t_datebegin", "Заключен",     8 ,  2);
   AddCol (col1,  "t_issend",    "Отправлено",   5 ,  2);
   AddCol (col1,  "t_datecreate","Создано",      8 ,  2);
   AddCol (col1,  "t_datesend",  "Отправлено",   8 ,  2);
   AddCol (col1,  "t_email",     "e-mail",       20,  2);
   AddCol (col1,  "t_resend",    "Повтор",       3 ,  -1);
   AddCol (col1,  "t_dlid",      "dlid",       3 ,  -1);

   while (need)
      need = false;
//      FillTmpTable();
//(t_id number(10), t_avrexch char(1), t_outexch char(1), t_dvexch char(1), t_moneyexch char(1), t_name varchar2(100), t_partyid number(10),
//t_number varchar2(20), t_datebegin date, t_issend char(1), t_countsend number(5), t_datecreate date, t_datesend date, t_email varchar2(50), t_resend char(1))
      sql = 
   " select rownum, t_dlid, t_number, t_name, t_state, t_issend, t_message, t_avrexch, t_outexch, t_dvexch, t_moneyexch, " + 
   " t_datebegin, t_datecreate, t_datesend, t_email, t_resend   from dbo_message_tmp order by t_datebegin desc, t_datecreate";
 
      cmd1 = RSDCommand(sql);
      rs1 = RSDRecordset(cmd1 , null, RSDVAL_STATIC );
      rs1.UpdateCommand = RsdCommand    ( "update dbo_message_tmp         " +
                                                "set t_message = :1, t_issend = :2 "+
                                                " where T_DLID = :3 ");
      rs1.UpdateCommand.AddUserCmdParam ("1",  "T_MESSAGE",    RSDRVER_NEWVAL);          
      rs1.UpdateCommand.AddUserCmdParam ("2",  "T_ISSEND",    RSDRVER_NEWVAL); 
      rs1.UpdateCommand.AddUserCmdParam ("3", "t_dlid",     RSDRVER_OLDVAL);          

      while (RunScroll (rs1,col1.size/6, col1, "test" ,"EvProc"," Договоры для отправки уведомлений "," F2 - обработать записи ", true, 1, 1))
        cmd1 = RSDCommand(sql);
        rs1 = RSDRecordset(cmd1 , null, RSDVAL_STATIC );
      end;
   end;

return null;

end;

DboScroll;
//printglobs;
exit(1);