// Библиотека процедур дилинга
import oralib;


private array map1,map2;



macro plat_dil5(s0,s1,s2,s3)

    private var que,sa1,sa2,srez,rs51;
    sa1=string(s0);
    srez=" ";
    que="select t_" +s3+" from dpmpaym_dbt  where t_documentid="+sa1+" and t_dockind="+s1+" and t_purpose="+s2;
    rs51 = execSQLSelect(que);
    if(rs51 != null)
      if (rs51.moveNext) 
        srez=rs51.value(0);
      end;
    end;
    return srez;
end;



macro fx_sd(pa1,pa2)

    private var que,srez=0,rs51;
    srez=" ";
    que="select t_" +pa2+" from ddvndeal_dbt  where t_id="+pa1 ;
    rs51 = execSQLSelect(que);
    if(rs51 != null)
      if (rs51.moveNext) 
        srez=rs51.value(0);
      end;
    end;
    return srez;
end;


/*
Macro Получить_Курс5 ( Rate, OtherFI, DateR, Type )

    var stat;
    record RATEDEF ( ratedef );
    SetParm (0, $0);
    if ( ValType (Type) == V_UNDEF )
        stat = ПолучитьКурс (RATEDEF, 0, OtherFI);
    else
        stat = ПолучитьКурс (RATEDEF, 0, OtherFI, Type);
    end;

    if ( stat != 0 ) return 1; end;
    stat = ПолучитьЗначениеКурса (RATEDEF, DateR);
    if ( stat != 0 ) return 1; end;

    SetParm (0, RATEDEF.RATE/10000);
    return 0;
End;
*/


MACRO DV_DAT(s);
   private var ss,dd;
   ss=trim(substr(string(s),1,10));
   if (substr(ss,3,1) != "." )
     ss="0"+ss;
   end; 
   dd=date(ss);
   return(dd);
END;

MACRO DV_SDAT(s);
   private var ss,dd;
   ss=trim(substr(string(s),1,10));
   if (substr(ss,3,1) != "." )
     ss="0"+ss;
   end; 
   return(ss);
END;



MACRO MM_nalog5(par1)
  private var que,rs5,rez=0;

  que="select count(*) from DDL_GENAGR_DBT where t_tax_amount > 0 and t_partyid="+par1;
  rs5 = execSQLSelect(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=int(rs5.value(0));
     end;
  end;
  if ( rez == 0 )
     return rez;
  else
     que="select t_tax_amount from DDL_GENAGR_DBT where t_partyid="+par1;
     rs5 = execSQLSelect(que);
     if(rs5 != null)
        if (rs5.moveNext) 
           rez=rs5.value(0);
        end;
     end;
  end;
  return rez;
END;



MACRO account_corr9(par1)
  private var que,rs5,rez="0";

  que="select t_account from dcorschem_dbt where rownum=1 and t_fiid="+par1;
  rs5 = execSQLSelect(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=rs5.value(0);
     end;
  end;
  return rez;
END;



MACRO account_corr5(par1,par2)
  private var que,rs5,rez="0";

  if ( par1 == 0 )
     par2=22;
  end;
  que="select t_account from dcorschem_dbt where rownum=1 and t_fiid="+par1+" and t_corrid="+par2;
  rs5 = execSQLSelect(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=rs5.value(0);
     end;
  end;
  return rez;
END;

/*

macro GetPartyName5(ID)
  if (ID == 0)
    return {Name_Bank};
  end;
  var party = TBfile("party");
  party.KeyNum = 0;
  party.rec.PartyID = ID;
  if( not GetEq(party) )
    return ID;
  else
    return party.rec.Name;
  end;
end;

*/



MACRO dmdm(par1)
  private var que,rs5,rez=0,nfiid;

  nfiid=plat_dil5(par1,4813,1,"fiid");
  que="select count(*) from dfininstr_dbt where t_fiid="+nfiid+" and t_fi_kind=6 ";
  rs5 = execSQLSelect(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=int(rs5.value(0));
     end;
  end;
  return rez;
END;

MACRO dmdmm(pa1)
  private var que,rs5,rez=0,nfiid;

  que="select count(*) from dfininstr_dbt where t_fiid="+pa1+" and t_fi_kind=6 ";
  rs5 = execSQLSelect(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=int(rs5.value(0));
     end;
  end;
  return rez;
END;

MACRO ВалютаМеталл(iFIID)
  private var select,rs,rez=0;

  select="select count(*) from dfininstr_dbt where t_fiid="+iFIID+" and t_fi_kind=6 ";
  rs = execSQLSelect(select);
  if(rs != null)
     if (rs.moveNext) 
        rez=int(rs.value(0));
        if (rez!=0)
          return true;
        else
          return false;
        end;
     end;
  end;
  return false;
END;

