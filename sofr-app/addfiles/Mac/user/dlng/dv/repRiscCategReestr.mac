/*
$Name:        repRiscCategReestr.mac 
$Module:      ФИСС и КО
$Description: Отчёт по категориям риска клиентов
$Programmer:  Кротов А.
*/

IMPORT globals, RsbFormsInter, "cb_sql.mac", PTInter, "dlquery.mac", rsd;
IMPORT "qracctools.mac";
IMPORT "role_model.mac";//ролевая модель
import or_rep_h;
import or_tpl_h;
import or_const;


//Переменные для варианта WindowsReports, поддерживающего POIReports
var csvFile, fName, csvTable, printEngine;
const SHEET_NAME = "Выписка";
const TEMPL_NAME = "Template_repRiscCategReestr.xlsx";
const FILE_REPORT = "Report_repRiscCategReestr.xlsx";
const CSV_NAME   = "repRiscCategReestr_csv.txt";

MACRO u_SQL_ConvSpec(value)
    var retval;

    retval = SQL_ConvSpec(value);

    if(valtype(retval) == v_undef)
      retval = "";
    end;

    return retval;
END;

private macro iif(a,b,c)
    if(a)
        return b;
    else
        return c;
    end;
end;

macro GetRiskCategStr(i)
    if(i == 1)
      return "КСУР";
    elif(i == 2)
      return "КПУР";
    elif(i == 3)
      return "КОУР";
    elif(i == 4)
      return "КНУР";
    else
      return "";
    end; 
end;


CLASS (tRsbPanel) pnl_RiscReestr ()
  private const FT_STRING = 7;
  const K_Enter = 13;
  const K_F3    = 317;
  const K_F2    = 316;
  const K_Alt_F3= 362;

  InitTRSBPanel();
  Caption = "Реестр Категорий риска.";
  Status  = "~ESC~Выход  ~F2~Выполнить  ~F3~Выбор";
  setSize(25,5);
  SetPosition(30,10);

  var curstr = 0,
      lbl_repDate,
      fld_repDate; 

  curstr = curstr + 2;  
    lbl_repDate = TRSBLabel(2, curstr,"Дата:");
      addlabel (lbl_repDate);

    fld_repDate = TRSBEditField (V_Date);
    fld_repDate.setPosition(10,curstr);
    fld_repDate.setSize(8,1);
    fld_repDate.name = "fld_repDate";
    fld_repDate.value = {CurDate};
      addControl(fld_repDate);

    curstr = curstr+1;
var pPrintUL = TRsbCheckbox;
    pPrintUL.setPosition(2,curstr);
    pPrintUL.name = "pCheckCouponNumber";
    pPrintUL.checked = false;
    addControl(pPrintUL);
var pPrintULlbl = TRsbLabel(5,curstr,"Выводить ЮЛ");
    addLabel (pPrintULlbl);


   
    addEventHandler (RSB_EV_Key_Pressed, R2M(this,"on_KeyPressed"));

   macro PrintRepReestr (_repdt, useUL)

      //printEngine = CTemplateXLS(NULL, NULL, NULL, NULL, NULL, NULL, true, true);
      printEngine = CTemplateSXLSX();

      if(printEngine.UsePoi())
        printEngine.SetXLSXFormat();
      end;

      //printEngine.CreateTotalBook();

      InitProgress(-1, "", "");

      printEngine.OpenTemplate(TEMPL_NAME, true);
      printEngine.SheetChange(1);

      printEngine.SetValue_NameCell("reportDate", _repdt);
     // printEngine.CopyAllSheetInTotalBook (null, false, "templateHeader", 0, SHEET_NAME);
     // printEngine.CopyAllSheetInTotalBook (null, false, "tableHeader", 0, SHEET_NAME);

      csvTable = printEngine.RegisterTable("tableRow", "tableHeader", true);
      csvFile = C_CSVFile();
      if (printEngine.UsePoi())
        csvFile.SetLimitRow(FLUSH_COUNT_XLSX);
      end;
      fName = csvFile.CreateFullFileName(CSV_NAME);
      csvFile.FileOpen(fName, true);

      var ColorD = 14069116;
     
      var  sql = String("select t1.*, atcor.t_attrid,\n"
                      ,"rshb_user.uGetChangeAtCorDate(t1.risk) risk_changedate, rshb_user.uGetDateExclusion(t1.t_partyid) t_dateExclusion,\n"
                      ,"(SELECT  count(1)\n"
                      ,"        FROM dobjatcor_dbt AtCor\n"
                      ,"       WHERE AtCor.t_ObjectType  = 3\n"
                      ,"         AND AtCor.t_GroupID     = 95\n"
                      ,"         AND AtCor.t_Object      = LPAD(t1.t_partyid, 10, '0')\n"
                      ,"         and AtCor.t_Validtodate != to_date('31 12 9999','dd mm yyyy'))histrec,\n"
                      ,"         (select t.T_VALIDFROMDATE from dobjatcor_dbt t where t.t_id =  t1.risk) t_validfromdate\n"
                      ," from\n"
                      ,"(select dlc.t_dlcontrid, dlc.t_sfcontrid, sf.t_partyid, p.t_shortname, P.T_LEGALFORM, sf.t_number, sf.t_datebegin,sf.t_dateclose,\n"
                      ,"(select count(1) from ddlcontrmp_dbt dlmp_f, dsfcontr_dbt sf_f where dlmp_f.t_sfcontrid = sf_f.t_id and\n"
                      ,"   sf_f.t_servkind = 1 and sf_f.t_servkindsub = 8 and dlmp_f.t_dlcontrid = dlc.t_dlcontrid and (params.r_date between dlmp_f.t_mpregdate and dlmp_f.t_mpclosedate\n"
                      ,"                                                                                   or dlmp_f.t_mpclosedate = to_date('01010001','ddmmyyyy'))) as t_mpcode_f_cnt,\n"
                      ,"(select listagg(dlmp_f.t_mpcode,' ,') within group (order by dlmp_f.t_sfcontrid)   from ddlcontrmp_dbt dlmp_f, dsfcontr_dbt sf_f where dlmp_f.t_sfcontrid = sf_f.t_id and\n"
                      ,"   sf_f.t_servkind = 1 and sf_f.t_servkindsub = 8 and dlmp_f.t_dlcontrid = dlc.t_dlcontrid and (params.r_date between dlmp_f.t_mpregdate and dlmp_f.t_mpclosedate\n"
                      ,"                                                                                   or dlmp_f.t_mpclosedate = to_date('01010001','ddmmyyyy')) group by dlmp_f.t_dlcontrid ) as t_mpcode_f,\n"
                      ,"(select count(1) from ddlcontrmp_dbt dlmp_v, dsfcontr_dbt sf_v where dlmp_v.t_sfcontrid = sf_v.t_id and\n"
                      ,"   sf_v.t_servkind = 21 and sf_v.t_servkindsub = 8 and dlmp_v.t_dlcontrid = dlc.t_dlcontrid and (params.r_date between dlmp_v.t_mpregdate and dlmp_v.t_mpclosedate\n"
                      ,"                                                                                   or dlmp_v.t_mpclosedate = to_date('01010001','ddmmyyyy'))) as t_mpcode_v_cnt,\n"
                      ," (select listagg(dlmp_v.t_mpcode,' ,') within group (order by dlmp_v.t_sfcontrid)   from ddlcontrmp_dbt dlmp_v, dsfcontr_dbt sf_v where dlmp_v.t_sfcontrid = sf_v.t_id and\n"
                      ,"   sf_v.t_servkind = 21 and sf_v.t_servkindsub = 8 and dlmp_v.t_dlcontrid = dlc.t_dlcontrid and (params.r_date between dlmp_v.t_mpregdate and dlmp_v.t_mpclosedate\n"
                      ,"                                                                                   or dlmp_v.t_mpclosedate = to_date('01010001','ddmmyyyy')) group by dlmp_v.t_dlcontrid ) as t_mpcode_v,\n"
                      ,"(select count(1) from ddlcontrmp_dbt dlmp_c, dsfcontr_dbt sf_c where dlmp_c.t_sfcontrid = sf_c.t_id and\n"
                      ,"   sf_c.t_servkind = 15 and sf_c.t_servkindsub = 8 and dlmp_c.t_dlcontrid = dlc.t_dlcontrid and (params.r_date between dlmp_c.t_mpregdate and dlmp_c.t_mpclosedate\n"
                      ,"                                                                                   or dlmp_c.t_mpclosedate = to_date('01010001','ddmmyyyy'))) as t_mpcode_c_cnt,\n"
                      ," (select listagg(dlmp_c.t_mpcode,' ,') within group (order by dlmp_c.t_sfcontrid)   from ddlcontrmp_dbt dlmp_c, dsfcontr_dbt sf_c where dlmp_c.t_sfcontrid = sf_c.t_id and\n"
                      ,"   sf_c.t_servkind = 15 and sf_c.t_servkindsub = 8 and dlmp_c.t_dlcontrid = dlc.t_dlcontrid and (params.r_date between dlmp_c.t_mpregdate and dlmp_c.t_mpclosedate\n"
                      ,"                                                                                   or dlmp_c.t_mpclosedate = to_date('01010001','ddmmyyyy')) group by dlmp_c.t_dlcontrid ) as t_mpcode_c,\n"
                      ,"(select rshb_user.uGetMainObjAttrRecID(3,LPAD(sf.t_partyid, 10, '0'), 95, params.r_date) from dual) risk\n"
                      ,"  from ddlcontr_dbt dlc, dsfcontr_dbt sf, dparty_dbt p, (select  ? as r_date from dual )  params\n"
                      ,"where sf.t_partyid = p.t_partyid and (sf.t_dateclose = to_date('01010001','ddmmyyyy') or sf.t_dateclose >  params.r_date )\n"
                      ,"and dlc.t_sfcontrid = sf.t_id) t1, dobjatcor_dbt atcor\n"
                      ,"where t1.risk = atcor.t_id(+) and t1.t_partyid != 1\n"); 
                      
       if (not useUL)
         sql = string(sql , "and t1.t_legalform = 2");
       end; 
       sql = string(sql , "order by  t1.t_mpcode_f_cnt desc, t_mpcode_v_cnt desc, t_mpcode_c_cnt desc ");

       sql = RSDCommand(sql);
       sql.AddParam("p_Date", rsdbp_in, _repdt);

      sql = RSDRecordset(sql, rsdval_client, RSDVAL_FORWARD_ONLY);
     
      BegAction(1, "Подготовка реестра. Ждите...");
      while (sql.MoveNext() )
        csvFile.AddCell(sql.value("T_SHORTNAME") );  // 1. Клиент
        csvFile.AddCell(sql.value("T_NUMBER") );  // 2. Номер брокерского договора
        csvFile.AddCell(u_SQL_ConvSpec(sql.value("T_DATEBEGIN")) );  // 3. Дата заключения брокерского договора
        csvFile.AddCell(u_SQL_ConvSpec(sql.value("T_MPCODE_F")) );  // 4. Код клиента фондовая секция
        csvFile.AddCell(u_SQL_ConvSpec(sql.value("T_MPCODE_V")) );  // 5. Код клиента валютная секция
        csvFile.AddCell(u_SQL_ConvSpec(sql.value("T_MPCODE_C")) );  // 6. Код клиента срочная секция
        csvFile.AddCell(GetRiskCategStr(sql.value("T_ATTRID")) );  // 7. Категория риска
        csvFile.AddCell(iif(((sql.value("T_ATTRID") == 1) or (sql.value("T_ATTRID") == 4)),
                              u_SQL_ConvSpec(sql.value("T_DATEBEGIN")), 
                              u_SQL_ConvSpec(sql.value("t_validfromdate"))));  // 8. Дата принятия решения по отнесению к категории риска
        csvFile.AddCell(u_SQL_ConvSpec(sql.value("risk_changedate")) );  // 9. Дата пересмотра решения по отнесению к категории риска
        csvFile.AddCell(u_SQL_ConvSpec(sql.value("t_dateclose")) );  // 10. Дата расторжение договора
        csvFile.AddCell( iif(u_SQL_ConvSpec(sql.value("t_dateExclusion")) > _repdt, "", u_SQL_ConvSpec(sql.value("t_dateExclusion"))) );  // 11. Дата исключения из реестра
        csvFile.AddRow();  
      end;
      EndAction(1);

      csvFile.FileClose();
      csvTable.FillTabelFromCSV(csvFile.GetlsFileName());
      csvTable.EndTable();

      //printEngine.CopyAllSheetInTotalBook(null,         //Имя закладки,по умолчанию имя закладки из шаблона
      //                                  false, // true - на новый лист, false - на существующий(если имя листа отличается, всегда на новый лист)
      //                                  csvTable.GetTableRange(),     //Что копировать м.б. диапозон вида "A1:T60" или имя именованного диапозона
      //                                    0,
      //                                  SHEET_NAME) ;

      RemProgress();
      printEngine.SaveAsTemplate("Report_repRiscCategReestr");
      printEngine.Close();
      //printEngine.SaveTotalBook(FILE_REPORT);

   end; 
   
       macro on_KeyPressed(ev)
        var errflag = 0;
        if (ev.KeyCode == K_F3)
     
        if(valtype(ev.source.parent) != V_UNDEF)
           if (ev.source.name == "fld_repDate")
            fld_repDate.value = GetDateByCalendar({CurDate});
            this.redraw; 
           end;
        end;
        elif (ev.KeyCode == K_Enter)
            this.redraw; 
        elif(ev.keyCode == K_F2) 
           PrintRepReestr(THIS.fld_repDate.value, THIS.pPrintUL.checked);
           this.close(1);
        end;
    end;       
END;

macro exec_report
  var pnlReport:TRSBpanel = pnl_RiscReestr();
  pnlReport.run();
end;

exec_report();
exit(1);
