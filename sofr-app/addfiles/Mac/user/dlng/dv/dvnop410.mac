import InsCarryDoc, "dv_categ.mac", "dv_car.mac", "mccatacf.mac";

private macro ПоставитьНаПросрочку( FD, doc, ДатаИсполненияШага ):integer

     if( not ПроводкаПоКатегориямУчета( FD,
                                        "Треб. с н.с.", "+Форвард, РПИ",
                                        ДатаИсполненияШага,
                                        1,
                                        FD.ВалютаТребования(),
                                        FD.СуммаТребования(),
                                        doc,
                                        INPCARRY, FD.kind, "",
                                        "Просроченные требования по сделке " + FD.DealCode(),
                                        null, null,
                                        FD.ВалютаТребования(), FD.ВалютаТребования(),
                                        FD.ВалютаТребования(), FD.СуммаТребования()
                                      )
       )
        return 1;
     end;

    return 0;

end;

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )

  record ndeal(dvndeal);
  SetBuff( ndeal, FDoc );
  var FD = DVFirstDocNDeal(DocKind, ndeal);
  var ДатаИсполненияШага:date;
  var ПлатежТреб = RsbPayment( FD.ПлатежТреб.rec.PaymentID );

  ДатаИсполненияШага = FD.ДатаИсполнения();

  if( ПоставитьНаПросрочку(FD, doc, ДатаИсполненияШага) != 0 )
     return 1;
  end;

  if( FD.ПлатежТреб.rec.PaymentID > 0 )
     if( ПИ_УстановитьСтатусПлатежа(ПлатежТреб, PM_OVERDUE) )
        MsgBox( "Ошибка при утановке платежу статуса \"Просрочен\"" );
        return 1;
     end;
  end;

  return 0;

end;





