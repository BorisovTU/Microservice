/*
$Name:         UTL_COMIS_STEP.mac 
$Module:       ФИССиКО
$Description:  Функции получения комиссий шага
*/
//import dv_car;
import rsd, SFInter, BankInter;

// пользовательская запись о параметраъ комиссии
Class Usr_Comiss_Parm(ContrID_, Coms_Tp_, Coms_Nm_)
   var ContrID = ContrID_;
   var Coms_Tp = Coms_Tp_;
   var Coms_Nm = Coms_Nm_;
   var Coms_Gr = "";
   var Coms_Dt;

   var Coms_Sm = 0;
   var Coms_Fi = 0;
   var Coms_Ku = "";
   var Coms_Dbt = "";
   var Coms_Crd = "";
   var Coms_Grn = "";
   var Coms_Pck = "";
   var Coms_Dt1;
   var Coms_Dt2;

   var Nds_Sm = 0.0;
   var Nds_Fi = 0;
   var Nds_Ku = "";
   var Nds_Dbt = "";
   var Nds_Crd = "";
   var Nds_Grn = "";
   var Nds_Pck = "";
   
   var Coms_Id = 0;
   var Coms_Err = "";
end;

// запись о начисленной комиссии
Class SfDef_Rec
   // добавить комиссию на шаг 
   macro Ins_rec(cms, OperId, StepId, p_Dept, p_Oper)
      var sqls , rsdc;
      sqls = String( 
         "DECLARE   \n"
        ,"   v_Cntr   Dsfdef_Dbt.t_Sfcontrid%TYPE := :p_Cntr;   \n"
        ,"   v_Com_Dt Dsfdef_Dbt.t_Datefee%TYPE := :p_Date;   \n"
        ,"   v_Com_Tp Dsfdef_Dbt.t_Feetype%TYPE := :p_Com_Tp;   \n"
        ,"   v_Com_Nm Dsfdef_Dbt.t_Commnumber%TYPE := :p_Com_Nm;   \n"
        ,"   v_Com_Sm Dsfdef_Dbt.t_Sum%TYPE := :p_Com_Sm;   \n"
        ,"   v_Com_Fi Dsfdef_Dbt.t_Fiid_Sum%TYPE := :p_Com_Fi;   \n"
        ,"   v_Nds_Sm Dsfdef_Dbt.t_Sumnds%TYPE := :p_Nds_Sm;   \n"
        ,"   v_Dbt_Ac VARCHAR2(50) := :p_Dbt_Ac;   \n"
        ,"   v_Crd_Ac VARCHAR2(50) := :p_Crd_Ac;   \n"
        ,"   v_Opr_Id Dsfdef_Dbt.t_Id_Operation%TYPE := :p_Opr_Id;   \n"
        ,"   v_Stp_Id Dsfdef_Dbt.t_Id_Step%TYPE := :p_Stp_Id;   \n"
        ,"   v_Dept   Dsfdef_Dbt.t_Department%TYPE := :p_Dept;   \n"
        ,"   v_Oper   Dsfdef_Dbt.t_Oper%TYPE := :p_Oper;   \n"
        ,"   v_Dat1   DATE := :p_Dat1;   \n"
        ,"   v_Dat2   DATE := :p_Dat2;   \n"
        ,"   r_Sfdef  Dsfdef_Dbt%ROWTYPE;   \n"
        ,"   r_Sfsid  Dsfsi_Dbt%ROWTYPE;   \n"
        ,"   r_Sfsik  Dsfsi_Dbt%ROWTYPE;   \n"
        ,"   \n"
        ,"   v_Err VARCHAR2(2000);   \n"
        ,"   \n"
        ,"   Ex_Er EXCEPTION;   \n"
        ,"BEGIN   \n"
        ,"   BEGIN   \n"
        ,"      IF v_Com_Tp IS NULL THEN   \n"
        ,"         v_Err := 'Не указан вид комиссии';   \n"
        ,"         RAISE Ex_Er;   \n"
        ,"      END IF;   \n"
        ,"      IF v_Com_Nm IS NULL THEN   \n"
        ,"         v_Err := 'Не указан номер комиссии';   \n"
        ,"         RAISE Ex_Er;   \n"
        ,"      END IF;   \n"
        ,"      SELECT Nvl(MAX(t.t_Id), 0) + 1 INTO r_Sfdef.t_Id FROM Dsfdef_Dbt t;   \n"
        ,"      r_Sfdef.t_Feetype         := v_Com_Tp;   \n"
        ,"      r_Sfdef.t_Commnumber      := v_Com_Nm;   \n"
        ,"      r_Sfdef.t_Status          := 20;   \n"
        ,"      r_Sfdef.t_Fiid_Sum        := v_Com_Fi;   \n"
        ,"      r_Sfdef.t_Sum             := v_Com_Sm;   \n"
        ,"      r_Sfdef.t_Sumnds          := v_Nds_Sm;   \n"
        ,"      r_Sfdef.t_Sfcontrid       := Nvl(v_Cntr, 0);   \n"
        ,"      r_Sfdef.t_Department      := Nvl(v_Dept, Rsbsessiondata.Operdprt);   \n"
        ,"      r_Sfdef.t_Ndsratevalue    := 0;   \n"
        ,"      r_Sfdef.t_Isincluded      := Chr(0);   \n"
        ,"      r_Sfdef.t_Facturaid       := 0;   \n"
        ,"      r_Sfdef.t_Datefee         := Nvl(v_Com_Dt, Rsbsessiondata.Curdate);   \n"
        ,"      r_Sfdef.t_Basesum         := 0;   \n"
        ,"      r_Sfdef.t_Fiid_Basesum    := 0;   \n"
        ,"      r_Sfdef.t_Percent         := 100;   \n"
        ,"      r_Sfdef.t_Sum_Per_Unit    := 0;   \n"
        ,"      r_Sfdef.t_Fiid_Tarscl     := -1;   \n"
        ,"      r_Sfdef.t_Invoiceid       := 0;   \n"
        ,"      r_Sfdef.t_Basequant       := 1;   \n"
        ,"      r_Sfdef.t_Datepay         := Rsb_Secur.Unknowndate;   \n"
        ,"      r_Sfdef.t_Dateperiodbegin := Nvl(v_Dat1, r_Sfdef.t_Datefee);   \n"
        ,"      r_Sfdef.t_Dateperiodend   := Nvl(v_Dat2, r_Sfdef.t_Datefee);   \n"
        ,"      r_Sfdef.t_Spgroundid      := 0;   \n"
        ,"      r_Sfdef.t_Extcomid        := 0;   \n"
        ,"      r_Sfdef.t_Comment         := Chr(1);   \n"
        ,"      r_Sfdef.t_Skipedbymacro   := Chr(1);   \n"
        ,"      r_Sfdef.t_Ishandmade      := Chr(0);   \n"
        ,"      r_Sfdef.t_Id_Operation    := Nvl(v_Opr_Id, 0);   \n"
        ,"      r_Sfdef.t_Id_Step         := Nvl(v_Stp_Id, 0);   \n"
        ,"      r_Sfdef.t_Id_Paystep      := 0;   \n"
        ,"      r_Sfdef.t_Oprcommnumber   := 0;   \n"
        ,"      r_Sfdef.t_Isdoc           := Chr(0);   \n"
        ,"      r_Sfdef.t_Fiidpayer       := 0;   \n"
        ,"      r_Sfdef.t_Accountpayer    := Chr(1);   \n"
        ,"      r_Sfdef.t_Oper            := Nvl(v_Oper, Rsbsessiondata.Oper);   \n"
        ,"      r_Sfdef.t_Code            := Chr(1);   \n"
        ,"      r_Sfdef.t_Userfield1      := Chr(1);   \n"
        ,"      r_Sfdef.t_Userfield2      := Chr(1);   \n"
        ,"      r_Sfdef.t_Userfield3      := Chr(1);   \n"
        ,"      r_Sfdef.t_Userfield4      := Chr(1);   \n"
        ,"      r_Sfdef.t_Closedate       := Rsb_Secur.Unknowndate;   \n"
        ,"      r_Sfdef.t_Fiid_Paysum     := v_Com_Fi;   \n"
        ,"      r_Sfdef.t_Concomid        := 0;   \n"
        ,"      IF r_Sfdef.t_Sfcontrid > 0 THEN   \n"
        ,"         BEGIN   \n"
        ,"            SELECT t_Id   \n"
        ,"              INTO r_Sfdef.t_Concomid   \n"
        ,"              FROM (SELECT t.t_Id   \n"
        ,"                      FROM Dsfconcom_Dbt t   \n"
        ,"                     WHERE t.t_Feetype = v_Com_Tp   \n"
        ,"                       AND t.t_Commnumber = v_Com_Nm   \n"
        ,"                       AND t.t_Objecttype = Cnst.Objtype_Sfcontr   \n"
        ,"                       AND t.t_Objectid = r_Sfdef.t_Sfcontrid   \n"
        ,"                       AND t.t_Date <= r_Sfdef.t_Datefee   \n"
        ,"                     ORDER BY t.t_Date DESC)   \n"
        ,"             WHERE Rownum = 1;   \n"
        ,"         EXCEPTION   \n"
        ,"            WHEN No_Data_Found THEN   \n"
        ,"               NULL;   \n"
        ,"         END;   \n"
        ,"      END IF;   \n"
        ,"      r_Sfdef.t_Calccomisssumalg := 1;   \n"
        ,"      r_Sfdef.t_Discountid       := 0;   \n"
        ,"      r_Sfdef.t_Nds_Quanted      := Chr(0);   \n"
        ,"      INSERT INTO Dsfdef_Dbt VALUES r_Sfdef;   \n"
        ,"      r_Sfsid.t_Id := 0;   \n"
        ,"      CASE v_Com_Tp   \n"
        ,"         WHEN 1 THEN   \n"
        ,"            r_Sfsid.t_Objecttype := 663;   \n"
        ,"         WHEN 3 THEN   \n"
        ,"            r_Sfsid.t_Objecttype := 665;   \n"
        ,"         WHEN 6 THEN   \n"
        ,"            r_Sfsid.t_Objecttype := 664;   \n"
        ,"      END CASE;   \n"
        ,"      r_Sfsid.t_Objectid           := Lpad(r_Sfdef.t_Id, 10, '0');   \n"
        ,"      r_Sfsid.t_Debetcredit        := 0;   \n"
        ,"      r_Sfsid.t_Corracc            := Chr(1);   \n"
        ,"      r_Sfsid.t_Bankcorrid         := -1;   \n"
        ,"      r_Sfsid.t_Bankcorrcodekind   := 3;   \n"
        ,"      r_Sfsid.t_Bankcorrcode       := Chr(1);   \n"
        ,"      r_Sfsid.t_Bankcorrname       := Chr(1);   \n"
        ,"      r_Sfsid.t_Istransitacc       := Chr(0);   \n"
        ,"      r_Sfsid.t_Transitfiid        := -1;   \n"
        ,"      r_Sfsid.t_Transitaccount     := Chr(1);   \n"
        ,"      r_Sfsid.t_Receiverndsaccount := Chr(1);   \n"
        ,"      r_Sfsid.t_Noaccept           := Chr(0);   \n"
        ,"      r_Sfsid.t_Department         := r_Sfdef.t_Department;   \n"
        ,"      r_Sfsid.t_Reserve            := Chr(1);   \n"
        ,"      IF v_Dbt_Ac IS NULL THEN   \n"
        ,"         r_Sfsid.t_Partyid       := 0;   \n"
        ,"         r_Sfsid.t_Partycodekind := 1;   \n"
        ,"         r_Sfsid.t_Partycode     := Chr(1);   \n"
        ,"         r_Sfsid.t_Partyname     := Chr(1);   \n"
        ,"         r_Sfsid.t_Partyinn      := Chr(1);   \n"
        ,"         r_Sfsid.t_Bankid        := Rsbsessiondata.Ourbank;   \n"
        ,"         r_Sfsid.t_Fiid          := 0;   \n"
        ,"         r_Sfsid.t_Account       := Chr(1);   \n"
        ,"      ELSE   \n"
        ,"         -- данные клиента   \n"
        ,"         SELECT Acc.t_Client   \n"
        ,"               ,Ob.t_Codekind   \n"
        ,"               ,Ob.t_Code   \n"
        ,"               ,Par.t_Name   \n"
        ,"               ,Nvl(Ob16.t_Code, Chr(1))   \n"
        ,"               ,Do.t_Partyid   \n"
        ,"               ,Acc.t_Code_Currency   \n"
        ,"               ,Acc.t_Account   \n"
        ,"           INTO r_Sfsid.t_Partyid   \n"
        ,"               ,r_Sfsid.t_Partycodekind   \n"
        ,"               ,r_Sfsid.t_Partycode   \n"
        ,"               ,r_Sfsid.t_Partyname   \n"
        ,"               ,r_Sfsid.t_Partyinn   \n"
        ,"               ,r_Sfsid.t_Bankid   \n"
        ,"               ,r_Sfsid.t_Fiid   \n"
        ,"               ,r_Sfsid.t_Account   \n"
        ,"           FROM Daccount_Dbt Acc   \n"
        ,"          INNER JOIN Dparty_Dbt Par   \n"
        ,"             ON (Par.t_Partyid = Acc.t_Client)   \n"
        ,"          INNER JOIN Dobjcode_Dbt Ob   \n"
        ,"             ON (Ob.t_Objecttype = Cnst.Objtype_Party AND Ob.t_Codekind = Cnst.Ptck_Contr AND   \n"
        ,"                Ob.t_Objectid = Acc.t_Client AND Ob.t_State = Cnst.Ptck_All)   \n"
        ,"          INNER JOIN Ddp_Dep_Dbt Do   \n"
        ,"             ON (Do.t_Code = Acc.t_Department)   \n"
        ,"           LEFT JOIN Dobjcode_Dbt Ob16   \n"
        ,"             ON (Ob16.t_Objecttype = Cnst.Objtype_Party AND Ob16.t_Codekind = Cnst.Ptck_Inn AND   \n"
        ,"                Ob16.t_Objectid = Acc.t_Client AND Ob16.t_State = Cnst.Ptck_All)   \n"
        ,"          WHERE Acc.t_Account = v_Dbt_Ac   \n"
        ,"            AND Acc.t_Chapter = 1;   \n"
        ,"      END IF;   \n"
        ,"      -- данные банка   \n"
        ,"      SELECT Ob3.t_Codekind, Ob3.t_Code, Bank.t_Name   \n"
        ,"        INTO r_Sfsid.t_Bankcodekind, r_Sfsid.t_Bankcode, r_Sfsid.t_Bankname   \n"
        ,"        FROM Dparty_Dbt Bank   \n"
        ,"       INNER JOIN Dobjcode_Dbt Ob3   \n"
        ,"          ON (Ob3.t_Objecttype = Cnst.Objtype_Party AND Ob3.t_Codekind = Cnst.Ptck_Bic AND   \n"
        ,"             Ob3.t_Objectid = Bank.t_Partyid AND Ob3.t_State = Cnst.Ptck_All)   \n"
        ,"       WHERE Bank.t_Partyid = r_Sfsid.t_Bankid;   \n"
        ,"      INSERT INTO Dsfsi_Dbt VALUES r_Sfsid;   \n"
        ,"   \n"
        ,"      r_Sfsik.t_Id                 := 0;   \n"
        ,"      r_Sfsik.t_Objecttype         := r_Sfsid.t_Objecttype;   \n"
        ,"      r_Sfsik.t_Objectid           := r_Sfsid.t_Objectid;   \n"
        ,"      r_Sfsik.t_Debetcredit        := 1;   \n"
        ,"      r_Sfsid.t_Corracc            := Chr(1);   \n"
        ,"      r_Sfsik.t_Bankcorrid         := -1;   \n"
        ,"      r_Sfsik.t_Bankcorrcodekind   := 3;   \n"
        ,"      r_Sfsik.t_Bankcorrcode       := Chr(1);   \n"
        ,"      r_Sfsik.t_Bankcorrname       := Chr(1);   \n"
        ,"      r_Sfsik.t_Transitfiid        := -1;   \n"
        ,"      r_Sfsik.t_Transitaccount     := Chr(1);   \n"
        ,"      r_Sfsik.t_Receiverndsaccount := Chr(1);   \n"
        ,"      r_Sfsik.t_Noaccept           := Chr(0);   \n"
        ,"      r_Sfsik.t_Department         := r_Sfdef.t_Department;   \n"
        ,"      r_Sfsik.t_Reserve            := Chr(1);   \n"
        ,"      IF v_Crd_Ac IS NULL THEN   \n"
        ,"         r_Sfsik.t_Partyid       := 0;   \n"
        ,"         r_Sfsik.t_Partycodekind := 1;   \n"
        ,"         r_Sfsik.t_Partycode     := Chr(1);   \n"
        ,"         r_Sfsik.t_Partyname     := Chr(1);   \n"
        ,"         r_Sfsik.t_Partyinn      := Chr(1);   \n"
        ,"         r_Sfsik.t_Bankid        := Rsbsessiondata.Ourbank;   \n"
        ,"         r_Sfsik.t_Fiid          := 0;   \n"
        ,"         r_Sfsik.t_Account       := Chr(1);   \n"
        ,"      ELSE   \n"
        ,"         -- данные клиента   \n"
        ,"         SELECT Acc.t_Client   \n"
        ,"               ,Ob.t_Codekind   \n"
        ,"               ,Ob.t_Code   \n"
        ,"               ,Par.t_Name   \n"
        ,"               ,Nvl(Ob16.t_Code, Chr(1))   \n"
        ,"               ,Do.t_Partyid   \n"
        ,"               ,Acc.t_Code_Currency   \n"
        ,"               ,Acc.t_Account   \n"
        ,"           INTO r_Sfsik.t_Partyid   \n"
        ,"               ,r_Sfsik.t_Partycodekind   \n"
        ,"               ,r_Sfsik.t_Partycode   \n"
        ,"               ,r_Sfsik.t_Partyname   \n"
        ,"               ,r_Sfsik.t_Partyinn   \n"
        ,"               ,r_Sfsik.t_Bankid   \n"
        ,"               ,r_Sfsik.t_Fiid   \n"
        ,"               ,r_Sfsik.t_Account   \n"
        ,"           FROM Daccount_Dbt Acc   \n"
        ,"          INNER JOIN Dparty_Dbt Par   \n"
        ,"             ON (Par.t_Partyid = Acc.t_Client)   \n"
        ,"          INNER JOIN Dobjcode_Dbt Ob   \n"
        ,"             ON (Ob.t_Objecttype = Cnst.Objtype_Party AND Ob.t_Codekind = Cnst.Ptck_Contr AND   \n"
        ,"                Ob.t_Objectid = Acc.t_Client AND Ob.t_State = Cnst.Ptck_All)   \n"
        ,"          INNER JOIN Ddp_Dep_Dbt Do   \n"
        ,"             ON (Do.t_Code = Acc.t_Department)   \n"
        ,"           LEFT JOIN Dobjcode_Dbt Ob16   \n"
        ,"             ON (Ob16.t_Objecttype = Cnst.Objtype_Party AND Ob16.t_Codekind = Cnst.Ptck_Inn AND   \n"
        ,"                Ob16.t_Objectid = Acc.t_Client AND Ob16.t_State = Cnst.Ptck_All)   \n"
        ,"          WHERE Acc.t_Account = v_Crd_Ac   \n"
        ,"            AND Acc.t_Chapter = 1;   \n"
        ,"      END IF;   \n"
        ,"      -- данные банка   \n"
        ,"      SELECT Ob3.t_Codekind, Ob3.t_Code, Bank.t_Name   \n"
        ,"        INTO r_Sfsik.t_Bankcodekind, r_Sfsik.t_Bankcode, r_Sfsik.t_Bankname   \n"
        ,"        FROM Dparty_Dbt Bank   \n"
        ,"       INNER JOIN Dobjcode_Dbt Ob3   \n"
        ,"          ON (Ob3.t_Objecttype = Cnst.Objtype_Party AND Ob3.t_Codekind = Cnst.Ptck_Bic AND   \n"
        ,"             Ob3.t_Objectid = Bank.t_Partyid AND Ob3.t_State = Cnst.Ptck_All)   \n"
        ,"       WHERE Bank.t_Partyid = r_Sfsik.t_Bankid;   \n"
        ,"      INSERT INTO Dsfsi_Dbt VALUES r_Sfsik;   \n"
        ,"   EXCEPTION   \n"
        ,"      WHEN OTHERS THEN   \n"
        ,"         v_Err := Nvl(v_Err, Dbms_Utility.Format_Error_Stack || ' ' || Dbms_Utility.Format_Error_Backtrace);   \n"
        ,"   END;   \n"
        ,"   :p_Err := v_Err;   \n"
        ,"END;   \n"
       );
      rsdc = rsdCommand(sqls);
      rsdc.AddParam("p_Cntr", RSDBP_IN, cms.ContrID);
      rsdc.AddParam("p_Date", RSDBP_IN, cms.Coms_Dt);
      rsdc.AddParam("p_Com_Tp", RSDBP_IN, cms.Coms_Tp);
      rsdc.AddParam("p_Com_Nm", RSDBP_IN, cms.Coms_Nm);
      rsdc.AddParam("p_Com_Sm", RSDBP_IN, cms.Coms_Sm);
      rsdc.AddParam("p_Com_Fi", RSDBP_IN, cms.Coms_Fi);
      rsdc.AddParam("p_Nds_Sm", RSDBP_IN, cms.Nds_Sm);
      rsdc.AddParam("p_Dbt_Ac", RSDBP_IN, cms.Coms_Dbt);
      rsdc.AddParam("p_Crd_Ac", RSDBP_IN, cms.Coms_Crd);
      rsdc.AddParam("p_Opr_Id", RSDBP_IN, OperID);
      rsdc.AddParam("p_Stp_Id", RSDBP_IN, StepID);
      if ((p_Dept == null) or (p_Dept== nullval) or (p_Dept <= 0))
         rsdc.AddParam("p_Dept", RSDBP_IN, "");
      else
         rsdc.AddParam("p_Dept", RSDBP_IN, p_Dept);
      end;   
      if ((p_Oper == null) or (p_Oper== nullval) or (p_Oper <= 0))
         rsdc.AddParam("p_Oper", RSDBP_IN, "");
      else
         rsdc.AddParam("p_Oper", RSDBP_IN, p_Oper);
      end;   
      if ((cms.Coms_Dt1 == null) or (cms.Coms_Dt1 == nullval) or (cms.Coms_Dt1 == date(0,0,0)))
         rsdc.AddParam("p_Dat1", RSDBP_IN, "");
      else   
         rsdc.AddParam("p_Dat1", RSDBP_IN, cms.Coms_Dt1);
      end;   
      if ((cms.Coms_Dt2 == null) or (cms.Coms_Dt2 == nullval) or (cms.Coms_Dt2 == date(0,0,0)))
         rsdc.AddParam("p_Dat2", RSDBP_IN, "");
      else   
         rsdc.AddParam("p_Dat2", RSDBP_IN, cms.Coms_Dt2);
      end;   
      rsdc.AddParam("p_Err", RSDBP_OUT, v_String, 2000);
      rsdc.Execute;
      sqls = rsdc.Value("p_Err");
      rsdc = null;
      if ((sqls != null) and (sqls != nullval))
         cms.Coms_Err = sqls; 
         return false;
      end;
      cms.Coms_Err = ""; 
      return true;
   end;
   // получить все комиссии шага
   macro get_rec_stp(p_Oper, p_Step, p_Cntr, p_Cms_Tp, p_Cms_Nm)
      var sqls, rsdc, rsds, recs:Tarray, i = 0;
      sqls = String( 
         "SELECT t.t_Feetype, t.t_Commnumber, t.t_Id, t.t_Sfcontrid   \n"
        ,"  FROM Dsfdef_Dbt t   \n"
        ," WHERE t.t_Id_Operation = :p_Opr   \n"
        ,"   AND t.t_Id_Step = :p_Stp   \n");
      rsdc = rsdCommand(sqls);
      rsdc.AddParam("p_Opr", RSDBP_IN, p_Oper);
      rsdc.AddParam("p_Stp", RSDBP_IN, p_Step);
      if ((p_Cms_Tp != null) and (p_Cms_Tp != nullval))
         rsdc.CmdText = string(sqls, "   AND t.t_Feetype = :p_Cms_Tp   \n");
         rsdc.AddParam("p_Cms_Tp", RSDBP_IN, p_Cms_Tp);
      end;      
      if ((p_Cms_Nm != null) and (p_Cms_Nm != nullval))
         rsdc.CmdText = string(sqls, "   AND t.t_Commnumber = :_Cms_Nm   \n");
         rsdc.AddParam("p_Cms_Nm", RSDBP_IN, p_Cms_Nm);
      end; 
      if ((p_Cntr != null) and (p_Cntr != nullval))
         rsdc.CmdText = string(sqls, "   AND t.t_Sfcontrid = :p_Cntr   \n");
         rsdc.AddParam("p_Cntr", RSDBP_IN, p_Cntr);
      end;      
      rsds = rsdrecordset(rsdc, RSDVAL_CLIENT_IF_NEEDED, RSDVAL_FORWARD_ONLY);
      rsds.Open();
      recs = Tarray;
      while (rsds.MoveNext())
         i = recs.Size;
         recs[i] = Usr_Comiss_Parm(int(rsds.Value("t_Sfcontrid")), int(rsds.Value("t_Feetype")), int(rsds.Value("t_Commnumber")));
         recs[i].Coms_Id = int(rsds.Value("t_Id"));
      end;
      rsds = null;
      rsdc = null;
      return recs;
   end;
   // удалить комиссию 
   macro Del_rec(p_Com_Tp, p_Com_Id)
      var sqls, rsdc;
      sqls = String( 
         "DECLARE   \n"
        ,"   v_Com_Tp Dsfdef_Dbt.t_Feetype%TYPE := :p_Com_Tp;   \n"
        ,"   v_Com_Id Dsfdef_Dbt.t_Id%TYPE := :p_Com_Id;   \n"
        ,"BEGIN   \n"
        ,"   DELETE FROM Dsfsi_Dbt t   \n"
        ,"    WHERE (t.t_Objecttype, t.t_Objectid) IN (SELECT CASE f.t_Feetype   \n"
        ,"                                                       WHEN 1 THEN   \n"
        ,"                                                        663   \n"
        ,"                                                       WHEN 3 THEN   \n"
        ,"                                                        665   \n"
        ,"                                                       WHEN 6 THEN   \n"
        ,"                                                        664   \n"
        ,"                                                    END   \n"
        ,"                                                   ,Lapd(f.t_Id, 10, '0')   \n"
        ,"                                               FROM Dsfdef_Dbt f   \n"
        ,"                                              WHERE f.t_Feetype = v_Com_Tp   \n"
        ,"                                                AND f.t_Id = v_Com_Id);   \n"
        ,"   DELETE FROM Dsfdef_Dbt f   \n"
        ,"    WHERE f.t_Feetype = v_Com_Tp   \n"
        ,"      AND f.t_Id = v_Com_Id;   \n"
        ,"END;   \n"
       );
      rsdc = rsdCommand(sqls);
      rsdc.AddParam("p_Dck", RSDBP_IN, p_Com_Tp);
      rsdc.AddParam("p_Opr", RSDBP_IN, p_Com_Id);
      rsdc.Execute;
      rsdc = null;
   end;
   // удалить комиссии шага
   macro Del_rec_stp(p_Oper, p_Step, p_Cntr, p_Cms_Tp, p_Cms_Nm)
      var recs, r;
      recs = get_rec_stp(p_Oper, p_Step, p_Cntr, p_Cms_Tp, p_Cms_Nm);
      for (r, recs)
         Del_rec(r.Coms_Tp, r.Coms_Id);
      end;
   end;
end;

// получить список комиссий шага
Class ListComisStep(p_Doc_Kd, p_Doc_Id, p_Oper_id, p_Step_Id, p_Date)
var v_Doc_Kd = p_Doc_Kd, v_Doc_Id = p_Doc_Id, v_Oper_id = p_Oper_id, v_Step_Id = p_Step_Id, v_Date = p_Date;
   //
   macro list
      var sqls, rsdc, rsds, i = 0, coms:Tarray;
      sqls = String( 
         "WITH Prm AS   \n"
        ," (SELECT :p_Dck Dock, :p_Opr Operid, :p_Stp Stepid, :p_Dat Dat FROM Dual)   \n"
        ,"SELECT Sfc.t_Id Cntrid   \n"
        ,"      ,Sfcc.t_Feetype Cms_Tp   \n"
        ,"      ,Sfcc.t_Commnumber Cms_Nm   \n"
        ,"      ,Sfco.t_Fiid_Comm Cms_Fi   \n"
        ,"      ,Rsi_Rsb_Kernel.Getnote(Objtype  => 650   \n"
        ,"                             ,Objid    => Lpad(Sfcc.t_Feetype, 5, '0') || Lpad(Sfcc.t_Commnumber, 5, '0')   \n"
        ,"                             ,Notekind => 101   \n"
        ,"                             ,Dat      => Prm.Dat) Cms_Ku   \n"
        ,"      ,(SELECT Mc.t_Code FROM Dmccateg_Dbt Mc WHERE Mc.t_Number = Sfco.t_Ndscateg) Cms_Nds_Ku   \n"
        ,"      ,(SELECT p.t_Code FROM Dsfcomiss_Dbt p WHERE p.t_Comissid = Sfco.t_Parentcomissid) Cms_Gr   \n"
        ,"  FROM Prm   \n"
        ," INNER JOIN Doprstep_Dbt Ops   \n"
        ,"    ON (Ops.t_Id_Operation = Prm.Operid AND Ops.t_Id_Step = Prm.Stepid)   \n"
        ," INNER JOIN Doproper_Dbt Opr   \n"
        ,"    ON (Opr.t_Id_Operation = Ops.t_Id_Operation AND Opr.t_Dockind = Prm.Dock)   \n"
        ," INNER JOIN Dnptxop_Dbt Npt   \n"
        ,"    ON (Npt.t_Id = To_Number(Opr.t_Documentid))   \n"
        ," INNER JOIN Dsfcontr_Dbt Sfc   \n"
        ,"    ON (Sfc.t_Id = Npt.t_Contract)   \n"
        ," INNER JOIN Dsfconcom_Dbt Sfcc   \n"
        ,"    ON (Sfcc.t_Objecttype = 659 AND Sfcc.t_Objectid = Sfc.t_Id AND Sfcc.t_Feetype = 3 AND Sfcc.t_Status = 0 AND   \n"
        ,"       Sfcc.t_Date <= Prm.Dat and (Sfcc.T_DATEEND = to_date('01.01.0001','DD.MM.YYYY') or Sfcc.T_DATEEND >= Prm.Dat) )   \n"/*DEF-31387*/
        ," INNER JOIN Dsfcomiss_Dbt Sfco   \n"
        ,"    ON (Sfco.t_Feetype = Sfcc.t_Feetype AND Sfco.t_Number = Sfcc.t_Commnumber AND Sfco.t_Fiid_Comm = Npt.t_Currency)   \n"
        ," INNER JOIN Doprksfcm_Dbt Oks   \n"
        ,"    ON (Oks.t_Blockid = Ops.t_Blockid AND Oks.t_Number_Step = Ops.t_Number_Step AND Oks.t_Feetype = Sfcc.t_Feetype AND   \n"
        ,"       Oks.t_Commnumber = Sfcc.t_Commnumber)   \n"
        ,"    where (SELECT p.t_Code FROM Dsfcomiss_Dbt p WHERE p.t_Comissid = Sfco.t_Parentcomissid) like case when npt.t_subkind_operation = 10 then '%Зачисление%' else '%Вывод%' end \n"
        ," ORDER BY Sfcc.t_Commnumber   \n"
       );
      rsdc = rsdCommand(sqls);
      rsdc.AddParam("p_Dck", RSDBP_IN, v_Doc_Kd);
      rsdc.AddParam("p_Opr", RSDBP_IN, v_Oper_Id);
      rsdc.AddParam("p_Stp", RSDBP_IN, v_Step_Id);
      rsdc.AddParam("p_Dat", RSDBP_IN, v_Date);
      rsds = rsdrecordset(rsdc, RSDVAL_CLIENT_IF_NEEDED, RSDVAL_FORWARD_ONLY);
      rsds.Open;
      coms = Tarray;
      while (rsds.MoveNext())
         i = coms.Size;
         coms[i] = Usr_Comiss_Parm(int(rsds.Value("Cntrid")), int(rsds.Value("Cms_Tp")), int(rsds.Value("Cms_Nm")));
         coms[i].Coms_Dt = v_Date;
         coms[i].Coms_Fi = int(rsds.Value("Cms_Fi"));
         if ((rsds.Value("Cms_Ku") != null) and ( rsds.Value("Cms_Ku") != nullval))
            coms[i].Coms_Ku = rsds.Value("Cms_Ku");
         end;
         if ((rsds.Value("Cms_Nds_Ku") != null) and ( rsds.Value("Cms_Nds_Ku") != nullval))
            coms[i].Nds_Ku = rsds.Value("Cms_Nds_Ku");
         end;
         if ((rsds.Value("Cms_Gr") != null) and ( rsds.Value("Cms_Gr") != nullval))
            coms[i].Coms_Gr = rsds.Value("Cms_Gr");
         end;
      end;
      rsds = null;
      rsdc = null;
      return coms;
   end;
end;

// Сформировать комиссии шагов
macro make_comis_step(r_doc, Doc_Kd, ID_Oper, ID_Step, Sm:@money)
   var paysum, taxsum, all_c, r, res ;
   // получить все комиссии шага
   all_c = ListComisStep(Doc_Kd, r_doc.ID, ID_Oper, ID_Step, r_doc.OperDate).List;
   // рассчитать все комиссии
   for (r, all_c)
      res = SfCalcOprSfCom(r.ContrID, r.Coms_Nm, r_doc, Doc_Kd, r_doc.OutSum, r_doc.Currency, r_doc.OperDate, r_doc.OperDate, @paysum, @taxsum);
      if (not res)
         r.Coms_Err = GetErrMsg();
         return r.Coms_Err;
      end;
      r.Coms_Sm = paysum;
      r.Nds_Sm  = taxsum;
   end;   
   // сформировать ненулевые комиссии
   Sm = $0.0;
   for (r, all_c)
      if (r.Coms_Sm == 0)
         continue;
      end;
      // найти или открыть счета и записать в коллекцию комиссий cms
      if ((Doc_Kd == 4607) and (r.Coms_Gr == "МСКБ_ВалБиржа_Вывод_ДС")) 
         ExecMacroFile("CLCCOM_BCOUTDS", "make_comission_doc", r_doc, r); 
      elif ((Doc_Kd == 4607) and (r.Coms_Gr == "МСКБ_ВалБиржа_Зачисление_ДС"))   
         ExecMacroFile("CLCCOM_BCINCDS", "make_comission_doc", r_doc, r); 
      end;
      if (strlen(trim(r.Coms_Err)) != 0)
         msgbox(r.Coms_Err);
         return false;
      end;
      //создать запись о комиссии
      Sm = Sm + r.Coms_Sm;
      if (not SfDef_Rec.Ins_rec(r, ID_Oper, ID_Step, "", ""))
         msgbox(r.Coms_Err);
         return false;
      end;
   end;
   return true;
end;

