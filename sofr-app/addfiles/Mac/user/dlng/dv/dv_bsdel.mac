IMPORT PTinter, RSBDataSet, dl_plib, dlgCommon, funk, dl_kvlib, fx_globals; 
PRIVATE VAR d0, pId22, rs0, cmd22, {curdate}, sql0, flag, rs05, que, su0, su10, su20, rs10, info, info0, dd0; 
PRIVATE VAR col22 = TArray();
PRIVATE VAR v_DealId = TArray(), v_count;

MACRO SD_STA()
  su0 = 0;
  su10 = 0;
  su20 = 0;

  que = "select count(*) from ddvndeal_dbt a , dpmpaym_dbt b, dparty_dbt e  where a.t_state = 0 and a.t_contractor = " + _NKC + "  and  (a.t_kind = 22730 or a.t_kind = 2730  or a.t_kind = 2740)  and b.t_dockind = 4813 and b.t_documentid = a.t_id and (b.t_purpose = 1 or  b.t_purpose = 3) and (to_char(b.t_valuedate,'dd.mm.yyyy') = '" + СДАТ(d0) + "' ) and e.t_partyid = a.t_contractor";
  rs10 = LnGetRecordset(que);
  if(rs10 != null)
    if (rs10.moveNext) 
         su0="Загружено: "+ string(int(rs10.value(0)));
    end;
  end;
           
  que = "select count(*) from ddvndeal_dbt a , dpmpaym_dbt b, dparty_dbt e  where a.t_state = 1 and a.t_contractor = " + _NKC + " and (a.t_kind = 22730 or a.t_kind = 2730 or a.t_kind = 2740) and b.t_dockind= 4813 and b.t_documentid = a.t_id and (b.t_purpose = 1 or b.t_purpose = 3) and (to_char(b.t_valuedate,'dd.mm.yyyy') = '" + СДАТ(d0) + "' ) and e.t_partyid = a.t_contractor";
  rs10 = LnGetRecordset(que);
  if(rs10 != null)
    if (rs10.moveNext) 
         su10 = "Готовы к неттингу: " + string(int(rs10.value(0)));
    end;
  end;

  que = "select count(*) from ddvndeal_dbt a , dpmpaym_dbt b, dparty_dbt e  where a.t_state = 2 and a.t_contractor = " + _NKC + " and (a.t_kind = 22730 or a.t_kind = 2730 or a.t_kind = 2740) and b.t_dockind = 4813 and b.t_documentid = a.t_id and (b.t_purpose = 1 or b.t_purpose = 3) and  (to_char(b.t_valuedate,'dd.mm.yyyy') = '" + СДАТ(d0) + "' ) and e.t_partyid = a.t_contractor";
  rs10 = LnGetRecordset(que);
  if(rs10 != null)
    if (rs10.moveNext) 
         su20 = "Полная обработка: " + string(int(rs10.value(0)));
    end;
  end;
  info = su0 + "    " + su10 + "   " + su20;
END;

MACRO bsdel()
     d0 = {curdate};

     sql0 = "select a.t_id pId22, a.t_date dealdate, b.t_valuedate valuedate, e.t_shortname nam, a.t_code dealcode, a.t_extcode dealcodets, (case when b.t_payer != 1 then TO_CHAR(b.t_baseamount,'9,999,999,999.00') else (select  TO_CHAR(bb.t_baseamount,'9,999,999,999.00')  from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and ";
     sql0 = sql0 + "  bb.t_documentid = b.t_documentid and bb.t_purpose = b.t_purpose + 1)  end) su1, (case when b.t_payer = 1 then TO_CHAR(b.t_baseamount,'9,999,999,999.00') else  (select  TO_CHAR(bb.t_baseamount,'9,999,999,999.00')  from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and  bb.t_documentid = b.t_documentid and bb.t_purpose = b.t_purpose + 1 ) end) su2, ";
     sql0 = sql0 + " (case when b.t_payer != 1 then (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = b.t_fiid) else (select (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = bb.t_fiid) from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and ";
     sql0 = sql0 + " bb.t_documentid=b.t_documentid and bb.t_purpose = 2)  end) fiid1, (case when b.t_payer = 1 then (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = b.t_fiid) else ";
     sql0 = sql0 + "  (select  (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = bb.t_fiid) from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and  bb.t_documentid = b.t_documentid and bb.t_purpose = b.t_purpose + 1) end) fiid2,";
     sql0 = sql0 + "  (case when a.t_state = 0 then 'Загружена' else (case when a.t_state = 2 then 'Исполнена' else 'В обработке'  end) end) sta";
     sql0 = sql0 + " from ddvndeal_dbt a, dpmpaym_dbt b, dparty_dbt e  where a.t_contractor = " + _NKC + " and a.t_kind in (22730, 2730, 2740, 2710)  and b.t_dockind in (4813, 4815, 199) and b.t_documentid = a.t_id and (b.t_purpose = 1 or b.t_purpose = 3) and (to_char(b.t_valuedate,'dd.mm.yyyy') = '" + СДАТ(d0) + "' ) and e.t_partyid = a.t_contractor order by sta desc, a.t_date, a.t_id, b.t_valuedate ";
     cmd22 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );

     MACRO EvProc22 (rs0, cmd22, id, key )
        if (cmd22 == DLG_INIT) // Инициализация
            if (pId22 != "0")  // Надо найти запись
                v_count = 0;
                while ( (rs0.value ("pId22") != pId22) And (Not rs0.EOF) )  
                         if (ValType(rs0.value ("pId22")) == 26)
                             v_DealId(v_count) = 0;
                         else
                             v_DealId(v_count)= rs0.value ("pId22");
                         end;
                         rs0.Move(1, RELATIVE);
                         v_count = v_count + 1;
                end;
            end;
            GoToScroll(rs0, true);
        elif (cmd22 == DLG_KEY)
             pId22 = rs0.value ("pId22");
             if(DLG_KEY_ENTER == Key)
               sql0 = "select a.t_id pId22,a.t_date dealdate,b.t_valuedate valuedate ,  e.t_shortname nam, a.t_code dealcode, a.t_extcode dealcodets, (case when b.t_payer != 1 then TO_CHAR(b.t_baseamount,'9,999,999,999.00') else (select  TO_CHAR(bb.t_baseamount,'9,999,999,999.00')   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and  ";
               sql0 = sql0 + "  bb.t_documentid=b.t_documentid and bb.t_purpose = b.t_purpose + 1)  end) su1, (case when b.t_payer = 1 then TO_CHAR(b.t_baseamount,'9,999,999,999.00') else  (select  TO_CHAR(bb.t_baseamount,'9,999,999,999.00')   from dpmpaym_dbt bb where bb.t_dockind=b.t_dockind and  bb.t_documentid = b.t_documentid and bb.t_purpose = b.t_purpose + 1 ) end) su2, ";
               sql0 = sql0 + " (case when b.t_payer != 1 then (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = b.t_fiid) else (select  (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = bb.t_fiid) from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and ";
               sql0 = sql0 + " bb.t_documentid=b.t_documentid and bb.t_purpose = 2)  end) fiid1, (case when b.t_payer = 1 then (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = b.t_fiid) else ";
               sql0 = sql0 + "  (select  (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = bb.t_fiid)   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and  bb.t_documentid = b.t_documentid and bb.t_purpose = b.t_purpose + 1) end) fiid2,";
               sql0 = sql0 + "  (case when a.t_state = 0 then 'Загружена' else (case when a.t_state = 2 then 'Исполнена' else 'В обработке'  end)    end) sta";
               sql0 = sql0 + " from ddvndeal_dbt a , dpmpaym_dbt b, dparty_dbt e  where a.t_contractor = " + _NKC + "  and  (a.t_kind = 22730 or a.t_kind = 2730 or a.t_kind = 2740)  and b.t_dockind = 4813 and b.t_documentid = a.t_id and (b.t_purpose = 1 or  b.t_purpose = 3) and (to_char(b.t_valuedate,'dd.mm.yyyy') = '" + СДАТ(d0) + "' ) and e.t_partyid = a.t_contractor  order by  sta desc, a.t_date,a.t_id, b.t_valuedate ";
               return CM_SELECT;
            elif(DLG_KEY_F3 == Key) 
               dd0 = {curdate};
               getdate(dd0,"Укажите дату  заключения сделк для фильтра ");
               sql0 = "select a.t_id pId22,a.t_date dealdate,b.t_valuedate valuedate ,  e.t_shortname nam, a.t_code dealcode, a.t_extcode dealcodets, (case when b.t_payer != 1 then TO_CHAR(b.t_baseamount,'9,999,999,999.00') else (select  TO_CHAR(bb.t_baseamount,'9,999,999,999.00') from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and  ";
               sql0 = sql0 + "  bb.t_documentid = b.t_documentid and bb.t_purpose = b.t_purpose + 1)  end) su1, (case when b.t_payer = 1 then TO_CHAR(b.t_baseamount,'9,999,999,999.00') else  (select  TO_CHAR(bb.t_baseamount,'9,999,999,999.00') from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and  bb.t_documentid = b.t_documentid and bb.t_purpose = b.t_purpose + 1 ) end) su2, ";
               sql0 = sql0 + " (case when b.t_payer != 1 then (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = b.t_fiid) else (select  (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = bb.t_fiid)   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and ";
               sql0 = sql0 + " bb.t_documentid = b.t_documentid and bb.t_purpose = 2)  end) fiid1, (case when b.t_payer = 1 then (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = b.t_fiid) else ";
               sql0 = sql0 + "  (select  (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = bb.t_fiid)   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and  bb.t_documentid = b.t_documentid and bb.t_purpose = b.t_purpose + 1)  end) fiid2,";
               sql0 = sql0 + "  (case when a.t_state = 0 then 'Загружена' else (case when a.t_state = 2 then 'Исполнена' else 'В обработке'  end)    end) sta";
               sql0 = sql0 + " from ddvndeal_dbt a , dpmpaym_dbt b, dparty_dbt e  where to_char(a.t_date,'dd.mm.yyyy') = '" + СДАТ(dd0) + "' and a.t_contractor = " + _NKC + "  and  ( a.t_kind=22730 or a.t_kind=2730  or a.t_kind=2740)  and b.t_dockind= 4813 and b.t_documentid=a.t_id and (b.t_purpose=1 or  b.t_purpose=3)  and  (to_char(b.t_valuedate,'dd.mm.yyyy') = '" + СДАТ(d0) + "' ) and e.t_partyid=a.t_contractor  order by  sta desc, a.t_date,a.t_id, b.t_valuedate ";
               return CM_SELECT;
            elif(DLG_KEY_F5 == Key) 
               sql0 = "select a.t_id pId22,a.t_date dealdate,b.t_valuedate valuedate ,  e.t_shortname nam, a.t_code dealcode, a.t_extcode dealcodets, (case when b.t_payer != 1 then TO_CHAR(b.t_baseamount,'9,999,999,999.00') else (select  TO_CHAR(bb.t_baseamount,'9,999,999,999.00')   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and  ";
               sql0 = sql0 + "  bb.t_documentid = b.t_documentid and bb.t_purpose = b.t_purpose + 1)  end) su1, (case when b.t_payer = 1 then TO_CHAR(b.t_baseamount,'9,999,999,999.00') else  (select  TO_CHAR(bb.t_baseamount,'9,999,999,999.00')   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and  bb.t_documentid = b.t_documentid and bb.t_purpose = b.t_purpose + 1 ) end) su2, ";
               sql0 = sql0 + " (case when b.t_payer != 1 then (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = b.t_fiid) else (select  (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = bb.t_fiid)   from dpmpaym_dbt bb where bb.t_dockind=b.t_dockind and ";
               sql0 = sql0 + " bb.t_documentid = b.t_documentid and bb.t_purpose = 2)  end) fiid1, (case when b.t_payer = 1 then (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = b.t_fiid) else ";
               sql0 = sql0 + "  (select  (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = bb.t_fiid) from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and  bb.t_documentid = b.t_documentid and bb.t_purpose=b.t_purpose+1)  end) fiid2,";
               sql0 = sql0 + "  (case when a.t_state = 0 then 'Загружена' else (case when a.t_state = 2 then 'Исполнена' else 'В обработке'  end)    end) sta";
               sql0 = sql0 + " from ddvndeal_dbt a , dpmpaym_dbt b, dparty_dbt e  where a.t_state = 0 and  a.t_contractor = " + _NKC + "  and  (a.t_kind = 22730 or a.t_kind = 2730 or a.t_kind = 2740)  and b.t_dockind= 4813 and b.t_documentid=a.t_id and (b.t_purpose=1 or  b.t_purpose = 3)  and  (to_char(b.t_valuedate,'dd.mm.yyyy') = '" + СДАТ(d0) + "' ) and e.t_partyid = a.t_contractor  order by  sta desc, a.t_date,a.t_id, b.t_valuedate ";
               return CM_SELECT;
            elif(DLG_KEY_F7 == Key) 
               sql0 = "select a.t_id pId22,a.t_date dealdate,b.t_valuedate valuedate ,  e.t_shortname nam, a.t_code dealcode, a.t_extcode dealcodets, (case when b.t_payer != 1 then TO_CHAR(b.t_baseamount,'9,999,999,999.00') else (select  TO_CHAR(bb.t_baseamount,'9,999,999,999.00')   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and  ";
               sql0 = sql0 + "  bb.t_documentid = b.t_documentid and bb.t_purpose = b.t_purpose + 1)  end) su1, (case when b.t_payer = 1 then TO_CHAR(b.t_baseamount,'9,999,999,999.00') else  (select  TO_CHAR(bb.t_baseamount,'9,999,999,999.00')   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and  bb.t_documentid = b.t_documentid and bb.t_purpose = b.t_purpose + 1 ) end) su2, ";
               sql0 = sql0 + " (case when b.t_payer != 1 then (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = b.t_fiid) else (select  (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = bb.t_fiid)   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and ";
               sql0 = sql0 + " bb.t_documentid = b.t_documentid and bb.t_purpose = 2)  end) fiid1, (case when b.t_payer = 1 then (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = b.t_fiid) else ";
               sql0 = sql0 + "  (select  (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = bb.t_fiid)   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and  bb.t_documentid = b.t_documentid and bb.t_purpose = b.t_purpose + 1)  end) fiid2,";
               sql0 = sql0 + "  (case when a.t_state = 0 then 'Загружена' else (case when a.t_state = 2 then 'Исполнена' else 'В обработке'  end)    end) sta";
               sql0 = sql0 + " from ddvndeal_dbt a , dpmpaym_dbt b, dparty_dbt e  where  a.t_state = 1 and a.t_contractor = " + _NKC + "  and  (a.t_kind = 22730 or a.t_kind = 2730  or a.t_kind = 2740)  and b.t_dockind = 4813 and b.t_documentid = a.t_id and (b.t_purpose = 1 or  b.t_purpose = 3)  and  (to_char(b.t_valuedate,'dd.mm.yyyy') = '" + СДАТ(d0) + "' ) and e.t_partyid = a.t_contractor  order by  sta desc, a.t_date,a.t_id, b.t_valuedate ";
               return CM_SELECT;
            end;
        end;
     END;

     AddCol (col22, 0, "nam","Контрагент", 11);
     AddCol (col22, 1, "dealdate","Дата ", 10);
     AddCol (col22, 2, "valuedate","Дата валютирования", 15);
     AddCol (col22, 3, "dealcode","№ сделки", 10);
     AddCol (col22, 4, "dealcodets","№ сделки(вн)", 10);
     AddCol (col22, 5, "su2","Cумма обязательств", 15);     
     AddCol (col22, 6, "fiid2","Валюта", 6);
     AddCol (col22, 7, "su1","Cумма требований", 15);                                                                                                                                                                                                          AddCol (col22, 5, "su2","Сумма обязательств", 15);
     AddCol (col22, 8, "fiid1","Валюта", 6);
     AddCol (col22, 9, "sta","Статус обработки сделки", 20);
 
     SD_STA();
     info0 = "Монитор обработки сделок FX ММВБ за "+СДАТ(d0)+"                       "+info;

     while(RunScroll(cmd22, 10, col22, null, @EvProc22,info0,"ENTER- Все сделки F3- Сделки по дате заключения   F5- Сделки загружены  F7- Cделки в обработке     ESC- Выход ", null, 2, 10) )
           SD_STA();
           info0= "Монитор обработки сделок FX ММВБ за "+СДАТ(d0)+"                       "+info;
           cmd22 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );
     end;
     exit(1);
END;

MACRO bsdelv(nfiid)

     d0 = {curdate};

     sql0 = "select a.t_id pId22,a.t_date dealdate,b.t_valuedate valuedate ,  e.t_shortname nam, a.t_code dealcode, a.t_extcode dealcodets, (case when b.t_payer != 1 then TO_CHAR(b.t_baseamount,'9,999,999,999.00') else (select  TO_CHAR(bb.t_baseamount,'9,999,999,999.00')   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and  ";
     sql0 = sql0 + "  bb.t_documentid = b.t_documentid and bb.t_purpose = b.t_purpose + 1)  end) su1, (case when b.t_payer = 1 then TO_CHAR(b.t_baseamount,'9,999,999,999.00') else  (select  TO_CHAR(bb.t_baseamount,'9,999,999,999.00')   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and  bb.t_documentid = b.t_documentid and bb.t_purpose = b.t_purpose + 1 ) end) su2, ";
     sql0 = sql0 + " (case when b.t_payer != 1 then (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = b.t_fiid) else (select  (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = bb.t_fiid)   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and ";
     sql0 = sql0 + " bb.t_documentid = b.t_documentid and bb.t_purpose = 2)  end) fiid1, (case when b.t_payer = 1 then (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = b.t_fiid) else ";
     sql0 = sql0 + "  (select  (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = bb.t_fiid)   from dpmpaym_dbt bb where bb.t_dockind=b.t_dockind and  bb.t_documentid = b.t_documentid and bb.t_purpose=b.t_purpose+1)  end) fiid2,";
     sql0 = sql0 + "  (case when a.t_state = 0 then 'Загружена' else (case when a.t_state = 2 then 'Исполнена' else 'В обработке'  end)    end) sta";
     sql0 = sql0 + " from ddvndeal_dbt a , dpmpaym_dbt b, dparty_dbt e  where b.t_fiid = " + nfiid + " and  a.t_contractor = " + _NKC + "  and  ";
     sql0 = sql0 + " ((a.t_kind in (22730, 2730, 2740)  and b.t_dockind in (4813, 4815)) or (a.t_kind in (2710)  and b.t_dockind in (199)) )  ";
     sql0 = sql0 + "  and b.t_documentid = a.t_id and (b.t_purpose = 1 or  b.t_purpose = 3)  and  (to_char(b.t_valuedate,'dd.mm.yyyy') = '" + СДАТ(d0) + "' ) and e.t_partyid = a.t_contractor  order by  sta desc, a.t_date,a.t_id, b.t_valuedate ";
     cmd22 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );

     MACRO EvProc22 (rs0, cmd22, id, key )
        if (cmd22 == DLG_INIT)       // Инициализация
            if (pId22 != "0")  // Надо найти запись
                v_count = 0;
                while ( (rs0.value ("pId22") != pId22) And (Not rs0.EOF) )  
                         if (ValType(rs0.value ("pId22")) == 26)
                             v_DealId(v_count) = 0;
                         else
                             v_DealId(v_count)= rs0.value ("pId22");
                         end;
                         rs0.Move(1, RELATIVE);
                         v_count = v_count + 1;
                end;
            end;
            GoToScroll(rs0, true);
        elif (cmd22 == DLG_KEY)
            pId22 = rs0.value ("pId22");
            if(DLG_KEY_ENTER == Key)
               sql0 = "select a.t_id pId22,a.t_date dealdate,b.t_valuedate valuedate ,  e.t_shortname nam, a.t_code dealcode, a.t_extcode dealcodets, (case when b.t_payer != 1 then TO_CHAR(b.t_baseamount,'9,999,999,999.00') else (select  TO_CHAR(bb.t_baseamount,'9,999,999,999.00')   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and  ";
               sql0 = sql0 + "  bb.t_documentid = b.t_documentid and bb.t_purpose = b.t_purpose + 1)  end) su1, (case when b.t_payer = 1 then TO_CHAR(b.t_baseamount,'9,999,999,999.00') else  (select  TO_CHAR(bb.t_baseamount,'9,999,999,999.00')   from dpmpaym_dbt bb where bb.t_dockind=b.t_dockind and  bb.t_documentid = b.t_documentid and bb.t_purpose=b.t_purpose+1 ) end) su2, ";
               sql0 = sql0 + " (case when b.t_payer != 1 then (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = b.t_fiid) else (select  (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = bb.t_fiid)   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and ";
               sql0 = sql0 + " bb.t_documentid = b.t_documentid and bb.t_purpose = 2)  end) fiid1, (case when b.t_payer = 1 then (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = b.t_fiid) else ";
               sql0 = sql0 + "  (select  (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = bb.t_fiid)   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and  bb.t_documentid = b.t_documentid and bb.t_purpose = b.t_purpose + 1)  end) fiid2,";
               sql0 = sql0 + "  (case when a.t_state = 0 then 'Загружена' else (case when a.t_state = 2 then 'Исполнена' else 'В обработке'  end)    end) sta";
               sql0 = sql0 + " from ddvndeal_dbt a , dpmpaym_dbt b, dparty_dbt e  where b.t_fiid = " + nfiid + " and  a.t_contractor = " + _NKC + "  and  ";
               sql0 = sql0 + " ((a.t_kind in (22730, 2730, 2740)  and b.t_dockind in (4813, 4815)) or (a.t_kind in (2710)  and b.t_dockind in (199)) )  ";
               sql0 = sql0 + "   and b.t_documentid = a.t_id and (b.t_purpose = 1 or  b.t_purpose = 3)  and  (to_char(b.t_valuedate,'dd.mm.yyyy') = '" + СДАТ(d0) + "' ) and e.t_partyid=a.t_contractor  order by  sta desc, a.t_date,a.t_id, b.t_valuedate ";
               return CM_SELECT;
            elif(DLG_KEY_F3 == Key) 
               dd0 = {curdate};
               getdate(dd0,"Укажите дату  заключения сделк для фильтра ");

               sql0 = "select a.t_id pId22,a.t_date dealdate,b.t_valuedate valuedate ,  e.t_shortname nam, a.t_code dealcode, a.t_extcode dealcodets, (case when b.t_payer != 1 then TO_CHAR(b.t_baseamount,'9,999,999,999.00') else (select  TO_CHAR(bb.t_baseamount,'9,999,999,999.00')   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and  ";
               sql0 = sql0 + "  bb.t_documentid = b.t_documentid and bb.t_purpose = b.t_purpose + 1)  end) su1, (case when b.t_payer = 1 then TO_CHAR(b.t_baseamount,'9,999,999,999.00') else  (select  TO_CHAR(bb.t_baseamount,'9,999,999,999.00')   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and  bb.t_documentid = b.t_documentid and bb.t_purpose = b.t_purpose + 1 ) end) su2, ";
               sql0 = sql0 + " (case when b.t_payer != 1 then (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = b.t_fiid) else (select  (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = bb.t_fiid)   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and ";
               sql0 = sql0 + " bb.t_documentid = b.t_documentid and bb.t_purpose = 2)  end) fiid1, (case when b.t_payer = 1 then (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = b.t_fiid) else ";
               sql0 = sql0 + "  (select  (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = bb.t_fiid)   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and  bb.t_documentid = b.t_documentid and bb.t_purpose = b.t_purpose + 1)  end) fiid2,";
               sql0 = sql0 + "  (case when a.t_state = 0 then 'Загружена' else (case when a.t_state = 2 then 'Исполнена' else 'В обработке'  end)    end) sta";
               sql0 = sql0 + " from ddvndeal_dbt a , dpmpaym_dbt b, dparty_dbt e  where b.t_fiid = " + nfiid + " and to_char(a.t_date,'dd.mm.yyyy') = '"+СДАТ(dd0)+"' and a.t_contractor = " + _NKC + "  and  ";
               sql0 = sql0 + " ((a.t_kind in (22730, 2730, 2740)  and b.t_dockind in (4813, 4815)) or (a.t_kind in (2710)  and b.t_dockind in (199)) )  ";
               sql0 = sql0 + "  and b.t_documentid = a.t_id and (b.t_purpose = 1 or  b.t_purpose = 3)  and  (to_char(b.t_valuedate,'dd.mm.yyyy') = '" + СДАТ(d0) + "' ) and e.t_partyid = a.t_contractor  order by  sta desc, a.t_date,a.t_id, b.t_valuedate ";
               return CM_SELECT;
            elif(DLG_KEY_F5 == Key) 
               sql0 = "select a.t_id pId22,a.t_date dealdate,b.t_valuedate valuedate ,  e.t_shortname nam, a.t_code dealcode, a.t_extcode dealcodets, (case when b.t_payer != 1 then TO_CHAR(b.t_baseamount,'9,999,999,999.00') else (select  TO_CHAR(bb.t_baseamount,'9,999,999,999.00')   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and  ";
               sql0 = sql0 + "  bb.t_documentid = b.t_documentid and bb.t_purpose = b.t_purpose + 1)  end) su1, (case when b.t_payer = 1 then TO_CHAR(b.t_baseamount,'9,999,999,999.00') else  (select  TO_CHAR(bb.t_baseamount,'9,999,999,999.00')   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and  bb.t_documentid = b.t_documentid and bb.t_purpose = b.t_purpose + 1 ) end) su2, ";
               sql0 = sql0 + " (case when b.t_payer != 1 then (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = b.t_fiid) else (select  (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = bb.t_fiid) from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and ";
               sql0 = sql0 + " bb.t_documentid = b.t_documentid and bb.t_purpose = 2)  end) fiid1, (case when b.t_payer = 1 then (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = b.t_fiid) else ";
               sql0 = sql0 + "  (select  (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = bb.t_fiid)   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and  bb.t_documentid = b.t_documentid and bb.t_purpose = b.t_purpose + 1)  end) fiid2,";
               sql0 = sql0 + "  (case when a.t_state = 0 then 'Загружена' else (case when a.t_state = 2 then 'Исполнена' else 'В обработке'  end)    end) sta";
               sql0 = sql0 + " from ddvndeal_dbt a , dpmpaym_dbt b, dparty_dbt e  where b.t_fiid = " + nfiid + " and a.t_state=0 and  a.t_contractor = " + _NKC + "  and  ";
               sql0 = sql0 + " ((a.t_kind in (22730, 2730, 2740)  and b.t_dockind in (4813, 4815)) or (a.t_kind in (2710)  and b.t_dockind in (199)) )  ";
               sql0 = sql0 + "     and b.t_documentid = a.t_id and (b.t_purpose = 1 or  b.t_purpose = 3)  and  (to_char(b.t_valuedate,'dd.mm.yyyy') = '" + СДАТ(d0) + "' ) and e.t_partyid = a.t_contractor  order by  sta desc, a.t_date,a.t_id, b.t_valuedate ";
               return CM_SELECT;
            elif(DLG_KEY_F7 == Key) 
               sql0 = "select a.t_id pId22, a.t_date dealdate, b.t_valuedate valuedate, e.t_shortname nam, a.t_code dealcode, a.t_extcode dealcodets, (case when b.t_payer != 1 then TO_CHAR(b.t_baseamount,'9,999,999,999.00') else (select  TO_CHAR(bb.t_baseamount,'9,999,999,999.00')   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and  ";
               sql0 = sql0 + "  bb.t_documentid = b.t_documentid and bb.t_purpose=b.t_purpose+1)  end) su1, (case when b.t_payer = 1 then TO_CHAR(b.t_baseamount,'9,999,999,999.00') else  (select  TO_CHAR(bb.t_baseamount,'9,999,999,999.00')   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and  bb.t_documentid = b.t_documentid and bb.t_purpose = b.t_purpose + 1 ) end) su2, ";
               sql0 = sql0 + " (case when b.t_payer != 1 then (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = b.t_fiid) else (select  (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = bb.t_fiid)   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and ";
               sql0 = sql0 + " bb.t_documentid = b.t_documentid and bb.t_purpose = 2)  end) fiid1, (case when b.t_payer = 1 then (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = b.t_fiid) else ";
               sql0 = sql0 + "  (select  (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid = bb.t_fiid)   from dpmpaym_dbt bb where bb.t_dockind = b.t_dockind and  bb.t_documentid = b.t_documentid and bb.t_purpose = b.t_purpose + 1)  end) fiid2,";
               sql0 = sql0 + "  (case when a.t_state = 0 then 'Загружена' else (case when a.t_state = 2 then 'Исполнена' else 'В обработке'  end)    end) sta";
               sql0 = sql0 + " from ddvndeal_dbt a , dpmpaym_dbt b, dparty_dbt e  where  b.t_fiid = " + nfiid + " and a.t_state=1 and a.t_contractor = " + _NKC + "  and  ";
               sql0 = sql0 + " ((a.t_kind in (22730, 2730, 2740)  and b.t_dockind in (4813, 4815)) or (a.t_kind in (2710)  and b.t_dockind in (199)) )  ";
               sql0 = sql0 + " and b.t_documentid = a.t_id and (b.t_purpose = 1 or  b.t_purpose = 3)  and  (to_char(b.t_valuedate,'dd.mm.yyyy') = '" + СДАТ(d0) + "' ) and e.t_partyid = a.t_contractor  order by  sta desc, a.t_date, a.t_id, b.t_valuedate ";
               return CM_SELECT;
            end;
        end;
     END;

     AddCol (col22, 0, "nam","Контрагент", 11);
     AddCol (col22, 1, "dealdate","Дата ", 10);
     AddCol (col22, 2, "valuedate","Дата валютирования", 15);
     AddCol (col22, 3, "dealcode","№ сделки", 10);
     AddCol (col22, 4, "dealcodets","№ сделки(вн)", 10);
     AddCol (col22, 5, "su2","Cумма обязательств", 15);     
     AddCol (col22, 6, "fiid2","Валюта", 6);
     AddCol (col22, 7, "su1","Cумма требований", 15);                                                                                                                                                                                                       
     AddCol (col22, 5, "su2","Сумма обязательств", 15);
     AddCol (col22, 8, "fiid1","Валюта", 6);
     AddCol (col22, 9, "sta","Статус обработки сделки", 20);
  
     SD_STA();
     info0 =  "Монитор обработки сделок FX ММВБ за "+СДАТ(d0)+"                       ";

     while(RunScroll(cmd22, 10, col22, null, @EvProc22,info0,"ENTER- Все сделки F3- Сделки по дате заключения   F5- Сделки загружены  F7- Cделки в обработке     ESC- Выход ", null, 2, 10) )
           SD_STA();
           info0 =  "Монитор обработки сделок FX ММВБ за " + СДАТ(d0) + "                       ";
           cmd22 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );
     end;
     exit(1);
END;
