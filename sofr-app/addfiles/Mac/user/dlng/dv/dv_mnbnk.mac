import PTinter,RSBDataSet,dl_plib,dlgCommon,funk,dl_kvlib,fx_globals; 
private  var d0,pId2,rs0,cmd2,{curdate},sql0,flag,rs05,que; 
private  var col2 = TArray();
private  var v_DealId = TArray(), v_count;

     d0={curdate};
     sql0="select a.t_id pId2,b.t_valuedate dealdate,  e.t_shortname nam, a.t_code dealcode, a.t_extcode dealcodets, (case when b.t_payer != 1 then TO_CHAR(b.t_baseamount,'9,999,999,999.00') else (select  TO_CHAR(bb.t_baseamount,'9,999,999,999.00')   from dpmpaym_dbt bb where bb.t_dockind=b.t_dockind and  ";
     sql0=sql0+"  bb.t_documentid=b.t_documentid and bb.t_purpose=b.t_purpose+1)  end) su1, (case when b.t_payer = 1 then TO_CHAR(b.t_baseamount,'9,999,999,999.00') else  (select  TO_CHAR(bb.t_baseamount,'9,999,999,999.00')   from dpmpaym_dbt bb where bb.t_dockind=b.t_dockind and  bb.t_documentid=b.t_documentid and bb.t_purpose=b.t_purpose+1 ) end) su2, ";

     sql0=sql0+ " (case when b.t_paymstatus = 32000 then'Сделка обработана' else     (select cc.t_name  from doproper_dbt aa , doprstep_dbt bb ,doprostep_dbt cc ";
     sql0=sql0+ " where (aa.t_dockind=4813 or  aa.t_dockind= 4815 )  and aa.t_DocumentID=lpad(a.t_id,34,'0') and bb.t_id_operation=aa.t_id_operation ";
     sql0=sql0+ " and t_isexecute='R'and rownum=1  and cc.t_blockid=bb.t_blockid and cc.t_number_step=bb.t_number_step ) end)   sta,  ";

     sql0=sql0+ " (case when ";
     sql0=sql0+ " (select count(*) from dpmpaym_dbt b9 where (b9.t_dockind= 4813 or b9.t_dockind=4815)  and b9.t_documentid=a.t_id and b9.t_purpose >= b.t_purpose+1   and b9.t_receiver = "+_BANK0+" and  b9.t_paymstatus=32000) > 0 ";
     sql0=sql0+ " then  'Cквитован' else ' ' end) vpl,";

     // sql0="select ";


     sql0=sql0+ " (case when ";
     sql0=sql0+ " (select count(*) from dpmpaym_dbt b9 where (b9.t_dockind= 4813 or b9.t_dockind=4815)  and b9.t_documentid=a.t_id and b9.t_purpose >= b.t_purpose+1   and b9.t_payer = "+_BANK0+" and  b9.t_paymstatus=32000) > 0 ";
     sql0=sql0+ " then  'Готов к отправке' else ";
     sql0=sql0+ " (case when ";
     sql0=sql0+ " (select count(*) from dpmpaym_dbt b9 where (b9.t_dockind= 4813 or b9.t_dockind=4815)  and b9.t_documentid=a.t_id and b9.t_purpose >= b.t_purpose+1   and b9.t_payer = "+_BANK0+" and  b9.t_paymstatus=3000) > 0 ";
     sql0=sql0+ " then  'Cформирован' else ' ' end) ";
     sql0=sql0+ " end) vpl2,";

     sql0=sql0+" (case when b.t_payer != 1 then (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid=b.t_fiid) else (select  (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid=bb.t_fiid)   from dpmpaym_dbt bb where bb.t_dockind=b.t_dockind and ";
     sql0=sql0+" bb.t_documentid=b.t_documentid and bb.t_purpose=2)  end) fiid1, (case when b.t_payer = 1 then (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid=b.t_fiid) else ";
     sql0=sql0+"  (select  (select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid=bb.t_fiid)   from dpmpaym_dbt bb where bb.t_dockind=b.t_dockind and  bb.t_documentid=b.t_documentid and bb.t_purpose=b.t_purpose+1)  end) fiid2 ";

     sql0=sql0+" from ddvndeal_dbt a , dpmpaym_dbt b, dparty_dbt e  where a.t_contractor !="+_NKC+"  and  (a.t_kind=12735  or a.t_kind=12735)  and b.t_dockind= 4813 and b.t_documentid=a.t_id and (b.t_purpose=1 or  b.t_purpose=3)  and  (to_char(b.t_valuedate,'dd.mm.yyyy') = '"+СДАТ(d0)+"' or  to_char(a.t_date,'dd.mm.yyyy') = '"+СДАТ(d0)+"') and e.t_partyid=a.t_contractor  order by b.t_paymstatus,a.t_id, b.t_valuedate ";

     //  msgbox(sql0);
      cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );


  macro EvProc2 (rs0, cmd2, id, key )
     if (cmd2 == DLG_INIT)	// Инициализация
        if (pId2 != "0")  // Надо найти запись
           v_count = 0;
           while ( (rs0.value ("pId2") != pId2) And (Not rs0.EOF) )  
		if (ValType(rs0.value ("pId2")) == 26)
			v_DealId(v_count) = 0;
		else
			v_DealId(v_count)= rs0.value ("pId2");
		end;
                rs0.Move(1, RELATIVE);
		v_count = v_count + 1;
            end;

        end;
        GoToScroll(rs0, true);
     elif (cmd2 == DLG_KEY)

        pId2=rs0.value ("pId2");
        if(DLG_KEY_ENTER == Key)
           return CM_SELECT;
        elif(DLG_KEY_F5 == Key) 
           // execmacrofile("dl_kvp.mac", "Kvitovka",d0) ;

           return CM_SELECT;

        end;
     end;
  end;

  AddCol (col2, 0, "nam","Контрагент", 16);
  AddCol (col2, 1, "dealdate","Дата ", 10);
  AddCol (col2, 2, "dealcode","№ сделки", 10);
  AddCol (col2, 3, "dealcodets","№ сделки(вн)", 10);
  AddCol (col2, 4, "su1","Cумма требований", 15);                                                                                                                                                                                                         
  AddCol (col2, 5, "su2","Сумма обязательств", 15);
  AddCol (col2, 5, "fiid1","Валюта", 6);
  AddCol (col2, 6, "su2","Cумма обязательств", 15);     
  AddCol (col2, 7, "fiid2","Валюта", 6);
  AddCol (col2, 8, "sta","Шаг обработки сделки", 20);
  AddCol (col2, 9, "vpl","Статус Входящего платежа", 24);
  AddCol (col2, 10, "vpl2","Статус Исходящего платежа", 24);



   while(RunScroll(cmd2, 11, col2, null, @EvProc2,"Монитор банкнотных сделок за "+СДАТ(d0)," ESC- Выход ", null, 0, 0) )
     cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );

   end;

   exit(1);
end;



