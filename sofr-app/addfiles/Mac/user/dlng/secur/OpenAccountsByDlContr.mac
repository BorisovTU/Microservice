/* 20.05.2019 bpv                              */
/* Открытие счетов по договору 306 47423 ВУ ДС */


import RSD, globals;
import dlcontrfunc, sp_car, func_lib;
import "CCloseAccountsSingle.mac";
import "fm_util.mac";
const K_ENTER   = 13;
//const K_ESC     = 27;
const K_F3      = 317;
const K_F2      = 316;
const K_F5      = 319;
const K_F6      = 320;
const K_F8      = 322;
const K_F9      = 323;
const K_ALT_F9  = 368;

const C_OPEN_ACC_DEBT         = 0; //Открытие счета просроченной задолженности
const C_OPEN_ACC_DEBT_RESERVE = 1; //Открытие счета резерва по просроченной задолженности

PRIVATE MACRO AddCol (ar,ind, fld, head, width, rdonly, ty, dp)
   ar.value (ind * 6)     = fld;
   ar.value (ind * 6 + 1) = head;
   ar.value (ind * 6 + 2) = width;
   ar.value (ind * 6 + 3 ) = rdonly;   // fldType
   ar.value (ind * 6 + 4 ) = dp;//   decPoint
   ar.value (ind * 6 + 5 ) = 0;   // reserv
END;

macro EvProcSelect(rs, cmd, id, key)
   var  CM_DEFAULT = null;

   if ((cmd == DLG_KEY)and(key == K_ENTER))
      return CM_SELECT;
   end;
   return CM_DEFAULT;
end;


private macro GetSfcontr(dlcontrid, servkind:@integer, servkindsub:@integer, partyid:@integer);
   var col1 = TArray;   
   var arnum = -1;
   AddCol (col1, arnum=arnum+1, "servkindsub",  "Вид",        8 ,  0,0);
   AddCol (col1, arnum=arnum+1, "t_number",     "Субдоговор", 15 ,  0,0);
   AddCol (col1, arnum=arnum+1, "servkind",   "Вид обслуживания", 15 ,  0,0);
   var cmd1 = 
     "   SELECT DECODE (t.t_servkindsub,  8, 'Биржа',  9, 'Внебиржа',  ' ') servkindsub, t_id, t_number, t.t_servkind, t.t_servkindsub, t.t_partyid, " +
     "          (SELECT servkind.t_name FROM dservkind_dbt servkind WHERE servkind.t_servisekind = t.t_servkind) servkind " +
     "     FROM dsfcontr_dbt t " +
     "    WHERE t.t_id in (select t_sfcontrid from ddlcontrmp_dbt where t_dlcontrid = "+dlcontrid+") " +
     "      AND t.t_DateClose = TO_DATE('01.01.0001', 'DD.MM.YYYY') "; 

   cmd1 = RSDCommand(cmd1);
   var rs1 = RSDRecordset(cmd1 , null, RSDVAL_STATIC );
   if (RunScroll (rs1,col1.size/6, col1, "test1" ,"EvProcSelect","Выбрать субдоговор","Выбрать субдоговор", true, 5, 5))
       servkind = rs1.value("t_servkind");
       servkindsub = rs1.value("t_servkindsub");
       partyid = rs1.value("t_partyid");
       return rs1.value("t_id");
   end;
   return -1;
end;

private macro GetCurrency(sfcontrid);
   var RetArr = TArray();
   var f = false;
   macro EvProcMultiSelect(rs, cmd, id, key)
        var  CM_DEFAULT = null;

        if (cmd == DLG_INIT)
           AddMultiAction(rs, K_F2);
        elif(cmd == DLG_MSELSTART)
           if(key == K_F2)
              RetArr = TArray()
           end;
        elif(cmd == DLG_MSELEND)
          if(key == K_F2)
             f = true;
             return CM_MSEL_CONT_CLEAR;
          end;
        elif(cmd == DLG_MSEL)
          if(key == K_F2)
             RetArr(RetArr.size) = rs.value("t_fiid");
             return CM_MSEL_CONT_CLEAR;
          end;
        elif ((cmd == DLG_KEY)and(key == K_ENTER))
           RetArr(RetArr.size) = rs.value("t_fiid");
           return CM_SELECT;
        end;
        if (f) return CM_SELECT; end;
        return CM_DEFAULT;
   end;

   var col1 = TArray;   
   var arnum = -1;
   AddCol (col1, arnum=arnum+1, "iso",    "Код",        8 ,  0,0);
   AddCol (col1, arnum=arnum+1, "t_name", "Наименование", 20 ,  0,0);
   var cmd1 = 
     " select t_fiid, decode(t_iso_number,'643','810',t_iso_number) iso, t_name from dfininstr_dbt where t_fi_kind = 1 order by t_fiid "; 

   cmd1 = RSDCommand(cmd1);
   var rs1 = RSDRecordset(cmd1 , null, RSDVAL_STATIC );
   RunScroll (rs1,col1.size/6, col1, "test1" ,"EvProcMultiSelect","Выбрать валюту счета"," Выбрать валюту. Enter - открыть счета по одной валюте. F2 - открыть счета по выделенным валютам", true, 5, 5);

   return RetArr;
end;

// Найти, существует ли такой счет 
private macro FindAcc(caregory, currency, contrid, accrec, dateACCOUNT)
   var accfile = TBFile("account.dbt", "r", 0);

   var Dt = TRsbDataSet("select d.t_Account " +
                        "  from dmccateg_dbt cat, dmcaccdoc_dbt d, daccount_dbt ac " +
                        " where cat.t_LevelType = 1 " +
                        "   and cat.t_Code = '" + caregory + "' " +
                        "   and d.t_CatID = cat.t_ID " +
                        "   and d.t_ClientContrID = " + contrid + 
                        "   and d.t_Currency = " + currency +
                        "   and (d.t_DisablingDate = to_date('01.01.0001','DD.MM.YYYY') or d.t_DisablingDate > " + GetSqlDate(dateACCOUNT) + ") " +
                        "   and ac.t_Account = d.t_Account " +
                        "   and ac.t_Chapter = d.t_Chapter " +
                        "   and ac.t_Code_Currency = d.t_Currency " +
                        "   and ac.t_Open_Date <= " + GetSqlDate(dateACCOUNT) +
                        "   and (ac.t_Close_Date = to_date('01.01.0001','DD.MM.YYYY') or ac.t_Close_Date >= " + GetSqlDate(dateACCOUNT) + ") "
                       );
   Dt.movenext();
   accfile.rec.chapter = 1;
   accfile.rec.account = Dt.account;
   accfile.rec.code_currency = currency;

   if (accfile.getEQ())
     copy(accrec, accfile);
   else
     accrec.rec.account = "";
     accrec.rec.code_currency = currency;
   end;
end;

/*DEF-22306*/
private macro UpdateDateOpenAcc(acc, currency, newdateopen)

   var sql = 
   "DECLARE " +
   "   acc       VARCHAR2 (20) := '"+acc+"'; " +
   "   fiid   NUMBER (10) := "+currency+"; " +
   "   new_date DATE := " +GetSQLDate(newdateopen)+ ";" +
   "BEGIN " +
    "   UPDATE daccount_dbt ac  " +
   "         SET AC.T_OPEN_DATE = new_date, AC.T_USERFIELD1 = AC.T_OPEN_DATE " +
   "    WHERE     ac.t_Account = acc AND ac.t_Code_Currency = fiid AND t_Chapter = 1;" +
    "END; " ;
   SQl_Execute(sql);
   return true;
OnError(e);
  return false;
end;
/*DEF-22306*/

// Открыть счет для субдоговора 
private macro usrIntgr_ОткрытьСубсчетДляСубдоговора(category:string, SubContrID:integer, Currency:integer, AccAddr, ErrStr, _dateED)
  var FD = DL_SubContrFD(SubContrID);
  record ClientAcc( account );
  var accrec = TRecHandler("account.dbt");
  var err = 0;
  var datesub;
  var sql1;

  datesub = FD.GetSubContr().rec.DateBegin;
  if (ValType(_dateED) == V_DATE)
     datesub = _dateED;
  end;

  ClearRecord(ClientAcc);

  if(false == FD.RecreateAccount( category, NULL, true, ClientAcc, datesub, Currency )) /*нужно при смене резидентства*/
    ErrStr = "Ошибка при актуализации счета по категории " + category;
    err = 1;
  end;

  if(false == FD.OpenAccount( category, NULL, NULL, ClientAcc, datesub, Currency, datesub ))
    ErrStr = "Ошибка при открытии счета по категории " + category;
    err = 1;
  end;
  println(clientacc.account);
  if(not err)
    var cmd, DataSet;
    var cmd1, DataSet1;

    cmd = DL_RSDCommand(  "select * from daccount_dbt"
                        + " where t_Account = ? "
                        + "   and t_Code_Currency = ? "
                        + "   and t_Chapter = ?"
                       ); 
    cmd.AddParam(ClientAcc.Account);
    cmd.AddParam(ClientAcc.Code_Currency);
    cmd.AddParam(ClientAcc.Chapter);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
/*DEF-22306*/
      if (DataSet.open_date != datesub) 
         UpdateDateOpenAcc(DataSet.Account, DataSet.Code_Currency, datesub);
         
         cmd1 = DL_RSDCommand(  "select * from daccount_dbt"
                        + " where t_Account = ? "
                        + "   and t_Code_Currency = ? "
                        + "   and t_Chapter = ?"
                       ); 
         cmd1.AddParam(DataSet.Account);
         cmd1.AddParam(DataSet.Code_Currency);
         cmd1.AddParam(DataSet.Chapter);

         DataSet1 = cmd1.Execute();
         if(DataSet1.moveNext())
           DataSet1.GetRecord().CopyTo( accrec.rec );
           SetParm(3, accrec);
         else
           err = 1;
         end;
      else
         DataSet.GetRecord().CopyTo( accrec.rec );
         SetParm(3, accrec);
      end;
/**/      
    else
      err = 1;
    end;
  end;

  SetParm(4, ErrStr);
  return err;
end;

// наименование длинное или короткое
private macro GetPartyName(_partyid, _isshort)
   var res = NULL;
   var sql_str, cmd, rs;
   sql_str = " select t_shortname, t_name "+
             " from dparty_dbt where t_partyid = :partyid";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("partyid", RSDBP_IN, _partyid);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      if (_isshort)
         res = rs.value("t_shortname");
      else
         res = rs.value("t_name");
      end;
   end;
   rs.close; cmd.close; rs = NULL; cmd = NULL;
   return res;
end;


// Привязка счета к субдоговору
private macro AddAccToSubContr(category, contractid, accrec, errstr)
   var stat = 0, cmd, rs, sqltext, servkind, partyid, bankid, order;
   var cmd2, DataSet;
   var bank_code;
   
   record sfspi("sfspiins.rec");
   ClearRecord(sfspi);

   sqltext = "select s.* from dsettacc_dbt a, dsfssi_dbt s  where t_account = ? and s.t_setaccid = a.t_settaccid and s.t_objecttype = 659 and t_objectid = ?";
   cmd = RsdCommand(sqltext);
   cmd.AddParam("", RSDBP_IN, accrec.rec.account);
   cmd.AddParam("", RSDBP_IN, contractid);
   cmd.Execute();
   rs = RsdRecordset(cmd);
   if (rs and rs.MoveNext())
      return 0;
   end;
   
   sqltext = "select t_servkind from dsfcontr_dbt where t_id = ?";
   cmd = RsdCommand(sqltext);
   cmd.AddParam("", RSDBP_IN, contractid);
   cmd.Execute();
   rs = RsdRecordset(cmd);
   if (rs and rs.MoveNext())
      servkind= rs.value(0);
   else
      SetParm(2, string("Нет данных о договоре ID = ", contractid));
      return -1;
   end;

   sqltext = "select c.t_partyid, "
             "       d.t_partyid "
             "  from dsfcontr_dbt c, "
             "       ddp_dep_dbt d "
             " where d.t_code = c.t_department "
             "   and c.t_id = ?";
   cmd = RsdCommand(sqltext);
   cmd.AddParam("", RSDBP_IN, contractid);
   cmd.Execute();
   rs = RsdRecordset(cmd);
   if (rs and rs.MoveNext())
      partyid = rs.value(0);
      bankid = rs.value(1);
   else
      SetParm(2, string("Нет данных о субъекте и/или банке по договору ID = ", contractid));
      return -1;
   end;

   sqltext = "select to_char(nvl(max(t_order), 0) + 1) "
             " from dsfssi_dbt where t_objecttype = 659 "+
             "  and t_objectid = lpad(?, 10, chr(48))";
   cmd = RsdCommand(sqltext);
   cmd.AddParam("", RSDBP_IN, contractid);
   cmd.Execute();
   rs = RsdRecordset(cmd);
   if (rs and rs.MoveNext())
      order = rs.value(0);
   else
      order = 1;
   end;
   
   cmd = RsdCommand(sqltext);
   cmd.AddParam("1", RSDBP_IN, partyid);
   cmd.AddParam("2", RSDBP_IN, partyid);
   cmd.AddParam("3", RSDBP_IN, bankid);
   cmd.AddParam("4", RSDBP_IN, partyid);
   cmd.AddParam("5", RSDBP_IN, bankid);
   cmd.Execute();
   rs = RsdRecordset(cmd);
   if ( (not (rs and rs.MoveNext())) )
      SetParm(2, string("Нет данных о субъекте и/или банке по договору ID = ", contractid));
      return -1;
   end;
   
   sfspi.ServiceKind      = servkind;
   sfspi.Order            = order;
   sfspi.FeeType          = 0;
   sfspi.FeeNumber        = 0;
   sfspi.FIID             = accrec.rec.code_currency;
   sfspi.Branch           = 0;
   if (category == CATEG_SUBCONTRACT)
      sfspi.ShortName        = "ДС клиента";
   elif (category == CATEG_SUBCONTRACT_COM)
      sfspi.ShortName        = "Расчеты по комиссии";
   else
      sfspi.ShortName        = order;
   end;
   sfspi.RecName          = GetPartyName(partyid, true);
   sfspi.CodeKind         = PTCK_CONTR;
   sfspi.Code             = GetPartyCode_ByNumber(partyid, PTCK_CONTR);
   sfspi.INN              = GetPartyCode_ByNumber(partyid, PTCK_INN);;
   sfspi.Account          = accrec.rec.account;
   sfspi.Chapter          = accrec.rec.chapter;
   sfspi.BankID           = bankid;
   sfspi.BankName         = GetPartyName(bankid, true);
   bank_code = GetPartyCode_ByNumber(bankid, PTCK_BIC);
   if (bank_code)
      sfspi.BankCodeKind     = PTCK_BIC ;
      sfspi.BankCode         = GetPartyCode_ByNumber(bankid, PTCK_BIC);
   else
      sfspi.BankCodeKind     = PTCK_SWIFT ;
      sfspi.BankCode         = GetPartyCode_ByNumber(bankid, PTCK_SWIFT);
   end;
   sfspi.CorrAcc          = "";
   sfspi.BankCorrName     = "";
   sfspi.BankCorrCodeKind = 3;
   sfspi.BankCorrCode     = "";
   sfspi.BankCorrID       = -1;
   sfspi.NoAccept         = "";
   sfspi.Description      = sfspi.ShortName;

   stat = SFSaveSfSSI(contractid, sfspi);
   if (stat != 0)
      SetParm(2, GetErrMsg());
   end;

   if (category == CATEG_SUBCONTRACT)
      cmd2 = DL_RSDCommand("SELECT T_ID " +
                           "  FROM DDLCONTRACC_DBT " +
                           " WHERE T_DLCONTRID = (select t_dlcontrid from ddlcontrmp_dbt where t_sfcontrid = ?) " +
                           "   AND T_ACCOUNTID = ? " +
                           "   AND T_MPID = (select t_id from ddlcontrmp_dbt where t_sfcontrid = ?) " +
                           "   AND T_FIID = ? ");
      cmd2.AddParam(contractid);
      cmd2.AddParam(accrec.rec.accountid);
      cmd2.AddParam(contractid);
      cmd2.AddParam(accrec.rec.code_currency);

      DataSet = cmd2.Execute();
      if(not DataSet.moveNext())
         sqltext = 
         "Insert into DDLCONTRACC_DBT           " +
         " (T_ID, T_DLCONTRID, T_ACCOUNTID, T_VERSION, T_MPID, " +
         "  T_FIID)                                            " +
         " Values                                              " +
         " (0, (select t_dlcontrid from ddlcontrmp_dbt where t_sfcontrid = ?), ?, null, (select t_id from ddlcontrmp_dbt where t_sfcontrid = ?), ?);";
         cmd = RsdCommand(sqltext);
         cmd.AddParam("", RSDBP_IN, contractid);
         cmd.AddParam("", RSDBP_IN, accrec.rec.accountid);
         cmd.AddParam("", RSDBP_IN, contractid);
         cmd.AddParam("", RSDBP_IN, accrec.rec.code_currency);
         cmd.Execute();
      end;
   end;

   return stat;
end;

private macro DeleteBindAccWithSPI(contrid, currency, acc, dateED):bool

   var sql = 
   "DECLARE " +
   "   contrid   NUMBER (10) := "+contrid+"; " +
   "   acc       VARCHAR2 (20) := '"+acc+"'; " +
   "   fiid   NUMBER (10) := "+currency+"; " +
   "   curdate DATE := " +GetSQLDate(dateED)+ ";" +
   "BEGIN " +
   "   DELETE " +
   "     FROM dsettacc_dbt t " +
   "    WHERE t_settaccid IN " +
   "             (SELECT t_setaccid " +
   "                FROM dsfssi_dbt " +
   "               WHERE t_fiid = fiid AND t_objecttype = 659 AND t_objectid = LPAD (contrid, 10, '0')); " +
   " " +
   "   DELETE " +
   "     FROM dpmautoac_dbt " +
   "    WHERE t_settaccid IN " + /*pnv DEF-22306*/
   "             (SELECT t_setaccid " +
   "                FROM dsfssi_dbt " +
   "               WHERE t_fiid = fiid AND t_objecttype = 659 AND t_objectid = LPAD (contrid, 10, '0')); " +
   " " +
   "   DELETE " +
   "     FROM dsfssi_dbt " +
   "    WHERE t_objecttype = 659 AND t_fiid = fiid AND t_objectid = LPAD (contrid, 10, '0'); " +
   " " +
   "     UPDATE dmcaccdoc_dbt " +
   "        SET t_iscommon = chr(0), t_disablingdate = curdate " + /*иначе с этим счетом не выгрузится проводка, связку удалять нельзя, iscommon сбрасываем чтоб нигде функционал не отломался*/
   "    WHERE t_clientcontrid = contrid AND t_catnum = 201 AND t_currency = fiid and t_account = acc; " +
   " " +
   "   DELETE " +
   "     FROM dpmautoac_dbt " +
   "    WHERE t_settaccid IN (SELECT T.T_SETTACCID " +
   "                            FROM dsettacc_dbt t " +
   "                           WHERE     t_partyid = (SELECT t_partyid " +
   "                                                    FROM dsfcontr_dbt " +
   "                                                   WHERE t_id = contrid) " +
   "                                 AND t_fiid = fiid " +
   "                                 AND t_account = acc); " +
   " " +
   "   DELETE " +
   "     FROM dsettacc_dbt " +
   "    WHERE     t_partyid = (SELECT t_partyid " +
   "                             FROM dsfcontr_dbt " +
   "                            WHERE t_id = contrid) " +
   "          AND t_fiid = fiid " +
   "          AND t_account = acc; " +
   /*DEF-22306: Укажем дату закрытия  и призна закрытия счета, иначе при попытке переоткрыть счет он "открывается" той же датой, что и был открыт  */
  // "   UPDATE daccount_dbt ac  " +
  // "         SET AC.T_CLOSE_DATE = curdate, AC.T_OPEN_CLOSE = CHR (135) " +
  // "    WHERE     ac.t_Account = acc AND ac.t_Code_Currency = 0 AND t_Chapter = 1;" +
   /**/
   "END; " ;
   SQl_Execute(sql);
   return true;
OnError(e);
  return false;
end;

// Прекращение действия привязки счета к КУ
private macro DeleteBindAcc(category, contrid, currency, acc, dateED):bool
   var sql = " UPDATE dmcaccdoc_dbt " +
             "    SET t_isusable = chr(0), t_iscommon = chr(0), t_disablingdate = "+GetSQLDate(dateED)+
             "  WHERE t_clientcontrid = "+contrid+
             "    AND t_catid = (SELECT t_ID FROM dmccateg_dbt WHERE t_LevelType = 1 AND t_Code = '"+category+"') "+
             "    AND t_currency = "+currency+
             "    AND t_account = "+acc;
   SQl_Execute(sql);
   return true;
OnError(e);
  return false;
end;

// Открыть и привязать счет к договору
private macro OpenAccAndBindToContract(category, contractid, currency, accnumber, error, _dateED, askReopen):integer
   var stat, errstr;
   var accrec = TRecHandler("account.dbt");
   var dt = TRsbDataSet("select t_ccy from dfininstr_dbt where t_fiid = " + currency);
   Dt.movenext();
   var currccy = dt.ccy;
   var askReopenText:string = "";
    
   if((category == CATEG_SUBCONTRACT) or (category == CATEG_SUBCONTRACT_DEBT) or (category == CATEG_SUBCONTRACT_DEBT_RESERVE))
      // поиск и заполнение структуры
      FindAcc(category, currency, contractid, accrec, _dateED);
      if(accrec.rec.accountid != 0)
         /*предложим удалить все старые привязки, тогда дальнейший код все переоткроет и привяжет заново. */
         /* При этом по мигрированным договорам откроется новый счет, по новым сгенерируется точно такой как и был и привяжется заново. */
         /* если же по клиенту изменился признак резидентства, то счет так же откроется новый */
         if(askReopen)
            if(category == CATEG_SUBCONTRACT_DEBT_RESERVE)
               askReopenText = "По данному рынку и валюте "+currccy+" уже есть привязанный счет " +accrec.rec.account+". Счета по данной КУ не предполагают переоткрытия. | Всё равно удалить все привязки и переоткрыть счет?";
            else
               askReopenText = "По данному рынку и валюте "+currccy+" уже есть привязанный счет " +accrec.rec.account+". | Удалить все привязки и переоткрыть счет?";
            end;
            if(not GetTrue(false, askReopenText))
               return -1; //Особым образом пометим отказ от переоткрытия, чтобы не пытаться переоткрыть этот же счет по другим связанным субдоговорам
            end;
         end;

         if(category == CATEG_SUBCONTRACT)
            /*Удалить СПИ с ДО, удалить СПИ и параметры выбора СПИ с клиента, удалить привязку с КУ*/
            if (not DeleteBindAccWithSPI(contractid, currency, accrec.rec.account, _dateED))
               SetParm(4,"Ошибка отвязки счета");
               return 1;
            end; 
         else
            /*Закрыть привязку с КУ*/
            if (not DeleteBindAcc(category, contractid, currency, accrec.rec.account, _dateED))
               SetParm(4,"Ошибка отвязки счета");
               return 1;
            end; 
         end;
      end;
   end;
   //открытие счета
   stat = usrIntgr_ОткрытьСубсчетДляСубдоговора(category, contractid, currency, accrec, errstr, _dateED);

   if (stat != 0)
      SetParm(4,errstr);
      return stat;
   end;

   if (category == CATEG_SUBCONTRACT)
      //привязка счета к договору
      stat = AddAccToSubContr(category, contractid, accrec, errstr);
      if (stat != 0)
         SetParm(4, errstr);
      end;
   end;

   return stat;
end;

macro OpenAllAccounts(_sub_id, _fiid_sub, _AgreementDate)
   private var stat, err_txt;
   private var v_AgreementDate = _AgreementDate;

   BegAction(1000, "Открытие счетов");
   stat = OpenAccAndBindToContract(CATEG_SUBCONTRACT, _sub_id, _fiid_sub, "", err_txt, v_AgreementDate, true);
   if(stat > 0)
      RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
   end;
   stat = OpenAccAndBindToContract(CATEG_SUBCONTRACT_COM, _sub_id, _fiid_sub, "", err_txt, v_AgreementDate);
   if(stat > 0)
      RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
   end;
   stat = OpenAccAndBindToContract(CATEG_SUBCONTRACT_VU, _sub_id, _fiid_sub, "", err_txt, v_AgreementDate);
   if(stat > 0)
      RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
   end;
   stat = OpenAccAndBindToContract(CATEG_SUBCONTRACT_VU_CALC, _sub_id, _fiid_sub, "", err_txt, v_AgreementDate);
   if(stat > 0)
      RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
   end;
   EndAction;

OnError(e)
   EndAction;
end;

macro OpenDebtAccount(_categ, _sub_id, _fiid_sub, _AgreementDate, _isEDP)
   private var stat, err_txt, cmd2, DataSet;
   var flag:bool = true; // Признак необходимости вывода пользователю уточняющих сообщений (выводим их только для первого субдоговора) 

   BegAction(1000, "Открытие счетов");
   if(_isEDP)
      cmd2 = DL_RSDCommand("SELECT sf.t_ID " +
                           "  FROM ddlcontrmp_dbt mp1, ddlcontrmp_dbt mp, dsfcontr_dbt sf " +
                           " WHERE mp1.t_SfContrID = ? " +
                           "   AND mp.t_DlContrID = mp1.t_DlContrID " +
                           "   AND sf.t_ID = mp.t_SfContrID " +
                           "   AND sf.t_ServKindSub <> 9 " +
                           "   AND sf.t_DateClose = TO_DATE('01.01.0001', 'DD.MM.YYYY') ");
      cmd2.AddParam(_sub_id);
      
      DataSet = cmd2.Execute();
      while(DataSet.moveNext())
         stat = OpenAccAndBindToContract(_categ, DataSet.ID, _fiid_sub, "", err_txt, _AgreementDate, flag);
         if(stat > 0)
            RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
         elif(stat == -1)
            break; //Если операционист отказался от переоткрытия, не пытаться переоткрыть этот же счет по другим субдоговорам
         end;
         flag = false;
      end;
   else
      stat = OpenAccAndBindToContract(_categ, _sub_id, _fiid_sub, "", err_txt, _AgreementDate, flag);
      if(stat > 0)
         RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
      end;
   end;
   EndAction;

OnError(e)
   EndAction;
end;

private var dat = {curdate};

macro OpenAccountsByDlContr(dlcontrid)
   var cmd1, rs1, col1, need = true,Column = TArray(),i, ColumnValue, ColumnName, NumColumns = 0, cond = "";
   macro EvProc2(rs, cmd, id, key)
     var  CM_DEFAULT = null;
     if ((cmd == DLG_KEY)and(key == K_ENTER))
        if (rs.RecCount > 0)
          return CM_SELECT;
        end;
     end;
     return CM_DEFAULT;
  end;

   macro EvProc(rs, cmd, id, key)
     var CM_DEFAULT = null, i;
     var sfcontrid:integer = -1;
     var servkind, servkindsub, partyid;
     var curr = TArray();
     var dt:date;
     var cmd2, Query, DataSet;
     private var v_acc_trn_menu = TArray;
     private var v_choice;

     if ((cmd == DLG_KEY)and(key == K_ENTER))
     elif ((cmd == DLG_KEY)and(key == K_F9))
        sfcontrid = GetSfcontr(dlcontrid, @servkind, @servkindsub, @partyid); // вывести список договоров к выбору
        // запросить валюту
        if (sfcontrid != -1)
           curr.size = 0; i = 0;
           dt = {curdate};
           if(GetDate(dt, "Дата открытия счетов"))            
              if (servkind == 1) 
                 curr = GetCurrency(sfcontrid); //массив
                 //дооткрыть недостающие
                 for (i, curr)
                    OpenAllAccounts( sfcontrid, i, dt ) 
                 end;
              elif (servkind == 15)/*срочный = только рубли всегда*/
                 if (OpenAllAccounts( sfcontrid, NATCUR, dt ) )
                 end;
              elif (servkind == 21)/*валютный - всегда пять валют*/
                 var stat = 0;
                 var AllCurStr;
            
                 var RegistryPath = IIF(IsPartyInst(partyid), "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\СПИСОК_ВАЛЮТ_ЮР_ЛИЦ","РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\СПИСОК_ВАЛЮТ");
                 GetRegistryValue(RegistryPath, V_STRING, AllCurStr, stat);
            
                 if((stat != 0)  or (AllCurStr == "")) 
                    msgbox("Ошибка при получении значения настройки:|", RegistryPath);
            
                    curr(curr.size) = 0;
                    curr(curr.size) = 7;
                    curr(curr.size) = 8;
                    curr(curr.size) = 19;
                    curr(curr.size) = 20;
                    curr(curr.size) = 11;
                    for (i, curr)
                       OpenAllAccounts( sfcontrid, i, dt ) 
                    end;
                 else
                    Query =    " SELECT fin.t_fiid  "
                              + "   FROM  dfininstr_dbt fin,   "
                              + "    (SELECT REGEXP_SUBSTR ('"+AllCurStr+"', '[^,]+', 1,  LEVEL) CCY  "
                              + "      FROM DUAL     "
                              + "     CONNECT BY INSTR ('"+AllCurStr+"',  ',', 1, LEVEL - 1) > 0) q  "
                              + "  WHERE UPPER (fin.t_CCY) = TRIM(UPPER (q.CCY)) ";              
                    cmd2 = DL_RSDCommand(Query);
            
                    DataSet = cmd2.Execute();
                    while(DataSet.moveNext())
                       OpenAllAccounts( sfcontrid, DataSet.t_fiid, dt ) 
                    end;
                    DataSet = NULL; cmd2 = NULL;
                 end;     
              else
                 curr = GetCurrency(sfcontrid);
                 for (i, curr)
                    OpenAllAccounts( sfcontrid, i, dt ) 
                 end;
              end;
           end;
        end;
        need = true;
        return 2;

     elif ((cmd == DLG_KEY)and(key == K_ALT_F9))
        v_acc_trn_menu.value(C_OPEN_ACC_DEBT) = "Открытие счета просроченной задолженности";
        v_acc_trn_menu.value(C_OPEN_ACC_DEBT_RESERVE) = "Открытие счета резерва по просроченной задолженности (не ПОТ)";
       
        v_choice = menu(v_acc_trn_menu, "Выберите действие", "Выберите действие");
        if(v_choice >= 0)
           sfcontrid = GetSfcontr(dlcontrid, @servkind, @servkindsub, @partyid); // вывести список договоров к выбору
           if(sfcontrid != -1)
              dt = {curdate};
              if(GetDate(dt, "Дата открытия счетов"))
                 var categ:string = "";
                 curr.size = 0; i = 0;
                 if(v_choice == C_OPEN_ACC_DEBT)
                    curr = GetCurrency(sfcontrid); // выбор валюты
                    categ = CATEG_SUBCONTRACT_DEBT;
                 elif(v_choice == C_OPEN_ACC_DEBT_RESERVE)
                    curr(curr.size) = NATCUR;
                    categ = CATEG_SUBCONTRACT_DEBT_RESERVE;
                 end;
               
                 var isEDP:bool = (servkindsub != 9) and ДоговорЕДП(null, sfcontrid);
                 for(i, curr)
                    OpenDebtAccount(categ, sfcontrid, i, dt, isEDP);
                 end;
              end;
           end;
        end;
        need = true;
        return 2;

     elif ((cmd == DLG_KEY)and(key == K_F5))
        GetDate(dat, "Дата остатков");
        need = true;
        return 2;

     elif ((cmd == DLG_KEY)and(key == K_F6)) // DEF-35275
        if (rs.Value("k") == 3)/*Ценные бумаги*/
           var dat = {curdate}, CatErr, usrMsg;
           if (rs.Value("block") == "X")
              if (GetTrue(false, "Установлена блокировка на Ценной бумаге. Установить Индивидуальную блокировку по Счету ВУ ? |"+
                                 "(Снятие общей блокировки производится в справочнике Ценных бумаг)"))
                if (GetDate(dat, "Укажите дату начала действия блокировки"))
                  if( (not DisconnectObjAttr( 4, rs.Value("AccObjID"), 102, null, dat )) 
                     OR
                     (not ConnectObjAttr( CatErr, 4, rs.Value("AccObjID"), 102, 1, null, null, dat )) 
                     OR
                     (CatErr != 0)
                    )
                     msgbox("Ошибка при установке категории " );
                  end;
                end;
              end;
           elif (rs.Value("block") == "И")
              if (GetTrue(false, "Снять блокировку по выпуску для расчета лимитов по клиенту? "))
                 if (GetDate(dat, "Укажите дату снятия блокировки"))
                    if (not DisconnectObjAttr( 4, rs.Value("AccObjID"), 102, null, dat )) 
                       msgbox("Ошибка при снятии признака " );
                    end;
                 end;
              end;
           else
              if (GetTrue(false, "Установить блокировку по выпуску для расчета лимитов по клиенту? "))
                 if (GetDate(dat, "Укажите дату начала действия блокировки"))
                    if( (not DisconnectObjAttr( 4, rs.Value("AccObjID"), 102, null, dat )) 
                       OR
                       (not ConnectObjAttr( CatErr, 4, rs.Value("AccObjID"), 102, 1, null, null, dat )) 
                       OR
                       (CatErr != 0)
                      )
                       msgbox("Ошибка при установке категории " );
                    end;
                 end;
              end;
           end;
        end;
        need = true;
        return 2;

/*zy  Добавлена возможность закрытия одного из 306 счетов без закрытия договора*/
     elif ((cmd == DLG_KEY)and(key == K_F8))
         if (substr(rs.value(3), 1,3) !="306")
            msgbox ("Закрывать можно только 306* счета");
         else
            var err, log, item, StrLog = "";
            var ca = CCloseContrAccountsSingle(dlcontrid, rs.value(3));
            if ( ca.CloseAcc(@err, @log) > 0 )
               for ( item, err )
                  if ( item.rest != 0 )
                     StrLog = StrLog + item.err + " " + item.acc + "   " + item.rest + "\n";
                  else
                     StrLog = StrLog + item.acc + "   " + item.err + "\n";
                  end;
               end;
      
               MsgBox("Невозможно закрыть счет" + StrLog);
      
            elif (log.size > 0)
               for ( item, log )
                  StrLog = StrLog + item.acc + "   " + item.err + "\n";
               end;
               MsgBox(StrLog);
            end;
           end;
           need = true;
           return 2;

     elif ((cmd == DLG_KEY)and(key == 18))
        cond = "";
        need = true;
        return 2;
     elif ((cmd == DLG_KEY)and(key == K_ESC))
        return 2;
     end;

     return CM_DEFAULT;
   end;

   col1 = TArray;   
   var arnum = -1;
   AddCol (col1, arnum=arnum+1, "servkindsub",   "Вид",        8 ,  0,0);
   AddCol (col1, arnum=arnum+1, "t_number",      "Субдоговор", 8 ,  0,0);
   AddCol (col1, arnum=arnum+1, "t_account",     "Счет",       20,  0,0);
   AddCol (col1, arnum=arnum+1, "t_open_date",   "Дата открытия счета",   8, 0);
   AddCol (col1, arnum=arnum+1, "block",         "Б",     3, 0);
   AddCol (col1, arnum=arnum+1, "curr",          "Валюта",     10, 0);
   AddCol (col1, arnum=arnum+1, "rest",          "Текущий остаток",     10, 0);
   AddCol (col1, arnum=arnum+1, "t_nameaccount", "Наименование счета",    35, 0);
   AddCol (col1, arnum=arnum+1, "catname",       "Категория",  12, 0);
   AddCol (col1, arnum=arnum+1, "t_open_close",  "Состояние",  12, 0);
   AddCol (col1, arnum=arnum+1, "t_close_date",  "Дата закрытия",  8, 0);
   dat = {curdate};

   while (need)
      need = false;
      cmd1 = 

" SELECT k, servkindsub,t_number,t_account,t_open_date,curr,block,rest,t_nameaccount,catname, t_chapter, t_catnum, t_currency, t_open_close, t_close_date, AccObjID          "+
"   FROM ( (SELECT *                                                                                                                                                         "+
"             FROM (  SELECT 1 k,t.t_servkindsub,                                                                                                                            "+
"                            DECODE (t.t_servkindsub,8, 'Биржа',9, 'Внебиржа',' ')servkindsub,                                                                               "+
"                            ac.t_account,to_char(t_open_date, 'dd.mm.yyyy') t_open_date, chr(1) block,                                                                      "+
"                            (SELECT DECODE (t_fi_kind,1, DECODE (t_iso_number,'643', '810',t_iso_number),t_name)                                                            "+
"                               FROM dfininstr_dbt WHERE t_fiid = ac.t_currency) curr,                                                                                       "+
"                            RSB_ACCOUNT.RESTALL (ac.t_account,ac.t_chapter,ac.t_currency, ?)rest,                                                                           "+
"                            t.t_number,a.t_nameaccount,ac.t_catnum,ac.t_templnum,ac.t_chapter,                                                                              "+
"                            (SELECT t_code FROM dmccateg_dbt WHERE t_id = ac.t_catid) catname,                                                                              "+
"                            ac.t_currency,                                                                                                                                  "+
"                            decode(a.T_OPEN_CLOSE, 'З', 'Закрыт', 'Открыт') t_open_close,                                                                                   "+
"                            decode(a.T_CLOSE_DATE, to_date('01010001', 'ddmmyyyy'), null, a.t_close_date) t_close_date,                                                     "+                                     
"                            TO_CHAR( a.t_chapter, 'FM0x' ) || TO_CHAR( a.t_code_currency, 'FM0xxxxxx' ) || a.t_account  AccObjID                                            "+                                   
"                       FROM ddlcontrmp_dbt mp, dsfcontr_dbt t                                                                                                               "+
"                               LEFT JOIN dmcaccdoc_dbt ac                                                                                                                   "+
"                               ON     ac.t_clientcontrid = t.t_id                                                                                                           "+
"                               AND    ac.t_owner = t.t_partyid                                                                                                              "+
"                                  AND ac.t_iscommon = CHR (88)                                                                                                              "+
"                               AND ac.t_catid IN (SELECT t_id                                                                                                               "+
"                                                    FROM dmccateg_dbt                                                                                                       "+
"                                                   WHERE t_leveltype = 1                                                                                                    "+
"                                                     AND t_code IN ('"+CATEG_SUBCONTRACT+"','"+CATEG_SUBCONTRACT_VU_CALC+"','"+CATEG_SUBCONTRACT_SECUR_VU_CALC+"',          "+
"                                                                    '"+CATEG_SUBCONTRACT_COM+"','"+CATEG_SUBCONTRACT_DEBT+"','"+CATEG_SUBCONTRACT_DEBT_RESERVE+"')          "+
"                                                 )                                                                                                                          "+
"                            LEFT JOIN daccount_dbt a                                                                                                                        "+
"                            ON     ac.t_chapter = a.t_chapter                                                                                                               "+
"                               AND ac.t_currency = a.t_code_currency                                                                                                        "+
"                               AND ac.t_account = a.t_account                                                                                                               "+
"                      WHERE     t.t_id = mp.t_sfcontrid                                                                                                                     "+
"                            AND mp.t_dlcontrid = ?                                                                                                                          "+
"                            AND (SELECT t_fi_kind                                                                                                                           "+
"                                   FROM dfininstr_dbt                                                                                                                       "+
"                                  WHERE t_fiid = a.t_code_currency) = 1                                                                                                     "+
"                   ORDER BY t.t_number, ac.t_chapter, ac.t_currency, ac.t_catnum)                                                                                           "+
"           UNION ALL                                                                                                                                                        "+
"           SELECT 0,NULL,NULL,'Денежные средства',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,null,null,null,null FROM DUAL                                           "+
"           UNION ALL                                                                                                                                                        "+
"           SELECT 2,NULL,NULL,'Ценные бумаги',    NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,null,null,null,null FROM DUAL                                           "+
"           UNION ALL                                                                                                                                                        "+
"           SELECT *                                                                                                                                                         "+
"             FROM (  SELECT 3,t.t_servkindsub,                                                                                                                              "+
"                            DECODE (t.t_servkindsub,8, 'Биржа',9, 'Внебиржа',' ') servkindsub,                                                                              "+
"                            ac.t_account, to_char(t_open_date, 'dd.mm.yyyy') t_open_date,                                                                                   "+
"                            CASE                                                                                                                                            "+
"                                    WHEN RSB_SECUR.                                                                                                                         "+
"                                          GetGeneralMainObjAttr (                                                                                                           "+
"                                            4,                                                                                                                              "+
"                                               TO_CHAR (a.t_chapter, 'FM0x')                                                                                                "+
"                                            || TO_CHAR (a.t_code_currency, 'FM0xxxxxx')                                                                                     "+
"                                            || a.t_account,                                                                                                                 "+
"                                            102,                                                                                                                            "+
"                                            ?) = 1                                                                                                                          "+
"                                    THEN                                                                                                                                    "+
"                                       CHR (136)                                                                                                                            "+
"                                    WHEN RSB_SECUR.                                                                                                                         "+
"                                          GetGeneralMainObjAttr (12,                                                                                                        "+
"                                                                 LPAD (a.t_code_currency, 10, '0'),                                                                         "+
"                                                                 129,                                                                                                       "+
"                                                                 ?) = 1                                                                                                     "+
"                                    THEN                                                                                                                                    "+
"                                       CHR (88)                                                                                                                             "+
"                                    ELSE                                                                                                                                    "+
"                                       CHR (0)                                                                                                                              "+
"                                 END                                                                                                                                        "+
"                                    block,                                                                                                                                  "+
"                            (SELECT DECODE (t_fi_kind,1, DECODE (t_iso_number,'643', '810',t_iso_number),t_name) FROM dfininstr_dbt  WHERE t_fiid = ac.t_currency) curr,    "+
"                            RSB_ACCOUNT.RESTALL (ac.t_account,ac.t_chapter,ac.t_currency, ?) rest,                                                                          "+
"                            t.t_number,a.t_nameaccount,ac.t_catnum,ac.t_templnum,ac.t_chapter,                                                                              "+
"                            (SELECT t_code FROM dmccateg_dbt WHERE t_id = ac.t_catid) catname,                                                                              "+
"                            ac.t_currency,                                                                                                                                  "+
"                            decode(a.T_OPEN_CLOSE, 'З', 'Закрыт', 'Открыт') t_open_close,                                                                                   "+
"                            decode(a.T_CLOSE_DATE, to_date('01010001', 'ddmmyyyy'), null, a.t_close_date) t_close_date,                                                     "+                                   
"                            TO_CHAR( a.t_chapter, 'FM0x' ) || TO_CHAR( a.t_code_currency, 'FM0xxxxxx' ) || a.t_account  AccObjID                                            "+                                   
"                       FROM ddlcontrmp_dbt mp,dsfcontr_dbt t                                                                                                                "+
"                            LEFT JOIN dmcaccdoc_dbt ac                                                                                                                      "+
"                            ON     ac.t_clientcontrid = t.t_id                                                                                                              "+
"                               AND ac.t_owner = t.t_partyid                                                                                                                 "+
"                               AND ac.t_iscommon = CHR (88)                                                                                                                 "+
"                               AND ac.t_catid IN (SELECT t_id                                                                                                               "+
"                                                    FROM dmccateg_dbt                                                                                                       "+
"                                                   WHERE t_leveltype = 1                                                                                                    "+
"                                                     AND t_code IN ('"+CATEG_SUBCONTRACT+"','"+CATEG_SUBCONTRACT_VU_CALC+"','"+CATEG_SUBCONTRACT_SECUR_VU_CALC+"',          "+
"                                                                    '"+CATEG_SUBCONTRACT_COM+"','"+CATEG_SUBCONTRACT_DEBT+"','"+CATEG_SUBCONTRACT_DEBT_RESERVE+"')          "+
"                                                 )                                                                                                                          "+
"                            LEFT JOIN daccount_dbt a                                                                                                                        "+
"                            ON     ac.t_chapter = a.t_chapter                                                                                                               "+
"                               AND ac.t_currency = a.t_code_currency                                                                                                        "+
"                               AND ac.t_account = a.t_account                                                                                                               "+
"                      WHERE     t.t_id = mp.t_sfcontrid                                                                                                                     "+
"                            AND mp.t_dlcontrid =  ?                                                                                                                         "+
"                            AND (SELECT t_fi_kind                                                                                                                           "+
"                                   FROM dfininstr_dbt                                                                                                                       "+
"                                  WHERE t_fiid = a.t_code_currency) = 2                                                                                                     "+
"                   ORDER BY t.t_number,ac.t_chapter,ac.t_currency,ac.t_catnum))                                                                                             "+
"         )        ORDER BY 1, t_number, t_chapter, t_catnum, t_currency                                                                                                     ";
      cmd1 = RSDCommand(cmd1);
      cmd1.addParam("", RSDBP_IN, dat);
      cmd1.addParam("", RSDBP_IN, dlcontrid);
      cmd1.addParam("", RSDBP_IN, dat);
      cmd1.addParam("", RSDBP_IN, dat);
      cmd1.addParam("", RSDBP_IN, dat);
      cmd1.addParam("", RSDBP_IN, dlcontrid);
      rs1 = RSDRecordset(cmd1 , null, RSDVAL_STATIC );

      RunScroll (rs1,col1.size/6, col1, "test" ,"EvProc"," Счета по договору " + string(dat:f)," F9 - Открыть счета F8 - Закрыть счета F5 - Выбрать дату остатка F6 - Блокир-ка по расч.лим. ALT-F9 - Открытие счетов просроченной задолженности/резерва", true, 1, 1);
   end;

return null;

end;