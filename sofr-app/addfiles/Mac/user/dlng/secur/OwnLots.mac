import RSD, globals;
import BankInter, dlquery, cb_sql, oralib, likepy;

const K_ENTER   = 13;
//const K_ESC     = 27;
const K_F3      = 317;
const K_F2      = 316;
const K_F8      = 322;
const K_F9      = 323;


PRIVATE MACRO AddCol (ar, fld, head, width, rdonly, ty, dp)
   var ind = ar.size;
   if (ind > 0) ind = ar.size / 6 ; end;
   ar.value (ind * 6)     = fld;
   ar.value (ind * 6 + 1) = head;
   ar.value (ind * 6 + 2) = width;
   ar.value (ind * 6 + 3 ) = 2;//rdonly;   // fldType
   ar.value (ind * 6 + 4 ) = dp;//   decPoint
   ar.value (ind * 6 + 5 ) = 0;   // reserv
END;

macro Scroll
   var sql, cmd1, rs1, col1, need = true,Column = TArray(),i, ColumnValue, ColumnName, NumColumns = 0, cond = "";

   var ErrAr = TArray(), inprocess, inprocessprogress, SaveNum = 0;

   macro EvProc(rs, cmd, id, key)
     var  CM_DEFAULT = null, err;
     
//msgbox(key);
      if (cmd == DLG_INIT)
      elif(cmd == DLG_MSELSTART)
      elif(cmd == DLG_MSELEND)
      elif(cmd == DLG_MSEL)
      elif ((cmd == DLG_KEY)and(key == K_F8)/* and ({oper} == 1)*/)
         return CM_IGNORE;
      elif ((cmd == DLG_KEY)and(key == 18))
      elif ((cmd == DLG_KEY)and(key == K_ESC))
         return 2;
      end;

     return CM_DEFAULT;
   end;

   col1 = TArray;   

  
   AddCol (col1, "T_DEALCODE",        "Сделка",   10 ,  2, -1);
  AddCol (col1,  "T_DEALDATE",        "Дата сделки",    10,  2, -1 );
   AddCol (col1,  "T_SUMID",  "Номер лота",    10,  2, -1);
   AddCol (col1,  "LotState",     " Статус лота",    10, 2, -1);
   AddCol (col1,  "T_DEFINITION",     "Ценная бумага ",   10 ,  2, -1);
   AddCol (col1,  "t_lsin",     " № гос. регистрации ",    10 ,  2, -1);
   AddCol (col1, "t_isin",        "ISIN",   12 ,  2, -1);
   AddCol (col1,  "T_AMOUNT",     "Кол-во ",    10 ,  2, -1);
   AddCol (col1,  "t_sum",     " Сумма ",   10 ,  2, -1);
   AddCol (col1, "T_BEGDISCOUNT",        "Начальный дисконт при разм.", 10 ,  2, -1);
   AddCol (col1,  "T_BEGDISCOUNTDATE",     "Дата дисконта ",     10 ,  2, -1);
   AddCol (col1,  "T_INTERESTINCOME",     " Входящий купон ",     10 ,  2, -1);
   AddCol (col1, "T_INTERESTDATE",        "Дата расч. вх. купона",    10 ,  2, -1);
  

   while (need)
      need = false;
 SQL = "/* Formatted on 18.02.2019 11:19:43 (QP5 v5.149.1003.31008) */ "
      + "SELECT  "
      + "PM.T_DEALCODE, "
      + "PM.T_DEALDATE, "
      + "PM.T_SUMID, "
      + "decode(pm.t_state,20,'Размещен',21,'Выкуплен',pm.t_state ) LotState, "
      + "FI.T_DEFINITION, "
      + "av.t_lsin, "
      + "av.t_isin, "
      + "PM.T_AMOUNT, "
      + "pm.t_sum, "
      + "PM.T_BEGDISCOUNT, "
      + "PM.T_BEGDISCOUNTDATE, "
      + "PM.T_INTERESTINCOME, "
      + "PM.T_INTERESTDATE  "
      + "  FROM DPMWRTSUM_DBT pm, dfininstr_dbt fi, davoiriss_dbt av "
      + " WHERE pm.t_fiid = fi.t_fiid "
      + "        AND fi.t_fiid = av.t_fiid "
      + "       AND RSI_RSB_FIInstr.FI_AvrKindsGetRoot (fi.t_fi_kind, fi.t_AvoirKind) = "
      + "              17 "
      + "       AND PM.T_PARTY = -1 "
      + "       AND pm.t_state IN (20, 21) order by av.t_lsin; ";



  /* var d = {curdate};
   if (GetDate(d, "Укажите дату открытия счетов. \n Нажмите Esc, чтобы посмотреть все счета"))
      sql = sql + " where t.t_open_date = " + GetSqlDate(d);
   end;
   sql = sql + "        order by t.t_open_date" ;*/

 
      cmd1 = RSDCommand(sql);
      rs1 = RSDRecordset(cmd1 , null, RSDVAL_STATIC );
      while (RunScroll (rs1,col1.size/6, col1, "test" ,"EvProc"," Лоты по собственным облигациям "," ", true, 1, 1))
        cmd1 = RSDCommand(sql);
        rs1 = RSDRecordset(cmd1 , null, RSDVAL_STATIC );
      end;
   end;

return null;

end;

Scroll;
exit(1);