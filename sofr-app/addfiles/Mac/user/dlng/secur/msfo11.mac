/*
$Name:        msfo11.mac
$Module:      Ценные бумаги
$Description: МСФО 11. Реест облигация, выпущенных на внутреннем рынке, и евроболигаций по состоянию на отчетную дату
$Programmer:  Кротов А.
*/
import msfo11_panel, ReportUser;
import captureoutput;
import "sud_utils.mac";
/*import spRepFun;*/
CONST OverValueDate = Date(31,12,2999);

private macro CheckValue(val:variant)
 private CONST v_SPECVAL = 26;

    if(valtype(val) == V_UNDEF)
        return 0;
    end;

    if(valtype(val) == v_SPECVAL)
        return 0;
    end;

    if(trim(string(val)) == "")
        return "";
    end;

    if(valtype(val) == v_DOUBLE)
       return money(val);
    end;

    return string(val);

end;//macro CheckValue

private macro getSSDays()
  var stateA, errCodeA, sRegValA;
  var statA = GetRegistryValue("SECUR\\МСФО\\СС_ДНЕЙ", V_INTEGER, sRegValA, errCodeA);
  if((statA == V_INTEGER) and (errCodeA == 0))
    return sRegValA;
  else
    msgbox("Не задана глубина поиска курсов|SECUR\\МСФО\\СС_ДНЕЙ");
    return "";
  end;
end;
var SSDays = getSSDays();


PRIVATE CLASS (TX_ReportUser) msfo11_Report
  var m_BeginDate;

  /*Создание отчета*/
  PRIVATE MACRO Create()

    /*Данные по купону*/
    macro GetWarrant(dt, fiid, DND:@date, DNDduration:@integer, OfferDate:@date, Rate:@double, RateOffer:@double, Period:@integer);
      var m_RS_w, m_cmd_w;
      /*Купон на дату dt*/
      StartCaptureOutput();
      [
        select fiwarnts.t_drawingdate t_drawingdate, 
               fiwarnts.t_drawingdate - dt t_drawingdur, 
               fiwarnts.t_incomerate t_incomerate
        from dfiwarnts_dbt fiwarnts
        join (select dt, t_fiid, t_id
              from (select dt, fiwarnts.t_fiid, fiwarnts.t_id
                    from dfiwarnts_dbt fiwarnts
                    join (select :dt dt, :fiid fiid from dual) on 1=1
                    where fiwarnts.t_fiid = fiid and
                          fiwarnts.t_drawingdate >= dt
                    order by fiwarnts.t_drawingdate, fiwarnts.t_id desc)
              where rownum = 1) d on rsi_rsb_fiinstr.FI_IsCouponAvoiriss(d.t_fiid) = 1 and 
                                     fiwarnts.t_id = d.t_id
      ];
      m_cmd_w = RsdCommand(EndCaptureOutput());
      m_cmd_w.AddParam("dt", RSDBP_IN, dt);
      m_cmd_w.AddParam("fiid", RSDBP_IN, fiid);
      m_cmd_w.Execute();
      m_RS_w = TRsbDataSet(m_cmd_w);
      if(m_RS_w.movenext)
        DND = date(m_RS_w.value("t_drawingdate"));
        DNDduration = m_RS_w.value("t_drawingdur");
        RateOffer = m_RS_w.value("t_incomerate") / 100;
      else
        DND = null;
        DNDduration = null;
        RateOffer = null;
      end;
      /*Первый купон*/
      StartCaptureOutput();
      [
        select fiwarnts.t_incomerate t_incomerate
        from dfiwarnts_dbt fiwarnts
        join (select t_fiid, t_id
              from (select fiwarnts.t_fiid, 
                           fiwarnts.t_id
                    from dfiwarnts_dbt fiwarnts
                    where fiwarnts.t_fiid = :fiid
                    order by fiwarnts.t_drawingdate, fiwarnts.t_id desc)
              where rownum = 1) d on rsi_rsb_fiinstr.FI_IsCouponAvoiriss(d.t_fiid) = 1 and 
                                     fiwarnts.t_id = d.t_id
      ];
      m_cmd_w = RsdCommand(EndCaptureOutput());
      m_cmd_w.AddParam("fiid", RSDBP_IN, fiid);
      m_cmd_w.Execute();
      m_RS_w = TRsbDataSet(m_cmd_w);
      if(m_RS_w.movenext)
        Rate = m_RS_w.value("t_incomerate") / 100;
      else
        Rate = null;
      end;
      /*Дата оферты на дату dt*/
      StartCaptureOutput();
      [
        select offers.t_dateredemption t_dateredemption
        from doffers_dbt offers
        join (select min(t_offernum) t_offernum, 
                     offers.t_fiid  t_fiid
              from doffers_dbt offers
              where offers.t_fiid = :fiid and
                    offers.t_dateredemption > :dt
              group by offers.t_fiid) offer on offers.t_fiid = offer.t_fiid and 
                                               offers.t_offernum = offer.t_offernum
      ];
      m_cmd_w = RsdCommand(EndCaptureOutput());
      m_cmd_w.AddParam("fiid", RSDBP_IN, fiid);
      m_cmd_w.AddParam("dt", RSDBP_IN, dt);
      m_cmd_w.Execute();
      m_RS_w = TRsbDataSet(m_cmd_w);
      if(m_RS_w.movenext)
        OfferDate = date(m_RS_w.value("t_dateredemption"));
      else
        OfferDate = null;
      end;
      /*Пытаемся угадать периодичность выплаты купона*/
      StartCaptureOutput();
      [
        select nvl(round(count(1)*12/months_between(max(t_drawingdate), min(fiwarnts.t_firstdate))),0) t_period
        from dfiwarnts_dbt fiwarnts
        join (select fiid 
              from (select :fiid fiid from dual) 
              where rsi_rsb_fiinstr.FI_IsCouponAvoiriss(fiid) = 1) fi on fi.fiid = fiwarnts.t_fiid
      ];
      m_cmd_w = RsdCommand(EndCaptureOutput());
      m_cmd_w.AddParam("fiid", RSDBP_IN, fiid);
      m_cmd_w.Execute();
      m_RS_w = TRsbDataSet(m_cmd_w);
      if(m_RS_w.movenext)
        Period = m_RS_w.value("t_period");
      else
        Period = null;
      end;
    end;

    /*Данные по балансовому счету*/
    macro GetBalAccount(dt, department, fiid, facevaluefi, facevalue, BalAccount:@string, RestBalAccount:@money, RateBalAccount:@double, RestBalAccountRUR:@money,RestRevaluationBalAccount:@money)
      var m_RS_w, m_cmd_w, m_Rev_RS_w, m_Rev_cmd_w;
      StartCaptureOutput();
      [
        select t_account,
               rsb_account.restall(t_account, t_chapter, t_currency, dt/*-1*/) t_accountrest,
               rsi_rsb_fiinstr.convsum(1,t_currency,0,dt/*-1*/) t_accountrate,
               case when t_currency != 0 then round(rsi_rsb_fiinstr.convsum(rsb_account.restall(t_account, t_chapter, t_currency, dt/*-1*/),t_currency,0,dt/*-1*/),2)
                    else rsb_account.restall(t_account, t_chapter, t_currency, dt/*-1*/)
               end t_accountrestRUR,
               rsb_fiinstr.convsum((select nvl(sum(v.t_amount),0)
                                    from v_scwrthistex2 v 
                                    where v.t_state = 20  and
                                          v.t_buy_sale = 5 and
                                          v.t_fiid = fiid and
                                          v.t_currency = facevaluefi and
                                          v.t_instance = (select max(t.t_instance) 
                                                          from v_scwrthistex t 
                                                          where v.t_sumid = t.t_sumid  and
                                                                v.t_changedate = t.t_changedate) and
                                          v.t_changedate = (select max(tt.t_changedate) 
                                                            from v_scwrthistex tt 
                                                            where v.t_sumid = tt.t_sumid  and
                                                                  tt.t_changedate < dt)) * facevalue, facevaluefi, 0, dt/*-1*/) t_nomRUR
        from(select mcaccdoc.t_account, mcaccdoc.t_chapter, mcaccdoc.t_currency, dt, fiid, facevaluefi, facevalue
             from dmcaccdoc_dbt mcaccdoc
             join (select :dt dt, :department department, :fiid fiid, :facevaluefi facevaluefi, :facevalue facevalue from dual) fi on 1=1 
             where mcaccdoc.t_iscommon = chr(88) and
                   mcaccdoc.t_branch = fi.department and
                   mcaccdoc.t_fiid = fi.fiid and
                   mcaccdoc.t_owner = -1 and
                   mcaccdoc.t_chapter = 1 and
                   (regexp_like(mcaccdoc.t_account, '^5200[1|2|3|4|5|6]') or 
                    regexp_like(mcaccdoc.t_account, '^5290[1|2]')) and
                   mcaccdoc.t_activatedate < fi.dt and
                   mcaccdoc.t_currency = fi.facevaluefi and
                   (mcaccdoc.t_disablingdate = to_date('01.01.0001','dd.mm.yyyy') or mcaccdoc.t_disablingdate >= fi.dt)
            order by mcaccdoc.t_activatedate)
       where rownum = 1
      ];
      m_cmd_w = RsdCommand(EndCaptureOutput());
      m_cmd_w.AddParam("dt", RSDBP_IN, dt);
      m_cmd_w.AddParam("department", RSDBP_IN, department);
      m_cmd_w.AddParam("fiid", RSDBP_IN, fiid);
      m_cmd_w.AddParam("facevaluefi", RSDBP_IN, facevaluefi);
      m_cmd_w.AddParam("facevalue", RSDBP_IN, facevalue);
      m_cmd_w.Execute();
      m_RS_w = TRsbDataSet(m_cmd_w);
      if(m_RS_w.movenext)
        BalAccount = m_RS_w.value("t_account");
        RestBalAccount = m_RS_w.value("t_accountrest");
        RateBalAccount = m_RS_w.value("t_accountrate");
        RestBalAccountRUR = m_RS_w.value("t_accountrestRUR");
//        RestBalAccountRUR = m_RS_w.value("t_nomRUR");
       if(facevaluefi != natcur)
        StartCaptureOutput();
        [   
            SELECT nvl((SELECT SUM (T_SUM_NATCUR)
              FROM dacctrn_dbt
             WHERE     t_number_pack in (994, 94)
                   AND T_ACCOUNT_PAYER LIKE '70608%46301%'
                   AND t_state = 1
                   AND t_chapter = 1
                   AND t_date_carry BETWEEN TRUNC (parm.dt, 'YYYY')
                                        AND parm.dt --ADD_MONTHS (TRUNC (parm.dt, 'YYYY'), 12) - 1
                   AND T_ACCOUNT_RECEIVER = parm.BalAcc)
                - (SELECT SUM (T_SUM_NATCUR)
                     FROM dacctrn_dbt
                     WHERE     t_number_pack in (994, 94)
                       AND T_ACCOUNT_RECEIVER LIKE '70603%26301%'
                       AND t_state = 1
                       AND t_chapter = 1
                       AND t_date_carry BETWEEN TRUNC (parm.dt, 'YYYY')
                                            AND  parm.dt --ADD_MONTHS (TRUNC (parm.dt, 'YYYY'), 12) - 1
                     AND T_ACCOUNT_PAYER = parm.BalAcc), 0)
                result_sum
               FROM (SELECT :dt dt, :BalAcc BalAcc FROM DUAL) parm
        ]; 
         m_Rev_cmd_w = RsdCommand(EndCaptureOutput());
         m_Rev_cmd_w.AddParam("dt", RSDBP_IN, dt);
         m_Rev_cmd_w.AddParam("BalAcc", RSDBP_IN, BalAccount);
         m_cmd_w.Execute();
         m_Rev_RS_w = TRsbDataSet(m_Rev_cmd_w); 
         if(m_Rev_RS_w.movenext)
           RestRevaluationBalAccount = m_Rev_RS_w.value("result_sum");
         end;  
       else 
         RestRevaluationBalAccount = null;         
       end; 


      else
        BalAccount = null;
        RestBalAccount = null;
        RateBalAccount = null;
        RestBalAccountRUR = null;
        RestRevaluationBalAccount = null;
      end;
/*
      StartCaptureOutput();
      [
        select scwrthistex.*
        from v_scwrthistex scwrthistex 
        join (select  
                     scwrthistex.t_bcid,
                     scwrthistex.t_sumid,
                     max(scwrthistex.t_changedate) t_maxchangedate,
                     max(scwrthistex.t_instance) t_maxinstance
              from v_scwrthistex scwrthistex
              join (select :dt dt, :department department, :fiid fiid from dual) on 1=1
              where scwrthistex.t_party = -1 and
                    scwrthistex.t_fiid = fiid and
                    scwrthistex.t_department = department and
                    scwrthistex.t_changedate <= dt
              group by scwrthistex.t_bcid, scwrthistex.t_sumid) t on scwrthistex.t_bcid = t.t_bcid and
                                                                     scwrthistex.t_sumid = t.t_sumid and 
                                                                     scwrthistex.t_changedate = t.t_maxchangedate and
                                                                     scwrthistex.t_instance = t.t_maxinstance
        where scwrthistex.t_state in (1,3,20)
      ];
      m_cmd_w = RsdCommand(EndCaptureOutput());
      m_cmd_w.AddParam("dt", RSDBP_IN, dt);
      m_cmd_w.AddParam("department", RSDBP_IN, department);
      m_cmd_w.AddParam("fiid", RSDBP_IN, fiid);
      m_RS_w = TRsbDataSet(m_cmd_w);
      addBalAccount = "";
      while(m_RS_w.movenext)
        if(ЛСчетНаКоторомУчитываетсяЛот(m_RS_w, dt/*-1*/).account != BalAccount)
          addBalAccount = addBalAccount + "+" + ЛСчетНаКоторомУчитываетсяЛот(m_RS_w, dt/*-1*/).account;
        end;
      end;
*/
    end;

    /*Данные по счету начисленного купона*/
    macro GetAccruedAccount(dt, department, fiid, facevaluefi, AccruedAccount:@string, RestAccruedAccount:@money, RestAccruedAccountRUR:@money, opu_RestAccruedAccount:@money, opu_RestAccruedAccountRUR:@money )
      var m_RS_w, m_cmd_w, opu_m_RS_w, opu_m_cmd_w;
      StartCaptureOutput();
      [
        select t_account,
               rsb_account.restall(t_account, t_chapter, t_currency, dt/*-1*/) t_accountrest,
               case when t_currency != 0 then round(rsi_rsb_fiinstr.convsum(rsb_account.restall(t_account, t_chapter, t_currency, dt/*-1*/),t_currency,0,dt/*-1*/),2)
                    else rsb_account.restall(t_account, t_chapter, t_currency, dt/*-1*/)
               end t_accountrestRUR
        from(select mcaccdoc.t_account, mcaccdoc.t_chapter, mcaccdoc.t_currency, dt
             from dmcaccdoc_dbt mcaccdoc
             join (select :dt dt, :department department, :fiid fiid, :facevaluefi facevaluefi from dual) fi on 1=1 
             where mcaccdoc.t_iscommon = chr(88) and
                   mcaccdoc.t_branch = fi.department and
                   mcaccdoc.t_fiid = fi.fiid and
                   mcaccdoc.t_owner = -1 and
                   mcaccdoc.t_chapter = 1 and
                   (regexp_like(mcaccdoc.t_account, '^52407') or 
                    regexp_like(mcaccdoc.t_account, '^52501') or 
                    regexp_like(mcaccdoc.t_account, '^47426')) and
                   mcaccdoc.t_activatedate <= fi.dt and
                   mcaccdoc.t_currency = fi.facevaluefi and
                   (mcaccdoc.t_disablingdate = to_date('01.01.0001','dd.mm.yyyy') or mcaccdoc.t_disablingdate >= fi.dt)
            order by mcaccdoc.t_activatedate)
       where rownum = 1
      ];
      m_cmd_w = RsdCommand(EndCaptureOutput());
      m_cmd_w.AddParam("dt", RSDBP_IN, dt);
      m_cmd_w.AddParam("department", RSDBP_IN, department);
      m_cmd_w.AddParam("fiid", RSDBP_IN, fiid);
      m_cmd_w.AddParam("facevaluefi", RSDBP_IN, facevaluefi);
      m_cmd_w.Execute();
      m_RS_w = TRsbDataSet(m_cmd_w);
      if(m_RS_w.movenext)
        AccruedAccount = m_RS_w.value("t_account");
        RestAccruedAccount = m_RS_w.value("t_accountrest");
        RestAccruedAccountRUR = m_RS_w.value("t_accountrestRUR");

      StartCaptureOutput();
      [
       SELECT SUM (T_SUM_NATCUR) SUM_NATCUR, SUM (T_SUM_RECEIVER) SUM_RECEIVER
        FROM dacctrn_dbt
        WHERE T_ACCOUNT_RECEIVER = :crAccount
        AND T_ACCOUNT_PAYER LIKE '70606%'
        AND T_STATE = 1
        AND t_date_carry BETWEEN TRUNC (:dt, 'YYYY') and :dt1
                           /* AND ADD_MONTHS (TRUNC (:dt1, 'YYYY'), 12) - 1*/
      ];
      opu_m_cmd_w = RsdCommand(EndCaptureOutput());
      opu_m_cmd_w.AddParam("crAccount", RSDBP_IN, AccruedAccount); 
      opu_m_cmd_w.AddParam("dt", RSDBP_IN, dt);
      opu_m_cmd_w.AddParam("dt1", RSDBP_IN, dt);
      opu_m_cmd_w.Execute();
      opu_m_RS_w = TRsbDataSet(opu_m_cmd_w);

      if(opu_m_RS_w.movenext)
        opu_RestAccruedAccount = opu_m_RS_w.value("SUM_RECEIVER");
        opu_RestAccruedAccountRUR = opu_m_RS_w.value("SUM_NATCUR");
      else 
        opu_RestAccruedAccount = $0;
        opu_RestAccruedAccountRUR = $0;  
      end;

      else
        AccruedAccount = null;
        RestAccruedAccount = $0;
        RestAccruedAccountRUR = $0;
        opu_RestAccruedAccount = $0;
        opu_RestAccruedAccountRUR = $0;  
      end;

      
      
    end;

    macro Get524Account(dt, department, fiid, facevaluefi, Account524:@string, Rest524Account:@money, Rest524AccountRUR:@money)
      var m_RS_w, m_cmd_w, opu_m_RS_w, opu_m_cmd_w;
      StartCaptureOutput();
      [
       select t_account,
               rsb_account.restall(t_account, t_chapter, t_currency, dt/*-1*/) t_accountrest,
               case when t_currency != 0 then round(rsi_rsb_fiinstr.convsum(rsb_account.restall(t_account, t_chapter, t_currency, dt/*-1*/),t_currency,0,dt/*-1*/),2)
                    else rsb_account.restall(t_account, t_chapter, t_currency, dt/*-1*/)
               end t_accountrestRUR
        from(select mcaccdoc.t_account, mcaccdoc.t_chapter, mcaccdoc.t_currency, dt
             from dmcaccdoc_dbt mcaccdoc
             join (select :dt dt, :department department, :fiid fiid, :facevaluefi facevaluefi from dual) fi on 1=1,
             ddl_tick_dbt tk 
             where mcaccdoc.t_branch = fi.department and
                   mcaccdoc.t_owner = -1 and
                   mcaccdoc.t_chapter = 1 and
                   (regexp_like(mcaccdoc.t_account, '^52407') or 
                    regexp_like(mcaccdoc.t_account, '^52402')) and
                   mcaccdoc.t_activatedate < fi.dt and
                   MCACCDOC.T_CATNUM = 1620 and 
                  (mcaccdoc.t_disablingdate = to_date('01.01.0001','dd.mm.yyyy') or mcaccdoc.t_disablingdate >= fi.dt)
                  and tk.t_BOfficeKind = mcaccdoc.t_DocKind
                  and tk.t_DealID = mcaccdoc.t_DocID
                  and tk.t_PFI = fi.fiid
            order by mcaccdoc.t_activatedate DESC)
       where rownum = 1;
      ];
      m_cmd_w = RsdCommand(EndCaptureOutput());
      m_cmd_w.AddParam("dt", RSDBP_IN, dt);
      m_cmd_w.AddParam("department", RSDBP_IN, department);
      m_cmd_w.AddParam("fiid", RSDBP_IN, fiid);
      m_cmd_w.AddParam("facevaluefi", RSDBP_IN, facevaluefi);
      m_cmd_w.Execute();
      m_RS_w = TRsbDataSet(m_cmd_w);
      if(m_RS_w.movenext)
        Account524 = m_RS_w.value("t_account");
        Rest524Account = m_RS_w.value("t_accountrest");
        Rest524AccountRUR = m_RS_w.value("t_accountrestRUR");
     else
        Account524 = null;
        Rest524Account = null;
        Rest524AccountRUR = null;
     end;
         
    end;

     macro Get52006Account(dt, department, fiid, facevaluefi, Account52006:@string, Rest52006Account:@money, Rest52006AccountRUR:@money)
      var m_RS_w, m_cmd_w, opu_m_RS_w, opu_m_cmd_w;

      StartCaptureOutput();
      [
       select t_account,
               rsb_account.restall(t_account, t_chapter, t_currency, dt/*-1*/) t_accountrest,
               case when t_currency != 0 then round(rsi_rsb_fiinstr.convsum(rsb_account.restall(t_account, t_chapter, t_currency, dt/*-1*/),t_currency,0,dt/*-1*/),2)
                    else rsb_account.restall(t_account, t_chapter, t_currency, dt/*-1*/)
               end t_accountrestRUR
        from(select mcaccdoc.t_account, mcaccdoc.t_chapter, mcaccdoc.t_currency, dt
             from dmcaccdoc_dbt mcaccdoc
             join (select :dt dt, :department department, :fiid fiid, :facevaluefi facevaluefi from dual) fi on 1=1 
             where mcaccdoc.t_iscommon = chr(88) and
                   mcaccdoc.t_branch = fi.department and
                   mcaccdoc.t_fiid = fi.fiid and
                   mcaccdoc.t_owner = -1 and
                   mcaccdoc.t_chapter = 1 and
                   (regexp_like(mcaccdoc.t_account, '^52006')) and
                   mcaccdoc.t_activatedate < fi.dt and
                   MCACCDOC.T_CATNUM = 1404 and 
                  (mcaccdoc.t_disablingdate = to_date('01.01.0001','dd.mm.yyyy') or mcaccdoc.t_disablingdate >= fi.dt)
            order by mcaccdoc.t_activatedate)
       where rownum = 1;
      ];
      m_cmd_w = RsdCommand(EndCaptureOutput());
      m_cmd_w.AddParam("dt", RSDBP_IN, dt);
      m_cmd_w.AddParam("department", RSDBP_IN, department);
      m_cmd_w.AddParam("fiid", RSDBP_IN, fiid);
      m_cmd_w.AddParam("facevaluefi", RSDBP_IN, facevaluefi);
      m_cmd_w.Execute();
      m_RS_w = TRsbDataSet(m_cmd_w);
      if(m_RS_w.movenext)
        Account52006 = m_RS_w.value("t_account");
        Rest52006Account = m_RS_w.value("t_accountrest");
        Rest52006AccountRUR = m_RS_w.value("t_accountrestRUR");
     else
        Account52006 = null;
        Rest52006Account = null;
        Rest52006AccountRUR = null;
     end;

   
    end;

     macro Get52006AccountBonus(dt, department, fiid, facevaluefi, Account52006Bonus:@string, Rest52006AccountBonus:@money, Rest52006AccountRURBonus:@money)
      var m_RS_w, m_cmd_w, opu_m_RS_w, opu_m_cmd_w;

      StartCaptureOutput();
      [
       select t_account,
               rsb_account.restall(t_account, t_chapter, t_currency, dt/*-1*/) t_accountrest,
               case when t_currency != 0 then round(rsi_rsb_fiinstr.convsum(rsb_account.restall(t_account, t_chapter, t_currency, dt/*-1*/),t_currency,0,dt/*-1*/),2)
                    else rsb_account.restall(t_account, t_chapter, t_currency, dt/*-1*/)
               end t_accountrestRUR
        from(select mcaccdoc.t_account, mcaccdoc.t_chapter, mcaccdoc.t_currency, dt
             from dmcaccdoc_dbt mcaccdoc
             join (select :dt dt, :department department, :fiid fiid, :facevaluefi facevaluefi from dual) fi on 1=1 
             where mcaccdoc.t_iscommon = chr(88) and
                   mcaccdoc.t_branch = fi.department and
                   mcaccdoc.t_fiid = fi.fiid and
                   mcaccdoc.t_owner = -1 and
                   mcaccdoc.t_chapter = 1 and
                   (regexp_like(mcaccdoc.t_account, '^52006')) and
                   mcaccdoc.t_activatedate < fi.dt and
                   MCACCDOC.T_CATNUM = 1403 and 
                  (mcaccdoc.t_disablingdate = to_date('01.01.0001','dd.mm.yyyy') or mcaccdoc.t_disablingdate >= fi.dt)
            order by mcaccdoc.t_activatedate)
       where rownum = 1;
      ];
      m_cmd_w = RsdCommand(EndCaptureOutput());
      m_cmd_w.AddParam("dt", RSDBP_IN, dt);
      m_cmd_w.AddParam("department", RSDBP_IN, department);
      m_cmd_w.AddParam("fiid", RSDBP_IN, fiid);
      m_cmd_w.AddParam("facevaluefi", RSDBP_IN, facevaluefi);
      m_cmd_w.Execute();
      m_RS_w = TRsbDataSet(m_cmd_w);
      if(m_RS_w.movenext)
        Account52006Bonus = m_RS_w.value("t_account");
        Rest52006AccountBonus = m_RS_w.value("t_accountrest");
        Rest52006AccountRURBonus = m_RS_w.value("t_accountrestRUR");
     else
        Account52006Bonus = null;
        Rest52006AccountBonus = null;
        Rest52006AccountRURBonus = null;
     end;

   
    end;



    /*Счет процентнах расходов и обороты по нему*/
    macro GetExpenseAccount(dt, department, facevaluefi, AccruedAccount, ExpenseAccount:@string, ExpenseAccountTurnDeb:@money, ExpenseAccountTurnDebRUR:@money, ExpenseAccountTurnCred:@money, ExpenseAccountTurnCredRUR:@money)
      var m_RS_w, m_cmd_w;
      if(AccruedAccount != null)
        StartCaptureOutput();
        [
          select expenseaccount,
                 (select nvl(sum(t_sum_receiver),0) 
                  from dacctrn_dbt 
                  where t_state = 1 and 
                        t_chapter = 1 and 
                        t_department = department and 
                        t_accountid_payer = expenseaccountid and 
                        t_account_receiver = accuredaccount and 
                        t_date_carry between begdt and dt/*-1*/) ExpenseAccountTurnDeb,
                 (select nvl(sum(t_sum_payer),0) 
                  from dacctrn_dbt 
                  where t_state = 1 and 
                        t_chapter = 1 and 
                        t_department = department and 
                        t_accountid_payer = expenseaccountid and 
                        t_account_receiver = accuredaccount and 
                        t_date_carry between begdt and dt/*-1*/) ExpenseAccountTurnDebRUR,
                 (select nvl(sum(case when t_fiid_payer = facevaluefi then t_sum_payer
                                      else round(rsi_rsb_fiinstr.convsum(t_sum_payer,t_fiid_payer,facevaluefi,t_date_carry),2)
                                 end),0) 
                  from dacctrn_dbt 
                  where t_state = 1 and 
                        t_chapter = 1 and 
                        t_department = department and 
                        t_accountid_receiver = expenseaccountid and 
                        (t_account_payer = accuredaccount or 
                         t_account_payer like '47404%' or 
                         t_account_payer like '3%') and 
                        t_date_carry between begdt and dt/*-1*/) ExpenseAccountTurnCred,
                 (select nvl(sum(t_sum_receiver),0) 
                  from dacctrn_dbt 
                  where t_state = 1 and 
                        t_chapter = 1 and 
                        t_department = department and 
                        t_accountid_receiver = expenseaccountid and 
                        (t_account_payer = accuredaccount or 
                         t_account_payer like '47404%' or 
                         t_account_payer like '3%') and 
                        t_date_carry between begdt and dt/*-1*/) ExpenseAccountTurnCredRUR
          from (select dt, 
                       last_day(add_months(dt,-2))+1 begdt, 
                       department, 
                       facevaluefi, 
                       expenseaccountid, 
                       expenseaccount, 
                       accuredaccount
                from (select dt, department, facevaluefi, t_accountid_payer expenseaccountid, t_account_payer expenseaccount, accuredaccount
                      from dacctrn_dbt
                      join (select :dt dt, :department department, :facevaluefi facevaluefi, :accuredaccount accuredaccount from dual) on t_account_receiver = accuredaccount and 
                                                                                                                                          t_date_carry < dt 
                     where t_account_payer like '70606%' and 
                           t_state = 1 and 
                           t_chapter = 1 and 
                           t_department = department
                order by t_acctrnid desc)
          where rownum = 1)
        ];
        m_cmd_w = RsdCommand(EndCaptureOutput());
        m_cmd_w.AddParam("dt", RSDBP_IN, dt);
        m_cmd_w.AddParam("department", RSDBP_IN, department);
        m_cmd_w.AddParam("facevaluefi", RSDBP_IN, facevaluefi);
        m_cmd_w.AddParam("accuredaccount", RSDBP_IN, AccruedAccount);
        m_cmd_w.Execute();
        m_RS_w = TRsbDataSet(m_cmd_w);
      end;
      if((AccruedAccount != null) and (m_RS_w.movenext))
        ExpenseAccount = m_RS_w.value("ExpenseAccount");
        ExpenseAccountTurnDeb = m_RS_w.value("ExpenseAccountTurnDeb");
        ExpenseAccountTurnDebRUR = m_RS_w.value("ExpenseAccountTurnDebRUR");
        ExpenseAccountTurnCred = m_RS_w.value("ExpenseAccountTurnCred");
        ExpenseAccountTurnCredRUR = m_RS_w.value("ExpenseAccountTurnCredRUR");
      else
        ExpenseAccount = null;
        ExpenseAccountTurnDeb = null;
        ExpenseAccountTurnDebRUR = null;
        ExpenseAccountTurnCred = null;
        ExpenseAccountTurnCredRUR = null;
      end;

      if (ExpenseAccount == null)
        var SQL = "SELECT acc.t_account " +
              "  FROM dmcaccdoc_dbt acc, dmccateg_dbt mcc " +
              " WHERE     acc.t_catnum = mcc.T_NUMBER " +
              "       AND mcc.t_code = '%Расход, ОЭБ' " +
              "       AND acc.t_iscommon = CHR (88) " +
              "       AND acc.t_templnum = :templ " ;
        SQL = RSDCommand(SQL);
        SQL.AddParam("templ", rsdbp_in, iif(facevaluefi == NATCUR, 1/*Шаблон для НацВалюты*/, 2/*Шаблон для ИнВалюты*/));  
        SQL = RSDRecordset(SQL, rsdval_client, rsdval_static);
        if(SQL.MoveNext)
          ExpenseAccount = SQL.Value("t_account");
        end;    

      end;          

    end;
    /*Данные по комиссиям*/
    macro GetComissAccount(dt, department, fiid, facevaluefi, ComissAccount:@string, RestComissAccount:@money,RestComissAccountRUR:@money,OpenRestComissAccount:@money,OpenRestComissAccountRUR:@money)
     var m_RS_w, m_cmd_w;
   
      StartCaptureOutput();
       [
       /* select t_account,
               abs(rsb_account.restall(t_account, t_chapter, t_currency, dt-1)) t_accountrest,
               case when t_currency != 0 then abs(round(rsi_rsb_fiinstr.convsum(rsb_account.restall(t_account, t_chapter, t_currency, dt-1),t_currency,0,dt-1),2))
                    else abs(rsb_account.restall(t_account, t_chapter, t_currency, dt-1))
               end t_accountrestRUR
        from(select mcaccdoc.t_account, mcaccdoc.t_chapter, mcaccdoc.t_currency, dt
             from dmcaccdoc_dbt mcaccdoc
             join (select :dt dt, :department department, :fiid fiid, :facevaluefi facevaluefi from dual) fi on 1=1 
             where mcaccdoc.t_iscommon = chr(88) and
                   mcaccdoc.t_branch = fi.department and
                   mcaccdoc.t_fiid = fi.fiid and
                   mcaccdoc.t_owner = -1 and
                   mcaccdoc.t_chapter = 1 and
                   (regexp_like(mcaccdoc.t_account, '^47440') ) and
                   mcaccdoc.t_activatedate < fi.dt and
                   mcaccdoc.t_currency = fi.facevaluefi and
                   (mcaccdoc.t_disablingdate = to_date('01.01.0001','dd.mm.yyyy') or mcaccdoc.t_disablingdate >= fi.dt)
            order by mcaccdoc.t_activatedate)*/
            select t_account,
               abs(rsb_account.restall(t_account, t_chapter, t_currency, dt-1)) t_accountrest,
               abs(rsb_account.restall(t_account, t_chapter, t_currency, odt)) t_openaccountrest,
               case when t_currency != 0 then abs(round(rsi_rsb_fiinstr.convsum(rsb_account.restall(t_account, t_chapter, t_currency, dt/*-1*/),t_currency,0,dt/*-1*/),2))
                    else abs(rsb_account.restall(t_account, t_chapter, t_currency, dt/*-1*/))
               end t_accountrestRUR,
                case when t_currency != 0 then abs(round(rsi_rsb_fiinstr.convsum(rsb_account.restall(t_account, t_chapter, t_currency, odt),t_currency,0,odt),2))
                    else abs(rsb_account.restall(t_account, t_chapter, t_currency, odt))
               end t_openaccountrestRUR
        from(select mcaccdoc.t_account, mcaccdoc.t_chapter, mcaccdoc.t_currency,  dt, ac.t_open_date odt
             from dmcaccdoc_dbt mcaccdoc, daccount_dbt ac
             join (select :dt dt, :department department, :fiid fiid, :facevaluefi facevaluefi from dual) fi on 1=1 
             where mcaccdoc.t_iscommon = chr(88) and
                   MCACCDOC.T_ACCOUNT = AC.T_ACCOUNT and 
                   mcaccdoc.t_branch = fi.department and
                   mcaccdoc.t_fiid = fi.fiid and
                   mcaccdoc.t_owner = -1 and
                   mcaccdoc.t_chapter = 1 and
                   (regexp_like(mcaccdoc.t_account, '^47440') ) and
                   mcaccdoc.t_activatedate < fi.dt and
            --       mcaccdoc.t_currency = fi.facevaluefi and
                   mcaccdoc.t_catnum = 1407 and 
                   (mcaccdoc.t_disablingdate = to_date('01.01.0001','dd.mm.yyyy') or mcaccdoc.t_disablingdate >= fi.dt)
            order by mcaccdoc.t_activatedate)
       ];
      m_cmd_w = RsdCommand(EndCaptureOutput());
      m_cmd_w.AddParam("dt", RSDBP_IN, dt);
      m_cmd_w.AddParam("department", RSDBP_IN, department);
      m_cmd_w.AddParam("fiid", RSDBP_IN, fiid);
      m_cmd_w.AddParam("facevaluefi", RSDBP_IN, facevaluefi);
      m_cmd_w.Execute();
      m_RS_w = TRsbDataSet(m_cmd_w);
      if(m_RS_w.movenext)
        ComissAccount = m_RS_w.value("t_account");
        RestComissAccount = m_RS_w.value("t_accountrest");
        RestComissAccountRUR = m_RS_w.value("t_accountrestRUR");
        OpenRestComissAccount = m_RS_w.value("t_openaccountrest");
        OpenRestComissAccountRUR = m_RS_w.value("t_openaccountrestRUR");
      else
        ComissAccount = null;
        RestComissAccount = null;
        RestComissAccountRUR = null;
        OpenRestComissAccount = null;
        OpenRestComissAccountRUR = null;
      end;  

    end;


   macro GetCouponAccount(dt, department, fiid, facevaluefi, CouponAccount:@string)
     var m_RS_w, m_cmd_w;
   
      StartCaptureOutput();
       [
         select t_account       
         from (select mcaccdoc.t_account, mcaccdoc.t_chapter, mcaccdoc.t_currency,  dt, ac.t_open_date odt
                      from dmcaccdoc_dbt mcaccdoc, daccount_dbt ac, DMCCATEG_DBT categ
                      join (select :dt dt, :fiid fiid, :facevaluefi facevaluefi from dual) fi on 1=1,
                      ddl_tick_dbt tk
         where  mcaccdoc.t_account = ac.t_account
              and mcaccdoc.t_catnum = CATEG.T_NUMBER
              and categ.t_code = 'ОЭБ купон, к погашению'
              and mcaccdoc.t_activatedate < fi.dt
              and (mcaccdoc.t_disablingdate = to_date('01.01.0001','dd.mm.yyyy') or mcaccdoc.t_disablingdate >= fi.dt)
              and tk.t_BOfficeKind = mcaccdoc.t_DocKind
              and tk.t_DealID = mcaccdoc.t_DocID
              and tk.t_PFI = fi.fiid
            order by mcaccdoc.t_activatedate DESC
              )
           ];

      m_cmd_w = RsdCommand(EndCaptureOutput());
      m_cmd_w.AddParam("dt", RSDBP_IN, dt);
      m_cmd_w.AddParam("fiid", RSDBP_IN, fiid);
      m_cmd_w.AddParam("facevaluefi", RSDBP_IN, facevaluefi);
      m_cmd_w.Execute();
      m_RS_w = TRsbDataSet(m_cmd_w);
      if(m_RS_w.movenext)
        CouponAccount = m_RS_w.value("t_account");
      else
        CouponAccount = null;
      end;  

   end;




    private macro getLotOnDate(dt, department, fiid, ValueRepDate:@money )
     var v_RS_w, v_cmd_w;
    StartCaptureOutput;
    [
          select  (SELECT SUM (t_amount)
                FROM v_scwrthistex vv
               WHERE t_state IN ( 20) AND t_amount > 0
                     AND t_instance = (SELECT MAX (t_instance)
                               FROM v_scwrthistex
                              WHERE vv.t_sumid = t_sumid
                                    AND vv.t_changedate = t_changedate)
                     AND t_fiid = v.t_fiid
                     AND t_contract = v.t_contract
                     AND vv.t_changedate =
                            (SELECT MAX (t.t_changedate)
                               FROM v_scwrthistex t
                              WHERE vv.t_sumid = t_sumid
                                    AND t.t_changedate <= v.t_changedate))       "Rest"      
        FROM v_scwrthistex v 
       WHERE t_state IN ( 20) AND t_amount > 0
             AND t_instance =
                    (SELECT MAX (t_instance)
                       FROM v_scwrthistex
                      WHERE v.t_sumid = t_sumid AND v.t_changedate = t_changedate)
             AND t_fiid = :2
             AND v.t_changedate =
                    (SELECT MAX (t.t_changedate)
                       FROM v_scwrthistex t
                      WHERE v.t_sumid = t_sumid AND t.t_changedate <= :3)
    GROUP BY v.t_changedate, v.t_state,  v.t_contract, v.t_fiid
    ]; 

      v_cmd_w = RsdCommand(EndCaptureOutput());
      v_cmd_w.AddParam("fiid", RSDBP_IN, fiid);
      v_cmd_w.AddParam("dt", RSDBP_IN, dt);
      v_cmd_w.Execute();
      v_RS_w = TRsbDataSet(v_cmd_w);
      if(v_RS_w.movenext)
        ValueRepDate = v_RS_w.value("Rest");
      else
        ValueRepDate = 0.0;
      end;  
    end;

    /*Данные по котировке*/
    macro GetRate(dt, ratedt, fiid, facevaluefi, RateValue:@double, RateType:@string, RateSource:@string, HierarchyLevel:@String)
      macro GetRate(FromFI, ToFI, RateType, dt, RateDate:@date)
        var m_RS_w, m_cmd_w, nullflag;
        StartCaptureOutput();
        [
          declare
            FromFI number := :FromFI;
            ToFI number := :ToFI;
            RateType number := :RateType;
            dt date := :dt;
            RateValue number := 0.0;
            RateDate date := null;
            RateID number;
          begin
            begin
              RateValue := RSI_RSB_FIInstr.FI_GetRate(FromFI, ToFI, RateType, dt, dt-to_date('01.01.0001','DD.MM.YYYY'), 0, RateID, RateDate);
              if(RateValue <= 0) then
                RateValue := RSI_RSB_FIInstr.FI_GetRate(FromFI, -1, RateType, dt, dt-to_date('01.01.0001','DD.MM.YYYY'), 0, RateID, RateDate);
              end if;
              if(RateID > 0)then
                begin
                  select t_rate/power(10,t_point)/t_scale 
                  into RateValue
                  from dratedef_dbt
                  where t_rateid = RateID and
                        t_isinverse != chr(88) and
                        t_sincedate = RateDate;
                exception when others then
                  begin
                    select t_rate/power(10,t_point)/t_scale 
                    into RateValue
                    from dratehist_dbt
                    where t_rateid = RateID and
                          t_isinverse != chr(88) and
                          t_sincedate = RateDate;
                  exception when others then
                    null;
                  end;
                end;
              end if;
            exception when others then
              null;
            end;
            :RateValue := RateValue;
            :RateDate := RateDate;
          end;
        ];
        m_cmd_w = RsdCommand(EndCaptureOutput());
        m_cmd_w.AddParam("FromFI", RSDBP_IN, FromFI);
        m_cmd_w.AddParam("ToFI", RSDBP_IN, ToFI);
        m_cmd_w.AddParam("RateType", RSDBP_IN, RateType);
        m_cmd_w.AddParam("dt", RSDBP_IN, dt);
        m_cmd_w.AddParam("RateValue", RSDBP_OUT, V_DOUBLE);
        m_cmd_w.AddParam("RateDate", RSDBP_OUT, V_DATE);
        m_cmd_w.Execute();
        RateDate = m_cmd_w.value("RateDate", nullflag);
        if(RateDate == " 1.01.0001")
          RateDate = date(0,0,0);
        else
          RateDate = date(RateDate);
        end;
        return m_cmd_w.value("RateValue")
      end;
      var RateDate;
      /*Номинал в рублях*/
      if((facevaluefi == 0) or (facevaluefi != 0))
        RateValue = GetRate(fiid, facevaluefi, 4/*Средневзвешенная цена*/, dt, @RateDate);
        if(RateDate == dt)
//        RateType = "средневзвешенная цена";
//        RateSource = "сравнительная оценка";
          RateType = "средневзвешенная цена";
          RateSource = "биржевая информация";
          HierarchyLevel = "1";
          return;
        end;
        RateValue = GetRate(fiid, facevaluefi, 1/*Рыночная цена*/, dt, @RateDate);
        if(RateDate == dt)
          RateType = "рыночная цена";
          RateSource = "биржевая информация";
          HierarchyLevel = "1";
          return;
        end;
        RateValue = GetRate(fiid, facevaluefi, 18/*Цена закрытия*/, dt, @RateDate);
        if(RateDate == dt)
          RateType = "цена закрытия";
          RateSource = "биржевая информация";
          HierarchyLevel = "1";
          return;
        end;
        RateValue = GetRate(fiid, facevaluefi, 4/*Средневзвешенная цена*/, dt, @RateDate);
        if(RateDate > ratedt)
          RateType = "рыночная цена";
          RateSource = "биржевая информация";
          HierarchyLevel = "1";
          return;
        end;
        RateValue = GetRate(fiid, facevaluefi, 1/*Рыночная цена*/, dt, @RateDate);
        if(RateDate > ratedt)
          RateType = "рыночная цена";
          RateSource = "биржевая информация";//"сравнительная оценка";
          HierarchyLevel = "1";
          return;
        end;
        RateValue = GetRate(fiid, facevaluefi, 18/*Цена закрытия*/, dt, @RateDate);
        if(RateDate > ratedt)
          RateType = "цена закрытия";
          RateSource = "биржевая информация";
          HierarchyLevel = "1";
          return;
        end;
//для номинала в валюте
        RateValue = GetRate(fiid, facevaluefi, 23/*Цена закрытия Bloomberg*/, dt, @RateDate);
        if(RateDate == dt)
          RateType = "ask price";
          RateSource = "bloomberg";
          HierarchyLevel = "1";
          return;
        end;
        RateValue = GetRate(fiid, facevaluefi, 10/*Средняя цена Рейтер*/, dt, @RateDate);
        if(RateDate == dt)
          RateType = "средняя цена Рейтер";
          RateSource = "рейтер";
          HierarchyLevel = "1";
          return;
        end;
        RateValue = GetRate(fiid, facevaluefi, 23/*Цена закрытия Bloomberg*/, dt, @RateDate);
        if(RateDate > ratedt)
          RateType = "ask price";
          RateSource = "bloomberg";
          HierarchyLevel = "1";
          return;
        end;
        RateValue = GetRate(fiid, facevaluefi, 10/*Средняя цена Рейтер*/, dt, @RateDate);
        if(RateDate > ratedt)
          RateType = "средняя цена Рейтер";
          RateSource = "рейтер";
          HierarchyLevel = "1";
          return;
        end;

        RateValue = GetRate(fiid, facevaluefi, 1001/*Мотивированное суждение*/, dt, @RateDate);
        if(RateDate >= ratedt)
          RateType = "сравнительная оценка";
          RateSource = "мотивированное суждение";
          HierarchyLevel = "2";
          return;
        end;

          RateType = "сравнительная оценка";
          RateSource = "мотивированное суждение";
          HierarchyLevel = "2";
          return;
      /*Номинал в валюте*/
      else
        RateValue = GetRate(fiid, facevaluefi, 23/*Цена закрытия Bloomberg*/, dt, @RateDate);
        if(RateDate == dt)
          RateType = "ask price";
          RateSource = "bloomberg";
          return;
        end;
        RateValue = GetRate(fiid, facevaluefi, 10/*Средняя цена Рейтер*/, dt, @RateDate);
        if(RateDate == dt)
          RateType = "средняя цена Рейтер";
          RateSource = "рейтер";
          return;
        end;
        RateValue = GetRate(fiid, facevaluefi, 23/*Цена закрытия Bloomberg*/, dt, @RateDate);
        if(RateDate > ratedt)
          RateType = "ask price";
          RateSource = "bloomberg";
          return;
        end;
        RateValue = GetRate(fiid, facevaluefi, 10/*Средняя цена Рейтер*/, dt, @RateDate);
        if(RateDate > ratedt)
          RateType = "средняя цена Рейтер";
          RateSource = "рейтер";
          return;
        end;
      end;
      RateValue = 0.0;
      RateType = null;
      RateSource = null;
    end;

    macro printExtLine(BonusAccountRest)
            PrintTableLine(
              /* 1*/ "row1_1", "", null,
              /* 2*/ "row1_2", "", null, 
              /* 3*/ "row1_3", "", null, 
              /* 4*/ "row1_4", "", null, 
              /* 5*/ "row1_5", "", null, 
              /* 6*/ "row1_5_isin", "", null, 
              /* 7*/ "row1_6", "", null, 
              /* 8*/ "row1_7", "" , 2, 
              /* 9*/ "row1_8", "", 2, 
              /*10*/ "row1_9", "", 2, 
              /*11*/ "row1_10", "", null, 
              /*12*/ "row1_11", "", null, 
              /*13*/ "row1_12", "", 0, 
              /*14*/ "row1_13", "", null, 
              /*15*/ "row1_14", "", 0, 
              /*16*/ "row1_15", "", null, 
              /*17*/ "row1_16", "", null, 
              /*18*/ "row1_17", "", null, 
              /*19*/ "row1_18", "", 0, 
              /*20*/ "row1_19", "", null, 
              /*21*/ "row1_20", "", null, 
              /*22*/ "row1_21", "", 0, 
              /*23*/ "row1_22", "", 4, 
              /*24*/ "row1_23", "", 0, 
              /*25*/ "row1_24", "", 0, 
              /*26*/ "row1_25", "", null, 
              /*27*/ "row1_26", "", null, 
              /*28*/ "row1_27", "", 2, 
              /*29*/ "row1_28", "", 2, 
              /*30*/ "row1_29", "", null, 
              /*31*/ "row1_30", "", 0, 
              /*32*/ "row1_31", "", 0, 
              /*33*/ "row1_34", "", null, 
              /*34*/ "row1_35", "", null, 
              /*35*/ "row1_36", "", null, 
              /*36*/ "row1_37", "",null, 
              /*37*/ "row1_38", "", null,
              /*38*/ "row1_39", "", 0, 
              /*39*/ "row1_40", "", null, 
              /*40*/ "row1_41", "", null, 
              /*41*/ "row1_42", "", null, 
              /*42*/ "row1_43", "", null, 
              /*43*/ "row1_44", "", null, 
              /*44*/ "row1_45", "", 2, 
              /*45*/ "row1_46", "", 0, 
              /*46*/ "row1_47", "", null, 
              /*47*/ "row1_48", "", null, 
              /*48*/ "row1_50", "", null,//m_RS.value("t_attr55"), null,
              /*49*/ "row1_51", "", 0,
              /*50*/ "row1_52", "", 2,
              /*51*/ "row1_53", "", 2,
              /*52*/ "row1_54", "", 0, /*money(checkvalue(RestBalAccountRUR)) + money(checkvalue(RestAccruedAccount)) - money(checkvalue(Rest524AccountRUR)) - money(checkvalue(RestComissAccountRUR)), 0,*/
              /*53*/ "row1_55", BonusAccountRest, 2,
              /*54*/ "row1_56", "", 0);

    end;

/*Точка входа*/
    var cnt, cntn;
    var m_DS, m_cmd;

    /*Отключаем все индикаторы*/
    if(m_UseTemplate)
      m_ObjTemplateXLS.SetFlagShowIndicator(false);
    else
      __BUG_Global_m_ObjTemplateXLS.SetFlagShowIndicator(false);
    end;
    m_ProgressIndicator = CreateProgressIndicator(true);

    /*Даты отчета*/
    m_BeginDate = FormData.BeginDate;

    /*Дата начала поиска котировки*/
    var m_RateDate = m_BeginDate;
    while(SSDays > 0)
      m_RateDate = m_RateDate - 1;
      if(IsWorkDay(m_RateDate))
        SSDays = SSDays - 1;
      end;
    end;

/*Лист "МСФО11"*/
    SetActiveSheet("МСФО11");
    PrintFormatString("", "reportdate", m_BeginDate);
    RegisterTable( "row1_full", "",
             /* 1*/ "row1_1", 
             /* 2*/ "row1_2", 
             /* 3*/ "row1_3", 
             /* 4*/ "row1_4", 
             /* 5*/ "row1_5", 
             /* 5*/ "row1_5_isin", 
             /* 6*/ "row1_6", 
             /* 7*/ "row1_7", 
             /* 8*/ "row1_8", 
             /* 9*/ "row1_9", 
             /*10*/ "row1_10", 
             /*11*/ "row1_11", 
             /*12*/ "row1_12", 
             /*13*/ "row1_13", 
             /*14*/ "row1_14", 
             /*15*/ "row1_15", 
             /*16*/ "row1_16", 
             /*17*/ "row1_17", 
             /*18*/ "row1_18", 
             /*19*/ "row1_19", 
             /*20*/ "row1_20", 
             /*21*/ "row1_21", 
             /*22*/ "row1_22", 
             /*23*/ "row1_23", 
             /*24*/ "row1_24",
             /*25*/ "row1_25",
             /*26*/ "row1_26",
             /*27*/ "row1_27",
             /*28*/ "row1_28",
             /*29*/ "row1_29",
             /*30*/ "row1_30",
             /*31*/ "row1_31",
             /*32*/ //"row1_32",
             /*33*/ //"row1_33",
             /*34*/ "row1_34",
             /*35*/ "row1_35",
             /*36*/ "row1_36",
             /*37*/ "row1_37",
             /*38*/ "row1_38",
             /*39*/ "row1_39",
             /*40*/ "row1_40",
             /*41*/ "row1_41",
             /*42*/ "row1_42",
             /*43*/ "row1_43",
             /*44*/ "row1_44",
             /*45*/ "row1_45",
             /*46*/ "row1_46",
             /*47*/ "row1_47",
             /*48*/ "row1_48",
             /*49*/ //"row1_49",
             /*50*/ "row1_50",
             /*50*/ "row1_51",
             /*50*/ "row1_52",
             /*50*/ "row1_53",
             /*50*/ "row1_54",
             /*50*/ "row1_55",
             /*50*/ "row1_56",
             /*50*/ "row1_57");
    StartCaptureOutput();
    [
      select count(1) over() t_cnt,
             t_fiid,
             t_department,
             t_facevaluefi,
             t_iseuro,
             t_departmentnum,
             t_departmentname,
             t_issuer,
             t_lsin,
             isin,
             t_fi_code,
             t_qtybegplacemetntdate,
             t_qtyrepdate,
             t_facevalue,
             t_begplacementdate,
             t_drawingdate,
             t_duration,
             t_overamount,
             t_amount,
             t_attr55,
             case when t_attr55 = '1' then 'да' else 'нет' end t_isactivemarket
      from (select fi.t_fiid t_fiid,
                   fi.t_department t_department,
                   fininstr.t_facevaluefi t_facevaluefi,
                   case when avrkinds.t_avoirkind in (39/*AVOIRKIND_BOND_PARTY_EVRO*/, 
                                                      41/*AVOIRKIND_BOND_MUNICIPAL_EVRO*/, 
                                                      43/*AVOIRKIND_BOND_CORPORATE_EVRO*/) then 1 
                        else 0 end 
                   t_iseuro,
                   nvl(dp_dep.t_name,chr(1)) t_departmentnum,
                   case when nvl(t_parentcode,-1) = 0 then 'Головной офис' 
                        else 'Филиал' 
                   end t_departmentname,
                   case when issuer.t_shortname is null then fininstr.t_definition 
                        else issuer.t_shortname||'/'||fininstr.t_definition 
                   end t_issuer,
                   nvl(avoiriss.t_lsin,chr(1)) t_lsin,
                   nvl(avoiriss.t_isin,chr(1)) isin,
                   face.t_fi_code t_fi_code,
                   (select nvl(sum(t_qty),0) * fininstr.t_facevalue 
                    from dv_fi_qty_hist v_fi_qty_hist  
                    where v_fi_qty_hist.t_fiid = fi.t_fiid and
                          v_fi_qty_hist.t_begdate <= avoiriss.t_begplacementdate and
                          (v_fi_qty_hist.t_enddate = to_date('01.01.0001','dd.mm.yyyy') or 
                           v_fi_qty_hist.t_enddate >= avoiriss.t_begplacementdate)) t_qtybegplacemetntdate,
                   (select nvl(sum(t_qty),0) 
                    from dv_fi_qty_hist v_fi_qty_hist  
                    where v_fi_qty_hist.t_fiid = fi.t_fiid and
                          v_fi_qty_hist.t_begdate <= dt and
                          (v_fi_qty_hist.t_enddate = to_date('01.01.0001','dd.mm.yyyy') or 
                           v_fi_qty_hist.t_enddate >= dt)) t_qtyrepdate,
                   (select nvl(sum(t_facevalue),0) 
                    from dv_fi_facevalue_hist v_fi_facevalue_hist  
                    where v_fi_facevalue_hist.t_fiid = fi.t_fiid and
                          v_fi_facevalue_hist.t_begdate <= dt and
                          (v_fi_facevalue_hist.t_enddate = to_date('01.01.0001','dd.mm.yyyy') or 
                           v_fi_facevalue_hist.t_enddate >= dt)) t_facevalue,
                   avoiriss.t_begplacementdate t_begplacementdate,
                   fininstr.t_drawingdate t_drawingdate,
                   case when fininstr.t_drawingdate > dt then fininstr.t_drawingdate - dt 
                        else 0 
                   end t_duration,
                   fi.t_overamount t_overamount,
                   fi.t_amount t_amount,
                   (select trim(lower(nvl(max(t_name),chr(1)))) 
                    from dobjattr_dbt objattr, dobjatcor_dbt objatcor 
                    where objattr.t_objecttype = 12/*ценная бумага*/ and 
                          objattr.t_groupid = 55/*Уровень исходных данных иерархии СС МСФО 13*/ and 
                          objatcor.t_objecttype = objattr.t_objecttype and 
                          objatcor.t_groupid = objattr.t_groupid and 
                          objatcor.t_attrid = objattr.t_attrid and 
                          objatcor.t_object = lpad(fi.t_fiid, 10, '0') and 
                          objatcor.t_validfromdate < dt and 
                          objatcor.t_validtodate >= dt) t_attr55
            from (select dt, 
                         t_department, 
                         t_fiid,
                         nvl(sum(t_amount),0) t_amount,
                         nvl(sum(t_overamount),0) t_overamount
                  from (select dt, 
                               scwrthistex.t_department,
                               scwrthistex.t_fiid,
                               scwrthistex.t_amount,
                               scwrthistex.t_overamount,
                               scwrthistex.t_state,
                               scwrthistex.t_changedate,
                               max(scwrthistex.t_changedate) over(partition by scwrthistex.t_department, scwrthistex.t_fiid, scwrthistex.t_sumid) t_maxchangedate,
                               scwrthistex.t_instance,  
                               max(scwrthistex.t_instance) over(partition by scwrthistex.t_department, scwrthistex.t_fiid, scwrthistex.t_sumid, scwrthistex.t_changedate) t_maxinstance
                        from v_scwrthistex scwrthistex
                        join (select :dt dt, :IssuerID IssuerID from dual) on 1=1
                        join dfininstr_dbt fininstr on fininstr.t_fi_kind = 2/*FIKIND_AVOIRISS*/ and 
                                                       fininstr.t_fiid = scwrthistex.t_fiid 
                                                       and fininstr.t_issuer  = case when IssuerID = -1 then fininstr.t_issuer else IssuerID end 
                        join davrkinds_dbt avrkinds on avrkinds.t_fi_kind = fininstr.t_fi_kind and 
                                                       avrkinds.t_avoirkind = fininstr.t_avoirkind and
                                                       rsb_fiinstr.fi_avrkindsgetroot(fininstr.t_fi_kind, fininstr.t_avoirkind) = 17/*AVOIRKIND_BOND*/
                        where scwrthistex.t_party = -1 and
                              scwrthistex.t_changedate < dt)
                  where t_changedate = t_maxchangedate and
                        t_instance = t_maxinstance and
                        t_state in (1,3,20)
                  group by dt, t_department, t_fiid) fi
            left join ddp_dep_dbt dp_dep on dp_dep.t_code = fi.t_department
            join dfininstr_dbt fininstr on fininstr.t_fi_kind = 2/*FIKIND_AVOIRISS*/ and 
                                           fininstr.t_fiid = fi.t_fiid  
            join davrkinds_dbt avrkinds on avrkinds.t_fi_kind = fininstr.t_fi_kind and 
                                           avrkinds.t_avoirkind = fininstr.t_avoirkind
            left join davoiriss_dbt avoiriss on avoiriss.t_fiid = fi.t_fiid 
            left join dparty_dbt issuer on issuer.t_partyid = fininstr.t_issuer
            left join dfininstr_dbt face on face.t_fiid = fininstr.t_facevaluefi)
     --     where t_fiid in  (943)
      order by t_iseuro, t_issuer
    ];
    m_cmd = RsdCommand(EndCaptureOutput());
    m_cmd.AddParam("dt", RSDBP_IN, m_BeginDate);
    m_cmd.AddParam("IssuerID", RSDBP_IN, {OurBank}); //-1 - для всех
    m_cmd.Execute();
    m_RS = TRsbDataSet(m_cmd);
    var DND, DNDduration, OfferDate, Rate, RateOffer, Period;
    var BalAccount, RestBalAccount, RateBalAccount, RestBalAccountRUR,RestRevaluationBalAccount;
    var AccruedAccount, RestAccruedAccount, RestAccruedAccountRUR, opu_RestAccruedAccount, opu_RestAccruedAccountRUR ;
    var ComissAccount, RestComissAccount, RestComissAccountRUR, OpenRestComissAccount,  OpenRestComissAccountRUR;
    var ExpenseAccount, ExpenseAccountTurnDeb, ExpenseAccountTurnDebRUR, ExpenseAccountTurnCred, ExpenseAccountTurnCredRUR;
    var RateValue, RateType, RateSource, HierarchyLevel;
    var ValuePlacementDate, ValueRepDate;
    var Account524, Rest524Account, Rest524AccountRUR;
    var Account52006, Rest52006Account, Rest52006AccountRUR;
    var Account52006Bonus, Rest52006AccountBonus, Rest52006AccountRURBonus;
    var CouponAccount;
    cnt = 0;
    cntn = 0;
    while(m_RS.movenext)
      if(cnt == 0)
        InitProgress(int(m_RS.value("t_cnt")), "Ждите...", "Формирование отчета \"МСФО 11\"");
      end;
      cnt = cnt + 1;
      /*Получаем данные по балансовому счету*/
      GetBalAccount(m_BeginDate, m_RS.value("t_department"), m_RS.value("t_fiid"), m_RS.value("t_facevaluefi"), m_RS.value("t_facevalue"), @BalAccount, @RestBalAccount, @RateBalAccount, @RestBalAccountRUR,@RestRevaluationBalAccount);
      if(BalAccount != null)
        cntn = cntn + 1;
        /*Получаем данные по купонам*/
        GetWarrant(m_BeginDate, m_RS.value("t_fiid"), @DND, @DNDduration, @OfferDate, @Rate, @RateOffer, @Period);
        /*Получаем данные по счету начисленного купона*/
        GetAccruedAccount(m_BeginDate, m_RS.value("t_department"), m_RS.value("t_fiid"), m_RS.value("t_facevaluefi"), @AccruedAccount, @RestAccruedAccount, @RestAccruedAccountRUR, @opu_RestAccruedAccount, @opu_RestAccruedAccountRUR );
        /*Получаем счет процентнах расходов и обороты по нему*/
        GetExpenseAccount(m_BeginDate, m_RS.value("t_department"), m_RS.value("t_facevaluefi"), AccruedAccount, @ExpenseAccount, @ExpenseAccountTurnDeb, @ExpenseAccountTurnDebRUR, @ExpenseAccountTurnCred, @ExpenseAccountTurnCredRUR);
        /*Получаем данные по котировке*/
        GetRate(m_BeginDate, m_RateDate, m_RS.value("t_fiid"), m_RS.value("t_facevaluefi"), @RateValue, @RateType, @RateSource, @HierarchyLevel);
        /*Получаем данные по комиссиям*/
        GetComissAccount(m_BeginDate, m_RS.value("t_department"), m_RS.value("t_fiid"), m_RS.value("t_facevaluefi"), @ComissAccount, @RestComissAccount, @RestComissAccountRUR,@OpenRestComissAccount, @OpenRestComissAccountRUR);
    
        /*Получаем лоты на дату*/
        getLotOnDate(m_BeginDate, m_RS.value("t_department"), m_RS.value("t_fiid"), @ValueRepDate );
        /*информация о состоянии счета по учету обязательств по уплате купона на отчетную датуvar 524Account, Rest524Account, Rest524AccountRUR;*/
        get524Account(m_BeginDate, m_RS.value("t_department"), m_RS.value("t_fiid"), m_RS.value("t_facevaluefi"), @Account524, @Rest524Account, @Rest524AccountRUR);
        get52006Account(m_BeginDate, m_RS.value("t_department"), m_RS.value("t_fiid"), m_RS.value("t_facevaluefi"), @Account52006, @Rest52006Account, @Rest52006AccountRUR);
        get52006AccountBonus(m_BeginDate, m_RS.value("t_department"), m_RS.value("t_fiid"), m_RS.value("t_facevaluefi"), @Account52006Bonus, @Rest52006AccountBonus, @Rest52006AccountRURBonus);
        /*Получаем счет учета купона по категории ОЭБ купон, к погашению*/
        GetCouponAccount(m_BeginDate, m_RS.value("t_department"), m_RS.value("t_fiid"), m_RS.value("t_facevaluefi"), @CouponAccount);

        /*Выводим строку отчета*/
        PrintTableLine(
              /* 1*/ "row1_1", cntn, null,
              /* 2*/ "row1_2", m_RS.value("t_departmentnum"), null, 
              /* 3*/ "row1_3", m_RS.value("t_departmentname"), null, 
              /* 4*/ "row1_4", m_RS.value("t_issuer"), null, 
              /* 5*/ "row1_5", m_RS.value("t_lsin"), null, 
              /* 6*/ "row1_5_isin", m_RS.value("isin"), null, 
              /* 7*/ "row1_6", m_RS.value("t_fi_code"), null, 
              /* 8*/ "row1_7", m_RS.value("t_qtybegplacemetntdate") , 2, 
              /* 9*/ "row1_8", ValueRepDate * m_RS.value("t_facevalue")/*m_RS.value("t_qtyrepdate")*/, 2, 
              /*10*/ "row1_9", m_RS.value("t_facevalue"), 2, 
              /*11*/ "row1_10", date(m_RS.value("t_begplacementdate")), null, 
              /*12*/ "row1_11", iif((date(m_RS.value("t_drawingdate")) != OverValueDate) and (date(m_RS.value("t_drawingdate")) != zerodate), date(m_RS.value("t_drawingdate")), "Бессрочная"), null, 
              /*13*/ "row1_12", m_RS.value("t_duration"), 0, 
              /*14*/ "row1_13", DND, null, 
              /*15*/ "row1_14", DNDduration, 0, 
              /*16*/ "row1_15", OfferDate, null, 
              /*17*/ "row1_16", Rate, null, 
              /*18*/ "row1_17", RateOffer, null, 
              /*19*/ "row1_18", Period, 0, 
              /*20*/ "row1_19", substr(BalAccount,1,5), null, 
              /*21*/ "row1_20", BalAccount, null, 
              /*22*/ "row1_21", RestBalAccount, 0, 
              /*23*/ "row1_22", RateBalAccount, 4, 
              /*24*/ "row1_23", RestBalAccountRUR, 0, 
              /*25*/ "row1_24", RestRevaluationBalAccount/*m_RS.value("t_overamount")*/, 0, 
              /*26*/ "row1_25", substr(AccruedAccount,1,5), null, 
              /*27*/ "row1_26", AccruedAccount, null, 
              /*28*/ "row1_27", RestAccruedAccount, 2, 
              /*29*/ "row1_28", RestAccruedAccountRUR, 2, 
              /*30*/ "row1_29", ExpenseAccount, null, 
              /*31*/ "row1_30", opu_RestAccruedAccount/*ExpenseAccountTurnDeb*/, 0, 
              /*32*/ "row1_31", opu_RestAccruedAccountRUR/*ExpenseAccountTurnDebRUR*/, 0, 
              /*33*/ "row1_34", ComissAccount, null, 
              /*34*/ "row1_35", ComissAccount, null, 
              /*35*/ "row1_36", "", null, 
              /*36*/ "row1_37", "",null, 
              /*37*/ "row1_38", m_RS.value("t_fi_code"), null,
              /*38*/ "row1_39", iif(OpenRestComissAccount==0,RestComissAccount,OpenRestComissAccount), 0, 
              /*39*/ "row1_40", "", null, 
              /*40*/ "row1_41", iif(OpenRestComissAccountRUR==0,RestComissAccountRUR,OpenRestComissAccountRUR), null, 
              /*41*/ "row1_42", "", null, 
              /*42*/ "row1_43", "", null, 
              /*43*/ "row1_44", "", null, 
              /*44*/ "row1_45", RateValue, 2, 
              /*45*/ "row1_46", round(RestBalAccountRUR * RateValue / 100, 2) + RestAccruedAccountRUR, 0, 
              /*46*/ "row1_47", RateSource, null, 
              /*47*/ "row1_48", RateType, null, 
              /*48*/ "row1_50", HierarchyLevel, null,//m_RS.value("t_attr55"), null,
              /*49*/ "row1_51", ComissAccount, null,
              /*50*/ "row1_52", RestComissAccountRUR, 2,
              /*51*/ "row1_53", money(checkvalue(Rest52006AccountRUR)) + money(checkvalue(RestBalAccountRUR)) + money(checkvalue(Rest52006AccountRURBonus)), 2,
              /*52*/ "row1_54", money(checkvalue(RestBalAccountRUR)) + money(checkvalue(RestAccruedAccountRUR)) - money(checkvalue(RestComissAccountRUR)), 0, /*money(checkvalue(RestBalAccountRUR)) + money(checkvalue(RestAccruedAccount)) - money(checkvalue(Rest524AccountRUR)) - money(checkvalue(RestComissAccountRUR)), 0,*/
              /*53*/ "row1_55", string(iif(Rest52006AccountRUR!=null,Rest52006AccountRUR,iif(Rest52006AccountRURBonus!=null,Rest52006AccountRURBonus,""))) +  iif( ((Rest52006AccountRURBonus!=null) and (Rest52006AccountRUR!=null) ),   string(" ",Rest52006AccountRURBonus),""    ), 2,
              /*54*/ "row1_56", Rest524AccountRUR, 0,
              /*55*/ "row1_57", CouponAccount, 0);

      end;
      UseProgress(cnt);
    end;
    if(cnt > 0)
      RemProgress();
    end;
    EndTable();
    m_ObjTemplateXLS.SetAutoFit("E", "МСФО11");    
  END;
  
  initTX_RegistrReport(msfo11_Panel(), "msfo11.xlsx");

END;

/*Точка входа*/

if (not CheckUserRoles({oper}, РОЛЬ_08, РОЛЬ_10, РОЛЬ_25, РОЛЬ_26, РОЛЬ_28))
  msgbox("Недостаточно прав для выпуска отчета!");
  exit(1);
end;

var r = msfo11_Report();
r.InitReport("МСФО11", null);
r.Run();

exit(1);

