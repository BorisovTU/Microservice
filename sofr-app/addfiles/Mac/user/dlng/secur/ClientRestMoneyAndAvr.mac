import rsd;
import "DLReport_h.mac", "dlreport.mac", "dlQuery.mac", "scsrvrepfun.mac", "sc_inacc.mac";
import "dpstdrep.mac", "dl_util_xml_obj.mac";
import RsbFormsInter;

private const FT_INTEGER = 0;
private const FT_LONG    = 1;
private const FT_FLOAT   = 2;
private const FT_DOUBLE  = 4;
private const FT_DOUBLEM = 6;
private const FT_STRING  = 7;
private const FT_SNR     = 8;
private const FT_DATE    = 9;
private const FT_TIME    = 10;
private const FT_CHR     = 12;
private const FT_UCHR    = 13;
private const FT_LDMON   = 14;
private const FT_LDMONR  = 15;
private const FT_DOUBLER = 16;
private const FT_LDOUBLE = 17;
private const FT_NUMSTR  = 18;

private class ReportParams()
    var dateBegin:date,
        dateEnd:date,
        clientid:integer,
        sfcontrid:integer, 
        dlcontrid:integer,
        account:string;
end;

private class CClientRestMoneyAndAvr_Report(_params)
    PRIVATE VAR m_rep:T_XML_Rep;
    PRIVATE VAR m_params = _params;

    var CreateOnTerm = (not isStandAlone());
/***********************************/  
    PRIVATE MACRO GetTxtPath()
        var RegistryPath = "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR";
        var Path = "";
        var stat = 0;
 
        GetRegistryValue(RegistryPath, V_STRING, Path, stat);
        if(stat) 
            msgbox("Не задана настройка в реестре банка:|", RegistryPath);      
        end;

        return Path;
    END;

    PRIVATE MACRO processPath( p_path )
        var l_str, l_p, l_path = "";

        p_path = trim( p_path );

        if( substr( p_path, 1, 2 ) == ".." ) /* ссылка на вышестоящий каталог */
            p_path = substr( p_path, 3 );

            l_str  = getCWD(false);    
            l_p    = strbrk( l_str, "\\" );
            while( l_p != 0 )
                 l_path = l_path + substr( l_str, 1, l_p - 1 ) + "\\";
                 l_str  = substr( l_str, l_p + 1 );
                 l_p    = strbrk( l_str, "\\" );
            end;
            return ( substr( l_path, 1, strlen( l_path ) - 1 ) + p_path );

        elif( substr( p_path, 1, 1 ) == "." ) /* ссылка на текущий каталог */
            return ( getCWD + substr( p_path, 2 ) );
        end;

        return p_path;
    END;
    MACRO GetRepFullPath(isRemote:bool)
        var Path = "";

        if(isRemote)
            var txtPath = GetTxtPath();

            if( substr( txtPath, 1, 2 ) == ".." ) /* ссылка на вышестоящий каталог */
                txtPath = substr(txtPath, 3 );
            end;

            if( substr( txtPath, 1, 1 ) == "\\" ) /* ссылка на вышестоящий каталог */
                txtPath = substr(txtPath, 2 );
            end;

            Path = GetCurDir(true) + "\\" + txtPath + "\\"; 
        else
            Path = processPath(GetTxtPath()) + "\\";
        end;

        // получить полный путь
        return Path;
    END;
/***********************************/  

    macro getContrName(_dlcontrid)
      var sqlQuery = RSDCommand(" SELECT T_NAME                                   " +
                                "   FROM DSFCONTR_DBT                             " +
                                "  WHERE T_ID = (SELECT t_sfcontrid               " +
                                "                  FROM ddlcontr_dbt              " +
                                "                 WHERE t_dlcontrid = :dlcontrid) ");

      sqlQuery.addParam("", RSDBP_IN, _dlcontrid);
      sqlQuery.execute();

      var sqlData = TRsbDataSet(sqlQuery);

      if(sqlData.movenext)
          return sqlData.name;
      end;

      return "";
    end;

    macro getClientName(_partyid, _dlcontrid)
        var party = TRecHandler ("party");

        if(not ПолучитьСубъекта(_partyid, party))
          if(party.rec.LegalForm == 2/*PTLEFG_PERSN*/)
              return party.rec.Name;
          else
              return getContrName(_dlcontrid);
          end;
        end;

        return "";
    end;

    macro PrintRestMoney()
        var query = " SELECT party.t_name,                                                           " +
                    "        dlcontrmp.t_mpcode  market_code,                                        " +
                    "        limits0.t_curr_code,                                                    " +
                    "        NVL((SELECT SUM (NVL (ABS (RSB_ACCOUNT.RESTALL (a.t_account,            " + 
                    "                                                        a.t_chapter,            " +
                    "                                                        a.t_code_currency,      " +
                    "                                                        :beg_date1-1)),0)) rest " +
                    "               FROM dsettacc_dbt s, dsfssi_dbt ss, daccount_dbt a               " +
                    "              WHERE     s.t_settaccid = ss.t_setaccid                           " +
                    "                    AND ss.t_objecttype = 659                                   " +
                    "                    AND ss.t_objectid = sfcontr.t_id                            " +
                    "                    AND a.t_account = s.t_account                               " +
                    "                    AND a.t_chapter = s.t_chapter                               " +
                    "                    AND a.t_code_currency = limits0.t_currid                    " +
                    "                    AND a.t_chapter = 1),0) rest_306,                           " +
                    "        nvl(limits0.t_money306,0) money306,                                     " +
                    "        nvl(limits0.t_open_balance,0) limit_t0,                                 " +
                    "        nvl(limits1.t_open_balance,0) limit_t1,                                 " +
                    "        nvl(limits2.t_open_balance,0) limit_t2,                                 " +
                    "        nvl(limits0.t_isblocked,chr(0)) is_blocked,                             " +
                    "        party.t_partyid,                                                        " +
                    "        dlcontrmp.t_dlcontrid                                                   " +
                    "   FROM dsfcontr_dbt sfcontr                                                    " +
                    "        LEFT JOIN dparty_dbt party                                              " +
                    "           ON party.t_partyid = sfcontr.t_partyid                               " +
                    "        LEFT JOIN DDLCONTRMP_DBT dlcontrmp                                      " +
                    "           ON dlcontrmp.t_sfcontrid = sfcontr.t_id                              " +
                    "        LEFT JOIN (SELECT t_curr_code,t_money306,t_open_balance,t_limit_kind,t_date,t_client_code,t_client,t_currid,t_isblocked FROM DDL_LIMITCASHSTOCK_DBT                         " +
                    "                   UNION                                                        " +
                    "                   SELECT t_curr_code,t_money306,t_open_balance,t_limit_kind,t_date,t_client_code,t_client,t_currid,t_isblocked FROM DDL_LIMITCASHSTOCKARCH_DBT) limits0            " +
                    "           ON     sfcontr.t_partyid = limits0.t_client                          " +
                    "              AND dlcontrmp.t_mpcode = limits0.t_client_code                    " +
                    "              AND limits0.t_date = :beg_date2                                   " +
                    "              AND limits0.t_limit_kind = 0                                      " +
                    "        LEFT JOIN (SELECT t_curr_code,t_money306,t_open_balance,t_limit_kind,t_date,t_client_code,t_client,t_currid,t_isblocked FROM DDL_LIMITCASHSTOCK_DBT                         " +
                    "                   UNION                                                        " +
                    "                   SELECT t_curr_code,t_money306,t_open_balance,t_limit_kind,t_date,t_client_code,t_client,t_currid,t_isblocked FROM DDL_LIMITCASHSTOCKARCH_DBT) limits1            " +
                    "           ON     sfcontr.t_partyid = limits1.t_client                          " +
                    "              AND dlcontrmp.t_mpcode = limits1.t_client_code                    " +
                    "              AND limits1.t_date = :beg_date3                                   " +
                    "              AND limits1.t_limit_kind = 1                                      " +
                    "              AND limits1.t_currid = limits0.t_currid                           " +
                    "        LEFT JOIN (SELECT t_curr_code,t_money306,t_open_balance,t_limit_kind,t_date,t_client_code,t_client,t_currid,t_isblocked FROM DDL_LIMITCASHSTOCK_DBT                         " +
                    "                   UNION                                                        " +
                    "                   SELECT t_curr_code,t_money306,t_open_balance,t_limit_kind,t_date,t_client_code,t_client,t_currid,t_isblocked FROM DDL_LIMITCASHSTOCKARCH_DBT) limits2            " +
                    "           ON     sfcontr.t_partyid = limits2.t_client                          " +
                    "              AND dlcontrmp.t_mpcode = limits2.t_client_code                    " +
                    "              AND limits2.t_date = :beg_date4                                   " +
                    "              AND limits2.t_limit_kind = 2                                      " +
                    "              AND limits2.t_currid = limits0.t_currid                           " +
                    "  WHERE sfcontr.t_servkind = 1 AND sfcontr.t_servkindsub = 8                    " +
                    "        AND (   LIMITS0.T_OPEN_BALANCE IS NOT NULL                              " +
                    "             OR LIMITS1.T_OPEN_BALANCE IS NOT NULL                              " +
                    "             OR LIMITS2.T_OPEN_BALANCE IS NOT NULL)                             ";
        if(m_params.clientid != -1)
            query = query + " AND  sfcontr.t_partyid = :clientid";
        end;

        if(m_params.sfcontrid != -1)
            query = query + " AND  sfcontr.t_id = :sfcontrid";
        end;

        query = query + " ORDER BY dlcontrmp.t_mpcode, party.t_partyid, sfcontr.t_id, limits0.t_currid ";

        var cmd = DL_RSDCommand(query);
            cmd.AddParam(m_params.dateBegin);
            cmd.AddParam(m_params.dateBegin);
            cmd.AddParam(m_params.dateBegin);
            cmd.AddParam(m_params.dateBegin);

        if(m_params.clientid != -1) 
            cmd.AddParam(m_params.clientid);           
        end;

        if(m_params.sfcontrid != -1) 
            cmd.AddParam(m_params.sfcontrid);           
        end;

        var cnt = cmd.GetCount();
        if(cnt)
            m_rep.Blank_Line();
            m_rep.Put_Str("Остатки по денежным средствам на бирже", "START;R=1;FB;HA=L;END;");
            m_rep.Put_Val("Клиент",             "START;BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Код на Бирже",       "BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Валюта счета",       "BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Остаток на 30601",   "BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Лимит Т0",           "BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Лимит Т1",           "BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Лимит Т2",           "BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Блокировка лимитов", "BOR;WT;HA=C;VA=C;END;");

            //BegAction(1000,"Идет отбор данных");
            var i=0;

            InitProgress(cnt, "Идет отбор данных", "Идет отбор данных");            
            var ClientData = cmd.Execute();

            while(ClientData.movenext)
                //m_rep.Put_Val(ClientData.name,        "START;BOR;WT;HA=C;VA=C;");
                m_rep.Put_Val(getClientName(ClientData.partyid, ClientData.dlcontrid),        "START;BOR;WT;HA=C;VA=C;");
                m_rep.Put_Val(ClientData.market_code,       "BOR;WT;HA=C;VA=C;");
                m_rep.Put_Val(ClientData.curr_code,         "BOR;WT;HA=C;VA=C;");
                m_rep.Put_Val(ClientData.Rest_306,          "BOR;WT;HA=C;VA=C;T=M4");
                m_rep.Put_Val(ClientData.limit_t0,          "BOR;WT;HA=C;VA=C;T=M4");
                m_rep.Put_Val(ClientData.limit_t1,          "BOR;WT;HA=C;VA=C;T=M4");
                m_rep.Put_Val(ClientData.limit_t2,          "BOR;WT;HA=C;VA=C;T=M4");
                m_rep.Put_Val(ClientData.is_blocked,  "END;BOR;WT;HA=C;VA=C;");

                i=i+1;
                UseProgress(i);
            end;
            //EndAction();
            RemProgress;
        else
            msgBox("За указанную дату нет рассчитанных лимитов по денежным средствам");
        end;
    end;

    macro PrintRestMoneyOffExchange()
        var query = " SELECT q.*, (q.rest_306 + q.plan_plus_rest - q.plan_minus_rest) plan_rest                                                                                                    " +
                    "   FROM(SELECT party.t_name,                                                                                                                                                  " +
                    "               dlcontrmp.t_mpcode market_code,                                                                                                                                " +
                    "               (SELECT CASE WHEN T_CCY = 'RUR' OR T_CCY = 'RUB' THEN 'SUR' ELSE T_CCY END                                                                                     " +
                    "                  FROM dfininstr_dbt fin                                                                                                                                      " +
                    "                 WHERE t_fiid = ss.t_fiid) t_curr_code,                                                                                                                       " +
                    "               a.t_account,                                                                                                                                                   " +
                    "               nvl(RSB_ACCOUNT.RESTALL (a.t_account, a.t_chapter,a.t_code_currency, :beg_date1 - 1),0) rest_306,                                                              " +
                    "               RSHB_RSI_SCLIMIT.GETSUMPLANCASHRQ(party.t_partyid,sfcontr.t_ID,0,:beg_date2,to_date('31.12.9999','dd.mm.yyyy'),a.t_accountid,a.t_code_currency,                " +
                    "                1, NVL(dlcontrmp.t_marketid,-1)) plan_plus_rest,                                                                                                              " +
                    "               RSHB_RSI_SCLIMIT.GETSUMPLANCASHRQ(party.t_partyid,sfcontr.t_ID,0,:beg_date3,to_date('31.12.9999','dd.mm.yyyy'),a.t_accountid,a.t_code_currency,                " +
                    "                0, NVL(dlcontrmp.t_marketid,-1)) plan_minus_rest,                                                                                                             " +
                    "               sfcontr.t_partyid clientid, sfcontr.t_id contrid,                                                                                                              " +
                    "               sfcontr.t_dateclose,                                                                                                                                           " +
                    "               dlcontrmp.t_dlcontrid,                                                                                                                                         " +
                    "               ss.t_fiid                                                                                                                                                      " +
                    "         FROM dsfcontr_dbt sfcontr                                                                                                                                            " +
                    "              LEFT JOIN dparty_dbt party ON party.t_partyid = sfcontr.t_partyid                                                                                               " +
                    "              LEFT JOIN DDLCONTRMP_DBT dlcontrmp ON dlcontrmp.t_sfcontrid = sfcontr.t_id                                                                                      " +
                    "              LEFT JOIN dsfssi_dbt ss ON ss.t_objecttype = 659 AND ss.t_objectid = sfcontr.t_id                                                                               " +
                    "              LEFT JOIN dsettacc_dbt s ON s.t_settaccid = ss.t_setaccid                                                                                                       " +
                    "              LEFT JOIN daccount_dbt a                                                                                                                                        " +
                    "                 ON     a.t_account = s.t_account                                                                                                                             " +
                    "                    AND a.t_chapter = s.t_chapter                                                                                                                             " +
                    "                    AND a.t_chapter = 1                                                                                                                                       " +
                    "        WHERE     sfcontr.t_servkind = 1 AND sfcontr.t_servkindsub = 9                                                                                                        " +
                    "              AND a.t_account is not null                                                                                                                                     " +
                    "              AND (t_dateclose > :beg_date4 or t_dateclose = to_date('01.01.0001','dd.mm.yyyy') )                                                                             ";

        if(m_params.clientid != -1)
            query = query + " AND  sfcontr.t_partyid = :clientid";
        end;

        if(m_params.sfcontrid != -1)
            query = query + " AND  sfcontr.t_id = :sfcontrid";
        end;

        query = query + " ) q ORDER BY market_code, clientid, contrid, t_fiid ";

        var cmd = DL_RSDCommand(query);
            cmd.AddParam(m_params.dateBegin);
            cmd.AddParam(m_params.dateBegin);
            cmd.AddParam(m_params.dateBegin);
            cmd.AddParam(m_params.dateBegin);

        if(m_params.clientid != -1) 
            cmd.AddParam(m_params.clientid);           
        end;

        if(m_params.sfcontrid != -1) 
            cmd.AddParam(m_params.sfcontrid);           
        end;
        var cnt = cmd.GetCount();
        if(cnt)
            m_rep.Blank_Line();
            m_rep.Put_Str("Остатки по денежным средствам на внебирже", "START;R=1;FB;HA=L;END;");
            m_rep.Put_Val("Клиент",                  "START;BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Код на Бирже",            "BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Номер счета",             "BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Валюта",                  "BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Остаток на 30601 (факт)", "BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Остаток с учетом будующих расчетов (план)", "BOR;WT;HA=C;VA=C;END;");

            var i=0;
            //BegAction(1000,"Идет отбор данных");
            InitProgress(cnt, "Расчет плановых остатков на внебирже", "Идет отбор данных");
            var ClientData = cmd.Execute();

            while(ClientData.movenext)
                //m_rep.Put_Val(ClientData.name,        "START;BOR;WT;HA=C;VA=C;");
                m_rep.Put_Val(getClientName(ClientData.clientid, ClientData.dlcontrid),        "START;BOR;WT;HA=C;VA=C;");
                m_rep.Put_Val(ClientData.market_code,       "BOR;WT;HA=C;VA=C;");
                m_rep.Put_Val(ClientData.account,           "BOR;WT;HA=C;VA=C;");
                m_rep.Put_Val(ClientData.curr_code,         "BOR;WT;HA=C;VA=C;");
                m_rep.Put_Val(ClientData.rest_306,          "BOR;WT;HA=C;VA=C;T=M4");
                m_rep.Put_Val(ClientData.plan_rest,  "END;BOR;WT;HA=C;VA=C;T=M4");            
                i=i+1;
                UseProgress(i);
            end;
            RemProgress;

        end;        
    end;

    macro printRestAvr()
        var query = "  SELECT party.t_name,                                                                                                                                                    " +
                    "         dlcontrmp.t_mpcode  market_code,                                                                                                                                 " +
                    "         NVL(TRIM(RSB_STRUCT.GETSTRING(                                                                                                                                   " +
                    "                  rsi_rsb_kernel.GetNote(207, LPAD(dlcontrmp.t_dlcontrid, 34, '0'), 104, :beg_date1)))                                                                    " +
                    "                  , CHR(1)) as DepoTradeAcc,                                                                                                                              " +
                    "         fininstr.t_name avr_name,                                                                                                                                        " +
                    "         (SELECT t_code                                                                                                                                                   " +
                    "            FROM dobjcode_dbt code                                                                                                                                        " +
                    "           WHERE     code. t_codekind = 11                                                                                                                                " +
                    "                 AND code.t_objecttype = 9                                                                                                                                " +
                    "                 AND code.t_objectid = t.t_fiid                                                                                                                           " +
                    "                 AND code.t_state = 0) t_seccode,                                                                                                                         " +
                    "         avr.t_isin,                                                                                                                                                      " +
                    "         t.t_amount t_quantity,                                                                                                                                           " +
                    "         nvl(limits0.t_open_balance,0) limit_t0,                                                                                                                          " +
                    "         nvl(limits1.t_open_balance,0) limit_t1,                                                                                                                          " +
                    "         nvl(limits2.t_open_balance,0) limit_t2,                                                                                                                          " +
                    "         nvl(limits0.t_isblocked,chr(0)) is_blocked,                                                                                                                      " +
                    "         sfcontr.t_number,                                                                                                                                                " +
                    "         sfcontr.t_partyid clientid,                                                                                                                                      " +
                    "         dlcontrmp.t_dlcontrid                                                                                                                                            " +
                    "    FROM dsfcontr_dbt sfcontr                                                                                                                                             " +
                    "         LEFT JOIN dparty_dbt party                                                                                                                                       " +
                    "            ON party.t_partyid = sfcontr.t_partyid                                                                                                                        " +
                    "         LEFT JOIN DDLCONTRMP_DBT dlcontrmp                                                                                                                               " +
                    "            ON dlcontrmp.t_sfcontrid = sfcontr.t_id                                                                                                                       " +
                    "         JOIN (SELECT t.t_fiid, SUM(t.t_amount) t_amount, t.t_contract                                                                                                    " +
                    "                 FROM v_scwrthistex t                                                                                                                                     " +
                    "                WHERE     t.t_instance = (SELECT MAX (t_instance)                                                                                                         " +
                    "                                            FROM v_scwrthistex                                                                                                            " +
                    "                                           WHERE     t_sumid = t.t_sumid                                                                                                  " +
                    "                                                 AND t_changedate <= :beg_date2 )                                                                                         " +
                    "                      AND t.t_amount > 0                                                                                                                                  " +
                    "                      AND t.t_portfolio = 0                                                                                                                               " +
                    "                      AND t.t_state = 1 GROUP BY t.t_fiid,  t.t_contract) t ON t.t_contract = sfcontr.t_id                                                                " +
                    "         LEFT JOIN (SELECT t_seccode,t_open_balance,t_limit_kind,t_date,t_client_code,t_client,t_security,t_isblocked,t_quantity FROM DDL_LIMITSECURITES_DBT              " +
                    "                    UNION                                                                                                                                                 " +
                    "                    SELECT t_seccode,t_open_balance,t_limit_kind,t_date,t_client_code,t_client,t_security,t_isblocked,t_quantity FROM DDL_LIMITSECURITESARCH_DBT) limits0 " +
                    "            ON     sfcontr.t_partyid = limits0.t_client                                                                                                                   " +
                    "               AND dlcontrmp.t_mpcode = limits0.t_client_code                                                                                                             " +
                    "               AND limits0.t_date = :beg_date3                                                                                                                            " +
                    "               AND limits0.t_limit_kind = 0                                                                                                                               " +
                    "               AND limits0.t_security = t.t_fiid                                                                                                                          " +
                    "         LEFT JOIN (SELECT t_seccode,t_open_balance,t_limit_kind,t_date,t_client_code,t_client,t_security,t_isblocked,t_quantity FROM DDL_LIMITSECURITES_DBT              " +
                    "                    UNION                                                                                                                                                 " +
                    "                    SELECT t_seccode,t_open_balance,t_limit_kind,t_date,t_client_code,t_client,t_security,t_isblocked,t_quantity FROM DDL_LIMITSECURITESARCH_DBT) limits1 " +
                    "            ON     sfcontr.t_partyid = limits1.t_client                                                                                                                   " +
                    "               AND dlcontrmp.t_mpcode = limits1.t_client_code                                                                                                             " +
                    "               AND limits1.t_date = :beg_date4                                                                                                                            " +
                    "               AND limits1.t_limit_kind = 1                                                                                                                               " +
                    "               AND limits1.t_security = limits0.t_security                                                                                                                " +
                    "         LEFT JOIN (SELECT t_seccode,t_open_balance,t_limit_kind,t_date,t_client_code,t_client,t_security,t_isblocked,t_quantity FROM DDL_LIMITSECURITES_DBT              " +
                    "                    UNION                                                                                                                                                 " +
                    "                    SELECT t_seccode,t_open_balance,t_limit_kind,t_date,t_client_code,t_client,t_security,t_isblocked,t_quantity FROM DDL_LIMITSECURITESARCH_DBT) limits2 " +
                    "            ON     sfcontr.t_partyid = limits2.t_client                                                                                                                   " +
                    "               AND dlcontrmp.t_mpcode = limits2.t_client_code                                                                                                             " +
                    "               AND limits2.t_date = :beg_date5                                                                                                                            " +
                    "               AND limits2.t_limit_kind = 2                                                                                                                               " +
                    "               AND limits2.t_security = limits0.t_security                                                                                                                " +
                    "         LEFT JOIN dfininstr_dbt fininstr ON  t.t_fiid  = fininstr.t_fiid                                                                                                 " +
                    "         LEFT JOIN davoiriss_dbt avr ON  t.t_fiid  = avr.t_fiid                                                                                                           " +
                    "   WHERE sfcontr.t_servkind = 1 AND sfcontr.t_servkindsub = 8                                                                                                             " +
                    "           AND (   LIMITS0.T_OPEN_BALANCE IS NOT NULL                                                                                                                     " +
                    "              OR LIMITS1.T_OPEN_BALANCE IS NOT NULL                                                                                                                       " +
                    "              OR LIMITS2.T_OPEN_BALANCE IS NOT NULL)                                                                                                                      ";

        if(m_params.clientid != -1)
            query = query + " AND  sfcontr.t_partyid = :clientid";
        end;

        if(m_params.sfcontrid != -1)
            query = query + " AND  sfcontr.t_id = :sfcontrid";
        end;

        query = query + " ORDER BY dlcontrmp.t_mpcode, SFCONTR.T_PARTYID, SFCONTR.T_ID, avr_name ";

        var cmd = DL_RSDCommand(query);
            cmd.AddParam(m_params.dateBegin);
            cmd.AddParam(m_params.dateBegin);
            cmd.AddParam(m_params.dateBegin);
            cmd.AddParam(m_params.dateBegin);
            cmd.AddParam(m_params.dateBegin);

        if(m_params.clientid != -1) 
            cmd.AddParam(m_params.clientid);           
        end;

        if(m_params.sfcontrid != -1) 
            cmd.AddParam(m_params.sfcontrid);           
        end;

        var cnt = cmd.GetCount();
        if(cnt)
            m_rep.Blank_Line();
            m_rep.Put_Str("Остатки по ценным бумагам на торговом счете депо", "START;R=1;FB;HA=L;END;");
            m_rep.Put_Val("Клиент",                           "START;BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Код на Бирже",                     "BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Счет депо",                        "BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Краткое наименование бумаги",      "BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Наименование бумаги по ММВб/ISIN", "BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Остаток штук (факт)",              "BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Лимит Т0",                         "BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Лимит Т1",                         "BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Лимит Т2",                         "BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Блокировка лимитов",               "BOR;WT;HA=C;VA=C;END;");

            var i=0;

            InitProgress(cnt, "Идет отбор данных", "Идет отбор данных");
            var ClientData = cmd.Execute();

            while(ClientData.movenext)
                //m_rep.Put_Val(ClientData.name,        "START;BOR;WT;HA=C;VA=C;");
                m_rep.Put_Val(getClientName(ClientData.clientid, ClientData.dlcontrid),        "START;BOR;WT;HA=C;VA=C;");
                m_rep.Put_Val(ClientData.market_code,       "BOR;WT;HA=C;VA=C;");
                m_rep.Put_Val(ClientData.DepoTradeAcc,      "BOR;WT;HA=C;VA=C;");
                m_rep.Put_Val(ClientData.avr_name,          "BOR;WT;HA=C;VA=C;");
                m_rep.Put_Val(ClientData.seccode+"/"+
                              ClientData.isin,              "BOR;WT;HA=C;VA=C;");
                m_rep.Put_Val(ClientData.quantity,          "BOR;WT;HA=C;VA=C;T=M0");                
                m_rep.Put_Val(ClientData.limit_t0,          "BOR;WT;HA=C;VA=C;T=M0");
                m_rep.Put_Val(ClientData.limit_t1,          "BOR;WT;HA=C;VA=C;T=M0");
                m_rep.Put_Val(ClientData.limit_t2,          "BOR;WT;HA=C;VA=C;T=M0");
                m_rep.Put_Val(ClientData.is_blocked,  "END;BOR;WT;HA=C;VA=C;");


                i=i+1;
                UseProgress(i);
            end;
            RemProgress;
        else
            msgBox("За указанную дату нет рассчитанных лимитов по ценным бумагам");
        end;
    end;

    macro printRestAvrEuroclear()
        var query = " SELECT q.t_name, q.market_code, q.DepoTradeAcc, q.marketplace, q.avr_name, q.t_isin, q.clientid, q.contrid, q.t_dlcontrid,                             " +
                    "        sum(q.t_amount) t_amount, sum(q.t_amount + q.Plan_Plus_Deal - q.Plan_Minus_Deal) t_plan_amount                                                  " +
                    "  FROM(SELECT party.t_name,                                                                                                                             " +
                    "              dlcontrmp.t_mpcode  market_code,                                                                                                          " +
                    "              NVL(TRIM(RSB_STRUCT.GETSTRING(                                                                                                            " +
                    "                       rsi_rsb_kernel.GetNote(207, LPAD(dlcontrmp.t_dlcontrid, 34, '0'), 104, :beg_date1)))                                             " +
                    "                  ,CHR(1)) as DepoTradeAcc,                                                                                                             " +
                    "              nvl(marketplace.t_name,chr(1)) marketplace,                                                                                               " +
                    "              fininstr.t_name avr_name,                                                                                                                 " +
                    "              sfcontr.t_ID contrid,                                                                                                                     " +
                    "              avr.t_isin,                                                                                                                               " +
                    "              t.t_amount,                                                                                                                               " +
                    "              RSHB_RSI_SCLIMIT.GetSumPlanAvrRQ (party.t_partyid, sfcontr.t_ID,sfcontr.t_servkindsub,:beg_date2,to_Date('31.12.2019','dd.mm.yyyy'),      " +
                    "              t.t_FIID,1, NVL(dlcontrmp.t_marketid,-1)) AS Plan_Plus_Deal,                                                                              " +
                    "              RSHB_RSI_SCLIMIT.GetSumPlanAvrRQ (party.t_partyid, sfcontr.t_ID,sfcontr.t_servkindsub,:beg_date3,to_Date('31.12.2019','dd.mm.yyyy'),      " +
                    "              t.t_FIID,0, NVL(dlcontrmp.t_marketid,-1)) AS Plan_Minus_Deal,                                                                             " +
                    "              sfcontr.t_partyid clientid,                                                                                                               " +
                    "              dlcontrmp.t_dlcontrid                                                                                                                     " +
                    "         FROM dsfcontr_dbt sfcontr                                                                                                                      " +
                    "              LEFT JOIN dparty_dbt party ON party.t_partyid = sfcontr.t_partyid                                                                         " +
                    "              LEFT JOIN DDLCONTRMP_DBT dlcontrmp ON dlcontrmp.t_sfcontrid = sfcontr.t_id                                                                " +
                    "              JOIN v_scwrthistex t                                                                                                                      " +
                    "                 ON t.t_contract = sfcontr.t_id                                                                                                         " +
                    "                      AND t.t_instance = (SELECT MAX (t_instance)                                                                                       " +
                    "                                            FROM v_scwrthistex                                                                                          " +
                    "                                           WHERE     t_sumid = t.t_sumid                                                                                " +
                    "                                                 AND t_changedate <= :beg_date4)                                                                        " +
                    "                      AND t.t_amount > 0                                                                                                                " +
                    "                      AND t.t_state = 1                                                                                                                 " +
                    "              JOIN ddlrq_dbt rq ON T.T_DOCID = RQ.T_ID AND RQ.T_PLACEID = 72832 /*Euroclear*/                                                           " +
                    "              JOIN ddl_tick_dbt tick ON T.T_DEALID = TICK.T_DEALID                                                                                      " +
                    "              LEFT JOIN dparty_dbt marketplace ON tick.t_marketid = marketplace.t_partyid                                                               " +
                    "              JOIN dfininstr_dbt fininstr ON  t.t_fiid  = fininstr.t_fiid                                                                               " +
                    "              JOIN davoiriss_dbt avr ON t.t_fiid = avr.t_fiid                                                                                           " +
                    "        WHERE (sfcontr.t_dateclose > :beg_date5 or sfcontr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') )                                           ";

        if(m_params.clientid != -1)
            query = query + " AND  sfcontr.t_partyid = :clientid";
        end;

        if(m_params.sfcontrid != -1)
            query = query + " AND  sfcontr.t_id = :sfcontrid";
        end;

        query = query + ")q GROUP BY  market_code, t_name, DepoTradeAcc, marketplace, avr_name, t_isin, q.clientid, q.contrid, q.t_dlcontrid ORDER BY q.clientid, q.contrid, avr_name ";

        var cmd = DL_RSDCommand(query);
            cmd.AddParam(m_params.dateBegin);
            cmd.AddParam(m_params.dateBegin);
            cmd.AddParam(m_params.dateBegin);
            cmd.AddParam(m_params.dateBegin);
            cmd.AddParam(m_params.dateBegin);

        if(m_params.clientid != -1) 
            cmd.AddParam(m_params.clientid);           
        end;

        if(m_params.sfcontrid != -1) 
            cmd.AddParam(m_params.sfcontrid);           
        end;

        var cnt = cmd.GetCount();
        if(cnt)
            m_rep.Blank_Line();
            m_rep.Put_Str("Остатки по ценным бумагам на торговом счете депо Euroclear", "START;R=1;FB;HA=L;END;");
            m_rep.Put_Val("Клиент",                           "START;BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Код на Бирже",                     "BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Счет депо",                        "BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Торговая площадка",                "BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Краткое наименование бумаги",      "BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("ISIN",                             "BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Остаток штук (факт)",              "BOR;WT;HA=C;VA=C;");
            m_rep.Put_Val("Остаток с учетом будующих расчетов (план)","BOR;WT;HA=C;VA=C;END;");        

            var i=0;

            InitProgress(cnt, "Идет отбор данных", "Идет отбор данных");
            var ClientData = cmd.Execute();

            while(ClientData.movenext)
                //m_rep.Put_Val(ClientData.name,        "START;BOR;WT;HA=C;VA=C;");
                m_rep.Put_Val(getClientName(ClientData.clientid, ClientData.dlcontrid),        "START;BOR;WT;HA=C;VA=C;");
                m_rep.Put_Val(ClientData.market_code,       "BOR;WT;HA=C;VA=C;");
                m_rep.Put_Val(ClientData.DepoTradeAcc,      "BOR;WT;HA=C;VA=C;");
                m_rep.Put_Val(ClientData.marketplace,       "BOR;WT;HA=C;VA=C;");
                m_rep.Put_Val(ClientData.avr_name,          "BOR;WT;HA=C;VA=C;");
                m_rep.Put_Val(ClientData.isin,              "BOR;WT;HA=C;VA=C;");
                m_rep.Put_Val(ClientData.amount,            "BOR;WT;HA=C;VA=C;T=M0");                
                m_rep.Put_Val(ClientData.plan_amount,  "END;BOR;WT;HA=C;VA=C;T=M0");

                i=i+1;
                UseProgress(i);
            end;
            RemProgress;

        end;
    end;


    macro run()
        m_rep.Init("utf8", true);

        m_rep.Set_Column_Width(/* 1*/  150,
                               /* 2*/  100,
                               /* 3*/  150,
                               /* 4*/  150,
                               /* 5*/  150,
                               /* 6*/  80,
                               /* 7*/  80,
                               /* 8*/  80,
                               /* 9*/  80,
                               /*10*/  80);

        m_rep.Set_Landscape();
        m_rep.Set_Indent(0);

        m_rep.Print_Header("Остатки по денежным средствам и ценным бумагам", "Calibri", 9);

        m_Rep.Set_WrapText(0);
        m_rep.Put_Str("Остатки по денежным средствам и ценным бумагам клиентов на утро " + m_params.dateBegin,
                      "STEN;I=2;R=4;FB;");

        PrintRestMoney();
        PrintRestMoneyOffExchange();
        PrintRestAvr();
        printRestAvrEuroclear();

        m_Rep.Set_WrapText(1);

        m_rep.Print_Bottom();
        var m_CurrentRepName = "RestMoneyAndAvr_"+strsubst(strsubst(string(date():f) + string(time():f), ":",""),".","");

        var FullPath = GetRepFullPath(CreateOnTerm);
        var xmlNameFile = FullPath + string(m_CurrentRepName+".xml");
        var ShowFilePath = IIF(CreateOnTerm, "$", "") + FullPath;

        m_rep.Move(IIF(CreateOnTerm, "$", "") + xmlNameFile);


        var  resultFileName = m_CurrentRepName + ".xls";

        var  err = SC_ConvertToFormat(xmlNameFile, FullPath+resultFileName, SC_SRVREPFORMAT_EXCEL_XLSX, false);

        if(not err)
            SC_ShowFile(ShowFilePath, resultFileName);
        end;

        m_rep.Delete();        
    end;
end;

macro scroll_event(rs, cmd, id, key)
    if(cmd == DLG_KEY)
        if(key == 13)
            return CM_SELECT;
        end;
    end;
end;

class (TRsbPanel) ClientRestMoneyAndAvrPanel()
    InitTRsbPanel();
    setSize(55,6);
    setPosition(35,15);

    var currentContr,currentClient;

    class (TRsbEditField) EditField(typeFld: integer, x: integer, y: integer, width: integer, height: integer, bindVal, active: bool, fieldName: string, panel)
        var bindString = string(bindVal);
        
        initTRsbEditField(typeFld);
        setPosition(x, y);
        setSize(width, height);
        
        if(active == false) 
            editable = focusable = false; 
        end;

        if(typeFld == FT_STRING)
            bindValue( this, "bindString", 100 );
        elif(bindVal != null)
            value = bindVal; 
        end;

        if(panel != null)
            panel.addControl(this); 
        end;

        if(fieldName != null) 
            name = fieldName; 
        end;
    end;

    addLabel(TRsbLabel(3, 1, "Дата:"));
    var m_DateBegin = EditField( FT_DATE, 10, 1, 20, 1, {curdate}, true, "Date", this );

    addLabel(TRsbLabel(3, 3, "Клиент:"));
    var m_EditField2 = EditField( FT_STRING, 10, 3, 20, 1, "Все", true,  "Client", this );
    var m_ClientName = EditField( FT_STRING, 31, 3, 20, 1, "",    false, "ClientName", this );

    addLabel(TRsbLabel(3, 4, "Договор:"));
    var m_EditField3 = EditField( FT_STRING, 10, 4, 20, 1, "Все", true, "Contr", this );

    m_EditField2.addEventHandler(RSB_EV_KEY_PRESSED, R2M(this, "EditField_KEY_PRESSED"));
    m_EditField3.addEventHandler(RSB_EV_KEY_PRESSED, R2M(this, "EditField_KEY_PRESSED"));
    m_DateBegin.addEventHandler(RSB_EV_KEY_PRESSED,  R2M(this, "DATEBEGIN_KEY_PRESSED"));
    m_EditField3.addEventHandler(RSB_EV_REMOVE_FOCUS, R2M(this, "EditField_EXIT"));
    m_EditField2.addEventHandler(RSB_EV_REMOVE_FOCUS, R2M(this, "EditField_EXIT"));
    addEventHandler(RSB_EV_KEY_PRESSED, R2M(this, "Panel_ButtonEvent"));

    PRIVATE MACRO AddCol (ar,ind, fld, head, width, rdonly, ty, dp)
        ar.value (ind * 6)     = fld;
        ar.value (ind * 6 + 1) = head;
        ar.value (ind * 6 + 2) = width;
        ar.value (ind * 6 + 3 ) = rdonly;   // fldType
        ar.value (ind * 6 + 4 ) = dp;//   decPoint
        ar.value (ind * 6 + 5 ) = 0;   // reserv
    END;

    macro getContrList()
        var query = " SELECT party.t_partyid, code.t_code, party.t_name, sf.t_number, dlcon.t_dlcontrid, sf.t_id "
                  + "   FROM dsfcontr_dbt sf, "
                  + "        ddlcontrmp_dbt dlcon, "
                  + "        dparty_dbt party, "
                  + "        dpartcode_dbt code "
                  + "  WHERE     sf.t_id = dlcon.t_sfcontrid "
                  + "        AND party.t_partyid = sf.t_partyid "
                  + "        AND party.t_partyid =code.t_partyid "
                  + "        AND code.t_codekind = 1 and code.t_state = 0 ";
        if (ValType(CurrentClient) != V_UNDEF)
           query = query + "        AND party.t_partyid = " + currentClient.value("t_partyid");
        end;

        var col = TArray;   
        var arnum = -1;
        AddCol (col, arnum=arnum+1, "t_code",    "Код",          10,  0,0);
        AddCol (col, arnum=arnum+1, "t_number",  "Номер",        50,  0,0);
        AddCol (col, arnum=arnum+1, "t_name",    "Клиент",       30,  0,0);
        AddCol (col, arnum=arnum+1, "t_partyid", "Идентификатор",20,  0,0);

        var cmd = RsdCommand(query);
        var rs = RsdRecordSet(cmd, rsdval_client, rsdval_static);
        if(RunScroll(rs, arnum+1, col, null ,"scroll_event","Договоры"))
            currentContr = rs;
            return true;
        end;

        return false;
    end;

    macro getClientsList()
        var query = " SELECT party.t_partyid, code.t_code, party.t_name "
                  + "   FROM dparty_dbt party, "
                  + "        dpartcode_dbt code, "
                  + "        dsfcontr_dbt sf "
                  + "  WHERE party.t_partyid =code.t_partyid "
                  + "        AND code.t_codekind = 1 and code.t_state = 0 "
                  + "        AND sf.t_partyid = party.t_partyid and sf.t_servkind = 1  "
                  + "        GROUP BY party.t_partyid, code.t_code, party.t_name ";
        var col = TArray;   
        var arnum = -1;
        AddCol (col, arnum=arnum+1, "t_code",    "Код",          10,  0,0);
        AddCol (col, arnum=arnum+1, "t_name",    "Клиент",       30,  0,0);
        AddCol (col, arnum=arnum+1, "t_partyid", "Идентификатор",20,  0,0);

        var cmd = RsdCommand(query);
        var rs = RsdRecordSet(cmd, rsdval_client, rsdval_static);
        if(RunScroll(rs, arnum+1, col, null ,"scroll_event","Клиенты"))
            currentClient = rs;
            return true;
        end;

        return false;
    end;

    macro findContr()
        var query = " SELECT party.t_partyid, code.t_code, party.t_name, sf.t_number, dlcon.t_dlcontrid, sf.t_id "
                  + "   FROM dsfcontr_dbt sf, "
                  + "        ddlcontrmp_dbt dlcon, "
                  + "        dparty_dbt party, "
                  + "        dpartcode_dbt code "
                  + "  WHERE     sf.t_id = dlcon.t_sfcontrid "
                  + "        AND sf.t_number = '" + m_EditField3.value + "'"
                  + "        AND party.t_partyid = sf.t_partyid "
                  + "        AND party.t_partyid =code.t_partyid "
                  + "        AND code.t_codekind = 1 and code.t_state = 0 ";

        var cmd = RsdCommand(query);
        var rs = RsdRecordSet(cmd, rsdval_client, rsdval_static);
        if(rs.movenext)
            currentClient = rs;
            currentContr = rs;
            return true;
        end;
        return false;
    end;

    macro findClient()
        var query = " SELECT party.t_partyid, code.t_code, party.t_name, sf.t_number, dlcon.t_dlcontrid, sf.t_id "
                  + "   FROM dsfcontr_dbt sf, "
                  + "        ddlcontrmp_dbt dlcon, "
                  + "        dparty_dbt party, "
                  + "        dpartcode_dbt code "
                  + "  WHERE     sf.t_id = dlcon.t_sfcontrid "
                  + "        AND code.t_code = '" + trim(m_EditField2.value) + "'"
                  + "        AND party.t_partyid = sf.t_partyid "
                  + "        AND party.t_partyid =code.t_partyid "
                  + "        AND code.t_codekind = 1 and code.t_state = 0 ";

        var cmd = RsdCommand(query);
        var rs = RsdRecordSet(cmd, rsdval_client, rsdval_static);
        if(rs.movenext)
            currentClient = rs;

            return true;
        end;
        return false;
    end;

    macro EditField_KEY_PRESSED(RsbEvent)
       if(RsbEvent.keyCode == 317)
          if (RsbEvent.Source.Name == "Contr")
             if (getContrList())
                m_EditField2.value = currentContr.value("t_code");
                m_ClientName.value = currentContr.value("t_name");
                m_EditField3.value = currentContr.value("t_number");
             end;
          elif (RsbEvent.Source.Name == "Client")
             if (getClientsList())
                m_EditField2.value = currentClient.value("t_code");
                m_ClientName.value = currentClient.value("t_name");
                m_EditField3.value = "Все";
             end;
          end;
       elif(RsbEvent.keyCode == 27)
          close(0);
       end

    end;

    macro EditField_EXIT(RsbEvent)
        if (RsbEvent.Source.Name == "Contr")
           if (trim(m_EditField3.value) == "")
              m_EditField3.value = "Все";
              currentContr = null;
           else
              if(trim(m_EditField3.value) != "Все")
                  if (findContr())
                     m_EditField2.value = currentContr.value("t_code");
                     m_ClientName.value = currentContr.value("t_name");
                     m_EditField3.value = currentContr.value("t_number");
                  else
                     m_EditField3.value = "";
                     currentContr = null;
                  end;
              end;
           end;
        elif (RsbEvent.Source.Name == "Client")
           if (trim(m_EditField2.value) == "")
              m_EditField2.value = "Все";
              m_ClientName.value = "";
              currentClient = null;
           else
              if((trim(m_EditField2.value) != "Все") AND findClient())
                 m_ClientName.value = currentClient.value("t_name");              
              end;
           end;
        end;
    end;

    macro Panel_ButtonEvent(RsbEvent)
       if(RsbEvent.keyCode == 316)
           var RepParams = ReportParams();
           RepParams.dateBegin = m_DateBegin.value;
           if (CurrentContr)
              RepParams.dlcontrid = currentContr.value("t_dlcontrid");
              RepParams.sfcontrid = currentContr.value("t_id");  
              RepParams.clientid  = currentContr.value("t_partyid");
           elif(currentClient)
              RepParams.dlcontrid = -1;
              RepParams.sfcontrid = -1;
              RepParams.clientid  = currentClient.value("t_partyid");
           else
              RepParams.dlcontrid = -1;
              RepParams.sfcontrid = -1;
              RepParams.clientid  = -1;
           end;

           CClientRestMoneyAndAvr_Report(RepParams).run();
       end;
    end;

    macro DATEBEGIN_KEY_PRESSED(RsbEvent)
       if(RsbEvent.keyCode == 317)
           m_DateBegin.value = GetDateByCalendar(m_DateBegin.value);
       end;
    end;
end;

var panel = ClientRestMoneyAndAvrPanel();
panel.setCaption("Остатки по денежным средствам и ценным бумагам клиентов на утро");
panel.setStatus("~F2~ Запуск");
panel.run;
exit(1);