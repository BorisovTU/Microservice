/*
$Name:        w475_Client.mac
$Module:      Ценные бумаги
$Description: Отчет о результатах брокерского обслуживания для клиента
$Programmer:  Чуйков Д.
*/
import BankInter, ReportUser;
import "DlRepForm_h.mac", "globals.mac", rsd, dlquery;

/*Номера полей в форме отчета*/
CONST P_W475_CLIENT_REPDATE = 0,
      P_W475_CLIENT_NAME    = 1;
CONST DL_PNFLD_REPDATE = 0,
      DL_PNFLD_CLIENTNAME = 1;

PRIVATE CONST BROKERREP_DL_SETTLOPER = 2030; //Расчетная операция ВУ

/*Установка значений в панели*/
private macro SetName(pThis:DL_CPanel)
    var rscmd, rscnt;
    rscmd = null;
    rscmd = DL_RSDCommand("select count(t_contrid) cnt, t_clientname from dset_sfc_u_tmp group by t_clientname");
    rscnt = rscmd.Execute();
    rscnt.movenext();
    if (rscnt.value("cnt") == 0)
        pThis.SetLinkedValue(DL_PNFLD_CLIENTNAME, STR_ALLVALUE);
    else
        pThis.SetLinkedValue(DL_PNFLD_CLIENTNAME, rscnt.value("t_clientname"));
    end;
end;

/*Выбор клиентов*/
macro SelectClient(RepDate)
    /*Обработчик скроллинга*/
    macro Client_Scroll(rs, cmd, id, key)
        if (cmd == DLG_KEY)
            if (key == 13) /*Enter*/
                //выбрали клиента, заполним таблицу договоров
                SQL_Execute("delete from dset_sfc_u_tmp");
                SQL_Execute("insert into dset_sfc_u_tmp(t_setflag, t_clientid, t_clientname, t_contrid, t_contrnumber, t_contrname, t_contrdate) "
                          + "select chr(88), party.t_partyid, party.t_name, sfcontr.t_id, sfcontr.t_number, sfcontr.t_name, sfcontr.t_datebegin "
                          + "from   ddlcontr_dbt dlcontr "
                          + "  join dsfcontr_dbt sfcontr on sfcontr.t_id = dlcontr.t_sfcontrid and "
                          + "                               sfcontr.t_datebegin <= " + GetSQLDate(RepDate) + " and "
                          + "                               (sfcontr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') or "
                          + "                                sfcontr.t_dateclose >= " + GetSQLDate(RepDate) + ") "
                          + "  join dparty_dbt party on party.t_partyid = sfcontr.t_partyid "
                          + "where party.t_partyid = "+rs.value("t_clientid") );
        
                return CM_SELECT;
            elif (key == 27) /*Esc*/
                return CM_CANCEL;
            end;
        end;
    end;

    var rs, cmd;
    var que =  "select party.t_partyid t_clientid, party.t_name t_clientname "
             + "from   ddlcontr_dbt dlcontr "
             + "  join dsfcontr_dbt sfcontr on sfcontr.t_id = dlcontr.t_sfcontrid and "
             + "                               sfcontr.t_datebegin <= " + GetSQLDate(RepDate) + " and "
             + "                               (sfcontr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') or "
             + "                                sfcontr.t_dateclose >= " + GetSQLDate(RepDate) + ") "
             + "  join dparty_dbt party on party.t_partyid = sfcontr.t_partyid "
             + "group by party.t_partyid, party.t_name "
             + "order by party.t_name ";

    cmd = RsdCommand(que);
    rs = RSDRecordset(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);

    var colArr = MakeArray("t_clientname", "Наименование клиента", 100, 2, -1, 0,
                           "t_clientid", "ИД клиента", 8, 2, -1, 0);

    RunScroll(rs, 2, colArr, null, "Client_Scroll", "Выбор клиента", "~Esc~ Выход ~Enter~ Выбрать", false);
end;

private MACRO DL_FldProc_Client( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
    if (Cmd == DLG_INIT)
        var rscmd, rscnt;
        rscmd = DL_RSDCommand("select count(1) cnt from dset_sfc_u_tmp");
        rscnt = rscmd.Execute();
        rscnt.movenext();
        if (rscnt.value("cnt") == 0)
            SQL_Execute("delete from dset_sfc_u_tmp");
            FldShowValue = STR_ALLVALUE;
        else
            SetName(pThis);
            FldShowValue = pThis.GetLinkedValue(DL_PNFLD_CLIENTNAME);
        end;
    elif ((Cmd == DLG_KEY) AND (Key == KEY_SPACE))
        if (pThis.GetLinkedValue(DL_PNFLD_CLIENTNAME) != STR_ALLVALUE)
            SQL_Execute("delete from dset_sfc_u_tmp");
            pThis.SetLinkedValue(DL_PNFLD_CLIENTNAME, STR_ALLVALUE);
            FldShowValue = STR_ALLVALUE;
        end;
    elif ((Cmd == DLG_KEY) AND (Key == KEY_F3))
        SelectClient(pThis.GetLinkedValue(DL_PNFLD_REPDATE));
        SetName(pThis);
        FldShowValue = pThis.GetLinkedValue(DL_PNFLD_CLIENTNAME);
    end;
    FldRealValue = FldShowValue;

    return CM_DEFAULT;
END;

/*Дата выпуска отчета*/
private MACRO DL_FldProc_RepDate( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
    if (Cmd == DLG_INIT) /*Установка значения в поле*/
        if (FldRealValue == null) /*инициализация по умолчанию*/
            FldRealValue = {curdate};
        end;
        FldShowValue = FldRealValue;
    elif (Cmd == DLG_CHANGEVALUE) /*значение поля было изменено*/
        FldRealValue = FldShowValue;
        SQL_Execute("delete from dset_sfc_u_tmp");
        pThis.SetLinkedValue(DL_PNFLD_CLIENTNAME, STR_ALLVALUE);
    elif ((Cmd == DLG_KEY) AND (Key == KEY_F3)) /*Вызов листалки и заполнение FldShowValue и FldRealValue*/
        FldRealValue = GetDateByCalendar( FldRealValue );
        FldShowValue = FldRealValue;
    end;

    return CM_DEFAULT;
END;

CLASS (DL_CPanel) W475_Client_Panel()
    PRIVATE MACRO Init()
        AddFieldProc(0, P_W475_CLIENT_REPDATE,  DL_PNFLD_REPDATE,    @DL_FldProc_RepDate, {curdate});
        AddFieldProc(0, P_W475_CLIENT_NAME,     DL_PNFLD_CLIENTNAME, @DL_FldProc_Client);
    END;

    PRIVATE MACRO Check():BOOL
        //заполним договора клиентов перед запуском
        if (this.GetLinkedValue(DL_PNFLD_CLIENTNAME) == STR_ALLVALUE)
            SQL_Execute("delete from dset_sfc_u_tmp");
            SQL_Execute("insert into dset_sfc_u_tmp(t_setflag, t_clientid, t_clientname, t_contrid, t_contrnumber, t_contrname, t_contrdate) "
                      + "select chr(88), party.t_partyid, party.t_name, sfcontr.t_id, sfcontr.t_number, sfcontr.t_name, sfcontr.t_datebegin "
                      + "from ddlcontr_dbt dlcontr "
                      + "  join dsfcontr_dbt sfcontr on sfcontr.t_id = dlcontr.t_sfcontrid and "
                      + "                               sfcontr.t_datebegin <= " + GetSQLDate(this.GetLinkedValue(DL_PNFLD_REPDATE)) + " and "
                      + "                               (sfcontr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') or "
                      + "                                sfcontr.t_dateclose >= " + GetSQLDate(this.GetLinkedValue(DL_PNFLD_REPDATE)) + ") "
                      + "  join dparty_dbt party on party.t_partyid = sfcontr.t_partyid " );
        end;

        return true;
    END;

    initDL_CPanel("ReportUserPanels.lbr", "W475-2"); 
END;

/**********************************************************************************************/


//Определим дату рождения для клиента по договору, если нет то пусто
PRIVATE MACRO GetAgeClient(sfc_id, repDate)
    var sql, rs, cmd;
    sql =  "SELECT decode(nvl(pt.t_born,to_date('01010001','ddmmyyyy')), "
         + "              to_date('01010001','ddmmyyyy'), "
         + "              ' ', "
         + "              trunc(months_between( :dt ,nvl(pt.t_born,to_date('01010001','ddmmyyyy')))/12)) AS age "
         + "FROM W475_TMP t "
         + "  JOIN dsfcontr_dbt sfc ON t.t_sfcontrid = sfc.t_id "
         + "  LEFT JOIN dpersn_dbt pt ON pt.t_personid = sfc.t_partyid "
         + "WHERE t.t_sfcontrid = :id ";
         
    cmd = RsdCommand(sql);
    cmd.AddParam("dt", RSDBP_IN, repDate);
    cmd.AddParam("id", RSDBP_IN, sfc_id);
    rs = RsdRecordSet(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);
   
    if (rs and rs.MoveNext())
        if (valtype(rs.value("age")) != V_UNDEF)
            return rs.value("age");
        end;
    end;
   
    return "";
END;

//Определим пол для клиента по договору
PRIVATE MACRO GetClientGender(sfc_id)
    var sql, rs, cmd;
    sql =  "SELECT decode(pt.t_ismale,chr(0),'жен.',chr(88),'муж.','Не заполнено') AS gender " 
         + "FROM W475_TMP t " 
         + "  JOIN dsfcontr_dbt sfc ON t.t_sfcontrid = sfc.t_id " 
         + "  LEFT JOIN dpersn_dbt pt ON pt.t_personid = sfc.t_partyid " 
         + "WHERE t.t_sfcontrid = :id ";
         
    cmd = RsdCommand(sql);
    cmd.AddParam("id", RSDBP_IN, sfc_id);
    rs = RsdRecordSet(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);
   
    if (rs and rs.MoveNext())
        return rs.value("gender");
    end;
   
    return "Не заполнено";
END;

/**********************************************************************************************/

PRIVATE CLASS (TX_ReportUser) W475_Client_Report
    var m_BeginDate, m_DateEnd;

    /*Создание отчета*/
    PRIVATE MACRO Create()

        /*Точка входа*/
        var query, row = 0, dlcontrid = 0;
        var m_dognum = 0, m_contrnumber, m_clientname, m_restperc, m_borndate = "", m_gender = "", m_age;
        var m_DS;
        var errmsg;

        /*Даты начала и окончания периода отчета*/
        m_BeginDate = FormData.RepDate;
        m_DateEnd   = FormData.RepDate;
    
        RSDCommand("delete W475_TMP").execute();
        query =  " INSERT INTO W475_TMP (t_dlcontrid,t_sfcontrid,t_contrnumber,t_contrdatebegin,t_planname,t_clientname,t_clientcode,t_depname,t_marketname,"
               + "                       t_sfcontridsm,t_sfcontridfm,t_sfcontridom,t_sfcontridcm,t_depcode, T_FINNAME, T_DS_PLUS, T_DS_MINUS, T_TURNSUM, "
               + "                       T_TURNSUMREPO, T_TURNSUMSVOP, T_DS_IN, T_DS_OUT, T_P_PLUS, T_P_MINUS, T_P_IN, T_P_OUT, T_COMSUM, T_COMSUMREPO, "
               + "                       T_SPECIAL_REPO, T_COMSUMSVOP, T_VAL_SVOP) "
               + " (select t_dlcontrid, t_sfcontrid, t_contrnumber, t_contrdatebegin, t_planname, t_clientname, t_clientcode, t_depname, t_marketname, "
               + "     t_sfcontridsm, t_sfcontridfm, t_sfcontridom, t_sfcontridcm, t_depcode, chr(1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 "
               + "  from (select /*+ USE_NL(SFCONTRCM,SFCONTROM,SFCONTRFM,SFCONTRSM,DP_DEP) */ t_dt1, t_dt2, "
               + "           t_dlcontrid, t_department, t_partyid, nvl(t_sfcontridsm, nvl(t_sfcontridsm, nvl(t_sfcontridom, t_sfcontridcm))) t_sfcontrid, "
               + "           t_contrnumber, t_contrdatebegin, t_planname, t_clientname, t_clientcode, t_marketname, "
               + "           (select ptdep.t_name " 
               + "            from dparty_dbt ptdep, ddp_dep_dbt dpdep "
               + "            where dpdep.t_name = t_depcode "
               + "               and dpdep.t_partyid = ptdep.t_partyid "
               + "           ) t_depname, "
               + "           t_depcode, " 
               + "           nvl(t_sfcontridsm, 0) t_sfcontridsm, "
               + "           nvl(t_sfcontridfm, 0) t_sfcontridfm, "
               + "           nvl(t_sfcontridom, 0) t_sfcontridom, "
               + "           nvl(t_sfcontridcm, 0) t_sfcontridcm  "
               + "        from (select t_dt1, t_dt2, "
               + "                 dlcontr.t_dlcontrid t_dlcontrid, "
               + "                 sfcontr.t_id t_sfcontrid, "
               + "                 sfcontr.t_department t_department, "
               + "                 sfcontr.t_partyid t_partyid, "
               + "                 sfcontr.t_number t_contrnumber, "
               + "                 sfcontr.t_datebegin t_contrdatebegin, "
               + "                 nvl(sfplan.t_name,chr(1)) t_planname, "
               + "                 nvl(party.t_name,chr(1)) t_clientname, "
               + "                 nvl((select t_code from dobjcode_dbt "
               + "                      where t_objecttype = 207 and t_codekind = 1 and t_state = 0 "
               + "                        and t_objectid = dlcontrmp.t_dlcontrid),chr(1)) t_clientcode, "
               + "                 case when SubStr(sfcontr.t_number,3,1) = '-' or SubStr(sfcontr.t_number,3,1) = '/' then  "
               + "                           SubStr( sfcontr.t_number,1,2) else '00' end||'00' t_depcode, "
               + "                 case when sfcontrsm.t_id is not null then 'Фондовый' "
               + "                      when sfcontrfm.t_id is not null then 'Срочный' "
               + "                      when sfcontrom.t_id is not null then 'Внебиржевой' "
               + "                      when sfcontrcm.t_id is not null then 'Валютный' "
               + "                      else chr(1) end t_marketname, "
               + "                 sfcontrsm.t_id t_sfcontridsm, "
               + "                 sfcontrfm.t_id t_sfcontridfm, "
               + "                 sfcontrom.t_id t_sfcontridom, "
               + "                 sfcontrcm.t_id t_sfcontridcm "
               + "              from dsfcontr_dbt sfcontr "
               + "                join (select ? t_dt1, ? t_dt2 from dual) on 1 = 1 and sfcontr.t_partyid != 1 "
               + "                join dset_sfc_u_tmp set_sfc_u on set_sfc_u.t_contrid = sfcontr.t_id and "
               + "                                                 set_sfc_u.t_setflag = chr(88) "
               + "                join ddlcontr_dbt dlcontr on dlcontr.t_sfcontrid = sfcontr.t_id "
               + "                join ddlcontrmp_dbt dlcontrmp on dlcontrmp.t_dlcontrid = dlcontr.t_dlcontrid "
               + "                left join dparty_dbt party on party.t_partyid = sfcontr.t_partyid "
               + "                left join dsfcontrplan_dbt sfcontrplan on sfcontrplan.t_sfcontrid = dlcontrmp.t_sfcontrid and "
               + "                                                          sfcontrplan.t_begin <= t_dt2 and "
               + "                                                          (sfcontrplan.t_end = to_date('01.01.0001','dd.mm.yyyy') or "
               + "                                                           sfcontrplan.t_end >= t_dt2) "
               + "                left join dsfplan_dbt sfplan on sfplan.t_sfplanid = sfcontrplan.t_sfplanid "
               + "                left join dobjcode_dbt objcode on objcode.t_objecttype = 3 and "
               + "                                                  objcode.t_codekind = 8 and "
               + "                                                  objcode.t_objectid = party.t_partyid and "
               + "                                                  objcode.t_bankdate <= t_dt2 and "
               + "                                                  (objcode.t_bankclosedate = to_date('01.01.0001','dd.mm.yyyy') or "
               + "                                                   objcode.t_bankclosedate >= t_dt2) "
               + "                left join ddp_dep_dbt dp_dep on dp_dep.t_code = sfcontr.t_department "
               + "                left join dsfcontr_dbt sfcontrsm on sfcontrsm.t_id = dlcontrmp.t_sfcontrid and "
               + "                                                    sfcontrsm.t_servkind = 1/*Фондовый дилинг*/ and "
               + "                                                    sfcontrsm.t_servkindsub = 8/*Биржевой рынок*/ "
               + "                left join dsfcontr_dbt sfcontrfm on sfcontrfm.t_id = dlcontrmp.t_sfcontrid and "
               + "                                                    sfcontrfm.t_servkind = 15/*Срочные контракты*/ and "
               + "                                                    sfcontrfm.t_servkindsub = 8/*Биржевой рынок*/ "     
               + "                left join dsfcontr_dbt sfcontrom on sfcontrom.t_id = dlcontrmp.t_sfcontrid and "
               + "                                                    sfcontrom.t_servkind = 1/*Фондовый дилинг*/ and "
               + "                                                    sfcontrom.t_servkindsub = 9/*Внебиржевой рынок*/ "
               + "                left join dsfcontr_dbt sfcontrcm on sfcontrcm.t_id = dlcontrmp.t_sfcontrid and "
               + "                                                    sfcontrcm.t_servkind = 21/*Валютный дилинг*/) "       
               + "        where (   t_sfcontridsm is not null or t_sfcontridfm is not null "
               + "               or t_sfcontridom is not null or t_sfcontridcm is not null )) )";

        m_DS = RSDCommand(query);
        m_DS.AddParam("dt1", RSDBP_IN, m_BeginDate);
        m_DS.AddParam("dt2", RSDBP_IN, m_DateEnd);
    
        InitProgress(5, "Формирование отчета", "Формирование отчета");
        message("0/5 Отбор данных");
        m_DS.Execute();

    
        /* 2 Обновление временной таблицы */
        var cmdUpdateTmp;
        cmdUpdateTmp = RsdCommand(
                 "UPDATE W475_TMP W475                                                              " +
                 "   SET t_Sfcontrid =                                                              " +
                 "       (select max(sfcontr.t_id)                                                  " +
                 "        From dsfcontr_dbt sfcontr,                                                " +
                 "             dsfcontr_dbt sfcontr2,                                               " +
                 "             ddlcontr_dbt dlcontr                                                 " +
                 "        where sfcontr.t_ServKind in (15 /*15 Срочные контракты (ФИССИКО)*/)       " + 
                 "          and (sfcontr.t_DateClose = to_date('01.01.0001', 'dd.mm.yyyy') or       " +
                 "              sfcontr.t_DateClose >= ?)                                           " +
                 "          and sfcontr2.t_ServKind = 0                                             " +
                 "          and (sfcontr2.t_DateClose = to_date('01.01.0001', 'dd.mm.yyyy') or      " +
                 "              sfcontr2.t_DateClose >= ?)                                          " +
                 "          and sfcontr2.t_id = dlcontr.t_sfcontrid                                 " +
                 "          and dlcontr.t_dlcontrid = W475.T_dlcontrid                              " +
                 "          and sfcontr.t_id in (select contr.T_SFCONTRID from DDLCONTRMP_DBT contr " +
                 "                              where contr.t_dlcontrid =  dlcontr.t_dlcontrid) )   " +
                 "where W475.t_Sfcontrid is null ");

        cmdUpdateTmp.AddParam("", RSDBP_IN, m_DateEnd);
        cmdUpdateTmp.AddParam("", RSDBP_IN, m_DateEnd);
        message("1/5 Подготовка");
        UseProgress(1);
        cmdUpdateTmp.execute();


        /* 3  t_ds_in */
        message("2/5  Расчет сумм");
        cmdUpdateTmp = RsdCommand(
                 " MERGE INTO W475_TMP W475                                                                                 " +
                 "   using (                                                                                                " +
                 "          select t_id, rest_out,                                                                          " +
                 "            case when REST_OUT_RUB >= 0 and REST_OUT_VAL >= 0 then REST_OUT_RUB                           " +
                 "                 when REST_OUT_RUB <= 0 and REST_OUT_VAL <= 0 then ABS(REST_OUT_RUB)                      " +
                 "                 when REST_OUT_RUB > 0 and REST_OUT_RUB+REST_OUT_VAL >= 0 then REST_OUT_RUB+REST_OUT_VAL  " +
                 "                 when REST_OUT_RUB < 0 and REST_OUT_RUB+REST_OUT_VAL <= 0 then ABS(REST_OUT_RUB+REST_OUT_VAL) " +
                 "                 else 0 end REST_OUT_RUB,                                                                 " +
                 "            case when REST_OUT_VAL >= 0 and REST_OUT_RUB >= 0 then REST_OUT_VAL                           " +
                 "                 when REST_OUT_VAL <= 0 and REST_OUT_RUB <= 0 then ABS(REST_OUT_VAL)                      " +
                 "                 when REST_OUT_VAL > 0 and REST_OUT_RUB+REST_OUT_VAL >= 0 then REST_OUT_RUB+REST_OUT_VAL  " +
                 "                 when REST_OUT_VAL < 0 and REST_OUT_RUB+REST_OUT_VAL <= 0 then ABS(REST_OUT_RUB+REST_OUT_VAL) " +
                 "                 else 0 end REST_OUT_VAL                                                                  " +
                 "          from (                                                                                          " +
                 "                select t_id, ABS(sum(rest_out)) rest_out,                                                 " +
                 "                  sum(REST_OUT_RUB) REST_OUT_RUB, sum(REST_OUT_VAL) REST_OUT_VAL                          " +
                 "                from (                                                                                    " +
                 "                      SELECT sf.t_id,                                                                     " +
                 "                        NVL (SUM (RSB_FIInstr.ConvSum (                                                   " +
                 "                                        RSB_ACCOUNT.RESTALL (a.t_account,a.t_chapter,a.t_code_currency,?) " +
                 "                                           ,a.t_code_currency,0,?,1)),0) rest_out,                        " +
                 "                        NVL (SUM (decode (a.t_code_currency,0,                                            " +
                 "                                           RSB_ACCOUNT.RESTALL (a.t_account,a.t_chapter,a.t_code_currency,?), " +
                 "                                          0) ),0) REST_OUT_RUB,                                           " +
                 "                        NVL (SUM (decode (a.t_code_currency,0, 0,                                         " +
                 "                                           RSB_FIInstr.ConvSum (                                          " +
                 "                                               RSB_ACCOUNT.RESTALL (a.t_account,a.t_chapter,a.t_code_currency,?) " +
                 "                                                  ,a.t_code_currency,0,?,1))),0) REST_OUT_VAL,            " +
                 "                        decode (a.t_code_currency,0, 0, 1) val                                            " +
                 "                      FROM dsettacc_dbt s,                                                                " +
                 "                           dsfssi_dbt ss,                                                                 " +
                 "                           dsfcontr_dbt sf,                                                               " +
                 "                           daccount_dbt a                                                                 " +
                 "                      WHERE   s.t_settaccid = ss.t_setaccid                                               " +
                 "                          AND ss.t_objecttype = 659                                                       " +
                 "                          AND ss.t_objectid = sf.t_id                                                     " +
                 "                          AND a.t_account = s.t_account                                                   " +
                 "                          AND a.t_chapter = s.t_chapter                                                   " +
                 "                          AND a.t_chapter = 1                                                             " +
                 "                          AND sf.t_id in (select t_sfcontrid from W475_TMP)                               " + 
                 "                      group by sf.t_id,a.t_code_currency)                                                 " +
                 "                group by t_id)                                                                            " +
                 "         ) R                                                                                              " +
                 "  ON (R.t_id = W475.T_sfcontrid)                                                                          " +
                 "  WHEN MATCHED THEN                                                                                       " +
                 "    UPDATE SET W475.T_DS_OUT     = R.REST_OUT,                                                            " +
                 "               W475.T_COMSUM     = R.REST_OUT_RUB,                                                        " +
                 "               W475.T_COMSUMREPO = R.REST_OUT_VAL "); 

        cmdUpdateTmp.AddParam("", RSDBP_IN, m_DateEnd);
        cmdUpdateTmp.AddParam("", RSDBP_IN, m_DateEnd);
        cmdUpdateTmp.AddParam("", RSDBP_IN, m_DateEnd);
        cmdUpdateTmp.AddParam("", RSDBP_IN, m_DateEnd);
        cmdUpdateTmp.AddParam("", RSDBP_IN, m_DateEnd);
        UseProgress(2);
        cmdUpdateTmp.execute();
                     

        /* 4  t_ds_out */
        message("3/5  Расчет сумм");
        cmdUpdateTmp = RsdCommand(
                 " MERGE INTO W475_TMP W475                                                                                                  " +
                 "  using (                                                                                                                  " +
                 "         select t_id, rest_out,                                                                                            " +
                 "            case when REST_OUT_RUB >= 0 and REST_OUT_VAL >= 0 then REST_OUT_RUB                                            " +
                 "                 when REST_OUT_RUB <= 0 and REST_OUT_VAL <= 0 then ABS(REST_OUT_RUB)                                       " +
                 "                 when REST_OUT_RUB > 0 and REST_OUT_RUB+REST_OUT_VAL >= 0 then REST_OUT_RUB+REST_OUT_VAL                   " +
                 "                 when REST_OUT_RUB < 0 and REST_OUT_RUB+REST_OUT_VAL <= 0 then ABS(REST_OUT_RUB+REST_OUT_VAL)              " +
                 "                 else 0 end REST_OUT_RUB,                                                                                  " +
                 "            case when REST_OUT_VAL >= 0 and REST_OUT_RUB >= 0 then REST_OUT_VAL                                            " +
                 "                 when REST_OUT_VAL <= 0 and REST_OUT_RUB <= 0 then ABS(REST_OUT_VAL)                                       " +
                 "                 when REST_OUT_VAL > 0 and REST_OUT_RUB+REST_OUT_VAL >= 0 then REST_OUT_RUB+REST_OUT_VAL                   " +
                 "                 when REST_OUT_VAL < 0 and REST_OUT_RUB+REST_OUT_VAL <= 0 then ABS(REST_OUT_RUB+REST_OUT_VAL)              " +
                 "                 else 0 end REST_OUT_VAL                                                                                   " +
                 "         from (                                                                                                            " +
                 "               select t_id, ABS(sum(rest_out)) rest_out,sum(REST_OUT_RUB) REST_OUT_RUB,sum(REST_OUT_VAL) REST_OUT_VAL      " +
                 "               from (                                                                                                      " +
                 "                     select sfcontr.t_id t_id,                                                                             " +
                 "                       nvl(sum(rsb_account.restall(acc.t_account, acc.t_chapter, acc.t_code_currency, ? , 0)),0) REST_OUT, " +
                 "                       nvl(sum(decode(acc.t_code_currency,0,                                                               " +
                 "                                       rsb_account.restall(acc.t_account, acc.t_chapter, acc.t_code_currency, ? , 0),0)    " +
                 "                           ),0) REST_OUT_RUB,                                                                              " +
                 "                       nvl(sum(decode(acc.t_code_currency,0,0,                                                             " +
                 "                                       rsb_account.restall(acc.t_account, acc.t_chapter, acc.t_code_currency, ? , 0))      " +
                 "                           ),0) REST_OUT_VAL,                                                                              " +
                 "                       decode (acc.t_code_currency,0, 0, 1) val                                                            " +
                 "                     from dsfssi_dbt ssi                                                                                   " +
                 "                       join dsettacc_dbt sa on sa.t_SettAccID = ssi.t_SetAccID                                             " +
                 "                       join daccount_dbt acc on acc.t_Account = sa.t_Account and                                           " +
                 "                                                acc.t_Chapter = sa.t_Chapter and                                           " +
                 "                                                acc.t_Code_Currency = sa.t_FIID                                            " +
                 "                       join dsfcontr_dbt sfcontr on sfcontr.t_ServKind in (15/*15 Срочные контракты (ФИССИКО)*/) and       " + 
                 "                                (sfcontr.t_DateClose = to_date('01.01.0001','dd.mm.yyyy') or sfcontr.t_DateClose >= ?)     " +
                 "                       join dsfcontr_dbt sfcontr2 on sfcontr2.t_ServKind = 0 and                                           " +
                 "                                (sfcontr2.t_DateClose = to_date('01.01.0001','dd.mm.yyyy') or sfcontr2.t_DateClose >= ?)   " +
                 "                       join ddlcontr_dbt dlcontr on sfcontr2.t_id = dlcontr.t_sfcontrid AND dlcontr.t_iis <> 'X'           " +
                 "                     where ssi.t_ObjectID = to_char(sfcontr.t_id,'FM0000000000')                                           " +
                 "                       and sfcontr.t_partyid = sfcontr2.t_partyid                                                          " +
                 "                       and sfcontr.t_id in (select t_sfcontrid from W475_TMP)                                              " + 
                 "                     group by sfcontr.t_id, acc.t_code_currency)                                                           " +
                 "              group by t_id)                                                                                               " +
                 "        ) R                                                                                                                " +
                 "  ON (R.t_id = W475.T_sfcontrid)                                                                                           " +
                 "  WHEN MATCHED THEN                                                                                                        " +
                 "    UPDATE SET W475.T_DS_OUT     = R.REST_OUT,                                                                             " +
                 "               W475.T_COMSUM     = R.REST_OUT_RUB,                                                                         " +
                 "               W475.T_COMSUMREPO = R.REST_OUT_VAL "); 

        cmdUpdateTmp.AddParam("", RSDBP_IN, m_DateEnd);
        cmdUpdateTmp.AddParam("", RSDBP_IN, m_DateEnd);
        cmdUpdateTmp.AddParam("", RSDBP_IN, m_DateEnd);
        cmdUpdateTmp.AddParam("", RSDBP_IN, m_BeginDate);
        cmdUpdateTmp.AddParam("", RSDBP_IN, m_BeginDate);
        UseProgress(3);
        cmdUpdateTmp.execute();


        /* 5  t_p_out */
        message("4/5  Расчет сумм");
        cmdUpdateTmp = RsdCommand(
                 " MERGE INTO W475_TMP w475                                                                              " +
                 " USING (SELECT T_CONTRACT,decode(sum(T_SUM),0,0,sum(T_SUM)-sum(T_NKD)) as T_SUM,                       " +
                 "          decode(sum(T_SUM_RUB),0,0,                                                                   " +
                 "                  decode(sum(T_SUM_VAL),0,sum(T_SUM_RUB)-(sum(T_NKD_RUB) + sum(T_NKD_VAL)),            " +
                 "                          sum(T_SUM_RUB)-sum(T_NKD_RUB))) as T_SUM_RUB,                                " +
                 "          decode(sum(T_SUM_VAL),0,0,                                                                   " +
                 "                  decode(sum(T_SUM_RUB),0,sum(T_SUM_VAL)-(sum(T_NKD_RUB) + sum(T_NKD_VAL)),            " +
                 "                          sum(T_SUM_VAL)-sum(T_NKD_VAL))) as T_SUM_VAL                                 " +
                 "        FROM (SELECT PMWRTCL.T_CONTRACT, FIN.t_facevaluefi,                                            " +
                 "                sum(nvl(round(t_amount*GetRate(PMWRTCL.t_fiid, 0, ?), 2), 0)) AS T_SUM,                " +
                 "                sum(nvl(round(t_amount*getNKdAmount(PMWRTCL.t_fiid,?,0),2),0)) AS T_NKD,               " +
                 "                sum(nvl(decode(FIN.t_facevaluefi,0,round(t_amount*GetRate(PMWRTCL.t_fiid, 0, ?), 2),0), 0)) AS T_SUM_RUB,  " +
                 "                sum(nvl(decode(FIN.t_facevaluefi,0,round(t_amount*getNKdAmount(PMWRTCL.t_fiid,?,0),2),0),0)) AS T_NKD_RUB, " +
                 "                sum(nvl(decode(FIN.t_facevaluefi,0,0,round(t_amount*GetRate(PMWRTCL.t_fiid, 0, ?), 2)), 0)) AS T_SUM_VAL,  " +
                 "                sum(nvl(decode(FIN.t_facevaluefi,0,0,round(t_amount*getNKdAmount(PMWRTCL.t_fiid,?,0),2)),0)) AS T_NKD_VAL  " +
                 "              FROM DPMWRTCL_DBT PMWRTCL, DFININSTR_DBT FIN                                             " +
                 "              WHERE PMWRTCL.T_BEGDATE <= ?                                                             " +
                 "                AND PMWRTCL.T_ENDDATE >= ?                                                             " +
                 "                AND PMWRTCL.T_FIID = FIN.T_FIID                                                        " +
                 "                AND T_CONTRACT in (select t_sfcontrid from W475_TMP)                                   " + 
                 "              GROUP BY PMWRTCL.T_CONTRACT, FIN.t_facevaluefi )                                         " +
                 "        GROUP BY T_CONTRACT                                                                            " +
                 "       ) PMWRTCLSUM                                                                                    " +
                 " ON (T_SFCONTRID = PMWRTCLSUM.T_CONTRACT)                                                              " +
                 " WHEN MATCHED THEN                                                                                     " +
                 " UPDATE SET T_P_OUT      = PMWRTCLSUM.T_SUM,                                                           " +
                 "            T_COMSUMSVOP = PMWRTCLSUM.T_SUM_RUB,                                                       " +
                 "            T_VAL_SVOP   = PMWRTCLSUM.T_SUM_VAL "); 

        cmdUpdateTmp.AddParam("", RSDBP_IN, m_DateEnd);
        cmdUpdateTmp.AddParam("", RSDBP_IN, m_DateEnd);
        cmdUpdateTmp.AddParam("", RSDBP_IN, m_DateEnd);
        cmdUpdateTmp.AddParam("", RSDBP_IN, m_DateEnd);
        cmdUpdateTmp.AddParam("", RSDBP_IN, m_DateEnd);
        cmdUpdateTmp.AddParam("", RSDBP_IN, m_DateEnd);
        cmdUpdateTmp.AddParam("", RSDBP_IN, m_DateEnd);
        cmdUpdateTmp.AddParam("", RSDBP_IN, m_DateEnd);
        UseProgress(4);
        cmdUpdateTmp.execute();

        RemProgress;

        InitProgress(-1,"Печать...","Печать...");
        message("Печать...");

        /*Отключаем все индикаторы*/
        if (m_UseTemplate)
            m_ObjTemplateXLS.SetFlagShowIndicator(false);
        else
            __BUG_Global_m_ObjTemplateXLS.SetFlagShowIndicator(false);
        end;


        /*Лист "Результаты БО для ДРРК"*/
        SetActiveSheet("Результаты БО для клиента");
        if (FormData.InvestorName == "Все")
            PrintFormatString( "", "ReportName1", "Результаты брокерского обслуживания клиентов на дату " + m_DateEnd); 
        else
            PrintFormatString( "", "ReportName1", "Результаты брокерского обслуживания клиента на дату " + m_DateEnd);
        end;
        RegisterTable( "ReportRow", "",
               /*1*/ "Field01", 
               /*2*/ "Field02", 
               /*3*/ "Field03", 
               /*4*/ "Field04", 
               /*5*/ "Field05",
               /*6*/ "Field06",
               /*7*/ "Field07",
               /*8*/ "Field08");

        var m_RS = TRsbDataSet(
                       "SELECT distinct t_clientname, max(t_sfcontrid) t_sfcontrid, t_contrnumber, " +
                       "       nvl(sum(t_ds_out + t_p_out),0) sumactiv,                            " +
                       "       nvl(sum(t_comsum + t_comsumsvop),0) sumactiv_rub,                   " +
                       "       nvl(sum(t_comsumrepo + t_val_svop),0) sumactiv_val                  " +
                       "FROM W475_TMP                                                              " +
                       "group by t_clientname, t_contrnumber                                       " +
                       "order by t_clientname, t_contrnumber ");
        while (m_RS.MoveNext())
            m_dognum = m_dognum + 1;

            /*Строка отчета*/
            PrintTableLine(
                  /* 1*/ "Field01", m_dognum, null,
                  /* 2*/ "Field02", m_RS.value("t_clientname"), null,
                  /* 3*/ "Field03", GetAgeClient(m_RS.value("t_sfcontrid"), m_DateEnd), null,
                  /* 4*/ "Field04", GetClientGender(m_RS.value("t_sfcontrid")), null,
                  /* 5*/ "Field05", m_RS.value("t_contrnumber"), null,
                  /* 6*/ "Field06", m_RS.value("sumactiv"), null,
                  /* 7*/ "Field07", m_RS.value("sumactiv_rub"), null,
                  /* 8*/ "Field08", m_RS.value("sumactiv_val"), null);

            row = row + 1;
            UseProgress(row);
        end;

        RemProgress;

        message("Вывод в EXCEL");
        EndTable();
    END;
  
    initTX_RegistrReport(W475_Client_Panel(), "Report_W475_Client.xls");
END;

/*Точка входа*/
var defprec = SetDefPrec(12);
var r = W475_Client_Report();
r.InitReport("Результаты брокерского обслуживания для клиента", null);
r.Run();
message("Конец");
SetDefPrec(defprec);

exit(1);