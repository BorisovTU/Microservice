import oralib, likepy, globals, rsexts, commonutil/*Simanov. Избавляемся от библиотеки, commoninter*/;
import "DlRepForm_h.mac", "dlmisc.mac","globals", Календарь, RSD, RsbDataSet, "or_tpl_h.mac",prnfrm,or_tpl_h, PTInter,rcw;
import RsbFormsInter, "scincfun.mac";


// Файл результата
var NameFile = "..\\txtfile\\result_" + UserNumber() +".csv"; //Выходной файл с данными
var Name, Ext;                                  
var NewName;
/*var obj :C_CSVFile = C_CSVFile();
var objExcel = CDAOMSExcel();
// Заполним файл данных 
Obj.FileOpen( NameFile, true);
Obj.FileOpen( NameFile, true);*/

var error, folder;
var count_req = 0;
var count_err = 0;
var flag = false;


Private macro LoadDeals()
    var ImportFileDir, ImportFile;
    var Rep;
  var sheet = 1;
  var errorcount = 0;
 // Находим отсутствующие договора брокерского обслуживания
  Rep = CMakeReport("┌┬┬┬┬┬┬┬┬┬┬┬┬┐");

  Rep.SetDefaultFontName("Times New Roman");
  Rep.SetDefaultFontSize(12);
  Rep.SetFlagShowGrid(true);
  Rep.AddPrintCell("" , 5,1, "c:ex_FS(b):ex_B()");
    GetRegistryValue("РСХБ\\ДИРЕКТОРИИ\\КАТАЛОГ_ИМПОРТА_ФАЙЛА", V_STRING, ImportFileDir, error, false, {oper}); // Каталог импорта
    if ( not selectFile (ImportFile,mergefile(ImportFileDir, "*"), "Файлы данных",0, true) )
        return;
    end;
    flag = true;

    var line;
    file instr () txt;

//    if ( not (open (instr, StrSubst(ImportFileDir, ".csv", ".txt"))))
    if ( not (open (instr, ImportFile)))
        msgbox ("Не все файлы данных открыты|",ImportFile);
        return;
    end;

    setDelIm (strFor (59));

    next (instr);
    line = 1;
    next (instr);
    Rep.AddPrintCell("", 5,1, "c:ex_FS(b):ex_B()");
    Rep.AddPrintCell("Протокол поиска новых контрагентов и ценных бумаг по файлу сделок Квик за дату " + string(instr (3)),60, null, "c:ex_FS(b):ex_B()");
    Rep.AddStr();
    Rep.AddPrintCell("", 5,1, "c:ex_FS(b):ex_B()");
    Rep.AddStr();
    Rep.AddPrintCell("№ сделки", 16.14, null, "r" );
    Rep.AddPrintCell("Вид ошибки",40, null, "r" );
    Rep.AddStr();
    rewind (instr);
    next (instr);
    while ( next (instr) )
        if(instr (34) != "")
           var cmd = RsdCommand("select T_SHORTNAME, t_partyid from dparty_dbt where t_partyid = (select t_partyid from dpartcode_dbt where t_codekind = 8 and t_state = 0 and t_code = '"+string(instr (34))+"')");
           var rs = RsdRecordset(cmd);
           if (rs.moveNext())
               var cmd_pr = RsdCommand("select 1 st_true from dpartyown_dbt where t_partyid = " +rs.value(1) + " and t_partykind = 7");
               var rs_pr = RsdRecordset(cmd_pr);
               if (not rs_pr.moveNext())   
                 Rep.AddPrintCell(string(instr (1)), 16.14, null, "r" );
                  Rep.AddPrintCell("Субъект "+ rs.value(0)+ " с кодом '" +string(instr (34))+"' не является контрагентом" , 40, null, "r" );
                  Rep.AddStr();
                  count_err = count_err + 1;
                 //Субъект с кодом <> не является контрагентом
               end;
               var ccy;
/*               if (instr (23)=="SUR")
                  ccy = "RUB";
               else ccy = instr (23);
               end;
               var cmd_spi = RsdCommand("select 1 spi_true from dsettacc_dbt sett, dpmautoac_dbt aut where SETT.T_PARTYID = "+ rs.value(1) + 
                                       " and sett.t_settaccid = aut.t_settaccid  and aut.t_fiid = (select t_fiid from dfininstr_dbt where t_ccy ='" +ccy+ "') and aut.t_servicekind = 1");
               var rs_spi = RsdRecordset(cmd_spi);
               if (not rs_pr.moveNext())
                  Obj.AddCell(string(instr (1)));
                  Obj.AddCell("Для субъекта "+ rs.value(0)+ " с кодом '"+string(instr (34))+"' не задана СПИ в валюте " + ccy);
                  Obj.AddRow();
                  count_err = count_err + 1;
               end;*/
            else
                  Rep.AddPrintCell(string(instr (1)), 16.14, null, "r" );
                  Rep.AddPrintCell("Субъект " + tooem(instr (35),true)+ " с кодом '"+string(instr (34))+"'  вида 8 не найден среди субъектов нашего банка", 40, null, "r" );
                  Rep.AddStr();
                  count_err = count_err + 1;
           end;
        end;
        
        if (instr (13) != "")
            //var cmd_secur = RsdCommand("select t_fiid from  davoiriss_dbt where t_isin = '" + instr (13) + "'");
            var cmd_secur = RsdCommand(" SELECT AVR.T_FIID                           " +
                                       "   FROM davoiriss_dbt avr, dfininstr_dbt fin " +
                                       "  WHERE     avr.t_fiid = fin.t_fiid          " +
                                       "        AND t_isin = '" + instr (13) + "'    " +
                                       "        AND AVR.T_SPISCLOSED != CHR (88)     " +
                                       "        AND FIN.T_ISCLOSED != CHR (88)       ");

            var rs_secur = RsdRecordset(cmd_secur);
            if (not rs_secur.moveNext())
               Rep.AddPrintCell(string(instr (1)), 16.14, null, "r" );
               Rep.AddPrintCell("Не найдена ценная бумага '"+tooem(instr (11), true)+"' ISIN '"+string(instr (13))+"'", 40, null, "r" );
               Rep.AddStr();
               count_err = count_err + 1;
            else
               var cmd_secur2 = RsdCommand("select t_code from  dobjcode_dbt where t_objecttype = 9 and t_codekind = 11 and t_state = 0 and t_objectid = " + string(rs_secur.value("t_fiid")));
               var rs_secur2 = RsdRecordset(cmd_secur2);
               if (not rs_secur2.moveNext())
                  Rep.AddPrintCell(string(instr (1)), 16.14, null, "r" );
                  Rep.AddPrintCell("Не найден код ценной бумаги на Бирже (код вида 11) для '"+tooem(instr (11), true)+"' ISIN '"+string(instr (13))+"'", 40, null, "r" );
                  Rep.AddStr();
                  count_err = count_err + 1;
               elif (rs_secur2.value("t_code") != instr(12) )//не совпадает с кодом из файла
                  Rep.AddPrintCell(string(instr (1)), 16.14, null, "r" );
                  Rep.AddPrintCell("Код ценной бумаги на Бирже (код вида 11) для '"+tooem(instr (11), true)+"' ISIN '"+string(instr (13))+"' не совпадает с кодом в СОФР. \n В СОФР: "+rs_secur2.value("t_code")+"\n в файле QUIK:"+instr(12), 40, null, "r" );
                  Rep.AddStr();
                  count_err = count_err + 1;
               end;
            end;
        end;


        count_req = count_req + 1;

    end;
if(count_err == 0)
   Rep.AddPrintCell("Новых контрагентов и ценных бумаг не обнаружено", 25, null, "r" );
   Rep.AddStr();
end;

Rep.AddPrintCell("", 5,1, "c:ex_FS(b):ex_B()");
Rep.AddStr();

Rep.AddPrintCell("Обработано строк " + string(count_req), 20, null, "r" );
Rep.AddStr();
  Rep.PrintWinRep("Отчет");
  Rep.SetZoomType(ZOOM_TYPE_A4L);
  Rep.SetWinRepOutput();
  Rep.ShowWinRep();


//    MsgBox ("Данные загружены");
End;

LoadDeals();

//Obj.FileClose();
//SplitFile(NameFile, Name, Ext);
//NewName = Name+strsubst(string(time()), ":", "") +  Ext;
/*if( not CopyFile(NameFile,"$Txtfile\\"+NewName) )
  msgbox("Ошибка копирования файла на терминал");
  exit( 1 );
else
  if(objExcel.CreateApplication() and flag)
    if(objExcel.open(GetCurDir(true)+"\\TxtFile\\"+NewName/*Name+Ext*/))
      objExcel.Application.Visible = true;
    end;
  end;
end;*/
exit (1);
