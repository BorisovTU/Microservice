/**************************************************************************************************/
/*     Макрос рассчета тарифа для сделок на внебиржевом рынке                                     */
/*  Изменения: 13.12.2019 Chesnokov D.S. I-Support 500620                                         */
/*             20.08.2020 Chesnokov D.S. I-Support 512567                                         */
/**************************************************************************************************/
import fiinter, "spserv.mac";
macro GetServicePayValue ( sfcalcalddr, datebegin, dateend, basetype, baseSum, sfcontraddr )
var summa = $0,MINIMUM = $3000, stavka1 = 0.15/*Chesnokov D.S. 512567*/, stavka2 = 0.2, stavka = $0;
var Comcode = "", ComVal = 0;

Private Macro GetComm(Number, Comcode, ComVal)
var sel, cmd, rs;
 sel  = "  select * from dsfcomiss_dbt where t_number = " + Number + " and t_feetype = 1" ;
    cmd = RSDCommand( sel );
    cmd.addParam( "", RSDBP_IN, Number );
    cmd.execute();
    rs = TRsbDataSet( cmd );
    if( rs.MoveNext() )
        SetParm(1, rs.code);
        SetParm(2, rs.fiid_comm);
        return 1;
    else
        return 0;
    end;
End;

record sfcontr ("sfcontr.dbt");
record sfcal ("sfcalcal.dbt");
 var sel, rs, cmd;
  var TempComSumVal = $0, TempComSumRur = $0, OneCente = $0;
     setbuff(sfcontr, sfcontraddr);
     setbuff(sfcal, sfcalcalddr);
/*
 sel  = " select UPPER(pl.t_name) as tarif from dsfplan_dbt pl, dsfconcom_dbt con "+
        "  where pl.t_sfplanid = con.t_sfplanid "+
        "  and con.t_objectid = ?";
    cmd = RSDCommand( sel );
    cmd.addParam( "", RSDBP_IN, sfcontr.id );
    cmd.execute();
    rs = TRsbDataSet( cmd );
     if( rs.MoveNext() )
      if( (rs.tarif == "БАЗОВЫЙ") or (rs.tarif == "ПРОФЕССИОНАЛЬНЫЙ") )
       stavka = stavka1;
      else
       stavka = stavka2;
      end;
     end;
*/
    //summa = basesum * stavka / 100;
    summa = basesum * stavka1 / 100;

    if( summa < MINIMUM ) 
/*KD*/
             If( not GetComm(sfcal.commNumber, Comcode, ComVal))
                return money(MINIMUM);
             end;
             //If((Comcode == "НеБирж_USD") and (dateend!= date(0,0,0)) )
             If((Comcode == "НеБиржБезНот_USD") and (dateend!= date(0,0,0)) )
                TempComSumVal = 0;
                TempComSumRur = 0;
                OneCente = 0;
                SmartConvertSum( TempComSumVal, MINIMUM, dateend, NATCUR, ComVal, false );
                TempComSumVal = round(TempComSumVal, 2);
                SmartConvertSum( TempComSumRur, TempComSumVal, dateend, ComVal, NATCUR, false );
                SmartConvertSum( OneCente, money(0.01), dateend, ComVal, NATCUR, false );
                If(TempComSumRur < MINIMUM)
                    return money(MINIMUM + OneCente);
                else
                    return money(MINIMUM);
                end;
             //ElIf((Comcode == "НеБирж_EUR") and (dateend!= date(0,0,0)) )
             ElIf((Comcode == "НеБиржБезНот_EUR") and (dateend!= date(0,0,0)) )
                TempComSumVal = 0;
                TempComSumRur = 0;
                OneCente = 0;
                SmartConvertSum( TempComSumVal, MINIMUM, dateend, NATCUR, ComVal, false );           
                TempComSumVal = round(TempComSumVal, 2);
                SmartConvertSum( TempComSumRur, TempComSumVal, dateend, ComVal, NATCUR, false );           
                SmartConvertSum( OneCente, money(0.01), dateend, ComVal, NATCUR, false );           
                If(TempComSumRur < MINIMUM)
                    return money(MINIMUM + OneCente);
                else
                    return money(MINIMUM);
                end;
             //ElIf((Comcode == "НеБирж_GBP") and (dateend!= date(0,0,0)) )
             ElIf((Comcode == "НеБиржБезНот_GBP") and (dateend!= date(0,0,0)) )
                TempComSumVal = 0;
                TempComSumRur = 0;
                OneCente = 0;
                SmartConvertSum( TempComSumVal, MINIMUM, dateend, NATCUR, ComVal, false );           
                TempComSumVal = round(TempComSumVal, 2);
                SmartConvertSum( TempComSumRur, TempComSumVal, dateend, ComVal, NATCUR, false );           
                SmartConvertSum( OneCente, money(0.01), dateend, ComVal, NATCUR, false );           
                If(TempComSumRur < MINIMUM)
                    return money(MINIMUM + OneCente);
                else
                    return money(MINIMUM);
                end;
             else
                    return money( MINIMUM );
             end;

//     return money( MINIMUM );
    else
     return money( summa );
    end;

END;
