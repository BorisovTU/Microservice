//А.Киселев 08.11.2018
import globals, oralib, likepy, cb_sql, DealsInter, CTInter, RsbFormsInter;
//import "ulmt_to_file.mac", "usr_table_int.mac";
import rsexts;
import "u_common_email_utils.mac";

//private const REG_EXPORT_PATH = "РСХБ\\ИНТЕГРАЦИЯ\\ДИРЕКТОРИИ\\EXPORT\\QUIK_ЛИМИТЫ"; //путь для выгрузки файла
private const REG_EXPORT_PATH = "РСХБ\\ДИРЕКТОРИИ\\QUIK_OUT"; //путь для выгрузки файла
private const REG_EXPORTCOR_PATH = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ДИРЕКТОРИЯ КОРРЕКТИРОВОК QUIK"; //путь для выгрузки файла
private const REG_EXPORTCOR_LIMIT = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ЛИМИТ КОРРЕКТИРОВОК QUIK"; //
private const REG_EXPORTCOR_CUR = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ВАЛЮТЫ К ВЫГРУЗКЕ КОРРЕКТ. QUIK"; //


private macro iif (c,a,b)
   if (c) return a else return b end;
end;

private class c_sfcontr(ContrID)
   var _sfcontr = TRecHandler("sfcontr");

   macro isBlocked(LimitDate)
      var Dt = TRsbDataSet
      ( " SELECT (CASE WHEN RSB_SECUR.GetGeneralMainObjAttr (207,LPAD (t_DlContrID, 34, '0'),1,"+GetSQLDate(LimitDate)+") = 1 THEN 'X' " + 
        "            ELSE CHR (0) END) IsBlocked                                                                         " +
        "   FROM ddlcontrmp_dbt WHERE t_sfcontrid = " + _sfcontr.rec.id);
      if (Dt.movenext())
         return Dt.IsBlocked;
      end;
      return StrFor(0);
   end;

   macro isExchange()
      if (_sfcontr.rec.servkindsub == 8)
         return true;
      else
         return false;
      end;
   end;

   macro isStock()
      if (_sfcontr.rec.servkind == 1)
         return true;
      else
         return false;
      end;
   end;

   macro isFuture()
      if (_sfcontr.rec.servkind == 15)
         return true;
      else
         return false;
      end;
   end;

   macro isCurMarket()
      if (_sfcontr.rec.servkind == 21)
         return true;
      else
         return false;
      end;
   end;

   macro isAccY()
      var note = ReadNoteForObject(659, UniID(_sfcontr,659), 5 /*Счет клиента на ММВБ Фондовый сектор*/);
      if (note != "")
         if (index(note,"Y") == 1)
            return true;
         end;
      end;
      return false
   end;

   macro rec()
      return _sfcontr.rec;
   end;

   /*
   if (_sfcontr.rec.id != 0)
      return _sfcontr.rec;
   end;*/
   var Dt = TRsbDataSet(" select * from dsfcontr_dbt where t_id = " + ContrID);
   if (Dt.movenext())
     Dt.GetRecord.CopyTo(_sfcontr.rec);
     //return _sfcontr.rec;
   end;
end;


private macro GetMicexCode(ContrID)
   var Dt = TRsbDataSet(" select t_mpcode from ddlcontrmp_dbt where t_sfcontrid = " + ContrID);
   if (Dt.movenext())
      return dt.mpcode;
   end;
   return "";
end;

macro NeedCorrLimit( contract )
    var sfcontr = c_sfcontr(contract);

    if (sfcontr.isExchange()        /*только биржевые*/
        and (not sfcontr.isFuture()) /*по срочному не выгружаем*/
        and (not sfcontr.isAccY())  /*по договорам в спецдепо не выводим*/
       )
       return true;
    end;

    return false;

end;

private macro AddAttrNPTXOP(rec)
   var CatErr = 0, Dt = TRsbDataSet(" select * from doproper_dbt where t_id_operation = " + rec.t_id_oper);
   if (Dt.movenext())
      AddNoteForObject(131, Dt.documentid, 101, "Выгружено в файл");
      if( (not DisconnectObjAttr( 131, Dt.documentid, 101 )) 
         OR
         (not ConnectObjAttr( CatErr, 131, Dt.DocumentID, 101, 1 )) 
         OR
         (CatErr != 0)
        )
         msgbox("Ошибка при установке категории " );
      end;
    end;

end;



/*>>bpv панель вызова выбор даты с галкой*/
private const FT_DATE = 9;

class (TRsbPanel) ChoiceDatePanel

    InitTRsbPanel();
    setSize(30,6);
    setPosition(35,15);

    var DateBeg = {curdate};
    var OnlyNewRec  = false;
    var stat = 0;

    this.Status("F3 - выбор даты F2,F9 - выполнить");
    this.Caption("Формирование сводного поручения");

    addLabel(TRsbLabel(3, 2, "Дата"));
    var m_DateBeg:TRsbEditField = TRsbEditField(FT_DATE);
    m_DateBeg.setPosition(10,2);
    m_DateBeg.setSize(10,1);
    m_DateBeg.value = DateBeg;
    m_DateBeg.enabled = true;
    m_DateBeg.Name = "DateBeg";
    addControl(m_DateBeg);

    var m_NewRec = TRsbCheckbox;
    m_NewRec.setPosition(3,4);
    m_NewRec.name = "newrec";
    m_NewRec.checked = "X";
    addControl(m_NewRec);
    addLabel(TRsbLabel(5, 4, "Выгружать только новые: "));


    m_DateBeg.addEventHandler(RSB_EV_KEY_PRESSED , R2M(this, "DATE_KEY_PRESSED"));
    addEventHandler(RSB_EV_KEY_PRESSED , R2M(this, "Panel_ButtonEvent"));


    macro Panel_ButtonEvent(RsbEvent)
       if((RsbEvent.keyCode == 316) or (RsbEvent.keyCode == 323))/*F2 F9*/
           stat = 0;
           DateBeg = m_DateBeg.Value;
           OnlyNewRec = m_NewRec.checked;
           this.close(1);
       elif(RsbEvent.keyCode == 27) /**/
           stat = 1;
       end;
    end;

    macro DATE_KEY_PRESSED(RsbEvent)
       if(RsbEvent.keyCode == 317)
           RsbEvent.Source.value = GetDateByCalendar(RsbEvent.Source.value);
       end;
    end;
end;


private macro CheckOper(Id_Oper, dat, OnlyNewRec)
  var stat = 0;
  var sql, dt;
  if ((dat < date()) and OnlyNewRec) /*только архивные выгрузки*/
     sql = 
        " SELECT MAX (t_systemdate) trnsysdate                                             "+
        "  FROM dacctrn_dbt                                                                "+
        " WHERE     t_acctrnid IN                                                          "+
        "               (SELECT t_acctrnid                                                 "+
        "                  FROM doprdocs_dbt                                               "+
        "                 WHERE t_acctrnid IS NOT NULL AND t_id_operation = "+id_oper+")   "+
        "       AND t_chapter = 1                                                          ";
     Dt = TRsbDataSet(sql);
     if (Dt.movenext())
        if (SQL_ConvTypeDate(dt.trnsysdate) < date())
           stat = 1;/*архивная операция скорее всего есть в утренних лимитах*/
        end;
     else
        stat = 2;/*По операции нет проводок*/
     end;
                                                                                   
  end;
  return stat;
end;


macro LimitCorOut( _Dat, NonDiag, _inout/*-1 - списания, 0 - все, 1 - зачисления*/ , OnlyNewRec) :integer
   var state :integer = 0,
       errortext :string = "",
       Params :TArray,
       StrPath :string = "",
       ErrCode,
       prev_id_oper = 0,
       limit_rub = $0.0, unload_cur = "", i_lim = $0.0, overlimit = $0.0, unloaded = 0, skipped = 0, s = "", flag = true;
   var FlagCheckOper = 0;

   var v_email_processor, emailText = "";


   if ((OnlyNewRec) == V_UNDEF)
      OnlyNewRec = false;
   end;


   //формируем файл
   //получим значение пути выгрузки из реестра
   GetRegistryValue(REG_EXPORTCOR_PATH, V_STRING, StrPath, ErrCode);
    if( ErrCode > 0 )
     StrPath = "..\\QUIK_EXCHNG\\out";
    end;

   GetRegistryValue(REG_EXPORTCOR_LIMIT, V_DOUBLE, limit_rub, ErrCode);
   if( ErrCode > 0 )
      msgbox("Не установлен лимит для выгрузки RUB. Будут выгружены все корректировки");
      limit_rub = $9999999999999999999999.0;
   end;

   GetRegistryValue(REG_EXPORTCOR_CUR, V_DOUBLE, unload_cur, ErrCode);
   if( ErrCode > 0 )
      unload_cur = "SUR";
   end;

   var dat = date();

   if (ValType(_Dat) != V_UNDEF)
      dat = _Dat;
   else
//      if (GetDate(dat, "Введите дату выгружаемых корректировок"))
//      end;

      var panel = ChoiceDatePanel;
      panel.run;
      if (panel.stat == 1)
         [Выгрузка отменена];
         return;
      end;
      dat = panel.DateBeg;
      OnlyNewRec = panel.OnlyNewRec;
   end;

   var cond = "";
   if (ValType(_inout) != V_UNDEF )
      if (_inout > 0)
         cond = 
                " AND ( (t_open_balance > 0)        " +
                "      OR (t_open_balance = 0       " +
                "          AND EXISTS               " +
                "                 (SELECT 1         " +
                "                    FROM DDL_LIMITADJUST_DBT tt " +
                "                   WHERE     T.T_ID_OPER = tt.t_id_oper " +
                "                         AND tt.t_limit_kind = 0        " +
                "                         AND tt.t_open_balance > 0)))   ";

      elif (_inout < 0)
         cond = 
                " AND ( (t_open_balance < 0)        " +
                "      OR (t_open_balance = 0       " +
                "          AND EXISTS               " +
                "                 (SELECT 1         " +
                "                    FROM DDL_LIMITADJUST_DBT tt " +
                "                   WHERE     T.T_ID_OPER = tt.t_id_oper " +
                "                         AND tt.t_limit_kind = 0        " +
                "                         AND tt.t_open_balance < 0)))   ";

      end;
   end;

   if (OnlyNewRec)
      cond = cond + " and not exists (SELECT 1  " + 
                    "  FROM dnotetext_dbt        " + 
                    " WHERE     t_notekind = 101     " + 
                    "       AND t_objecttype = 131       " + 
                    "       AND t_documentid = (SELECT t_documentid " + 
                    "                             FROM doproper_dbt " + 
                    "                            WHERE t_id_operation = t.t_id_oper)) ";
   end;

   //var fullfarch = StrPath+"\\limits"+string(dat:f)+".lci";
   MakeDir(string(StrPath));
   MakeDir(string(StrPath+"\\", "Archive"));

   var fullf = StrPath+"\\limits.lci";
   var f = TStreamDoc(fullf, "C");

   
   var sql = " select * from DDL_LIMITADJUST_DBT t where t_market = 1 "+cond+" and t_date = "+GetSQLDate(dat)+" /*and t_isblocked <> chr(88)*/ order by t_id_oper, t_client_code, t_curr_code, t_limit_kind";
   var dt = trsbdataset(sql);
   var cnt = 1; 
   initprogress(sql_getnrecs(sql),"Выгрузка в файл", "Выгрузка в файл раздела MONEY: " + fullf);

   while (dt.movenext())

      /*для операций зачисления по рублям считаем суммарну*/
      if (((prev_id_oper == 0) or (prev_id_oper != Dt.Id_Oper)) and (dt.open_balance > 0) and (dt.curr_code == "SUR"))
         i_lim = i_lim + dt.open_balance;
      end;

      if (Dt.limit_type == "MONEY")
         s = 
           "LIMIT_TYPE = "     +dt.LIMIT_TYPE  + 
         "; LIMIT_ID = "       +dt.LIMITID     +
         "; FIRM_ID = "        +dt.FIRM_ID     +
         "; TAG = "            +dt.tag         +
         "; CURR_CODE = "      +dt.curr_code   +
         "; CLIENT_CODE = "    +dt.client_code +
         "; OPEN_BALANCE = "   +dt.open_balance+
         "; OPEN_LIMIT = "     +dt.open_limit  +
         "; CURRENT_LIMIT = "  +dt.current_limit+
         "; LIMIT_OPERATION = "+dt.limit_operation+
         "; LIMIT_KIND = "     +dt.limit_kind   +
         "; LEVERAGE = -1;";/*BIQ-9185*/
      elif (Dt.limit_type == "DEPO")
/* LIMIT_TYPE = DEPO; LIMIT_ID = 11616550; FIRM_ID = MB0134700000; SECCODE = USD000UTSTOM; CLIENT_CODE = CU413098; OPEN_BALANCE = 0.00;
 OPEN_LIMIT = 0.00; CURRENT_LIMIT = 0.00; LIMIT_OPERATION = CORRECT_LIMIT; LIMIT_KIND = 0; LEVERAGE = 0.00;*/
         s = 
           "LIMIT_TYPE = "     +dt.LIMIT_TYPE  + 
         "; LIMIT_ID = "       +dt.LIMITID     +
         "; FIRM_ID = "        +dt.FIRM_ID     +
         "; SECCODE = "        +dt.seccode     +
         "; CLIENT_CODE = "    +dt.client_code +
         "; OPEN_BALANCE = "   +trim(string(dt.open_balance:0:0))+
         "; OPEN_LIMIT = "     +trim(string(dt.open_limit:0:0))  +
         "; CURRENT_LIMIT = "  +trim(string(dt.current_limit:0:0))+
         "; LIMIT_OPERATION = "+dt.limit_operation+
         "; LIMIT_KIND = "     +dt.limit_kind   +
         "; LEVERAGE = "       +dt.leverage    +
         "; TRDACCID = "       +dt.trdaccid    + ";";

      end;
/*   bpv 21 11 2019 попросили убрать жесткий контроль и при превышении лимита уведомлять, но выгружать
      if ( ( ( i_lim <= limit_rub) and 
            (index(unload_cur, dt.curr_code) > 0)) or (dt.open_balance < 0) ) 
         if (Dt.isblocked != "X")
            f.WriteLine( s );
            println( s );
         else
            println( "Блокировка: " + s );
         end;
         if ((prev_id_oper == 0) or (prev_id_oper != Dt.Id_Oper))
           AddAttrNPTXOP(Dt);
           unloaded = unloaded + 1;
         end;
      elif((prev_id_oper == 0) or (prev_id_oper != Dt.Id_Oper)) 
         if (flag)
            println("---------------Превышение лимита по зачислениям SUR. Следующее зачисление на " +string(dt.open_balance:a)+ " ---------------");
            flag = false;
         end;
         overlimit = overlimit + dt.open_balance;
         skipped = skipped + 1;
      end;                       */

      if (Dt.isblocked != "X")
         if((prev_id_oper == 0) or (prev_id_oper != Dt.Id_Oper)) 
            if ((flag) and ( i_lim > limit_rub))
               println("---------------Превышение лимита по зачислениям SUR. ---------------");
               flag = false;
            end;
            if ( i_lim > limit_rub)
            overlimit = overlimit + dt.open_balance;
            end;
            //skipped = skipped + 1;

            FlagCheckOper = CheckOper(Dt.Id_Oper, dat, OnlyNewRec);
            if (FlagCheckOper == 1)
               println("--------------Возможно операция клиента "+dt.client_code+" на сумму "+dt.open_balance+" уже учтена в утренних лимитах --------------");
            elif (FlagCheckOper == 2)
               println("--------------По операции клиента "+dt.client_code+" на сумму "+dt.open_balance+" нет проводок --------------");
            end;

         end;                       

         f.WriteLine( s );
         println( s );
         if ((prev_id_oper == 0) or (prev_id_oper != Dt.Id_Oper))
           AddAttrNPTXOP(Dt);
           unloaded = unloaded + 1;
         end;

      else
         println( "Блокировка: " + s );
      end;

      prev_id_oper = dt.id_oper;

      useprogress(cnt=cnt+1);
   end;

   remprogress;
   f = null; //по сути commit для файла
   CopyFile("$"+fullf, "$"+StrPath+"\\Archive\\limits"+string(dat:f)+".lci");
   if (overlimit > 0)
      msgbox(fullf +"| Превышен лимит для автоматической выгрузки корректировок на "+overlimit+"| Выгружено: " + unloaded + "	Осталось: "+skipped);
      if (NonDiag)/*безынтерфейсный режим*/
         v_email_processor = c_email_proc_env();

         emailText =
         emailText  + "\n\nПревышен лимит для автоматической выгрузки корректировок на "+overlimit+". \n"
                    + "\n\n"  
                    + "\n Выгружено: " + unloaded + " " 
                    + "\n Осталось: "+skipped;
         v_email_processor.m_add_broker_email_to_list();
         v_email_processor.m_set_msg_head("Превышен лимит выгрузки корректировок!");
         v_email_processor.m_add_row_to_msg_text(emailText);
         v_email_processor.m_save_to_submit_synch();
         v_email_processor.m_submit_email_synch();

      end;
   else
      msgbox(fullf+"| Выгружено: " + unloaded + "	Осталось: "+skipped);
   end;
end;

private macro CreateLimitAdJust(limitadjust)
   var sql = 
        "DECLARE " +
        "   p_LimitAdj             DDL_LIMITADJUST_DBT%ROWTYPE; " +
        "   UnknownDate   CONSTANT DATE := TO_DATE ('01.01.0001', 'DD.MM.YYYY'); " +
        "   UnknownTime   CONSTANT DATE := TO_DATE ('01.01.0001 00:00:00', 'DD.MM.YYYY HH24:MI:SS'); " +
        "BEGIN " +
        "   p_LimitAdj.t_ID              := 0; " +
        "   p_LimitAdj.T_LIMITID         := NVL (:T_LIMITID, 0); " +
        "   p_LimitAdj.T_LIMIT_KIND       := NVL (:T_LIMIT_KIND, 0); " +
        "   p_LimitAdj.T_DATE            := NVL (:T_DATE, UnknownDate); " +
        "   p_LimitAdj.T_TIME            := NVL (:T_TIME, UnknownTime); " +
        "   p_LimitAdj.T_MARKET          := NVL (:T_MARKET, -1); " +
        "   p_LimitAdj.T_CLIENT          := NVL (:T_CLIENT, 0); " +
        "   p_LimitAdj.T_INTERNALACCOUNT := NVL (:T_INTERNALACCOUNT, 0); " +
        "   p_LimitAdj.T_LIMIT_TYPE      := NVL (:T_LIMIT_TYPE, CHR (1)); " +
        "   p_LimitAdj.T_FIRM_ID         := NVL (:T_FIRM_ID, CHR (1)); " +
        "   p_LimitAdj.T_CLIENT_CODE     := NVL (:T_CLIENT_CODE, CHR (1)); " +
        "   p_LimitAdj.T_OPEN_BALANCE    := NVL (:T_OPEN_BALANCE, 0); " +
        "   p_LimitAdj.T_OPEN_LIMIT      := NVL (:T_OPEN_LIMIT, 0); " +
        "   p_LimitAdj.T_CURRENT_LIMIT   := NVL (:T_CURRENT_LIMIT, 0); " +
        "   p_LimitAdj.T_LIMIT_OPERATION := NVL (:T_LIMIT_OPERATION, CHR (1)); " +
        "   p_LimitAdj.T_TRDACCID        := NVL (:T_TRDACCID, CHR (1)); " +
        "   p_LimitAdj.T_SECCODE         := NVL (:T_SECCODE, CHR (1)); " +
        "   p_LimitAdj.T_TAG             := NVL (:T_TAG, CHR (1)); " +
        "   p_LimitAdj.T_CURRID          := NVL (:T_CURRID, -1); " +
        "   p_LimitAdj.T_CURR_CODE       := NVL (:T_CURR_CODE, CHR (1)); " +
//        "   p_LimitAdj.T_LIMIT_KIND      := NVL (:T_LIMIT_KIND, 0); " +
        "   p_LimitAdj.T_LEVERAGE        := NVL (:T_LEVERAGE, 0); " +
        "   p_LimitAdj.T_ID_OPER         := NVL (:T_ID_OPER, 0); " +
        "   p_LimitAdj.T_ID_STEP         := NVL (:T_ID_STEP, 0); " +
        "   p_LimitAdj.T_ISBLOCKED       := NVL (:T_ISBLOCKED, CHR (0)); " +
        " " +
        "   rshb_rsi_sclimit.RSI_CreateLimitAdJust (p_LimitAdj, :p_id_operation, :p_id_step); " +
        "END; " ;

   var cmd = RsdCommand(sql);
       cmd.addParam("T_LIMITID         ",RSDBP_IN, limitadjust.rec.LIMITID        );
       cmd.addParam("T_LIMIT_KIND       ",RSDBP_IN, limitadjust.rec.LIMIT_KIND      );
       cmd.addParam("T_DATE            ",RSDBP_IN, limitadjust.rec.DATE           );
       cmd.addParam("T_TIME            ",RSDBP_IN, limitadjust.rec.TIME           );
       cmd.addParam("T_MARKET          ",RSDBP_IN, limitadjust.rec.MARKET         );
       cmd.addParam("T_CLIENT          ",RSDBP_IN, limitadjust.rec.CLIENT         );
       cmd.addParam("T_INTERNALACCOUNT ",RSDBP_IN, limitadjust.rec.INTERNALACCOUNT);
       cmd.addParam("T_LIMIT_TYPE      ",RSDBP_IN, limitadjust.rec.LIMIT_TYPE     );
       cmd.addParam("T_FIRM_ID         ",RSDBP_IN, limitadjust.rec.FIRM_ID        );
       cmd.addParam("T_CLIENT_CODE     ",RSDBP_IN, limitadjust.rec.CLIENT_CODE    );
       cmd.addParam("T_OPEN_BALANCE    ",RSDBP_IN, limitadjust.rec.OPEN_BALANCE   );
       cmd.addParam("T_OPEN_LIMIT      ",RSDBP_IN, limitadjust.rec.OPEN_LIMIT     );
       cmd.addParam("T_CURRENT_LIMIT   ",RSDBP_IN, limitadjust.rec.CURRENT_LIMIT  );
       cmd.addParam("T_LIMIT_OPERATION ",RSDBP_IN, limitadjust.rec.LIMIT_OPERATION);
       cmd.addParam("T_TRDACCID        ",RSDBP_IN, limitadjust.rec.TRDACCID       );
       cmd.addParam("T_SECCODE         ",RSDBP_IN, limitadjust.rec.SECCODE        );
       cmd.addParam("T_TAG             ",RSDBP_IN, limitadjust.rec.TAG            );
       cmd.addParam("T_CURRID          ",RSDBP_IN, limitadjust.rec.CURRID         );
       cmd.addParam("T_CURR_CODE       ",RSDBP_IN, limitadjust.rec.CURR_CODE      );
//       cmd.addParam("T_LIMIT_KIND      ",RSDBP_IN, limitadjust.rec.LIMIT_KIND     );
       cmd.addParam("T_LEVERAGE        ",RSDBP_IN, limitadjust.rec.LEVERAGE       );
       cmd.addParam("T_ID_OPER         ",RSDBP_IN, limitadjust.rec.ID_OPER        );
       cmd.addParam("T_ID_STEP         ",RSDBP_IN, limitadjust.rec.ID_STEP        );
       cmd.addParam("T_ISBLOCKED       ",RSDBP_IN, limitadjust.rec.ISBLOCKED      );
       cmd.addParam("p_id_operation    ",RSDBP_IN, limitadjust.rec.ID_OPER        );
       cmd.addParam("p_id_step         ",RSDBP_IN, limitadjust.rec.ID_STEP        );
   cmd.Execute();

end;

macro InsertLimitAdjust(ContrId, LimitKind, LimitType, OpenBalance, Fiid, LimitDate, ID_Operation, LimitOperation, err:@string)

  private var limitadjust = TRecHandler("dl_limitadjust.dbt");
  private var _dockind = -1;

  private macro nvl(val, retval)
    if (ValType(Val) == V_UNDEF)
       return retval;
    else
       return val;
    end;
  end;
  private macro iif(val, retval, retval2)
    if (Val)
       return retval;
    else
       return retval2;
    end;
  end;
  private macro GetFiCode(Curr, fi_kind)
     var Dt = TRsbDataSet(" select decode(t_fi_kind,1,decode(t_ccy,'RUB','SUR',t_ccy),t_code) curr_code,  t_fi_kind from dfininstr_dbt f " + 
                          " left join dobjcode_dbt a on a.t_objectid = f.t_fiid and a.t_codekind = 11 and t_objecttype = 9 where t_fiid = " + Curr + 
                          " and t_fi_kind = " + fi_kind );
     if (Dt.movenext())
        return dt.curr_code;
     end;
     return "";
  end;
  private macro GetCurDepoCode(Curr)
     var Dt = TRsbDataSet(" select t_code from  " + 
                          " dobjcode_dbt where t_objectid =  "+curr+" and t_codekind = 106 and t_objecttype = 9 and t_state = 0 " );
     if (Dt.movenext())
        return dt.code;
     end;
     return "";
  end;

  private macro GetDocKind(id_operation)
     if (_dockind == -1)
        var Dt = TRsbDataSet(" select t_dockind from doproper_dbt where t_id_operation = " + id_operation);
        if (Dt.Movenext())
           _dockind = Dt.dockind;
        else
           _dockind = 0;
        end;
     end;
     return _dockind;
  end;

  var _dt;
  var sfcontr = c_sfcontr(ContrID);
  var limitprm = TRsbDataSet(" select * from ddl_limitprm_dbt where t_marketkind = 3");/*для валютного*/
  var existsCurParm = limitprm.movenext();
  var NumForID;/*для уникальности id операции в операциях первода не хватает, добавим разрез по рынку*/

  if (sfcontr.isStock())
     NumForID = 1;
  elif (sfcontr.IsCurMarket())
     NumForID = 2;
  elif (sfcontr.IsFuture())
     NumForID = 3;
  else
     NumForID = 0;
  end;

  limitadjust.rec.client_code = GetMicexCode(ContrID);
  if (limitadjust.rec.client_code == "")
     err = "Не удалось получить Код клиента на Бирже. "+sfcontr.rec.number;
     return false;
  end;

  if (( LimitType == "DEPO") and sfcontr.IsCurMarket())
     /*BIQ-7074 если сегодня уже добавляли такой, то повторно не нужно.*/
     _dt = TRsbDataSet(" select 1 from ddl_limitadjust_dbt where t_date = " +GetSQLDate(LimitDate)+" and t_limit_type = 'DEPO' and t_client_code = '"+limitadjust.rec.client_code+"'");
     if (_dt.movenext())
        return true;
     else
     limitadjust.rec.Limitid         = ID_Operation*100+NumForID*10+9 /*для нулевого лимита DEPO по валюте*/;
     end;
  elif (LimitKind == "365") 
     limitadjust.rec.Limitid         = ID_Operation*100+NumForID*10+3;
  else 
     limitadjust.rec.Limitid         = ID_Operation*100+NumForID*10+int(LimitKind);
  end;
  
  limitadjust.rec.open_balance    = OpenBalance;  
  limitadjust.rec.limit_kind       = LimitKind;
  limitadjust.rec.limit_Type      = LimitType;
  limitadjust.rec.date            = LimitDate;
  //limitadjust.rec.time          = time();
  limitadjust.rec.market          = 1;
  limitadjust.rec.client          = sfcontr.rec.partyID;
  limitadjust.rec.curr_code       = GetFiCode(Fiid, 1);
  if (( LimitType == "MONEY") and (limitadjust.rec.curr_code == ""))
     err = "Не удалось получить Код валюты. fiid = "+ Fiid;
     return false;
  end;
  limitadjust.rec.currid          = Fiid;
  if (( LimitType == "DEPO") and sfcontr.IsCurMarket())
     limitadjust.rec.seccode         = GetCurDepoCode(Fiid);
  else
     limitadjust.rec.seccode         = GetFiCode(Fiid, 2);
  end;
  if (( LimitType == "DEPO") and (limitadjust.rec.seccode == ""))
     err = "Не удалось получить Код ценной бумаги на МБ. ID инструмента = "+ Fiid;
     return false;
  end;
  limitadjust.rec.Limit_Operation = nvl(LimitOperation,"CORRECT_LIMIT");
  limitadjust.rec.Tag             = "EQTV";
  if (sfcontr.isCurMarket())
     if (existsCurParm)
        limitadjust.rec.Firm_ID      = limitprm.firmcode;
        limitadjust.rec.trdaccid     = limitprm.depoacc;
     else
     limitadjust.rec.Firm_ID         = "MB0134700000";
        limitadjust.rec.trdaccid     = "MB0134716791";
     end;
  else
     limitadjust.rec.Firm_ID         = "MC0134700000";
  end;
  limitadjust.rec.isBlocked       = sfcontr.IsBlocked(LimitDate);

  if (GetDocKind(ID_Operation) == 4607)
     DL_CreateLimitAdJust(limitadjust);
  else
     limitadjust.rec.id_oper = id_operation;
     limitadjust.rec.id_step = 2;
     CreateLimitAdJust(limitadjust);
  end;
  return true;
end;


//сервис загрузки лимитов
macro ws_lmt_to_buf( Str_Param :string, fullf:@string, fulls:@string, msg:@string, sec, fut, cur, fname, marketid ) :integer

var state :integer = 0,
    errortext :string = "",
    Params :TArray,
    StrPath :string = "",
    ErrCode;

 if (ValType(cur) == V_UNDEF)
    cur = false;
 end;
 if (ValType(sec) == V_UNDEF)
    sec = false;
 end;
 if (ValType(fut) == V_UNDEF)
    fut = false;
 end;
 if (ValType(marketid) == V_UNDEF)
    marketid = -1;
 end;


 if ((not cur) and (not fut) and (not sec))
    println("Файлы не выгружены. Ни один рынок не выбран.");
    msg = "Файлы не выгружены. Ни один рынок не выбран.";
    return state;
 end;

 if( not GetParm(2, Str_Param) )
   Str_Param = "";
 end;


 //формируем файл
 //получим значение пути выгрузки из реестра
 GetRegistryValue(REG_EXPORT_PATH, V_STRING, StrPath, ErrCode);
 if( ErrCode > 0 )
    StrPath = "..\\QUIK_EXCHNG\\out";
 end;
 //получим значение пути выгрузки из реестра

 if (ValType(fname) == V_UNDEF)
    fname = "limit";
 end;

 // state = CreateOutputFileLMT(/*"$C:\\RsBank60"*/ StrPath );
 //формируем файл
  fullf = StrPath+"\\"+fname+".lim";
  fulls = StrPath+"\\limit.fli";


 if ( cur or sec)
    var f = TStreamDoc(fullf, "C");
   /***********************/
   /* MONEY */
   var dt, cnt, sql = "";
   if (cur and sec)
     sql = " select * from DDL_LIMITCASHSTOCK_DBT where "+iif (marketid == -1,"1=1", " t_market = " + marketid) +" and t_client = 114800 and t_isblocked <> chr(88)  order by t_client_code, t_curr_code, t_limit_kind";
   elif (cur)
     sql = " select * from DDL_LIMITCASHSTOCK_DBT where "+iif (marketid == -1,"1=1", " t_market = " + marketid) +" and t_client = 114800 and t_isblocked <> chr(88) and t_market_kind = 'валютный' order by t_client_code, t_curr_code, t_limit_kind";
   elif(sec)
     sql = " select * from DDL_LIMITCASHSTOCK_DBT where "+iif (marketid == -1,"1=1", " t_market = " + marketid) +" and t_client = 114800 and t_isblocked <> chr(88) and t_market_kind != 'валютный' order by t_client_code, t_curr_code, t_limit_kind";
   end;


   if (sql != "")
     dt = trsbdataset(sql);
     cnt = 1; 
     initprogress(sql_getnrecs(sql),"Выгрузка в файл", "Выгрузка в файл раздела MONEY: " + fullf);
     while (dt.movenext())
        f.WriteLine(
       "MONEY:  FIRM_ID = "+dt.firm_id+"; TAG = "+dt.tag+"; CURR_CODE = "+dt.curr_code+"; CLIENT_CODE = "+dt.client_code+"; LIMIT_KIND = "+dt.limit_kind+"; OPEN_BALANCE = "+dt.open_balance+"; OPEN_LIMIT = "+dt.open_limit+";" + IIF (dt.leverage == -1,"", " LEVERAGE = "+trim(string(dt.leverage:0:0))+";")
       /*MONEY:  FIRM_ID = MC0134700000; TAG = EQTV; CURR_CODE = SUR; CLIENT_CODE = 40491; LIMIT_KIND = 2; OPEN_BALANCE = 0; OPEN_LIMIT = 0; LEVERAGE = 0;*/
       );
       useprogress(cnt=cnt+1);
     end;

     remprogress;
   end;

  /***********************/
  /* DEPO */
  sql = "";
  if (cur and sec)
   sql = " select * from DDL_LIMITSECURITES_DBT where "+iif (marketid == -1,"1=1", " t_market = " + marketid) +" and t_client = 114800 and t_isblocked <> chr(88)  order by t_client_code, t_seccode, t_limit_kind";
  elif(cur)
   sql = " select * from DDL_LIMITSECURITES_DBT where "+iif (marketid == -1,"1=1", " t_market = " + marketid) +" and t_client = 114800 and t_isblocked <> chr(88)  and t_market_kind = 'валютный' order by t_client_code, t_seccode, t_limit_kind";
  elif(sec)
   sql = " select * from DDL_LIMITSECURITES_DBT where "+iif (marketid == -1,"1=1", " t_market = " + marketid) +" and t_client = 114800 and t_isblocked <> chr(88)  and t_market_kind != 'валютный' order by t_client_code, t_seccode, t_limit_kind";
  end;
  if (sql != "")
   dt = trsbdataset(sql);

   cnt = 1; 
    initprogress(sql_getnrecs(sql),"Выгрузка в файл", "Выгрузка в файл раздела DEPO: " + fullf);
    while (dt.movenext())
      f.WriteLine(
    "DEPO:  FIRM_ID = "+dt.firm_id+"; SECCODE = "+dt.seccode+"; CLIENT_CODE = "+dt.client_code+"; LIMIT_KIND = "+dt.limit_kind+"; OPEN_BALANCE = "+trim(string(dt.open_balance:0:0))/*int(dt.open_balance)*/+"; OPEN_LIMIT = "+int(dt.open_limit)+"; WA_POSITION_PRICE = "+string(dt.wa_position_price:0:6)+"; TRDACCID = "+dt.trdaccid+";" /*CHVA 501442*/
    /*DEPO:  FIRM_ID = MC0134700000; SECCODE = RU000A0ZZ4T1; CLIENT_CODE = 48382; LIMIT_KIND = 365; OPEN_BALANCE = 200; OPEN_LIMIT = 0; TRDACCID = L01+00000F00;*/
    );

     useprogress(cnt=cnt+1);
     end;

  remprogress;
  end;
end;
  /***********************/
sql = "";
if (fut)
  var s = TStreamDoc(fulls, "C");
   /* срочный */
    sql = " select * from DDL_LIMITFUTURMARK_DBT /*where t_market = 1*/  where  t_isblocked <> chr(88)  "+ 
//dan>          "  and upper (t_ACCOUNT) LIKE '%F502%' AND  ROUND(T_VOLUMEMN,4)<>0                            "+
          "  and upper (t_ACCOUNT) LIKE 'CLF5%' AND  ROUND(T_VOLUMEMN,4)<>0                            "+
//<dan              
          "  order by t_class_code, t_account,  t_seccode /*, t_limit_kind*/                            ";
    dt = trsbdataset(sql);

    cnt = 1; 
   initprogress(sql_getnrecs(sql),"Выгрузка в файл", "Выгрузка в файл раздела по срочному рынку: " + fulls);

   while (dt.movenext())
       s.WriteLine(
   //"CLASS_CODE = "+dt.class_code+"; ACCOUNT = "+dt.account+"; VOLUMEMN = "+dt.volumemn+"; VOLUMEPL = "+dt.volumepl+"; KFL = "+dt.kfl+"; KGO = "+dt.kgo+"; USE_KGO = "+dt.use_kgo+"; FIRM_ID = "+dt.firm_id+"; SECCODE = "+dt.seccode+";"
   "CLASS_CODE="+dt.class_code+";FIRM_ID="+dt.firm_id+";ACCOUNT="+dt.account+";VOLUMEMN="+dt.volumemn+";VOLUMEPL="+dt.volumepl+";KFL="+trim(string(dt.kfl:15:2))+";KGO="+trim(string(dt.kgo:15:2))+";USE_KGO="+dt.use_kgo+";"// SECCODE = "+dt.seccode+";"
   /*CLASS_CODE=SPBFUT;ACCOUNT=;VOLUMEMN=0;VOLUMEPL=0;KFL=1;KGO=1;USE_KGO=Да;FIRM_ID=;SECCODE=;*/
   );

   useprogress(cnt=cnt+1);
   end;

   remprogress;
end;

//println("Файлы выгружены: \n"+fullf +"\n" + fulls);
    msg = "Файлы выгружены";

return state;
OnError(e)
   msg = e.message;
   return 1;
end;
//сервис загрузки лимитов


//сервис загрузки корректировок лимитов
macro ws_lmtchange_to_buf( Str_Param :string ) :integer
var state :integer = 0,
    errortext :string = "",
    Params :TArray,
//    ParamProcess :TParamProcess,
//    ProcessOutTbl :c_usr_tbl_uTableProcessOut,
    StrPath :string = "",
    ErrCode;



 if( not GetParm(2, Str_Param) )
  Str_Param = "";
 end;

 //загрузили буферные таблицы из дистрибутивных
 state = execStoredFunc( "USR_PKG_IMPORT_SOFR.AddInudl_dl_lmtadjust_exch", V_INTEGER );

 if( state != 0 )
  return state;
 end;
 //загрузили буферные таблицы из дистрибутивных


//формируем файл
 Params = Null;
 Params = makeArray( SQLParam("p_Mode", 1), //формируем файл по корректировкам лимитов
                     SQLParam("p_IsDel", 1 ), //удалять ранее сформированный файл с таким именем
                     SQLParam("p_FileName", "lim_chng") );
 state = execStoredFunc( "USR_PKG_IMPORT_SOFR.AddLOBToTMP", V_INTEGER, Params );
 Params = Null;
 if( state != 0 )
  return state;
 end;


//получим значение пути выгрузки из реестра
 GetRegistryValue(REG_EXPORT_PATH, V_STRING, StrPath, ErrCode);
 if( ErrCode > 0 )
  StrPath = "..\\QUIK_EXCHNG\\out";
 end;
//получим значение пути выгрузки из реестра
// state = CreateOutputFileLMT(/*"$C:\\RsBank60"*/ StrPath );
//формируем файл

 if( state != 0 )
  return state;
 end;

 //установка статуса в ProcessOut
 //ParamProcess = Null;
 //ProcessOutTbl = Null;
 /*ParamProcess = TParamProcess( Str_Param + ";2"); //установить статусы 2
 ProcessOutTbl = c_usr_tbl_uTableProcessOut();
 ProcessOutTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
 ProcessOutTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
 ProcessOutTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
 if( not ProcessOutTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
  state = 1;
 end;
 ParamProcess = Null;
 ProcessOutTbl = Null;
 //установка статуса в ProcessOut
 */
 return state;

onError(err)
 Params = Null;
 //ParamProcess = Null;
 //ProcessOutTbl = Null;
 state = 1;
 return state;

end;
//сервис загрузки корректировок лимитов
//ws_lmt_to_buf;
