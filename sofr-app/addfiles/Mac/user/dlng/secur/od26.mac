/*
$Name:        od26.mac
$Module:      Ценные бумаги
$Description: Таблица ОД_26: Отчет по сверке начисления купона на дату
$Programmer:  Кротов А.
*/

import rsd;
import or_rep_h, globals, oralib, likepy,it_utils;
import fiinter;
import "sp_categ.mac";
import RsbFormsInter;
import likepy; //Simanov

var FD, FD_deal_nkd, Bpp, FIRole, CatCode, AccRest, err, Rep;
var Account, AccountCalc, NKDAmount, IncomeNKDAmount, allNKDAmount, calcNKD, oneAvrNKD, diffNkdAmount;

PRIVATE VAR InAcc = TRecHandler("account");

macro FiWarntDrawingDate(m_fiid, m_rep_date)
    var query =
    " SELECT T_DRAWINGDATE                         " +
    "   FROM DFIWARNTS_DBT fiw                     " +
    "  WHERE     fiw.t_isPartial = CHR (0)         " +
    "        AND t_fiid = :m_fiid                  " +
    "        AND FIW.T_DRAWINGDATE >= :m_rep_date1 " +
    "        AND FIW.T_FIRSTDATE <= :m_rep_date2   ";

    var cmd = DL_RSDCommand(query);
        cmd.AddParam(m_fiid);
        cmd.AddParam(m_rep_date);
        cmd.AddParam(m_rep_date);

    var sql = cmd.Execute();

    if(sql.movenext)
        return date(sql.DRAWINGDATE);
    end; 

    return date(0,0,0);
end;

// CLASS (CB_CReportTemplate) od26Report( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI:BOOL, UseBigReportMode:BOOL, FocreFormatRep:INTEGER )
CLASS (CB_CReportTemplate) od26Report( rep_date )

    var sql;
    var error_str = "";
    var repdate = rep_date;
    
    const SHEET_N1    = "ОД_26";

    private macro adderr (text:string)
    if (error_str == "")
        error_str = text;
        else
        error_str = error_str + ";\n" + text;
        end;
    End;

    PRIVATE MACRO PrintMode():INTEGER
        return DL_OUTREPORT_EXCEL;
    END;

    PRIVATE MACRO PrintLine( P1,P2,P3,P4,P5,P6,P7,P8,P9,P10,P11,P12 )
        PrintTableLine( "N1_Name",            P1,  null, /*1*/
                        "N1_ISIN",            P2,  null, /*2*/
                        "N1_Amount",          P3,  null, /*3*/
                        "N1_Account",         P4,  null, /*4*/
                        "N1_NKDAmount",       P5,  null, /*5*/
                        "N1_Portfolio",       P6,  null, /*6*/
                        "N1_IncomeNKDAmount", P7,  null, /*7*/
                        "N1_allNKDAmount",    P8,  null, /*8*/
                        "N1_calcNKD",         P9,  null, /*9*/
                        "N1_diffNkdAmount",   P10, null, /*10*/
                        "N1_oneAvrNKD",       P11, null, /*11*/
                        "N1_Date",            P12, null  /*12*/
            );
    END;

    PRIVATE MACRO BeginReport()
    END;

    PRIVATE MACRO EndReport()
    END;

    macro print_bpp(rep_date, avr_data, portf /*DEF-61472 SD10327585*/)
        var BppAccounts = TArray(), isFirstAccount = true;
        var query =
        "   SELECT /*+ leading(fin,avr,lot)*/ LOT.t_fiid,   " +
        "          LOT.t_portfolio,                         " +
        "          LOT.t_state,                             " +
        "          FIN.T_NAME,                              " +
        "          AVR.T_ISIN,                              " +
        "          SUM (LOT.t_amount) t_amount,             " +
        "          wrt_parent.t_dealid                      " +
        "     FROM V_SCWRTHISTEX lot,                       " +
        "          DFININSTR_DBT FIN,                       " +
        "          davoiriss_dbt AVR,                       " +
        "          dpmwrtsum_dbt wrt_parent                 " +
        "    WHERE     lot.t_amount > 0                     " +
            "  AND lot.t_portfolio NOT IN (0, 6)        " +
            "  AND lot.t_portfolio = :m_portfolio       " +/*DEF-61472 SD10327585*/    
            "  AND lot.t_state = :m_state               " +
            "  AND lot.t_changedate <= :m_date1         " +
            "  AND FIN.T_FIID = LOT.T_FIID              " +
            "  AND AVR.T_FIID = FIN.T_FIID              " +
            "  AND wrt_parent.t_sumid = lot.t_parent    " +
            "  AND fin.t_fiid = :m_fiid                 " +
            "  AND RSI_RSB_FIINSTR.FI_AvrKindsGetRoot (fin.t_fi_kind, fin.t_avoirkind) = 17 " +
            "  AND LOT.T_INSTANCE =                                                         " +
            "         (SELECT MAX (LOT2.T_INSTANCE)                                         " +
            "            FROM V_SCWRTHISTEX lot2                                            " +
            "           WHERE lot2.t_sumid = lot.t_sumid                                    " +
            "                 AND lot2.t_changedate <= :m_date2)                            " +
        " GROUP BY LOT.t_fiid, LOT.t_portfolio, LOT.t_state, FIN.T_NAME, AVR.T_ISIN, wrt_parent.t_dealid ";

        var cmd = DL_RSDCommand(query);
            cmd.AddParam(portf);/*DEF-61472 SD10327585*/
            cmd.AddParam(3); // поставлен БПП
            cmd.AddParam(rep_date);
            cmd.AddParam(avr_data.fiid);
            cmd.AddParam(rep_date);

        var sql = cmd.Execute();
        var FIRole_bpp;
        var FD; //Первичка по ЦБ
        var sum_amount = 0; /*GAA: 518683*/

        /* собираем данные по счетам БПП */
        NKDAmount = 0.0;

        while(sql.movenext)
            FD_deal_nkd = SPFirstDoc(LEG_KIND_DL_TICK, int(sql.DealID));
            FIRole = GetFIRoleByPortfolio(sql.portfolio);
            FIRole_bpp = GetFIRoleByPortfolio(sql.portfolio, false, false, Bpp); //Simanov
            FD = SPFirstDocFI( DLDOC_ISSUE, avr_data.fiid, avr_data.fiid, sql.portfolio); 

            if( FD_deal_nkd.IsExistAccount("Уплаченный НКД, БПП", null, true, FIRole, InAcc, null, rep_date) )
                NKDAmount = NKDAmount + ABS(GetRestAccount(InAcc.rec, rep_date));
                BppAccounts[BppAccounts.size] = InAcc.rec.account;

            /*Simanov
            * По КУ "Уплаченный НКД" с признаком БПП счета открываются не посделочно, а под фин. инструмент
            * Соответственно, один такой счёт может быть привязан к нескольким сделкам.
            * Находим этот счёт только один раз, этого достаточно. На всякий случай проверка, что такого счёта нет в массиве, если, например, будут разные портфели
            *///
            elif( FD.IsExistAccount("Уплаченный НКД", null, true, FIRole_bpp, InAcc, null, rep_date) and (Find(BppAccounts, InAcc.rec.Account) == -1) )
                NKDAmount = NKDAmount + ABS(GetRestAccount(InAcc.rec, rep_date));
                BppAccounts[BppAccounts.size] = InAcc.rec.account;
            end;
            sum_amount = sum_amount + int(sql.amount);/*GAA: 518683*/
        end;

        if(BppAccounts.size == 0)
            BppAccounts[BppAccounts.size] = "";
        end;

        FD = SPFirstDocFI(DLDOC_ISSUE, sql.fiid, sql.fiid, sql.portfolio, {OurBank}, null, null, null);

        FIRole = GetFIRoleByPortfolio(sql.portfolio, false, true, Bpp);    

        if( FD.IsExistAccount("Начисл.ПДД, ц/б", null, true, FIRole, InAcc, null, rep_date) )
            IncomeNKDAmount = ABS(GetRestAccount(InAcc.rec, rep_date));
        else
            IncomeNKDAmount = 0.0;
        end;

        allNKDAmount = NKDAmount + IncomeNKDAmount;

        calcNKD = НКД(sql.fiid, 
                    sum_amount, /*GAA:517683, old:*/
    //              int(sql.amount), 
                    rep_date, 
                    err, false,
                    true, false);

        diffNkdAmount = allNKDAmount - calcNKD;    
        oneAvrNKD = calcNKD / sum_amount; /*GAA:517683, old:int(sql.amount)*/
        
        for(var BppAccount, BppAccounts)
            if(isFirstAccount)
                PrintLine(
                    /*1*/  sql.name,
                    /*2*/  sql.isin,
                    /*3*/  sum_amount,
                    /*4*/  BppAccount,
                    /*5*/  NKDAmount,
                    /*6*/  InAcc.rec.account,
                    /*7*/  IncomeNKDAmount,
                    /*8*/  allNKDAmount,
                    /*9*/  calcNKD,
                    /*10*/ diffNkdAmount,
                    /*11*/ oneAvrNKD,
                    /*12*/ FiWarntDrawingDate(sql.fiid, rep_date)
                );

                isFirstAccount = false;
            else
                PrintLine(
                    /*1*/  "",
                    /*2*/  "",
                    /*3*/  "",
                    /*4*/  BppAccount,
                    /*5*/  "",
                    /*6*/  "",
                    /*7*/  "",
                    /*8*/  "",
                    /*9*/  "",
                    /*10*/ "",
                    /*11*/ "",
                    /*12*/ ""
                );
            end;
        end;
    end;

    MACRO Create( NumCopy:INTEGER )
        SetActiveSheet(SHEET_N1);

        PrintFormatString("", "N1_ReportHeader", "Отчет по сверке начисления купона на " + string(repdate:f));
        
        RegisterTable( "N1_TableLine", "",
              /*1*/    "N1_Name",
              /*2*/    "N1_ISIN",
              /*3*/    "N1_Amount",
              /*4*/    "N1_Account",
              /*5*/    "N1_NKDAmount",
              /*6*/    "N1_Portfolio",
              /*7*/    "N1_IncomeNKDAmount",
              /*8*/    "N1_allNKDAmount",
              /*9*/    "N1_calcNKD",
             /*10*/    "N1_diffNkdAmount",
             /*11*/    "N1_oneAvrNKD",
             /*12*/    "N1_Date" );

        sql = "";
    
        begaction(100,"Подготовка данных для отчета");
    
	/*var query =
    " with fin as (select /*+ materialize*/ " +
                    "  FIN.T_FIID " +
                    " ,FIN.T_NAME " +
                    " ,AVR.T_ISIN " +
                    "  from DFININSTR_DBT fin " +
                    "  join davoiriss_dbt AVR " +
                    "     on AVR.T_FIID = FIN.T_FIID " +
                    "  where RSI_RSB_FIINSTR.FI_AvrKindsGetRoot(fin.t_fi_kind, fin.t_avoirkind) = 17) " +
        " select count(*) over() as cnt_rec  " +
		      ", t_fiid " +
              " ,t_portfolio " +
              " ,t_state " +
              " ,T_NAME " +
              " ,T_ISIN " +
              " ,t_amount " +
              " ,T_INTERESTINCOME " +
       " from( select t_fiid " +
              " ,t_portfolio " +
              " ,t_state " +
              " ,T_NAME " +
              " ,T_ISIN " +
              " ,sum(t_amount) t_amount " +
              " ,sum(T_INTERESTINCOME) T_INTERESTINCOME" +
              "  from (select t_fiid " +
                            " ,t_portfolio " +
                            " ,t_state " +
                            " ,T_NAME " +
                            " ,T_ISIN " +
                            " ,t_amount " +
                            " ,T_INTERESTINCOME " +
                       " from (select /*+ leading(fin) cardinality(fin 10 ) */ " +
                              "  LOT.t_fiid " +
                              " ,LOT.t_portfolio " +
                              " ,LOT.t_state " +
                              " ,FIN.T_NAME " +
                              " ,FIN.T_ISIN " +
                              " ,LOT.t_amount " +
                              " ,LOT.T_INTERESTINCOME " +
                              " ,LOT.T_INSTANCE " +
                              " ,max(LOT.T_INSTANCE) over(partition by lot.t_sumid) as max_INSTANCE " +
                              "   from V_SCWRTHISTEX lot, FIN " +
                              "  where lot.t_changedate <= :m_date " +
                             "  and FIN.T_FIID = LOT.T_FIID) subq " +
                     "  where T_INSTANCE = max_INSTANCE) subq2 " +
              " where t_amount > 0 " +
              " and t_portfolio not in (0, 6) " +
              " and T_STATE in (1, 3) " +
              " group by t_fiid ,t_portfolio ,t_state ,T_NAME ,T_ISIN ) subq3" +
         " order by t_fiid ,t_portfolio ,t_state " ;*/
		 debugbreak;
	var query = "	with fin as ( "+
				"		select "+
				"			FIN.T_FIID , "+
				"			FIN.T_NAME , "+
				"			AVR.T_ISIN "+
				"		from "+
				"			DFININSTR_DBT fin "+
				"		join davoiriss_dbt AVR on "+ 
				"			AVR.T_FIID = FIN.T_FIID "+ 
				"		where "+ 
				"			RSI_RSB_FIINSTR.FI_AvrKindsGetRoot(fin.t_fi_kind, "+ 
				"			fin.t_avoirkind) = 17), "+ 
				"		cte_v1 as ( "+ 
				"		SELECT 			bc.t_fiid , "+ 
				"						bc.t_portfolio , "+ 
				"						bc.t_state , "+ 
				"						f.T_NAME , "+ 
				"						f.T_ISIN , "+ 
				"						bc.t_amount , "+ 
				"						bc.T_INTERESTINCOME , "+ 
				"						bc.T_INSTANCE, "+ 
				"						bc.t_sumid, "+ 
				"						bc.t_changedate "+ 
				"		FROM dpmwrtbc_dbt bc "+ 
				"		JOIN fin f ON bc.t_fiid = f.t_fiid JOIN dpmwrtsum_dbt lot ON bc.t_sumid = lot.t_sumid "+ 
				"		union all "+ 
				"		select bc.t_fiid , "+ 
				"						bc.t_portfolio , "+ 
				"						bc.t_state , "+ 
				"						f.T_NAME , "+ 
				"						f.T_ISIN , "+ 
				"						bc.t_amount , "+ 
				"						bc.T_INTERESTINCOME , "+ 
				"						bc.T_INSTANCE, "+ 
				"						bc.t_sumid, "+ 
				"						bc.t_changedate "+ 
				"						from dpmwrtsum_dbt bc JOIN fin f ON bc.t_fiid = f.t_fiid "+ 
				"		) "+ 
				"		select "+ 
				"			count(*) over() as cnt_rec , "+ 
				"			t_fiid , "+ 
				"			t_portfolio , "+ 
				"			t_state , "+ 
				"			T_NAME , "+ 
				"			T_ISIN , "+ 
				"			t_amount , "+ 
				"			T_INTERESTINCOME "+ 
				"		from "+ 
				"			( "+ 
				"			select "+ 
				"				t_fiid , "+ 
				"				t_portfolio , "+ 
				"				t_state , "+ 
				"				T_NAME , "+ 
				"				T_ISIN , "+ 
				"				sum(t_amount) t_amount , "+ 
				"				sum(T_INTERESTINCOME) T_INTERESTINCOME "+ 
				"			from "+ 
				"				( "+ 
				"				select "+ 
				"					t_fiid , "+ 
				"					t_portfolio , "+ 
				"					t_state , "+ 
				"					T_NAME , "+ 
				"					T_ISIN , "+ 
				"					t_amount , "+ 
				"					T_INTERESTINCOME "+ 
				"				from "+ 
				"					( "+ 
				"					select "+ 
				"						lot.* , "+ 
				"						max(LOT.T_INSTANCE) over(partition by lot.t_sumid) as max_INSTANCE "+ 
				"					from "+ 
				"						cte_v1 lot "+ 
				"					where "+ 
				"						lot.t_changedate <= ? "+ 
				"						) subq "+ 
				"				where "+ 
				"					T_INSTANCE = max_INSTANCE) subq2 "+ 
				"			where "+ 
				"				t_amount > 0 "+ 
				"				and t_portfolio not in (0, 6) "+ 
				"					and T_STATE in (1, 3) "+ 
				"				group by "+ 
				"					t_fiid , "+ 
				"					t_portfolio , "+ 
				"					t_state , "+ 
				"					T_NAME , "+ 
				"					T_ISIN ) subq3 "+ 
				"		order by "+ 
				"			t_fiid , "+ 
				"			t_portfolio , "+ 
				"			t_state  ";

    var cmd = DL_RSDCommand(query);
	//cmd.disableOraToPgConverter = true;
//        cmd.AddParam(rep_date);
        cmd.AddParam(repdate);

        var cnt = -1;
        var i = 0;  
        var portf = 0;/*DEF-61472 SD10327585*/  

        var sql = cmd.Execute();

        while(sql.movenext)
            if (cnt == -1)
                endaction();
                cnt = int(sql.cnt_rec);
                InitProgress(cnt, "Сбор данных", "Сбор данных");
            end;

            Bpp = sql.state == 3;

            if(Bpp)
                portf = sql.portfolio;/*DEF-61472 SD10327585*/
                print_bpp(repdate, sql,portf/*DEF-61472 SD10327585*/);
                continue;
            end;

            FD = SPFirstDocFI(DLDOC_ISSUE, 
                            sql.fiid, 
                            sql.fiid, 
                            sql.portfolio, 
                            {OurBank}, null, null, null);

            FIRole = GetFIRoleByPortfolio(sql.portfolio);

            CatCode = "Уплаченный НКД";
            FD_deal_nkd = FD;

            if( FD_deal_nkd.IsExistAccount(CatCode, null, true, FIRole, InAcc, null, repdate) )
                NKDAmount = ABS(GetRestAccount(InAcc.rec, repdate));
                Account = InAcc.rec.account;
            else
                Account = "";
                NKDAmount = 0.0;
            end;

            FIRole = GetFIRoleByPortfolio(sql.portfolio, false, true, Bpp);    
            CatCode = "Начисл.ПДД, ц/б";

            if( FD.IsExistAccount(CatCode, null, true, FIRole, InAcc, null, repdate) )
                IncomeNKDAmount = ABS(GetRestAccount(InAcc.rec, repdate));
                AccountCalc = InAcc.rec.account;
            else
                IncomeNKDAmount = 0.0;
                AccountCalc = "";
            end;

            allNKDAmount = NKDAmount + IncomeNKDAmount;

            calcNKD = НКД(sql.fiid, 
                        int(sql.amount), 
                        repdate, 
                        err, false,
                        true, false);

            diffNkdAmount = allNKDAmount - calcNKD;

    /*
            calcNKD = НКД(sql.fiid, 
                        1, 
                        rep_date, 
                        err, false,
                        true, false);
    */
            oneAvrNKD = calcNKD / int(sql.amount);

            PrintLine(
                /*1*/  sql.name,
                /*2*/  sql.isin,
                /*3*/  int(sql.amount),
                /*4*/  Account,
                /*5*/  NKDAmount,
                /*6*/  AccountCalc,
                /*7*/  IncomeNKDAmount,
                /*8*/  allNKDAmount,
                /*9*/  calcNKD,
                /*10*/ diffNkdAmount,
                /*11*/ oneAvrNKD,
                /*12*/ FiWarntDrawingDate(sql.fiid, repdate)
            );

            UseProgress(i = i + 1);
        end;

    RemProgress();

        RemProgress();

        //Rep.SetFileName("ОД_26_"+rep_date);

        EndTable();
    END;

    initCB_CReportTemplate(NULL, "Report_od26.xlsx", true, null, null, true, true, WINREP_FORMAT_XLSX); //бьем таблицу

END; // class od26Report


private const FT_STRING = 7;
private const FT_DATE = 9;
class (TRsbPanel) DateReportPanel()
    InitTRsbPanel();
    setSize(35,4);
    setPosition(35,15);

    class (TRsbEditField) EditField(typeFld: integer, x: integer, y: integer, width: integer, height: integer, bindVal, active: bool, fieldName: string, panel)
        var bindString = string(bindVal);
        
        initTRsbEditField(typeFld);
        setPosition(x, y);
        setSize(width, height);
        
        if(active == false) 
            editable = focusable = false; 
        end;

        if(typeFld == FT_STRING)
            bindValue( this, "bindString", 100 );
        elif(bindVal != null)
            value = bindVal; 
        end;

        if(panel != null)
            panel.addControl(this); 
        end;

        if(fieldName != null) 
            name = fieldName; 
        end;
    end;

    addLabel(TRsbLabel(3, 2, "Укажите дату:"));
    var m_DateBegin = EditField( FT_DATE, 20, 2, 10, 1, {curdate}, true, "Date", this );

    m_DateBegin.addEventHandler(RSB_EV_KEY_PRESSED,  R2M(this, "DATEBEGIN_KEY_PRESSED"));
    addEventHandler(RSB_EV_KEY_PRESSED, R2M(this, "Panel_ButtonEvent"));

    macro DATEBEGIN_KEY_PRESSED(RsbEvent)
       if(RsbEvent.keyCode == 317)
           m_DateBegin.value = GetDateByCalendar(m_DateBegin.value);
       elif((RsbEvent.keyCode == 408) OR (RsbEvent.keyCode == 411))/*KEY_ALT_UP KEY_ALT_LEFT*/
           m_DateBegin.value = m_DateBegin.value - 1;
       elif((RsbEvent.keyCode == 416) OR (RsbEvent.keyCode == 413))/*KEY_ALT_DOWN KEY_ALT_RIGHT*/
           m_DateBegin.value = m_DateBegin.value + 1;
       end;
    end;

    macro Panel_ButtonEvent(RsbEvent)
       var Rep;
       if((RsbEvent.keyCode == 316) or (RsbEvent.keyCode == 13))
          Rep = od26Report(m_DateBegin.value);
          Rep.Run();
          close(1);       
       elif(RsbEvent.keyCode == 27)
          close(0);
       end;
    end;
end;  

var panel = DateReportPanel();
    panel.setCaption("Отчет по сверке начисления купона");
    panel.run();

exit(1);