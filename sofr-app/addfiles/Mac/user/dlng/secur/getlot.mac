macro ПолучитьЛотНаДату( SumID, dat, wrtsum:@TRecHandler )
  var cmd, RSD;

   if( SumID <= 0)
      return false;
   end;

   cmd = RSDCommand("select * " +
                    "  from dpmwrtsum_dbt " +
                    " where t_SumID = ?");
   cmd.addParam("", RSDBP_IN, SumID);

   cmd.execute();

   RSD = TRsbDataSet(cmd);

   if( RSD.MoveNext() )
      RSD.GetRecord().CopyTo( wrtsum.rec );
   else
      return false;
   end;

   if( wrtsum.rec.ChangeDate >= dat )
      cmd = RSDCommand("select * " +
                       "  from dpmwrtbc_dbt " +
                       " where t_SumID    = ? and " +
                       "       t_Instance = ( select max(t_Instance) " +
                       "                        from dpmwrtbc_dbt " +
                       "                       where t_SumID     = ? and " +
                       "                             t_ChangeDate < ? )");
      cmd.addParam("", RSDBP_IN, SumID);
      cmd.addParam("", RSDBP_IN, SumID);
      cmd.addParam("", RSDBP_IN, dat);

      cmd.execute();

      RSD = TRsbDataSet(cmd);

      if( RSD.MoveNext() )
         wrtsum.rec.ID_Operation     = RSD.rec.ID_Operation     ;
         wrtsum.rec.ID_Step          = RSD.rec.ID_Step          ;
         wrtsum.rec.Instance         = RSD.rec.Instance         ;
         wrtsum.rec.Action           = RSD.rec.Action           ;
         wrtsum.rec.ChangeDate       = RSD.rec.ChangeDate       ;
         wrtsum.rec.FIID             = RSD.rec.FIID             ;
         wrtsum.rec.Portfolio        = RSD.rec.Portfolio        ;
         wrtsum.rec.GroupID          = RSD.rec.GroupID          ;
         wrtsum.rec.Date             = RSD.rec.Date             ;
         wrtsum.rec.Time             = RSD.rec.Time             ;
         wrtsum.rec.Amount           = RSD.rec.Amount           ;
         wrtsum.rec.AmountBD         = RSD.rec.AmountBD         ;
         wrtsum.rec.Sum              = RSD.rec.Sum              ;
         wrtsum.rec.Currency         = RSD.rec.Currency         ;
         wrtsum.rec.Cost             = RSD.rec.Cost             ;
         wrtsum.rec.BalanceCost      = RSD.rec.BalanceCost      ;
         wrtsum.rec.BalanceCostBD    = RSD.rec.BalanceCostBD    ;
         wrtsum.rec.NKDAmount        = RSD.rec.NKDAmount        ;
         wrtsum.rec.InterestIncome   = RSD.rec.InterestIncome   ;
         wrtsum.rec.NotCarryInterest = RSD.rec.NotCarryInterest ;
         wrtsum.rec.InterestDate     = RSD.rec.InterestDate     ;
/*         wrtsum.rec.BegDate          = RSD.rec.BegDate          ;*/ 
         wrtsum.rec.BegDiscount      = RSD.rec.BegDiscount      ;
         wrtsum.rec.DiscountIncome   = RSD.rec.DiscountIncome   ;
         wrtsum.rec.NotCarryDiscount = RSD.rec.NotCarryDiscount ;
         wrtsum.rec.DiscountDate     = RSD.rec.DiscountDate     ;
         wrtsum.rec.Outlay           = RSD.rec.Outlay           ;
         wrtsum.rec.ReservAmount     = RSD.rec.ReservAmount     ;
         wrtsum.rec.ReservDate       = RSD.rec.ReservDate       ;
         wrtsum.rec.OverAmount       = RSD.rec.OverAmount       ;
         wrtsum.rec.OverDate         = RSD.rec.OverDate         ;
         wrtsum.rec.OverAmountBD     = RSD.rec.OverAmountBD     ;
         wrtsum.rec.State            = RSD.rec.State            ;
         wrtsum.rec.StateDate        = RSD.rec.StateDate        ;


         wrtsum.rec.CORRINTTOEIR    = RSD.rec.CORRINTTOEIR     ;
         wrtsum.rec.RESERVAMOUNT    = RSD.rec.RESERVAMOUNT     ;
         wrtsum.rec.INCOMERESERV    = RSD.rec.INCOMERESERV     ;
         wrtsum.rec.CORRESTRESERVE  = RSD.rec.CORRESTRESERVE   ;
         wrtsum.rec.ESTRESERVE      = RSD.rec.ESTRESERVE       ;




         wrtsum.rec.BegBonus         = RSD.rec.BegBonus         ;
         wrtsum.rec.Bonus            = RSD.rec.Bonus            ;
         wrtsum.rec.NotWrtBonus      = RSD.rec.NotWrtBonus   ;
          if(ValType(RSD.rec.costpfi) == V_UNDEF)
         wrtsum.rec.costpfi          = 0;
          else
         wrtsum.rec.costpfi          =   RSD.rec.costpfi   ;      //      SD-1976169
          end;
      end;
   end;

   return true;

end;