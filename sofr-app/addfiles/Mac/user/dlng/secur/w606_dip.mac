/*
$Name:        w606_dip.mac
$Module:      Ценные бумаги
$Description: Формирование данных для ЦКРР (долговые эмиссионные бумаги)
$Programmer:  Кротов А.
*/
import rsd, captureoutput;

macro RecordSetDIP(dt)
  var cmd;
  /*Чистим и наполняем GT данными*/
  StartCaptureOutput();
  [ 
    declare 
      type Type_W606 is table of DW606_U_TMP%rowtype;
      Coll_W606 Type_W606 := Type_W606();
      dt date := ?;--to_date('02.06.2016','dd.mm.yyyy');
      v_t_parentid dobjattr_dbt.t_parentid%type;
    begin
      -- Удаляем данные за дату (если есть)
      delete from DW606_U_TMP where t_TypeFI = 'Эмиссионная бумага';

      -- Проходим по эмиссионным бумагам
      for v in (select lots.t_issuer t_partyid,
                       lots.t_date t_start,
                       'Эмиссионная бумага' TypeFI,
                       case when (select count(1) 
                                  from dpartyown_dbt partyown 
                                  where partyown.t_partyid = lots.t_issuer and 
                                        partyown.t_partykind = 16/*PTK_STATE_BODY_SUBJECT*/) > 0 then 'SUBSOVEREIGN' 
                            when (select count(1) 
                                  from dpartyown_dbt partyown 
                                  where partyown.t_partyid = lots.t_issuer and 
                                        partyown.t_partykind = 15/*PTK_STATE_BODY*/) > 0 then 'SOVEREIGN' 
                            when (select count(1) 
                                  from dpartyown_dbt partyown 
                                  where partyown.t_partyid = lots.t_issuer and 
                                        partyown.t_partykind = 2/*PTK_BANK*/) > 0 then 'FINANCIAL' 
                            else 'CORPORATE' end TypeIssuer, 
                       dt ReportDate,
                       lots.t_balancecost BalanceDebt,
                       lots.t_currency Currency,
                       chr(1) FIID,
                       lots.t_isin ISIN,
                       chr(1) DealID,
                       lots.t_date BuyDate,
                       case when lots.t_minrawingdate1 is null then nvl(lots.t_mindrawingdate2,to_date('01.01.0001','dd.mm.yyyy')) 
                            when lots.t_mindrawingdate2 is not null then least(lots.t_minrawingdate1, lots.t_mindrawingdate2) 
                            else lots.t_minrawingdate1 end MaturityDate,
                       case when lots.t_issuer is null then chr(1)
                            else (select nvl(max(objcode.t_code),chr(1)) 
                                  from dobjcode_dbt objcode 
                                  where objcode.t_objecttype = 3 and 
                                        objcode.t_codekind = 101/*КОД В БИСКВИТ*/ and
                                        objcode.t_objectid = lots.t_issuer and 
                                        objcode.t_bankdate < dt and 
                                        (objcode.t_bankclosedate = to_date('01.01.0001','dd.mm.yyyy') or objcode.t_bankclosedate >= dt)) end IssuerId,
                       chr(1) ContractorId,
                       case when lots.t_issuer is null then chr(1)
                            else (select nvl(regexp_substr(max(objcode.t_code),'^\d{0,}'),chr(1)) 
                                  from dobjcode_dbt objcode 
                                  where objcode.t_objecttype = 3 and 
                                        objcode.t_codekind = 16/*ИНН*/ and
                                        objcode.t_objectid = lots.t_issuer and 
                                        objcode.t_bankdate < dt and 
                                        (objcode.t_bankclosedate = to_date('01.01.0001','dd.mm.yyyy') or objcode.t_bankclosedate >= dt)) end IssuerINN,
                       chr(1) ContractorINN,
                       nvl(issuer.t_name, chr(1)) IssuetName,
                       chr(1) ContractorName,
                       nvl(rsi_rsbcalendar.getWorkDayCount(case when lots.t_minrawingdate1 is null then nvl(lots.t_mindrawingdate2,dt) 
                                                                when lots.t_mindrawingdate2 is not null then least(lots.t_minrawingdate1, lots.t_mindrawingdate2) 
                                                                else lots.t_minrawingdate1 end, dt-1),0) Expiration,
                       0 CollateralValue,

                       /* ВР */
                       (SELECT m.t_account 
                        FROM dmcaccdoc_dbt m
                        WHERE m.t_catnum = 231 and m.t_fiid = lots.t_fiid and m.t_isusable = chr(88) 
                              AND ( (m.t_templnum IN (12, 13, 14, 15, 16, 17, 18, 26, 27, 28, 29, 53) AND (lots.t_portfolio = 'СССД_ЦБ'))
                                     OR (m.t_templnum IN (64, 65, 66, 67, 68, 69, 70, 71) AND (lots.t_portfolio = 'АС_ЦБ'))
                                     OR (m.t_templnum IN (38) AND (lots.t_portfolio = 'ПДО'))
                                   )
                              and rownum = 1
                       ) AccountNumber, 

                       case when lots.t_issuer is null then chr(1)
                            else (select nvl(max(objcode.t_code),chr(1)) 
                                  from dobjcode_dbt objcode 
                                  where objcode.t_objecttype = 3 and 
                                        objcode.t_codekind = 6/*BIC ISO (SWIFT)*/ and
                                        objcode.t_objectid = lots.t_issuer and 
                                        objcode.t_bankdate < dt and 
                                        (objcode.t_bankclosedate = to_date('01.01.0001','dd.mm.yyyy') or objcode.t_bankclosedate >= dt)) end SWIFT,
                       case when lots.t_drawingdur > 0 then lots.t_drawingdur 
                            else 0 end YearsToMaturity,
                       'Да' SPPI,
                       case when lots.t_portfolio = 'АС_ЦБ' then 2 
                            when lots.t_portfolio = 'ПДО' then 2 
                            else 1 
                       end BusinessModel,
                       case when lots.t_portfolio = 'АС_ЦБ' then 'АС'
                            when lots.t_portfolio = 'ПДО' then 'ПДО'
                            else 'СССД' 
                       end EvaluationCategory
                from (select lots.t_fiid, 
                             lots.t_date, 
                             lots.t_portfolio t_portfolio,
                             lots.t_balancecost, 
                             nvl(fininstrcurrency.t_ccy,0) t_currency,
                             nvl(avoiriss.t_isin,chr(1)) t_isin,
                             round(months_between(nvl(fininstr.t_drawingdate,dt), dt-1)/12,12) t_drawingdur, 
                             (select min(fiwarnts.t_drawingdate) 
                              from dfiwarnts_dbt fiwarnts 
                              where fiwarnts.t_fiid = lots.t_fiid and 
                                    fiwarnts.t_ispartial = chr(0) and
                                    fiwarnts.t_spisclosed != chr(88)) t_minrawingdate1,
                             (select min(fiwarnts.t_drawingdate) 
                              from dfiwarnts_dbt fiwarnts 
                              where fiwarnts.t_fiid = lots.t_fiid and 
                                    fiwarnts.t_ispartial = chr(0) and
                                    fiwarnts.t_drawingdate >= dt) t_mindrawingdate2,
                            (select max(v_fi_issuer_hist.t_issuer) 
                             from dv_fi_issuer_hist v_fi_issuer_hist
                             where v_fi_issuer_hist.t_fiid = lots.t_fiid and
                                   v_fi_issuer_hist.t_begdate < dt and 
                                   (v_fi_issuer_hist.t_enddate = to_date('01.01.0001','dd.mm.yyyy') or v_fi_issuer_hist.t_enddate >= dt)) t_issuer
                      from (select lots.t_fiid t_fiid, 
                                   lots.t_date t_date, 
                                   lots.t_portfolio t_portfolio,
                                   nvl(sum(lots.t_balancecost),0) t_balancecost, 
                                   lots.t_currency t_currency
                            from (select pmwrtsum.t_sumid t_sumid, 
                                         pmwrtsum.t_fiid t_fiid, 
                                         pmwrtsum.t_date t_date, 
                                         portfolio.t_code t_portfolio,
                                         /* ВР */
                                         RSI_RSB_FIInstr.ConvSum(pmwrtsum.t_balancecost, pmwrtsum.t_currency, 0, dt-1, 1) t_balancecost,
                                         /*
                                         RSI_RSB_FIInstr.ConvSum(pmwrtsum.t_cost + pmwrtsum.t_nkdamount + pmwrtsum.t_interestincome + pmwrtsum.t_discountincome + pmwrtsum.t_corrinttoeir, 
                                         pmwrtsum.t_currency, 0, dt-1, 1) + pmwrtsum.t_overamount t_balancecost, 
                                         */
                                         pmwrtsum.t_currency t_currency  
                                  from dpmwrtsum_dbt pmwrtsum
                                  join dfininstr_dbt fininstr on fininstr.t_fiid = pmwrtsum.t_fiid and 
                                                                 fininstr.t_fi_kind = 2 and 
                                                                 RSI_RSB_FIInstr.FI_AvrKindsGetRoot(2, fininstr.t_avoirkind) = 17/*RSI_RSB_FIInstr.AVOIRKIND_BOND*/ 
                                  join dllvalues_dbt portfolio on portfolio.t_list = 1100 and 
                                                                  portfolio.t_element = pmwrtsum.t_portfolio and 
                                                                  portfolio.t_code in ('СССД_ЦБ', 'АС_ЦБ', 'ПДО')
                            where pmwrtsum.t_buy_sale = 0 and
                                  pmwrtsum.t_date < dt and
                                  pmwrtsum.t_balancecost > 0 and
                                  pmwrtsum.t_changedate < dt
                            union all
                            select pmwrtbc.t_sumid t_sumid, 
                                   pmwrtbc.t_fiid t_fiid, 
                                   pmwrtbc.t_date t_date, 
                                   portfolio.t_code t_portfolio,
                                   /* ВР */
                                   RSI_RSB_FIInstr.ConvSum(pmwrtbc.t_balancecost, pmwrtbc.t_currency, 0, dt-1, 1) t_balancecost,
                                   /*
                                   RSI_RSB_FIInstr.ConvSum(pmwrtbc.t_cost + pmwrtbc.t_nkdamount + pmwrtbc.t_interestincome + pmwrtbc.t_discountincome + pmwrtbc.t_corrinttoeir, 
                                   pmwrtbc.t_currency, 0, dt-1, 1) + pmwrtbc.t_overamount t_balancecost, 
                                   */
                                   pmwrtbc.t_currency t_currency
                            from (select pmwrtsum.t_sumid, 
                                         max(pmwrtbc.t_bcid) t_bcid  
                                  from dpmwrtsum_dbt pmwrtsum
                                  join dpmwrtbc_dbt pmwrtbc on pmwrtbc.t_sumid = pmwrtsum.t_sumid and 
                                                               pmwrtbc.t_changedate < dt  
                                  where pmwrtsum.t_buy_sale = 0 and
                                        pmwrtsum.t_changedate >= dt
                                  group by pmwrtsum.t_sumid) pmwrtsum
                            join dpmwrtbc_dbt pmwrtbc on pmwrtbc.t_bcid = pmwrtsum.t_bcid and
                                                         pmwrtbc.t_date < dt and
                                                         pmwrtbc.t_balancecost > 0   
                            join dfininstr_dbt fininstr on fininstr.t_fiid = pmwrtbc.t_fiid and 
                                                           fininstr.t_fi_kind = 2 and 
                                                           RSI_RSB_FIInstr.FI_AvrKindsGetRoot(2, fininstr.t_avoirkind) = 17/*RSI_RSB_FIInstr.AVOIRKIND_BOND*/ 
                            join dllvalues_dbt portfolio on portfolio.t_list = 1100 and 
                                                            portfolio.t_element = pmwrtbc.t_portfolio and 
                                                            portfolio.t_code in ('СССД_ЦБ', 'АС_ЦБ', 'ПДО')) lots
                            group by lots.t_fiid, lots.t_date, lots.t_portfolio, lots.t_currency) lots
                      left join dfininstr_dbt fininstr on fininstr.t_fiid = lots.t_fiid
                      left join davoiriss_dbt avoiriss on avoiriss.t_fiid = lots.t_fiid
                      left join dfininstr_dbt fininstrcurrency on fininstrcurrency.t_fiid = lots.t_currency and 
                                                                  fininstrcurrency.t_fi_kind = 1) lots
                left join dparty_dbt issuer on issuer.t_partyid = lots.t_issuer)
      loop
        -- Добавляем значение в коллекцию
        Coll_W606.extend();
        Coll_W606(Coll_W606.last).t_TypeFI := v.TypeFI;
        Coll_W606(Coll_W606.last).t_TypeIssuer := v.TypeIssuer;
        Coll_W606(Coll_W606.last).t_ReportDate := v.ReportDate;
        Coll_W606(Coll_W606.last).t_BalanceDebt := v.BalanceDebt;
        Coll_W606(Coll_W606.last).t_Currency := v.Currency;
        Coll_W606(Coll_W606.last).t_FIID := v.FIID;
        Coll_W606(Coll_W606.last).t_ISIN := v.ISIN;
        Coll_W606(Coll_W606.last).t_DealID := v.DealID;
        Coll_W606(Coll_W606.last).t_BuyDate := v.BuyDate;
        Coll_W606(Coll_W606.last).t_MaturityDate := v.MaturityDate;
        Coll_W606(Coll_W606.last).t_IssuerId := v.IssuerId;
        Coll_W606(Coll_W606.last).t_ContractorId := v.ContractorId;
        Coll_W606(Coll_W606.last).t_IssuerINN := v.IssuerINN;
        Coll_W606(Coll_W606.last).t_ContractorINN := v.ContractorINN;
        Coll_W606(Coll_W606.last).t_IssuetName := v.IssuetName;
        Coll_W606(Coll_W606.last).t_ContractorName := v.ContractorName;
        Coll_W606(Coll_W606.last).t_Expiration := v.Expiration;
        -- Ищем текущий рейтинг
        begin
          select t_validfromdate, t_name, t_codelist, t_parentid
          into Coll_W606(Coll_W606.last).t_RatingDate, Coll_W606(Coll_W606.last).t_RatingCurrent, Coll_W606(Coll_W606.last).t_RatingSource, v_t_parentid
          from (select objatcor.t_validfromdate,
                       objattr.t_name,
                       objattr.t_codelist,
                       objattr.t_parentid,
                       row_number() over(order by objatcor.t_validfromdate) rnum
                from dobjatcor_dbt objatcor 
                join dobjattr_dbt objattr on objattr.t_objecttype = objatcor.t_objecttype and 
                                             objattr.t_groupid = objatcor.t_groupid and 
                                             objattr.t_attrid = objatcor.t_attrid
                where objatcor.t_objecttype = 3 and 
                      objatcor.t_groupid = 19 /*Рейтинг*/ and 
                      objatcor.t_object = lpad(v.t_partyid, 10, '0') and 
                      objatcor.t_validfromdate <= dt-1 and 
                      objatcor.t_validtodate >= dt-1 and
                      objatcor.t_general = chr(88))
          where rnum = 1;
          -- Ищем рейтинг той же группы за дату сделки
          begin
            select t_name
            into Coll_W606(Coll_W606.last).t_RatingFirst
            from (select objattrfirst.t_name t_name, row_number() over(order by objatcorfirst.t_general desc, objatcorfirst.t_validfromdate) rnum
                  from dobjatcor_dbt objatcorfirst 
                  left join dobjattr_dbt objattrfirst on objattrfirst.t_objecttype = objatcorfirst.t_objecttype and 
                                                         objattrfirst.t_groupid = objatcorfirst.t_groupid and 
                                                         objattrfirst.t_attrid = objatcorfirst.t_attrid and 
                                                         objattrfirst.t_parentid = v_t_parentid 
                  where objatcorfirst.t_objecttype = 3 and 
                        objatcorfirst.t_groupid = 19 /*Рейтинг*/ and 
                        objatcorfirst.t_object = lpad(v.t_partyid, 10, '0') and 
                        objatcorfirst.t_validfromdate <= v.t_start and 
                        objatcorfirst.t_validtodate >= v.t_start)
            where rnum = 1;
          exception when no_data_found then
            Coll_W606(Coll_W606.last).t_RatingFirst := chr(1);
          end;
        exception when no_data_found then
          Coll_W606(Coll_W606.last).t_RatingDate := to_date('01.01.0001','dd.mm.yyyy');
          Coll_W606(Coll_W606.last).t_RatingFirst := chr(1);
          Coll_W606(Coll_W606.last).t_RatingCurrent := chr(1);
          Coll_W606(Coll_W606.last).t_RatingSource := chr(1);
        end;
        Coll_W606(Coll_W606.last).t_CollateralValue := v.CollateralValue;
        Coll_W606(Coll_W606.last).t_AccountNumber := v.AccountNumber;
        Coll_W606(Coll_W606.last).t_SWIFT := v.SWIFT;
        Coll_W606(Coll_W606.last).t_YearsToMaturity := v.YearsToMaturity;
        Coll_W606(Coll_W606.last).t_SPPI := v.SPPI;
        Coll_W606(Coll_W606.last).t_BusinessModel := v.BusinessModel;
        Coll_W606(Coll_W606.last).t_EvaluationCategory := v.EvaluationCategory;
      end loop;

      -- Сохраняем коллекцию
      forall i in Coll_W606.first .. Coll_W606.last
        insert into DW606_U_TMP values Coll_W606(i);

    end;
  ];
  cmd = RSDCommand(EndCaptureOutput());
  cmd.AddParam("dt", RSDBP_IN, dt);
  cmd.Execute();
end;

