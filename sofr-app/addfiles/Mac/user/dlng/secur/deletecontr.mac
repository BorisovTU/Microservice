import globals, cb_sql;

private macro createTables()
var sql = 
"   BEGIN " +
"      FOR i IN (SELECT * " +
"                  FROM (SELECT 'DACCBALANCE_DBT' tab FROM DUAL " +
"                        UNION " +
"                        SELECT 'DACCBLNC_DBT' tab FROM DUAL " +
"                        UNION " +
"                        SELECT 'drestdate_dbt' tab FROM DUAL " +
"                        UNION " +
"                        SELECT 'daccount_dbt' tab FROM DUAL " +
"                        UNION " +
"                        SELECT 'dmcaccdoc_dbt' tab FROM DUAL " +
"                        UNION " +
"                        SELECT 'dsettacc_dbt' tab FROM DUAL " +
"                        UNION " +
"                        SELECT 'dsfssi_dbt' tab FROM DUAL " +
"                        UNION " +
"                        SELECT 'dobjatcor_dbt' tab FROM DUAL " +
"                        UNION " +
"                        SELECT 'dnotetext_dbt' tab FROM DUAL " +
"                        UNION " +
"                        SELECT 'dsfcontr_dbt' tab FROM DUAL " +
"                        UNION " +
"                        SELECT 'DIMGDATA_DBT' tab FROM DUAL " +
"                        UNION " +
"                        SELECT 'dimage_dbt' tab FROM DUAL " +
"                        UNION " +
"                        SELECT 'ddlcontrmsg_dbt' tab FROM DUAL " +
"                        UNION " +
"                        SELECT 'ddlcontr_dbt' tab FROM DUAL " +
"                        UNION " +
"                        SELECT 'dobjcode_dbt' tab FROM DUAL " +
"                        UNION " +
"                        SELECT 'DDLCONTRMP_DBT' tab FROM DUAL) " +
"                 WHERE NOT EXISTS " +
"                          (SELECT 1 " +
"                             FROM user_tables " +
"                            WHERE table_name = UPPER ('DELDBO_' || tab))) " +
"      LOOP " +
"         DBMS_OUTPUT.put_line ('DELDBO_' || i.tab); " +
" " +
"         EXECUTE IMMEDIATE 'create table ' || 'DELDBO_' || i.tab " +
"                          || ' as select 123456 t_deldlcontrid, sysdate t_delsysdate,  RsbSessionData.Oper t_deloper, t.* from ' " +
"                          || i.tab " +
"                          || ' t where 1=2'; " +
"      END LOOP; " +
"   END; " ;
var cmd = RsdCommand(sql);
    cmd.execute();

end;

private macro delContr_sql(dlid, err:@string)
var sql;

sql = 
"DECLARE  " +
"   dlid   NUMBER (10) := :dlid;  " +
"   sfid   NUMBER (10);  " +
"   ptid   NUMBER (10);  " +
"   cnt    NUMBER (10);  " +
"BEGIN  " +
"   BEGIN  " +
"      SELECT t_sfcontrid,  " +
"             (SELECT t_partyid  " +
"                FROM DSFCONTR_DBT  " +
"               WHERE t_id = t.t_sfcontrid)  " +
"                ptid  " +
"        INTO sfid, ptid  " +
"        FROM ddlcontr_dbt t  " +
"       WHERE t_dlcontrid = dlid;  " +
"   EXCEPTION  " +
"      WHEN NO_DATA_FOUND  " +
"      THEN  " +
"         DBMS_OUTPUT.put_line ('Не найден ДБО: ' || dlid);  " +
"         RETURN;  " +
"   END;  " +
"  " +
"  " +
"  " +
"   FOR i IN (SELECT t_sfcontrid  " +
"               FROM ddlcontrmp_dbt  " +
"              WHERE t_dlcontrid = dlid)  " +
"   LOOP  " +
"      FOR ac  " +
"         IN (SELECT t_account, t_chapter  " +
"               FROM dsettacc_dbt  " +
"              WHERE t_settaccid IN  " +
"                       (SELECT t_setaccid  " +
"                          FROM dsfssi_dbt  " +
"                         WHERE t_objecttype = 659 AND t_objectid = LPAD (i.t_sfcontrid, 10, '0'))  " +
"          UNION ALL                                                                                " +
"          SELECT t_account, t_chapter                                                              " +
"            FROM dmcaccdoc_dbt                                                                     " +
"           WHERE t_clientcontrid = i.t_sfcontrid                                                   " +
"                                                                                                   " +
"  )  " +
"      LOOP  " +
"  " +
"         INSERT INTO DELDBO_DACCBALANCE_DBT SELECT dlid, sysdate, RsbSessionData.Oper, t.* FROM DACCBALANCE_DBT t  " +
"               WHERE t_accountid =  " +
"                        (SELECT t_accountid  " +
"                           FROM daccount_dbt  " +
"                          WHERE t_account = ac.t_account  " +
"                                AND t_chapter = ac.t_chapter);  " +
"  " +
"         DELETE FROM DACCBALANCE_DBT  " +
"               WHERE t_accountid =  " +
"                        (SELECT t_accountid  " +
"                           FROM daccount_dbt  " +
"                          WHERE t_account = ac.t_account  " +
"                                AND t_chapter = ac.t_chapter)  " +
"           RETURNING COUNT (1)  " +
"                INTO cnt;  " +
"  " +
"         DBMS_OUTPUT.put_line ('    Удалено DACCBALANCE_DBT: ' || cnt);  " +
"  " +
"         INSERT INTO DELDBO_DACCBLNC_DBT SELECT dlid, sysdate, RsbSessionData.Oper, t.*  " +
"         FROM DACCBLNC_DBT t  " +
"               WHERE t_accountid =  " +
"                        (SELECT t_accountid  " +
"                           FROM daccount_dbt  " +
"                          WHERE t_account = ac.t_account  " +
"                                AND t_chapter = ac.t_chapter);  " +
"  " +
"  " +
"         DELETE FROM DACCBLNC_DBT  " +
"               WHERE t_accountid =  " +
"                        (SELECT t_accountid  " +
"                           FROM daccount_dbt  " +
"                          WHERE t_account = ac.t_account  " +
"                                AND t_chapter = ac.t_chapter)  " +
"           RETURNING COUNT (1)  " +
"                INTO cnt;  " +
"  " +
"         DBMS_OUTPUT.put_line ('    Удалено DACCBLNC_DBT: ' || cnt);  " +
"  " +
"         BEGIN  " +
"  " +
"         INSERT INTO DELDBO_DRESTDATE_DBT SELECT dlid, sysdate, RsbSessionData.Oper, t.*  " +
"         FROM drestdate_dbt t  " +
"         WHERE t_accountid =  " +
"                           (SELECT t_accountid  " +
"                              FROM daccount_dbt  " +
"                             WHERE t_account = ac.t_account  " +
"                                   AND t_chapter = ac.t_chapter);  " +
"                                     " +
"            DELETE FROM drestdate_dbt t  " +
"                  WHERE t_accountid =  " +
"                           (SELECT t_accountid  " +
"                              FROM daccount_dbt  " +
"                             WHERE t_account = ac.t_account  " +
"                                   AND t_chapter = ac.t_chapter)  " +
"              RETURNING COUNT (1)  " +
"                   INTO cnt;  " +
"         EXCEPTION  " +
"            WHEN OTHERS  " +
"            THEN  " +
"               DBMS_OUTPUT.  " +
"                put_line (  " +
"                  '    Удалить вручную daccount_dbt: '  " +
"                  || ac.t_account);  " +
"         END;  " +
"  " +
"         IF cnt = -1  " +
"         THEN  " +
"            DBMS_OUTPUT.put_line ('    НЕ Удалено drestdate_dbt');  " +
"         ELSE  " +
"            DBMS_OUTPUT.  " +
"             put_line ('    Удалено drestdate_dbt: ' || cnt);  " +
"         END IF;  " +
"  " +
"         INSERT INTO DELDBO_DACCOUNT_DBT SELECT dlid, sysdate, RsbSessionData.Oper, t.*  " +
"         FROM daccount_dbt t  " +
"               WHERE t_account = ac.t_account AND t_chapter = ac.t_chapter;  " +
"  " +
"         DELETE FROM daccount_dbt  " +
"               WHERE t_account = ac.t_account AND t_chapter = ac.t_chapter  " +
"           RETURNING COUNT (1)  " +
"                INTO cnt;  " +
"  " +
"         IF cnt = -1  " +
"         THEN  " +
"            DBMS_OUTPUT.put_line ('    НЕ Удалено daccount_dbt');  " +
"         ELSE  " +
"            DBMS_OUTPUT.put_line ('    Удалено daccount_dbt: ' || cnt);  " +
"         END IF;  " +
"  " +
"         INSERT INTO DELDBO_DMCACCDOC_DBT SELECT dlid, sysdate, RsbSessionData.Oper, t.*  " +
"         FROM dmcaccdoc_dbt t  " +
"               WHERE t_account = ac.t_account AND t_chapter = ac.t_chapter;  " +
"  " +
"         DELETE FROM dmcaccdoc_dbt  " +
"               WHERE t_account = ac.t_account AND t_chapter = ac.t_chapter  " +
"           RETURNING COUNT (1)  " +
"                INTO cnt;  " +
"  " +
"         DBMS_OUTPUT.put_line ('    Удалено dmcaccdoc_dbt: ' || cnt);  " +
"      END LOOP;  " +
"         INSERT INTO DELDBO_dsettacc_dbt SELECT dlid, sysdate, RsbSessionData.Oper,   " +
"               T_SETTACCID, T_PARTYID, T_BANKID,  " +
"             T_FIID, T_CHAPTER, T_ACCOUNT,  " +
"             T_INN, T_RECNAME, T_BANKCODEKIND,  " +
"             T_BANKCODE, T_BANKNAME, T_BANKCORRID,  " +
"             T_BANKCORRCODEKIND, T_BANKCORRCODE, T_BANKCORRNAME,  " +
"             T_CORRACC, T_FIKIND, T_BENEFICIARYID,  " +
"             T_CODEKIND, T_CODE, T_DESCRIPTION,  " +
"             T_ORDER, T_SHORTNAME, T_NOACCEPT,  " +
"             T_KZPARTYCODE, T_SPI_IDENT " +
"                       FROM dsettacc_dbt t  " +
"            WHERE t_settaccid IN  " +
"                     (SELECT t_setaccid  " +
"                        FROM dsfssi_dbt  " +
"                       WHERE t_objecttype = 659 AND t_objectid = LPAD (i.t_sfcontrid, 10, '0'));  " +
"  " +
"      DELETE FROM dsettacc_dbt  " +
"            WHERE t_settaccid IN  " +
"                     (SELECT t_setaccid  " +
"                        FROM dsfssi_dbt  " +
"                       WHERE t_objecttype = 659 AND t_objectid = LPAD (i.t_sfcontrid, 10, '0'))  " +
"        RETURNING COUNT (1)  " +
"             INTO cnt;  " +
"  " +
"      DBMS_OUTPUT.put_line ('    Удалено dsettacc_dbt: ' || cnt);  " +
"  " +
"      INSERT INTO DELDBO_dsfssi_dbt SELECT dlid, sysdate, RsbSessionData.Oper, t.* FROM dsfssi_dbt t  " +
"            WHERE t_objecttype = 659 AND t_objectid = LPAD (i.t_sfcontrid, 10, '0');  " +
"  " +
"      DELETE FROM dsfssi_dbt  " +
"            WHERE t_objecttype = 659 AND t_objectid = LPAD (i.t_sfcontrid, 10, '0')  " +
"        RETURNING COUNT (1)  " +
"             INTO cnt;  " +
"  " +
"      DBMS_OUTPUT.put_line ('    Удалено dsfssi_dbt: ' || cnt);  " +
"  " +
"      INSERT INTO DELDBO_dobjatcor_dbt SELECT dlid, sysdate, RsbSessionData.Oper, t.* FROM dobjatcor_dbt t  " +
"            WHERE t_objecttype = 659 AND t_object = LPAD (i.t_sfcontrid, 10, '0');  " +
"  " +
"      DELETE FROM dobjatcor_dbt  " +
"            WHERE t_objecttype = 659 AND t_object = LPAD (i.t_sfcontrid, 10, '0')  " +
"        RETURNING COUNT (1)  " +
"             INTO cnt;  " +
"  " +
"      DBMS_OUTPUT.put_line ('    Удалено dobjatcor_dbt: ' || cnt);  " +
"  " +
"      INSERT INTO DELDBO_dnotetext_dbt SELECT dlid, sysdate, RsbSessionData.Oper, t.* FROM dnotetext_dbt t  " +
"            WHERE t_objecttype = 659 AND t_documentid = LPAD (i.t_sfcontrid, 10, '0');  " +
"  " +
"      DELETE FROM dnotetext_dbt  " +
"            WHERE t_objecttype = 659 AND t_documentid = LPAD (i.t_sfcontrid, 10, '0')  " +
"        RETURNING COUNT (1)  " +
"             INTO cnt;  " +
"  " +
"      DBMS_OUTPUT.put_line ('    Удалено dnotetext_dbt: ' || cnt);  " +
"  " +
"      INSERT INTO DELDBO_dsfcontr_dbt SELECT dlid, sysdate, RsbSessionData.Oper, t.* FROM dsfcontr_dbt t  " +
"            WHERE t_id = i.t_sfcontrid;  " +
"  " +
"      DELETE FROM dsfcontr_dbt  " +
"            WHERE t_id = i.t_sfcontrid;  " +
"  " +
"      DBMS_OUTPUT.  " +
"       put_line ('    Удален dsfcontr_dbt : ' || i.t_sfcontrid);  " +
"   END LOOP;  " +
"  " +
"   FOR img IN (SELECT *  " +
"                 FROM dimgdata_dbt  " +
"                WHERE t_objecttype = 207  " +
"                      AND t_objectid IN (SELECT LPAD (dlid, 34, '0')  " +
"                                           FROM ddlcontrmsg_dbt  " +
"                                          WHERE t_dlcontrid = dlid))  " +
"   LOOP  " +
"  " +
"      INSERT INTO DELDBO_DIMGDATA_DBT SELECT dlid, sysdate, RsbSessionData.Oper, t.* FROM DIMGDATA_DBT t  " +
"            WHERE t_imageid = img.t_imageid;  " +
"  " +
"      DELETE FROM DIMGDATA_DBT  " +
"            WHERE t_imageid = img.t_imageid  " +
"        RETURNING COUNT (1)  " +
"             INTO cnt;  " +
"  " +
"      DBMS_OUTPUT.put_line ('    Удалено dimgdata_dbt : ' || cnt);  " +
"  " +
"      INSERT INTO DELDBO_dimage_dbt SELECT dlid, sysdate, RsbSessionData.Oper, t.* FROM dimage_dbt  t  " +
"            WHERE t_imageid = img.t_imageid;  " +
"  " +
"      DELETE FROM dimage_dbt  " +
"            WHERE t_imageid = img.t_imageid  " +
"        RETURNING COUNT (1)  " +
"             INTO cnt;  " +
"  " +
"      DBMS_OUTPUT.put_line ('    Удалено dimage_dbt : ' || cnt);  " +
"  " +
"      INSERT INTO DELDBO_ddlcontrmsg_dbt SELECT dlid, sysdate, RsbSessionData.Oper,  " +
"      T_ID, T_DLCONTRID, T_KIND,  " +
"      T_CREATEDATE, T_CREATETIME, T_SENDDATE,  " +
"      T_SENDTIME, T_XML,  " +
"      T_ISONLINESENDMES,  " +
"      T_SENDMESSTATE   ,  " +
"      T_RESPDATA       ,  " +
"      T_RESPDATE       ,  " +
"      T_RESPTIME, T_VERSION   " +
"       FROM ddlcontrmsg_dbt  t  " +
"            WHERE t_dlcontrid = dlid AND t_id = img.t_objectid;  " +
"  " +
"      DELETE FROM ddlcontrmsg_dbt  " +
"            WHERE t_dlcontrid = dlid AND t_id = img.t_objectid  " +
"        RETURNING COUNT (1)  " +
"             INTO cnt;  " +
"  " +
"      DBMS_OUTPUT.put_line ('    Удалено ddlcontrmsgr_dbt : ' || cnt);  " +
"   END LOOP;  " +
"  " +
"   FOR img2  " +
"      IN (SELECT *  " +
"            FROM dimgdata_dbt  " +
"           WHERE t_objecttype = 208 AND t_objectid = LPAD (dlid, 34, '0'))  " +
"   LOOP  " +
"      INSERT INTO DELDBO_DIMGDATA_DBT SELECT dlid, sysdate, RsbSessionData.Oper, t.* FROM DIMGDATA_DBT t  " +
"            WHERE t_imageid = img2.t_imageid;  " +
"  " +
"      DELETE FROM DIMGDATA_DBT  " +
"            WHERE t_imageid = img2.t_imageid  " +
"        RETURNING COUNT (1)  " +
"             INTO cnt;  " +
"  " +
"      DBMS_OUTPUT.put_line ('    Удалено dimgdata_dbt : ' || cnt);  " +
"  " +
"      INSERT INTO DELDBO_dimage_dbt SELECT dlid, sysdate, RsbSessionData.Oper, t.* FROM dimage_dbt  t  " +
"            WHERE t_imageid = img2.t_imageid;  " +
"  " +
"      DELETE FROM dimage_dbt  " +
"            WHERE t_imageid = img2.t_imageid  " +
"        RETURNING COUNT (1)  " +
"             INTO cnt;  " +
"  " +
"      DBMS_OUTPUT.put_line ('    Удалено dimage_dbt : ' || cnt);  " +
"   END LOOP;  " +
"  " +
"   INSERT INTO DELDBO_dobjcode_dbt SELECT dlid, sysdate, RsbSessionData.Oper, t.* FROM dobjcode_dbt  t  " +
"         WHERE     t_objecttype = 3  " +
"               AND t_codekind = 8  " +
"               AND t_objectid = ptid  " +
"               AND t_code IN (SELECT t_mpcode  " +
"                                FROM ddlcontrmp_dbt  " +
"                               WHERE t_dlcontrid = dlid);  " +
"  " +
"   DELETE FROM dobjcode_dbt  " +
"         WHERE     t_objecttype = 3  " +
"               AND t_codekind = 8  " +
"               AND t_objectid = ptid  " +
"               AND t_code IN (SELECT t_mpcode  " +
"                                FROM ddlcontrmp_dbt  " +
"                               WHERE t_dlcontrid = dlid)  " +
"     RETURNING COUNT (1)  " +
"          INTO cnt;  " +
"   INSERT INTO DELDBO_dobjcode_dbt SELECT dlid, sysdate, RsbSessionData.Oper, t.* FROM dobjcode_dbt  t " +
"         WHERE     t_objecttype = 207 " +
"               AND t_codekind = 1 " +
"               AND t_objectid = ptid " +
"               AND t_code IN (SELECT t_mpcode " +
"                                FROM ddlcontrmp_dbt " +
"                               WHERE t_dlcontrid = dlid); " +
" " +
"   DELETE FROM dobjcode_dbt " +
"         WHERE     t_objecttype = 207 " +
"               AND t_codekind = 1 " +
"               AND t_objectid = ptid " +
"               AND t_code IN (SELECT t_mpcode " +
"                                FROM ddlcontrmp_dbt " +
"                               WHERE t_dlcontrid = dlid) " +
"     RETURNING COUNT (1) " +
"          INTO cnt; " +
"  " +
"   DBMS_OUTPUT.put_line ('    Удалено dobjcode_dbt : ' || cnt);  " +
"  " +
"   INSERT INTO DELDBO_DDLCONTRMP_DBT SELECT dlid, sysdate, RsbSessionData.Oper, " +
"   T_ID, T_DLCONTRID, T_SFCONTRID,  " +
"   T_ROLE, T_MPCODE, T_MPREGDATE,  " +
"   T_MPCLOSEDATE, T_VERSION, T_AUTOOPENACC, T_FIRMID " +
"   FROM DDLCONTRMP_DBT  t  " +
"         WHERE t_dlcontrid = dlid;  " +
"  " +
"   DELETE FROM DDLCONTRMP_DBT  " +
"         WHERE t_dlcontrid = dlid  " +
"     RETURNING COUNT (1)  " +
"          INTO cnt;  " +
"  " +
"   DBMS_OUTPUT.put_line ('    Удалено ddlcontrmp_dbt : ' || cnt);  " +
"  " +
"   INSERT INTO DELDBO_dsfcontr_dbt SELECT dlid, sysdate, RsbSessionData.Oper, t.* FROM dsfcontr_dbt  t  " +
"         WHERE t_id = sfid;  " +
"  " +
"   DELETE FROM dsfcontr_dbt  " +
"         WHERE t_id = sfid  " +
"     RETURNING COUNT (1)  " +
"          INTO cnt;  " +
"  " +
"   DBMS_OUTPUT.put_line ('    Удалено dsfcontr_dbt : ' || cnt);  " +
"  " +
"   INSERT INTO DELDBO_dnotetext_dbt SELECT dlid, sysdate, RsbSessionData.Oper, t.* FROM dnotetext_dbt t  " +
"         WHERE t_objecttype = 659 AND t_documentid = LPAD (sfid, 10, '0');  " +
"  " +
"   DELETE FROM dnotetext_dbt  " +
"         WHERE t_objecttype = 659 AND t_documentid = LPAD (sfid, 10, '0')  " +
"     RETURNING COUNT (1)  " +
"          INTO cnt;  " +
"  " +
"   DBMS_OUTPUT.put_line ('    Удалено dnotetext_dbt: ' || cnt);  " +
"  " +
"   INSERT INTO DELDBO_dobjatcor_dbt SELECT dlid, sysdate, RsbSessionData.Oper, t.* FROM dobjatcor_dbt t  " +
"         WHERE t_objecttype = 659 AND t_object = LPAD (sfid, 10, '0');  " +
"  " +
"   DELETE FROM dobjatcor_dbt  " +
"         WHERE t_objecttype = 659 AND t_object = LPAD (sfid, 10, '0')  " +
"     RETURNING COUNT (1)  " +
"          INTO cnt;  " +
"  " +
"   DBMS_OUTPUT.put_line ('    Удалено dobjatcor_dbt: ' || cnt);  " +
"  " +
"   INSERT INTO DELDBO_dnotetext_dbt SELECT dlid, sysdate, RsbSessionData.Oper, t.* FROM dnotetext_dbt t  " +
"         WHERE t_objecttype = 207 AND t_documentid = LPAD (dlid, 34, '0');  " +
"  " +
"   DELETE FROM dnotetext_dbt  " +
"         WHERE t_objecttype = 207 AND t_documentid = LPAD (dlid, 34, '0')  " +
"     RETURNING COUNT (1)  " +
"          INTO cnt;  " +
"  " +
"   DBMS_OUTPUT.put_line ('    Удалено dnotetext_dbt: ' || cnt);  " +
"  " +
"   INSERT INTO DELDBO_dobjatcor_dbt SELECT dlid, sysdate, RsbSessionData.Oper, t.* FROM dobjatcor_dbt t  " +
"         WHERE t_objecttype = 207 AND t_object = LPAD (dlid, 34, '0');  " +
"  " +
"   DELETE FROM dobjatcor_dbt  " +
"         WHERE t_objecttype = 207 AND t_object = LPAD (dlid, 34, '0')  " +
"     RETURNING COUNT (1)  " +
"          INTO cnt;  " +
"  " +
"   DBMS_OUTPUT.put_line ('    Удалено dobjatcor_dbt: ' || cnt); commit;  " +
"   INSERT INTO DELDBO_ddlcontr_dbt SELECT dlid, sysdate, RsbSessionData.Oper, " + 
"           t.T_DLCONTRID         ,  " +
"           t.T_SFCONTRID         ,  "
"           t.T_IIS               ,  "
"           t.T_UNIDEPOCONTRID    ,  " +
"           t.T_INEXTDEPO         ,  "
"           t.T_USESUBACC         ,  "
"           t.T_IISFIRSTDATE      ,  " +
"           t.T_IISFIRSTBROKERNAME,  "
"           t.T_IISFIRSTNUMBER    ,  "
"           t.T_IISTRANSFER       ,  " +
"           t.T_IISLASTBROKERNAME ,  "
"           t.T_IISLASTNUMBER     ,  "
"           t.T_IISLASTOPENDATE   ,  " +
"           t.T_IISLASTCLOSEDATE  ,  "
"           t.T_IISLASTYEAR       ,  "
"           t.T_IISLASTINSUM      ,  " +
"           t.T_ISSLASTOUTSUM     ,  "
"           t.T_IISCLOSEBYTRANSF  ,  "
"           t.T_IISBENEFITDEP     ,  " +
"           t.T_IISENROLBAN       ,  "
"           t.T_REPMETHOD         ,  "
"           t.T_EMAIL             ,  " +
"           t.T_REPOOVERNIGHT     ,  "
"           t.T_LEVERAGE          ,  "
"           t.T_NOTPAYBRKACC      ,  " +
"           t.T_RETURNTAX         ,  "
"           t.T_USEQUIK           ,  "
"           t.T_IISDEDFINRES      ,  " +
"           t.T_LEVERAGECUR       ,  "
"           t.T_ISUNDERWRITING       "
"                                    "
" FROM ddlcontr_dbt t  " +           
"         WHERE t_dlcontrid = dlid;  " +
"  " +
"   DELETE FROM ddlcontr_dbt  " +
"         WHERE t_dlcontrid = dlid  " +
"     RETURNING COUNT (1)  " +
"          INTO cnt;  " +
"  " +
"   DBMS_OUTPUT.put_line ('    Удалено ddlcontr_dbt: ' || cnt); commit;  " +
"  " +
"END;  " ;

var cmd = RsdCommand(sql);
    cmd.addparam("",     rsdbp_in, dlid);
//    cmd.addparam("retval",     rsdbp_out,v_double);
    cmd.execute();

//return cmd.value("retval");
err = "";
return true;
OnError(er);
   err = "sql err";
   return false;

end;


private macro delContrSf_sql(sfid, err:@string)
var sql;

sql = 
"DECLARE " +
"   dlid   NUMBER (10) := -1; " +
"   sfid   NUMBER (10) := 28401; " +
"   ptid   NUMBER (10); " +
"   cnt    NUMBER (10); " +
"BEGIN " +
"   FOR ac " +
"      IN (SELECT t_account, t_chapter " +
"            FROM dsettacc_dbt " +
"           WHERE t_settaccid IN " +
"                    (SELECT t_setaccid " +
"                       FROM dsfssi_dbt " +
"                      WHERE t_objecttype = 659 AND t_objectid = LPAD (sfid, 10, '0')) " +
"          UNION ALL " +
"          SELECT t_account, t_chapter " +
"            FROM dmcaccdoc_dbt " +
"           WHERE t_clientcontrid = sfid) " +
"   LOOP " +
"      INSERT INTO DELDBO_DACCBALANCE_DBT " +
"         SELECT dlid, " +
"                SYSDATE, " +
"                RsbSessionData.Oper, " +
"                t.* " +
"           FROM DACCBALANCE_DBT t " +
"          WHERE t_accountid = " +
"                   (SELECT t_accountid " +
"                      FROM daccount_dbt " +
"                     WHERE t_account = ac.t_account " +
"                           AND t_chapter = ac.t_chapter); " +
" " +
"      DELETE FROM DACCBALANCE_DBT " +
"            WHERE t_accountid = " +
"                     (SELECT t_accountid " +
"                        FROM daccount_dbt " +
"                       WHERE t_account = ac.t_account " +
"                             AND t_chapter = ac.t_chapter) " +
"        RETURNING COUNT (1) " +
"             INTO cnt; " +
" " +
"      DBMS_OUTPUT.put_line ('    Удалено DACCBALANCE_DBT: ' || cnt); " +
" " +
"      INSERT INTO DELDBO_DACCBLNC_DBT " +
"         SELECT dlid, " +
"                SYSDATE, " +
"                RsbSessionData.Oper, " +
"                t.* " +
"           FROM DACCBLNC_DBT t " +
"          WHERE t_accountid = " +
"                   (SELECT t_accountid " +
"                      FROM daccount_dbt " +
"                     WHERE t_account = ac.t_account " +
"                           AND t_chapter = ac.t_chapter); " +
" " +
" " +
"      DELETE FROM DACCBLNC_DBT " +
"            WHERE t_accountid = " +
"                     (SELECT t_accountid " +
"                        FROM daccount_dbt " +
"                       WHERE t_account = ac.t_account " +
"                             AND t_chapter = ac.t_chapter) " +
"        RETURNING COUNT (1) " +
"             INTO cnt; " +
" " +
"      DBMS_OUTPUT.put_line ('    Удалено DACCBLNC_DBT: ' || cnt); " +
" " +
"      BEGIN " +
"         INSERT INTO DELDBO_DRESTDATE_DBT " +
"            SELECT dlid, " +
"                   SYSDATE, " +
"                   RsbSessionData.Oper, " +
"                   t.* " +
"              FROM drestdate_dbt t " +
"             WHERE t_accountid = " +
"                      (SELECT t_accountid " +
"                         FROM daccount_dbt " +
"                        WHERE t_account = ac.t_account " +
"                              AND t_chapter = ac.t_chapter); " +
" " +
"         DELETE FROM drestdate_dbt t " +
"               WHERE t_accountid = " +
"                        (SELECT t_accountid " +
"                           FROM daccount_dbt " +
"                          WHERE t_account = ac.t_account " +
"                                AND t_chapter = ac.t_chapter) " +
"           RETURNING COUNT (1) " +
"                INTO cnt; " +
"      EXCEPTION " +
"         WHEN OTHERS " +
"         THEN " +
"            DBMS_OUTPUT. " +
"             put_line ( " +
"               '    Удалить вручную daccount_dbt: ' " +
"               || ac.t_account); " +
"      END; " +
" " +
"      IF cnt = -1 " +
"      THEN " +
"         DBMS_OUTPUT.put_line ('    НЕ Удалено drestdate_dbt'); " +
"      ELSE " +
"         DBMS_OUTPUT.put_line ('    Удалено drestdate_dbt: ' || cnt); " +
"      END IF; " +
" " +
"      INSERT INTO DELDBO_DACCOUNT_DBT " +
"         SELECT dlid, " +
"                SYSDATE, " +
"                RsbSessionData.Oper, " +
"                t.* " +
"           FROM daccount_dbt t " +
"          WHERE t_account = ac.t_account AND t_chapter = ac.t_chapter; " +
" " +
"      DELETE FROM daccount_dbt " +
"            WHERE t_account = ac.t_account AND t_chapter = ac.t_chapter " +
"        RETURNING COUNT (1) " +
"             INTO cnt; " +
" " +
"      IF cnt = -1 " +
"      THEN " +
"         DBMS_OUTPUT.put_line ('    НЕ Удалено daccount_dbt'); " +
"      ELSE " +
"         DBMS_OUTPUT.put_line ('    Удалено daccount_dbt: ' || cnt); " +
"      END IF; " +
" " +
"      INSERT INTO DELDBO_DMCACCDOC_DBT " +
"         SELECT dlid, " +
"                SYSDATE, " +
"                RsbSessionData.Oper, " +
"                t.* " +
"           FROM dmcaccdoc_dbt t " +
"          WHERE t_account = ac.t_account AND t_chapter = ac.t_chapter; " +
" " +
"      DELETE FROM dmcaccdoc_dbt " +
"            WHERE t_account = ac.t_account AND t_chapter = ac.t_chapter " +
"        RETURNING COUNT (1) " +
"             INTO cnt; " +
" " +
"      DBMS_OUTPUT.put_line ('    Удалено dmcaccdoc_dbt: ' || cnt); " +
"   END LOOP; " +
" " +
" " +
" " +
"   INSERT INTO DELDBO_dsettacc_dbt " +
"      SELECT dlid, " +
"             SYSDATE, " +
"             RsbSessionData.Oper, " +
"             t.* " +
"        FROM dsettacc_dbt t " +
"       WHERE t_settaccid IN " +
"                (SELECT t_setaccid " +
"                   FROM dsfssi_dbt " +
"                  WHERE t_objecttype = 659 AND t_objectid = LPAD (sfid, 10, '0')); " +
" " +
"   DELETE FROM dsettacc_dbt " +
"         WHERE t_settaccid IN " +
"                  (SELECT t_setaccid " +
"                     FROM dsfssi_dbt " +
"                    WHERE t_objecttype = 659 AND t_objectid = LPAD (sfid, 10, '0')) " +
"     RETURNING COUNT (1) " +
"          INTO cnt; " +
" " +
"   DBMS_OUTPUT.put_line ('    Удалено dsettacc_dbt: ' || cnt); " +
" " +
"   INSERT INTO DELDBO_dsfssi_dbt " +
"      SELECT dlid, " +
"             SYSDATE, " +
"             RsbSessionData.Oper, " +
"             t.* " +
"        FROM dsfssi_dbt t " +
"       WHERE t_objecttype = 659 AND t_objectid = LPAD (sfid, 10, '0'); " +
" " +
"   DELETE FROM dsfssi_dbt " +
"         WHERE t_objecttype = 659 AND t_objectid = LPAD (sfid, 10, '0') " +
"     RETURNING COUNT (1) " +
"          INTO cnt; " +
" " +
"   DBMS_OUTPUT.put_line ('    Удалено dsfssi_dbt: ' || cnt); " +
" " +
"   INSERT INTO DELDBO_dobjatcor_dbt " +
"      SELECT dlid, " +
"             SYSDATE, " +
"             RsbSessionData.Oper, " +
"             t.* " +
"        FROM dobjatcor_dbt t " +
"       WHERE t_objecttype = 659 AND t_object = LPAD (sfid, 10, '0'); " +
" " +
"   DELETE FROM dobjatcor_dbt " +
"         WHERE t_objecttype = 659 AND t_object = LPAD (sfid, 10, '0') " +
"     RETURNING COUNT (1) " +
"          INTO cnt; " +
" " +
"   DBMS_OUTPUT.put_line ('    Удалено dobjatcor_dbt: ' || cnt); " +
" " +
"   INSERT INTO DELDBO_dnotetext_dbt " +
"      SELECT dlid, " +
"             SYSDATE, " +
"             RsbSessionData.Oper, " +
"             t.* " +
"        FROM dnotetext_dbt t " +
"       WHERE t_objecttype = 659 AND t_documentid = LPAD (sfid, 10, '0'); " +
" " +
"   DELETE FROM dnotetext_dbt " +
"         WHERE t_objecttype = 659 AND t_documentid = LPAD (sfid, 10, '0') " +
"     RETURNING COUNT (1) " +
"          INTO cnt; " +
" " +
"   DBMS_OUTPUT.put_line ('    Удалено dnotetext_dbt: ' || cnt); " +
" " +
"   INSERT INTO DELDBO_dsfcontr_dbt " +
"      SELECT dlid, " +
"             SYSDATE, " +
"             RsbSessionData.Oper, " +
"             t.* " +
"        FROM dsfcontr_dbt t " +
"       WHERE t_id = sfid; " +
" " +
"   DELETE FROM dsfcontr_dbt " +
"         WHERE t_id = sfid; " +
" " +
"   DBMS_OUTPUT.put_line ('    Удален dsfcontr_dbt : ' || sfid); " +
"END; " ;

var cmd = RsdCommand(sql);
    cmd.addparam("",     rsdbp_in, sfid);
//    cmd.addparam("retval",     rsdbp_out,v_double);
    cmd.execute();

//return cmd.value("retval");
err = "";
return true;
OnError(er);
   err = "sql err";
   return false;

end;


macro DeleteDBO(dlid, err:@string)
   CreateTables();
   return delContr_sql(dlid, @err);

end;

macro DeleteSubContr(sfid, err:@string)
   CreateTables();
   return delContrSF_sql(sfid, @err);

end;






