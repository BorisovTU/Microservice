// DEF-34128  АЗ Компенсация клиентам в связи с пересчетом комиссии брокера
// Дылгеров Ц.

import "def34128rollback.mac";  //откатить проводки по компенсации
import "def34128rollbackLost.mac";  //откатить проводки по комиссиям
import RSD, or_rep_h;

macro def34128printReport()
  var StrHeader:string =
  "┌────────────────────────┬───────────────┬─────────────┬──────────────────────────┬───────────────────────┬──────────────────┬──────────────────┬──────────────────┬──────────────────┬────────────────────┬────────────────┬───────────────────┬───────────────────┬───────────────────┐\n"+
  "│ ФИО клиента            │ № ДБО         │  ЕКК        │Счет 3060х                │Номер сделки           │ Дата сделки      │Сумма уд.бр.комисс│Сум.уд.бр.ком.нацв│Сум.перес.брок.ком│Сум.перес.бр.к.нацв │Сумма переплаты │ Расходы компенсац.│  НДФЛ компенсац.  │ Выплата компенсац.│\n"+
  "├────────────────────────┼───────────────┼─────────────┼──────────────────────────┼───────────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼────────────────────┼────────────────┼───────────────────┼───────────────────┼───────────────────┤";
  var Report = CMakeReport(StrHeader); 
  var rn = 1;

  private macro ДобавитьПустуюСтроку()
    Report.AddEmptyStr();
    rn = rn + 1;
  end; 

  Report.SetDefaultFontName("Times New Roman");
  Report.SetDefaultFontSize(10);
  Report.SetFlagShowGrid(true);

  var query = 
"select t.*, (t.t_old_comis_nc - t.t_comis1_nc) t_compens1                             "+
"  from (SELECT                                                                        "+
"               n.t_plusg_4800,                                                        "+
"               n.t_paidcomp,                                                          "+
"               n.t_paidcomp_15,                                                       "+
"               (n.t_plusg_4800 - n.t_paidcomp - n.t_paidcomp_15) comp_paid,           "+
"               p.t_name,                                                              "+
"               s.t_number,                                                            "+
"               dlo.t_code,                                                            "+
"               n.t_account3060,                                                       "+
"               k1.T_DEALID,                                                           "+
"               trunc(k1.T_DEALSTART) T_DEALSTART,                                     "+
"               k1.T_OLD_COMIS,                                                        "+
"               k1.T_OLD_COMIS_NC,                                                     "+
"               k1.t_comis,                                                            "+
"               k1.t_comis_nc,                                                         "+
"               to_number(k1.t_error) * (case                                          "+
"                                          when k1.t_dockind = 101 then                "+
"                                           dleg.t_cost                                "+
"                                          when k1.t_dockind = 4813 then               "+
"                                           fi.t_cost                                  "+
"                                          else                                        "+
"                                           0                                          "+
"                                        end) t_comis1,                                "+
"               to_number(k1.t_error) * (case                                          "+
"                                          when k1.t_dockind = 101 then                "+
"                                           RSB_FIInstr.ConvSum(dleg.t_cost,           "+
"                                                               dleg.t_cfi,            "+
"                                                               0,                     "+
"                                                               k1.t_dealstart)        "+
"                                          when k1.t_dockind = 4813 then               "+
"                                           RSB_FIInstr.ConvSum(fi.t_cost,             "+
"                                                               fi.t_pricefiid,        "+
"                                                               0,                     "+
"                                                               k1.t_dealstart)        "+
"                                          else                                        "+
"                                           0                                          "+
"                                        end) t_comis1_nc,                             "+
"               (case                                                                  "+
"                 when k1.t_dockind = 101 then                                         "+
"                  dleg.t_cost                                                         "+
"                 when k1.t_dockind = 4813 then                                        "+
"                  fi.t_cost                                                           "+
"                 else                                                                 "+
"                  0                                                                   "+
"               end) t_cost,                                                           "+
"               to_number(k1.t_error) t_comiss_koeff,                                  "+
"               k1.t_compens                                                           "+
"          from dnptxdefferedobj_dbt  n,                                               "+
"               dparty_dbt            p,                                               "+
"               dsfcontr_dbt          s,                                               "+
"               dsfcontr_dbt          sfc_s,                                           "+
"               ddlobjcode_dbt        dlo,                                             "+
"               ddlcontr_dbt          dlc,                                             "+
"               ddlcontrmp_dbt        mp,                                              "+
"               dl_tmp_leg_comiss_dbt k1                                               "+
"          left join ddl_leg_dbt dleg                                                  "+
"         on dleg.t_dealid = k1.t_dealid and k1.t_dockind = 101 and dleg.t_legkind = 0 "+
"          left join ddvndeal_dbt dvn                                                  "+
"            on dvn.t_id = k1.t_dealid and k1.t_dockind = 4813                         "+
"          left join ddvnfi_dbt fi                                                     "+
"            on FI.T_DEALID = DVN.T_ID                                                 "+
"         where n.t_partyid = p.t_partyid                                              "+
"           and s.t_id = n.t_contractid                                                "+
"           and dlo.t_objectid = dlc.t_dlcontrid                                       "+
"           and n.t_contractid = s.t_id                                                "+
"           and dlo.t_codekind = 1                                                     "+
"           and dlo.t_objecttype = 207                                                 "+
"           and dlc.t_sfcontrid = s.t_id                                               "+
"           and mp.t_dlcontrid = dlc.t_dlcontrid                                       "+
"           and ((mp.t_marketid = 2 and sfc_s.t_servkind in (1, 21)) or                "+
"               (mp.t_marketid = 151337 and sfc_s.t_servkind = 1))                     "+
"           and sfc_s.t_id = mp.t_sfcontrid                                            "+
"           and k1.t_sfsubcontractid = sfc_s.t_id) t                                   "+
" order by t_number, t_dealstart                                                       ";

  var cmd = RSDCommand(query);
  var rs = RsdRecordSet(cmd);
  while (rs.movenext)
      ДобавитьПустуюСтроку();
      Report.AddPrintCell(rs.value("t_name"));
      Report.AddPrintCell(rs.value("t_number"));
      Report.AddPrintCell(rs.value("t_code"));
      Report.AddPrintCell(rs.value("t_account3060"));
      Report.AddPrintCell(rs.value("t_dealid"));
      Report.AddPrintCell(date(rs.value("t_dealstart")));
      Report.AddPrintCell(rs.value("t_old_comis"));
      Report.AddPrintCell(rs.value("t_old_comis_nc"));
      Report.AddPrintCell(rs.value("t_comis1"));
      Report.AddPrintCell(rs.value("t_comis1_nc"));
      Report.AddPrintCell(rs.value("t_compens1"));
      Report.AddPrintCell(rs.value("t_plusg_4800"));
      Report.AddPrintCell(rs.value("t_paidcomp")+rs.value("t_paidcomp_15"));
      Report.AddPrintCell(rs.value("t_plusg_4800")-rs.value("t_paidcomp")-rs.value("t_paidcomp_15"));
    end;
  Report.PrintWinRep("Компенсация и налоги");
  Report.SetWinRepOutput();
  Report.ShowWinRep();

end;

macro def34128storedProcedureRun()
	var query = "begin usr_def34128.run; end;";
	var cmd = RSDCommand(query);
	cmd.execute;
end;

macro scrollSomeTable (sql)
  RunScroll(RSDRecordSet(RSDCommand(sql), RSDVAL_CLIENT, RSDVAl_STATIC));
end;

macro SelectMenu ()
  array Pmenu;
  Pmenu(0) = " Отказ ";
  Pmenu(1) = " 3.Записать данные договоров из Excel в таблицу d_tmp_compens_def34128_dbt ";
  Pmenu(2) = " Просмотр d_tmp_compens_def34128_dbt ";
  Pmenu(3) = " 4.Подсчет компенсации и сохранение в dcompcomiss_tmp и dl_tmp_leg_comiss_dbt";
  Pmenu(4) = " Просмотр dcompcomiss_tmp ";
  Pmenu(5) = " Просмотр dl_tmp_leg_comiss_dbt ";
  Pmenu(6) = " 5.Оплата компенсации на основании dcompcomiss_tmp и запись в dnptxdefferedobj_dbt ";
  Pmenu(7) = " Просмотр dnptxdefferedobj_dbt ";
  Pmenu(8) = " Формирование отчета по пересчету брок. комиссии в Excel на основании dnptxdefferedobj_dbt ";
  Pmenu(9) = " Откат проводок оплаты компенсации на основании dnptxdefferedobj_dbt ";
  Pmenu(10) = "1.Расчет lost-комиссий ";
  Pmenu(11) = "Просмотр lost-комиссий ";
  Pmenu(12) = "2.Начисление и оплата lost-комиссий ";
  Pmenu(13) = "Просмотр лог-файла последней оплаты lost-комиссий (файл def34128 в каталоге TXTFILES)";
  Pmenu(14) = "Откат проводок последней оплаты lost-комиссий ";
  var Prompt   = " Запустите процедуру или откажитесь... Процедуры пронумерованы в логическом порядке"; 
  return Menu (Pmenu,Prompt,"Выберите режим работы");
end;

macro mainmenu()
  file view () txt;
  var   NumSel = 0; // Выбрано в меню:
  NumSel = SelectMenu ();
  if (NumSel != 0)
	if (NumSel == 1)
		ExecMacroFile("def34128readExcel","def34128readExcelRun");
	elif (NumSel == 2)
		scrollSomeTable("select * from d_tmp_compens_def34128_dbt ");
	elif (NumSel == 3)
                if (getTrue(false, "Запустить пересчет компенсаций во временные таблицы? Старые данные в таблицах dcompcomiss_tmp и dl_tmp_leg_comiss_dbt  будут удалены"))
  		  def34128storedProcedureRun;  
                end;
	elif (NumSel == 4)
		scrollSomeTable("select * from dcompcomiss_tmp ");
	elif (NumSel == 5)
		scrollSomeTable( 
"select t.*,                                                                                                  "+
"       (t.starya_komissia_nacvaluta - t.novaya_komissia_nacvaluta) kompensatsya                              "+
"  from (select k1.t_sfsubcontractid id_subkontracta,                                                         "+
"               k1.t_dealid id_sdelki,                                                                        "+
"               k1.t_dealstart data_sdelki,                                                                   "+
"               k1.t_old_comis staraya_komissia,                                                              "+
"               k1.t_old_comis_nc starya_komissia_nacvaluta,                                                  "+
"               k1.t_error procent_komissii_po_dnuy,                                                          "+
"               k1.t_dockind tip_101_BOTSB_ili_48133_FISSIKO,                                                 "+
"               dsf.t_partyid kod_klienta,                                                                    "+
"               dsf.t_number nomer_subdogovora,                                                               "+
"               to_number(k1.t_error) * (case                                                                 "+
"                                          when k1.t_dockind = 101 then                                       "+
"                                           dleg.t_cost                                                       "+
"                                          when k1.t_dockind = 4813 then                                      "+
"                                           fi.t_cost                                                         "+
"                                          else                                                               "+
"                                           0                                                                 "+
"                                        end) novaya_komissia,                                                "+
"               to_number(k1.t_error) * (case                                                                 "+
"                                          when k1.t_dockind = 101 then                                       "+
"                                           RSB_FIInstr.ConvSum(dleg.t_cost,                                  "+
"                                                               dleg.t_cfi,                                   "+
"                                                               0,                                            "+
"                                                               k1.t_dealstart)                               "+
"                                          when k1.t_dockind = 4813 then                                      "+
"                                           RSB_FIInstr.ConvSum(fi.t_cost,                                    "+
"                                                               fi.t_pricefiid,                               "+
"                                                               0,                                            "+
"                                                               k1.t_dealstart)                               "+
"                                          else                                                               "+
"                                           0                                                                 "+
"                                        end) novaya_komissia_nacvaluta,                                      "+
"               (case                                                                                         "+
"                 when k1.t_dockind = 101 then                                                                "+
"                  dleg.t_cost                                                                                "+
"                 when k1.t_dockind = 4813 then                                                               "+
"                  fi.t_cost                                                                                  "+
"                 else                                                                                        "+
"                  0                                                                                          "+
"               end) stoimost_sdelki,                                                                         "+
"               to_number(k1.t_error) * (case                                                                 "+
"                                          when k1.t_dockind = 101 then                                       "+
"                                           RSB_FIInstr.ConvSum(dleg.t_cost,                                  "+
"                                                               dleg.t_cfi,                                   "+
"                                                               0,                                            "+
"                                                               k1.t_dealstart)                               "+
"                                          when k1.t_dockind = 4813 then                                      "+
"                                           RSB_FIInstr.ConvSum(fi.t_cost,                                    "+
"                                                               fi.t_pricefiid,                               "+
"                                                               0,                                            "+
"                                                               k1.t_dealstart)                               "+
"                                          else                                                               "+
"                                           0                                                                 "+
"                                        end) stoimost_sdelki_nacvaluta                                       "+
"          from dl_tmp_leg_comiss_dbt k1                                                                      "+
"          left join dsfcontr_dbt dsf                                                                         "+
"            on k1.t_sfsubcontractid = dsf.t_id                                                               "+
"          left join ddl_leg_dbt dleg                                                                         "+
"            on dleg.t_dealid = k1.t_dealid                                                                   "+
"           and k1.t_dockind = 101                                                                            "+
"           and dleg.t_legkind = 0                                                                            "+
"          left join ddvndeal_dbt dvn                                                                         "+
"            on dvn.t_id = k1.t_dealid                                                                        "+
"           and k1.t_dockind = 4813                                                                           "+
"          left join ddvnfi_dbt fi                                                                            "+
"            on FI.T_DEALID = DVN.T_ID) t                                                                     ");
	elif (NumSel == 6)
                if (getTrue(false, "Запустить оплату компенсаций? (на основании dcompcomiss_tmp). Будет очищена DNPTXDEFFEREDOBJ_DBT, т.е. будет невозможно откатить проводки предыдущего запуска"))
		  ExecMacroFile("def34128trn","def34128trnRun");
                end;  
	elif (NumSel == 7)
		scrollSomeTable("select df.*, dsf.t_number from DNPTXDEFFEREDOBJ_DBT df, dsfcontr_dbt dsf where dsf.t_id = df.t_contractid ");
	elif (NumSel == 8)
		def34128printReport;
	elif (NumSel == 9)
                if (getTrue(false, "Запустить откат проводок компенсации на основании dcompcomiss_tmp?"))
		  def34128RollbackRun;
                end;
	elif (NumSel == 10)
                if (getTrue(false, "Запустить расчет lost-комиссий c 1 октября 22г по ФИССИКО?"))
		  ExecMacroFile("def34128LostComis","def34128LostComisRun");
                end; 
	elif (NumSel == 11)
          var query12 = 
             "SELECT lo.*, dp.t_notresident, sfc_s.t_number, dlc.t_iis  " +
             "from  DDLCOMIS_LOST_34128_DBT lo, dparty_dbt dp, dsfcontr_dbt sfc_s, ddlcontr_dbt dlc, ddlcontrmp_dbt mp   " +
             "where lo.t_dealid<>0 and dp.t_partyid=lo.t_payerid and sfc_s.t_id = lo.t_contrid  " +
             "  and mp.t_dlcontrid = dlc.t_dlcontrid " +
             "  and sfc_s.t_id = mp.t_sfcontrid  ";
          scrollSomeTable(query12);
        elif (NumSel == 12)
          if (getTrue(false, "Запустить начисление и оплату lost-комиссий c 1 октября 22г по ФИССИКО?"))
            ExecMacroFile("def34128PayLostComis","def34128PayLostComisRun");
            open(view,GetTxtFileName("def34128"));
            viewfile(view);
            close(view);
          end;  
        elif (NumSel == 13)
          open(view,GetTxtFileName("def34128"));
          viewfile(view);
          close(view);
	elif (NumSel == 14)
          if (getTrue(false, "Запустить откат проводок lost-комиссий c 1 октября 22г по ФИССИКО? Откат расчета комиссий не реализован"))
            if (getTrue(false, "Будет откат всех проводок согласно значению поля DDLCOMIS_LOST_34128_DBT.t_str (Просмотр lost-комиссий). Продолжить?"))
		def34128RollbackLostRun;
            end;
          end;
  end;
  else
    println ("Вы отказались от выполнения процедуры.");
  end;
onError(er)
  MsgBox("Ошибка: " + er.Message);
  //RunError("Ошибка: " + er.Message);
end;
  
mainmenu();


