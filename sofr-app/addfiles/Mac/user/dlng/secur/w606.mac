/*
$Name:        w606.mac
$Module:      Ценные бумаги
$Description: Формирование данных для ЦКРР
$Programmer:  Кротов А.
*/

import BankInter, ReportUser, w606_panel, w606_mbk, w606_mbk_ext, w606_repo, w606_dip, w606_dnip;
// import BankInter, ReportUser, w606_panel, w606_mbk_ext, w606_repo, w606_dip, w606_dnip;


CLASS (TX_ReportUser) W606_Report(dt:date)
  var m_dt = dt;

  /*Создание отчета*/
  PRIVATE MACRO Create()

/*Точка входа*/
     var cmd;
     cmd = RSDCommand("select t_TypeFI, "
                    + "       t_TypeIssuer, "
                    + "       t_ReportDate, "
                    + "       t_BalanceDebt, "
                    + "       t_Currency, "
                    + "       t_FIID, "
                    + "       t_ISIN, "
                    + "       t_DealID, "
                    + "       t_BuyDate, "
                    + "       t_MaturityDate, "
                    + "       t_IssuerId, "
                    + "       t_ContractorId, "
                    + "       t_IssuerINN, "
                    + "       t_ContractorINN, "
                    + "       t_IssuetName, "
                    + "       t_ContractorName, "
                    + "       t_Expiration, "
                    + "       t_RatingDate, "
                    + "       t_RatingFirst, "
                    + "       t_RatingCurrent, "
                    + "       t_RatingSource, "
                    + "       t_CollateralValue, "
                    + "       t_AccountNumber, "
                    + "       t_SWIFT, "
                    + "       t_YearsToMaturity, "
                    + "       t_SPPI, "
                    + "       t_BusinessModel, "
                    + "       t_EvaluationCategory "
                    + "from DW606_U_TMP "
                    + "where t_TypeFI = ?");
    cmd.AddParam("m_mode", RSDBP_IN, m_mode);
    cmd.Execute();
    m_RS = TRsbDataSet(cmd);

/*Отключаем все индикаторы*/
    if(m_UseTemplate)
      m_ObjTemplateXLS.SetFlagShowIndicator(false);
    else
      __BUG_Global_m_ObjTemplateXLS.SetFlagShowIndicator(false);
    end;
    m_ProgressIndicator = CreateProgressIndicator(true);

/*Лист "ИзСОФР_вЦКРР"*/
    SetActiveSheet("ИзСОФР_вЦКРР");
    PrintFormatString( "", "ReportName", m_reportname);
    PrintFormatString( "", "UploadDate", m_dt);
    RegisterTable("ReportRow", "", 
           /* 1*/ "TypeFI", 
           /* 2*/ "TypeIssuer",
           /* 3*/ "ReportDate", 
           /* 4*/ "BalanceDebt",
           /* 5*/ "Currency",
           /* 6*/ "FIID",
           /* 7*/ "ISIN",              
           /* 8*/ "DealID",            
           /* 9*/ "BuyDate",
           /*10*/ "MaturityDate",
           /*11*/ "IssuerId",
           /*12*/ "ContractorId",
           /*13*/ "IssuerINN",
           /*14*/ "ContractorINN",
           /*15*/ "IssuetName",
           /*16*/ "ContractorName",
           /*17*/ "Expiration",
           /*18*/ "RatingDate",
           /*19*/ "RatingFirst",
           /*20*/ "RatingCurrent",
           /*21*/ "RatingSource",
           /*22*/ "CollateralValue",
           /*23*/ "AccountNumber",
           /*24*/ "SWIFT",
           /*25*/ "YearsToMaturity",
           /*26*/ "SPPI",
           /*27*/ "BusinessModel",
           /*28*/ "EvaluationCategory");
    while(m_RS.movenext)
      PrintTableLine(
         /* 1*/ "TypeFI", 		m_RS.value("t_TypeFI"), 		null,
         /* 2*/ "TypeIssuer", 		m_RS.value("t_TypeIssuer"), 		null,
         /* 3*/ "ReportDate", 		date(m_RS.value("t_ReportDate")),	null,
         /* 4*/ "BalanceDebt", 		m_RS.value("t_BalanceDebt"), 		2,
         /* 5*/ "Currency", 		m_RS.value("t_Currency"), 		null,
         /* 6*/ "FIID", 		m_RS.value("t_FIID"), 			null,
         /* 7*/ "ISIN", 		m_RS.value("t_ISIN"), 			null,
         /* 8*/ "DealID", 		m_RS.value("t_DealID"), 		null,
         /* 9*/ "BuyDate", 		date(m_RS.value("t_BuyDate")), 		null,
         /*10*/ "MaturityDate", 	date(m_RS.value("t_MaturityDate")),	null,
         /*11*/ "IssuerId", 		m_RS.value("t_IssuerId"), 		null,
         /*12*/ "ContractorId", 	m_RS.value("t_ContractorId"), 		null,
         /*13*/ "IssuerINN", 		m_RS.value("t_IssuerINN"), 		null,
         /*14*/ "ContractorINN", 	m_RS.value("t_ContractorINN"), 		null,
         /*15*/ "IssuetName", 		m_RS.value("t_IssuetName"), 		null,
         /*16*/ "ContractorName", 	m_RS.value("t_ContractorName"),		null,
         /*17*/ "Expiration", 		m_RS.value("t_Expiration"), 		0,
         /*18*/ "RatingDate", 		date(m_RS.value("t_RatingDate")),	null,
         /*19*/ "RatingFirst", 		m_RS.value("t_RatingFirst"), 		null,
         /*20*/ "RatingCurrent", 	m_RS.value("t_RatingCurrent"),		null,
         /*21*/ "RatingSource", 	m_RS.value("t_RatingSource"), 		null,
         /*22*/ "CollateralValue", 	m_RS.value("t_CollateralValue"),	2,
         /*23*/ "AccountNumber", 	m_RS.value("t_AccountNumber"), 		null,
         /*24*/ "SWIFT", 		m_RS.value("t_SWIFT"), 			null,
         /*25*/ "YearsToMaturity", 	m_RS.value("t_YearsToMaturity"),	12,
         /*26*/ "SPPI", 		m_RS.value("t_SPPI"), 			null,
         /*27*/ "BusinessModel", 	m_RS.value("t_BusinessModel"), 		null,
         /*28*/ "EvaluationCategory",	m_RS.value("t_EvaluationCategory"), 	null);
    end;

    EndTable();

  END;
  
  initTX_RegistrReport(null, "Report_W606.xls");

END;

/*Точка входа*/
  var panel = W606_Panel();
  var reportMBK, reportREPO, reportDIP, reportDNIP;
  var reportdate;
  var cnt;
  while(panel.run())
    reportdate = panel.GetFieldValue(P_BEGINDATE);
    /*Считаем отчеты*/
    cnt = 0;
    if(panel.GetFieldValue(P_MBK) == "X")
      cnt = cnt + 1;
    end;
    if(panel.GetFieldValue(P_REPO) == "X")
      cnt = cnt + 1;
    end;
    if(panel.GetFieldValue(P_DIP) == "X")
      cnt = cnt + 1;
    end;
    if(panel.GetFieldValue(P_DNIP) == "X")
      cnt = cnt + 1;
    end;
    /*Строим отчеты*/
    InitProgress(cnt, "Ждите...", "Формирование данных для выгрузки");
    cnt = 0;
    if(panel.GetFieldValue(P_MBK) == "X")
/*
      if(GetTrue(false, "Данные по МБК в расширенном режиме"))
         RecordSetMBK_ext(reportdate);
      else
         RecordSetMBK(reportdate);
      end;
*/
      RecordSetMBK(reportdate);

      reportMBK = W606_Report(reportdate);
      reportMBK.InitReport("Данные МБК для ЦКРР", "МБК");
      cnt = cnt + 1;
      UseProgress(cnt)
    end;
    if(panel.GetFieldValue(P_REPO) == "X")
      RecordSetREPO(reportdate);
      reportREPO = W606_Report(reportdate);
      reportREPO.InitReport("Данные по РЕПО для ЦКРР", "РЕПО");
      cnt = cnt + 1;
      UseProgress(cnt)
    end;
    if(panel.GetFieldValue(P_DIP) == "X")
      RecordSetDIP(reportdate);
      reportDIP = W606_Report(reportdate);
      reportDIP.InitReport("Сбор данных по долговым эмиссионным бумагам для ЦКРР", "Эмиссионная бумага");
      cnt = cnt + 1;
      UseProgress(cnt)
    end;
    if(panel.GetFieldValue(P_DNIP) == "X")
      RecordSetDNIP(reportdate);
      reportDNIP = W606_Report(reportdate);
      reportDNIP.InitReport("Данные по долговым неэмиссионным бумагам для ЦКРР", "Неэмиссионная бумага");
      cnt = cnt + 1;
      UseProgress(cnt)
    end;
    RemProgress();
    /*Формируем файлы*/
    if(panel.GetFieldValue(P_MBK) == "X")
      reportMBK.Run();
      reportMBK.Destructor();
    end;
    if(panel.GetFieldValue(P_REPO) == "X")
      reportREPO.Run();
      reportREPO.Destructor();
    end;
    if(panel.GetFieldValue(P_DIP) == "X")
      reportDIP.Run();
      reportDIP.Destructor();
    end;
    if(panel.GetFieldValue(P_DNIP) == "X")
      reportDNIP.Run();
      reportDNIP.Destructor();
    end;
    msgboxex("Данные для ЦКРР сформированы");
  end;

exit(1);