import Quik_UnloadINIFiles;

macro CreateCodesFile()
  var out_obj = c_Error();
  BegAction ("Выгрузка codes.ini");
  RunCreateCodesFile();
  EndAction();
  out_obj.ErrorCode = 0;
  out_obj.ErrorDesc = "OK";

  return out_obj;

onError(err)
   out_obj = c_Error;
   out_obj.ErrorCode = c_err_obj.obtain_err_code(err);
   out_obj.ErrorDesc = c_err_obj.obtain_err_msg(err);

   return out_obj;
end;

macro CreateDeallibFile()
  var out_obj = c_Error();
  BegAction ("Выгрузка deallib.ini");
  RunCreateDeallibFile();
  endAction();
  out_obj.ErrorCode = 0;
  out_obj.ErrorDesc = "OK";

  return out_obj;

onError(err)
   out_obj = c_Error;
   out_obj.ErrorCode = c_err_obj.obtain_err_code(err);
   out_obj.ErrorDesc = c_err_obj.obtain_err_msg(err);

   return out_obj;
end;


var err = "",out_obj = c_Error();
var ErrCode = 0;

private var v_choice;
private var v_acc_trn_menu = TArray;

v_acc_trn_menu.value(0) = "Выгрузка codes.ini";
v_acc_trn_menu.value(1) = "Выгрузка deallib.ini";

v_choice = menu(v_acc_trn_menu, "Выберите вариант выгрузки", "Выберите вариант выгрузки", null, null, 0);
if(v_choice == 0)
   GetRegistryValue(REG_QUIK_CODES_INI, V_STRING, PATH_QUIK_CODES_INI, ErrCode);
   if( ( ErrCode > 0 ) or (not PATH_QUIK_CODES_INI) )
      msgbox("Настройка "+REG_QUIK_CODES_INI+" не найдена или отключена, выгрузка невозможна");
      exit(1);
   end;

   if (MsgBoxEx("Вы уверены, что хотите выгрузить данные в файл "+PATH_QUIK_CODES_INI+"\\codes.ini",MB_YES+MB_NO, IND_NO) == IND_YES )
      out_obj = CreateCodesFile;
      if (out_obj.errorCode != 0)
         err = out_obj.ErrorCode + "	" + out_obj.ErrorDesc;
      end;
      if (err == "")
         MsgBox("Файл codes.ini обновлен");
      else
         MsgBox(err);
      end;
   end;

elif (v_choice == 1 )
   GetRegistryValue(REG_QUIK_DEALLIB_INI, V_STRING, PATH_QUIK_DEALLIB_INI, ErrCode);
   if( ( ErrCode > 0 ) or (not PATH_QUIK_DEALLIB_INI) )
      msgbox("Настройка "+REG_QUIK_DEALLIB_INI+" не найдена или отключена, выгрузка невозможна");
      exit(1);
   end;

   if (MsgBoxEx("Вы уверены, что хотите выгрузить данные в файл "+PATH_QUIK_DEALLIB_INI+"\\deallib.ini",MB_YES+MB_NO, IND_NO) == IND_YES )
      var out_obj2 = c_Error();
      out_obj2 = CreateDeallibFile;
      if (out_obj2.errorCode != 0)
         err = err + "|" + out_obj2.ErrorCode + "	" + out_obj2.ErrorDesc;
      end;
      if (err == "")
         MsgBox("Файл deallib.ini обновлен");
      else
         MsgBox(err);
      end;
   end;
else
   msgbox("Выбор не подтвержден");
   return 0;
end;




exit(1);