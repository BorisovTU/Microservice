/*
$Name:        SCImpRegContrSEM82.mac
$Module:      Ценные бумаги
$Description: Загрузка данных о регистрации изменений по договоарм на бирже SEM82
*/

IMPORT "XMLLoader.mac", "ScImpRate.mac";
import gtdlfun_u;
import RsbFormsInter;
import "u_common_email_utils.mac";

PRIVATE VAR   FlagCtrlBrk = false;
PRIVATE CONST CtrlBrkErr  = 17;



private macro SendSimpleNotify(email, subject, text, attach);

        var v_email_processor = c_email_proc_env();

        v_email_processor.m_add_email_to_list(email);
        v_email_processor.m_set_msg_head(Subject);
        v_email_processor.m_add_row_to_msg_text(Text);

        if (ValType(attach) != V_UNDEF)
           v_email_processor.m_add_attach_to_list(attach);
        end;

        v_email_processor.m_save_to_submit_synch();
        v_email_processor.m_submit_email_synch();
end;


//PRIVATE 
CLASS  SC_ImportRegContrSEM82()

  var datafilepath, fname, XML_copy;

  PRIVATE CLASS DataContracts()
    var ClientCode :string,
        Type       :string,
        Details    :string,
        CountryCode:string,
        Q_Investor :string,
        IsCurrency :string,
        IsInsurer  :string,
        IsIIA      :string,
        CrossTrd   :string,
        Status     :string,
        DateOpen   :date,
        DateClose  :date,
        DataChanged:string;

    macro Init()
       ClientCode = Type = Details = CountryCode = Q_Investor = IsCurrency = IsInsurer = IsIIA = CrossTrd = Status = DataChanged = "";
       DateOpen = DateClose = date(0,0,0);
    end;

    macro InitRecords()
       ClientCode = Type = Details = CountryCode = Q_Investor = IsCurrency = IsInsurer = IsIIA = CrossTrd = Status = DataChanged = "";
       DateOpen = DateClose = date(0,0,0);
    end;

    macro ClearTable()
       var cmd = RSDCommand( " truncate table dloadsem82_dbt ");
           cmd.Execute();
    end;

    macro Insert()
       var cmd = RSDCommand( " insert into dloadsem82_dbt values (?,?,?,?,?,?,?,?,?,?,?,?,?) ");
           cmd.AddParam("", RSDBP_IN, ClientCode);
           cmd.AddParam("", RSDBP_IN, Type);
           cmd.AddParam("", RSDBP_IN, Details);
           cmd.AddParam("", RSDBP_IN, CountryCode);
           cmd.AddParam("", RSDBP_IN, Q_Investor);
           cmd.AddParam("", RSDBP_IN, IsCurrency);
           cmd.AddParam("", RSDBP_IN, IsInsurer);
           cmd.AddParam("", RSDBP_IN, IsIIA);
           cmd.AddParam("", RSDBP_IN, CrossTrd);
           cmd.AddParam("", RSDBP_IN, Status);
           cmd.AddParam("", RSDBP_IN, DateOpen);
           cmd.AddParam("", RSDBP_IN, DateClose);
           cmd.AddParam("", RSDBP_IN, DataChanged);
           cmd.Execute();
    end;

  end;



  PRIVATE VAR Contracts = DataContracts();


  private var isSilent = false;

  MACRO getXMLClearRecords(xml)
   XML_copy = ActiveX( "MSXML.DOMDocument", null, true );
   XML_copy.load( datafilepath + fname ); //xml
   XML_copy.setProperty("SelectionLanguage", "XPath");
   var firmNode = XML_copy.DocumentElement.SelectSingleNode("//FIRM");
   var recordNode = XML_copy.DocumentElement.SelectSingleNode("//RECORDS");
   while (ValType(recordNode) != V_UNDEF)
      firmNode.removeChild(recordNode);
      recordNode = XML_copy.DocumentElement.SelectSingleNode("//RECORDS");
   end;
  end;

  MACRO SetSilentMode(mode)
     IsSilent = mode;
     if (IsSilent)
        SetDialogFlag(0);
     else
        SetDialogFlag(1);
     end;
  END;

  macro IsSilentMode()
     return IsSilent;
  end;

  MACRO DataFileName():STRING
     return datafilepath + fname;
  END;

  MACRO Error( Str:STRING ):BOOL
     MsgBox( "ERROR: " + Str );
     //m_ErrorCount = m_ErrorCount + 1;
     return false;
  END;

  MACRO Warning( Str:STRING ):BOOL
     MsgBox( "WARNING: " + Str );
     //m_WarnCount = m_WarnCount + 1;
     return true;
  END;

  PRIVATE MACRO LZ( num, len )
     var str1, len1;
     str1 = trim( string( num ) );
     len1 = strlen( str1 );
     if( len1 >= len )
        return str1;
     else
        return mkstr("0", len-len1 ) + str1; /* слева */
     end;
  END;


  MACRO strImpDate( dt ):STRING
     var day, month, year;
     var YearLen:integer =  2;
     DateSplit(dt, day, month, year);
     if( YearLen == 2 )
        year = year - 1900;

        if ( year >= 100 )
           year = year - 100;
        end;
     end;

     return LZ(day,2) + LZ(month,2) + LZ(year,YearLen);
  END;

  /* настраиваемый пользователем макрос формирования
     имен файла котировок и сделок с госбумагами с ММВБ */
  MACRO GetDataFileName( CalcDate ):BOOL
     var ErrStr = "";

/*ak
     datafilepath = GetRegImportDir( "MICEX", @ErrStr );

     if( ErrStr != "" )
        errmsg = ErrStr;
        return false;
     end;

     datafilepath = datafilepath + "QUOTESX" + "\\";*/
     datafilepath = GetRegImportDirU(calcdate, @ErrStr);
/*!ak*/

     var datafilemask = "???????_" + "SEM82" + "_???_" + strImpDate(calcdate) + "_?????????" + ".xml";
     var List = TDirList ( datafilepath + datafilemask, "f" );

     List.Sort(0);

     if (List.Count == 0)
        fname = "";
        MsgBox( "Ошибка открытия файла данных. Не найден файл по маске " + datafilepath + datafilemask );
        return false;
     end;

     fname = List.name(0);
     return true;
  END;


  MACRO LoadFromFile(CalcDate):bool

     private class itemArr(_code, _dat, _tim, _xml)
        var code, xml, dat, tim;
        code = _code;
        dat  = _dat;
        tim  = _tim;
        xml  = _xml;
     end;

     /*найти запись в массиве с таким же кодом клиента*/
     private macro FindItemArr(code, arr:@TArray)
        var pos = -1;
        for ( var i, arr )
           pos = pos + 1;
           if (i.code == code)
              return pos;
           end;
        end;
        return -1;
     end;

     /*добавляем в массив xml с записью по одному клиенту, которую потом запишем под ДБО*/
     private macro addXmlToArr(code,dat, tim, xml, child_Board, arr:@TArray)
        var _xml:object = ActiveX( "MSXML.DOMDocument" );
        var pos = FindItemArr(code, arr);

        if (pos == -1)/* если первая запись, то создаем новую xml и новый элеент массива*/
           _xml = XML_copy;
           //_xml.load( XML_copy );
           _xml.selectsinglenode("//FIRM").appendChild (child_Board); /*тут внимательно ! Append ПЕРЕМЕЩАЕТ ноду - в xml источинке она удаляется*/
           arr(arr.size) = itemArr(code, dat, tim, _xml);
        else /*такой клиент уже был - просто добавляем еще одну запись в уже имеющуюся xml*/
           arr[pos].xml.selectsinglenode("//FIRM").appendChild (child_Board);
        end;

     end;

     private macro GetDlcontrid(ClientCode)
        var Dt = TRsbDataSet(" select t_objectid dlid  from ddlobjcode_dbt where t_codekind = 1 and t_objecttype = 207 and t_code = '" + ClientCode + "'");
        if (dt.movenext())
           return dt.dlid;
        end;
        return -1;
     end;

     private macro InsertDlContrMsg(arr:TArray)
        var dlcontrmsg = Tbfile("dlcontrmsg", "W", 0);
        var cmd, rs;

        var NameFile,DirFileLen,FileNameLen; 

        for ( var i, arr )
           if (not RslDefCon.isInTrans)
           RslDefCon.BeginTrans;
           else
              RslDefCon.RollBackTrans; //при отладке старая иногда зависает. 
              RslDefCon.BeginTrans;
           end;

           dlcontrmsg.clear();
           dlcontrmsg.rec.DlContrID = GetDlcontrID(i.code);
           if (dlcontrmsg.rec.DlContrID == -1)
              RslDefCon.RollbackTrans;
              println("Не удалось найти ДБО по Коду клиента " + i.code);
              continue;
           end;
           dlcontrmsg.rec.Kind = 502;
           dlcontrmsg.rec.CreateDate = i.dat; //.panel.calcdate;//date();
           dlcontrmsg.rec.CreateTime = i.tim; //Time();

           rs = RsdRecordSet (" select 1 from ddlcontrmsg_dbt where t_dlcontrid = " + dlcontrmsg.rec.DlContrID + 
                              " and t_kind = " + dlcontrmsg.rec.Kind + 
                              " and t_createdate = " + GetSQLDate(dlcontrmsg.rec.CreateDate) );
           if (not rs.movenext())
              if( not dlcontrmsg.insert() )
                 RslDefCon.RollbackTrans;
                 println("Ошибка вставки сообщения под ДБО по Коду клиента " + i.code);
                 continue;
              end;
              cmd = RsdCommand( "update ddlcontrmsg_dbt set t_xml = :xml where t_id = :id"  );
              cmd.addParam("xml", RSDBP_IN,i.xml.xml, V_STRING, 4000);
              cmd.addParam("id", RSDBP_IN,dlcontrmsg.rec.id);
              cmd.execute();

              NameFile = StrSubst(string(date(dlcontrmsg.rec.CreateDate):f),".","") + "_SEM82_" +i.code ; 
              FileNameLen = strlen(NameFile);
              NameFile = GetTxtFileName(NameFile); 
              DirFileLen = strlen(NameFile);
              NameFile = substr(NameFile, 1, Index(NameFile, ".", DirFileLen - FileNameLen)-1) + ".xml";

              i.xml.Save(NameFile);

              if( not LoadImageObj(NameFile, OBJTYPE_BSCMSG_DL, UniID(dlcontrmsg, OBJTYPE_BSCMSG_DL), 1)) 
//                 MsgBox("К записи о сообщении не удалось прикрепить файл сообщения");
                 RslDefCon.RollbackTrans;
                 println("К записи о сообщении не удалось прикрепить файл сообщения. Код клиента: " + i.code);
                 continue;
              else
                 RemoveFile(NameFile);
              end;

              RslDefCon.CommitTrans;
           else
              RslDefCon.RollbackTrans;
              println("Уже есть сообщение Ответ от биржи на ДБО по Коду клиента " + i.code);
           end;
        end;

        return true;
     end;


     var xml:object = ActiveX( "MSXML.DOMDocument" );
     var xml2:object = ActiveX( "MSXML.DOMDocument" );
     var xml2arr = TArray();

     var node:object, child_MicexDoc:object, child_Sem82:object, child_Board:object;
     var DOC_REQUISITES = false, SEM82 = false;
     var i=0, j=0, k=0;
     var ffile, FTime;

     Contracts.ClearTable();

     if (not GetDataFileName( CalcDate))
        return false;
     end;

     /* откроем файл импорта */
     if( not xml.load( DataFileName() ) )
       return Error(string( "Неверный формат файла импорта|", DataFileName(), "|Невозможно загрузить xml-документ" ));
     end;

     ffile = TDirList(DataFileName(),"f");
     if (ffile.Count() == 1)
        FTime = ffile.Ftime(0);
     end;

     getXMLClearRecords(xml);

     node = xml.DocumentElement;
     /* считаем параметры котировок */
     i=0;
     while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
        child_MicexDoc = node.childNodes.item(i);
        if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))

           if(child_MicexDoc.tagname == "DOC_REQUISITES")
              if(DOC_REQUISITES)
                 return Error( DataFileName() + ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре");
              end;
              DOC_REQUISITES = true;
           end;

           if(child_MicexDoc.tagname == "SEM82")
              if(SEM82)
                 return Error( DataFileName(), ": Блок MICEX_DOC\SEM82 должен присутствовать в единственном экземпляре");
              end;
              SEM82 = true;
              //if(ReadTagAttribut(child_MicexDoc, "REPORTDATE", V_DATE, Rates.TradeDate) == false)
                 /* если не нашли дату предоставления информации */
              //end;
              j=0;

//              InitProgress(child_MicexDoc.childNodes.length, "Загрузка файла ", "Просмотр режимов торгов...");
              while(j<child_MicexDoc.childNodes.length) /* бегаем по SEM21 */
                 child_Sem82 = child_MicexDoc.childNodes.item(j);
                 if(child_Sem82 and (child_Sem82.nodeType==CHILD_NODE))

                    if(child_Sem82.tagname == "FIRM")
                       k=0;
                       InitProgress(child_Sem82.childNodes.length, "Загрузка файла SEM82", "Просмотр записей ...");
                       while(k<child_Sem82.childNodes.length/* != 0*/) /* бегаем по BOARD */
                          child_Board = child_Sem82.childNodes.item(k);
                          if(child_Board and (child_Board.nodeType==CHILD_NODE))
                              if(child_Board.tagname == "RECORDS")
                                  Contracts.InitRecords();

                                  if(ReadTagAttribut(child_Board, "CLIENTCODE", V_STRING, Contracts.ClientCode ) == false)/* если не нашли  */end;
                                  if(ReadTagAttribut(child_Board, "TYPE",       V_STRING, Contracts.Type       ) == false)/* если не нашли  */end;
                                  if(ReadTagAttribut(child_Board, "DETAILS",    V_STRING, Contracts.Details    ) == false)/* если не нашли  */end;
                                  if(ReadTagAttribut(child_Board, "COUNTRYCODE",V_STRING, Contracts.CountryCode) == false)/* если не нашли  */end;
                                  if(ReadTagAttribut(child_Board, "Q_INVESTOR", V_STRING, Contracts.Q_Investor ) == false)/* если не нашли  */end;              
                                  if(ReadTagAttribut(child_Board, "ISCURRENCY", V_STRING, Contracts.IsCurrency ) == false)/* если не нашли  */end;
                                  if(ReadTagAttribut(child_Board, "ISINSURER",  V_STRING, Contracts.IsInsurer  ) == false)/* если не нашли  */end;
                                  if(ReadTagAttribut(child_Board, "ISIIA",      V_STRING, Contracts.IsIIA      ) == false)/* если не нашли  */end;
                                  if(ReadTagAttribut(child_Board, "CROSSTRD",   V_STRING, Contracts.CrossTrd   ) == false)/* если не нашли  */end;
                                  if(ReadTagAttribut(child_Board, "STATUS",     V_STRING, Contracts.Status     ) == false)/* если не нашли  */end;
                                  if(ReadTagAttribut(child_Board, "DATEOPEN",   V_DATE,   Contracts.DateOpen   ) == false)/* если не нашли  */end;
                                  if(ReadTagAttribut(child_Board, "DATECLOSE",  V_DATE,   Contracts.DateClose  ) == false)/* если не нашли  */end;                                                                             
                                  if(ReadTagAttribut(child_Board, "DATACHANGED",V_STRING, Contracts.DataChanged) == false)/* если не нашли  */end;    

                                  Contracts.Insert();/*вставили в таблицу dloadsem82_dbt*/
                                  if ((calcdate == Contracts.DateOpen) or 
                                      (calcdate == Contracts.DateClose)) 
                                     /* если это реально изменение договора в эту дату, а не просто информационная запись, 
                                        то сохраняем в массив для сохранения под договор*/
                                     addXmlToArr(Contracts.ClientCode, CalcDate, FTime, xml, child_Board, @xml2arr);
                                     k = k - 1;
                                  end;
                                  
                                  /* println(Contracts.ClientCode,";",Contracts.Type,";",Contracts.Details,";",Contracts.CountryCode,";",Contracts.Q_Investor,";",
                                             Contracts.IsCurrency,";",Contracts.IsInsurer,";",Contracts.IsIIA,";",Contracts.CrossTrd,";",Contracts.Status,";",
                                             Contracts.DateOpen,";",Contracts.DateClose,";",Contracts.DataChanged);  
                                    */
                              end;
                          end;
                          k = k + 1;
                          UseProgress(k);
                          if( FlagCtrlBrk == true )
                             break;
                          end;
                       end;
                       RemProgress(); 
                    end;

                 end;
                 j = j + 1;
                 UseProgress(j);
                 if( FlagCtrlBrk == true )
                    break;
                 end;
              end;
              RemProgress(); 
           end;

        end;
        i = i + 1;
        if( FlagCtrlBrk == true )
           RemProgress(); RemProgress();
           break;
        end;
     end;


     if (not InsertDlContrMsg(xml2arr))
        msgbox("Не удалось сохранить сообщения под договоры");
     end;

     return true;

  OnError( RslErrObj )
     RemProgress();RemProgress();
     MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
     RunError;
  END;

  macro FillTableForCompare(CalcDate)
     /*отбираем события за предыдущую календарную дату и вставляем в таблицу данные в таком же формате, как нам присылает биржа данные об это формате*/
     var sql = 
     " DECLARE " + 
     " PapNum varchar2(20) := ''; qinv char(1) := '';" 
     " function GetPaperNum(ClientCode in varchar2, dat in date) return varchar2 " +
     "  is    " +
     "  RetVal varchar2(20):=''; " +
     "  begin  " +
     " SELECT details into retval from ( select REPLACE (t_paperseries, CHR (1)) || ' ' || REPLACE (t_papernumber, CHR (1)) details                                                                                              " +
     "     FROM (SELECT *                                                                                                                                                                                 " 
     "             FROM (SELECT t_personid,t_paperkind,t_paperseries,t_papernumber,t_paperissueddate,t_ismain,t_isnotvalid,t_validtodate,t_changedate FROM DPERSNIDCHIST_DBT                               " +
     "                   UNION                                                                                                                                                                            " 
     "                   SELECT t_personid,t_paperkind,t_paperseries,t_papernumber,t_paperissueddate,t_ismain,t_isnotvalid,t_validtodate,TO_DATE ('31122999', 'ddmmyyyy') t_changedate FROM DPERSNIDC_DBT  " +
     "                   UNION                                                                                                                                                                            " 
     "                   SELECT t_objectid,NULL,CHR (1),SUBSTR (t_code, 0, INSTR (t_code, '/') - 1),NULL,'X',CHR (0),t_bankclosedate,                                                                     " +
     "                          DECODE (t_bankclosedate, TO_DATE ('01010001', 'ddmmyyyy'), TO_DATE ('31122999', 'ddmmyyyy'), t_bankclosedate)FROM dobjcode_dbt                                            " 
     "                    WHERE t_objecttype = 3 AND t_codekind = 16 AND t_state = 0)                                                                                                                     " +
     "            WHERE t_personid = (SELECT t_partyid FROM dsfcontr_dbt                                                                                                                                  " 
     "                                 WHERE t_id = (SELECT t_sfcontrid FROM ddlcontr_dbt                                                                                                                 " +
     "                                                WHERE t_dlcontrid = (SELECT t_objectid FROM ddlobjcode_dbt                                                                                            " 
     "                                                                      WHERE t_codekind = 1 AND t_objecttype = 207 AND t_code = ClientCode)))                                                        " +
     "                  AND TRIM (t_papernumber) <> CHR (1)) t                                                                                                                                            " 
     "    WHERE t_ismain = CHR (88) AND (t_changedate >= dat OR t_changedate = TO_DATE ('31122999', 'ddmmyyyy'))                                                                                         " +
     " ORDER BY t_personid, t_changedate desc) where rownum = 1;                                                                                                                                                                 " 
     /*
     "  SELECT replace(t_paperseries,chr(1)) ||' '|| replace(t_papernumber,chr(1)) details into retval " +
     "    FROM (SELECT t_personid,t_paperkind,t_paperseries,t_papernumber,t_paperissueddate,t_ismain,t_isnotvalid,t_validtodate,t_changedate " +
     "            FROM DPERSNIDCHIST_DBT " +
     "          UNION " +
     "          SELECT t_personid,t_paperkind,t_paperseries,t_papernumber,t_paperissueddate,t_ismain,t_isnotvalid,t_validtodate,TO_DATE ('31122999', 'ddmmyyyy') t_changedate " +
     "            FROM DPERSNIDC_DBT) t " +
     "   WHERE t_ismain = CHR (88) " +
     "         AND t_personid = " +
     "                (SELECT t_partyid FROM dsfcontr_dbt " +
     "                  WHERE t_id =  " +
     "                           (SELECT t_sfcontrid FROM ddlcontr_dbt WHERE t_dlcontrid = " +
     "                                      (SELECT t_objectid FROM ddlobjcode_dbt WHERE     t_codekind = 1 AND t_objecttype = 207 AND t_code = ClientCode))) " +
     "         AND t_changedate = " +
     "                (SELECT MAX (t_changedate) " +
     "                   FROM (SELECT t_changedate, t_personid, t_paperkind, t_ismain FROM DPERSNIDCHIST_DBT " +
     "                         UNION " +
     "                         SELECT TO_DATE ('31122999', 'ddmmyyyy'), t_personid, t_paperkind, t_ismain FROM DPERSNIDC_DBT) " +
     "                  WHERE     t_personid = t.t_personid AND t_paperkind = t.t_paperkind AND t_ismain = CHR (88) " +
     "                        AND t_changedate <= dat) " +
     "ORDER BY t_personid, t_changedate; " +*/
     "return retval;  exception when no_data_found then return null; " +
     "end; " +
     " function IsQinv(ClientCode in varchar2, dat in date) return varchar2 " +
     "  is    " +
     "  RetVal varchar2(20):=''; " +
     "  begin  " +
     " select decode(count(1),1,'Y','N') qinv into retval  " +
     "            FROM DV_SCQINVHIST hist      " +        
     "            WHERE hist.t_PartyID   = (SELECT t_partyid FROM dsfcontr_dbt " +
     "                  WHERE t_id =                                              " +
     "                           (SELECT t_sfcontrid FROM ddlcontr_dbt WHERE t_dlcontrid = " +
     "                                      (SELECT t_objectid FROM ddlobjcode_dbt WHERE     t_codekind = 1 AND t_objecttype = 207 AND t_code = ClientCode))) " +
     "                AND hist.t_State     = 1           " +
     "                AND hist.t_BegDate  <= dat            " +
     "                AND (hist.t_EndDate = TO_DATE('01.01.0001','DD.MM.YYYY') OR hist.t_EndDate > dat); " +
     "return retval; " +
     "end; " +

     "BEGIN " +
     "    DELETE FROM dcompsem82_dbt;"
     "   FOR i " +
     "      IN (SELECT (SELECT t_code " +
     "                    FROM ddlobjcode_dbt " +
     "                   WHERE     t_codekind = 1 " +
     "                         AND t_objecttype = 207 " +
     "                         AND t_objectid = t_dlcontrid) clientcode, " +
     "                 0 TYPE, " +
     "                 EXTRACTVALUE (xmltype (TO_CHAR (t.t_xml)), '/CLIENT/CLIENT_INFO/CLIENT_SIMPLE/CLIENT_INDIVIDUAL/PASSPORT_RF/@DocNo') Details, " +
     "                 EXTRACTVALUE (xmltype (TO_CHAR (t.t_xml)), '/CLIENT/CLIENT_INFO/CLIENT_SIMPLE/@CountryCode') CountryCode, " +
     "                 EXTRACTVALUE (xmltype (TO_CHAR (t.t_xml)), '/CLIENT/CLIENT_INFO/CLIENT_SIMPLE/@isQualInvestor') qual, " +
     "                 '-' iscurrency, " +
     "                 '-' isinsurer, " +
     "                 '-' isIIA, " +
     "                 CASE " +
     "                    WHEN t_kind = 1 THEN EXTRACTVALUE (xmltype (TO_CHAR (t.t_xml)), '/CLIENTS/CLIENT/CLIENT_CODE/CLIENT_MARKETS/@isCrossTrades') ELSE '-' " +
     "                 END crosstrd, " +
     "                 EXTRACTVALUE (xmltype (TO_CHAR (t.t_xml)), '/CLIENT/@ClientOperation') status, " +
     "                 (SELECT t_datebegin " +
     "                    FROM dsfcontr_dbt " +
     "                   WHERE t_id = (SELECT t_sfcontrid " +
     "                                   FROM ddlcontr_dbt " +
     "                                  WHERE t_dlcontrid = t.t_dlcontrid)) dateopen, " +
     "                 CASE " +
     "                    WHEN t_kind IN (3, 4) THEN " +
     "                       (SELECT t_dateclose " +
     "                          FROM dsfcontr_dbt " +
     "                         WHERE t_id = (SELECT t_sfcontrid " +
     "                                         FROM ddlcontr_dbt " +
     "                                        WHERE t_dlcontrid = t.t_dlcontrid)) " +
     "                    WHEN t_kind = 7 THEN t_createdate " +
     "                    ELSE TO_DATE ('01010001', 'ddmmyyyy') " +
     "                 END dateclose, " +
     "                 'Y' datachanged, d.dt dt " +
     "            FROM ddlcontrmsg_dbt t, (select :dt dt from dual) d " +
     "           WHERE t_createdate between d.dt and d.dt and (( :dlid1 = -1) or (t_dlcontrid = :dlid2)) and t_kind in (1,2,3,4,7) and dbms_lob.substr(t_xml,4000) is not null and regexp_like(t.t_xml, '*?</CLIENT>')  ) " +
     "   LOOP " +
     "      IF i.status IN ('A', 'D', 'L') " +
     "      THEN " +
     "         PapNum := GetPaperNum(i.clientcode, i.dt); " +
     "         QInv   := IsQinv(i.clientcode, i.dt); " +
     "         INSERT INTO DCOMPSEM82_DBT (T_CLIENTCODE,T_TYPE,T_DETAILS,T_COUNTRYCODE,T_QINVESTOR,T_ISCURRENCY,T_ISINSURER,T_ISIIA, " +
     "                                     T_CROSSTRD,T_STATUS,T_DATEOPEN,T_DATECLOSE,T_DATACHANGED) " +
     "              VALUES (i.clientcode,i.TYPE,PapNum,i.COUNTRYCODE,QInv,i.ISCURRENCY,i.ISINSURER,i.ISIIA,i.CROSSTRD, " +
     "                      i.STATUS,i.DATEOPEN,i.DATECLOSE,i.DATACHANGED                     ); " +
     " " +
     "         DBMS_OUTPUT.put_line (i.clientcode|| '   '|| i.TYPE|| '   '|| i.DETAILS|| '   '|| i.COUNTRYCODE|| '   '|| i.Qual|| '   '|| i.ISCURRENCY|| '   '|| i.ISINSURER|| '   '|| i.ISIIA|| '   '|| i.CROSSTRD|| '   ' " +
     "            || i.STATUS|| '   '|| i.DATEOPEN|| '   '|| i.DATECLOSE|| '   '|| i.DATACHANGED); " +
     "      ELSIF i.status = 'U' " +
     "      THEN " +
     "         PapNum := GetPaperNum(i.clientcode, i.dt-1); " +
     "         QInv   := IsQinv(i.clientcode, i.dt-1); " +

     "         INSERT INTO DCOMPSEM82_DBT (T_CLIENTCODE,T_TYPE,T_DETAILS,T_COUNTRYCODE,T_QINVESTOR,T_ISCURRENCY,T_ISINSURER,T_ISIIA,T_CROSSTRD, " +
     "                                     T_STATUS,T_DATEOPEN,T_DATECLOSE,T_DATACHANGED) " +
     "              VALUES (i.clientcode,i.TYPE,PapNum,i.COUNTRYCODE,qinv,i.ISCURRENCY,i.ISINSURER,i.ISIIA,i.CROSSTRD, " +
     "                      'D',i.DATEOPEN,i.DATECLOSE,i.DATACHANGED); " +
     " " +
     "         INSERT INTO DCOMPSEM82_DBT (T_CLIENTCODE,T_TYPE,T_DETAILS,T_COUNTRYCODE,T_QINVESTOR,T_ISCURRENCY,T_ISINSURER,T_ISIIA,T_CROSSTRD, " +
     "                                     T_STATUS,T_DATEOPEN,T_DATECLOSE,T_DATACHANGED) " +
     "              VALUES (i.clientcode,i.TYPE,i.Details,i.COUNTRYCODE,i.Qual,i.ISCURRENCY,i.ISINSURER,i.ISIIA,i.CROSSTRD, " +
     "                      'A',i.DATEOPEN,i.DATECLOSE,i.DATACHANGED); " +
     " " +
     "         DBMS_OUTPUT.put_line (i.clientcode|| '   '|| i.TYPE|| '   '|| i.DETAILS|| '   '|| i.COUNTRYCODE|| '   '|| i.Qual|| '   '|| i.ISCURRENCY|| '   '|| i.ISINSURER|| '   '|| i.ISIIA|| '   ' " +
     "            || i.CROSSTRD|| '  D   '|| i.DATEOPEN|| '   '|| TO_DATE ('01010001', 'ddmmyyyy')|| '   '|| i.DATACHANGED); " +
     "         DBMS_OUTPUT.put_line (i.clientcode|| '   '|| i.TYPE|| '   '|| i.DETAILS|| '   '|| i.COUNTRYCODE|| '   '|| i.Qual|| '   '|| i.ISCURRENCY|| '   '|| i.ISINSURER|| '   '|| i.ISIIA|| '   ' " +
     "            || i.CROSSTRD|| '   A   '|| i.dateclose|| '   '|| TO_DATE ('01010001', 'ddmmyyyy')|| '   '|| i.DATACHANGED); " +
     "      END IF; " +
     "   END LOOP; " +
     "END; ";

     var cmd = RsdCommand(sql);
         cmd.addParam(":dt", RSDBP_IN, CalcDate);
       //  cmd.addParam(":dt2", RSDBP_IN, CalcDate);
         cmd.addParam(":dlid1", RSDBP_IN, -1/*1942*/);
         cmd.addParam(":dlid2", RSDBP_IN, -1/*1942*/);
         cmd.Execute();
     //var rs = RsdRecordSet(cmd);

  OnError( RslErrObj )
     RemProgress();RemProgress();
     MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
     RunError;

  end;

  macro Compare(CalcDate)
     var count = 0, NeedSend = false, rs;
     //Переменные для варианта WindowsReports, поддерживающего POIReports
     var csvFile, fName, csvTable, printEngine;
     const SHEET_NAME = "Отчет";
     const TEMPL_NAME = "Report_SCImpRegContrSEM82.xlsx";
     const CSV_NAME   = "SCImpRegContrSEM82_csv.txt";

     private macro InsertDlContrMsg(dlcontr, xml)
        var dlcontrmsg = Tbfile("dlcontrmsg", "W", 0);

        dlcontrmsg.clear();
        dlcontrmsg.rec.DlContrID = DlContr.rec.DlContrID;
        dlcontrmsg.rec.Kind = 502;
        dlcontrmsg.rec.CreateDate = date();
        dlcontrmsg.rec.CreateTime = Time();
        if( not dlcontrmsg.insert() )
           return false
        end;
        /*update xml*/
        return true;

     end;

     private macro print_header(str)
       printEngine.SetValue_NameCell("CalcDate", CalcDate);
       printEngine.SetValue_NameCell("str", str);

       printEngine.CopyAllSheetInTotalBook (null, false, "templateHeader", 0, SHEET_NAME);

     end;

     private macro print_line()
        var Dt = TRsbDataSet(" SELECT t.t_name, t.t_number " +
                             "  FROM dsfcontr_dbt t, dobjcode_dbt o, ddlcontr_dbt d " +
                             " WHERE o.t_code = '"+rs.value("t_ClientCode")+
                             "' AND o.t_objectid = d.t_dlcontrid AND d.t_sfcontrid = t.t_id ");
        var Name = "", Number = "";
        if (Dt.movenext())
           Name = Dt.Name;
           Number = Dt.Number;
        end;

        csvFile.AddCell(rs.value("t_ClientCode") );
        csvFile.AddCell(Name );
        csvFile.AddCell(Number );
        csvFile.AddCell(rs.value("t_Details") );
        csvFile.AddCell(rs.value("t_qinvestor") );
        csvFile.AddCell(rs.value("t_IsIIA") );
        csvFile.AddCell(rs.value("t_Status") );
        csvFile.AddCell(SQL_ConvTypeDate(rs.value("t_DateOpen")) );
        csvFile.AddCell(SQL_ConvTypeDate(rs.value("t_DateClose")) );
        csvFile.AddCell(rs.value("t_DataChanged") );
        
        csvFile.AddRow();

     end;

    printEngine=CTemplateXLS(NULL, NULL, NULL, NULL, NULL, NULL, true, false);

    if(printEngine.UsePoi())
      printEngine.SetXLSXFormat();
    end;

    printEngine.CreateTotalBook();

    printEngine.OpenTemplate(TEMPL_NAME, true);
    printEngine.SheetChange(1);

    csvTable = printEngine.RegisterTable("tableRow", null, true); //"tableHeader"
    csvFile = C_CSVFile();
    if (printEngine.UsePoi())
      csvFile.SetLimitRow(FLUSH_COUNT_XLSX);
    end;
    fName = csvFile.CreateFullFileName(CSV_NAME);
    csvFile.FileOpen(fName, true);

    /*сравнить загруженное из файла и созданное нами по событиям в системе*/
    /*1. Ищем изменения, которые есть в СОФР и нет в SEM82*/
     var SQL = 
     "SELECT * " +
     "  FROM    dcompsem82_dbt c " +
     "       LEFT JOIN " +
     "          dloadsem82_dbt l " +
     "       ON     c.t_clientcode = l.t_clientcode " +
     "          AND c.t_qinvestor = l.t_qinvestor " +
     "          AND c.t_status = l.t_status " +
     "          AND replace(c.t_details,' ') = replace(l.t_details,' ') " +
//     "          AND l.t_datachanged = 'Y'" +
     "          WHERE /*((l.t_dateopen = " + GetSQLDate(CalcDate) + " and l.t_dateclose is null) or (l.t_dateclose = " + GetSQLDate(CalcDate) + "))"   
     "          AND */l.t_clientcode IS NULL " +
     "          ORDER BY c.t_clientcode, c.t_dateopen "; 
//     msgbox(sql);
     var cmd = RsdCommand(sql);
         cmd.Execute();
     rs = RsdRecordSet(cmd);
    /*Вывести расхождения*/
    print_header("Изменения в СОФР не найдены в биржевом файле");
    while (rs.movenext())
       print_line();
       count = count + 1;
       NeedSend = true;
    end;

    /********************************/
    /*сравнить загруженное из файла и созданное нами по событиям в системе*/
    /*2. Ищем, что есть в файле, но нет у нас. Инициатор всегда СОФР, поэтому в теории этот селект никогда ничего не должен возвращать, но мало ли ... */
      SQL = 
     " SELECT * " +
     "  FROM    dLOADsem82_dbt c " +
     "       LEFT JOIN " +
     "          dCOMPsem82_dbt l " +
     "       ON     c.t_clientcode = l.t_clientcode " +
     "          AND c.t_qinvestor = l.t_qinvestor " +
     "          AND c.t_status = l.t_status " +
     "          AND replace(c.t_details,' ') = replace(l.t_details,' ') " +
//     "          AND c.t_datachanged = 'Y'" +
     "          WHERE ((c.t_dateopen = " + GetSQLDate(CalcDate) + " and c.t_dateclose is null) or (c.t_dateclose = " + GetSQLDate(CalcDate) + "))"   
     "          AND l.t_clientcode IS NULL " +
     "          ORDER BY c.t_clientcode, c.t_dateopen "; 

      cmd = RsdCommand(sql);
         cmd.Execute();
     rs = RsdRecordSet(cmd);
    /*Вывести расхождения*/

    print_header("Изменения в биржевом файле не найдены в СОФР");
    while (rs.movenext())
       print_line();
       count = count + 1;
       NeedSend = true;
    end;

    /*сравнить загруженное из файла и созданное нами по событиям в системе*/
    /*3. Смапленные записи. Когда все записи здесь - это хорошо*/
      SQL = 
     " SELECT * " +
     "  FROM    dLOADsem82_dbt c " +
     "      INNER JOIN " +
     "          dCOMPsem82_dbt l " +
     "       ON     c.t_clientcode = l.t_clientcode " +
     "          AND c.t_qinvestor = l.t_qinvestor " +
     "          AND c.t_status = l.t_status " +
//     "          AND c.t_datachanged = 'Y'" +
     "          WHERE ((c.t_dateopen = " + GetSQLDate(CalcDate) + " and c.t_dateclose is null) or (c.t_dateclose = " + GetSQLDate(CalcDate) + "))"   
     "          AND replace(c.t_details,' ') = replace(l.t_details,' ') " +
     "          ORDER BY c.t_clientcode, c.t_dateopen "; 

      cmd = RsdCommand(sql);
         cmd.Execute();
     rs = RsdRecordSet(cmd);
    /*Вывести расхождения*/

    print_header("Изменения есть и в СОФР, и в биржевом файле");
    while (rs.movenext())
       print_line();
       count = count + 1;
    end;

    csvFile.FileClose();
    csvTable.FillTabelFromCSV(csvFile.GetlsFileName());
    csvTable.EndTable();

    printEngine.CopyAllSheetInTotalBook(SHEET_NAME,         //Имя закладки,по умолчанию имя закладки из шаблона
                                false, // true - на новый лист, false - на существующий(если имя листа отличается, всегда на новый лист)
                                csvTable.GetTableRange(),     //Что копировать м.б. диапозон вида "A1:T60" или имя именованного диапозона
                                  0,
                                SHEET_NAME) ;
    printEngine.Close();

    if ( IsSilent )
       printEngine.SaveTotalBook("SCImpRegContrSEM82", false);
    else
       printEngine.SaveTotalBook("SCImpRegContrSEM82");
    end;


    /*если запуск из планировщика - отправить письмо на broker@rshb.ru*/
    if (( IsSilent) and (NeedSend)) ;

       SendSimpleNotify(GetMainRSHBBrokerAddress(), "Сверка SEM82", " Во вложении результаты сверки",
                        "..\\TxtFile\\" + StrSubst(printEngine.reportFileName_XLS,"htm","files")); // + "\\sheet00001.htm"
    end;
  end;

  
END;
