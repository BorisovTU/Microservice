import globals, InsCarryDoc;
import rsd;

class def34128rollbackClass()
  
  macro rollback(trn)
	var d = RsbAccTransaction();
        
        if (d.Find(trn) !=0 )
          println("Не найдена проводка №"+trn);
          return;
        end;
        if (d.Delete() == true ) 
          println("Удалена проводка №"+trn);
        else
          println("Ошибка при удалении проводки №"+trn);
        end;
  end;

  macro make_rollback()
    var query = "select * from DNPTXDEFFEREDOBJ_DBT ";
//    query = query + "  fetch first 1 rows only ";  //отладка
    var cmd = RSDCommand(query);
    var rs = RsdRecordSet(cmd);
    while (rs.movenext)
      if (valtype(rs.value("trn4"))!=26)
        if (rs.value("trn4")>0)
          rollback(rs.value("trn4")); //важен порядок
        end;
      end;
      if (valtype(rs.value("trn3"))!=26)
        if (rs.value("trn3")>0)
          rollback(rs.value("trn3")); //важен порядок
        end;
      end;
      if (valtype(rs.value("trn2"))!=26)
        if (rs.value("trn2")>0)
          rollback(rs.value("trn2")); //важен порядок
        end;
      end;
      if (valtype(rs.value("trn1"))!=26)
        if (rs.value("trn1")>0)
          rollback(rs.value("trn1")); //важен порядок
        end;
      end;
    end;
  end;
end;


macro def34128rollbackRun()
  var trnObject = def34128rollbackClass;
  trnObject.make_rollback;
onError(er)
  MsgBox("Ошибка при откате проводок " + er.Message);
end;
