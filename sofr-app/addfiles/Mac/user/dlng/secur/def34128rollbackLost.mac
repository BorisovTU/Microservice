import globals, InsCarryDoc;
import rsd;
import "def34128common.mac";

class def34128rollbackLostClass()
  
  macro rollback(trn)
	var d = RsbAccTransaction();
        
        if (d.Find(trn) !=0 )
          println("Не найдена проводка №"+trn);
          return false;
        end;
        if (d.Delete() == true ) 
          println("Удалена проводка №"+trn);
          return true;
        else
          println("Ошибка при удалении проводки №"+trn);
          return false;   
        end;
  end;

  macro updateStr(rs)
    var query = "update DDLCOMIS_LOST_34128_DBT lo set t_str = ? where t_guid = ? ";
    var cmd = RSDCommand(query);
    cmd.AddParam("", RSDBP_IN, "");
    cmd.AddParam("", RSDBP_IN, rs.value("t_guid"));
    cmd.execute;
  end;

  macro make_rollback()
    var maxcalcid = get34128CalcId();
    var query = 
        " select t_str, t_guid                                                                                                                                                                 "
        "  from DDLCOMIS_LOST_34128_DBT lo                                                                                                                                                     "
        "  where t_type = 1 and t_calcid = ?  and t_calcdate = ? and                                                                                                                           "
        "  (case when instr(t_str, ',') > 1 then to_number(substr(t_str, 1, instr(t_str, ',') - 1) default 0 on conversion error) else to_number(t_str default 0 on conversion error) end) > 0 "
        "  order by                                                                                                                                                                            "
        " (case when instr(t_str, ',') > 1 then to_number(substr(t_str, 1, instr(t_str, ',') - 1) default 0 on conversion error) else to_number(t_str default 0 on conversion error) end) desc ";
//    query = query + "  fetch first 1 rows only ";  //отладка
    var cmd = RSDCommand(query);
    cmd.AddParam("", RSDBP_IN, maxcalcid);
    cmd.AddParam("", RSDBP_IN, {curdate});
    var rs = RsdRecordSet(cmd);
    var a = tarray;
    while (rs.movenext)
      a = split1(rs.value("t_str"));
      for (var i,a.size-1,0)
        if (rollback(a(i))) 
          updateStr(rs);         
        end;
      end; 
    end;
  end;
end;


macro def34128rollbackLostRun()
  var trnObject = def34128rollbackLostClass;
    trnObject.make_rollback;
  end;
onError(er)
  MsgBox("Ошибка при проведении отката проводок " + er.Message);
end;
