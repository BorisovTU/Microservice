/*
$Name:        w112_panel.mac
$Module:      Ценные бумаги
$Description: Фин.мониторинг для БОФР - отчет, содержащий список операций, каждую из которых сотрудник должен проверить и при необходимости сформировать сообщение в формате Word вне системы
$Programmer:  Кротов А.
*/
import "DlRepForm_h.mac", "globals.mac";

/*Номера полей в форме отчета*/
CONST P_W112_BEGINDATE      = 0,
      P_W112_ENDDATE        = 1,
      P_W112_CLIENTTYPE     = 2,
      P_W112_CONTRAGENTTYPE = 3,
      P_W112_PAPERTYPE      = 4,
      P_W112_INMARKETLIST   = 5,
      P_W112_MARKET         = 6,
      P_W112_ROUTE          = 7,
      P_W112_DEALSUM        = 8,
      P_W112_AVRKIND        = 9,
      P_W112_AVRCODE        = 10,
      P_W112_AVRNAME        = 11,
      P_W112_PAPERNUM       = 12;

/* Обработчики для нестандарных контролов */
private CONST DL_CLIENTTYPE     = 101,
              DL_CONTRAGENTTYPE = 102,
              DL_PAPERTYPE      = 103,
              DL_INMARKETLIST   = 104,
              DL_MARKET         = 105,
              DL_ROUTE          = 106,
              DL_DEALSUM        = 107,
              DL_PAPERNUM       = 108;

PRIVATE MACRO Default( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
    FldShowValue = FldRealValue;
  end; 
  FldShowValue = FldRealValue;
  return CM_DEFAULT;
END;

MACRO DL_FldProc_ClientType( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if(Cmd == DLG_INIT)
    if(FldRealValue == null)
      FldRealValue = -1;
      FldShowValue = "Любой";
    end;
  elif((Cmd == DLG_KEY) AND (Key == KEY_SPACE)) 
    FldRealValue = -1;
    FldShowValue = "Любой";
  elif((Cmd == DLG_KEY) AND (Key == KEY_F3))
    DL_ListString(null, pThis.CurrentFldX(), pThis.CurrentFldY(), @FldShowValue, @FldRealValue,
                  "Любой",  -1,
                  "Резидент", 0,
                  "Нерезидент", 1);
  end;
  return CM_DEFAULT;
END;

MACRO DL_FldProc_PaperType( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if(Cmd == DLG_INIT)
    if(FldRealValue == null)
      FldRealValue = -1;
      FldShowValue = "Любая";
    end;
  elif((Cmd == DLG_KEY) AND (Key == KEY_SPACE)) 
    FldRealValue = -1;
    FldShowValue = "Любая";
  elif((Cmd == DLG_KEY) AND (Key == KEY_F3))
    DL_ListString(null, pThis.CurrentFldX(), pThis.CurrentFldY(), @FldShowValue, @FldRealValue,
                  "Любая",  -1,
                  "Иностранная ЦБ", 0,
                  "Российская ЦБ", 1);
  end;
  return CM_DEFAULT;
END;

MACRO DL_FldProc_InMarketList( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if(Cmd == DLG_INIT)
    if(FldRealValue == null)
      FldRealValue = -1;
      FldShowValue = "Любое";
    end;
  elif((Cmd == DLG_KEY) AND (Key == KEY_SPACE)) 
    FldRealValue = -1;
    FldShowValue = "Любое";
  elif((Cmd == DLG_KEY) AND (Key == KEY_F3))
    DL_ListString(null, pThis.CurrentFldX(), pThis.CurrentFldY(), @FldShowValue, @FldRealValue,
                  "Любое",  -1,
                  "Включена", 0,
                  "Не включена", 1);
  end;
  return CM_DEFAULT;
END;

MACRO DL_FldProc_Market( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if(Cmd == DLG_INIT)
    if(FldRealValue == null)
      FldRealValue = -1;
      FldShowValue = "Любой";
    end;
  elif((Cmd == DLG_KEY) AND (Key == KEY_SPACE)) 
    FldRealValue = -1;
    FldShowValue = "Любой";
  elif((Cmd == DLG_KEY) AND (Key == KEY_F3))
    DL_ListString(null, pThis.CurrentFldX(), pThis.CurrentFldY(), @FldShowValue, @FldRealValue,
                  "Любой",  -1,
                  "Биржевой", 0,
                  "Внебиржевой", 1);
  end;
  return CM_DEFAULT;
END;

MACRO DL_FldProc_Route( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if(Cmd == DLG_INIT)
    if(FldRealValue == null)
      FldRealValue = -1;
      FldShowValue = "Любое";
    end;
  elif((Cmd == DLG_KEY) AND (Key == KEY_SPACE)) 
    FldRealValue = -1;
    FldShowValue = "Любое";
  elif((Cmd == DLG_KEY) AND (Key == KEY_F3))
    DL_ListString(null, pThis.CurrentFldX(), pThis.CurrentFldY(), @FldShowValue, @FldRealValue,
                  "Любое",  -1,
                  "Покупка", 0,
                  "Продажа", 1);
  end;
  return CM_DEFAULT;
END;

MACRO DL_FldProc_DealSum( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if(Cmd == DLG_INIT)
    FldShowValue = FldRealValue;
  elif(Cmd == DLG_CHANGEVALUE)
    if(FldShowValue < 0)
      msgboxex("Сумма сделки должна быть >= 0");
      FldShowValue = FldRealValue;
    end;
    FldRealValue = FldShowValue;
  end;
  return CM_DEFAULT;
END;

MACRO DL_FldProc_PaperNum( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@DOUBLEL, FldRealValue:@DOUBLEL ):INTEGER
  if(Cmd == DLG_INIT)
    if(FldShowValue < 0)
      msgboxex("Количество бумаг должно быть >= 0");
      FldShowValue = FldRealValue;
    end;
    FldShowValue = FldRealValue;
  elif(Cmd == DLG_CHANGEVALUE)
    FldRealValue = FldShowValue;
  end;
  return CM_DEFAULT;
END;

CLASS (DL_CPanel) W112_Panel()

  PRIVATE MACRO Init()

     AddFieldProc(0, P_W112_BEGINDATE,      DL_PNFLD_BEGINDATE, @DL_FldProc_BeginDate, {curdate});
     AddFieldProc(0, P_W112_ENDDATE,        DL_PNFLD_ENDDATE,   @DL_FldProc_EndDate, {curdate});
     AddFieldProc(0, P_W112_CLIENTTYPE,     DL_CLIENTTYPE,      @DL_FldProc_ClientType, null, 36, 8);
     AddFieldProc(0, P_W112_CONTRAGENTTYPE, DL_CONTRAGENTTYPE,  @DL_FldProc_ClientType, null, 36, 9);
     AddFieldProc(0, P_W112_PAPERTYPE,      DL_PAPERTYPE,       @DL_FldProc_PaperType, null, 36, 10);
     AddFieldProc(0, P_W112_INMARKETLIST,   DL_INMARKETLIST,    @DL_FldProc_InMarketList, null, 36, 11);
     AddFieldProc(0, P_W112_MARKET,         DL_MARKET,          @DL_FldProc_Market, null, 36, 12);
     AddFieldProc(0, P_W112_ROUTE,          DL_ROUTE,           @DL_FldProc_Route, null, 36, 13);
     AddFieldProc(0, P_W112_DEALSUM,        DL_DEALSUM,         @DL_FldProc_DealSum, 600000);
     AddFieldProc(0, P_W112_AVRKIND,        DL_PNFLD_AVRKIND,   @DL_FldProc_AvrKind);
     AddFieldProc(0, P_W112_AVRCODE,        DL_PNFLD_AVRCODE,   @DL_FldProc_NpTxAvrCode);
     AddFieldProc(0, P_W112_AVRNAME,        DL_PNFLD_AVRNAME,   @Default);
     AddFieldProc(0, P_W112_PAPERNUM,       DL_PAPERNUM,        @DL_FldProc_PaperNum, 0);

  END;

  PRIVATE MACRO Check():BOOL
     return true;
  END;

  initDL_CPanel("ReportUserPanels.lbr", "W112" ); 

END;

