/*
$Name:        ExportCorLimQUIK.mac
$Module:      Ценные бумаги
$Description: Выгрузка коректировок лимитов QUIK
*/

import limout, Календарь;


private class c_ssRunResult(p_ProcessState, p_ErrorNumber, p_ErrorText)
   var ProcessState;
   var ErrorNumber;
   var ErrorText;

   private macro init_ssRunResult(p_ProcessState, p_ErrorNumber, p_ErrorText)
      if(ValType(p_ProcessState) != V_UNDEF)
         ProcessState = p_ProcessState;
      end;
      if(ValType(p_ErrorNumber) != V_UNDEF)
         ErrorNumber = p_ErrorNumber;
      end;
      if(ValType(p_ErrorText) != V_UNDEF)
         ErrorText = p_ErrorText;
      end;
   end;

   init_ssRunResult(p_ProcessState, p_ErrorNumber, p_ErrorText);
end;

/*
macro insertlog(v);
   var cmd = RsdCommand(" insert into _____dbt values (sysdate, ?, ?)");
       cmd.addParam("", RSDBP_IN,  string(v));
       cmd.addParam("", RSDBP_IN,  {oper});
       cmd.execute();
end;
*/

Macro Run_ExportCorLimQUIK()

   Var ResultSheduler;
   var IntVal = 0, err, dat = date(); //GetDateAfterWorkDays(date(),-1);//date(20,6,2019);//
   GetRegistryValue( "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\АВТОВЫГРУЗКА КОРРЕКТИРОВОК QUIK", V_INTEGER, IntVal, err );
   if ( not err)
      if ( (intVal == 1)/*включено*/
           and (GetDateAfterWorkDays (date(), 0) == date () ) //рабочий день
         )
         SetDialogFlag(0);

         LimitCorOut( dat, true );                               	

         SetDialogFlag(1);
      end;
   end;
//   Insertlog(geterrmsg());
   ResultSheduler = c_ssRunResult(3);

   return ResultSheduler;

End;
//    Run_ExportCorLimQUIK;
exit(1);

