 
/*
        Отчёт по лотам
        MEV, RSSL, Jan 2004, for TIBank

        Использует macro ПортфельПоЛотуИСделкеНаДату из spRepFun.mac
        Использует macro КоличествоНаЛотеПокупкиНаКонецДня(lotbuy, ValDate) из spserv.mac

        [!]: MEV, RSSL, 3 Feb 2004
                Если в отчёте для "Нашего банка" вдруг встречаются сделки из клиентского
                портфеля, значит в системе есть "кривые" лоты. Т.е. лоты, в которых обнулены
                поля Party, BuyGoal и GroupID.


   14.05.2009 ВР  Заплата GetBalanceCost()
   26.08.2009 ВР  В заплате GetBalanceCost() код валюты для расчёта переоценки 
                  берём равным не валюте лота, а валюте номинала бумаги
*/

import secinter, "spRepFun.mac", "spserv.mac", "getlot.mac", "DlForms_h.mac", or_tpl_h;

/* !!! Пользовательские настройки параметров отчета */
private const ПечататьТекстовыйОтчет = false;
private const ПечататьОтчетВExcel = true;
private var 
               TableWidth = 199; /* Ширина таблицы*/

private const SayError = true;  /* !!! Выдавать сообщения об ошибках */

//private record dlg("lotsrep", "tibank.lbr") dialog;
/*private file tmp( "lotsrep.tmp" ) key 0 WRITE; */

private const RUB_ISO = " RUB";
/*private const RUB_ISO = " RUR";*/

private var 
        NominalFI_ISO = "",             /* ISO-код валюты номинала */
        nFirstLine, nLastLine,  /* Номера строк таблицы */
        FirstSheetTitle = "",   /* Название первой закладки отчёта */
        manyAvoir = false,              /* Отчёт по всем выпускам? */
    /*    tmp,*/    /* Временный файл */
        Rep,    /* Отчёт */
        Header,     /* Заголовок отчёта */
        AllAmount;       /*Объем выпуска*/
private var
   IsApp = true;/*апострофы*/
private var 
   Is_BPP = true;
private var
   ZNDS=0;
	
private var
   ZOUT=0;

//Переменные для варианта WindowsReports, поддерживающего POIReports
private var
  csvFile, fName, csvTable, printEngine, SHEET_NAME;
  const TEMPL_NAME  = "Template_lotsrep.xlsx";
  const FILE_REPORT = "Report_lotsrep";
  const CSV_NAME    = "Report_lotsrep_csv.txt";

private const PNFLD_LOTSREP_DATE    = 0,
              PNFLD_LOTSREP_AVOIR   = 1,
              PNFLD_LOTSREP_OWNER   = 2,
              PNFLD_LOTSREP_PORTF   = 3,
              PNFLD_LOTSREP_ISBPP   = 4,
              PNFLD_LOTSREP_BUYKIND = 5,
              PNFLD_LOTSREP_APOSTR  = 6;

PRIVATE CONST H_PNFLD_DATE    = 101,
              H_PNFLD_AVOIR   = 102,
              H_PNFLD_OWNER   = 103,
              H_PNFLD_PORTF   = 104,
              H_PNFLD_BUYKIND = 105;


private const ALL_KIND = -1;    /* Всё */

private const ALL_PORTF = 0;
private const TORG_PORTF = 1;
private const SALE_PORTF = 2;
private const REPO_PORTF = 3;
private const UDP_PORTF  = 4; /* ВР. Тема Айса 237617 */


private array dlgPort;  /* Виды портфелей */
dlgPort(ALL_PORTF)  = "Все";
dlgPort(TORG_PORTF) = "ССПУ_ЦБ";
dlgPort(SALE_PORTF) = "СССД_ЦБ";
dlgPort(REPO_PORTF) = "ПВО";
dlgPort(UDP_PORTF)  = "АС_ЦБ"; /* ВР. Тема Айса 237617 */


private const NORMAL_BUYS = 1;
private const BACK_REPO = 2;

private array dlgBuyKind;       /* Виды покупок */
dlgBuyKind(0) = "Все";
dlgBuyKind(NORMAL_BUYS) = "Покупки";
dlgBuyKind(BACK_REPO) = "Обратное РЕПО";


private file fin(fininstr) key 0;
private file avr(avoiriss);
private file pty(party);
/*private file cli(client) key 2;*/
var cli = TBFile ("client.dbt","r",2);
private file lot(pmwrtsum) key 1;       /* FIID, Party и т.д. */
private file Deal(dl_tick) key 0;

private record dl_leg(dl_leg);
//private record pmpaym(pmpaym);
private var pmpaym = TRecHandler("dlrq.dbt");
var TSS, DateTSS;

/*private file _tmp("tlotsrep.dbt", "tibank.def") key 0 write;*/

class RepData   /* Параметры выпуска отчёта */
   var     Date = {curdate},
           Avoir = ALL_KIND,       /* По всем бумагам */
           Owner = {OurBank},      /* Наш банк */
           Portf = ALL_KIND,       /* Все портфели */
           IsBPP = "X",
           BuyKind = ALL_KIND,     /* Все виды покупок */
           Apostr  = "X";
end;

PRIVATE MACRO FldProc_Avoir( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT ) /*Установка значения в поле*/
    if( FldRealValue == null ) /*инициализация по умолчанию*/
      FldRealValue = ALL_KIND;
    end;
    FldShowValue = "Все";

  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) ) /*Вызов листалки и заполнение FldShowValue и FldRealValue*/
    if( ListAvoiriss (0, fin, avr, true) )
      FldRealValue = fin.FIID;
      FldShowValue = fin.FI_Code+" "+fin.Name;
    end;

  elif( (Cmd ==  DLG_KEY) AND (Key == KEY_SPACE) )
    FldRealValue = ALL_KIND;
    FldShowValue = "Все";
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO FldProc_Owner( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  var CodeKind = 1, PartCode;

  if( Cmd == DLG_INIT ) /*Установка значения в поле*/
    if( FldRealValue == null ) /*инициализация по умолчанию*/
      FldRealValue = {OurBank};
    end;
    ПолучитьСубъекта({OurBank}, pty);
    FldShowValue = string({OurBank})+" "+pty.ShortName;

  elif( Cmd == DLG_CHANGEVALUE ) /*значение поля было изменено*/
    /*Изменить значения связанных полей*/
    if( pThis.ExistField( H_PNFLD_PORTF ) )
      if ({OurBank} != FldRealValue)
        pThis.SetLinkedValue( H_PNFLD_PORTF, KINDPORT_CLIENT ); /*!!! Клиентский портфель*/
      else    /* Проверить портфель */
        if (pThis.GetLinkedValue( H_PNFLD_PORTF ) == KINDPORT_CLIENT)     /* Ставим все портфели */
          pThis.SetLinkedValue( H_PNFLD_PORTF, ALL_KIND );
        end;
      end;
    end;

  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) ) /*Вызов листалки и заполнение FldShowValue и FldRealValue*/
    if( ListPT(pty, CodeKind, PartCode, PTLIST_STOCKDLCLIENT) )
      FldRealValue = pty.PartyID;
      FldShowValue = PartCode+" "+pty.ShortName;
    end;

  elif( (Cmd ==  DLG_KEY) AND (Key == KEY_SPACE) )
    FldRealValue = ALL_KIND;
    FldShowValue = "Все";
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO FldProc_Portf( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT ) /*Установка значения в поле*/
    if( FldRealValue == null ) /*инициализация по умолчанию*/
      FldRealValue = ALL_KIND;
    end;
    FldShowValue = "Все";

  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) ) /*Вызов листалки и заполнение FldShowValue и FldRealValue*/
    if ({OurBank} != pThis.GetLinkedValue( H_PNFLD_OWNER )) /* Для всех владельцев и для клиентов портфель выбирать не нужно */
      return CM_DEFAULT;         
    end;

    DL_ListString( null, pThis.CurrentFldX(), pThis.CurrentFldY(), @FldShowValue, @FldRealValue,
                   dlgPort(ALL_PORTF),  ALL_PORTF,
                   dlgPort(TORG_PORTF), TORG_PORTF,
                   dlgPort(SALE_PORTF), SALE_PORTF,
                   dlgPort(REPO_PORTF), REPO_PORTF,
                   dlgPort(UDP_PORTF),  UDP_PORTF
                 );

  elif( (Cmd ==  DLG_KEY) AND (Key == KEY_SPACE) )
    FldRealValue = ALL_KIND;
    FldShowValue = "Все";
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO FldProc_BuyKind( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT ) /*Установка значения в поле*/
    if( FldRealValue == null ) /*инициализация по умолчанию*/
      FldRealValue = ALL_KIND;
    end;
    FldShowValue = "Все";

  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) ) /*Вызов листалки и заполнение FldShowValue и FldRealValue*/
    if ({OurBank} != pThis.GetLinkedValue( H_PNFLD_OWNER )) /* Для всех владельцев и для клиентов портфель выбирать не нужно */
      return CM_DEFAULT;         
    end;

    DL_ListString( null, pThis.CurrentFldX(), pThis.CurrentFldY(), @FldShowValue, @FldRealValue,
                   dlgBuyKind(0),           0,
                   dlgBuyKind(NORMAL_BUYS), NORMAL_BUYS,
                   dlgBuyKind(BACK_REPO),   BACK_REPO
                 );

  elif( (Cmd ==  DLG_KEY) AND (Key == KEY_SPACE) )
    FldRealValue = ALL_KIND;
    FldShowValue = "Все";
  end;
  return CM_DEFAULT;
END;

CLASS (DL_CPanel) LotsRep_Panel()
  var Params = RepData();

  PRIVATE MACRO Init()        
    AddFieldProc( 0, PNFLD_LOTSREP_DATE,    H_PNFLD_DATE,      @DL_FldProc_EndDate,  Params.Date);
    AddFieldProc( 0, PNFLD_LOTSREP_AVOIR,   H_PNFLD_AVOIR,     @FldProc_Avoir,       Params.Avoir);
    AddFieldProc( 0, PNFLD_LOTSREP_OWNER,   H_PNFLD_OWNER,     @FldProc_Owner,       Params.Owner);
    AddFieldProc( 0, PNFLD_LOTSREP_PORTF,   H_PNFLD_PORTF,     @FldProc_Portf,       Params.Portf,  31, 12);
    AddFieldProc( 0, PNFLD_LOTSREP_ISBPP,   DL_PNFLD_CHECKBOX, @DL_FldProc_CheckBox, Params.IsBPP);
    AddFieldProc( 0, PNFLD_LOTSREP_BUYKIND, H_PNFLD_BUYKIND,   @FldProc_BuyKind,     Params.BuyKind, 31, 14);
    AddFieldProc( 0, PNFLD_LOTSREP_APOSTR,  DL_PNFLD_CHECKBOX, @DL_FldProc_CheckBox, Params.Apostr);
  END;

  PRIVATE MACRO GetFieldValue(fldNum:integer):variant
    var showValue:variant, fldValue:variant;

    GetFieldValue(fldNum, @showValue, @fldValue);
    return fldValue;
  END;

  MACRO Run()
    var stat = Run();

    Params.Date    = GetFieldValue(PNFLD_LOTSREP_DATE);
    Params.Avoir   = GetFieldValue(PNFLD_LOTSREP_AVOIR);
    Params.Owner   = GetFieldValue(PNFLD_LOTSREP_OWNER);
    Params.Portf   = GetFieldValue(PNFLD_LOTSREP_PORTF);
    Params.IsBPP   = GetFieldValue(PNFLD_LOTSREP_ISBPP);
    Params.BuyKind = GetFieldValue(PNFLD_LOTSREP_BUYKIND);
    Params.Apostr =  GetFieldValue(PNFLD_LOTSREP_APOSTR);

    return stat;
  END;

  initDL_CPanel("tibank.lbr", "lotsrep");
END;


/* ВР. Получить балансовую стоимость. 
   Заплата, ибо системно поле pmwrtsum.BalanceCost заполняется не всегда верно */
macro GetBalanceCost(rWrtsum)
  var retValue = $0, 
      _OverAmount = $0,
	_Corrinttoeir = $0;

  /* Сумма переоценки всегда выражена в рублях. Конвертируем нац.валюту в валюту 
     лота по курсу на дату получения ТСС */
/*
   ВР.  Код валюты для расчёта переоценки  берём равным не валюте лота, а валюте номинала бумаги.

  if(rWrtsum.Currency and rWrtsum.OverAmount)
    if(not SmartConvertSum(_OverAmount, rWrtsum.OverAmount, DateTSS /*dlg.dDate*/, 0, rWrtsum.Currency, true))
      _OverAmount = $0;
    end;
  else
    _OverAmount = rWrtsum.OverAmount;
  end;
*/

  if(fin.FaceValueFI and rWrtsum.OverAmount)
    if((ValType(DateTSS) == V_UNDEF) or not SmartConvertSum(_OverAmount, rWrtsum.OverAmount, DateTSS, 0, fin.FaceValueFI, true))
      _OverAmount = $0;
    end;
  else
    _OverAmount = rWrtsum.OverAmount;
  end;

   if(fin.FaceValueFI and rWrtsum.Corrinttoeir)
    if((ValType(DateTSS) == V_UNDEF) or not SmartConvertSum(_Corrinttoeir, rWrtsum.Corrinttoeir, DateTSS, 0, fin.FaceValueFI, true))
      _Corrinttoeir = $0;
    end;
  else
    _Corrinttoeir = rWrtsum.Corrinttoeir;
  end;
 
  retValue = rWrtsum.Cost +                 /* стоимость */
             rWrtsum.NKDAmount +            /* НКД */                                                                              
 /* //           rWrtsum.OutLay +               /* затраты */       */                                                             
             rWrtsum.DiscountIncome +       /* НДД */                                                                              
             rWrtsum.InterestIncome +       /* НПД */
             rWrtsum.COSTPFI +              /*переоценка ПФИ */// SD-1976169
             _OverAmount +                  /* Переоценка */
	     _Corrinttoeir;          /*Корректировка ЭПС*/         

  return retValue;
end;


/************** ААИ Айс 326192 **********************/
macro FindComp(id, dat)
 var sql, rsd;
  rsd = Trsbdataset(" select t_amount amount from dpmwrtbc_dbt               "+
                    " where t_sumid in(select t_sumid from dpmwrtsum_dbt     "+
                    " where t_source=" +id+")                                "+
                    " and t_action=480                                       "+
                    " and t_changedate > " + GetSQLDate(dat)                  +                
                    " union                                                  "+ 
                    " select t_amount amount from dpmwrtsum_dbt              "+
                    " where t_source in "+id+
                    " and t_action=480                                       "+
                    " and t_changedate > " + GetSQLDate(dat)                 );                

 if( rsd.MoveNext() )
  return rsd.amount;
 else
  return 0;
 end;
end;
/************** ААИ Айс 326192 **********************/

macro ПолучитьСделкуПоПервЛоту(WrtID,_dealid,_dealcode)
   var sql, rsd;
   rsd = Trsbdataset("select * from dpmwrtsum_dbt where t_sumid = " + WrtID);
   if( rsd.MoveNext() )
//      return /*rsd.docid*/rsd.dealid;
      SetParm(1,rsd.dealid);
      SetParm(2,rsd.dealcode);
     return /*rsd.docid*/rsd.dealid;
   else 
      MsgBox("Не определена сделка по первоначальному лоту с t_sumid = ", WrtID);
   end;
end;

/* !!! Если отладочный вывод не нужен - закомментируй тело этой функции - и всё */
private macro _dbg(aParm:string)        /* Печать отладочных сообщений */
   var i = 1, val, str = string(aParm);
   
   while(GetParm(i, val))
      i = i + 1;
      str = str + string(val);
   end;  
   // println(str);
end;  

private macro dd(_a): double    /* Корректное приведение к типу DOUBLE */
   var r: double;
   r = _a;
   if (V_MONEY==ValType(_a))
           r = r/**0.01*/;
   end;
   return r;
end;

private var RepForm, RepParm, TmpName = "", dl_tick = TRecHandler("dl_tick");

private macro CheckLot(_lot, _Portf, _BuyKind, _Amount)       /* Проверка на корректность лота */
   var Portf, BuyKind, OperGroup, Amount, CompAmount;
    /*Проверить статус - лот должен быть поставлен или готов*/
   if ( (_lot.state < PM_WRTSUM_FORM) or (_lot.state == 2))    /*KD*/
      if((_lot.sumid == 2057289) and (_lot.changedate>=RepParm.Date))
        else     
         return false;
      end;
   end;
        
   /* 1. Проверить портфель */
   if (ПолучитьСделкуПоЛоту(_lot, dl_tick, SayError))
       /* Определить портфель на дату отчёта */
/*    Portf = ПортфельПоЛотуИСделкеНаДату( dl_tick.rec, _lot, RepParm.Date, SayError );*/

      Portf = _lot.Portfolio;
   else
      _dbg("Не найдена сделка по лоту");  
      return false;
   end;
   if (RepParm.Portf != ALL_KIND)
      if (Portf != RepParm.Portf)
         _dbg("Портфель не подходит");  
         return false;
      end;
   end;

    /* 2. Проверить цель приобретения */
    /* 3. Проверить вид операции */
   OperGroup = GetOperationGroup( dl_tick.rec.DealType );

  /*  if (IsBackSale(OperGroup))*/
/*   
   if ((dl_tick.rec.DealType == 2131) or (dl_tick.rec.DealType == 2121))
  ВР. Тема Айса 225647.
*/
   if(IsREPO(OperGroup) and IsBUY(OperGroup))

      BuyKind = BACK_REPO;    /* Репо */
   else        
      _dbg("Неопознанный вид операции: ", dl_tick.rec.DealType);
      BuyKind = NORMAL_BUYS;
   end;
   if (RepParm.BuyKind != ALL_KIND)    /* Указан тип сделки */
      if (BuyKind != RepParm.BuyKind)
         _dbg("Вид операции не подходит");        
         return false;
      end;
   end;

   /* 4. Определить количество бумаг на дату */
   if ( (_lot.ChangeDate < RepParm.Date) and (_lot.amount != 0) )
      Amount = _lot.amount;
   else
    
      CompAmount = FindComp(_lot.sumid, RepParm.Date); // ААИ Айс 326192 
      Amount = КоличествоНаЛотеПокупкиНаКонецДня(_lot, RepParm.Date) + CompAmount;
   end;

   if (Amount <=0)
      _dbg("На заданную дату на лоте не было бумаг");    
      return false;
   end;

   _dbg("Лот - ок :-)");      
   SetParm(1, Portf);
   SetParm(2, BuyKind);
   SetParm(3, Amount);

   return true;        /* Лот прошёл все проверки */    
end;

private macro getCostInNominalFI(_lot): money   /* Получить стоимость в валюте номинала */
   var   LegKind, dealid=_lot.DealID, dealcode=_lot.Dealcode,CostInNominal = $0, stat, ConvDate = _lot.Date, FD, IsBack;
   var   DocID = _lot.DocID;
      var   paymid =   0;              
                  /* Ищем сделку */
/*
/*KD*/  if(_lot.parent >0 )
            //_lot.dealid = ПолучитьСделкуПоПервЛоту(_lot.parent);
            ПолучитьСделкуПоПервЛоту(_lot.parent, dealid, dealcode);

        end;        
*/  /*Тут искать сделку покупки нужно а не лот по первой части :) */
   if((_lot.source >0 ) and (_lot.fiid!=94968/*по RUSSIA 11 2030 некорректные данные в полях t_source и t_parent*/))
      DocID = ПолучитьСделкуПоПервЛоту(_lot.source, dealid, dealcode);
    else 
      DocId = _lot.dealid;
   end;        
   ClearRecord( Deal );

   deal.dealid = dealid;

   if( not GetEQ( Deal ) ) 
      _dbg( "!!! Не найдена сделка по лоту pmwrsum.DealID = " + string( DealID ) );     
      return;
   end;
 //  paymid = GetRQId (DocID, deal.rec.pfi); /*gko*/

     if( not ПолучитьТОпоДокументу( Deal.Bofficekind, DocID, 1, 8, 0, pmpaym))   /*!!!*/
      _dbg( "!!! Не найдено требование на поставку основного актива (Код сделки=", Deal.DealCode, ")" );  
      return;
   end;

/*
   if( not GetPaymentInfo( NULL, 0, pmpaym, DocID ) ) 
      _dbg( "!!! Не найден платеж на поставку основного актива (Код сделки=", Deal.DealCode, ")" );   
      return;
   end; 

   if( pmpaym.Purpose == 3/*CRi*/ ) /*лот по обратной части сделки*/
      LegKind = LEG_KIND_DL_TICK_BACK;
      IsBack = true;
   else
      LegKind = LEG_KIND_DL_TICK;
      IsBack = false;
   end;
      ААИ переход на 31  */

      if( pmpaym.rec.DealPart/*Purpose*/ == 2/*CRi*/ ) /*лот по обратной части сделки*/
      LegKind = LEG_KIND_DL_TICK_BACK;
      IsBack = true;
   else
      LegKind = LEG_KIND_DL_TICK;
      IsBack = false;
   end;

      
   if( FindDL_LEG( LegKind, Deal.DealID, 0, dl_leg ) )
      /*Иногда могут быть сьезды в платеже тогда не сразу нужно проверять*/
      if( FindDL_LEG( LEG_KIND_DL_TICK, Deal.DealID, 0, dl_leg ) )
         _dbg( "!!! Не найдены условия сделки dl_leg.dbt (код сделки=", Deal.DealCode,")" );   
         return;
      end;
      IsBack = false;
   end;

   if( ПолучитьФинИн( _lot.FIID, fin, avr ) ) 
      _dbg( "!!!  Не найдена ценная бумага по лоту покупки сделки " + Deal.DealCode );     
      return;
   end;

   /* ВР. Тема Айса 229913. */
   var ПараметрыПая;
   if(fin.AvoirKind == AVOIRISSKIND_INVESTMENT_SHARE)
      ПараметрыПая = RSDRecordSet("SELECT t_formvaluefiid FROM davrinvst_dbt WHERE t_fiid = " + fin.FIID);
      if(ПараметрыПая.MoveNext())
         fin.FaceValueFI = ПараметрыПая.Value(0);
      end;
   end;

   if ((fin.FaceValueFI == 0) and (dl_leg.CFI != 0))
      FD = SPFirstDoc (deal, IsBack);
      FD.ПолучитьДатыСделки( true, false );  
      if (FD.GetPayFIID () == 0)
         ConvDate = FD.DateArray[Date_DealBeginExec];
      end;
   end;

   if( not SmartConvertSum( CostInNominal, dl_leg.Cost, ConvDate, dl_leg.CFI, fin.FaceValueFI, false ) )
      _dbg( "!!! Ошибка при конвертации стоимости лота из валюты цены " + ПолучитьКодФинИн(dl_leg.CFI) + " в валюту номинала ", ПолучитьКодФинИн(fin.FaceValueFI) + ". Сделка " + Deal.DealCode );         
      return ;
   end;    
   
   if( not CostInNominal )
      CostInNominal = $0;
   end;

   return CostInNominal;
end;

private macro getISONominal(_FIID)      /* Найти код ISO для ФИ */
   private file fi(fininstr) key 0;
   var str = " ";
   
   fi.FIID = _FIID;
   if (GetEQ(fi))
           str = str + fi.CCy;
   end;
   return str;
end;

macro ПолучитьСуммуНДС(Perv_kol, amount, NDS_LOT)
   var _nds=$0;
   _nds =  money ((amount/Perv_kol)*NDS_LOT);
   return _nds;
end;

macro ПолучитьКодСделкиРЕПО( _lot, sumrec )
  var cmd, sql;

   if( (_lot.Parent > 0) AND (sumrec.state == 3) )
      cmd = RSDCommand(" SELECT T_DEALCODE FROM DPMWRTSUM_DBT WHERE t_SumID = ? ");
      cmd.addParam( "t_SumID", RSDBP_IN, _lot.Parent );
      cmd.execute();

      sql = TRsbDataSet(cmd);

      if( sql.MoveNext() )
         return sql.DealCode;
      end;
   end;
   return " ";
end;

private macro Add2TmpFile(lot, _Portf, _BuyKind, _Amount)     /* Добавить во временный файл */
   var CostInNominal, nds = 0, Price, Cost, cmd, err,_Corrinttoeir, BCost;
   var wrtcalc = TRecHandler( "pmwrtsum.dbt" );   /*для подсчета остатков*/
   var wrtsum = TRecHandler ("pmwrtsum.dbt");

   VAR DLSUM = trecHANDLER ("DLSUM.DBT");
   wrtcalc.Clear();
    
    
   cmd = RSDCommand(" INSERT INTO DLOTSREP_TMP  "
                    + " ( T_OWNER, " 
                    +   " T_ISBPP, "
                    +   " T_PORTF, " 
                    +   " T_BUYGOAL, "
                    +   " T_BUYKIND, "
                    +   " T_AMOUNT, " 
                    +   " T_DEALCODE, "
                    +   " T_DEALCODER, "
                    +   " T_DEALDATE, " 
                    +   " T_DATE, "
                    +   " T_PRICEPERC, "
                    +   " T_PRICE, " 
                    +   " T_COST, "
                    +   " T_COSTL, "
		    
		    
	
                    +   " T_BALANCECOST, " 
                    +   " T_NKD, "
                    +   " T_OUTLAY, "
                    +   " T_DISCOUNT, "
                    +   " T_INTEREST, "
                    +   " T_BEGBONUS, "
                    +   " T_BONUS, "
                    +   " T_NOTWRTBONUS, "

                  +   " T_COSTV, " 

                    +   " T_OVERAMOUNT, "
                    +   " T_COSTPFI, " // SD-1976169 
                    +   " T_SUMID, "

                    +   " T_CORRINTTOEIR, " 
                    +   " T_RESERVAMOUNT, "   
                    +   " T_INCOMERESERV, "     
               /*     +   " T_CORRESTRESERVE, " */
                    +   " T_ESTRESERVE, "     


                    +   " T_NDS  )  VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?/*,?*/,?,?,?)"); 
   cmd.addParam( "T_OWNER", RSDBP_IN, lot.Party );
   wrtsum.Clear;
   if (RepParm.Date == {CurDate})
       if (ПолучитьЛотНаДату (lot.SumID, RepParm.Date, wrtsum))
         if (int(wrtsum.rec.state) == 3)
           if( Is_BPP )
              cmd.addParam( "T_ISBPP", RSDBP_IN, SET_CHAR);
           else
              return;
           end;
         else
            cmd.addParam( "T_ISBPP", RSDBP_IN, UNSET_CHAR);
         end;
       end;

   else
      if (ПолучитьЛотНаДату (lot.SumID, RepParm.Date+1, wrtsum))
         if (int(wrtsum.rec.state) == 3)
           if( Is_BPP )
              cmd.addParam( "T_ISBPP", RSDBP_IN, SET_CHAR);
           else
              return;
           end;
         else
            cmd.addParam( "T_ISBPP", RSDBP_IN, UNSET_CHAR);
         end;
      end;
   end;
   cmd.addParam( "T_PORTF", RSDBP_IN, /*_Portf*/wrtsum.rec.portfolio );/*PNV 380156*/
   cmd.addParam( "T_BUYGOAL", RSDBP_IN, 0 );
   cmd.addParam( "T_BUYKIND", RSDBP_IN, _BuyKind );
   cmd.addParam( "T_AMOUNT", RSDBP_IN, _Amount );
   cmd.addParam( "T_DEALCODE", RSDBP_IN, dl_tick.rec.DealCode );
   cmd.addParam( "T_DEALCODER", RSDBP_IN, ПолучитьКодСделкиРЕПО( lot, wrtsum.rec ) );
   cmd.addParam( "T_DEALDATE", RSDBP_IN, dl_tick.rec.DealDate );
   cmd.addParam( "T_DATE", RSDBP_IN, lot.Date );

   CostInNominal = getCostInNominalFI(lot);
   Price = dd(CostInNominal)/dd(dl_leg.Principal);
   
   if (FI_IsBond(avr.FIID))        /* Для облигаций заполняются дополнительные поля */
   //    cmd.addParam( "T_NKD", RSDBP_IN, wrtcalc.rec.NKDAmount );
      /* Цена в процентах от номинала */
      if (dl_leg.RelativePrice != "")
         cmd.addParam( "T_PRICEPERC", RSDBP_IN, dl_leg.Price );
      else
         cmd.addParam( "T_PRICEPERC", RSDBP_IN, (Price)*100/fin.FaceValue );
      end;
   else
   //    cmd.addParam( "T_NKD", RSDBP_IN, 0 );
      cmd.addParam( "T_PRICEPERC", RSDBP_IN, 0 );
   end;

   cmd.addParam( "T_PRICE", RSDBP_IN, Price );

   Cost = Price*_Amount;

   cmd.addParam( "T_COST", RSDBP_IN, Cost );

   if ( ПолучитьЛотНаДату(lot.SumID, RepParm.Date + 1, wrtcalc ) == false)

      MSGBOX ("Ошибка при подсчете балансовой стоимости лота!!! c id= ", lot.SumID, "    ", lot.fiid);
      cmd.addParam( "T_COSTL", RSDBP_IN, 0);

      cmd.addParam( "T_COSTV", RSDBP_IN, 0);
      cmd.addParam( "T_BALANCECOST", RSDBP_IN, 0 );
      cmd.addParam( "T_NKD", RSDBP_IN, 0 );
      cmd.addParam( "T_OUTLAY", RSDBP_IN, 0 );
      cmd.addParam( "T_DISCOUNT", RSDBP_IN, 0 );
      cmd.addParam( "T_INTEREST", RSDBP_IN, 0 );
      cmd.addParam( "T_BEGBONUS", RSDBP_IN, 0 );
      cmd.addParam( "T_BONUS", RSDBP_IN, 0 );
      cmd.addParam( "T_NOTWRTBONUS", RSDBP_IN, 0 );
      cmd.addParam( "T_OVERAMOUNT", RSDBP_IN, 0 );
      cmd.addParam( "T_COSTPFI", RSDBP_IN, 0 );


   else
      cmd.addParam( "T_COSTL", RSDBP_IN, wrtcalc.rec.Cost);
     
      /* ВР. */
      cmd.addParam( "T_BALANCECOST", RSDBP_IN, GetBalanceCost(wrtcalc.rec) );
      
      if (FI_IsBond(avr.FIID))
         cmd.addParam( "T_NKD", RSDBP_IN, wrtcalc.rec.nkdamount );
      else  
         cmd.addParam( "T_NKD", RSDBP_IN, 0 );
      end;
      cmd.addParam( "T_OUTLAY", RSDBP_IN, wrtcalc.rec.OutLay );
      cmd.addParam( "T_DISCOUNT", RSDBP_IN, wrtcalc.rec.DiscountIncome );
      cmd.addParam( "T_INTEREST", RSDBP_IN, wrtcalc.rec.InterestIncome );
      cmd.addParam( "T_BEGBONUS", RSDBP_IN, wrtcalc.rec.BegBonus );
      cmd.addParam( "T_BONUS", RSDBP_IN, wrtcalc.rec.Bonus );
      cmd.addParam( "T_NOTWRTBONUS", RSDBP_IN, (wrtcalc.rec.BegBonus-wrtcalc.rec.Bonus) );

  /***************************/                                                                        
       if (wrtcalc.rec.DiscountIncome == 0)                                                            
      	 cmd.addParam( "T_COSTV", RSDBP_IN, (wrtcalc.rec.Cost-(wrtcalc.rec.BegBonus-wrtcalc.rec.Bonus)));
       else                                                                                              
      	  cmd.addParam( "T_COSTV", RSDBP_IN, wrtcalc.rec.Cost);                                      
       end;                                                                                               
/***********************************/                                                                






      cmd.addParam( "T_OVERAMOUNT", RSDBP_IN, wrtcalc.rec.OverAmount );
      cmd.addParam( "T_COSTPFI", RSDBP_IN, wrtcalc.rec.CostPfi );

   end;

   if( FindDLSUM( LOT.DocKind, LOT.SumID, DLSUM_KIND_AGENT_ONCE, dl_tick.rec.CommDate, dlsum ) == 0)
       nds = ПолучитьСуммуНДС(dl_leg.principal, _amount, DLSUM.nds);
   end;
   cmd.addParam( "T_SUMID", RSDBP_IN, lot.SumID);



   cmd.addParam( " T_CORRINTTOEIR ",      RSDBP_IN, wrtcalc.rec.CORRINTTOEIR);
   cmd.addParam( " T_RESERVAMOUNT ",    RSDBP_IN, wrtcalc.rec.RESERVAMOUNT );
   cmd.addParam( " T_INCOMERESERV ",    RSDBP_IN, wrtcalc.rec.INCOMERESERV); 
   cmd.addParam( " T_ESTRESERVE ",      RSDBP_IN, wrtcalc.rec.ESTRESERVE);
  

   
   cmd.addParam( "T_NDS", RSDBP_IN, nds );
      if (not cmd.execute())
         _dbg("Ошибка записи во временный файл");      
      else
      end;
end;

private macro LoopLots(_Avoir, _Owner)  /* Перебор лотов покупки по выпуску и владельцу */
   var stat = false, count = 0, Portf, BuyKind, Amount;
   var lots = TBFile ("pmwrtsum","r",1);
   _dbg("\tLoopLots(", _Avoir, ", ",  _Owner, ")");
   if (_Owner == {OurBank})
      _Owner = -1;
   end;
   lots.Clear;
   lots.AddFilter (  "t_Party = " + String (_Owner) + " and " +
                     "t_FIID = " + String (_Avoir) + " and " +
                     "((t_Buy_Sale = " + String (PM_WRITEOFF_SUM_BUY) + ") or (" +
                     "t_Buy_Sale = " + String (3) + ")) and " +
                     "( (t_amount != 0) or ( t_ChangeDate > " + 
                     GetSQLDate(RepParm.Date) + ")" +
                     ")"
                   );     

   var cnt = NRecords(lots);
   if (cnt > 10)
      InitProgress(NRecords(lots), "Просмотр лотов", "Просмотр лотов"); /*мельтешит*/
   end;

   lots.Rewind;
   while(lots.next())
      if(CheckLot(lots.rec, Portf, BuyKind, Amount))  /* Проверить лот */
         Add2TmpFile(lots.rec, Portf, BuyKind, Amount); /* Добавить во временный файл */
      end;
      if (cnt > 10)
         UseProgress(count = count + 1);
      end;
   end;
   if (cnt > 10)
      RemProgress();
   end;
   lots.DropFilter;
end;

private macro RepByOwner(_Avoir, _Owner)
   _dbg("\tPartyID= ", _Owner);  
   ПолучитьСубъекта(_Owner, pty);  /* Заполнить структурку с информацией о субъекте */
   /* Просмотр лотов */
   LoopLots(_Avoir, _Owner);
end;

private macro LoopOwners(_Avoir)        /* Перебрать всех субъектов фондового дилинга */
   var stat = false, count = 0;
   
   InitProgress(NRecords(cli), "Просмотр клиентов фондового дилинга", "Просмотр клиентов фондового дилинга");
   cli.Clear;
   cli.AddFilter ("t_ServiceKind = " + String (PTSK_STOCKDL));
   cli.rewind;
   while(cli.next())
      if ({OurBank} == cli.rec.PartyID)
         RepByOwner(_Avoir, {ourBank});  /* Отчёт по клиенту */
      else
         RepByOwner(_Avoir, cli.rec.PartyID);        /* Отчёт по клиенту */
      end;
      UseProgress(count=count+1);
   end;
   RemProgress;
   cli.DropFilter;
end;

private macro PrintAvoirHeader()        /* Заголовок */
   var query_val = "Select t_ccy from dfininstr_dbt where t_fiid = " + string (fin.FaceValueFI);
   var data_val = TRsbDataSet(query_val);
   var Name_FI = "";
   if (Data_val.MoveNext())
      Name_FI = Data_Val.CCY;
   end;
   if (""==Trim(FirstSheetTitle))      /* Сменить название первой закладки */
      FirstSheetTitle = fin.FI_Code+" "+fin.Name;
   elif (manyAvoir)    /* Новые бумажки - новые закладки */
      Rep.AddNewSheetBreak(fin.FI_Code+" "+fin.Name);
   end;

   /* Установить валюту номинала */
   NominalFI_ISO = getISONominal(fin.FaceValueFI);

   /* Вывести код и название выпуска */            
   Rep.AddPrintCell("Дата: "+ RepParm.Date, TableWidth, 0, "l", REP_ELEM_STR);
   Rep.AddStr();
   Rep.AddPrintCell("Ценная бумага: "+fin.FI_Code+" "+fin.Name+" ("+avr.ISIN+")", TableWidth, 0, "l", REP_ELEM_STR);
   Rep.AddStr();

   Rep.AddPrintCell("Cправедливая стоимость: " + tss + " " + Name_FI + " за дату " + string(DateTSS), TableWidth, 0, "l", REP_ELEM_STR);
   Rep.AddStr(); 

    Rep.AddPrintCell("Текущий номинал: " + GetFaceValue(fin.FIID, DateTSS), TableWidth, 0, "l", REP_ELEM_STR);
    Rep.AddStr(); /*PDV*/                                                                                                                

   Rep.AddEmptyStr();
end;

private macro PrintAvoirHeaderXLS()        /* Заголовок */
   var query_val = "Select t_ccy from dfininstr_dbt where t_fiid = " + string (fin.FaceValueFI);
   var data_val = TRsbDataSet(query_val);
   var Name_FI = "";

   // DEF-89651 Имя листа уменьшено до кода, длина не должна превышать 31 символов.
   SHEET_NAME = fin.FI_Code;

   if (Data_val.MoveNext())
      Name_FI = Data_Val.CCY;
   end;

   /* Установить валюту номинала */
   NominalFI_ISO = getISONominal(fin.FaceValueFI);

   /* Вывести код и название выпуска */ 
   printEngine.SetValue_NameCell("hDate", RepParm.Date); // "Дата: "
   printEngine.SetValue_NameCell("hShare", fin.FI_Code+" "+fin.Name+" ("+avr.ISIN+")"); // "Ценная бумага: "
   printEngine.SetValue_NameCell("hPrice", tss + " " + Name_FI + " за дату " + string(DateTSS)); // "Cправедливая стоимость: "
   printEngine.SetValue_NameCell("hValue", GetFaceValue(fin.FIID, DateTSS)); // "Текущий номинал: "

   printEngine.CopyAllSheetInTotalBook (null, false, "$A$1:$AA$6", 0, SHEET_NAME); // templateHeader
end;

private macro printOwner(_Owner)        /* Пропечатать владельца */
   var Code;       

   ПолучитьСубъекта(_Owner, pty);
   Code = ПолучитьКодСубъекта(_Owner, 1);
   
   return Code + " " + pty.ShortName;
end;

private macro printPortf(_Portf, _IsBPP)        /* Пропечатать портфель */
   var str = "";
   if (KINDPORT_TRADE==_Portf)
      str = "ССПУ_ЦБ";
   elif (KINDPORT_SALE==_Portf)
      str = "СССД_ЦБ";
   elif (KINDPORT_BACK == _Portf)
      str = "ПВО";
   elif(KINDPORT_RETIRE == _Portf)
      str = "АС_ЦБ";
   elif (KINDPORT_CLIENT==_Portf)
      str = "Клиентский";
   end;

   if( _IsBPP )
      str = str + "(БПП)"
   end;

   return str;
end;

private macro printBuyKind(_a)
   var str = "";
   if (NORMAL_BUYS==_a)
      str = "Покупки";
   elif (BACK_REPO==_a)
      str = "Обратное РЕПО"
   end;
   return str;
end;

private macro PrintSubHeader(Owner,Portf,IsBPP,BuyKind)
   Rep.AddPrintCell("Владелец: "+printOwner(Owner), TableWidth, 0, "l", REP_ELEM_STR);
   Rep.AddStr();
   Rep.AddPrintCell("Портфель: "+printPortf(Portf, IsBPP), TableWidth, 0, "l", REP_ELEM_STR);
   Rep.AddStr();
   Rep.AddPrintCell("Вид: "+printBuyKind(BuyKind),TableWidth, 0, "l", REP_ELEM_STR);
   Rep.AddStr();
   Rep.AddEmptyStr();
   nFirstLine = Rep.GetNumLastStr();       /* Первая строка таблицы */
end;

private macro PrintSubHeaderXLS(Owner,Portf,IsBPP,BuyKind)
   printEngine.SetValue_NameCell("hOwner", printOwner(Owner)); // "Владелец: "
   printEngine.SetValue_NameCell("hPortf", printPortf(Portf, IsBPP)); // "Портфель: "
   printEngine.SetValue_NameCell("hKind", printBuyKind(BuyKind)); // "Вид: "

   printEngine.CopyAllSheetInTotalBook (null, false, "templateSubHeader", 0, SHEET_NAME);
end;

private macro printMoney(_a)    /* Напечатать денежное значение */
   return (_a + NominalFI_ISO);
end;

private macro DigitIsApp(Digit)
  if(Digit)
    if(IsApp)
      return string(Digit:a);
    else
      return string(Digit);
    end;
  else
    return "";
  end;
end;

private macro UpdateCell(_x, _y, _str: string)  /* Добавить в указанную ячейку строку _str */
   var val: string = "";
   
   if (Rep.GetCellValue(_x, _y, val)!=0)
      _dbg("GetCellValue: Err x="+_x+", y=", _y);  
      return;
   end;
   if (""!=Trim(string(val)))      /* К пустым ячейкам ничего не добавляется */
      val = string(val)+_str;
      if (Rep.SetCellValue(_x, _y, val)!=0)
         _dbg("SetCellValue: Err x="+_x+", y=", _y);      
         return;
      ELSE
         IF (REP.SetCellFormat(_x,_y,"r")!=0)
           _dbg("SetCellFormat: Err x="+_x+", y=", _y);          
            return;
         end;
      end;
   end;                          
end;

/*private macro printMoneyWithISO()
   var cur = nFirstLine;
   while(cur<nLastLine)
      /* Цена покупки в валюте номинала */
      UpdateCell(cur, 7, NominalFI_ISO);
      /* Покупная стоимость */
      UpdateCell(cur, 8, NominalFI_ISO);
      /* Балансовая стоимость */
      UpdateCell(cur, 9, NominalFI_ISO);
      /* НКД */
      UpdateCell(cur, 10, NominalFI_ISO);
      /*Дисконт*/
      UpdateCell(cur, 11, NominalFI_ISO);
      /*Процент*/
      UpdateCell(cur, 12, NominalFI_ISO);
      /* Начальная премия */        
      UpdateCell(cur, 14, NominalFI_ISO);
      /*Начисленная премия*/           
      UpdateCell(cur, 15, NominalFI_ISO);
      /*Несписанная премия*/           
      UpdateCell(cur, 16, NominalFI_ISO);
      /* Затраты (в рублях) */        
      UpdateCell(cur, 19, RUB_ISO);
      /*НДС*/           
      UpdateCell(cur, 20, RUB_ISO);

      cur = cur+1;    /* Перейти к следующей строке */
   end;
end;*/

/*Строка валюты PDV*/
private macro PrintLotV(Lotsrep)        /* Напечатать первый лот */
   Rep.AddPrintCell("");
   Rep.AddPrintCell("");
   Rep.AddPrintCell("");
   Rep.AddPrintCell("");
   Rep.AddPrintCell("");
   Rep.AddPrintCell("");

   if (FI_IsBond(avr.FIID))
      Rep.AddPrintCell("");
   else
      Rep.AddPrintCell("");
   end;
   Rep.AddFormatCell(DigitIsApp(NominalFI_ISO),"c");
   Rep.AddFormatCell(DigitIsApp(NominalFI_ISO),"c");
   Rep.AddFormatCell(DigitIsApp(NominalFI_ISO),"c");

   Rep.AddFormatCell(DigitIsApp(NominalFI_ISO),"c");

   Rep.AddFormatCell(DigitIsApp(NominalFI_ISO),"c");
   if (FI_IsBond(avr.FIID))                         
      Rep.AddFormatCell(DigitIsApp(NominalFI_ISO),"c");
   else
      Rep.AddPrintCell("");
   end;    
   Rep.AddFormatCell(DigitIsApp(NominalFI_ISO),"c");
   Rep.AddFormatCell(DigitIsApp(NominalFI_ISO),"c");
   Rep.AddFormatCell(DigitIsApp(NominalFI_ISO),"c");
   Rep.AddFormatCell(DigitIsApp(NominalFI_ISO),"c");
   Rep.AddFormatCell(DigitIsApp(NominalFI_ISO),"c");
   Rep.AddFormatCell(DigitIsApp(RUB_ISO),"c");
   Rep.AddFormatCell(DigitIsApp(NominalFI_ISO),"c");
   Rep.AddFormatCell(DigitIsApp(RUB_ISO),"c");

   Rep.AddFormatCell(DigitIsApp(RUB_ISO)   ,"c");
   Rep.AddFormatCell(DigitIsApp(RUB_ISO)  ,"c");
   Rep.AddFormatCell(DigitIsApp(RUB_ISO)   ,"c"); 
   Rep.AddFormatCell(DigitIsApp(RUB_ISO)     ,"c");
   Rep.AddFormatCell(DigitIsApp(RUB_ISO),"c");
   Rep.AddFormatCell("");

   Rep.AddStr();
end;

/*Строка валюты PDV*/
private macro PrintLotVXLS(Lotsrep)        /* Напечатать первый лот */

   csvFile.AddCell("");
   csvFile.AddCell("");
   csvFile.AddCell("");
   csvFile.AddCell("");
   csvFile.AddCell("");
   csvFile.AddCell("");

   if (FI_IsBond(avr.FIID))
      csvFile.AddCell("");
   else
      csvFile.AddCell("");
   end;
   csvFile.AddCell(DigitIsApp(NominalFI_ISO));
   csvFile.AddCell(DigitIsApp(NominalFI_ISO));
   csvFile.AddCell(DigitIsApp(NominalFI_ISO));

   csvFile.AddCell(DigitIsApp(NominalFI_ISO));

   csvFile.AddCell(DigitIsApp(NominalFI_ISO));
   if (FI_IsBond(avr.FIID))                         
      csvFile.AddCell(DigitIsApp(NominalFI_ISO));
   else
      csvFile.AddCell("");
   end;    
   csvFile.AddCell(DigitIsApp(NominalFI_ISO));
   csvFile.AddCell(DigitIsApp(NominalFI_ISO));
   csvFile.AddCell(DigitIsApp(NominalFI_ISO));
   csvFile.AddCell(DigitIsApp(NominalFI_ISO));
   csvFile.AddCell(DigitIsApp(NominalFI_ISO));
   csvFile.AddCell(DigitIsApp(RUB_ISO));
   csvFile.AddCell(DigitIsApp(NominalFI_ISO));
   csvFile.AddCell(DigitIsApp(RUB_ISO));

   csvFile.AddCell(DigitIsApp(RUB_ISO));
   csvFile.AddCell(DigitIsApp(RUB_ISO));
   csvFile.AddCell(DigitIsApp(RUB_ISO)); 
   csvFile.AddCell(DigitIsApp(RUB_ISO));
   csvFile.AddCell(DigitIsApp(RUB_ISO));
   csvFile.AddCell("");

   csvFile.AddRow();
end;

/*Строка валюты*/
private macro PrintLot(Lotsrep)        /* Напечатать первый лот */                                             
   Rep.AddPrintCell(Lotsrep.DealCode);                                                                         
   Rep.AddPrintCell(SQL_ConvTypeDate(Lotsrep.DealDate),0,0,"c");                                               
   Rep.AddPrintCell(Lotsrep.DealCodeR);                                                                        
   Rep.AddPrintCell(SQL_ConvTypeDate(Lotsrep.Date),0,0,"c");                                                   
/*                                                                                                             
   Rep.AddFormatCell(DigitIsApp(int(Lotsrep.Amount)),"r");        /* Нужно округление до целых */              
  ВР. Тема Айса 214429.                                                                                        
*/                                                                                                             
   Rep.AddFormatCell(DigitIsApp(Lotsrep.Amount),"r");                                                          
                                                                                                               
   Rep.AddPrintCell("");                                                                                       
                                                                                                               
   if (FI_IsBond(avr.FIID))                                                                                    
      Rep.AddFormatCell(DigitIsApp(Lotsrep.PricePerc),"r");                                                    
   else                                                                                                        
      Rep.AddPrintCell("");                                                                                    
   end;                                                                                                        
   Rep.AddFormatCell(DigitIsApp(Lotsrep.Price),"r");                                                           
   Rep.AddFormatCell(DigitIsApp(Lotsrep.Cost),"r");                                                            
   Rep.AddFormatCell(DigitIsApp(Lotsrep.CostL),"r");                                                           
                                                                                                               
   Rep.AddFormatCell(DigitIsApp(Lotsrep.CostV),"r");                                                           
                                                                                                               
   Rep.AddFormatCell(DigitIsApp(Lotsrep.BalanceCost),"r");                                                     
   if (FI_IsBond(avr.FIID))                                                                                    
      Rep.AddFormatCell(DigitIsApp(Lotsrep.NKD),"r");                                                          
   else                                                                                                        
      Rep.AddPrintCell("");                                                                                    
   end;                                                                                                        
   Rep.AddFormatCell(DigitIsApp(Lotsrep.Discount),"r");                                                        
   Rep.AddFormatCell(DigitIsApp(Lotsrep.Interest),"r");                                                        
   Rep.AddFormatCell(DigitIsApp(Lotsrep.BegBonus),"r");                                                        
   Rep.AddFormatCell(DigitIsApp(Lotsrep.Bonus),"r");                                                           
   Rep.AddFormatCell(DigitIsApp(Lotsrep.NotWrtBonus),"r");                                                     
   Rep.AddFormatCell(DigitIsApp(Lotsrep.OverAmount),"r");                                                      
   Rep.AddFormatCell(DigitIsApp(Lotsrep.COSTPFI),"r");                                                         
   Rep.AddFormatCell(DigitIsApp(Lotsrep.Outlay),"r");                                                          
                                                                                                               
   Rep.AddFormatCell(DigitIsApp(Lotsrep.CORRINTTOEIR)   ,"r");                                                 
   Rep.AddFormatCell(DigitIsApp(Lotsrep.RESERVAMOUNT)   ,"r");                                                 
   Rep.AddFormatCell(DigitIsApp(Lotsrep.INCOMERESERV)   ,"r");                                                 
 /*  Rep.AddFormatCell(DigitIsApp(Lotsrep.CORRESTRESERVE) ,"r");*/                                             
   Rep.AddFormatCell(DigitIsApp(Lotsrep.ESTRESERVE)     ,"r");                                                 
                                                                                                               
                                                                                                               
                                                                                                               
/* Rep.AddPrintCell((tmp.rec.nds), "r");*/                                                                     
   Rep.AddFormatCell(DigitIsApp(Lotsrep.nds),"r");                                                             
   Rep.AddFormatCell(DigitIsApp(Lotsrep.SUMID),"r");                                                           
                                                                                                               
   Rep.AddStr();                                                                                               
end;

/*Строка валюты*/
private macro PrintLotXLS(Lotsrep)        /* Напечатать первый лот */                                             
   csvFile.AddCell(Lotsrep.DealCode);                                                                         
   csvFile.AddCell(SQL_ConvTypeDate(Lotsrep.DealDate));                                               
   csvFile.AddCell(Lotsrep.DealCodeR);                                                                        
   csvFile.AddCell(SQL_ConvTypeDate(Lotsrep.Date));                                                   
   csvFile.AddCell(DigitIsApp(Lotsrep.Amount));                                                          
   csvFile.AddCell("");                                                                                       
                                                                                                               
   if (FI_IsBond(avr.FIID))                                                                                    
      csvFile.AddCell(DigitIsApp(Lotsrep.PricePerc));                                                    
   else                                                                                                        
      csvFile.AddCell("");                                                                                    
   end;                                                                                                        

   csvFile.AddCell(DigitIsApp(Lotsrep.Price));                                                           
   csvFile.AddCell(DigitIsApp(Lotsrep.Cost));                                                            
   csvFile.AddCell(DigitIsApp(Lotsrep.CostL));                                                           
   csvFile.AddCell(DigitIsApp(Lotsrep.CostV));                                                           
   csvFile.AddCell(DigitIsApp(Lotsrep.BalanceCost));                                                     

   if (FI_IsBond(avr.FIID))                                                                                    
      csvFile.AddCell(DigitIsApp(Lotsrep.NKD));                                                          
   else                                                                                                        
      csvFile.AddCell("");                                                                                    
   end;

   csvFile.AddCell(DigitIsApp(Lotsrep.Discount));                                                        
   csvFile.AddCell(DigitIsApp(Lotsrep.Interest));                                                        
   csvFile.AddCell(DigitIsApp(Lotsrep.BegBonus));                                                        
   csvFile.AddCell(DigitIsApp(Lotsrep.Bonus));                                                           
   csvFile.AddCell(DigitIsApp(Lotsrep.NotWrtBonus));                                                     
   csvFile.AddCell(DigitIsApp(Lotsrep.OverAmount));                                                      
   csvFile.AddCell(DigitIsApp(Lotsrep.COSTPFI));                                                         
   csvFile.AddCell(DigitIsApp(Lotsrep.Outlay));                                                          
   csvFile.AddCell(DigitIsApp(Lotsrep.CORRINTTOEIR)   );                                                 
   csvFile.AddCell(DigitIsApp(Lotsrep.RESERVAMOUNT)   );                                                 
   csvFile.AddCell(DigitIsApp(Lotsrep.INCOMERESERV)   );                                                 
   csvFile.AddCell(DigitIsApp(Lotsrep.ESTRESERVE)     );                                                 
   csvFile.AddCell(DigitIsApp(Lotsrep.nds));                                                             
   csvFile.AddCell(DigitIsApp(Lotsrep.SUMID));                                                           
                                                                                                               
   csvFile.AddRow();                                                                                              
end;

private macro PrintSubTotals(_Amount, _Cost,_costL,_costV, _BalanceCost, _NKD, _Discount, _Interest, _BegBonus, _Bonus, _NotWrtBonus, _OverAmount,_CostPfi, _Outlay, _nds,_CORRINTTOEIR,_RESERVAMOUNT,_INCOMERESERV,_ESTRESERVE)
   var persent = "";                                                                                                                                          
   if ((AllAmount != 0) and (AllAmount != NULL))
      persent = _Amount/AllAmount;
     /*  if (persent < 5)
          persent = "";
       end;*/
   end;

   Rep.AddPrintCell("");
   Rep.AddPrintCell("");
   Rep.AddPrintCell("");
   Rep.AddFormatCell("Итого:", "r");
/*
   Rep.AddFormatCell(DigitIsApp(int(_Amount)),"r");
  ВР. Тема Айса 214429.
*/
   Rep.AddFormatCell(DigitIsApp(_Amount),"r");

   Rep.AddFormatCell(String(persent),"r");
   
   if (FI_IsBond(avr.FIID))
      Rep.AddPrintCell("");
   else
      Rep.AddPrintCell("");
   end;
   Rep.AddPrintCell("");

   Rep.AddFormatCell(DigitIsApp(_Cost),"r");
   Rep.AddFormatCell(DigitIsApp(_CostL),"r");
   Rep.AddFormatCell(DigitIsApp(_CostV),"r");
   Rep.AddFormatCell(DigitIsApp(_BalanceCost),"r");
   if (FI_IsBond(avr.FIID))
      Rep.AddformatCell(DigitIsApp(_NKD),"r");
   else
      Rep.AddPrintCell("");
   end;
   Rep.AddFormatCell(DigitIsApp(_Discount),"r");
   Rep.AddFormatCell(DigitIsApp(_Interest),"r");
   Rep.AddPrintCell(DigitIsApp(_BegBonus),"r");
   Rep.AddPrintCell(DigitIsApp(_Bonus),"r");
   Rep.AddPrintCell(DigitIsApp(_NotWrtBonus),"r");
   Rep.AddFormatCell(DigitIsApp(_OverAmount),"r");
   Rep.AddFormatCell(DigitIsApp(_CostPFI),"r");
   Rep.AddFormatCell(DigitIsApp(_OutLay),"r");

   Rep.AddFormatCell(DigitIsApp (_CORRINTTOEIR ),"r");                   
   Rep.AddFormatCell(DigitIsApp   (_RESERVAMOUNT ),"r");                   
   Rep.AddFormatCell(DigitIsApp   (_INCOMERESERV ),"r");                  
  /* Rep.AddFormatCell(DigitIsApp(_CORRESTRESERVE),"r"); */            
   Rep.AddFormatCell(DigitIsApp(_ESTRESERVE),"r");                     
   

   Rep.AddPrintCell(DigitIsApp(_nds), "r");
   Rep.AddPrintCell("");
   Rep.AddStr();
   nLastLine = Rep.GetNumLastStr();        /* Последнаяя строка таблицы */
   Rep.AddEmptyStr();

   ZNDS = ZNDS + _nds;
   ZOUT = ZOUT + _OutLay;
  /* Z1OUT = Z1OUT + _CORRINTTOEIR;
   Z2OUT = Z2OUT +   _RESERVAMOUNT;
   Z3OUT = Z3OUT +   _INCOMERESERV;
   Z4OUT = Z4OUT +   _ESTRESERVE;    */



end;

private macro PrintSubTotalsXLS(_Amount, _Cost,_costL,_costV, _BalanceCost, _NKD, _Discount, _Interest, _BegBonus, _Bonus, _NotWrtBonus, _OverAmount,_CostPfi, _Outlay, _nds,_CORRINTTOEIR,_RESERVAMOUNT,_INCOMERESERV,_ESTRESERVE)
   var persent = "";

   if ((AllAmount != 0) and (AllAmount != NULL))
      persent = _Amount/AllAmount;
   end;

   csvFile.AddCell("");
   csvFile.AddCell("");
   csvFile.AddCell("");
   csvFile.AddCell("Итого:");
   csvFile.AddCell(DigitIsApp(_Amount));
   csvFile.AddCell(String(persent));
   
   if (FI_IsBond(avr.FIID))
      csvFile.AddCell("");
   else
      csvFile.AddCell("");
   end;

   csvFile.AddCell("");
   csvFile.AddCell(DigitIsApp(_Cost));
   csvFile.AddCell(DigitIsApp(_CostL));
   csvFile.AddCell(DigitIsApp(_CostV));
   csvFile.AddCell(DigitIsApp(_BalanceCost));

   if (FI_IsBond(avr.FIID))
      csvFile.AddCell(DigitIsApp(_NKD));
   else
      csvFile.AddCell("");
   end;

   csvFile.AddCell(DigitIsApp(_Discount));
   csvFile.AddCell(DigitIsApp(_Interest));
   csvFile.AddCell(DigitIsApp(_BegBonus));
   csvFile.AddCell(DigitIsApp(_Bonus));
   csvFile.AddCell(DigitIsApp(_NotWrtBonus));
   csvFile.AddCell(DigitIsApp(_OverAmount));
   csvFile.AddCell(DigitIsApp(_CostPFI));
   csvFile.AddCell(DigitIsApp(_OutLay));
   csvFile.AddCell(DigitIsApp (_CORRINTTOEIR ));                   
   csvFile.AddCell(DigitIsApp   (_RESERVAMOUNT ));                   
   csvFile.AddCell(DigitIsApp   (_INCOMERESERV ));                  
   csvFile.AddCell(DigitIsApp(_ESTRESERVE));                     
   csvFile.AddCell(DigitIsApp(_nds), "r");
   csvFile.AddCell("");

   csvFile.AddRow();
   
   Rep.AddEmptyStr(); //TODO

   ZNDS = ZNDS + _nds;
   ZOUT = ZOUT + _OutLay;
end;

private macro PrintAvoirReport()        /* Тело отчёта */
   var Itog_Amount = 0,Itog_Cost = $0,Itog_CostL = $0,Itog_CostV = $0,Itog_BalanceCost=$0,Itog_NKD =$0, Itog_Outlay =$0,Itog_nds =$0,
       Itog_Discount = $0, Itog_Interest = $0, Itog_OverAmount = $0, Itog_BegBonus= $0, Itog_Bonus= $0, Itog_NotWrtBonus= $0, Itog_CostPfi = $0, Itog_CORRINTTOEIR = $0,Itog_RESERVAMOUNT = $0,Itog_INCOMERESERV = $0,Itog_ESTRESERVE  = $0,
       Owner, Portf, BuyKind, IsBPP, cmd, Lotsrep; /* текущие значения */                                                                        
                                                                                                                                                 
   cmd = RSDCommand("select * from DLOTSREP_TMP order by T_OWNER, T_ISBPP, T_PORTF, T_BUYGOAL, T_BUYKIND, T_DATE, T_DEALCODE");                  
   cmd.Execute();
   Lotsrep = TRsbDataSet(cmd);

   if (Lotsrep.movenext)
   
      Owner = Lotsrep.Owner;
      Portf = Lotsrep.Portf;
      IsBPP = (Lotsrep.IsBPP == SET_CHAR);
      BuyKind = Lotsrep.BuyKind;
      PrintSubHeader(Owner,Portf,IsBPP,BuyKind);       /* Вывести владельца, портфель, цель приобретения и вид покупки */
PrintLotV(Lotsrep);	
      PrintLot(Lotsrep);     /* Напечатать первый лот */
      Itog_Amount = Itog_Amount + Lotsrep.Amount;
      Itog_Cost = Itog_Cost + Lotsrep.Cost;
      Itog_CostL = Itog_CostL + Lotsrep.CostL;
	Itog_CostV = Itog_CostV + Lotsrep.CostV;
       
      Itog_BalanceCost = Itog_BalanceCost + Lotsrep.BalanceCost;
      Itog_NKD = Itog_NKD + Lotsrep.NKD;
      Itog_Outlay = Itog_Outlay + Lotsrep.Outlay;
      Itog_nds = Itog_nds + Lotsrep.nds;
      Itog_Discount = Itog_Discount + Lotsrep.Discount;
      Itog_Interest = Itog_Interest + Lotsrep.Interest;
      Itog_BegBonus = Itog_BegBonus + Lotsrep.BegBonus;
      Itog_Bonus    = Itog_Bonus + Lotsrep.Bonus;
      Itog_NotWrtBonus = Itog_NotWrtBonus + Lotsrep.NotWrtBonus;
      Itog_OverAmount = Itog_OverAmount + Lotsrep.OverAmount;
      Itog_CostPfi = Itog_CostPfi + Lotsrep.CostPfi;
      
       Itog_CORRINTTOEIR = Itog_CORRINTTOEIR + Lotsrep.CORRINTTOEIR;         
       Itog_RESERVAMOUNT = Itog_RESERVAMOUNT + Lotsrep.RESERVAMOUNT; 
       Itog_INCOMERESERV = Itog_INCOMERESERV + Lotsrep.INCOMERESERV;    
       Itog_ESTRESERVE   = Itog_ESTRESERVE   + Lotsrep.ESTRESERVE; 
                                                                   
                                                                   
                                                                   
      while(Lotsrep.movenext)
         if ((Owner != Lotsrep.Owner) or (Portf != Lotsrep.Portf) or
             (BuyKind != Lotsrep.BuyKind) or (IsBPP != (Lotsrep.IsBPP == SET_CHAR))
            )
            Owner = Lotsrep.Owner;
            Portf = Lotsrep.Portf;
            BuyKind = Lotsrep.BuyKind;
            IsBPP = (Lotsrep.IsBPP == SET_CHAR);
            PrintSubTotals(Itog_Amount, Itog_Cost, Itog_costL,Itog_costV, Itog_BalanceCost, Itog_NKD, Itog_Discount, Itog_Interest, Itog_BegBonus, Itog_Bonus, Itog_NotWrtBonus, Itog_OverAmount, Itog_CostPfi, Itog_Outlay, Itog_nds,Itog_CORRINTTOEIR,Itog_RESERVAMOUNT,Itog_INCOMERESERV,Itog_ESTRESERVE);        /* Вывести итоги по столбцам */
            //PrintAvoirFooter();

            Itog_Amount = 0;
            Itog_Cost = $0;
            Itog_CostL = $0;
            Itog_CostV = $0;
            Itog_BalanceCost = $0;
            Itog_NKD = $0;
            Itog_Outlay = $0;
            Itog_nds = $0;
            Itog_Discount = $0;
            Itog_Interest = $0;
            Itog_BegBonus = $0;
            Itog_Bonus = $0;
            Itog_NotWrtBonus = $0;
            Itog_OverAmount = $0;

             Itog_CORRINTTOEIR = $0;
             Itog_RESERVAMOUNT = $0;
             Itog_INCOMERESERV = $0; 
             Itog_ESTRESERVE  = $0;
             
	
	    
            PrintSubHeader(Owner,Portf,IsBPP,BuyKind);       /* Вывести владельца, портфель, цель приобретения и вид покупки */
         end;
         PrintLot(Lotsrep);     /* Напечатать первый лот */             

         Itog_Amount = Itog_Amount + Lotsrep.Amount;
         Itog_Cost = Itog_Cost + Lotsrep.Cost;
         Itog_CostL = Itog_CostL + Lotsrep.CostL;
	Itog_CostV = Itog_CostV + Lotsrep.CostV;
         Itog_BalanceCost = Itog_BalanceCost + Lotsrep.BalanceCost;
         Itog_NKD = Itog_NKD + Lotsrep.NKD;
         Itog_Outlay = Itog_Outlay + Lotsrep.Outlay;
         Itog_nds = Itog_nds + Lotsrep.nds;
         Itog_Discount = Itog_Discount + Lotsrep.Discount;
         Itog_Interest = Itog_Interest + Lotsrep.Interest;
         Itog_BegBonus = Itog_BegBonus + Lotsrep.BegBonus;
         Itog_Bonus    = Itog_Bonus + Lotsrep.Bonus;
         Itog_NotWrtBonus = Itog_NotWrtBonus + Lotsrep.NotWrtBonus;
         Itog_CostPfi = Itog_CostPfi + Lotsrep.CostPfi;
         Itog_OverAmount = Itog_OverAmount + Lotsrep.OverAmount;
	   Itog_CORRINTTOEIR = Itog_CORRINTTOEIR + Lotsrep.CORRINTTOEIR;   
           Itog_RESERVAMOUNT = Itog_RESERVAMOUNT + Lotsrep.RESERVAMOUNT;   
           Itog_INCOMERESERV = Itog_INCOMERESERV + Lotsrep.INCOMERESERV;   
           Itog_ESTRESERVE   = Itog_ESTRESERVE   + Lotsrep.ESTRESERVE;     



      end;
      PrintSubTotals(Itog_Amount, Itog_Cost, Itog_CostL,Itog_CostV, Itog_BalanceCost, Itog_NKD, Itog_Discount, Itog_Interest, Itog_BegBonus, Itog_Bonus, Itog_NotWrtBonus, Itog_OverAmount, Itog_CostPfi, Itog_Outlay, Itog_nds,itog_CORRINTTOEIR,itog_RESERVAMOUNT,itog_INCOMERESERV,itog_ESTRESERVE);        /* Вывести итоги по столбцам для последней таблички */
      
      Itog_Amount = 0;
      Itog_Cost = $0;
      Itog_CostL = $0;
	Itog_CostV = $0;
      Itog_BalanceCost = $0;
      Itog_NKD = $0;
      Itog_Outlay = $0;
      Itog_nds = $0;
      Itog_CORRINTTOEIR = $0;  	
      Itog_RESERVAMOUNT = $0;  
      Itog_INCOMERESERV = $0;  
      Itog_ESTRESERVE  = $0;   



   end;

end;

private macro PrintAvoirReportXLS()        /* Тело отчёта */
   var Itog_Amount = 0,Itog_Cost = $0,Itog_CostL = $0,Itog_CostV = $0,Itog_BalanceCost=$0,Itog_NKD =$0, Itog_Outlay =$0,Itog_nds =$0,
       Itog_Discount = $0, Itog_Interest = $0, Itog_OverAmount = $0, Itog_BegBonus= $0, Itog_Bonus= $0, Itog_NotWrtBonus= $0, Itog_CostPfi = $0, Itog_CORRINTTOEIR = $0,Itog_RESERVAMOUNT = $0,Itog_INCOMERESERV = $0,Itog_ESTRESERVE  = $0,
       Owner, Portf, BuyKind, IsBPP, cmd, Lotsrep; /* текущие значения */                                                                        
                                                                                                                                                 
   cmd = RSDCommand("select * from DLOTSREP_TMP order by T_OWNER, T_ISBPP, T_PORTF, T_BUYGOAL, T_BUYKIND, T_DATE, T_DEALCODE");                  
   cmd.Execute();
   Lotsrep = TRsbDataSet(cmd);

   if (Lotsrep.movenext)

      csvFile = C_CSVFile();
      if (printEngine.UsePoi())
         csvFile.SetLimitRow(FLUSH_COUNT_XLSX);
      end;
      fName = csvFile.CreateFullFileName(CSV_NAME);
      csvFile.FileOpen(fName, true);

      csvTable = printEngine.RegisterTable("tableRow", "tableHeader", true);
   
      Owner = Lotsrep.Owner;
      Portf = Lotsrep.Portf;
      IsBPP = (Lotsrep.IsBPP == SET_CHAR);
      BuyKind = Lotsrep.BuyKind;

      PrintSubHeaderXLS(Owner,Portf,IsBPP,BuyKind);       /* Вывести владельца, портфель, цель приобретения и вид покупки */

      PrintLotVXLS(Lotsrep);	
      PrintLotXLS(Lotsrep);     /* Напечатать первый лот */

      Itog_Amount = Itog_Amount + Lotsrep.Amount;
      Itog_Cost = Itog_Cost + Lotsrep.Cost;
      Itog_CostL = Itog_CostL + Lotsrep.CostL;
	   Itog_CostV = Itog_CostV + Lotsrep.CostV;
      Itog_BalanceCost = Itog_BalanceCost + Lotsrep.BalanceCost;
      Itog_NKD = Itog_NKD + Lotsrep.NKD;
      Itog_Outlay = Itog_Outlay + Lotsrep.Outlay;
      Itog_nds = Itog_nds + Lotsrep.nds;
      Itog_Discount = Itog_Discount + Lotsrep.Discount;
      Itog_Interest = Itog_Interest + Lotsrep.Interest;
      Itog_BegBonus = Itog_BegBonus + Lotsrep.BegBonus;
      Itog_Bonus    = Itog_Bonus + Lotsrep.Bonus;
      Itog_NotWrtBonus = Itog_NotWrtBonus + Lotsrep.NotWrtBonus;
      Itog_OverAmount = Itog_OverAmount + Lotsrep.OverAmount;
      Itog_CostPfi = Itog_CostPfi + Lotsrep.CostPfi;
      
       Itog_CORRINTTOEIR = Itog_CORRINTTOEIR + Lotsrep.CORRINTTOEIR;         
       Itog_RESERVAMOUNT = Itog_RESERVAMOUNT + Lotsrep.RESERVAMOUNT; 
       Itog_INCOMERESERV = Itog_INCOMERESERV + Lotsrep.INCOMERESERV;    
       Itog_ESTRESERVE   = Itog_ESTRESERVE   + Lotsrep.ESTRESERVE; 
                                                                   
      while(Lotsrep.movenext)
         if ((Owner != Lotsrep.Owner) or (Portf != Lotsrep.Portf) or
             (BuyKind != Lotsrep.BuyKind) or (IsBPP != (Lotsrep.IsBPP == SET_CHAR))
            )
            Owner = Lotsrep.Owner;
            Portf = Lotsrep.Portf;
            BuyKind = Lotsrep.BuyKind;
            IsBPP = (Lotsrep.IsBPP == SET_CHAR);

            PrintSubTotalsXLS(Itog_Amount, Itog_Cost, Itog_costL,Itog_costV, Itog_BalanceCost, Itog_NKD, Itog_Discount, Itog_Interest, Itog_BegBonus, Itog_Bonus, Itog_NotWrtBonus, Itog_OverAmount, Itog_CostPfi, Itog_Outlay, Itog_nds,Itog_CORRINTTOEIR,Itog_RESERVAMOUNT,Itog_INCOMERESERV,Itog_ESTRESERVE);        /* Вывести итоги по столбцам */

            Itog_Amount = 0;
            Itog_Cost = $0;
            Itog_CostL = $0;
            Itog_CostV = $0;
            Itog_BalanceCost = $0;
            Itog_NKD = $0;
            Itog_Outlay = $0;
            Itog_nds = $0;
            Itog_Discount = $0;
            Itog_Interest = $0;
            Itog_BegBonus = $0;
            Itog_Bonus = $0;
            Itog_NotWrtBonus = $0;
            Itog_OverAmount = $0;

            Itog_CORRINTTOEIR = $0;
            Itog_RESERVAMOUNT = $0;
            Itog_INCOMERESERV = $0; 
            Itog_ESTRESERVE  = $0;
             
            PrintSubHeaderXLS(Owner,Portf,IsBPP,BuyKind);       /* Вывести владельца, портфель, цель приобретения и вид покупки */
         end;
         PrintLotXLS(Lotsrep);     /* Напечатать первый лот */             

         Itog_Amount = Itog_Amount + Lotsrep.Amount;
         Itog_Cost = Itog_Cost + Lotsrep.Cost;
         Itog_CostL = Itog_CostL + Lotsrep.CostL;
      	Itog_CostV = Itog_CostV + Lotsrep.CostV;
         Itog_BalanceCost = Itog_BalanceCost + Lotsrep.BalanceCost;
         Itog_NKD = Itog_NKD + Lotsrep.NKD;
         Itog_Outlay = Itog_Outlay + Lotsrep.Outlay;
         Itog_nds = Itog_nds + Lotsrep.nds;
         Itog_Discount = Itog_Discount + Lotsrep.Discount;
         Itog_Interest = Itog_Interest + Lotsrep.Interest;
         Itog_BegBonus = Itog_BegBonus + Lotsrep.BegBonus;
         Itog_Bonus    = Itog_Bonus + Lotsrep.Bonus;
         Itog_NotWrtBonus = Itog_NotWrtBonus + Lotsrep.NotWrtBonus;
         Itog_CostPfi = Itog_CostPfi + Lotsrep.CostPfi;
         Itog_OverAmount = Itog_OverAmount + Lotsrep.OverAmount;
	      Itog_CORRINTTOEIR = Itog_CORRINTTOEIR + Lotsrep.CORRINTTOEIR;   
         Itog_RESERVAMOUNT = Itog_RESERVAMOUNT + Lotsrep.RESERVAMOUNT;   
         Itog_INCOMERESERV = Itog_INCOMERESERV + Lotsrep.INCOMERESERV;   
         Itog_ESTRESERVE   = Itog_ESTRESERVE   + Lotsrep.ESTRESERVE;     
      end;

      PrintSubTotalsXLS(Itog_Amount, Itog_Cost, Itog_CostL,Itog_CostV, Itog_BalanceCost, Itog_NKD, Itog_Discount, Itog_Interest, Itog_BegBonus, Itog_Bonus, Itog_NotWrtBonus, Itog_OverAmount, Itog_CostPfi, Itog_Outlay, Itog_nds,itog_CORRINTTOEIR,itog_RESERVAMOUNT,itog_INCOMERESERV,itog_ESTRESERVE);        /* Вывести итоги по столбцам для последней таблички */
      
      Itog_Amount = 0;
      Itog_Cost = $0;
      Itog_CostL = $0;
	   Itog_CostV = $0;
      Itog_BalanceCost = $0;
      Itog_NKD = $0;
      Itog_Outlay = $0;
      Itog_nds = $0;
      Itog_CORRINTTOEIR = $0;  	
      Itog_RESERVAMOUNT = $0;  
      Itog_INCOMERESERV = $0;  
      Itog_ESTRESERVE  = $0;

      csvFile.FileClose();
      csvTable.FillTabelFromCSV(csvFile.GetlsFileName());
      csvTable.EndTable();

      printEngine.CopyAllSheetInTotalBook(null,         //Имя закладки,по умолчанию имя закладки из шаблона
                                       false, // true - на новый лист, false - на существующий(если имя листа отличается, всегда на новый лист)
                                       csvTable.GetTableRange(),     //Что копировать м.б. диапозон вида "A1:T60" или имя именованного диапозона
                                       0,
                                       SHEET_NAME) ;
   end;
end;


private macro PrintAvoirRep()
   var cmd, countrec = 0; 
   cmd = RSDCommand("select count(1) crec from DLOTSREP_TMP");
   cmd.Execute();
   countrec = TRsbDataSet(cmd);

   if (countrec.movenext)    /* Если нет записей - нечего и печатать */
        if( countrec.crec > 0 )
            if(ПечататьТекстовыйОтчет)
               PrintAvoirHeader();     /* Заголовок */
               PrintAvoirReport();     /* Тело отчёта */
            end;
            if(ПечататьОтчетВExcel)
               PrintAvoirHeaderXlS();     /* Заголовок */
               PrintAvoirReportXlS();     /* Тело отчёта */
            end;
          // PrintAvoirFooter();     /* Подвал */
        end;
   end;
end;

private macro ReportByAvoir(_Avoir)     /* Отчёт по выпуску */
   var SinceDate, erflag;    
   /* Пересоздать временный файл */
   private var avoir = TBfile ("avoiriss"), cmd;
   avoir.rec.FIID = _Avoir;
   if (avoir.GetEQ)
     AllAmount = avoir.rec.Qty;
   end;

   cmd = RSDCommand(" delete from DLOTSREP_TMP ");
   cmd.Execute();

  /* _dbg("FIID= ", _Avoir);    */

   TSS = GetRateOnDate( RepParm.Date, fin.fiid, fin.FaceValueFI, false, 12, erFlag, SinceDate);
   DateTSS = SinceDate;

   if (ALL_KIND==RepParm.Owner)
       LoopOwners(_Avoir);     /* Перебрать всех субъектов фондового дилинга */
   else
       RepByOwner(_Avoir, RepParm.Owner);
   end;
   PrintAvoirRep();    /* Печать данных по выпуску */
end;

private macro LoopAvoir()       /* Перебор выпусков */
   /* Собственно перебор */
   var count = 0;
   rewind(avr);
   
   manyAvoir = true;

   InitProgress(NRecords(avr), "Просмотр выпусков ценных бумаг", "Просмотр выпусков ценных бумаг");
   while(next(avr));
           fin.FIID = avr.FIID;
           GetEQ(fin);     /* Спозиционироваться в fininstr */
           ReportByAvoir(avr.FIID);
           UseProgress(count = count+1);
           //if (count == 2) break; end;
   end;
   RemProgress;
end;

private macro CreateReport      /* Начало формирования отчёта */

   Header =    "┌─────────────┬─────────────┬─────────────┬───────────────┬───────────────────┬──────────────┬────────────────────┬─────────────────┬────────────────────┬──────────────────────┬──────────────────────┬──────────────────────┬────────────────────┬────────────────────┬────────────────────┬────────────────────┬────────────────────┬────────────────────┬────────────────────┬────────────────────┬────────────────┬────────────────────┬────────────────────┬────────────────────┬────────────────────┬──────────────┬──────────────┐  \n"+
               "│Номер сделки │ Дата сделки │Номер сделки │ Дата поставки │ Количество в лоте │  % от объема │      Цена покупки  │ Цена покупки в  │ Покупная стоимость │   Стоимость лота     │   Сумма вложений     │ Балансовая стоимость │      НКД лота      │     Дисконтный     │     Процентный     │  Начальная премия  │  Начисленная премия│ Несписанная премия │    Переоценка      │    Переоценка      │ Затраты по лоту│ Сумма корректировки│  Сумма резерва по  │  Сумма резерва по  │ Сумма корректировки│      НДС     │    ИД ЛОТА   │  \n"+
               "│покупки лота │             │    РЕПО     │     лота      │                   │    выпуска   │    в % от номинала │ валюте номинала │  (цена*количество) │                      │                      │                      │                    │        доход       │        доход       │                    │                    │                    │                    │      ССПФИ         │                │        по ЭПС      │   вложениям в цб   │         ПДД        │ оценочного резерва │              │              │  \n"+
               "│             │             │             │               │                   │              │                    │                 │                    │                      │                      │                      │                    │                    │                    │                    │                    │                    │                    │                    │                │                    │                    │                    │                    │              │              │  \n"+
               "│             │             │             │               │                   │              │                    │                 │                    │                      │                      │                      │                    │                    │                    │                    │                    │                    │                    │                    │                │                    │                    │                    │                    │              │              │  \n"+
               "├─────────────┼─────────────┼─────────────┼───────────────┼───────────────────┼──────────────┼────────────────────┼─────────────────┼────────────────────┼──────────────────────┼──────────────────────┼──────────────────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┼────────────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┼──────────────┼──────────────┤    ";           

   Rep = CMakeReport(Header);
   
   if(ПечататьОтчетВExcel)
      printEngine = CTemplateSXLSX( NULL );
      //printEngine=CTemplateXLS(NULL, NULL, NULL, NULL, NULL, NULL, true, true);

      if(printEngine.UsePoi())
         printEngine.SetXLSXFormat();
      end;

      printEngine.CreateTotalBook();

      printEngine.OpenTemplate(TEMPL_NAME, true);
   
      printEngine.SheetChange(0);

      csvTable = printEngine.RegisterTable("tableRow", "tableHeader", true);
   end;
    
   if (ALL_KIND == RepParm.Avoir)
       LoopAvoir();    /* Перебор выпусков */
   else
       ReportByAvoir(RepParm.Avoir);
   end;
   
   //if (rep.isDataExist)
      if(ПечататьТекстовыйОтчет)
         Rep.PrintRep();
      end;
                          
        /* Проверим, нужна ли печать отчета в Excel */
      if(ПечататьОтчетВExcel)
         printEngine.Close();
         printEngine.SaveTotalBook(FILE_REPORT);
      end;                  
   //end;
end;

macro RunReport()       /* Выпустить отчёт */
  var sql,sql1,cmd;

  /* в случае изменения структуры таблиц, в апгрейдере необходимо добавить строчку удаления таблицы */
  /* данные в таблице хранятся в разрезе депонентов и места хранения, т.е. так, как нужно выводить в отчет */
   RepForm = LotsRep_Panel();
   if ( RepForm.Run())
      RepParm = RepForm.Params;
      CreateReport;   /* Сформировать отчёт */
      msgbox("Отчет сформирован !");
   end;

end;

RunReport();
