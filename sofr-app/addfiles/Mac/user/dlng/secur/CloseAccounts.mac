import RSD, globals;
import BankInter, dlquery, cb_sql, oralib, likepy;

const K_ENTER   = 13;
//const K_ESC     = 27;
const K_F3      = 317;
const K_F2      = 316;
const K_F8      = 322;
const K_F9      = 323;

private class CLog;
   private macro PrepareLog()
      if ( execSqlSelect ("select 1 from user_tables where upper(table_name) = upper('RSHB_CloseAccLog')").moveNext () )
        /*  if ( not execSql ("truncate table RSHB_CloseAccLog") )
              return false;
          end;*/
      else
          if ( not execSql ("create table RSHB_CloseAccLog (t_kind number not null, t_account varchar2(25),  t_text varchar2(4000), t_timestamp timestamp, t_oper number, t_operdate date) ") )
              return false;
          end;
      end;
      return true;
   end;

   Macro add ( kind, account, text )
       execSql ("insert into RSHB_CloseAccLog values (:1, :2, :3, systimestamp, :4, :5)", makeArray (sqlParam ("1", kind), sqlParam ("2", account), sqlParam ("3", text),sqlParam ("4", {oper}),sqlParam ("5", {curdate})));
   End;

   if (not PrepareLog() );
      msgbox("Ошибка инициализации логирования");
      exit(1);
   end;
end;


private  macro closeAcc( acc, chapter, currency, CloseDate, ErrMsg)
   var stat, mes;
   var IsError = false;

   if( (stat=CB_CloseAccount(chapter, currency, acc, CloseDate , mes)) != 0 )
      if (strlen(mes) == 0)
         InitError();
         MemoryError(stat);
         mes = GetErrMsg();
      end;
      IsError = true;
   end;
   SetParm(4, mes);
   return not IsError;

   onError(er)
     SetParm(4, er.message);
     return not IsError;
end;



PRIVATE MACRO AddCol (ar, fld, head, width, rdonly, ty, dp)
   var ind = ar.size;
   if (ind > 0) ind = ar.size / 6 ; end;
   ar.value (ind * 6)     = fld;
   ar.value (ind * 6 + 1) = head;
   ar.value (ind * 6 + 2) = width;
   ar.value (ind * 6 + 3 ) = 2;//rdonly;   // fldType
   ar.value (ind * 6 + 4 ) = dp;//   decPoint
   ar.value (ind * 6 + 5 ) = 0;   // reserv
END;

macro Scroll
   var sql, cmd1, rs1, col1, need = true,Column = TArray(),i, ColumnValue, ColumnName, NumColumns = 0, cond = "";

   var ErrAr = TArray(), inprocess, inprocessprogress, SaveNum = 0, Log = CLog();

   macro EvProc(rs, cmd, id, key)
     var  CM_DEFAULT = null, err;
     
//msgbox(key);
      if (cmd == DLG_INIT)
         /*Позиционируемся*/
         if(SaveNum > 0)
           while(rs.movenext)
             if(SaveNum == rs.value("rownum"))
               GoToScroll(rs);
               break;
             end;
           end;
         end;

          AddMultiAction(rs, 322/*F8*/);
      elif(cmd == DLG_MSELSTART)
         if(key == 322)
           if(msgboxex("Закрыть выделенные счета?", MB_YES + MB_NO, IND_YES) == IND_YES)
             inprocess = true;
             inprocessprogress = 0;
             InitProgress(int(GetMultiCount()), "Ждите...", "Закрытие счетов");
             ErrAr = TArray();
           end;
         end;
      elif(cmd == DLG_MSELEND)
        if(key == 322)
          if(inprocess)
            inprocess = false;
            RemProgress();
            msgboxex("Закрытие счетов завершено");
            if (ErrAr.size > 0)
               var i = 0;
               var ItogSQl = "select '"+ErrAr(i)+"' account, '"+ErrAr(i+1)+"' error from dual";
               i = i + 2;
               while (i < ErrAr.size )
                  ItogSQl = ItogSQl + " union all select  '"+ErrAr(i)+"', '"+ErrAr(i+1)+"' from dual";
                  i = i + 2;
               end;
               var ItogCMD = RsdRecordSet(ItogSQL, null, RSDVAL_STATIC );
               RunScroll(ItogCMD);
               updatescroll(rs, 5);
               return CM_CANCEL;
            end;
          end;
        end;
      elif(cmd == DLG_MSEL)
        if(key == 322)
           if ( not CloseAcc (rs.Value("t_account"), rs.Value("t_chapter"), rs.Value("t_code_currency"), SQL_ConvTypeDate(rs.Value("t_dateclose")),err) )
               ErrAr(ErrAr.Size) = rs.Value("t_account");
               ErrAr(ErrAr.Size) = err;
               Log.add(1, rs.Value("t_account"), err);
           else
               Log.add(0, rs.Value("t_account"), "Закрыт");
           end;
           UseProgress(inprocessprogress = inprocessprogress + 1);
           updatescroll(rs, 5);
           return CM_MSEL_CONT_CLEAR;
        end;
      elif ((cmd == DLG_KEY)and(key == K_F8)/* and ({oper} == 1)*/)
         if (ValType(rs.Value("t_account")) != 26)
            if (msgboxex("Закрыть счет?", MB_YES + MB_NO, IND_YES) == IND_YES)
               if ( not CloseAcc (rs.Value("t_account"), rs.Value("t_chapter"), rs.Value("t_code_currency"), SQL_ConvTypeDate(rs.Value("t_dateclose")),err) )
                 Log.add(1, rs.Value("t_account"), err);
                 msgbox(err);
               else
                 Log.add(0, rs.Value("t_account"), "Закрыт");
                 msgbox("Закрыт " + rs.Value("t_account"));
               end;
      //         updatescroll(rs, 5);
               SaveNum = rs.value("rownum");
               return CM_SELECT;
            end;
         end;
         return CM_IGNORE;
      elif ((cmd == DLG_KEY)and(key == 18))
            SaveNum = rs.value("rownum");
            return CM_SELECT;

            //updatescroll(rs, 5);
            //updatefields;
      elif ((cmd == DLG_KEY)and(key == K_ESC))
         return 2;
      end;

     return CM_DEFAULT;
   end;

   col1 = TArray;   

   AddCol (col1, "kind",        "Вид",   4 ,  2, -1);
   AddCol (col1, "T_account",        "Счет",   18 ,  2, -1);
   AddCol (col1,  "T_ccy",        "Валюта",    10,  2, -1 );
   AddCol (col1,  "T_close_date",  "Дата закрытия счета",    8,  2, -1);
   AddCol (col1,  "T_number",     " Номер договора",    15, 2, -1);
   AddCol (col1,  "T_dateclose",  "Дата закрытия договора",    8,  2, -1);
   AddCol (col1,  "T_name",     " Клиент ",    25, -1);
   AddCol (col1, "rest",        "Остаток",   18 ,  2, 2);
   while (need)
      need = false;
      sql = 
   "select rownum,t.*, RSB_ACCOUNT.RESTALL(t.t_account, t.t_chapter, t.t_code_currency, "+GetSQLDate({curdate})+") rest  from ( " +
   "SELECT   " +
   "       a.t_open_close, " +
   "       a.t_close_date, " +
   "       (select t_ccy from dfininstr_dbt where t_fiid = a.t_code_currency) t_ccy, " +
   "       a.t_code_currency, " +
   "       sf.t_number, " +
   "       sf.t_dateclose, " +
   "       sf.t_name, " +
   "       s.t_account, " +
   "       s.t_chapter, " +
   "       decode(s.t_chapter,1,'БУ',21,'ВУ ДС',22,'ВУ ЦБ') kind " +
   "  FROM dsettacc_dbt s, " +
   "       dsfssi_dbt ss, " +
   "       dsfcontr_dbt sf, " +
   "       daccount_dbt a " +
   " WHERE     s.t_settaccid = ss.t_setaccid " +
   "       AND ss.t_objecttype = 659 " +
   "       AND ss.t_objectid = sf.t_id " +
   "       AND sf.t_dateclose <> TO_DATE ('01010001', 'ddmmyyyy') " +
   "       AND a.t_account = s.t_account " +
   "       AND a.t_chapter = s.t_chapter " +
   "       and instr(a.t_open_close,'З') =0 " +
   "union all " +
   "SELECT a.t_open_close,        " +
   "       a.t_close_date, " +
   "       (select decode(t_ccy,chr(1),t_definition, t_ccy) t_ccy from dfininstr_dbt where t_fiid = a.t_code_currency) t_ccy, " +
   "       a.t_code_currency, " +
   "       sf.t_number, " +
   "       sf.t_dateclose, " +
   "       sf.t_name, " +
   "       mc.t_account, " +
   "       mc.t_chapter, " +
   "       decode(a.t_chapter,1,'БУ',21,'ВУ ДС',22,'ВУ ЦБ') kind " +
   "  FROM dmcaccdoc_dbt mc, dsfcontr_dbt sf, daccount_dbt a " +
   " WHERE    " 
   "           mc.t_chapter in (21,22) " +
   "       AND mc.t_iscommon = CHR (88) " +
   "       AND sf.t_id = mc.t_clientcontrid " +
   "       AND a.t_account = mc.t_account " +
   "       AND a.t_chapter = mc.t_chapter " +
   "       AND sf.t_dateclose <> TO_DATE ('01010001', 'ddmmyyyy') " +
   "       AND INSTR (a.t_open_close, 'З') = 0 " +
   "union all " +
   "SELECT a.t_open_close,        " +
   "       a.t_close_date, " +
   "       (select t_ccy from dfininstr_dbt where t_fiid = a.t_code_currency) t_ccy, " +
   "       a.t_code_currency, " +
   "       sf.t_number, " +
   "       sf.t_dateclose, " +
   "       sf.t_name, " +
   "       mc.t_account, " +
   "       mc.t_chapter, " +
   "       decode(a.t_chapter,1,'БУ',21,'ВУ ДС',22,'ВУ ЦБ') kind " +
   "  FROM dmcaccdoc_dbt mc, dsfcontr_dbt sf, daccount_dbt a " +
   " WHERE     " 
   " t_catnum = 5087 " +
   "       AND mc.t_iscommon = CHR (88) " +
   "       AND sf.t_id = mc.t_clientcontrid " +
   "       AND a.t_account = mc.t_account " +
   "       AND a.t_chapter = mc.t_chapter "  +
   "       AND sf.t_dateclose <> TO_DATE ('01010001', 'ddmmyyyy') " +
   "       AND INSTR (a.t_open_close, 'З') = 0 ) t";
/*   if ({oper} != 1)
      sql = sql + " where t.t_chapter in (1) "
   end;*/
   sql = sql + "        order by t.t_dateclose" ;

 
      cmd1 = RSDCommand(sql);
      rs1 = RSDRecordset(cmd1 , null, RSDVAL_STATIC );
      while (RunScroll (rs1,col1.size/6, col1, "test" ,"EvProc"," Закрытие счетов "," F8 - закрыть счет   Ctrl+R - обновить список ", true, 1, 1))
        cmd1 = RSDCommand(sql);
        rs1 = RSDRecordset(cmd1 , null, RSDVAL_STATIC );
      end;
   end;

return null;

end;

Scroll;
exit(1);