
/*           !!!!Макрос тестовый (только для демонстрации)!!!
*/
import activex, oralib, likepy, BankInter, DVInter, globals, rsd,RsbDataSet, PTInter,CTInter,FIInter, "cb_sql.mac", oprinter;
import "u_common_email_utils.mac", "dlquery.mac";
import  "dvserv.mac";

private const COL_HEAD= 2, COL_DATA = 3, COL_FI_Head = "Серия облигаций",
              COL_BIO_SSPFI_Value   = 10,
              COL_DateSFBegin       = 3,
              COL_ClientCodeF       = 4,
              COL_Status            = 5,
              COL_DateBeginStatus   = 6,
              COL_DateReclassStatus = 7,
              COL_Notes             = 8;


var Series_head = "Серия облигаций"; // БО-01RIB-002Р
var Reg_Num_Head = "Регистрационный номер выпуска облигаций"; // выпуска облигаций 4В02-01-03349-В-002Р
var RegDate_Head = "Дата регистрации выпуска"; // 17.11.2020
var ISIN_Head = "ISIN" ;
var DateBegPlcmt_Head = "Дата начала размещения";// 23.12.2020
var DateEndPlcmnt_Head = "Дата окончания размещения";// 23.12.2020
Var Amount_Head = "Количество размещенных облигаций, штук";// 500000
var Price_head = "Номинальная стоимость 1 облигации";// 1000
var BondMaturity_Head = "Срок обращения облигаций, дней"; // 1095
var CloseDate_Head = "Дата погашения облигаций (плановая)";// 23.12.2023
//Дата погашения облигаций (фактическая) с учетом совпадения с выходным  днем 23.12.2023
var Discont_Head = "Дисконт, рублей";// 175
// Ставка фиксированного купона, % годовых 0,01
//Выплата фиксированного купона (указываются конкретные даты (плановые) выплаты каждого купона) 23.12.2021
// 23.12.2022
// 23.12.2023
//ПФИ (опцион) 
//Контрагент по ПФИ (опциону) АО Россельхозбанк
var Prem_Head = "Премия по ПФИ (опциону), рублей ";//  175
var IncomeRate_Head = "Ставка фиксированного купона, % годовых";
var Fiwrntsdrwdate_head = "Выплата фиксированного купона (указываются конкретные даты (плановые) выплаты каждого купона)";
var DatePrem_Head = "Дата отражения  премии по ПФИ (опциону) "; // 23.12.2020
var ExpDate_Head = "Срок экспирации (обращения) ПФИ (опциона)";// 18.12.2023
var DateRasch_Head = "Дата расчетов по ПФИ"; // 18.12.2023
var Active_Head = "Базовый актив"; // Золото
var Style_Head = "Стиль";// Европейский
var Kurs_Head = "Курс USDRUBнач, (указывается значение курса)"; // 76,53
var T_Head = "Требования по базовому активу, (количество базового актива, в соответствующих единицах), кг";// 2
var O_Head = "Обязательства по базовому активу, (сумма денежных средств в соответствующей валюте), $"; //122000


private const Print_WellDown = true;              

private const OPEN_DIR = "C:\\*.xls*",
              OPEN_DIALOG_HEADER = "Выберите файл для загрузки :";

private const PARTY_ATTR_GROUP_RISKCATEG = 95,
              
              COL_VALUEDATE = 3,
              COL_CPTY      = 6,
              COL_SS        = 16;



//Расположение загружаемого файла
var  reg_path, errcode;
 GetRegistryValue("РСХБ\\ДИРЕКТОРИИ\\БИО_ПФИ", V_STRING, reg_path, errcode );
  if ( errcode != 0 )
    reg_path = "";
  end; 
 reg_path = reg_path + "\\";

 var arch_path;
 GetRegistryValue("РСХБ\\ДИРЕКТОРИИ\\БИО_ПФИ_АРХИВ", V_STRING, arch_path, errcode );
  if ( errcode != 0 )
    arch_path = "";
  end; 
 arch_path = arch_path + "\\";
   
class fi_data()
  var Series;
  var Reg_Num;
  var RegDate;
  var ISIN;
  var DateBegPlcmt;
  var DateEndPlcmnt;
  Var Amount;
  var Price;
  var BondMaturity;
  var CloseDate;
  var Prem;
  var DatePrem;
  var ExpDate;
  var DateRasch;
  var Active;
  var Style;
  var Kurs;
  var T;
  var O;
  var incomerate;
  var fiwrntsdrwdate = TArray();
  var fiid;
  var Discont; 
end;


class FIFRVALDATA()
  var ISIN      : string;
  var LSIN      : string;
  var FRVAL     : money;
  var FRVALDATE : date;  
end;

private macro iif(a,b,c)
    if(a)
        return b;
    else
        return c;
    end;
end;

PRIVATE MACRO ПолучитьПоследнийКурсНаДатуТипа( p_RateDate:DATE, p_fiid:INTEGER, p_Type:INTEGER, p_OtherFi:@INTEGER ):bool
  VAR v_Data, v_Query, IsExistCurse = false;

  v_Query = RSDCommand(
             "SELECT t_rateid, t_fiid "+
             "  FROM (SELECT t_rateid, t_fiid "+
             "            FROM (SELECT rate.t_rateid, rate.t_sincedate, rate.t_type, rate.t_fiid, rate.T_ISRELATIVE, rate.t_otherfi "+
             "                    FROM dratedef_dbt rate "+
             "                   WHERE rate.t_otherfi = ? "+ /*string(Fiid_from) */
             "                     AND t_sincedate    = (SELECT MAX (t_sincedate) "+
             "                                             FROM dratedef_dbt "+
             "                                            WHERE     t_otherfi = rate.t_otherfi "+
             "                                                  AND t_type    = rate.t_type  "+
             "                                                  AND t_sincedate <= ? "+ /*RateDate*/
             "                                          ) "+
             "                  UNION "+
             "                    SELECT r.t_rateid, h.t_sincedate, r.t_type, r.t_fiid, r.T_ISRELATIVE, r.t_otherfi "+
             "                      FROM dratehist_dbt h, dratedef_dbt r "+
             "                     WHERE     r.t_rateid    = h.t_rateid "+
             "                           AND r.t_otherfi   = ? "+  /*string(Fiid_from) */
             "                           AND h.t_sincedate = ( SELECT MAX (h2.t_sincedate) "+
             "                                                   FROM dratehist_dbt h2, dratedef_dbt r2 "+
             "                                                  WHERE r2.t_rateid  = h2.t_rateid "+
             "                                                    AND r2.t_otherfi = r.t_otherfi "+
             "                                                    AND r2.t_type    = r.t_type  "+
             "                                                    AND h2.t_sincedate <= ?  "+ /*RateDate*/
             "                                               ) "+
             "                 ) WHERE t_type IN (?)"+
             // Golovkin 17.05.2019 для относительных курсов берём в первую очередь валюту номинала
             "         ORDER BY t_sincedate DESC,                                            " +
             "                  (CASE                                                        " +
             "                      WHEN T_ISRELATIVE != CHR (88) THEN 1                     " +
             "                      WHEN T_ISRELATIVE = CHR (88)                             " +
             "                           AND t_fiid = (SELECT fin.t_facevaluefi              " +
             "                                           FROM dfininstr_dbt fin              " +
             "                                          WHERE fin.t_fiid = t_otherfi) THEN 1 " +
             "                      ELSE 0                                                   " +
             "                   END) DESC,                                                  " +
             "                  t_type ASC                                                   " +
             //"        ORDER BY t_sincedate DESC, t_type ASC "+
             "       ) "+
             " WHERE ROWNUM = 1 "
                     );

  v_Query.addParam( "", RSDBP_IN, p_fiid );
  v_Query.addParam( "", RSDBP_IN, p_RateDate );
  v_Query.addParam( "", RSDBP_IN, p_fiid );
  v_Query.addParam( "", RSDBP_IN, p_RateDate );
  v_Query.addParam( "", RSDBP_IN, p_Type );
  v_Query.execute();

  v_Data = TRsbDataSet( v_Query );
  if( v_Data.MoveNext() )
    p_OtherFi = v_Data.fiid;
    IsExistCurse = true;
  end;

  return IsExistCurse;
END;


PRIVATE MACRO ПолучитьЛюбойПоследнийКурсНаДату( p_RateDate:DATE, p_fiid:INTEGER, p_Course:@money ):bool
  VAR v_Data, v_Query, IsExistCurse = false;

  p_Course = $0;

  v_Query = RSDCommand(
             "SELECT t_rateid, t_type, t_fiid "+
             "  FROM (SELECT t_rateid, t_type, t_fiid "+
             "            FROM (SELECT rate.t_rateid, rate.t_sincedate, rate.t_type, rate.t_fiid "+
             "                    FROM dratedef_dbt rate "+
             "                   WHERE rate.t_otherfi = ? "+ /*string(Fiid_from) */
             "                     AND t_sincedate    = (SELECT MAX (t_sincedate) "+
             "                                             FROM dratedef_dbt "+
             "                                            WHERE     t_otherfi = rate.t_otherfi "+
             "                                                  AND t_type    = rate.t_type  "+
             "                                                  AND t_sincedate <= ? "+ /*RateDate*/
             "                                          ) "+
             "                  UNION "+
             "                    SELECT r.t_rateid, h.t_sincedate, r.t_type, r.t_fiid  "+
             "                      FROM dratehist_dbt h, dratedef_dbt r "+
             "                     WHERE     r.t_rateid    = h.t_rateid "+
             "                           AND r.t_otherfi   = ? "+  /*string(Fiid_from) */
             "                           AND h.t_sincedate = ( SELECT MAX (h2.t_sincedate) "+
             "                                                   FROM dratehist_dbt h2, dratedef_dbt r2 "+
             "                                                  WHERE r2.t_rateid  = h2.t_rateid "+
             "                                                    AND r2.t_otherfi = r.t_otherfi "+
             "                                                    AND r2.t_type    = r.t_type  "+
             "                                                    AND h2.t_sincedate <= ?  "+ /*RateDate*/
             "                                               ) "+
             "                 ) "+
             "        ORDER BY t_sincedate DESC "+
             "       ) "+
             " WHERE ROWNUM = 1 "
                     );

  v_Query.addParam( "", RSDBP_IN, p_fiid );
  v_Query.addParam( "", RSDBP_IN, p_RateDate );
  v_Query.addParam( "", RSDBP_IN, p_fiid );
  v_Query.addParam( "", RSDBP_IN, p_RateDate );
  v_Query.execute();

  v_Data = TRsbDataSet( v_Query );
  if( v_Data.MoveNext() )
     if( ПолучитьКурсЗаданногоTипа(@p_Course, p_fiid, v_Data.fiid, v_Data.Type, p_RateDate, false) == true )
        if( (int(v_Data.fiid) != NATCUR) and (ConvSum(p_Course, p_Course, p_RateDate, v_Data.fiid, NATCUR)) )
           msgbox(GetCurrencyConvertErrorMsg(v_Data.fiid,NATCUR,p_RateDate));
           IsExistCurse = false;
        else
           IsExistCurse = true;
        end;
     else
        msgbox(GetCurrencyConvertErrorMsg(p_fiid, v_Data.fiid, p_RateDate));
        IsExistCurse = false;
     end;
  end;

  return IsExistCurse;
END;


class Logger()

    macro RepHeader()
       var str;
       str =     "                             Протокол загрузки БИО \n";
       str = str+"\n";
       str = str+"Дата загрузки  : "+date()+"\n";
       str = str+"Время загрузки : "+time()+"\n";
       //toRep1(str);                                                                                                   
       println(str);                                                                                                   
    end;
                                                                                                                                                                     
    macro RepFooter(suc, er, tot)                                                       
       var str = "";
    end;

    macro RepStr(str)
       return println(str);
    end;

end;

 private macro Initdvndeal()
         var dvndeal = TRecHandler( "dvndeal.dbt" );

         dvndeal.clear();
         dvndeal.rec.ID = 0;
         dvndeal.rec.DOCKIND = DL_DVNDEAL; //199
         dvndeal.rec.KIND = 12695; //вид сделки
         dvndeal.rec.TYPE = ALG_DV_SALE;; // Продажа
//         dvndeal.rec.DATE = vFI.DateBegPlcmt; //дата операции
         dvndeal.rec.TIME = Time(0,0,0);
//         dvndeal.rec.CODE = "FXO:" + vFI.Series;
         dvndeal.rec.EXTCODE = "";
         dvndeal.rec.ISPFI = "X";
         dvndeal.rec.STATE = 0;
         dvndeal.rec.DEPARTMENT = {OPERDPRT}; 
         dvndeal.rec.OPER = {oper};
         dvndeal.rec.AGENT = -1;
         dvndeal.rec.CLIENT = -1;
         dvndeal.rec.Contractor = {OurBank};
         dvndeal.rec.CLIENTCONTR = 0;
         dvndeal.rec.PARENTID = -1;
         dvndeal.rec.KINDDEALPARTYCLIENT = -1;
//         dvndeal.rec.COMMENT = "Встроенный ПФИ для  "+ fininstr.Definition;
         dvndeal.rec.COUNTRY = 165;
         dvndeal.rec.TRADERID = 0;
         dvndeal.rec.PERIODCLS = 3;
         dvndeal.rec.MARKETKIND = 0;
         dvndeal.rec.OptionType = 2;
         dvndeal.rec.OptionStyle = 2;
         dvndeal.rec.Instance = 0; //??
         dvndeal.rec.ChangeKind = 0;  //??
//         dvndeal.rec.BEGINDATE = vFI.DateBegPlcmt;
         dvndeal.rec.DVKIND = 2;
         dvndeal.rec.GenAgrID = -1;
//         dvndeal.rec.BonusDate = DatePrem_Head;
     return dvndeal;
  end;

  private macro initdvnfi()
          var dvnfi      = TRecHandler( "dvnfi.dbt" );
          dvnfi.clear();
          dvnfi.rec.ID = 0;
//          dvnfi.rec.DEALID = dvndeal.rec.ID;
          dvnfi.rec.TYPE = 0; //актив по сделке
//          dvnfi.rec.EXECDATE = vFI.ExpDate;
          dvnfi.rec.EXECTYPE = 0;
          //    dvnfi.rec.PAYDATE 
//          dvnfi.rec.EXPIRYDATE = vFI.ExpDate;
          //    dvnfi.rec.SUPLDATE
//          dvnfi.rec.AMOUNT = vFI.T;
          dvnfi.rec.COST = 0;
//          dvnfi.rec.PRICE =vFI.Kurs;
          dvnfi.rec.PRICEFIID = 7;//USD
          dvnfi.rec.POINT = 2;
          dvnfi.rec.FIID = 2574;
          dvnfi.rec.CONTRAMOUNT = 1;
          dvnfi.rec.STDFIID = -1;
          dvnfi.rec.ACCFIID = -1;
          dvnfi.rec.RATEID = 0;
          dvnfi.rec.CALKINDID = 0;
          dvnfi.rec.SCALE = 1;
    return dvnfi;
  end;

  private macro insertSSPFI(vFI)
   var  sql = "INSERT INTO dbiofrval_dbt (T_FIID,T_DATE,T_FAIRVALUE,T_ONEITEMFV,T_CURRENCY) VALUES (?,?,?,?,?)";
   var  cmd = RSDCommand(sql);
        cmd.addparam("t_fiid", rsdbp_in, vFI.fiid );
        cmd.addparam("t_date", rsdbp_in, vFI.DateBegPlcmt);
        cmd.addparam("T_FAIRVALUE", rsdbp_in, 0 );
        cmd.addparam("T_ONEITEMFV", rsdbp_in, vFI.Discont);
        cmd.addparam("T_CURRENCY", rsdbp_in, 0 );
        cmd.execute();
  end;


//Загрузка данных из Excel
macro OPLoad_BIO()
  record fininstr ("fininstr");
  record avoiriss ("avoiriss");
  record fiwarnts ("fiwarnts");
  var rparm = TRecHandler("rateparm");


  var DealID_Excel:string;
  var DealCode:string = "";
  var FullNameFile = "";
  var FileName = "";
  var TermPath = GetCurDir(true) + "\\TxtFile";
  var Userpath = "";
  var DirName = "";
  var ExtName = "";
  var frow = 1;
  var row = 1;
  var sheet, sql, query_insert, query_check, query_update;
  var valuedate:date =  Date(0, 0, 0);
  var ss = $0;
  var str;
  var DealID,FrVal = 0;
  var day = date();
  var ErrStr = "",ErrStat = false,IsOption = false;
  var all = 0,suc = 0, err = 0;
  var log = Logger();
  var StRec;
  var dt = StrSubSt(string(Date()),".","");
  var tm = StrSubSt(string(time()),":","");
  var InfoLogFileName = GetTxtFileName( "load_bio_"+dt+"_"+tm);
  var FIFRVAL = FIFRVALDATA();
  var fiwrntdrwdate;

 /*Выбираем файл для обработки*/

  if(not SelectFile(FullNameFile, /*OPEN_DIR*/reg_path, OPEN_DIALOG_HEADER, 0, true))
    MsgBox("Отказ от загрузки");
    return 0;
  end;

  //Отделяем путь файла от имени
  DirName = splitfile(FullNameFile, FileName, ExtName);
  FileName = FileName + ExtName;

  if (not copyfile("$" + DirName + FileName, "$" + TermPath + "\\" + FileName) )
    MsgBox("Ошибка при передаче файла на терминал");
  end;

  /*Открываем файл*/
  BegAction(1, "Обработка файла \"" + TermPath + "\\" + FileName + "\". Ждите...");

  if(not OpenExcelFile(FileName, false, true, TermPath))
    MsgBox("Ошибка открытия файла \"" + TermPath + "\\" + FileName + "\"");
    EndAction(1);
    return 0;
  end;

  sheet = ExcelApplication.Sheets(1);

  SetOutput( InfoLogFileName, true ); //Пишем лог в файл. Начало
  log.RepHeader(date(),time());

  var vFI = fi_data(); 
  var prev_row_head; 

  InitProgress(-1);
  while(frow <= 40)
    if((valtype(sheet.cells(frow, COL_HEAD).value) != V_UNDEF) )
      prev_row_head = StrUpr(sheet.cells(frow, COL_HEAD).value);
    end;
    frow = frow + 1; 
  
    if((valtype(sheet.cells(frow, COL_HEAD).value) != V_UNDEF) or (prev_row_head == StrUpr(fiwrntsdrwdate_Head)))
        if(StrUpr(sheet.cells(frow, COL_HEAD).value) == StrUpr(Series_Head))      
         vFI.Series = sheet.cells(frow, COL_DATA).value;
        elif(StrUpr(sheet.cells(frow, COL_HEAD).value) == StrUpr(Reg_Num_Head))      
         vFI.Reg_Num = sheet.cells(frow, COL_DATA).value;
        elif(StrUpr(sheet.cells(frow, COL_HEAD).value) == StrUpr(RegDate_Head))      
         vFI.RegDate = sheet.cells(frow, COL_DATA).value;
        elif(StrUpr(sheet.cells(frow, COL_HEAD).value) == StrUpr(ISIN_Head))      
         vFI.ISIN = sheet.cells(frow, COL_DATA).value;
        elif(StrUpr(sheet.cells(frow, COL_HEAD).value) == StrUpr(DateBegPlcmt_Head))      
         vFI.DateBegPlcmt = sheet.cells(frow, COL_DATA).value;
        elif(StrUpr(sheet.cells(frow, COL_HEAD).value) == StrUpr(DateEndPlcmnt_Head))      
         vFI.DateEndPlcmnt = sheet.cells(frow, COL_DATA).value;
        elif(StrUpr(sheet.cells(frow, COL_HEAD).value) == StrUpr(Amount_Head))      
         vFI.Amount = sheet.cells(frow, COL_DATA).value;
        elif(StrUpr(sheet.cells(frow, COL_HEAD).value) == StrUpr(Price_Head))      
         vFI.Price = sheet.cells(frow, COL_DATA).value;
        elif(StrUpr(sheet.cells(frow, COL_HEAD).value) == StrUpr(BondMaturity_Head))      
         vFI.BondMaturity = sheet.cells(frow, COL_DATA).value;
        elif(StrUpr(sheet.cells(frow, COL_HEAD).value) == StrUpr(CloseDate_Head))      
         vFI.CloseDate = sheet.cells(frow, COL_DATA).value;
        elif(StrUpr(sheet.cells(frow, COL_HEAD).value) == StrUpr(Prem_Head))      
         vFI.Prem = sheet.cells(frow, COL_DATA).value;
        elif(StrUpr(sheet.cells(frow, COL_HEAD).value) == StrUpr(DatePrem_Head))      
         vFI.DatePrem = sheet.cells(frow, COL_DATA).value;
        elif(StrUpr(sheet.cells(frow, COL_HEAD).value) == StrUpr(ExpDate_Head))      
         vFI.ExpDate = sheet.cells(frow, COL_DATA).value;
        elif(StrUpr(sheet.cells(frow, COL_HEAD).value) == StrUpr(DateRasch_Head))      
         vFI.DateRasch = sheet.cells(frow, COL_DATA).value;
        elif(StrUpr(sheet.cells(frow, COL_HEAD).value) == StrUpr(Active_Head))      
         vFI.Active = sheet.cells(frow, COL_DATA).value;
        elif(StrUpr(sheet.cells(frow, COL_HEAD).value) == StrUpr(Style_Head))      
         vFI.Style = sheet.cells(frow, COL_DATA).value;
        elif(StrUpr(sheet.cells(frow, COL_HEAD).value) == StrUpr(Kurs_Head))      
         vFI.Kurs = sheet.cells(frow, COL_DATA).value;
        elif(StrUpr(sheet.cells(frow, COL_HEAD).value) == StrUpr(T_Head))      
         vFI.T = sheet.cells(frow, COL_DATA).value;
        elif(StrUpr(sheet.cells(frow, COL_HEAD).value) == StrUpr(O_Head))      
         vFI.O = sheet.cells(frow, COL_DATA).value;
        elif(StrUpr(sheet.cells(frow, COL_HEAD).value) == StrUpr(Incomerate_head))      
         vFI.incomerate = sheet.cells(frow, COL_DATA).value;
        elif(StrUpr(sheet.cells(frow, COL_HEAD).value) == StrUpr(Discont_head))      
         vFI.Discont = sheet.cells(frow, COL_DATA).value;

        elif((StrUpr(sheet.cells(frow, COL_HEAD).value) == StrUpr(fiwrntsdrwdate_Head)) or (prev_row_head == StrUpr(fiwrntsdrwdate_Head)))
         vfi.fiwrntsdrwdate.value(vfi.fiwrntsdrwdate.size) = sheet.cells(frow, COL_DATA).value;
        
      end;
    end;
    
    UseProgress(frow);
  end;

      ClearRecord(fininstr);
      ClearRecord(avoiriss);
      ClearRecord(fiwarnts);
   var   avrinvst = TRechandler ("avrinvst");
   var err_msg;


         fininstr.Issuer = {OurBank};
         fininstr.AvoirKind = 52; //BIO
         fininstr.FI_Kind = 2;
         fininstr.Name = "BIO " + vFI.Series;
         fininstr.Definition ="BIO " + vFI.Series;
         fininstr.Settlement_Code = 0;
         fininstr.FaceValue = vFI.Price;
         fininstr.Issued = vFI.DateBegPlcmt;
         fininstr.MainFiid = -1;
         fininstr.GeneralizedFiid = -1;
         fininstr.ParentFI = 0;
         fininstr.DrawingDate =vFI.CloseDate;
         avoiriss.isin = vFI.ISIN;
         avoiriss.lsin = vFI.reg_num;
         avoiriss.series = vFI.Series;
         avoiriss.qty = vFI.Amount;
         avoiriss.nkdround_kind = 1;
         avoiriss.regdate = vFI.RegDate;

         avoiriss.nkdbase_kind = 0;
         avoiriss.incirculationdate = vFI.DateBegPlcmt;

         avoiriss.begplacementdate = vFI.DateBegPlcmt;
         avoiriss.endplacementdate = vFI.DateEndPlcmnt;
         FI_AvoirGenerateCode(fininstr, avoiriss, fininstr.FI_Code, fininstr.CodeInAccount);
         avrinvst = null;
         if( FI_InsertAvoiriss(fininstr, avoiriss, avrinvst, null, false) != 0 ) 
           err_msg = "Ошибка вставки ценной бумаги:" + geterrmsg();
         else
           err_msg = "ЦБ "+ fininstr.Name + " загружена.";
         end;
          log.repstr(err_msg);
//       Добавляем купоны
         var n = 1;
         var prevdrwdate;
         for(fiwrntdrwdate, vfi.fiwrntsdrwdate)
            if(valtype(fiwrntdrwdate) != v_Undef)
                  ClearRecord(fiwarnts);
                  fiwarnts.fiid         = fininstr.FIID;
                  fiwarnts.number       = n;
                  fiwarnts.drawingdate  = fiwrntdrwdate;
                  if(n == 1)
                    prevdrwdate  = fiwrntdrwdate;
                  end;
                  fiwarnts.incomerate   = money(vFI.incomerate);
     //             fiwarnts.incomevolume = money( DataSet.value("T_INCOMEVOLUME") );
                  if (n == 1)
                    fiwarnts.firstdate    = avoiriss.begplacementdate + 1;
                  else
                    fiwarnts.firstdate = prevdrwdate + 1;
                    prevdrwdate  = fiwrntdrwdate;                    
                  end;
     //             fiwarnts.factdate     = DataSet.value("T_FACTDATE");
                  fiwarnts.incomescale  = 1;
     //             fiwarnts.listdate     = DataSet.value("T_LISTDATE");
                  fiwarnts.incomepoint = 4;
                  fiwarnts.relativeincome = "X";
                  if( FI_InsertWarnt(fiwarnts) != 0 )
                   log.repstr("Ошибка вставки купона №" + n);
                  else
                    log.repstr("Купон №" + n + " добавлен");
                  end;
                  n = n + 1; 
            end;
         end;

         rparm.Clear();
         rparm.rec.OtherFI = fininstr.fi_code;
         rparm.rec.IsRelative = "X";
         rparm.rec.Type = 1;
         rparm.rec.Market_Place = 0;
         rparm.rec.Section = 0;
         rparm.rec.Name = "";
         rparm.rec.FI_Code = "810";
         rparm.rec.Scale = 1;
         rparm.rec.Point = 4;
         rparm.rec.Rate = (fininstr.FaceValue  * pow(10,rparm.rec.Point))/10;
         rparm.rec.SinceDate = fininstr.Issued;
         if(УстановитьКурс(rparm) != 0 )
         end;

         vFI.fiid = fininstr.FIID;
         insertSSPFI(vFI);
 
         var dvndeal = Initdvndeal();
         dvndeal.rec.DATE = vFI.DateBegPlcmt; //дата операции
         dvndeal.rec.CODE = "FXO:" + vFI.Series;
         dvndeal.rec.COMMENT = "Встроенный ПФИ для  "+ fininstr.Definition;
         dvndeal.rec.BEGINDATE = vFI.DateBegPlcmt;
         dvndeal.rec.BonusDate = vFI.DatePrem;
         dvndeal.rec.Bonus = vFI.Prem*vFI.Amount;
         dvndeal.rec.BonusFiid = 0;
         dvndeal.rec.BonusPrice = dvndeal.rec.Bonus/(vFI.T*1000);
        


        var dvnfi2     = TRecHandler("dvnfi.dbt");
        var spgrdoc    = TRecHandler( "spgrdoc.dbt"  );
        VAR ArrComSums = TArray();/*список комиссиий (бирже)*/
        var ArrNotes   = TArray();/*список примечаний*/
        var ClntRep    = TRecHandler( "spground.dbt" );

        var dvnfi      = initdvnfi();
        dvnfi.rec.DEALID = dvndeal.rec.ID;
        dvnfi.rec.EXECDATE = vFI.ExpDate;
        dvnfi.rec.EXPIRYDATE = vFI.ExpDate;
        dvnfi.rec.AMOUNT = vFI.T * 1000;
        var FindCourseFi;
        ПолучитьЛюбойПоследнийКурсНаДату(vFI.DateBegPlcmt,dvnfi.rec.FIID, @FindCourseFi);
        dvnfi.rec.PRICE = vFI.O/(vFI.T *1000)/*FindCourseFi*/;
        var stat;
          stat = DV_InsertNDeal(dvndeal, dvnfi, dvnfi2, null, spgrdoc, ArrComSums, ClntRep, ArrNotes);
        if( stat != 0 )
          err_msg = "Ошибка при вставке отложенной сделки с ПИ.\n"+GetErrMsg();  
//        RunError(err_txt, c_err_obj(err_txt,-3000));
        else
          err_msg =  "Oтложенная сделка с ПИ  "+ dvndeal.rec.CODE + " загружена.";
        end;
        log.repstr(err_msg);
        // вставка связи
        var sql1 = "insert into dobjlink_dbt( t_linkid, T_GROUPID,T_OBJECTTYPE ,T_OBJECTID ,T_ATTRTYPE,T_ATTRID,T_VALIDFROMDATE,T_VALIDTODATE,T_OPER) " +
              "values(0, 2,145,?,12, ?, ?,to_date('31129999','ddmmyyyy)'), ?); " ;
        var  cmd1 = RSDCommand(sql1);
        cmd1.addparam("dvndealid", rsdbp_in,string(dvndeal.rec.id:o:34));
        cmd1.addparam("fiid", rsdbp_in, string(vFI.fiid:o:10));
        cmd1.addparam("BegDate", rsdbp_in, vFI.DateBegPlcmt );
        cmd1.addparam("oper", rsdbp_in, {oper});
        cmd1.execute();

        err_msg =  "Связь между Загруженной ЦБ и встроенным ПФИ установлена";
        log.repstr(err_msg);
 

  RemProgress();  
  ExcelApplication.ActiveWorkbook.Close;
  if (not copyfile("$" + DirName + FileName, "$" + arch_path + "\\" + FileName) )
    log.repstr("Ошибка при копировании файла в архив");
  else 
    log.repstr("Исходный файл скопирован в архив: " + arch_path + "\\" + FileName);
  end;

  if (not RemoveFile ("$" + DirName /*+ "\\"*/ + FileName))
    log.repstr("Ошибка при удалении исходного файла");
  end;

  if (not RemoveFile ("$" + TermPath + "\\" + FileName))
    MsgBox("Ошибка удаления файла " + TermPath + "\\" + FileName);
  end;
  SetOutput( NULL, true ); //Пишем лог в файл. Конец
  ViewFile( InfoLogFileName );

onerror()
  if (valtype(ExcelApplication) != V_UNDEF)
    ExcelApplication.ActiveWorkbook.Close;
  end;
  EndAction(1);
End;
OPLoad_BIO();
exit(1);
