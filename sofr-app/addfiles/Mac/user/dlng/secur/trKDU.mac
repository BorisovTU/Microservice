import  RsbFormsInter, Globals, RSD;
import "qracctools.mac";
 
 const K_F2 = 316;
 const K_F3 = 317;
 const Alt_K_F3 = 362;

 const pDepName_Field    = 2;
 const pDepoAcc_Field    = 3;
 const pDepoPart_Field   = 4 ;
 const pLSIN_Field       = 5;
 const pISIN_Field       = 6;
 const pFI_CODE_Field    = 7;
 const pDefinition_Field = 8;
 const pName_Field       = 9;
 const pRest_Field       = 10;

 var Acc_Code = "18574";
 var dpPart_Code ="";

var vFiid,vFI_CODE, vLSIN,vISIN,vDefinition,vName ;
var vDepID, vDepName;
var vDepoACC, vDepoPart;

var ScQrAcc = TRecHandler("scqracc.dbt");
var AvoirRec = TRecHandler("avoiriss.dbt");
var FininstRec = TRecHandler("fininstr.dbt"); 

var errStr,err;



PRIVATE MACRO AddCol (ar,ind, fld, head, width, rdonly, ty, dp)
   ar.value (ind * 6)     = fld;
   ar.value (ind * 6 + 1) = head;
   ar.value (ind * 6 + 2) = width;
   ar.value (ind * 6 + 3 ) = rdonly;   // fldType
   ar.value (ind * 6 + 4 ) = dp;//   decPoint
   ar.value (ind * 6 + 5 ) = 0;   // reserv
END;




private macro FoundCreateQrRest(ScQrAcc:TRecHandler, Rest:money, RestDate:date, ErrStr:@string)
    var err=0, bufStr="";
    var ScQrRestTB = TBFile("scqrrest.dbt","w",1);
    ScQrRestTB.rec.QrId = ScQrAcc.rec.QrId;
    ScQrRestTB.rec.Date = RestDate;
    if (ScQrRestTB.GetEQ())
      ScQrRestTB.rec.Rest = Rest;
      if (not ScQrRestTB.Update())
        RunError("Ошибка обновления записи таблицы scqrrest.dbt:|"+status(bufStr)+"-"+bufStr);
      end;
    else
      ScQrRestTB.rec.QrId = ScQrAcc.rec.QrId;
      ScQrRestTB.rec.Date = RestDate;
      ScQrRestTB.rec.Rest = Rest;
      if (not ScQrRestTB.Insert())
        RunError("Ошибка вставки записи в таблицу scqrrest.dbt:|"+status(bufStr)+"-"+bufStr);
      end;
    end;
  OnError(ErrObj)
    if (IsEqClass ("TrslError", ErrObj))
      ErrStr=ErrObj.Message;
      if(IsEqClass ("TDbError", ErrObj.err))
        ErrStr=ErrStr+":|"+ErrObj.err.Stat+"-"+ErrObj.err.Oper+"-"+ErrObj.err.Table+"-"+ErrObj.err.Message;
      end;
    elif (not ErrStr)
      ErrStr="Ошибка выполнения FoundOpenScQr";
    end;
    return 1;
  end;

private macro FoundOpenScQr(EurPartyId:integer, DepoAcc:string, DepoPart:string, 
    Fiid:integer, ScQrAcc:TRecHandler, AvoirRec:TRecHandler, FininstRec:TRecHandler, Rest:money, RestDate:date, ErrStr:@string)
    var err=0, bufStr="";
    var cmd, DataSet;
    var ScQrAccTB = TBFile("scqracc.dbt","w");
    ScQrAcc.Clear();
    FininstRec.Clear();
    AvoirRec.Clear();
    cmd = DL_RSDCommand(  "select * from dscqracc_dbt qracc"
                               + " where qracc.t_StorageId  = ? "
                               + "   and qracc.t_Fiid  = ? "
                               + "   and qracc.t_DepoAccCode = ? "
                               + "   and qracc.t_DepoPartCode = ? "
                               + "   and rownum = 1"
                               ); 
    cmd.AddParam(EurPartyId);
    cmd.AddParam(Fiid);
    cmd.AddParam(DepoAcc);
    cmd.AddParam(DepoPart);
    DataSet = cmd.Execute();
    if (DataSet.moveNext())
      DataSet.GetRecord().CopyTo(ScQrAcc.rec);
      err=FoundCreateQrRest(ScQrAcc, Rest, RestDate, @ErrStr);
    else
      ScQrAcc.rec.StorageId = EurPartyId;
      ScQrAcc.rec.Fiid = Fiid;
      ScQrAcc.rec.DepoAccCode = DepoAcc;
      ScQrAcc.rec.DepoPartCode = DepoPart;
      err = СоздатьЗаписьВРегистреКДУ(ScQrAcc, RestDate, Rest, @ErrStr);
    end;
    if (not err)
      ПолучитьФинИн(Int(Fiid),FininstRec,AvoirRec);
    end;
    return err;
  OnError(ErrObj)
    if (IsEqClass ("TrslError", ErrObj))
      ErrStr=ErrObj.Message;
      if(IsEqClass ("TDbError", ErrObj.err))
        ErrStr=ErrStr+":|"+ErrObj.err.Stat+"-"+ErrObj.err.Oper+"-"+ErrObj.err.Table+"-"+ErrObj.err.Message;
      end;
    elif (not ErrStr)
      ErrStr="Ошибка выполнения FoundOpenScQr";
    end;
    return 1;
  end;

  
  macro EvProc(rs, cmd, id, key)
   
   if (cmd == DLG_KEY)
    if (key == 13)
       vFiid = rs.value("t_FIID");
       vFi_CODE = rs.value("t_FI_CODE");
       vLSIN = rs.value("t_LSIN"); 
       vISIN = rs.value("t_ISIN");
       vDefinition = rs.value("t_Definition");
       vName = rs.value("Name"); 
       return CM_SELECT;
    end;   
  end;
end;


macro EvProc2(rs, cmd, id, key)
   
   if (cmd == DLG_KEY)
    if (key == 13)
       vDepID = rs.value("t_storageid");
       vDepName = rs.value("T_ShortNAME");
       return CM_SELECT;
    end;   
  end;
end;

macro EvProc3(rs, cmd, id, key)
   
   if (cmd == DLG_KEY)
    if (key == 13)
       vDepoACC = rs.value("t_DepoAccCode");
       return CM_SELECT;
    end;   
  end;
end;

macro EvProc4(rs, cmd, id, key)
   
   if (cmd == DLG_KEY)
    if (key == 13)
       vDepoPart = rs.value("t_DepoPartCode");
       return CM_SELECT;
    end;   
  end;
end;


 macro PnlProc(dlgPanel, cmd, id, key, numScroll)
	var CM_FLAG = CM_DEFAULT;
  var sql2;

  if (cmd == DLG_INIT)
   
   dlgPanel.rec.pDate = {CurDate}; 
  // dlgPanel.rec.pRest = 0;
   
   if ({oper}==1)
    EnableFields( dlgPanel, pRest_Field ); 
   end;

  elif(cmd==DLG_KEY)
   if (key ==K_F2)
     errStr;
     UpdateFields(dlgPanel);
    vDepoACC = dlgPanel.rec.pDepoAcc;
     err = FoundOpenScQr(vDepID, vDepoACC, vDepoPart, 
                vFiid, ScQrAcc, AvoirRec, FininstRec, /*dlgPanel.rec.pRest*/0, {CurDate}, @ErrStr);

     if(err==0)
        msgbox("Выполнено.\n Нажмите ESC для выхода.");
     else msgbox("Запись в регистре КДУ с введенными параметрами уже существует. Проверьте корректность данных.");
     end;

     elif (key ==318111)
        msgbox("!!");
        err = FoundOpenScQr(72832, "18574", "", 
                182, ScQrAcc, AvoirRec, FininstRec, 1, {CurDate}, @ErrStr);

   elif ((key ==K_F3) or (key == Alt_K_F3) )
  	if(id == 0)
	  //	msgbox("Выбор даты");
        elif( (id == 1) or (id == 2) )
		//msgbox("Выбор депозитария");
	    var col2 = tArray;
     	AddCol (col2, 0, "T_ShortNAME",    "Наименование",   50 ,  0,0);
       if (key ==K_F3)
         sql2 = "select st.t_storageid, PT.T_ShortNAME  from dscqracc_dbt st, dparty_dbt pt where PT.T_PARTYID = ST.T_STORAGEID group by st.t_storageid, PT.T_ShortNAME";
       else
         sql2 = " SELECT                                             " +
      "        t.t_partyid t_storageid, " +
      "        t.t_shortname " +
      "   FROM dparty_dbt t, " +
      "         dpartcode_opened_view partcode_opened, " +
      "         dpartyname_view partyname, " +
      "         dpartyown_dbt partyown, " +
      "         dptfrzng_dbt ptfrzng " +
      "   WHERE   partyown.t_PartyID = t.t_PartyID " +
      "              AND partyown.t_PartyKind = 4 " +
      "              AND partyown.t_SubKind = 0 " +
      "              AND t.t_Locked = chr(0) " +
      "              AND t.t_LegalForm = 1 " +
      "              AND partcode_opened.t_PartyID(+) = t.t_PartyID " +
      "              AND partcode_opened.t_CodeKind(+) = 1 " +
      "              AND partyname.t_NameTypeID(+) = 2 " +
      "              AND partyname.t_PartyID(+) = t.t_PartyID " +
      "              AND ptfrzng.t_PartyID(+) = t.t_PartyID " +
      "ORDER BY t.t_partyid "; 

       end;
        var rs2 = RSDrecordset(sql2, rsdval_client, rsdval_static);
		var retval1 =     runScroll(rs2, 1, col2, "Депозитарии", "EvProc2", "", "", true );

          if(retval1) 
            dlgPanel.rec.pDepID = vDepID;
            dlgPanel.rec.pDepName = vDepName;
    	      dlgPanel.rec.pDepoAcc = vDepoAcc = "";
            dlgPanel.rec.pDepoPart = vDepoPart = "";
            UpdateFields(dlgPanel);
          end;
        elif( id == 3 )
	//	msgbox("Выбор счета депо");
        var col3 = tArray;
        AddCol (col3, 0, "t_DepoACCCode",    "Счет Депо",   50 ,  0,0);
        var sql3 = "select st.t_DepoACCCode from dscqracc_dbt st where  ST.T_STORAGEID = "+ vDepID + " group by st.t_DepoACCCode";
        var rs3 = RSDrecordset(sql3, rsdval_client, rsdval_static);
        var retval3 =     runScroll(rs3, 1, col3, "Счета ДЕПО", "EvProc3", "", "", true );
        dlgPanel.rec.pDepoACC = vDepoACC;
        dlgPanel.rec.pDepoPart = vDepoPart = "";
        UpdateFields(dlgPanel);



        elif( id == 4 )
		//msgbox("Выбор раздела депо");
        var col4 = tArray;
        AddCol (col4, 0, "t_DepoPartCode",    "Раздел счета Депо",   50 ,  0,0);
        var sql4 = "select st.t_DepoPartCode from dscqracc_dbt st where  ST.T_STORAGEID = "+ vDepID + " and st.t_DepoAccCode = '" + vDepoAcc + "'  group by st.t_DepoPartCode";
        var rs4 = RSDrecordset(sql4, rsdval_client, rsdval_static);
        var retval4 = runScroll(rs4, 1, col4, "Счета ДЕПО", "EvProc4", "", "", true );
        dlgPanel.rec.pDepoPart = vDepoPart;
        UpdateFields(dlgPanel);
	      
        else
 		var col1 = TArray;   

		   AddCol (col1, 0, "T_FI_CODE",    "Код цб в софр",   12 ,  0,0);
		   AddCol (col1, 1, "NAME",    "Наименование",                  30,  0,0);
		   AddCol (col1, 2, "T_DEFINITION",      "Кр.наименование",           15, 0);
		   AddCol (col1, 3, "t_lsin",        "ГосРег",                    12, 0);
		   AddCol (col1, 4, "t_isin", "ISIN",                    12, 0);
		   AddCol (col1, 5, "T_NAME",   "Эмитент",                     25, 0);

		        var SQL = "SELECT FI.T_FIID, FI.T_FI_CODE, "
		      + "       FI.T_NAME Name, "
		      + "       FI.T_DEFINITION, "
		      + "       av.t_lsin, "
		      + "       av.t_isin, "
		      + "       P.T_NAME "
		      + "  FROM dfininstr_dbt fi, davoiriss_dbt av, dparty_dbt p "
		      + " WHERE     av.t_fiid = fi.t_fiid "
		      + "       AND p.t_partyid = fi.t_issuer "
		      + "       AND fi.t_fi_kind = 2 "
		      + "       AND fi.t_issuer != -1 "
		      + "       AND fi.t_avoirkind != 5 ";

      
		      var rs = RSDrecordset(sql, rsdval_client, rsdval_static);
		      var retval =     runScroll(rs, 6, col1, "Ценные бумаги","EvProc", "", "", true );

        dlgPanel.rec.pFI_CODE = vFi_CODE;
        dlgPanel.rec.pLSIN = vLSIN; 
        dlgPanel.rec.pISIN = vISIN;
        dlgPanel.rec.pDefinition = vDefinition;
        dlgPanel.rec.pName = vName;
		//msgbox(vFiid);
        UpdateFields(dlgPanel);
 
       end;

   end;
    
  end;

  UpdateFields(dlgPanel);
  return CM_DEFAULT;
end;




 //  initDL_CPanel( "kdu.lbr", "trKDU" ); 
var pnl = tRecHandler("trKDU", "userKDU.lbr", true);
runDialog(pnl, @PnlProc);
exit(1);