/*Новые ДБО*/
import captureoutput, rsd, globals;


/**/
macro makeArray():TArray
  var parm:variant, i:integer = 0, result:TArray = TArray( ParmCount(), ParmCount() );
  while( GetParm(i, parm) )
    result.value(i) = parm;
    i = i + 1;
  end;
  return result;
end;


/*Обработчик скроллинга*/
macro DBO_Scroll(rs, cmd, id, key)
  var errmsg, ars;
  /*Обработчик*/
  if(cmd == DLG_KEY)
    /*Enter*/
    if(key == 13)
      return CM_IGNORE;
    /*Esc*/
    elif(key == 27)
      return CM_CANCEL;
    end;
  end;
end;


/**/
macro NewDBO()
  var que, rs, cmd;
    StartCaptureOutput();
    [ 
      select t_status, 
             t_number, 
             t_datebegin, 
             t_name
      from (select (select trim(lower(nvl(max(t_name),'новый'))) 
                    from dobjattr_dbt objattr, dobjatcor_dbt objatcor 
                    where objattr.t_objecttype = 207/*Договор брокерского обслуживания*/ and 
                          objattr.t_groupid = 101 and /*Статус договора*/ 
                          objatcor.t_objecttype = objattr.t_objecttype and 
                          objatcor.t_groupid = objattr.t_groupid and 
                          objatcor.t_attrid = objattr.t_attrid and 
                          objatcor.t_object = lpad(dlcontr.t_dlcontrid, 34, '0') and 
                          objatcor.t_validfromdate <= dt and 
                          objatcor.t_validtodate > dt) t_status,
                   sfcontrdl.t_number, 
                   sfcontrdl.t_datebegin, 
                   sfcontrdl.t_name
            from ddlcontr_dbt dlcontr
            join (select ? dt from dual) on 1 = 1
            join dsfcontr_dbt sfcontrdl on sfcontrdl.t_id = dlcontr.t_sfcontrid and 
                              sfcontrdl.t_datebegin <= dt and ((sfcontrdl.t_dateclose = to_date('01010001','ddmmyyyy')) or (sfcontrdl.t_dateclose > dt) ) )
      where t_status != 'обработка завершена'
      order by t_datebegin, t_status, t_name
    ];
    que = EndCaptureOutput();
    cmd = RsdCommand(que);
    cmd.AddParam("dt", RSDBP_IN, {curdate});
    rs = RSDRecordset(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);
    while(RunScroll(rs, 4, MakeArray("t_status", "Состояние", 15, 2, -1, 0,
                                     "t_number", "Номер", 20, 2, -1, 0,  
                                     "t_datebegin", "Дата", 10, 2, -1, 0,
                                     "t_name", "Название", 50, 2, -1, 0), 
                    null, "NewDBO_Scroll", "Новые ДБО", "~Esc~ Выход", true))
      cmd = RsdCommand(que);
      cmd.AddParam("dt", RSDBP_IN, {curdate});
      rs = RSDRecordset(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);
    end;
end;

  
/*Точка входа*/
NewDBO();
exit(1);
