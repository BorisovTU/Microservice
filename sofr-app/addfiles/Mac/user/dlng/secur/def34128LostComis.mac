import globals, InsCarryDoc;
import rsd;
import "def34128spcomcalc.mac";

class def34128LostComisClass()

  macro createComis(rs, maxcalcid)
      var web_rep = null;
      var all_str = 0;
      var all_err = 0;
      var all_mes = TStrCollector;
      var comid = 0;
      RunComCalc(maxcalcid, rs.value("dealdate"), rs.value("t_dealid"), rs.value("t_clientid"), rs.value("t_clientcontrid"), comId, 1, true, @web_rep, @all_mes, @all_str, @all_err);
  end;

  macro make_comis()
    var maxcalcid = get34128CalcId();
    var query = 
    "select                                                                                          "+
    "       pl.t_end plenddate,                                                                      "+
    "       pl.t_sfplanid,                                                                           "+
    "       spl.t_name,                                                                              "+
    "       deal.t_date Dealdate,                                                                    "+
    "       deal.t_id t_dealid,                                                                      "+
    "       deal.t_code t_dealcode,                                                                  "+
    "       deal.t_extcode,                                                                          "+
    "       deal.t_client t_clientid,                                                                "+
    "       p.t_shortname,                                                                           "+
    "       deal.t_clientcontr t_clientcontrid,                                                      "+
    "       sf.t_number,                                                                             "+
    "       deal.t_fromimport,                                                                       "+
    "       sf.t_id,                                                                                 "+
    "       Dli.t_Pricefiid                                                                          "+
    "  from ddvndeal_dbt     deal,                                                                   "+
    "       dsfcontrplan_dbt pl,                                                                     "+
    "       dsfplan_dbt      spl,                                                                    "+
    "       dsfcontr_dbt     sf,                                                                     "+
    "       dparty_dbt       p,                                                                      "+
    "       Ddvnfi_Dbt       Dli                                                                     "+
    " where 1=1                                                                                      "+
    "   and deal.t_clientcontr <> 0                                                                  "+
    "   and deal.t_dockind in (4813, 199)                                                            "+
    "   and t_date >= to_date('01.10.2022', 'dd.mm.yyyy')                                            "+
    "   and not exists (select 1                                                                     "+
    "          from ddlcomis_dbt                                                                     "+
    "         where t_dockind in (4813, 199)                                                         "+
    "           and t_docid = deal.t_id                                                              "+
    "           and t_comnumber > 1000)                                                              "+
    "   and deal.t_marketid = 2                                                                      "+
    "   and pl.t_sfcontrid = deal.t_clientcontr                                                      "+
    "   and pl.t_begin <= deal.t_date                                                                "+
    "   and (pl.t_end >= deal.t_date OR                                                              "+
    "       pl.t_end = to_date('01.01.0001', 'dd.mm.yyyy'))                                          "+
    "   and spl.t_sfplanid = pl.t_sfplanid                                                           "+
    "   and sf.t_id = deal.t_clientcontr                                                             "+
    "   and p.t_partyid = deal.t_client                                                              "+
    "   and Dli.t_Dealid = deal.t_Id                                                                 ";
//    query = query + "     and sf.t_id = 180937 ";  //отладка                    
    query = query + "   order by p.t_partyid, sf.t_id, deal.t_date ";  //необходимо для суммы за день
//    query = query + "  fetch first 2 rows only ";  //отладка                    
    var cmd = RSDCommand(query);                                                
    var rs = RsdRecordSet(cmd);                                                 
    while (rs.movenext)                
      createComis(rs, maxcalcid);  
    end;                                                                        
  end;                                                                          

end;                                                                            


macro def34128LostComisRun()
  var trnObject = def34128LostComisClass;
  trnObject.make_comis;
onError(er)
  MsgBox("Ошибка при создании комиссий " + er.Message);
end;
