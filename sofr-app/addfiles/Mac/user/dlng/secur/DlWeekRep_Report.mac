/*
$Name:             DlWeekRep_Report.mac
$Module:           Ядро Securities
$Description:      Запуск Отчета "Еженедельная отчетность по ц/б"
*/
import "DlWeekRep_Form.mac", "mctplprm.mac", "dlquery.mac", "dldlngfun.mac", "spCache.mac", "dv_categ.mac", "dv_car.mac", "secinter.mac";
import "spRepFn2.mac";

PRIVATE VAR  weekRep_Form;      // DlWeekRep_Panel  - объект панели
private var  weekRepPanData;    // Данные на панели: флажки с типами отчетов, даты отчетности

    private MACRO getAccRest(fiid: Integer, ondate: Date) : money
        var res = $0;

        var q = "select "
                +"      Nvl(Sum( abs(rsb_account.restac(acc.t_Account, acc.t_Currency, ?, acc.t_Chapter, null))  ), 0) amount "
                +" from (select accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter "
                +"         from DMCACCDOC_DBT accdoc, DMCCATEG_DBT categ " 
                +"        where  "
                +"           categ.t_ID = accdoc.t_catID and "
                +"           categ.t_Code = 'Наш портфель ц/б' and "
//                +"           accdoc.t_IsCommon <> 'X' and "
//                +"           accdoc.t_ActivateDate <= ? and " 
//                +"           (accdoc.t_DisablingDate >= ? or accdoc.t_DisablingDate = TO_DATE('01-01-0001','DD-MM-YYYY') ) and " 
                +"           accdoc.t_FIID = ? "
                +"       Group by accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter "
                +"      ) acc ";

        var cmd = DL_RSDCommand(q);
        cmd.addParam( ondate );
//        cmd.addParam( ondate );
//        cmd.addParam( ondate );
        cmd.addParam( fiid );    
        var rs = cmd.Execute();
        if  ( rs.MoveNext() )    
            res = res + money(rs.amount);
        end;

/*
        q = "select /*+ leading(categ accdoc tick) */ "
                +"      Nvl(Sum( abs(rsb_account.restac(acc.t_Account, acc.t_Currency, ?, acc.t_Chapter, null))  ), 0) amount "
                +" from (select accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter "
                +"         from DMCACCDOC_DBT accdoc, DMCCATEG_DBT categ, ddl_tick_dbt tick " 
                +"         where  "
                +"            categ.t_ID = accdoc.t_catID and "
                +"            categ.t_Code = 'Ц/б, БПП' and "
//                +"            accdoc.t_IsCommon <> 'X' and "
//                +"            accdoc.t_ActivateDate <= ? and " 
//                +"            (accdoc.t_DisablingDate >= ? or accdoc.t_DisablingDate = TO_DATE('01-01-0001','DD-MM-YYYY') ) and " 
                +"            tick.t_DealID = rsb_secur.GetDealID(accdoc.t_DocKind, accdoc.t_DocID) and "
                +"            tick.t_PFI = ? "
                +"       Group by accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter "
                +"      ) acc ";
*/
        q = "select  "
                +"      Nvl(Sum( abs(rsb_account.restac(acc.t_Account, acc.t_Currency, ?, acc.t_Chapter, null))  ), 0) amount "
                +" from (select accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter "
                +"         from DMCACCDOC_DBT accdoc, DMCCATEG_DBT categ, ddl_tick_dbt tick, ddl_leg_dbt leg " 
                +"         where  "
                +"            categ.t_ID = accdoc.t_catID and "
                +"            categ.t_Code = 'Ц/б, БПП' and "
                +"            accdoc.t_DocID = leg.t_id and " 
                +"            accdoc.t_dockind = 176  and " // Golovkin 08.12.2020 ID : 519868 через rsb_secur.GetDealID очень медленная связка. Пока сделал через 176 документ(ddl_leg_dbt), т.к. не нашел счетов по этой категории с другим t_dockind
                +"            tick.t_DealID = leg.t_dealid and "
                +"            tick.t_PFI = ? "
                +"       Group by accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter "
                +"      ) acc ";

        cmd = DL_RSDCommand(q);
        cmd.addParam( ondate );
//        cmd.addParam( ondate );
//        cmd.addParam( ondate );
        cmd.addParam( fiid );    
        rs = cmd.Execute();
        if  ( rs.MoveNext() )    
            res = res + money(rs.amount);
        end;



        q = "select "
                +"    Nvl(Sum( abs(rsb_account.restac(acc.t_Account, acc.t_Currency, ?, acc.t_Chapter, null))  ), 0) amount "
                +" from (select accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter "
                +"         from DMCACCDOC_DBT accdoc, DMCCATEG_DBT categ, ddl_tick_ens_dbt tick_ens " 
                +"         where  "
                +"            categ.t_ID = accdoc.t_catID and "
                +"            categ.t_Code = 'Ц/б, Корзина БПП' and "
                +"            tick_ens.t_ID = accdoc.t_DocID and "
                +"            accdoc.t_DocKind = ? and " //DL_TICK_ENS_DOC
//                +"            accdoc.t_IsCommon <> 'X' and "
//                +"            accdoc.t_ActivateDate <= ? and " 
//                +"            (accdoc.t_DisablingDate >= ? or accdoc.t_DisablingDate = TO_DATE('01-01-0001','DD-MM-YYYY') ) and " 
                +"            tick_ens.t_FIID = accdoc.t_FIID and " 
                +"            tick_ens.t_FIID = ? "
                +"       Group by accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter "
                +"      ) acc ";



        cmd = DL_RSDCommand(q);
        cmd.addParam( ondate );
        cmd.addParam( DL_TICK_ENS_DOC );
//        cmd.addParam( ondate );
//        cmd.addParam( ondate );
        cmd.addParam( fiid );    
        rs = cmd.Execute();
        if  ( rs.MoveNext() )    
            res = res + money(rs.amount);
        end;

        return res;
    END;

    private MACRO getAccRestOverval(fiid: Integer, ondate: Date) : money
        var res = $0;


        var q = "select "
                +"      Nvl(Sum( abs(rsb_account.restac(acc.t_Account, acc.t_Currency, ?, acc.t_Chapter, null))  ), 0) amount "
                +" from (select accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter "
                +"         from DMCACCDOC_DBT accdoc, DMCCATEG_DBT categ " 
                +"        where  "
                +"           categ.t_ID = accdoc.t_catID and "
                +"           categ.t_Code IN ( '+Переоценка, ц/б ССПУ_ЦБ', '+Переоценка, ц/б СССД_ЦБ') and "
//                +"           accdoc.t_IsCommon <> 'X' and "
//                +"           accdoc.t_ActivateDate <= ? and " 
//                +"           (accdoc.t_DisablingDate >= ? or accdoc.t_DisablingDate = TO_DATE('01-01-0001','DD-MM-YYYY') ) and " 
                +"           accdoc.t_FIID = ? "
                +"       Group by accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter "
                +"      ) acc ";

        var cmd = DL_RSDCommand(q);
        cmd.addParam( ondate );
//        cmd.addParam( ondate );
//        cmd.addParam( ondate );
        cmd.addParam( fiid );    
        var rs = cmd.Execute();
        if  ( rs.MoveNext() )    
            res = res + money(rs.amount);
        end;



        q = "select "
                +"      Nvl(Sum( abs(rsb_account.restac(acc.t_Account, acc.t_Currency, ?, acc.t_Chapter, null))  ), 0) amount "
                +" from (select accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter "
                +"         from DMCACCDOC_DBT accdoc, DMCCATEG_DBT categ " 
                +"        where  "
                +"           categ.t_ID = accdoc.t_catID and "
                +"           categ.t_Code IN ( '-Переоценка, ц/б ССПУ_ЦБ', '-Переоценка, ц/б СССД_ЦБ') and "
//                +"           accdoc.t_IsCommon <> 'X' and "
//                +"           accdoc.t_ActivateDate <= ? and " 
//                +"           (accdoc.t_DisablingDate >= ? or accdoc.t_DisablingDate = TO_DATE('01-01-0001','DD-MM-YYYY') ) and " 
                +"           accdoc.t_FIID = ? "
                +"       Group by accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter "
                +"      ) acc ";

        cmd = DL_RSDCommand(q);
        cmd.addParam( ondate );
//        cmd.addParam( ondate );
//        cmd.addParam( ondate );
        cmd.addParam( fiid );    
        rs = cmd.Execute();
        if  ( rs.MoveNext() )    
            res = res - money(rs.amount);
        end;

        return res;
    END;

PRIVATE CLASS (DL_CReportTemplate) DlWeekRep(Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER)
    PRIVATE VAR ErrorMesage = DL_TUniqStrCollector();
    var m_PanData           = weekRepPanData;   // weekRepPanData
    var m_repTypes          = TArray();         // Список отчетов
   
    initDL_CReportTemplate(Form, TemplateName, UseCSV, IsWebService, ReportHashCode);  

    MACRO AddErrMsg(ErrMsg:string)
        ErrorMesage.AddString(ErrMsg);
    END;

    MACRO GetPanData()
        return m_PanData;
    END;

    PRIVATE MACRO PrintMode():INTEGER
        return DL_OUTREPORT_EXCEL;
    END;

    MACRO AddReport(repObj)  
        m_repTypes(m_repTypes.size) = repObj;
    END;

    MACRO Create()
    
        var rep;
        for (rep, m_repTypes)
            rep.ExecuteReport();
        end;
    END;

    MACRO BeginReport(NumCopy:INTEGER)
    
        ErrorMesage.ClearArray();
        var rep; // Возможно потребуется перенести вызов DoBeginReport/DoEndReport (если будет больше одного отчета) в rep.ExecuteReport  
      /*  for (rep, m_repTypes)
            rep.DoBeginReport(this, NumCopy);
        end;*/
    END;

    MACRO EndReport()
    
        if(m_repTypes.size > 0)
           /* var rep;
            for (rep, m_repTypes)
                rep.DoEndReport(this);
            end;*/

            var i = 0;
            while (i < ErrorMesage.Size)
                msgbox(ErrorMesage[i]);
                i = i + 1;
            end;
        else
            msgbox("Нет данных для формирования отчета.");
        end;
    END;

    MACRO ExecuteReport(rep:OBJECT)
        rep.ExecuteReport();
    END;

    MACRO RegisterTableRep(rep:OBJECT) 
        rep.DoRegisterTable();
    END;

    MACRO PrintTableLineRep(rep:OBJECT)
        rep.DoPrintTableLine();        
    END;
    // ------- Print fields --------
    MACRO BeginDate() : date
        return m_PanData.startDate;
    END;

    MACRO EndDate() : date
        return m_PanData.endDate;
    END;
    // ------- end - print fields ------

END; // DlWeekRep_Report

//---------------------------
private CLASS RowDataRevalution(pIssuerName, pIssName, pIssISIN, pIssCateg, psumInvestStart, psumInvestEnd, pSumRevalutionStart, pSumRevalution)
    var issuerName: string = pIssuerName;
	var issName: string = pIssName;
    var issISIN: string = pIssISIN;
    var issCateg: string = pIssCateg;
    var sumInvestStart = psumInvestStart;
    var sumInvestEnd   = psumInvestEnd;
	var SumRevalutionStart = pSumRevalutionStart;
    var SumRevalution  = pSumRevalution;
END;

PRIVATE CLASS Rep_Revalution(weekRep: DlWeekRep)
    var m_weekRep    = weekRep;  // Класс который умеет печатать в Эксель
    var m_Numb       = 0;        // Номер строки
    var m_LinesCount = 0;        // Количество отобраных ЦБ
    var m_rowData    = null;     // RowDataRevalution - переоценка ЦБ - все данные по текущей строке
    var m_isTableRegistered = false;
    var m_since1     = Date(0,0,0);
    var m_since2     = Date(0,0,0);

// ------  printing fields  ----
    MACRO H0() : string
        return "За период с " + m_weekRep.BeginDate() +" по "+ m_weekRep.EndDate();
    END;     

    MACRO BeginDate() : date
        return m_weekRep.BeginDate();
    END;    

    MACRO EndDate() : date
        return m_weekRep.EndDate();
    END;

    private MACRO getCurrency(ondate: date, kind:integer) : double
        var res = 0.0, since: date;

        var fin = TRecHandler("fininstr.dbt");
        if(ПолучитьФинИн("840", fin, null, null, null, FICK_ISONUMBER) != 0)
            msgbox("Не найден финансовый инструмент по коду ISO: \"840\"");
            return 0;
        end;
        SmartConvertSumDbl(res, 1.0, ondate, fin.rec.FIID, NATCUR, 
                            true, null/*RATETYPE_CALC_PRICE*/, since);
        if (kind == 1)
           m_since1 = since;
        else
           m_since2 = since;
        end;
        return res;
    END;

// end ------- printing fields -------

    MACRO DoBeginReport()
       this.DoRegisterTable();
    END;

    MACRO DoEndReport()
        if (m_weekRep != NULL)
            m_weekRep.EndTable();
            m_weekRep.AddStandardFooter("N1_");
        end;
    END;

    MACRO ExecuteReport()
        var issCateg = "", Amount = $0;

        var query = " select party.t_ShortName t_IssuerName, fin.t_FIID,  fin.t_Name, fin.t_Fi_Code,  iss.t_isin"
                    +" from dfininstr_dbt fin, davoiriss_dbt iss, dparty_dbt party "
                    +" where  "
                    +"     fin.t_FIID = iss.t_FIID and "
					+"     (party.t_PartyID = fin.t_Issuer or party.t_PartyID is NULL) and "
                    +"     fin.t_FI_KIND = ?  and " // -- FIKIND_AVOIRISS 2
                    +"     (   (RSB_PMWRTOFF.WRTGETPORTFOLIOAMOUNT(1,fin.t_FIID,-1,0,:portfolio1,-1,:datebegin1,1,0,1 ) != 0) or " // Golovkin 08.12.2020 ID : 519868 WRTGETPORTFOLIOAMOUNT работает быстрее exists
                    +"         (RSB_PMWRTOFF.WRTGETPORTFOLIOAMOUNT(1,fin.t_FIID,-1,0,:portfolio2,-1,:datebegin2,1,0,1 ) != 0) or "
                    +"         (RSB_PMWRTOFF.WRTGETPORTFOLIOAMOUNT(1,fin.t_FIID,-1,0,:portfolio12,-1,:dateend1,1,0,1 ) != 0) or  "
                    +"         (RSB_PMWRTOFF.WRTGETPORTFOLIOAMOUNT(1,fin.t_FIID,-1,0,:portfolio22,-1,:dateend2,1,0,1 ) != 0) )   ";
/*
                    +"     ( exists ( select s.t_FIID from v_scwrthistex s "
                    +"               where s.t_Amount > 0 and "
                    +"                     s.t_FIID = fin.t_FIID and "
                    +"                     s.t_State in (?,?) and " // -- PM_WRTSUM_FORM 1 , PM_WRTSUM_SALE_BPP 3
                    +"                     s.t_Portfolio in ( ?,? ) and " //  -- KINDPORT_TRADE = 1, KINDPORT_SALE = 2  
                    +"                     s.t_Buy_Sale = ? and "//  PM_WRITEOFF_SUM_BUY  = 0,  //Зачисление;
                    +"                     s.t_Instance = ( "
                    +"                                     select max(t_Instance) "
                    +"                                       from v_scwrthistex  "
                    +"                                      where "
                    +"                                            t_sumid = s.t_sumid and "
                    +"                                            t_changedate <= ? " //дата начала  
                    +"                                    ) "
                    +"              ) or "
                    +"       exists ( select s.t_FIID from v_scwrthistex s "
                    +"               where s.t_Amount > 0 and "
                    +"                     s.t_FIID = fin.t_FIID and "
                    +"                     s.t_State in (?,?) and " // -- PM_WRTSUM_FORM 1 , PM_WRTSUM_SALE_BPP 3
                    +"                     s.t_Portfolio in ( ?,? ) and " //  -- KINDPORT_TRADE = 1, KINDPORT_SALE = 2  
                    +"                     s.t_Buy_Sale = ? and "//  PM_WRITEOFF_SUM_BUY  = 0,  //Зачисление;
                    +"                     s.t_Instance = ( "
                    +"                                     select max(t_Instance) "
                    +"                                       from v_scwrthistex  "
                    +"                                      where "
                    +"                                            t_sumid = s.t_sumid and "
                    +"                                            t_changedate <= ? " //дата окончания
                    +"                                    ) "
                    +"             ) "
                    +"     ) ";
*/
        var ds;
        var cmd = DL_RSDCommand(query);
        cmd.addParam( FIKIND_AVOIRISS );
/*
        cmd.addParam( PM_WRTSUM_FORM ); cmd.addParam(PM_WRTSUM_SALE_BPP );
        cmd.addParam( KINDPORT_TRADE);  cmd.addParam(KINDPORT_SALE);
        cmd.addParam( PM_WRITEOFF_SUM_BUY );
        cmd.addParam( BeginDate ); 

        cmd.addParam( PM_WRTSUM_FORM ); cmd.addParam(PM_WRTSUM_SALE_BPP );
        cmd.addParam( KINDPORT_TRADE);  cmd.addParam(KINDPORT_SALE);
        cmd.addParam( PM_WRITEOFF_SUM_BUY );
        cmd.addParam( EndDate() );  
*/    
        cmd.addParam( KINDPORT_TRADE);
        cmd.addParam( BeginDate );
        cmd.addParam(KINDPORT_SALE);
        cmd.addParam( BeginDate );
        cmd.addParam( KINDPORT_TRADE);
        cmd.addParam( EndDate() );
        cmd.addParam(KINDPORT_SALE);
        cmd.addParam( EndDate() );

        m_LinesCount = cmd.GetCount();
        if (m_LinesCount > 0)
            var ProgressIndicator = TProgressBar();
            ProgressIndicator.init(m_LinesCount, "Отбор бумаг для отчета", "Переоценка ЦБ");

            this.DoBeginReport();
            
            var fake = true;
            var sum = 0;
			var sumEnd = 0;
            while (true)
                ds = cmd.Execute();
                while (ds.MoveNext())
                    if (fake)
                        sum    = sum + getAccRestOverval(SQL_ConvTypeInteger(ds.FIID), BeginDate()-1);
						sumEnd = sumEnd + getAccRestOverval(SQL_ConvTypeInteger(ds.FIID), EndDate());
                    else
                        Amount = WRTGetPortfolioAmount(-1, SQL_ConvTypeInteger(ds.FIID), -1, 0, KINDPORT_SALE, -1, BeginDate, true, false, true );
                        if (Amount == $0)
                           Amount = WRTGetPortfolioAmount(-1, SQL_ConvTypeInteger(ds.FIID), -1, 0, KINDPORT_SALE, -1, EndDate(), true, false, true );
                        end;

                        if (Amount > $0)
                           issCateg = "2";
                        else
                           issCateg = "1";
                        end;

                        m_rowData = RowDataRevalution( ds.IssuerName, ds.Name, ds.ISIN, issCateg,
                                                       getAccRest(SQL_ConvTypeInteger(ds.FIID), BeginDate()-1), 
                                                       getAccRest(SQL_ConvTypeInteger(ds.FIID), EndDate()),
                                                       getAccRestOverval(SQL_ConvTypeInteger(ds.FIID), BeginDate()-1),
                                                       getAccRestOverval(SQL_ConvTypeInteger(ds.FIID), EndDate())
                                                     );

                        this.DoPrintTableLine();
                        ProgressIndicator.Use;
                    end;
                end;

                if (fake == false)
                    break;
                else
                    fake = false;
                    this.DoPrintTableLineSum(sum, sumEnd);
                end;
            end;

            this.DoEndReport();

            ProgressIndicator.Remove();
        end;
    END;

    MACRO DoRegisterTable()
        m_weekRep.SetActiveSheet("ПереоценкаЦБ");
        var Curr1 = getCurrency(BeginDate(), 1);
        var Curr2 = getCurrency(EndDate(), 2);

        m_weekRep.PrintFormatString("",
                            "N1_H0", H0(),
                            "N1_B1", "Курс на " + m_since1,
                            "N1_B2", "Курс на " + m_since2,
                            "N1_D1", Curr1,
                            "N1_D2", Curr2 
                       );
 
        m_weekRep.RegisterTable("N1_MainTable", "",
                                "N1_Numb",
								"N1_Issuer_Name",
                                "N1_ISS_Name",
                                "N1_ISS_Code",
                                "N1_SumInvest_Start",
                                "SumInvest_End",
								"SumRevalution_Start",
                                "SumRevalution_End",
                                "ISS_Categ"
                           );  
        m_isTableRegistered = true;   
    END;

    MACRO DoPrintTableLine()
        if (not m_isTableRegistered)
            m_weekRep.RegisterTableRep(this);
        end;

        m_Numb = m_Numb + 1;
        m_weekRep.PrintTableLine(
                    "N1_Numb",              m_Numb,                     null,
                    "N1_Issuer_Name",       m_rowData.IssuerName,       null,
                    "N1_ISS_Name",          m_rowData.issName,          null,
                    "N1_ISS_Code",          m_rowData.issISIN,          null,
                    "N1_SumInvest_Start",   m_rowData.sumInvestStart,   null,
                    "N1_SumInvest_End",     m_rowData.SumInvestEnd,     null,
                    "N1_SumRevalution_Start", m_rowData.SumRevalutionStart, null,
                    "N1_SumRevalution_End", m_rowData.SumRevalution,    null,
                    "N1_ISS_Categ",         m_rowData.issCateg,         null
               );
    END; 

    MACRO DoPrintTableLineSum(sumStart, sum)
        if (not m_isTableRegistered)
            m_weekRep.RegisterTableRep(this);
        end;

        m_weekRep.PrintTableLine(
                    "N1_Numb",              "",      null,
                    "N1_Issuer_Name",       "",      null,
                    "N1_ISS_Name",          "",      null,
                    "N1_ISS_Code",          "",      null,
                    "N1_SumInvest_Start",   "",      null,
                    "N1_SumInvest_End",     "",      null,
                    "N1_SumRevalution_Start", sumStart, null,
                    "N1_SumRevalution_End", sum,      null,
                    "N1_ISS_Categ",         "",      null
               );
    END; 
END;

////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////

//---------------------------
private macro GetSaleAcc(BOfficeKind:integer, DealID:integer, SaleSumID:integer, deliveryDate:date)
  var query, cmd, DataSet, query2, cmd2, DataSet2;
  var lotBuy = TRecHandler("pmwrtsum.dbt");
  var FDBuy = NULL;
  var DealBuy = TBFile("dl_tick.dbt");
  var acc = TRecHandler( "account" );
  var account = "";
         
  query =   " select lot.* "
          + "   from dpmwrtlnk_dbt lnk, dpmwrtsum_dbt lot "
          + "  where lnk.t_SaleID = ? "
          + "    and lot.t_SumID = lnk.t_BuyID"
          + "    and not Exists(select 1 "
          + "                     from dpmwrtlnk_dbt lnk1, dpmwrtsum_dbt lot1 "
          + "                    where lnk1.t_SaleID = lnk.t_SaleID "
          + "                      and lot1.t_SumID = lnk1.t_BuyID "
          + "                      and lot1.t_Portfolio != lot.t_Portfolio "
          + "                  )"
          + "    and rownum = 1" ;

  cmd = DL_RSDCommand(query);

  cmd.AddParam(SaleSumID);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    DataSet.GetRecord().CopyTo(lotBuy.rec);

    DealBuy.Clear();
    DealBuy.rec.DealID = lotBuy.rec.DealID;
    if(DealBuy.GetEQ())
      var LegKind = GetLegKindByLotDeal(lotBuy.rec, DealBuy.rec);
      var IsBack  = (LegKind == LEG_KIND_DL_TICK_BACK);

      FDBuy = SPFirstDoc(DealBuy, IsBack);

      acc = ЛСчетНаКоторомУчитываетсяЛот(lotBuy.rec, deliveryDate, FDBuy, 1);
      account = acc.Account;

      if (account == "") // случай - счёт закрыт, получим из проводки
         query2 =   "     select acc.t_Account "
                  + "       from ddlgrdeal_dbt grd, ddlgrdoc_dbt grdoc, dacctrn_dbt acctrn, daccount_dbt acc "
                  + "      where grd.t_DocKind = ? "
                  + "        and grd.t_DocID = ? "
                  + "        and grdoc.t_GrDealID = grd.t_ID "
                  + "        and grdoc.t_DocKind = " + DLDOC_CARRY
                  + "        and acctrn.t_AccTrnID = grdoc.t_DocID "
                  + "        and acc.t_AccountID = acctrn.t_AccountID_Receiver "
                  + "        and Exists(select 1"
                  + "                     from dmcaccdoc_dbt accdoc, dmccateg_dbt cat "
                  + "                    where accdoc.t_Account = acc.t_Account "
                  + "                      and accdoc.t_Chapter = acc.t_Chapter "
                  + "                      and accdoc.t_Currency = acc.t_Code_Currency "
                  + "                      and cat.t_ID = accdoc.t_CatID "
                  + "                      and cat.t_Code = 'Наш портфель ц/б' "
                  + "                  )"
                  + "        and ROWNUM = 1 ";
         cmd2 = DL_RSDCommand(query2);

         cmd2.AddParam(BOfficeKind);
         cmd2.AddParam(DealID);

         DataSet2 = cmd2.Execute();
         if(DataSet2.moveNext())
            account = SQL_ConvTypeStr(DataSet2.Account);
         end;

      end;

    end;

  end;

  return account;

end;


private CLASS RowDataBuySale(ds:OBJECT, isMarket)
    var IssuerName = "";
    var dealDate = date(0,0,0);
    var contractor = -1, contractorName = "";
    var issName = ds.finame;
    var issISIN = ds.isin;
    var amount = 0;
    var sumNKD_CUR = 0;
    var sumNKD_RUB = 0;
    var price = "";
    var dealType = "";
    var currency = -1, currencyCCY = "";
    var paymDate = date(0,0,0);
    var deliveryDate = date(0,0,0);
    var finResult = 0;
    var acc = TRecHandler( "account" );
    var account = "";
    var dealNum = "";
    var portfolioCode = ds.PortfolioCode;
    
    var FD = SPFirstDoc(LEG_KIND_DL_TICK, ds.DealID);

    IssuerName = ds.IssuerName;

    dealDate = FD.tick.rec.DealDate;
    
    dealNum  = iif(FD.tick.rec.DealCodeTS != "", FD.tick.rec.DealCodeTS, FD.tick.rec.DealCode);

 /*   if(not isMarket)// Golovkin 05.09.2019 ID : 494139
        dealNum = FD.tick.rec.DealCodeTS;
    end;*/
    if(not isMarket)// DAN
        dealNum = FD.tick.rec.DealCode;
    end;

    amount = FD.dl_leg.rec.Principal;

    paymDate = FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.FactDate;
    if(paymDate == date(0,0,0))
      paymDate = FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.PlanDate;
    end;

    deliveryDate = date(ds.FactDate);

    sumNKD_CUR = FD.dl_leg.rec.TotalCost;
    if(FD.dl_leg.rec.CFI != NATCUR)
      ConvSum(sumNKD_RUB, sumNKD_CUR, FD.dl_leg.rec.Maturity, FD.dl_leg.rec.CFI, NATCUR);
    else
      sumNKD_RUB = sumNKD_CUR;
    end;
    
    if (FD.tick.rec.BOfficeKind == DL_SECURITYDOC)
        contractor  = FD.tick.rec.PartyID;
        
        if(IsBuy(FD.Group))
            dealType = "Покупка";
            acc = ЛСчетНаКоторомУчитываетсяЛот(FD.pmwrtsum.rec, deliveryDate, FD);
            account = acc.Account;
        else
            dealType = "Продажа";
            account = GetSaleAcc(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.pmwrtsum.rec.SumID, deliveryDate);
        end;

        price = FD.dl_leg.rec.Price;
        if(FD.dl_leg.rec.RelativePrice == SET_CHAR)
          price = string(price) + "%";
        end;

    elif (FD.tick.rec.BOfficeKind == DL_RETIREMENT)
        contractor = FI_GetIssuerOnDate(FD.tick.rec.PFI, dealDate);
        dealType = "Ч/П";
        if(not IsRET_PARTLY(FD.Group))
           price = "100%";
           dealType = "Погашение";
        end;

        account = GetSaleAcc(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.pmwrtsum.rec.SumID, deliveryDate);
    end;

    if(contractor != -1)
      contractorName = GetPartyShortNameByID(contractor);
    end;

    currency = int(ds.Curr);
    if(currency != -1)
      currencyCCY    = GetFinInstrCcy(currency, true, false);
    end;

    finResult = money(ds.PlusFR - ds.MinusFR);

END;

PRIVATE CLASS Rep_BuySale(weekRep: DlWeekRep)
    var m_weekRep    = weekRep;  // Класс который умеет печатать в Эксель
    var m_Numb       = 0;        // Номер строки
    var m_LinesCount = 0;        // Количество отобраных ЦБ
    var m_rowData    = null;     // RowDataBuySale - переоценка ЦБ - все данные по текущей строке
    var m_isTableRegistered = false;
// ------  printing fields  ----
    MACRO H0() : string
        return "За период с " + m_weekRep.BeginDate() +" по "+ m_weekRep.EndDate();
    END;     

    MACRO BeginDate() : date
        return m_weekRep.BeginDate();
    END;    

    MACRO EndDate() : date
        return m_weekRep.EndDate();
    END;

 
// end ------- printing fields -------

    MACRO DoBeginReport()
        m_weekRep.SetActiveSheet("СделкиПокупкиПродажи");
        m_weekRep.PrintFormatString("", "N2_H0", H0());
    END;

    MACRO DoEndReport()
        if (m_weekRep != NULL)
            m_weekRep.EndTable();
        end;
    END;

    macro get_select(isMarket:bool)
        var query =   " select party.t_ShortName t_IssuerName, tk.t_DealID, gracc.t_FactDate, llv.t_Code as PortfolioCode, "
                    + "        fin.t_name finame, avr.t_isin isin, "
                    + "        (CASE WHEN tk.t_BOfficeKind = "+DL_RETIREMENT+" THEN fin.t_FaceValueFI ELSE leg.t_CFI END) as Curr, "
                    + "        NVL((select SUM(acctrn.t_Sum_Receiver)"
                    + "               from ddlgrdeal_dbt grd, ddlgrdoc_dbt grdoc, dacctrn_dbt acctrn, daccount_dbt accP, daccount_dbt accR "
                    + "              where grd.t_DocKind = tk.t_BOfficeKind "
                    + "                and grd.t_DocID = tk.t_DealID "
                    + "                and grdoc.t_GrDealID = grd.t_ID "
                    + "                and grdoc.t_DocKind = " + DLDOC_CARRY
                    + "                and acctrn.t_AccTrnID = grdoc.t_DocID "
                    + "                and accP.t_AccountID = acctrn.t_AccountID_Payer "
                    + "                and accR.t_AccountID = acctrn.t_AccountID_Receiver "
                    + "                and Exists(select 1"
                    + "                             from dmcaccdoc_dbt accdoc, dmccateg_dbt cat "
                    + "                            where accdoc.t_Account = accP.t_Account "
                    + "                              and accdoc.t_Chapter = accP.t_Chapter "
                    + "                              and accdoc.t_Currency = accP.t_Code_Currency "
                    + "                              and cat.t_ID = accdoc.t_CatID "
                    + "                              and cat.t_Code = 'Реализация, ц/б' "
                    + "                          )"
                    + "                and Exists(select 1"
                    + "                             from dmcaccdoc_dbt accdoc, dmccateg_dbt cat "
                    + "                            where accdoc.t_Account = accR.t_Account "
                    + "                              and accdoc.t_Chapter = accR.t_Chapter "
                    + "                              and accdoc.t_Currency = accR.t_Code_Currency "
                    + "                              and cat.t_ID = accdoc.t_CatID "
                    + "                              and cat.t_Code = '+Маржа, ц/б' "
                    + "                          )"
                    + "            ), 0) as PlusFR, "
                    + "        NVL((select SUM(acctrn.t_Sum_Payer)"
                    + "               from ddlgrdeal_dbt grd, ddlgrdoc_dbt grdoc, dacctrn_dbt acctrn, daccount_dbt accP, daccount_dbt accR "
                    + "              where grd.t_DocKind = tk.t_BOfficeKind "
                    + "                and grd.t_DocID = tk.t_DealID "
                    + "                and grdoc.t_GrDealID = grd.t_ID "
                    + "                and grdoc.t_DocKind = " + DLDOC_CARRY
                    + "                and acctrn.t_AccTrnID = grdoc.t_DocID "
                    + "                and accP.t_AccountID = acctrn.t_AccountID_Payer "
                    + "                and accR.t_AccountID = acctrn.t_AccountID_Receiver "
                    + "                and Exists(select 1"
                    + "                             from dmcaccdoc_dbt accdoc, dmccateg_dbt cat "
                    + "                            where accdoc.t_Account = accP.t_Account "
                    + "                              and accdoc.t_Chapter = accP.t_Chapter "
                    + "                              and accdoc.t_Currency = accP.t_Code_Currency "
                    + "                              and cat.t_ID = accdoc.t_CatID "
                    + "                              and cat.t_Code = '-Маржа, ц/б' "
                    + "                          )"
                    + "                and Exists(select 1"
                    + "                             from dmcaccdoc_dbt accdoc, dmccateg_dbt cat "
                    + "                            where accdoc.t_Account = accR.t_Account "
                    + "                              and accdoc.t_Chapter = accR.t_Chapter "
                    + "                              and accdoc.t_Currency = accR.t_Code_Currency "
                    + "                              and cat.t_ID = accdoc.t_CatID "
                    + "                              and cat.t_Code = 'Реализация, ц/б' "
                    + "                          )"
                    + "            ), 0) as MinusFR "
                    + "   from ddl_tick_dbt tk, ddlgrdeal_dbt grdeal, ddlgracc_dbt gracc, ddl_leg_dbt leg, dllvalues_dbt llv, "
                    + "        dfininstr_dbt fin, davoiriss_dbt avr, dparty_dbt party "
                    + "  where ((tk.t_BOfficeKind = "+DL_SECURITYDOC
                    + "         and RSB_SECUR.IsTwoPart(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) = 0 "
                    + "         ) or (tk.t_BOfficeKind = " + DL_RETIREMENT
                    + "               and RSB_SECUR.IsRet_Coupon(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) = 0"
                    + "             )"
                    + "        )" 
                    + "    and grdeal.t_DocKind = tk.t_BOfficeKind "
                    + "    and grdeal.t_DocID = tk.t_DealID "
                    + "    and grdeal.t_TemplNum = " + DLGR_TEMPL_RECDELIVERY
                    + "    and gracc.t_GrDealID = grdeal.t_ID "
                    + "    and gracc.t_AccNum = " + DLGR_ACCKIND_ACCOUNTING
                    + "    and gracc.t_State = " + DLGRACC_STATE_FACTEXEC
                    + "    and gracc.t_FactDate >= ? "
                    + "    and gracc.t_FactDate <= ? "
                    + "    and leg.t_DealID = tk.t_DealID "
                    + "    and leg.t_LegID = 0 "
                    + "    and leg.t_LegKind = " + LEG_KIND_DL_TICK
                    + "    and llv.t_List (+)= " + OBJTYPE_KINDPORT
                    + "    and llv.t_Element (+)= tk.t_PortfolioID "
                    + "    and fin.t_FIID = tk.t_PFI "
                    + "    and avr.t_FIID = fin.t_FIID"
                    + "    and (party.t_PartyID = fin.t_Issuer or party.t_PartyID is NULL)";


        if(isMarket == true)
           query = query + " and 1 = (CASE WHEN tk.t_BOfficeKind = " + DL_RETIREMENT + " THEN (CASE WHEN tk.t_Flag1 = chr(88) THEN 1 ELSE 0 END) "
                         + "               ELSE RSB_SECUR.IsExchange(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind)),1) "
                         + "               END )";

        else
           query = query + " and 1 = (CASE WHEN tk.t_BOfficeKind = " + DL_RETIREMENT + " THEN (CASE WHEN tk.t_Flag1 = chr(0) THEN 1 ELSE 0 END) "
                         + "               ELSE RSB_SECUR.IsOutExchange(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind)),1) "
                         + "               END )";
        end;

        query = query + " order by (CASE WHEN tk.t_BOfficeKind = "+DL_RETIREMENT+" THEN fin.t_FaceValueFI ELSE leg.t_CFI END), tk.t_DealDate, tk.t_DealTime ";
        
        return query;
    end;

    MACRO ExecuteReport()
        var ds;
        var prevCurr = -1, prevCurrCCY = "";
        var ItogAmount = 0;
        var ItogSumCFI = 0;
        var ItogSumRUR = 0;
        var ItogFR     = 0;
        var stat = 0;

        var ProgressIndicator;
        var ProgressIndicator2;

        m_weekRep.SetActiveSheet("СделкиПокупкиПродажи");
        m_weekRep.PrintFormatString("", "N2_H0", H0());

//!!
        var query = get_select(true);
        var cmd = DL_RSDCommand(query);
        cmd.addParam(BeginDate); 
        cmd.addParam(EndDate());
    
        m_LinesCount = cmd.GetCount();
        var have_data = false;
        if (m_LinesCount > 0)
//!! Печать - биржевые или внебиржа
            have_data = true;
            ProgressIndicator = TProgressBar();
            ProgressIndicator.init(m_LinesCount, "Отбор сделок для отчета", "Сделки покупки/продажи");

            this.DoBeginReport();
            
            ds = cmd.Execute();
            stat = ds.moveNext();
            while(stat)
                m_rowData = RowDataBuySale(ds, true);
                this.DoPrintTableLine_1();

                ItogAmount = ItogAmount + m_rowData.Amount;
                ItogSumCFI = ItogSumCFI + m_rowData.sumNKD_CUR;
                ItogSumRUR = ItogSumRUR + m_rowData.sumNKD_RUB;
                ItogFR     = ItogFR + m_rowData.finResult;

                prevCurrCCY = m_rowData.currencyCCY;
                prevCurr    = m_rowData.currency;

                stat = ds.moveNext();

                if((stat == 0) or (prevCurr != int(ds.Curr)))
                  this.DoPrintItogTableLine_1(prevCurrCCY, ItogAmount, ItogSumCFI, ItogSumRUR, ItogFR);
                  ItogAmount = 0; 
                  ItogSumCFI = 0;
                  ItogSumRUR = 0;
                  ItogFR     = 0;
                  m_Numb     = 0;
                end;
                
                ProgressIndicator.Use;
            end;
            this.DoEndReport();
        end;

        m_isTableRegistered = false;
        m_Numb = 0;

//!!
        query = get_select(false);
        cmd = DL_RSDCommand(query);
        cmd.addParam(BeginDate()); 
        cmd.addParam(EndDate());
    
        m_LinesCount = cmd.GetCount();
        if (m_LinesCount > 0)
            ProgressIndicator2 = TProgressBar();
            ProgressIndicator2.init(m_LinesCount, "Отбор сделок для отчета", "Сделки покупки/продажи");
            if (have_data == false)
              this.DoBeginReport();
            end;
            have_data = true;
            
            prevCurr = -1;
            ds = cmd.Execute();
            stat = ds.moveNext();
            while(stat)
                m_rowData = RowDataBuySale(ds, false);
                this.DoPrintTableLine_2();

                ItogAmount = ItogAmount + m_rowData.Amount;
                ItogSumCFI = ItogSumCFI + m_rowData.sumNKD_CUR;
                ItogSumRUR = ItogSumRUR + m_rowData.sumNKD_RUB;
                ItogFR     = ItogFR + m_rowData.finResult;

                prevCurrCCY = m_rowData.currencyCCY;
                prevCurr    = m_rowData.currency;

                stat = ds.moveNext();

                if((stat == 0) or (prevCurr != int(ds.Curr)))
                  this.DoPrintItogTableLine_2(prevCurrCCY, ItogAmount, ItogSumCFI, ItogSumRUR, ItogFR);
                  ItogAmount = 0; 
                  ItogSumCFI = 0;
                  ItogSumRUR = 0;
                  ItogFR     = 0;
                  
                  m_Numb     = 0;
                end;

                ProgressIndicator2.Use;
            end;


            this.DoEndReport();
        end;

        if (have_data == true)
            if (ProgressIndicator != null)
              ProgressIndicator.Remove();
            end;
            if (ProgressIndicator2 != null) /*GAA: 538845 */
              ProgressIndicator2.Remove();
            end;/*GAA*/
        end;
    END;

    MACRO DoRegisterTable_1()
        m_weekRep.RegisterTable("N2_LineTable1", "",
                                "N2_A1",
                                "N2_B1",
                                "N2_C1",
                                "N2_D1",
                                "N2_E1",
                                "N2_F1",
                                "N2_G1",
                                "N2_H1",
                                "N2_I1",
                                "N2_J1",
                                "N2_K1",
                                "N2_L1",
                                "N2_M1",
                                "N2_N1",
                                "N2_O1",
                                "N2_P1",
                                "N2_Q1",
                                "N2_R1");
        m_isTableRegistered = true;   
    END;

    MACRO DoPrintTableLine_1()
        if (not m_isTableRegistered)
            DoRegisterTable_1();
        end;

        m_Numb = m_Numb + 1;
        m_weekRep.PrintTableLine(
                    "N2_A1", m_Numb, null,
                    "N2_B1", m_rowData.dealDate, null,
                    "N2_C1", m_rowData.contractorName, null,
                    "N2_D1", m_rowData.issuerName, null,
                    "N2_E1", m_rowData.issName, null,
                    "N2_F1", m_rowData.issISIN, null,
                    "N2_G1", m_rowData.amount, null,
                    "N2_H1", m_rowData.sumNKD_CUR, null,
                    "N2_I1", m_rowData.sumNKD_RUB, null,
                    "N2_J1", m_rowData.price, null,
                    "N2_K1", m_rowData.dealType, null,
                    "N2_L1", m_rowData.currencyCCY, null,
                    "N2_M1", m_rowData.paymDate, null,
                    "N2_N1", m_rowData.deliveryDate, null,
                    "N2_O1", m_rowData.finResult, null,
                    "N2_P1", m_rowData.account, null,
                    "N2_Q1", m_rowData.dealNum, null,
                    "N2_R1", m_rowData.portfolioCode, null);
    END; 

    MACRO DoPrintItogTableLine_1(CurrCCY, ItogAmount, ItogSumCFI, ItogSumRUR, ItogFR)
       
        m_weekRep.Merge("N2_E3", "N2_F3", null);
        
        m_weekRep.PrintTableLine(
                    "N2_A3", "", null,
                    "N2_B3", "", null,
                    "N2_C3", "", null,
                    "N2_D3", "", null,
                    "N2_E3", "Итого в "+CurrCCY+":", null,
                    "N2_F3", "", null,
                    "N2_G3", ItogAmount, null,
                    "N2_H3", ItogSumCFI, null,
                    "N2_I3", ItogSumRUR, null,
                    "N2_J3", "", null,
                    "N2_K3", "", null,
                    "N2_L3", "", null,
                    "N2_M3", "", null,
                    "N2_N3", "", null,
                    "N2_O3", ItogFR, null,
                    "N2_P3", "", null,
                    "N2_Q3", "", null,
                    "N2_R3", "", null);
    END;

    MACRO DoRegisterTable_2()
        m_weekRep.RegisterTable("N2_LineTable2", "",
                                "N2_A2",
                                "N2_B2",
                                "N2_C2",
                                "N2_D2",
                                "N2_E2",
                                "N2_F2",
                                "N2_G2",
                                "N2_H2",
                                "N2_I2",
                                "N2_J2",
                                "N2_K2",
                                "N2_L2",
                                "N2_M2",
                                "N2_N2",
                                "N2_O2",
                                "N2_P2",
                                "N2_Q2",
                                "N2_R2");
        m_isTableRegistered = true;   
    END;

    MACRO DoPrintTableLine_2()
        if (not m_isTableRegistered)
            DoRegisterTable_2();
        end;

        m_Numb = m_Numb + 1;
        m_weekRep.PrintTableLine(
                    "N2_A2", m_Numb, null,
                    "N2_B2", m_rowData.dealDate, null,
                    "N2_C2", m_rowData.contractorName, null,
                    "N2_D2", m_rowData.issuerName, null,
                    "N2_E2", m_rowData.issName, null,
                    "N2_F2", m_rowData.issISIN, null,
                    "N2_G2", m_rowData.amount, null,
                    "N2_H2", m_rowData.sumNKD_CUR, null,
                    "N2_I2", m_rowData.sumNKD_RUB, null,
                    "N2_J2", m_rowData.price, null,
                    "N2_K2", m_rowData.dealType, null,
                    "N2_L2", m_rowData.currencyCCY, null,
                    "N2_M2", m_rowData.paymDate, null,
                    "N2_N2", m_rowData.deliveryDate, null,
                    "N2_O2", m_rowData.finResult, null,
                    "N2_P2", m_rowData.account, null,
                    "N2_Q2", m_rowData.dealNum, null,
                    "N2_R2", m_rowData.portfolioCode, null);
    END; 

    MACRO DoPrintItogTableLine_2(CurrCCY, ItogAmount, ItogSumCFI, ItogSumRUR, ItogFR)
       
        m_weekRep.Merge("N2_E4", "N2_F4", null);
        
        m_weekRep.PrintTableLine(
                    "N2_A4", "", null,
                    "N2_B4", "", null,
                    "N2_C4", "", null,
                    "N2_D4", "", null,
                    "N2_E4", "Итого в "+CurrCCY+":", null,
                    "N2_F4", "", null,
                    "N2_G4", ItogAmount, null,
                    "N2_H4", ItogSumCFI, null,
                    "N2_I4", ItogSumRUR, null,
                    "N2_J4", "", null,
                    "N2_K4", "", null,
                    "N2_L4", "", null,
                    "N2_M4", "", null,
                    "N2_N4", "", null,
                    "N2_O4", ItogFR, null,
                    "N2_P4", "", null,
                    "N2_Q4", "", null,
                    "N2_R4", "", null);
    END;
END;

////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////

//---------------------------
private CLASS RowDataREPO(ds:OBJECT)
    var contractorName = "";
    var dealDate = date(0,0,0);
    var deliveryDate_1 = date(0,0,0);
    var deliveryDate_2 = date(0,0,0);
    var sumNKD_1 = $0;
    var sumNKD_2 = $0;
    var currencyCCY = "";
    var rate = 0;
    var issuerName = "";
    var issName = "";
    var issISIN = "";
    var amount = 0;
    var dealNum = "";
    var dealType = "";


    contractorName = GetPartyShortNameByID(ds.PartyID);
    dealDate       = date(ds.DealDate);
    deliveryDate_1 = date(ds.SupplyDate1);
    deliveryDate_2 = date(ds.SupplyDate2);
    sumNKD_1       = ds.TotalCost1;
    sumNKD_2       = ds.TotalCost2;
    currencyCCY    = GetFinInstrCcy(ds.CFI, true, false);
    rate           = ds.IncomeRate;
    issuerName     = ds.IssuerName;
    issName        = ds.finame;
    issISIN        = ds.isin;
    amount         = ds.Principal1;

    dealNum = ds.DealCodeTS;
    if(dealNum == "")
      dealNum = ds.DealCode;
    end;

    if (ds.IsSale == 1)
       dealType      = "Прямое РЕПО";
    else
       dealType      = "Обратное РЕПО";
    end;

END;

PRIVATE CLASS Rep_REPO(weekRep: DlWeekRep)
    var m_weekRep    = weekRep;  // Класс который умеет печатать в Эксель
    var m_Numb       = 0;        // Номер строки
    var m_LinesCount = 0;        // Количество отобраных ЦБ
    var m_rowData    = null;     // RowDataREPO - переоценка ЦБ - все данные по текущей строке
    var m_isTableRegistered = false;
// ------  printing fields  ----
    MACRO H0() : string
        return "За период с " + m_weekRep.BeginDate() +" по "+ m_weekRep.EndDate();
    END;     

    MACRO BeginDate() : date
        return m_weekRep.BeginDate();
    END;    

    MACRO EndDate() : date
        return m_weekRep.EndDate();
    END;

    private MACRO getCurrency(since:date, ondate: date) : money
        var res = $0;

        var fin = TRecHandler("fininstr.dbt");
        if(ПолучитьФинИн("840", fin, null, null, null, FICK_ISONUMBER) != 0)
            msgbox("Не найден финансовый инструмент по коду ISO: \"840\"");
            return 0;
        end;

        SmartConvertSumDbl(res, 1.0, ondate, fin.rec.FIID, NATCUR, 
                            true, RATETYPE_CALC_PRICE, since);
        return res;
    END;

    MACRO Curr1() : money
        return getCurrency(BeginDate(), BeginDate());
    END; 

    MACRO Curr2() : money
        return getCurrency(BeginDate(), EndDate());
    END;
    
// end ------- printing fields -------

    MACRO DoBeginReport()
       this.DoRegisterTable();
    END;

    MACRO DoEndReport()
        if (m_weekRep != NULL)
            m_weekRep.EndTable();
            //m_weekRep.AddStandardFooter("N1_");
        end;
    END;

    MACRO ExecuteReport()
        var ItogTotalCost1 = 0, ItogTotalCost2 = 0;
        var prevCFI = -1;
        var precCCY = "";
        var stat = 0;

        var query =   " select party.t_ShortName t_IssuerName, tk.t_DealID, tk.t_PartyID, tk.t_DealDate, tk.t_DealCode, tk.t_DealCodeTS, "
                    + "        leg1.t_TotalCost as TotalCost1, leg2.t_TotalCost as TotalCost2, leg1.t_CFI, (CASE WHEN leg2.t_isflrate = CHR(88) THEN RSB_SECUR.GetIncRateOnDate(tk.t_DealID, tk.t_BOfficeKind, ?) ELSE leg1.t_IncomeRate END) IncomeRate, "
                    + "        leg1.t_Principal as Principal1, opr.t_Name as DealTypeName, RSB_SECUR.IsSale(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) IsSale, "
                    + "        fin.t_name finame, avr.t_isin isin, "
                    + "        NVL((select gracc.t_FactDate "
                    + "               from ddlgrdeal_dbt grdeal, ddlgracc_dbt gracc "
                    + "              where grdeal.t_DocKind = tk.t_BOfficeKind "
                    + "                and grdeal.t_DocID = tk.t_DealID "
                    + "                and grdeal.t_TemplNum = " + DLGR_TEMPL_RECDELIVERY
                    + "                and gracc.t_GrDealID = grdeal.t_ID "
                    + "                and gracc.t_AccNum = " + DLGR_ACCKIND_ACCOUNTING
                    + "                and gracc.t_State = " + DLGRACC_STATE_FACTEXEC
                    + "                and rownum = 1 "
                    + "            ), RSB_SECUR.GetDealSupplyDate1(leg1.t_MaturityIsPrincipal, leg1.t_Maturity, leg1.t_Expiry)) as SupplyDate1, "
                    + "        NVL((select gracc.t_FactDate "
                    + "               from ddlgrdeal_dbt grdeal, ddlgracc_dbt gracc "
                    + "              where grdeal.t_DocKind = tk.t_BOfficeKind "
                    + "                and grdeal.t_DocID = tk.t_DealID "
                    + "                and grdeal.t_TemplNum = " + DLGR_TEMPL_RECDELIVERY2
                    + "                and gracc.t_GrDealID = grdeal.t_ID "
                    + "                and gracc.t_AccNum = " + DLGR_ACCKIND_ACCOUNTING
                    + "                and gracc.t_State = " + DLGRACC_STATE_FACTEXEC
                    + "                and rownum = 1 "
                    + "            ), RSB_SECUR.GetDealSupplyDate1(leg2.t_MaturityIsPrincipal, leg2.t_Maturity, leg2.t_Expiry)) as SupplyDate2 "
                    + "   from ddl_tick_dbt tk, ddl_leg_dbt leg1, ddl_leg_dbt leg2, doprkoper_dbt opr, "
                    + "        dfininstr_dbt fin, davoiriss_dbt avr, dparty_dbt party "
                    + "  where tk.t_BOfficeKind = "+DL_SECURITYDOC
                    + "    and RSB_SECUR.IsREPO(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) = 1 "
                    + "    and Exists(select 1 "
                    + "                 from ddlgrdeal_dbt grdeal, ddlgracc_dbt gracc "
                    + "                where grdeal.t_DocKind = tk.t_BOfficeKind "
                    + "                  and grdeal.t_DocID = tk.t_DealID "
                    + "                  and grdeal.t_TemplNum IN (" + DLGR_TEMPL_RECDELIVERY+", "+DLGR_TEMPL_RECDELIVERY2+")"
                    + "                  and gracc.t_GrDealID = grdeal.t_ID "
                    + "                  and gracc.t_AccNum = " + DLGR_ACCKIND_ACCOUNTING
                    + "                  and gracc.t_State = " + DLGRACC_STATE_FACTEXEC
                    + "                  and gracc.t_FactDate >= ? "
                    + "                  and gracc.t_FactDate <= ? "
                    + "              ) "
                    + "    and leg1.t_DealID = tk.t_DealID "
                    + "    and leg1.t_LegID = 0 "
                    + "    and leg1.t_LegKind = " + LEG_KIND_DL_TICK
                    + "    and leg2.t_DealID = tk.t_DealID "
                    + "    and leg2.t_LegID = 0 "
                    + "    and leg2.t_LegKind = " + LEG_KIND_DL_TICK_BACK
                    + "    and fin.t_FIID = tk.t_PFI "
                    + "    and avr.t_FIID = fin.t_FIID"
                    + "    and (party.t_PartyID = fin.t_Issuer or party.t_PartyID is NULL)"
                    + "    and opr.t_Kind_Operation = tk.t_DealType";
 
        query = query + " order by leg1.t_CFI, tk.t_DealDate, tk.t_DealTime ";
  
        var cmd = DL_RSDCommand(query);
        cmd.addParam(EndDate());
        cmd.addParam(BeginDate());
        cmd.addParam(EndDate());
    
        m_LinesCount = cmd.GetCount();
        if (m_LinesCount > 0)
            var ProgressIndicator = TProgressBar();
            ProgressIndicator.init(m_LinesCount, "Отбор сделок для отчета", "Сделки РЕПО");

            this.DoBeginReport();
            
            var ds = cmd.Execute();
            stat = ds.MoveNext();
            while(stat)
                m_rowData = RowDataREPO(ds);
                this.DoPrintTableLine();


                ItogTotalCost1 = ItogTotalCost1 + ds.TotalCost1;
                ItogTotalCost2 = ItogTotalCost2 + ds.TotalCost2;

                prevCFI = ds.CFI;
                precCCY = m_rowData.currencyCCY;

                stat = ds.MoveNext();

                if((not stat) or (prevCFI != ds.CFI))
                  this.DoPrintItogTableLine(precCCY, ItogTotalCost1, ItogTotalCost2);
                  ItogTotalCost1 = 0;
                  ItogTotalCost2 = 0;
                  m_Numb = 0;
                end;

                ProgressIndicator.Use;
            end;

            this.DoEndReport();

            ProgressIndicator.Remove();
        else
           this.DoBeginReport();
           this.DoEndReport(); 
        end;
    END;

    MACRO DoRegisterTable()
        m_weekRep.SetActiveSheet("СделкиРЕПО");
        m_weekRep.PrintFormatString("", "N3_H0", H0());
 
        m_weekRep.RegisterTable("N3_LineTable", "",
                                "N3_A1",
                                "N3_B1",
                                "N3_C1",
                                "N3_D1",
                                "N3_E1",
                                "N3_F1",
                                "N3_G1",
                                "N3_H1",
                                "N3_I1",
                                "N3_J1",
                                "N3_K1",
                                "N3_L1",
                                "N3_M1",
                                "N3_N1",
                                "N3_O1");
        m_isTableRegistered = true;   
    END;

    MACRO DoPrintTableLine()
        if (not m_isTableRegistered)
            m_weekRep.RegisterTableRep(this);
        end;

        m_Numb = m_Numb + 1;
        m_weekRep.PrintTableLine(
                    "N3_A1", m_Numb, null,
                    "N3_B1", m_rowData.contractorName, null,
                    "N3_C1", m_rowData.dealDate, null,
                    "N3_D1", m_rowData.deliveryDate_1, null,
                    "N3_E1", m_rowData.deliveryDate_2, null,
                    "N3_F1", m_rowData.sumNKD_1, null,
                    "N3_G1", m_rowData.sumNKD_2, null,
                    "N3_H1", m_rowData.currencyCCY, null,
                    "N3_I1", m_rowData.rate, null,
                    "N3_J1", m_rowData.issuerName, null,
                    "N3_K1", m_rowData.issName, null,
                    "N3_L1", m_rowData.issISIN, null,
                    "N3_M1", m_rowData.amount, null,
                    "N3_N1", m_rowData.dealNum, null,
                    "N3_O1", m_rowData.dealType, null);
    END; 

    MACRO DoPrintItogTableLine(CurrCCY, ItogTotalCost1, ItogTotalCost2)
        m_weekRep.Merge("N3_D1", "N3_E1", null);

        m_weekRep.PrintTableLine(
                    "N3_A1", "", null,
                    "N3_B1", "", null,
                    "N3_C1", "", null,
                    "N3_D1", "Итого в "+CurrCCY+":", null,
                    "N3_E1", "", null,
                    "N3_F1", ItogTotalCost1, null,
                    "N3_G1", ItogTotalCost2, null,
                    "N3_H1", "", null,
                    "N3_I1", "", null,
                    "N3_J1", "", null,
                    "N3_K1", "", null,
                    "N3_L1", "", null,
                    "N3_M1", "", null,
                    "N3_N1", "", null,
                    "N3_O1", "", null);
    END;
END;

////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////

MACRO RunReport()

    var stat = true;

    while(stat)
        weekRep_Form = DlWeekRep_Panel();
        stat = weekRep_Form.Run();
 
        if (not stat)
            break;
        end;

        if (stat)
            // Это данные из панели: фажки-переключатели типов отчетов, даты начала и конца отчета
            weekRepPanData = DlWeekRepPanData();
            weekRepPanData.SetValues(weekRep_Form.GetFieldValue(PNFLD_WEEKREP_START),
                                     weekRep_Form.GetFieldValue(PNFLD_WEEKREP_END),
                                     weekRep_Form.GetFieldValue(PNFLD_WEEKREP_REVALUTION),
                                     weekRep_Form.GetFieldValue(PNFLD_WEEKREP_BUY_SELL),
                                     weekRep_Form.GetFieldValue(PNFLD_WEEKREP_REPO));


            var weekRep = DlWeekRep(null, "Report_WeekRep.xls");    

            if (weekRepPanData.revalution == "X")
                var repRevalution = Rep_Revalution(weekRep);
                weekRep.AddReport(repRevalution);
            end;

            if (weekRepPanData.buySell == "X")
                var repBuySale = Rep_BuySale(weekRep);
                weekRep.AddReport(repBuySale);
            end;
            if (weekRepPanData.repo == "X")
                var repREPO = rep_REPO(weekRep);
                weekRep.AddReport(repREPO);
            end;

            weekRep.Run(null, "");
            Dl_CallInsertStat(DL_OUTREPORT_EXCEL);
        end;
    end;

END;

RunReport();
exit(1);  
//eof
