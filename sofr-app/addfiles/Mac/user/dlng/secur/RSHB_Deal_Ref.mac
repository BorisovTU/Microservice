import CTInter, PTInter, BankInter, wldinter, "globals.mac", RSD, RsbDataSet,oprinter;

record  deal(dl_tick);

macro GenRef( SeqValue, ObjKind, ObjAddr)
  var refer, dd, mm, yy, nextval;
  datesplit( {curdate}, dd, mm, yy );
  SetBuff( deal, ObjAddr );
  var Kind = GetOperationGroup(deal.dealtype);
  var NoBirg = not isexchange(Kind);
  var REPO = istwopart(Kind);
  if (NoBirg)
     if (REPO)
        GenerateReference(1000005, nextval);//Обязательно завести дополнительный референс для нумерации внебиржевого репо и сюда вписать его номер
	    if (deal.portfolioid == 0)
		    var  Query = "select T_iis from ddlcontrmp_dbt EBO left join ddlcontr_dbt contr on ebo.t_dlcontrid = CONTR.T_DLCONTRID where ebo.T_sfcontrid = :contrid";
	        Query = RSDCommand(Query);
            Query.AddParam("contrid", RSDBP_IN, deal.clientcontrid);	 
	        var rs = RsdRecordset(Query);
	         while (rs.MoveNext)
	             var tmp = rs.value(0);
	         end;
	        if (tmp == "X")
	            refer = string("БИ/", nextval, "-", yy,"/REPO");
	        else
	           refer = string("Б/", nextval, "-", yy,"/REPO");
	        end;	
		else
		    refer = string("Д/", nextval, "-", yy,"/REPO");
	    end;
	 else
	 GenerateReference(1000006, nextval);//Обязательно завести дополнительный референс для нумерации внебиржевого не репо и сюда вписать его номер
	    if (deal.portfolioid == 0)
	         refer = string("Б/", nextval, "-", yy);
	    else
	         refer = string("Д/", nextval, "-", yy);
	    end;
	 end;
  else
		if (deal.dealcodets == "")
			msgbox ("Не задан внешний номер сделки");
			return null;
		else 
			refer = deal.dealcodets;
		end;
  end;
  
  return refer;
end;