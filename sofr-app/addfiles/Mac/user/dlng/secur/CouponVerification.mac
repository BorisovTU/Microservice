import RsbFormsInter, Global, or_rep_h,"cb_sql.mac";

const v_specval = 26;

private macro iif(a,b,c)
      if(a)
         return b;
      else
         return c;
      end;
   end;




CLASS OfferRep(pDAte)

var Report;
var vDAte   = pDAte;

var rn = 1;
var EXCEL_MONEY = "\"# ##0,00\"";
var sheet = 1,n_sheet = 2;
var count = 0;

var col1_len = 5,  col2_len = 25, col3_len = 15;
var col4_len = 25,  col5_len = 14,  col6_len = 9;
var col7_len = 9,   col8_len = 7, col9_len = 7;
var color  = 12632256;  
var ColorD = 16316664;
var ColorL = 15395562;

var head_format = "ex_FS(b):ex_B(tblr):ex_BC(" + color + ")";
var format      = "ex_FS():ex_B(tblr):ex_BC(" + color + ")";

private macro ДобавитьСтроку()
  Report.AddStr();rn = rn + 1;
end;

private macro ДобавитьПустуюСтроку()
   Report.AddEmptyStr();rn = rn + 1;
end; 

private macro ПечатьШапки ()        

    ДобавитьПустуюСтроку();

    Report.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
    Report.SetExecute("iBook.Sheets("+sheet+").Range(\"A"+(rn)+":D"+(rn)+"\").merge;");
   
    ДобавитьСтроку();

    Report.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
    Report.SetExecute("iBook.Sheets("+sheet+").Range(\"A"+(rn)+":D"+(rn)+"\").merge;");
    Report.AddPrintCell("Список купонов с нулевой доходностью.", col1_len, null, "r:ex_FS(b):ex_B()");
    ДобавитьСтроку();

    Report.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
    Report.SetExecute("iBook.Sheets("+sheet+").Range(\"A"+(rn)+":D"+(rn)+"\").merge;");
    Report.AddPrintCell("Дата отчета: " + string(vDate):f, col1_len, null, "l:ex_FS(b):ex_B()");
    ДобавитьСтроку();

    ДобавитьПустуюСтроку();

    rn = rn - 1;    

    Report.SetExecute("iBook.Sheets("+sheet+").Range(\"F"+(rn)+":G"+(rn)+"\").merge;");
    Report.SetExecute("iBook.Sheets("+sheet+").Range(\"H"+(rn)+":I"+(rn)+"\").merge;");
    Report.SetExecute("iBook.Sheets("+sheet+").Range(\"J"+(rn)+":K"+(rn)+"\").merge;");
    Report.SetExecute("iBook.Sheets("+sheet+").Range(\"L"+(rn)+":M"+(rn)+"\").merge;");
    Report.SetExecute("iBook.Sheets("+sheet+").Range(\"N"+(rn)+":O"+(rn)+"\").merge;");
    //Report.SetExecute("iBook.Sheets("+sheet+").Range(\"F"+(rn)+":G"+(rn)+"\").merge;");
/*1*/   Report.AddPrintCell ("ID",         col1_len,  null, "c:" + head_format);
/*2*/   Report.AddPrintCell ("Наименование",  col2_len,  null,"c:" + head_format);
/*2*/   Report.AddPrintCell ("T_ISIN",   col3_len,  null,"c:" + head_format);
/*4*/   Report.AddPrintCell ("Расхождение",        col4_len,  null, "c:"+ head_format);
/*5*/   Report.AddPrintCell ("Номер купона",       col5_len+col5_len + 1,  null, "c:" + head_format);
/*6*/   Report.AddPrintCell ("Начало периода",        col6_len + col6_len + 1,  null,"c:" + head_format); 
/*7*/   Report.AddPrintCell ("Конец периода",        col7_len + col6_len + 1,  null,"c:" + head_format); 
/*8*/   Report.AddPrintCell ("Ставка",        col8_len + col8_len +1,  null, "c:" + head_format);
/*9*/   Report.AddPrintCell ("Доходность",col9_len + col9_len + 1,  null, head_format);


    ДобавитьСтроку;  color = colorD; head_format = "c:ex_FZ(8):ex_FS():ex_B(tblr):ex_BC(" + color + ")"; color = colorL;
/*1*/   Report.AddPrintCell ("1      ", col1_len,  null, head_format);
/*2*/   Report.AddPrintCell ("2", col2_len,  null, head_format);
/*3*/   Report.AddPrintCell ("3", col3_len,  null, head_format);
/*4*/   Report.AddPrintCell ("4", col4_len,  null, head_format);
/*5*/   Report.AddPrintCell ("5.1 СОФР", col5_len,  null, head_format);
/*5*/   Report.AddPrintCell ("5.2 Рудата", col5_len,  null, head_format);
/*6*/   Report.AddPrintCell ("6.1 СОФР", col6_len,  null, head_format); 
/*6*/   Report.AddPrintCell ("6.2 РуДата", col6_len,  null, head_format); 
/*7*/   Report.AddPrintCell ("7.1 СОФР", col7_len,  null, head_format); 
/*7*/   Report.AddPrintCell ("7.2 РуДата", col7_len,  null, head_format); 
/*8*/   Report.AddPrintCell ("8.1 СОФР", col8_len,  null, head_format); 
/*8*/   Report.AddPrintCell ("8.2 РуДата", col8_len,  null, head_format); 
/*9*/   Report.AddPrintCell ("9.1 СОФР", col9_len,  null, head_format);
/*9*/   Report.AddPrintCell ("9.2 РуДата", col9_len,  null, head_format);


    Report.SetExecute("iBook.Sheets("+sheet+").Rows("+(rn)+").AutoFilter;");
    ДобавитьСтроку;
end;

private macro ПечатьБлокаДанных(_rs);
    if(valtype(_rs) != v_undef)
    format = "ex_FS():ex_B(tblr)";
    var test;
      while(_rs.movenext)
        Report.AddPrintCell(_rs.value("t_FIID"), col1_len, null, "l:"+format); // 1. 
        Report.AddPrintCell(_rs.value("T_Definition"), col2_len, null, "l:"+format); // 2.  
        Report.AddPrintCell(_rs.value("T_ISIN"), col3_len, null, "l:"+format); // 3.  

        Report.AddPrintCell(iif(_rs.value("ZEROCOUPON") == 0,"Отсутствует купон на дату", IIF(_rs.value("ZEROCOUPON") == 1,"Нулевая доходность по купону","Расхождения в ставках с РуДата")), col4_len, null, "l:"+format); // 4. 
        Report.AddPrintCell(iif(valtype(_rs.value("T_NUMBER"))==v_specval,"", _rs.value("T_NUMBER")), col5_len, null, "c:"+format); // 5. 
        Report.AddPrintCell(iif(valtype(_rs.value("ID_COUPON"))==v_specval,"", _rs.value("ID_COUPON")), col5_len, null, "c:"+format); // 5. 
        Report.AddPrintCell(SQL_ConvTypeDate(_rs.value("T_FIRSTDATE")), col6_len, null, "c:"+format); // 6. 
        Report.AddPrintCell(SQL_ConvTypeDate(_rs.value("BEGIN_PERIOD")), col6_len, null, "c:"+format); // 6. 
        Report.AddPrintCell(SQL_ConvTypeDate(_rs.value("T_DRAWINGDATE")), col7_len, null, "c:"+format); // 7. 
        Report.AddPrintCell(SQL_ConvTypeDate(_rs.value("END_PERIOD")), col7_len, null, "c:"+format); // 7. 
        Report.AddPrintCell(iif(valtype(_rs.value("INCOMERATE"))==v_specval,"", _rs.value("INCOMERATE")), col8_len, null, "c:"+format); // 8. 
        Report.AddPrintCell(iif(valtype(_rs.value("SBCOUPONRATE"))==v_specval,"", _rs.value("SBCOUPONRATE")), col8_len, null, "c:"+format); // 8. 
        Report.AddPrintCell(iif(valtype(_rs.value("T_INCOMEVOLUME"))==v_specval,"", _rs.value("T_INCOMEVOLUME")), col9_len, null, "c:"+format); // 9. 
        Report.AddPrintCell(iif(valtype(_rs.value("PAY_PER_BOND"))==v_specval,"", _rs.value("PAY_PER_BOND")), col9_len, null, "c:"+format); // 9. 
        ДобавитьСтроку;
                     
      end;
    end;
end;

macro run()
var SQL, cmd, rs, KP = 0;

  Report = CMakeReport("┌┬┬┬┬┬┬┬┬┬┬┬┐");
  Report.SetDefaultFontName("Times New Roman");
  Report.SetDefaultFontSize(10);
  Report.SetFlagShowGrid(true);

  ПечатьШапки();

if (MsgBoxEx("Вывести в отчет Цб находящиеся только в клиентских портфелях?", MB_YES + MB_NO, IND_NO) == IND_NO)
   KP = 1;
end;

SQL = "SELECT coupons.\*,     " +
      "       SB.ID_COUPON, " +
      "       (SB.BEGIN_PERIOD + 1) BEGIN_PERIOD, " +
      "       SB.END_PERIOD, " +
      "       TO_NUMBER (SB.COUPON_RATE) SBCOUPONRATE, " +
      "       SB.PAY_PER_BOND, " +
      "       FIW.T_NUMBER, " +
      "       FIW.T_FIRSTDATE, " +
      "       FIW.T_DRAWINGDATE, " +
      "       TO_NUMBER (FIW.T_INCOMERATE) INCOMERATE, " +
      "       FIW.T_INCOMEVOLUME, " +
      "       TO_NUMBER (SB.COUPON_RATE) A1, " +
      "       TO_NUMBER (FIW.T_INCOMERATE) A2 " +
      "  FROM (SELECT av.t_fiid, " +
      "               fi.t_definition, " +
      "               av.t_isin, " +
      "               rshb_user.bond_haszerocoupons (fi.t_fiid, to_date('" + vDate + "','dd.mm.yyyy')) ZeroCoupon " +
      "          FROM davoiriss_dbt av, dfininstr_dbt fi " +
      "         WHERE     av.t_fiid = fi.t_fiid " +
      "               AND RSI_RSB_FIInstr. " +
      "                    FI_AvrKindsGetRoot (fi.t_fi_kind, fi.t_AvoirKind) = 17 " +
      "               AND FI.T_ISCLOSED <> CHR (88) " +
      "               AND FI.T_DRAWINGDATE >= to_date('" + vDate + "','dd.mm.yyyy') " +
      "               AND av.t_fiid IN " +
      "                      (SELECT DISTINCT v.t_fiid " +
      "                         FROM v_scwrthistex v " +
      "                        WHERE t_state IN (1, 3, 20, 21) AND t_amount > 0 " +
      "                              AND t_instance = " +
      "                                     (SELECT MAX (t_instance) " +
      "                                        FROM v_scwrthistex " +
      "                                       WHERE v.t_sumid = t_sumid " +
      "                                             AND v.t_changedate = " +
      "                                                    t_changedate) " ;
if(KP)
     SQL = SQL + "                              AND t_party = -1 ";
end;
     SQL = SQL + "                              AND v.t_changedate = " +
      "                                     (SELECT MAX (t.t_changedate) " +
      "                                        FROM v_scwrthistex t " +
      "                                       WHERE v.t_sumid = t_sumid " +
      "                                             AND t.t_changedate <= to_date('" + vDate + "','dd.mm.yyyy')))) Coupons " +
      "       LEFT JOIN SOFR_BOND_COUPONS sb " +

      "          ON sb.id_fintool = " +
      "            (SELECT  SIF.FINTOOLID " +
      "                 FROM     sofr_info_fintoolreferencedata sif " +
      "                 where sif.ISINCODEBASE_NRD = Coupons.t_Isin OR sif.ISINCODE = Coupons.t_isin and rownum = 1) " +

/*      "                (SELECT c.t_code " +
      "                   FROM dobjcode_dbt c " +
      "                  WHERE     c.t_objecttype = 9 " +
      "                        AND c.t_codekind = 104 " +
      "                        AND c.t_objectid = Coupons.t_fiid " +
      "                        AND c.t_state = 0) " +  */
      "             AND to_date('" + vDate + "','dd.mm.yyyy') BETWEEN (sb.begin_period + 1) AND sb.end_period " +
      "       LEFT JOIN dfiwarnts_dbt fiw " +
      "          ON     FIW.T_FIID = coupons.t_fiid " +
      "             AND to_date('" + vDate + "','dd.mm.yyyy') BETWEEN FIW.T_FIRSTDATE AND FIW.T_DRAWINGDATE " +
      "             AND fiw.t_ispartial <> CHR (88) " +
      " WHERE coupons.zerocoupon < 3 " +
      "       OR (coupons.zerocoupon = 3 " +
      "           AND ROUND (TO_NUMBER (SB.COUPON_RATE), 4) <> " +
      "                  ROUND (TO_NUMBER (FIW.T_INCOMERATE), 4) " +
      "           AND TO_NUMBER (SB.PAY_PER_BOND) <> TO_NUMBER (FIW.T_INCOMEVOLUME))" ;


   
    cmd = RSDCommand(SQL);
    begaction(100,"Сбор данных...");
    rs = RSDRecordset(cmd, rsdval_client,rsdval_static);
      ПечатьБлокаДанных(rs);
      endaction;

      Report.PrintWinRep("Нулевые купоны.");
      Report.SetWinRepOutput();
      Report.ShowWinRep();

end;  

END;


CLASS (TRsbPanel) Pan
    initTRsbPanel();

    const Delta = 50;

    const K_Enter = 13;
    const K_F3    = 317;
    const K_F2    = 316;

    const BeginCalcDate_ID = 1;

    var curstr = 1;
    Caption = "Облигации. Нулевые купоны.";
    Status = "~ESC~Выход ~F2~Выполнить";
    setSize(37,5);
    setPosition(30,10);
    var BeginCalcDate, dx;
    var RuDataFlag = 0;
    var InPortfolioFlag = 1;

    curstr = curstr+1;
    BeginCalcDate = TRsbEditField(V_DATE);
    BeginCalcDate.setPosition(16,curstr);
    BeginCalcDate.setSize(8,1);
    BeginCalcDate.name = "begincalcdate";
    BeginCalcDate.value = {curdate};
    addControl(BeginCalcDate);

    var m_LabelCD:TrsbLabel = TRsbLabel(2,curstr,"Дата отчета:");
    addLabel (m_LabelCD);

    addEventHandler(RSB_EV_KEY_PRESSED, R2M(this, "onKeyPressed"));
    
    macro onKeyPressed(ev)
        if (ev.KeyCode == K_F3)
           if (ev.id == BeginCalcDate_ID)
            BeginCalcDate.value = GetDateByCalendar({CurDate});
            this.redraw; 
           end;
        elif (ev.KeyCode == K_Enter)
            //this.update;
           // EndCalcDate.value = BeginCalcDate.value + Delta;
            this.redraw; 
        elif(ev.keyCode == K_F2)
                
         var myRep = OfferRep(BeginCalcDate.value);
         myRep.run;
        end;
    end; 
END;

var myPanel:TRsbPanel = Pan;
myPanel.run;
exit(1);
