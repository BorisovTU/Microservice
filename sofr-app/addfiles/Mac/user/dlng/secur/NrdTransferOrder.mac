/*NrdTransferOrder.mac*/
IMPORT Global, RsbFormsInter, "cb_sql.mac", PTInter, "dlquery.mac", rsd;
IMPORT "qracctools.mac";
IMPORT "role_model.mac";//ролевая модель

var commid;
var ordernum;
var oldfilename = "";
var orderdate;

macro GetRegNRDOrderDir( dt:date, ErrMes:@string):string
  var RegDir = "РСХБ\\ДИРЕКТОРИИ\\NRDOrderDir";
  var ExpDir, err, i, j, k;

  GetRegistryValue(RegDir, V_STRING, ExpDir, err);

  if(err)
     ErrMes = "Ошибка получения значения настройки \"" + ExpDir + "\"";
     return "";
  end;

  if(substr(ExpDir,strlen(ExpDir)) != "\\")
    ExpDir = ExpDir + "\\";
  end;
  return ExpDir;
end;

private macro GetFICode(objecttype, codekind, objectid)
 var sql = " SELECT                                                     " +
   "        t.t_objecttype, " +
   "         t.t_codekind, " +
   "         t.t_objectid, " +
   "         t.t_code, " +
   "         t.t_state, " +
   "         t.t_bankdate, " +
   "         t.t_sysdate, " +
   "         t.t_systime, " +
   "         t.t_userid, " +
   "         t.t_branch, " +
   "         t.t_numsession, " +
   "         t.t_unique, " +
   "         t.t_autokey, " +
   "         t.t_bankclosedate, " +
   "         t.t_normcode " +
   "    FROM dobjcode_dbt t " +
   "   WHERE (    t.t_objecttype = ? " +
   "          AND t.t_codekind =? " +
   "          AND t.t_objectid =? )" +
   "ORDER BY t.t_objecttype, " +
   "         t.t_codekind, " +
   "         t.t_objectid, " +
   "         t.t_bankdate DESC, " +
   "         t.t_autokey " ;
 var dl_cmd = dl_RSDCommand(sql);
     dl_cmd.AddParam(objecttype);
     dl_cmd.AddParam(codekind);
     dl_cmd.AddParam(objectid);
 var dl_rs = dl_cmd.execute();
 if(dl_rs.movenext())
   return dl_rs.Code;
 end;
   return "";
end;

CLASS cl_TransferOrder (comm)
  
  macro get_format_date(pDate)
    var comm_date_d, comm_date_m, comm_date_y;
    datesplit(pDate, comm_date_d, comm_date_m, comm_date_y);
    return (comm_date_y + "-" + comm_date_m + "-" + comm_date_d);
  end;

  macro CheckExistOrder(commid, ordernum:@integer, oldfilename:@string, orderdate:@date)
   var dl_sql = "Select * from dnrdorder_dbt where t_commid = ? order by t_id desc";
   var dl_cmd = dl_RSDCommand(dl_sql);
       dl_cmd.AddParam(commid);
   var dl_rs = dl_cmd.execute();
   if (dl_rs.movenext())
      oldfilename = dl_rs.filename;
      ordernum = dl_rs.ordernum;
      orderdate = date(dl_rs.date);
   else
      dl_sql = "select nvl(max(t_ordernum),0)+1 newnum  from dnrdorder_dbt ";
      dl_cmd = dl_RSDCommand(dl_sql);
      dl_rs = dl_cmd.execute();
      if(dl_rs.movenext())
        oldfilename = "";
        ordernum = dl_rs.newnum;
        orderdate = null;
      end;
   end;    
  end; 

  class cl_ORDER_HEADER
    var deposit_c :string;
    var contrag_c :string;
    var contr_d_id :integer;
    var createdate :string ;
    var order_t_id :string;
    var execute_dt :string ;
    var expirat_dt :string ;
  end;

  class cl_MF035
    var dep_acc_c :string;
    var deponent_c :string;
    var sec_c :string;
    var reestr_bic :string;
    var person_bic :string;
    var sr_acc_c :string;
    var oper_date :string;
    var trad_dt :string;
    var trad_id :string;
    var need_cvit :string;
    var reciv_payment :string;
    var security_c :string;
    var security_q :string;
    var security_lsin :string;
    var security_isin :string;
    var security_code :string;
    var security_name :string;
  
  end;

  class cl_MF036
    var dep_acc_c :string;
    var deponent_c :string;
    var sec_c :string;
    var reestr_bic :string;
    var pr_jur_or_ind :string;
    var recv_acc_c :string;
    var person_bic :string;
    var oper_date :string;
    var need_cvit :string;
    var trad_dt :string;
    var trad_id :string;
    var security_c :string;
    var security_q :string;
    var security_name :string;
    var security_lsin :string;
    var security_isin :string;
  end;

  class cl_MF010
    var dep_acc_c :string;
    var deponent_c :string;
    var sec_c :string;
    var corr_acc_c :string;
    var corr_sec_c :string;
    var corr_code :string;
    var deal_reference :string;
    var date_deal :string;
    var ord_stat :string;


    var reestr_bic :string;
    var pr_jur_or_ind :string;
    var recv_acc_c :string;
    var person_bic :string;
    var oper_date :string;
    var need_cvit :string;
    var trad_dt :string;
    var trad_id :string;
    var security_c :string;
    var security_q :string;
    var security_name :string;
    var security_lsin :string;
    var security_isin :string;
  end;

  var  order_header = cl_ORDER_HEADER;
  var  MF035 = cl_MF035;
  var  MF036 = cl_MF036;
  var  MF010 = cl_MF010;
  var TypeOrder;

  private var err = 0;
  private var CodeStr = "";
  private var OrderRecieverID; //НРД 

  var refer = 1000014; //Формирование номера инструкции в НРД

  GetRegistryValue( "SECUR\\NRD_CODE", V_STRING, CodeStr, err );
  if (not err)
    OrderRecieverID = ПолучитьКодСубъекта(CodeStr, PTCK_CLIENT);
  end;  

  var pt_OrderReciever = RSBParty(OrderRecieverID);
  var pt_Initiator     = RSBParty(iif(comm.clientid==-1/*Наш банк*/, {OurBank}, comm.clientid));
  var pt_Sender        = RSBParty(comm.storageid_from);
  var pt_Reciever      = RSBParty(comm.storageid_to);

  macro Get_dep_acc_c()
   if   (typeorder=="MF036")   return MF036.dep_acc_c;
   elif (typeorder=="MF035")   return MF035.dep_acc_c; 
   elif (typeorder=="MF010")   return MF010.dep_acc_c; 
   end;
  end;
  
  macro Get_deponent_c()
   if   (typeorder=="MF036")   return MF036.deponent_c;
   elif (typeorder=="MF035")   return MF035.deponent_c; 
   elif (typeorder=="MF010")   return MF010.deponent_c; 
   end;
  end;
  
  macro Get_sec_c()
   if   (typeorder=="MF036")   return MF036.sec_c;
   elif (typeorder=="MF035")   return MF035.sec_c; 
   elif (typeorder=="MF010")   return MF010.sec_c; 
   end;
  end;

  macro Get_reestr_bic()
   if   (typeorder=="MF036")   return MF036.reestr_bic;
   elif (typeorder=="MF035")   return MF035.reestr_bic; 
   elif (typeorder=="MF010")   return MF010.reestr_bic; 
   end;
  end;

  macro Get_security_c()
   if   (typeorder=="MF036")   return MF036.security_c;
   elif (typeorder=="MF035")   return MF035.security_c; 
   elif (typeorder=="MF010")   return MF010.security_c; 
   end;
  end;

  macro Get_security_q()
   if   (typeorder=="MF036")   return MF036.security_q;
   elif (typeorder=="MF035")   return MF035.security_q; 
   elif (typeorder=="MF010")   return MF010.security_q; 
   end;
  end;

  macro Get_order_t_id()
   if   (typeorder=="MF036")   return "36";
   elif (typeorder=="MF035")   return "37";
   elif (typeorder=="MF010")   
    if (pt_Sender.PartyID == pt_OrderReciever.PartyID)
      return "16";
    elif(pt_Reciever.PartyID == pt_OrderReciever.PartyID)
      return "16/1"
    end;
   else return "";
   end;
  end;

  macro Get_OperationCaption(TypeOperation)
   if    (TypeOperation=="36")     return "36(Снятие ценных бумаг с харанения и/или учета)";
    elif (TypeOperation=="35")     return "37(Прием ценных буман на хранение и/или учет";
    elif (TypeOperation=="16")     return "16(Перевод с подтверждением)";
    elif (TypeOperation=="16/1")   return "16/1(Перевод с подтверждением)";
   end;
  
   return "";
  end;

  macro Get_person_bic()
   if   (typeorder=="MF036")   return MF036.person_bic;
   elif (typeorder=="MF035")   return MF035.person_bic; 
   elif (typeorder=="MF010")   return MF010.corr_code; 
   end;
  end;

  macro Get_recv_acc_c()
   if   (typeorder=="MF036")   return MF036.recv_acc_c;
   elif (typeorder=="MF035")   return MF035.recv_acc_c; 
   elif (typeorder=="MF010")   return MF010.corr_acc_c; 
   end;
  end;

  macro Get_security_name()
   if   (typeorder=="MF036")   return MF036.security_name;
   elif (typeorder=="MF035")   return MF035.security_name; 
   elif (typeorder=="MF010")   return MF010.security_name; 
   end;
  end;

  macro Get_security_lsin()
   if   (typeorder=="MF036")   return MF036.security_lsin;
   elif (typeorder=="MF035")   return MF035.security_lsin; 
   elif (typeorder=="MF010")   return MF010.security_lsin; 
   end;
  end;

  macro Get_security_isin()
   if   (typeorder=="MF036")   return MF036.security_isin;
   elif (typeorder=="MF035")   return MF035.security_isin; 
   elif (typeorder=="MF010")   return MF010.security_isin; 
   end;
  end;

  record AVR (avoiriss);
  record ФинИн(fininstr);
  ПолучитьФинИн(comm.fiid,ФинИН,AVR);

  commid = comm.Documentid; 
  CheckExistOrder(comm.Documentid, @order_header.contr_d_id, @oldfilename, @orderdate);
  ordernum = order_header.contr_d_id;

  order_header.deposit_c = pt_OrderReciever.code(PTCK_MICEX);
  order_header.contrag_c = pt_Initiator.code(PTCK_MICEX);
  order_header.createdate = get_format_date({curdate});
  order_header.execute_dt = get_format_date({curdate}); 
  
  if(substr(avr.isin,1,2)=="RU") //Вроде как так нужно определять минфинку
  //заполняем MF010
    TypeOrder = "MF010";
      MF010.dep_acc_c = comm.depoacccode_from;
      MF010.sec_c     = comm.depopartcode_from;

      if (pt_Sender.PartyID == pt_OrderReciever.PartyID)
        MF010.deponent_c = pt_Initiator.Code(PTCK_MICEX);        
        MF010.corr_code  = pt_Reciever.Code(23);//Депозитаорный код в НРД
      elif(pt_Reciever.PartyID == pt_OrderReciever.PartyID)
        MF010.deponent_c = pt_Sender.Code(23);//Депозитаорный код в НРД
        MF010.corr_code  = pt_Initiator.Code(23);        
      end;
        MF010.corr_acc_c = comm.depoacccode_to;
        MF010.corr_sec_c = comm.depopartcode_to;


      MF010.security_c = iif(GetFICode( 9, 11, comm.fiid )!="", GetFICode( 9, 11, comm.fiid ),GetFICode( 9, 14, comm.fiid ));
      MF010.security_q = comm.HIDDEN_SUM;
      MF010.deal_reference = comm.commcode;
      MF010.date_deal = get_format_date({curdate}); // исправить на дату перевода
      MF010.ord_stat = "NEWM";
      MF010.security_name = ФинИн.definition;
      MF010.security_lsin = avr.lsin;
      MF010.security_isin = avr.isin;
      order_header.expirat_dt = get_format_date(getnextworkdate(date(comm.commdate),5));

  elif (pt_Sender.partyID == pt_OrderReciever.partyID) 
    TypeOrder = "MF036";
      MF036.dep_acc_c = comm.depoacccode_from;
      MF036.deponent_c = pt_Initiator.Code(PTCK_MICEX);
      MF036.sec_c     = comm.depopartcode_from;
      MF036.reestr_bic = substr(pt_Reciever.Code(PTCK_SWIFT),1,8);
      MF036.person_bic = substr(pt_Initiator.Code(PTCK_SWIFT),1,8);
      MF036.recv_acc_c = comm.depoacccode_to;
      MF036.pr_jur_or_ind = "J";
      MF036.security_c = iif(GetFICode( 9, 11, comm.fiid )!="", GetFICode( 9, 11, comm.fiid ),GetFICode( 9, 14, comm.fiid ));
      MF036.security_q = comm.HIDDEN_SUM;
      MF036.security_lsin = avr.lsin;
      MF036.security_isin = avr.isin;
      MF036.security_name = ФинИн.definition;
      MF036.oper_date = get_format_date({curdate});
      MF036.need_cvit = "N";
      MF036.trad_dt = get_format_date({curdate});
      MF036.trad_id = comm.commcode;
      order_header.expirat_dt = get_format_date(getnextworkdate(date(comm.commdate),8));

  elif (pt_Reciever.partyID == pt_OrderReciever.partyID)
    TypeOrder = "MF035";
      MF035.dep_acc_c = comm.depoacccode_to;
      MF035.deponent_c = pt_Initiator.Code(PTCK_MICEX);
      MF035.sec_c     = comm.depopartcode_to;
      MF035.reestr_bic = substr(pt_Sender.Code(PTCK_SWIFT),1,8);
      MF035.person_bic = substr(pt_Initiator.Code(PTCK_SWIFT),1,8);
      MF035.sr_acc_c = comm.depoacccode_from;
      MF035.oper_date = get_format_date({curdate});
      MF035.trad_dt = get_format_date(comm.commdate);
      MF035.need_cvit = "Y";
      MF035.reciv_payment = "N";
      MF035.security_c = iif(GetFICode( 9, 11, comm.fiid )!="", GetFICode( 9, 11, comm.fiid ),GetFICode( 9, 14, comm.fiid ));
      MF035.security_q = comm.HIDDEN_SUM;
      MF035.security_lsin = avr.lsin;
      MF035.security_lsin = avr.isin;
      MF035.security_name = ФинИн.definition;
      MF035.trad_id = comm.commcode;
      order_header.expirat_dt = get_format_date(getnextworkdate(date(comm.commdate),5));
  end;
  order_header.order_t_id = Get_order_t_id();

END; //CLASS

PRIVATE CLASS (DL_XML) TransferOrder_XML(ds)
   private var m_MainNode = NULL,
               m_ds;

   private macro GetFileName()
      if(m_FileName == NULL)
         var y, mon, d, h, m, s, impl_ord_date, _date, _time;

         
         impl_ord_date = string(L_Z(d,2)) + string(L_Z(mon,2)) + string(L_Z(y, 4));

         datesplit(Date(), d, mon, y);
         _date = string(L_Z(d,2)) + string(L_Z(mon,2)) + string(L_Z(y, 4));

         TimeSplit(Time(), h, m, s);
         _time = string(L_Z(h,2)) + string(L_Z(m,2)) + string(L_Z(s, 2));

         m_FileName =  m_ds.order_header.contr_d_id + "_" + _date + _time;
      end;

      return m_FileName;
   end;

   macro AddLogData(FileName)
     var dl_sql = "INSERT INTO DNRDORDER_DBT (T_COMMID, T_ORDERNUM,T_FILENAME, T_DATE)  " +
                  "VALUES ( ? , ?, ?, sysdate  ) " ;


         
     var dl_cmd = RSDCommand(dl_sql);
         dl_cmd.AddParam("", rsdbp_in, commid); 
         dl_cmd.AddParam("", rsdbp_in, ordernum);
         dl_cmd.AddParam("", rsdbp_in, FileName);
         dl_cmd.execute();
         return 0;
   end;

   macro SaveXML()
     var dir;
     dir = GetRegNRDOrderDir;

     if(m_MainNode != null)
       AddMainNode(m_MainNode);
       SaveXML(/*dir*/);

       if (not CopyFile("..\\txtfile\\" + GetFileName()+ ".xml", "$" + GetRegNRDOrderDir + GetFileName()+ ".xml")  )
           msgbox("err");          
       end;

       msgbox ("Сформирован файл " + GetFileName()+".xml");
       AddLogData(GetFileName()+".xml");
     end;
   end;

   private macro CreateNode_ORDER_HEADER()
      var Header = CreateNode("ORDER_HEADER");
      //deposit_c
        Header.appendChild(CreateElementValue("deposit_c",  m_ds.order_header.deposit_c));
      //contrag_c
        Header.appendChild(CreateElementValue("contrag_c",  m_ds.order_header.contrag_c));
      //contr_d_id
        Header.appendChild(CreateElementValue("contr_d_id",  m_ds.order_header.contr_d_id));
      //createdate
        Header.appendChild(CreateElementValue("createdate",  m_ds.order_header.createdate));
      //order_t_id
        Header.appendChild(CreateElementValue("order_t_id",  m_ds.order_header.order_t_id));
      //execute_dt
        Header.appendChild(CreateElementValue("execute_dt",  m_ds.order_header.execute_dt + " 00:00:00"));
      //expirat_dt
        Header.appendChild(CreateElementValue("expirat_dt",  m_ds.order_header.expirat_dt + " 23:59:59"));
      return Header;
   end;
   private macro CreateNode_DOCUMENT()
      return CreateNode("Document");
   end;
   private macro CreateNode_BODY()
      var MFXXX; 

      if   (m_ds.typeorder=="MF036") MFXXX = CreateNode("MF036");   
      elif (m_ds.typeorder=="MF036") MFXXX = CreateNode("MF035");   
      elif (m_ds.typeorder=="MF010") MFXXX = CreateNode("MF010");   
      end;
      if(m_ds.typeorder!="MF010")
         MFXXX.appendChild(CreateElementValue("dep_acc_c", m_ds.Get_dep_acc_c()));
         MFXXX.appendChild(CreateElementValue("deponent_c", m_ds.Get_deponent_c()));
         MFXXX.appendChild(CreateElementValue("sec_c", m_ds.Get_sec_c()));
         MFXXX.appendChild(CreateElementValue("reestr_bic", M_DS.Get_reestr_bic()));

         if(m_ds.typeorder=="MF036")
            MFXXX.appendChild(CreateElementValue("pr_jur_or_ind",  m_ds.MF036.pr_jur_or_ind));
            MFXXX.appendChild(CreateElementValue("recv_acc_c",  m_ds.MF036.recv_acc_c));
            MFXXX.appendChild(CreateElementValue("person_bic",  m_ds.MF036.person_bic));
            MFXXX.appendChild(CreateElementValue("oper_date",  m_ds.MF036.oper_date));
            MFXXX.appendChild(CreateElementValue("need_cvit",  m_ds.MF036.need_cvit));
            MFXXX.appendChild(CreateElementValue("trad_dt",  m_ds.MF036.trad_dt));
            MFXXX.appendChild(CreateElementValue("trad_id",  m_ds.MF036.trad_id));
            
         elIF(m_ds.typeorder=="MF035")
           MFXXX.appendChild(CreateElementValue("person_bic",  m_ds.MF035.person_bic));
           MFXXX.appendChild(CreateElementValue("sr_acc_c",  m_ds.MF035.sr_acc_c));
           MFXXX.appendChild(CreateElementValue("oper_date",  m_ds.MF035.oper_date));
           MFXXX.appendChild(CreateElementValue("trad_dt",  m_ds.MF035.trad_dt));
           MFXXX.appendChild(CreateElementValue("trad_id",  m_ds.MF035.trad_id));
           MFXXX.appendChild(CreateElementValue("need_cvit",  m_ds.MF035.need_cvit));
           MFXXX.appendChild(CreateElementValue("reciv_payment",  m_ds.MF035.reciv_payment));
            
         end;

         MFXXX.appendChild(CreateElementValue("security_c", m_ds.Get_security_c()));
         MFXXX.appendChild(CreateElementValue("security_q", m_ds.Get_security_q()));
      else
         MFXXX.appendChild(CreateElementValue("dep_acc_c", m_ds.MF010.dep_acc_c));
         MFXXX.appendChild(CreateElementValue("sec_c", m_ds.MF010.sec_c));
         MFXXX.appendChild(CreateElementValue("deponent_c", m_ds.MF010.deponent_c));
         MFXXX.appendChild(CreateElementValue("corr_acc_c", M_DS.MF010.corr_acc_c));
         MFXXX.appendChild(CreateElementValue("corr_sec_c", M_DS.MF010.corr_sec_c));
         MFXXX.appendChild(CreateElementValue("corr_code", M_DS.MF010.corr_code));

         var n_securities = CreateNode("securities");
         var n_security   = CreateNode("securities");
         n_security.appendChild(CreateElementValue("security_c", M_DS.MF010.security_c));
         n_security.appendChild(CreateElementValue("security_q", int(M_DS.MF010.security_q)));
         n_securities.appendChild(n_security);
         MFXXX.appendChild(n_securities);
         MFXXX.appendChild(CreateElementValue("deal_reference", M_DS.MF010.deal_reference));
         MFXXX.appendChild(CreateElementValue("date_deal", M_DS.MF010.date_deal));
         MFXXX.appendChild(CreateElementValue("ord_stat", M_DS.MF010.ord_stat));

         if(m_ds.typeorder=="MF036")
            MFXXX.appendChild(CreateElementValue("pr_jur_or_ind",  m_ds.MF036.pr_jur_or_ind));
            MFXXX.appendChild(CreateElementValue("recv_acc_c",  m_ds.MF036.recv_acc_c));
            MFXXX.appendChild(CreateElementValue("person_bic",  m_ds.MF036.person_bic));
            MFXXX.appendChild(CreateElementValue("oper_date",  m_ds.MF036.oper_date));
            MFXXX.appendChild(CreateElementValue("need_cvit",  m_ds.MF036.need_cvit));
            MFXXX.appendChild(CreateElementValue("trad_dt",  m_ds.MF036.trad_dt));
            MFXXX.appendChild(CreateElementValue("trad_id",  m_ds.MF036.trad_id));
            
         elIF(m_ds.typeorder=="MF035")
           MFXXX.appendChild(CreateElementValue("person_bic",  m_ds.MF035.person_bic));
           MFXXX.appendChild(CreateElementValue("sr_acc_c",  m_ds.MF035.sr_acc_c));
           MFXXX.appendChild(CreateElementValue("oper_date",  m_ds.MF035.oper_date));
           MFXXX.appendChild(CreateElementValue("trad_dt",  m_ds.MF035.trad_dt));
           MFXXX.appendChild(CreateElementValue("trad_id",  m_ds.MF035.trad_id));
           MFXXX.appendChild(CreateElementValue("need_cvit",  m_ds.MF035.need_cvit));
           MFXXX.appendChild(CreateElementValue("reciv_payment",  m_ds.MF035.reciv_payment));
            
         end;

         MFXXX.appendChild(CreateElementValue("security_c", m_ds.Get_security_c()));
         MFXXX.appendChild(CreateElementValue("security_q", int(m_ds.Get_security_q())));

      end;   
      return MFXXX;
   end;

   private macro CreateElementValue_Documents_amount(val)
      return CreateElementValue("Documents_amount", val);
   end;

   private macro Create_Nodes()
      
      var ORDER_HEADER = CreateNode_ORDER_HEADER();
      var DOCUMENT = CreateNode_DOCUMENT();
      var BODY = CreateNode_BODY(); 

      m_MainNode = CreateNode("Batch");
      m_MainNode.appendChild(CreateElementValue_Documents_amount("1"));
      DOCUMENT.appendChild(ORDER_HEADER);
      DOCUMENT.appendChild(BODY);

      m_MainNode.appendChild(DOCUMENT);
      
   end;

   macro Construct(ds);
      CreateXML();
      m_ds = ds;
      Create_Nodes();
   end;

   initDL_XML();
   this.Construct(ds);
END;

CLASS (tRsbPanel) pnl_TransferOrder (DOC)
  private const FT_STRING = 7;

  const K_Enter = 13;
  const K_F3    = 317;
  const K_F2    = 316;
  const K_Alt_F3= 362;

  var curstr = 0;

var sql = "SELECT t.T_COMMCODE, SC_FROM.T_STORAGEID AS t_storageid_from, " +
   "       SC_FROM.T_DEPOACCCODE AS T_DEPOACCCODE_from, " +
   "       SC_FROM.T_DEPOPARTCODE  AS T_DEPOPARTCODE_from ,  " +
   "       SC_to.T_STORAGEID AS t_storageid_to, " +
   "       SC_to.T_DEPOACCCODE AS T_DEPOACCCODE_to, " +
   "       SC_to.T_DEPOPARTCODE  AS T_DEPOPARTCODE_to, " +
   "       t.\* " +
   "  FROM ddl_comm_dbt t, dscqracc_dbt sc_from, dscqracc_dbt sc_to " +
   " WHERE " +
   " sc_from.t_qrid = t.t_depsetid and " +
   " sc_to.t_qrid = t.t_depsetid_2 and " +
   " t.t_documentid = ? " ;
 var dl_cmd = DL_RSDCommand(sql);
 dl_cmd.AddParam(doc.rec.documentid);
 var rs = dl_cmd.execute;
 if(not rs.movenext())
   return 0;
 end;
  
  var TransferOrder = cl_TransferOrder(rs);
  
  InitTRSBPanel();
  Caption = "Поручение на перевод ценных бумаг.";
  Status  = "~ESC~Выход  ~F2~Выполнить";
  setSize(45,40);
  SetPosition(30,10);
  var TypeOperation = TransferOrder.Get_order_t_id();
  
  curstr = curstr + 1;  
     var lbl_RegForm;
     lbl_RegForm = TRSBLabel(2, curstr,"Регистрационная форма:");
      addlabel (lbl_RegForm);
  
  curstr = curstr + 1;  
      var lbl_Operation;
      lbl_Operation = TRSBLabel(4, curstr,"Операция:");
        addlabel (lbl_Operation);
      var fld_Operation;
      fld_Operation = TRSBEditField (FT_STRING);
      fld_Operation.setPosition(12,curstr);
      fld_Operation.setSize(30,1);
      fld_Operation.name = "fld_Operation";
      fld_Operation.textLength = 40;
      fld_Operation.editable = false;
      fld_Operation.value = TransferOrder.Get_OperationCaption(TypeOperation);
        addControl(fld_Operation);

  curstr = curstr + 1;  
      var lbl_Order;
      lbl_Order = TRSBLabel(4, curstr,"Поручение:");
        addlabel (lbl_Order);
      var fld_Order;
      fld_Order = TRSBEditField (FT_STRING);
      fld_Order.setPosition(12,curstr);
      fld_Order.setSize(30,1);
      fld_Order.name = "fld_Order";
      fld_Order.textLength = 30;
      fld_Order.editable = true;
      fld_Order.value = string(TransferOrder.order_header.contr_d_id);
        addControl(fld_Order);

  curstr = curstr + 1;  
      var lbl_Initiator;
      lbl_Initiator = TRSBLabel(4, curstr,"Инициатор:");
        addlabel (lbl_Initiator);
      var fld_Initiator;
      fld_Initiator = TRSBEditField (FT_STRING);
      fld_Initiator.setPosition(12,curstr);
      fld_Initiator.setSize(30,1);
      fld_Initiator.name = "fld_Initiator";
      fld_Initiator.textLength = 40;
      fld_Initiator.editable = False;
      fld_Initiator.value = TransferOrder.pt_Initiator.Code(PTCK_MICEX) + "("+TransferOrder.pt_initiator.ShortName+")"; 
        addControl(fld_Initiator);

  curstr = curstr + 1;  
      var lbl_OrderReciever;
      lbl_OrderReciever = TRSBLabel(4, curstr,"Получатель поручения:");
        addlabel (lbl_OrderReciever);
      var fld_OrderReciever;
      fld_OrderReciever = TRSBEditField (FT_STRING);
      fld_OrderReciever.setPosition(20,curstr);
      fld_OrderReciever.setSize(22,1);
      fld_OrderReciever.name = "fld_OrderReciever";
      fld_OrderReciever.textLength = 40;
      fld_OrderReciever.editable = False;
      fld_OrderReciever.value = TransferOrder.pt_OrderReciever.Code(PTCK_MICEX) + "("+TransferOrder.pt_OrderReciever.ShortName+")"; 
        addControl(fld_OrderReciever);

  curstr = curstr + 1;  
      var lbl_Period;
      lbl_Period = TRSBLabel(4, curstr,"Период исполнения:");
      addlabel (lbl_Period);
      var fld_StartPeriod;
      fld_StartPeriod = TRSBEditField (FT_STRING);
      fld_StartPeriod.setPosition(21,curstr);
      fld_StartPeriod.setSize(8,1);
      fld_StartPeriod.textLength = 12;
      fld_StartPeriod.name = "fld_StartPeriod";
      fld_StartPeriod.value = TransferOrder.order_header.execute_dt;
        addControl(fld_StartPeriod);
      var lbl_Tld1;
      lbl_Tld1 = TRSBLabel(30, curstr,"-");
        addlabel (lbl_Tld1);
        var fld_EndPeriod;
      fld_EndPeriod = TRSBEditField (FT_STRING);
      fld_EndPeriod.setPosition(32,curstr);
      fld_EndPeriod.setSize(8,1);
      fld_EndPeriod.textLength = 12;
      fld_EndPeriod.name = "fld_EndPeriod";
      fld_EndPeriod.value = TransferOrder.order_header.expirat_dt;
        addControl(fld_EndPeriod);

  curstr = curstr + 2;  
     
     var lbl_NRDSyde_m;
     var lbl_NRDSyde_m_Caption = "";
     var lbl_NRDSyde_Caption = "";
     var fld_NRDSyde_value = "";
     if     (TransferOrder.TypeOrder == "MF036") lbl_NRDSyde_m_Caption = lbl_NRDSyde_Caption = "Отправитель"; fld_NRDSyde_value = TransferOrder.pt_Initiator.Code(PTCK_MICEX) + "("+TransferOrder.pt_initiator.ShortName+")";  
       elIF (TransferOrder.TypeOrder == "MF035") lbl_NRDSyde_m_Caption = lbl_NRDSyde_Caption = "Получатель"; fld_NRDSyde_value = TransferOrder.pt_Initiator.Code(PTCK_MICEX) + "("+TransferOrder.pt_initiator.ShortName+")"; 
       elIF (TransferOrder.TypeOrder == "MF010") lbl_NRDSyde_m_Caption = "Со счета отправителя"; lbl_NRDSyde_Caption = "Отправитель"; fld_NRDSyde_value = TransferOrder.MF010.deponent_c;
       else lbl_NRDSyde_m_Caption = ""; lbl_NRDSyde_Caption   = "";
     end;

     lbl_NRDSyde_m = TRSBLabel(2, curstr,lbl_NRDSyde_m_Caption);
        addlabel (lbl_NRDSyde_m);
  
  curstr = curstr + 1;  
      var lbl_NRDSyde;
      lbl_NRDSyde = TRSBLabel(4, curstr, lbl_NRDSyde_Caption);
        addlabel (lbl_NRDSyde);
      var fld_NRDSyde;
      fld_NRDSyde = TRSBEditField (FT_STRING);
      fld_NRDSyde.setPosition(15,curstr);
      fld_NRDSyde.setSize(27,1);
      fld_NRDSyde.name = "fld_NRDSyde";
      fld_NRDSyde.textLength = 40;
      fld_NRDSyde.editable = False;
      fld_NRDSyde.value = fld_NRDSyde_value; 
        addControl(fld_NRDSyde);

  curstr = curstr + 1;  
      var lbl_DepoAccSender;
      lbl_DepoAccSender = TRSBLabel(4, curstr,"Счет Депо:");
        addlabel (lbl_DepoAccSender);
      var fld_DepoAccSender;
      fld_DepoAccSender = TRSBEditField (FT_STRING);
      fld_DepoAccSender.setPosition(15,curstr);
      fld_DepoAccSender.setSize(27,1);
      fld_DepoAccSender.name = "fld_DepoAccSender";
      fld_DepoAccSender.textLength = 27;
      fld_DepoAccSender.editable = False;
      fld_DepoAccSender.value = TransferOrder.Get_dep_acc_c();
        addControl(fld_DepoAccSender);

  curstr = curstr + 1;  
      var lbl_DepoPartSender;
      lbl_DepoPartSender = TRSBLabel(4, curstr,"Раздел счета:");
        addlabel (lbl_DepoPartSender);
      var fld_DepoPartSender;
      fld_DepoPartSender = TRSBEditField (FT_STRING);
      fld_DepoPartSender.setPosition(15,curstr);
      fld_DepoPartSender.setSize(27,1);
      fld_DepoPartSender.name = "fld_DepoPartSender";
      fld_DepoPartSender.textLength = 27;
      fld_DepoPartSender.editable = FAlse;
      fld_DepoPartSender.value = TransferOrder.Get_sec_c();
        addControl(fld_DepoPartSender);
/*
  curstr = curstr + 1;  
      var lbl_PartIDSender;
      lbl_PartIDSender = TRSBLabel(4, curstr,"Идентификатор раздела:");
        addlabel (lbl_PartIDSender);
      var fld_PartIDSender;
      fld_PartIDSender = TRSBEditField (FT_STRING);
      fld_PartIDSender.setPosition(20,curstr);
      fld_PartIDSender.setSize(22,1);
      fld_PartIDSender.name = "fld_PartIDSender";
      fld_PartIDSender.textLength = 22;
      fld_PartIDSender.editable = True;
       addControl(fld_PartIDSender);
*/
if(TransferOrder.TypeOrder != "MF010")
  
  curstr = curstr + 2;  
     var lbl_AccPlace;
     lbl_AccPlace = TRSBLabel(2, curstr,"Регистратор/депозитарий (место расчетов):");
      addlabel (lbl_AccPlace);
  
  curstr = curstr + 1;  
      var lbl_BICAccPlace;
      lbl_BICAccPlace = TRSBLabel(4, curstr,"BIC места расчетов:");
        addlabel (lbl_BICAccPlace);
      var fld_BICAccPlace;
      fld_BICAccPlace = TRSBEditField (FT_STRING);
      fld_BICAccPlace.setPosition(20,curstr);
      fld_BICAccPlace.setSize(22,1);
      fld_BICAccPlace.name = "fld_BICAccPlace";
      fld_BICAccPlace.textLength = 22;
      fld_BICAccPlace.editable = False;
      fld_BICAccPlace.value = TransferOrder.Get_reestr_bic();

        addControl(fld_BICAccPlace);

  curstr = curstr + 2;  
     var lbl_Services;
     lbl_Services = TRSBLabel(2, curstr,"Сервисы вышестоящих депозитариев:");
      addlabel (lbl_Services);
  
  curstr = curstr + 1;  
      var lbl_ICSD;
      lbl_ICSD = TRSBLabel(4, curstr,"Приоритет исполнения поручения ICSD:");
        addlabel (lbl_ICSD);
      var fld_ICSD;
      fld_ICSD = TRSBEditField (FT_STRING);
      fld_ICSD.setPosition(30,curstr);
      fld_ICSD.setSize(12,1);
      fld_ICSD.name = "fld_ICSD";
      fld_ICSD.textLength = 12;
      fld_ICSD.editable = True;
        addControl(fld_ICSD);

  curstr = curstr + 1;  
      var lbl_ICSDPoolID;
      lbl_ICSDPoolID = TRSBLabel(4, curstr,"Идентификатор пула ICSD:");
        addlabel (lbl_ICSDPoolID);
      var fld_ICSDPoolID;
      fld_ICSDPoolID = TRSBEditField (FT_STRING);
      fld_ICSDPoolID.setPosition(30,curstr);
      fld_ICSDPoolID.setSize(12,1);
      fld_ICSDPoolID.name = "fld_ICSDPoolID";
      fld_ICSDPoolID.textLength = 12;
      fld_ICSDPoolID.editable = True;
        addControl(fld_ICSDPoolID);

end;



     var lbl_SydeEclr_m;
     var lbl_SydeEclr_m_Caption;

     var lbl_SydeEclrBIC;
     var fld_SydeEclrBIC;

     var lbl_Reciever;
     var Lbl_Reciever_Caption;
     var fld_Reciever;

     var lbl_RecieverAccPart;
     var lbl_RecieverAccPart_Caption;
     var fld_RecieverAccPart;
   
     if     (TransferOrder.TypeOrder == "MF036") lbl_SydeEclr_m_Caption = "Отправитель"; 
       elIF (TransferOrder.TypeOrder == "MF035") lbl_SydeEclr_m_Caption = "Получатель";
       elIF (TransferOrder.TypeOrder == "MF010") lbl_SydeEclr_m_Caption = "На счет получателя"; Lbl_Reciever_Caption = "Получатель";
       else lbl_SydeEclr_m_Caption = ""; Lbl_Reciever_Caption = "";
     end;
        
   curstr = curstr + 2;  
     lbl_SydeEclr_m = TRSBLabel(2, curstr,lbl_SydeEclr_m_Caption);
        addlabel (lbl_SydeEclr_m);

  if(TransferOrder.TypeOrder != "MF010")

    curstr = curstr + 1;  
      lbl_SydeEclrBIC = TRSBLabel(4, curstr,"BIC:");
        addlabel (lbl_SydeEclrBIC);

      fld_SydeEclrBIC = TRSBEditField (FT_STRING);
      fld_SydeEclrBIC.setPosition(15,curstr);
      fld_SydeEclrBIC.setSize(27,1);
      fld_SydeEclrBIC.name = "fld_SydeEclrBIC";
      fld_SydeEclrBIC.textLength = 27;
      fld_SydeEclrBIC.editable = False;
      fld_SydeEclrBIC.value =  TransferOrder.GET_person_bic;
        addControl(fld_SydeEclrBIC);
  else
    curstr = curstr + 1;  
      lbl_Reciever = TRSBLabel(4, curstr, Lbl_Reciever_Caption);
        addlabel (lbl_Reciever);

      fld_Reciever = TRSBEditField (FT_STRING);
      fld_Reciever.setPosition(15,curstr);
      fld_Reciever.setSize(27,1);
      fld_Reciever.name = "fld_Reciever";
      fld_Reciever.textLength = 27;
      fld_Reciever.editable = False;
      fld_Reciever.value =  TransferOrder.mf010.corr_Code;
        addControl(fld_Reciever);
  end;

  curstr = curstr + 1;  
      var lbl_DepoAccEclr;
      lbl_DepoAccEclr = TRSBLabel(4, curstr,"Счет Депо:");
        addlabel (lbl_DepoAccEclr);
      var fld_DepoAccEclr;
      fld_DepoAccEclr = TRSBEditField (FT_STRING);
      fld_DepoAccEclr.setPosition(15,curstr);
      fld_DepoAccEclr.setSize(27,1);
      fld_DepoAccEclr.name = "fld_DepoAccEclr";
      fld_DepoAccEclr.textLength = 27;
      fld_DepoAccEclr.editable = False;
      fld_DepoAccEclr.value =TransferOrder.GET_recv_acc_c();
        addControl(fld_DepoAccEclr);

if(TransferOrder.TypeOrder != "MF010")
  curstr = curstr + 1;  
      var lbl_SydeECLR_PersonType;
      lbl_SydeECLR_PersonType = TRSBLabel(4, curstr,"Тип лица:");
        addlabel (lbl_SydeECLR_PersonType);
      var fld_SydeECLR_PersonType;
      fld_SydeECLR_PersonType = TRSBEditField (FT_STRING);
      fld_SydeECLR_PersonType.setPosition(20,curstr);
      fld_SydeECLR_PersonType.setSize(22,1);
      fld_SydeECLR_PersonType.name = "fld_SydeECLR_PersonType";
      fld_SydeECLR_PersonType.textLength = 22;
      fld_SydeECLR_PersonType.editable = False;
      fld_SydeECLR_PersonType.value = iif(TransferOrder.MF036.pr_jur_or_ind == "J","Юридическое лицо", "");
        addControl(fld_SydeECLR_PersonType);
else
  curstr = curstr + 1;  
      var lbl_PartAccSyde2;
      lbl_PartAccSyde2 = TRSBLabel(4, curstr,"Раздел счета:");
        addlabel (lbl_PartAccSyde2);
      var fld_PartAccSyde2;
      fld_PartAccSyde2 = TRSBEditField (FT_STRING);
      fld_PartAccSyde2.setPosition(20,curstr);
      fld_PartAccSyde2.setSize(22,1);
      fld_PartAccSyde2.name = "fld_PartAccSyde2";
      fld_PartAccSyde2.textLength = 22;
      fld_PartAccSyde2.editable = False;
      fld_PartAccSyde2.value = TransferOrder.MF010.corr_sec_c;
        addControl(fld_PartAccSyde2);
end;
  curstr = curstr + 2;  
     var lbl_Avoirisses;
     lbl_Avoirisses = TRSBLabel(2, curstr,"Ценные бумаги:");
      addlabel (lbl_Avoirisses);
  
  curstr = curstr + 1;  
     var lbl_FICode;
     lbl_FICode = TRSBLabel(4, curstr,"Код ц/б:");
      addlabel (lbl_FICode);
     var lbl_FIShortName;
     lbl_FIShortName = TRSBLabel(17, curstr,"Краткое наименование:");
      addlabel (lbl_FIShortName);

  curstr = curstr + 1;  

      var fld_FICode;
      fld_FICode = TRSBEditField (FT_STRING);
      fld_FICode.setPosition(4,curstr);
      fld_FICode.setSize(12,1);
      fld_FICode.name = "fld_FICode";
      fld_FICode.textLength = 12;
      fld_FICode.editable = FAlse;
      fld_FICode.value = TransferOrder.Get_security_c();
        addControl(fld_FICode);
      var fld_FIShortName;
      fld_FIShortName = TRSBEditField (FT_STRING);
      fld_FIShortName.setPosition(17,curstr);
      fld_FIShortName.setSize(25,1);
      fld_FIShortName.name = "fld_FIShortName";
      fld_FIShortName.textLength = 25;
      fld_FIShortName.editable = FAlse;
      fld_FIShortName.value = TransferOrder.GET_security_name();
        addControl(fld_FIShortName);

  curstr = curstr + 1;  
     var lbl_FILSIN;
     lbl_FILSIN = TRSBLabel(4, curstr,"Номер гос.регистрации:");
      addlabel (lbl_FILSIN);
     var lbl_FIISIN;
     lbl_FIISIN = TRSBLabel(25, curstr,"ISIN:");
      addlabel (lbl_FIISIN);

  curstr = curstr + 1;  

      var fld_FILSIN;
      fld_FILSIN = TRSBEditField (FT_STRING);
      fld_FILSIN.setPosition(4,curstr);
      fld_FILSIN.setSize(20,1);
      fld_FILSIN.name = "fld_FILSIN";
      fld_FILSIN.textLength = 20;
      fld_FILSIN.editable = FAlse;
      fld_FILSIN.value =TransferOrder.Get_security_lsin();
        addControl(fld_FILSIN);
      var fld_FIISIN;
      fld_FIISIN = TRSBEditField (FT_STRING);
      fld_FIISIN.setPosition(25,curstr);
      fld_FIISIN.setSize(17,1);
      fld_FIISIN.name = "fld_FIISIN";
      fld_FIISIN.textLength = 17;
      fld_FIISIN.editable = False;
      fld_FIISIN.value = TransferOrder.Get_security_isin();
        addControl(fld_FIISIN);

   curstr = curstr + 1;  
     var lbl_Amount;
     lbl_Amount = TRSBLabel(4, curstr,"Кол-во(шт.):");
        addlabel (lbl_Amount);
   curstr = curstr + 1;  
      var fld_Amount;
      fld_Amount = TRSBEditField (FT_STRING);
      fld_Amount.setPosition(4,curstr);
      fld_Amount.setSize(15,1);
      fld_Amount.name = "fld_Amount";
      fld_Amount.textLength = 15;
      fld_Amount.editable = False;
      fld_Amount.value = TransferOrder.Get_security_q();
        addControl(fld_Amount);

if(oldfilename !="")
   curstr = curstr + 2;  
     var lbl_Warning;
     lbl_Warning = TRSBLabel(4, curstr,"Внимание:");
        addlabel (lbl_Warning);
   curstr = curstr + 1;  
      var fld_Warn;
      fld_Warn = TRSBEditField (FT_STRING);
      fld_Warn.setPosition(4,curstr);
      fld_Warn.setSize(30,4);
      fld_Warn.name = "fld_Warn";
      fld_Warn.textLength = 200;
      fld_Warn.editable = False;
      fld_Warn.value = "По данному переводу уже формировалось сообщение №" + ordernum + " от " + orderdate + ", выгруженное в файл:" + oldfilename;
        addControl(fld_Warn);
end;

    addEventHandler (RSB_EV_Key_Pressed, R2M(this,"on_KeyPressed"));
    macro on_KeyPressed(ev)
       var errflag = 0;
       var RepFlag = 0;
       if (ev.KeyCode == K_F3)
        
       elif(ev.keyCode == K_F2) 
          TransferOrder.order_header.contr_d_id = fld_Order.value;
//          TransferOrder.MF036.trad_id = fld_Order.value;
          ordernum = fld_Order.value;  
          if(oldfilename != "")
             if( MsgBoxEx("Вы хотите cформировать повторно" + "?", MB_YES + MB_NO, IND_NO) == IND_YES )
               repFlag = 1
             end;             
          end;
          if ((oldfilename == "") or (RepFlag == 1))  
            var xml_order = TransferOrder_XML(TransferOrder);
            xml_order.SaveXML();
            close(0); 
          end;
          
       end;
    end;

END; //CLASS

macro CreateTransferOrder(DOC)

  var pnlTransferOrder:TRSBpanel = pnl_TransferOrder(DOC);
  pnlTransferOrder.run();
  
end;
