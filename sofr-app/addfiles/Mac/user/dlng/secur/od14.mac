import or_rep_h, total, globals, oralib, likepy, vslib, PTinter;

macro f_od14 ()
  var color = 16777062;
  var head_format = "c:ex_FS(b):ex_B(tblr):ex_BC(" + color + ")";
  var line_format = "r:ex_B(tblr):ex_FZ(8)";
  var line_format_l = "l:ex_B(tblr):ex_FZ(8)";
  var begindate = {curdate};
  var enddate = {curdate};
  var rn:integer = 1;
  var sheet = 1;
  var count = 0;
  var Rep, sql;
  var IsCB:bool = false;
  var tracc, trcur, otr, obacc, obcur, oob, tssacc, tsscur, otss;

  if (not ВвестиПериодДат (begindate, enddate))
     exit (1);
  end;

  /*10 колонок*/
  Rep = CMakereport("┌─┬─┬─┬─┬─┬─┬─┬─┬─┬─┐");

  Rep.SetDefaultFontName("Times New Roman");
  Rep.SetDefaultFontSize(10);
  Rep.SetFlagShowGrid(true);
  Rep.SetExecute("iBook.Sheets("+sheet+").Rows().RowHeight = 12.75;");

  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(1).ColumnWidth = 8;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(2).ColumnWidth = 40;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(3).ColumnWidth = 22;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(4).ColumnWidth = 11;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(5).ColumnWidth = 11;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(6).ColumnWidth = 11;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(7).ColumnWidth = 11;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(8).ColumnWidth = 12;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(9).ColumnWidth = 12;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(10).ColumnWidth = 19;");

  Rep.AddPrintCell("№ п/п",                          0, 0, head_format);
  Rep.AddPrintCell("Субъект",                        0, 0, head_format);
  Rep.AddPrintCell("Лицевой счет по учету опциона",  0, 0, head_format);
  Rep.AddPrintCell("Код валюты",                     0, 0, head_format);
  Rep.AddPrintCell("Тип (Покупка/продажа)",          0, 0, head_format);
  Rep.AddPrintCell("Дата заклюения",                 0, 0, head_format);
  Rep.AddPrintCell("Дата завершения",                0, 0, head_format);
  Rep.AddPrintCell("Сумма требования",               0, 0, head_format);
  Rep.AddPrintCell("Сумма обязательства",            0, 0, head_format);
  Rep.AddPrintCell("Тип сделки",                     0, 0, head_format);
  Rep.AddStr();   

  rn = rn + 1;
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"A1:J1\").VerticalAlignment = "+ALIGN_CENTER+";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Rows(\"1:1\").EntireRow.AutoFit;");

  rn = rn + 1;

  RemProgress();
  sql = "SELECT bdt, edt, fi_kind, t_id, T_NAME, t_state, t_extcode, t_code, t_contractor, t_dealtype, t_date, t_execdate, t_ispfi, t_marketkind, t_fiidT, t_amountT, " +
        "       CASE WHEN t_fiidT = 0 THEN t_amountT ELSE ROUND (rsi_rsb_fiinstr.convsum (t_amountT, t_fiidT, 0, t_execdate), 2) END t_amountTRUR, " +
        "       CASE WHEN t_priceT = 1 AND t_fiidT != 0 THEN t_priceO ELSE t_priceT END t_priceT, " +
        "       CASE WHEN t_fiidT = 0 THEN 1 ELSE ROUND (rsi_rsb_fiinstr.convsum (1, t_fiidT, 0, t_execdate), 4) END t_priceTCB, " +
        "       t_fiidO, t_amountO, " +
        "       CASE WHEN t_fiidO = 0 THEN t_amountO ELSE ROUND (rsi_rsb_fiinstr.convsum (t_amountO, t_fiidO, 0, t_execdate), 2) END t_amountORUR, " +
        "       CASE WHEN t_priceO = 1 AND t_fiidO != 0 THEN t_priceT ELSE t_priceO END t_priceO, " +
        "       CASE WHEN t_fiidO = 0 THEN 1 ELSE ROUND (rsb_fiinstr.convsum (1, t_fiidO, 0, t_execdate), 4) END t_priceOCB, " +
        "       T_ISO_NUMBERO, T_ISO_NUMBERT, T_ACCOUNT, " +
        "       NVL ((SELECT t_id FROM (SELECT t_id FROM ddvnfrval_dbt WHERE t_dealid = dvndeal.t_id AND t_date <= edt ORDER BY t_date DESC, t_id DESC) WHERE ROWNUM = 1), 0) t_dvnfrvalid, " +
        "       (SELECT C.T_SHORTNAME FROM dparty_dbt c WHERE C.T_PARTYID = t_contractor) T_SHORTNAME, " +
        "       (SELECT COUNT (1) cnt FROM dpartyown_dbt partyown WHERE partyown.t_partyid = t_contractor AND partyown.t_partykind = 2) t_contractorisbank " +
        "  FROM ( " +                             // Опцион/Форвард (любой актив за валюту)
        "        SELECT bdt, edt, fininstrT.t_fi_kind fi_kind, " +
                       // Сделка
        "               dvndeal.t_id, dvndeal.t_state, dvndeal.t_extcode, dvndeal.t_code, dvndeal.t_contractor, " +
        "               CASE WHEN dvndeal.t_type = 1 THEN 'покупка' ELSE 'продажа' END t_dealtype, " +
        "               dvndeal.t_date, " +
        "               GREATEST (dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdate, dvndeal.t_ispfi, dvndeal.t_marketkind, " +
                       // Требования
        "               CASE WHEN dvndeal.t_type != 1 THEN fininstrO.t_fiid ELSE fininstrT.t_fiid END t_fiidT, " +
        "               CASE WHEN dvndeal.t_type != 1 THEN dvnfiT.t_cost ELSE dvnfiT.t_amount END t_amountT, " +
        "               CASE WHEN dvndeal.t_type != 1 THEN 1 ELSE dvnfiT.t_price END t_priceT, " +
                       // Обязательста
        "               CASE WHEN dvndeal.t_type != 1 THEN fininstrT.t_fiid ELSE fininstrO.t_fiid END t_fiidO, " +
        "               CASE WHEN dvndeal.t_type != 1 THEN dvnfiT.t_amount ELSE dvnfiT.t_cost END t_amountO, " +
        "               CASE WHEN dvndeal.t_type != 1 THEN dvnfiT.t_price ELSE 1 END t_priceO, " +
        "               FININSTRO.T_ISO_NUMBER T_ISO_NUMBERO,FININSTRT.T_ISO_NUMBER T_ISO_NUMBERT,CACCO.T_ACCOUNT T_ACCOUNT,CACCO.T_CURRENCY, OPRKOPER.T_NAME " +
        "          FROM ddvndeal_dbt dvndeal " +
        "               JOIN (SELECT TO_DATE ('"+begindate+"', 'dd.mm.yyyy') bdt, TO_DATE ('"+enddate+"', 'dd.mm.yyyy') edt FROM DUAL) ON 1 = 1 " +
        "               JOIN doprkoper_dbt oprkoper ON oprkoper.t_kind_operation = dvndeal.t_kind AND REGEXP_LIKE (oprkoper.t_systypes, '[O|U]') " +
        "               JOIN ddvnfi_dbt dvnfiT ON dvnfiT.t_dealid = dvndeal.t_id AND dvnfiT.t_type = 0 " +
        "               JOIN dfininstr_dbt fininstrT ON fininstrT.t_fiid = dvnfiT.t_fiid AND fininstrT.t_fi_kind = 1 " +
        "               JOIN dfininstr_dbt fininstrO ON fininstrO.t_fiid = dvnfiT.t_pricefiid AND fininstrO.t_fi_kind = 1 " +
        "               JOIN dmcaccdoc_dbt caccO ON CACCO.T_DOCID = DVNDEAL.T_ID AND CACCO.T_DOCKIND = 199 AND CACCO.T_CATNUM = 1225 AND CACCO.T_ISUSABLE = 'X' " +
//        "         WHERE dvndeal.t_date BETWEEN bdt AND edt " +
        "         WHERE dvndeal.t_date <= edt " +
        "               AND GREATEST (dvnfiT.t_execdate, dvnfiT.t_paydate) > edt " +
        "               AND dvndeal.t_dockind = 199 " +         //Внебиржевая сделка с ПИ
        "               AND dvndeal.t_state >= 1 " +
        "               AND fininstrT.t_fiid != fininstrO.t_fiid) dvndeal";
  sql = ExecSqlSelect(sql);

  count = 0;
  InitProgress(-1, "Сбор данных");
  rn = rn + 1;
  while (sql.MoveNext())
    if (sql.value("t_contractorisbank") == 0)
      Rep.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = true;");

      Rep.AddPrintCell(count+1, 0, 0, line_format);                              // 1. Номер п/п
      Rep.AddPrintCell(sql.value("T_SHORTNAME"), 0, 0, line_format_l);           // 2. субъект
      Rep.AddPrintCell(sql.value("T_ACCOUNT"), 0, 0, line_format_l);             // 3. счет тр
      Rep.AddPrintCell(sql.value("T_ISO_NUMBERT"), 0, 0, line_format);           // 4. валюта тр
      Rep.AddPrintCell(sql.value("T_DEALTYPE"), 0, 0, line_format_l);            // 5. направление
      Rep.AddPrintCell(date(sql.value("T_DATE")), 0, 0, line_format);            // 6. дата закл
      Rep.AddPrintCell(date(sql.value("T_EXECDATE")), 0, 0, line_format);        // 7. дата заверш
      Rep.AddPrintCell(sql.value("T_AMOUNTT"), 0, 0, line_format);               // 8. сумма требования
      Rep.AddPrintCell(sql.value("T_AMOUNTO"), 0, 0, line_format);               // 9. сумма обеспечения
      Rep.AddPrintCell(sql.value("T_NAME"), 0, 0, line_format_l);                // 10. Тип сделки

      Rep.AddStr(); 

      UseProgress(count = count + 1);
      rn = rn + 1;
    end;
  end;
  RemProgress();

  /*Запуск Excel*/
  Rep.PrintWinRep("Сделки");
  Rep.SetZoomType(ZOOM_TYPE_A4L); /*альбомная ориентация*/
  Rep.SetWinRepOutput();
  Rep.ShowWinRep();

onerror()
  RemProgress();
end;

f_od14();
exit(1);