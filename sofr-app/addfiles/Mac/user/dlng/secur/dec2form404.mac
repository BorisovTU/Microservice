/*
$Name:        dec2form404.mac
$Module:      Ценные бумаги
$Description: Расшифровки к форме 404
$Programmer:  Кротов А.
*/
import dec2form404_panel, ReportUser;
import captureoutput;
import spinter;


PRIVATE CLASS (TX_ReportUser) dec2form404_Report
  var m_BeginDate;

  /*Создание отчета*/
  PRIVATE MACRO Create()

    /*Не будем каждый раз искать котировку*/
    class tRate
      var afiid;
      var aRateValue;
      var aRateType;
      var aNKD;
    end;
    var aRate = tarray();

    /*Данные по котировке*/
    macro GetRate(fiidname, dt, fiid, facevaluefi, RateValue:@double, RateType:@string, NKD:@double, RateNote:@string)
      macro GetRate(FromFI, ToFI, RateType, dt, RateDate:@date)
        var m_RS_w, m_cmd_w, nullflag;
        StartCaptureOutput();
        [
          declare
            FromFI_ number := :FromFI;
            ToFI_ number := :ToFI;
            RateType_ number := :RateType;
            dt_ date := :dt;
            RateValue_ number := 0.0;
            RateDate_ date := null;
            RateID_ number;
            RateFI_ number;
            RateIsRelative_ char(1) := chr(0);
          begin
            begin
              RateValue_ := RSI_RSB_FIInstr.FI_GetRate(FromFI_, ToFI_, RateType_, dt_, dt_-to_date('01.01.0001','DD.MM.YYYY'), 0, RateID_, RateDate_);
              if(RateValue_ <= 0) then
                RateValue_ := RSI_RSB_FIInstr.FI_GetRate(FromFI_, -1, RateType_, dt_, dt_-to_date('01.01.0001','DD.MM.YYYY'), 0, RateID_, RateDate_);
              end if;
              if(RateID_ > 0)then
                begin
                  select t_rate/power(10,t_point)/t_scale, t_fiid, t_isrelative
                  into RateValue_, RateFI_, RateIsRelative_
                  from dratedef_dbt
                  where t_rateid = RateID_ and
                        t_isinverse != chr(88) and
                        t_sincedate = RateDate_;
                exception when others then
                  begin
                    select t_rate/power(10,t_point)/t_scale
                    into RateValue_
                    from dratehist_dbt
                    where t_rateid = RateID_ and
                          t_isinverse != chr(88) and
                          t_sincedate = RateDate_;
                    select t_fiid, t_isrelative
                    into RateFI_, RateIsRelative_
                    from dratedef_dbt
                    where t_rateid = RateID_;
                  exception when others then
                    null;
                  end;
                end;
              end if;
            exception when others then
              null;
            end;
            if(RateIsRelative_ = chr(88))then
              RateValue_ := round(RateValue_ * rsb_fiinstr.FI_GetNominalOnDate(FromFI_, dt_) / 100, 4);
            end if;
            if(RateFI_ != ToFI_)then
              RateValue_ := rsi_rsb_fiinstr.convsum(RateValue_, RateFI_, ToFI_, dt_);
            end if;
            
            if (RateValue_ is null) then
              RateDate_ := to_date('01.01.0001','DD.MM.YYYY');
            end if;
            
            :RateValue := RateValue_;
            :RateDate := RateDate_;
          end;
        ];
        m_cmd_w = RsdCommand(EndCaptureOutput());
        m_cmd_w.AddParam("FromFI", RSDBP_IN, FromFI);
        m_cmd_w.AddParam("ToFI", RSDBP_IN, ToFI);
        m_cmd_w.AddParam("RateType", RSDBP_IN, RateType);
        m_cmd_w.AddParam("dt", RSDBP_IN, dt);
        m_cmd_w.AddParam("RateValue", RSDBP_OUT, V_DOUBLE);
        m_cmd_w.AddParam("RateDate", RSDBP_OUT, V_DATE);
        m_cmd_w.Execute();
        RateDate = m_cmd_w.value("RateDate", nullflag);
        if(RateDate == " 1.01.0001")
          RateDate = date(0,0,0);
        else
          RateDate = date(RateDate);
        end;
        return m_cmd_w.value("RateValue");
      end;
      macro AddRate(fiid, RateValue, RateType, NKD)
        aRate[aRate.size] = tRate;
        aRate[aRate.size - 1].afiid = fiid;
        aRate[aRate.size - 1].aRateValue = RateValue;
        aRate[aRate.size - 1].aRateType = RateType;
        aRate[aRate.size - 1].aNKD = NKD;
      end;
      /*Поищем котировку в уже определенных*/
      var i = 0;
      while(i < aRate.size)
        if(aRate[i].afiid == fiid)
          RateValue = aRate[i].aRateValue;
          RateType = aRate[i].aRateType;
          NKD = aRate[i].aNKD;
          RateNote = "";
          return;
        end;
        i = i + 1;
      end;
      /*Не нашли*/
      NKD = НКД(fiid, 1, dt);
      var RateDate1, RateDate11, RateDate4, RateDate23;
      var RateValue1, RateValue11, RateValue4, RateValue23;
      RateValue1 = GetRate(fiid, facevaluefi, 1/*Рыночная цена*/, dt, @RateDate1);
      if(RateDate1 == dt)
        RateValue = RateValue1;
        RateType = "РЦ";
        RateNote = "";
        AddRate(fiid, RateValue, RateType, NKD);
        return;
      end;
      RateValue11 = GetRate(fiid, facevaluefi, 11/*Рыночная цена для Ф404*/, dt, @RateDate11);
      if(RateDate11 == dt)
        RateValue = RateValue11;
        RateType = "РЦ";
        RateNote = "";
        AddRate(fiid, RateValue, RateType, NKD);
        return;
      end;
      RateValue4 = GetRate(fiid, facevaluefi, 4/*Средневзвешенная цена*/, dt, @RateDate4);
      if(RateDate4 == dt)
        RateValue = RateValue4;
        RateType = "РЦ";
        RateNote = "";
        AddRate(fiid, RateValue, RateType, NKD);
        return;
      end;
      RateValue23 = GetRate(fiid, facevaluefi, 23/*Цена закрытия "Bloomberg"*/, dt, @RateDate23);
      if(RateDate23 == dt)
        RateValue = RateValue23;
        RateType = "РЦ";
        RateNote = "";
        AddRate(fiid, RateValue, RateType, NKD);
        return;
      end;
      if((RateDate1 == date(0,0,0)) and (RateDate11 == date(0,0,0)) and (RateDate4 == date(0,0,0)) and (RateDate23 == date(0,0,0)))
        RateValue = 0.0;
        RateType = "";
        RateNote = "Для выпуска \"" + fiidname + "\" не найдена рыночная цена";
        return;
      end;
      if((RateDate1 >= RateDate11) and (RateDate1 >= RateDate4) and (RateDate1 >= RateDate23))
        RateValue = RateValue1;
        RateType = "РЦ";
        RateNote = "Для выпуска \"" + fiidname + "\" в качестве рыночной цены использовался курс вида \"Рыночная цена\" за дату " + string(RateDate1:f);
        AddRate(fiid, RateValue, RateType, NKD);
        return;
      elif((RateDate11 >= RateDate4) and (RateDate11 >= RateDate23))
        RateValue = RateValue11;
        RateType = "РЦ";
        RateNote = "Для выпуска \"" + fiidname + "\" в качестве рыночной цены использовался курс вида \"Рыночная цена для Ф404\" за дату " + string(RateDate11:f);
        AddRate(fiid, RateValue, RateType, NKD);
        return;
      elif(RateDate4 >= RateDate23)
        RateValue = RateValue4;
        RateType = "РЦ";
        RateNote = "Для выпуска \"" + fiidname + "\" в качестве рыночной цены использовался курс вида \"Средневзвешенная цена\" за дату " + string(RateDate4:f);
        AddRate(fiid, RateValue, RateType, NKD);
      else
        RateValue = RateValue23;
        RateType = "РЦ";
        RateNote = "Для выпуска \"" + fiidname + "\" в качестве рыночной цены использовался курс вида \"Цена закрытия Bloomberg\" за дату " + string(RateDate23:f);
        AddRate(fiid, RateValue, RateType, NKD);
      end;
      return;
    end;

    class tAmount
      var AmountSum;
      var AmountType;
      var StorageCode;
    end;

/*Точка входа*/
    var cnt;
    var m_cmd;
    var Amount = tarray(), AmountSum, AmountReverse, RateValue, RateType, NKD, RateNote, CalcCost, Note, i;

    /*Отключаем все индикаторы*/
    if(m_UseTemplate)
      m_ObjTemplateXLS.SetFlagShowIndicator(false);
    else
      __BUG_Global_m_ObjTemplateXLS.SetFlagShowIndicator(false);
    end;
    m_ProgressIndicator = CreateProgressIndicator(true);

    /*Даты отчета*/
    m_BeginDate = FormData.BeginDate;

/*Лист "Расшифровке к форме 404"*/
    SetActiveSheet("Расшифровки к форме 404");
    PrintFormatString("", "reportname", "Расшифровки к форме 404 на " + string(m_BeginDate:f));
    RegisterTable( "row1_0", "",
             /* 1*/ "row1_1", 
             /* 2*/ "row1_2", 
             /* 3*/ "row1_3", 
             /* 4*/ "row1_4", 
             /* 5*/ "row1_5", 
             /* 6*/ "row1_6", 
             /* 7*/ "row1_7", 
             /* 8*/ "row1_8", 
             /* 9*/ "row1_9", 
             /*10*/ "row1_10", 
             /*11*/ "row1_11", 
             /*12*/ "row1_12", 
             /*13*/ "row1_13", 
             /*14*/ "row1_14", 
             /*15*/ "row1_15", 
             /*16*/ "row1_16", 
             /*17*/ "row1_17", 
             /*18*/ "row1_18", 
             /*19*/ "row1_19", 
             /*20*/ "row1_20", 
             /*21*/ "row1_21", 
             /*22*/ "row1_22", 
             /*23*/ "row1_23", 
             /*24*/ "row1_24");
    this.AutoFilter(5, "B", "AA");
    if(m_Form.GetFieldValue(PNFLD_BANK) == "X")
      StartCaptureOutput();
      [
        select count(1) over() t_cnt,
               secur.t_mfiid t_mfiid,
               nvl(lead(secur.t_mfiid) over(order by secur.t_isin, secur.t_mfiid, secur.t_type, secur.t_amount desc),0) t_mfiidnext,
               secur.t_mfacevaluefi t_mfacevaluefi,
               secur.t_isexp t_isexp,
               secur.t_isin t_isin,
               secur.t_fiidname t_fiidname,
               secur.t_avoirkindroot t_avoirkindroot,
               secur.t_fiidcodetype t_fiidcodetype,
               secur.t_issuername t_issuername,
               secur.t_issuerdirectinvest t_issuerdirectinvest,
               case when (select count(1) 
                          from dpartyown_dbt partyown 
                          where partyown.t_partyid = secur.t_issuer and partyown.t_partykind = 34/*Международной организацией*/) > 0 then '998' 
                    when secur.t_codeissuer76 = '400' then '998'
                    else secur.t_codenum3 
               end t_issuercountry,
               secur.t_clientcode t_clientcode,
               secur.t_amount t_amount,
               secur.t_amountDirect t_amountDirect,
               secur.t_amountReverse t_amountReverse,
               secur.t_type,
               secur.t_fiidface t_fiidface,
               secur.t_facevalue t_facevalue,
               case when secur.t_placecode = 'NSD' or substr(secur.t_placecode,1,4) = '3294' then '3294 НКО АО НРД' when secur.t_placecode = 'EURO' or substr(secur.t_placecode,1,4) = '9999' then '9999 Euroclear' else secur.t_placecode end t_placecode,
               secur.t_fi_code t_fi_code,
               secur.t_section t_section,
               case when secur.t_codeissuer76 != chr(1) then decode(secur.t_codeissuer76, '510', '513', secur.t_codeissuer76)
                    when (select count(1) 
                          from dpartyown_dbt partyown 
                          where partyown.t_partyid = secur.t_issuer and partyown.t_partykind = 2/*Банком*/) > 0 then '100'
                    when (select count(1) 
                          from dpartyown_dbt partyown 
                          where partyown.t_partyid = secur.t_issuer and partyown.t_partykind = 29/*Центральным банком*/) > 0 then '200'
                    when (select count(1) 
                          from dpartyown_dbt partyown 
                          where partyown.t_partyid = secur.t_issuer and partyown.t_partykind in (32/*Международным банком развития*/, 34/*Международной организацией*/ )) > 0 then '400'
                    when (select count(1) 
                          from dpartyown_dbt partyown 
                          where partyown.t_partyid = secur.t_issuer and partyown.t_partykind in (8/*Пенсионным фондом*/, 9/*Органом обяз. медиц. страхования*/, 30/*Страховой компанией*/)) > 0 then '511'
                    when (select count(1) 
                          from dpartyown_dbt partyown 
                          where partyown.t_partyid = secur.t_issuer and partyown.t_partykind = 19/*Паевым инвестиционным фондом*/) > 0 then '512'
                    when (select count(1) 
                          from dpartyown_dbt partyown 
                          where partyown.t_partyid = secur.t_issuer and partyown.t_partykind = 69/*Финансовой организацией*/) > 0 then '520'
                    when t_issuerlegalform = 2 then '540'
                    else '550'
               end t_issuersectorcode, 
               secur.t_durationcode t_durationcode,
               secur.t_regionclient t_regionclient,
               secur.t_fioclient t_fioclient
        from (select secur.t_issuer,
                     t_mfiid,
                     t_mfacevaluefi,
                     t_isexp,
                     partyissuer.t_legalform t_issuerlegalform,
                     avoiriss.t_isin t_isin,
                     secur.t_fiidname t_fiidname,
                     case secur.t_avoirkindroot 
                          when 17 then 'Облигация' 
                          when 20 then 'Акция' 
                          when 10 then 'Депозитарные расписки' 
                          else 'Паи' 
                     end t_avoirkindroot,
                     secur.t_fiidcodetype t_fiidcodetype,
                     partyissuer.t_name t_issuername,
                     case when (select trim(lower(nvl(max(t_name),chr(1))))
                                from dobjattr_dbt objattr, dobjatcor_dbt objatcor
                                where objattr.t_objecttype = 3 and
                                      objattr.t_groupid = 33 and /*Отношения прямого инвестирования*/
                                      objatcor.t_objecttype = objattr.t_objecttype and
                                      objatcor.t_groupid = objattr.t_groupid and
                                      objatcor.t_attrid = objattr.t_attrid and
                                      objatcor.t_object = lpad(secur.t_issuer, 10, '0') and
                                      objatcor.t_validfromdate <= dt and
                                      objatcor.t_validtodate >= dt) = 'да' then 'ДА'
                          else 'НЕТ' 
                     end t_issuerdirectinvest,
                     (select trim(lower(nvl(max(t_nameobject),chr(1))))
                                from dobjattr_dbt objattr, dobjatcor_dbt objatcor
                                where objattr.t_objecttype = 3 and
                                      objattr.t_groupid = 76 and /*Код сектора экономики эмит.-нерез.*/
                                      objatcor.t_objecttype = objattr.t_objecttype and
                                      objatcor.t_groupid = objattr.t_groupid and
                                      objatcor.t_attrid = objattr.t_attrid and
                                      objatcor.t_object = lpad(secur.t_issuer, 10, '0') and
                                      objatcor.t_validfromdate <= dt and
                                      objatcor.t_validtodate >= dt) t_codeissuer76,
                     country.t_codenum3, 
                     chr(88) t_clientcode,
                     secur.t_amount t_amount,
                     secur.t_amountDirect t_amountDirect,
                     secur.t_amountReverse t_amountReverse,
                     secur.t_type,
                     fininstrface.t_iso_number t_fiidface,
                     case when secur.t_fiidcodetype in ('SHS7','DR','DOL2') then 0
                          else secur.t_facevalue
                     end t_facevalue,
                     (select nvl(max(objcode.t_code),chr(1)) 
                      from dobjcode_dbt objcode 
                      where objcode.t_objecttype = 3 and 
                            objcode.t_codekind = 103/*Код Кондор CPTY*/ and
                            objcode.t_objectid = secur.t_place and 
                            objcode.t_bankdate <= dt and 
                            (objcode.t_bankclosedate = to_date('01.01.0001','dd.mm.yyyy') or objcode.t_bankclosedate >= dt)) t_placecode,
                     secur.t_fi_code t_fi_code,
                     '1' t_section,
                     secur.t_durationcode t_durationcode,
                     chr(88) t_regionclient,
                     chr(1) t_fioclient
              from (select dt, 
                           secur.t_fiid,
                           secur.t_amount,
                           secur.t_amountDirect,
                           secur.t_amountReverse,
                           secur.t_type,
                           fininstr.t_definition t_fiidname,
                           avrkindsroot.t_avoirkind t_avoirkindroot,
                           secur.t_place,
                           case when avrkindsroot.t_avoirkind in (17,20) then fininstr.t_issuer 
                                when avrkindsroot.t_avoirkind = 10 then fininstrparent.t_issuer
                                else (select nvl(max(to_number(objlink.t_attrid)),fininstr.t_issuer) from dobjlink_dbt objlink where objlink.t_objecttype = 12 and objlink.t_groupid = 12 and lpad(objlink.t_objectid,10,'0') = fininstr.t_fiid and objlink.t_attrtype = 3 and objlink.t_validfromdate <= dt and objlink.t_validtodate >= dt)
                           end t_issuer,
                           case when avrkindsroot.t_avoirkind in (17,20,16) then fininstr.t_facevaluefi
                                else fininstrparent.t_facevaluefi
                           end t_facevaluefi,
                           case when avrkindsroot.t_avoirkind in (17,20,16) then rsb_fiinstr.FI_GetNominalOnDate(fininstr.t_fiid, dt) 
                                else rsb_fiinstr.FI_GetNominalOnDate(fininstrparent.t_fiid, dt)
                           end t_facevalue,
                           --(select nvl(max(t_codelist),chr(1))
                           (select nvl(max(t_name),chr(1))
                                      from dobjattr_dbt objattr, dobjatcor_dbt objatcor
                                      where objattr.t_objecttype = 12 and
                                            --objattr.t_groupid = 56 and /*Тип ц/б для формы 404*/
                                            objattr.t_groupid = 1 and /*Код типа ц.б. для формы 711*/
                                            objatcor.t_objecttype = objattr.t_objecttype and
                                            objatcor.t_groupid = objattr.t_groupid and
                                            objatcor.t_attrid = objattr.t_attrid and
                                            objatcor.t_object = lpad(fininstr.t_fiid, 10, '0') and
                                            objatcor.t_validfromdate <= dt and
                                            objatcor.t_validtodate >= dt) t_fiidcodetype,
                           fininstr.t_fi_code,
                          case when avrkindsroot.t_avoirkind in (20,16) or (avrkindsroot.t_avoirkind = 10 and avrkindsrootparent.t_avoirkind = 17) then '-'
                               when avrkindsroot.t_avoirkind = 17 then case when months_between(fininstr.t_drawingdate, decode(avoiriss.t_begplacementdate, to_date('01.01.0001','dd.mm.yyyy'),fininstr.t_issued,avoiriss.t_begplacementdate)) <= 12 then 'SHT' else 'LNT' end
                               else case when months_between(fininstrparent.t_drawingdate, decode(avoirissparent.t_begplacementdate, to_date('01.01.0001','dd.mm.yyyy'),fininstrparent.t_issued,avoirissparent.t_begplacementdate)) <= 12 then 'SHT' else 'LNT' end
                          end t_durationcode,
                          case when avrkindsroot.t_avoirkind in (16,17,20) then fininstr.t_fiid
                               else fininstrparent.t_fiid
                          end t_mfiid,
                          case when avrkindsroot.t_avoirkind in (16,17,20) then fininstr.t_facevaluefi
                               else fininstrparent.t_facevaluefi
                          end t_mfacevaluefi,
                          case when avrkindsroot.t_avoirkind in (20,16) or (avrkindsroot.t_avoirkind = 10 and avrkindsrootparent.t_avoirkind = 17) then 0
                               when avrkindsroot.t_avoirkind = 17 then case when fininstr.t_drawingdate <= dt then 1 else 0 end
                               else case when fininstrparent.t_drawingdate <= dt then 1 else 0 end
                          end t_isexp
                    from (select dt, t_fiid, t_place, nvl(sum(t_amount),0) t_amount, nvl(sum(t_amountDirect),0) t_amountDirect, nvl(sum(t_amountReverse),0) t_amountReverse, t_type
                          from (select dt, 
                                       scqracc.t_fiid t_fiid,
                                       scqracc.t_storageid t_place,
                                       -rsb_account.restall(account.t_account, account.t_chapter, account.t_code_currency, dt) t_amount,
                                       0 t_amountDirect,
                                       0 t_amountReverse,
                                       1 t_type
                                from daccount_dbt account
                                join (select :dt-1 dt from dual) on 1=1
                                join dscqracc_dbt scqracc on scqracc.t_accountid = account.t_accountid
                                where account.t_chapter = 5 and
                                      account.t_open_date <= dt and
                                      (account.t_close_date = to_date('01.01.0001','dd.mm.yyyy') or account.t_close_date > dt) and
                                      account.t_kind_account = 'А'
                      /*               and scqracc.t_fiid = 52252*/
                                union all
                                select dt, 
                                       dlrq.t_fiid, 
                                       dlrq.t_placeid t_place, 
                                       0 t_amount, 
                                       sum(case when t_isdirectrepo = 1 then case when dlrq.t_kind = 1/*DLRQ_KIND_COMMIT*/  then dlrq.t_amount else -dlrq.t_amount end else 0 end) t_amountDirect,
                                       sum(case when t_isdirectrepo != 1 then case when dlrq.t_kind = 0/*DLRQ_KIND_REQUEST*/  then dlrq.t_amount else -dlrq.t_amount end else 0 end) t_amountReverse,
                                       2 t_type
                                from (select dt, 
                                             case when regexp_like(oprkoper.t_systypes, 'S') then 1 else 0 end t_isdirectrepo,
                                             dl_tick.t_bofficekind t_bofficekind,
                                             dl_tick.t_dealid t_dealid
                                      from ddl_tick_dbt dl_tick
                                      join (select :dt-1 dt from dual) on 1=1
                                      join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dl_tick.t_dealtype and 
                                                                     regexp_like(oprkoper.t_systypes, 't'/*РЕПО*/) and 
                                                                     regexp_like(oprkoper.t_systypes, '[S|B]'/*Продажа - прямое/Покупка - обратное*/) 
                                      where dl_tick.t_bofficekind = 101 and
                                            dl_tick.t_clientid = -1 and
                                            dl_tick.t_dealstatus >= 10 and
                                            dl_tick.t_dealdate <= dt and
                                            (dl_tick.t_closedate = to_date('01.01.0001','dd.mm.yyyy') or dl_tick.t_closedate > dt)) dl_tick
                                join ddlrq_dbt dlrq on dlrq.t_dockind = dl_tick.t_bofficekind and
                                                       dlrq.t_docid = dl_tick.t_dealid and
                                                       dlrq.t_subkind = 1/*DLRQ_SUBKIND_AVOIRISS*/ and
                                                       dlrq.t_type in (8/*DLRQ_TYPE_DELIVERY*/, 9/*DLRQ_TYPE_COMPDELIVERY*/) and
                                                       decode(dlrq.t_factdate, to_date('01.01.0001','dd.mm.yyyy'), dlrq.t_plandate, dlrq.t_factdate) <= dt
                                group by dt, dlrq.t_fiid, dlrq.t_placeid)
                          group by dt, t_fiid, t_place, t_type) secur
                    join dfininstr_dbt fininstr on fininstr.t_fiid = secur.t_fiid and 
                                                   fininstr.t_fi_kind = 2
                    join davoiriss_dbt avoiriss on avoiriss.t_fiid = fininstr.t_fiid 
                    join davrkinds_dbt avrkindsroot on avrkindsroot.t_fi_kind = fininstr.t_fi_kind and 
                                                       avrkindsroot.t_avoirkind = rsb_fiinstr.fi_avrkindsgetroot(fininstr.t_fi_kind, fininstr.t_avoirkind) and 
                                                       avrkindsroot.t_avoirkind in (17/*AVOIRKIND_BOND - облигации*/, 
                                                                                    20/*AVOIRKIND_SHARE - акции*/, 
                                                                                    16/*AVOIRKIND_INVESTMENT_SHARE - инвестиционный пай*/, 
                                                                                    10/*AVOIRKIND_DEPOSITORY_RECEIPT - депозитарная расписка*/)
                    left join dfininstr_dbt fininstrparent on avrkindsroot.t_avoirkind = 10 and 
                                                              fininstrparent.t_fiid = fininstr.t_parentfi and 
                                                              fininstrparent.t_fi_kind = 2
                    left join davoiriss_dbt avoirissparent on avrkindsroot.t_avoirkind = 10 and 
                                                              avoirissparent.t_fiid = fininstrparent.t_fiid 
                    left join davrkinds_dbt avrkindsrootparent on avrkindsroot.t_avoirkind = 10 and 
                                                                  avrkindsrootparent.t_fi_kind = fininstrparent.t_fi_kind and 
                                                                  avrkindsrootparent.t_avoirkind = rsb_fiinstr.fi_avrkindsgetroot(fininstrparent.t_fi_kind, fininstrparent.t_avoirkind) and   
                                                                  avrkindsrootparent.t_avoirkind in (17, 20)            
                    where secur.t_amount > 0 or secur.t_amountDirect > 0 or secur.t_amountReverse > 0) secur
              join davoiriss_dbt avoiriss on avoiriss.t_fiid = secur.t_fiid 
              join dparty_dbt partyissuer on partyissuer.t_partyid = secur.t_issuer and 
                                             partyissuer.t_notresident = chr(88)
              left join dcountry_dbt country on nvl(partyissuer.t_nrcountry,chr(1)) != chr(1) and 
                                                country.t_codelat3 = partyissuer.t_nrcountry 
              left join dfininstr_dbt fininstrface on fininstrface.t_fiid = secur.t_facevaluefi) secur
        order by secur.t_isin, secur.t_mfiid, secur.t_type, secur.t_amount desc
      ];
      m_cmd = RsdCommand(EndCaptureOutput());
      m_cmd.AddParam("dt", RSDBP_IN, m_BeginDate);
      m_cmd.Execute();
      m_RS = TRsbDataSet(m_cmd);
      cnt = 0;
      while(m_RS.movenext)
        if(cnt == 0)
          InitProgress(int(m_RS.value("t_cnt")), "Ждите...", "Формирование расшифровки к форме 404. Раздел 1");
        end;
        cnt = cnt + 1;
        /*Сохраняем сумму по позиции*/
        if(m_RS.value("t_type") == 1)
          Amount[Amount.size] = tAmount;
          Amount[Amount.size-1].AmountSum = m_RS.value("t_amount");
          Amount[Amount.size-1].AmountType = m_RS.value("t_type");
          Amount[Amount.size-1].StorageCode = m_RS.value("t_placecode");
          /*Если следующая бумага такая же, то переходим к следующей позиции*/
          if(m_RS.value("t_mfiid") == m_RS.value("t_mfiidnext"))
            UseProgress(cnt);
            continue;
          end;
        end;
        /*РЕПО*/
        if(m_RS.value("t_type") == 2)
          /*Добавляем сумму прямого РЕПО*/
          if(m_RS.value("t_amountDirect") > 0)
            i = Amount.size;
            while((i > 0) and (Amount[i-1].AmountSum < m_RS.value("t_amountDirect")))
              Amount[i] = tAmount;
              Amount[i].AmountSum = Amount[i-1].AmountSum;
              Amount[i].AmountType = Amount[i-1].AmountType;
              Amount[i].StorageCode = Amount[i-1].StorageCode;
              i = i - 1;
            end;
            Amount[i] = tAmount; 
            Amount[i].AmountSum = m_RS.value("t_amountDirect");
            Amount[i].AmountType = m_RS.value("t_type");
            if(Amount.size > 1)
              if(i == Amount.size - 1)
                /*От предыдущего*/
                Amount[i].StorageCode = Amount[i-1].StorageCode;
              else
                /*От последнего*/
                Amount[i].StorageCode = Amount[Amount.size - 1].StorageCode;
              end;
            else
              Amount[i].StorageCode = "";
            end;
          end;
          /*Добавляем сумму обратного РЕПО*/
          if(m_RS.value("t_amountReverse") > 0)
            AmountReverse = m_RS.value("t_amountReverse");
            i = 0;
            while((AmountReverse > 0) and (i < Amount.size))
              AmountSum = max(0, Amount[i].AmountSum - AmountReverse);
              AmountReverse = AmountReverse - min(AmountReverse, Amount[i].AmountSum);
              Amount[i].AmountSum = AmountSum;
              i = i + 1;
            end;
          end;
        end;
        /*Проверяем, что есть хотя бы одна не нулевая сумма*/
        i = Amount.size - 1;
        while(i >= 0)
          if(Amount[i].AmountSum > 0)
            break;
          end;
          i = i - 1;
        end;
        if(i < 0)
          UseProgress(cnt);
          Amount = tarray();
          continue;
        end;
        /*Определяем значение котировки*/
        if(m_RS.value("t_isexp") != 0)
          RateValue = m_RS.value("t_facevalue");
          RateType = "ПБ";
          CalcCost = "Просроченные";
          Note = "ПН";
        else
          GetRate(m_RS.value(/*"t_fiidname"*/"t_isin"), m_BeginDate - 1, m_RS.value("t_mfiid"), m_RS.value("t_mfacevaluefi"), @RateValue, @RateType, @NKD, @RateNote);
          RateValue = round(RateValue + NKD, 4);
          if(RateType == "РЦ")
            CalcCost = "По справочнику";
          else
            CalcCost = "";
          end;
          Note = "ПС";
          if(RateNote != "")
            msgbox(RateNote);
          end;
        end;
        /*Выводим строки отчета*/
        i = 0;
        while(i < Amount.size)
          if(Amount[i].AmountSum > 0)
            /*Выводим строку отчета по позиции*/
            if(Amount[i].AmountType == 1)
              PrintTableLine(
                    /* 1*/ "row1_1", "РСХБ", null, 
                    /* 2*/ "row1_2", m_RS.value("t_isin"), null, 
                    /* 3*/ "row1_3", m_RS.value("t_fiidname"), null, 
                    /* 4*/ "row1_4", m_RS.value("t_avoirkindroot"), null, 
                    /* 5*/ "row1_5", "", null, 
                    /* 6*/ "row1_6", m_RS.value("t_fiidcodetype"), null, 
                    /* 7*/ "row1_7", m_RS.value("t_issuername"), null, 
                    /* 8*/ "row1_8", m_RS.value("t_issuerdirectinvest"), null, 
                    /* 9*/ "row1_9", m_RS.value("t_issuercountry"), null, 
                    /*10*/ "row1_10", m_RS.value("t_clientcode"), null, 
                    /*11*/ "row1_11", Amount[i].AmountSum, null, 
                    /*12*/ "row1_12", m_RS.value("t_fiidface"), null, 
                    /*13*/ "row1_13", m_RS.value("t_facevalue"), null, 
                    /*14*/ "row1_14", RateValue, null, 
                    /*15*/ "row1_15", round(Amount[i].AmountSum * m_RS.value("t_facevalue"), 4), null, 
                    /*16*/ "row1_16", round(Amount[i].AmountSum * RateValue, 4), null, 
                    /*17*/ "row1_17", RateType, null, 
                    /*18*/ "row1_18", Amount[i].StorageCode, null, 
                    /*19*/ "row1_19", Note, null, 
                    /*20*/ "row1_20", CalcCost, null, 
                    /*21*/ "row1_21", m_RS.value("t_fi_code"), null, 
                    /*22*/ "row1_22", m_RS.value("t_section"), null, 
                    /*23*/ "row1_23", m_RS.value("t_issuersectorcode"), null, 
                    /*24*/ "row1_24", m_RS.value("t_durationcode"), null,
                    /*25*/ "row1_25", m_RS.value("t_regionclient"), null,
                    /*26*/ "row1_26", m_RS.value("t_fioclient"), null);
            /*Выводим строку отчета по прямому РЕПО*/
            elif(Amount[i].AmountType == 2)
              PrintTableLine(
                    /* 1*/ "row1_1", "РСХБ", null, 
                    /* 2*/ "row1_2", m_RS.value("t_isin"), null, 
                    /* 3*/ "row1_3", m_RS.value("t_fiidname"), null, 
                    /* 4*/ "row1_4", m_RS.value("t_avoirkindroot"), null, 
                    /* 5*/ "row1_5", "", null, 
                    /* 6*/ "row1_6", m_RS.value("t_fiidcodetype"), null, 
                    /* 7*/ "row1_7", m_RS.value("t_issuername"), null, 
                    /* 8*/ "row1_8", m_RS.value("t_issuerdirectinvest"), null, 
                    /* 9*/ "row1_9", m_RS.value("t_issuercountry"), null, 
                    /*10*/ "row1_10", m_RS.value("t_clientcode"), null, 
                    /*11*/ "row1_11", Amount[i].AmountSum, null, 
                    /*12*/ "row1_12", m_RS.value("t_fiidface"), null, 
                    /*13*/ "row1_13", m_RS.value("t_facevalue"), null, 
                    /*14*/ "row1_14", RateValue, null, 
                    /*15*/ "row1_15", round(Amount[i].AmountSum * m_RS.value("t_facevalue"), 4), null, 
                    /*16*/ "row1_16", round(Amount[i].AmountSum * RateValue, 4), null, 
                    /*17*/ "row1_17", RateType, null, 
                    /*18*/ "row1_18", Amount[i].StorageCode, null, 
                    /*19*/ "row1_19", "ЗБ", null, 
                    /*20*/ "row1_20", CalcCost, null, 
                    /*21*/ "row1_21", m_RS.value("t_fi_code"), null, 
                    /*22*/ "row1_22", m_RS.value("t_section"), null, 
                    /*23*/ "row1_23", m_RS.value("t_issuersectorcode"), null, 
                    /*24*/ "row1_24", m_RS.value("t_durationcode"), null,
                    /*25*/ "row1_25", m_RS.value("t_regionclient"), null,
                    /*26*/ "row1_26", m_RS.value("t_fioclient"), null);
            end;
          end;
          i = i + 1;
        end;
        /*Зануляем массив*/
        Amount = tarray();
        UseProgress(cnt);
      end;
      if(cnt > 0)
        RemProgress();
      end;
    end;
    if(m_Form.GetFieldValue(PNFLD_CLIENT) == "X")
      var j, k, result = tarray;
      var TurnOffResult = msgboxex("Сворачивать результат по 2-му разделу?", MB_YES + MB_NO, IND_YES);
      StartCaptureOutput();
      [
        select count(1) over() t_cnt,
               secur.t_mfiid t_mfiid,
               nvl(lead(secur.t_mfiid) over(order by secur.t_isin, secur.t_mfiid, secur.t_clientid, secur.t_type, secur.t_amount desc),0) t_mfiidnext,
               secur.t_clientid t_clientid,
               nvl(lead(secur.t_clientid) over(order by secur.t_isin, secur.t_mfiid, secur.t_clientid, secur.t_type, secur.t_amount desc),0) t_clientidnext,
               secur.t_mfacevaluefi t_mfacevaluefi,
               secur.t_isexp t_isexp,
               secur.t_isin t_isin,
               secur.t_fiidname t_fiidname,
               secur.t_avoirkindroot t_avoirkindroot,
               secur.t_fiidcodetype t_fiidcodetype,
               secur.t_issuername t_issuername,
               chr(88) t_issuerdirectinvest,
               case when (select count(1) 
                          from dpartyown_dbt partyown 
                          where partyown.t_partyid = secur.t_issuer and partyown.t_partykind = 34/*Международной организацией*/) > 0 then '998' 
                    when secur.t_codeissuer76 = '400' then '998'
                    else secur.t_codenum3 
               end t_issuercountry,
               case when secur.t_codeclient75 != chr(1) then secur.t_codeclient75
                    when (select count(1) 
                          from dpartyown_dbt partyown 
                          where partyown.t_partyid = secur.t_issuer and partyown.t_partykind in (15/*Орган гос.власти*/, 16/*Орган гос.власти субъекта*/, 26/*Местный орган исполнит. вл.*/)) > 0 then 'S13'
                    when secur.t_clientfl = 1 then 'S14'
                    when (select count(1) 
                          from dpartyown_dbt partyown 
                          where partyown.t_partyid = secur.t_issuer and partyown.t_partykind in (69/*Финансовая организация*/, 33/*Министерство финансов*/)) > 0 then 'S125'
                    when (select count(1) 
                          from dpartyown_dbt partyown 
                          where partyown.t_partyid = secur.t_issuer and partyown.t_partykind = 19/*Паевый инвестиционный фонд*/) > 0 then 'S124'
                    when (select count(1) 
                          from dpartyown_dbt partyown 
                          where partyown.t_partyid = secur.t_issuer and partyown.t_partykind = 30/*Страховая компания*/) > 0 then 'S128'
                    else chr(88) 
               end t_clientcode,
               secur.t_amount t_amount,
               secur.t_amountDirect t_amountDirect,
               secur.t_amountReverse t_amountReverse,
               secur.t_type,
               secur.t_fiidface t_fiidface,
               secur.t_facevalue t_facevalue,
               case when substr(secur.t_placecode,1,4) = '3294' then '3294 НКО АО НРД' when substr(secur.t_placecode,1,4) = '9999' then '9999 Euroclear' else secur.t_placecode end t_placecode,
               secur.t_fi_code t_fi_code,
               secur.t_section t_section,
               case when secur.t_codeissuer76 != chr(1) then decode(secur.t_codeissuer76, '510', '513', secur.t_codeissuer76)
                    when (select count(1) 
                          from dpartyown_dbt partyown 
                          where partyown.t_partyid = secur.t_issuer and partyown.t_partykind = 2/*Банком*/) > 0 then '100'
                    when (select count(1) 
                          from dpartyown_dbt partyown 
                          where partyown.t_partyid = secur.t_issuer and partyown.t_partykind = 29/*Центральным банком*/) > 0 then '200'
                    when (select count(1) 
                          from dpartyown_dbt partyown 
                          where partyown.t_partyid = secur.t_issuer and partyown.t_partykind in (32/*Международным банком развития*/, 34/*Международной организацией*/ )) > 0 then '400'
                    when (select count(1) 
                          from dpartyown_dbt partyown 
                          where partyown.t_partyid = secur.t_issuer and partyown.t_partykind in (8/*Пенсионным фондом*/, 9/*Органом обяз. медиц. страхования*/, 30/*Страховой компанией*/)) > 0 then '511'
                    when (select count(1) 
                          from dpartyown_dbt partyown 
                          where partyown.t_partyid = secur.t_issuer and partyown.t_partykind = 19/*Паевым инвестиционным фондом*/) > 0 then '512'
                    when (select count(1) 
                          from dpartyown_dbt partyown 
                          where partyown.t_partyid = secur.t_issuer and partyown.t_partykind = 69/*Финансовой организацией*/) > 0 then '520'
                    when t_issuerlegalform = 2 then '540'
                    else '550'
               end t_issuersectorcode, 
               secur.t_durationcode t_durationcode,
               secur.t_regionclient t_regionclient,
               secur.t_fioclient t_fioclient
        from (select secur.t_issuer,
                     t_mfiid,
                     t_mfacevaluefi,
                     t_isexp,
                     partyissuer.t_legalform t_issuerlegalform,
                     avoiriss.t_isin t_isin,
                     secur.t_fiidname t_fiidname,
                     case secur.t_avoirkindroot 
                          when 17 then 'Облигация' 
                          when 20 then 'Акция' 
                          when 10 then 'Депозитарные расписки' 
                          else 'Паи' 
                     end t_avoirkindroot,
                     secur.t_fiidcodetype t_fiidcodetype,
                     partyissuer.t_name t_issuername,
                     (select trim(lower(nvl(max(t_nameobject),chr(1))))
                                from dobjattr_dbt objattr, dobjatcor_dbt objatcor
                                where objattr.t_objecttype = 3 and
                                      objattr.t_groupid = 76 and /*Код сектора экономики эмит.-нерез.*/
                                      objatcor.t_objecttype = objattr.t_objecttype and
                                      objatcor.t_groupid = objattr.t_groupid and
                                      objatcor.t_attrid = objattr.t_attrid and
                                      objatcor.t_object = lpad(secur.t_issuer, 10, '0') and
                                      objatcor.t_validfromdate <= dt and
                                      objatcor.t_validtodate >= dt) t_codeissuer76,
                     country.t_codenum3,
                     (select trim(lower(nvl(max(t_nameobject),chr(1))))
                                from dobjattr_dbt objattr, dobjatcor_dbt objatcor
                                where objattr.t_objecttype = 3 and
                                      objattr.t_groupid = 75 and /*Код клиента для 404 формы*/
                                      objatcor.t_objecttype = objattr.t_objecttype and
                                      objatcor.t_groupid = objattr.t_groupid and
                                      objatcor.t_attrid = objattr.t_attrid and
                                      objatcor.t_object = lpad(secur.t_clientid, 10, '0') and
                                      objatcor.t_validfromdate <= dt and
                                      objatcor.t_validtodate >= dt) t_codeclient75,
                     secur.t_amount t_amount,
                     secur.t_amountDirect t_amountDirect,
                     secur.t_amountReverse t_amountReverse,
                     secur.t_type,
                     fininstrface.t_iso_number t_fiidface,
                     case when secur.t_fiidcodetype in ('SHS7','DR','DOL2') then 0
                          else secur.t_facevalue
                     end t_facevalue,
                     case when partyplace.t_notresident = chr(88) then '9999'
                          when (select count(1) 
                                from dpartyown_dbt partyown 
                                where partyown.t_partyid = secur.t_place and partyown.t_partykind = 2/*Банком*/) > 0 
                          then (select nvl(max(objcode.t_code),chr(1)) 
                                from dobjcode_dbt objcode 
                                where objcode.t_objecttype = 3 and 
                                      objcode.t_codekind = 13/*Рег. номер кред. орг-ции*/ and
                                      objcode.t_objectid = secur.t_place and 
                                      objcode.t_bankdate <= dt and 
                                      (objcode.t_bankclosedate = to_date('01.01.0001','dd.mm.yyyy') or objcode.t_bankclosedate >= dt))
                          else (select nvl(max(objcode.t_code),'0') 
                                from dobjcode_dbt objcode 
                                where objcode.t_objecttype = 3 and 
                                      objcode.t_codekind = 16/*ИНН*/ and
                                      objcode.t_objectid = secur.t_place and 
                                      objcode.t_bankdate <= dt and 
                                      (objcode.t_bankclosedate = to_date('01.01.0001','dd.mm.yyyy') or objcode.t_bankclosedate >= dt))
                     end t_placecode,
                     secur.t_fi_code t_fi_code,
                     '2' t_section,
                     secur.t_durationcode t_durationcode,
                     secur.t_regionclient t_regionclient,
                     secur.t_clientid t_clientid,
                     secur.t_clientfl t_clientfl,
                     secur.t_clientfio t_fioclient
              from (select dt, 
                           secur.t_fiid,
                           secur.t_amount,
                           secur.t_amountDirect,
                           secur.t_amountReverse,
                           secur.t_type,
                           fininstr.t_definition t_fiidname,
                           avrkindsroot.t_avoirkind t_avoirkindroot,
                           secur.t_place,
                           case when avrkindsroot.t_avoirkind in (17,20) then fininstr.t_issuer 
                                when avrkindsroot.t_avoirkind = 10 then fininstrparent.t_issuer
                                else (select nvl(max(to_number(objlink.t_attrid)),fininstr.t_issuer) from dobjlink_dbt objlink where objlink.t_objecttype = 12 and objlink.t_groupid = 12 and lpad(objlink.t_objectid,10,'0') = fininstr.t_fiid and objlink.t_attrtype = 3 and objlink.t_validfromdate <= dt and objlink.t_validtodate >= dt)
                           end t_issuer,
                           case when avrkindsroot.t_avoirkind in (17,20,16) then fininstr.t_facevaluefi
                                else fininstrparent.t_facevaluefi
                           end t_facevaluefi,
                           case when avrkindsroot.t_avoirkind in (17,20,16) then rsb_fiinstr.FI_GetNominalOnDate(fininstr.t_fiid, dt) 
                                else rsb_fiinstr.FI_GetNominalOnDate(fininstrparent.t_fiid, dt)
                           end t_facevalue,
                           --(select nvl(max(t_codelist),chr(1))
                           (select nvl(max(t_name),chr(1))
                            from dobjattr_dbt objattr, dobjatcor_dbt objatcor
                            where objattr.t_objecttype = 12 and
                                  --objattr.t_groupid = 56 and /*Тип ц/б для формы 404*/
                                  objattr.t_groupid = 1 and /*Код типа ц.б. для формы 711*/
                                  objatcor.t_objecttype = objattr.t_objecttype and
                                  objatcor.t_groupid = objattr.t_groupid and
                                  objatcor.t_attrid = objattr.t_attrid and
                                  objatcor.t_object = lpad(fininstr.t_fiid, 10, '0') and
                                  objatcor.t_validfromdate <= dt and
                                  objatcor.t_validtodate >= dt) t_fiidcodetype,
                           fininstr.t_fi_code,
                          case when avrkindsroot.t_avoirkind in (20,16) or (avrkindsroot.t_avoirkind = 10 and avrkindsrootparent.t_avoirkind = 17) then '-'
                               when avrkindsroot.t_avoirkind = 17 then case when months_between(fininstr.t_drawingdate, decode(avoiriss.t_begplacementdate, to_date('01.01.0001','dd.mm.yyyy'),fininstr.t_issued,avoiriss.t_begplacementdate)) <= 12 then 'SHT' else 'LNT' end
                               else case when months_between(fininstrparent.t_drawingdate, decode(avoirissparent.t_begplacementdate, to_date('01.01.0001','dd.mm.yyyy'),fininstrparent.t_issued,avoirissparent.t_begplacementdate)) <= 12 then 'SHT' else 'LNT' end
                          end t_durationcode,
                          case when avrkindsroot.t_avoirkind in (16,17,20) then fininstr.t_fiid
                               else fininstrparent.t_fiid
                          end t_mfiid,
                          case when avrkindsroot.t_avoirkind in (16,17,20) then fininstr.t_facevaluefi
                               else fininstrparent.t_facevaluefi
                          end t_mfacevaluefi,
                          case when avrkindsroot.t_avoirkind in (20,16) or (avrkindsroot.t_avoirkind = 10 and avrkindsrootparent.t_avoirkind = 17) then 0
                               when avrkindsroot.t_avoirkind = 17 then case when fininstr.t_drawingdate <= dt then 1 else 0 end
                               else case when fininstrparent.t_drawingdate <= dt then 1 else 0 end
                          end t_isexp,
                          secur.t_clientid,
                          case when persnclient.t_name1 is null then 0 else 1 end t_clientfl,
                          case when persnclient.t_name1 is null then partyclient.t_name else partyclient.t_name end t_clientfio,
                          case when persnclient.t_name1 is null then (select trim(lower(nvl(max(t_nameobject),chr(1))))
                                                                      from dobjattr_dbt objattr, dobjatcor_dbt objatcor
                                                                      where objattr.t_objecttype = 3 and
                                                                            objattr.t_groupid = 12 and /*Справочник ОКАТО*/
                                                                            objatcor.t_objecttype = objattr.t_objecttype and
                                                                            objatcor.t_groupid = objattr.t_groupid and
                                                                            objatcor.t_attrid = objattr.t_attrid and
                                                                            objatcor.t_object = lpad(secur.t_clientid, 10, '0') and
                                                                            objatcor.t_validfromdate <= dt and
                                                                            objatcor.t_validtodate >= dt)
                               else trim(nvl((select max(t_nameobject)
                                              from dobjattr_dbt objattr, dobjatcor_dbt objatcor
                                              where objattr.t_objecttype = 3 and
                                                    objattr.t_groupid = 12 and /*Справочник ОКАТО*/
                                                    objatcor.t_objecttype = objattr.t_objecttype and
                                                    objatcor.t_groupid = objattr.t_groupid and
                                                    objatcor.t_attrid = objattr.t_attrid and
                                                    objatcor.t_object = lpad(secur.t_clientid, 10, '0') and
                                                    objatcor.t_validfromdate <= dt and
                                                    objatcor.t_validtodate >= dt), 
                                             (select decode(nvl(max(adress.t_okato),chr(1)),chr(1),'45',max(adress.t_okato)) 
                                              from dadress_dbt adress
                                              where adress.t_partyid = secur.t_clientid and
                                                    adress.t_type = 2)))
                           end t_regionclient
                    from (select dt, 
                                 t_fiid, 
                                 t_clientid, 
                                 t_amount, 
                                 0 t_amountDirect, 
                                 0 t_amountReverse, 
                                 t_place, 
                                 1 t_type
                          from (select dt, 
                                       mcaccdoc.t_currency t_fiid, 
                                       mcaccdoc.t_owner t_clientid, 
                                       -rsb_account.restall(mcaccdoc.t_account, mcaccdoc.t_chapter, mcaccdoc.t_currency, dt) t_amount, 
                                       (select nvl(max(dlrq.t_placeid), mcaccdoc.t_place)
                                        from dmcaccdoc_dbt mcaccdoc_dltick 
                                        left join ddl_tick_dbt dl_tick on dl_tick.t_bofficekind = mcaccdoc_dltick.t_dockind and
                                                                          dl_tick.t_dealid = mcaccdoc_dltick.t_docid
                                        left join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dl_tick.t_dealtype and 
                                                                            (regexp_like(oprkoper.t_systypes, 'Z'/*Зачисление*/) or regexp_like(oprkoper.t_systypes, 'B'/*Покупка*/))
                                        left join ddlrq_dbt dlrq on dlrq.t_dockind = dl_tick.t_bofficekind and
                                                                    dlrq.t_docid = dl_tick.t_dealid and
                                                                    dlrq.t_dealpart = 1 and
                                                                    dlrq.t_subkind = 1/*DLRQ_SUBKIND_AVOIRISS*/ and
                                                                    dlrq.t_type = 8/*DLRQ_TYPE_DELIVERY*/
                                        where mcaccdoc_dltick.t_chapter = mcaccdoc.t_chapter and 
                                              mcaccdoc_dltick.t_account = mcaccdoc.t_account and 
                                              mcaccdoc_dltick.t_currency = mcaccdoc.t_currency and
                                              mcaccdoc_dltick.t_catnum = mcaccdoc.t_catnum and
                                              mcaccdoc_dltick.t_clientcontrid > 0 and
                                              mcaccdoc_dltick.t_iscommon != chr(88) and
                                              mcaccdoc_dltick.t_dockind in (101/*Покупка/продажа ц/б*/,127/*Списание/зачисление ц/б*/)) t_place
                                from dmcaccdoc_dbt mcaccdoc
                                join (select :dt-1 dt from dual) on 1=1
                                join daccount_dbt account on account.t_chapter = mcaccdoc.t_chapter and 
                                                             account.t_account = mcaccdoc.t_account and 
                                                             account.t_code_currency = mcaccdoc.t_currency and 
                                                             account.t_open_date <= dt and 
                                                             (account.t_close_date = to_date('01.01.0001','dd.mm.yyyy') or account.t_close_date > dt)  
                                left join ddlcontrmp_dbt dlcontrmp on dlcontrmp.t_sfcontrid = mcaccdoc.t_clientcontrid
                                left join dobjattr_dbt objattr on objattr.t_objecttype = 207/*Договор брокерского обслуживания*/ and 
                                                                  objattr.t_groupid = 110/*Исключить из 404*/ and 
                                                                  lower(objattr.t_name) = 'да'  
                                where mcaccdoc.t_catnum = 560 and
                                      mcaccdoc.t_clientcontrid > 0 and
                                      mcaccdoc.t_chapter = 22 and
                                      mcaccdoc.t_iscommon = chr(88) and
                                      (objattr.t_objecttype is null or 
                                       dlcontrmp.t_dlcontrid is null or
                                       not exists(select 1
                                                  from dobjatcor_dbt objatcor 
                                                  where objatcor.t_objecttype = objattr.t_objecttype and
                                                                                objatcor.t_groupid = objattr.t_groupid and
                                                                                objatcor.t_attrid = objattr.t_attrid and
                                                                                objatcor.t_object = lpad(dlcontrmp.t_dlcontrid, 34, '0') and
                                                                                objatcor.t_validfromdate <= dt and
                                                                                objatcor.t_validtodate >= dt))
                                group by dt, mcaccdoc.t_owner, mcaccdoc.t_chapter, mcaccdoc.t_account, mcaccdoc.t_currency, mcaccdoc.t_place, mcaccdoc.t_catnum)
                          where t_amount > 0
                          union all
                          select dt, 
                                 dlrq.t_fiid, 
                                 dl_tick.t_clientid,
                                 0 t_amount, 
                                 sum(case when t_isdirectrepo = 1 then case when dlrq.t_kind = 1/*DLRQ_KIND_COMMIT*/  then dlrq.t_amount else -dlrq.t_amount end else 0 end) t_amountDirect,
                                 sum(case when t_isdirectrepo != 1 then case when dlrq.t_kind = 0/*DLRQ_KIND_REQUEST*/  then dlrq.t_amount else -dlrq.t_amount end else 0 end) t_amountReverse,
                                 dlrq.t_placeid t_place,
                                 2 t_type
                          from (select dt,
                                       dl_tick.t_clientid, 
                                       case when regexp_like(oprkoper.t_systypes, 'S') then 1 else 0 end t_isdirectrepo,
                                       dl_tick.t_bofficekind t_bofficekind,
                                       dl_tick.t_dealid t_dealid
                                from ddl_tick_dbt dl_tick
                                join (select :dt-1 dt from dual) on 1=1
                                join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dl_tick.t_dealtype and 
                                                               regexp_like(oprkoper.t_systypes, 't'/*РЕПО*/) and 
                                                               regexp_like(oprkoper.t_systypes, '[S|B]'/*Продажа - прямое/Покупка - обратное*/) 
                                where dl_tick.t_bofficekind = 101 and
                                      dl_tick.t_clientid > 0 and
                                      dl_tick.t_clientcontrid > 0 and
                                      dl_tick.t_dealstatus >= 10 and
                                      dl_tick.t_dealdate <= dt and
                                      (dl_tick.t_closedate = to_date('01.01.0001','dd.mm.yyyy') or dl_tick.t_closedate > dt) and
                                      not exists(select 1
                                                 from ddlcontrmp_dbt dlcontrmp
                                                 join dobjattr_dbt objattr on objattr.t_objecttype = 207/*Договор брокерского обслуживания*/ and
                                                                              objattr.t_groupid = 110/*Исключить из 404*/ 
                                                 join dobjatcor_dbt objatcor on objatcor.t_objecttype = objattr.t_objecttype and
                                                                                objatcor.t_groupid = objattr.t_groupid and
                                                                                objatcor.t_attrid = objattr.t_attrid and
                                                                                objatcor.t_object = lpad(dlcontrmp.t_dlcontrid, 34, '0') and
                                                                                objatcor.t_validfromdate <= dt and
                                                                                objatcor.t_validtodate >= dt
                                                 where dlcontrmp.t_sfcontrid = dl_tick.t_clientcontrid and
                                                       lower(objattr.t_name) = 'да')) dl_tick
                          join ddlrq_dbt dlrq on dlrq.t_dockind = dl_tick.t_bofficekind and
                                                 dlrq.t_docid = dl_tick.t_dealid and
                                                 dlrq.t_subkind = 1/*DLRQ_SUBKIND_AVOIRISS*/ and
                                                 dlrq.t_type in (8/*DLRQ_TYPE_DELIVERY*/, 9/*DLRQ_TYPE_COMPDELIVERY*/) and
                                                 decode(dlrq.t_factdate, to_date('01.01.0001','dd.mm.yyyy'), dlrq.t_plandate, dlrq.t_factdate) <= dt
                          group by dt, dlrq.t_fiid, dl_tick.t_clientid, dlrq.t_placeid) secur
                    join dfininstr_dbt fininstr on fininstr.t_fiid = secur.t_fiid and 
                                                   fininstr.t_fi_kind = 2
                    join davoiriss_dbt avoiriss on avoiriss.t_fiid = fininstr.t_fiid 
                    join davrkinds_dbt avrkindsroot on avrkindsroot.t_fi_kind = fininstr.t_fi_kind and 
                                                       avrkindsroot.t_avoirkind = rsb_fiinstr.fi_avrkindsgetroot(fininstr.t_fi_kind, fininstr.t_avoirkind) and 
                                                       avrkindsroot.t_avoirkind in (17/*AVOIRKIND_BOND - облигации*/, 
                                                                                    20/*AVOIRKIND_SHARE - акции*/, 
                                                                                    16/*AVOIRKIND_INVESTMENT_SHARE - инвестиционный пай*/, 
                                                                                    10/*AVOIRKIND_DEPOSITORY_RECEIPT - депозитарная расписка*/)
                    left join dfininstr_dbt fininstrparent on avrkindsroot.t_avoirkind = 10 and 
                                                              fininstrparent.t_fiid = fininstr.t_parentfi and 
                                                              fininstrparent.t_fi_kind = 2
                    left join davoiriss_dbt avoirissparent on avrkindsroot.t_avoirkind = 10 and 
                                                              avoirissparent.t_fiid = fininstrparent.t_fiid 
                    left join davrkinds_dbt avrkindsrootparent on avrkindsroot.t_avoirkind = 10 and 
                                                                  avrkindsrootparent.t_fi_kind = fininstrparent.t_fi_kind and 
                                                                  avrkindsrootparent.t_avoirkind = rsb_fiinstr.fi_avrkindsgetroot(fininstrparent.t_fi_kind, fininstrparent.t_avoirkind) and   
                                                                  avrkindsrootparent.t_avoirkind in (17, 20)
                    join dparty_dbt partyclient on partyclient.t_partyid = secur.t_clientid and
                                                               partyclient.t_notresident != chr(88) and
                                                               (select count(1) 
                                                                from dpartyown_dbt partyown 
                                                                where partyown.t_partyid = secur.t_clientid and partyown.t_partykind = 2/*Банком*/) = 0
                    left join dpersn_dbt persnclient on partyclient.t_legalform = 2 and persnclient.t_personid = partyclient.t_partyid and persnclient.t_isemployer != chr(88)   
                    where secur.t_amount > 0 or secur.t_amountDirect > 0 or secur.t_amountReverse > 0) secur
              join davoiriss_dbt avoiriss on avoiriss.t_fiid = secur.t_fiid 
              join dparty_dbt partyissuer on partyissuer.t_partyid = secur.t_issuer and 
                                             partyissuer.t_notresident = chr(88)
              left join dcountry_dbt country on nvl(partyissuer.t_nrcountry,chr(1)) != chr(1) and 
                                                country.t_codelat3 = partyissuer.t_nrcountry 
              left join dfininstr_dbt fininstrface on fininstrface.t_fiid = secur.t_facevaluefi
              left join dparty_dbt partyplace on partyplace.t_partyid = secur.t_place) secur
        --where substr(t_placecode,1,4) not in ('3294','9999')              
        order by secur.t_isin, secur.t_mfiid, secur.t_clientid, secur.t_type, secur.t_amount desc
      ];
      m_cmd = RsdCommand(EndCaptureOutput());
      m_cmd.AddParam("dt", RSDBP_IN, m_BeginDate);
      m_cmd.Execute();
      m_RS = TRsbDataSet(m_cmd);
      cnt = 0;
      while(m_RS.movenext)
        if(cnt == 0)
          InitProgress(int(m_RS.value("t_cnt")), "Ждите...", "Формирование расшифровки к форме 404. Раздел 2");
        end;
        cnt = cnt + 1;
        /*Сохраняем сумму по позиции*/
        if(m_RS.value("t_type") == 1)
          Amount[Amount.size] = tAmount;
          Amount[Amount.size-1].AmountSum = m_RS.value("t_amount");
          Amount[Amount.size-1].AmountType = m_RS.value("t_type");
          Amount[Amount.size-1].StorageCode = m_RS.value("t_placecode");
          /*Если следующая бумага/клиент такие же, то переходим к следующей позиции*/
          if((m_RS.value("t_mfiid") == m_RS.value("t_mfiidnext")) and (m_RS.value("t_clientid") == m_RS.value("t_clientidnext")))
            UseProgress(cnt);
            continue;
          end;
        end;
        /*РЕПО*/
        if(m_RS.value("t_type") == 2)
          /*Добавляем сумму прямого РЕПО*/
          if(m_RS.value("t_amountDirect") > 0)
            i = Amount.size;
            while((i > 0) and (Amount[i-1].AmountSum < m_RS.value("t_amountDirect")))
              Amount[i] = tAmount;
              Amount[i].AmountSum = Amount[i-1].AmountSum;
              Amount[i].AmountType = Amount[i-1].AmountType;
              Amount[i].StorageCode = Amount[i-1].StorageCode;
              i = i - 1;
            end;
            Amount[i] = tAmount; 
            Amount[i].AmountSum = m_RS.value("t_amountDirect");
            Amount[i].AmountType = m_RS.value("t_type");
            Amount[i].StorageCode = "8888";
          end;
          /*Добавляем сумму обратного РЕПО*/
          if(m_RS.value("t_amountReverse") > 0)
            AmountReverse = m_RS.value("t_amountReverse");
            i = 0;
            while((AmountReverse > 0) and (i < Amount.size))
              AmountSum = max(0, Amount[i].AmountSum - AmountReverse);
              AmountReverse = AmountReverse - min(AmountReverse, Amount[i].AmountSum);
              Amount[i].AmountSum = AmountSum;
              i = i + 1;
            end;
          end;
        end;
        /*Проверяем, что есть хотя бы одна не нулевая сумма*/
        i = Amount.size - 1;
        while(i >= 0)
          if(Amount[i].AmountSum > 0)
            break;
          end;
          i = i - 1;
        end;
        if(i < 0)
          UseProgress(cnt);
          Amount = tarray();
          continue;
        end;
        /*Определяем значение котировки*/
        if(m_RS.value("t_isexp") != 0)
          RateValue = m_RS.value("t_facevalue");
          RateType = "ПБ";
          CalcCost = "Просроченные";
        else
          GetRate(m_RS.value(/*"t_fiidname"*/"t_isin"), m_BeginDate - 1, m_RS.value("t_mfiid"), m_RS.value("t_mfacevaluefi"), @RateValue, @RateType, @NKD, @RateNote);
          RateValue = round(RateValue + NKD, 4);
          if(RateType == "РЦ")
            CalcCost = "По справочнику";
          else
            CalcCost = "";
          end;
          if(RateNote != "")
            msgbox(RateNote);
          end;
        end;
        /*Выводим строки отчета*/
        i = 0;
        while(i < Amount.size)
          if(Amount[i].AmountSum > 0)
            if(TurnOffResult != IND_YES)
              PrintTableLine(
                    /* 1*/ "row1_1", "РСХБ", null, 
                    /* 2*/ "row1_2", m_RS.value("t_isin"), null, 
                    /* 3*/ "row1_3", m_RS.value("t_fiidname"), null, 
                    /* 4*/ "row1_4", m_RS.value("t_avoirkindroot"), null, 
                    /* 5*/ "row1_5", "", null, 
                    /* 6*/ "row1_6", m_RS.value("t_fiidcodetype"), null, 
                    /* 7*/ "row1_7", m_RS.value("t_issuername"), null, 
                    /* 8*/ "row1_8", m_RS.value("t_issuerdirectinvest"), null, 
                    /* 9*/ "row1_9", m_RS.value("t_issuercountry"), null, 
                    /*10*/ "row1_10", m_RS.value("t_clientcode"), null, 
                    /*11*/ "row1_11", Amount[i].AmountSum, null, 
                    /*12*/ "row1_12", m_RS.value("t_fiidface"), null, 
                    /*13*/ "row1_13", m_RS.value("t_facevalue"), null, 
                    /*14*/ "row1_14", RateValue, null, 
                    /*15*/ "row1_15", round(Amount[i].AmountSum * m_RS.value("t_facevalue"), 4), null, 
                    /*16*/ "row1_16", round(Amount[i].AmountSum * RateValue, 4), null, 
                    /*17*/ "row1_17", RateType, null, 
                    /*18*/ "row1_18", Amount[i].StorageCode, null, 
                    /*19*/ "row1_19", "ДО", null, 
                    /*20*/ "row1_20", CalcCost, null, 
                    /*21*/ "row1_21", m_RS.value("t_fi_code"), null, 
                    /*22*/ "row1_22", m_RS.value("t_section"), null, 
                    /*23*/ "row1_23", m_RS.value("t_issuersectorcode"), null, 
                    /*24*/ "row1_24", m_RS.value("t_durationcode"), null,
                    /*25*/ "row1_25", m_RS.value("t_regionclient"), null,
                    /*26*/ "row1_26", m_RS.value("t_fioclient"), null);
            else
              /*Ищем строку для объединения*/
              j = result.size - 1;
              while(j >= 0)
                if((result[j][0] == m_RS.value("t_mfiid")) and (result[j][10] == m_RS.value("t_clientcode")) and (result[j][18] == Amount[i].StorageCode) and (result[j][25] == m_RS.value("t_regionclient")))
                  break;
                end;
                j = j - 1;
              end;
              /*Не нашли*/
              if(j < 0)
                result[result.size] = tarray;
                j = result.size - 1;
                result[j][0] = m_RS.value("t_mfiid");
                result[j][1] = "РСХБ";
                result[j][2] = m_RS.value("t_isin");
                result[j][3] = m_RS.value("t_fiidname");
                result[j][4] = m_RS.value("t_avoirkindroot");
                result[j][5] = "";
                result[j][6] = m_RS.value("t_fiidcodetype");
                result[j][7] = m_RS.value("t_issuername");
                result[j][8] = m_RS.value("t_issuerdirectinvest");
                result[j][9] = m_RS.value("t_issuercountry");
                result[j][10]  = m_RS.value("t_clientcode");
                result[j][11] = 0.00;
                result[j][12] = m_RS.value("t_fiidface");
                result[j][13] = m_RS.value("t_facevalue");
                result[j][14] = RateValue;
                result[j][15] = 0.00;
                result[j][16] = 0.00;
                result[j][17] = RateType;
                result[j][18] = Amount[i].StorageCode;
                result[j][19] = "ДО";
                result[j][20] = CalcCost;
                result[j][21] = m_RS.value("t_fi_code");
                result[j][22] = m_RS.value("t_section");
                result[j][23] = m_RS.value("t_issuersectorcode");
                result[j][24] = m_RS.value("t_durationcode");
                result[j][25] = m_RS.value("t_regionclient");
                result[j][26] = "";
                result[j][27] = tarray;
              end;
              /*Суммируем*/
              result[j][11] = result[j][11] + Amount[i].AmountSum;
              result[j][15] = result[j][15] + round(Amount[i].AmountSum * m_RS.value("t_facevalue"), 4);
              result[j][16] = result[j][16] + round(Amount[i].AmountSum * RateValue, 4);
              if(m_RS.value("t_fioclient") != "")
                k = 0;
                while(k <= result[j][27].size - 1)
                  if(result[j][27][k] == m_RS.value("t_clientid"))
                    break;
                  end;
                  k = k + 1;
                end;
                if(k == result[j][27].size)
                  result[j][27][k] = m_RS.value("t_clientid");
                  if(result[j][26] == "")
                    result[j][26] = m_RS.value("t_fioclient");
                  else
                    result[j][26] = result[j][26] + ", " + m_RS.value("t_fioclient");
                  end;
                end;
              end;
            end;
          end;
          i = i + 1;
        end;
        /*Зануляем массив*/
        Amount = tarray();
        UseProgress(cnt);
      end;
      if(cnt > 0)
        RemProgress();
      end;
      if(TurnOffResult == IND_YES)
        for(j, 0, result.size-1)
          PrintTableLine(
                /* 1*/ "row1_1", result[j][1], null, 
                /* 2*/ "row1_2", result[j][2], null, 
                /* 3*/ "row1_3", result[j][3], null, 
                /* 4*/ "row1_4", result[j][4], null, 
                /* 5*/ "row1_5", result[j][5], null, 
                /* 6*/ "row1_6", result[j][6], null, 
                /* 7*/ "row1_7", result[j][7], null, 
                /* 8*/ "row1_8", result[j][8], null, 
                /* 9*/ "row1_9", result[j][9], null, 
                /*10*/ "row1_10", result[j][10], null, 
                /*11*/ "row1_11", result[j][11], null, 
                /*12*/ "row1_12", result[j][12], null, 
                /*13*/ "row1_13", result[j][13], null, 
                /*14*/ "row1_14", result[j][14], null, 
                /*15*/ "row1_15", result[j][15], null, 
                /*16*/ "row1_16", result[j][16], null, 
                /*17*/ "row1_17", result[j][17], null, 
                /*18*/ "row1_18", result[j][18], null, 
                /*19*/ "row1_19", result[j][19], null, 
                /*20*/ "row1_20", result[j][20], null, 
                /*21*/ "row1_21", result[j][21], null, 
                /*22*/ "row1_22", result[j][22], null, 
                /*23*/ "row1_23", result[j][23], null, 
                /*24*/ "row1_24", result[j][24], null, 
                /*25*/ "row1_25", result[j][25], null, 
                /*26*/ "row1_26", result[j][26], null);
        end;
      end;
    end;
    EndTable();
  END;
  
  initTX_RegistrReport(dec2form404_Panel(), "dec2form404.xlsx", true, null, null, true, true);

END;

/*Точка входа*/
var r = dec2form404_Report();
r.InitReport("Расшифровки к форме 404", null);
r.Run();

exit(1);
