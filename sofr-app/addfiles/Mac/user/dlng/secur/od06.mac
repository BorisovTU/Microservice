/*
$Name:        od06.mac
$Module:      Ценные бумаги
$Description: Таблица ОД_6: Реестр сделок с иностранной валютой: покупка, продажа, FOREX
$Programmer:  Кротов А.
*/
import od06_panel, ReportUser;
import captureoutput;


PRIVATE CLASS (TX_ReportUser) od06_Report
  var m_BeginDate/*, m_EndDate*/;

  /*Создание отчета*/
  PRIVATE MACRO Create()
    var m_que_FR;

    /*Счет по маске*/
    macro AccountMask(acc)
      if(strlen(acc) <= 1)
        return "";
      elif(strlen(acc) != 20)
        return acc;
      else
        return substr(acc,1,5) + "-" + substr(acc,6,3) + "-" + substr(acc,9,1) + "-" + substr(acc,10,4) + "-" + substr(acc,14);
      end;
    end;

    /*Финансовый результат и счета*/
    macro GetFR(dockind, docid, dt1, dt2, fr, Account7:@string, Account4:@string)
      var m_cmd_FR, m_RS_FR;
      Account7 = "";
      Account4 = "";
      m_cmd_FR = RsdCommand(m_que_FR);
      m_cmd_FR.AddParam("dt2", RSDBP_IN, dt2);
      m_cmd_FR.AddParam("dockind", RSDBP_IN, dockind);
      m_cmd_FR.AddParam("docid", RSDBP_IN, docid);
      m_cmd_FR.Execute();
      m_RS_FR = TRsbDataSet(m_cmd_FR);
      while(m_RS_FR.movenext())
        if(Account7 == "")
          Account7 = AccountMask(m_RS_FR.value("t_account7"));
        end;
        if(dt1 == dt2)
          break;
        end;
        if(substr(m_RS_FR.value("t_account4"),1,4) == "4742")
          Account4 = AccountMask(m_RS_FR.value("t_account4"));
          break;
        end;
      end;
    end;

/*Точка входа*/
    var cnt;
    var m_cmd;

    StartCaptureOutput();
    [
      select case when substr(acctrn.t_account_payer,1,5) = '70606' then acctrn.t_account_payer else acctrn.t_account_receiver end t_account7,
             case when substr(acctrn.t_account_payer,1,5) = '70606' then acctrn.t_account_receiver else acctrn.t_account_payer end t_account4  
      from doproper_dbt oproper
      join doprdocs_dbt oprdocs on oprdocs.t_id_operation = oproper.t_id_operation and
                                   oprdocs.t_dockind = 1
      join doprstep_dbt oprstep on oprstep.t_id_operation = oprdocs.t_id_operation and
                                   oprstep.t_id_step = oprdocs.t_id_step and
                                   oprstep.t_isexecute = chr(88) and
                                   oprstep.t_symbol in ('П','б')
      join dacctrn_dbt acctrn on acctrn.t_acctrnid = oprdocs.t_acctrnid and
                                 acctrn.t_state = 1/*Фактическая*/ and
                                 (substr(acctrn.t_account_payer,1,5) = '70606' or substr(acctrn.t_account_receiver,1,5) = '70601') and
                                 acctrn.t_date_carry <= ?
      where oproper.t_dockind = ? and 
            oproper.t_documentid = lpad(?,34,'0')
      order by acctrn.t_date_carry desc, acctrn.t_acctrnid desc
    ];
    m_que_FR = EndCaptureOutput();

    /*Отключаем все индикаторы*/
    if(m_UseTemplate)
      m_ObjTemplateXLS.SetFlagShowIndicator(false);
    else
      __BUG_Global_m_ObjTemplateXLS.SetFlagShowIndicator(false);
    end;
    m_ProgressIndicator = CreateProgressIndicator(true);

    /*Даты отчета*/
    if(m_Form.GetFieldValue(PNFLD_PERIOD) < 13)
      /*Задан месяц*/
      m_BeginDate = date(1, m_Form.GetFieldValue(PNFLD_PERIOD), FormData.Year);
      m_EndDate = DateAfterCalenMonths(m_BeginDate, 1) - 1;
    else 
      /*Задан квартал*/
      m_BeginDate = date(1, (m_Form.GetFieldValue(PNFLD_PERIOD) - 12 - 1) * 3 + 1, FormData.Year);
      m_EndDate = DateAfterCalenMonths(m_BeginDate, 3) - 1;
    end;

/*Лист "Покупка+продажа+FX"*/
    SetActiveSheet("Покупка+продажа+FX");
    PrintFormatString("", "reportname", "Таблица ОД_6 \"Реестр сделок с иностранной валютой: покупка, продажа, FOREX\" на " + string(date(m_EndDate+1):f));
    RegisterTable( "row1_0", "",
             /* 1*/ "row1_1", 
             /* 2*/ "row1_2", 
             /* 3*/ "row1_3", 
             /* 4*/ "row1_4", 
             /* 5*/ "row1_5", 
             /* 6*/ "row1_6", 
             /* 7*/ "row1_7", 
             /* 8*/ "row1_8", 
             /* 9*/ "row1_9", 
             /*10*/ "row1_10", 
             /*11*/ "row1_11", 
             /*12*/ "row1_12", 
             /*13*/ "row1_13", 
             /*14*/ "row1_14", 
             /*15*/ "row1_15", 
             /*16*/ "row1_16", 
             /*17*/ "row1_17", 
             /*18*/ "row1_18", 
             /*19*/ "row1_19", 
             /*20*/ "row1_20", 
             /*21*/ "row1_21", 
             /*22*/ "row1_22", 
             /*23*/ "row1_23", 
             /*24*/ "row1_24", 
             /*25*/ "row1_25");
    this.AutoFilter(7, "A", "Y");
    StartCaptureOutput();
    [
      select count(1) over() t_cnt,
             bdt, edt, fi_kind, t_id, t_state, t_dockind, t_fiidO, t_fiidT,
             t_extcode, t_code,
             contragent.t_name t_contragentname,
             nvl(market.t_shortname, chr(1)) t_marketname,
             case when t_contractorisbank > 0 and contragent.t_name != 'НКО НКЦ (АО)' then contragent.t_name else chr(1) end t_bankname,
             case when contragent.t_notresident = chr(88) then 'N' else 'R' end t_contragentres,
             t_dealtype,
             t_date, t_execdate, t_dur,
             fininstrT.t_codeinaccount t_fiidTname,
             t_amountT,
             t_amountTRUR,
             t_priceT,
             t_priceTCB,  
             fininstrO.t_codeinaccount t_fiidOname,
             t_amountO, 
             t_amountORUR,
             t_priceO,
             t_priceOCB,
             t_ispfi,
             case when t_dur = 0 or t_execdate <= edt then t_amountTRUR - t_amountORUR
                  else case when t_execdateT > edt then round(rsi_rsb_fiinstr.convsum(t_amountT,t_fiidT,0,edt),2) else t_amountTRUR end - case when t_execdateO > edt then round(rsi_rsb_fiinstr.convsum(t_amountO,t_fiidO,0,edt),2) else t_amountORUR end 
              end t_fr,
             case when t_marketkind > 0 then 'БИРЖА' when t_contractorisbank > 0 then 'Внебиржа' else 'Клиенты' end t_classificator
      from (select bdt, edt, fi_kind,
                   t_id, t_state, t_dockind,
                   t_execdateT, t_execdateO,  
                   t_extcode, t_code,
                   t_contractor, 
                   t_dealtype,
                   t_date, t_execdate, t_execdate - t_date t_dur, 
                   t_ispfi, t_marketkind, t_marketid,
                   t_fiidT,
                   t_amountT,
                   case when t_fiidT = 0 then t_amountT else round(rsi_rsb_fiinstr.convsum(t_amountT,t_fiidT,0,t_execdate),2) end t_amountTRUR,
                   case when t_priceT = 1 and t_fiidT != 0 then t_priceO else t_priceT end t_priceT,
                   case when t_fiidT = 0 then 1 else round(rsi_rsb_fiinstr.convsum(1,t_fiidT,0,t_execdate),4) end t_priceTCB,  
                   t_fiidO,
                   t_amountO, 
                   case when t_fiidO = 0 then t_amountO else round(rsi_rsb_fiinstr.convsum(t_amountO,t_fiidO,0,t_execdate),2) end t_amountORUR,
                   case when t_priceO = 1 and t_fiidO != 0 then t_priceT else t_priceO end t_priceO,
                   case when t_fiidO = 0 then 1 else round(rsb_fiinstr.convsum(1,t_fiidO,0,t_execdate),4) end t_priceOCB,  
                   (select count(1) cnt 
                    from dpartyown_dbt partyown 
                    where partyown.t_partyid = t_contractor and 
                          partyown.t_partykind = 2/*Банком*/) t_contractorisbank
            from(--Процентный СВОП (только валюта)
                 select bdt, edt, fininstrT.t_fi_kind fi_kind,
                        -- Сделка
                        dvndeal.t_id, dvndeal.t_state, dvndeal.t_dockind,  
                        dvndeal.t_extcode, dvndeal.t_code, 
                        dvndeal.t_contractor,
                        case when fininstrT.t_fiid != fininstrO.t_fiid then 'продажа'||' '|| fininstrO.t_ccy||' за '||fininstrT.t_ccy else chr(1) end t_dealtype,
                        dvndeal.t_date, greatest(dvnfiT.t_execdate, dvnfiT.t_paydate, dvnfiO.t_execdate, dvnfiO.t_paydate) t_execdate,
                        dvndeal.t_ispfi, dvndeal.t_marketkind, dvndeal.t_marketid,
                        -- Требования
                        greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdateT,
                        fininstrT.t_fiid t_fiidT,
                        dvnfiT.t_amount t_amountT,
                        dvnfiT.t_price t_priceT,
                        -- Обязательста
                        greatest(dvnfiO.t_execdate, dvnfiO.t_paydate) t_execdateO,
                        fininstrO.t_fiid t_fiidO,
                        dvnfiO.t_amount t_amountO, 
                        dvnfiO.t_price t_priceO
                 from ddvndeal_dbt dvndeal 
                 join (select :bdt bdt, :edt edt from dual) on 1=1
                 join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dvndeal.t_kind and 
                                                regexp_like(oprkoper.t_systypes, 'P'/*Процентный СВОП*/)
                 join ddvnfi_dbt dvnfiT on dvnfiT.t_dealid = dvndeal.t_id and 
                                           dvnfiT.t_type = 2 
                 join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvnfiT.t_fiid and 
                                                 fininstrT.t_fi_kind = 1
                 join ddvnfi_dbt dvnfiO on dvnfiO.t_dealid = dvndeal.t_id and 
                                           dvnfiO.t_type = 0
                 join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvnfiO.t_fiid and 
                                                 fininstrO.t_fi_kind = 1  
                 where dvndeal.t_dockind = 199/*Внебиржевая сделка с ПИ*/ and 
                       dvndeal.t_date between bdt and edt and 
                       dvndeal.t_state >= 1 and
                       dvndeal.t_ispfi != chr(88) and
                       fininstrT.t_fiid != fininstrO.t_fiid
                 union all
                 -- Опцион/Форвард (любой актив за валюту)
                 select bdt, edt, fininstrT.t_fi_kind fi_kind,
                        -- Сделка
                        dvndeal.t_id, dvndeal.t_state, dvndeal.t_dockind,  
                        dvndeal.t_extcode, dvndeal.t_code, 
                        dvndeal.t_contractor,
                        case when dvndeal.t_type = 1 then 'покупка' else 'продажа' end ||' '|| fininstrT.t_ccy||' за '||fininstrO.t_ccy t_dealtype,
                        dvndeal.t_date, greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdate,
                        dvndeal.t_ispfi, dvndeal.t_marketkind,  dvndeal.t_marketid,
                        -- Требования
                        greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdateT,
                        case when dvndeal.t_type != 1 then fininstrO.t_fiid else fininstrT.t_fiid end t_fiidT,
                        case when dvndeal.t_type != 1 then dvnfiT.t_cost else dvnfiT.t_amount end t_amountT,
                        case when dvndeal.t_type != 1 then 1 else dvnfiT.t_price end t_priceT,
                        -- Обязательста
                        greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdateO,
                        case when dvndeal.t_type != 1 then fininstrT.t_fiid else fininstrO.t_fiid end t_fiidO,
                        case when dvndeal.t_type != 1 then dvnfiT.t_amount else dvnfiT.t_cost end t_amountO, 
                        case when dvndeal.t_type != 1 then dvnfiT.t_price else 1 end t_priceO 
                 from ddvndeal_dbt dvndeal 
                 join (select :bdt bdt, :edt edt from dual) on 1=1
                 join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dvndeal.t_kind and 
                                                regexp_like(oprkoper.t_systypes, '[O|U]'/*Опцион/Форвард*/)
                 join ddvnfi_dbt dvnfiT on dvnfiT.t_dealid = dvndeal.t_id and 
                                           dvnfiT.t_type = 0 
                 join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvnfiT.t_fiid and 
                                                 fininstrT.t_fi_kind in (1,6)
                 join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvnfiT.t_pricefiid and 
                                                 fininstrO.t_fi_kind = 1  
                 where dvndeal.t_dockind = 199/*Внебиржевая сделка с ПИ*/ and 
                       dvndeal.t_date between bdt and edt and 
                       dvndeal.t_state >= 1 and 
                       dvndeal.t_ispfi != chr(88) and
                       fininstrT.t_fiid != fininstrO.t_fiid
                 union all
                 -- Валютный СВОП - первая нога (валюта и драгметалл)
                 select bdt, edt, fininstrT.t_fi_kind fi_kind,
                        -- Сделка
                        dvndeal.t_id, dvndeal.t_state, dvndeal.t_dockind,  
                        dvndeal.t_extcode, dvndeal.t_code||'/1' t_code, 
                        dvndeal.t_contractor,
                        case when dvndeal.t_type = 5 then 'покупка' else 'продажа' end ||' '|| fininstrT.t_ccy||' за '||fininstrO.t_ccy t_dealtype,
                        dvndeal.t_date, greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdate,
                        dvndeal.t_ispfi, dvndeal.t_marketkind, dvndeal.t_marketid,
                        -- Требования
                        greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdateT,
                        case when dvndeal.t_type != 5 then fininstrO.t_fiid else fininstrT.t_fiid end t_fiidT,
                        case when dvndeal.t_type != 5 then dvnfiT.t_cost else dvnfiT.t_amount end t_amountT,
                        case when dvndeal.t_type != 5 then 1 else dvnfiT.t_price end t_priceT,
                        -- Обязательста
                        greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdateO,
                        case when dvndeal.t_type != 5 then fininstrT.t_fiid else fininstrO.t_fiid end t_fiidO,
                        case when dvndeal.t_type != 5 then dvnfiT.t_amount else dvnfiT.t_cost end t_amountO, 
                        case when dvndeal.t_type != 5 then dvnfiT.t_price else 1 end t_amountO 
                 from ddvndeal_dbt dvndeal 
                 join (select :bdt bdt, :edt edt from dual) on 1=1
                 join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dvndeal.t_kind and 
                                                regexp_like(oprkoper.t_systypes, 'S'/*Валютный СВОП*/)
                 join ddvnfi_dbt dvnfiT on dvnfiT.t_dealid = dvndeal.t_id and 
                                           dvnfiT.t_type = 0 
                 join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvnfiT.t_fiid and 
                                                 fininstrT.t_fi_kind in (1,6)
                 join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvnfiT.t_pricefiid and 
                                                 fininstrO.t_fi_kind in (1,6)  
                 where dvndeal.t_dockind in (199/*Внебиржевая сделка с ПИ*/, 4813/*Конверсионная сделка ФИССиКО*/) and 
                       dvndeal.t_date between bdt and edt and 
                       dvndeal.t_state >= 1 and
                       dvndeal.t_ispfi != chr(88) and
                       fininstrT.t_fiid != fininstrO.t_fiid
                 union all
                 -- Валютный ПФИ - вторая нога (валюта и драгметалл)
                 select bdt, edt, fininstrT.t_fi_kind fi_kind,
                        -- Сделка
                        dvndeal.t_id, dvndeal.t_state, dvndeal.t_dockind,  
                        dvndeal.t_extcode, dvndeal.t_code||'/2' t_code, 
                        dvndeal.t_contractor,
                        case when dvndeal.t_type != 5 then 'покупка' else 'продажа' end ||' '|| fininstrT.t_ccy||' за '||fininstrO.t_ccy t_dealtype,
                        dvndeal.t_date, greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdate,
                        dvndeal.t_ispfi, dvndeal.t_marketkind, dvndeal.t_marketid,
                        -- Требования
                        greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdateT,
                        case when dvndeal.t_type = 5 then fininstrO.t_fiid else fininstrT.t_fiid end t_fiidT,
                        case when dvndeal.t_type = 5 then dvnfiT.t_cost else dvnfiT.t_amount end t_amountT,
                        case when dvndeal.t_type = 5 then 1 else dvnfiT.t_price end t_priceT,
                        -- Обязательста
                        greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdateO,
                        case when dvndeal.t_type = 5 then fininstrT.t_fiid else fininstrO.t_fiid end t_fiidO,
                        case when dvndeal.t_type = 5 then dvnfiT.t_amount else dvnfiT.t_cost end t_amountO, 
                        case when dvndeal.t_type = 5 then dvnfiT.t_price else 1 end t_priceO 
                 from ddvndeal_dbt dvndeal 
                 join (select :bdt bdt, :edt edt from dual) on 1=1
                 join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dvndeal.t_kind and 
                                                regexp_like(oprkoper.t_systypes, 'S'/*Валютный СВОП*/)
                 join ddvnfi_dbt dvnfiT on dvnfiT.t_dealid = dvndeal.t_id and 
                                           dvnfiT.t_type = 2 
                 join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvnfiT.t_fiid and 
                                                 fininstrT.t_fi_kind in (1,6)
                 join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvnfiT.t_pricefiid and 
                                                 fininstrO.t_fi_kind in (1,6)  
                 where dvndeal.t_dockind in (199/*Внебиржевая сделка с ПИ*/, 4813/*Конверсионная сделка ФИССиКО*/) and 
                       dvndeal.t_date between bdt and edt and 
                       dvndeal.t_state >= 1 and
                       dvndeal.t_ispfi != chr(88) and
                       fininstrT.t_fiid != fininstrO.t_fiid
                 union all
                 -- Покупка/продажа конверсионной операцией (валюта за драгметалл, драгметалл за валюту и валюта за валюту)
                 select bdt, edt, fininstrT.t_fi_kind fi_kind,
                        -- Сделка
                        dvndeal.t_id, dvndeal.t_state, dvndeal.t_dockind,  
                        dvndeal.t_extcode, dvndeal.t_code, 
                        dvndeal.t_contractor,
                        case when dvndeal.t_type = 1 then 'покупка' else 'продажа' end ||' '|| fininstrT.t_ccy||' за '||fininstrO.t_ccy t_dealtype,
                        dvndeal.t_date, greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdate,
                        dvndeal.t_ispfi, dvndeal.t_marketkind, dvndeal.t_marketid,
                        -- Требования
                        greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdateT,
                        case when dvndeal.t_type != 1 then fininstrO.t_fiid else fininstrT.t_fiid end t_fiidT,
                        case when dvndeal.t_type != 1 then dvnfiT.t_cost else dvnfiT.t_amount end t_amountT,
                        case when dvndeal.t_type != 1 then 1 else dvnfiT.t_price end t_priceT,
                        -- Обязательста
                        greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdateO,
                        case when dvndeal.t_type != 1 then fininstrT.t_fiid else fininstrO.t_fiid end t_fiidO,
                        case when dvndeal.t_type != 1 then dvnfiT.t_amount else dvnfiT.t_cost end t_amountO, 
                        case when dvndeal.t_type != 1 then dvnfiT.t_price else 1 end t_priceO 
                 from ddvndeal_dbt dvndeal 
                 join (select :bdt bdt, :edt edt from dual) on 1=1
                 join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dvndeal.t_kind and 
                                                regexp_like(oprkoper.t_systypes, 'D'/*Покупка/продажа*/)
                 join ddvnfi_dbt dvnfiT on dvnfiT.t_dealid = dvndeal.t_id and 
                                           dvnfiT.t_type = 0 
                 join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvnfiT.t_fiid and 
                                                 fininstrT.t_fi_kind in (1,6)
                 join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvnfiT.t_pricefiid and 
                                                 fininstrO.t_fi_kind in (1,6)  
                 where dvndeal.t_dockind = 4813/*Конверсионная сделка ФИССиКО*/ and 
                       dvndeal.t_date between bdt and edt and 
                       dvndeal.t_state >= 1 and
                       dvndeal.t_ispfi != chr(88) and
                       fininstrT.t_fiid != fininstrO.t_fiid
                 union all
                 -- Покупка/продажа сделкой Т+ (любой актив за валюту)
                 select bdt, edt, fininstrT.t_fi_kind fi_kind,
                        -- Сделка
                        dvndeal.t_id, dvndeal.t_state, dvndeal.t_dockind,  
                        dvndeal.t_extcode, dvndeal.t_code, 
                        dvndeal.t_contractor,
                        case when dvndeal.t_type = 1 then 'покупка' else 'продажа' end ||' '|| fininstrT.t_ccy||' за '||fininstrO.t_ccy t_dealtype,
                        dvndeal.t_date, greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdate,
                        dvndeal.t_ispfi, dvndeal.t_marketkind, dvndeal.t_marketid,
                        -- Требования
                        greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdateT,
                        case when dvndeal.t_type != 1 then fininstrO.t_fiid else fininstrT.t_fiid end t_fiidT,
                        case when dvndeal.t_type != 1 then dvnfiT.t_cost else dvnfiT.t_amount end t_amountT,
                        case when dvndeal.t_type != 1 then 1 else dvnfiT.t_price end t_priceT,
                        -- Обязательста
                        greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdateO,
                        case when dvndeal.t_type != 1 then fininstrT.t_fiid else fininstrO.t_fiid end t_fiidO,
                        case when dvndeal.t_type != 1 then dvnfiT.t_amount else dvnfiT.t_cost end t_amountO, 
                        case when dvndeal.t_type != 1 then dvnfiT.t_price else 1 end t_priceO 
                 from ddvndeal_dbt dvndeal 
                 join (select :bdt bdt, :edt edt from dual) on 1=1
                 join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dvndeal.t_kind and 
                                                regexp_like(oprkoper.t_systypes, 'D'/*Покупка/продажа*/)
                 join ddvnfi_dbt dvnfiT on dvnfiT.t_dealid = dvndeal.t_id and 
                                           dvnfiT.t_type = 0 
                 join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvnfiT.t_fiid and 
                                                 fininstrT.t_fi_kind in (1,6)
                 join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvnfiT.t_pricefiid and 
                                                 fininstrO.t_fi_kind = 1  
                 where dvndeal.t_dockind = 4815/*Сделка Т+3*/ and 
                       dvndeal.t_date between bdt and edt and
                       dvndeal.t_state >= 1 and 
                       dvndeal.t_ispfi != chr(88) and
                       fininstrT.t_fiid != fininstrO.t_fiid) dvndeal) dvndeal
      join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvndeal.t_fiidT  
      join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvndeal.t_fiidO  
      left join dparty_dbt contragent on contragent.t_partyid = dvndeal.t_contractor
      left join dparty_dbt market on market.t_partyid = t_marketid
      --where t_id in (686,18834)
      --where contragent.t_name = 'ING BANK N.V.'
      --where t_code = 'SPT:2605875'
      order by t_date
    ];
    m_cmd = RsdCommand(EndCaptureOutput());
    m_cmd.AddParam("bdt", RSDBP_IN, m_BeginDate);
    m_cmd.AddParam("edt", RSDBP_IN, m_EndDate);
    m_cmd.Execute();
    m_RS = TRsbDataSet(m_cmd);
    var Account7, Account4;
    cnt = 0;
    while(m_RS.movenext)
      if(cnt == 0)
        InitProgress(int(m_RS.value("t_cnt")), "Ждите...", "Формирование таблицы \"ОД_6\"");
      end;
      cnt = cnt + 1;
      /*Получим финрез*/
      GetFR(m_RS.value("t_dockind"), m_RS.value("t_id"), date(m_RS.value("t_date")), date(m_RS.value("t_execdate")), m_RS.value("t_fr"), @Account7, @Account4);
      /*Выводим строку отчета*/
      PrintTableLine(
            /* 1*/ "row1_1", m_RS.value("t_extcode"), null, 
            /* 2*/ "row1_2", m_RS.value("t_code"), null, 
            /* 3*/ "row1_3", m_RS.value("t_contragentname"), null, 
            /* 4*/ "row1_4", m_RS.value("t_marketname"), null, 
            /* 5*/ "row1_5", m_RS.value("t_bankname"), null, 
            /* 6*/ "row1_6", m_RS.value("t_contragentres"), null, 
            /* 7*/ "row1_7", m_RS.value("t_dealtype"), null, 
            /* 8*/ "row1_8", date(m_RS.value("t_date")), null, 
            /* 9*/ "row1_9", date(m_RS.value("t_execdate")), null, 
            /*10*/ "row1_10", m_RS.value("t_dur"), null, 
            /*11*/ "row1_11", m_RS.value("t_fiidTname"), null, 
            /*12*/ "row1_12", m_RS.value("t_amountT"), null, 
            /*13*/ "row1_13", m_RS.value("t_amountTRUR"), null, 
            /*14*/ "row1_14", m_RS.value("t_priceT"), null, 
            /*15*/ "row1_15", m_RS.value("t_priceTCB"), null, 
            /*16*/ "row1_16", m_RS.value("t_fiidOname"), null, 
            /*17*/ "row1_17", m_RS.value("t_amountO"), null, 
            /*18*/ "row1_18", m_RS.value("t_amountORUR"), null, 
            /*19*/ "row1_19", m_RS.value("t_priceO"), null, 
            /*20*/ "row1_20", m_RS.value("t_priceOCB"), null, 
            /*21*/ "row1_21", m_RS.value("t_ispfi"), null, 
            /*22*/ "row1_22", m_RS.value("t_fr"), null, 
            /*23*/ "row1_23", Account7, null, 
            /*24*/ "row1_24", m_RS.value("t_classificator"), null, 
            /*25*/ "row1_25", Account4, null);
      UseProgress(cnt);
    end;
    if(cnt > 0)
      RemProgress();
    end;
    EndTable();
  END;
  
  initTX_RegistrReport(od06_Panel(), "od06.xlsx", true, null, null, true, true);

END;

/*Точка входа*/
var r = od06_Report();
r.InitReport("ОД06", null);
r.Run();

exit(1);
