import RsbFormsInter, Global, or_rep_h,"cb_sql.mac";

const v_specval = 26;

private macro iif(a,b,c)
      if(a)
         return b;
      else
         return c;
      end;
   end;




CLASS OprRep(pPlannedOpr, pExpiredOpr, pDate)

var Report;
var vDAte   = pDAte;
var vPlannedOpr = pPlannedOpr;
var vExpiredOpr = pExpiredOpr;

var rn = 1;
var EXCEL_MONEY = "\"# ##0,00\"";
var sheet = 1,n_sheet = 2;
var count = 0;

var col1_len = 15,  col2_len = 25, col3_len = 15;
var col4_len = 25,  col5_len = 55,  col6_len = 9;
var col7_len = 15,   col8_len = 7, col9_len = 7;
var color  = 12632256;  
var ColorD = 16316664;
var ColorL = 15395562;

var head_format = "ex_FS(b):ex_B(tblr):ex_BC(" + color + ")";
var format      = "ex_FS():ex_B(tblr):ex_BC(" + color + ")";

private macro ДобавитьСтроку()
  Report.AddStr();rn = rn + 1;
end;

private macro ДобавитьПустуюСтроку()
   Report.AddEmptyStr();rn = rn + 1;
end; 

private macro ПечатьШапки ()        

    ДобавитьПустуюСтроку();

    Report.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
    Report.SetExecute("iBook.Sheets("+sheet+").Range(\"A"+(rn)+":D"+(rn)+"\").merge;");
   
    ДобавитьСтроку();

    Report.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
    Report.SetExecute("iBook.Sheets("+sheet+").Range(\"A"+(rn)+":D"+(rn)+"\").merge;");
    Report.AddPrintCell("Отчет о статусе исполнения шагов операций", col1_len, null, "r:ex_FS(b):ex_B()");
    ДобавитьСтроку();

    Report.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
    Report.SetExecute("iBook.Sheets("+sheet+").Range(\"A"+(rn)+":D"+(rn)+"\").merge;");
    Report.AddPrintCell("Дата отчета: " + string(vDate):f, col1_len, null, "l:ex_FS(b):ex_B()");
    ДобавитьСтроку();

    ДобавитьПустуюСтроку();

    rn = rn - 1;    

/*1*/   Report.AddPrintCell ("ID операции",    col1_len,  null, "c:" + head_format);
/*2*/   Report.AddPrintCell ("Код внутренний", col2_len,  null,"c:" + head_format);
/*2*/   Report.AddPrintCell ("Код внешний",    col3_len,  null,"c:" + head_format);
/*4*/   Report.AddPrintCell ("Вид операции",   col4_len,  null, "c:"+ head_format);
/*5*/   Report.AddPrintCell ("Наименование шага",        col5_len,  null, "c:" + head_format);
/*6*/   Report.AddPrintCell ("плановая дата исполнения", col6_len,  null, "c:" + head_format);
/*7*/   Report.AddPrintCell ("Статус выполнения",        col7_len,  null, "c:" + head_format);


    ДобавитьСтроку;  color = colorD; head_format = "c:ex_FZ(8):ex_FS():ex_B(tblr):ex_BC(" + color + ")"; color = colorL;
/*1*/   Report.AddPrintCell ("1", col1_len,  null, head_format);
/*2*/   Report.AddPrintCell ("2", col2_len,  null, head_format);
/*3*/   Report.AddPrintCell ("3", col3_len,  null, head_format);
/*4*/   Report.AddPrintCell ("4", col4_len,  null, head_format);
/*5*/   Report.AddPrintCell ("5", col5_len,  null, head_format);

    Report.SetExecute("iBook.Sheets("+sheet+").Rows("+(rn)+").AutoFilter;");
    ДобавитьСтроку;
end;

private macro ПечатьБлокаДанных(_rs);
    if(valtype(_rs) != v_undef)
    format = "ex_FS():ex_B(tblr)";
    var test;
      while(_rs.movenext)
        Report.AddPrintCell(int(_rs.value("t_documentid")), col1_len, null, "l:"+format); // 1. 
        Report.AddPrintCell(_rs.value("T_dealcode"), col2_len, null, "l:"+format); // 2.  
        Report.AddPrintCell(_rs.value("T_dealcodets"), col3_len, null, "l:"+format); // 3.  
        Report.AddPrintCell(_rs.value("T_name"), col4_len, null, "l:"+format); // 4.  
        Report.AddPrintCell(_rs.value("T_step_name"), col5_len, null, "l:"+format); // 5. 
        Report.AddPrintCell(date(_rs.value("T_plan_date")), col6_len, null, "l:"+format); // 6.  
        Report.AddPrintCell(iif(_rs.value("T_plan_date")<vDate, "Просрочен","Запланирован"), col7_len, null, "l:"+format); // 7. 

        ДобавитьСтроку;
                     
      end;
    end;
end;

macro run()
var SQL, cmd, rs, KP = 0;

  Report = CMakeReport("┌┬┬┬┬┬┬┬┬┬┬┬┐");
  Report.SetDefaultFontName("Times New Roman");
  Report.SetDefaultFontSize(10);
  Report.SetFlagShowGrid(true);

  ПечатьШапки();

var query =  "   select oprstep.t_id_operation,   ";
    query = query + "   oprstep.t_blockid,  ";
    query = query + "   oprstep.t_kind_operation, ";
    query = query + "   oprstep.t_number_step, ";
    query = query + "   oprstep.t_plan_date,   ";
    query = query + "   oprstep.t_fact_date,   ";
    query = query + "   oprstep.t_syst_date,   ";
    query = query + "   oprstep.t_dockind,  ";
    query = query + "   oprkind.t_name,  ";
    query = query + "   to_number(opr.t_documentid) t_documentid,   ";
    query = query + "   tick.t_dealcode,    ";
    query = query + "   tick.t_dealcodets, step.T_NAME t_step_name  ";
    query = query + " FROM doprstep_dbt oprstep, doprkoper_dbt oprkind, doproper_dbt opr, ddl_tick_dbt tick, doprostep_dbt step   ";
    query = query + "  where 1 = 1  ";
    query = query + "   and oprstep.t_id_operation = opr.t_id_operation   ";
    query = query + "   and oprstep.t_kind_operation = oprkind.t_kind_operation ";
    query = query + "   and oprstep.t_kind_operation = tick.t_dealtype ";
    query = query + "   and to_number(opr.t_documentid) = tick.t_dealid   ";
    query = query + "   and oprstep.T_BLOCKID = step.T_BLOCKID  ";
    query = query + "   and oprstep.T_NUMBER_STEP = step.T_NUMBER_STEP  ";
    query = query + "   and oprstep.t_fact_date = to_date('01.01.0001','dd.mm.yyyy')  ";
    query = query + "   and oprstep.t_plan_date >= to_date('01.01.2020','dd.mm.yyyy') ";
    if((vPlannedOpr) and (vExpiredOpr))
      query = query + "   and oprstep.t_plan_date <= ? ";
    elif(vPlannedOpr)
      query = query + "   and oprstep.t_plan_date = ? ";
    elif(vExpiredOpr)
      query = query + "   and oprstep.t_plan_date < ? ";
    end;
    query = query + "   and oprstep.t_dockind not in (102)   ";

begaction(100,"Сбор данных...");
cmd = RSDCommand(Query);
cmd.addparam("", rsdbp_in,vDate);

rs = RSDRecordset(cmd, rsdval_client,rsdval_static);
      ПечатьБлокаДанных(rs);
    //  runscroll(rs);
      endaction;

      Report.PrintWinRep("Отчет.");
      Report.SetWinRepOutput();
      Report.ShowWinRep();

end;  

END;


CLASS (TRsbPanel) Pan(rDate)
    initTRsbPanel();

    const K_Enter = 13;
    const K_F3    = 317;
    const K_F2    = 316;

    const BeginCalcDate_ID = 1;

    var curstr = 0;
    Caption = "Операции. исполнение шагов.";
    Status = "~ESC~Выход ~F2~Выполнить";
    setSize(26,10);
    setPosition(30,10);
    
    var BeginCalcDate;
    curstr = curstr+2;
    BeginCalcDate = TRsbEditField(V_DATE);
    BeginCalcDate.setPosition(16,curstr);
    BeginCalcDate.setSize(8,1);
    BeginCalcDate.name = "begincalcdate";
    BeginCalcDate.value = rDate;
    addControl(BeginCalcDate);


    var m_LabelCD:TrsbLabel = TRsbLabel(2,curstr,"Дата отчета:");
    addLabel (m_LabelCD);

    var pLbl;
    curstr = curstr+1;
    pLbl = TRsbLabel(2,curstr,"_________________________________ ");
    addLabel (pLbl);    

    curstr = curstr+1;
    var pPlannedOpr, pPlannedOprLbl;
    pPlannedOpr = TRsbCheckbox;
    pPlannedOpr.setPosition(2,curstr);
    pPlannedOpr.name = "pPlannedOpr";
    pPlannedOpr.checked = true;
    addControl(pPlannedOpr);
    pPlannedOprLbl = TRsbLabel(5,curstr,"вывести запланированные шаги");
    addLabel (pPlannedOprLbl);

    curstr = curstr+1;
    var pExpiredOpr, pExpiredOprLbl;
    pExpiredOpr = TRsbCheckbox;
    pExpiredOpr.setPosition(2,curstr);
    pExpiredOpr.name = "pExpiredOpr";
    pExpiredOpr.checked = true;
    addControl(pExpiredOpr);
    pExpiredOprLbl = TRsbLabel(5,curstr,"Вывести просроченные шаги");
    addLabel (pExpiredOprLbl);

    addEventHandler(RSB_EV_KEY_PRESSED, R2M(this, "onKeyPressed"));
    
    macro onKeyPressed(ev)
        if (ev.KeyCode == K_F3)
           if (ev.id == BeginCalcDate_ID)
            BeginCalcDate.value = GetDateByCalendar({CurDate});
            this.redraw; 
           end;
        elif (ev.KeyCode == K_Enter)
            this.redraw; 
        elif(ev.keyCode == K_F2)
         var myRep = OprRep(THIS.pPlannedOpr.checked, THIS.pExpiredOpr.checked, BeginCalcDate.value );
         myRep.run;
        end;
    end; 
END;


var myPanel:TRsbPanel = Pan({Curdate});
     myPanel.run;
exit(1);
