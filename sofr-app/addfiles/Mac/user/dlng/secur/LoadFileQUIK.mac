import "RSHB_Quik2.mac", rsd;
import u_common_email_utils;
import "simpleservice.mac";
 
PRIVATE CONST REG_PATH_AUTO = "РСХБ\\ДИРЕКТОРИИ\\QUIK_IN_AUTO";

private macro WriteLog(_label)
   var sql = 
            "INSERT INTO DCALCLIMITLOG_DBT (T_DATE, T_LABEL, T_START, T_END, T_ACTION) " +
            "     VALUES (trunc(sysdate),substr(:label_,1,250),SYSTIMESTAMP,SYSTIMESTAMP,null); " ;
   var cmd = RsdCommand(sql);
   cmd.addParam("",RSDBP_IN,_label);
   cmd.Execute();
end;

private macro _LoadDataSecur(dat, err:@string, folder)
   LoadDataSecur(dat,@err, folder);
   if (err != "")
      return 1;
   end;
   return 0;
OnError(ErrObj)
    if (IsEqClass ("TrslError", ErrObj))
      Err=ErrObj.Message + " " + ErrObj.Module + " " + ErrObj.Line;
      if(IsEqClass ("TDbError", ErrObj.err))
        Err="Ошибка загрузки файла QUIK: " + Err+":|"+ErrObj.err.Stat+"-"+ErrObj.err.Oper+"-"+ErrObj.err.Table+"-"+ErrObj.err.Message;
      end;
    elif (not Err)
      Err="Ошибка загрузки файла QUIK";
    end;
    return 1;
end;

private macro _LoadDataFutur(dat, err:@string, folder)
   LoadDataFutur(dat,@err, folder);
   if (err != "")
      return 1;
   end;
   return 0;
OnError(ErrObj)
    if (IsEqClass ("TrslError", ErrObj))
      Err=ErrObj.Message + " " + ErrObj.Module + " " + ErrObj.Line;
      if(IsEqClass ("TDbError", ErrObj.err))
        Err="Ошибка загрузки файла QUIK: " + Err+":|"+ErrObj.err.Stat+"-"+ErrObj.err.Oper+"-"+ErrObj.err.Table+"-"+ErrObj.err.Message;
      end;
    elif (not Err)
      Err="Ошибка загрузки файла QUIK";
    end;
    return 1;
end;

private macro _SaveArch(dat, err:@string)
   var cmd = null;
   cmd = RsdCommand(" begin " + 
                    " rshb_rsi_sclimit.SaveArchMoney(:p_CalcDate); " + 
                    " rshb_rsi_sclimit.SaveArchSecur(:p_CalcDate2); " + 
                    " rshb_rsi_sclimit.SaveArchFuture(:p_CalcDate3); " + 
                    " end;");
   cmd.AddParam("p_CalcDate",RSDBP_IN,dat);
   cmd.AddParam("p_CalcDate2",RSDBP_IN,dat);
   cmd.AddParam("p_CalcDate3",RSDBP_IN,dat);
   cmd.Execute;
   return 0;
OnError(ErrObj)
    if (IsEqClass ("TrslError", ErrObj))
      Err=ErrObj.Message + " " + ErrObj.Module + " " + ErrObj.Line;
      if(IsEqClass ("TDbError", ErrObj.err))
        Err="Ошибка переноса данных в архив: " + Err+":|"+ErrObj.err.Stat+"-"+ErrObj.err.Oper+"-"+ErrObj.err.Table+"-"+ErrObj.err.Message;
      end;
    elif (not Err)
      Err="Ошибка переноса данных в архив";
    end;
    return 1;
end;

macro _LoadFileQUIK()
   var folder = "", ErrObj, ErrStr = "", cmd;
   var v_email_processor;
   var res = SS_RESPONSE_END;
   getregistryvalue(REG_PATH_AUTO, V_STRING, folder );

   /*запускаемся только в рабочий день банка*/
   if (true) //(IsWorkDay(date()))
      var err = "";
      /*файл формируется ночью после предыдущего рабочего дня Биржи*/
      var dat = GetDateAfterWorkDays(date(), -1, 20/*календарь Биржи*/) + 1;

      var sdf = SetDialogFlag(0);

      WriteLog("Начало загрузки файла QUIK фондового и валютного рынков");
      if (_LoadDataSecur(dat,@err, folder) != 0 );
      if (err != "")
				res = SS_RESPONSE_FATAL;
         WriteLog(err);
         ErrStr = err;
      end;
      end;
      WriteLog("Завершение загрузки файла QUIK фондового и валютного рынков");

      WriteLog("Начало загрузки файла QUIK срочного рынка");
      if (_LoadDataFutur(dat,@err, folder) != 0 );
      if (err != "")
				res = SS_RESPONSE_FATAL;
         WriteLog(err);
         if (ErrStr != "")
           ErrStr = ErrStr + "\n\n" + err; 
         else 
           ErrStr = err; 
         end;
      end;
      end;
      WriteLog("Завершение загрузки файла QUIK срочного рынка");  

      SetDialogFlag(sdf);
   /*Отправить письмо*/
   if (ErrStr != "")
          res = SS_RESPONSE_FATAL;
      v_email_processor = c_email_proc_env();
      v_email_processor.m_set_msg_head("Ошибка загрузки файла QUIK");
      v_email_processor.m_add_row_to_msg_text(string(date():f) + " " + string(time():f) + "\n" + ErrStr);
      v_email_processor.m_save_to_submit_grp(20 /*LoadFileQUIK*/, true);
   end;
   end;

   WriteLog("Старт переноса рассчитанных данных в архив");
   if (_SaveArch(GetDateAfterWorkDays(date(), -1, 20/*календарь Биржи*/), @err) != 0 )
     WriteLog("ОШИБКА архивирования :"+err);
     res = SS_RESPONSE_FATAL;
   else 
     WriteLog("Архивирование завершено");
   end;    

   Return SsExecResult(res);

   OnError(ErrObj)
    if (IsEqClass ("TrslError", ErrObj))
      ErrStr=ErrObj.Message + " " + ErrObj.Module + " " + ErrObj.Line;
      if(IsEqClass ("TDbError", ErrObj.err))
        ErrStr="Ошибка LoadFileQUIK.mac: " + ErrStr+":|"+ErrObj.err.Stat+"-"+ErrObj.err.Oper+"-"+ErrObj.err.Table+"-"+ErrObj.err.Message;
      end;
    elif (not ErrStr)
      ErrStr="Ошибка LoadFileQUIK.mac";
    end;
   WriteLog(ErrStr);
    SetDialogFlag(sdf);
    /*Отправить письмо*/
    v_email_processor = c_email_proc_env();
    v_email_processor.m_set_msg_head("Ошибка LoadFileQUIK.mac");
    v_email_processor.m_add_row_to_msg_text(ErrStr);
    v_email_processor.m_save_to_submit_grp(20 /*LoadFileQUIK*/, true);
    RunError();
 end;
//_LoadFileQUIK;
