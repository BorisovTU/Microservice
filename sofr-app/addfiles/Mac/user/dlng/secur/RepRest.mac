/*
carry_no_sent.mac
*/
import globals, or_rep_h, oralib, likepy, RSD, Календарь;
import  RsbFormsInter;
import "jvmutils.mac";

//import DealsInter, SPInter, PTInter;
import /*RsbDataSet,*/ /*"dlutils.mac",*/ "scsrvrepfun.mac";



const K_F2 = 316;
const K_F3 = 317;

var repdt,vDepID, vDepName = "";
var vDepoACC = "", vDepoPart = "";

var errStr,err;


PRIVATE MACRO AddCol (ar,ind, fld, head, width, rdonly, ty, dp)
   ar.value (ind * 6)     = fld;
   ar.value (ind * 6 + 1) = head;
   ar.value (ind * 6 + 2) = width;
   ar.value (ind * 6 + 3 ) = rdonly;   // fldType
   ar.value (ind * 6 + 4 ) = dp;//   decPoint
   ar.value (ind * 6 + 5 ) = 0;   // reserv
END;

  
macro EvProc2(rs, cmd, id, key)
   
   if (cmd == DLG_KEY)
    if (key == 13)
       vDepID = rs.value("t_partyid");
       vDepName = rs.value("T_ShortNAME");
       return CM_SELECT;
    end;   
  end;
end;

macro EvProc3(rs, cmd, id, key)
   
   if (cmd == DLG_KEY)
    if (key == 13)
       vDepoACC = rs.value("t_DepoAccCode");
       return CM_SELECT;
    end;   
  end;
end;

macro EvProc4(rs, cmd, id, key)
   
   if (cmd == DLG_KEY)
    if (key == 13)
       vDepoPart = rs.value("t_DepoPartCode");
       return CM_SELECT;
    end;   
  end;
end;

macro RepRest (_depID, _DepAcc, _depPart, _repdt)
  var EXCEL_MONEY = "\"# ##0,00\"";

  repdt = _repdt;

  var rn    = 0;
  var sheet = 1;
  var count = 0;
  var col1_len = 10;
  var col2_len = 15;
  var col3_len = 12;
  var col4_len = 10;
  var col5_len = 30;
  var col6_len = 5;
  var col7_len = 8;
  var col8_len = 7;
  var col9_len = 14;
  var col10_len = 15; // 12
  var col11_len = 30;
  var col12_len = 15;
  var col13_len = 10;
  var col14_len = 10;
  var /*Rep,*/ sql;
 
  var sumSt = 0;
  var sumAc = 0;
  var sumPt = 0;

  var sumFlag = 0;

private macro AddCell(colID, poiCurrentSheet, poiCurrentRow, Style, Value, width)
  var poiCurrentCell = poiCurrentRow.{createCell@(I)Lorg/apache/poi/xssf/usermodel/XSSFCell;}(colID);
  poiCurrentCell.setCellStyle(Style);
  poiCurrentCell.{setCellValue@(Ljava/lang/String;)V}(Value);
  if (ValType(width) != V_UNDEF)
    poiCurrentSheet.setColumnWidth(colID, width * 256);
  end;
end;


private macro AddMergedCell(fromColID, toColID, numRow, jvm, poiCurrentSheet, Style, Value/*, width*/)
    var poiCurrentRow = poiCurrentSheet.{createRow@(I)Lorg/apache/poi/xssf/usermodel/XSSFRow;}(numRow);
    var poiCurrentCell = poiCurrentRow.{createCell@(I)Lorg/apache/poi/xssf/usermodel/XSSFCell;}(fromColID);

    poiCurrentCell.setCellStyle(Style);
    poiCurrentCell.{setCellValue@(Ljava/lang/String;)V}(Value);

    var mergeAddress = jvm.createJavaObject("org.apache.poi.ss.util.CellRangeAddress",
                                            "<init>@(IIII)V", numRow, numRow, fromColID, toColID);

    poiCurrentSheet.addMergedRegion(mergeAddress);
end;


private macro print_header(poiCurrentSheet, poiCurrentRow, headerStyle)
  poiCurrentRow.setHeightInPoints(45);

  AddCell(0, poiCurrentSheet, poiCurrentRow, headerStyle, "Код ценной бумаги",                  col1_len);
  AddCell(1, poiCurrentSheet, poiCurrentRow, headerStyle, "Вид ценной бумаги",                  col2_len);
  AddCell(2, poiCurrentSheet, poiCurrentRow, headerStyle, "Код ISIN",                           col3_len);
  AddCell(3, poiCurrentSheet, poiCurrentRow, headerStyle, "Госрег номер",                       col4_len);
  AddCell(4, poiCurrentSheet, poiCurrentRow, headerStyle, "Краткое наименование ценных бумаг",  col5_len);
  AddCell(5, poiCurrentSheet, poiCurrentRow, headerStyle, "Валюта номинала",                    col6_len);
  AddCell(6, poiCurrentSheet, poiCurrentRow, headerStyle, "Номинал",                            col7_len);
  AddCell(7, poiCurrentSheet, poiCurrentRow, headerStyle, "Номера ценных бумаг",                col8_len);
  AddCell(8, poiCurrentSheet, poiCurrentRow, headerStyle, "Количество штук",                    col9_len);
  AddCell(9, poiCurrentSheet, poiCurrentRow, headerStyle, "Сумма номинала",                     col10_len);

  rn = rn + 1;
end;

  var jvm = CreateObject("rsjvm", "TJavaHost", "GlobalJavaHost");
  var poiRepCreator = jvm.callStaticMethod("ru.softlab.rsbank.poireports.ReportCreator", "getInstance");
  var poiBook = poiRepCreator.addWorkbookXLSX();
  var poiWorkBook = poiBook.getCurrentWorkbook();
  var poiCurrentSheet = poiWorkBook.{getSheetAt@(I)Lorg/apache/poi/xssf/usermodel/XSSFSheet;}(0); 

  var headerStyle = poiWorkBook.{createCellStyle@()Lorg/apache/poi/ss/usermodel/CellStyle;}();
  var headerFont = poiWorkBook.{createFont@()Lorg/apache/poi/xssf/usermodel/XSSFFont;}();

  var borderStyle = GetJavaEnumConstByName(jvm, "org.apache.poi.ss.usermodel.BorderStyle", "THIN");
  var borderColor = GetJavaEnumConstByName(jvm, "org.apache.poi.ss.usermodel.IndexedColors", "BLACK");

  headerFont.setBold(true);
  headerFont.setFontHeightInPoints(10);

  headerStyle.setAlignment(GetJavaEnumConstByName(jvm, "org.apache.poi.ss.usermodel.HorizontalAlignment", "CENTER"));
  headerStyle.setVerticalAlignment(GetJavaEnumConstByName(jvm, "org.apache.poi.ss.usermodel.VerticalAlignment", "TOP"));
  headerStyle.setFont(headerFont);
  headerStyle.setWrapText(true);
  headerStyle.setBorderRight(borderStyle);
  headerStyle.setRightBorderColor(borderColor.getIndex());
  headerStyle.setBorderLeft(borderStyle);
  headerStyle.setLeftBorderColor(borderColor.getIndex());
  headerStyle.setBorderBottom(borderStyle);
  headerStyle.setBottomBorderColor(borderColor.getIndex());
  headerStyle.setBorderTop(borderStyle);
  headerStyle.setTopBorderColor(borderColor.getIndex());

  var tableCellStyle = poiWorkBook.{createCellStyle@()Lorg/apache/poi/ss/usermodel/CellStyle;}();
  var tableCellFont = poiWorkBook.{createFont@()Lorg/apache/poi/xssf/usermodel/XSSFFont;}();
  tableCellFont.setFontHeightInPoints(10);

  tableCellStyle.setAlignment(GetJavaEnumConstByName(jvm, "org.apache.poi.ss.usermodel.HorizontalAlignment", "CENTER"));
  tableCellStyle.setVerticalAlignment(GetJavaEnumConstByName(jvm, "org.apache.poi.ss.usermodel.VerticalAlignment", "TOP"));
  tableCellStyle.setFont(tableCellFont);
  tableCellStyle.setWrapText(true);
  tableCellStyle.setBorderRight(borderStyle);
  tableCellStyle.setRightBorderColor(borderColor.getIndex());
  tableCellStyle.setBorderLeft(borderStyle);
  tableCellStyle.setLeftBorderColor(borderColor.getIndex());
  tableCellStyle.setBorderBottom(borderStyle);
  tableCellStyle.setBottomBorderColor(borderColor.getIndex());
  tableCellStyle.setBorderTop(borderStyle);
  tableCellStyle.setTopBorderColor(borderColor.getIndex());


  var leftTitleStyle = poiWorkBook.{createCellStyle@()Lorg/apache/poi/ss/usermodel/CellStyle;}();
  var leftTitleFont = poiWorkBook.{createFont@()Lorg/apache/poi/xssf/usermodel/XSSFFont;}();
  leftTitleFont.setBold(true);
  leftTitleFont.setFontHeightInPoints(10);
  leftTitleStyle.setAlignment(GetJavaEnumConstByName(jvm, "org.apache.poi.ss.usermodel.HorizontalAlignment", "LEFT"));
  leftTitleStyle.setFont(leftTitleFont);


  var leftTitleKStyle = poiWorkBook.{createCellStyle@()Lorg/apache/poi/ss/usermodel/CellStyle;}();
  var leftTitleKFont = poiWorkBook.{createFont@()Lorg/apache/poi/xssf/usermodel/XSSFFont;}();
  leftTitleKFont.setBold(true);
  leftTitleKFont.setItalic(true);
  leftTitleKFont.setFontHeightInPoints(10);
  leftTitleKStyle.setAlignment(GetJavaEnumConstByName(jvm, "org.apache.poi.ss.usermodel.HorizontalAlignment", "LEFT"));
  leftTitleKStyle.setFont(leftTitleKFont);

  var rightTitleKStyle = poiWorkBook.{createCellStyle@()Lorg/apache/poi/ss/usermodel/CellStyle;}();
  var rightTitleKFont = poiWorkBook.{createFont@()Lorg/apache/poi/xssf/usermodel/XSSFFont;}();
  rightTitleKFont.setBold(true);
  rightTitleKFont.setItalic(true);
  rightTitleKFont.setFontHeightInPoints(10);
  rightTitleKStyle.setAlignment(GetJavaEnumConstByName(jvm, "org.apache.poi.ss.usermodel.HorizontalAlignment", "RIGHT"));
  rightTitleKStyle.setFont(leftTitleKFont);



  var centerTitleStyle = poiWorkBook.{createCellStyle@()Lorg/apache/poi/ss/usermodel/CellStyle;}();
  var centerTitleFont = poiWorkBook.{createFont@()Lorg/apache/poi/xssf/usermodel/XSSFFont;}();
  centerTitleFont.setBold(true);
  centerTitleFont.setFontHeightInPoints(10);
  centerTitleStyle.setAlignment(GetJavaEnumConstByName(jvm, "org.apache.poi.ss.usermodel.HorizontalAlignment", "CENTER"));
  centerTitleStyle.setFont(centerTitleFont);

  var centerTitle12Style = poiWorkBook.{createCellStyle@()Lorg/apache/poi/ss/usermodel/CellStyle;}();
  var centerTitle12Font = poiWorkBook.{createFont@()Lorg/apache/poi/xssf/usermodel/XSSFFont;}();
  centerTitle12Font.setBold(true);
  centerTitle12Font.setFontHeightInPoints(12);

  centerTitle12Style.setAlignment(GetJavaEnumConstByName(jvm, "org.apache.poi.ss.usermodel.HorizontalAlignment", "CENTER"));
  centerTitle12Style.setFont(centerTitle12Font);




  var poiCurrentRow = poiCurrentSheet.{createRow@(I)Lorg/apache/poi/xssf/usermodel/XSSFRow;}(0);

  BegAction(2000, "Формируем список", false);


  var regStyle = poiWorkBook.{createCellStyle@()Lorg/apache/poi/ss/usermodel/CellStyle;}();

  AddMergedCell(0, 9, rn, jvm, poiCurrentSheet, leftTitleStyle, "выписка по регистру КДУ, остатки на конец дня " + repdt );
  rn = rn + 1;
  
  SQL = " SELECT QRACC.T_STORAGEID,lead(QRACC.T_STORAGEID) over (order by QRACC.T_STORAGEID, qracc.t_depoacccode, qracc.t_depopartcode ) T_NStorageid, "
      + " lag(QRACC.T_STORAGEID) over (order by QRACC.T_STORAGEID, qracc.t_depoacccode, qracc.t_depopartcode ) T_pStorageid, "
      + " qracc.t_depoacccode, lead(QRACC.t_depoacccode) over (order by QRACC.T_STORAGEID, qracc.t_depoacccode, qracc.t_depopartcode ) t_Ndepoacccode,lag(QRACC.t_depoacccode) over (order by QRACC.T_STORAGEID, qracc.t_depoacccode, qracc.t_depopartcode ) t_pDepoacccode, "
      + " QRACC.t_depopartcode, lead(QRACC.t_depopartcode) over (order by QRACC.T_STORAGEID, qracc.t_depoacccode, qracc.t_depopartcode ) t_Ndepopartcode, lag(QRACC.t_depopartcode) over (order by QRACC.T_STORAGEID, qracc.t_depoacccode, qracc.t_depopartcode ) t_pdepopartcode,"
      + "       PT.T_shortNAME, fi.t_fi_code, "
      + "       AV.T_LSIN, "
      + "       AV.T_ISIN, "
      + "       FI.T_NAME, "
      + "       avk.t_name t_FiKind, "
      + "       fifv.t_ccy, "
      + "       rsb_fiinstr.FI_GetNominalOnDate (fi.t_fiid, to_date('" +repdt + "','dd.mm.yyyy'))   T_Nominal, "
      + "       acc.t_account, "
      + "       ABS (RSI_RSB_ACCOUNT.RestAC (acc.t_ACCOUNT,acc.t_CODE_CURRENCY,to_date('" +repdt + "','dd.mm.yyyy'),acc.t_CHAPTER,0)) t_AccRest, "
      + "       (ABS (RSI_RSB_ACCOUNT.RestAC (acc.t_ACCOUNT,acc.t_CODE_CURRENCY,to_date('" +repdt + "','dd.mm.yyyy'),acc.t_CHAPTER,0)) *  rsb_fiinstr.FI_GetNominalOnDate (fi.t_fiid, to_date('" +repdt + "','dd.mm.yyyy')) ) T_SumNominal "
      + "  FROM daccount_dbt acc, "
      + "       dscqracc_dbt qracc, "
      + "       dparty_dbt pt, "
      + "       dfininstr_dbt fi, "
      + "       dfininstr_dbt fifv, "
      + "       davoiriss_dbt av, "
      + "       davrkinds_dbt avk "
      + " WHERE     acc.t_Chapter = 5 "
      + "       AND acc.t_Client = 1 "
      + "       AND ACC.T_KIND_ACCOUNT = 'А' "
      + "       AND acc.t_Department = 1 "
      + "       AND acc.t_accountid = qracc.t_accountid "
      + "       AND FI.T_FIID = QRACC.T_FIID "
      + "       AND AV.T_FIID = QRACC.T_FIID ";
if (valtype(_DepID) != v_undef)
  SQL = SQL + " AND QRACC.T_STORAGEID = " + _DepID;
  if (_DepAcc != "")
    SQL = SQL + " AND QRACC.T_DepoAccCode = '" + _DepAcc + "'";
    if (_DepPart != "")
      SQL = SQL + " AND QRACC.T_DepoPartCode = '" + _DepPart + "'";
    end;
  end;
end;
 SQL= SQL + "   AND PT.T_PARTYID = QRACC.T_STORAGEID "
      + "       AND avk.t_fi_kind = fi.t_fi_kind "
      + "       AND avk.t_avoirkind = fi.t_avoirkind "
      + "       AND fifv.t_fiid = fi.t_facevaluefi "
      + "       AND (acc.t_Close_Date = TO_DATE ('01.01.0001', 'DD.MM.YYYY') "
      + "            OR acc.t_Close_Date >= to_date('" +repdt + "','dd.mm.yyyy')) "
      + "       AND acc.t_Open_Date <= to_date('" +repdt + "','dd.mm.yyyy') "
      + "       and ABS (RSI_RSB_ACCOUNT.RestAC (acc.t_ACCOUNT,acc.t_CODE_CURRENCY,to_date('" +repdt + "','dd.mm.yyyy'),acc.t_CHAPTER,0)) > 0 "
      + "       order by QRACC.T_STORAGEID, qracc.t_depoacccode, qracc.t_depopartcode  " ;

  sql = ExecSqlSelect(sql, null, false);
  while (sql.MoveNext() )
    if (sql.value("T_StorageID") != sql.value("T_pStorageID"))
         AddMergedCell(0, 9, rn, jvm, poiCurrentSheet, centerTitle12Style, " Место хранения: " + string(SQL_ConvTypeStr(sql.value("T_shortNAME"))));
         rn = rn + 1;
    end;

    if (sql.value("T_DepoAccCode") != sql.value("T_pDepoAccCode"))
         AddMergedCell(0, 9, rn, jvm, poiCurrentSheet, centerTitleStyle, "Остатки на счете : " +  string(SQL_ConvTypeStr(sql.value("T_DepoAccCode"))));
         rn = rn + 1;
    end;

    if (sql.value("T_DepoPartCode") != sql.value("T_pDepoPartCode"))
       AddMergedCell(0, 9, rn, jvm, poiCurrentSheet, leftTitleKStyle, "Раздел счета :   " + string(SQL_ConvTypeStr(sql.value("T_DepoPartCode"))) );
       rn = rn + 1;

       poiCurrentRow = poiCurrentSheet.{createRow@(I)Lorg/apache/poi/xssf/usermodel/XSSFRow;}(rn);
       print_header(poiCurrentSheet, poiCurrentRow, headerStyle);
    end;

    poiCurrentRow = poiCurrentSheet.{createRow@(I)Lorg/apache/poi/xssf/usermodel/XSSFRow;}(rn);
    poiCurrentRow.setHeightInPoints(35);

    AddCell(0, poiCurrentSheet, poiCurrentRow, tableCellStyle, string(SQL_ConvTypeStr(sql.value("T_FI_CODE"))),      col1_len );
    AddCell(1, poiCurrentSheet, poiCurrentRow, tableCellStyle, string(SQL_ConvTypeStr(sql.value("T_FIKIND"))),       col2_len );
    AddCell(2, poiCurrentSheet, poiCurrentRow, tableCellStyle, string(SQL_ConvTypeStr(sql.value("T_ISIN"))),         col3_len );
    AddCell(3, poiCurrentSheet, poiCurrentRow, tableCellStyle, string(SQL_ConvTypeStr(sql.value("T_LSIN"))),         col4_len );
    AddCell(4, poiCurrentSheet, poiCurrentRow, tableCellStyle, string(SQL_ConvTypeStr(sql.value("T_NAME"))),         col5_len );
    AddCell(5, poiCurrentSheet, poiCurrentRow, tableCellStyle, string(SQL_ConvTypeStr(sql.value("T_CCY"))),          col6_len );
    AddCell(6, poiCurrentSheet, poiCurrentRow, tableCellStyle, string(SQL_ConvTypeSum(sql.value("T_NOMINAL"))),      col7_len );
    AddCell(7, poiCurrentSheet, poiCurrentRow, tableCellStyle, "  ",                                                 col8_len );
    AddCell(8, poiCurrentSheet, poiCurrentRow, tableCellStyle, string(SQL_ConvTypeSum(sql.value("T_ACCREST"))),      col9_len );
    AddCell(9, poiCurrentSheet, poiCurrentRow, tableCellStyle, string(SQL_ConvTypeSum(sql.value("T_SUMNOMINAL"))),   col10_len);
   
    sumST = sumST + sql.value("T_ACCREST");
    sumAc = sumAC + sql.value("T_ACCREST");   
    sumPT = sumPT + sql.value("T_ACCREST");
    
    rn = rn + 1;
    
    if (sql.value("T_nDepoPartCode") != sql.value("T_DepoPartCode"))
       AddMergedCell(0, 9, rn, jvm, poiCurrentSheet, rightTitleKStyle, "Всего по разделу Депо, штук : " + string(SQL_ConvTypeSum(sumPT)) );
        rn = rn + 1;
       sumPT = 0;
    end;
    if (sql.value("T_nDepoAccCode") != sql.value("T_DepoAccCode"))
       AddMergedCell(0, 9, rn, jvm, poiCurrentSheet, rightTitleKStyle, "Итого по счету депо, штук : " + string(SQL_ConvTypeSum(sumAC)) );
       rn = rn + 1;                             
       sumAC = 0;
    end;
    if (sql.value("T_nStorageID") != sql.value("T_StorageID"))
       AddMergedCell(0, 9, rn, jvm, poiCurrentSheet, rightTitleKStyle, "Итого по месту хранения : " + string(SQL_ConvTypeSum(sumST)) );
       rn = rn + 1;                            
       sumST = 0;
    end;
  
  end;

  poiWorkBook.setSheetName(poiWorkBook.getSheetIndex(poiCurrentSheet), "Выписка"); // ?? 

  var dirPath =  "..\\TxtFile\\";
  var fileName = "Выписка_"+CreateGUID()+".xlsx";
  if (not poiBook.saveAs(dirPath+fileName))
    RunError("Ошибка сохранения файла по пути " + dirPath+fileName);
  end;

  EndAction();
  SC_ShowFile(dirPath, fileName, false);
End;


 macro PnlProc(dlgPanel, cmd, id, key, numScroll)
  var CM_FLAG = CM_DEFAULT;

  if (cmd == DLG_INIT)
   dlgPanel.rec.pDate = {CurDate};
   
  elif(cmd==DLG_KEY)


   if (key ==K_F2)
RepRest(vDepID, vDepoAcc, vDepoPart, dlgPanel.rec.pDate);
exit(1);


     if(err==0)
        msgbox("Выполнено.\n Нажмите ESC для выхода.");
     end;

   
   elif (key ==K_F3)
  if(id == 0)
     repdt = GetDateByCalendar({CurDate});  
     dlgPanel.rec.pDate = repdt;
  elif (id == 2) 
      var col2 = tArray;
      AddCol (col2, 0, "T_ShortNAME",    "Наименование",   50 ,  0,0);
        var sql2 = "SELECT R.T_PARTYID, T.T_SHORTNAME FROM DPARTYOWN_DBT R,DPARTY_DBT T WHERE R.T_PARTYKIND = 4 AND T.T_PARTYID = R.T_PARTYID AND T.T_LOCKED != CHR(88)";
        //var sql2 = "select st.t_storageid, PT.T_ShortNAME  from dscqracc_dbt st, dparty_dbt pt where PT.T_PARTYID = ST.T_STORAGEID group by st.t_storageid, PT.T_ShortNAME";
        var rs2 = RSDrecordset(sql2, rsdval_client, rsdval_static);
    var retval1 =     runScroll(rs2, 1, col2, "Депозитарии", "EvProc2", "", "", true );
        dlgPanel.rec.pDepoAcc = vDepName;
        dlgPanel.rec.pDepo = "";vDepoACC = "";
        dlgPanel.rec.pDepoPart = "";vDepoPart = ""; 
        UpdateFields(dlgPanel);
 


        elif( id == 1 )
        if (valtype(vDepID) == v_undef)
          msgbox("Прежде необходимо выбрать место хранения!");
        else
          var col3 = tArray;
          AddCol (col3, 0, "t_DepoACCCode",    "Счет Депо",   50 ,  0,0);
          var sql3 = "select st.t_DepoACCCode from dscqracc_dbt st where  ST.T_STORAGEID = "+ vDepID + " group by st.t_DepoACCCode";
          var rs3 = RSDrecordset(sql3, rsdval_client, rsdval_static);
          var retval3 =     runScroll(rs3, 1, col3, "Счета ДЕПО", "EvProc3", "", "", true );
          dlgPanel.rec.pDepo = vDepoACC;
          dlgPanel.rec.pDepoPart = "";vDepoPart = "";
          UpdateFields(dlgPanel);
        end;


        elif( id == 3 )
      var col4 = tArray;
        AddCol (col4, 0, "t_DepoPartCode",    "Раздел счета Депо",   50 ,  0,0);
        var sql4 = "select st.t_DepoPartCode from dscqracc_dbt st where  ST.T_STORAGEID = "+ vDepID + " and st.t_DepoAccCode = '" + vDepoAcc + "'  group by st.t_DepoPartCode";
        var rs4 = RSDrecordset(sql4, rsdval_client, rsdval_static);
        var retval4 = runScroll(rs4, 1, col4, "Счета ДЕПО", "EvProc4", "", "", true );
        dlgPanel.rec.pDepoPart = vDepoPart;
        UpdateFields(dlgPanel);
        
        
       end;

   end;
   
  end;
  
  UpdateFields(dlgPanel);
end;

var pnl = tRecHandler("repKDU", "userKDU.lbr", true);
runDialog(pnl, @PnlProc);

//RepRest();
//exit(1);
