import globals;
import InsCarryDoc;
import cb_sql, oralib, likepy, dealsinter, globals, bankinter, payminter, sp_class, rsbformsinter, ptinter;


macro Payment(rs,grnd,rs40817,Acc47422,PaySum, acctrnid:@integer, paymentid:@integer)
      var pmobj = RSBPayment();
      var stat = 0;

      pmobj.DocKind      = rs.value("t_dockind");
      pmobj.DocumentID   = string(rs.value("t_docid"):o:34); //string(rec.m_EnrollID:o:34); //string(77014:o:34); //rec.m_EnrollID
      pmobj.Purpose      = 100;/*Возврат ДС*/
      pmobj.BaseAmount   = PaySum;
      pmobj.PayerAmount  = PaySum;
      pmobj.BaseFIID     = 0;
      pmobj.ReceiverFIID = 0;
      pmobj.PayerFIID    = 0;
      pmobj.ValueDate    = {curdate}; 
      pmobj.PaymStatus   = 3000; //- на отправку. 
      pmobj.Ground       = grnd;
//      pmobj.Number       = rec.m_EnrollID;
      pmobj.PrimDocKind  = DOC_BO_PAYMENT;
//      pmobj.NumberPack   = 11;
//      pmobj.Priority     = 5;
//      pmobj.ShifrOper   = "09";

      //Проверить опера
//      pmobj.Oper = GetMainOperInGroup(pmobj.DocKind);
//      if (pmobj.Oper <= 0)
        pmobj.Oper = {oper};
//      end;

      Pmobj.SetPayerPI(
                  PAYMENTS_GROUP_UNDEF, // Group
                  {OurBank},            // BankID  // Банк плательщика
                  3,                    // BankCodeKind
                  "044525111",          // BankCode
                  "",                   // BankName
                  "",                   // CorrAcc
                  0,                    // AccountFI
                  1,                    // AccountChapter
                  Acc47422.Account,     // Счет плательщика
                  {OurBank},            // ClientID  // Плательщик
                  "",                   // ClientName,
                  {INN_Bank},           // ClientINN,
                  3,                    // ClientCodeKind,
                  "044525111"           // ClientCode
                 );
      var CorrAcc = "";

//      if (ValType(rec.Partyid()) == V_UNDEF) /*Если возврат при отсутствии клиента, то клиента такого создаём*/
//         СоздатьКлиента();
//      end;

         Pmobj.SetReceiverPI(
                     PAYMENTS_GROUP_UNDEF, // Group
                     ПолучитьКодСубъекта(rs40817.value("t_bankcode"),3),         // BankID
                     3,                                                          // BankCodeKind
                     rs40817.value("t_bankcode"),                                // BankCode
                     rs40817.value("t_bankname"),                                // BankName
                     rs40817.value("t_corracc"),                                 // CorrAcc
                     0,                                                          // AccountFI
                     1,                                                          // AccountChapter
                     rs40817.value("t_account")/*"40817810400000013848"*/,       // Account
                     rs.value("t_Partyid"),                                      // ClientID
                     rs.value("t_name"),                                         // ClientName,
                     ПолучитьКодСубъекта(rs.value("t_Partyid"), 16),             // ClientINN,
                     1,                                                          // ClientCodeKind,
                     ПолучитьКодСубъекта(rs.value("t_Partyid"), 1)               // ClientCode
                  );

    
         Pmobj.IsFactPaym   = "X"; //Этот флаг должен бысть установлен уже после добавления схем расчётов. Иначе по платежу не создаётся операция 4001 (или 14001)

         pmobj.BaseRate.Actuate(pmobj.ValueDate, false);
         pmobj.FactRate.Actuate(pmobj.ValueDate, false);
         pmobj.Actuate();
         pmobj.Update();

/*         if(substr(pmobj.futurereceiveraccount,1,5) =="30102")
            Connect_attr_to_paym (pmobj.paymentid, ATTR_GROUP_DOCUMENT_BIS, IIF(pmobj.basefiid == NATCUR,"01","01"));
         else
            Connect_attr_to_paym (pmobj.paymentid, ATTR_GROUP_DOCUMENT_BIS, IIF(pmobj.basefiid == NATCUR,"06o","06"));
         end; 
*/

         if(PM_BOOperation(pmObj) == false)
   //        errmsg = "Ошибка PM_BOOperation";
           stat = 1;
         end;
         if ( not stat )
            var tr = pmobj.MakeTransaction();
            if( tr == NULL )
               msgbox("Ошибка при создании проводки по платежу");
               stat = 1;
            else
     //          tr.AccountReceiver = rs40817.value("t_account");
     //          tr.Number_Pack = pmobj.NumberPack;
               tr.Number_Pack = 10;
               if( not tr.Carry() )
                  msgbox("Ошибка при выполнении проводки");
                  stat = 1;
               end;
            end;
         end;
         acctrnid = tr.acctrnid;
         paymentid = pmobj.PaymentID;
    //println("acctrnid"+acctrnid);
    //println("paymentid"+paymentid);

      return stat;
   //OnError(e);
   //   return 1;
   end;
end; 


