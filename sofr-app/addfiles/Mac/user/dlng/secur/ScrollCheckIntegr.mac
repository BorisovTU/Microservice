/*
$Name:           scrollcheckintegr.mac
$Module:         интеграция
$Description:    просмотр лога миграции
*/

/*BPV просмотр лога миграции*/
import RSD, globals, cb_sql;

const K_ENTER   = 13;
//const K_ESC     = 27;
const K_F3      = 317;
const K_F2      = 316;
const K_F8      = 322;
const K_F9      = 323;

const GR_ACCBO = 1; 
const GR_ACCBU = 2;
const GR_ACCIN = 3;
const GR_ACCDU = 4;

PRIVATE MACRO AddCol (ar,ind, fld, head, width, rdonly, ty, dp)
   ar.value (ind * 6)     = fld;
   ar.value (ind * 6 + 1) = head;
   ar.value (ind * 6 + 2) = width;
   ar.value (ind * 6 + 3 ) = rdonly;   // fldType
   ar.value (ind * 6 + 4 ) = dp;//   decPoint
   ar.value (ind * 6 + 5 ) = 0;   // reserv
END;

var shift = 0, kind = 0, logid = -1;

private macro iif(cond,res1,res2)
   if (cond)
      return res1;
   else
      return res2;
   end;
end;

private macro CheckGr(p_gracc, p_needgroup)
var sql = "";
if (p_needgroup)
   sql = 
"  SELECT d.t_plandate dealdate                              ";
else
   sql = 
"  SELECT d.t_plandate dealdate                              ";
end;

"  SELECT d.t_plandate dealdate,                              "
"         t_dealcode,                                         "
"         t.t_pfi fiid,                                       " +
"         (SELECT t_avoirkind                                 "
"            FROM dfininstr_dbt                               "
"           WHERE t_fiid = t.t_pfi)                           "
"            avrkind                                          " +
"    FROM ddlgrdeal_dbt d, ddlgracc_dbt ac, ddl_tick_dbt t    "
"   WHERE     d.t_dockind IN (101, 127, 117)                  "
"         AND d.t_docid = t.t_dealid                          "
"         AND d.t_dockind = t.t_bofficekind                   " +
"         AND d.t_id = ac.t_grdealid                          "
"         AND AC.T_ACCNUM = " + p_gracc + "                   "
"         AND T.T_DEALSTATUS = 10                             " 
"         AND t_clientid = -1                                 "
"         AND ac.t_state = 1                                  " +
" ORDER BY d.t_plandate                                       "
" group by d.t_plandate order by d.t_plandate       " ; 

 
 
end;

 
macro Scroll
   var cmd1, rs1, col1, need = true,Column = TArray(),i, ColumnValue, ColumnName, NumColumns = 0, cond = "";
   var bottom_txt = "";
   var sql_ready =" and t_userfield4 = chr(1) ", sql_ready_f = false;
   var f_date_carry = {curdate}, sql_date_carry =" and t_date_carry = "+getsqldate({curdate}), sql_date_carry_f = true;
   var f_number_pack = "10,0,45,55", sql_number_pack =" and t_number_pack in ("+f_number_pack+")", sql_number_pack_f = true;
   var f_number_pack2 = "18,46,50,998,994", sql_number_pack2 =" and t_number_pack not in ("+f_number_pack2+")", sql_number_pack2_f = true;
   var f_number_pack_exclude = "10", sql_number_pack_exclude =sql_number_pack_exclude, sql_number_pack_exclude_f = false;
   var choice = 0, ar_menu = TArray();

   macro EvProc2(rs, cmd, id, key)
     var  CM_DEFAULT = null;
     if ((cmd == DLG_KEY)and(key == K_ENTER))
        if (rs.RecCount > 0)
          return CM_SELECT;
        end;
     end;
     return CM_DEFAULT;
  end;

   macro EvProc(rs, cmd, id, key)
     var  CM_DEFAULT = null;
//msgbox(key);
     if ((cmd == DLG_KEY)and(key == K_ENTER))
       /* if (rs.RecCount > 0)
          return CM_SELECT;
        end;*/
        if (rs.Value("t_status") == "Ошибка")
                   var ssql =   "  select resultcode, err, id_num, t_sysdate, t_systime                                                                                                  "            
                                "    from                                                                                                                                                " 
                                "    (    SELECT  DBMS_LOB.SUBSTR (t_message, (DBMS_LOB.INSTR (t_message, '&' || 'lt;/ResultCode' || '&' || 'gt;')                                       " 
                                "                                                                    - DBMS_LOB.INSTR (t_message, '&' || 'lt;ResultCode' || '&' || 'gt;')                "+ 
                                "                                                                    - LENGTH ( '&' || 'lt;ResultCode' || '&' || 'gt;')),                                " 
                                "                                                                 (DBMS_LOB.INSTR (t_message, '&' || 'lt;ResultCode' || '&' || 'gt;')                    " 
                                "                                                                  + LENGTH ( '&' || 'lt;ResultCode' || '&' || 'gt;'))) resultcode,                      " 
                                "                DBMS_LOB.SUBSTR (t_message, (DBMS_LOB.INSTR (t_message, '&' ||'lt;/ErrorDesc' || '&' || 'gt;')                                          " 
                                "                                                                   - DBMS_LOB.INSTR (t_message,  '&' || 'lt;ErrorDesc' || '&' || 'gt;')                 "+ 
                                "                                                                  - LENGTH ( '&' || 'lt;ErrorDesc' || '&' || 'gt;')),                                   " 
                                "                                                                 (DBMS_LOB.INSTR (t_message, '&' || 'lt;ErrorDesc' || '&' || 'gt;')                     " 
                                "                                                                  + LENGTH ( '&' || 'lt;ErrorDesc' || '&' || 'gt;'))) err,                              " 
                                "                DBMS_LOB.SUBSTR (t_message,  (DBMS_LOB.INSTR (t_message,  '&' || 'lt;/DocumentNumberInSOFR' || '&' || 'gt;')                            " 
                                "                                                                    - DBMS_LOB.INSTR (t_message, '&'  || 'lt;DocumentNumberInSOFR'  || '&' || 'gt;')    " 
                                "                                                                    - LENGTH ( '&' || 'lt;DocumentNumberInSOFR' || '&'  || 'gt;')),                     "+ 
                                "                                                                    (DBMS_LOB.INSTR (t_message, '&' || 'lt;DocumentNumberInSOFR' || '&' || 'gt;')       " 
                                "                                                                    + LENGTH ( '&' || 'lt;DocumentNumberInSOFR' || '&' || 'gt;'))) id_num,              " 
                                "                                          t_sysdate,                                                                                                    " 
                                "                                          t_systime                                                                                                     " 
                                "      FROM dqueue_log_dbt ww                                                                                                                            " 
                                "     WHERE 1=1                                                                                                                                          "+ 
                                "         and t_qname = 'ESB_TO_SOFR'                                                                                                                    " 
                                "         and ww.t_sysdate > TRUNC ("+GetSQlDate(rs.value("t_date_carry"))+")                                                                                         " 
                                "         and t_message like '%AddAccountingEntries_v3%' )                                                                                               " 
                                "         where id_num = '"+rs.value("t_acctrnid")+"'  and resultcode = 1                                                                                                                        " 
                                 ;
         var ddt= TRsbDataSet(ssql);
         begaction();
         if (ddt.movenext())
            endaction;
            msgbox(ddt.Value("err"));
         else
            msgbox("Не удалось получить сообщение об ошибке");
         end;
            endaction;
      else
        msgbox(rs.Value("t_ground"));
      end;

      elif ((cmd == DLG_KEY)and(key == K_F3))
         ar_menu = TArray();
         ar_menu(ar_menu.size) = "Показывать выгруженные \t" + iif(sql_ready_f,"ON","OFF");
         ar_menu(ar_menu.size) = "Дата проводки \t" + iif(f_date_carry != date(0,0,0), f_date_carry," ");
         ar_menu(ar_menu.size) = "Номера пачек \t" + iif(sql_number_pack_f, f_number_pack," ");
         ar_menu(ar_menu.size) = "Номера пачек искл \t" + iif(sql_number_pack2_f, f_number_pack2," ");
  //       ar_menu(ar_menu.size) = "Исключить номера пачек \t" + iif(sql_number_pack_exclude_f, "ON","OFF");
         choice = menu(ar_menu);
         if (choice == 0)
            sql_ready = iif(sql_ready_f," and t_userfield4 = chr(1) "," and t_userfield4 <> chr(1) ");
            sql_ready_f = (not sql_ready_f);
         elif (choice == 1)
            f_date_carry = {curdate};
            if (not GetDate(f_date_carry,"Дата проводок"))
               f_date_carry = date(0,0,0);
               sql_date_carry_f = false;
            elif (f_date_carry == date(0,0,0))
               sql_date_carry_f = false;
            else
               sql_date_carry_f = true;
            end;
            sql_date_carry = iif(sql_date_carry_f," and t_date_carry = "+getsqldate(f_date_carry), " ");
            sql_date_carry_f = iif(f_date_carry == date(0,0,0), false, true );
         elif (choice == 2)
            if (not GetString(f_number_pack,"Номера пачек"))
               f_number_pack = "";
               sql_number_pack_f = false;
            elif (f_number_pack == "")
               sql_number_pack_f = false;
            else
               sql_number_pack_f = true;
            end;
            sql_number_pack = iif(sql_number_pack_f, " and t_number_pack in ("+f_number_pack+")", " ");
         elif (choice == 3)
            if (not GetString(f_number_pack2,"Номера пачек искл"))
               f_number_pack2 = "";
               sql_number_pack2_f = false;
            elif (f_number_pack2 == "")
               sql_number_pack2_f = false;
            else
               sql_number_pack2_f = true;
            end;
            sql_number_pack2 = iif(sql_number_pack2_f, " and t_number_pack not in ("+f_number_pack2+")", " ");

/*         elif (choice == 3)
            sql_number_pack = iif(sql_number_pack_exclude_f,StrSubst(sql_number_pack,"t_number_pack not in", "t_number_pack in"),StrSubst(sql_number_pack,"t_number_pack in", "t_number_pack not in"));
            sql_number_pack_exclude_f = (not sql_number_pack_exclude_f);
*/
         end;
         bottom_txt = 
         iif (sql_ready_f,"Выгруженные. ","Невыгруженные. ") + 
         iif (f_date_carry != date(0,0,0),f_date_carry,"За все время. ") + 
         iif (sql_number_pack_f,"Пачки:" + f_number_pack,"все") +  
         iif (sql_number_pack2_f,"Пачки искл:" + f_number_pack2,"все"); 
         need = true;
         return 2;
/*      elif ((cmd == DLG_KEY)and(key == K_F8))
         if (kind == 3) kind = -1; else kind = kind + 1; end;
         if (kind == -1) cond = ""; 
         else  cond = " and t_kind = " + kind; 
         end;
         if (logid > -1) cond = cond + " and t_kind = " + kind; end;
         need = true;
         return 2;
      elif ((cmd == DLG_KEY)and(key == K_F9))
         cond = "";
         need = true;
         return 2;*/
      elif ((cmd == DLG_KEY)and(key == 18))
         cond = "";
         need = true;
         return 2;
/*      elif ((cmd == DLG_KEY)and(key == K_F2))
            var retval, cmd2 = " select to_char(t_logid) t_logid,t_objecttype from ( select t_logid, t_objecttype from user_cnvhlplogex where t_logid is not null group by t_logid,t_objecttype order by t_logid desc) ";
            cmd2 = RSDCommand(cmd2);
            var rs2 = RSDRecordset(cmd2 , null, RSDVAL_STATIC );

            if (RunScroll (rs2,2,null,"","EvProc2"))
               logid = rs2.value(0);
               shift = 0;
               cond = " and t_logid = " + logid;
            else
                cond = "";
            end;
         need = true;
         return 2;
  */
      elif ((cmd == DLG_KEY)and(key == K_ESC))
         return 2;
      end;

     return CM_DEFAULT;
   end;

   col1 = TArray;   
   var arnum = -1;
   AddCol (col1, arnum=arnum+1, "T_acctrnid",     "trnid",   5 ,  0,0);
   AddCol (col1, arnum=arnum+1, "T_type",     "Тип ",   5 ,  0,0);
   AddCol (col1, arnum=arnum+1, "T_status",     "Статус",  10 ,  0,0);
   AddCol (col1, arnum=arnum+1, "T_date_carry",     "Дата",   8 ,  0,0);
   AddCol (col1, arnum=arnum+1, "T_numb_document",  "Номер",  8  ,  0,0);
   AddCol (col1, arnum=arnum+1, "T_account_payer",  "Счет плательщица",    17, 0);
   AddCol (col1, arnum=arnum+1, "T_account_receiver","Счет получателя",    17, 0);
   AddCol (col1, arnum=arnum+1, "T_sum_payer",      "Сумма дебета",    15, 0);
   AddCol (col1, arnum=arnum+1, "T_fiid_payer",     "ФИ дебета",    4, 0);
   AddCol (col1, arnum=arnum+1, "T_sum_receiver",   "Сумма кредита",    15, 0);
   AddCol (col1, arnum=arnum+1, "T_fiid_receiver",  "ФИ кредита",    4, 0);
   AddCol (col1, arnum=arnum+1, "T_ground",         "Основание",    50, 0);
   AddCol (col1, arnum=arnum+1, "T_number_pack",    "Номер пачки",    10, 0);
   AddCol (col1, arnum=arnum+1, "T_result_carry",     "RC",    5, 0);
   AddCol (col1, arnum=arnum+1, "T_userfield2",     "UF2",    3, 0);
   AddCol (col1, arnum=arnum+1, "T_userfield3",     "UF3",    3, 0);
   AddCol (col1, arnum=arnum+1, "T_userfield4",     "BIS",    5, 0);
   AddCol (col1, arnum=arnum+1, "T_oper",     "oper",    5, 0);
   AddCol (col1, arnum=arnum+1, "T_opername",     "opername",    15, 0);

   while (need)
         bottom_txt = 
         iif (sql_ready_f,"Выгруженные. ","Невыгруженные. ") + 
         iif (f_date_carry != date(0,0,0),f_date_carry," За все время.") + 
         iif (sql_number_pack_f," Пачки:" + f_number_pack," все") + 
         iif (sql_number_pack2_f," Пачки искл:" + f_number_pack2," все");   

      need = false;
var sql_ =  
" select  " + 
" acctrn.t_oper,t_acctrnid, decode(t_type, 1,'Вставка',2,'Обновление',3,'Удаление',' ') t_type, " +
" nvl(decode(t_status,45,'Проводка удалена',450,'Проводка отсутствует',400,'Была выгружена ранее',11,'Ожидание ручной обработки', " +
" 1,'Готов к обработке',2,'Обрабатывается',4,'Успешно выгружено',-45,'Проводка удалена',5,'Ошибка',-1420,'Не выгружать',t_status),'Не будет выгружено') t_status,             " +
" t_userfield2, t_userfield3, t_userfield4, t_date_carry, t_numb_document, t_account_payer, t_account_receiver, t_sum_payer, " +
" (select p.t_name from dperson_dbt p where p.t_oper = acctrn.t_oper) t_opername, " +
"  decode(t_fiid_payer,0,'RUB',7,'USD',8,'EUR',t_fiid_payer) t_fiid_payer,t_sum_receiver, decode(t_fiid_receiver,0,'RUB',7,'USD',8,'EUR',t_fiid_receiver) t_fiid_receiver, t_ground, t_number_pack , t_result_carry from "
"       dacctrn_dbt acctrn left join utableprocessevent_dbt on t_objecttype = 1 and t_objectid = t_acctrnid where " 
"       t_chapter in (1,3,4)                                                                                                                                                    " 
"       and t_state = 1                                                                                                                                                            ";
//"       and t_result_carry not in (18, 46 /*,82*//*?*/)                                                                                                                            "
//"       and t_date_carry = to_date ('140119','ddmmyy')                                                                                                                             "
//"       and t_number_pack not in (55, 40)                                                                                                                                          " +
//"       and t_oper <> 1019                                                                                                                                                         "
//"       and t_ground not like '%SPT%'                                                                                                                                              "
//"       and t_ground not like '% МБК%'                                                                                                                                             "
//"       and t_ground not like 'Курсовая разница от переоценки требования сделки%'                                                                                                  " +
//"       and t_ground not like 'Списание переоценки требования%'                                                                                                                    "
//"       and t_ground not like 'Перенос%по%сделк%'                                                                                                                                  "
//"       and t_ground not like 'Списание%по%сделк%'                                                                                                                                 "
//"       and t_ground not like '%ПФИ%'                                                                                                                                              ";
//"       and t_userfield2 <> '1'                                                                                                                                           " +
//"       and t_account_receiver not like '301%'                                                                                                                                     " ;
sql_ = sql_
 + sql_ready 
 + sql_date_carry
 + sql_number_pack
 + sql_number_pack2; 
sql_ = sql_ + " order by t_date_carry, t_number_pack ";
      cmd1 = RSDCommand(sql_);
      rs1 = RSDRecordset(cmd1 , null, RSDVAL_STATIC );


      if (RunScroll (rs1,arnum+1, col1, "test" ,"EvProc"," Проводки к выгрузке.  " + sql_GetNRecs(sql_) + "шт.", "F3 - Фильтр:  " + bottom_txt , true, 1, 1))
       //   return rs1;
      end;
   end;

return null;

end;

Scroll;
exit(1);