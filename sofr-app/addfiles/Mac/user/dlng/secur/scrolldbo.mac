import globals, rsd, likepy;
var cmdDBO, rsDBO;

var crid;

/*Скроллинг ДБО*/
macro ScrollDBO(dt1, dt2, client, ClDog)
  /*Обработчик скроллинга*/
  macro Contr_Scroll(rs, cmd, id, key)
    /*Обработчик*/
    if(cmd == DLG_KEY)
      /*Enter*/
      if(key == 13)
        return CM_IGNORE;
      /*Esc*/
      elif(key == 27)

        var cnt = 0;
        crid = Tarray;
        cmdDBO = RsdCommand("select * from dset_sfc_u_tmp where t_setflag = chr(88)");
        rsDBO = RSDRecordset(cmdDBO, RSDVAL_CLIENT, RSDVAL_STATIC);

 if (client == 1)

        while(rsDBO.movenext())
            crid.Value(cnt,0)  = rsDBO.value("t_clientid");
            cnt = cnt + 1;
        end;

        if(cnt == 0)
          msgboxex("Нет данных для отправки");
        end;
 else

        while(rsDBO.movenext())
            crid.Value(cnt,0)  = rsDBO.value("t_contrid");
            cnt = cnt + 1;
        end;

        if(cnt == 0)
          msgboxex("Нет данных для отправки");
        end;

 end;
        return CM_CANCEL;
      /*Space*/
      elif(key == 32)
        if(rs.RecCount > 0)
          rs.edit();
          if(rs.value("t_setflag") == "X")
            rs.value("t_setflag") = " ";
          else                                                                                         
            rs.value("t_setflag") = "X";
          end;
          rs.update();

          updatescroll(rs, 5);
          return CM_IGNORE;
        end;
      end;
    end;
  end;

  var cmd, que, rs;
  cmd = RsdCommand("delete from dset_sfc_u_tmp");
  cmd.Execute();

 if (client == 1)

  cmd = RsdCommand("insert into dset_sfc_u_tmp "
                 + "select distinct chr(0), party.t_partyid, party.t_name, '', '', '', ''  "
                 + "from ddlcontr_dbt dlcontr "
                 + "join dsfcontr_dbt sfcontr on sfcontr.t_id = dlcontr.t_sfcontrid and "
                 + "                             sfcontr.t_department = ? and "
                 + "                             sfcontr.t_datebegin >= ? and "
                 + "                             sfcontr.t_datebegin <= ? and "
                 + "                             sfcontr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') "
                 + "join dparty_dbt party on party.t_partyid = sfcontr.t_partyid");
  cmd.AddParam("department", RSDBP_IN, {operdprt});
  cmd.AddParam("dt1", RSDBP_IN, dt1);
  cmd.AddParam("dt2", RSDBP_IN, dt2);
  cmd.Execute();

  que = "select t_setflag, t_clientname "
      + "from dset_sfc_u_tmp "
      + "order by t_clientname";

  cmd = RsdCommand(que);

  rs = RSDRecordset(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);                                                             


  while(RunScroll(rs, 2, MakeArray("t_setflag", "В", 1, 2, -1, 0,  
                                   "t_clientname", "Наименование клиента", 40, 2, -1, 0), 
                  null, "Contr_Scroll", "Договоры брокерского обслуживания", "~Esc~ Выход ~Пробел~ Изменить", false))
    cmd = RsdCommand(que);
    rs = RSDRecordset(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);
  end;

  else

  if (ClDog == "")

  cmd = RsdCommand("insert into dset_sfc_u_tmp "
                 + "select chr(0), party.t_partyid, party.t_name, dlcontr.t_dlcontrid, sfcontr.t_number, sfcontr.t_name, sfcontr.t_datebegin "
                 + "from ddlcontr_dbt dlcontr "
                 + "join dsfcontr_dbt sfcontr on sfcontr.t_id = dlcontr.t_sfcontrid and "
                 + "                             sfcontr.t_department = ? and "
                 + "                             sfcontr.t_datebegin >= ? and "
                 + "                             sfcontr.t_datebegin <= ? and "
                 + "                             sfcontr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') "
                 + "join dparty_dbt party on party.t_partyid = sfcontr.t_partyid");

  cmd.AddParam("department", RSDBP_IN, {operdprt});
  cmd.AddParam("dt1", RSDBP_IN, dt1);
  cmd.AddParam("dt2", RSDBP_IN, dt2);
  cmd.Execute();

  que = "select t_setflag, t_clientname, t_contrnumber, t_contrname, t_contrdate "
      + "from dset_sfc_u_tmp "
      + "order by t_clientname, t_contrnumber";
  cmd = RsdCommand(que);

  rs = RSDRecordset(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);                                                             
 
  while(RunScroll(rs, 5, MakeArray("t_setflag", "В", 1, 2, -1, 0,  
                                   "t_clientname", "Наименование клиента", 40, 2, -1, 0, 
                                   "t_contrnumber", "Номер ДБО", 20, 2, -1, 0, 
                                   "t_contrname", "Наименование ДБО", 40, 2, -1, 0, 
                                   "t_contrdate", "Дата ДБО", 10, 2, -1, 0), 
                  null, "Contr_Scroll", "Договоры брокерского обслуживания", "~Esc~ Выход ~Пробел~ Изменить", false))
    cmd = RsdCommand(que);
    rs = RSDRecordset(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);
  end;

  else

  cmd = RsdCommand("insert into dset_sfc_u_tmp "
                 + "select chr(0), party.t_partyid, party.t_name, dlcontr.t_dlcontrid, sfcontr.t_number, sfcontr.t_name, sfcontr.t_datebegin "
                 + "from ddlcontr_dbt dlcontr "
                 + "join dsfcontr_dbt sfcontr on sfcontr.t_id = dlcontr.t_sfcontrid and "
                 + "                             sfcontr.t_department = ? and "
                 + "                             sfcontr.t_datebegin >= ? and "
                 + "                             sfcontr.t_datebegin <= ? and "
                 + "                             sfcontr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') "
                 + "join dparty_dbt party on party.t_partyid = sfcontr.t_partyid where party.t_partyid in (" + ClDog + ")");
  cmd.AddParam("department", RSDBP_IN, {operdprt});
  cmd.AddParam("dt1", RSDBP_IN, dt1);
  cmd.AddParam("dt2", RSDBP_IN, dt2);
  cmd.Execute();

  que = "select t_setflag, t_clientname, t_contrnumber, t_contrname, t_contrdate "
      + "from dset_sfc_u_tmp "
      + "order by t_clientname, t_contrnumber";
  cmd = RsdCommand(que);

  rs = RSDRecordset(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);                                                             


  while(RunScroll(rs, 5, MakeArray("t_setflag", "В", 1, 2, -1, 0,  
                                   "t_clientname", "Наименование клиента", 40, 2, -1, 0, 
                                   "t_contrnumber", "Номер ДБО", 20, 2, -1, 0, 
                                   "t_contrname", "Наименование ДБО", 40, 2, -1, 0, 
                                   "t_contrdate", "Дата ДБО", 10, 2, -1, 0), 
                  null, "Contr_Scroll", "Договоры брокерского обслуживания", "~Esc~ Выход ~Пробел~ Изменить", false))
    cmd = RsdCommand(que);
    rs = RSDRecordset(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);
  end;
 end;
 end;
end;

/*Точка входа*/
//ScrollDBO({curdate});
//exit(1);