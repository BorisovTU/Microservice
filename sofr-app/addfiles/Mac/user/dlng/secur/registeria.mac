/*
$Name:        registeria.mac
$Module:      БО ЦБ
$Description: РеестрВУ
*/

import BankInter, registeria_panel, ReportUser;
import captureoutput;
private const MAXROWSHEET = 1000000;/*GAA:499568 из-за невозможности задать значение константы в or_set_h.mac (т.к. "ломаются" налоговые регистры), установим значение константы для конкретного отчета*/

PRIVATE CLASS (TX_ReportUser) registeria_Report
  var m_BeginDate, m_End_Date;

  /*Создание отчета*/
  PRIVATE MACRO Create()

    /*Остаток ЦБ по договору клиента*/
    macro GetRestP(clientid, contrid, pfi, dt, inrest)
      var cmd_Rest, RS_Rest;
      /*Тип остатка*/
      if(inrest)
        dt = dt - 1;
      end;
      /*Определяем исходящий остаток*/
      StartCaptureOutput();
      [
        select t_amount
        from dpmwrtcl_dbt pmwrtcl
        where pmwrtcl.t_department = ########## and
              pmwrtcl.t_party = ? and
              pmwrtcl.t_contract = ? and
              pmwrtcl.t_fiid = ? and
              pmwrtcl.t_begdate <= ? and
              pmwrtcl.t_enddate >= ?

      ]({operdprt});
      cmd_Rest = RsdCommand(EndCaptureOutput());
      cmd_Rest.AddParam("clientid", RSDBP_IN, clientid);
      cmd_Rest.AddParam("contrid", RSDBP_IN, contrid);
      cmd_Rest.AddParam("pfi", RSDBP_IN, pfi);
      cmd_Rest.AddParam("dt1", RSDBP_IN, dt);
      cmd_Rest.AddParam("dt2", RSDBP_IN, dt);
      cmd_Rest.Execute();
      RS_Rest = TRsbDataSet(cmd_Rest);
      if(RS_Rest.movenext)
        return RS_Rest.value("t_amount");
      else
        return 0;
      end;
    end;

    /*Остаток собственных ЦБ*/
    macro GetRestBankP(pfi, dt, inrest)
      var cmd_Rest, RS_Rest;
      /*Тип остатка*/
      if(inrest)
        dt = dt - 1;
      end;
      /*Определяем исходящий остаток*/
      StartCaptureOutput();
/*
      [
        select nvl(sum(t_amount),0) t_amount
        from (select scwrthistex.t_amount,
                     scwrthistex.t_state,
                     scwrthistex.t_changedate,
                     max(scwrthistex.t_changedate) over(partition by scwrthistex.t_sumid, scwrthistex.t_fiid) t_maxchangedate,
                     scwrthistex.t_instance,  
                     max(scwrthistex.t_instance) over(partition by scwrthistex.t_sumid, scwrthistex.t_fiid, scwrthistex.t_changedate) t_maxinstance
              from v_scwrthistex scwrthistex
              where scwrthistex.t_party = -1 and
                    scwrthistex.t_fiid = ? and
                    scwrthistex.t_changedate <= ?)
        where t_changedate = t_maxchangedate and
              t_instance = t_maxinstance and
              t_state in (1,3)
      ];
*/
/*10.09.2020 RAS 505307*/
      /*[
        select nvl(sum(t_amount),0) t_amount
          from (select scwrthistex.t_amount,
                       scwrthistex.t_state,
                       scwrthistex.t_changedate,
                       max(scwrthistex.t_changedate) over(partition by scwrthistex.t_sumid, scwrthistex.t_fiid) t_maxchangedate,
                       scwrthistex.t_instance,
                       max(scwrthistex.t_instance) over(partition by scwrthistex.t_sumid, scwrthistex.t_fiid, scwrthistex.t_changedate) t_maxinstance
                  from(
                        (SELECT t_amount, t_state, t_changedate, t_instance, t_sumid, t_fiid, t_party
                           FROM
                           (  SELECT BC.T_AMOUNT          ,
                                     BC.T_STATE           ,
                                     BC.T_CHANGEDATE      ,
                                     BC.T_INSTANCE        ,
                                     BC.t_SumID           ,
                                     BC.T_FIID            ,
                                     Lot.t_party
                                FROM DPMWRTSUM_DBT Lot, DPMWRTBC_DBT BC
                               WHERE BC.t_SumID   = Lot.t_SumID
                                 AND BC.t_state in (1, 3)
                                 AND Lot.t_party = -1
                                 AND BC.T_FIID = ?
                                 AND BC.t_changedate <= ?
                                 AND lot.t_portfolio !=0
                                 AND BC.t_state IN (1, 3)
                                 AND bc.t_instance =
                                        (SELECT MAX (t_instance)
                                           FROM DPMWRTBC_DBT bc2
                                          WHERE     bc2.t_sumid = bc.t_sumid
                                                AND bc2.T_FIID = :fid
                                                AND BC2.t_state IN (1, 3)
                                                 AND bc2.t_portfolio !=0
                                                AND BC2.t_changedate <= :dd)
                           )
                        ) UNION ALL
                        (SELECT t_amount, t_state, t_changedate, t_instance, t_sumid, t_fiid, t_party
                           FROM DPMWRTSUM_DBT
                          WHERE t_party = -1
                            and t_fiid = ?
                            and t_changedate <= ?
                            and t_state in (1, 3))
                      ) scwrthistex
                   )
         where t_changedate = t_maxchangedate
           and t_instance = t_maxinstance
           and t_state in (1, 3)
      ];*/
      [
        select NVL(rsb_pmwrtoff.WRTGetPortfolioAmount(1, ?, -1, 0, -1, -1, ?, 1,0,1 ), 0) t_amount from dual
      ];
      /*~RAS*/
      
      cmd_Rest = RsdCommand(EndCaptureOutput());
      cmd_Rest.AddParam("pfi1", RSDBP_IN, pfi);
      cmd_Rest.AddParam("dt1", RSDBP_IN, dt);
      //cmd_Rest.AddParam("pfi2", RSDBP_IN, pfi); 10.09.2020 RAS 505307
      //cmd_Rest.AddParam("dt2", RSDBP_IN, dt); 10.09.2020 RAS 505307
      cmd_Rest.Execute();
      RS_Rest = TRsbDataSet(cmd_Rest);
      if(RS_Rest.movenext)
        return RS_Rest.value("t_amount");
      else
        return 0;
      end;
    end;

    /*Остаток ДС по договору клиента в разрезе валют*/
    macro GetRestM(clientid, contrid, fiid, dt, inrest)
      var cmd_Rest, RS_Rest;
      /*Тип остатка*/
      if(inrest)
        dt = dt - 1;
      end;
      /*Определяем исходящий остаток*/
      StartCaptureOutput();
      [
        select nvl(sum(rsb_account.restall(acc.t_account, acc.t_chapter, acc.t_code_currency, edt)),0) t_rest
        from dsfssi_dbt ssi
        join (select ? sfcontrid, ? fiid, ? edt from dual) on 1=1
        join dsettacc_dbt sa on sa.t_SettAccID = ssi.t_SetAccID and
                                sa.t_fiid = fiid and
                                sa.t_chapter = 1
        join daccount_dbt acc on acc.t_Account = sa.t_Account and
                          acc.t_Chapter = sa.t_Chapter and
                          acc.t_Code_Currency = sa.t_FIID
        join dsfcontr_dbt sfcontr on sfcontr.t_id = sfcontrid
        where ssi.t_ObjectType = 659/*cnst.OBJTYPE_SFCONTR*/ and
              ssi.t_ObjectID = sfcontr.t_id and
              ssi.t_FIKind = 1/*rsi_rsb_fiinstr.FIKIND_CURRENCY*/
      ];
      cmd_Rest = RsdCommand(EndCaptureOutput());
      cmd_Rest.AddParam("contrid", RSDBP_IN, contrid);
      cmd_Rest.AddParam("fiid", RSDBP_IN, fiid);
      cmd_Rest.AddParam("dt", RSDBP_IN, dt);
      cmd_Rest.Execute();
      RS_Rest = TRsbDataSet(cmd_Rest);
      if(RS_Rest.movenext)
        return money(RS_Rest.value("t_rest"));
      else
        return 0;
      end;
    end;

    /*Получить остатки ценых бумаг по договору клиента для сделки*/
    macro GetRestsP(clientid, contrid, pfi, dealid, dealdate, dealtime, dealpart, RestP_Fact:@double, RestP_Plan:@double)
      var cmd_Turn, RS_Turn;
      /*Берем входящие остатки*/
      RestP_Fact = GetRestP(clientid, contrid, pfi, dealdate, true/*входящий*/);
      RestP_Plan = RestP_Fact;
      /*Учитываеим изменения в составе сделок по текущую включительно*/
      StartCaptureOutput();
      [
        select t_factplandate, 
               sum(case when t_kind = 1 /*DLRQ_KIND_COMMIT*/ then -t_amount else t_amount end) t_amount
        from(select dealdt, 
                    dlrq.t_kind, 
                    case when dlrq.t_factdate = to_date('01.01.0001','dd.mm.yyyy') then dlrq.t_plandate 
                         else dlrq.t_factdate 
                    end t_factplandate, 
                    dlrq.t_amount  
             from ddl_tick_dbt dl_tick
             join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dl_tick.t_dealtype and
                                            -- Покупка/Продажа
                                            regexp_like(oprkoper.t_systypes, '[B|S|Z]')
             join (select ? clientid, 
                          ? clientcontrid, 
                          ? pfi, 
                          ? dealdt, 
                          ? dealtm, 
                          ? dealpart,
                          ? dealid from dual) on 1=1
             join ddl_leg_dbt dl_leg on dl_leg.t_dealid = dl_tick.t_dealid and 
                                        dl_leg.t_legid = 0 and 
                                        dl_leg.t_legkind in (0,2)
             join ddlrq_dbt dlrq on dlrq.t_dockind = dl_tick.t_bofficekind and
                                    dlrq.t_docid = dl_tick.t_dealid and 
                                    dlrq.t_dealpart = decode(dl_leg.t_legkind, 0, 1, 2) and
                                    dlrq.t_state != 7 /*отменено GAA:496245*/ and  
                                    dlrq.t_subkind = 1 /*DLRQ_SUBKIND_AVOIRISS*/ and
                                    (dlrq.t_kind = 0 /*DLRQ_KIND_REQUEST*/ or dlrq.t_kind = 1 /*DLRQ_KIND_COMMIT*/) and
                                    case when dlrq.t_factdate = to_date('01.01.0001','dd.mm.yyyy') then dlrq.t_plandate 
                                         else dlrq.t_factdate 
                                    end >= dealdt
             where dl_tick.t_bofficekind in (###,###,####) and
                   dl_tick.t_clientid = clientid and
                   dl_tick.t_clientcontrid = clientcontrid and
                   dl_tick.t_pfi = pfi and
                   ((dl_tick.t_dealdate < dealdt) or 
                    (dl_tick.t_dealdate = dealdt and dl_tick.t_dealtime < dealtm) or
                    (dl_tick.t_dealdate = dealdt and dl_tick.t_dealtime = dealtm and dl_tick.t_dealid < dealid) or
                    (dl_tick.t_dealdate = dealdt and dl_tick.t_dealtime = dealtm and dl_tick.t_dealid = dealid and dlrq.t_dealpart <= dealpart)))
        group by t_factplandate
      ](101,117,127);
      cmd_Turn = RsdCommand(EndCaptureOutput());
      cmd_Turn.AddParam("clientid", RSDBP_IN, clientid);
      cmd_Turn.AddParam("contrid", RSDBP_IN, contrid);
      cmd_Turn.AddParam("pfi", RSDBP_IN, pfi);
      cmd_Turn.AddParam("dealdate", RSDBP_IN, dealdate);
      cmd_Turn.AddParam("dealtime", RSDBP_IN, dealtime);
      cmd_Turn.AddParam("dealpart", RSDBP_IN, dealpart);
      cmd_Turn.AddParam("dealid", RSDBP_IN, dealid);
      cmd_Turn.Execute();
      RS_Turn = TRsbDataSet(cmd_Turn);
      while(RS_Turn.movenext)
        RestP_Plan = RestP_Plan + RS_Turn.value("t_amount");
        if(RS_Turn.value("t_factplandate") == dealdate)
          RestP_Fact = RestP_Fact + RS_Turn.value("t_amount");
        end;
      end;
    end;

    /*Получить остатки собственных ценых бумаг для сделки*/
    macro GetRestsBankP(pfi, dealid, dealdate, dealtime, dealpart, RestP_Fact:@double, RestP_Plan:@double)
      var cmd_Turn, RS_Turn;
      /*Берем входящие остатки*/
/*GAA:496247  получить дату поставки ц/б по части сделки*/
      var daterq = date(0,0,0);
      var timereq = time(0,0,0);
      var factdaterq = date(0,0,0);
      var sql_txt = "SELECT CASE WHEN dlrq.t_factdate = TO_DATE ('01.01.0001', 'dd.mm.yyyy') THEN dlrq.t_plandate ELSE dlrq.t_factdate END  Date_Rq," +
                    "     dlrq.t_factdate  fact_date_rq,                           " +
                    "     DL_LEG.T_SUPPLYTIME time_req                             " +
                    "   FROM ddl_tick_dbt dl_tick                                  " +
                    "     JOIN ddl_leg_dbt dl_leg                                  " +
                    "     ON     dl_leg.t_dealid = dl_tick.t_dealid                " +
                    "            AND dl_leg.t_legid = 0                            " +
                    "            AND dl_leg.t_legkind IN (0, 2)                    " +
                    "      JOIN ddlrq_dbt dlrq                                     " +
                    "         ON     dlrq.t_dockind = dl_tick.t_bofficekind        " +
                    "            AND dlrq.t_docid = dl_tick.t_dealid                        " +
                    "            AND dlrq.t_dealpart = DECODE (dl_leg.t_legkind, 0, 1, 2)" +
                    "            AND dlrq.t_subkind = 1                      " +
                    "            AND DLRQ.T_STATE != 7                    " +
                    "             AND (dlrq.t_kind = 0 OR dlrq.t_kind = 1)" +
                    " WHERE DL_TICK.T_DEALID = " +dealid +
                    "   AND DLRQ.T_DEALPART = " +  dealpart;

      var cmd_sql = RsdCommand(sql_txt);
      cmd_sql.AddParam("dealid", RSDBP_IN,dealid);
      cmd_sql.AddParam("dealpart", RSDBP_IN,dealpart);
      cmd_sql.Execute();
      var DateSet = TRsbDataSet(cmd_sql);
      while (DateSet.movenext)
           daterq = date(DateSet.Date_Rq);
           timereq = time(DateSet.time_req);
           factdaterq = date(DateSet.fact_date_rq);
      end;/**/
 //     RestP_Fact = GetRestBankP(pfi, dealdate, true/*входящий*/);
     RestP_Fact = GetRestBankP(pfi, iif (daterq != date("01.01.0001"),daterq, dealdate), true/*входящий*/); //GAA: 496247 
      RestP_Plan = RestP_Fact;
      /*Учитываеим изменения в составе сделок по текущую включительно*/
      StartCaptureOutput();
      [
        select t_factplandate, 
               sum(case when t_kind = 1 /*DLRQ_KIND_COMMIT*/ then -t_amount else t_amount end) t_amount
        from(select dealdt, 
                    dlrq.t_kind, 
                    case when dlrq.t_factdate = to_date('01.01.0001','dd.mm.yyyy') then dlrq.t_plandate 
                         else dlrq.t_factdate 
                    end t_factplandate, 
                    dlrq.t_amount  
             from ddl_tick_dbt dl_tick
             join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dl_tick.t_dealtype and
                                            -- Покупка/Продажа
                                            regexp_like(oprkoper.t_systypes, '[B|S|Z]')
             join (select ? pfi, 
                          ? dealdt, 
                          ? dealtm, 
                          ? dealpart,
                          ? dealid from dual) on 1=1
             join ddl_leg_dbt dl_leg on dl_leg.t_dealid = dl_tick.t_dealid and 
                                        dl_leg.t_legid = 0 and 
                                        dl_leg.t_legkind in (0,2)
             join ddlrq_dbt dlrq on dlrq.t_dockind = dl_tick.t_bofficekind and
                                    dlrq.t_docid = dl_tick.t_dealid and 
                                    dlrq.t_dealpart = decode(dl_leg.t_legkind, 0, 1, 2) and
                                    dlrq.t_subkind = 1 /*DLRQ_SUBKIND_AVOIRISS*/ and
                                    dlrq.t_state != 7  /*статус не равен "отказ от исполнения"*/and
                                    (dlrq.t_kind = 0 /*DLRQ_KIND_REQUEST*/ or dlrq.t_kind = 1 /*DLRQ_KIND_COMMIT*/) and
                                    case when dlrq.t_factdate = to_date('01.01.0001','dd.mm.yyyy') then dlrq.t_plandate 
                                         else dlrq.t_factdate 
                                    end >= dealdt
             where dl_tick.t_bofficekind in (###,###,####) and
                   (dl_tick.t_clientid = -1 or exists(select 1 
                                                      from ddp_dep_dbt dp_dep 
                                                      where dp_dep.t_partyid = dl_tick.t_clientid))and
                   dl_tick.t_pfi = pfi and
                   --((dl_tick.t_dealdate < dealdt) or  --GAA:496247 
                    --(dl_tick.t_dealdate = dealdt and dl_tick.t_dealtime < dealtm) or
                    --(dl_tick.t_dealdate = dealdt and dl_tick.t_dealtime = dealtm and dl_tick.t_dealid < dealid) or
                    --(dl_tick.t_dealdate = dealdt and dl_tick.t_dealtime = dealtm and dl_tick.t_dealid = dealid and dlrq.t_dealpart <= dealpart)))
                   (((CASE WHEN dlrq.t_factdate = TO_DATE ('01.01.0001', 'dd.mm.yyyy') THEN dlrq.t_plandate ELSE dlrq.t_factdate END) < dealdt)
                        or ((CASE WHEN dlrq.t_factdate = TO_DATE ('01.01.0001', 'dd.mm.yyyy') THEN dlrq.t_plandate ELSE dlrq.t_factdate END) = dealdt 
                               and DL_LEG.T_SUPPLYTIME < dealtm  )
                        or  ((CASE WHEN dlrq.t_factdate = TO_DATE ('01.01.0001', 'dd.mm.yyyy') THEN dlrq.t_plandate ELSE dlrq.t_factdate END) = dealdt 
                               and DL_LEG.T_SUPPLYTIME = dealtm
                               and dl_tick.t_dealid != dealid)
                        or  ((CASE WHEN dlrq.t_factdate = TO_DATE ('01.01.0001', 'dd.mm.yyyy') THEN dlrq.t_plandate ELSE dlrq.t_factdate END) = dealdt 
                               and DL_LEG.T_SUPPLYTIME = dealtm
                               and dl_tick.t_dealid = dealid
                               and dlrq.t_dealpart <= dealpart)))
        group by t_factplandate
      ](101,117,127);
      cmd_Turn = RsdCommand(EndCaptureOutput());
      cmd_Turn.AddParam("pfi", RSDBP_IN, pfi);
      cmd_Turn.AddParam("dealdate", RSDBP_IN, daterq/*dealdate*/);//GAA:496247 
      cmd_Turn.AddParam("dealtime", RSDBP_IN, timereq/*dealtime*/);//GAA:496247 
      cmd_Turn.AddParam("dealpart", RSDBP_IN, dealpart);
      cmd_Turn.AddParam("dealid", RSDBP_IN, dealid);
      cmd_Turn.Execute();
      RS_Turn = TRsbDataSet(cmd_Turn);
      while(RS_Turn.movenext)
        RestP_Plan = RestP_Plan + RS_Turn.value("t_amount");
        if(RS_Turn.value("t_factplandate") == factdaterq/*dealdate*/)  //GAA: 496247 
          RestP_Fact = RestP_Fact + RS_Turn.value("t_amount");
        end;
      end;
    end;

    /*Получить остатки и обороты дережных средств по договору клиента для сделки*/
    macro GetRestsM(clientid, contrid, dealid, dealdate, dealtime, dealpart, RestM_Fact:@tarray, RestM_Plan:@tarray, RestM_Cur:@tarray, RestM_TurnD:@tarray, RestM_TurnC:@tarray)
      var cmd_Turn, RS_Turn, fiid = null, fiidok;
      RestM_Fact.size = 0;
      RestM_Plan.size = 0;
      RestM_Cur.size = 0;
      RestM_TurnD.size = 0;
      RestM_TurnC.size = 0;
      /*Учитываеим изменения в составе сделок по текущую включительно*/
      StartCaptureOutput();
      [
        select dt.t_factplandate, dt.t_fiid, nvl(fininstr.t_ccy,chr(1)) t_ccy, dt.t_amount, dt.t_turnd, dt.t_turnc
        from(select t_factplandate,
                    t_fiid, 
                    sum(case when t_kind = 1 /*DLRQ_KIND_COMMIT*/ then -t_amount else t_amount end) t_amount,
                    sum(case when dealid = t_dealid and 
                                  dealpart = t_dealpart and 
                                  t_kind = 1 /*DLRQ_KIND_COMMIT*/ then t_amount else 0 end) t_turnd,
                    sum(case when dealid = t_dealid and  
                                  dealpart = t_dealpart and 
                                  t_kind = 0 /*DLRQ_KIND_REQUEST*/ then t_amount else 0 end) t_turnc
             from(select dealdt,
                         dealid, 
                         dl_tick.t_dealid,
                         dealpart,
                         dlrq.t_dealpart,
                         dlrq.t_fiid, 
                         dlrq.t_kind, 
                         case when dlrq.t_factdate = to_date('01.01.0001','dd.mm.yyyy') then dlrq.t_plandate 
                              else dlrq.t_factdate 
                         end t_factplandate, 
                         dlrq.t_amount  
                  from ddl_tick_dbt dl_tick
                  join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dl_tick.t_dealtype and
                                                 -- Покупка/Продажа
                                                 regexp_like(oprkoper.t_systypes, '[B|S|Z]')
                  join (select ? clientid, 
                               ? clientcontrid, 
                               ? dealdt, 
                               ? dealtm,
                               ? dealpart,
                               ? dealid from dual) on 1=1
                  join ddl_leg_dbt dl_leg on dl_leg.t_dealid = dl_tick.t_dealid and 
                                             dl_leg.t_legid = 0 and 
                                             dl_leg.t_legkind in (0,2)
                  join ddlrq_dbt dlrq on dlrq.t_dockind = dl_tick.t_bofficekind and
                                         dlrq.t_docid = dl_tick.t_dealid and 
                                         dlrq.t_dealpart = decode(dl_leg.t_legkind, 0, 1, 2) and
                                         dlrq.t_subkind = 0 /*DLRQ_SUBKIND_CURRENCY*/ and
                                         (dlrq.t_kind = 0 /*DLRQ_KIND_REQUEST*/ or dlrq.t_kind = 1 /*DLRQ_KIND_COMMIT*/) and
                                         case when dlrq.t_factdate = to_date('01.01.0001','dd.mm.yyyy') then dlrq.t_plandate 
                                              else dlrq.t_factdate 
                                         end >= dealdt
                  where dl_tick.t_bofficekind in (###,###,####) and
                        dl_tick.t_clientid = clientid and
                        dl_tick.t_clientcontrid = clientcontrid and
                        ((dl_tick.t_dealdate < dealdt) or 
                         (dl_tick.t_dealdate = dealdt and dl_tick.t_dealtime < dealtm) or
                         (dl_tick.t_dealdate = dealdt and dl_tick.t_dealtime = dealtm and dl_tick.t_dealid < dealid) or
                         (dl_tick.t_dealdate = dealdt and dl_tick.t_dealtime = dealtm and dl_tick.t_dealid = dealid and dlrq.t_dealpart <= dealpart))
union
select dealdt,
       dealid,
       nptx.t_id,
       dealpart,
       nprq.t_dealpart,
       nprq.t_fiid,
       nprq.t_kind,
       CASE
          WHEN nprq.t_factdate = TO_DATE ('01.01.0001', 'dd.mm.yyyy')
          THEN
             nprq.t_plandate
          ELSE
             nprq.t_factdate
       END
          t_factplandate,
       nprq.t_amount
  FROM dnptxop_dbt nptx
       JOIN (SELECT ? clientid,
                    ? clientcontrid,
                    ? dealdt,
                    ? dealtm,
                    ? dealpart,
                    ? dealid
               FROM DUAL)
          ON 1 = 1
       JOIN ddlrq_dbt nprq
          ON NPRQ.T_DOCID = nptx.t_id
 WHERE nptx.t_kind_operation = 2037 AND nptx.t_client = clientid
 and NPTX.T_CONTRACT = clientcontrid
       AND (   (nptx.t_operdate = dealdt)
            OR (nptx.t_operdate = dealdt AND nptx.t_time < dealtm)
            OR (nptx.t_operdate = dealdt AND nptx.t_time = dealtm)) )
             group by t_factplandate, t_fiid) dt
             left join dfininstr_dbt fininstr on fininstr.t_fiid = dt.t_fiid  
        order by dt.t_fiid, dt.t_turnd desc, dt.t_turnc desc
      ](101,117,127);
   

var sql_Turn = "select dt.t_factplandate, dt.t_fiid, nvl(fininstr.t_ccy,chr(1)) t_ccy, dt.t_amount, dt.t_turnd, dt.t_turnc " +
",dt.deal_c " /*GAA:513780 Выводить вначале информацию о суммах в валюте сделки, а затем во всех остальных валютах*/
"        from(select t_factplandate, " +
"                    t_fiid,  " +
"                    sum(case when t_kind = 1 /*DLRQ_KIND_COMMIT*/ then -t_amount else t_amount end) t_amount, " +
"                    sum(case when dealid = t_dealid and  " +
"                                  dealpart = t_dealpart and  " +
"                                  t_kind = 1 /*DLRQ_KIND_COMMIT*/ then t_amount else 0 end) t_turnd, " +
"                    sum(case when dealid = t_dealid and   " +
"                                  dealpart = t_dealpart and  " +
"                                  t_kind = 0 /*DLRQ_KIND_REQUEST*/ then t_amount else 0 end) t_turnc " +
",sum (deal_cur ) deal_c " +   /*GAA:513780*/
"             from(select dealdt, " +
"                         dealid,  " +
"                         dl_tick.t_dealid, "+ 
"                         dealpart, " +
"                         dlrq.t_dealpart, " +
"                         dlrq.t_fiid,  " +
"                         dlrq.t_kind,  " +
"                         case when dlrq.t_factdate = to_date('01.01.0001','dd.mm.yyyy') then dlrq.t_plandate  " +
"                              else dlrq.t_factdate  " +
"                         end t_factplandate,  " +
"                         dlrq.t_amount   " +
", case when (dlrq.t_type = 2 and dealid = dl_tick.T_dealid) then 1 else 0 end deal_cur " + /*GAA:513780*/
"                  from ddl_tick_dbt dl_tick " +
"                  join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dl_tick.t_dealtype and " +
"                                                                    " +
"                                                 regexp_like(oprkoper.t_systypes, '[B|S|Z]') " +
"                  join (select ? clientid,  " +
"                               ? clientcontrid,  " +
"                               ? dealdt,  " +
"                               ? dealtm, " +
"                               ? dealpart, " +
"                               ? dealid from dual) on 1=1 " +
"                  join ddl_leg_dbt dl_leg on dl_leg.t_dealid = dl_tick.t_dealid and  " +
"                                             dl_leg.t_legid = 0 and  " +
"                                             dl_leg.t_legkind in (0,2) " +
"                  join ddlrq_dbt dlrq on dlrq.t_dockind = dl_tick.t_bofficekind and " +
"                                         dlrq.t_docid = dl_tick.t_dealid and  " +
"                                         dlrq.t_dealpart = decode(dl_leg.t_legkind, 0, 1, 2) and " +
"                                         dlrq.t_subkind = 0 /*DLRQ_SUBKIND_CURRENCY*/ and " +
"                                         DLRQ.T_STATE != 7  and" + //GAA: 496245
"                                         (dlrq.t_kind = 0 /*DLRQ_KIND_REQUEST*/ or dlrq.t_kind = 1 /*DLRQ_KIND_COMMIT*/) and " +
"                                         case when dlrq.t_factdate = to_date('01.01.0001','dd.mm.yyyy') then dlrq.t_plandate  " +
"                                              else dlrq.t_factdate  " +
"                                         end >= dealdt " +
"                  where dl_tick.t_bofficekind in (101,117,127) and " +
"                        dl_tick.t_clientid = clientid and " +
"                        dl_tick.t_clientcontrid = clientcontrid and " +
"                        ((dl_tick.t_dealdate < dealdt) or  " +
"                         (dl_tick.t_dealdate = dealdt and dl_tick.t_dealtime < dealtm) or " +
"                         (dl_tick.t_dealdate = dealdt and dl_tick.t_dealtime = dealtm and dl_tick.t_dealid < dealid) or " +
"                         (dl_tick.t_dealdate = dealdt and dl_tick.t_dealtime = dealtm and dl_tick.t_dealid = dealid and dlrq.t_dealpart <= dealpart)) " +
"union all " +  /*GAA: 516326, old:UNION - удаляет одинаковые записи если они имеются в результате выполнения любого из запросов в объединении (нпрм.: если в сделке комиссии на  одинаковые суммы, то одна из записей будет удалена*/ 
"select dealdt, " +
"       dealid, " +
"       nptx.t_id, " +
"       dealpart, " +
"       nprq.t_dealpart, " +
"       nprq.t_fiid, " +
"       nprq.t_kind, " +
"       CASE " +
"          WHEN nprq.t_factdate = TO_DATE ('01.01.0001', 'dd.mm.yyyy') " +
"          THEN " +
"             nprq.t_plandate " +
"          ELSE " +
"             nprq.t_factdate " +
"       END " +
"          t_factplandate, " +
"       nprq.t_amount " +
", 0 deal_cur " +  /*GAA:513780*/
"  FROM dnptxop_dbt nptx " +
"       JOIN (SELECT ? clientid, " +
"                    ? clientcontrid, " +
"                    ? dealdt, " +
"                    ? dealtm, " +
"                    ? dealpart, " +
"                    ? dealid " +
"               FROM DUAL) " +
"          ON 1 = 1 " +
"       JOIN ddlrq_dbt nprq " +
"          ON NPRQ.T_DOCID = nptx.t_id " +
" WHERE nptx.t_kind_operation = 2037 AND nptx.t_client = clientid " +
" and NPTX.T_CONTRACT = clientcontrid " +
"       AND (   (nptx.t_operdate = dealdt) " +
"            OR (nptx.t_operdate = dealdt AND nptx.t_time < dealtm) " +
"            OR (nptx.t_operdate = dealdt AND nptx.t_time = dealtm)) ) " +
"             group by t_factplandate, t_fiid) dt " +
"             left join dfininstr_dbt fininstr on fininstr.t_fiid = dt.t_fiid   " +
"        order by dt.deal_c desc /*GAA:513780*/, dt.t_fiid, dt.t_turnd desc, dt.t_turnc desc "; 



   
 //     cmd_Turn = RsdCommand(EndCaptureOutput());

      cmd_Turn = RsdCommand(sql_Turn);
      cmd_Turn.AddParam("clientid", RSDBP_IN, clientid);
      cmd_Turn.AddParam("contrid", RSDBP_IN, contrid);
      cmd_Turn.AddParam("dealdate", RSDBP_IN, dealdate);
      cmd_Turn.AddParam("dealtime", RSDBP_IN, dealtime);
      cmd_Turn.AddParam("dealpart", RSDBP_IN, dealpart);
      cmd_Turn.AddParam("dealid", RSDBP_IN, dealid);
   
      cmd_Turn.AddParam("clientid_Nptx", RSDBP_IN, clientid);
      cmd_Turn.AddParam("contrid_Nptx", RSDBP_IN, contrid);
      cmd_Turn.AddParam("dealdate_Nptx", RSDBP_IN, dealdate);
      cmd_Turn.AddParam("dealtime_Nptx", RSDBP_IN, dealtime);
      cmd_Turn.AddParam("dealpart_Nptx", RSDBP_IN, dealpart);
      cmd_Turn.AddParam("dealid_Nptx", RSDBP_IN, dealid);
      cmd_Turn.Execute();
      RS_Turn = TRsbDataSet(cmd_Turn);
      while(RS_Turn.movenext)
        if((fiid == null) or (fiid != RS_Turn.value("t_fiid")))
          fiid = RS_Turn.value("t_fiid");
          if((RS_Turn.value("t_turnd") != 0) or (RS_Turn.value("t_turnc") != 0))
            fiidok = true;
            RestM_Fact[RestM_Fact.size] = GetRestM(clientid, contrid, fiid, dealdate, true/*входящий*/);
            RestM_Plan[RestM_Plan.size] = RestM_Fact[RestM_Fact.size-1];
            RestM_Cur[RestM_Cur.size] = RS_Turn.value("t_ccy");
            RestM_TurnD[RestM_TurnD.size] = $0;
            RestM_TurnC[RestM_TurnC.size] = $0;
          else
            fiidok = false;
          end;
        end;
        if(fiidok)
          RestM_Plan[RestM_Plan.size-1] = RestM_Plan[RestM_Plan.size-1] + RS_Turn.value("t_amount");
          if(RS_Turn.value("t_factplandate") == dealdate)
            RestM_Fact[RestM_Fact.size-1] = RestM_Fact[RestM_Fact.size-1] + RS_Turn.value("t_amount");
          end;
          RestM_TurnD[RestM_TurnD.size-1] = RestM_TurnD[RestM_TurnD.size-1] + RS_Turn.value("t_turnd");
          RestM_TurnC[RestM_TurnC.size-1] = RestM_TurnC[RestM_TurnC.size-1] + RS_Turn.value("t_turnc");
        end;
      end;
    end;
                     
    /*Получить остатки и обороты собственных дережных средств для сделки*/
    macro GetRestsBankM(dealid, dealdate, dealpart, RestM_Fact:@tarray, RestM_Plan:@tarray, RestM_Cur:@tarray, RestM_TurnD:@tarray, RestM_TurnC:@tarray)
      var cmd_Turn, RS_Turn, fiid = null, fiidok;
      var daterq = date (0,0,0);
      RestM_Fact.size = 0;
      RestM_Plan.size = 0;
      RestM_Cur.size = 0;
      RestM_TurnD.size = 0;
      RestM_TurnC.size = 0;
      /*Учитываеим изменения в составе сделок по текущую включительно*/
      StartCaptureOutput();
      [
        select dt.t_factplandate, dt.t_factdate/*GAA:496247*/, dt.t_fiid, nvl(fininstr.t_ccy,chr(1)) t_ccy, dt.t_amount, dt.t_turnd, dt.t_turnc
        from(select t_factplandate,
                    t_factdate/*GAA:496247*/,
                    t_fiid, 
                    sum(case when t_kind = 1 /*DLRQ_KIND_COMMIT*/ then -t_amount else t_amount end) t_amount,
                    sum(case when dealpart = t_dealpart and 
                                  t_kind = 1 /*DLRQ_KIND_COMMIT*/ then t_amount else 0 end) t_turnd,
                    sum(case when dealpart = t_dealpart and 
                                  t_kind = 0 /*DLRQ_KIND_REQUEST*/ then t_amount else 0 end) t_turnc
             from(select  
                         dl_tick.t_dealid,
                         dealpart,
                         dlrq.t_dealpart,
                         dlrq.t_fiid, 
                         dlrq.t_kind, 
                         case when dlrq.t_factdate = to_date('01.01.0001','dd.mm.yyyy') then dlrq.t_plandate 
                              else dlrq.t_factdate 
                         end t_factplandate,
                         dlrq.t_factdate/*GAA:496247*/,
                         dlrq.t_amount  
                  from ddl_tick_dbt dl_tick
                  join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dl_tick.t_dealtype and
                                                 -- Покупка/Продажа
                                                 regexp_like(oprkoper.t_systypes, '[B|S|Z]')
                  join (select ? dealpart,
                               ? dealid from dual) on 1=1
                  join ddl_leg_dbt dl_leg on dl_leg.t_dealid = dl_tick.t_dealid and 
                                             dl_leg.t_legid = 0 and 
                                             dl_leg.t_legkind in (0,2)
                  join ddlrq_dbt dlrq on dlrq.t_dockind = dl_tick.t_bofficekind and
                                         dlrq.t_docid = dl_tick.t_dealid and 
                                         dlrq.t_dealpart = decode(dl_leg.t_legkind, 0, 1, 2) and
                                         dlrq.t_subkind = 0 /*DLRQ_SUBKIND_CURRENCY*/ and
                                         DLRQ.T_STATE != 7 /*GAA: 496247 исключим ТО в статусе "отказ от исполнения"*/and
                                         (dlrq.t_kind = 0 /*DLRQ_KIND_REQUEST*/ or dlrq.t_kind = 1 /*DLRQ_KIND_COMMIT*/)
                  where dl_tick.t_bofficekind in (###,###,####) and
                        dl_tick.t_dealid = dealid and 
                        dlrq.t_dealpart <= dealpart)
             group by t_factplandate, t_factdate /*GAA:496247*/, t_fiid) dt
             left join dfininstr_dbt fininstr on fininstr.t_fiid = dt.t_fiid  
        order by dt.t_fiid, dt.t_turnd desc, dt.t_turnc desc
      ](101,117,127);
      cmd_Turn = RsdCommand(EndCaptureOutput());
      cmd_Turn.AddParam("dealpart", RSDBP_IN, dealpart);
      cmd_Turn.AddParam("dealid", RSDBP_IN, dealid);
      cmd_Turn.Execute();
      RS_Turn = TRsbDataSet(cmd_Turn);
      while(RS_Turn.movenext)
        daterq =  date(RS_Turn.value("t_factdate"));/*GAA: 496247*/
        if((fiid == null) or (fiid != RS_Turn.value("t_fiid")))
          fiid = RS_Turn.value("t_fiid");
          if((RS_Turn.value("t_turnd") != 0) or (RS_Turn.value("t_turnc") != 0))
            fiidok = true;
            RestM_Fact[RestM_Fact.size] = $0;
            RestM_Plan[RestM_Plan.size] = $0;
            RestM_Cur[RestM_Cur.size] = RS_Turn.value("t_ccy");
            RestM_TurnD[RestM_TurnD.size] = $0;
            RestM_TurnC[RestM_TurnC.size] = $0;
          else
            fiidok = false;
          end;
        end;
        if(fiidok)
          RestM_Plan[RestM_Plan.size-1] = RestM_Plan[RestM_Plan.size-1] + RS_Turn.value("t_amount");
          if(RS_Turn.value("t_factplandate") == daterq /*dealdate*/)  // GAA:496247
            RestM_Fact[RestM_Fact.size-1] = RestM_Fact[RestM_Fact.size-1] + RS_Turn.value("t_amount");
          end;
          RestM_TurnD[RestM_TurnD.size-1] = RestM_TurnD[RestM_TurnD.size-1] + RS_Turn.value("t_turnd");
          RestM_TurnC[RestM_TurnC.size-1] = RestM_TurnC[RestM_TurnC.size-1] + RS_Turn.value("t_turnc");
        end;
      end;
    end;

    /*Получить остатки и обороты ценных бумаг по договору клиента*/
    macro GetRestsAllP(clientid, contrid, enddate, RS_RestP:@rsdrecordset)
      var cmd_Turn;
      /*Остаки по ценным бумагам по договору за дату enddate плюс ТО по ЦБ с датой исполнения больше enddate*/
      StartCaptureOutput();
      [
        select nvl(avrkindsroot.t_name,chr(1)) t_firootname,
               nvl(avrkinds.t_name,chr(1)) t_finame,
               decode(nvl(avoiriss.t_lsin,chr(1)), chr(1), avoiriss.t_isin, nvl(avoiriss.t_lsin,chr(1))) t_lsin, /*Chesnokov D.S. 514870*/
               nvl(issuer.t_name, chr(1)) t_issuername,
               nvl(rest.t_rest,0) t_rest, 
               nvl(rest.t_rest,0) + nvl(turn.t_turn,0) t_planrest
        from (select pmwrtcl.t_fiid t_fiid,
                 pmwrtcl.t_amount t_rest
              from dpmwrtcl_dbt pmwrtcl
              join (select ? clientid, ? clientcontrid, ? edt from dual) on 1=1
              where pmwrtcl.t_department = 1 and
                    pmwrtcl.t_party = clientid and
                    pmwrtcl.t_contract = clientcontrid and
                    pmwrtcl.t_begdate <= edt and
                    pmwrtcl.t_enddate >= edt
              ) rest
              full join (select dlrq.t_fiid, 
                                sum(case when dlrq.t_kind = 1 /*DLRQ_KIND_COMMIT*/ then -dlrq.t_amount else dlrq.t_amount end) t_turn
                         from ddl_tick_dbt dl_tick
                         join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dl_tick.t_dealtype and
                                                        -- Покупка/Продажа
                                                        regexp_like(oprkoper.t_systypes, '[B|S|Z]')
                         join (select ? clientid, ? clientcontrid, ? edt from dual) on 1=1
                         join ddl_leg_dbt dl_leg on dl_leg.t_dealid = dl_tick.t_dealid and 
                                                    dl_leg.t_legid = 0 and 
                                                    dl_leg.t_legkind in (0,2)
                         join ddlrq_dbt dlrq on dlrq.t_dockind = dl_tick.t_bofficekind and
                                                dlrq.t_docid = dl_tick.t_dealid and 
                                                dlrq.t_dealpart = decode(dl_leg.t_legkind, 0, 1, 2) and
                                                dlrq.t_subkind = 1 /*DLRQ_SUBKIND_AVOIRISS*/ and
                                                (dlrq.t_kind = 0 /*DLRQ_KIND_REQUEST*/ or dlrq.t_kind = 1 /*DLRQ_KIND_COMMIT*/) and
                                                case when dlrq.t_factdate = to_date('01.01.0001','dd.mm.yyyy') then dlrq.t_plandate 
                                                     else dlrq.t_factdate 
                                                end > edt
                         where dl_tick.t_bofficekind in (101
                         ) and
                               dl_tick.t_clientid = clientid and
                               dl_tick.t_clientcontrid = clientcontrid and
                               dl_tick.t_dealdate <= edt
                         group by dlrq.t_fiid) turn on turn.t_fiid = rest.t_fiid  
              left join dfininstr_dbt fininstr on fininstr.t_fiid = nvl(rest.t_fiid, turn.t_fiid)
              left join davoiriss_dbt avoiriss on avoiriss.t_fiid = fininstr.t_fiid
              left join davrkinds_dbt avrkinds on avrkinds.t_fi_kind = fininstr.t_fi_kind and 
                                                  avrkinds.t_avoirkind = fininstr.t_avoirkind 
              left join davrkinds_dbt avrkindsroot on avrkindsroot.t_fi_kind = fininstr.t_fi_kind and 
                                                      avrkindsroot.t_avoirkind = rsb_fiinstr.fi_avrkindsgetroot(fininstr.t_fi_kind, fininstr.t_avoirkind)
              left join dparty_dbt issuer on issuer.t_partyid = fininstr.t_issuer
              order by avrkinds.t_name
      ];
      cmd_Turn = RsdCommand(EndCaptureOutput());
      cmd_Turn.AddParam("clientid1", RSDBP_IN, clientid);
      cmd_Turn.AddParam("contrid1", RSDBP_IN, contrid);
      cmd_Turn.AddParam("enddate1", RSDBP_IN, enddate);
      cmd_Turn.AddParam("clientid2", RSDBP_IN, clientid);
      cmd_Turn.AddParam("contrid2", RSDBP_IN, contrid);
      cmd_Turn.AddParam("enddate2", RSDBP_IN, enddate);
      cmd_Turn.Execute();
      RS_RestP = RSDRecordset(cmd_Turn, RSDVAL_CLIENT, RSDVAL_STATIC);
    end;


/*GAA: 495699*/
    /*Получить данные по обеспечению в сделках с корзиной ц/б */
    macro GetBasketAvr(dealid, enddate, 
                       B_firootname:@tarray, 
                       B_finame:@tarray,
                       B_lsin:@tarray,
                       B_issuername:@tarray,
                       B_cost:@tarray,
                       B_currencyname:@tarray,
                       B_costrur:@tarray,
                       B_principal:@tarray)
 
      var cmd_Turn, RS_Turn;
      B_firootname.size = 0; 
      B_finame.size = 0;
      B_lsin.size = 0;
      B_issuername.size = 0;
      B_cost.size = 0;
      B_currencyname.size = 0;
      B_costrur.size = 0;
      B_principal.size = 0;
 /*Отберем данные по обеспечению (количество, стоимость) по сделке с dealid на дату enddate и дополним информацией по ФИ(наименовани,LSIN,эмитент, вид ц/б)*/
      StartCaptureOutput();
      [
       SELECT AVRKINDS.T_NAME AS firootname,
       FININSTR.T_NAME AS finame,
       decode(nvl(avoiriss.t_lsin,chr(1)), chr(1), avoiriss.t_isin, nvl(avoiriss.t_lsin,chr(1))) AS lsin, /* MAA: iSupport - 515468 */
       PARTY.T_NAME AS issuername,
       ROUND (ens.t_totalcost/ (CASE WHEN ens.t_principal != 0 THEN ens.t_principal ELSE 1 END), 6) AS cost,
       (SELECT t_ccy FROM dfininstr_dbt WHERE t_fiid = ens.t_costfiid) AS currencyname,
       CASE WHEN ens.t_costfiid = 0 THEN NVL ( ROUND (ens.t_totalcost / (CASE  WHEN ens.t_principal != 0 THEN ens.t_principal ELSE 1 END), 6), 0)
                 ELSE ROUND (rsi_rsb_fiinstr.convsum ( ROUND (ens.t_totalcost / (CASE WHEN ens.t_principal != 0 THEN ens.t_principal ELSE 1 END), 6), ens.t_costfiid, 0, ?/*1*/), 6)
        END as costrur,
       ens.t_principal as principal 
       FROM (  SELECT DL_TICK_ENS.T_FIID t_fiid, DL_TICK_ENS.T_COSTFIID t_costfiid, SUM (NVL ((CASE  WHEN DL_TICK_ENS.T_KIND = 0 THEN DL_TICK_ENS.T_PRINCIPAL ELSE - DL_TICK_ENS.T_PRINCIPAL END), 0)) AS t_principal,
                 SUM ( NVL ( (CASE WHEN DL_TICK_ENS.T_KIND = 0 THEN DL_TICK_ENS.T_TOTALCOST ELSE -DL_TICK_ENS.T_TOTALCOST END), 0) ) AS t_totalcost
                 FROM ddl_tick_ens_dbt dl_tick_ens
                 WHERE DL_TICK_ENS.T_DEALID = ? /*2*/ AND DL_TICK_ENS.T_DATE <= ?/*3*/
                 GROUP BY DL_TICK_ENS.T_FIID, DL_TICK_ENS.T_COSTFIID) ens
       JOIN dfininstr_dbt fininstr             ON fininstr.t_fiid = ens.t_fiid
       LEFT JOIN davoiriss_dbt avoiriss   ON avoiriss.t_fiid = ens.t_fiid
       LEFT JOIN davrkinds_dbt avrkinds ON avrkinds.t_fi_kind = fininstr.t_fi_kind
             AND avrkinds.t_avoirkind = rsb_fiinstr.fi_avrkindsgetroot (fininstr.t_fi_kind, fininstr.t_avoirkind)
       JOIN dparty_dbt party  ON PARTY.T_PARTYID = FININSTR.T_ISSUER
      ];
      cmd_Turn = RsdCommand(EndCaptureOutput());
      cmd_Turn.AddParam("enddate1", RSDBP_IN, enddate);
      cmd_Turn.AddParam("dealid1", RSDBP_IN, dealid);
      cmd_Turn.AddParam("enddate2", RSDBP_IN, enddate);
      cmd_Turn.Execute();
      RS_Turn = TRsbDataSet(cmd_Turn);
      while(RS_Turn.movenext)
        B_firootname[B_firootname.size]     = RS_Turn.value("firootname");
        B_finame[B_finame.size]             = RS_Turn.value("finame");
        B_lsin[B_lsin.size]                 = RS_Turn.value("lsin");
        B_issuername[B_issuername.size]     = RS_Turn.value("issuername");
        B_cost[B_cost.size]                 = RS_Turn.value("cost");
        B_currencyname[B_currencyname.size] = RS_Turn.value("currencyname");
        B_costrur[B_costrur.size]           = RS_Turn.value("costrur");
        B_principal[B_principal.size]       = RS_Turn.value("principal");
      end;
    end; /*GAA:495699*/

    /*Получить остатки и обороты дережных средств по договору клиента*/
    macro GetRestsAllM(clientid, contrid, enddate, RestM_Fact:@tarray, RestM_Plan:@tarray, RestM_Cur:@tarray)
      var cmd_Turn, RS_Turn;
      RestM_Fact.size = 0;
      RestM_Plan.size = 0;
      RestM_Cur.size = 0;
      /*Остаки по счетам по договору за дату enddate плюс ТО по ДС с датой исполнения больше enddate*/
      StartCaptureOutput();
      [
        select nvl(fininstr.t_ccy,chr(1)) t_ccy, 
               nvl(rest.t_rest,0) t_rest, 
               nvl(rest.t_rest,0) + nvl(turn.t_turn,0) t_planrest  
        from (select sa.t_FIID t_fiid, 
                           --rsb_account.restall(acc.t_account, acc.t_chapter, acc.t_code_currency, edt) t_rest
                           nvl(sum(rsb_account.restall(sa.t_account, sa.t_chapter, sa.t_FIID, edt)),0) t_rest
                    from dsfssi_dbt ssi
                    join (select ? sfcontrid, ? edt from dual) on 1=1
                    join dsettacc_dbt sa on sa.t_SettAccID = ssi.t_SetAccID and
                                            sa.t_chapter = 1/*
                    join daccount_dbt acc on acc.t_Account = sa.t_Account and
                                      acc.t_Chapter = sa.t_Chapter and
                                      acc.t_Code_Currency = sa.t_FIID
                    join dsfcontr_dbt sfcontr on sfcontr.t_id = sfcontrid*/
                    where ssi.t_ObjectType = 659/*cnst.OBJTYPE_SFCONTR*/ and
                          ssi.t_ObjectID = /*sfcontr.t_id*/sfcontrid and
                          ssi.t_FIKind = 1/*rsi_rsb_fiinstr.FIKIND_CURRENCY*/
                    group by sa.t_fiid) rest
              full join (select dlrq.t_fiid, 
                                sum(case when dlrq.t_kind = 1 /*DLRQ_KIND_COMMIT*/ then -dlrq.t_amount else dlrq.t_amount end) t_turn
                         from ddl_tick_dbt dl_tick
                         join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dl_tick.t_dealtype and
                                                        -- Покупка/Продажа
                                                        regexp_like(oprkoper.t_systypes, '[B|S|Z]')
                         join (select ? clientid, ? clientcontrid, ? edt from dual) on 1=1
                         join ddl_leg_dbt dl_leg on dl_leg.t_dealid = dl_tick.t_dealid and 
                                                    dl_leg.t_legid = 0 and 
                                                    dl_leg.t_legkind in (0,2)
                         join ddlrq_dbt dlrq on dlrq.t_dockind = dl_tick.t_bofficekind and
                                                dlrq.t_docid = dl_tick.t_dealid and 
                                                dlrq.t_dealpart = decode(dl_leg.t_legkind, 0, 1, 2) and
                                                dlrq.t_subkind = 0 /*DLRQ_SUBKIND_CURRENCY*/ and
                                                (dlrq.t_kind = 0 /*DLRQ_KIND_REQUEST*/ or dlrq.t_kind = 1 /*DLRQ_KIND_COMMIT*/) and
                                                case when dlrq.t_factdate = to_date('01.01.0001','dd.mm.yyyy') then dlrq.t_plandate 
                                                     else dlrq.t_factdate 
                                                end > edt
                         where dl_tick.t_bofficekind in (###,###,####) and
                               dl_tick.t_clientid = clientid and
                               dl_tick.t_clientcontrid = clientcontrid and
                               dl_tick.t_dealdate <= edt
                         group by dlrq.t_fiid) turn on turn.t_fiid = rest.t_fiid  
              left join dfininstr_dbt fininstr on fininstr.t_fiid = nvl(rest.t_fiid, turn.t_fiid)
              order by nvl(rest.t_fiid, turn.t_fiid)
      ](101,117,127);
      cmd_Turn = RsdCommand(EndCaptureOutput());
      cmd_Turn.AddParam("contrid1", RSDBP_IN, contrid);
      cmd_Turn.AddParam("enddate1", RSDBP_IN, enddate);
      cmd_Turn.AddParam("clientid2", RSDBP_IN, clientid);
      cmd_Turn.AddParam("contrid2", RSDBP_IN, contrid);
      cmd_Turn.AddParam("enddate2", RSDBP_IN, enddate);
      cmd_Turn.Execute();
      RS_Turn = TRsbDataSet(cmd_Turn);
      while(RS_Turn.movenext)
        RestM_Cur[RestM_Cur.size] = RS_Turn.value("t_ccy");
        RestM_Fact[RestM_Fact.size] = RS_Turn.value("t_rest");
        RestM_Plan[RestM_Plan.size] = RS_Turn.value("t_planrest");
      end;
    end;

/*Точка входа*/
    var row1, row2, row = 0, cnt, cnta;
    var m_DS, m_cmd, m_DS_d, m_cmd_d, m_RS_d, RS_RestP;
    var errmsg;

    /*Даты начала и окончания периода отчета*/
    m_BeginDate = FormData.BeginDate;
    m_End_Date   = FormData.EndDate;

/*Лист "ФР"*/
    if(m_Form.GetFieldValue(P_RIA_StockMarket))
      SetActiveSheet("ФР");
      PrintFormatString("", "reportperiod", "с " + m_BeginDate + " по " + m_End_Date);
      RegisterTable( "row1_0", "",
              /* 1*/ "row1_1", 
              /* 2*/ "row1_2", 
              /* 3*/ "row1_3", 
              /* 4*/ "row1_4", 
              /* 5*/ "row1_4a", 
              /* 6*/ "row1_5", 
              /* 7*/ "row1_6", 
              /* 8*/ "row1_7", 
              /* 9*/ "row1_8", 
              /*10*/ "row1_9a", 
              /*11*/ "row1_9", 
              /*12*/ "row1_10", 
              /*13*/ "row1_11", 
              /*14*/ "row1_11a", 
              /*15*/ "row1_12", 
              /*16*/ "row1_13", 
              /*17*/ "row1_14", 
              /*18*/ "row1_14a",
              /*19*/ "row1_15",  
              /*20*/ "row1_16", 
              /*21*/ "row1_17", 
              /*22*/ "row1_18", 
              /*23*/ "row1_19", 
              /*24*/ "row1_20", 
              /*25*/ "row1_21", 
              /*26*/ "row1_22", 
              /*27*/ "row1_23", 
              /*28*/ "row1_24",
              /*29*/ "row1_25",
              /*30*/ "row1_26",
              /*31*/ "row1_27",
              /*32*/ "row1_28",
              /*33*/ "row1_29",
              /*34*/ "row1_30",
              /*35*/ "row1_70", //GAA:496249 
              /*36*/ "row1_71", //GAA:496249
              /*37*/ "row1_31",
              /*38*/ "row1_32",
              /*39*/ "row1_33",
              /*40*/ "row1_34",
              /*41*/ "row1_35",
              /*42*/ "row1_36",
              /*43*/ "row1_37",
              /*44*/ "row1_38",
              /*45*/ "row1_39",
              /*46*/ "row1_40",
              /*47*/ "row1_41",
              /*48*/ "row1_42",
              /*49*/ "row1_43",
              /*50*/ "row1_44",
              /*51*/ "row1_45",
              /*52*/ "row1_46",
              /*53*/ "row1_47",
              /*54*/ "row1_48",
              /*55*/ "row1_49",
              /*56*/ "row1_50",
              /*57*/ "row1_51",
              /*58*/ "row1_52",
              /*59*/ "row1_53",
              /*60*/ "row1_54",
              /*61*/ "row1_55",
              /*62*/ "row1_56",
              /*63*/ "row1_57",
              /*64*/ "row1_58",
              /*65*/ "row1_59",
              /*66*/ "row1_60",
              /*67*/ "row1_61");
      this.AutoFilter(9, "B", "BI");
      StartCaptureOutput();
      [
        select count(1) over(partition by dt.t_isbank) t_cnt,
               dt.clientid,
               dt.clientcontrid,
               dt.pfi,
               dt.t_dealid dealid,
               dt.t_dealdate dealdate,
               dt.t_dealpart,
               dt.t_isbank,
               dt.t_dealcode,
               dt.t_dealdates,
               dt.t_dealtime,
               dt.t_planexecdate,
               dt.t_marketname,
               dt.t_sfcontrnumber,
               dt.t_sfcontrbegdate,
               dt.t_sfcontrenddate,
               case when dt.t_clientcode != chr(1) then nvl(dt.t_sfcontrname, dt.t_clientname)||' '||'/'||' '||dt.t_clientcode 
                    else nvl(dt.t_sfcontrname, dt.t_clientname) 
               end t_clientname,
               dt.t_clientform,
               dt.t_clientcountry,
               dt.t_clientresident,
               dt.t_clientcvalinv,
               dt.t_side2name,
               dt.t_genagr,
               dt.t_contragentname,
               dt.t_brokercomiss,
               case when dt.t_isbank = 1 then 'С' else 'К' end t_dealtype,
               case when dt.t_isrepo = 0 then case when dt.t_isbuy = 1 then 'Покупка' 
                                                  /*BIQ-5485, иначе возвращалась "Продажа"*/
                                                   when dt.t_isbuy = 2 then 'Списание'
                                                   when dt.t_isbuy = 3 then 'Зачисление'
                                                   else 'Продажа' end
                    when dt.t_dealpart = 1 then decode(dt.t_isbuy, 1, 'Покупка', 'Продажа')
                    when dt.t_dealpart = 2 then decode(dt.t_isbuy, 1, 'Продажа', 'Покупка')
                    else chr(1)
               end t_side,
               dt.t_isotc,
               case when  instr( lower(dt.T_USERFIELD1), 'мена') != 0 then 'мена'       --GAA:495919 
                    when  instr( lower(dt.T_USERFIELD1), 'уступка') != 0 then 'уступка' --GAA:495919
                    when  dt.t_isrepo = 0 and dt.t_isbuy in (2, 3) then 'cписание-зачисление' /*BIQ-5485*/
                    when dt.t_isrepo = 0 then 'купля-продажа'
                    when (select trim(lower(nvl(max(t_name),chr(1)))) 
                          from dobjattr_dbt objattr, dobjatcor_dbt objatcor 
                          where objattr.t_objecttype = dt.t_bofficekind and 
                                objattr.t_groupid = 103 and /*103*/ 
                                objatcor.t_objecttype = objattr.t_objecttype and 
                                objatcor.t_groupid = objattr.t_groupid and 
                                objatcor.t_attrid = objattr.t_attrid and 
                                objatcor.t_object = lpad(dt.t_dealid, 34, '0') and 
                                objatcor.t_validfromdate <= dt.t_dealdate and 
                                objatcor.t_validtodate > dt.t_dealdate) = 'да' then 'СпецРЕПО'||dt.t_dealpart
                    else 'РЕПО'||dt.t_dealpart 
               end t_side2,
               dt.t_firootname,
               dt.t_finame,
               dt.t_lsin,
               dt.t_issuername,
               dt.t_cost,
               case when dt.t_dealpart = 2 then 0 
                    else nvl(lead(dt.t_cost) over(partition by dt.t_isbank, dt.t_dealcode, dt.t_dealdate order by dt.t_dealpart),0) 
               end t_costpart2,
               dt.t_currencyname,
               dt.t_costrur,
               case when dt.t_dealpart = 2 then 0 
                    else nvl(lead(dt.t_costrur) over(partition by dt.t_isbank, dt.t_dealcode, dt.t_dealdate order by dt.t_dealpart),0) 
               end t_costpart2rur,
               dt.t_incomerate,
               dt.t_principal,
               dt.t_totalcost,
               dt.t_totalcostrur,
               dt.t_dvalue,/*GAA:496249*/
               dt.t_dvaluerur,/*GAA:496249*/
               dt.t_curpfi t_currencyname2,
          (select nvl(max(dlrq.t_plandate),to_date('01.01.0001','dd.mm.yyyy'))
          from ddlrq_dbt dlrq
          where dlrq.t_dockind = dt.t_bofficekind and
                dlrq.t_docid = dt.t_dealid and
                dlrq.t_dealpart = dt.t_dealpart and
                dlrq.t_subkind = 1 /*DLRQ_SUBKIND_AVOIRISS*/) t_plandatesp_old,
            ( SELECT min(nvl((case when  DLRQbc.T_PLANDATE is null then DLRQ.T_PLANDATE else DLRQbc.T_PLANDATE end), to_date('01.01.0001','dd.mm.yyyy')))
              FROM ddlrq_dbt dlrq, ddlrqbc_dbt dlrqbc 
             WHERE   DLRQBC.T_RQID = DLRQ.T_ID  
                   AND dlrq.t_docid = dt.t_dealid
                   AND dlrq.t_dockind = dt.t_bofficekind
                   AND dlrq.t_dealpart = dt.t_dealpart
                   AND dlrq.t_subkind = 1 /*DLRQ_SUBKIND_AVOIRISS*/) t_plandatesp,
               (select nvl(max(dlrq.t_factdate),to_date('01.01.0001','dd.mm.yyyy')) 
                from ddlrq_dbt dlrq 
                where dlrq.t_dockind = dt.t_bofficekind and
                      dlrq.t_docid = dt.t_dealid and 
                      dlrq.t_dealpart = dt.t_dealpart and
                      dlrq.t_subkind = 1 /*DLRQ_SUBKIND_AVOIRISS*/) t_factdatesp,
         (select nvl(max(dlrq.t_plandate),to_date('01.01.0001','dd.mm.yyyy'))
          from ddlrq_dbt dlrq
          where dlrq.t_dockind = dt.t_bofficekind and
                dlrq.t_docid = dt.t_dealid and
                dlrq.t_dealpart = dt.t_dealpart and
                dlrq.t_subkind = 0 /*DLRQ_SUBKIND_CURRENCY*/ and
                dlrq.t_type in (2/*DLRQ_TYPE_PAYMENT*/, 3/*DLRQ_TYPE_INCREPO*/)) t_plandatem_old, 
                case 
                  when dt.t_isbuy in (2, 3) then  to_date('01.01.0001','dd.mm.yyyy') /* BIQ-5485  для операций списания зачисления ЦБ*/
                else
                 ( SELECT min(nvl((case when  DLRQbc.T_PLANDATE is null then DLRQ.T_PLANDATE else DLRQbc.T_PLANDATE end), to_date('01.01.0001','dd.mm.yyyy')))
                   FROM ddlrq_dbt dlrq, ddlrqbc_dbt dlrqbc 
                  WHERE   DLRQBC.T_RQID = DLRQ.T_ID  
                        AND dlrq.t_docid = dt.t_dealid
                        AND dlrq.t_dockind = dt.t_bofficekind
                        AND dlrq.t_dealpart = dt.t_dealpart
                        AND dlrq.t_subkind = 0
                        AND dlrq.t_type IN(2/*DLRQ_TYPE_PAYMENT*/, 3/*DLRQ_TYPE_INCREPO*/)) 
                  end   
               t_plandatem,
               (select nvl(max(dlrq.t_factdate),to_date('01.01.0001','dd.mm.yyyy')) 
                from ddlrq_dbt dlrq 
                where dlrq.t_dockind = dt.t_bofficekind and
                      dlrq.t_docid = dt.t_dealid and 
                      dlrq.t_dealpart = dt.t_dealpart and
                      dlrq.t_subkind = 0 and /*DLRQ_SUBKIND_CURRENCY*/
                      dlrq.t_type in (2/*DLRQ_TYPE_PAYMENT*/, 3/*DLRQ_TYPE_INCREPO*/)) t_factdatem,
               dt.t_curpfi t_curpfi,
               (select nvl(sum(dlrq.t_amount),0) 
                from ddlrq_dbt dlrq 
                where dlrq.t_dockind = dt.t_bofficekind and
                      dlrq.t_docid = dt.t_dealid and 
                      dlrq.t_dealpart = dt.t_dealpart and 
                      dlrq.t_kind = 1 /*DLRQ_KIND_COMMIT*/ and
                      dlrq.t_subkind = 1 /*DLRQ_SUBKIND_AVOIRISS*/ ) t_avrsumcom,
               (select nvl(sum(dlrq.t_amount),0) 
                from ddlrq_dbt dlrq 
                where dlrq.t_dockind = dt.t_bofficekind and
                      dlrq.t_docid = dt.t_dealid and 
                      dlrq.t_dealpart = dt.t_dealpart and 
                      dlrq.t_kind = 0 /*DLRQ_KIND_REQUEST*/ and
                      dlrq.t_subkind = 1 /*DLRQ_SUBKIND_AVOIRISS*/ ) t_avrsumreq,
               dt.t_conftp,
               (select trim(max(nvl(objattr.t_name,objattr.t_nameobject)))
                          from dobjattr_dbt objattr, dobjatcor_dbt objatcor 
                          where objattr.t_objecttype = 101 and
                                objattr.t_groupid = 106 and 
                                objatcor.t_objecttype = objattr.t_objecttype and 
                                objatcor.t_groupid = objattr.t_groupid and 
                                objatcor.t_attrid = objattr.t_attrid and 
                                objatcor.t_object = lpad(dt.t_dealid, 34, '0') and 
                                objatcor.t_validfromdate <= edt and 
                                objatcor.t_validtodate > edt and
                                rownum = 1) t_markettype,
               (select trim(nvl(max(t_name),decode(t_marketname,'Внебиржа','Адресная',''))) 
                          from dobjattr_dbt objattr, dobjatcor_dbt objatcor 
                          where objattr.t_objecttype = 101 and
                                objattr.t_groupid = 105 and 
                                objatcor.t_objecttype = objattr.t_objecttype and 
                                objatcor.t_groupid = objattr.t_groupid and 
                                objatcor.t_attrid = objattr.t_attrid and 
                                objatcor.t_object = lpad(dt.t_dealid, 34, '0') and 
                                objatcor.t_validfromdate <= edt and 
                                objatcor.t_validtodate > edt and
                                rownum = 1) t_dealtypeAdr,
             --(select nvl(max(dl_req.t_code),chr(1)) -- GAA:495676
               -- from dspgrdoc_dbt spgrdoc
                --join dspgrdoc_dbt spgrdocZ on spgrdocZ.t_sourcedockind = 350 and 
                                             --spgrdocZ.t_spgroundid = spgrdoc.t_spgroundid
                --join ddl_req_dbt dl_req on dl_req.t_kind = spgrdocZ.t_sourcedockind and 
                                           --dl_req.t_id = spgrdocZ.t_sourcedocid   
               -- where spgrdoc.t_sourcedockind = dt.t_bofficekind and 
                      --spgrdoc.t_sourcedocid = dt.t_dealid) t_groundnumber,  */
               dt.t_groundnumber,
               (select nvl(max(dl_req.t_date),dt.t_dealdate/*to_date('01.01.0001','dd.mm.yyyy')*/)
                from dspgrdoc_dbt spgrdoc
                join dspgrdoc_dbt spgrdocZ on spgrdocZ.t_sourcedockind = 350 and 
                                              spgrdocZ.t_spgroundid = spgrdoc.t_spgroundid
                join ddl_req_dbt dl_req on dl_req.t_kind = spgrdocZ.t_sourcedockind and 
                                           dl_req.t_id = spgrdocZ.t_sourcedocid   
                where spgrdoc.t_sourcedockind = dt.t_bofficekind and 
                      spgrdoc.t_sourcedocid = dt.t_dealid) t_grounddate,
               dt.t_execmethod,
               dt.t_formpayment,
               dt.t_ordernumber,
               case when dt.t_isbank = 1 then 'хозяйствующий субъект' else 'поверенный' end t_bankrole,
               'не ПФИ' t_ispfi,
               case when dt.t_isbank = 1 or dt.t_dlcontrid is null then chr(1)
                    else (select trim(lower(nvl(max(t_name),'право предоставлено'))) 
                          from dobjattr_dbt objattr, dobjatcor_dbt objatcor 
                          where objattr.t_objecttype = 207 and /*Договор брокерского обслуживания*/  
                                objattr.t_groupid = 102 and /*Право использования ДС Клиента Банком*/ 
                                objatcor.t_objecttype = objattr.t_objecttype and 
                                objatcor.t_groupid = objattr.t_groupid and 
                                objatcor.t_attrid = objattr.t_attrid and 
                                objatcor.t_object = lpad(dt.t_dlcontrid, 34, '0') and 
                                objatcor.t_validfromdate <= edt and 
                                objatcor.t_validtodate > edt) 
               end t_cashright,
               case when dt.t_isbank = 1 or dt.t_dlcontrid is null then chr(1)
                    else (select trim(nvl(max(t_name),'отсутствует')) 
                          from dobjattr_dbt objattr, dobjatcor_dbt objatcor 
                          where objattr.t_objecttype = 207 and /*Договор брокерского обслуживания*/  
                                objattr.t_groupid = 103 and /*Уровень риска клиента*/ 
                                objatcor.t_objecttype = objattr.t_objecttype and 
                                objatcor.t_groupid = objattr.t_groupid and 
                                objatcor.t_attrid = objattr.t_attrid and 
                                objatcor.t_object = lpad(dt.t_dlcontrid, 34, '0') and 
                                objatcor.t_validfromdate <= edt and 
                                objatcor.t_validtodate > edt) 
               end t_risklevel,
               case when dt.t_isbank = 1 then chr(1)
                    else nvl((select listagg(clientproxy.t_name, '/') 
                                     within group (order by clientproxy.t_name, ptproxy.t_proxyid)
                              from dptproxy_dbt ptproxy
                              join dparty_dbt clientproxy on clientproxy.t_partyid =  ptproxy.t_proxyid
                              where ptproxy.t_partyid = dt.t_clientid and
                                    ptproxy.t_docdate <= edt and 
                                    ptproxy.t_validitydate >= edt), chr(1)) 
               end t_proxyname,
               case when dt.t_isbank = 1 then chr(1)
                    else nvl((select listagg(ptproxy.t_docnumber||' с '||to_char(ptproxy.t_docdate,'dd.mm.yyyy')||' по '||to_char(ptproxy.t_validitydate,'dd.mm.yyyy'), '/') 
                                     within group (order by ptproxy.t_proxyid, ptproxy.t_proxyid)  
                              from dptproxy_dbt ptproxy
                              join dparty_dbt clientproxy on clientproxy.t_partyid =  ptproxy.t_proxyid
                              where ptproxy.t_partyid = dt.t_clientid and
                                    ptproxy.t_docdate <= edt and 
                                    ptproxy.t_validitydate >= edt), chr(1)) 
               end t_proxynum,
               dt.t_isBasket,/*GAA:495699*/
               dt.T_USERFIELD1,/*GAA: 495919*/
               dt.REJECT_DEAL, /*GAA:503363 */
               dt.t_note
        from (select bdt, edt,
                     dl_tick.t_clientid clientid,
                     dl_tick.t_clientcontrid clientcontrid,
                     dl_tick.t_pfi pfi,
                     case when dl_tick.t_clientid <= 0 or exists(select 1 
                                                                 from ddp_dep_dbt dp_dep 
                                                                 where dp_dep.t_partyid = dl_tick.t_clientid) then 1 
                          else 0 
                     end t_isbank,
                     dl_tick.t_dealid t_dealid,
                     dl_tick.t_dealdate t_dealdate,
                     dl_tick.t_bofficekind t_bofficekind,
                     rsb_brkrep_u.GetPlanExecDate(dl_tick.t_bofficekind, dl_tick.t_dealid, decode(dl_leg.t_legkind, 0, 1, 2)) t_planexecdate,
                     RSB_SECUR.IsRepo(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(dl_tick.t_DealType, dl_tick.t_BofficeKind))) t_isrepo,
                     RSB_SECUR.IsOtc(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(dl_tick.t_DealType, dl_tick.t_BofficeKind))) t_isotc,  
                     /*RSB_SECUR.IsBuy(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(dl_tick.t_DealType, dl_tick.t_BofficeKind))) t_isbuy, */
                     case /*BIQ-5485*/
                        when dl_tick.t_DealType = 2010 and dl_tick.t_BofficeKind = 127 then 2 /*2010 - списание ЦБ*/
                        when dl_tick.t_DealType = 2011 and dl_tick.t_BofficeKind = 127 then 3 /*2011 - зачисление ЦБ*/
                     else 
                        RSB_SECUR.IsBuy(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(dl_tick.t_DealType, dl_tick.t_BofficeKind)))
                     end   
                     t_isbuy,
                     decode(dl_leg.t_legkind, 0, 1, 2) t_dealpart,
                     CASE  WHEN REGEXP_LIKE (oprkoper.t_systypes, '[v]') /* внебиржевые сдекли*/ THEN       /*GAA: 495698, 495699*/
                            CASE WHEN dl_tick.t_clientid = -1    /*Собственные сделки*/
                               THEN  dl_tick.t_dealcode
                              WHEN dl_tick.t_dealcodets = CHR (1)
                               THEN dl_tick.t_dealcode
                              ELSE
                               dl_tick.t_dealcodets
                            END
                     ELSE/*GAA*/
                      case when dl_tick.t_dealcodets = chr(1) then dl_tick.t_dealcode 
                           else dl_tick.t_dealcodets 
                      end
                     END t_dealcode, 
                     to_char(dl_tick.t_dealdate,'dd.mm.yyyy') t_dealdates, 
                     to_char(dl_tick.t_dealtime,'hh24:mi:ss') t_dealtime,
                     case when regexp_like(oprkoper.t_systypes, '[X]') AND (rsb_secur.IsOTC(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(dl_tick.t_DealType,dl_tick.t_BofficeKind)))=0) then replace(nvl(market.t_name, chr(1)), 'Публичное акционерное общество (ПАО)', 'ПАО') 
                          else 'Внебиржа' 
                     end t_marketname,
                     nvl(sfcontr.t_number,chr(1)) t_sfcontrnumber,
                     nvl(sfcontr.t_name,chr(1)) t_sfcontrname,
                     nvl(sfcontr.t_datebegin, to_date('01.01.0001','dd.mm.yyyy')) t_sfcontrbegdate,
                     nvl(sfcontr.t_dateclose, to_date('01.01.0001','dd.mm.yyyy')) t_sfcontrenddate,
                     nvl(client.t_name,chr(1)) t_clientname,
                     (select OBJCODE.T_CODE from ddlobjcode_dbt objcode where objcode.t_objecttype = 207 and objcode.t_codekind =1 and objcode.t_objectid =DLCONTR.T_DLCONTRID) t_clientcode,/* GAA:495103, old: nvl(dlcontrmp.t_mpcode,chr(1)) t_clientcode,*/
                     case when client.t_legalform is null then chr(1) 
                          when client.t_legalform = 1 then 'ЮЛ' 
                          when nvl(clientp.t_isemployer,chr(0)) = chr(88) then 'ИП' 
                          else 'ФЛ' 
                     end t_clientform,
                     nvl(clientc.t_name, chr(1)) t_clientcountry,
                     case when client.t_notresident is null then chr(1) 
                          when client.t_notresident = chr(88) then 'нерезидент' 
                          else 'резидент' 
                     end t_clientresident,
                    (CASE WHEN REGEXP_LIKE (oprkoper.t_systypes, '[G|Z]')  --GAA:496240
                          THEN (SELECT nvl (SPGROUND.T_XLD,chr(1))
                                  From Dspgrdoc_Dbt SpGrDoc
                                  JOIN DSpGround_Dbt SpGround
                                    ON SpGround.T_KIND = 251
                                   AND SpGround.T_SPGROUNDID = SpGrDoc.T_SPGROUNDID
                                 WHERE SpGrDoc.T_SOURCEDOCKIND = DL_TICK.T_BOFFICEKIND
                                   AND SpGrDoc.T_SOURCEDOCID = dl_tick.T_dealID ) 
                          WHEN REGEXP_LIKE (oprkoper.t_systypes, '[v]') --GAA: 495676
                               AND dl_tick.t_clientid != -1
                          THEN dl_tick.t_dealcode
                          WHEN dl_tick.t_bofficekind = 101 /*DL_SECURITYDOC*/ 
                               AND RSB_SECUR.GetMainObjAttr(101, LPAD(dl_tick.t_dealid, 34, '0'), 116, dl_tick.t_dealdate) = 1
                          THEN '' --Biq-9103
                          ELSE
                           (SELECT NVL (MAX (dl_req.t_code), CHR (1))
                              FROM dspgrdoc_dbt spgrdoc
                                JOIN dspgrdoc_dbt spgrdocZ
                                   ON spgrdocZ.t_sourcedockind = 350
                                      AND spgrdocZ.t_spgroundid = spgrdoc.t_spgroundid
                                JOIN ddl_req_dbt dl_req
                                   ON dl_req.t_kind = spgrdocZ.t_sourcedockind
                                      AND dl_req.t_id = spgrdocZ.t_sourcedocid
                             WHERE spgrdoc.t_sourcedockind = dl_tick.t_bofficekind
                               AND spgrdoc.t_sourcedocid = dl_tick.t_dealid) 
                          END) t_groundnumber, --GAA
                     case when exists(select 1 from dscqinv_dbt scqinv where scqinv.t_partyid = dl_tick.t_clientid and scqinv.t_state = 1 and scqinv.t_regdate <= edt)
                            or exists(select 1 from dscqinvh_dbt scqinvh where scqinvh.t_partyid = dl_tick.t_clientid and scqinvh.t_state = 1 and scqinvh.t_begdate <= edt and scqinvh.t_enddate >= edt) 
                               then 'квалинвестор' 
                          else 'не квалинвестор' 
                     end t_clientcvalinv,
                     case when regexp_like(oprkoper.t_systypes, '[v]') then nvl(contragent.t_name,chr(1)) 
                          else '-' 
                     end t_side2name,
                     case when (regexp_like(oprkoper.t_systypes, '[v]')) and (dl_tick.t_clientid = -1) then (SELECT genagr.t_code || ' от ' || to_char(genagr.t_start,'DD.MM.YYYY') FROM ddl_genagr_dbt genagr where genagr.t_genagrid = dl_tick.t_genagrid and rownum=1)
                       else '' 
                     end t_genagr,
                     case when regexp_like(oprkoper.t_systypes, '[v]') then chr(1) 
                          else nvl(contragent.t_name,chr(1)) 
                     end t_contragentname,
                     nvl(rsb_brkrep_u.GetBrokerComissSum(dl_tick.t_bofficekind, dl_tick.t_dealid, decode(dl_leg.t_legkind, 0, 1, 2)),0) t_brokercomiss,
                     nvl(avrkindsroot.t_name,chr(1)) t_firootname,
                     nvl(avrkinds.t_name,chr(1)) t_finame,
                     decode(nvl(avoiriss.t_lsin,chr(1)), chr(1), avoiriss.t_isin, nvl(avoiriss.t_lsin,chr(1))) t_lsin, /* MAA: iSupport - 515468 */
                     nvl(issuer.t_name, chr(1)) t_issuername,
                     nvl(currency.t_ccy,chr(1)) t_currencyname,
                     nvl(round(dl_leg.t_cost/dl_leg.t_principal,6),0) t_cost, 
                     nvl(dl_leg.t_totalcost,0) t_totalcost, 
                     nvl(dl_leg.t_principal,0) t_principal, 
                     nvl(dl_leg.t_incomerate,0) t_incomerate,
                     case when dl_leg.t_cfi = 0 then nvl(round(dl_leg.t_cost/dl_leg.t_principal,6),0) 
                          else round(rsi_rsb_fiinstr.convsum(round(dl_leg.t_cost/dl_leg.t_principal,6),dl_leg.t_cfi,0,dl_tick.t_dealdate),6) 
                     end t_costrur, 
                     case when dl_leg.t_cfi = 0 then nvl(dl_leg.t_totalcost,0) 
                          else round(rsi_rsb_fiinstr.convsum(dl_leg.t_totalcost,dl_leg.t_cfi,0,dl_tick.t_dealdate),6) 
                     end t_totalcostrur,
                     nvl(round(dl_leg.t_cost,6),0) t_dvalue,/*GAA:496249*/
                     case when dl_leg.t_cfi = 0 then nvl(round(dl_leg.t_cost,6),0) 
                          else round(rsi_rsb_fiinstr.convsum(round(dl_leg.t_cost,6),dl_leg.t_cfi,0,dl_tick.t_dealdate),6) 
                     end t_dvaluerur, /*GAA:496249*/
                     case when regexp_like(oprkoper.t_systypes, '[v]') then 'поставка против платежа'/*'предпоставка' */
                          when regexp_like(oprkoper.t_systypes, '[X]') then 'поставка против платежа'/*GAA:496620 */
                          when regexp_like(oprkoper.t_systypes, '[Z]') then 'Зачисление на счет'/* BIQ-5485 */
                          when regexp_like(oprkoper.t_systypes, '[G]') then 'Списание со счета'/*BIQ-5485 */
                          else lower(nvl(conftp.t_contens,chr(1))) 
                     end t_conftp,
                     case when regexp_like(oprkoper.t_systypes, '[v]') then 'поставка' 
                          else 'неттинг' 
                     end t_execmethod,
                     case when regexp_like(oprkoper.t_systypes, '[v]') then 'платежное поручение в формате SWIFT' 
                          else 'платежное поручение' 
                     end t_formpayment,
                     case when regexp_like(oprkoper.t_systypes, '[v]') then case /*GAA:495698,495699*/ when dl_tick.t_clientid = -1 then  dl_tick.t_dealcode  /*GAA*/
                                                                                 when dl_tick.t_dealcodets = chr(1) then dl_tick.t_dealcode 
                                                                                 else dl_tick.t_dealcodets end 
                          else chr(1) 
                     end t_ordernumber,
                     nvl(paycurrency.t_ccy,chr(1)) t_curpfi,
                     dlcontr.t_dlcontrid t_dlcontrid,
                     dl_tick.t_clientid,
                     case when regexp_like(oprkoper.t_systypes, '[K]') then 1 else 0 end t_isBasket,/*GAA:495699*/
                     dl_tick.T_USERFIELD1,/*GAA: 495919*/
                     case when dl_leg.T_REJECTDATE != to_date ('01.01.0001','dd.mm.yyyy') then 1 else 0 end REJECT_DEAL, /*GAA:503363 Отказ от исполнения сделки */
                     case when dl_tick.t_bofficekind = 101 /*DL_SECURITYDOC*/ 
                               AND RSB_SECUR.GetMainObjAttr(101, LPAD(dl_tick.t_dealid, 34, '0'), 116, dl_tick.t_dealdate) = 1
                          THEN 'Принудительное закрытие позиций' ELSE '' END AS t_note --Biq-9103
              from ddl_tick_dbt dl_tick
              join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dl_tick.t_dealtype and
                                             -- Покупка/Продажа
                                             regexp_like(oprkoper.t_systypes, '[B|S|Z|G]') /*GAA:496240  +G*/
              join (select ? bdt, ? edt from dual) on 1=1
              join ddl_leg_dbt dl_leg on dl_leg.t_dealid = dl_tick.t_dealid and 
                                         dl_leg.t_legid = 0 and 
                                         dl_leg.t_legkind in (0,2)  
              left join dparty_dbt market on market.t_partyid = dl_tick.t_marketid AND (rsb_secur.IsOTC(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(dl_tick.t_DealType,dl_tick.t_BofficeKind)))=0)
              left join ddlcontrmp_dbt dlcontrmp on dlcontrmp.t_sfcontrid = dl_tick.t_clientcontrid
              left join ddlcontr_dbt dlcontr on dlcontr.t_dlcontrid = dlcontrmp.t_dlcontrid
              left join dsfcontr_dbt sfcontr on sfcontr.t_id = dlcontr.t_sfcontrid   
              left join dparty_dbt client on client.t_partyid = dl_tick.t_clientid
              left join dpersn_dbt clientp on clientp.t_personid = dl_tick.t_clientid
              left join dcountry_dbt clientc on (clientc.t_parentcountryid = 0 AND clientc.t_codelat3 = client.t_nrcountry) /* MAA: iS - 517711 */
              left join dparty_dbt contragent on contragent.t_partyid = dl_tick.t_partyid
              left join dfininstr_dbt fininstr on fininstr.t_fiid = dl_tick.t_pfi
              left join davoiriss_dbt avoiriss on avoiriss.t_fiid = dl_tick.t_pfi
              left join davrkinds_dbt avrkinds on avrkinds.t_fi_kind = fininstr.t_fi_kind and 
                                                  avrkinds.t_avoirkind = fininstr.t_avoirkind 
              left join davrkinds_dbt avrkindsroot on avrkindsroot.t_fi_kind = fininstr.t_fi_kind and 
                                                      avrkindsroot.t_avoirkind = rsb_fiinstr.fi_avrkindsgetroot(fininstr.t_fi_kind, fininstr.t_avoirkind)
              left join dparty_dbt issuer on issuer.t_partyid = fininstr.t_issuer
              left join dfininstr_dbt currency on currency.t_fiid = dl_leg.t_cfi 
              left join dtypeac_dbt conftp on conftp.t_inumtype = 155 and 
                                              conftp.t_type_account = dl_tick.t_conftpid
              left join dfininstr_dbt paycurrency on paycurrency.t_fiid = dl_leg.t_payfiid
              where dl_tick.t_bofficekind in (###,###,####) and
                    (dl_tick.t_dealdate between bdt and edt or
                    (dl_tick.t_dealdate < bdt and rsb_brkrep_u.GetPlanExecDate(dl_tick.t_bofficekind, dl_tick.t_dealid, decode(dl_leg.t_legkind, 0, 1, 2)) >= bdt))
              --and rownum = 1
              --and dl_tick.t_dealdate between :dt1 and :dt2
              --and t_dealcodets = '2850150747'
              --and dl_tick.t_dealid = 305919--in (328922,328929)--213302--93397
              --and dlcontr.t_sfcontrid = 24986
        ) dt
        order by dt.t_isbank, dt.t_dealdate, dt.t_dealtime, dt.t_dealid
      ](101,117,127);
      m_cmd = RsdCommand(EndCaptureOutput());
     
      m_cmd.AddParam("dt1", RSDBP_IN, m_BeginDate);
      m_cmd.AddParam("dt2", RSDBP_IN, m_End_Date);
      m_cmd.Execute();
      m_RS = TRsbDataSet(m_cmd);
      row1 = 11;
      cnt = 0;
      var RestP_Fact, RestP_Plan;
      var RestM_Fact = tarray(), RestM_Plan = tarray(), RestM_Cur = tarray(), RestM_TurnD = tarray(), RestM_TurnC = tarray();
      var B_firootname = tarray(), B_finame = tarray(), B_lsin = tarray(), B_issuername = tarray(), B_cost = tarray(), B_currencyname = tarray(), B_costrur = tarray(), B_principal = tarray();/*GAA:495699*/
      var iRest;
      var flagbreak = false;
      while(m_RS.movenext)
        if(m_RS.value("t_isbank") != 0)
          flagbreak = true;
          break;
        end;
        if(cnt == 0)
          InitProgress(int(m_RS.value("t_cnt")), "Ждите...", "Клиентские сделки");
        end;
        /*Считаем остатки ценных бумаг*/
        GetRestsP(m_RS.value("clientid"), m_RS.value("clientcontrid"), m_RS.value("pfi"), m_RS.value("dealid"), date(m_RS.value("dealdate")), time(m_RS.value("t_dealtime")), m_RS.value("t_dealpart"), @RestP_Fact, @RestP_Plan);
        /*Считаем остатки дережных средств*/
        GetRestsM(m_RS.value("clientid"), m_RS.value("clientcontrid"), m_RS.value("dealid"), date(m_RS.value("dealdate")), time(m_RS.value("t_dealtime")), m_RS.value("t_dealpart"), @RestM_Fact, @RestM_Plan, @RestM_Cur, @RestM_TurnD, @RestM_TurnC);
        /*Строка отчета*/
        SetGlobalParameter("SetCellFormat", false);
        PrintTableLine(
              /* 1*/ "row1_1", m_RS.value("t_dealcode"), null,
              /* 2*/ "row1_2", m_RS.value("t_dealdates"), null, 
              /* 3*/ "row1_3", m_RS.value("t_dealtime"), null, 
              /* 4*/ "row1_4", m_RS.value("t_marketname"), null, 
              /* 5*/ "row1_4a", iif( (m_RS.value("t_marketname") == "Внебиржа") AND (m_RS.value("t_isotc") == 0), "Внебиржевой рынок", "Фондовый рынок" ) + iif(valtype(m_RS.value("t_markettype"))!=V_UNDEF, ", Режим торгов: " + m_RS.value("t_markettype"),""), null, 
              /* 6*/ "row1_5", m_RS.value("t_sfcontrnumber"), null, 
              /* 7*/ "row1_6", date(m_RS.value("t_sfcontrbegdate")), null, 
              /* 8*/ "row1_7", date(m_RS.value("t_sfcontrenddate")), null, 
              /* 9*/ "row1_8", m_RS.value("t_clientname"), null, 
              /*10*/ "row1_9a", m_RS.value("t_proxyname"), null, 
              /*11*/ "row1_9", m_RS.value("t_proxynum"), null, 
              /*12*/ "row1_10", "АО \"РОССЕЛЬХОЗБАНК\"", null, 
              /*13*/ "row1_11", m_RS.value("t_side2name"), null, 
              /*14*/ "row1_11a", m_RS.value("t_genagr"), null, 
              /*15*/ "row1_12", m_RS.value("t_contragentname"), null, 
              /*16*/ "row1_13", m_RS.value("t_brokercomiss"), 6, 
              /*17*/ "row1_14", m_RS.value("t_dealtype"), null,
           //PD
              /*18*/ "row1_14a", m_RS.value("t_dealtypeAdr"), null,
//GAA  495676 
              /*19*/ "row1_15", m_RS.value("t_groundnumber"), null, 
//              /*16*/ "row1_16",iif( m_RS.value("t_groundnumber") == "",m_RS.value("t_dealcode"),m_RS.value("t_groundnumber")), null, 
              /*20*/ "row1_16", m_RS.value("t_side"), null, 
              /*21*/ "row1_17", m_RS.value("t_side2"), null, 
              /*22*/ "row1_18", m_RS.value("t_firootname"), null, 
              /*23*/ "row1_19", m_RS.value("t_finame"), null, 
              /*24*/ "row1_20", m_RS.value("t_lsin"), null, 
              /*25*/ "row1_21", m_RS.value("t_issuername"), null, 
              /*26*/ "row1_22", m_RS.value("t_cost"), 6, 
              /*27*/ "row1_23", m_RS.value("t_costpart2"), 6, 
              /*28*/ "row1_24", m_RS.value("t_currencyname"), null, 
              /*29*/ "row1_25", m_RS.value("t_costrur"), 6, 
              /*30*/ "row1_26", m_RS.value("t_costpart2rur"), 6, 
              /*31*/ "row1_27", m_RS.value("t_incomerate"), 6, 
              /*32*/ "row1_28", m_RS.value("t_principal"), 6, 
              /*33*/ "row1_29", m_RS.value("t_totalcost"), 6, 
              /*34*/ "row1_30", m_RS.value("t_totalcostrur"), 6,
              /*35*/ "row1_70", m_RS.value("t_dvalue"), 6,//GAA:496249 
              /*36*/ "row1_71", m_RS.value("t_dvaluerur"), 6,//GAA:496249
              /*37*/ "row1_31", m_RS.value("t_currencyname2"), null, 
              /*38*/ "row1_32", date(m_RS.value("t_plandatesp")), null, 
              /*39*/ "row1_33", iif (m_RS.value("REJECT_DEAL"),"", date(m_RS.value("t_factdatesp"))), null, /*GAA: 503363*/
              /*40*/ "row1_34", date(m_RS.value("t_plandatem")), null, 
              /*41*/ "row1_35", iif (m_RS.value("REJECT_DEAL"),"", date(m_RS.value("t_factdatem"))), null,  /*GAA: 503363*/
              /*42*/ "row1_36", m_RS.value("t_ordernumber"), null, 
              /*43*/ "row1_37", m_RS.value("t_clientform"), null, 
              /*44*/ "row1_38", m_RS.value("t_clientcountry"), null, 
              /*45*/ "row1_39", m_RS.value("t_clientresident"), null, 
              /*46*/ "row1_40", m_RS.value("t_clientcvalinv"), null, 
              /*47*/ "row1_41", m_RS.value("t_risklevel"), null, 
              /*48*/ "row1_42", m_RS.value("t_conftp"), null, 
              /*49*/ "row1_43", m_RS.value("t_execmethod"), null, 
              /*50*/ "row1_44", m_RS.value("t_formpayment"), null, 
              /*51*/ "row1_45", m_RS.value("t_bankrole"), null, 
              /*52*/ "row1_46", date(m_RS.value("t_grounddate")), null, 
              /*53*/ "row1_47", m_RS.value("t_ispfi"), null, 
              /*54*/ "row1_48", m_RS.value("t_cashright"), null, 
              /*55*/ "row1_49", RestP_Fact, 2, 
              /*56*/ "row1_50", RestP_Plan, 2, 
              /*57*/ "row1_51", RestM_Fact[0], 2, 
              /*58*/ "row1_52", RestM_Plan[0], 2, 
              /*59*/ "row1_53", RestM_Cur[0], null, 
              /*60*/ "row1_54", RestM_TurnD[0], 2, 
              /*61*/ "row1_55", m_RS.value("t_avrsumcom"), 2, 
              /*62*/ "row1_56", RestM_TurnC[0], 2, 
              /*63*/ "row1_57", m_RS.value("t_avrsumreq"), 2, 
              /*64*/ "row1_58", "документы получены", null, 
              /*65*/ "row1_59", "", null, 
              /*66*/ "row1_60", "", null,
              /*66*/ "row1_61", m_RS.value("t_note"), null);
        row = row + 1;
        iRest = 1;
        while(iRest < RestM_Fact.size)
          SetGlobalParameter("SetCellFormat", false);
          PrintTableLine(
                /* 1*/ "row1_1", m_RS.value("t_dealcode"), null,
                /* 2*/ "row1_2", "", null, 
                /* 3*/ "row1_3", "", null, 
                /* 4*/ "row1_4", "", null, 
                /* 5*/ "row1_4a", "", null, 
                /* 6*/ "row1_5", "", null, 
                /* 7*/ "row1_6", "", null, 
                /* 8*/ "row1_7", "", null, 
                /* 9*/ "row1_8", "", null, 
                /*10*/ "row1_9a", "", null, 
                /*11*/ "row1_9", "", null, 
                /*12*/ "row1_10", "", null, 
                /*13*/ "row1_11", "", null, 
                /*14*/ "row1_11a", "", null, 
                /*15*/ "row1_12", "", null, 
                /*16*/ "row1_13", "", null, 
                /*17*/ "row1_14", "", null, 
                /*18*/ "row1_14a", "", null, 
                /*19*/ "row1_15", "", null, 
                /*20*/ "row1_16", "", null, 
                /*21*/ "row1_17", "", null, 
                /*22*/ "row1_18", "", null, 
                /*23*/ "row1_19", "", null, 
                /*24*/ "row1_20", "", null, 
                /*25*/ "row1_21", "", null, 
                /*26*/ "row1_22", "", null, 
                /*27*/ "row1_23", "", null, 
                /*28*/ "row1_24", "", null, 
                /*29*/ "row1_25", "", null, 
                /*30*/ "row1_26", "", null, 
                /*31*/ "row1_27", "", null, 
                /*32*/ "row1_28", "", null, 
                /*33*/ "row1_29", "", null, 
                /*34*/ "row1_30", "", null,
                /*35*/ "row1_70", "", null,//GAA:496249 
                /*36*/ "row1_71", "", null,//GAA:496249 
                /*37*/ "row1_31", "", null, 
                /*38*/ "row1_32", "", null, 
                /*39*/ "row1_33", "", null, 
                /*40*/ "row1_34", "", null, 
                /*41*/ "row1_35", "", null, 
                /*42*/ "row1_36", "", null, 
                /*43*/ "row1_37", "", null, 
                /*44*/ "row1_38", "", null, 
                /*45*/ "row1_39", "", null, 
                /*46*/ "row1_40", "", null, 
                /*47*/ "row1_41", "", null, 
                /*48*/ "row1_42", "", null, 
                /*49*/ "row1_43", "", null, 
                /*50*/ "row1_44", "", null, 
                /*51*/ "row1_45", "", null, 
                /*52*/ "row1_46", "", null, 
                /*53*/ "row1_47", "", null, 
                /*54*/ "row1_48", "", null, 
                /*55*/ "row1_49", RestP_Fact, 2, 
                /*56*/ "row1_50", RestP_Plan, 2, 
                /*57*/ "row1_51", RestM_Fact[iRest], 2, 
                /*58*/ "row1_52", RestM_Plan[iRest], 2, 
                /*59*/ "row1_53", RestM_Cur[iRest], null, 
                /*60*/ "row1_54", RestM_TurnD[iRest], 2, 
                /*61*/ "row1_55", m_RS.value("t_avrsumcom"), 2, 
                /*62*/ "row1_56", RestM_TurnC[iRest], 2, 
                /*63*/ "row1_57", m_RS.value("t_avrsumreq"), 2, 
                /*64*/ "row1_58", "", null, 
                /*65*/ "row1_59", "", null, 
                /*66*/ "row1_60", "", null,
                /*67*/ "row1_61", "", null);
          iRest = iRest + 1;
          row = row + 1;
        end;
        cnt = cnt + 1;
        UseProgress(cnt);
      end;
      if(cnt > 0)
        RemProgress();
        this.GroupRows(row1, row + row1 - 1);
      end;
      EndTable();
  
      RegisterTable( "row3_0", "",
              /* 1*/ "row3_1", 
              /* 2*/ "row3_2", 
              /* 3*/ "row3_3", 
              /* 4*/ "row3_4", 
              /* 5*/ "row3_4a", 
              /* 6*/ "row3_5", 
              /* 7*/ "row3_6", 
              /* 8*/ "row3_7", 
              /* 9*/ "row3_8", 
              /*10*/ "row3_9a", 
              /*11*/ "row3_9", 
              /*12*/ "row3_10", 
              /*13*/ "row3_11", 
              /*14*/ "row3_11a",
              /*15*/ "row3_12", 
              /*16*/ "row3_13", 
              /*17*/ "row3_14", 
              /*18*/ "row3_14a", 
              /*19*/ "row3_15", 
              /*20*/ "row3_16", 
              /*21*/ "row3_17", 
              /*22*/ "row3_18", 
              /*23*/ "row3_19", 
              /*24*/ "row3_20", 
              /*25*/ "row3_21", 
              /*26*/ "row3_22", 
              /*27*/ "row3_23",
              /*28*/ "row3_24",
              /*29*/ "row3_25",
              /*30*/ "row3_26",
              /*31*/ "row3_27",
              /*32*/ "row3_28",
              /*33*/ "row3_29",
              /*34*/ "row3_30",
              /*35*/ "row3_70",//GAA:496249 
              /*36*/ "row3_71",//GAA:496249 
              /*37*/ "row3_31",
              /*38*/ "row3_32",
              /*39*/ "row3_33",
              /*40*/ "row3_34",
              /*41*/ "row3_35",
              /*42*/ "row3_36",
              /*43*/ "row3_37",
              /*44*/ "row3_38",
              /*45*/ "row3_39",
              /*46*/ "row3_40",
              /*47*/ "row3_41",
              /*48*/ "row3_42",
              /*49*/ "row3_43",
              /*50*/ "row3_44",
              /*51*/ "row3_45",
              /*52*/ "row3_46",
              /*53*/ "row3_47",
              /*54*/ "row3_48",
              /*55*/ "row3_49",
              /*56*/ "row3_50",
              /*57*/ "row3_51",
              /*58*/ "row3_52",
              /*59*/ "row3_53",
              /*60*/ "row3_54",
              /*61*/ "row3_55",
              /*62*/ "row3_56",
              /*63*/ "row3_57",
              /*64*/ "row3_58",
              /*65*/ "row3_59",
              /*66*/ "row3_60",
              /*66*/ "row3_61");
      StartCaptureOutput();
      [
        select count(1) over() t_cnt,
               dt.t_clientcontrid clientcontrid,
               dt.t_clientid clientid,
               dt.t_sfcontrnumber,
               dt.t_sfcontrbegdate,
               dt.t_sfcontrenddate,
               case when dt.t_clientcode != chr(1) then
                 (CASE WHEN dt.t_sfcontrname = CHR (1) THEN dt.t_clientname   --GAA:501246 
                       ELSE NVL (dt.t_sfcontrname, dt.t_clientname) END)
                    ||' '||'/'||' '||dt.t_clientcode 
                    else nvl(dt.t_sfcontrname, dt.t_clientname) 
               end t_clientname,
               dt.t_clientform,
               dt.t_clientcountry,
               dt.t_clientresident,
               dt.t_clientcvalinv,
               dt.t_bankrole,
               dt.t_cashright,
               dt.t_risklevel,
               dt.t_proxyname,
               dt.t_proxynum,
               dt.sf_servkind,        /*GAA:501246 */
               dt.sf_servkindsub      /*GAA:502511 */
        from (select sfcontr.t_partyid t_clientid,
                     sfcontrmp.t_id t_clientcontrid,
                     sfcontr.t_number t_sfcontrnumber,
                     sfcontr.t_datebegin t_sfcontrbegdate,
                     sfcontr.t_dateclose t_sfcontrenddate,
                     sfcontr.t_name t_sfcontrname,
                     nvl(client.t_name,chr(1)) t_clientname,
                     (select OBJCODE.T_CODE from ddlobjcode_dbt objcode where objcode.t_objecttype = 207 and objcode.t_codekind =1 and objcode.t_objectid =DLCONTR.T_DLCONTRID) --GAA:495102 OLD:
                     /*case when max(dlcontrmp.t_mpcode) over(partition by dlcontrmp.t_dlcontrid) != chr(1) then max(dlcontrmp.t_mpcode) over(partition by dlcontrmp.t_dlcontrid) 
                          else (select nvl(max(objcode.t_code),chr(1)) 
                                from dobjcode_dbt objcode 
                                where objcode.t_objecttype = 3 and 
                                      objcode.t_codekind = 8 and 
                                      objcode.t_objectid = sfcontr.t_partyid and 
                                      objcode.t_bankdate <= edt and 
                                      (objcode.t_bankclosedate = to_date('01.01.0001','dd.mm.yyyy') or 
                                       objcode.t_bankclosedate > edt)) 
                     end*/
                     t_clientcode, 
                     case when client.t_legalform is null then chr(1) 
                          when client.t_legalform = 1 then 'ЮЛ' 
                          when nvl(clientp.t_isemployer,chr(0)) = chr(88) then 'ИП' 
                          else 'ФЛ' 
                     end t_clientform,
                     nvl(clientc.t_name, chr(1)) t_clientcountry,
                     case when client.t_notresident is null then chr(1) 
                          when client.t_notresident = chr(88) then 'нерезидент' 
                          else 'резидент' 
                     end t_clientresident,
                     case when exists(select 1 from dscqinv_dbt scqinv 
                                      where scqinv.t_partyid = sfcontr.t_partyid and 
                                            scqinv.t_state = 1 and 
                                            scqinv.t_regdate <= edt)
                            or exists(select 1 from dscqinvh_dbt scqinvh 
                                      where scqinvh.t_partyid = sfcontr.t_partyid and 
                                            scqinvh.t_state = 1 and 
                                            scqinvh.t_begdate <= edt and 
                                            scqinvh.t_enddate >= edt) 
                          then 'квалинвестор' 
                          else 'не квалинвестор' 
                     end t_clientcvalinv,
                     'поверенный' t_bankrole,
                     (select trim(lower(nvl(max(t_name),'право предоставлено'))) 
                      from dobjattr_dbt objattr, dobjatcor_dbt objatcor 
                      where objattr.t_objecttype = 207 and /*Договор брокерского обслуживания*/  
                            objattr.t_groupid = 102 and /*Право использования ДС Клиента Банком*/ 
                            objatcor.t_objecttype = objattr.t_objecttype and 
                            objatcor.t_groupid = objattr.t_groupid and 
                            objatcor.t_attrid = objattr.t_attrid and 
                            objatcor.t_object = lpad(dlcontr.t_dlcontrid, 34, '0') and 
                            objatcor.t_validfromdate <= edt and 
                            objatcor.t_validtodate > edt) t_cashright,
                     (select trim(lower(nvl(max(t_name),'отсутствует'))) 
                      from dobjattr_dbt objattr, dobjatcor_dbt objatcor 
                      where objattr.t_objecttype = 207 and /*Договор брокерского обслуживания*/  
                            objattr.t_groupid = 103 and /*Уровень риска клиента*/ 
                            objatcor.t_objecttype = objattr.t_objecttype and 
                            objatcor.t_groupid = objattr.t_groupid and 
                            objatcor.t_attrid = objattr.t_attrid and 
                            objatcor.t_object = lpad(dlcontr.t_dlcontrid, 34, '0') and 
                            objatcor.t_validfromdate <= edt and 
                            objatcor.t_validtodate > edt) t_risklevel,
                     nvl((select listagg(clientproxy.t_name, '/') within group (order by clientproxy.t_name, ptproxy.t_proxyid)
                          from dptproxy_dbt ptproxy
                          join dparty_dbt clientproxy on clientproxy.t_partyid =  ptproxy.t_proxyid
                          where ptproxy.t_partyid = sfcontr.t_partyid and
                                ptproxy.t_docdate <= edt and 
                                ptproxy.t_validitydate >= edt),chr(1)) t_proxyname,
                     nvl((select listagg(ptproxy.t_docnumber||' с '||to_char(ptproxy.t_docdate,'dd.mm.yyyy')||' по '||to_char(ptproxy.t_validitydate,'dd.mm.yyyy'), '/') within group (order by ptproxy.t_proxyid, ptproxy.t_proxyid)  
                          from dptproxy_dbt ptproxy
                          join dparty_dbt clientproxy on clientproxy.t_partyid =  ptproxy.t_proxyid
                          where ptproxy.t_partyid = sfcontr.t_partyid and
                                ptproxy.t_docdate <= edt and ptproxy.t_validitydate >= edt),chr(1)) t_proxynum,
                     sfcontrmp.t_servkind sf_servkind,
                     sfcontrmp.t_servkindsub sf_servkindsub   /*GAA:502511*/
              from ddlcontr_dbt dlcontr
              join (select ? bdt, ? edt from dual) on 1=1
              join dsfcontr_dbt sfcontr on sfcontr.t_id = dlcontr.t_sfcontrid   
              join ddlcontrmp_dbt dlcontrmp on dlcontrmp.t_dlcontrid = dlcontr.t_dlcontrid
              join dsfcontr_dbt sfcontrmp on sfcontrmp.t_id = dlcontrmp.t_sfcontrid and 
                                             sfcontrmp.t_servkind in (1, 15) --GAA:495102, OLD:"=1 "
              left join dparty_dbt client on client.t_partyid = sfcontr.t_partyid
              left join dpersn_dbt clientp on clientp.t_personid = sfcontr.t_partyid
              left join dcountry_dbt clientc on (clientc.t_parentcountryid = 0 AND clientc.t_codelat3 = client.t_nrcountry) /* MAA: iS - 517711 */
              where sfcontr.t_datebegin <= edt and 
                 -- sfcontr.t_id = 15602  and--GAA
                    (sfcontr.t_dateclose >= bdt or sfcontr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy'))) dt
        order by dt.t_clientname
      ];
      m_cmd_d = RsdCommand(EndCaptureOutput());
      m_cmd_d.AddParam("dt1", RSDBP_IN, m_BeginDate);
      m_cmd_d.AddParam("dt2", RSDBP_IN, m_End_Date);
      m_cmd_d.Execute();
      m_RS_d = TRsbDataSet(m_cmd_d);
      cnt = 0;
      cnta = 0;
      while(m_RS_d.movenext)
        if(cnt == 0)
          InitProgress(int(m_RS_d.value("t_cnt")), "Ждите...", "Клиентские договоры");
          UseProgress(cnt);
        end;
        /*Денежные средства по договору*/
        GetRestsAllM(m_RS_d.value("clientid"), m_RS_d.value("clientcontrid"), m_End_Date, @RestM_Fact, @RestM_Plan, @RestM_Cur);
        if(RestM_Cur.size == 0)
          RestM_Cur[0] = "";
          RestM_Fact[0] = 0;
          RestM_Plan[0] = 0;
        end;
        /*Строка отчета*/
        SetGlobalParameter("SetCellFormat", false);
        PrintTableLine(
              /* 1*/ "row3_1", "", null,
              /* 2*/ "row3_2", "", null, 
              /* 3*/ "row3_3", "", null, 
              /* 4*/ "row3_4", "", null, 
//              /* 5*/ "row3_4a", "Фондовый рынок" + iif(valtype(m_RS.value("t_markettype"))!=V_UNDEF, ", Режим торгов: " + m_RS.value("t_markettype"),""), null, 
//              /* 5*/ "row3_4a", IIF(m_RS_d.value("sf_servkind") == 1 ,"Фондовый рынок", "Срочный рынок") + iif(valtype(m_RS.value("t_markettype"))!=V_UNDEF, ", Режим торгов: " + m_RS.value("t_markettype"),""), null, 
              /* 5*/ "row3_4a", IIF(m_RS_d.value("sf_servkind") == 1, /*GAA: 502511*/iif (m_RS_d.value("sf_servkindsub") == 8, "Фондовый рынок","Внебиржевой рынок"), "Срочный рынок") + iif(valtype(m_RS.value("t_markettype"))!=V_UNDEF, ", Режим торгов: " + m_RS.value("t_markettype"),""), null, 
              /* 6*/ "row3_5", m_RS_d.value("t_sfcontrnumber"), null, //GAA: 501246 
              /* 7*/ "row3_6", date(m_RS_d.value("t_sfcontrbegdate")), null, 
              /* 8*/ "row3_7", date(m_RS_d.value("t_sfcontrenddate")), null, 
              /* 9*/ "row3_8", m_RS_d.value("t_clientname"), null, 
              /*10*/ "row3_9a", m_RS_d.value("t_proxyname"), null, 
              /*11*/ "row3_9", m_RS_d.value("t_proxynum"), null, 
              /*12*/ "row3_10", "", null, 
              /*13*/ "row3_11", "", null, 
              /*14*/ "row3_11a", "", null, 
              /*15*/ "row3_12", "", null, 
              /*16*/ "row3_13", 0, 6,
              /*17*/ "row3_14", "", null,
              /*18*/ "row3_14a", m_RS.value("t_dealtypeAdr"), null,
              /*19*/ "row3_15" , 0, 6,
              /*20*/ "row3_16", "", null,  
              /*21*/ "row3_17", "", null, 
              /*22*/ "row3_18", "", null, 
              /*23*/ "row3_19", "", null, 
              /*24*/ "row3_20", "", null, 
              /*25*/ "row3_21", "", null, 
              /*26*/ "row3_22", 0, 6,     //GAA: 497084
              /*27*/ "row3_23", 0, 6, 
              /*28*/ "row3_24", "", null, 
              /*29*/ "row3_25", 0, 6, 
              /*30*/ "row3_26", 0, 6, 
              /*31*/ "row3_27", 0, 6, 
              /*32*/ "row3_28", 0, 6, 
              /*33*/ "row3_29", 0, 6, 
              /*34*/ "row3_30", 0, 6, 
              /*35*/ "row3_70", 0, 6, // GAA:496249
              /*36*/ "row3_71", 0, 6, // GAA:496249
              /*37*/ "row3_31", "", null,//GAA: 497084 
              /*38*/ "row3_32", "", null, 
              /*39*/ "row3_33", "", null, 
              /*40*/ "row3_34", "", null, 
              /*41*/ "row3_35", "", null, 
              /*42*/ "row3_36", "", null, 
              /*43*/ "row3_37", m_RS_d.value("t_clientform"), null, //GAA: 497084 
              /*44*/ "row3_38", m_RS_d.value("t_clientcountry"), null, 
              /*45*/ "row3_39", m_RS_d.value("t_clientresident"), null,  
              /*46*/ "row3_40", m_RS_d.value("t_clientcvalinv"), null, 
              /*47*/ "row3_41", m_RS_d.value("t_risklevel"), null, 
              /*48*/ "row3_42", "", null, //GAA: 497084
              /*49*/ "row3_43", "", null, 
              /*50*/ "row3_44", "", null, 
              /*51*/ "row3_45", m_RS_d.value("t_bankrole"), null,  //GAA: 497084
              /*52*/ "row3_46", "", null,
              /*53*/ "row3_47", "", null, 
              /*54*/ "row3_48", m_RS.value("t_cashright"), null,   //GAA: 497084
              /*55*/ "row3_49", 0, 2, 
              /*56*/ "row3_50", 0, 2, 
              /*57*/ "row3_51", RestM_Fact[0], 2,  //GAA: 497084
              /*58*/ "row3_52", RestM_Plan[0], 2, 
              /*59*/ "row3_53", RestM_Cur[0], null,
              /*60*/ "row3_54", 0, 2, 
              /*61*/ "row3_55", 0, 2, 
              /*62*/ "row3_56", 0, 2, 
              /*63*/ "row3_57", 0, 2, 
              /*64*/ "row3_58", "", null,
              /*65*/ "row3_59", "", null, 
              /*66*/ "row3_60", "", null,
              /*67*/ "row3_61", "", null);
        row = row + 1;   
        iRest = 1;
        while(iRest < RestM_Cur.size)
          SetGlobalParameter("SetCellFormat", false);
          PrintTableLine(
                /* 1*/ "row3_1", "", null,
                /* 2*/ "row3_2", "", null, 
                /* 3*/ "row3_3", "", null, 
                /* 4*/ "row3_4", "", null, 
                /* 5*/ "row3_4a", "", null, 
                /* 6*/ "row3_5", "", null, 
                /* 7*/ "row3_6", "", null, 
                /* 8*/ "row3_7", "", null, 
                /* 9*/ "row3_8", "", null, 
                /*10*/ "row3_9a", "", null, 
                /*11*/ "row3_9", "", null, 
                /*12*/ "row3_10", "", null, 
                /*13*/ "row3_11", "", null, 
                /*14*/ "row3_11a", "", null, 
                /*15*/ "row3_12", "", null, 
                /*16*/ "row3_13", "", null, 
                /*17*/ "row3_14", "", null, 
                /*18*/ "row3_14a", "", null, 
                /*19*/ "row3_15", "", null, 
                /*20*/ "row3_16", "", null, 
                /*21*/ "row3_17", "", null, 
                /*22*/ "row3_18", "", null, 
                /*23*/ "row3_19", "", null, 
                /*24*/ "row3_20", "", null, 
                /*25*/ "row3_21", "", null, 
                /*26*/ "row3_22", "", null, 
                /*27*/ "row3_23", "", null, 
                /*28*/ "row3_24", "", null, 
                /*29*/ "row3_25", "", null, 
                /*30*/ "row3_26", "", null, 
                /*31*/ "row3_27", "", null, 
                /*32*/ "row3_28", "", null, 
                /*33*/ "row3_29", "", null,
                /*34*/ "row3_30", "", null, 
                /*35*/ "row3_70", "", null, // GAA:496249
                /*36*/ "row3_71", "", null, // GAA:496249
                /*37*/ "row3_31", "", null, 
                /*38*/ "row3_32", "", null, 
                /*39*/ "row3_33", "", null, 
                /*40*/ "row3_34", "", null, 
                /*41*/ "row3_35", "", null, 
                /*42*/ "row3_36", "", null, 
                /*43*/ "row3_37", "", null, 
                /*44*/ "row3_38", "", null, 
                /*45*/ "row3_39", "", null, 
                /*46*/ "row3_40", "", null, 
                /*47*/ "row3_41", "", null, 
                /*48*/ "row3_42", "", null, 
                /*49*/ "row3_43", "", null, 
                /*50*/ "row3_44", "", null, 
                /*51*/ "row3_45", "", null, 
                /*52*/ "row3_46", "", null, 
                /*53*/ "row3_47", "", null, 
                /*54*/ "row3_48", "", null, 
                /*55*/ "row3_49", "", null, 
                /*56*/ "row3_50", "", null,
                /*57*/ "row3_51", RestM_Fact[iRest], 2, //GAA: 497084
                /*58*/ "row3_52", RestM_Plan[iRest], 2, 
                /*59*/ "row3_53", RestM_Cur[iRest], null, 
                /*60*/ "row3_54", "", null, 
                /*61*/ "row3_55", "", null, 
                /*62*/ "row3_56", "", null, 
                /*63*/ "row3_57", "", null, 
                /*64*/ "row3_58", "", null, 
                /*65*/ "row3_59", "", null, 
                /*66*/ "row3_60", "", null,
                /*67*/ "row3_61", "", null);
          iRest = iRest + 1;
          cnta = cnta + 1;
          row = row + 1;   
        end;
        /*Ценные бумаги по договору*/
        GetRestsAllP(m_RS_d.value("clientid"), m_RS_d.value("clientcontrid"), m_End_Date, @RS_RestP);
        while(RS_RestP.movenext)
          SetGlobalParameter("SetCellFormat", false);
          PrintTableLine(
                /* 1*/ "row3_1", "", null,
                /* 2*/ "row3_2", "", null, 
                /* 3*/ "row3_3", "", null, 
                /* 4*/ "row3_4", "", null, 
                /* 5*/ "row3_4a", "", null, 
                /* 6*/ "row3_5", "", null, 
                /* 7*/ "row3_6", "", null, 
                /* 8*/ "row3_7", "", null, 
                /* 9*/ "row3_8", "", null, 
                /*10*/ "row3_9a", "", null, 
                /*11*/ "row3_9", "", null, 
                /*12*/ "row3_10", "", null, 
                /*13*/ "row3_11", "", null, 
                /*14*/ "row3_11a", "", null, 
                /*15*/ "row3_12", "", null, 
                /*16*/ "row3_13", "", null, 
                /*17*/ "row3_14", "", null, 
                /*18*/ "row3_14a", m_RS.value("t_dealtypeAdr"), null,
                /*19*/ "row3_15", "", null, 
                /*20*/ "row3_16", "", null, 
                /*21*/ "row3_17", "", null,
                /*22*/ "row3_18", RS_RestP.value("t_firootname"), null, //GAA:497084  
                /*23*/ "row3_19", RS_RestP.value("t_finame"), null,
                /*24*/ "row3_20", RS_RestP.value("t_lsin"), null,  
                /*25*/ "row3_21", RS_RestP.value("t_issuername"), null, 
                /*26*/ "row3_22", "", null, 
                /*27*/ "row3_23", "", null, 
                /*28*/ "row3_24", "", null, 
                /*29*/ "row3_25", "", null, 
                /*30*/ "row3_26", "", null, 
                /*31*/ "row3_27", "", null, 
                /*32*/ "row3_28", "", null, 
                /*33*/ "row3_29", "", null, 
                /*34*/ "row3_30", "", null, 
                /*35*/ "row3_70", "", null, // GAA:496249
                /*36*/ "row3_71", "", null, // GAA:496249
                /*37*/ "row3_31", "", null, 
                /*38*/ "row3_32", "", null, 
                /*39*/ "row3_33", "", null, 
                /*40*/ "row3_34", "", null, 
                /*41*/ "row3_35", "", null, 
                /*42*/ "row3_36", "", null, 
                /*43*/ "row3_37", "", null, 
                /*44*/ "row3_38", "", null, 
                /*45*/ "row3_39", "", null, 
                /*46*/ "row3_40", "", null, 
                /*47*/ "row3_41", "", null, 
                /*48*/ "row3_42", "", null, 
                /*49*/ "row3_43", "", null, 
                /*50*/ "row3_44", "", null, 
                /*51*/ "row3_45", "", null, 
                /*52*/ "row3_46", "", null, 
                /*53*/ "row3_47", "", null, 
                /*54*/ "row3_48", "", null,
                /*55*/ "row3_49", "", null,
                /*56*/ "row3_50", "", null, 
                /*57*/ "row3_51", RS_RestP.value("t_rest"), null, //GAA:497084
                /*58*/ "row3_52", RS_RestP.value("t_rest"), null, 
                /*59*/ "row3_53", "", null, 
                /*60*/ "row3_54", "", null, 
                /*61*/ "row3_55", "", null, 
                /*62*/ "row3_56", "", null, 
                /*63*/ "row3_57", "", null, 
                /*64*/ "row3_58", "", null, 
                /*65*/ "row3_59", "", null, 
                /*66*/ "row3_60", "", null,
                /*67*/ "row3_61", "", null);
          cnta = cnta + 1;
          row = row + 1;   
        end;
        cnt = cnt + 1;
        UseProgress(cnt);
      end;
      if(cnt > 0)
        RemProgress();
        this.GroupRows(row1 + (row - cnt - cnta) + 1, row + row1 - 1 + 1);
      end;
      EndTable();
     
      row2 = row1 + row + 1 + 1;
      row = 0;
      PrintFormatString("", "reportperiod", "с " + m_BeginDate + " по " + m_End_Date);
      RegisterTable( "row2_0", "",
              /* 1*/ "row2_1", 
              /* 2*/ "row2_2", 
              /* 3*/ "row2_3", 
              /* 4*/ "row2_4", 
              /* 5*/ "row2_4a", 
              /* 6*/ "row2_5", 
              /* 7*/ "row2_6", 
              /* 8*/ "row2_7", 
              /* 9*/ "row2_8", 
              /*10*/ "row2_9a", 
              /*11*/ "row2_9", 
              /*12*/ "row2_10", 
              /*13*/ "row2_11", 
              /*14*/ "row2_11a",
              /*15*/ "row2_12", 
              /*16*/ "row2_13", 
              /*17*/ "row2_14", 
              /*18*/ "row2_14a", 
              /*19*/ "row2_15", 
              /*20*/ "row2_16", 
              /*21*/ "row2_17", 
              /*22*/ "row2_18", 
              /*23*/ "row2_19", 
              /*24*/ "row2_20", 
              /*25*/ "row2_21", 
              /*26*/ "row2_22", 
              /*27*/ "row2_23",
              /*28*/ "row2_24",
              /*29*/ "row2_25",
              /*30*/ "row2_26",
              /*31*/ "row2_27",
              /*32*/ "row2_28",
              /*33*/ "row2_29",
              /*34*/ "row2_30",
              /*35*/ "row2_70", //GAA:496249
              /*36*/ "row2_71", //GAA:496249
              /*37*/ "row2_31",
              /*38*/ "row2_32",
              /*39*/ "row2_33",
              /*40*/ "row2_34",
              /*41*/ "row2_35",
              /*42*/ "row2_36",
              /*43*/ "row2_37",
              /*44*/ "row2_38",
              /*45*/ "row2_39",
              /*46*/ "row2_40",
              /*47*/ "row2_41",
              /*48*/ "row2_42",
              /*49*/ "row2_43",
              /*50*/ "row2_44",
              /*51*/ "row2_45",
              /*52*/ "row2_46",
              /*53*/ "row2_47",
              /*54*/ "row2_48",
              /*55*/ "row2_49",
              /*56*/ "row2_50",
              /*57*/ "row2_51",
              /*58*/ "row2_52",
              /*59*/ "row2_53",
              /*60*/ "row2_54",
              /*61*/ "row2_55",
              /*62*/ "row2_56",
              /*63*/ "row2_57",
              /*64*/ "row2_58",
              /*65*/ "row2_59",
              /*66*/ "row2_60",
              /*67*/ "row2_61");
      cnt = 0;
      while(flagbreak or m_RS.movenext)
        if(flagbreak)
          flagbreak = false;
        end;
        if(cnt == 0)
          InitProgress(int(m_RS.value("t_cnt")), "Ждите...", "Собственные сделки");
        end;
        /*Считаем остатки ценных бумаг*/
        GetRestsBankP(m_RS.value("pfi"), m_RS.value("dealid"), date(m_RS.value("dealdate")), time(m_RS.value("t_dealtime")), m_RS.value("t_dealpart"), @RestP_Fact, @RestP_Plan);
        /*Считаем остатки дережных средств*/
        GetRestsBankM(m_RS.value("dealid"), date(m_RS.value("dealdate")), m_RS.value("t_dealpart"), @RestM_Fact, @RestM_Plan, @RestM_Cur, @RestM_TurnD, @RestM_TurnC);
        /*GAA:495699*/
        if ( m_RS.value("t_isBasket") == 1)
           GetBasketAvr(m_RS.value("dealid"), m_End_Date, @B_firootname, @B_finame, @B_lsin, @B_issuername, @B_cost, @B_currencyname, @B_costrur, @B_principal);
        end;/**/
        /*Строка отчета*/
        SetGlobalParameter("SetCellFormat", false);
        PrintTableLine(
              /* 1*/ "row2_1", m_RS.value("t_dealcode"), null,
              /* 2*/ "row2_2", m_RS.value("t_dealdates"), null, 
              /* 3*/ "row2_3", m_RS.value("t_dealtime"), null, 
              /* 4*/ "row2_4", m_RS.value("t_marketname"), null, 
              /* 5*/ "row2_4a", iif( m_RS.value("t_marketname") == "Внебиржа", "Внебиржевой рынок", "Фондовый рынок" )  + iif(valtype(m_RS.value("t_markettype"))!=V_UNDEF, ", Режим торгов: " + m_RS.value("t_markettype"),""), null, 
              /* 6*/ "row2_5", m_RS.value("t_sfcontrnumber"), null, 
              /* 7*/ "row2_6", date(m_RS.value("t_sfcontrbegdate")), null, 
              /* 8*/ "row2_7", date(m_RS.value("t_sfcontrenddate")), null, 
              /* 9*/ "row2_8", m_RS.value("t_clientname"), null, 
              /*10*/ "row2_9a", "", null, 
              /*11*/ "row2_9", "", null, 
              /*12*/ "row2_10", "АО \"РОССЕЛЬХОЗБАНК\"", null, 
              /*13*/ "row2_11", m_RS.value("t_side2name"), null, 
              /*14*/ "row2_11a", m_RS.value("t_genagr"), null, 
              /*15*/ "row2_12", m_RS.value("t_contragentname"), null, 
              /*16*/ "row2_13", m_RS.value("t_brokercomiss"), 6, 
              /*17*/ "row2_14", m_RS.value("t_dealtype"), null, 
              /*18*/ "row2_14a", m_RS.value("t_dealtypeAdr"), null,
              /*19*/ "row2_15", m_RS.value("t_groundnumber"), null,
              /*20*/ "row2_16", m_RS.value("t_side"), null, 
              /*21*/ "row2_17", m_RS.value("t_side2"), null, 
              /*22*/ "row2_18", m_RS.value("t_firootname"), null, 
              /*23*/ "row2_19", m_RS.value("t_finame"), null, 
              /*24*/ "row2_20", m_RS.value("t_lsin"), null, 
              /*25*/ "row2_21", iif (m_RS.value("t_isBasket")==0, m_RS.value("t_issuername"), ""), null, //GAA: 495699 
              /*26*/ "row2_22", iif (m_RS.value("t_isBasket")==0, m_RS.value("t_cost"), ""), 6,          //GAA: 495699 
              /*27*/ "row2_23", m_RS.value("t_costpart2"), 6, 
              /*28*/ "row2_24", m_RS.value("t_currencyname"), null, 
              /*29*/ "row2_25", iif (m_RS.value("t_isBasket")==0, m_RS.value("t_costrur"), ""), 6,       //GAA: 495699 
              /*30*/ "row2_26", m_RS.value("t_costpart2rur"), 6, 
              /*31*/ "row2_27", m_RS.value("t_incomerate"), 6, 
              /*32*/ "row2_28", iif (m_RS.value("t_isBasket")==0, m_RS.value("t_principal"),""), 6,      //GAA: 495699
              /*33*/ "row2_29", m_RS.value("t_totalcost"), 6, 
              /*34*/ "row2_30", m_RS.value("t_totalcostrur"), 6,
              /*35*/ "row2_70", m_RS.value("t_dvalue"), 6,//GAA:496249 
              /*36*/ "row2_71", m_RS.value("t_dvaluerur"), 6,//GAA:496249 
              /*37*/ "row2_31", m_RS.value("t_currencyname2"), null, 
              /*38*/ "row2_32", date(m_RS.value("t_plandatesp")), null, 
              /*39*/ "row2_33", date(m_RS.value("t_factdatesp")), null, 
              /*40*/ "row2_34", date(m_RS.value("t_plandatem")), null, 
              /*41*/ "row2_35", date(m_RS.value("t_factdatem")), null, 
              /*42*/ "row2_36", m_RS.value("t_ordernumber"), null, 
              /*43*/ "row2_37", "", null, 
              /*44*/ "row2_38", "", null, 
              /*45*/ "row2_39", "", null, 
              /*46*/ "row2_40", "", null, 
              /*47*/ "row2_41", "", null, 
              /*48*/ "row2_42", m_RS.value("t_conftp"), null, 
              /*49*/ "row2_43", m_RS.value("t_execmethod"), null, 
              /*50*/ "row2_44", m_RS.value("t_formpayment"), null, 
              /*51*/ "row2_45", m_RS.value("t_bankrole"), null, 
              /*52*/ "row2_46", date(m_RS.value("t_grounddate")), null, 
              /*53*/ "row2_47", m_RS.value("t_ispfi"), null, 
              /*54*/ "row2_48", "", null, 
              /*55*/ "row2_49", RestP_Fact, 2, 
              /*56*/ "row2_50", RestP_Plan, 2, 
              /*57*/ "row2_51", RestM_Fact[0], 2, 
              /*58*/ "row2_52", RestM_Plan[0], 2, 
              /*59*/ "row2_53", RestM_Cur[0], null, 
              /*60*/ "row2_54", RestM_TurnD[0], 2, 
              /*61*/ "row2_55", m_RS.value("t_avrsumcom"), 2, 
              /*62*/ "row2_56", RestM_TurnC[0], 2, 
              /*63*/ "row2_57", m_RS.value("t_avrsumreq"), 2, 
              /*64*/ "row2_58", "документы получены", null, 
              /*65*/ "row2_59", "", null, 
              /*66*/ "row2_60", "", null,
              /*67*/ "row2_61", "", null);
        row = row + 1;
        iRest = 1;
        while(iRest < RestM_Fact.size)
          SetGlobalParameter("SetCellFormat", false);
          PrintTableLine(
                /* 1*/ "row2_1", "", null,
                /* 2*/ "row2_2", "", null, 
                /* 3*/ "row2_3", "", null, 
                /* 4*/ "row2_4", "", null, 
                /* 5*/ "row2_4a", "", null, 
                /* 6*/ "row2_5", "", null, 
                /* 7*/ "row2_6", "", null, 
                /* 8*/ "row2_7", "", null, 
                /* 9*/ "row2_8", "", null, 
                /*10*/ "row2_9a", "", null, 
                /*11*/ "row2_9", "", null, 
                /*12*/ "row2_10", "", null, 
                /*13*/ "row2_11", "", null, 
                /*14*/ "row2_11a", "", null, 
                /*15*/ "row2_12", "", null, 
                /*16*/ "row2_13", "", null, 
                /*17*/ "row2_14", "", null, 
                /*18*/ "row2_14a", "", null, 
                /*19*/ "row2_15", "", null, 
                /*20*/ "row2_16", "", null, 
                /*21*/ "row2_17", "", null, 
                /*22*/ "row2_18", "", null, 
                /*23*/ "row2_19", "", null, 
                /*24*/ "row2_20", "", null, 
                /*25*/ "row2_21", "", null, 
                /*26*/ "row2_22", "", null, 
                /*27*/ "row2_23", "", null, 
                /*28*/ "row2_24", "", null, 
                /*29*/ "row2_25", "", null, 
                /*30*/ "row2_26", "", null, 
                /*31*/ "row2_27", "", null, 
                /*32*/ "row2_28", "", null, 
                /*33*/ "row2_29", "", null, 
                /*34*/ "row2_30", "", null, 
                /*35*/ "row2_70", "", null, //GAA:496249 
                /*36*/ "row2_71", "", null, //GAA:496249
                /*37*/ "row2_31", "", null, 
                /*38*/ "row2_32", "", null, 
                /*39*/ "row2_33", "", null, 
                /*40*/ "row2_34", "", null, 
                /*41*/ "row2_35", "", null, 
                /*42*/ "row2_36", "", null, 
                /*43*/ "row2_37", "", null, 
                /*44*/ "row2_38", "", null, 
                /*45*/ "row2_39", "", null, 
                /*46*/ "row2_40", "", null, 
                /*47*/ "row2_41", "", null, 
                /*48*/ "row2_42", "", null, 
                /*49*/ "row2_43", "", null, 
                /*50*/ "row2_44", "", null, 
                /*51*/ "row2_45", "", null, 
                /*52*/ "row2_46", "", null, 
                /*53*/ "row2_47", "", null, 
                /*54*/ "row2_48", "", null, 
                /*55*/ "row2_49", "", null, 
                /*56*/ "row2_50", "", null, 
                /*57*/ "row2_51", RestM_Fact[iRest], 2, 
                /*58*/ "row2_52", RestM_Plan[iRest], 2, 
                /*59*/ "row2_53", RestM_Cur[iRest], null, 
                /*60*/ "row2_54", RestM_TurnD[iRest], 2, 
                /*61*/ "row2_55", "", null, 
                /*62*/ "row2_56", RestM_TurnC[iRest], 2, 
                /*63*/ "row2_57", "", null, 
                /*64*/ "row2_58", "", null, 
                /*65*/ "row2_59", "", null, 
                /*66*/ "row2_60", "", null,
                /*67*/ "row2_61", "", null);
          iRest = iRest + 1;
          row = row + 1;
        end;
        var iEsn = 0;  /*GAA:495699*/
        while(iEsn < B_firootname.size)
          SetGlobalParameter("SetCellFormat", false);
          PrintTableLine(
                /* 1*/ "row2_1", "", null,
                /* 2*/ "row2_2", "", null, 
                /* 3*/ "row2_3", "", null, 
                /* 4*/ "row2_4", "", null, 
                /* 5*/ "row2_4a", "", null, 
                /* 6*/ "row2_5", "", null, 
                /* 7*/ "row2_6", "", null, 
                /* 8*/ "row2_7", "", null, 
                /* 9*/ "row2_8", "", null, 
                /*10*/ "row2_9a", "", null, 
                /*11*/ "row2_9", "", null, 
                /*12*/ "row2_10", "", null, 
                /*13*/ "row2_11", "", null, 
                /*14*/ "row2_11a", "", null, 
                /*15*/ "row2_12", "", null, 
                /*16*/ "row2_13", "", null, 
                /*17*/ "row2_14", "", null, 
                /*18*/ "row2_14a", "", null, 
                /*19*/ "row2_15", "", null, 
                /*20*/ "row2_16", "", null, 
                /*21*/ "row2_17", "", null, 
                /*22*/ "row2_18", B_firootname[iEsn], null, 
                /*23*/ "row2_19", B_finame[iEsn], null, 
                /*24*/ "row2_20", B_lsin[iEsn], null, 
                /*25*/ "row2_21", B_issuername[iEsn], null, 
                /*26*/ "row2_22", B_cost[iEsn], 6, 
                /*27*/ "row2_23", "", null, 
                /*28*/ "row2_24", B_currencyname[iEsn], null, 
                /*29*/ "row2_25", B_costrur[iEsn], 6, 
                /*30*/ "row2_26", "", null, 
                /*31*/ "row2_27", "", null, 
                /*32*/ "row2_28", B_principal[iEsn], 6, 
                /*33*/ "row2_29", "", null, 
                /*34*/ "row2_30", "", null,
                /*35*/ "row2_70", "", null, //GAA:496249 
                /*36*/ "row2_71", "", null, //GAA:496249 
                /*37*/ "row2_31", "", null, 
                /*38*/ "row2_32", "", null, 
                /*39*/ "row2_33", "", null, 
                /*40*/ "row2_34", "", null, 
                /*41*/ "row2_35", "", null, 
                /*42*/ "row2_36", "", null, 
                /*43*/ "row2_37", "", null, 
                /*44*/ "row2_38", "", null, 
                /*45*/ "row2_39", "", null, 
                /*46*/ "row2_40", "", null, 
                /*47*/ "row2_41", "", null, 
                /*48*/ "row2_42", "", null, 
                /*49*/ "row2_43", "", null, 
                /*50*/ "row2_44", "", null, 
                /*51*/ "row2_45", "", null, 
                /*52*/ "row2_46", "", null, 
                /*53*/ "row2_47", "", null, 
                /*54*/ "row2_48", "", null, 
                /*55*/ "row2_49", "", null, 
                /*56*/ "row2_50", "", null, 
                /*57*/ "row2_51", "", null, 
                /*58*/ "row2_52", "", null, 
                /*59*/ "row2_53", "", null, 
                /*60*/ "row2_54", "", null, 
                /*61*/ "row2_55", "", null, 
                /*62*/ "row2_56", "", null, 
                /*63*/ "row2_57", "", null, 
                /*64*/ "row2_58", "", null, 
                /*65*/ "row2_59", "", null, 
                /*66*/ "row2_60", "", null,
                /*67*/ "row2_61", "", null);
          iEsn = iEsn + 1;
          row = row + 1;
        end; /*GAA:495699*/
        cnt = cnt + 1;
        UseProgress(cnt);
      end;
      if(cnt > 0)
        RemProgress();
      end;
      if(row > 0)
        this.GroupRows(row2, row + row2 - 1);
      end;
      EndTable();     
    end;

  END;
  
 // initTX_RegistrReport(registeria_Panel(), "registeria.xlsx");
    initTX_RegistrReport(registeria_Panel(), "registeria.xlsx", NULL,NULL,NULL, TRUE);/*PDV 523573 печать отчета POI*/


END;

/*Точка входа*/
var r = registeria_Report();
r.InitReport("Реестр ВУ", null);
r.Run();

exit(1);

