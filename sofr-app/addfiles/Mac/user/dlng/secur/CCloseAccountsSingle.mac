/* Закрытие счетов 306 47423 и ВУ по закрытым договоарм*/
import RSD, globals;
import BankInter, dlquery, cb_sql, oralib, likepy;

private class CLog;
   private macro PrepareLog()
      if ( execSqlSelect ("select 1 from user_tables where upper(table_name) = upper('RSHB_CloseAccLog')").moveNext () )
        /*  if ( not execSql ("truncate table RSHB_CloseAccLog") )
              return false;
          end;*/
      else
          if ( not execSql ("create table RSHB_CloseAccLog (t_kind number not null, t_account varchar2(25),  t_text varchar2(4000), t_timestamp timestamp, t_oper number, t_operdate date) ") )
              return false;
          end;
      end;
      return true;
   end;

   Macro add ( kind, account, text )
       execSql ("insert into RSHB_CloseAccLog values (:1, :2, :3, systimestamp, :4, :5)", makeArray (sqlParam ("1", kind), sqlParam ("2", account), sqlParam ("3", text),sqlParam ("4", {oper}),sqlParam ("5", {curdate})));
   End;

   if (not PrepareLog() );
      msgbox("Ошибка инициализации логирования");
      exit(1);
   end;
end;


class CCloseContrAccountsSingle(_dlcontrid, _accountnumber)

   private var dlcontrid, accountnumber;

   private class ErrRec(_acc,_rest, _err)
      var err,rest,acc;
         acc  = _acc;
         err  = _err;
         rest = _rest;
   end;


   private  macro _doCloseAcc( acc, chapter, currency, CloseDate, ErrMsg)
      var stat, mes;
      var IsError = false;

      if( (stat=CB_CloseAccount(chapter, currency, acc, CloseDate , mes)) != 0 )
         if (strlen(mes) == 0)
            InitError();
            MemoryError(stat);
            mes = GetErrMsg();
         end;
         IsError = true;
      end;
      SetParm(5, mes);
      return not IsError;

      onError(er)
        SetParm(5, er.message);
        return not IsError;
   end;



   macro CloseAcc(ArErr:@TArray, ArLog:@TArray)
      var sql, cmd, rs, err;
      var sql2, cmd2, rs2;
      var Log = CLog();
      ArErr = TArray();
      ArLog = TArray();

         sql = 
      "select rownum,t.*, RSB_ACCOUNT.RESTALL(t.t_account, t.t_chapter, t.t_code_currency, "+GetSQLDate({curdate})+") rest  from ( " +
      "SELECT   " +
      "       a.t_open_close, " +
      "       a.t_close_date, " +
      "       (select t_ccy from dfininstr_dbt where t_fiid = a.t_code_currency) t_ccy, " +
      "       a.t_code_currency, " +
      "       sf.t_number, " +
      "       sf.t_id, " +
      "       sf.t_dateclose, " +
      "       sf.t_name, " +
      "       s.t_account, " +
      "       s.t_chapter, " +
      "       decode(s.t_chapter,1,'БУ',21,'ВУ ДС',22,'ВУ ЦБ') kind " +
      "  FROM dsettacc_dbt s, " +
      "       dsfssi_dbt ss, " +
      "       dsfcontr_dbt sf, " +
      "       daccount_dbt a " +
      " WHERE     s.t_settaccid = ss.t_setaccid " +
      "       AND ss.t_objecttype = 659 " +
      "       AND ss.t_objectid = sf.t_id " +
      "       AND a.t_account = s.t_account " +
      "       AND a.t_chapter = s.t_chapter " +
      "union all " +
      "SELECT a.t_open_close,        " +
      "       a.t_close_date, " +
      "       (select decode(t_ccy,chr(1),t_definition, t_ccy) t_ccy from dfininstr_dbt where t_fiid = a.t_code_currency) t_ccy, " +
      "       a.t_code_currency, " +
      "       sf.t_number, " +
      "       sf.t_id, " +
      "       sf.t_dateclose, " +
      "       sf.t_name, " +
      "       mc.t_account, " +
      "       mc.t_chapter, " +
      "       decode(a.t_chapter,1,'БУ',21,'ВУ ДС',22,'ВУ ЦБ') kind " +
      "  FROM dmcaccdoc_dbt mc, dsfcontr_dbt sf, daccount_dbt a " +
      " WHERE    " 
      "           mc.t_chapter in (21,22) " +
      "       AND mc.t_iscommon = CHR (88) " +
      "       AND sf.t_id = mc.t_clientcontrid " +
      "       AND a.t_account = mc.t_account " +
      "       AND a.t_chapter = mc.t_chapter " +
      "union all " +
      "SELECT a.t_open_close,        " +
      "       a.t_close_date, " +
      "       (select t_ccy from dfininstr_dbt where t_fiid = a.t_code_currency) t_ccy, " +
      "       a.t_code_currency, " +
      "       sf.t_number, " +
      "       sf.t_id, " +
      "       sf.t_dateclose, " +
      "       sf.t_name, " +
      "       mc.t_account, " +
      "       mc.t_chapter, " +
      "       decode(a.t_chapter,1,'БУ',21,'ВУ ДС',22,'ВУ ЦБ') kind " +
      "  FROM dmcaccdoc_dbt mc, dsfcontr_dbt sf, daccount_dbt a " +
      " WHERE     " 
      " t_catnum = 5087 " +
      "       AND mc.t_iscommon = CHR (88) " +
      "       AND sf.t_id = mc.t_clientcontrid " +
      "       AND a.t_account = mc.t_account " +
      "       AND a.t_chapter = mc.t_chapter "  +
      "           ) t "  +
      "    where  t.t_id in ( select t_sfcontrid from ddlcontrmp_dbt where t_dlcontrid =  :contrid ) and t.t_open_close <> 'З' ";
      sql = sql + " and t.t_account = :accnum ";
      sql = sql + "        order by t.t_dateclose" ;
      cmd = RSDCommand(sql);
      cmd.addParam("contrid", RSDBP_IN, dlcontrid);
      cmd.addParam("accnum", RSDBP_IN, accountnumber);
      rs = RSDRecordset(cmd);
      rs.movenext();
         sql2 = 
      "select rownum,t.*, RSB_ACCOUNT.RESTALL(t.t_account, t.t_chapter, t.t_code_currency, "+GetSQLDate({curdate})+") rest  from ( " +
      "SELECT   " +
      "       a.t_open_close, " +
      "       a.t_close_date, " +
      "       (select t_ccy from dfininstr_dbt where t_fiid = a.t_code_currency) t_ccy, " +
      "       a.t_code_currency, " +
      "       sf.t_number, " +
      "       sf.t_id, " +
      "       sf.t_dateclose, " +
      "       sf.t_name, " +
      "       s.t_account, " +
      "       s.t_chapter, " +
      "       decode(s.t_chapter,1,'БУ',21,'ВУ ДС',22,'ВУ ЦБ') kind " +
      "  FROM dsettacc_dbt s, " +
      "       dsfssi_dbt ss, " +
      "       dsfcontr_dbt sf, " +
      "       daccount_dbt a " +
      " WHERE     s.t_settaccid = ss.t_setaccid " +
      "       AND ss.t_objecttype = 659 " +
      "       AND ss.t_objectid = sf.t_id " +
      "       AND a.t_account = s.t_account " +
      "       AND a.t_chapter = s.t_chapter " +
      "union all " +
      "SELECT a.t_open_close,        " +
      "       a.t_close_date, " +
      "       (select decode(t_ccy,chr(1),t_definition, t_ccy) t_ccy from dfininstr_dbt where t_fiid = a.t_code_currency) t_ccy, " +
      "       a.t_code_currency, " +
      "       sf.t_number, " +
      "       sf.t_id, " +
      "       sf.t_dateclose, " +
      "       sf.t_name, " +
      "       mc.t_account, " +
      "       mc.t_chapter, " +
      "       decode(a.t_chapter,1,'БУ',21,'ВУ ДС',22,'ВУ ЦБ') kind " +
      "  FROM dmcaccdoc_dbt mc, dsfcontr_dbt sf, daccount_dbt a " +
      " WHERE    " 
      "           mc.t_chapter in (21,22) " +
      "       AND mc.t_iscommon = CHR (88) " +
      "       AND sf.t_id = mc.t_clientcontrid " +
      "       AND a.t_account = mc.t_account " +
      "       AND a.t_chapter = mc.t_chapter " +
      "union all " +
      "SELECT a.t_open_close,        " +
      "       a.t_close_date, " +
      "       (select t_ccy from dfininstr_dbt where t_fiid = a.t_code_currency) t_ccy, " +
      "       a.t_code_currency, " +
      "       sf.t_number, " +
      "       sf.t_id, " +
      "       sf.t_dateclose, " +
      "       sf.t_name, " +
      "       mc.t_account, " +
      "       mc.t_chapter, " +
      "       decode(a.t_chapter,1,'БУ',21,'ВУ ДС',22,'ВУ ЦБ') kind " +
      "  FROM dmcaccdoc_dbt mc, dsfcontr_dbt sf, daccount_dbt a " +
      " WHERE     " 
      " t_catnum = 5087 " +
      "       AND mc.t_iscommon = CHR (88) " +
      "       AND sf.t_id = mc.t_clientcontrid " +
      "       AND a.t_account = mc.t_account " +
      "       AND a.t_chapter = mc.t_chapter "  +
      "           ) t "  +
      "    where  t.t_id in ( select t_sfcontrid from ddlcontrmp_dbt where t_dlcontrid =  :contrid ) and t.t_open_close <> 'З' ";
      sql2 = sql2 + " and t.t_ccy = :ccy and t.t_number = :trnumber ";
      sql2 = sql2 + "        order by t.t_dateclose" ;
      cmd2 = RSDCommand(sql2);
      cmd2.addParam("contrid", RSDBP_IN, dlcontrid);
      cmd2.addParam("ccy", RSDBP_IN, rs.value(3));
      cmd2.addParam("trnumber", RSDBP_IN, rs.value(5));
      rs2 = RSDRecordset(cmd2);

         while ( rs2.movenext() )
            if (rs2.Value("rest") != 0)
               ArErr(ArErr.size) = ErrRec(rs2.Value("t_account"), rs2.Value("rest"), "Ненулевой остаток");
            end;
         end;

         rs2  = cmd2 = null;
         cmd2 = RSDCommand(sql2);
         cmd2.addParam("contrid", RSDBP_IN, dlcontrid);
         cmd2.addParam("ccy", RSDBP_IN, rs.value(3));
         cmd2.addParam("trnumber", RSDBP_IN, rs.value(5));
         rs2 = RSDRecordset(cmd2);
         if ( ArErr.size == 0 )
            while ( rs2.movenext() )
               if ( not _doCloseAcc (rs2.Value("t_account"), rs2.Value("t_chapter"), rs2.Value("t_code_currency"), SQL_ConvTypeDate(rs2.Value("t_dateclose")),err) )
                  Log.add(1, rs2.Value("t_account"), err);
                  ArErr(ArErr.size) = ErrRec(rs2.Value("t_account"), rs2.Value("rest"), err);
               else
                  Log.add(0, rs2.Value("t_account"), "Закрыт");
                  ArLog(ArLog.size) = ErrRec(rs2.Value("t_account"), 0, " Счет закрыт");
               end;
            end;
         end;

      rs = null;

      return ArErr.size;

   end;

  /*init*/

  dlcontrid = _dlcontrid;
  accountnumber = _accountnumber;

end;
