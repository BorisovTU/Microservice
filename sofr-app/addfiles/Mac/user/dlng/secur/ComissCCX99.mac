import "gtdlfun_u.mac", "gtdlfun.mac", "sp_categ.mac", "sp_car.mac";

   var DataOtherKlirArray = TArray();
   var imp_date = {curdate},datafilename_CCX99;
   var i = 0;
   var DlCOmmId = -1, FD;

  var  CurClirAccBuf = TRecHandler("account.dbt" );
  var  FiRole, FiRole_Other;

Private Macro GetDlCommID(RepDate)
    var Select, DataSet, Query;
    Query = "select * from ddl_comm_dbt where t_commdate = ? and t_fiid = -1 "
          + "  and t_dockind = 107 and t_partyofficeid = 7 and t_opersubkind = 1";
    Select = DL_RSDCommand(Query);
    Select.AddParam(RepDate);
    DataSet = Select.Execute(Query);
    if(DataSet.MoveNext())
       return DataSet.documentid; 
    end;
    return -1;
End;

private class DataMoneyMotion(_StatementAcc, _EntryCodeType, _EntryNumber, _EntryCorAcc, _EntryPurposePayment, _EntryRecName, _EntryDebit, _EntryCredit,
                                  _EntryDate, _EntryPayAcc, _EntryRecAcc, _ExtSettleCodeID, _OtherKlirAcc)
        var StatementAcc:string                             =   _StatementAcc,
        EntryCodeType:integer                               =   _EntryCodeType,
        EntryNumber:string                                  =   _EntryNumber,
        EntryCorAcc:string                                  =   _EntryCorAcc,
        EntryPurposePayment:string                          =   _EntryPurposePayment,
        EntryRecName:string                                 =   _EntryRecName,
        EntryDebit:money                                    =   _EntryDebit,
        EntryCredit:money                                   =   _EntryCredit,
        EntryDate:date                                      =   _EntryDate,
        EntryPayAcc:string                                  =   _EntryPayAcc,
        EntryRecAcc:string                                  =   _EntryRecAcc,
        ExtSettleCodeID:string                              =   _ExtSettleCodeID,
        OtherKlirAcc:string                                 =   _OtherKlirAcc;

    macro Init()
        OtherKlirAcc = EntryCorAcc = EntryPurposePayment = EntryPayAcc = EntryRecAcc = EntryRecName = "";
        EntryCodeType = EntryNumber = EntryDebit = EntryCredit = 0;
        EntryDate = date(0, 0, 0);
    end;

    macro InitRecords()
        StatementAcc = EntryCorAcc = EntryPurposePayment = EntryPayAcc = EntryRecName = "";
        EntryCodeType = EntryNumber = EntryDebit = EntryCredit = 0;
        EntryDate = date(0, 0, 0);
    end;
END;


private macro FileDate(date_val)
   var day, month, year;
   DateSplit(date_val,day,month,year);

   year = year - 1900;

   if( year >= 100 )
      year = year - 100;
   end;

   return RGDLFUN_LZ(day,2) + RGDLFUN_LZ(month,2) + RGDLFUN_LZ(year,2);
end;


/* настраиваемый пользователем макрос формирования
   имен файла котировок и сделок с госбумагами с ММВБ */
private macro get_data_file_name( folder:string, pfx:string, datafilepath:@string, datafilename:@string, comment_from_:string )
   var ErrStr = "";

   datafilepath = GetRegImportDir("MICEX",@ErrStr);

   if( (ErrStr != "") or (ErrStr == null) )
      /*RGLog.Message*/MsgBox( ErrStr );
      return 1;
   end;

   datafilepath = datafilepath + folder + "\\";
   datafilepath = GetRegImportDirU(imp_date, @ErrStr);
/*~ak*/

   var datafilemask = "???????_" + pfx + "_???_" + FileDate(imp_date) + "_?????????" + ".xml";
   var List = TDirList ( datafilepath + datafilemask, "f" );

   List.Sort(0);

   var comment_from = "";
   if(comment_from_)
      comment_from = comment_from_;
   end;

   if (List.Count == 0)
      datafilename = "";
/*ak - Если SEM25 или SEM26 не нашли, то и не будем считать это ошибкой*/
      if((pfx == "SEM25") or (pfx == "SEM26"))
         MsgBox("Не найден файл по маске " + datafilepath + datafilemask);
      else
/*~ak*/
      /*RGLog.Error*/MsgBox( comment_from + "Ошибка открытия файла данных. Не найден файл по маске " + datafilepath + datafilemask);
/*ak*/
      end;
/*~ak*/
      return 1;
   else
      datafilename = List.name(0);

   end;

end;

private macro GetInfoFromCCX99(DataArray:@TArray, datafilename_CCX99)
    var xml:object = ActiveX( "MSXML.DOMDocument" );
    var node:object, child_MicexDoc:object, child_CCX99:object, child_ExtSettleCode:object, child_Statement:object, child_Entry:object;
    var i = 0, j = 0, k = 0, l = 0;
    var stat = 0;
    var data_filepath_CCX99 = "", data_filename_CCX99 = ""/*ak, datafilename_CCX99 = ""~ak*/;
    var DOC_REQUISITES = false, CCX99 = false;
    var ID = 0, Debit = 0, EntryDate = date(0, 0, 0), CodeType = 0, Account = "", PurposePayment = "";
/*ak*/
    var Pay_Acc = "", Rec_Acc = "", Credit = 0, Number = "", Cor_Acc = "", RecName = "", res = true;
/*~ak*/

    var ExtSettleCodeID = "", ExtBuff = TRecHandler( "dl_extsettlecode.dbt" ); // Golovkin 24.04.20 ID : 509063 

    stat = get_data_file_name("MONEYX", "CCX99", @data_filepath_CCX99, @data_filename_CCX99);
    if(stat)
        return false;
    end;

    datafilename_CCX99 = data_filepath_CCX99 + data_filename_CCX99;

    if(GetDialogFlag())
        InitProgress(-1, "Поиск движений денежных средств для перевода с другого клирингового счета", "Просмотр данных...");
    end;

    if(not xml.load(datafilename_CCX99))
        /*RGLog.Error*/MsgBox( "Неверный формат файла импорта|", datafilename_CCX99, "|Невозможно загрузить xml-документ" );
        return false;
    end;

    node = xml.DocumentElement;
    i = 0;
    while(i < node.ChildNodes.Length)
        child_MicexDoc = node.childNodes.item(i);
        if(child_MicexDoc.tagname == "DOC_REQUISITES")
            if(DOC_REQUISITES)
                /*RGLog.Error*/MsgBox(string(datafilename_CCX99, ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
                return false;
            end;
            DOC_REQUISITES = true;
        end;

        if(child_MicexDoc.tagname == "CCX99")
            if(CCX99)
                /*RGLog.Error*/MsgBox(string(datafilename_CCX99, ": Блок MICEX_DOC\CCX99 должен присутствовать в единственном экземпляре"));
                return false;
            end;
            CCX99 = true;

            j = 0;
            while(j < child_MicexDoc.ChildNodes.Length)
                child_ExtSettleCode = child_MicexDoc.ChildNodes.item(j);
                if(child_ExtSettleCode.tagname == "EXTSETTLECODE")
                    ID = 0;
                    if(ReadTagAttribut(child_ExtSettleCode, "ID", V_INTEGER, ID) == false)

                    end;

                    if(ReadTagAttribut(child_ExtSettleCode, "ID", V_STRING, ExtSettleCodeID) == false)
                    end;

                    ExtBuff.clear();
                    if( FindDL_EXTSETTLECODEbyCode( ExtSettleCodeID, ExtBuff ) != 0 ) // Golovkin
                    end;

                    /*ak - Код должен быть либо нашим (01356 и 13385)
                           либо клиентским (06263,10120,10121,10122,10123,10124,10125,10126,11140,11139)*/
                    if((valtype(ID) == V_INTEGER) and ((ID ==  1356) or
                                                       (ID == 13385) or
                                                       (ID ==  6263) or
                                                       (ID == 10120) or
                                                       (ID == 10121) or
                                                       (ID == 10122) or
                                                       (ID == 10123) or
                                                       (ID == 10124) or
                                                       (ID == 10125) or
                                                       (ID == 10126) or
                                                       (ID == 11140) or
                                                       (ID == 11139) or
                                                       (ExtBuff.rec.MarketKind == DV_MARKETKIND_STOCK) // Golovkin 24.04.2020 ID : 509063
                                                       ))

                      k = 0;
                      while(k < child_ExtSettleCode.childNodes.Length)
                          child_Statement = child_ExtSettleCode.childNodes.item(k);
                          if(child_Statement.tagname == "STATEMENT")
                              Account = "";
                              if(ReadTagAttribut(child_Statement, "ACCOUNT", V_STRING, Account) == false)
                              end;

                              l = 0;
                              while(l < child_Statement.childNodes.Length)
                                  child_Entry = child_Statement.childNodes.item(l);
                                  CodeType = 0;
                                  Debit = $0.0;
                                  EntryDate = date(0, 0, 0);
                                  PurposePayment = "";
                                  /*ak*/
                                  Pay_Acc = "";
                                  Rec_Acc = "";
                                  RecName = "";
                                  Credit = $0.0;
                                  Number = "";
                                  Cor_Acc = "";
                                  /*~ak*/
                                  if(child_Entry.tagname == "ENTRY")
                                      if(ReadTagAttribut(child_Entry, "CODETYPE", V_INTEGER, CodeType) == false)
                                      end;
                                      /*10 и задан DEBIT*/
                                      if((valtype(CodeType) == V_INTEGER) and (CodeType == 10))

                                        if(ReadTagAttribut(child_Entry, "DEBIT", V_MONEY, Debit) == false)
                                        end;

                                        if((valtype(Debit) == V_MONEY) and (Debit > 0))

                                          if(ReadTagAttribut(child_Entry, "CREDIT", V_MONEY, Credit) == false)
                                          end;

                                          if(ReadTagAttribut(child_Entry, "PAY_ACC", V_STRING, Pay_Acc) == false)
                                          end;

                                          if(ReadTagAttribut(child_Entry, "REC_ACC", V_STRING, Rec_Acc) == false)
                                          end;

                                          if(ReadTagAttribut(child_Entry, "REC_NAME", V_STRING, RecName) == false)
                                          end;

                                          if(ReadTagAttribut(child_Entry, "NUMBER", V_STRING, Number) == false)
                                          end;

                                          if(ReadTagAttribut(child_Entry, "DATE", V_DATE, EntryDate) == false)
                                          end;

                                          if(ReadTagAttribut(child_Entry, "PURPOSE_PAYMENT", V_STRING, PurposePayment) == false)
                                          end;

                                          DataArray[DataArray.Size] = DataMoneyMotion(Account, 		/*_StatementAcc*/ 
                                                                                      CodeType, 	/*_EntryCodeType*/
                                                                                      Number, 		/*_EntryNumber*/
                                                                                      Cor_Acc, 		/*_EntryCorAcc*/
                                                                                      PurposePayment, 	/*_EntryPurposePayment*/
                                                                                      RecName,          /*_EntryRecName*/
                                                                                      Debit, 		/*_EntryDebit*/
                                                                                      Credit, 		/*_EntryCredit*/
                                                                                      EntryDate, 	/*_EntryDate*/
                                                                                      Pay_Acc, 		/*_EntryPayAcc*/
                                                                                      Rec_Acc, 		/*_EntryRecAcc*/
                                                                                      ID); 		/*_ExtSettleCodeID*/

                                        end;

                                      end;
                                      /*~ak*/

                                      /*ak - Все не так
                                      if((Debit > 0) and ((CodeType == 20) or (CodeType == 813)))
                                          DataArray[DataArray.Size] = DataMoneyMotion(Account, CodeType, 0, "", PurposePayment, Debit, $0.0, EntryDate, "", "", ID);
                                      end;~ak*/
                                  end;

                                  l = l + 1;
                              end;
                          end;

                          k = k + 1;
                      end;
                    end;
                end;

                j = j + 1;
            end;
        end;

        i = i + 1;
    end;

    if(GetDialogFlag())
        RemProgress();
    end;

    /*ak*/
     return res;
    /*~ak*/

OnError( RslErrObj )
   if(GetDialogFlag())
      RemProgress(); 
   end;

   MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
   RunError;
end;

   GetDate(imp_date, "Введите дату файла CCX99 для загрузки комиссий ");
   if(not GetInfoFromCCX99(@DataOtherKlirArray, datafilename_CCX99))
     return false;
   end; 
  
   i = 0;

   DlCOmmId =  GetDlCommID(imp_date);
   If(DlCOmmId != -1)
     FD = SPFirstDocDLCOMM( 0, dlcommid );
     GetSettlFiRoleByOperSubKind(FD.comm.rec.OperSubKind,@FiRole,@FiRole_Other);

     if( not FD.IsExistAccount( "Клиринговый счет", null, false, FiRole, CurClirAccBuf, null, FD.comm.rec.CommDate, 0 ) )
        return false;
     end;
      While (i < DataOtherKlirArray.size())

         if( not ПроводкаПоКатегориямУчета( FD, 
                                            "-КВ, ц/б2", "ОбязатПрочие1", /* КатегДеб , КатегКредит*/
                                            imp_date, /* Дата */
                                            1,                    /* Глава */
                                            0,                 /* Валюта */
                                            DataOtherKlirArray[i].entrydebit,                /* Сумма  */
                                            Doc,                  /* Документ */
                                            INPCARRY,             /* Result_Carry */
                                            " 1",                 /* Kind_Oper */
                                            "",                   /* Numb_Document */
                                            DataOtherKlirArray[i].entryrecname, null,null,null,
                                            0, 0     /* валюты счетов: Дт - Кт */ 
                                          )
           )
            return false;
         end;

         if( not ПроводкаПоКатегориямУчета( FD, 
                                            "ОбязатПрочие1", CurClirAccBuf, /* КатегДеб , КатегКредит*/
                                            imp_date, /* Дата */
                                            1,                    /* Глава */
                                            0,                 /* Валюта */
                                            DataOtherKlirArray[i].entrydebit,                /* Сумма  */
                                            Doc,                  /* Документ */
                                            INPCARRY,             /* Result_Carry */
                                            " 1",                 /* Kind_Oper */
                                            "",                   /* Numb_Document */
                                            DataOtherKlirArray[i].entrypurposepayment, null,null,null,
                                            0, 0     /* валюты счетов: Дт - Кт */ 
                                          )
           )
            return false;
         end;
         Println("Обработана запись по комиссии на сумму " + DataOtherKlirArray[i].entrydebit);
         i = i+1;
      end;
   end;


