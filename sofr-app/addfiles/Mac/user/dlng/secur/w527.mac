import BankInter, ReportUser;

PRIVATE CLASS (TX_ReportUser) W527_Report
  var m_Date;
  var m_DataExists = false,
      m_exitFlag   = false;

  /*Создание отчета*/
  PRIVATE MACRO Create()

    /*Точка входа*/
    var query = "";
    var m_DS;
    var errmsg;

    /*Отключаем все индикаторы*/
    if(m_UseTemplate)
      m_ObjTemplateXLS.SetFlagShowIndicator(false);
    else
      __BUG_Global_m_ObjTemplateXLS.SetFlagShowIndicator(false);
    end;
    m_ProgressIndicator = CreateProgressIndicator(true);

    m_Date = {curdate};
    if (not getDate(m_Date,"Дата формирования отчёта"));
      m_exitFlag = true;
      return false;
    end;

    /*Лист "Расшифровка сводных счетов"*/
    SetActiveSheet("Расшифровка сводных счетов");

    var curRate = 0;
    m_DS = RsdCommand("select RSI_RSB_FIInstr.ConvSum(1, 7, 0, :pDate1, 1) rate from dual");
    m_DS.AddParam(":pDate1", RSDBP_IN, date(m_Date));
    m_DS.Execute();
    m_RS = TRsbDataSet(m_DS);    
    if ((m_RS.MoveNext()) and (VALTYPE(m_RS.value("rate"))!=V_UNDEF))
      curRate = money(m_RS.value("rate"));
    end;

    PrintFormatString( "", "Rate", String(curRate));
    PrintFormatString( "", "Date", String(date(m_Date)));

    query = " select distinct t.t_account,"+
            "        acc.t_nameaccount,                                                            "+
            "        settacc.t_fiid,                                                               "+
            "        fininstr.t_iso_number t_currency,                                             "+
            "        nvl(abs(rsi_rsb_account.restall(settacc.t_account,                            "+
            "                                       settacc.t_chapter,                            "+
            "                                        settacc.t_fiid,                               "+
            "                                        :pDate1)),                                    "+
            "            0) t_rest,                                                                "+
            "        nvl(RSI_RSB_FIInstr.ConvSum(abs(rsi_rsb_account.restall(settacc.t_account,    "+
            "                                                                settacc.t_chapter,    "+
            "                                                                settacc.t_fiid,       "+
            "                                                                :pDate2)),            "+
            "                                    settacc.t_fiid,                                   "+
            "                                    0,                                                "+
            "                                    :pDate3,                                          "+
            "                                    1),                                               "+
            "            0) t_rest_nat_cur,                                                        "+
            "       settacc.t_partyid,                                                            "+
            "        settacc.t_recname t_client,                                                   "+
            "        nvl(objcode.t_code, chr(0)) t_inn,                                            "+
            "        nvl(case                                                                      "+
            "              when party.t_nrcountry = chr(1) then                                    "+
            "               chr(0)                                                                 "+
            "              else                                                                    "+
            "               party.t_nrcountry                                                      "+
            "            end,                                                                      "+
            "            chr(0)) t_country_code,                                                   "+
            "        case                                                                          "+
            "          when country.t_codenum3 = chr(1) then                                       "+
            "                                 chr(0)                                                 "+                    
            "          else                                                                        "+
            "           country.t_codenum3                                                         "+
            "        end t_country_code_num , party.t_legalform                                  "+                  
            "   from dsettacc_dbt settacc                                                      "+    
            "   join dsfssi_dbt sfssi                                                        "+      
            "     on sfssi.t_setaccid = settacc.t_settaccid                                "+        
            "   join dsfcontr_dbt sfcontr                                                "+          
            "     on sfcontr.t_id = TO_NUMBER(sfssi.t_objectid)                        "+            
            "    and sfssi.t_objecttype = 659                                        "+              
            "   join dfininstr_dbt fininstr                                        "+                
            "     on fininstr.t_fiid = settacc.t_fiid                            "+                  
            "   join daccount_dbt acc                                          "+                    
            "     on acc.t_chapter = settacc.t_chapter                       "+                      
            "    and acc.t_account = settacc.t_account                     "+                        
            "    and acc.t_code_currency = settacc.t_fiid                "+                          
            "   left outer join dobjcode_dbt objcode                   "+                            
            "     on objcode.t_objectid = settacc.t_partyid          "+                              
            "    and objcode.t_codekind = 16                       "+                                
            "   join dparty_dbt party                            "+                                  
            "     on party.t_partyid = settacc.t_partyid       "+                                    
            "   left outer join dcountry_dbt country          "+                                     
            "     on party.t_nrcountry = country.t_codelat3 "+
            "     left join dbrokacc_dbt t on t.t_servkind = sfcontr.t_servkind and t.t_servkindsub = sfcontr.t_servkindsub and t.t_currency =  fininstr.t_fiid                                     "+
            "  where sfcontr.t_datebegin <= :pDate4                                                "+
            "    and (sfcontr.t_dateclose = to_date('01.01.0001', 'dd.mm.yyyy') or                 "+
            "                        sfcontr.t_dateclose >= :pDate5 - 1)                            "+               
            "    and acc.t_balance in (30601, 30606) "+ 
            "    and party.t_legalform = 2 "+
            "    and  SFCONTR.T_SERVKIND <> 0 "+ 
            "    and   fininstr.t_fiid <> 0  "+			
            "  order by settacc.t_fiid, t.t_account, settacc.t_recname                     ";
    m_DS = RSDCommand(query);
    m_DS.AddParam(":pDate1", RSDBP_IN, m_Date);
    m_DS.AddParam(":pDate2", RSDBP_IN, m_Date);
    m_DS.AddParam(":pDate3", RSDBP_IN, m_Date);
    m_DS.AddParam(":pDate4", RSDBP_IN, m_Date);
    m_DS.AddParam(":pDate5", RSDBP_IN, m_Date);
    m_DS.Execute();
    m_RS = TRsbDataSet(m_DS);    

    RegisterTable( "ReportRow_1" , "",
                   "Field_1", 
                   "Field_2", 
                   "Field_3", 
                   "Field_4", 
                   "Field_5", 
                   "Field_6",
                   "Field_7",
                   "Field_8",
                   "Field_9",
                   "Field_10");
        
    var i = 1;
    while (m_RS.MoveNext())
      PrintTableLine(
        "Field_1", m_Rs.value("t_account"), null,     
        "Field_2", m_Rs.value("t_nameaccount"), null, 
        "Field_3", m_Rs.value("t_currency"), null,    
        "Field_4", m_Rs.value("t_rest"), null,        
        "Field_5", m_Rs.value("t_rest_nat_cur"), null,
        "Field_6", money(m_Rs.value("t_rest_nat_cur")/curRate), null,
        "Field_7", m_Rs.value("t_client"), null,       
        "Field_8", m_Rs.value("t_inn"), null,
        "Field_9", m_Rs.value("t_country_code"), null,
        "Field_10", m_Rs.value("t_country_code_num"), null);
      i = i + 1;
    end;
    EndTable();

    if (i > 1)            
      m_DataExists = true;
    end;    
  END;

  MACRO CReport_DataExist() 
    if (m_DataExists)
      return true; 
    else
      return false;
    end;
  END;

  MACRO CReport_NoDataMsg() 
    if ((not m_DataExists) and (not m_exitFlag))
      msgbox("Информация за указанную дату отсутствует.");
    end;
  END; 

  initTX_RegistrReport(NULL, "Report_W527.xls");
END;


/*Точка входа*/
var defprec = SetDefPrec(12);
var r = W527_Report();
r.InitReport("Расшифровка сводных счетов", null);
r.Run();
SetDefPrec(defprec);

SetExitFlag(1);
