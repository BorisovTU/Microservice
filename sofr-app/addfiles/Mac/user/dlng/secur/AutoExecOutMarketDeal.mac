import spinter, "sp_class.mac", "spserv.mac", Календарь;

      const TypeAction_DeferredPayment    = 12;
      const TypeAction_DeferredDelivery   = 13;
      const TypeAction_ExecDeferPayment   = 14;
      const TypeAction_ExecDeferDelivery  = 15;
      const pTraceCount = 2;

const real_date = date;
const cur_date = {curdate};

private macro getLastDayOfMonth( curDt:Date )
    var day, mon, year;

    DateSplit(curDt, day, mon, year);
    if( mon == 12 )
      return Date(1, 1, year + 1) - 1;
    else
      return Date(1, mon + 1, year) - 1;
    end;
end;

private macro getLastWorkDayOfMonth( curDt:Date )
   var res;

   res = GetLastDayOfMonth(curDt);
   if( not IsWorkDay(res) )
     res = GetDateAfterWorkDays(res, -1);
   end;
   return res;
end;

// проверка на наличие выполненого шага переоценки СС ПФИ
private macro IsVStepExec(DealID, factDt)
   var sql, cmd, rs;
   
   sql = " SELECT \* " +
"            FROM doprstep_dbt step  " +
"           WHERE step.t_id_operation = :DealID " +
"             AND step.t_isexecute = chr(88)  " +
"             AND step.t_symbol = 'V' and step.t_fact_date = :factDt " ;
   cmd = RSDCommand(sql);
   cmd.AddParam ("DealID", rsdbp_in, DealID);
   cmd.AddParam ("factDt", rsdbp_in, factDt);
   rs = RSDRecordset(cmd, rsdval_client, rsdval_static);
   
   if (rs.MoveNext())
     return 1;
   end;  

   return 0;

end;

macro dp_msgbox()
var str:string ="";
var i = 0, CellVal;
while( GetParm( i, CellVal) )
    if( str == "" )
      str = string(CellVal);
    else
      str = string(str) + string(CellVal);
    end;
    i = i + 1;
end;
if(str != "")
  //  println(str);
end

end;

// проверка на наличие у сделки готовых к исполнению шагов поставки/оплаты
private macro IsReadToExec(DealID)
   var sql, cmd, rs;
   
   sql = " SELECT \* " +
"            FROM doprstep_dbt step  " +
"           WHERE step.t_id_operation = :DealID " +
"             AND step.t_isexecute = 'R'  " +
"             AND step.t_symbol IN ('Т', 'О') and step.t_fact_date = to_date('01010001','ddmmyyyy') " ;
   cmd = RSDCommand(sql);
   cmd.AddParam ("DealID", rsdbp_in, DealID);
   rs = RSDRecordset(cmd, rsdval_client, rsdval_static);
   
   if (rs.MoveNext())
     return 1;
   end;  
 
   return 0;

end;


macro insert_log(p1,p2,p3,p4,p5)
 var sql = "insert into doutmarketexeclog_dbt values( users_OUTMARKETEXEC_seq.nextval, sysdate,+"+p1+","+p2+","+p3+","+p4+",'"+p5+"')";
 var dl_cmd =RSDCommand(sql);
/* dl_cmd.AddParam("",rsdbp_in,p1);
 dl_cmd.AddParam("",rsdbp_in,p2);
 dl_cmd.AddParam("",rsdbp_in,p3);
 dl_cmd.AddParam("",rsdbp_in,p4);*/
 dl_cmd.execute();
 sql = null; dl_cmd = null;
end;

//Добавление записи об ошибке при обработке сделки
private macro InsertErrRecord(DealID, Description, Trace_flag)
  var sql, cmd; 

  sql = "DECLARE " +
        "   p_dealid        NUMBER := :DealID ; " +
        "   p_trace_flag    NUMBER := :Trace_Flag; " +
        "   p_description   VARCHAR (150) := :Description; " +
        "   l_count         NUMBER; " +
        "BEGIN " +
        "   SELECT COUNT (1) " +
        "     INTO l_count " +
        "     FROM doutmarketexec_error_dbt derr " +
        "    WHERE derr.t_dealid = p_dealid; " +
        "   IF l_count = 0 " +
        "   THEN " +
        "      INSERT INTO doutmarketexec_error_dbt (t_dealid, t_last_exec_date, t_trace_count, t_description,t_err_status) " +
        "           VALUES (p_dealid, SYSDATE, 0, CHR (1), chr(88)); " +
        "   END IF; " +
        "  UPDATE doutmarketexec_error_dbt " +
        "      SET t_last_exec_date = SYSDATE, " +
        "          t_trace_count = CASE " +
        "                                     WHEN p_trace_flag = 1 THEN t_trace_count + 1 " +
        "                                     ELSE t_trace_count " +
        "                                 END, " +
        "          t_description = p_description, " +
        "          t_err_status = chr(88) " +
        "    WHERE t_dealid = p_dealid; " +
        "END; " ;

   cmd = RSDCommand(sql);
   cmd.AddParam ("DealID",      rsdbp_in, DealID);
   cmd.AddParam ("Trace_Flag",  rsdbp_in, Trace_Flag);
   cmd.AddParam ("Description", rsdbp_in, Description);
   cmd.Execute();

end;
//Удаление записи об ошибке
private macro ClearErrRecord(DealID)
  var sql,cmd, rs;
  sql = "delete from doutmarketexec_error_dbt where t_dealid = :DealID";
  cmd = RSDCommand(sql);
  cmd.AddParam("DealID", rsdbp_in, DealID);
  cmd.Execute(); 
end;

private macro GetTotalCost(AmountStr:String, CurCode:@string, Amount:@money)
   array ar;
   var str = substr(AmountStr,7);
   StrSplit ( str, ar,100 , 3 );
   CurCode = ar[0];
   Amount  = (ar[1]);
end;

private macro CheckConfirmStatus(DraftID, amount:@string, confirm_num:@string ) //DAN
  const DraftKind = 8;
  var query, Select, rs, Transport, Stat;
  var ConfNumber;
  var FactValueDate;
  var InstrStatus;
  var msg_txt;
  var TypeIN;

  query = "SELECT mtrec1.\*, " +
          "       (SELECT SUBSTR (str, 7, 10) " +
          "          FROM (    SELECT TO_CHAR (LTRIM (SUBSTR (txt, INSTR (txt, CHR (10), 1, LEVEL) + 1,   INSTR (txt, CHR (10), 1, LEVEL + 1) - INSTR (txt, CHR (10), 1, LEVEL) - 1))) str, " +
          "                             TO_CHAR ( REPLACE ( SUBSTR ( SUBSTR ( txt, INSTR (txt, ':70D:'), INSTR (SUBSTR (txt, INSTR (txt, ':70D:')), CHR (10) || ':')), 13), CHR (10))) f70D, typ " +
          "                      FROM (SELECT CHR (10) || str || CHR (10) txt, typ " +
          "                              FROM (SELECT str, TYPE typ " +
          "                                      FROM mtrec " +
          "                                     WHERE id_paym = mtrec1.id_paym)) " +
          "                CONNECT BY LEVEL <= LENGTH (txt) - LENGTH (REPLACE (txt, CHR (10))) - 1) " +
          "         WHERE str LIKE (':25D::%') AND ROWNUM = 1) t_confirm_status, " +
          "       (SELECT TO_CHAR ( TO_DATE (SUBSTR (str, 13, 14), 'yyyy.mm.dd hh24:mi:ss'), 'dd.mm.yyyy hh24:mi:ss') " +
          "          FROM (    SELECT TO_CHAR (LTRIM (SUBSTR (txt, INSTR (txt, CHR (10), 1, LEVEL) + 1,   INSTR (txt, CHR (10), 1, LEVEL + 1) - INSTR (txt, CHR (10), 1, LEVEL) - 1))) str, " +
          "                           TO_CHAR ( REPLACE ( SUBSTR ( SUBSTR ( txt, INSTR (txt, ':70D:'), INSTR (SUBSTR (txt, INSTR (txt, ':70D:')), CHR (10) || ':')), 13), CHR (10))) f70D, typ " +
          "                      FROM (SELECT CHR (10) || str || CHR (10) txt, typ " +
          "                              FROM (SELECT str, TYPE typ " +
          "                                      FROM mtrec " +
          "                                     WHERE id_paym = mtrec1.id_paym)) " +
          "                CONNECT BY LEVEL <= LENGTH (txt) " +
          "                              - LENGTH (REPLACE (txt, CHR (10))) - 1) " +
          "         WHERE str LIKE (':98_::PREP//%')) " +
          "          t_confirm_date, " +
          "       (SELECT p1.numreferdoc " +
          "          FROM paym p1 " +
          "         WHERE p1.id_paym = mtrec1.id_paym) " +
          "          T_CONFIRM_NUM, " +
          "       REPLACE ( (SELECT SUBSTR (str, 7)  " +
          "                    FROM ( (    SELECT TO_CHAR ( LTRIM ( SUBSTR (txt, INSTR (txt, CHR (10), 1, LEVEL) + 1, INSTR (txt, CHR (10), 1, LEVEL + 1) - INSTR (txt, CHR (10), 1, LEVEL) - 1)))str, " +
          "                                       TO_CHAR ( REPLACE (SUBSTR ( SUBSTR (txt, INSTR (txt, ':70D:'), INSTR ( SUBSTR ( txt, INSTR (txt, ':70D:')), CHR (10) || ':')), 13), CHR (10))) f70D, typ " +
          "                                  FROM (SELECT CHR (10) || str || CHR (10) txt, typ " +
          "                                          FROM (SELECT str, TYPE typ " +
          "                                                  FROM mtrec mtrec3 " +
          "                                                 WHERE mtrec3.id_paym = mtrec1.ID_Paym))  CONNECT BY LEVEL <= LENGTH (txt) - LENGTH (REPLACE (txt, CHR (10))) - 1)) ttabl " +
          "                   WHERE str LIKE (':19A::%')), ',', '.') t_amount " +
          "  FROM payass pass, " +
          "       pckpay pckpay1, " +
          "       pckpay pckpay2, " +
          "       mtrec mtrec1 " +
          " WHERE     pckpay1.id_paym = pass.id_paym " +
          "       AND PCKPAY2.ID_IPSPCK = PCKPAY1.ID_ipspck " +
          "       AND MTREC1.ID_PAYM = PCKPAY2.ID_paym " +
          "       AND pass.associate = TO_CHAR (:P_DRAFTID) " +
          "       AND pass.bankid = :P_DRAFTKIND " +
          "       AND pass.id_sass = " +
          "              RSP_COMMON.GET_ID_BY_CODE_DICT (P_TABLE => 'SASS', P_CODE => 3); " ;
 
  Select = RSDCommand( query );
  Select.AddParam("P_DRAFTID", rsdbp_in, DraftID); 
  Select.AddParam("P_DRAFTKIND", rsdbp_in, 8);
  rs = RSDRecordset(Select, rsdval_client, rsdval_static);
  while (rs.MoveNext())
    if ((rs.value("Type") != 548) and 
        (rs.value("Type") != 540) and
        (rs.value("Type") != 541) and 
        (rs.value("Type") != 542) and
        (rs.value("Type") != 543) and (rs.value("T_Amount") != ""))

           amount = rs.value("T_Amount");
           CONFIRM_NUM = rs.value("T_CONFIRM_NUM");
           return 1;

    end;
  end; 
  return 0;

  query = "begin\n ? := RSP_SECURITY.GetConfirmParams_ext(?,?,?,?,?,?,?,?,?);\n end; ";

  Select = RSDCommand( query );

  Select.AddParam("p_Stat", RSDBP_OUT, V_INTEGER );

  Select.AddParam("p_DraftKind", RSDBP_IN, DraftKind );
  Select.AddParam("p_DraftID", RSDBP_IN, DraftID );
  Select.AddParam("p_Number", RSDBP_OUT, V_STRING );
  Select.AddParam("p_Date", RSDBP_OUT, V_DATE );
  Select.AddParam("p_TypeIn", RSDBP_OUT, V_STRING );
  Select.AddParam("p_Status", RSDBP_OUT, V_STRING );
  Select.AddParam("p_Reason", RSDBP_OUT, V_STRING );
  Select.AddParam("p_Comment", RSDBP_OUT, V_STRING );
  Select.AddParam("p_Amount", RSDBP_OUT, V_STRING );
  Select.Execute();

  ConfNumber    = SQL_ConvTypeStr(Select.value("p_Number"));
  FactValueDate = SQL_ConvTypeDate(Select.value("p_Date"));
  InstrStatus   = SQL_ConvTypeInteger(Select.value("p_Status"));
  Amount        = SQL_ConvTypeStr(Select.value("p_Amount"));
  TypeIN        = SQL_ConvTypeStr(Select.value("p_TypeIN")); 
  if((SQL_ConvTypeInteger(Select.value("p_Stat")) == 0) and (TypeIN != "MT548") and (TypeIN != ""))
    return 1;
  end;
    return 0;
end;

private macro ПроверитьСделкуНаОтложенноеИсполнение(DealID)
  var cmd = DL_RSDCommand();
  var sql = " select 1 from ddl_tick_dbt tick, doproper_dbt oper  where tick.t_dealstatus != 0 and tick.t_bofficekind = 101 " +
"             AND oper.t_dockind = tick.t_bofficekind and oper.t_documentid = LPAD(tick.t_dealid, 34, '0' )  " +
"             and exists(select 1 from doprstep_dbt step where step.t_id_operation = oper.t_id_operation and step.t_plan_date = to_date('31.12.9999','dd.mm.yyyy') and step.t_isexecute = 'R' AND step.t_symbol in ('Т', 'О')) " +
"             and tick.t_dealid = ? " ;
  cmd.AddParam(DealID);
  var ds = cmd.Execute(sql);
  if(ds.MoveNext())
    return 1;
  end;
  return 0;
end;

private macro ПроверитьСделкуНаПросрочку(DealID)
  
  var cmd = DL_RSDCommand();
  var   q = " select 1 from ddl_tick_dbt tick, doproper_dbt oper  where tick.t_dealstatus != 0 and tick.t_bofficekind = 101 "+
            " AND oper.t_dockind = tick.t_bofficekind and oper.t_documentid = LPAD(tick.t_dealid, 34, '0' ) and tick.t_dealid = ?"+
            " and exists(select 1 from doprstep_dbt step where step.t_id_operation = oper.t_id_operation and step.t_plan_date < ? and step.t_isexecute = 'R' AND step.t_symbol in ('Т', 'О'))";

  cmd.AddParam(DealID);
  cmd.AddParam(real_date);
  var ds = cmd.Execute(q);
  if(ds.MoveNext())
    return 1;
  end;
  return 0;
end;


macro ExecAutoStart ()
   //Comment macro
   var ConfirmStatus, err, errtr, errstr, TraceON = False;
   var Deal_Cost, Deal_NKD;
   var TotalCostSTR, CurCode, confirm_num;
   var cmd = DL_RSDCommand();
   var FD;

   // Выясняем является ли текущий день последним рабочим днем месяца
   var delayExecDeal, isLastWorkDay = FALSE;
   if ( cur_date == getLastWorkDayOfMonth(cur_date) )
     isLastWorkDay = TRUE;
   end;

   var sql = "SELECT tick.\*, " +
             "       leg.T_MATURITY, " +
             "       leg.T_EXPIRY, " +
             "       leg.T_PRINCIPAL, " +
             "       leg.T_TOTALCOST, " +
             "       leg.T_NKD, OPER.T_ID_OPERATION, " +
             "       nvl(derr.t_last_exec_date, to_date('01010001','ddmmyyyy')) t_last_exec_date, " +
             "       nvl(derr.t_trace_count,0) t_trace_count, " +
             "       nvl(derr.t_description, chr(1)) t_description, " +
             "       nvl(derr.t_err_status, chr(1)) t_err_status " +
             "  FROM ddl_tick_dbt tick  left join doutmarketexec_error_dbt derr on TICK.T_DEALID = derr.t_dealid, doproper_dbt oper, ddl_leg_dbt leg " +
             " WHERE     tick.t_dealstatus != 0 " +
             "       AND tick.t_bofficekind = 101 " +
             "       AND tick.t_marketid = -1 " +
             "       AND tick.t_clientid = -1 " +
             "       AND RSB_SECUR. " +
             "            ISREPO ( " +
             "              rsb_secur. " +
             "               get_OperationGroup ( " +
             "                 rsb_secur. " +
             "                  get_OperSysTypes (tick.t_DealType, tick.t_BofficeKind))) = 0 " +
             "       AND leg.t_dealid = tick.t_dealid " +
             "       AND oper.t_dockind = tick.t_bofficekind " +
             "       AND oper.t_documentid = LPAD (tick.t_dealid, 34, '0') " +
//             "       AND tick.t_dealid = 385835 " +
             "       AND EXISTS " +
             "              (SELECT 1 " +
             "                 FROM doprstep_dbt step " +
             "                WHERE step.t_id_operation = oper.t_id_operation " +
             "                      AND (step.t_plan_date <= :d1 " +
             "                           OR step.t_plan_date = " +
             "                                 TO_DATE ('31.12.9999', 'dd.mm.yyyy')) " +
             "                      AND step.t_isexecute = 'R' " +
             "                      AND step.t_symbol IN ('Т', 'О')) " ;

    cmd.AddParam(real_date); 
    var ds = cmd.Execute(sql);
    insert_log(0,0,0,0,"Старт обработки. Real_Date: " + real_date + "; Cur_Date: " + cur_date + " ;" );  
    while (ds.MoveNext())
       insert_log(ds.DealID,0,0,0,"Обработка сделки: " + ds.DealID);  
       ConfirmStatus = 0; err = null;
      FD = SPFirstDoc(LEG_KIND_DL_TICK, ds.DealID ); //LEG_KIND_DL_TICK
      //1. Проверяем наличие для сделки подтверждения. 
       ConfirmStatus = CheckConfirmStatus(ds.DealID, @TotalCostSTR, @confirm_num);
       if (ConfirmStatus)
          insert_log(ds.DealID,0,0,0,"Получено подтверждение по сделке: " + confirm_num );  
          if ((ПроверитьСделкуНаПросрочку(ds.DealID)) and (not ПроверитьСделкуНаОтложенноеИсполнение(ds.DealID)))
          //если плановые даты исполнения меньше текущей даты исполняем перенос по срокам 
             Deal_Cost = ds.TotalCost;
             Deal_NKD  = ds.nkd;
             err = SC_CalcExecute (ds.DealID, TypeAction_DeferredDelivery, date(ds.maturity), money(Deal_Cost), money(Deal_NKD)); 
             if (not err)
                  insert_log(ds.DealID,TypeAction_DeferredDelivery,Deal_Cost,Deal_NKD,"Выполнен перенос по срокам (поставка)"); 
                  err = SC_CalcExecute (ds.DealID, TypeAction_DeferredPayment , date(ds.expiry)  , money(Deal_Cost), money(Deal_NKD));
                  if (not err)
                      insert_log(ds.DealID,TypeAction_DeferredDelivery,Deal_Cost,Deal_NKD,"Выполнен перенос по срокам (оплата)"); 
                   end;
             end;
          end;
          if(ПроверитьСделкуНаОтложенноеИсполнение((ds.DealID)))
            // исполняем отложенную поставку и оплату
             if(real_date <= cur_date)
               GetTotalCost(TotalCostSTR, @CurCode, @Deal_Cost);
               Deal_NKD  = (НКД(ds.pfi,ds.principal,cur_date));   
               err = SC_CalcExecute (ds.DealID, TypeAction_ExecDeferDelivery, cur_date, money(Deal_Cost), money(Deal_NKD)); 
               if (not err)
                     insert_log(ds.DealID,TypeAction_ExecDeferDelivery,Deal_Cost,Deal_NKD,"Выполнена отложенная поставка"); 
                     err = SC_CalcExecute (ds.DealID, TypeAction_ExecDeferPayment ,cur_date, money(Deal_Cost), money(Deal_NKD)); 
                     if (not err)
                        insert_log(ds.DealID,TypeAction_ExecDeferPayment,Deal_Cost,Deal_NKD,"Выполнена отложенная оплата"); 
                     end; 
               end;
               
             end;
          end; 

          // Если это последний рабочий день месяца выясняем выполнены ли шаги переоценки СС ПФИ
          delayExecDeal = FALSE;
          if ((isLastWorkDay) and (FD.tick.rec.ispfi == set_char))
            delayExecDeal = TRUE;
            if ( IsVStepExec(ds.ID_OPERATION, cur_date) )
              delayExecDeal = FALSE;
            end;
          end;
  
          if ( not delayExecDeal )
            //исполняем сделку
          /*  if((ds.Err_Status == set_char) and (ds.trace_count < pTraceCount))
              SetRSTrace(True);         // 17-06-2020 по теме 511711
              TraceON = True;
            end; */
  
            err = SP_ExecDeal(ds.DealID, false ); 
  
            if (not IsReadToExec(ds.ID_OPERATION))
              insert_log(ds.DealID,0,0,0, "Сделка исполнена");
              ClearErrRecord(ds.DealID);
            else
              insert_log(ds.DealID,0,0,0, "При исполнении шаги сделки не изменили свой статус");
              InsertErrRecord(ds.DealID, "При исполнении шаги сделки не изменили свой статус", iif(TraceON,1,0))
            end;
  
           /* if(TraceON)
              SetRSTrace(False);          //17-06-2020 по теме 511711
              TraceON = False; 
            end;    */
          end;
       else
          if (ПроверитьСделкуНаПросрочку(ds.DealID))
          //если плановые даты исполнения меньше текущей даты исполняем перенос по срокам 
             Deal_Cost = ds.TotalCost;
             Deal_NKD  = ds.nkd;
             err = SC_CalcExecute (ds.DealID, TypeAction_DeferredDelivery, date(ds.maturity), money(Deal_Cost), money(Deal_NKD)); 
             if (not err)
                   insert_log(ds.DealID,TypeAction_DeferredDelivery,Deal_Cost,Deal_NKD,"Выполнен перенос по срокам (поставка)"); 
                   SC_CalcExecute (ds.DealID, TypeAction_DeferredPayment , date(ds.expiry)  , money(Deal_Cost), money(Deal_NKD));
                   if (not err)
                     insert_log(ds.DealID,TypeAction_DeferredPayment,Deal_Cost,Deal_NKD,"Выполнен перенос по срокам (оплата)"); 
                   end;
             end;
          end;
       end; 
    end;
 
End;

ReplaceMacro("MsgBox", "DP_MsgBox");
ExecAutoStart();

exit(1);

OnError
exit(1);
