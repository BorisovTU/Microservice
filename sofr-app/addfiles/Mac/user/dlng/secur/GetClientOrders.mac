/*
load_RPS.mac
Загрузка поручений клиентов
*/
import oralib, likepy, globals, rsexts, or_rep_h, fiinter;
import "usr_open_files.mac", "cb_sql.mac", "u_common_email_utils.mac";
import "Orders_report.mac";


private const RATE_DATE = 0,
              CURRENCY  = 1,
              PERIOD    = 2,
              DAYS      = 3,
              RATE      = 4;

private var RegDir = "РСХБ\\ДИРЕКТОРИИ\\IMPORDERS",
            etl_path = "";

private file doc() txt;

//Массивы с ошибками и информацией о загрузке
private var errors = TArray();
private var logs = TArray();

Private const ConstBirgCom = 0.0125;
Private const ConstBankCom1 = 0.015;
Private const ConstBankCom2 = 0.007;

private macro AddErr (err:string)
  errors[errors.size] = err;
  return false;
End;

private macro AddLog (log:string)
  logs[logs.size] = log;
  return true;
End;

Private Const CALCOR_RECEIVER_GROUP_ID = 23;

//Перемещает файл
private macro copyFromTo (from, to)
  return TDirList().copy(from, null, to, true, false);
End;

   Private macro SendErrMsg(error:string, attach:string, receiverGroupID:integer)
      var email = c_email_proc_env();
      var arh_name = attach;
      var FileName, ExtName, DirName;
      VAR SpPath = "", SpFileName = "", tittle = "", message = "";
      //Отделяем путь файла от имени
      splitfile(attach, FileName, ExtName);
      FileName = FileName + ExtName;
      DirName = substr(attach, 1, index(attach, FileName) - 1);

      arh_name = StrSubst(arh_name,"$","");
      arh_name = StrSubst(arh_name, ExtName, ".7z");

      tittle = "Ошибка загрузки файла с поручениями клиентов " + FileName;
      message = "Сообщение отправлено автоматически. Ошибка загрузки файла с поручениями клиентов " + FileName + ". " + error;
      email.m_set_msg_head(tittle);
      email.m_add_row_to_msg_text(message);
      email.m_save_to_submit_grp(receiverGroupID);
      email.m_submit_email_synch();
   End;


//----------------------------------------------------------------------------------------------

/*Класс для загрузки поручений */
class InsertOrders () 
  var BegDate;
  var EndDate;  
  var FioClient = "";
  var ContrNum = "";
  var COntrDate;
  var FiCode = "";
  var Principal  = 0;
  var KindDeal = "";
  var FilOrderDate;
  var FilOrderTime;
  var MskOrderDate;
  var MskOrderTime;
  var RFNum = "";
  var RFName = "";
  var SSPNum = "";
  var SSPName = "";
  var FIOWorker = "";
  var FilOrderDateCancel;
  var FilOrderTimeCancel;
  var MskOrderDateCancel;
  var MskOrderTimeCancel;
  var FIOWorkerCancel = "";
  var FIID = 0;


   macro GetFIIDByIsin(isin):integer
    var sql = ExecSqlSelect("select t_fiid from davoiriss_dbt where t_isin= :1", MakeArray(SqlParam("1", isin)));
    if (sql.MoveNext() )
      return sql.value(0);
    end;
    return -1;
  End;

   macro GetBegDate(isin)
    var sql = ExecSqlSelect("select t_begplacementdate from davoiriss_dbt where t_isin= :1", MakeArray(SqlParam("1", isin)));
    if (sql.MoveNext() )
      return SQL_ConvTypeDate(sql.value(0));
    end;
    return date("01.01.0001");
  End;

   Macro GetEndDate(StrFileName)
    var TmpStr, dd,mm,yyyy, CurDt;
        TmpStr = substr(strFileName, 1, strlen(strFileName) -4);
        TmpStr = substr(TmpStr, strlen(TmpStr) -7);
        dd = substr(TmpStr, 1, 2);
        mm = substr(TmpStr, 3, 2);
        yyyy = substr(TmpStr, 5);
        curDt = date( dd+"."+ mm+ "." + yyyy);
        return curDt;
  End;

   macro ClearOrders (FileIsin)

    var sql = "delete Usr_ClientsOrders where ficode = :isin ";
    sql = ExecSql(sql, MakeArray(SqlParam("isin",           FileIsin)));
    
    if (sql == null)
      RunError("Ошибка при очистке данных");
    end;
    onerror()
      AddErr("Ошибка при очистке данных"); 

  end;



  //Вставить значение в таблицу с поручениями
  private macro InsertOrdersLine ()


    var sql = "INSERT INTO Usr_ClientsOrders  "
        + "VALUES ( 0,  "
        + "        :FioClient, " 
        + "        :ContrNum, " 
        + "        :COntrDate, " 
        + "        :FiCode, " 
        + "        :Principal, " 
        + "        :KindDeal, " 
        + "        :FilOrderDate, " 
        + "        :FilOrderTime, " 
        + "        :MskOrderDate, " 
        + "        :MskOrderTime, " 
        + "        :RFNum, " 
        + "        :RFName, " 
        + "        :SSPNum, " 
        + "        :SSPName, " 
        + "        :FIOWorker, " 
        + "        :FilOrderDateCancel, " 
        + "        :FilOrderTimeCancel, " 
        + "        :MskOrderDateCancel, " 
        + "        :MskOrderTimeCancel, " 
        + "        :FIOWorkerCancel,chr(1), chr(1),0,0,1,0,0,0,0,0, -1, 0, 0 " 
        + "       ) ";
  sql = ExecSql(sql, MakeArray(SqlParam("FioClient",           FioClient),
                               SqlParam("ContrNum",     ContrNum),
                               SqlParam("COntrDate",          COntrDate),
                               SqlParam("FiCode",           FiCode),
                               SqlParam("Principal",        Principal),
                               SqlParam("KindDeal",     KindDeal),
                               SqlParam("FilOrderDate",       FilOrderDate),
                               SqlParam("FilOrderTime",           FilOrderTime),
                               SqlParam("MskOrderDate",          MskOrderDate),
                               SqlParam("MskOrderTime",            MskOrderTime),
                               SqlParam("RFNum",           RFNum),
                               SqlParam("RFName",            RFName),
                               SqlParam("SSPNum",      SSPNum),
                               SqlParam("SSPName",            SSPName),
                               SqlParam("FIOWorker",       FIOWorker),
                               SqlParam("FilOrderDateCancel",       FilOrderDateCancel),
                               SqlParam("FilOrderTimeCancel",       FilOrderTimeCancel),
                               SqlParam("MskOrderDateCancel",       MskOrderDateCancel),
                               SqlParam("MskOrderTimeCancel", MskOrderTimeCancel),
                               SqlParam("FIOWorkerCancel",        FIOWorkerCancel)));
    if (sql == null)
      RunError("Ошибка при заполнении данных");
    end;


  End;



  macro AddNewOrders (_FioClient,
                   _ContrNum,       
                   _COntrDate,           
                   _FiCode, 
                   _Principal,      
                   _KindDeal,       
                   _FilOrderDate,        
                   _FilOrderTime,        
                   _MskOrderDate,        
                   _MskOrderTime,        
                   _RFNum,          
                   _RFName,         
                   _SSPNum,         
                   _SSPName,        
                   _FIOWorker,      
                   _FilOrderDateCancel,  
                   _FilOrderTimeCancel,  
                   _MskOrderDateCancel,  
                   _MskOrderTimeCancel,  
                   _FIOWorkerCancel
                  )



                   
    FioClient            = _FioClient;
    ContrNum             = _ContrNum;
    COntrDate            = date(_COntrDate);
    FiCode               = _FiCode;
    Principal            = int(_Principal);
    KindDeal             = _KindDeal;
    FilOrderDate         = date(_FilOrderDate);
    FilOrderTime         = time(_FilOrderTime);
    MskOrderDate         = date(_MskOrderDate);
    MskOrderTime         = time(_MskOrderTime);
    RFNum                = _RFNum;
    RFName               = _RFName;
    SSPNum               = _SSPNum;
    SSPName              = _SSPName;
    FIOWorker            = _FIOWorker;
    FilOrderDateCancel   = date(_FilOrderDateCancel);
    FilOrderTimeCancel   = time(_FilOrderTimeCancel);
    MskOrderDateCancel   = date(_MskOrderDateCancel);
    MskOrderTimeCancel   = time(_MskOrderTimeCancel);
    FIOWorkerCancel      = _FIOWorkerCancel;
    
    InsertOrdersLine();
  End;
END;

//Автопоиск файла. Маска: RSB_CONS_REP_ORD_*.csv
private macro FindFile ()
  var dd, mm, year, FileName="", mask = "RSB_CONS_REP_ORD_*.csv";

  //datesplit({curdate}, dd, mm, year);
  //mask = string(year:o:4) + string(mm:o:2) + string(dd:o:2) + mask;
  //GetRegistryValue(RegDir, V_STRING, etl_path);
  If(TDirList ("$" + etl_path + "\\"+ mask, "F").count !=0)
     FileName = TDirList ("$" + etl_path + "\\"+ mask, "F").name(0);
     FileName = "$" + etl_path +"\\"+ FileName;
  else
     FileName = "";
  end;
//  FileName = "$" + etl_path +"\\"+ FileName;
  return FileName;
End;

Private Macro Check(StrVal, Field)
    If(StrVal == "")
       runerror("Ошибка загрузки. Не заполнен обязательный атрибут " + Field);
    else 
       return StrVal;
    end;

end;

//IsHandler - признак ручной обработки
macro StartLoadOrders (IsHandler)
  var Orders_class = InsertOrders(), firstStr = true, cmd;
  var c_file = c_txt_file();
  var FullFileName, mask = "RSB_CONS_REP_ORD_*.csv";
  var stat;
  record AVR (avoiriss);
  record ФинИн(fininstr);
  var strfi = "", tempFiid, i = 0, j = 0, isfind = false;
  private var Arrfi = TArray();

//  Rep.PrintHeader();

  GetRegistryValue(RegDir, V_STRING, etl_path);
  FullFileName = FindFile();
  If(FullFileName == "")
     return 0;
  end;
  Orders_class.EndDate = Orders_class.GetEndDate(FullFileName);
  stat = c_file.openFile(doc, etl_path+"\\"+mask, true, true/*(not IsHandler)*/, FullFileName, "rsansi");

  if ( (valtype(stat) == V_UNDEF) or (stat == false) )
     exit(1);
  end;

  SetDelim(";");
  Next(doc); //Первая строка - заголовочная
// Определяем выпуски
  while(Next(doc))
    If(firstStr)
        tempFiid = Orders_class.GetFIIDByIsin(doc(3));
        If(tempFiid == -1)
           runerror("Ошибка загрузки. В СОФР не найден выпуск с кодом " + doc(3));
        end;
        Arrfi[i] = tempFiid;
        Orders_class.ClearOrders(doc(3));
        firstStr = false;
    else
        If(doc(3) != "")
           tempFiid = Orders_class.GetFIIDByIsin(doc(3));
           If(tempFiid == -1)
              runerror("Ошибка загрузки. В СОФР не найден выпуск с кодом " + doc(3));
           end;

            j = 0;
	    isfind = false;	
            while ( j< Arrfi.size)
                If(Arrfi[j]==tempFiid)
                   isfind = true;
                   break;
                else
  		 j = j+1;
                end;
            end;
            If(not isfind)
              i = i+1;
              Arrfi[i] = tempFiid;
              Orders_class.ClearOrders(doc(3));
            end;
        else
           runerror("Ошибка загрузки. В строке файла с поручениями не указан выпуск " + doc(3));
        end;
    end;
  end;


  Rewind(doc);
  Next(doc); //Первая строка - заголовочная

  while(Next(doc))
/*
    If(firstStr)
       If(doc(3) != "")
          Orders_class.ClearOrders(doc(3));
          Orders_class.fiid = Orders_class.GetFIIDByIsin(doc(3));
          If(Orders_class.fiid == -1)
             runerror("Ошибка загрузки. В СОФР не найден выпуск с кодом " + doc(3));
          end;
          ПолучитьФинИн(Orders_class.fiid,ФинИН,AVR);

          Orders_class.BegDate = Orders_class.GetBegDate(doc(3));
       else
        // генерить ошибку;
       end;

       firstStr = false;
    end;
*/
    Orders_class.AddNewOrders(Check(doc(0), "ФИО клиента"), //FioClient
                              Check(doc(1), "Номер договора"), //ContrNum
                              Check(doc(2), "Дата договора"), //COntrDate
                              Check(doc(3), "Код выпуска"), //FiCode
                              doc(4), //Principal
                              doc(5), //KindDeal
                              doc(6), //FilOrderDate
                              doc(7), //FilOrderTime
                              doc(8), //MskOrderDate
                              doc(9), //MskOrderTime
                              doc(10), //RFNum
                              doc(11), //RFName
                              doc(12), //SSPNum
                              doc(13), //SSPName
                              doc(14), //FIOWorker
                              doc(15), //FilOrderDateCancel
                              doc(16), //FilOrderTimeCancel
                              doc(17), //MskOrderDateCancel
                              doc(18), //MskOrderTimeCancel
                              doc(19)); //FIOWorkerCancel
  end;                            
  c_file.closeFile(doc);
     If(firstStr)
        runerror("Ошибка загрузки. В файле загрузки нет данных ");
     end;



  i = 0;
  while (i<Arrfi.size())

   ПолучитьФинИн(Arrfi[i],ФинИН,AVR);
      
      cmd = RsdCommand("{CALL rshb_AddOrderTableData(?, ?, ?, ?, ?, ?, ?, ?, ?) }");

      cmd.addParam("BegDate",         RSDBP_IN, AVR.begplacementdate);
      cmd.addParam("EndDate",             RSDBP_IN, Orders_class.EndDate );
      cmd.addParam("fiid",       RSDBP_IN, ФинИН.fiid );
      cmd.addParam("Codefi",       RSDBP_IN, AVR.isin );
      cmd.addParam("facevalue",        RSDBP_IN, ФинИН.facevalue );
      cmd.addParam("facevaluefi",            RSDBP_IN, ФинИН.facevaluefi );
      cmd.addParam("BirgCom",            RSDBP_IN, ConstBirgCom );
      cmd.addParam("BankCom1",            RSDBP_IN, ConstBankCom1 );
      cmd.addParam("BankCom2",            RSDBP_IN, ConstBankCom2 );

      cmd.execute();

    /*Выпуск отчета*/

        var prm = CDLCalcOrdersParm();

        prm.BegDate = AVR.begplacementdate;
        prm.EndDate = Orders_class.EndDate;
        prm.fiid = ФинИН.fiid;
        DL_CalcOrders_Report(prm);

     i = i+1;
  end;

    copyFromTo(FullFileName, "$" + etl_path+"\\" + "old\\");


onerror(er)
SendErrMsg(er.message, FullFileName, CALCOR_RECEIVER_GROUP_ID);
exit(1);
  //Rep().ShowRep(IsHandler);
End;