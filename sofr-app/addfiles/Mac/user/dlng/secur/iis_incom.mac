import get2date, rsd, dl_util_xml_obj, rcw;
import "DLReport_h.mac", "dlreport.mac", "dlQuery.mac", "scsrvrepfun.mac", "sc_inacc.mac";
import "dpstdrep.mac", "dl_util_xml_obj.mac";
import RsbFormsInter, spinter;

macro iis_incom
   var flt, rep, dt, tm, rpnm ;
   var sqls, rsdc, rsds;

   macro show()
      var v_err, fpth, fnam, dlmt = "\\", ob1, obex, obbook;
      fnam = String(modulename,strsubst(strsubst(string(date:f), ".", ""), " ", "0"), UserNumber, ".xml");
      if (isStandalone())        
         GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR", V_STRING, fpth, v_err);
         if (substr(fpth, strlen(fpth), 1) != dlmt)
            fpth = string(fpth, dlmt);
         end;
      else
         fpth = string("$", GetCurDir(true), dlmt, "TXTFILE", dlmt);
      end;   
      var fpathnam = rep.Move(string(fpth, fnam));      
      if (substr(fpathnam, 1, 1) == "$")
         fnam = substr(fpathnam, 2);
      end;
      if (fpathnam)
         SC_ShowFile(fpathnam, "");   
         rep.Delete();
      end;
   end;  
  
   flt = Panel2Date;
   if (not flt.Show)
      return;
   end;
   sqls = String( 
                  "SELECT fil.t_Name   \n"
                 ,"      ,prt.t_name Prt_Name   \n"
                 ,"      ,sf.t_number   \n"
                 ,"      ,sf.t_datebegin   \n"
                 ,"      ,sf.t_number || ' от ' || to_char(sf.t_datebegin, 'DD.MM.YYYY') nmb_dat   \n"
                 ,"      ,TRUNC(dl.t_iislastclosedate) iis_dat   \n"
                 ,"      ,NVL((SELECT SUM(nx.t_outsum)   \n"
                 ,"             FROM dnptxop_dbt nx   \n"
                 ,"            WHERE nx.t_contract = sfp.t_id   \n"
                 ,"              AND nx.t_dockind = 4607   \n"
                 ,"              AND nx.t_Status = 2   \n"
                 ,"              AND nx.t_subkind_operation = 10   \n"
                 ,"              AND nx.t_iis = chr(88))   \n"
                 ,"          ,0) iis_sum   \n"
                 ,"      ,dl.t_dlcontrid   \n"
                 ,"      ,sf.t_id   \n"
                 ,"      ,sfp.t_id   \n"
                 ,"      ,sf.t_partyid   \n"
                 ,"      ,(SELECT t_code   \n"
                 ,"          FROM ddlobjcode_dbt oc   \n"
                 ,"         WHERE oc.t_objecttype = 207   \n"
                 ,"           AND oc.t_codekind = 1   \n"
                 ,"           AND oc.t_objectid = dl.t_dlcontrid) ekk   \n"                 
                 //,"           AND oc.t_objectid = dl.t_dlcontrid   \n"
                 //,"           AND oc.t_state = 0) ekk   \n"
                 ,"  FROM ddlcontr_dbt dl   \n"
                 ," INNER JOIN dsfcontr_dbt sf   \n"
                 ,"    ON (sf.t_id = dl.t_sfcontrid)   \n"
                 ," INNER JOIN dparty_dbt prt   \n"
                 ,"    ON (prt.t_partyid = sf.t_partyid)   \n"
                 ," INNER JOIN ddlcontrmp_dbt t   \n"
                 ,"    ON (t.t_dlcontrid = dl.t_dlcontrid)   \n"
                 ," INNER JOIN dsfcontr_dbt sfP   \n"
                 ,"    ON (sfP.t_id = T.T_SFCONTRID)   \n"
                 ," INNER JOIN ddp_dep_dbt fil   \n"
                 ,"    ON (fil.t_code = sf.t_department)   \n"
                 ," WHERE dl.t_Iistransfer = chr(88)   \n"
                 ,"   AND dl.t_iis = chr(88)   \n"
                 ,"   AND sf.t_datebegin <= NVL(:p_Dat2, SYSDATE)   \n"
                 ,"   AND (sf.t_dateclose = to_date('01010001', 'DDMMYYYY') OR sf.t_Dateclose >= NVL(:p_Dat1, SYSDATE))   \n"
                );
   rsdc = rsdcommand(sqls);
   rsdc.AddParam("p_Dat2", RSDBP_IN, flt.Dat2);
   rsdc.AddParam("p_Dat1", RSDBP_IN, flt.Dat1);
   rsds = rsdrecordset(rsdc, RSDVAL_CLIENT_IF_NEEDED, RSDVAL_FORWARD_ONLY);
   rsds.Open();
   if (not rsds.MoveNext())
      msgbox("Нет данных для отчета");   
      rsds = null;
      rsdc = null;   
      return;
   end;    
   rep = T_XML_Rep;            
   InitProgress(-1, "Подождите...", "Формирование отчета");            
   rep.Init("utf8", TRUE);
   // rep.Set_Column_Width( 5, 220, 180, 120, 140);
   // strlen("поступивших при расторжении ИИС") * 5.55 = 31 * 5.55 = 172
   // strlen("у другого проф участника") * 5.55 = 134
   rep.Set_Column_Width( 5, 220, 180, 134, 172);
   rep.Set_Indent(0);
   rep.Print_Header("Отчет", "Times New Roman", 11);
   rep.Blank_Line(18);   
   rep.Put_Val("Договоры ИИС принятые на обслуживание от других проф.участников за период", "STEN;I=2;HA=C;VA=C;R=3;FS=12;FB", 30);
   if ((flt.Dat2 != "") and (flt.Dat2 != ""))
      rep.Put_Val("с " + string(flt.Dat1:f) + " по " + string(flt.Dat2:f), "STEN;I=2;HA=C;VA=C;R=3;FS=12;FB", 40);
   elif(flt.Dat2 != "")    
      rep.Put_Val("по " + string(flt.Dat2:f), "STEN;I=2;HA=C;VA=C;R=3;FS=12;FB", 40);
   elif(flt.Dat2 != "")    
      rep.Put_Val("c " + string(flt.Dat1:f), "STEN;I=2;HA=C;VA=C;R=3;FS=12;FB", 40);
   else    
      rep.Put_Val("", "STEN;I=2;HA=C;VA=C;R=3;FS=12;FB", 40);
   end;       
   rep.Put_Val("ФИО клиента", "START;I=2;P=C;WT;BOR;FS=11;IC=B7DEE8", 77);
   rep.Put_Val("Номер и дата договора", "P=C;WT;BOR;FS=11;IC=B7DEE8");
   rep.Put_Val("Дата расторженния ИИ\nу другого проф участника", "P=C;WT;BOR;FS=11;IC=B7DEE8");
   rep.Put_Val("Сумма денежных средств\nпоступивших при расторжении ИИС\nот другого проф. участника", "END;P=C;WT;BOR;FS=11;IC=B7DEE8");
   while (sqls)          
      rep.Put_Val(rsds.value("Prt_Name"), "START;I=2;HA=L;VA=C;BOR;FS=11;", 20);
      rep.Put_Val(rsds.value("nmb_dat"), "HA=L;VA=C;BOR;FS=11;");
      rep.Put_Val(rsds.value("iis_dat"), "HA=C;VA=C;BOR;FS=11;T=D");
      rep.Put_Val(rsds.value("iis_sum"), "END;HA=R;VA=C;BOR;FS=11;T=M;");
      sqls = rsds.moveNext();
   end;        
   rep.Print_Bottom();
   RemProgress();
   show();
   
   Rep  = null;
   rsds = null;
   rsdc = null;   
onerror(er)
   RemProgress();
   msgbox(er.Message);
   Rep  = null;
   rsds = null;
   rsdc = null;   
end;

iis_incom;
exit(1);
end;
