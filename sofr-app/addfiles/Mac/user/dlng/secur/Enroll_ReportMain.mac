/*****************************************************************************/
/*                                                           R-Style Softlab */
/*                                                                           */
/*               Отчет по буферным зачислениям                               */
/*                                                                           */
/*  Create : Belohonov P.V.                                                  */
/*  Date   : 04.03.2021                                                      */
/*****************************************************************************/
import RsbFormsInter, globals, Календарь, sp_class, captureoutput, enroll_class;

const REPTYPE_ENROLL_ALL = 1,
      REPTYPE_ENROLL_COMPLETED = 2,
      REPTYPE_WRTOFF = 3;

private const FT_INT32  = 1;
private const FT_STRING = 7;
private const FT_DATE   = 9;


var ExitCode:integer, FProcPanel:TRsbPanel, Rep, rn = 1, sheet = 1;

private var _sqlString:string;

class TReportParm()
   var BegDate : date;
   var EndDate : date;
   var EnrollCreated       : bool;
   var EnrollTransferred   : bool;
   var EnrollRefunded      : bool;
   var EnrollCreatedNptxop : bool;
   var NptxopCreated   : bool;
   var NptxopRefunded  : bool;
   var NptxopCompletedEnroll : bool;
   var NptxopCompletedWrtoff : bool;
   var RepType : integer;
   macro Init(Type)
      RepType = Type;
      if (RepType == REPTYPE_ENROLL_ALL)
         BegDate             = {curdate};
      EndDate             = {curdate};
      EnrollCreated       = true;
      EnrollTransferred   = true;
         EnrollRefunded      = true;
         EnrollCreatedNptxop = false;
         NptxopCreated       = true;
         NptxopRefunded      = true;
         NptxopCompletedEnroll = true;
      NptxopCompletedWrtoff = false;
      elif (RepType == REPTYPE_ENROLL_COMPLETED)
         BegDate             = {curdate};
         EndDate             = {curdate};
         EnrollCreated       = false;
         EnrollTransferred   = false;
         EnrollRefunded      = false;
         EnrollCreatedNptxop = false;
         NptxopCreated       = true;
         NptxopRefunded      = true;
         NptxopCompletedEnroll = true;
         NptxopCompletedWrtoff = false;
      elif (RepType == REPTYPE_WRTOFF)
         BegDate             = {curdate};
         EndDate             = {curdate};
         EnrollCreated       = false;
         EnrollTransferred   = false;
         EnrollRefunded      = true;
         EnrollCreatedNptxop = false;
         NptxopCreated       = false;
         NptxopRefunded      = true;
         NptxopCompletedEnroll = false;
         NptxopCompletedWrtoff = true;
   end;
end;
end;

macro GetHeaderText(parm)
   var RetVal = "";
   if (Parm.RepType == REPTYPE_ENROLL_ALL)
      RetVal = "Отчет по зачислениям с " + Parm.BegDate + " по " + Parm.EndDate;
   elif (Parm.RepType == REPTYPE_ENROLL_COMPLETED)
      RetVal = "Отчет по распределенным зачислениям с " + Parm.BegDate + " по " + Parm.EndDate;
   elif (Parm.RepType == REPTYPE_WRTOFF)
      RetVal = "Отчет по выводам/возвратам с " + Parm.BegDate + " по " + Parm.EndDate;
   else
      RetVal = "Отчет с " + Parm.BegDate + " по " + Parm.EndDate;
   end;
   return RetVal;
end;

macro print_header(Type, Header_str)
 
// var EXCEL_MONEY = "\"# ##0,0000\"";
  var EXCEL_MONEY = "\"##0,0000;-##0,0000;##0,0000\"";
  Rep.SetExecute("iBook.Sheets(1).Columns(1).NumberFormat = 0;");
  Rep.SetExecute("iBook.Sheets(1).Columns(6).NumberFormat = "+EXCEL_MONEY+";");
 
  Rep.AddEmptyStr();
  Rep.AddEmptyStr();

  Rep.AddPrintCell("Номер п/п",         4, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Дата",             10, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Время",             8, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Статус",           25, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Номер договора",   15, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("ФИО клиента/Наименование",      30, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Сумма",            10, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Валюта",            5, null, "c:ex_FS(b):ex_B(tblr)");
   if (Type == REPTYPE_WRTOFF)
      Rep.AddPrintCell("Номер поручения",      10, null, "c:ex_FS(b):ex_B(tblr)");
      Rep.AddPrintCell("Дата и время возврата д/с",      20, null, "c:ex_FS(b):ex_B(tblr)");
   end;
  Rep.AddPrintCell("Комментарий",      50, null, "c:ex_FS(b):ex_B(tblr)");
  
  Rep.AddStr();
end;

macro PrintStr(num, dt, tm, st, contr, fio, sum, cur, com)
  Rep.AddPrintCell(num,      4, null, "r:ex_FS():ex_B(tblr)");
  Rep.AddPrintCell(Dt,      10, null, "c:ex_FS():ex_B(tblr)");
  Rep.AddPrintCell(tm,       8, null, "c:ex_FS():ex_B(tblr)");
  Rep.AddPrintCell(St,      25, null, "c:ex_FS():ex_B(tblr)");
  Rep.AddPrintCell(contr,   15, null, "r:ex_FS():ex_B(tblr)");
  Rep.AddPrintCell(fio,     30, null, "r:ex_FS():ex_B(tblr)");
  Rep.AddPrintCell(sum,     10, null, "c:ex_FS():ex_B(tblr)");
  Rep.AddPrintCell(cur,      5, null, "c:ex_FS():ex_B(tblr)");
  Rep.AddPrintCell(com,     50, null, "c:ex_FS():ex_B(tblr)");
  Rep.AddStr();
end;

macro PrintStrWrtOff(num, dt, tm, st, contr, fio, sum, cur, reqnum, dttm, com)
  Rep.AddPrintCell(num,      4, null, "r:ex_FS():ex_B(tblr)");
  Rep.AddPrintCell(Dt,      10, null, "c:ex_FS():ex_B(tblr)");
  Rep.AddPrintCell(tm,       8, null, "c:ex_FS():ex_B(tblr)");
  Rep.AddPrintCell(St,      25, null, "c:ex_FS():ex_B(tblr)");
  Rep.AddPrintCell(contr,   15, null, "r:ex_FS():ex_B(tblr)");
  Rep.AddPrintCell(fio,     30, null, "r:ex_FS():ex_B(tblr)");
  Rep.AddPrintCell(sum,     10, null, "c:ex_FS():ex_B(tblr)");
  Rep.AddPrintCell(cur,      5, null, "c:ex_FS():ex_B(tblr)");
  Rep.AddPrintCell(reqnum,  10, null, "c:ex_FS():ex_B(tblr)");
  Rep.AddPrintCell(dttm,    20, null, "c:ex_FS():ex_B(tblr)");
  Rep.AddPrintCell(com,     50, null, "c:ex_FS():ex_B(tblr)");
  Rep.AddStr();
end;


macro GetData(parm)
     var rs, cmd;
   var sql = 
             " select ROW_NUMBER () OVER (ORDER BY t_date, t_time) num, tt.* from ( " +
             " select  t_enrollid, t_date, to_char(t_time,'hh24:mi:ss') t_time, t_contrnumber, t_clientname, t_debetaccount, t_creditaccount, " +
             "  t_sum, (select t_ccy from dfininstr_dbt where t_fi_code = t_currcode) t_currency, decode(t_state,0,'Создана',1,'Выполнен перевод на 306Т',2,'Создана операция зачисления',3,'Возврат ДС выполнен',4,'Удалена',5, 'Ошибка') t_state, " + 
             " nvl(t_comment,' ') t_comment, 'б/н' reqnum, " 
             " nvl (( select to_char(s.t_systemdate,'dd.mm.yyyy')||'  '||to_char(s.t_systemdate,'hh24:mi:ss')  " + 
             "      from usr_acc306enroll_step_dbt s where s.t_enrollid = t.t_enrollid and t_action = "+C_ENROLL_ACTION_REFUNDED+
             "        and exists(select 1 from usr_acc306enroll_trn_dbt trn where trn.t_enrollid = t.t_enrollid and trn.t_stepid = s.t_stepid and trn.t_paymentid <> 0) ),' ') dttm,  " +
             " t_nptxopid, t_JMSMESSAGEID, t_ground from usr_acc306enroll_dbt t where " + 
             " t_date between " +GEtSQLDate(parm.BegDate)+ " and " + GEtSQLDate(parm.EndDate)+
             " and t_state in (" +
                                 iif (Parm.EnrollCreated      , string(C_ENROLL_ACTION_CREATED)      ,"-1") + ", " +
                                 iif (parm.EnrollTransferred  , string(C_ENROLL_ACTION_TRANSFERRED)  ,"-1") + ", " +
                                 iif (parm.EnrollCreatedNptxop, string(C_ENROLL_ACTION_CREATEDNPTXOP),"-1") + ", " +
                                 iif (parm.EnrollRefunded     , string(C_ENROLL_ACTION_REFUNDED)     ,"-1") + 
                                ") " ;
     sql = sql + 
             "UNION ALL \n" +
             "SELECT  \n" +
             "       0, \n" +
             "       t_operdate, \n" +
             "       TO_CHAR (t_time, 'hh24:mi:ss') t_time, \n" +
             "       (SELECT t_number \n" +
             "          FROM dsfcontr_dbt \n" +
             "         WHERE t_id = \n" +
             "                  (SELECT t_sfcontrid \n" +
             "                     FROM ddlcontr_dbt \n" +
             "                    WHERE t_dlcontrid = (SELECT t_dlcontrid \n" +
             "                                           FROM ddlcontrmp_dbt \n" +
             "                                          WHERE t_sfcontrid = n.t_contract))) \n" +
             "          contrnum, \n" +
             "       CASE WHEN p.t_LEgalForm = 2 THEN (SELECT t_name1 || ' ' || t_name2 || ' ' || t_name3 \n" +
             "          FROM dpersn_dbt \n" +
             "         WHERE t_personid = n.t_client) \n" +
             "         ELSE p.t_name END \n" +
             "          clientname, \n" +
             "       ' ', \n" +
             "       ' ', \n" +
             "       t_outsum, \n" +
             "       (SELECT t_ccy \n" +
             "          FROM dfininstr_dbt \n" +
             "         WHERE t_fiid = n.t_currency) \n" +
             "          cur, \n" +
             "       CASE \n" +
             "          WHEN n.t_subkind_operation = 10 and s_enroll.t_isexecute IS NULL AND s_refund.t_isexecute IS NULL \n" +
             "          THEN \n" +
             "             'Создана операция зачисления' \n" +
             "          WHEN n.t_subkind_operation = 20 and s_enroll.t_isexecute IS NULL AND s_refund.t_isexecute IS NULL \n" +
             "          THEN \n" +
             "             'Создана операция списания' \n" +
             "          WHEN s_enroll.t_isexecute IS NULL \n" +
             "               AND s_refund.t_isexecute = CHR (88) \n" +
             "          THEN \n" +
             "             'Возврат ДС выполнен' \n" +
             "          WHEN s_enroll.t_isexecute IS NULL \n" +
             "               AND s_refund.t_isexecute <> CHR (88) \n" +
             "          THEN \n" +
             "             'Возврат ДС готов к выполнению' \n" +
             "          WHEN n.t_subkind_operation = 10 and s_enroll.t_isexecute = CHR (88) \n" +
             "               AND s_refund.t_isexecute IS NULL \n" +
             "          THEN \n" +
             "             'Зачисление выполнено' \n" +
             "          WHEN n.t_subkind_operation = 20 and s_enroll.t_isexecute = CHR (88) \n" +
             "               AND s_refund.t_isexecute IS NULL \n" +
             "          THEN \n" +
             "             'Вывод выполнен' \n" +
             "          WHEN n.t_subkind_operation = 10 and s_enroll.t_isexecute <> CHR (88) \n" +
             "               AND s_refund.t_isexecute IS NULL \n" +
             "          THEN \n" +
             "             'Зачисление готово к выполнению' \n" +
             "          WHEN n.t_subkind_operation = 20 and s_enroll.t_isexecute <> CHR (88) \n" +
             "               AND s_refund.t_isexecute IS NULL \n" +
             "          THEN \n" +
             "             'Вывод готов к выполнению' \n" +
             "       END \n" +
             "          status, \n" +
             "       NVL(TRIM(RSB_STRUCT.GETSTRING(                                            " +
             "                  rsi_rsb_kernel.GetNote(131, LPAD(n.t_id, 34, '0'), 1, "+GEtSQLDate(parm.EndDate)+")))        " +
             "                  , CHR(1)) com, \n" +
             //"       case when n.t_subkind_operation = 20 then n.t_code else ' ' end reqnum, " +
             "       n.t_code reqnum, " +
             "       nvl(case when n.t_subkind_operation = 10 then  to_char(s_refund.t_syst_date,'dd.mm.yyyy')||'  '||to_char(s_refund.t_syst_time,'hh24:mi:ss')  else ' ' end,' ') dattm," +
             "       n.t_id, \n" +
             "       ' ', \n" +
             "       ' ' \n" +
             "  FROM dnptxop_dbt n  " +
             "           left join doproper_dbt o on (n.t_id = o.t_documentid \n " +
             "              AND n.t_kind_operation = o.t_kind_operation       \n " +
             "              AND n.t_dockind = o.t_dockind)                     \n " +
             "          LEFT JOIN \n" +
             "             doprstep_dbt s_enroll \n" +
             "          ON (    s_enroll.t_kind_operation = o.t_kind_operation \n" +
             "              AND s_enroll.t_id_operation = o.t_id_operation \n" +
             "              AND s_enroll.t_blockid = 203702 \n" +
             "              AND s_enroll.t_number_step = 110) \n" +
             "       LEFT JOIN \n" +
             "          doprstep_dbt s_refund \n" +
             "       ON (    s_refund.t_kind_operation = o.t_kind_operation \n" +
             "           AND s_refund.t_id_operation = o.t_id_operation \n" +
             "           AND s_refund.t_blockid = 203704 \n" +
             "           AND s_refund.t_number_step = 107) \n" +
             "       INNER JOIN dparty_Dbt p ON (p.t_partyid = n.t_client) \n" +
             " WHERE     n.t_kind_operation = 2037 \n" +
             "       AND ("+IIF(parm.NptxopCreated or parm.NptxopRefunded or parm.NptxopCompletedEnroll, " ( n.t_subkind_operation =  10 )", "(1<>1)") + " \n" +
             "         or "+IIF(parm.NptxopCompletedWrtoff, "( n.t_subkind_operation =  20 )", "(1<>1)") + ")" +
             "       and ("+IIF(parm.NptxopCreated, "(( n.t_subkind_operation =  10 ) and (s_enroll.t_isexecute is null or s_refund.t_isexecute is null ))","(1<>1)") + 
             "         or "+IIF(parm.NptxopRefunded, "(( n.t_subkind_operation =  10 ) and (s_enroll.t_isexecute is null and s_refund.t_isexecute is not null ))","(1<>1)") + 
             "         or "+IIF(parm.NptxopCompletedWrtoff, "( n.t_subkind_operation =  20 )","(1<>1)") + 
             "         or "+IIF(parm.NptxopCompletedEnroll, "(( n.t_subkind_operation =  10 ) and (s_enroll.t_isexecute is not null and s_refund.t_isexecute is null ))","(1<>1)") + ")" +
             "       AND t_operdate between " +GEtSQLDate(parm.BegDate)+ " and " + GEtSQLDate(parm.EndDate) + ") tt";


/*   var NptxopCreated   : bool;
   var NptxopRefunded  : bool;
   var NptxopCompletedEnroll : bool;
   var NptxopCompletedWrtoff : bool;*/

     cmd = RSDCommand(sql);
     rs = RSDRecordset(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);
     var cnt = 0;
     InitProgress(SQL_GetNRecs(sql),"Формирование отчета", "Выполнение");
     while(rs and rs.MoveNext())
       if (parm.RepType == REPTYPE_WRTOFF)
          PrintStrWrtOff(rs.value("num"), 
                   Sql_ConvTypeDate(rs.value("t_date")), 
                   rs.value("t_time"), 
                   rs.value("t_state"), 
                   rs.value("t_contrnumber"), 
                   rs.value("t_clientname"),
                   rs.value("t_sum"),
                   rs.value("t_currency"),
                   rs.value("reqnum"),
                   rs.value("dttm"),
                   rs.value("t_comment")
                   );
       else
       PrintStr(rs.value("num"), 
                Sql_ConvTypeDate(rs.value("t_date")), 
                rs.value("t_time"), 
                rs.value("t_state"), 
                rs.value("t_contrnumber"), 
                rs.value("t_clientname"),
                rs.value("t_sum"),
                rs.value("t_currency"),
                rs.value("t_comment")
                );
       end;
       UseProgress(cnt=cnt+1);
     end;
     RemProgress;
end;

class(TRsbPanel) DatePanel()

  var LBegDate:TRsbLabel, ,
      FieldDate:TRsbEditField, 
      BegDate:date = date(0,0,0),
      EndDate:date = date(0,0,0);

  InitTRsbPanel();
  SetCaption("Параметры выпуска");
  SetStatus("~Esc~ Выход ~F3~ Календарь ~F2~ Выполнить ~F9~ Выполнить");
  SetSize(42, 4);
  SetPosition(45,10);
  
  LBegDate = TRsbLabel(3, 2, "Период с:");
  addLabel(LBegDate);
  
  FieldDate = TRsbEditField(FT_DATE);
  FieldDate.setPosition(12,2);
  FieldDate.setSize(10,1);
  FieldDate.Name = "BegDate";
  FieldDate.bindValue( this, "BegDate" );
  FieldDate.value = {Curdate};
  addControl(FieldDate);
  
  LBegDate = TRsbLabel(23, 2, "по");
  addLabel(LBegDate);
  
  FieldDate = TRsbEditField(FT_DATE);
  FieldDate.setPosition(26,2);
  FieldDate.setSize(10,1);
  FieldDate.Name = "EndDate";
  FieldDate.bindValue( this, "EndDate" );
  FieldDate.value = {Curdate};
  addControl(FieldDate);

  
  addEventHandler(RSB_EV_KEY_PRESSED, R2M(this, "KeyEvent"));//KeyEvent
  
  
  macro KeyEvent(RsbEvent:Object)
    var focusedControl;
    
    if (rsbEvent.KeyCode == 27)//ESC
      this.Close(rsbEvent.KeyCode);
    elif ((rsbEvent.KeyCode == 316) or (rsbEvent.KeyCode == 323))//F2 or F9
      BegDate = GetControl("BegDate").value;
      EndDate = GetControl("EndDate").value;
      this.Close(rsbEvent.KeyCode);
    elif (rsbEvent.KeyCode == 317)//F3
      focusedControl = this.focusedControl();
      if(focusedControl.Name == "BegDate")
        BegDate = GetDateByCalendar(BegDate);
        GetControl("BegDate").Value = BegDate;
      elif(focusedControl.Name == "EndDate")
        EndDate = GetDateByCalendar(EndDate);
        GetControl("EndDate").Value = EndDate;
      end;
    end;
  end;
  
end;


macro RunReport(parm : TReportParm)

   FProcPanel = DatePanel();
   ExitCode = FProcPanel.Run();
   parm.BegDate = FProcPanel.BegDate;
   parm.EndDate = FProcPanel.EndDate;

   if(ExitCode)
     Rep = CMakeReport("┌┬┬┬┬┬┬┬┬┐");
     Rep.SetDefaultFontName("Times New Roman");
     Rep.SetDefaultFontSize(12);
     Rep.SetFlagShowGrid(true);

     Rep.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
     Rep.AddEmptyStr();
     Rep.AddEmptyStr();
     Rep.AddPrintCell(GetHeaderText(parm), 101, null, "c:ex_FS(b):ex_B()");
     Rep.AddStr();

     print_header(parm.RepType);
     GetData(parm);

     Rep.PrintWinRep("Отчет");
     Rep.SetZoomType(ZOOM_TYPE_A4L);
     Rep.SetWinRepOutput();
     Rep.ShowWinRep();

   end;
end;

/*const REPTYPE_ENROLL_ALL = 1,
      REPTYPE_ENROLL_COMPLETED = 2,
      REPTYPE_WRTOFF = 3;
*/
//var parm = TReportParm;
//parm.Init(REPTYPE_ENROLL_ALL);
//RunReport(parm);



