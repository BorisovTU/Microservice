/*
$Name:             OwnSubordBondOpenAcc.mac
$Module:           Ценные бумаги 
$Description:      Открытие счетов для субординированных ОЭБ
*/
import DealsInter, spserv, sp_class, sp_car, spreserv;
import "estimdoc.mac";

macro OpenAccountsForOwnSubordBond
  var FD = NULL;
  var Acc = TRecHandler("account.dbt");
  var PlaceAcc = TRecHandler("account.dbt");
  var dat = {curdate};
  var CatCode = "";
  var msg = "";
  var FIID = 0;

  getParm(0, FIID);

  if(FIID <= 0)
    msgbox("Не задан индентификатор ц/б");
    return;
  end;

  FD = SPFirstDocFI(DLDOC_ISSUE, FIID, FIID, -1, {OurBank}, true, true, null );

  if(FD.avoiriss.rec.Subordinated != SET_CHAR)
    msgbox("Ц/б не является субординированной");
    return;
  end;

  if(FD.fininstr.rec.Issuer != {OurBank})
    msgbox("Ц/б не является эмитированной банком");
    return;
  end;

  
  CatCode = КодКатегорииРазмещОЭБ(FD, dat);
  if( not FD.OpenAccount(CatCode, null, null, FIROLE_AJUSTVALOEB, PlaceAcc, dat, null) )
    msg = GetErrMsg();
    msgbox("Ошибка при открытии счета по КУ \"" + CatCode+"\": "+msg+".");
  end;

  CatCode = КодКатегорииПремияОЭБ(FD, dat);
  if( not FD.OpenAccount(CatCode, null, null, FIROLE_AJUSTVALOEB, Acc, dat, null) )
    msg = GetErrMsg();
    msgbox("Ошибка при открытии счета по КУ \"" + CatCode+"\": "+msg+".");
  end;

  CatCode = КодКатегорииДисконтОЭБ(FD, dat);
  if( not FD.OpenAccount(CatCode, null, null, FIROLE_AJUSTVALOEB, Acc, dat, null) )
    msg = GetErrMsg();
    msgbox("Ошибка при открытии счета по КУ \"" + CatCode+"\": "+msg+".");
  end;

  if(GetSubordCvalTypeAttrID(FD.fininstr.rec.FIID) == OBJATTR_SUBORDCVALTYPE_DI)
    CatCode = "-Изм.кап., суборд.ОЭБ";
    if( not FD.OpenAccount(CatCode, null, null, FIROLE_AJUSTVALOEB, Acc, dat, null) )
      msg = GetErrMsg();
      msgbox("Ошибка при открытии счета по КУ \"" + CatCode+"\": "+msg+".");
    end;
    
    CatCode = "+Изм.кап., суборд.ОЭБ";
    if( not FD.OpenAccount(CatCode, null, null, FIROLE_AJUSTVALOEB, Acc, dat, null) )
      msg = GetErrMsg();
      msgbox("Ошибка при открытии счета по КУ \"" + CatCode+"\": "+msg+".");
    end;


    if(FD.fininstr.rec.FaceValueFI != NATCUR)
      var FDOver = PDocOverEstimate(PlaceAcc.rec.Chapter, PlaceAcc.rec.Code_Currency, PlaceAcc.rec.Account, PlaceAcc);
   
      CatCode = "+ПереоценкаА";
      var FindAccount = MC_FindAndOpenCommonAccByFD(CatCode,
                                                    FDOver,
                                                    dat,
                                                    0,
                                                    MC_OPENACC_CREATE,
                                                    Acc, null, null, null, null, null, null, null,  NULL, NULL, dat
                                                   );

      if(FindAccount == "")
        MsgBox("Счет категории \"" + CatCode + "\" неопределен или недоступен в данной операции");
      end;

      CatCode = "-ПереоценкаА";
      FindAccount = MC_FindAndOpenCommonAccByFD(CatCode,
                                                FDOver,
                                                dat,
                                                0,
                                                MC_OPENACC_CREATE,
                                                Acc, null, null, null, null, null, null, null,  NULL, NULL, dat
                                               );

      if(FindAccount == "")
        MsgBox("Счет категории \"" + CatCode + "\" неопределен или недоступен в данной операции");
      end;                                         
    end;

  end;


OnError(er)
  msgbox(er.Message);
end;
