import "dbo_message_mass.mac";

//DboScroll();
TMsgScroll.run_list;



/*
import RsbFormsInter, Scrolldbo, Календарь/*, dboall*/;
import "dbo_message_main.mac";

Class (TRecHandler) SendDboAll
  
    var client;
    var dogovor;
    var ClDog = "";

       initTRecHandler ("Senddbll", "SendDboAll.lbr", true); 

       this.("client")  = "Все";
       this.("dogovor") = "Все";
       this.("date1")   = {curdate};
       this.("date2")   = {curdate};
      
 
  Macro handler(dlg, cmd, id, key)

     var En, cnt = 0, cnt1 = 0 ;
             
    if ((cmd == DLG_KEY) and (key == 317))  // Клавиша F3

        if (id == 0)
             dlg.(0) = GetDateByCalendar (dlg.(0));
        elif (id == 1)
             dlg.(1) = GetDateByCalendar (dlg.(1));
        end;
 
        if (id == 2)
            client = 1;
            ScrollDBO(dlg.(0), dlg.(1), client);
            En = crid.createEnum;
            ClDog = "";

            While (En.next)
              ClDog = ClDog + En.Item + ", ";
              cnt = cnt + 1;
            End;

        ClDog = (SubStr ( ClDog, 1, StrLen (ClDog) - 2 ));

           if (cnt > 1);
              this.("client")  = "Несколько";
              this.("dogovor") = "Несколько";
              UpdateFields(dlg);
           elif  (cnt == 1)
              var sel, rs;
                  sel =  "select chr(0), party.t_partyid, sfcontr.t_id, dlcontr.t_dlcontrid, party.t_name, sfcontr.t_number, sfcontr.t_name t_namesf, sfcontr.t_datebegin "              
                   "from ddlcontr_dbt dlcontr "
                   "join dsfcontr_dbt sfcontr on sfcontr.t_id = dlcontr.t_sfcontrid and "
                   "                             sfcontr.t_department = 1 and " 
                   "                             sfcontr.t_datebegin >= to_date('" + dlg.(0) + "','dd.mm.yyyy') and "
                   "                             sfcontr.t_datebegin <= to_date('" + dlg.(1) + "','dd.mm.yyyy')  and "
                   "                             sfcontr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') "
                   "join dparty_dbt party on party.t_partyid = sfcontr.t_partyid where party.t_partyid = " + ClDog + "";
            
                 rs = RsdRecordSet(RsdCommand(sel));

            while(rs.moveNext())
                 cnt1 = cnt1 + 1;
            end;                                         
        
           if (cnt1 == 1);
               this.("client") = rs.value("t_name");
               this.("dogovor") = rs.value("t_namesf");
               UpdateFields(dlg);
           else
               this.("client") = rs.value("t_name");
               this.("dogovor") = "Несколько";
               UpdateFields(dlg);
           end;
        end;
     end;

       if (id == 3)
          client = 0;
          ScrollDBO(dlg.(0), dlg.(1), client, ClDog);
          En = crid.createEnum;
          While (En.next)
              cnt = cnt + 1;
          End;
         if (cnt > 1);
              this.("dogovor") = "Несколько";
              UpdateFields(dlg);
         elif  (cnt == 1)
     
            var sel2, rs2;

            sel2 =  "select chr(0), party.t_partyid, sfcontr.t_id, dlcontr.t_dlcontrid, party.t_name, sfcontr.t_number, sfcontr.t_name t_namesf, sfcontr.t_datebegin "              
                   "from ddlcontr_dbt dlcontr "
                   "join dsfcontr_dbt sfcontr on sfcontr.t_id = dlcontr.t_sfcontrid and "
                   "                             sfcontr.t_department = 1 and " 
                   "                             sfcontr.t_datebegin >= to_date('" + dlg.(0) + "','dd.mm.yyyy') and "
                   "                             sfcontr.t_datebegin <= to_date('" + dlg.(1) + "','dd.mm.yyyy')  and "
                   "                             sfcontr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') "
                   "join dparty_dbt party on party.t_partyid = sfcontr.t_partyid where dlcontr.t_dlcontrid = " + En.Item + "";
            
            rs2 = RsdRecordSet(RsdCommand(sel2));
            rs2.moveNext();

            this.("dogovor") = rs2.value("t_namesf");

            UpdateFields(dlg);
          end;
        end;

    elif ((cmd == DLG_KEY) and (key == 316))  // Клавиша F2


    var dlcid, pf;
    var selcnt, rscnt;
    var i = 0;
    var cntpb: integer;

  
      if ((this.("client")  == "Все")  and  (this.("dogovor") == "Все"))
            var sel3, rs3;

            sel3 = "select chr(0), party.t_partyid, sfcontr.t_id, dlcontr.t_dlcontrid, party.t_name, sfcontr.t_number, sfcontr.t_name t_namesf, sfcontr.t_datebegin "              
                   "from ddlcontr_dbt dlcontr "
                   "join dsfcontr_dbt sfcontr on sfcontr.t_id = dlcontr.t_sfcontrid and "
                   "                             sfcontr.t_department = 1 and " 
                   "                             sfcontr.t_datebegin >= to_date('" + dlg.(0) + "','dd.mm.yyyy') and "
                   "                             sfcontr.t_datebegin <= to_date('" + dlg.(1) + "','dd.mm.yyyy') and "
                   "                             sfcontr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') "
                   "join dparty_dbt party on party.t_partyid = sfcontr.t_partyid";
            
            rs3 = RsdRecordSet(RsdCommand(sel3));

            selcnt = "select count (*) "              
                   "from ddlcontr_dbt dlcontr "
                   "join dsfcontr_dbt sfcontr on sfcontr.t_id = dlcontr.t_sfcontrid and "
                   "                             sfcontr.t_department = 1 and " 
                   "                             sfcontr.t_datebegin >= to_date('" + dlg.(0) + "','dd.mm.yyyy') and "
                   "                             sfcontr.t_datebegin <= to_date('" + dlg.(1) + "','dd.mm.yyyy') and "
                   "                             sfcontr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') "
                   "join dparty_dbt party on party.t_partyid = sfcontr.t_partyid";
            
            rscnt = RsdRecordSet(RsdCommand(selcnt));
            rscnt.moveNext();
            cntpb = rscnt.value("count(*)");

      InitProgress (cntpb, "Выполнение", "Формирование сообщений");

             while (rs3.moveNext())

                  dlcid =  rs3.value("t_dlcontrid");
                  /*
                  pf = PrintForm(dlcid);
                  pf.Run();
                  */
                  pf = dboMessage(dlcid).CreateMessage(false,true);

                  println ("Клиент:  ", rs3.value("t_name"));
                  println ("Договор: ", rs3.value("t_namesf"));
                  //println ("Статус:  ", statMes);
                  println ("Статус:  ", pf.statMes);
                  println ("----------------------------------------------------------------");
                  i = i + 1;
                  UseProgress (i);
             end;
       RemProgress;
       return CM_CANCEL;

      else
        
        if  (client == 1)
        var CrDog = "";

            En = crid.createEnum;
            While (En.next)
                CrDog = CrDog + En.Item + ", ";
            End;
            CrDog = (SubStr ( CrDog, 1, StrLen (CrDog) - 2 ));

            var sel4, rs4;

            sel4 =  "select chr(0), party.t_partyid, sfcontr.t_id, dlcontr.t_dlcontrid, party.t_name, sfcontr.t_number, sfcontr.t_name t_namesf, sfcontr.t_datebegin "              
                   "from ddlcontr_dbt dlcontr "
                   "join dsfcontr_dbt sfcontr on sfcontr.t_id = dlcontr.t_sfcontrid and "
                   "                             sfcontr.t_department = 1 and " 
                   "                             sfcontr.t_datebegin >= to_date('" + dlg.(0) + "','dd.mm.yyyy') and "
                   "                             sfcontr.t_datebegin <= to_date('" + dlg.(1) + "','dd.mm.yyyy')  and "
                   "                             sfcontr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') "
                   "join dparty_dbt party on party.t_partyid = sfcontr.t_partyid where party.t_partyid in (" + CrDog + ")";
            
            rs4 = RsdRecordSet(RsdCommand(sel4));
        

            selcnt = "select count (*) "           
                   "from ddlcontr_dbt dlcontr "
                   "join dsfcontr_dbt sfcontr on sfcontr.t_id = dlcontr.t_sfcontrid and "
                   "                             sfcontr.t_department = 1 and " 
                   "                             sfcontr.t_datebegin >= to_date('" + dlg.(0) + "','dd.mm.yyyy') and "
                   "                             sfcontr.t_datebegin <= to_date('" + dlg.(1) + "','dd.mm.yyyy')  and "
                   "                             sfcontr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') "
                   "join dparty_dbt party on party.t_partyid = sfcontr.t_partyid where party.t_partyid in (" + CrDog + ")";            

            rscnt = RsdRecordSet(RsdCommand(selcnt));
            rscnt.moveNext();
            cntpb = rscnt.value("count(*)");

            InitProgress (cntpb, "Выполнение", "Формирование сообщений");

             while (rs4.moveNext())
                  dlcid =  rs4.value("t_dlcontrid");
                  /*
                  pf = PrintForm(dlcid);
                  pf.Run(); 
                  */

                  pf = dboMessage(dlcid).CreateMessage(false,true);

                  println ("Клиент:  ", rs4.value("t_name"));
                  println ("Договор: ", rs4.value("t_namesf"));
                  println ("Статус:  ", pf.statMes);
                  println ("----------------------------------------------------------------");
                  i = i + 1;
                  UseProgress (i);
             end;
            RemProgress;
            return CM_CANCEL;

         elif (client == 0)

         var CrDog1 = "";

            En = crid.createEnum;
            While (En.next)
                CrDog1 = CrDog1 + En.Item + ", ";
            End;
            CrDog1 = (SubStr ( CrDog1, 1, StrLen (CrDog1) - 2 ));
            var sel5, rs5;


            sel5 =  "select chr(0), party.t_partyid, sfcontr.t_id, dlcontr.t_dlcontrid, party.t_name, sfcontr.t_number, sfcontr.t_name t_namesf, sfcontr.t_datebegin "              
                   "from ddlcontr_dbt dlcontr "
                   "join dsfcontr_dbt sfcontr on sfcontr.t_id = dlcontr.t_sfcontrid and "
                   "                             sfcontr.t_department = 1 and " 
                   "                             sfcontr.t_datebegin >= to_date('" + dlg.(0) + "','dd.mm.yyyy') and "
                   "                             sfcontr.t_datebegin <= to_date('" + dlg.(1) + "','dd.mm.yyyy')  and "
                   "                             sfcontr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') "
                   "join dparty_dbt party on party.t_partyid = sfcontr.t_partyid where dlcontr.t_dlcontrid in (" + CrDog1 + ")";
            
            rs5 = RsdRecordSet(RsdCommand(sel5));

            selcnt = "select count (*) "              
                   "from ddlcontr_dbt dlcontr "
                   "join dsfcontr_dbt sfcontr on sfcontr.t_id = dlcontr.t_sfcontrid and "
                   "                             sfcontr.t_department = 1 and " 
                   "                             sfcontr.t_datebegin >= to_date('" + dlg.(0) + "','dd.mm.yyyy') and "
                   "                             sfcontr.t_datebegin <= to_date('" + dlg.(1) + "','dd.mm.yyyy')  and "
                   "                             sfcontr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') "
                   "join dparty_dbt party on party.t_partyid = sfcontr.t_partyid where dlcontr.t_dlcontrid in (" + CrDog1 + ")";
            
            rscnt = RsdRecordSet(RsdCommand(selcnt));
            rscnt.moveNext();
            cntpb = rscnt.value("count(*)");

      InitProgress (cntpb, "Выполнение", "Формирование сообщений");

             while (rs5.moveNext())
                  dlcid =  rs5.value("t_dlcontrid");
                  /*
                  pf = PrintForm(dlcid);
                  pf.Run(); 
                  */

                  pf = dboMessage(dlcid).CreateMessage(false,true);

                  println ("Клиент:  ", rs5.value("t_name"));
                  println ("Договор: ", rs5.value("t_namesf"));
                  println ("Статус:  ", pf.statMes);
                  println ("----------------------------------------------------------------");
                  i = i + 1;
                  UseProgress (i);
             end;
       RemProgress;
       return CM_CANCEL;
 
       end;

      end;
 
    end;
 
  End;

        
  Macro run
      rundialog (this, r2m (this, "handler"));
  End;

End;
 

SendDboAll.run();
*/


