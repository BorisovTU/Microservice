import RsbFormsInter, Global, or_rep_h;


private macro iif(a,b,c)
      if(a)
         return b;
      else
         return c;
      end;
   end;




CLASS OfferRep(pDAte,pRudata, pInPortfolio)

var Report;
var vDAte   = pDAte;
var vRuData = pRuData;
var vInPortfolio = pInPortfolio;
var rn = 1;
var EXCEL_MONEY = "\"# ##0,00\"";
var sheet = 1,n_sheet = 2;
var count = 0;

var col1_len = 25,  col2_len = 13, col3_len = 30;
var col4_len = 25,  col5_len = 14,  col6_len = 8;
var col7_len = 8,   col8_len = 10;
var color  = 12632256;  
var ColorD = 16316664;
var ColorL = 15395562;

var head_format = "ex_FS(b):ex_B(tblr):ex_BC(" + color + ")";
var format      = "ex_FS():ex_B(tblr):ex_BC(" + color + ")";

private macro ДобавитьСтроку()
  Report.AddStr();rn = rn + 1;
end;

private macro ДобавитьПустуюСтроку()
   Report.AddEmptyStr();rn = rn + 1;
end; 

private macro ПечатьШапки ()        

    ДобавитьПустуюСтроку();

    Report.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
    Report.SetExecute("iBook.Sheets("+sheet+").Range(\"A"+(rn)+":D"+(rn)+"\").merge;");
   
    ДобавитьСтроку();

    Report.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
    Report.SetExecute("iBook.Sheets("+sheet+").Range(\"A"+(rn)+":D"+(rn)+"\").merge;");
    Report.AddPrintCell("Отчет о будущих погашениях.", col1_len, null, "r:ex_FS(b):ex_B()");
    ДобавитьСтроку();

    Report.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
    Report.SetExecute("iBook.Sheets("+sheet+").Range(\"A"+(rn)+":D"+(rn)+"\").merge;");
    Report.AddPrintCell("Дата отчета: " + string(vDate):f, col1_len, null, "l:ex_FS(b):ex_B()");
    ДобавитьСтроку();

    ДобавитьПустуюСтроку();
/*1*/   Report.AddPrintCell ("Вид ФИ",         col1_len,  null, "c:" + head_format);
/*2*/   Report.AddPrintCell ("Форма выпуска",  col2_len,  null,"c:" + head_format);
/*2*/   Report.AddPrintCell ("Наименование",   col3_len,  null,"c:" + head_format);
/*4*/   Report.AddPrintCell ("Эмитент",        col4_len,  null, "c:"+ head_format);
/*5*/   Report.AddPrintCell ("Код ISIN",       col5_len,  null, "c:" + head_format);
/*6*/   Report.AddPrintCell ("Код CFI",        col6_len,  null,"c:" + head_format); 
/*7*/   Report.AddPrintCell ("Номинал",        col7_len,  null, "c:" + head_format);
/*8*/   Report.AddPrintCell ("Дата выкупа    ",col8_len,  null, head_format);


    ДобавитьСтроку;  color = colorD; head_format = "c:ex_FZ(8):ex_FS():ex_B(tblr):ex_BC(" + color + ")"; color = colorL;
/*1*/   Report.AddPrintCell ("1", col1_len,  null, head_format);
/*2*/   Report.AddPrintCell ("2", col2_len,  null, head_format);
/*3*/   Report.AddPrintCell ("3", col3_len,  null, head_format);
/*4*/   Report.AddPrintCell ("4", col4_len,  null, head_format);
/*5*/   Report.AddPrintCell ("5", col5_len,  null, head_format);
/*6*/   Report.AddPrintCell ("6", col6_len,  null, head_format); 
/*7*/   Report.AddPrintCell ("7", col7_len,  null, head_format);
/*8*/   Report.AddPrintCell ("8", col8_len,  null, head_format);

    Report.SetExecute("iBook.Sheets("+sheet+").Rows("+(rn-1)+").AutoFilter;");
    ДобавитьСтроку;
end;

private macro ПечатьЗакладки(nSheet,_rs)
   var n_rn = 1;
        report.AddNewSheetBreak(_rs.value("t_definition"), "┌┬┬┬┬┬┬┬┬┬┬┬┐");
        report.SetDefaultFontName("Times New Roman");
        report.SetDefaultFontSize(10);
        report.SetFlagShowGrid(false);

        var format_tblr = "ex_FS():ex_B(tblr)";
        var format_tblr_b = "ex_FS(b):ex_B(tblr)";
        var format_n = "ex_FS():ex_B()";
        var format_n_b = "ex_FS(b):ex_B()";
        var weight_double = 61, weight_single = 30;

        Report.AddPrintCell("", 3, null, "r:"+format_n);
        Report.AddPrintCell("", 3, null, "r:"+format_n);
        Report.AddPrintCell("", 3, null, "r:"+format_n);
        Report.AddStr();n_rn = n_rn + 1;

        Report.SetExecute("iBook.Sheets("+nSheet+").Range(\"B"+(rn)+":C"+(rn)+"\").merge;");
        Report.AddPrintCell("", 3, null, "l:"+format_n);
        Report.AddPrintCell("Депозитарий АО РОССЕЛЬХОЗБАНК", weight_double, null, "l:"+format_n);
        Report.AddStr();n_rn = n_rn + 1;

        Report.SetExecute("iBook.Sheets("+nSheet+").Range(\"B"+(rn)+":C"+(rn)+"\").merge;");
        Report.AddPrintCell("", 3, null, "l:"+format_n);
        Report.AddPrintCell("Фактический адрес: 119034,г.Москва, Гагаринский пер.,3", weight_double, null, "l:"+format_n);
        Report.AddStr();n_rn = n_rn + 1;

        Report.SetExecute("iBook.Sheets("+nSheet+").Range(\"B"+(rn)+":C"+(rn)+"\").merge;");
        Report.AddPrintCell("", 3, null, "l:"+format_n);
        Report.AddPrintCell("Телефон:(495)7877787,7771100,(495)981-36-62", weight_double, null, "l:"+format_n);
        Report.AddStr();n_rn = n_rn + 1;

        Report.SetExecute("iBook.Sheets("+nSheet+").Range(\"B"+(rn)+":C"+(rn)+"\").merge;");
        Report.AddPrintCell("", 3, null, "l:"+format_n);
        Report.AddPrintCell("Свидетельство о государственной регистрации юридического лица от 22.10.2002,ОГРН 1027700342890 Управление МНС России по г.Москва", weight_double, null, "l:"+format_n);
        Report.AddStr();n_rn = n_rn + 1;

        Report.SetExecute("iBook.Sheets("+nSheet+").Range(\"B"+(rn)+":C"+(rn)+"\").merge;");
        Report.AddPrintCell("", 3, null, "l:"+format_n);
        Report.AddPrintCell("Лицензия на осуществление депозитарной деятельности 077-08461-000100 от 19.05.2005 ФСФР России", weight_double, null, "l:"+format_n);
        Report.AddStr();n_rn = n_rn + 1;

        Report.SetExecute("iBook.Sheets("+nSheet+").Range(\"B"+(rn)+":C"+(rn)+"\").merge;");
        Report.AddPrintCell("", 3, null, "l:"+format_n);
        Report.AddPrintCell("Отчет о будущих погашениях", weight_double, null, "c:"+format_n_b);
        Report.AddStr();n_rn = n_rn + 1;

        Report.SetExecute("iBook.Sheets("+nSheet+").Range(\"B"+(rn)+":C"+(rn)+"\").merge;");
        Report.AddPrintCell("", 3, null, "l:"+format_n);
        Report.AddPrintCell("Дата отчета: " + string(vDate):f, weight_double, null, "l:"+format_n_b);
        Report.AddStr();n_rn = n_rn + 1;

        Report.AddPrintCell("", 3, null, "l:"+format_n);
        Report.AddPrintCell("Вид ФИ", 30, null, "l:"+format_tblr);Report.AddPrintCell(_rs.value("T_NAME"), weight_single, null, "l:"+format_tblr);
        Report.AddStr();n_rn = n_rn + 1;

        Report.AddPrintCell("", 3, null, "l:"+format_n);
        Report.AddPrintCell("Форма выпуска ФИ", weight_single, null, "l:"+format_tblr);Report.AddPrintCell(IIF(_rs.value("T_SETTLEMENT_CODE"),"Документарная","Бездокументарная"), weight_single, null, "l:"+format_tblr);
        Report.AddStr();n_rn = n_rn + 1;

        Report.AddPrintCell("", 3, null, "l:"+format_n);
        Report.AddPrintCell("Наименование ФИ", weight_single, null, "l:"+format_tblr);Report.AddPrintCell(_rs.value("t_definition"), weight_single, null, "l:"+format_tblr);
        Report.AddStr();n_rn = n_rn + 1;


        Report.AddPrintCell("", 3, null, "l:"+format_n);
        Report.AddPrintCell("Эмитент", weight_single, null, "l:"+format_tblr);Report.AddPrintCell(_rs.value("t_shortname"), weight_single, null, "l:"+format_tblr);
        Report.AddStr();n_rn = n_rn + 1;

        Report.AddPrintCell("", 3, null, "l:"+format_n);
        Report.AddPrintCell("Код ISIN", weight_single, null, "l:"+format_tblr);Report.AddPrintCell(_rs.value("t_isin"), weight_single, null, "l:"+format_tblr);
        Report.AddStr();n_rn = n_rn + 1;

        Report.AddPrintCell("", 3, null, "l:"+format_n);
        Report.AddPrintCell("Код CFI", weight_single, null, "l:"+format_tblr);Report.AddPrintCell(_rs.value("cfi"), weight_single, null, "l:"+format_tblr);
        Report.AddStr();n_rn = n_rn + 1;

        Report.AddPrintCell("", 3, null, "l:"+format_n);
        Report.AddPrintCell("Номинал", weight_single, null, "l:"+format_tblr);Report.AddPrintCell(_rs.value("nominal"), weight_single, null, "l:"+format_tblr);
        Report.AddStr();n_rn = n_rn + 1;      

        Report.SetExecute("iBook.Sheets("+nSheet+").Range(\"B"+(rn)+":C"+(rn)+"\").merge;");
        Report.AddPrintCell("", 3, null, "l:"+format_n);
        Report.AddPrintCell("Выкупы", weight_double, null, "c:"+format_tblr_b);
        Report.AddStr();n_rn = n_rn + 1;  

        Report.SetExecute("iBook.Sheets("+nSheet+").Range(\"B"+(rn)+":C"+(rn)+"\").merge;");
        Report.AddPrintCell("", 3, null, "l:"+format_n);
        Report.AddPrintCell("Контрольный срок 50 дн.", weight_double, null, "l:"+format_tblr);
        Report.AddStr();n_rn = n_rn + 1;          

        Report.AddPrintCell("", 3, null, "l:"+format_n);
        Report.AddPrintCell("Дата выкупа(плановая)", weight_single, null, "l:"+format_tblr);Report.AddPrintCell(date(_rs.value("T_DATEREDEMPTION")), weight_single, null, "l:"+format_tblr);
        Report.AddStr();n_rn = n_rn + 1;  

        Report.AddPrintCell("", 3, null, "l:"+format_n);
        Report.AddPrintCell("Цена выкупа", weight_single, null, "l:"+format_tblr);Report.AddPrintCell("", weight_single, null, "l:"+format_tblr);
        Report.AddStr();n_rn = n_rn + 1; 

        Report.AddPrintCell("", 3, null, "l:"+format_n);
        Report.AddPrintCell("Лицо, выкупающее ФИ", weight_single, null, "l:"+format_tblr);Report.AddPrintCell(_rs.value("t_shortname"), weight_single, null, "l:"+format_tblr);
        Report.AddStr();n_rn = n_rn + 1; 

        Report.AddPrintCell("", 3, null, "l:"+format_n);
        Report.AddPrintCell("Дата объявления об операции", weight_single, null, "l:"+format_tblr);Report.AddPrintCell(" ", weight_single, null, "l:"+format_tblr);
        Report.AddStr();n_rn = n_rn + 1; 

        Report.AddPrintCell("", 3, null, "l:"+format_n);
        Report.AddPrintCell("Период действия предложения", weight_single, null, "l:"+format_tblr);Report.AddPrintCell("с  по  ", weight_single, null, "l:"+format_tblr);
        Report.AddStr();n_rn = n_rn + 1; 

        Report.AddPrintCell("", 3, null, "l:"+format_n);
        Report.AddPrintCell("Комментарий", weight_single, null, "l:"+format_tblr);Report.AddPrintCell("   ", weight_single, null, "l:"+format_tblr);
        Report.AddStr();n_rn = n_rn + 1;                

        report.SetCurSheet(0);
end;

private macro ПечатьБлокаДанных(_rs);
    if(valtype(_rs) != v_undef)
    format = "ex_FS():ex_B(tblr)";
      while(_rs.movenext)
        Report.AddPrintCell(_rs.value("T_NAME"), col1_len, null, "l:"+format); // 1. 
        Report.AddPrintCell(IIF(_rs.value("T_SETTLEMENT_CODE"),"Документарная","Бездокументарная"), col2_len, null, "l:"+format); // 2.  
        Report.AddPrintCell(_rs.value("t_definition"), col3_len, null, "l:"+format); // 3. 
        Report.AddPrintCell(_rs.value("t_shortname"), col4_len, null, "c:"+format); // 4. 
        Report.AddPrintCell(_rs.value("t_isin"), col5_len, null, "c:"+format); // 5. 
        Report.AddPrintCell(_rs.value("cfi"), col6_len, null, "r:"+format); // 6. 
        Report.AddPrintCell(_rs.value("nominal"), col7_len, null, "r:"+format); // 7. 
        Report.AddPrintCell(date(_rs.value("T_DATEREDEMPTION")), col8_len, null, "r:"+format); // 8. 
        ДобавитьСтроку;
        
        ПечатьЗакладки(n_sheet,_rs); n_sheet = n_sheet + 1;
              
      end;
    end;
end;

macro run()
var SQL, cmd, rs;

  Report = CMakeReport("┌┬┬┬┬┬┬┬┬┬┬┬┐");
  Report.SetDefaultFontName("Times New Roman");
  Report.SetDefaultFontSize(10);
  Report.SetFlagShowGrid(true);

  ПечатьШапки();

SQL = "WITH dOffers AS (SELECT *     " +
      "                   FROM (  SELECT t_fiid, " +
      "                                  t_offernum, " +
      "                                  T_DATEREDEMPTION, " +
      "                                  0 AS t_RuData " +
      "                             FROM doffers_dbt " +
      "                         ORDER BY t_fiid, t_offernum) " +
      "                 UNION " +
      "                 SELECT * " +
      "                   FROM (  SELECT (SELECT c.t_objectid " +
      "                                     FROM dobjcode_dbt c " +
      "                                    WHERE     c.t_objecttype = 9 " +
      "                                          AND c.t_codekind = 104 " +
      "                                          AND c.t_code = sbo.id_fintool " +
      "                                          AND c.t_state = 0) " +
      "                                     t_fiid, " +
      "                                  TO_NUMBER (sbo.id_offer) AS t_offernum, " +
      "                                  sbo.end_offer_date AS T_DATEREDEMPTION, " +
      "                                  1 AS t_RuData " +
      "                             FROM sofr_bond_offers sbo " +
      "                            WHERE (SELECT c.t_objectid " +
      "                                     FROM dobjcode_dbt c " +
      "                                    WHERE     c.t_objecttype = 9 " +
      "                                          AND c.t_codekind = 104 " +
      "                                          AND c.t_code = sbo.id_fintool " +
      "                                          AND c.t_state = 0) " +
      "                                     IS NOT NULL " +
      "                                  AND sbo.end_offer_date IS NOT NULL " +
      "                         ORDER BY sbo.id_fintool, sbo.id_offer)) " +
      "SELECT avrk.t_name, " +
      "       p.t_shortname, " +
      "       p.t_partyid, " +
      "       fi.t_fi_kind, " +
      "       fi.t_avoirkind, " +
      "       FI.T_SETTLEMENT_CODE, " +
      "       fi.t_definition, " +
      "       p.t_shortname, " +
      "       av.t_isin, " +
      "       rsb_fiinstr.fi_getnominalondate (fi.t_fiid, to_date('" + vDate + "','dd.mm.yyyy')) nominal, " +
      "       (SELECT obj.t_code " +
      "          FROM dobjcode_dbt obj " +
      "         WHERE     obj.t_objecttype = 9 " +
      "               AND obj.t_objectid = fi.t_fiid " +
      "               AND obj.t_codekind = 18 " +
      "               AND obj.t_bankdate <= to_date('" + vDate + "','dd.mm.yyyy') " +
      "               AND (obj.t_bankclosedate = " +
      "                       TO_DATE ('01.01.0001', 'dd.mm.yyyy') " +
      "                    OR obj.t_bankclosedate > to_date('" + vDate + "','dd.mm.yyyy')) " +
      "               AND ROWNUM = 1) " +
      "          cfi, " +
      "       offers.T_DATEREDEMPTION " +
      "  FROM dfininstr_dbt fi, " +
      "       davoiriss_dbt av, " +
      "       dparty_dbt p, " +
      "       davrkinds_dbt avrk, " +
      "       doffers offers " +
      " WHERE     av.t_fiid = fi.t_fiid " +
      "       AND fi.t_issuer = p.t_partyid " +
      "       AND fi.t_fi_kind = avrk.t_fi_kind " +
      "       AND fi.t_avoirkind = avrk.t_avoirkind " +
      "       AND offers.t_fiid = fi.t_fiid " +
      "       AND offers.T_DATEREDEMPTION BETWEEN to_date('" + vDate + "','dd.mm.yyyy') AND (to_date('" + vDate + "','dd.mm.yyyy') + 50) " +
      "       AND offers.t_RuData = " + vRuData ;  //UseRuData
     if (vInPortfolio == 1) 
         SQL = SQL +  "       AND offers.t_fiid IN " +
              "              (SELECT DISTINCT v.t_fiid " +
              "                 FROM v_scwrthistex v " +
              "                WHERE t_state IN (1, 3,20,21) AND t_amount > 0 " +
              "                      AND t_instance = " +
              "                             (SELECT MAX (t_instance) " +
              "                                FROM v_scwrthistex " +
              "                               WHERE v.t_sumid = t_sumid " +
              "                                     AND v.t_changedate = t_changedate) " +
              "                      AND t_party = -1 " +
              "                      AND v.t_changedate = " +
              "                             (SELECT MAX (t.t_changedate) " +
              "                                FROM v_scwrthistex t " +
              "                               WHERE v.t_sumid = t_sumid " +
              "                                     AND t.t_changedate <= to_date('" + vDate + "','dd.mm.yyyy'))) " ;
      end;


   
    cmd = RSDCommand(SQL);
    begaction(100,"Сбор данных...");

    rs = RSDRecordset(cmd, rsdval_client,rsdval_static);
      ПечатьБлокаДанных(rs);
      endaction;

      Report.PrintWinRep("Предстоящие погашения.");
      Report.SetWinRepOutput();
      Report.ShowWinRep();

end;  

END;


CLASS (TRsbPanel) Pan
    initTRsbPanel();

    const Delta = 50;

    const K_Enter = 13;
    const K_F3    = 317;
    const K_F2    = 316;

    const BeginCalcDate_ID = 1;

    var curstr = 1;
    Caption = "Предстоящие оферты";
    Status = "~ESC~Выход ~F2~Выполнить";
    setSize(37,5);
    setPosition(30,10);
    var BeginCalcDate, EndCalcDate, UseRuData, InPortfolio, dx;
    var RuDataFlag = 0;
    var InPortfolioFlag = 1;

    curstr = curstr+1;
    BeginCalcDate = TRsbEditField(V_DATE);
    BeginCalcDate.setPosition(16,curstr);
    BeginCalcDate.setSize(8,1);
    BeginCalcDate.name = "begincalcdate";
    BeginCalcDate.value = {curdate};
    addControl(BeginCalcDate);

    EndCalcDate = TRsbEditField(V_DATE);
    EndCalcDate.setPosition(27,curstr);
    EndCalcDate.setSize(8,1);
    EndCalcDate.name = "endincalcdate";
    EndCalcDate.value = {curdate} + 50;
    addControl(EndCalcDate);

    var m_LabelCD:TrsbLabel = TRsbLabel(2,curstr,"Оферты за период:");
    addLabel (m_LabelCD);

    var m_LabelT:TrsbLabel = TRsbLabel(25,curstr,"~");
    addLabel (m_LabelT);
 
    curstr = curstr+1;
    InPortfolio = TRsbCheckbox;
    InPortfolio.setPosition(2,curstr);
    InPortfolio.name = "InPortfolio";
    InPortfolio.checked = True;
    InPortfolio.setsize(1,1);
    addControl(InPortfolio);

    var m_LabelInPortfolio:TrsbLabel = TRsbLabel(18,curstr,":Только портфель Банка." );
    m_LabelInPortfolio.setsize(23,1);
    addLabel (m_LabelInPortfolio);

 
    curstr = curstr+1; 
    UseRuData = TRsbCheckbox;
    UseRuData.setPosition(2,curstr);
    UseRuData.name = "UseRuData";
    UseRuData.checked = False;
    UseRuData.setsize(1,1);
    addControl(UseRuData);

    var m_LabelUseRuData = TRsbLabel(18,curstr,":Использовать RuData." );
    m_LabelUseRuData.setsize(23,1);
    addLabel (m_LabelUseRuData);


    addEventHandler(RSB_EV_KEY_PRESSED, R2M(this, "onKeyPressed"));
    addEventHandler(RSB_EV_CONTROL_CHECKED,R2M(this,"OnChecked"));

    EndCalcDate.editable = not EndCalcDate.editable;

    macro OnChecked(RsbEvent:Object)
    
       if (RsbEvent.id == RSB_EV_CONTROL_CHECKED)
          if (RsbEvent.source.name == "UseRuData")
             if (RuDataFlag == 0)
                RuDataFlag = 1;
             else
                RuDataFlag = 0;
             end;
             this.redraw();
          end;
          if (RsbEvent.source.name == "InPortfolio")
             if (InPortfolioFlag == 0)
                InPortfolioFlag = 1;
             else
                InPortfolioFlag = 0;
             end;
             this.redraw();
          end;
       end;
         
       return true;
    end;

    macro onKeyPressed(ev)
        if (ev.KeyCode == K_F3)
           if (ev.id == BeginCalcDate_ID)
            BeginCalcDate.value = GetDateByCalendar({CurDate});
            EndCalcDate.value   = BeginCalcDate.value + Delta;
            this.redraw; 
           end;
        elif (ev.KeyCode == K_Enter)
            //this.update;
            EndCalcDate.value = BeginCalcDate.value + Delta;
            this.redraw; 
        elif(ev.keyCode == K_F2)
         EndCalcDate.value   = BeginCalcDate.value + Delta;
        
         var myRep = OfferRep(BeginCalcDate.value, RuDataflag, InPortfolioFlag);
         myRep.run;
        end;
    end; 
END;

var myPanel:TRsbPanel = Pan;
myPanel.run;
exit(1);
