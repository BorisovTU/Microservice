/*
$Name:        paymlink.mac
$Description: Модификация ссылки на ТО по платежу
$Programmer:  Кротов А.
*/
import dlquery;
import captureoutput;


/*Вставка/удаление связки с ТО по платежу на постобработке выполнения/отката шага*/
macro ModifyLink(rsPM, CommitOrRollback, ID_Operation, ID_Step, DocKind, DocID)
  var cmdL;

  /*Откат шага*/
  if(CommitOrRollback == 2)
    StartCaptureOutput();
    [ 
      delete from drqpmlink_dbt rqpmlink
      where rqpmlink.t_servdockind = ? and
            rqpmlink.t_servdocid = ? and
            not exists(select 1 from ddlrq_dbt dlrq where dlrq.t_id = rqpmlink.t_rqid)
    ];
    cmdL = RSDCommand(EndCaptureOutput());
    cmdL.AddParam("dockind", RSDBP_IN, DocKind);
    cmdL.AddParam("docid", RSDBP_IN, DocID);
    cmdL.Execute();
  /*Выполнение шага*/
  else
    /*Проходим по платежам*/
    while(rsPM.movenext())
      StartCaptureOutput();
      [ 
        insert into drqpmlink_dbt
        select dlrq.t_id, dlrq.t_docid, dlrq.t_dockind, ?
        from ddlrq_dbt dlrq 
        where dlrq.t_dockind = ? and 
              dlrq.t_docid = ? and 
              dlrq.t_id_operation = ? and 
              dlrq.t_id_step = ?
      ];
      cmdL = RSDCommand(EndCaptureOutput());
      cmdL.AddParam("paymentid", RSDBP_IN, rsPM.value("t_paymentid"));
      cmdL.AddParam("dockind", RSDBP_IN, DocKind);
      cmdL.AddParam("docid", RSDBP_IN, DocID);
      cmdL.AddParam("id_operation", RSDBP_IN, ID_Operation);
      cmdL.AddParam("id_step", RSDBP_IN, ID_Step);
      cmdL.Execute();
    end;              
  end;

  /*Возвращаем результат*/
  return 1;
end;

