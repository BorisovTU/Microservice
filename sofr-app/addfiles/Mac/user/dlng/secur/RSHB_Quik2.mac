/*
$Name:        RSHB_Quik2.mac
$Module:      Ценные бумаги
$Description: Сверка лимитов
*/

import oralib, likepy, globals, rsexts, commonutil/*, commoninter*/;
import "DlRepForm_h.mac", "dlmisc.mac","globals", Календарь, RSD, RsbDataSet, "or_tpl_h.mac",prnfrm,or_tpl_h, PTInter,rcw;
import RsbFormsInter, "scincfun.mac", "lim_utils.mac";

private const MICEX_CODE_CURMARKET   = "MB0134700000";
private const MICEX_CODE_STOCKMARKET = "MC0134700000";

private const PROC_LD_FUTUR = "LoadDataFutur";
private const PROC_LD_SECUR = "LoadDataSecur";

private const BIG_TABLE_ROW_LIMIT = 1000000; //10000;

//Сверка данных по фондовому рынку


private macro getQueryWhere(alias,secur_checked, cur_checked, first_cond)
   var query_where = "";
   if (ValType(first_cond) == V_UNDEF)
      first_cond = false;
   end;

   if (alias != "")
      alias = alias + ".";
   end;

   if (( secur_checked ) and (cur_checked))
      query_where = " ("+alias+"t_firm_id = '"+MICEX_CODE_CURMARKET+"' or "+alias+"t_firm_id = '"+MICEX_CODE_STOCKMARKET+"') ";
   elif( secur_checked )
      query_where = " "+alias+"t_firm_id = '"+MICEX_CODE_STOCKMARKET+"' ";
   elif(cur_checked)
      query_where = " "+alias+"t_firm_id = '"+MICEX_CODE_CURMARKET+"' ";
   else
      query_where = "  1 = 1  ";
   end;

   return iif(first_cond, " where ", " and ") +  query_where;
end;

private macro CreateNextFileName(fileName:string, lsFiles:@tarray) : string
   var Dir :string = "";
   var Name:string = "";
   var Ext :string = "";

   Dir = SplitFile(fileName, Name, Ext);

   if( lsFiles.Size > 1 )
      SplitFile(lsFiles[0], Name, NULL);
   end;

   return string(Dir, Name, "_", lsFiles.Size, Ext);
end;

private macro store_file_csv(pref, lsFiles:@tarray)
  var rslDefCon,strm ;
  var resultStr, idx,file_csv;
  file_csv ="..\\txtfile\\"+string(UserNumber)+pref+".txt";  
  strm = TStream(file_csv, "C");

  lsFiles[lsFiles.size] = file_csv;

  idx = 1;
  var endStr = "";
  while(true)
    rslDefCon = RsdCommand(" begin "+
                           " ? := it_rsl_string.get_varchar(?); "+
                              " end;" );
    rslDefCon.addParam("v_result",RSDBP_OUT,V_STRING, 32768);
    rslDefCon.addParam("p_index",RSDBP_IN,idx);
    rslDefCon.execute();

    resultStr = rslDefCon.value("v_result");
    resultStr = StrSubst(resultStr, StrFor(1), StrFor(0));
    
    if ( (StrLen(resultStr) == 0) and (StrLen(endStr) == 0) );
      break;
    end;
    if (idx > 1)
       strm.Flush();
       strm = NULL;
       file_csv = CreateNextFileName(file_csv, lsFiles);
       strm = TStream(file_csv, "C");
       lsFiles[lsFiles.size] = file_csv;
	   //пишем прошлую последнюю строку в новый файл
	   if (StrLen(endStr) != 0)
	     strm.write(ToANSI(endStr,true));
		 endStr = "";
	   end;
    end;
    //отрежем из строки последнюю, так как она может быть разбитой
	var sLen = StrLen(resultStr);
    var sPos = sLen;
    while (sPos > 0)
      if ((SubStr(resultStr, sPos, 1) == "\n") and (sPos != sLen))
	    break;
	  end;
	  sPos = sPos - 1;
    end;
	if (sPos > 0)
		endStr    = SubStr(resultStr, sPos+1);
		resultStr = SubStr(resultStr, 1, sPos-1);
	end;
    //
    strm.write(ToANSI(resultStr,true));
    idx = idx + 1;
  end;
  if (idx==1)
   strm.write(" ;\n");
  end;
  strm.Flush();
  execSQL("begin it_rsl_string.clear; end;"); // Очистка буфера
  return file_csv;
end;

macro CallSetColor(Ob:object, color)
  Ob.SetFrColor(color);
OnError
  return;
end;

macro CheckDataSecur(secur_checked, cur_checked, ShowAppl, TermPath:@string, err:@string, IsAdd, IsShort)
   var folder_auto, n = 0;
   var compareDate = null;
   var lsFiles_ds:tArray = tarray();
   var lsFiles_ss:tArray = tarray();
   var lsFiles_qs:tArray = tarray();
   var lsFiles_is:tArray = tarray();
   var lsFiles_wp:tArray = tarray();

   //var Obtemp = CTemplateXLS(NULL, NULL, NULL, NULL, NULL, NULL, true, true); //CTemplateSXLSX();
   var Obtemp = CTemplateSXLSX(NULL);
   Obtemp.SetXLSXFormat();
   Obtemp.CreateTotalBook();
   Obtemp.OpenTemplate("Report_LimitQuik.xlsx", false);//имя шаблона
   Obtemp.SheetChange(1);

   var obtable, obtable1, obtable2, obtable3, obtable4, obtable5, obtable6;
   if (ValType(IsAdd) == V_UNDEF)
     isAdd = IsReviseAdditional();
   end;
   if (ValType(IsShort) == V_UNDEF)
     IsShort = 0;
   end;


/******/
/*проверить наличие необработанных файлов QUIK */
   if (QuikFilesAutoExists()) 
      if (IsShedulerRunning())
         err = "Обнаружен необработанный вечерний файл QUIK";
         return 1;
      else
         if (not GetTrue(false, "В директории \""+GetQuikInAutoFolder()+"\" обнаружен необработанный вечерний файл QUIK!"
                               +" Влияние на сверку лимитов. Продолжить сверку?"))
            err = "Обнаружен необработанный вечерний файл QUIK";
            return 1;
         end;
      end;
   end;
/***********/


   var market_str = "";
   if (secur_checked and cur_checked) market_str = "фондовому и валютному рынкам";
   elif (secur_checked) market_str = "фондовому рынку";
   elif (cur_checked) market_str = "валютному рынку";
   end;


   // Находим расхождения
   InitProgress(10,"","Сверка данных по "+market_str);
   var cmdmoney, cmddepo, cmdfutur, rsmoney, rsdepo, rsfutur, first = true;

   var dt1 = TRsbDataSet(" select t_date from DDL_LIMITSECURITES_DBT where 1=1 " + getQueryWhere("", secur_checked, cur_checked) + " group by t_date ");//bpv может быть не одна запись, если были запуски по бирже и внебирже в разные даты
   if (dt1.movenext())
      if (isAdd)
         CalcLimDates(date(dt1.date));
         var dt2 = execSQLselect( "select T_SETTLEDATEFROM from DLIMIT_BSDATE_DBT where T_BASEDATE = :bsdt and T_LIMITKIND = -1 ", makeArray(SQLParam("bsdt", date(dt1.date))), true);
         if (dt2.moveNext())
           compareDate = SQL_ConvTypeDate(dt2.value("t_settledatefrom"));
         end;
      else
         compareDate = GetDateAfterWorkDays(date(dt1.date),-1,20); /*CHVA  509739*/
      end;
   else
      compareDate = {curdate};
   end;

   if (compareDate == null)
      compareDate = {curdate};
   end;

   // obcsvfile.FileOpen(string(UserNumber)+"ds.txt",true);// цсв таблица

   cmddepo = RSDCommand("begin " +
                        "  rshb_limit_util.CheckDataSecur_ds(p_micex_code_curmarket   => ?, " +
                        "                                    p_micex_code_stockmarket => ?, " +
                        "                                    p_secur_checked          => ?, " +
                        "                                    p_cur_checked            => ?, " +
                        "                                    p_is_advanced_check      => ?); " +
                        " end;");
   cmddepo.addParam( "", RSDBP_IN, MICEX_CODE_CURMARKET);
   cmddepo.addParam( "", RSDBP_IN, MICEX_CODE_STOCKMARKET);
   cmddepo.addParam( "", RSDBP_IN, secur_checked);
   cmddepo.addParam( "", RSDBP_IN, cur_checked);
   cmddepo.addParam( "", RSDBP_IN, IIF(isAdd, 1, 0));
   cmddepo.execute();
   

   var obcsvfile = store_file_csv("ds", lsFiles_ds);
   useprogress (1);

//  obcsvfile1.FileOpen(string(UserNumber)+"ss.txt",true);// цсв таблица

  if (IsShort == 0) 
     cmddepo = RSDCommand("begin rshb_limit_util.CheckDataSecur_ss(?,?,?,?,?); end;");
     cmddepo.addParam( "", RSDBP_IN, MICEX_CODE_CURMARKET);
     cmddepo.addParam( "", RSDBP_IN, MICEX_CODE_STOCKMARKET);
     cmddepo.addParam( "", RSDBP_IN, secur_checked);
     cmddepo.addParam( "", RSDBP_IN, cur_checked);
     cmddepo.addParam( "", RSDBP_IN, BIG_TABLE_ROW_LIMIT);
     cmddepo.execute();

     var obcsvfile1 = store_file_csv("ss", lsFiles_ss);
  end;
  
   useprogress (2);


  
 //  obcsvfile2.FileOpen(string(UserNumber)+"qs.txt",true);// цсв таблица

  if (IsShort == 0) 
     cmddepo = RSDCommand("begin rshb_limit_util.CheckDataSecur_qs(?,?,?,?,?); end;");
     cmddepo.addParam( "", RSDBP_IN, MICEX_CODE_CURMARKET);
     cmddepo.addParam( "", RSDBP_IN, MICEX_CODE_STOCKMARKET);
     cmddepo.addParam( "", RSDBP_IN, secur_checked);
     cmddepo.addParam( "", RSDBP_IN, cur_checked);
     cmddepo.addParam( "", RSDBP_IN, BIG_TABLE_ROW_LIMIT);
     cmddepo.execute();

     var obcsvfile2 = store_file_csv("qs", lsFiles_qs);
  end;

   useprogress (3);

   //находим совпадения
  // obcsvfile3.FileOpen(string(UserNumber)+"is.txt",true);// цсв таблица      
   cmddepo = RSDCommand("begin rshb_limit_util.CheckDataSecur_is(?,?,?,?); end;");
   cmddepo.addParam( "", RSDBP_IN, MICEX_CODE_CURMARKET);
   cmddepo.addParam( "", RSDBP_IN, MICEX_CODE_STOCKMARKET);
   cmddepo.addParam( "", RSDBP_IN, secur_checked);
   cmddepo.addParam( "", RSDBP_IN, cur_checked);
   //cmddepo.execute();
   execSQL("begin it_rsl_string.clear; end;"); // Очистка буфера 

   var obcsvfile3 = store_file_csv("is", lsFiles_is);
   useprogress (4);


 //  obcsvfile5.FileOpen(string(UserNumber)+"wp.txt",true);
   cmddepo = RSDCommand("begin rshb_limit_util.CheckDataSecur_wp(?,?,?,?); end;");
   cmddepo.addParam( "", RSDBP_IN, MICEX_CODE_CURMARKET);
   cmddepo.addParam( "", RSDBP_IN, MICEX_CODE_STOCKMARKET);
   cmddepo.addParam( "", RSDBP_IN, secur_checked);
   cmddepo.addParam( "", RSDBP_IN, cur_checked);
   cmddepo.execute();

   var obcsvfile5 = store_file_csv("wp", lsFiles_wp);
   useprogress (5);

   MEssage("");

   Obtemp.SetValue_NameCell("Date", compareDate);
//Obtemp.SetValue_NameCell("bodyline");
   Obtemp.CopyAllSheetInTotalBook (null, false, "header", 0, "Расшифровка расхождений");

   obtable  = Obtemp.RegisterTable("bodyline");
   obtable.FillTabelFromCSV(lsFiles_ds);
   obtable.EndTable();
   lsFiles_ds.Size = 0;

   Obtemp.CopyAllSheetInTotalBook(null,         //Имя закладки,по умолчанию имя закладки из шаблона
                                     false, // true - на новый лист, false - на существующий(если имя листа отличается, всегда на новый лист)
                                     obtable.GetTableRange(),     //Что копировать м.б. диапозон вида "A1:T60" или имя именованного диапозона
                                      0,
                                    "Расшифровка расхождений") ;


   Obtemp.SetDiapazon( CAddressDiapazon(obtable.GetTableRange()).GetColumn(10) );
   CallSetColor(Obtemp, RGB(0,0,255));

   useprogress (6);

   if (IsShort == 0) 

     Obtemp.CopyAllSheetInTotalBook (null, false, "header1", 0, "Расшифровка расхождений");
     obtable1 = Obtemp.RegisterTable("bodyline1");
     Obtemp.SetValue_NameCell("bodyline1");
     obtable1.FillTabelFromCSV(lsFiles_qs);/*да, именно сначала 2 (qs)*/
     obtable1.EndTable();
     lsFiles_qs.Size = 0;

     Obtemp.CopyAllSheetInTotalBook(null,         //Имя закладки,по умолчанию имя закладки из шаблона
                                   false, // true - на новый лист, false - на существующий(если имя листа отличается, всегда на новый лист)
                                   obtable1.GetTableRange(),     //Что копировать м.б. диапозон вида "A1:T60" или имя именованного диапозона
                                    0,
                                  "Расшифровка расхождений") ;

   end ;
  
   useprogress (7);

   if (IsShort == 0) 
       Obtemp.CopyAllSheetInTotalBook (null, false, "header2", 0, "Расшифровка расхождений");
       obtable2 = Obtemp.RegisterTable("bodyline2");
       Obtemp.SetValue_NameCell("bodyline2");
       obtable2.FillTabelFromCSV(lsFiles_ss);/*а потом 1 (ss).*/
       obtable2.EndTable();
       lsFiles_ss.Size = 0;
       
       Obtemp.CopyAllSheetInTotalBook(null,         //Имя закладки,по умолчанию имя закладки из шаблона
                                       false, // true - на новый лист, false - на существующий(если имя листа отличается, всегда на новый лист)
                                       obtable2.GetTableRange(),     //Что копировать м.б. диапозон вида "A1:T60" или имя именованного диапозона
                                        0,
                                      "Расшифровка расхождений") ;
   end ;
  
   useprogress (8);

   Obtemp.CopyAllSheetInTotalBook (null, false, "header3", 0, "Расшифровка расхождений");
   obtable3 = Obtemp.RegisterTable("bodyline3");
   Obtemp.SetValue_NameCell("bodyline3");
   obtable3.FillTabelFromCSV(lsFiles_is);
   obtable3.EndTable();
   lsFiles_is.Size = 0;


   Obtemp.CopyAllSheetInTotalBook(null,         //Имя закладки,по умолчанию имя закладки из шаблона
                                   false, // true - на новый лист, false - на существующий(если имя листа отличается, всегда на новый лист)
                                   obtable3.GetTableRange(),     //Что копировать м.б. диапозон вида "A1:T60" или имя именованного диапозона
                                    0,
                                  "Расшифровка расхождений") ;

   useprogress (9);

   Obtemp.CopyAllSheetInTotalBook (null, false, "header4", 0, "Расшифровка расхождений");
   //obtable4 = Obtemp.RegisterTable("bodyline4");
   obtable5 = Obtemp.RegisterTable("bodyline5");
   Obtemp.SetValue_NameCell("bodyline5");
   obtable5.FillTabelFromCSV(lsFiles_wp);
   obtable5.EndTable();
   lsFiles_wp.Size = 0;


   Obtemp.CopyAllSheetInTotalBook(null,         //Имя закладки,по умолчанию имя закладки из шаблона
                                   false, // true - на новый лист, false - на существующий(если имя листа отличается, всегда на новый лист)
                                   obtable5.GetTableRange(),     //Что копировать м.б. диапозон вида "A1:T60" или имя именованного диапозона
                                    0,
                                  "Расшифровка расхождений") ;

   useprogress (10);

   var dt = String({curdate});
   dt = StrSubst(dt, " ", "0");
   dt = StrSubst(dt, ".", "");
   var tm = String(time());
   tm = StrSubst(tm, " ", "0");
   tm = StrSubst(tm, ":", "");
   var nm = "";
   if ((secur_checked) and  (cur_checked))
      nm = nm + "QuikLimitsSecurCur";
   elif (secur_checked) 
      nm = nm + "QuikLimitsSecur";
   elif (cur_checked) 
      nm = nm + "QuikLimitsCur";
   end;
   nm = nm + IIF(isAdd, "Add", "") + "_" + dt + "_" + tm;
   if (ValType(ShowAppl) != V_UNDEF)
      //Obtemp.SaveAsTemplate(nm,ShowAppl);
      Obtemp.SaveTotalBook(nm, ShowAppl);
   else
      //Obtemp.SaveAsTemplate(nm,TRUE);
      Obtemp.SaveTotalBook(nm, TRUE);
   end;

   TermPath = Obtemp.ReportPath + "\\" + Obtemp.ReportFileName_xls;
   Obtemp.Close();

   RemProgress ;
OnError(e)
   TermPath = "";
   err = e.Message + " " + e.Module + " " + e.Line;
   if (not IsNoInterfaceRun())
     RunError(e);
   end;
end;
      
//Сверка данных по срочному рынку

macro CheckDataFutur(repDate, ShowAppl, TermPath:@string, err:@string)
   var lsFiles_df:tArray = tarray();
   var lsFiles_sf:tArray = tarray();
   var lsFiles_qf:tArray = tarray();
   var lsFiles_if:tArray = tarray();

   var Obtemp = CTemplateSXLSX(NULL);
   Obtemp.SetXLSXFormat();
   Obtemp.CreateTotalBook();
   Obtemp.OpenTemplate("Report_LimitQuik.xlsx", false);//имя шаблона
   Obtemp.SheetChange(1);

   var obtable, obtable1, obtable2, obtable3;

/******/
/*проверить наличие необработанных файлов QUIK */
   if (QuikFortsFilesAutoExists()) 
      if (IsShedulerRunning())
         err = "Обнаружен необработанный вечерний файл QUIK";
         return 1;
      else
         if (not GetTrue(false, "В директории \""+GetQuikInAutoFolder()+"\" обнаружен необработанный вечерний файл QUIK по срочному рынку."
                               +" Влияние на сверку лимитов. Продолжить сверку?"))
            err = "Обнаружен необработанный вечерний файл QUIK";
            return 1;
         end;
      end;
   end;
/***********/

   // Находим расхождения
   InitProgress(9,"","Сверка данных по срочному рынку");
   
   //obcsvfile.FileOpen(string(UserNumber)+"df.txt",true);// цсв таблица
 
    execSQL("begin rshb_limit_util.CheckDataFutur_df; end;");  
    useprogress (1);

    var obcsvfile = store_file_csv("df", lsFiles_df);
    useprogress (2);

    // obcsvfile1.FileOpen(string(UserNumber)+"sf.txt",true);// цсв таблица

    execSQL("begin rshb_limit_util.CheckDataFutur_sf; end;");  
    useprogress (3);

    var obcsvfile1 = store_file_csv("sf", lsFiles_sf);
    useprogress (4);

    // obcsvfile2.FileOpen(string(UserNumber)+"qf.txt",true);// цсв таблица

    execSQL("begin rshb_limit_util.CheckDataFutur_qf; end;");  
    useprogress (5);

    var obcsvfile2 = store_file_csv("qf", lsFiles_qf);
    useprogress (6);

     //находим совпадения
    execSQL("begin it_rsl_string.clear; end;"); // Очистка буфера
    useprogress (7);

    var obcsvfile3 = store_file_csv("if", lsFiles_if);
    useprogress (8);

    Obtemp.SetValue_NameCell("Date", GetDateAfterWorkDays(repDate, -1,20));/*CHVA  509739*/
    //Obtemp.SetValue_NameCell("bodyline");
    Obtemp.CopyAllSheetInTotalBook (null, false, "header", 0, "Расшифровка расхождений");
    obtable = Obtemp.RegisterTable("bodyline");
    obtable.FillTabelFromCSV(lsFiles_df,NULL,";");
    obtable.EndTable();
    lsFiles_df.Size = 0;

    Obtemp.CopyAllSheetInTotalBook(null,         //Имя закладки,по умолчанию имя закладки из шаблона
                                   false, // true - на новый лист, false - на существующий(если имя листа отличается, всегда на новый лист)
                                   obtable.GetTableRange(),     //Что копировать м.б. диапозон вида "A1:T60" или имя именованного диапозона
                                    0,
                                  "Расшифровка расхождений") ;


    Obtemp.SetDiapazon( CAddressDiapazon(obtable.GetTableRange()).GetColumn(10) );
    // Obtemp.SetFrColor(RGB(0,0,255));
    CallSetColor(Obtemp, RGB(0,0,255));

    Obtemp.CopyAllSheetInTotalBook (null, false, "header1", 0, "Расшифровка расхождений");
    obtable1 = Obtemp.RegisterTable("bodyline1");
    //Obtemp.SetValue_NameCell("bodyline1");
    obtable1.FillTabelFromCSV(lsFiles_qf,NULL,";");
    obtable1.EndTable();
    lsFiles_qf.size = 0;

    Obtemp.CopyAllSheetInTotalBook(null,         //Имя закладки,по умолчанию имя закладки из шаблона
                                   false, // true - на новый лист, false - на существующий(если имя листа отличается, всегда на новый лист)
                                   obtable1.GetTableRange(),     //Что копировать м.б. диапозон вида "A1:T60" или имя именованного диапозона
                                    0,
                                  "Расшифровка расхождений") ;

    Obtemp.CopyAllSheetInTotalBook (null, false, "header2", 0, "Расшифровка расхождений");
    obtable2 = Obtemp.RegisterTable("bodyline2");
    //Obtemp.SetValue_NameCell("bodyline2");
    obtable2.FillTabelFromCSV(lsFiles_sf,NULL,";");
    obtable2.EndTable();
    lsFiles_sf.size = 0;

    Obtemp.CopyAllSheetInTotalBook(null,         //Имя закладки,по умолчанию имя закладки из шаблона
                                   false, // true - на новый лист, false - на существующий(если имя листа отличается, всегда на новый лист)
                                   obtable2.GetTableRange(),     //Что копировать м.б. диапозон вида "A1:T60" или имя именованного диапозона
                                    0,
                                  "Расшифровка расхождений") ;

    Obtemp.CopyAllSheetInTotalBook (null, false, "header3", 0, "Расшифровка расхождений");
    obtable3 = Obtemp.RegisterTable("bodyline3");
    //Obtemp.SetValue_NameCell("bodyline3");
    obtable3.FillTabelFromCSV(lsFiles_if,NULL,";");
    obtable3.EndTable();
    lsFiles_if.size = 0;

    Obtemp.CopyAllSheetInTotalBook(null,         //Имя закладки,по умолчанию имя закладки из шаблона
                                   false, // true - на новый лист, false - на существующий(если имя листа отличается, всегда на новый лист)
                                   obtable3.GetTableRange(),     //Что копировать м.б. диапозон вида "A1:T60" или имя именованного диапозона
                                    0,
                                  "Расшифровка расхождений") ;

    var dt = String({curdate});
        dt = StrSubst(dt, " ", "0");
        dt = StrSubst(dt, ".", "");
        dt = "QuiklimitsFutur" + dt;
    if (ValType(ShowAppl) != V_UNDEF)
       //Obtemp.SaveAsTemplate(dt,ShowAppl);
       Obtemp.SaveTotalBook(dt, ShowAppl);
    else
       //Obtemp.SaveAsTemplate(dt,TRUE);
       Obtemp.SaveTotalBook(dt, TRUE);
    end;

    TermPath = Obtemp.ReportPath + "\\" + Obtemp.ReportFileName_xls;
    Obtemp.Close();
    RemProgress(8);      
     
   OnError(e)
   TermPath = "";  
   err = e.Message + " " + e.Module + " " + e.Line;
end;

private macro GetParm(s, parm, def)
   parm = StrUpr(parm);
   s = StrSubst(StrUpr(s)," ","");
   var pos = index(s,parm+"=");
   var retval = "";
   if ( pos > 0 )
      pos = pos + StrLen(parm) + 1; //смещаемся на длинну самого параметра и " = "
      retval =  SubStr(s,pos, index(s,";",pos) - pos);
   end;
   if ((ValType(def) != V_UNDEF) and (retval == ""))
      RetVal = def;
   end;
   return StrSubst(RetVal,",",".");
end;

Macro Exec_LoadData(loadproc, Trunc_t,mess:@string )
  BegAction(100,"Обработка данных на сервере");
  var cmd = RsdCommand(("begin ? := rshb_limit_util."+loadproc+"(it_rsl_string.get_clob,?,?); it_rsl_string.clear; end;"));
  cmd.addParam("res",RSDBP_OUT,V_NUMERIC);
  cmd.addParam("", RSDBP_IN, Trunc_t);
  cmd.addParam("mess",RSDBP_OUT,V_STRING,32768);

  cmd.execute() ;
  mess = cmd.value("mess");
  var res = cmd.value("res");
  EndAction;
  return res;
end;

Macro Exec_append_varchar(bstr)
  var cmd = RsdCommand(" begin  it_rsl_string.append_varchar(?);  end;");
  cmd.addParam("", RSDBP_IN, bstr);
  cmd.execute() ;
end;

Macro LoadDataBD(fname,fsize,loadproc, caption ,loadmsg:@string )
   var size_buf = 32676 ;
   var num_buf = 0;
   var exec_res = 0 ;
   var res = 0 ;
   var mess = "";
   loadmsg ="";
   var LineCount = 0 ;
   var v_fsize = 0 ;

   InitProgress((int(fsize/size_buf)+1),"","Загрузка блоков (по 32кБ) файла QUIK по "+caption);
   var v_bstr,v_lenbuf,v_tt, v_stream = TStreamDoc(fname,"R","rsansi");  
  // Очистка буфера
   var cmd = RsdCommand(" begin it_rsl_string.clear; end;");
   cmd.execute();
  // Наполняем буфер из файла    
   
   v_bstr="";
   v_lenbuf=0;
   v_tt = 1;
   while (v_stream.ReadLine())
     LineCount = LineCount+1 ;
     v_fsize = v_fsize + StrLen(v_stream.str)+2;
     if (StrLen(v_bstr + v_stream.str) > size_buf)
       Exec_append_varchar(v_bstr);
       v_lenbuf= v_lenbuf+StrLen(v_bstr);
       v_bstr="";
       if (v_lenbuf> 4000000000)
         exec_res = Exec_LoadData(loadproc,v_tt,@mess);
         loadmsg = loadmsg + mess;
         if (exec_res < 0 )
           res = exec_res ;
           exit;
         end;
         res = res+ exec_res;
         v_tt = 0;
         v_lenbuf = 0 
       end;
       UseProgress(num_buf = num_buf+1);
     end;
     v_bstr = v_bstr + v_Stream.str+StrFor(13)+StrFor(10);
   end;
   if (res >= 0)
     if (StrLen(v_bstr) > 0)
       v_bstr = SubStr(v_bstr,1,StrLen(v_bstr)-2);
       Exec_append_varchar(v_bstr);
     end;
     UseProgress((int(fsize/size_buf)+1));
     exec_res = Exec_LoadData(loadproc,v_tt,@mess);
     loadmsg = loadmsg + mess;
     if (exec_res < 0 )
       res = exec_res ;
     else  
       res = res+ exec_res;
     end;
   end;
   if (res >= 0)
     var sql = "begin ? := rshb_limit_util.LoadDataGetLineCount(it_file." ;
     if (loadproc == PROC_LD_SECUR)
        sql = sql + "C_FILE_CODE_QUIK_SECUR";
     elif (loadproc == PROC_LD_FUTUR)
        sql = sql + "C_FILE_CODE_QUIK_FUTUR";
     else
        res = -1;
         loadmsg = "ОШИБКА параметров макроса RSHB_Quik2.LoadDataBD";
     end;
     if (res >= 0)
       sql = sql + "); end;";
       cmd = RsdCommand(sql);
       cmd.addParam("rescount",RSDBP_OUT,V_NUMERIC);
       cmd.execute() ;
       var rescount = cmd.value("rescount");
       if (rescount != LineCount)
         res = -1;
         loadmsg = "ОШИБКА загрузки файла: считано строк "+string(LineCount)+" загружено "+string(rescount);
       elif (fsize > v_fsize )
         res = -1;
         loadmsg = "ОШИБКА загрузки файла: считано "+string(v_fsize)+"Б из "+string(fsize)+"Б";
       end;
     end;
   end;
   RemProgress();
   return res;
end;


macro chk_file(p_file, mess:@string)
  var v_n,v_filegltmp,v_listfiletmp;
  for (v_n, 1, 100)
    v_filegltmp = p_file+"_"+v_n ;
    v_listfiletmp = tdirlist (v_filegltmp,"f");
    if (v_listfiletmp.count == 0)
      break;
    end;
  end;
  if (v_n== 100)
    mess = "ошибка проверки файла "+p_file ; 
    return 1;    
  end; 
  if (not renamefile (p_file, v_filegltmp))
    mess = "файл "+p_file+ " занят другим процессом в системе !"; 
    return 1;    
  end; 
  if (not renamefile (v_filegltmp,p_file))
    mess = "ошибка переименования  "+v_filegltmp+" имя файла "+p_file+" изменено !";    
    return 1;    
  end; 
  v_listfiletmp = tdirlist (p_file,"f");
  if (v_listfiletmp.count == 0)
    mess = "ошибка переименования  "+v_filegltmp+" имя файла "+p_file+" изменено !";    
    return 1;    
  end;
  return 0;
end;

//Загрузка данных по фондовому рынку
Macro loadDataSecur(CalcDate, err:@string,folder_auto)
   var FIRM_ID = "";
   var TAG = "";
   var CURR_CODE = "";
   var CLIENT_CODE = "";
   var LIMIT_KIND = "";
   var OPEN_BALANCE = "";
   var OPEN_LIMIT = "";
   var LEVERAGE = "";
   var SECCODE = "";
   var TRDACCID = "";
   var WA_POSITION_PRICE = "";
   file Quik () txt;

   err = "";

   CalcDate = GetDateAfterWorkDays (CalcDate, -1, 20/*календарь биржи*/) + 1;

   Var folder;

  // InitProgress(-1,"","Загрузка файла QUIK по фондовому и валютному рынкам");
   if ((ValType(folder_auto) == V_UNDEF) or (folder_auto == ""))
      getregistryvalue("РСХБ\\ДИРЕКТОРИИ\\QUIK_IN", V_STRING, folder );
   else/*если что-то передали сюда, значит запуск из шедулера LoadFileQUIK.mac*/
      folder = folder_auto;
   end;

   var dd,mm,yyyy;
   //DateSplit(CalcDate, dd, mm, yyyy);
   yyyy = SubStr(StrSubst(string(CalcDate:f),".",""),5,4);
   mm   = SubStr(StrSubst(string(CalcDate:f),".",""),3,2);
   dd   = SubStr(StrSubst(string(CalcDate:f),".",""),1,2);

   var mask = "Limit_"+string(YYYY)+string(MM)+string(DD)+"*.lim";
   Var d1 = TDirList (mergeFile (folder , mask), "F"),
   line;

   if ( d1.count < 1 )
      err = "В папке "+folder+" не обнаружено файлов Quik по маске " + mask;
      msgbox (err);
      RemProgress(1);
      return 1;
   end;

   if ( not (open (Quik, mergeFile (folder, d1.name (0)))) )
      err = "Не удалось открыть файл данных";
      msgbox (err);
      RemProgress(1);
      return 1;
   end;   
   close(Quik);
   var mess;
   if (chk_file(mergeFile (folder, d1.name (0)),@mess) != 0)
      err = mess;
      msgbox (err);
      RemProgress(1);
      return 1;   
   end;
   var loadmsg ;
   var res = LoadDataBD(mergeFile (folder, d1.name (0)),d1.Size(0),PROC_LD_SECUR, "фондовому и валютному рынкам",@loadmsg ) ;
   err = loadmsg;
   if (res != 0 )
      msgbox (err);
   end;
   if ( res  < 0 )
      RemProgress(1);
      return 1;
   end;

 
   MakeDir(string(folder+"\\", "Arch"));
   copyfile( mergeFile (folder, d1.name (0)), folder  + "\\arch\\"+d1.name (0) );
   removefile(mergeFile (folder, d1.name (0)));

   return 0;
End;

//загрузка данных по срочному рынку

macro LoadDataFutur(CalcDate, err:@string, folder_auto)
   var CLASS_CODE = "";
   var FIRM_ID = "";
   var ACCOUNT = "";
   var VOLUMEMN = String(0.00); /*PNV i-support 502025*/
   var VOLUMEPL = String(0.00); /*PNV i-support 502025*/
   var KFL = String(0.0000);/*PNV i-support 502025*/
   var KGO = String(0.0000);
   var USE_KGO = "";
   Var folder;
   var sqlstr,sqlres;
   file Quik () txt;
   err = "";

   UseProgress(1);
   if ((ValType(folder_auto) == V_UNDEF) or (folder_auto == ""))
      getregistryvalue("РСХБ\\ДИРЕКТОРИИ\\QUIK_IN", V_STRING, folder );
   else/*если что-то передали сюда, значит запуск из шедулера LoadFileQUIK.mac*/
      folder = folder_auto;
   end;

   CalcDate = GetDateAfterWorkDays (CalcDate, -1, 20/*календарь биржи*/) + 1;
      
    var dd,mm,yyyy;
    //DateSplit(CalcDate, dd, mm, yyyy);
    yyyy = SubStr(StrSubst(string(CalcDate:f),".",""),5,4);
    mm   = SubStr(StrSubst(string(CalcDate:f),".",""),3,2);
    dd   = SubStr(StrSubst(string(CalcDate:f),".",""),1,2);

    var mask = "Forts_"+string(YYYY)+string(MM)+string(DD)+"*.lim";

    Var d1 = TDirList (mergeFile (folder, mask), "F"),
        line;

    if ( d1.count < 1 )
        err = "В папке "+folder+" не обнаружено файлов Quik по маске " + mask;
        msgbox (err);
        RemProgress(1);
        return 1;
    end;

    if ( not (open (Quik, mergeFile (folder, d1.name (0)))) )
        err = "Не удалось открыть файл данных";
        msgbox (err);
        RemProgress(1);
        return 1;
    end;
    close(Quik);

   var mess;
   if (chk_file(mergeFile (folder, d1.name (0)),@mess) != 0)
      err = mess;
      msgbox (err);
      RemProgress(1);
      return 1;   
   end;

   var loadmsg ;
   var res = LoadDataBD(mergeFile (folder, d1.name (0)),d1.Size(0),PROC_LD_FUTUR, "срочному рынку",@loadmsg ) ;
   err = loadmsg;
   if (res != 0 )
      msgbox (err);
   end;
   if ( res  < 0 )
      RemProgress(1);
      return 1;
   end;

   UseProgress(1);
   RemProgress(1);

   MakeDir(string(folder+"\\", "Arch"));
   copyfile( mergeFile (folder, d1.name (0)), folder  + "\\arch\\"+d1.name (0) );
   removefile(mergeFile (folder, d1.name (0)));


   return 0;
end;

class (TRsbPanel) PanelCompareQuik
initTRsbPanel();
Caption = "Сверка лимитов QUIK";
Status = "~ESC~Выход ~F2~Выполнить";
setSize(25,8);
setPosition(50,10);
var futur, secur;
secur = TRsbCheckbox;
secur.setPosition(4,2);
secur.name = "Фондовый рынок";
secur.checked = true;
 
addControl(secur);
var m_Label1:TrsbLabel = TRsbLabel(8,2,"Фондовый рынок");
addLabel (m_Label1);

futur = TRsbCheckbox;
futur.setPosition(4,4);
futur.name = "Срочный рынок";
 
addControl(futur);
var m_Label2:TrsbLabel = TRsbLabel(8,4,"Срочный рынок" );
addLabel (m_Label2);
addEventHandler(RSB_EV_KEY_PRESSED, R2M(this, "onKeyPressed"));

macro OnChecked(RsbEvent:Object)
   if (RsbEvent.id == RSB_EV_CONTROL_CHECKED)
   end;
return true;
end;

macro onKeyPressed(ev)
   if (ev.keycode == 316)
      if (secur.checked)
         LoadDataSecur(false);
      end;
      if (futur.checked)
         LoadDataFutur(true);
      end;
   else
      exit(1);
   end;
end;

end;

//var myPanel:TRsbPanel = PanelCompareQuik;
//myPanel.run;
//CheckDataSecur;                  
