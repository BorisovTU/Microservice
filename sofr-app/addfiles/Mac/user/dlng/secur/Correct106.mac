import DealsInter, spserv, sp_class, sp_car, spreserv;

  var query, cmd, DataSet, cmd1, FD, corrdate, ground = "";
  var err = 0;
  var i = 0, cnt = 0;

private record acnt_dk_negative(account);
private record acnt_dk_positive(account);

const USED_PLUSDK_DEBET          = 11; //По дебету используется счет + ПО ДК // отриц. разн. в добав. капитале
const USED_PLUSDK_CREDIT         = 12; //По кредиту используется счет + ПО ДК // отриц. разн. в добав. капитале
const USED_MINUSDK_DEBET         = 13; //По дебету используется счет - ПО ДК // полож. разн. в добав. капитале
const USED_MINUSDK_CREDIT        = 14; //По кредиту используется счет - ПО ДК // полож. разн. в добав. капитале

  Corrdate = {curdate};
  GetDate(Corrdate, "Введите дату корректировки ");

  query =   " select * from ( "
          + " select acc106.t_fiid, acc10603.t_account account10603, acc10605.t_account account10605, acc50220.t_account account50220, acc50221.t_account account50221,  "
          + " rsb_account.restac(acc10603.t_Account, acc10603.t_Currency, ?, acc10603.t_Chapter, null) Rest10603,  "
          + " rsb_account.restac(acc10605.t_Account, acc10605.t_Currency, ?, acc10605.t_Chapter, null) Rest10605,  "
          + " rsb_account.restac(acc50220.t_Account, acc50220.t_Currency, ?, acc50220.t_Chapter, null) Rest50220,  "
          + " rsb_account.restac(acc50221.t_Account, acc50221.t_Currency, ?, acc50221.t_Chapter, null) Rest50221  "
          + "   from dmcaccdoc_dbt acc106, dmcaccdoc_dbt acc10603, dmcaccdoc_dbt acc10605, dmcaccdoc_dbt acc50220, dmcaccdoc_dbt acc50221 where acc106.t_catnum in ('1251','1252') and acc106.t_iscommon = 'X' and rsb_account.restac(acc106.t_Account, acc106.t_Currency, ?, acc106.t_Chapter, null) != 0 "
          + " AND acc10603.t_catnum = '1251' and acc10603.t_iscommon = 'X' and acc10603.t_fiid = acc106.t_fiid   "
          + " AND acc10605.t_catnum = '1252' and acc10605.t_iscommon = 'X' and acc10605.t_fiid = acc106.t_fiid "
          + " AND acc50220.t_catnum = '1250' and acc50220.t_iscommon = 'X' and acc50220.t_fiid = acc106.t_fiid "
          + " AND acc50221.t_catnum = '1249' and acc50221.t_iscommon = 'X' and acc50221.t_fiid = acc106.t_fiid "
          + " ) where ( (abs(rest10605) <> abs(rest50220)) OR ( (abs(rest10603) <> abs(rest50221) ) ) )  ";

  cmd = DL_RSDCommand(query);        

     cmd.addParam(CorrDate);
     cmd.addParam(CorrDate);
     cmd.addParam(CorrDate);
     cmd.addParam(CorrDate);
     cmd.addParam(CorrDate);


    DataSet = cmd.Execute();

    while(DataSet.moveNext())
          FD = SPFirstDocFI(DLDOC_ISSUE, DataSet.FIID, DataSet.FIID, KINDPORT_SALE, {OurBank}, null, null, null);

       If(dataset.fiid == 314 )

          Ground = "Перенос остатка на верный счет по выпуску " + FD.fininstr.rec.definition;

          if(FD.IsExistAccount( "+ПО ДК 2014", null, true, null, acnt_dk_positive, MC_PAIRACCMODE_MANUAL, CorrDate ))
          end;

          if(FD.IsExistAccount( "-ПО ДК", null, true, null, acnt_dk_negative, MC_PAIRACCMODE_MANUAL, CorrDate ))
          end;

           if(not ПроводкаПоКатегориямУчета( FD, 
                                                acnt_dk_positive, 
                                                acnt_dk_negative,
                                                CorrDate,                     /* Дата */
                                                1,                           /* Глава */
                                                NATCUR,                      /* Валюта */
                                                ABS( Dataset.Rest10603 ),           /* Сумма  */
                                                NULL,                        /* Документ */
                                                INPCARRY,                    /* Result_Carry */
                                                " 1",                        /* Kind_Oper */
                                                "",                          /* Numb_Document */
                                                Ground/*"Списание положительной переоценки"*/,
                                                USED_PLUSDK_DEBET,
                                                null,
                                                GetFIRoleByPortfolio( KINDPORT_SALE )
                                              )
             )
               return false;
           end;

       else
          If(Dataset.Rest10603 > 0)

             if(FD.IsExistAccount( "-ПО ДК 2014", null, true, null, acnt_dk_negative, MC_PAIRACCMODE_MANUAL, CorrDate ))
             end;
             Ground = "Списание переоценки по выпуску " + FD.fininstr.rec.definition;

             if(not ПроводкаПоКатегориямУчета( FD, 
                                                  "-Маржа, ц/б", 
                                                  acnt_dk_negative,
                                                  CorrDate,                     /* Дата */
                                                  1,                           /* Глава */
                                                  NATCUR,                      /* Валюта */
                                                  ABS( Dataset.Rest50221 ) - ABS( Dataset.Rest10603 ),           /* Сумма  */
                                                  NULL,                        /* Документ */
                                                  INPCARRY,                    /* Result_Carry */
                                                  " 1",                        /* Kind_Oper */
                                                  "",                          /* Numb_Document */
                                                  Ground,
                                                  USED_MINUSDK_CREDIT,
                                                  GetFIRoleByPortfolio( KINDPORT_SALE )
                                                )

                )
                 return false;
             end;

          elif(Dataset.Rest10605 < 0)


             if(FD.IsExistAccount( "-ПО ДК 2014", null, true, null, acnt_dk_negative, MC_PAIRACCMODE_MANUAL, CorrDate ))
             end;
             Ground = "Списание переоценки по выпуску " + FD.fininstr.rec.definition;

             if(not ПроводкаПоКатегориямУчета( FD, 
                                                  "-Маржа, ц/б", 
                                                  acnt_dk_negative,
                                                  CorrDate,                     /* Дата */
                                                  1,                           /* Глава */
                                                  NATCUR,                      /* Валюта */
                                                  ABS( Dataset.Rest10605 ) - ABS( Dataset.Rest50220 ),           /* Сумма  */
                                                  NULL,                        /* Документ */
                                                  INPCARRY,                    /* Result_Carry */
                                                  " 1",                        /* Kind_Oper */
                                                  "",                          /* Numb_Document */
                                                  Ground,
                                                  USED_MINUSDK_CREDIT,
                                                  GetFIRoleByPortfolio( KINDPORT_SALE )
                                                )

                )
                 return false;
             end;

          end;
          

       end;
    end;
