import "secinter.mac", "mctplprm.mac", "sp_categ.mac", "spserv.mac", "mccatacc.mac", "spRepFun.mac";

Var CheckDate;

private macro PrintHead( RevDate:Date )
      println( "\n                       Протокол проверок исполнения сделок " );
      println( " Дата Проверки: ", RevDate );
end;

Private Macro ПроверитьНаличиеКомиссийБрокера(RevDate)


    var Select, DataSet, Query, count = 0;
PrintLn();
PrintLn("7. Проверки наличия комиссий Брокера по сделкам за дату :");
PrintLn();

Query = " select t.* from ddl_tick_dbt t where t.t_bofficekind = 101 and t.t_clientid != -1 and decode(t.t_CommDate, to_date('01.01.0001','DD.MM.YYYY'), t.t_DealDate, t.t_CommDate) = ? "
        " and not exists (select 1 from ddlcomis_dbt where t_dockind = t.t_bofficekind and t_docid = t.t_dealid and t_comnumber > 1000)";
    Select = DL_RSDCommand(Query);
    Select.AddParam(RevDate);
    DataSet = Select.Execute(Query);
    while(DataSet.MoveNext())
       PrintLn("Необходимо проверить рассчитанные комиссии брокера. По сделке: ", DataSet.Dealcode,  " нет комиссии за дату: ",  RevDate, "!!");
	count = count + 1;
    end;
    If(count == 0)
       PrintLn("Все комиссии расчитаны");
    end;
    return true;

End;



Private Macro ПроверитьПереносПоСРокамБОЦБ(RevDate)

    var Select, DataSet, Query, count = 0;
PrintLn();
PrintLn("6. Необходимость выполнения переноса по счетам срочности :");
PrintLn();

Query = " select gr.* from ddlgrdeal_dbt gr, ddlgracc_dbt  acc where gr.t_templnum = 4 and gr.t_plandate = ? and "
" acc.t_grdealid = gr.t_id and acc.t_state = 1 ";
    Select = DL_RSDCommand(Query);
    Select.AddParam(RevDate);
    DataSet = Select.Execute(Query);
    If(DataSet.MoveNext())
       PrintLn("!Необходимо завести и исполнить Серв. операцию 'Перенос по счетам срочности в БОЦБ' за дату ",  RevDate);
       count = count + 1;
    end;
    If(count == 0)
       PrintLn("Перенос по срокам не нужен");
    end;
    return true;

End;

Private Macro ПроверитьОтложенныеСделкиБОЦБ(RevDate)

    var Select, DataSet, Query, count = 0;
PrintLn();
PrintLn("1. Наличие отложенных сделок БОЦБ :");
PrintLn();
    Query = "select * from ddl_tick_dbt where t_dealstatus = 0 and t_bofficekind = 101 and t_dealdate <= ?";
    Select = DL_RSDCommand(Query);
    Select.AddParam(RevDate);
    DataSet = Select.Execute(Query);
    while(DataSet.MoveNext())
       PrintLn("Внутренний код сделки: ", DataSet.Dealcode, " дата заключения: ", SQL_ConvTypeDate(DataSet.DealDate));
       count = count + 1;
    end;
    If(count == 0)
       PrintLn("Отложенных сделок БОЦБ не найдено");
    end;
    return true;
End; 

Private Macro ПроверитьОтложенныеДвиженияКСУ(RevDate)

    var Select, DataSet, Query, count = 0;
PrintLn();
PrintLn("2. Наличие отложенных списаний/зачислений КСУ :");
PrintLn();
    Query = "SELECT  tick.\* " +
            "  FROM ddl_tick_dbt tick " +
            " WHERE  tick.t_dealstatus = 0 " +
            "       AND tick.t_bofficekind = 127 " +
            "       AND t_dealdate <= :d1 " +
            "       AND RSB_FIINSTR.FI_IsKSU(tick.t_pfi) = 1 " ;
    Select = DL_RSDCommand(Query);
    Select.AddParam(RevDate);
    DataSet = Select.Execute(Query);
    while(DataSet.MoveNext())
       [Внутренний код операции: ########## дата операции: ##########](DataSet.Dealcode,SQL_ConvTypeDate(DataSet.DealDate));
       count = count + 1;
    end;
    If(count == 0)
       PrintLn("Отложенных списаний/зачислений КСУ не найдено");
    end;
    return true;
End; 

Private Macro ПроверитьОтложенныеСделкиФИСС(RevDate)

    var Select, DataSet, Query, count = 0;
PrintLn();
PrintLn("3. Наличие отложенных сделок ФИСС :");
PrintLn();
    Query = "select dv.*, fin.t_fi_kind, nfi.* from ddvnfi_dbt nfi, dfininstr_dbt fin, ddvndeal_dbt dv  where nfi.t_dealid = dv.t_id and dv.t_kind in (2690, 12690) and dv.t_state = 0 "+
    " and fin.t_fiid = nfi.t_fiid and fin.t_fi_kind = 2 and dv.t_date <= ?";
    Select = DL_RSDCommand(Query);
    Select.AddParam(RevDate);
    DataSet = Select.Execute(Query);
    while(DataSet.MoveNext())
       PrintLn("Внутренний код сделки: ", DataSet.code, " дата заключения: ", SQL_ConvTypeDate(DataSet.Date));
       count = count + 1;
    end;
    If(count == 0)
       PrintLn("Отложенных сделок ФИСС не найдено");
    end;
    return true;
End; 


Private Macro ПоверитьНаличиеСделокСОтложеннымИсполнениемБОЦБ(RevDate)
    var Select, DataSet, Query, count = 0;
PrintLn();
PrintLn("8. Наличие сделок, по которым отложена поставка|оплата  :");
PrintLn();
    Query = " select tick.* from ddl_tick_dbt tick, doproper_dbt oper  where tick.t_dealstatus != 0 and tick.t_bofficekind = 101 "+
            " AND oper.t_dockind = tick.t_bofficekind and oper.t_documentid = LPAD(tick.t_dealid, 34, '0' ) "+
            " and exists(select 1 from doprstep_dbt step where step.t_id_operation = oper.t_id_operation and step.t_plan_date = to_date('31.12.9999','dd.mm.yyyy') and step.t_isexecute = 'R')";

    Select = DL_RSDCommand(Query);
    Select.AddParam(RevDate);
    DataSet = Select.Execute(Query);
    While(DataSet.MoveNext())
       PrintLn("Внутренний код сделки: ", DataSet.Dealcode, " дата заключения: ", SQL_ConvTypeDate(DataSet.DealDate));
       count = count + 1;
    end;
    If(count == 0)
       PrintLn("Сделок с отложенным исполнением в БОЦБ не найдено");
    end;
    return true;


End;

Private Macro ПоверитьИсполнениеШаговБОЦБ(RevDate)

    var Select, DataSet, Query, count = 0;
PrintLn();
PrintLn("4. Наличие не исполненных шагов по сделкам БОЦБ :");
PrintLn();
    Query = " select tick.* from ddl_tick_dbt tick, doproper_dbt oper  where tick.t_dealstatus != 0 and tick.t_bofficekind = 101 "+
            " AND oper.t_dockind = tick.t_bofficekind and oper.t_documentid = LPAD(tick.t_dealid, 34, '0' ) "+
            " and exists(select 1 from doprstep_dbt step where step.t_id_operation = oper.t_id_operation and step.t_plan_date <= ? and step.t_isexecute = 'R')";

    Select = DL_RSDCommand(Query);
    Select.AddParam(RevDate);
    DataSet = Select.Execute(Query);
    While(DataSet.MoveNext())
       PrintLn("Внутренний код сделки: ", DataSet.Dealcode, " дата заключения: ", SQL_ConvTypeDate(DataSet.DealDate));
       count = count + 1;
    end;
    If(count == 0)
       PrintLn("Не исполненных шагов сделок БОЦБ не найдено");
    end;
    return true;
End; 

Private Macro ПоверитьИсполнениеШаговФИСС(RevDate)

    var Select, DataSet, Query, count = 0;
PrintLn();
PrintLn("5. Наличие не исполненных шагов по сделкам ФИСС :");
PrintLn();
    Query = " select dv.*, fin.t_fi_kind, nfi.* from ddvnfi_dbt nfi, dfininstr_dbt fin, ddvndeal_dbt dv, doproper_dbt oper  where nfi.t_dealid = dv.t_id and dv.t_kind in( 2690, 12690) and dv.t_state != 0 "+
            " and fin.t_fiid = nfi.t_fiid and fin.t_fi_kind = 2 "+
            " AND oper.t_dockind = dv.t_dockind and oper.t_documentid = LPAD(dv.t_id, 34, '0' )" + 
            " and exists(select 1 from doprstep_dbt step where step.t_id_operation = oper.t_id_operation and step.t_plan_date <= ? and step.t_isexecute = 'R') ";

    Select = DL_RSDCommand(Query);
    Select.AddParam(RevDate);
    DataSet = Select.Execute(Query);
    While(DataSet.MoveNext())
       PrintLn("Внутренний код сделки: ", DataSet.code, " дата заключения: ", SQL_ConvTypeDate(DataSet.Date));
       count = count + 1;
    end;
    If(count == 0)
       PrintLn("Не исполненных шагов сделок ФИСС не найдено");
    end;
    return true;
End; 

Private Macro ПроверитьСделкиПФИвДатуЗаключения(RevDate)                                                                   
                                                                                                                       
    var Select, DataSet, Query, count = 0;                                                                             
PrintLn();                                                                                                             
PrintLn("9. Наличие сделок ПФИ в дату заключения:");                                                                        
PrintLn();                                                                                                             
    Query = "SELECT  tick.* FROM ddl_tick_dbt tick WHERE  tick.t_ispfi = chr(88) AND tick.t_bofficekind = 101 AND t_dealdate = ? ";
               
    Select = DL_RSDCommand(Query);                                                                                     
    Select.AddParam(RevDate);                                                                                          
    DataSet = Select.Execute(Query);                                                                                   
    while(DataSet.MoveNext())                                                                                          
       PrintLn("Внутренний код сделки: ", DataSet.Dealcode, " дата заключения: ", SQL_ConvTypeDate(DataSet.DealDate)); 
       count = count + 1;                                                                                              
    end;                                                                                                               
    If(count == 0)                                                                                                     
       PrintLn("Заключенных сделок ПФИ  не найдено.");                                                                   
    end;                                                                                                               
    return true;                                                                                                       
End;                                                                                                                   

Private Macro ПроверитьСделкиПФИвДатуИсполнения(RevDate)                                                                                 
                                                                                                                                         
    var Select, DataSet, Query, count = 0;                                                                                               
PrintLn();                                                                                                                               
PrintLn("10. Наличие сделок ПФИ в дату исполнения:");                                                                                
PrintLn();                                                                                                                                     
       Query = " select tick.* from ddl_tick_dbt tick, doproper_dbt oper  where tick.t_dealstatus != 0 and tick.t_bofficekind = 101 "+
            " AND oper.t_dockind = tick.t_bofficekind and oper.t_documentid = LPAD(tick.t_dealid, 34, '0' ) and tick.t_ispfi = chr(88) "+
            " and exists(select 1 from doprstep_dbt step where step.t_id_operation = oper.t_id_operation and step.t_plan_date = ?)";                                                                                                                                  
    Select = DL_RSDCommand(Query);                                                                                                       
    Select.AddParam(RevDate);                                                                                                            
    DataSet = Select.Execute(Query);                                                                                                     
    while(DataSet.MoveNext())                                                                                                            
       PrintLn("Внутренний код сделки: ", DataSet.Dealcode, " дата исполнения ", RevDate );                   
       count = count + 1;                                                                                                                
    end;                                                                                                                                 
    If(count == 0)                                                                                                                       
       PrintLn("Исполненых сделок ПФИ не найдено.");                                                                               
    end;                                                                                                                                 
    return true;                                                                                                                         
End;                                                                                                                                     

Private Macro ПроверитьСделкиПФИвПоследнийДеньМесяца(RevDate)                                                                                 
                                                                                                                         
    var Select, DataSet, Query, count = 0;                                                                             
PrintLn();                                                                                                             
PrintLn("11. Наличие переходных сделок ПФИ  на конец месяца:");                                                                        
PrintLn();                                                                                                             
       Query =  " select  leg.t_maturity, ar.* from ( SELECT  tick.*, (select RSI_RSBCalendar.GetDateAfterWorkDay( last_day (? +1), -1,0) from dual ) a     "+
		" FROM ddl_tick_dbt tick )  ar, ddl_leg_dbt leg  where  ar.t_ispfi = chr(88) AND ar.t_bofficekind = 101 AND ar.t_dealstatus = 10  "+
		"  AND ar.t_dealdate < ? and   ar.a = ? and leg.t_dealid = ar.t_dealid and LEG.T_MATURITY > ar.a  ";       
            
    Select = DL_RSDCommand(Query);                                                                                     
    Select.AddParam(RevDate);
    Select.AddParam(RevDate);     
    Select.AddParam(RevDate);                                                                                     
    DataSet = Select.Execute(Query);                                                                                   
    while(DataSet.MoveNext())                                                                                          
       PrintLn("Внутренний код сделки: ", DataSet.Dealcode, " дата исполнения: ", SQL_ConvTypeDate(DataSet.t_Maturity)); 
       count = count + 1;                                                                                              
    end;                                                                                                               
    If(count == 0)                                                                                                     
       PrintLn("Переходных сделок ПФИ не найдено.");                                                                   
    end;                                                                                                               
    return true;                                                                                                       
End;                                                                                                                   



macro ReportRun( RevDate)

      ПроверитьОтложенныеСделкиБОЦБ( RevDate );

      ПроверитьОтложенныеДвиженияКСУ( RevDate );

      ПроверитьОтложенныеСделкиФИСС( RevDate );

      ПоверитьИсполнениеШаговБОЦБ(RevDate);

      ПоверитьИсполнениеШаговФИСС(RevDate);

      ПроверитьПереносПоСРокамБОЦБ(RevDate);

      ПроверитьНаличиеКомиссийБрокера(RevDate);

      ПоверитьНаличиеСделокСОтложеннымИсполнениемБОЦБ(RevDate);

      ПроверитьСделкиПФИвДатуЗаключения(RevDate);

      ПроверитьСделкиПФИвДатуИсполнения(RevDate);

      ПроверитьСделкиПФИвПоследнийДеньМесяца(RevDate);
      
end;

If(GetDate(CheckDate, "Введите дату проверок исполнения сделок ")) 
   PrintHead(CheckDate);
   ReportRun(CheckDate);
else
   exit(1);
end;
