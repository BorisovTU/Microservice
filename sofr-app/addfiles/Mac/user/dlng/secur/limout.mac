/**
@file 		limout.mac
@brief 		Выгрузка лимитов
$Module:      	Ценные бумаги
*/

import globals, oralib, likepy, cb_sql, DealsInter, CTInter, RsbFormsInter;
import rsexts;
import "u_common_email_utils.mac",it_utils;

//private const REG_EXPORT_PATH = "РСХБ\\ИНТЕГРАЦИЯ\\ДИРЕКТОРИИ\\EXPORT\\QUIK_ЛИМИТЫ"; //путь для выгрузки файла
private const REG_EXPORT_PATH = "РСХБ\\ДИРЕКТОРИИ\\QUIK_OUT"; //путь для выгрузки файла
private const REG_EXPORTCOR_PATH = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ДИРЕКТОРИЯ КОРРЕКТИРОВОК QUIK"; //путь для выгрузки файла
private const REG_EXPORTCOR_LIMIT = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ЛИМИТ КОРРЕКТИРОВОК QUIK"; //
private const REG_EXPORTCOR_CUR = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ВАЛЮТЫ К ВЫГРУЗКЕ КОРРЕКТ. QUIK"; //
private const REG_LEV_DEF = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\QUIK\\LEVERAGE_DEFAULT";
private const REG_LEV_DEF_ENTITY = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\QUIK\\LEVERAGE_DEFAULT_ENTITY";

/*-1 - списания, 0 - все, 1 - зачисления*/
private const MODE_WRITE_OFF = -1;
private const MODE_CREDITING = 1;
private const MODE_BOTH = 0;

private var _SpbexID ;

private var RegVal_Default_Leverage, RegVal_Default_Leverage_Entity;
private var errCode;

GetRegistryValue(REG_LEV_DEF, V_STRING, RegVal_Default_Leverage, ErrCode);
if( ErrCode > 0 )
  RegVal_Default_Leverage = -1;
end;

if (StrIsNumber(RegVal_Default_Leverage))
  RegVal_Default_Leverage = int(RegVal_Default_Leverage);
end;

/*BOSS-4379 Доступ к сложным ФИ для ЮЛ неквалифицированных инвесторов */
GetRegistryValue(REG_LEV_DEF_ENTITY, V_STRING, RegVal_Default_Leverage_Entity, ErrCode);
if( ErrCode > 0 )
  RegVal_Default_Leverage_Entity = -1;
end;

if (StrIsNumber(RegVal_Default_Leverage_Entity))
  RegVal_Default_Leverage_Entity = int(RegVal_Default_Leverage_Entity);
else 
  RegVal_Default_Leverage_Entity = -1;
end;

private macro iif (c,a,b)
   if (c) return a else return b end;
end;

private class c_sfcontr(ContrID)
   var _sfcontr = TRecHandler("sfcontr");
   var _party = TBFile("party");
   var _Edp,_MarketId ;

   macro isBlocked(LimitDate)
      var Dt = TRsbDataSet
      ( " SELECT (CASE WHEN RSB_SECUR.GetGeneralMainObjAttr (207,LPAD (t_DlContrID, 34, '0'),1,"+GetSQLDate(LimitDate)+") = 1 THEN 'X' " + 
        "            ELSE CHR (0) END) IsBlocked                                                                         " +
        "   FROM ddlcontrmp_dbt WHERE t_sfcontrid = " + _sfcontr.rec.id);
      if (Dt.movenext())
         return Dt.IsBlocked;
      end;
      return StrFor(0);
   end;

   macro isExchange()
      if (_sfcontr.rec.servkindsub == 8)
         return true;
      else
         return false;
      end;
   end;

   macro isStock()
      if (_sfcontr.rec.servkind == 1)
         return true;
      else
         return false;
      end;
   end;

   macro isFuture()
      if (_sfcontr.rec.servkind == 15)
         return true;
      else
         return false;
      end;
   end;

   macro isCurMarket()
      if (_sfcontr.rec.servkind == 21)
         return true;
      else
         return false;
      end;
   end;

   macro isEdp()
      if (ValType(_Edp) == V_UNDEF)
        _Edp = false ;
        var Dt = TRsbDataSet("SELECT rshb_rsi_sclimit.SfcontrIsEDP("+_sfcontr.rec.id+") as t_isedp FROM dual");
        if (Dt.movenext())
           _Edp = ( Dt.IsEDP == 1);
        end;
      end;
      return _Edp ;
   end;

   macro isAccY()
      var note = ReadNoteForObject(659, UniID(_sfcontr,659), 5 /*Счет клиента на ММВБ Фондовый сектор*/);
      if (note != "")
         if (index(note,"Y") == 1)
            return true;
         end;
      end;
      return false
   end;

   macro GetTagFromNote(OperDate)
      var note = ReadNoteForObject(659, UniID(_sfcontr,659), 105, OperDate);
      if ((ValType(note) == V_STRING) and (note != ""))
        return Trim(note);
      end;
      return "";
   end;

   macro GetTestResult()
      var note = ReadNoteForObject(3, UniID(_party,3), 108);
      if ((ValType(note) != V_INTEGER) or ((ValType(note) == V_INTEGER) and (note == 0)))
        note = -1;
      end;
      return note;
   end;

   macro GetMarketId()
      if (ValType(_MarketId) == V_UNDEF)
        _MarketId = 0  ;
       var Dt = TRsbDataSet(" select t_marketid from ddlcontrmp_dbt where t_sfcontrid = " +_sfcontr.rec.id);
       if (Dt.movenext())
          _MarketId = dt.marketid;
       end;
      end;
     return _MarketId;
   end;

   macro IsQI()
     var Dt = TRsbDataSet(" select t_state from dscqinv_dbt where t_partyid = " +_sfcontr.rec.partyid);
     if (Dt.movenext())
        return SQL_ConvTypeInteger(dt.state) == 1;
     end;
     return false;
   end;

   macro rec()
      return _sfcontr.rec;
   end;

   /*
   if (_sfcontr.rec.id != 0)
      return _sfcontr.rec;
   end;*/
   var Dt = TRsbDataSet(" select * from dsfcontr_dbt where t_id = " + ContrID);
   if (Dt.movenext())
     Dt.GetRecord.CopyTo(_sfcontr.rec);
     //return _sfcontr.rec;
   end;
   if (_sfcontr.rec.partyid > 0)
     _party.rec.partyid = _sfcontr.rec.partyid ;
     _party.GetEQ();
   end;
end;

private macro GetSpbexID()
 if (ValType(_SpbexID) == V_UNDEF)
   _SpbexID = 0  ;
   var Dt = TRsbDataSet("SELECT rshb_rsi_sclimit.GetSpbexID() as t_spbid FROM dual");
   if (Dt.movenext())
      _SpbexID = SQL_ConvTypeInteger(dt.spbid);
   end;
 end;
 return _SpbexID;
end;

// DEF-68258, возвращает валюту для нулевых лимитов, по соглашению -1
macro GetCurrencyByZeroLimit()
   return -1;
end;

// DEF-68258, возвращает код для нулевых лимитов из ddl_limitprm_dbt
macro GetCodeSCZeroLimit(p_MarketKind, p_MarketID, p_ImplKind)
    var sql, cmd, p_Code;
   
    sql =  "DECLARE "
         + "BEGIN "
         + "   :p_Code := RSHB_RSI_SCLIMIT.GetCodeSCZeroLimit(:p_MarketKind, :p_MarketID, :p_ImplKind); "
         + "END; "
    ;
      
    cmd = RSDCommand(sql);
    cmd.addParam("p_Code", RSDBP_OUT, V_STRING);
    cmd.addParam("p_MarketKind", RSDBP_IN, p_MarketKind);
    cmd.addParam("p_MarketID", RSDBP_IN, p_MarketID);
    cmd.addParam("p_ImplKind", RSDBP_IN, p_ImplKind);
    cmd.execute();

    p_Code = cmd.value("p_Code");
    return p_Code;
end;

private macro GetMicexCode(ContrID)
   var Dt = TRsbDataSet(" select t_mpcode from ddlcontrmp_dbt where t_sfcontrid = " + ContrID);
   if (Dt.movenext())
      return dt.mpcode;
   end;
   return "";
end;

/*DEF-32047*/
private macro GetMicexCode_FB(ContrID)
   var Dt = TRsbDataSet(
      " SELECT T_CODE "
     +"   FROM DDLOBJCODE_DBT dlcode "
     +"  WHERE     dlcode.T_CODEKIND = " + DLCCK_USC
     +"        AND dlcode.T_OBJECTTYPE = " + OBJTYPE_BROKERCONTR_DL
     +"        AND dlcode.T_OBJECTID = (SELECT T_DLCONTRID "
     +"                                   FROM ddlcontrmp_dbt mp "
     +"                                  WHERE mp.T_SFCONTRID = " + ContrID +  ") "
     +"        AND (   dlcode.t_bankclosedate IS NULL "
     +"             OR dlcode.T_BANKCLOSEDATE = TO_DATE ('01.01.0001', 'DD.MM.YYYY')) "
   ); /*DEF-34787*/
   if (Dt.movenext())
      return dt.code;
   end;
   return "";
end;
/*DEF-32047*/

macro NeedCorrLimit( contract )
    var sfcontr = c_sfcontr(contract);

    if (sfcontr.isExchange()        /*только биржевые*/
        and (not sfcontr.isFuture()) /*по срочному не выгружаем*/
        and (not sfcontr.isAccY())  /*по договорам в спецдепо не выводим*/
       )
       return true;
    end;

    return false;

end;

private macro markOperationAsUnloaded(type,limit_type,docKind, docID)
  var noteKind:integer = 101;
  var objectType:integer = 0;
  var CatErr:integer = 0;
  var needObjAttr:bool = false;

  if (docKind == 4607)
    if ((type >= 0) and (limit_type == "DEPO"))
      noteKind = 106 ;
    end;
    objectType = 131;
    needObjAttr = true;
  elif (dockind == 4608)
    objectType = 133;
    needObjAttr = true;
  elif (dockind == 159)
    objectType = 159;
    needObjAttr = false;
  end;

  if (objectType != 0)
    AddNoteForObject(objectType, docID, noteKind, "Выгружено в файл");
    if( needObjAttr and (
                         (not DisconnectObjAttr( objectType, docID, 101 )) OR
                         (not ConnectObjAttr( CatErr, objectType, docID, 101, 1 )) OR
                         (CatErr != 0)
                        )
      )
      msgbox("Ошибка при установке категории " );
    end;
  end;

end;

/*>>bpv панель вызова выбор даты с галкой*/
private const FT_DATE = 9;

class (TRsbPanel) ChoiceDatePanel(mode:integer)

    InitTRsbPanel();

    Status = "F3 - выбор даты F2,F9 - выполнить";
    if (mode == 0 )
      Caption = "Формирование сводного поручения";
    elif (mode > 0 )
      Caption = "Коррект-ки лимитов по зачислениям";
    else
      Caption = "Коррект-ки лимитов по списаниям" ;
    end;
    
    setSize(32,8);
    setPosition(35,15);
    var Formmode = mode ;
    var DateBeg = {curdate};
    var OnlyNewRec  = false;
    var OnlyHoldNDFL = false;
    var OnlyMONEY  = false;
    var OnlyDEPO  = false;

    var stat = 0;

    
    addLabel(TRsbLabel(3, 2, "Дата"));
    var m_DateBeg:TRsbEditField = TRsbEditField(FT_DATE);
    m_DateBeg.setPosition(10,2);
    m_DateBeg.setSize(10,1);
    m_DateBeg.value = DateBeg;
    m_DateBeg.enabled = true;
    m_DateBeg.Name = "DateBeg";
    addControl(m_DateBeg);

    var m_NewRec = TRsbCheckbox;
    m_NewRec.setPosition(3,4);
    m_NewRec.name = "newrec";
    m_NewRec.checked = "X";
    addControl(m_NewRec);
    addLabel(TRsbLabel(5, 4, "Выгружать только новые "));

    var m_OnlyMONEY = TRsbCheckbox;
    m_OnlyMONEY.setPosition(3,5);
    m_OnlyMONEY.name = "moneyrec";
    m_OnlyMONEY.checked = "X";
    m_OnlyMONEY.enabled = (mode == MODE_CREDITING);
    if (mode == MODE_CREDITING)
      addControl(m_OnlyMONEY);
      addLabel(TRsbLabel(5, 5,  "Выгружать корректировки MONEY"));
    end;


    var m_OnlyDEPO = TRsbCheckbox;
    m_OnlyDEPO.setPosition(3,6);
    m_OnlyDEPO.name = "deporec";
    m_OnlyDEPO.checked = "X";
    m_OnlyDEPO.enabled = (mode == MODE_CREDITING);
    if (mode == MODE_CREDITING)
      addControl(m_OnlyDEPO);
      addLabel(TRsbLabel(5, 6,  "Выгружать нулевые DEPO"));
    end;
   
    var m_OnlyHoldNDFL = TRsbCheckbox;
    m_OnlyHoldNDFL.setPosition(3,6);
    m_OnlyHoldNDFL.name = "newrec";
    m_OnlyHoldNDFL.checked = "";
    m_OnlyHoldNDFL.enabled = (mode != MODE_CREDITING);
    if (mode != MODE_CREDITING)
      addControl(m_OnlyHoldNDFL);
      addLabel(TRsbLabel(5, 6, "Выгружать только по удержанию НДФЛ "));
    end;

    m_DateBeg.addEventHandler(RSB_EV_KEY_PRESSED , R2M(this, "DATE_KEY_PRESSED"));
    addEventHandler(RSB_EV_KEY_PRESSED , R2M(this, "Panel_ButtonEvent"));


    macro Panel_ButtonEvent(RsbEvent)
       if((RsbEvent.keyCode == 316) or (RsbEvent.keyCode == 323))/*F2 F9*/
           stat = 0;
           DateBeg = m_DateBeg.Value;
           OnlyNewRec = m_NewRec.checked;
           OnlyHoldNDFL = m_OnlyHoldNDFL.checked;
           OnlyMONEY  = m_OnlyMONEY.checked;
           OnlyDEPO  = m_OnlyDEPO.checked;
           if ((Formmode > 0) and (not OnlyMONEY) and (not OnlyDEPO))
              msgbox("Не выбран вид лимитов для выгрузки ");
              return ;
           end  ;
           this.close(1);
       elif(RsbEvent.keyCode == 27) /**/
           stat = 1;
       end;
    end;

    macro DATE_KEY_PRESSED(RsbEvent)
       if(RsbEvent.keyCode == 317)
           RsbEvent.Source.value = GetDateByCalendar(RsbEvent.Source.value);
       end;
    end;
end;


private macro StateOperByTrn(Id_Oper, dat, OnlyNewRec)
   var stat = 0;
   var sql, dt;
   if ((dat < date()) and OnlyNewRec) /*только архивные выгрузки*/
      sql = 
         " SELECT MAX (t_systemdate) trnsysdate                                  "+
         "  FROM dacctrn_dbt                                                     "+
         " WHERE     t_acctrnid IN                                               "+
         "               (SELECT t_acctrnid                                      "+
         "                  FROM doprdocs_dbt                                    "+
         "                 WHERE t_acctrnid IS NOT NULL AND t_id_operation = :1) "+
         "       AND t_chapter = 1                                               ";

      var cmd = RsdCommand(sql);
      cmd.addParam("", RSDBP_IN, Id_Oper);
      cmd.Execute();

      Dt = TRsbDataSet(cmd);
      if (Dt.movenext())
         if (SQL_ConvTypeDate(dt.trnsysdate) <= date()) /*PNV 536400*/
            stat = 1;/*архивная операция скорее всего есть в утренних лимитах*/
         end;
      else
         stat = 2;/*По операции нет проводок*/
      end;
   end;
  return stat;
end;

private macro LimitCorOutGetSettings(filePath:@string, limitRub:@money, unloadCur:@string)
   var ErrCode;

   GetRegistryValue(REG_EXPORTCOR_PATH, V_STRING, filePath, ErrCode);
    if( ErrCode > 0 )
     filePath = "..\\QUIK_EXCHNG\\out";
    end;

   GetRegistryValue(REG_EXPORTCOR_LIMIT, V_DOUBLE, limitRub, ErrCode);
   if( ErrCode > 0 )
      msgbox("Не установлен лимит для выгрузки RUB. Будут выгружены все корректировки");
      limitRub = $9999999999999999999999.0;
   end;

   GetRegistryValue(REG_EXPORTCOR_CUR, V_DOUBLE, unloadCur, ErrCode);
   if( ErrCode > 0 )
      unloadCur = "SUR";
   end;
end;

private macro LimitCorOutBuildQuery(type,
                                    OnlyNewRec,
                                    OnlyROVU48,
                                    OnlyHoldNDFL,
                                    OnlyMONEY,
                                    OnlyDEPO  
                                   ):string
   var sql:string = "",where_lt="ALL";

   sql = "select t.*,                  " +
         "       op.t_documentid,      " +
         "       op.t_dockind          " +
         "  from ddl_limitadjust_dbt t " +
         "  join doproper_dbt op on op.t_id_operation = t.t_id_oper     " +
         " where t_market = 1  " +
         "   and t_date = :dt ";

   if (type > 0)
      sql = sql +
          "  AND ( (t_open_balance > 0)    " +
                  "OR (t_open_balance = 0   " +
                  "    AND EXISTS           " +
                        " (SELECT 1     " +
                        "    FROM DDL_LIMITADJUST_DBT tt     " +
                        "   WHERE T.T_ID_OPER = tt.t_id_oper " +
                        "     AND tt.t_limit_kind = 0        " +
                        "     AND tt.t_open_balance > 0)))   ";
     if (OnlyMONEY and not OnlyDEPO)
      sql = sql +
          "  AND T_LIMIT_TYPE = 'MONEY'"; 
      where_lt="MONEY"
     elif (not OnlyMONEY and OnlyDEPO)
      sql = sql +
          "  AND T_LIMIT_TYPE = 'DEPO'"; 
      where_lt="DEPO"
     elif (OnlyMONEY and OnlyDEPO)
       where_lt="DEPO&MONEY" ;
     end
   elif (type < 0)
      sql = sql +
          "  AND ( (t_open_balance < 0)  " +
                "OR (t_open_balance = 0  " +
                "    AND EXISTS          " +
                          " (SELECT 1    " +
                          "    FROM DDL_LIMITADJUST_DBT tt     " +
                          "   WHERE T.T_ID_OPER = tt.t_id_oper " +
                          "     AND tt.t_limit_kind = 0        " +
                          "     AND tt.t_open_balance < 0)))   ";

   end;

   if (OnlyNewRec)
     if (where_lt == "DEPO&MONEY")
       sql = sql +
          "  and op.t_dockind = 4607 and ( "+
          " ( T_LIMIT_TYPE = 'MONEY' and not exists (SELECT /*+ ordered */ 1 " + 
          "FROM  dnotetext_dbt nt " + 
          "WHERE nt.t_notekind = 101 " + 
          "  AND nt.t_objecttype = 131 " + 
          "  AND nt.t_documentid in ( lpad(op.t_documentid,10,'0'),lpad(op.t_documentid,34,'0')))) "+
          " or ( T_LIMIT_TYPE = 'DEPO' and not exists (SELECT /*+ ordered */ 1 " + 
          "FROM  dnotetext_dbt nt " + 
          "WHERE nt.t_notekind = 106 " + 
          "  AND nt.t_objecttype = 131 " + 
          "  AND nt.t_documentid in ( lpad(op.t_documentid,10,'0'),lpad(op.t_documentid,34,'0')))) )";
    else
      sql = sql +
          "  and not exists (SELECT /*+ ordered */ 1         " + 
          "FROM (select 4607 dockind, 131 objecttype, 101 notekind, CAST(NULL AS number)  type , 'MONEY' limit_type from dual union all " +
          "      select 4607 dockind, 131 objecttype, 101 notekind, -1 , CAST('DEPO' AS varchar(5)) from dual union all " +
          "      select 4607 dockind, 131 objecttype, 106 notekind, 1 , CAST('DEPO' AS varchar(5)) from dual union all " +
          "      select 4608 dockind, 133 objecttype, 101 notekind, CAST(NULL AS number) , CAST(NULL AS varchar(5)) from dual union all " +
          "      select 159  dockind, 159 objecttype, 101 notekind, CAST(NULL AS number) , CAST(NULL AS varchar(5)) from dual ) nup " +
          "     , dnotetext_dbt nt " + 
          "WHERE nup.dockind = op.t_dockind  and nvl(nup.type,"+string(type)+") = "+string(type)+iif((where_lt!= "ALL")," and nvl(limit_type,'"+where_lt+"') = '"+where_lt+"'","")+
          "  and nt.t_notekind = nup.notekind  " + 
          "  AND nt.t_objecttype = nup.objecttype  " + 
          "  AND nt.t_documentid in ( lpad(op.t_documentid,10,'0'),lpad(op.t_documentid,34,'0'))) ";
      end;
   end;

   if (OnlyROVU48)
      sql = sql +
          "  and op.t_kind_operation = 2030    " +
          "  and op.t_dockind = 159            " +
          "  and exists (select 1              " +
                      "  from ddl_acc_dbt ac  " +
                      " where lpad (to_char (ac.t_id), 10, '0') = op.t_documentid  " +
                      "   and ac.t_opertype = 48 )                                 ";
   else
      sql = sql +
          "  and (   op.t_dockind != 159   " +
          "       or not exists (select 1  " +
                          "   from ddl_acc_dbt ac  " +
                          "  where lpad (to_char (ac.t_id), 10, '0') = op.t_documentid  " +
                          "    and ac.t_opertype = 48 ))                                ";
   end;

   if(OnlyHoldNDFL)
      sql = sql + " and op.t_dockind = 4608 ";
   end;

   sql = sql + " order by t_id_oper, t_limit_kind, t_client_code, t_curr_code";

   return sql;
end; // LimitCorOutBuildQuery

private macro LimitCorOutInternal( dt, 
                                   NonDiag, 
                                   type, 
                                   OnlyNewRec, 
                                   OnlyROVU48,
                                   limitfile:@string,
                                   OnlyHoldNDFL,
                                   OnlyMONEY,
                                   OnlyDEPO          
                                )
   var StrPath :string = "",
       limitRow :string = "",
       prev_id_oper = -1,
       prev_limit_type = "",
       limit_rub = $0.0, unload_cur = "", i_lim = $0.0, overlimit = $0.0, unloaded = 0, isOverLimitMsgPrint = true;
   var operState = 0;
   var cnt = 1; 
   var hasLines = false;
   var hasLines_lim = false;
   var isNextOperation:bool, isNextLimOperation:bool ;

   var v_email_processor, emailText = "";

   //получим значение пути выгрузки из реестра
   LimitCorOutGetSettings(@StrPath, @limit_rub, @unload_cur);

   //makeFile
   MakeDir(string(StrPath));
   MakeDir(string(StrPath+"\\", "Archive"));
   var fullf = StrPath+"\\limits.lci";
   var fileStream = TStreamDoc(fullf, "C");

   var day, month, year;
   var hh, mm, ss;

   DateSplit ( date, day, month, year );
   var strd = string(day:o:2)+string(month:o:2)+string(year:o:4);

   TimeSplit ( time, hh, mm, ss );
   var strt = string(hh:o:2)+string(mm:o:2)+string(ss:o:2);

   var fullf_lim = StrPath+"\\limits.lim";
   var fileStream_lim = TStreamDoc(fullf_lim, "C");

   //getData
   var query = LimitCorOutBuildQuery(type, OnlyNewRec, OnlyROVU48, OnlyHoldNDFL, OnlyMONEY, OnlyDEPO );
   var cmd = RsdCommand(query);
   cmd.addParam("dt", RSDBP_IN, dt);
   cmd.Execute();
   var data = trsbdataset(cmd);
   
   initprogress(-1, "Выгрузка в файл", "Выгрузка в: " + fullf);

   while (data.movenext())
      isNextOperation = (prev_id_oper != data.Id_Oper);
      isNextLimOperation = isNextOperation or  (prev_limit_type != data.limit_type);
      
      prev_id_oper = data.id_oper;
      prev_limit_type = data.limit_type ;
      
      if (data.limit_type == "MONEY")
         limitRow = 
                    "LIMIT_TYPE = "     +data.LIMIT_TYPE  + 
                  "; LIMIT_ID = "       +data.LIMITID     +
                  "; FIRM_ID = "        +data.FIRM_ID     +
                  "; TAG = "            +data.tag         +
                  "; CURR_CODE = "      +data.curr_code   +
                  "; CLIENT_CODE = "    +data.client_code +
                  "; OPEN_BALANCE = "   +data.open_balance+
                  "; OPEN_LIMIT = "     +data.open_limit  +
                  "; CURRENT_LIMIT = "  +data.current_limit+
                  "; LIMIT_OPERATION = "+data.limit_operation+
                  "; LIMIT_KIND = "     +data.limit_kind;
         if (data.leverage != -1)
           limitRow = limitRow + "; LEVERAGE = "+trim(string(data.leverage:0:0));
         end;
         limitRow = limitRow + ";";
      elif (data.limit_type == "DEPO")
        if ((data.Limit_Operation == "SET_LIMIT") and (data.open_balance == 0)) 
          /*DEPO:  FIRM_ID = MC0134700000; SECCODE = GAZP; CLIENT_CODE = 468753; LIMIT_KIND = 0; OPEN_BALANCE = 0; OPEN_LIMIT = 0; WA_POSITION_PRICE = 0.000000; TRDACCID = L01+00000F00; */
          limitRow = "DEPO:  "+
                  "FIRM_ID = "        +data.FIRM_ID     +
                  "; SECCODE = "        +data.seccode     +
                  "; CLIENT_CODE = "    +data.client_code +
                  "; LIMIT_KIND = "     +data.limit_kind  +
                  "; OPEN_BALANCE = "   +trim(string(data.open_balance:0:0))+
                  "; OPEN_LIMIT = "     +trim(string(data.open_limit:0:0))  +
                  "; WA_POSITION_PRICE = 0.000000"        +
                  "; TRDACCID = "       +data.trdaccid + ";"
 
        else
         /* LIMIT_TYPE = DEPO; LIMIT_ID = 11616550; FIRM_ID = MB0134700000; SECCODE = USD000UTSTOM; CLIENT_CODE = CU413098; OPEN_BALANCE = 0.00;
            OPEN_LIMIT = 0.00; CURRENT_LIMIT = 0.00; LIMIT_OPERATION = CORRECT_LIMIT; LIMIT_KIND = 0; LEVERAGE = 0.00;*/
          limitRow = 
                    "LIMIT_TYPE = "     +data.LIMIT_TYPE  + 
                  "; LIMIT_ID = "       +data.LIMITID     +
                  "; FIRM_ID = "        +data.FIRM_ID     +
                  "; SECCODE = "        +data.seccode     +
                  "; CLIENT_CODE = "    +data.client_code +
                  "; OPEN_BALANCE = "   +trim(string(data.open_balance:0:0))+
                  "; OPEN_LIMIT = "     +trim(string(data.open_limit:0:0))  +
                  "; CURRENT_LIMIT = "  +trim(string(data.current_limit:0:0))+
                  "; LIMIT_OPERATION = "+data.limit_operation+
                  "; LIMIT_KIND = "     +data.limit_kind;
        //DEF-70623 Поле LEVERAGE может быть только по строкам с типом MONEY
         
         limitRow = limitRow + "; TRDACCID = " + data.trdaccid + ";";
        end ;
      end;

      if (data.isblocked == "X")
         println( "Блокировка: " + limitRow );
         continue;
      end;

      if(isNextOperation) 
         /*для операций зачисления по рублям считаем суммарну*/
         if ((data.open_balance > 0) and (data.curr_code == "SUR"))
            i_lim = i_lim + data.open_balance;
         end;

         if (i_lim > limit_rub)
            if (isOverLimitMsgPrint)
               println("---------------Превышение лимита по зачислениям SUR. ---------------");
               isOverLimitMsgPrint = false;
            end;

            overlimit = overlimit + data.open_balance;
         end;

         operState = StateOperByTrn(data.Id_Oper, dt, OnlyNewRec);
         if (operState == 1)
            println("--------------Возможно операция клиента "+data.client_code+" на сумму "+data.open_balance+" уже учтена в утренних лимитах --------------");
         elif (operState == 2)
            println("--------------По операции клиента "+data.client_code+" на сумму "+data.open_balance+" нет проводок --------------");
         end;

         unloaded = unloaded + 1;
         useprogress(unloaded);
      end;

      if(isNextLimOperation) 
         markOperationAsUnloaded(type,data.limit_type,data.t_dockind, data.t_documentid);
      end;
      if ((data.limit_type == "MONEY") or (data.Limit_Operation != "SET_LIMIT") or (data.open_balance != 0))
        hasLines = true;
        fileStream.WriteLine( limitRow );
      elif ((data.limit_type == "DEPO") and (data.Limit_Operation = "SET_LIMIT") and (data.open_balance == 0) )
        hasLines_lim = true;
        fileStream_lim.WriteLine( limitRow );
      end;
      println( limitRow );
   end;

   fileStream = null;
   fileStream_lim = null;

   if (not hasLines)
     RemoveFile(fullf);
   end;

   if (not hasLines_lim)
     RemoveFile(fullf_lim);
   end;

   RemProgress();
   var fileArch="",copyArch = false, copyArch_lim = false,fullf_all="" ;
   if (ExistFile(fullf))
      fileArch = StrPath+"\\Archive\\limits"+string(dt:fileStream)+"_"+strd+strt+".lci" ;
      copyArch = CopyFile(fullf, fileArch);
      limitfile = fullf;
      fullf_all=fullf_all+"|в "+fullf ;
   end;
   if (ExistFile(fullf_lim))
      fileArch = StrPath+"\\Archive\\limits"+string(dt:fileStream)+"_"+strd+strt+".lim" ;
      copyArch_lim = CopyFile(fullf_lim, fileArch);
      fullf_all=fullf_all+"|в "+fullf_lim ;
   end;

   if (overlimit > 0)
      msgbox(fullf +"| Превышен лимит для автоматической выгрузки корректировок на "+overlimit+"| Выгружено: " + unloaded);
      if (NonDiag)/*безынтерфейсный режим*/
         v_email_processor = c_email_proc_env();

         emailText =
         emailText  + "\n\nПревышен лимит для автоматической выгрузки корректировок на "+overlimit+". \n"
                    + "\n\n"  
                    + "\n Выгружено: " + unloaded;
         v_email_processor.m_add_broker_email_to_list();
         v_email_processor.m_set_msg_head("Превышен лимит выгрузки корректировок!");
         v_email_processor.m_add_row_to_msg_text(emailText);
         v_email_processor.m_save_to_submit_synch();
         v_email_processor.m_submit_email_synch();

      end;
   else
      if (hasLines or hasLines_lim)
         if ((hasLines and not copyArch) or (hasLines_lim and not copyArch_lim)) 
            msgbox( "Выгружено: " + unloaded+fullf_all+"|В \\Archive НЕ СКОПИРОВАНО !!! ");
         else
            msgbox( "Выгружено: " + unloaded+fullf_all);
         end;
      else
         msgbox("Файл не сформирован| Выгружено: " + unloaded);
      end;
   end;
end; //LimitCorOutInternal

macro LimitCorOut(  _Dat, 
                    NonDiag, 
                    _inout/*-1 - списания, 0 - все, 1 - зачисления*/ , 
                    OnlyNewRec, 
                    OnlyROVU48 /*BIQ-10484 CCBO-5829 */ ,
                    limitfile:@string /*BIQ-10484 CCBO-5829 */,
                    OnlyHoldNDFL
                 ) :integer
   var type:integer = _inout;
   var dat:date = date();
   var OnlyMONEY  = false;
   var OnlyDEPO  = false;


   if (ValType(OnlyNewRec) == V_UNDEF)
      OnlyNewRec = false;
   end;

   if (ValType(OnlyROVU48) == V_UNDEF)
      OnlyROVU48 = false;
   end;

   if (ValType(OnlyHoldNDFL) == V_UNDEF)
      OnlyHoldNDFL = false;
   end;

   if (ValType(type) == V_UNDEF)
      type = 0;
   end;

   if (ValType(_Dat) != V_UNDEF)
      dat = _Dat;
   else
      var panel = ChoiceDatePanel(type);
      panel.run;
      if (panel.stat == 1)
         [Выгрузка отменена];
         return;
      end;
      dat = panel.DateBeg;
      OnlyNewRec = panel.OnlyNewRec;
      OnlyHoldNDFL = panel.OnlyHoldNDFL;
      OnlyMONEY  = panel.OnlyMONEY;
      OnlyDEPO  = panel.OnlyDEPO;
   end;

   LimitCorOutInternal(dat, 
                       NonDiag, 
                       type, 
                       OnlyNewRec, 
                       OnlyROVU48,
                       @limitfile,
                       OnlyHoldNDFL,
                       OnlyMONEY,
                       OnlyDEPO
                    );
end;

private macro CreateLimitAdJust(limitadjust)
   var sql = 
        "DECLARE " +
        "   p_LimitAdj             DDL_LIMITADJUST_DBT%ROWTYPE; " +
        "   UnknownDate   CONSTANT DATE := TO_DATE ('01.01.0001', 'DD.MM.YYYY'); " +
        "   UnknownTime   CONSTANT DATE := TO_DATE ('01.01.0001 00:00:00', 'DD.MM.YYYY HH24:MI:SS'); " +
        "BEGIN " +
        "   p_LimitAdj.t_ID              := 0; " +
        "   p_LimitAdj.T_LIMITID         := NVL (:T_LIMITID, 0); " +
        "   p_LimitAdj.T_LIMIT_KIND       := NVL (:T_LIMIT_KIND, 0); " +
        "   p_LimitAdj.T_DATE            := NVL (:T_DATE, UnknownDate); " +
        "   p_LimitAdj.T_TIME            := NVL (:T_TIME, UnknownTime); " +
        "   p_LimitAdj.T_MARKET          := NVL (:T_MARKET, -1); " +
        "   p_LimitAdj.T_CLIENT          := NVL (:T_CLIENT, 0); " +
        "   p_LimitAdj.T_INTERNALACCOUNT := NVL (:T_INTERNALACCOUNT, 0); " +
        "   p_LimitAdj.T_LIMIT_TYPE      := NVL (:T_LIMIT_TYPE, CHR (1)); " +
        "   p_LimitAdj.T_FIRM_ID         := NVL (:T_FIRM_ID, CHR (1)); " +
        "   p_LimitAdj.T_CLIENT_CODE     := NVL (:T_CLIENT_CODE, CHR (1)); " +
        "   p_LimitAdj.T_OPEN_BALANCE    := NVL (:T_OPEN_BALANCE, 0); " +
        "   p_LimitAdj.T_OPEN_LIMIT      := NVL (:T_OPEN_LIMIT, 0); " +
        "   p_LimitAdj.T_CURRENT_LIMIT   := NVL (:T_CURRENT_LIMIT, 0); " +
        "   p_LimitAdj.T_LIMIT_OPERATION := NVL (:T_LIMIT_OPERATION, CHR (1)); " +
        "   p_LimitAdj.T_TRDACCID        := NVL (:T_TRDACCID, CHR (1)); " +
        "   p_LimitAdj.T_SECCODE         := NVL (:T_SECCODE, CHR (1)); " +
        "   p_LimitAdj.T_TAG             := NVL (:T_TAG, CHR (1)); " +
        "   p_LimitAdj.T_CURRID          := NVL (:T_CURRID, -1); " +
        "   p_LimitAdj.T_CURR_CODE       := NVL (:T_CURR_CODE, CHR (1)); " +
//        "   p_LimitAdj.T_LIMIT_KIND      := NVL (:T_LIMIT_KIND, 0); " +
        "   p_LimitAdj.T_LEVERAGE        := NVL (:T_LEVERAGE, 0); " +
        "   p_LimitAdj.T_ID_OPER         := NVL (:T_ID_OPER, 0); " +
        "   p_LimitAdj.T_ID_STEP         := NVL (:T_ID_STEP, 0); " +
        "   p_LimitAdj.T_ISBLOCKED       := NVL (:T_ISBLOCKED, CHR (0)); " +
        " " +
        "   rshb_rsi_sclimit.RSI_CreateLimitAdJust (p_LimitAdj, :p_id_operation, :p_id_step); " +
        "END; " ;

   var cmd = RsdCommand(sql);
       cmd.addParam("T_LIMITID         ",RSDBP_IN, limitadjust.rec.LIMITID        );
       cmd.addParam("T_LIMIT_KIND       ",RSDBP_IN, limitadjust.rec.LIMIT_KIND      );
       cmd.addParam("T_DATE            ",RSDBP_IN, limitadjust.rec.DATE           );
       cmd.addParam("T_TIME            ",RSDBP_IN, limitadjust.rec.TIME           );
       cmd.addParam("T_MARKET          ",RSDBP_IN, limitadjust.rec.MARKET         );
       cmd.addParam("T_CLIENT          ",RSDBP_IN, limitadjust.rec.CLIENT         );
       cmd.addParam("T_INTERNALACCOUNT ",RSDBP_IN, limitadjust.rec.INTERNALACCOUNT);
       cmd.addParam("T_LIMIT_TYPE      ",RSDBP_IN, limitadjust.rec.LIMIT_TYPE     );
       cmd.addParam("T_FIRM_ID         ",RSDBP_IN, limitadjust.rec.FIRM_ID        );
       cmd.addParam("T_CLIENT_CODE     ",RSDBP_IN, limitadjust.rec.CLIENT_CODE    );
       cmd.addParam("T_OPEN_BALANCE    ",RSDBP_IN, limitadjust.rec.OPEN_BALANCE   );
       cmd.addParam("T_OPEN_LIMIT      ",RSDBP_IN, limitadjust.rec.OPEN_LIMIT     );
       cmd.addParam("T_CURRENT_LIMIT   ",RSDBP_IN, limitadjust.rec.CURRENT_LIMIT  );
       cmd.addParam("T_LIMIT_OPERATION ",RSDBP_IN, limitadjust.rec.LIMIT_OPERATION);
       cmd.addParam("T_TRDACCID        ",RSDBP_IN, limitadjust.rec.TRDACCID       );
       cmd.addParam("T_SECCODE         ",RSDBP_IN, limitadjust.rec.SECCODE        );
       cmd.addParam("T_TAG             ",RSDBP_IN, limitadjust.rec.TAG            );
       cmd.addParam("T_CURRID          ",RSDBP_IN, limitadjust.rec.CURRID         );
       cmd.addParam("T_CURR_CODE       ",RSDBP_IN, limitadjust.rec.CURR_CODE      );
//       cmd.addParam("T_LIMIT_KIND      ",RSDBP_IN, limitadjust.rec.LIMIT_KIND     );
       cmd.addParam("T_LEVERAGE        ",RSDBP_IN, limitadjust.rec.LEVERAGE       );
       cmd.addParam("T_ID_OPER         ",RSDBP_IN, limitadjust.rec.ID_OPER        );
       cmd.addParam("T_ID_STEP         ",RSDBP_IN, limitadjust.rec.ID_STEP        );
       cmd.addParam("T_ISBLOCKED       ",RSDBP_IN, limitadjust.rec.ISBLOCKED      );
       cmd.addParam("p_id_operation    ",RSDBP_IN, limitadjust.rec.ID_OPER        );
       cmd.addParam("p_id_step         ",RSDBP_IN, limitadjust.rec.ID_STEP        );
   cmd.Execute();

end;

macro InsertLimitAdjust(ContrId, LimitKind, LimitType, OpenBalance, Fiid, LimitDate, ID_Operation, LimitOperation, err:@string)

  private var limitadjust = TRecHandler("dl_limitadjust.dbt");
  private var _dockind = -1;
  it_log(string("Старт ContrId=",ContrId,", LimitKind=",LimitKind,", LimitType=",LimitType,", OpenBalance=",OpenBalance,", Fiid=",Fiid," LimitDate=",LimitDate,", ID_Operation=",ID_Operation),"limout.mac");
  
  private macro nvl(val, retval)
    if (ValType(Val) == V_UNDEF)
       return retval;
    else
       return val;
    end;
  end;
  private macro iif(val, retval, retval2)
    if (Val)
       return retval;
    else
       return retval2;
    end;
  end;
  private macro GetFiCode(Curr, fi_kind)
     var Dt = TRsbDataSet(" select decode(t_fi_kind,1,decode(t_ccy,'RUB','SUR',t_ccy),t_code) curr_code,  t_fi_kind from dfininstr_dbt f " + 
                          " left join dobjcode_dbt a on a.t_objectid = f.t_fiid and a.t_codekind = 11 and t_objecttype = 9 where t_fiid = " + Curr + 
                          " and t_fi_kind = " + fi_kind );
     if (Dt.movenext())
        return dt.curr_code;
     end;
     return "";
  end;
  private macro GetCurDepoCode(Curr)
     var Dt = TRsbDataSet(" select t_code from  " + 
                          " dobjcode_dbt where t_objectid =  "+curr+" and t_codekind = 106 and t_objecttype = 9 and t_state = 0 " );
     if (Dt.movenext())
        return dt.code;
     end;
     return "";
  end;

  private macro GetDocKind(id_operation)
     if (_dockind == -1)
        var Dt = TRsbDataSet(" select t_dockind from doproper_dbt where t_id_operation = " + id_operation);
        if (Dt.Movenext())
           _dockind = Dt.dockind;
        else
           _dockind = 0;
        end;
     end;
     return _dockind;
  end;

  /* DEF-62480, код участника торгов, код позиции и торговый счет получаем из параметров расчета лимитов 
   */
  private macro GetLimitPrm( p_SfContrID: INTEGER, p_LimitDate: DATE, p_FirmID:@STRING, p_Tag:@STRING, p_TrdAcc:@STRING )

    var sql, cmd;
   
    sql =  "DECLARE "
         + "BEGIN "
         + "    RSHB_RSI_SCLIMIT.GetLimitPrm(:SfContrID, :LimitDate, :FirmID, :Tag, :TrdAcc); "
         + "END; "
    ;
      
    cmd = RSDCommand(sql);
    cmd.addParam("SfContrID", RSDBP_IN, p_SfContrID);
    cmd.addParam("LimitDate", RSDBP_IN, p_LimitDate);
    cmd.addParam("FirmID", RSDBP_OUT, V_STRING);
    cmd.addParam("Tag", RSDBP_OUT, V_STRING);
    cmd.addParam("TrdAcc", RSDBP_OUT, V_STRING);
    cmd.execute();

    p_FirmID = cmd.value("FirmID");
    p_Tag = cmd.value("Tag");
    p_TrdAcc = cmd.value("TrdAcc");
    return true;
  onerror(err)
    return false;
  end; // GetLimitPrm()

  var _dt;
  var sfcontr = c_sfcontr(ContrID);
  var limitprm = TRsbDataSet(" select * from ddl_limitprm_dbt where t_marketkind = 3");/*для валютного*/
  var existsCurParm = limitprm.movenext();
  var NumForID;/*для уникальности id операции в операциях первода не хватает, добавим разрез по рынку*/
  var sfcontrIsEDP = sfcontr.isEdp();


  if (LimitType == "DEPO")
    NumForID = 4;
  elif (LimitType == "MONEY")
    NumForID = 0;
  else
    err = "Для данного вида лимита не заданы правила определения limitID";
    return false;
  end;


  if (sfcontrIsEDP)
     limitadjust.rec.client_code = GetMicexCode_FB(ContrID)
  else
     limitadjust.rec.client_code = GetMicexCode(ContrID);
  end;

  if (limitadjust.rec.client_code == "")
     err = "Не удалось получить Код клиента на Бирже. "+sfcontr.rec.number;
     return false;
  end;

  if ( LimitType == "DEPO")
    if (sfcontr.IsCurMarket())
      limitadjust.rec.Limitid = ID_Operation * 10 + 9 /*для нулевого лимита DEPO по валюте*/;
    elif (sfcontr.GetMarketId() == GetSpbexID())
      limitadjust.rec.Limitid = ID_Operation * 10 + 8 ;
    else
      limitadjust.rec.Limitid = ID_Operation * 10 + 4 ;
    end;    
  elif (LimitKind == "365") 
    limitadjust.rec.Limitid = ID_Operation * 10 + 3 + NumForID;
  else 
    limitadjust.rec.Limitid = ID_Operation * 10 + int(LimitKind) + NumForID;
  end;
  
  limitadjust.rec.open_balance    = OpenBalance;  
  limitadjust.rec.limit_kind      = LimitKind;
  limitadjust.rec.limit_Type      = LimitType;
  limitadjust.rec.date            = LimitDate;
  //limitadjust.rec.time          = time();
  limitadjust.rec.market          = 1;
  limitadjust.rec.client          = sfcontr.rec.partyID;
  limitadjust.rec.curr_code       = GetFiCode(Fiid, 1);
  if (( LimitType == "MONEY") and (limitadjust.rec.curr_code == ""))
     err = "Не удалось получить Код валюты. fiid = "+ Fiid;
     return false;
  end;
  limitadjust.rec.currid          = Fiid;
  if (( LimitType == "DEPO") and (sfcontr.IsCurMarket() or sfcontr.isStock()) and (OpenBalance == 0) and (fiid == -1) and (LimitKind == "0") )  // DEF-68258
     if (sfcontr.IsCurMarket())
       limitadjust.rec.seccode         = GetCodeSCZeroLimit(3, 2, 1);
     else
       limitadjust.rec.seccode         = GetCodeSCZeroLimit(1, sfcontr.GetMarketId(), 1);
     end;     
     _dt = TRsbDataSet(" select 1 from ddl_limitadjust_dbt where t_date = " +GetSQLDate(LimitDate)+" and t_limit_type = 'DEPO' "
         +" and t_client_code = '"+limitadjust.rec.client_code+"' and T_SECCODE = '"+limitadjust.rec.seccode+"' ");
     if (_dt.movenext())
         it_log(string("Есть 0лимит t_client_code=",limitadjust.rec.client_code,", T_SECCODE=",limitadjust.rec.seccode,", ID_Operation=",ID_Operation),"limout.mac");
        return true;
     end;

  elif (( LimitType == "DEPO") and sfcontr.IsCurMarket()) 
     limitadjust.rec.seccode         = GetCurDepoCode(Fiid);
  else
     limitadjust.rec.seccode         = GetFiCode(Fiid, 2);
  end;
  if (( LimitType == "DEPO") and (limitadjust.rec.seccode == ""))
     err = "Не удалось получить Код ценной бумаги на МБ. ID инструмента = "+ Fiid;
     it_log(string(err, ", T_SECCODE=",limitadjust.rec.seccode,", ID_Operation=",ID_Operation),"limout.mac");
     return false;
  end;
  
  if (( LimitType == "DEPO") and  (OpenBalance == 0) and (fiid == -1) )  // DEF-78731
    limitadjust.rec.Limit_Operation = "SET_LIMIT" ;
  else
    limitadjust.rec.Limit_Operation = nvl(LimitOperation,"CORRECT_LIMIT");
  end;
  if (sfcontr.isCurMarket())
     if (not sfcontrIsEDP)
       limitadjust.rec.Firm_ID         = "MC0134700000";
       if (existsCurParm)
         limitadjust.rec.trdaccid     = limitprm.depoacc;
       else
         limitadjust.rec.trdaccid     = "MB0134716791";
       end;
     else
       if (existsCurParm)
         limitadjust.rec.Firm_ID      = limitprm.firmcode;
         limitadjust.rec.trdaccid     = limitprm.depoacc;
       else
         limitadjust.rec.Firm_ID         = "MB0134700000";
         limitadjust.rec.trdaccid     = "MB0134716791";
       end;
     end;
  else
     limitadjust.rec.Firm_ID         = "MC0134700000";
  end;
  
  /*DEF-32047*/
  if (sfcontrIsEDP)
      limitadjust.rec.Firm_ID     = "MC0134700000";
  end; 
  /*DEF-32047*/

  /* DEF-62480, код участника торгов, код позиции и торговый счет получаем из параметров расчета лимитов  */
  if ( not GetLimitPrm( ContrID, LimitDate, @limitadjust.rec.Firm_ID, @limitadjust.rec.Tag, @limitadjust.rec.trdaccid ) )
     it_log(string(" Не выполнен GetLimitPrm", ", Firm_ID=",limitadjust.rec.Firm_ID,", ID_Operation=",ID_Operation),"limout.mac");
    return false; //DEF-72632 прекращаем расчет
  end;

  //Костыль. GetLimitPrm не должна пересчитывать тэг, это ошибка. В качестве временной затычки тег перезапишем. Далее последует полноценное решение
  limitadjust.rec.Tag = "";
  if (sfcontr.GetMarketId() == GetSpbexID())
    limitadjust.rec.Tag = sfcontr.GetTagFromNote(LimitDate);
  end;
  if ((limitadjust.rec.Tag == "") and (sfcontr.IsCurMarket() and (not sfcontrIsEDP)))
    limitadjust.rec.Tag = "RTOD";
  end;
  if (limitadjust.rec.Tag == "")
    limitadjust.rec.Tag = "EQTV";
  end;
  
  limitadjust.rec.isBlocked       = sfcontr.IsBlocked(LimitDate);

  if  (LimitType == "MONEY")
    if (sfcontr.IsQI() and (RegVal_Default_Leverage != -1))
      limitadjust.rec.leverage = RegVal_Default_Leverage;
    else
      limitadjust.rec.leverage = sfcontr.GetTestResult();

      if (RegVal_Default_Leverage_Entity != -1)
         if (limitadjust.rec.leverage == -1)  
            var po = RSBParty(sfcontr._party.rec.partyid);
            if ( (po.legalform == PTLEGF_INST)  // ЮЛ не квал.инвесторы и без примечания
                 and (not po.IsOwned(65) ) ) // не доверительный управляющий
               limitadjust.rec.leverage =  RegVal_Default_Leverage_Entity;
            end;
         end;
      end;
    end;
  else 
    limitadjust.rec.leverage = -1;
  end;

  /* DEF-67912, Неверное заполнение ddl_limitadjust_dbt.T_TRDACCID для категории MONEY */
  if  (LimitType == "MONEY")
     limitadjust.rec.trdaccid = "";
  end;

  
  if ((GetDocKind(ID_Operation) == 4607) or (GetDocKind(ID_Operation) == 4608))
     DL_CreateLimitAdJust(limitadjust);
  else
     limitadjust.rec.id_oper = id_operation;
     limitadjust.rec.id_step = 2;
     CreateLimitAdJust(limitadjust);
  end;
  it_log(string(" ФИНИШ "," ID_Operation=",ID_Operation),"limout.mac");

  return true;

end;


//сервис загрузки лимитов
macro ws_lmt_to_buf( Str_Param :string, dat, fullf:@string, fulls:@string, msg:@string, sec, fut, cur, edp, fname, marketid, unload_sel, delete_sel ) :integer

var state :integer = 0,
    errortext :string = "",
    Params :TArray,
    StrPath :string = "",
    ErrCode;

 if (ValType(cur) == V_UNDEF)
    cur = false;
 end;
 if (ValType(sec) == V_UNDEF)
    sec = false;
 end;
 if (ValType(fut) == V_UNDEF)
    fut = false;
 end;
 if (ValType(edp) == V_UNDEF)
    edp = false;
 end;
 if (ValType(marketid) == V_UNDEF)
    marketid = -1;
 end;

 if ((not cur) and (not fut) and (not sec) and (not edp))
    println("Файлы не выгружены. Ни один рынок не выбран.");
    msg = "Файлы не выгружены. Ни один рынок не выбран.";
    return state;
 end;

 if( not GetParm(2, Str_Param) )
   Str_Param = "";
 end;

 if (ValType(unload_sel) == V_UNDEF)
    unload_sel = false;
 end;

 if (ValType(delete_sel) == V_UNDEF)
    delete_sel = false;
 end;

 //формируем файл
 //получим значение пути выгрузки из реестра
 GetRegistryValue(REG_EXPORT_PATH, V_STRING, StrPath, ErrCode);
 if( ErrCode > 0 )
    StrPath = "..\\QUIK_EXCHNG\\out";
 end;
 //получим значение пути выгрузки из реестра

 if (ValType(fname) == V_UNDEF)
    fname = "limit";
 end;

 // state = CreateOutputFileLMT(/*"$C:\\RsBank60"*/ StrPath );
 //формируем файл
  fullf = StrPath+"\\"+fname+".lim";
  fulls = StrPath+"\\limit.fli";


 if ( cur or sec or edp)
    var f = TStreamDoc(fullf, "C");
   /***********************/
   /* MONEY */
   var dt, cnt, sql = "";

   sql = "  SELECT t_firm_id, t_tag, t_curr_code, t_client_code, t_limit_kind, t_open_balance, t_leverage " ;

   if (unload_sel or delete_sel)
        sql = sql +
        // "  SELECT * " +
         "    FROM DDL_LIMITCASHSTOCK_DBT s left join " +
         "    (SELECT distinct t.t_mpcode, t.t_dlcontrid " +
         "  FROM    ddl_panelcontr_dbt P " +
         "       LEFT JOIN " +
         "          (SELECT t_mpcode, t_dlcontrid " +
         "             FROM ddlcontrmp_dbt mp " +
         "            WHERE t_mpcode <> CHR (1) " +
         "           UNION ALL " +
         "           SELECT t_code, t_objectid " +
         "             FROM ddlobjcode_dbt o " +
         "            WHERE     t_bankclosedate = TO_DATE ('01010001', 'ddmmyyyy') " +
         "                  AND t_objecttype = 207 " +
         "                  AND t_codekind = 1) t " +
         "       ON p.t_dlcontrid = t.t_dlcontrid " +
         " WHERE p.T_CALC_SID = 'X' and t_setflag = CHR (88)) t on s.t_client_code = t.t_mpcode  " +
         "   WHERE  t_isblocked <> CHR (88)  " ;
     if (unload_sel)
        sql = sql + " and t.t_dlcontrid is not null ";
     end;
     if (delete_sel)
        sql = sql + " and t.t_dlcontrid is null ";
     end;
   else
     sql = sql + " from DDL_LIMITCASHSTOCK_DBT where t_isblocked <> CHR (88) " ; 
   end;

   if (marketid != -1)
     sql = sql +  " and t_market = " + string(marketid) ;
   end;

   if (cur or  sec or edp)
     sql = sql + " and (   (( "+iif(edp,1,0)+" = 0) or ( t_market_kind = 'ЕДП')) "   ;
     sql = sql + "      or (( "+iif(cur,1,0)+" = 0) or ( t_market_kind = 'валютный'))   " ;
     sql = sql + "      or (( "+iif(sec,1,0)+" = 0) or ( t_market_kind = 'фондовый'))  ) " ;
   end;

   if (sql != "")

     sql = sql + " and t_date = " +GetSQLDate(dat) + " order by t_client_code, t_curr_code, t_limit_kind, t_tag"; 

     dt = trsbdataset(sql);
     cnt = 1; 
     initprogress(sql_getnrecs(sql),"Выгрузка в файл", "Выгрузка в файл раздела MONEY: " + fullf);
     while (dt.movenext())
        f.WriteLine(
       "MONEY:  FIRM_ID = "+dt.firm_id+"; TAG = "+dt.tag+"; CURR_CODE = "+dt.curr_code+"; CLIENT_CODE = "+dt.client_code+"; LIMIT_KIND = "+dt.limit_kind+"; OPEN_BALANCE = "+dt.open_balance+"; OPEN_LIMIT = 0.00;" + IIF (dt.leverage == -1,"", " LEVERAGE = "+trim(string(dt.leverage:0:0))+";")
       /*MONEY:  FIRM_ID = MC0134700000; TAG = EQTV; CURR_CODE = SUR; CLIENT_CODE = 40491; LIMIT_KIND = 2; OPEN_BALANCE = 0; OPEN_LIMIT = 0; LEVERAGE = 0;*/
       );
       useprogress(cnt=cnt+1);
     end;

     remprogress;
   end;

  /***********************/
  /* DEPO */
  sql = "";

  if (unload_sel or delete_sel)
   sql = 
         "  SELECT s.t_firm_id, s.t_seccode, s.t_client_code, s.t_limit_kind, trunc(s.t_open_balance) t_open_balance, s.t_open_limit, s.t_wa_position_price, s.t_trdaccid " +
         "    FROM DDL_LIMITSECURITES_DBT s left join " +
         "    (SELECT distinct t.t_mpcode, t.t_dlcontrid " +
         "  FROM    ddl_panelcontr_dbt P " +
         "       LEFT JOIN " +
         "          (SELECT t_mpcode, t_dlcontrid " +
         "             FROM ddlcontrmp_dbt mp " +
         "            WHERE t_mpcode <> CHR (1) " +
         "           UNION ALL " +
         "           SELECT t_code, t_objectid " +
         "             FROM ddlobjcode_dbt o " +
         "            WHERE     t_bankclosedate = TO_DATE ('01010001', 'ddmmyyyy') " +
         "                  AND t_objecttype = 207 " +
         "                  AND t_codekind = 1) t " +
         "       ON p.t_dlcontrid = t.t_dlcontrid " +
         " WHERE p.T_CALC_SID = 'X' and t_setflag = CHR (88)) t on s.t_client_code = t.t_mpcode  " +
         "   WHERE  t_isblocked <> CHR (88)  " ;
     if (unload_sel)
        sql = sql + " and t.t_dlcontrid is not null ";
     end;
     if (delete_sel)
        sql = sql + " and t.t_dlcontrid is null ";
     end;
  else
    sql = " select s.t_firm_id, s.t_seccode, s.t_client_code, s.t_limit_kind, trunc(s.t_open_balance) t_open_balance, s.t_open_limit, s.t_wa_position_price, s.t_trdaccid from DDL_LIMITSECURITES_DBT s where t_isblocked <> CHR (88) " ; 
  end;

  if (marketid != -1)
    sql = sql +  " and t_market = " + string(marketid) ;
  end;

  if (cur and sec)
    /**/
  elif(cur)
   sql = sql + " and t_market_kind = 'валютный' ";
  elif(sec)
   sql = sql + " and t_market_kind != 'валютный' ";
  end;

  if (sql != "")

     sql = sql + " and t_date = " +GetSQLDate(dat) + " order by t_client_code, t_seccode, t_limit_kind, t_open_limit"; 
     dt = trsbdataset(sql);

     cnt = 1; 
     initprogress(sql_getnrecs(sql),"Выгрузка в файл", "Выгрузка в файл раздела DEPO: " + fullf);
     while (dt.movenext())
       f.WriteLine(
     "DEPO:  FIRM_ID = "+dt.firm_id+"; SECCODE = "+dt.seccode+"; CLIENT_CODE = "+dt.client_code+"; LIMIT_KIND = "+dt.limit_kind+"; OPEN_BALANCE = "+trim(string(dt.open_balance:0:0))/*int(dt.open_balance)*/+"; OPEN_LIMIT = 0; WA_POSITION_PRICE = "+string(dt.wa_position_price:0:6)+"; TRDACCID = "+dt.trdaccid+";" /*CHVA 501442*/
     /*DEPO:  FIRM_ID = MC0134700000; SECCODE = RU000A0ZZ4T1; CLIENT_CODE = 48382; LIMIT_KIND = 365; OPEN_BALANCE = 200; OPEN_LIMIT = 0; TRDACCID = L01+00000F00;*/
     );

      useprogress(cnt=cnt+1);
     end;

  remprogress;
  end;
end;
  /***********************/
sql = "";
if (fut)
  var s = TStreamDoc(fulls, "C");
   /* срочный */
    sql = " select * from DDL_LIMITFUTURMARK_DBT /*where t_market = 1*/  where  t_isblocked <> chr(88)  "+ 
//dan>          "  and upper (t_ACCOUNT) LIKE '%F502%' AND  ROUND(T_VOLUMEMN,4)<>0                            "+
          "  and upper (t_ACCOUNT) LIKE 'CLF5%' AND  ROUND(T_VOLUMEMN,4)<>0                            ";
//<dan              


     if (unload_sel)
        sql = sql + " and replace(t_account,'CL') in ( select t_mpcode from ddlcontrmp_dbt where t_dlcontrid in ( select t_dlcontrid from ddl_panelcontr_dbt where T_CALC_SID= 'X' and t_setflag = chr(88)  ) " +
                    " union all select t_code from ddlobjcode_dbt where t_codekind = 1 and t_bankclosedate = to_date('01010001','DDMMYYYY') and t_objecttype = 207 and  t_objectid in " + 
                    " (select t_dlcontrid from ddl_panelcontr_dbt where T_CALC_SID= 'X' and t_setflag = chr(88))) " ;

     end;

     if (delete_sel)
        sql = sql + " and replace(t_account,'CL') not in ( select t_mpcode from ddlcontrmp_dbt where t_dlcontrid in ( select t_dlcontrid from ddl_panelcontr_dbt where T_CALC_SID= 'X' and t_setflag = chr(88)  )) " + 
                    " and replace(t_account,'CL') not in ( select t_code from ddlobjcode_dbt where t_codekind = 1 and t_bankclosedate = to_date('01010001','DDMMYYYY') and t_objecttype = 207 and  t_objectid in " + 
                    " (select t_dlcontrid from ddl_panelcontr_dbt where T_CALC_SID= 'X' and t_setflag = chr(88))) " ;
     end;

     sql = sql + " and t_date = " +GetSQLDate(dat) + "  order by t_class_code, t_account,  t_seccode ";

    dt = trsbdataset(sql);

    cnt = 1; 
   initprogress(sql_getnrecs(sql),"Выгрузка в файл", "Выгрузка в файл раздела по срочному рынку: " + fulls);

   while (dt.movenext())
       s.WriteLine(
   // BOSS-385, замена "CLASS_CODE=SPBFUT;" на "FUT_MONEY: "
   // BOSS-1103, откат изменений по BOSS-385, обратная замена "FUT_MONEY: " на "CLASS_CODE=SPBFUT;"
   "CLASS_CODE="+dt.class_code+";FIRM_ID="+dt.firm_id+";ACCOUNT="+dt.account+";VOLUMEMN="+dt.volumemn+";VOLUMEPL="+dt.volumepl+";KFL="+trim(string(dt.kfl:15:2))+";KGO="+trim(string(dt.kgo:15:2))+";USE_KGO="+dt.use_kgo+";"// SECCODE = "+dt.seccode+";"
   );

   useprogress(cnt=cnt+1);
   end;

   remprogress;
end;

//println("Файлы выгружены: \n"+fullf +"\n" + fulls);
    msg = "Файлы выгружены";

return state;
OnError(e)
   msg = e.message;
   return 1;
end;
//сервис загрузки лимитов


//сервис загрузки корректировок лимитов
macro ws_lmtchange_to_buf( Str_Param :string ) :integer
var state :integer = 0,
    errortext :string = "",
    Params :TArray,
//    ParamProcess :TParamProcess,
//    ProcessOutTbl :c_usr_tbl_uTableProcessOut,
    StrPath :string = "",
    ErrCode;



 if( not GetParm(2, Str_Param) )
  Str_Param = "";
 end;

 //загрузили буферные таблицы из дистрибутивных
 state = execStoredFunc( "USR_PKG_IMPORT_SOFR.AddInudl_dl_lmtadjust_exch", V_INTEGER );

 if( state != 0 )
  return state;
 end;
 //загрузили буферные таблицы из дистрибутивных


//формируем файл
 Params = Null;
 Params = makeArray( SQLParam("p_Mode", 1), //формируем файл по корректировкам лимитов
                     SQLParam("p_IsDel", 1 ), //удалять ранее сформированный файл с таким именем
                     SQLParam("p_FileName", "lim_chng") );
 state = execStoredFunc( "USR_PKG_IMPORT_SOFR.AddLOBToTMP", V_INTEGER, Params );
 Params = Null;
 if( state != 0 )
  return state;
 end;


//получим значение пути выгрузки из реестра
 GetRegistryValue(REG_EXPORT_PATH, V_STRING, StrPath, ErrCode);
 if( ErrCode > 0 )
  StrPath = "..\\QUIK_EXCHNG\\out";
 end;
//получим значение пути выгрузки из реестра
// state = CreateOutputFileLMT(/*"$C:\\RsBank60"*/ StrPath );
//формируем файл

 if( state != 0 )
  return state;
 end;

 //установка статуса в ProcessOut
 //ParamProcess = Null;
 //ProcessOutTbl = Null;
 /*ParamProcess = TParamProcess( Str_Param + ";2"); //установить статусы 2
 ProcessOutTbl = c_usr_tbl_uTableProcessOut();
 ProcessOutTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
 ProcessOutTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
 ProcessOutTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
 if( not ProcessOutTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
  state = 1;
 end;
 ParamProcess = Null;
 ProcessOutTbl = Null;
 //установка статуса в ProcessOut
 */
 return state;

onError(err)
 Params = Null;
 //ParamProcess = Null;
 //ProcessOutTbl = Null;
 state = 1;
 return state;

end;
//сервис загрузки корректировок лимитов
//ws_lmt_to_buf;


macro CalcPrice_RunJob(calc_direct,id_first, id_last, forall)
    var sql = 
         " DECLARE " +
         "   cnt        NUMBER (10) := 0; " +
         "   flag       BOOLEAN := FALSE; " +
         " " +
         "   PROCEDURE RunJob (id_from IN NUMBER, id_to IN NUMBER) " +
         "   AS " +
         "      v_action    VARCHAR2 (32000); " +
         "      njob        NUMBER (5) := 1; " +
         "      check_job   NUMBER (5) := 0; " +
         "   BEGIN " +
         "      v_action := " +
         " ' BEGIN " +
         "   it_limit.set_calc_sid(''"+calc_direct+"'');  " +
         "   rshb_rsi_sclimit.SetWAPositionPrice (  p_MarketID => -1, p_id_first => '||id_from||', p_id_last => '||id_to||', p_UseListClients => ";
    if (not forAll)
      sql = sql +  " 1) ;"
    else
      sql = sql +  " 0) ;"
    end;
    sql = sql +
         "END; '; "  +
         " " +
         "     <<loop1>> " +
         "      LOOP " +
         "         BEGIN " +
         "            SELECT 1 " +
         "              INTO check_job " +
         "              FROM USER_SCHEDULER_JOBS " +
         "             WHERE job_name = UPPER ('job' || TO_CHAR (njob)); " + 
         "         EXCEPTION " +
         "            WHEN NO_DATA_FOUND " +
         "            THEN " +
         "               check_job := 0; " +
         "         END; " +
         " " +
         "         IF (check_job = 1) " +
         "         THEN " +
         "            njob := njob + 1; " +
         "            CONTINUE; " +
         "         ELSE " +
         "            BEGIN " +
         "               DBMS_SCHEDULER.drop_job ('job' || TO_CHAR (njob)); " +
         "            EXCEPTION " +
         "               WHEN OTHERS " +
         "               THEN " +
         "                  NULL; " +
         "            END; " +
         " " +
         "            EXIT loop1; " +
         "         END IF; " +
         "      END LOOP loop1; " +
         " " +
         "      DBMS_SCHEDULER.create_job (job_name => 'job' || TO_CHAR (njob), job_type => 'PLSQL_BLOCK', job_action => v_action); " +
         "      DBMS_SCHEDULER.run_job ('job' || TO_CHAR (njob), FALSE); " +
//                 "      --EXECUTE IMMEDIATE v_action; " +
         "      njob := njob + 1; " +
         "   END; " +
         " BEGIN " +
         "   RunJob (:id_first, :id_last); " +
         "END; " ;
   var cmd = RsdCommand(sql);
   cmd.addParam("", RSDBP_IN, id_first);
   cmd.addParam("", RSDBP_IN, id_last);
   cmd.Execute();


end;

