/*
acc_trn.mac
Отчет для контроля валютных проводок
GAA:505753,27.02.2020. исключить из отчета проводки курсовых разниц (в корреспонденции со счетами 70603/70608)
GAA: 505753, 28.02.2020. Добавлено возможность формирования отчета в разрезе подсистем
*/

import rsd;
import "DLReport_h.mac", "dlreport.mac", "dlQuery.mac", "scsrvrepfun.mac", "sc_inacc.mac";
import "dpstdrep.mac", "dl_util_xml_obj.mac";
import RsbFormsInter;
var v_fissico = 0, v_bocb = 0, v_mbc = 0, v_sv = 0, v_all = 1;

private class ReportParams()
    var dateBegin:date/*,
        dateEnd:date,
        clientid:integer,
        sfcontrid:integer, 
        dlcontrid:integer,
        account:string*/;
end;

private class CBrokerAccStatement_Report(_params)
    PRIVATE VAR m_rep:T_XML_Rep;
    PRIVATE VAR m_params = _params;
 //   private const V_SQLUNDEF = 26;/*GAA: 494483*/

    var CreateOnTerm = (not isStandAlone());

    macro getClientFIO()
        return "";
    end;
   
    macro PrintAccTrnData()
        var query = 
     " SELECT q.* FROM (SELECT "
     +"  (SELECT 1 FROM ddlgrdoc_dbt WHERE t_DocKind = 1 AND t_DocID = acctr.T_ACCTRNID) SO_BOCB, "
     +"  (SELECT oprstep.T_DOCKIND FROM doprstep_dbt oprstep JOIN doprdocs_dbt oprdocs ON oprdocs.T_ID_OPERATION = oprstep.T_ID_OPERATION AND oprdocs.T_ID_STEP = oprstep.T_ID_STEP "
     +"  WHERE oprdocs.t_acctrnid = acctr.T_ACCTRNID) DOCKIND, "
     +"  acctr.DAT, "
     +"  acctr.numb, "
     +"  acctr.ACC_PAY debet,"
     +"  acctr.ACC_REC credit,"
     +"  acctr.val cur,"
     +"  acctr.Sum_Val Sum_Cur,"
     +"  acctr.rate_date_No_round Rate_acctr,"
     +"  acctr.sum_natcur sum_natcur_SOFR,"
     +"  acctr.rate_CBRF rate_CB,"
     +"  (acctr.Sum_Val * acctr.rate_CBRF) sum_natcur_CB,"
     +"  ROUND (acctr.Sum_Val * acctr.rate_CBRF, 2) sum_natcur_CB_Round,"
     +"  (CASE"
     +"      WHEN acctr.rate_date_No_round = acctr.rate_CBRF"
     +"      THEN"
     +"         CASE"
     +"            WHEN acctr.sum_natcur ="
     +"                    ROUND (acctr.Sum_Val * acctr.rate_CBRF, 2)"
     +"            THEN"
     +"               'Расхождений нет'"
     +"            WHEN acctr.sum_natcur !="
     +"                    ROUND (acctr.Sum_Val * acctr.rate_CBRF, 2)"
     +"            THEN"
     +" 'Имеются расхождения. Курс проводки равен курсу ЦБ, но сумма проводки в рублях отличается от суммы проводки по курсу ЦБ( ошибка округления СОФР)'"
     +"         END"
     +"      WHEN acctr.rate_date_No_round = acctr.rate_CBRF_1"
     +"      THEN"
     +"         CASE"
     +"            WHEN acctr.sum_natcur ="
     +"                    ROUND (acctr.Sum_Val * acctr.rate_CBRF_1, 2)"
     +"            THEN"
     +" 'Имеются расхождения. Курс проводки равен курсу ЦБ за предыдущий день'"
     +"            WHEN acctr.sum_natcur !="
     +"                    ROUND (acctr.Sum_Val * acctr.rate_CBRF, 2)"
     +"            THEN"
     +" 'Имеются расхождения. Курс проводки равен курсу ЦБ за предыдущий день, но суммы проводки в рублях отличается от суммы проводки по курсу ЦБ за предыдущий день(ошибка округления СОФР)'"
     +"         END"
     +"      WHEN ( (acctr.rate_date_No_round != acctr.rate_CBRF)"
     +"            AND (acctr.sum_natcur ="
     +"                    ROUND (acctr.Sum_Val * acctr.rate_CBRF, 2)))"
     +"      THEN"
     +"         'Имеются незначительные расхождения. Курс проводки не равен курсу ЦБ, но сумма проводки в рублях равна сумме проводки по курсу ЦБ'"
     +"      ELSE"
     +"         CASE"
     +"            WHEN acctr.T_SKIPRECALCSUMNATCUR = CHR (88)"
     +"            THEN"
     +"               'Курс проводки не совпадает с курсом ЦБ РФ. НО на проводке установлена отметка <Не пересчитывать> '"
     +"            ELSE"
     +"               'Имеются расхожения. Курс проводки не совпадает с курсом ЦБ РФ'"
     +"         END"
     +"   END)"
     +"     rezult,"
     +"  acctr.T_GROUND"
     +"  FROM (SELECT TRN.T_DATE_CARRY DAT,"
     +"          trn.T_ACCTRNID, "
     +"          TRN.T_NUMB_DOCUMENT NUMB,"
     +"          TRN.T_ACCOUNT_PAYER ACC_PAY,"
     +"          TRN.T_FIID_PAYER FIID_PAY,"
     +"          TRN.T_SUM_PAYER SUM_PAY,"
     +"          TRN.T_ACCOUNT_RECEIVER ACC_REC,"
     +"          TRN.T_FIID_RECEIVER FIID_REC,"
     +"          TRN.T_SUM_RECEIVER SUM_REC,"
     +"          CASE"
     +"             WHEN TRN.T_FIID_PAYER = 0"
     +"             THEN"
     +"                (SELECT fi.t_ccy"
     +"                   FROM dfininstr_dbt fi"
     +"                  WHERE FI.T_FIID = TRN.T_FIID_RECEIVER)"
     +"             WHEN TRN.T_FIID_RECEIVER = 0"
     +"             THEN"
     +"                (SELECT fi.t_ccy"
     +"                   FROM dfininstr_dbt fi"
     +"                  WHERE FI.T_FIID = TRN.T_FIID_PAYER)"
     +"          END"
     +"             Val,"
     +"          CASE"
     +"             WHEN TRN.T_FIID_PAYER = 0 THEN TRN.T_SUM_RECEIVER"
     +"             WHEN TRN.T_FIID_RECEIVER = 0 THEN TRN.T_SUM_PAYER"
     +"          END"
     +"             Sum_Val,"
     +"          TRN.T_SUM_NATCUR SUM_NAT,"
     +"          TRN.T_RATE,"
     +"          TRN.T_POINT,"
     +"          TRN.T_RATE"
     +"          / (POWER (10, TRN.T_POINT) * GREATEST (1, TRN.T_SCALE))"
     +"             rate_date_No_round,"
     +"          RATEHIST.T_RATE"
     +"          / (POWER (10, RATEHIST.T_POINT)"
     +"             * GREATEST (1, RATEHIST.T_SCALE))"
     +"             rate_CBRF,"
     +"          CASE"
     +"             WHEN (TRN.T_FIID_PAYER != 0)"
     +"             THEN"
     +"                TRN.T_SUM_PAYER * RATEHIST.T_RATE"
     +"                / (POWER (10, RATEHIST.T_POINT)"
     +"                   * GREATEST (1, RATEHIST.T_SCALE))"
     +"             WHEN TRN.T_FIID_PAYER = 0"
     +"             THEN"
     +"                TRN.T_SUM_RECEIVER * RATEHIST.T_RATE"
     +"                / (POWER (10, RATEHIST.T_POINT)"
     +"                   * GREATEST (1, RATEHIST.T_SCALE))"
     +"             ELSE"
     +"                0"
     +"          END"
     +"             Sum_NAT,"
     +"          CASE"
     +"             WHEN TRN.T_FIID_PAYER != 0"
     +"             THEN"
     +"                ROUND ("
     +"                   TRN.T_SUM_PAYER * RATEHIST.T_RATE"
     +"                   / (POWER (10, RATEHIST.T_POINT)"
     +"                      * GREATEST (1, RATEHIST.T_SCALE)),"
     +"                   2)"
     +"             WHEN TRN.T_FIID_RECEIVER != 0"
     +"             THEN"
     +"                ROUND ("
     +"                   TRN.T_SUM_RECEIVER * RATEHIST.T_RATE"
     +"                   / (POWER (10, RATEHIST.T_POINT)"
     +"                      * GREATEST (1, RATEHIST.T_SCALE)),"
     +"                   2)"
     +"             ELSE"
     +"                0"
     +"          END"
     +"             Sum_NAT_koop,"
     +"          TRN.T_SUM_NATCUR sum_natcur,"
     +"          - (CASE"
     +"                WHEN TRN.T_FIID_PAYER != 0"
     +"                THEN"
     +"                   ROUND ("
     +"                      TRN.T_SUM_PAYER * RATEHIST.T_RATE"
     +"                      / (POWER (10, RATEHIST.T_POINT)"
     +"                         * GREATEST (1, RATEHIST.T_SCALE)),"
     +"                      2)"
     +"                WHEN TRN.T_FIID_RECEIVER != 0"
     +"                THEN"
     +"                   ROUND ("
     +"                      TRN.T_SUM_RECEIVER * RATEHIST.T_RATE"
     +"                      / (POWER (10, RATEHIST.T_POINT)"
     +"                         * GREATEST (1, RATEHIST.T_SCALE)),"
     +"                      2)"
     +"                ELSE"
     +"                   0"
     +"             END)"
     +"             Rez,"
     +"          TRN.T_GROUND,"
     +"          TRN.T_SKIPRECALCSUMNATCUR,"
     +"          (SELECT RATEHIST1.T_RATE"
     +"                  / (POWER (10, RATEHIST1.T_POINT)"
     +"                     * GREATEST (1, RATEHIST1.T_SCALE))"
     +"             FROM dratedef_dbt rate1, dratehist_dbt ratehist1"
     +"            WHERE RATE1.T_OTHERFI ="
     +"                     (CASE"
     +"                         WHEN TRN.T_FIID_PAYER = 0"
     +"                         THEN"
     +"                            TRN.T_FIID_RECEIVER"
     +"                         WHEN TRN.T_FIID_RECEIVER = 0"
     +"                         THEN"
     +"                            TRN.T_FIID_PAYER"
     +"                      END)"
     +"                  AND RATE1.T_ISDOMINANT = 'X'"
     +"                  AND RATE1.T_TYPE = 7                      " //Курс ЦБ РФ
     +"                  AND RATEHIST1.T_RATEID = RATE1.T_RATEID"
     +"                  AND RATEHIST1.T_SINCEDATE = :dateBegin)"
//     +"                         (TO_DATE ('20.09.2019', 'dd.mm.yyyy') - 1))"
     +"             rate_CBRF_1"
     +"     FROM dacctrn_dbt trn, dratedef_dbt rate, dratehist_dbt ratehist"
     +"    WHERE TRN.T_DATE_CARRY = :dateBegin "//TO_DATE ('20.09.2019', 'dd.mm.yyyy')
     +"          AND TRN.T_CHAPTER = 1"
     +"          AND ( (TRN.T_FIID_PAYER != 0 AND TRN.T_FIID_RECEIVER = 0)"
     +"               OR (TRN.T_FIID_PAYER = 0 AND TRN.T_FIID_RECEIVER != 0)"
     +"               OR ( (TRN.T_FIID_PAYER != 0 AND TRN.T_FIID_RECEIVER != 0)))"
     +"          AND (TRN.T_SUM_PAYER != 0 OR TRN.T_SUM_RECEIVER != 0)"
     +"          AND RATE.T_OTHERFI ="
     +"                 (CASE"
     +"                     WHEN TRN.T_FIID_PAYER = 0 THEN TRN.T_FIID_RECEIVER"
     +"                     WHEN TRN.T_FIID_RECEIVER = 0 THEN TRN.T_FIID_PAYER"
     +"                  END)"
     +"          AND RATE.T_ISDOMINANT = 'X'"
     +"          AND RATE.T_TYPE = 7                              "//  Курс ЦБ РФ
     +"          AND RATEHIST.T_RATEID = RATE.T_RATEID"
     +"          AND RATEHIST.T_SINCEDATE = :dateBegin"
//GAA: 505753, исклчение проводок курсовых разниц (в корреспонденции со счетами 70603/70608)
     +"          AND (    (INSTR (TRN.T_ACCOUNT_PAYER, '70603') = 0) "
     +"               AND (INSTR (TRN.T_ACCOUNT_PAYER, '70608') = 0)) "
     +"          AND (    (INSTR (TRN.T_ACCOUNT_RECEIVER, '70603') = 0) "
     +"               AND (INSTR (TRN.T_ACCOUNT_RECEIVER, '70608') = 0)) "
//     +"                 TO_DATE ('20.09.2019', 'dd.mm.yyyy')"
//     +"          AND TRN.T_ACCTRNID NOT IN "//Исклоючил валютные проводки, у которых сумма по дебету или кредиту нулевая 
//     +"                 (SELECT TRN1.T_ACCTRNID"
//     +"                    FROM dacctrn_dbt trn1"
//     +"                   WHERE TRN1.T_DATE_CARRY = :dateBegin"
//     +"                            TO_DATE ('20.09.2019', 'dd.mm.yyyy')"
//     +"                         AND ( (TRN1.T_FIID_PAYER != 0"
//     +"                                AND TRN1.T_FIID_RECEIVER = 0)"
//     +"                              OR (TRN1.T_FIID_PAYER = 0"
//     +"                                  AND TRN1.T_FIID_RECEIVER != 0))"
//     +"                         AND ( (TRN1.T_SUM_PAYER != 0"
//     +"                                AND TRN1.T_SUM_RECEIVER = 0)"
//     +"                              OR (TRN1.T_SUM_PAYER = 0"
//     +"                                  AND TRN1.T_SUM_RECEIVER != 0)))
     +"                                                                   ) acctr ) q";
       if ((v_all == 1) or ((v_bocb  == 1) and (v_fissico == 1) and (v_mbc == 1) and (v_sv == 1)))
       else
         if ((v_bocb  == 1) or (v_fissico == 1) or (v_mbc == 1) or (v_sv == 1))
            query = query + " WHERE q.NUMB != '' "; 
           if (v_bocb  == 1)
              query = query + " or q.SO_BOCB = 1 OR q.DOCKIND IN (5, 4607)"; 
           end;
           if (v_fissico == 1)
              query = query + " or q.DOCKIND IN (140, 199, 4813)"; 
           end;
           if (v_mbc == 1)
              query = query + " or q.DOCKIND IN (102)";
           end;
           if (v_sv == 1)
              query = query + " or q.DOCKIND IN (110)";
           end;
         end;
       end; 

        var cmd = DL_RSDCommand(query);
            cmd.AddParam(m_params.dateBegin);
            cmd.AddParam(m_params.dateBegin);
            cmd.AddParam(m_params.dateBegin);
            cmd.AddParam(m_params.dateBegin); 
        var DataSet = cmd.Execute();

        var cnt = cmd.GetCount();

        if(cnt)
            var AccTrnData = cmd.Execute();

            while(AccTrnData.movenext)
            
                m_rep.Put_Val(AccTrnData.DAT, "START;BRL;BRR;WT;HA=C;VA=C;T=D;BRB;");
                m_rep.Put_Val(AccTrnData.numb, "BRL;BRR;WT;HA=C;VA=C;BRB;");                 
                m_rep.Put_Val(AccTrnData.debet, "BRL;BRR;WT;HA=C;VA=C;BRB;");
                m_rep.Put_Val(AccTrnData.credit, "BRL;BRR;WT;HA=C;VA=C;BRB;");
                m_rep.Put_Val(AccTrnData.cur, "BRL;BRR;WT;HA=C;VA=C;BRB;");
                m_rep.Put_Val(AccTrnData.Sum_Cur, "BRL;BRR;WT;HA=C;VA=C;T=M2;BRB;");
                m_rep.Put_Val(AccTrnData.Rate_acctr, "BRL;BRR;WT;HA=C;VA=C;T=N6;BRB;");
                m_rep.Put_Val(AccTrnData.sum_natcur_SOFR, "BRL;BRR;WT;HA=C;VA=C;T=M2;BRB;");                                                
                m_rep.Put_Val(AccTrnData.rate_CB, "BRL;BRR;WT;HA=C;VA=C;T=N5;BRB;");
                m_rep.Put_Val(AccTrnData.sum_natcur_CB, "BRL;BRR;WT;HA=C;VA=C;T=M2;BRB;");
  //              m_rep.Put_Val(AccTrnData.sum_natcur_CB_Round, "BRL;BRR;WT;HA=C;VA=C;T=M2;"); 
                m_rep.Put_Val(AccTrnData.rezult, "BRL;BRR;WT;HA=C;VA=C;BRB;");
                m_rep.Put_Val(AccTrnData.T_GROUND, "BRL;BRR;WT;HA=L;VA=C;END;BRB;");

            end;
        end;
    end;

/***********************************/  
    PRIVATE MACRO GetTxtPath()
        var RegistryPath = "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR";
        var Path = "";
        var stat = 0;
 
        GetRegistryValue(RegistryPath, V_STRING, Path, stat);
        if(stat) 
            msgbox("Не задана настрйка в реестре банка:|", RegistryPath);      
        end;

        return Path;
    END;

    PRIVATE MACRO processPath( p_path )
        var l_str, l_p, l_path = "";

        p_path = trim( p_path );

        if( substr( p_path, 1, 2 ) == ".." ) /*Ссылка на вышестоящий каталог */
            p_path = substr( p_path, 3 );

            l_str  = getCWD(false);    
            l_p    = strbrk( l_str, "\\" );
            while( l_p != 0 )
                 l_path = l_path + substr( l_str, 1, l_p - 1 ) + "\\";
                 l_str  = substr( l_str, l_p + 1 );
                 l_p    = strbrk( l_str, "\\" );
            end;
            return ( substr( l_path, 1, strlen( l_path ) - 1 ) + p_path );

        elif( substr( p_path, 1, 1 ) == "." ) /* Ссылка на текущий каталог */
            return ( getCWD + substr( p_path, 2 ) );
        end;

        return p_path;
    END;
    MACRO GetRepFullPath(isRemote:bool)
        var Path = "";

        if(isRemote)
            var txtPath = GetTxtPath();

            if( substr( txtPath, 1, 2 ) == ".." ) /*ссылка на вышестоящий каталог */
                txtPath = substr(txtPath, 3 );
            end;

            if( substr( txtPath, 1, 1 ) == "\\" ) /*ссылка на вышестоящий каталог*/
                txtPath = substr(txtPath, 2 );
            end;

            Path = GetCurDir(true) + "\\" + txtPath + "\\"; 
        else
            Path = processPath(GetTxtPath()) + "\\";
        end;

        // получить полный путь
        return Path;
    END;
/***********************************/  
  
    macro run()
        m_rep.Init("utf8", true);

        m_rep.Set_Column_Width(/* 1*/  50,
                               /* 2*/  50,
                               /* 3*/  100,
                               /* 4*/  100,
                               /* 5*/  35,
                               /* 6*/  45,
                               /* 7*/  70,
                               /* 8*/  45,
                               /* 9*/  70,
                               /*10*/  45,
                               /*11*/  170,
                               /*12*/  100);

        m_rep.Set_Landscape();
        m_rep.Set_Indent(0);

        m_rep.Print_Header("Валютные проводки за "+DL_DateToStr(m_params.dateBegin), "Calibri", 9);

        m_Rep.Set_WrapText(0);
        m_rep.Put_Str("ВАЛЮТНЫЕ ПРОВОДКИ ЗА "+DL_DateToStr(m_params.dateBegin), "START;R=11;HA=C;END;");
        m_rep.Blank_Line();
        m_rep.Blank_Line();
        m_rep.Put_Val("Дата проводки",                           "START;BOR;WT;HA=C;VA=C;");
        m_rep.Put_Val("№ проводки",                              "BOR;WT;HA=C;VA=C;");
        m_rep.Put_Val("Дебет",                                   "BOR;WT;HA=C;VA=C;");
        m_rep.Put_Val("Кредит",                                  "BOR;WT;HA=C;VA=C;");
        m_rep.Put_Val("Валюта",                                  "BOR;WT;HA=C;VA=C;");
        m_rep.Put_Val("Сумма проводки в валюте",                 "BOR;WT;HA=C;VA=C;");
        m_rep.Put_Val("Курс в проводке",                         "BOR;WT;HA=C;VA=C;");
        m_rep.Put_Val("Сумма проводки в рублях (в СОФТ)",        "BOR;WT;HA=C;VA=C;");
        m_rep.Put_Val("Курс ЦБ РФ",                              "BOR;WT;HA=C;VA=C;");        
        m_rep.Put_Val("Сумма проводки в рублях по курсу ЦБ РФ",  "BOR;WT;HA=C;VA=C;");  
        m_rep.Put_Val("Результат",                               "BOR;WT;HA=C;VA=C;");                 
        m_rep.Put_Val("Комментарий проводки",                    "BOR;WT;HA=C;VA=C;END;");

        PrintAccTrnData();

        m_Rep.Set_WrapText(1);
        m_rep.Blank_Line();


        m_rep.Put_Str("АО \"РОССЕЛЬХОЗБАНК\"",    "START;R=3;HA=L;END;");

        m_rep.Print_Bottom();
     
        var m_CurrentRepName = "ACCTRN_REPORT";
/*GAA: добавил постфикс к наименованию отчета в зависимости от подсистемы*/
        if ((v_all == 1) or ((v_bocb  == 1) and (v_fissico == 1) and (v_mbc == 1) and (v_sv == 1)))
           m_CurrentRepName = m_CurrentRepName+"_ALL";           
        else
           if (v_bocb  == 1)
             m_CurrentRepName = m_CurrentRepName+"_BOCB";
           end;
           if (v_fissico == 1)
             m_CurrentRepName = m_CurrentRepName+"_FISSiCO";
           end;
           if (v_mbc == 1)
             m_CurrentRepName = m_CurrentRepName+"_MBC";
           end;
           if (v_sv == 1)
             m_CurrentRepName = m_CurrentRepName+"_SV";
           end;
        end;

        var FullPath = GetRepFullPath(CreateOnTerm);
        var xmlNameFile = FullPath + string(m_CurrentRepName+".xml");
        var ShowFilePath = IIF(CreateOnTerm, "$", "") + FullPath;

        m_rep.Move(IIF(CreateOnTerm, "$", "") + xmlNameFile);


        var  resultFileName = m_CurrentRepName + ".xls";

        var  err = SC_ConvertToFormat(xmlNameFile, FullPath+resultFileName, SC_SRVREPFORMAT_EXCEL_XLSX, false);

        if(not err)
            SC_ShowFile(ShowFilePath, resultFileName);
        end;

        m_rep.Delete();

    end;
end;

private const FT_STRING = 7;
private const FT_DATE = 9;

macro accounts_event(rs, cmd, id, key)
    if(cmd == DLG_KEY)
        if(key == 13)
            return CM_SELECT;
        end;
    end;
end;

class (TRsbPanel) MyRsbPanel1
    InitTRsbPanel();
    Caption = "Валютные проводки"; 
    Status  = "~ESC~Выход  ~F2~Выполнить  ~F3~Выбор ";
    setSize(30,10);
    setPosition(35,15);

    var currentRS;

    addLabel(TRsbLabel(3, 2, "Дата:"));
    var m_DateBegin:TRsbEditField = TRsbEditField(FT_DATE);
    m_DateBegin.setPosition(10,2);
    m_DateBegin.setSize(10,1);
    m_DateBegin.value = {curdate};
    m_DateBegin.addEventHandler(RSB_EV_KEY_PRESSED , R2M(this, "DATEBEGIN_KEY_PRESSED"));
    addControl(m_DateBegin);
    
    addEventHandler(RSB_EV_KEY_PRESSED , R2M(this, "Panel_ButtonEvent"));


var fissico, bocb, mbc, sv, all;
//var v_fissico = 0, v_bocb = 0, v_mbc = 0, v_sv = 0, v_all = 1;

bocb = TRsbCheckbox;
bocb.setPosition(3,4);
bocb.name = "БОЦБ"; 
addControl(bocb);
var m_Label1:TrsbLabel = TRsbLabel(8,4,"БОЦБ");
addLabel (m_Label1);

fissico = TRsbCheckbox;
fissico.setPosition(3,5);
fissico.name = "ФИССиКО";
addControl(fissico);
var m_Label2:TrsbLabel = TRsbLabel(8,5,"ФИССиКО" );
addLabel (m_Label2);

mbc = TRsbCheckbox;
mbc.setPosition(3,6);
mbc.name = "МБК"; 
addControl(mbc);
var m_Label3:TrsbLabel = TRsbLabel(8,6,"МБК");
addLabel (m_Label3);

sv = TRsbCheckbox;
sv.setPosition(3,7);
sv.name = "СВ"; 
addControl(sv);
var m_Label4:TrsbLabel = TRsbLabel(8,7,"СВ");
addLabel (m_Label4);

all = TRsbCheckbox;
all.setPosition(3,8);                                                                      	
all.name = "По всем подсистемам";
all.checked = True; 
addControl(all);
var m_Label5:TrsbLabel = TRsbLabel(8,8,"По всем подсистемам");
addLabel (m_Label5);

addEventHandler(RSB_EV_KEY_PRESSED, R2M(this, "onKeyPressed"));

macro OnChecked(RsbEvent:Object)
   if (RsbEvent.id == RSB_EV_CONTROL_CHECKED)
   end;
return true;
end;

macro onKeyPressed(ev)
   if (ev.keycode == 316)
      if (bocb.checked)
         v_bocb = 1;
      else
         v_bocb = 0;
      end;
      if (fissico.checked)
         v_fissico = 1;
      else
         v_fissico = 0;
      end;
      if (mbc.checked)
         v_mbc = 1;
      else
         v_mbc = 0;
      end;
      if (sv.checked)
         v_sv = 1;
      else
         v_sv = 0;
      end; 
      if (all.checked)
         v_all = 1;
      else
         v_all = 0;
      end;

   else
      exit(1);
   end;
end;


    PRIVATE MACRO AddCol (ar,ind, fld, head, width, rdonly, ty, dp)
        ar.value (ind * 6)     = fld;
        ar.value (ind * 6 + 1) = head;
        ar.value (ind * 6 + 2) = width;
        ar.value (ind * 6 + 3 ) = rdonly;   // fldType
        ar.value (ind * 6 + 4 ) = dp;//   decPoint
        ar.value (ind * 6 + 5 ) = 0;   // reserv
    END;

    macro Panel_ButtonEvent(RsbEvent)
       if(RsbEvent.keyCode == 316)
           var RepParams = ReportParams();

           RepParams.dateBegin = m_DateBegin.value;

           CBrokerAccStatement_Report(RepParams).run();
       end;
    end;

    macro DATEBEGIN_KEY_PRESSED(RsbEvent)
       if(RsbEvent.keyCode == 317)
           m_DateBegin.value = GetDateByCalendar(m_DateBegin.value);
       end;
    end;
    
end;

var panel = MyRsbPanel1;
panel.run;
