import spserv, secinter, dlquery, sp_cars, "or_rep_h.mac";

import "buyrepo_Form.mac";

PRIVATE VAR buyrepo_Form;


private macro СвойЛотБылПроданПРЕПО(SumID:integer, //Лот продаже 2ч ОРЕПО
                                    IsAfter:bool //true, если 2ч ПРЕПО исполняется после 2ч ОРЕПО, false, если не позже
                                   )
  var cmd, query;
  
  query =   " SELECT 1 "
          + "   FROM DPMWRTLNK_DBT Lnk, DPMWRTSUM_DBT Sale2, DPMWRTSUM_DBT Sale "
          + "  WHERE Sale2.t_SumID = ? "
          + "    AND Lnk.t_BuyID = Sale2.t_Parent "
          + "    AND Sale.t_SumID = Lnk.t_SaleID "
          + "    AND Sale.t_Source = 0 ";

  if(IsAfter)
    query = query + "    AND Sale2.t_Date < NVL((SELECT MIN(Buy2.t_Date) FROM DPMWRTSUM_DBT Buy2 WHERE Buy2.t_Parent = Lnk.t_SaleID), "+GetSQLDate(date(0,0,0))+")";
  else
    query = query + "    AND Sale2.t_Date >= (SELECT MIN(Buy2.t_Date) FROM DPMWRTSUM_DBT Buy2 WHERE Buy2.t_Parent = Lnk.t_SaleID)";
  end;

  cmd = DL_RSDCommand(query);
  cmd.AddParam(SumID);

  if(cmd.GetCount() > 0)
    return true;
  end;
    
  return false;
end;

private class SummFR( _Portofolio:integer )
  var Portofolio:integer = _Portofolio;
  var Amount:money = 0;
  var CostSum:money = 0;
  var InterestIncomeSum:money = 0;
  var DiscountIncomeSum:money = 0;
  var OverAmountBuy:money = 0;
  var CorrSum:money = 0;
  var ReservSum:money = 0;
  var BalanceCostBD:money = 0;
end;

private macro AddCostSummFR( SummFRArr:TArray, Portofolio:integer, CostSum:money )
  var i = 0;

  while( i < SummFRArr.Size )
     if( SummFRArr[i].Portofolio == Portofolio )
        SummFRArr[i].CostSum = SummFRArr[i].CostSum + CostSum;
     end;
     i = i + 1;
  end;
end;

private macro DecAmountSummFR( SummFRArr:TArray, Portofolio:integer, Amount:money )
  var i = 0;
  while( i < SummFRArr.Size )
     if( SummFRArr[i].Portofolio == Portofolio )
        SummFRArr[i].Amount = SummFRArr[i].Amount - Amount;
     end;
     i = i + 1;
  end;
end;

/*Списание резерва по вложениям в ц/б по продаваемым лотам*/
PRIVATE MACRO СписаниеРезерваПоЦБ( FD:OBJECT/*SPFirstDoc*/, dat:DATE, KindPortf:INTEGER, ReservAmountBuy:MONEY, IncomeReservBuy:MONEY, EstReserveBuy:MONEY , SumReservInFR:@MONEY):BOOL
  VAR ReservAcc = TRecHandler( "account" );  /*счет резерва*/
  VAR FIRole = null, FIRolePDD = null;
  VAR CodePC:string, RolePC:integer;
  var ErrCode, OptionValue:bool;
  var CatDeb, CatCred, CatCorr;
  var CheckResSum = $0;
  var SumResFR = $0;
  var IsBond = false;

  GetRegistryValue( "SECUR\\МСФО\\61210 ПРИ ВЫБЫТИИ ДЛЯ РВП И ОР", V_BOOL, OptionValue, ErrCode );
  if ( (ErrCode != 0) or IsRET_ISSUE(FD.Group) )
     OptionValue = false;
  end;

  if( (KindPortf == KINDPORT_SALE) and ( FI_IsAvrKindBond(FD.fininstr.rec.AvoirKind)))  
    OptionValue = false;    // долговая бумага в СССД не должна идти на реализацию    
    IsBond = true;
  end;

  if( not (IsBasket(FD.Group) and IsOUTEXCHANGE(FD.Group)) )
        ПолучитьРолиДляСписаниеРезерваПоЦБ(KindPortf,@FIRole,@FIRolePDD,@CodePC,@RolePC, IsBond);
     if( (ReservAmountBuy != 0) OR (IncomeReservBuy != 0) )

        
        SumResFR = SumResFR - IIF(OptionValue,  ReservAmountBuy + IncomeReservBuy, 0); 

        if( (KindPortf == KINDPORT_SALE) and (not FI_IsAvrKindBond(FD.fininstr.rec.AvoirKind)) ) /* не долговые, долевые*/
          
          SumResFR = SumResFR + IIF(OptionValue,  ReservAmountBuy , 0); //если сюда зашли, значит на реализацию зачислили и тут же списали 
        end;

     end;

     var isReserv = true;
     if ( (KindPortf == KINDPORT_PROMISSORY) or (KindPortf == KINDPORT_RETIRE) or (KindPortf == KINDPORT_CONTR) or ( (KindPortf == KINDPORT_SALE) and ( FI_IsAvrKindBond(FD.fininstr.rec.AvoirKind))) )

        if(EstReserveBuy != 0)
          CatCorr = IIF (((KindPortf == KINDPORT_PROMISSORY) or (KindPortf == KINDPORT_CONTR)), "КОР_РС, д/с", "КорОР_ЦБ");
          if( FD.IsExistAccount( "-Кор_Резерв, ЦБ", null, true, null, ReservAcc, MC_PAIRACCMODE_MANUAL, dat, NATCUR ) )
             CheckResSum = money(GetRestAccount(ReservAcc.rec, dat) );
             if ( CheckResSum != 0 )
                CatDeb  = "-Кор_Резерв, ЦБ";
                CatCred = IIF(OptionValue == false, "+"+CatCorr, "Реализация, ц/б");
                FIRole = GetFIRoleByPortfolio(KindPortf);
                RolePC = IIF (CatCred == "+КорОР_ЦБ", GetFIRoleByPortfolio(KindPortf), null);
             else
               isReserv = false;
             end;

             if( isReserv )
                
                SumResFR = SumResFR - ABS(IIF(OptionValue,  EstReserveBuy, 0));   // минус резерв
             end;
          end;

          isReserv = true;
          CheckResSum = 0;
          if( FD.IsExistAccount( "+Кор_Резерв, ЦБ", null, true, null, ReservAcc, MC_PAIRACCMODE_MANUAL, dat, NATCUR ) )
             CheckResSum = money(GetRestAccount(ReservAcc.rec, dat) );
             if (CheckResSum != 0)
                CatCred  = "+Кор_Резерв, ЦБ";
                CatDeb = IIF(OptionValue == false, "-"+CatCorr, "Реализация, ц/б");
                RolePC = GetFIRoleByPortfolio(KindPortf);
                FIRole = IIF (CatCred == "-КорОР_ЦБ", GetFIRoleByPortfolio(KindPortf), null);
             else
               isReserv = false;
             end;

             if( isReserv )
                
                SumResFR = SumResFR + ABS(IIF(OptionValue,  EstReserveBuy, 0));     // плюс резерв
             end;
          end;
        end;
     end;
  end;
  if( SumReservInFR != NULL )
     SumReservInFR = SumResFR;
  end;
  return true;
END;


PRIVATE MACRO GetSumFR( FD:SPFirstDoc, CarDate:DATE, Portfolio ):MONEY
   var PmWrtSum = Trechandler( "pmwrtsum.dbt" );
   VAR i = 0, Groups = TArray(),
       AccCredit, FIIDCredit, AccDebet, FIIDDebet,
       FR = $0, CommSum = $0, CommSumFIID;
   VAR RSD, SQLQuery, FD_buy, RatePVO, FIRole;
   VAR DebCat, CredCat, DebCatBD, CarFIID, CarFIID2, CarSumm, CarSumm_od = $0, Capter, CarSummBD, TotalCost = $0, 
       Amount = $0, PreoutlayNotPVO, DVSSCost = $0, ForRestAcc = 0, WrtCostSum, RestoreSumm_od = $0, CarSummBD_Natcur = $0;
   var NeedThisTrnAcc = true;
   var SummFRArr = TArray();
   var query, DataSet;

   VAR ALL_CostBuy             = $0, CostBuy             = $0, /* Списанная чистая стоимость (Счист) */
       ALL_BalanceCostBuy      = $0, BalanceCostBuy      = $0, /* Списанная текущая стоимость */
       ALL_NKDBuy              = $0, NKDBuy              = $0, /* НКД ( S(НКД упл.)) */
       ALL_InterestIncomeBuy   = $0, InterestIncomeBuy   = $0, /* Списанный начисленный ПД */
       ALL_DiscountIncomeBuy   = $0, DiscountIncomeBuy   = $0, /* Cписанный начисленный ДД */
       ALL_NotCarryInterestBuy = $0, NotCarryInterestBuy = $0, /* Списанный не отнесенный на доходы ПД */
       ALL_NotCarryDiscountBuy = $0, NotCarryDiscountBuy = $0, /* Списанный не отнесенный на доходы ДД */
       ALL_InterestIncomeAdd   = $0, InterestIncomeAdd   = $0, /* Доначисленный ПД S(Sдонач.ПДi) */
       ALL_DiscountIncomeAdd   = $0, DiscountIncomeAdd   = $0, /* Доначисленный ДД S(Sдонач.ДДi) */
       ALL_NotCarryInterestAdd = $0, NotCarryInterestAdd = $0, /* Доначисленный не отнесенный на доходы ПД */
       ALL_NotCarryDiscountAdd = $0, NotCarryDiscountAdd = $0, /* Доначисленный не отнесенный на доходы ДД */
                                     InterestIncomeSum   = $0, /* Суммарный начисленный ПД S(ПДначисл) */
                                     DiscountIncomeSum   = $0, /* Суммарный начисленный ДД S(ДДначисл) */
                                     NotCarryInterestSum = $0, /* Суммарный не отнесенный на доходы ПД  S(ПДне_отн) */
                                     NotCarryDiscountSum = $0, /* Суммарный не отнесенный на доходы ДД  S(ДДне_отн) */
       ALL_BalanceCostSum      = $0, BalanceCostSum      = $0, /* Суммарная текущая стоимость (Стек) */
       ALL_BalanceCostBD       = $0,                           /* Списанная стоимость в ОД (Часть остатка счета "- ОД", пропорциональная количеству ц/б, проданно-му из ТП и ППР) */
       ALL_OutlayBuy           = $0, OutlayBuy           = $0, /* Списанные затраты */
       OverAmountSum           = $0, OverAmountBuy       = $0, /* Списанная сумма переоценки S(ПО) */
       ReservAmountBuy         = $0,                           /* Списанная сумма резерва (Сумма созданного резерва) */
       ALL_AmountNotPVO        = $0, ALL_Amount          = $0,
       IncomeReservBuy         = $0,
       BonusAdd                = $0, NotWrtBonus         = $0,
                                     CostSum             = $0,
       CorrIntToEIRAdd         = $0, CorrIntToEIRSum     = $0, /*Добавленная и суммарная корректировки % до ЭСП*/
       ReservAmountAdd         = $0, IncomeReservAdd     = $0, /*Доначисленные резерв и резерв по ПДД*/
       ReservAmountSum         = $0, IncomeReservSum     = $0, /*Сумма списываемого резерва и резерва по ПДД*/
       EstReserveAdd           = $0, CorrEstReserveAdd   = $0, /*Доначисленные оценочный резерв и корректировка резерва*/
       EstReserveSum           = $0, CorrEstReserveSum   = $0, /*Суммарный списываемый оценочный резерв и его корректировка*/
       AccounttedDefDiffAdd    = $0,                           /*Доначисленная отсроченная разница*/
                                     OverAmountAdd       = $0, /*Доначисленная переоценка*/    
       CorrValueBuy            = $0;                           /*Списанная сумма корректировки СС*/
   VAR BalanceCostBD = $0, CostSale = $0, SСпво = $0, SСакт = $0, BonusRest = $0, NKDRest = $0, NotWrtBonusBuy = $0, SumReservFR = $0;
   VAR err = 0, AccDebetFIRole, AccCreditFIRole;

   if( IsClientDeal(FD.tick.rec) )
      return 0;
   end;

   
   copy(PmWrtSum, FD.pmwrtsum);

   var UsingNewRepo = false;

   if( IsBUY(FD.Group) AND IsTwoPart(FD.Group) AND // ОРЕПО
       (GetSecurNewRepoDate() <= CarDate)       // если в режиме новых сделок РЕПО
     )
     UsingNewRepo = true;
   end;
   
   

   ПолучитьГруппыСписания(FD, Groups);


   while( i < Groups.Size )

      FIIDDebet = FD.FaceFIID();

      FIIDCredit = NATCUR;

      SummFRArr[i] = SummFR(Groups[i]);
      if( WRT_GetSaleFinResult_EX( PmWrtSum.rec.SumID, 
                                   Groups[i],
                                   0,
                                   @CostBuy            ,
                                   @BalanceCostBuy     ,
                                   @NKDBuy             ,
                                   @InterestIncomeBuy  ,
                                   @DiscountIncomeBuy  ,
                                   @NotCarryInterestBuy,
                                   @NotCarryDiscountBuy,
                                   @InterestIncomeAdd  ,
                                   @DiscountIncomeAdd  ,
                                   @NotCarryInterestAdd,
                                   @NotCarryDiscountAdd,
                                   @InterestIncomeSum  ,
                                   @DiscountIncomeSum  ,
                                   @NotCarryInterestSum,
                                   @NotCarryDiscountSum,
                                   @BalanceCostSum     ,
                                   @OutlayBuy          ,
                                   @OverAmountBuy      ,
                                   @OverAmountAdd      ,
                                   @OverAmountSum      ,
                                   @ReservAmountBuy    ,
                                   @ReservAmountAdd    ,
                                   @ReservAmountSum    ,
                                   @BalanceCostBD      ,
                                   @CostSale           ,
                                   NULL                ,
                                   @Amount             ,
                                   @IncomeReservBuy    ,
                                   @IncomeReservAdd    ,
                                   @IncomeReservSum    ,
                                   @BonusAdd           ,
                                   @CostSum            ,
                                   null                ,
                                   null                ,
                                   null                ,
                                   null                ,
                                   null                ,
                                   @BonusRest          ,
                                   @NotWrtBonus        ,
                                   NULL,
                                   @AccounttedDefDiffAdd,
                                   NULL,
                                   @CorrValueBuy       ,
                                   NULL,
                                   @CorrIntToEIRAdd    ,
                                   @CorrIntToEIRSum    ,
                                   NULL,
                                   @EstReserveAdd      ,
                                   @EstReserveSum      ,
                                   NULL,
                                   @CorrEstReserveAdd  ,
                                   @CorrEstReserveSum
                                 ) != true )
         return 0;
      end;

      ALL_BalanceCostBuy      = ALL_BalanceCostBuy       + BalanceCostBuy     ;
      ALL_InterestIncomeBuy   = ALL_InterestIncomeBuy    + InterestIncomeBuy  ;
      ALL_DiscountIncomeBuy   = ALL_DiscountIncomeBuy    + DiscountIncomeBuy  ;
      ALL_NotCarryInterestBuy = ALL_NotCarryInterestBuy  + NotCarryInterestBuy;
      ALL_NotCarryDiscountBuy = ALL_NotCarryDiscountBuy  + NotCarryDiscountBuy;
      ALL_InterestIncomeAdd   = ALL_InterestIncomeAdd    + InterestIncomeAdd  ;
      ALL_DiscountIncomeAdd   = ALL_DiscountIncomeAdd    + DiscountIncomeAdd  ;
      ALL_NotCarryInterestAdd = ALL_NotCarryInterestAdd  + NotCarryInterestAdd;
      ALL_NotCarryDiscountAdd = ALL_NotCarryDiscountAdd  + NotCarryDiscountAdd;
      ALL_OutlayBuy           = ALL_OutlayBuy            + OutlayBuy          ;
      ALL_Amount              = ALL_Amount               + Amount;

      SummFRArr[i].Amount = SummFRArr[i].Amount + Amount;

      

      if( (Groups[i] == KINDPORT_SALE) or (Groups[i] == KINDPORT_TRADE) ) /*/*ППР*/*/
        SummFRArr[i].OverAmountBuy = SummFRArr[i].OverAmountBuy + OverAmountSUM ;
      end;

      SummFRArr[i].CorrSum = SummFRArr[i].CorrSum + CorrValueBuy + CorrIntToEIRSum;

      if( (Groups[i] != KINDPORT_BACK) AND (Groups[i] != KINDPORT_BACK_KSU)) /*не ПВО*/
         ALL_AmountNotPVO   = ALL_AmountNotPVO + Amount;
         ALL_BalanceCostSum = ALL_BalanceCostSum + BalanceCostSum;
      end;

      ALL_BalanceCostBD  = ALL_BalanceCostBD + BalanceCostBD;
      SummFRArr[i].BalanceCostBD = SummFRArr[i].BalanceCostBD + BalanceCostBD;

      if (EstReserveAdd == 0)
         EstReserveAdd = CorrEstReserveAdd;
      end;
      if (EstReserveSum == 0)
        EstReserveSum = CorrEstReserveSum;
      end;
      CorrValueBuy = CorrValueBuy + CorrIntToEIRSum;

      if( (IsTwoPart(FD.Group) and IsBUY(FD.Group)) or
          (IsTwoPart(FD.Group) == false) )

         if( InterestIncomeSum != 0 )
               
             /*для ФР собираем сконвертированные данные из ВН в НацВ, округленные до копеек*/
             if( SmartConvertSum( InterestIncomeSum, InterestIncomeSum, CarDate, FD.FaceFIID(), NATCUR, true ) == false )
                return 0;
             end;                      
             SummFRArr[i].InterestIncomeSum = SummFRArr[i].InterestIncomeSum + InterestIncomeSum;
            end;

         if((Groups[i] == KINDPORT_TRADE) or
            (Groups[i] == KINDPORT_SALE ) or
            (Groups[i] == KINDPORT_UNADMITTED) or
            (Groups[i] == KINDPORT_RETIRE) ) /*Если списание из ССПУ_ЦБ, ССПД_ЦБ, БПП или АС_ЦБ*/
             
            

            

            if( DiscountIncomeSum != 0 )
               
               /*для ФР собираем сконвертированные данные из ВН в НацВ, округленные до копеек*/
               if( SmartConvertSum( DiscountIncomeSum, DiscountIncomeSum, CarDate, FD.FaceFIID(), NATCUR, true ) == false )
                  return 0;
               end;                      
               SummFRArr[i].DiscountIncomeSum = SummFRArr[i].DiscountIncomeSum + DiscountIncomeSum;
            end;
         end;
      end;   

      if( СписаниеРезерваПоЦБ( FD, CarDate, Groups[i], ReservAmountSum, IncomeReservSum, EstReserveSum, @SumReservFR) == false )
         return 0;
      end;
      SummFRArr[i].ReservSum = SummFRArr[i].ReservSum + SumReservFR; // сумма списаного резерва (на реализацию)
      i = i + 1;
   end;

   /*списание обязательств по обр. поставке своей сделки ОРЕПО. Проводка 2КА2*/
   if( IsTwoPart(FD.Group) and IsBUY(FD.Group) )
     CarSumm_od = money( ALL_BalanceCostBD );
   end;

  
   query = "select buylot.t_DealID, buylot.t_Portfolio, NVL(sum(lnk.t_BalanceCostBuy), 0) t_BalanceCostBuy, NVL(sum(lnk.t_BalanceCostSale), 0) t_BalanceCostSale, NVL(sum(lnk.t_Amount), 0) t_Amount, NVL(SUM(LNK.T_OVERAMOUNTADD), 0) T_OVERAMOUNTADD, " +
           " NVL(sum((CASE WHEN buylot.t_Kind = "+PM_WRTSUM_KIND_RRWAB2+" THEN 0 ELSE lnk.t_BalanceCostBD END)), 0) t_BalanceCostBD "
           "  from dpmwrtlnk_dbt lnk, dpmwrtsum_dbt buylot " +
           " where buylot.t_SumID  = lnk.t_BuyID " +
           "   and lnk.t_SaleID = ? " +
           "   and buylot.t_Portfolio IN ("+KINDPORT_BACK+", "+KINDPORT_BACK_KSU+") " +
           " group by buylot.t_DealID, buylot.t_Portfolio" +
           " order by (case when ? = buylot.t_DealID then 0 else 1 end) asc"; //сначала свои

   SQLQuery = DL_RSDCommand(query);

   SQLQuery.addParam(PmWrtSum.rec.SumID );
   SQLQuery.addParam(PmWrtSum.rec.DealID );
   
   var cntRec = SQLQuery.GetCount();
   var PrevDebAcc = "";

   /*Если списание из ПВО, то проводки посделочные. Иначе - группируем по портфелям.*/
   RSD = SQLQuery.execute();
   i = 0;
   while( RSD.MoveNext() )

      i = i + 1;

      if( (IsTwoPart(FD.Group) and IsBUY(FD.Group)) and  (PmWrtSum.rec.DealID == RSD.rec.DealID)  )
        FD_buy = FD; //потому что счета ПВО должны быть по этой же ОРЕПО
      else
        FD_buy = SPFirstDoc( LEG_KIND_DL_TICK, RSD.rec.DealID );
      end;

      FD_buy.SetCurPFI(PmWrtSum.rec.FIID);
      
         FIRole = FIROLE_BA;
         
       /*продажа "своего" лота или его части*/
       if( PmWrtSum.rec.DealID == RSD.rec.DealID )
         /*списание стоимости ц/б*/
          CredCat  = "ВнебалСчетКорресп";
          CarFIID  = NATCUR;
          CarFIID2 = FD_buy.FaceFIID();
          CarSumm = money( RSD.rec.BalanceCostBuy );
          Capter   = 3;

          /* Отнимем из ПВО количество по "своим" лотам */
          DecAmountSummFR(SummFRArr, RSD.rec.Portfolio, RSD.rec.Amount);

       /*продажа чужого лота или его части из ПВО*/
       else
          
          NeedThisTrnAcc = true;

          /*списание стоимости чужого лота*/
          CredCat  = "ВнебалСчетКорресп";
          CarFIID  = NATCUR;
          CarFIID2 = FD_buy.FaceFIID();
          CarSumm  = money( RSD.rec.BalanceCostBuy );
          Capter   = 3;

          if( IsTwoPart(FD.Group) and IsSALE(FD.Group) )
             DebCatBD = IIF(IsBasket(FD.Group), "+ОД, Корзина", "+ОД");
             if(GetSecurNewRepoDate() <= CarDate)
               NeedThisTrnAcc = false; //В новом РЕПО проводка не нужна
             end;
          else
             DebCatBD = "Реализация, ц/б";
          end;

          if( IsTwoPart(FD.Group) )
            CarSummBD = money( RSD.rec.BalanceCostBD );
          else
            CarSummBD = money( RSD.rec.BalanceCostBuy );
          end;
          
          if((NeedThisTrnAcc == true) and (CarSummBD > 0))
               /*для ФР собираем сконвертированные данные из ВН в НацВ, округленные до копеек*/
               if( SmartConvertSum( CarSummBD_Natcur, CarSummBD, CarDate, FD.FaceFIID(), NATCUR, true ) == false )
                  return 0;
               end;                      
               SСпво = SСпво + CarSummBD_Natcur;
          end;
       end;
      
   end;

   if( UsingNewRepo ) /*Обрабатываем 2ч ОРЕПО*/
     var cmd; 
     var FDsale; /*1ч ПРЕПО*/
     var FDBuy;
     var PVOAcc = TRecHandler( "account.dbt" );
     /*линки покупки и 2ч ОРЕПО*/
     query =   " select buylot.t_Portfolio, buylot.t_DealID, lnk.t_BalanceCostSale, lnk.t_Amount, salelot2.t_DealID SaleDealID, "
             + "        (lnk.t_CostBuy + lnk.t_NKDBuyAmount - lnk.t_BonusAdd) CarSumm, "
             + "        (ROUND(NVL(lnk.T_BEGBONUSCHANGE, 0),2) - ROUND(NVL(lnk.T_BONUSBUY, 0),2) - ROUND(NVL(lnk.T_BONUSADD, 0),2) + ROUND(NVL(lnk.T_OLDBONUSBUY, 0),2)) BonusRest, "
             + "        lnk.t_NKDBuyAmount NKDRest, "
             + "        lnk.t_NotWrtBonusBuy NotWrtBonusBuy "
             + "   from dpmwrtlnk_dbt lnk, dpmwrtsum_dbt buylot, dpmwrtsum_dbt salelot2 "
             + "  where lnk.t_SaleID = salelot2.t_SumID "
             + "    and salelot2.t_Source = ? "
             + "    and salelot2.t_Kind = " + PM_WRTSUM_KIND_RRWAS1
             + "    and buylot.t_SumID = lnk.t_BuyID "
             + "    and buylot.t_Portfolio not in( " + KINDPORT_BACK + ", "+KINDPORT_BASICDEBT+", "+ KINDPORT_BACK_KSU+ ", " + KINDPORT_BACK_BPP_KSU + ")"
             + "  order by lnk.t_Amount DESC";

     cmd = DL_RSDCommand(query);
     cmd.AddParam(PmWrtSum.rec.SumID); 

     DataSet = cmd.Execute();
     while( DataSet.moveNext() )

       FDBuy = SPFirstDoc(LEG_KIND_DL_TICK, DataSet.DealID);
       FDBuy.SetCurPFI(PmWrtSum.rec.FIID);

       FDsale = SPFirstDoc(LEG_KIND_DL_TICK, DataSet.SaleDealID);
       FDsale.SetCurPFI(PmWrtSum.rec.FIID);

       var SaleIsOverdue:bool = false;

       if(IsTwoPart(FD.Group) )
         if( IsBasket(FDsale.Group) )
            DebCat = "Ц/б, Корзина БПП";
         else
            DebCat = "Ц/б, БПП";
         end;
         CarFIID2 = FDsale.FaceFIID();

         CredCat  = "Наш портфель ц/б";
         CarFIID  = FDsale.GetAccFIID(CredCat);
       else
         DebCat   = "Реализация, ц/б";
         CarFIID2 = NATCUR;

         CredCat = "Наш портфель ПКУ, ц/б";
         CarFIID = NATCUR;
       end;

       CarSumm  = money(DataSet.CarSumm);
       BonusRest= money(DataSet.BonusRest);
       NKDRest  = money(DataSet.NKDRest);
       NotWrtBonusBuy = money(DataSet.NotWrtBonusBuy);
       Capter   = 1;

       WrtCostSum = CarSumm - BonusRest;

       if( ОтдельныйУчетУплНКД() )
          WrtCostSum = WrtCostSum - NKDRest;
       end;

       CarSumm = BonusRest;
     end;
     
   end; 
   
   if((not UsingNewRepo) OR (not СвойЛотБылПроданПРЕПО(PmWrtSum.rec.SumID, true)))

     var AcCurSec = УЧЕТ_ВАЛЮТНЫХ_ДОЛЕВЫХ_ЦБ(),
         IsBondFI = FI_IsBond(FD.fininstr),
         SumDeb = 0, SumCred = 0;
     var SumEquivalentCarry = null;

     // *Если ц/б с идентификаторм T_FIID текущего лота продажи НЕ является облигацией И её валюта номинала НЕ равна НацВ,
     // Продажа:
     //   то сумма для проводки <Списание стоимости покупки> (Реализация, ц/б - Наш портфель, ц/б) из портфелей ССПУ_ЦБ или СССД_ЦБ определяется следующим образом:
     // ПРЕПО:
     //   И <Учет валютных долевых ц/б> имеет значение 0 (т.е. в рублях),
     //   то сумма для проводки <Перевод основной стоимости> (ЦБ_БПП (ВН) - Наш портфель (ВУ)) определяется следующим образом:
     if( (((not IsTwoPart(FD.Group)) and IsSALE(FD.Group))
             or (IsREPO(FD.Group) and IsSALE(FD.Group) and (AcCurSec == 0))) and
          (IsBondFI == false) and (FD.FaceFIID() != NATCUR) )
        SQLQuery = RSDCommand("select buylot.t_Portfolio, " +
                              "       NVL(SUM(lnk.t_CostBuy), 0) Svib, " +
                              "       NVL(SUM(lnk.t_CostBuyNat), 0) Svibrub " +
                              "  from dpmwrtlnk_dbt lnk, dpmwrtsum_dbt buylot " +
                              " where lnk.t_SaleID   = ? " +
                              "   and buylot.t_SumID = lnk.t_BuyID " +
                              "   and buylot.t_Portfolio in (?, ?) " +
                              " group by buylot.t_Portfolio ");

        SQLQuery.addParam( "", RSDBP_IN, PmWrtSum.rec.SumID );
        SQLQuery.addParam( "", RSDBP_IN, KINDPORT_TRADE );
        SQLQuery.addParam( "", RSDBP_IN, KINDPORT_SALE );
        SQLQuery.execute();

        RSD = TRsbDataSet(SQLQuery);

        while( RSD.MoveNext() )
           if( IsREPO(FD.Group))
              DebCat = IIF(IsBasket(FD.Group), "Ц/б, Корзина БПП", "Ц/б, БПП");
              SumDeb = RSD.rec.Svib;
              CarFIID = FD.FaceFIID();
              SumCred = RSD.rec.Svibrub;
              CarFIID2 = NATCUR;
           else
              DebCat   = "Реализация, ц/б";

              if(AcCurSec == 0)
                 SumDeb = SumCred = RSD.rec.Svibrub;
                 CarFIID = CarFIID2 = NATCUR;
              else
                 SumDeb = RSD.rec.Svibrub;
                 SumCred = RSD.rec.Svib;
                 CarFIID = NATCUR;
                 CarFIID2 = FD.FaceFIID();
              end;
           end;
           CredCat  = "Наш портфель ц/б";

           SumEquivalentCarry = null;
           if((AcCurSec != 0) and (IsBondFI == false) and (FD.FaceFIID() != NATCUR))
             SumEquivalentCarry = money(RSD.rec.Svibrub);
           end;

           if( SumDeb != 0 )
              

              if( not (IsTwoPart(FD.Group) and IsSALE(FD.Group)) ) // не ПРЕПО
                 AddCostSummFR(SummFRArr, RSD.rec.Portfolio, money(RSD.rec.Svibrub));
              end;
           end;
        end;
     end;

     query = "select buylot.t_Portfolio, " +
             "       NVL(SUM(lnk.t_CostBuy + lnk.t_NKDBuyAmount - lnk.t_BonusAdd), 0) CarSumm, NVL(SUM(lnk.t_CostPFIBuy), 0) CostPFIBuy, " +
             "       NVL(SUM(  ROUND(NVL(lnk.T_BEGBONUSCHANGE, 0),2) "+
             "               - ROUND(NVL(lnk.T_BONUSBUY, 0),2) "+
             "               - ROUND(NVL(lnk.T_BONUSADD, 0),2) "+
             "               + ROUND(NVL(lnk.T_OLDBONUSBUY, 0),2)";

     if(CheckCalcBonusWithoutPartly() == false)
       query = query + 
             "               - NVL((SELECT SUM(RSB_PMWRTOFF.WRTCalcSumPart(FW.T_FIID,FW.T_NUMBER,(buylot.T_BEGBONUS*lnk.t_Amount/buylot.t_Amount),GREATEST(buylot.T_BEGBONUSDATE,buylot.T_RECALCDATE))) "+
             "                        FROM DFIWARNTS_DBT FW "+
             "                       WHERE FW.T_FIID = buylot.T_FIID "+
             "                         AND FW.T_ISPARTIAL = 'X' "+
             "                         AND FW.T_DRAWINGDATE > GREATEST(buylot.T_BEGBONUSDATE, buylot.T_RECALCDATE) "+
             "                         AND FW.T_DRAWINGDATE < lnk.T_CREATEDATE "+
             "                    ), 0) ";
     end;

     query = query +
             "              ), 0) BonusRest, " +
             "       NVL(SUM(lnk.t_NKDBuyAmount), 0) NKDRest, " +
             "       NVL(SUM(lnk.t_NotWrtBonusBuy), 0) NotWrtBonusBuy, " +
             "       NVL(SUM(lnk.t_CostBuyNat), 0) CostBuyNat " +
             "  from dpmwrtlnk_dbt lnk, v_scwrthistex buylot " +
             " where buylot.t_SumID = lnk.t_BuyID " +
             "   and buylot.t_Instance = lnk.t_BuyInstance-1 " +
             "   and lnk.t_SaleID   = ? " +
             "   and buylot.t_Portfolio not in (?, ?, ?, ?) " +
             " group by buylot.t_Portfolio ";

     cmd = DL_RSDCommand(query);

     cmd.addParam(PmWrtSum.rec.SumID );
     cmd.addParam(KINDPORT_BACK );
     cmd.addParam(KINDPORT_BASICDEBT );
     cmd.addParam(KINDPORT_BACK_KSU );
     cmd.addParam(KINDPORT_BACK_BPP_KSU );
     RSD = cmd.execute();
      
     /*Иначе - группируем проводки по портфелям, кроме ПВО.
       Эту проводку наверное можно внести выше и получать сумму в WRT_GetSaleFinResult_EX. 
       Возможно, так не сделано потому что в WRT_GetSaleFinResult_EX перебираются не все портфели 
       и чтобы не ломать там логику.
     */
     while( RSD.MoveNext() )
        if( IsTwoPart(FD.Group) and IsSALE(FD.Group) ) // ПРЕПО
           if( RSD.rec.Portfolio == KINDPORT_CONTR )
              DebCat   = IIF(IsBasket(FD.Group), "Ц/б, Корзина ПКУ БПП", "Ц/б, ПКУ БПП");
              CarFIID2 = NATCUR;
           else
              DebCat   = IIF(IsBasket(FD.Group), "Ц/б, Корзина БПП", "Ц/б, БПП");
              CarFIID2 = FD.FaceFIID();
           end;
        else
           DebCat   = "Реализация, ц/б";
           CarFIID2 = NATCUR;
        end;

        if( (IsTwoPart(FD.Group) and IsSALE(FD.Group) and (RSD.rec.Portfolio == KINDPORT_CONTR)) or // ПРЕПО
            ((not IsTwoPart(FD.Group)) and (FD.ТипПортфеля() == KINDPORT_CONTR))
          )
           CredCat = "Наш портфель ПКУ, ц/б";
           CarFIID = NATCUR;
        else
           CredCat  = "Наш портфель ц/б";
           CarFIID  = FD.GetAccFIID(CredCat);
        end;

        CarSumm  = money(RSD.rec.CarSumm);
        BonusRest= money(RSD.rec.BonusRest);
        NotWrtBonusBuy= money(RSD.rec.NotWrtBonusBuy);
        NKDRest  = money(RSD.rec.NKDRest);
        Capter   = 1;

        // *Для остальных ц/б остается имеющаяся реализация
        if(not((((not IsTwoPart(FD.Group)) and IsSALE(FD.Group))
                   or (IsREPO(FD.Group) and IsSALE(FD.Group) and (AcCurSec == 0))) and
                (IsBondFI == false) and
                (FD.FaceFIID() != NATCUR) and
                ((RSD.rec.Portfolio == KINDPORT_TRADE) or (RSD.rec.Portfolio == KINDPORT_SALE)))
          )        
           if((AcCurSec == 0) and (IsBondFI == false) and (FD.FaceFIID() != NATCUR))
             WrtCostSum = RSD.rec.CostBuyNat;
           else
             WrtCostSum = CarSumm - BonusRest + money(RSD.rec.CostPFIBuy);
           end;

           if( ОтдельныйУчетУплНКД() )
              WrtCostSum = WrtCostSum - NKDRest;
           end;

           SumEquivalentCarry = null;
           if((AcCurSec != 0) and (IsBondFI == false) and (FD.FaceFIID() != NATCUR))
             SumEquivalentCarry = money(RSD.rec.CostBuyNat);
           end;

           if( WrtCostSum != 0 )
              

              if( not (IsTwoPart(FD.Group) and IsSALE(FD.Group)) ) // не ПРЕПО
                 /*для ФР собираем сконвертированные данные из ВН в НацВ, округленные до копеек*/
                 if( SmartConvertSum( WrtCostSum, WrtCostSum, CarDate, CarFIID, NATCUR, true ) == false )
                    return 0;
                 end;                      
                 AddCostSummFR(SummFRArr, RSD.rec.Portfolio, WrtCostSum);
              end;
           end;
        end;

        if (ОтдельныйУчетУплНКД())
           if( IsTwoPart(FD.Group) and IsSALE(FD.Group) ) // ПРЕПО
              /* ПР 1КА1б2 */
              
           else
              /* ОР 2КВБАб2, продажа 1ЛАБб2 # */
                 
                 /*для ФР собираем сконвертированные данные из ВН в НацВ, округленные до копеек*/
                 if( SmartConvertSum( NKDRest, NKDRest, CarDate, FD.FaceFIID(), NATCUR, true ) == false )
                    return 0;
                 end;
                 AddCostSummFR(SummFRArr, RSD.rec.Portfolio, NKDRest);
           end;
        end;

        if( IsTwoPart(FD.Group) and IsSALE(FD.Group) ) // ПРЕПО
           /* ПР 1КА1б2 */
           
        else
           /* ОР 2КВБАб2, продажа 1ЛАБб2 # */
              
              /*для ФР собираем сконвертированные данные из ВН в НацВ, округленные до копеек*/
              if( SmartConvertSum( BonusRest, BonusRest, CarDate, FD.FaceFIID(), NATCUR, true ) == false )
                 return 0;
              end;                      
              AddCostSummFR(SummFRArr, RSD.rec.Portfolio, BonusRest);
        end;
     end;
   end;

   if( (not (IsSALE(FD.Group) and IsTwoPart(FD.Group))) and (ALL_Amount != 0) ) /*в ПРЕПО нет ФР*/

      if( IsTwoPart(FD.Group) )

         var ALLAmountOD = $0, j = 0;
         while( j < SummFRArr.Size )
            ALLAmountOD = ALLAmountOD + SummFRArr[j].Amount;
            j = j + 1;
         end;

         if( ALLAmountOD != 0 )
            var BCostBD = $0;

            i = 0;
            while( i < SummFRArr.Size )
               if( (SummFRArr[i].Portofolio == KINDPORT_BACK) OR (SummFRArr[i].Portofolio == KINDPORT_BACK_KSU))
                  if( SmartConvertSum(BCostBD, SummFRArr[i].BalanceCostBD, CarDate, FD.FaceFIID(), NATCUR, true) == false )
                    return 0;
                  end;

                  FR = BCostBD - SСпво;
               else
                  SСакт = SummFRArr[i].CostSum + SummFRArr[i].InterestIncomeSum + SummFRArr[i].DiscountIncomeSum;

                  if( SmartConvertSum(BCostBD, SummFRArr[i].BalanceCostBD, CarDate, FD.FaceFIID(), NATCUR, true) == false )
                    return 0;
                  end;
               
                  FR = BCostBD
                     - SСакт
                     - SummFRArr[i].OverAmountBuy
                     - IIF(FI_IsAvrKindBond(FD.fininstr.rec.AvoirKind), SummFRArr[i].CorrSum, 0)    // если долговая, тогда списываем корректировку;
               end;

               if(Portfolio == SummFRArr[i].Portofolio)
                 return FR;
               end;

               i = i + 1;
            end;
         end;
      end;
   end;

   return 0; 
END;



macro BuyRepoBDCheck(FIID:integer, fromDate:date, toDate:date)
  var query, cmd, DataSet;
  var Rep     :CMakeReport;

  query =  " SELECT q.t_CreateDate, q.t_Kind as LnkKind, q.t_BalanceCostBuy, q.t_DealID, q.SaleDealCode, q.BuyDealCode, q.Account, q.prevRest, "
         + "        q.RealPortfolioID as Portfolio, q.AccountNewBD, q.t_Amount as LnkAmount, q.t_BalanceCostBD as LnkBalanceCostBD, q.t_FaceValueFI, "
         + "        q.t_ISO_Number as FaceValueFICode, q.Course, q.RealizAccount, "
         + "        q.TSSprev, q.NeedNewBD, q.TSSToday, q.BuyDealID, q.t_BuyID, q.BuyIsPREPO, "
         + "        (SELECT t_Fi_Code from dfininstr_dbt where t_FIID = q.t_FIID) as FI_Code,"
         + "        (SELECT llv.t_Code "
         + "           FROM dllvalues_dbt llv "
         + "          WHERE llv.t_List = 1100 "
         + "            AND llv.t_Element = q.RealPortfolioID "
         + "        ) as PortfolioName, "
         + "        (SELECT rq2.t_PlanDate "
         + "           FROM ddlrq_dbt rq2 "
         + "          WHERE rq2.t_DocKind = 101 "
         + "            AND rq2.t_DocID = q.BuyDealID "
         + "            AND rq2.t_DealPart = 2 "
         + "            AND rq2.t_Type = " + DLRQ_TYPE_DELIVERY
         + "            AND rq2.t_FIID = q.t_FIID "
         + "        ) as Buy2Date, "
         + "        (SELECT atrn.t_Sum_Payer"
         + "           FROM dacctrn_dbt atrn, ddlgrdoc_dbt grdoc, ddlgrdeal_dbt grdeal "
         + "          WHERE grdeal.t_DocKind = 101 "
         + "            AND grdeal.t_DocID = q.t_DealID "
         + "            AND grdeal.t_PlanDate = q.t_CreateDate "
         + "            AND grdoc.t_GrDealID = grdeal.t_ID "
         + "            AND grdoc.t_DocKind = 1 "
         + "            AND atrn.t_AccTrnID = grdoc.t_DocID "
         + "            AND atrn.t_Account_Payer = q.Account "
         + "            AND atrn.t_Date_Carry = q.t_CreateDate "
         + "            AND atrn.t_State = 1 "
         + "            AND SUBSTR (atrn.t_Account_Receiver, 1, 5) = '61210'"
         + "        ) as trnSum, "
         + "        (CASE WHEN q.AccountNewBD != CHR(1) THEN"
         + "           (SELECT atrn.t_Sum_Receiver "
         + "              FROM dacctrn_dbt atrn, ddlgrdoc_dbt grdoc, ddlgrdeal_dbt grdeal "
         + "             WHERE grdeal.t_DocKind = 101 "
         + "               AND grdeal.t_DocID = q.t_DealID "
         + "               AND grdeal.t_PlanDate = q.t_CreateDate "
         + "               AND grdoc.t_GrDealID = grdeal.t_ID "
         + "               AND grdoc.t_DocKind = 1 "
         + "               AND atrn.t_AccTrnID = grdoc.t_DocID "
         + "               AND atrn.t_Account_Receiver = q.AccountNewBD "
         + "               AND atrn.t_Date_Carry = q.t_CreateDate "
         + "               AND atrn.t_State = 1 "
         + "               AND SUBSTR (atrn.t_Account_Payer, 1, 5) = '61210'"
         + "           )"
         + "         ELSE 0 END"
         + "        ) as TrnNewSum, "
         + "        (CASE WHEN q.AccountNewBD != CHR(1) THEN"
         + "           NVL((SELECT SUM(atrn.t_Sum_Receiver) "
         + "                  FROM dacctrn_dbt atrn "
         + "                 WHERE atrn.t_Numb_Document = q.SaleDealCode "
         + "                   AND atrn.t_Account_Receiver IN ('31502810499005000000', '31502840799005000000') "
         + "                   AND atrn.t_Date_Carry = q.t_CreateDate "
         + "                   AND atrn.t_State = 1 "
         + "                   AND SUBSTR (atrn.t_Account_Payer, 1, 5) = '61210'"
         + "               ), 0) "
         + "         ELSE 0 END"
         + "        ) as TrnNewSumUser, "
         + "        (CASE WHEN q.AccountNewBD != CHR(1) THEN"
         + "           NVL((SELECT SUM(atrn.t_Sum_Natcur) "
         + "                  FROM dacctrn_dbt atrn "
         + "                 WHERE atrn.t_Account_Payer IN ('31502810499005000000', '31502840799005000000') "
         + "                   AND atrn.t_Account_Receiver = q.AccountNewBD "
         + "                   AND atrn.t_Date_Carry = q.t_CreateDate + 1 "
         + "                   AND atrn.t_State = 1 "
         + "               ), 0) - "
         + "           NVL((SELECT SUM(atrn.t_Sum_Natcur) "
         + "                  FROM dacctrn_dbt atrn "
         + "                 WHERE atrn.t_Account_Receiver IN ('31502810499005000000', '31502840799005000000') "
         + "                   AND atrn.t_Date_Carry = q.t_CreateDate "
         + "                   AND atrn.t_State = 1 "
         + "                   AND atrn.t_Account_Payer = q.RealizAccount "
         + "               ), 0) "
         + "         ELSE 0 END"
         + "        ) as TrnOverSumUser, "
         + "        NVL((SELECT SUM(atrn.t_Sum_Payer)"
         + "               FROM dacctrn_dbt atrn, ddlgrdoc_dbt grdoc, ddlgrdeal_dbt grdeal "
         + "              WHERE grdeal.t_DocKind = 101 "
         + "                AND grdeal.t_DocID = q.t_DealID "
         + "                AND grdeal.t_PlanDate = q.t_CreateDate "
         + "                AND grdoc.t_GrDealID = grdeal.t_ID "
         + "                AND grdoc.t_DocKind = 1 "
         + "                AND atrn.t_AccTrnID = grdoc.t_DocID "
         + "                AND atrn.t_State = 1 "
         + "                AND SUBSTR (atrn.t_Account_Payer, 1, 5) = '61210' "
         + "                AND Exists(SELECT 1 "
         + "                             FROM dmcaccdoc_dbt accdoc, dmctempl_dbt tpl "
         + "                            WHERE accdoc.t_Account = atrn.t_Account_Receiver "
         + "                              AND accdoc.t_Chapter = atrn.t_Chapter "
         + "                              AND accdoc.t_Currency = atrn.t_FIID_Receiver "
         + "                              AND accdoc.t_CatNum = 15 /*+Маржа, ц/б*/"
         + "                              AND tpl.t_CatID = accdoc.t_CatID "
         + "                              AND tpl.t_Number = accdoc.t_TemplNum "
         + "                              AND tpl.t_Value1 = (CASE WHEN q.RealPortfolioID = 6 THEN 2 ELSE q.RealPortfolioID END) " 
         + "                          ) "
         + "            ), 0) as PlusFR, "
         + "        NVL((SELECT SUM(atrn.t_Sum_Receiver) "
         + "               FROM dacctrn_dbt atrn, ddlgrdoc_dbt grdoc, ddlgrdeal_dbt grdeal "
         + "              WHERE grdeal.t_DocKind = 101 "
         + "                AND grdeal.t_DocID = q.t_DealID "
         + "                AND grdeal.t_PlanDate = q.t_CreateDate "
         + "                AND grdoc.t_GrDealID = grdeal.t_ID "
         + "                AND grdoc.t_DocKind = 1 "
         + "                AND atrn.t_AccTrnID = grdoc.t_DocID "
         + "                AND atrn.t_State = 1 "
         + "                AND SUBSTR (atrn.t_Account_Receiver, 1, 5) = '61210' "
         + "                AND Exists(SELECT 1 "
         + "                             FROM dmcaccdoc_dbt accdoc, dmctempl_dbt tpl "
         + "                            WHERE accdoc.t_Account = atrn.t_Account_Payer "
         + "                              AND accdoc.t_Chapter = atrn.t_Chapter "
         + "                              AND accdoc.t_Currency = atrn.t_FIID_Payer "
         + "                              AND accdoc.t_CatNum = 37 /*-Маржа, ц/б*/"
         + "                              AND tpl.t_CatID = accdoc.t_CatID "
         + "                              AND tpl.t_Number = accdoc.t_TemplNum "
         + "                              AND tpl.t_Value1 = (CASE WHEN q.RealPortfolioID = 6 THEN 2 ELSE q.RealPortfolioID END) " 
         + "                          ) "
         + "            ), 0) as MinusFR, "
         + "        NVL((SELECT atrn.t_Sum_Receiver "
         + "               FROM dacctrn_dbt atrn "
         + "              WHERE atrn.t_Date_Carry = q.t_CreateDate "
         + "                AND atrn.t_State = 1 "
         + "                AND atrn.t_Account_Payer = q.AccountNewBD "
         + "                AND Exists(SELECT 1 "
         + "                             FROM dmcaccdoc_dbt accdoc, dmctempl_dbt tpl "
         + "                            WHERE accdoc.t_Account = atrn.t_Account_Receiver "
         + "                              AND accdoc.t_Chapter = atrn.t_Chapter "
         + "                              AND accdoc.t_Currency = atrn.t_FIID_Receiver "
         + "                              AND accdoc.t_CatNum = 15 /*+Маржа, ц/б*/"
         + "                              AND tpl.t_CatID = accdoc.t_CatID "
         + "                              AND tpl.t_Number = accdoc.t_TemplNum "
         + "                              AND tpl.t_Value1 = 2 " 
         + "                          ) "
         + "                AND NOT EXISTS(SELECT 1 FROM ddlgrdoc_dbt where t_DocKind = 1 and t_DocID = atrn.t_AccTrnID)"
         + "            ), 0) as MinusOvervl, "
         + "        NVL((SELECT atrn.t_Sum_Payer "
         + "               FROM dacctrn_dbt atrn "
         + "              WHERE atrn.t_Date_Carry = q.t_CreateDate "
         + "                AND atrn.t_State = 1 "
         + "                AND atrn.t_Account_Receiver = q.AccountNewBD "
         + "                AND Exists(SELECT 1 "
         + "                             FROM dmcaccdoc_dbt accdoc, dmctempl_dbt tpl "
         + "                            WHERE accdoc.t_Account = atrn.t_Account_Payer "
         + "                              AND accdoc.t_Chapter = atrn.t_Chapter "
         + "                              AND accdoc.t_Currency = atrn.t_FIID_Payer "
         + "                              AND accdoc.t_CatNum = 37 /*-Маржа, ц/б*/"
         + "                              AND tpl.t_CatID = accdoc.t_CatID "
         + "                              AND tpl.t_Number = accdoc.t_TemplNum "
         + "                              AND tpl.t_Value1 = 2 " 
         + "                          ) "
         + "                AND NOT EXISTS(SELECT 1 FROM ddlgrdoc_dbt where t_DocKind = 1 and t_DocID = atrn.t_AccTrnID)"
         + "            ), 0) as PlusOvervl, "
         + "        NVL((SELECT SUM(lnk1.t_BalanceCostBD) "
         + "               FROM dpmwrtlnk_dbt lnk1, dpmwrtsum_dbt lot "
         + "              WHERE lnk1.t_CreateDate = q.t_CreateDate "
         + "                AND lot.t_SumID = lnk1.t_SaleID "
         + "                AND lot.t_DealID = q.t_DealID"
         + "           ), 0) as LotBalanceCostBD, "
         + "        NVL((SELECT SUM(lnk1.t_Amount) "
         + "               FROM dpmwrtlnk_dbt lnk1, dpmwrtsum_dbt lot "
         + "              WHERE lnk1.t_CreateDate = q.t_CreateDate "
         + "                AND lot.t_SumID = lnk1.t_SaleID "
         + "                AND lot.t_DealID = q.t_DealID"
         + "           ), 0) as TotalAmount, "
         + "        NVL((SELECT SUM((CASE WHEN lnk1.t_Kind = 10 THEN lnk1.t_BalanceCostBuy ELSE lnk1.t_BalanceCostBD END)) "
         + "               FROM dpmwrtlnk_dbt lnk1, dpmwrtsum_dbt lotBuy, dpmwrtsum_dbt lotSale, ddlrq_dbt rq, ddl_tick_dbt saleTk "
         + "              WHERE lnk1.t_CreateDate = q.t_CreateDate "
         + "                AND lotBuy.t_SumID = lnk1.t_BuyID "
         + "                AND lotBuy.t_DealID = q.BuyDealID "
         + "                AND lotSale.t_SumId = lnk1.t_SaleID "
         + "                AND lotSale.t_DocKind = 29 "
         + "                AND rq.t_ID = lotSale.t_DocID "
         + "                AND saleTk.t_BOfficeKind = rq.t_DocKind "
         + "                AND saleTk.t_DealID = rq.t_DocID "
         + "                AND NOT ( RSB_SECUR.ISREPO(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(saleTk.t_DealType, saleTk.t_BofficeKind))) <> 0 "
         + "                          AND RSB_SECUR.ISSALE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(saleTk.t_DealType, saleTk.t_BofficeKind))) <> 0 "
         + "                        ) "
         + "           ), 0) as TotalLnkBalanceCostBD, "
         + "        NVL((SELECT SUM(lot.t_AmountBD) "
         + "               FROM v_scwrthistex lot "
         + "              WHERE lot.t_Parent = q.t_BuyID "
         + "                AND lot.t_ChangeDate <= q.t_CreateDate "
         + "                AND lot.t_Instance = (SELECT MAX(l.t_Instance) "
         + "                                           FROM v_scwrthistex l "
         + "                                          WHERE l.t_SumID = lot.t_SumID "
         + "                                            AND l.t_ChangeDate <= q.t_CreateDate "
         + "                                        ) "
         + "           ), 0) as TotalBuyDealAmountBD, "
         + "        NVL((SELECT SUM(lot.t_BalanceCostBD) "
         + "               FROM v_scwrthistex lot "
         + "              WHERE lot.t_Parent = q.t_BuyID "
         + "                AND lot.t_ChangeDate <= q.t_CreateDate-1 "
         + "                AND lot.t_Instance = (SELECT MAX(l.t_Instance) "
         + "                                           FROM v_scwrthistex l "
         + "                                          WHERE l.t_SumID = lot.t_SumID "
         + "                                            AND l.t_ChangeDate <= q.t_CreateDate-1 "
         + "                                        ) "
         + "           ), 0) as PrevTotalBuyBalanceCostBD "
         + "   FROM (SELECT lnk.t_CreateDate, lnk.t_BuyID, lnk.t_SaleID, lnk.t_Kind, lnk.t_BalanceCostBuy, saleTk.t_DealID, buyTk.t_DealID as BuyDealID, saleTk.t_DealCode SaleDealCode, buyTk.t_DealCode BuyDealCode, buyLot.t_Portfolio, "
         + "                buyLot.t_FIID, realBuyTK.t_PortfolioID as RealPortfolioID, fin.t_FaceValueFI, cur.t_ISO_Number, "
         + "                (CASE WHEN RSB_SECUR.ISREPO(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(buyTk.t_DealType, buyTk.t_BofficeKind))) <> 0 "
         + "                           AND RSB_SECUR.ISSALE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(buyTk.t_DealType, buyTk.t_BofficeKind))) <> 0 THEN 1 "
         + "                 ELSE 0 END) as BuyIsPREPO, "
         + "                NVL((select ad.t_Account "
         + "                       from dmcaccdoc_dbt ad, ddl_leg_dbt leg "
         + "                      where leg.t_LegKind = 0 "
         + "                        and leg.t_DealId = saleTk.t_DealID "
         + "                        and ad.t_DocKind = 176 "
         + "                        and ad.t_DocID = leg.t_ID "
         + "                        and ad.t_CatNum = 602 "
         + "                        and ad.t_ActivateDate <= lnk.t_CreateDate "
         + "                        and (ad.t_DisablingDate = "+GetSQLDate(date(0,0,0))+" or ad.t_DisablingDate >= lnk.t_CreateDate) "
         + "                    ), CHR(1)) as Account, "
         + "                NVL((select abs(rsb_account.restac(ad.t_Account, ad.t_Currency, lnk.t_CreateDate-1, ad.t_Chapter, null)) "
         + "                   from dmcaccdoc_dbt ad, ddl_leg_dbt leg "
         + "                  where leg.t_LegKind = 0 "
         + "                    and leg.t_DealId = saleTk.t_DealID "
         + "                    and ad.t_DocKind = 176 "
         + "                    and ad.t_DocID = leg.t_ID "
         + "                    and ad.t_CatNum = 602 "
         + "                    and ad.t_ActivateDate <= lnk.t_CreateDate "
         + "                    and (ad.t_DisablingDate = "+GetSQLDate(date(0,0,0))+" or ad.t_DisablingDate >= lnk.t_CreateDate) "
         + "                ), 0) as prevRest, "
         + "                (CASE WHEN realBuyTK.t_PortfolioID = 6 AND saleTk.t_DealID != buyTk.t_DealID and buyLot.t_Kind <> "+PM_WRTSUM_KIND_RRWAB2+" THEN"
         + "                   1 "
         + "                 ELSE 0 END) as NeedNewBD, "
         + "                NVL((select ad.t_Account "
         + "                       from dmcaccdoc_dbt ad, ddl_leg_dbt leg "
         + "                      where leg.t_LegKind = 0 "
         + "                        and leg.t_DealId = buyTk.t_DealID "
         + "                        and ad.t_DocKind = 176 "
         + "                        and ad.t_DocID = leg.t_ID "
         + "                        and ad.t_CatNum = 602 "
         + "                        and ad.t_ActivateDate <= lnk.t_CreateDate "
         + "                        and (ad.t_DisablingDate = "+GetSQLDate(date(0,0,0))+" or ad.t_DisablingDate >= lnk.t_CreateDate) "
         + "                    ), CHR(1)) as AccountNewBD, "
         + "                lnk.t_Amount, lnk.t_BalanceCostBD, "
         + "                (NVL(RSB_Secur.SC_ConvSumTypeRep(1, fin.t_FIID, fin.t_FaceValueFI, fin.t_FaceValueFI, "+ПолучитьВидКурса(SP_RATETYPE_RightCost)+", lnk.t_CreateDate-1), 0) "
//         + "                    - RSI_RSB_FIInstr.CalcNKD_Ex(fin.t_FIID, lnk.t_CreateDate-1, 1, 1 ) "
//         + "                    + RSI_RSB_FIInstr.CalcNKD_Ex(fin.t_FIID, lnk.t_CreateDate, 1, 1 )"
         + "                ) TSSprev, "
         + "                NVL(RSB_Secur.SC_ConvSumTypeRep(1, fin.t_FIID, fin.t_FaceValueFI, fin.t_FaceValueFI, "+ПолучитьВидКурса(SP_RATETYPE_RightCost)+", lnk.t_CreateDate), 0) TSSToday, "
         + "                NVL(RSB_FIINSTR.ConvSum(1, fin.t_FaceValueFI, "+NATCUR+", lnk.t_CreateDate), 0) Course, "
         + "                NVL((SELECT acc.t_Account "
         + "                       FROM dmcaccdoc_dbt acc "
         + "                      WHERE acc.t_CatNum = 262 "
         + "                        AND acc.t_FIID = fin.t_FIID "
         + "                        AND ROWNUM = 1 "
         + "                    ), CHR(1)) as RealizAccount "
         + "           FROM dpmwrtlnk_dbt lnk, "
         + "                dpmwrtsum_dbt buyLot, "
         + "                dpmwrtsum_dbt saleLot, "
         + "                ddlrq_dbt rqBuy, "
         + "                ddlrq_dbt rqSale, "
         + "                ddl_tick_dbt saleTk, "
         + "                ddl_tick_dbt buyTk, "
         + "                ddl_tick_dbt realBuyTk, "
         + "                dfininstr_dbt fin, "
         + "                dfininstr_dbt cur "
         + "          WHERE lnk.t_CreateDate >= ? "
         + "            AND lnk.t_CreateDate <= ?"
         + "            AND (lnk.t_BalanceCostBD > 0 OR lnk.t_Kind = "+PMWRTLINK_KIND_DISCARD+") "
         + "            AND buyLot.t_SumID = lnk.t_BuyID "
         + IIF(FIID > 0, "            AND buyLot.t_FIID = ? ", "")
         + "            AND saleLot.t_SumID = lnk.t_SaleID "
         + "            AND saleLot.t_Party = -1 "
         + "            AND buyLot.t_Party = -1 "
         + "            AND rqBuy.t_ID = buyLot.t_DocID "
         + "            AND rqSale.t_ID = saleLot.t_DocID "
         + "            AND buyTk.t_DealID = rqBuy.t_DocID "
         + "            AND saleTk.t_DealID = rqSale.t_DocID "
         + "            and ((    RSB_SECUR.ISREPO(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(buyTk.t_DealType, buyTk.t_BofficeKind))) <> 0 "
         + "                  and RSB_SECUR.ISBUY(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(buyTk.t_DealType, buyTk.t_BofficeKind))) <> 0 "
         + "                  and NOT ( RSB_SECUR.ISREPO(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(saleTk.t_DealType, saleTk.t_BofficeKind))) <> 0 "
         + "                            AND RSB_SECUR.ISSALE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(saleTk.t_DealType, saleTk.t_BofficeKind))) <> 0 "
         + "                          ) "
         + "                 ) or "
         + "                 (    RSB_SECUR.ISREPO(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(saleTk.t_DealType, saleTk.t_BofficeKind))) <> 0 "
         + "                  and RSB_SECUR.ISBUY(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(saleTk.t_DealType, saleTk.t_BofficeKind))) <> 0 "
         + "                 )"
         + "                ) "
         + "            and realBuyTK.t_DealId = buyLot.T_DealID "
         + "            and fin.t_FIID = buyLot.t_FIID "
         + "            and cur.t_FIID = fin.t_FaceValueFI "
         //+ "          group by lnk.t_CreateDate, saleTk.t_DealID, saleTk.t_DealCode, buyLot.t_Portfolio, buyLot.t_FIID, buyTk.t_DealID "
         + "        ) q "
         + "  ORDER BY q.t_CreateDate ASC, q.Account, q.BuyDealID, q.RealPortfolioID, q.AccountNewBD ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(fromDate); 
  cmd.AddParam(toDate); 
  if(FIID > 0)
    cmd.AddParam(FIID);
  end;
  
//Просто пустая шапка для задания размеров столбцов. Названия столбцов заполняются отдельной печатью
var StrHeader:string =
    "┌────┬──────────────┬────────────────────┬──────────────┬───────────────┬─────────────┬──────────────────────┬───────────┬─────────────────┬─────────────────┬────────────────────┬─────────────────────┬────────┬─────────────────┬─────────────────┬──────────────┬──────────────┬─────────────────────┬─────────────────┬─────────────────┬──────────────┬───────┬──────────────────────┬───────────────────┬────────┬────────┬─────────────────────┬──────────────────────┬──────────────────────┬───────────────────────┬──────────────────────┬──────────────────────┬────────────┬──────────────────────┬──────────────────────┬────────────┬──────────────────────┬──────────────────────┬────────────┬──────────────────────┬──────────────────────┐\n"
    "├────┼──────────────┼────────────────────┼──────────────┼───────────────┼─────────────┼──────────────────────┼───────────┼─────────────────┼─────────────────┼────────────────────┼─────────────────────┼────────┼─────────────────┼─────────────────┼──────────────┼──────────────┼─────────────────────┼─────────────────┼─────────────────┼──────────────┼───────┼──────────────────────┼───────────────────┼────────┼────────┼─────────────────────┼──────────────────────┼──────────────────────┼───────────────────────┼──────────────────────┼──────────────────────┼────────────┼──────────────────────┼──────────────────────┼────────────┼──────────────────────┼──────────────────────┼────────────┼──────────────────────┼──────────────────────┤";


    Rep = CMakeReport(StrHeader, SEP_DEFAULT, 60, 0 );
    Rep.SetHeader(StrHeader, Color_white);
    Rep.setFont("Arial Narrow", 10);

  
  var cnt = cmd.GetCount();
  var prevAccount = "";
  var prevPortfolio = -1;
  var prevBuyDealID = 0;
  var colorGreen  = 84+130*256+45*256*256;
  var colorBrown  = 131+60*256+12*256*256;
  var colorRed    = 255+0*256+102*256*256;
  var colorViolet = 112+48*256+176*256*256;
  var colorBlue   = 57+176*256+240*256*256;

  var colorBkGr      = 221+235*256+247*256*256;
  var colorYelowBkGr = 255+242*256+0*256*256;

  var AccArray = TArray();
  var DatePrev = ZeroDate;
  var CountAcc = 0;
  var IsFindAcc = false;

  if(cnt > 0)
    var i = 1;
    var j = 1;

    var FI_Code          = "";
    var SaleDealCode     = "";
    var BuyDealCode      = "";
    var CreateDate       = "";
    var Account          = "";
    var TotalAmount      = "";
    var LotBalanceCostBD = "";
    var prevRest         = "";
    var TrnSum           = "";
    var Diff             = "";
    var TSS              = "";
    var PortfolioName    = "";
    var TrnFR            = "";
    var TrnOverValue     = "";
    var Action           = "";
    

    Rep.AddPrintCell("Анализ данных", Rep.GetHeaderWidth() + 1, 0, "c:ex_FS(b)", REP_ELEM_STR);               
    Rep.AddStr();

    Rep.AddPrintCell(""                                                    ,  0, 0, "c:ex_FS(b)");
    Rep.AddPrintCell("Код ц/б"                                             ,  0, 0, "c:ex_FS(b)");
    Rep.AddPrintCell("Действие"                                            ,  0, 0, "c:ex_FS(b)");
    Rep.AddPrintCell("Код сделки продажи"                                  ,  0, 0, "c:ex_FS(b)");
    Rep.AddPrintCell("Дата исп. (дата списания)"                           ,  0, 0, "c:ex_FS(b)");
    Rep.AddPrintCell("ТСС на предыдущую дату"                              ,  0, 0, "c:ex_FS(b)");
    Rep.AddPrintCell("Номер счета -ОД"                                     ,  0, 0, "c:ex_FS(b):ex_FC("+colorGreen+")");
    Rep.AddPrintCell("Кол-во ц/б в продаже"                                ,  0, 0, "c:ex_FS(b)");
    Rep.AddPrintCell("Осн. долг на дату списания по лоту"                  ,  0, 0, "c:ex_FS(b):ex_FC("+colorGreen+")");
    Rep.AddPrintCell("Остаток на счете -ОД на начало дня"                  ,  0, 0, "c:ex_FS(b):ex_FC("+colorGreen+")");
    Rep.AddPrintCell("Сумма факт. проводки списания ОД"                    ,  0, 0, "c:ex_FS(b):ex_FC("+colorGreen+")");
    Rep.AddPrintCell("Расхождение (ОД по лоту минус сумма проводки)"       ,  0, 0, "c:ex_FS(b):ex_FC("+colorGreen+")");
    Rep.AddPrintCell("Портфель"                                            ,  0, 0, "c:ex_FS(b)");
    Rep.AddPrintCell("Кол-во ц/б в связи"                                  ,  0, 0, "c:ex_FS(b)");
    Rep.AddPrintCell("Сумма проводки по финрезу"                           ,  0, 0, "c:ex_FS(b):ex_FC("+colorViolet+")");
    Rep.AddPrintCell("Расчетный ФР по ОД лота"                             ,  0, 0, "c:ex_FS(b):ex_FC("+colorViolet+")");
    Rep.AddPrintCell("Код сделки покупки"                                  ,  0, 0, "c:ex_FS(b)");
    Rep.AddPrintCell("Номер счета, куда завешен ОД"                        ,  0, 0, "c:ex_FS(b)");
    Rep.AddPrintCell("Сумма проводки (фактическая)"                        ,  0, 0, "c:ex_FS(b):ex_FC("+colorRed+")");
    Rep.AddPrintCell("Сумма проводки (ожидаемая)"                          ,  0, 0, "c:ex_FS(b):ex_FC("+colorRed+")");
    Rep.AddPrintCell("Расхождение (ож. - факт.)"                           ,  0, 0, "c:ex_FS(b):ex_FC("+colorRed+")");
    Rep.AddPrintCell("ТСС"                                                 ,  0, 0, "c:ex_FS(b)");
    Rep.AddPrintCell("Сумма проводки по переоценке (суммарно по счету)"    ,  0, 0, "c:ex_FS(b):ex_FC("+colorBrown+")");
    Rep.AddPrintCell("Расчетная сумма переоценки (суммарно по счету)"      ,  0, 0, "c:ex_FS(b):ex_FC("+colorBrown+")");
    Rep.AddPrintCell("Валюта номинала"                                     ,  0, 0, "c:ex_FS(b)");
    Rep.AddPrintCell("Курс"                                                ,  0, 0, "c:ex_FS(b)");
    Rep.AddPrintCell("Корректировка переоценки ОД в рублях (счет R)"       ,  0, 0, "c:ex_FS(b):ex_FC("+colorBrown+")");
    Rep.AddPrintCell("Дт. исправления переоценки"                          ,  0, 0, "c:ex_FS(b):ex_FC("+colorBrown+")");
    Rep.AddPrintCell("Кт. исправления переоценки"                          ,  0, 0, "c:ex_FS(b):ex_FC("+colorBrown+")");
    Rep.AddPrintCell("Корректировка ОД при закрытии ОД (счет из колонки G)",  0, 0, "c:ex_FS(b):ex_FC("+colorGreen+")");
    Rep.AddPrintCell("Дт.исправления закрытия ОД"                          ,  0, 0, "c:ex_FS(b):ex_FC("+colorGreen+")");
    Rep.AddPrintCell("Кт. исправления закрытия ОД"                         ,  0, 0, "c:ex_FS(b):ex_FC("+colorGreen+")");
    Rep.AddPrintCell("Корректировка ФР по зкп"                             ,  0, 0, "c:ex_FS(b):ex_FC("+colorViolet+")");
    Rep.AddPrintCell("Дт. Корректировки ФР при ЗКП"                        ,  0, 0, "c:ex_FS(b):ex_FC("+colorViolet+")");
    Rep.AddPrintCell("Кт. Корректировки ФР при ЗКП"                        ,  0, 0, "c:ex_FS(b):ex_FC("+colorViolet+")");
    Rep.AddPrintCell("Корректировка ОД при открытии ОД (счет из колонки R)",  0, 0, "c:ex_FS(b):ex_FC("+colorRed+")");
    Rep.AddPrintCell("Дт. Корректировки при возникновении ОД"              ,  0, 0, "c:ex_FS(b):ex_FC("+colorRed+")");
    Rep.AddPrintCell("Кт. Корректировки при возникновении ОД"              ,  0, 0, "c:ex_FS(b):ex_FC("+colorRed+")");
    Rep.AddPrintCell("Добавление проводки по ФР"                           ,  0, 0, "c:ex_FS(b):ex_FC("+colorBlue+")");
    Rep.AddPrintCell("Дт добавления по ФР"                                 ,  0, 0, "c:ex_FS(b):ex_FC("+colorBlue+")");
    Rep.AddPrintCell("Кт добавления по ФР"                                 ,  0, 0, "c:ex_FS(b):ex_FC("+colorBlue+")");


    Rep.AddStr();

    
    InitProgress(cnt, "Просмотр связей", "Просмотр связей");

    DataSet = cmd.Execute();
    while(DataSet.moveNext())
      var CalcFR = 0.0; 
      var CalcOverValue = 0.0;
      var DiffOvervalue = 0.0;
      var DtOverAcc = "";
      var CtOverAcc = "";
      var DiffByCourse = 0.0;
      var DtDiffAcc = "";
      var CtDiffAcc = "";
      var CorrFR = 0.0;
      var DtCorrFR = "";
      var CtCorrFR = "";
      var DiffBDByCourse = 0.0;
      var DtDiffBD = "";
      var CtDiffBD = "";
      var AddTrnFR = 0.0;
      var DtAddTrnFR = "";
      var CtAddTrnFR = "";
      var FD;
      var addStyle = IIF(Mod(i,2) > 0, ":ex_BC("+colorBkGr+")", "");  
      var AccountR = "";
      
      if((DataSet.LotBalanceCostBD > 0) or (DataSet.LnkKind == PMWRTLINK_KIND_DISCARD))

        var TrnNewSum = IIF(ValType(DataSet.TrnNewSum)==V_UNDEF, DataSet.TrnNewSumUser, DataSet.TrnNewSum);
        var LnkBalanceCostBD = IIF(DataSet.NeedNewBD==1, DataSet.LnkBalanceCostBD, 0.0);

        if((ValType(DataSet.TrnNewSum)==V_UNDEF) and (DataSet.TrnNewSumUser != 0))
          addStyle = ":ex_BC("+colorYelowBkGr+")";  
        end;


        if((prevAccount != DataSet.Account) or (DataSet.Account == ""))
          FI_Code          = DataSet.FI_Code;
          SaleDealCode     = DataSet.SaleDealCode;
          BuyDealCode      = DataSet.BuyDealCode;
          CreateDate       = date(DataSet.CreateDate);
          TSS              = DataSet.TSSprev;
          PortfolioName    = DataSet.PortfolioName;
          TotalAmount      = DataSet.TotalAmount;
        
          TrnFR            = IIF(DataSet.PlusFR !=0.0, DataSet.PlusFR, IIF(DataSet.MinusFR !=0.0, -1*DataSet.MinusFR, 0.0)); 

          if(DataSet.LotBalanceCostBD > 0)
            Account          = DataSet.Account;
            LotBalanceCostBD = DataSet.LotBalanceCostBD;
            prevRest         = DataSet.prevRest;
            TrnSum           = DataSet.TrnSum;
            Diff             = DataSet.LotBalanceCostBD - DataSet.TrnSum;
            
            FD = SPFirstDoc(LEG_KIND_DL_TICK_BACK, DataSet.DealID );
          
            CalcFR = GetSumFR( FD, date(DataSet.CreateDate), DataSet.Portfolio );
          else
            SaleDealCode     = DataSet.SaleDealCode;
            BuyDealCode      = DataSet.BuyDealCode;
            CreateDate       = date(DataSet.CreateDate);                   
            Account          = "";                   
            LotBalanceCostBD = "";                   
            prevRest         = "";                   
            TrnSum           = "";                   
            Diff             = "";                   
            CalcFR           = "";

            LnkBalanceCostBD = IIF(DataSet.NeedNewBD==1, DataSet.BalanceCostBuy, 0.0);      
          end;
        else
            FI_Code          = DataSet.FI_Code;

          BuyDealCode      = DataSet.BuyDealCode;

          if(DataSet.LnkKind == PMWRTLINK_KIND_DISCARD)
            TotalAmount      = DataSet.TotalAmount;
            LnkBalanceCostBD = IIF(DataSet.NeedNewBD==1, DataSet.BalanceCostBuy, 0.0);
          else
            TotalAmount      = "";
          end;

            SaleDealCode     = DataSet.SaleDealCode;
            CreateDate       = date(DataSet.CreateDate);
          
          Account          = "";
          
          LotBalanceCostBD = "";
          prevRest         = "";
          TrnSum           = "";
          Diff             = "";
          TSS              = "";
          PortfolioName    = DataSet.PortfolioName;
          CalcFR           = "";

          if(prevPortfolio == DataSet.Portfolio)
            PortfolioName = "";
            TrnFR = "";
          else
            FD = SPFirstDoc(LEG_KIND_DL_TICK_BACK, DataSet.DealID );
        
            CalcFR = GetSumFR( FD, date(DataSet.CreateDate), DataSet.Portfolio );

            TrnFR  = IIF(DataSet.PlusFR !=0.0, DataSet.PlusFR, IIF(DataSet.MinusFR !=0.0, -1*DataSet.MinusFR, 0.0));
            
          end;
        end;

        var DiffBD = LnkBalanceCostBD - TrnNewSum;

        Action = "";
        if((DataSet.Account == "") and (DataSet.AccountNewBD != ""))
          Action = "Прямая продажа из ОРЕПО";
          if(DataSet.BuyIsPREPO == 1)
            Action = "ОРЕПО закрывается на ПРЕПО";
          end;
        elif((DataSet.Account != "") and (DataSet.AccountNewBD != "") and (DataSet.NeedNewBD==1))
          Action = "ОРЕПО закрывается на ОРЕПО";
        elif((DataSet.Account != "") and ((DataSet.AccountNewBD == "") or (DataSet.NeedNewBD!=1)))
          Action = "ОРЕПО закрывается на покупку";
          if(DataSet.BuyIsPREPO == 1)
            Action = "ОРЕПО закрывается на ПРЕПО";
          elif(DataSet.BuyDealID == DataSet.DealID)
            Action = "ОРЕПО закрывается на себя"; 
          end;
        else
          Action = "ОРЕПО закрывается на себя";
        end;

        TrnOverValue     = IIF(DataSet.PlusOvervl !=0.0, DataSet.PlusOvervl, IIF(DataSet.MinusOvervl !=0.0, -1*DataSet.MinusOvervl, 0.0));
        if((ValType(DataSet.TrnNewSum)==V_UNDEF) and (DataSet.TrnNewSumUser != 0) and (DataSet.TrnOverSumUser != 0) and (TrnOverValue == 0.0))
          TrnOverValue = DataSet.TrnOverSumUser;
        end;

        CalcOverValue = IIF(DataSet.NeedNewBD==1, DataSet.TSSToday*DataSet.TotalBuyDealAmountBD - DataSet.PrevTotalBuyBalanceCostBD - DataSet.TotalLnkBalanceCostBD, "");

        if(date(DataSet.Buy2Date) == date(DataSet.CreateDate))
          CalcOverValue = 0.0; 
        else
          if(CalcOverValue != "")
            if( SmartConvertSum(CalcOverValue, money(round(CalcOverValue,2)), date(DataSet.CreateDate), DataSet.FaceValueFI, NATCUR, true) == false )
              return 0;
            end;
          end; 
        end;

        if(CalcOverValue != "")
          DiffOvervalue = CalcOverValue - TrnOverValue;
        end;


        if(DiffOvervalue != 0)
          if(DiffOvervalue > 0)
            DtOverAcc = "70606";
            CtOverAcc = IIF(DataSet.NeedNewBD==1, DataSet.AccountNewBD, "");
          else
            DtOverAcc = IIF(DataSet.NeedNewBD==1, DataSet.AccountNewBD, "");
            CtOverAcc = "70601";
          end;
        end;

        if(Diff != "")
          DiffByCourse = Diff * DataSet.Course;
        end;

        if(DiffByCourse != 0)
          if(DiffByCourse > 0 )
            DtDiffAcc = DataSet.Account;
            CtDiffAcc = DataSet.RealizAccount;
          else
            DtDiffAcc = DataSet.RealizAccount;
            CtDiffAcc = DataSet.Account;
          end;
        end;

        if(TrnFR != "")
          CorrFR = TrnFR;
          if(CalcFR != "")
            CorrFR = CorrFR - CalcFR; 
          end;
        end;

        if(Action == "Прямая продажа из ОРЕПО")
            CorrFR   = 0.0;
            DtCorrFR = "";
            CtCorrFR = "";
        else
            CorrFR = -CorrFR; // меняем знак в поле 33 //278374 п.4
        end;

        if(CorrFR != 0)
          if(CorrFR > 0)
            DtCorrFR = DataSet.RealizAccount;
            CtCorrFR = "70601";
          else
            DtCorrFR = "70606";
            CtCorrFR = DataSet.RealizAccount;
          end;

        end;

        if(DiffBD != "")
          DiffBDByCourse = DiffBD * DataSet.Course;
        end;

        if(DiffBDByCourse != 0)
          if(DiffBDByCourse > 0)
            DtDiffBD = DataSet.RealizAccount;
            CtDiffBd = IIF(DataSet.NeedNewBD==1, DataSet.AccountNewBD, "");
          else
            DtDiffBD = IIF(DataSet.NeedNewBD==1, DataSet.AccountNewBD, "");
            CtDiffBd = DataSet.RealizAccount;
          end;
        end;

        if(Action == "Прямая продажа из ОРЕПО")
          AddTrnFR = -DiffBDByCourse;
        end;

        if(AddTrnFR != 0)
          if(AddTrnFR > 0)
            DtAddTrnFR = DataSet.RealizAccount;
            CtAddTrnFR = "70601";
          else
            DtAddTrnFR = "70606";
            CtAddTrnFR = DataSet.RealizAccount;
          end;
        end;
        AccountR = IIF(DataSet.NeedNewBD==1, DataSet.AccountNewBD, "");

        if (CreateDate != DatePrev )   // 278374 п.6 
           AccArray.Size = 0;
        end;
        CountAcc = 0;
        IsFindAcc = false;
        while( AccArray.Size > CountAcc)
          if(AccArray[CountAcc] == AccountR)
            IsFindAcc = true;
          end;
          CountAcc = CountAcc + 1;
        end;

        if( IsFindAcc )
           DiffOvervalue = "";
           DtOverAcc = "";
           CtOverAcc = "";
        elif(AccountR != "")
           AccArray[AccArray.Size] = AccountR; 
        end;

        DatePrev = CreateDate;

        Rep.AddPrintCell(j                      ,  0, 0, "c"+addStyle);
        Rep.AddPrintCell(FI_Code                ,  0, 0, "c"+addStyle);
        Rep.AddPrintCell(Action                 ,  0, 0, "c"+addStyle);
        Rep.AddPrintCell(SaleDealCode           ,  0, 0, "c"+addStyle);
        //Дата списания
        Rep.AddPrintCell(CreateDate             ,  0, 0, "c"+addStyle);
        Rep.AddPrintCell(TSS                    ,  0, 4, "c"+addStyle);
        Rep.AddPrintCell(Account                ,  0, 0, "c:ex_FC("+colorGreen+")"+addStyle);
        Rep.AddPrintCell(TotalAmount            ,  0, 0, "c"+addStyle);
        Rep.AddPrintCell(LotBalanceCostBD       ,  0, 2, "c:ex_FC("+colorGreen+")"+addStyle);
        Rep.AddPrintCell(prevRest               ,  0, 2, "c:ex_FC("+colorGreen+")"+addStyle);
        Rep.AddPrintCell(TrnSum                 ,  0, 2, "c:ex_FC("+colorGreen+")"+addStyle);
        Rep.AddPrintCell(Diff                   ,  0, 2, "c:ex_FC("+colorGreen+")"+addStyle);
        Rep.AddPrintCell(PortfolioName          ,  0, 0, "c"+addStyle);
        Rep.AddPrintCell(DataSet.LnkAmount      ,  0, 0, "c"+addStyle);
        Rep.AddPrintCell(TrnFR                  ,  0, 2, "c:ex_FC("+colorViolet+")"+addStyle);
        Rep.AddPrintCell(CalcFR                 ,  0, 2, "c:ex_FC("+colorViolet+")"+addStyle);
        Rep.AddPrintCell(BuyDealCode            ,  0, 0, "c"+addStyle);
        Rep.AddPrintCell(AccountR               ,  0, 0, "c"+addStyle);
        Rep.AddPrintCell(TrnNewSum              ,  0, 2, "c:ex_FC("+colorRed+")"+addStyle);                 
        Rep.AddPrintCell(LnkBalanceCostBD       ,  0, 2, "c:ex_FC("+colorRed+")"+addStyle);                 
        Rep.AddPrintCell(DiffBD                 ,  0, 2, "c:ex_FC("+colorRed+")"+addStyle);
        Rep.AddPrintCell(DataSet.TSSToday       ,  0, 2, "c"+addStyle);                 
        Rep.AddPrintCell(TrnOverValue           ,  0, 2, "c:ex_FC("+colorBrown+")"+addStyle);
        Rep.AddPrintCell(CalcOverValue          ,  0, 2, "c:ex_FC("+colorBrown+")"+addStyle);
        //Валюта номинала
        Rep.AddPrintCell(DataSet.FaceValueFICode,  0, 0, "c"+addStyle);
        //Курс
        Rep.AddPrintCell(DataSet.Course         ,  0, 4, "c"+addStyle);
        //Корректировка переоценки ОД в рублях (счет G)
        Rep.AddPrintCell(DiffOvervalue          ,  0, 2, "c:ex_FC("+colorBrown+")"+addStyle);
        //Дт. исправления переоценки
        Rep.AddPrintCell(DtOverAcc              ,  0, 0, "c:ex_FC("+colorBrown+")"+addStyle);
        //Кт. исправления переоценки
        Rep.AddPrintCell(CtOverAcc              ,  0, 0, "c:ex_FC("+colorBrown+")"+addStyle);
        //Корректировка ОД при закрытии ОД (счет из колонки G)
        Rep.AddPrintCell(DiffByCourse           ,  0, 2, "c:ex_FC("+colorGreen+")"+addStyle);
        //Дт.исправления закрытия ОД
        Rep.AddPrintCell(DtDiffAcc              ,  0, 0, "c:ex_FC("+colorGreen+")"+addStyle);
        //Кт. исправления закрытия ОД
        Rep.AddPrintCell(CtDiffAcc              ,  0, 0, "c:ex_FC("+colorGreen+")"+addStyle);
        //Корректировка ФР по зкп
        Rep.AddPrintCell(CorrFR                 ,  0, 2, "c:ex_FC("+colorViolet+")"+addStyle);
        //Дт. Корректировки ФР при ЗКП
        Rep.AddPrintCell(DtCorrFR               ,  0, 0, "c:ex_FC("+colorViolet+")"+addStyle);
        //Кт. Корректировки ФР при ЗКП
        Rep.AddPrintCell(CtCorrFR               ,  0, 0, "c:ex_FC("+colorViolet+")"+addStyle);
        //Корректировка ОД при открытии ОД (счет из колонки R)
        Rep.AddPrintCell(DiffBDByCourse         ,  0, 2, "c:ex_FC("+colorRed+")"+addStyle);
        //Дт. Корректировки при возникновении ОД
        Rep.AddPrintCell(DtDiffBD               ,  0, 0, "c:ex_FC("+colorRed+")"+addStyle);
        //Кт. Корректировки при возникновении ОД
        Rep.AddPrintCell(CtDiffBD               ,  0, 0, "c:ex_FC("+colorRed+")"+addStyle);
        //Добавление проводки по ФР
        Rep.AddPrintCell(AddTrnFR               ,  0, 2, "c:ex_FC("+colorBlue+")"+addStyle);
        //Дт. добавления по ФР
        Rep.AddPrintCell(DtAddTrnFR             ,  0, 0, "c:ex_FC("+colorBlue+")"+addStyle);
        //Кт. добавления по ФР
        Rep.AddPrintCell(CtAddTrnFR             ,  0, 0, "c:ex_FC("+colorBlue+")"+addStyle);


        Rep.AddStr();

        Rep.SetExecuteRowSize(1, j+2, 1);
        
        j = j + 1;
      end;

      prevAccount   = DataSet.Account;
      prevPortfolio = DataSet.Portfolio;
      prevBuyDealID = DataSet.BuyDealID;

      UseProgress(i = i + 1);
    end;

    RemProgress();

  else
    Rep.AddPrintCell("Нет подходящих сделок ОРЕПО в периоде с " + string(fromDate:f) + " по текущую дату", 200 + 1, 0, "l:ex_FS(b)", REP_ELEM_STR);
  end;

  Rep.PrintWinRep(); 
  Rep.ShowWinRep();

end;


macro ReportRun()
  var buyrepo_Form = buyrepo_Form_Panel();
  if( buyrepo_Form.Run())
    BuyRepoBDCheck(buyrepo_Form.FIID,buyrepo_Form.BegDate, buyrepo_Form.EndDate);
  end;
end;  

ReportRun();
exit(1);