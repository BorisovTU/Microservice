/*BPV просмотр лога миграции*/
import RSD, globals;

const K_ENTER   = 13;
//const K_ESC     = 27;
const K_F3      = 317;
const K_F2      = 316;
const K_F8      = 322;
const K_F9      = 323;


PRIVATE MACRO AddCol (ar,ind, fld, head, width, rdonly, ty, dp)
   ar.value (ind * 6)     = fld;
   ar.value (ind * 6 + 1) = head;
   ar.value (ind * 6 + 2) = width;
   ar.value (ind * 6 + 3 ) = rdonly;   // fldType
   ar.value (ind * 6 + 4 ) = dp;//   decPoint
   ar.value (ind * 6 + 5 ) = 0;   // reserv
END;

var shift = "", kind = 0, logid = -1;

macro Scroll
   var cmd1, rs1, col1, need = true,Column = TArray(),i, ColumnValue, ColumnName, NumColumns = 0, cond = "";

   macro EvProc2(rs, cmd, id, key)
     var  CM_DEFAULT = null;
     if ((cmd == DLG_KEY)and(key == K_ENTER))
        if (rs.RecCount > 0)
          return CM_SELECT;
        end;
     end;
     return CM_DEFAULT;
  end;

   macro EvProc(rs, cmd, id, key)
     var  CM_DEFAULT = null;
//msgbox(key);
     if ((cmd == DLG_KEY)and(key == K_ENTER))
       /* if (rs.RecCount > 0)
          return CM_SELECT;
        end;*/
      elif ((cmd == DLG_KEY)and(key == K_F3) and ({oper} == 1))
         if (rs.value("t_servkindsub") == 9)
           shift = rs.value("ekk");
         else
           shift = rs.value("t_mpcode");
         end;
         if (GetString(shift,"Новый номер") )
            /*bpv код на субъекте уже не должен нигде испоьлхзоваться, но на всякий случай обновляем*/
            var cmd1;
            if (rs.value("ekk"))
               cmd1 = rsdcommand(" update dobjcode_dbt set t_code = '"+shift+"' where t_objectid = "+ 
                              rs.value("t_partyid")+" and t_objecttype = 3 and t_codekind = 8 and t_code = '" + rs.value("ekk")+"'");
               cmd1.execute();
            end;
            /*код апдейтим только на биржевом фондового рынка*/
            if ((rs.value("t_servkindsub") == 8) and (rs.value("t_servkind") == 1))
               cmd1 = rsdcommand(" update ddlcontrmp_dbt set t_mpcode = '"+shift+"' where t_dlcontrid = "+ rs.value("t_dlcontrid")+" and t_sfcontrid = " + rs.value("t_id"));
               cmd1.execute();
            end;
            cmd1 = rsdcommand(" update ddlobjcode_dbt set t_code = '"+shift+"' where t_objectid = "+ rs.value("t_dlcontrid")+" and t_codekind = 1 /*and t_state = 0*/ and t_objecttype = 207 " );
            cmd1.execute();
            need = true;
            return 2;
           end;
      elif ((cmd == DLG_KEY)and(key == 18))
         cond = "";
         need = true;
         return 2;
      elif ((cmd == DLG_KEY)and(key == K_ESC))
         return 2;
      end;

     return CM_DEFAULT;
   end;

   col1 = TArray;   
   var arnum = -1;
   AddCol (col1, arnum=arnum+1, "T_MPCODE",        "Краткий код на бирже",   8 ,  0,0);
   AddCol (col1, arnum=arnum+1, "EKK",        "EKK",   8 ,  0,0);
   AddCol (col1, arnum=arnum+1, "T_NUMBER",        "Номер",    18,  0,0);
   AddCol (col1, arnum=arnum+1, "T_NAME",     "Наименование",    30, 0);
   AddCol (col1, arnum=arnum+1, "T_DATEBEGIN",     "Дата заключения",    8, 0);
   AddCol (col1, arnum=arnum+1, "risk",     "Уровень риска",    8, 0);
//   AddCol (col1, arnum=arnum+1, "deponum",     "Договор депо",    12, 0);
   AddCol (col1, arnum=arnum+1, "T_id",     "sfid",    6, 0);
   AddCol (col1, arnum=arnum+1, "T_dlcontrid",     "dlid",    5, 0);
   AddCol (col1, arnum=arnum+1, "T_partyid",     "pid",    5, 0);
   while (need)
      need = false;
      cmd1 = " select dsf.t_datebegin, mp.t_mpcode, (select t_code from ddlobjcode_dbt where t_objecttype = 207 and t_objectid = mp.t_dlcontrid and t_codekind = 1 ) ekk, sf.t_number, sf.t_name, sf.t_id, sf.t_partyid, sf.t_servkind, sf.t_servkindsub," + 
" (SELECT a.t_name " +
"  FROM dobjatcor_dbt t, dobjattr_dbt a " +
" WHERE     T.T_OBJECT = LPAD (d.t_dlcontrid, 34, '0') " +
"       AND t.t_groupid = 103                  " +
"       AND t.t_objecttype = 207               " +
"       AND t.t_groupid = a.t_groupid          " +
"       AND t.t_objecttype = a.t_objecttype    " +
"       AND a.t_attrid = t.t_attrid ) risk,           " +
             //" (select replace(rsb_struct.getchar(t_text),chr(0)) from dnotetext_dbt where t_objecttype = 207 and t_notekind = 102 and t_documentid = lpad(mp.t_dlcontrid,34,'0')) deponum , " + 
             " mp.t_dlcontrid from ddlcontrmp_dbt mp, dsfcontr_dbt sf, ddlcontr_dbt d, dsfcontr_dbt dsf where mp.t_sfcontrid = sf.t_id and mp.t_dlcontrid = d.t_dlcontrid and d.t_sfcontrid = dsf.t_id";
 
      cmd1 = RSDCommand(cmd1);
      rs1 = RSDRecordset(cmd1 , null, RSDVAL_STATIC );


      if (RunScroll (rs1,col1.size/6, col1, "test" ,"EvProc"," Краткие коды на бирже"," ", true, 1, 1))
       //   return rs1;
      end;
   end;

return null;

end;

Scroll;
exit(1);
