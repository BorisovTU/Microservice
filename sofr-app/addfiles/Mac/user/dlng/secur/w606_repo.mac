/*
$Name:        w606_repo.mac
$Module:      Ценные бумаги
$Description: Формирование данных для ЦКРР (Репо)
$Programmer:  Кротов А.
*/
import rsd, captureoutput;

/*Репо. Только открытые сделки обратного репо на дату выгрузки*/
macro RecordSetREPO(dt)
  var cmd;
  /*Чистим и наполняем GT данными*/
  StartCaptureOutput();
  [ 
    declare 
      type Type_W606 is table of DW606_U_TMP%rowtype;
      Coll_W606 Type_W606 := Type_W606();
      dt date := ?;--to_date('02.06.2016','dd.mm.yyyy');
    begin
      -- Удаляем данные за дату (если есть)
      delete from DW606_U_TMP where t_TypeFI = 'РЕПО';

      -- Проходим по сделкам обратного РЕПО
      for v in (select TypeFI,
                       TypeIssuer,
                       ReportDate,
                       RSI_RSB_FIInstr.ConvSum(BalanceDebt, CurrencyID, 0, dt, 1) BalanceDebt, 
                       nvl(fininstr.t_ccy, chr(1)) Currency,
                       FIID, 
                       ISIN, 
                       DealID, 
                       BuyDate, 
                       MaturityDate, 
                       IssuerId, 
                       ContractorId, 
                       IssuerINN, 
                       ContractorINN, 
                       IssuetName, 
                       ContractorName, 
                       Expiration, 
                       RatingDate, 
                       RatingFirst, 
                       RatingCurrent, 
                       RatingSource, 
                       CollateralValue, 
                       AccountNumber, 
                       SWIFT, 
                       case when YearsToMaturity > 0 then YearsToMaturity else 0 end YearsToMaturity, 
                       SPPI, 
                       BusinessModel, 
                       EvaluationCategory 
                from (select 'РЕПО' TypeFI, 
                             case when (select count(1) 
                                        from dpartyown_dbt partyown 
                                        where partyown.t_partyid = deal.t_contractorid and 
                                              partyown.t_partykind = 2/*Банком*/) > 0 then 'FINANCIAL' 
                                  else 'CORPORATE' end TypeIssuer, 
                             dt ReportDate, 
                             (select nvl(sum(dlrq.t_amount),0) 
                              from ddlrq_dbt dlrq 
                              where dlrq.t_dockind = deal.t_bofficekind and 
                                    dlrq.t_docid = deal.t_dealid and 
                                    dlrq.t_dealpart = 2 and /*2-ая часть*/
                                    dlrq.t_kind = 0 and /*DLRQ_KIND_REQUEST*/ 
                                    dlrq.t_subkind = 0 and /*DLRQ_SUBKIND_CURRENCY*/ 
                                    dlrq.t_type in (2/*DLRQ_TYPE_PAYMENT*/, 3/*DLRQ_TYPE_INCREPO*/)) BalanceDebt, 
                             (select nvl(max(dlrq.t_fiid),-1) 
                              from ddlrq_dbt dlrq 
                              where dlrq.t_dockind = deal.t_bofficekind and 
                                    dlrq.t_docid = deal.t_dealid and 
                                    dlrq.t_dealpart = 2 and /*2-ая часть*/
                                    dlrq.t_kind = 0 and /*DLRQ_KIND_REQUEST*/ 
                                    dlrq.t_subkind = 0 and /*DLRQ_SUBKIND_CURRENCY*/ 
                                    dlrq.t_type in (2/*DLRQ_TYPE_PAYMENT*/, 3/*DLRQ_TYPE_INCREPO*/)) CurrencyID, 
                             chr(1) FIID, 
                             chr(1) ISIN, 
                             deal.t_dealcode DealID, 
                             (select nvl(max(dlrq.t_factdate),to_date('01.01.0001','dd.mm.yyyy')) 
                              from ddlrq_dbt dlrq 
                              where dlrq.t_dockind = deal.t_bofficekind and
                                    dlrq.t_docid = deal.t_dealid and 
                                    dlrq.t_dealpart = 1 and /*1-ая часть*/
                                    dlrq.t_kind = 0 and /*DLRQ_KIND_REQUEST*/ 
                                    dlrq.t_subkind = 1 and /*DLRQ_SUBKIND_AVOIRISS*/ 
                                    dlrq.t_type = 8 /*DLRQ_TYPE_DELIVERY*/) BuyDate, 
                             (select nvl(max(case when dlrq.t_factdate != to_date('01.01.0001','dd.mm.yyyy') and 
                                                       dlrq.t_factdate != dt then dlrq.t_factdate 
                                                  else dlrq.t_plandate end), to_date('01.01.0001','dd.mm.yyyy')) 
                              from ddlrq_dbt dlrq 
                              where dlrq.t_dockind = deal.t_bofficekind and
                                    dlrq.t_docid = deal.t_dealid and 
                                    dlrq.t_dealpart = 2 and /*2-ая часть*/
                                    dlrq.t_kind = 0 and /*DLRQ_KIND_REQUEST*/ 
                                    dlrq.t_subkind = 0 and /*DLRQ_SUBKIND_CURRENCY*/ 
                                    dlrq.t_type = 2/*DLRQ_TYPE_PAYMENT*/) MaturityDate, 
                             chr(1) IssuerId, 
                            (select nvl(max(objcode.t_code),chr(1)) 
                             from dobjcode_dbt objcode 
                             where objcode.t_objecttype = 3 and 
                                   objcode.t_codekind = 101/*КОД В БИСКВИТ*/ and 
                                   objcode.t_objectid = deal.t_contractorid and 
                                   objcode.t_bankdate < dt and 
                                   (objcode.t_bankclosedate = to_date('01.01.0001','dd.mm.yyyy') or objcode.t_bankclosedate >= dt)) ContractorId, 
                            chr(1) IssuerINN, 
                            (select nvl(regexp_substr(max(objcode.t_code),'^\d{0,}'),chr(1)) 
                             from dobjcode_dbt objcode 
                             where objcode.t_objecttype = 3 and 
                                   objcode.t_codekind = 16/*ИНН*/ and 
                                   objcode.t_objectid = deal.t_contractorid and 
                                   objcode.t_bankdate < dt and 
                                   (objcode.t_bankclosedate = to_date('01.01.0001','dd.mm.yyyy') or objcode.t_bankclosedate >= dt)) ContractorINN, 
                            chr(1) IssuetName, 
                            contractor.t_name ContractorName, 
                            (select nvl(rsi_rsbcalendar.getWorkDayCount(nvl(max(case when dlrq.t_factdate = to_date('01.01.0001','dd.mm.yyyy') or dlrq.t_factdate > dt then dlrq.t_plandate else dt end),dt), dt-1), 0) 
                             from ddlrq_dbt dlrq 
                             where dlrq.t_dockind = deal.t_bofficekind and
                                   dlrq.t_docid = deal.t_dealid and 
                                   dlrq.t_dealpart = 2 and /*2-ая часть*/
                                   dlrq.t_kind = 0 and /*DLRQ_KIND_REQUEST*/ 
                                   dlrq.t_subkind = 0 and /*DLRQ_SUBKIND_CURRENCY*/ 
                                   dlrq.t_type = 2/*DLRQ_TYPE_PAYMENT*/) Expiration, 
                            to_date('01.01.0001','dd.mm.yyyy') RatingDate, 
                            chr(1) RatingFirst, 
                            chr(1) RatingCurrent, 
                            chr(1) RatingSource, 
                            (select case when deal.t_facevaluefi = 0 then nvl(sum(rsi_rsb_fiinstr.ConvSumType(dlrq.t_amount, deal.t_pfi, deal.t_facevaluefi, 1/*Рыночная цена*/, dt, 1)),0) 
                                         else RSI_RSB_FIInstr.ConvSum(nvl(sum(rsi_rsb_fiinstr.ConvSumType(dlrq.t_amount, deal.t_pfi, deal.t_facevaluefi, 1/*Рыночная цена*/, dt, 1)),0), deal.t_facevaluefi, 0, dt, 1) end
                             from ddlrq_dbt dlrq 
                             where dlrq.t_dockind = deal.t_bofficekind and
                                   dlrq.t_docid = deal.t_dealid and 
                                   dlrq.t_dealpart = 1 and /*1-ая часть*/
                                   dlrq.t_kind = 0 and /*DLRQ_KIND_REQUEST*/ 
                                   dlrq.t_subkind = 1 and /*DLRQ_SUBKIND_AVOIRISS*/ 
                                   dlrq.t_type = 8 /*DLRQ_TYPE_DELIVERY*/) CollateralValue, 

                            /* ВР */
                            (SELECT m.t_account 
                             FROM dmcaccdoc_dbt m
                             WHERE m.t_catnum = 603 and m.t_dockind = 176 and m.t_docid = dl_leg.t_id and m.t_isusable = chr(88)
                            ) AccountNumber, 

                            (select nvl(max(objcode.t_code),chr(1)) 
                             from dobjcode_dbt objcode 
                             where objcode.t_objecttype = 3 and 
                                   objcode.t_codekind = 6/*BIC ISO (SWIFT)*/ and 
                                   objcode.t_objectid = deal.t_contractorid and 
                                   objcode.t_bankdate < dt and 
                                   (objcode.t_bankclosedate = to_date('01.01.0001','dd.mm.yyyy') or objcode.t_bankclosedate >= dt)) SWIFT, 
                           (select round(months_between(nvl(max(case when dlrq.t_factdate != to_date('01.01.0001','dd.mm.yyyy') and dlrq.t_factdate < dt then dlrq.t_factdate else dlrq.t_plandate end),dt), dt-1)/12,12) 
                            from ddlrq_dbt dlrq 
                            where dlrq.t_dockind = deal.t_bofficekind and
                                  dlrq.t_docid = deal.t_dealid and 
                                  dlrq.t_dealpart = 2 and /*2-ая часть*/
                                  dlrq.t_kind = 1 and /*DLRQ_KIND_COMMIT*/ 
                                  dlrq.t_subkind = 1 and /*DLRQ_SUBKIND_AVOIRISS*/ 
                                  dlrq.t_type = 8 /*DLRQ_TYPE_DELIVERY*/) YearsToMaturity, 
                           'Да' SPPI, 
                           '1' BusinessModel, 
                           'АС' EvaluationCategory 
                      from (select dt, 
                                   dl_tick.t_dealid t_dealid, 
                                   dl_tick.t_bofficekind t_bofficekind,
                                   dl_tick.t_dealcode t_dealcode, 
                                   dl_tick.t_pfi t_pfi, 
                                   nvl(fininstr.t_facevaluefi, 0) t_facevaluefi, 
                                   nvl(contractor.t_partyid, 29/*ЗАО АКБ НКЦ*/) t_contractorid 
                            from ddl_tick_dbt dl_tick 
                            join doproper_dbt oproper on oproper.t_dockind = dl_tick.t_bofficekind and 
                                                         oproper.t_kind_operation = dl_tick.t_dealtype and 
                                                         oproper.t_documentid = lpad(dl_tick.t_dealid,34,'0') and 
                                                         oproper.t_start_date != to_date('01.01.0001','dd.mm.yyyy') and
                                                         oproper.t_start_date < dt
                            left join dparty_dbt contractor on contractor.t_partyid = dl_tick.t_partyid 
                            left join dfininstr_dbt fininstr on fininstr.t_fiid = dl_tick.t_pfi 
                            left join dfininstr_dbt fininstrface on fininstrface.t_fiid = fininstr.t_facevaluefi 
                            where dl_tick.t_bofficekind = 101 /*DL_SECURITYDOC*/ and 

                                  dl_tick.t_clientid = -1 and /* ВР */

                                  rsb_secur.IsRepo(rsb_secur.get_operationgroup(rsb_secur.get_opersystypes(dl_tick.t_dealtype, dl_tick.t_bofficekind))) != 0 and 
                                  rsb_secur.IsBuy(rsb_secur.get_operationgroup(rsb_secur.get_opersystypes(dl_tick.t_dealtype, dl_tick.t_bofficekind))) != 0 and 
                                  (dl_tick.t_dealstatus = 10/*Открытая*/ or dl_tick.t_closedate >= dt)) deal 

                            join ddl_leg_dbt dl_leg on dl_leg.t_dealid = deal.t_dealid /* ВР */

                            join dparty_dbt contractor on contractor.t_partyid = deal.t_contractorid ) deal 
                left join dfininstr_dbt fininstr on fininstr.t_fiid = deal.CurrencyID
                where deal.AccountNumber <> chr(0)) /* ВР */

      loop
        -- Добавляем значение в коллекцию
        Coll_W606.extend();
        Coll_W606(Coll_W606.last).t_TypeFI := v.TypeFI;
        Coll_W606(Coll_W606.last).t_TypeIssuer := v.TypeIssuer;
        Coll_W606(Coll_W606.last).t_ReportDate := v.ReportDate;
        Coll_W606(Coll_W606.last).t_BalanceDebt := v.BalanceDebt;
        Coll_W606(Coll_W606.last).t_Currency := v.Currency;
        Coll_W606(Coll_W606.last).t_FIID := v.FIID;
        Coll_W606(Coll_W606.last).t_ISIN := v.ISIN;
        Coll_W606(Coll_W606.last).t_DealID := v.DealID;
        Coll_W606(Coll_W606.last).t_BuyDate := v.BuyDate;
        Coll_W606(Coll_W606.last).t_MaturityDate := v.MaturityDate;
        Coll_W606(Coll_W606.last).t_IssuerId := v.IssuerId;
        Coll_W606(Coll_W606.last).t_ContractorId := v.ContractorId;
        Coll_W606(Coll_W606.last).t_IssuerINN := v.IssuerINN;
        Coll_W606(Coll_W606.last).t_ContractorINN := v.ContractorINN;
        Coll_W606(Coll_W606.last).t_IssuetName := v.IssuetName;
        Coll_W606(Coll_W606.last).t_ContractorName := v.ContractorName;
        Coll_W606(Coll_W606.last).t_Expiration := v.Expiration;
        Coll_W606(Coll_W606.last).t_RatingDate := v.RatingDate;
        Coll_W606(Coll_W606.last).t_RatingFirst := v.RatingFirst;
        Coll_W606(Coll_W606.last).t_RatingCurrent := v.RatingCurrent;
        Coll_W606(Coll_W606.last).t_RatingSource := v.RatingSource;
        Coll_W606(Coll_W606.last).t_CollateralValue := v.CollateralValue;
        Coll_W606(Coll_W606.last).t_AccountNumber := v.AccountNumber;
        Coll_W606(Coll_W606.last).t_SWIFT := v.SWIFT;
        Coll_W606(Coll_W606.last).t_YearsToMaturity := v.YearsToMaturity;
        Coll_W606(Coll_W606.last).t_SPPI := v.SPPI;
        Coll_W606(Coll_W606.last).t_BusinessModel := v.BusinessModel;
        Coll_W606(Coll_W606.last).t_EvaluationCategory := v.EvaluationCategory;
      end loop;

      -- Сохраняем коллекцию
      forall i in Coll_W606.first .. Coll_W606.last
        insert into DW606_U_TMP values Coll_W606(i);

    end;
  ];
  cmd = RSDCommand(EndCaptureOutput());
  cmd.AddParam("dt", RSDBP_IN, dt);
  cmd.Execute();
end;
