/*
ndfl_out.mac
*/
import globals, or_rep_h, oralib, likepy, cb_sql;

macro ndfl_data_rep ()
  var EXCEL_MONEY = "\"# ##0,00\"";
  var repdt = {curdate};
  var rn    = 0;
  var sheet = 1;
  var count = 0;
  var col1_len = 10;
  var col2_len = 10;
  var col3_len = 12;
  var col4_len = 20;
  var col5_len = 7;
  var col6_len = 14;
  var col7_len = 20;
  var col8_len = 7;
  var col9_len = 14;
  var col10_len = 10;
  var col11_len = 3;
  var col12_len = 5;
  var col13_len = 15;
  var col14_len = 10;
  var col15_len = 10;
  var Rep, sql;

/*  if (not GetDate(repdt)) 
    return 1;
  end;
*/
  Rep = CMakeReport("┌┬┬┬┬┬┬┬┬┬┬┬┐");
  Rep.SetDefaultFontName("Times New Roman");
  Rep.SetDefaultFontSize(10);
  Rep.SetFlagShowGrid(true);

  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(6).NumberFormat = "+EXCEL_MONEY+";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(9).NumberFormat = "+EXCEL_MONEY+";");

  rn = rn + 1;
  Rep.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
  Rep.AddPrintCell("Данные НДФЛ" + repdt, col1_len, null, "l:ex_FS(b):ex_B(tblr)");
  Rep.AddStr();
  
  rn = rn + 1;
  Rep.AddPrintCell("Внешний номер",             col1_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Номер",          col2_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Дата",          col2_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Наименование цб",          col3_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("ISIN",    col4_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Договор",  col5_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Краткий код",   col6_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Портфель",   col7_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Количество", col8_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("абс. цена",  col9_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("цена",  col10_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("%",     col11_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("валюта цены",   col12_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Стоимость",   col13_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("УНКД",   col14_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Затраты",   col15_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddStr();

    sql = 
          "SELECT t.t_dealcodets,                                                                           "
        + "       replace(t.t_dealcode,'NDFL/') dealcode, t.t_dealdate,                                     "
        + "       f.t_definition fname,                                                                     "
        + "              (select t_isin from davoiriss_dbt where t_fiid = f.t_fiid) isin,                   "
        + "              (select t_number from dsfcontr_dbt where t_id = t.t_clientcontrid) numb,           "
        + "              (select t_mpcode from ddlcontrmp_dbt where t_sfcontrid = t.t_clientcontrid) micex, "
        + "              (select t_name from dsfcontr_dbt where t_id = t.t_clientcontrid) name,             "
        + "              l.t_principal,                                                                     "
        + "       s1220.t_sum PriceAbs,                                                                     "
        + "       l.t_price,                                                                                "
        + "       l.t_relativeprice relprice,                                                               "
        + "       (select t_fi_code from dfininstr_dbt where t_fiid = l.t_cfi) pricefi,                     "
        + "       s1230.t_sum Cost,                                                                         "
        + "       s1240.t_sum uNKD,                                                                         "
        + "       s1250.t_sum OUTLAY                                                                        "
        + "  FROM ddl_tick_dbt t                                                                            "
        + "  left join ddl_leg_dbt l on t.t_dealid = l.t_dealid                                             "
        + "       LEFT JOIN dfininstr_dbt f                                                                 "
        + "          ON t.t_pfi = f.t_fiid                                                                  "
        + "       LEFT JOIN ddlsum_dbt s1220                                                                "
        + "          ON     t.t_bofficekind = s1220.T_DOCKIND                                               "
        + "             AND t.t_dealid = s1220.t_docid                                                      "
        + "             AND s1220.t_kind = 1220                                                             "
        + "        LEFT JOIN ddlsum_dbt s1230                                                               "
        + "           ON     t.t_bofficekind = s1230.T_DOCKIND                                              "
        + "              AND t.t_dealid = s1230.t_docid                                                     "
        + "              AND s1230.t_kind = 1230                                                            "
        + "        LEFT JOIN ddlsum_dbt s1240                                                               "
        + "           ON     t.t_bofficekind = s1240.T_DOCKIND                                              "
        + "              AND t.t_dealid = s1240.t_docid                                                     "
        + "              AND s1240.t_kind = 1240                                                            "
        + "        LEFT JOIN ddlsum_dbt s1250                                                               "
        + "           ON     t.t_bofficekind = s1250.T_DOCKIND                                              "
        + "              AND t.t_dealid = s1250.t_docid                                                     "
        + "             AND s1250.t_kind = 1250                                                             "
        + " WHERE SUBSTR (t.t_dealcode, 1, 4) = 'NDFL' AND t.t_bofficekind = 127                            ";
  var NRecs = SQL_GetNRecs(sql);
  sql = ExecSqlSelect(sql);//, MakeArray(SqlParam("dt", repdt)), false);


  InitProgress(NRecs, " Выгрузка данных ", " Выгрузка данных ");
  var cnt = 0 ;
  while (sql.MoveNext() )
    rn = rn + 1;
    Rep.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = true;");

    Rep.AddPrintCell(sql.value("t_dealcodets"),  col1_len, null, "c:ex_FS():ex_B(tblr)"); // 1. ID
    Rep.AddPrintCell(sql.value("dealcode"),   col2_len, null, "c:ex_FS():ex_B(tblr)"); // 2. Глава
    Rep.AddPrintCell(SQL_cONVtYPEdATE(sql.value("t_dealdate")),   col2_len, null, "c:ex_FS():ex_B(tblr)"); // 3. Дата
    Rep.AddPrintCell(sql.value("fname"),      col3_len, null, "c:ex_FS():ex_B(tblr)"); // 3. Номер
    Rep.AddPrintCell(sql.value("isin"),  col4_len, null, "c:ex_FS():ex_B(tblr)"); // 4. Счет дебета
    Rep.AddPrintCell(sql.value("numb"),  col5_len, null, "c:ex_FS():ex_B(tblr)"); // 5. Валюта дебета
    Rep.AddPrintCell(sql.value("micex"),  col6_len, null, "c:ex_FS():ex_B(tblr)"); // 6. Сумма дебета
    Rep.AddPrintCell(sql.value("name"), col7_len, null, "c:ex_FS():ex_B(tblr)"); // 7. Счет кредита
    Rep.AddPrintCell(sql.value("t_principal"), col8_len, null, "c:ex_FS():ex_B(tblr)"); // 8. Валюта кредита
    Rep.AddPrintCell(sql.value("priceabs"), col9_len, null, "c:ex_FS():ex_B(tblr)"); // 9. Сумма кредита
    Rep.AddPrintCell(sql.value("t_price"), col10_len, null, "c:ex_FS():ex_B(tblr)"); // 10. Дата проводки
    Rep.AddPrintCell(sql.value("relprice"),  col11_len, null, "c:ex_FS():ex_B(tblr)"); // 11. Назначение
    Rep.AddPrintCell(sql.value("pricefi"),      col12_len, null, "c:ex_FS():ex_B(tblr)"); // 12. Операционист
    Rep.AddPrintCell(sql.value("cost"),      col13_len, null, "c:ex_FS():ex_B(tblr)"); // 12. Операционист
    Rep.AddPrintCell(sql.value("uNKD"),      col14_len, null, "c:ex_FS():ex_B(tblr)"); // 12. Операционист
    Rep.AddPrintCell(sql.value("OUTlay"),      col15_len, null, "c:ex_FS():ex_B(tblr)"); // 12. Операционист
    Rep.AddStr();

    count = count + 1;
    UseProgress(cnt = cnt + 1);
  end;

  RemProgress;

  rn = rn + 1;
  Rep.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
  Rep.AddPrintCell("Количество : " + count, col1_len, null, "l:ex_FS(b):ex_B()");
  Rep.AddStr();

  Rep.PrintWinRep("НДФЛ 2018");
  Rep.SetZoomType(ZOOM_TYPE_A4L);
  Rep.SetWinRepOutput();
  Rep.ShowWinRep();

End;

ndfl_data_rep();
exit(1);
