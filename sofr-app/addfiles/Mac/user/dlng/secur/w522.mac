import BankInter, w522_panel, ReportUser;


PRIVATE CLASS (TX_ReportUser) W522_Report
  var m_Date;
  var m_DataExists = false;

  /*Создание отчета*/
  PRIVATE MACRO Create()

    /*Точка входа*/
    var query              = "",
        filter             = TArray,
        sort               = "",
        sql                = "",
        tblCnt             = 0, 
        indxNumb           = 1,   /* порядковый номер записи внутри каждой таблицы */
        curCur             = "",  /* Валюта текущей строки */   
        cur                = "",  /* Валюта в текущем блоке */
        prevAcc            = "",
        cur_rest           = 0,   /* Остаток текущей строки */   
        cur_rest_nat_cur   = 0,   /* Остаток в нац валюте текущей строки */
        rest_total         = 0,   /* Общий остаток в текущем блоке */
        rest_nat_cur_total = 0;   /* Общий остаток в нац валюте в текущем блоке */
    var m_DS;
    var errmsg;

    /*Отключаем все индикаторы*/
    if(m_UseTemplate)
      m_ObjTemplateXLS.SetFlagShowIndicator(false);
    else
      __BUG_Global_m_ObjTemplateXLS.SetFlagShowIndicator(false);
    end;
    m_ProgressIndicator = CreateProgressIndicator(true);

    /*Даты начала и окончания периода отчета*/
    m_Date = FormData.Date;    

    /*Лист "Остатки по счетам"*/
    SetActiveSheet("Остатки по счетам");
    query = " select * from ( "+
            "select settacc.t_partyid,                                                          "+
//            "       settacc.t_recname,                                                          "+
            "  DECODE (settacc.t_partyid, 114800,                                                 "+
            "         (select t_name from dsfcontr_dbt sf where sf.t_id = sfcontr.t_id),          "+
            "         (select t_shortname from dparty_dbt where t_partyid = settacc.t_partyid)) t_recname,  "+
            "       settacc.t_account,                                                          "+
            "       nvl(rsi_rsb_account.restall(settacc.t_account,                          "+
            "                                       settacc.t_chapter,                          "+
            "                                       settacc.t_fiid,                             "+
            "                                       :pDate1),                                  "+
            "           0) t_rest,                                                              "+
            "       nvl(RSI_RSB_FIInstr.ConvSum(rsi_rsb_account.restall(settacc.t_account,  "+
            "                                                               settacc.t_chapter,  "+
            "                                                               settacc.t_fiid,     "+
            "                                                               :pDate2),          "+
            "                                   settacc.t_fiid,                                 "+
            "                                   0,                                              "+
            "                                   :pDate3,                                        "+
            "                                   1),                                             "+
            "           0) t_rest_nat_cur,                                                      "+
            "       settacc.t_fiid,                                                             "+
            "       fininstr.t_ccy,                                                             "+
            "       case                                                                        "+
            "         when sfcontr.t_servkind = 1 and sfcontr.t_servkindsub = 9 then            "+
            "          'Внебиржевой'                                                            "+
            "         when sfcontr.t_servkind = 1 and sfcontr.t_servkindsub = 8 then            "+
            "          'Биржевой'                                                               "+
            "         when sfcontr.t_servkind = 15 then                                         "+
            "          'Срочный'                                                                "+
            "         else                                                                      "+
            "          chr(1)                                                                   "+
            "       end t_marketname,                                                           "+
            "       sfcontr.t_id,                                                               "+
            "       sfcontr.t_number,                                                           "+
            "       sfcontr.t_servkind,                                                         "+
            "       sfcontr.t_servkindsub                                                       "+
            "  from dsettacc_dbt settacc                                                        "+
            "  join dsfssi_dbt sfssi                                                            "+
            "    on sfssi.t_setaccid = settacc.t_settaccid                                      "+
            "  join dsfcontr_dbt sfcontr                                                        "+
            "    on sfcontr.t_id = TO_NUMBER(sfssi.t_objectid)                                  "+
            "   and sfssi.t_objecttype = 659                                                    "+
            "  join dfininstr_dbt fininstr                                                      "+
            "    on fininstr.t_fiid = settacc.t_fiid                                            "+
            "  join dset_cln_U_TMP"+V_W522_CNUM+"  clntmp                                                       "+
            "    on clntmp.t_clientid = sfcontr.t_partyid                                       "+
            "   and clntmp.t_setflag = chr(88)                                                  "+
            "  join dset_fi_U_TMP"+V_W522_CNUM+"  fitmp                                                         "+
            "    on fitmp.t_fiid = settacc.t_fiid                                               "+
            "   and fitmp.t_setflag = chr(88)                                                   "+
            "  join dset_bacc_U_TMP"+V_W522_CNUM+"  bacctmp                                                     "+
            "    on bacctmp.t_balacc = substr(settacc.t_account, 1, 5)                          "+
            "   and bacctmp.t_setflag = chr(88)                                                 "+
            " where sfcontr.t_datebegin <= :pDate4                                              "+
            "   and (sfcontr.t_dateclose = to_date('01.01.0001', 'dd.mm.yyyy') or               "+
            "       sfcontr.t_dateclose >= :pDate5 - 1)                                         "+
            "       union all " +
            "       select a.t_owner,                                                           " +
//            "       (select t_nameaccount from daccount_dbt where t_account = a.t_account) t_nameaccount,                                                           " +
            "       DECODE (a.t_owner, 114800, "+
            "               (select t_name from dsfcontr_dbt sf where sf.t_id = sfcontr.t_id),          "+
            "               (select t_shortname from dparty_dbt where t_partyid = a.t_owner)) t_recname, "+
            "       a.t_account,                                                           " +
            "       nvl(abs(rsi_rsb_account.restall(a.t_account,                           " +
            "                                       a.t_chapter,                           " +
            "                                       a.t_currency,                              " +
            "                                       :pDate)),                                   " +
            "           0) t_rest,                                                               " +
            "       nvl(RSI_RSB_FIInstr.ConvSum(abs(rsi_rsb_account.restall(a.t_account,   " +
            "                                                               a.t_chapter,   " +
            "                                                               a.t_currency,      " +
            "                                                               :pDate)),           " +
            "                                   a.t_currency,                                  " +
            "                                   0,                                               " +
            "                                   :pDate,                                         " +
            "                                   1),                                              " +
            "           0) t_rest_nat_cur,                                                       " +
            "       a.t_currency,                                                              " +
            "       fininstr.t_ccy,                                                              " +
            "       case                                                                         " +
            "         when sfcontr.t_servkind = 1 and sfcontr.t_servkindsub = 9 then             " +
            "          'Внебиржевой'                                                             " +
            "         when sfcontr.t_servkind = 1 and sfcontr.t_servkindsub = 8 then             " +
            "          'Биржевой'                                                                " +
            "         when sfcontr.t_servkind = 15 then                                          " +
            "          'Срочный'                                                                 " +
            "         else                                                                       " +
            "          chr(1)                                                                    " +
            "       end t_marketname,                                                            " +
            "       sfcontr.t_id,                                                                " +
            "       sfcontr.t_number,                                                            " +
            "       sfcontr.t_servkind,                                                          " +
            "       sfcontr.t_servkindsub  " +
            "      from dmcaccdoc_dbt a                                                         " +
            "  join dsfcontr_dbt sfcontr                                                         " +
            "    on sfcontr.t_id = a.t_clientcontrid                                   " +
            "   and a.t_catnum = 5087                                                     " +
            "  join dfininstr_dbt fininstr                                                       " +
            "    on fininstr.t_fiid = a.t_currency                                             " +
            "  join dset_cln_U_TMP"+V_W522_CNUM+"  clntmp                                                        " +
            "    on clntmp.t_clientid = sfcontr.t_partyid                                        " +
            "   and clntmp.t_setflag = chr(88)                                                   " +
            "  join dset_fi_U_TMP"+V_W522_CNUM+"  fitmp                                                          " +
            "    on fitmp.t_fiid = a.t_currency                                                " +
            "   and fitmp.t_setflag = chr(88)                                                    " +
            "  join dset_bacc_U_TMP"+V_W522_CNUM+"  bacctmp                                                      " +
            "    on bacctmp.t_balacc = substr(a.t_account, 1, 5)                           " +
            "   and bacctmp.t_setflag = chr(88)                                                  " +
            " where sfcontr.t_datebegin <= :pDate                                               " +
            "   and (sfcontr.t_dateclose = to_date('01.01.0001', 'dd.mm.yyyy') or                " +
            "       sfcontr.t_dateclose >= :pDate - 1)   " +
            "   ) where (1 = 0                                                                      ";


    if(m_Form.GetFieldValue(P_W522_OverTheCounterMarket) == "X")
      filter(filter.size) = " or (t_servkind = 1 and t_servkindsub = 9)";    /* Внебиржевой фондовый рынок*/
      tblCnt = tblCnt + 1;
      PrintFormatString( "", "ReportName" + tblCnt, "'Остатки по денежным счетам на " + date(m_Date) + " по группе договоров \"Внебиржевой рынок\"");
    end;

    if(m_Form.GetFieldValue(P_W522_StockMarket) == "X")
      filter(filter.size) = " or (t_servkind = 1 and t_servkindsub = 8)";    /* Биржевой фондовый рынок*/
      tblCnt = tblCnt + 1;
      PrintFormatString( "", "ReportName" + tblCnt, "'Остатки по денежным счетам на " + date(m_Date) + " по группе договоров \"Биржевой рынок\"");
    end;

    if(m_Form.GetFieldValue(P_W522_FuturesMarket) == "X")
      filter(filter.size) = " or t_servkind = 15";   /* Срочный рынок */
      tblCnt = tblCnt + 1;
      PrintFormatString( "", "ReportName" + tblCnt, "'Остатки по денежным счетам на " + date(m_Date) + " по группе договоров \"Срочный рынок\"");
    end;

//    sort = ") order by settacc.t_fiid, settacc.t_partyid, settacc.t_account  ";
    sort = ") order by  t_partyid,t_fiid, t_account  ";

    var i = 1;
    var m_CRS, m_CS = null, cnt = 0, j = 0;
    while (i<=tblCnt)                   
      m_CS = null; cnt = 0; j = 0;
      sql = query + filter[i-1] + sort;
      m_DS = RSDCommand(sql);
      m_DS.AddParam("", RSDBP_IN, m_Date);
      m_DS.AddParam("", RSDBP_IN, m_Date);
      m_DS.AddParam("", RSDBP_IN, m_Date);
      m_DS.AddParam("", RSDBP_IN, m_Date);
      m_DS.AddParam("", RSDBP_IN, m_Date);
      m_DS.AddParam("", RSDBP_IN, m_Date);
      m_DS.AddParam("", RSDBP_IN, m_Date);
      m_DS.AddParam("", RSDBP_IN, m_Date);
      m_DS.AddParam("", RSDBP_IN, m_Date);
      m_DS.AddParam("", RSDBP_IN, m_Date);
      m_CS = RSDCommand(" select count(1) cnt from ( " + sql + ")");
      m_CS.AddParam("", RSDBP_IN, m_Date);
      m_CS.AddParam("", RSDBP_IN, m_Date);
      m_CS.AddParam("", RSDBP_IN, m_Date);
      m_CS.AddParam("", RSDBP_IN, m_Date);
      m_CS.AddParam("", RSDBP_IN, m_Date);
      m_CS.AddParam("", RSDBP_IN, m_Date);
      m_CS.AddParam("", RSDBP_IN, m_Date);
      m_CS.AddParam("", RSDBP_IN, m_Date);
      m_CS.AddParam("", RSDBP_IN, m_Date);
      m_CS.AddParam("", RSDBP_IN, m_Date);
      BegAction(1000,"Сбор данных");
      m_CS.Execute();
      m_CRS = TRsbDataSet(m_CS);
      if (m_CRS.movenext())
         cnt = m_CRS.cnt;
      end;


      m_DS.Execute();
      m_RS = TRsbDataSet(m_DS);    
      EndAction();
      indxNumb           = 1;
      rest_total         = "";
      rest_nat_cur_total = "";

      RegisterTable( "ReportRow" + i, "",
                     "Field_" + i + "_1", 
                     "Field_" + i + "_2", 
                     "Field_" + i + "_3", 
                     "Field_" + i + "_4", 
                     "Field_" + i + "_5", 
                     "Field_" + i + "_6");
      InitProgress(int(cnt),"Формирование отчета");
        
      while (m_RS.MoveNext())
        curCur = m_Rs.value("t_ccy");
        if (cur=="")
          cur = curCur;
        end;
        /*
        if ((curCur != cur) and (indxNumb!=1))
          PrintTableLine(
            "Field_" + i + "_1", "", null,
            "Field_" + i + "_2", "", null,
            "Field_" + i + "_3", "ИТОГО:", null,
            "Field_" + i + "_4", cur, null,
            "Field_" + i + "_5", rest_total, null,
            "Field_" + i + "_6", rest_nat_cur_total, null);
          cur = curCur;
          rest_total         = 0;
          rest_nat_cur_total = 0;
        end;                     
         */
        if (prevAcc!=m_rs.value("t_account"))
          cur_rest = m_Rs.value("t_rest");
          cur_rest_nat_cur = m_Rs.value("t_rest_nat_cur");          
          PrintTableLine(
            "Field_" + i + "_1", indxNumb, null,                         
            "Field_" + i + "_2", m_Rs.value("t_recname"), null,       
            "Field_" + i + "_3", m_Rs.value("t_account"), null,          
            "Field_" + i + "_4", curCur, null,                           
            "Field_" + i + "_5", m_Rs.value("t_rest"), null,             
            "Field_" + i + "_6", m_Rs.value("t_rest_nat_cur"), null);    
          indxNumb           = indxNumb + 1;
          rest_total         = money(rest_total) + money(cur_rest);
          rest_nat_cur_total = money(rest_nat_cur_total) + money(cur_rest_nat_cur);
        end;
        prevAcc = m_rs.value("t_account");
        UseProgress(j=j+1);
      end;
      RemProgress;
      PrintTableLine(
        "Field_" + i + "_1", "", null,
        "Field_" + i + "_2", "", null,
        "Field_" + i + "_3", "ИТОГО:", null,
        "Field_" + i + "_4", cur, null,
        "Field_" + i + "_5", rest_total, null,
        "Field_" + i + "_6", rest_nat_cur_total, null);
      EndTable();
      cur = "";
      i = i + 1;
    end;

    m_DataExists = false;
    if (tblCnt>0)            
      m_DataExists = true;
    end;
    
    while (tblCnt < 3)
      tblCnt = tblCnt + 1;
      __BUG_Global_m_ObjTemplateXLS.sheet.application.names("Table" + tblCnt).referstorange.clear;   /* Если были выбраны не все 3 рынка, то удаляем лишние таблицы из формы */
    end;    
  END;

  MACRO CReport_DataExist() 
    if (m_DataExists)
      return true; 
    else
      return false;
    end;
  END;

  MACRO CReport_NoDataMsg() 
    if (not m_DataExists)
      msgbox("Информация по заданным параметрам отсутствует.");
    end;
  END; 
                                                        
//  SQL_Execute("delete from dset_cln_U_TMP"+V_W522_CNUM+" ");
//  SQL_Execute("delete from dset_fi_U_TMP"+V_W522_CNUM+" "); 
//  SQL_Execute("delete from dset_bacc_U_TMP"+V_W522_CNUM+" ");  
    SQL_Execute("begin  execute immediate 'drop table DSET_FI_U_TMP"+V_W522_CNUM +"';exception when others then null;end;");
    SQL_Execute("begin  execute immediate 'drop table DSET_CLN_U_TMP"+V_W522_CNUM +"';exception when others then null;end;");
    SQL_Execute("begin  execute immediate 'drop table DSET_BACC_U_TMP"+V_W522_CNUM +"';exception when others then null;end;");

  initTX_RegistrReport(W522_Panel(), "Report_W522.xls");

END;

/*Точка входа*/
var defprec = SetDefPrec(12);
var r = W522_Report();
r.InitReport("Остатки по счетам", null);
r.Run();
SetDefPrec(defprec);

exit(1);