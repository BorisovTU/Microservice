/*BIQ 7785 перевод ДБО на ЕДП*/
import "dlcontrfunc.mac";
import "dldlngfun.mac", "dl_car.mac", "funcobj.mac";



private macro IIF(cond, val1, val2)
   if (cond)
      return val1;
   else
      return val2;
   end;
end;


private Macro SetCateg(objecttype, objectid, groupid, attrid, pdate)
 var sql, cmd;

 sql = "declare\n" +
       "  vobjecttype dobjatcor_dbt.t_objecttype%type := :pobjecttype;\n" + 
       "  vobjectid dobjatcor_dbt.t_object%type := :pobjectid;\n" + 
       "  vgroupid dobjatcor_dbt.t_groupid%type := :pgroupid;\n" + 
       "  vattrid dobjatcor_dbt.t_attrid%type := :pattrid;\n" + 
       "begin\n" + 
       "  delete from dobjatcor_dbt where t_objecttype = vobjecttype and t_groupid = vgroupid and t_object = vobjectid;\n" + 
       "  insert into dobjatcor_dbt values (vobjecttype,\n" + 
       "                                    vgroupid,\n" + 
       "                                    vattrid,\n" + 
       "                                    vobjectid,\n" + 
       "                                    'X',\n" + 
       "                                    :pdate,\n" + 
       "                                    :poper,\n" + 
       "                                    to_date ('31129999', 'ddmmyyyy'),\n" + 
       "                                    to_date ('01010001','ddmmyyyy'),\n" + 
       "                                    to_date ('00:00:00','hh24:mi:ss'),\n" + 
       "                                    chr(88),\n" + 
       "                                    0);\n" + 
       "end;";

 cmd = RSDCommand(sql);
 cmd.AddParam("pobjecttype", RSDBP_IN, objecttype);
 cmd.AddParam("pobjectid", RSDBP_IN, objectid);
 cmd.AddParam("pgroupid", RSDBP_IN, groupid);
 cmd.AddParam("pattrid", RSDBP_IN, attrid);
 cmd.AddParam("pdate", RSDBP_IN, pdate);
 cmd.AddParam("poper", RSDBP_IN, {oper});
 cmd.Execute;
 return true;
onError(e)
 return true;
end;


macro Change2edp(dlcontrid, err:@string, acccode, curdate)
   // var acccode = "", 
var stat = 0, ObjCat, sql_sf1, dt_sf1, cmd, sql1,dt1;    

   if (valtype(curdate) == v_undef) curdate = {curdate};end;
   //отобрать биржевые субдоговоры
   var sql_sf = DL_RSDCommand(" select * from dsfcontr_dbt where t_servkindsub = 8 and " + 
                              " (t_dateclose = to_date('01010001','ddmmyyyy') or t_dateclose > ?) and t_id in (select t_sfcontrid from ddlcontrmp_dbt where t_dlcontrid = ?) order by t_servkind");
       sql_sf.addParam(curdate);
       sql_sf.addParam(dlcontrid);
   var dt_sf = sql_sf.Execute();
   var sql = "", dt_acc, dt_t, FD, attrid, error = "", rest = 0.0;
   record ClientAccOld( account );
   record ClientAccNew( account );
   record ComAccOld( account );
   record ComAccNew( account );


   while ((  not stat ) and dt_sf.movenext() )
      FD = ObjCat = dt_acc = null;

      FD = DL_SubContrFD(dt_sf.id);

      /*По старым договорам иногда нет 47423 - откроем*/
      sql = " select a.*, sysdate from dsfssi_dbt s, dsettacc_dbt a where S.T_SETACCID = A.T_SETTACCID and s.t_objecttype = 659 and t_objectid = lpad(?,10,'0') "
            " and exists (select 1 from daccount_dbt where t_close_date = to_date('01010001','ddmmyyyy') and t_account = a.t_account and t_chapter = a.t_chapter and t_code_currency = a.t_fiid) " ;
      sql = DL_RSDCommand(sql);
      sql.addParam(dt_sf.id);
      dt_acc = sql.Execute();
      while ((not stat) and  dt_acc.movenext() )
         if((not stat) and (false == FD.OpenAccount( "+РасчетыКомисс1", NULL, NULL, ComAccOld, curdate, dt_acc.fiid )))
            err = "Ошибка при открытии счета по категории \"+РасчетыКомисс1\" "  +geterrmsg();
            msgbox(err);
            stat = 1;
         end;
         if(false == FD.OpenAccount( "ДС Клиента, ВУ", NULL, NULL, ClientAccOld, curdate, dt_acc.fiid ))
            err = "Ошибка при открытии счета по категории \"ДС Клиента, ВУ\" " +geterrmsg();
            msgbox(err);
            stat = 1;
         end;
         if(false == FD.OpenAccount( "ДС, Расч. с клиентом, ВУ", NULL, NULL, ClientAccOld, curdate, dt_acc.fiid ))
            err = "Ошибка при открытии счета по категории \"ДС, Расч. с клиентом, ВУ\" " +geterrmsg();
            msgbox(err);
            stat = 1;
         end;
      end;
   end;

   //  генерим и код в номере счета
  // stat = GenerateReference(127, acccode);
   if (not stat)
      cmd = RSDCommand(" update dsfcontr_dbt set t_acccode = ? where  t_servkindsub = 8 and t_id in (select t_sfcontrid from ddlcontrmp_dbt where t_dlcontrid = ?)");
      cmd.addParam("", RSDBP_IN, string(acccode));
      cmd.addParam("", RSDBP_IN, dlcontrid);
      cmd.Execute();
   end;

   dt_sf = sql_sf.Execute();
   //по каждому субдоговору
   while ((  not stat ) and dt_sf.movenext() )
      FD = ObjCat = dt_acc = dt_t = null;

      FD = DL_SubContrFD(dt_sf.id);


      sql = ""; dt_acc = null;
    //  ставим категорию едп Да 

      SetCateg(659, string(dt_sf.id:o:10), 102, 1, curdate);
   /*
      ObjCat = RsbObjCategories(659, string(dt_sf.id:o:10));
      stat = ObjCat.ConnectAttr(102, 1, NULL, NULL, curdate );
      if(stat == 0)
         stat = ObjCat.Save(string(dt_sf.id:o:10));
      end;
    */

/*      if (not stat)
         cmd = RSDCommand(" update dsfcontr_dbt set t_acccode = ? where  t_servkindsub = 8 and t_id = ?");
         cmd.addParam("", RSDBP_IN, string(acccode));
         cmd.addParam("", RSDBP_IN, dt_sf.id);
         cmd.Execute();
      end;
*/

      sql = " select a.*, sysdate from dsfssi_dbt s, dsettacc_dbt a where S.T_SETACCID = A.T_SETTACCID and s.t_objecttype = 659 and t_objectid = lpad(?,10,'0') ";
      sql = DL_RSDCommand(sql);
      sql.addParam(dt_sf.id);
      dt_acc = sql.Execute();

      while ((not stat) and  dt_acc.movenext() )
         ClearRecord(ClientAccOld);
         ClearRecord(ClientAccNew);
         ClearRecord(ComAccOld);
         ClearRecord(ComAccNew);

         if(false == FD.OpenAccount( "ДС клиента, ц/б", NULL, NULL, ClientAccOld, curdate, dt_acc.fiid ))
            err = "Ошибка при открытии счета по категории \"ДС клиента, ц/б\" "  +geterrmsg();
            if (index(err,"счет закрыт") > 0)
               sql1 = DL_RSDCommand(" select * from dmcaccdoc_dbt t where t_clientcontrid = ? and t_catnum = 201 " + 
                                   " and t_iscommon = chr(88) and exists(select 1 from daccount_dbt a where t_account = t.t_account and A.T_CLOSE_DATE <> to_date('01010001','ddmmyyyy')) ");
               sql1.addParam(dt_sf.id);
               dt1 = sql1.Execute();
               if (dt1.movenext())
                  DeleteBindAcc(dt_sf.id, dt1.currency, dt1.account);
                  stat = OpenAccAndBindToContract("ДС клиента, ц/б", dt_sf.id, dt_acc.fiid, "", error, curdate);
               end;
            else
            msgbox(err);
            stat = 1;
         end;
         end;

         if((not stat) and (false == FD.OpenAccount( "+РасчетыКомисс1", NULL, NULL, ComAccOld, curdate, dt_acc.fiid )))
            err = "Ошибка при открытии счета по категории \"+РасчетыКомисс1\" " +geterrmsg();
            if (index(err,"счет закрыт") > 0)
               cmd = RSDCommand(
                        "     UPDATE dmcaccdoc_dbt " +
                        "        SET t_iscommon = chr(0), t_disablingdate = ? " + /*иначе с этим счетом не выгрузится проводка, связку удалять нельзя, iscommon сбрасываем чтоб нигде функционал не отломался*/
                        "    WHERE t_clientcontrid = ? AND t_catnum = 5087 AND t_currency = ? and t_iscommon = chr(88) ; "); 
               cmd.addParam("", RSDBP_IN, curdate);
               cmd.addParam("", RSDBP_IN, dt_sf.id);
               cmd.addParam("", RSDBP_IN, dt_acc.fiid);
               cmd.Execute();
            else
            msgbox(err);
            stat = 1;
         end;
         end;

         if((not stat) and (ClientAccOld.account != ""))
            DeleteBindAcc(dt_sf.id, dt_acc.fiid, ClientAccOld.account);
            stat = OpenAccAndBindToContract("ДС клиента, ц/б", dt_sf.id, dt_acc.fiid, "", error, curdate);
         end;

         if((not stat) and (ComAccOld.account != ""))
            cmd = RSDCommand(
                     "     UPDATE dmcaccdoc_dbt " +
                     "        SET t_iscommon = chr(0), t_disablingdate = ? " + /*иначе с этим счетом не выгрузится проводка, связку удалять нельзя, iscommon сбрасываем чтоб нигде функционал не отломался*/
                     "    WHERE t_clientcontrid = ? AND t_catnum = 5087 AND t_currency = ? and t_account = ? ; "); 
            cmd.addParam("", RSDBP_IN, curdate);
            cmd.addParam("", RSDBP_IN, dt_sf.id);
            cmd.addParam("", RSDBP_IN, dt_acc.fiid);
            cmd.addParam("", RSDBP_IN, ComAccOld.account);
            cmd.Execute();
         end;

         if((not stat) and (false == FD.RecreateAccount( "ДС клиента, ц/б", NULL, NULL, ClientAccNew, curdate, dt_acc.fiid )))
            err = "Ошибка при открытии счета по категории \"ДС клиента, ц/б\" " + geterrmsg(); 
            msgbox(err);
            stat = 1;
         end;

         if((not stat) and (false == FD.RecreateAccount( "+РасчетыКомисс1", NULL, NULL, ComAccNew, curdate, dt_acc.fiid )))
            err = "Ошибка при открытии счета по категории \"+РасчетыКомисс1\" "  + geterrmsg();
            msgbox(err);
            stat = 1;
         end;

         if ((not stat) and (ClientAccOld.account != "")
             and (ClientAccOld.Account != ClientAccNew.Account))
            rest = DL_FindAccRest( ClientAccOld.code_currency, ClientAccOld.Chapter, ClientAccOld.Account, curdate, ClientAccOld.code_currency );
            if ( not ЮзерПроводкаПоКатегориямУчета(
               FD, 
               IIF( rest >= 0, ClientAccOld, ClientAccNew), 
               IIF(rest >= 0, ClientAccNew, ClientAccOld), 
               curdate,
               ClientAccOld.Chapter, 
               ClientAccOld.code_currency,
               abs(rest),
               "",
               "Перенос остатка на счета ЕДП по договору " + FD.GetMainContr().rec.Number + " от " + FD.GetMainContr().rec.DateBegin,
               null, null,
               ClientAccOld.code_currency, ClientAccOld.code_currency,
               false ) )
                  stat = 1;
                  err = "Ошибка при переносе остатка по категории \"ДС клиента, ц/б\" |" + geterrmsg();
                  msgbox(err);
            end;
         end;

         if ((not stat)  and (ComAccOld.account != "")
             and (ComAccOld.Account != ComAccNew.Account))
            rest = DL_FindAccRest( ComAccOld.code_currency, ComAccOld.Chapter, ComAccOld.Account, curdate, ComAccOld.code_currency );
            if ( not ЮзерПроводкаПоКатегориямУчета(
               FD, 
               IIF( rest <= 0, ComAccNew, ComAccOld), 
               IIF( rest <= 0, ComAccOld, ComAccNew), 
               curdate,
               ComAccOld.Chapter, 
               ComAccOld.code_currency,
               abs(rest),
               "",
               "Перенос остатка на счета ЕДП по договору " + FD.GetMainContr().rec.Number + " от " + FD.GetMainContr().rec.DateBegin,
               null, null,
               ComAccOld.code_currency, ComAccOld.code_currency,
               false ) )
                  err = "Ошибка при переносе остатка по категории \"+РасчетыКомисс1\" |"  + geterrmsg();
                  msgbox(err);
                  stat = 1;
            end;
         end;

         if ((not stat)  and (ClientAccOld.account != ""))
            stat=CB_CloseAccount(ClientAccOld.chapter, ClientAccOld.code_currency, ClientAccOld.account, curdate , error);
            if (stat)
               err = "Не удалось закрыть счет " + ClientAccOld.account +"|" + error;
               msgbox(err);
            end;
         end;

         if ((not stat)   and (ComAccOld.account != ""))
            stat=CB_CloseAccount(ComAccOld.chapter, ComAccOld.code_currency, ComAccOld.account, curdate , error);
            if (stat)
               err = "Не удалось закрыть счет " + ComAccOld.account +"|" + error;
               msgbox(err);
            end;
         end;


         //stat = MC_FindAndCloseAccountByAccDoc( AccRS.ID, curdate, MC_ACC_CLOSE_ALL );

      end;


      /*далее внутренний учет*/
      sql = 
                "     select a.*, ac.t_id,ac.t_catnum " +
                "     FROM ddlcontrmp_dbt mp,dsfcontr_dbt t           " +
                "             INNER JOIN dmcaccdoc_dbt ac              " +
                "             ON     ac.t_clientcontrid = t.t_id      " +
                "                AND ac.t_iscommon = CHR (88)         " +
                "                AND ac.t_templnum = case when t.t_servkind = 1 then 1 when t.t_servkind = 15 then 3 when t.t_servkind = 21 then 5 end " +
                "                and ac.t_chapter IN (21,22)          " +
                "          INNER JOIN daccount_dbt a                   " +
                "          ON     ac.t_chapter = a.t_chapter          " +
                "             AND ac.t_currency = a.t_code_currency   " +
                "             AND ac.t_account = a.t_account          " +
                "             and a.t_chapter IN (21,22)              " +  
                "             and a.t_close_date = to_date('01010001','ddmmyyyy')              " +  
                "    WHERE     t.t_id = mp.t_sfcontrid                " +
                "    and t.t_id = ? " +
                "  and (select t_fi_kind from dfininstr_dbt where t_fiid = a.t_code_currency) = 1  " +
                " ORDER BY t.t_number,ac.t_chapter,ac.t_currency,ac.t_catnum         " ;

      sql = DL_RSDCommand(sql);
      sql.addParam(dt_sf.id);
      dt_acc = sql.Execute();

      while ((not stat) and ( dt_acc.movenext()))
         ClearRecord(ClientAccOld);
         ClearRecord(ClientAccNew);
         if (dt_acc.catnum == 531)
             if(false == FD.OpenAccount( "ДС Клиента, ВУ", NULL, NULL, ClientAccOld, curdate, dt_acc.code_currency ))
                err = "Ошибка при открытии счета по категории \"ДС Клиента, ВУ\" " +geterrmsg();
                msgbox(err);
                stat = 1;
             end;
         elif  (dt_acc.catnum == 533)
             if(false == FD.OpenAccount( "ДС, Расч. с клиентом, ВУ", NULL, NULL, ClientAccOld, curdate, dt_acc.code_currency ))
                err = "Ошибка при открытии счета по категории \"ДС, Расч. с клиентом, ВУ\" " +geterrmsg();
                msgbox(err);
                stat = 1;
             end;
         end;

         if (not stat)
            cmd = RSDCommand(
                        "     UPDATE dmcaccdoc_dbt " +
                        "        SET t_iscommon = chr(0), t_disablingdate = ? " +  /*иначе с этим счетом не выгрузится проводка, связку удалять нельзя, iscommon сбрасываем чтоб нигде функционал не отломался*/
                        "    WHERE t_clientcontrid = ? AND t_catnum = ? AND t_currency = ? and t_account = ? ;" );
            cmd.addParam("", RSDBP_IN, curdate);
            cmd.addParam("", RSDBP_IN, dt_sf.id);
            cmd.addParam("", RSDBP_IN, dt_acc.catnum);
            cmd.addParam("", RSDBP_IN, dt_acc.code_currency);
            cmd.addParam("", RSDBP_IN, dt_acc.account);
            cmd.Execute();
         end;

         if ((not stat) and (dt_acc.catnum == 531))
             if(false == FD.RecreateAccount( "ДС Клиента, ВУ", NULL, NULL, ClientAccNew, curdate, dt_acc.code_currency ))
                err = "Ошибка при открытии счета по категории \"ДС Клиента, ВУ\" " +geterrmsg();
                msgbox(err);
                stat = 1;
             end;
         elif  ((not stat) and (dt_acc.catnum == 533))
             if(false == FD.RecreateAccount( "ДС, Расч. с клиентом, ВУ", NULL, NULL, ClientAccNew, curdate, dt_acc.code_currency ))
                err = "Ошибка при открытии счета по категории \"ДС, Расч. с клиентом, ВУ\" "  +geterrmsg();
                msgbox(err);
                stat = 1;
             end;
         end;


         if ((not stat)
             and (ClientAccOld.Account != ClientAccNew.Account))
            rest = DL_FindAccRest( ClientAccOld.code_currency, ClientAccOld.Chapter, ClientAccOld.Account, curdate, ClientAccOld.code_currency );
            if ( not ЮзерПроводкаПоКатегориямУчета(
               FD, 
               IIF(dt_acc.catnum == 533, IIF(rest >= 0, ClientAccOld, ClientAccNew), IIF(rest <= 0, ClientAccNew, ClientAccOld) ) , 
               IIF(dt_acc.catnum == 533, IIF(rest >= 0, ClientAccNew, ClientAccOld), IIF(rest <= 0, ClientAccOld, ClientAccNew) ),
               curdate,
               ClientAccOld.Chapter, 
               ClientAccOld.code_currency,
               ABS(rest),
               "",
               "Перенос остатка на счета ЕДП по договору " + FD.GetMainContr().rec.Number + " от " + FD.GetMainContr().rec.DateBegin,
               null, null,
               ClientAccOld.code_currency, ClientAccOld.code_currency,
               false ) )
                  err = "Не удалось выполнить перенос остатка по счету " + ClientAccNew.account;
                  msgbox(err);
                  stat = 1;
            end;
         end;

         if (not stat)
            stat=CB_CloseAccount(ClientAccOld.chapter, ClientAccOld.code_currency, ClientAccOld.account, curdate , error);
            if (stat)
               if (ClientAccOld.code_currency != NATCUR)
                  if ((ABS(DL_FindAccRest( ClientAccOld.code_currency, ClientAccOld.Chapter, ClientAccOld.Account, curdate, NATCUR )) !=0) and 
                      (ABS(DL_FindAccRest( ClientAccOld.code_currency, ClientAccOld.Chapter, ClientAccOld.Account, curdate, ClientAccOld.code_currency )) ==0))
                     /*по ВУ валютные остатки не переоцениваются - обнулим сами*/
                     cmd = RSDCommand(
                                  "UPDATE drestdate_dbt t " +
                                  "   SET t_rest = 0, t_planrest = 0 " +
                                  " WHERE t_accountid IN " +
                                  "          (SELECT t_accountid " +
                                  "             FROM daccount_dbt " +
                                  "            WHERE     t_account = ? " +
                                  "                  AND t_code_currency = ? " +
                                  "                  AND t_chapter = ?) " +
                                  "       AND t_restcurrency = 0 " +
                                  "       AND ( (t_restdate = ? ) " +
                                  "            OR (t_restdate = " +
                                  "                   (SELECT MAX (t_restdate) " +
                                  "                      FROM drestdate_dbt " +
                                  "                     WHERE t_accountid = t.t_accountid " +
                                  "                           AND t_restcurrency = t.t_restcurrency))) ");
                     cmd.addParam("", RSDBP_IN, ClientAccOld.Account);
                     cmd.addParam("", RSDBP_IN, ClientAccOld.code_currency);
                     cmd.addParam("", RSDBP_IN, ClientAccOld.Chapter);
                     cmd.addParam("", RSDBP_IN, curdate);
                     cmd.Execute();
                     stat=CB_CloseAccount(ClientAccOld.chapter, ClientAccOld.code_currency, ClientAccOld.account, curdate , error);
                  end;
               end;
               if (stat)
                  err = "Не удалось закрыть счет " + ClientAccOld.account +"|" + error;
                  msgbox(err);
               end;
            end;
         end;

      end;

      // продёрнуть счета по остальным валютам, чтобы привязались к фондовому рынку. По срочному могут быть только рубли, потому ничего не делаем

      sql = DL_RSDCommand(" select * from dsfcontr_dbt where t_servkindsub = 8 and t_servkind = 1 and t_id in (select t_sfcontrid from ddlcontrmp_dbt where t_dlcontrid = ? ) ");
      sql.addParam(dlcontrid);
      dt_sf1 = sql.Execute();

      while ((not stat) and (dt_sf1.movenext))
         // сначала убрать привязки, т.к. есть договоры с закрытыми валютными счетами и живыми привязками
         if (not stat)
            cmd = RSDCommand(
                        "     UPDATE dmcaccdoc_dbt t " +
                        "        SET t_iscommon = chr(0), t_disablingdate = ? " + 
                        "    WHERE t_clientcontrid = ? AND t_catnum = ? AND t_currency in ( ?, ?, ?, ?) and exists " + 
                        "       ( select 1 from daccount_dbt where t_account = t.t_account and t_chapter = t.t_chapter and t_code_Currency = t.t_currency and t_close_date <> to_date('01010001','ddmmyyyy'));" );
            cmd.addParam("", RSDBP_IN, curdate);
            cmd.addParam("", RSDBP_IN, dt_sf1.id);
            cmd.addParam("", RSDBP_IN, 201);
            cmd.addParam("", RSDBP_IN, ПолучитьКодФинИн("840"));
            cmd.addParam("", RSDBP_IN, ПолучитьКодФинИн("978"));
            cmd.addParam("", RSDBP_IN, ПолучитьКодФинИн("756"));
            cmd.addParam("", RSDBP_IN, ПолучитьКодФинИн("826"));
            cmd.Execute();
         end;

         stat = OpenAccAndBindToContract("ДС клиента, ц/б", dt_sf1.id, ПолучитьКодФинИн("840"), "", error, curdate);
         if (not stat)
            stat = OpenAccAndBindToContract("ДС клиента, ц/б", dt_sf1.id, ПолучитьКодФинИн("978"), "", error, curdate);
         end;
         if (not stat)
            stat = OpenAccAndBindToContract("ДС клиента, ц/б", dt_sf1.id, ПолучитьКодФинИн("756"), "", error, curdate);
         end;
         if (not stat)
            stat = OpenAccAndBindToContract("ДС клиента, ц/б", dt_sf1.id, ПолучитьКодФинИн("826"), "", error, curdate);
         end;
         if ( stat)
            err = "Не удалось привязать валютный счет к фондовому рынку";
         end;
      end;

     /*
      sql = DL_RSDCommand("select 1 f  from ddl_tick_dbt t where T.T_CLIENTCONTRID = :parm1 and T.T_DEALSTATUS <> 20 " +
                    "union all " +
                    " select 1 f  from ddvndeal_dbt t where T.T_CLIENTCONTR = :parm2 and T.T_STATE <> 2 ");
      sql.addParam(dt_sf.id);
      sql.addParam(dt_sf.id);
      dt_t = sql.Execute();
                  */
    //  if ((not stat) and (dt_t.movenext()))
       if (not stat) 
         cmd = RSDCommand(

              "DECLARE " +
              " dt_sf number(10):=:parm; " +
              "BEGIN " +
              "   FOR i " +
              "      IN (SELECT ac.t_id, " +
              "                 ac.t_dockind, " +
              "                 ac.t_docid, " +
              "                 t.t_dealdate, " +
              "                 t.t_dealcode, " +
              "                 a.t_account accountnew, " +
              "                 ac.t_account " +
              "            FROM ddl_tick_dbt t, ddlrqacc_dbt ac, dmcaccdoc_dbt a " +
              "           WHERE     t.t_dealstatus <> 20 " +
              "                 AND t.t_dealid = ac.t_docid " +
              "                 AND t.t_bofficekind = ac.t_dockind " +
              "                 AND ac.t_subkind = 0 " +
              "                 AND t.t_clientcontrid > 0 " +
              "                 AND ac.t_chapter = 1 " +
              "                 AND ac.t_party NOT IN (1, 2) " +
              "                 AND t.t_clientcontrid = A.T_CLIENTCONTRID " +
              "                 AND ac.t_fiid = A.T_CURRENCY " +
              "                 AND t.t_clientcontrid = dt_sf " + 
              "                 AND A.T_CATNUM = 201 " +
              "                 AND a.t_iscommon = CHR (88) " +
              "                 AND a.t_disablingdate = TO_DATE ('01010001', 'ddmmyyyy') " +
              "                 AND a.t_account <> ac.t_account) " +
              "   LOOP " +
              "      UPDATE ddlrqacc_dbt " +
              "         SET t_account = i.accountnew " +
              "       WHERE t_id = i.t_id; " +
              "   END LOOP; " +
              " FOR i " +
              "      IN (SELECT ac.t_paymentid, " +
              "                 ac.t_dockind, " +
              "                 ac.t_documentid, " +
              "                 t.t_date, " +
              "                 t.t_code, " +
              "                 a.t_account accountnew, " +
              "                 ac.t_payeraccount " +
              "            FROM ddvndeal_dbt t, dpmpaym_dbt ac, dmcaccdoc_dbt a " +
              "           WHERE     t.t_state = 1 " +
              "                 AND t.t_id = ac.t_documentid " +
              "                 AND t.t_dockind = ac.t_dockind " +
              "                 AND ac.t_payer = t.t_client " +
              "                 AND t.t_clientcontr > 0 " +
              "                 AND ac.t_chapter = 1 " +
              "                 AND ac.t_payer NOT IN (1, 2) " +
              "                 AND ac.t_paymstatus <> 32000 " +
              "                 AND t.t_clientcontr = A.T_CLIENTCONTRID " +
              "                 AND ac.t_fiid = A.T_CURRENCY " +
              "                 AND t.t_clientcontr =  dt_sf " + 
              "                 AND A.T_CATNUM = 201 " +
              "                 AND a.t_iscommon = CHR (88) " +
              "                 AND a.t_disablingdate = TO_DATE ('01010001', 'ddmmyyyy') " +
              "                 AND SUBSTR (ac.t_payeraccount, 1, 3) = '306' " +
              "                 AND a.t_account <> ac.t_payeraccount) " +
              "   LOOP " +
              "      UPDATE dpmpaym_dbt " +
              "         SET t_payeraccount = i.accountnew, " +
              "             t_futurepayeraccount = i.accountnew " +
              "       WHERE t_paymentid = i.t_paymentid; " +
              "   END LOOP; " +
              " " +
              "   FOR i " +
              "      IN (SELECT ac.t_paymentid, " +
              "                 ac.t_dockind, " +
              "                 ac.t_documentid, " +
              "                 t.t_date, " +
              "                 t.t_code, " +
              "                 a.t_account accountnew, " +
              "                 ac.t_receiveraccount " +
              "            FROM ddvndeal_dbt t, dpmpaym_dbt ac, dmcaccdoc_dbt a " +
              "           WHERE     t.t_state = 1 " +
              "                 AND t.t_id = ac.t_documentid " +
              "                 AND t.t_dockind = ac.t_dockind " +
              "                 AND ac.t_receiver = t.t_client " +
              "                 AND t.t_clientcontr > 0 " +
              "                 AND ac.t_chapter = 1 " +
              "                 AND ac.t_payer NOT IN (1, 2) " +
              "                 AND ac.t_paymstatus <> 32000 " +
              "                 AND t.t_clientcontr = A.T_CLIENTCONTRID " +
              "                 AND ac.t_fiid = A.T_CURRENCY " +
              "                 AND t.t_clientcontr =  dt_sf " + 
              "                 AND A.T_CATNUM = 201 " +
              "                 AND a.t_iscommon = CHR (88) " +
              "                 AND a.t_disablingdate = TO_DATE ('01010001', 'ddmmyyyy') " +
              "                 AND SUBSTR (ac.t_receiveraccount, 1, 3) = '306' " +
              "                 AND a.t_account <> ac.t_receiveraccount) " +
              "   LOOP " +
              "      UPDATE dpmpaym_dbt " +
              "         SET t_receiveraccount = i.accountnew, " +
              "             t_futurereceiveraccount = i.accountnew " +
              "       WHERE t_paymentid = i.t_paymentid; " +
              "   END LOOP; " +
              "   DELETE FROM dmcaccdoc_dbt " +
              "      WHERE t_id IN " +
              "               (SELECT a.t_id " +
              "                  FROM dmcaccdoc_dbt a, ddvndeal_dbt d " +
              "                 WHERE     d.t_state = 1 " +
              "                       AND d.t_clientcontr > 0 " +
              "                       AND A.T_CLIENTCONTRID = D.T_CLIENTCONTR " +
              "                       AND a.t_iscommon = CHR (0) " +
              "                       and a.t_catnum in (201, 531, 533) " +
              "                       AND a.t_docid = D.T_ID " +
              "                       AND a.t_clientcontrid =  dt_sf " + 
              "                       AND A.T_DOCKIND = d.t_dockind); " +
              "END; " );
         cmd.addParam("", RSDBP_IN, dt_sf.id);
         cmd.Execute();
      end;


   end;
   return stat;

end;

macro Change2edpTrn(dlcontrid, err:@string)

   //транзакция

   var acccode = "", stat = GenerateReference(127, acccode);
   RslDefCon.BeginTrans();

   stat= Change2edp(dlcontrid, @err, acccode);
   if (not stat)
      RslDefCon.CommitTrans();
      return 0;
   else
      RslDefCon.RollBackTrans();
      return 1;
   end;
onerror(e)
   RslDefCon.RollBackTrans();
   err = e.Message + " " + e.Module + " " + e.Line;
   msgbox(err);
   return 1;
end;

   macro upd_line(p_dli)
      var sqls, rsdc;
      sqls = String( 
                     "DECLARE   \n"
                    ,"   v_Dli VARCHAR2(50) := :p_Dli;   \n"
                    ,"BEGIN   \n"
                    ,"   UPDATE Dbo_Edp_Tmp t  \n"
                    ,"      SET (t_Name   \n"
                    ,"         ,t_Partyid   \n"
                    ,"         ,t_Number   \n"
                    ,"         ,t_Datebegin   \n"
                    ,"         ,t_State   \n"
                    ,"         ,t_Issend   \n"
                    ,"         ,t_Datecreate   \n"
                    ,"         ,t_Datesend   \n"
                    ,"         ,t_Email   \n"
                    ,"         ,t_Countsend   \n"
                    ,"         ,t_Resend    \n"
                    ,"         ,t_EDP) =   \n"
                    ,"          (SELECT Sfn.t_Name   \n"
                    ,"                 ,Sfn.t_Partyid   \n"
                    ,"                 ,Sfn.t_Number   \n"
                    ,"                 ,Sfn.t_Datebegin   \n"
                    ,"                 ,(SELECT Atr.t_Name   \n"
                    ,"                     FROM Dobjatcor_Dbt Atc   \n"
                    ,"                    INNER JOIN Dobjattr_Dbt Atr   \n"
                    ,"                       ON (Atr.t_Objecttype = Atc.t_Objecttype AND Atc.t_Groupid = Atr.t_Groupid AND   \n"
                    ,"                          Atc.t_Attrid = Atr.t_Attrid)   \n"
                    ,"                    WHERE Atc.t_Objecttype = 207   \n"
                    ,"                      AND Atc.t_Groupid = 101   \n"
                    ,"                      AND SYSDATE BETWEEN Atc.t_Validfromdate AND Atc.t_Validtodate   \n"
                    ,"                      AND Atc.t_Object = Lpad(Dl.t_Dlcontrid, 34, '0')) t_State   \n"
                    ,"                 ,Decode((SELECT COUNT(1)   \n"
                    ,"                           FROM Ddlcontrmsg_Dbt m   \n"
                    ,"                          WHERE m.t_Dlcontrid = Dl.t_Dlcontrid   \n"
                    ,"                            AND m.t_Kind = 500)   \n"
                    ,"                        ,0   \n"
                    ,"                        ,Chr(0)   \n"
                    ,"                        ,Chr(88)) t_Issend   \n"
                    ,"                 ,(SELECT MIN(m.t_Createdate)   \n"
                    ,"                     FROM Ddlcontrmsg_Dbt m   \n"
                    ,"                    WHERE m.t_Dlcontrid = Dl.t_Dlcontrid   \n"
                    ,"                      AND m.t_Kind = 500) t_Datecreate   \n"
                    ,"                 ,(SELECT MIN(m.t_Senddate)   \n"
                    ,"                     FROM Ddlcontrmsg_Dbt m   \n"
                    ,"                    WHERE m.t_Dlcontrid = Dl.t_Dlcontrid   \n"
                    ,"                      AND m.t_Kind = 500) t_Datesend   \n"
                    ,"                 ,Dl.t_Email   \n"
                    ,"                 ,0 t_Countsend   \n"
                    ,"                 ,Chr(0) t_Resend   \n"
                    ,"            ,Decode( (SELECT count(1)  \n"
                    ,"                      FROM dsfcontr_dbt s, dobjatcor_dbt a  \n"
                    ,"                       WHERE     s.t_servkindsub = 8  \n"
                    ,"                        AND a.t_objecttype = 659  \n"
                    ,"                        AND a.t_groupid = 102  \n"
                    ,"                        AND a.t_attrid = 1  \n"
                    ,"                        AND a.t_object = LPAD (s.t_id, 10, '0')  \n"
                    ,"                        AND s.t_id IN (SELECT t_sfcontrid  \n"
                    ,"                                         FROM ddlcontrmp_dbt  \n"
                    ,"                                        WHERE t_dlcontrid = Dl.t_Dlcontrid))  \n"
                    ,"                     ,0   \n"
                    ,"                     ,chr(0)  \n"
                    ,"                     ,chr(88)) EDP  \n"
                    ,"             FROM Ddlcontr_Dbt Dl   \n"
                    ,"            INNER JOIN Dsfcontr_Dbt Sfn   \n"
                    ,"               ON (Sfn.t_Id = Dl.t_Sfcontrid)   \n"
                    ,"            WHERE Dl.t_Dlcontrid = t.t_Dlid) WHERE t.t_dlid = v_Dli;   \n"
                    ,"   COMMIT;   \n"
                  //  ,"EXCEPTION   \n"
                  //  ,"   WHEN OTHERS THEN   \n"
                  //  ,"      ROLLBACK;   \n"
                    ,"END;   \n"
                   );
      rsdc = rsdcommand(sqls);
      rsdc.AddParam("p_Dli", RSDBP_IN, p_dli);
      rsdc.execute;                         
      rsdc = null;
      //onerror(e);
   end;


macro funcChange2edp(param0, dlcontrid)
  var err = 0;
  var ErrStr = "";
  var ReturnObj = FuncObjResult(FUNCOBJ_RESULT_OK, "", 0);
  var OldDialogFlag = SetDialogFlag(0);
  var rsdc, sqls = "";
  //setrstrace(true);
  sqls = String( 
                  "BEGIN   \n"
                 ,"   UPDATE Dbo_Edp_Tmp t SET t.t_Message = null, t_Countsend = RSBSESSIONDATA.CNum WHERE t.t_dlID = :p_Dlid;   \n"
                 ,"END;   \n"
                );
   rsdc = rsdcommand(sqls);
   rsdc.AddParam("p_Dlid", RSDBP_IN, dlcontrid);
   rsdc.execute;
  err = Change2edpTrn(dlcontrid, @errstr);
//   var acccode = "", stat = GenerateReference(127, acccode);
//   err = Change2edp(dlcontrid, @errstr, acccode, date(3,9,2021));


  if((err != 0 ) OR (ErrStr != ""))
    sqls = String( 
                   "BEGIN   \n"
                  ,"   UPDATE Dbo_Edp_Tmp t SET t.t_Message = t.t_Message || ' ' || Substr(:p_Err, 1, 200), t_Countsend = 0 WHERE t.t_dlID = :p_Dlid;   \n"
                  ,"END;   \n"
                 );
    rsdc = rsdcommand(sqls);
    rsdc.AddParam("p_Err", RSDBP_IN, ErrStr);
    rsdc.AddParam("p_Dlid", RSDBP_IN, dlcontrid);
    rsdc.execute;
   

    ReturnObj.state = FUNCOBJ_RESULT_ERROR;
    ReturnObj.errorText = ErrStr;
    ReturnObj.errorCode = err;
  else
     upd_line(dlcontrid);
  end;
  SetDialogFlag(OldDialogFlag);
  //setrstrace(false);
  return ReturnObj;
onerror(e) 
    ReturnObj.state = FUNCOBJ_RESULT_ERROR;
    ReturnObj.errorText = "OnError";
    ReturnObj.errorCode = 1;
  return ReturnObj;
end;


//funcChange2edp(3226);