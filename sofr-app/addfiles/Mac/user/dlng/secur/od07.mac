/*
$Name:        od07.mac
$Module:      Ценные бумаги
$Description: Таблица ОД_7: Таблица ОД-7 Реестр валютно-процентных сделок СВОП, форвардов и опционов, которые были открыты в течение отчетного периода, и изменение справедливой стоимости которых было отражено на символах 25101-25105, 25201-25205, 25401-25405, 25501-25505, 45101-45105, 45201-45205, 45401-45405, 45501-45505
$Programmer:  Кротов А.
*/
import od07_panel, ReportUser;
import captureoutput;


PRIVATE CLASS (TX_ReportUser) od07_Report
  var m_BeginDate/*, m_EndDate*/;

  /*Создание отчета*/
  PRIVATE MACRO Create()

  /*Точка входа*/
    var cnt;
    var m_cmd;
    var flagss;

    /*Отключаем все индикаторы*/
    if(m_UseTemplate)
      m_ObjTemplateXLS.SetFlagShowIndicator(false);
    else
      __BUG_Global_m_ObjTemplateXLS.SetFlagShowIndicator(false);
    end;
    m_ProgressIndicator = CreateProgressIndicator(true);

    /*Даты отчета*/
    if(m_Form.GetFieldValue(PNFLD_PERIOD) < 13)
      /*Задан месяц*/
      m_BeginDate = date(1, m_Form.GetFieldValue(PNFLD_PERIOD), FormData.Year);
      m_EndDate = DateAfterCalenMonths(m_BeginDate, 1) - 1;
    else 
      /*Задан квартал*/
      m_BeginDate = date(1, (m_Form.GetFieldValue(PNFLD_PERIOD) - 12 - 1) * 3 + 1, FormData.Year);
      m_EndDate = DateAfterCalenMonths(m_BeginDate, 3) - 1;
    end;

    /*Лист "Таблица ОД-7"*/
    SetActiveSheet("Таблица ОД-7");
    if(m_Form.GetFieldValue(PNFLD_CURRENCY) == "X")
      if(m_Form.GetFieldValue(PNFLD_SECURITY) == "X")
        PrintFormatString("", "reportname", "Таблица ОД-7 Реестр сделок, которые были открыты c " + string(m_BeginDate:f) + " по " + string(m_EndDate:f) + ", и изменение справедливой стоимости которых было отражено на символах 25101-25105, 25201-25205, 25401-25405, 25501-25505, 45101-45105, 45201-45205, 45401-45405, 45501-45505");
      else
        PrintFormatString("", "reportname", "Таблица ОД-7 Реестр валютно-процентных сделок СВОП, форвардов и опционов, которые были открыты c " + string(m_BeginDate:f) + " по " + string(m_EndDate:f) + ", и изменение справедливой стоимости которых было отражено на символах 25101-25105, 25201-25205, 25401-25405, 25501-25505, 45101-45105, 45201-45205, 45401-45405, 45501-45505");
      end;
    else
      PrintFormatString("", "reportname", "Таблица ОД-7 Реестр биржевых сделок, которые были открыты c " + string(m_BeginDate:f) + " по " + string(m_EndDate:f) + ", и изменение справедливой стоимости которых было отражено на символах 25101-25105, 25201-25205, 25401-25405, 25501-25505, 45101-45105, 45201-45205, 45401-45405, 45501-45505");
    end;
    RegisterTable( "row1_0", "",
            /* 1*/ "row1_1", 
            /* 2*/ "row1_2", 
            /* 3*/ "row1_3", 
            /* 4*/ "row1_4", 
            /* 5*/ "row1_5", 
            /* 6*/ "row1_6", 
            /* 7*/ "row1_7", 
            /* 8*/ "row1_8", 
            /* 9*/ "row1_9", 
            /*10*/ "row1_10", 
            /*11*/ "row1_11", 
            /*12*/ "row1_12", 
            /*13*/ "row1_13", 
            /*14*/ "row1_14", 
            /*15*/ "row1_15", 
            /*16*/ "row1_16", 
            /*17*/ "row1_17", 
            /*18*/ "row1_18", 
            /*19*/ "row1_19", 
            /*20*/ "row1_20", 
            /*21*/ "row1_21", 
            /*22*/ "row1_22", 
            /*23*/ "row1_23", 
            /*24*/ "row1_24");
    this.AutoFilter(6, "A", "X");
    if(m_Form.GetFieldValue(PNFLD_CURRENCY) == "X")
      flagss = msgboxex("Выводить сделки с нулевыми оборотами по 70614/70613, но не нулевой справедливой стоимостью?", MB_YES + MB_NO, IND_NO);
      StartCaptureOutput();
      [
        select count(1) over() t_cnt, 
               dvndeal.fi_kind fi_kind,
               dvndeal.t_id t_id,
               dvndeal.t_code t_code,
               nvl(contragent.t_shortname,chr(1)) t_contragentname,
               case when t_contractorisbank > 0 then nvl(contragent.t_shortname,chr(1)) else chr(1) end t_contragentbank, 
               case when contragent.t_notresident is null then '-' when contragent.t_notresident = chr(88) then 'N' else 'R' end t_isresident,
               dvndeal.t_dealtype t_dealtype,
               dvndeal.t_date t_date, 
               dvndeal.t_execdate t_execdate,
               dvndeal.t_execdate - dvndeal.t_date t_days, 
               fininstrT.t_codeinaccount t_ccyT,
               t_amountT,
               case when t_fiidT = 0 then t_amountT
                    when fininstrT.t_fi_kind in(1,6) then round(rsi_rsb_fiinstr.convsum(t_amountT,t_fiidT,0,edt),2)
                    else 0 
               end t_amountTRUR,
               case when t_fiidT = 0 then 1
                    when fininstrT.t_fi_kind in(1,6) then round(rsi_rsb_fiinstr.convsum(1,t_fiidT,0,edt),4)
                    else 0 
               end t_amountTCurRUR,
               fininstrO.t_codeinaccount t_ccyO,
               t_amountO,
               case when t_fiidO = 0 then t_amountO
                    when fininstrO.t_fi_kind in(1,6) then round(rsi_rsb_fiinstr.convsum(t_amountO,t_fiidO,0,edt),2)
                    else 0 
               end t_amountORUR,
               case when t_fiidO = 0 then 1
                    when fininstrO.t_fi_kind in(1,6) then round(rsi_rsb_fiinstr.convsum(1,t_fiidO,0,edt),4)
                    else 0 
               end t_amountOCurRUR,
               case when t_ispfi = chr(88) then 'Да' else 'Нет' end t_ispfi,
               dvnfrval.t_fairvalue t_fairvalue,
               (select nvl(sum(acctrn.t_sum_natcur),0)
                from doprdocs_dbt oprdocs 
                join doprstep_dbt oprstep on oprstep.t_id_operation = oprdocs.t_id_operation and
                                             oprstep.t_id_step = oprdocs.t_id_step and
                                             oprstep.t_isexecute = chr(88)
                join dacctrn_dbt acctrn on acctrn.t_acctrnid = oprdocs.t_acctrnid and
                                           acctrn.t_state = 1 --Фактическая
                                           and acctrn.t_date_carry between bdt and edt and
                                           substr(acctrn.t_account_receiver,1,5) = '70614'  
                where oprdocs.t_id_operation = oproper.t_id_operation and
                                             oprdocs.t_dockind = 1) - 
               (select nvl(sum(acctrn.t_sum_natcur),0)
                from doprdocs_dbt oprdocs
                join doprstep_dbt oprstep on oprstep.t_id_operation = oprdocs.t_id_operation and
                                             oprstep.t_id_step = oprdocs.t_id_step and
                                             oprstep.t_isexecute = chr(88)
                join dacctrn_dbt acctrn on acctrn.t_acctrnid = oprdocs.t_acctrnid and
                                           acctrn.t_state = 1 --Фактическая
                                           and acctrn.t_date_carry between bdt and edt and
                                           substr(acctrn.t_account_payer,1,5) = '70614'  
                where oprdocs.t_id_operation = oproper.t_id_operation and
                                               oprdocs.t_dockind = 1) t_70614, 
               (select nvl(sum(acctrn.t_sum_natcur),0)
                from doprdocs_dbt oprdocs 
                join doprstep_dbt oprstep on oprstep.t_id_operation = oprdocs.t_id_operation and
                                             oprstep.t_id_step = oprdocs.t_id_step and
                                             oprstep.t_isexecute = chr(88)
                join dacctrn_dbt acctrn on acctrn.t_acctrnid = oprdocs.t_acctrnid and
                                           acctrn.t_state = 1 --Фактическая
                                           and  acctrn.t_date_carry between bdt and edt and
                                           substr(acctrn.t_account_receiver,1,5) = '70613'  
                where oprdocs.t_id_operation = oproper.t_id_operation and
                                               oprdocs.t_dockind = 1) - 
               (select nvl(sum(acctrn.t_sum_natcur),0)
                from doprdocs_dbt oprdocs
                join doprstep_dbt oprstep on oprstep.t_id_operation = oprdocs.t_id_operation and
                                             oprstep.t_id_step = oprdocs.t_id_step and
                                             oprstep.t_isexecute = chr(88)
                join dacctrn_dbt acctrn on acctrn.t_acctrnid = oprdocs.t_acctrnid and
                                           acctrn.t_state = 1 --Фактическая
                                           and acctrn.t_date_carry between bdt and edt and
                                           substr(acctrn.t_account_payer,1,5) = '70613'  
                where oprdocs.t_id_operation = oproper.t_id_operation and
                                               oprdocs.t_dockind = 1) t_70613, 
               case when t_contractorisbank = 0 then 'Клиенты' when t_marketkind = 0 then 'Внебиржа' else 'Биржа' end t_dealclass
        from (select bdt, edt, typ, fi_kind,
                     t_id, t_state, t_dockind,  
                     case when t_code != chr(1) then t_code else t_extcode end t_code, 
                     t_contractor,
                     t_dealtype,
                     t_date,t_execdate,
                     t_ispfi, t_marketkind,
                     t_fiidT,
                     t_amountT,
                     t_fiidO,
                     t_amountO,
                     nvl((select t_id 
                          from (select t_id 
                                from ddvnfrval_dbt 
                                where t_dealid = dvndeal.t_id and t_date <= edt
                                order by t_date desc, t_id desc)
                          where rownum = 1),0) t_dvnfrvalid,
                     (select count(1) cnt 
                      from dpartyown_dbt partyown 
                      where partyown.t_partyid = t_contractor and 
                            partyown.t_partykind = 2 --Банком
                      ) t_contractorisbank
              from(--Процентный СВОП (только валюта)
                   select bdt, edt, typ, fininstrT.t_fi_kind fi_kind,
                          -- Сделка
                          dvndeal.t_id, dvndeal.t_state, dvndeal.t_dockind,  
                          dvndeal.t_extcode, dvndeal.t_code, 
                          dvndeal.t_contractor,
                          case when fininstrT.t_fiid != fininstrO.t_fiid then 'продажа'||' '|| fininstrO.t_ccy||' за '||fininstrT.t_ccy else chr(1) end t_dealtype,
                          dvndeal.t_date, greatest(dvnfiT.t_execdate, dvnfiT.t_paydate, dvnfiO.t_execdate, dvnfiO.t_paydate) t_execdate,
                          dvndeal.t_ispfi, dvndeal.t_marketkind,
                          -- Требования
                          fininstrT.t_fiid t_fiidT,
                          dvnfiT.t_amount t_amountT,
                          -- Обязательста
                          fininstrO.t_fiid t_fiidO,
                          dvnfiO.t_amount t_amountO 
                   from ddvndeal_dbt dvndeal 
                   join (select :bdt bdt, :edt edt, :typ typ from dual) on 1=1
                   join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dvndeal.t_kind and 
                                                  regexp_like(oprkoper.t_systypes, 'P' --Процентный СВОП
                                                              )
                   join ddvnfi_dbt dvnfiT on dvnfiT.t_dealid = dvndeal.t_id and 
                                             dvnfiT.t_type = 2 
                   join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvnfiT.t_fiid and 
                                                   fininstrT.t_fi_kind = 1
                   join ddvnfi_dbt dvnfiO on dvnfiO.t_dealid = dvndeal.t_id and 
                                             dvnfiO.t_type = 0
                   join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvnfiO.t_fiid and 
                                                   fininstrO.t_fi_kind = 1  
                   where dvndeal.t_dockind = 199 --Внебиржевая сделка с ПИ  
                         and dvndeal.t_date <= edt and 
                         dvndeal.t_state >= 1 and
                         dvndeal.t_ispfi = chr(88) and
                         typ in (0,1)
                   union all
                   -- Опцион/Форвард (любой актив за валюту)
                   select bdt, edt, typ, fininstrT.t_fi_kind fi_kind,
                          -- Сделка
                          dvndeal.t_id, dvndeal.t_state, dvndeal.t_dockind,  
                          dvndeal.t_extcode, dvndeal.t_code, 
                          dvndeal.t_contractor,
                          case when fininstrT.t_fi_kind in (1,6,3) then case when dvndeal.t_type = 1 then 'покупка' else 'продажа' end ||' '|| fininstrT.t_ccy||' за '||fininstrO.t_ccy else '-' end t_dealtype,--PNV 517524
                          dvndeal.t_date, greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdate,
                          dvndeal.t_ispfi, dvndeal.t_marketkind,
                          -- Требования
                          case when dvndeal.t_type != 1 then fininstrO.t_fiid else fininstrT.t_fiid end t_fiidT,
                          case when dvndeal.t_type != 1 then dvnfiT.t_cost else dvnfiT.t_amount end t_amountT,
                          -- Обязательста
                          case when dvndeal.t_type != 1 then fininstrT.t_fiid else fininstrO.t_fiid end t_fiidO,
                          case when dvndeal.t_type != 1 then dvnfiT.t_amount else dvnfiT.t_cost end t_amountO 
                   from ddvndeal_dbt dvndeal 
                   join (select :bdt bdt, :edt edt, :typ typ from dual) on 1=1
                   join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dvndeal.t_kind and 
                                                  regexp_like(oprkoper.t_systypes, '[O|U]' --Опцион/Форвард
                                                             )
                   join ddvnfi_dbt dvnfiT on dvnfiT.t_dealid = dvndeal.t_id and 
                                             dvnfiT.t_type = 0 
                   join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvnfiT.t_fiid and 
                                                   ((fininstrT.t_fi_kind in (1,6, 3) and typ in (0,1)) or (fininstrT.t_fi_kind in (2) and typ in (0,2)))
                   join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvnfiT.t_pricefiid and 
                                                   fininstrO.t_fi_kind = 1  
                   where dvndeal.t_dockind = 199 --Внебиржевая сделка с ПИ  
                         and dvndeal.t_date <= edt and 
                         dvndeal.t_ispfi = chr(88) and
                         dvndeal.t_state >= 1
                   union all
                   -- +СВОП
                   select bdt, edt, typ, fininstrT.t_fi_kind fi_kind,
                          -- Сделка
                          dvndeal.t_id, dvndeal.t_state, dvndeal.t_dockind,  
                          dvndeal.t_extcode, dvndeal.t_code, 
                          dvndeal.t_contractor,
                          case when fininstrT.t_fi_kind in (1,6) then case when dvndeal.t_type != 5 then 'покупка' else 'продажа' end ||' '|| fininstrT.t_ccy||' за '||fininstrO.t_ccy else '-' end t_dealtype,
                          dvndeal.t_date, greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdate,
                          dvndeal.t_ispfi, dvndeal.t_marketkind,
                          -- Требования
                          case when dvndeal.t_type = 5 then fininstrO.t_fiid else fininstrT.t_fiid end t_fiidT,
                          case when dvndeal.t_type = 5 then dvnfiT.t_cost else dvnfiT.t_amount end t_amountT,
                          -- Обязательста
                          case when dvndeal.t_type = 5 then fininstrT.t_fiid else fininstrO.t_fiid end t_fiidO,
                          case when dvndeal.t_type = 5 then dvnfiT.t_amount else dvnfiT.t_cost end t_amountO 
                   from ddvndeal_dbt dvndeal 
                   join (select :bdt bdt, :edt edt, :typ typ from dual) on 1=1
                   join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dvndeal.t_kind and 
                                                  regexp_like(oprkoper.t_systypes, '[S|H]' --Валютный СВОП/КСВОП
                                                              )
                   join ddvnfi_dbt dvnfiT on dvnfiT.t_dealid = dvndeal.t_id and 
                                             dvnfiT.t_type = 2 
                   join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvnfiT.t_fiid and 
                                                   fininstrT.t_fi_kind in (1,6)
                   join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvnfiT.t_pricefiid and 
                                                   fininstrO.t_fi_kind = 1  
                   where dvndeal.t_dockind in (199 --Внебиржевая сделка с ПИ
                                               , 4813 --Конверсионная сделка ФИССиКО
                                               ) and 
                         dvndeal.t_date <= edt and 
                         dvndeal.t_state >= 1 and
                         dvndeal.t_ispfi = chr(88) and
                         typ in (0,1)
                   union all
                   -- Покупка/продажа конверсионной операцией (валюта за драгметалл, драгметалл за валюту и валюта за валюту)
                   select bdt, edt, typ, fininstrT.t_fi_kind fi_kind,
                          -- Сделка
                          dvndeal.t_id, dvndeal.t_state, dvndeal.t_dockind,  
                          dvndeal.t_extcode, dvndeal.t_code, 
                          dvndeal.t_contractor,
                          case when fininstrT.t_fi_kind in (1,6) then case when dvndeal.t_type = 1 then 'покупка' else 'продажа' end ||' '|| fininstrT.t_ccy||' за '||fininstrO.t_ccy else '-' end t_dealtype,
                          dvndeal.t_date, greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdate,
                          dvndeal.t_ispfi, dvndeal.t_marketkind,
                          -- Требования
                          case when dvndeal.t_type != 1 then fininstrO.t_fiid else fininstrT.t_fiid end t_fiidT,
                          case when dvndeal.t_type != 1 then dvnfiT.t_cost else dvnfiT.t_amount end t_amountT,
                          -- Обязательста
                          case when dvndeal.t_type != 1 then fininstrT.t_fiid else fininstrO.t_fiid end t_fiidO,
                          case when dvndeal.t_type != 1 then dvnfiT.t_amount else dvnfiT.t_cost end t_amountO 
                   from ddvndeal_dbt dvndeal 
                   join (select :bdt bdt, :edt edt, :typ typ from dual) on 1=1
                   join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dvndeal.t_kind and 
                                                  regexp_like(oprkoper.t_systypes, 'D'--Покупка/продажа
                                                             )
                   join ddvnfi_dbt dvnfiT on dvnfiT.t_dealid = dvndeal.t_id and 
                                             dvnfiT.t_type = 0 
                   join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvnfiT.t_fiid and 
                                                   fininstrT.t_fi_kind in (1,6)
                   join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvnfiT.t_pricefiid and 
                                                   fininstrO.t_fi_kind in (1,6)  
                   where dvndeal.t_dockind = 4813 --Конверсионная сделка ФИССиКО  
                         and dvndeal.t_date <= edt and 
                         dvndeal.t_state >= 1 and
                         dvndeal.t_ispfi = chr(88) and
                         typ in (0,1)
                   union all
                   -- Покупка/продажа сделкой Т+ (любой актив за валюту)
                   select bdt, edt, typ, fininstrT.t_fi_kind fi_kind,
                          -- Сделка
                          dvndeal.t_id, dvndeal.t_state, dvndeal.t_dockind,  
                          dvndeal.t_extcode, dvndeal.t_code, 
                          dvndeal.t_contractor,
                          case when fininstrT.t_fi_kind in (1,6) then case when dvndeal.t_type = 1 then 'покупка' else 'продажа' end ||' '|| fininstrT.t_ccy||' за '||fininstrO.t_ccy else '-' end t_dealtype,
                          dvndeal.t_date, greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdate,
                          dvndeal.t_ispfi, dvndeal.t_marketkind,
                          -- Требования
                          case when dvndeal.t_type != 1 then fininstrO.t_fiid else fininstrT.t_fiid end t_fiidT,
                          case when dvndeal.t_type != 1 then dvnfiT.t_cost else dvnfiT.t_amount end t_amountT,
                          -- Обязательста
                          case when dvndeal.t_type != 1 then fininstrT.t_fiid else fininstrO.t_fiid end t_fiidO,
                          case when dvndeal.t_type != 1 then dvnfiT.t_amount else dvnfiT.t_cost end t_amountO 
                   from ddvndeal_dbt dvndeal 
                   join (select :bdt bdt, :edt edt, :typ typ from dual) on 1=1
                   join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dvndeal.t_kind and 
                                                  regexp_like(oprkoper.t_systypes, 'D' --Покупка/продажа
                                                             )
                   join ddvnfi_dbt dvnfiT on dvnfiT.t_dealid = dvndeal.t_id and 
                                             dvnfiT.t_type = 0 
                   join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvnfiT.t_fiid and 
                                                   ((fininstrT.t_fi_kind in (1,6) and typ in (0,1)) or (fininstrT.t_fi_kind in (2) and typ in (0,2)))
                   join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvnfiT.t_pricefiid and 
                                                   fininstrO.t_fi_kind = 1  
                   where dvndeal.t_dockind = 4815 --Сделка Т+3 
                         and dvndeal.t_date <= edt and 
                         dvndeal.t_ispfi = chr(88) and
                         dvndeal.t_state >= 1) dvndeal
              where dvndeal.t_state = 1 or t_execdate >= bdt) dvndeal
        join ddvnfrval_dbt dvnfrval on dvndeal.t_dvnfrvalid > 0 and dvnfrval.t_id = dvndeal.t_dvnfrvalid
        join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvndeal.t_fiidT  
        join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvndeal.t_fiidO  
        left join dparty_dbt contragent on contragent.t_partyid = dvndeal.t_contractor
        left join doproper_dbt oproper on oproper.t_dockind = dvndeal.t_dockind and 
              oproper.t_documentid = lpad(dvndeal.t_id,34,'0')
        order by dvndeal.t_date, dvndeal.t_code 
      ];
      m_cmd = RsdCommand(EndCaptureOutput());
      m_cmd.AddParam("bdt", RSDBP_IN, m_BeginDate);
      m_cmd.AddParam("edt", RSDBP_IN, m_EndDate);
      m_cmd.AddParam("typ", RSDBP_IN, 1);
      m_cmd.Execute();
      m_RS = TRsbDataSet(m_cmd);
      cnt = 0;
      while(m_RS.movenext)
        if(cnt == 0)
          InitProgress(int(m_RS.value("t_cnt")), "Ждите...", "Формирование таблицы \"ОД_7\" по валюте");
        end;
        cnt = cnt + 1;
        /*Выводим строку отчета*/
        if(((flagss == IND_YES) and (m_RS.value("t_fairvalue") != 0)) or (m_RS.value("t_70614") != 0) or (m_RS.value("t_70613") != 0))
          PrintTableLine(
                /* 1*/ "row1_1", "", null, 
                /* 2*/ "row1_2", m_RS.value("t_code"), null, 
                /* 3*/ "row1_3", m_RS.value("t_contragentname"), null, 
                /* 4*/ "row1_4", "", null, 
                /* 5*/ "row1_5", m_RS.value("t_contragentbank"), null, 
                /* 6*/ "row1_6", m_RS.value("t_isresident"), null, 
                /* 7*/ "row1_7", m_RS.value("t_dealtype"), null, 
                /* 8*/ "row1_8", date(m_RS.value("t_date")), null, 
                /* 9*/ "row1_9", date(m_RS.value("t_execdate")), null, 
                /*10*/ "row1_10", m_RS.value("t_days"), null, 
                /*11*/ "row1_11", m_RS.value("t_ccyT"), null, 
                /*12*/ "row1_12", m_RS.value("t_amountT"), null, 
                /*13*/ "row1_13", m_RS.value("t_amountTRUR"), null, 
                /*14*/ "row1_14", m_RS.value("t_amountTCurRUR"), null, 
                /*15*/ "row1_15", m_RS.value("t_ccyO"), null, 
                /*16*/ "row1_16", m_RS.value("t_amountO"), null, 
                /*17*/ "row1_17", m_RS.value("t_amountORUR"), null, 
                /*18*/ "row1_18", m_RS.value("t_amountOCurRUR"), null, 
                /*19*/ "row1_19", m_RS.value("t_ispfi"), null, 
                /*20*/ "row1_20", "-", null, 
                /*21*/ "row1_21", "-", null, 
                /*22*/ "row1_22", m_RS.value("t_70614"), null, 
                /*23*/ "row1_23", m_RS.value("t_70613"), null, 
                /*24*/ "row1_24", m_RS.value("t_dealclass"), null);
        end;
        UseProgress(cnt);
      end;
      if(cnt > 0)
        RemProgress();
      end;
    end;
    if(m_Form.GetFieldValue(PNFLD_SECURITY) == "X")
      StartCaptureOutput();
      [
        select count(1) over() t_cnt, 
               t_code,
               t_extcode,
               case when t_issuer = 'ММВБ' then 'БАНК НКЦ (АО)' else chr(1) end t_contragent,
               t_issuer,
               case when t_issuer = 'ММВБ' then 'БАНК НКЦ (АО)' else chr(1) end t_creditorg,
               t_resident,
               t_dealtype,
               t_dealdate,
               t_drawingdate,
               t_dealduration,
               t_dealcost,
               t_ispfi,
               t_70614,
               t_70613,
               case when t_issuer = 'ММВБ' then t_issuer else chr(1) end t_classificator,
               NVL((select fin.t_fi_code from dfininstr_dbt fin where fin.t_fiid = fiid_tr), CHR(1))  fiid_tr_code,
               sumd_tr,
               sumk_tr,
               NVL((select fin.t_fi_code from dfininstr_dbt fin where fin.t_fiid = fiid_ob), CHR(1)) fiid_ob_code,
               sumd_ob,
               sumk_ob 
        from (select dvdeal.t_code t_code,
                     dvdeal.t_extcode t_extcode, 
                     (select nvl(max(objcode.t_code),nvl(partyissuer.t_shortname,chr(1))) 
                      from dobjcode_dbt objcode 
                      where objcode.t_objecttype = 3 and 
                            objcode.t_codekind = 8 --ММВБ 
                            and objcode.t_objectid = fininstr.t_issuer and 
                            objcode.t_bankdate <= edt and 
                            (objcode.t_bankclosedate = to_date('01.01.0001','dd.mm.yyyy') or objcode.t_bankclosedate > edt)) t_issuer,
                     case when nvl(partyissuer.t_notresident,chr(0)) = chr(88) then 'N' 
                          else 'R' 
                     end t_resident,
                     case when regexp_like(dvdeal.t_type, 'S') then 'Продажа'||fininstr.t_name 
                          when regexp_like(dvdeal.t_type, 'B') then 'Покупка'||fininstr.t_name 
                          else fininstr.t_name 
                     end t_dealtype,
                     dvdeal.t_date t_dealdate,
                     fininstr.t_drawingdate t_drawingdate,
                     fininstr.t_drawingdate - dvdeal.t_date t_dealduration,
                     dvdeal.t_positioncost t_dealcost,
                     case when fininstr.t_fi_kind = 4 --Производные инструменты
                          then 'ДА' 
                          else 'НЕТ' 
                     end t_ispfi, 
                     trn.t_70614 t_70614,
                     trn.t_70613 t_70613,
                     NVL(dealtrn_tr.fiid, -1) fiid_tr,
                     NVL(dealtrn_tr.sumd, -1) sumd_tr,
                     NVL(dealtrn_tr.sumk, 0) sumk_tr,
                     NVL(dealtrn_ob.fiid, -1) fiid_ob,
                     NVL(dealtrn_ob.sumd, -1) sumd_ob,
                     NVL(dealtrn_ob.sumk, 0) sumk_ob
              from (select bdt, 
                           edt, 
                           trn.t_dealid, 
                           sum(trn.t_70614) t_70614, 
                           sum(trn.t_70613) t_70613
                    from (select bdt, 
                                 edt, 
                                 oproper.t_start_date 
                                 t_operdate, 
                                 to_number(acctrn.t_userfield1) t_dealid, 
                                 case when acctrn.t_account_receiver like '70614%' then acctrn.t_sum_natcur 
                                      when acctrn.t_account_payer like '70614%' then -acctrn.t_sum_natcur 
                                      else 0 
                                 end t_70614, 
                                 case when acctrn.t_account_receiver like '70613%' then acctrn.t_sum_natcur 
                                      when acctrn.t_account_payer like '70613%' then -acctrn.t_sum_natcur 
                                      else 0 
                                 end t_70613  
                          from doproper_dbt oproper
                          join (select :bdt bdt, :edt edt from dual) on 1=1
                          join doprkoper_dbt oprkoper on oprkoper.t_dockind = oproper.t_dockind and 
                                             oprkoper.t_shortname = 'РАСЧЕТЫ_ПИ' and 
                                             oprkoper.t_kind_operation = oproper.t_kind_operation
                          join doprdocs_dbt oprdocs on oprdocs.t_id_operation = oproper.t_id_operation and 
                                                       oprdocs.t_dockind = 1 --проводка
                          join dacctrn_dbt acctrn on acctrn.t_chapter = 1 and 
                                                     acctrn.t_acctrnid = oprdocs.t_acctrnid and 
                                                     acctrn.t_userfield1 != chr(1) and 
                                                     regexp_like(acctrn.t_userfield1, '^\d{1,}$') and 
                                                     (regexp_like(acctrn.t_account_payer, '^7061[3|4]') or regexp_like(acctrn.t_account_receiver, '^7061[3|4]'))
                          where oproper.t_dockind = 194 --Расчеты по ПИ
                                and oproper.t_start_date between bdt and edt) trn
                          group by bdt, edt, trn.t_dealid) trn 
                    join ddvdeal_dbt dvdeal on dvdeal.t_id = trn.t_dealid /*and
                                               dvdeal.t_date between bdt and edt*//*PNV i-support 504036*/                                                               
                    join dfininstr_dbt fininstr on fininstr.t_fiid = dvdeal.t_fiid 
                    left join dparty_dbt partyissuer on partyissuer.t_partyid = fininstr.t_issuer
                    left join (select dtrn.t_DealID dealid,  step.t_AccountDate AccDate, acctrn.t_FIID_PAYER fiid, acctrn.t_SUM_PAYER sumd, acctrn.t_SUM_RECEIVER sumk
                                 FROM  ddvdealtrn_dbt dtrn, doprstep_dbt step, dacctrn_dbt acctrn 
                               WHERE dtrn.t_ID_Step = 6 
                                    and step.t_ID_Operation = dtrn.t_ID_Operation 
                                    and step.t_ID_Step = dtrn.t_ID_Step
                                    and  acctrn.t_acctrnid = dtrn.t_AccTrnID 
                                    and substr(acctrn.t_account_payer, 1, 2) in ('93', '94') ) dealtrn_tr on dealtrn_tr.dealid = dvdeal.t_id and dealtrn_tr.AccDate = dvdeal.t_Date_Clr 
                    left join (select dtrn.t_DealID dealid,  step.t_AccountDate AccDate, acctrn.t_FIID_RECEIVER fiid, acctrn.t_SUM_PAYER sumd, acctrn.t_SUM_RECEIVER sumk
                                 FROM  ddvdealtrn_dbt dtrn, doprstep_dbt step, dacctrn_dbt acctrn 
                               WHERE dtrn.t_ID_Step = 6 
                                    and step.t_ID_Operation = dtrn.t_ID_Operation 
                                    and step.t_ID_Step = dtrn.t_ID_Step
                                    and  acctrn.t_acctrnid = dtrn.t_AccTrnID 
                                    and substr(acctrn.t_account_receiver, 1, 2) in ('96', '97') ) dealtrn_ob on dealtrn_ob.dealid = dvdeal.t_id and dealtrn_ob.AccDate = dvdeal.t_Date_Clr
                )
        order by t_dealdate desc, t_code desc 
      ];
      m_cmd = RsdCommand(EndCaptureOutput());
      m_cmd.AddParam("bdt", RSDBP_IN, m_BeginDate);
      m_cmd.AddParam("edt", RSDBP_IN, m_EndDate);
      m_cmd.Execute();
      m_RS = TRsbDataSet(m_cmd);
      cnt = 0;
      while(m_RS.movenext)
        if(cnt == 0)
          InitProgress(int(m_RS.value("t_cnt")), "Ждите...", "Формирование таблицы \"ОД_7\" по ценным бумагам");
        end;
        cnt = cnt + 1;
        /*Выводим строку отчета*/
        var rate_tr, rate_ob;
        if ((m_RS.value("sumd_tr") == 0))
           rate_tr = 0;
        else
           rate_tr = m_RS.value("sumk_tr")/m_RS.value("sumd_tr");
        end;
        if ((m_RS.value("sumk_ob") == 0))
           rate_ob = 0;
        else
           rate_ob = m_RS.value("sumd_ob")/m_RS.value("sumk_ob");
        end;
        PrintTableLine(
              /* 1*/ "row1_1", "", null, 
              /* 2*/ "row1_2", m_RS.value("t_extcode"), null, 
              /* 3*/ "row1_3", m_RS.value("t_contragent"), null, 
              /* 4*/ "row1_4", m_RS.value("t_issuer"), null, 
              /* 5*/ "row1_5", m_RS.value("t_creditorg"), null, 
              /* 6*/ "row1_6", m_RS.value("t_resident"), null, 
              /* 7*/ "row1_7", m_RS.value("t_dealtype"), null, 
              /* 8*/ "row1_8", date(m_RS.value("t_dealdate")), null,    
              /* 9*/ "row1_9", date(m_RS.value("t_drawingdate")), null, 
              /*10*/ "row1_10", m_RS.value("t_dealduration"), null, 
              /*11*/ "row1_11", m_RS.value("fiid_tr_code"), null, 
              /*12*/ "row1_12", m_RS.value("sumd_tr"), null, 
              /*13*/ "row1_13", m_RS.value("sumk_tr"), null, 
              /*14*/ "row1_14", rate_tr, null, 
              /*15*/ "row1_15", m_RS.value("fiid_ob_code"), null, 
              /*16*/ "row1_16", m_RS.value("sumk_ob"), null, 
              /*17*/ "row1_17", m_RS.value("sumd_ob"), null, 
              /*18*/ "row1_18", rate_ob, null, 
              /*19*/ "row1_19", m_RS.value("t_ispfi"), null, 
              /*20*/ "row1_20", "", null, 
              /*21*/ "row1_21", "", null, 
              /*22*/ "row1_22", m_RS.value("t_70614"), null, 
              /*23*/ "row1_23", m_RS.value("t_70613"), null,
              /*24*/ "row1_24", m_RS.value("t_classificator"), null);
        UseProgress(cnt);
      end;
      if(cnt > 0)
        RemProgress();
      end;
    end;
    EndTable();

    SetActiveSheet("Расшифровка");
    if(m_Form.GetFieldValue(PNFLD_CURRENCY) == "X")
      if(m_Form.GetFieldValue(PNFLD_SECURITY) == "X")
        PrintFormatString("", "reportname2", "Расшифровка. Таблица ОД-7 Реестр сделок, которые были открыты c " + string(m_BeginDate:f) + " по " + string(m_EndDate:f) + ", и изменение справедливой стоимости которых было отражено на символах 25101-25105, 25201-25205, 25401-25405, 25501-25505, 45101-45105, 45201-45205, 45401-45405, 45501-45505");
      else
        PrintFormatString("", "reportname2", "Расшифровка. Таблица ОД-7 Реестр валютно-процентных сделок СВОП, форвардов и опционов, которые были открыты c " + string(m_BeginDate:f) + " по " + string(m_EndDate:f) + ", и изменение справедливой стоимости которых было отражено на символах 25101-25105, 25201-25205, 25401-25405, 25501-25505, 45101-45105, 45201-45205, 45401-45405, 45501-45505");
      end;
    else
      PrintFormatString("", "reportname2", "Расшифровка. Таблица ОД-7 Реестр биржевых сделок, которые были открыты c " + string(m_BeginDate:f) + " по " + string(m_EndDate:f) + ", и изменение справедливой стоимости которых было отражено на символах 25101-25105, 25201-25205, 25401-25405, 25501-25505, 45101-45105, 45201-45205, 45401-45405, 45501-45505");
    end;

    RegisterTable( "row2_0", "",
            /* 1*/ "row2_1", 
            /* 2*/ "row2_2", 
            /* 3*/ "row2_3", 
            /* 4*/ "row2_4", 
            /* 5*/ "row2_5", 
            /* 6*/ "row2_6", 
            /* 7*/ "row2_7", 
            /* 8*/ "row2_8");

    if(m_Form.GetFieldValue(PNFLD_SECURITY) == "X")
      StartCaptureOutput();
      [
              select count(1) over() t_cnt, 
                     dvdeal.t_extcode t_extcode,        
                     dvdeal.t_date t_dealdate,
                     fininstr.t_drawingdate t_drawingdate,
                     trn.t_date_carry,
                     trn.t_account_receiver,
                     trn.t_account_payer,
                     trn.t_sum_natcur,
                     trn.t_ground
              from (select bdt, 
                           edt,
                           trn.t_dealid, 
                           trn.t_date_carry,
                           trn.t_account_receiver,
                           trn.t_account_payer,
                           trn.t_sum_natcur,
                           trn.t_ground
                    from (select bdt, 
                                 edt, 
                                 oproper.t_start_date 
                                 t_operdate, 
                                 to_number(acctrn.t_userfield1) t_dealid, 
                                 acctrn.t_acctrnid,
                                 acctrn.t_date_carry,
                                 acctrn.t_account_receiver,
                                 acctrn.t_account_payer,
                                 acctrn.t_sum_natcur,
                                 acctrn.t_ground
                          from doproper_dbt oproper
                          join (select :bdt bdt, :edt edt from dual) on 1=1
                          join doprkoper_dbt oprkoper on oprkoper.t_dockind = oproper.t_dockind and 
                                             oprkoper.t_shortname = 'РАСЧЕТЫ_ПИ' and 
                                             oprkoper.t_kind_operation = oproper.t_kind_operation
                          join doprdocs_dbt oprdocs on oprdocs.t_id_operation = oproper.t_id_operation and 
                                                       oprdocs.t_dockind = 1 --проводка
                          join dacctrn_dbt acctrn on acctrn.t_chapter = 1 and 
                                                     acctrn.t_acctrnid = oprdocs.t_acctrnid and 
                                                     acctrn.t_userfield1 != chr(1) and 
                                                     regexp_like(acctrn.t_userfield1, '^\d{1,}$') and 
                                                     (regexp_like(acctrn.t_account_payer, '^7061[3|4]') or regexp_like(acctrn.t_account_receiver, '^7061[3|4]'))
                          where oproper.t_dockind = 194 --Расчеты по ПИ
                                and oproper.t_start_date between bdt and edt) trn
                          ) trn 
                    join ddvdeal_dbt dvdeal on dvdeal.t_id = trn.t_dealid and
                                               dvdeal.t_date between bdt and edt                                                               
                    join dfininstr_dbt fininstr on fininstr.t_fiid = dvdeal.t_fiid 
                    left join dparty_dbt partyissuer on partyissuer.t_partyid = fininstr.t_issuer
           order by dvdeal.t_date desc, dvdeal.t_extcode desc 
      ];
      m_cmd = RsdCommand(EndCaptureOutput());
      m_cmd.AddParam("bdt", RSDBP_IN, m_BeginDate);
      m_cmd.AddParam("edt", RSDBP_IN, m_EndDate);
      m_cmd.Execute();
      m_RS = TRsbDataSet(m_cmd);
      cnt = 0;
      while(m_RS.movenext)
        if(cnt == 0)
          InitProgress(int(m_RS.value("t_cnt")), "Ждите...", "Формирование расшифровки таблицы \"ОД_7\" по ценным бумагам");
        end;
        cnt = cnt + 1;
        /*Выводим строку отчета*/
        PrintTableLine(
              /* 1*/ "row2_1", m_RS.value("t_extcode"), null, 
              /* 2*/ "row2_2", date(m_RS.value("t_dealdate")), null, 
              /* 3*/ "row2_3", date(m_RS.value("t_drawingdate")), null, 
              /* 4*/ "row2_4", date(m_RS.value("t_date_carry")), null, 
              /* 5*/ "row2_5", m_RS.value("t_account_payer"), null, 
              /* 6*/ "row2_6", m_RS.value("t_account_receiver"), null, 
              /* 7*/ "row2_7", m_RS.value("t_sum_natcur"), null, 
              /* 8*/ "row2_8", m_RS.value("t_ground"), null);
        UseProgress(cnt);
      end;
      if(cnt > 0)
        RemProgress();
      end;
    end;

    EndTable();


  END;
  
  initTX_RegistrReport(od07_Panel(), "od07.xlsx");

END;

/*Точка входа*/
var r = od07_Report();
r.InitReport("ОД07", null);
r.Run();

exit(1);
