import "Orders_report.mac";
import rsd;
import "DLReport_h.mac", "dlreport.mac", "dlQuery.mac", "scsrvrepfun.mac", "sc_inacc.mac";
import "dl_util_xml_obj.mac";
import RsbFormsInter;

    var prm = CDLCalcOrdersParm();
/*
    prm.BegDate = Date("05.07.2020");
    prm.EndDate = Date("25.09.2020");
    prm.fiid = 22837;
    DL_CalcOrders_Report(prm);
*/


private class ReportParams()
    var BegDate:date,
        Enddate:date,
        fiid:integer;
 end;

private const FT_STRING = 7;
private const FT_DATE = 9;

macro avoir_event(rs, cmd, id, key)
    if(cmd == DLG_KEY)
        if(key == 13)
            return CM_SELECT;
        end;
    end;
end;

class (TRsbPanel) MyRsbPanel1
    InitTRsbPanel();
    setSize(80,6);
    setPosition(35,15);


    var currentRS;
    var CurFiid = -1;
    addLabel(TRsbLabel(3, 2, "Выпуск:"));
    var m_sEditFld:String = "";
    var m_EditField:TRsbEditField = TRsbEditField(FT_STRING);
    m_EditField.bindValue(this, "m_sEditFld", 20);
    m_EditField.setPosition(10,2);
    m_EditField.setSize(20,1);
    addControl(m_EditField);

    addLabel(TRsbLabel(3, 3, "ISIN:"));
    var m_sEditFld2:String = "";
    var m_EditField2:TRsbEditField = TRsbEditField(FT_STRING);
    m_EditField2.bindValue(this, "m_sEditFld2", 20);
    m_EditField2.setPosition(10,3);
    m_EditField2.setSize(20,1);
    m_EditField2.enabled = false;
    addControl(m_EditField2);

    addLabel(TRsbLabel(3, 4, "Наименование:"));
    var m_sEditFld3:String = "";
    var m_EditField3:TRsbEditField = TRsbEditField(FT_STRING);
    m_EditField3.bindValue(this, "m_sEditFld2", 50);
    m_EditField3.setPosition(15,4);
    m_EditField3.setSize(50,1);
    m_EditField3.enabled = false;
    addControl(m_EditField3);


    addLabel(TRsbLabel(3, 1, "Период:"));
    var m_DateBegin:TRsbEditField = TRsbEditField(FT_DATE);
    m_DateBegin.setPosition(10,1);
    m_DateBegin.setSize(10,1);
    m_DateBegin.value = {curdate};
    m_DateBegin.addEventHandler(RSB_EV_KEY_PRESSED , R2M(this, "DATEBEGIN_KEY_PRESSED"));
    addControl(m_DateBegin);

    var m_DateEnd:TRsbEditField = TRsbEditField(FT_DATE);
    m_DateEnd.setPosition(24,1);
    m_DateEnd.setSize(10,1);
    m_DateEnd.value = {curdate};
    m_DateEnd.addEventHandler(RSB_EV_KEY_PRESSED , R2M(this, "DATEEND_KEY_PRESSED"));
    addControl(m_DateEnd);

    m_EditField.addEventHandler(RSB_EV_KEY_PRESSED , R2M(this, "EditField_KEY_PRESSED"));
    m_EditField.addEventHandler(RSB_EV_REMOVE_FOCUS , R2M(this, "EditField_EXIT"));
    addEventHandler(RSB_EV_KEY_PRESSED , R2M(this, "Panel_ButtonEvent"));

    PRIVATE MACRO AddCol (ar,ind, fld, head, width, rdonly, ty, dp)
        ar.value (ind * 6)     = fld;
        ar.value (ind * 6 + 1) = head;
        ar.value (ind * 6 + 2) = width;
        ar.value (ind * 6 + 3 ) = rdonly;   // fldType
        ar.value (ind * 6 + 4 ) = dp;//   decPoint
        ar.value (ind * 6 + 5 ) = 0;   // reserv
    END;

    Private Macro CheckFiid(fiid);

        var cmd = DL_RSDCommand(" SELECT * from dfininstr_dbt where t_fiid =  ? ");

        cmd.addParam(fiid); 
        var DataSet = cmd.execute();

        If (DataSet.moveNext())
            If(DataSet.issuer == {ourbank})
               return true;
            else
               return false;
            end;
        else
           return false;
        end;
    end;
    macro getClientsList(default)
        var query = " select f.t_fiid, f.t_fi_code, av.t_isin, f.t_name from dfininstr_dbt  f, davoiriss_dbt av where f.t_fi_kind = 2 and f.t_fiid = av.t_fiid";
                      
        var col1 = TArray;   
        var arnum = -1;
        AddCol (col1, arnum=arnum+1, "t_fiid",    "ID выпуска",        10,  0,0);
        AddCol (col1, arnum=arnum+1, "t_fi_code", "Код выпуска",20,  0,0);
        AddCol (col1, arnum=arnum+1, "t_ISIN",    "ISIN",          25,  0);
        AddCol (col1, arnum=arnum+1, "t_Name",    "Наименование",          50,  0);

        var cmd1 = RsdCommand(query);
        var rs1 = RsdRecordSet(cmd1, rsdval_client, rsdval_static);
        if(RunScroll(rs1, arnum+1, col1, null ,"avoir_event","Справочник выпусков "))
            currentRS = rs1;
            return rs1.value("t_fiid");
        end;

        return default;
    end;


    macro EditField_KEY_PRESSED(RsbEvent)
       if(RsbEvent.keyCode == 317)

          m_sEditFld = getClientsList(m_sEditFld);
          m_EditField.value = currentRS.value("t_fi_code");
          m_EditField2.value = currentRS.value("t_isin");
          m_EditField3.value = currentRS.value("t_name");
          CurFiid =  currentRS.value("t_fiid");
          If( not CheckFiid(CurFiid))
             MsgBox("Должен быть выбран выпуск облигации банка РСХБ!");
             CurFiid = -1;
             m_EditField3.value = "";
             m_EditField2.value = "";
             m_EditField.value = "";
          end;
       end;

       if(RsbEvent.keyCode == 27)
          close(0);
       end

    end;

    macro EditField_EXIT(RsbEvent)
        if(currentRS)
          if(currentRS.value("t_fi_code") != null)
            m_EditField.value = currentRS.value("t_fi_code");
            m_EditField2.value = currentRS.value("t_isin");
            m_EditField3.value = currentRS.value("t_name");
          else
            m_EditField2.value = "";
            m_EditField3.value = "";
          end;
        else
          m_EditField2.value = "";
          m_EditField3.value = "";
        end;
    end;

    macro Panel_ButtonEvent(RsbEvent)
       if(RsbEvent.keyCode == 316)
	   If( not CheckFiid(CurFiid))
              MsgBox("Должен быть выбран выпуск облигации банка РСХБ!");
	   else
              prm.BegDate = m_DateBegin.value;
              prm.EndDate = m_DateEnd.value;
              prm.fiid = CurFiid;
              DL_CalcOrders_Report(prm);
           end;
       end;
    end;

    macro DATEBEGIN_KEY_PRESSED(RsbEvent)
       if(RsbEvent.keyCode == 317)
           m_DateBegin.value = GetDateByCalendar(m_DateBegin.value);
       end;
    end;

    macro DATEEND_KEY_PRESSED(RsbEvent)
       if(RsbEvent.keyCode == 317)
           m_DateEnd.value = GetDateByCalendar(m_DateEnd.value);
       end;
    end;
end;

var panel = MyRsbPanel1;
panel.run;
