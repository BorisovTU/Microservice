/************************************************************************/
/*  Имя файла      : dbo.mac                                            */
/*                                                                      */
/*  Описание       : Отправка сообщений клиентам принятых               */
/*                   на обслуживание                                    */
/*                                                                      */
/*  Программист    : Филиппов Б.В.                                      */
/*                                                                      */
/*  Создан         : 11.10.2018                                         */
/************************************************************************/
import "dbo_message_main.mac";

class (TRecHandler) PrintForm
   initTRecHandler ("PrForm", "PrintForm.lbr", true);

   var dgoMess = dboMessage(dlcid);
   if (dgoMess.statsend == -1)
      exit();
   end;

   this.("DateOp")   = {curdate};
   this.("Account")  = dgoMess.NameDP;
   this.("NameBO")   = dgoMess.NameBO;   
   this.("NumberBO") = dgoMess.NumberBO;
   this.("Party")    = dgoMess.partyForm;
   this.("DIIS")     = dgoMess.iisNumber;

   macro handler(dlg, cmd, id, key)
   if (cmd == DLG_INIT)
      this.("CheckReceiver") = "X";
      this.("CheckTest")   = "";   
      DisableFields (dlg, dlg.fldindex("testEmail"));
      this.("testEmail")   = "RadionovaOS@rshb.ru";
      if (dgoMess.isGOClient())
         DisableFields (dlg, dlg.fldindex("Check1"));
      else
         this.("Check2") = "X"; 
      end;
      if (this.("Check2") == "");
         DisableFields (dlg, dlg.fldindex("CheckTest"));
      end;
      if (not dgoMess.isExistsMessage())
         DisableFields (dlg, dlg.fldindex("Check1"));
      end;
      this.("SendNumber") = 1;/*"2"*/;/*CHVA 516006*/
      EnableFields(dlg, dlg.fldindex("SendNumber"));

      UpdateFields(dlg);
   end;

   if (cmd == DLG_KEY)
   end;
   if ((cmd == DLG_KEY) and (key == 32))  // Клавиша Пробел
      if (fldname (id) == "Check1")
         if (this.("Check1") == "");
            this.("Check1") = "X";
         else
            this.("Check1") = "";
         end;
      elif (fldname (id) == "Check2")
         if (this.("Check2") == "");
            this.("Check2") = "X";
            //EnableFields(dlg, dlg.fldindex("CheckReceiver"));
            EnableFields(dlg, dlg.fldindex("CheckTest"));
         else
            this.("Check2") = "";
            //DisableFields(dlg, dlg.fldindex("CheckReceiver"));
            DisableFields(dlg, dlg.fldindex("CheckTest"));
            this.("CheckTest")     = "";
            //this.("CheckReceiver") = "";
         end;
      elif (fldname (id) == "CheckReceiver")
         if (this.("CheckReceiver") == "");
            this.("CheckReceiver") = "X";
         else
            this.("CheckReceiver") = "";
         end;
      elif (fldname (id) == "CheckTest")
         if (this.("CheckTest") == "");
            this.("CheckTest") = "X";
            EnableFields(dlg, dlg.fldindex("testEmail"));
         else
            this.("CheckTest") = "";
            DisableFields(dlg, dlg.fldindex("testEmail"));
         end;
      end;

      UpdateFields(dlg);

   elif ((cmd == DLG_KEY) and (key == 316))  // Клавиша F2

      if ((this.("CheckTest") == "X") and (this.("TestEmail") == ""))
         MsgBox("Укажите адрес для тестовой отправки");
         return CM_IGNORE;
      end;
      if (this.("SendNumber") == "")
         MsgBox("Укажите номер уведомления");
         return CM_IGNORE;
      end;

      //BIQ-7033 формирование текстового файла для новых договоров
      var new_depo = CheckContractForNovelty(dlcid);

      InitProgress(-1);
      dgoMess.CreateMessage(this.("Check1") == "X",
                            this.("Check2") == "X",
                            this.("CheckReceiver") == "X",
                            this.("CheckTest") == "X",
                            this.("testEmail"),
			    this.("SendNumber"),
                            new_depo );
      RemProgress;
      if (dgoMess.statsend == -1) 
         MsgBox(dgoMess.statMes);     
      else
         MsgBox("Сформировано сообщение: " + dgoMess.Mess + " || Сообщение прикреплено к договору. Просмотр по Alt+M");
         if (this.("Check2") == "X")  // было что-то отправлено
            if (new_depo)
               FixEvent99(dlcid);
            end;
         end;
      end;
      return CM_CANCEL;   
     end;
   end;

   macro run
   rundialog (this, r2m (this, "handler"));
   end;
End;
//---------------------------------------------------------------------------------------

PrintForm.Run (); 