import cb_sql, globals;

CONST PROCEDURE_NAME = "rsFillPortfolio2",
      TMP_TABLE_NAME = "DPORTFOLIO2_TMP",
      TOTAL_TABLE_NAME = "tRSHB_Portfolio_PKL_2CHD2";
/*CONST PROCEDURE_NAME = "rsFillPortfolio",
      TMP_TABLE_NAME = "DPORTFOLIO_TMP",
      TOTAL_TABLE_NAME = "tRSHB_Portfolio_PKL_2CHD"; */
/*
var d = {curdate};
GetDate(d,"","");
*/

private macro GetTrueU(f,m, s)
   if (s)
      return f;
   else
      return GetTrue(f,m);
   end;
end;

macro FillPortfolio(d, silent)
var cmd, rs;

if (GetTrueU(true, "Очистить ранее сформированные данные за указанную дату?"
  "\n При выборе \"Нет\"- данные будут удалены только по тем выпускам, по которым будет формироваться ПКЛ Портфель", silent))
   sql_execute("DELETE FROM "+TMP_TABLE_NAME +" WHERE REPORT_DT = " + GetSqlDate(d));
end;

if (GetTrueU(true, "Переформировать? \n Примерное время работы 15-20 мин. \n При выборе \"Нет\" на экран будут выведены ранее сформированные данные, которые можно выгрузить в Excel по нажатию Ctrl+Shift+F11", silent))

    var sql = 
    "  SELECT  t_fiid, count(1) cnt, (select t_definition from dfininstr_dbt where t_fiid = v.t_fiid ) def  " +
    "    FROM v_scwrthistex v     " +
    "   WHERE t_state IN (1, 3) AND t_amount > 0                                    " +
    "         AND t_instance =                                                      " +
    "                (SELECT MAX (t_instance)                                       " +
    "                   FROM v_scwrthistex                                          " +
    "                  WHERE v.t_sumid = t_sumid AND v.t_changedate = t_changedate) " +
    "         AND v.t_changedate =                                                  " +
    "                (SELECT MAX (t.t_changedate)                                     " +
    "                   FROM v_scwrthistex t                                         " +
    "                  WHERE v.t_sumid = t_sumid AND t.t_changedate <= "+GetSqlDate(d)+") " +
    "                  and t_party = -1   " + 
    // " /* and t_fiid = 1953*/  rownum < 4 " +
    "                  group by t_fiid          " ;

    var dt = trsbdataset(sql);
    var cnt = sql_getnrecs(sql);
    InitProgress(cnt, "");
    cnt = 0;
       var tm = time();
       println( "Начало обработки: " + tm );
       println( "----------------------------");
    while (dt.movenext())
       Message("Количество лотов по обрабатываемому выпуску " + substr(dt.def,1,30) + ": \t" + string(dt.cnt:5:0));
       [Количество лотов по обрабатываемому выпуску ##########################:   #####] (dt.def, string(dt.cnt:10:0));
       cmd = RsdCommand(" begin "+PROCEDURE_NAME +"(:f, :d); end;");
       cmd.addParam(":d"  , RSDBP_IN, d);
       cmd.addParam(":f"  , RSDBP_IN, dt.t_fiid);
       cmd.execute;
       UseProgress(cnt=cnt+1);
    end;
       println( "----------------------------");
       println( "Завершение обработки: " + time());
       println( "Продолжительность обработки: " + (time()-tm ));

    RemProgress;
    //MsgBox("Выполнено");
end;
  if (not silent )
    var sql1 = 
    " select  t.*, " 
    "  (select t_definition from dfininstr_dbt where t_fiid = (select t_fiid from davoiriss_dbt " 
    "   where t_isin = t.isin and t_lsin = t.reg_number)) shortname                             " 
    "   from " +TOTAL_TABLE_NAME+" t where report_dt = "+GetSqlDate(d)                      ;
    var rs1 = RsdRecordSet(sql1, rsdval_client, rsdval_static);
    RunScroll(rs1);
  end;
end;

exit(1);