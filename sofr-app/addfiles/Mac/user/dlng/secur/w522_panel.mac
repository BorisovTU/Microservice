import "DlRepForm_h.mac", "globals.mac", rsd, dlquery;

/*Номера полей в форме отчета*/
CONST P_W522_DATE                 = 0,
      P_W522_CLIENT               = 1,
      P_W522_CURRENCY             = 2,
      P_W522_BALACC               = 3,
      P_W522_OverTheCounterMarket = 4,
      P_W522_StockMarket          = 5,
      P_W522_FuturesMarket        = 6;

var V_W522_CNUM = UserNumber();

/* Обработчики для нестандарных контролов */
private CONST H_StockMarket          = 101,
              H_OverTheCounterMarket = 102,
              H_FuturesMarket        = 103,
              H_BalAcc               = 104;


/**/
private MACRO DL_FldProc_CheckBox( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER

  if( Cmd == DLG_INIT )
    if( FldRealValue == null ) /*инициализация по умолчанию*/
      FldRealValue = "X";
    end;
    FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
    FldRealValue = FldShowValue;
  elif( Cmd == DLG_KEY )
    if( Key == KEY_SPACE )
      if(FldRealValue == "X")
        FldShowValue = FldRealValue = " ";
      else
        FldShowValue = FldRealValue = "X";
      end;
    end;
  end;

  return CM_DEFAULT;
END;

/*Установка значений в панели*/
private macro SetName(pThis:DL_CPanel)
  var rscmd, rscnt;
  rscmd = null;
  rscmd = DL_RSDCommand("select count(1) cnt, "
                       + "      nvl(sum(case when t_setflag = chr(88) then 1 else 0 end),0) cntx, "
                       + "      max(case when t_setflag = chr(88) then t_clientname else ' ' end) t_clientname "
                       + "from dset_cln_U_TMP"+V_W522_CNUM+" ");
  rscnt = rscmd.Execute();
  rscnt.movenext();
  if(rscnt.value("cnt") == rscnt.value("cntx"))
    if(rscnt.value("cnt") == 0)
      pThis.SetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_CODE, "Не выбран");
    else
      pThis.SetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_CODE, STR_ALLVALUE);
    end;
  elif(rscnt.value("cntx") > 1)
    pThis.SetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_CODE, "Несколько");
  elif(rscnt.value("cntx") == 1)
    pThis.SetLinkedValue( DL_PNFLD_CLIENT_STOCKDL_CODE, rscnt.value("t_clientname"));
  elif(rscnt.value("cntx") == 0)
    pThis.SetLinkedValue( DL_PNFLD_CLIENT_STOCKDL_CODE, "Не выбран");
  end;
  rscmd = null;    
  rscmd = DL_RSDCommand("select count(1) cnt, "
                       + "      nvl(sum(case when t_setflag = chr(88) then 1 else 0 end), 0) cntx, "
                       + "      max(case when t_setflag = chr(88) then t_ccy else ' ' end) t_ccy "
                       + "from dset_fi_U_TMP"+V_W522_CNUM+" ");
  rscnt = rscmd.Execute();
  rscnt.movenext();
  if(rscnt.value("cnt") == rscnt.value("cntx"))
    if(rscnt.value("cnt") == 0)
      pThis.SetLinkedValue( DL_PNFLD_FI_NAME, "Не выбрана");
    else
      pThis.SetLinkedValue(DL_PNFLD_FI_NAME, STR_ALLVALUE);
    end;
  elif(rscnt.value("cntx") > 1)
    pThis.SetLinkedValue(DL_PNFLD_FI_NAME, "Несколько");
  elif(rscnt.value("cntx") == 1)
    pThis.SetLinkedValue( DL_PNFLD_FI_NAME, rscnt.value("t_ccy"));
  elif(rscnt.value("cntx") == 0)
    pThis.SetLinkedValue( DL_PNFLD_FI_NAME, "Не выбрана");
  end;
  rscmd = DL_RSDCommand("select count(1) cnt, "
                       + "      nvl(sum(case when t_setflag = chr(88) then 1 else 0 end), 0) cntx, "
                       + "      max(case when t_setflag = chr(88) then t_balacc else ' ' end) t_balacc "
                       + "from dset_bacc_U_TMP"+V_W522_CNUM+" ");
  rscnt = rscmd.Execute();
  rscnt.movenext();
  if(rscnt.value("cnt") == rscnt.value("cntx"))
    if(rscnt.value("cnt") == 0)
      pThis.SetLinkedValue( H_BalAcc, "Не выбран");
    else
      pThis.SetLinkedValue(H_BalAcc, STR_ALLVALUE);
    end;
  elif(rscnt.value("cntx") > 1)
    pThis.SetLinkedValue(H_BalAcc, "Несколько");
  elif(rscnt.value("cntx") == 1)
    pThis.SetLinkedValue( H_BalAcc, rscnt.value("t_balacc"));
  elif(rscnt.value("cntx") == 0)
    pThis.SetLinkedValue( H_BalAcc, "Не выбран");
  end;        
end;

/*Выбор клиентов*/
macro SelectClient()
  /*Обработчик скроллинга*/
  macro Client_Scroll(rs, cmd, id, key)
    /*Обработчик*/
    if(cmd == DLG_KEY)
      /*Enter*/
      if(key == 13)
        return CM_IGNORE;
      /*Esc*/
      elif(key == 27)
        return CM_CANCEL;
      /*Space*/
      elif(key == 32)
        if(rs.RecCount > 0)
          rs.edit();
          if(rs.value("t_setflag") == "X")
            rs.value("t_setflag") = " ";
          else                                                                                         
            rs.value("t_setflag") = "X";
          end;
          rs.update();
          updatescroll(rs, 5);
          return CM_IGNORE;
        end;
      end;
    end;
  end;
  var rs, cmd;
  var que = "select t_setflag, t_clientid, t_clientname from dset_cln_U_TMP"+V_W522_CNUM+"  order by t_clientname";
  cmd = RsdCommand(que);
  rs = RSDRecordset(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);
  while(RunScroll(rs, 2, MakeArray("t_setflag", "В", 1, 2, -1, 0,  
                                   "t_clientname", "Наименование клиента", 100, 2, -1, 0), 
                  null, "Client_Scroll", "Выбор клиентов", "~Esc~ Выход ~Пробел~ Изменить", false))
    cmd = RsdCommand(que);
    rs = RSDRecordset(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);
  end;
end;

/*Обработчик поля клиент*/
macro Refresh_Clients(pDate)
  var rscmd, rscnt;
  SQL_Execute("delete from dset_cln_U_TMP"+V_W522_CNUM+" ");
  SQL_Execute("insert into dset_cln_U_TMP"+V_W522_CNUM+" (t_setflag, t_clientid, t_clientname) "+
              "select chr(88), party.t_partyid, party.t_name "+
              "  from dsfcontr_dbt sfcontr "+
              "  join dparty_dbt party "+
              "    on party.t_partyid = sfcontr.t_partyid "+
              " where sfcontr.t_datebegin <= " + GetSQLDate(pDate) + 
              "   and (sfcontr.t_dateclose = to_date('01.01.0001', 'dd.mm.yyyy') or "+
              "       sfcontr.t_dateclose >= " + GetSQLDate(pDate) + ") " +
              "   and sfcontr.t_partyid != 0 "+
              " group by party.t_partyid, party.t_name");
  rscmd = DL_RSDCommand("select count(1) cnt from dset_cln_U_TMP"+V_W522_CNUM+" ");
  rscnt = rscmd.Execute();
  rscnt.movenext();
  return rscnt.value("cnt");
end;

private MACRO DL_FldProc_Client( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if(Cmd == DLG_INIT)
    var rscmd, rscnt;
    rscmd = DL_RSDCommand("select count(1) cnt from dset_cln_U_TMP"+V_W522_CNUM+" ");
    rscnt = rscmd.Execute();
    rscnt.movenext();
    if(rscnt.value("cnt") == 0)
      if(Refresh_Clients(pThis.GetLinkedValue(DL_PNFLD_ENDDATE)) == 0)
        FldShowValue = "Не выбран";
      else
        FldShowValue = STR_ALLVALUE;
      end;
    else
      SetName(pThis);
      FldShowValue = pThis.GetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_CODE);
    end;
  elif((Cmd == DLG_KEY) AND (Key == KEY_SPACE))
    if(pThis.GetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_CODE) != STR_ALLVALUE)
      SQL_Execute("update dset_cln_U_TMP"+V_W522_CNUM+"  set t_setflag = chr(88)");
      pThis.SetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_CODE, STR_ALLVALUE);
      FldShowValue = STR_ALLVALUE;
    else
      SQL_Execute("update dset_cln_U_TMP"+V_W522_CNUM+"  set t_setflag = chr(0)");
      pThis.SetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_CODE, "Не выбран");
      FldShowValue = "Не выбран";
    end;
  elif((Cmd == DLG_KEY) AND (Key == KEY_F3))
    SelectClient();
    SetName(pThis);
    FldShowValue = pThis.GetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_CODE);
  end;
  FldRealValue = FldShowValue;

  return CM_DEFAULT;
END;

macro SelectCurrency()
  /*Обработчик скроллинга*/
  macro Currency_Scroll(rs, cmd, id, key)
    /*Обработчик*/
    if(cmd == DLG_KEY)
      /*Enter*/
      if(key == 13)
        return CM_IGNORE;
      /*Esc*/
      elif(key == 27)
        return CM_CANCEL;
      /*Space*/
      elif(key == 32)
        if(rs.RecCount > 0)
          rs.edit();
          if(rs.value("t_setflag") == "X")
            rs.value("t_setflag") = " ";
          else                                                                                         
            rs.value("t_setflag") = "X";
          end;
          rs.update();
          updatescroll(rs, 5);
          return CM_IGNORE;
        end;
      end;
    end;
  end;
  var rs, cmd;
  var que = "select t_setflag, t_fiid, t_finame, t_ccy from dset_fi_U_TMP"+V_W522_CNUM+"  order by t_fiid";
  cmd = RsdCommand(que);
  rs = RSDRecordset(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);
  while(RunScroll(rs, 3, MakeArray("t_setflag", "В", 1, 2, -1, 0,  
                                   "t_ccy",     "Код", 5, 2, -1, 0, 
                                   "t_finame",  "Наименование", 100, 2, -1, 0), 
                  null, "Currency_Scroll", "Выбор валюты", "~Esc~ Выход ~Пробел~ Изменить", false))
    cmd = RsdCommand(que);
    rs = RSDRecordset(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);
  end;
end;

/*Обработчик поля валюты*/
macro Refresh_Currency()
  var rscmd, rscnt;
    SQL_Execute("delete from dset_fi_U_TMP"+V_W522_CNUM+" ");
    SQL_Execute("insert into dset_fi_U_TMP"+V_W522_CNUM+" (t_setflag, t_fiid, t_finame, t_ccy)  "+
                "select chr(88), fi.t_fiid, fi.t_name, fi.t_ccy                 "+
                "  from (select t_fiid, t_name, t_ccy from dfininstr_dbt        "+
                " where t_ccy in ('RUB', 'USD', 'EUR') order by t_fiid) fi      ");
    rscmd = DL_RSDCommand("select count(1) cnt from dset_fi_U_TMP"+V_W522_CNUM+" ");
    rscnt = rscmd.Execute();
    rscnt.movenext();
    return rscnt.value("cnt");
end;

/*Обработчик поля валюты*/
private MACRO DL_FldProc_Currency( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if(Cmd == DLG_INIT)
    var rscmd, rscnt;
    rscmd = DL_RSDCommand("select count(1) cnt from dset_fi_U_TMP"+V_W522_CNUM+" ");
    rscnt = rscmd.Execute();
    rscnt.movenext();
    if(rscnt.value("cnt") == 0)
      if(Refresh_Currency() == 0)
        FldShowValue = "Не выбрана";
      else
        FldShowValue = STR_ALLVALUE;
      end;
    else
      SetName(pThis);
      FldShowValue = pThis.GetLinkedValue(DL_PNFLD_FI_NAME);     
    end;
  elif((Cmd == DLG_KEY) AND (Key == KEY_SPACE))
    if(pThis.GetLinkedValue(DL_PNFLD_FI_NAME) != STR_ALLVALUE)
      SQL_Execute("update dset_fi_U_TMP"+V_W522_CNUM+"  set t_setflag = chr(88)");      
      pThis.SetLinkedValue(DL_PNFLD_FI_NAME, STR_ALLVALUE);
      FldShowValue = STR_ALLVALUE;
    else
      SQL_Execute("update dset_fi_U_TMP"+V_W522_CNUM+"  set t_setflag = chr(0)");
      pThis.SetLinkedValue(DL_PNFLD_FI_NAME, "Не выбрана");
      FldShowValue = "Не выбрана";
    end;
  elif((Cmd == DLG_KEY) AND (Key == KEY_F3))
    SelectCurrency();
    SetName(pThis);
    FldShowValue = pThis.GetLinkedValue(DL_PNFLD_FI_NAME);
  end;
  FldRealValue = FldShowValue;
  return CM_DEFAULT;
end;

macro SelectBalAcc()
  /*Обработчик скроллинга*/
  macro BalAcc_Scroll(rs, cmd, id, key)
    /*Обработчик*/
    if(cmd == DLG_KEY)
      /*Enter*/
      if(key == 13)
        return CM_IGNORE;
      /*Esc*/
      elif(key == 27)
        return CM_CANCEL;
      /*Space*/
      elif(key == 32)
        if(rs.RecCount > 0)
          rs.edit();
          if(rs.value("t_setflag") == "X")
            rs.value("t_setflag") = " ";
          else                                                                                         
            rs.value("t_setflag") = "X";
          end;
          rs.update();
          updatescroll(rs, 5);
          return CM_IGNORE;
        end;
      end;
    end;
  end;
  var rs, cmd;
  var que = "select t_setflag, t_balacc from dset_bacc_U_TMP"+V_W522_CNUM+"  order by t_balacc";
  cmd = RsdCommand(que);
  rs = RSDRecordset(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);
  while(RunScroll(rs, 2, MakeArray("t_setflag", "В", 1, 2, -1, 0,  
                                   "t_balacc",  "Балансовый счёт", 25, 2, -1, 0),                                    
                  null, "BalAcc_Scroll", "Выбор балансового счета", "~Esc~ Выход ~Пробел~ Изменить", false))
    cmd = RsdCommand(que);
    rs = RSDRecordset(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);
  end;
end;

/*Обработчик поля валюты*/
macro Refresh_BalAcc()
  var rscmd, rscnt;
  SQL_Execute("delete from dset_bacc_U_TMP"+V_W522_CNUM+" ");
  SQL_Execute("insert into dset_bacc_U_TMP"+V_W522_CNUM+"  (t_setflag, t_balacc)  "+
              "  select chr(88), ba.t_acc                         "+
              "    from (select '30601' t_acc from dual           "+
              "           union                                   "+
              "          select '30606' t_acc from dual           "+
              "           union                                   "+
              "          select '47423' t_acc from dual) ba       ");
  rscmd = DL_RSDCommand("select count(1) cnt from dset_bacc_U_TMP"+V_W522_CNUM+" ");
  rscnt = rscmd.Execute();
  rscnt.movenext();    
  return rscnt.value("cnt");
end;

/*Обработчик поля балансового счета*/
private MACRO DL_FldProc_BalAcc( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if(Cmd == DLG_INIT)
    var rscmd, rscnt;
    rscmd = DL_RSDCommand("select count(1) cnt from dset_bacc_U_TMP"+V_W522_CNUM+" ");
    rscnt = rscmd.Execute();
    rscnt.movenext();
    if(rscnt.value("cnt") == 0)
      if(Refresh_BalAcc() == 0)
        FldShowValue = "Не выбран";
      else
        FldShowValue = STR_ALLVALUE;
      end;
    else
      SetName(pThis); 
      FldShowValue = pThis.GetLinkedValue(H_BalAcc);          
    end;
  elif((Cmd == DLG_KEY) AND (Key == KEY_SPACE))
    if(pThis.GetLinkedValue(H_BalAcc) != STR_ALLVALUE)
      SQL_Execute("update dset_bacc_U_TMP"+V_W522_CNUM+"  set t_setflag = chr(88)");      
      pThis.SetLinkedValue(H_BalAcc, STR_ALLVALUE);
      FldShowValue = STR_ALLVALUE;
    else
      SQL_Execute("update dset_bacc_U_TMP"+V_W522_CNUM+"  set t_setflag = chr(0)");
      pThis.SetLinkedValue(H_BalAcc, "Не выбран");
      FldShowValue = "Не выбран";
    end;
  elif((Cmd == DLG_KEY) AND (Key == KEY_F3))
    SelectBalAcc();
    SetName(pThis);
    FldShowValue = pThis.GetLinkedValue(H_BalAcc);
  end;
  FldRealValue = FldShowValue;
  return CM_DEFAULT;
end;

/*Дата выпуска отчета*/
private MACRO DL_FldProc_Date( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT ) /*Установка значения в поле*/
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = {curdate};
     end;
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE ) /*значение поля было изменено*/
     if (FldRealValue != FldShowValue)
       FldRealValue = FldShowValue;
       if(Refresh_Clients(FldRealValue) == 0)
         pThis.SetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_CODE, "Не выбран");
       else
         pThis.SetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_CODE, STR_ALLVALUE);
       end;
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) ) /*Вызов листалки и заполнение FldShowValue и FldRealValue*/
     FldRealValue = GetDateByCalendar( FldRealValue );
     FldShowValue = FldRealValue;
  end;
  return CM_DEFAULT;
END;

CLASS (DL_CPanel) W522_Panel()

  PRIVATE MACRO Init()

     /*>>bpv временные таблицу на севрере банка очень медленно работают, возможно из-за настроек оракла. */
     /*переделаем на обычные таблицы, но индивидуальные под каждый запуск отчета. */
     private macro TryDropTables()
        SQL_Execute("begin  execute immediate 'drop table DSET_FI_U_TMP"+V_W522_CNUM +"';exception when others then null;end;");
        SQL_Execute("begin  execute immediate 'drop table DSET_CLN_U_TMP"+V_W522_CNUM +"';exception when others then null;end;");
        SQL_Execute("begin  execute immediate 'drop table DSET_BACC_U_TMP"+V_W522_CNUM +"';exception when others then null;end;");     
     OnError(e)
     end;
     TryDropTables();
     SQL_Execute("CREATE TABLE DSET_CLN_U_TMP"+V_W522_CNUM+" (T_SETFLAG     CHAR(1 BYTE),T_CLIENTID    NUMBER(10),T_CLIENTNAME  VARCHAR2(320 BYTE))");
     SQL_Execute("CREATE TABLE DSET_FI_U_TMP" +V_W522_CNUM+" ( T_SETFLAG  CHAR(1 BYTE),T_FIID     NUMBER(10),T_FINAME   VARCHAR2(50 BYTE),T_CCY      VARCHAR2(3 BYTE));");
     SQL_Execute("CREATE TABLE DSET_BACC_U_TMP" +V_W522_CNUM+" (T_SETFLAG  CHAR(1 BYTE),T_BALACC   VARCHAR2(10 BYTE));");
     /*<<bpv*/

     AddFieldProc(0, P_W522_DATE,                 DL_PNFLD_ENDDATE,             @DL_FldProc_Date, {curdate});
     AddFieldProc(0, P_W522_CLIENT,               DL_PNFLD_CLIENT_STOCKDL_CODE, @DL_FldProc_Client);
     AddFieldProc(0, P_W522_CURRENCY,             DL_PNFLD_FI_NAME,             @DL_FldProc_Currency);
     AddFieldProc(0, P_W522_BALACC,               H_BalAcc,                     @DL_FldProc_BalAcc);
     AddFieldProc(0, P_W522_StockMarket,          H_StockMarket,                @DL_FldProc_CheckBox, "X" );
     AddFieldProc(0, P_W522_FuturesMarket,        H_FuturesMarket,              @DL_FldProc_CheckBox, "X" );
     AddFieldProc(0, P_W522_OverTheCounterMarket, H_OverTheCounterMarket,       @DL_FldProc_CheckBox, "X" );  
  END;
  
  PRIVATE MACRO Check():BOOL
    if (This.GetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_CODE) == "Не выбран")
      Msgbox("Необходимо выбрать хотя бы одного клиента.");
      return false;
    elif (This.GetLinkedValue(DL_PNFLD_FI_NAME) == "Не выбрана")
      Msgbox("Необходимо выбрать хотя бы одну валюту.");
      return false;
    elif (This.GetLinkedValue(H_BalAcc) == "Не выбран")
      Msgbox("Необходимо выбрать хотя бы один балансовый счет.");
      return false;
    elif ((This.GetLinkedValue(H_StockMarket) != "X") and
          (This.GetLinkedValue(H_FuturesMarket) != "X") and 
          (This.GetLinkedValue(H_OverTheCounterMarket) != "X"))
      Msgbox("Необходимо выбрать хотя бы один вариант рынка.");
      return false;
    else
      return true;
    end;
  END;

  initDL_CPanel("ReportUserPanels.lbr", "W522"); 

END;

 