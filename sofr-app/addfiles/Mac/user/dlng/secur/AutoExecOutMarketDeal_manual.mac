import spinter, "sp_class.mac", "spserv.mac";

      const TypeAction_DeferredPayment    = 12;
      const TypeAction_DeferredDelivery   = 13;
      const TypeAction_ExecDeferPayment   = 14;
      const TypeAction_ExecDeferDelivery  = 15;

const real_date = date;
const cur_date = {curdate};

macro dp_msgbox()
var str:string ="";
var i = 0, CellVal;
while( GetParm( i, CellVal) )
    if( str == "" )
      str = string(CellVal);
    else
      str = string(str) + string(CellVal);
    end;
    i = i + 1;
end;
if(str != "")
    println(str);
end

end;

macro insert_log(p1,p2,p3,p4)
 var sql = "insert into doutmarketexeclog_dbt values(sysdate,+"+p1+","+p2+","+p3+","+p4+")";
 var dl_cmd =RSDCommand(sql);
/* dl_cmd.AddParam("",rsdbp_in,p1);
 dl_cmd.AddParam("",rsdbp_in,p2);
 dl_cmd.AddParam("",rsdbp_in,p3);
 dl_cmd.AddParam("",rsdbp_in,p4);*/
 dl_cmd.execute();
 sql = null; dl_cmd = null;
end;

private macro GetTotalCost(AmountStr:String, CurCode:@string, Amount:@money)
   array ar;
   var str = substr(AmountStr,7);
   StrSplit ( str, ar,100 , 3 );
   CurCode = ar[0];
   Amount  = (ar[1]);
end;

private macro CheckConfirmStatus(DraftID, amount:@string) //DAN
  const DraftKind = 8;
  var query, Select, Transport, Stat;
  var ConfNumber;
  var FactValueDate;
  var InstrStatus;
  var msg_txt;
  var TypeIN;

  query = "begin\n ? := RSP_SECURITY.GetConfirmParams_ext(?,?,?,?,?,?,?,?,?);\n end; ";

  Select = RSDCommand( query );

  Select.AddParam("p_Stat", RSDBP_OUT, V_INTEGER );

  Select.AddParam("p_DraftKind", RSDBP_IN, DraftKind );
  Select.AddParam("p_DraftID", RSDBP_IN, DraftID );
  Select.AddParam("p_Number", RSDBP_OUT, V_STRING );
  Select.AddParam("p_Date", RSDBP_OUT, V_DATE );
  Select.AddParam("p_TypeIn", RSDBP_OUT, V_STRING );
  Select.AddParam("p_Status", RSDBP_OUT, V_STRING );
  Select.AddParam("p_Reason", RSDBP_OUT, V_STRING );
  Select.AddParam("p_Comment", RSDBP_OUT, V_STRING );
  Select.AddParam("p_Amount", RSDBP_OUT, V_STRING );
  Select.Execute();

  ConfNumber    = SQL_ConvTypeStr(Select.value("p_Number"));
  FactValueDate = SQL_ConvTypeDate(Select.value("p_Date"));
  InstrStatus   = SQL_ConvTypeInteger(Select.value("p_Status"));
  Amount        = SQL_ConvTypeStr(Select.value("p_Amount"));
  TypeIN        = SQL_ConvTypeStr(Select.value("p_TypeIN")); 
  if((SQL_ConvTypeInteger(Select.value("p_Stat")) == 0) and (TypeIN != "MT548") and (TypeIN != ""))
    return 1;
  end;
    return 0;
end;

private macro ПроверитьСделкуНаОтложенноеИсполнение(DealID)
  var cmd = DL_RSDCommand();
  var sql = " select 1 from ddl_tick_dbt tick, doproper_dbt oper  where tick.t_dealstatus != 0 and tick.t_bofficekind = 101 " +
"             AND oper.t_dockind = tick.t_bofficekind and oper.t_documentid = LPAD(tick.t_dealid, 34, '0' )  " +
"             and exists(select 1 from doprstep_dbt step where step.t_id_operation = oper.t_id_operation and step.t_plan_date = to_date('31.12.9999','dd.mm.yyyy') and step.t_isexecute = 'R' AND step.t_symbol in ('Т', 'О')) " +
"             and tick.t_dealid = ? " ;
  cmd.AddParam(DealID);
  var ds = cmd.Execute(sql);
  if(ds.MoveNext())
    return 1;
  end;
  return 0;
end;

private macro ПроверитьСделкуНаПросрочку(DealID)
  
  var cmd = DL_RSDCommand();
  var   q = " select 1 from ddl_tick_dbt tick, doproper_dbt oper  where tick.t_dealstatus != 0 and tick.t_bofficekind = 101 "+
            " AND oper.t_dockind = tick.t_bofficekind and oper.t_documentid = LPAD(tick.t_dealid, 34, '0' ) and tick.t_dealid = ?"+
            " and exists(select 1 from doprstep_dbt step where step.t_id_operation = oper.t_id_operation and step.t_plan_date < ? and step.t_isexecute = 'R' AND step.t_symbol in ('Т', 'О'))";

  cmd.AddParam(DealID);
  cmd.AddParam(real_date);
  var ds = cmd.Execute(q);
  if(ds.MoveNext())
    return 1;
  end;
  return 0;
end;


macro ExecAutoStart (dealid)
   //Comment macro
   var ConfirmStatus, err;
   var Deal_Cost, Deal_NKD;
   var TotalCostSTR, CurCode;
   var cmd = DL_RSDCommand();
   var FD;
   var sql = "SELECT tick.\*, " +
      "       leg.T_MATURITY, " +
      "       leg.T_EXPIRY, " +
      "       leg.T_PRINCIPAL, " +
      "       leg.T_TOTALCOST, " +
      "       leg.T_NKD " +
      "  FROM ddl_tick_dbt tick, doproper_dbt oper, ddl_leg_dbt leg " +
      " WHERE     tick.t_dealstatus != 0 " +
      "       AND tick.t_bofficekind = 101 " +
      "       AND tick.t_marketid = -1 and tick.t_clientid = -1 " +
      "       AND RSB_SECUR. " +
      "            ISREPO ( " +
      "              rsb_secur. " +
      "               get_OperationGroup ( " +
      "                 rsb_secur. " +
      "                  get_OperSysTypes (tick.t_DealType, tick.t_BofficeKind))) =  0 " +
      "       AND leg.t_dealid = tick.t_dealid " +
      "       AND oper.t_dockind = tick.t_bofficekind " +
      "       AND oper.t_documentid = LPAD (tick.t_dealid, 34, '0') " +
     "       AND tick.t_dealid = :did " +
      "       AND EXISTS " +
      "              (SELECT 1 " +
      "                 FROM doprstep_dbt step " +
      "                WHERE step.t_id_operation = oper.t_id_operation " +
      "                      AND (step.t_plan_date <= :d1 " +
      "                           OR step.t_plan_date = " +
      "                                 TO_DATE ('31.12.9999', 'dd.mm.yyyy')) " +
      "                      AND step.t_isexecute = 'R' " +
      "                      AND step.t_symbol IN ('Т', 'О')) " ;

    cmd.AddParam(dealid);
    cmd.AddParam(real_date); 
    var ds = cmd.Execute(sql);
//setrstrace(true);
    while (ds.MoveNext())
       ConfirmStatus = 0;
      //FD = SPFirstDoc(LEG_KIND_DL_TICK, ds.DealID ); //LEG_KIND_DL_TICK
      //1. Проверяем наличие для сделки подтверждения. 
       ConfirmStatus = CheckConfirmStatus(ds.DealID, @TotalCostSTR);
       if (ConfirmStatus)
          if ((ПроверитьСделкуНаПросрочку(ds.DealID)) and (not ПроверитьСделкуНаОтложенноеИсполнение(ds.DealID)))
          //если плановые даты исполнения меньше текущей даты исполняем перенос по срокам 
             Deal_Cost = ds.TotalCost;
             Deal_NKD  = ds.nkd;
             err = SC_CalcExecute (ds.DealID, TypeAction_DeferredDelivery, date(ds.maturity), money(Deal_Cost), money(Deal_NKD)); 
             if (not err)
                   insert_log(ds.DealID,TypeAction_DeferredDelivery,Deal_Cost,Deal_NKD); 
                   SC_CalcExecute (ds.DealID, TypeAction_DeferredPayment , date(ds.expiry)  , money(Deal_Cost), money(Deal_NKD));
                   insert_log(ds.DealID,TypeAction_DeferredPayment,Deal_Cost,Deal_NKD);  
             end;
          end;
          if(ПроверитьСделкуНаОтложенноеИсполнение((ds.DealID)))
            // исполняем отложенную поставку и оплату
             if(real_date <= cur_date)
               GetTotalCost(TotalCostSTR, @CurCode, @Deal_Cost);
               Deal_NKD  = (НКД(ds.pfi,ds.principal,cur_date));   
               err = SC_CalcExecute (ds.DealID, TypeAction_ExecDeferDelivery, cur_date, money(Deal_Cost), money(Deal_NKD)); 
               if (not err)
                    insert_log(ds.DealID,TypeAction_ExecDeferDelivery,Deal_Cost,Deal_NKD);
                     SC_CalcExecute (ds.DealID, TypeAction_ExecDeferPayment ,cur_date, money(Deal_Cost), money(Deal_NKD)); 
                    insert_log(ds.DealID,TypeAction_ExecDeferPayment,Deal_Cost,Deal_NKD); 
               end;
             end;
          end; 
          //исполняем сделку
            SP_ExecDeal(ds.DealID, false );
            insert_log(ds.DealID,0,0,0)  
       else
          if (ПроверитьСделкуНаПросрочку(ds.DealID))
          //если плановые даты исполнения меньше текущей даты исполняем перенос по срокам 
             Deal_Cost = ds.TotalCost;
             Deal_NKD  = ds.nkd;
             err = SC_CalcExecute (ds.DealID, TypeAction_DeferredDelivery, date(ds.maturity), money(Deal_Cost), money(Deal_NKD)); 
             if (not err)
                   insert_log(ds.DealID,TypeAction_DeferredDelivery,Deal_Cost,Deal_NKD); 
                   SC_CalcExecute (ds.DealID, TypeAction_DeferredPayment , date(ds.expiry)  , money(Deal_Cost), money(Deal_NKD));
                   insert_log(ds.DealID,TypeAction_DeferredPayment,Deal_Cost,Deal_NKD);  
             end;
          end;
       end; 
    end;
 
//setrstrace(false); 
End;
//setdialogflag(0); 
ReplaceMacro("MsgBox", "DP_MsgBox");
var dealid = 256434;
//261392
ExecAutoStart(dealid);
//setdialogflag(1); 
exit(1);

OnError
exit(1);
