import RSD, RsbDataSet, BankInter, globals, Календарь; 
import dlcontrfunc;

CONST DO_SERVKIND_FORTS       = 15,
      DO_SERVKIND_CURRDL      = 21,
      DO_SERVKIND_STOCKDL     = 1,
      DO_SERVKINDSUB_EXCH     = 8,
      DO_SERVKINDSUB_OUTEXCH  = 9;
CONST DO_CODEKIND_EKK         = 1,
      DO_CODEKIND_KUT         = 2;

PRIVATE CONST C_FORBIDDEN_CODES = 5055;
PRIVATE CONST C_NUMBER_LLVALUE_FIRMID = 5053;
PRIVATE CONST C_MAX_COUNT = 46656; // максимальное значение счетчика

//gtv: служебная метка в трассу
private macro ServPutIntoTrace(_text)
   var sql_str, rs;
   sql_str = "select 'serv_message', '"+_text+"', sysdate from dual";
   rs = RSDRecordSet(sql_str);
   rs.movenext;
   rs.close; rs = null;
end;

//Процедура генерации уникального кода клиента
//Для работы процедуры требуется создание референсов №1000002, который будет присваивать порядковые номера
//по всем сделкам кроме срочного рынка, а также №1000003 для срочного рынка
//GeneratePersonalCode(personid : INTEGER, IIS : BOOL, IsIP : BOOL, futures : BOOL): STRING
//Входящие параметры:
//personid: INTEGER
//обязательный, ИД пользователя в базе
//IIS: BOOL
//необязательный, признак БО с использованием ИИС 
//IsIP: BOOL
//необязательный, признак индивидуального предпренимателя
//servkind: int
//вид обслуживания

Private macro IIF(condition, value_true, value_false)
    If(condition)
       return value_true;
    else
       return value_false;
    end;
end;


private macro rlCheckSeqNotEnded(FirmID)
  var max_count = C_MAX_COUNT-1; // максимальное значение счетчика
  var sql = "SELECT last_number   \n"
            "  FROM all_sequences \n"
            "  WHERE sequence_name = 'U_' || UPPER (:FirmID) || '_SEQ'; " ;
  var cmd = RSDCommand(sql);
      cmd.AddParam("FirmID", rsdbp_in, FirmID);
  var rs = RSDRecordset(cmd, rsdval_client, rsdval_static);
  if ((rs.MoveNext()) and (rs.value("last_number") >= max_count))
    return 0;
  end;
    return 1;
end;


/*PNV 504903*/
PRIVATE MACRO GeneratePersonalCode_FX()
   var alpha : string = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
   var nextval = 0;
   var ind = 0;
   var val = "", code = "", PersonalCode = "";

   GenerateReference(1000003, nextval);
   if (nextval == 1016) /*чтобы пропустить уже сформированные значения F502K16, F502K17, F502K18, F502K19*/
        GenerateReference(1000003, nextval);
        GenerateReference(1000003, nextval);
        GenerateReference(1000003, nextval);
        GenerateReference(1000003, nextval);
   end;
   nextval = Double(nextval) - 3574;
   nextval = string(Double(nextval)/100);

   ind = substr(nextval, Index(nextval, ".") + 1);
   val = Int(substr(nextval, 1, Index(nextval, ".") - 1));

   code =  Substr(ind, 1, 1) + Substr(alpha, val+1, 1 ) + Substr(ind, 2, 1);
   PersonalCode = string("F502", code);
   return PersonalCode; 
END;
/*PNV 504903*/


//dan>
//BIQ-7571 Генерация кода клиента. Учитывается код фирмы в панели обслуживания. Алгоритм основан на использовании сиквенсов БД

macro uGenerateUnicClientCode_FX_FirmID(FirmID)

   private macro uGenerateReference(pFirmID:String)

     var sql, exec, startseqval = 1;
     var seqnextval = 0;
     
     if(pFirmID == "F502")
        GenerateReference(1000003, startseqval);
     end; 


     sql = "declare                                                                                                           \n "+
           "                                                                                                                   \n "+
           " seq_nextval number;                                                                                               \n "+
           " seq_startval number   := :p_seq_startval;                                                                         \n "+
           " p_FirmID varchar2(10) := :pFirmID;                                                                                \n "+
           "                                                                                                                   \n "+
           " function CreateFirmSEQ(vFirmID in varchar2, pseq_startval in number) return number                                \n "+
           " is                                                                                                                \n "+
           " createseq_sql varchar2(500);                                                                                      \n "+
           " begin                                                                                                             \n "+
           " createseq_sql := 'CREATE SEQUENCE u_'||vFirmID||'_SEQ START WITH '||seq_startval||' MAXVALUE "+C_MAX_COUNT+"'||   \n "+
           "                   ' MINVALUE 1 NOCYCLE NOCACHE NOORDER';                                                          \n "+
           " execute immediate createseq_sql;                                                                                  \n "+
           " return 0;                                                                                                         \n "+
           " exception when others then                                                                                        \n "+
           "   return 1;                                                                                                       \n "+
           " end;                                                                                                              \n "+
           "                                                                                                                   \n "+
           " function GetNextVal(FirmID in varchar2) return number                                                             \n "+
           " is                                                                                                                \n "+
           " getnextval_sql varchar2(500);                                                                                     \n "+
           " seqnextval number;                                                                                                \n "+
           " err number;                                                                                                       \n "+
           " sequence_is_missing EXCEPTION;                                                                                    \n "+
           " PRAGMA EXCEPTION_INIT (sequence_is_missing, -2289);                                                               \n "+
           "                                                                                                                   \n "+
           " begin                                                                                                             \n "+
           "    getnextval_sql := 'select u_'||FirmID||'_SEQ.NEXTVAL from DUAL';                                               \n "+
           "    execute immediate getnextval_sql into seqnextval;                                                              \n "+
           "    return seqnextval;                                                                                             \n "+
           "                                                                                                                   \n "+
           "    exception when sequence_is_missing then                                                                        \n "+
           "      err := CreateFirmSEQ(FirmID,seq_startval);                                                                   \n "+
           "      if err = 0 then                                                                                              \n "+
           "        seqnextval := GetNextVal(FirmID);                                                                          \n "+
           "        return seqnextval;                                                                                         \n "+
           "      end if;                                                                                                      \n "+
           "      return 0;                                                                                                    \n "+
           " end;                                                                                                              \n "+
           "                                                                                                                   \n "+
           " begin                                                                                                             \n "+
           " :seq_nextval := GetNextVal(p_FirmID);                                                                             \n "+
           " end;                                                                                                                 ";
  
       exec = RsdCommand(sql);
       exec.AddParam("p_seq_startval", RSDBP_IN, startseqval);
       exec.AddParam("p_FirmID",       RSDBP_IN, pFirmID);
       exec.AddParam("seq_nextval",    RSDBP_OUT, V_INTEGER);
       exec.Execute();
       seqnextval = exec.value("seq_nextval");


     return seqnextval;

  end;

  private macro lpad( str, len )
    var chr;
    if ( not GetParm(2, chr))
       chr = " ";
    end;
    str = Trim( str );
    return MkStr(chr, len - StrLen(str)) + str;
  end;

  private macro   uGenerateClientCode_FX(pFirmID,n)
    var betta =  "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    var x,y; 
    y = n;
    var retval, tmpstr="";
      for 
        x   = mod(y, strLen(betta));
        y   = int(y / strlen(betta));
        retval = substr(betta, x+1 , 1);
        if(valtype(retval)!= v_undef)
          tmpstr = string(tmpstr, retval);
        end;
        if(y == 0)
          break;
        end;
      end ; 
     return string(pFirmID,lpad(tmpstr,3,"0")); 
  end;

  private macro GetCurFirmID()
     var CurFirmID;
     var item_FirmID;
     var sql_str, rs, cmd;

     sql_str = "select t_code from dllvalues_dbt where t_list = "+C_NUMBER_LLVALUE_FIRMID+" order by t_element";
     rs = RSDRecordSet(sql_str);
     while (rs.movenext)
        CurFirmID = rs.value("t_code");
        if(rlCheckSeqNotEnded(CurFirmID))
          break;
        end;
     end;
     return CurFirmID;
  end;
 
  var sql, cmd, rs, tmpCode = "", pFirmID ;
  var nextval, count;

  if((valType(FirmID) == v_Undef) or (FirmID == ""))
    //pFirmID = "F502";
    pFirmID = GetCurFirmID();  // def-44155 если прямо не указали, значит, будем перебирать
  else
    pFirmID = FirmID;
  end;


  sql = "select count(1) countrec from ddlcontrmp_dbt where t_mpcode = ?"; 
  cmd = RSDCommand(sql);
  cmd.addParam( "mpcode" );

  //def-44155 проверка запрещенных кодов
  var sql2 = "select count(1) countrec from dllvalues_dbt  where t_list = ? and t_code = ? ";
  var cmd2 = RSDCommand(sql2);
  cmd2.addparam( "list", RSDBP_IN, 5055);
  cmd2.addParam( "mpcode" );
  var rs2;
  for 
     nextval = uGenerateReference(pFirmID);
     if (nextval >= C_MAX_COUNT) // def-44155 последнее допустимое значение 46555 = ZZZ (36*36*36-1) 
       return "-F";
     end;
     tmpCode =  uGenerateClientCode_FX( pFirmID, int(nextval));
     cmd.value("mpcode") = tmpCode;      
     cmd.execute;
     rs = TRsbDataSet(cmd);
     if (rs.movenext)
       count = rs.value("countrec");
     end;
     rs = null;      
     if (tmpcode == String(pFirmID, "000")) 
       continue;
     end;
     if(count == 0) //def-44155 проверка запрещенных кодов
       cmd2.value("mpcode") = tmpCode;
       cmd2.execute;
       rs2 = TRsbDataSet(cmd2);
       if (rs2.movenext)
          count = rs2.value("countrec");
       end;
       rs2 = null;
     end;

     if(count == 0)
       break;
     end;
  end; 
  return tmpCode;
end;
// <dan


/*NEW F502xxx*/
macro uGenerateUnicClientCode_FX()
  private macro lpad( str, len )
    var chr;
    if ( not GetParm(2, chr))
       chr = " ";
    end;
    str = Trim( str );
    return MkStr(chr, len - StrLen(str)) + str;
  end;

  private macro   uGenerateClientCode_FX(n)
    var betta =  "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    var x,y; 
    y = n;
    var retval, tmpstr="";
      for 
        x   = mod(y, strLen(betta));
        y   = int(y / strlen(betta));
        retval = substr(betta, x+1 , 1);
        if(valtype(retval)!= v_undef)
          tmpstr = string(tmpstr, retval);
        end;
        if(y == 0)
          break;
        end;
      end ; 
     return string("F502",lpad(tmpstr,3,"0")); 
  end;
  var sql, cmd, rs, tmpCode = "";
  var nextval, count;
  sql = "select count(1) countrec from ddlcontrmp_dbt where t_mpcode = ?"; 
  cmd = RSDCommand(sql);
  cmd.addParam( "mpcode" );
  for 
     GenerateReference(1000003, nextval);
     tmpCode =  uGenerateClientCode_FX(int(nextval));
     cmd.value("mpcode") = tmpCode;      
     cmd.execute;
     rs = TRsbDataSet(cmd);
     if (rs.movenext)
       count = rs.value("countrec");
     end;
     rs = null;      
     if(count == 0)
       break;
     end;
  end; 
  return tmpCode;
end;
/*NEW F502xxx*/

macro GeneratePersonalCode(personid, IIS, IsIP, servkind, UndrWr, FirmID, codekind /*1 - EKK, 2 - КУТ*/)
   var nextval, PersonalCode;
   var curval, Query, rs, legalform = -1;



   if (servkind == DO_SERVKIND_FORTS)
//dan> BIQ-7571
    /* PersonalCode =uGenerateUnicClientCode_FX();*///CHVA  GeneratePersonalCode_FX()/*PNV 504903*/
       PersonalCode =uGenerateUnicClientCode_FX_FirmID(FirmID);
       if (PersonalCode == "-F")
          msgbox("Для торговой фирмы "+FirmID+" генерация кодов невозможна\n(достигнут предел последовательности кодов).\n Укажите другую фирму.");
          return null;
       end;
//<dan
   else
      //gtv: проверка использования последнего значения
//gtv: 06042022 морально устарело и мешает параллельной работе
/*      Query = "select t_lastvalue from dmeter_dbt where t_seqid = 1000002 and t_closedate = to_date('01.01.0001','dd.mm.yyyy')";
      rs = RSDRecordSet(Query);
      if (rs.movenext)
         curval = rs.value(0);
      end;
      if (curval)
         Query = "select cod.t_code from ddlobjcode_dbt cod "+
                 " where cod.t_objecttype = 207           "+
                 "   and cod.t_codekind = 1               "+
                 "   and ( cod.t_bankclosedate = to_date('01.01.0001','dd.mm.yyyy') or (cod.t_bankclosedate > :dat) ) "+
                 "   and substr(t_code,2) like '%"+curval+"'"; /*517780 Добавлен substr*/
         Query = RSDCommand(Query);
         Query.AddParam("dat", RSDBP_IN, {curdate});
         rs = RsdRecordset(Query);
         if (rs.movenext) // существует ЕКК из последовательности, генерируем новый       
            GenerateReference(1000002, nextval);
         else // последовательность есть, а кода нет
            nextval = curval;
         end;
      else // нет последовательности? 
         GenerateReference(1000002, nextval);
      end;*/

      GenerateReference(1000002, nextval);
      ServPutIntoTrace("Получили значение последовательности: " + nextval);

      if (IsIP)
         PersonalCode = IIF(servkind == DO_SERVKIND_CURRDL, "CU", "") + string("5", nextval);
      elif (IIS)
         PersonalCode = string("6", nextval);
      elif (UndrWr) //BIQ-5485 
         PersonalCode = IIF(servkind == DO_SERVKIND_CURRDL, "CU", "") + string("7", nextval);   
      else
         Query = "select party.t_legalform, "+
                  "case when isb.num = 1 then 'X' end as isbank, "+
                  "case when isdu.num = 1 then 'X' end as istrust "+
                  "from dparty_dbt party "+
                  "left join(select PTOWN.T_PARTYID, count(*) as num from dpartyown_dbt ptown where PTOWN.T_PARTYKIND = 2 group by PTOWN.T_PARTYID) isb on  isb.T_PARTYID = party.t_partyid "+
                  "left join(select PTOWN.T_PARTYID, count(*) as num from dpartyown_dbt ptown where PTOWN.T_PARTYKIND = 65 group by PTOWN.T_PARTYID) isdu on  isdu.T_PARTYID = party.t_partyid "+
                  "where party.t_partyid = :patyid ";
         Query = RSDCommand(Query);
         Query.AddParam("patyid", RSDBP_IN, personid);
         rs = RsdRecordset(Query);
         while (rs.MoveNext)
            legalform = rs.value(0);
            if (legalform==2)
               PersonalCode = string("4", nextval);
            else
               if (rs.value(1)=="X")
                  PersonalCode = IIF(servkind == DO_SERVKIND_CURRDL, "CU", "") + string("1", nextval);
               elif(rs.value(2)=="X")
                  PersonalCode = IIF(servkind == DO_SERVKIND_CURRDL, "CU", "") + string("3", nextval);
               else
                  PersonalCode = IIF(servkind == DO_SERVKIND_CURRDL, "CU", "") + string("2", nextval);
               end;
            end;
         end;
      end;
      /* 25/11/2021 Отключение префиксов для новых клиентов ФЛ
      if (codekind == DO_CODEKIND_KUT /*2*/)
         PersonalCode = "S"+PersonalCode;
      end;
      
      if (servkind == DO_SERVKIND_CURRDL)
         if ( IIS )  
         PersonalCode = "CU"+PersonalCode;
      end;
      */
   end;

   return PersonalCode;
end;

//Функция генерации единого кода на бирже в договоре брокерского обслуживания
macro GetPersonalCode( SeqValue, ObjKind, ObjAddr )

   var IsIp = false;
   record dlcontrprm("dlcontrprm.rec");
   setBuff(dlcontrprm, ObjAddr);

   if(dlcontrprm.IsGenBookingCode == 1) // вызов генерации кодов для предварительного бронирования
     var nextval:string, MarketCode:string = "";
     GenerateReference(1000002, nextval);

     if(nextval != "")
       MarketCode = string(dlcontrprm.ClientType, nextval);
     end;
     
     return MarketCode;
   end;

   var Query = "select t_isemployer from dpersn_dbt where t_personid = :1 and t_isemployer = chr(88)";
   Query = RSDCommand(Query);
   Query.AddParam("1", RSDBP_IN, dlcontrprm.partyid);
   var rs = RsdRecordset(Query);

   if (rs.MoveNext)
      IsIp = true;
   end;
   if (dlcontrprm.partyid == -1)
      MSgBox("Необходимо задать клиента по договору");
      return null; //раньшье при отсутствии клиента возвращался нулл, традиции не меняем, чтобы не поймать ничего нового
   end;

   var mpcode = GetGlobalParameter ("CodeContractEKK");
   if (mpcode)
      return mpcode;
   end;

   return GeneratePersonalCode(dlcontrprm.partyid, (dlcontrprm.iis == "X" ), isip, DO_SERVKIND_STOCKDL, (dlcontrprm.isunderwriting == "X" ), null, dlcontrprm.gencodekind); //BIQ-5485 добавлен признак андеррайтинга
end;

//Функция генерации единого кода на бирже в субдоговорах
macro GetPersonalCodeSub( SeqValue, ObjKind, ObjAddr )
   var PersonalCode;
   record sfcontr(sfcontr);
   setBuff(sfcontr, ObjAddr);

   record mptmp("dlcontrmp.tmp");
   var sizer = GetRecordSize (sfcontr);

   var BlobObjAddr = 0;
   if(ObjAddr != null)
    BlobObjAddr = OffsetMemAddr(ObjAddr, sizer);
    SetBuff( mptmp,  BlobObjAddr );
   end;

   var codekind = IIF(mptmp.marketid == SPB_ID() , DO_CODEKIND_KUT, IIF(mptmp.marketid == MMVB_ID(), DO_CODEKIND_EKK, -1 ) );
   if (codekind == -1)
      msgbox("Неободимо задать биржу: \"ММВБ\" или \"ПАО СПБ\"");
      return null;
   end;

   if ((sfcontr.servkind == DO_SERVKIND_FORTS) and (sfcontr.servkindsub == DO_SERVKINDSUB_EXCH))
      if (sfcontr.id == 0)/*вызов по Ctrl+G*/
         if(not rlCheckSeqNotEnded(mptmp.FirmID))
            msgbox("Для торговой фирмы "+mptmp.FirmID+" генерация кодов невозможна\n(достигнут предел последовательности кодов).\n Укажите другую фирму.");
            return null;
         end;
      end;

      PersonalCode = GeneratePersonalCode(sfcontr.partyid, false, false, true, null, mptmp.FirmID, null, codekind);
   else 
      //Берем краткий код клиента на ммвб
      //var Query = "select t_code from dobjcode_dbt where t_objectid = :id and t_codekind = 8 and T_BANKCLOSEDATE > :dat";
      // gtv: ЕКК хранится в виде кода 1 к договору
      var Query = "select distinct cod.t_code "+
      "  from            "+       
      "        DDLCONTRMP_dbt  mp, "+                    
      "        ddlcontr_dbt dl,    "+
      "        ddlobjcode_dbt cod    "+
      " where mp.t_dlcontrid = DL.T_DLCONTRID ";
      if (sfcontr.id == 0)/*вызов по Ctrl+G*/
         Query = Query + "   and dl.t_sfcontrid = (select t_id from dsfcontr_dbt where t_servkind = 0 and t_number = :numb ) ";
      else 
         Query = Query + "   and mp.t_sfcontrid = :id            ";
      end;
      Query = Query + 
      "   and cod.t_objecttype = 207          "+
      "   and cod.t_objectid = dl.t_dlcontrid "+
      "   and cod.t_codekind = 1              "+
      "   and ( cod.t_bankclosedate = to_date('01.01.0001','dd.mm.yyyy') or (cod.t_bankclosedate > :dat) )";
      Query = RSDCommand(Query);
      if (sfcontr.id == 0)/*вызов по Ctrl+G*/
         Query.AddParam("numb", RSDBP_IN, StrSubst(StrSubst(StrSubst(StrSubst(StrSubst(sfcontr.number,"_ю",""),"_с",""),"_ф",""),"_в",""),"_s","")  );
      else
         Query.AddParam("id", RSDBP_IN, sfcontr.id);
      end;
      Query.AddParam("dat", RSDBP_IN, {curdate});
      var rs = RsdRecordset(Query);
      rs.Movenext();

      if (valtype(rs.value(0))== 26)

         //если краткий код клиента на ммвб не задан, берется последнее значение референса и по принципу вышестоящей функции генерится единый код клиента
         var CMD = "select t_lastvalue from dmeter_dbt where t_seqid = 1000002";
         cmd = RSDCommand(cmd);
         var rs1 = RsdRecordset(cmd);
         rs1.movenext;

         var val = rs1.value(0);
         var Query1 = "select t_isemployer from dpersn_dbt where t_personid = :1 and t_isemployer = chr(88)";
         Query1 = RSDCommand(Query1);
         Query1.AddParam("1", RSDBP_IN, sfcontr.partyid);
         var rs2 = RsdRecordset(Query1);
         ServPutIntoTrace("Последовательность для субдоговора: "+val);

         if (rs2.MoveNext)
               PersonalCode = IIF(sfcontr.servkind == DO_SERVKIND_CURRDL, "CU", "") + string("5", val);
         elif (index(StrUpr(sfcontr.number),"ИИС" ) > 0)
            PersonalCode = string("6", val);
         else
            var  Query2 = "select party.t_legalform, "+
                          "case when isb.num = 1 then 'X' end as isbank, "+
                          "case when isdu.num = 1 then 'X' end as istrust "+
                          "from dparty_dbt party "+
                          "left join(select PTOWN.T_PARTYID, count(*) as num from dpartyown_dbt ptown where PTOWN.T_PARTYKIND = 2 group by PTOWN.T_PARTYID) isb on  isb.T_PARTYID = party.t_partyid "+
                          "left join(select PTOWN.T_PARTYID, count(*) as num from dpartyown_dbt ptown where PTOWN.T_PARTYKIND = 65 group by PTOWN.T_PARTYID) isdu on  isdu.T_PARTYID = party.t_partyid "+
                          "where party.t_partyid = :patyid ";
            Query2= RSDCommand(Query2);
            Query2.AddParam("patyid", RSDBP_IN, sfcontr.partyid);
            var rs3 = RsdRecordset(Query2);

            while (rs3.MoveNext)
               if (rs3.value(0)==2)
                  PersonalCode = string("4", val);
               else
                  if (rs3.value(1)=="X")
                     PersonalCode = IIF(sfcontr.servkind == DO_SERVKIND_CURRDL, "CU", "") + string("1", val);
                  elif(rs3.value(2)=="X")
                     PersonalCode = IIF(sfcontr.servkind == DO_SERVKIND_CURRDL, "CU", "") + string("3", val);
                  else
                     PersonalCode = IIF(sfcontr.servkind == DO_SERVKIND_CURRDL, "CU", "") + string("2", val);
                  end;
               end;
            end;
         end;
      else
         ServPutIntoTrace("Поиск ЕКК: "+rs.value(0));
         PersonalCode = rs.value(0);
      end;
      /* 25/11/2021 Отключение префиксов для новых клиентов ФЛ
      if (codekind == DO_CODEKIND_KUT /*2*/)
         PersonalCode = "S"+PersonalCode;
      end;

      if (sfcontr.servkind == DO_SERVKIND_CURRDL)
         PersonalCode = "CU"+PersonalCode;
      end;
      */
   end;

   return PersonalCode;
end;


