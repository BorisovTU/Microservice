import globals, Global, or_rep_h, oralib, likepy, RSD, Календарь, or_tpl_h;
import  RsbFormsInter, SPInter, PTInter;

const K_F2 = 316;
const K_F3 = 317;


var repDate, p1Date, p2Date;
var pPortfolioID, pPortfolioName;

var repSource;
//получение портфеля
//select cls.t_name, VAL.T_NAME, val.t_element from dllclsval_dbt clv, dllclass_dbt cls, dllvalues_dbt val where CLV.T_CLASSIFICATOR = CLS.T_CLASSIFICATOR and clv.t_element = VAL.T_ELEMENT and val.t_list = clv.t_list  and clv.t_classificator = 1649;

CLASS clF657_2 ()
var rn = 1;
var rn_a = 1;
// var EXCEL_MONEY = "\"# ##0,00\"";
var sheet = 1;
var nsheet = 2;
var count = 0;

var Rep, sql, cmd, rs;
var n_dl_sql, n_dl_cmd, n_dl_rs;
var csvFile, fName, csvTable, printEngine;
const TEMPL_NAME = "report_906.xlsx";
var SHEET_NAME;
var header;

macro initRep(templateName)
    printEngine=CTemplateXLS(NULL, NULL, NULL, NULL, NULL, NULL, true, false);

    if(printEngine.UsePoi())
      printEngine.SetXLSXFormat();
    end;
    printEngine.CreateTotalBook();
    printEngine.OpenTemplate(templateName, true);
end;

macro showRep(FileName)
    printEngine.Close();
    printEngine.SaveTotalBook(FileName);
end;

private macro ПечатьШапки ()
  printEngine.SetValue_NameCell("repDate", "Остатки на " +  repDate);
  printEngine.SetValue_NameCell("pDate", "будущие погашения купонов за период с  " + p1Date + "  по   " + p2Date);
  printEngine.CopyAllSheetInTotalBook (SHEET_NAME, false, "templateHeader", 0, SHEET_NAME + header);
end;

private macro ПечатьЗакладкиАмортизаций(rs)
  var chrOne = StrFor(1);
  printEngine.SetValue_NameCell("pdlDate", "Планируемые частичные погашения за период с  " + p1Date + "  по   " + p2Date);
  printEngine.CopyAllSheetInTotalBook (SHEET_NAME, false, "amortHeader", 0, SHEET_NAME + header);
  while(n_dl_rs.movenext())
    csvFile.AddCell( n_dl_rs.value("t_isin")); // 01.
    csvFile.AddCell( n_dl_rs.value("t_definition")); // 02.  
    csvFile.AddCell(""); //
    csvFile.AddCell( n_dl_rs.value("t_shortname")); // 03. 
    csvFile.AddCell( date(n_dl_rs.value("t_amortdate"))); // 04. 
    csvFile.AddCell( date(n_dl_rs.value("t_drawingdate"))); // 05.  
    if (n_dl_rs.value("MTY_TYPE") == chrOne)
      csvFile.AddCell(" ");
    else
      csvFile.AddCell( n_dl_rs.value("MTY_TYPE")); // 06.
    end;
    csvFile.AddCell( n_dl_rs.value("T_INCOMERATE")); // 07. 
    csvFile.AddCell( n_dl_rs.value("t_incomevolume")); // 08.
    csvFile.AddRow();  
  end;
end;


private macro ПечатьБлокаДанных(_rs);
    ПечатьШапки();
    if(ValType(_rs) != v_undef)
      while(_rs.MoveNext())
        csvFile.AddCell( (_rs.value("t_isin"))); // 01.
        csvFile.AddCell( (_rs.value("T_DEFINITION"))); // 02. 
        csvFile.AddCell(""); //  
        csvFile.AddCell( (_rs.value("T_SHORTNAME"))); // 03. 
        csvFile.AddCell( (date(_rs.value("T_DRAWINGDATE")))); // 04. 
        csvFile.AddCell( (_rs.value("T_FI_DRAWINGDATE"))); // 05.  
        csvFile.AddCell( (_rs.value("T_NUMBER"))); // 06.  
        csvFile.AddCell( (_rs.value("T_INCOMERATE"))); // 07. 
        // csvFile.AddCell( (_rs.value("t_INCOMEVOLUME"))); // 08.
        csvFile.AddCell( (СуммаКупона(_rs.value("T_FIID"),1,_rs.value("T_DRAWINGDATE") ))); // 08.
        csvFile.AddCell(""); // 09. 
        csvFile.AddCell( (_rs.value("t_DepoRest"))); // 10.
        csvFile.AddCell( (_rs.value("t_amortnominal"))); // 11.
        csvFile.AddRow();
      end;
    end;
    
//   var format;
//   while(_rs.movenext)
//     format = ФорматСтроки(_rs.value("T_FIID"),_rs.value("T_pFIID"), _rs.value("t_DepoRest"));
//       if( (_rs.value("T_INCOMERATE") == 0) and (repSource == "Sofr") )
//        Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"G"+(rn)+"\").AddComment(\"Значение ставки купона №" + _rs.value("T_NUMBER") + " для обл. " + _rs.value("T_DEFINITION") + " не определено в RuData на момент последнего обновления справочника ЦБ.\") ;");
//        Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"G"+(rn)+"\").Comment.Shape.TextFrame.Characters.Font.Size=7 ;");
//       end;
//     Rep.AddPrintCell(_rs.value("t_isin"),              col1_len, null, "l:"+format); // 1.  Код ценной бумаги
//     Rep.AddPrintCell(_rs.value("T_DEFINITION"),        col2_len, null, "l:"+format); // 2.  Балансовый счет
//     Rep.AddPrintCell(_rs.value("T_SHORTNAME"),        col25_len, null, "l:"+format); // 2.  Балансовый счет
//     Rep.AddPrintCell(date(_rs.value("T_DRAWINGDATE")),         col3_len, null, "c:"+format); // 3.  Счет вложений
//     Rep.AddPrintCell((_rs.value("T_FI_DRAWINGDATE")),         col3_len, null, "c:"+format); // 3.  Счет вложений
//     Rep.AddPrintCell(_rs.value("T_NUMBER"), col4_len, null, "c:"+format); // 4.  Валюта  
//     Rep.AddPrintCell(_rs.value("T_INCOMERATE"),              col5_len, null, "r:"+format); // 5.  ISIN
//     Rep.AddPrintCell(_rs.value("t_INCOMEVOLUME"),   col6_len, null, "r:"+format); // 6.  Дата начала купона
//     Rep.AddPrintCell(СуммаКупона(_rs.value("T_FIID"),1,_rs.value("T_DRAWINGDATE") ),   col6_len, null, "r:"+format); // 6.  Дата начала купона
//     Rep.AddPrintCell(_rs.value("T_Empty"), col7_len, null, format); // 7.  Дата начала купона
//     Rep.AddPrintCell(_rs.value("t_DepoRest"),            col8_len, null, "r:"+format); // 8.  Номер купона
//     Rep.AddPrintCell(_rs.value("t_amortnominal"),        col9_len, null, "r:"+format); // 9.  Ставка купона
//     ДобавитьСтроку;
//   end;
// печатьЗакладкиАмортизаций();

end;


macro run()
  sql = null;

  if (repSource == "Sofr")
    header = ".Софр";
    SQL = "SELECT /*+ INDEX_JOIN(FW) */ av.t_isin,  "
          + "       FI.T_DEFINITION,  "
          + "       FW.T_DRAWINGDATE,case FI.T_DRAWINGDATE when to_date('31122999','ddmmyyyy') then 'Бессрочная' else to_char(FI.T_DRAWINGDATE,'DD.MM.YYYY') end t_fi_drawingdate,  "
          + "       FW.T_NUMBER,  "
          + "       FW.T_INCOMERATE,  "
          + "       TO_CHAR(FW.T_INCOMEVOLUME, 'FM999G999G999G990D00') t_INCOMEVOLUME,  "
          + "       '  ' T_Empty,  "
          + "       to_char(NVL(rshb_user.getKDURestOnDate(fi.t_fiid, :repdate), 0),'999G999G999G999') t_DepoRest,  "
          + "       TO_CHAR(RSB_FIINSTR.FI_GETNOMINALONDATE(fi.t_fiid, :repdate1), 'FM999G999G999G990D00') || ' ' || TO_CHAR(F1.T_CCY) t_amortnominal, "
          + "        fi.t_fiid,  lag(fi.t_fiid) over (order by fi.t_fiid, fw.t_number ) T_pFiid ,  P.T_SHORTNAME"
          + "  FROM dfininstr_dbt fi,  "
          + "       davoiriss_dbt av,  "
          + "       dfiwarnts_dbt fw,  "
          + "       dfininstr_dbt f1, dparty_dbt p  "
          + " WHERE RSI_RSB_FIInstr.FI_AvrKindsGetRoot(fi.t_fi_kind, fi.t_AvoirKind) = 17  "
          + "   AND fi.t_fiid = av.t_fiid AND FI.T_ISSUER = P.T_PARTYID "
          + "   AND FW.T_FIID = AV.T_FIID  and fw.t_ispartial = CHR(0)"
          + "   AND FW.T_DRAWINGDATE BETWEEN :begdate AND :enddate  "
          + "   AND f1.t_fiid = FI.T_FACEVALUEFI  "
          + " ORDER BY fi.t_fiid, FW.T_NUMBER ";

    n_dl_sql = "  SELECT                                                " +
            "        av.t_isin, " +
            "         FI.T_DEFINITION, p.t_shortname, " +
            "         FW.T_DRAWINGDATE t_amortdate, FI.T_DRAWINGDATE, " +
            "         FW.T_INCOMERATE, " +
            "         TO_CHAR (FW.T_INCOMEVOLUME, 'FM999G999G999G990D00') t_INCOMEVOLUME, " +
            "         chr(1) AS MTY_TYPE " +
            "    FROM dfininstr_dbt fi, " +
            "         davoiriss_dbt av, " +
            "         dfiwarnts_dbt fw, " +
            "         dfininstr_dbt f1, " +
            "         dparty_dbt p " +
            "   WHERE RSI_RSB_FIInstr.FI_AvrKindsGetRoot (fi.t_fi_kind, fi.t_AvoirKind) = 17 " +
            "         AND fi.t_fiid = av.t_fiid " +
            "         AND FI.T_ISSUER = P.T_PARTYID " +
            "         AND FW.T_FIID = AV.T_FIID " +
            "         AND fw.t_ispartial = CHR (88) " +
            "         AND FW.T_DRAWINGDATE BETWEEN :begdate AND :enddate " +
            "         AND f1.t_fiid = FI.T_FACEVALUEFI " +
            "ORDER BY fi.t_fiid, FW.t_drawingdate " ;
  else
    header = ".RuData";
    SQL = "SELECT /*+ INDEX_JOIN(FI) */ av.t_isin,  "
          + "       FI.T_DEFINITION,  "
          + "       SB.END_PERIOD T_DRAWINGDATE,case FI.T_DRAWINGDATE when to_date('31122999','ddmmyyyy') then 'Бессрочная' else to_char(FI.T_DRAWINGDATE,'DD.MM.YYYY') end t_fi_drawingdate,  "
          + "       SB.ID_COUPON T_NUMBER,  "
          + "       nvl(to_char(SB.COUPON_RATE, 'FM9999999999990.00000000000000'), '0,00') T_INCOMERATE,  "
          + "       nvl(SB.COUPON_VAL, '0,00') t_INCOMEVOLUME,  "
          + "       '  ' T_Empty,  "
          + "       to_char(NVL(rshb_user.getKDURestOnDate(fi.t_fiid, :repdate), 0),'999G999G999G999') t_DepoRest,  "
          + "       TO_CHAR(RSB_FIINSTR.FI_GETNOMINALONDATE(fi.t_fiid, :repdate), 'FM999G999G999G990D00') || ' ' || TO_CHAR(F1.T_CCY) t_amortnominal , "
          + "       fi.t_fiid,  lag(fi.t_fiid) over (order by fi.t_fiid, SB.ID_COUPON ) T_pFiid ,  P.T_SHORTNAME"
          + "  FROM dfininstr_dbt fi  "
          + "       JOIN davoiriss_dbt    av ON fi.t_fiid = av.t_fiid  "
          + "       JOIN dparty_dbt       p ON FI.T_ISSUER = P.T_PARTYID  "
          + "       JOIN dobjcode_dbt     c ON c.t_objecttype = 9 AND c.t_codekind = 104 AND c.t_objectid = fi.t_fiid AND c.t_state = 0 "
          + "       JOIN SOFR_BOND_COUPONS sb ON sb.id_fintool = c.t_code AND SB.END_PERIOD BETWEEN :begdate AND :enddate "
          + "       JOIN dfininstr_dbt    f1 ON f1.t_fiid = FI.T_FACEVALUEFI  "
          + " WHERE RSI_RSB_FIInstr.FI_AvrKindsGetRoot(fi.t_fi_kind, fi.t_AvoirKind) = 17  "
          + " ORDER BY fi.t_fiid, SB.ID_COUPON ";

    n_dl_sql =" SELECT                            " +
          "        av.t_isin, " +
          "         FI.T_DEFINITION, p.t_shortname," +
          "         SBA.MTY_DATE t_amortdate, FI.T_DRAWINGDATE," +
          "         to_char(SBA.MTY_PART, 'FM9999999999990.000000000000000') T_INCOMERATE, " +
          "         to_char(SBA.PAY_PER_BOND, 'FM9999999999990.0000000000') T_INCOMEVOLUME, " +
          "         sba.mty_type " +
          "    FROM dfininstr_dbt fi " +
          "         JOIN davoiriss_dbt    av ON fi.t_fiid = av.t_fiid " +
          "         JOIN dparty_dbt       p ON FI.T_ISSUER = P.T_PARTYID " +
          "         JOIN dobjcode_dbt     c ON c.t_objecttype = 9 AND c.t_codekind = 104 AND c.t_objectid = fi.t_fiid AND c.t_state = 0 " +
          "         JOIN SOFR_BOND_amortizations sba ON sba.id_fintool = c.t_code AND SBA.MTY_DATE BETWEEN :begdate AND :enddate " +
          "         JOIN dfininstr_dbt    f1 ON f1.t_fiid = FI.T_FACEVALUEFI " +
          "   WHERE RSI_RSB_FIInstr.FI_AvrKindsGetRoot (fi.t_fi_kind, fi.t_AvoirKind) = 17 " +
          "ORDER BY fi.t_fiid, SBA.MTY_DATE " ;
  end;

  cmd = RSDCommand(sql);
  cmd.addParam("repDate"  , rsdbp_in , repDate );
  cmd.addParam("repDate1"  , rsdbp_in , repDate );
  cmd.addParam("begDate", rsdbp_in , p1Date );
  cmd.addParam("endDate"  , rsdbp_in , p2Date );
  rs = RSdRecordSet(cmd);

  initRep(TEMPL_NAME);

  var CSV_NAME   = "rep_906_coupons_csv.txt";
  SHEET_NAME = "Купоны";
  csvFile = C_CSVFile();
  if (printEngine.UsePoi())
    csvFile.SetLimitRow(FLUSH_COUNT_XLSX);
  end;
  fName = csvFile.CreateFullFileName(CSV_NAME);
  csvFile.FileOpen(fName, true);
  printEngine.SheetChange(SHEET_NAME);

  csvTable = printEngine.RegisterTable("TemplateTable", "TemlplateTableHeader", true);
  ПечатьБлокаДанных(rs);

  csvFile.FileClose();
  csvTable.FillTabelFromCSV(csvFile.GetlsFileName());
  printEngine.CopyAllSheetInTotalBook (null, false, csvTable.GetTableRange(), 0, SHEET_NAME + header);
  csvTable.EndTable();


  n_dl_cmd = RSDCommand(n_dl_sql);
  n_dl_cmd.AddParam("", rsdbp_in,p1Date);   
  n_dl_cmd.AddParam("", rsdbp_in,p2Date);  
  n_dl_rs = rsdRecordset(n_dl_cmd, rsdval_client, rsdval_static);

  CSV_NAME   = "rep_906_amort_csv.txt";
  SHEET_NAME = "Амортизации";
  csvFile = C_CSVFile();
  if (printEngine.UsePoi())
    csvFile.SetLimitRow(FLUSH_COUNT_XLSX);
  end;
  fName = csvFile.CreateFullFileName(CSV_NAME);
  csvFile.FileOpen(fName, true);

  printEngine.SheetChange(SHEET_NAME);
  csvTable = printEngine.RegisterTable("amortTableRow", "amortTableHeader", true);
  печатьЗакладкиАмортизаций(n_dl_rs);

  csvFile.FileClose();
  csvTable.FillTabelFromCSV(csvFile.GetlsFileName());
  printEngine.CopyAllSheetInTotalBook (null, false, csvTable.GetTableRange(), 0, SHEET_NAME + header);
  csvTable.EndTable();

  printEngine.Close();
  showRep(GetUniqAdd("report_906"));
end;

END; // CLASS clF405


PRIVATE MACRO AddCol (ar,ind, fld, head, width, rdonly, ty, dp)
   ar.value (ind * 6)     = fld;
   ar.value (ind * 6 + 1) = head;
   ar.value (ind * 6 + 2) = width;
   ar.value (ind * 6 + 3 ) = rdonly;   // fldType
   ar.value (ind * 6 + 4 ) = dp;//   decPoint
   ar.value (ind * 6 + 5 ) = 0;   // reserv
END;


macro EvProcPrtf(rs, cmd, id, key)
   
   if (cmd == DLG_KEY)
    if (key == 13)
       pPortfolioID   = rs.value("t_element");
       pPortfolioName = rs.value("T_NAME");
       return CM_SELECT;
    end;   
  end;
end;


private macro FillPortfolio();
  var rec;
   rec = " select val.t_element, VAL.T_NAME " +
        "  from dllclsval_dbt clv, dllclass_dbt cls, dllvalues_dbt val " +
        "  where CLV.T_CLASSIFICATOR = CLS.T_CLASSIFICATOR " +
        "    and clv.t_element = VAL.T_ELEMENT " +
        "    and val.t_list = clv.t_list  " +
        "    and clv.t_classificator = 1649";

  rec = RSDRecordset(rec, rsdval_client, rsdval_static);

  var col = TArray();
  AddCol (col, 0, "t_element",    "№.",   2 ,  0,0);
  AddCol (col, 1, "T_NAME",    "Наименование портфеля",   30 ,  0,0);
  var retval = runScroll(rec, 2, col, "Портфели ЦБ", "EvProcPrtf", "", "", true );
  
end;


macro PnlProc(dlgPanel, cmd, id, key, numScroll)
  var CM_FLAG = CM_DEFAULT;

  private macro changeRB()
      if (dlgPanel.rec.rbSofr == "X")
        dlgPanel.rec.rbSofr = "";
        dlgPanel.rec.rbRuData = "X";
        repSource = "RuData";
      else
        dlgPanel.rec.rbSofr = "X";
        dlgPanel.rec.rbRuData = "";
        repSource = "Sofr";
      end;
      UpdateFields(dlgPanel);    
  end;

  if (cmd == DLG_INIT)
    repDate = p1Date = p2Date = {CurDate}; 
    dlgPanel.rec.repDate = dlgPanel.rec.startDate = dlgPanel.rec.endDate = {CurDate};
    dlgPanel.rec.rbSofr = "X";
    dlgPanel.rec.rbRuData = "";
    repSource = "Sofr";

    UpdateFields(dlgPanel);
  elif(cmd==DLG_KEY)
//msgbox("key=" + key +"   " + "id="  + id);
    if (key ==K_F2)
      var f657_2 = clF657_2();
      repDate = dlgPanel.rec.repDate;
      p1Date = dlgPanel.rec.startDate;
      p2Date = dlgPanel.rec.endDate;

      //UpdateFields(dlgPanel);
      f657_2.run;
    elif (key ==K_F3)
      if(id == 0)
        repDate = GetDateByCalendar({CurDate});
        dlgPanel.rec.repDate = repDate;
        UpdateFields(dlgPanel);

      elif(id == 1)
        p1Date = GetDateByCalendar({CurDate});
        if(p1Date < repDate)
        //  msgbox("Начало периода не может быть раньше даты отчета!");
        //  dlgPanel.rec.startDate = p1Date = repDate;
        dlgPanel.rec.startDate = p1Date;
        else
          dlgPanel.rec.startDate = p1Date;
        end;
        UpdateFields(dlgPanel);

      elif(id == 2)
        p2Date = GetDateByCalendar({CurDate});
        if(p2Date < p1Date)
          msgbox("Конец периода не может быть раньше начала периода!");
          dlgPanel.rec.endDate = p2Date = p1Date;
        else
          dlgPanel.rec.endDate = p2Date
        end;
        UpdateFields(dlgPanel);
      elif(id == 3)
        FillPortfolio();
        dlgPanel.rec.pPortfolio = pPortfolioName;      
      end;     
     //dlgPanel.rec.pDate = repdt;
       UpdateFields(dlgPanel);

    elif (key == 32)
        if ((id == 3) or (id == 4))
          changeRB();
        end;
    end;

  end;
  
end;



var pnl = tRecHandler("UPCOUPON", "f657.lbr", true);
runDialog(pnl, @PnlProc);

exit(1);
