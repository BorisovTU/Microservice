
import RSD, globals;

const K_ENTER   = 13;
//const K_ESC     = 27;
const K_F3      = 317;
const K_F2      = 316;
const K_F8      = 322;
const K_F9      = 323;


PRIVATE MACRO AddCol (ar,ind, fld, head, width, rdonly, ty, dp)
   ar.value (ind * 6)     = fld;
   ar.value (ind * 6 + 1) = head;
   ar.value (ind * 6 + 2) = width;
   ar.value (ind * 6 + 3 ) = rdonly;   // fldType
   ar.value (ind * 6 + 4 ) = dp;//   decPoint
   ar.value (ind * 6 + 5 ) = 0;   // reserv
END;

var shift = "", kind = 0, logid = -1;

macro Scroll
   var cmd1, rs1, col1, need = true,Column = TArray(),i, ColumnValue, ColumnName, NumColumns = 0, cond = "";

   macro EvProc2(rs, cmd, id, key)
     var  CM_DEFAULT = null;
     if ((cmd == DLG_KEY)and(key == K_ENTER))
        if (rs.RecCount > 0)
          return CM_SELECT;
        end;
     end;
     return CM_DEFAULT;
  end;

   macro EvProc(rs, cmd, id, key)
     var  CM_DEFAULT = null;

     if ((cmd == DLG_KEY)and(key == K_ENTER))
       /* if (rs.RecCount > 0)
          return CM_SELECT;
        end;*/
      elif ((cmd == DLG_KEY)and(key == 18))
         cond = "";
         need = true;
         return 2;
      elif ((cmd == DLG_KEY)and(key == K_ESC))
         return 2;
      end;

     return CM_DEFAULT;
   end;

   col1 = TArray;   
   var arnum = -1;
   AddCol (col1, arnum=arnum+1, "ABSID",   "Код клиента АБС",   20 ,  0,0);
   AddCol (col1, arnum=arnum+1, "T_NUMBER", "Номер ДБО",    18,  0,0);
   AddCol (col1, arnum=arnum+1, "T_datebegin", "Дата договора",    18,  0,0);
   AddCol (col1, arnum=arnum+1, "TP",       "Торговые площадки",    30, 0);
   AddCol (col1, arnum=arnum+1, "EKK",      "EKK",   10 ,  0,0);
   AddCol (col1, arnum=arnum+1, "EDP",      "EДП",   10 ,  0,0);

   while (need)
      need = false;
      cmd1 = 
             "  SELECT (SELECT t_code " +
             "            FROM dobjcode_dbt o " +
             "           WHERE     t_objecttype = 3 " +
             "                 AND t_codekind = 101 " +
             "                 AND t_state = 0 " +
             "                 AND O.T_OBJECTID = dsf.t_partyid) " +
             "            absid, " +
             "         dsf.t_number, " +
             "         dsf.t_datebegin, " +
             "         (SELECT LISTAGG (t_name, '; ') WITHIN GROUP (ORDER BY t_name) " +
             "            FROM (SELECT DECODE ( " +
             "                            TO_CHAR (s.t_servkind) || TO_CHAR (s.t_servkindsub), " +
             "                            18, 'Фондовый', " +
             "                            19, 'Внебиржевой', " +
             "                            158, 'Срочный', " +
             "                            218, 'Валютный', " +
             "                            TO_CHAR (s.t_servkind) || TO_CHAR (s.t_servkindsub)) " +
             "                         || ' ' " +
             "                         || NVL (o.t_code, '') " +
             "                            t_name " +
             "                    FROM ddlcontrmp_dbt mp, " +
             "                            dsfcontr_dbt s " +
             "                         LEFT JOIN " +
             "                            dobjcode_dbt o " +
             "                         ON (o.t_codekind = 1 AND o.t_objecttype = 3) " +
             "                   WHERE     s.t_id = mp.t_sfcontrid " +
             "                         AND mp.t_marketid = o.t_objectid " +
             "                         AND mp.t_dlcontrid = d.t_dlcontrid)) " +
             "            tp, " +
             "         (SELECT t_code " +
             "            FROM ddlobjcode_dbt " +
             "           WHERE     t_objecttype = 207 " +
             "                 AND t_objectid = d.t_dlcontrid " +
             "                 AND t_codekind = 1) " +
             "            ekk, " +
             "         (SELECT LISTAGG (edp, '; ') WITHIN GROUP (ORDER BY edp) " +
             "            FROM (SELECT DISTINCT DECODE (RSB_SECUR. " +
             "                                           GetGeneralMainObjAttr ( " +
             "                                             659, " +
             "                                             LPAD (ss.t_ID, 10, '0'), " +
             "                                             102, " +
             "                                             TRUNC (SYSDATE)), " +
             "                                          1, 'Да', " +
             "                                          2, 'Нет') " +
             "                                     edp " +
             "                    FROM ddlcontrmp_dbt mpp, dsfcontr_dbt ss " +
             "                   WHERE     ss.t_id = mpp.t_sfcontrid " +
             "                         AND mpp.t_dlcontrid = d.t_dlcontrid " +
             "                         AND ss.t_servkindsub = 8)) " +
             "            edp " +
             "    FROM ddlcontr_dbt d, dsfcontr_dbt dsf " +
             "   WHERE dsf.t_dateclose = TO_DATE ('01010001', 'ddmmyyyy') " +
             "         AND d.t_sfcontrid = dsf.t_id " +
             "ORDER BY t_number " ;


      cmd1 = RSDCommand(cmd1);
      rs1 = RSDRecordset(cmd1 , null, RSDVAL_STATIC );


      if (RunScroll (rs1,col1.size/6, col1, "test" ,"EvProc","Сверочный отчет"," ", true, 1, 1))
       //   return rs1;
      end;
   end;

return null;

end;

Scroll;
exit(1);
