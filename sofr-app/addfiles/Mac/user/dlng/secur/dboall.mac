/************************************************************************/
/*  Имя файла      : dboall.mac                                         */
/*                                                                      */
/*  Описание       : Отправка сообщений клиентам принятых               */
/*                   на обслуживание                                    */
/*                                                                      */
/*  Программист    : Филиппов Б.В.                                      */
/*                                                                      */
/*  Создан         : 11.10.2018                                         */
/************************************************************************/

import oralib, likepy;
import rsexts;
Import rsd, RsbDataSet;
Import rslscr, or_rep_h;
import email_library;

var statMes;
var statsend;

Class (TRecHandler) PrintForm(indlcid)
 
private   var rs, select, rs_sd, select_sd, rs_se, select_se, rs_mes, select_mes, rs_stat, select_stat, rs_accs, select_accs, ar_accs = TArray();
private   var rs_DD, select_DD, rs_SHD, select_SHD, rs_TSD, select_TSD, rs_DTD, select_DTD, rs_ADR, select_ADR;
private   var Rep = CMakeReport;
private   var NumberDBO = "";
private   var NumDBO = "";
private   var NDBO = "";
private   var GODBO = "";
private   var DTMP : string;
private   var TM   : string;
private   var DT   : string;
private   var DTOBC: string;
private   var cmd;
private   var {oper};
private   var {HeadBankID}; 
private   var {curdate};
private   var FlNm;
private   var FileDir;
private   var SMTP_SERVER;    
private   var SMTP_SERVER_PORT = 25;
private   var SMTP_USERNAME;
private   var SMTP_PASSWORD;
private   var SMTP_USESSL = true;
private   var PATH_OUT;
private   var Mess;
private   var FileDirForm;
private   var dlcid = indlcid;

statMes = "Сообщение уже было сформировано";

private class CAccs(_acc, _mpcode, _servkind, _servkindsub, _mpregdate, _isocur)
   var acc,mpcode,servkind, servkindsub, mpregdate, isocur;
   acc         = _acc;         
   mpcode      = _mpcode;      
   servkind    = _servkind;    
   servkindsub = _servkindsub;
   mpregdate   = _mpregdate;
   isocur      = _isocur;
end;

private macro GetNameSection(kind, kindsub, isocur)
   var retval = "";
   if (kind == 15)
      retval = "Срочный рынок";
   elif(kind == 1)
     if (KindSub == 8)
        retval = "Фондовый рынок";
     elif (KindSub == 9)
        retval = "Внебиржевой рынок";
     end;
   end;

   return RetVal + " (" + isocur + ")";
end;


/*ak
     select =  "select dp.t_partyid, "
               "dmacc.t_mpcode, "
               "doc.t_code, "
	       "ddl.t_dlcontrid, "
	       "ddl.t_email, "
	       "dsf.t_name, "
	       "dsf.t_number, "
	       "dp.t_name t_namedp, "
	       "dp.t_legalform, "
	       "ddl.t_iis, "
	       "ddl.t_iisfirstnumber, "
	       "dac.t_account, "
	       "dac.t_open_date, (select t_code from dobjcode_dbt where t_objectid = dsf.t_partyid and t_objecttype = 3 and t_codekind = 8) mmvbcode "
	       "from ddlcontr_dbt ddl, "
	       "dsfcontr_dbt dsf, "
	       "dparty_dbt dp, "
               "ddlcontracc_dbt acc, "
	       "daccount_dbt dac, "
	       "dobjcode_dbt doc, "
               "ddlcontrmp_dbt dmacc " 
	       "where ddl.t_sfcontrid = dsf.t_id "
	       "and dsf.t_partyid = dp.t_partyid "
               "and ddl.t_dlcontrid = acc.t_dlcontrid "
	       "and acc.t_accountid = dac.t_accountid "
	       "and dsf.t_partyid = doc.t_objectid "
               "and dmacc.t_dlcontrid = ddl.t_dlcontrid "
	       "and doc.t_codekind = 1 and doc.t_state = 0 and ddl.t_dlcontrid = " + dlcid + "";*/
     select = "select dp.t_partyid, "
            + "       dmacc.t_mpcode, "
            + "       nvl(doc.t_code,chr(1)) t_code, "
            + "       ddl.t_dlcontrid, "
            + "       ddl.t_email, "
            + "       dsf.t_name, "
            + "       dsf.t_number, "
            + "       dp.t_name t_namedp, "
            + "       dp.t_legalform, "
            + "       ddl.t_iis, "
            + "       ddl.t_iisfirstnumber, "
            + "       nvl(dac.t_account, chr(1)) t_account, "
            + "       nvl(dac.t_open_date, to_date('01.01.0001','dd.mm.yyyy')) t_open_date, "
            + "       (select t_code from dobjcode_dbt where t_objectid = dsf.t_partyid and t_objecttype = 3 and t_codekind = 8) mmvbcode "
            + "from ddlcontr_dbt ddl "
            + "join dsfcontr_dbt dsf on ddl.t_sfcontrid = dsf.t_id "
            + "join dparty_dbt dp on dsf.t_partyid = dp.t_partyid "
            + "left join ddlcontracc_dbt acc on ddl.t_dlcontrid = acc.t_dlcontrid "
            + "left join daccount_dbt dac on acc.t_accountid = dac.t_accountid "
            + "left join dobjcode_dbt doc on dsf.t_partyid = doc.t_objectid and doc.t_codekind = 1 and doc.t_state = 0 "
            + "left join ddlcontrmp_dbt dmacc on dmacc.t_dlcontrid = ddl.t_dlcontrid "
            + "where ddl.t_dlcontrid = " + dlcid + "";
/*~ak*/

     rs = RsdRecordSet(RsdCommand(select));
     rs.moveNext();

     if (rs.value("t_namedp") == NullVal)
        return;
     end;

      select_sd = "select * from dsfcontr_dbt sfc, ddlcontrmp_dbt dlc "
                  " where dlc.t_sfcontrid = sfc.t_id and dlc.t_dlcontrid = " + dlcid + "";

      rs_sd = RsdRecordSet(RsdCommand(select_sd));
      rs_sd.moveNext();


   if (rs.value("t_legalform") == 2)
      select_se = "select t_isemployer from dpersn_dbt dpe, dparty_dbt dp "
                  "where dp.t_partyid  = dpe.t_personid and dpe.t_personid = "+ rs.value("t_partyid")+"";

      rs_se = RsdRecordSet(RsdCommand(select_se));
      rs_se.moveNext();
   end;


     select_mes =  "select ddl.t_dlcontrid, t_createdate "
                   "from ddlcontr_dbt ddl, "
                   "dsfcontr_dbt dsf, "
                   "ddlcontrmsg_dbt msg, "
                   "dimgdata_dbt dim, "
                   "dparty_dbt dpy, "
                   "dobjatcor_dbt dob "
                   "where ddl.t_sfcontrid = dsf.t_id "
                   "and ddl.t_dlcontrid = msg.t_dlcontrid "
                   "and msg.t_id = dim.t_objectid "
                   "and msg.t_kind = 500 "
                   "and dim.t_objecttype = 208 "
                   "and LPAD (ddl.t_dlcontrid, 34, '0') = dob.t_object "
                   "and dsf.t_partyid = dpy.t_partyid "
                   "and dob.t_attrid = 3 "
                   "and dob.t_objecttype = 207 "
                   "and dob.t_groupid = 101 "
                   "and ddl.t_dlcontrid = " + dlcid + "";

      rs_mes = RsdRecordSet(RsdCommand(select_mes));
      rs_mes.moveNext();

      select_stat = "select ddl.t_dlcontrid "
                    "from ddlcontr_dbt ddl, "
                    "dsfcontr_dbt dsf, "
                    "dobjatcor_dbt dob "
                    "where ddl.t_sfcontrid = dsf.t_id "
                    "and lpad (ddl.t_dlcontrid, 34, '0') = dob.t_object "
                    "and dob.t_attrid = 3 "
                    "and dob.t_objecttype = 207 "
                    "and dob.t_groupid = 101 "
                    "and ddl.t_dlcontrid = " + dlcid + "";

      rs_stat = RsdRecordSet(RsdCommand(select_stat));
      rs_stat.moveNext();


      select_accs = 
                     "  SELECT DECODE (p.t_legalform, 1, st.t_account, ba.t_account) account, "
                   //  "        p.t_legalform,                                          "
                     "        mp.t_mpcode,                                            "
                     "        sf.t_servkind,                                          " +
                     "        sf.t_servkindsub,                                       "
                     "        mp.t_mpregdate,                                          "
                     "        (select t_ccy from dfininstr_dbt where t_fiid = st.t_fiid) cur "
                     "   FROM dsfcontr_dbt sf,                                        "
                     "        dsettacc_dbt st,                                        "
                     "        dpmautoac_dbt pm,                                       " +
                     "        dsfssi_dbt ssi,                                         "
                     "        ddlcontrmp_dbt mp,                                      "
                     "        dparty_dbt p,                                           "
                     "        dbrokacc_dbt ba                                         "
                     "  WHERE     mp.t_dlcontrid = " + dlcid + "                      " +
                     "        AND SF.T_ID = mp.t_sfcontrid                            "
                     "        AND SSI.T_OBJECTTYPE = 659                              "
                     "        AND LPAD (sf.t_id, 10, '0') = ssi.t_objectid            "
                     "        AND ssi.t_setaccid = ST.T_SETTACCID                     "
                     "        AND PM.T_SETTACCID = ST.T_SETTACCID                     " +
                     "        AND p.t_partyid = sf.t_partyid                          "
                     "        AND ba.t_servkind = sf.t_servkind                       "
                     "        AND ba.t_servkindsub = sf.t_servkindsub                 "
                     "        AND BA.T_CURRENCY = st.t_fiid                           "
                     "        and substr(st.t_account,1,5) = substr(ba.t_account,1,5) "
                     "        order by sf.t_servkind, sf.t_servkindsub                ";

      rs_accs = RsdRecordSet(RsdCommand(select_accs));
      while (rs_accs.moveNext())
         ar_accs(ar_accs.size()) = CAccs(rs_accs.value(0),rs_accs.value(1),rs_accs.value(2),rs_accs.value(3), rs_accs.value(4), rs_accs.value(5));
      end;

     select_DD = "select nvl(max(rtrim(UTL_RAW.CAST_TO_VARCHAR2(notetext.t_text),chr(0))),chr(1)) note102 "
                 "from ddlcontrmp_dbt dlcontrmp " 
                 "join dnotetext_dbt notetext on notetext.t_objecttype = 207 and "
                 "notetext.t_documentid = lpad(dlcontrmp.t_dlcontrid,34,'0') and "
                 "notetext.t_notekind = 102 "
                 "where dlcontrmp.t_dlcontrid = " + dlcid + "";                                                    

     rs_DD = RsdRecordSet(RsdCommand(select_DD));
     rs_DD.moveNext();



     select_SHD = "select nvl(max(rtrim(UTL_RAW.CAST_TO_VARCHAR2(notetext.t_text),chr(0))),chr(1)) note101 "
                  "from ddlcontrmp_dbt dlcontrmp " 
                  "join dnotetext_dbt notetext on notetext.t_objecttype = 207 and "
                  "notetext.t_documentid = lpad(dlcontrmp.t_dlcontrid,34,'0') and "
                  "notetext.t_notekind = 101 "
                  "where dlcontrmp.t_dlcontrid = " + dlcid + "";                                                    

     rs_SHD = RsdRecordSet(RsdCommand(select_SHD));
     rs_SHD.moveNext();

     select_TSD = "select nvl(max(rtrim(UTL_RAW.CAST_TO_VARCHAR2(notetext.t_text),chr(0))),chr(1)) note104 "
                  "from ddlcontrmp_dbt dlcontrmp " 
                  "join dnotetext_dbt notetext on notetext.t_objecttype = 207 and "
                  "notetext.t_documentid = lpad(dlcontrmp.t_dlcontrid,34,'0') and "
                  "notetext.t_notekind = 104 "
                  "where dlcontrmp.t_dlcontrid = " + dlcid + "";                                                    

     rs_TSD = RsdRecordSet(RsdCommand(select_TSD));
     rs_TSD.moveNext();

     select_DTD = "select rsb_struct.getdate(notetext.t_text) note103 "
                  "from ddlcontrmp_dbt dlcontrmp " 
                  "join dnotetext_dbt notetext on notetext.t_objecttype = 207 and "
                  "notetext.t_documentid = lpad(dlcontrmp.t_dlcontrid,34,'0') and "
                  "notetext.t_notekind = 103 "
                  "where dlcontrmp.t_dlcontrid = " + dlcid + "";                                                    

     rs_DTD = RsdRecordSet(RsdCommand(select_DTD));
     rs_DTD.moveNext();

 /*Определение номера договора и кода филиала */

     NumberDBO =  rs.value("t_number");
     NDBO =  SubStr(NumberDBO, StrBrk (NumberDBO,"-") + 1);
        if  (StrBrk (NumberDBO,"-") != 0)
          if  (StrBrk (NumberDBO,"/") != 0)
            GODBO = SubStr(NumberDBO, 1, (StrBrk (NumberDBO,"/")-1));
              GetRegistryValue("РСХБ\\ДИРЕКТОРИИ\\OUT\\ФИЛИАЛ", V_STRING, PATH_OUT);
          else
            GODBO = SubStr(NumberDBO, 1, (StrBrk (NumberDBO,"-")-1));
              GetRegistryValue("РСХБ\\ДИРЕКТОРИИ\\OUT\\ФИЛИАЛ", V_STRING, PATH_OUT);
          end;
        else
              GetRegistryValue("РСХБ\\ДИРЕКТОРИИ\\OUT\\ГО", V_STRING, PATH_OUT);
        end;

     NumDBO  =  StrSubst (NumberDBO, "/", "-");


/*
    if (IsStandAlone) /*Двухзвенка*/
     FileDirForm = PATH_OUT;
    else
     FileDirForm = "..\\" + PATH_OUT;
    end;
*/
     FileDirForm = "..\\txtFile\\";


     select_ADR = "SELECT ddp_dep_dbt.t_partyid, ddp_dep_dbt.t_name, dparty_dbt.t_normalizedname, dadress_dbt.t_place "
                  "FROM ddp_dep_dbt, dparty_dbt, dadress_dbt "
                  "WHERE dparty_dbt.t_partyid = ddp_dep_dbt.t_partyid " 
                  "AND dadress_dbt.t_partyid = dparty_dbt.t_partyid " 
                  "AND ddp_dep_dbt.t_name = " + GODBO + "00";

     rs_ADR = RsdRecordSet(RsdCommand(select_ADR));
     rs_ADR.moveNext();

 var place, doname;

   place  = rs_ADR.value("t_place");
   doname = "3349/"+ GODBO;
//   doname = rs_ADR.value("t_name");
   
   if (place == NullVal)
       place = "Москва";
   end;

   if (place == "")
       place = "Москва";
   end;

   if (doname == "3349/")
       doname = "АО Россельхозбанк";
   end;



  Macro Head_Form_UL() 

   Rep.RegisterForm
   ("letter", "Ф340_1_4_1.doc", string(FileDirForm + NumDBO + "("+ rs.value("t_namedp") + ")", ".doc"),
//   ("letter", "Ф340_1_4_1.doc", string(FileDirForm + NDBO + "(" + StrSubst (DT, ".", "-") + ")" + StrSubst (TM, ":", "-"), ".doc"),
    "Клиент","Номер", "Дата", 
    "ДатаМР1", "СубСчет1", "Договор1", "Секция1", 
    "ДатаМР2", "СубСчет2", "Договор2", "Секция2", 
    "ДатаМР3", "СубСчет3", "Договор3", "Секция3", 
    "ДатаМР4", "СубСчет4", "Договор4", "Секция4", 
    "ДатаМР5", "СубСчет5", "Договор5", "Секция5", 
    "ДатаМР6", "СубСчет6", "Договор6", "Секция6", 
    "ДатаБС", "КодКлиента", "Город", "ДОВСП");
 
   Rep.AddDoc("letter","Клиент","Номер", "Дата", 
              "ДатаМР1", "СубСчет1", "Договор1", "Секция1", 
              "ДатаМР2", "СубСчет2", "Договор2", "Секция2", 
              "ДатаМР3", "СубСчет3", "Договор3", "Секция3", 
              "ДатаМР4", "СубСчет4", "Договор4", "Секция4", 
              "ДатаМР5", "СубСчет5", "Договор5", "Секция5", 
              "ДатаМР6", "СубСчет6", "Договор6", "Секция6", 
              "ДатаБС", "КодКлиента", "Город", "ДОВСП");
   Rep.AddDocFields("Клиент"              , rs.value("t_namedp"));
   Rep.AddDocFields("Номер"               , rs.value("t_number"));
   Rep.AddDocFields("Дата"                , DT);
   //Rep.AddDocFields("ДатаМР"              , rs_sd.value("t_mpregdate"));
   //Rep.AddDocFields("СубСчет"             , rs_sd.value("t_number"));
   //Rep.AddDocFields("Договор"             , rs_sd.value("t_name"));
   //Rep.AddDocFields("Секция"              , rs_sd.value("t_mpcode"));

   for (var i, 1, 6, 1)
      if (ar_accs.size >= i )
         Rep.AddDocFields("СубСчет"+i , ar_accs(i-1).acc      );
         Rep.AddDocFields("Договор"+i , GetNameSection(ar_accs(i-1).servkind,ar_accs(i-1).servkindsub, ar_accs(i-1).isocur ));
         if (ar_accs(i-1).servkindsub != 9)
            Rep.AddDocFields("ДатаМР" +i , string(date(sqlDate2date(ar_accs(i-1).mpregdate)):f));
            Rep.AddDocFields("Секция" +i , ar_accs(i-1).mpcode);
         else
            Rep.AddDocFields("ДатаМР" +i , "");
            Rep.AddDocFields("Секция" +i , "");
         end;
      else
         Rep.AddDocFields("ДатаМР" +i , "");
         Rep.AddDocFields("СубСчет"+i , "");
         Rep.AddDocFields("Договор"+i , "");
         Rep.AddDocFields("Секция" +i , "");
      end;
   end;

   Rep.AddDocFields("ДатаБС"              , rs.value("t_open_date"));
   Rep.AddDocFields("Город"               , place);
   Rep.AddDocFields("ДОВСП"               , doname);
   Rep.AddDocFields("КодКлиента"          , rs.value("mmvbcode"));

   Rep.SetFlagShowReport(false);
   Rep.CreateTemplateData();
   Rep.ShowTemplateRep();
   Rep.ClearRegisterForm("letter");

  End;


  Macro Head_Form_FL() 

   Rep.RegisterForm
   ("letter", "Ф340_1_4_2.doc", string(FileDirForm + NumDBO + "("+ rs.value("t_namedp") + ")", ".doc"),
//   ("letter", "Ф340_1_4_2.doc", string(FileDirForm + NDBO + "(" + StrSubst (DT, ".", "-") + ")" + StrSubst (TM, ":", "-"), ".doc"),
    "Клиент","Номер", "Дата", "ДоговорДЕПО", "СчетДЕПО", "ТоргСчетДЕПО", "ДатаДЕПО",
    "ДатаМР1", "СубСчет1", "Договор1", "Секция1", 
    "ДатаМР2", "СубСчет2", "Договор2", "Секция2", 
    "ДатаМР3", "СубСчет3", "Договор3", "Секция3", 
    "ДатаМР4", "СубСчет4", "Договор4", "Секция4", 
    "ДатаМР5", "СубСчет5", "Договор5", "Секция5", 
    "ДатаМР6", "СубСчет6", "Договор6", "Секция6", 
    "ДатаБС", "КодКлиента", "Город", "ДОВСП");
 
   Rep.AddDoc("letter","Клиент","Номер", "Дата", "ДоговорДЕПО", "СчетДЕПО", "ТоргСчетДЕПО", "ДатаДЕПО",
              "ДатаМР1", "СубСчет1", "Договор1", "Секция1", 
              "ДатаМР2", "СубСчет2", "Договор2", "Секция2", 
              "ДатаМР3", "СубСчет3", "Договор3", "Секция3", 
              "ДатаМР4", "СубСчет4", "Договор4", "Секция4", 
              "ДатаМР5", "СубСчет5", "Договор5", "Секция5", 
              "ДатаМР6", "СубСчет6", "Договор6", "Секция6", 
              "ДатаБС", "КодКлиента", "Город", "ДОВСП");
   Rep.AddDocFields("Клиент"                , rs.value("t_namedp"));
   Rep.AddDocFields("Номер"                 , rs.value("t_number"));
   Rep.AddDocFields("Дата"                  , DT);
   //Rep.AddDocFields("ДатаМР"              , rs_sd.value("t_mpregdate"));
   //Rep.AddDocFields("СубСчет"             , rs_sd.value("t_number"));
   //Rep.AddDocFields("Договор"             , rs_sd.value("t_name"));
   //Rep.AddDocFields("Секция"              , rs_sd.value("t_mpcode"));


   for (var i, 1, 6, 1)
      if (ar_accs.size >= i )
         Rep.AddDocFields("СубСчет"+i , ar_accs(i-1).acc      );
         Rep.AddDocFields("Договор"+i , GetNameSection(ar_accs(i-1).servkind,ar_accs(i-1).servkindsub, ar_accs(i-1).isocur));
         if (ar_accs(i-1).servkindsub != 9)
            Rep.AddDocFields("ДатаМР" +i , string(date(sqlDate2date(ar_accs(i-1).mpregdate)):f));
            Rep.AddDocFields("Секция" +i , ar_accs(i-1).mpcode);
         else
            Rep.AddDocFields("ДатаМР" +i , "");
            Rep.AddDocFields("Секция" +i , "");
         end;
      else
         Rep.AddDocFields("ДатаМР" +i , "");
         Rep.AddDocFields("СубСчет"+i , "");
         Rep.AddDocFields("Договор"+i , "");
         Rep.AddDocFields("Секция" +i , "");
      end;
   end;

   Rep.AddDocFields("ДатаБС"              , rs.value("t_open_date"));
   Rep.AddDocFields("КодКлиента"          , rs.value("mmvbcode"));
   Rep.AddDocFields("ДоговорДЕПО"         , rs_DD.value("note102"));
   Rep.AddDocFields("СчетДЕПО"            , rs_SHD.value("note101"));
   Rep.AddDocFields("ТоргСчетДЕПО"        , rs_TSD.value("note104"));
   Rep.AddDocFields("Город"               , place);
   Rep.AddDocFields("ДОВСП"               , doname);
   Rep.AddDocFields("ДатаДЕПО"            , string(date(rs_DTD.value("note103")):f));


   Rep.SetFlagShowReport(false);
   Rep.CreateTemplateData();
   Rep.ShowTemplateRep();
   Rep.ClearRegisterForm("letter");

  End;

  Macro Head_Form_IIS() 
   Rep.RegisterForm
   ("letter", "Ф340_1_4_3.doc", string(FileDirForm + NumDBO + "("+ rs.value("t_namedp") + ")", ".doc"),
//   ("letter", "Ф340_1_4_3.doc", string(FileDirForm + NDBO + "(" + StrSubst (DT, ".", "-") + ")" + StrSubst (TM, ":", "-"), ".doc"),
    "Клиент", "НомерИИС", "Дата", "ДоговорДЕПО", "СчетДЕПО", "ТоргСчетДЕПО", "ДатаДЕПО",
    "ДатаМР1", "СубСчет1", "Договор1", "Секция1", 
    "ДатаМР2", "СубСчет2", "Договор2", "Секция2", 
    "ДатаМР3", "СубСчет3", "Договор3", "Секция3", 
    "ДатаМР4", "СубСчет4", "Договор4", "Секция4", 
    "ДатаМР5", "СубСчет5", "Договор5", "Секция5", 
    "ДатаМР6", "СубСчет6", "Договор6", "Секция6", 
    "ДатаБС", "КодКлиента", "Город", "ДОВСП");
 
   Rep.AddDoc("letter", "Клиент", "НомерИИС", "Дата", "ДоговорДЕПО", "СчетДЕПО", "ТоргСчетДЕПО", "ДатаДЕПО",
              "ДатаМР1", "СубСчет1", "Договор1", "Секция1", 
              "ДатаМР2", "СубСчет2", "Договор2", "Секция2", 
              "ДатаМР3", "СубСчет3", "Договор3", "Секция3", 
              "ДатаМР4", "СубСчет4", "Договор4", "Секция4", 
              "ДатаМР5", "СубСчет5", "Договор5", "Секция5", 
              "ДатаМР6", "СубСчет6", "Договор6", "Секция6", 
              "ДатаБС", "КодКлиента", "Город", "ДОВСП");
   Rep.AddDocFields("Клиент"                , rs.value("t_namedp"));
   Rep.AddDocFields("НомерИИС"              , rs.value("t_number"));
   Rep.AddDocFields("Дата"                  , DT);
   //Rep.AddDocFields("ДатаМР"              , rs_sd.value("t_mpregdate"));
   //Rep.AddDocFields("СубСчет"             , rs_sd.value("t_number"));
   //Rep.AddDocFields("Договор"             , rs_sd.value("t_name"));
   //Rep.AddDocFields("Секция"              , rs_sd.value("t_mpcode"));

   for (var i, 1, 6, 1)
      if (ar_accs.size >= i )
         Rep.AddDocFields("СубСчет"+i , ar_accs(i-1).acc      );
         Rep.AddDocFields("Договор"+i , GetNameSection(ar_accs(i-1).servkind,ar_accs(i-1).servkindsub, ar_accs(i-1).isocur));
         if (ar_accs(i-1).servkindsub != 9)
            Rep.AddDocFields("ДатаМР" +i , string(date(sqlDate2date(ar_accs(i-1).mpregdate)):f));
            Rep.AddDocFields("Секция" +i , ar_accs(i-1).mpcode);
         else
            Rep.AddDocFields("ДатаМР" +i , "");
            Rep.AddDocFields("Секция" +i , "");
         end;
      else
         Rep.AddDocFields("ДатаМР" +i , "");
         Rep.AddDocFields("СубСчет"+i , "");
         Rep.AddDocFields("Договор"+i , "");
         Rep.AddDocFields("Секция" +i , "");
      end;
   end;

   Rep.AddDocFields("ДатаБС"              , string(rs.value("t_open_date")));
   Rep.AddDocFields("КодКлиента"          , rs.value("mmvbcode"));
   Rep.AddDocFields("ДоговорДЕПО"         , rs_DD.value("note102"));
   Rep.AddDocFields("СчетДЕПО"            , rs_SHD.value("note101"));
   Rep.AddDocFields("ТоргСчетДЕПО"        , rs_TSD.value("note104"));
   Rep.AddDocFields("Город"               , place);
   Rep.AddDocFields("ДОВСП"               , doname);
   Rep.AddDocFields("ДатаДЕПО"            , string(date(rs_DTD.value("note103")):f));

   Rep.SetFlagShowReport(false);
   Rep.CreateTemplateData();
   Rep.ShowTemplateRep();
   Rep.ClearRegisterForm("letter");


  End;

  Macro Head() 

//   DT = {curdate};
   DT = string(date(date):f);
   TM = Time;
   TM = SubStr(TM, 1, 5);
//   DTOBC =  rs.value("t_open_date");
//   DTMP =   rs_sd.value("t_mpregdate");
//     FlNm = NDBO + "(" + StrSubst (DT, ".", "-") + ")" + StrSubst (TM, ":", "-") + ".doc";
     FlNm = NumDBO + "("+ rs.value("t_namedp") + ")" + ".doc";

   if (rs.value("t_legalform") == 1)
      if (rs.value("t_iis") == "X")
          Head_Form_IIS();
      else
          Head_Form_UL();
      end;
   elif (rs.value("t_legalform") == 2)
     if (rs_se.value("t_isemployer") == "X")
       if (rs.value("t_iis") == "X")
            Head_Form_IIS();
        else
            Head_Form_FL();
        end;
     else
       if (rs.value("t_iis") == "X")
            Head_Form_IIS();
        else
            Head_Form_FL();
        end;
     end;
   end;

 End;

  Macro SendForm()

  var rs_sel, sel, Eml;

         sel = "select ddp_dep_dbt.t_partyid, t_name, t_value " 
               "from ddp_dep_dbt, dcontact_dbt "
               "where dcontact_dbt.t_partyid = ddp_dep_dbt.t_partyid "
               "and dcontact_dbt.t_contactkind = 5 and dcontact_dbt.t_ismain = 'X' and t_name = " + GODBO + "00" + "";

         rs_sel = RsdRecordSet(RsdCommand(sel));
         rs_sel.moveNext();

         Eml = rs_sel.value("t_value");


   /* Email отправителя из реестра банка */
 
   GetRegistryValue("COMMON\\EMAIL\\MAIL_SMTPSERVER", V_STRING, SMTP_SERVER);
   GetRegistryValue("COMMON\\EMAIL\\MAIL_USERNAME", V_STRING, SMTP_USERNAME);
   GetRegistryValue("COMMON\\EMAIL\\MAIL_PASSWORD", V_STRING, SMTP_PASSWORD);

  var config = SmtpSettings();

  config.SMTP_SERVER      = SMTP_SERVER;
  config.SMTP_SERVER_PORT = SMTP_SERVER_PORT;
  config.SMTP_USERNAME    = SMTP_USERNAME;
  config.SMTP_PASSWORD    = SMTP_PASSWORD;
  config.SMTP_USESSL      = SMTP_USESSL;
  var mail = MailSender(config);

  Var Path_Out_Str = SubStr (StrSubst (PATH_OUT, "\\\\", "\\"),3);
                               
  FileDir =(SubStr (GetCurDir, 1, StrLen(GetCurDir())- 3) + Path_Out_Str);


        if  (StrBrk (NumberDBO,"-") != 0)

            if ((SMTP_SERVER != "") and 
//                (SMTP_USERNAME != "") and 
//                (SMTP_PASSWORD != "") and 
                (Eml != NullVal))
                mail.send("АО Россельхозбанк", Eml, "Уведомления о приеме на обслуживание", "Уведомления о приеме на обслуживание", FileDir + FlNm); 
                statMes = "Сообщение отправлено";
                statsend = 1;
            else
                statMes = "Сообщение сформировано, но не отправлено. Не настроен Email отправителя или получателя";
                statsend = 2;
            end;

          if  (StrBrk (NumberDBO,"/") != 0)
    
            if ((SMTP_SERVER != "") or 
//                (SMTP_USERNAME != "") or 
//                (SMTP_PASSWORD != "") or 
                (Eml != NullVal))
                mail.send("АО Россельхозбанк", Eml, "Уведомления о приеме на обслуживание", "Уведомления о приеме на обслуживание", FileDir + FlNm); 
                statMes = "Сообщение отправлено";
                statsend = 1;
            else
                statMes = "Сообщение сформировано, но не отправлено. Не настроен Email отправителя или получателя";
                statsend = 2;
            end;

          end;

        else
              statMes = "Сообщение сформировано";
              statsend = 3;
        end;

  End;

  Macro ReForm()

  var rs_sel, sel;
  
      sel = "select msg.t_id, msg.t_dlcontrid, msg.t_kind, dim.t_imageid, dim.t_objectid, dim.t_objecttype, t_filename "
            "from ddlcontrmsg_dbt msg, dimgdata_dbt dim, dimage_dbt dig "
            "where lpad (msg.t_id, 34, '0') = dim.t_objectid "
            " and msg.t_kind = 500 "
            " and dim.t_imageid = dig.t_imageid "
            " and msg.t_dlcontrid = " + dlcid + "";

      rs_sel = RsdRecordSet(RsdCommand(sel));
      rs_sel.moveNext();

   if  (rs_sel.value("t_dlcontrid") == dlcid)

      cmd = RSDCommand("delete from dimage_dbt "
                       "where t_imageid = '" + rs_sel.value("t_imageid") + "'");
      cmd.execute();

      cmd = RSDCommand("delete from dimgdata_dbt "
                       "where t_imageid = '" + rs_sel.value("t_imageid") + "' "
                       "and t_objecttype = 208 "
                       "and t_objectid = '" + rs_sel.value("t_objectid") + "'");
      cmd.execute();

      cmd = RSDCommand("delete from ddlcontrmsg_dbt "
                       "where t_dlcontrid = '" + dlcid + "' and t_kind = 500");
      cmd.execute();

//      DelFile(FileDirForm + rs_sel.value("t_filename") + "");   

   end;

      rs_sel.close;

      if (statsend == 1)

          cmd = RSDCommand("insert into ddlcontrmsg_dbt ("
                              "t_dlcontrid,"
                              "t_kind, "
                              "t_createdate, "
                              "t_createtime, "
                              "t_senddate, "
                              "t_sendtime) "
                          "values (" + dlcid + ", 500, to_date ('" + Date + "','dd-mm-yy'), to_date ('" + Time + "','hh24:mi:ss'), to_date ('" + Date + "','dd-mm-yy'), to_date ('" + Time + "','hh24:mi:ss'))");
          cmd.execute();

      elif ((statsend == 2) or (statsend == 3))

          cmd = RSDCommand("insert into ddlcontrmsg_dbt ("
                              "t_dlcontrid,"
                              "t_kind, "
                              "t_createdate, "
                              "t_createtime) "
                          "values (" + dlcid + ", 500, to_date ('" + Date + "','dd-mm-yy'), to_date ('" + Time + "','hh24:mi:ss'))");
          cmd.execute();

      end;

      sel = "select lpad (t_id, 34, '0') t_id "
            "from ddlcontrmsg_dbt "
            "where t_kind = 500 and t_dlcontrid = " + dlcid + "";

      rs_sel = RsdRecordSet(RsdCommand(sel));
      rs_sel.moveNext();

      if (not CopyFile ("$txtFile\\"+ NumDBO + "("+ rs.value("t_namedp") + ")" + ".doc","..\\txtFile\\"+ NumDBO + "("+ rs.value("t_namedp") + ")" + ".doc"))
        println ("Ошибка копирования файла");
      end;


//     Mess =  PATH_OUT + NDBO + "(" + StrSubst (DT, ".", "-") + ")" + StrSubst (TM, ":", "-") + ".doc";
     Mess =  "..\\txtFile\\" + NumDBO + "("+ rs.value("t_namedp") + ")" + ".doc";

     if( not LoadImageObj(Mess, 208, rs_sel.value("t_id"), 1))
            msgbox("К записи о сообщении не удалось прикрепить файл сообщения");
     end;

  End;


  Macro handler()
         
    
   var sel_stat, rs_stat;

      sel_stat = "select ddl.t_dlcontrid "
                 "from ddlcontr_dbt ddl, dsfcontr_dbt dsf, dobjatcor_dbt dob "
                 "where ddl.t_sfcontrid = dsf.t_id "
                 "and lpad (ddl.t_dlcontrid, 34, '0') = dob.t_object "
                 "and dob.t_attrid = 3 "
                 "and dob.t_objecttype = 207 "
                 "and dob.t_groupid = 101 "
                 "and ddl.t_dlcontrid = " + dlcid + "";

      rs_stat = RsdRecordSet(RsdCommand(sel_stat));
      rs_stat.moveNext();



   if  (rs_stat.value("t_dlcontrid") == dlcid)

     select_mes =  "select ddl.t_dlcontrid, t_createdate "
                   "from ddlcontr_dbt ddl, "
                   "dsfcontr_dbt dsf, "
                   "ddlcontrmsg_dbt msg, "
                   "dimgdata_dbt dim, "
                   "dparty_dbt dpy, "
                   "dobjatcor_dbt dob "
                   "where ddl.t_sfcontrid = dsf.t_id "
                   "and ddl.t_dlcontrid = msg.t_dlcontrid "
                   "and msg.t_id = dim.t_objectid "
                   "and msg.t_kind = 500 "
                   "and dim.t_objecttype = 208 "
                   "and LPAD (ddl.t_dlcontrid, 34, '0') = dob.t_object "
                   "and dsf.t_partyid = dpy.t_partyid "
                   "and dob.t_attrid = 3 "
                   "and dob.t_objecttype = 207 "
                   "and dob.t_groupid = 101 "
                   "and ddl.t_dlcontrid = " + dlcid + "";

      rs_mes = RsdRecordSet(RsdCommand(select_mes));
      rs_mes.moveNext();
 
     if (rs_mes.value("t_dlcontrid") != dlcid);
            Head();
            SendForm();
            ReForm();
     end;

   else

     statMes = "Сообщение не сформировано: Статус договора: Обработка незавершена";

   end;

      rs_stat.close;
 
  End;

  Macro run

     handler();

  End;

End;
//---------------------------------------------------------------------------------------


