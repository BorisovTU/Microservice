import oralib, likepy, globals, rsexts, commonutil/*Simanov. Избавляемся от библиотеки, commoninter*/;
import "DlRepForm_h.mac", "dlmisc.mac","globals", Календарь, RSD, RsbDataSet, "or_tpl_h.mac",prnfrm,or_tpl_h, PTInter,rcw;
import RsbFormsInter, "scincfun.mac";

//Сверка данных по фондовому рынку

private macro ChekDataSecur
var Obtemp = CTemplateSXLSX();
Obtemp.OpenTemplate("Report_LimitQuik.xlsx", false);//имя шаблона
Obtemp.SheetChange(1);
var obcsvfile = C_CSVFile(";");
var obcsvfile1 = C_CSVFile(";");
var obcsvfile2 = C_CSVFile(";");
var obcsvfile3 = C_CSVFile(";");
obcsvfile.FileOpen(string(UserNumber)+"ds.txt",true);// цсв таблица
var obtable, obtable1, obtable2, obtable3;
obtable = Obtemp.RegisterTable("bodyline");
obtable1 = Obtemp.RegisterTable("bodyline1");
obtable2 = Obtemp.RegisterTable("bodyline2");
obtable3 = Obtemp.RegisterTable("bodyline3");

// Находим расхождения
InitProgress(8,"","Сверка данных по фондовому рынку");
  //  BegAction(100,"Сверка остатков денежных средствам");
var cmdmoney, cmddepo, cmdfutur, rsmoney, rsdepo, rsfutur;
	cmdmoney = "SELECT lim.t_client_code,                                                     "+
	"                   'T' || lim.t_limit_kind,                                               "+
	"                   lim.t_curr_code,                                                      "+
	"                   lim.t_open_balance,                                                     "+
	"                   qlim.t_open_balance,                                                    "+
	"                   ' ',                                                                 "+
	"                   ' ',                                                                 "+
	"                   lim.t_isblocked                                                     "+
	"              FROM    (SELECT t_firm_id,                                                 "+
	"                              t_tag,                                                     "+
	"                              t_curr_code,                                               "+
	"                              t_client_code,                                             "+
	"                              t_limit_kind,                                              "+
	"                              t_open_balance /* + t_comprevious*/ AS t_open_balance,              "+
	"                              t_leverage,                                                "+
	"                              T_ISBLOCKED                                                "+
	"                         FROM DDL_LIMITCASHSTOCK_dbt                                     "+
	"                        WHERE t_market = 1) lim                                          "+
	"                   LEFT JOIN                                                             "+
	"                      DDL_LIMITCASHSTOCK qlim                                        "+
	"                   ON     lim.t_client_code = qlim.t_client_code                         "+
	"                      AND lim.t_curr_code = qlim.t_curr_code                             "+
	"                      AND lim.t_limit_kind = qlim.t_limit_kind                           "+
	"                      AND lim.t_open_balance <> QLIM.t_open_balance                          "+
	"             WHERE QLIM.t_open_balance IS NOT NULL                                         "+
        "             order by  lim.t_client_code, lim.t_curr_code, lim.t_limit_kind                                ";
	            
	cmdmoney = RSDCommand(cmdmoney);
	rsmoney = RsdRecordset(cmdmoney);
//EndAction;
//BegAction("Выгрузка в файл");
	while (rsmoney.movenext)
		obcsvfile.AddCell("MONEY");
		obcsvfile.AddCell(rsmoney.value(0));
		obcsvfile.AddCell(rsmoney.value(1));
		obcsvfile.AddCell(rsmoney.value(2));
		obcsvfile.AddCell(rsmoney.value(3));
		obcsvfile.AddCell(rsmoney.value(4));
		obcsvfile.AddCell(rsmoney.value(5));
		obcsvfile.AddCell(rsmoney.value(6));
		if (rsmoney.value(7)=="X")
		obcsvfile.AddCell("Классификатор блокировки")
              else 
              obcsvfile.AddCell(" ")
		end;
		if (rsmoney.value(1)=="T0")
		obcsvfile.AddCell(rsmoney.value(3)-rsmoney.value(4))
              else 
              obcsvfile.AddCell(" ")
		end;
              obcsvfile.AddCell(" ");
              obcsvfile.AddCell(" ");
		obcsvfile.addrow();
	end;

	useprogress (1);
//EndAction;
//BegAction("Сверка остатков ценных бумаг");

	cmddepo ="SELECT lim.t_client_code,                                "+
	"                 'T' || lim.t_limit_kind,                         "+
	"                 lim.t_SECCODE,                                   "+
	"                 lim.t_open_balance,                              "+
	"                 qlim.t_open_balance,                             "+
	"                 lim.t_trdaccid,                                  "+
	"                 qlim.t_trdaccid,                                 "+
	"                 lim.T_ISBLOCKED                                  "+
	"            FROM    (SELECT t_firm_id,                            "+
	"                            t_SECCODE,                            "+
	"                            t_client_code,                        "+
	"                            t_limit_kind,                         "+
	"                            t_open_balance,                        "+
	"                            t_TRDACCID,                           "+
	"                            t_isblocked                           "+
	"                       FROM DDL_LIMITSECURITES_DBT                "+
	"                      WHERE t_market = 1) lim                     "+
	"                 LEFT JOIN                                        "+
	"                    DDL_LIMITSECURITES qlim                   "+
	"                 ON     lim.t_client_code = qlim.t_client_code    "+
	"                    AND lim.t_SECCODE = qlim.t_SECCODE            "+
	"                    AND lim.t_limit_kind = qlim.t_limit_kind      "+
	"                    AND lim.t_open_balance <> QLIM.t_open_balance     "+
	"           WHERE QLIM.t_open_balance IS NOT NULL                    "+
        "             order by  lim.t_client_code, lim.t_seccode, lim.t_limit_kind                                ";
	          
	cmddepo = RSDCommand(cmddepo);
	rsdepo = RsdRecordset(cmddepo);
//EndAction;
//BegAction("Выгрузка в файл");

	while (rsdepo.movenext)
		obcsvfile.AddCell("DEPO");
		obcsvfile.AddCell(rsdepo.value(0));
		obcsvfile.AddCell(rsdepo.value(1));
		obcsvfile.AddCell(rsdepo.value(2));
		obcsvfile.AddCell(rsdepo.value(3));
		obcsvfile.AddCell(rsdepo.value(4));
		obcsvfile.AddCell(rsdepo.value(5));
		obcsvfile.AddCell(rsdepo.value(6));
		if (rsdepo.value(7)=="X")
		obcsvfile.AddCell("Классификатор блокировки")
              else 
              obcsvfile.AddCell(" ")
		end;
 		if (rsmoney.value(1)=="T0")
		obcsvfile.AddCell(rsmoney.value(3)-rsmoney.value(4))
              else 
              obcsvfile.AddCell(" ")
		end;
		obcsvfile.AddCell(" ");
              obcsvfile.AddCell(" ");
		obcsvfile.addrow();
	end;

       obcsvfile.AddCell(" ");
	obcsvfile.addrow();
	cmdmoney = null;
	cmddepo  = null;
	rsmoney= null;
	rsdepo= null;
	Obcsvfile.fileclose();

	useprogress (2);

obcsvfile1.FileOpen(string(UserNumber)+"ss.txt",true);// цсв таблица

	//находим то чего нет у нас

     	cmdmoney = "SELECT lim.t_client_code,                                        "+
	"                  'T' || lim.t_limit_kind,                                  "+
	"                  lim.t_curr_code,                                          "+
	"                  lim.t_open_balance,                                          "+
	"                  ' ',                                                     "+
	"                  ' '                                                      "+
	"                        FROM DDL_LIMITCASHSTOCK lim                     "+
	"                        WHERE     NOT EXISTS                                "+
	"                          (SELECT 1                                         "+
	"                             FROM DDL_LIMITCASHSTOCK_dbt lt                 "+
	"                            WHERE     LIM.t_client_code = LT.t_client_code  "+
	"                                  AND LIM.t_curr_code = LT.t_curr_code      "+
	"                                  AND LIM.t_limit_kind = LT.t_limit_kind    "+
	"                            AND lt.t_market = 1)" +
        "             order by  lim.t_client_code, lim.t_curr_code, lim.t_limit_kind                                ";
	cmdmoney = RSDCommand(cmdmoney);
	rsmoney = RsdRecordset(cmdmoney);
	while (rsmoney.movenext)
	    	obcsvfile1.AddCell("MONEY");
	    	obcsvfile1.AddCell(rsmoney.value(0));
		obcsvfile1.AddCell(rsmoney.value(1));
		obcsvfile1.AddCell(rsmoney.value(2));
		obcsvfile1.AddCell(rsmoney.value(3));
		obcsvfile1.AddCell(rsmoney.value(4));
		obcsvfile1.AddCell(rsmoney.value(5));
		obcsvfile1.AddCell(" ");
		obcsvfile1.AddCell(" ");
		obcsvfile1.addrow();
	end; 

        useprogress (3);

     	cmddepo = "SELECT lim.t_client_code,                                           "+
	"                  'T' || lim.t_limit_kind,                                    "+
	"                  lim.t_SECCODE,                                              "+
	"                  lim.t_open_balance,                                         "+
	"                  lim.t_trdaccid,                                             "+
	"                  ' '                                                         "+
	"             FROM DDL_LIMITSECURITES lim                                  "+
	"            WHERE NOT EXISTS                                                  "+
	"                         (SELECT 1                                            "+
	"                            FROM DDL_LIMITSECURITES_dbt lt                    "+
	"                           WHERE     LIM.t_client_code = LT.t_client_code     "+
	"                                 AND LIM.t_SECCODE = LT.t_SECCODE             "+
	"                                 AND LIM.t_limit_kind = LT.t_limit_kind       "+
	"                                 AND lt.t_market = 1)                         "+
        "             order by  lim.t_client_code, lim.t_seccode, lim.t_limit_kind                                ";
	cmddepo = RSDCommand(cmddepo);
	rsdepo = RsdRecordset(cmddepo);
	while (rsdepo.movenext)
		obcsvfile1.AddCell("DEPO");
		obcsvfile1.AddCell(rsdepo.value(0));
		obcsvfile1.AddCell(rsdepo.value(1));
		obcsvfile1.AddCell(rsdepo.value(2));
		obcsvfile1.AddCell(rsdepo.value(3));
		obcsvfile1.AddCell(rsdepo.value(4));
		obcsvfile1.AddCell(rsdepo.value(5));
		obcsvfile1.AddCell(" ");
		obcsvfile1.AddCell(" ");
		obcsvfile1.addrow();
	end;        
	useprogress (4);

	cmdmoney = null;
	cmddepo  = null;
	rsmoney= null;
	rsdepo= null;
	Obcsvfile1.fileclose();

obcsvfile2.FileOpen(string(UserNumber)+"qs.txt",true);// цсв таблица

	//находим то чего нет в файле квик
   	cmdmoney = "SELECT lim.t_client_code,                                           "+
	"                   'T' || lim.t_limit_kind,                                    "+
	"                   lim.t_curr_code,                                            "+
	"                   lim.t_open_balance /* + lim.t_comprevious*/ AS t_open_balance,   "+
	"                   ' ',                                                        "+
	"                   lim.T_ISBLOCKED                                             "+
	"              FROM DDL_LIMITCASHSTOCK_dbt lim                                  "+
	"             WHERE NOT EXISTS                                                  "+
	"                          (SELECT 1                                            "+
	"                             FROM DDL_LIMITCASHSTOCK lt                    "+
	"                            WHERE     LIM.t_client_code = LT.t_client_code     "+
	"                                  AND LIM.t_curr_code = LT.t_curr_code         "+
	"                                  AND LIM.t_limit_kind = LT.t_limit_kind)      "+
	"                   AND lim.t_market = 1 					"+
        "             order by  lim.t_client_code, lim.t_curr_code, lim.t_limit_kind                                ";
	cmdmoney = RSDCommand(cmdmoney);
	rsmoney = RsdRecordset(cmdmoney);
	while (rsmoney.movenext)
	      	obcsvfile2.AddCell("MONEY");
		obcsvfile2.AddCell(rsmoney.value(0));
		obcsvfile2.AddCell(rsmoney.value(1));
		obcsvfile2.AddCell(rsmoney.value(2));
		obcsvfile2.AddCell(rsmoney.value(3));
		obcsvfile2.AddCell(rsmoney.value(4));
		if (rsmoney.value(5)=="X")
		 obcsvfile2.AddCell("Классификатор блокировки")
                else 
                 obcsvfile2.AddCell(" ")
		end;
		obcsvfile2.AddCell(" ");
		obcsvfile2.AddCell(" ");
		obcsvfile2.addrow();
		end;  

	useprogress (5);
      
	cmddepo = "SELECT lim.t_client_code,                                            "+
	"                  'T' || lim.t_limit_kind,                                     "+
	"                  lim.t_SECCODE,                                               "+
	"                  lim.t_open_balance,                                            "+
	"                  lim.t_trdaccid,                                              "+
	"                  lim.T_ISBLOCKED                                     "+
	"             FROM DDL_LIMITSECURITES_DBT lim                                   "+
	"            WHERE NOT EXISTS                                                   "+
	"                         (SELECT 1                                             "+
	"                            FROM DDL_LIMITSECURITES lt                     "+
	"                           WHERE     LIM.t_client_code = LT.t_client_code      "+
	"                                 AND LIM.t_SECCODE = LT.t_SECCODE              "+
	"                                 AND LIM.t_limit_kind = LT.t_limit_kind)       "+
	"                  AND lim.t_market = 1						"+
        "             order by  lim.t_client_code, lim.t_seccode, lim.t_limit_kind                                ";
	cmddepo = RSDCommand(cmddepo);
	rsdepo = RsdRecordset(cmddepo);
	while (rsdepo.movenext)
	      	obcsvfile2.AddCell("DEPO");
		obcsvfile2.AddCell(rsdepo.value(0));
		obcsvfile2.AddCell(rsdepo.value(1));
		obcsvfile2.AddCell(rsdepo.value(2));
		obcsvfile2.AddCell(rsdepo.value(3));
		obcsvfile2.AddCell(rsdepo.value(4));
		if (rsdepo.value(5)=="X")
                   obcsvfile2.AddCell("Классификатор блокировки")
                else 
                   obcsvfile2.AddCell(" ")
		end;
		obcsvfile2.AddCell(" ");
		obcsvfile2.AddCell(" ");
		obcsvfile2.addrow();   
	end;
	obcsvfile2.AddCell(" ");
	obcsvfile2.addrow();

	cmdmoney = null;
	cmddepo  = null;
	rsmoney= null;
	rsdepo= null;  
	Obcsvfile2.fileclose();

        useprogress (6);

	//находим совпадения
obcsvfile3.FileOpen(string(UserNumber)+"is.txt",true);// цсв таблица	
      	cmdmoney = "SELECT lim.t_client_code,                                          "+
      	"                   'T' || lim.t_limit_kind,                                   "+
      	"                   lim.t_curr_code,                                           "+
      	"                   lim.t_open_balance,                                          "+
      	"                   qlim.t_open_balance,                                         "+
      	"                   ' ',                                                      "+
      	"                   ' ',                                                      "+
      	"                   lim.T_ISBLOCKED                                   "+
      	"              FROM    (SELECT t_firm_id,                                      "+
      	"                              t_tag,                                          "+
      	"                              t_curr_code,                                    "+
      	"                              t_client_code,                                  "+
      	"                              t_limit_kind,                                   "+
      	"                              t_open_balance/* + t_comprevious*/ AS t_open_balance,   "+
      	"                              t_leverage,                                     "+
      	"                              t_isblocked                                     "+
      	"                         FROM DDL_LIMITCASHSTOCK_dbt                          "+
      	"                        WHERE t_market = 1) lim                               "+
      	"                   LEFT JOIN                                                  "+
      	"                      DDL_LIMITCASHSTOCK qlim                             "+
      	"                   ON     lim.t_client_code = qlim.t_client_code              "+
      	"                      AND lim.t_curr_code = qlim.t_curr_code                  "+
      	"                      AND lim.t_limit_kind = qlim.t_limit_kind                "+
      	"                      AND lim.t_open_balance = QLIM.t_open_balance                "+
      	"             WHERE QLIM.t_open_balance IS NOT NULL			       "+
        "             order by  lim.t_client_code, lim.t_curr_code, lim.t_limit_kind                                ";
	cmdmoney = RSDCommand(cmdmoney);
	rsmoney = RsdRecordset(cmdmoney);
	while (rsmoney.movenext)
		obcsvfile3.AddCell("MONEY");
		obcsvfile3.AddCell(rsmoney.value(0));
		obcsvfile3.AddCell(rsmoney.value(1));
		obcsvfile3.AddCell(rsmoney.value(2));
		obcsvfile3.AddCell(rsmoney.value(3));
		obcsvfile3.AddCell(rsmoney.value(4));
		obcsvfile3.AddCell(rsmoney.value(5));
		obcsvfile3.AddCell(rsmoney.value(6));
		if (rsmoney.value(7)=="X")
		obcsvfile3.AddCell("Классификатор блокировки")
              else 
              obcsvfile3.AddCell(" ")
		end;
	obcsvfile3.addrow();
	end;

        useprogress (7);

     	cmddepo = "SELECT /*+ index (lim ddl_limitsecurites_dbt_idx3) index (qlim DDL_LIMITSECURITES_idx1)*/ lim.t_client_code,                                "+
	"                  'T' || lim.t_limit_kind,                         "+
	"                  lim.t_SECCODE,                                   "+
	"                  lim.t_open_balance,                                "+
	"                  qlim.t_open_balance,                               "+
	"                  lim.t_trdaccid,                                  "+
	"                  qlim.t_trdaccid,                                 "+
	"                  lim.T_ISBLOCKED                                  "+
	"             FROM     DDL_LIMITSECURITES_DBT lim                   "+
	"                  LEFT JOIN                                        "+
	"                     DDL_LIMITSECURITES qlim                   "+
	"                  ON     lim.t_client_code = qlim.t_client_code    "+
	"                     AND lim.t_SECCODE = qlim.t_SECCODE            "+
	"                     AND lim.t_limit_kind = qlim.t_limit_kind      "+
	"                     AND lim.t_open_balance = QLIM.t_open_balance      "+
	"                    and LIM.T_MARKET = 1                           "+
	"            WHERE QLIM.t_open_balance IS NOT NULL "+
        "             order by  lim.t_client_code, lim.t_seccode, lim.t_limit_kind                                ";
       var co = SQL_GetNRecs(cmddepo);
	cmddepo = RSDCommand(cmddepo);
	rsdepo = RsdRecordset(cmddepo);
	var j = 1;
	InitProgressBar(co,"Заполнение файла отчета");
	while (rsdepo.movenext)
		obcsvfile3.AddCell("DEPO");
		obcsvfile3.AddCell(rsdepo.value(0));
		obcsvfile3.AddCell(rsdepo.value(1));
		obcsvfile3.AddCell(rsdepo.value(2));
		obcsvfile3.AddCell(rsdepo.value(3));
		obcsvfile3.AddCell(rsdepo.value(4));
		obcsvfile3.AddCell(rsdepo.value(5));
		obcsvfile3.AddCell(rsdepo.value(6));
		if (rsdepo.value(7)=="X")
		obcsvfile3.AddCell("Классификатор блокировки")
              else 
              obcsvfile3.AddCell(" ")
		end;
		obcsvfile3.addrow();
	UseProgress(j=j+1);	
	end;
	 RemProgress;
	obcsvfile3.AddCell(" ");
	obcsvfile3.addrow();

	cmdmoney = null;
	cmddepo  = null;
	rsmoney= null;
	rsdepo= null;
      Obcsvfile3.fileclose();

	useprogress (8);

	Obtemp.SetValue_NameCell("Date", {curdate});
      	Obtemp.SetValue_NameCell("bodyline");
	obtable.FillTabelFromCSV(string(UserNumber)+"ds.txt",NULL,";");
	Obtemp.SetValue_NameCell("bodyline1");
	obtable1.FillTabelFromCSV(string(UserNumber)+"qs.txt",NULL,";");
	Obtemp.SetValue_NameCell("bodyline2");
       obtable2.FillTabelFromCSV(string(UserNumber)+"ss.txt",NULL,";");
	Obtemp.SetValue_NameCell("bodyline3");
	obtable3.FillTabelFromCSV(string(UserNumber)+"is.txt",NULL,";");
        var dt = String({curdate});
        dt = StrSubst(dt, " ", "0");
        dt = StrSubst(dt, ".", "");
        dt = "QuikLimitsSecur" + dt;
	Obtemp.SaveAsTemplate(dt,TRUE);
        Obtemp.Close();
        RemProgress(8)
end;

//Сверка данных по срочному рынку

private macro ChekDataFutur
var Obtemp = CTemplateSXLSX();
Obtemp.OpenTemplate("Report_LimitQuik.xlsx", false);//имя шаблона
Obtemp.SheetChange(1);
var obcsvfile = C_CSVFile(";");
var obcsvfile1 = C_CSVFile(";");
var obcsvfile2 = C_CSVFile(";");
var obcsvfile3 = C_CSVFile(";");
obcsvfile.FileOpen(string(UserNumber)+"df.txt",true);// цсв таблица
var obtable, obtable1, obtable2, obtable3;
obtable = Obtemp.RegisterTable("bodyline");
obtable1 = Obtemp.RegisterTable("bodyline1");
obtable2 = Obtemp.RegisterTable("bodyline2");
obtable3 = Obtemp.RegisterTable("bodyline3");

// Находим расхождения
InitProgress(4,"","Сверка данных по срочному рынку");

var cmdfutur,rsfutur;
	cmdfutur = "SELECT lim.t_client,                               "+
	"                   ' ',                                      "+
	"                   ' ',                                      "+
	"                   lim.T_VOLUMEMN,                            "+
	"                   qlim.T_VOLUMEMN,                           "+
	"                   lim.T_ACCOUNT,                             "+
	"                   qlim.t_account,                            "+
	"                   lim.T_ISBLOCKED,                   "+
	"                   ' '                                       "+
	"              FROM     DDL_LIMITFUTURMARK_DBT lim             "+
	"                   LEFT JOIN                                  "+
	"                      DDL_LIMITFUTURMARK_tmp qlim             "+
	"                   ON lim.T_ACCOUNT = qlim.T_ACCOUNT          "+
	"                      AND lim.T_VOLUMEMN <> QLIM.T_VOLUMEMN   "+
        "             WHERE QLIM.T_VOLUMEMN IS NOT NULL                ";
	cmdfutur = RSDCommand(cmdfutur);
	rsfutur = RsdRecordset(cmdfutur);
	while (rsfutur.movenext)
		obcsvfile.AddCell("SPBFUT");
		obcsvfile.AddCell(rsfutur.value(0));
		obcsvfile.AddCell(rsfutur.value(1));
		obcsvfile.AddCell(rsfutur.value(2));
		obcsvfile.AddCell(rsfutur.value(3));
		obcsvfile.AddCell(rsfutur.value(4));
		obcsvfile.AddCell(rsfutur.value(5));
		obcsvfile.AddCell(rsfutur.value(6));
		if (rsfutur.value(7)=="X")
		obcsvfile.AddCell("Классификатор блокировки")
              else 
              obcsvfile.AddCell(" ")
		end;
		obcsvfile.AddCell(rsfutur.value(8));
		obcsvfile.addrow();
	end;
	cmdfutur = null;
	rsfutur	= null;
	obcsvfile.AddCell(" ");
	obcsvfile.addrow();
	Obcsvfile.fileclose();

	useprogress (1);	

	obcsvfile1.FileOpen(string(UserNumber)+"sf.txt",true);// цсв таблица

	//находим то чего нет у нас

	cmdfutur = "SELECT ' ',                                    "+
	"                   ' ',                                   "+
	"                   ' ',                                   "+
	"                   lim.T_VOLUMEMN,                         "+
	"                   lim.T_ACCOUNT,                          "+
	"                   ' '                                     "+
	"              FROM DDL_LIMITFUTURMARK_tmp lim              "+
	"             WHERE NOT EXISTS                              "+
	"                      (SELECT 1                            "+
	"                         FROM DDL_LIMITFUTURMARK_dbt lt    "+
	"                        WHERE lim.T_ACCOUNT = lt.T_ACCOUNT)";
	cmdfutur = RSDCommand(cmdfutur);
	rsfutur = RsdRecordset(cmdfutur);
	while (rsfutur.movenext)
		obcsvfile1.AddCell("SPBFUT");
		obcsvfile1.AddCell(rsfutur.value(0));
		obcsvfile1.AddCell(rsfutur.value(1));
		obcsvfile1.AddCell(rsfutur.value(2));
		obcsvfile1.AddCell(rsfutur.value(3));
		obcsvfile1.AddCell(rsfutur.value(4));
		obcsvfile1.AddCell(rsfutur.value(5));
		obcsvfile1.AddCell(" ");
		obcsvfile1.AddCell(" ");
		obcsvfile1.addrow();
	end;
	obcsvfile1.addrow();
	cmdfutur = null;
	rsfutur	= null;
	Obcsvfile1.fileclose();

	useprogress (2);

	obcsvfile2.FileOpen(string(UserNumber)+"qf.txt",true);// цсв таблица

	//находим то чего нет в файле квик

	cmdfutur = "SELECT lim.t_client,                                 "+
	"                   ' ',                                        "+
	"                   ' ',                                        "+
	"                   lim.T_VOLUMEMN,                              "+
	"                   lim.T_ACCOUNT,                               "+
	"                   lim.T_ISBLOCKED                     "+
	"              FROM DDL_LIMITFUTURMARK_DBT lim                   "+
	"             WHERE NOT EXISTS                                   "+
	"                      (SELECT 1                                 "+
	"                         FROM DDL_LIMITFUTURMARK_tmp lt         "+
	"                        WHERE lim.T_ACCOUNT = lt.T_ACCOUNT)     ";
	cmdfutur = RSDCommand(cmdfutur);
	rsfutur = RsdRecordset(cmdfutur);
	while (rsfutur.movenext)
		obcsvfile2.AddCell("SPBFUT");
		obcsvfile2.AddCell(rsfutur.value(0));
		obcsvfile2.AddCell(rsfutur.value(1));
		obcsvfile2.AddCell(rsfutur.value(2));
		obcsvfile2.AddCell(rsfutur.value(3));
		obcsvfile2.AddCell(rsfutur.value(4));
		if (rsfutur.value(5)=="X")
		obcsvfile2.AddCell("Классификатор блокировки")
              else 
              obcsvfile2.AddCell(" ")
		end;
		obcsvfile2.AddCell(" ");
		obcsvfile2.AddCell(" ");
		obcsvfile2.addrow();
	end;
	obcsvfile2.AddCell(" ");
	obcsvfile2.addrow();
	cmdfutur = null;
	rsfutur	= null;
	Obcsvfile2.fileclose();

	useprogress (3);

	//находим совпадения

obcsvfile3.FileOpen(string(UserNumber)+"if.txt",true);// цсв таблица	
	cmdfutur = "SELECT lim.t_client,                                                              "+
	"                   ' ',                                                                     "+
	"                   ' ',                                                                     "+
	"                   lim.T_VOLUMEMN,                                                           "+
	"                   qlim.T_VOLUMEMN,                                                          "+
	"                   lim.T_ACCOUNT,                                                            "+
	"                   qlim.t_account,                                                           "+
	"                   lim.T_ISBLOCKED                                                  "+
	"              FROM    (SELECT t_client,                                                      "+
	"                              T_ACCOUNT,                                                     "+
	"                              T_VOLUMEMN,                                                    "+
	"                              t_isblocked                                                    "+
	"                         FROM DDL_LIMITFUTURMARK_DBT) lim                                    "+
	"                   LEFT JOIN                                                                 "+
	"                      DDL_LIMITFUTURMARK_tmp qlim                                            "+
	"                   ON lim.T_ACCOUNT = qlim.T_ACCOUNT AND lim.T_VOLUMEMN = QLIM.T_VOLUMEMN    "+
	"             WHERE QLIM.T_VOLUMEMN IS NOT NULL						      ";
	cmdfutur = RSDCommand(cmdfutur);
	rsfutur = RsdRecordset(cmdfutur);
	while (rsfutur.movenext)
		obcsvfile3.AddCell("SPBFUT");
		obcsvfile3.AddCell(rsfutur.value(0));
		obcsvfile3.AddCell(rsfutur.value(1));
		obcsvfile3.AddCell(rsfutur.value(2));
		obcsvfile3.AddCell(rsfutur.value(3));
		obcsvfile3.AddCell(rsfutur.value(4));
		obcsvfile3.AddCell(rsfutur.value(5));
		obcsvfile3.AddCell(rsfutur.value(6));
		if (rsfutur.value(7)=="X")
		obcsvfile3.AddCell("Классификатор блокировки")
              else 
              obcsvfile3.AddCell(" ")
		end;
		obcsvfile3.addrow();
	end;
	obcsvfile3.AddCell(" ");
	obcsvfile3.addrow();
    Obcsvfile3.fileclose();

	useprogress (4);
	
	Obtemp.SetValue_NameCell("Date", {curdate});
	Obtemp.SetValue_NameCell("bodyline");
	obtable.FillTabelFromCSV(string(UserNumber)+"df.txt",NULL,";");
      	Obtemp.SetValue_NameCell("bodyline1");
	obtable1.FillTabelFromCSV(string(UserNumber)+"qf.txt",NULL,";");
	Obtemp.SetValue_NameCell("bodyline2");
	obtable2.FillTabelFromCSV(string(UserNumber)+"sf.txt",NULL,";");
	Obtemp.SetValue_NameCell("bodyline3");
	obtable3.FillTabelFromCSV(string(UserNumber)+"if.txt",NULL,";");
       var dt = String({curdate});
       dt = StrSubst(dt, " ", "0");
       dt = StrSubst(dt, ".", "");
       dt = "QuiklimitsFutur" + dt;
	Obtemp.SaveAsTemplate(dt,TRUE);
        Obtemp.Close();
	RemProgress(8);	
end;

//Загрузка данных по фондовому рынку

Macro loadDataSecur
var FIRM_ID = "";
var TAG = "";
var CURR_CODE = "";
var CLIENT_CODE = "";
var LIMIT_KIND = "";
var OPEN_BALANCE = "";
var OPEN_LIMIT = "";
var LEVERAGE = "";
var SECCODE = "";
var TRDACCID = "";

   Var folder;
   var cmddel= "truncate table DDL_LIMITSECURITES";
   cmddel = RSDCommand(cmddel);
   cmddel.execute; 
      var cmddel2= "truncate table DDL_LIMITCASHSTOCK";
   cmddel2 = RSDCommand(cmddel2);
   cmddel2.execute; 

   InitProgress(-1,"","Загрузка файла QUIK по фондовому рынку");
	getregistryvalue("РСХБ\\ДИРЕКТОРИИ\\QUIK_IN", V_STRING, folder );
    file Quik () txt;
    
    Var d1 = TDirList (mergeFile (folder , "*.lim"), "F"),
        line;

    if ( d1.count < 1 )
        msgbox ("В указанной папке не обнаружено файлов Quik");
        RemProgress(1);
        return 1;
    end;

    if ( not (open (Quik, mergeFile (folder, d1.name (0)))) )
        msgbox ("Не удалось открыть файл данных");
        RemProgress(1);
        return 1;
    end;
var name, ext;
    name =  mergeFile (folder, d1.name (0));
    setDelIm (strFor (59));
    line = 1;
    //BegAction(100,"Загрузка файла");
    while ( next (Quik) )
	   if (substr(Quik(0), 1, 5) == "MONEY")
		 FIRM_ID = strsubst(strsubst(strsubst(Quik(0)," ","")," ",""),"MONEY:FIRM_ID=","");
		 TAG = strsubst(strsubst(Quik(1)," ",""),"TAG=","");
		 CURR_CODE = strsubst(strsubst(Quik(2)," ",""),"CURR_CODE=","");
		 CLIENT_CODE = strsubst(strsubst(Quik(3)," ",""),"CLIENT_CODE=","");
		 LIMIT_KIND = strsubst(strsubst(strsubst(Quik(4)," ",""),"LIMIT_KIND=",""), ",",".");  
		 OPEN_BALANCE = strsubst(strsubst(strsubst(Quik(5)," ",""),"OPEN_BALANCE=",""), ",", ".");
		 OPEN_LIMIT = strsubst(strsubst(strsubst(Quik(6)," ",""),"OPEN_LIMIT=",""),",",".");
		 LEVERAGE = strsubst( strsubst(strsubst(Quik(7)," ",""),"LEVERAGE=",""), ",", ".");

         execSql ("insert into DDL_LIMITCASHSTOCK values (:0, :1, :2, :3, TO_NUMBER(:4), TO_NUMBER(:5), TO_NUMBER(:6), TO_NUMBER(:7))",
               makeArray (sqlParam ("0", FIRM_ID), sqlParam ("1", TAG), sqlParam ("2", CURR_CODE), sqlParam ("3", CLIENT_CODE), 
                            sqlParam ("4", LIMIT_KIND),   sqlParam ("5", OPEN_BALANCE), sqlParam ("6", OPEN_LIMIT), sqlParam ("7", LEVERAGE)));
	   elif (substr(Quik(0), 1, 4) == "DEPO")

	         FIRM_ID = strsubst(strsubst(strsubst(Quik(0)," ","")," ",""),"DEPO:FIRM_ID=","");
		 SECCODE = strsubst(strsubst(Quik(1)," ",""),"SECCODE=","");
		 CLIENT_CODE = strsubst(strsubst(Quik(2)," ",""),"CLIENT_CODE=","");
		 LIMIT_KIND =  strsubst(strsubst(strsubst(Quik(3)," ",""),"LIMIT_KIND=",""), ",",".");
		 OPEN_BALANCE =  strsubst(strsubst(strsubst(Quik(4)," ",""),"OPEN_BALANCE=",""), ",", ".");
		 OPEN_LIMIT = strsubst(strsubst(strsubst(Quik(5)," ",""),"OPEN_LIMIT=",""),",",".");
		 TRDACCID = strsubst(strsubst(Quik(6)," ",""),"TRDACCID=","");
		 execSql ("insert into DDL_LIMITSECURITES values (:0, :1, :2,TO_NUMBER(:3), TO_NUMBER(:4), TO_NUMBER(:5), :6)",
               makeArray (sqlParam ("0", FIRM_ID), sqlParam ("1", SECCODE), sqlParam ("2", CLIENT_CODE), sqlParam ("3", LIMIT_KIND), 
                            sqlParam ("4", OPEN_BALANCE),   sqlParam ("5", OPEN_LIMIT), sqlParam ("6", TRDACCID)));
       end;
    end;
   EndAction;
   close(Quik);
   UseProgress(1);
   RemProgress(1);
   ChekDataSecur;
   copyfile( mergeFile (folder, d1.name (0)), folder  + "\\archin\\"+d1.name (0) );
   removefile(mergeFile (folder, d1.name (0)));
   //cmddel2.execute; 
   //cmddel.execute;
   return 0;
End;

//загрузка данных по срочному рынку

macro LoadDataFutur
var CLASS_CODE = "";
var FIRM_ID = "";
var ACCOUNT = "";
var VOLUMEMN = "";
var VOLUMEPL = "";
var KFL = "";
var KGO = "";
var USE_KGO = "";
Var folder;
    UseProgress(1);
    getregistryvalue("РСХБ\\ДИРЕКТОРИИ\\QUIK_IN", V_STRING, folder );
	
    file Quik () txt;
    Var d1 = TDirList (mergeFile (folder, "*.fli"), "F"),
        line;

    if ( d1.count < 1 )
        msgbox ("В указанной папке не обнаружено файлов Quik");
        RemProgress(1);
        return 1;
    end;

    if ( not (open (Quik, mergeFile (folder, d1.name (0)))) )
        msgbox ("Не удалось открыть файл данных");
        RemProgress(1);
        return 1;
    end;

    setDelIm (strFor (59));
	 while ( next (Quik) )
	     CLASS_CODE = strsubst(Quik(0),"CLASS_CODE=","");
		 FIRM_ID = strsubst(Quik(1),"FIRM_ID=","");
		 ACCOUNT = strsubst(Quik(2),"ACCOUNT=","");
		 VOLUMEMN = strsubst(strsubst(Quik(3),"VOLUMEMN=",""), ",", ".");
		 VOLUMEPL = strsubst(strsubst(Quik(4),"VOLUMEPL=",""), ",", ".");
		 KFL = strsubst(Quik(5),"KFL=","");
		 KGO = strsubst(Quik(6),"KGO=","");
		 USE_KGO = strsubst(Quik(7),"USE_KGO=","");
         execSql ("insert into DDL_LIMITFUTURMARK_tmp values (:0, :1, :2,TO_NUMBER(:3), TO_NUMBER(:4), :5, :6, :7)",
               makeArray (sqlParam ("0", CLASS_CODE), sqlParam ("1", FIRM_ID), sqlParam ("2", ACCOUNT), sqlParam ("3", VOLUMEMN), 
                            sqlParam ("4", VOLUMEPL),   sqlParam ("5", KFL), sqlParam ("6", KGO), sqlParam ("7", USE_KGO)));
	end;   
   close(Quik);
   UseProgress(1);
   RemProgress(1);
   ChekDataFutur();
   copyfile( mergeFile (folder, d1.name (0)), folder  + "\\archIn\\"+d1.name (0) );
   removefile(mergeFile (folder, d1.name (0)));
	return 0;
end;

class (TRsbPanel) PanelWithCheckbox
initTRsbPanel();
Caption = "Сверка лимитов QUIK";
Status = "~ESC~Выход ~F2~Выполнить";
setSize(25,8);
setPosition(50,10);
var futur, secur;
secur = TRsbCheckbox;
secur.setPosition(4,2);
secur.name = "Фондовый рынок";
 
addControl(secur);
var m_Label1:TrsbLabel = TRsbLabel(8,2,"Фондовый рынок");
addLabel (m_Label1);

futur = TRsbCheckbox;
futur.setPosition(4,4);
futur.name = "Срочный рынок";
 
addControl(futur);
var m_Label2:TrsbLabel = TRsbLabel(8,4,"Срочный рынок" );
addLabel (m_Label2);
addEventHandler(RSB_EV_KEY_PRESSED, R2M(this, "onKeyPressed"));

macro OnChecked(RsbEvent:Object)
   if (RsbEvent.id == RSB_EV_CONTROL_CHECKED)
   end;
return true;
end;

macro onKeyPressed(ev)
   if (ev.keycode == 316)
      if (secur.checked)
         LoadDataSecur;
      end;
      if (futur.checked)
         LoadDataFutur;
      end;
   else
      exit(1);
   end;
end;

end;

var myPanel:TRsbPanel = PanelWithCheckBox;
myPanel.run;
//ChekDataSecur;                  
