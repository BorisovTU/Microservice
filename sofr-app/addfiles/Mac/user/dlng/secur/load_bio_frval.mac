/*
*/
import activex, oralib, likepy, BankInter, DVInter, globals, rsd,RsbDataSet, PTInter,CTInter,FIInter, "cb_sql.mac";
import "u_common_email_utils.mac", "dlquery.mac";

private const COL_HEAD= 2, COL_DATA = 3, COL_FI_Head = "Серия облигаций",
              COL_BIO_SSPFI_Value   = 10,
              COL_DateSFBegin       = 3,
              COL_ClientCodeF       = 4,
              COL_Status            = 5,
              COL_DateBeginStatus   = 6,
              COL_DateReclassStatus = 7,
              COL_Notes             = 8;

private const    ISIN_HEAD      = "ISIN",
                 LSIN_HEAD      = "Регистрационный номер выпуска облигаций",
                 FRVAL_HEAD     = "Размер дополнительного дохода на 1 облигацию, рублях",
                 FRVALDATE_HEAD = "Дата определения дополнительного дохода (указывается конкретная дата) ";


private const Print_WellDown = true;              

private const OPEN_DIR = "C:\\*.xls*",
              OPEN_DIALOG_HEADER = "Выберите файл для загрузки справедливой стоимости:";

private const PARTY_ATTR_GROUP_RISKCATEG = 95,
              
              COL_VALUEDATE = 3,
              COL_CPTY      = 6,
              COL_SS        = 16;



//Расположение загружаемого файла
var  reg_path, errcode;
 GetRegistryValue("РСХБ\\ДИРЕКТОРИИ\\БИО_ПФИ", V_STRING, reg_path, errcode );
  if ( errcode != 0 )
    reg_path = "";
  end; 
 reg_path = reg_path + "\\";

 var arch_path;
 GetRegistryValue("РСХБ\\ДИРЕКТОРИИ\\БИО_ПФИ_АРХИВ", V_STRING, arch_path, errcode );
  if ( errcode != 0 )
    arch_path = "";
  end; 
 arch_path = arch_path + "\\";

class FIFRVALDATA()
  var ISIN      : string;
  var LSIN      : string;
  var FRVAL     : money;
  var FRVALDATE : date;  
end;

private macro iif(a,b,c)
    if(a)
        return b;
    else
        return c;
    end;
end;


class Logger()

    macro RepHeader()
       var str;
       str =     "                             Протокол загрузки ДД \n";
       str = str+"\n";
       str = str+"Дата загрузки  : "+date()+"\n";
       str = str+"Время загрузки : "+time()+"\n";
       //toRep1(str);                                                                                                   
       println(str);                                                                                                   
    end;
                                                                                                                                                                     
    macro RepFooter(suc, er, tot)                                                       
       var str = "";
    end;

    macro RepStr(str)
       return println(str);
    end;

end;


//Загрузка данных из Excel
macro OpLoad_BIO_SSPFI()

  var DealID_Excel:string;
  var DealCode:string = "";
  var FullNameFile = "";
  var FileName = "";
  var TermPath = GetCurDir(true) + "\\TxtFile";
  var Userpath = "";
  var DirName = "";
  var ExtName = "";
  var frow = 1;
  var row = 1;
  var sheet, sql, query_insert, query_check, query_update;
  var valuedate:date =  Date(0, 0, 0);
  var ss = $0;
  var str;
  var DealID,FrVal = 0;
  var day = date();
  var ErrStr = "",ErrStat = false,IsOption = false;
  var all = 0,suc = 0, err = 0;
  var log = Logger();
  var StRec;
  var dt = StrSubSt(string(Date()),".","");
  var tm = StrSubSt(string(time()),":","");
  var InfoLogFileName = GetTxtFileName( "load_bio_SS_"+dt+"_"+tm);
  var FIFRVAL = FIFRVALDATA();

  private macro insert_BIO_SSPFI(_FrVal : variant)
    var countrec;
    var fiid;
    var tsql = "select av.* from davoiriss_dbt av where AV.T_ISIN  = ? or av.t_lsin = ?"; 
    var tcmd = RSDCommand(string("Select count(1) countrec  from (", tsql, ")" ));
    tcmd.addparam("isin", rsdbp_in, _FrVal.ISIN);
    tcmd.addparam("lsin", rsdbp_in, _FrVal.LSIN);
    var trs = RSDRecordset(tcmd, rsdval_client, rsdval_static);
    if(trs.movenext())
      countrec = trs.value("countrec");
    end; 
    if(countrec)
      if(countrec == 1)
         tcmd = RSDCommand(tsql);
         tcmd.addparam("isin", rsdbp_in, _FrVal.ISIN);
         tcmd.addparam("lsin", rsdbp_in, _FrVal.LSIN);
         trs = RSDRecordset(tcmd, rsdval_client, rsdval_static);
         if(trs.movenext())
           fiid = trs.value("t_fiid");
         end;
      else
        println("Ценная бумага определена не однозначно"); 
        return 0;
      end;
    else
      println("Ценная бумага не найдена"); 
      return 0;
    end;
    var sql = "select * from dbiofrval_dbt where t_fiid = ? and t_date >= ?";
    var cmd = RSDCommand(sql);
    cmd.addparam("t_fiid", rsdbp_in, fiid );
    cmd.addparam("t_date", rsdbp_in, _FrVal.FRVALDATE);
    var rs  = RSDRecordset(cmd, rsdval_client, rsdval_static);
    if (rs.movenext())
      println("Найдены операции за эту или более позднюю даты. Вставка ДД невозможна.");
      return 0;
    end;

    sql = "INSERT INTO dbiofrval_dbt (T_FIID,T_DATE,T_FAIRVALUE,T_ONEITEMFV,T_CURRENCY) VALUES (?,?,?,?,?)";
    cmd = RSDCommand(sql);
    cmd.addparam("t_fiid", rsdbp_in, fiid );
    cmd.addparam("t_date", rsdbp_in, _FrVal.FRVALDATE);
    cmd.addparam("T_FAIRVALUE", rsdbp_in, 0 );
    cmd.addparam("T_ONEITEMFV", rsdbp_in, _FrVal.FRVAL);
    cmd.addparam("T_CURRENCY", rsdbp_in, 0 );
    cmd.execute();
    
    
  end;




 /*Выбираем файл для обработки*/

  if(not SelectFile(FullNameFile, /*OPEN_DIR*/reg_path, OPEN_DIALOG_HEADER, 0, true))
    MsgBox("Отказ от загрузки");
    return 0;
  end;

  //Отделяем путь файла от имени
  DirName = splitfile(FullNameFile, FileName, ExtName);
  FileName = FileName + ExtName;

  if (not copyfile("$" + DirName + FileName, "$" + TermPath + "\\" + FileName) )
    MsgBox("Ошибка при передаче файла на терминал");
  end;

  /*Открываем файл*/
  BegAction(1, "Обработка файла \"" + TermPath + "\\" + FileName + "\". Ждите...");

  if(not OpenExcelFile(FileName, false, true, TermPath))
    MsgBox("Ошибка открытия файла \"" + TermPath + "\\" + FileName + "\"");
    EndAction(1);
    return 0;
  end;

  sheet = ExcelApplication.Sheets(1);

  SetOutput( InfoLogFileName, true ); //Пишем лог в файл. Начало
  log.RepHeader(date(),time());


  InitProgress(-1);
  while(frow <= 20)
    if((valtype(sheet.cells(frow, COL_HEAD).value) != V_UNDEF) )
      if(StrUpr(sheet.cells(frow, COL_HEAD).value) == StrUpr(ISIN_HEAD))      
         FIFRVAL.ISIN = sheet.cells(frow, COL_DATA).value;
      elif(StrUpr(sheet.cells(frow, COL_HEAD).value) == StrUpr(LSIN_HEAD))      
         FIFRVAL.LSIN = sheet.cells(frow, COL_DATA).value;
      elif(StrUpr(sheet.cells(frow, COL_HEAD).value) == StrUpr(FRVAL_HEAD))      
         FIFRVAL.FRVAL = sheet.cells(frow, COL_DATA).value;
      elif(StrUpr(sheet.cells(frow, COL_HEAD).value) == StrUpr(FRVALDATE_HEAD))      
         FIFRVAL.FRVALDATE = sheet.cells(frow, COL_DATA).value;
      end;
    end;
    frow = frow + 1; 
    UseProgress(frow);
  end;
  Insert_BIO_SSPFI(FIFRVAL);
  log.repstr("Значение СС ПФИ " + FIFRVAL.FRVAL + " на 1 цб для выпуска ISIN:" + FIFRVAL.ISIN + " на дату " + FIFRVAL.FRVALDATE + " загружено");
  RemProgress();
  ExcelApplication.ActiveWorkbook.Close;
  if (not copyfile("$" + DirName + FileName, "$" + arch_path + "\\" + FileName) )
    log.repstr("Ошибка при копировании файла в архив");
  else 
    log.repstr("Исходный файл скопирован в архив: " + arch_path + "\\" + FileName);
  end;

  if (not RemoveFile ("$" + DirName /*+ "\\"*/ + FileName))
    log.repstr("Ошибка при удалении исходного файла");
  end;

  if (not RemoveFile ("$" + TermPath + "\\" + FileName))
    MsgBox("Ошибка удаления файла " + TermPath + "\\" + FileName);
  end;
  SetOutput( NULL, true ); //Пишем лог в файл. Конец
  ViewFile( InfoLogFileName );

onerror()
  if (valtype(ExcelApplication) != V_UNDEF)
    ExcelApplication.ActiveWorkbook.Close;
  end;
  EndAction(1);
End;
OpLoad_BIO_SSPFI();
