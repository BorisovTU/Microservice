/*
$Name:        unRegisteredClient.mac
$Module:      Ценные бумаги
$Description: CHVA отчет о незарегистрированных клиентах BIQ-7033
*/
import oralib, likepy, globals, rsexts;
import "DlRepForm_h.mac", "globals", Календарь, "or_tpl_h.mac", PTInter,BankInter,rcw;
import RsbFormsInter, "scincfun.mac";
import "u_common_email_utils.mac";

var isAuto = false;

// отправка отчета
MACRO SendReport(fileMess,usr_Email, repDateBeg,repDateEnd)
   var Eml, emailText, Subject, v_email_processor;
   var templ_dir;
   var strerr;
   var SendClient =true;
   var statmes;
  
   if (SendClient)
      Eml = usr_Email;
      Subject = "Уведомление о незарегистрированных клиентах!!! ";
      if(repDateBeg == repDateEnd)
         emailText = string("Добрый день!",
                         "\n",
                         "\nНаправляем в Ваш адрес перечень незарегистрированных клиентов на " + repDateBeg ,
                         "\n"
                         );
      else 
         emailText = string("Добрый день!",
                         "\n",
                         "\nНаправляем в Ваш адрес перечень незарегистрированных клиентов за период с  " + repDateBeg  +" по " + repDateEnd,
                         "\n"
                         );
      end;
   end;
   if ((ValType(Eml) == V_UNDEF) or (ValType(Eml) == 26) or (trim(eml) == StrFor(1)))
      statMes = "Сообщение сформировано, но не отправлено. Не задан email";
      msgbox(statmes);
      return;
   end;
    v_email_processor = c_email_proc_env();
   v_email_processor.m_set_msg_head(Subject);
   v_email_processor.m_add_attach_to_list(fileMess);
  
   v_email_processor.m_add_row_to_msg_text(emailText);
   // Сохраняем текст письма для отправки плановой процедурой 
   v_email_processor.m_save_to_submit_grp(16, true);
   v_email_processor.m_save_to_submit_synch();
   // Отправляем все не отправленные письма
   v_email_processor.m_submit_email_synch();

   if(v_email_processor.m_get_error_status())
      statMes = "Сообщение сформировано, но не отправлено: " + v_email_processor.get_service_msg();
   else
      statMes = "Сообщение отправлено";
   end;
END;

MACRO emailGroup()
   var emailArr = tarray();
   var cmd =DL_RSDCommand("SELECT  tbl_addr.t_email "+
                                                            " FROM usr_email_addr_dbt tbl_addr "+
                                                            " WHERE tbl_addr.t_group = 16 " +
                                                            " ORDER BY tbl_addr.t_id ASC");
   var DataSet = cmd.execute();
   while (DataSet.moveNext())
      emailArr[emailArr.size] = DataSet.t_email; 
   end;
   return emailArr;
END;

private macro GetRespDateTimeStr(respDate:Date, respTime:Time):string
  if(respDate == Date(0,0,0))
    return "";
  else
    return string(respDate, respTime)
  end;
end;

macro ChekData(DateBeg : date, DateEnd : date)
  var Rep;
  var sheet = 1;
  var errorcount = 0;
  var filePath;
  var saveDirPath;
  var email = tarray();
  var i:integer = 0;

  const WIDTH_FLD_NUM:integer          = 5;  // № п/п
  const WIDTH_FLD_CONTRNUM:integer     = 25; // Номер договора
  const WIDTH_FLD_CONTRDATE:integer    = 8;  // Дата договора
  const WIDTH_FLD_FIO:integer          = 12; // ФИО клиента
  const WIDTH_FLD_MSGDATETIME:integer  = 10; // Дата/время ответа на сообщение
  const WIDTH_FLD_MSGSTAT:integer      = 8;  // Статус сообщения
  const WIDTH_FLD_MSGSTATDESCR:integer = 20; // Расшифровка статуса
  const WIDTH_FLD_DESCR:integer        = 25; // Текст ошибки

 // Находим отсутствующие договора брокерского обслуживания
  Rep = CMakeReport("┌┬┬┬┬┬┬┬┬┬┬┬┬┐");
  
  Rep.SetDefaultFontName("Times New Roman");
  Rep.SetDefaultFontSize(12);
  Rep.SetFlagShowGrid(true);
  Rep.AddPrintCell("", WIDTH_FLD_NUM, null, "c:ex_FS(b):ex_B()", REP_ELEM_STR);
  Rep.AddPrintCell("Отчет о не зарегистрированных клиентах за " + IIF(DateBeg == DateEnd, string(DateBeg), "период с "+ string(DateBeg) + " по " + string(DateEnd)), WIDTH_FLD_CONTRNUM, null, "w:c:ex_FS(b):ex_B()", REP_ELEM_STR);
  Rep.AddStr(false, TEMPLATE_DEFAULT);

  Rep.AddPrintCell("", WIDTH_FLD_NUM, null, "", REP_ELEM_STR);
  Rep.AddStr(false, TEMPLATE_DEFAULT);

  Rep.AddPrintCell("№ п/п", WIDTH_FLD_NUM, null, "c:ex_B(tblr)", REP_ELEM_STR);
  Rep.AddPrintCell("Номер договора", WIDTH_FLD_CONTRNUM, null, "c:ex_B(tblr)", REP_ELEM_STR);
  Rep.AddPrintCell("Дата договора", WIDTH_FLD_CONTRDATE, null, "w:c:ex_B(tblr)", REP_ELEM_STR);
  Rep.AddPrintCell("ФИО клиента", WIDTH_FLD_FIO, null, "c:ex_B(tblr)", REP_ELEM_STR);
  Rep.AddPrintCell("Дата/время ответа на сообщение", WIDTH_FLD_MSGDATETIME, null, "w:c:ex_B(tblr)", REP_ELEM_STR);
  Rep.AddPrintCell("Статус сообщения", WIDTH_FLD_MSGSTAT, null, "w:c:ex_B(tblr)", REP_ELEM_STR);
  Rep.AddPrintCell("Расшифровка статуса", WIDTH_FLD_MSGSTATDESCR, null, "w:c:ex_B(tblr)", REP_ELEM_STR);
  Rep.AddPrintCell("Текст ошибки", WIDTH_FLD_DESCR, null, "w:c:ex_B(tblr)", REP_ELEM_STR);
  Rep.AddStr(false, TEMPLATE_DEFAULT);

  var cmd = RSDCommand("SELECT CONTR.T_NUMBER, CONTR.T_DATEBEGIN, P.T_SHORTNAME, "+
                             " MSG.T_RESPDATE, MSG.T_RESPTIME, MSG.T_SENDMESSTATE, ST.T_SZNAMEALG T_SENDMESSTATEDESCR, "+
                             " (CASE WHEN t_SendMesState IN ("+DLSENDMESSTATE_ER_CALLREGSERV+", "+DLSENDMESSTATE_ER_CALLSTATSERV+") "+
                                   " THEN (CASE WHEN INSTR(t_RespData, '<MICEX_DOC') > 0 "+ //предполагаем что полноценный ответ
                                              " THEN XMLTYPE(t_RespData).extract('/MICEX_DOC/CLIENTS/@ResMessage').getStringVal() "+

                                              " WHEN INSTR(t_RespData, '<MICEX_ERROR') > 0 "+
                                              " THEN regexp_substr(to_char(t_RespData),'>(.*)<',1,1,'n',1) "+

                                              " WHEN INSTR(t_RespData, '<head><title>') > 0 "+
                                              " THEN regexp_substr(to_char(t_RespData),'<head><title>(.*)</title></head>',1,1,'n',1) "+

                                              " WHEN INSTR(t_RespData, '\"error_description\":') > 0 "+
                                              " THEN JSON_VALUE(t_RespData, '$.error_description') "+

                                              " ELSE TO_CHAR(t_RespData) "+
                                          " END) "+
                                    " ELSE TO_CHAR(t_RespData) "+
                                " END) t_ResMessage "+
                        " FROM DSFCONTR_DBT CONTR, DDLCONTR_DBT DLCONTR, DDLCONTRMSG_DBT MSG, DPARTY_DBT P, DNAMEALG_DBT ST "+
                       " WHERE DLCONTR.T_SFCONTRID = CONTR.T_ID "+
                       "   AND MSG.T_DLCONTRID = DLCONTR.T_DLCONTRID "+
                       "   AND P.T_PARTYID = CONTR.T_PARTYID "+
                       "   AND MSG.T_ISONLINESENDMES = 'X' "+
                       "   AND MSG.T_KIND IN ("+OBJTYPE_DLCONTRMSG_MARKETREG+", "+OBJTYPE_DLCONTRMSG_MPREG+") "+
                       "   AND MSG.T_SENDMESSTATE NOT IN (0, "+DLSENDMESSTATE_SUCCESS+") "+
                       "   AND CONTR.T_DATECLOSE = TO_DATE('01.01.0001', 'DD.MM.YYYY') "+
                       "   AND CONTR.T_DATEBEGIN BETWEEN ? AND ? "+
                       "   AND ST.T_ITYPEALG = 7535 "+ //ALG_DLSENDMESSTATE
                       "   AND ST.T_INUMBERALG = MSG.T_SENDMESSTATE "+
                       " ORDER BY MSG.T_RESPDATE DESC, MSG.T_RESPTIME DESC ");

  cmd.addParam("", RSDBP_IN, DateBeg);
  cmd.addParam("", RSDBP_IN, DateEnd);

  var ds = TRsbDataSet(cmd);

  var n:integer = 1;
  var normal_format = "w:c:ex_FS():ex_B(tblr)";
  var signal_format = "w:c:ex_FS():ex_B(tblr):ex_BC(255)";
  var comment_format = normal_format;

  while (ds.movenext())
    Rep.AddPrintCell(n, WIDTH_FLD_NUM, null, Comment_format, REP_ELEM_STR);
    Rep.AddPrintCell(ds.Number, WIDTH_FLD_CONTRNUM, null, Comment_format, REP_ELEM_STR);
    Rep.AddPrintCell(Date(ds.DateBegin), WIDTH_FLD_CONTRDATE, null, Comment_format, REP_ELEM_STR);
    Rep.AddPrintCell(ds.ShortName, WIDTH_FLD_FIO, null, Comment_format, REP_ELEM_STR);
    Rep.AddPrintCell(GetRespDateTimeStr(ds.RespDate, ds.RespTime), WIDTH_FLD_MSGDATETIME, null, Comment_format, REP_ELEM_STR);
    Rep.AddPrintCell(ds.SendMesState, WIDTH_FLD_MSGSTAT, null, Comment_format, REP_ELEM_STR);
    Rep.AddPrintCell(ds.SendMesStateDescr, WIDTH_FLD_MSGSTATDESCR, null, Comment_format, REP_ELEM_STR);
    Rep.AddPrintCell(ds.ResMessage, WIDTH_FLD_DESCR, null, Comment_format, REP_ELEM_STR);
    Rep.AddStr(false, TEMPLATE_DEFAULT);

    n = n + 1;
  end;


  var CreateDate = date();
  var CreateTime = time();
  var day, mon, year;
  var hour, min, sec;
  DateSplit(CreateDate, day, mon, year);
  TimeSplit(CreateTime, hour, min, sec);

  Rep.PrintWinRep("Отчет");
  Rep.SetZoomType(ZOOM_TYPE_A4L);
  
  var fileNameAfter = "unRegisteredClient" +"_"+string(year)+string(mon:f)+string(day:f)
                                                                                  +"_"+string(hour:f)+string(min:f)+string(sec:f)+SubStr(Rep.Exlusivefilename, StrLen(Rep.Exlusivefilename) - 3);
  fileNameAfter = strSubst(fileNameAfter,".htm",".xls");
  Rep.SetWinRepOutput(1,WINREP_FORMAT_XLS);
 
/* if (isAuto == false)
     Rep.ShowWinRep();/*Нужен для выпуска пользователем напрямую, чтобы отображался на экране*/
 /* Если работаем в трехзвенке - то запускаем отчет на терминале */
  end;*/

  if( Not IsStandAlone() )
   // Если в строке пути есть знак ":" или "\\", то это абсолютный путь
    if( Index(toAnsi(NameDirTerm), ":") OR Index(toAnsi(NameDirTerm), "\\\\") )
      filePath  = SubStr(toAnsi(NameDirTerm), 2);
    else
      filePath = GetCurDir(TRUE)+"\\"+SubStr(toAnsi(NameDirTerm), 2);
    end;
  else
    filePath = Rep.WorkDir + "\\";  
  end;

  var ob, mainbook, mainsize, childbook, ind = 1;
  ob = CDAOMSExcel(null, true);
  ob.Create();
  mainbook = ob.Application.Workbooks.Open(string(filePath+Rep.Exlusivefilename), null, false);

    /*Сохраняем книгу*/
  if(mainbook.SaveAs(filePath + fileNameAfter, WINREP_FORMAT_XLS) == false)
      msgbox("Ошибка при сохранении файла отчета");
  end;

  /*Закрываем книгу*/
  mainbook.Close();
  var saveFilePath = filePath + fileNameAfter;

  if (isAuto == false)
    Rep.ShowWinRep();/*Нужен для выпуска пользователем напрямую, чтобы отображался на экране*/
  /* Если работаем в трехзвенке - то запускаем отчет на терминале */
  end;

  email = emailGroup();
  i = email.size-1 ;
  while ( i  >=0 )  
     SendReport(saveFilePath, email.value(i), DateBeg,DateEnd);
     i = i-1;
  end;
   /*if (not CopyFile(filePath + fileNameAfter,  "..\\Export\\BROK_OUT\\"+fileNameAfter));
            runerror("Ошибка формирования файла отчета", "Не удалось скопировать файл " /*+ FormFilename */+ " в директорию " /*+ string(PATH_OUT, FolderName)*/);
  end;    */

 end; 

CLASS (TRsbPanel) Pan
    initTRsbPanel();

    const K_Enter = 13;
    const K_F3    = 317;
    const K_F2    = 316;

    const BeginCalcDate_ID = 1;

    var curstr = 1;
    Caption = "Незарегистрированные клиенты";
    Status = "~ESC~Выход ~F2~Выполнить";
    setSize(37,5);
    setPosition(30,10);
    var BeginCalcDate, EndCalcDate, dx;
 
    curstr = curstr+1;
    BeginCalcDate = TRsbEditField(V_DATE);
    BeginCalcDate.setPosition(16,curstr);
    BeginCalcDate.setSize(8,1);
    BeginCalcDate.name = "begincalcdate";
    BeginCalcDate.value = {curdate};
    addControl(BeginCalcDate);

    EndCalcDate = TRsbEditField(V_DATE);
    EndCalcDate.setPosition(27,curstr);
    EndCalcDate.setSize(8,1);
    EndCalcDate.name = "endincalcdate";
    EndCalcDate.value = {curdate} ;
    addControl(EndCalcDate);

    var m_LabelCD:TrsbLabel = TRsbLabel(2,curstr,"Даты периода : с");
    addLabel (m_LabelCD);

    var m_LabelT:TrsbLabel = TRsbLabel(25,curstr,"по");
    addLabel (m_LabelT);
 
   addEventHandler(RSB_EV_KEY_PRESSED, R2M(this, "onKeyPressed"));
 
    macro onKeyPressed(ev)
        if (ev.KeyCode == K_F3)
           if (ev.id == BeginCalcDate_ID)
            if (this.focusedControl.name == "begincalcdate")
             BeginCalcDate.value = GetDateByCalendar({CurDate});
             this.redraw; 
            elif  (this.focusedControl.name == "endincalcdate")
             EndCalcDate.value = GetDateByCalendar({CurDate});
             this.redraw; 
            end;
           end;
        elif (ev.KeyCode == K_Enter)
            this.redraw; 
        elif(ev.keyCode == K_F2)
      
        chekdata(BeginCalcDate.value, EndCalcDate.value);
  
        end;
    end; 
END;

var myPanel:TRsbPanel = Pan;

GetCmdLineParm("isAuto",isAuto);
if (isAuto == false)
  myPanel.run;
  exit(1);
else
  ChekData({Curdate}, {Curdate});
end;
