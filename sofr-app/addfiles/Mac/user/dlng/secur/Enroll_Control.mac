/**
  @file: 		mac\user\dlng\secur\Enroll_Control.mac
  @brief: 		Обработчики для планировщика "Операции списания и зачисления денежных средств"

  # changelog
  |date       |author         |tasks                                       |note                                                        
  |-----------|---------------|--------------------------------------------|-------------------------------------------------------------
  |2025.07.24 |Велигжанин А.В.|BOSS-9380_BOSS-10126                        | IsWorkDay( ..., AUTO_CALENDAR_ID )

*/
import cb_sql, "pm_bo_controller.mac";
Import Календарь;

private const SS_RESPONSE_END = 3;
PRIVATE CONST AUTO_CALENDAR_ID = 41;// id календаря автопополнения брокерского счета.

private class c_ssRunResult(p_ProcessState, p_ErrorNumber, p_ErrorText)
   var ProcessState;
   var ErrorNumber;
   var ErrorText;

   private macro init_ssRunResult(p_ProcessState, p_ErrorNumber, p_ErrorText)
      if(ValType(p_ProcessState) != V_UNDEF)
         ProcessState = p_ProcessState;
      end;
      if(ValType(p_ErrorNumber) != V_UNDEF)
         ErrorNumber = p_ErrorNumber;
      end;
      if(ValType(p_ErrorText) != V_UNDEF)
         ErrorText = p_ErrorText;
      end;
   end;

   init_ssRunResult(p_ProcessState, p_ErrorNumber, p_ErrorText);
end;

//Верю, что разработчики будут внимательны и не попытаются вызвать функцию из макроса с названием "enroll" для других типов операций
macro ExecuteControl(paymentid, dockind, errmsg:@string)
  var controller = EnrollMoneyPaymentController(paymentid, dockind);
  var result = controller.Control();
  if (not result) 
    errmsg = controller.GerError();
  end;

  return result;
end;

macro pm_control()
  var errmsg="",ResultSheduler;

   // запускаемся только в рабочий день по календарю 41 
   if ( IsWorkDay(date(), AUTO_CALENDAR_ID) )
      var sql = " select p.t_paymentid from dpmpaym_dbt p where " + 
                 "      p.t_dockind in (5002, 4607) " + /*Зачисления д/с и Буферные зачисления*/
                 "  and P.T_PURPOSE = 100 " +     /*Возврат д/с*/
                 "  and p.t_paymstatus = 3000 ";  /* Готов к отправке*/

      var Dt = TRsbDataSet(sql);
      while (Dt.movenext())
        ExecuteControl( dt.paymentid, 450, @errmsg);
      end;
   end;

   return ResultSheduler = c_ssRunResult(SS_RESPONSE_END);
end;