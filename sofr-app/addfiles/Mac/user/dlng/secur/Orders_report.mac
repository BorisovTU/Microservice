/*
$Name:        orders_report.mac
$Module:      Ядро Securities
$Description: Отчет "Отчет по поручениям клиентов на БО"
*/
import "dlcalcor_form.mac", "sp_class.mac", "vaacc.mac", "mmcateg.mac";
import "u_common_email_utils.mac", "file_archive.mac", oralib, likepy; 

private const SHEET_MAIN = "Отчет по поручениям";
private const SHEET_SUM = "Консолидация данных";


const CALCOR_RECEIVER_GROUP_ID = 23;


class CDLCalcOrdersParm()

   var BegDate:date;
   var EndDate:date;
   var fiid:integer;
   var ByEmail:bool;
   var IsShowReport:bool;

   macro Init()
	BegDate = ZeroDate;      
	EndDate = ZeroDate;
	fiid = -1;
        ByEmail = true;
        IsShowReport = false; // true при выпуске отчета через интерфейс

   end;

   this.Init();
end;



PRIVATE MACRO GetTxtPath()
  var RegistryPath = "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR";
  var Path = "";
  var stat = 0;

  GetRegistryValue(RegistryPath, V_STRING, Path, stat);
  if(stat) 
     msgbox("Не задана настройка в реестре банка:|", RegistryPath);      
  end;

  return Path;
END;


PRIVATE MACRO GetRepFullPath()
  var Path = "";

    var txtPath = GetTxtPath();
 /*
    if( substr( txtPath, 1, 2 ) == ".." ) /* ссылка на вышестоящий каталог */
      txtPath = substr(txtPath, 3 );
    end;

    if( substr( txtPath, 1, 1 ) == "\\" ) /* ссылка на вышестоящий каталог */
      txtPath = substr(txtPath, 2 );
    end;
   */
    Path = GetCurDir(false) + "\\" + txtPath + "\\"; 

  // получить полный путь
  return Path;
END;



private class CRecData()
   var A01, A02, A03, A04, A05, A06, A07, A08, A09, A10,
       A11, A12, A13, A14, A15, A16, A17, A18, A19, A20,
       A21, A22, A23, A24, A25, A26, A27, A28, A29, A30,
       A31, A32, A33, A34, A35, A36, A37, A38, A39, A40, A41;

   macro Clear()
      A01 = A02 = A03 = A04 = A05 = A06 = A07 = A08 = A09 = A10 =
      A11 = A12 = A13 = A14 = A15 = A16 = A17 = A18 = A19 = A20 = 
      A21 = A22 = A23 = A24 = A25 = A26 = A27 = A28 = A29 = A30 = 
      A31 = A32 = A33 = A34 = A35 = A36 = A37 = A38 = A39 = "";
   end;
end;

private class CRecData2()
   var B01, B02, B03, B04, B05, B06, B07, B08, B09, B10,
       B11, B12, B13;

   macro Clear()
      B01 = B02 = B03 = B04 = B05 = B06 = B07 = B08 = B09 = B10 =
      B11 = B12 = "";
   end;
end;

private class (DL_CReportTemplate) CDLCalcORdersReport( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER )
   private var 
   m_RepParm:CDLCalcOrdersParm,
   m_RS,m_RS2, m_RecNo = 0, m_IsDataExist = false,
   m_RecData:CRecData = CRecData(),
   m_RecData2:CRecData2 = CRecData2(),
   m_FD,
   m_PortfolioSum = $0, m_prevFIID = -1, m_prevPortf = -1;

   macro SetRepParm(RepParm:CDLCalcORdersParm)
      m_RepParm = RepParm;
      SetIsShowAppl(m_RepParm.IsShowReport);
   end;

   macro DataExist()
      return (m_IsDataExist or ReportHasError());
   end;

   macro PrintMode():INTEGER
      return DL_OUTREPORT_EXCEL;
   end;

   Private macro GetCodeClient(DogNum)
      var cmd = DL_RSDCommand(" select mp.t_mpcode mpcode from dsfcontr_dbt sf, dsfcontr_dbt sf2, ddlcontr_dbt dl, ddlcontrmp_dbt mp where sf.t_number = ? and "
                            + " dl.t_sfcontrid = sf.t_id and mp.t_dlcontrid = dl.t_dlcontrid "
                            + " and sf2.t_number like '%'||sf.t_number||'%' and sf2.t_servkind = 1 and sf2.t_servkindsub = 8 "
                            + " and mp.t_sfcontrid = sf2.t_id ");
      
      cmd.addParam(DogNum); 
      var DataSet = cmd.execute();

      If (DataSet.moveNext())
         return DataSet.value("mpcode")
      else 
         return  "";
      end;
      
   end;

   Private macro GetFinCons(DogNum, dt)
      var Fc = "";
      var cmd = DL_RSDCommand(" SELECT lpad(t.t_dlcontrid, 34, '0') t_dlcontrid "
                            + "   FROM ddlcontr_dbt t, dsfcontr_dbt sfcontr "
                            + "  WHERE sfcontr.t_ID = t.t_SfContrID "
                            + "    AND sfcontr.t_number = ? ");

      cmd.addParam(DogNum); 
      var DataSet = cmd.execute();

      If (DataSet.moveNext())
         Fc = ReadNoteForObject(207, DataSet.value("t_dlcontrid"), 150, dt);
      else 
         Fc = "";
      end;
      
      return Fc;
   end;

   Private Macro GetRFSSSP(DogNum, _Rfnum, _RfName, _SSPNum)
       var rfNum = "00", SSPNum = "00", strtmp = "", RFName;
       If(DogNum == "")
          SetParm(2,"");
          SetParm(3,"");
          SetParm(4,"");
          return 0;
       end;

       If(index(DogNum, "-ИИС") !=0)
             DogNum = substr(DogNum, 1,index(DogNum, "-ИИС")-1);
       end;
       If(index(DogNum, "/") !=0)
          rfnum = substr(DogNum, 1,index(DogNum, "/")-1);
          strtmp = substr(DogNum,index(DogNum, "/")+1);
          If(index(strtmp, "-") !=0)
             SSPNum = substr(strtmp,1, index(strtmp, "-")-1);
          else
             SSPNum = "00";
          end;
       else
          If(index(DogNum, "-") !=0)

             RFNum = substr(DogNum,1, index(DogNum, "-")-1);
             SSPNum = "00";
          else
             RfNum = "00";
             SSPNum = "00";
          end;
       end;
       If(RfNum != "00" )
             var cmd = DL_RSDCommand(" select p.t_name from ddp_dep_dbt dep, dparty_dbt p where dep.t_name = ?||'00' "
                                   + " and p.t_partyid = dep.t_partyid ");

             cmd.addParam(RfNum); 
             var DataSet = cmd.execute();

             If (DataSet.moveNext())
                RFName  = DataSet.name;
             else
                RFName = "";
             end;
       end;

       SetParm(2,RfNum);
       SetParm(3,RfName);
       SetParm(4,SSPNum);

   End;

   private macro PrintHeader()
      PrintFormatString( "",
                         "N1_D01", string(m_RepParm.BegDate:f)
                       );
    PrintFormatString("", "N1_D02", string(m_RepParm.EndDate:f));
    PrintFormatString("", "N1_T01", string(Time():f));

   end;

   private macro PrintHeadersum()
      PrintFormatString( "",
                         "N2_D01", string(m_RepParm.BegDate:f)
                       );
      PrintFormatString("", "N2_D02", string(m_RepParm.EndDate:f));

   end;

   private macro BReport()

      SetActiveSheet( SHEET_MAIN );
      PrintHeader();

      RegisterTable( "N1_MainTable", "",
                     "N1_FIO",       "N1_NDOG",      "N1_DDOG",      "N1_FNAME",     "N1_NOM",       "N1_VAL",
                     "N1_RATE",      "N1_KOL",       "N1_DEALT",     "N1_ORDNUM",    "N1_ORDDM",     "N1_ORDTM",
                     "N1_ORDDMSK",   "N1_ORDTMSK",   "N1_NRF",       "N1_NAMERF",    "N1_NSSP",      "N1_NAMESSP",
                     "N1_FIOW",      "N1_DOTMM",     "N1_TOTMM",     "N1_DOTMMSK",   "N1_TOTMMSK",   "N1_OTMFIO",
                     "N1_CLCODE",    "N1_NDOG1",     "N1_DDOG1",     "N1_DOGT",      "N1_ACCOUNT",   "N1_TP",
                     "N1_NRF1",      "N1_NAMERF1",   "N1_NSSP1",     "N1_NAMESSP1",  "N1_FIOW1",     "N1_RESTACC",
                     "N1_ZACH",      "N1_SPIS",      "N1_RESTACC2"
                   );
   end;

   private macro BReport2()

      SetActiveSheet( SHEET_SUM );
      PrintHeadersum();

      RegisterTable( "N2_MainTable", "",
                     "N2_FIO",       "N2_CLCODE",    "N2_NDOG",      "N2_DOGT",      "N2_FNAME",     "N2_KOL",
                     "N2_AMOUNT",    "N1_ACCOUNT",   "N1_RESTACC",   "N1_ZACH",      "N1_SPIS",      "N1_RESTACC2"
                   );
   end;

   private macro EReport()
      EndTable();
//      AddStandardFooter( "N1_", null, true );
   end;

   private macro PrintData()
      PrintTableLine( "N1_FIO",                  m_RecData.A01,      null,
                      "N1_NDOG",                 m_RecData.A02,      null,
                      "N1_DDOG",                 m_RecData.A03,      null,
                      "N1_FNAME",                m_RecData.A04,      null,
                      "N1_NOM",                  m_RecData.A05,      null,
                      "N1_VAL",                  m_RecData.A06,      null,
                      "N1_RATE",                 m_RecData.A07,      null,
                      "N1_KOL",                  m_RecData.A08,      null,
                      "N1_DEALT",                m_RecData.A09,      null,
                      "N1_ORDNUM",               m_RecData.A10,      null,
                      "N1_ORDDM",                m_RecData.A11,      null,
                      "N1_ORDTM",                m_RecData.A12,      null,
                      "N1_ORDDMSK",              m_RecData.A13,      null,
                      "N1_ORDTMSK",              m_RecData.A14,      null,
                      "N1_NRF",                  m_RecData.A15,      null,
                      "N1_NAMERF",               m_RecData.A16,      null,
                      "N1_NSSP",                 m_RecData.A17,      null,
                      "N1_NAMESSP",              m_RecData.A18,      null,
                      "N1_FIOW",                 m_RecData.A19,      null,
                      "N1_DOTMM",                m_RecData.A20,      null,
                      "N1_TOTMM",                m_RecData.A21,      null,
                      "N1_DOTMMSK",              m_RecData.A22,      null,
                      "N1_TOTMMSK",              m_RecData.A23,      null,
                      "N1_OTMFIO",               m_RecData.A24,      null,
                      "N1_CLCODE",               m_RecData.A25,      null,
                      "N1_NDOG1",                m_RecData.A26,      null,
                      "N1_DDOG1",                m_RecData.A27,      null,
                      "N1_DOGT",                 m_RecData.A28,      null,
                      "N1_ACCOUNT",              m_RecData.A29,      null,
                      "N1_TP",                   m_RecData.A30,      null,
                      "N1_NRF1",                 m_RecData.A31,      null,
                      "N1_NAMERF1",              m_RecData.A32,      null,
                      "N1_NSSP1",                m_RecData.A33,      null,
                      "N1_NAMESSP1",             m_RecData.A34,      null,
                      "N1_FIOW1",                m_RecData.A35,      null,
                      "N1_RESTACC",              m_RecData.A36,      null,
                      "N1_ZACH",                 m_RecData.A37,      null,
                      "N1_SPIS",                 m_RecData.A38,      null,
                      "N1_RESTACC2",             m_RecData.A39,      null
                    );
   end;

   private macro PrintData2()
      PrintTableLine( "N2_FIO",                  m_RecData2.B01,      null,
                      "N2_CLCODE",               m_RecData2.B02,      null,
                      "N2_NDOG",                 m_RecData2.B03,      null,
                      "N2_DOGT",                 m_RecData2.B04,      null,
                      "N2_FNAME",                m_RecData2.B05,      null,
                      "N2_KOL",                  m_RecData2.B06,      null,
                      "N2_AMOUNT",               m_RecData2.B07,      null,
                      "N2_ACCOUNT",              m_RecData2.B08,      null,
                      "N2_RESTACC",              m_RecData2.B09,      null,
                      "N2_ZACH",                 m_RecData2.B10,      null,
                      "N2_SPIS",                 m_RecData2.B11,      null,
                      "N2_RESTACC2",             m_RecData2.B12,      null
                    );
   end;


   private macro CollectDataOrders()
      m_RecData.Clear();

      var IsIIS = "", Rfnum = "", RfName = "", SSPNum = "";

      record ФинИн(fininstr);
      record ФинИнВал(fininstr);

      If(Index(m_rs.contrnum, "ИИС") != 0)
         IsIIS = "ИИС";
      else 
         IsIIS = "Брокерское";
      end;

      GetRFSSSP(m_rs.contrnumsofr, Rfnum, RfName, SSPNum);
      ПолучитьФинИн(m_RepParm.fiid,ФинИН);
      ПолучитьФинИн(ФинИН.facevaluefi,ФинИНВал);

      m_RecData.A01 = m_rs.fioclient;
      m_RecData.A02 = m_rs.contrnum;
      m_RecData.A03 = SQL_ConvTypeDate(m_rs.contrdate);

      m_RecData.A04 = m_rs.ficode;
      m_RecData.A05 = ФинИН.facevalue;
      m_RecData.A06 = ФинИНВал.CCY;
      m_RecData.A07 = m_rs.currate;
      m_RecData.A08 = m_rs.principal;
      m_RecData.A09 = m_rs.kinddeal;
      m_RecData.A10 = m_rs.ordernum;
      m_RecData.A11 = SQL_ConvTypeDate(m_rs.filorderdate);

      m_RecData.A12 = Time(m_rs.filordertime);
      m_RecData.A13 = SQL_ConvTypeDate(m_rs.mskorderdate);
      m_RecData.A14 = Time(m_rs.mskordertime);
      m_RecData.A15 = m_rs.rfnum;
      m_RecData.A16 = m_rs.rfname;
      m_RecData.A17 = m_rs.sspnum;
      m_RecData.A18 = m_rs.sspname;
      m_RecData.A19 = m_rs.fioworker;
      m_RecData.A20 = SQL_ConvTypeDate(m_rs.filorderdatecancel);
      m_RecData.A21 = Time(m_rs.filordertimecancel);
      m_RecData.A22 = SQL_ConvTypeDate(m_rs.mskorderdatecancel);
      m_RecData.A23 = Time(m_rs.mskordertimecancel);
      m_RecData.A24 = m_rs.fioworkercancel;

      m_RecData.A25 = GetCodeClient(m_rs.contrnum);
      m_RecData.A26 = m_rs.contrnumsofr;
      m_RecData.A27 = SQL_ConvTypeDate(m_rs.contrdate);
      m_RecData.A28 = IsIIS;
      m_RecData.A29 = m_rs.account;
      m_RecData.A30 = "ММВБ";
      m_RecData.A31 = Rfnum;
      m_RecData.A32 = RfName;
      m_RecData.A33 = SSPNum;
      m_RecData.A34 = "";
      m_RecData.A35 = GetFinCons(m_rs.contrnum, m_RepParm.EndDate);
      m_RecData.A36 = m_rs.BegRestAccount;
      m_RecData.A37 = m_rs.CurZach;
      m_RecData.A38 = m_rs.CurSpis;
      m_RecData.A39 = m_rs.RestAccount;
/*
      m_RecData.A40 = m_rs.A40;
      If(m_rs.A40 <= 0)
         m_RecData.A41 = 0;
      else
         m_RecData.A41 = m_rs.principal;
      end;
*/
   end;

   Private macro GetCurRest(DogNum, ficode, maxnum)
      var cmd = DL_RSDCommand(" select A40 from Usr_ClientsOrders where contrnum = ? and ficode = ? and ordernum = ? ");
      
      cmd.addParam(DogNum);
      cmd.addParam(ficode); 
      cmd.addParam(maxnum); 
 
      var DataSet = cmd.execute();

      If (DataSet.moveNext())
         return DataSet.value("A40")
      else 
         return  0;
      end;
      
   end;


   private macro CollectDataOrdersSUM()
      m_RecData2.Clear();
      var IsIIS = "";
      If(Index(m_rs2.contrnum, "ИИС") != 0)
         IsIIS = "ИИС";
      else 
         IsIIS = "Брокерское";
      end;

      m_RecData2.B01 = m_rs2.fioclient;
      m_RecData2.B02 = GetCodeClient(m_rs2.contrnum);
      m_RecData2.B03 = m_rs2.contrnum;

      m_RecData2.B04 = IsIIS;
      m_RecData2.B05 = m_rs2.ficode;
      m_RecData2.B06 = m_rs2.maxordernum;
      m_RecData2.B07 = m_rs2.sumprincipal;
      m_RecData2.B08 = m_rs2.account;
      m_RecData2.B09 = m_rs2.Begsumrestaccount;
      m_RecData2.B10 = m_rs2.sumCurZach;
      m_RecData2.B11 = m_rs2.sumCurSpis;

      m_RecData2.B12= m_rs2.SumRestAccount;
//      m_RecData2.B13 = GetCurRest(m_rs2.contrnum, m_rs2.ficode, m_rs2.maxordernum);
   end;


   private macro GetSQLOrders()
      return " SELECT * from Usr_ClientsOrders "
             + " where filorderdate >= ? and filorderdate <= ? and curfiid = ? order by fioclient, contrnum, filorderdate, filordertime, ordernum " ;
   end;

   private macro GetSQLOrdersSUM()
      return " SELECT fioclient, contrnum, ficode, sum(principal) sumprincipal, max(ordernum) maxordernum, account, max(Begrestaccount) Begsumrestaccount, max(curZach) sumCurZach, max(curSpis) sumCurSpis, max(restaccount) sumrestaccount from Usr_ClientsOrders "
             + " where filorderdate >= ? and filorderdate <= ? and curfiid = ? group by fioclient, contrnum, ficode, account order by fioclient, contrnum, ficode"; 
   end;        

   private macro PrintOrders()
      var header = "", NRecs = 0, Current = 0, cmd;

      cmd = DL_RSDCommand(GetSQLOrders());
      cmd.addParam(m_RepParm.BegDate);
      cmd.addParam(m_RepParm.EndDate);
      cmd.addParam(m_RepParm.fiid);

      NRecs = cmd.GetCount();

      if( NRecs > 0 )
         m_IsDataExist = true;
         header = "Обработка и печать данных отчета по поручениям";
         m_ProgressIndicator.Start(NRecs, header, header);

         m_RS = cmd.execute();
         while( m_RS.MoveNext() )
            CollectDataOrders();
            PrintData();
            m_RecNo = m_RecNo + 1;
            Current = Current + 1;
            m_ProgressIndicator.Update(Current,NRecs);
         end;
         m_ProgressIndicator.Stop();
      end;
   end;

   private macro PrintOrdersSum()
      var header = "", NRecs = 0, Current = 0, cmd;

      cmd = DL_RSDCommand(GetSQLOrderssum());
      cmd.addParam(m_RepParm.BegDate);
      cmd.addParam(m_RepParm.EndDate);
      cmd.addParam(m_RepParm.fiid);

      NRecs = cmd.GetCount();

      if( NRecs > 0 )
         m_IsDataExist = true;
         header = "Обработка и печать консолидированных данных отчета по поручениям";
         m_ProgressIndicator.Start(NRecs, header, header);

         m_RS2 = cmd.execute();
         while( m_RS2.MoveNext() )
            CollectDataOrderssum();
            PrintData2();
            m_RecNo = m_RecNo + 1;
            Current = Current + 1;
            m_ProgressIndicator.Update(Current,NRecs);
         end;
         m_ProgressIndicator.Stop();
      end;
   end;



   private macro PrintReport()
         PrintOrders();
   end;

   private macro PrintReportSum()
         PrintOrdersSum();
   end;


   private macro Create()
      BReport();
      PrintReport();
      EReport();
      BReport2();
      PrintReportSum();
      EReport();
   end;

   /* Simanov
    * Отправить письмо с вложением
    * attach - путь к прикрепляемому файлу
    * вложение архивируется
    */
   macro Send(tittle:string, message:string, receiverGroupID:integer, attach:string)
      var email = c_email_proc_env();
      var arh_name = attach;
      var FileName, ExtName, DirName;
      VAR SpPath = "", SpFileName = "";
      //Отделяем путь файла от имени
      splitfile(attach, FileName, ExtName);
      FileName = FileName + ExtName;
      DirName = substr(attach, 1, index(attach, FileName) - 1);

      arh_name = StrSubst(arh_name,"$","");
      arh_name = StrSubst(arh_name, ExtName, ".7z");

      email.m_set_msg_head(tittle);
      email.m_add_row_to_msg_text(message);
      

      var arh = c_inarch_kit( arh_name, StrSubst(DirName,"$","") );
      arh.add_file_name(FileName);

      if (not (arh.Add_to_Archive("zip7")))
         msgbox("Ошибка архивирования файла " + FileName);
         return;
      end;
//MsgBox(arh_name);
      SpPath = GetRepFullPath();
      SpFileName = SpPath + StrSubst(FileName, ExtName, ".7z");
      If ( not copyfile("$" + arh_name, SpFileName))
          SpFileName = arh_name;
      end;

      email.m_add_attach_to_list(SpFileName);
      email.m_save_to_submit_grp(receiverGroupID);
      email.m_submit_email_synch();
   End;


   initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode );
end;

// Функция формирования отчета "Отчет по поручениям клиентов"
macro DL_CalcOrders_Report(RepParm:CDLCalcORdersParm, DataFound:@bool)
   var report = CDLCalcORdersReport(null, "Orders_report.xlsx", true, false);
   var reportname = ""; //Simanov
   report.SetRepParm(RepParm);
   report.Run();

   DataFound = report.DataExist();

   Dl_CallInsertStat(report.PrintMode());
   if(report.GetFullReportFileNames().size > 0)
      reportname = report.GetFullReportFileNames()[0];
   end;

   report = null;

   //Simanov. Отправить отчёт по почте
   if (RepParm.ByEmail and (reportname != ""))
      CDLCalcORdersReport.Send("Отчёт по поручениям клиентов на БО с " + RepParm.BegDate + " по " + RepParm.EndDate, //tittle
                           "Данное сообщение отправлено автоматически.", //message
                           CALCOR_RECEIVER_GROUP_ID, //receiverGroupID
                           reportname //attach
                           );
   end;

   return reportname;
end;

private macro GetDLCalcORParm(formReport) : CDLCalcORdersParm
   var prm = CDLCalcORdersParm();

   prm.EndDate = formReport.GetFieldValue(PNFLD_DLCALCOR_ENDDATE);
   prm.BySecur = formReport.GetFieldValue(PNFLD_DLCALCOR_BYSECUR);
   prm.ByBill  = formReport.GetFieldValue(PNFLD_DLCALCOR_BYBILL);
   prm.ByMBK   = formReport.GetFieldValue(PNFLD_DLCALCOR_BYMBK);
   prm.ByEmail = formReport.GetFieldValue(PNFLD_DLCALCOR_BYEMAIL);
   //prm.IsShowReport = true;
   prm.IsShowReport = IIF(prm.ByEmail, false, true);

   return prm;
end;

MACRO ReportRunEx(
  IsWebService    : Bool
 ,FormData      //: CTxReportForm
 ,ReportHashCode  : Integer
 ,menuItem      //: WsMenuItem
)
   var stat = true;
   var formReport = CDLCalcOR_Panel();

   while( stat )
      stat = formReport.Run();
      if( stat )
         DL_CalcORders_Report(GetDLCalcORParm(formReport));
      end;
   end;
END;

