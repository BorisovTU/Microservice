//А.Киселев 08.11.2018
import globals, oralib, likepy, cb_sql, DealsInter, CTInter;
//import "ulmt_to_file.mac", "usr_table_int.mac";
import rsexts;
import "u_common_email_utils.mac";

//private const REG_EXPORT_PATH = "РСХБ\\ИНТЕГРАЦИЯ\\ДИРЕКТОРИИ\\EXPORT\\QUIK_ЛИМИТЫ"; //путь для выгрузки файла
private const REG_EXPORT_PATH = "РСХБ\\ДИРЕКТОРИИ\\QUIK_OUT"; //путь для выгрузки файла
private const REG_EXPORTCOR_PATH = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ДИРЕКТОРИЯ КОРРЕКТИРОВОК QUIK"; //путь для выгрузки файла
private const REG_EXPORTCOR_LIMIT = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ЛИМИТ КОРРЕКТИРОВОК QUIK"; //
private const REG_EXPORTCOR_CUR = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ВАЛЮТЫ К ВЫГРУЗКЕ КОРРЕКТ. QUIK"; //


private class c_sfcontr(ContrID)
   var _sfcontr = TRecHandler("sfcontr");

   macro isBlocked(LimitDate)
      var Dt = TRsbDataSet
      ( " SELECT (CASE WHEN RSB_SECUR.GetGeneralMainObjAttr (207,LPAD (t_DlContrID, 34, '0'),1,"+GetSQLDate(LimitDate)+") = 1 THEN 'X' " + 
        "            ELSE CHR (0) END) IsBlocked                                                                         " +
        "   FROM ddlcontrmp_dbt WHERE t_sfcontrid = " + _sfcontr.rec.id);
      if (Dt.movenext())
         return Dt.IsBlocked;
      end;
      return StrFor(0);
   end;

   macro isExchange()
      if (_sfcontr.rec.servkindsub == 8)
         return true;
      else
         return false;
      end;
   end;

   macro isAccY()
      var note = ReadNoteForObject(659, UniID(_sfcontr,659), 5 /*Счет клиента на ММВБ Фондовый сектор*/);
      if (note != "")
         if (index(note,"Y") == 1)
            return true;
         end;
      end;
      return false
   end;

   macro rec()
      return _sfcontr.rec;
   end;

   /*
   if (_sfcontr.rec.id != 0)
      return _sfcontr.rec;
   end;*/
   var Dt = TRsbDataSet(" select * from dsfcontr_dbt where t_id = " + ContrID);
   if (Dt.movenext())
     Dt.GetRecord.CopyTo(_sfcontr.rec);
     //return _sfcontr.rec;
   end;
end;


private macro GetMicexCode(ContrID)
   var Dt = TRsbDataSet(" select t_mpcode from ddlcontrmp_dbt where t_sfcontrid = " + ContrID);
   if (Dt.movenext())
      return dt.mpcode;
   end;
   return "";
end;

macro NeedCorrLimit( contract )
    var sfcontr = c_sfcontr(contract);

    if (sfcontr.isExchange()        /*только биржевые*/
        and (not sfcontr.isAccY())  /*по договорам в спецдепо не выводим*/
       )
       return true;
    end;

    return false;

end;

private macro AddAttrNPTXOP(rec)
   var CatErr = 0, Dt = TRsbDataSet(" select * from doproper_dbt where t_id_operation = " + rec.t_id_oper);
   if (Dt.movenext())
      AddNoteForObject(131, Dt.documentid, 101, "Выгружено в файл");
      if( (not DisconnectObjAttr( 131, Dt.documentid, 101 )) 
         OR
         (not ConnectObjAttr( CatErr, 131, Dt.DocumentID, 101, 1 )) 
         OR
         (CatErr != 0)
        )
         msgbox("Ошибка при установке категории " );
      end;
    end;

end;


macro LimitCorOut( _Dat, NonDiag ) :integer
   var state :integer = 0,
       errortext :string = "",
       Params :TArray,
       StrPath :string = "",
       ErrCode,
       prev_id_oper = 0,
       limit_rub = $0.0, unload_cur = "", i_lim = $0.0, overlimit = $0.0, unloaded = 0, skipped = 0, s = "", flag = true;

   var v_email_processor, emailText = "", 


   //формируем файл
   //получим значение пути выгрузки из реестра
   GetRegistryValue(REG_EXPORTCOR_PATH, V_STRING, StrPath, ErrCode);
   if( ErrCode > 0 )
      StrPath = "..\\QUIK_EXCHNG\\out";
   end;

   GetRegistryValue(REG_EXPORTCOR_LIMIT, V_DOUBLE, limit_rub, ErrCode);
   if( ErrCode > 0 )
      msgbox("Не установлен лимит для выгрузки RUB. Будут выгружены все корректировки");
      limit_rub = $9999999999999999999999.0;
   end;

   GetRegistryValue(REG_EXPORTCOR_CUR, V_DOUBLE, unload_cur, ErrCode);
   if( ErrCode > 0 )
      unload_cur = "SUR";
   end;

   var dat = date();

   if (ValType(_Dat) != V_UNDEF)
      dat = _Dat;
   else
      if (GetDate(dat, "Введите дату выгружаемых корректировок"))
      end;
   end;

   //var fullfarch = StrPath+"\\limits"+string(dat:f)+".lci";
   MakeDir(string(StrPath));
   MakeDir(string(StrPath+"\\", "Archive"));

   var fullf = StrPath+"\\limits.lci";
   var f = TStreamDoc(fullf, "C");

   
   var sql = " select * from DDL_LIMITADJUST_DBT where t_market = 1 and t_date = "+GetSQLDate(dat)+" /*and t_isblocked <> chr(88)*/ order by t_id_oper, t_client_code, t_curr_code, t_limit_kind";
   var dt = trsbdataset(sql);
   var cnt = 1; 
   initprogress(sql_getnrecs(sql),"Выгрузка в файл", "Выгрузка в файл раздела MONEY: " + fullf);

   while (dt.movenext())

      if (((prev_id_oper == 0) or (prev_id_oper != Dt.Id_Oper)) and (dt.open_balance > 0) and (dt.curr_code == "SUR"))
         i_lim = i_lim + dt.open_balance;
      end;

      if ( (( i_lim <= limit_rub) and (index(unload_cur, dt.curr_code) > 0)) or (dt.open_balance < 0) )
          s = 
            "LIMIT_TYPE = "     +dt.LIMIT_TYPE  + 
          "; LIMIT_ID = "       +dt.LIMITID     +
          "; FIRM_ID = "        +dt.FIRM_ID     +
          "; TAG = "            +dt.tag         +
          "; CURR_CODE = "      +dt.curr_code   +
          "; CLIENT_CODE = "    +dt.client_code +
          "; OPEN_BALANCE = "   +dt.open_balance+
          "; OPEN_LIMIT = "     +dt.open_limit  +
          "; CURRENT_LIMIT = "  +dt.current_limit+
          "; LIMIT_OPERATION = "+dt.limit_operation+
          "; LIMIT_KIND = "     +dt.limit_kind   +
          "; LEVERAGE = "       +dt.leverage    +";";
           if (Dt.isblocked != "X")
              f.WriteLine( s );
              println( s );
           else
              println( "Блокировка: " + s );
           end;
          if ((prev_id_oper == 0) or (prev_id_oper != Dt.Id_Oper))
             AddAttrNPTXOP(Dt);
             unloaded = unloaded + 1;
          end;
      elif((prev_id_oper == 0) or (prev_id_oper != Dt.Id_Oper)) 
         if (flag)
            println("---------------Превышение лимита по зачислениям SUR. Следующее зачисление на " +string(dt.open_balance:a)+ " ---------------");
            flag = false;
         end;
         overlimit = overlimit + dt.open_balance;
         skipped = skipped + 1;
      end;
      prev_id_oper = dt.id_oper;

      useprogress(cnt=cnt+1);
   end;

   remprogress;
   f = null; //по сути commit для файла
   CopyFile("$"+fullf, "$"+StrPath+"\\Archive\\limits"+string(dat:f)+".lci");
   if (overlimit > 0)
      msgbox(fullf +"| Превышен лимит для автоматической выгрузки корректировок на "+overlimit+"| Выгружено: " + unloaded + "	Осталось: "+skipped);
      if (NonDiag)/*безынтерфейсный режим*/
         v_email_processor = c_email_proc_env();

         emailText =
         emailText  + "\n\nПревышен лимит для автоматической выгрузки корректировок на "+overlimit+". \n"
                    + "\n\n"  
                    + "\n Выгружено: " + unloaded + " " 
                    + "\n Осталось: "+skipped;
         v_email_processor.m_add_broker_email_to_list();
         v_email_processor.m_set_msg_head("Превышен лимит выгрузки корректировок!");
         v_email_processor.m_add_row_to_msg_text(emailText);
         v_email_processor.m_save_to_submit_synch();
         v_email_processor.m_submit_email_synch();

      end;
   else
      msgbox(fullf+"| Выгружено: " + unloaded + "	Осталось: "+skipped);
   end;
end;

private macro CreateLimitAdJust(limitadjust)
   var sql = 
        "DECLARE " +
        "   p_LimitAdj             DDL_LIMITADJUST_DBT%ROWTYPE; " +
        "   UnknownDate   CONSTANT DATE := TO_DATE ('01.01.0001', 'DD.MM.YYYY'); " +
        "   UnknownTime   CONSTANT DATE := TO_DATE ('01.01.0001 00:00:00', 'DD.MM.YYYY HH24:MI:SS'); " +
        "BEGIN " +
        "   p_LimitAdj.t_ID              := 0; " +
        "   p_LimitAdj.T_LIMITID         := NVL (:T_LIMITID, 0); " +
        "   p_LimitAdj.T_LIMIT_KIND       := NVL (:T_LIMIT_KIND, 0); " +
        "   p_LimitAdj.T_DATE            := NVL (:T_DATE, UnknownDate); " +
        "   p_LimitAdj.T_TIME            := NVL (:T_TIME, UnknownTime); " +
        "   p_LimitAdj.T_MARKET          := NVL (:T_MARKET, -1); " +
        "   p_LimitAdj.T_CLIENT          := NVL (:T_CLIENT, 0); " +
        "   p_LimitAdj.T_INTERNALACCOUNT := NVL (:T_INTERNALACCOUNT, 0); " +
        "   p_LimitAdj.T_LIMIT_TYPE      := NVL (:T_LIMIT_TYPE, CHR (1)); " +
        "   p_LimitAdj.T_FIRM_ID         := NVL (:T_FIRM_ID, CHR (1)); " +
        "   p_LimitAdj.T_CLIENT_CODE     := NVL (:T_CLIENT_CODE, CHR (1)); " +
        "   p_LimitAdj.T_OPEN_BALANCE    := NVL (:T_OPEN_BALANCE, 0); " +
        "   p_LimitAdj.T_OPEN_LIMIT      := NVL (:T_OPEN_LIMIT, 0); " +
        "   p_LimitAdj.T_CURRENT_LIMIT   := NVL (:T_CURRENT_LIMIT, 0); " +
        "   p_LimitAdj.T_LIMIT_OPERATION := NVL (:T_LIMIT_OPERATION, CHR (1)); " +
        "   p_LimitAdj.T_TRDACCID        := NVL (:T_TRDACCID, CHR (1)); " +
        "   p_LimitAdj.T_SECCODE         := NVL (:T_SECCODE, CHR (1)); " +
        "   p_LimitAdj.T_TAG             := NVL (:T_TAG, CHR (1)); " +
        "   p_LimitAdj.T_CURRID          := NVL (:T_CURRID, -1); " +
        "   p_LimitAdj.T_CURR_CODE       := NVL (:T_CURR_CODE, CHR (1)); " +
//        "   p_LimitAdj.T_LIMIT_KIND      := NVL (:T_LIMIT_KIND, 0); " +
        "   p_LimitAdj.T_LEVERAGE        := NVL (:T_LEVERAGE, 0); " +
        "   p_LimitAdj.T_ID_OPER         := NVL (:T_ID_OPER, 0); " +
        "   p_LimitAdj.T_ID_STEP         := NVL (:T_ID_STEP, 0); " +
        "   p_LimitAdj.T_ISBLOCKED       := NVL (:T_ISBLOCKED, CHR (0)); " +
        " " +
        "   rshb_rsi_sclimit.RSI_CreateLimitAdJust (p_LimitAdj, :p_id_operation, :p_id_step); " +
        "END; " ;

   var cmd = RsdCommand(sql);
       cmd.addParam("T_LIMITID         ",RSDBP_IN, limitadjust.rec.LIMITID        );
       cmd.addParam("T_LIMIT_KIND       ",RSDBP_IN, limitadjust.rec.LIMIT_KIND      );
       cmd.addParam("T_DATE            ",RSDBP_IN, limitadjust.rec.DATE           );
       cmd.addParam("T_TIME            ",RSDBP_IN, limitadjust.rec.TIME           );
       cmd.addParam("T_MARKET          ",RSDBP_IN, limitadjust.rec.MARKET         );
       cmd.addParam("T_CLIENT          ",RSDBP_IN, limitadjust.rec.CLIENT         );
       cmd.addParam("T_INTERNALACCOUNT ",RSDBP_IN, limitadjust.rec.INTERNALACCOUNT);
       cmd.addParam("T_LIMIT_TYPE      ",RSDBP_IN, limitadjust.rec.LIMIT_TYPE     );
       cmd.addParam("T_FIRM_ID         ",RSDBP_IN, limitadjust.rec.FIRM_ID        );
       cmd.addParam("T_CLIENT_CODE     ",RSDBP_IN, limitadjust.rec.CLIENT_CODE    );
       cmd.addParam("T_OPEN_BALANCE    ",RSDBP_IN, limitadjust.rec.OPEN_BALANCE   );
       cmd.addParam("T_OPEN_LIMIT      ",RSDBP_IN, limitadjust.rec.OPEN_LIMIT     );
       cmd.addParam("T_CURRENT_LIMIT   ",RSDBP_IN, limitadjust.rec.CURRENT_LIMIT  );
       cmd.addParam("T_LIMIT_OPERATION ",RSDBP_IN, limitadjust.rec.LIMIT_OPERATION);
       cmd.addParam("T_TRDACCID        ",RSDBP_IN, limitadjust.rec.TRDACCID       );
       cmd.addParam("T_SECCODE         ",RSDBP_IN, limitadjust.rec.SECCODE        );
       cmd.addParam("T_TAG             ",RSDBP_IN, limitadjust.rec.TAG            );
       cmd.addParam("T_CURRID          ",RSDBP_IN, limitadjust.rec.CURRID         );
       cmd.addParam("T_CURR_CODE       ",RSDBP_IN, limitadjust.rec.CURR_CODE      );
//       cmd.addParam("T_LIMIT_KIND      ",RSDBP_IN, limitadjust.rec.LIMIT_KIND     );
       cmd.addParam("T_LEVERAGE        ",RSDBP_IN, limitadjust.rec.LEVERAGE       );
       cmd.addParam("T_ID_OPER         ",RSDBP_IN, limitadjust.rec.ID_OPER        );
       cmd.addParam("T_ID_STEP         ",RSDBP_IN, limitadjust.rec.ID_STEP        );
       cmd.addParam("T_ISBLOCKED       ",RSDBP_IN, limitadjust.rec.ISBLOCKED      );
       cmd.addParam("p_id_operation    ",RSDBP_IN, limitadjust.rec.ID_OPER        );
       cmd.addParam("p_id_step         ",RSDBP_IN, limitadjust.rec.ID_STEP        );
   cmd.Execute();

end;

macro InsertLimitAdjust(ContrId, LimitKind, LimitType, OpenBalance, Fiid, LimitDate, ID_Operation, LimitOperation, err:@string)

  private var limitadjust = TRecHandler("dl_limitadjust.dbt");
  private var _dockind = -1;

  private macro nvl(val, retval)
    if (ValType(Val) == V_UNDEF)
       return retval;
    else
       return val;
    end;
  end;
  private macro iif(val, retval, retval2)
    if (Val)
       return retval;
    else
       return retval2;
    end;
  end;
  private macro GetFiCode(Curr, fi_kind)
     var Dt = TRsbDataSet(" select decode(t_fi_kind,1,decode(t_ccy,'RUB','SUR',t_ccy),t_code) curr_code,  t_fi_kind from dfininstr_dbt f " + 
                          " left join dobjcode_dbt a on a.t_objectid = f.t_fiid and a.t_codekind = 11 and t_objecttype = 9 where t_fiid = " + Curr + 
                          " and t_fi_kind = " + fi_kind );
     if (Dt.movenext())
        return dt.curr_code;
     end;
     return "";
  end;
  private macro GetDocKind(id_operation)
     if (_dockind == -1)
        var Dt = TRsbDataSet(" select t_dockind from doproper_dbt where t_id_operation = " + id_operation);
        if (Dt.Movenext())
           _dockind = Dt.dockind;
        else
           _dockind = 0;
        end;
     end;
     return _dockind;
  end;

  var sfcontr = c_sfcontr(ContrID);

  limitadjust.rec.client_code = GetMicexCode(ContrID);
  if (limitadjust.rec.client_code == "")
     err = "Не удалось получить Код клиента на Бирже. "+sfcontr.rec.number;
     return false;
  end;
  limitadjust.rec.open_balance    = OpenBalance;
  if (LimitKind == "365") 
     limitadjust.rec.Limitid         = ID_Operation*10+3;
  else 
     limitadjust.rec.Limitid         = ID_Operation*10+int(LimitKind);
  end;
  
  limitadjust.rec.limit_kind       = LimitKind;
  limitadjust.rec.limit_Type      = LimitType;
  limitadjust.rec.date            = LimitDate;
  //limitadjust.rec.time          = time();
  limitadjust.rec.market          = 1;
  limitadjust.rec.client          = sfcontr.rec.partyID;
  limitadjust.rec.curr_code       = GetFiCode(Fiid, 1);
  if (( LimitType == "MONEY") and (limitadjust.rec.curr_code == ""))
     err = "Не удалось получить Код валюты. fiid = "+ Fiid;
     return false;
  end;
  limitadjust.rec.currid          = Fiid;
  limitadjust.rec.seccode         = GetFiCode(Fiid, 2);
  if (( LimitType == "DEPO") and (limitadjust.rec.seccode == ""))
     err = "Не удалось получить Код ценной бумаги на МБ. ID инструмента = "+ Fiid;
     return false;
  end;
  limitadjust.rec.Limit_Operation = nvl(LimitOperation,"CORRECT_LIMIT");
  limitadjust.rec.Tag             = "EQTV";
  limitadjust.rec.Firm_ID         = "MC0134700000";
  limitadjust.rec.isBlocked       = sfcontr.IsBlocked(LimitDate);

  if (GetDocKind(ID_Operation) == 4607)
     DL_CreateLimitAdJust(limitadjust);
  else
     limitadjust.rec.id_oper = id_operation;
     limitadjust.rec.id_step = 2;
     CreateLimitAdJust(limitadjust);
  end;

end;


//сервис загрузки лимитов
macro ws_lmt_to_buf( Str_Param :string, fullf:@string, fulls:@string ) :integer
var state :integer = 0,
    errortext :string = "",
    Params :TArray,
    StrPath :string = "",
    ErrCode;


 if( not GetParm(2, Str_Param) )
  Str_Param = "";
 end;


//формируем файл
//получим значение пути выгрузки из реестра
 GetRegistryValue(REG_EXPORT_PATH, V_STRING, StrPath, ErrCode);
 if( ErrCode > 0 )
  StrPath = "..\\QUIK_EXCHNG\\out";
 end;
//получим значение пути выгрузки из реестра


// state = CreateOutputFileLMT(/*"$C:\\RsBank60"*/ StrPath );
//формируем файл
  fullf = StrPath+"\\limit.lim";
  fulls = StrPath+"\\limit.fli";
  var f = TStreamDoc(fullf, "C");
  var s = TStreamDoc(fulls, "C");

/***********************/
/* MONEY */

var sql = " select * from DDL_LIMITCASHSTOCK_DBT where t_market = 1 and t_isblocked <> chr(88) order by t_client_code, t_curr_code, t_limit_kind";
var dt = trsbdataset(sql);
var cnt = 1; 
initprogress(sql_getnrecs(sql),"Выгрузка в файл", "Выгрузка в файл раздела MONEY: " + fullf);

while (dt.movenext())
    f.WriteLine(
   "MONEY:  FIRM_ID = "+dt.firm_id+"; TAG = "+dt.tag+"; CURR_CODE = "+dt.curr_code+"; CLIENT_CODE = "+dt.client_code+"; LIMIT_KIND = "+dt.limit_kind+"; OPEN_BALANCE = "+dt.open_balance+"; OPEN_LIMIT = "+dt.open_limit+"; LEVERAGE = "+dt.leverage+";"
   /*MONEY:  FIRM_ID = MC0134700000; TAG = EQTV; CURR_CODE = SUR; CLIENT_CODE = 40491; LIMIT_KIND = 2; OPEN_BALANCE = 0; OPEN_LIMIT = 0; LEVERAGE = 0;*/
   );
   useprogress(cnt=cnt+1);
end;

remprogress;

/***********************/
/* DEPO */
 sql = " select * from DDL_LIMITSECURITES_DBT where t_market = 1  and t_isblocked <> chr(88) order by t_client_code, t_seccode, t_limit_kind";
 dt = trsbdataset(sql);

 cnt = 1; 
initprogress(sql_getnrecs(sql),"Выгрузка в файл", "Выгрузка в файл раздела DEPO: " + fullf);

while (dt.movenext())
    f.WriteLine(
"DEPO:  FIRM_ID = "+dt.firm_id+"; SECCODE = "+dt.seccode+"; CLIENT_CODE = "+dt.client_code+"; LIMIT_KIND = "+dt.limit_kind+"; OPEN_BALANCE = "+int(dt.open_balance)+"; OPEN_LIMIT = "+int(dt.open_limit)+"; TRDACCID = "+dt.trdaccid+";"
/*DEPO:  FIRM_ID = MC0134700000; SECCODE = RU000A0ZZ4T1; CLIENT_CODE = 48382; LIMIT_KIND = 365; OPEN_BALANCE = 200; OPEN_LIMIT = 0; TRDACCID = L01+00000F00;*/
);

useprogress(cnt=cnt+1);
end;

remprogress;
/***********************/
/* срочный */
 sql = " select * from DDL_LIMITFUTURMARK_DBT /*where t_market = 1*/  where  t_isblocked <> chr(88)  "+ 
       "  and upper (t_ACCOUNT) LIKE '%F502%' AND  ROUND(T_VOLUMEMN,4)<>0                            "+
       "  order by t_class_code, t_account,  t_seccode /*, t_limit_kind*/                            ";
 dt = trsbdataset(sql);

 cnt = 1; 
initprogress(sql_getnrecs(sql),"Выгрузка в файл", "Выгрузка в файл раздела по срочному рынку: " + fulls);

while (dt.movenext())
    s.WriteLine(
//"CLASS_CODE = "+dt.class_code+"; ACCOUNT = "+dt.account+"; VOLUMEMN = "+dt.volumemn+"; VOLUMEPL = "+dt.volumepl+"; KFL = "+dt.kfl+"; KGO = "+dt.kgo+"; USE_KGO = "+dt.use_kgo+"; FIRM_ID = "+dt.firm_id+"; SECCODE = "+dt.seccode+";"
"CLASS_CODE="+dt.class_code+";FIRM_ID="+dt.firm_id+";ACCOUNT="+dt.account+";VOLUMEMN="+dt.volumemn+";VOLUMEPL="+dt.volumepl+";KFL="+trim(string(dt.kfl:15:2))+";KGO="+trim(string(dt.kgo:15:2))+";USE_KGO="+dt.use_kgo+";"// SECCODE = "+dt.seccode+";"
/*CLASS_CODE=SPBFUT;ACCOUNT=;VOLUMEMN=0;VOLUMEPL=0;KFL=1;KGO=1;USE_KGO=Да;FIRM_ID=;SECCODE=;*/
);

useprogress(cnt=cnt+1);
end;

remprogress;


println("Файлы выгружены: \n"+fullf +"\n" + fulls);

return state;

end;
//сервис загрузки лимитов


//сервис загрузки корректировок лимитов
macro ws_lmtchange_to_buf( Str_Param :string ) :integer
var state :integer = 0,
    errortext :string = "",
    Params :TArray,
//    ParamProcess :TParamProcess,
//    ProcessOutTbl :c_usr_tbl_uTableProcessOut,
    StrPath :string = "",
    ErrCode;



 if( not GetParm(2, Str_Param) )
  Str_Param = "";
 end;

 //загрузили буферные таблицы из дистрибутивных
 state = execStoredFunc( "USR_PKG_IMPORT_SOFR.AddInudl_dl_lmtadjust_exch", V_INTEGER );

 if( state != 0 )
  return state;
 end;
 //загрузили буферные таблицы из дистрибутивных


//формируем файл
 Params = Null;
 Params = makeArray( SQLParam("p_Mode", 1), //формируем файл по корректировкам лимитов
                     SQLParam("p_IsDel", 1 ), //удалять ранее сформированный файл с таким именем
                     SQLParam("p_FileName", "lim_chng") );
 state = execStoredFunc( "USR_PKG_IMPORT_SOFR.AddLOBToTMP", V_INTEGER, Params );
 Params = Null;
 if( state != 0 )
  return state;
 end;


//получим значение пути выгрузки из реестра
 GetRegistryValue(REG_EXPORT_PATH, V_STRING, StrPath, ErrCode);
 if( ErrCode > 0 )
  StrPath = "..\\QUIK_EXCHNG\\out";
 end;
//получим значение пути выгрузки из реестра
// state = CreateOutputFileLMT(/*"$C:\\RsBank60"*/ StrPath );
//формируем файл

 if( state != 0 )
  return state;
 end;

 //установка статуса в ProcessOut
 //ParamProcess = Null;
 //ProcessOutTbl = Null;
 /*ParamProcess = TParamProcess( Str_Param + ";2"); //установить статусы 2
 ProcessOutTbl = c_usr_tbl_uTableProcessOut();
 ProcessOutTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
 ProcessOutTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
 ProcessOutTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
 if( not ProcessOutTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
  state = 1;
 end;
 ParamProcess = Null;
 ProcessOutTbl = Null;
 //установка статуса в ProcessOut
 */
 return state;

onError(err)
 Params = Null;
 //ParamProcess = Null;
 //ProcessOutTbl = Null;
 state = 1;
 return state;

end;
//сервис загрузки корректировок лимитов
//ws_lmt_to_buf;
