import RSD;

const K_ENTER   = 13;
const K_ESC     = 27;
const K_F3      = 317;
const K_F8      = 322;
const K_F9      = 323;
// Вспомогательная процедура подготовки информации с атрибутами полей
PRIVATE MACRO AddCol (ar,ind, fld, head, width, rdonly, ty, dp)
   ar.value (ind * 6)     = fld;
   ar.value (ind * 6 + 1) = head;
   ar.value (ind * 6 + 2) = width;
   ar.value (ind * 6 + 3 ) = rdonly;   // fldType
   ar.value (ind * 6 + 4 ) = dp;//   decPoint
   ar.value (ind * 6 + 5 ) = 0;   // reserv
END;

macro ScrollKind

   macro EvProc(rs, cmd, id, key)
   var  CM_DEFAULT = null;
     if ((cmd == DLG_KEY)and(key == K_ENTER))
        if (rs.RecCount > 0)
          return CM_SELECT;
        end;
      end;
     return CM_DEFAULT;
   end;

var cmd1 = " select T_SERVISEKIND as T_ELEMENT, T_NAME as T_NAME from dservkind_dbt where T_SERVISEKIND in(1, 2, 8, 14 , 15, 21)";
cmd1 = RSDCommand(cmd1);
var rs1 = RSDRecordset(cmd1 , null, RSDVAL_STATIC ),Column = TArray(),i, ColumnValue, ColumnName, NumColumns = 0;
var col1 = TArray;                                                                             
AddCol (col1, 0, "T_ELEMENT", "ИД обслуживания", null, true);
AddCol (col1, 1, "T_NAME", "Вид обслуживания",    null, true);
if (RunScroll (rs1,2, col1, "test" ,"EvProc","Виды обслуживания"," ", true, 1, 1))
   return rs1;
end;
return null;

end;


macro ScrollSubKind(Kind)
var cmd2 = "select t_servicekindsub , t_name from dservksub_dbt where t_servicekind  = :data1 and t_servicekindsub in(8, 9)";
cmd2 = RSDCommand(cmd2); 
cmd2.AddParam("Data1", RSDBP_IN,Kind);
var rs2 = RSDRecordset(cmd2 , null, RSDVAL_STATIC ),Column = TArray(),i, ColumnValue, ColumnName, NumColumns = 0;
var col2 = TArray;                                                                             
AddCol (col2, 0, "t_servicekindsub", "ИД", null, true);
AddCol (col2, 1, "T_NAME", "Подвид обслуживания",    null, true);
if (RunScroll (rs2,2, col2, "test" ,"EvProc","Подвиды обслуживания"," ", true, 1, 1))
   return rs2;
end;
return null;
macro EvProc(rs, cmd, id, key)
var  CM_DEFAULT = null;
   if ((cmd == DLG_KEY)and(key == K_ENTER))
     if (rs.RecCount > 0)
       return CM_SELECT;
     end;
   end;
  return CM_DEFAULT;
end;
end;

macro ScrollMon
var cmd2 = "select T_FIID, T_CCY, T_NAME from dfininstr_dbt where T_FI_KIND = 1";
cmd2 = RSDCommand(cmd2); 
var rs2 = RSDRecordset(cmd2 , null, RSDVAL_STATIC ),Column = TArray(),i, ColumnValue, ColumnName, NumColumns = 0;
var col2 = TArray;                                                                             
AddCol (col2, 0, "T_FIID", "ИД", null, true);
AddCol (col2, 1, "T_CCY", "Буквенный код",    null, true);
AddCol (col2, 2, "T_NAME", "Вылюта",    null, true);

if (RunScroll (rs2,3, col2, "test" ,"EvProc","Валюта"," ", true, 1, 1))
   return rs2;
end;
return null;
macro EvProc(rs, cmd, id, key)
var  CM_DEFAULT = null;

   if ((cmd == DLG_KEY)and(key == K_ENTER))
     if (rs.RecCount > 0)
       return CM_SELECT;
     end;
   end;
  return CM_DEFAULT;
end;
end;
      
PRIVATE MACRO Scr_AVR()
 var cmd, rs, query,filter = "", a, n, refresh = true, new_val = -1, total,getval, gtv;   
    /*Обработчик скроллинга*/
macro EvProc (rs, cmd, id, key )
var parm;
     if  (cmd == DLG_KEY)
       if (IsScrollEditMode())
        if( (key == K_F3 ) and ((id ==0) or(id ==1)) )
         Parm = ScrollKind;
          if (Parm != NULL)
            if( GetScrollFieldValue(0, getval ) AND (getval != parm.value("T_ELEMENT")) )
            SetScrollFieldValue(0,parm.value("T_ELEMENT"));
            SetScrollFieldValue(1,parm.value("T_NAME"), 20);
            SetScrollFieldValue(2,0);
	     SetScrollFieldValue(3,"",20);
            end;
          end;
         elif((key == K_F3 ) and ((id ==2)  or(id ==3)))
          GetScrollFieldValue(0, getval );
          parm = ScrollSubKind(getval);
           if (Parm != NULL)
 		if( GetScrollFieldValue(2, getval ) AND (getval != parm.value("t_servicekindsub")) )
		SetScrollFieldValue(2,parm.value("t_servicekindsub"));
		SetScrollFieldValue(3,parm.value("T_NAME"), 20);
              end;
           end;
          elif((key == K_F3 ) and ((id ==4) or(id ==5)))
            parm = ScrollMon;
             if (Parm != NULL)
 		if( GetScrollFieldValue(4, getval ) AND (getval != parm.value("T_FIID")) )
              GetScrollFieldValue(6, gtv );
              SetScrollFieldValue(4,parm.value("T_FIID"));
              SetScrollFieldValue(5,parm.value("T_CCY"), 20);
              SetScrollFieldValue(6,gtv, 20);

		
              end;
           end;
         elif ((key == K_F9 ) or (key==336) or (key==328) or (key ==27)) 
  	    refresh = true; return 2; 
         end;
       end;
     end;
end;      
/******************************************/
/*    точка входа                         */
/******************************************/

   query = 
"      SELECT BRACC.T_SERVKIND AS T_SERVKIND,                       "+
"       val.t_name AS T_SERVKINDid,                                     "+
"       BRACC.T_SERVKINDSUB AS T_SERVKINDSUB,                       "+
"       SUB.T_NAME AS T_SERVKINDSUBid,                                  "+
"       BRACC.T_CURRENCY AS T_CURRENCY,                             "+
"       FI.T_CCY AS T_CURRENCYid,                                       "+
"       BRACC.T_ACCOUNT AS T_ACCOUNT, null                                  "+
"  FROM DBROKACC_DBT BrAcc                                            "+
"       LEFT JOIN dservkind_dbt val                                   "+
"          ON BRACC.T_SERVKIND = VAL.T_SERVISEKIND   "+
"       LEFT JOIN dservksub_dbt sub                                   "+
"          ON     BRACC.T_SERVKIND = SUB.T_SERVICEKIND                "+
"             AND BRACC.T_SERVKINDSUB = SUB.T_SERVICEKINDSUB          "+
"       LEFT JOIN dfininstr_dbt fi ON BRACC.T_CURRENCY = fi.t_fiid";


   a = TArray;
   n = 0;
   AddCol (a, n, "T_SERVKIND"    , "ID"                      ,  5, 5, 2,0);n = n+1;
   AddCol (a, n, "T_servkindid"      , "Вид обслуживания"        , 15, 2, 2,0);n = n+1;
   AddCol (a, n, "T_SERVKINDSUB" , "ID"                      ,  5, 5, 2,0);n = n+1;
   AddCol (a, n, "T_SERVKINDSUBid"   , "Подвид обслуживания"     , 15, 2, 2,0);n = n+1;
   AddCol (a, n, "T_CURRENCY"    , "ID"                      ,  5, 5, 2,0);n = n+1;
   AddCol (a, n, "T_currencyid"      , "Буквенный код валюты"    , 15, 2, 2,0);n = n+1;
   AddCol (a, n, "T_account"       , "Сводный счёт АБС"        , 15, 1, 2,0);n = n+1;
   AddCol (a, n, "null"       , ""        , 2, 1, 2,0);n = n+1;
  
   while (refresh)
      refresh = false;
      //msgbox(CreateFilter());
      cmd = RsdCommand (query );
      rs = RSDRecordset(cmd,RSDVAL_CLIENT, RSDVAL_STATIC );
        /*Задание скрипта обработчика. Используется при вызове rs.Update()*/

      rs.UpdateCommand = RsdCommand    ( "update DBROKACC_DBT         " +
                                                "set {{?,?,?,?}} "+
                                                " where T_ACCOUNT = ? ");
      rs.UpdateCommand.AddUserCmdParam ("",  "T_SERVKIND",    RSDRVER_CHANGE);          
      rs.UpdateCommand.AddUserCmdParam ("",  "T_SERVKINDSUB", RSDRVER_CHANGE);          
      rs.UpdateCommand.AddUserCmdParam ("",  "T_CURRENCY",    RSDRVER_CHANGE);          
      rs.UpdateCommand.AddUserCmdParam ("",  "T_ACCOUNT",     RSDRVER_CHANGE);
      rs.UpdateCommand.AddUserCmdParam ("",  "T_ACCOUNT",     RSDRVER_OLDVAL); 
  
     
      rs.DeleteCommand = RsdCommand    ( "Delete from  DBROKACC_DBT         " +
                                                " where T_ACCOUNT = ? ");
      rs.DeleteCommand.AddUserCmdParam ("",  "T_ACCOUNT",    RSDRVER_OLDVAL);


      rs.InsertCommand = RsdCommand    ( "INSERT INTO DBROKACC_DBT (T_SERVKIND, T_SERVKINDSUB, T_CURRENCY, T_ACCOUNT) " +
                                                "values " + 
                                                "    (?, ?, ?, ?) "); 
      rs.InsertCommand.AddUserCmdParam ("",  "T_SERVKIND",    RSDRVER_NEWVAL);          
      rs.InsertCommand.AddUserCmdParam ("",  "T_SERVKINDSUB", RSDRVER_NEWVAL);          
      rs.InsertCommand.AddUserCmdParam ("",  "T_CURRENCY",    RSDRVER_NEWVAL);          
      rs.InsertCommand.AddUserCmdParam ("",  "T_ACCOUNT",     RSDRVER_NEWVAL);

      rs.autorefresh = true;    
      if (RunScroll (rs, n/*Кол-во столбцов*/, a, "test", "EvProc","Сводные 306е счета","~Enter~ Редактировать ~F9~ Ввод ~F8~ Удаление ~Esc~ Выход", false, 1, 1))
      end;
   end;


END;

Scr_Avr();
exit(1);
end;