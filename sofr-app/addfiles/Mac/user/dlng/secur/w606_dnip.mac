/*
$Name:        w606_dnip.mac
$Module:      Ценные бумаги
$Description: Формирование данных для ЦКРР (долговые не эмиссионные бумаги)
$Programmer:  
*/
import rsd, captureoutput;

macro RecordSetDNIP(dt)
  var cmd;
  /*Чистим и наполняем GT данными*/
  StartCaptureOutput();
  [ 
    declare 
      type Type_W606 is table of DW606_U_TMP%rowtype;
      Coll_W606 Type_W606 := Type_W606();
      dt date := ?;--to_date('01.06.2016','dd.mm.yyyy');
      p_BalanceDate date;
      p_stat number;
      p_DaysInYear number;
      p_DealID      ddl_tick_dbt.t_DealID%TYPE;
      p_Cost        dvsordlnk_dbt.t_BCCost%TYPE;
      p_CostFI      dvsordlnk_dbt.t_BCCFI%TYPE;
      p_DealType    ddl_tick_dbt.t_DealType%TYPE;
      p_DealCode    ddl_tick_dbt.t_DealCode%TYPE;
      p_BOfficeKind ddl_tick_dbt.t_BOfficeKind%TYPE;
      v_t_parentid dobjattr_dbt.t_parentid%type;
    begin
      -- Удаляем данные за дату (если есть)
      delete from DW606_U_TMP where t_TypeFI = 'Неэмиссионная бумага';

      -- Проходим по учтенным векселям
      for v in (select vsbanner.t_bcid t_bcid,
                       vsbanner.t_issuer t_partyid,
                       'Неэмиссионная бумага' TypeFI,
                       case when (select count(1) 
                                  from dpartyown_dbt partyown 
                                  where partyown.t_partyid = vsbanner.t_issuer and 
                                        partyown.t_partykind = 2/*Банком*/) > 0 then 'FINANCIAL' 
                                  else 'CORPORATE' end TypeIssuer, 
                       dt ReportDate,
                       RSI_RSB_FIInstr.ConvSum(vsbanner.t_sum, dl_leg.t_pfi, 0, dt, 1) BalanceDebt, 
                       nvl(fininstr.t_ccy, chr(1)) Currency,
                       case when vsbanner.t_bcseries = chr(1) then trim(vsbanner.t_bcnumeber) 
                            when vsbanner.t_bcnumeber = chr(1) then trim(vsbanner.t_bcseries) 
                            else trim(vsbanner.t_bcseries)||' '||trim(vsbanner.t_bcnumeber) end FIID, 
                       chr(1) ISIN,
                       chr(1) DealID, 
                      (select nvl(max(objcode.t_code),chr(1)) 
                       from dobjcode_dbt objcode 
                       where objcode.t_objecttype = 3 and 
                             objcode.t_codekind = 101/*КОД В БИСКВИТ*/ and
                             objcode.t_objectid = vsbanner.t_issuer and 
                             objcode.t_bankdate < dt and 
                             (objcode.t_bankclosedate = to_date('01.01.0001','dd.mm.yyyy') or objcode.t_bankclosedate >= dt)) IssuerId,
                      chr(1) ContractorId, 
                      (select nvl(regexp_substr(max(objcode.t_code),'^\d{0,}'),chr(1)) 
                       from dobjcode_dbt objcode 
                       where objcode.t_objecttype = 3 and 
                             objcode.t_codekind = 16/*ИНН*/ and
                             objcode.t_objectid = vsbanner.t_issuer and 
                             objcode.t_bankdate < dt and 
                             (objcode.t_bankclosedate = to_date('01.01.0001','dd.mm.yyyy') or objcode.t_bankclosedate >= dt)) IssuerINN,
                      chr(1) ContractorINN, 
                      nvl(party.t_name, chr(1)) IssuetName,
                      chr(1) ContractorName,
                      0 CollateralValue, 

                      /* ВР */
                      (SELECT m.t_account 
                       FROM dmcaccdoc_dbt m
                       WHERE m.t_catnum = case when instr(vsbanner.t_bcstate, 'Ч') > 0 then 1492 else 462 end
                             and m.t_dockind = 164 and m.t_docid = vsbanner.t_bcid and m.t_isusable = chr(88) and t_firole = 5
                      ) AccountNumber, 

                      (select nvl(max(objcode.t_code),chr(1)) 
                       from dobjcode_dbt objcode 
                       where objcode.t_objecttype = 3 and 
                             objcode.t_codekind = 6/*BIC ISO (SWIFT)*/ and
                             objcode.t_objectid = vsbanner.t_issuer and 
                             objcode.t_bankdate < dt and 
                             (objcode.t_bankclosedate = to_date('01.01.0001','dd.mm.yyyy') or objcode.t_bankclosedate >= dt)) SWIFT,
                      'Да' SPPI, 
                      '1' BusinessModel, 
                      'АС' EvaluationCategory,
                      vsbanner.t_bctermformula t_bctermformula, 
                      vsbanner.t_bcformkind t_bcformkind,
                      dl_leg.t_start t_start,
                      dl_leg.t_maturity t_maturity,
                      dl_leg.t_expiry t_expiry,
                      dl_leg.t_basis t_basis,
                      dl_leg.t_diff t_diff            
                from (select dt, 
                             vsbanner.t_bcid t_bcid,
                             vsbanner.t_issuer t_issuer,
                             (select nvl(sum(vsincome.t_perc), 0)
                              from dvsincome_dbt vsincome
                              where vsincome.t_bcid = vsbanner.t_bcid and
                                    vsincome.t_incometype in (2/*VSINCOMETYPE_ACCOUNTEDSUM*/, 3/*VSINCOMETYPE_BONUSSUM*/, 0/*VSINCOMETYPE_CHARGE*/, 1/*VSINCOMETYPE_OVERVALUE*/) and
                                    vsincome.t_enrolment_id = rsb_bill.GetVABnrLastAccountedEnrolID(vsbanner.t_bcid, dt-1) and
                                    vsincome.t_enddate < dt) t_sum,
                             vsbanner.t_bcseries t_bcseries,
                             vsbanner.t_bcnumber t_bcnumeber,
                             vsbanner.t_bctermformula t_bctermformula, 
                             vsbanner.t_bcformkind t_bcformkind,
                             vsbanner.t_issuedate t_issuedate,
                             vsbanner.t_bcstate t_bcstate
                      from dvsbanner_dbt vsbanner
                      where not exists(select 1 from ddp_dep_dbt dp_dep where dp_dep.t_partyid = vsbanner.t_issuer) and
                            vsbanner.t_portfolioid > 0 and
                            vsbanner.t_issuedate < dt and
                            (vsbanner.t_repaymentdate > dt or vsbanner.t_repaymentdate = to_date('01.01.0001','dd.mm.yyyy'))) vsbanner
                      join ddl_leg_dbt dl_leg on 
                           dl_leg.t_legid = 0 and 
                           dl_leg.t_legkind = 1/*rsb_bill.LEG_KIND_VSBANNER*/ and 
                           dl_leg.t_dealid = vsbanner.t_bcid
                      left join dfininstr_dbt fininstr on fininstr.t_fiid = dl_leg.t_pfi
                      left join dparty_dbt party on party.t_partyid = vsbanner.t_issuer 
                      where vsbanner.t_sum > 0)
      loop
        -- Добавляем значение в коллекцию
        rsb_bill.GetVABnrBalancePrm(v.t_bcid,
                                    dt,
                                    null,
                                    null,
                                    p_BalanceDate,
                                    p_DealID,
                                    p_Cost,
                                    p_CostFI,
                                    p_DealType,
                                    p_DealCode,
                                    p_BOfficeKind);
        if((p_BalanceDate is not null) and (p_BalanceDate > to_date('01.01.0001','dd.mm.yyyy')))then
          Coll_W606.extend();
          Coll_W606(Coll_W606.last).t_TypeFI := v.TypeFI;
          Coll_W606(Coll_W606.last).t_TypeIssuer := v.TypeIssuer;
          Coll_W606(Coll_W606.last).t_ReportDate := v.ReportDate;
          Coll_W606(Coll_W606.last).t_BalanceDebt := v.BalanceDebt;
          Coll_W606(Coll_W606.last).t_Currency := v.Currency;
          Coll_W606(Coll_W606.last).t_FIID := v.FIID;
          Coll_W606(Coll_W606.last).t_ISIN := v.ISIN;
          Coll_W606(Coll_W606.last).t_DealID := v.DealID;
          Coll_W606(Coll_W606.last).t_BuyDate := p_BalanceDate;
          if(v.t_BCFormKind = 1/*VSBANNER_FORMKIND_SIMPLE*/)then
            /** Формулировка вексельного срока - На определенный день */
            if(v.t_BCTermFormula = 10/*VS_TERMF_FIXEDDAY*/)then
              Coll_W606(Coll_W606.last).t_MaturityDate := v.t_Maturity;
            /** Формулировка вексельного срока - Во столько-то времени от составления */
            elsif(v.t_BCTermFormula = 15/*VS_TERMF_INATIME*/)then
              Coll_W606(Coll_W606.last).t_MaturityDate := v.t_Maturity;
            /** Формулировка вексельного срока - Во столько-то времени предъявления */
            elsif(v.t_BCTermFormula = 30/*VS_TERMF_DURING*/)then
              /*Coll_W606(Coll_W606.last).t_MaturityDate := to_date('01.01.2099','dd.mm.yyyy');*/
              p_stat := rsb_bill.GetDaysInYearByBasis(v.t_Basis, v.t_Start, true, p_DaysInYear);
              Coll_W606(Coll_W606.last).t_MaturityDate := v.t_Start + v.t_Diff + p_DaysInYear;
            /** Формулировка вексельного срока - По предъявлении */
            elsif(v.t_BCTermFormula = 20/*VS_TERMF_ATSIGHT*/)then
              /*-- Указано "не позднее даты"
              if((v.t_Expiry > v.t_Start))then
                Coll_W606(Coll_W606.last).t_MaturityDate := v.t_Expiry;
              -- Указано "на ранее даты"
              elsif((v.t_Maturity > v.t_Start))then
                Coll_W606(Coll_W606.last).t_MaturityDate := v.t_Expiry;
              else
                Coll_W606(Coll_W606.last).t_MaturityDate := to_date('01.01.2099','dd.mm.yyyy');
              end if;*/
              if((v.t_Maturity >= v.t_Start) and (v.t_Expiry >= v.t_Start))then
                Coll_W606(Coll_W606.last).t_MaturityDate := v.t_Expiry;
              elsif(v.t_Maturity >= v.t_Start)then
                p_stat := rsb_bill.GetDaysInYearByBasis(v.t_Basis, v.t_Maturity, true, p_DaysInYear);
                Coll_W606(Coll_W606.last).t_MaturityDate := v.t_Maturity + p_DaysInYear;
              elsif(v.t_Expiry >= v.t_Start)then
                Coll_W606(Coll_W606.last).t_MaturityDate := v.t_Expiry;
              else
                p_stat := rsb_bill.GetDaysInYearByBasis(v.t_Basis, v.t_Start, true, p_DaysInYear);
                Coll_W606(Coll_W606.last).t_MaturityDate := v.t_Start + p_DaysInYear;
              end if;
            end if;
          else
            Coll_W606(Coll_W606.last).t_MaturityDate := v.t_Maturity;
          end if;
          Coll_W606(Coll_W606.last).t_IssuerId := v.IssuerId;
          Coll_W606(Coll_W606.last).t_ContractorId := v.ContractorId;
          Coll_W606(Coll_W606.last).t_IssuerINN := v.IssuerINN;
          Coll_W606(Coll_W606.last).t_ContractorINN := v.ContractorINN;
          Coll_W606(Coll_W606.last).t_IssuetName := v.IssuetName;
          Coll_W606(Coll_W606.last).t_ContractorName := v.ContractorName;
          Coll_W606(Coll_W606.last).t_Expiration := nvl(rsi_rsbcalendar.getWorkDayCount(nvl(Coll_W606(Coll_W606.last).t_MaturityDate,dt), dt-1),0);
          -- Ищем текущий рейтинг
          begin
            select t_validfromdate, t_name, t_codelist, t_parentid
            into Coll_W606(Coll_W606.last).t_RatingDate, Coll_W606(Coll_W606.last).t_RatingCurrent, Coll_W606(Coll_W606.last).t_RatingSource, v_t_parentid
            from (select objatcor.t_validfromdate,
                         objattr.t_name,
                         objattr.t_codelist,
                         objattr.t_parentid,
                         row_number() over(order by objatcor.t_validfromdate) rnum
                  from dobjatcor_dbt objatcor 
                  join dobjattr_dbt objattr on objattr.t_objecttype = objatcor.t_objecttype and 
                                               objattr.t_groupid = objatcor.t_groupid and 
                                               objattr.t_attrid = objatcor.t_attrid
                  where objatcor.t_objecttype = 3 and 
                        objatcor.t_groupid = 19 /*Рейтинг*/ and 
                        objatcor.t_object = lpad(v.t_partyid, 10, '0') and 
                        objatcor.t_validfromdate <= dt-1 and 
                        objatcor.t_validtodate >= dt-1 and
                        objatcor.t_general = chr(88))
            where rnum = 1;
            -- Ищем рейтинг той же группы за дату сделки
            begin
              select t_name
              into Coll_W606(Coll_W606.last).t_RatingFirst
              from (select objattrfirst.t_name t_name, row_number() over(order by objatcorfirst.t_general desc, objatcorfirst.t_validfromdate) rnum
                    from dobjatcor_dbt objatcorfirst 
                    left join dobjattr_dbt objattrfirst on objattrfirst.t_objecttype = objatcorfirst.t_objecttype and 
                                                           objattrfirst.t_groupid = objatcorfirst.t_groupid and 
                                                           objattrfirst.t_attrid = objatcorfirst.t_attrid and 
                                                           objattrfirst.t_parentid = v_t_parentid 
                    where objatcorfirst.t_objecttype = 3 and 
                          objatcorfirst.t_groupid = 19 /*Рейтинг*/ and 
                          objatcorfirst.t_object = lpad(v.t_partyid, 10, '0') and 
                          objatcorfirst.t_validfromdate <= v.t_start and 
                          objatcorfirst.t_validtodate >= v.t_start)
              where rnum = 1;
            exception when no_data_found then
              Coll_W606(Coll_W606.last).t_RatingFirst := chr(1);
            end;
          exception when no_data_found then
            Coll_W606(Coll_W606.last).t_RatingDate := to_date('01.01.0001','dd.mm.yyyy');
            Coll_W606(Coll_W606.last).t_RatingFirst := chr(1);
            Coll_W606(Coll_W606.last).t_RatingCurrent := chr(1);
            Coll_W606(Coll_W606.last).t_RatingSource := chr(1);
          end;
          Coll_W606(Coll_W606.last).t_CollateralValue := v.CollateralValue;
          Coll_W606(Coll_W606.last).t_AccountNumber := v.AccountNumber;
          Coll_W606(Coll_W606.last).t_SWIFT := v.SWIFT;
          Coll_W606(Coll_W606.last).t_YearsToMaturity := greatest(round(months_between(nvl(Coll_W606(Coll_W606.last).t_MaturityDate,dt), dt-1)/12,12), 0);
          Coll_W606(Coll_W606.last).t_SPPI := v.SPPI;
          Coll_W606(Coll_W606.last).t_BusinessModel := v.BusinessModel;
          Coll_W606(Coll_W606.last).t_EvaluationCategory := v.EvaluationCategory;
        end if;
      end loop;

      -- Сохраняем коллекцию
      forall i in Coll_W606.first .. Coll_W606.last
        insert into DW606_U_TMP values Coll_W606(i);

    end;
  ];
  cmd = RSDCommand(EndCaptureOutput());
  cmd.AddParam("dt", RSDBP_IN, dt);
  cmd.Execute();
end;

