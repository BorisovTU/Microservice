import RSBDataSet, dlgCommon;
import FIInter,rsexts,oralib,likepy;
import "gtconst.inc",calculate,funk,"cb_sql.mac",dl_plib,globals,PTInter,PaymInter,OprInter,SfInter;

var rs,sql;

macro AddAcc(dealid,account,bdate)
    
    macro GetPidByAcc(acc):integer
    var pid = "",sql,rs;
      pid = SubStr(acc,4,2);
    if (pid != "")
      sql = "SELECT p.t_id FROM dmcperiod_dbt p WHERE p.t_id BETWEEN 43 AND 53 AND p.t_periodcode = "+pid;
      rs = ExecSqlSelect(sql);
      if(rs.MoveNext())
        return rs.value(0);
      end;
    end;
    return 0;
  end;

    const DKIND=4813;
    macro InsAccount(dockind, dealid, acc, catid, catnum, duration, firole , chapter)
          //InsAccount(, prm_tick.rec.DealID, macc, 184, 311, 0, 1); //КУ +Форвард, расчеты (Требования)     //prm_legBase.rec.Duration
          var que, rs0, pid,Err,Filename,tmp,grp=0;
          bdate = substr(string(bdate),1,10);

         if ((substr(acc,1, 3) == "939") or (substr(acc,1, 3) == "969") )
            pid = GetPidByAcc(acc);
         else
            pid = 0;
         end;

         if (pid == 43)
          tmp = 1;
         elif (pid == 44)
          tmp = 2;
         else
          tmp = 1;
         end;

         if (pid != 0)
          grp = 6;
         end;

          que = "insert into dmcaccdoc_dbt "+ 
                "(t_dockind,      "+
                " t_catid,        "+
                " t_catnum,       "+
                " t_docid,        "+
                " t_account,      "+
                " t_actiondate,   "+
                " t_activatedate, "+
                " t_isusable,     "+     //???  пусто внебаланс
                " t_kind_account, "+
                " t_currency,     "+
                " t_fiid,         "+     //??? -1 внебаланс
                " t_templnum,     "+     //???
                " t_groupnum,     "+
                " t_periodid,     "+
                " t_chapter,      "+
                " t_disablingdate,"+
                " t_iscommon,     "+ 
                " t_owner,        "+ 
                " t_place,        "+ 
                " t_issuer,       "+ 
                " t_departmentid, "+ 
                " t_branch,       "+ 
                " t_mcbranch,      "+ 
                " t_firole,       "+ 
                " t_centr,        "+ 
                " t_centroffice,  "+ 
                " t_clientcontrid,"+ 
                " t_bankcontrid,  "+ 
                " t_marketplaceid,"+ 
                " t_marketplaceofficeid,"+ 
                " t_indexdate,    "+ 
                " t_contractor,   "+ 
                " t_currencyeq,   "+
                " t_currencyeq_ratetype,"+
                " t_currencyeq_ratedate,"+
                " t_currencyeq_rateextra,"+
                " t_corrdepartmentid,"+ 
                " t_fiid2 )"+
                " values ("+
                 String(dockind)+", " +
                 String(catid) + ", " +
                 String(catnum)+ ", " +    
                 String(dealid)+","+
                "'"+ acc+"', "+
                " to_date('"+bdate+"', 'DD.MM.YYYY'),"+
                " to_date('"+bdate+"', 'DD.MM.YYYY'),"+
                " 'X', "+
                " (select t_kind_account from dbalance_dbt  where t_balance ='"+ substr(acc,1,5)+"'), "+
                " (select nvl((select t_fiid from dfininstr_dbt t where t_fi_kind=1 and t.t_fi_code='"+substr(acc,6,3)+"'), 0) from dual), "+
                " (select nvl((select t_fiid from dfininstr_dbt t where t_fi_kind=1 and t.t_fi_code='"+substr(acc,6,3)+"'), 0) from dual), "+
                tmp+", "+
                grp+", "+
                pid+", "+
                chapter+", "+
                " to_date('01010001', 'DDMMYYYY'),"+
                "chr(0), "+
                "-1,"+
                "-1,"+
                "-1,"+
                {NumDprt}+","+
                {NumDprt}+","+
                {NumDprt}+","+
                string(firole)+","+  //FiDoc
                "-1,"+
                "-1,"+
                "-1,"+
                "-1,"+
                "-1,"+
                "-1,"+
                "-1,"+
                "-1,"+
                "-1,"+
                "0,"+
                "0,"+
                "0.0,"+
                "0,"+
                "0 )";

          rs0 = LnGetRecordset(que);
    end;

    if ( (account != "empty") or (ValType(account) != V_UNDEF) )
        if ( substr(account,1, 5) == "47421" )
            InsAccount(DKIND, dealid, account, 792, 5072, 0, 182, 1); //КУ +Форвард, расчеты
        elif ( substr(account,1, 5) == "47424" ) 
            InsAccount(DKIND, dealid, account, 793, 5073, 0, 182, 1); //КУ -Форвард, расчеты
        elif ( substr(account,1, 3) == "939" ) 
            InsAccount(DKIND, dealid, account, 616, 5021, 0, 1, 4); //КУ +Форвард, дрейф внебирж
        elif ( substr(account,1, 3) == "969" ) 
            InsAccount(DKIND, dealid, account, 617, 5022, 0, 2, 4); //КУ -Форвард, дрейф внебирж
        end;
    end;
end;

sql = "select d.t_id,b.t_account,d.t_date from ddvndeal_dbt d,dbufacc_dbt b where trim(d.t_code) = trim(b.t_deriv) and d.t_dockind = 4813 and d.t_id<>1789";
rs = ExecSqlSelect(sql);

while (rs.MoveNext())
    AddAcc(rs.value(0),rs.value(1),rs.value(2));
end;