/*
va_rep_drrk1.mac
Отчет (ДРРК_1) Расшифровка учтенных векселей (по Банку в целом) по состоянию на отчетную дату (счета 512-519)
*/
import oralib, likepy, or_rep_h, globals, vslib;

macro StartReport ()
  var decsep = GetLocaleInfo (0, LOCALE_SDECIMAL, IsStandAlone() );

  var prccontract = TRecHandler("prccontract");
  var Rep, sql, dt = {curdate};
  var sheet = 1;
  var rn = 0;
  var format_line = "c:ex_B(tblr):ex_FS()";
  var format_head = "c:ex_B(tblr):ex_FS(b)";
  var format_head_msfo = "c:ex_B(tblr):ex_FS(b):ex_BC(16777164)";
  var format_line_msfo = "c:ex_B(tblr):ex_FS(b):ex_BC(16777164)";
  var EXCEL_MONEY = "\"# ##0"+decsep+"00\"";
  var EXCEL_INTEGER = "\"# ##0\"";
  var com_issuedate = "";
  var com_termformula = "";


  var НачисленныйПроцент:money;
  var НеНачисленныйПроцент:money;
  var РассчетныйПроцент:money;
  var РассчетныйПроцентВВалюте:money;
  var Amount_to_be_paid:money;
  
  //Длины колонок
  var length_long_text    = 30;
  var length_medium_text  = 13;
  var length_small_text   = 6;
  var length_account      = 18;
  var length_long_number  = 14;
  var length_small_number = 4;
  var length_date         = 10;


  macro ПустаяСтрока (height:double)
    rn = rn + 1;
    if (valtype(height) != V_UNDEF)
      Rep.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").RowHeight = " + height + ";");
    end;
    Rep.AddPrintCell("", length_medium_text, null, "ex_B()");
    Rep.AddStr();
  End;

  if (not GetDate(dt)) 
    return;
  end;

  Rep = CMakeReport("┌┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┐");

  Rep.SetDefaultFontName("Times New Roman");
  Rep.SetDefaultFontSize(9);
  Rep.SetFlagShowGrid(true);

  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(8).NumberFormat = "+EXCEL_MONEY+";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(9).NumberFormat = "+EXCEL_MONEY+";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(10).NumberFormat = "+EXCEL_MONEY+";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(11).NumberFormat = "+EXCEL_MONEY+";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(12).NumberFormat = "+EXCEL_MONEY+";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(13).NumberFormat = "+EXCEL_MONEY+";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(18).NumberFormat = "+EXCEL_MONEY+";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(19).NumberFormat = "+EXCEL_MONEY+";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(20).NumberFormat = "+EXCEL_MONEY+";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(21).NumberFormat = "+EXCEL_MONEY+";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(22).NumberFormat = "+EXCEL_MONEY+";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(23).NumberFormat = "+EXCEL_MONEY+";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(24).NumberFormat = "+EXCEL_MONEY+";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(25).NumberFormat = "+EXCEL_MONEY+";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(28).NumberFormat = "+EXCEL_MONEY+";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(35).NumberFormat = "+EXCEL_MONEY+";");

  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(16).NumberFormat = "+EXCEL_INTEGER+";");  

  ПустаяСтрока();

  rn = rn + 1;
  Rep.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"R"+rn+"\").FormulaR1C1 = \"Для процентных векселей\";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"U"+rn+"\").FormulaR1C1 = \"Для дисконтных векселей\";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"X"+rn+"\").FormulaR1C1 = \"РАСЧЕТ\";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"Y"+rn+"\").FormulaR1C1 = \"РАСЧЕТ\";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"Z"+rn+"\").FormulaR1C1 = \"РАСЧЕТ\";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"AA"+rn+"\").FormulaR1C1 = \"РАСЧЕТ\";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"AB"+rn+"\").FormulaR1C1 = \"РАСЧЕТ\";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"AC"+rn+"\").FormulaR1C1 = \"РАСЧЕТ\";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"AJ"+rn+"\").FormulaR1C1 = \"Справедливая стоимость ценных бумаг\";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"AL"+rn+"\").FormulaR1C1 = \"Страна резидентности эмитента векселя\";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"AQ"+rn+"\").FormulaR1C1 = \"График погашения ценной бумаги\";");

  Rep.AddPrintCell("", length_medium_text, null, "ex_B():ex_FS(b)");
  Rep.AddPrintCell("Расшифровка учтенных векселей (по Банку в целом) по состоянию на дату " + dt + " (счета 512-519)", length_small_text, null, "ex_B():ex_FS(b)");
  Rep.AddStr();

  rn = rn + 1;
  Rep.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").VerticalAlignment = "+ALIGN_CENTER+";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = true;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").RowHeight = 152;");

  Rep.AddPrintCell("Филиал", length_medium_text, null, format_head);
  Rep.AddPrintCell("Номер счета второго порядка", length_small_text, null, format_head);
  Rep.AddPrintCell("Номер лицевого счета", length_account, null, format_head);
  Rep.AddPrintCell("Векселедатель", length_long_text, null, format_head);
  Rep.AddPrintCell("Серия / выпуск", length_medium_text, null, format_head);
  Rep.AddPrintCell("Количество бумаг", length_small_number, null, format_head);
  Rep.AddPrintCell("Валюта, в которой номинирован вексель", length_small_text, null, format_head);
  Rep.AddPrintCell("Номинальная стоимость на отчетную дату в рублевом эквиваленте", length_long_number, null, format_head);
  Rep.AddPrintCell("Если вексель номинирован в инвалюте, то номинальная стоимость на отчетную дату в инвалюте", length_long_number, null, format_head);
  Rep.AddPrintCell("Цена приобретения", length_long_number, null, format_head);
  Rep.AddPrintCell("Если вексель номинирован в инвалюте, то цена приобретения на отчетную дату в инвалюте", length_long_number, null, format_head);
  Rep.AddPrintCell("Балансовая стоимость на отчетную дату в рублевом эквиваленте", length_long_number, null, format_head);
  Rep.AddPrintCell("Если вексель номинирован в инвалюте, то балансовая стоимость на отчетную дату в инвалюте", length_long_number, null, format_head);
  Rep.AddPrintCell("Дата приобретения", length_date, null, format_head);
  Rep.AddPrintCell("Дата погашения (срок вложения)", length_date, null, format_head);
  Rep.AddPrintCell("Дней до погашения", length_small_number, null, format_head);
  Rep.AddPrintCell("Доходность к погашению", length_small_number, null, format_head);
  Rep.AddPrintCell("Процентная ставка", length_small_number, null, format_head);
  Rep.AddPrintCell("Наращенные проценты по состоянию на отчетную дату", length_long_number, null, format_head);
  Rep.AddPrintCell("Если вексель номинирован в инвалюте, то наращенные проценты на отчетную дату в инвалюте", length_long_number, null, format_head);
  Rep.AddPrintCell("Сумма дисконта, в рублевом эквиваленте", length_long_number, null, format_head);
  Rep.AddPrintCell("Наращенный дисконт по состоянию на отчетную дату", length_long_number, null, format_head);
  Rep.AddPrintCell("Если вексель номинирован в инвалюте, то наращенный дисконт на отчетную дату в инвалюте", length_long_number, null, format_head);
  Rep.AddPrintCell("Amount received", length_long_number, null, format_head_msfo);
  Rep.AddPrintCell("Amount to be paid", length_long_number, null, format_head_msfo);
  Rep.AddPrintCell("Issue date", length_date, null, format_head_msfo);
  Rep.AddPrintCell("Maturity date", length_date, null, format_head_msfo);
  Rep.AddPrintCell("Effective rate (for discount)", length_small_number, null, format_head_msfo);
  Rep.AddPrintCell("Амортизированная стоимость", length_small_number, null, format_head_msfo);
  Rep.AddPrintCell("ССП, к зоне ответственности которого относится инструмент", length_medium_text, null, format_head);
  Rep.AddPrintCell("Наличие признаков обесценения", length_small_text, null, format_head);
  Rep.AddPrintCell("Необходимость расчета резерва МСФО (да/нет)", length_small_text, null, format_head);
  Rep.AddPrintCell("Дисконтированная стоимость ценной бумаги (при наличии обесценения)", length_long_number, null, format_head);
  Rep.AddPrintCell("Сумма резерва под возможное обесценение МСФО, для векселей, классифицированных в категорию МСФО \"удерживаемые до погашения\" или \"ссуды\"", length_long_number, null, format_head);
  Rep.AddPrintCell("Сумма фактически созданного резерва под возможное обесценение РСБУ", length_long_number, null, format_head);
  Rep.AddPrintCell("рыночная котировка по состоянию на отчетную дату; если сделки заключаются на внебиржевом рынке, то цена последней котировки на покупку", length_long_number, null, format_head);
  Rep.AddPrintCell("на основе иных методик оценки (если рыночная оценка отсутствует)", length_medium_text, null, format_head);
  Rep.AddPrintCell("Россия", length_medium_text, null, format_head);
  Rep.AddPrintCell("Организация экономического сотрудничества и развития", length_medium_text, null, format_head);
  Rep.AddPrintCell("Другие страны", length_medium_text, null, format_head);
  Rep.AddPrintCell("Классификация ценных бумаг для целей МСФО: (1) торговые, (2) имеющиеся в наличии для продажи, (3) удерживаемые до погашения, (4) ссуды", length_small_number, null, format_head);
  Rep.AddPrintCell("Рейтинг векселедателя", length_small_text, null, format_head);
  Rep.AddPrintCell("<=30 дн", length_medium_text, null, format_head_msfo);
  Rep.AddPrintCell("30<дн<=180", length_medium_text, null, format_head_msfo);
  Rep.AddPrintCell("180<дн<=365", length_medium_text, null, format_head_msfo);
  Rep.AddPrintCell(">365 дн до 3 лет включительно", length_medium_text, null, format_head_msfo);
  Rep.AddPrintCell("Свыше 3 лет", length_medium_text, null, format_head_msfo);
  Rep.AddPrintCell("Дисконт по формуле простых %", length_long_number, null, format_head_msfo);
  Rep.AddPrintCell("Разность дисконта NPV", length_long_number, null, format_head_msfo);
  Rep.AddPrintCell("Дисконт в РСБУ", length_long_number, null, format_head_msfo);
  Rep.AddPrintCell("Дооценка дисконта в МСФО", length_long_number, null, format_head_msfo);
  Rep.AddStr();

sql = "select department, \n"
    + "       balance_account, \n"
    + "       account, \n"
    + "       issuername, \n"
    + "       sernum, \n"
    + "       currency, \n"
    + "       facevalue_rub, \n"
    + "       facevalue_cur, \n"
    + "       bccost_rub, \n"
    + "       bccost_cur, \n"
    + "       balance_cost_rub, \n"
    + "       balance_cost_cur, \n"
    + "       buyDate, \n"
    + "       planrepaydate, \n"
    + "       DaysToRepay, \n"
    + "       repay_yield, \n"
    + "       perc_rate, \n"
    + "       discount_full_rub, \n"
    + "       case when balance_cost_rub < bccost_rub then 0 \n"
    + "            else accrued_discount_rub \n"
    + "       end accrued_discount_rub, \n"
    + "       case when facevaluefi <> 0 then accrued_discount_cur else 0 end accrued_discount_cur, \n"
    + "       case when facevaluefi <> 0 \n"
    + "            then balance_cost_cur + accrued_discount_cur \n"
    + "            else balance_cost_rub + accrued_discount_rub \n"
    + "       end Amount_to_be_paid, \n"
    + "       issuedate, \n"
    + "       maturity_date, \n"
    + "       effective_rate, \n"
    + "       fact_reserve_rsbu, \n"
    + "       termformula, \n"
    + "       maturity, \n"
    + "       expiry, \n"
    + "       prccontractid, \n"
    + "       bcid, \n"
    + "       presentationdate, \n"
    + "       facevaluefi \n"
    + "from ( \n"
    + "    select banner.*, \n"
    + "           substr(account, 1, 5) balance_account, \n"
    + "           RSI_RSB_FIInstr.ConvSum(facevalue, facevaluefi, 0, :dt, 2) facevalue_rub, \n"
    + "           case when facevaluefi <> 0 then facevalue else 0 end facevalue_cur, \n"
    + "           RSI_RSB_FIInstr.ConvSum(bccost, PayFi, 0, :dt, 2) bccost_rub, \n"
    + "           case when PayFi <> 0 then bccost else 0 end bccost_cur, \n"
    + "           abs(rsi_rsb_account.RestAll(account, 1, facevaluefi, :dt, 0)) balance_cost_rub, \n"
    + "           case when facevaluefi <> 0 then abs(rsi_rsb_account.RestAll(account, 1, facevaluefi, :dt)) else 0 end balance_cost_cur, \n"
    + "           RSI_RSB_FIInstr.ConvSum(facevalue, facevaluefi, 0, :dt, 2) - RSI_RSB_FIInstr.ConvSum(bccost, PayFi, 0, :dt, 2) discount_full_rub, \n"
    + "           decode(presentationdate, to_date('01.01.0001', 'dd.mm.yyyy'), planrepaydate, presentationdate) maturity_date, \n"
    + "           RSI_RSB_FIInstr.ConvSum(accrued_discount_cur, facevaluefi, 0, :dt, 2) accrued_discount_rub, \n"
    + "           planrepaydate - buyDate DaysToRepay \n"
    + "    from(select (select t_name from dparty_dbt where t_partyid = (select t_partyid from ddp_dep_dbt where t_code = bnr.t_department)) department, \n"
    + "                 rsb_bill_rshb.VA_GetBannerAccount(bnr.t_bcid, :dt) account, \n"
    + "                 bnr.t_IssuerName issuername, \n"
    + "                 trim(bnr.t_bcseries) || ' ' || trim(bnr.t_bcnumber) sernum, \n"
    + "                 (select t_iso_number from dfininstr_dbt where t_fiid = leg.t_pfi) currency, \n"
    + "                 leg.t_principal facevalue, \n"
    + "                 leg.t_pfi facevaluefi, \n"
    + "                 rsb_bill.GetVABnrPayFIID(bnr.t_bcid) PayFi, \n"
    + "                 lnk.t_bccost bccost, \n"
    + "                 (select t_dealdate from ddl_tick_dbt where t_bofficekind = 141 and t_dealid = lnk.t_contractid) buyDate, \n"
    + "                 rsb_bill_rshb.GetBnrPlanRepayDate(leg.t_id) planrepaydate, \n"
    //+ "                 leg.t_duration DaysToRepay, \n"
    + "                 rsb_bill_rshb.GetBnrRate(bnr.t_bcid) repay_yield, \n"
    + "                 leg.t_price/power(10, leg.t_point) perc_rate, \n"
    + "                 rsb_bill_rshb.GetDiscountOnDateVA(leg.t_id, bnr.t_bcid, :dt) accrued_discount_cur, \n"
    + "                 bnr.t_issueDate issuedate, \n"
    + "                 case when leg.t_formula = 0 then leg.t_incomerate else 0 end effective_rate, \n"
    + "                 (select nvl(sum(t_reserveamount), 0) from ddlreslnk_dbt \n"
    + "                  where t_type = 2 and t_parentid = bnr.t_bcid and t_reservesubkind <> 5) fact_reserve_rsbu, \n"
    + "                 bnr.t_bcid bcid, \n"
    + "                 leg.t_id legid, \n"
    + "                 bnr.t_bcpresentationdate presentationdate, \n"
    + "                 bnr.t_bctermformula termformula, \n"
    + "                 leg.t_maturity maturity, \n"
    + "                 leg.t_expiry expiry, \n"
    + "                 nvl((select t_contractid from dprccontract_dbt where t_objecttype = 651 and to_number(t_objectid) = bnr.t_bcid), 0) prccontractid \n"
    + "         from dvsbanner_dbt bnr, ddl_leg_dbt leg, dvsordlnk_dbt lnk \n"
    + "         where     not bnr.t_issuer in (select t_partyid from ddp_dep_dbt) \n"
    + "               and rsb_bill.GetVABnrStatusOnDate(bnr.t_bcid, :dt) = 100 /*Учтен*/ \n"
    + "               and leg.t_legid = 0 \n"
    + "               and leg.t_legkind = 1 \n"
    + "               and leg.t_dealid = bnr.t_bcid \n"
    + "               and lnk.t_bcid = bnr.t_bcid \n"
    + "               and lnk.t_linkkind = 1 /*Покупка*/ \n"
    + "         order by bnr.t_issuer \n"
    + "        ) banner \n"
    + ") t \n";

  sql = ExecSqlSelect(sql, MakeArray(SqlParam("dt", dt)), false);
  
  while (sql.MoveNext() )
    НачисленныйПроцент = 
    НеНачисленныйПроцент = 
    РассчетныйПроцент = 
    РассчетныйПроцентВВалюте = 
    Amount_to_be_paid = $0;

    com_issuedate = ":ex_COM(Дата составления: " + String(sql.value("issuedate", null, V_DATE):f)+")";
    com_termformula = ":ex_COM("+ VS_TermFormula(sql.value("termformula"),
                                                 sql.value("maturity"),
                                                 sql.value("expiry"))+")";

    if (sql.value("prccontractid") > 0)
      prccontract.clear();
      if(not НайтиСчетПроцВекселя(prccontract, sql.value("bcid"), null, VS_FINDPC_ACTUAL))
        НачисленныйПроцент = 0;
        НеНачисленныйПроцент = 0;
      elif(not СуммаНачисленныхПроцентовПоПДВекселя(prccontract.rec.ContractID, prccontract.rec.BeginDate, dt, НачисленныйПроцент))
        НачисленныйПроцент = 0;
        НеНачисленныйПроцент = 0;
      elif((sql.value("presentationdate") == Date(0, 0, 0)) and not ПроцентыКНачислениюПоПДВекселя(prccontract.rec.ContractID, VS_GetRightPcDate(prccontract, dt), НеНачисленныйПроцент))
        НачисленныйПроцент = 0;
        НеНачисленныйПроцент = 0;
      end;
      РассчетныйПроцент = НачисленныйПроцент + НеНачисленныйПроцент;
      if (sql.value("facevaluefi") != NATCUR)
        РассчетныйПроцентВВалюте = РассчетныйПроцент;
        РассчетныйПроцент = VS_Convert( РассчетныйПроцент, dt, sql.value("facevaluefi"), NATCUR);
      end;
    end;
    Amount_to_be_paid = sql.value("Amount_to_be_paid") + IfThenElse(sql.value("facevaluefi") == NATCUR, РассчетныйПроцент, РассчетныйПроцентВВалюте);

    rn = rn + 1;
    Rep.AddPrintCell(sql.value("department"),           length_medium_text,  null, format_line); //1. филиал
    Rep.AddPrintCell(sql.value("balance_account"),      length_small_text,   null, format_line); //2. Номер счета второго порядка
    Rep.AddPrintCell(sql.value("account"),              length_account,      null, format_line); //3. Номер лицевого счета
    Rep.AddPrintCell(sql.value("issuername"),           length_long_text,    null, format_line); //4. Векселедатель
    Rep.AddPrintCell(sql.value("sernum"),               length_medium_text,  null, format_line); //5. Серия / выпуск
    Rep.AddPrintCell(1,                                 length_small_number, null, format_line); //6. Количество бумаг
    Rep.AddPrintCell(sql.value("currency"),             length_small_text,   null, format_line); //7. Валюта, в которой номинирован вексель
    Rep.AddPrintCell(sql.value("facevalue_rub"),        length_long_number,  null, format_line); //8. Номинальная стоимость на отчетную дату в рублевом эквиваленте
    Rep.AddPrintCell(sql.value("facevalue_cur"),        length_long_number,  null, format_line); //9. Если вексель номинирован в инвалюте, то номинальная стоимость на отчетную дату в инвалюте
    Rep.AddPrintCell(sql.value("bccost_rub"),           length_long_number,  null, format_line); //10. Цена приобретения
    Rep.AddPrintCell(sql.value("bccost_cur"),           length_long_number,  null, format_line); //11. Если вексель номинирован в инвалюте, то цена приобретения на отчетную дату в инвалюте
    Rep.AddPrintCell(sql.value("balance_cost_rub"),     length_long_number,  null, format_line); //12. Балансовая стоимость на отчетную дату в рублевом эквиваленте
    Rep.AddPrintCell(sql.value("balance_cost_cur"),     length_long_number,  null, format_line); //13. Если вексель номинирован в инвалюте, то балансовая стоимость на отчетную дату в инвалюте
    Rep.AddPrintCell(sql.value("buyDate", null, V_DATE),       length_date,  null, format_line + com_issuedate); //14. Дата приобретения
    Rep.AddPrintCell(sql.value("planrepaydate", null, V_DATE), length_date,  null, format_line); //15. Дата погашения (срок вложения)
    Rep.AddPrintCell(sql.value("DaysToRepay"),          length_small_number, null, format_line + com_termformula); //16. Дней до погашения
    Rep.AddPrintCell(sql.value("repay_yield"),          length_small_number, null, format_line); //17. Доходность к погашению
    Rep.AddPrintCell(sql.value("perc_rate"),            length_small_number, null, format_line); //18. Процентная ставка
    Rep.AddPrintCell(РассчетныйПроцент,                 length_long_number,  null, format_line); //19. Наращенные проценты по состоянию на отчетную дату
    Rep.AddPrintCell(РассчетныйПроцентВВалюте,          length_long_number,  null, format_line); //20. Если вексель номинирован в инвалюте, то наращенные проценты на отчетную дату в инвалюте
    Rep.AddPrintCell(sql.value("discount_full_rub"),    length_long_number,  null, format_line); //21. Сумма дисконта, в рублевом эквиваленте
    Rep.AddPrintCell(sql.value("accrued_discount_rub"), length_long_number,  null, format_line); //22. Наращенный дисконт по состоянию на отчетную дату
    Rep.AddPrintCell(sql.value("accrued_discount_cur"), length_long_number,  null, format_line); //23. Если вексель номинирован в инвалюте, то наращенный дисконт на отчетную дату в инвалюте
    Rep.AddPrintCell(" ",                               length_long_number,  null, format_line); //24. Amount received
    Rep.AddPrintCell(Amount_to_be_paid,                 length_long_number,  null, format_line); //25. Amount to be paid
    Rep.AddPrintCell(sql.value("issuedate", null, V_DATE),     length_date,  null, format_line); //26. Issue date
    Rep.AddPrintCell(sql.value("maturity_date", null, V_DATE), length_date,  null, format_line); //27. Maturity date
    Rep.AddPrintCell(sql.value("effective_rate"),       length_small_number, null, format_line); //28. Effective rate (for discount)
    Rep.AddPrintCell(" ",                               length_small_number, null, format_line); //29. Амортизированная стоимость
    Rep.AddPrintCell("",                                length_medium_text,  null, format_line); //30. ССП, к зоне ответственности которого относится инструмент
    Rep.AddPrintCell("",                                length_small_text,   null, format_line); //31. Наличие признаков обесценения
    Rep.AddPrintCell(" ",                               length_small_text,   null, format_line); //32. Необходимость расчета резерва МСФО (да/нет)
    Rep.AddPrintCell(" ",                               length_long_number,  null, format_line); //33. Дисконтированная стоимость ценной бумаги (при наличии обесценения)
    Rep.AddPrintCell(" ",                               length_long_number,  null, format_line); //34. Сумма резерва под возможное обесценение МСФО, для векселей, классифицированных в категорию МСФО "удерживаемые до погашения" или "ссуды"
    Rep.AddPrintCell(sql.value("fact_reserve_rsbu"),    length_long_number,  null, format_line); //35. Сумма фактически созданного резерва под возможное обесценение РСБУ
    Rep.AddPrintCell(" ",                               length_long_number,  null, format_line); //36. рыночная котировка по состоянию на отчетную дату; если сделки заключаются на внебиржевом рынке, то цена последней котировки на покупку
    Rep.AddPrintCell("",                                length_medium_text,  null, format_line); //37. на основе иных методик оценки (если рыночная оценка отсутствует)
    Rep.AddPrintCell("Россия",                          length_medium_text,  null, format_line); //38. Россия
    Rep.AddPrintCell(" ",                               length_medium_text,  null, format_line); //39. Организация экономического сотрудничества и развития
    Rep.AddPrintCell("",                                length_medium_text,  null, format_line); //40. Другие страны
    Rep.AddPrintCell(" ",                               length_small_number, null, format_line); //41. Классификация ценных бумаг для целей МСФО: (1) торговые, (2) имеющиеся в наличии для продажи, (3) удерживаемые до погашения, (4) ссуды
    Rep.AddPrintCell(" ",                               length_small_text,   null, format_line); //42. Рейтинг векселедателя
    Rep.AddPrintCell(" ",                               length_medium_text,  null, format_line); //43. <=30 дн
    Rep.AddPrintCell(" ",                               length_medium_text,  null, format_line); //44. 30<дн<=180
    Rep.AddPrintCell(" ",                               length_medium_text,  null, format_line); //45. 180<дн<=365
    Rep.AddPrintCell(" ",                               length_medium_text,  null, format_line); //46. >365 дн до 3 лет включительно
    Rep.AddPrintCell(" ",                               length_medium_text,  null, format_line); //47. Свыше 3 лет
    Rep.AddPrintCell(" ",                               length_long_number,  null, format_line); //48. Дисконт по формуле простых %
    Rep.AddPrintCell(" ",                               length_long_number,  null, format_line); //49. Разность дисконта NPV
    Rep.AddPrintCell(" ",                               length_long_number,  null, format_line); //50. Дисконт в РСБУ
    Rep.AddPrintCell(" ",                               length_long_number,  null, format_line); //51. Дооценка дисконта в МСФО
    Rep.AddStr();
  end;

  Rep.SetFileName("ДРРК_1_"+dt);
  Rep.PrintWinRep("Отчет");
  Rep.SetZoomType(ZOOM_TYPE_A4L);
  Rep.SetWinRepOutput();
  Rep.ShowWinRep();
End;

StartReport();
exit(1);