import activex, oralib, likepy, BankInter, DVInter, globals, rsd,RsbDataSet, PTInter,CTInter, "cb_sql.mac", dealsinter;
import "u_common_email_utils.mac", "dlquery.mac";


//private record HDGRelation(dlhdgrelation) key 0;
     Var HDGRelation = TBFile("dlhdgrelation.dbt", "R", 0 );


Var Repdate;
var g_errortext = "";

private const COL1               = 1,
              COL2               = 2,
              COL3               = 3,
              COL4               = 4,
              COL5               = 5,
              COL6               = 6,
              COL7               = 7,
              COL8               = 8, 
              COL9               = 9, 
              COL10               = 10, 
              COL11               = 11, 
              COL12               = 12; 


class StatusRecOH()
  var OperDate         :date,
      IDDealOHAsudr    :string,
      Portf            :string,
      SubPortf         :string,
      Val              :string,
      CurSSOH          :money,
      PrewSSOH         :money,
      DeltaSSOH        :money,            
      IDOHSOFR         :string,
      KindDealOH       :string,
      IDHedgRel        :string,
      EndDateOHAsudr   :date,
//BIQ-10394 Тип отношений хеджирования
      Relationtype     :integer;
;
 end;

    private const CV_EMAIL_GRP_HEDG = 31; /* Группа рассылки по проблемам загрузки файла с данными по Инструментам Хеджирования */


Private Macro TrimStr(str)
   If (valtype(str) != V_STRING)
      return str;
   else
      return trim(str);
   end;
End;

// получение sql-ошибки. 
// использовать в onError(e) так:  RunError(e.message + getFullCmdErrorText(cmd));
private macro getFullCmdErrorText(_cmd:RSDCommand)
   var cmd = _cmd;
   var err_str = "", i = 0;

   while( i < cmd.connection.environment.ErrorCount)
      err_str = err_str + cmd.connection.environment.Error(i).Descr + " ";
      i = i+1;
   end;

   return trim(err_str);
end;

Private macro SendErrMsg(error:string, LoadFileName:string, receiverGroupID:integer)
   var email = c_email_proc_env();
   var FileName, ExtName, DirName;
   VAR SpPath = "", SpFileName = "", tittle = "", message = "";
   //Отделяем путь файла от имени
   tittle = "Внимание! Хеджирование. Загрузка файла.  " + LoadFileName;
   message = "Сообщение отправлено автоматически. В процессе загрузки файла по СС ОХ " + LoadFileName + " возникли следующие ошибки: \n " + error;
   email.m_set_msg_head(tittle);
   email.m_add_row_to_msg_text(message);
   email.m_save_to_submit_grp(receiverGroupID);
   email.m_submit_email_synch();
End;

Private macro SendGoodMsg(error:string, LoadFileName:string, receiverGroupID:integer)
   var email = c_email_proc_env();
   var FileName, ExtName, DirName;
   VAR SpPath = "", SpFileName = "", tittle = "", message = "";
   //Отделяем путь файла от имени
   tittle = "Внимание! Хеджирование. Загрузка файла.  " + LoadFileName;
   message = "Сообщение отправлено автоматически. Файл по СС ОХ " + LoadFileName + " успешно загружен ";
   email.m_set_msg_head(tittle);
   email.m_add_row_to_msg_text(message);
   email.m_save_to_submit_grp(receiverGroupID);
   email.m_submit_email_synch();
End;


//Перемещает файл
private macro copyFromTo (from, to)
  return TDirList().copy(from, null, to, true, false);
End;

Private macro GetRepDate(RepDate)
   var day,mon,year;
   DateSplit(RepDate, day,mon,year);
   if (day < 10)
     day = string(0,day)
   end;
   If(mon <10)
      mon = string(0,mon);
   end;
     return string (day,mon,year);

End;


Private macro InsOH_IHDate(strho, IrsId, ID, kind)

 var sql, rs, cmd, err, KindCateg = 0, Hoid = 0;

   cmd = RsdCommand("select * from ddlavrhdobj_dbt where t_objkind = :Kind and t_objid = :ID"); 

  cmd.addParam("Kind", RSDBP_IN, kind);
  cmd.addParam("ID", RSDBP_IN, ID);

  cmd.execute();
  
  rs = RsdRecordset(cmd);

  if(rs.MoveNext())
     Hoid = rs.value("t_hoid");
  end;

  cmd = RsdCommand("select * from ddlavrhdinstr_dbt where t_instrdockind = 199 and t_hoid = :hoid and t_instrdocid = :IrsId"); 

  cmd.addParam("Hoid", RSDBP_IN, Hoid);
  cmd.addParam("IrsId", RSDBP_IN, IrsId);

  cmd.execute();
  
  rs = RsdRecordset(cmd);

  if(not rs.MoveNext())
      sql = "Insert into ddlavrhdinstr_dbt values(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, :11, :12, :13, :14, :15, :16, :17, :18)";
      cmd = RSDCommand(sql);
      cmd.AddParam("p01", RSDBP_IN, 0);
      cmd.AddParam("p02", RSDBP_IN, Hoid);
      cmd.AddParam("p03", RSDBP_IN, 1);
      cmd.AddParam("p04", RSDBP_IN, 199);
      cmd.AddParam("p05", RSDBP_IN, IrsId);
      cmd.AddParam("p06", RSDBP_IN, strho.OperDate);
      cmd.AddParam("p07", RSDBP_IN, strho.EndDateOHAsudr);
      cmd.AddParam("p08", RSDBP_IN, strho.Relationtype);
      cmd.AddParam("p09", RSDBP_IN, strho.IDDealOHAsudr);
      cmd.AddParam("p10", RSDBP_IN, strfor(1));
      cmd.AddParam("p11", RSDBP_IN, strho.EndDateOHAsudr);
      cmd.AddParam("p12", RSDBP_IN, strho.Portf);
      cmd.AddParam("p13", RSDBP_IN, strho.SubPortf);
      cmd.AddParam("p14", RSDBP_IN, strfor(1));
      cmd.AddParam("p15", RSDBP_IN, strho.IDHedgRel);
      cmd.AddParam("p16", RSDBP_IN, strho.OperDate);
      cmd.AddParam("p17", RSDBP_IN, 1);
      cmd.AddParam("p18", RSDBP_IN, 1);

      cmd.Execute;
  end;
  return true;
onError(e)
  g_errortext = e.message + getFullCmdErrorText(cmd);
  RunError(g_errortext);
end;

Private macro InsSSOH(strho, /*IrsId,*/ ID, kind, ihohid, fiid)
 var sql, cmd, rs, err, KindCateg = 0;

  cmd = RsdCommand("select turn.* from DDLHDGRFAIRVAL_DBT turn where turn.t_relationid =  :ihohid "+
                    " and turn.t_date = :SSDate"); 

  cmd.addParam("ihohid", RSDBP_IN, ihohid);
  cmd.addParam("SSDate", RSDBP_IN, strho.OperDate);

  cmd.execute();
  
  rs = RsdRecordset(cmd);

  if( rs.MoveNext())
  
  else
      sql = " Insert into DDLHDGRFAIRVAL_DBT (T_ID, T_RELATIONID, T_DATE, T_ACTUALFV, T_PREVFV, T_DFV, T_CURFIID) "+
            " values(:1, :2, :3, :4, :5, :6, :7)";
      cmd = RSDCommand(sql);
      cmd.AddParam("p01", RSDBP_IN, 0);
      cmd.AddParam("p02", RSDBP_IN, ihohid);
      cmd.AddParam("p03", RSDBP_IN, strho.OperDate);
      cmd.AddParam("p04", RSDBP_IN, strho.CurSSOH);
      cmd.AddParam("p05", RSDBP_IN, strho.PrewSSOH);
      cmd.AddParam("p06", RSDBP_IN, strho.DeltaSSOH);
      cmd.AddParam("p07", RSDBP_IN, fiid);

      cmd.Execute;
  end;
  return true;
onError(e)
  g_errortext = e.module + ", line=" + e.line + " " + e.message + getFullCmdErrorText(cmd);
  RunError(g_errortext);
End;


Private macro InsOH_IHMBKDate(strho, IrsId, ID, kind)

 var sql, cmd, rs,err, KindCateg = 0;

  cmd = RsdCommand("select * from dmmhedginstr_dbt where t_dealid = :ID and t_dvndealid = :IrsId"); 

  cmd.addParam("ID", RSDBP_IN, ID);
  cmd.addParam("IrsId", RSDBP_IN, IrsId);

  cmd.execute();
  
  rs = RsdRecordset(cmd);

  if(not rs.MoveNext())
      sql = "Insert into dmmhedginstr_dbt values(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, chr(1), chr(1), :13)";
      cmd = RSDCommand(sql);
      cmd.AddParam("p01", RSDBP_IN, 0);
      cmd.AddParam("p02", RSDBP_IN, ID);
//      cmd.AddParam("p03", RSDBP_IN, "");
//      cmd.AddParam("p04", RSDBP_IN, 1);
      cmd.AddParam("p03", RSDBP_IN, IrsId);
      cmd.AddParam("p04", RSDBP_IN, strho.OperDate);
      cmd.AddParam("p05", RSDBP_IN, strho.EndDateOHAsudr);
      cmd.AddParam("p06", RSDBP_IN, strho.Relationtype);

      cmd.AddParam("p07", RSDBP_IN, strho.IDDealOHAsudr);
//      cmd.AddParam("p10", RSDBP_IN, strho.EndDateOHAsudr);
      cmd.AddParam("p08", RSDBP_IN, strho.Portf);
      cmd.AddParam("p09", RSDBP_IN, strho.SubPortf);
      cmd.AddParam("p10", RSDBP_IN, strho.IDHedgRel);
      cmd.AddParam("p13", RSDBP_IN, strho.OperDate);


      cmd.Execute;

  end;
  return true;

onError(e)
  g_errortext = e.module + " " + e.line + " " + e.message + getFullCmdErrorText(cmd);
  RunError(g_errortext);
end;


Private macro InsOHMBKDate(strho, IrsId, ID, kind)

 var sql, cmd, rs,err, KindCateg = 0;

  cmd = RsdCommand("select * from dmmhedginstr_dbt where t_ishedgobj = 'X' and t_instrkind = 0 and t_dealid = :ID "); 

  cmd.addParam("ID", RSDBP_IN, ID);

  cmd.execute();
  
  rs = RsdRecordset(cmd);

  if(not rs.MoveNext())
      sql = "Insert into dmmhedginstr_dbt values(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, :11, :12, :13)";
      cmd = RSDCommand(sql);
      cmd.AddParam("p01", RSDBP_IN, 0);
      cmd.AddParam("p02", RSDBP_IN, ID);
      cmd.AddParam("p03", RSDBP_IN, "X");
      cmd.AddParam("p04", RSDBP_IN, 0);
      cmd.AddParam("p05", RSDBP_IN, 0);
      cmd.AddParam("p06", RSDBP_IN, date("01.01.0001"));
      cmd.AddParam("p07", RSDBP_IN, date("01.01.0001"));
      cmd.AddParam("p08", RSDBP_IN, 0);

      cmd.AddParam("p09", RSDBP_IN, strho.IDDealOHAsudr);
      cmd.AddParam("p10", RSDBP_IN, strho.EndDateOHAsudr);
      cmd.AddParam("p11", RSDBP_IN, strho.Portf);
      cmd.AddParam("p12", RSDBP_IN, strho.SubPortf);
      cmd.AddParam("p13", RSDBP_IN, strho.IDHedgRel);

      cmd.Execute;

//   		connectobjattr(err, Kind, string (ID:o:34), 11, 1, null, null, strho.OperDate);
//   		connectobjattr(err, Kind, string (ID:o:34), 11, 2, null, null, strho.EndDateOHAsudr);
  end;
  return true;
onError(e)
  g_errortext = e.module + " " + e.line + " " + e.message + getFullCmdErrorText(cmd);
  RunError(g_errortext);
end;


Private macro InsOHDate(strho, IrsId, ID, kind)

 var sql, cmd, rs,err, KindCateg = 0;

  cmd = RsdCommand("select * from ddlavrhdobj_dbt where t_objkind = :Kind and t_objid = :ID"); 

  cmd.addParam("Kind", RSDBP_IN, kind);
  cmd.addParam("ID", RSDBP_IN, ID);

  cmd.execute();
  
  rs = RsdRecordset(cmd);

  if(not rs.MoveNext())
      sql = "Insert into ddlavrhdobj_dbt values(:1, :2, :3, :4, :5, :6, :7, :8)";
      cmd = RSDCommand(sql);
      cmd.AddParam("p01", RSDBP_IN, 0);
      cmd.AddParam("p02", RSDBP_IN, kind);
      cmd.AddParam("p03", RSDBP_IN, ID);
      cmd.AddParam("p04", RSDBP_IN, strho.IDDealOHAsudr);
      cmd.AddParam("p05", RSDBP_IN, strho.EndDateOHAsudr);
      cmd.AddParam("p06", RSDBP_IN, strho.Portf);
      cmd.AddParam("p07", RSDBP_IN, strho.SubPortf);
      cmd.AddParam("p08", RSDBP_IN, strho.IDHedgRel);

      cmd.Execute;
      If(Kind == 12)
         KindCateg = 68;
   	elif(Kind == 24)
   	  KindCateg = 6;
   	end;
//   		connectobjattr(err, Kind, string (ID:o:10), KindCateg, 1, null, null, strho.OperDate);
//   		connectobjattr(err, Kind, string (ID:o:10), KindCateg, 2, null, null, strho.EndDateOHAsudr);
  end;
  return true;
onError(e)
  g_errortext = e.module + " " + e.line + " " + e.message + getFullCmdErrorText(cmd);
  RunError(g_errortext);
end;


Private macro InsertTablesOH(strho, /*IrsId,*/ ID, kind, IHOHID, ValFiid)
 var stat = 0;
/*
 If((kind == 12) or (kind == 24))
    stat = InsOHDate(strho, IrsId, ID, kind);
    stat = InsOH_IHDate(strho, IrsId, ID, kind);
 else
//    stat = InsOHMBKDate(strho, IrsId, ID, kind);
    stat = InsOH_IHMBKDate(strho, IrsId, ID, kind);
 end;
*/
 stat = InsSSOH(strho, /*IrsId,*/ ID, kind, IHOHID, ValFiid);

 return true;
end;


Private Macro GetValFiid(ficode, err:@string)
   var cmd, rs ;
   err= "";
  cmd = RsdCommand(" select * from dfininstr_dbt where t_ccy = :code"); 

  cmd.addParam("code", RSDBP_IN, ficode);

  cmd.execute();
  
  rs = RsdRecordset(cmd);

  if(rs.MoveNext())
        return rs.value("t_fiid");
  else
     Err = "Не определена валюта в файле по объектам Хеджирования по коду валюты " + ficode;
     return -1;
  end;

end;


Private Macro GetIHOHIDParm (strho, ID, kind, IHOHID:@integer, IHOHDATE:@Date, err:@string)
  var cmd, rs ;
  err= "";
  cmd = RsdCommand(" select * from ddlhdgrelation_dbt where t_ext_hedgeid = :Rel and t_objid = :ID"); 

  cmd.addParam("Rel", RSDBP_IN, strho.IDHedgRel);
  cmd.addParam("ID", RSDBP_IN, ID);

  cmd.execute();
  
  rs = RsdRecordset(cmd);

  if(rs.MoveNext())
      if (strho.SubPortf != rs.value("t_ext_subportf"))
         Err = "Не совпадают субпортфели в " + strho.IDHedgRel + " передано "+strho.SubPortf+", существующий "+rs.value("t_ext_subportf");
         return -1;
      end;
      IHOHID = rs.value("t_id");
      IHOHDATE = SQL_ConvTypeDate(rs.value("t_enddate"));
  else
      Err = "Не определены отношения Хеджирования по ID отношений Хеджирования " + strho.IDHedgRel;
      return -1;
  end;

End;


Private Macro GetIHOHID (strho, /*IrsId,*/ ID, kind, err:@string)
   var cmd, rs ;
   err= "";
  cmd = RsdCommand(" select * from ddlhdgrelation_dbt where /*t_instrid = :IrsId and*/ t_ext_hedgeid = :Rel and t_objid = :ID"); 

//  cmd.addParam("IrsId", RSDBP_IN, IrsId);
  cmd.addParam("Rel", RSDBP_IN, strho.IDHedgRel);
  cmd.addParam("ID", RSDBP_IN, ID);

  cmd.execute();
  
  rs = RsdRecordset(cmd);

  if(rs.MoveNext())
        return rs.value("t_id");
  else
     Err = "Не определены отношения Хеджирования по ID отношений Хеджирования " + strho.IDHedgRel;
     return -1;
  end;

end;


Private Macro GetIrsDealID (code, err:@string)
   var cmd, rs ;
   err= "";
  cmd = RsdCommand(" select * from ddlhdgrelation_dbt where t_Instrdockind = 199 and t_ext_hedgeid = :code  and rownum = 1"); 

  cmd.addParam("code", RSDBP_IN, code);
  cmd.execute();
  
  rs = RsdRecordset(cmd);

  if(rs.MoveNext())
        return rs.value("t_dealid");
  else
     Err = "Не определена сделка СВОП (инструмент Хеджирования) по ID отношений Хеджирования " + code;
     return -1;
  end;

end;

Private Macro GetVekselDate(SerNumVeks, ObjectID:@integer, ObjKind:@integer, err:@string)
   var cmd, rs ;
   Var Ser, Num;
   err = "";

   num = substr(SerNumVeks, 1, strlen(SerNumVeks) -(strlen(SerNumVeks) - index(SerNumVeks, "-")) - 1);
   ser = substr(SerNumVeks, index(SerNumVeks, "-") + 1);
   ObjectID = -1;
   ObjKind = -1;
                                                 
  cmd = RsdCommand(" select " + 
                   " (case when exists( select 1 from ddp_dep_dbt where t_partyid = bnr.t_issuer) Then 1 else 0 end) as IsSobstv," +
                   " bnr.* from dvsbanner_dbt bnr where bnr.t_bcseries = :seria and Trim(bnr.t_bcnumber) = :num"); 

  cmd.addParam("seria", RSDBP_IN, Ser);
  cmd.addParam("num", RSDBP_IN, num);

  cmd.execute();
  
  rs = RsdRecordset(cmd);

  if(rs.MoveNext())
      ObjectID = rs.value("t_bcid");
         ObjKind = 24;
      If(rs.value("t_BcStatus") == 30)
         err= "Ошибка загрузки данных по ОХ. Вексель, определенный по комбинации номер-серия " + SerNumVeks + " погашен";
         ObjectID = -1;
         ObjKind = -1;
      end;
  else
     err= "Ошибка загрузки данных по ОХ. Не удалось определить вексель по комбинации номер-серия " + SerNumVeks;
     ObjectID = -1;
     ObjKind = -1;

  end;
onerror(RslErrObj)

End;


Private Macro GetAvoirDate(ISINCode, ObjectID:@integer, ObjKind:@integer, err:@string)
   var cmd, rs ;
   err = "";
  cmd = RsdCommand(" select avr.*, fin.* from davoiriss_dbt avr, dfininstr_dbt fin where avr.t_isin = :isin and fin.t_fiid = avr.t_fiid"); 

  cmd.addParam("isin", RSDBP_IN, ISINCode);
  cmd.execute();
  
  rs = RsdRecordset(cmd);

  if(rs.MoveNext())
      ObjectID = rs.value("t_fiid");
         ObjKind = 12;
/*
      If(rs.value("t_drawingdate") <= {curdate})
         err= "Ошибка загрузки данных по ОХ. Выпуск ценных бумаг с кодом " + ISINCode + " имеет дату погашения, меньшую чем установление отношения хеджирования.";
         ObjectID = -1;
         ObjKind = -1;
      end;
*/
      If(rs.value("t_isclosed") == "X")
         err= "Ошибка загрузки данных по ОХ. Выпуск ценных бумаг с кодом " + ISINCode + " закрыт";
         ObjectID = -1;
         ObjKind = -1;
      end;

  else
     err= "Ошибка загрузки данных по ОХ. Не удалось определить выпуск ценных бумаг по коду " + ISINCode;
     ObjectID = -1;
     ObjKind = -1;

  end;

End;

Private Macro GetMBKDealDate(MBKDealCode, ObjectID:@integer, ObjKind:@integer, err:@string)
   var cmd, rs ;
   err = "";
  cmd = RsdCommand(" select * from ddl_tick_dbt where t_bofficekind = 102 and t_dealcode = :dealcode    "); 

  cmd.addParam("dealcode", RSDBP_IN, MBKDealCode);
  cmd.execute();
  
  rs = RsdRecordset(cmd);

  if(rs.MoveNext())
     ObjectID = rs.value("t_dealid");
     ObjKind = 103;

     If(rs.value("t_dealstatus") == 20)
         ObjKind = -1;
         ObjectID = -1;
         err = "Ошибка загрузки данных по ОХ. Сделка МБК с кодом " + MBKDealCode + "закрыта";
     end;
  else
     err = "Ошибка загрузки данных по ОХ. Не удалось определить сделку МБК по коду " + MBKDealCode;
     ObjectID = -1;
     ObjKind = -1;
  end;

End;


Private Macro GetOXParm(Kind, ID, ObjectID:@integer, ObjKind:@integer, err:@string);
err = "";
If(strupr(Kind) == "МБК")
   GetMBKDealDate(ID, @ObjectID, @ObjKind, @err);
elIf(strupr(Kind) == "ОБЛИГАЦИЯ")
   GetAvoirDate(ID, @ObjectID, @ObjKind, @err);
elIf(strupr(Kind) == "ВЕКСЕЛЬ")
   GetVekselDate(ID, @ObjectID, @ObjKind, @err);
elIf((strupr(Kind) == "ДЕПОЗИТ") OR (strupr(Kind) == "КРЕДИТ") OR (strupr(Kind) == "LOAN") OR (strupr(Kind) == "DEPOSIT"))
   ObjectID = 0;
   If((strupr(Kind) == "КРЕДИТ") OR (strupr(Kind) == "LOAN"))
      ObjKind = 7;
   else
      ObjKind = 8;
   end;
else
   err = "Неверный вид ОХ = " + Kind + " в файле по ОХ.";
   ObjectID = -1;
   ObjKind = -1;
end;


End;


//Расположение загружаемого файла
var  reg_path, errcode;
 GetRegistryValue("РСХБ\\ДИРЕКТОРИИ\\ИМПОРТ_ХЕДЖИРОВАНИЕ", V_STRING, reg_path, errcode );
  if ( errcode != 0 )
    reg_path = "";
  end; 
var  arch_path;                                               
 GetRegistryValue("РСХБ\\ДИРЕКТОРИИ\\ИМПОРТ_ХЕДЖИРОВАНИЕ_АРХИВ", V_STRING, arch_path, errcode );
  if ( errcode != 0 )
    arch_path = "";
  end; 

var  err_path;                                               
 GetRegistryValue("РСХБ\\ДИРЕКТОРИИ\\ИМПОРТ_ХЕДЖИРОВАНИЕ_ОШИБКИ", V_STRING, err_path, errcode );
  if ( errcode != 0 )
    err_path = "";
  end; 


  //Загрузка данных из Excel

macro OpLoadFile(FileName, TermPath, RepDate)
   var frow = 1;
   var row = 1;
   var StRecOH, sheet, sheetcount;
   var all = 0,suc = 0, err = 0;
   var ErrStr = "",ErrStat = false, AllErrStr = "", curerr = "", DistrErrstr = "";
   Var IrsDealCode = "";
   Var ObjectID = -1, ObjKind = -1, IrsDealId = -1, IHOHID = -1, ValFiid = -1, IHOHEndDate;
   /*Открываем файл*/
   BegAction(1, "Обработка файла \"" + TermPath + "\\" + FileName + "\". Ждите...");
   if(not OpenExcelFile(FileName, false, true, TermPath))
      MsgBox("Ошибка открытия файла \"" + TermPath + "\\" + FileName + "\"");
      EndAction(1);
      return 0;
   end;
  /**/
   sheetcount = 1;
   WHILE(ExcelApplication.Sheets.count >= sheetcount)
      sheet = ExcelApplication.Sheets(sheetcount);
      frow = 1;
      row = 1;

      row = frow;
      //Бежим по файлу
      InitProgress(-1);
      while (valtype(sheet.cells(row, COL1).value) != V_UNDEF) 
         ErrStat = false;
         if (strupr(sheet.cells(row, COL1).value) == "ДАТА ОПЕРАЦИОННОГО ДНЯ") 
            row = row + 1;
            continue; 
         end;

         all = all + 1;

         StRecOH = StatusRecOH(); 
         StRecOH.OperDate       = TrimStr(sheet.cells(row, COL1).value);
         StRecOH.IDDealOHAsudr       = TrimStr(sheet.cells(row, COL2).value);
         StRecOH.Portf       = TrimStr(sheet.cells(row, COL3).value);
         StRecOH.SubPortf       = TrimStr(sheet.cells(row, COL4).value);
         StRecOH.Val       = TrimStr(sheet.cells(row, COL5).value);
         StRecOH.CurSSOH       = TrimStr(sheet.cells(row, COL6).value);
         StRecOH.PrewSSOH       = TrimStr(sheet.cells(row, COL7).value);
         StRecOH.DeltaSSOH       = TrimStr(sheet.cells(row, COL8).value);

         If(valtype(sheet.cells(row, COL9).value) != V_STRING)
            StRecOH.IDOHSOFR       = string(sheet.cells(row, COL9).value:0:0);
         else
            StRecOH.IDOHSOFR       = sheet.cells(row, COL9).value;
         end;
         StRecOH.KindDealOH       = TrimStr(sheet.cells(row, COL10).value);
         StRecOH.IDHedgRel       = TrimStr(sheet.cells(row, COL11).value);
         StRecOH.EndDateOHAsudr       = TrimStr(sheet.cells(row, COL12).value);
         if (StRecOH.SubPortf == "FV_HEDGE")
            StRecOH.Relationtype = 1;          // Тип отношений хеджирования = Хеджирование СС
         elif (StRecOH.SubPortf == "CF_HEDGE")
            StRecOH.Relationtype = 2;          // Тип отношений хеджирования = Хеджирование ДП
         else 
            StRecOH.Relationtype = 0;          // других типов не предусмотрено
            ErrStat = true;
            ErrStr = "Неизвестный субпортфель " + StRecOH.SubPortf;
            AllErrStr = AllErrStr + ErrStr + "\n";
         end;

         GetOXParm(StRecOH.KindDealOH, StRecOH.IDOHSOFR, @ObjectID, @ObjKind, @curerr);
         If(ObjectID == -1)
            ErrStat = true;
            ErrStr = curerr;
            AllErrStr = AllErrStr + ErrStr + "\n";
         end;

//            IHOHID = GetIHOHID (StRecOH, /*IrsDealId,*/ ObjectID, ObjKind, @curerr);
         IHOHID = -1;
         GetIHOHIDParm (StRecOH, ObjectID, ObjKind, @IHOHID, @IHOHEndDate, @curerr);
         If(IHOHID == -1)
            ErrStat = true;
            ErrStr = curerr;
            AllErrStr = AllErrStr + ErrStr + "\n";
         end;

         ValFiid = GetValFiid(StRecOH.Val, @curerr);
         If(ValFiid == -1)
            ErrStat = true;
            ErrStr = curerr;
            AllErrStr = AllErrStr + ErrStr + "\n";
         end;
         If(not errstat)
            rslDefCon.beginTrans ();
            InsertTablesOH(StRecOH, ObjectID, ObjKind, IHOHID, ValFiid);
            If(date(StRecOH.EndDateOHAsudr) != date(IHOHEndDate))
                   //Println("Даты не равны. ");

               ClearRecord( HDGRelation );
               HDGRelation.rec.id = IHOHID;
               if( not GetEQ( HDGRelation ) ) 
                  ErrStat = true;
                  ErrStr = "Не удалось определить структуру отношений Хеджирования для изменения даты окончания на " + StRecOH.EndDateOHAsudr;
                  AllErrStr = AllErrStr + ErrStr + "\n";
                  if ( rslDefCon.isInTrans () )
                     rslDefCon.rollbackTrans ();
                  end;
               else
                  HDGRelation.rec.EndDate = date(StRecOH.EndDateOHAsudr);
                  DL_HDGRelationChangeParm(HDGRelation, date(StRecOH.OperDate),  DistrErrstr)
               end;
               If(DistrErrstr != "")
                  ErrStat = true;
                  ErrStr = "Не удалось изменить дату отношенйя хеджирования на " + StRecOH.EndDateOHAsudr + " по ID отношений = " + IHOHID + " по причине:\n" + DistrErrstr;
                  AllErrStr = AllErrStr + ErrStr + "\n";
                  if ( rslDefCon.isInTrans () )
                     rslDefCon.rollbackTrans ();
                  end;
               end;

            end;
            If(not errstat)
               if ( rslDefCon.isInTrans () )
                  rslDefCon.commitTrans ();
               end;
            else
               if ( rslDefCon.isInTrans () )
                  rslDefCon.rollbackTrans ()
               end;
            end;
         end;
         UseProgress(row);

         ErrStr = "";
         ErrStat = false;
             //STrec = null;
         row = row + 1;
      end; //while
      RemProgress();
      sheetcount = sheetcount+1;
   end;//eow sheet
   ExcelApplication.ActiveWorkbook.Close;
   If(AllErrStr != "")
      PrintLn("Внимание! В процессе загрузки файла " + FileName + " произошли следующие ошибки :");
      Println();
      PrintLn(AllErrStr);
      Println();
      Println("Файл " + FileName + " будет перемещен по пути : " + err_path);
      SendErrMsg(AllErrStr, FileName, CV_EMAIL_GRP_HEDG);
      return 1;
   else
      Println("Файл " + FileName + " обработан успешно");
      SendGoodMsg("", FileName, CV_EMAIL_GRP_HEDG);
      return 0;
   end;

onerror(er)
  if ( rslDefCon.isInTrans () )
      rslDefCon.rollbackTrans ();
  end;
  if (valtype(ExcelApplication) != V_UNDEF)
    ExcelApplication.ActiveWorkbook.Close;
  end;
  EndAction(1);
  PrintLn("Внимание! В процессе загрузки файла " + FileName + " произошли следующие ошибки :" + er.message + g_errortext);
  if (g_errortext == "")
     g_errortext = er.message;
  end;
  SendErrMsg( g_errortext, FileName, CV_EMAIL_GRP_HEDG);

  return 1;

end;


macro OpLoadOH(RepDate)

  var DealID_Excel:string;
  var DealCode:string = "";
  var FullNameFile = "";
  var FileName = "";
  var TermPath = GetCurDir(true) + "\\TxtFile";
  var Userpath = "";
  var DirName = "";
  var ExtName = "";
  var valuedate:date =  Date(0, 0, 0);
  var ss = $0;
  var str;
  var DealID,FrVal = 0;
  var day = date();
  var i = 0, WIthErr = 0;
  var dt = StrSubSt(string(Date()),".","");
 /*Выбираем файл для обработки*/

  var List = TDirList(reg_path + "\FI_OH_" + GetRepDate(RepDate) + "*.xlsx", "F");
  while( i < List.Count )
     FullNameFile = List.Name(i);
     DirName = splitfile(FullNameFile, FileName, ExtName);
     FileName = FileName + ExtName;

     if (not copyfile("$" + reg_path + FileName, "$" + TermPath + "\\" + FileName) )
       MsgBox("Ошибка при передаче файла на терминал");
     end;
     WIthErr = OpLoadFile(FileName, TermPath, RepDate);
     If(WIthErr)
        copyFromTo(reg_path + FullNameFile, "$" + err_path+"\\");
     else

        copyFromTo(reg_path + FullNameFile, "$" + arch_path+"\\");

     end;

     i = i + 1;

  end;
  
End;


  if( not IsShedulerRunning())
   If( not GetDate(Repdate, "Введите дату загрузки"))
      exit(1);
   end;
   OpLoadOH(Repdate);
  end;
