/*
$Name:         vsv005.mac
$Module:       Векселя банка
$Description:  Выкуп собственных векселей банка. Прием векселей в кассу

                vs-вексель
                 v-операция выкупа векселя
               010-номер (соответствующий шагу)
                in-инициализация
*/

import vs_sendmes, globals;

private macro GetRecipients (DepNum)
  var Recipients = "";

  //Пока не ясно, где и как будут находиться почтовые адреса получателей уведомлений. Это для теста
  Recipients = "mail@domen.ru";

  return Recipients;
End;

/* Запуск шага
*/
MACRO ExecuteStep(Buffer, dl_order)
  var stat = 0;
  record order( dl_order );
  SetBuff( order, dl_order );

  if ({OperDprt} != 1 ) //Выполнить этот шаг может только сотрудник ГО
    return 1;
  end;

  var DepName = "Вексельный центр ДРРК";
  var Body = "";//текст уведомления

  Body = "Уведомляем РФ " + GetDprtName(order.Department) + " о том, что операция погашения векселей Банка №" + order.OrderNumber + " акцептована";

  /* Отпраить письмо в филиал, что операция проверена */
  if (order.Department != 1) //Уведомление отправляется только в РФ
    stat = ОтправитьУведомление(DepName, GetRecipients(order.Department), "Уведомление об акцептовке", Body);
  end;  

  if (stat != 0)
    MsgBoxEx("Ошибка при отправке уведомления в ГО");
  end;

  return stat;
END;

/* Макрос постобработки
*/
MACRO PostStep(
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

   if(errTrn or (CommitOrRollback == 2))
      /* Произошла ошибка или происходит откат */
      return;
   end;

   return 1;
END;