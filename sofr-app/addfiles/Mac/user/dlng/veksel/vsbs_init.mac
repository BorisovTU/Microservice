/*
Макрос инициализации операции отправки бланков в филиал
*/
import oralib, likepy, globals, vslib;

macro InitOperation(Kind_Operation,DocKind,fmo_buf)
  var sql;
  var count = 0;

  record fmo( vsfrmord );
  SetBuff( fmo, fmo_buf );

  sql = "select trim(vsform.t_number) numb, \n"
      + "       vsform.t_status status, \n"
      + "       vsform.t_department dep \n"
      + "from dobjlink_dbt objlink, dvsform_dbt vsform \n"
      + "where     objlink.t_groupid = 1 \n"
      + "      and objlink.t_objecttype = 667 \n"
      + "      and objlink.t_objectid = lpad(:objid, 10, 0) \n"
      + "      and objlink.t_attrid = trim(vsform.t_number) \n";
  sql = ExecSqlSelect(sql, MakeArray(SqlParam("objid", fmo.frmordid)), false);

  while (sql.MoveNext() )
    if (sql.value("status", null, V_INTEGER) != 10)
      MsgBox("Бланк №" + sql.value("numb") + "|не имеет статус \"В кассе\"" );
      return 1;
    end;

    if (sql.value("dep", null, V_INTEGER) != {OperDprt})
      MsgBox("В филиале " + GetDprtName({OperDprt}) + "|не найден вексель №" + sql.value("numb"));
      return 1;
    end;

    //поискать бланк в любой другой не отложенной операции

    count = count + 1;
  end;

  if (count == 0)
    MsgBox("Не выбраны бланки для операции");
    return 1;
  end;

  return 0;
END; 