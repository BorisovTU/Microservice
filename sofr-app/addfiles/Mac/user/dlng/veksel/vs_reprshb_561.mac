/*
$Name:         vs_reprshb_561.mac
$Module:       Векселя банка
$Description:  Отчет по собственным векселям
*/

import oralib, likepy, globals, Календарь, vslib;
import cb_sql;  //dan  +SQL_ConvTypeStr
import or_tpl_h;  

private const LIGHT_GRAY = 12632256;

//Форма дохода по векселю
private const VS_FORMULA_PERCENT  = 1, //процентный
              VS_FORMULA_DISCOUNT = 0; //дисконтный (или бездоходный)

//плановая дата погашения векселя
private macro BnrPlanRepayDate (termformula, start:date, maturity:date, expiry:date, Basis)
  var repaydt = Date(0, 0, 0);
  if (termformula == VS_TERMF_FIXEDDAY) //на определенный день
    repaydt = maturity;
  elif (termformula == VS_TERMF_ATSIGHT) //по предъявлении
    if ( (valtype(expiry) != V_UNDEF) and (expiry != Date(0, 0, 0)) ) //есть дата не позднее
      repaydt = expiry;
    elif ( (valtype(maturity) != V_UNDEF) and (maturity != Date(0, 0, 0)) ) //есть дата не ранее
      repaydt = maturity + DaysInYearByBasis(Basis, Maturity, true);
    else
      repaydt = start + DaysInYearByBasis(Basis, ifThenElse(Maturity==Date(0, 0, 0), start, Maturity), true);
    end;
  end;
  return repaydt;
End;

//dan Получить статус векселя на дату
private macro GetBSStatusOnDate(p_bs_id, p_date)
  var sql = String( "declare\n" 
                   ,"  bs_id  number := :p_bs_id;\n"  
                   ,"  bshststatusid number := 0;\n"  
                   ,"  find_status varchar2(100) := '';\n"  
                   ,"  maxdate date := :p_maxdate;\n"  
                   ,"begin\n"  
                   ," select max(t_id) into bshststatusid from dvsbnrbck_dbt\n"  
                   ,"        where t_bcstatus = chr(88)\n"  
                   ,"          and t_bcid = bs_id\n"  
                   ,"          and t_changedate <= maxdate;\n"  
                   ," if bshststatusid > 0 then\n"  
                   ,"    select alg.t_sznamealg into find_status from dvsbnrbck_dbt vs, dnamealg_dbt alg\n"  
                   ,"      where vs.t_id = bshststatusid\n"  
                   ,"        and alg.t_itypealg = 3507\n" 
                   ,"        and alg.t_inumberalg = vs.t_newabcstatus\n"  
                   ,"        and vs.t_id = bshststatusid;\n"  
                   ,"   end if;\n"  
                   ,"  :find_status := find_status; \n"  
                   ,"--return find_status;\n"  
                   ,"--dbms_output.put_line(find_status);\n"  
                   ,"end;\n");
  var cmd = RSDCommand(sql);
      cmd.AddParam("p_bs_id", rsdbp_in, p_bs_id );
      cmd.AddParam("p_maxdate", rsdbp_in, p_date );
      cmd.AddParam("find_status", rsdbp_out, V_STRING );
  cmd.Execute;
  var status = SQL_ConvTypeStr((cmd.value("find_status")));
  if(status == "")
    status = "Отложен";
  end;
  return status;
end;


macro vs_report (repdate)
  var color = 12632256;
  var decsep = GetLocaleInfo (0, LOCALE_SDECIMAL, IsStandAlone ());
  var EXCEL_MONEY = "\"# ##0"+decsep+"00\"";
  var EXCEL_PERCENT = "\"# ##0"+decsep+"00%\"";
  var format_head = "c:ex_FS(b):ex_B(tblr):ex_BC("+color+")";
  var rn = 0;
  var sheet = 1;
  var DaysToRepay = 0;
  var Rep,csvFile,csvTable,fName, sql, depfltr:string = "";
  var IncludDeferred = False; // dan Включить отложенные BIQ-8217

  if ( (valtype(repdate) == V_UNDEF) or (repdate == Date(0, 0, 0)) )
    repdate = {curdate};
    if (not GetDate(repdate))
      return 1;
    end;
  end;
  if (msgboxex("Включить в отчет векселя в статусе \"Отложенный\"?", mb_YES + mb_NO, ind_NO, "Отбор отложенных векселей" ) == ind_YES) //dan BIQ-8217
    IncludDeferred = True;
  end;

  if ( {operdprt} != 1)
    depfltr = " where t_code = " + {operdprt};
  end;
  
  Rep = CTemplateXLS(NULL, NULL, NULL, NULL, NULL, NULL, true, false);
  if(Rep.UsePoi())
	Rep.SetXLSXFormat();
  end;
  
  Rep.CreateTotalBook();

  Rep.openTemplate("f_657_5_template.xlsx",true);
  Rep.SheetChange(1);
  

  csvTable = Rep.RegisterTable ("templateTable", "templateHeader", true);
  csvFile = C_CSVFile ();
  
  if (Rep.UseBigReport ())
      csvFile.SetLimitRow (FLUSH_COUNT_XLSX);
  end;
  
  Rep.SetValue_NameCell ("Date", "Портфель собственных векселей по состоянию за "+repdate + IIF(IncludDeferred, " (в том числе отложенные)", ""));

  Rep.CopyAllSheetInTotalBook (null, false, "templateHeader", 0, "template");

  fName = csvFile.CreateFullFileName ("f_657_5_csv.txt");
  csvFile.FileOpen (fName, true);

sql = " select Trim(t.t_bcseries) || ' ' || Trim(t.t_bcnumber) sernum, \n"
    + "       Trim(t.t_holdername) holdername, \n"
    + "       t.facevaluefi, \n"
    + "       t.fiid, \n"
    + "       t.t_issuedate, \n"
    + "       t.t_principal, \n"
    + "       case when t.t_formula = 0 and t.discount_all <> 0 then 'Д' else 'П' end as formula, \n"
    + "       t.discount_all, \n"
    + "       t.percent, \n"
    + "       t.termformula, \n"
    + "       t.maturity, \n"
    + "       t.expiry, \n"
    + "       t.basis, \n"
    + "       t.startdate, \n"
    + "       t.t_duration, \n"
    + "       nvl(t.t_bccost, 0) as t_bccost, \n"
    + "       (select nalg.t_sznamealg from dnamealg_dbt nalg where nalg.t_itypealg = 3507 and nalg.t_inumberalg = t.T_BCSTATUS) as t_status_vs, \n"
    + "       CASE WHEN t.T_BCSTATUS != 0 THEN nvl(t.t_ordernumber, chr(1)) ELSE chr(1) END as t_ordernumber, \n"
    + "       nvl(t.t_signdate, to_date('01010001','ddmmyyyy')) as t_signdate, \n"
    + "       nvl(t.body_acc, chr(1)) as body_acc , \n"
    + "       abs(rsi_rsb_account.RestAll(t.body_acc, 1, t.fiid, :dt, t.fiid)) body_rest, \n"
    + "       abs(rsi_rsb_account.RestAll(t.body_acc, 1, t.fiid, :dt, 0)) body_rest_natcur, \n"
    + "       t.pdd_acc, \n"
    + "       case when nvl((select t_changedate from dvsbnrbck_dbt where t_bcid = t.t_bcid and t_isbcstate = 'A' and instr(t_oldbcstate, 'И') = 0 and instr(t_newbcstate, 'И') > 0), to_date('31.12.9999', 'dd.mm.yyyy')) <= :dt \n"
    + "            then 0 \n"
    + "            else abs(rsi_rsb_account.RestAll(t.pdd_acc, 1, t.fiid, :dt, 0)) \n"
    + "       end pdd_rest_natcur, \n"
    + "       t.kor_down_acc, \n"
    + "       abs(rsi_rsb_account.RestAll(t.kor_down_acc, 1, 0, :dt)) kor_down_rest, \n"
    + "       t.kor_up_acc, \n"
    + "       abs(rsi_rsb_account.RestAll(t.kor_up_acc, 1, 0, :dt)) kor_up_rest, t.t_bcid \n"
    + "from (select bnr.t_bcseries, \n"
    + "             bnr.t_bcnumber, \n"
    + "             bnr.t_bcid, \n"
    + "             bnr.t_holdername, \n"
    + "             BNR.T_BCSTATUS, \n"
    + "             (select t_ccy from dfininstr_dbt where t_fi_kind = 1 and t_fiid = leg.t_pfi) facevaluefi, \n"
    + "             leg.t_pfi fiid, \n"
    + "             bnr.t_issuedate, \n"
    + "             leg.t_principal, \n"
    + "             leg.t_formula, \n"
    + "             leg.t_principal-leg.t_receiptamount discount_all, \n"
    + "             leg.t_price * power(10, -leg.t_point)/100 percent, \n"
    + "             bnr.t_bctermformula termformula, \n"
    + "             leg.t_maturity maturity, \n"
    + "             leg.t_expiry expiry, \n"
    + "             leg.t_basis basis, \n"
    + "             leg.t_start startdate, \n"
    + "             leg.t_duration, \n"
    + "             lnk.t_bccost, \n"
    + "             ord.t_ordernumber, \n"
    + "             ord.t_signdate, \n"
    + "             /*Счет учета вложений в вексель*/ \n"
    + "             (select t_account from dmcaccdoc_dbt \n"
    + "              where     t_dockind = 164 /*Первичный документ - Вексель*/ \n"
    + "                    and t_docid = bnr.t_bcid \n"
    + "                    and t_catnum = case when (select nvl(min(t_changedate), to_date('31.12.9999', 'dd.mm.yyyy')) \n"
    + "                                              from DVSBNRBCK_DBT \n"
    + "                                              where instr(t_newbcstate, 'И') > 0 and t_bcid = t_docid) <= :dt \n"
    + "                                        then 451 /*КУ - СВексель к исполнению*/ \n"
    + "                                        else 450 /*КУ - Наш вексель*/ \n"
    + "                                   end \n"
    + "                    and (:dt between t_activatedate and t_disablingdate-1 or  \n"
    + "                        (t_disablingdate = to_date('01.01.0001', 'dd.mm.yyyy') and t_activatedate <= :dt and t_isusable = chr(88)))  \n"
    + "                    and t_iscommon = chr(0)) body_acc, \n"
    + "             /*Счет учета начисленных процентов/дисконта*/ \n"
    + "             nvl((select t_account from dmcaccdoc_dbt \n"
    + "                  where     t_dockind = 164 \n"
    + "                        and t_docid = bnr.t_bcid \n"
    + "                        and t_catnum = case when (select nvl(min(t_changedate), to_date('31.12.9999', 'dd.mm.yyyy')) \n"
    + "                                                  from DVSBNRBCK_DBT \n"
    + "                                                  where instr(t_newbcstate, 'И') > 0 and t_bcid = t_docid) <= :dt then 451 /*КУ - СВексель к исполнению*/ \n"
    + "                                            when leg.t_formula = 1 then 452 /*КУ - Обяз%,СВексель*/ \n"
    + "                                            else 1384 /*КУ - Дисконт, Свексель*/ \n"
    + "                                       end  \n"
    + "                        and (:dt between t_activatedate and t_disablingdate-1 or  \n"
    + "                            (t_disablingdate = to_date('01.01.0001', 'dd.mm.yyyy') and t_activatedate <= :dt and t_isusable = chr(88)))  \n"
    + "                        and t_iscommon = chr(0)), ' ') pdd_acc, \n"
    + "             /*Корректировки, уменьшающие стоимость*/ \n"
    + "             nvl((select t_account from dmcaccdoc_dbt \n"
    + "                  where     t_dockind = 164 \n"
    + "                        and t_docid = bnr.t_bcid \n"
    + "                        and t_catnum = 1381 /*КУ - +Корр, Свексель*/  \n"
    + "                        and (:dt between t_activatedate and t_disablingdate-1 or  \n"
    + "                            (t_disablingdate = to_date('01.01.0001', 'dd.mm.yyyy') and t_activatedate <= :dt and t_isusable = chr(88))) \n"
    + "                        and t_iscommon = chr(0)), ' ') kor_down_acc, \n"
    + "             /*Корректировки, увеличивающие стоимость*/ \n"
    + "             nvl((select t_account from dmcaccdoc_dbt \n"
    + "                  where     t_dockind = 164 \n"
    + "                        and t_docid = bnr.t_bcid \n"
    + "                        and t_catnum = 1380 /*КУ - -Корр, Свексель*/ \n"
    + "                        and (:dt between t_activatedate and t_disablingdate-1 or  \n"
    + "                            (t_disablingdate = to_date('01.01.0001', 'dd.mm.yyyy') and t_activatedate <= :dt and t_isusable = chr(88)))  \n"
    + "                        and t_iscommon = chr(0)), ' ') kor_up_acc \n"
//dan BIQ-8217   + "      from ddl_leg_dbt leg, dvsordlnk_dbt lnk, ddl_order_dbt ord, dvsbanner_dbt bnr \n"
    + "      from ddl_leg_dbt leg,  dvsbanner_dbt bnr left join dvsordlnk_dbt lnk  on lnk.t_bcid = bnr.t_bcid and lnk.t_linkkind = 0/*Выдача*/ left join  ddl_order_dbt ord on lnk.t_contractid = ord.t_contractid \n"
    + "      where     bnr.t_bcformkind = 1 " + iif(not IncludDeferred, " and BNR.T_BCSTATUS != 0 \n", "")
    + "            and bnr.t_issuer in (select t_partyid from ddp_dep_dbt "+depfltr+") \n"
    + "            and leg.t_dealid = bnr.t_bcid \n"
    + "            and leg.t_legkind = 1 \n"
    + "            and leg.t_legid = 0 \n"
    + "            and ( (:dt between bnr.t_issuedate and (bnr.t_repaymentdate-1)) \n"
    + "                   or (bnr.t_repaymentdate = to_date('01.01.0001', 'dd.mm.yyyy') and bnr.t_issuedate <= :dt ) \n"
    + "                ) \n"
//dan BIQ-8217   + "            and lnk.t_bcid = bnr.t_bcid \n"
//dan BIQ-8217   + "            and lnk.t_linkkind = 0 /*Выдача*/ \n"
//dan BIQ-8217    + "            and lnk.t_contractid = ord.t_contractid \n"
    + "      order by body_acc, bnr.t_issuedate \n"
    + "   ) t \n";

  sql = ExecSqlSelect(sql, MakeArray(SqlParam("dt", repdate)), false);

  while (sql.MoveNext() )
    DaysToRepay = BnrPlanRepayDate(sql.value("termformula"),
                                   sql.value("startdate"),
                                   sql.value("maturity"),
                                   sql.value("expiry"),
                                   sql.value("basis")) - repdate;

    csvFile.AddCell(sql.value("holdername"));          // 1. Первый векселедержатель
    csvFile.AddCell(sql.value("facevaluefi"));           // 2. Валюта
    csvFile.AddCell(sql.value("formula"));               // 3. Тип дохода
    csvFile.AddCell(sql.value("percent"));                  // 4. Процентная ставка
    csvFile.AddCell(sql.value("sernum"));           // 5. Серия Номер
    csvFile.AddCell(sql.value("t_principal"));                 // 6. Номинал
    csvFile.AddCell(sql.value("t_issuedate", null, V_DATE)); // 7. Дата составления
    csvFile.AddCell(sql.value("t_signdate", null, V_DATE));  // 8. Дата Продажи
    csvFile.AddCell(VS_TermFormula(sql.value("termformula"),
                                    sql.value("maturity"),
                                    sql.value("expiry")));      // 9. Дата погашения
    csvFile.AddCell(int(sql.value("t_duration")));             // 10. Срок размещения
    csvFile.AddCell(sql.value("t_bccost"));                    // 11. Цена продажи
    csvFile.AddCell(GetBSStatusOnDate(sql.value("t_bcid"), repdate)); // 12. Статус +
    csvFile.AddCell(sql.value("body_acc"));          // 13. Балансовый счет
    csvFile.AddCell(sql.value("body_rest"));        // 14. Остаток счета в валюте номинала
    csvFile.AddCell(sql.value("body_rest_natcur")); // 15. Остаток счета в рублях
    csvFile.AddCell(sql.value("pdd_acc"));           // 16. Балансовый счет процентов/дисконта
    csvFile.AddCell(sql.value("pdd_rest_natcur"));  // 17. Остаток счета в рублях
    csvFile.AddCell(sql.value("kor_up_acc"));        // 18. Балансовый счет корректировки, увеличивающей стоимость векселя
    csvFile.AddCell(sql.value("kor_up_rest"));      // 19. Остаток счета в рублях
    csvFile.AddCell(sql.value("kor_down_acc"));      // 20. Балансовый счет корректировки, уменьшающей стоимость векселя
    csvFile.AddCell(sql.value("kor_down_rest"));    // 21. Остаток счета в рублях
    csvFile.AddCell(sql.value("discount_all"));         // 22. Дисконт при продаже
    csvFile.AddCell(DaysToRepay);                       // 23. Дней до погашения
    csvFile.AddCell("  ");                                // 24. Доходность к погашению
    csvFile.AddCell(sql.value("t_ordernumber"));        // 25. Номер договора
    csvFile.AddRow();
  end;
	csvFile.FileClose();
    csvTable.FillTabelFromCSV(csvFile.GetlsFileName());
    csvTable.EndTable();
    Rep.CopyAllSheetInTotalBook(null, false, csvTable.GetTableRange(), 0, "template");

    Rep.SetAutoFitTotalbook("F", Rep.SheetName());
    Rep.SetAutoFitTotalbook("N", Rep.SheetName());
    Rep.SetAutoFitTotalbook("O", Rep.SheetName());
    Rep.SetAutoFitTotalbook("Q", Rep.SheetName());
    Rep.SetAutoFitTotalbook("V", Rep.SheetName());

    Rep.Close();
    Rep.SaveTotalBook();
End;

vs_report();
exit(1);