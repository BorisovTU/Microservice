/***************************/
/*  Работа с сообщениями   */ 
/*                         */
/*                         */
/***************************/
import "dlcontrmsg.mac";

macro CheckExistMSG(pDlContrID:integer, pMsgKind:integer, pSendStatus:integer, pMarketID:integer)
   var sqls, cmds, ds;
   sqls = String( "select count(1) as msg_cnt  \n"
                 ,"  from ddlcontrmsg_dbt msg   \n"
                 ," where msg.t_dlcontrid = :pDlContrID   \n"
                 ,"   and msg.t_kind = :pMsgKind   \n"
                 ,"   and msg.t_sendmesstate = :pSendStatus  and msg.t_marketid = :pMarketID \n");
   cmds = DL_RSDCommand(sqls);
   cmds.AddParam(pDlContrID);
   cmds.AddParam(pMsgKind);
   cmds.AddParam(pSendStatus);
   cmds.AddParam(pMarketID);
   ds = cmds.Execute();
   if(ds.movenext)
    return ds.msg_cnt
   end; 

return 0;
onerror(err)
  return 0;
end;

private macro GetDlContrMsg(dlcontrid:integer, msg_type:integer, msg_status:integer, dlcontrmsg:@variant)
 var sql, cmd, rs;
    sql = "select * from ddlcontrmsg_dbt where t_dlcontrid = :p_dlcontrid and t_kind = :p_kind and t_sendmesstate = :p_msg_status";

    cmd = DL_RSDCommand(sql);
    cmd.AddParam(dlcontrid);
    cmd.AddParam(msg_type);
    cmd.AddParam(msg_status);

    rs = cmd.Execute();
    if(rs.movenext)
      rs.GetRecord().CopyTo(dlcontrmsg.rec);
      return 1;
    end;
    return 0;
 onerror(err)
   return 0;
end;

private macro GetDlContrMsgInArch(dlcontrid:integer, msg_type:integer, dlcontrmsg:@variant)
 var sql, cmd, rs;
    sql = "select * from ddlcontrmsg_dbt where t_dlcontrid = :p_dlcontrid and t_kind = to_number('999'||:p_kind) order by t_id desc";

    cmd = DL_RSDCommand(sql);
    cmd.AddParam(dlcontrid);
    cmd.AddParam(msg_type);
    

    rs = cmd.Execute();
    if(rs.movenext)
      rs.GetRecord().CopyTo(dlcontrmsg.rec);
      return 1;
    end;
    return 0;
 onerror(err)
   return 0;
end;


private macro SetDlContrStatus()
end;

private macro ChangeDlContrMsgKind(DlContrMsgID, NewMsgKind)
   var sql, cmd;
   sql = "Update ddlcontrmsg_dbt set t_kind = :pKind where t_id = :pDlContrMsgID";
 
   cmd = RSDCommand(sql);
   cmd.AddParam("pKind", rsdbp_in, NewMsgKind);
   cmd.AddParam("pDlContrMsgID", rsdbp_in, DlContrMsgID);
   cmd.Execute;

   return 1;

 onerror(er)
   return 0;
end;

Private macro PutMsgInArch(pDlContrID:integer, pMsgKind:integer, pStateToSearch:integer)
   var stat; 
   var dlcontrmsg = TRecHandler("dlcontrmsg.dbt");
   var dlcontrmsgid;

   for
      dlcontrmsg = TRecHandler("dlcontrmsg.dbt");
      stat = GetDlContrMsg(pDlContrID, pMsgKind, pStateToSearch, @dlcontrmsg);
      if (not stat)
         dlcontrmsg = null;    
         break;   
      else 
         dlcontrmsgid = dlcontrmsg.rec.id;
         dlcontrmsg = null;    
         ChangeDlContrMsgKind(dlcontrmsgid, int(string("999",pMsgKind)));
      end;   
   end;

end;

Private macro RestoreMsgFromArch(pDlContrID:integer, pMsgKind:integer)
   var stat; 
   var dlcontrmsg = TRecHandler("dlcontrmsg.dbt");
   var dlcontrmsgid;

   for 
      stat = GetDlContrMsgInArch(pDlContrID, pMsgKind, @dlcontrmsg);
      if (not stat)
         dlcontrmsg = null;    
         break;   
      else 
         dlcontrmsgid = dlcontrmsg.rec.id;
         dlcontrmsg = null;    
         ChangeDlContrMsgKind(dlcontrmsgid, pMsgKind);
      end;   
   end;

end;

macro usr_ReCreateMSG(DlContrID:integer, MarketID:integer, MsgKind:integer)
   var dlContrF = TRecHandler("dlcontr.dbt"), sfContrF = TRecHandler("sfcontr.dbt"), dlContrMpF = TRecHandler("dlcontrmp.dbt");

   var stat;

   var queryF = " SELECT DLCONTR.* FROM DDLCONTR_DBT DLCONTR WHERE DLCONTR.T_DLCONTRID = " + DlContrID;
   var cmdF = DL_RSDCommand(queryF);
   var dsF = cmdF.Execute();
   while(dsF.moveNext())
      dlcontrF.Clear();
      dsF.GetRecord().CopyTo( dlcontrF.rec);
      queryF = " SELECT DLCONTRMP.* FROM DDLCONTRMP_DBT DLCONTRMP WHERE DLCONTRMP.T_DLCONTRID = " + DlContrID + " AND DLCONTRMP.T_MARKETID = " + MarketID;
      cmdF = DL_RSDCommand(queryF);
      dsF = cmdF.Execute();
      while(dsF.moveNext())
         dlcontrMpF.Clear();
         dsF.GetRecord().CopyTo( dlcontrMpF.rec);   
         queryF = " SELECT DSFCONTR.* FROM DSFCONTR_DBT DSFCONTR WHERE DSFCONTR.T_ID = " + dlContrMpF.rec.SFContrID ;
         cmdF = DL_RSDCommand(queryF);
         dsF = cmdF.Execute();
         while(dsF.moveNext())
            sfContrF.Clear();
            dsF.GetRecord().CopyTo( sfContrF.rec);   
         end;
      end;
   end;

   PutMsgInArch(DlContrID, MsgKind, 300);
   PutMsgInArch(DlContrID, MsgKind, 302);
   PutMsgInArch(DlContrID, MsgKind, 305);
   PutMsgInArch(DlContrID, MsgKind, 310);

   stat = DL_AddDlContrGenMes(MsgKind, dlContrMpF.rec.ID, dlContrMpF.rec.MarketID);

    var KUT = DL_GetDlObjCodeOnDate(OBJTYPE_BROKERCONTR_DL, DLCCK_SPB_BIDCODE, DlContrID/*, m_SfContr.rec.DateBegin*/);
    if(KUT == "")
        stat = 1;
        msgbox("Для договора \"" + sfContrF.rec.Number + "\" на ДБО не задан КУТ");
    end;

   if(stat == 0)
      stat = СоздатьСообщениеДБО_СПБ(MsgKind, dlContrMpF.rec.MarketID, DlContrF, SfContrF, null, dlContrMpF.rec.ID);
   end;
   if(stat != 0)
     //RestoreMsgFromArch(DlContrID, MsgKind);
   end;
   SQL_Execute("DELETE FROM DDLCONTRGENMSG_TMP");

end;


//usr_ReCreateMSG(9888, 151337, 10);


