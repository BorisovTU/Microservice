import RSD;
import OprInter, PTInter, PaymInter, CTInter, SPInter, sp_class, "dpimp.mac" , "spRepFun.mac";
import RsbDataSet;
import sfinter, rsd, sp_car, activex, or_rep_h;
import "dlcontrmsg.mac";                                 
import "usr_msg_lib.mac";


private macro print_line(str1, str2)
  [Обработка договора: #############  : #################################################################################################]( str1,str2);  
end;

private macro FindDBO(DBO_NUM:string, DBO_ID:@integer)
   var sqls = String( "select dlc.t_dlcontrid   \n"
                     ,"  from ddlcontr_dbt dlc, dsfcontr_dbt sfc   \n"
                     ," where sfc.t_id = dlc.t_sfcontrid   \n"
                     ,"   and sfc.t_number = ?   and sfc.t_dateclose = to_date('01010001','ddmmyyyy')\n");
   var cmd = RSDCommand(sqls);
       cmd.AddParam("", rsdbp_in, DBO_NUM);
   var rs = RSDRecordset(cmd, 1, 1);
       if(rs.movenext)
          DBO_ID = rs.value("t_dlcontrid");
          return 1;
       end;
   return 0;
end;

private macro FindOpenSPB(dbo_id:integer, sf_id:@integer)
   var sqls = String( "select sfc.t_id   \n"
                     ,"  from ddlcontrmp_dbt mp, dsfcontr_dbt sfc   \n"
                     ," where sfc.t_id = mp.t_sfcontrid   \n"
                     ,"   and mp.t_dlcontrid = ?   \n"
                     ,"   and mp.t_marketid = 151337   \n"
                     ,"   and sfc.t_dateclose = to_date('01010001', 'ddmmyyyy')   \n");
   var cmd = RSDCommand(sqls);
       cmd.AddParam("", rsdbp_in, dbo_id);
   var rs = RSDRecordset(cmd, 1, 1);
       if(rs.movenext)
          sf_id = rs.value("t_id");
          return 1;
       end;
   return 0;
end;


private macro ResendMSG(msgID)
  return DlRepeatSendWithAddCode(msgid);
onerror(err)
  return 1;
end;


macro ProcMsgSPBByList()

  var err, errstr;
  var FullNameFile = "", file_xlsx, pFileName  ,ExtName, DirName, Sheet, range, i = 1, j = 1, cnt = 0, SF_NUM = "", number = "", InputDir = "";
  var pr_cnt = 0;
  var Reopen310 = False;

  println ("Подготовка: " + err + " " + errstr);


  if (not err)

      InputDir = "..\\Import\\";
      if(not SelectFile(FullNameFile, InputDir + "ProcMsgSPB_*.xls*", "Выберите файл для загрузки", 0, true))
        MsgBox("Отказ от загрузки");
        return false;
      else
         splitfile(FullNameFile, pFileName, ExtName);
         pFileName = pFileName + ExtName;
         println ("Обработка файла: " + pFileName);
         DirName = substr(FullNameFile, 1, index(FullNameFile, pFileName) - 1);

         if(not OpenExcelFile(pFileName, false, true, DirName))
           MsgBox("Ошибка открытия файла \"" + FullNameFile + "\"");
           return false;
         end;

         j = 1;
         while(j <= ExcelApplication.Sheets.Count)
            Sheet = ExcelApplication.Sheets(j);
            i = 1;
            while (ValType(Sheet.Cells(i, 1).Value) != V_UNDEF)
              i = i + 1;
            end;
            j = j+1;
         end;//

         pr_cnt = i;

         if(Gettrue(false,"Переотправлять подтвержденные сообщения?"))
           Reopen310 = True;
         end;

         j = 1;
         while(j <= ExcelApplication.Sheets.Count)

            Sheet = ExcelApplication.Sheets(j);
            i = 1;
            InitProgress(pr_cnt-1, "Ждите...", "Обработка сообщений");
            while (ValType(Sheet.Cells(i, 1).Value) != V_UNDEF)

              SF_NUM = string(Sheet.Cells(i, 1).Value:0:0);
              var dboid = 0;
              if (FindDBO(SF_NUM, @dboid))
                 print_line(SF_NUM, "Договор найден");
                 err = 0;
              else 
                 err = 1;
              end;

              var spbsfopenid = 0; 
              if (not err)
                if(not FindOpenSPB(dboid,@spbsfopenid)) 
                     print_line( SF_NUM,"Ошибка. Для ДБО отсутствует открытая площадка на СПБ");
                     err = 1;
                end;
              end;

               if(not err)
                   var stat;
                   if ((not CheckExistMSG(dboid, 10,310, 151337)) or (Reopen310))
                     err = usr_ReCreateMSG(dboid, 151337, 10); 
                   end;

                   if(err)
                     print_line( SF_NUM,"Ошибка формирования сообщения");
                   else
                     print_line( SF_NUM,"ОК. Соощение сформировано повторно");
                     cnt = cnt + 1;
                   end;
                 //end;
              end;

              print_line( SF_NUM,"Обработка завершена");

              i = i + 1;
              UseProgress(i);
            end;
            RemProgress();
            msgbox("Обработка завершена");
            j = j+1;
         end;//


      end; //




  end;
  return cnt ;
end;