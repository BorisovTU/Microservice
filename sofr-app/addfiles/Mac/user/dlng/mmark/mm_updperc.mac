/*
$Name: mm_updperc.mac
$Module: МБК
$Description: Актуализация начисленных процентов после доср. погашения
*/
IMPORT mmlibr;

macro MM_UpdPercPm(DealID)
   var que, rs, rs2;
   // обновление сумм платежей в соответствии с проводками по инкассовым поручениям
   que="select t_paymentid, t_valuedate from dpmpaym_dbt where t_dockind=" + DL_IBCDOC + " and t_documentid=" + DealID + " and t_purpose=11  and t_paymstatus not in (0, 1000)";
   rs = LnGetRecordSet(que);
   if (rs != null)
     while(rs.moveNext())
        que = "select trn.t_acctrnid, trn.t_date_carry, trn.t_sum_payer from dacctrn_dbt trn " +
               "inner join doprdocs_dbt oprdocs on oprdocs.t_dockind=1 and oprdocs.t_acctrnid=trn.t_acctrnid " +
               "inner join doprstep_dbt oprstep on oprdocs.t_id_operation = oprstep.t_id_operation and oprdocs.t_id_step = oprstep.t_id_step " +
               "inner join doproper_dbt oproper on oprdocs.t_id_operation = oproper.t_id_operation " +
                     "where oproper.t_dockind=" + DL_IBCDOC + " and oproper.t_documentid = lpad(" + DealID + ", 34, 0) and  oprstep.t_symbol='U' and trn.t_date_carry = " + GetSQLDate(rs.value("t_valuedate") + " and trn.t_Number_Pack = 170") +
              " order by trn.t_sum_payer DESC";

         rs2 = LnGetRecordSet(que);
         if (rs2 != null)
            if(rs2.moveNext())  // берем первую проводку
                 que = "update dpmpaym_dbt SET t_FUTUREPAYERAMOUNT ="+rs2.value("t_sum_payer")+", t_FUTURERECEIVERAMOUNT = "+rs2.value("t_sum_payer")+",  t_AMOUNT = "+rs2.value("t_sum_payer")+", t_BASEAMOUNT = "+rs2.value("t_sum_payer")+", t_PAYAMOUNT ="+rs2.value("t_sum_payer")+
                                " where t_paymentid = " + rs.value("t_paymentid") ;
                 LnGetRecordSet(que);
            end;
         end;
     end;

   end;
end;

private macro GetSumCreditDebet(Chapter, PFI, Account, isCredit)
  var que, rs, result = $0;
  if (isCredit)
     que = "select sum(t_credit) as t_sum ";
   else
      que = "select sum(t_debet) as t_sum ";
   end;
   que = que + "from drestdate_dbt rd, daccount_dbt acc where acc.t_Account = '" + account  + "' and acc.t_Chapter = " + Chapter + " and acc.t_Code_Currency =" + PFI + " and acc.t_AccountID = rd.t_AccountID and rd.t_restCurrency = "  + PFI;
   rs = LnGetRecordSet(que);
   if (rs != null)
     if(rs.moveNext())              
       result = rs.value("t_sum");
     end;
   end;

   return result;

end;

macro MM_UpdPrcSched(DealID)
  var que, rs, rs2, deal_pd, cat, sumPerc, diff, percAccount = "", isCredit = false;;
  // ищем последнюю дату начисления процентов
  que = "select max(t_datereal) as t_datereal from DPRCCNTSCHED_DBT where t_SumCalc != 0 and t_schedulekind = 2 and t_datereal <> to_date('01.01.0001','dd.mm.yyyy') and t_contractid in (select t_contractid from dprccontract_dbt where t_contracttype = 7 and t_objectid in (select t_dealcode from ddl_tick_dbt where t_dealid = " + DealID+ "))";
  rs = LnGetRecordSet(que);
   if (rs != null)
     if(rs.moveNext()) 
         deal_pd = MMFirstDoc(DL_IBCDOC, DealID, true);
         if (isSale(GetOperationGroup(deal_pd.GetTick().DealType)))
            cat = tdr_claimR;
            isCredit = false;
         else
            cat = tdr_claimP;
            isCredit = true;
         end;
         // сравниваем остаток на счете учета процентов и сумму в графике начислений
         //sumPerc = ABS(deal_pd.GetRestAccount(cat, date(rs.value("t_datereal")), deal_pd.GetLeg().PFI, 1));
         deal_pd.FindNumberAccount(cat, percAccount, null, null, deal_pd.GetLeg().PFI);
         if (percAccount == "")
           return;
         end;
         sumPerc = GetSumCreditDebet(1, deal_pd.GetLeg().PFI, percAccount, isCredit);
         if (sumPerc == 0)
           return;
         end;

         que = "select  sum( t_sumcalc) as t_sumcalc from DPRCCNTSCHED_DBT where t_schedulekind = 2 and t_datereal <> to_date('01.01.0001','dd.mm.yyyy') and t_contractid in (select t_contractid from dprccontract_dbt where t_contracttype = 7 and t_objectid in (select t_dealcode from ddl_tick_dbt where t_dealid = " + DealID+ "))";
         rs2 = LnGetRecordSet(que);
         if (rs2 != null)
            if(rs2.moveNext())     
               if (sumPerc != rs2.value("t_sumcalc"))
                   diff = rs2.value("t_sumcalc") - sumPerc;
                   que = "update DPRCCNTSCHED_DBT set t_sumCalc = (t_sumCalc - " + diff + ") where t_schedulekind = 2 and t_datereal = " +  GetSQLDate(date(rs.value("t_datereal")))  + " and t_contractid in (select t_contractid from dprccontract_dbt where t_contracttype = 7 and t_objectid in (select t_dealcode from ddl_tick_dbt where t_dealid = " + DealID+ "))";
                   LnGetRecordSet(que);                                                                                                                    

               end;
            end;
         end;

     end;
   end;         
end;
