IMPORT fx_globals,funk,"cb_sql.mac",OprInter,mmcarry,mmcnst_j,mmlibr,dl_lib,dl_plat,dl_platv;
array mas;

  RECORD deal2(dl_tick);
  record leg2 (dl_leg);



macro par_ground(pa1)
 private var que,srez,rs51;
   srez=" ";
   que="select t_ground from dpmrmprop_dbt   where t_paymentid="+pa1;
   rs51 = LnGetRecordSet(que);
   if(rs51 != null)
     if (rs51.moveNext) 
        srez=rs51.value(0);
     end;
   end;
 return srez;
end;




MACRO ExecuteStep(Buffer, Document)
  private var que,si,rs,ss,debet,credit,d1,d0,ss1,s1,np,ku,nbank,rs9,rs05,rs5,rs51,{curdate}, ssu0,sunp,newsu,dda,ppaymentid,Debet0,Credit0,   
  SumComm,SumComm2,CurComm,ss0,ss01,plid,gensog=" " ;
  private var i,Document1,prol;
  var  at = MM_Carry;

  var FirstDoc = NULL;
  SetBuff( deal2, Document );
  FirstDoc = MMFirstDoc(DL_IBCDOC, deal2.DealID, true);

        if (( deal2.partyid  == _BANK_RF ) and isBuy(GetOperationGroup(deal2.dealtype)))
         dda=СДАТ({curdate});  

         que = "select COUNT(*) from dpmpaym_dbt a , dpmrmprop_dbt  b   where rownum=1 and   a.t_fiid=0 and a.t_receiveraccount='30102810700000000001'"; 
         que= que+" and to_char(a.t_valuedate,'dd.mm.yyyy')='"+СДАТ({curdate})+"' and b.t_paymentid=a.t_paymentid and b.t_ground like '%"+deal2.dealcode+"%' and b.t_ground like '%процент%'";
         rs5 = LnGetRecordSet(que);

         if(rs5 != null)
           if (rs5.moveNext) 
             // --
                                   if (int(rs5.value(0)) > 0 )

              que = "select a.t_baseamount amount,a.t_payeraccount acc,b.t_number nom from dpmpaym_dbt a , dpmrmprop_dbt  b   where rownum=1 and   a.t_fiid=0 and a.t_receiveraccount='30102810700000000001'"; 
              que= que+" and to_char(a.t_valuedate,'dd.mm.yyyy')='"+СДАТ({curdate})+"' and b.t_paymentid=a.t_paymentid and b.t_ground like '%"+deal2.dealcode+"%' and b.t_ground like '%процент%'";
              rs51 = LnGetRecordSet(que);
              if(rs51 != null)
                if (rs51.moveNext) 
                  sunp=MM_acc(deal2.dealid,118);
                  newsu=ABS(rs51.value("amount"));
                  ssu0=abs(execmacrofile("calculate.mac", "RestA_", sunp, {curdate}, 1, 0)) ;
                  // msgbox(sunp," ",newsu," ",ssu0);
                  SumComm=newsu;

	  	  if (not СчетСделки("-% к погашению", FirstDoc, Debet0)) 
        		  return false; 
    		  end; 



	  	  if (not СчетСделки("-%, Кр0", FirstDoc, Credit0)) 
        		  return false; 
    		  end; 


/*

     if(not FirstDoc.OpenAccount("+РС, кредиты%000", Credit0, NULL, FirstDoc.GetFIRoleByCategory("+РС, кредиты%000", 0), NULL, {curdate}, 0))
        return 1;
     end;    

 */


                  if ( newsu != ssu0 )

                      if ( ssu0 > newsu)
                         at.AccountPayer    =  debet0;
                         at.AccountReceiver  = Credit0;

                      else
                        at.AccountPayer    = Credit0;
                        at.AccountReceiver  = debet0;
                      end;


                      ssu0=abs(ssu0-newsu);
                      

          at.Numb_Document   = deal2.dealid;
          at.FIIDPayer      = NATCUR;
          at.FIIDReceiver   = NATCUR;
          at.SumPayer       = ssu0;
          at.SumReceiver    = ssu0;
          at.Number_Pack    = 60;
          at.Chapter        = 1;
          at.Ground         = "Корректировка начисления процентов по кредиту Банка России No "+deal2.dealcode+" от "+СДАТ(deal2.dealdate);

          if(not at.carry())
            msgbox("Ошибка формирования проводки !");
            return false;
         end;


                     ppaymentid=plat_dil0(deal2.dealid,102,"11",dda,"paymentid");
                     que = "update dpmpaym_dbt SET t_FUTUREPAYERAMOUNT = '"+newsu+"' ,  t_FUTURERECEIVERAMOUNT = '"+newsu+"' ,  t_AMOUNT = '"+newsu+"' , t_BASEAMOUNT = '"+newsu+"' ,  t_PAYAMOUNT ='"+newsu+"'";
                     que=que+" where t_paymentid ="+ ppaymentid; 
                     rs = LnGetRecordSet(que);
                  end;
                end;

               end;

             end;
             // --
                             else
                             msgbox("Не загружено инкассовое поручение !  Cделка "+deal2.dealcode);
                             println("Не загружено инкассовое поручение !  Cделка "+deal2.dealcode);
                             return 1;

           end;
         end;








          at.Numb_Document   = ppaymentid;
          at.AccountPayer    = debet0;	  
	  
          at.AccountReceiver = account_corr(0,_BANK_RF);
          at.FIIDPayer      = NATCUR;
          at.FIIDReceiver   = NATCUR;
          at.SumPayer       = SumComm;
          at.SumReceiver    = SumComm;
          at.Number_Pack    = 63;
          at.Chapter        = 1;
          at.Ground         = mm_ground(deal2.dealid,11);
          if(not at.carry())
            msgbox("Ошибка формирования проводки !");
            return false;
         end;

                                   end;


  return 0;
END;



MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -откат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */  



  RECORD tick (dl_tick);


  private var que,rs1,rs9,rs,idsd,acctrnid,kod,paymentid=0,kod2,ii,pur=11,dockind,kod322,acc10=" ",ground2=" ",acc01,ppaym;
  SetBuff(tick, FirstDoc );



      que="select b.t_paymentid, c.t_purpose,c.t_dockind,c.t_userfield4, c.t_receiveraccount from doprdocs_dbt a, dpmdocs_dbt b, dpmpaym_dbt c  where c.t_paymentid=b.t_paymentid and  a.t_id_operation="+ID_Operation+" and a.t_id_step="+ID_Step+" and a.t_acctrnid > 0  and b.t_acctrnid=a.t_acctrnid ";
      rs9 = LnGetRecordSet(que);
      if(rs9 != null)
        if (rs9.moveNext) 
           paymentid=rs9.value(0);
           pur=rs9.value(1);
           dockind=rs9.value(2);
           kod322=rs9.value(3);
           acc10=substr(rs9.value(4),1,5);
           ground2=par_ground(paymentid);


        end;
      end;



  if (( CommitOrRollback == 1 )  and  (tick.partyid == _BANK_RF) and  isBuy(GetOperationGroup(tick.dealtype)) and pur== 11 )
      idsd=tick.dealid;
      que = "select a.t_userfield4,a.t_baseamount,a.t_paymentid from dpmpaym_dbt a , dpmrmprop_dbt  b   where rownum=1 and   a.t_fiid=0 and a.t_receiveraccount='30102810700000000001'"; 
      que= que+" and to_char(a.t_valuedate,'dd.mm.yyyy')='"+СДАТ({curdate})+"' and b.t_paymentid=a.t_paymentid and b.t_ground like '%"+tick.dealcode+"%' and (b.t_ground like '%процент%')  ";

      rs9 = LnGetRecordSet(que);
      if(rs9 != null)
        if (rs9.moveNext) 
          kod=rs9.value(0);
          ii=index(kod,"#");

          if ( ii > 0 )
           kod2=substr(kod,1,ii-1);
          else
           kod2=kod;
          end;
          que="select a.t_acctrnid from doprdocs_dbt a, dacctrn_dbt b  where a.t_id_operation="+ID_Operation+" and a.t_id_step="+ID_Step+" and a.t_acctrnid > 0 ";
          que=que+" and b.t_acctrnid=a.t_acctrnid and substr(b.t_account_receiver,1,5)='30102' "; 
          rs1 = LnGetRecordSet(que);
          if(rs1 != null)
            if (rs1.moveNext) 
               acctrnid=rs1.value(0);
               que="update dacctrn_dbt set  T_NUMB_DOCUMENT='"+kod2+"',  t_shifr_oper='01', t_kind_oper='06', t_userfield3='1', t_Number_Pack=170, t_userfield1='ENCASH:"+kod+"' where t_acctrnid="+acctrnid;
               rs = LnGetRecordSet(que);

               que="update dpmdocs_dbt  set t_acctrnid=0 where t_paymentid="+paymentid;
               rs = LnGetRecordSet(que);


               que="update dpmpaym_dbt set t_paymstatus=2995, t_tobackoffice='J' where t_paymentid="+rs9.value(2);
               rs = LnGetRecordSet(que);

               ppaym=plat_dil0(tick.dealid,102,"11",СДАТ({curdate}),"paymentid");
               que="update dpmpaym_dbt  set t_paymstatus=32000 where t_paymentid="+ppaym;
               rs = LnGetRecordSet(que);

            end;
          end;

        end;
      end;

   end;


  if (( CommitOrRollback == 2 )  and  (tick.partyid == _BANK_RF) and  isBuy(GetOperationGroup(tick.dealtype)) and pur== 11 )
               ppaym=plat_dil0(tick.dealid,102,"11",СДАТ({curdate}),"paymentid");
               que="update dpmpaym_dbt  set t_paymstatus=1000 where t_paymentid="+ppaym;
               rs = LnGetRecordSet(que);

  end;

  return 0;

END;


