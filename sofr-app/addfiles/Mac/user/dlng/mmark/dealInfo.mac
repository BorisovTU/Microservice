
/*-------------------------------------------------------------------------

  Имя файла : dealInfo.mac 

  Описание  : Информация о сделках КО и МБК и участвующих в них сторонах

  Программист : Селезнёв Роман

  Создан    : 12.02.2008

        Модификация     : 16.11.2009


-------------------------------------------------------------------------*/


import CTInter, globals,fx_globals, oralib, likepy, cb_sql, dlgCommon, DateLib, CommonInfo, PTInter, StringLib;


// Номер примечания на субъекте экономики, используемый для хранения комиссии брокера
const Примечание_КомиссияБрокеруПроцент = 203;  

// Типы сделок для нумерации
const DEAL_INFO_TYPE_FOREX = 0;
const DEAL_INFO_TYPE_CASH  = 1;
const DEAL_INFO_TYPE_NETT  = 2;
const DEAL_INFO_TYPE_SWAP  = 3;


/************************************** Данные сделок *************************************/

private macro GetLastNum(partyId):Integer
//      var sql = " select nvl(max( (substr(lpad(t_dealCode, 20, '0'), length(lpad(t_dealCode, 20, '0'))-3)) ), 0) tail  from ddl_tick_dbt where t_partyId = :partyId and t_bOfficeKind = 100; ";
   var sql = " select max(tail) tail from ( "
        + " select nvl(max( (substr(lpad(t_dealCode, 20, '0'), length(lpad(t_dealCode, 20, '0'))-3)) ), 0) tail   " 
        + " from ddl_tick_dbt where t_partyId = :partyId11 and t_bOfficeKind = 100 " 
        + " union " 
        + " select nvl(max( (substr(lpad(t_dealNumber, 20, '0'), length(lpad(t_dealNumber, 20, '0'))-3)) ), 0) tail   " 
        + " from ddl_nett_dbt where t_contractor = :partyId12 and t_DocKind = 140 " 
        + " ) " ;

   var params = MakeArray(SQLParam("partyId11", partyId), SQLParam("partyId12", partyId));    
 
   var rs = ExecSQLSelect(sql, params, false); 
   if(rs.MoveNext())
      return rs.value(0);   
   end;
   return 0;
end;

macro GetNextNum(partyID)
  var tmp = 1 + GetLastNum(partyId);
  tmp = string(tmp);
  tmp = StrLeftPad(tmp, 4, "0");
  tmp = StrRight(tmp, 4);
  return tmp;
end;

macro IsDealCodeExist(DealID, BofficeKind, DealCode)
  var sql;
  if(valtype(DealID) == V_UNDEF)
    DealID = 0;
  end;
  if(BofficeKind == 140)
    sql = "select count(*) t_cnt from ddl_nett_dbt where t_NettingID != :DealID and substr(t_DealNumber, 9) = substr(:DealCode, 9) and t_DocKind = :BOF";
  elif(BofficeKind == 100)
    sql = "select count(*) t_cnt from ddl_tick_dbt where t_DealID != :DealID and substr(t_DealCode, 9) = substr(:DealCode, 9) and t_BofficeKind = :BOF";
  elif(BofficeKind == 102)
    sql = "select count(*) t_cnt from ddl_tick_dbt where t_DealID != :DealID and substr(t_DealCode, 9) = substr(:DealCode, 9) and t_BofficeKind = :BOF";
  end;
  sql = ExecSQLSelect(sql, MakeArray(SQLParam("DealID", DealID), SQLParam("DealCode", DealCode), SQLParam("BOF", BofficeKind)), false);
  return (sql.MoveNext() and sql.value("t_cnt"))
end;

//
// Сгенерировать номер сделки КО
//
macro diGenDealNumber(partyId, dealType, dealDate, DealCodeTS)
   var num = "??";
   var tmp = "";
 
   // <2 буквы(FX для форексных сделок; BN для банкнотных сделок; NT для неттинга>
   if(DEAL_INFO_TYPE_FOREX == dealType)
      num = "FX";
   elif(DEAL_INFO_TYPE_CASH == dealType)
      num = "BN";
   elif(DEAL_INFO_TYPE_SWAP == dealType)
      num = "SW";
   elif(DEAL_INFO_TYPE_NETT == dealType)
      num = "NT";
   end;
 
   // <6 знаков: ДДММГГ> 
   var dd, mm, yyyy;
   DateSplit(date(dealDate), dd, mm, yyyy); 
   tmp = string(dd:2:o, mm:2:o, (yyyy-2000):2:o); 
   num = num + tmp; 

   // <4 знака: код клиента вида 1>   
   tmp = ПолучитьКодСубъекта (partyId, 1);
   tmp = StrLeftPad(tmp, 4, "0");
   tmp = StrRight(tmp, 4);
   num = num + tmp;
  
   // <4 знака: Номер сделки по порядку по клиенту по сделкам FX, включая банкнотные сделки и неттинги>
   if((Valtype(DealCodeTS) == V_UNDEF) or (int(DealCodeTS) == 0))
     tmp = 1 + GetLastNum(partyId);
   else
     tmp = int(DealCodeTS);
   end;
   tmp = string(tmp);
   tmp = StrLeftPad(tmp, 4, "0");
   tmp = StrRight(tmp, 4);
   num = num + tmp;

   return num;
end; 

//
// Получить имя транспорта подтверждения по его id
// tId -- Id транспорта (ddl_tick_dbt.t_confTpId)
//
private macro GetTransport(tId)
   var sql = "select t_name from dwltransp_dbt where t_tPid=:id";
   var params = MakeArray(SQLParam("id", tId)); 

   var rs = ExecSQLSelect(sql, params, false);
   if(rs.MoveNext())
      return rs.value(0);   
   end;
   return "";
end;


//
// Получить происхождение сделки 
// originId -- Id происхождения (ddl_tick_dbt.t_originId)
//
private macro GetOrigin(originId)
   if( 0 == originId )
      return "Внутренняя";
   end;

   var sql = "select t_applicationName from drg_app_dbt where t_applicationId=:appId";
   var params = MakeArray(SQLParam("appId", originId)); 

   var rs = ExecSQLSelect(sql, params, false);
   if(rs.MoveNext())
      return rs.value(0);   
   end;

   return "";
end;
  

//
// Получить прикреплённый к сделке КО/МБК счёт по имени категории учёта и Id сделки/ЦУ сделки
//
MACRO ПолучитьПрикреплённыйСчётПоКУ(nkat, dealId);
   var params:TArray;
   

   var sql = "select t_id from dmccateg_dbt  where  t_code=:cat";
   params = MakeArray(SQLParam("cat", nkat)); 
   var res = ExecSQLSelect(sql, params, false);               


   if(res.MoveNext())     
      sql = "select t_account from dmcaccdoc_dbt where t_dockind in (100, 102, 175) and t_docid=:doc and t_catid=:cat";
 
      params = MakeArray(SQLParam("doc", string(dealId)), SQLParam("cat", string(res.value(0)))); 
      res = ExecSQLSelect(sql, params, false);              

      if(res.MoveNext())  
         return res.value(0);
      end;         
   end;

   return "";
END;



//
// Получить плательщика и получателя по сделке
//
macro ПолучитьПлательщикаИПолучателяПоСделке(agent, contagent, dealID, agentBank, contagentBank, purp, agentAcc, contragentAcc)
 /*  var MbkPurp;

   if(V_UNDEF == valType(purpMbk))
      MbkPurp = 9;
   else
      MbkPurp = purpMbk;
   end;
  */

   var sql = " select pmnt.t_payer, pmnt.t_receiver, pmnt.t_payerBankId, pmnt.t_receiverBankId, pmnt.t_payerAccount, pmnt.t_receiverAccount "
            +" from dPmPaym_dbt pmnt " 
            +" where pmnt.t_documentId=:doc and pmnt.t_docKind in (100, 102) and pmnt.t_Purpose = " + purp;

 
   var params:TArray;
   params = MakeArray(SQLParam("doc", dealID));

   var res = ExecSQLSelect(sql, params, false);

   if(res.MoveNext())      

      SetParm(0, res.value(0));
      SetParm(1, res.value(1));
      SetParm(3, res.value(2));
      SetParm(4, res.value(3));
      SetParm(6, res.value(4));
      SetParm(7, res.value(5));

      return true;
   end; 

   return false;
end;

/************************* Генсоглашения *************

//
// Получить дату генерального соглашения
//
macro GetGenDateBySubj(subj)  : Date
   var sql = " select note.t_date from dNoteText_dbt note "
           + " where note.t_noteKind=900 and t_objectType=3 and note.t_documentId=:subj " ;

   var params:TArray;
   params = MakeArray(SQLParam("subj", subj));
  
   var res = ExecSQLSelect(sql, params, false);

   if( (res.moveNext()) and (res.value(0) != null))
      return res.value(0);
   else
      MsgBox("Ошибка получения даты Генерального соглашения");     
   end;

   return null;
end;


//
// Получить примечание "Генеральное соглашение"  по Id субъекта экономики (клиента)  и номеру типа примечания
// В случае отсутствия примечания возвращает 0.
//
macro GetGenTextBySubj(subj) : String 
   var uId:Object;
   record client ("party");                                    
   SetBuff(client, uId); 
   client.partyId = subj;                                    

   var text:String="";
   //if (getEQ(client))  
   text = readNoteForObject(OBJTYPE_PARTY, UniID(client,OBJTYPE_PARTY), 900);
   if("" == text)
      MsgBox("Не задано Генеральное соглашение");
      return "";
   end;


   var dt = GetGenDateBySubj(subj);

   if(null != dt)
      text = text + " от ";
      text = text + dt;
   end;

   return text;
end; 
*********************************************************/

//
// Получить имя контрагента по его ID
//
macro diGetPartyNameById(ID)  
  if (ID == 0)
    return {Name_Bank};
  end;
   
  var party = TBfile("party");
  party.KeyNum = 0;
  party.rec.PartyID = ID;
  if( not GetEq(party) )
    return ID;
  else
    return party.rec.Name;
  end;
end;


//
// Получить краткое имя контрагента по его ID
//
macro diGetPartyShortNameById(ID)
  if (ID == 0)
    return {Name_Bank};
  end;
   
  var party = TBfile("party");
  party.KeyNum = 0;
  party.rec.PartyID = ID;
  if( not GetEq(party) )
    return ID;
  else
    return party.rec.ShortName;
  end;
end;



/***************************************** Пролонгации ***************************************/

//
// Проверка на то, что сделка создана на основе другой сделки (пролонгация) МБК
//
macro mmIsProlongation(dealId)
   var sql = " select To_Number(substr(oper.t_DocumentID, 25, 10)) as parentDealId  "
           +" from dOprDocs_dbt doc  " 
           +"     inner join dOprOper_dbt oper  " 
           +"     on doc.t_id_operation=oper.t_id_operation and doc.t_docKind=102 and oper.t_docKind=102  " 
           +"     and doc.t_DocumentID=LPad(:dealId,34,'0') " ;
   var res; 


   var params:TArray;
   params = MakeArray(SQLParam("dealId", dealId));

   res = ExecSQLSelect(sql, params, false);

   if(res.MoveNext())
      return true;
   end;

   return false;
end;


//
// Получить информацию о сделке-основании МБК, вынесенной на пролонгацию
//
macro mmGetParentDocInfo(dealId, parentDealId, parentDealCode, parentDealDate, parentStart, parentPayAmount)
/*  
   var sql = " select To_Number(substr(oper.t_DocumentID, 25, 10)) as parentDealId,  "
          +" Decode(To_Number(oper.t_DocumentID),'','0',tick.t_dealCode) as parentDealCode, " 
          +" tick.t_dealDate as parentDealDate, leg.t_start as parentStart,  " 
          +" Decode(pmnt.t_amount, '', 0, pmnt.t_amount) as parentPayAmount " 
          +" from dOprDocs_dbt doc   " 
          +" inner join dOprOper_dbt oper   " 
          +" on doc.t_id_operation=oper.t_id_operation and doc.t_docKind=102 and oper.t_docKind=102   " 
          +" and doc.t_DocumentID=LPad(:dealId,34,'0')  " 
          +" left outer join ddl_tick_dbt tick  " 
          +" on tick.t_bofficekind = 102 and tick.t_dealType in (12300, 12305)  " 
          +" and tick.t_dealId=To_Number(oper.t_DocumentID) " 
          +" inner join ddl_leg_dbt leg " 
          +" on tick.t_dealId=leg.t_dealId and leg.t_legKind=0 and tick.t_bOfficeKind=102 and leg.t_legId=1 " 
          +" left outer join dPmPaym_dbt pmnt " 
          +" on pmnt.t_documentId=tick.t_dealId and pmnt.t_docKind in (100, 102) and (pmnt.t_Purpose=10 or pmnt.t_Purpose=11)  " 
          +" and pmnt.t_paymStatus = 32000 " ;

*/

var sql = "select b.t_Dealid,b.t_DealCodets, b.t_DealDate, c.t_Start, c.t_principal from ddl_tick_dbt a, ddl_tick_dbt b, ddl_leg_dbt c where c.t_dealid=b.t_dealid and  b.t_dealid=a.t_marketid and a.t_dealid= :dealId";

   var res; 

   var params:TArray;
   params = MakeArray(SQLParam("dealId", dealId));

   res = ExecSQLSelect(sql, params, false);

   if(res.MoveNext())
      SetParm(1, res.value(0));
      SetParm(2, res.value(1));
      SetParm(3, res.value(2));
      SetParm(4, res.value(3));
      SetParm(5, res.value(4));

      return true;   
   end;

      SetParm(1, " ");
      SetParm(2, " ");
      SetParm(3, " ");
      SetParm(4, " ");
      SetParm(5, " ");


   return false;
end;



// Итерация нахождения первой сделки-основания (рекурсия) 
private macro mmGetFirstDocInfoIter(i, dealId, parentDealId, parentDealCode, parentDealDate, parentStart, parentPayAmount)
   var _parentDealId = parentDealId, _parentDealCode = parentDealCode, 
  _parentDealDate = parentDealDate, _parentStart = parentStart, _parentPayAmount = parentPayAmount;

  
   var flag = mmGetParentDocInfo(Int(dealId), parentDealId, parentDealCode, parentDealDate, parentStart, parentPayAmount);
 
   if (not flag)
      SetParm(2, _parentDealId);
      SetParm(3, _parentDealCode);
      SetParm(4, _parentDealDate);
      SetParm(5, _parentDealDate);
      SetParm(6, _parentPayAmount);
 
      return false;
   end;

   i = i+1;
   mmGetFirstDocInfoIter(i, Int(parentDealId), parentDealId, parentDealCode, parentDealDate, parentStart, parentPayAmount);

      SetParm(2, parentDealId);
      SetParm(3, parentDealCode);
      SetParm(4, parentDealDate);
      SetParm(5, parentDealDate);
      SetParm(6, parentPayAmount);


   return true;
end;


//
// Получить информацию о первой сделке-основании МБК, давшей начало цепочке пролонгаций 
//
macro mmGetFirstDocInfo(dealId, parentDealId, parentDealCode, parentDealDate, parentStart, parentPayAmount)

   // Инициализация значениями, соответствующими отсутствию сделки-основания
   mmGetParentDocInfo(-1, parentDealId, parentDealCode, parentDealDate, parentStart, parentPayAmount);      

   var i=0;
 
   // Поиск самой первой сделки
   mmGetFirstDocInfoIter(i, dealId, parentDealId, parentDealCode, parentDealDate, parentStart, parentPayAmount);
 
      SetParm(1, parentDealId);
      SetParm(2, parentDealCode);
      SetParm(3, parentDealDate);
      SetParm(4, parentDealDate);
      SetParm(5, parentPayAmount);

   return true;
end;

/*****************************
//
// Проверка на то, что сделка создана на основе другой сделки (пролонгация) МБК
//
macro mmIsProlongation(dealId)
   var sql = " select To_Number(substr(oper.t_DocumentID, 25, 10)) as parentDealId  "
           +" from dOprDocs_dbt doc  " 
           +"     inner join dOprOper_dbt oper  " 
           +"     on doc.t_id_operation=oper.t_id_operation and doc.t_docKind=102 and oper.t_docKind=102  " 
           +"     and doc.t_DocumentID=LPad(:dealId,34,'0') " ;
   var res; 


   var params:TArray;
   params = MakeArray(SQLParam("dealId", dealId));

   res = ExecSQLSelect(sql, params, false);

   if(res.MoveNext())
      return true;
   end;

   return false;
end;


//
// Получить информацию о сделке-основании МБК, вынесенной на пролонгацию
//
macro mmGetParentDocInfo(dealId, parentDealId, parentDealCode, parentDealDate, parentStart, parentPayAmount)
/*  
   var sql = " select To_Number(substr(oper.t_DocumentID, 25, 10)) as parentDealId,  "
          +" Decode(To_Number(oper.t_DocumentID),'','0',tick.t_dealCode) as parentDealCode, " 
          +" tick.t_dealDate as parentDealDate, leg.t_start as parentStart,  " 
          +" Decode(pmnt.t_amount, '', 0, pmnt.t_amount) as parentPayAmount " 
          +" from dOprDocs_dbt doc   " 
          +" inner join dOprOper_dbt oper   " 
          +" on doc.t_id_operation=oper.t_id_operation and doc.t_docKind=102 and oper.t_docKind=102   " 
          +" and doc.t_DocumentID=LPad(:dealId,34,'0')  " 
          +" left outer join ddl_tick_dbt tick  " 
          +" on tick.t_bofficekind = 102 and tick.t_dealType in (12300, 12305)  " 
          +" and tick.t_dealId=To_Number(oper.t_DocumentID) " 
          +" inner join ddl_leg_dbt leg " 
          +" on tick.t_dealId=leg.t_dealId and leg.t_legKind=0 and tick.t_bOfficeKind=102 and leg.t_legId=1 " 
          +" left outer join dPmPaym_dbt pmnt " 
          +" on pmnt.t_documentId=tick.t_dealId and pmnt.t_docKind in (100, 102) and (pmnt.t_Purpose=10 or pmnt.t_Purpose=11)  " 
          +" and pmnt.t_paymStatus = 32000 " ;

*/

var sql = "select b.t_Dealid,b.t_DealCode, b.t_DealDate, c.t_Start, c.t_principal from ddl_tick_dbt a, ddl_tick_dbt b, ddl_leg_dbt c where c.t_dealid=b.t_dealid and  b.t_dealid=a.t_marketid and a.t_dealid= :dealId";

   var res; 

   var params:TArray;
   params = MakeArray(SQLParam("dealId", dealId));

   res = ExecSQLSelect(sql, params, false);

   if(res.MoveNext())
      SetParm(1, res.value(0));
      SetParm(2, res.value(1));
      SetParm(3, res.value(2));
      SetParm(4, res.value(3));
      SetParm(5, res.value(4));

      return true;   
   end;

      SetParm(1, " ");
      SetParm(2, " ");
      SetParm(3, " ");
      SetParm(4, " ");
      SetParm(5, " ");


   return false;
end;

private macro mmGetFirstDocInfoIter(i, dealId, parentDealId, parentDealCode, parentDealDate, parentStart, parentPayAmount)
var sql = "select b.t_Dealid,b.t_DealCode, b.t_DealDate, c.t_Start, c.t_principal from ddl_tick_dbt a, ddl_tick_dbt b, ddl_leg_dbt c where c.t_dealid=b.t_dealid and  b.t_dealid=a.t_depositid and a.t_dealid= :dealId";

   var res; 

   var params:TArray;
   params = MakeArray(SQLParam("dealId", dealId));

   res = ExecSQLSelect(sql, params, false);

   if(res.MoveNext())
      SetParm(2, res.value(0));
      SetParm(3, res.value(1));
      SetParm(4, res.value(2));
      SetParm(5, res.value(3));
      SetParm(6, res.value(4));

      return true;   
   end;

      SetParm(1, " ");
      SetParm(2, " ");
      SetParm(3, " ");
      SetParm(4, " ");
      SetParm(5, " ");


   return false;
end;


/*
// Итерация нахождения первой сделки-основания (рекурсия) 
private macro mmGetFirstDocInfoIter(i, dealId, parentDealId, parentDealCode, parentDealDate, parentStart, parentPayAmount)
   var _parentDealId = parentDealId, _parentDealCode = parentDealCode, 
  _parentDealDate = parentDealDate, _parentStart = parentStart, _parentPayAmount = parentPayAmount;

  
   var flag = mmGetParentDocInfo(Int(dealId), parentDealId, parentDealCode, parentDealDate, parentStart, parentPayAmount);
 
   if (not flag)
      SetParm(2, _parentDealId);
      SetParm(3, _parentDealCode);
      SetParm(4, _parentDealDate);
      SetParm(5, _parentDealDate);
      SetParm(6, _parentPayAmount);
 
      return false;
   end;

   i = i+1;
   mmGetFirstDocInfoIter(i, Int(parentDealId), parentDealId, parentDealCode, parentDealDate, parentStart, parentPayAmount);

      SetParm(2, parentDealId);
      SetParm(3, parentDealCode);
      SetParm(4, parentDealDate);
      SetParm(5, parentDealDate);
      SetParm(6, parentPayAmount);


   return true;
end;

*/
//
// Получить информацию о первой сделке-основании МБК, давшей начало цепочке пролонгаций 
//
macro mmGetFirstDocInfo(dealId, parentDealId, parentDealCode, parentDealDate, parentStart, parentPayAmount)

   // Инициализация значениями, соответствующими отсутствию сделки-основания
   mmGetParentDocInfo(-1, parentDealId, parentDealCode, parentDealDate, parentStart, parentPayAmount);      

   var i=0;
 
   // Поиск самой первой сделки
   mmGetFirstDocInfoIter(i, dealId, parentDealId, parentDealCode, parentDealDate, parentStart, parentPayAmount);
 
      SetParm(1, parentDealId);
      SetParm(2, parentDealCode);
      SetParm(3, parentDealDate);
      SetParm(4, parentDealDate);
      SetParm(5, parentPayAmount);

   return true;
end;
*********************/



/***************************************** Буферы ****************************************/

//
// Получить буффер таблицы dl_tick по id сделки
// dealId -- Id сделки, buff -- выходной (OUT) буфер, содержащий record с записью о сделке, найденной по id
// Замечание: требуется в вызывающем коде явно объявить << record buff (dl_tick) >> для передачи buff в процедуру
// Возвращает true в случае успешной работы, false -- в случае ошибки
//
macro GetBufferForTick (dealId, buff)
   record deal(dl_tick);

   var sql = "select *  from ddl_tick_dbt  where t_dealId = :dealId";
   var params = MakeArray(SQLParam("dealId", dealId)); 
   var rs = ExecSQLSelect(sql, params, false);
   if(rs.MoveNext())        
      CopyRSetToFBuff( deal, rs ); 
      Copy(buff, deal);  
      return true;
   end;
 
   return false;
end;



/*************************************** Скроллинги ***************************************/


private var g_selectedDealer = 0; // Id искомого субъекта в скроллинге (или 0, если искать не надо)
//
// Процедура обработки событий скроллинга дилеров
//
private macro ListDealerScrollEvProc(rs, cmd, id, key) 
   if (cmd == DLG_INIT) 
      rs.MoveFirst();          
   
      // Прокрутка до нужной записи
      if (g_selectedDealer > 0)  // Надо найти запись
         while ( (Int(rs.value ("dname")) != g_selectedDealer) And (Not rs.EOF) )  
            rs.Move(1, RELATIVE);
         end;
      end;
     
      GoToScroll(rs, true); 
   elif (DLG_KEY == cmd)  
      if(DLG_KEY_ENTER == Key)  
         return CM_SELECT;
      end;
   end;

   return CM_DEFAULT;
end;
   

//
// Построение списка дилеров
//
macro ListDealer(dealer:Integer, selectedDealer:Integer, dealerName:String)
   var sql = " select part.t_partyId id, part.t_shortname dname, cod.t_code code "
          +"     from dOfficer_dbt ofr  " 
          +"     inner join dParty_dbt part   " 
          +"     on ofr.t_partyId=" +_SelfID+ " and ofr.t_personId=part.t_partyId " 
          +"         inner join dObjCode_dbt cod  " 
          +"         on cod.t_objectId = part.t_partyId and cod.t_objectType=3 and cod.t_codeKind=1  " ;

 
   if(ValType(selectedDealer) == V_UNDEF)
      g_selectedDealer = selectedDealer = 0;  // Позиционирование на 1й записи
   else
      g_selectedDealer = selectedDealer;
   end;


   var rs = ExecSQLSelect(sql, null, false, RSDVAL_CLIENT, RSDVAL_STATIC);

   var col = TArray();
   AddCol (col, 0, "code",  "Код",                12);   
   AddCol (col, 1, "dname", "Сокр. наименование", 20);   
 
   if(RunScroll (rs, 2, col, "ListDealerScroll", @ListDealerScrollEvProc, "Список сотрудников", 
  "~ESC~ выход, ~Enter~ выбор", true, 7, 15, 40, 20) )
                              
      SetParm(0, rs.value("id"));       
      SetParm(2, rs.value("dname"));  
      return true;
   end;     

   return false;
end;


//
// Получить Id любого дилера
//
macro GetAnyDealer()
   var sql = " select part.t_partyId id, part.t_shortname dname, cod.t_code code "
          +"     from dOfficer_dbt ofr  " 
          +"     inner join dParty_dbt part   " 
          +"     on ofr.t_partyId=" +_SelfID+ " and ofr.t_personId=part.t_partyId " 
          +"         inner join dObjCode_dbt cod  " 
          +"         on cod.t_objectId = part.t_partyId and cod.t_objectType=3 and cod.t_codeKind=1  " 
          +"         and ofr.t_officeId = 1 ";
                  
   var rs = ExecSQLSelect(sql, null, false);
   if( rs.moveNext() )
      return rs.value(0);
   end;

   return -1;
end;

//
// Получить partyId по номеру операциониста
//
macro diGetPartyByOper(oper)
   var sql = "select t_partyId from dperson_dbt where t_oper=:oper";

   var rs = ExecSQLSelect(sql, MakeArray(SQLParam("oper", oper)), false);
   if( rs.moveNext() )
      return rs.value(0);
   end;

   return -1;
end;
 
private var g_selectedBroker = 0; // Id искомого субъекта в скроллинге (или 0, если искать не надо)
//
// Процедура обработки событий скроллинга брокеров
//
private macro ListBrokerScrollEvProc(rs, cmd, id, key) 
   if (cmd == DLG_INIT) 
      rs.MoveFirst();          
   
      // Прокрутка до нужной записи
      if (g_selectedBroker > 0)  // Надо найти запись
         while ( (Int(rs.value ("bname")) != g_selectedBroker) And (Not rs.EOF) )  
            rs.Move(1, RELATIVE);
         end;
      end;
     
      GoToScroll(rs, true); 
   elif (DLG_KEY == cmd)  
      if(DLG_KEY_ENTER == Key)  
         return CM_SELECT;
      end;
   end;

   return CM_DEFAULT;
end;

  
//
// Построение списка брокеров
//
macro ListBroker(broker:Integer, selectedBroker:Integer, brokerName:String)
   var sql = " select cod.t_code code, part.t_partyId id, part.t_name bname, part.t_shortname sname, pown.t_partyKind kind, kind.t_name isa "
          +" from dPartyOwn_dbt pown " 
          +"     inner join dPtKind_dbt kind " 
          +"     on pown.t_partyKind = kind.t_partyKind and kind.t_partyKind=22 " 
          +"         inner join dParty_dbt part " 
          +"         on pown.t_partyId = part.t_partyId " 
          +"             inner join dObjCode_dbt cod  " 
          +"             on cod.t_objectId = part.t_partyId and cod.t_objectType=3 and cod.t_codeKind=1 and cod.t_state=0 " ;
 
   if(ValType(selectedBroker) == V_UNDEF)
      g_selectedBroker = selectedBroker = 0;  // Позиционирование на 1й записи
   else
      g_selectedBroker = selectedBroker;
   end;

   var rs = ExecSQLSelect(sql, null, false, RSDVAL_CLIENT, RSDVAL_STATIC);

   var col = TArray();
   AddCol (col, 0, "code",  "Код", 20);   
   AddCol (col, 1, "bname", "Наименование", 50);   
 
   if(RunScroll (rs, 2, col, "ListBrokerScroll", @ListBrokerScrollEvProc, "Список брокеров", 
  "~ESC~ выход, ~Enter~ выбор", true, 43, 15, 75, 20) )
                              
      SetParm(0, rs.value("id"));       
      SetParm(2, rs.value("sname"));  
      return true;
   end;     

   return false;

end;



/***************************************** Базисы ***************************************/

// Базисы начисления 
private const BASIS_360_30  = 1,    
      BASIS_360_ACT     = 2,
      BASIS_Act_ACT   = 4,  
      BASIS_365_ACT = 8,
      BASIS_360_31  = 1001;

//
// Получить базис начисления для года (количество дней в году или Act)
//
macro getDaysInYearOnBasis(basis)
   var sql = " select substr(t_szNameAlg,0,3) from dNameAlg_dbt where t_iTypeAlg = 2317  "
           + " and t_iNumberAlg=:bas " ;

   var params:TArray;
   params = MakeArray(SQLParam("bas", basis));
  
   var res = ExecSQLSelect(sql, params, false);

   if( (res.moveNext()) and (res.value(0) != null))
      return res.value(0);   
   else
      MsgBox("Ошибка получения базиса начисления");     
   end;

   return 0;
end;

//
// Получить базис начисления для месяца (количество дней в месяце или Act)
//
macro getDaysInMonthOnBasis(basis)
   var sql = " select substr(t_szNameAlg,5,3) from dNameAlg_dbt where t_iTypeAlg = 2317  "
           + " and t_iNumberAlg=:bas " ;

   var params:TArray;
   params = MakeArray(SQLParam("bas", basis));
  
   var res = ExecSQLSelect(sql, params, false);

   if( (res.moveNext()) and (res.value(0) != null))
      return res.value(0);   
   else
      MsgBox("Ошибка получения базиса начисления");     
   end;

   return 0;
end;

//
// Получить полный базис начисления в виде строки 
//
macro getBasis(basis)
   var sql = " select t_szNameAlg from dNameAlg_dbt where t_iTypeAlg = 2317  "
           + " and t_iNumberAlg=:bas " ;
 
   var params:TArray;
   params = MakeArray(SQLParam("bas", Int(basis)));
  
   var res = ExecSQLSelect(sql, params, false);
 
   if( (res.moveNext()) and (res.value(0) != null))
      return res.value(0);      
   else
      MsgBox("Ошибка получения базиса начисления");     
   end;

   return 0;
end;


/**************************************** Алгоритмы **************************************/

//
// Процедура обработки событий скроллинга алгоритмов
//
private macro ListAlgEvProc(rs, cmd, id, key)
   if (cmd == DLG_INIT) 
      rs.MoveFirst();          
      GoToScroll(rs, true);
   elif (cmd == DLG_KEY)
      if(DLG_KEY_ENTER == Key)    // Выбрать алгоритм
         return CM_SELECT;
      end; 
   end;

   return CM_DEFAULT;
end;
   
//
// Вывести скроллинг выбора данных для алгоритма из таблицы namealg.dbt
// type -- группа значений, name -- возвращаемое имя выбранного алгоритма. 
// Возвращает код выбранного значения.
// Работает аналогично list_alg из ритейлового CommonInter, только без побочных эффектов, которые могут быть при ненастройке ритейла
//     
macro ListAlgorithm(type:Integer, name:String):Integer 
   var sql = "select t_iNumberAlg num, t_szNameAlg alg from dnamealg_dbt where t_iTypeAlg=:type "; 
   var params = MakeArray(SQLParam("type", type)); 
   var rs = ExecSQLSelect(sql, params, false, RSDVAL_CLIENT, RSDVAL_STATIC); 

   var col = TArray();
   AddCol (col, 0, "alg", "Варианты", null, true); 


   if(RunScroll (rs, 1, col, "ListAlgScroll", @ListAlgEvProc, null, 
  "~ESC~ выход, ~Enter~ выбор", true, 32, 10, 30, 20) )
      SetParm(1, rs.value(1));
      return rs.value(0);
   end;

   return 0;
end;

//
// Определение наименования алгоритма с заданными параметрами. 
// Поиск записи об алгоритме осуществляется в таблице namealg.dbt.
// type -- группа значений (код вида алгоритма), code -- код искомого алгоритма. 
// Возвращает название алгоритма или пустую строку при неудаче.
// Работает аналогично GetNameAlg из ритейлового CommonInter, только без побочных эффектов, которые могут быть при ненастройке ритейла
//  
macro GetAlgorithmName(type:Integer, code:Integer):String
   var sql = "select t_szNameAlg from dnamealg_dbt where t_iTypeAlg=:type and t_iNumberAlg=:alg "; 
   var params = MakeArray(SQLParam("type", type), SQLParam("alg", code)); 
   var rs = ExecSQLSelect(sql, params, false);

   if(rs.MoveNext())                
      return rs.value(0);
   end;

   return "";
end;  


/*************************************** Портфели сделок ***********************************/
//
// Процедура обработки событий скроллинга портфелей МБК
//
private macro ListMmPortEvProc(rs, cmd, id, key)
   if (cmd == DLG_INIT) 
      rs.MoveFirst();          
      GoToScroll(rs, true);
   elif (cmd == DLG_KEY)
      if(DLG_KEY_ENTER == Key)    // Выбрать портфель
         return CM_SELECT;
      end; 
   end;

   return CM_DEFAULT;
end;

//
// Вывести скроллинг выбора портфеля для сделки МБК из таблицы dObjAttr_dbt
// name (OUT) -- название портфеля. Возвращает номер портфеля или ноль -- если портфель не был выбран
//
macro ListPortfolio(name:String):Integer 
   var sql = "select t_attrId id, t_numInList num, t_FullName nam from dObjAttr_dbt where t_objectType=103 and t_groupId=1 "; 
 
   var rs = ExecSQLSelect(sql, null, false, RSDVAL_CLIENT, RSDVAL_STATIC); 

   var col = TArray();
   AddCol (col, 0, "num", "Номер",  10, true); 
   AddCol (col, 1, "nam", "Портфель", 30, true); 


   if(RunScroll (rs, 2, col, "ListMmPortScroll", @ListMmPortEvProc, "Портфели", 
  "~ESC~ выход, ~Enter~ выбор", true, 32, 10, 60, 20) )
      SetParm(0, rs.value(2));
      return rs.value(0);
   end;

   return 0;
end;


//
// Получить имя портфеля (его типа) по его Id
// portfolioTypeId -- Id типа портфеля. Возвращает имя портфеля или пустую строку, если портфель не найден 
//
macro GetPortfolioName(portfolioTypeId:Integer):String
   var sql = "select t_Name from dObjAttr_dbt where t_objectType=103 and t_groupId=1 and t_attrId=:attrId "; 
   var params = MakeArray(SQLParam("attrId", portfolioTypeId)); 
   var rs = ExecSQLSelect(sql, params, false, RSDVAL_CLIENT, RSDVAL_STATIC); 

   if(rs.MoveNext())                
      return rs.value(0);
   end;

   return "";
end;


//
// Получить полное имя портфеля (его типа) по его Id
// portfolioTypeId -- Id типа портфеля. Возвращает имя портфеля или пустую строку, если портфель не найден 
//
macro GetPortfolioFullName(portfolioTypeId:Integer):String
   var sql = "select t_fullName from dObjAttr_dbt where t_objectType=103 and t_groupId=1 and t_attrId=:attrId "; 
   var params = MakeArray(SQLParam("attrId", portfolioTypeId)); 
   var rs = ExecSQLSelect(sql, params, false, RSDVAL_CLIENT, RSDVAL_STATIC); 

   if(rs.MoveNext())                
      return rs.value(0);
   end;

   return "";
end;


//
// Получить портфель у сделки МБК
// dealId -- Id сделки
// Возвращает номер портфеля или 0, если портфель не был задан
//
macro GetPortfolio(dealId:Integer):Integer
   var CatErr:Integer = 0;
   
   var uId:Object;
   record tick ("dl_tick");                                    
   SetBuff(tick, uId); 
   tick.dealId = dealId; 

   var AttrId = 0, Code = 0, Num = 0;
/*
   GetMainObjAttr( CatErr, OBJTYPE_MMARKDEAL,
                                UniID(tick, OBJTYPE_MMARKDEAL),
                                1,
                                AttrId, Code, Num
                 );

 
   if( CatErr != 0 )      
      MsgBox("Ошибка получения портфеля для сделки");
      return 0;
   end;
*/

   AttrId = GetObjAttr( OBJTYPE_MMARKDEAL,
                        UniID(tick, OBJTYPE_MMARKDEAL),
                        1 
                      );



   return AttrId;
end;


//
// Проверка на задание портфеля у сделки МБК
// dealId -- Id сделки
// Возвращает true, если у сделки задан портфель или false -- если портфель не задан
//
macro IsPortfolioExist(dealId:Integer):Bool
   var sql = "select * from dObjAtCor_dbt where t_objectType=103 and t_groupId=1 and t_general='X' and t_object = LPAD(:dealId, 34, '0') "; 
   var params = MakeArray(SQLParam("dealId", dealId)); 
   var rs = ExecSQLSelect(sql, params, false, RSDVAL_CLIENT, RSDVAL_STATIC); 

   if(rs.MoveNext())                
      return true;
   end;

   return false;
end;


//
// Удалить портфель у сделки МБК
// dealId -- Id сделки
//
macro ResetPortfolio(dealId:Integer):Bool
   var CatErr:Integer = 0;  

   var uId:Object;
   record tick ("dl_tick");                                    
   SetBuff(tick, uId); 
   tick.dealId = dealId; 

/*
   if( not DisconnectObjAttr( OBJTYPE_MMARKDEAL, 
                              UniID(tick, OBJTYPE_MMARKDEAL),
                              1 )
     )
      MsgBox("Ошибка удаления портфеля для сделки");
      return false;
   end;        
*/
   if( not ResetObjAttr( OBJTYPE_MMARKDEAL, 
                         UniID(tick, OBJTYPE_MMARKDEAL),
                         1 )
      )

      MsgBox("Ошибка удаления портфеля для сделки");
      return false;
   end;

   return true;
end;


//
// Задать портфель у сделки МБК
// dealId -- Id сделки, portId -- Id портфеля (dObjAttr_dbt.t_attrId)
// Возвращает true в случае успешного выполнения и false -- в случае ошибки
// 
macro SetPortfolio(dealId:Integer, portId:Integer):Bool
   var CatErr:Integer = 0;  

   var uId:Object;
   record tick ("dl_tick");                                    
   SetBuff(tick, uId); 
   tick.dealId = dealId; 

/*
   if(not ResetPortfolio(dealId)) // Удаление из имеющегося портфеля (портфель м.б. только 1)
      return false;
   end;

   if( (not ConnectObjAttr( CatErr, OBJTYPE_MMARKDEAL,
                            UniID(tick, OBJTYPE_MMARKDEAL),
                            1,
                            portId
                          )    
       ) OR 
       ( CatErr != 0 )
     )
      MsgBox("Ошибка задания портфеля для сделки");
      return false;
   end;
*/


   if(not SetObjAttr( OBJTYPE_MMARKDEAL,
                      UniID(tick, OBJTYPE_MMARKDEAL),
                      1,
                      portId
                    )
     )
      MsgBox("Ошибка задания портфеля для сделки");
      return false;
   end;

   return true;
end;



/***************************************** Проценты ***************************************/

//
// Получение суммы рассчитанных процентов за период
// Rest -- остаток, на сумму которого рассчитываются проценты, begDate и endDate -- границы периода расчёта, 
// PercRate -- величина процентной ставки, basis -- код алгоритма базиса начисления
// Работает аналогично РасчетГрафикаПроцентов из лоансовского ПроцентыБухгалтер, только без побочных эффектов, которые могут быть при ненастройке лоанса
// Плюс имеется возможность задания базиса начисления
//
macro РасчётПроцентнойСтавки2(Rest:Money, begDate:Date, endDate:Date, PercRate:Double, basis:Integer):Money  

   if(V_UNDEF == ValType(basis))
      basis = BASIS_ACT_ACT;  // Позиционирование на Act/Act
   else
      basis = basis;
   end;

   var begY = ДатаГод(begDate);
   var endY = ДатаГод(endDate);
   var currDate = begDate,m1,m2;
   var nextYearBeg;

   var i = 0;
   var res = 0;
   
   var strBasis = getDaysInYearOnBasis(basis);
   if(0 == strBasis)
      return 0;
   end;

   var strBasisD= getDaysInMonthOnBasis(basis);
   if(0 == strBasisD)
      return 0;
   end;
 
 
   if(BASIS_ACT_ACT == basis) // Кол-во дней в году == актуальному (реальному) числу, аналогично и кол-во дней в месяце (Act/Act)
      while(begY+i != endY)     // Если имеет место одно- или многократная смена года в заданном периоде
         i = i+1;
  
         nextYearBeg = ПолучитьНачалоГода(ДобавитьГод(currDate)); 
         res = res + Rest * PercRate / 100  / ПолучитьКолВоДнейВГоду(currDate) * (nextYearBeg - currDate - 1);
         currDate = nextYearBeg; 
        
      end;   

 
      if(0 == i) 
         res = res + Rest * PercRate / 100  / ПолучитьКолВоДнейВГоду(currDate) * (endDate - currDate); 
      else 
         res = res + Rest * PercRate / 100  / ПолучитьКолВоДнейВГоду(currDate) * (endDate - currDate + i); 
      end;
      return res;
   end;   


   if(BASIS_360_30 == basis)    // Считается, что в месяце не больше 30 дней (360/30) 
 
//     datesplit(currDate,null,m1,null);
//      datesplit(endDate,null,m2,null);


      if (NDays30(currDate, endDate) == 30) 
        return Rest * PercRate / 100  / Int(strBasis) * ( NDays30(currDate, endDate)  );
      else
        return Rest * PercRate / 100  / Int(strBasis) * ( NDays30(currDate, endDate) + 1 );
      end;

   else       // Все прочие случаи (дней в месяце Act, а в году -- различное фиксированное) 
      return Rest * PercRate / 100  / Int(strBasis) * (endDate - currDate);
   end; 
end;


macro РасчётПроцентнойСтавки(Rest:Money, begDate:Date, endDate:Date, PercRate:Double, basis:Integer):Money  
 private var rres;

 if(begDate > endDate)
    return -1;  
 end;


 rres=РасчётПроцентнойСтавки2(Rest, begDate, endDate, PercRate, basis);
 rres=round(rres,2);
 return rres;


end;



/***************************************** Платежи ***************************************/

//
// Поиск платежа по id операции. 
// Возвращает true в случае наличия платежа и false - в случае отсутствия
//
macro НайтиПлатёжПоОперации(OperationId:Integer, PaymentId:Integer, Fiid:Integer, Purpose:Integer, KindOperation:Integer, PaymStatus:Integer)
   var sql = " select paym.t_paymentId, paym.t_fiid, paym.t_purpose, paym.t_kindOperation, paym.t_paymStatus from dPmPaym_dbt paym  "
            +"     inner join dOprOper_dbt op  " 
            +"     on op.t_documentid = lpad(paym.t_documentid,34,'0') and paym.t_docKind in (16, 27) and paym.t_docKind = op.t_docKind and (paym.t_kindOperation = 0 or op.t_kind_Operation = 0) " 
            +"     and paym.t_purpose = :purp " //and paym.t_kindOperation = :kind  
            +"         inner join dOprDocs_dbt doc " 
            +"         on doc.t_documentId = op.t_documentId and doc.t_docKind = op.t_docKind and doc.t_id_operation = :OperationId " ;
          
   // Возможно, в дальнейшем будет анализироваться поле paym.t_kindOperation для платежей (10201 рублёвый платёж, 13022  валютный платёж) 
   // и основание paym.t_purpose (14 кассовое поручение, 15 платёж банка)
   // paym_docKind = 430 и 440 -- для кассовых поручений
   var params = MakeArray(SQLParam("purp", 15), SQLParam("OperationId", OperationId)); 
 
   var rs = ExecSQLSelect(sql, params, false);
   if(rs.MoveNext())
      SetParm(1, rs.value(0));
      SetParm(2, rs.value(1));
      SetParm(3, rs.value(2));
      SetParm(4, rs.value(3));
      SetParm(5, rs.value(4));
      return true;   
   end;
   return false;
end;
 
// Получить краткое имя контрагента по его ID
//
macro GetPartyShortNameById2(ID)
  if (ID == 0)
    return {Name_Bank};
  end;
   
  var party = TBfile("party");
  party.KeyNum = 0;
  party.rec.PartyID = ID;
  if( not GetEq(party) )
    return ID;
  else
    return party.rec.ShortName;
  end;
end;



 