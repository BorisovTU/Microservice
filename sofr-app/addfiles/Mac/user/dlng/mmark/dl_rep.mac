/***********************************************************


 Сделки МБК за дату
************************************************************/

import RSBDataSet, dlgCommon,funk,dl_plib, Календарь, dl_lib;
IMPORT FIInter,rsexts,oralib,likepy,rcw, or_tpl_h;

//Переменные для варианта WindowsReports, поддерживающего POIReports
var csvFile, fName, csvTable, printEngine;
const TEMPL_NAME = "Template_et_repp.xlsx";

MACRO prol2(par1)
    private var rs5,que,rez,jk=0;
    rez=0;

    while (jk < 100 )
       que = "select nvl(sum(b.t_DocumentID),0) from doprdocs_dbt a, doproper_dbt b where a.t_id_operation=b.t_id_operation and a.t_dockind=102 and b.t_dockind=102 and a.t_DocumentID=lpad("+par1+",34,'0') order by  a.t_id_operation desc";
       rs5 = LnGetRecordset(que);
       if(rs5 != null)
         if (rs5.moveNext) 
            if (rs5.value(0) > 0 )
             rez=int(rs5.value(0));
             par1=rez;
            else
             jk=101;
            end;
         end;
       end;
       jk=jk+1;
    end;

     return rez;
END;


MACRO prolpos2(par1,par2)
    private var ndealid,rs5,que,rez,jk=0,sql0;
    rez=0;

     ndealid=prol2(par1);
     par1=ndealid;

    sql0=" select a.t_dealid, a.t_dealdate  from ddl_tick_dbt a , ddl_leg_dbt b where b.t_dealid=a.t_dealid and to_char(b.t_maturity,'dd.mm.yyyy')='"+СДАТ(par2)+"' and (  a.t_dealid = "+par1;
    jk=0;
    while (jk < 100 )
       que = "select nvl(sum(a.t_DocumentID),0) from doprdocs_dbt a, doproper_dbt b where a.t_id_operation=b.t_id_operation and a.t_dockind=102 and b.t_dockind=102 and b.t_DocumentID=lpad("+par1+",34,'0')";
       rs5 = LnGetRecordset(que);
       if(rs5 != null)
         if (rs5.moveNext) 
            if (rs5.value(0) > 0 )
             rez=int(rs5.value(0));
             par1=rez;
             sql0=sql0+ " or a.t_dealid = "+rez;
            else
             jk=101;
            end;
         end;
       end;

       jk=jk+1;
    end;
    sql0=sql0 +" )";
    rs5 = LnGetRecordSet(sql0);
    if(rs5 != null)
      if (rs5.moveNext) 
        rez=int(rs5.value(0));
     end;
   end;

     return rez;
END;


/*
  Инциализируем класс Отчёта
*/
macro initRep(templateName)
    printEngine=CTemplateXLS(NULL, NULL, NULL, NULL, NULL, NULL, true, false);

    if(printEngine.UsePoi())
      printEngine.SetXLSXFormat();
    end;

    printEngine.CreateTotalBook();

    InitProgress(-1, "", "");

    printEngine.OpenTemplate(templateName, true);
   
end;

/*
  Показать окно отчёта
*/
macro showRep(FileName)
    printEngine.Close();
    printEngine.SaveTotalBook(FileName);
end;

macro CheckQuote(str):string
	var count,countOld, length, i: Integer;
	var item;

	count = 0;
	i = 1;
	length = StrLen(str);

	while(i <= length)
		item = SubStr(str, i, 1);
		if(item == "\"")
			count = count + 1;
		end;
		i = i + 1;
	end;

	countOld = count;
	count = (count / 2) * 2;

	if (count != countOld)
		str = str + "\""
	end;

	return str;
end;

macro AddRow(rs45, rowNum, dat)
   var dealid, price, nndealid, d3, kd, acc0, nnn;

   dealid=rs45.value("dealid");

   csvFile.AddCell ( rowNum );
   csvFile.AddCell ( rs45.value("d0") );
   csvFile.AddCell ( rs45.value("dealcodets") );
   csvFile.AddCell ( rs45.value("d1") );
   csvFile.AddCell ( rs45.value("d2") );
   csvFile.AddCell ( CheckQuote(rs45.value("name")) );
   csvFile.AddCell ( rs45.value("principal") );
   csvFile.AddCell ( rs45.value("fiid") );

   if (rs45.value("dealstatus") == 0 )
      price=rs45.value("price")/Pow(10,rs45.value("point") );
   else
      price= Новая_проц_ставка(dealid,dat);
   end;
   
   csvFile.AddCell ( price );

   if ( rs45.value("flag1") == "X" )
         nndealid=prol2(dealid);
         d3=СДАТ(MM_tickid(nndealid,"dealdate"));
         kd=rs45.value("duration");
   else
      d3=" ";
      kd=rs45.value("duration");
   end;

   csvFile.AddCell ( kd );
   csvFile.AddCell ( rs45.value("cost") );

   acc0=rs45.value("acc");
   if ( strlen(acc0 ) > 2 )
      acc0=substr(acc0,1,5)+"-"+substr(acc0,6,3)+"-"+substr(acc0,9,1)+"-"+substr(acc0,10,4)+"-"+substr(acc0,14);
   end;
         
   csvFile.AddCell ( acc0 );
   csvFile.AddCell ( d3 );
      
   if ( rs45.value("flag1") == "X" )
      nndealid= prolpos2(dealid,rs45.value("d1"));
      nnn=zsdell(nndealid,"dealcodets");
   else
      nnn=" ";
   end;

   csvFile.AddCell ( nnn );
   csvFile.AddRow();

end;

macro AddRowCSA(rs45, rowNum, dat, val:bool)
   var dealid, pst, acc0;

   dealid=rs45.value("dealid");

   csvFile.AddCell ( rowNum );
   csvFile.AddCell ( dat );
   csvFile.AddCell ( rs45.value("dealcodets") );
   csvFile.AddCell ( dat );
   csvFile.AddCell ( DateAfterWorkDays(date(dat),1) );
   csvFile.AddCell ( CheckQuote(rs45.value("name")) );
   csvFile.AddCell ( abs(rs45.value("cost")) );
   csvFile.AddCell ( rs45.value("fiid") );

   if ( (ValType(val) == V_UNDEF) OR ((ValType(val) == V_BOOL) and (not val)) )
      pst= "RUONIA";
   else
      if (rs45.value("cur") == 8 ) 
         pst="EONIA";
         else
         pst="FED.F H.15"; 
      end;
   end;
   csvFile.AddCell ( pst );

   csvFile.AddCell ( 1 );
   csvFile.AddCell ( " " );

   acc0=rs45.value("acc");
   if ( strlen(acc0 ) > 2 )
      acc0=substr(acc0,1,5)+"-"+substr(acc0,6,3)+"-"+substr(acc0,9,1)+"-"+substr(acc0,10,4)+"-"+substr(acc0,14);
   end;
         
   csvFile.AddCell ( acc0 );
   csvFile.AddCell ( rs45.value("d0") );
      
   csvFile.AddRow();
end;

   private var dat;
   private var is2, que, rs45;

   dat={curdate};
   getdate(dat,"Уточните дату отчета");
   dat=СДАТ(dat);

   initRep(TEMPL_NAME);

   // LEND RUB
   var CSV_NAME   = "et_repp_lend_csv.txt";
   var SHEET_NAME = "LEND";

   csvFile = C_CSVFile();
   if (printEngine.UsePoi())
      csvFile.SetLimitRow(FLUSH_COUNT_XLSX);
   end;
   fName = csvFile.CreateFullFileName(CSV_NAME);
   csvFile.FileOpen(fName, true);

   printEngine.SheetChange(SHEET_NAME);
   printEngine.CopyAllSheetInTotalBook (SHEET_NAME, false, "lendHeader", 0, SHEET_NAME);
   csvTable = printEngine.RegisterTable("lendTableRow", "lendTableHeader", true);

   is2=1;
   
   que="select to_char(a.t_dealdate,'dd.mm.yyyy') d0 , a.t_dealstatus dealstatus,  to_char(b.t_start,'dd.mm.yyyy') d1 ,to_char(b.t_maturity,'dd.mm.yyyy') d2 ,";
   que=que+" b.t_principal principal,a.t_dealcodets dealcodets , c.t_name name, b.t_cost cost, b.t_price price, ";
   que=que+" b.t_point point, f.t_fi_code fiid, b.t_duration duration,a.t_dealid dealid,a.t_flag1 flag1, "; 
   que=que+" (case  when (select count(*) from dmcaccdoc_dbt aa where aa.t_docid=a.t_dealid and aa.t_dockind = 102 and aa.t_catid=111 ) > 0 then ";
   que=que+"  (select t_account from (select aa.t_account from dmcaccdoc_dbt  aa where aa.t_docid=a.t_dealid and aa.t_dockind = 102 and aa.t_catid=111 order by aa.t_activatedate desc, aa.t_id desc) where rownum = 1) ";
   que=que+"  else ' '  end ) acc  from  ddl_tick_dbt a , ddl_leg_dbt b , dparty_dbt c, dfininstr_dbt f where a.t_dealtype=12305 and a.t_bofficekind=102 "; 
   que=que+" and to_char(a.t_dealdate,'dd.mm.yyyy')= '"+dat+"' and b.t_dealid=a.t_dealid and b.t_pfi=0  ";
   que=que+" and c.t_partyid=a.t_partyid and f.t_fiid=b.t_pfi order by a.t_partyid ";

   rs45 = LnGetRecordSet(que);
   if(rs45 != null)
      while(rs45.moveNext)
         AddRow(rs45, is2, dat);
         is2=is2+1;
      end;
   end;

   // lend CSA

   que="select a.t_csaid dealid,  to_char(b.t_begdate,'dd.mm.yyyy')  d0 , a.t_cur cur,  a.t_rate price,  b.t_code dealcodets,a.t_insum principal, (select f.t_fi_code from dfininstr_dbt f where  f.t_fiid=a.t_cur) fiid, (a.t_morningsum +a.t_insum-a.t_outsum) cost, (select d.t_name from dparty_dbt d where d.t_partyid=b.t_partyid) name, ";
   que=que+" (case when /* a.t_morningsum*/ a.t_eveningsum /*kea*/ > 0 then (select c.t_account from dmcaccdoc_dbt c where c.t_docid=a.t_csaid and c.t_dockind=4626 and c.t_catid=807)";
   que=que+" else (select c.t_account from dmcaccdoc_dbt c  where c.t_docid=a.t_csaid and c.t_dockind=4626 and c.t_catid=808) end )  acc ";
   que=que+"  from ddvcsash_dbt a , ddvcsa_dbt b  where   to_char(a.t_dmain,'dd.mm.yyyy')='"+dat+"' and b.t_csaid=a.t_csaid   and/* a.t_morningsum*/ a.t_eveningsum < 0 /*kea*/  and a.t_cur = 0 ";

   rs45 = LnGetRecordSet(que);
   if(rs45 != null)
      while(rs45.moveNext)
         AddRowCSA(rs45, is2, dat);
         is2=is2+1;

      end;
   end;

   csvFile.FileClose();
   csvTable.FillTabelFromCSV(csvFile.GetlsFileName());
   csvTable.EndTable();

   printEngine.CopyAllSheetInTotalBook(SHEET_NAME,         //Имя закладки,по умолчанию имя закладки из шаблона
                              false, // true - на новый лист, false - на существующий(если имя листа отличается, всегда на новый лист)
                              csvTable.GetTableRange(),     //Что копировать м.б. диапозон вида "A1:T60" или имя именованного диапозона
                                 0,
                              SHEET_NAME) ;

   // BORROW RUB
   CSV_NAME   = "et_repp_borrow_csv.txt";
   SHEET_NAME = "BORROW";

   csvFile = C_CSVFile();
   if (printEngine.UsePoi())
      csvFile.SetLimitRow(FLUSH_COUNT_XLSX);
   end;
   fName = csvFile.CreateFullFileName(CSV_NAME);
   csvFile.FileOpen(fName, true);

   printEngine.SheetChange(SHEET_NAME);
   printEngine.CopyAllSheetInTotalBook (SHEET_NAME, false, "borrowHeader", 0, SHEET_NAME);

   csvTable = printEngine.RegisterTable("borrowTableRow", "borrowTableHeader", true);

   is2=1;
   
   que="select to_char(a.t_dealdate,'dd.mm.yyyy') d0 ,a.t_dealstatus dealstatus, to_char(b.t_start,'dd.mm.yyyy') d1 ,to_char(b.t_maturity,'dd.mm.yyyy') d2 ,";
   que=que+" b.t_principal principal,a.t_dealcodets dealcodets , c.t_name name, b.t_cost cost, b.t_price price, ";
   que=que+" b.t_point point, f.t_fi_code fiid, b.t_duration duration,a.t_dealid dealid,a.t_flag1 flag1, "; 
   que=que+" (case  when (select count(*) from dmcaccdoc_dbt aa where aa.t_docid=a.t_dealid and aa.t_dockind = 102 and aa.t_catid IN (111, 924) ) > 0 then ";
   que=que+"  (select t_account from (select aa.t_account from dmcaccdoc_dbt  aa where aa.t_docid=a.t_dealid and aa.t_dockind = 102 and aa.t_catid IN (111, 924) order by aa.t_activatedate desc, aa.t_id desc) where rownum = 1) ";
   que=que+"  else ' '  end ) acc  from  ddl_tick_dbt a , ddl_leg_dbt b , dparty_dbt c, dfininstr_dbt f where a.t_dealtype IN (12300, 12301) and a.t_bofficekind=102 "; 
   que=que+" and to_char(a.t_dealdate,'dd.mm.yyyy')= '"+dat+"' and b.t_dealid=a.t_dealid and b.t_pfi=0  ";
   que=que+" and c.t_partyid=a.t_partyid and f.t_fiid=b.t_pfi order by a.t_partyid ";

   rs45 = LnGetRecordSet(que);
   if(rs45 != null)
      while(rs45.moveNext)
         AddRow(rs45, is2, dat);
         is2=is2+1;
      end;
   end;

   // BORROW CSA

   que="select a.t_csaid dealid,  to_char(b.t_begdate,'dd.mm.yyyy')  d0, a.t_cur cur ,a.t_rate price,  b.t_code dealcodets,a.t_insum principal, (select f.t_fi_code from dfininstr_dbt f where  f.t_fiid=a.t_cur) fiid, (a.t_morningsum +a.t_insum-a.t_outsum) cost, (select d.t_name from dparty_dbt d where d.t_partyid=b.t_partyid) name, ";
   que=que+" (case when /* a.t_morningsum*/ a.t_eveningsum /*kea*/ > 0 then (select c.t_account from dmcaccdoc_dbt c where c.t_docid=a.t_csaid and c.t_dockind=4626 and c.t_catid=807)";
   que=que+" else (select c.t_account from dmcaccdoc_dbt c  where c.t_docid=a.t_csaid and c.t_dockind=4626 and c.t_catid=808) end )  acc ";
   que=que+"  from ddvcsash_dbt a , ddvcsa_dbt b  where   to_char(a.t_dmain,'dd.mm.yyyy')='"+dat+"' and b.t_csaid=a.t_csaid   and /*a.t_morningsum > 0*/a.t_eveningsum > 0 /*kea*/  and a.t_cur = 0 ";

   rs45 = LnGetRecordSet(que);
   if(rs45 != null)
      while(rs45.moveNext)
         AddRowCSA(rs45, is2, dat);
         is2=is2+1;
      end;
   end;
   
   csvFile.FileClose();
   csvTable.FillTabelFromCSV(csvFile.GetlsFileName());
   csvTable.EndTable();

   printEngine.CopyAllSheetInTotalBook(SHEET_NAME,         //Имя закладки,по умолчанию имя закладки из шаблона
                              false, // true - на новый лист, false - на существующий(если имя листа отличается, всегда на новый лист)
                              csvTable.GetTableRange(),     //Что копировать м.б. диапозон вида "A1:T60" или имя именованного диапозона
                                 0,
                              SHEET_NAME) ;

   // LEND val
   CSV_NAME   = "et_repp_lendv_csv.txt";
   SHEET_NAME = "LEND-v";

   csvFile = C_CSVFile();
   if (printEngine.UsePoi())
      csvFile.SetLimitRow(FLUSH_COUNT_XLSX);
   end;
   fName = csvFile.CreateFullFileName(CSV_NAME);
   csvFile.FileOpen(fName, true);

   printEngine.SheetChange(SHEET_NAME);
   printEngine.CopyAllSheetInTotalBook (SHEET_NAME, false, "lendvHeader", 0, SHEET_NAME);

   csvTable = printEngine.RegisterTable("lendvTableRow", "lendvTableHeader", true);

   is2=1;

   que="select to_char(a.t_dealdate,'dd.mm.yyyy') d0 ,a.t_dealstatus dealstatus, to_char(b.t_start,'dd.mm.yyyy') d1 ,to_char(b.t_maturity,'dd.mm.yyyy') d2 ,";
   que=que+" b.t_principal principal,a.t_dealcodets dealcodets , c.t_name name, b.t_cost cost, b.t_price price, ";
   que=que+" b.t_point point, f.t_fi_code fiid, b.t_duration duration,a.t_dealid dealid,a.t_flag1 flag1, "; 
   que=que+" (case  when (select count(*) from dmcaccdoc_dbt aa where aa.t_docid=a.t_dealid and aa.t_dockind = 102 and aa.t_catid=111 ) > 0 then ";
   que=que+"  (select t_account from (select aa.t_account from dmcaccdoc_dbt  aa where aa.t_docid=a.t_dealid and aa.t_dockind = 102 and aa.t_catid=111 order by aa.t_activatedate desc, aa.t_id desc) where rownum = 1) ";
   que=que+"  else ' '  end ) acc  from  ddl_tick_dbt a , ddl_leg_dbt b , dparty_dbt c, dfininstr_dbt f where a.t_dealtype=12305 and a.t_bofficekind=102 "; 
   que=que+" and to_char(a.t_dealdate,'dd.mm.yyyy')= '"+dat+"' and b.t_dealid=a.t_dealid and b.t_pfi> 0   ";
   que=que+" and c.t_partyid=a.t_partyid and f.t_fiid=b.t_pfi order by a.t_partyid ";

   rs45 = LnGetRecordSet(que);
   if(rs45 != null)
      while(rs45.moveNext)
         AddRow(rs45, is2, dat);
         is2=is2+1;
      end;
   end;

   // lend val CSA
   que="select a.t_csaid dealid,  to_char(b.t_begdate,'dd.mm.yyyy')  d0 , a.t_cur cur,  a.t_rate price,  b.t_code dealcodets,a.t_insum principal, (select f.t_fi_code from dfininstr_dbt f where  f.t_fiid=a.t_cur) fiid, (a.t_morningsum +a.t_insum-a.t_outsum) cost, (select d.t_name from dparty_dbt d where d.t_partyid=b.t_partyid) name, ";
   que=que+" (case when /* a.t_morningsum*/ a.t_eveningsum /*kea*/ > 0 then (select c.t_account from dmcaccdoc_dbt c where c.t_docid=a.t_csaid and c.t_dockind=4626 and c.t_catid=807)";
   que=que+" else (select c.t_account from dmcaccdoc_dbt c  where c.t_docid=a.t_csaid and c.t_dockind=4626 and c.t_catid=808) end )  acc ";
   que=que+"  from ddvcsash_dbt a , ddvcsa_dbt b  where   to_char(a.t_dmain,'dd.mm.yyyy')='"+dat+"' and b.t_csaid=a.t_csaid   and/* a.t_morningsum*/ a.t_eveningsum < 0 /*kea*/  and a.t_cur > 0 ";

   rs45 = LnGetRecordSet(que);
   if(rs45 != null)
      while(rs45.moveNext)
         AddRowCSA(rs45, is2, dat, true);
         is2=is2+1;
      end;
   end;

   csvFile.FileClose();
   csvTable.FillTabelFromCSV(csvFile.GetlsFileName());
   csvTable.EndTable();

   printEngine.CopyAllSheetInTotalBook(SHEET_NAME,         //Имя закладки,по умолчанию имя закладки из шаблона
                              false, // true - на новый лист, false - на существующий(если имя листа отличается, всегда на новый лист)
                              csvTable.GetTableRange(),     //Что копировать м.б. диапозон вида "A1:T60" или имя именованного диапозона
                                 0,
                              SHEET_NAME) ;

   // BORROW val
   CSV_NAME   = "et_repp_borrowv_csv.txt";
   SHEET_NAME = "BORROW-v";

   csvFile = C_CSVFile();
   if (printEngine.UsePoi())
      csvFile.SetLimitRow(FLUSH_COUNT_XLSX);
   end;
   fName = csvFile.CreateFullFileName(CSV_NAME);
   csvFile.FileOpen(fName, true);

   printEngine.SheetChange(SHEET_NAME);
   printEngine.CopyAllSheetInTotalBook (SHEET_NAME, false, "borrowvHeader", 0, SHEET_NAME);

   csvTable = printEngine.RegisterTable("borrowvTableRow", "borrowvTableHeader", true);

   is2=1;

   que="select to_char(a.t_dealdate,'dd.mm.yyyy') d0 ,a.t_dealstatus dealstatus, to_char(b.t_start,'dd.mm.yyyy') d1 ,to_char(b.t_maturity,'dd.mm.yyyy') d2 ,";
   que=que+" b.t_principal principal,a.t_dealcodets dealcodets , c.t_name name, b.t_cost cost, b.t_price price, ";
   que=que+" b.t_point point, f.t_fi_code fiid, b.t_duration duration,a.t_dealid dealid,a.t_flag1 flag1, "; 
   que=que+" (case  when (select count(*) from dmcaccdoc_dbt aa where aa.t_docid=a.t_dealid and aa.t_dockind = 102 and aa.t_catid IN (111, 924) ) > 0 then ";
   que=que+"  (select t_account from (select aa.t_account from dmcaccdoc_dbt  aa where aa.t_docid=a.t_dealid and aa.t_dockind = 102 and aa.t_catid IN (111, 924) order by aa.t_activatedate desc, aa.t_id desc) where rownum = 1) ";
   que=que+"  else ' '  end ) acc  from  ddl_tick_dbt a , ddl_leg_dbt b , dparty_dbt c, dfininstr_dbt f where a.t_dealtype IN (12300, 12301) and a.t_bofficekind=102 "; 
   que=que+" and to_char(a.t_dealdate,'dd.mm.yyyy')= '"+dat+"' and b.t_dealid=a.t_dealid and b.t_pfi > 0  ";
   que=que+" and c.t_partyid=a.t_partyid and f.t_fiid=b.t_pfi order by a.t_partyid ";

   rs45 = LnGetRecordSet(que);
   if(rs45 != null)
      while(rs45.moveNext)
         AddRow(rs45, is2, dat);
         is2=is2+1;
      end;
   end;

   // BORROW val CSA
   que="select a.t_csaid dealid,  to_char(b.t_begdate,'dd.mm.yyyy')  d0, a.t_cur cur ,a.t_rate price,  b.t_code dealcodets,a.t_insum principal, (select f.t_fi_code from dfininstr_dbt f where  f.t_fiid=a.t_cur) fiid, (a.t_morningsum +a.t_insum-a.t_outsum)  cost, (select d.t_name from dparty_dbt d where d.t_partyid=b.t_partyid) name, ";
   que=que+" (case when /* a.t_morningsum*/ a.t_eveningsum /*kea*/ > 0 then (select c.t_account from dmcaccdoc_dbt c where c.t_docid=a.t_csaid and c.t_dockind=4626 and c.t_catid=807)";
   que=que+" else (select c.t_account from dmcaccdoc_dbt c  where c.t_docid=a.t_csaid and c.t_dockind=4626 and c.t_catid=808) end )  acc ";
   que=que+"  from ddvcsash_dbt a , ddvcsa_dbt b  where   to_char(a.t_dmain,'dd.mm.yyyy')='"+dat+"' and b.t_csaid=a.t_csaid   and/* a.t_morningsum*/ a.t_eveningsum > 0 /*kea*/ and a.t_cur > 0 ";

   rs45 = LnGetRecordSet(que);
   if(rs45 != null)
      while(rs45.moveNext)
         AddRowCSA(rs45, is2, dat, true);
         is2=is2+1;
      end;
   end;

   csvFile.FileClose();
   csvTable.FillTabelFromCSV(csvFile.GetlsFileName());
   csvTable.EndTable();

   printEngine.CopyAllSheetInTotalBook(SHEET_NAME,         //Имя закладки,по умолчанию имя закладки из шаблона
                              false, // true - на новый лист, false - на существующий(если имя листа отличается, всегда на новый лист)
                              csvTable.GetTableRange(),     //Что копировать м.б. диапозон вида "A1:T60" или имя именованного диапозона
                                 0,
                              SHEET_NAME) ;
   
   //

   showRep("et_repp");
   msgbox("Отчет сформирован !");

   exit(1);





