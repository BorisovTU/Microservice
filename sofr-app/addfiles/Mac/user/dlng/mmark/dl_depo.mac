///////////////////////////////////////////////////////////////////////////////////
//*******************************************************************************//
//*  Модуль           : Импорт на базе макроса Шлюза                            *//
//*  Имя файла        : dl_ImpDeals.mac                                         *//	
//*  Описание         : Загрузка МБК/КО сделок в бэк-офис из шлюза              *//
//*  Программист      :                                                         *//
//*******************************************************************************//
///////////////////////////////////////////////////////////////////////////////////
IMPORT DealsInter, Проценты, PTInter, PaymInter, "gtconst.inc","rgtgtrec.mac", "gtdlfun.mac", "dlref.mac", OprInter, SfInter, FIInter,Календарь, funk, dl_lib, dl_note_lib,fx_globals;

VAR ER,basi;

private macro GetNumZalog(sdognum, partyid)
  private var que, rs, dognum, i, e, anum = TArray;
  anum.Size = 0;
  i = 0;
  e = index(sdognum,"=");
  while ( e > 0)

     dognum = substr(sdognum, 1, (e-1) );
     que = "select t.t_contractid from ddl_order_dbt t where t.t_contractor="+string(partyid)+" and t.t_ordernumber='"+dognum+"'";
     rs = LnGetRecordSet(que);
     if(rs != null)
        if (rs.moveNext) 
           anum(i) = rs.value(0); 
        else
           anum(i) = 0; 
        end;
     end;

     i = i+1;
     e = index(sdognum,"=");
     sdognum = substr(sdognum, e+1);
  end;
  return  anum;
end;

private macro InsNewPrice(dealid, price)
   private var rs, que;
   que ="insert into dstd_pls_dbt ("+
         "t_id,   "+
         "t_dizm, "+ 
         "t_stav,  "+
         "t_kor_pro) values ("+
         string(dealid) + ","+
         "to_date('"+date()+"','dd.mm.yyyy'), "+
         string(price*Pow(10,6))+","+
         string(price)+")";
   rs  = LnGetRecordset(que);

end;

private macro RetBasis(FBasis)

  if  ( FBasis == "360/30" )
	return 1; 
  elif( FBasis == "360/ACT")
	return 2; 
  elif( FBasis == "365/ACT")
	return 3; 
  elif( FBasis == "ACT/ACT")
	return 4; 
  end;
  return 1; 
end;


//Обеспечение
private macro RetPOB(FPOB)

  if  ( FPOB == "ДА" )
	return 1; 
  elif( FPOB == "НЕТ")
	return 3; 
  end;
  return 1; 
end;

private macro AddField (ar, name, tp, sz, dec)

     ar [ar.size] = name;
     ar [ar.size] = tp;
     ar [ar.size] = sz;
     ar [ar.size] = dec;
     ar [ar.size] = 0;

end;


macro MakeArDeal()

      var ardeal = TArray;

      AddField (ardeal, "DEALID",   V_STRING,  10, 0);
      AddField (ardeal, "DEALTYPE", V_STRING,  2,  0);
      AddField (ardeal, "SOGL",     V_INTEGER, 4,  0);
      AddField (ardeal, "NUMBER",   V_STRING,  20,  0);
      AddField (ardeal, "VNUMBER",  V_STRING,  20,  0);
      AddField (ardeal, "DEALDATE", V_STRING,  11,  0);
      AddField (ardeal, "BEGDATE",  V_STRING,  11,  0);
      AddField (ardeal, "ENDDATE",  V_STRING,  11,  0);
      AddField (ardeal, "CONTR",    V_INTEGER,  4,  0);
      AddField (ardeal, "FILIAL",   V_INTEGER,  4,  0);
      AddField (ardeal, "PRINCIPAL",V_STRING,  10,  0);
      AddField (ardeal, "PPRINCIPAL",V_STRING, 10,  0);     //add
      AddField (ardeal, "PFI",      V_STRING,  10,  0);
      AddField (ardeal, "PRICE",    V_STRING,  10,  0);
      AddField (ardeal, "NEWPRICE", V_STRING,  10,  0);     //add
      AddField (ardeal, "PSLONG",   V_INTEGER,  4,  0);     //add
      AddField (ardeal, "BASIS",    V_STRING,  10,  0);
      AddField (ardeal, "PPRICE",   V_STRING,  10,  0);
      AddField (ardeal, "DINDEX",   V_INTEGER,  4,  0);
      AddField (ardeal, "TRADER",   V_INTEGER,  4,  0);
      AddField (ardeal, "ACCOUNT",  V_STRING,  21,  0);
      AddField (ardeal, "PACCOUNT", V_STRING,  21,  0);
      AddField (ardeal, "RACCOUNT", V_STRING,  21,  0);     //add
      AddField (ardeal, "RPACCOUNT",V_STRING,  21,  0);     //add
      AddField (ardeal, "POB",      V_STRING,  10,  0);
      AddField (ardeal, "ZCONTRACT",V_INTEGER,  4,  0);
      AddField (ardeal, "ZNCONTRACT",V_STRING, 50,  0);     //add
      AddField (ardeal, "OBAMOUNT", V_STRING,  10,  0);
      AddField (ardeal, "ZACCOUNT", V_STRING,  21,  0);     //add
      AddField (ardeal, "PPROLONG", V_STRING,  10,  0);
      AddField (ardeal, "PDATE",    V_STRING,  11,  0);
      AddField (ardeal, "PMPRICE",  V_INTEGER,  4,  0);     //add
      AddField (ardeal, "DPLAMOUNT",V_STRING,  10,  0);     //add
      AddField (ardeal, "SROK",     V_INTEGER,  4,  0);     //add
      AddField (ardeal, "PRACCOUNT",V_STRING,  21,  0);     //add
      AddField (ardeal, "PRPACCOUNT",V_STRING, 21,  0);     //add
      AddField (ardeal, "COMMENT",  V_STRING,  100, 0);

      return ardeal;
end;

var locdeal = TRecHandler ("deal", MakeArDeal());


    macro InsAccount(dockind, dealid, acc, catid, catnum, duration )
      var que, rs0, pid;

      if (duration == 0)
	      pid = 0;
      elif (duration == 1)
 	      pid = 1;
      elif ((duration>1) and (duration <= 7))
 	      pid = 2;
      elif ((duration>7) and (duration <= 31))
 	      pid = 3;
      elif ((duration>32) and (duration <= 91))
 	      pid = 4;
      elif ((duration>92) and (duration <= 181))
 	      pid = 5;
      elif ((duration>181) and (duration <= 367))
 	      pid = 6;
      elif ((duration>367) and (duration <= 1097))
 	      pid = 7;
      else
              pid = 8;
      end;

      que = "insert into dmcaccdoc_dbt "+ 
            "(t_dockind,      "+
            " t_catid,        "+
            " t_catnum,       "+
            " t_docid,        "+
            " t_account,      "+
            " t_actiondate,   "+
            " t_activatedate, "+
            " t_isusable,     "+
            " t_kind_account, "+
            " t_currency,     "+
            " t_fiid,         "+
            " t_templnum,     "+
            " t_groupnum,     "+
            " t_periodid,     "+
            " t_chapter,      "+
            " t_disablingdate,"+
            " t_iscommon,     "+ 
            " t_owner,        "+ 
            " t_place,        "+ 
            " t_issuer,       "+ 
            " t_departmentid, "+ 
            " t_branch,       "+ 
            " t_mcbranch,      "+ 
            " t_firole,       "+ 
            " t_centr,        "+ 
            " t_centroffice,  "+ 
            " t_clientcontrid,"+ 
            " t_bankcontrid,  "+ 
            " t_marketplaceid,"+ 
            " t_marketplaceofficeid,"+ 
            " t_indexdate,    "+ 
            " t_contractor,   "+ 
            " t_currencyeq,   "+
            " t_currencyeq_ratetype,"+
            " t_currencyeq_ratedate,"+
            " t_currencyeq_rateextra,"+
            " t_corrdepartmentid,"+ 
            " t_fiid2 )"+
            " values ("+
             String(dockind)+", " +
             String(catid) + ", " +
             String(catnum)+ ", " +    
             String(dealid)+","+
            "'"+ acc+"', "+
            " to_date('"+locdeal.rec.BEGDATE+"', 'DD.MM.YYYY'),"+
            " to_date('"+locdeal.rec.BEGDATE+"', 'DD.MM.YYYY'),"+
            " 'X', "+
            " (select t_kind_account from dbalance_dbt  where t_balance ='"+ substr(acc,1,5)+"'), "+
            " (select nvl((select t_fiid from dfininstr_dbt t where t_fi_kind=1 and t.t_fi_code='"+substr(acc,6,3)+"'), 0) from dual), "+
            " (select nvl((select t_fiid from dfininstr_dbt t where t_fi_kind=1 and t.t_fi_code='"+substr(acc,6,3)+"'), 0) from dual), "+
            "1, "+
            "0, "+
            pid+", "+
            "1, "+
            " to_date('01010001', 'DDMMYYYY'),"+
            "chr(0), "+
            "-1,"+
            "-1,"+
            "-1,"+
            locdeal.rec.FILIAL+","+
            locdeal.rec.FILIAL+","+
            locdeal.rec.FILIAL+","+
            "5,"+  //FiDoc
            "-1,"+
            "-1,"+
            "-1,"+
            "-1,"+
            "-1,"+
            "-1,"+
            "-1,"+
            "-1,"+
            "-1,"+
            "0,"+
            "0,"+
            "0.0,"+
            "0,"+
            "0 )";

      rs0 = LnGetRecordset(que);
end;


//Посчитать сумму процентов
private macro GetProcAmount(dealid)
  private var que, rs;
  que = "select nvl((select sum(t.t_amount) from dl_impplat_tmp t where t.t_systype = 1 and t.t_dealid="+dealid+" and t.t_type in (2,3)),0) from dual";
  rs = LnGetRecordSet(que);
  if(rs != null)
        if (rs.moveNext) 
            return rs.value(0) ; 
        else
            return 0;
        end;	
  else
        return 0;

  end;

end;


//Получить параметр основной сделки при вставке пролонгирующей
private macro GetIdOperation(DealType, dealpfi)
  private var que, rs, dealid;

  que = "select t.t_dealid from ddl_tick_dbt t, ddl_leg_dbt l where t.t_dealtype ='"+DealType+"' and t.t_bofficekind=102  and t.t_dealstatus=0 and t.t_dealid=l.t_dealid and " +
        "t.t_pfi = "+dealpfi +" and t.t_partyid="+locdeal.rec.CONTR +" and t.t_dealdate=to_date('"+locdeal.rec.DEALDATE+"', 'DD.MM.YYYY') and l.t_principal="+locdeal.rec.PRINCIPAL +" and l.t_start=to_date('"+locdeal.rec.BEGDATE+"', 'DD.MM.YYYY') and l.t_maturity =to_date('"+locdeal.rec.ENDDATE+"', 'DD.MM.YYYY')";
  rs = LnGetRecordSet(que);

  if(rs != null)
        if (rs.moveNext) 
            dealid =  rs.value(0) ; 
        else
            return 0;
        end;	
  end;

  que = "select t.t_id_operation from  doproper_dbt t where t.t_dockind=102 and t.t_documentid = lpad("+dealid+",34,'0')";
  rs = LnGetRecordSet(que);
  if(rs != null)
        if (rs.moveNext) 
            return  rs.value(0) ; 
        else
            return 0;
        end;	
  end;

end;

private class DlngPayment()
  private const
      mode_ins = 0,
      mode_upd = 1,
      mode_del = 2;

  private var
      prm_workMode = NULL;

  private var
      prm_pmObj  = NULL;

  macro SetPurpose(_Purpose, _SubPurpose)
      prm_pmObj.Purpose    = _Purpose;
      prm_pmObj.SubPurpose = _SubPurpose;
      prm_pmObj.Number     = String(_SubPurpose);
  end;

  macro SetDocKind(_DocKind)
      prm_pmObj.DocKind = _DocKind;
  end;

  macro SetDocumentID(_DocumentID)
      prm_pmObj.DocumentID = _DocumentID;
  end;

  macro SetDepartment(_Department)
      prm_pmObj.Department = _Department;
  end;

  macro SetFIID(_FIID)
      prm_pmObj.OrderFIID          =
      prm_pmObj.BaseFIID           = 
      prm_pmObj.PayerFIID          =
      prm_pmObj.ReceiverFIID       =
      prm_pmObj.FuturePayerFIID    =
      prm_pmObj.FutureReceiverFIID = _FIID;
  end;

  macro SetLegID(_LegID)
//      dprm_LegID = _LegID;
  end;

  macro SetNetting(_Netting)
      prm_pmObj.Netting  = _Netting;
  end;

  macro SetDate(_VDate, _RDate)
      prm_pmObj.Date                 = _VDate;
      prm_pmObj.PayDate              = 
      prm_pmObj.OutTransferDate      =
      prm_pmObj.ValueDate            = _RDate;
      prm_pmObj.ClientDate           = {curdate};
  end;

  macro SetAmount(_Amount)
      prm_pmObj.OrderAmount          =
      prm_pmObj.PayerAmount          = 
      prm_pmObj.ReceiverAmount       = 
      prm_pmObj.BaseAmount           =
      prm_pmObj.FutureBaseAmount     = _Amount;
      prm_pmObj.ActuateFutureAmounts(TBA_AMOUNT);
  end;

  macro SetGround(_Ground)
      prm_pmObj.Ground = _Ground;
  end;

  macro SetPayer(_Payer, _PayerCodeKind, _PayerBankID, _PayerBankIDCodeKind, _Kind_Operation, _FIID)
      RECORD settacc(settacc);
      RECORD settaccour(settacc);

      if (_Payer == {OurBank})

          if (not FindSETTACC_PMAUTO(_PayerBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, prm_pmObj.Purpose, 0, settaccour))
              ;
          elif (not FindSETTACC_PMAUTO(_PayerBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, 0, 0, settaccour))
              ;
          elif (not FindSETTACC_PMAUTO(_PayerBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, 0, prm_pmObj.Purpose, 0, settaccour))
              ;
          elif (not FindSETTACC_PMAUTO(_PayerBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, 0, 0, 0, settaccour))
              ;
          end;


          prm_pmObj.SetPayerPI(PAYMENTS_GROUP_UNDEF,
                              _PayerBankID,
                              _PayerBankIDCodeKind,
                              settaccour.BankCode, 
                              settaccour.BankName,  
                              "",//settaccour.CorrAcc,    //коррсчет
                              _FIID,
                              settaccour.Chapter,
                              settaccour.Account, 
                              _Payer, 
                              "",
                              settaccour.INN,
                              _PayerCodeKind,       
                              settacc.Code                // клиент
                              );



//          prm_pmObj.PayerBankName = settaccour.BankName; //prm_pmObj.PayerName;
//          prm_pmObj.PayerBankCorrCodeKind = PTCK_ALL;
//          prm_pmObj.PayerBankCorrCode     = "";
//          prm_pmObj.ReceiverInOurBalance  = "";
          prm_pmObj.ReceiverOurCorrAcc    = settaccour.CorrAcc;
//          prm_pmObj.ReceiverOurCorrID     = -1;

      else
          if (not FindSETTACC_PMAUTO(_PayerBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, prm_pmObj.Purpose, 0, settacc))
              ;
          elif (not FindSETTACC_PMAUTO(_PayerBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, 0, 0, settacc))
              ;
          elif (not FindSETTACC_PMAUTO(_PayerBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, 0, prm_pmObj.Purpose, 0, settacc))
              ;
          elif (not FindSETTACC_PMAUTO(_PayerBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, 0, 0, 0, settacc))
              ;
          end;

          prm_pmObj.SetPayerPI(PAYMENTS_GROUP_UNDEF,
                                _PayerBankID,
                                _PayerBankIDCodeKind,
                                 settacc.BankCode,
                                 settacc.BankName,  
                                 "", //settacc.CorrAcc,
                                 _FIID, /*          settacc.FIID,   */
                                 settacc.Chapter,
                                 settacc.Account, 
                                 _Payer,        /* settacc.PartyID,  */
                                 settacc.RecName,
                                 settacc.INN,
                                 _PayerCodeKind,  /*settacc.CodeKind, */
                                 settacc.Code  //clnt  
                                 );

          if (settacc.BankCorrID != {OurBank})
              prm_pmObj.PayerBankCorrAcc      = settacc.CorrAcc; 
              prm_pmObj.PayerBankCorrCodeKind = settacc.BankCorrCodeKind;
              prm_pmObj.PayerBankCorrCode     = settacc.BankCorrCode;
              prm_pmObj.PayerBankCorrName     = settacc.BankCorrName;
          end;

      end;
  end;

  macro SetReceiver(_Receiver, _ReceiverCodeKind, _ReceiverBankID, _ReceiverBankIDCodeKind, _Kind_Operation, _FIID);
      RECORD settaccour(settacc);
      RECORD settacc(settacc);

      if (_Receiver == {OurBank})

          if (not FindSETTACC_PMAUTO(_ReceiverBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, prm_pmObj.Purpose, 0, settaccour))
              ;
          elif (not FindSETTACC_PMAUTO(_ReceiverBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, 0, 0, settaccour))
              ;
          elif (not FindSETTACC_PMAUTO(_ReceiverBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, 0, prm_pmObj.Purpose, 0, settaccour))
              ;
          elif (not FindSETTACC_PMAUTO(_ReceiverBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, 0, 0, 0, settaccour))
              ;
          end;


          prm_pmObj.SetReceiverPI(PAYMENTS_GROUP_UNDEF,
                              _ReceiverBankID,
                              _ReceiverBankIDCodeKind,  
                              settaccour.BankCode,
                              settaccour.BankName,
                              "", //settaccour.CorrAcc,
                              _FIID,
                              settaccour.Chapter,
                              settaccour.Account, 
                              _Receiver,
                              "",
                              settaccour.INN,
                              _ReceiverCodeKind,   
                              settacc.Code  //clnt  
                              );

//          prm_pmObj.ReceiverBankName = settaccour.BankName; //prm_pmObj.ReceiverName;
//          prm_pmObj.ReceiverBankCorrCodeKind = PTCK_ALL;
//          prm_pmObj.ReceiverBankCorrCode     = "";
//          prm_pmObj.PayerInOurBalance  = "";
          prm_pmObj.PayerOurCorrAcc    = settaccour.CorrAcc;
//          prm_pmObj.PayerOurCorrID     = -1;

      else
          if (not FindSETTACC_PMAUTO(_ReceiverBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, prm_pmObj.Purpose, 0, settacc))
              ;
          elif (not FindSETTACC_PMAUTO(_ReceiverBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, 0, 0, settacc))
              ;
          elif (not FindSETTACC_PMAUTO(_ReceiverBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, 0, prm_pmObj.Purpose, 0, settacc))
              ;
          elif (not FindSETTACC_PMAUTO(_ReceiverBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, 0, 0, 0, settacc))
              ;
          end;

          prm_pmObj.SetReceiverPI(PAYMENTS_GROUP_UNDEF,
                                 _ReceiverBankID,
                                 _ReceiverBankIDCodeKind,
                                 settacc.BankCode,
                                 settacc.BankName,   
                                 "",                // settacc.CorrAcc,
                                 _FIID,             // settacc.FIID, 
                                 settacc.Chapter,
                                 settacc.Account, 
                                 _ReceiverBankID,   // settacc.PartyID, 
                                 settacc.RecName,
                                 settacc.INN,
                                 _ReceiverCodeKind,  // settacc.CodeKind,
                                 settacc.Code        //clnt  
                                 );

          if (settacc.BankCorrID != {OurBank})
              prm_pmObj.ReceiverBankCorrAcc      = settacc.CorrAcc;
              prm_pmObj.ReceiverBankCorrCodeKind = settacc.BankCorrCodeKind;
              prm_pmObj.ReceiverBankCorrCode     = settacc.BankCorrCode;
              prm_pmObj.ReceiverBankCorrName     = settacc.BankCorrName;
          end;

     end;    

  end;

  macro CreateNew()
      prm_pmObj.Actuate();

      if (prm_pmObj.Update())
          RunError("Ошибка при создании платежей.");
      end;
  end;

  private macro ClassConstructorNew()
      prm_workMode = mode_ins;

      prm_pmObj  = RsbPayment(0);
      prm_pmObj.Department       = {OperDprt};
      prm_pmObj.PaymStatus       = PM_PREPARING;
      prm_pmObj.IsPlanPaym       = "X";
      prm_pmObj.ValueDate        = {curdate};
      prm_pmObj.SubPurpose       = 0;
      prm_pmObj.Oper             = {oper};
      prm_pmObj.Origin           = PAYMENT_OR_AUTO;
  end;

  private macro ClassConstructor(CountParm)
      if (CountParm == 1)
          ClassConstructorNew();
      elif (CountParm == 2)
      //
      elif (CountParm == 5)
      //
      end;
  end;

  ClassConstructor(ParmCount());
end;
///////////////////////////////////////////////////////////////////////////////////
private class Ob_DealFileImport( obdeal )
  private var
      prm_SeanceID,
      prm_RecordID;

  private var
      prm_ObjID,
      prm_Comment;

  private var
      RG;

  private var
      prm_tick,
      prm_legBase,
      prm_legRev;

  private var
      prm_deferOp,
      prm_deferDoc;



  PRIVATE MACRO ДАТ0(s);
      private var ss,d1;
      ss=trim(substr(string(s),1,10));
      if (substr(ss,3,1) != "." )
       ss="0"+ss;
      end; 
      d1=date(ss);
      return(d1);
     END;


  private macro CreateTick(_BofficeKind)
    var
        type     = 0,
        DateP1C1 = date(0, 0, 0),
        DateP1C2 = date(0, 0, 0),
        DateP2C1 = date(0, 0, 0),
        DateP2C2 = date(0, 0, 0);

      prm_tick.rec.DealID      = 0;
      prm_tick.rec.BofficeKind = _BofficeKind;

      //Статические параметры   
      prm_tick.rec.TradeSystem = 0; // PTCK_REUTER;  //LKL???
      prm_tick.rec.DealStatus  = DL_PREPARING;
      prm_tick.rec.RegDate     = {curdate};
      prm_tick.rec.Oper        = {oper};   
      prm_tick.rec.ClientID    = ALLFININSTR;
      prm_tick.rec.DepositID   = ALLFININSTR;
      prm_tick.rec.MarketID    = ALLFININSTR;
      prm_tick.rec.PortfolioID = 0;
      prm_tick.rec.IndocID     = 0;
      prm_tick.rec.NumberPack  = 0;
//      prm_tick.rec.Department  = {OperDprt};
      prm_tick.rec.Department  = locdeal.rec.FILIAL;
      prm_tick.rec.OriginID    = 0; // GT_REUTERS;  //LKL???
      prm_tick.rec.Netting     = 1;
      prm_tick.rec.LinkChannel = 0;
      prm_tick.rec.conftpid    = 2; //SWIFT код подтверждения


      //ID
//      prm_tick.rec.DealID = locdeal.rec.DEALID;

      //Генеральное соглашение
      prm_tick.rec.GenagrID = locdeal.rec.SOGL;

      //Номер сделки в торговой системе
      prm_tick.rec.DealCodeTS = locdeal.rec.NUMBER; 

      //Дата заключения сделки   
      prm_tick.rec.DealDate =  ДАТ0(locdeal.rec.DEALDATE); 

      //Время заключения сделки   
      prm_tick.rec.DealTime = Time(0,0,0);

      //Дилер   
	prm_tick.rec.TraderID = locdeal.rec.TRADER;

      //Идентификатор контрагента   
	prm_tick.rec.PartyID = locdeal.rec.CONTR;

//      if (prm_tick.rec.PartyID == -1)
//          RunError( "Ошибка при создании новой сделки: не задан контрагент." );
//      end;

      //Брокер   
//      if((GetParmByName(RG, "RGREU_510", @prm_tick.rec.BrokerID, @type) == NULL)or(type != V_INTEGER))
//          RunError("Не найден параметр RGREU_510 объекта " + String(prm_RecordID));
//      end;

      //Системный тип документа   
        prm_tick.rec.TypeDoc = "L";

      //Комментарий
      prm_tick.rec.Comment = locdeal.rec.COMMENT;

      //тип сделки


      if (  prm_tick.rec.PARTYID == _BANK_RF )
        if   ( trim(locdeal.rec.DEALTYPE) == "П" )
            prm_tick.rec.DealType = 22300;
        elif ( trim(locdeal.rec.DEALTYPE) == "Р" )
            prm_tick.rec.DealType = 22305; 
        end;
      else
        if   ( trim(locdeal.rec.DEALTYPE) == "П" )
            prm_tick.rec.DealType = 12300;
        elif ( trim(locdeal.rec.DEALTYPE) == "Р" )
            prm_tick.rec.DealType = 12305; 
        end;
      end;


      //Группа сделки
      prm_tick.rec.DealGroup = GetOperationGroup (prm_tick.rec.DealType);


     //генерим номер сделки - не генерим
     prm_tick.rec.DealCode = locdeal.rec.VNUMBER;
//         prm_tick.rec.DealCode=Kol_sdel(prm_tick.rec.DealDate,prm_tick.rec.PartyID,prm_tick.rec.DealType);

//lkl???
//prm_tick.rec.userfield3= prm_tick.rec.Comment;



      if (not prm_tick.insert)
          RunError("Ошибка при создании новой сделки." );
      end;

//Добавим примечания на сделку

      SetNoteDifValue( prm_tick.rec.DealID, 121, locdeal.rec.DEALID );
      if ( (locdeal.rec.PPROLONG =="ДА") and (strlen(locdeal.rec.PDATE)==10) )
       	SetNoteDifValue( prm_tick.rec.DealID, 120, ДАТ0(locdeal.rec.PDATE) );
      end;

  end;

private macro Basis_mbk(s1,s2)
        private var que,rs10,rez;
            rez=100;

//в селекте некотораяя избыточность
            if ( s1 == 12305 ) //  размещение
               que="select t_number from dprccalc_dbt where t_chargescheduleid=2 and t_groupcalcid=2 and t_resourcekind=2 and t_calendar='"+s2+"'";

            elif ( s1 == 12300 ) // привлечение
               que="select t_number from dprccalc_dbt where t_chargescheduleid=2 and t_groupcalcid=3 and t_resourcekind=1 and t_calendar='"+s2+"'";
            end;
    	    rs10 = LnGetRecordset(que);
            if(rs10 != null)
              if (rs10.moveNext) 
                 rez=rs10.value(0);
              end;
            end;
            return rez;
        end;

  private macro CreateLeg()
    var
        type     = 0,
        DateP1C1 = date(0, 0, 0),
        DateP1C2 = date(0, 0, 0),
        DateP2C1 = date(0, 0, 0),
        DateP2C2 = date(0, 0, 0);

      prm_legBase.rec.DepositID    = ALLFININSTR;
      prm_legBase.rec.Registrar    = ALLFININSTR;
      prm_legBase.rec.Pitch        = 1;
      prm_legBase.rec.Mode         = 1;
      prm_legBase.rec.PeriodNumber = 10000;
      prm_legBase.rec.PeriodType   = 3;
      prm_legBase.rec.Diff         = 0;
      prm_legBase.rec.PayDay       = 0;
      prm_legBase.rec.TablePercent = "";
      prm_legBase.rec.Caption      = 0;
      prm_legBase.rec.TypeDate     = 0;
      prm_legBase.rec.CountDay     = 0;
      prm_legBase.rec.Correct      = 0;

      prm_legBase.rec.DealID = prm_tick.rec.DealID;

      //валюта
      prm_legBase.rec.PFI = GetFiidCodeByName(locdeal.rec.PFI);

      //сумма
      prm_legBase.rec.Principal = Money(locdeal.rec.PRINCIPAL);

      prm_legBase.rec.LegNumber = prm_tick.rec.DealCode;	  

//      elif (prm_tick.rec.BofficeKind == DL_IBCDOC)
          //статические параметры    
          prm_legBase.rec.LegID = 1;
          prm_legBase.rec.Scale = 100;

          if (ValType(GetRegistryValue ("MMARK\\ОБЩИЕ\\ТОЧНОСТЬ", V_INTEGER, prm_legBase.rec.Point)) == V_UNDEF)
              prm_legBase.rec.Point = 4;
          end;


          if (  prm_tick.rec.PARTYID == _BANK_RF )
              prm_legBase.rec.Point = 2;
          end;

          prm_legBase.rec.CFI = prm_legBase.rec.PFI;

          //Действующая ставка 
          if (locdeal.rec.PSLONG == 0)
             prm_legBase.rec.Price = Double(locdeal.rec.PRICE);    //проценты
             InsNewPrice(prm_tick.rec.DealID, Double(locdeal.rec.NEWPRICE));
          else
             prm_legBase.rec.Price = Double(locdeal.rec.PRICE)*100;    //доли  ???
          end;
//          if((GetParmByName(RG, "RGREU_520", @prm_legBase.rec.Price, @type) == NULL)or(type != V_DOUBLE))
//              RunError("Не найден параметр RGREU_520 объекта " + String(prm_RecordID));
//          else
//              prm_legBase.rec.Price = prm_legBase.rec.Price * pow(10, prm_legBase.rec.Point);
//          end;

          // Даты валютирования
          prm_legBase.rec.Start = ДАТ0(locdeal.rec.BEGDATE); 
          prm_legBase.rec.Maturity = ДАТ0(locdeal.rec.ENDDATE); 

          //Сумма процентов

//add          prm_legBase.rec.Cost = GetProcAmount(locdeal.rec.DEALID);
          prm_legBase.rec.Cost = locdeal.rec.PPRINCIPAL;

          //Количество дней в сделке для расчета процентов
          prm_legBase.rec.Duration = prm_legBase.rec.Maturity - prm_legBase.rec.Start;

          //Таблица процентов
          if (locdeal.rec.PPRICE == "ДА")
              prm_legBase.rec.TablePercent = "X"; 
              prm_legBase.rec.TypePercent = 1; 
              prm_legBase.rec.Caption = locdeal.rec.DINDEX;
              prm_legBase.rec.Correct = (locdeal.rec.PMPRICE)*Double(locdeal.rec.DPLAMOUNT); // add
          end;

          //Базис расчета процентов
          prm_legBase.rec.Basis = RetBasis(locdeal.rec.BASIS); 

/*
          if ( prm_legBase.rec.Basis == 2 )
               prm_legBase.rec.Basis = 1;
          elif ( prm_legBase.rec.Basis == 8 )
               prm_legBase.rec.Basis = 4;
          end;

          if (prm_tick.rec.partyid == 2)
            prm_legBase.rec.Basis=2;
          end;
*/

          basi=Basis_mbk(prm_tick.rec.dealtype, prm_legBase.rec.Basis);

  
          if (not prm_legBase.insert)
              RunError( "Ошибка при создании новой сделки." );
          end;
//      end;
  end;

  private macro CreatePaym(ftype, rdate, vdate, amount, fiid)
//  private macro CreatePaym(ftype, rdate, vdate, amount, fiid, pbank, pacc)
    var
        paym       = DlngPayment(),
        Purpose,
        TypeBankCode = 3,
        type         = 0,
        BankID       = -1,
        Ground       = "";

      paym.SetDocKind(prm_tick.rec.BofficeKind);
      paym.SetDocumentID(prm_tick.rec.DealID);
      paym.SetPurpose(Purpose, 0);
      paym.SetDepartment(prm_tick.rec.Department);
      paym.SetDate(vdate, rdate);
      paym.SetAmount(amount);
      paym.SetFIID(fiid);

      BankID = prm_tick.rec.PartyID;

      if (fiid==0)
         TypeBankCode = PTCK_BIC;
      else
         TypeBankCode = PTCK_SWIFT;
      end;
/*
      if (prm_tick.rec.Netting == 3)
          paym.SetNetting("X");
      else
          paym.SetNetting("");
      end;
*/



      if (ftype == 0)
          Purpose = PM_PURP_PRINC;
          paym.SetLegID(prm_legBase.rec.LegID);
          paym.SetPurpose(Purpose, 0);
          Ground = "Предоставление средств по сделке №"+locdeal.rec.NUMBER+" от "+locdeal.rec.DEALDATE;
          paym.SetGround(Ground);

          if (IsCOMMITMENT (prm_tick.rec.DealGroup, Purpose))
              paym.SetPayer({OurBank}, TypeBankCode, {OurBank}, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
              paym.SetReceiver(prm_tick.rec.PartyID, TypeBankCode, BankID, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
          else
              paym.SetReceiver({OurBank}, TypeBankCode, {OurBank}, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
              paym.SetPayer(prm_tick.rec.PartyID, TypeBankCode, BankID, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
          end;

       elif (ftype == 1)
          Purpose = PM_PURP_PRINC_RET;
          paym.SetLegID(prm_legBase.rec.LegID);
          paym.SetPurpose(Purpose, 0);
          Ground = "Погашение основного долга по сделке №"+locdeal.rec.NUMBER+" от "+locdeal.rec.DEALDATE;
          paym.SetGround(Ground);

          if (IsCOMMITMENT (prm_tick.rec.DealGroup, Purpose))
              paym.SetPayer({OurBank}, TypeBankCode, {OurBank}, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
              paym.SetReceiver(prm_tick.rec.PartyID, TypeBankCode, BankID, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
          else
              paym.SetReceiver({OurBank}, TypeBankCode, {OurBank}, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
              paym.SetPayer(prm_tick.rec.PartyID, TypeBankCode, BankID, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
          end;

      elif (ftype == 2)
          Purpose = PM_PURP_PERCENT;
          paym.SetLegID(prm_legBase.rec.LegID);
          paym.SetPurpose(Purpose, 1);
          Ground = "Проценты по сделке №"+locdeal.rec.NUMBER+" от "+locdeal.rec.DEALDATE;
          paym.SetGround(Ground);

          if (IsCOMMITMENT (prm_tick.rec.DealGroup, Purpose))
              paym.SetPayer({OurBank}, TypeBankCode, {OurBank}, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
              paym.SetReceiver(prm_tick.rec.PartyID, TypeBankCode, BankID, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
          else
              paym.SetReceiver({OurBank}, TypeBankCode, {OurBank}, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
              paym.SetPayer(prm_tick.rec.PartyID, TypeBankCode, BankID, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
          end;

      elif (ftype == 3)
          Purpose = PM_PURP_PERCENT;
          paym.SetLegID(prm_legBase.rec.LegID);
          paym.SetPurpose(Purpose, 1);
          Ground = "Проценты по сделке №"+locdeal.rec.NUMBER+" от "+locdeal.rec.DEALDATE;
          paym.SetGround(Ground);

          if (IsCOMMITMENT (prm_tick.rec.DealGroup, Purpose))
              paym.SetReceiver({OurBank}, TypeBankCode, {OurBank}, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
              paym.SetPayer(prm_tick.rec.PartyID, TypeBankCode, BankID, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec);
          else
              paym.SetPayer({OurBank}, TypeBankCode, {OurBank}, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
              paym.SetReceiver(prm_tick.rec.PartyID, TypeBankCode, BankID, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
          end;

      end;

      paym.CreateNew();

  end;


  private macro CreateDeferOperation()
      ClearRecord(prm_deferOp);

      prm_deferOp.rec.id_operation   = 0; 
      prm_deferOp.rec.kind_operation = prm_tick.rec.DealType;
      prm_deferOp.rec.init_oper      = {oper};
      prm_deferOp.rec.dockind        = prm_tick.rec.bofficekind;
//      prm_deferOp.rec.start_date    = prm_legBase.rec.Start;
      prm_deferOp.rec.deferdate      = prm_legBase.rec.Start;
      prm_deferOp.rec.syst_date      = date();
      prm_deferOp.rec.syst_time      = time();
      prm_deferOp.rec.boactions      = 1;

      if (prm_tick.rec.bofficekind == DL_IBCDOC)
          prm_deferOp.rec.documentid = UniID(prm_tick, OBJTYPE_MMARKDEAL);
      end;

      if (not prm_deferOp.insert)
          RunError( "Ошибка при создании новой сделки." );
      end;

      if ( locdeal.rec.PPROLONG == "ДА")
         ClearRecord(prm_deferDoc);
         prm_deferDoc.rec.dockind = prm_tick.rec.bofficekind;;
         prm_deferDoc.rec.origin  = 0;
         prm_deferDoc.rec.status  = 0;
//lkl не работает         prm_deferDoc.rec.id_step = 0;
         prm_deferDoc.rec.id_operation = GetIdOperation(prm_tick.rec.DealType, prm_legBase.rec.PFI);  //Для пролонгирующей ссылка на основную id_operation;
         prm_deferDoc.rec.documentid   = prm_deferOp.rec.documentid; // UniID(prm_tick, OBJTYPE_MMARKDEAL);
         if (not prm_deferDoc.insert)
             RunError( "Ошибка при создании новой сделки." );
         end;

      end;


  end;


//Обеспечение
  private macro CreateQLT()
    var
        qlt = Tbfile("mmdqlt.dbt", "W");

      ClearRecord(qlt);

      qlt.rec.DealID  = prm_tick.rec.DealID;
      qlt.rec.Date    = prm_tick.rec.DealDate;
      qlt.rec.Quality = RetPOB(locdeal.rec.POB);

      if (not qlt.insert)
          RunError( "Ошибка при создании новой сделки." );
      end;	  
  end;


//Договор залога
  private macro CreateGrnt()
    private var count, i, alist = tarray(); 
    private var grnt = Tbfile("dl_grnt.dbt", "W");

//Договор из примечания
      ClearRecord(grnt);
      grnt.rec.DealID      = prm_tick.rec.DealID;
      grnt.rec.ContractId  = locdeal.rec.ZCONTRACT;
      grnt.rec.Amount      = Money(locdeal.rec.OBAMOUNT);

      if (not grnt.insert)
          RunError( "Ошибка при создании новой сделки." );
      end;	  

//цикл по списку договоров
      alist = Tarray(GetNumZalog(locdeal.rec.ZNCONTRACT, prm_tick.rec.partyid));

      i = 0;
      count = alist.Size;
      while (i < count)
          alist.value(i);
          if (alist.value(i) > 0) 
            ClearRecord(grnt);
            grnt.rec.DealID      = prm_tick.rec.DealID;
            grnt.rec.ContractId  = alist.value(i);
            grnt.rec.Amount      = 0.0;

            if (not grnt.insert)
                RunError( "Ошибка при создании новой сделки." );
            end;	  
          end;
          i =i + 1;
      end;

  end;

//Процентный договор
  private macro CreatePcAcc(_type)
      var 
          prm       = TPrcContractPrm,
          Contract  = 0,
          Sum       = Money(0);

      prm.BackOffice     = 2;
      prm.ObjectType     = 103;
      prm.ObjectID       = prm_tick.rec.DealCode;//String(prm_tick.rec.DealID) + " 1";     
      prm.CalcNumber     = basi;
      prm.IsUserCalc     = "";    
      prm.RateNumber     = 100;
      prm.IsUserRate     = "X";
      prm.ContractType   = _type;  
      prm.ContractNumber = 0;
      prm.Client         = prm_tick.rec.PartyID; //lkl {OurBank};        
      prm.ClientQuality  = 1;
      prm.BeginDate      = prm_legBase.rec.Start;     
      prm.EndDate        = prm_legBase.rec.Maturity;       
      prm.Oper           = {Oper};


      if (Prc_CreateContractByObject(prm, Contract))
          RunError( "Ошибка при создании новой сделки !!!" );
      elif (_type == 7)
          Prc_SetRateVal (Contract, prm_legBase.rec.Start, (prm_legBase.rec.Price / pow(10, prm_legBase.rec.Point)), false); 
          Prc_CalcPeriodOnDate (Contract, 3, prm_legBase.rec.Maturity, 1, Sum); 
      end;
  end;

  private macro CreateMMDeal()
      private var que, rs, rsp, ftype, pfiid, cbank, caccount, obank, oaccount,;

      CreateTick(DL_IBCDOC);
      CreateLeg();

      CreateQLT();

      CreatePcAcc(7);
      CreatePcAcc(9);
      CreatePcAcc(10);

      InsAccount(102, prm_tick.rec.DealID, locdeal.rec.ACCOUNT, 111, 601, prm_legBase.rec.Duration); //КУ ОД
      if (prm_tick.rec.DealType == 12305)
	 InsAccount(102, prm_tick.rec.DealID, locdeal.rec.PACCOUNT, 117, 621, 0);    //КУ +% к погашению
      elif (prm_tick.rec.DealType == 12300)
         InsAccount(102, prm_tick.rec.DealID, locdeal.rec.PACCOUNT, 118, 622, 0);    //КУ -% к погашению
      end;

      if ( strlen(locdeal.rec.RACCOUNT) == 20 );
        InsAccount(102, prm_tick.rec.DealID, locdeal.rec.RACCOUNT,   113,  243, 0);   //Счет по резерву ОД, КУ  Р, ссуды
      end;

      if ( strlen(locdeal.rec.RPACCOUNT) == 20 );
         InsAccount(102, prm_tick.rec.DealID, locdeal.rec.RPACCOUNT,  402, 1200, 0);  //Счет по резерву %, КУ  Р, %
      end;
//счета просрочки, если есть признак
      if (locdeal.rec.SROK == 1)
         if ( strlen(locdeal.rec.PRACCOUNT) == 20 );
             InsAccount(102, prm_tick.rec.DealID, locdeal.rec.PRACCOUNT, 198,  700, 0); //Счет по просрочке ОД, КУ  Треб. с н.с.
         end;                                                                                             
         if ( strlen(locdeal.rec.PRPACCOUNT) == 20 );
             InsAccount(102, prm_tick.rec.DealID, locdeal.rec.PRPACCOUNT, 114,  611, 0); //Счет по просрочке %, КУ  +% с н.с.
         end;
      end;


      que ="select count(*) from dl_impplat_tmp where t_systype = 1 and t_dealid="+String(locdeal.rec.DEALID);
      rs = LnGetRecordset(que);
      if(rs != null)
        rs.moveNext;
        if (rs.value(0) == 0 )
//платежей нет
            pfiid = prm_legBase.rec.PFI;

            CreatePaym( 0, prm_legBase.rec.Start, prm_legBase.rec.Start, prm_legBase.rec.Principal, pfiid );
            CreatePaym( 1, prm_legBase.rec.Maturity, prm_legBase.rec.Maturity, prm_legBase.rec.Principal, pfiid );
            CreatePaym( 2, prm_legBase.rec.Maturity, prm_legBase.rec.Maturity, prm_legBase.rec.Cost, pfiid );
        else;
//Цикл по платежам
            que ="select t_type, t_rdate, t_vdate, t_amount, t_fiid /*, t_obank, t_oaccount, t_pbank, t_paccount*/ from dl_impplat_tmp where t_systype = 1 and t_dealid="+String(locdeal.rec.DEALID);
            rsp = LnGetRecordset(que);
            if(rsp != null)
              while (rsp.moveNext) 

                   CreatePaym( rsp.value(0), rsp.value(1), rsp.value(2), rsp.value(3), rsp.value(4) );

              end;
            end;
        end;
      end;


      CreateDeferOperation();

      if (locdeal.rec.ZCONTRACT>0)
         CreateGrnt(locdeal.rec.ZCONTRACT);

         if ( strlen(locdeal.rec.ZACCOUNT) == 20 );
             InsAccount(126, locdeal.rec.ZCONTRACT, locdeal.rec.ZACCOUNT,   147, 508, 0);     //Счет учета залога по договору обеспечения, КУ +Обесп. кр., ц/б   
         end;

      end;

      return true;
  end;

  private macro CreateDealTrn()
    var
        retVal = true;

          retVal = CreateMMDeal();

      return retVal;

    OnError( RslErrObj )
      prm_Comment = RslErrObj.Message;

      AbortTrn();
      return false;
  end;

  macro CreateDeal()
    macro Local_CreateDealTrn()
        return CreateDealTrn();
    end;

      if (not ProcessTrn(0, "Local_CreateDealTrn"))
          return 1;
      end;

      prm_ObjID = prm_tick.rec.DealID;

      return 0;
  end;

  macro Get_ObjID()
      return prm_ObjID;
  end;

  macro Get_Comment()
      return prm_Comment;
  end;

  private macro ClassConstructor( obdeal)
      prm_SeanceID = 0; // _SeanceID;
      prm_RecordID = 0;// _RecordID;

      prm_ObjID   = -1;
      prm_Comment = "";


//msgbox(obdeal.rec.dealid);
      copy(locdeal, obdeal);
//msgbox(locdeal.rec.dealid);

      prm_tick    = Tbfile("dl_tick.dbt", "W");
      prm_legBase = Tbfile("dl_leg.dbt", "W");
      prm_legRev  = Tbfile("dl_leg.dbt", "W");

      prm_deferOp  = Tbfile("oproper.dbt", "W");
      prm_deferDoc = Tbfile("oprdocs.dbt", "W");

  end;

  ClassConstructor( obdeal);
end;

///////////////////////////////////////////////////////////////////////////////////
//вызываем транзакцию импорта сделки МБК, возвращаем нужные параметры	
macro _MoneyMarketDeal_CreateNew( obdeal ):INTEGER
  var 
      Obj = Ob_DealFileImport(obdeal),
      retVal = 0;

    retVal = Obj.CreateDeal(obdeal);

//    _NewID    = Obj.Get_ObjID();
//    _Comment = Obj.Get_Comment(); 

    return retVal;
end;
