import oralib, likepy, globals,fx_globals, CTInter;
IMPORT mmarkinter, OprInter,funk,dl_plib,dl_lib;

   private var que,rs9,ii,{curdate},da,dealid,rs5,fflag;

   var docKind=102, sql,nbank,fiid,debet,dealcode,sta;
   var exec, command1, command2, chainblockId,chainblockId0=4000019 ;

macro  shnpr()

   private var jj0,jj,acc4,ssu,ndealcode;
   jj0=0;
   da=СДАТ({curdate});

   que=" select count(*) from ddl_tick_dbt a, dpmpaym_dbt d where  a.t_bofficekind=102 and a.t_dealstatus=10  and a.t_partyid ="+_BANK_RF+" and (MMARK_UTL.IsBUY(MMARK_UTL.GetOperationGroup(a.t_dealtype)) > 0/*SVE 545517*/)  and d.t_dockind=102 and d.t_documentid=a.t_dealid and d.t_paymstatus< 32000    and d.t_valuedate = to_date('"+da+"','dd.mm.yyyy')";
   rs9 = LnGetRecordSet(que);
   if(rs9 != null)
     while(rs9.moveNext())
      jj0=int(rs9.value(0));
     end;
   end;

   InitProgress( jj0, "Инкассовые поручения МБК" );  

   jj=0;
   que=" select a.t_dealid, a.t_dealcode, d.t_fiid pfi, d.t_baseamount cost, a.t_dealtype dealtype from ddl_tick_dbt a, dpmpaym_dbt d where  a.t_bofficekind=102 and a.t_dealstatus=10  and a.t_partyid ="+_BANK_RF+" and (MMARK_UTL.IsBUY(MMARK_UTL.GetOperationGroup(a.t_dealtype)) > 0/*SVE 545517*/)  and d.t_dockind=102 and d.t_documentid=a.t_dealid and d.t_paymstatus< 32000    and d.t_valuedate = to_date('"+da+"','dd.mm.yyyy')";
   rs9 = LnGetRecordSet(que);
   if(rs9 != null)
     while(rs9.moveNext())
       useprogress(jj);
       jj=jj+1;
       dealid=int(rs9.value(0));
       ndealcode=rs9.value(1);
       fflag=0;

       que = "select COUNT(*) from dpmpaym_dbt a , dpmrmprop_dbt  b   where rownum=1 and   a.t_fiid=0 and a.t_receiveraccount='30102810700000000001'"; 
       que= que+" and to_char(a.t_valuedate,'dd.mm.yyyy')='"+da+"' and b.t_paymentid=a.t_paymentid and b.t_ground like '%"+ndealcode+"%' and b.t_ground like '%процент%'";
       rs5 = LnGetRecordSet(que);
       if(rs5 != null)
          if (rs5.moveNext) 
             if (int(rs5.value(0)) > 0 )
                fflag = 1
             end;
          end;
       end;

       if  (fflag == 1 )
         println("Инкассовые поручения МБК по сделке "+rs9.value(1));

         que= "select count(*)  from ddl_tick_dbt c1, doproper_dbt aa1 , doprstep_dbt bb1 ,doprostep_dbt cc1 where c1.t_dealid="+dealid+"  and  aa1.t_dockind=102 and ";
         que=que+ " aa1.t_DocumentID=lpad(c1.t_dealid,34,'0') and bb1.t_id_operation=aa1.t_id_operation  and cc1.t_blockid=bb1.t_blockid and cc1.t_number_step=bb1.t_number_step   and  (bb1.t_fact_date = '"+da+"' or bb1.t_isexecute='R')   and bb1.t_blockid="+chainblockId0;
         rs5 = LnGetRecordSet(que);
         if(rs5 != null)
            if (rs5.moveNext) 
               if (int(rs5.value(0)) == 0 )
                  // ---  blok cep  -------------------
                  sql = "select s.t_id_operation, s.t_id_step, s.t_blockid, s.t_kind_operation, s.t_IsExecute from " 
                      + " doproper_dbt o "
                      + " inner join doprstep_dbt s on s.t_id_operation=o.t_id_operation and s.t_id_step = (select t_id_step from doprstep_dbt where t_id_operation = s.t_id_operation  and t_isexecute ='R'  )"
                      + " where o.t_dockind = :dockind and o.t_documentid = lpad(:dealid, 34, '0')";
                  chainblockId = 4000019;
                  sql = ExecSqlSelect(sql, MakeArray(SqlParam("dockind", dockind), SqlParam("dealid", dealid)), false);     
                  if(not sql.MoveNext())
                     MsgBox("Ошибка поиcка сделки  = "+dealid);
                     return false;
                  end;
                  ii=int(sql.value("t_id_step"));

                  command1 = "BEGIN :res := RSI_RsbOperation.InsertBranchTrn(:step, "+int(sql.value("t_id_operation"))+", " + ii+",'I', "+chainblockId+", 550, :dt, 0, 0); END;";
                  exec = ExecSql(command1, MakeArray(SqlParam ("res",  V_INTEGER, RSDBP_RETVAL), 
                                                     SqlParam ("step", V_INTEGER, RSDBP_RETVAL), 
                                                     SqlParam ("dt", {curdate})), false);

                  if (exec == null)
                     MsgBox("Ошибка вставки цепочки ");
                     return false;
                  end;

                  if (exec.value("res") != 0)
                     MsgBox("Процедура вставки цепочки вернула ошибку, для документа id="+dealid);
                     return false;
                  end;
                  // ----------------------------------------------
               end;
            end;
         end;
       else
         println("По сделке "+rs9.value(1)+" нет инкассового поручения !"); 
       end;
       // ---
     end;
   end;
  
   RemProgress; 
end;


 if(GetTrue(true, "Выполнить обработку инкассовых поручений ?"))
    shnpr();
    execmacrofile("dl_avto222.mac", "npr") ;
 end;

end;


