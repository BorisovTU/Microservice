import fx_lib,funk;
//IMPORT BankInter,FIInter,rsexts,oralib,likepy, globals;
//import "osfile.d32";


  FILE fp () txt;

  var fininstr       = Tbfile( "fininstr.dbt", "W" );
  var ratedef  = Tbfile( "ratedef.dbt", "W" );
  var ARTICLE  = Tbfile( "ARTICLE.dbt", "W" );

  var file_in,kod,nam,j,stat,comment,dat,{curdate},nfiid,rs5,que;
  setdelim(";");


/*
  T_FIID            NUMBER(10) not null,
  T_FI_CODE         VARCHAR2(15),
  T_FI_KIND         NUMBER(5),
  T_AVOIRKIND       NUMBER(5),
  T_NAME            VARCHAR2(50),
  T_DEFINITION      VARCHAR2(164),
  T_CODEINACCOUNT   VARCHAR2(7),
  T_ISO_NUMBER      VARCHAR2(3),
  T_CCY             VARCHAR2(3),
  T_ISSUER          NUMBER(10),
  T_ISSUED          DATE,
  T_SETTLEMENT_CODE NUMBER(5),
  T_FACEVALUEFI     NUMBER(10),
  T_FACEVALUE       NUMBER(32,12),
  T_PARENTFI        NUMBER(10),
  T_DRAWINGDATE     DATE,
  T_EXPIRYDATE      DATE,
  T_ISCLOSED        CHAR(1),
  T_USERFIELD1      VARCHAR2(120),
  T_USERFIELD2      VARCHAR2(40),
  T_USERFIELD3      VARCHAR2(80),
  T_USERFIELD4      VARCHAR2(80),
  T_ISINVERSE       CHAR(1),
  T_SCALE           NUMBER(10),
  T_POINT           NUMBER(5),
  T_ISSYS           CHAR(1),
  T_ISADDITIONAL    CHAR(1),
  T_MAINFIID        NUMBER(10),
  T_SUMPRECISION    NUMBER(5),
  T_ISGENERALIZED   CHAR(1) default CHR(0),
  T_GENERALIZEDFIID NUMBER(10) default -1,
  T_RESERVE         VARCHAR2(177),
  T_DURATION        NUMBER(5),
  T_TYPEDURATION    NUMBER(5),
  T_VERSION         NUMBER(10)


  T_RATEID        NUMBER(10) not null,
  T_FIID          NUMBER(10),
  T_OTHERFI       NUMBER(10),
  T_NAME          VARCHAR2(60),
  T_DEFINITION    VARCHAR2(164),
  T_TYPE          NUMBER(5),
  T_ISDOMINANT    CHAR(1),
  T_ISRELATIVE    CHAR(1),
  T_INFORMATOR    NUMBER(10),
  T_MARKET_PLACE  NUMBER(10),
  T_ISINVERSE     CHAR(1),
  T_RATE          FLOAT(53),
  T_SCALE         NUMBER(10),
  T_POINT         NUMBER(5),
  T_INPUTDATE     DATE,
  T_INPUTTIME     DATE,
  T_OPER          NUMBER(5),
  T_SINCEDATE     DATE,
  T_SECTION       NUMBER(10),
  T_VERSION       NUMBER(10),
  T_ISMANUALINPUT CHAR(1)



*/


macro _Create_op()

                              

    fininstr.rec.FIID = nfiid;   
    fininstr.rec.FI_CODE = kod;
    fininstr.rec.FI_KIND = 7;
    fininstr.rec.NAME = nam;
    fininstr.rec.SETTLEMENT_CODE = 0;
    fininstr.rec.FACEVALUEFI =0;
    fininstr.rec.PARENTFI = 0;
    fininstr.rec.POINT= 2;
    fininstr.rec.MAINFIID = -1;
    fininstr.rec.SUMPRECISION = 2;
    fininstr.rec.GENERALIZEDFIID = -1;
    fininstr.rec.ISSUER = -1;

    fininstr.rec.ISCLOSED = "" ;
    fininstr.rec.ISINVERSE = "";
    fininstr.rec.ISSYS = "";       
    fininstr.rec.ISADDITIONAL = "";
    fininstr.rec.ISGENERALIZED = ""; 

    stat = fininstr.insert;
    if (not stat)
        RunError( "Ошибка fininstr " );
    else
        nfiid=nfiid+1;
    end;


    ARTICLE.rec.FIID = fininstr.rec.FIID;
    ARTICLE.rec.MEASURECODE = 642;
    ARTICLE.rec.RESERVE = "";
    stat = ARTICLE.insert;
    if (not stat)
        RunError( "Ошибка ARTICLE " );
    end;



    ratedef.rec.RATEID = 0;
    ratedef.rec.OTHERFI = fininstr.rec.FIID;
    ratedef.rec.FIID= -10;
    ratedef.rec.TYPE = 1;
    ratedef.rec.ISDOMINANT= "X";
    ratedef.rec.SCALE = 1;
    ratedef.rec.INPUTDATE = dat;
    ratedef.rec.OPER = 1;
    ratedef.rec.SINCEDATE = dat;
    stat = ratedef.insert;
    if (not stat)
        RunError( "Ошибка ratedef " );
    end;



// -----------------
  OnError( RslErrObj ) //А если ошибка - заполняем коммент
        Comment = RslErrObj.Message;
    AbortTrn();

end;

        que="select nvl (max (t_fiid), 0)+1 from dfininstr_dbt";
        rs5 = LnGetRecordSet(que);
        if(rs5 != null)
          if (rs5.moveNext) 
            nfiid=int(rs5.value(0));
          end;
        end;
        dat=СДАТ0({curdate});
        file_in = getsysdir(0)+"\\..\\import\\art.txt";

        if (not Open(fp, file_in))
            MsgBox("Не открыт файл ! ");
        else
           j=0;
           InitProgress( 50, "Загрузка справочник аиндексов ");
           while (next(fp))
              useprogress(j);
              j = j + 1;      
              kod=trim(fp(0));
              nam=trim(fp(1));
              if (ProcessTrn(0,"_Create_op"))
                 println(kod," ",nam);

              else
                msgbox("Индекс  не загружен !");
                MSGBOX(Comment);
                return false;
              end;

           end;
           RemProgress();
       end;
  end;