import "or_rep_h.mac", RsbDataSet,datelib,Календарь;

import funk;

private var Rep : CMakeReport; /* Объект вида CMakeReport */ 
        var aa,sql,val,typ,rs0,daot,i,ii,jk,ost1=0,ost2=0,para1,para2,vals,typs,da1,da2,dox,rasx,tips,jj;
var lTrue = true;
var IsApp = ":a";
var l="l";
var iMainMenu = -1,d,m,year;
var bHeaderPrinted = false;
const FontStyleTitel = ""; // "ex_FS(b)";
const FontStyleTitel2 = "r:ex_FS(b):ex_FZ(8)";


array mas1,mas2;
aa="                    ";


/* Печать заголовка страниц */ 


macro PrintHeadd(vari)
   var St1 = "c:ex_BC(13421772):ex_FS(b):ex_B(rlt):ex_FZ(10)";
   var REP_ELEM = REP_ELEM_TABL,zago;

       Rep.AddPrintCell("FOREX(today)", 30,0, "c:ex_FS(b):ex_FZ(14)", REP_ELEM_STR);
     Rep.AddStr();
     Rep.AddEmptyStr(); 
      Rep.AddPrintCell("№",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Банк",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Страна",15, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Дата сделки",10, 0, St1, REP_ELEM);
/*
      Rep.AddPrintCell("Дата валютир.",10, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Покупка",52, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Продажа",52, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Курс сделки",8, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Доход",36, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Расход",36, 0, St1, REP_ELEM);
      Rep.AddPrintCell("№ сделки",18, 0, St1, REP_ELEM);
      Rep.AddStr();
      Rep.AddPrintCell("",6, 0, St1, REP_ELEM);
      Rep.AddPrintCell("",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("",15, 0, St1, REP_ELEM);
      Rep.AddPrintCell("",10, 0, St1, REP_ELEM);
      Rep.AddPrintCell("",10, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Вал.",3, 0, St1, REP_ELEM);
      Rep.AddPrintCell("сумма в валюте",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Курс",6, 0, St1, REP_ELEM);
      Rep.AddPrintCell("сумма в тенге",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Вал.",3, 0, St1, REP_ELEM);
      Rep.AddPrintCell("сумма в валюте",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Курс",6, 0, St1, REP_ELEM);
      Rep.AddPrintCell("сумма в тенге",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("",8, 0, St1, REP_ELEM);
      Rep.AddPrintCell("счет",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("сумма",15, 0, St1, REP_ELEM);
      Rep.AddPrintCell("счет",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("сумма",15, 0, St1, REP_ELEM);
      Rep.AddPrintCell("",18, 0, St1, REP_ELEM);
*/
      Rep.AddStr();
end;



macro PrintHeadd3(vari)
   var St1 = "c:ex_BC(13421772):ex_FS(b):ex_B(rlt):ex_FZ(10)";
   var REP_ELEM = REP_ELEM_TABL,zago;

     if (vari == 1 )
       Rep.AddPrintCell("FORWARD-SWOP", 30, "c:ex_FS(b):ex_FZ(14)", REP_ELEM_STR);
     else
       Rep.AddPrintCell("SWOP", 30, "c:ex_FS(b):ex_FZ(14)", REP_ELEM_STR);
     end;
     Rep.AddStr();
     Rep.AddEmptyStr(); 



      Rep.AddPrintCell("№",6, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Банк",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Страна",15, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Дата сделки",10, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Дата валютир.",10, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Покупка",52, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Продажа",52, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Курс сделки",8, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Нереализ.доходы",36, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Нереализ.расходы",36, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Доход",36, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Расход",36, 0, St1, REP_ELEM);
      Rep.AddPrintCell("№ сделки",18, 0, St1, REP_ELEM);
      Rep.AddStr();
      Rep.AddPrintCell("",6, 0, St1, REP_ELEM);
      Rep.AddPrintCell("",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("",15, 0, St1, REP_ELEM);
      Rep.AddPrintCell("",10, 0, St1, REP_ELEM);
      Rep.AddPrintCell("",10, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Вал.",3, 0, St1, REP_ELEM);
      Rep.AddPrintCell("сумма в валюте",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Курс",6, 0, St1, REP_ELEM);
      Rep.AddPrintCell("сумма в тенге",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Вал.",3, 0, St1, REP_ELEM);
      Rep.AddPrintCell("сумма в валюте",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Курс",6, 0, St1, REP_ELEM);
      Rep.AddPrintCell("сумма в тенге",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("",8, 0, St1, REP_ELEM);
      Rep.AddPrintCell("счет",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("сумма",15, 0, St1, REP_ELEM);
      Rep.AddPrintCell("счет",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("сумма",15, 0, St1, REP_ELEM);
      Rep.AddPrintCell("счет",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("сумма",15, 0, St1, REP_ELEM);
      Rep.AddPrintCell("счет",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("сумма",15, 0, St1, REP_ELEM);
      Rep.AddPrintCell("",18, 0, St1, REP_ELEM);
      Rep.AddStr();

end;

MACRO SDEL(S,KS)
 PRIVATE VAR SW="                                                                                                      ";
 S=SUBSTR(S+SW,1,KS);
RETURN(S);
END;


macro Fiiid_namel(par1) 
    private var que,rs51,rez=" ";

     que="select t_ccy from dfininstr_dbt where  t_fiid="+string(par1);
     rs51 = LnGetRecordset(que);
     if(rs51 != null)
       if (rs51.moveNext) 
         rez=rs51.value(0);
       end;
     end;
     return rez;
end;



macro Проводка_доходы(par1,par2) 
    private var que,rs51,rez=" ";

     que="select count(*) from  doproper_dbt b ,doprstep_dbt a where  b.t_DocumentID = lpad('"+string(par1)+"',34,'0') ";   
     que=que+" and    b.t_dockind='"+string(par2)+"' and a.t_id_operation=b.t_id_operation  and a.t_number_step=80 and  a.t_isexecute='X' ";
     rs51 = LnGetRecordset(que);
     if(rs51 != null)
       if (rs51.moveNext) 
         rez=rs51.value(0);
       end;
     end;
     return rez;
end;




macro Проводка_доходы2(par1,par2) 
    private var que,rs51,rez=" ";

     que="select count(*) from  doproper_dbt b ,doprstep_dbt a where  b.t_DocumentID = lpad('"+string(par1)+"',34,'0') ";   
     que=que+" and    b.t_dockind='"+string(par2)+"' and a.t_id_operation=b.t_id_operation  and a.t_number_step=30 and  a.t_isexecute='X' ";
     rs51 = LnGetRecordset(que);
     if(rs51 != null)
       if (rs51.moveNext) 
         rez=rs51.value(0);
       end;
     end;
     return rez;
end;


MACRO ПРИКРЕПИТЬ33(nkat,id1);
    private var ss1,ss2,ss,rs1,que,rs;
     ss2="1";
     return (ss2);
END;


macro First_Call() 
   DefaultStringFont  = "Times New Roman";  
   DefaultFontSize    = 10;                                                                                                               
   DefaultWinRepOutput= WINREP_OUTPUT_EXCEL;
  /* Создадим объект класса CMakeReport */ 
   Rep = CMakeReport(); 
end; /* First_Call */ 


MACRO Last_Call() 

     Rep.AddEmptyStr(); 
 
     Rep.SetZoomType(ZOOM_TYPE_A4L);
     Rep.SetFlagShowZeroValue(false);

     Rep.PrintWinRep("TODAY"); // Печатаем отчёт в Excel 
//     Rep.ShowWinRep();         // Делаем окно с Excel активным  

END; /* Last_Call */ 





/* Циклический вызов макроса для формирования таблицы с данными */ 

MACRO Cycle_Call(rs) 
  private var acc,acc2,ku,КурсНБ,datnach,vidinstr,daku,sut1,sut2,,uslo,dapog,subank,sukontr,perval18,perproc18,perval28,perproc28;
/*
  if (rs.value("partyid") == 83 ) 
      acc=ПРИКРЕПИТЬ33("СЧЕТ_4530KASE",rs.value("dealid"));
      acc2=ПРИКРЕПИТЬ33("СЧЕТ_5530KASE",rs.value("dealid"));
  else
      acc=ПРИКРЕПИТЬ33("СЧЕТ_4530",rs.value("dealid"));
      acc2=ПРИКРЕПИТЬ33("СЧЕТ_5530",rs.value("dealid"));
  end;

      if (strlen(acc+acc2) < 10 )
         return;
      end;

  if ((rs.value("dockind") == 100) and (rs.value("dockind") == 3) ) 
      if (Проводка_доходы(rs.value("dealid"),rs.value("dockind")) == 0 )
        return;
      end;
  end;

  if (rs.value("dealtype") == 11100 ) 
      if (Проводка_доходы(rs.value("dealid"),rs.value("dockind")) == 0 )
        return;
      end;
  end;

  */
      КурсНБ=1;
      Rep.AddPrintCell(jj, 6, 0, "c:" + FontStyleTitel);
      Rep.AddPrintCell(rs.value("t_name"), 20, 0, "c:" + FontStyleTitel);
      Rep.AddPrintCell(rs.value("t_fullname"), 15, 0, "c:" + FontStyleTitel);
      Rep.AddPrintCell(string(rs.value("dealdate")), 10, 0, "c:" + FontStyleTitel);
      Rep.AddPrintCell(string(rs.value("daplat")), 10, 0, "c:" + FontStyleTitel);
        daku=date(rs.value("daplat"))-1;


      if (rs.value("typedoc")  == "B" )
        if (rs.value("pfi") == 0 )
          sut1=rs.value("principal");
          КурсНБ=0.00;
        else
          sut1=rs.value("principal")*1;
        end;

        Rep.AddPrintCell(Fiiid_namel(rs.value("pfi")), 3, 0, "c:" + FontStyleTitel);
        Rep.AddPrintCell(string(rs.value("principal"):a), 20, 2, "c:" + FontStyleTitel);
        Rep.AddPrintCell(КурсНБ, 6, 2, "c:" + FontStyleTitel);
        Rep.AddPrintCell(string(sut1:a), 20, 2, "c:" + FontStyleTitel);

        if (rs.value("cfi") == 0 )
          sut2=rs.value("cost");
          КурсНБ=0.00;
        else
          sut2=rs.value("cost")*1;
        end;

        Rep.AddPrintCell(Fiiid_namel(rs.value("cfi")), 3, 0, "c:" + FontStyleTitel);
        Rep.AddPrintCell(string(rs.value("cost"):a), 20, 2, "c:" + FontStyleTitel);
        Rep.AddPrintCell(КурсНБ, 6, 2, "c:" + FontStyleTitel);
        Rep.AddPrintCell(string(sut2:a), 20, 2, "c:" + FontStyleTitel);
        ku=double(rs.value("cost")/rs.value("principal"));

      else
        if (rs.value("cfi") == 0 )
          sut1=rs.value("cost");
          КурсНБ=0.00;
        else
          sut1=rs.value("cost")*12;
        end;


        Rep.AddPrintCell(Fiiid_namel(rs.value("cfi")), 3, 0, "c:" + FontStyleTitel);
        Rep.AddPrintCell(string(rs.value("cost"):a), 20, 2, "c:" + FontStyleTitel);
        Rep.AddPrintCell(КурсНБ, 6, 2, "c:" + FontStyleTitel);
        Rep.AddPrintCell(string(sut1:a), 20, 2, "c:" + FontStyleTitel);

        if (rs.value("pfi") == 0 )
          sut2=rs.value("principal");
          КурсНБ=0.00;
        else
          sut2=rs.value("principal");
        end;

        Rep.AddPrintCell(Fiiid_namel(rs.value("pfi")), 3, 0, "c:" + FontStyleTitel);
        Rep.AddPrintCell(string(rs.value("principal"):a), 20, 2, "c:" + FontStyleTitel);
        Rep.AddPrintCell(КурсНБ, 6, 2, "c:" + FontStyleTitel);
        Rep.AddPrintCell(string(sut2:a), 20, 2, "c:" + FontStyleTitel);
        ku=double(rs.value("principal")/rs.value("cost"));

      end;

//      ku=double("1"+substr("0000000000",1,int(rs.value("point"))));
//      ku=rs.value("price")/ku;
      Rep.AddPrintCell(ku, 8, 4, "c:" + FontStyleTitel);

      if ( sut1 > sut2 )
        if (rs.value("partyid") == 83 ) 
          acc=ПРИКРЕПИТЬ33("СЧЕТ_4530KASE",rs.value("dealid"));
        else
          acc=ПРИКРЕПИТЬ33("СЧЕТ_4530",rs.value("dealid"));
        end;

        sut1 = sut1-sut2;

        Rep.AddPrintCell(acc, 20, 0, "c:" + FontStyleTitel);
        Rep.AddPrintCell(string(sut1:a), 15, 2, "c:" + FontStyleTitel);
        Rep.AddPrintCell(" ", 20, 0, "c:" + FontStyleTitel);
        Rep.AddPrintCell(" ", 15, 0, "c:" + FontStyleTitel);
      else
        if (rs.value("partyid") == 83 ) 
          acc=ПРИКРЕПИТЬ33("СЧЕТ_5530KASE",rs.value("dealid"));
        else
          acc=ПРИКРЕПИТЬ33("СЧЕТ_5530",rs.value("dealid"));
        end;

        sut1 = sut2-sut1;
        Rep.AddPrintCell(" ", 20, 0, "c:" + FontStyleTitel);
        Rep.AddPrintCell(" ", 15, 0, "c:" + FontStyleTitel);
        Rep.AddPrintCell(acc, 20, 0, "c:" + FontStyleTitel);
        Rep.AddPrintCell(string(sut1:a), 15, 2, "c:" + FontStyleTitel);
      end;

      Rep.AddPrintCell(rs.value("dealcode"), 18, 0, "c:" + FontStyleTitel);
      Rep.AddStr();
      jj=jj+1;

END; /* Cycle_Call */ 

MACRO Cycle_Call2(rs) 
  private var que,rs0,acc,acc2,ku,КурсНБ,ssut1,ssut2,datnach,vidinstr,daku,flag,sut1,sut2,,uslo,dapog,subank,sukontr,perval18,perproc18,perval28,perproc28;
  private array maa;



      if (Проводка_доходы2(rs.value("dealid"),rs.value("dockind")) == 0 )
        return;
      end;
 

     flag = 0 ;
     que="select count(*) from doprdocs_dbt a, doproper_dbt b, dacctrn_dbt d ";
     que=que+" where d.t_state=1 and  d.t_date_carry='"+string(rs.value("dealdate"))+"' and substr(d.t_account_receiver,13,4)='4530'"; 
     que=que+" and b.t_DocumentID ="+ string(rs.value("dealid"))+"  and   b.t_dockind=140 ";
     que=que+" and a.t_id_operation=b.t_id_operation and a.t_dockind=1 and a.t_acctrnid = d.t_acctrnid"; 
     rs0 = LnGetRecordset(que);
     if(rs0 != null)
       if (rs0.moveNext) 
        flag=flag+rs0.value(0);
       end;
     end;

     que="select count(*)from doprdocs_dbt a, doproper_dbt b, dacctrn_dbt d ";
     que=que+" where d.t_state=1 and d.t_date_carry='"+string(rs.value("dealdate"))+"' and substr(d.t_account_payer,13,4)='5530'"; 
     que=que+" and b.t_DocumentID ="+ string(rs.value("dealid"))+"  and   b.t_dockind=140 ";
     que=que+" and a.t_id_operation=b.t_id_operation and a.t_dockind=1 and a.t_acctrnid = d.t_acctrnid "; 
     rs0 = LnGetRecordset(que);
     if(rs0 != null)
       if (rs0.moveNext) 
        flag=flag+rs0.value(0);
       end;
     end;

     if ( flag == 0 )
        return;
     end;



      Rep.AddPrintCell(jj, 6, 0, "c:" + FontStyleTitel);
      Rep.AddPrintCell(rs.value("t_name"), 20, 0, "c:" + FontStyleTitel);
      Rep.AddPrintCell(rs.value("t_fullname"), 15, 0, "c:" + FontStyleTitel);
      Rep.AddPrintCell(string(rs.value("dealdate")), 10, 0, "c:" + FontStyleTitel);
      Rep.AddPrintCell(string(rs.value("daplat")), 10, 0, "c:" + FontStyleTitel);
       daku=date(rs.value("daplat"))-1;



      asize(maa,0);
      maa(0)="";
      maa(1)="";
      maa(2)="";
      maa(3)="";
      ssut1=0;
      ssut2=0;
      que=" select aaa.t_baseamount principal,aaa.t_fiid pfi from dpmpaym_dbt aaa where aaa.t_documentid='"+string(rs.value("dealid"))+"' and aaa.t_dockind=140 and aaa.t_receiver = 88 ";
      rs0 = LnGetRecordset(que);
      if(rs0 != null)
        while(rs0.moveNext)

          if (rs0.value("pfi") == 0 )
            sut1=rs0.value("principal");
            КурсНБ=0.00;
          else
            sut1=rs0.value("principal");
          end;
          ssut1=ssut1+sut1;
          maa(0)=maa(0)+SDEL(Fiiid_namel(rs0.value("pfi")),3);
          maa(1)=maa(1)+SDEL(string(rs0.value("principal"):a));
          maa(2)=maa(2)+SDEL(string(КурсНБ));
          maa(3)=maa(3)+SDEL(string(sut1:a));

        end;
      end;

          Rep.AddPrintCell(maa(0), 3, 0, "c:" + FontStyleTitel);
          Rep.AddPrintCell(maa(1), 20, 2, "c:" + FontStyleTitel);
          Rep.AddPrintCell(maa(2), 6, 2, "c:" + FontStyleTitel);
          Rep.AddPrintCell(maa(3), 20,2, "c:" + FontStyleTitel);

/*
          Rep.AddPrintCell(Fiiid_namel(rs0.value("pfi")), 3, 0, "c:" + FontStyleTitel);
          Rep.AddPrintCell(string(rs0.value("principal"):a), 20, 2, "c:" + FontStyleTitel);
          Rep.AddPrintCell(КурсНБ, 6, 2, "c:" + FontStyleTitel);
          Rep.AddPrintCell(string(sut1:a), 20, 2, "c:" + FontStyleTitel);
*/

      asize(maa,0);
      maa(0)="";
      maa(1)="";
      maa(2)="";
      maa(3)="";
      que=" select aaa.t_baseamount cost,aaa.t_fiid cfi from dpmpaym_dbt aaa where aaa.t_documentid='"+string(rs.value("dealid"))+"' and aaa.t_dockind=140 and aaa.t_payer = 88 ";
      rs0 = LnGetRecordset(que);
      if(rs0 != null)
        while(rs0.moveNext)
          if (rs0.value("cfi") == 0 )
            sut2=rs0.value("cost");
            КурсНБ=0.00;
          else
            sut2=rs0.value("cost");
          end;
          ssut2=ssut2+sut2;

          maa(0)=maa(0)+SDEL(Fiiid_namel(rs0.value("cfi")),3);
          maa(1)=maa(1)+SDEL(string(rs0.value("cost"):a));
          maa(2)=maa(2)+SDEL(string(КурсНБ));
          maa(3)=maa(3)+SDEL(string(sut2:a));

        end;
      end;

          Rep.AddPrintCell(maa(0), 3, 0, "c:" + FontStyleTitel);
          Rep.AddPrintCell(maa(1), 20, 2, "c:" + FontStyleTitel);
          Rep.AddPrintCell(maa(2), 6, 2, "c:" + FontStyleTitel);
          Rep.AddPrintCell(maa(3), 20,2, "c:" + FontStyleTitel);

      if ( ssut2 == 0 )
       ku=0;
      else
       ku=double(ssut1/ssut2);
      end;
      Rep.AddPrintCell(ku, 8, 4, "c:" + FontStyleTitel);

     que="select d.t_account_receiver account,t_sum from doprdocs_dbt a, doproper_dbt b, dacctrn_dbt d ";
     que=que+" where d.t_state=1 and d.t_date_carry='"+string(rs.value("dealdate"))+"' and substr(d.t_account_receiver,13,4)='4530'"; 
     que=que+" and b.t_DocumentID ="+ string(rs.value("dealid"))+"  and   b.t_dockind=140 ";
     que=que+" and a.t_id_operation=b.t_id_operation and a.t_dockind=1 and a.t_acctrnid = d.t_acctrnid "; 
     rs0 = LnGetRecordset(que);
     if(rs0 != null)
       if (rs0.moveNext) 
        Rep.AddPrintCell(rs0.value("account"), 20, 0, "c:" + FontStyleTitel);
        Rep.AddPrintCell(string(rs0.value("t_sum"):a), 15, 2, "c:" + FontStyleTitel);
        Rep.AddPrintCell(" ", 20, 0, "c:" + FontStyleTitel);
        Rep.AddPrintCell(" ", 15, 0, "c:" + FontStyleTitel);
       end;
     end;


     que="select d.t_account_payer account,t_sum from doprdocs_dbt a, doproper_dbt b, dacctrn_dbt d ";
     que=que+" where d.t_state=1 and d.t_date_carry='"+string(rs.value("dealdate"))+"' and substr(d.t_account_payer,13,4)='5530'"; 
     que=que+" and b.t_DocumentID ="+ string(rs.value("dealid"))+"  and   b.t_dockind=140 ";
     que=que+" and a.t_id_operation=b.t_id_operation and a.t_dockind=1 and a.t_acctrnid = d.t_acctrnid "; 
     rs0 = LnGetRecordset(que);
     if(rs0 != null)
       if (rs0.moveNext) 
        Rep.AddPrintCell(" ", 20, 0, "c:" + FontStyleTitel);
        Rep.AddPrintCell(" ", 15, 0, "c:" + FontStyleTitel);

        Rep.AddPrintCell(rs0.value("account"), 20, 0, "c:" + FontStyleTitel);


        Rep.AddPrintCell(string(rs0.value("t_sum"):a), 15, 2, "c:" + FontStyleTitel);
       end;
     end;

      Rep.AddPrintCell(rs.value("dealcode"), 18, 0, "c:" + FontStyleTitel);
      Rep.AddStr();
      jj=jj+1;


END; /* Cycle_Call */ 



MACRO Cycle_Call02(rs) 
  private var acc,acc2,ku,КурсНБ,datnach,vidinstr,daku,sut1,sut2,,uslo,dapog,subank,sukontr,perval18,perproc18,perval28,perproc28;

  if (rs.value("partyid") == 83 ) 
      acc=ПРИКРЕПИТЬ33("СЧЕТ_4530B",rs.value("dealid"));
      acc2=ПРИКРЕПИТЬ33("СЧЕТ_5530B",rs.value("dealid"));
  else
      acc=ПРИКРЕПИТЬ33("СЧЕТ_4592",rs.value("dealid"));
      acc2=ПРИКРЕПИТЬ33("СЧЕТ_5592",rs.value("dealid"));
  end;
      if (strlen(acc+acc2) < 10 )
         return;
      end;

  if ((rs.value("dockind") == 100) and (rs.value("dockind") == 3) ) 
      if (Проводка_доходы(rs.value("dealid"),rs.value("dockind")) == 0 )
        return;
      end;
  end;

  if (rs.value("dealtype") == 11100 ) 
      if (Проводка_доходы(rs.value("dealid"),rs.value("dockind")) == 0 )
        return;
      end;
  end;



      Rep.AddPrintCell(jj, 6, 0, "c:" + FontStyleTitel);
      Rep.AddPrintCell(rs.value("t_name"), 20, 0, "c:" + FontStyleTitel);
      Rep.AddPrintCell(rs.value("t_fullname"), 15, 0, "c:" + FontStyleTitel);
      Rep.AddPrintCell(string(rs.value("dealdate")), 10, 0, "c:" + FontStyleTitel);
      Rep.AddPrintCell(string(rs.value("daplat")), 10, 0, "c:" + FontStyleTitel);
        daku=date(rs.value("dealdate"))-1;


      if (rs.value("typedoc")  == "B" )
        if (rs.value("pfi") == 0 )
          sut1=rs.value("principal");
          КурсНБ=0.00;
        else
          sut1=rs.value("principal");
        end;

        Rep.AddPrintCell(Fiiid_namel(rs.value("pfi")), 3, 0, "c:" + FontStyleTitel);
        Rep.AddPrintCell(string(rs.value("principal"):a), 20, 2, "c:" + FontStyleTitel);
        Rep.AddPrintCell(КурсНБ, 6, 2, "c:" + FontStyleTitel);
        Rep.AddPrintCell(string(sut1:a), 20, 2, "c:" + FontStyleTitel);

        if (rs.value("cfi") == 0 )
          sut2=rs.value("cost");
          КурсНБ=0.00;
        else
          sut2=rs.value("cost");
        end;

        Rep.AddPrintCell(Fiiid_namel(rs.value("cfi")), 3, 0, "c:" + FontStyleTitel);
        Rep.AddPrintCell(string(rs.value("cost"):a), 20, 2, "c:" + FontStyleTitel);
        Rep.AddPrintCell(КурсНБ, 6, 2, "c:" + FontStyleTitel);
        Rep.AddPrintCell(string(sut2:a), 20, 2, "c:" + FontStyleTitel);

        ku=double(rs.value("cost")/rs.value("principal"));

      else
        if (rs.value("cfi") == 0 )
          sut1=rs.value("cost");
          КурсНБ=0.00;
        else
          sut1=rs.value("cost");
        end;


        Rep.AddPrintCell(Fiiid_namel(rs.value("cfi")), 3, 0, "c:" + FontStyleTitel);
        Rep.AddPrintCell(string(rs.value("cost"):a), 20, 2, "c:" + FontStyleTitel);
        Rep.AddPrintCell(КурсНБ, 6, 2, "c:" + FontStyleTitel);
        Rep.AddPrintCell(string(sut1:a), 20, 2, "c:" + FontStyleTitel);

        if (rs.value("pfi") == 0 )
          sut2=rs.value("principal");
          КурсНБ=0.00;
        else
          sut2=rs.value("principal");
        end;

        Rep.AddPrintCell(Fiiid_namel(rs.value("pfi")), 3, 0, "c:" + FontStyleTitel);
        Rep.AddPrintCell(string(rs.value("principal"):a), 20, 2, "c:" + FontStyleTitel);
        Rep.AddPrintCell(КурсНБ, 6, 2, "c:" + FontStyleTitel);
        Rep.AddPrintCell(string(sut2:a), 20, 2, "c:" + FontStyleTitel);

        ku=double(rs.value("principal")/rs.value("cost"));

      end;

//      ku=double("1"+substr("0000000000",1,int(rs.value("point"))));
//      ku=rs.value("price")/ku;
  

      Rep.AddPrintCell(ku, 8, 4, "c:" + FontStyleTitel);

      if ( sut1 > sut2 )
        if (rs.value("partyid") == 83 ) 
          acc=ПРИКРЕПИТЬ33("СЧЕТ_4530B",rs.value("dealid"));
        else
          acc=ПРИКРЕПИТЬ33("СЧЕТ_4592",rs.value("dealid"));
        end;

        sut1 = sut1-sut2;

        Rep.AddPrintCell(acc, 20, 0, "c:" + FontStyleTitel);
        Rep.AddPrintCell(string(sut1:a), 15, 2, "c:" + FontStyleTitel);
        Rep.AddPrintCell(" ", 20, 0, "c:" + FontStyleTitel);
        Rep.AddPrintCell(" ", 15, 0, "c:" + FontStyleTitel);
      else
        if (rs.value("partyid") == 83 ) 
          acc=ПРИКРЕПИТЬ33("СЧЕТ_5530B",rs.value("dealid"));
        else
          acc=ПРИКРЕПИТЬ33("СЧЕТ_5592",rs.value("dealid"));
        end;

        sut1 = sut2-sut1;
        Rep.AddPrintCell(" ", 20, 0, "c:" + FontStyleTitel);
        Rep.AddPrintCell(" ", 15, 0, "c:" + FontStyleTitel);
        Rep.AddPrintCell(acc, 20, 0, "c:" + FontStyleTitel);
        Rep.AddPrintCell(string(sut1:a), 15, 2, "c:" + FontStyleTitel);
      end;

      Rep.AddPrintCell(rs.value("dealcode"), 18, 0, "c:" + FontStyleTitel);
      Rep.AddStr();
      jj=jj+1;



END; /* Cycle_Call */ 


/* Вывод отчёта */
macro PrintRows()
  var params : TArray;
  var rs,rs5,koli;

   sql="select count(*) ";
   sql=sql+" from ddl_tick_dbt a , ddl_leg_dbt b , dparty_dbt c, dcountry_dbt e where a.t_bofficekind=100 and a.t_dealstatus > 0 and a.t_dealdate >= '"+string(da1)+"' and a.t_dealdate <= '"+string(da2)+"'";  
   sql=sql+" and (a.t_dealtype=1000 or a.t_dealtype=11100) ";
   sql=sql+" and b.t_dealid=a.t_dealid and b.t_maturity=a.t_dealdate and c.t_partyid=a.t_partyid and e.t_codeLAT3=c.t_nrcountry ";
   rs5 = LnGetRecordSet(sql);
   if(rs5 != null)
     if (rs5.moveNext) 
        koli=int(rs5.value(0));
     end;
   end;

   InitProgress( koli, "Выполнение" );   


   jk=0;
   jj=1;
   sql="select a.t_partyid partyid  ,c.t_name,e.t_fullname,a.t_dealdate dealdate ,b.t_maturity daplat,a.t_dealid dealid,b.t_principal principal ,b.t_cost cost ,b.t_pfi pfi  ,b.t_cfi cfi,a.t_typedoc typedoc ,a.t_dealcode dealcode  ,b.t_point point,b.t_price price, a.t_bofficekind dockind, a.t_netting netting,a.t_dealtype dealtype ";
   sql=sql+" from ddl_tick_dbt a , ddl_leg_dbt b , dparty_dbt c, dcountry_dbt e where a.t_bofficekind=100 and a.t_dealstatus > 0 and a.t_dealdate = '09.06.2017' ";  
   sql=sql+" and (a.t_dealtype=1000 or a.t_dealtype=11100)";
   sql=sql+" and b.t_dealid=a.t_dealid and b.t_maturity=a.t_dealdate and c.t_partyid=a.t_partyid and e.t_codeLAT3=c.t_nrcountry ";
   sql=sql+"  order by dealdate,dealcode ";
   
   rs = LnGetRecordset(sql);

   if(rs != null)
     while(rs.moveNext)
       useprogress(jk);
       if (rs.value("dealtype") == 11080 ) 
         Cycle_Call2 (rs); 
       else
         Cycle_Call (rs); 
       end;
       jk=jk+1;
     end;
  end;
       RemProgress;   
end;


macro PrintRows2()
  var params : TArray;
  var rs,rs5,koli,ss;


   sql="select count(*) ";
   sql=sql+" from ddl_tick_dbt a , ddl_leg_dbt b , dparty_dbt c, dcountry_dbt e where a.t_bofficekind=100 and a.t_dealstatus > 0 and a.t_dealdate >= '"+string(da1)+"' and a.t_dealdate <= '"+string(da2)+"'";  
   sql=sql+" and a.t_dealtype=1000  ";
   sql=sql+" and b.t_dealid=a.t_dealid and b.t_maturity > a.t_dealdate and c.t_partyid=a.t_partyid and e.t_codeLAT3=c.t_nrcountry ";
   rs5 = LnGetRecordSet(sql);
   if(rs5 != null)
     if (rs5.moveNext) 
        koli=int(rs5.value(0));
     end;
   end;

   InitProgress( koli, "Выполнение" );   
   jk=0;

   jj=1;
   sql="select a.t_partyid partyid  ,c.t_name,e.t_fullname,a.t_dealdate dealdate ,b.t_maturity daplat,a.t_dealid dealid,b.t_principal principal ,b.t_cost cost ,b.t_pfi pfi  ,b.t_cfi cfi,a.t_typedoc typedoc ,a.t_dealcode dealcode  ,b.t_point point,b.t_price price, a.t_bofficekind dockind, a.t_netting netting,a.t_dealtype dealtype ";
   sql=sql+" from ddl_tick_dbt a , ddl_leg_dbt b , dparty_dbt c, dcountry_dbt e where a.t_bofficekind=100 and a.t_dealstatus > 0 and a.t_dealdate >= '"+string(da1)+"' and a.t_dealdate <= '"+string(da2)+"'";  
   sql=sql+" and a.t_dealtype=1000 " ;
   sql=sql+" and b.t_dealid=a.t_dealid and b.t_maturity > a.t_dealdate and c.t_partyid=a.t_partyid and e.t_codeLAT3=c.t_nrcountry ";
   sql=sql+"  order by dealdate,dealcode ";
   rs = LnGetRecordset(sql);

   if(rs != null)
     while(rs.moveNext)
       useprogress(jk);

         ss  = Workdays(date(rs.value("dealdate")),date(rs.value("daplat"))) ;
         if( ss == 3 )
           ss = 2;
         end;
         if ( ss == 2 )
          Cycle_Call02 (rs); 
         end;
         jk=jk+1;
     end;
  end;
       RemProgress;   
end;



      
      da2={curdate};
      da1=date("01"+substr(string(da2),3));

      ВвестиДиапазонДат(da1, da2);

      First_Call(); 
      PrintHeadd(0);
//      PrintRows();
      Last_Call();

Rep.AddNewSheetBreak("СПОТ");
      Rep.PrintWinRep();
      Rep.ShowWinRep();



      exit(1);







