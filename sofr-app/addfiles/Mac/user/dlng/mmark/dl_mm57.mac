import InsCarryDoc, CurrInter, Проценты, MmarkInter, mmlibr, mmcarry, mmcnst_j, mmplib, dl_lib ;

PRIVATE FILE leg (dl_leg);
// PRIVATE FILE pm ("pmpaym") key 1 write;
PRIVATE RECORD tick (dl_tick);




//Получить сумму финреза
macro GetSumFinRez2(DealId, fiidval)

  private  var que, rs, sumvalin, sumrubin,  sumvalout, sumrubout, res, rate;

  sumrubin  = plat_dil(dealid,102,10,"baseamount");
  sumrubout = plat_dil(dealid,102,9,"baseamount");


    res = sumrubin - sumrubout;

     return res;


end;



/*----------------------------------------------------------------------------
    Выполнение шага
----------------------------------------------------------------------------*/
// MACRO ExecuteStep(Buffer, Document)
MACRO ExStep(Buffer, Document)

    var deal_pd ,acc0, acc2, acc0p, s_addground, nrate, vsum, vsum2,nsum,ssu;
    var  at  = MM_Carry;
    var  atp = MM_Carry;

    SetBuff (tick,Document);
    DL_PrepareCarryBuffer (Buffer);
    leg.LegKind = LEG_KIND_DL_TICK;
    leg.DealID = tick.DealID;
    leg.LegID = 1;

    if (not GetEq(leg))
        mm_error ("Не найден транш сделки");
        return 1;
    end;

    deal_pd = MMFirstDoc(DL_IBCDOC, tick.DealID, true);


     s_addground = GetGroundAddPart(tick);

//Списание внебеланса


// CloseAccount(_CatCode, _ActionDate, _FIRole, _FIID, _NoErrMes )
// OpenAccount(_CatCode, FindAccount_, _NoErrMes, _FIRole, AccBuf_, _ActionDate, _FIID)


     if(not deal_pd.OpenAccount("СЧЕТ_91418", acc0, NULL, deal_pd.GetFIRoleByCategory("СЧЕТ_91418", deal_pd.GetLeg().PFI), NULL, deal_pd.GetTick().DealDate, deal_pd.GetLeg().PFI))
        return 1;
     end;    
/*
     if(not deal_pd.OpenAccount("ВнебалСчетКорресп0", acc2, NULL, deal_pd.GetFIRoleByCategory("ВнебалСчетКорресп", deal_pd.GetLeg().PFI), NULL, deal_pd.GetTick().DealDate, deal_pd.GetLeg().PFI))
        return 1;
     end;    

*/

     if ( {curdate} < date("04.04.2020") )
        acc2="99999810000009999999";
     else


       if(not deal_pd.OpenAccount("ВнебалСчетКорресп0", acc2, NULL, deal_pd.GetFIRoleByCategory("ВнебалСчетКорресп0", 0), NULL, deal_pd.GetTick().DealDate,0 ))
        return 1;
       end;    
    end;



//          at.Numb_Document = execmacrofile("fx_lib", "MakeNumber0");
          at.AccountPayer    = acc2;	  
          at.AccountReceiver = acc0;
          at.FIIDPayer       = 0;
          at.FIIDReceiver    = leg.pfi;
          at.SumReceiver     = leg.principal;
          at.Chapter         = 3;
          at.Ground          = "Погашение прав требования по цене приобретения (ОД) по договору № " + s_addground;
          if(not at.carry())
             msgbox("Error !");
             return false;
          end;
/*

     if(not deal_pd.OpenAccount("СЧЕТ_91418P", acc0p, NULL, deal_pd.GetFIRoleByCategory("СЧЕТ_91418P", deal_pd.GetLeg().PFI), NULL, deal_pd.GetTick().DealDate, deal_pd.GetLeg().PFI))
        return 1;
     end;    

          atp.AccountPayer    = acc2;	  
          atp.AccountReceiver = acc0p;
          atp.FIIDPayer       = leg.pfi;
          atp.FIIDReceiver    = leg.pfi;
          atp.SumReceiver     = GetSummPaymByPurpose(tick.DealID, 11, 1);
          atp.Chapter         = 3;
          atp.Ground          = "Погашение прав требования по цене приобретения (ПРОЦЕНТЫ) по договору № " + s_addground; 
          if(not atp.carry())
             msgbox("Error !");
             return false;
          end;
*/

//Закрытие внебал. счетов ?
//....

//Балансовые проводки 

     if(not deal_pd.FindNumberAccount("СЧЕТ_61212", acc0, NULL, deal_pd.GetFIRoleByCategory("СЧЕТ_61212", 0), NULL, deal_pd.GetTick().DealDate, 0))
     end;    

      ssu=abs(execmacrofile("calculate.mac", "RestA_", acc0, {curdate}, 1, 0)) ;


      if ( ssu == 0 )

        if(not deal_pd.OpenAccount("СЧЕТ_61212", acc0, NULL, deal_pd.GetFIRoleByCategory("СЧЕТ_61212", 0), NULL, {curdate}, 0))
        end;    

      end;


//Посмотреть КУ
     if(not deal_pd.OpenAccount("СЧЕТ_47802", acc2, NULL, deal_pd.GetFIRoleByCategory("СЧЕТ_47802", deal_pd.GetLeg().PFI), NULL, deal_pd.GetTick().DealDate, deal_pd.GetLeg().PFI))
        return 1;
     end;    

          nsum=plat_dil(tick.DealID,"102","9","baseamount");


       vsum = GetSumFinRez2(tick.dealid, leg.pfi);
       if ( leg.pfi ==0 ) 
          at.SumPayer        = vsum;
          at.SumReceiver     = vsum; 
          vsum2=vsum;
       else
          at.SumPayer     = GetSumFinRez(tick.dealid, leg.pfi);
          if (0 != Получить_Курс0(nrate, leg.pfi, {curdate}))
              Msgbox("Не возможно получить курс за ", {curdate});
              return 1;
          end;

          at.Date_conv    = {curdate};
          vsum2 = Money(vsum * nrate);
       end;


              if ( vsum > 0 )

          at.AccountPayer    = acc2;	  
          at.AccountReceiver = acc0;
          at.FIIDPayer       = leg.pfi;
          at.FIIDReceiver    = 0;

          at.SumReceiver     = vsum2;
          at.SumPayer        = vsum;

          at.Chapter         = 1;
          at.Ground          = "Погашение прав требования по договору № " + s_addground; 
          if(not at.carry())
             msgbox("Error !");
             return false;
          end;

          elif ( vsum < 0 )

          at.AccountPayer    = acc0;	  
          at.AccountReceiver = acc2;
          at.FIIDPayer       = 0;
          at.FIIDReceiver    = leg.pfi;

          at.SumReceiver     = abs(vsum);
          at.SumPayer        = abs(vsum2);

          at.Chapter         = 1;
          at.Ground          = "Погашение прав требования по договору № " + s_addground; 
          if(not at.carry())
             msgbox("Error !");
             return false;
          end;




             end;


          at.AccountPayer    = acc0;	  
          at.AccountReceiver = acc2;
          at.FIIDPayer       = 0;
          at.FIIDReceiver    = leg.pfi;
          at.SumReceiver     = nsum;
          at.SumPayer        = nsum;

          at.SumReceiver     = leg.principal;
          at.SumPayer        = Money(leg.principal * nrate);;

          at.Chapter         = 1;
          at.Ground          = "Погашение прав требования по договору № " + s_addground; 
          if(not at.carry())
             msgbox("Error !");
             return false;
          end;

//Финрез, посчитать результат

       at.Chapter         = 1;
       at.Ground          = "Финансовый результат по договору № " + s_addground; 
       vsum = GetSumFinRez2(tick.dealid, leg.pfi);

       if ( leg.pfi ==0 ) 
          at.SumPayer        = vsum;
          at.SumReceiver     = vsum; 
       else
          at.SumPayer     = GetSumFinRez(tick.dealid, leg.pfi);
          if (0 != Получить_Курс0(nrate, leg.pfi, {curdate}))
              Msgbox("Не возможно получить курс за ", {curdate});
              return 1;
          end;

          at.Date_conv    = {curdate};
          vsum2 = Money(vsum * nrate);
       end;

       if (vsum > 0 )
           if(not deal_pd.OpenAccount("+%, Кр0П", acc2, NULL, deal_pd.GetFIRoleByCategory("+%, Кр0П", 0), NULL, deal_pd.GetTick().DealDate, 0))
              return 1;
           end;

           at.FIIDPayer       = 0;
           at.FIIDReceiver    = 0;

           at.AccountPayer    = acc0;	  
           at.AccountReceiver = acc2;

           at.SumPayer    = vsum2;
           at.SumReceiver = vsum2;

       else

           if(not deal_pd.OpenAccount("-%, Кр0П", acc2, NULL, deal_pd.GetFIRoleByCategory("-%, Кр0П", 0), NULL, deal_pd.GetTick().DealDate, 0))
              return 1;
           end;

           at.FIIDPayer       = 0;
           at.FIIDReceiver    = 0;

           at.AccountPayer    = acc2;	  
           at.AccountReceiver = acc0;

           at.SumPayer    = vsum2;
           at.SumReceiver = vsum;

       end;

       if ( leg.pfi ==0 ) 
          at.FIIDPayer       = 0;
          at.FIIDReceiver    = 0;
       end;

       at.SumReceiver = abs(at.SumReceiver);
       at.SumPayer    = abs(at.SumPayer);

//msgbox(at.SumReceiver);
       if(not at.carry())
          msgbox("Error !");
          return false;
       end;


//Проверить остатки. Закрыть бал. счета по сделке ?

    return 0;
END;
