import RSBDataSet, oralib, likepy, cb_sql,funk,"dlgCommon.mac";




macro spis_pl (sd0,sd01);


private  var sd1,nazvm,imfil,fil,ss0,sql2,sql0,sql1,nazv, cmd2,im,rs5,total=" ",sss,imm,pId2,FLAG,kj,to1,to2,to3,us1,us2,us3,don;
private  var col2=TArray();
     sd1=СДАТ(sd01);

     sql0="select to_char((b.t_baseamount-a.t_baseamount),'999,999,999.00')  nalog , to_char(b.t_baseamount,'999,999,999.00') sum0, a.t_paymentid  pId2 ,  t.t_receivername  bank,  a.t_payeraccount acc11, to_char(a.t_baseamount,'999,999,999.00') su11, t.t_ground ground11 ";
     sql0=sql0+", (select ee.t_ccy from dfininstr_dbt ee where ee.t_fiid=a.t_fiid) val";
     sql0=sql0+" from dpmpaym_dbt a ,dpmrmprop_dbt t , dpmpaym_dbt b ";
     sql0=sql0+" where a.t_paymstatus=0 and (a.t_dockind= 16 or a.t_dockind = 27)  and  a.t_valuedate='"+sd1+"' and t.t_paymentid=a.t_paymentid and (b.t_paymentid=a.t_payerDpNode or b.t_paymentid=a.t_receiverDpNode)   and b.t_dockind=102  order by  b.t_purpose,a.t_fiid,b.t_documentid ";
     // msgbox(sql0);

      cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );

// ------------------------------

  macro EvProc2 (rs0, cmd2, id, key )
   private var rs122,nnn,ss1,ss2,u1,u2,que,rs12,jk,ik;     


     if (cmd2 == DLG_INIT)	// Инициализация
        rs0.MoveFirst();          


        if (pId2 != "0")  // Надо найти запись
           while ( (rs0.value ("pId2") != pId2) And (Not rs0.EOF) )  
              rs0.Move(1, RELATIVE);
            end;
        end;
        GoToScroll(rs0, true);


     elif (cmd2 == DLG_KEY)

       if (Key == 317) 

           execmacrofile("plpaym.mac", "PaymDlg2", 0,rs0.value ("pId2")) ;
         //  return CM_SELECT;
        end;
     end;
  end;




  AddCol (col2, 0, "bank", "Получатель", 40);
  AddCol (col2, 1, "val",  "Валюта", 5);
  AddCol (col2, 2, "sum0",  "Сумма по сделке", 18);
  AddCol (col2, 3, "su11",  "Сумма платежа ", 18);
  AddCol (col2, 4, "nalog",  "Сумма налога ", 18);
  AddCol (col2, 5, "ground11",  "Назначение платежа", 200);

  sss=" F3- Просмотр платежа   ESC- Выход " ;

    while(RunScroll(cmd2, 6, col2, null, @EvProc2,"Подготвлены отложенные платежи по дилингу в модуле  'БУХГАЛТЕРИЯ БАНКА'  за "+sd0,sss, null, 1, 11) )
     cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );
    end;

end;