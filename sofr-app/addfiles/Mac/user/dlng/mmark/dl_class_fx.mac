//  класс для вставки первичного документа 
import BankInter, PaymInter, OprInter, PTInter, Globals, RSD, fx_globals;

const КассовыйПриход        = CASH_BOF_INCORDER,    // 430
      КассовыйРасход        = CASH_BOF_OUTORDER,    // 440
      /* КассовыйПодкрепление = 400, */
      Мемордер              = DLDOC_MEMORIALORDER,  //  70
      Мультивалютный        = CB_MULTYDOC,          //  15
      ПлатежББ              = DLDOC_BANKPAYMENT,    //  16
      ПлатежББВАЛ           = BBANK_CPORDER,        //  27
      ТребованиеББ          = DLDOC_BANKCLAIM,      //  17
      ПлатежРКО             = PS_PAYORDER,          // 201
      ПлатежРКОВАЛ          = PS_CPORDER;           // 202

/*────────────────────────────────────────────────────────────────────────────────────────────────────────────────*/
class TBBPrimDocc () 

    var m_docKind,                                /* ВидДокумента                                       */
        m_Kind_Operation   = 0,
        m_LaunchOper       = false,
        m_docNumber,                              /* НомерДокумента                                     */
        m_docDate          = {curdate},           /* ДатаДокумента                                      */
        m_valueDate        = {curdate},           /* ДатаЗначения                                       */
        m_ClientDate       = {curdate},           /* Дата принятия документа от клиента                 */
        m_BankPayerCode    = {MFO_BANK},          /* SWIFT или БИК банка плательщика                    */
        m_PayerINNKPP      = "",                  /* ИНН/КППплательщика                                 */
        m_PayerAccount,                           /* СчетПлательщика                                    */
        m_PayerCurrency    = 0,                   /* Валюта плательщика - для загрузки SWIFT-документов */
        m_Payername        = "",                  /* НаименованиеПлательщика                            */
        m_PayerBankName    = "",                  /* Наименование банка                                 */
        m_receiverDpNode   = 0,
        m_BankReceiverCode = {MFO_BANK},          /* SWIFT или БИК банка получателя                     */
        m_ReceiverINNKPP,                         /* ИНН/КППполучателя                                  */
        m_ReceiverAccount,                        /* СчетПолучателя                                     */
        m_ReceiverCurrency = 0,                   /* Валюта получателя - для загрузки SWIFT-документов  */
        m_ReceiverName     = "",                  /* НаименованиеПолучателя                             */
        m_ReceiverBankName = "",                  /* Наименование банка получателя                      */
        m_Receiver         = 0 ,                  /* ПолучателЬ                                         */

        m_AmountDt         = $0.00,               /* Сумма по дебету                                    */
        m_AmountKt         = $0.00,               /* Сумма по кредиту                                   */
        m_PaymKind         = "Э",                 /* ВидПлатежа                                         */
        m_ShifrOper        = "09",                /* ШифрОперации                                       */
        m_NumberPack       = {Oper},              /* НомерПачки                                         */
        m_Oper             = {Oper},              /* Операционист                                       */
        m_Department       = {OperDPRTNode},      /* Филиал                                             */
        m_Ground,                                 /* Основание                                          */
        m_Priority         = 6,                   /* Очередность                                        */
        m_Origin           = 0,                   /* Происхождение                                      */
        m_OriginStatus     = CodeFor (1),         /* СтатусСоставителя                                  */
        m_fiid             = 0,                   /* СтатусСоставителя                                  */

        /*----------------------------------------------------------------------------------------------*/
        m_KbK              = "0",                 /* КБК                                                */
        m_OcatoCode        = "0",                 /* ОКАТО                                              */
        m_TaxGround        = "0",                 /* ОснованиеНП                                        */
        m_TaxPeriod        = 0,                   /* НалоговыйПериод                                    */
        m_TaxDocNumber     = 0,                   /* НомерНД                                            */
        m_TaxDocDate       = "0",                 /* ДатаНД                                             */
        m_TaxDocType       = "0",                 /* ТипНД                                              */
        /*----------------------------------------------------------------------------------------------*/
        m_CashSymbol       = CodeFor (1),         /* КассовыйСимвол                                     */
        m_FIOClient        = CodeFor (1),         /* ФИО клиента                                        */
        m_PaperKind        = 0,                   /* Тип документа, удостоверяющего личность            */
        m_PaperSeries      = "",                  /* Серия                                              */
        m_PaperNumber      = "",                  /* Номер                                              */
        m_PaperIssuedDate  = date ("01.01.0001"), /* Дата выдачи                                        */
        m_PaperIssuer      = "",                  /* Кем выдан                                          */
        /*----------------------------------------------------------------------------------------------*/
        m_KNP:string       = "",                  // КНП - код назначения платежа
        m_KOD:string       = "",                  // КОД - код отправителя денег
        m_KBE:string       = "",                  // КБе - код бенефициара
        m_ReceiverCountry:string = "",            //     - страна бенефициара
        /*----------------------------------------------------------------------------------------------*/
        m_TypeDocument     = strfor(1),
        m_UserTypeDocument = strfor(0),
        m_Kind_Oper        = strfor(0);
/*────────────────────────────────────────────────────────────────────────────────────────────────────────────────*/
    /* заполнение налоговых реквизитов платежа */
    private macro fillTaxPaymentStuff (RsbPaymentBuff)
        //RsbPaymentBuff.TaxAuthorState = m_OriginStatus;  /* СтатусСоставителя */
        RsbPaymentBuff.BttTICode      = m_KbK;           /* КБК               */
        //RsbPaymentBuff.OKATOCode      = m_OcatoCode;     /* ОКАТО             */          
        //RsbPaymentBuff.TaxPmGround    = m_TaxGround;     /* ОснованиеНП       */
        //RsbPaymentBuff.TaxPmPeriod    = m_TaxPeriod;     /* НалоговыйПериод   */
        //RsbPaymentBuff.TaxPmNumber    = m_TaxDocNumber;  /* НомерНД           */
        //RsbPaymentBuff.TaxPmDate      = m_TaxDocDate;    /* ДатаНД            */
        //RsbPaymentBuff.TaxPmType      = m_TaxDocType;    /* ТипНД             */
    end;
/*────────────────────────────────────────────────────────────────────────────────────────────────────────────────*/
    private macro getChapterByAccount (t_account)
        var cmd = RSDCommand ("SELECT bal.t_chapter"
                              "  FROM dbalance_dbt bal"
                              " WHERE bal.t_balance = SUBSTR (?, 0, 3)"
                              "   AND bal.t_inumplan = 0" );
        cmd.NullConversion = true;
        cmd.AddParam ("acc", RSDBP_IN, t_account);
        
        var rs = RSDRecordSet ( cmd );
        if (rs.moveNext)
            return rs.value ("t_chapter");
        end;

        return 1;
    end;
    
/*────────────────────────────────────────────────────────────────────────────────────────────────────────────────*/
    private macro getIDByAccount (t_account)
        var cmd = RSDCommand ("SELECT t_client FROM daccount_dbt WHERE t_account = ?");       
        cmd.NullConversion = true;
        cmd.AddParam ("acc", RSDBP_IN, t_account);
        
        var rs = RSDRecordSet ( cmd );
        
        if (rs.moveNext)
            return rs.value ("t_client");
        end;
        return 0;
    end;
    
/*────────────────────────────────────────────────────────────────────────────────────────────────────────────────*/
    private macro GetCorrAccountByID ( id )
        var cmd = RSDCommand ("select t_coracc from dbankdprt_dbt where t_partyid = ?");
        cmd.NullConversion = true;
        cmd.AddParam ("pid", RSDBP_IN, id);
        
        var rs = RSDRecordSet (cmd);
        
        if( rs.MoveNext )
            return rs.value(0);
        end;
        
        return "";
    end;

/*────────────────────────────────────────────────────────────────────────────────────────────────────────────────*/
    private macro getIDByBankCode (t_code)
        var cmd = RSDCommand ("SELECT t_objectid FROM dobjcode_dbt WHERE t_code = ?");
        cmd.NullConversion = true;
        cmd.AddParam ("code", RSDBP_IN, t_code);
        
        var rs = RSDRecordSet ( cmd );

        if (rs.moveNext)
            return rs.value ("t_objectid");
        end;
        
        return 0;
        
    end;

/*────────────────────────────────────────────────────────────────────────────────────────────────────────────────*/
    private macro getSWIFTCodeById (id)
        var cmd = RSDCommand ("SELECT t_code FROM dobjcode_dbt WHERE t_codekind = 6 AND t_objectid = ?");
        cmd.NullConversion = true;
        cmd.AddParam ("obj_id", RSDBP_IN, id);
        
        var rs = RSDRecordSet ( cmd );
        
        if (rs.moveNext)
            return rs.value ("t_code");
        end;
        
        return "";
    end;

/*────────────────────────────────────────────────────────────────────────────────────────────────────────────────*/
    private macro isDigitNum (what:string)
        var stat = false, 
            i = 1, 
            ch, 
            DigitString = "0123456789";

        while ((not stat) and (i <= strlen(what)))
            ch = substr (what, i, 1 );
        
            if( not index( DigitString, ch ))
                stat = 1;
            end;
            
            i = i + 1;
        end;
    
        return not (stat);
    end;
    
/*────────────────────────────────────────────────────────────────────────────────────────────────────────────────*/
    private macro getFIIDByAccount (t_account)
        var cmd = RSDCommand ("SELECT t_code_currency FROM daccount_dbt WHERE t_account = ?");
        cmd.NullConversion = true;
        cmd.AddParam ("acc", RSDBP_IN, t_account);
        
        var rs = RSDRecordSet ( cmd );
        
        if (rs.moveNext)
            return rs.value ("t_code_currency");
        end;
        
        return 0;
    end;

/*────────────────────────────────────────────────────────────────────────────────────────────────────────────────*/
    private macro getNameByPartyID (id)
        var Party = RSBParty (id);
        return Party.FullName;
    end;

/*────────────────────────────────────────────────────────────────────────────────────────────────────────────────*/

/*────────────────────────────────────────────────────────────────────────────────────────────────────────────────*/
    private macro InsertBBPayment (flag) /*** Банковский платеж ***/
        var CodeKind,fifi,stat ;
        var BankPaym :object;
        array FlgRM, FlgCP;

        BankPaym            = GenObject ( "RsbBbCpOrder", 0 ) ;
        BankPaym.Kind_Operation = m_Kind_Operation;
        BankPaym.Origin     = m_Origin;
        BankPaym.Oper       = m_Oper; 
        BankPaym.LaunchOper = m_LaunchOper;
        
        var Payment = BankPaym.Payment;
        

        if (m_KBK     != CodeFor (1)) 
            fillTaxPaymentStuff (Payment);
        end;
        // ----------
        fifi=m_fiid;
        // getFIIDByAccount (m_PayerAccount);
        
        Payment.DocKind            = m_docKind;
        Payment.Ground             = m_Ground;
        Payment.ShifrOper          = m_ShifrOper;
        Payment.Number             = string (m_docNumber);
        Payment.Oper               = m_Oper;
        Payment.FuturePayerFIID    = fifi;
        Payment.FutureReceiverFIID = fifi;
        Payment.PayerFIID          = fifi;
        Payment.ReceiverFIID       = fifi;
        Payment.BaseFIID           = fifi;
        Payment.PaymentKind        = m_PaymKind;
        Payment.Priority           = m_Priority;
        Payment.NumberPack         = m_NumberPack;
        Payment.Purpose            = 15;
        Payment.IsPlanPaym         = CodeFor (1);
        Payment.ClientDate         = m_ClientDate;
        Payment.StartDepartment    =
        Payment.Department         = m_Department;

        // m_docDate              = m_valueDate;
        Payment.Date           = m_docDate;
        Payment.ValueDate      = m_valueDate;
        Payment.ReceiverAmount = 
        Payment.PayerAmount    = 
        Payment.BaseAmount     = m_AmountDt;
        Payment.receiverDpNode = m_receiverDpNode;
        
        Payment.PayerBankEnterDate = m_docDate;
        Payment.OutRlsForm  = 2;  

        if (m_ReceiverBankName = "")
            m_ReceiverBankName = getNameByPartyID (getIDByBankCode(m_BankReceiverCode));
        end;
        
            CodeKind = 6;
            Payment.SetPayerPI 
                                ( 
                                    PAYMENTS_GROUP_UNDEF, 
                                    getIDByBankCode (m_BankpayerCode), 
                                    6, 
                                    m_BankpayerCode, 
                                    m_payerBankName,
                                    getCorrAccountByID (getIDByBankCode(m_BankpayerCode)),
                                    getFIIDByAccount (m_PayerAccount), 
                                    1, 
                                    m_PayerAccount, 
                                    _SelfID, 
                                    m_Payername, 
                                    m_PayerINNKPP,
                                    6,
                                    ПолучитьКодСубъекта (7177,6)
                                );

            Payment.SetReceiverPI
                                ( 
                                    pmpaym.ReceiverBankID, // PAYMENTS_GROUP_UNDEF, 
                                    getIDByBankCode (m_BankReceiverCode), 
                                    6, //CodeKind, 
                                    m_BankReceiverCode, 
                                    m_ReceiverBankName,
                                    getCorrAccountByID (getIDByBankCode(m_BankReceiverCode)),
                                    fifi, // getFIIDByAccount (m_ReceiverAccount), 
                                    1,
                                    m_ReceiverAccount, 
                                    m_Receiver, 
                                    m_ReceiverName, 
                                    m_ReceiverINNKPP,
                                    6,
                                    ПолучитьКодСубъекта (m_Receiver,6)
                                );
    
        if (BankPaym.Update () == 0)
          return Payment.DocumentID;
        end;

/*
          // R-maket
         FlgRM[ PNRMPM_SUM       ] = 1;
         FlgRM[ PNRMPM_ACCOUNTR  ] = 1;
         FlgRM[ PNRMPM_CODEKINDR ] = 1;
         FlgRM[ PNRMPM_CODEKIND2R] = 1;
         FlgRM[ PNRMPM_CODER     ] = 1;
         FlgRM[ PNRMPM_BANKACCR  ] = 1;
*/
         // Swift
         // FlgCP[ PNCPPM_PAYAMOUNT ] = 1;
        FlgCP[ PNCPPM_PAYFIID   ] = 1;
        FlgCP[ PNCPPM_ACCOUNTP  ] = 1;
        FlgCP[ PNCPPM_CODEKINDR ] = 1;
        FlgCP[ PNCPPM_CODEKINDR2] = 1;
        FlgCP[ PNCPPM_CODER     ] = 1;
        FlgCP[ PNCPPM_ACCOUNTR  ] = 1;

        if (ValType(flag) != V_UNDEF)
        else
 //         stat = PM_ProcessPanel( Payment, 0, NULL, FlgRM, FlgCP );
        end;

        return 0;
    end; /* private macro InsertBBPayment () */


/*────────────────────────────────────────────────────────────────────────────────────────────────────────────────*/
    macro insert (flag) /* Вставка документа */
        var retDocId; /* возвращаемый ID документа */

            return InsertBBPayment (flag); 


    end; /* macro insert () */
end;