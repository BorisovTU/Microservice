/*LKL
Панель условий минимальной маржи
*/

IMPORT  dl_note_lib, funk, RSD, RSBDataSet, dlgCommon;
Private const kbF2 = 316, kbF3 = 317, kbF7 = 522, kbF9 =323, kbEnter = 13;

Class (TRecHandler) CPanelCmargin ( _DealId )
    private var  DealId, CurrentField;

    InitTRecHandler ("cmargin", "mbkadd.lbr", TRUE);
    DealId    = _DealId;

    Macro scrHandler ( rs, cmd, id, key )
        if ( (cmd == DLG_KEY) and (key == kbEnter) and (rs.RecCount) )
            return CM_SELECT;
        end;
    End;


    Macro ListVal
        private var sql, cmd; 
        sql = "select t_ccy, t_name from dfininstr_dbt  where t_fi_kind=1 and t_fi_code<>1";
        cmd = RSDRecordset(sql, RSDVAL_CLIENT, RSDVAL_STATIC );
        if ( RunScroll (cmd, 2, MakeArray ("t_ccy", "Код", 3, 2, 3, 0, "t_name", "Наименование", 40, 2, 40, 0),
                        "ListVal", R2M (this, "scrHandler"), "Список валют", "Enter Выбор  ESC Отмена", TRUE, 0, 0) )
            SetParm (1, cmd.value ("t_ccy"));
            return TRUE;
        end;
        return FALSE;
    End;


    Macro Handler ( dlg, cmd, id, key )

      if( (cmd == DLG_KEY) and (key == kbF9)  )

           if ( (this.("PeriodM")==0) or (strlen(this.("ValM")) <3)  or (this.("SummaM")<=0) )
              msgbox("Не все условия определены!");
              return CM_IGNORE;
           end;
           UpdateFields (dlg);
  	   SetNoteDifValue(DealId, 105, this.("PeriodM"));
	   SetNoteDifValue(DealId, 106, this.("ValM"));
           SetNoteDifValue(DealId, 107, this.("SummaM"));
           return CM_SAVE;

      elif (cmd == 5) //DLG_IN???
           CurrentField = id;

      elif( (cmd == DLG_KEY) and (key == kbF3) and ( CurrentField == 1 )  )
           ListVal(dlg.(id));
           UpdateFields (dlg);

      elif( (cmd == DLG_KEY) and (key == kbEnter) )

           return CM_IGNORE;
      end;
    End;


    Macro Init
      private var v_valcode;
      this.("SummaM")  =  GetNoteDifValue(DealId, 107);
      v_valcode = GetNoteDifValue(DealId, 106);
      if ( v_valcode == 0 )
         this.("ValM") = "" ;
      else 
	 this.("ValM") = v_valcode ;
       end;
      this.("PeriodM") =  GetNoteDifValue(DealId, 105);

    End;

    
    Macro Run
        Init ();
        return RunDialog (this, R2M (this, "Handler"));
    End;

end;