import fx_globals,InsCarryDoc, CurrInter, Проценты, MmarkInter, mmlibr, mmcarry, mmcnst_j, mmplib, dl_lib ,"calculate.mac",dl_plib;

//PRIVATE FILE leg (dl_leg);
// PRIVATE RECORD tick (dl_tick);


private var tick = Tbfile( "dl_tick.dbt", "W" );
private var leg  = Tbfile( "dl_leg.dbt", "W" );

record mo( "uo_mem_o", "USEROP.DEF" );

MACRO Ex (Buffer, fd)

private var d00 ,d01,{curdate};
   SetBuff( mo,fd );
   d00=DAT(mo.Date_Carry);
   d01=SDAT(mo.ground);


    var deal_pd ,acc0, acc2, acc0p, s_addground, nrate, vsum, vsum2,sground,dealid,rs9,que,rs,rs1;
    var  at  = MM_Carry;
    var  atp = MM_Carry;


    que="select b.t_dealcode,a.t_account,b.t_dealid  from dmcaccdoc_dbt a, ddl_tick_dbt b , ddl_leg_dbt  c where a.t_dockind=102 ";
    que=que+ " and b.t_dealid=a.t_docid and c.t_dealid=b.t_dealid  and c.t_maturity < to_date('"+d01+"') ";
    que=que+" and c.t_maturity < to_date('"+d01+"')";
    que=que+" and a.t_catid=711 ";


//    que=que+" and a.t_catid=711 and b.t_dealcode='МБК-BELARUSBANK-02112018'";
//    que=que+" and a.t_catid=711 and b.t_dealcode='MM0000257141'";

//    que=que+" and (a.t_catid=711  or  a.t_catid=717) and b.t_dealcode='МБК-BELARUSBANK-02112018'";

    rs9 = LnGetRecordSet(que);
                    if(rs9 != null)
                      while(rs9.moveNext())
                        dealid=int(rs9.value(2));

    que = "select *  from ddl_tick_dbt  where t_dealid ="+dealid;
    rs = LnGetRecordSet(que);
    if (rs != null)
      while (rs.moveNext())
            CopyRSetToFBuff(tick, rs ) ;
            que = "select *  from ddl_leg_dbt  where t_dealid ="+dealid;
            rs1 = LnGetRecordSet(que);
            if (rs1 != null)
              while (rs1.moveNext())
                CopyRSetToFBuff(leg, rs1 ) ;
              end;
            end;
      end;
    end;


    deal_pd = MMFirstDoc(DL_IBCDOC, tick.rec.DealID, true);
    sground="Восстановление оценочного резерва ОД по "+tick.rec.dealcode+"/"+nami(tick.rec.partyid);
 /*
     if(not deal_pd.OpenAccount("+КОР_Резерв, ОД", acc0, NULL, deal_pd.GetFIRoleByCategory("+КОР_Резерв, %0", 0), NULL, {curdate}, 0))
        return 1;
     end;    
 */

                if ( tick.rec.partyid == _BANK_RF )

    if(not deal_pd.OpenAccount("+РС, кредиты%0", acc2, NULL, deal_pd.GetFIRoleByCategory("+РС, кредиты%0", 0), NULL, {curdate}, 0))
        return 1;
     end;    
                else

     if(not deal_pd.OpenAccount("+РС, кредиты%00", acc2, NULL, deal_pd.GetFIRoleByCategory("+РС, кредиты%0", 0), NULL, {curdate}, 0))
        return 1;
     end;    
                end;

     acc0 =MM_acc(tick.rec.dealid,711);

     vsum=RestA_(acc0,date(d01), 1,0);
     if ( vsum > 0 )
          at.date_carry       = d00;
          at.AccountPayer    = acc0;	  
          at.AccountReceiver = acc2;
          at.FIIDPayer       = 0;
          at.FIIDReceiver    = 0;
          at.SumReceiver     = vsum;
          at.SumPayer        = vsum;
          at.Chapter         = 1;
          at.Ground          = sground;
          if(not at.carry())
             msgbox("Error !");
             return false;
          end;
     end;

/*
     if(not deal_pd.OpenAccount("+КОР_Резерв, %", acc0, NULL, deal_pd.GetFIRoleByCategory("+КОР_Резерв, %0", 0), NULL, {curdate}, 0))
        return 1;
     end;    

*/
                if ( tick.rec.partyid == _BANK_RF )

    if(not deal_pd.OpenAccount("+РС, кредиты%0", acc2, NULL, deal_pd.GetFIRoleByCategory("+РС, кредиты%0", 0), NULL, {curdate}, 0))
        return 1;
     end;    
                else


     if(not deal_pd.OpenAccount("+РС, кредиты%00", acc2, NULL, deal_pd.GetFIRoleByCategory("+РС, кредиты%0", 0), NULL, {curdate}, 0))
        return 1;
     end;    
                end;
     acc0 =MM_acc(tick.rec.dealid,717);
     // acc2 =MM_acc(tick.rec.dealid,864);


     sground="Восстановление оценочного резерва %% по "+tick.rec.dealcode+"/"+nami(tick.rec.partyid);
     vsum2=RestA_(acc0,date(d01), 1,0);
     if ( vsum2 > 0 )

          at.date_carry       = d00;
          at.AccountPayer    = acc0;	  
          at.AccountReceiver = acc2;
          at.FIIDPayer       = 0;
          at.FIIDReceiver    = 0;
          at.SumReceiver     = vsum2;
          at.SumPayer        = vsum2;

          at.Chapter         = 1;
          at.Ground          = sground;
          if(not at.carry())
             msgbox("Error !");
             return false;
          end;
     end;
                        end;
                    end;


    return 0;
END;
