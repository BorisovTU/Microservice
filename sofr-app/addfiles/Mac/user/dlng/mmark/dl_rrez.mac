import InsCarryDoc, CurrInter, Проценты, MmarkInter, mmlibr, mmcarry, mmcnst_j, mmplib, dl_lib,dl_plib,funk ;

PRIVATE FILE leg (dl_leg);
// PRIVATE FILE pm ("pmpaym") key 1 write;
PRIVATE RECORD tick (dl_tick);


MACRO MM_acc9(par1,par2)
  private var que,rs5,rez="0";
  que="select a.t_account  from  dmcaccdoc_dbt a,  dmccateg_dbt b  where a.t_dockind=102  and a.t_docid="+par1+"  and a.t_catid=b.t_id  and t_code='"+par2+"'";
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=rs5.value(0);
     end;
  end;
  return rez;
END;

/*----------------------------------------------------------------------------
    Выполнение шага
----------------------------------------------------------------------------*/
MACRO ExecuteStep(Buffer, Document)
    var deal_pd ,acc0, acc2, acc0p, s_addground, nrate, vsum, vsum2,sground,rs9,ii,nka,nfiid,que,da;
    var  at  = MM_Carry;
    var  atp = MM_Carry;

    SetBuff (tick,Document);
    DL_PrepareCarryBuffer (Buffer);

    leg.LegKind = LEG_KIND_DL_TICK;
    leg.DealID = tick.DealID;
    leg.LegID = 1;

    if (not GetEq(leg))
        mm_error ("Не найден транш сделки");
        return 1;
    end;

    da = {curdate};
    deal_pd = MMFirstDoc(DL_IBCDOC, tick.DealID, true);
    acc0=MM_acc9(tick.DealID,"+КОР_Резерв, ОД2");
    if ( acc0 == "0")
       acc2="0";
       if (not deal_pd.OpenAccount("+КОР_Резерв, ОД2", acc2, NULL, deal_pd.GetFIRoleByCategory("+КОР_Резерв, ОД2", 0), NULL, da, 0))
          return 1;
       end;    
    end;

    acc0=MM_acc9(tick.DealID,"-КОР_Резерв, ОД2");
    if ( acc0 == "0")
       acc2="0";
       if (not deal_pd.OpenAccount("-КОР_Резерв, ОД2", acc2, NULL, deal_pd.GetFIRoleByCategory("-КОР_Резерв, ОД2", 0), NULL, da, 0))
          return 1;
       end;    
    end;

    acc0=MM_acc9(tick.DealID,"-КОР_Резерв, %0");
    if ( acc0 == "0")
       acc2="0";
       if (not deal_pd.OpenAccount("-КОР_Резерв, %0", acc2, NULL, deal_pd.GetFIRoleByCategory("-КОР_Резерв, %0", 0), NULL, da, 0))
          return 1;
       end;    
    end;

    acc0=MM_acc9(tick.DealID,"+КОР_Резерв, %0");
    if ( acc0 == "0")
       acc2="0";
       if (not deal_pd.OpenAccount("+КОР_Резерв, %0", acc2, NULL, deal_pd.GetFIRoleByCategory("+КОР_Резерв, %0", 0), NULL, da, 0))
          return 1;
       end;    
    end;

    return 0;
END;

MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -откат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */  


  private var sql,rs01,rs05,pplid,acc4,nnn;
  SetBuff(tick, FirstDoc );

  if ( CommitOrRollback == 1 )
       acc4=MM_acc9(tick.DealID,"+КОР_Резерв, ОД2");
       if ( acc4 != "0")
         nnn = "Корректировка резервов на возможные потери по ОД по "+tick.dealcode+"/"+nami(tick.partyid);
         sql="update daccount_dbt set  t_nameaccount='"+nnn+"',  t_userfield3='1' where t_account='"+acc4+"'";
         rs05 = LnGetRecordSet(sql);
       end;
       acc4=MM_acc9(tick.DealID,"-КОР_Резерв, ОД2");
       if ( acc4 != "0")
         nnn = "Корректировка резервов на возможные потери по ОД по "+tick.dealcode+"/"+nami(tick.partyid);
         sql="update daccount_dbt set  t_nameaccount='"+nnn+"',  t_userfield3='1' where t_account='"+acc4+"'";
         rs05 = LnGetRecordSet(sql);
       end;

       acc4=MM_acc9(tick.DealID,"-КОР_Резерв, %0");
       if ( acc4 != "0")
         nnn = "Корректировка резервов на возможные потери по %% по "+tick.dealcode+"/"+nami(tick.partyid);
         sql="update daccount_dbt set  t_nameaccount='"+nnn+"',  t_userfield3='1' where t_account='"+acc4+"'";
         rs05 = LnGetRecordSet(sql);
       end;

       acc4=MM_acc9(tick.DealID,"+КОР_Резерв, %0");
       if ( acc4 != "0")
         nnn = "Корректировка резервов на возможные потери по %% по "+tick.dealcode+"/"+nami(tick.partyid);
         sql="update daccount_dbt set  t_nameaccount='"+nnn+"',  t_userfield3='1' where t_account='"+acc4+"'";
         rs05 = LnGetRecordSet(sql);
       end;



  end;

  return 0;
END;
