//-----------------------------------------------------------------------------------------
// Платеж по комиссии
// v.1
//-----------------------------------------------------------------------------------------
import "gtconst.inc",calculate,funk,"cb_sql.mac",dl_plib,dl_lib,fx_globals;


private var Mmdeal = Tbfile( "dl_tick.dbt", "W" );
private var leg  = Tbfile( "dl_leg.dbt", "W" );
private   var paym       = Tbfile( "pmpaym.dbt", "W" );
private   var paymprop  = Tbfile( "pmprop.dbt", "W" );
private   var paymprop2  = Tbfile( "pmprop.dbt", "W" );
private   var pmrmprop  = Tbfile( "pmrmprop.dbt", "W" );
var sup,d22,jj,pu,d2,npach=0,Comment,;



// Макрос записи нового платежа МБК
macro _Create_op()
   var type:integer;
   var yearlen:integer;
   var stat=0,kontr,su,prpr,pss,ku,toch,dil,kurs,alg,d3,d1,v1,v2,kden;
                        
//  платеж

    paym.rec.PAYMENTID = 0;
    paym.rec.DOCKIND = Mmdeal.rec.BOFFICEKIND;
    paym.rec.DOCUMENTID = Mmdeal.rec.DEALID;
    paym.rec.PURPOSE = pu;
    paym.rec.SUBPURPOSE = jj;

    paym.rec.VALUEDATE=d2;

    paym.rec.AMOUNT = sup;
    paym.rec.BASEAMOUNT = sup;
    paym.rec.PAYAMOUNT = sup;
    paym.rec.FUTUREPAYERAMOUNT = sup;
    paym.rec.FUTURERECEIVERAMOUNT = sup;
    paym.rec.userfield1="";
    paym.rec.userfield2="";
    paym.rec.NUMBERPACK=60;

    if ( d22 != d2 )
      paym.rec.userfield1=СДАТ(d22);
    end;
    paym.rec.PAYMSTATUS =1000;

        stat = paym.insert;
        if (not stat)
                RunError( "Ошибка при создании новой сделки 10" );
        end;

//debet

                paymprop.rec.PAYMENTID = paym.rec.PAYMENTID;
                paymprop.rec.DEBETCREDIT = 0;
                paymprop.rec.TRANSFERDATE = paym.rec.VALUEDATE;
                stat = paymprop.insert;
                if (not stat)
                        RunError( "Ошибка при создании новой сделки 11." );
                end;
//credit
                paymprop2.rec.PAYMENTID = paym.rec.PAYMENTID ;
                paymprop2.rec.DEBETCREDIT = 1;
                paymprop2.rec.TRANSFERDATE = paym.rec.VALUEDATE;
                stat = paymprop2.insert;
                if (not stat)
                        RunError( "Ошибка при создании новой сделки 12." );
            end;
//Реквизиты платежа         

            pmrmprop.rec.PAYMENTID = paym.rec.PAYMENTID ;
            pmrmprop.rec.DATE = d2;
            pmrmprop.rec.PAYDATE = d2;
            pmrmprop.rec.CLIENTDATE = d2;
            pmrmprop.rec.ground= MM_ground(Mmdeal.rec.DEALID,572) ;

                stat = pmrmprop.insert;
                if (not stat)
                        RunError( "Ошибка при создании новой сделки 13." );
                end;

// -----------------
  OnError( RslErrObj ) //А если ошибка - заполняем коммент
        Comment = RslErrObj.Message;
    AbortTrn();

end;

// ------------------------------------------------------



MACRO kom_plat(idsd,vkom,acc,flag01,flag02,kamount,kfiid);
    private var que,rs,rs1,rr,rs2б,amount,rs2,nrate,acc5; 
/*
   входные данные
   idsd- dealid сделки
   vkom - вид комиссии (оно равно t_suppurpose в платеже (dpmpaym_dbt)
   2- комиссия уступки
   3- комиссия за выданный кредит
   4- комиссия за управление


   acc - счет по расчетам
   flag01    - кто платит комиссию   (0 - банк, 1 - контрагент);
   flag02    - вариант комисии  (0 -  процент комиссии от суммы сделки, 1- фиксированная сумма процентов)
   kamount   - суммма процентов или сумма комисиии
   kfiid     - fiid валюты комиссии

*/

    // Данные по сделке
    que = "select *  from ddl_tick_dbt  where t_dealid ="+idsd;
    rs = LnGetRecordSet(que);
    if (rs != null)
      while (rs.moveNext())
            CopyRSetToFBuff(mmdeal, rs ) ;
            que = "select *  from ddl_leg_dbt  where t_dealid ="+idsd;
            rs1 = LnGetRecordSet(que);
            if (rs1 != null)
              while (rs1.moveNext())
                CopyRSetToFBuff(leg, rs1 ) ;
              end;
            end;
      end;
    end;


//--- расчет суммы в зависимости от вараинта комиссии (процент или фиксированная сумма) -------------- 
     if (flag02 == 0 )
        amount=(leg.rec.principal*kamount)/100;
     else
        amount=kamount;
     end;
     

// ---- расчет сумммы комиссии в руб если валюты сделки не руб ------------------------------------------------------------------------------------------------

    if (leg.rec.pfi != kfiid)
        if (0 != Получить_Курс0(nrate, leg.rec.pfi, {curdate}))
          Msgbox("Не возможно получить курс за ", {curdate});
          return 1;
        end;
        amount=money(amount*nrate);
    end;
  

    getmoney(amount,"Укажите суммму комиссии",20);

    pu=72;
    // d2=ДАТ(Mmdeal.rec.dealdate);
    d2={curdate};
    d22=d2;
    sup=amount;
    jj=vkom;
    npach=10;



    if (flag01 == 0 )              // если платеж платит банк - плательщик по аналогии платежа размещения
      que="select t_paymentid  from dpmpaym_dbt where t_purpose=9 and t_dockind=102 and t_documentid = "+idsd; // and t_subpurpose=0
    else
      que="select t_paymentid  from dpmpaym_dbt where t_purpose=10 and t_dockind=102 and t_documentid = "+idsd; // and t_subpurpose=0
    end;

    if (( Mmdeal.rec.dealtype == 12300 ) and (flag01 == 0 ) )  // по привлечению изменение признака
      que="select t_paymentid  from dpmpaym_dbt where t_purpose=10 and t_dockind=102 and t_documentid = "+idsd; // and t_subpurpose=0
    elif (( Mmdeal.rec.dealtype == 12300 ) and (flag01 == 1 ) ) 
      que="select t_paymentid  from dpmpaym_dbt where t_purpose=9 and t_dockind=102 and t_documentid = "+idsd;   // and t_subpurpose=0
    end;

    rs = LnGetRecordSet(que);
    if(rs != null)
       if (rs.moveNext) 
         rr=rs.value(0);
       end;
    end;


    que="select *  from dpmpaym_dbt where t_paymentid = '"+rr+"'"; 
    rs2 = LnGetRecordSet(que);
    if (rs2 != null)
      while (rs2.moveNext())                                
        CopyRSetToFBuff(paym, rs2 ) ;
      end;
    end;


    if (leg.rec.pfi != kfiid)
      paym.rec.FIID             = kfiid;
      paym.rec.PAYFIID          = kfiid;
      paym.rec.FIID_FUTUREPAYACC= kfiid;
      paym.rec.FIID_FUTURERECACC= kfiid;
      paym.rec.BASEFIID         = kfiid;
      if ( kfiid == 0 )
        paym.rec.PAYERBANKID=paym.rec.PAYER;
        paym.rec.RECEIVERBANKID=paym.rec.RECEIVER;
        if (flag01 == 1 )
          paym.rec.PAYERACCOUNT="0";
        else
          paym.rec.RECEIVERACCOUNT="0";
        end;

      end;

    end;


    if (flag01 == 0 )
       paym.rec.PAYERACCOUNT=acc;
       paym.rec.futurepayeraccount=acc;
       acc5=" ";
       getstring(acc5,"Укажите счет получателя",20);
       paym.rec.RECEIVERACCOUNT=acc5;

    else
       paym.rec.RECEIVERACCOUNT=acc;
       paym.rec.futurereceiveraccount=acc;

    end;





    que="select *  from dpmprop_dbt where t_DEBETCREDIT = 0 and t_paymentid = '"+rr+"'"; 
    rs2 = LnGetRecordSet(que);
    if (rs2 != null)
      while (rs2.moveNext())
            CopyRSetToFBuff(paymprop, rs2 ) ;
      end;
    end;
    que="select *  from dpmprop_dbt where t_DEBETCREDIT = 1 and t_paymentid = '"+rr+"'"; 
    rs2 = LnGetRecordSet(que);
    if (rs2 != null)
      while (rs2.moveNext())
            CopyRSetToFBuff(paymprop2, rs2 ) ;
      end;
    end;

    que="select *  from dpmrmprop_dbt where t_paymentid = '"+rr+"'"; 
    rs2 = LnGetRecordSet(que);
    if (rs2 != null)
      while (rs2.moveNext())
            CopyRSetToFBuff(pmrmprop, rs2) ;
      end;
    end;
    if (ProcessTrn(0,"_Create_op"))
        else
                msgbox("Сделка не загружена");
                MSGBOX(Comment);
                return 1;
    end;

    return 0;

END;





 


