/*
  $Name:             rminpm.mac
  $Module:           АРМ позиционера
  $Description:      Макрос скроллинга входящих платежей
*/

import PaymInter, globals, PTInter, OprInter, CTInter, FIInter, WldInter,funk,
"rmtools.mac", lnpaym, "likepy.mac", "rmtplstr.mac", "cbdefbo.mac", "rmcmptl.mac","pm_tools.mac", "pm_chksave.mac";
import "cb_FillFactura.mac", "pmedit.mac", pmbuff;
import "pmchangeprop.mac";

const СимволШагаРазрешениеРедактирования = "З";

/*номера полей в панели*/
const fld_akkr_Number = 1,          /*Номер аккредитива*/
      fld_akkr_PayerBankCode = 13,  /*Код банка плательщика*/
      fld_akkr_Date = 3,            /*Срок действия аккредитива*/
      fld_akkr_Type = 1,            /*Вид аккредитива*/
      fld_akkr_PayCondition = 2;    /*Условие оплаты аккредитива*/

/* Хинты */
// а) списки по шагу
private const Hint_ByStep:string = "/*+FIRST_ROWS LEADING(t oproper pmpaym pmprop pmrmprop prop2 pk rk) INDEX(t doprstep_dbt_idx10) INDEX(pmprop dpmprop_dbt_idx0) INDEX(pmpaym dpmpaym_dbt_idx0) USE_NL(t oproper pmpaym pmprop pmrmprop prop2 pk rk)*/";
// а1) списки по шагу для невыясненных
private const Hint_ByStepUnk:string = "/*+FIRST_ROWS LEADING(t oproper pmpaym pmprop prop2 pmrmprop rminprop wlpm ) INDEX(t doprstep_dbt_idx10) INDEX(pmpaym dpmpaym_dbt_idx0) INDEX(pmprop dpmprop_dbt_idx0)  USE_NL(t oproper pmpaym pmprop prop2 pmrmprop rminprop wlpm )*/";
// б) списки по статусу платежа
private const Hint_ByPaymStatus:string = "/*+FIRST_ROWS LEADING(pmpaym t pmrmprop prop2 oproper oprstep pk rk) INDEX(pmpaym dpmpaym_dbt_idx16) INDEX(t dpmprop_dbt_idx0) USE_NL(pmpaym t pmrmprop prop2 oproper oprstep wlpm wlmeslnk wlmes pk rk)*/";
// в) списки по статусу свойств, где документов слишком много, и необходима фильтрация по дате
// в1) Если фильтрация по дате значения
private const Hint_ByValueDate:string = "/*+FIRST_ROWS LEADING(pmpaym t pmrmprop prop2 oproper oprstep pk rk) INDEX(pmpaym dpmpaym_dbt_idx11) INDEX(t dpmprop_dbt_idx0) USE_NL(pmpaym t pmrmprop prop2 oproper oprstep pk rk)*/";
// в2) Если фильтрация по ДПП
private const Hint_ByTransferDate:string = "/*+FIRST_ROWS LEADING(t pmpaym pmrmprop prop2 oproper oprstep pk rk) INDEX(t dpmprop_dbt_idx1) INDEX(pmpaym dpmpaym_dbt_idx0) INDEX(oprstep doprstep_dbt_idx0) USE_NL(t pmpaym pmrmprop prop2 oproper oprstep wlpm wlmeslnk wlmes pk rk)*/";
// в3) Если фильтрация по дате закрытия
private const Hint_ByCloseDate:string = "/*+FIRST_ROWS LEADING(pmpaym t pmrmprop prop2 oproper oprstep pk rk) INDEX(pmpaym dpmpaym_dbt_idx15) INDEX(t dpmprop_dbt_idx0) INDEX(oprstep doprstep_dbt_idx0) USE_NL(pmpaym t pmrmprop prop2 oproper oprstep wlpm wlmeslnk wlmes pk rk)*/";
// г) списки по статусу (несквитованныеб отвергнутые)
private const Hint_ByOprStatus:string = "/*+FIRST_ROWS LEADING(t oproper oprstep pmpaym pmprop prop2 pmrmprop wlpm pk rk) INDEX(t doprcurst_dbt_idx1) INDEX(wlpm dwlpm_dbt_idx1) USE_NL(t oproper oprstep pmpaym pmprop prop2 pmrmprop wlpm pk rk)*/";
// для скролинга входящих валютных в РКО
private const Hint_ByPaymStatus_cpins:string = "/*+FIRST_ROWS LEADING(t pmrmprop pmprop oproper oprstep wlpm) INDEX(t dpmpaym_dbt_idx16) INDEX(pmprop dpmprop_dbt_idx0) USE_NL(t pmrmprop pmprop oproper oprstep wlpm wlmeslnk wlmes)*/";
private const Hint_ByValueDate_cpins:string = "/*+FIRST_ROWS LEADING(t pmrmprop pmprop oproper oprstep wlpm) INDEX(t dpmpaym_dbt_idx11) INDEX(pmprop dpmprop_dbt_idx0) USE_NL(t pmrmprop pmprop oproper oprstep wlpm wlmeslnk wlmes )*/";

private const Hint_ByNeedExecNotify:string = "/*+FIRST_ROWS LEADING(t) INDEX(t dwlpm_dbt_idxA)*/";

/* Установка подсказки для скролингов из макроса */
MACRO УстановитьПодсказку( TableName:string, IndexNum:integer, DefaultHint:string, ScrolStates:integer ):string
  // Пример формируемой подсказки
  //    "/*+FIRST_ROWS LEADING(t)*/"

  if( ( ScrolStates == PM_READY_TO_RECEIVE_SCR ) or   /* отложенные   */
      ( ScrolStates == PM_INPROCESSING_SCR ) )    /* открытые */

    return Hint_ByPaymStatus;

  elif ( ScrolStates == PM_UNKNOWN_SCR )  /* На счетах невыясненных сумм */
    return Hint_ByStepUnk;
  elif ( ( ScrolStates == PM_PREPROC_SCR ) or /* На предобработке  */
         ( ScrolStates == PM_READY_TO_CONTROL_SCR ) or /* Контроль */         
         ( ScrolStates == PM_WAITEDIT_SCR ) or /* ожидающие ручной обработки */
         ( ScrolStates == PM_WAITEDITFILIAL_SCR ) or /* На обработке в других филиалах */
         ( ScrolStates == PM_IN_CARDFILE_SCR ) or /* Документы на картотеках к корсчетам */
         ( ScrolStates == PM_IN_QUEUE_SCR ) or /* В очереди */
         ( ScrolStates == PM_TOBACKOFFICE_SCR ) or /* Переданные в БО */
         ( ScrolStates == PM_STEP_SCR ) )  /* на шаге */
    
    return Hint_ByStep;

  elif( ( ScrolStates == PM_INCLOSED_SCR ) or /* закрытые */
        ( ScrolStates == PM_INALL_SCR ) or /* все ответные */
        ( ScrolStates == PM_TRANSIT_SRC )) 

    var dtflt:PMScrolDateFltr = PMScrolDateFltr();

    if( dtflt.IsSet( DTFL_TRANSFERDATE ) )
      return Hint_ByTransferDate;
    elif( dtflt.IsSet( DTFL_VALUEDATE ) )
      return Hint_ByValueDate;
    elif( dtflt.IsSet( DTFL_CLOSEDATE ) )
      return Hint_ByCloseDate;
    end;
  elif( ScrolStates == PM_STATUS_IN_SRC )
    return Hint_ByOprStatus;
  elif( ScrolStates == 100 ) /*CPINSPAY_KIND_WORK*/
    return Hint_ByPaymStatus_cpins;
  elif( ScrolStates == 101 ) /*CPINSPAY_KIND_FINISHED*/
    return Hint_ByValueDate_cpins;
  elif( ScrolStates == PM_FORNOTIFY )
    return Hint_ByNeedExecNotify;
  end;

  return DefaultHint;
END;

macro Новый_Документ( )
  return 0;
end;


/*проверка на то, что входит в ТС*/
private macro Входит_в_ТС():bool
  var rs : RsdRecordset,
  Query: string = " SELECT * "+
                    " FROM ddp_dep_dbt dp "+
                   " WHERE dp.t_PartyID = :ReceiverBankID "+
                    "  AND dp.t_AccessMode = 1 ",
  params: TArray = makeArray( SQLParam( "ReceiverBankID", r_pmpaym.ReceiverBankID  ) );
  rs = execSQLselect( Query, params , true  );
  return  rs.MoveNext();
end;

macro Проверить_Документ( Режим )
  var PropStatus,
      stat;
    if ( r_pmrmprop.ShifrOper == "08" )
    if ( (Режим == 2) or (Режим == 3) or (Режим == 8) )

      if ( r_pmpaym.PayerBankID == r_pmpaym.ReceiverBankID )
         msgbox("Банк плательщика не должен совпадать с банком получателя");
         stat = fld_akkr_PayerBankCode;        
         return stat;
      end;             
      
      if ( NOT Входит_в_ТС() )
         msgbox("Банк получателя не входит в ТС (on-line)");
         stat = fld_akkr_PayerBankCode;        
         return stat;
      end;
      
      if ( (r_pmpaym.FIID != r_pmpaym.PayFIID) or (r_pmpaym.BaseFIID != r_pmpaym.PayFIID) or (r_pmpaym.BaseFIID != NATCUR) )
         msgbox("Аккредитив может быть только в рублях");
         return 1;
      end;
      
      if ( (r_credit.DebetCredit == 0) ) 
         msgbox("Аккредитив может быть только кредитовым");
         return 1;
      end;
         
      if ( r_pmakkr.Date < {curdate} )
         msgbox("Срок действия аккредитива должен быть больше|либо равен дате операционного дня"); 
         stat = fld_akkr_Date;
         return stat;
      end;

      if ( r_pmakkr.Type == "" )
         msgbox("Не задан вид аккредитива");
         stat = fld_akkr_Type; 
         return stat;
      end;                    

      if ( StrLen( r_pmrmprop.Ground ) == 0 )
         MsgBox("Не заполнено поле 'Наименование товаров (работ, услуг), № и дата договора, срок отгрузки товаров (выполнения работ, оказания услуг), грузополучатель и место назначения'");
         return 1;
      end;

      if ( StrLen( r_pmrmprop.Number ) == 0 )
         MsgBox("Не задан номер аккредитива");
         return fld_akkr_Number;
      end;
      
    end;
  end;
  
  if ( (Режим == 2) or (Режим == 3) or (Режим == 8) )
    
    /*проверка реквизитов валютной операции*/
    if( PM_CheckCO(r_pmpaym,r_pmrmprop,r_debet,r_credit) )
      return 1;
    end;

    /* Общие проверки по списку */

    if( r_pmpaym.Purpose == PM_PURP_BANKPAYORDER )
      stat = RMIN_ScrolMacroCommonChecksForBankPayorder( TPanelFields(), r_pmpaym, r_debet, r_credit, r_pmrmprop );
    else
      stat = RMIN_ScrolMacroCommonChecks( TPanelFields(), r_pmpaym, r_debet, r_credit, r_pmrmprop );
    end;

    if( stat != NOTERROR )
      return stat;
    end;
    
  end;
  
  if((Режим == 2) or (Режим == 3)) // Проверки при вводе и редактировании
      
    if( PM_CheckPayments( r_pmpaym, r_debet, r_credit, r_pmrmprop, 1 ) )
      return 1;
    end;

  end;

  if( Режим == 3 )  /* РЕДАКТИРОВАНИЕ ДОКУМЕНТА */
    /*При редактировании производим проверку важности внесенных изменений */
    /* Константы важности внесенных изменений:           */
    /* CHANG_NOTIMPORTANT   - изменения неважные (сохранение без отката операции)*/
    /* CHANG_IMPORTANT      - изменения важны (сохранение изменений возможно только при откате) */
    /* CHANG_NOTKEEP        - не сохранять изменения */
    /* Если возвращаемое значение  > 0, то это оно интерпретируется как номер поля с ошибочным параметром*/
    /* Если возвращаемое значение  = 0, то cчитается, что проверка прошла успешно
       и сохранение изменений можно производить без отката операции      */

    if (StandartCheckUpdate(TCheckUpdateParam(r_pmpaym, r_debet, r_credit, r_pmrmprop, null, null, null, null, r_pmakkr, r_pmcurtr), 
        TCheckUpdateParam(r_pmpaym_old, r_debet_old, r_credit_old, r_pmrmprop_old, null, null, null, null, r_pmakkr_old, r_pmcurtr_old)) == CHANG_NOTKEEP)
      return CHANG_NOTKEEP;
    end;       

  elif( Режим == 2 ) /* Ввод ответного платежа  */

  end;
  

  return 0;
end;

/*
 return 0;        // никаких действий после работы макросы не делать
 return UPDTREC   // обновить в скролле текущюю запись
 return UPDTPAGE  // обновить страницу скроллла         
*/
macro Функция_Пользователя(Режим)
  private var ii,rs21,que,mnu = tarray(), imnu = 0;
  if (Режим == UFN_PANEL_INPUT)
    // функция вызвана из панели ввода объекта
  end;
  if (Режим == UFN_PANEL_EDIT)
    // функция вызвана из панели корректировки объекта  
  end;
  if (Режим == UFN_SCROL)
    // функция вызвана из панели скроллинга, единичный вызов (read-only)  
  end;

  mnu(imnu) = "ВВОД";
  imnu = imnu + 1;

  mnu(imnu) = "Подогнать под СВ";
  imnu = imnu + 1;
  
  if(imnu > 0)
    imnu = -2;
    imnu = menu(mnu);
    if(imnu >= 0)
      if(mnu(imnu) == "Подогнать под СВ")
        que="update dpmpaym_dbt set t_paymstatus=2995, t_tobackoffice=chr(89) where t_paymentid="+r_pmpaym.paymentid;
      elif(mnu(imnu) == "ВВОД")
        que="update dpmpaym_dbt set t_paymstatus=2995 where t_paymentid="+r_pmpaym.paymentid;
      end;
    end;
  end;

  ii=0;
  getint(ii,"ВВОД");
  if ( ii == 1000 )
      rs21 = LnGetRecordSet(que);
      MSGBOX("квитовка !");
  elif ( ii == 1100 )
      que="update dpmpaym_dbt set t_paymstatus=2995, t_tobackoffice='Ю' where t_paymentid="+r_pmpaym.paymentid;
      rs21 = LnGetRecordSet(que);
      MSGBOX("квитовка ФИССИКО !");

  end;


  return 0;
end;

macro  ЗапроситьРеквизиты()
  return ChoicePaymentPropertiesFromScrol();
end;

macro  УстановитьРеквизиты( PaymentID )
  return ChangePaymentPropertiesFromScrol( PaymentID );
end;