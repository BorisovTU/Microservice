import /*SImanov - избавляемся от библиотеки CommonInter,*/globals, RsbDataSet, dlwreps, oralib, funk, adress, docsign,funk;
// RsbDataSet, funk, vaprord;

var did=0;

private MACRO SDAT0(s);
      private var ss;
      ss=trim(substr(string(s),1,10));
      if (substr(ss,3,1) != "." )
       ss="0"+ss;
      end; 

      return(ss);
END;



macro GetSFIO(par1)
  private  var que, rs;

  que = "select b.t_name  from dparty_dbt b where b.t_partyid="+par1;
  rs = LnGetRecordSet(que);
  if(rs != null)
    if (rs.moveNext) 
       return  rs.value(0) ; 
    else
       return " ";
    end;	
  end;
end;

macro GetDFIO(par1)
  private  var que, rs;

  que = "select b.t_name, a.t_personid from dofficer_dbt a , dparty_dbt b where a.t_partyid="+par1+" and a.t_post='Дилер' and b.t_partyid=a.t_personid ";
  rs = LnGetRecordSet(que);
  if(rs != null)
    if (rs.moveNext) 
       did=rs.value(1);
       return  rs.value(0) ; 
    else
       return " ";
    end;	
  end;
end;



macro GetDadr(par1,par2)
  private  var que, rs,rez=" ";

  que = "select t_adress from dadress_dbt where t_partyid="+par1+" and t_type="+par2;
  rs = LnGetRecordSet(que);
  if(rs != null)
    if (rs.moveNext) 
       rez=rs.value(0);
    end;	
  end;
  return rez;
end;



macro GetDpasp(par1)
  private  var que, rs,rez=" ";

  que = "select T_PAPERSERIES,T_PAPERNUMBER,T_PAPERISSUEDDATE, T_PAPERISSUER from dpersnidc_dbt where t_personid="+par1;
  rs = LnGetRecordSet(que);
  if(rs != null)
    if (rs.moveNext) 
       rez="Паспорт серия "+rs.value(0)+" номер "+rs.value(1)+" выдан "+SDAT0(rs.value(2))+" "+rs.value(3);
    end;	
  end;
  return rez;
end;



macro GetFl(par1,par2)
    private var que,sa1,sa2,srez,rs51;
    srez=" ";
    que="select t_" +par2+" from dpersn_dbt where t_personid="+par1;  
    rs51 = LnGetRecordSet(que);
    if(rs51 != null)
      if (rs51.moveNext) 
        srez=rs51.value(0);
      end;
    end;
    return srez;
end;




private MACRO TIM0(s);
      private var ss,d1;
      ss=trim(substr(string(s),1,8));
      if (substr(ss,3,1) != ":" )
       ss="0"+ss;
      end; 
      d1=substr(ss,1,5);
      return(d1);
END;


/* Генерация имени файла */
private MACRO GenFileName(_dealid)
VAR str;
    str = "DocMBK115fz_" +string({oper})+"_"+ string(_dealid)+".docx";
    return str;
END;


/*  Тэг для реквизитов нашего контрагента.*/
private MACRO ContrTag (_partyid)
var 
   party = TBfile("party.dbt"), 
   partcode = TBfile("partcode.dbt"),
//   settacc =  TBfile("settacc.dbt"),
//   corschem = TBfile("corschem.dbt"),
//   Валюта,
   found, Ok;
   record PtAdress ( adress );

   party.KeyNum = 0;
   party.rec.PartyID = _partyid;
   Ok = party.GetEQ;
   if(Ok)
      ClearRecord(PtAdress);

//Наименование контрагента/получателя
      [~DealContrName];
      println(party.rec.Name);
      [~BankContrName];
      println(party.rec.Name);
      [~ReceiverName];
      println(party.rec.Name);

//Адреса контрагента/получателя
      НайтиЮридическийАдресСубъекта(party.rec.PartyID,PtAdress);
//      [~SelfCaptionShort];
//      println(party.rec.ShortName);
      [~ContrRegAddress];
      println(PtAdress.Adress);
      НайтиАдресСубъекта(party.rec.PartyID,1,PtAdress);
      [~ContrFactAddress];
      println(PtAdress.Adress);


   end;

   partcode.KeyNum = 0;
   partcode.rec.PartyID = _partyid;
   partcode.rec.CodeKind = PTCK_INN;
   Ok = partcode.GetEQ;
   if(Ok)
      [~DealContrINN];
      println(partcode.rec.Code);
      [~ReceiverINN];
      println(partcode.rec.Code);

   end;

   if (party.rec.NotResident == "X")
       partcode.rec.CodeKind = PTCK_SWIFT;
   else
       partcode.rec.CodeKind = PTCK_BIC;
   end;

   Ok = partcode.GetEQ;
   if(Ok)
      [~DealContrBIC];
      println(partcode.rec.Code);
      [~BankContrBIC];
      println(partcode.rec.Code);
      [~ReceiverBankBIC];
      println(partcode.rec.Code);

   end;

   partcode.rec.CodeKind = PTCK_OGRN;
   Ok = partcode.GetEQ;
   if(Ok)
      [~DealContrOGRN];
      println(partcode.rec.Code);
      [~ReceiverOGRN];
      println(partcode.rec.Code);

   end;

   [~DealContrOKPO];
   println(party.rec.OKPO);
   [~ReceiverOKPO];
   println(party.rec.OKPO);


//return true;
end;


//Печать по выбранной сделке
MACRO Print_115fz(_dealid, ishide, count, RepOperName, RepOperPost, RepBossName )
//msgbox(_dealid);
 private var sign   = CDocumentSign,{oper},ids,ids2;
// private var TxtDir = GetRegVal( "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR", TRUE );
 var TempFile ,qque,rs0; 
 private var sacc, Lines, n = 1, FileName, FileID, sql, sqlquery, party, ArchFileName;


//Если подписанты не переданы, то спросим
if ((strlen(RepOperName) == 0) or (strlen(RepBossName) == 0))

//  sign.run;

//  RepOperName = Sign.("Name1");
//  RepOperPost = Sign.("Post1");
//  RepBossName = Sign.("Name2");


  ids=string({oper});
  ids2=-1;
  if ( ids == "1" )
    ids="1024";
  end;
  ids="СОТРУДНИК_"+ids;
  RepOperName =" ";
  qque="select t_objectid from dobjcode_dbt where t_code='"+ids+"'";
  rs0 = LnGetRecordSet(qque);
  if(rs0 != null)
    if (rs0.moveNext) 
     RepOperName = GetSFIO(rs0.value(0));
     ids2=rs0.value(0);
    end;	
  end;


  RepOperPost = " ";

  qque="select a.t_post from dofficer_dbt a where  a.T_PERSONID="+ids2;
  rs0 = LnGetRecordSet(qque);
  if(rs0 != null)
    if (rs0.moveNext) 

     RepOperPost = rs0.value(0);

    end;	
  end;




  RepBossName = " ";

  qque="select a.T_PERSONID,a.t_post from dofficer_dbt a where  t_isfirstofficeperson='X' and t_partyid=1";
  rs0 = LnGetRecordSet(qque);
  if(rs0 != null)
    if (rs0.moveNext) 

     RepBossName = GetSFIO(rs0.value(0));

    end;	
  end;



end;

    if (count < 0)
       InitProgress(1,"Подождите...", "Формирование отчета по сделке МБК");
    end;

    sqlquery="select t.t_dealtype as dealtype, a.t_account as acc, to_char(t_dealdate,'dd.mm.yyyy') as dealdate, t.t_partyid as contrid, l.t_pfi as pfi, "+
             "to_char(l.t_principal,'999,999,999.99') as amount, l.t_start as begdate, f.t_name as curname, "+ 
             "c.t_name  as countryname,  "+
             "a.t_activatedate as accdate, m.t_receiveraccount as contracc, "+
             "(select to_char(o.t_docdate,'dd.mm.yyyy') from dobjrgdoc_dbt o where o.t_objectid =t.t_partyid and o.t_regdockind = 4 ) as regdate  "+
             "from ddl_tick_dbt t, ddl_leg_dbt l, dmcaccdoc_dbt a, dfininstr_dbt f, dparty_dbt p, dcountry_dbt c, dpmpaym_dbt m "+
             "where t.t_dealid ="+String(_dealid)+ " and t.t_dealid=l.t_dealid and t.t_dealid=a.t_docid "+
             "and a.t_catid=111 and a.t_catnum=601 and  f.t_fi_kind=1 and l.t_pfi=f.t_fiid "+
             "and t.t_partyid=p.t_partyid and c.t_codelat3 = decode(nvl(p.T_NRCOUNTRY,'RUS'),chr(1),'RUS',p.T_NRCOUNTRY) " +
             "and m.t_dockind=102 and m.t_purpose=9 and t.t_dealid=m.t_documentid"; 

//msgbox(sqlquery);
//Имя шаблона и временного файла

    FileName = "";
    // ArchFileName = GetCurDir(true)+"\\TxtFile\\"+GenFileName(_dealid);

    // ArchFileName =  "\\\\sgo-fc01-r03.go.rshbank.ru\\sofr_for_etl\\inbox\\import\\BR\\"+GenFileName(_dealid);
     ArchFileName =  "\\\\sgo-fc01-r03.go.rshbank.ru\\sofr_for_etl\\inbox\\import\\"+GenFileName(_dealid);

    println("MBK_115FZ.dotx");
    println("MBK_115FZ");


  sql = ExecSQLSelect(sqlquery, null, false);
  if (sql.Movenext())


//Тип сделки
   if (sql.value("dealtype") == 12305)
        [~DealType];
   	println("ПРИВЛЕЧЕНИИЕ ДЕПОЗИТА");

        [~ReceiverAccountType];
        println("кредитный");

   elif  (sql.value("dealtype") == 12300)
        [~DealType];
   	println("РАЗМЕЩЕНИЕ ДЕПОЗИТА");

        [~ReceiverAccountType];
        println("депозитный");
   end;


//Дата сделки
   [~DealDate];
   println(sql.value("dealdate"));

//Сумма сделки
   [~DealAmount];
   println(sql.value("amount"));

//Наименование валюты сделки
   [~DealCurName];
   println(sql.value("curname"));


//Атрибуты контрагента по сделке
   ContrTag(sql.value("contrid"));

//Страна
   [~ContrCountryName];
   println(sql.value("countryname"));
   [~BankContrCountryName];
   println(sql.value("countryname"));
   [~ReceiverCountryName];
   println(sql.value("countryname"));

//Дата регистрации
   [~ContrRegDate];
   println(sql.value("regdate"));
   [~ReceiverRegDate];
   println(sql.value("regdate"));


// ДИЛЕР

   [~Dealer];
   println(GetDFIO(sql.value("contrid")));


   [~Ddr];
   println(SDAT0(GetFl(did,"born")));


   [~Dmr];
   println((GetFl(did,"BIRSPLASE")));


   [~Dpasp];
   println(GetDpasp(did));


   [~Dadr1];
   println(GetDadr(did,1));

   [~Dadr2];
   println(GetDadr(did,2));




   [~Dealer2];
   println(GetDFIO(sql.value("contrid")));


   [~Ddr2];
   println(SDAT0(GetFl(did,"born")));


   [~Dmr2];
   println((GetFl(did,"BIRSPLASE")));


   [~Dpasp2];
   println(GetDpasp(did));


   [~Dadr11];
   println(GetDadr(did,1));

   [~Dadr22];
   println(GetDadr(did,2));




//Счета
   sacc = sql.value("contracc");
   [~ContrAccount];
   println(substr(sacc,1,5)+"-"+substr(sacc,6,3)+"-"+substr(sacc,9,1)+"-"+substr(sacc,10,4)+"-"+substr(sacc,14,7));

   sacc = sql.value("acc");
   [~ReceiverAccount];
   println(substr(sacc,1,5)+"-"+substr(sacc,6,3)+"-"+substr(sacc,9,1)+"-"+substr(sacc,10,4)+"-"+substr(sacc,14,7));

//Дата открытия счета 
   [~ReceiverAccountOpenDate];
   println(SDAT0(sql.value("accdate")));

//Дата составления отчета
   [~RepDate];
   println(SDAT0(Date()));

//Время составления отчета
   [~RepTime];
   println(TIM0(Time()));

//Подписанты
   [~RepOperPost];
   println(RepOperPost+"\n");

   [~RepOperName];
   println(RepOperName);

   [~RepBossName];
   println(RepBossName+"\n");


  end;


/* Завершение вывода */
    TempFile = SetOutPut(GetTxtFileName ("Mbk115FZInWord"), FALSE);


    if (ishide)
        DLWREPS_PrintReportFromTagFile (TempFile,@FileName, true, true );

        if(IsStandAlone) /*Двухзвенка*/
          RemoveFile ( ArchFileName );
          if(not CopyFile(FileName, ArchFileName))
            msgbox("Ошибка при копировании файла|" + FileName + "|в каталог архива|" + ArchFileName);
          end;
        else /*Трехзвенка*/
          RemoveFile ("$" + ArchFileName);
          if(not CopyFile("$" + FileName,"$" +  ArchFileName))
            msgbox("Ошибка при копировании файла|" + FileName + "|в каталог архива|" + ArchFileName);
          end;
        end;

    else
        DLWREPS_PrintReportFromTagFile (TempFile); 
    end;
    SetOutput(NULL, false);                               

    if (count < 0)
       UseProgress(1);
       RemProgress(1);
       msgbox("Формирование отчета завершено!");
    end;
    return 1;

END;

//Печать по выборке сделок  за дату
macro Print_115fz_AllbyDate()
private var DealDate, i, sql, sqlquery, sqltmpl, count, stat = false;
private var sign = CDocumentSign, RepOperName, RepOperPost, RepBossName, TempFile, FileName, qque,rs0,ids,ids2;;

                              
  DealDate = {curdate};

  while( not stat )
   stat = GetDate( DealDate, " Введите дату отчета: " );
   if(DealDate > {curdate})
      MsgBox( " Введенная дата больше текущего операционного дня !!! ");
      stat = true;
   end;
  end;

/*
  sign.run;
  RepOperName = Sign.("Name1");
  RepOperPost = Sign.("Post1");
  RepBossName = Sign.("Name2");
  if ((strlen(RepOperName) == 0) or (strlen(RepBossName) == 0))
    msgbox("Подписанты не определены. Отчет не сформирован!");
    return 1;
  end;
*/


  ids=string({oper});
  ids2=-1;
  if ( ids == "1" )
    ids="1024";
  end;
  ids="СОТРУДНИК_"+ids;
  RepOperName =" ";
  qque="select t_objectid from dobjcode_dbt where t_code='"+ids+"'";
  rs0 = LnGetRecordSet(qque);
  if(rs0 != null)
    if (rs0.moveNext) 
     RepOperName = GetSFIO(rs0.value(0));
     ids2=rs0.value(0);
    end;	
  end;


  RepOperPost = " ";

  qque="select a.t_post from dofficer_dbt a where  a.T_PERSONID="+ids2;
  rs0 = LnGetRecordSet(qque);
  if(rs0 != null)
    if (rs0.moveNext) 

     RepOperPost = rs0.value(0);

    end;	
  end;




  RepBossName = " ";

  qque="select a.T_PERSONID,a.t_post from dofficer_dbt a where  t_isfirstofficeperson='X' and t_partyid=1";
  rs0 = LnGetRecordSet(qque);
  if(rs0 != null)
    if (rs0.moveNext) 

     RepBossName = GetSFIO(rs0.value(0));

    end;	
  end;






  sqltmpl =" from ddl_tick_dbt where   t_bofficekind=102 and t_dealtype in (12300, 12305) and t_dealdate = to_date('"+SDAT0(DealDate) +"','DD.MM.YYYY')";
  sqltmpl =sqltmpl +" and (select count(*) from DDL_GENAGR_DBT b where b.t_dockind=4611 and b.t_partyid=t_partyid and b.t_deposit='X') > 0 ";

  sqlquery ="select count(*) as cnt"+ sqltmpl;
  sql = ExecSQLSelect(sqlquery, null, false);
  if (sql.Movenext())
    count = int(sql.value("cnt"));
  end;

  sqlquery ="select t_dealid as id "+ sqltmpl; 
  sql = ExecSQLSelect(sqlquery, null, false);

  InitProgress(count,"Подождите...", "Формирование отчетов по сделкам МБК");
  i = 0;
  while (sql.Movenext())
    Print_115fz(sql.value("id"), true, i, RepOperName, RepOperPost, RepBossName);
    i = i + 1;
    UseProgress(i);
  end;
  RemProgress(i);
  msgbox("Формирование отчетов завершено!");
  return 1;
end;






