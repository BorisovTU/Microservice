
IMPORT globals,OprInter,"cb_sql.mac",funk,mmcarry,mmcnst_j,mmlibr,dl_plib,dl_lib,dl_plat,dl_platv;

 private var nPaymentID,d1,soob,chpog,NDOG;
 private var newdata,que,rs,rs0,rs1,ss,debet,vkom,credit,CRE,dsob,d0,ss1,s1,np,j,i,ku,curdate,
 SumComm,SumComm2,CurComm,Document1,ss0,prol,ss01,debet3,credit3,credit2,debet2,dbcr,plid,plid2 ;
 private array mas;
 var  at = MM_Carry;
 private var sta,pu,dpl,is,ddata,pld00,nsum,nsum2,{curdate},j9,stnal,nalog,tek_ost,sup,gensog,rs01,nbank,sclient,snalog;


record deal (dl_tick);
record leg (dl_leg);


MACRO Ex (dealid, daz,pa3)
   private var samount,nrate;

   soob=" ";
   pld00=daz;
   ddata= СДАТ(pld00);
   dpl="11";
   InitProgress( 100, "Платежи по погашению МБК " );  
   j9=10;
   que = "select b.t_dealid,a.t_purpose,a.t_baseamount,a.t_paymentid,a.t_valuedate from dpmpaym_dbt a, ddl_tick_dbt b, ddl_leg_dbt u where  b.t_dealid="+dealid+" and  a.t_valuedate >= '"+ddata+"'  and a.t_dockind=102 and a.t_purpose = "+pa3+" and  a.t_paymstatus != 55  and  a.t_paymstatus <  32000  and  b.t_dealid=a.t_documentid   and u.t_dealid=b.t_dealid  order by a.t_purpose, a.t_valuedate "; //MAA: из-за условия "a.t_valuedate >= '+ddata+'" отбирается более одного платежа
 //  msgbox(que);
 rs0 = LnGetRecordset(que);

 if (rs0 != null)
  if (rs0.moveNext()) //MAA: из-за условия "a.t_valuedate >= '+ddata+'" в запросе выше отбирается более одного платежа, что приводит к формированию двух проводок, поэтому меняем while на if.
// -------------

      ss=string(rs0.value("t_dealid"));
      que = "select *  from ddl_tick_dbt  where t_dealid = "+ss; 
      rs1 = LnGetRecordset(que);
      if (rs1 != null)
        while (rs1.moveNext())
            CopyRSetToFBuff( deal, rs1 ) ;
            j9=j9+10;
            useprogress(j9);
            message("МИНУТОЧКУ !! ИДЕТ РАСЧЕТ !");
            que = "select *  from ddl_leg_dbt  where t_dealid = "+ss; 
            rs = LnGetRecordset(que);
            if (rs != null)
               if (rs.moveNext)
                  CopyRSetToFBuff( leg, rs );
                  nPaymentID=rs0.value("t_paymentid"); 
                  pu=rs0.value("t_purpose");
                  // ndog=Кред_договор(rs.value("t_dealid"));
                  ndog="!!!";
                  sup=rs0.value("t_baseamount");
                  gensog=" ";

                  que = string("select b.t_code,to_char(b.t_startdate,'DD.MM.YYYY'), ga.t_outpmtmin1 "
                              ,"from ddl_tick_dbt a, ddl_genagrview_dbt b, ddl_genagr_dbt ga "
                              ," where a.t_dealid="+deal.dealid+" and b.t_genagrid=a.t_genagrid and a.t_genagrid = ga.t_genagrid");

                  rs01 = LnGetRecordset(que);
                  if (rs01 != null)
                    if (rs01.moveNext)
                     gensog=" № "+rs01.value(0)+" от "+rs01.value(1);
                     if(rs01.value("t_outpmtmin1") == "X") // настройка "платеж Т-1" в ГС
                       ddata = СДАТ(rs0.value("t_valuedate"));
                     end;
                    end;
                  end;
                  d0=leg.start;
                  d1=leg.maturity;
                  CurComm=leg.pfi;
                  // SumComm2=leg.cost;
                  // SumComm=leg.principal;

                  SumComm=plat_dil0(deal.dealid,"102","10",ddata,"baseamount");
                  nbank=plat_dil(deal.dealid,"102","10","payerbankid");
                  ss0=" ";
                  ku=double("1"+substr("0000000000",1,leg.point));
                  d1=date(dpl);


                               if  ((pu == 10 ) and  (pa3 == 10 ) )

                plid=nPaymentID;
                ss0=MM_ground(deal.dealid,10);

                // "Выплата основного долга по сделке "+deal.dealcode+" от "+СДАТ(deal.dealdate) ;
                //SVE 500951 для нерезидентов формируется основание платежа на английском языке
                if ( IsNotResident(deal.partyid) )
                  opmpr(plid, deal.dealid, 10);
                elif ( strlen(gensog) > 2 )
                  ss0=ss0+" по дог. о предоставлении кредита "+gensog;
                end;
                credit=plat_dil(deal.dealid,"102","10","receiveraccount");
                if ( deal.dealtype == 12301 )
                  Debet=ПРИКРЕПИТЬ2("ОДОВ",deal.dealid);
                elif ((deal.dealtype == 12335) or (deal.dealtype == 12310))  /*SVE 528366 04.06.2021 Не было учтено что сделки ТФ используют другую КУ для учета долга*/
                  Debet = ПРИКРЕПИТЬ2("ОДТФ", deal.dealid);
                  if ( trim(Debet) == "" )                                   /* MAA: iS - 533702. Если по КУ "ОДТФ" не найдено, тогда ищем по КУ "ОД" */
                    Debet=ПРИКРЕПИТЬ2("ОД",deal.dealid);
                  end;
                else
                 Debet=ПРИКРЕПИТЬ2("ОД",deal.dealid);
                end;

                if ( (( substr(credit,1,5) == "30109") or  ( substr(credit,1,5) == "30111")) and  (nbank < 2 ))
                  credit=plat_dil(deal.dealid,"102","10","futurereceiveraccount");
                else
	          credit=account_corr(CurComm,nbank);
	        end;

                if (strlen(credit) == 1) 
                  credit=plat_dil(deal.dealid,"102","10","futurereceiveraccount");
                elif (credit == "0") 
                  credit=plat_dil(deal.dealid,"102","10","futurereceiveraccount");
                end;

                if((CheckIsDealTminus1_ByDealID(deal.dealid))  and (GetDateAfterWorkDays( date(rs.value("t_maturity")),  -1) == {curdate}) )   //dan для ГС Т-1
                  at.Date_Carry = date(rs.value("t_maturity"));
                end;


        	at.AccountPayer    = debet;	  
        	at.AccountReceiver = credit;
        	at.FIIDPayer      = CurComm;
        	at.FIIDReceiver   = CurComm;
                at.SumPayer       = SumComm;
        	at.SumReceiver    = SumComm;
        	at.Chapter        = 1;
        	at.Ground         = ss0;
        	at.PaymentID      = plid;
        	if(not at.carry())
           		msgbox("Error !");
           		return false;
        	end;

                               elif  ((pu == 72 ) and  (pa3 == 72 ) )

                plid=nPaymentID;

                SumComm=plat_dil0(deal.dealid,"102","72",ddata,"baseamount");
                ss0=MM_ground(deal.dealid,572);

                credit=plat_dil(deal.dealid,"102","72","receiveraccount");
                  Debet=plat_dil(deal.dealid,"102","72","payeraccount");

                if ( (( substr(credit,1,5) == "30109") or  ( substr(credit,1,5) == "30111")) and  (nbank < 2 ))
                  credit=plat_dil(deal.dealid,"102","72","futurereceiveraccount");
                else
	          credit=account_corr(CurComm,nbank);
	        end;

                if (strlen(credit) == 1) 
                  credit=plat_dil(deal.dealid,"102","72","futurereceiveraccount");
                elif (credit == "0") 
                  credit=plat_dil(deal.dealid,"102","72","futurereceiveraccount");
                end;

 

        	at.AccountPayer    = debet;	  
        	at.AccountReceiver = credit;
        	at.FIIDPayer      = CurComm;
        	at.FIIDReceiver   = CurComm;
                at.SumPayer       = SumComm;
        	at.SumReceiver    = SumComm;
        	at.Chapter        = 1;
        	at.Ground         = ss0;
        	at.PaymentID      = plid;
        	if(not at.carry())
           		msgbox("Error !");
           		return false;
        	end;




                               elif  ((pu == 11 ) and  (pa3 == 11 ) )


                plid2=nPaymentID;
                ss0="Погашение процентов по сделке "+deal.dealcode+" от "+СДАТ(deal.dealdate) ;
                if ( strlen(gensog) > 2 ) 
                  ss0=ss0+" по дог. о предоставлении кредита "+gensog;
                end;
                credit=plat_dil(deal.dealid,"102","11","receiveraccount");
                Debet=ПРИКРЕПИТЬ2("-% к погашению",deal.dealid);




               SumComm2=plat_dil0(deal.dealid,"102","11",ddata,"baseamount");
               sclient=MM_tickid(deal.dealid,"partyid");
               snalog=MM_nalog(sclient);

               if (snalog > 0 )
                 SumComm=(SumComm2*snalog/100);
                 SumComm2=SumComm2-(SumComm2*snalog/100);
                 credit=ПРИКРЕПИТЬ2("СЧЕТ_603",deal.dealid);
                 if (credit == "0")
                   credit=plat_dil(deal.dealid,"102","11","futurereceiveraccount");
                 end;


                 if (0 != Получить_Курс0(nrate, CurComm, daz))
                     Msgbox("Не возможно получить курс за ", {curdate});
                     return 1;
                 end;
                 samount= money(SumComm*nrate);


        	 at.AccountPayer    = debet; 	  
        	 at.AccountReceiver = credit;
        	 at.FIIDPayer      = CurComm;
        	 at.FIIDReceiver   = 0;
        	 at.SumPayer       = SumComm;
        	 at.SumReceiver    = samount;

        	 at.Chapter        = 1;
        	 at.Ground         = "Налог. "+ss0;
        	 at.PaymentID      = plid;
        	 if(not at.carry())
           		msgbox("Error !");
           		return false;
        	 end;
               end;





               SumComm2=plat_dil0(deal.dealid,"102","11",ddata,"baseamount");

               sclient=MM_tickid(pmpaymm.documentid,"partyid");
               snalog=MM_nalog(sclient);
               if (snalog > 0 )
                SumComm2=SumComm2-(SumComm2*snalog/100);
               end;


	        credit=account_corr(CurComm,nbank);
        	at.AccountPayer    = debet;	  
        	at.AccountReceiver = credit;
        	at.FIIDPayer      = CurComm;
        	at.FIIDReceiver   = CurComm;
        	at.SumPayer       = SumComm2;
        	at.SumReceiver    = SumComm2;

        	at.Chapter        = 1;
        	at.Ground         = ss0;
        	at.PaymentID      = plid;
        	if(not at.carry())
           		msgbox("Error !");
           		return false;
        	end;


                                  end;
               end;
            end;

      end;
   end;

// ---------

  end;
 end;

   RemProgress; 

   return 0;
END;


MACRO Ex2 (dealid, daz)

   private var samount,nrate,sta0;

   soob=" ";
   pld00=daz;
   ddata= СДАТ(pld00);
   dpl="11";
   j9=10;


 que = "select b.t_dealid,a.t_purpose,a.t_baseamount,a.t_paymentid from dpmpaym_dbt a, ddl_tick_dbt b  where  b.t_dealid="+dealid+" and  a.t_valuedate = '"+ddata+"'  and a.t_dockind=102 and  a.t_purpose > 9   and  b.t_dealid=a.t_documentid  order by  a.t_purpose ";
 rs0 = LnGetRecordset(que);
 if (rs0 != null)
  while (rs0.moveNext())
// -------------

      ss=string(rs0.value("t_dealid"));
      que = "select *  from ddl_tick_dbt  where t_dealid = "+ss; 
      rs1 = LnGetRecordset(que);
      if (rs1 != null)
        while (rs1.moveNext())
            CopyRSetToFBuff( deal, rs1 ) ;
            j9=j9+10;
            message("МИНУТОЧКУ !! ИДЕТ РАСЧЕТ !");
            que = "select *  from ddl_leg_dbt  where t_dealid = "+ss; 
            rs = LnGetRecordset(que);
            if (rs != null)
               if (rs.moveNext)
                  CopyRSetToFBuff( leg, rs );
                  nPaymentID=rs0.value("t_paymentid"); 
                  pu=rs0.value("t_purpose");
                  // ndog=Кред_договор(rs.value("t_dealid"));
                  ndog="!!!";
                  sup=rs0.value("t_baseamount");

                  gensog=" ";
                  que = "select b.t_code,to_char(b.t_startdate,'DD.MM.YYYY') from ddl_tick_dbt a, ddl_genagrview_dbt b  where a.t_dealid="+deal.dealid+" and b.t_genagrid=a.t_genagrid ";
                  rs01 = LnGetRecordset(que);
                  if (rs01 != null)
                    if (rs01.moveNext)
                     gensog=" № "+rs01.value(0)+" от "+rs01.value(1);
                    end;
                  end;
                  d0=leg.start;
                  d1=leg.maturity;
                  CurComm=leg.pfi;

                  nbank=plat_zak(deal.dealid,"102","10",0,"receiverbankid");
                  credit=account_corr(CurComm,nbank);


                  if  (substr(credit,1,5) != "30111" )
                      sta=plat_zak(deal.dealid,"102","10",0,"paymstatus");
                      sta0=sta;
                     if (( sta != 32000 ) and ( sta != 55 ))
                        msgbox("НЕ сквитован платеж ОД !");
                        return 1;
                     else
 
                       sta=plat_zak(deal.dealid,"102","11",1,"paymstatus");
                       if ( sta != 32000 )
                          msgbox("НЕ сквитован платеж %% !");
                          return 1;
                       end;

                     end;

                     return 0;
                  end;



                  SumComm=plat_dil0(deal.dealid,"102","10",ddata,"baseamount");
                  ss0=" ";
                  ku=double("1"+substr("0000000000",1,leg.point));
                  d1=date(dpl);


                               if  (pu == 10 )

                                            if (sta0 != 55 )

                plid=nPaymentID;
                ss0="Выплата основного долга по сделке "+deal.dealcode+" от "+СДАТ(deal.dealdate) ;
                if ( strlen(gensog) > 2 ) 
                  ss0=ss0+" по дог. о предоставлении кредита "+gensog;
                end;
                Debet=ПРИКРЕПИТЬ2("ОД",deal.dealid);

        	at.AccountPayer    = credit;	  
        	at.AccountReceiver = debet;
        	at.FIIDPayer      = CurComm;
        	at.FIIDReceiver   = CurComm;
                at.SumPayer       = SumComm;
        	at.SumReceiver    = SumComm;
        	at.Chapter        = 1;
        	at.Ground         = ss0;
        	at.PaymentID      = plid;
        	if(not at.carry())
           		msgbox("Error !");
           		return false;
        	end;



               if(not InsertPaymentStat (plid, PM_FINISHED))
                  MsgBox("Ошибка установки статуса платежа - Закрыт.");
               end;
                                            end;

                                elif  (pu == 11 )
                plid2=nPaymentID;
                ss0="Погашение процентов по сделке "+deal.dealcode+" от "+СДАТ(deal.dealdate) ;
                if ( strlen(gensog) > 2 ) 
                  ss0=ss0+" по дог. о предоставлении кредита "+gensog;
                end;



               SumComm2=plat_dil0(deal.dealid,"102","11",ddata,"baseamount");
               sclient=MM_tickid(deal.dealid,"partyid");
               snalog=MM_nalog(sclient);

               if (snalog > 0 )
                 SumComm=(SumComm2*snalog/100);
                 SumComm2=SumComm2-(SumComm2*snalog/100);
                 Debet=ПРИКРЕПИТЬ2("СЧЕТ_603",deal.dealid);
                 if (0 != Получить_Курс0(nrate, CurComm, daz))
                     Msgbox("Не возможно получить курс за ", {curdate});
                     return 1;
                 end;
                 samount= money(SumComm*nrate);


        	 at.AccountPayer    = credit;	  
        	 at.AccountReceiver = debet;
        	 at.FIIDPayer      = CurComm;
        	 at.FIIDReceiver   = 0;
        	 at.SumPayer       = SumComm;
        	 at.SumReceiver    = samount;

        	 at.Chapter        = 1;
        	 at.Ground         = "Налог. "+ss0;
        	 at.PaymentID      = plid;
        	 if(not at.carry())
           		msgbox("Error !");
           		return false;
        	 end;
               end;

                Debet=ПРИКРЕПИТЬ2("+% к погашению",deal.dealid);

        	at.AccountPayer    = credit;	  
        	at.AccountReceiver = debet;
        	at.FIIDPayer      = CurComm;
        	at.FIIDReceiver   = CurComm;
        	at.SumPayer       = SumComm2;
        	at.SumReceiver    = SumComm2;

        	at.Chapter        = 1;
        	at.Ground         = ss0;
        	at.PaymentID      = plid;
        	if(not at.carry())
           		msgbox("Error !");
           		return false;
        	end;

                if(not InsertPaymentStat (plid2, PM_FINISHED))
                   MsgBox("Ошибка установки статуса платежа - Закрыт.");
                end;

                                  end;
               end;
            end;

      end;
   end;

// ---------

  end;
 end;


   return 0;
END;



