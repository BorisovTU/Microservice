import oralib, likepy, globals,fx_globals, CTInter;
IMPORT mmarkinter, OprInter,funk,dl_plib,dl_lib;

   private var que,rs9,ii,{curdate},da,dealid,rs5;
   var docKind=102, sql,nbank,fiid,debet,dealcode,sta;
   var exec, command1, command2, chainblockId,chainblockId0=230500 ;

   da=‘„Ђ’({curdate});
   que=" select a.t_dealid,a.t_dealcode from ddl_tick_dbt a , dpmpaym_dbt b  where a.t_dealtype=12300 and a.t_dealstatus=10 and a.t_dealdate='"+da+"'  and b.t_dockind=102 and b.t_documentid=a.t_dealid and b.t_purpose=9 and b.t_paymstatus < 32000 ";
   rs9 = LnGetRecordSet(que);
   if(rs9 != null)
     while(rs9.moveNext())
       dealid=int(rs9.value(0));
       dealcode=rs9.value(1);

       nbank=plat_dil(dealid,"102","9","receiverbankid");
       fiid=plat_dil(dealid,"102","9","fiid");

       debet=account_corr(fiid,nbank);
       if (substr(debet,1,5) =="30111" )
         que= "select COUNT(*) from ddl_tick_dbt c, doproper_dbt aa , doprstep_dbt bb ,doprostep_dbt cc where c.t_dealid="+dealid+" and  aa.t_dockind=102 and aa.t_DocumentID=lpad(c.t_dealid,34,'0') ";
         que=que+" and bb.t_id_operation=aa.t_id_operation and t_isexecute='X' and cc.t_blockid=bb.t_blockid and cc.t_number_step=bb.t_number_step and cc.t_symbOl='D'";
         rs5 = LnGetRecordSet(que);
         if(rs5 != null)
            if (rs5.moveNext) 
               if (rs5.value(0) > 0 )
  // ---  Блок вставки цепочки -------------------
  sql = "select s.t_id_operation, s.t_id_step, s.t_blockid, s.t_kind_operation, s.t_IsExecute from " 
  + " doproper_dbt o "
  + " inner join doprstep_dbt s on s.t_id_operation=o.t_id_operation and s.t_id_step = (select t_id_step from doprstep_dbt where t_id_operation = s.t_id_operation  and t_isexecute ='R'  )"
  + " where o.t_dockind = :dockind and o.t_documentid = lpad(:dealid, 34, '0')";
  chainblockId = 20000130;
  sql = ExecSqlSelect(sql, MakeArray(SqlParam("dockind", dockind), SqlParam("dealid", dealid)), false);     
  if(not sql.MoveNext())
    MsgBox("Ошибка поиcка сделки для закрытия неттинга id = "+dealid);

    return false;
  end;
  ii=int(sql.value("t_id_step"));
  

  command1 = "BEGIN :res := RSI_RsbOperation.InsertBranchTrn(:step, "+int(sql.value("t_id_operation"))+", "
  +ii+",'I', "+chainblockId+", 315, :dt, 0, 0); END;";
  exec = ExecSql(command1, MakeArray(SqlParam ("res",  V_INTEGER, RSDBP_RETVAL), 
                                     SqlParam ("step", V_INTEGER, RSDBP_RETVAL), 
                                     SqlParam ("dt", {curdate})), false);

  if(exec == null)
    MsgBox("Ошибка вставки цепочки ");
    return false;
  end;

  if(exec.value("res") != 0)
    MsgBox("Процедура вставки цепочки вернула ошибку, для документа id="+dealid);
    return false;
  end;
  // ----------------------------------------------

               end;
            end;
        end;
      end;

     end;
   end;

 end;


