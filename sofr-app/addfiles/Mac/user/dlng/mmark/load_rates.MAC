 /*------------------------------------------------------------*/
/* Адаптеры для загрузки котировок                            */
/*                                                            */
/* Автор: TEG                                                 */
/*                                                            */
/*------------------------------------------------------------*/
import BankInter, globals, ws_imprates,rsexts, rsd;


var ExcelApplication, startAX, ExcelDoc, ActiveSheet, isOpen = false;

// класс результата по одной записи
private class c_DealParm_resp()
   var ExternalId : String; // Уникальный идентификатор счета во внешней системе
   var DealId     : String; // Внутренний идентификатор проводки

   var ResultCode : String; // Результат обработки входного запроса по счету. Справочник (Код)
   var ResultText : String; // Результат обработки входного запроса по счету. Текст
end;

// класс результата по одной записи
private class c_RatesParm_resp()
   var RatesId     : String; // Внутренний идентификатор индекса
   var ResultCode : String; // Результат обработки входного запроса по индексу. (Код)
   var ResultText : String; // Результат обработки входного запроса по индексу. Текст
end;

private macro uTryToGetPropS2(ImportFilePath, propName:string)
   var ret = NULL;
   var i = 1;


   if (propName == "!quit!")
      ExcelApplication.Quit();
      return;
   end;

   if (not isOpen)
      /*
      if (isStandAlone())
         ExcelApplication = ActiveX("Excel.Application", null, true);
      else
         if (startAX == null)
            startAX = CreateObject("rsax", "TRsAxServer", "FmAxServer", isStandalone());
         end;
         ExcelApplication = startAX.CreateComObject("Excel.Application");
      end;
      */
      ExcelApplication = CreateObject ("rsax", "TRsAxServer", "RsBankAxServer", isStandAlone ()).CreateComObject ("Excel.Application");
      ExcelDoc = ExcelApplication.Workbooks.Open(ImportFilePath);
      ExcelDoc.Sheets(1).Activate();
      ActiveSheet = ExcelApplication.ActiveSheet;
      isOpen = true;
   end;

   if ( isOpen )
      while (i <= ActiveSheet.UsedRange.Rows.Count)
//         if (index(strupr(ActiveSheet.Cells(i, 3).Value), strupr(propName)) > 0)
         if (ActiveSheet.Cells(i, 3).Value == propName)
//            Ret = ActiveSheet.Cells(i, 2).Value;
            Ret = ActiveSheet.Cells(i, 2).Text;
            i = ActiveSheet.UsedRange.Rows.Count;
         end;
         i = i + 1;
      end;
   end;

   return ret;

   onError
      return NULL
end;

private macro FormatDate(params)
   Private var newdata;
   Private var pParam=trim(params);
   if (strlen(pParam) > 1 ) 
      newdata=substr(params,1,2)+"."+substr(pParam,4,2)+"."+substr(pParam,7,4);
   else
      newdata=params;
   end;
   return newdata;
End;

private macro Codeparty(par1,par2)
   var nrez="",rs50,que;
   que="SELECT nvl(sum(t_objectid),0) FROM dobjcode_dbt where t_code='"+par1+"' and t_codekind="+par2;

   nrez = (-1);
   rs50 = LnGetRecordset(que);
   if (rs50 != null)
      if (rs50.moveNext) 
          nrez=int(rs50.value(0));
      end;
   end;

   return(nrez);
end;

macro ProcessRates(p_req_data_obj)
   var ResultAction = c_RatesParm_resp;
   
   private var resp_resultCode = 0, resp_resultText = "";
   private var resp_RatesId = 0;
   private var err_txt = "";

   var stat;
   var str, que, rs1, rs0,vari;
   var acc = tarray;
   var ob = TRecHandler ("rates", MakeArRates());

   ob.rec.IDRATE=0;
   ob.rec.DATERATE = uTryToGetPropS2(p_req_data_obj, "Date"); //0
   if (strlen(ob.rec.DATERATE) == 8 )
      ob.rec.DATERATE  = FormatDate(ob.rec.DATERATE);
   end;
   ob.rec.PREVDATERATE="";
   ob.rec.CODEFI=uTryToGetPropS2(p_req_data_obj, ":/Basefiid"); //1
   ob.rec.CODE=uTryToGetPropS2(p_req_data_obj, ":/Otherfiid"); //2
   ob.rec.SECTION=uTryToGetPropS2(p_req_data_obj, ":/Section"); //3
   ob.rec.RATE=uTryToGetPropS2(p_req_data_obj, ":/Rate"); //4;
   ob.rec.PREVRATE="0";//Предыдущая величина индекса
   ob.rec.SCALE=int(uTryToGetPropS2(p_req_data_obj, ":/Scale")); //5;
   ob.rec.POINT=int(uTryToGetPropS2(p_req_data_obj, ":/Point")); //6;
   ob.rec.ISDOMINANT=uTryToGetPropS2(p_req_data_obj, ":/IsDominant"); //7;
   ob.rec.RESCOMMENT="";

   //Проверка на существование финиструмента
   que = "select nvl((SELECT t_fiid FROM dfininstr_dbt i  WHERE i.t_fi_kind=3 AND trim(i.t_fi_code)='"+trim(ob.rec.CODEFI)+"'),0) from DUAL";
   rs0 = LnGetRecordset(que);
   if(rs0 != null)
      if (rs0.moveNext) 
         if ( rs0.value(0) == 0 )
               err_txt="Не найден финансовый инструмент "+trim(ob.rec.CODEFI)+" !";
               ob.rec.NEEDACTION=0; 
         else 
               ob.rec.IDFI=rs0.value(0);
               ob.rec.NEEDACTION=1;
         end;
      end;
   end;
   //Проверка на существование ставки
  if (ob.rec.NEEDACTION==1)
     que = "SELECT NVL((SELECT r.t_rateid FROM dfininstr_dbt i ,dratedef_dbt r WHERE r.t_otherfi=i.t_fiid "
           +" AND i.t_fi_kind=3 AND trim(i.t_fi_code)='"+trim(ob.rec.CODEFI)+"'),0) FROM DUAL";
   rs0 = LnGetRecordset(que);
   if(rs0 != null)
      if (rs0.moveNext) 
         if ( rs0.value(0) == 0 )
               err_txt="Не установлен первоначальный индекс для финансового инструмента "+trim(ob.rec.CODEFI)+" !";
               ob.rec.NEEDACTION=0; 
         else 
               ob.rec.NEEDACTION=1;
               ob.rec.IDRATE=rs0.value(0);//сохраним айдишник
         end;
      end;
   end;
  
  end;

  //Проверка на наличие ставки на загружаемый день 
  if (ob.rec.NEEDACTION==1)
   que = "SELECT COUNT(*) FROM dfininstr_dbt i ,dratedef_dbt r WHERE r.t_otherfi=i.t_fiid "
         +"AND i.t_fi_kind=3 AND trim(i.t_fi_code)='"+trim(ob.rec.CODEFI)+"' AND r.t_sincedate= to_date('"+ob.rec.DATERATE+"','dd.mm.yyyy') ";
   rs0 = LnGetRecordset(que);
   if(rs0 != null)
      if (rs0.moveNext) 
         if ( rs0.value(0) > 0 )
               err_txt="Индекс "+trim(ob.rec.CODEFI)+" за "+ob.rec.DATERATE+" уже существует!";
               ob.rec.NEEDACTION=0; 
         else 
               ob.rec.NEEDACTION=1;
         end;
      end;
   end;
  end;

   uTryToGetPropS2(p_req_data_obj, "!quit!");
   
   if (err_txt == "")
      //resp_resultText= "До вызова класса obRate.rec.PREVRATE="+ob.rec.PREVRATE;
      if (_LoadRates_CreateNew(ob) == 1)
             err_txt="Ошибка загрузки индекса!";
      end;
   end;

   /* Получаем объектный вид ответа */
   
   ResultAction.RatesId = resp_RatesId;     
   ResultAction.ResultCode = resp_resultCode;
   ResultAction.ResultText = resp_resultText;//+" после вызова "+ob.rec.PREVRATE; ;//resp_resultText;
   
   if (err_txt != "")
       ResultAction.ResultText = err_txt;
   end;
//доп информация
   if (ob.rec.RESCOMMENT != "")
       ResultAction.ResultText = ResultAction.ResultText+" ReturnRes "+ob.rec.RESCOMMENT;
   end;

   return ResultAction;
      
onError(err)
   /* Получаем объектный вид ответа */
  // ResultAction.ExternalId = ExternalId;
   ResultAction.RatesId = 0;
   ResultAction.ResultText = err.Message;
   ResultAction.ResultCode = 0; //err.Code;
   
   return ResultAction;
end;

/*---------------- Main -----------------------*/
var ResAct;
//ResAct = ProcessRates("v:\\RSBank\\Ebankru1203\\Mac.usr\\DLNG\\mmark\\dop\\222\\xls\\file30.xlsx");
//ResAct = ProcessRates("\\\\TST-SOFR-AP01\\RsBank\\import\\111.xlsx");
ResAct = ProcessRates("d:\\RsBank\\import\\111.xls");

println( ResAct.ResultText );

