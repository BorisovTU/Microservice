//-----------------------------------------------------------------------------------------
// Формирование Платежа в Бухгалтерии Банка 
//-----------------------------------------------------------------------------------------
//import dealInfo, oralib, likepy,dopground;
import  oralib, likepy,dopground;

import BankInter, PaymInter;

private macro MaxPriority():Integer
  var maxPriority:Integer = 6, err, TypeVal;
  TypeVal = GetRegistryValue( "CB\\PAYMENTS\\MAXPRIORITY", V_INTEGER, maxPriority, err );
  if( ( TypeVal == V_UNDEF ) OR ( err != 0 ) )
    return 6;
  end;
  return maxPriority;
end;

private macro GetOrigin()
  if(StrFor(GetIdentProgram())   == "J") //Происхождение подсистема МБК
    return 1001;
  elif(StrFor(GetIdentProgram()) == "V") //Происхождение подсистема Конверсионные операции
    return 1002;
  else
//    MsgBox("Внимание неизвестное происхождение документа-", StrFor(GetIdentProgram()));
    return 1001; //Вернем МБК по умолчанию, чтобы документ был виден в скроллингах
  end;
end;

private macro FindBankID( StartDepartment );
   var select:string = " select t_PartyID "
                       " from ddp_dep_dbt "
                       " where t_Code = :StartDepartment ";

   var params:TArray = MakeArray(SQLParam( "StartDepartment", StartDepartment ));   
   var rset:RsdRecordset = ExecSQLselect( select, params, TRUE );
 
   if( rset and rset.moveNext() )
      return rset.value(0);
   end;     

   return 0;  
end;
/*
private macro Наименование(Имя, Счет, Банк);
   return string( Substr(Имя, 1, 160), " р/сч. ", 
                  Substr(Счет,1, 20), " в ", 
                  Substr(Банк,1, 160) ); 
end;
*/

private macro needUseKZpm():Bool
  var err:Integer = 0;
  var locale:String = "";
  GetRegistryValue("CB\\PAYMENTS\\PANEL\\LOCALE", V_STRING, locale, err);
  return ( ( err == 0 ) AND ( Index( StrUpr(locale), "KZ" ) ) );
end; 


//
// Формирование валютного платежа
//
macro InsertCPBankPayment_alt(pmpaym, pmrmprop, pmpropDebet, pmpropCredit, cpOrder, DealID, purpos, IDPaym):Bool 
  var Payment:RsbPayment; // платеж 
  var BankPayment:object; // первичный документ
  var Name;
  var PayerBankID, ReceiverBankID;
  record CorsIn(corschem);
  var stat = 0, sql,{SelfId};

  BankPayment            = GenObject( "RsbBbCpOrder", 0 );
  Payment                = BankPayment.Payment();

  BankPayment.Origin       = GetOrigin();
  BankPayment.Oper         = {oper}; 
  BankPayment.CurrentState = 0;
  Payment.DocKind          = pmpaym.docKind;
  Payment.Purpose     = pmpaym.purpose;
  Payment.Origin      = 7; 
  Payment.IsPlanPaym  = "X";
  Payment.PrimDocKind = 0; //должен быть всегда для платежей Dealing-а = 0
//  Payment.Number      = PaymentObj.Number;
  Payment.Number      = pmrmprop.Number;
  Payment.Priority    = MaxPriority();
  Payment.PaymentKind = "Э";
  Payment.ShifrOper   = pmrmprop.shifrOper;
  Payment.PayDate     =
  Payment.ClientDate  = 
  Payment.Date        =
  Payment.ValueDate   = pmpaym.ValueDate;
 
  Payment.AdditionalInfo = pmrmprop.Ground;
  Payment.NumberPack     = pmpaym.NumberPack;
  Payment.payerDpNode    = pmpaym.payerDpNode;
  Payment.receiverDpNode = pmpaym.receiverDpNode;


  // Сдвижка счетов
  pmpaym.ReceiverAccount = pmpropCredit.CorrAcc;
  pmpropCredit.CorrAcc   = pmrmprop.ReceiverCorrAccNostro;
 

  if(pmpropCredit.CorrAcc != "")
     sql = "INSERT INTO HBUSER_DDLPROP_DBT ( T_DEALID, T_PURPOSE, T_RCORRACC, T_FIID) "
           "VALUES ( :1, :2, nvl(:3, chr(1)), :4)";
     sql = ExecSQL(sql, MakeArray(
                                  SQLParam("1", pmpaym.receiverDpNode), 
                                  SQLParam("2", pmpaym.payerDpNode), 
                                  SQLParam("3", pmpropCredit.CorrAcc),
                                  SQLParam("4", pmpaym.BaseFIID)
                                 ), true);
     if(sql = null)
        MsgBox("Ошибка формирования валютного платежа");
        return false;
     end;
  end;

  pmpropDebet.CorrAcc    = "";
  pmpropCredit.CorrAcc   = "";


    Payment.BaseFIID       = pmpaym.BaseFIID;
    Payment.PayerFIID      = pmpaym.BaseFIID;
    Payment.ReceiverFIID   = pmpaym.BaseFIID;
    Payment.FutureReceiverFiid = pmpaym.BaseFIID;
    Payment.FuturePayerFiid    = pmpaym.BaseFIID;
    Payment.BaseAmount     = money(round(pmpaym.BaseAmount, 2));  
    Payment.PayerAmount    = money(round(pmpaym.BaseAmount, 2));
    Payment.ReceiverAmount = money(round(pmpaym.BaseAmount, 2));

    Payment.ReceiverBankCorrCodeKind = pmpropCredit.CORRCODEKIND; 
    Payment.ReceiverBankCorrCode     = pmpropCredit.CORRCODE; 
    if(trim(pmrmprop.receiverCorrBankName) != "")
      Payment.ReceiverBankCorrName   = pmrmprop.receiverCorrBankName;
      Payment.ReceiverCorrAccNostro  = pmrmprop.ReceiverCorrAccNostro;
    end;
 
 
    Payment.SetReceiverPI( PAYMENTS_GROUP_UNDEF, 
                           pmpaym.ReceiverBankID, 
                           pmpropCredit.CodeKind,
                           pmpropCredit.BankCode,
                           pmrmprop.ReceiverBankName,
                           pmpropCredit.CorrAcc,
                           pmpaym.baseFiid, 
                           1/*CHAPT1*/, 
                           pmpaym.ReceiverAccount, 
                           pmpaym.Receiver, 
                           pmrmprop.ReceiverName , 
                           pmrmprop.ReceiverINN, 
                           pmpaym.ReceiverCodeKind,
                           pmpaym.ReceiverCode);

    Payment.SetPayerPI(  PAYMENTS_GROUP_UNDEF, 
                         {SelfId}/*pmpaym.PayerBankID*/,   
                         6/*pmpropDebet.CodeKind*/, 
                         ""/*pmpropDebet.BankCode*/, 
                         ""/*pmrmprop.PayerBankName*/,
                         pmpropDebet.CorrAcc,
                         pmpaym.baseFiid, 
                         1/*CHAPT1*/, 
                         pmpaym.PayerAccount, 
                         pmpaym.Payer, 
                         pmrmprop.PayerName, 
                         pmrmprop.PayerINN,
                         pmpaym.PayerCodeKind,
                         pmpaym.PayerCode );
 
  Payment.OutTransferDate  = pmpaym.ValueDate;

  array FlgRM, FlgCP, FlgKZRM, FlgKZCP;
  FlgRM[PNRMPM_COUNT]      = 0;
  FlgKZRM[KZPNRMPM_COUNT]  = 0;
  FlgCP[PNCPPM_COUNT]      = 0;
  FlgKZCP[KZ_PNCPPM_COUNT] = 0;


  // R-maket
  FlgRM[ PNRMPM_SUM       ] = 1;
  FlgRM[ PNRMPM_ACCOUNTR  ] = 1;
  FlgRM[ PNRMPM_CODEKINDR ] = 1;
  FlgRM[ PNRMPM_CODEKIND2R] = 1;
  FlgRM[ PNRMPM_CODER     ] = 1;
  FlgRM[ PNRMPM_BANKACCR  ] = 1;
  // Swift
  // FlgCP[ PNCPPM_PAYAMOUNT ] = 1;
  FlgCP[ PNCPPM_PAYFIID   ] = 1;
  FlgCP[ PNCPPM_ACCOUNTP  ] = 1;
  FlgCP[ PNCPPM_CODEKINDR ] = 1;
  FlgCP[ PNCPPM_CODEKINDR2] = 1;
  FlgCP[ PNCPPM_CODER     ] = 1;
  FlgCP[ PNCPPM_ACCOUNTR  ] = 1;
  //R-Maket
  FlgKZRM[ KZPNRMPM_KINDCODE_RECEIVER ] = 1;
  FlgKZRM[ KZPNRMPM_CODE_RECEIVER     ] = 1;
  FlgKZRM[ KZPNRMPM_RecieverCode      ] = 1;
  FlgKZRM[ KZPNRMPM_IIK_RECEIVER      ] = 1;
  //swift
  FlgKZCP[ KZ_PNCPPM_FI_Code  ] = 1;
  FlgKZCP[ KZ_PNCPPM_Amount   ] = 1;
  FlgKZCP[ KZ_PNCPPM_CodeKind ] = 1;
  FlgKZCP[ KZ_PNCPPM_BankCode ] = 1;
  FlgKZCP[ KZ_PNCPPM_ReceiverCodeKind] = 1;
  FlgKZCP[ KZ_PNCPPM_ReceiverCode    ] = 1;
  FlgKZCP[ KZ_PNCPPM_ReceiverAccount ] = 1;

 
  if( not needUseKZpm() )
//    stat = PM_ProcessPanel( Payment, 0, NULL, FlgRM, FlgCP );
    stat = PM_ProcessPanel(Payment, 0, NULL, FlgRM, FlgCP, null, null, null, null, null, null, null, null, 4);
  else
    stat = PM_ProcessPanel( Payment, 0, NULL, FlgKZRM, FlgKZCP );
  end;

  // Установить признак автозапуска операции.
  BankPayment.LaunchOper = false;//true;

  BankPayment.Notes.AddNote( 300, pmrmprop.Ground, pmpaym.ValueDate);
  // Payment.AdditionalInfo = newground(DealID, purpos, pmpaym.ValueDate); 

  return true;
end;

//
// Формирование рублёвого платежа
//
macro InsertBankPayment_alt(pmpaym, pmrmprop, pmpropDebet, pmpropCredit, IDPaym,flag):Bool 
  var Payment:RsbPayment; // платеж 
  var BankPayment:object; // первичный документ
  var Name;
  var PayerBankID, ReceiverBankID;
  record CorsIn(corschem);
  var sql, stat = 0;

  BankPayment            = GenObject( "RsbBankPayment", 0 );
  Payment                = BankPayment.Payment();
 
  BankPayment.Origin       = GetOrigin();
  BankPayment.Oper         = {oper}; 
  BankPayment.Status       = 1;
  Payment.DocKind          = pmpaym.docKind;

  Payment.Purpose     = pmpaym.purpose;
  Payment.Origin      = 7; 
  Payment.IsPlanPaym  = "X";
  Payment.PrimDocKind = 0; //должен быть всегда для платежей Dealing-а = 0
  Payment.Number      = pmrmprop.Number; //PaymentObj.Number;
  Payment.Priority    = pmrmprop.Priority;
  // MaxPriority();
  Payment.INSTANCY    = pmrmprop.INSTANCY;

  Payment.PaymentKind = "Э";
  Payment.ShifrOper   = pmrmprop.shifrOper;

  Payment.PayDate     =
  Payment.ClientDate  = 
  Payment.Date        =
  Payment.ValueDate   = pmpaym.ValueDate; 
  Payment.Ground      = pmrmprop.Ground;
  Payment.NumberPack  = pmpaym.NumberPack;
  Payment.payerDpNode = pmpaym.payerDpNode;
  Payment.receiverDpNode = pmpaym.receiverDpNode;

// msgbox(pmpaym.Payer, " - ", pmpaym.PayerBankID, " - ", pmpropDebet.CorrAcc, " - ", pmpaym.baseFiid, " - ", pmpaym.PayerAccount, " - ", pmpaym.Payer, " - ", pmrmprop.PayerName, " - ", pmrmprop.PayerINN);
  Payment.BaseFIID       = pmpaym.BaseFIID;
  Payment.PayerFIID      = pmpaym.BaseFIID;
  Payment.ReceiverFIID   = pmpaym.BaseFIID;
  Payment.BaseAmount     = money(round(pmpaym.BaseAmount, 2));  
  Payment.PayerAmount    = money(round(pmpaym.BaseAmount, 2));
  Payment.ReceiverAmount = money(round(pmpaym.BaseAmount, 2));
  

    Payment.SetReceiverPI( PAYMENTS_GROUP_UNDEF, 
                           pmpaym.ReceiverBankID, 
                           pmpropCredit.CodeKind,
                           pmpropCredit.BankCode,
                           pmrmprop.ReceiverBankName,
                           pmpropCredit.CorrAcc,                            
                           pmpaym.baseFiid, 
                           1/*CHAPT1*/, 
                           pmpaym.ReceiverAccount, 
                           pmpaym.Receiver, 
                           pmrmprop.ReceiverName, 
                           pmrmprop.ReceiverINN ,
                         pmpaym.ReceiverCodeKind,
                         pmpaym.ReceiverCode,
                         pmpropCredit.CORSCHEM,1 );


    Payment.SetPayerPI(  PAYMENTS_GROUP_UNDEF, 
                         pmpaym.PayerBankID/* {SelfId} */,
                         pmpropDebet.CodeKind, 
                         pmpropDebet.BankCode, 
                         ""/*pmrmprop.PayerBankName*/,
                         pmpropDebet.CorrAcc,
                         pmpaym.baseFiid, 
                         1/*CHAPT1*/, 
                         pmpaym.PayerAccount, 
                         pmpaym.Payer, /*0 pmpaym.Payer*/ 
                         pmrmprop.PayerName/*""*/, 
                         pmrmprop.PayerINN );

  Payment.PropStatus  = pmpropCredit.propstatus;  
  Payment.OutTpSchem  = pmpropCredit.tpschemid;   
  Payment.OutRlsForm  = pmpropCredit.rlsformid;   
  Payment.OutTransferDate  = pmpaym.ValueDate;
  Payment.OutSubKindMessage = 3;


  array FlgRM, FlgCP, FlgKZRM, FlgKZCP;
  FlgRM[PNRMPM_COUNT]      = 0;
  FlgKZRM[KZPNRMPM_COUNT]  = 0;
  FlgCP[PNCPPM_COUNT]      = 0;
  FlgKZCP[KZ_PNCPPM_COUNT] = 0;


  // R-maket
  FlgRM[ PNRMPM_SUM       ] = 1;
  FlgRM[ PNRMPM_ACCOUNTR  ] = 1;
  FlgRM[ PNRMPM_CODEKINDR ] = 1;
  FlgRM[ PNRMPM_CODEKIND2R] = 1;
  FlgRM[ PNRMPM_CODER     ] = 1;
  FlgRM[ PNRMPM_BANKACCR  ] = 1;
  // Swift
  // FlgCP[ PNCPPM_PAYAMOUNT ] = 1;
  FlgCP[ PNCPPM_PAYFIID   ] = 1;
  FlgCP[ PNCPPM_ACCOUNTP  ] = 1;
  FlgCP[ PNCPPM_CODEKINDR ] = 1;
  FlgCP[ PNCPPM_CODEKINDR2] = 1;
  FlgCP[ PNCPPM_CODER     ] = 1;
  FlgCP[ PNCPPM_ACCOUNTR  ] = 1;
  //R-Maket
  FlgKZRM[ KZPNRMPM_KINDCODE_RECEIVER ] = 1;
  FlgKZRM[ KZPNRMPM_CODE_RECEIVER     ] = 1;
  FlgKZRM[ KZPNRMPM_RecieverCode      ] = 1;
  FlgKZRM[ KZPNRMPM_IIK_RECEIVER      ] = 1;
  //swift
  FlgKZCP[ KZ_PNCPPM_FI_Code  ] = 1;
  FlgKZCP[ KZ_PNCPPM_Amount   ] = 1;
  FlgKZCP[ KZ_PNCPPM_CodeKind ] = 1;
  FlgKZCP[ KZ_PNCPPM_BankCode ] = 1;
  FlgKZCP[ KZ_PNCPPM_ReceiverCodeKind] = 1;
  FlgKZCP[ KZ_PNCPPM_ReceiverCode    ] = 1;
  FlgKZCP[ KZ_PNCPPM_ReceiverAccount ] = 1;


  if (ValType(flag) != V_UNDEF)
  else
    if( not needUseKZpm() )
//      stat = PM_ProcessPanel( Payment, 0, NULL, FlgRM, FlgCP );
    else
//      stat = PM_ProcessPanel( Payment, 0, NULL, FlgKZRM, FlgKZCP );
    end;
  end;

  // Установить признак автозапуска операции.
  BankPayment.LaunchOper = false;//true;

  return true;
end;

