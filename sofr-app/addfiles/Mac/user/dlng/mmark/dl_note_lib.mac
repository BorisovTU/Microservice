/*
LKL 
Библиотека чтения и вставки/обновления значения T_TEXT пользовательского примечания=T_NOTEKIND для сделки МБК=DealId
T_OBJECTTYPE - Вид объекта (Сделка МБК=103)
*/

import /*Simanov. Избавляемся от библиотеки CommonInter,*/ RSD, globals, funk, dl_lib;

const T_OBJECTTYPE = 103,
      T_DATE       ={curdate},
      T_OPER       ={oper},
      T_BRANCH     ={NumDprt},
      T_NOTETYPEInt    = 0,
      T_NOTETYPELong   = 1,
      T_NOTETYPEMoney  = 25,
      T_NOTETYPEDate   = 9,
      T_NOTETYPEText   = 7,
      T_NOTETYPEDouble = 4;



private macro ReadFmtStruct(name)
    var cmd;

//    if (ActiveFmtStruct != name)
      cmd = RsdCommand("begin rsb_struct.readstruct(?); end;");
      cmd.addParam("name", RSDBP_IN, name);
      cmd.execute();
//      ActiveFmtStruct = name;
//    end;
end; // ReadFmtStruct



//Получить тип пользовательского примечания по номеру
macro getNoteType( NoteKind )
  private var  T_NOTEKIND;
  private var  que0, rs0;

  T_NOTEKIND  = String(NoteKind);
  que0 =  "select t.t_notetype from dnotekind_dbt t where t.t_objecttype="+String(T_OBJECTTYPE)+" and t_notekind="+T_NOTEKIND;
  rs0 = LnGetRecordSet(que0);
  if(rs0 != null)
     if (rs0.moveNext) 
        return rs0.value(0);
     else
	return (-1);
     end;
  end;

end;  //getNoteType



//Есть ли история у примечания по типу
macro IsNoteHist( NoteKind )
  private var  T_NOTEKIND;
  private var  que0, rs0;

  T_NOTEKIND  = String(NoteKind);
  que0 =  "select t.t_keepoldvalues from dnotekind_dbt t where t.t_objecttype="+String(T_OBJECTTYPE)+" and t_notekind="+T_NOTEKIND;
  rs0 = LnGetRecordSet(que0);
  if(rs0 != null)
     if (rs0.moveNext) 
        if (rs0.value(0)=="X") 
           return True;
        else 
           return False;
        end;
     else
	return False;
     end;
  end;

end;  //IstNoteHist


//Получить примечание сделки по номеру  
macro getNoteDifValue(DealId, NoteKind)
  
  private var T_DOCUMENTID, T_NOTEKIND;
  private var  que0, rs0, v_notetype, s_proc;

  T_DOCUMENTID = String(DealID); 
  T_NOTEKIND   = String(NoteKind);

  v_notetype   = getNoteType( T_NOTEKIND );

  ReadFmtStruct("dnotetext_dbt");

  if (v_notetype == (-1))
     msgbox("Примечание "+T_NOTEKIND+" отсутствует в справочнике объекта сделка МБК!");
     return V_UNDEF;
  elif (v_notetype == T_NOTETYPEMoney)
     s_proc = "RSB_Struct.GetMoney";

  elif (v_notetype == T_NOTETYPEDate)
     s_proc = "RSB_Struct.GetDate";

  elif (v_notetype == T_NOTETYPEText)
     s_proc = "RSB_Struct.GetString";

  elif (v_notetype == T_NOTETYPEDouble)
     s_proc = "RSB_Struct.GetDouble";

  elif (v_notetype == T_NOTETYPEInt)
     s_proc = "RSB_Struct.GetInt";

  elif (v_notetype == T_NOTETYPELong)
     s_proc = "RSB_Struct.GetLong";

  else
     return V_UNDEF;
  end; 

  que0="select "+s_proc +"(t_text) from dnotetext_dbt where t_objecttype="+String(T_OBJECTTYPE)+" and t_notekind="+T_NOTEKIND+" and t_documentid = lpad("+t_documentid+",34,'0') AND T_VALIDTODATE=to_date('31129999','DDMMYYYY')";
  rs0 = LnGetRecordSet(que0);
  if(rs0 != null)
     if (rs0.moveNext) 
        return rs0.value(0);
     end;
  end;
  return V_UNDEF;
end;  //getNoteDifValue


//Получить примечание сделки по номеру  на дату
macro getNoteDifValueByDate(DealId, NoteKind, DateNote)
  
  private var T_DOCUMENTID, T_NOTEKIND;
  private var  que0, rs0, v_notetype, s_proc, is_notehist;

  T_DOCUMENTID = String(DealID); 
  T_NOTEKIND   = String(NoteKind);

  v_notetype   = getNoteType( T_NOTEKIND );
  is_notehist  = IsNoteHist( T_NOTEKIND );

  ReadFmtStruct("dnotetext_dbt");

  if (v_notetype == (-1))
     msgbox("Примечание "+T_NOTEKIND+" отсутствует в справочнике объекта сделка МБК!");
     return V_UNDEF;
  elif (v_notetype == T_NOTETYPEMoney)
     s_proc = "RSB_Struct.GetMoney";

  elif (v_notetype == T_NOTETYPEDate)
     s_proc = "RSB_Struct.GetDate";

  elif (v_notetype == T_NOTETYPEText)
     s_proc = "RSB_Struct.GetString";

  elif (v_notetype == T_NOTETYPEDouble)
     s_proc = "RSB_Struct.GetDouble";

  elif (v_notetype == T_NOTETYPEInt)
     s_proc = "RSB_Struct.GetInt";

  elif (v_notetype == T_NOTETYPELong)
     s_proc = "RSB_Struct.GetLong";

  else
     return V_UNDEF;
  end; 

  que0 ="select "+s_proc +"(t_text) from dnotetext_dbt where t_objecttype="+String(T_OBJECTTYPE)+" and t_notekind="+T_NOTEKIND;
  que0 = que0 +" and t_documentid = lpad("+t_documentid+",34,'0') AND T_VALIDTODATE=(select min(t_validtodate) from dnotetext_dbt";
  que0 = que0 +" where t_objecttype="+String(T_OBJECTTYPE)+" and t_notekind="+T_NOTEKIND+" and t_validtodate>to_date('"+SDAT(DateNote)+"','DD.MM.YYYY'))";
  rs0 = LnGetRecordSet(que0);
  if(rs0 != null)
     if (rs0.moveNext) 
        return rs0.value(0);
     end;
  end;
  return V_UNDEF;
end;  //getNoteDifValueByDate


//Добавить или обновить примечание сделки  по номеру 
macro SetNoteDifValue( DealId, NoteKind, NoteValue )
  private var T_DOCUMENTID, T_NOTEKIND,T_TEXT, cmd, que, que1, cmd_fmt, rs_fmt, BeginOffset, FieldLenght, t_name, t_column;
  private var que0, rs0, rs1, s_proc, v_notetype, is_notehist, s_notevalue, is_notins;

  t_name       = "dnotetext_dbt";
  t_column     = "t_text";
  T_DOCUMENTID = String(DealID); 
  T_NOTEKIND   = String(NoteKind);
  is_notins = false;

  v_notetype   = getNoteType( T_NOTEKIND );
  is_notehist  = IsNoteHist( T_NOTEKIND );

  cmd_fmt = RsdCommand(
       "select (select t_offset " +
                 "from fmt_fields " +
                "where t_fmtid = (select t_id " +
                                   "from fmt_names " +
                                  "where lower (t_name) = '"+ t_name +"') " +
                  "and lower (t_name) = '"+t_column+"') beginoffset, " +
              "(select t_size " +
                 "from fmt_fields " +
                "where t_fmtid = (select t_id " +
                                   "from fmt_names " +
                                  "where lower (t_name) = '"+ t_name +"') " +
                  "and lower (t_name) = '"+t_column+"') fieldlenght " +
         "from dual " );

  cmd_fmt.execute;
  rs_fmt = RsdRecordSet( cmd_fmt );
    if ( rs_fmt.MoveNext )
      BeginOffset = int(rs_fmt.value("BeginOffset"));
      FieldLenght = 2 * int(rs_fmt.value("FieldLenght"));
      if ( (BeginOffset == 0) or (FieldLenght == 0 ) )
        RunError("Не получается определить данные  из fmt");  
        return 1;
      end;  
    end;

  ReadFmtStruct(t_name);

/*  ???
  que="select count(*) from dnotetext_dbt where t_objecttype="+String(T_OBJECTTYPE)+" and t_notekind="+String(T_NOTEKIND)+" and t_documentid = lpad("+t_documentid+",34,'0') AND T_VALIDTODATE=to_date('"+SDAT(T_DATE-1)+"','DD.MM.YYYY')";
  rs0 = LnGetRecordSet(que);
  if(rs0 != null)
     if (rs0.moveNext) 
        if ( (rs0.value(0) > 0) ) 
		is_notehist = False; 
	end;
     end;	
  end;
*/
  que="select count(*) from dnotetext_dbt where t_objecttype="+String(T_OBJECTTYPE)+" and t_notekind="+String(T_NOTEKIND)+" and t_documentid = lpad("+t_documentid+",34,'0') AND T_VALIDTODATE=to_date('31129999','DDMMYYYY')";
  rs0 = LnGetRecordSet(que);


  if (v_notetype == (-1))
     msgbox("Примечание "+T_NOTEKIND+" отсутствует в справочнике объекта сделка МБК!");
     return V_UNDEF;
  elif (v_notetype == T_NOTETYPEMoney)
     s_proc="RSB_Struct.PutMoney('t_text', rpad('0',"+ String(FieldLenght)+", '0'), "+ String(NoteValue)+", (-1)*"+String(BeginOffset)+")";

  elif (v_notetype == T_NOTETYPEDate)
     s_proc="RSB_Struct.PutDate('t_text', rpad('0',"+ String(FieldLenght)+", '0'), to_date('"+ String(NoteValue)+"','DD.MM.YYYY'), (-1)*"+String(BeginOffset)+")";

  elif (v_notetype == T_NOTETYPEText)
     s_proc="RSB_Struct.PutString('t_text', rpad('0',"+ String(FieldLenght)+", '0'), '"+ NoteValue+"', (-1)*"+String(BeginOffset)+")";

  elif (v_notetype == T_NOTETYPEDouble)
     s_proc="RSB_Struct.PutDouble('t_text', rpad('0',"+ String(FieldLenght)+", '0'), "+ String(NoteValue)+", (-1)*"+String(BeginOffset)+")";

  elif (v_notetype == T_NOTETYPEInt)
     s_proc="to_blob(rpad(cast(DBMS_LOB.SUBSTR(RSB_Struct.PutInt(to_blob(rpad('0',"+ String(FieldLenght)+", '0')), "+ String(NoteValue)+"), 32767 ,1) as varchar2(4000)), "+String(FieldLenght)+", '0'))";

  elif (v_notetype == T_NOTETYPELong)
     s_proc="to_blob(rpad(cast(DBMS_LOB.SUBSTR(RSB_Struct.PutLong(to_blob(rpad('0',"+ String(FieldLenght)+", '0')), "+ String(NoteValue)+"), 32767 ,1) as varchar2(4000)), "+String(FieldLenght)+", '0'))";

  end; 


  if(rs0 != null)
     if (rs0.moveNext) 
        if ( (rs0.value(0) > 0) and ( is_notehist ) )
//если есть примечание с текущей датоу и историей, то не надо добавлять запись  в историю, только обновляем примечание
          que="select count(*) from dnotetext_dbt where t_objecttype="+String(T_OBJECTTYPE)+" and t_notekind="+String(T_NOTEKIND)+" and t_documentid = lpad("+t_documentid+",34,'0') AND T_VALIDTODATE=to_date('31129999','DDMMYYYY') AND T_DATE=to_date('"+SDAT(T_DATE)+"','DD.MM.YYYY')";
          rs1 = LnGetRecordSet(que);
          if(rs1 != null)
             if (rs1.moveNext) 
                if ( (rs1.value(0) > 0) ) 
                  is_notins = true;
        	end;
             end;	
          end;

//для примечания с историей изменим дату текущего примечания
          if  (is_notins )
            que1 = " UPDATE DNOTETEXT_DBT  SET T_TEXT="+ s_proc +  
                   " WHERE T_OBJECTTYPE=? AND T_DOCUMENTID= LPAD(?, 34, '0') AND  T_VALIDTODATE=to_date('31129999','DDMMYYYY') AND T_DATE=trunc(?) AND T_NOTEKIND="+T_NOTEKIND; 
          else
            que1 = " UPDATE DNOTETEXT_DBT  SET T_VALIDTODATE=(trunc(?)-1) " + 
                   " WHERE T_OBJECTTYPE=? AND T_DOCUMENTID= LPAD(?, 34, '0') AND  T_VALIDTODATE=to_date('31129999','DDMMYYYY') AND T_DATE<>trunc(?) AND T_NOTEKIND="+T_NOTEKIND; 
          end;

            cmd = RSDCommand(que1);     
            if ( not is_notins )
              cmd.addParam("", RSDBP_IN, T_DATE);
            end;
    	    cmd.addParam("", RSDBP_IN, T_OBJECTTYPE);
            cmd.addParam("", RSDBP_IN, T_DOCUMENTID);
            cmd.addParam("", RSDBP_IN, T_DATE);
            cmd.execute();

        end;

        if ( (rs0.value(0) > 0) and ( not is_notehist ))
          que1 = " UPDATE DNOTETEXT_DBT  SET  T_TEXT="+ s_proc+", T_DATE=trunc(?) " + 
                 " WHERE T_OBJECTTYPE=? AND T_DOCUMENTID= LPAD(?, 34, '0') AND T_VALIDTODATE=to_date('31129999','DDMMYYYY') AND T_NOTEKIND="+T_NOTEKIND; 

          cmd = RSDCommand(que1); 
         
          cmd.addParam("", RSDBP_IN, T_DATE);
	  cmd.addParam("", RSDBP_IN, T_OBJECTTYPE);
          cmd.addParam("", RSDBP_IN, T_DOCUMENTID);
          cmd.execute();
	  return 0;

        else
          if( not is_notins )
  	    que1 = " INSERT INTO DNOTETEXT_DBT  ( T_OBJECTTYPE, T_DOCUMENTID, T_NOTEKIND, T_OPER, T_DATE, T_TIME, T_TEXT, T_VALIDTODATE, T_BRANCH, T_NUMSESSION )" + 
                   " VALUES "+
                   "  ( ?, LPAD(?, 34, '0'), ?, ?, trunc(?), to_date('01010001'||to_char(sysdate,'hhmiss'),'DDMMYYYYhhmiss'), "+ s_proc+", to_date('31129999','DDMMYYYY'), ?, 0 )"; 

            cmd = RSDCommand(que1);

  	    cmd.addParam("", RSDBP_IN, T_OBJECTTYPE);
            cmd.addParam("", RSDBP_IN, T_DOCUMENTID);
  	    cmd.addParam("", RSDBP_IN, T_NOTEKIND);
  	    cmd.addParam("", RSDBP_IN, T_OPER);
            cmd.addParam("", RSDBP_IN, T_DATE);
  	    cmd.addParam("", RSDBP_IN, T_BRANCH);
            cmd.execute();
          end;
  	  return 0;
 
        end;
     end;
  end;
  return 1;
end; //SetNoteDifValue

//Удаление примечания
macro DelNoteByKind(DealId, NoteKind)

  private var T_DOCUMENTID, T_NOTEKIND;
  private var  que0, rs0;

  T_DOCUMENTID = String(DealID); 
  T_NOTEKIND   = String(NoteKind);

  que0="delete from dnotetext_dbt where t_objecttype="+String(T_OBJECTTYPE)+" and t_notekind="+T_NOTEKIND+" and t_documentid = lpad("+t_documentid+",34,'0') AND T_VALIDTODATE=to_date('31129999','DDMMYYYY')";
  rs0 = LnGetRecordSet(que0);

end;

//Вставка/обновление  типа портфеля по сделке
macro InsPortfolioAttr( DealId, CodePortfolio )
  private var T_DOCUMENTID;
  private var  que0, rs0, cmd, v_attrid;

  T_DOCUMENTID = String(DealID); 

/*
INSERT INTO dobjatcor_dbt
(T_OBJECTTYPE,T_GROUPID,T_ATTRID,T_OBJECT,T_GENERAL,T_VALIDFROMDATE,T_OPER,T_VALIDTODATE,T_SYSDATE,T_SYSTIME,T_ISAUTO,T_ID)
VALUES (103,1,2,'0000000000000000000000000000000433','88',to_date('2.6.2016','DD.MM.YYYY
HH24:MI:SS'),1,to_date('31.12.9999','DD.MM.YYYY HH24:MI:SS'),to_date('21.6.2018','DD.MM.YYYY
HH24:MI:SS'),to_date('01.01.0001','DD.MM.YYYY HH24:MI:SS'),'88',0)

*/
  que0="select t_id from  dobjatcor_dbt  where t_objecttype="+String(T_OBJECTTYPE)+" and t_object = lpad("+t_documentid+",34,'0') and t_validtodate=to_date('31129999','DDMMYYYY')";
  rs0 = LnGetRecordSet(que0);
  if(rs0 != null)
     if (rs0.moveNext) 
        v_attrid = rs0.value(0); 
     else
        v_attrid = (-1);
     end;	
  end;
//msgbox(v_attrid);

  if (v_attrid < 0 )
     que0="INSERT INTO dobjatcor_dbt (T_OBJECTTYPE,T_GROUPID,T_ATTRID,T_OBJECT,T_GENERAL,T_VALIDFROMDATE,T_OPER,T_VALIDTODATE,T_SYSDATE,T_SYSTIME,T_ISAUTO,T_ID) "+
          "VALUES (?,1,?,LPAD(?, 34,'0'),chr(88),trunc(?),?,to_date('31129999','DDMMYYYY'),trunc(sysdate),to_date('01010001'||to_char(sysdate,'hhmiss'),'DDMMYYYYhhmiss'),chr(88),dobjatcor_dbt_SEQ.Nextval)";

            cmd = RSDCommand(que0);

  	    cmd.addParam("", RSDBP_IN, T_OBJECTTYPE);
  	    cmd.addParam("", RSDBP_IN, CodePortfolio);
            cmd.addParam("", RSDBP_IN, T_DOCUMENTID);
            cmd.addParam("", RSDBP_IN, T_DATE);
  	    cmd.addParam("", RSDBP_IN, T_OPER);

            cmd.execute();
 
  else
//msgbox(CodePortfolio);
     que0="update dobjatcor_dbt set t_attrid = "+ String(CodePortfolio) +" where t_id = "+String(v_attrid) +" and t_objecttype="+String(T_OBJECTTYPE)+"  and t_object = lpad("+t_documentid+",34,'0') and t_validtodate=to_date('31129999','DDMMYYYY')";
     rs0 = LnGetRecordSet(que0);
  end;

end;

// ----------------------------------------

macro NEWNOTE( DealId, NoteKind, NoteValue )
  private var T_DOCUMENTID, T_NOTEKIND,T_TEXT, cmd, que, que1, cmd_fmt, rs_fmt, BeginOffset, FieldLenght, t_name, t_column;
  private var que0, rs0, rs1, s_proc, v_notetype, is_notehist, s_notevalue, is_notins, T_OBJECTTYPE2=24,rs01 ;


  t_name       = "dnotetext_dbt";
  t_column     = "t_text";
  T_DOCUMENTID = String(DealID); 
  T_NOTEKIND   = String(NoteKind);
  is_notins = false;

  v_notetype   = getNoteType( T_NOTEKIND );
  is_notehist  = IsNoteHist( T_NOTEKIND );

  cmd_fmt = RsdCommand(
       "select (select t_offset " +
                 "from fmt_fields " +
                "where t_fmtid = (select t_id " +
                                   "from fmt_names " +
                                  "where lower (t_name) = '"+ t_name +"') " +
                  "and lower (t_name) = '"+t_column+"') beginoffset, " +
              "(select t_size " +
                 "from fmt_fields " +
                "where t_fmtid = (select t_id " +
                                   "from fmt_names " +
                                  "where lower (t_name) = '"+ t_name +"') " +
                  "and lower (t_name) = '"+t_column+"') fieldlenght " +
         "from dual " );

  cmd_fmt.execute;
  rs_fmt = RsdRecordSet( cmd_fmt );
    if ( rs_fmt.MoveNext )
      BeginOffset = int(rs_fmt.value("BeginOffset"));
      FieldLenght = 2 * int(rs_fmt.value("FieldLenght"));
      if ( (BeginOffset == 0) or (FieldLenght == 0 ) )
        RunError("Не получается определить данные  из fmt");  
        return 1;
      end;  
    end;

  ReadFmtStruct(t_name);

          s_proc="RSB_Struct.PutMoney('t_text', rpad('0',"+ String(FieldLenght)+", '0'), "+ String(NoteValue)+", (-1)*"+String(BeginOffset)+")";
          que="select count(*) from dnotetext_dbt where T_OBJECTTYPE="+String(T_OBJECTTYPE2)+" and t_notekind="+String(T_NOTEKIND)+" and t_documentid = lpad("+t_documentid+",10,'0') ";
          rs1 = LnGetRecordSet(que);
          if(rs1 != null)
           if (rs1.moveNext) 
             if ( int(rs1.value(0)) > 0 )

               que="delete from dnotetext_dbt where T_OBJECTTYPE="+String(T_OBJECTTYPE2)+" and t_notekind="+String(T_NOTEKIND)+" and t_documentid = lpad("+t_documentid+",10,'0') ";
               rs01 = LnGetRecordSet(que);

           end;	
          end;

  	    que1 = " INSERT INTO DNOTETEXT_DBT  ( T_OBJECTTYPE, T_DOCUMENTID, T_NOTEKIND, T_OPER, T_DATE, T_TIME, T_TEXT, T_VALIDTODATE, T_BRANCH, T_NUMSESSION )" + 
                   " VALUES "+
                   "  ( ?, LPAD(?, 10, '0'), ?, ?, trunc(?), to_date('01010001'||to_char(sysdate,'hhmiss'),'DDMMYYYYhhmiss'), "+ s_proc+", to_date('31129999','DDMMYYYY'), ?, 0 )"; 

            cmd = RSDCommand(que1);

  	    cmd.addParam("", RSDBP_IN, T_OBJECTTYPE2);
            cmd.addParam("", RSDBP_IN, T_DOCUMENTID);
  	    cmd.addParam("", RSDBP_IN, T_NOTEKIND);
  	    cmd.addParam("", RSDBP_IN, T_OPER);
            cmd.addParam("", RSDBP_IN, T_DATE);
  	    cmd.addParam("", RSDBP_IN, T_BRANCH);
            cmd.execute();


  	  return 0;
 
        end;
     end;
  end;
  return 1;
end; //SetNoteDifValue


