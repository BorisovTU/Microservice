import fx_globals,InsCarryDoc, CurrInter, Проценты, MmarkInter, mmlibr, mmcarry, mmcnst_j, mmplib, dl_lib ,"calculate.mac";

PRIVATE FILE leg (dl_leg);
// PRIVATE FILE pm ("pmpaym") key 1 write;
PRIVATE RECORD tick (dl_tick);


/*----------------------------------------------------------------------------
    Выполнение шага
----------------------------------------------------------------------------*/
MACRO ExecuteStep(Buffer, Document)
    var deal_pd ,acc0, acc2, acc0p, s_addground, nrate, vsum, vsum2,sground,acc5;
    var  at  = MM_Carry;
    var  atp = MM_Carry;

    SetBuff (tick,Document);
    DL_PrepareCarryBuffer (Buffer);
    leg.LegKind = LEG_KIND_DL_TICK;
    leg.DealID = tick.DealID;
    leg.LegID = 1;

    if (not GetEq(leg))
        mm_error ("Не найден транш сделки");
        return 1;
    end;

    deal_pd = MMFirstDoc(DL_IBCDOC, tick.DealID, true);
    s_addground = GetGroundAddPart(tick);
    sground="Восстановление оценочного резерва ОД по "+tick.dealcode+"/"+nami(tick.partyid);

    if ((tick.dealtype == 12305 ) or (tick.dealtype == 12306 ))
       if ( tick.partyid == _BANK_RF )
          if (not deal_pd.OpenAccount("+РС, кредиты%0", acc2, NULL, deal_pd.GetFIRoleByCategory("+РС, кредиты%0", 0), NULL, {curdate}, 0))
             return 1;
          end;    
       else
          if (not deal_pd.OpenAccount("+РС, кредиты%00", acc2, NULL, deal_pd.GetFIRoleByCategory("+РС, кредиты%0", 0), NULL, {curdate}, 0))
             return 1;
          end;    
       end;

       acc0 =MM_acc(tick.dealid,711);
       if (tick.dealtype == 12306 )
          if (not deal_pd.OpenAccount("+КОР_Резерв, ОД3", acc0, NULL, deal_pd.GetFIRoleByCategory("+КОР_Резерв, %0", 0), NULL, {curdate}, 0))
             return 1;
          end;    
       end;

    else
      if(not deal_pd.OpenAccount("+КОР_Резерв, ОД2", acc0, NULL, deal_pd.GetFIRoleByCategory("+КОР_Резерв, %0", 0), NULL, {curdate}, 0))
        return 1;
      end;
    
      if (tick.dealtype == 12335 )
/*SVE 504287 списание происходит только на счет КУ '+РС, кредиты%0'
         if (not deal_pd.OpenAccount("+%, Кр01", acc2, NULL, deal_pd.GetFIRoleByCategory("+%, Кр01", 0), NULL, {curdate}, 0))
            return 1;
         end;    
      else
*/
         if (not deal_pd.OpenAccount("+РС, кредиты%0", acc2, NULL, deal_pd.GetFIRoleByCategory("+РС, кредиты%0", 0), NULL, {curdate}, 0))
            return 1;
         end;    
      end;
    end;

    if ( tick.dealtype == 12306 )
       if(not deal_pd.OpenAccount("СЧЕТ_61212", acc5, NULL, deal_pd.GetFIRoleByCategory("СЧЕТ_61212П", 0), NULL, {curdate}, 0))
       end;    

       vsum=RestA_(acc0,{curdate}, 1,0);
       at.date_carry       = {curdate};
       at.AccountPayer    = acc0;	  
       at.AccountReceiver = acc5;
       at.FIIDPayer       = 0;
       at.FIIDReceiver    = 0;
       at.SumReceiver     = vsum;
       at.Chapter         = 1;
       at.Ground          = sground;
       if (not at.carry())
          msgbox("Error !");
          return false;
       end;
 
       at.date_carry       = {curdate};
       at.AccountPayer    = acc5;	  
       at.AccountReceiver = acc2;
       at.FIIDPayer       = 0;
       at.FIIDReceiver    = 0;
       at.SumReceiver     = vsum;
       at.Chapter         = 1;
       at.Ground          = sground;
       if (not at.carry())
          msgbox("Error !");
          return false;
       end;
    else
       vsum=RestA_(acc0,{curdate}, 1,0);
       at.date_carry       = {curdate};
       at.AccountPayer    = acc0;	  
       at.AccountReceiver = acc2;
       at.FIIDPayer       = 0;
       at.FIIDReceiver    = 0;
       at.SumReceiver     = vsum;
       at.Chapter         = 1;
       at.Ground          = sground;
       if (not at.carry())
          msgbox("Error !");
          return false;
       end;
    end;

    if ((tick.dealtype == 12305 ) or (tick.dealtype == 12306 ))
       if ( tick.partyid == _BANK_RF )
          if (not deal_pd.OpenAccount("+РС, кредиты%0", acc2, NULL, deal_pd.GetFIRoleByCategory("+РС, кредиты%0", 0), NULL, {curdate}, 0))
             return 1;
          end;    
       else
          if (not deal_pd.OpenAccount("+РС, кредиты%00", acc2, NULL, deal_pd.GetFIRoleByCategory("+РС, кредиты%0", 0), NULL, {curdate}, 0))
             return 1;
          end;   
       end;
       acc0 =MM_acc(tick.dealid,717);
    else
       if (not deal_pd.OpenAccount("+КОР_Резерв, %0", acc0, NULL, deal_pd.GetFIRoleByCategory("+КОР_Резерв, %0", 0), NULL, {curdate}, 0))
          return 1;
       end;    
       if (tick.dealtype == 12335 )
/*SVE 504287 списание происходит только на счет КУ '+РС, кредиты%0'
          if (not deal_pd.OpenAccount("+%, Кр01", acc2, NULL, deal_pd.GetFIRoleByCategory("+%, Кр01", 0), NULL, {curdate}, 0))
             return 1;
          end;    
       else
*/ 
          if (not deal_pd.OpenAccount("+РС, кредиты%0", acc2, NULL, deal_pd.GetFIRoleByCategory("+РС, кредиты%0", 0), NULL, {curdate}, 0))
             return 1;
          end;    
       end;
    end;
    sground="Восстановление оценочного резерва %% по "+tick.dealcode+"/"+nami(tick.partyid);
    vsum2=RestA_(acc0,{curdate}, 1,0);

    at.date_carry       = {curdate};
    at.AccountPayer    = acc0;	  
    at.AccountReceiver = acc2;
    at.FIIDPayer       = 0;
    at.FIIDReceiver    = 0;
    at.SumReceiver     = vsum2;
    at.SumPayer        = vsum2;
    at.Chapter         = 1;
    at.Ground          = sground;
    if (not at.carry())
       msgbox("Error !");
       return false;
    end;

    return 0;
END;
