import BankInter, PTInter, FIInter, Rsexts, globals, rsd, RsbDataSet, Š «¥­¤ àì;


macro ProcessDialog(dlg, cmd, id, key)

  if(cmd == DLG_KEY)

     if(key == 317) /* F3 */
       if  (id == 0) /* „ â  ­ ç «  ¯¥à¨®¤  */
         dlg.startdate = GetDateByCalendar({curdate});
       elif(id == 1) /* „ â  ®ª®­ç ­¨ï ¯¥à¨®¤  */
         dlg.enddate = GetDateByCalendar({curdate});
       end;
     elif  (key == 316) /* F2 */
       return CM_SAVE;
     elif(key == 27)  /* ESC */
       exit(1);
     end;

  end;

end;

PRIVATE MACRO GetOperNameEx(OperID):string
   var rsbQuery, querystr = "", name = "";

     querystr = " select " +
                " case when t_name like '%.%' then t_name " +
                 " else " +
                  "  case when instr(t_name,' ',1,1) = 0 then t_name " +
                     " else substr(t_name,1,instr(t_name,' ',1,1)) || " +
                          "  Upper(substr(t_name,instr(t_name,' ',1,1)+1,1)) || '.' || " +
                           "  case when instr(t_name,' ',1,2) = 0 then '' " +
                                "  else Upper(substr(t_name,instr(t_name,' ',1,2)+1,1)) || '.'  " +
                           "  end " +
                   " end " +
               " end as t_name " + 
      "from dperson_dbt   where t_oper = " + OperID;

   rsbQuery = TRsbDataSet(querystr);
   if (rsbQuery.MoveNext())
      name = rsbQuery.name;
   end;
   return name;
END;



var sqlStr = "", rs, cmd, Date1, Date2, n=1;
record dl (Dates, "..\\Obj\\dialog.lbr") dialog;

  dl.startdate = {curdate};
  dl.enddate  =  {curdate};
  RunDialog(dl, @ProcessDialog);

  date1 = dl.startdate;
  date2 = dl.enddate;

sqlStr = "select fi.t_fiid, FI.T_FI_CODE, fi.t_name, "
                "fw.t_drawingdate, "
                "case when fw.T_RELATIVEINCOME = chr(88) then 'Š' else '—' end T_RELATIVEINCOME, "
                "fw.t_number, fw.t_incomerate, "
                "s.t_amount, "
                "round((fw.t_incomerate / 100) * (FW.T_DRAWINGDATE - fw.t_firstdate + 1) * fi.t_facevalue / 365, 2) as abs_vel, "
                "s.t_amount * round((fw.t_incomerate / 100) *  (FW.T_DRAWINGDATE - fw.t_firstdate + 1) * fi.t_facevalue / 365, 2) doh_na_lot, "
                "ti.t_dealcode, "
                "v.t_code "
           "from dfininstr_dbt fi "
       "inner join dfiwarnts_dbt fw "
              "on fw.t_fiid = fi.t_fiid and fw.t_isclosed <> 'X' and fw.t_drawingdate between :date1 and :date2 "
       "inner join dpmwrtsum_dbt s "
               "on s.t_fiid = fi.t_fiid and s.t_amount > 0 and s.t_date <= fw.t_drawingdate "
       "inner join ddl_tick_dbt ti "
               "on ti.t_dealid = s.t_dealid "
       "inner join dllvalues_dbt v "
               "on v.t_element = s.t_portfolio AND v.t_list = 1100 and s.t_state <> 2 --  ­­ã«¨à®¢ ­ "
        "where fi.t_issuer not in (1, 67) "
       "order by fw.t_drawingdate, FI.T_FI_CODE";

cmd = RsdCommand(SqlStr);
cmd.addParam("date1", RSDBP_IN, date1);
cmd.addParam("date2", RSDBP_IN, date2);


rs = RsdRecordSet(cmd);

  println("");
  println("Šã¯®­ë, ¯®£ è ¥¬ë¥ ¢ ¯¥à¨®¤ á " + Date1  + " ¯® " + Date2 );
  println("");
  println("");

  [ÚÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿];
  [³ ü³  Š®¤ ³    ¨¬¥­®¢ ­¨¥     ³ Š/— ³ ü ³ ®£ è ¥âáï ³   %   ³ €¡á. ¢¥«¨ç¨­  ³   ‘¤¥«ª  ü    ³  Š®«-¢®  ³ ®àâä ³     ‘ã¬¬       ³];
  [³¯¯³  ”ˆ  ³        ”ˆ          ³      ³   ³            ³       ³               ³               ³    èâ.   ³       ³    ¤®å.­  «®â  ³];
//[ÃÄÄÅÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÅÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
//   1    2             3            4     5       6          7             8             9            10        11        12





while (rs.MoveNext)                                             

  [ÃÄÄÅÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÅÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
  [³##³######³####################³######³###³############³#######³###############³###############³##########³#######³################³]
  ( n, //1
    rs.value("t_fi_code"):c, // 2
    rs.value("t_name"):w, // 3
    rs.value("T_RELATIVEINCOME"):c, // 4
    rs.value("t_number"):c, // 5
    date(rs.value("t_drawingdate")):c, // 6
    rs.value("t_incomerate"):0:2, // 7
    rs.value("abs_vel"):0:2:a, // 8
    rs.value("t_dealcode"):c, // 9
    int(rs.value("t_amount")):0:2:a, // 10
    rs.value("t_code"):c, // 11
    rs.value("doh_na_lot"):0:2:a // 12
  );
  
 n=n+1; 
end;

[ÀÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];

[ ];
[ ];
[ ];
[########## ########](Date,time);
[ ];
[ˆá¯®«­¨â¥«ì   _______________  ##################################]( GetOperNameEx({Oper}) );
[                 ¯®¤¯¨áì             ”ˆ                 ];













