IMPORT FIInter, rsexts, oralib, likepy, funk, dl_plib, "sprepfun.mac";

private var  ff_1, ff_2, Debet_index, Sum_index, Sum_index_RUR, DocNum_index, OperNum_index;
private var  DocNum, DocNum_2, Debet, PredDebet, Credit, PredCredit, OperNum, val;
private var  da, {curdate}, sql, query, Data, sql_sum, flag, acctrnid;
private var  find = 0, Sum = 0, PredSum = 0;

private var protokol = "", PredOperNum = "";

private macro CheckACC(acc)
  var sql = DL_RSDCommand("select t_account from daccount_dbt where t_account = ?");
  sql.addParam(acc);
  var Data = sql.execute();
  if (Data.MoveNext () )
    return true;
  end;
  return false;
end;

private macro CheckAcctrn(Debet, Credit, Sum, val)
  var sql; //= "select t_acctrnid from dacctrn_dbt where t_account_payer = ? and t_account_receiver = ? and ";
  if (val == "810")
    sql = "select t_acctrnid from dacctrn_dbt where t_account_payer ='" + Debet + "' and t_account_receiver = '" + Credit + "' and t_sum_natcur = " + Sum;
  else
    sql = "select t_acctrnid from dacctrn_dbt where t_account_payer ='" + Debet + "' and t_account_receiver = '" + Credit + "' and t_sum_payer = " + Sum;
  end;
/*
  var query = DL_RSDCommand(sql + sql_sum);
  query.addParam(Debet);
  query.addParam(Credit);
  query.addParam(Sum);
*/
  var query = DL_RSDCommand(sql);
  

  var Data = query.execute();

  if (Data.MoveNext () )
    return Data.acctrnid;
  end;
  return -1;
end;

private macro IsExsist(acctrnid)
  var sql = DL_RSDCommand("select * from dextgnd_dbt where t_acctrnid = ?");
  sql.addParam(acctrnid);
  var Data = sql.execute();
  if (Data.MoveNext () )
    return true;
  end;
  return false;
end;

private macro update(flag, OperNum, acctrnid, Sum)
  var sql;
  if (flag != "Составная")
    sql =  RsdCommand("update dacctrn_dbt set t_userfield4 = ? where t_acctrnid = ?");        
    sql.addParam("",RSDBP_IN, OperNum);
    sql.addParam("",RSDBP_IN, acctrnid);
    sql.execute();
    return true;
  else
    if ( not IsExsist (acctrnid) )
      sql = RsdCommand("insert into dextgnd_dbt values (?, ?)");
    else
      sql = RsdCommand("update dextgnd_dbt set t_extendedground = ? where t_acctrnid = ?");
    end;
    sql.addParam("",RSDBP_IN, OperNum + "\\" + Sum + ";");
    sql.addParam("",RSDBP_IN, acctrnid);
    sql.execute();
    return true;
  end;
  return -1;
end;

  FILE fn_1 () txt;
  FILE fn_2 () txt;
  ff_1 = "..\\\\Import\\ACC\\999.txt";

  Close(fn_1);
  if (not Open(fn_1, ff_1 ))
    msgbox(" Не открыт новый файл ! ");
    return ;
  else
    rewind(fn_1);
    while (next(fn_1))
        
        if ( (Debet != "") and (Credit != ""))
          PredDebet = Debet;
          PredCredit = Credit;
          
          if ( (PredSum == 0) and (Sum != 0) )
            PredSum = Sum;
          end;
        end;
        
        Debet=trim(substr(fn_1.str, 13,20));
        Credit=trim(substr(fn_1.str, 34, 20));

        if ( (protokol != "") and ((Debet != PredDebet) or (Credit != PredCredit)) and (Debet != ""))

          if (flag == "Составная")
            protokol = StrSubst(protokol, PredOperNum, PredOperNum + "\\" +  Sum);
          end;

          acctrnid = CheckAcctrn(PredDebet, PredCredit, PredSum, val);
          if ( acctrnid != -1 )
            if ( update(flag, PredOperNum, acctrnid, Sum) )
              protokol = protokol + "   -   ОБНОВЛЕНА";
            end;
          else
            protokol = protokol + "   -   НЕ ОБНОВЛЕНА";
          end;

          println(protokol);
          protokol = "";
        end;

      if ( CheckACC(Debet) )
        
        DocNum = trim(substr(fn_1.str,2,10));
        val = substr(Debet, 6, 3);
        if (val == "810")
          Sum = trim(substr(fn_1.str, 75, 16));
          Sum = double(Sum);
        else
          Sum = trim(substr(fn_1.str, 60, 14));
          Sum = double(Sum);
        end;

        Close(fn_2);
        ff_2 = "..\\\\Import\\ACC\\9.txt";

        if (not Open(fn_2, ff_2 ))
          msgbox(" Не открыт новый файл ! ");
          return ;
        else
          rewind(fn_2);
          while (next(fn_2))

            DocNum_index = index(fn_2.str,DocNum);       

            if ( DocNum_index == 1 )
            
              OperNum = trim(substr(fn_2.str, 25, 14)) + "#1";
              if ((PredOperNum == "") and (OperNum != ""))
                PredOperNum = OperNum;
              end;

              if ((Debet != PredDebet) or (Credit != PredCredit))
                PredSum = Sum;
                PredOperNum = OperNum;
                flag = "";
                protokol = OperNum + ";   " + Debet + "/" + Credit + "   " + Sum + ";";
                break;
                
              else

                protokol = StrSubst(protokol, string(PredSum), string(Sum + PredSum)) ;
                protokol = StrSubst(protokol, PredOperNum, PredOperNum + "\\" +  PredSum + ";" + OperNum);
                PredOperNum = PredOperNum + "\\" +  PredSum + ";" + OperNum;
                PredSum = PredSum + Sum;
                
                flag = "Составная";
                break;
              end;
            end;
          end;
        end;
        Close(fn_2);
        
        
        if ((Debet != PredDebet) or (Credit != PredCredit))
          
        end;  
      end;
    end;
  end;           
  Close(fn_1);




