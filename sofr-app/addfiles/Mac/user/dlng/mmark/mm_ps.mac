import BankInter, OprInter,dealInfo,PTInter,funk,"cb_sql.mac", Календарь, dlref,dl_plib;
import "gtconst.inc",dlref;

private var RecordID, 
  SeanceID, 
  NewID, 
  Comment;

private var {oper},{curdate},que,tipo,vsd,su1,su2,su11,su22,dss,jj,rs,psn,v1,v2,sd1,sd2 ;
private var sv4,sv5,v4,v5,sv6,sv7,v6,v7,RS12;
private var dealid, new_rate;

private var jk,j2,jj2,v3,sv1,sv2,sv3;
private var kontr,su,kurs,tsd,dsu,dtsd;

private array mas1,mas2 ,mmas,mmas2, mval, misd,mmasi2;

MACRO SDEL3(S,KS)
 PRIVATE VAR SW="                                                                                                      ";
 S=SUBSTR(S+SW,1,KS);
RETURN(S);
END;


macro GetName2(ID)
 var ds;
  ds = TRsbDataSet("select distinct T_NAME from DPARTY_DBT where T_PARTYID = "+ID);
  if (ds.MoveNext())
  return ds.NAME;
  else return -1; 
  end;
end;


macro  indval2(vv1,jjj)
 private var kk,ivv;
 ivv=0;
 kk=0;
 while ( kk < jjj)
   if ( vv1 == mval(kk) )
     ivv=kk;
   end;
     kk=kk+1;
 end;
 return ivv;
end;



private macro GetDealStatus(DealID)
  var sql = "select t_DealStatus from ddl_tick_dbt where t_DealID = "+DealID;
  sql = LnGetRecordset(sql);
  if(sql.MoveNext())

    return sql.value("t_DealStatus");
  end;
  return 20;
end;


macro fix_st(pa1,pa2,pa3)

  private var que,rs93,rs94,rs95,pst,dasd;

  que="SELECT COUNT(*) FROM dprcrateval_dbt prcrateval INNER JOIN dprccontract_dbt prccntr ON prccntr.t_RateID = prcrateval.t_RateID";
  que=que+" INNER JOIN ddl_tick_dbt tick ON tick.t_Dealcode = t_ObjectID ";
  que=que+" WHERE t_ContractType = 7 AND t_ObjectType = 103 AND t_DealID = "+pa1+"AND TO_CHAR(T_RATEDATE,'DD.MM.YYYY')='"+pa2+"'";
   rs93 = LnGetRecordSet(que);
   if(rs93 != null)
     while(rs93.moveNext())

        if (rs93.value(0) == 0 )

          que="SELECT * FROM dprcrateval_dbt prcrateval INNER JOIN dprccontract_dbt prccntr ON prccntr.t_RateID = prcrateval.t_RateID ";
          que=que+" INNER JOIN ddl_tick_dbt tick ON tick.t_Dealcode = t_ObjectID ";
          que=que+" WHERE t_ContractType = 7 AND t_ObjectType = 103 AND t_DealID = "+pa1; 
          rs94 = LnGetRecordSet(que);
   	  if(rs94 != null)
            if (rs94.moveNext) 
             que = "INSERT INTO dprcrateval_dbt Values("+rs94.value("t_rateid")+",'"+pa2+"',"+pa3+",'"+rs94.value("t_macrofile")+"','"+rs94.value("t_macroproc")+"','"+rs94.value("t_variablename")+"',"+rs94.value("t_variableperiod")+","+rs94.value("t_variabledays")+",'"+rs94.value("t_isprognoz")+"')";
             rs94 = LnGetRecordset(que);
       	    end;
       	  end;
/*
  t_rateid         NUMBER(10) not null,
  t_ratedate       DATE not null,
  t_rate           FLOAT(53),
  t_macrofile      VARCHAR2(255),
  t_macroproc      VARCHAR2(255),
  t_variablename   VARCHAR2(50),
  t_variableperiod NUMBER(5),
  t_variabledays   NUMBER(5),
  t_isprognoz      CHAR(1)

*/

        else

          pst=0;
          que="SELECT prcrateval.T_RATE , prcrateval.t_RateID id  FROM dprcrateval_dbt prcrateval INNER JOIN dprccontract_dbt prccntr ON prccntr.t_RateID = prcrateval.t_RateID";
          que=que+" INNER JOIN ddl_tick_dbt tick ON tick.t_Dealcode = t_ObjectID ";
          que=que+" WHERE t_ContractType = 7 AND t_ObjectType = 103 AND t_DealID = "+pa1+"AND TO_CHAR(T_RATEDATE,'DD.MM.YYYY')='"+pa2+"'";
          rs94 = LnGetRecordSet(que);
   	  if(rs94 != null)
            if (rs94.moveNext) 
       	      pst=rs94.value(0);
              if (pst != pa3 )
                que = "update dprcrateval_dbt SET t_rate = "+pa3+" where t_RateID ="+rs94.value("id")+" and TO_CHAR(T_RATEDATE,'DD.MM.YYYY')='"+pa2+"'";
                rs95 = LnGetRecordset(que);
              end;


       	    end;
       	  end;


        end;
     end;
   end;
end;


macro prog_ps(dealid, DealStatus)
  
  private var sql, ik, ii, cmd1, newrez=1;
  private var col1=TArray();
  private var pId,rs10, oldDate = Date(0,0,0);
  private var MenuString   = "", StatusString = "";

  private var correct = 0, old_rate = 0, rate_date = Date(0,0,0), point = 0, dealdate = Date(0,0,0), new_rate_date = Date(0,0,0), stav = 0, price = 0, new_percent_sum = 0, principal = 0;

  array mas5; 

  point = zsdelp(dealid,"point") ;
  que="select t_correct, t_typePercent from ddl_leg_dbt t where t_dealid = '" + dealid + "'";
  rs10 = LnGetRecordset(que);
  if (rs10 != null)
     if (rs10.moveNext)
        correct = rs10.value(0);
     end;
  end;  

  IF ( rs10.value(1) == 0  )
     sql="select a.t_dizm rate_date, replace(to_char(a.t_stav/1000000,'999,999,999.999999'),',', '''') rate, a.t_stav/1000000 t_stav, a.t_id pId,b.t_tablepercent pstav,replace(to_char((a.t_stav-(b.t_correct+a.t_kor_pro)*1000000) /1000000,'999,999,999.999999'),',', '''') klib, b.t_correct+a.t_kor_pro korr, b.t_correct par11 ,b.t_maturity par2,b.t_start dealdate   from dstd_pls_dbt a , ddl_leg_dbt b  where  a.t_id=b.t_dealid and    a.t_id='" + dealid + "' order by a.t_dizm ";
  ELSE
     sql="select a.t_dizm rate_date, replace(to_char(a.t_stav/1000000,'999,999,999.999999'),',', '''') rate, a.t_stav/1000000 t_stav, a.t_id pId,c.t_fi_code pstav,replace(to_char((a.t_stav-(b.t_correct+a.t_kor_pro)*1000000) /1000000,'999,999,999.999999'),',', '''') klib, b.t_correct+a.t_kor_pro korr, b.t_correct par11 ,b.t_maturity par2,b.t_start dealdate   from dstd_pls_dbt a , ddl_leg_dbt b, dfininstr_dbt c where c.t_fiid=b.t_caption and    a.t_id=b.t_dealid and    a.t_id='" + dealid + "' order by a.t_dizm ";
  END;
  cmd1 = RSDRecordset(sql , RSDVAL_CLIENT, RSDVAL_STATIC );


  private macro EvProc (rs, cmd1, id, key )

    dealdate = zsdelp(dealid,"start") ;

    if (cmd1 == DLG_INIT)  // Инициализация
       if (OldDate != Date(0,0,0))  // Надо найти запись
          while ( (rs.value ("rate_date") != OldDate) And (Not rs.EOF) )  
             rs.MoveNext;
          end;
       end;
       GoToScroll(rs, true);

       elif((DLG_KEY_Enter  == Key) or (DLG_KEY_F9  == Key) OR (DLG_KEY_SHIFT_F9  == Key)) 
          if (DealStatus == 0)
             if (DLG_KEY_Enter  == Key)
                OldDate = Date(rs.value("rate_date"));
                old_rate  = rs.value("t_stav");;
             else
                OldDate  = {curdate};
                old_rate  = 0.00;
             end;
             new_rate = old_rate;
             new_rate_date = OldDate;
             ik  = 0;
             jk  = 0;
             while(ik == 0)
                mas5(0)=" Дата изменения %%         :       "+string(new_rate_date:f);
                mas5(1)=" Новое значение  процентов : "+string(new_rate:a:16:6);
                mas5(2)=" Сохранить значения ";
                jk = menu(mas5," ESC - отмена, <Enter> - Ввод параметров "," Введите новые параметры сделки", null, null, jk);
                if (jk == 0 )
                   if (DLG_KEY_Enter  == Key)
                      MsgBox("В режиме редактирования ставки, можно изменить только сумму ставки, для ввода новой ставки другой датой воспользуйтесь клавишей Ф9.");
                   else                      
                      getdate(new_rate_date,"Введите дату изменения :",10);
                      if ( new_rate_date <= OldDate)
                         msgbox("Возможен ввод/редактирование даты > даты выдачи !");
                         new_rate_date = OldDate;
                      end;
                   end;
                elif (jk == 1 )
                   getdouble(new_rate,"Введите новое значение процентов  :", 16, false, 6);
                else
                   ik = 1;
                end;
             end;

             if (jk == 2) //ТОлько если пользователь подтвердил сохраниение
                if ( new_rate_date < ДАТ(RS.VALUE("dealdate")))
                   msgbox("Возможен ввод/редактирование даты > даты выдачи !");
                   new_rate_date = OldDate;
                else
                   new_rate_date  = СДАТ(new_rate_date);
                   price = string(new_rate * (Pow(10, point)));   
                   
                   if (DLG_KEY_Enter  == Key)
                      que = "delete dstd_pls_dbt where t_dizm ='" + OldDate + "' and t_id = '" + dealid  + "'";
                      rs10 = LnGetRecordset(que);
                      if (rs10 != null)   end;
                   else
                      OldDate = new_rate_date;
                   end;

                   que="select count(*)  from dstd_pls_dbt where t_dizm ='" + OldDate + "' and t_id = '" + dealid + "'";
                   rs10 = LnGetRecordset(que);
                   if (rs10 != null)
                      if (rs10.moveNext)
                         jj=rs10.value(0);
                      end;
                   end;
                   
                   stav = string(new_rate * 1000000);          /*t_stav dstd_pls_dbt*/
                   new_rate = (new_rate - correct);
                   new_rate = trim(string(new_rate:16:6));
                   if ( jj == 0 )
                      que = "INSERT INTO dstd_pls_dbt Values('" + dealid + "','" + new_rate_date + "'," + stav + "," + new_rate + ")";
                   else
                      que = "update dstd_pls_dbt SET t_stav = '" + stav + "', t_kor_pro='" + new_rate + "'  where t_dizm ='" + new_rate_date + "' and t_id = '" + dealid + "'";
                   end;
                   rs12 = LnGetRecordset(que);
                   if (rs12 != null)    end;  
           
                   if ( (jj == 0) or (new_rate_date == OldDate))

                      execmacrofile("dl_nplat.mac","ПересчетПроцентовПоГрафику2", dealid ) ;
                      fix_st(dealid, new_rate_date, new_rate); 

                      que = "update ddl_leg_dbt SET t_price='" + price + "',  T_RECEIPTAMOUNT = '" + stav + "'  where t_dealid = '" + dealid + "'";
                      rs12 = LnGetRecordset(que);
                      if(rs12 != null)    end;

                      que = "select t_amount from dpmpaym_dbt where t_purpose = 11 and t_dockind = 102 and t_documentid = " + dealid;
                      rs12 = LnGetRecordset(que);
                      if (rs12.MoveNext)
                         new_percent_sum = rs12.value(0);
                      end;
                      que = "update DPRCCNTSCHED_DBT set t_sumcalc = " + new_percent_sum + " where t_datereal <> to_date('01.01.0001','dd.mm.yyyy') and t_contractid in (select t_contractid from dprccontract_dbt where t_contracttype = 7 and t_objectid in (select t_dealcode from ddl_tick_dbt where t_dealid = " + dealid + "))";
                      rs12 = LnGetRecordset(que);
                      if(rs12 != null)    end;

                      que = "update ddl_leg_dbt set t_cost = " + new_percent_sum + " where t_dealid = " + dealid;
                      rs12 = LnGetRecordset(que);
                      if(rs12 != null)    end;

                      que = "select t_principal from ddl_leg_dbt where t_dealid = " + dealid;
                      rs12 = LnGetRecordset(que);
                      if (rs12.MoveNext)
                         principal = rs12.value(0);
                      end;
                      que = "update ddl_leg_dbt set t_totalcost = " + (new_percent_sum + principal) + " where t_dealid = " + dealid;
                      rs12 = LnGetRecordset(que);
                      if(rs12 != null)    end;

                      newrez=0;
                   end;
                end;
             end;
             return CM_SELECT; 
          end;

       elif((DLG_KEY_F8  == Key) OR (DLG_KEY_SHIFT_F8  == Key)) 
          if (DealStatus == 0)
             mmasi2(0)="Отмена Удаления   ";
             mmasi2(1)="УДАЛЕНИЕ % СТАВКИ ";

             ii = Menu (mmasi2,"УКАЖИТЕ ВАРИАНТ ","УКАЖИТЕ ВАРИАНТ ");
             if ( ii < 1 )
                return;
             end;

             if ( ДАТ(rs.value("rate_date")) == ДАТ(dealdate))
                msgbox("Удаление запрещено ! Даты изменения процентов = даты выдачи !");
                return;
             end;

             rate_date = СДАТ(rs.value("rate_date"));
             que = "delete from dstd_pls_dbt where t_dizm ='" + rate_date + "' and t_id = '" + dealid + "'";
             rs12 = LnGetRecordset(que);
             if (rs12 != null)   end;  

             execmacrofile("dl_nplat.mac","ПересчетПроцентовПоГрафику", dealid ) ;

             new_rate = Новая_проц_ставка(dealid, ДАТ(rate_date) - 1);
             price = string(new_rate * (Pow(10, point )));

             que = "update ddl_leg_dbt SET t_price='" + price + "',  T_RECEIPTAMOUNT = '" + stav + "'  where t_dealid = '" + dealid + "'";
             rs12 = LnGetRecordset(que);
             if (rs12 != null)   end;  

             newrez=0;

             return CM_SELECT; 
          end;
       end;
    end;

  AddCol (col1, 0, "rate_date",   "Дата",                   10);
  AddCol (col1, 1, "rate",    "Процентная ставка",      20);
  MenuString = "График процентных ставок";

  StatusString = "Enter Редактирование F4 Поиск F8 Удаление F9 Изменение %% ставки Esc Выход";

  while( RunScroll(cmd1, 2, col1, null, @EvProc, MenuString, StatusString, null, 10, 5) )
     cmd1 = RSDRecordset(sql , RSDVAL_CLIENT, RSDVAL_STATIC );
  end;

  return newrez;

end;











