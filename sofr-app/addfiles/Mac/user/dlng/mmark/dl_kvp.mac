import PTinter,RSBDataSet,dl_plib,dlgCommon,funk,dl_kvlib; 
private  var d0,pId2,rs0,cmd2,{curdate},sql0,flag,rs05,que; 
private  var col2 = TArray();
private  var v_DealId = TArray(), v_count;

macro Kvitovka(pa1)

     // d0={curdate};
     // getdate(d0,"Введите дату:",10);

     d0=pa1;
     sql0="select c.t_dealid pId2,h.t_mesid mesid, e.t_shortname nam , c.t_dealcode dealcode, to_char(c.t_dealdate,'dd.mm.yyyy') dealdate, to_char(d.t_maturity,'dd.mm.yyyy') maturity ,";
//     sql0=sql0+ " decode(c.t_dealtype,12300,TO_CHAR(d.t_principal,'9,999,999,999.00'),12305,' ') su1 , h.t_trn imt, ( case when (select count(*) from DL_KVI_DBT ee where ee.t_dealid=c.t_dealid and ee.t_id > 0 ) > 0 then 'Сквитовано' else ' ' end) rez, ";
     sql0=sql0+ " decode(c.t_dealtype,12300,TO_CHAR(d.t_principal,'99,999,999,999.00'),12305,' ') su1 , h.t_trn imt, ( case when (select count(*) from DL_KVI_DBT ee where ee.t_dealid=c.t_dealid and ee.t_id > 0 ) > 0 then 'Сквитовано' else  ";
     sql0=sql0+ " ( case when (select count(*) from DL_KVI_DBT ee where ee.t_dealid=c.t_dealid ) > 0 then 'Принудительно' else ' ' end) ";
     sql0=sql0+ "  end) rez, ";

     sql0=sql0+ " decode(c.t_dealtype,12305,TO_CHAR(d.t_principal,'99,999,999,999.00'),12300,' ') su2, ";

     sql0=sql0+ "  (select bb.t_value  from dwlmes_dbt aa , dwlmesval_dbt bb where rownum=1 and  bb.t_mesid=aa.t_mesid  and  bb.t_index=2 and aa.t_mesid = "; 
     sql0=sql0+ "  (select aaa.t_mesid  from dwlmes_dbt aaa , dwlmesval_dbt bbb where rownum=1 and  bbb.t_mesid=aaa.t_mesid  and  bbb.t_index=3 and aaa.t_agentcode=h.t_agentcode and bbb.t_value= ";
     sql0=sql0+ "  (select b.t_value from dwlmes_dbt a , dwlmesval_dbt b , dl_kvi_dbt c where  rownum=1 and c.t_id0=h.t_mesid and  a.t_mesid =c.t_id and  b.t_mesid=a.t_mesid and b.t_index=2 )) ) vmt2, ";

     sql0=sql0+ "  (select bb.t_value  from dwlmes_dbt aa , dwlmesval_dbt bb where rownum=1 and  bb.t_mesid=aa.t_mesid  and  bb.t_index=5 and aa.t_mesid = "; 
     sql0=sql0+ "  (select aaa.t_mesid  from dwlmes_dbt aaa , dwlmesval_dbt bbb where  rownum=1 and bbb.t_mesid=aaa.t_mesid  and  bbb.t_index=3 and aaa.t_agentcode=h.t_agentcode and bbb.t_value= ";
     sql0=sql0+ "  (select b.t_value from dwlmes_dbt a , dwlmesval_dbt b , dl_kvi_dbt c where rownum=1 and  c.t_id0=h.t_mesid and  a.t_mesid =c.t_id and  b.t_mesid=a.t_mesid and b.t_index=2 )) ) funmt, ";

     sql0=sql0+ "  ( select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid=d.t_pfi ) fiid2 ";
     sql0=sql0+ "  , ( case when (select count(*) from DL_KVI_DBT ee where ee.t_dealid=c.t_dealid and ee.t_id > 0 ) > 0 then  (select gg.t_trn from dwlmes_dbt gg, DL_KVI_DBT kk  where kk.t_dealid=c.t_dealid and   t_mesid=kk.t_id  )  else ' ' end) vmt ";

     sql0=sql0+ "  from dwlmeslnk_dbt b , dwldlmm_dbt a, ddl_tick_dbt c, ddl_leg_dbt d, dparty_dbt e , dwlmes_dbt h where  b.t_objkind=512 and b.t_objid=a.t_dlmmid";
     sql0=sql0+ " and c.t_dealid=a.t_dealid and d.t_dealid=c.t_dealid  and c.t_dealdate='"+СДАТ(d0)+"' and e.t_partyid=c.t_partyid and h.t_mesid=b.t_mesid and h.t_direct !='X' ";


    //  MSGBOX( sql0);
     cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );

  macro EvProc2 (rs0, cmd2, id, key )
     if (cmd2 == DLG_INIT)	// Инициализация
        if (pId2 != "0")  // Надо найти запись
           v_count = 0;
           while ( (rs0.value ("pId2") != pId2) And (Not rs0.EOF) )  
		if (ValType(rs0.value ("pId2")) == 26)
			v_DealId(v_count) = 0;
		else
			v_DealId(v_count)= rs0.value ("pId2");
		end;
                rs0.Move(1, RELATIVE);
		v_count = v_count + 1;
            end;

        end;
        GoToScroll(rs0, true);
     elif (cmd2 == DLG_KEY)
        pId2=rs0.value ("pId2");
        if(DLG_KEY_ENTER == Key)
        return CM_SELECT;

        elif(DLG_KEY_F5 == Key) 

            if (IsExistKvit(rs0.value ("pId2")))
                   msgbox("Квитовка сообщения выполнена ранее, отмените квитовку!");
            else
                  HandKvit(rs0.value ("pId2"));
                  if (IsExistKvit(rs0.value ("pId2")))
                         msgbox("Квитовка сообщения выполнена!");
         	  end;
            end;
            return CM_SELECT;

        elif(DLG_KEY_F2 == Key) 
            return CM_SELECT;

        elif(DLG_KEY_F3 == Key) 
            mes_reading(rs0.value ("pId2"));
            return CM_SELECT;

        elif(DLG_KEY_F8 == Key) 
           que="UPDATE dwldlmm_dbt SET T_dealid =0 WHERE t_direct='X' and  t_dealid ="+ rs0.value ("pId2");   
           rs05 = LnGetRecordset(que);
           que="delete DL_KVI_DBT WHERE T_dealid ="+ rs0.value ("pId2"); 
           rs05 = LnGetRecordset(que);
           return CM_SELECT;

        elif(DLG_KEY_F9 == Key)
           for (v_count, 0, v_DealId.Size-1) 
             if ( v_DealId.Value(v_count)==0 )
                   msgbox("Входящее MT отсутствует" );
             elif(IsExistKvit(v_DealId.Value(v_count)))
                   msgbox("Квитовка сообщения выполнена ранее, отмените квитовку!");
             else
           	AutoKvit( v_DealId.Value(v_count));   
               if (IsExistKvit(v_DealId.Value(v_count)))
//                      msgbox("Квитовка сообщения выполнена!");
      	       end;
             end;
            end; //for
            return CM_SELECT;

        end;
     end;
  end;


  AddCol (col2, 0, "nam","Контрагент", 10);
  AddCol (col2, 1, "dealcode","№ сделки", 10);
  AddCol (col2, 2, "dealdate","Дата сд", 8);
  AddCol (col2, 3, "maturity","Дата вал", 8);
  AddCol (col2, 4, "su1","Cумма требований", 18);
  AddCol (col2, 5, "su2","Сумма обязательств", 18);
  AddCol (col2, 6, "fiid2","Вал", 3);
  AddCol (col2, 7, "imt","Код исходящего MT", 16);
  AddCol (col2, 8, "rez","Результат квитовки", 16);
  AddCol (col2, 9, "vmt","Код входящего MT", 14);
  AddCol (col2, 10, "vmt2","Вход.повторное MT", 15);
  AddCol (col2, 11, "funmt","Функция сообщения", 15);
//  AddCol (col2, 12, "mesid","ID входящего MT320", 10);

   while(RunScroll(cmd2, 12, col2, null, @EvProc2,"Квитовка SWIFT МТ320 за "+СДАТ(d0),"F3- Просмотр F5- Ручная квитовка  F8- Отмена квитовки по сделке F9- Автоквитовка  ESC- Выход ", null, 0, 0,135,70) )
     cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );
   end;

   exit(1);
end;


