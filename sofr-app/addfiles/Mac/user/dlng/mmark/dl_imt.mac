IMPORT fx_globals, funk, RSD, mmlibr, MmarkInter,dl_prol;
import MesInter;
import  "dl_kvlib.mac","cb_sql.mac", "dvswiftMT320.mac";
import "mtedit.mac";

    record tick( dl_tick );
    record leg ( dl_leg );

const TRANSP_SPFSCBR = 51; //А.Киселев 29.03.2019 пользовательский транспорт СПФСЦБРФ

MACRO ExecuteStep(Buffer, Document)
    private var i, s_id0, sql, rs0, rs01, s_messerr, s_messok,ii=1;
    array masm; 

    SetBuff( tick, Document );

    if ((tick.numberpack == 99 ) or (tick.partyid == _BANK_RF ))
       return 0;
    end;
   //  return 1;

    sql = "select *  from ddl_leg_dbt  where t_dealid = "+tick.dealid; 
    rs0 = LnGetRecordset(sql);
    if (rs0 != null)
       if (rs0.moveNext)
           CopyRSetToFBuff( leg, rs0 );
       end;
    end;
    if (leg.pfi == 65)
        sql="select count(*) from dwldlmm_dbt a, ddl_tick_dbt b where b.t_dealid="+tick.dealid+" and  a.t_dealid=b.t_dealid"; 
        rs01 = LnGetRecordSet(sql);
        if(rs01 != null)
          if (rs01.moveNext) 
            if (int(rs01.value(0)) > 0 )
              return 0 ;
            end;
          end;
        end;
        msgbox("Требуется сформировать mt620 !");
        return 1;
    else

       if ( ПРОЛОНГАЦИЯ(tick.dealid) > 0 )
          ii=3;
       else
          ii=1;
       end;
    
//А.Киселев 05.04.2019
//     if ( tick.CONFTPID == 2 )
       if ( (tick.ConfTpId == TRANSP_SWIFT) or (tick.ConfTpId == TRANSP_TELEX) )  //SVE 27.07.2020 513574 для транспортов SWIFT и TELEX используем отправку через МБР
          tick.ConfTpId = TRANSP_SWIFT;
          СоздатьСообщение (ii, tick,leg);
       elif (tick.ConfTpId == TRANSP_SPFSCBR)                                     //SVE 27.07.2020 513574 для СПФС формирование и отправка через Payments
            set_mtsend_flag(1);
               DV_DealsGenMesMT320Paym( tick.dealid );
            if(get_mtsend_flag() == "0")
              return 1;
             end;
       end;
//А.Киселев 05.04.2019

    end;

    return 0 ;
END;


MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -откат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */  


  private var sql,rs01,rs05,pplid,acc4,pplid0;
  SetBuff(tick, FirstDoc );

  if ( CommitOrRollback == 1 )
        sql="select count(*) from dwldlmm_dbt a, ddl_tick_dbt b where b.t_dealid="+tick.dealid+" and  a.t_dealid=b.t_dealid";
        rs01 = LnGetRecordSet(sql);
        if(rs01 != null)
          if (rs01.moveNext) 
            if (int(rs01.value(0)) > 0 )
               sql="update dwldlmm_dbt set  t_dealcodeps=substr(t_dealcode,4), t_state=20  where t_dealid="+tick.dealid; 
               rs05 = LnGetRecordSet(sql);
            end;
          end;
        end;

       if ( tick.dealtype == 12305 )
         pplid=plat_dil(tick.dealid,"102","9","paymentid");
         opmpr(pplid,tick.dealid,9);
         acc4 =MM_acc(tick.dealid,111);
         sql="update dpmpaym_dbt set t_payeraccount='"+acc4+"' where t_paymentid="+pplid;
         rs05 = LnGetRecordSet(sql);
         sql="update daccount_dbt set t_userfield3='1' where t_account='"+acc4+"'";
         rs05 = LnGetRecordSet(sql);

          if ( ПРОЛОНГАЦИЯ(tick.dealid) > 0 )
            sql="update daccount_dbt set t_userfield3='' where t_account='"+acc4+"'";
            rs05 = LnGetRecordSet(sql);

            sql="update daccount_dbt set t_userfield3='1' where t_account='"+acc4+"'";
            rs05 = LnGetRecordSet(sql);
          end;



         pplid=plat_zak(tick.dealid,"102","11",1,"paymentid");
         acc4 =MM_acc(tick.dealid,117);
         sql="update daccount_dbt set t_userfield3='1' where t_account='"+acc4+"'";
           rs05 = LnGetRecordSet(sql);



       elif (( tick.dealtype == 12300 ) or  ( tick.dealtype == 12301 ))
         pplid=plat_zak(tick.dealid,"102","10",0,"paymentid");
         opmpr(pplid,tick.dealid,10);
         acc4 =MM_acc(tick.dealid,111);
         if ( tick.dealtype == 12301 )
            acc4 =MM_acc(tick.dealid,924);
            pplid0=plat_dil(tick.dealid,"102","9","paymentid");
            sql="update dpmpaym_dbt set t_receiveraccount='"+acc4+"' where t_paymentid="+pplid0;
            rs05 = LnGetRecordSet(sql);


         end;

         sql="update dpmpaym_dbt set t_payeraccount='"+acc4+"' where t_paymentid="+pplid;
         rs05 = LnGetRecordSet(sql);
         sql="update daccount_dbt set t_userfield3='1' where t_account='"+acc4+"'";
         rs05 = LnGetRecordSet(sql);

         if ( ПРОЛОНГАЦИЯ(tick.dealid) > 0 )
            sql="update daccount_dbt set t_userfield3='' where t_account='"+acc4+"'";
            rs05 = LnGetRecordSet(sql);

            sql="update daccount_dbt set t_userfield3='1' where t_account='"+acc4+"'";
            rs05 = LnGetRecordSet(sql);
         end;



         pplid=plat_zak(tick.dealid,"102","11",1,"paymentid");
         opmpr(pplid,tick.dealid,11);
         acc4 =MM_acc(tick.dealid,118);
         sql="update dpmpaym_dbt set t_payeraccount='"+acc4+"' where t_paymentid="+pplid;
         rs05 = LnGetRecordSet(sql);
         sql="update daccount_dbt set t_userfield3='1' where t_account='"+acc4+"'";
          rs05 = LnGetRecordSet(sql);


       end;


  end;

  return 0;
END;


MACRO CheckStepAction( mes, primdoc, DocKind, ID_Operation )

  private var sql,rs01,rs05;
  SetBuff(tick, primdoc );
  if( mes == OP_BACKOUT_STEP )
        sql="select count(*) from dwldlmm_dbt a, ddl_tick_dbt b where b.t_dealid="+tick.dealid+" and  a.t_dealid=b.t_dealid"; 
        rs01 = LnGetRecordSet(sql);
        if(rs01 != null)
          if (rs01.moveNext) 
            if (int(rs01.value(0)) > 0 )
               sql="update dwldlmm_dbt set t_state=10  where t_dealid="+tick.dealid+" and t_state = 20"; 
               rs05 = LnGetRecordSet(sql);
            end;
          end;
        end;

  end;
  return 0;

END;

