import oralib, likepy, globals,fx_globals, CTInter;
IMPORT mmarkinter, OprInter,funk,dl_plib,dl_lib;



   private var que,rs9,ii,{curdate},da,dealid,rs5,rs,rs51,da2;

   var docKind=102, sql,nbank,fiid,debet,dealcode,sta,das,dda;
   var exec, command1, command2, chainblockId,chainblockId0=3000019 ;


   private var jj0,jj,;



macro Ins_kat( par10, par11,par12)
  private var T_DOCUMENTID;
  private var  que0, rs0, cmd, v_attrid;


  dda=SDAT(da);
  que0="select count(*) from  dobjatcor_dbt  where t_objecttype=103 and t_object = lpad("+par10+",34,'0') and t_groupid="+par11 ;
  rs0 = LnGetRecordSet(que0);
  if(rs0 != null)
     if (rs0.moveNext) 
        v_attrid =int(rs0.value(0)); 
     end;	
  end;

  if (v_attrid == 0 )
     que0="INSERT INTO dobjatcor_dbt (T_OBJECTTYPE,T_GROUPID,T_ATTRID,T_OBJECT,T_GENERAL,T_VALIDFROMDATE,T_OPER,T_VALIDTODATE,T_SYSDATE,T_SYSTIME,T_ISAUTO,T_ID) "+
     "VALUES (103,"+par11+","+par12+",LPAD("+par10+", 34,'0'),chr(88),to_date('"+dda+"'),"+{oper}+",to_date('31129999','DDMMYYYY'),trunc(sysdate),to_date('01010001'||to_char(sysdate,'hhmiss'),'DDMMYYYYhhmiss'),chr(88),dobjatcor_dbt_SEQ.Nextval)";
      // msgbox(que0);
      rs0 = LnGetRecordSet(que0);
  else
     que0="update dobjatcor_dbt set t_attrid = "+ par12+" where  t_objecttype=103  and t_object = lpad("+par10+",34,'0') and t_groupid="+par11 ;
     rs0 = LnGetRecordSet(que0);
  end;

end;



macro fix_st(pa1,pa2,pa3)

  private var que,rs93,rs94,rs95,pst,dasd;

  que="SELECT COUNT(*) FROM dprcrateval_dbt prcrateval INNER JOIN dprccontract_dbt prccntr ON prccntr.t_RateID = prcrateval.t_RateID";
  que=que+" INNER JOIN ddl_tick_dbt tick ON tick.t_Dealcode = t_ObjectID ";
  que=que+" WHERE t_ContractType = 7 AND t_ObjectType = 103 AND t_DealID = "+pa1+"AND TO_CHAR(T_RATEDATE,'DD.MM.YYYY')='"+pa2+"'";
   rs93 = LnGetRecordSet(que);
   if(rs93 != null)
     while(rs93.moveNext())

        if (rs93.value(0) == 0 )

          que="SELECT * FROM dprcrateval_dbt prcrateval INNER JOIN dprccontract_dbt prccntr ON prccntr.t_RateID = prcrateval.t_RateID ";
          que=que+" INNER JOIN ddl_tick_dbt tick ON tick.t_Dealcode = t_ObjectID ";
          que=que+" WHERE t_ContractType = 7 AND t_ObjectType = 103 AND t_DealID = "+pa1; 
          rs94 = LnGetRecordSet(que);
   	  if(rs94 != null)
            if (rs94.moveNext) 
             que = "INSERT INTO dprcrateval_dbt Values("+rs94.value("t_rateid")+",'"+pa2+"',"+pa3+",'"+rs94.value("t_macrofile")+"','"+rs94.value("t_macroproc")+"','"+rs94.value("t_variablename")+"',"+rs94.value("t_variableperiod")+","+rs94.value("t_variabledays")+",'"+rs94.value("t_isprognoz")+"')";
             rs94 = LnGetRecordset(que);
       	    end;
       	  end;
/*
  t_rateid         NUMBER(10) not null,
  t_ratedate       DATE not null,
  t_rate           FLOAT(53),
  t_macrofile      VARCHAR2(255),
  t_macroproc      VARCHAR2(255),
  t_variablename   VARCHAR2(50),
  t_variableperiod NUMBER(5),
  t_variabledays   NUMBER(5),
  t_isprognoz      CHAR(1)

*/

        else

          pst=0;
          que="SELECT prcrateval.T_RATE , prcrateval.t_RateID id  FROM dprcrateval_dbt prcrateval INNER JOIN dprccontract_dbt prccntr ON prccntr.t_RateID = prcrateval.t_RateID";
          que=que+" INNER JOIN ddl_tick_dbt tick ON tick.t_Dealcode = t_ObjectID ";
          que=que+" WHERE t_ContractType = 7 AND t_ObjectType = 103 AND t_DealID = "+pa1+"AND TO_CHAR(T_RATEDATE,'DD.MM.YYYY')='"+pa2+"'";
          rs94 = LnGetRecordSet(que);
   	  if(rs94 != null)
            if (rs94.moveNext) 
       	      pst=rs94.value(0);
              if (pst != pa3 )
                que = "update dprcrateval_dbt SET t_rate = "+pa3+" where t_RateID ="+rs94.value("id")+" and TO_CHAR(T_RATEDATE,'DD.MM.YYYY')='"+pa2+"'";
                rs95 = LnGetRecordset(que);
              end;


       	    end;
       	  end;


        end;
     end;
   end;

end;





macro kk(par1)

   private var rs91,rs92;

   que="select * from ddlreslnk_dbt where t_type=3 and t_id=1904 ";
   rs91 = LnGetRecordSet(que);
   if(rs91 != null)
     while(rs91.moveNext())

      que="insert into ddlreslnk_dbt a ";
      que=que+"(select  0, "+par1+",  t_childid,  t_type,  t_lnkdate,  t_qualitycategory, t_reservepercent, t_securityamount, t_securitycurrency, t_reservekind,"; 
      que=que+" t_reserveamount, t_reservedate,  t_flag1,  t_ismanual, t_riseqc,  t_reservesubkind, t_typebase, t_qualitycategoryswap,";
      que=que+" t_reservepercentswap,  t_reserveamountswap, t_reserveassesamount, t_comid,t_isexpcom   from ddlreslnk_dbt where t_type=3 and t_id=1904 )" ;
      // msgbox(que);
      rs92 = LnGetRecordSet(que);


     end;
   end;


end;





   jj0=0;
   da=({curdate});
   getdate(da,"ДАТА",10);


   que="select count(*) from ddl_tick_dbt a, ddl_leg_dbt b where a.t_dealtype=12305 and t_dealstatus=10 and b.t_dealid=a.t_dealid ";
   rs9 = LnGetRecordSet(que);
   if(rs9 != null)
     while(rs9.moveNext())

      jj0=int(rs9.value(0));
     end;
   end;

   InitProgress( jj0, "Проверка перед резервами МБК" );  
   jj=0;
   que="select a.t_dealdate dealdate,a.t_dealcode dealcode  ,a.t_dealid dealid,b.t_maturity maturity,c.t_paymstatus  paymstatus,c.t_paymentid paymentid  from ddl_tick_dbt a, ddl_leg_dbt b, dpmpaym_dbt c ";
   que=que+" where a.t_dealtype=12305 and t_dealstatus=10 and b.t_dealid=a.t_dealid  and c.t_dockind=102 and c.t_documentid=a.t_dealid and c.t_purpose=9 ";
   // que=que+" and a.t_dealcode='IAM:702000'";
   rs9 = LnGetRecordSet(que);
   if(rs9 != null)
     while(rs9.moveNext())
       useprogress(jj);
       jj=jj+1;

      que="update dmcaccdoc_dbt   set t_docid=0 where t_docid="+rs9.value("dealid")+" and t_dockind=102 and  (t_catnum=5125 or t_catnum=5126) ";
      rs5 = LnGetRecordSet(que);

       das=DAT(rs9.value("maturity"));

       if (das <= da)
         Ins_kat(rs9.value("dealid") ,2,1);
         println("Снять резервирование",rs9.value("dealcode"),"-",DAT(rs9.value("maturity")));
       else
           println("Установка КК ",rs9.value("dealcode"));
            
            que = "select count(1) as cnt from ddlreslnk_dbt rlnk where (rlnk.t_type = 3) and (rlnk.t_parentid = " + rs9.value("dealid") + ")";
            // msgbox(que);
            rs = RsdRecordset(que);
            rs.MoveNext();
            if (rs.value("cnt") > 0)
               // println("Уже задана группа риска на указанную дату");
            else
              kk(rs9.value("dealid"));
            end;



       end;


       das=DAT(rs9.value("dealdate"));
       da2=SDAT(da);
       da2="01"+substr(da2,3);
       da2=DAT(da2);
       if (das > da2 )
         Ins_kat(rs9.value("dealid") ,5,1);
         println("Категория сделки ",rs9.value("dealcode"),"-",DAT(rs9.value("dealdate")));
       end;


      if (rs9.value("paymstatus") != 32000)
        que="update dpmpaym_dbt set t_paymstatus=32000 where t_paymentid="+rs9.value("paymentid");
        rs5 = LnGetRecordSet(que);
         println("Статус платежа ",rs9.value("dealcode"));
      end;


      end;
   end;



   que="select a.t_dealid dealid,b.t_purpose pu,b.t_baseamount baseamount,to_char(b.t_valuedate,'dd.mm.yyyy') da from ddl_tick_dbt a , dpmpaym_dbt b where a.t_bofficekind=102 and a.t_dealstatus < 20 ";
   que=que+" and b.t_documentid=a.t_dealid and b.t_dockind=102 and b.t_purpose > 9  order by t_dealid ";

   rs9 = LnGetRecordSet(que);
   if(rs9 != null)
     while(rs9.moveNext())
      dealid=rs9.value("dealid");

             if ( rs9.value("pu") == 10 )
               ii=1;
             else
               ii=2;
             end;

      // --
      que = "select count(*) from dmmpmgraph_dbt where t_graphtype ="+ii+" and to_char(t_date,'dd.mm.yyyy')='"+rs9.value("da")+"' and  t_documentid ="+dealid;
      // msgbox(que);
      rs5 = LnGetRecordSet(que);
      if (rs5 != null)
        if (rs5.moveNext) 
          if (rs5.value(0) == 0)

             que = "INSERT INTO dmmpmgraph_dbt Values(0,"+dealid+","+ii+","+rs9.value("baseamount")+",'"+rs9.value("da")+"')";
             rs5 = LnGetRecordSet(que);
          end;
        end;
      end;
     // --
         // ------
     end;
   end;



   que="select a.t_dealid dealid from ddl_tick_dbt a where a.t_bofficekind=102 and a.t_dealstatus < 20 ";
   rs9 = LnGetRecordSet(que);
   if(rs9 != null)
     while(rs9.moveNext())
      dealid=rs9.value("dealid");
  
         // -- СТ --
         que="select to_char(a.t_dizm,'dd.mm.yyyy') dizm, a.t_stav/1000000 stav  from dstd_pls_dbt a  where  a.t_id="+dealid;
    	 rs5 = LnGetRecordSet(que);
    	 if(rs5 != null)
      	   while(rs5.moveNext())
              fix_st(dealid,rs5.value("dizm"),rs5.value("stav"));
           end;
         end;
         // ------

     end;
   end;








   RemProgress; 

 end;




