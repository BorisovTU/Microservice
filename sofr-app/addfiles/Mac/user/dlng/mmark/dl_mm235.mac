
IMPORT globals,OprInter,"cb_sql.mac",funk,mmcarry,mmcnst_j,mmlibr,dl_plib,dl_lib,dl_plat,dl_platv;

 private var nPaymentID,d1,soob,chpog,NDOG;
 private var newdata,que,rs,rs0,rs1,ss,debet,vkom,credit,CRE,dsob,d0,ss1,s1,np,j,i,ku,curdate,
 SumComm,SumComm2,CurComm,Document1,ss0,prol,ss01,debet3,credit3,credit2,debet2,dbcr,plid,plid2 ;
 private array mas;
 var  at = MM_Carry;
 private var sta,pu,dpl,is,ddata,pld00,nsum,nsum2,{curdate},j9,stnal,nalog,tek_ost,sup,gensog,rs01,nbank,sclient,snalog;


record deal (dl_tick);
record leg (dl_leg);


MACRO Ex (dealid, daz)

   private var samount,nrate;

   soob=" ";
   pld00=daz;
   ddata= ‘„€’(pld00);
   dpl="11";
   InitProgress( 100, "« â¥¦¨ ¯® ¯®£ è¥­¨î ŒŠ " );  
   j9=10;
 que = "select b.t_dealid,a.t_purpose,a.t_baseamount,a.t_paymentid from dpmpaym_dbt a, ddl_tick_dbt b, ddl_leg_dbt u where  b.t_dealid="+dealid+" and  a.t_valuedate = '"+ddata+"'  and a.t_dockind=102 and a.t_purpose > 9 and  a.t_paymstatus != 55  and  a.t_paymstatus <  32000  and  b.t_dealid=a.t_documentid   and u.t_dealid=b.t_dealid  order by  a.t_purpose ";
 rs0 = LnGetRecordset(que);
 if (rs0 != null)
  while (rs0.moveNext())
// -------------

      ss=string(rs0.value("t_dealid"));
      que = "select *  from ddl_tick_dbt  where t_dealid = "+ss; 
      rs1 = LnGetRecordset(que);
      if (rs1 != null)
        while (rs1.moveNext())
            CopyRSetToFBuff( deal, rs1 ) ;
            j9=j9+10;
            useprogress(j9);
            message("Œˆ“’—Š“ !! ˆ„…’ €‘—…’ !");
            que = "select *  from ddl_leg_dbt  where t_dealid = "+ss; 
            rs = LnGetRecordset(que);
            if (rs != null)
               if (rs.moveNext)
                  CopyRSetToFBuff( leg, rs );
                  nPaymentID=rs0.value("t_paymentid"); 
                  pu=rs0.value("t_purpose");
                  // ndog=Šà¥¤_¤®£®¢®à(rs.value("t_dealid"));
                  ndog="!!!";
                  sup=rs0.value("t_baseamount");
                  gensog=" ü ";
                  d0=leg.start;
                  d1=leg.maturity;
                  CurComm=leg.pfi;
                  // SumComm2=leg.cost;
                  // SumComm=leg.principal;

                  SumComm=plat_dil0(deal.dealid,"102","10",ddata,"baseamount");
                  nbank=plat_dil(deal.dealid,"102","10","payerbankid");
                  ss0=" ";
                  ku=double("1"+substr("0000000000",1,leg.point));
                  d1=date(dpl);

                               if  (pu == 10 )

                plid=nPaymentID;
                ss0="‚ë¯« â  ®á­®¢­®£® ¤®«£  ¯® á¤¥«ª¥ "+deal.dealcode+" ®â "+‘„€’(deal.dealdate) ;

                credit=account_corr(CurComm,nbank);

                Debet=ˆŠ…ˆ’œ2("„",deal.dealid);

	        credit=account_corr(CurComm,nbank);
        	at.AccountPayer    = credit;	  
        	at.AccountReceiver = debet; 
        	at.FIIDPayer      = CurComm;
        	at.FIIDReceiver   = CurComm;
                at.SumPayer       = SumComm;
        	at.SumReceiver    = SumComm;
        	at.Chapter        = 1;
        	at.Ground         = ss0;
        	at.PaymentID      = plid;
        	if(not at.carry())
           		msgbox("Error !");
           		return false;
        	end;




                                elif  (pu == 11 )
                plid2=nPaymentID;
                ss0="®£ è¥­¨¥ ¯à®æ¥­â®¢ ¯® á¤¥«ª¥ "+deal.dealcode+" ®â "+‘„€’(deal.dealdate) ;
                Debet=ˆŠ…ˆ’œ2("-% ª ¯®£ è¥­¨î",deal.dealid);

                SumComm2=plat_dil0(deal.dealid,"102","11",ddata,"baseamount");
	        credit=account_corr(CurComm,nbank);

        	 at.AccountPayer    = credit; 	  
        	 at.AccountReceiver = debet;
        	 at.FIIDPayer      = CurComm;
        	 at.FIIDReceiver   = CurComm;
        	 at.SumPayer       = SumComm2;
        	 at.SumReceiver    = SumComm2;

        	 at.Chapter        = 1;
        	 at.Ground         = " "+ss0;
        	 at.PaymentID      = plid;
        	 if(not at.carry())
           		msgbox("Error !");
           		return false;
        	 end;
                                  end;
               end;
            end;

      end;
   end;

// ---------

  end;
 end;

   RemProgress; 

   return 0;
END;


