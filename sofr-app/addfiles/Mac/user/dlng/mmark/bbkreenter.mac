import rsd, globals;

record panel    (reentry, "mbk_oper.lbr" ) dialog;
record errpanel (err    , "mbk_oper.lbr" ) dialog;

var rs, sql;
var code = 0;
var pSumma = 0, pPercent = 0, pDate1 = date(0,0,0), pDate2= date(0,0,0);
var rSumma = 0, rPercent = 0, rDate1 = date(0,0,0), rDate2= date(0,0,0);

macro PanelErr (dlg, cmd, id, key ) 
  if (cmd == DLG_INIT)
     dlg.Summa   =pSumma  ;   
     dlg.Percent =pPercent; 
     dlg.Date1   =pDate1  ;   
     dlg.Date2   =pDate2  ;   

     dlg.xSumma   =rSumma  ;   
     dlg.xPercent =rPercent; 
     dlg.xDate1   =rDate1  ;   
     dlg.xDate2   =rDate2  ;   
     updateFields (dlg);

  end;
  if(cmd == DLG_KEY)
    if(key == 13) 
      return CM_IGNORE;
    elif(key == 27) 
      return CM_CANCEL;
    else
      return CM_IGNORE;
    end;
  end;
end;


macro mainPanel (dlg, cmd, id, key ) 
   if (cmd == DLG_INIT)
   end;
   if(cmd == DLG_KEY)
     if (key == 323) 
        sql = rsdcommand ("select leg.t_cost, leg.t_principal, leg.t_start, leg.t_maturity  from ddl_tick_dbt tick, ddl_leg_dbt leg where tick.t_bofficekind = 102 and tick.t_dealcode='208' and leg.t_dealid = tick.t_dealid ");
        rs  = rsdrecordset (sql);
        if (rs.movenext)
           if ((rs.value("t_cost") != dlg.Percent) or
               (rs.value("t_principal") != dlg.Summa  ) or
               (rs.value("t_start") != dlg.Date1) or
               (rs.value("t_maturity") != dlg.Date2) )
              msgbox ("Верификация не выполнена !");
              pSumma   = dlg.Summa; 
              pPercent = dlg.Percent; 
              pDate1   = dlg.Date1;
              pDate2   = dlg.Date2;

              rSumma   = rs.value("t_cost");
              rPercent = rs.value("t_principal");
              rDate1   = rs.value("t_start");
              rDate2   = rs.value("t_maturity"); 
              code = 3;
              rundialog ( errpanel, "PanelErr" );
           else
              msgbox ("Верификация выполнена !");
              code = 5;
           end;
        end;
        return CM_CANCEL;

    elif (key == 27) 
       msgbox ("Верификация не выполнена !");
       code = 9;
       return CM_CANCEL;
    elif ((key == 13) and (id == 3));
       setfocus (dlg, 0);
       return CM_IGNORE;
    end;
  end;
end;


rundialog ( panel, "mainPanel" );
msgbox (code);
exit (1)