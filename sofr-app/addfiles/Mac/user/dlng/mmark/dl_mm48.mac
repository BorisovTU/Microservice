import InsCarryDoc, CurrInter, MmarkInter,mmlibr, mmcarry, mmcnst_j, mmplib,dl_lib,fx_globals;

RECORD tick (dl_tick);
RECORD leg (dl_leg);



/*----------------------------------------------------------------------------
    Выполнение шага
----------------------------------------------------------------------------*/
MACRO ExecuteCaseStep(OperationKind, StepNumber, Document, DocKind)

    var deal_pd ,acc0,acc1,rez,nflag01,nflag02,nkamount,nkfiid,nvkom,rs1,que,eskom;
    var  at = MM_Carry;


    SetBuff (tick,Document);

    que = "select *  from ddl_leg_dbt  where t_dealid ="+tick.DealID;
    rs1 = LnGetRecordSet(que);
    if (rs1 != null)
        while (rs1.moveNext())
          CopyRSetToFBuff(leg, rs1 ) ;
        end;
    end;
    deal_pd = MMFirstDoc(DL_IBCDOC, tick.DealID, true);

/*
   входные данные
   dealid сделки
   nvkom - вид комиссии (оно равно t_suppurpose в платеже (dpmpaym_dbt)
   2- комиссия уступки
   3- комиссия за выданный кредит
   4- комиссия за управление


   acc - счет по расчетам
   eskom      - комиссия  ( 1 есть, 0 - нет)
   nflag01    - кто платит комиссию   (0 - банк, 1 - контрагент);
   nflag02    - вариант комисии  (0 -  процент комиссии от суммы сделки, 1- фиксированная сумма процентов)
   nkamount   - сумма процентов или сумма комиccии
   nkfiid     - fiid валюты комиссии

*/

     // -- формальный ввод исходных данных --  ТРЕБУЕТСЯ ОПРЕДЕЛИТЬ ДАННЫЕ ЧЕРЕЗ SELECT С ТАБЛИЦЫ УСТУПКИ
     eskom    = IsExistComUstup(tick.DealID);
     nvkom    = 2;
     nflag01  = IsContragentComPayUstup(tick.DealID);
     nflag02  = IsPercentComUstup(tick.DealID);
     nkamount = GetProcComUstup(tick.DealID);
     nkfiid   = GetFiidComUstup(tick.DealID); 

    if ( eskom == 0 )
       return "50";
    end;

    if ( nflag01 == 0 )
      if ((leg.pfi != nkfiid) and ( nkfiid == 0 ))
        if(not deal_pd.ActualAccount("СЧЕТ_47423B", acc0, NULL, deal_pd.GetFIRoleByCategory("СЧЕТ_47422", 0), NULL, deal_pd.GetTick().DealDate, 0))
          return 1;
        end; 
      else
        if(not deal_pd.ActualAccount("СЧЕТ_47423", acc0, NULL, deal_pd.GetFIRoleByCategory("СЧЕТ_47422", deal_pd.GetLeg().PFI), NULL, deal_pd.GetTick().DealDate, deal_pd.GetLeg().PFI))
          return 1;
        end; 
      end;
    else
      if ((leg.pfi != nkfiid) and ( nkfiid == 0 ))
        if(not deal_pd.ActualAccount("СЧЕТ_47422B", acc0, NULL, deal_pd.GetFIRoleByCategory("СЧЕТ_47422", 0), NULL, deal_pd.GetTick().DealDate, 0))
          return 1;
        end; 
      else
        if(not deal_pd.ActualAccount("СЧЕТ_47422", acc0, NULL, deal_pd.GetFIRoleByCategory("СЧЕТ_47422", deal_pd.GetLeg().PFI), NULL, deal_pd.GetTick().DealDate, deal_pd.GetLeg().PFI))
          return 1;
        end; 
      end;
    end;


    rez=execmacrofile("dl_pkom.mac","kom_plat", tick.DealID,nvkom,acc0,nflag01,nflag02,nkamount,nkfiid) ;
    if ( rez == 1 )
        msgbox("Платеж по комиссии не сформирован !");
    end;


    return "49";
END;




MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -откат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */  

  SetBuff(tick, FirstDoc );

  if ( CommitOrRollback == 2 )
  end;

  return 0;
END;











