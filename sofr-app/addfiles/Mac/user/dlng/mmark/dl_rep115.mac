/***********************************************************
 Сделки МБК за дату
************************************************************/

import RSBDataSet, dlgCommon,funk,dl_plib,"fiInfo.mac", "or_tools.mac", "dlutils.mac";
IMPORT FIInter,rsexts,oralib,likepy,rcw;


  MACRO  new_file(dir0,nname)
    FILE fn () txt  ;
    var DirList = TDirList;
    private var  name, nxltfile ,rez=0,ff;
        nxltfile = dir0+nname;
  DirList.List(nxltfile, "F");
        if( DirList.Count == 1 )
       ff=dir0+nname;
       if (not Open(fn,ff ))
       else
                 rez=1;
           Close (fn);
       end;
        end;
        return rez;
  END;



Macro Получить_Курс00 ( Rate, OtherFI, DateR, Type )

    var stat;
    record RATEDEF ( ratedef );
    SetParm (0, $0);
    if ( ValType (Type) == V_UNDEF )
        stat = ПолучитьКурс (RATEDEF, 0, OtherFI);
    else
        stat = ПолучитьКурс (RATEDEF, 0, OtherFI, Type);
    end;

    if ( stat != 0 ) return 1; end;
    stat = ПолучитьЗначениеКурса (RATEDEF, DateR);
    if ( stat != 0 ) return 1; end;

    SetParm (0, RATEDEF.RATE/10000);
    return 0;
End;





macro Scale(pa1)
 private var que,rs51,nrez=0;

   que="select t_scale from dratedef_dbt  where t_otherfi="+pa1;
   rs51 = LnGetRecordSet(que);
   if(rs51 != null)
     if (rs51.moveNext) 
        nrez=rs51.value(0);
     end;
   end;
   return nrez;

end;



     private var nach_tabl=6; // до строки 6 - "шапка" таблицы
     private var sql0, sql, pdir, xltfile, file_out, par0, ob,ii=1,jj=3, str, ind_cl_pos,{curdate},dat,S1,S2,d3,nnn,kd;
     private var dat2,is2,valuedate,price,acc0,que,rs45,irez,dealid,nndealid,vari,xltfile0,xltfile2;

     if( IsRunFromWine( true ) )
        var jvm = CreateObject("rsjvm", "TJavaHost", "GlobalJavaHost");
        var reportCreator = jvm.CallStaticMethod("ru.softlab.rsbank.poireports.ReportCreator", "getInstance");
     else
        var obj = CreateObject("rsax", "TRsAxServer", "RsAxServer", false);
     end;

     Var shell = CreateObject ("rsax", "TRsAxServer", "RsAxServer", false).CreateComObject ("WScript.Shell");
     Var MyDocument = shell.RegRead ("HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\\Personal");


MACRO mbk1()
    private var rs9,que,rs91,nfiid,rez,rezz,nrate,rs5,csum;
       rez=0;
       que = "SELECT unique(c.t_code_currency)  FROM daccount_dbt c where  (substr(c.t_balance,1,3)='320' or substr(c.t_balance,1,3)='321' or substr(c.t_balance,1,3)='324')  order by c.t_code_currency  ";
       rs91 = LnGetRecordSet(que);
       if(rs91 != null)
        while(rs91.moveNext())
          nfiid=int(rs91.value(0));
          rezz=0;


          if ( nfiid == 0 )
            que = "SELECT nvl(sum(abs(rsb_account.resta(c.t_account,to_date('"+dat+"'),1,null)) ),0) rest FROM daccount_dbt c,  dmcaccdoc_dbt cc,  ddl_leg_dbt ee where c.t_code_currency="+nfiid+" and  (substr(c.t_balance,1,3)='320' or substr(c.t_balance,1,3)='321' or substr(c.t_balance,1,3)='324')";
          else
            que = "SELECT nvl(sum(abs(rsb_account.restac(c.t_account, c.t_code_currency,to_date('"+dat+"'),1,null))  ),0) rest FROM daccount_dbt c,  dmcaccdoc_dbt cc, ddl_leg_dbt ee where c.t_code_currency="+nfiid+" and   (substr(c.t_balance,1,3)='320' or substr(c.t_balance,1,3)='321' or substr(c.t_balance,1,3)='324')";
          end;
            que=que+" and cc.t_account=c.t_account and cc.t_dockind=102 and cc.t_catid=111  and (select count(*) from  dobjatcor_dbt a  where a.t_objecttype=3 and a.t_attrid=5 and a.t_object = lpad(c.t_client,10,'0') and a.t_groupid=13) = 0 ";
            que=que+" and ee.t_dealid=cc.t_docid  and ee.t_maturity > to_date('"+dat+"') and ee.t_start <= to_date('"+dat+"')"; 
           //  msgbox(que);

          rs9 = LnGetRecordSet(que);
          if(rs9 != null)
           if (rs9.moveNext) 

              rezz=rs9.value(0);
           end;
          end;

          if ( nfiid > 0 )

            if (0 != Получить_Курс00(nrate, nfiid, ДАТ(dat)))
               Msgbox("Не возможно получить курс за ", dat);
               return 1;
            end;
            rezz=rezz*nrate/Scale(nfiid);
            // msgbox(rezz);
          end;


          rez=rez+rezz;
           // msgbox(string(rez:a)," ",string(rezz:a));
        end;
      end;


      rez=round(rez/1000,0);
      rez=int(rez);

      // msgbox(string(rez:a));



      return rez;

END;


MACRO mbk5()
    private var rs9,que,rs91,nfiid,rez,rezz,nrate,rs5;
       rez=0;
       que = "SELECT unique(c.t_code_currency)  FROM daccount_dbt c where c.t_code_currency < 10 and   substr(c.t_balance,1,3)='324' ";
       que=que+" and (select count(*) from  dobjatcor_dbt a  where a.t_objecttype=3 and a.t_attrid=5 and a.t_object = lpad(c.t_client,10,'0') and a.t_groupid=13) > 0 ";

       rs91 = LnGetRecordSet(que);
       if(rs91 != null)
        while(rs91.moveNext())
          nfiid=int(rs91.value(0));
          rezz=0;

          if ( nfiid == 0 )
            que = "SELECT nvl(sum(abs(rsb_account.resta(c.t_account,to_date('"+dat+"'),1,null)) ),0) rest FROM daccount_dbt c, dmcaccdoc_dbt cc where c.t_code_currency="+nfiid+" and  (substr(c.t_balance,1,3)='324')";
          else
            que = "SELECT nvl(sum(abs(rsb_account.restac(c.t_account, c.t_code_currency,to_date('"+dat+"'),1,null))  ),0) rest FROM daccount_dbt c, dmcaccdoc_dbt cc where c.t_code_currency="+nfiid+" and   ( substr(c.t_balance,1,3)='324')";
          end;
            que=que+"  and cc.t_account=c.t_account and cc.t_dockind=102 and cc.t_catid=198 and (select count(*) from  dobjatcor_dbt a  where a.t_objecttype=3 and a.t_attrid=5 and a.t_object = lpad(c.t_client,10,'0') and a.t_groupid=13) > 0 ";

           // msgbox(que);
          rs9 = LnGetRecordSet(que);

          if(rs9 != null)
           if (rs9.moveNext) 

              rezz=rs9.value(0);
           end;
          end;

          if ( nfiid > 0 )

            if (0 != Получить_Курс00(nrate, nfiid, ДАТ(dat)))
               Msgbox("Не возможно получить курс за ", dat);
               return 1;
            end;
            // msgbox(nrate);
            rezz=rezz*nrate/Scale(nfiid);

          end;


          rez=rez+rezz;

          // msgbox(string(rez:a)," ",string(rezz:a));
        end;
      end;


      rez=round(rez/1000,0);
      rez=int(rez);

      // msgbox(string(rez:a));


      return rez;

END;


/*
MACRO mbk9()
    private var rs9,que,rs91,nfiid,rez,rezz,nrate,rs5;
       rez=0;
       que = "SELECT unique(c.t_code_currency)  FROM daccount_dbt c where  (c.t_balance='32027' or c.t_balance='32028' or c.t_balance='32116' or c.t_balance='32117' or c.t_balance='47805' or c.t_balance='47806' or (c.t_balance='47465' and c.t_client = 343) or (c.t_balance='47466' and c.t_client = 343))  order by c.t_code_currency  "; 
              rs91 = LnGetRecordSet(que);
       if(rs91 != null)
        while(rs91.moveNext())
          nfiid=int(rs91.value(0));
          rezz=0;

          if ( nfiid == 0 )
          //  que = "SELECT nvl(sum(abs(rsb_account.resta(c.t_account,to_date('"+dat+"'),1,null)) ),0) rest FROM daccount_dbt c,  dmcaccdoc_dbt cc where c.t_code_currency="+nfiid+" and  (c.t_balance='32027' or c.t_balance='32028' or c.t_balance='32116' or c.t_balance='32117' or c.t_balance='47805' or c.t_balance='47806' or (c.t_balance='47465' and c.t_client = 343) or (c.t_balance='47466' and c.t_client = 343))";
            que = "SELECT nvl(sum(abs(rsb_account.resta(c.t_account,to_date('"+dat+"'),1,null)) ),0) rest FROM daccount_dbt c,  dmcaccdoc_dbt cc where c.t_code_currency="+nfiid+" and  (c.t_balance='32027' or c.t_balance='32028' or c.t_balance='32116' or c.t_balance='32117' )";
          else
            que = "SELECT nvl(sum(abs(rsb_account.restac(c.t_account, c.t_code_currency,to_date('"+dat+"'),1,null))  ),0) rest FROM daccount_dbt c,  dmcaccdoc_dbt cc where c.t_code_currency="+nfiid+" and  (c.t_balance='32027' or c.t_balance='32028' or c.t_balance='32116' or c.t_balance='32117' or c.t_balance='47805' or c.t_balance='47806'  or (c.t_balance='47465' and c.t_client = 343) or (c.t_balance='47466' and c.t_client = 343))  ";
          end;
            que=que+" and cc.t_account=c.t_account and cc.t_dockind=102  and (select count(*) from  dobjatcor_dbt a  where a.t_objecttype=3 and a.t_attrid=5 and a.t_object = lpad(c.t_client,10,'0') and a.t_groupid=13) = 0 ";
            //msgbox(que);

          rs9 = LnGetRecordSet(que);

          if(rs9 != null)
           if (rs9.moveNext) 

              rezz=rs9.value(0);
           end;
          end;

          if ( nfiid > 0 )

            if (0 != Получить_Курс00(nrate, nfiid, ДАТ(dat)))
               Msgbox("Не возможно получить курс за ", dat);
               return 1;
            end;

            rezz=rezz*nrate/Scale(nfiid);


          end;

          rez=rez+rezz;

          // msgbox(string(rez:a)," ",string(rezz:a));
        end;
      end;


      rez=round(rez/1000,0);
      rez=int(rez);
      //msgbox(string(rez:a));


      return rez;

END;

*/

MACRO mbk9()
    // 08.11.2019 "Оценочные резервы по переуступке прав требований  должны отражаться на балансовых счетах 47805/47806* а не на 32117/32116* как это происходит сейчас" 
    // 08.11.2019  "Оценочные резервы по сделкам размещения с Банком России должны отражаться на счетах 47465/47466*". 343 -  Банк России

    private var rs9,que,nrate=1,rez;
       rez=0;
          
          que = "SELECT distinct c.t_account,  c.t_code_currency, nvl(abs(rsb_account.restac(c.t_account, c.t_code_currency, :0, 1, null)) ,0) rest ";
          que=que+" FROM daccount_dbt c,  dmcaccdoc_dbt cc where ";
          que=que+" (c.t_balance='32027' or c.t_balance='32028' or c.t_balance='32116' or c.t_balance='32117' )"; 
          que=que+" and cc.t_account=c.t_account and cc.t_dockind=102  and (select count(*) from  dobjatcor_dbt a  where a.t_objecttype=3 and a.t_attrid=5 and a.t_object = lpad(c.t_client,10,'0') and a.t_groupid=13) = 0 ";

          rs9 = ExecSqlSelect(que, MakeArray( SqlParam("0", dat),
                                              sqlParam("1", V_INTEGER, RSDBP_RETVAL)), false);

          if(rs9 != null)
             while (rs9.moveNext) 
              if ( rs9.value(1) > 0 )
                 if (0 != Получить_Курс00(nrate, rs9.value(1), ДАТ(dat)))
                   Msgbox("Не возможно получить курс за ", dat);
                   return 1;
                 end;
                 rez=rez + rs9.value(2)*nrate/Scale(rs9.value(1));    
              else 
                 rez=rez + rs9.value(2);
              end;
           end;
          end;

      rez=round(rez/1000,0);
      rez=int(rez);

      return rez;

END;

MACRO mbk11()
    private var rs9,que,rs91,nfiid,rez,rezz,nrate,rs5;
       rez=0;
       println("Расшифровка по 47408 (БАНК)");

       que = "SELECT unique(c.t_code_currency)  FROM daccount_dbt c where  c.t_balance='47408'  order by c.t_code_currency  ";
       rs91 = LnGetRecordSet(que);
       if(rs91 != null)
        while(rs91.moveNext())
          nfiid=int(rs91.value(0));
          rezz=0;



          que = "SELECT   ( select a1.t_code  from ddvndeal_dbt  a1 , dmcaccdoc_dbt b1 where a1.t_id=b1.t_docid and b1.t_account=c.t_account and rownum=1 ) dealcode, (select a1.t_name from dparty_dbt a1 where t_partyid=c.t_client) cli, ";

          if ( nfiid == 0 )
            que =que+ " c.t_account account, abs(rsb_account.resta(c.t_account,to_date('"+dat+"'),1,null))  rest FROM daccount_dbt c  where c.t_code_currency="+nfiid+" and  c.t_balance='47408' ";
          else
            que =que+ " c.t_account account, abs(rsb_account.restac(c.t_account, c.t_code_currency,to_date('"+dat+"'),1,null))  rest FROM daccount_dbt c  where c.t_code_currency="+nfiid+" and  c.t_balance='47408'  ";
          end;
          que=que+" and c.t_client !=1181  and c.t_client !=1 and (select count(*) from dpartyown_dbt ee where ee.t_partyid=c.t_client  and ee.t_partykind=2 ) > 0 ";
          que=que+" and   (select count(*)  from dmcaccdoc_dbt cc where cc.t_account=c.t_account ) > 0 ";
          que=que+" and   (select count(*)  from dmcaccdoc_dbt cc where cc.t_account=c.t_account and cc.t_dockind=101   ) = 0 ";


          // MSGBOX(QUE);


          rs9 = LnGetRecordSet(que);

          if(rs9 != null)
           while(rs9.moveNext())
              if (rs9.value("rest") > 0 )
                println(rs9.value("cli"),"  ",rs9.value("dealcode"),"  ",rs9.value("account"),"  ",string(rs9.value("rest"):a));
              end;
           end;
          end;





          if ( nfiid == 0 )
            que = "SELECT nvl(sum(abs(rsb_account.resta(c.t_account,to_date('"+dat+"'),1,null)) ),0) rest FROM daccount_dbt c  where c.t_code_currency="+nfiid+" and  c.t_balance='47408' ";
          else
            que = "SELECT nvl(sum(abs(rsb_account.restac(c.t_account, c.t_code_currency,to_date('"+dat+"'),1,null))  ),0) rest FROM daccount_dbt c  where c.t_code_currency="+nfiid+" and  c.t_balance='47408'  ";
          end;
          que=que+" and c.t_client !=1181  and c.t_client !=1 and (select count(*) from dpartyown_dbt ee where ee.t_partyid=c.t_client  and ee.t_partykind=2 ) > 0 ";
          que=que+" and   (select count(*)  from dmcaccdoc_dbt cc where cc.t_account=c.t_account ) > 0 ";
          que=que+" and   (select count(*)  from dmcaccdoc_dbt cc where cc.t_account=c.t_account and cc.t_dockind=101   ) = 0 ";

          //  msgbox(que);


          rs9 = LnGetRecordSet(que);

          if(rs9 != null)
           if (rs9.moveNext) 

              rezz=rs9.value(0);
           end;

          end;

          if ( nfiid > 0 )
            if (0 != Получить_Курс00(nrate, nfiid, ДАТ(dat)))
               Msgbox("Не возможно получить курс за ", dat);
               return 1;
            end;
            rezz=rezz*nrate/Scale(nfiid);

          end;


          rez=rez+rezz;
          //  msgbox(nfiid," ",string(rez:a)," ",string(rezz:a));
        end;
      end;

      rez=round(rez/1000,0);
      rez=int(rez);

      // msgbox(string(rez:a));


      return rez;

END;



MACRO mbk21()

    private var rs9,que,nrate=1,rez;
       rez=0;
          
          que = "WITH ACC as (SELECT distinct c.t_account,  c.t_code_currency  FROM daccount_dbt c,  dmcaccdoc_dbt cc where (substr(c.t_balance,1,3)='323' or substr(c.t_balance,1,3)='322' or c.t_balance='47802')";
          que=que+" and cc.t_account=c.t_account and cc.t_dockind in (102, 4626) and (select count(*) from  dobjatcor_dbt a  where a.t_objecttype=3 and a.t_attrid=5 and a.t_object = lpad(c.t_client,10,'0') and a.t_groupid=13) = 0)  ";
          que=que+" SELECT acc.t_code_currency, nvl(abs(rsb_account.restac(acc.t_account, acc.t_code_currency, :0, 1, null)) ,0) rest  FROM ACC ";

          rs9 = ExecSqlSelect(que, MakeArray( SqlParam("0", dat),
                                              sqlParam("1", V_INTEGER, RSDBP_RETVAL)), false);

          if(rs9 != null)
             while (rs9.moveNext) 
              if ( rs9.value(0) > 0 )
                 if (0 != Получить_Курс00(nrate, rs9.value(0), ДАТ(dat)))
                   Msgbox("Не возможно получить курс за ", dat);
                   return 1;
                 end;
                 rez=rez + rs9.value(1)*nrate/Scale(rs9.value(0));    
              else 
                 rez=rez + rs9.value(1);
              end;
           end;
          end;

      rez=round(rez/1000,0);
      rez=int(rez);

      return rez;

END;


MACRO mbk31()
    private var rs9,que,rs91,nfiid,rez,rezz,nrate,rs5,csum,accn=" ",rezz0;
       rez=0;

          println(" ");
          println(" ---------------- Расшифровка  325 47427 47425  ------------------------------");

       que = "SELECT unique(c.t_code_currency)  FROM daccount_dbt c where  (substr(c.t_balance,1,3)='325' or c.t_balance='47427' or c.t_balance='47425')  order by c.t_code_currency  ";
       rs91 = LnGetRecordSet(que);
       if(rs91 != null)
        while(rs91.moveNext())
          nfiid=int(rs91.value(0));
          rezz=0;
          println(" ");
          if ( nfiid == 0 )
            que = "SELECT c.t_nameaccount nacc, c.t_account account, (abs(rsb_account.resta(c.t_account,to_date('"+dat+"'),1,null)) ) rest, cc.t_dockind dockind  FROM daccount_dbt c,  dmcaccdoc_dbt cc  where c.t_code_currency="+nfiid+"  and c.t_client !=343   and  (substr(c.t_balance,1,3)='325' or c.t_balance='47427' or c.t_balance='47425')";
          else
            que = "SELECT c.t_nameaccount nacc,c.t_account account, (abs(rsb_account.restac(c.t_account, c.t_code_currency,to_date('"+dat+"'),1,null))  ) rest, cc.t_dockind dockind  FROM daccount_dbt c,  dmcaccdoc_dbt cc  where c.t_code_currency="+nfiid+" and c.t_client !=343  and (substr(c.t_balance,1,3)='325' or c.t_balance='47427' or c.t_balance='47425')  ";
          end;
            que=que+" and cc.t_account=c.t_account and cc.t_dockind > 0 and ( cc.t_catid=117 or cc.t_catid=809)  and (select count(*) from  dobjatcor_dbt a  where a.t_objecttype=3 and a.t_attrid=5 and a.t_object = lpad(c.t_client,10,'0') and a.t_groupid=13) = 0 ";
            que=que+" and ( ( (  (select a5.t_dealtype from ddl_tick_dbt a5 where a5.t_dealid= cc.t_docid) = 12305 ";
            que=que+" or (select a5.t_dealtype from ddl_tick_dbt a5 where a5.t_dealid= cc.t_docid) = 12306 ) ";
            que=que+ "  and ( select ee.t_maturity from ddl_leg_dbt ee where ee.t_dealid=cc.t_docid)   > to_date('"+dat+"')";
            que=que+" and ( select t_start from ddl_leg_dbt ee where ee.t_dealid=cc.t_docid ) <= to_date('"+dat+"'))  or cc.t_dockind != 102  ) ";
          rs9 = LnGetRecordSet(que);
          if(rs9 != null)
           while(rs9.moveNext())
              if ((rs9.value("rest") > 0 ) and  (rs9.value("dockind") != 176 ) )
                if ( accn  != rs9.value("account") ) 
                  println(rs9.value("dockind"),"  ",rs9.value("account"),"  ",string(rs9.value("rest"):a), "    ",rs9.value("nacc"));
                  rezz=rezz+rs9.value("rest");
                end;
                accn  = rs9.value("account") ;
              end;
           end;
          end;

/*
          if ( nfiid == 0 )
            que = "SELECT nvl(sum(abs(rsb_account.resta(c.t_account,to_date('"+dat+"'),1,null)) ),0) rest FROM daccount_dbt c,  dmcaccdoc_dbt cc  where c.t_code_currency="+nfiid+"  and c.t_client !=343   and  (substr(c.t_balance,1,3)='325' or c.t_balance='47427' or c.t_balance='47425')";
          else
            que = "SELECT nvl(sum(abs(rsb_account.restac(c.t_account, c.t_code_currency,to_date('"+dat+"'),1,null))  ),0) rest FROM daccount_dbt c,  dmcaccdoc_dbt cc  where c.t_code_currency="+nfiid+" and c.t_client !=343  and (substr(c.t_balance,1,3)='325' or c.t_balance='47427' or c.t_balance='47425')  ";
          end;
            que=que+" and cc.t_account=c.t_account and cc.t_dockind > 0 and ( cc.t_catid=117 or cc.t_catid=809)  and (select count(*) from  dobjatcor_dbt a  where a.t_objecttype=3 and a.t_attrid=5 and a.t_object = lpad(c.t_client,10,'0') and a.t_groupid=13) = 0 ";

            que=que+" and ( ( (  (select a5.t_dealtype from ddl_tick_dbt a5 where a5.t_dealid= cc.t_docid) = 12305 ";

            que=que+" or (select a5.t_dealtype from ddl_tick_dbt a5 where a5.t_dealid= cc.t_docid) = 12306 ) ";


            que=que+ "  and ( select ee.t_maturity from ddl_leg_dbt ee where ee.t_dealid=cc.t_docid)   > to_date('"+dat+"')";
            que=que+" and ( select t_start from ddl_leg_dbt ee where ee.t_dealid=cc.t_docid ) <= to_date('"+dat+"'))  or cc.t_dockind != 102  ) ";

            //  msgbox(que);
          rs9 = LnGetRecordSet(que);

          if(rs9 != null)
           if (rs9.moveNext) 


              rezz=rs9.value(0);
           end;
          end;
 */
          if ( nfiid > 0 )

            if (0 != Получить_Курс00(nrate, nfiid, ДАТ(dat)))
               Msgbox("Не возможно получить курс за ", dat);
               return 1;
            end;
            rezz=rezz*nrate/Scale(nfiid);

          end;


          rez=rez+rezz;
          // msgbox(string(rez:a)," ",string(rezz:a));
        end;
      end;

      rez=round(rez/1000,0);
      rez=int(rez);
      //  msgbox(string(rez:a));

          println(" -----------------------------------------------------------------  ");
          println(" ");


      return rez;

END;



MACRO mbk35()
    private var rs9,que,rs91,nfiid,rez,rezz,nrate,rs5,csum;
       rez=0;
       que = "SELECT unique(c.t_code_currency)  FROM daccount_dbt c where  (substr(c.t_balance,1,3)='325' or c.t_balance='47427' or c.t_balance='47425')  order by c.t_code_currency  ";
       rs91 = LnGetRecordSet(que);
       if(rs91 != null)
        while(rs91.moveNext())
          nfiid=int(rs91.value(0));
          rezz=0;

          if ( nfiid == 0 )
            que = "SELECT nvl(sum(abs(rsb_account.resta(c.t_account,to_date('"+dat+"'),1,null)) ),0) rest FROM daccount_dbt c,  dmcaccdoc_dbt cc, ddl_tick_dbt b  where c.t_code_currency="+nfiid+" and  (substr(c.t_balance,1,3)='325' or c.t_balance='47427' or c.t_balance='47425')";
          else
            que = "SELECT nvl(sum(abs(rsb_account.restac(c.t_account, c.t_code_currency,to_date('"+dat+"'),1,null))  ),0) rest FROM daccount_dbt c,  dmcaccdoc_dbt cc, ddl_tick_dbt b  where c.t_code_currency="+nfiid+" and  (substr(c.t_balance,1,3)='325' or c.t_balance='47427' or c.t_balance='47425')";
          end;

            que=que+" and c.t_client !=343  and cc.t_account=c.t_account and cc.t_dockind=102  and (select count(*) from  dobjatcor_dbt a  where a.t_objecttype=3 and a.t_attrid=5 and a.t_object = lpad(c.t_client,10,'0') and a.t_groupid=13) > 0 ";
            que=que+" and b.t_dealid=cc.t_docid and b.t_dealtype = 12305 and b.t_partyid !=343  ";

            //msgbox(que);


          rs9 = LnGetRecordSet(que);
          if(rs9 != null)
           if (rs9.moveNext) 


              rezz=rs9.value(0);
           end;
          end;

          if ( nfiid > 0 )



            if (0 != Получить_Курс00(nrate, nfiid, ДАТ(dat)))
               Msgbox("Не возможно получить курс за ", dat);
               return 1;
            end;
            rezz=rezz*nrate/Scale(nfiid);

          end;


          rez=rez+rezz;
          // msgbox(string(rez:a)," ",string(rezz:a));
        end;
      end;

      rez=round(rez/1000,0);
      rez=int(rez);
      // msgbox(string(rez:a));



      return rez;

END;

MACRO mbk171_20()
    
    private var rs9,que,nrate=1,rez;
       rez=0;
          
          que = "SELECT distinct c.t_account, c.t_code_currency, nvl(abs(rsb_account.restac(c.t_account, c.t_code_currency, :0, 1, null)) ,0) rest ";
          que=que+" FROM daccount_dbt c,  dmcaccdoc_dbt cc where c.t_balance in ('47805', '47806') and cc.t_account=c.t_account and cc.t_dockind = (102)  ";
          
          rs9 = ExecSqlSelect(que, MakeArray( SqlParam("0", dat),
                                              sqlParam("1", V_INTEGER, RSDBP_RETVAL)), false);

          if(rs9 != null)
             while (rs9.moveNext) 
              if ( rs9.value(1) > 0 )
                 if (0 != Получить_Курс00(nrate, rs9.value(1), ДАТ(dat)))
                   Msgbox("Не возможно получить курс за ", dat);
                   return 1;
                 end;
                 rez=rez + rs9.value(2)*nrate/Scale(rs9.value(1));    
              else 
                 rez=rez + rs9.value(2);
              end;
           end;
          end;

      rez=round(rez/1000,0);
      rez=int(rez);

      return rez;

END;

MACRO mbk39()
    private var rs9,que,rs91,nfiid,rez,rezz,nrate,rs5,csum;
       rez=0;
       que = "SELECT unique(c.t_code_currency)  FROM daccount_dbt c where  (c.t_balance='47466' or c.t_balance='47465')  order by c.t_code_currency  ";
       rs91 = LnGetRecordSet(que);
       if(rs91 != null)
        while(rs91.moveNext())
          nfiid=int(rs91.value(0));
          rezz=0;

          if ( nfiid == 0 )
            que = "SELECT nvl(sum(abs(rsb_account.resta(c.t_account,to_date('"+dat+"'),1,null)) ),0) rest FROM daccount_dbt c,  dmcaccdoc_dbt cc, ddl_tick_dbt b  where c.t_code_currency="+nfiid+" and  (c.t_balance='47466' or c.t_balance='47465')";
          else
            que = "SELECT nvl(sum(abs(rsb_account.restac(c.t_account, c.t_code_currency,to_date('"+dat+"'),1,null))  ),0) rest FROM daccount_dbt c,  dmcaccdoc_dbt cc, ddl_tick_dbt b  where c.t_code_currency="+nfiid+" and  (c.t_balance='47466' or c.t_balance='47465')";
          end;

            que=que+" and cc.t_account=c.t_account and cc.t_dockind=102  and (select count(*) from  dobjatcor_dbt a  where a.t_objecttype=3 and a.t_attrid=5 and a.t_object = lpad(c.t_client,10,'0') and a.t_groupid=13) = 0 ";
            que=que+" and b.t_dealid=cc.t_docid and (b.t_dealtype = 12305 or  b.t_dealtype = 12306) AND c.t_client !=343 "; //08.11.2019 исключим счета Банкаа России, "Оценочные резервы по сделкам размещения с Банком России должны отражаться на счетах 47465*/47466*" 

            //msgbox(que);

          rs9 = LnGetRecordSet(que);
          if(rs9 != null)
           if (rs9.moveNext) 


              rezz=rs9.value(0);
           end;
          end;

          if ( nfiid > 0 )



            if (0 != Получить_Курс00(nrate, nfiid, ДАТ(dat)))
               Msgbox("Не возможно получить курс за ", dat);
               return 1;
            end;
            rezz=rezz*nrate/Scale(nfiid);

          end;


          rez=rez+rezz;
          // msgbox(string(rez:a)," ",string(rezz:a));
        end;
      end;

      rez=round(rez/1000,0);
      rez=int(rez);
      // msgbox(string(rez:a));



      return rez;

END;




MACRO mbk41()
    private var rs9,que,rs91,nfiid,rez,rezz,nrate,rs5;
       rez=0;
       println(" " );
       println("Расшифровка по 47408 (юрлица)");
       que = "SELECT unique(c.t_code_currency)  FROM daccount_dbt c where  c.t_balance='47408'  order by c.t_code_currency  ";
       rs91 = LnGetRecordSet(que);
       if(rs91 != null)
        while(rs91.moveNext())
          nfiid=int(rs91.value(0));
          rezz=0;


            que = "SELECT   ( select a1.t_code  from ddvndeal_dbt  a1 , dmcaccdoc_dbt b1 where a1.t_id=b1.t_docid and b1.t_account=c.t_account and rownum=1 ) dealcode, (select a1.t_name from dparty_dbt a1 where t_partyid=c.t_client) cli, ";

          if ( nfiid == 0 )
            que=que+" c.t_account account, abs(rsb_account.resta(c.t_account,to_date('"+dat+"'),1,null))   rest FROM daccount_dbt c  where c.t_code_currency="+nfiid+" and  c.t_balance='47408' ";
          else
            que =que+ " c.t_account account, abs(rsb_account.restac(c.t_account, c.t_code_currency,to_date('"+dat+"'),1,null))   rest FROM daccount_dbt c  where c.t_code_currency="+nfiid+" and  c.t_balance='47408'  ";
          end;
          que=que+" and c.t_client !=1181  and c.t_client !=1 and (select count(*) from dpartyown_dbt ee where ee.t_partyid=c.t_client  and ee.t_partykind=2 ) = 0 ";
          que=que+" and   (select count(*)  from dmcaccdoc_dbt cc where cc.t_account=c.t_account and cc.t_dockind=199   ) > 0 ";




          // MSGBOX(QUE);


          rs9 = LnGetRecordSet(que);

          if(rs9 != null)
           while(rs9.moveNext())
              if (rs9.value("rest") > 0 )
                println(rs9.value("cli"),"  ",rs9.value("dealcode"),"  ",rs9.value("account"),"  ",string(rs9.value("rest"):a));
              end;
           end;
          end;


          if ( nfiid == 0 )
            que = "SELECT nvl(sum(abs(rsb_account.resta(c.t_account,to_date('"+dat+"'),1,null)) ),0) rest FROM daccount_dbt c  where c.t_code_currency="+nfiid+" and  c.t_balance='47408' ";
          else
            que = "SELECT nvl(sum(abs(rsb_account.restac(c.t_account, c.t_code_currency,to_date('"+dat+"'),1,null))  ),0) rest FROM daccount_dbt c  where c.t_code_currency="+nfiid+" and  c.t_balance='47408'  ";
          end;
          que=que+" and c.t_client !=1181  and c.t_client !=1 and (select count(*) from dpartyown_dbt ee where ee.t_partyid=c.t_client  and ee.t_partykind=2 ) = 0 ";
          que=que+" and   (select count(*)  from dmcaccdoc_dbt cc where cc.t_account=c.t_account and cc.t_dockind=199   ) > 0 ";
          rs9 = LnGetRecordSet(que);

          if(rs9 != null)
           if (rs9.moveNext) 
              rezz=rs9.value(0);
           end;
          end;

          if ( nfiid > 0 )
            if (0 != Получить_Курс00(nrate, nfiid, ДАТ(dat)))
               Msgbox("Не возможно получить курс за ", dat);
               return 1;
            end;
            rezz=rezz*nrate/Scale(nfiid);

          end;


          rez=rez+rezz;
          //  msgbox(nfiid," ",string(rez:a)," ",string(rezz:a));
        end;
      end;

      rez=round(rez/1000,0);
      rez=int(rez);

       //  msgbox(string(rez:a));


      return rez;

END;





      // dat={curdate};
      dat=date("01.11.2019");
      getdate(dat,"Уточните дату отчета");
      dat2=dat;
      dat=СДАТ(dat-1);


      //   xltfile="F5_115.xlsb";
         xltfile="F_115.xlsb";


  xltfile0=xltfile;
  xltfile2="..\\import\\BR\\" + xltfile;
  xltfile = "$" + MyDocument + "\\" + xltfile;

  if( IsRunFromWine( false ) )
    var tmpfile = GetTxtDir() + "\\" + GetUniqAddWhithConnect( xltfile0 );
    if( not WR_ConvertToFormatLibreOffice( xltfile2, tmpfile, WINREP_FORMAT_XLSX ) )
      msgbox( "Ошибка конвертации файла" );
    end;

    ob = reportCreator.openWorkbook( tmpfile );
    // LEND RUB
    ob.setActiveSheetByName( "Форма" );


    par0=dat2;  //актуализация даты в шапке отчета
    ob.setCellValue( "L3", par0 );

    par0=mbk1();
    ob.setCellValue( "D13", par0 );

    par0=mbk5();
    ob.setCellValue( "H13", par0 );

    par0=mbk9();
    ob.setCellValue( "T13", par0 );

    par0=mbk11();
    ob.setCellValue( "D16", par0 );

    par0=mbk21();
    ob.setCellValue( "D19", par0 );

    par0=mbk31();
    ob.setCellValue( "D20", par0 );


    par0=mbk35();
    ob.setCellValue( "H20", par0 );

    par0=mbk171_20();
    ob.setCellValue( "T19", par0 );

    par0=mbk39();
    ob.setCellValue( "T20", par0 );


    par0=mbk41();
    ob.setCellValue( "D24", par0 );

    ob.save();
    ob.close();

    if( not CopyFile( tmpfile, xltfile ) )
      msgbox( "Не удалось перместить файл в директорию пользователя" );
      RemoveFile( tmpfile );
      return 0;
    end;

    RemoveFile( tmpfile );

    StartShellProgram( xltfile );

  else
    if ( not copyfile(xltfile2,xltfile,true ) )
      msgbox("Недоступен файл на сервере приложений !");
      return 0;
    end;

    ob = obj.CreateComObject("Excel.Application");
    ob.Workbooks.Open(xltfile0);

    // LEND RUB
    ob.Sheets("Форма").Select;


    par0=dat2;  //актуализация даты в шапке отчета
    ob.Range("L3").Select;
    ob.activecell.formular1c1 = par0;

    par0=mbk1();
    ob.Range("D13").Select;
    ob.activecell.formular1c1 = par0;

    par0=mbk5();
    ob.Range("H13").Select;
    ob.activecell.formular1c1 = par0;

    par0=mbk9();
    ob.Range("T13").Select;
    ob.activecell.formular1c1 = par0;

    par0=mbk11();
    ob.Range("D16").Select;
    ob.activecell.formular1c1 = par0;

    par0=mbk21();
    ob.Range("D19").Select;
    ob.activecell.formular1c1 = par0;

    par0=mbk31();
    ob.Range("D20").Select;
    ob.activecell.formular1c1 = par0;


    par0=mbk35();
    ob.Range("H20").Select;
    ob.activecell.formular1c1 = par0;

    par0=mbk171_20();
    ob.Range("T19").Select;
    ob.activecell.formular1c1 = par0;

    par0=mbk39();
    ob.Range("T20").Select;
    ob.activecell.formular1c1 = par0;


    par0=mbk41();
    ob.Range("D24").Select;
    ob.activecell.formular1c1 = par0;

    ob.Visible = true;
  //  ob.DisplayAlerts = false;
  //  ob.ActiveWorkbook.SaveAs(file_out);
  //  ob.ActiveWorkbook.Close(file_out);
  //  ob         = null;
  end;
      msgbox("Отчет сформирован !");

   // exit(1);
end;




