import PTinter,RSBDataSet,dl_plib,dlgCommon,funk,dl_kvlib; 
private  var d0,pId2,rs0,cmd2,{curdate},sql0,flag,rs05,que; 
private  var col2 = TArray();
private  var v_DealId = TArray(), v_count;


     d0={curdate};
     getdate(d0,"Введите дату:",10);
     sql0="select c.t_dealid pId2,(select ff.t_name from doprkoper_dbt ff  where ff.t_kind_operation=c.t_dealtype) vop,e.t_shortname nam , c.t_dealcode dealcode,";
     sql0=sql0+ " to_char(c.t_dealdate,'dd.mm.yyyy') dealdate,to_char(d.t_maturity,'dd.mm.yyyy') maturity ,(case when c.t_dealtype = 22300 or  c.t_dealtype = 12300 then TO_CHAR(d.t_principal,'9,999,999,999.00') else ' ' end) su1,";
     sql0=sql0+ " (case when c.t_dealtype = 22305 or  c.t_dealtype = 12305 then TO_CHAR(d.t_principal,'9,999,999,999.00') else ' ' end) su2,";
     sql0=sql0+ " ( select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid=d.t_pfi ) fiid2 , (CASE when c.t_dealstatus = 20 then 'Сделка обработана'  else ";
     sql0=sql0+ " 'Ожидание закрытия'   END) sta , ' ' dosr,";

//     sql0=sql0+ " (case when a.t_paymstatus = 32000 then'Сделка обработана' else     (select cc.t_name  from doproper_dbt aa , doprstep_dbt bb ,doprostep_dbt cc ";
//     sql0=sql0+ " where aa.t_dockind=102 and aa.t_DocumentID=lpad(c.t_dealid,34,'0') and bb.t_id_operation=aa.t_id_operation ";
//     sql0=sql0+ " and t_isexecute='R' and cc.t_blockid=bb.t_blockid and cc.t_number_step=bb.t_number_step ) end)  END) sta , ";


     sql0=sql0+ " (case when (c.t_dealtype = 22300 or  c.t_dealtype = 12300) and a.t_paymstatus=32000 then  'Cквитован' else ' ' end) vpl,";
//     sql0=sql0+ " (case when (c.t_dealtype = 22305 or  c.t_dealtype = 12305) and a.t_paymstatus=32000 then  'Cформирован' else ' ' end) isxpl ";

     sql0=sql0+ " (case when (c.t_dealtype = 22305 or  c.t_dealtype = 12305) and a.t_paymstatus=32000 then ";
     sql0=sql0+ "  decode((select nvl(bb1.t_paymstatus,0) from doproper_dbt aa1 ,  doprdocs_dbt dd1, dpmpaym_dbt bb1 where aa1.t_dockind=102 and aa1.t_DocumentID=lpad(c.t_dealid,34,'0') ";
     sql0=sql0+ " and dd1.t_id_operation=aa1.t_id_operation and (dd1.t_dockind=16 or dd1.t_dockind=27)   and bb1.t_paymentid=to_number(dd1.t_documentid)) ,0,'Cформирован',1000,'Отправлен в Расчетную Систему',32000,'Исполнен',100,'Отмена-изменить корсчет выгона' ) ";
     sql0=sql0+ " else ' '  end) isxpl ";
     sql0=sql0+ " from  ddl_tick_dbt c, ddl_leg_dbt d, dparty_dbt e , dpmpaym_dbt a where c.t_bofficekind=102 and  d.t_maturity='"+СДАТ(d0)+"'";
     sql0=sql0+ " and d.t_dealid=c.t_dealid and d.t_legid=1  and e.t_partyid=c.t_partyid  and a.t_dockind=102 and a.t_documentid=c.t_dealid and a.t_purpose=10 and c.t_dealtype > 5000 order by  a.t_paymstatus ,vop desc , sta ";
     // msgbox(sql0);
      cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );


  macro EvProc2 (rs0, cmd2, id, key )
     if (cmd2 == DLG_INIT)	// Инициализация
        if (pId2 != "0")  // Надо найти запись
           v_count = 0;
           while ( (rs0.value ("pId2") != pId2) And (Not rs0.EOF) )  
		if (ValType(rs0.value ("pId2")) == 26)
			v_DealId(v_count) = 0;
		else
			v_DealId(v_count)= rs0.value ("pId2");
		end;
                rs0.Move(1, RELATIVE);
		v_count = v_count + 1;
            end;

        end;
        GoToScroll(rs0, true);
     elif (cmd2 == DLG_KEY)
        pId2=rs0.value ("pId2");
        if(DLG_KEY_ENTER == Key)
         return CM_SELECT;
        end;
     end;
  end;


  AddCol (col2, 0, "vop","Вид сделки", 20);
  AddCol (col2, 1, "nam","Контрагент", 16);
  AddCol (col2, 2, "dealcode","№ сделки", 10);
  AddCol (col2, 3, "dealdate","Дата начала", 10);
  AddCol (col2, 4, "maturity","Дата окончания", 13);
  AddCol (col2, 5, "su1","Cумма требований", 15);
  AddCol (col2, 6, "su2","Сумма обязательств", 15);
  AddCol (col2, 7, "fiid2","Валюта", 5);
  AddCol (col2, 8, "dosr","Досроч.пог.", 9);
  AddCol (col2, 9, "sta","Статус обработки сделки", 20);
  AddCol (col2, 10, "vpl","Статус Входящего платежа", 20);
  AddCol (col2, 11, "isxpl","Статус Исходящего платежа", 24);

   while(RunScroll(cmd2, 12, col2, null, @EvProc2,"Монитор обработки новых сделок МБК за "+СДАТ(d0),"F3- Просмотр F5- Ручная квитовка  F8- Отмена квитовки по сделке F9- Автоквитовка  ESC- Выход ", null, 0, 0) )
     cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );

   end;

   exit(1);
end;


