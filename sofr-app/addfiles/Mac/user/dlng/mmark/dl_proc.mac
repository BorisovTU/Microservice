import oralib, likepy, globals,fx_globals, CTInter;
IMPORT mmarkinter, OprInter,funk,dl_plib,dl_lib;

   private var que,rs9,ii,da,dealid,rs5,fflag;

   var docKind=102, sql;
   var exec, command1, chainblockId=3000019;

macro shnpr()
   private var jj0,jj,acc4,ssu;

   jj0=0;
   da=СДАТ({curdate});
   que=" select count(*) from ddl_tick_dbt a left join ddl_genagr_dbt ga on a.t_genagrid = ga.t_genagrid, ddl_leg_dbt d " +
       " where (a.t_dealtype != 12310 AND a.t_dealtype != 12335) and a.t_bofficekind=102 and a.t_dealstatus=10  and a.t_partyid !="+_BANK_RF+" and d.t_dealid=a.t_dealid " + 
           "and ((d.t_maturity = to_date('"+da+"','dd.mm.yyyy'))" +
                " or " +
                "(MMARK_UTL.IsBUY(MMARK_UTL.GetOperationGroup(a.t_dealtype)) > 0 and ga.t_outpmtmin1 = chr(88) and " +
                "to_date('"+da+"','dd.mm.yyyy') = " + " case when ga.t_adjdatetype = 2 and RSI_RSBCALENDAR.ISWORKDAY(d.t_maturity - 1) = 0 then   RSI_RsbCalendar.GetDateAfterWorkDay (d.t_maturity,-2) " +
                                                      "        else    RSI_RsbCalendar.GetDateAfterWorkDay (d.t_maturity,-1) " +
                                                      "   end))";

   rs9 = LnGetRecordSet(que);
   if(rs9 != null)
     while(rs9.moveNext())
      jj0=int(rs9.value(0));
     end;
   end;

   InitProgress( jj0, "Начисление %% МБК" );  
   jj=0;
   que=" select a.t_dealid, a.t_dealcode, d.t_pfi pfi, d.t_cost cost, a.t_dealtype dealtype from ddl_tick_dbt a left join ddl_genagr_dbt ga on a.t_genagrid = ga.t_genagrid, ddl_leg_dbt d " +
           " where (a.t_dealtype != 12310 AND a.t_dealtype != 12335) and a.t_bofficekind=102 and a.t_dealstatus=10  and a.t_partyid !="+_BANK_RF+" and d.t_dealid=a.t_dealid " +
           "and ((d.t_maturity = to_date('"+da+"','dd.mm.yyyy'))" +
                " or " +
                "(MMARK_UTL.IsBUY(MMARK_UTL.GetOperationGroup(a.t_dealtype)) > 0 and ga.t_outpmtmin1 = chr(88) and " +
                "to_date('"+da+"','dd.mm.yyyy') = " + " case when ga.t_adjdatetype = 2 and RSI_RSBCALENDAR.ISWORKDAY(d.t_maturity - 1) = 0 then   RSI_RsbCalendar.GetDateAfterWorkDay (d.t_maturity,-2) " +
                                                      "        else    RSI_RsbCalendar.GetDateAfterWorkDay (d.t_maturity,-1) " +
                                                      "   end))";
   rs9 = LnGetRecordSet(que);
   if(rs9 != null)
     while(rs9.moveNext())
       useprogress(jj);
       jj=jj+1;
       dealid=int(rs9.value(0));

      if (isSale(GetOperationGroup(rs9.value("dealtype"))))
         acc4 =MM_acc(dealid,117);
      else
         acc4 =MM_acc(dealid,118);
      end;

      ssu=abs(execmacrofile("calculate.mac", "RestA_", acc4, {curdate}, 1, rs9.value("pfi"))) ;
      fflag=0;
      if ( plat_dil0(dealid,"102","11",date(da),"paymstatus")  > 2999 )
         fflag=1;
      end;


      if  (( ssu < rs9.value("cost") )  and (fflag == 0 ))
         println("Начисление %% по сделке "+rs9.value(1));

         que= "select count(*)  from ddl_tick_dbt c1, doproper_dbt aa1 , doprstep_dbt bb1 ,doprostep_dbt cc1 where c1.t_dealid="+dealid+"  and  aa1.t_dockind=102 and ";
         que=que+ " aa1.t_DocumentID=lpad(c1.t_dealid,34,'0') and bb1.t_id_operation=aa1.t_id_operation  and cc1.t_blockid=bb1.t_blockid and cc1.t_number_step=bb1.t_number_step   and  (bb1.t_fact_date = '"+da+"' or bb1.t_isexecute='R')   and bb1.t_blockid="+chainblockId;
//         que=que+ " aa1.t_DocumentID=lpad(c1.t_dealid,34,'0') and bb1.t_id_operation=aa1.t_id_operation  and bb1.t_isexecute='X'   and cc1.t_blockid=bb1.t_blockid and cc1.t_number_step=bb1.t_number_step   and t_fact_date = '"+da+"'  and bb1.t_blockid="+chainblockId;
         rs5 = LnGetRecordSet(que);
         if(rs5 != null)
            if (rs5.moveNext) 
               if (int(rs5.value(0)) == 0 )
                 // ---  blok cep  -------------------
                 sql = "select s.t_id_operation, s.t_id_step, s.t_blockid, s.t_kind_operation, s.t_IsExecute from " 
                 + " doproper_dbt o "
                 + " inner join doprstep_dbt s on s.t_id_operation=o.t_id_operation and s.t_id_step = (select t_id_step from doprstep_dbt where t_id_operation = s.t_id_operation  and t_isexecute ='R'  )"
                 + " where o.t_dockind = :dockind and o.t_documentid = lpad(:dealid, 34, '0')";
                 sql = ExecSqlSelect(sql, MakeArray(SqlParam("dockind", dockind), SqlParam("dealid", dealid)), false);     
                 if(not sql.MoveNext())
                   MsgBox("Ошибка поиcка сделки  = "+dealid);
                   return false;
                 end;
                 ii=int(sql.value("t_id_step"));
                

                 command1 = "BEGIN :res := RSI_RsbOperation.InsertBranchTrn(:step, "+int(sql.value("t_id_operation"))+", "
                 +ii+",'I', "+chainblockId+", 550, :dt, 0, 0); END;";
                 exec = ExecSql(command1, MakeArray(SqlParam ("res",  V_INTEGER, RSDBP_RETVAL), 
                                                    SqlParam ("step", V_INTEGER, RSDBP_RETVAL), 
                                                    SqlParam ("dt", {curdate})), false);
 
                 if(exec == null)
                   MsgBox("Ошибка вставки цепочки ");
                   return false;
                 end;

                 if(exec.value("res") != 0)
                   MsgBox("Процедура вставки цепочки вернула ошибку, для документа id="+dealid);
                   return false;
                 end;
                 // ----------------------------------------------

               end;
            end;
         end;

      else
        println("По сделке "+rs9.value(1)+" ранее начислены проценты !"); 
      end;
// ---
     end;
   end;

   que=" select count(*) from ddl_tick_dbt a, dpmpaym_dbt d where (a.t_dealtype != 12310 AND a.t_dealtype != 12335) and  a.t_bofficekind=102 and a.t_dealstatus=10  and d.t_dockind=102 and d.t_documentid=a.t_dealid and d.t_purpose=11  and d.t_paymstatus< 32000    and d.t_valuedate = to_date('"+da+"','dd.mm.yyyy')" +
       " AND a.t_dealid Not IN (select dl.t_dealid from ddl_tick_dbt dl, ddl_leg_dbt leg where dl.t_bofficekind=102 and dl.t_dealstatus=10  and dl.t_partyid !="+_BANK_RF+" and leg.t_dealid=dl.t_dealid  and leg.t_maturity = to_date('"+da+"','dd.mm.yyyy'))";
   rs9 = LnGetRecordSet(que);
   if(rs9 != null)

     while(rs9.moveNext())
      jj0=int(rs9.value(0));
     end;
   end;

   InitProgress( jj0, "Начисление %% МБК" );  

   jj=0;
   que=" select a.t_dealid, a.t_dealcode, d.t_fiid pfi, d.t_baseamount cost, a.t_dealtype dealtype from ddl_tick_dbt a, dpmpaym_dbt d where (a.t_dealtype != 12310 AND a.t_dealtype != 12335) and  a.t_bofficekind=102 and a.t_dealstatus=10 and d.t_dockind=102 and d.t_documentid=a.t_dealid and d.t_purpose=11  and d.t_paymstatus< 32000    and d.t_valuedate = to_date('"+da+"','dd.mm.yyyy')" +
       " AND a.t_dealid Not IN (select dl.t_dealid from ddl_tick_dbt dl, ddl_leg_dbt leg where dl.t_bofficekind=102 and dl.t_dealstatus=10  and dl.t_partyid !="+_BANK_RF+" and leg.t_dealid=dl.t_dealid  and leg.t_maturity = to_date('"+da+"','dd.mm.yyyy'))";
   rs9 = LnGetRecordSet(que);
   if(rs9 != null)
     while(rs9.moveNext())
       useprogress(jj);
       jj=jj+1;
       dealid=int(rs9.value(0));

      if (isSale(GetOperationGroup(rs9.value("dealtype"))))
         acc4 =MM_acc(dealid,117);
      else
         acc4 =MM_acc(dealid,118);
      end;

      ssu=abs(execmacrofile("calculate.mac", "RestA_", acc4, {curdate}, 1, rs9.value("pfi"))) ;
      fflag=0;
      if ( plat_dil0(dealid,"102","11",date(da),"paymstatus")  > 2999 )
         fflag=1;
      end;

      if  (( ssu < rs9.value("cost") )  and (fflag == 0 ))
         println("Начисление %% по сделке "+rs9.value(1));

         que= "select count(*)  from ddl_tick_dbt c1, doproper_dbt aa1 , doprstep_dbt bb1 ,doprostep_dbt cc1 where c1.t_dealid="+dealid+"  and  aa1.t_dockind=102 and ";
         que=que+ " aa1.t_DocumentID=lpad(c1.t_dealid,34,'0') and bb1.t_id_operation=aa1.t_id_operation  and cc1.t_blockid=bb1.t_blockid and cc1.t_number_step=bb1.t_number_step   and  (bb1.t_fact_date = '"+da+"' or bb1.t_isexecute='R')   and bb1.t_blockid="+chainblockId;
//         que=que+ " aa1.t_DocumentID=lpad(c1.t_dealid,34,'0') and bb1.t_id_operation=aa1.t_id_operation  and bb1.t_isexecute='X'   and cc1.t_blockid=bb1.t_blockid and cc1.t_number_step=bb1.t_number_step   and t_fact_date = '"+da+"'  and bb1.t_blockid="+chainblockId;
         rs5 = LnGetRecordSet(que);
         if(rs5 != null)
            if (rs5.moveNext) 
               if (int(rs5.value(0)) == 0 )
                 // ---  blok cep  -------------------
                 sql = "select s.t_id_operation, s.t_id_step, s.t_blockid, s.t_kind_operation, s.t_IsExecute from " 
                 + " doproper_dbt o "
                 + " inner join doprstep_dbt s on s.t_id_operation=o.t_id_operation and s.t_id_step = (select t_id_step from doprstep_dbt where t_id_operation = s.t_id_operation  and t_isexecute ='R'  )"
                 + " where o.t_dockind = :dockind and o.t_documentid = lpad(:dealid, 34, '0')";
                 sql = ExecSqlSelect(sql, MakeArray(SqlParam("dockind", dockind), SqlParam("dealid", dealid)), false);     
                 if(not sql.MoveNext())
                   MsgBox("Ошибка поиcка сделки  = "+dealid); 

                   return false;
                 end;
                 ii=int(sql.value("t_id_step"));
                

                 command1 = "BEGIN :res := RSI_RsbOperation.InsertBranchTrn(:step, "+int(sql.value("t_id_operation"))+", "
                 +ii+",'I', "+chainblockId+", 550, :dt, 0, 0); END;";
                 exec = ExecSql(command1, MakeArray(SqlParam ("res",  V_INTEGER, RSDBP_RETVAL), 
                                                    SqlParam ("step", V_INTEGER, RSDBP_RETVAL), 
                                                    SqlParam ("dt", {curdate})), false);

                 if(exec == null)
                   MsgBox("Ошибка вставки цепочки ");
                   return false;
                 end;

                 if(exec.value("res") != 0)
                   MsgBox("Процедура вставки цепочки вернула ошибку, для документа id="+dealid);
                   return false;
                 end;
                 // ----------------------------------------------
               end;
            end;
         end;

      else
        println("По сделке "+rs9.value(1)+" ранее начислены проценты !!"); 
      end;
// ---
     end;
   end;

 RemProgress; 

 end;

 if(GetTrue(true, "Выполнить начисление %% ?"))
   shnpr();
   execmacrofile("dl_avto22.mac", "npr") ;
 end;

 // exit(1);
end;
