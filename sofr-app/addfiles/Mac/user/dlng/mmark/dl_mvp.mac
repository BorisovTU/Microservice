import Bankinter,PTinter,RSBDataSet,dl_plib,dlgCommon,funk,MMarkInter,fx_globals;

private  var d0,pId2,rs0,cmd2,{curdate},sql0,flag,rs05,que,rs4,pnewsu,acc0; 
private var pdelta,psclient,psnalog;

private  var col2 = TArray();
private  var v_DealId = TArray(), v_count;


MACRO PaymVxod(pa1,pa2,pa3,pa4,pa5)


private  var sql0,cmd2,rs,pId22,zag,sss,rs22;
private  var col2=TArray();

     zag="Входящие платежи по контрагенту "+pa3+"     сумма требования(без налога) "+string(pa1:a)+ "          дата платежа "+pa2;

     sql0="select a.t_paymentid pId22 ,d.t_name pname,to_char(a.t_valuedate,'dd.mm.yyyy') pda, a.t_tobackoffice nsta, to_char(a.t_baseamount,'999,999,999,999.00') pamount ,c.t_ccy nfiid, b.t_ground pground,";
     sql0=sql0+" (case when a.t_tobackoffice='J' then 'МБК' else ' ' end) sta, a.t_payeraccount ppayeraccount, a.t_receiveraccount preceiveraccount from dpmpaym_dbt a , dpmrmprop_dbt b , dfininstr_dbt c, dparty_dbt d ";
     sql0=sql0+"     where a.t_dockind=322 and a.t_baseamount="+pa1+" and to_char(a.t_valuedate,'dd.mm.yyyy')='"+pa2+"' and a.t_fiid="+pa5+" and b.t_paymentid=a.t_paymentid  and c.t_fiid=a.t_fiid and d.t_partyid=a.t_payer  ";
     //  msgbox(sql0);

     cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );


  macro EvProc2 (rs0, cmd2, id, key )

     if (cmd2 == DLG_INIT)	// Инициализация
        rs0.MoveFirst();          

        if (pId22 != "0")  // Надо найти запись
           while ( (rs0.value ("pId22") != pId22) And (Not rs0.EOF) )  
              rs0.Move(1, RELATIVE);
            end;
        end;
        GoToScroll(rs0, true);

     elif (cmd2 == DLG_KEY)
        pId22=rs0.value ("pId22");
 
        if(DLG_KEY_ENTER == Key)
          if(DLG_KEY_ENTER == Key)  

            if (rs0.value("nsta") == "J")
               que="update dpmpaym_dbt set t_paymstatus=2990, t_tobackoffice=' ' where t_paymentid="+pId22;
               rs22 = LnGetRecordset(que);
            else
               que="update dpmpaym_dbt set t_paymstatus=2995, t_tobackoffice='J' where t_paymentid="+pId22;
               rs22 = LnGetRecordset(que);
               AddNoteForObject (501, string(pId22:o:10), 101, pa4);
            end;

            return CM_SELECT;

          end;

        end;
     end;
  end;

  AddCol (col2, 0, "sta","Бэк-офис", 7);
  AddCol (col2, 1, "pname","Банк отправителя", 20);
  AddCol (col2, 2, "nfiid","Вал.", 3);
  AddCol (col2, 3, "pamount","Сумма", 16);
  AddCol (col2, 4, "ppayeraccount","Cчет отправителя", 18);
  AddCol (col2, 5, "preceiveraccount","Cчет получателя", 18);
  AddCol (col2, 6, "pground","Основание", 50);

     sss=" ENTER- Смена Бэк-офиса ESC- Выход " ;
     while(RunScroll(cmd2, 7, col2, null, @EvProc2,zag,sss, null, 2,15,150,45) )
     cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );
    end;

end;




MACRO MM_nalog2(par1)
  private var que,rs5,rez=0;

  que="select count(*) from DDL_GENAGR_DBT where t_tax_amount > 0 and t_partyid="+par1;
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=int(rs5.value(0));
     end;
  end;
  if ( rez == 0 )
     return rez;
  else
     que="select t_tax_amount from DDL_GENAGR_DBT where t_tax_amount > 0 and  t_partyid="+par1;
     rs5 = LnGetRecordSet(que);
     if(rs5 != null)
        if (rs5.moveNext) 
           rez=rs5.value(0);
        end;
     end;
  end;
  return rez;
END;

MACRO MM_ac(par1,par2)
  private var que,rs5,rez=0;

  que="select t_account from dmcaccdoc_dbt where t_dockind=102 and t_catid="+par2+" and t_docid="+par1;
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=rs5.value(0);
     end;
  end;
  return rez;
END;



MACRO MM_tickid2(par1,par2)
  private var que,rs5,rez=0;

  que="select a.t_" +par2+"  from ddl_tick_dbt a  where a.t_dealid ="+par1; 
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=rs5.value(0);
     end;
  end;
  return rez;
END;



MACRO Kvplatmm()
   private var que,rs,ndealid,ntip,rs50,rs55,rs21,npaym,paym2,delta,vari;

     que=" select a.t_paymentid from dpmpaym_dbt a, dpmrmprop_dbt b where a.t_dockind=322  and a.t_valuedate='"+d0+"' and b.t_paymentid=a.t_paymentid and (substr(b.t_ground,1,2)='MM' or b.t_ground like '%MBK%') ";
     rs55 = LnGetRecordSet(que);
     if(rs55 != null)
       while(rs55.moveNext())
         paym2=rs55.value(0);
         que="update dpmpaym_dbt set t_paymstatus=2995, t_tobackoffice='J' where t_paymentid="+paym2;
         rs21 = LnGetRecordSet(que);
       end;
     end;




     que="select c.t_dealid,a.t_purpose purpose, c.t_dealcode dealcode,a.t_fiid fiid,   a.t_baseamount amount,c.t_partyid partyid,e.t_shortname , a.t_paymentid paymentid, c.t_dealtype dealtype, d.t_pfi pfi   from  ddl_tick_dbt c, ddl_leg_dbt d, dparty_dbt e , dpmpaym_dbt a where c.t_dealtype = 12305 and   c.t_dealstatus < 20 and  c.t_bofficekind=102 ";
     que=que+ " and d.t_dealid=c.t_dealid and d.t_legid=1  and e.t_partyid=c.t_partyid  and a.t_dockind=102 and a.t_documentid=c.t_dealid   and a.t_receiver=1 and a.t_fiid = 0 and  a.t_paymstatus< 32000 and a.t_paymstatus != 55   and a.t_valuedate='"+d0+"' and c.t_partyid  ="+_BANK_RF+" order by c.t_dealdate, c.t_dealid ";
     rs = LnGetRecordSet(que);
     if(rs != null)
        while(rs.moveNext())
          vari=0;
          ndealid=int(rs.value(0));
          ntip=rs.value(1);
          delta=0.0;


       que= "select count(*)  from ddl_tick_dbt a , dpmpaym_dbt b,dpmpaym_dbt bb where a.t_dealid="+ndealid+" and b.t_dockind=102 and b.t_documentid=a.t_dealid ";
       que=que+" and b.t_paymstatus < 32000  and b.t_purpose="+ntip+" and b.t_valuedate='"+d0+"'  and bb.t_dockind=322 and bb.t_fiid=b.t_fiid  and bb.t_payer="+_BANK_RF;
       que=que+" and bb.t_baseamount=b.t_baseamount-"+delta+" and substr(bb.t_receiveraccount,1,5)='47416'  and  bb.t_valuedate= b.t_valuedate and bb.t_tobackoffice !='J' ";
       rs55 = LnGetRecordSet(que);
       if(rs55 != null)
        if (rs55.moveNext) 
           vari=vari+int(rs55.value(0));
        end;
       end;


                         if ( vari == 1 )

       que="select count(*)  from  ddl_tick_dbt c, ddl_leg_dbt d, dparty_dbt e , dpmpaym_dbt a where c.t_dealtype !=12310 and  c.t_dealtype !=12335 and   c.t_dealstatus < 20 and  c.t_bofficekind=102 ";
       que=que+ " and c.t_partyid="+_BANK_RF+" and a.t_baseamount="+rs.value("amount")+" and a.t_fiid=0" ; 
       que=que+ " and d.t_dealid=c.t_dealid  and d.t_legid=1  and e.t_partyid=c.t_partyid  and a.t_dockind=102 and a.t_documentid=c.t_dealid   and a.t_receiver=1 and a.t_fiid = 0 and  a.t_paymstatus< 32000 and a.t_paymstatus != 55   and a.t_valuedate='"+d0+"'";

       rs55 = LnGetRecordSet(que);
       if(rs55 != null)
        if (rs55.moveNext) 
           vari=vari+int(rs55.value(0));
        end;
       end;

 
       if ( vari == 2 )

         que= "select bb.t_paymentid  paymentid  from ddl_tick_dbt a , dpmpaym_dbt b,dpmpaym_dbt bb where a.t_dealid="+ndealid+" and b.t_dockind=102 and b.t_documentid=a.t_dealid ";
         que=que+" and b.t_paymstatus < 32000  and b.t_purpose="+ntip+" and b.t_valuedate='"+d0+"'  and bb.t_dockind=322 and bb.t_fiid=b.t_fiid  and bb.t_payer="+_BANK_RF;
         que=que+" and bb.t_baseamount=b.t_baseamount-"+delta+" and substr(bb.t_receiveraccount,1,5)='47416'  and  bb.t_valuedate= b.t_valuedate and bb.t_tobackoffice !='J' ";
         rs55 = LnGetRecordSet(que);
         if(rs55 != null)
          if (rs55.moveNext) 
	         paym2=rs55.value(0);
	         que="update dpmpaym_dbt set t_paymstatus=2995, t_tobackoffice='J' where t_paymentid="+rs55.value("paymentid");
	         rs21 = LnGetRecordSet(que);
          end;
         end;
       end;

                         end;

        end;
     end;



END;



     d0={curdate};
     getdate(d0,"Введите дату:",10);
     d0=СДАТ(d0);

     sql0="select c.t_dealid pId2,cc.t_number plat33, a.t_baseamount psu ,a.t_fiid fiid, a.t_numberpack plat2,c.t_dealtype pdealtype, a.t_paymentid paymentid,a.t_purpose purpose, c.t_dealcodets dealcodets, decode(c.t_dealtype,12300,'П',32300,'П',12305,'Р',32305,'Р',32300,'П',32305,'Р')  vop,e.t_shortname nam , c.t_dealcode dealcode,";
     sql0=sql0+ " to_char(c.t_dealdate,'dd.mm.yyyy') dealdate,to_char(d.t_maturity,'dd.mm.yyyy') maturity , TO_CHAR(a.t_baseamount,'999,999,999,999.00')  su1, c.t_partyid partyid,";

     sql0=sql0+ "( select to_char(a5.T_PURPOSEPAYMENT) from dpmlink_dbt a5 where rownum=1 and a5.T_LINKKIND=2 and a5.T_INITIALPAYMENT=a.t_paymentid  and a5.T_PURPOSEPAYMENT != a.t_paymentid)  plat3,";

     sql0=sql0+ " ( select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid=d.t_pfi ) fiid2, decode(a.t_paymstatus,32000,'Исполнен',55,'Пролонгирован',0,'?',1000,'?')   sta ";
     sql0=sql0+ " from  ddl_tick_dbt c, ddl_leg_dbt d, dparty_dbt e , dpmpaym_dbt a, dpmrmprop_dbt cc where c.t_dealtype !=12310 and  c.t_dealtype !=12335 and   c.t_dealstatus < 20 and  c.t_bofficekind=102 ";
     sql0=sql0+ "and cc.t_paymentid=a.t_paymentid  and d.t_dealid=c.t_dealid and d.t_legid=1  and e.t_partyid=c.t_partyid  and a.t_dockind=102 and a.t_documentid=c.t_dealid  and a.t_receiver=1 and a.t_valuedate='"+d0+"'  order by c.t_dealdate, c.t_dealid ";

    //  msgbox(sql0);
      cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );

  macro EvProc2 (rs0, cmd2, id, key )
     if (cmd2 == DLG_INIT)	// Инициализация
        if (pId2 != "0")  // Надо найти запись
           v_count = 0;
           while ( (rs0.value ("pId2") != pId2) And (Not rs0.EOF) )  
		if (ValType(rs0.value ("pId2")) == 26)
			v_DealId(v_count) = 0;
		else
			v_DealId(v_count)= rs0.value ("pId2");
		end;
                rs0.Move(1, RELATIVE);
		v_count = v_count + 1;
            end;

        end;
        GoToScroll(rs0, true);                                                                                   
        elif (cmd2 == DLG_KEY)
        pId2=rs0.value ("pId2");
        if(DLG_KEY_ENTER == Key)   
            if  ( ValType (rs0.value ("plat3")) == 26 )
               return CM_SELECT;
            end;    
         execmacrofile("plpaym.mac", "PaymDlg2", 0,int(rs0.value ("plat3"))) ;
         return CM_SELECT;

        elif(DLG_KEY_F2 == Key) 

          pnewsu=rs0.value ("psu");

          if ( rs0.value ("purpose") == 11)
               psclient=MM_tickid2(pId2,"partyid");
               psnalog=MM_nalog2(psclient);
               if (psnalog > 0 )
                 pdelta=pnewsu*psnalog/100;
               else
                 pdelta=0.0;
               end;
               pnewsu=pnewsu-pdelta;
          end;


            if ( rs0.value("purpose") == 11 ) 
        if ( rs0.value("pdealtype") == 12300 ) 
          acc0 =MM_ac(pId2,118);
        else
          acc0 =MM_ac(pId2,117);
        end;

            else
              acc0 =MM_ac(pId2,111);
            end;



          PaymVxod( pnewsu,d0,rs0.value ("nam"),acc0,rs0.value ("fiid"));
          return CM_SELECT;



        elif(DLG_KEY_F5 == Key) 
            Kvplatmm();
            system( 1010, CODEFOR("J"));


/*
            if ( par_plat(rs0.value ("paymentid"),"paymstatus")  == 32000 )
             que="update dpmpaym_dbt set t_numberpack = 175  where t_paymentid="+rs0.value ("paymentid");
             rs4 = LnGetRecordset(que);
            end;

*/
            return CM_SELECT;

/*
        elif(DLG_KEY_F11 == Key) 
            Kvplat1();
            return CM_SELECT;

        elif(DLG_KEY_F9 == Key) 
            Kvplat();
            return CM_SELECT;
*/
        end;
     end;
  end;

  AddCol (col2, 0, "nam","Контрагент", 16);
  AddCol (col2, 1, "dealcode","№ сделки", 10);
  AddCol (col2, 2, "dealcodets","№ сделки(вн)", 10);
  AddCol (col2, 3, "dealdate","Дата сделки", 10);
  AddCol (col2, 4, "vop","Вид", 3);
  AddCol (col2, 5, "fiid2","Валюта", 5);
  AddCol (col2, 6, "su1","Cумма требований", 20);
  AddCol (col2, 7, "sta","Cтатус", 7);
  AddCol (col2, 8, "plat3","Входящий платеж",15);

   while(RunScroll(cmd2, 9, col2, null, @EvProc2,"Монитор входящих платежей за "+СДАТ(d0),"Enter- Просмотр вх платежа  F2- Отбор платежей МБК  F5- Панель платежей  ESC- Выход ", null, 0, 0) )
     cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );
   end;


   exit(1);
end;



