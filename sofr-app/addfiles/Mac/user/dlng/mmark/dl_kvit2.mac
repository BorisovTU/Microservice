IMPORT fx_globals, funk, RSD, mmlibr,funk,"swgenmes.mac",fx_globals;
import  "dl_kvlib.mac";
import MMarkInter;


MACRO ExecuteStep(Buffer, Document)
    record tick( dl_tick );
    SetBuff( tick, Document );

    private var i, s_id0, sql, rs0, rs1, s_messerr, s_messok;

    array masm; 

    if ((tick.numberpack == 99 ) or (tick.partyid == _BANK_RF ))
       return 0;
    end;

   if ({oper} == 1 );
//      return 0;
   end;

    // return 0;

    masm(0) = "  Автоматическая квитовка ";
    masm(1) = "  Ручная квитовка ";
    masm(2) = "  Принудительная  квитовка  ";
    s_messok  = "Квитовка сообщения выполнена!";
    s_messerr = "Квитовка сообщения выполнена ранее! Невозможна";

// получим реквизиты исходящего

    sql = "select l.t_mesid from  dwldlmm_dbt d, dwlmeslnk_dbt l where l.t_objkind=512 and  l.t_direct<>'X'and d.t_dlmmid=l.t_objid and d.t_dealid="+string(tick.dealid);
    rs0 = LnGetRecordSet(sql);
    if(rs0 != null)
      if (rs0.moveNext) 
	 s_id0 = rs0.value(0);
      end;
    else
      msgbox("Отсутствует связь с исходящим подтверждением, квитовка невозможна!");
      return 1 ;
    end;
        /*

        if (IsExistKvit(tick.dealid))
        else
        	AutoKvit( tick.dealid );   
                if (IsExistKvit(tick.dealid))
                      msgbox(s_messok);
       		      return 0;
       	        end;
        end;
        */

    sql = "select count(*) from DL_KVI_DBT where t_dealid="+tick.dealid;
    rs0 = LnGetRecordSet(sql);
    if(rs0 != null)
      if (rs0.moveNext) 
         if (rs0.value(0) > 0 )
           return 0;
         end;
      end;
    end;


    i=menu(masm," ESC - отмена, <Enter> - Квитовка ", "Выберите способ квитовки. ");
    if (i == (-2) )
	msgbox("Квитовка отложена!");
	return 1 ;
    elif (i == 0 )
//автоматическая квитовка
        if (IsExistKvit(tick.dealid))
       	      return 0;

        else
        	AutoKvit( tick.dealid );   
                if (IsExistKvit(tick.dealid))
                      msgbox(s_messok);
       		      return 0;
       	        end;
        end;
	return 1;

    elif (i == 1 )
//ручная квитовка
        if (IsExistKvit(tick.dealid))
                // msgbox(s_messerr+masm(1));
            return 0;

        else
	        HandKvit( tick.dealid );   
                if (IsExistKvit(tick.dealid))
                        msgbox(s_messok);
        		return 0;		
                end;
        end;
        return 1;

    elif (i == 2 )
//принудительная квитовка
        if ( IsExistKvit(tick.dealid) )
	       // msgbox(s_messerr+masm(2));
	       return 0;
        else
 	  sql = " INSERT INTO DL_KVI_DBT  ( T_DEALID, T_ID0, T_ID ) VALUES ( ?, ?, 0)"; 
          rs1 = RSDCommand(sql);
	  rs1.addParam("", RSDBP_IN, tick.dealid);
          rs1.addParam("", RSDBP_IN, s_id0);
          rs1.execute();
           
          return 0 ;
        end;
   end;
//~LKL

    return 1 ;
END;


/* Макрос постобработки */
MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

    private var sql, rs1,acc,que,ii,rs01,rs2,acc0,rs11,uslo,paymstatus,ij,es,flag=0,ij2;
    record tick( dl_tick );
    SetBuff( tick, FirstDoc );

     if (errTrn OR (CommitOrRollback==2)) 
           que="UPDATE dwldlmm_dbt SET T_dealid =0 WHERE t_direct='X' and  t_dealid ="+ tick.dealid;   
           rs1 = LnGetRecordset(que);
           que="delete DL_KVI_DBT WHERE T_dealid ="+ tick.dealid; 
           rs1 = LnGetRecordset(que);
     end;

    if (CommitOrRollback==1) 
      if (tick.dealtype== 12300 )
         // uslo= " bb.t_index=23 ";
         uslo= " bb.t_fieldid=1770";

      else
        //  uslo= "(bb.t_index=21  or  bb.t_index=22)";
         uslo= " bb.t_fieldid=1770";
      end;

      que="select count(*)  from  dwlmes_dbt aa , dwlmesval_dbt  bb, dwltpfld_dbt cc , dwlmeslnk_dbt b, dwldlmm_dbt a ";
      que=que+ " where  bb.t_mesid=aa.t_mesid and  aa.t_direct='X'  and aa.t_tpschemid=51 and a.t_pfi=0 ";
      que=que+ " and cc.t_tpfieldid=bb.t_tpfieldid and cc.t_name='57D'  and "+uslo+" and b.t_mesid=aa.t_mesid and b.t_objkind=512  and b.t_objid=a.t_dlmmid and a.t_dealid="+tick.dealid+" order by bb.t_mesid";
      rs01 = LnGetRecordSet(que);
      if(rs01 != null)

       if (rs01.moveNext) 
        if (rs01.value(0) > 0 ) 
          // --
          que="select bb.t_value  from  dwlmes_dbt aa , dwlmesval_dbt  bb, dwltpfld_dbt cc , dwlmeslnk_dbt b, dwldlmm_dbt a ";
          que=que+ " where  bb.t_mesid=aa.t_mesid and  aa.t_direct='X'  and aa.t_tpschemid=51 and a.t_pfi=0 ";
          que=que+ " and cc.t_tpfieldid=bb.t_tpfieldid and cc.t_name='57D'  and "+uslo+" and b.t_mesid=aa.t_mesid and b.t_objkind=512  and b.t_objid=a.t_dlmmid and a.t_dealid="+tick.dealid+" order by bb.t_mesid";
          //que=que+ " and cc.t_tpfieldid=bb.t_tpfieldid and cc.t_name='57D' and (bb.t_index=21 or  bb.t_index=22)  and b.t_mesid=aa.t_mesid and b.t_objkind=512  and b.t_objid=a.t_dlmmid and a.t_dealid="+tick.dealid+" order by bb.t_mesid";
          rs1 = LnGetRecordSet(que);
          if(rs1 != null)
            if (rs1.moveNext) 
              acc=rs1.value(0);
              acc0=acc;
              es=0;
              ii=index(acc,SYMB_ENDL);
              if ( ii > 0 )
                 acc=substr(acc,1,ii-1);
                 if ( substr(acc,1,1) == "/")
                    acc=strsubst(acc,"-","");
                    acc=substr(acc,2,20);
                 end;

                 if (( substr(acc,1,1) == "3") or  ( substr(acc,1,1) == "4") or  ( substr(acc,1,1) == "7")  )
                   flag=1;
                 else
                   flag=0;
                 end;

                 if ((substr(rs1.value(0),ii+1) > 2 )  and (flag == 1))
                    if ( tick.dealtype == 12300  )
                      if (substr(acc,1,5)  != "30101")
                        es=1;
                        que="update dpmpaym_dbt set t_payeraccount='"+acc+"'  where t_dockind=102 and t_documentid="+tick.dealid+ " and t_purpose=9 ";
                        rs2 = LnGetRecordSet(que);
                        que="update dpmpaym_dbt set t_receiveraccount='"+acc+"'  where t_dockind=102 and t_documentid="+tick.dealid+ " and t_purpose=10"; // and t_subpurpose=0 
                        rs2 = LnGetRecordSet(que);
                      end;
                    else

                      // --
                      if (substr(acc,1,5)  != "30101")
                        es=1;
                        que="update dpmpaym_dbt set t_payeraccount='"+acc+"'  where t_dockind=102 and t_documentid="+tick.dealid+ " and t_purpose=10"; // and t_subpurpose=0 
                        rs2 = LnGetRecordSet(que);
                        que="update dpmpaym_dbt set t_receiveraccount='"+acc+"'  where t_dockind=102 and t_documentid="+tick.dealid+ " and t_purpose=9 ";
                        rs2 = LnGetRecordSet(que);

                        que="select bb.t_mesid  from  dwlmes_dbt aa , dwlmesval_dbt  bb, dwltpfld_dbt cc , dwlmeslnk_dbt b, dwldlmm_dbt a ";
                        que=que+ " where  bb.t_mesid=aa.t_mesid and  aa.t_direct !='X'  and aa.t_tpschemid=51 and a.t_pfi=0 ";
                        que=que+ " and cc.t_tpfieldid=bb.t_tpfieldid and cc.t_name='57A' and bb.t_index=20  and b.t_mesid=aa.t_mesid and b.t_objkind=512  and b.t_objid=a.t_dlmmid and a.t_dealid="+tick.dealid+" order by bb.t_mesid";
                        rs11 = LnGetRecordSet(que);
                        if(rs11 != null)
                          if (rs11.moveNext) 
                             que="update dwlmesval_dbt set  t_value ='"+acc0+"' where  t_mesid="+int(rs11.value(0))+" and t_index=20 ";
                             rs2 = LnGetRecordSet(que);
                          end;
                        end;
                      // --
                      end;
                    end;
                 end;
              end;
              // --
              if ( es == 0 )
                 if ( tick.dealtype == 12300  )
                    ij=index(acc0,"320");
                    if ( ij > 0 )
                        acc=substr(acc0,ij,20);
                        ij=index(acc,"-");
                              if ( ij == 0 )
                        que="update dpmpaym_dbt set t_payeraccount='"+acc+"'  where t_dockind=102 and t_documentid="+tick.dealid+ " and t_purpose=9 ";
                        rs2 = LnGetRecordSet(que);
                        que="update dpmpaym_dbt set t_receiveraccount='"+acc+"'  where t_dockind=102 and t_documentid="+tick.dealid+ " and t_purpose=10"; // and t_subpurpose=0 
                        rs2 = LnGetRecordSet(que);
                              end;
                     end;

                    else

                      ij=index(acc0,"321");
                      if ( ij > 0 )
                        acc=substr(acc0,ij,20);

                        ij=index(acc,"-");
                              if ( ij == 0 )
                        que="update dpmpaym_dbt set t_payeraccount='"+acc+"'  where t_dockind=102 and t_documentid="+tick.dealid+ " and t_purpose=9 ";
                        rs2 = LnGetRecordSet(que);
                        que="update dpmpaym_dbt set t_receiveraccount='"+acc+"'  where t_dockind=102 and t_documentid="+tick.dealid+ " and t_purpose=10"; // and t_subpurpose=0 
                        rs2 = LnGetRecordSet(que);
                              end;
                      end;

                 end;

                 if ( tick.dealtype == 12305  )
                    ij=index(acc0,"313");
                    if ( ij > 0 )
                        acc=substr(acc0,ij,20);

                        ij=index(acc,"-");
                              if ( ij == 0 )
                        que="update dpmpaym_dbt set t_payeraccount='"+acc+"'  where t_dockind=102 and t_documentid="+tick.dealid+ " and t_purpose=10"; // and t_subpurpose=0    
                        rs2 = LnGetRecordSet(que);
                        que="update dpmpaym_dbt set t_receiveraccount='"+acc+"'  where t_dockind=102 and t_documentid="+tick.dealid+ " and t_purpose=9 ";
                        rs2 = LnGetRecordSet(que);
                              end;
                     end;

                    else

                      ij=index(acc0,"314");
                      if ( ij > 0 )
                        acc=substr(acc0,ij,20);

                        ij=index(acc,"-");
                              if ( ij == 0 )
                        es=1;
                        que="update dpmpaym_dbt set t_payeraccount='"+acc+"'  where t_dockind=102 and t_documentid="+tick.dealid+ " and t_purpose=10"; // and t_subpurpose=0 
                        rs2 = LnGetRecordSet(que);
                        que="update dpmpaym_dbt set t_receiveraccount='"+acc+"'  where t_dockind=102 and t_documentid="+tick.dealid+ " and t_purpose=9 ";
                        rs2 = LnGetRecordSet(que);
                              end;
                      end;

                 end;

               
              end;
              //--


            end;
          end;
          //--
        end;
       end;
      end;
    end;


    if (CommitOrRollback==1) 
      if (tick.dealtype== 12300 )
         uslo= " bb.t_fieldid=1814";
      end;

      que="select count(*)  from  dwlmes_dbt aa , dwlmesval_dbt  bb, dwltpfld_dbt cc , dwlmeslnk_dbt b, dwldlmm_dbt a ";
      que=que+ " where  bb.t_mesid=aa.t_mesid and  aa.t_direct='X'  and aa.t_tpschemid=51 and a.t_pfi=0 ";
      que=que+ " and cc.t_tpfieldid=bb.t_tpfieldid and cc.t_name='57D'  and "+uslo+" and b.t_mesid=aa.t_mesid and b.t_objkind=512  and b.t_objid=a.t_dlmmid and a.t_dealid="+tick.dealid+" order by bb.t_mesid";
      rs01 = LnGetRecordSet(que);
      if(rs01 != null)

       if (rs01.moveNext) 
        if (rs01.value(0) > 0 ) 
          // --
          que="select bb.t_value  from  dwlmes_dbt aa , dwlmesval_dbt  bb, dwltpfld_dbt cc , dwlmeslnk_dbt b, dwldlmm_dbt a ";
          que=que+ " where  bb.t_mesid=aa.t_mesid and  aa.t_direct='X'  and aa.t_tpschemid=51 and a.t_pfi=0 ";
          que=que+ " and cc.t_tpfieldid=bb.t_tpfieldid and cc.t_name='57D'  and "+uslo+" and b.t_mesid=aa.t_mesid and b.t_objkind=512  and b.t_objid=a.t_dlmmid and a.t_dealid="+tick.dealid+" order by bb.t_mesid";
          //que=que+ " and cc.t_tpfieldid=bb.t_tpfieldid and cc.t_name='57D' and (bb.t_index=21 or  bb.t_index=22)  and b.t_mesid=aa.t_mesid and b.t_objkind=512  and b.t_objid=a.t_dlmmid and a.t_dealid="+tick.dealid+" order by bb.t_mesid";
          rs1 = LnGetRecordSet(que);
          if(rs1 != null)
            if (rs1.moveNext) 
              acc=rs1.value(0);
              acc0=acc;
              ii=index(acc,SYMB_ENDL);
              if ( ii > 0 )
                 acc=substr(acc,1,ii-1);
                 if ( substr(acc,1,1) == "/")
                    acc=strsubst(acc,"-","");
                    acc=substr(acc,2,20);
                 end;

                 end;
                 if (substr(rs1.value(0),ii+1) > 2 )
                    if ( tick.dealtype == 12300  )
                      if (substr(acc,1,5)  != "30101")
                        que="update dpmpaym_dbt set t_receiveraccount='"+acc+"'  where t_dockind=102 and t_documentid="+tick.dealid+ " and t_purpose=11"; // and t_subpurpose=1 
                        rs2 = LnGetRecordSet(que);
                      end;
                    end;

                 end;
              end;

                if (( es == 0 ) and ( tick.dealtype == 12300 ) )
                    ij=index(acc0,"474");
                    if ( ij > 0 )
                        acc=substr(acc0,ij,20);
                        ij=index(acc,"-");
                              if ( ij == 0 )
                                que="update dpmpaym_dbt set t_receiveraccount='"+acc+"'  where t_dockind=102 and t_documentid="+tick.dealid+ " and t_purpose=11"; // and t_subpurpose=1 
                                rs2 = LnGetRecordSet(que);
                              end;
                    end;

                    ij=index(acc0,"706");
                    if ( ij > 0 )
                        acc=substr(acc0,ij,20);
                        ij=index(acc,"-");
                              if ( ij == 0 )
                                que="update dpmpaym_dbt set t_receiveraccount='"+acc+"'  where t_dockind=102 and t_documentid="+tick.dealid+ " and t_purpose=11"; // and t_subpurpose=1 
                                rs2 = LnGetRecordSet(que);
                              end;
                    end;

                end;

            end;
          end;
          //--
        end;
       end;
      end;
    end;





end;