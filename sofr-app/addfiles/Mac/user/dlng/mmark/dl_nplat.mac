//-----------------------------------------------------------------------------------------
// График платежей
// v.3
//-----------------------------------------------------------------------------------------

import "gtconst.inc",calculate,funk,"cb_sql.mac",dl_plib, "dealinfo.mac";


private var Mmdeal = Tbfile( "dl_tick.dbt", "W" );
private var leg  = Tbfile( "dl_leg.dbt", "W" );
private   var paym       = Tbfile( "pmpaym.dbt", "W" );
private   var paymprop  = Tbfile( "pmprop.dbt", "W" );
private   var paymprop2  = Tbfile( "pmprop.dbt", "W" );
private   var pmrmprop  = Tbfile( "pmrmprop.dbt", "W" );
var sup,d22,jj,purpose,d2,npach=0,Comment;

private array map1,map2;
macro Histpaym11(pa1)
 private var que,rs51;

   que="select   T_AMOUNT,T_PAYERBANKID,T_PAYERACCOUNT,T_RECEIVERBANKID,T_RECEIVERACCOUNT,to_char(T_VALUEDATE,'DD.MM.YYYY') from dpmpaym_dbt  where t_paymentid="+pa1;
   rs51 = LnGetRecordSet(que);
   if(rs51 != null)
     if (rs51.moveNext) 
        map1(0)=rs51.value(0);
        map1(1)=rs51.value(1);
        map1(2)=rs51.value(2);
        map1(3)=rs51.value(3);
        map1(4)=rs51.value(4);
        map1(5)=rs51.value(5);
     end;
   end;
end;

macro Histpaym22(pa1)
 private var que,rs51,ii=0,pfix=0,{curdare},{oper};
   if (map1(0) == 1 )
       return;
   end;
   que="select   T_AMOUNT,T_PAYERBANKID,T_PAYERACCOUNT,T_RECEIVERBANKID,T_RECEIVERACCOUNT,to_char(T_VALUEDATE,'DD.MM.YYYY') from dpmpaym_dbt  where t_paymentid="+pa1;
   rs51 = LnGetRecordSet(que);
   if(rs51 != null)
     if (rs51.moveNext) 
        map2(0)=rs51.value(0);
        map2(1)=rs51.value(1);
        map2(2)=rs51.value(2);
        map2(3)=rs51.value(3);
        map2(4)=rs51.value(4);
        map2(5)=rs51.value(5);
     end;
   end;

   while(ii < 7) 
     if (map1(ii) != map2(ii) )
         pfix=1;
         ii=10;
     end;
     ii=ii+1;
   end;
   if ( pfix > 0 ) 
     que="insert into  DSTD_HISTPAYM_DBT (T_PAYMENTID,T_AMOUNT,T_PAYERBANKID,T_PAYERACCOUNT,T_RECEIVERBANKID,T_RECEIVERACCOUNT,T_VALUEDATE,T_AMOUNT2,T_PAYERBANKID2,T_PAYERACCOUNT2,T_RECEIVERBANKID2,T_RECEIVERACCOUNT2,T_VALUEDATE2,T_RESERVE,T_DATER,T_OPER) ";
     que=que+" values("+pa1+","+map1(0)+","+map1(1)+","+map1(2)+","+map1(3)+","+map1(4)+",'"+map1(5)+"',"+map2(0)+","+map2(1)+","+map2(2)+","+map2(3)+","+map2(4)+",'"+map2(5)+"',' ','"+СДАТ({curdate})+"',"+{oper}+" )"; 
     rs51 = LnGetRecordSet(que);
   end;


end;



macro prov_mes(pa1,pa2)
  private var d10,m10,y10,m20,rez=0;

  datesplit(pa1,d10,m10,y10);
  datesplit(pa2,d10,m20,y10);
  if ( m10 == m20 )
     rez=1;
  end;
  return rez;
end;

/* ------------------------ МБК --------------------- */


// Макрос записи нового платежа МБК
macro _Create_op()
   var type:integer;
   var yearlen:integer;
   var stat=0,kontr,su,prpr,pss,ku,toch,dil,kurs,alg,d3,d1,v1,v2,kden;
                        
//  платеж

    paym.rec.PAYMENTID = 0;
    paym.rec.DOCKIND = Mmdeal.rec.BOFFICEKIND;
    paym.rec.DOCUMENTID = Mmdeal.rec.DEALID;
    paym.rec.PURPOSE = purpose;
    paym.rec.SUBPURPOSE = jj;

    paym.rec.VALUEDATE=d2;

    paym.rec.AMOUNT = sup;
    paym.rec.BASEAMOUNT = sup;
    paym.rec.PAYAMOUNT = sup;
    paym.rec.FUTUREPAYERAMOUNT = sup;
    paym.rec.FUTURERECEIVERAMOUNT = sup;
    paym.rec.userfield1="";
    paym.rec.userfield2="";
    paym.rec.NUMBERPACK=npach;
    if ( d22 != d2 )
      paym.rec.userfield1=СДАТ(d22);
    end;
    //paym.rec.PAYMSTATUS = 0;
    paym.rec.PAYMSTATUS = 1000;

        stat = paym.insert;
        if (not stat)
                RunError( "Ошибка при создании новой сделки 10" );
        end;

//debet

                paymprop.rec.PAYMENTID = paym.rec.PAYMENTID;
                paymprop.rec.DEBETCREDIT = 0;
                paymprop.rec.TRANSFERDATE = paym.rec.VALUEDATE;
                stat = paymprop.insert;
                if (not stat)
                        RunError( "Ошибка при создании новой сделки 11." );
                end;
//credit
                paymprop2.rec.PAYMENTID = paym.rec.PAYMENTID ;
                paymprop2.rec.DEBETCREDIT = 1;
                paymprop2.rec.TRANSFERDATE = paym.rec.VALUEDATE;                
                stat = paymprop2.insert;
                if (not stat)
                        RunError( "Ошибка при создании новой сделки 12." );
            end;
//Реквизиты платежа         

            pmrmprop.rec.PAYMENTID = paym.rec.PAYMENTID ;
            pmrmprop.rec.DATE = d2;
            pmrmprop.rec.PAYDATE = d2;
            pmrmprop.rec.CLIENTDATE = d2;
            //Для МСП банка отдельное основание платежа по Погашению ОД
            if ((paym.rec.purpose == 10) and (mmdeal.rec.partyid ==857))
               pmrmprop.rec.ground = "Уплата части основного долга по договору о предоставлении кредита в целях реализации программы фин. поддержки малого и среднего предпринимательства №" + SubStr(mmdeal.rec.dealcode, 14)+ " от " + mmdeal.rec.dealdate + " г. Без налога (НДС).";
            end;
            stat = pmrmprop.insert;
            if (not stat)
               RunError( "Ошибка при создании новой сделки 13." );
            end;

// -----------------
  OnError( RslErrObj ) //А если ошибка - заполняем коммент
        Comment = RslErrObj.Message;
    AbortTrn();

end;

// ------------------------------------------------------

macro ПересчетПроцентовПоГрафику(DealID)
 private var que,RS90,rs95,kor5,rs31,nnss1,su55,bas,rs21,rs22,nss,npe,epe,npe1,epe1,snpe,sepe,npe11,epe11,nsumma,pr55,sod55,susd,plid9,dend;

   npe=ДАТ(zsdelp(dealid,"start"))+1;
   epe=СДАТ(zsdelp(dealid,"maturity"));
   susd=zsdelp(dealid,"principal");
   bas=zsdelp(dealid,"basis");


   npe1=npe;
   kor5=0;
   nss=string(dealid);

   que="select COUNT(*) from dmmpaymode_dbt a where a.t_dealid= '"+nss+"'";
   rs90 = LnGetRecordSet(que);
    if(rs90 != null)
     if (rs90.moveNext) 
      if (RS90.value(0) > 0 )
        que="select a.t_pcSum from dmmpaymode_dbt a where a.t_dealid= '"+nss+"'";
        rs95 = LnGetRecordSet(que);
        if(rs95 != null)
          if (rs95.moveNext) 
            kor5=int(rs95.value(0));
          end;
        end;
      else
        dend=ДАТ(zsdelp(dealid,"maturity"));
        plid9=string(Пареметры_платежа(dealid,"11",dend,"paymentid"));
        que = "update dpmrmprop_dbt SET T_DATE ='"+epe+"',  T_PAYDATE = '"+epe+"' , T_CLIENTDATE = '"+epe+"'";
        que=que+" where t_paymentid = '"+plid9+"'";  
        rs95 = LnGetRecordSet(que);
      end;
     end;
    end;

   que = "select b.t_date,a.t_paymentid paymentid,a.t_paymstatus,a.t_subpurpose  from dpmpaym_dbt a, dpmrmprop_dbt b  where a.t_paymentid=b.t_paymentid and a.t_documentid='"+nss+"' and a.t_dockind=102 and a.t_purpose=11 order by a.t_valuedate ";
   rs21 = LnGetRecordSet(que);
   if (rs21 != null)
      while (rs21.moveNext())
         Histpaym11(rs21.value("paymentid"));
         epe1=ДАТ(rs21.value(0));
         epe11=npe1;
         npe11=npe1;
         su55=0;
             while  ( epe11 < epe1 ) 
              snpe=СДАТ(npe11);
              sepe=СДАТ(epe1);
               //  msgbox(snpe," ",sepe);
              if ( snpe > sepe)
                 que = "select  dl_mmark.get_newdate(t_dealid,to_date('"+snpe+"','dd.mm.yyyy'),to_date('"+sepe+"','dd.mm.yyyy'))   from ddl_tick_dbt  where t_dealid= '"+nss+"'";
                 rs22 = LnGetRecordSet(que);
                 if(rs22 != null)
                  if (rs22.moveNext) 
                    epe11=ДАТ(rs22.value(0));
                    if ( kor5 > 0 )
                      epe11=epe11+1;
                    end;
                    pr55=Новая_проц_ставка(dealid,npe11);
                    sod55=susd-Сумма_платежей_сделки_all2(dealid,"10",npe11);
                    // msgbox(sod55," ", npe11-1," ", epe11," ", pr55," ", bas);
                    nsumma = Round(РасчётПроцентнойСтавки(sod55, npe11-1, epe11, pr55, bas), 2); 
                    su55=su55+nsumma;
                    //  msgbox(npe1," ",epe1," ",npe11-1," === ",epe11,"  ===  ",epe11-npe11+1 ," ", sod55," ",nsumma," ",su55);
                    if ( epe11 > epe1 )
                      epe11=epe11-1;
                    end;
                    npe11=epe11+1;
                  end;
                 end;
              else
                 epe11=epe11+1;
                 npe11=epe11+1;
              end;
             end;
             npe1=epe1+1;
             if (( rs21.value(2) < 32000 ) and (( rs21.value(3) > 1 ) OR (СДАТ(rs21.value(0)) == epe ) ) )
                 nnss1=string(su55);
                 if (zsdell(dealid,"flag3") == "X")

                     que = "update dpmpaym_dbt SET  t_FUTUREPAYERAMOUNT = '"+nnss1+"' ,  t_FUTURERECEIVERAMOUNT = '"+nnss1+"' ,  t_AMOUNT = '"+nnss1+"' , t_BASEAMOUNT = '"+nnss1+"' ,  t_PAYAMOUNT ='"+nnss1+"' ";
                     que=que+" where t_paymentid = '"+string(rs21.value(1))+"'"; 
                     rs31 = LnGetRecordSet(que);
                 else
                     que = "update dpmpaym_dbt SET t_BASEAMOUNT = '"+nnss1+"'";
                     que=que+" where t_paymentid = '"+string(rs21.value(1))+"'"; 
                     rs31 = LnGetRecordSet(que);
                     nsumma= Round(РасчётПроцентнойСтавки(zsdelp(dealid,"principal"), npe-1, ДАТ(zsdelp(dealid,"maturity")), pr55, bas), 2); 
                     nnss1=string(nsumma);
                     que = "update dpmpaym_dbt SET  t_FUTUREPAYERAMOUNT = '"+nnss1+"' ,  t_FUTURERECEIVERAMOUNT = '"+nnss1+"' ,  t_AMOUNT = '"+nnss1+"' ,   t_PAYAMOUNT ='"+nnss1+"' ";
                     que=que+" where t_paymentid = '"+string(rs21.value(1))+"'"; 
                     rs31 = LnGetRecordSet(que);
                 end;
              end;
         Histpaym22(rs21.value("paymentid"));
     end;
   end;

   if (zsdell(dealid,"flag3") == "X")
   else
      nsumma = Round(РасчётПроцентнойСтавки(zsdelp(dealid,"principal"), npe-1, ДАТ(zsdelp(dealid,"maturity")), pr55, bas), 2); 
      korr_sd(dealid,nsumma);
   end;
end;

// --
macro ПересчетПроцентовПоГрафику2(DealID)
 private var que,RS90,rs95,kor5,rs31,nnss1,su55,bas,rs21,rs22,nss,npe,epe,npe1,epe1,snpe,sepe,npe11,epe11,nsumma,pr55,sod55,susd,plid9,dend;

   npe=ДАТ(zsdelp(dealid,"start"))+1;
   epe=СДАТ(zsdelp(dealid,"maturity"));
   susd=zsdelp(dealid,"principal");
   bas=zsdelp(dealid,"basis");
   npe1=npe;
   kor5=0;
   nss=string(dealid);

   que="select COUNT(*) from dmmpaymode_dbt a where a.t_dealid= '"+nss+"'";
   rs90 = LnGetRecordSet(que);
    if(rs90 != null)
     if (rs90.moveNext) 
      if (RS90.value(0) > 0 )
        que="select a.t_pcSum from dmmpaymode_dbt a where a.t_dealid= '"+nss+"'";
        rs95 = LnGetRecordSet(que);
        if(rs95 != null)
          if (rs95.moveNext) 
            kor5=int(rs95.value(0));
          end;
        end;
      else
        dend=ДАТ(zsdelp(dealid,"maturity"));
        plid9=string(Пареметры_платежа(dealid,"11",dend,"paymentid"));
        que = "update dpmrmprop_dbt SET T_DATE ='"+epe+"',  T_PAYDATE = '"+epe+"' , T_CLIENTDATE = '"+epe+"'";
        que=que+" where t_paymentid = '"+plid9+"'";  
        rs95 = LnGetRecordSet(que);
      end;
     end;
    end;

   npe11=npe-1;


     if ( zsdell(dealid,"partyid") == 857  )
       que = "select a.t_futurecratedate,a.t_paymentid paymentid,a.t_paymstatus,a.t_subpurpose  from dpmpaym_dbt a, dpmrmprop_dbt b  where a.t_paymentid=b.t_paymentid and a.t_documentid='"+nss+"' and a.t_dockind=102 and a.t_purpose=11 order by a.t_valuedate ";
     else
       que = "select b.t_date,a.t_paymentid paymentid,a.t_paymstatus,a.t_subpurpose  from dpmpaym_dbt a, dpmrmprop_dbt b  where a.t_paymentid=b.t_paymentid and a.t_documentid='"+nss+"' and a.t_dockind=102 and a.t_purpose=11 order by a.t_valuedate ";
     end;

   rs21 = LnGetRecordSet(que);
   if (rs21 != null)
      while (rs21.moveNext())
         Histpaym11(rs21.value("paymentid"));
         epe11=ДАТ(rs21.value(0));

                    pr55=Новая_проц_ставка(dealid,npe11);
                    sod55=susd-Сумма_платежей_сделки_all2(dealid,"10",npe11);
                    // msgbox(sod55," ", npe11-1," ", epe11," ", pr55," ", bas);
                    nsumma = Round(РасчётПроцентнойСтавки(sod55, npe11, epe11, pr55, bas), 2); 
                    // msgbox(epe11,"-",nsumma," ",epe11-(npe11));
                    npe11=epe11;

                 nnss1=string(nsumma);
                                          if ( rs21.value(2) < 32000 ) 
 
                 if (zsdell(dealid,"flag3") == "X")
                     que = "update dpmpaym_dbt SET  t_FutureBaseAmount = " + nnss1 + ", t_FUTUREPAYERAMOUNT = '"+nnss1+"' ,  t_FUTURERECEIVERAMOUNT = '"+nnss1+"' ,  t_AMOUNT = '"+nnss1+"' , t_BASEAMOUNT = '"+nnss1+"' ,  t_PAYAMOUNT ='"+nnss1+"' ";
                     que=que+" where t_paymentid = '"+string(rs21.value(1))+"'"; 
                     rs31 = LnGetRecordSet(que);
                 else
                     que = "update dpmpaym_dbt SET t_BASEAMOUNT = '"+nnss1+"'";
                     que=que+" where t_paymentid = '"+string(rs21.value(1))+"'"; 
                     rs31 = LnGetRecordSet(que);
                     nsumma= Round(РасчётПроцентнойСтавки(zsdelp(dealid,"principal"), npe-1, ДАТ(zsdelp(dealid,"maturity")), pr55, bas), 2); 
                     nnss1=string(nsumma);
                     que = "update dpmpaym_dbt SET  t_FUTUREPAYERAMOUNT = '"+nnss1+"' ,  t_FUTURERECEIVERAMOUNT = '"+nnss1+"' ,  t_AMOUNT = '"+nnss1+"' ,   t_PAYAMOUNT ='"+nnss1+"' ";
                     que=que+" where t_paymentid = '"+string(rs21.value(1))+"'"; 
                     rs31 = LnGetRecordSet(que);
                 end;
         Histpaym22(rs21.value("paymentid"));
                                         end;
     end;
   end;

   if (zsdell(dealid,"flag3") == "X")
   else
      nsumma = Round(РасчётПроцентнойСтавки(zsdelp(dealid,"principal"), npe-1, ДАТ(zsdelp(dealid,"maturity")), pr55, bas), 2); 
      korr_sd(dealid,nsumma);
   end;
end;


MACRO sdelka_new(idsd,spu);
    private var que,rs,rs1,rr,rs2; 
    que = "select *  from ddl_tick_dbt  where t_dealid ="+idsd;
    rs = LnGetRecordSet(que);
    if (rs != null)
      while (rs.moveNext())
            CopyRSetToFBuff(mmdeal, rs ) ;
            que = "select *  from ddl_leg_dbt  where t_dealid ="+idsd;
            rs1 = LnGetRecordSet(que);
            if (rs1 != null)
              while (rs1.moveNext())
                CopyRSetToFBuff(leg, rs1 ) ;
              end;
            end;
      end;
    end;
    purpose=spu;
    d2={curdate};
    d22=d2;
    sup=1000;
    jj=20;
    que="select max(t_subpurpose)  from dpmpaym_dbt where t_purpose='"+string(spu)+"' and t_dockind=102 and t_documentid = "+idsd; 
    rs = LnGetRecordSet(que);
    if(rs != null)
       if (rs.moveNext) 
         jj=rs.value(0)+1;
       end;
    end;

    if (purpose == 9)
       que="select min(t_paymentid)  from dpmpaym_dbt where t_purpose = 9 and t_dockind=102 and t_documentid = "+idsd;
    elif (purpose == 10)
       que="select min(t_paymentid)  from dpmpaym_dbt where t_purpose = 10 and t_dockind=102 and t_documentid = "+idsd; // and t_subpurpose=0
    elif (purpose == 11)
       que="select min(t_paymentid)  from dpmpaym_dbt where t_purpose = 11 and t_dockind=102 and t_documentid = "+idsd; // and t_subpurpose=1
    end;
    rs = LnGetRecordSet(que);
    if(rs != null)
       if (rs.moveNext) 
         rr=rs.value(0);
       end;
    end;

    que="select *  from dpmpaym_dbt where t_paymentid = '"+rr+"'"; 
    rs2 = LnGetRecordSet(que);
    if (rs2 != null)
      while (rs2.moveNext())                                
        CopyRSetToFBuff(paym, rs2 ) ;
      end;
    end;
    que="select *  from dpmprop_dbt where t_DEBETCREDIT = 0 and t_paymentid = '"+rr+"'"; 
    rs2 = LnGetRecordSet(que);
    if (rs2 != null)
      while (rs2.moveNext())
            CopyRSetToFBuff(paymprop, rs2 ) ;
      end;
    end;
    que="select *  from dpmprop_dbt where t_DEBETCREDIT = 1 and t_paymentid = '"+rr+"'"; 
    rs2 = LnGetRecordSet(que);
    if (rs2 != null)
      while (rs2.moveNext())
            CopyRSetToFBuff(paymprop2, rs2 ) ;
      end;
    end;

    que="select *  from dpmrmprop_dbt where t_paymentid = '"+rr+"'"; 
    rs2 = LnGetRecordSet(que);
    if (rs2 != null)
      while (rs2.moveNext())
            CopyRSetToFBuff(pmrmprop, rs2) ;
      end;
    end;
    if (ProcessTrn(0,"_Create_op"))
        else
                msgbox("Сделка не загружена");
                MSGBOX(Comment);
                return false;
    end;
    return int(jj);

END;




macro sdelka_mm_op(idsd);

   private var II,j,que,dstart,rs,rs9,rs1,rs2,rr,day1,day2,tip1,tip2,sum1,kmes1,kmes2,dfin,kp1,kp2,kpi,ds,d1,m1,y1,dn,kk,ku,price,sum0;
   private array mas1,mas2,mas10,mas20;
   
   que="select count(*) from dpmpaym_dbt where t_dockind=102 and t_documentid = "+idsd;
   rs9 = LnGetRecordSet(que);
   if(rs9 != null)
     if (rs9.moveNext) 
        if ( rs9.value(0) > 3 )
           return;
        end;
     end;
   end;



   que = "select *  from ddl_tick_dbt  where t_dealid ="+idsd;
   rs = LnGetRecordSet(que);
   if (rs != null)
     while (rs.moveNext())
            CopyRSetToFBuff(mmdeal, rs ) ;
            que = "select *  from ddl_leg_dbt  where t_dealid ="+idsd;
            rs1 = LnGetRecordSet(que);
            if (rs1 != null)
              while (rs1.moveNext())
                CopyRSetToFBuff(leg, rs1 ) ;
                dstart=СДАТ(leg.rec.start);
                dfin=СДАТ(leg.rec.maturity);
              end;
            end;
     end;
   end;
   sum0=leg.rec.principal;
   que="select count(*)  from dstd_pls_dbt where  t_id = "+idsd;
   rs9 = LnGetRecordSet(que);
   if(rs9 != null)
     if (rs9.moveNext) 
        if ( rs9.value(0) == 0 )
           ku=double("1"+substr("0000000000",1,leg.rec.point));
           price=leg.rec.price/ku;
           que = "INSERT INTO dstd_pls_dbt Values("+idsd+",'"+dstart+"',"+(price*1000000)+","+price+")";
           rs = LnGetRecordSet(que);
        end;
     end;
   end;



   que="select a.t_odPayType tip1,a.t_odDay day1,a.t_odSum sum1,a.t_odDelay kmes1,a.t_pcPayType tip2,a.t_pcDay day2,a.t_pcSum, a.t_pcDelay kmes2 from dmmpaymode_dbt a where a.t_dealid="+idsd;
   rs9 = LnGetRecordSet(que);
   if(rs9 != null)
     if (rs9.moveNext) 
       day1=СДАТ(rs9.value("day1"));
       day2=СДАТ(rs9.value("day2")); 
       tip1=rs9.value("tip1");
       tip2=rs9.value("tip2"); 
       sum1=rs9.value("sum1");
       kmes1=rs9.value("kmes1");
       kmes2=rs9.value("kmes2");
     end;
   end;
  
   if ((tip1 == 0 ) and (tip2 == 0 ))
      return;
   end;

   if (tip1 == 1 )
      kmes1=1;
   end;
   if (tip2 == 1 )
      kmes2=1;
   end;

   if ((tip1 == 2 ) and  (kmes1 < 0 ))
     datesplit(leg.rec.start,d1,m1,y1);
     tip1=3;
     kmes1=abs(kmes1);
     day1=d1;
   end;
  // msgbox(tip1,"=",kmes1,"=", leg.rec.start,"=",d1);

   if ((tip2 == 2 ) and  (kmes2 < 0 ))
     datesplit(leg.rec.start,d1,m1,y1);
     tip2=3;
     kmes2=abs(kmes2);
     day2=d1;
   end;

   if (tip1 > 0 )

     // msgbox("start ",leg.rec.start,"-",leg.rec.maturity );
     // datesplit(ДАТ(leg.rec.start),d1,m1,y1);
     m1=substr(СДАТ(leg.rec.start),4,2);
     y1=substr(СДАТ(leg.rec.start),7);
     dn=DateAfterCalenMonths(date(day1+".01."+y1),int(m1)-1);
     if (kmes1 > 1)
       kpi = 1;
     else
       kpi = 0;
     end;
     kp1=0;
     while  ( dn < leg.rec.maturity ) 
       if (tip1 == 3 )
          dn=dn+kmes1;
       else
         if ((kp1 > 0) OR (kmes1 > 1))
           dn=DateAfterCalenMonths(date(day1+".01."+y1),int(m1)-1+(kmes1*(kp1+kpi)));
         end;
       end;
       if ( dn < leg.rec.maturity ) 
          if ( prov_mes(dn,leg.rec.maturity) == 1 )
          //  msgbox("Погашение в один месяц !");
          else
              kp1=kp1+1;
              mas1(kp1)=dn;
              mas2(kp1)=sum1;
              sum0=sum0-sum1;
          end;
       end;
     end;
   end;

   if (tip2 > 0)
     // msgbox("start ",leg.rec.start,"-%%%-",leg.rec.maturity );
     // datesplit(leg.rec.start,d1,m1,y1);
     // dn=date(day2+"."+string(m1)+"."+string(y1));

     m1=substr(СДАТ(leg.rec.start),4,2);
     y1=substr(СДАТ(leg.rec.start),7);
     dn=DateAfterCalenMonths(date(day2+".01."+y1),int(m1)-1);
     if (kmes2 > 1)
       kpi = 1;
     else
       kpi = 0;
     end;
     kp2=0;
     while  ( dn < leg.rec.maturity ) 
       if (tip2 == 3 )
         dn=dn+kmes2;
       else
         if ((kp2 > 0) OR (kmes2 > 1))
           dn=DateAfterCalenMonths(date(day2+".01."+y1),int(m1)-1+(kmes2*(kp2+kpi)));
         end;
       end;
       if ( dn < leg.rec.maturity ) 
          //SVE 08.06.2020 510319 Проверка не нужна так как из-за этого не формируется предпоследний платеж по процентам
          //if (( prov_mes(dn,leg.rec.maturity) == 1 ) and (tip2 != 3 ))
             //  msgbox("Погашение в один месяц !");
          //else
             kp2=kp2+1;
             mas10(kp2)=dn;
             mas20(kp2)=1;
          //end;
       end;
     end;
   end;

   if (tip1 == 0 )
     kp1=0;
   end;
   if (tip2 == 0 )
     kp2=0;
   end;

   II=0;
   if (tip1 == 0 )
      II=1;
   end;

   While (II < 2 )
     if (II == 0 )
       que="select t_paymentid, t_valuedate  from dpmpaym_dbt where t_purpose=10 and t_dockind=102 and t_documentid = "+idsd;   // and t_subpurpose=0
       purpose=10;
       jj=0;
       kk=kp1+1;
     else
       que="select t_paymentid,t_valuedate  from dpmpaym_dbt where t_purpose=11 and t_dockind=102 and t_documentid = "+idsd;    // and t_subpurpose=1
       purpose=11;
       jj=1;
       kk=kp2+1;
     end;
     rs2 = LnGetRecordSet(que);
     if (rs2 != null)
        if (rs2.moveNext) 
           rr=string(rs2.value(0));
           if ((II == 0 ) and (tip1 > 0 ))
              sum1=sum0;
              que = "update dpmpaym_dbt SET  t_FUTUREPAYERAMOUNT = "+sum1+" ,  t_FUTURERECEIVERAMOUNT = "+sum1+" ,  t_AMOUNT = "+sum1+" , t_BASEAMOUNT = "+sum1+" ,  t_PAYAMOUNT ="+sum1+", t_userfield2='"+СДАТ(rs2.value(1))+"' " ;
              que=que+"where t_paymentid = "+rr;
              rs2 = LnGetRecordSet(que);
           end;
        end;
     end;

     que="select *  from dpmpaym_dbt where t_paymentid = '"+rr+"'"; 
     rs2 = LnGetRecordSet(que);
     if (rs2 != null)
        while (rs2.moveNext())                                
           CopyRSetToFBuff(paym, rs2 ) ;
        end;
     end;
     que="select *  from dpmprop_dbt where t_DEBETCREDIT = 0 and t_paymentid = '"+rr+"'"; 
     rs2 = LnGetRecordSet(que);
     if (rs2 != null)
        while (rs2.moveNext())
           CopyRSetToFBuff(paymprop, rs2 ) ;
        end;
     end;
     que="select *  from dpmprop_dbt where t_DEBETCREDIT = 1 and t_paymentid = '"+rr+"'"; 
     rs2 = LnGetRecordSet(que);
     if (rs2 != null)
        while (rs2.moveNext())
           CopyRSetToFBuff(paymprop2, rs2 ) ;
        end;
     end;
     que="select *  from dpmrmprop_dbt where t_paymentid = '"+rr+"'"; 
     rs2 = LnGetRecordSet(que);
     if (rs2 != null)
        while (rs2.moveNext())
           CopyRSetToFBuff(pmrmprop, rs2) ;
        end;
     end;

     j=1;
     var begDate = dstart;
     var endDate;        
     while (j < kk )
        jj=jj+1;
        if (II == 0 )
           sup=mas2(j);
           d2=mas1(j);
        else
           sup=mas20(j);
           d2=mas10(j);
        end;

        if (Workdays(d2, d2) == 0  )
           //   MSGBOX("Перенос даты платежа с выходного дня ! ", d2);
           d22=GetDateAfterWorkDays(d2, 0);
           d2 = d22;
        else
           d22=d2;
        end;
      
        //SVE 08.06.2020 510319 Расчет суммы платежа по процентам сразу перед вставкой, нет смысла потом апдейтить готовые платежи когда можно создать сразу с корректной суммой
        if (j == 1)              
           endDate = mas10(j);
        elif (jj == kk-1)
           begDate = mas10(j);
           endDate = dFin;
        else
           begDate = mas10(j-1);
           endDate = mas10(j);
        end;
        sup = round(РасчётПроцентнойСтавки2(sum0, begDate, endDate, leg.rec.price / 100, leg.rec.basis), 2);               

        //  msgbox(ii,"==",d2," ",d22," ", sup," ",jj);
        if (ProcessTrn(0,"_Create_op"))
        else
           msgbox("Платежи не зафиксированы !");
           MSGBOX(Comment);
           return false;
        end;     
        j=j+1;
     end;

     II=II+1;
     if (tip2 == 0 )
        II=10;
     end;
  end;
  
  if (tip2 == 3 )
     ПересчетПроцентовПоГрафику2(idsd);
  else
     //ПересчетПроцентовПоГрафику(idsd);
  end;
end;
 


macro op_prol(idsd);
 


    if (ProcessTrn(0,"_Create_op"))
        else
                msgbox("Сделка не загружена");
                MSGBOX(Comment);
                return false;
    end;

end;

