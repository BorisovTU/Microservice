IMPORT globals,OprInter,funk,mmcarry,mmcnst_j,mmlibr;
private var ss,rs,que;
     RECORD deal(dl_tick);

MACRO ExecuteStep(Buffer, Document)

   SetBuff( deal, Document );

   ss=string(deal.dealid);

   que = "update dpmpaym_dbt SET t_paymstatus = 55 where t_paymstatus < 32000 and t_purpose = 10 and t_dockind=102 and t_documentid='"+ss+"'";

/*
   IF (deal.dealtype == 2300)
    que = "update dpmpaym_dbt SET t_paymstatus = 55  where t_subpurpose=0 and t_purpose = 9 and t_dockind=102 and t_documentid='"+ss+"'";
   ELSE
    que = "update dpmpaym_dbt SET t_paymstatus = 55, t_futurepayeramount = t_baseamount where t_subpurpose=0 and t_purpose = 10 and t_dockind=102 and t_documentid='"+ss+"'";
   END;
   msgbox(que);
*/

   rs = LnGetRecordset(que);
   if(rs != null)
   else
     msgbox("no update !!!!!");
     return 1;
   end;    
 
   return 0;
END;

MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */

                ID_Step)       /* Номер шага операции */

        private var  sid_operation,DocumentID,rs2,rs02;

        SetBuff( deal, FirstDoc );
        ss=string(deal.dealid);


  if (errTrn OR (CommitOrRollback==2)) 
     que = "update dpmpaym_dbt SET t_paymstatus = 1000  where  t_paymstatus < 32000 and  t_purpose = 10 and t_dockind=102 and t_documentid='"+ss+"'";
     rs = LnGetRecordset(que);
         if(rs != null)
         else
           msgbox("no update !!!!!");
         end;    


  end;

  if (CommitOrRollback == 1) 

    que = "select count(*) from doprdocs_dbt a, doproper_dbt b where a.t_id_operation=b.t_id_operation and a.t_dockind=102 and b.t_dockind=102 and a.t_DocumentID=lpad('"+ss+"',34,'0')";
    rs = LnGetRecordset(que);
    if(rs != null)
      if (rs.moveNext) 
        if (rs.value(0) >  0)
// ----------------------------------
          que = "select b.t_DocumentID,b.t_id_operation from doprdocs_dbt a, doproper_dbt b where a.t_id_operation=b.t_id_operation and a.t_dockind=102 and b.t_dockind=102 and a.t_DocumentID=lpad('"+ss+"',34,'0')";
          rs02 = LnGetRecordset(que);

          if(rs02 != null)
            if (rs02.moveNext) 
               DocumentID=string(rs02.value(0));

               sid_operation=string(rs02.value(1));
               que = "update dpmpaym_dbt SET t_userfield1 = '"+DocumentID+"' ,  t_userfield2 = '"+sid_operation+"'  where  t_purpose = 9  and t_dockind=102 and t_documentid='"+ss+"'";
               rs2 = LnGetRecordset(que);
               if(rs2 != null)
               end;

               que = "update doproper_dbt set t_DocumentID=lpad('0',34,'0')  where t_id_operation='"+sid_operation+"' and t_dockind=102 ";
               rs2 = LnGetRecordset(que);
               if(rs2 != null)
               end;

            end;
          end;
// -----------------------------------
        end;
      end;
    end;

 end;



END;


