import globals;
import PTInter;
import RSBDataSet;
import "activex.mac";
import OprInter; /* ВР. Тема Айса 231751 */
 
const MINDATE = date(01,01,1900); /* дата, условно считающаяся "минус бесконечностью" */
const MAXDATE = date(31,12,2099); /* дата, условно считающаяся "плюс  бесконечностью" */
CONST SelCodeKind = 1; // Общий параметр для листалок Бирж,Субьектов,Брокеров,Клиентов
const OurClientID = 6485; // partyID нашего Банка
 
 

Private macro GetPartyName( partyID, IsFullName )  /*SD - 1996769*/
   record party("party");
   
   if (valType(IsFullName) == V_UNDEF)
     IsFullName = true;
   end;
   
   if ( partyID != -1 )
     if ( not ПолучитьСубъекта( partyID, party ) )
        if( IsFullName )
          return party.Name;
        else
          return party.ShortName;
        end;
     end;
   end;
   
   return "";
end;


macro ShowDialog(_RepDate)
    
    private var dlg1 = TRecHandler("test1", "test.lbr", TRUE);
    private var dlg2 = TRecHandler("test2", "test.lbr", TRUE);
    private var Params = TArray();
    /*
      Текущие параметры отчёта, возвращаться в основную процедуру будут не они, а dlg1/dlg2
      Params(0) - RepType
            (1) - DealType
            (2) - Trade
            (3) - Conv
            (4) - PriceType
            (5..) - даты
    */
    

    private var NextStatus = 1; /* 0 - выход, 1 - панельку 1 (за дату), 2 - панельку 2 (за период) */
    private var CurStatus = 0;

    private CONST ESC:integer = 27,
                ENTER:integer = 13,
                   F2:integer = 316,
                   F3:integer = 317,
                  Tab:integer = 9,
                 k_UP:integer = 328,
               k_DOWN:integer = 336,
                SPACE:integer = 32;
    
    private var MenuRes:integer = 0;

    private var Cmps = TArray();

    private var RepType_IDs = TArray();
    private var RepType_names = TArray();
    private var RepType_selected = 1;
    
    private var DealType_IDs = TArray();
    private var DealType_names = TArray();
    private var DealType_selected = 1;
    
    private var Markets_IDs = TArray();
    private var Markets_names = TArray();
    private var Markets_selected = 0;
    
    private var Conv_IDs = TArray();
    private var Conv_names = TArray();
    private var Conv_selected = 0;
                                       private var PriceType_IDs = TArray();
    private var PriceType_names = TArray();
    private var PriceType_selected = 0;
    
    private var ClientCode = "";
    private var ClientName = "";
    private var ClientID_selected = 0;

    /* ВР. Тема Айса 231751. */
    private var ContrCode = "";
    private var ContrName = "";
    private var ContrID_selected = -1;

    private var arr = TArray();
    private var cmp_n:string = ""; // номер поля сравнения периодов дат 

    private var ds = TRsbDataSet;


    private macro SetParameters()
    /* 
      Вычисление параметров отчёта и заполнение значений по умолчанию 
    */
        private var ds;   // DataSet
        private var i:integer, N:integer;
    
    
        /* Вид отчёта */
        RepType_IDs.size = 0;
        RepType_names.size = 0;
        RepType_IDs(0) = 1;
        RepType_names(0) = "За дату";
        RepType_IDs(1) = 2;
        RepType_names(1) = "За период";
        RepType_selected = 0;       /* выбираем из массива элемент со значением по умолчанию */
    
        /* Типы сделок */
        DealType_IDs.size = 0;
        DealType_names.size = 0;
        DealType_IDs(0)   = 1;
        DealType_names(0) = "Покупка ЦБ";
        DealType_IDs(1)   = 2;
        DealType_names(1) = "Продажа ЦБ";
        DealType_IDs(2)   = 3;
        DealType_names(2) = "Прямое РЕПО";
        DealType_IDs(3)   = 4;
        DealType_names(3) = "Обратное РЕПО";
        DealType_IDs(4)   = -1;
        DealType_names(4) = "Все сделки";
        DealType_selected = 4;    /* Выбираем из массива элемент со значением по умолчанию */
    
    
        /* Заполним список бирж */
        ds = TRsbDataSet("select distinct t_marketid, (select t_shortname from dparty_dbt where t_partyid = t_marketid) as StockName from ddl_tick_dbt where t_marketid > 0");
        Markets_IDs.size = 0;
        Markets_names.size = 0;
        Markets_IDs(0) = -1;
        Markets_names(0) = "Все";
        while(ds.movenext())
            Markets_IDs  (Markets_IDs.size)    = int(ds.t_marketid);
            Markets_names(Markets_names.size)  = string (ds.StockName);
        end;
        Markets_selected = 0;   /* выбираем из массива элемент по умолчанию */
    
    
        /* переводить проценты в деньги? */
        Conv_IDs.size = 0;
        Conv_names.size = 0;
        Conv_IDs(0)   = 0;
        Conv_names(0) = "ДА";
        Conv_IDs(1)   = 1;
        Conv_names(1) = "НЕТ";
        Conv_selected = 0;
    
    
        /* Тип цены - заполняем массив IDшниками типов цен */
        PriceType_IDs.size = 0;
        PriceType_names.size = 0;
        PriceType_IDs(0) =  1; // рыночная
        PriceType_IDs(1) =  4; // средневзвешенная
        PriceType_IDs(2) = 12; // ТСС
        i = 0;
        N = PriceType_IDs.size;
        while(i < N)
            ds = TRsbDataSet("select t_TypeName from dratetype_dbt where t_type = " + PriceType_IDs(i));
            if(ds.movenext())
                PriceType_names(i) = ds.t_TypeName;
            end;
            i = i + 1;
        end;
        PriceType_Selected = 2;    

        Cmps.size = 0;
        Cmps(0) = "_ Любое значение";
        Cmps(1) = "= Равно";
        Cmps(2) = "> Больше";
        Cmps(3) = "] Больше, либо равно";
        Cmps(4) = "< Меньше";
        Cmps(5) = "[ Меньше, либо равно";
        Cmps(6) = "с Период";  /* Указана КИРИЛЛИЧЕСКАЯ БУКВА 'С' первым символом */
       
    end;


    private macro SaveParams(d)
        Params.size = 0;
        Params(0) = RepType_selected;
        Params(1) = DealType_selected;
        Params(2) = Markets_selected;
        Params(3) = Conv_selected;
        Params(4) = PriceType_selected;
    end;

    private macro SaveParamsForExit(d)
        var i:integer = 0;
        Params.size = 0;
        Params(Params.size) = RepType_IDs(RepType_selected);
        Params(Params.size) = DealType_IDs(DealType_selected);
        Params(Params.size) = Markets_IDs(Markets_selected);
        Params(Params.size) = Conv_IDs(Conv_selected);
        Params(Params.size) = PriceType_IDs(PriceType_selected);
        Params(Params.size) = ClientID_Selected;
        Params(Params.size) = ContrID_Selected; /* ВР. Тема Айса 231751 */
        if(RepType_selected == 0)
            /* Отчёт на дату */
            Params(Params.size) = d.rec.d1start;
        else
            /* Отчёт "за период" 
               Так как Заказчик хочет "универсализации под привычные механизмы RS", то придётся ВСЁ разбирать ручками ((( 
               А так как алгоритм не меняется (SELECT'ы остались рабочими), только интерфейс, 
                 то приходится подстраиваться под уже реализованные алгоритмы.
               Полэкрана выше - состав массива операторов сравнения CMPS. Попробуем хотя бы в цикл закатать, 
                 а не расписывать 35 вариантов на каждую дату

               Конечно, можно оптимизировать следующий цикл - слишком много повторных вычислений операндов,
                 но это только графическая форма, сильно тормозить и не должна бы.
            */

            i = 1;
            while(i <= 5)
                if(d.item("Cmp" + string(i)) == "_") // любая дата                      
                    Params(Params.size) = MINDATE;
                    Params(Params.size) = MAXDATE;
                elif(d.item("Cmp" + string(i)) == "=") // конкретная дата
                    Params(Params.size) = d.item("d" + string(i) + "start");
                    Params(Params.size) = d.item("d" + string(i) + "start");
                elif(d.item("Cmp" + string(i)) == ">") // строго больше, то есть больше либо равно дате, следующей за указанной
                    Params(Params.size) = d.item("d" + string(i) + "start") + 1;
                    Params(Params.size) = MAXDATE;
                elif(d.item("Cmp" + string(i)) == "]") // больше, либо равно
                    Params(Params.size) = d.item("d" + string(i) + "start");
                    Params(Params.size) = MAXDATE;
                elif(d.item("Cmp" + string(i)) == "<") // строго меньше
                    Params(Params.size) = MINDATE;
                    Params(Params.size) = d.item("d" + string(i) + "start") - 1;
                elif(d.item("Cmp" + string(i)) == "[") // меньше либо равно
                    Params(Params.size) = MINDATE;
                    Params(Params.size) = d.item("d" + string(i) + "start");
                elif(d.item("Cmp" + string(i)) == "с") // период. Указана КИРИЛЛИЧЕСКАЯ БУКВА 'С'
                    Params(Params.size) = d.item("d" + string(i) + "start");
                    Params(Params.size) = d.item("d" + string(i) + "finish");
                else
                    /* Сюда попасть мы не могли, только если ввели ещё какой-то оператор сравнения. */
                end;

                i = i + 1;
            end;
        end;
    end;

    macro LoadParams(d:@TRecHandler)
        var i:integer = 0;

        d.rec.RepType   = RepType_names  (Params(0));
        d.rec.DealType  = DealType_names (Params(1));
        d.rec.Trade     = Markets_names  (Params(2));
        d.rec.Conv      = Conv_names     (Params(3));
        d.rec.PriceType = PriceType_names(Params(4));

        if(NextStatus == 1)
            d.rec.d1start = _RepDate;
        else
//            d.rec.d1start  = d.rec.d2start  = d.rec.d3start  = d.rec.d4start  = d.rec.d5start  = MINDATE;
//            d.rec.d1finish = d.rec.d2finish = d.rec.d3finish = d.rec.d4finish = d.rec.d5finish = MAXDATE;

            d.rec.d1start  = d.rec.d2start  = d.rec.d3start  = d.rec.d4start  = d.rec.d5start  = date(0,0,0);
            d.rec.d1finish = d.rec.d2finish = d.rec.d3finish = d.rec.d4finish = d.rec.d5finish = date(0,0,0);

            d.rec.Cmp1 = d.rec.Cmp2 = d.rec.Cmp3 = d.rec.Cmp4 = d.rec.Cmp5 = "_";
            i = 1;
            while(i <= 5)
                DisableFields(d, FldIndex(d, "d" + string(i) + "start"));
                DisableFields(d, FldIndex(d, "d" + string(i) + "finish"));
                i = i + 1;
            end;
        end;            
        d.rec.ClientName = ClientName;
        d.rec.ClientCode = ClientCode;

        /* ВР. Тема Айса 231751. */
        d.rec.ContrName = ContrName;
        d.rec.ContrCode = ContrCode;
    end;

    macro PrintParams(arr)
        private var i:integer, N:integer;
        N = arr.size;
        i = 0;
        while(i < N)
            println(arr(i));
            i = i + 1;
        end;
    end;

    macro Dialog1(d, m, f, k)
        var delta:integer = 0; // у панелек разная высота. Отличия - на указанную величину
        var party:TRecHandler;
        var partcode = TBFile( "partcode.dbt",  "R", 0 );

        if (m == DLG_INIT)  /* Заполнение начальных данных. Установка фокуса требует возврата CM_IGNORE */    
            
            LoadParams(@d);
            
            UpdateFields(d);       
            SetFocus(d, 0);
            return CM_IGNORE;
    
        elif (m == DLG_SETFOCUS) /* Вызывается непосредственно перед установкой фокуса в поле "f" */
    /*        println("Установка фокуса на поле ", FldName(d, f));*/
        elif (m == DLG_REMFOCUS) /* Вызывается непосредственно перед переносом фокуса из поля "f" */
        elif (m == DLG_BUTTON)   /* Пользователь щёлкнул ПО КНОПКЕ!  */
        elif (m == DLG_MOUSE)    /* Пользователь использует мышку    */
        elif (m == DLG_KEY)      /* Пользователь нажал на клавиатуре */
    
            if(k == ESC)
                NextStatus = -1;
                return CM_CANCEL;
            elif(k == F2)
                NextStatus = 0;
                return CM_SAVE;
            elif(k == F3)

                if(NextStatus == 1) // смещение по вертикали MENUшек (из-за разной формы диалоговых панелек)
                    delta = 0;
                else
                    delta = 6;
                end;

                if(FldName(d, f) == "RepType")
                    MenuRes = Menu(RepType_names, "Введите тип отчёта", "", 15, 4);
                    if(MenuRes >= 0)
                        d.rec.RepType = RepType_names(MenuRes);
                        RepType_selected = MenuRes;
                        if(MenuRes == 0) /* выбрали За дату*/
                            if(NextStatus != 1) /* а сейчас была панелька "за период" */
                                NextStatus = 1;
                                SaveParams(d); //printparams(params);
                                return CM_CANCEL;
                            end;
                        else /* выбрали За период */
                            if(NextStatus != 2) /* а сейчас была панелька "за дату" */
                                NextStatus = 2;
                                SaveParams(d); //printparams(params);
                                return CM_CANCEL;
                            end;
                        end;

                    end;
                elif(FldName(d, f) == "DealType")
                    MenuRes = Menu(DealType_names, "Введите тип сделок", "", 15, 6 + delta);
                    if(MenuRes >= 0)
                        d.rec.DealType = DealType_names(MenuRes);
                        DealType_selected = MenuRes;
                    end;
                elif(FldName(d, f) == "Trade")
                   
                    MenuRes = Menu(Markets_names, "", "", 25, 8 + delta);
                    if(MenuRes >= 0)
                        d.rec.Trade = Markets_names(MenuRes);
                        Markets_selected = MenuRes;
                    end;                         
                elif(FldName(d, f) == "Conv")
                    MenuRes = Menu(Conv_names, "", "", 25, 10 + delta);
                    if(MenuRes >= 0)
                        d.rec.Conv = Conv_names(MenuRes);
                        Conv_selected = MenuRes;
                    end;                
                elif(FldName(d, f) == "PriceType")
    
                    MenuRes = Menu(PriceType_names, "", "", 12, 12 + delta);
                    if(MenuRes >= 0)
                        d.rec.PriceType = PriceType_Names(MenuRes);
                        PriceType_selected = MenuRes;
                    end;                
                elif(FldName(d, f) == "ClientCode")
                    
                    Party = TRecHandler("party.dbt");

                    if(ListPT( Party, SelCodeKind, "", PTLIST_STOCKDLCLIENT, PTCK_ALL) == true )
                        partcode.Clear();
                        partcode.rec.PartyID  = Party.rec.PartyID;
                        partcode.rec.CodeKind = SelCodeKind;
                        if(partcode.GetEQ())
                            d.rec.ClientCode = partcode.rec.Code;                        
                            d.rec.ClientName = Party.rec.shortname;
                            ClientID_Selected = Party.rec.PartyID;
                            ClientCode = d.rec.ClientCode;
                            ClientName = d.rec.ClientName;
                        else
                            d.rec.ClientCode = "";
                            d.rec.ClientName = "";
                            ClientID_Selected = -1;
                            ClientCode = d.rec.ClientCode;
                            ClientName = d.rec.ClientName;
                        end;
                    end;
                /* ВР. Тема Айса 231751. */
                elif(FldName(d, f) == "ContrCode")
                    
                    Party = TRecHandler("party.dbt");

                    if(ListPT( Party, SelCodeKind, "", PTLIST_CONTR, PTCK_ALL) == true )
                        partcode.Clear();
                        partcode.rec.PartyID  = Party.rec.PartyID;
                        partcode.rec.CodeKind = SelCodeKind;
                        if(partcode.GetEQ())
                            d.rec.ContrCode = partcode.rec.Code;                        
                            d.rec.ContrName = Party.rec.shortname;
                            ContrID_Selected = Party.rec.PartyID;
                            ContrCode = d.rec.ContrCode;
                            ContrName = d.rec.ContrName;
                        else
                            d.rec.ContrCode = "";
                            d.rec.ContrName = "";
                            ContrID_Selected = -1;
                            ContrCode = d.rec.ContrCode;
                            ContrName = d.rec.ContrName;
                        end;
                    end;
    
                end;

                /* Сделаем выбор возможных периодов (больше, больше либо равно, с..по,...)*/

                if(Substr(FldName(d, f), 1, 3) == "Cmp") /* у нас ПЯТЬ полей: Cmp1, Cmp2, ... Cmp5. Так объединим ) */

                    cmp_n = substr(FldName(d, f), 4, 1); 
                    
                    MenuRes = Menu(Cmps, "", "", 25, 4 + int(cmp_n));
                    if(MenuRes >= 0)
                    /* Таки выбрали какой-либо пунктик */    
                        if(MenuRes == 0)
                            /* Выбрали ЛЮБУЮ дату, то есть дату данного типа мы не будем рассматривать в выборке.
                               Так что все поля "затеняем"
                            */
                            d.item(f) = substr(Cmps(MenuRes), 1, 1);
                            d.item("d" + cmp_n + "start") = date(0,0,0);
                            DisableFields(d, FldIndex(d, "d" + cmp_n + "start"));
                            d.item("d" + cmp_n + "finish") = date(0,0,0);
                            DisableFields(d, FldIndex(d, "d" + cmp_n + "finish"));
                        elif(MenuRes == 6)
                            /* Выбрали полноценный период С..ПО */
                            d.item(f) = substr(Cmps(MenuRes), 1, 1);
                            d.item("d" + cmp_n + "start") = _RepDate;
                            EnableFields(d, FldIndex(d, "d" + cmp_n + "start"));
                            d.item("d" + cmp_n + "finish") = _RepDate;
                            EnableFields(d, FldIndex(d, "d" + cmp_n + "finish"));
                        else
                            /* Выбрали 1 дату, относительно которой и "поём" (>, >=, <, <=, =) */
                            d.item(f) = substr(Cmps(MenuRes), 1, 1);
                            d.item("d" + cmp_n + "start") = _RepDate;
                            EnableFields (d, FldIndex(d, "d" + cmp_n + "start"));
                            d.item("d" + cmp_n + "finish") = date(0,0,0);
                            DisableFields(d, FldIndex(d, "d" + cmp_n + "finish"));
                        end;
                    end;
                end;


                UpdateFields(d);

            elif((k == Tab) or (k == k_DOWN) or (k == ENTER))
                /* Тут будут сложности - так как часть полей может быть отключена, то их надо "перепрыгивать". 
                   Отключиться может только 1 или 2 поля подряд, так что будем пробовать взять ещё 1 или 2 поля 
                       и сразу на них прыгнуть 
                */
                if(not     SetFocus(d, mod(f+1, d.FldNumber)))
                    if(not SetFocus(d, mod(f+2, d.FldNumber)))
                           SetFocus(d, mod(f+3, d.FldNumber));
                    end;
                end;
            elif(k == k_UP)
                /* Аналогично переходу по TAB/DOWN/ENTER */
                if(not     SetFocus(d, mod(f-1 + d.FldNumber, d.FldNumber)))
                    if(not SetFocus(d, mod(f-2 + d.FldNumber, d.FldNumber)))
                           SetFocus(d, mod(f-3 + d.FldNumber, d.FldNumber));
                    end;
                end;
            else
            end;
            return CM_IGNORE;
        elif (m == DLG_SAVE)   /* Вызывается при выходе с сохранением данных */
            SaveParamsForExit(d);
        elif (m == DLG_DESTROY)
        else
             return CM_DEFAULT;
        end;
    end;
    

    /* Заполняем возможные параметры для отчёта и значения по-умолчанию */
    SetParameters();
    SaveParams();
    
    NextStatus = 1;
    while(NextStatus > 0)
       CurStatus = NextStatus;
       if(NextStatus == 1)
           RunDialog(dlg1, "Dialog1");
       elif(NextStatus == 2)
           RunDialog(dlg2, "Dialog1");
       end;
       
    end;

    if(NextStatus == -1)
        println("Мы вышли из диалогового окна");
        Params.size = 0;
        return Params;
    end;

/*
    if(CurStatus == 1)
        copy(b,dlg1);
        return 1;
    elif(CurStatus == 2)
        copy(b,dlg2);
        return 1;
    end;
*/
    return Params;

end; // end of ShowDialog




macro main()

     /* Параметры выпуска отчёта и значения по умолчанию при загрузке диалога */
     private var p_RepType    =  2;    /* 1 - за дату, 2 - за период */
     private var p_DealType   = -1;    /* 1 - покупка ЦБ, 2 - продажа ЦБ, 3 - прямое РЕПО, 4 - обратное РЕПО, -1 - все сделки */
     private var p_Market     = -1;    /* ID торговой площадки, -1 - все */
     private var p_Conv2Money =  0;    /* 0 - переводить % в деньги, 1 - оставлять в прцоентах */
     private var p_PriceType  =  4;    /* ID цены, на которую ориентируемся */
     private var p_ClientID   = -1;    /* ID клиента, по которому делаем выборку. -1 - собственные */
     private var p_ContrID    = -1;    /* ID контрагента, по которому делаем выборку. -1 - собственные */  /* ВР. Тема Айса 231751 */
     private var p_RepDate:date = {CurDate};
  
     /* Если отчёт за период, то это даты начала и окончания 0: */
     private var p_Period_Start = TArray(); 
     private var p_Period_Finish = TArray();
    

    private macro SQLDate(d:date):string
    /* банальное преобразование типов. Из RSL'ного типа DATE получаем SQL'ный DATE*/

        private var res:string = "";
        if((ValType(d) == V_UNDEF) or (d == date(0,0,0)))
            res = "to_date('1.1.1', 'dd.mm.yyyy')";
        else
            res = "to_date('" + d + "', 'dd.mm.yyyy')";
        end;
        return res;   

    end;

    private macro printds(_ds)
    /* Отладочная процедурка - выводит в стандартный вывод все поля текущей записи DataSet'а */
        private var i:integer = 0, N:integer = 0;
        N = _ds.FldCount();
        println(N + " fields");
        if(N > 0)
            while(i<N-1)
                print(_ds.Value(i) + ", ");
                i = i + 1;
            end;
            println(_ds.Value(N-1));
        end;
    end;

/*
    private macro MakeSQL_DealInfo(_RepType:integer, _RepDate:date, _Period_Start:TArray, _Period_Finish:TArray, _ClientID:integer, _Market:integer, _DealType:integer)
  ВР. Тема Айса 231751.
*/
    private macro MakeSQL_DealInfo(_RepType:integer, _RepDate:date, _Period_Start:TArray, _Period_Finish:TArray, _ClientID:integer, _Market:integer, _DealType:integer, _ContrID:integer)
        private var q:string = "";

        q = q + " SELECT DISTINCT deal.t_dealid as DealID, deal.t_dealcodets as DealCodeTS, deal.t_dealdate as DealDate, deal.t_dealtype as DealType, deal.t_dealcode as DealCode,";
        q = q + "                 deal.t_partyid as DealContragent, deal.t_clientid as DealClient, deal.t_PFI as DealFI, ";
/*SD - 1996769*/
        q = q + " (select nvl(t_attrid,0) from dobjlink_dbt where t_objecttype=101  and t_objectid=lpad(deal.t_dealid,34,'0')) as realcontr ,";

        /* данные по первой ноге */
        q = q + "                 leg1.t_maturity as L1Date, leg1.t_price as L1Price, leg1.t_nkd as L1NKD, leg1.t_totalcost as L1TotalCost, leg1.t_principal as L1Amount, ";
        q = q + "                 leg1.t_relativeprice as L1RelPrice, leg1.t_pfi as L1pfi, ";

        q = q + "                 curr.t_ccy as DealCurr ";
        
        /* дата поставки (1 нога) */
     /* q = q + "               , (SELECT t_valuedate ";
        q = q + "                    FROM dpmpaym_dbt ";
        q = q + "                   WHERE t_documentid = deal.t_dealid ";
        q = q + "                     and t_purpose = 1 ";
        q = q + "                     and t_dockind = 101 ";
        q = q + "                 ) as DateMat1 ";  
        ААИ переход на 31  */
        q = q + "               , (SELECT t_plandate ";
        q = q + "                    FROM ddlrq_dbt ";
        q = q + "                   WHERE t_docid = deal.t_dealid ";
        q = q + "                     and t_type = 8 ";
        q = q + "                     and t_dealpart = 1 ";
        q = q + "                     and t_dockind = 101 ";
        q = q + "                 ) as DateMat1 ";  
 

        /* дата оплаты (1 нога) */                               
   /*   q = q + "               , (SELECT t_valuedate ";
        q = q + "                    FROM dpmpaym_dbt ";
        q = q + "                   WHERE t_documentid = deal.t_dealid ";
        q = q + "                     and t_purpose = 2 ";
        q = q + "                     and t_dockind = 101 ";
        q = q + "                 ) as DatePay1 ";
        ААИ переход на 31  */
        q = q + "               , (SELECT t_plandate ";
        q = q + "                    FROM ddlrq_dbt ";
        q = q + "                   WHERE t_docid = deal.t_dealid ";
        q = q + "                     and t_type = 2 ";
        q = q + "                     and t_dealpart = 1 ";
        q = q + "                     and t_dockind = 101 ";
        q = q + "                 ) as DatePay1 ";
                               
   /*   q = q + "               , (SELECT t_amount ";
        q = q + "                    FROM dpmpaym_dbt ";
        q = q + "                   WHERE t_documentid = deal.t_dealid ";
        q = q + "                     and t_purpose = 61 ";  /* !!! Точно 61?*/
        q = q + "                     and t_dockind = 101 ";
        q = q + "                 ) as KDSum ";
        ААИ переход на 31   */
        /*выплаты КД */
        q = q + "               , NVL((SELECT sum(t_amount) ";
        q = q + "                    FROM ddlrq_dbt ";
        q = q + "                   WHERE t_docid = deal.t_dealid ";
        q = q + "                     and t_type = 4 ";   
        q = q + "                     and t_dockind = 101 ";
        q = q + "                 ), 0) as KDSum ";
      


 //       q = q + "               , (SELECT t_amount ";   //ААИ Айс 327598
 /*     q = q + "               , (SELECT sum(t_amount) ";
        q = q + "                    FROM dpmpaym_dbt ";
        q = q + "                   WHERE t_documentid = deal.t_dealid ";
        q = q + "                     and t_purpose = 66 ";  
        q = q + "                     and t_dockind = 101 ";
        q = q + "                 ) as CompPaym ";  
        ААИ переход на 31  */
         /*комп. платежи*/
        q = q + "               , NVL((SELECT sum(t_amount) ";
        q = q + "                    FROM ddlrq_dbt ";
        q = q + "                   WHERE t_docid = deal.t_dealid ";
        q = q + "                     and t_type = 7 ";  
        q = q + "                     and t_dockind = 101 ";
        q = q + "                 ),0) as CompPaym ";  
     

        /* Аванс */
  /*    q = q + "               , (SELECT t_amount ";
        q = q + "                    FROM dpmpaym_dbt ";
        q = q + "                   WHERE t_documentid = deal.t_dealid ";
        q = q + "                     and t_purpose = 42 ";
        q = q + "                     and t_dockind = 101 ";
        q = q + "                 ) as Avans ";
         ААИ переход на 31  */

        q = q + "               ,NVL ((SELECT t_amount ";
        q = q + "                    FROM ddlrq_dbt ";
        q = q + "                   WHERE t_docid = deal.t_dealid ";
        q = q + "                     and t_type = 0 ";
        q = q + "                     and t_dealtype = 1"; 
        q = q + "                     and t_dockind = 101 ";
        q = q + "                 ), 0) as Avans ";
      

        /* Продолжим мучить основной select по сделке */
     /* q = q + "   FROM dpmpaym_dbt pm, ddl_tick_dbt deal, ddl_leg_dbt leg1, dfininstr_dbt curr ";
        ААИ переход на 31    */
        q = q + "   FROM ddlrq_dbt pm, ddl_tick_dbt deal, ddl_leg_dbt leg1, dfininstr_dbt curr ";

        q = q + "  WHERE pm.t_dockind = 101 ";
        if(_RepType == 2) /* задан интервал */
          if(_Period_Start(0) > MINDATE)
            q = q + "  and deal.t_dealdate >= " + SQLDate(_Period_Start(0));
          end;
          if(_Period_Finish(0) < MAXDATE)
            q = q + "  and deal.t_dealdate <= " + SQLDate(_Period_Finish(0));
          end;
    
 /*       if(_Period_Start(1) > MINDATE)
            q = q + "  and (SELECT t_valuedate FROM dpmpaym_dbt WHERE t_documentid = deal.t_dealid and t_purpose = 1 and t_dockind = 101) >= " + SQLDate(_Period_Start(1)); /* DateMat1 */
          end;
 ААИ переход на 31*/
          if(_Period_Start(1) > MINDATE)
            q = q + "  and (SELECT t_plandate FROM ddlrq_dbt WHERE t_docid = deal.t_dealid and t_type = 8 and t_dealpart = 1 and t_dockind = 101) >= " + SQLDate(_Period_Start(1)); /* DateMat1 */
          end;
 /*
          if(_Period_Finish(1) < MAXDATE)
            q = q + "  and (SELECT t_valuedate FROM dpmpaym_dbt WHERE t_documentid = deal.t_dealid and t_purpose = 1 and t_dockind = 101) <= " + SQLDate(_Period_Finish(1)); /* DateMat1 */
          end;
 ААИ переход на 31*/  
          if(_Period_Finish(1) < MAXDATE)
            q = q + "  and (SELECT t_plandate FROM ddlrq_dbt WHERE t_docid = deal.t_dealid and t_type = 8 and t_dealpart = 1 and t_dockind = 101) <= " + SQLDate(_Period_Finish(1)); /* DateMat1 */
          end;
/* 
          if(_Period_Start(2) > MINDATE)
            q = q + "  and (SELECT t_valuedate FROM dpmpaym_dbt WHERE t_documentid = deal.t_dealid and t_purpose = 2 and t_dockind = 101) >= " + SQLDate(_Period_Start(2)); /* DatePay1 */
          end;
ААИ переход на 31*/
          if(_Period_Start(2) > MINDATE)
            q = q + "  and (SELECT t_plandate FROM ddlrq_dbt WHERE t_docid = deal.t_dealid and t_type = 2 and t_dealpart = 1 and t_dockind = 101) >= " + SQLDate(_Period_Start(2)); /* DatePay1 */
          end;
/*
          if(_Period_Finish(2) < MAXDATE)
            q = q + "  and (SELECT t_valuedate FROM dpmpaym_dbt WHERE t_documentid = deal.t_dealid and t_purpose = 2 and t_dockind = 101) <= " + SQLDate(_Period_Finish(2)); /* DatePay1 */
          end;
ААИ переход на 31*/
          if(_Period_Finish(2) < MAXDATE)
            q = q + "  and (SELECT t_plandate FROM ddlrq_dbt WHERE t_docid = deal.t_dealid and t_type = 2 and t_dealpart = 1 and t_dockind = 101) <= " + SQLDate(_Period_Finish(2)); /* DatePay1 */
          end;
/*    
          if(_Period_Start(3) > MINDATE)
            q = q + "  and (SELECT t_valuedate FROM dpmpaym_dbt WHERE t_documentid = deal.t_dealid and t_purpose = 3 and t_dockind = 101) >= " + SQLDate(_Period_Start(3)); /* DateMat2 */
          end;
ААИ переход на 31*/
          if(_Period_Start(3) > MINDATE)
            q = q + "  and (SELECT t_plandate FROM ddlrq_dbt WHERE t_docid = deal.t_dealid and t_type = 8 and t_dealpart = 2 and t_dockind = 101) >= " + SQLDate(_Period_Start(3)); /* DateMat2 */
          end;
/*
          if(_Period_Finish(3) < MAXDATE)
            q = q + "  and (SELECT t_valuedate FROM dpmpaym_dbt WHERE t_documentid = deal.t_dealid and t_purpose = 3 and t_dockind = 101) <= " + SQLDate(_Period_Finish(3)); /* DateMat2 */
          end;
ААИ переход на 31*/
          if(_Period_Finish(3) < MAXDATE)
            q = q + "  and (SELECT t_plandate FROM ddlrq_dbt WHERE t_docid = deal.t_dealid and t_type = 8 and t_dealpart = 2 and t_dockind = 101) <= " + SQLDate(_Period_Finish(3)); /* DateMat2 */
          end;
/*
          if(_Period_Start(4) > MINDATE)
            q = q + "  and (SELECT t_valuedate FROM dpmpaym_dbt WHERE t_documentid = deal.t_dealid and t_purpose = 4 and t_dockind = 101) >= " + SQLDate(_Period_Start(4)); /* DatePay2 */
          end;
ААИ переход на 31*/
          if(_Period_Start(4) > MINDATE)
            q = q + "  and (SELECT t_plandate FROM ddlrq_dbt WHERE t_docid = deal.t_dealid and t_type = 2 and t_dealpart = 2 and t_dockind = 101) >= " + SQLDate(_Period_Start(4)); /* DatePay2 */
          end;
/*
          if(_Period_Finish(4) < MAXDATE)
            q = q + "  and (SELECT t_valuedate FROM dpmpaym_dbt WHERE t_documentid = deal.t_dealid and t_purpose = 4 and t_dockind = 101) <= " + SQLDate(_Period_Finish(4)); /* DatePay2 */
          end;
ААИ переход на 31*/
          if(_Period_Finish(4) < MAXDATE)
            q = q + "  and (SELECT t_plandate FROM ddlrq_dbt WHERE t_docid = deal.t_dealid and t_type = 2 and t_dealpart = 2 and t_dockind = 101) <= " + SQLDate(_Period_Finish(4)); /* DatePay2 */
          end;

        elif(_RepType == 1)
          /* Отчёт на дату, заданную параметром d11 */
    /*    q = q + " and pm.t_purpose in (1,2,3,4,42,43) ";
          q = q + " and (pm.t_valuedate > " + SQLDate(_RepDate);
          q = q + "      or  (     pm.t_valuedate <= " + SQLDate(_RepDate);
          q = q + "            and pm.t_paymstatus in (58,59,0,1000,3000) ";
          q = q + "            and deal.t_dealstatus = 10 ";
          q = q + "          ) ";
          q = q + "     ) ";
          q = q + " and deal.t_dealdate <= " + SQLDate(_RepDate);
 ААИ переход на 31       */
          q = q + " and pm.t_type in (0, 2, 8) ";
          q = q + " and (pm.t_plandate > " + SQLDate(_RepDate);
          q = q + "      or  (     pm.t_plandate <= " + SQLDate(_RepDate);
          q = q + "            and pm.t_state in (0,2) ";
          q = q + "            and deal.t_dealstatus = 10 ";
          q = q + "          ) ";
          q = q + "     ) ";
          q = q + " and deal.t_dealdate <= " + SQLDate(_RepDate);
        end;

 //       q = q + "    and deal.t_dealid = pm.t_documentid ";
        q = q + "    and deal.t_dealid = pm.t_docid ";
        q = q + "    and deal.t_dealid = leg1.t_dealid ";
        q = q + "    and leg1.t_legkind = 0 ";
        q = q + "    and leg1.t_cfi = curr.t_fiid ";

        /* Условие на клиента */
        if(_ClientID > 0)
          q = q + "  and deal.t_clientid = " + string(_ClientID);  /* !!! */
        elif(_ClientID == -1)
          q = q + "  and deal.t_clientid = " + string(_ClientID);  /* !!! */
        end;

        /* ВР. Тема Айса 231751. Условие на контрагента */
        if(_ContrID != -1)
          q = q + "  and deal.t_partyid = " + string(_ContrID);  /* !!! */
        end;

        /* Условие на торговую площадку */
        if(_Market != -1)
          q = q + "  and deal.t_marketid = " + string(_Market);
        end;
 
        /* Условие на типы сделок */
/*
        if(_DealType == 1)  /* Покупка ЦБ */
          q = q + "  and deal.t_dealtype in (2140,2160,2180,12180,22140) ";  
        elif(_DealType == 2) /* Продажа ЦБ */
          q = q + "  and deal.t_dealtype in (2150,2170,2190,12190,22150) ";  
        elif(_DealType == 3) /* Прямое РЕПО */
          q = q + "  and deal.t_dealtype in (2126,2136) "; 
        elif(_DealType == 4) /* Обратное РЕПО */
          q = q + "  and deal.t_dealtype in (2121,2131) "; 
        elif(_DealType == -1) /* Покупка, продажа ЦБ, прямое и обратное РЕПО */
          q = q + "  and deal.t_dealtype in (2140,2160,2180,12180,22140,2150,2170,2190,12190,22150,2126,2136,2121,2131) ";
        end;
  ВР. Тема Айса 225647.
*/
        if(_DealType == 1)  /* Покупка ЦБ */
/*
          q = q + "  and deal.t_dealtype in (2140,2160,2180,32140,32160,32180) ";  
  ВР. Тема Айса 231751.
*/
          q = q + "  and deal.t_dealtype in (SELECT t_kind_operation " +
                  "                            FROM doprkoper_dbt " +
                  "                           WHERE t_dockind = 101 AND INSTR (t_systypes, 'B') > 0 AND INSTR (t_systypes, 't') = 0)";
        elif(_DealType == 2) /* Продажа ЦБ */
/*
          q = q + "  and deal.t_dealtype in (2150,2170,2190,32150,32170,32190) ";  
  ВР. Тема Айса 231751.
*/
          q = q + "  and deal.t_dealtype in (SELECT t_kind_operation " +
                  "                            FROM doprkoper_dbt " +
                  "                           WHERE t_dockind = 101 AND INSTR (t_systypes, 'S') > 0 AND INSTR (t_systypes, 't') = 0)";
        elif(_DealType == 3) /* Прямое РЕПО */
/*
          q = q + "  and deal.t_dealtype in (2126,2136,32126,32136) "; 
  ВР. Тема Айса 231751.
*/
          q = q + "  and deal.t_dealtype in (SELECT t_kind_operation " +
                  "                            FROM doprkoper_dbt " +
                  "                           WHERE t_dockind = 101 AND INSTR (t_systypes, 'S') > 0 AND INSTR (t_systypes, 't') > 0)";
        elif(_DealType == 4) /* Обратное РЕПО */
/*
          q = q + "  and deal.t_dealtype in (2121,2131,32121,32131) "; 
  ВР. Тема Айса 231751.
*/
          q = q + "  and deal.t_dealtype in (SELECT t_kind_operation " +
                  "                            FROM doprkoper_dbt " +
                  "                           WHERE t_dockind = 101 AND INSTR (t_systypes, 'B') > 0 AND INSTR (t_systypes, 't') > 0)";
        elif(_DealType == -1) /* Покупка, продажа ЦБ, прямое и обратное РЕПО */
        end;

        q = q + " ORDER BY t_dealdate ";
        q = q + "";

        return q;
    end;


    private macro MakeSQL_FIinfo(fiid:integer, d1:date, d2:date):string
    /* Создаём запрос для выборки информации по финансовому инстурменту
       Входные параметры: fiid - id финансового инструмента, dfininstr.t_fiid
                          d1, d2 - "с..по"
       На выходе: запрос на SQL для получения данных.
    */

        var q:string = "";
        q = q + "SELECT fi.t_fi_code as SecCode, fi.t_name as SecName, fi.t_facevalue as SecFaceVal, curr2.t_name as FaceValCur, p.t_name as Emitent, fi.t_issued as RegDate, iss.t_lsin as LSIN, iss.t_isin as ISIN";
/*
        /* Дата погашения купона */
        q = q + "     , (SELECT wrt.t_drawingdate "; //
        q = q + "          FROM dfiwarnts_dbt wrt ";
        q = q + "         WHERE wrt.t_fiid = fi.t_fiid ";
        q = q + "           and wrt.t_ispartial != 'X' ";
        q = q + "           and wrt.t_drawingdate >= " + SQLDate(d1);
        q = q + "           and wrt.t_drawingdate <= " + SQLDate(d2);
        q = q + "       ) as CouponDate ";
                      
        /* ставка дохода */
        q = q + "     , (SELECT wrt.t_incomerate ";  //
        q = q + "          FROM dfiwarnts_dbt wrt ";
        q = q + "         WHERE wrt.t_fiid = fi.t_fiid ";
        q = q + "           and wrt.t_ispartial != 'X' ";
        q = q + "           and wrt.t_drawingdate >= " + SQLDate(d1);
        q = q + "           and wrt.t_drawingdate <= " + SQLDate(d2);
        q = q + "       ) as CouponPercents ";
  ВР. Тема Айса 191439. 
*/                      
        /* Дата погашения купона */
        q = q + "     , (SELECT * FROM (SELECT wrt.t_drawingdate ";
        q = q + "                         FROM dfiwarnts_dbt wrt ";
        q = q + "                        WHERE wrt.t_fiid = " + string(fiid);
        q = q + "                          and wrt.t_ispartial != 'X' ";
        q = q + "                          and wrt.t_drawingdate <= " + SQLDate(d2);
        q = q + "                     ORDER BY wrt.t_drawingdate DESC ";
        q = q + "                      ) WHERE ROWNUM = 1 ";
        q = q + "       ) as CouponDate ";
                      
        /* ставка дохода */
        q = q + "     , (SELECT * FROM (SELECT wrt.t_incomerate ";
        q = q + "                         FROM dfiwarnts_dbt wrt ";
        q = q + "                        WHERE wrt.t_fiid = " + string(fiid);
        q = q + "                          and wrt.t_ispartial != 'X' ";
        q = q + "                          and wrt.t_drawingdate >= " + SQLDate(d1);
        q = q + "                          and wrt.t_drawingdate <= " + SQLDate(d2);
        q = q + "                     ORDER BY wrt.t_drawingdate DESC ";
        q = q + "                      ) WHERE ROWNUM = 1 ";
        q = q + "       ) as CouponPercents ";


        /* сумма дохода */
        q = q + "     , (SELECT distinct(wrt.t_incomevolume) ";
        q = q + "          FROM dfiwarnts_dbt wrt ";
        q = q + "         WHERE wrt.t_fiid = fi.t_fiid ";
        q = q + "           and wrt.t_ispartial != 'X' ";
        q = q + "           and wrt.t_drawingdate >= " + SQLDate(d1);
        q = q + "           and wrt.t_drawingdate <= " + SQLDate(d2);  /* ТОЧНО ЛИ ЭТА ДАТА? */
        q = q + "       ) as CouponAmount ";
                      
        q = q + "     , (SELECT wrt.t_incomerate ";
        q = q + "          FROM dfiwarnts_dbt wrt ";
        q = q + "         WHERE wrt.t_fiid = fi.t_fiid ";
        q = q + "           and wrt.t_ispartial != 'X' ";
        q = q + "           and wrt.t_drawingdate = ";
        q = q + "                   (SELECT min(wrt3.t_drawingdate) ";
        q = q + "                      FROM dfiwarnts_dbt wrt3 ";
        q = q + "                     WHERE wrt3.t_fiid = fi.t_fiid ";
        q = q + "                       and wrt3.t_ispartial != 'X' ";
        q = q + "                       and wrt3.t_drawingdate >= " + SQLDate(d1);
        q = q + "                   ) ";
        q = q + "       ) as SecPercents ";
                      
        q = q + "     , (SELECT wrt.t_incomevolume ";
        q = q + "          FROM dfiwarnts_dbt wrt ";
        q = q + "         WHERE wrt.t_fiid = fi.t_fiid ";
        q = q + "           and wrt.t_ispartial != 'X' ";
        q = q + "           and wrt.t_drawingdate = ";
        q = q + "                   (SELECT min(wrt3.t_drawingdate) ";
        q = q + "                      FROM dfiwarnts_dbt wrt3 ";
        q = q + "                     WHERE wrt3.t_fiid = fi.t_fiid ";
        q = q + "                       and wrt3.t_ispartial != 'X' ";
        q = q + "                       and wrt3.t_drawingdate >= " + SQLDate(d1);
        q = q + "                   ) ";
        q = q + "       ) as SecPercentsAmount ";
        
        /* Название типа бумаги (ОФЗ, обыкновенная акция, ...) */
        q = q + "     , (SELECT t_name ";
        q = q + "          FROM davrkinds_dbt ";
        q = q + "         WHERE t_avoirkind = fi.t_avoirkind ";
        q = q + "           and t_fi_kind = 2 ";
        q = q + "       ) as SecType ";

        /* параметры основного select'а */
        q = q + "  FROM dfininstr_dbt fi, dfininstr_dbt curr2, davoiriss_dbt iss, dparty_dbt p ";
        q = q + " WHERE fi.t_fiid = " + string(fiid);
        q = q + "   and fi.t_facevaluefi = curr2.t_fiid ";
        q = q + "   and fi.t_fiid = iss.t_fiid ";
        q = q + "   and fi.t_issuer = p.t_partyid ";

        q = q + "";

        return q;

    end; /* end of macro MakeSQL_FIinfo */


/*══════════════════════════════════════════════════════════════════════════════════════════════════*/


    private macro MakeSQL_ContrInfo(ContrID:integer):string
    /* Создаём запрос для выборки информации по субъекту
       На входе: ID субъекта (dparty_dbt.t_partyid)
       На выходе: строка с запросом
    */

        private var q:string = "";

        q = q + " SELECT subj.t_partyid ContragentID, subj.t_shortname ContragentName, subj.t_nrcountry ContragentCountry ";
        q = q + "   FROM dparty_dbt subj ";
        q = q + "  WHERE subj.t_partyid = " + string(ContrID);
        q = q + "";

        return q;

    end; /* end of macro MakeSQL_ContrInfo */


    private macro MakeSQL_GetSecondLeg(DealId:integer):string

        private var q:string = "";

        q = q + " SELECT leg2.t_maturity as L2Date, leg2.t_price as L2Price, leg2.t_nkd as L2NKD, leg2.t_totalcost as L2TotalCost, ";
        q = q + "        leg2.t_principal as L2Amount, leg2.t_returnincome as L2PercentsDeal, leg2.t_incomerate as L2PercentsREPO ";

        /* дата базового актива */
/*      q = q + "      , (SELECT t_valuedate ";
        q = q + "           FROM dpmpaym_dbt ";
        q = q + "          WHERE t_documentid = " + string(DealId);
        q = q + "            and t_purpose = 3 ";
        q = q + "            and t_dockind = 101 ";
        q = q + "        ) as DateMat2 ";
*/
        q = q + "      , (SELECT t_plandate ";
        q = q + "           FROM ddlrq_dbt ";
        q = q + "          WHERE t_docid = " + string(DealId);
        q = q + "            and t_type = 8 ";
        q = q + "            and t_dealpart = 2 ";
        q = q + "            and t_dockind = 101 ";
        q = q + "        ) as DateMat2 ";
        /* дата контрактива */              
/*      q = q + "      , (SELECT t_valuedate ";
        q = q + "           FROM dpmpaym_dbt ";
        q = q + "          WHERE t_documentid = " + string(DealId);
        q = q + "            and t_purpose = 4 ";
        q = q + "            and t_dockind = 101 ";
        q = q + "        ) as DatePay2 ";
*/
        q = q + "      , (SELECT t_plandate ";
        q = q + "           FROM ddlrq_dbt ";
        q = q + "          WHERE t_docid = " + string(DealId);
        q = q + "            and t_type = 2 ";
        q = q + "            and t_dealpart = 2 ";
        q = q + "            and t_dockind = 101 ";
        q = q + "        ) as DatePay2 ";
        /* Основной select */
        q = q + "   FROM ddl_leg_dbt leg2 ";
        q = q + "  WHERE leg2.t_dealid = " + string(DealID);
        q = q + "    and leg2.t_legkind = 2 ";

        q = q + "";

        return q;

    end; /* end of macro MakeSQL_GetSecondLeg */


/*══════════════════════════════════════════════════════════════════════════════════════════════════*/


    private macro MakeSQL_GetNominal(fiid:integer, _d:date)
        private var q:string = "";

        q = q + " SELECT fi.t_facevalue, curr.t_name ";
        q = q + "        , (SELECT sum(w.t_incomerate) ";
        q = q + "             FROM dfiwarnts_dbt w ";
        q = q + "            WHERE w.t_ispartial = 'X' ";
        q = q + "              and w.t_drawingdate <= " + SQLDate(_d);
        q = q + "              and w.t_fiid = fi.t_fiid ";
        q = q + "           ) as PartNom ";
        q = q + "   FROM dfininstr_dbt fi, dfininstr_dbt curr ";
        q = q + "  WHERE fi.t_fiid = " + string(fiid);
        q = q + "    and fi.t_facevaluefi = curr.t_fiid ";

        return q;
    end;

    private macro GetNominal(fiid:integer, _date:date, _curr:@string)
        private var ds = TRsbDataSet(MakeSQL_GetNominal(fiid, _date));
        private var perc, begnom;
        private var result:double = 0.0, cur = "";


        if(ds.movenext())
            if(ValType(ds.PartNom) == V_UNDEF)
                perc = 0.0;
            else
                perc = ds.PartNom;
            end;
            begnom = ds.t_facevalue;

            result = (100 - perc)*0.01*BegNom;
            cur  = ds.t_name;
        end;
        _curr = cur;
        return result;
    end;


/*══════════════════════════════════════════════════════════════════════════════════════════════════*/


    private macro MakeSQL_GetPrice(fiid:integer, _d:date, _PriceType:integer)
    /* Получаем цену типа _PriceType финансового инструмента fiid на дату _d
       Если Conv = TRUE, то переводим проценты в деньги

    */
        var q:string = "";
      
        q = q + " SELECT hist.t_sincedate, hist.t_rate, hist.t_point, curr.t_name, rate.t_isrelative ";
        q = q + "   FROM dratehist_dbt hist, dratedef_dbt rate, dfininstr_dbt fi, dfininstr_dbt curr ";
        q = q + "  WHERE hist.t_rateid = rate.t_rateid ";
        q = q + "    and fi.t_fiid = " + string(fiid);
        q = q + "    and rate.t_otherfi = fi.t_fiid ";
        q = q + "    and rate.t_fiid = curr.t_fiid ";
        q = q + "    and rate.t_type = " + string(_PriceType);
        q = q + "    and hist.t_sincedate = ";
        q = q + "                           (SELECT max(hist2.t_sincedate) ";
        q = q + "                              FROM dratehist_dbt hist2 ";
        q = q + "                             WHERE hist2.t_sincedate <= " + SQLDate(_d);
        q = q + "                               and hist2.t_rateid = rate.t_rateid ) ";

        return q;

    end;

    private macro GetPrice(fiid:integer, _d:date, _PriceType:integer, Conv:integer, Curr:@string):money
    /* Таки получить цену в процентах (Conv = FALSE) или деньгах (Conv = TRUE) */
        private var ds;
        private var res, result = 0.0, nominal, nom_cur:string;

        ds = TRsbDataSet(MakeSQL_GetPrice(fiid, _d, _PriceType));

        if(ds.movenext())
            res = round(double(ds.t_rate)/pow(10.0, ds.t_point), 4); /* вот такой кракозяблик */
            if(ds.t_isrelative != "X")
            /* цена и так выражена в абсолютных значениях */
                result  = res;
                nom_cur = string(ds.t_name);
            elif(Conv == 0)
            /* Цена выражена НЕ в абсолютных значениях и мы хотим % конвертировать в $$$ */                
                nominal = GetNominal(fiid, _d, @nom_cur);
/*
                result  = res * nominal;
  ВР. Тема Айса 191439.
*/
                result  = res * nominal / 100;

                curr    = string(nom_cur);
            else
            /* Цена НЕ в абсолютных значениях и при этом конвертировать % в $ не хотим */
                result  = res;
                nom_cur = "%";
            end;
        end;
        Curr = string(nom_cur);

        return result;
    end;

/*  ВР. Тема Айса 191439. <********** */
    macro ПриведениеЦены(fiid, ЦенаВПроцентах, ЗначениеЦены, КонвертироватьВВалюту, ДатаСделки)
      var rValue;

      rValue = ЗначениеЦены;

      if(ЦенаВПроцентах and КонвертироватьВВалюту)
        rValue = ЗначениеЦены * GetNominal(fiid, ДатаСделки) / 100;
      end;

      return rValue;
    end;
/*                        **********> */

    private macro _GetClientName(_ClientID:integer)
        private var ds, result = "";
        if(_ClientID == -1)
            _ClientID = OurClientID;
        elif(_ClientID == 0)
            result = "ВСЕ";
            return result;
        end;
        ds = TRsbDataSet("SELECT t_name from dparty_dbt where t_partyid = "+string(_ClientID));
        if(ds.movenext())
            result = ds.t_name
        end;
        return result;
    end;

    private macro GetPriceName(PriceID:integer)
        var ds, result = "";
        ds = TRsbDataSet("select t_TypeName from dratetype_dbt where t_type = " + string(PriceID));
        if(ds.movenext())
            result = ds.t_TypeName;
        end;
        return result;
    end;
    
    private macro GetMarketName(MarketID:integer)
        var ds, result = "";

        ds = TRsbDataSet("select t_shortname from dparty_dbt where t_partyid = " + string(MarketID));
        if(ds.movenext())
            result = string(ds.t_shortname);
        end;
        return result;
    end;

/*══════════════════════════════════════════════════════════════════════════════════════════════════*/

    private macro PrintReport(_RepData)
    /* Итак, нам передан двумерный массив.
       Каждая строка - одна запись, в строке 38 элементов.
       Напечатаем их! :)
    */
        private var startrow:integer = 0, currow:integer = 0;
        NewExcelWorkbook (false);    


        private macro RGB(R:integer,G:integer,B:integer)

            return (R + G*256 + B*256*256);

        end; /* RGB */

        macro PrintHeader(Visible:bool)
            var range;
            var per:string = "";

        
            startrow = 1; 
            currow = startrow;

            ActiveSheet.Cells (currow,  1).Value = "Реестр сделок ";
            if(p_RepType == 1)
                ActiveSheet.Cells (currow,  1).Value = ActiveSheet.Cells (currow,  1).Value + " на дату " + p_RepDate;
                ActiveSheet.Range("A" + currow + ":D" + currow).Select;
                ExcelApplication.Selection.MergeCells = true;
                currow = currow + 1;
            else
                ActiveSheet.Cells (currow,  1).Value = ActiveSheet.Cells (currow,  1).Value + " за период: ";
                ActiveSheet.Range("A" + currow + ":D" + currow).Select;
                ExcelApplication.Selection.MergeCells = true;
                currow = currow + 1;

                per = "";
                if(p_Period_Start(0) > MINDATE)
                   per = per + string(p_Period_Start(0)) + " <= ";
                end;
                per = per + "Дата заключения сделки";
                if(p_Period_Finish(0) < MAXDATE)
                    per = per + " <= " + string(p_Period_Finish(0));
                end; 
                if(per != "Дата заключения сделки")
                    ActiveSheet.Cells (currow,  1).Value = per;
                    currow = currow + 1;
                end;

                per = "";
                if(p_Period_Start(1) > MINDATE)
                   per = per + string(p_Period_Start(1)) + " <= ";
                end;
                per = per + "Дата контрактива";
                if(p_Period_Finish(1) < MAXDATE)
                    per = per + " <= " + string(p_Period_Finish(1));
                end; 
                if(per != "Дата контрактива")
                    ActiveSheet.Cells (currow,  1).Value = per;
                    currow = currow + 1;
                end;

                per = "";
                if(p_Period_Start(2) > MINDATE)
                   per = per + string(p_Period_Start(2)) + " <= ";
                end;
                per = per + "Дата базового актива";
                if(p_Period_Finish(2) < MAXDATE)
                    per = per + " <= " + string(p_Period_Finish(2));
                end; 
                if(per != "Дата базового актива")
                    ActiveSheet.Cells (currow,  1).Value = per;
                    currow = currow + 1;
                end;

                per = "";
                if(p_Period_Start(3) > MINDATE)
                   per = per + string(p_Period_Start(3)) + " <= ";
                end;
                per = per + "Дата контрактива обр.";
                if(p_Period_Finish(3) < MAXDATE)
                    per = per + " <= " + string(p_Period_Finish(3));
                end; 
                if(per != "Дата контрактива обр.")
                    ActiveSheet.Cells (currow,  1).Value = per;
                    currow = currow + 1;
                end;

                per = "";
                if(p_Period_Start(4) > MINDATE)
                   per = per + string(p_Period_Start(4)) + " <= ";
                end;
                per = per + "Дата баз.актива обр";
                if(p_Period_Finish(4) < MAXDATE)
                    per = per + " <= " + string(p_Period_Finish(4));
                end;
                if(per != "Дата баз.актива обр")
                    ActiveSheet.Cells (currow,  1).Value = per;
                    currow = currow + 1;
                end;                
            end;

            if(p_DealType == 1)
                ActiveSheet.Cells (currow,  1).Value = "Вид сделок: Покупка ЦБ";
            elif(p_DealType == 2)
                ActiveSheet.Cells (currow,  1).Value = "Вид сделок: Продажа ЦБ";
            elif(p_DealType == 3)
                ActiveSheet.Cells (currow,  1).Value = "Вид сделок: Прямое РЕПО";
            elif(p_DealType == 4)
                ActiveSheet.Cells (currow,  1).Value = "Вид сделок: Обратное РЕПО";
            elif(p_DealType == -1)
                ActiveSheet.Cells (currow,  1).Value = "Вид сделок: Все";
            end;
            ActiveSheet.Range("A" + currow + ":D" + currow).Select;
            ExcelApplication.Selection.MergeCells = true;
            currow = currow + 1;
            
            if(p_Conv2Money == 0)
                ActiveSheet.Cells (currow,  1).Value = "Переводим проценты в деньги";
            else
                ActiveSheet.Cells (currow,  1).Value = "Не переводим проценты в деньги";
            end;
            ActiveSheet.Range("A" + currow + ":D" + currow).Select;
            ExcelApplication.Selection.MergeCells = true;
            currow = currow + 1;
            

            if(p_Market > 0)
                ActiveSheet.Cells (currow,  1).Value = "Биржа: " + GetMarketName(p_Market);
            else
                ActiveSheet.Cells (currow,  1).Value = "Биржи: ВСЕ";
            end;
            ActiveSheet.Range("A" + currow + ":D" + currow).Select;
            ExcelApplication.Selection.MergeCells = true;
            currow = currow + 1;


            ActiveSheet.Cells (currow,  1).Value = "Тип цены: " + GetPriceName(p_PriceType);
            ActiveSheet.Range("A" + currow + ":D" + currow).Select;
            ExcelApplication.Selection.MergeCells = true;
            currow = currow + 1;
          
            ActiveSheet.Cells (currow,  1).Value = "Клиент: " + _GetClientName(p_ClientID);
            ActiveSheet.Range("A" + currow + ":L" + currow).Select;
            ExcelApplication.Selection.MergeCells = true;
            currow = currow + 1;
            
        
            startrow = currow;
            ActiveSheet.Cells (currow,  1).Value = "ID сделки";
            ActiveSheet.Cells (currow,  2).Value = "Номер сделки";
            ActiveSheet.Cells (currow,  3).Value = "Дата заключения сделки";
            ActiveSheet.Cells (currow,  4).Value = "Тип сделки";
            ActiveSheet.Cells (currow,  5).Value = "Ставка РЕПО";
            ActiveSheet.Cells (currow,  6).Value = "Сумма процентов по сделке";
            ActiveSheet.Cells (currow,  7).Value = "Дата поставки 1 части";
            ActiveSheet.Cells (currow,  8).Value = "Дата оплаты 1 части";
            ActiveSheet.Cells (currow,  9).Value = "Цена 1 части";
            ActiveSheet.Cells (currow, 10).Value = "Количество бумаг 1 части";
            ActiveSheet.Cells (currow, 11).Value = "Проценты 1 части";
            ActiveSheet.Cells (currow, 12).Value = "Общая сумма 1 части";
            ActiveSheet.Cells (currow, 13).Value = "Дата поставки 2 части";
            ActiveSheet.Cells (currow, 14).Value = "Дата оплаты 2 части";
            ActiveSheet.Cells (currow, 15).Value = "Цена 2 части";
            ActiveSheet.Cells (currow, 16).Value = "Количество бумаг 2 части";
            ActiveSheet.Cells (currow, 17).Value = "Проценты 2 части";
            ActiveSheet.Cells (currow, 18).Value = "Общая сумма 2 части";
            ActiveSheet.Cells (currow, 19).Value = "Аванс по сделке";
            ActiveSheet.Cells (currow, 20).Value = "Валюта сделки";
            ActiveSheet.Cells (currow, 21).Value = "Код бумаги";
            ActiveSheet.Cells (currow, 22).Value = "Тип бумаги";
            ActiveSheet.Cells (currow, 23).Value = "ISIN";
            ActiveSheet.Cells (currow, 24).Value = "Номер гос.регистрации";
            ActiveSheet.Cells (currow, 25).Value = "Дата гос.регистрации";
            ActiveSheet.Cells (currow, 26).Value = "Наименование бумаги";
            ActiveSheet.Cells (currow, 27).Value = "Номинал бумаги";
            ActiveSheet.Cells (currow, 28).Value = "Валюта номинала";
            ActiveSheet.Cells (currow, 29).Value = "Процент по бумаге";
            ActiveSheet.Cells (currow, 30).Value = "Дата купона";
            ActiveSheet.Cells (currow, 31).Value = "Процент по купону";
            ActiveSheet.Cells (currow, 32).Value = "Сумма купона";
            ActiveSheet.Cells (currow, 33).Value = "Эмитент";
            ActiveSheet.Cells (currow, 34).Value = "ID контрагента";
            ActiveSheet.Cells (currow, 35).Value = "Наименоавние контрагента";
            ActiveSheet.Cells (currow, 36).Value = "Страна контрагента";
            ActiveSheet.Cells (currow, 37).Value = "Рыночная стоимость";
            ActiveSheet.Cells (currow, 38).Value = "Валюта цены";
            ActiveSheet.Cells (currow, 39).Value = "ID клиента";
            ActiveSheet.Cells (currow, 40).Value = "Наименование клиента";          
            ActiveSheet.Cells (currow, 41).Value = "Компенсационный платёж";
            ActiveSheet.Cells (currow, 42).Value = "Итого по 2 части РЕПО";
            ActiveSheet.Cells (currow, 43).Value = "Контрагент-участник торгов по адресным сделкам и РПС"; /*SD - 1996769*/
            ActiveSheet.Cells (currow, 44).Value = "Финансовый результат"; /*IT-31070*/
        
/* SD - 1996769
            Range = "A"+String (startrow)+":AP"+String (startrow);
*/
/* IT-31070
            Range = "A"+String (startrow)+":AQ"+String (startrow);
*/
            Range = "A"+String (startrow)+":AR"+String (startrow);
            ActiveSheet.Range (Range).Select;
            ExcelApplication.Selection.Interior.Color = RGB(200,200,200);
            ExcelApplication.Selection.WrapText = TRUE;
            
            currow = currow + 1;
        end;

        macro PrintBody(_Data:TArray)
            var i:integer, j:integer, N:integer, M:integer;
            var DealType:string = "", DealTypeID:integer = 0;
 
            N = _Data.size;
            i = 0;
            InitProgress(N, "Печать отчёта", "Печать отчёта");
            while(i<N)
                M = _Data.Value(i).size;
                j = 0;
                while(j < M)

                    if(j == 3)
                        DealTypeID = _Data.Value(i).Value(j);
/*
                        if((DealTypeID == 2126) or (DealTypeID == 2136) or (DealTypeID == 32126) or (DealTypeID == 32136))
                            DealType = "Прямое РЕПО";
                        elif((DealTypeID == 2121) or (DealTypeID == 2131) or (DealTypeID == 32121) or (DealTypeID == 32131))
                            DealType = "Обратное РЕПО";
                        elif((DealTypeID == 2140) or (DealTypeID == 2160) or (DealTypeID == 2180) or (DealTypeID == 32180) or (DealTypeID == 32140))
                            DealType = "Покупка ц/б";
                        elif((DealTypeID == 2150) or (DealTypeID == 2170) or (DealTypeID == 2190) or (DealTypeID == 32190) or (DealTypeID == 32150))
                            DealType = "Продажа ц/б";
                        else
                            DealType = string(DealTypeID);
                        end;
  ВР. Тема Айса 231751.
*/
                        DealTypeID = GetOperationGroup(DealTypeID);
                        if(IsREPO(DealTypeID) and IsSALE(DealTypeID))
                            DealType = "Прямое РЕПО";
                        elif(IsREPO(DealTypeID) and IsBUY(DealTypeID))
                            DealType = "Обратное РЕПО";
                        elif(not IsREPO(DealTypeID) and IsBUY(DealTypeID))
                            DealType = "Покупка ц/б";
                        elif(not IsREPO(DealTypeID) and IsSALE(DealTypeID))
                            DealType = "Продажа ц/б";
                        else
                            DealType = string(_Data.Value(i).Value(j));
                        end;

                        ActiveSheet.Cells (currow,  j+1).Value = DealType;

                    else
                        ActiveSheet.Cells (currow,  j+1).Value = _Data.Value(i).Value(j);
                    end;
                    j = j + 1;
                end;

                i = i + 1;
                UseProgress(i);
                CurRow = CurRow + 1;
            end;
            RemProgress();
        end;


        macro PrintFooter()
            var range;
           
            /* выделяем границы */
            if(currow > startrow + 1)
                /* В отчёте есть содержательные строки */
/* SD - 1996769
                Range = "A"+String (startrow)+":AP"+String (currow-1);
*/
/* IT-31070
            Range = "A"+String (startrow)+":AQ"+String (startrow);
*/
            Range = "A"+String (startrow)+":AR"+String (currow-1);

                ActiveSheet.Range (Range).Select;
                ExcelApplication.Selection.Borders (xlEdgeLeft).LineStyle = xlContinuous;
                ExcelApplication.Selection.Borders (xlEdgeTop).LineStyle = xlContinuous;
                ExcelApplication.Selection.Borders (xlEdgeBottom).LineStyle = xlContinuous;
                ExcelApplication.Selection.Borders (xlEdgeRight).LineStyle = xlContinuous;
                ExcelApplication.Selection.Borders (xlInsideVertical).LineStyle = xlContinuous;
                ExcelApplication.Selection.Borders (xlInsideHorizontal).LineStyle = xlContinuous;
/* SD - 1996769        
                Range = "A"+String (startrow+1)+":AP"+String (currow-1);
*/
/* IT-31070
            Range = "A"+String (startrow+1)+":AQ"+String (startrow-1);
*/
            Range = "A"+String (startrow+1)+":AR"+String (startrow-1);

                ActiveSheet.Range (Range).Select;
                ExcelApplication.Selection.Columns.Autofit;
        
        
            else
                /* в отчёте 0 содержательных строк, и только 1 - с заголовком */
/* SD - 1996769
                Range = "A"+String (startrow)+":AP"+String (startrow);
*/
/* IT-31070
            Range = "A"+String (startrow)+":AQ"+String (startrow);
*/
            Range = "A"+String (startrow)+":AR"+String (startrow);

                ActiveSheet.Range (Range).Select;
                ExcelApplication.Selection.Borders (xlEdgeLeft).LineStyle = xlContinuous;
                ExcelApplication.Selection.Borders (xlEdgeTop).LineStyle = xlContinuous;
                ExcelApplication.Selection.Borders (xlEdgeBottom).LineStyle = xlContinuous;
                ExcelApplication.Selection.Borders (xlEdgeRight).LineStyle = xlContinuous;
                ExcelApplication.Selection.Borders (xlInsideVertical).LineStyle = xlContinuous;
        
            end;
            
            /* выбираем первую ячейку и показываем отчёт */
            ActiveSheet.Range ("A1").Select;
            ExcelApplication.Visible = true;
        end;

        PrintHeader(false);
        PrintBody(_RepData);
        PrintFooter();

    end;

/*══════════════════════════════════════════════════════════════════════════════════════════════════*/

     private var DlgParams = TArray();
     
     private var i:integer, j:integer, N:integer, M:integer;
     private var query:string = "";    
     private var DataSet_Deal :object;
     private var DataSet_FI   :object;
     private var DataSet_Contr:object;
     private var DataSet_Leg2 :object;
     private var d1:date, d2:date;
     private var CurrName;

     private var sel, cmd, rs; //IT-31070
     private var FR = 0;//IT-31070
  
     private var RepData = TArray();
  
     i = 0;
     while(i < 5)
         p_Period_Start (i) = MINDATE;
         p_Period_Finish(i) = MAXDATE;
         i = i + 1;
     end;
  
    p_Period_Start(0)  = date(01,01,2010);
    p_Period_Finish(0) = date(31,01,2010);
  
    DlgParams = ShowDialog(p_RepDate);
    if(DlgParams.size == 0)
        msgbox("Вы отказались от выбора параметров.|Можете запустить отчёт ещё раз");
        return 0;
    elif(DlgParams.size == 8)
  
        p_RepType    = DlgParams(0);
        p_DealType   = DlgParams(1);
        p_Market     = DlgParams(2);
        p_Conv2Money = DlgParams(3);
        p_PriceType  = DlgParams(4);
        p_ClientID   = DlgParams(5);
        p_ContrID    = DlgParams(6); /* ВР. Тема Айса 231751 */
        p_RepDate    = DlgParams(7);
  
    elif(DlgParams.size  > 8)
        p_RepType    = DlgParams(0);
        p_DealType   = DlgParams(1);
        p_Market     = DlgParams(2);
        p_Conv2Money = DlgParams(3);
        p_PriceType  = DlgParams(4);
        p_ClientID   = DlgParams(5);
        p_ContrID    = DlgParams(6); /* ВР. Тема Айса 231751 */
  
        p_Period_Start (0) = DlgParams( 7);
        p_Period_Finish(0) = DlgParams( 8);
        p_Period_Start (1) = DlgParams( 9);
        p_Period_Finish(1) = DlgParams(10);
        p_Period_Start (2) = DlgParams(11);
        p_Period_Finish(2) = DlgParams(12);
        p_Period_Start (3) = DlgParams(13);
        p_Period_Finish(3) = DlgParams(14);
        p_Period_Start (4) = DlgParams(15);
        p_Period_Finish(4) = DlgParams(16);
  
    end;


    if(p_ClientID == OurClientID) /* Выбрали ТРАСТ, то есть свои сделки */
        p_ClientID = -1; // НУ вот аткое надо бы передать в обработку
    end;

/*
    query = MakeSQL_DealInfo(p_RepType, p_RepDate, p_Period_Start, p_Period_Finish, p_ClientID, p_Market, p_DealType);
  ВР. Тема Айса 231751.
*/
    query = MakeSQL_DealInfo(p_RepType, p_RepDate, p_Period_Start, p_Period_Finish, p_ClientID, p_Market, p_DealType, p_ContrID);
    DataSet_Deal = TRsbDataSet(query);

    i = 0;
    Repdata.size = 0;
    InitProgress(-1);
    while(DataSet_Deal.movenext())

      FR = 0;
        RepData.Value(i) = TArray();
        RepData.Value(i).Value( 0) = DataSet_Deal.DealID;
        RepData.Value(i).Value( 1) = string(DataSet_Deal.DealCodeTS);
        RepData.Value(i).Value( 2) = DataSet_Deal.DealDate;
        RepData.Value(i).Value( 3) = DataSet_Deal.DealType;
        RepData.Value(i).Value( 6) = DataSet_Deal.DateMat1;
        RepData.Value(i).Value( 7) = DataSet_Deal.DatePay1;
/*
        RepData.Value(i).Value( 8) = DataSet_Deal.L1Price;
 ВР. Тема Айса 191439.
*/
        RepData.Value(i).Value( 8) = ПриведениеЦены(DataSet_Deal.DealFI, (DataSet_Deal.L1RelPrice == "X"), 
                                                    DataSet_Deal.L1Price, (p_Conv2Money == 0), 
                                                    DataSet_Deal.L1Date);

        RepData.Value(i).Value( 9) = string(DataSet_Deal.L1Amount:0:0);
        RepData.Value(i).Value(10) = double(DataSet_Deal.L1NKD);
        RepData.Value(i).Value(11) = double(DataSet_Deal.L1TotalCost);       
        RepData.Value(i).Value(18) = double(DataSet_Deal.Avans);
        RepData.Value(i).Value(19) = DataSet_Deal.DealCurr;
        RepData.Value(i).Value(31) = double(DataSet_Deal.KDSum);
        RepData.Value(i).Value(40) = double(DataSet_Deal.CompPaym);
        if(DataSet_Deal.DealClient != -1)
            RepData.Value(i).Value(38) = DataSet_Deal.DealClient;
        else
            RepData.Value(i).Value(38) = "";
        end;

        RepData.Value(i).Value(39) = _GetClientName(DataSet_Deal.DealClient);
  

        d1 = DataSet_Deal.L1Date;
        d2 = d1;

        /* Для сделок РЕПО рассмотрим вторую ногу */
/*
        if((DataSet_Deal.DealType == 2126) or (DataSet_Deal.DealType == 2136) or

           /* ВР. Перевод на 3048. */
           (DataSet_Deal.DealType == 32126) or (DataSet_Deal.DealType == 32136) or (DataSet_Deal.DealType == 32121) or (DataSet_Deal.DealType == 32131) or

           (DataSet_Deal.DealType == 2121) or (DataSet_Deal.DealType == 2131))

  ВР. Тема Айса 231751.
*/
        if(IsREPO(GetOperationGroup(DataSet_Deal.DealType)))

            DataSet_Leg2  = TRsbDataSet(MakeSQL_GetSecondLeg(DataSet_Deal.DealID));
            if(DataSet_Leg2.movenext())
                RepData.Value(i).Value( 4) = DataSet_Leg2.L2PercentsREPO;
                RepData.Value(i).Value( 5) = double(DataSet_Leg2.L2PercentsDeal);
                RepData.Value(i).Value(12) = DataSet_Leg2.DateMat2;
                RepData.Value(i).Value(13) = DataSet_Leg2.DatePay2;
/*
                RepData.Value(i).Value(14) = DataSet_Leg2.L2Price;
*/
                RepData.Value(i).Value(14) = ПриведениеЦены(DataSet_Deal.DealFI, (DataSet_Deal.L1RelPrice == "X"), 
                                                            DataSet_Leg2.L2Price, (p_Conv2Money == 0), 
                                                            DataSet_Leg2.L2Date);

                RepData.Value(i).Value(15) = string(DataSet_Leg2.L2Amount:0:0);
                RepData.Value(i).Value(16) = double(DataSet_Leg2.L2NKD);
                RepData.Value(i).Value(17) = double(DataSet_Leg2.L2TotalCost);
                d2 = DataSet_Leg2.L2Date;
            end;
        end;


        DataSet_Contr = TRsbDataSet(MakeSQL_ContrInfo(DataSet_Deal.DealContragent));

        DataSet_FI    = TRsbDataSet(MakeSQL_FIinfo(DataSet_Deal.DealFI, d1, d2));


        if(DataSet_FI.movenext())
            RepData.Value(i).Value(20) = DataSet_FI.SecCode;
            RepData.Value(i).Value(21) = DataSet_FI.SecType;
            RepData.Value(i).Value(22) = DataSet_FI.ISIN;
            RepData.Value(i).Value(23) = DataSet_FI.LSIN;
            RepData.Value(i).Value(24) = DataSet_FI.RegDate;
            RepData.Value(i).Value(25) = DataSet_FI.SecName;
/*  ААИ SD - 1881624
            RepData.Value(i).Value(26) = dataSet_FI.SecFaceVal;
*/
            RepData.Value(i).Value(26) = double(dataSet_FI.SecFaceVal);
            RepData.Value(i).Value(27) = DataSet_FI.FaceValCur;
            RepData.Value(i).Value(28) = DataSet_FI.SecPercents;
            RepData.Value(i).Value(29) = DataSet_FI.CouponDate;
            RepData.Value(i).Value(30) = DataSet_FI.CouponPercents;
            RepData.Value(i).Value(32) = DataSet_FI.Emitent;
            RepData.Value(i).Value(36) = GetPrice(DataSet_Deal.DealFI, DataSet_Deal.DealDate, p_PriceType, p_Conv2Money, @CurrName);
            RepData.Value(i).Value(37) = CurrName;

        end;

        if(DataSet_Contr.movenext())
            RepData.Value(i).Value(33) = DataSet_Contr.ContragentID;
            RepData.Value(i).Value(34) = DataSet_Contr.ContragentName;
            RepData.Value(i).Value(35) = DataSet_Contr.ContragentCountry;
        end;
        

        RepData.Value(i).Value(41)   = 0;
        if(valtype(RepData.Value(i).Value(17)) != V_UNDEF)
            RepData.Value(i).Value(41) = RepData.Value(i).Value(41) + RepData.Value(i).Value(17) /* Общая сумма второй ноги */ 
        end;
        if(valtype(RepData.Value(i).Value(31)) != V_UNDEF)
            RepData.Value(i).Value(41) = RepData.Value(i).Value(41) + RepData.Value(i).Value(31) /* Сумма купона */ 
        end;
        if(valtype(RepData.Value(i).Value(40)) != V_UNDEF)
            RepData.Value(i).Value(41) = RepData.Value(i).Value(41) + RepData.Value(i).Value(40) /* Компенсационный платёж */ 
        end;
/* SD - 1996769*/
        if(valtype(DataSet_Deal.realcontr)!=V_UNDEF)
         RepData.Value(i).Value(42) = GetPartyName(int(DataSet_Deal.realcontr), false);        
        else
         RepData.Value(i).Value(42) = "-";
        end;
/* SD - 1996769*/
/*IT-31070*/
        if(IsSALE(GetOperationGroup(DataSet_Deal.DealType)) and (DataSet_Deal.DealClient=-1))

         sel = " select t_sum_natcur as sum, substr(t_account_payer,1,5) as acc from dacctrn_dbt  "+
               " where t_numb_document=?    "+
               " and t_ground like 'Отнесение фин. результата%' "; 

         cmd = RsdCommand(sel);
         cmd.addParam( "", RSDBP_IN, DataSet_Deal.DealCode);
         cmd.execute();

         rs = TRSBDataset(cmd) ;

         while(rs.MoveNext())
           if(rs.acc == "61210")
             Fr = Fr + rs.sum;
           else
             Fr = Fr - rs.sum;
           end;
         end;
        end;

        RepData.Value(i).Value(43) =double(FR);  
/*IT-31070*/
        i = i + 1;
        UseProgress(i); 
    end;
    RemProgress();


    PrintReport(RepData);


/*
    /* Печать отладки */
    i = 0;
    N = RepData.size();
    while(i < N)
        M = RepData.Value(i).size;
        j = 0;
        while(j < M)
            print(RepData.Value(i).Value(j) + " ");
            j = j + 1;
        end;
        println();
        i = i + 1;
    end;
*/
end;


main();

Exit(1);
