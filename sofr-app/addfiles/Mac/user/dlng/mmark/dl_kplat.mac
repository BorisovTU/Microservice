import PTinter,RSBDataSet,dl_plib,dlgCommon,funk,dl_kvlib,fx_globals; 
private  var d0,pId22,rs0,cmd33,{curdate},sql0,flag,rs05,que,rs9,ssu,npaymstatus; 
private  var col33 = TArray();
private  var v_DealId = TArray(), v_count;

Macro kpaym(pa1)
     // d0={curdate};
     d0=pa1;
     sql0="select bb1.t_paymentid pId22,  bb1.t_paymstatus paymstatus,  c.t_dealcodets dealcodets,( select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid=d.t_pfi ) fiid2,";
     sql0=sql0+" decode(c.t_dealtype,12300,'П',22300,'П',12305,'Р',22305,'Р') vop,   e.t_shortname nam , c.t_dealcode dealcode,to_CHAR(d.t_principal,'99,999,999,999.00') su2,";

     sql0=sql0+"  decode(bb1.t_paymstatus,0,'Cформирован',1000,'Выполнен контроль',32000,'Исполнен',100,'Отмена-изменить корсчет выгона' )  stap,";

     sql0=sql0+" to_char(c.t_dealdate,'dd.mm.yyyy') dealdate,to_char(d.t_maturity,'dd.mm.yyyy') maturity , to_char(bb1.t_valuedate,'dd.mm.yyyy') dpl, to_CHAR(bb1.t_baseamount,'99,999,999,999.00') psu ";
     sql0=sql0+" from doproper_dbt aa1 ,  doprdocs_dbt dd1, dpmpaym_dbt bb1, ddl_tick_dbt c,  dparty_dbt e, ddl_leg_dbt d ";
     sql0=sql0+" where   c.t_bofficekind=102 and e.t_partyid=c.t_partyid and aa1.t_dockind=102 and aa1.t_DocumentID=lpad(c.t_dealid,34,'0')  ";
     sql0=sql0+" and dd1.t_id_operation=aa1.t_id_operation and (dd1.t_dockind=16 or dd1.t_dockind=27) and bb1.t_paymentid=to_number(dd1.t_documentid) and  d.t_dealid=c.t_dealid and d.t_legid=1 ";
     sql0=sql0+" and to_char(bb1.t_valuedate,'dd.mm.yyyy')='"+СДАТ(d0)+"'";
      // msgbox(sql0);
      cmd33 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );

  macro EvProc33 (rs0, cmd33, id, key )
     if (cmd33 == DLG_INIT)	// Инициализация

        if (pId22 != "0")  // Надо найти запись
           v_count = 0;

           while ( (rs0.value ("pId22") != pId22) And (Not rs0.EOF) )  
		if (ValType(rs0.value ("pId22")) == 26)
			v_DealId(v_count) = 0;
		else
			v_DealId(v_count)= rs0.value ("pId22");
		end;
                rs0.Move(1, RELATIVE);
		v_count = v_count + 1;
            end;

        end;
        GoToScroll(rs0, true);
     elif (cmd33 == DLG_KEY)
        pId22=rs0.value ("pId22");
        if(DLG_KEY_ENTER == Key)
          execmacrofile("plpaym.mac", "PaymDlg2", 0,pId22) ;
          ssu=rs0.value ("psu");
          npaymstatus=rs0.value ("paymstatus");
   	  if(GetTrue(true, "Патеже на сумму "+ssu+" -  установить признак конторля ?"))
      		// msgbox("Контроль установлен !");
      		que="update dpmpaym_dbt set t_paymstatus=1000 where t_paymentid="+pId22;
      		rs9 = LnGetRecordSet(que);
   	  else
     		if (npaymstatus == 1000 )
       			que="update dpmpaym_dbt set t_paymstatus=0 where t_paymentid="+pId22;
       			rs9 = LnGetRecordSet(que);
     		end;
   	  end;
           return CM_SELECT;
        elif(DLG_KEY_F5 == Key) 
           return CM_SELECT;

        end;
     end;
  end;

  AddCol (col33, 0, "nam","Контрагент", 16);
  AddCol (col33, 1, "vop","Вид", 3);
  AddCol (col33, 2, "dealdate","Дата сделки", 10);
  AddCol (col33, 3, "maturity","Дата возврата", 10);
  AddCol (col33, 4, "dealcode","№ сделки", 10);
  AddCol (col33, 5, "su2","Сумма сделки", 15);
  AddCol (col33, 6, "dealcodets","№ сделки(вн)", 10);
  AddCol (col33, 7, "fiid2","Валюта", 5);
  AddCol (col33, 8, "dpl","Дата платежа", 10);
  AddCol (col33, 9, "psu","Cумма платежа", 15);                                                                                                                                                                                                          AddCol (col33, 5, "su2","Сумма обязательств", 15);
  AddCol (col33, 10, "stap","Статус платежа", 15);

   while(RunScroll(cmd33, 11, col33, null, @EvProc33,"Монитор контроля платежей МБК за "+СДАТ(d0)," ESC- Выход ", null, 0, 5) )
     cmd33 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );

   end;

   exit(1);
end;



