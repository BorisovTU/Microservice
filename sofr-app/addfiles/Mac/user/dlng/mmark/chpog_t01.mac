
IMPORT globals,OprInter,"cb_sql.mac",funk,mmcarry,mmcnst_j,mmlibr,dl_plib,dl_lib,dl_plat,dl_platv;

 private var nPaymentID,d1,soob,chpog,NDOG,nbank,sclient,snalog,nrate,daz,samount;
 private var newdata,que,rs,rs0,rs1,ss,debet,vkom,credit,CRE,dsob,d0,ss1,s1,np,j,i,ku,curdate,
 SumComm,SumComm2,CurComm,Document1,ss0,prol,ss01,debet3,credit3,credit2,debet2,dbcr,plid,plid2 ;
 array mas;
 var  at = MM_Carry;


record deal (dl_tick);
record leg (dl_leg);
record mo( "uo_mem_o", "USEROP.DEF" );


MACRO Ex (Buffer, fd)

private var pu,dpl,is,ddata,pld00,nsum,nsum2,{curdate},j9,stnal,nalog,tek_ost,sup,ss0,gensog,rs01;


   SetBuff( mo,fd );

   soob=" ";
   pld00=mo.Date_Carry;
   ddata= СДАТ(pld00);
   dpl=mo.ground;
   InitProgress( 100, "Платежи по частичному погашению МБК " );  
   j9=10;

 que = "select b.t_dealid,a.t_purpose,a.t_baseamount,a.t_paymentid from dpmpaym_dbt a, ddl_tick_dbt b, ddl_leg_dbt u where  a.t_valuedate = '"+ddata+"'  and a.t_dockind=102 and a.t_purpose > 9 and  a.t_paymstatus != 55  and  a.t_paymstatus <  32000  and  b.t_dealid=a.t_documentid  and b.t_dealtype=12300  and b.t_dealstatus = 10  and b.t_flag3 = 'X'  and u.t_dealid=b.t_dealid and u.t_maturity != a.t_valuedate  order by  a.t_purpose,a.t_fiid,b.t_dealid   ";  
 // msgbox(que);
 rs0 = LnGetRecordset(que);
 if (rs0 != null)
  while (rs0.moveNext())
// -------------

      ss=string(rs0.value("t_dealid"));
      que = "select *  from ddl_tick_dbt  where t_dealid = "+ss; 
      rs1 = LnGetRecordset(que);
      if (rs1 != null)
        while (rs1.moveNext())
            CopyRSetToFBuff( deal, rs1 ) ;
            j9=j9+10;
            useprogress(j9);
            message("МИНУТОЧКУ !! ИДЕТ РАСЧЕТ !");
            que = "select *  from ddl_leg_dbt  where t_dealid = "+ss; 
            rs = LnGetRecordset(que);
            if (rs != null)
               if (rs.moveNext)
                  CopyRSetToFBuff( leg, rs );
                  nPaymentID=rs0.value("t_paymentid"); 
                  pu=rs0.value("t_purpose");
                  // ndog=Кред_договор(rs.value("t_dealid"));
                  ndog="!!!";
                  sup=rs0.value("t_baseamount");
                  gensog=" ";
                  que = "select b.t_code,to_char(b.t_startdate,'DD.MM.YYYY') from ddl_tick_dbt a, ddl_genagrview_dbt b  where a.t_dealid="+deal.dealid+" and b.t_genagrid=a.t_genagrid ";
                  rs01 = LnGetRecordset(que);
                  if (rs01 != null)
                    if (rs01.moveNext)
                     gensog=" № "+rs01.value(0)+" от "+rs01.value(1);
                    end;
                  end;
                  d0=leg.start;
                  d1=leg.maturity;
                  CurComm=leg.pfi;
                  // SumComm2=leg.cost;
                  // SumComm=leg.principal;
                  SumComm=plat_dil0(deal.dealid,"102","10",ddata,"baseamount");
                  SumComm2=plat_dil0(deal.dealid,"102","11",ddata,"baseamount");

                  ss0=" ";
                  ku=double("1"+substr("0000000000",1,leg.point));
                  d1=date(dpl);



                               if  (pu == 10 )

                plid=nPaymentID;
                ss0="Выплата части основного долга по сделке "+deal.dealcode+" от "+СДАТ(deal.dealdate) ;
                if ( strlen(gensog) > 2 ) 
                  ss0=ss0+" по дог. о предоставлении кредита "+gensog;
                end;
                if ( strlen(mo.reserve) > 2 ) 
                  ss0=ss0+", С-НО РАСП.№ "+mo.reserve;
                end;
                credit=plat_dil(deal.dealid,"102","10","receiveraccount");
                Debet=ПРИКРЕПИТЬ2("ОД",deal.dealid);
                if (CurComm == 0 )
                  ss0=ss0+". НДС не обл."; 
                   plat(deal.DealID, plid,10, ss0,Debet,null,d1,credit,false);
                  // plat(deal.DealID, plid,10, ss0,Debet,null,d1,credit);

               else
                   // platv(plid,ss0,Debet,credit);
                   platv(plid,ss0,Debet,credit,false);
               end;


               if(not InsertPaymentStat (plid, PM_FINISHED))
                  MsgBox("Ошибка установки статуса платежа - Закрыт.");
               end;

                                elif  (pu == 11 )
                plid2=nPaymentID;
                ss0="Частичное погашение процентов по сделке "+deal.dealcode+" от "+СДАТ(deal.dealdate) ;
                if ( strlen(gensog) > 2 ) 
                  ss0=ss0+" по дог. о предоставлении кредита "+gensog;
                end;
                if ( strlen(mo.reserve) > 2 ) 
                  ss0=ss0+", С-НО РАСП.№ "+mo.reserve;
                end;
                credit=plat_dil(deal.dealid,"102","11","receiveraccount");
                Debet=ПРИКРЕПИТЬ2("-% к погашению",deal.dealid);
                if (CurComm == 0 )
                  ss0=ss0+". НДС не обл."; 
                  plat(deal.DealID, plid2,11, ss0,Debet,null,d1,credit,false);
                  // plat(deal.DealID, plid2,11, ss0,Debet,null,d1,credit);
               else
                   // platv(plid2,ss0,Debet,credit);
                   platv(plid2,ss0,Debet,credit,false);

               end;


                if(not InsertPaymentStat (plid2, PM_FINISHED))
                   MsgBox("Ошибка установки статуса платежа - Закрыт.");
                end;

                                  end;
               end;
            end;

      end;
   end;

// ---------

  end;
 end;

   RemProgress; 

   return 0;
END;


