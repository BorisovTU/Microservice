//-----------------------------------------------------------------------------------------
// Формирование платежей 
//-----------------------------------------------------------------------------------------
import globals,BankInter,  CurrInter, dl_Payments,dl_lib;
import funk,"cb_sql.mac", "cbsfinv.mac", oralib, likepy;


Private var Kod_Oper = {oper},err,doc,snew,{curdate} ;
private var que,d1,s0,dd0,dd1,ku,ss,ss2,snal,pay,ss1,rs3, rs,rs1,rs2,rs0,TextError, ExternPayment,PaymentID;

record pmpaym ("pmpaym.dbt");
record pscshdoc ("pscshdoc.dbt");
record symbcash ("symbcash.dbt");

record pm11 ("pmpaym.dbt");
record  pm2 ("pmprop.dbt"); 
record pm2d ("pmprop.dbt"); 
record  pm22 ("pmprop.dbt"); 
record  pm5 ("pmprop.dbt"); 
record  pm55 ("pmprop.dbt"); 


record pm3( bbcpord );
record pm33( bbcpord );

record pmrmprop ("pmrmprop.dbt");
record pm44 ("pmrmprop.dbt");

record memorder ("memorder.dbt");
record oproper ("oproper.dbt");
record pt ( party );

array massi;

// Проверка на то, что контрагент является резидентом
private macro IsPartyResident(pt)
   var sql = " select t_notResident from dparty_dbt where t_partyid = :partyId ";
   var rs  = ExecSqlSelect (sql, MakeArray (SqlParam ("partyId", pt)), false);
   if (rs.MoveNext ()) 
      return ( "X" != rs.value(0) );
   end;

   RunError("Не найден контрагент");
   return false;
end;

// Определение номера бэк-офиса (100 - КО, 102 - МБК)
private macro GetBackOffice(dealId)
   var sql = "select t_bOfficeKind from ddl_tick_dbt where t_dealId = :dealId";
   var rs  = ExecSqlSelect (sql, MakeArray (SqlParam ("dealId", dealId)), false);
   if (rs.MoveNext ()) 
      return Int(rs.value(0));
   end;

   RunError("Не найдена сделка");
   return false;
end;


macro innaz(s1)
private var ds1,rs52,dcc;

 ds1=" ";

record part (party);

            dcc=string(s1);
            que = "select t_latname  from dparty_dbt  where t_partyid = '"+dcc+"'"; 
            rs52 = LnGetRecordSet(que);
            if (rs52 != null)
               if (rs52.moveNext)
                  IF (STRLEN(rs52.value(0)) > 1 )
                    ds1=rs52.value(0);
                  end;
               end;
            end;
  return ds1;
end;


macro nks(s1,s2)
private var ds1,rs52,dcc,dcc2;
 ds1=0;

            dcc=string(s1);
            dcc2=string(s2);
            que = "select t_number from dcorschem_dbt  where  t_isnostro='X' and t_corrid= '"+dcc+"' and t_fiid='"+dcc2+"' and t_state = 0";
            rs52 = LnGetRecordSet(que);
            if (rs52 != null)
               if (rs52.moveNext)
                ds1=rs52.value(0);
               end;
            end;
  return ds1;

end;

macro rnal(s1,s2)
private var ds1,rs52,dcc;
 ds1=0.0;

record part (party);

            dcc=string(s1);
            que = "select *  from dparty_dbt  where t_partyid = '"+dcc+"'"; 
            rs52 = LnGetRecordSet(que);
            if (rs52 != null)
               if (rs52.moveNext)
                  CopyRSetToFBuff( part, rs52 );
                ds1=readNoteForObject( 3, UniID( part, 3),507,s2 );
               end;
            end;
  return ds1;
end;

macro  Sroch(pa1)
 private var rez=0,pa0=0,que,rs52;
  pa0=execmacrofile("dl_plib.mac", "par_plat",pa1,"documentid") ;
  que="select COUNT(*) from ddl_tick_dbt where t_dealid="+pa0+" and T_ISINSTANCY='X'";
  rs52 = LnGetRecordSet(que);
  if (rs52 != null)
     if (rs52.moveNext)
        rez=int(rs52.value(0));
     end;
  end;
 return rez;
end;




macro plat(id1,par2,par3,ground,lch, subpurp, DateCarry,lch2,scroll)

      private var kl,i9,i4,IDPaym,sidpl,{SelfId},sup=0.00,delta,rs31,snalog,sclient;
      ClearRecord(pmpaym);
      ClearRecord(pmrmprop);
      ClearRecord(pm2);
      ClearRecord(pm3);

      que = "select  *  from dpmpaym_dbt  where t_paymentid= "+par2; 
      rs1 = LnGetRecordSet(que);
      if(rs1 != null)
        if (rs1.moveNext) 
            CopyRSetToFBuff( pm11, rs1 ) ;
        end;
      end;
     pm11.baseamount = money(round(pm11.baseamount, 2));

     if (pm11.purpose == 11 ) 

       sclient=MM_tickid(id1,"partyid");
       snalog=MM_nalog(sclient);
       if (snalog > 0 )
          pm11.baseamount=pm11.baseamount-(pm11.baseamount*snalog/100);
          ground=ground+", БЕЗ НАЛОГА "+string(snalog)+" % ";
       end;
     end;

     pmpaym.amount =pm11.baseamount;
     pmpaym.baseamount =pm11.baseamount;
     pmpaym.payamount =pm11.baseamount;
     pmpaym.userfield2=string(par2);

//     pmpaym.DocKind = 16;
     pmpaym.FIID=pm11.FIID;
     pmpaym.baseFIID=pm11.FIID;
     pmpaym.payFIID=pm11.FIID;
     pmpaym.fiid_futurePayAcc=pm11.FIID;
     pmpaym.fiid_futureRecAcc=pm11.FIID;
//     pmpaym.Purpose = 15;
     pmpaym.ORIGIN = 1;
//     pmpaym.payer={SelfId};
     pmpaym.payer=pm11.payer;
     pmpaym.isfactpaym="X";
     pmpaym.paymstatus=3000;

     pmpaym.payerbankid=pm11.payer;
     pmpaym.receiver=pm11.receiver;
     pmpaym.payerDpNode =pm11.paymentid;                     //par3;
     pmpaym.receiverDpNode = id1;
     pmpaym.chapter = 1;

     pmpaym.receiverbankid=pm11.receiverbankid;

     pmpaym.payerAccount =lch;
     pmpaym.receiverAccount =lch2;
     if ( strlen(pmpaym.receiverAccount) < 1 )
       pmpaym.receiverAccount =""; 
     end;

     pmpaym.Department = 1;
     pmpaym.KindOperation = 4001;


     pm11.ValueDate=DateCarry;
     pmpaym.ValueDate=pm11.ValueDate;

     pmpaym.PAYERBANKENTERDATE=pm11.ValueDate;
     pmpaym.NumberPack = 400;


     que = "select  *  from dpmprop_dbt  where t_debetcredit=0  and t_paymentid="+par2;
     rs0 = LnGetRecordSet(que);
     if(rs0 != null)
       if (rs0.moveNext) 
          CopyRSetToFBuff( pm22, rs0 ) ;
          pm2.codekind=3;
          pm2.codename="БИК";
          pm2.bankcode = ПолучитьКодСубъекта ( pm11.payer, 3 );
          pm2.payfiid=pmpaym.FIID;
          pm2.CORSCHEM=0;
          pm2.propstatus=0;
          pm2.transferdate=date("00.00.0000");
       end;
    end;
    que = "select  *  from dpmprop_dbt  where t_debetcredit=1  and t_paymentid="+par2;
    rs0 = LnGetRecordSet(que);
    if(rs0 != null)
      if (rs0.moveNext) 
         CopyRSetToFBuff( pm55, rs0 ) ;
         pm5.codekind=3;
         pm5.codename="БИК";
         pm5.bankcode=ПолучитьКодСубъекта ( pm11.receiver, 3 );
         pm5.payfiid=pmpaym.FIID;
         PM5.CORSCHEM=nks(pm11.payerbankid,pmpaym.FIID);
         pm5.propstatus=1000;
         pm5.tpid=9;
         pm5.tpschemid=52; 
         pm5.rlsformid=287;
         pm5.subkindmessage=1;
         pm5.corrpostype=0;
      end;
    end;


    que = "select  *  from dpmrmprop_dbt  where t_paymentid="+par2;
    rs0 = LnGetRecordSet(que);
    if(rs0 != null)
      if (rs0.moveNext) 
         CopyRSetToFBuff( pm44, rs0 ) ;
          pmrmprop.ShifrOper="01";
          if ( ПолучитьСубъекта ( pmpaym.payerbankid, pt ) == 0 )
             pmrmprop.PayerBankName      = pt.Name;
          end;
          if ( ПолучитьСубъекта ( pmpaym.Receiverbankid, pt ) == 0 )
             pmrmprop.ReceiverBankName      = pt.Name;
          end;
          if ( ПолучитьСубъекта ( pmpaym.Payer, pt ) == 0 )
             pmrmprop.PayerName      = pt.Name ;
          end;
          if ( ПолучитьСубъекта ( pmpaym.Receiver, pt ) == 0 )
             pmrmprop.ReceiverName          = pt.Name;
          end;

          pmrmprop.Ground = ground;
//          pmrmprop.Number = execmacrofile("memorder", "MakeNumber") ;

          pmrmprop.Number = execmacrofile("fx_lib", "MakeNumber0") ;
          pmrmprop.PayerINN = ПолучитьКодСубъекта ( pmpaym.Payer, 16 );
          pmrmprop.ReceiverINN  = ПолучитьКодСубъекта ( pmpaym.Receiver, 16 );

          pmrmprop.paydate=pm11.ValueDate;
          pmrmprop.clientdate=pm11.ValueDate;
          pmrmprop.date=pm11.ValueDate;
          pmrmprop.Payername =pmrmprop.Payername;
          pmrmprop.Receivername=pmrmprop.Receivername;
          pmrmprop.Receiverbankname=pmrmprop.Receiverbankname;
          if ( Sroch(par2) > 0 )
            pmrmprop.PRIORITY=1;
            pmrmprop.INSTANCY=1;
          else
            pmrmprop.PRIORITY=5;
            pmrmprop.INSTANCY=0;
          end;

      end;
   end;


   
   if( not InsertBankPayment_alt(pmpaym,pmrmprop,pm2,pm5,null,scroll ) )
       MsgBox( "Ошибка при вставке платежа" );
       return 1;
   end;
   


  return 0;
end;
// ---------------

