import PTinter,RSBDataSet,dl_plib,dlgCommon,funk; 
private  var d0,pId2,rs0,cmd2,sql0,flag,rs05,que,ground; 
private  var col2 = TArray();
private  var v_DealId = TArray(), v_count;


MACRO Kground(partyid)


      sql0="select a.t_id  pId2, b.t_shortname nam, decode(a.t_tip,9,'Размещение ОД',10,'Погашение ОД',11,'Погашение %%') tip, a.t_ground ground FROM  DSTD_GROUND_DBT a , DPARTY_DBT b where b.t_partyid=a.t_partyid and a.t_partyid="+partyid;
      cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );

  macro EvProc2 (rs0, cmd2, id, key )
     if (cmd2 == DLG_INIT)	// Инициализация
        if (pId2 != "0")  // Надо найти запись
           v_count = 0;
           while ( (rs0.value ("pId2") != pId2) And (Not rs0.EOF) )  
		if (ValType(rs0.value ("pId2")) == 26)
			v_DealId(v_count) = 0;
		else
			v_DealId(v_count)= rs0.value ("pId2");
		end;
                rs0.Move(1, RELATIVE);
		v_count = v_count + 1;
            end;
        end;
        GoToScroll(rs0, true);                                                                                   
        elif (cmd2 == DLG_KEY)
        pId2=rs0.value ("pId2");
        if(DLG_KEY_ENTER == Key)                                                                                 

         ground=rs0.value ("ground");
         getstring(ground,"Введите основание для платежа по размещению",150) ;
         que="update DSTD_GROUND_DBT set t_ground='"+ground+"' where t_id="+pId2;
         rs05 = LnGetRecordSet(que);
         return CM_SELECT;

        elif(DLG_KEY_F8 == Key) 

        que="delete from  DSTD_GROUND_DBT where t_id="+pId2;
        rs05 = LnGetRecordSet(que);
        return CM_SELECT;


        elif(DLG_KEY_F9 == Key) 
           ground=" ";
           getstring(ground,"Введите основание для платежа по размещению",150) ;
           que="insert into  DSTD_GROUND_DBT (T_ID , T_PARTYID, T_TIP, T_GROUND) values (DSTD_GROUND_DBT_SEQ.Nextval,"+partyid+",9,'"+ground+"')";
           rs05 = LnGetRecordSet(que);
           return CM_SELECT;


        elif(DLG_KEY_F10 == Key) 
           ground=" ";
           getstring(ground,"Введите основание для платежа по размещению",150) ;
           que="insert into  DSTD_GROUND_DBT (T_ID , T_PARTYID, T_TIP, T_GROUND) values (DSTD_GROUND_DBT_SEQ.Nextval,"+partyid+",10,'"+ground+"')";
           rs05 = LnGetRecordSet(que);
           return CM_SELECT;


        elif(DLG_KEY_F11 == Key) 
           ground=" ";
           getstring(ground,"Введите основание для платежа по размещению",150) ;
           que="insert into  DSTD_GROUND_DBT (T_ID , T_PARTYID, T_TIP, T_GROUND) values (DSTD_GROUND_DBT_SEQ.Nextval,"+partyid+",11,'"+ground+"')";
           rs05 = LnGetRecordSet(que);
           return CM_SELECT;

        end;
     end;
  end;

  AddCol (col2, 0, "nam","Контрагент", 20);

  AddCol (col2, 1, "tip","Тип платежа", 15);
  AddCol (col2, 2, "ground","Основание платежа", 150);

   while(RunScroll(cmd2, 3, col2, null, @EvProc2,"Основания валютных платежей c "+nami(partyid),"F8- Удаление    F9- Ввод Размещение ОД  F10- Ввод Погашение ОД  F11- Ввод %%   Enter- Редактирование  ESC- Выход ", null, 0, 32,150,10) )
     cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );

   end;

   exit(1);
end;


MACRO Leng_inn(pa1,pa2)

   private var que,rs51;

   que="select count(*) from dpartyown_dbt ee where ee.t_partyid="+pa1+" and ee.t_partykind=2";
   rs51 = LnGetRecordSet(que);
   if(rs51 != null)
     if (rs51.moveNext) 
        if (rs51.value(0)  > 0 )
          if ( strlen(pa2) != 10 )
             msgbox("Внимание ! Субъект - БАНК,  ИНН по субъекту не равно 10 знакам !"); 
          end;

        end;

     end;
   end;


END;

