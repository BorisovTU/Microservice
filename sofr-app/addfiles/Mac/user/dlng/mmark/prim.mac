//-----------------------------------------------------------------------------------------
// График платежей
// v.3
//-----------------------------------------------------------------------------------------

import "gtconst.inc",calculate,funk,"cb_sql.mac",dl_plib,globals;


//private var Mmdeal = Tbfile( "dl_tick.dbt", "W" );
//private var leg  = Tbfile( "dl_leg.dbt", "W" );
private   var paym       = Tbfile( "pmpaym.dbt", "W" );
private   var paymprop  = Tbfile( "pmprop.dbt", "W" );
private   var paymprop2  = Tbfile( "pmprop.dbt", "W" );
private   var pmrmprop  = Tbfile( "pmrmprop.dbt", "W" );

//для занесения внебиржевых форвардов и опционов
private var dvndeal = Tbfile( "dvndeal.dbt", "W" );
private var dvnfi = Tbfile( "dvnfi.dbt", "W" );
var Comment;

macro GetSpiProperty(pid,kindop,purp,fiid,bid,acc,bckind,bcode)
    var sql,rs;

    sql = " SELECT a.t_bankid bid,a.t_account acc,a.t_bankcodekind bckind,a.t_bankcode bcode "
    + " FROM dsettacc_dbt a "
    + " WHERE a.t_settaccid = "
    + " ( "
    + " SELECT a.t_settaccid "
    + " FROM dpmautoac_dbt a "
    + " WHERE a.t_partyid = :1 "
    + " AND a.t_kindoper = :2 "
    + " AND a.t_purpose = :3 "
    + " AND a.t_fiid = :4 "
    + "AND a.t_account = '1' ) ";

    rs = ExecSqlSelect(sql, MakeArray(SqlParam("1", pid),SqlParam("2",kindop),SqlParam("3",purp),SqlParam("4",fiid)), false);
//while Заменить на --> if (not rs.MoveNext())
    if (rs.MoveNext())
        setparm(4,rs.value("bid"));
        setparm(5,rs.value("acc"));
        setparm(6,rs.value("bckind"));
        setparm(7,rs.value("bcode"));
    else
        setparm(4,999);
        setparm(5,40000000000000000);
        setparm(6,1);
        setparm(7,"ahahahah");
    end;
end;

macro GetCodeById(pid,codekind)
    var sql,rs;
    sql = " SELECT c.t_code AS code "
    + " FROM dpartcode_dbt c "
    + " WHERE c.t_partyid = :1 AND c.t_codekind = :2 ";

    rs = ExecSqlSelect(sql, MakeArray(SqlParam("1", pid),SqlParam("2",codekind)), false);
    while (rs.MoveNext())
        return rs.value("code");
    end;
end;

macro Create_Payment(dealid,fiid,amount,pid,purpose,date,kind)
    var stat,paybid,payacc,recbid,recacc,payid,recid,paybckind,paybcode,recbckind,recbcode;

if (purpose == 1)
    GetSpiProperty(pid,kind,purpose,fiid,paybid,payacc,paybckind,paybcode);
    GetSpiProperty({OurBank},kind,purpose,fiid,recbid,recacc,recbckind,recbcode);
    payid = pid;
    recid = {OurBank};

elif (purpose == 2)
    GetSpiProperty({OurBank},kind,purpose,fiid,paybid,payacc,paybckind,paybcode);
    GetSpiProperty(pid,kind,purpose,fiid,recbid,recacc,recbckind,recbcode);
    payid = {OurBank};
    recid = pid;
end;

    paym.rec.PAYMENTID = 0;
    paym.rec.DOCKIND = 199;
    paym.rec.DOCUMENTID = dealid;
    paym.rec.PURPOSE = purpose;
    paym.rec.FIID = fiid;
    paym.rec.AMOUNT = amount;
    paym.rec.PAYFIID = fiid;
    //start блок данных из СПИ, получатель-плательщик
    paym.rec.PAYER = payid;
    paym.rec.PAYERBANKID = paybid;
    paym.rec.PAYERACCOUNT = payacc;
    paym.rec.RECEIVER = recid;
    paym.rec.RECEIVERBANKID = recbid;
    paym.rec.RECEIVERACCOUNT = recacc;
    //end
    paym.rec.VALUEDATE = date;
    paym.rec.PAYMSTATUS = 1000;
    paym.rec.DEPARTMENT = 1;
    paym.rec.ISPLANPAYM = "X";
    paym.rec.FUTUREPAYERACCOUNT = payacc;
    paym.rec.FUTURERECEIVERACCOUNT = recacc;
    paym.rec.PAYAMOUNT = amount;
    paym.rec.PAYERCODEKIND = 1;
    paym.rec.PAYERCODE = GetCodeById(payid,1);
    paym.rec.RECEIVERCODEKIND = 1;
    paym.rec.RECEIVERCODE = GetCodeById(recid,1);
    paym.rec.FIID_FUTUREPAYACC = fiid;
    paym.rec.FIID_FUTURERECACC = fiid;
    paym.rec.BASEAMOUNT = amount;
    paym.rec.BASEFIID = fiid;
    paym.rec.OPER = 1;
    paym.rec.PRIMDOCKIND = 199;
    paym.rec.ORDERFIID = fiid;
    paym.rec.ORDERAMOUNT = amount;
    paym.rec.FUTUREPAYERAMOUNT = amount;
    paym.rec.FUTURERECEIVERAMOUNT = amount;
    stat = paym.insert;

    if (stat)
        //свойства по дебету
        paymprop.rec.PAYMENTID = paym.rec.PAYMENTID;
        paymprop.rec.DEBETCREDIT = 0; //дебет
        paymprop.rec.TRANSFERDATE = paym.rec.VALUEDATE; //дебет
        paymprop.rec.CODEKIND = paybckind; //дебет
        paymprop.rec.BANKCODE = paybcode; //дебет

        stat = paymprop.insert;
        if (not stat)
            RunError( "Ошибка! Не могу создать запись в pmprop!" );
        end;

        paymprop2.rec.PAYMENTID = paym.rec.PAYMENTID;
        paymprop2.rec.DEBETCREDIT = 1; //кредит
        paymprop2.rec.TRANSFERDATE = paym.rec.VALUEDATE;
        paymprop2.rec.CODEKIND = recbckind; //дебет
        paymprop2.rec.BANKCODE = recbcode;

        stat = paymprop2.insert;
        if (not stat)
            RunError( "Ошибка! Не могу создать запись в pmprop2!" );
        end;

        pmrmprop.rec.PAYMENTID = paym.rec.PAYMENTID;
        pmrmprop.rec.DATE = paym.rec.VALUEDATE;
        pmrmprop.rec.PAYDATE = paym.rec.VALUEDATE;
        pmrmprop.rec.CLIENTDATE = paym.rec.VALUEDATE;

        stat = pmrmprop.insert;
        if (not stat)
            RunError( "Ошибка! Не могу создать запись в pmrmprop!" );
        end;
    else
        RunError( "Ошибка! Не могу создать запись в pmpaym!" );
    end;
end;


macro _Create_dvndeal()
    //Тут начнем запись сделки в БД
    //создаем запись в dvndeal
    var status;
    var vKIND,vTYPE,vDATE,vTIME,vCODE,vEXTCODE,vCOUNTRY,vCONTRACTOR,vDVKIND,vAGENT,vCLIENT,vPARENTID,vGENAGRID,vKINDDEALPARTYCLIENT;
    var zTYPE,zCONTRAMOUNT,zFIID,zAMOUNT,zEXECDATE,zPAYDATE,zSUPLDATE,zEXECTYPE,zPRICE,zPOINT,zCOST,zACCFIID,zSTDFIID;

    /* тестовые переменные */
    vKIND = 2690;
    vTYPE = 1;
    vDATE = date("02.06.2016");
    vTIME = time();
    vCODE = "ИмпСд2";
    vEXTCODE = "ИмпСд2";
    vCOUNTRY = 165;
    vCONTRACTOR = 31;
    vDVKIND = 1;
    vAGENT = -1;
    vCLIENT = -1;
    vPARENTID = -1;
    vGENAGRID = -1;
    vKINDDEALPARTYCLIENT = -1;

    zTYPE = 0;
    zCONTRAMOUNT = 1;
    zFIID = 7;
    zAMOUNT = 233;
    zEXECDATE = date();
    zPAYDATE = date();
    zSUPLDATE = date();
    zEXECTYPE = 1;//поставочный
    zPRICE = 1000;
    zPOINT = 2;
    zCOST = zAMOUNT * zPRICE;
    zACCFIID = -1;
    zSTDFIID = -1;


    dvndeal.rec.ID = 0;
    dvndeal.rec.KIND = vKIND; //вид сделки
    dvndeal.rec.TYPE = vTYPE; //покупка или продажа
    dvndeal.rec.DATE = vDATE; //дата операции
    dvndeal.rec.TIME = vTIME;
    dvndeal.rec.CODE = vCODE;
    dvndeal.rec.EXTCODE = vEXTCODE;
    dvndeal.rec.COUNTRY = vCOUNTRY;
    dvndeal.rec.CONTRACTOR = vCONTRACTOR;
    dvndeal.rec.ISPFI = "X";
    dvndeal.rec.DVKIND = vDVKIND;
    dvndeal.rec.STATE = 0;
    dvndeal.rec.DEPARTMENT = 1;
    dvndeal.rec.OPER = 1;
    dvndeal.rec.AGENT = vAGENT;
    dvndeal.rec.CLIENT = vCLIENT;
    dvndeal.rec.PARENTID = vPARENTID;
    dvndeal.rec.GENAGRID = vGENAGRID;
    dvndeal.rec.KINDDEALPARTYCLIENT = vKINDDEALPARTYCLIENT;


    status = dvndeal.insert;

    if (status)
        dvnfi.rec.ID = 0;
        dvnfi.rec.DEALID = dvndeal.rec.ID;
        dvnfi.rec.TYPE = zTYPE;
        dvnfi.rec.CONTRAMOUNT = zCONTRAMOUNT;
        dvnfi.rec.FIID = zFIID;
        dvnfi.rec.AMOUNT = zAMOUNT;
        dvnfi.rec.EXECDATE = zEXECDATE;
        dvnfi.rec.PAYDATE = zPAYDATE;
        dvnfi.rec.SUPLDATE = zSUPLDATE;
        dvnfi.rec.EXECTYPE = zEXECTYPE;
        dvnfi.rec.PRICE = zPRICE;
        dvnfi.rec.POINT = zPOINT;
        dvnfi.rec.COST = zCOST;
        dvnfi.rec.PRICEFIID = 0;//рубль
        dvnfi.rec.ACCFIID = zACCFIID;
        dvnfi.rec.STDFIID = zSTDFIID;

        status = dvnfi.insert;
        if (status)
           if (dvndeal.rec.KIND == 2690) //если это форвард
            Create_Payment(dvnfi.rec.DEALID,dvnfi.rec.FIID,dvnfi.rec.AMOUNT,dvndeal.rec.CONTRACTOR,1,dvnfi.rec.PAYDATE,dvndeal.rec.KIND); //базовый актив. purpose = 1
            Create_Payment(dvnfi.rec.DEALID,dvnfi.rec.PRICEFIID,dvnfi.rec.COST,dvndeal.rec.CONTRACTOR,2,dvnfi.rec.PAYDATE,dvndeal.rec.KIND); //контрактив. purpose = 2
           end; 
        else
            RunError("Ошибка! Не могу создать запись в dvnfi!");
        end;

    else
        RunError("Ошибка! Не могу создать запись в dvndeal!");
    end;

    OnError( RslErrObj )
    Comment = RslErrObj.Message;
    AbortTrn();

end;


if (not ProcessTrn(0,"_Create_dvndeal"))
    msgbox("Ахтунг!");
    msgbox(Comment);
end;


