/*-------------------------------------------------------------------------

	Имя файла	: dlgCommon.mac 

	Описание	: Общий функционал по работе с диалогами и скроллами

	Программист	: Селезнёв Роман

	Создан		: 12.02.2008


-------------------------------------------------------------------------*/

import oralib, likepy, StringLib;

//
// Коды клавиш для обработки в окнах
//

CONST


// Клавиши выбора
DLG_KEY_ESC     = 27,
DLG_KEY_ENTER   = 13,
DLG_KEY_SPACE   = 32,

// Клавиши навигации
DLG_KEY_LEFT	= 331,
DLG_KEY_RIGHT   = 333,
DLG_KEY_UP      = 328,
DLG_KEY_DOWN    = 336,

DLG_KEY_PGDOWN  = 337,
DLG_KEY_PGUP    = 329,

DLG_KEY_HOME    = 327,
DLG_KEY_END     = 335,

// Вставка-удаление
DLG_KEY_INS     = 338,
DLG_KEY_DEL     = 339,

// Функциональные клавиши
DLG_KEY_F1      = 315, 	// X 
DLG_KEY_F2  	= 316,
DLG_KEY_F3      = 317,
DLG_KEY_F4      = 318,
DLG_KEY_F5      = 319,
DLG_KEY_F6      = 320,
DLG_KEY_F7      = 321,
DLG_KEY_F8      = 322,
DLG_KEY_F9      = 323,
DLG_KEY_F10     = 324,
DLG_KEY_F11     = 389,
DLG_KEY_F12     = 390,


// Функциональные клавиши + SHIFT
DLG_KEY_SHIFT_F1 = 340,
DLG_KEY_SHIFT_F2 = 341,
DLG_KEY_SHIFT_F3 = 342,
DLG_KEY_SHIFT_F4 = 343,
DLG_KEY_SHIFT_F5 = 344,
DLG_KEY_SHIFT_F6 = 345,
DLG_KEY_SHIFT_F7 = 346,
DLG_KEY_SHIFT_F8 = 347,
DLG_KEY_SHIFT_F9 = 348,
DLG_KEY_SHIFT_F10= 349,	// X
DLG_KEY_SHIFT_F11= 391,
DLG_KEY_SHIFT_F12= 392,

// Функциональные клавиши + CTRL
DLG_KEY_CTRL_F1 = 350,
DLG_KEY_CTRL_F2 = 351,
DLG_KEY_CTRL_F3 = 352,
DLG_KEY_CTRL_F4 = 353,
DLG_KEY_CTRL_F5 = 354,
DLG_KEY_CTRL_F6 = 355,
DLG_KEY_CTRL_F7 = 356,
DLG_KEY_CTRL_F8 = 357,
DLG_KEY_CTRL_F9 = 358,
DLG_KEY_CTRL_F10= 359,
DLG_KEY_CTRL_F11= 393,
DLG_KEY_CTRL_F12= 394,

// Функциональные клавиши + ALT
DLG_KEY_ALT_F1 = 360,
DLG_KEY_ALT_F2 = 361,
DLG_KEY_ALT_F3 = 362,
DLG_KEY_ALT_F4 = 363,
DLG_KEY_ALT_F5 = 364,
DLG_KEY_ALT_F6 = 365,
DLG_KEY_ALT_F7 = 366,
DLG_KEY_ALT_F8 = 367,
DLG_KEY_ALT_F9 = 368,
DLG_KEY_ALT_F10= 369,	
DLG_KEY_ALT_F11= 395,
DLG_KEY_ALT_F12= 396,

// Функциональные клавиши + CTRL + SHIFT
DLG_KEY_CTRL_SHIFT_F1 = 762,
DLG_KEY_CTRL_SHIFT_F2 = 763,
DLG_KEY_CTRL_SHIFT_F3 = 764,
DLG_KEY_CTRL_SHIFT_F4 = 765,
DLG_KEY_CTRL_SHIFT_F5 = 766,
DLG_KEY_CTRL_SHIFT_F6 = 767,
DLG_KEY_CTRL_SHIFT_F7 = 768,
DLG_KEY_CTRL_SHIFT_F11= 772,

// Цифровые клавиши + CTRL
DLG_KEY_CTRL_1	= 258,
DLG_KEY_CTRL_2	= 259,
DLG_KEY_CTRL_3	= 260,
DLG_KEY_CTRL_4	= 261,
DLG_KEY_CTRL_5	= 262,
DLG_KEY_CTRL_6	= 30,
DLG_KEY_CTRL_7	= 263,
DLG_KEY_CTRL_8	= 264,
DLG_KEY_CTRL_9	= 265,
DLG_KEY_CTRL_0	= 257, 

// Цифровые клавиши + ALT
DLG_KEY_ALT_1	= 376,
DLG_KEY_ALT_2	= 377,
DLG_KEY_ALT_3	= 378,
DLG_KEY_ALT_4	= 379,
DLG_KEY_ALT_5	= 380,
DLG_KEY_ALT_6	= 381,
DLG_KEY_ALT_7	= 382,
DLG_KEY_ALT_8	= 383,
DLG_KEY_ALT_9	= 384,
DLG_KEY_ALT_0	= 385,

// Стандартные сочетания
DLG_KEY_CTRL_G = 7,
DLG_KEY_ALT_G  = 290;


// Вспомогательная процедура подготовки информации с атрибутами полей
macro AddCol (ar,ind, fld, head, width, rdonly)
   ar.value ( ind * 6     ) = fld;
   ar.value ( ind * 6 + 1 ) = head;
   ar.value ( ind * 6 + 2 ) = width;
   ar.value ( ind * 6 + 3 ) = 0;    // fldType
   ar.value ( ind * 6 + 4 ) = -1;   // decPoint
   ar.value ( ind * 6 + 5 ) = 0;    // reserve
end;


// Процедура для фильтрации Special value 0 в данных, полученных выборкой из БД
// Используется, когда нет возможности вносить decode и т.п. в SQL-запрос для замены на стороне Oracle
macro SpecialValue0ToEmpty(val)   
   return IfThenElse(26 == ValType (val), "", val);
   //return IfThenElse("Special value 0" == string (val), "", val);
end;


// Проверка поля на заполненность (указаны не только пробелы)
macro IsFilledField(val)
   return IfThenElse("" != trim(string(val)), true, false);
end;


//
// Отфильтровать пустую строку с заменой на символ chr(1)
//
macro EmptyToChr1(str)
   var res = trim(String(str));

   return IfThenElse((null == str) or ("" == res), StrFor(1), res);
end;


//
// Отформатировать номер счёта. 
// 1 параметр -- номер счёта; 2 -- необязательный, если задано true -- отделять части точками (по умолчанию)
// если false -- убрать точки (если таковые имеются)
//
macro FormatAccountNum(acc, bIsDotted)
   if(V_UNDEF == valType(bIsDotted)) 
      bIsDotted = true;   
   end;

   // Вырезаем все точки
   var tmp = StrSubst ( acc, ".", "" );
 
   if(not bIsDotted)
      return tmp;
   end;

   var res = SubStr(tmp, 1, 5);
   res = res + ".";
   res = res + SubStr(tmp, 6, 3);
   res = res + ".";
   res = res + SubStr(tmp, 9, 1);
   res = res + ".";
   res = res + SubStr(tmp, 10);
    
   if("..."==res)
      res = "";
   end;
   
   return res;
end;

//
// Отформатировать сумму. 
// 1 параметр -- сумма; 2 -- необязательный, если задано true -- отделять триады апострофами (по умолчанию)
// если false -- убрать апострофы (если таковые имеются)
//
macro FormatSum(sum, bIsApostr)
   if(V_UNDEF == valType(bIsApostr)) 
      bIsApostr = true;   
   end;

   // Вырезаем все точки
   var tmp = StrSubst ( String(sum), "'", "" );

   if(not bIsApostr)
      return Double(tmp); //SubStr(tmp, 1, Index(tmp, ".") + 2);
   end;
 
   tmp = String(Double(sum):a);  
   return SubStr(tmp, 1, Index(tmp, ".") + 2); 
end;


macro FormatSum_(sum, bIsApostr)   // предыдущая версия
   if(V_UNDEF == valType(bIsApostr)) 
      bIsApostr = true;   
   end;

   // Вырезаем все точки
   var tmp = StrSubst ( String(sum), "'", "" );
 
   if(not bIsApostr)
      return Double(tmp);
   end;
 
   return String(Double(sum):a);
end;

macro FormatSum2(sum, bIsApostr)
   if(V_UNDEF == valType(bIsApostr)) 
      bIsApostr = true;   
   end;

   // Вырезаем все точки
   var tmp = StrSubst ( String(sum), "'", "" );
 
   if(not bIsApostr)
      return Double(tmp);
   end;

   var res = SubStr(tmp, Index(tmp, "."));
   var intP = SubStr(tmp, 1, Index(tmp, ".")-1); 
 
   var i = 0;
 
   while (strlen(intP) > 2)           
      tmp = StrRight(intP, 3);      
      if(0 == i)
         res = tmp + res;
      else
         res = tmp + "'" + res;
      end;
      i = i+1;
 
      if(strlen(intP) > 3)
         intP = SubStr(intP, 1, strlen(intP)-3);
      else
         intP = "";
      end;
   end;

   if(intP != "")
      if(0 == i)
         res = intP + res;
      else
         res = intP + "'" + res;
      end;
   end;

   return res;
end;










