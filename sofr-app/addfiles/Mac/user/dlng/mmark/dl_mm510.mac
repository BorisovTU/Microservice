/*
LKL
Шаг частичной пролонгации 
*/
IMPORT funk, RSD, mmlibr, dl_note_lib, dl_lib;


private macro GetLegSum(Document)
    record tick( dl_tick );
    SetBuff( tick, Document );
    private var i, v_money, delta, que, rs;

    FILE leg (dl_leg); 
    leg.LegKind = LEG_KIND_DL_TICK;
    leg.DealID = tick.DealID;
    leg.LegID = 1;

    if (not GetEq(leg))
        mm_error ("Не найден транш сделки");
        return (-1);
    else
        return Leg.Principal;
    end;

end;

MACRO ExecuteStep(Buffer, Document)
    record tick( dl_tick );
    SetBuff( tick, Document );
    private var i, v_money, delta, que, rs;
//msgbox(tick.dealid);
   v_money = 0;
   GetMoney(v_money, "Введите сумму пролонгации");
   if ( v_money<=0 )
//        msgbox("Сумма частичной пролонгации должна быть больше 0!");
        return 1;
   end;
//   if ( MakeNoteMoney( tick.dealid, 102, v_money) == 1)
   if ( SetNoteDifValue( tick.dealid, 102, v_money) == 1)
	return 1;
   else
        PaymMainSummUpd(tick.dealid, v_money);	
   end;
   return 0;
end;

/* Макрос постобработки */
MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

    private var v_money;
    record tick( dl_tick );
    SetBuff( tick, FirstDoc );

    if (errTrn OR (CommitOrRollback==2)) 
         v_money = GetLegSum(FirstDoc); 
         if ( v_money == (-1) )
              return 1; 
         end ;
         PaymMainSummUpd( tick.DealId, v_money );
//         if ( MakeNoteMoney( tick.dealid, 102, 0) == 1  )
         if ( SetNoteDifValue( tick.dealid, 102, 0) == 1  )

              return 1;
         end;
         return 0;
    end;

    return 1;
end;