// Библиотека функций

import Календарь,funk, PTInter, CTInter,fx_globals;

MACRO СДАТ0(par1);
  private var rez;
  rez=substr(string(par1),1,10);   
  if ( substr(rez,1,1) == " ")
     rez="0"+substr(rez,2);
  end;
  return rez;
end;


Private macro MakeNumber0
    Var Refer, Number;
    if ( GetReferenceIDByType (OBJTYPE_BANKPAYMENT, 1, Refer) + GenerateReference (Refer, Number) )
        MsgBox ("Ошибка генерации номера");
        return "";
    end;
    return  Number;
End;


Private macro MakeNumberv
    Var Refer, Number=1;
/*
    if ( GetReferenceIDByType (OBJTYPE_BBANKCPORDER, 1, Refer) + GenerateReference (Refer, Number) )
        MsgBox ("Ошибка генерации номера");
        return "";
    end;
*/
    return  Number;
End;


MACRO Fx_leg(par1,par2,par3)
  private var que,rs5,rez=0;

  que="select a.t_" +par2+"  from ddl_leg_dbt a, ddl_tick_dbt b  where a.t_dealid=b.t_dealid and a.t_legid ="+par3+" and b.t_bofficekind=102 and a.t_dealid="+par1; 
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=rs5.value(0);
     end;
  end;
  return rez;
END;

/*
Macro Получить_Курс0 ( Rate, OtherFI, DateR, Type )
    var stat;
    record ratedef ( ratedef );
    SetParm (0, $0);
    if ( Type == NULL )
        stat = ПолучитьКурс (ratedef, 0, OtherFI);
    else
        stat = ПолучитьКурс (ratedef, 0, OtherFI, Type);
    end;

    if ( stat != 0 ) return 1; end;
    stat = ПолучитьЗначениеКурса (ratedef, DateR);
    if ( stat != 0 ) return 1; end;

    SetParm (0, ratedef.Rate/10000);
    return 0;
End;
*/


MACRO Account_KU(par1,par2)
  private var que,rs5,rez="0";
  que="select a.t_account from  dmcaccdoc_dbt a, dmccateg_dbt b where a.t_dockind=102   and a.t_docid="+par1+" and t_catid=b.t_id and b.t_code='"+par2+"'";
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=rs5.value(0);
     end;
  end;
  return rez;
END;


MACRO Fx_op(par1)
  private var rez=0;
  if ( par1 == 1020 )
     rez="SW";
  else
     rez="FX";
  end;
  return rez;
END;

MACRO Fx_tick(par1,par2,par3)
  private var que,rs5,rez=0;

  que="select b.t_" +par2+"  from ddl_leg_dbt a, ddl_tick_dbt b  where a.t_dealid=b.t_dealid and a.t_legid ="+par3+" and b.t_bofficekind=102 and a.t_dealid="+par1; 
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=rs5.value(0);
     end;
  end;
  return rez;
END;



MACRO Fx_fiid(par1)
  private var que,rs5,rez=0;

  que="select a.t_ccy from dfininstr_dbt a where a.t_fiid="+par1; 
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=rs5.value(0);
     end;
  end;
  if ( rez == "RUR")
     rez="RUB";
  end;
  return rez;
END;

MACRO Fx_rezerv(par1)
  private var que,rs5,rez=0;

  que="SELECT rsb_struct.getdouble(t_text) FROM dnotetext_dbt where t_objecttype=3 and t_notekind=3 and t_documentid=lpad("+par1+",10,'0') order by t_id desc ";
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=rs5.value(0);
     end;
  end;
  return rez;
END;


MACRO Fx_kontr(par1,par2)
  private var que,rs5,rez=0;

  que="select a.t_shortname,a.t_name from dparty_dbt a where a.t_partyid="+par1; 
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        if ( par2 == 0 )
           rez=rs5.value(0);
        else
           rez=rs5.value(1);
        end;
     end;
  end;
  return rez;
END;


MACRO Fx_comi(par1,par2)
  private var que,rs5,rez=0;
  if (par2 == 0 )
    que="select count(*) from dl_comi_dbt where t_partyid="+par1; 
  elif (par2 == 1 )
    que="select t_amount from dl_comi_dbt where t_partyid="+par1; 
  elif (par2 == 2 )
    que="select t_rate from dl_comi_dbt where t_partyid="+par1; 
  else
    que="select t_fiid from dl_comi_dbt where t_partyid="+par1; 
  end;
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
           rez=rs5.value(0);
     end;
  end;
  return rez;

END;



MACRO Fx_paym(par1,par2,par3)
  private var que,rs5,rez=0;

  que="select a.t_" +par2+"  from dpmpaym_dbt a  where a.t_dockind=4813 and a.t_documentid ="+par1+" and a.t_purpose="+par3; 
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=rs5.value(0);
     end;
  end;
  return rez;
END;

MACRO Fx_paym2(par1,par2)
  private var que,rs5,rez=0;

  que="select a.t_" +par2+"  from dpmpaym_dbt a  where a.t_paymentid ="+par1;
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=rs5.value(0);
     end;
  end;
  return rez;
END;


MACRO Swift_account(par1,par2)

  private var que,rs5,rez=0;
  que="select a.t_account from dcorschem_dbt a where a.t_fiid="+par1+" and a.t_corrid="+par2;
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=rs5.value(0);
     end;
  end;
  return rez;
END;



MACRO Osn(fd,lleg)
  private var que,rez=0,rs52,fi1,fi2,nfi1=" ",nfi2=" ",ssop;


    if ( lleg == 10 )
       ssop="Конверсионная сделка, ";

       que="select count(*) from ddl_tick_dbt t, dpmpaym_dbt a where t.t_dealid="+fd.tick.rec.dealid+" and a.t_documentid=t.t_dealid and a.t_dockind=100 and (substr(a.t_payeraccount,1,3)='202' or substr(a.t_receiveraccount,1,3)='202') ";
       rs52 = LnGetRecordSet(que);
       if(rs52 != null)
         if (rs52.moveNext) 
            if ( rs52.value(0) > 0 )
              ssop="Банкнотная сделка, ";
              lleg = 5;
            end;
         end;
       end;

       if ( fd.tick.rec.dealtype == 11030 )
          ssop="Банкнотная сделка, ";
          lleg = 5;
       end;

        rez=ssop+ "перечисление суммы по сделке покупки/продажи валюты от "+СДАТ0(fd.tick.rec.dealdate)+" c "+ Fx_kontr(fd.tick.rec.partyid,0) +". Без налога(НДС)";
        

        return rez;
    end;

    if ( fd.tick.rec.dealtype == 11030 )
         lleg = 5;
    end;


    if ( lleg == 1 )
	    if (fd.tick.rec.typedoc == "B" )
        	ssop="Продажа ";
    	    else
        	ssop="Покупка ";
    	    end;
    else
	    if (fd.tick.rec.typedoc == "B" )
        	ssop="Покупка ";
    	    else
        	ssop="Продажа ";
    	    end;
    end;
    if ( lleg > 4 )
//        rez="Банкнотная сделка c "+ Fx_kontr(fd.tick.rec.partyid,0)+" от "+СДАТ0(fd.tick.rec.dealdate);  // lisowski 2016
        rez="Банкнотная сделка c "+ Fx_kontr(fd.tick.rec.partyid,1)+" от "+СДАТ0(fd.tick.rec.dealdate);
        lleg=0;
        return rez;
    end;

    que="select a.t_pfi,a.t_cfi,a.t_principal,a.t_cost from ddl_leg_dbt a, ddl_tick_dbt b  where a.t_dealid=b.t_dealid and a.t_legid ="+lleg+" and b.t_bofficekind=100 and a.t_dealid="+fd.tick.rec.dealid;
    rs52 = LnGetRecordSet(que);
    if(rs52 != null)
      if (rs52.moveNext) 
         fi1=rs52.value(0);
         fi2=rs52.value(1);

      end;
    end;

    nfi1=Fx_fiid(fi1);
    nfi2=Fx_fiid(fi2);



    if ((fi1 == 0 ) or (fi2 == 0 ) )
     rez=ssop+nfi1+" по сделке "+fd.tick.rec.dealcode+" от "+СДАТ0(fd.tick.rec.dealdate)+" "+ Fx_kontr(fd.tick.rec.partyid,0);
    else
     rez=ssop+nfi1+" за "+nfi2+ " по сделке "+fd.tick.rec.dealcode+" от "+СДАТ0(fd.tick.rec.dealdate)+" "+ Fx_kontr(fd.tick.rec.partyid,0);
    end;



  return rez;
END;


MACRO Corr_loro(par1)
  private var que,rs09,rez=0;

  que="select count(*) from dsettacc_dbt a, dpmautoac_dbt b  WHERE  b.t_fikind=1 and b.t_servicekind=2 and a.T_SETTACCID=b.T_SETTACCID ";
  que=que+" and a.T_partyid=7177 and t_bankcorrid=7177    and a.t_fiid=0   and a.t_account='"+par1+"'"; 
  rs09 = LnGetRecordSet(que);
  if(rs09 != null)
     if (rs09.moveNext) 
        rez=int(rs09.value(0));
     end;
  end;

  return rez;
END;

