IMPORT fx_globals, funk, RSD, mmlibr, MmarkInter,dl_lib,dl_plib;
import MesInter;


record tick( dl_tick );

var col2=TArray();
var oprdocs = Tbfile( "oprdocs.dbt", "W" );
var nflag,idop,istep,Comment;

MACRO ExecuteStep(Buffer, Document)
    return 0 ;
END;


//private  var dealid,ndealid,sql,pzag,cmd2,datra,nmt,d0,sss,sd0,ss0,sql0,ik2,soob=" ",par1,par2,{curdate},rs5,pId2,sidk,zag,sdiller,rs02,datransh;
// private var que,rez,jk=0,dealtype,partyid,nflag,Comment,docid,idop;
// array mas1,mas0;


MACRO Sprovod()

     private var cmd2,datpr,zag,sss,sql0;

     datpr={curdate};
     getdate(datpr,"Дата проводки",10);
     datpr=СДАТ(datpr);

     zag="Внебалансовые проводки за "+datpr;
     sql0="select t_acctrnid pId2 ,t_date_carry da,  t_number_pack np,t_account_payer acc1,t_account_receiver acc2,(select aa.t_ccy from dfininstr_dbt aa where aa.t_fiid=t_fiid_payer) sfiid  ,t_sum_payer ssu,t_ground ground";
     sql0=sql0+" from dacctrn_dbt where t_number_pack < 64 and  t_chapter=3  and to_char(t_date_carry,'dd.mm.yyyy')='"+datpr+"' order by np desc";
     // msgbox(sql0);
     cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );



  macro EvProc2 (rs0, cmd2, id, key )

     private var pId2 ;


     if (cmd2 == DLG_INIT)	// Инициализация
        rs0.MoveFirst();          

        if (pId2 != "0")  // Надо найти запись
           while ( (rs0.value ("pId2") != pId2) And (Not rs0.EOF) )  
              rs0.Move(1, RELATIVE);
            end;
        end;
        GoToScroll(rs0, true);

     elif (cmd2 == DLG_KEY)
        pId2=rs0.value ("pId2");
 
        if(DLG_KEY_ENTER == Key)
          if(DLG_KEY_ENTER == Key)  
            nflag=rs0.value ("pId2");
            return CM_CANCEL;
          end;



        elif(DLG_KEY_F9 == Key) 
          return CM_SELECT;
        end;
     end;
  end;


  AddCol (col2, 0, "np","Пачка", 4);
  AddCol (col2, 1, "acc1","Счет по дебету", 20);
  AddCol (col2, 2, "acc1","Счет по кредиту", 20);
  AddCol (col2, 3, "ssu","Cумма сделки", 15);
  AddCol (col2, 4, "sfiid","Вал", 3);
  AddCol (col2, 5, "ground","Основание", 40);

     sss="Enter- Выбор   ESC- Выход " ;

     while(RunScroll(cmd2, 6, col2, null, @EvProc2,zag,sss, null, 5, 15,122,45) )
     cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );
    end;

end;




macro _Create_pr()
   
   var stat=0;
   oprdocs.rec.DOCKIND     =1;
   oprdocs.rec.DOCUMENTID  ="";
   oprdocs.rec.ID_OPERATION=idop;
   oprdocs.rec.ID_STEP= istep;
   oprdocs.rec.PART   =1;
   oprdocs.rec.acctrnid   = nflag;


   stat = oprdocs.insert;
   if (not stat)
       RunError( "Ошибка при создании новой сделки 10" );
   end;

   OnError( RslErrObj ) //А если ошибка - заполняем коммент
   Comment = RslErrObj.Message;

   AbortTrn();
end;




MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -откат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */  


  SetBuff(tick, FirstDoc );
  if ( CommitOrRollback == 1 ) 
      nflag=0;
      Sprovod();
      if (nflag > 0)
         idop=ID_Operation;
         istep=ID_Step;

         if (ProcessTrn(0,"_Create_pr"))
      //  if (_Create_pr() )

             msgbox("Проводка привязана к сделке !");

         else
             msgbox("Проводка НЕ привязана к сделке !");
         end;


      end;

  end;

  return 0;
END;



