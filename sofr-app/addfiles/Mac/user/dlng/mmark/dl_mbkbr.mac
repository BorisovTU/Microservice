/*
Задача РСХБ 605
Обработка сделок Банка России по распоряжениям
LKL - распарсивание файлов, создание сделки
GYA - создание залога, обновление залоговой стоимости
*/
import RSBDataSet, dlgCommon,funk,dl_nplat;
import FIInter,rsexts,oralib,likepy;
import "gtconst.inc" , calculate, funk, "cb_sql.mac", dl_plib, globals ;
import DealsInter, Проценты, PTInter, PaymInter, OprInter, SfInter, FIInter, "dl_note_lib.mac",Календарь ;


file Report1  () txt 1024 write;   // Вывод предварительных результатов

// var Comment,ErrComm = "";
var ErrComm = "";
var ProcDate     = {curdate};
var ProcTime     = Time();
var ProcTimeFile;
var DealArr = TArray();
var ndealtype = 12300,ndealcode,nsda,flmsfo=0;
var basi, ddealcode,isobr,qque,dda,rs5,rs55,fl,ssup,     //признак корректной обраотки файла
          locdeal,   //структура deal.dbt
          parrec,    //структура dl_tick.dbt
          grnt,      //dl_grnt.dbt
          mdl_leg,   //структура dl_leg.dbt
          mdmmdqlt, //dmmdqlt_dbt
          sdl_order, //структура dl_order.dbt
          mdl_order, //dl_order.dbt
          mdl_secur, //dl_secur.dbt
          sdl_secure,//структура dl_secure.dbt
          mparty,    //party.dbt
          mspground; //структура spground.dbt
const mcateg=1,      //категория залога
      nNodeK=124,    //тип примечания для договора
      mCurCLnt = 343;//PartyId ГУ БАНКА РОССИИ ПО ЦФО

private   var paym      = Tbfile( "pmpaym.dbt", "W" );
private   var paymprop  = Tbfile( "pmprop.dbt", "W" );
private   var paymprop2 = Tbfile( "pmprop.dbt", "W" );
private   var pmrmprop  = Tbfile( "pmrmprop.dbt", "W" );


macro Ins_katt( par10, par11,par12)
  private var T_DOCUMENTID;
  private var  que0, rs0, cmd, v_attrid;

  que0="select count(*) from  dobjatcor_dbt  where t_objecttype=103 and t_object = lpad("+par10+",34,'0') and t_groupid="+par11 ;
  rs0 = LnGetRecordSet(que0);
  if(rs0 != null)
     if (rs0.moveNext) 
        v_attrid =int(rs0.value(0)); 
     end;	
  end;

  if (v_attrid == 0 )
     que0="INSERT INTO dobjatcor_dbt (T_OBJECTTYPE,T_GROUPID,T_ATTRID,T_OBJECT,T_GENERAL,T_VALIDFROMDATE,T_OPER,T_VALIDTODATE,T_SYSDATE,T_SYSTIME,T_ISAUTO,T_ID) "+
     "VALUES (103,"+par11+","+par12+",LPAD("+par10+", 34,'0'),chr(88),to_date('"+dda+"'),"+{oper}+",to_date('31129999','DDMMYYYY'),trunc(sysdate),to_date('01010001'||to_char(sysdate,'hhmiss'),'DDMMYYYYhhmiss'),chr(88),dobjatcor_dbt_SEQ.Nextval)";
     // msgbox(que0);
      rs0 = LnGetRecordSet(que0);
  else
     que0="update dobjatcor_dbt set t_attrid = "+ par12+" where  t_objecttype=103  and t_object = lpad("+par10+",34,'0') and t_groupid="+par11 ;
     rs0 = LnGetRecordSet(que0);
  end;

end;



private macro AddField (ar, name, tp, sz, dec)
     ar [ar.size] = name;
     ar [ar.size] = tp;
     ar [ar.size] = sz;
     ar [ar.size] = dec;
     ar [ar.size] = 0;
end;


//вернуть только числа из строки
private macro getDigStr(str)
  private var retval="",i=0;
  str = trim(str);
  while(i<strlen(str))
    if(index("0123456789",substr(str,i,1))>0)
      retval=retval+substr(str,i,1);
    end;
    i=i+1;
  end;
  return int(retval);
end;


// получить строку времени с заменой символа ":" на любой другой. требуется для использования в имени файла
private macro GetTimeInString (t, symb)
     var temp;
     var s = iif(valtype(symb)==V_STRING,symb," ");
     var stat = index;
     if (valtype(t) == V_TIME)
        temp = string(t);
        stat = index(temp, ":");
        while (stat != 0)
           temp = substr(temp, 1, stat-1) + symb + substr(temp, stat+1, strlen(temp)-stat);
           stat = index(temp, ":");
        end;
        return temp;
     else
        return "Некорректная дата";
     end;
end;

macro toRep1 (str)
   var stat = false;
   if(trim(str)!="")
      stat  = Insert(Report1, str);
   end;
   return stat;

end;

//получить массив залогов клиента
private macro GetNumZalog(sdognum, partyid)
  private var que, rs, dognum, i, e, anum = TArray;
  anum.Size = 0;
  i = 0;
  e = index(sdognum,"=");
  while ( e > 0)

     dognum = substr(sdognum, 1, (e-1) );
     que = "select t.t_contractid from ddl_order_dbt t where t.t_contractor="+string(partyid)+" and t.t_ordernumber='"+dognum+"'";
     rs = LnGetRecordSet(que);
     if(rs != null)
        if (rs.moveNext) 
           anum(i) = rs.value(0); 
        else
           anum(i) = 0; 
        end;
     end;

     i = i+1;
     e = index(sdognum,"=");
     sdognum = substr(sdognum, e+1);
  end;
  return  anum;
end;

//проверить наличие сделки
private macro mCheckTick()
  private var sql,retval=false;
//  sql = "select nvl(t_dealid,0) from ddl_tick_dbt where t_partyid=:1 and t_dealtype=:2 and t_dealgroup=:3 ";
//  sql = ExecSqlSelect(sql, MakeArray(SqlParam("1", mCurCLnt),SqlParam("2", 12300),SqlParam("3", 8390184)), false);


  sql = "select nvl(t_dealid,0) from ddl_tick_dbt where t_partyid=:1 and t_dealcode=:2 ";
  sql = ExecSqlSelect(sql, MakeArray(SqlParam("1", mCurCLnt),SqlParam("2", ndealcode)), false);



  if(sql.MoveNext())
    if(sql.value(0)>0)
      retval = true;
    end;
  end;
  return retval;
end;

//проверить наличие залога
private macro mCheckGrnt(dealid)
  private var sql,retval=false;
  sql = "select nvl(count(*),0) from ddl_grnt_dbt where t_dealid=:1 ";
  sql = ExecSqlSelect(sql, MakeArray(SqlParam("1", dealid)), false);
  if(sql.MoveNext())
    if(sql.value(0)>0)
      retval = true;
    end;
  end;
  return retval;
end;

//заполнить данные по сделке МБК
private macro mFillDl()
  private var sql,retval=false;
//  sql = "select t.t_dealid,t.t_dealcode,t.t_dealcodets,t.t_partyid,t.t_dealdate,t.t_regdate,t.t_BRANCH,t.T_DEPARTMENT,l.t_start,l.T_MATURITY,p.t_shortname "+
//        " from ddl_tick_dbt t,ddl_leg_dbt l,dparty_dbt p where t.t_partyid=:1 and t.t_dealtype=:2 and t.t_dealgroup=:3 and L.T_DEALID=T.T_DEALID and p.t_partyid=t.t_partyid ";
//  sql = ExecSqlSelect(sql, MakeArray(SqlParam("1", mCurCLnt),SqlParam("2", 12300),SqlParam("3", 8390184)), false);



  sql = "select t.t_dealid,t.t_dealcode,t.t_dealcodets,t.t_partyid,t.t_dealdate,t.t_regdate,t.t_BRANCH,t.T_DEPARTMENT,l.t_start,l.T_MATURITY,p.t_shortname "+
        " from ddl_tick_dbt t,ddl_leg_dbt l,dparty_dbt p where t.t_partyid=:1 and t.t_dealcode=:2 and L.T_DEALID=T.T_DEALID and p.t_partyid=t.t_partyid ";

  sql = ExecSqlSelect(sql, MakeArray(SqlParam("1", mCurCLnt),SqlParam("2", ndealcode)), false);



  while((sql.MoveNext()) and (not retval))
    if(getNoteDifValue(sql.value("t_dealid"), nNodeK)==locdeal.rec.MAINNUMBER)
      parrec.rec.dealid            = sql.value("t_dealid");
      parrec.rec.dealcode          = sql.value("t_dealcode");
      parrec.rec.dealcodets        = sql.value("t_dealcodets");
      parrec.rec.partyid           = sql.value("t_partyid");
      parrec.rec.dealdate          = sql.value("t_dealdate");
      parrec.rec.regdate           = sql.value("t_regdate");
      parrec.rec.branch            = sql.value("t_branch");
      parrec.rec.DEPARTMENT        = sql.value("t_DEPARTMENT");
      mdl_leg.rec.start            = sql.value("t_start");
      mdl_leg.rec.MATURITY         = sql.value("t_MATURITY");
      sdl_order.rec.contractorname = sql.value("t_shortname");
      retval = true;
    end;
  end;
  sql = null;
  if(( locdeal.rec.FTYPE == 2 ) or ( locdeal.rec.FTYPE == 3 ))
    sql = "select t_partyid from dparty_dbt where t_shortname like '"+locdeal.rec.contr+"'";
    sql = LnGetRecordSet(sql);
    if(sql != null)
      if(sql.moveNext) 
        sdl_secure.rec.contractor = sql.value("t_partyid");
      end;
    end;
    sql = null;
    if(sdl_secure.rec.contractor==0)
      mparty    = Tbfile("party.dbt", "W");
      mparty.rec.partyid   = 0;
      mparty.rec.shortname = locdeal.rec.contr;
      mparty.rec.name      = locdeal.rec.contr;
      mparty.rec.legalform = 1;
      mparty.rec.superior  = -1;
      mparty.rec.nrcountry = "RUS";
      if(mparty.insert())
        sdl_secure.rec.contractor = mparty.rec.partyid;
      end;
      mparty = null;
    end;
  end;
  return retval;
end;

//создать dl_secure (требования по кредитным договорам для залога)
private macro fdl_secure()
  private var retval = false;
  mdl_secur.rec.contractkind       = 126;
  mdl_secur.rec.contractid         = mdl_order.rec.CONTRACTID;
  mdl_secur.rec.fiid               = locdeal.rec.VAL;
  mdl_secur.rec.quantity           = 1;
  mdl_secur.rec.valuationdate      = date(int(substr(locdeal.rec.datedeal,1,2)),int(substr(locdeal.rec.datedeal,4,2)),int(substr(locdeal.rec.datedeal,7)));
  mdl_secur.rec.cost               = money(locdeal.rec.rest);
  mdl_secur.rec.qualitycategory    = mcateg;
  mdl_secur.rec.signdate           = mdl_secur.rec.valuationdate;
  mdl_secur.rec.typesecur          = 1;
  mdl_secur.rec.contractor         = sdl_secure.rec.contractor;
  mdl_secur.rec.depositorydepo     = -1;
  mdl_secur.rec.depositoryverify   = -1;
  mdl_secur.rec.crdnumber          = locdeal.rec.number;
  mdl_secur.rec.REALTYNAME         = locdeal.rec.number;

  mdl_secur.rec.crdsum             = money(locdeal.rec.rest);
  mdl_secur.rec.crdfiid            = locdeal.rec.VAL;
  if(mdl_secur.insert())
    mdl_secur.rec.securityproperties = mdl_secur.rec.numsecinorder;
    mdl_secur.rec.securid_ref        = mdl_secur.rec.numsecinorder;
    if(mdl_secur.update())
      retval = true;
    end;
  end;
  return retval;
onerror
  return false;
end;

//создать spground
private macro fspground()
  private var retval = false;
  mspground.rec.doclog        = 488;
  mspground.rec.kind          = 111;
  mspground.rec.direction     = 1;
  mspground.rec.xld           = mdl_order.rec.ordernumber;
  mspground.rec.registrdate   = parrec.rec.dealdate;//{curdate};
  mspground.rec.registrtime   = time();
  mspground.rec.party         = -1;
  mspground.rec.signeddate    = parrec.rec.dealdate;//{curdate};
  mspground.rec.signedtime    = time();
  mspground.rec.proxy         = -1;
  mspground.rec.division      = 6000;
  mspground.rec.references    = 1;
  mspground.rec.comment       = locdeal.rec.number;
  mspground.rec.sourcedocid   = mdl_order.rec.CONTRACTID;
  mspground.rec.sourcedockind = 126;
  mspground.rec.partyname     = locdeal.rec.contr;
  mspground.rec.department    = parrec.rec.DEPARTMENT;
  mspground.rec.branch        = parrec.rec.branch;
  mspground.rec.version       = 1;
  mspground.rec.deponent      = -1;
  mspground.rec.subjectid     = -1;
  if(mspground.insert())
    retval = true;
  end;
  return retval;
onerror
  return false;
end;

//создать dl_order
private macro fdl_order()
  private var retval = false;
  mdl_order.rec.ordernumber            = locdeal.rec.rnumber;
  mdl_order.rec.createdate             = parrec.rec.dealdate;//{curdate};
  mdl_order.rec.signdate               = parrec.rec.dealdate;//{curdate};
  mdl_order.rec.contractkind           = 111;
  mdl_order.rec.CONTRACTOR             = parrec.rec.partyid;
  mdl_order.rec.CONTRACTORNAME         = sdl_order.rec.contractorname;
  mdl_order.rec.CONTRACTORbankcodekind = 3;
  mdl_order.rec.correspbankcodekind    = 3;
  mdl_order.rec.oper                   = {oper};
  mdl_order.rec.department             = parrec.rec.DEPARTMENT;
  mdl_order.rec.kind_operation         = 2350;
  mdl_order.rec.dockind                = 126;
  mdl_order.rec.PLEDGECURATOR          = 2;
  mdl_order.rec.PLEDGESTORAGE          = 3;
  mdl_order.rec.CONTRACTORROLE         = 2;
  mdl_order.rec.expiry                 = mdl_leg.rec.MATURITY;
  mdl_order.rec.systypes               = "К";
  mdl_order.rec.flag1                  = "X";
  mdl_order.rec.branch                 = parrec.rec.branch;
  mdl_order.rec.fiid                   = locdeal.rec.VAL;
  mdl_order.rec.cost                   = 0;
  mdl_order.rec.priznak                = "X";
  if(mdl_order.insert())
    if(fspground())
      if(fdl_secure())
        mdl_order.rec.cost = money(mdl_order.rec.cost)+money(locdeal.rec.rest);
        if(mdl_order.update())
          retval = true;
        end;
      end;
    end;
  end;
  return retval;
onerror
  return false;
end;

//меняем признак обеспечения dmmdqlt.dbt по сделке
private macro fdmmdqlt()
  private var retval = false;
  mdmmdqlt.rec.dealid  = parrec.rec.dealid;
  mdmmdqlt.rec.date    = date(int(substr(locdeal.rec.datebeg,1,2)),int(substr(locdeal.rec.datebeg,4,2)),int(substr(locdeal.rec.datebeg,7)));;
  mdmmdqlt.rec.quality = 1;
  if(mdmmdqlt.insert())
    retval = true;
  end;
  return retval;
onerror
  return false;
end;

//создать залог
private macro mCreateGrnt()
  private var retval=false;
  if(fdl_order())
    ClearRecord(grnt);
    grnt.rec.DealID      = parrec.rec.DealID;
    grnt.rec.ContractId  = mdl_order.rec.CONTRACTID;
    grnt.rec.Amount      = Money(locdeal.rec.rest);
    if(grnt.insert)
      if(fdmmdqlt())
        retval = true;
      end;
    end;	  
  end;
  return retval;
onerror
  return false;
end;

//обновить залог
private macro mChgGrnt()
  private var sql,retval=false;
  sql = "select t_CONTRACTID "+
        " from ddl_grnt_dbt where t_dealid=:1 ";
  sql = ExecSqlSelect(sql, MakeArray(SqlParam("1", parrec.rec.dealid)), false);
  if(sql.MoveNext())
    grnt.rec.DealID      = parrec.rec.DealID;
    grnt.rec.ContractId  = sql.value(0);
    if(grnt.getEQ())
      mdl_order.rec.ContractId = grnt.rec.ContractId;
      if(mdl_order.getEQ())
        if(fdl_secure())
          mdl_order.rec.cost = money(mdl_order.rec.cost)+money(locdeal.rec.rest);
          if(mdl_order.update())
            grnt.rec.amount = money(grnt.rec.amount)+Money(locdeal.rec.rest);
            if(grnt.update())
              retval=true;
            end;
          end;
        end;
      end;
    end;
  end;
  sql = null;
  return retval;
onerror
  return false;
end;

private class DlngPayment()
  private const
                mode_ins = 0,
                mode_upd = 1,
                mode_del = 2;

  private var
                prm_workMode = NULL,
                prm_pmObj    = NULL;

  macro SetPurpose(_Purpose, _SubPurpose)
    prm_pmObj.Purpose    = _Purpose;
    prm_pmObj.SubPurpose = _SubPurpose;
    prm_pmObj.Number     = String(_SubPurpose);
  end;

  macro SetDocKind(_DocKind)
    prm_pmObj.DocKind = _DocKind;
  end;

  macro SetDocumentID(_DocumentID)
    prm_pmObj.DocumentID = _DocumentID;
  end;

  macro SetDepartment(_Department)
    prm_pmObj.Department = _Department;
  end;

  macro SetFIID(_FIID)
    prm_pmObj.OrderFIID          =
    prm_pmObj.BaseFIID           = 
    prm_pmObj.PayerFIID          =
    prm_pmObj.ReceiverFIID       =
    prm_pmObj.FuturePayerFIID    =
    prm_pmObj.FutureReceiverFIID = _FIID;
  end;

  macro SetLegID(_LegID)
    //dprm_LegID = _LegID;
  end;

  macro SetNetting(_Netting)
    prm_pmObj.Netting  = _Netting;
  end;

  macro SetDate(_VDate, _RDate)
    prm_pmObj.Date                 = _VDate;
    prm_pmObj.PayDate              = 
    prm_pmObj.OutTransferDate      =
    prm_pmObj.ValueDate            = _RDate;
    prm_pmObj.ClientDate           = {curdate};
  end;

  macro SetAmount(_Amount)
    prm_pmObj.OrderAmount          =
    prm_pmObj.PayerAmount          = 
    prm_pmObj.ReceiverAmount       = 
    prm_pmObj.BaseAmount           =
    prm_pmObj.FutureBaseAmount     = _Amount;
    prm_pmObj.ActuateFutureAmounts(TBA_AMOUNT);
  end;

  macro SetGround(_Ground)
    prm_pmObj.Ground = _Ground;
  end;

  macro SetPayer(_Payer, _PayerCodeKind, _PayerBankID, _PayerBankIDCodeKind, _Kind_Operation, _FIID)
    RECORD settacc(settacc);
    RECORD settaccour(settacc);

    if(_Payer == {OurBank})
      if(not FindSETTACC_PMAUTO(_PayerBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, prm_pmObj.Purpose, 0, settaccour))
        ;
      elif (not FindSETTACC_PMAUTO(_PayerBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, 0, 0, settaccour))
        ;
      elif (not FindSETTACC_PMAUTO(_PayerBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, 0, prm_pmObj.Purpose, 0, settaccour))
        ;
      elif (not FindSETTACC_PMAUTO(_PayerBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, 0, 0, 0, settaccour))
        ;
      end;

      prm_pmObj.SetPayerPI(PAYMENTS_GROUP_UNDEF,
                          _PayerBankID,
                          _PayerBankIDCodeKind,
                          settaccour.BankCode, 
                          settaccour.BankName,  
                          "",//settaccour.CorrAcc,    //коррсчет
                          _FIID,
                          settaccour.Chapter,
                          settaccour.Account, 
                          _Payer, 
                          "",
                          settaccour.INN,
                          _PayerCodeKind,       
                          settacc.Code                // клиент
                          );



      //prm_pmObj.PayerBankName = settaccour.BankName; //prm_pmObj.PayerName;
      //prm_pmObj.PayerBankCorrCodeKind = PTCK_ALL;
      //prm_pmObj.PayerBankCorrCode     = "";
      //prm_pmObj.ReceiverInOurBalance  = "";
      prm_pmObj.ReceiverOurCorrAcc    = settaccour.CorrAcc;
      //prm_pmObj.ReceiverOurCorrID     = -1;

    else
      if (not FindSETTACC_PMAUTO(_PayerBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, prm_pmObj.Purpose, 0, settacc))
        ;
      elif (not FindSETTACC_PMAUTO(_PayerBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, 0, 0, settacc))
        ;
      elif (not FindSETTACC_PMAUTO(_PayerBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, 0, prm_pmObj.Purpose, 0, settacc))
        ;
      elif (not FindSETTACC_PMAUTO(_PayerBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, 0, 0, 0, settacc))
        ;
      end;

      prm_pmObj.SetPayerPI(PAYMENTS_GROUP_UNDEF,
                            _PayerBankID,
                            _PayerBankIDCodeKind,
                             settacc.BankCode,
                             settacc.BankName,  
                             "", //settacc.CorrAcc,
                             _FIID, /*          settacc.FIID,   */
                             settacc.Chapter,
                             settacc.Account, 
                             _Payer,        /* settacc.PartyID,  */
                             settacc.RecName,
                             settacc.INN,
                             _PayerCodeKind,  /*settacc.CodeKind, */
                             settacc.Code  //clnt  
                             );

      if (settacc.BankCorrID != {OurBank})
          prm_pmObj.PayerBankCorrAcc      = settacc.CorrAcc; 
          prm_pmObj.PayerBankCorrCodeKind = settacc.BankCorrCodeKind;
          prm_pmObj.PayerBankCorrCode     = settacc.BankCorrCode;
          prm_pmObj.PayerBankCorrName     = settacc.BankCorrName;
      end;
    end;
  end;

  macro SetReceiver(_Receiver, _ReceiverCodeKind, _ReceiverBankID, _ReceiverBankIDCodeKind, _Kind_Operation, _FIID);
    RECORD settaccour(settacc);
    RECORD settacc(settacc);

    if(_Receiver == {OurBank})
      if (not FindSETTACC_PMAUTO(_ReceiverBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, prm_pmObj.Purpose, 0, settaccour))
          ;
      elif (not FindSETTACC_PMAUTO(_ReceiverBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, 0, 0, settaccour))
          ;
      elif (not FindSETTACC_PMAUTO(_ReceiverBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, 0, prm_pmObj.Purpose, 0, settaccour))
          ;
      elif (not FindSETTACC_PMAUTO(_ReceiverBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, 0, 0, 0, settaccour))
          ;
      end;

      prm_pmObj.SetReceiverPI(PAYMENTS_GROUP_UNDEF,
                          _ReceiverBankID,
                          _ReceiverBankIDCodeKind,  
                          settaccour.BankCode,
                          settaccour.BankName,
                          "", //settaccour.CorrAcc,
                          _FIID,
                          settaccour.Chapter,
                          settaccour.Account, 
                          _Receiver,
                          "",
                          settaccour.INN,
                          _ReceiverCodeKind,   
                          settacc.Code  //clnt  
                          );

      //prm_pmObj.ReceiverBankName = settaccour.BankName; //prm_pmObj.ReceiverName;
      //prm_pmObj.ReceiverBankCorrCodeKind = PTCK_ALL;
      //prm_pmObj.ReceiverBankCorrCode     = "";
      //prm_pmObj.PayerInOurBalance  = "";
      prm_pmObj.PayerOurCorrAcc    = settaccour.CorrAcc;
      //prm_pmObj.PayerOurCorrID     = -1;
    else
      if (not FindSETTACC_PMAUTO(_ReceiverBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, prm_pmObj.Purpose, 0, settacc))
        ;
      elif (not FindSETTACC_PMAUTO(_ReceiverBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, 0, 0, settacc))
        ;
      elif (not FindSETTACC_PMAUTO(_ReceiverBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, 0, prm_pmObj.Purpose, 0, settacc))
        ;
      elif (not FindSETTACC_PMAUTO(_ReceiverBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, 0, 0, 0, settacc))
        ;
      end;

      prm_pmObj.SetReceiverPI(PAYMENTS_GROUP_UNDEF,
                             _ReceiverBankID,
                             _ReceiverBankIDCodeKind,
                             settacc.BankCode,
                             settacc.BankName,   
                             "",                // settacc.CorrAcc,
                             _FIID,             // settacc.FIID, 
                             settacc.Chapter,
                             settacc.Account, 
                             _ReceiverBankID,   // settacc.PartyID, 
                             settacc.RecName,
                             settacc.INN,
                             _ReceiverCodeKind,  // settacc.CodeKind,
                             settacc.Code        //clnt  
                             );

      if (settacc.BankCorrID != {OurBank})
        prm_pmObj.ReceiverBankCorrAcc      = settacc.CorrAcc;
        prm_pmObj.ReceiverBankCorrCodeKind = settacc.BankCorrCodeKind;
        prm_pmObj.ReceiverBankCorrCode     = settacc.BankCorrCode;
        prm_pmObj.ReceiverBankCorrName     = settacc.BankCorrName;
      end;
    end;    
  end;

  macro CreateNew()
    prm_pmObj.Actuate();

    //lkl paym
    if (prm_pmObj.Update())
      RunError("Ошибка при создании платежей.");
    end;
    //
  end;

  private macro ClassConstructorNew()
    prm_workMode = mode_ins;
    prm_pmObj    = RsbPayment(0);
    prm_pmObj.Department       = {OperDprt};
    prm_pmObj.PaymStatus       = PM_PREPARING;
    prm_pmObj.IsPlanPaym       = "X";
    prm_pmObj.ValueDate        = {curdate};
    prm_pmObj.SubPurpose       = 0;
    prm_pmObj.Oper             = {oper};
    prm_pmObj.Origin           = PAYMENT_OR_AUTO;
  end;

  private macro ClassConstructor(CountParm)
    if(CountParm == 1)
      ClassConstructorNew();
    elif (CountParm == 2)
      //
    elif (CountParm == 5)
      //
    end;
  end;

  ClassConstructor(ParmCount());
end;

///////////////////////////////////////////////////////////////////////////////////
private class Ob_DealFileImport( obdeal )
  private var
    prm_SeanceID,
    prm_RecordID;

  private var
    prm_ObjID,
    prm_Comment;

  private var
    RG;

  private var
    prm_tick,
    prm_legBase;

  private var
    prm_deferOp,
    prm_deferDoc;


  PRIVATE MACRO ДАТ0(s);
    private var ss,d1;
    ss=trim(substr(string(s),1,10));
    if (substr(ss,3,1) != "." )
      ss="0"+ss;
    end; 
    d1=date(ss);
    return(d1);
  END;


  private macro CreateTick(_BofficeKind)
    var
      type     = 0,sda,{curadate},rs2,que2;

    prm_tick.rec.DealID      = 0;
    prm_tick.rec.BofficeKind = _BofficeKind;

    //Статические параметры   
    prm_tick.rec.TradeSystem = PTCK_REUTER; 
    prm_tick.rec.DealStatus  = DL_PREPARING;  //LKL ???
    prm_tick.rec.RegDate     = {curdate};
    prm_tick.rec.Oper        = {oper};   
    prm_tick.rec.ClientID    = ALLFININSTR;
    prm_tick.rec.DepositID   = ALLFININSTR;
    prm_tick.rec.MarketID    = ALLFININSTR;
    prm_tick.rec.PortfolioID = 0;
    prm_tick.rec.IndocID     = 0;
    prm_tick.rec.NumberPack  = 0;
    //prm_tick.rec.Department  = {OperDprt};
    prm_tick.rec.Department  = locdeal.rec.DEPART;
    prm_tick.rec.branch      = {OperDprt};
    prm_tick.rec.OriginID    = 0; // GT_REUTERS;  //LKL???
    prm_tick.rec.Netting     = 1;
    prm_tick.rec.LinkChannel = 0;
    prm_tick.rec.conftpid    = 2; //SWIFT код подтверждения


    //ID
    //prm_tick.rec.DealID = locdeal.rec.DEALID;

    //Генеральное соглашение
    prm_tick.rec.GenagrID = -1; //locdeal.rec.SOGL;

    //Номер сделки в торговой системе
    sda=СДАТ(ДАТ0(locdeal.rec.DATEBEG));
    prm_tick.rec.DealCodeTS = "МБК-БАНК-РОССИИ-"+substr(sda,1,2)+substr(sda,4,2)+substr(sda,7); 

    //locdeal.rec.NUMBER; 

    //Дата заключения сделки   
    prm_tick.rec.DealDate =  ДАТ0(locdeal.rec.DATEBEG); 

    //Время заключения сделки   
    prm_tick.rec.DealTime = Time(0,0,0);

    //Дилер   
    prm_tick.rec.TraderID = -1; //locdeal.rec.TRADER;

    //Идентификатор контрагента   
    prm_tick.rec.PartyID = locdeal.rec.CONTR;

    //Системный тип документа   
    prm_tick.rec.TypeDoc = "L";
    prm_tick.rec.numberpack = 99;


    //Комментарий
    prm_tick.rec.Comment = locdeal.rec.COMMENT;


    //тип сделки
    //if   ( trim(locdeal.rec.DEALTYPE) == "П" )
    prm_tick.rec.DealType = 12300;
    //elif ( trim(locdeal.rec.DEALTYPE) == "Р" )
    //    prm_tick.rec.DealType = 32305; 
    //end;



    if ((ДАТ0(locdeal.rec.DATEEND) - ДАТ0(locdeal.rec.DATEBEG))  > 180 )
      if(GetTrue(true, "Срок сделки более 180 дней !  Нелинейный метод учета сделки по МСФО ?"))
          prm_tick.rec.DealType =  32300;
          flmsfo=1;
      end;
    end;



    //Группа сделки
    prm_tick.rec.DealGroup = GetOperationGroup (prm_tick.rec.DealType);


    //генерим номер сделки - не генерим
    // prm_tick.rec.DealCode = "12345";//locdeal.rec.DEALID; locdeal.rec.VNUMBER;
    prm_tick.rec.DealCode = "МБК-БАНК-РОССИИ-"+substr(sda,1,2)+substr(sda,4,2)+substr(sda,7); 


    que2="select count(*) from ddl_tick_dbt where substr(t_dealcode,1,24)='"+prm_tick.rec.DealCode+"'";
    rs2 = LnGetRecordSet(que2);
    if(rs2 != null)
        if (rs2.moveNext) 
           if (rs2.value(0)  > 0 )
              prm_tick.rec.DealCode=prm_tick.rec.DealCode+"/"+string(int(rs2.value(0))+1);
              prm_tick.rec.DealCodeTS=prm_tick.rec.DealCode;
           end;
        end;
     end;

    ddealcode=prm_tick.rec.DealCode; 

    //prm_tick.rec.DealCode=Kol_sdel(prm_tick.rec.DealDate,prm_tick.rec.PartyID,prm_tick.rec.DealType);

    //lkl???
    //prm_tick.rec.userfield3= prm_tick.rec.Comment;
    if (not prm_tick.insert)
        RunError("Ошибка при создании новой сделки." );
    end;

    //Добавим примечания на сделку
    SetNoteDifValue( prm_tick.rec.DealID, nNodeK, locdeal.rec.RNUMBER );
    /*
    if ( (index(locdeal.rec.PPROLONG,"ДА")>0 ) and (strlen(locdeal.rec.PDATE)==10) )
     	SetNoteDifValue( prm_tick.rec.DealID, 120, ДАТ0(locdeal.rec.PDATE) );
    end;
    */

  end;

  private macro Basis_mbk(s1,s2)
    private var que,rs10,rez;
    rez=100;

    //в селекте некоторая избыточность
    if( s1 == 32305 ) //  размещение
      que="select t_number from dprccalc_dbt where t_chargescheduleid=2 and t_groupcalcid=2 and t_resourcekind=2 and t_calendar='"+s2+"'";
    elif ( s1 == 12300 )       // привлечение
      que="select t_number from dprccalc_dbt where t_chargescheduleid=2 and t_groupcalcid=3 and t_resourcekind=1 and t_calendar='"+s2+"'";

    elif ( s1 == 32300 )       // привлечение МСФО
      que="select t_number from dprccalc_dbt where t_chargescheduleid=2 and t_groupcalcid=3 and t_resourcekind=1 and t_calendar='"+s2+"'";

    end;
    rs10 = LnGetRecordset(que);
    if(rs10 != null)
      if(rs10.moveNext) 
        rez=rs10.value(0);
      end;
    end;
    return rez;
  end;

  private macro CreateLeg()
    var
      type     = 0;

    prm_legBase.rec.DepositID    = ALLFININSTR;
    prm_legBase.rec.Registrar    = ALLFININSTR;
    prm_legBase.rec.Pitch        = 1;
    prm_legBase.rec.Mode         = 1;
    prm_legBase.rec.PeriodNumber = 10000;
    prm_legBase.rec.PeriodType   = 3;
    prm_legBase.rec.Diff         = 0;
    prm_legBase.rec.PayDay       = 0;
    prm_legBase.rec.TablePercent = "";
    prm_legBase.rec.Caption      = 0;
    prm_legBase.rec.TypeDate     = 0;
    prm_legBase.rec.CountDay     = 0;
    prm_legBase.rec.Correct      = 0;

    prm_legBase.rec.DealID = prm_tick.rec.DealID;

    //валюта
    prm_legBase.rec.PFI = int(locdeal.rec.VAL);//GetFiidCodeByName(locdeal.rec.PFI);

    //сумма
    prm_legBase.rec.Principal = Money(locdeal.rec.AMOUNT);

    prm_legBase.rec.LegNumber = prm_tick.rec.DealCode;	  

    //elif (prm_tick.rec.BofficeKind == DL_IBCDOC)
    //статические параметры    
    prm_legBase.rec.LegID = 1;
    prm_legBase.rec.Scale = 100; //100;

    // prm_legBase.rec.Point = strlen(locdeal.rec.RATE)-Index(locdeal.rec.RATE,"."); 

    prm_legBase.rec.Point = 2;

    //if (ValType(GetRegistryValue ("MMARK\\ОБЩИЕ\\ТОЧНОСТЬ", V_INTEGER, prm_legBase.rec.Point)) == V_UNDEF)
    //  prm_legBase.rec.Point = 4;
    //end;

    prm_legBase.rec.CFI = prm_legBase.rec.PFI;

    //Действующая ставка 
    //prm_legBase.rec.Price = Double(locdeal.rec.RATE);    //проценты
    prm_legBase.rec.Price = Double(locdeal.rec.RATE)*pow(10, prm_legBase.rec.Point);    
    //InsNewPrice(prm_tick.rec.DealID, Double(locdeal.rec.NEWPRICE));

    // Даты валютирования

    prm_legBase.rec.Start = ДАТ0(locdeal.rec.DATEBEG); 
    prm_legBase.rec.Maturity = ДАТ0(locdeal.rec.DATEEND); 


    //Количество дней в сделке для расчета процентов
    prm_legBase.rec.Duration = prm_legBase.rec.Maturity - prm_legBase.rec.Start;


    //Сумма процентов
    //add          prm_legBase.rec.Cost = GetProcAmount(locdeal.rec.DEALID);
    // prm_legBase.rec.Cost =  prm_legBase.rec.Duration*(prm_legBase.rec.Principal*prm_legBase.rec.Price/1000)/365;
    if ( ДАТ(prm_legBase.rec.Maturity) > date("31.12.2020") )
     prm_legBase.rec.Cost =round(РасчётПроцентнойСтавки(prm_legBase.rec.Principal, ДАТ(prm_legBase.rec.Start),ДАТ("31.12.2019"),prm_legBase.rec.Price/100, locdeal.rec.BASIS), 2);
     prm_legBase.rec.Cost =prm_legBase.rec.Cost+round(РасчётПроцентнойСтавки(prm_legBase.rec.Principal, ДАТ("31.12.2019"),ДАТ("31.12.2020"),prm_legBase.rec.Price/100, locdeal.rec.BASIS), 2);
     prm_legBase.rec.Cost =prm_legBase.rec.Cost+round(РасчётПроцентнойСтавки(prm_legBase.rec.Principal, ДАТ("31.12.2020"),ДАТ(prm_legBase.rec.Maturity),prm_legBase.rec.Price/100, locdeal.rec.BASIS), 2);
    else
     prm_legBase.rec.Cost =round(РасчётПроцентнойСтавки(prm_legBase.rec.Principal, ДАТ(prm_legBase.rec.Start),ДАТ(prm_legBase.rec.Maturity),prm_legBase.rec.Price/100, locdeal.rec.BASIS), 2);
    end;
    ssup=prm_legBase.rec.Cost;



    /*
    //Таблица процентов
    if ( index(locdeal.rec.PPRICE,"ДА") >0 )
      prm_legBase.rec.TablePercent = "X"; 
      prm_legBase.rec.TypePercent = 1; 
      prm_legBase.rec.Caption = locdeal.rec.DINDEX;
      prm_legBase.rec.Correct = (locdeal.rec.PMPRICE)*Double(locdeal.rec.DPLAMOUNT); // add
    end;
    */

    //Базис расчета процентов
    prm_legBase.rec.Basis = locdeal.rec.BASIS; 

    /*
    if ( prm_legBase.rec.Basis == 2 )
         prm_legBase.rec.Basis = 1;
    elif ( prm_legBase.rec.Basis == 8 )
         prm_legBase.rec.Basis = 4;
    end;

    if (prm_tick.rec.partyid == 2)
      prm_legBase.rec.Basis=2;
    end;
    */

    basi=Basis_mbk(prm_tick.rec.dealtype, prm_legBase.rec.Basis);
  
    if (not prm_legBase.insert)
      RunError( "Ошибка при создании новой сделки." );
    end;
    //end;
  end;

  private macro CreatePaym(ftype, rdate, vdate, amount, fiid)
  //private macro CreatePaym(ftype, rdate, vdate, amount, fiid, pbank, pacc)
    var
        paym         = DlngPayment(),
        Purpose,
        TypeBankCode = 3,
        type         = 0,
        BankID       = -1,
        Ground       = "";

    paym.SetDocKind(prm_tick.rec.BofficeKind);
    paym.SetDocumentID(prm_tick.rec.DealID);
    paym.SetPurpose(Purpose, 0);
    paym.SetDepartment(prm_tick.rec.Department);
    paym.SetDate(vdate, rdate);
    paym.SetAmount(amount);
    paym.SetFIID(fiid);

    BankID = prm_tick.rec.PartyID;

    if (fiid==0)
       TypeBankCode = PTCK_BIC;
    else
       TypeBankCode = PTCK_SWIFT;
    end;
    /*
    if (prm_tick.rec.Netting == 3)
        paym.SetNetting("X");
    else
        paym.SetNetting("");
    end;
    */

    if (ftype == 0)
        Purpose = PM_PURP_PRINC;
        paym.SetLegID(prm_legBase.rec.LegID);
        paym.SetPurpose(Purpose, 0);
        Ground = "Предоставление средств по сделке №"+locdeal.rec.NUMBER+" от "+locdeal.rec.DATEBEG;
        paym.SetGround(Ground);

        if (IsCOMMITMENT (prm_tick.rec.DealGroup, Purpose))
            paym.SetPayer({OurBank}, TypeBankCode, {OurBank}, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
            paym.SetReceiver(prm_tick.rec.PartyID, TypeBankCode, BankID, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
        else
            paym.SetReceiver({OurBank}, TypeBankCode, {OurBank}, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
            paym.SetPayer(prm_tick.rec.PartyID, TypeBankCode, BankID, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
        end;

     elif (ftype == 1)
        Purpose = PM_PURP_PRINC_RET;
        paym.SetLegID(prm_legBase.rec.LegID);
        paym.SetPurpose(Purpose, 0);
        Ground = "Погашение основного долга по сделке №"+locdeal.rec.NUMBER+" от "+locdeal.rec.DATEBEG;
        paym.SetGround(Ground);

        if (IsCOMMITMENT (prm_tick.rec.DealGroup, Purpose))
            paym.SetPayer({OurBank}, TypeBankCode, {OurBank}, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
            paym.SetReceiver(prm_tick.rec.PartyID, TypeBankCode, BankID, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
        else
            paym.SetReceiver({OurBank}, TypeBankCode, {OurBank}, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
            paym.SetPayer(prm_tick.rec.PartyID, TypeBankCode, BankID, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
        end;

    elif (ftype == 2)
        Purpose = PM_PURP_PERCENT;
        paym.SetLegID(prm_legBase.rec.LegID);
        paym.SetPurpose(Purpose, 1);
        Ground = "Проценты по сделке №"+locdeal.rec.NUMBER+" от "+locdeal.rec.DATEBEG;
        paym.SetGround(Ground);

        if (IsCOMMITMENT (prm_tick.rec.DealGroup, Purpose))
            paym.SetPayer({OurBank}, TypeBankCode, {OurBank}, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
            paym.SetReceiver(prm_tick.rec.PartyID, TypeBankCode, BankID, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
        else
            paym.SetReceiver({OurBank}, TypeBankCode, {OurBank}, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
            paym.SetPayer(prm_tick.rec.PartyID, TypeBankCode, BankID, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
        end;

    elif (ftype == 3)
        Purpose = PM_PURP_PERCENT;
        paym.SetLegID(prm_legBase.rec.LegID);
        paym.SetPurpose(Purpose, 1);
        Ground = "Проценты по сделке №"+locdeal.rec.NUMBER+" от "+locdeal.rec.DATEBEG;
        paym.SetGround(Ground);

        if (IsCOMMITMENT (prm_tick.rec.DealGroup, Purpose))
            paym.SetReceiver({OurBank}, TypeBankCode, {OurBank}, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
            paym.SetPayer(prm_tick.rec.PartyID, TypeBankCode, BankID, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec);
        else
            paym.SetPayer({OurBank}, TypeBankCode, {OurBank}, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
            paym.SetReceiver(prm_tick.rec.PartyID, TypeBankCode, BankID, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI);
        end;

    end;

    paym.CreateNew();

  end;


  private macro CreateDeferOperation()
    ClearRecord(prm_deferOp);

    prm_deferOp.rec.id_operation   = 0; 
    prm_deferOp.rec.kind_operation = prm_tick.rec.DealType;
    prm_deferOp.rec.init_oper      = {oper};
    prm_deferOp.rec.dockind        = prm_tick.rec.bofficekind;
    //prm_deferOp.rec.start_date    = prm_legBase.rec.Start;
    prm_deferOp.rec.deferdate      = prm_legBase.rec.Start;
    prm_deferOp.rec.syst_date      = date();
    prm_deferOp.rec.syst_time      = time();
    prm_deferOp.rec.boactions      = 1;

    if (prm_tick.rec.bofficekind == DL_IBCDOC)
        prm_deferOp.rec.documentid = UniID(prm_tick, OBJTYPE_MMARKDEAL);
    end;

    if (not prm_deferOp.insert)
        RunError( "Ошибка при создании новой сделки." );
    end;
    /*
    if ( index(locdeal.rec.PPROLONG,"ДА")>0 )
       ClearRecord(prm_deferDoc);
       prm_deferDoc.rec.dockind = prm_tick.rec.bofficekind;;
       prm_deferDoc.rec.origin  = 0;
       prm_deferDoc.rec.status  = 0;
       //lkl не работает         prm_deferDoc.rec.id_step = 0;
       prm_deferDoc.rec.id_operation = GetIdOperation(prm_tick.rec.DealType, prm_legBase.rec.PFI);  //Для пролонгирующей ссылка на основную id_operation;
       prm_deferDoc.rec.documentid   = prm_deferOp.rec.documentid; // UniID(prm_tick, OBJTYPE_MMARKDEAL);
       if (not prm_deferDoc.insert)
         RunError( "Ошибка при создании новой сделки." );
       end;

    end;
    */

  end;


  //Обеспечение
  private macro CreateQLT()
    var
      qlt = Tbfile("mmdqlt.dbt", "W");

    ClearRecord(qlt);

    qlt.rec.DealID  = prm_tick.rec.DealID;
    qlt.rec.Date    = prm_tick.rec.DealDate;
    //qlt.rec.Quality = RetPOB(locdeal.rec.POB);

    if (not qlt.insert)
      RunError( "Ошибка при создании новой сделки." );
    end;	  
  end;


  //Договор залога
  private macro CreateGrnt()
    private var count, i, alist = tarray(); 
    private var grnt = Tbfile("dl_grnt.dbt", "W");

    //Договор из примечания
    ClearRecord(grnt);
    grnt.rec.DealID      = prm_tick.rec.DealID;
    /*
    grnt.rec.ContractId  = locdeal.rec.IDCONTRACT;
    grnt.rec.Amount      = Money(locdeal.rec.OBAMOUNT);

    if (not grnt.insert)
        RunError( "Ошибка при создании новой сделки." );
    end;	  

    //цикл по списку договоров
    alist = Tarray(GetNumZalog(locdeal.rec.ZCONTRACT, prm_tick.rec.partyid));

    i = 0;
    count = alist.Size;
    while (i < count)
        alist.value(i);
        if (alist.value(i) > 0) 
          ClearRecord(grnt);
          grnt.rec.DealID      = prm_tick.rec.DealID;
          grnt.rec.ContractId  = alist.value(i);
          grnt.rec.Amount      = 0.0;

          if (not grnt.insert)
              RunError( "Ошибка при создании новой сделки." );
          end;	  
        end;
        i =i + 1;
    end;
    */
  end;

  //Процентный договор
  private macro CreatePcAcc(_type)
      var 
          prm       = TPrcContractPrm,
          Contract  = 0,
          Sum       = Money(0);

      prm.BackOffice     = 2;
      prm.ObjectType     = 103;
      prm.ObjectID       = prm_tick.rec.DealCode;//String(prm_tick.rec.DealID) + " 1";     
      prm.CalcNumber     = basi;
      prm.IsUserCalc     = "";    
      prm.RateNumber     = 100;
      prm.IsUserRate     = "X";
      prm.ContractType   = _type;  
      prm.ContractNumber = 0;
      prm.Client         = prm_tick.rec.PartyID; //lkl {OurBank};        
      prm.ClientQuality  = 1;
      prm.BeginDate      = prm_legBase.rec.Start;     
      prm.EndDate        = prm_legBase.rec.Maturity;       
      prm.Oper           = {Oper};


      if (Prc_CreateContractByObject(prm, Contract))
          RunError( "Ошибка при создании новой сделки !!!" );
      elif (_type == 7)
          Prc_SetRateVal (Contract, prm_legBase.rec.Start, (prm_legBase.rec.Price / pow(10, prm_legBase.rec.Point)), false); 
          Prc_CalcPeriodOnDate (Contract, 3, prm_legBase.rec.Maturity, 1, Sum); 
      end;
  end;

  private macro CreateMMDeal()
    private var que, rs, rsp, ftype, pfiid, cbank, caccount, obank, oaccount,plusm = 0,pd=1,by,bm,bd,ey,em,ed,sql,ccost,lpd,pld=0,ced;

    CreateTick(DL_IBCDOC);
    CreateLeg();

    CreateQLT();

    CreatePcAcc(7);
    CreatePcAcc(9);
    CreatePcAcc(10);

    //paym lkl 
    pfiid = prm_legBase.rec.PFI;

    CreatePaym( 0, prm_legBase.rec.Start, prm_legBase.rec.Start, prm_legBase.rec.Principal, pfiid );
    CreatePaym( 1, prm_legBase.rec.Maturity, prm_legBase.rec.Maturity, prm_legBase.rec.Principal, pfiid );
    //создаем график платежей
    pld=0;
    if(index(strupr(locdeal.rec.period),"ЕЖЕМЕСЯЧНО")>0)//считаем что гасим один раз в месяц
      plusm = 1;
    elif(index(strupr(locdeal.rec.period),"ЕЖЕКВАРТАЛЬНО")>0)//считаем что гасим один раз в 3 месяца
      plusm = 3;
    end;
    pd = getDigStr(locdeal.rec.period);
    datesplit(prm_legBase.rec.Start,bd,bm,by);
    datesplit(prm_legBase.rec.Maturity,ed,em,ey);
    if(bd<pd)
      if(not IsWorkday(date(pd,bm,by)))
        datesplit(GetNextWorkDate(date(pd,bm,by),1),pd,bm,by);
      end;
      ccost = (date(pd,bm,by)-prm_legBase.rec.Start)*(prm_legBase.rec.Principal*prm_legBase.rec.Price/1000)/365;
      CreatePaym( 2, date(pd,bm,by),date(pd,bm,by), ccost, pfiid );
      lpd = date(pd,bm,by);
    else
      lpd = prm_legBase.rec.Start;//DateAfterWorkMonths(date(pd,bm,by),1);
    end;
    sql = "select add_months(to_date('"+pd+"."+bm+"."+by+"','dd.mm.yyyy'),rownum) ed from (Select Level From Dual Connect By Level <= (select months_between(to_date('"+ed+"."+em+"."+ey+"','dd.mm.yyyy'),to_date('"+bd+"."+bm+"."+by+"','dd.mm.yyyy'))-1 from dual))";
    sql = LnGetRecordSet(sql);
    while(sql.moveNext) 
      ced   = date(sql.value("ed"));
      if(not IsWorkday(ced))
        ced = GetNextWorkDate(ced,1)
      end;
      ccost = (ced-lpd)*(prm_legBase.rec.Principal*prm_legBase.rec.Price/1000)/365;
      CreatePaym( 2, ced,ced, ccost, pfiid );
      lpd = ced;
    end;
    sql = null;
    ccost = (date(ed,em,ey)-lpd)*(prm_legBase.rec.Principal*prm_legBase.rec.Price/1000)/365;
    CreatePaym( 2, date(ed,em,ey),date(ed,em,ey), ccost, pfiid );
    //CreatePaym( 2, prm_legBase.rec.Maturity, prm_legBase.rec.Maturity, prm_legBase.rec.Cost, pfiid );
    //paym lkl /

    CreateDeferOperation();
    /*
    if (locdeal.rec.IDCONTRACT>0)
      CreateGrnt(locdeal.rec.IDCONTRACT);
      if ( strlen(locdeal.rec.ZACCOUNT) == 20 );
        InsAccount(126, locdeal.rec.IDCONTRACT, locdeal.rec.ZACCOUNT,   147, 508, 0);     //Счет учета залога по договору обеспечения, КУ +Обесп. кр., ц/б   
      end;
    end;
    */

    return true;
  end;

  private macro CreateDealTrn()
    var retVal = true;
    retVal = CreateMMDeal();
    return retVal;
  OnError( RslErrObj )
    prm_Comment = RslErrObj.Message;
    AbortTrn();
    return false;
  end;

  macro CreateDeal()
    macro Local_CreateDealTrn()
      return CreateDealTrn();
    end;

    if(not ProcessTrn(0, "Local_CreateDealTrn"))
    //if(not Local_CreateDealTrn())
      return false;
    end;

    prm_ObjID = prm_tick.rec.DealID;
    return true;
  end;

  macro Get_ObjID()
      return prm_ObjID;
  end;

  macro Get_Comment()
      return prm_Comment;
  end;

  private macro ClassConstructor( obdeal)
      prm_SeanceID = 0; // _SeanceID;
      prm_RecordID = 0;// _RecordID;

      prm_ObjID   = -1;
      prm_Comment = "";


//msgbox(obdeal.rec.dealid);
      copy(locdeal, obdeal);
//msgbox(locdeal.rec.dealid);

      prm_tick    = Tbfile("dl_tick.dbt", "W");
      prm_legBase = Tbfile("dl_leg.dbt", "W");


      prm_deferOp  = Tbfile("oproper.dbt", "W");
      prm_deferDoc = Tbfile("oprdocs.dbt", "W");

  end;

  ClassConstructor( obdeal);
end;

///////////////////////////////////////////////////////////////////////////////////
//вызываем транзакцию импорта сделки МБК, возвращаем нужные параметры	
macro _MoneyMarketDeal_CreateNew( obdeal ):INTEGER
  var Objdeal = Ob_DealFileImport(obdeal),retVal = 0;
  retVal = Objdeal.CreateDeal(obdeal);
//  _NewID    = Objdeal.Get_ObjID();
//  _Comment = Objdeal.Get_Comment(); 
  if(retVal)
    return 1;
  else
    return 0;
  end;
end;

class ConvertFromExcel()

  macro Splt (str_,char_):tarray;
    var splitted=tarray;
    var ind=1;
    var pos=1;
    splitted[1]="";
    while(pos<=strlen(str_))
      if (substr(str_,pos,1)==char_)
        splitted[ind]=trim(splitted[ind]);
        ind=ind+1;
        splitted[ind]="";
        pos=pos+1;
      else
        splitted[ind]=splitted[ind]+substr(str_,pos,1);
        pos=pos+1;
      end;
    end;
    return splitted;
  end;

  macro RepHeader(dt, tm, oper)
    var str;

    str =     "                             ОТЧЕТ О ЗАГРУЗКЕ СДЕЛКИ МБК БР в RS-BANK V6.0\n";
    str = str+"\n";
    str = str+"Дата загрузки  : "+dt+"\n";
    str = str+"Время загрузки : "+tm+"\n";
    str = str+"Операционист   : "+oper+"\n";   
    str = str+"┌─┬────────────────────────────┬──────────────────┬──────────────────┬──────────────┬──────────────┬────────────────────────────┐\n";
    str = str+"│ │ID                          │Договор №         │                  │                                                          │\n";
    str = str+"├─┼────────────────────────────┼──────────────────┼──────────────────┼──────────────┼──────────────┼────────────────────────────┤";
    toRep1(str); 
    println(str);                                                                                                  
  end; 

  macro RepStr(_err   ,
               _code  ,
               _contr ,
               _kind  ,
               _acc   )

    var str = "│"+string(_err   :1)   +"│"+
                  string(_code  :5:l)+"│"+
                  string(_contr :5:l)+"│"+
                  string(_kind  :5:l)+"│"+
                  string(_acc   :80:l) +"│";
    println(str);
    return toRep1(str);
  end;

  macro RepFooter(suc, er, tot)                                                       
    var str = "└─┴────────────────────────────┴──────────────────┴──────────────────┴───────────────┴───────────────┴──────────────────────────────────────────────────┘\n";
    str = str+"Загружено успешно: "+suc+"\n";               
    str = str+"Не загружено     : "+er+"\n";
    str = str+"Всего            : "+tot+"\n";
   println(str);
  end;

  //----------------------------------------------------------------------------------------------------------------------------------------

  private macro ДАТ0(s);
    private var ss,d1;
    ss=trim(substr(string(s),1,10));
    if(substr(ss,3,1) != "." )
      ss="0"+ss;
    end; 
    d1=date(ss);
    return(d1);
  end;

  macro GetPartyIdByShortName(name)
    var sql,rs;
    sql = " SELECT p.t_partyid as pid "
    + " FROM dparty_dbt p "
    + " WHERE trim(p.t_shortname) = trim(:1) ";

    rs = ExecSqlSelect(sql, MakeArray(SqlParam("1", name)), false);
    if (rs.MoveNext())
      return rs.value("pid");
    else
      return null;
    end;
  end;

  //----------------------------------------------------------------------------------------------------------------------------------------

  macro CheckGenAgr(pid,ganame)
    var sql,rs;
    sql = "SELECT d.t_genagrid gid "
    + " FROM ddl_genagr_dbt d  "
    + " where d.t_partyid = :1 AND trim(d.t_code) = trim(:2) ";

    rs = ExecSqlSelect(sql, MakeArray(SqlParam("1", pid),SqlParam("2",ganame)), false);
    if (rs.MoveNext())
      return rs.value("gid");
    else
      return null;
    end;

  end;

  //----------------------------------------------------------------------------------------------------------------------------------------

  macro GetGenAgr(str)
    var g = TArray,cont;
    g = Splt(str," ");

    if(substr(trim(str),1,1)  == "№")
      if (substr(trim(str),2,1) == " ")
        cont = g[2];
      else
        cont = substr(g[1],2);
      end;
    else
      cont = g[1];
    end;
    return cont;
  end;

  //----------------------------------------------------------------------------------------------------------------------------------------
  macro GetFiidByCode(code,codekind)
    var sql,rs;
    sql = " SELECT f.t_Fiid fiid "
    + " FROM dfininstr_dbt f "
    + " WHERE f.t_codeinaccount = '"+code+"' AND f.t_fi_kind = "+ codekind;

    rs = ExecSqlSelect(sql);
    if (rs.MoveNext())
        return rs.value("fiid");
    else
        return null;
    end;
  end;


  Private macro OpenExcel()//создаем объект ms excel
    return CreateObject ("rsax", "TRsAxServer", "RsBankAxServer", isStandAlone ()).CreateComObject ("Excel.Application");
  OnError
    return NULL;
  End;

  //----------------------------------------------------------------------------------------------------------------------------------------

  Private macro OpenExcelFile ( fName )//открываем файл
    Var ex = OpenExcel ();
    if ( ex == NULL )
      MsgBox ("Ошибка открытия MS-Excel");
      return NULL;
    end;
    ex.Workbooks.Open (fName);
    return ex;
  OnError
    ex = NULL;
    MsgBox ("Ошибка открытия файла ", fName);
    return NULL;
  End;
  //----------------------------------------------------------------------------------------------------------------------------------------

  macro Main(filepath)//парсим файл
    const EndCol = 5; //количество колонок в Excel файле
    var ex,sdelim,startline,err = 0,cnt = 0,suc = 0,ArrVal,item,Line,EndLine,Col,tmpstr,locarr,zalsize,zalst,que,rs5, ii5;
    // var DealArr = TArray();
    var templnum = "РАСПОРЯЖЕНИЕ";
    var templnew = "Об учете привлеченного кредита";
    var templold = "В дополнение к распоряжению от";
    var templsum = "Сумма основного долга цифрами";
    var templval = "Валюта кредита";
    var templproc= "Процентная ставка";
    var templbas = "База начисления процентов";
    var templper = "Период уплаты процентов";
    var templrecv= "Реквизиты первичного документа";
    var templbeg = "Дата привлечения кредита";
    var templend = "Дата возврата";
    var templfin = "Порядок погашения основного долга";
    var templcom = "Особые (дополнительные) условия, примечания к операции";
    var templdep = "Подразделение/филиал";
    var templkind= "Вид сделки (характер операции)";
    var templcontr= "Заемщик";
    var templ2="1. Сообщаем, что обеспечением по привлекаемому от Банка России кредиту является"; 
    var templ3="1. Сообщаем об изменении остатка задолженности по кредитному договору, заключенному"; 

    ex = OpenExcelFile(filepath);
    if (ex == NULL)
      MsgBox("Не могу открыть файл!");
      return false;
    else
      AddField (DealArr, "FTYPE",     V_INTEGER,  4, 0);
      AddField (DealArr, "RNUMBER",   V_STRING,  30, 0);
      AddField (DealArr, "MAINNUMBER",V_STRING,  30, 0);
      AddField (DealArr, "AMOUNT",    V_STRING,  30, 0);
      AddField (DealArr, "RATE",      V_STRING,  30, 0);
      AddField (DealArr, "VAL",       V_STRING,  30, 0);
      AddField (DealArr, "PERIOD",    V_STRING,  100, 0);
      AddField (DealArr, "DATEBEG",   V_STRING,  11, 0);
      AddField (DealArr, "DATEEND",   V_STRING,  11, 0);
      AddField (DealArr, "BASIS",     V_STRING,  100, 0);
      AddField (DealArr, "RECV",      V_STRING,  500, 0);
      AddField (DealArr, "RETOD",     V_STRING,  500, 0);
      AddField (DealArr, "COMMENT",   V_STRING,  200, 0);
      AddField (DealArr, "DEPART",    V_STRING,  200, 0);
      AddField (DealArr, "KIND",      V_STRING,  200, 0);
      AddField (DealArr, "CONTR",     V_STRING,  100, 0);
      AddField (DealArr, "DATEDEAL",  V_STRING,  11, 0);
      AddField (DealArr, "NUMBER",    V_STRING,  100, 0);
      AddField (DealArr, "REST",      V_STRING,  300, 0);
    
      locdeal = TRecHandler ("deal", DealArr);
      Line    = ex.ActiveSheet.UsedRange.Row;
      EndLine = ex.ActiveSheet.UsedRange.Rows.Count;
      Col     = ex.ActiveSheet.UsedRange.Column;
      EndLine = EndLine + Line;
      startline = Line + 5;
      RepHeader (ProcDate, Proctime, {oper});    
      InitProgress (EndLine - startline, NULL, "Чтение файла");
      while (startline < EndLine)
        UseProgress (cnt = cnt+1);
        Col = ex.ActiveSheet.UsedRange.Column;
        while (Col <= EndCol)
          if (ValType(ex.Cells(startline,Col).Value) == V_UNDEF)
            ArrVal = "empty";
          else
            ArrVal = (ex.Cells(startline,Col).Value);
            if (substr(trim(ArrVal),1, strlen(templnew)) == templnew)
              locdeal.rec.FTYPE = 1;
              //msgbox(ArrVal);
            elif (substr(trim(ArrVal),1, strlen(templnum)) == templnum)
              locdeal.rec.RNUMBER = substr(ex.Cells(startline+2,Col).Value, index(ex.Cells(startline+2,Col).Value,"№")+1); 
              //msgbox(locdeal.rec.RNUMBER);
            elif (substr(trim(ArrVal),1, strlen(templold)) == templold)
              locdeal.rec.MAINNUMBER = substr(ArrVal, index(ArrVal,"№")+1);
              tmpstr                 = trim(substr(ArrVal, strlen(templold)+1,(strlen(ArrVal)-index(ArrVal,"№"))));
              locdeal.rec.datebeg    = date(int(substr(tmpstr,1,2)),int(substr(tmpstr,4,2)),int(substr(tmpstr,7)));
              //msgbox(locdeal.rec.MAINNUMBER);
              //msgbox(ex.Cells(startline+1,Col).Value);
              if (substr(trim(ex.Cells(startline+1,Col).Value ),1, strlen(templ2)) == templ2)
                locdeal.rec.FTYPE = 2;
              elif (substr(trim(ex.Cells(startline+1,Col).Value ),1, strlen(templ3)) == templ3)
                locdeal.rec.FTYPE = 3;
              else
                msgbox("Неизвестный тип!");
              end;
            end;
            if(locdeal.rec.FTYPE == 1)
              if(substr(trim(ArrVal),1, strlen(templsum)) == templsum)
                sdelim = ex.Cells(startline,Col+3).Value;  
                //sdelim = StrSubst(sdelim, ",", "");
                //sdelim = StrSubst(sdelim, ".", "");
                locdeal.rec.AMOUNT = sdelim; 
                locdeal.rec.CONTR = mCurCLnt; //ГУ БАНКА РОССИИ ПО ЦФО
                //msgbox("Сумма - "+locdeal.rec.AMOUNT);
              elif (substr(trim(ArrVal),1, strlen(templproc)) == templproc)
                // sdelim = StrSubst(ex.Cells(startline,Col+3).Value,"%","");
                sdelim = ex.Cells(startline,Col+3).Value;
                // sdelim = StrSubst(sdelim, ",", ".");
                ii5=index(string(sdelim),",");
                if ( ii5 > 0 )
                   sdelim=substr(sdelim,1,ii5-1)+"."+substr(sdelim,ii5+1);
                end;

                locdeal.rec.RATE = sdelim;
                // msgbox("Ставка - "+locdeal.rec.RATE);
              elif (substr(trim(ArrVal),1, strlen(templval)) == templval)
                locdeal.rec.VAL = ex.Cells(startline,Col+3).Value;
                if (index(ex.Cells(startline,Col+3).Value,"руб")>0 )  
                  locdeal.rec.VAL = 0;
                end;
                //msgbox(locdeal.rec.VAL);
              elif (substr(trim(ArrVal),1, strlen(templbas)) == templbas)
                //locdeal.rec.BASIS = ex.Cells(startline,Col+3).Value;
                locdeal.rec.BASIS = 4;
                // 8 msgbox(locdeal.rec.BASIS);
              elif (substr(trim(ArrVal),1, strlen(templper)) == templper)
                locdeal.rec.PERIOD = ex.Cells(startline,Col+3).Value;
                //msgbox(locdeal.rec.PERIOD);
              elif (substr(trim(ArrVal),1, strlen(templbeg)) == templbeg)
                locdeal.rec.DATEBEG = (ex.Cells(startline,Col+3).Value);
                //msgbox(locdeal.rec.DATEBEG);
              elif (substr(trim(ArrVal),1, strlen(templend)) == templend)
                locdeal.rec.DATEEND =( ex.Cells(startline,Col+3).Value);
                //msgbox(locdeal.rec.DATEEND);
              elif (substr(trim(ArrVal),1, strlen(templrecv)) == templrecv)
                locdeal.rec.RECV = ex.Cells(startline,Col+3).Value;
                //msgbox(locdeal.rec.RECV);
              elif (substr(trim(ArrVal),1, strlen(templfin)) == templfin)
                locdeal.rec.RETOD = ex.Cells(startline,Col+3).Value;
                //msgbox(locdeal.rec.RETOD);
              elif (substr(trim(ArrVal),1, strlen(templcom)) == templcom)
                locdeal.rec.COMMENT = ex.Cells(startline,Col+3).Value;
                //msgbox(locdeal.rec.COMMENT);
              elif (substr(trim(ArrVal),1, strlen(templdep)) == templdep)
                //locdeal.rec.DEPART = ex.Cells(startline,Col+3).Value;
                locdeal.rec.DEPART = {OperDprt};
                //msgbox(locdeal.rec.DEPART);
              elif (substr(trim(ArrVal),1, strlen(templkind)) == templkind)
                locdeal.rec.KIND    = ex.Cells(startline,Col+3).Value;
                //msgbox(locdeal.rec.KIND);
              end;
            elif (( locdeal.rec.FTYPE == 2 ) or ( locdeal.rec.FTYPE == 3 ));
              if (substr(trim(ArrVal),1, strlen(templcontr)) == templcontr)
                locarr  = TArray();
                zalsize = 0;
                zalst   = true;
                while(zalst)
                  locdeal.rec.CONTR    = ex.Cells(startline+zalsize+1,Col).Value; 
                  locdeal.rec.NUMBER   = ex.Cells(startline+zalsize+1,Col+1).Value;
                  locdeal.rec.DATEDEAL = ex.Cells(startline+zalsize+1,Col+2).Value;
                  locdeal.rec.REST     = ex.Cells(startline+zalsize+1,Col+3).Value;
                  locdeal.rec.VAL      = ex.Cells(startline+zalsize+1,Col+4).Value;
                  if (index(ex.Cells(startline+zalsize+1,Col+4).Value,"руб")>0 )  
                    locdeal.rec.VAL = 0;
                  end;
                  locarr[zalsize] = TRecHandler ("deal", DealArr);
                  copy(locarr[zalsize],locdeal);
                  zalsize = zalsize+1;
                  if(trim(ex.Cells(startline+zalsize+1,Col).Value)=="")
                    zalst = false;
                  end;
                end;
                //msgbox(locdeal.rec.CONTR+locdeal.rec.NUMBER+locdeal.rec.DATEDEAL+locdeal.rec.REST);
              end;
            end;
          end;
          RepStr(string(Col),
                 string(Line),
                 string(EndLine),
                 string(startline),
                 ArrVal  
                 );
          Col = Col + 1;
        end;
        DealArr.Size = 0;
        startline = startline + 1;
      end;
      RemProgress ();
      RepFooter(suc,err,cnt);
      ex.Quit();
      ex = NULL;
      //закончили парсить файл переходим к созданию нужных документов
      if(locdeal.rec.FTYPE == 1 )
        if(_MoneyMarketDeal_CreateNew( locdeal ))
          //msgbox("Ok");
          isobr = 1;
        else
          Msgbox("Ошибка создания сделки");
        end;


       que="select a.t_dealid from ddl_tick_dbt a  where a.t_dealcode ='"+ddealcode+"'"; 
       rs5 = LnGetRecordSet(que);
       if(rs5 != null)
         if (rs5.moveNext) 
            ПересчетПроцентовПоГрафику2(rs5.value(0));
         end;
      end;



      elif(( locdeal.rec.FTYPE == 2 ) or ( locdeal.rec.FTYPE == 3 ))


            nsda=СДАТ(ДАТ0(locdeal.rec.DATEBEG));
            ndealcode = "МБК-БАНК-РОССИИ-"+substr(nsda,1,2)+substr(nsda,4,2)+substr(nsda,7); 


        if(locarr.size>0)
          if(mCheckTick())//если есть сделка
            isobr   = 1;
            zalsize = 0;
            while(zalsize<locarr.size)
              copy(locdeal,locarr[zalsize]);
              parrec     = TRecHandler("dl_tick.dbt");
              mdl_leg    = TRecHandler("dl_leg.dbt");
              sdl_order  = TRecHandler("dl_order.dbt");
              sdl_secure = TRecHandler("dl_secur.dbt");
              if(mFillDl(locdeal))
                mdl_secur = Tbfile("dl_secur.dbt", "W");
                mdl_order = Tbfile("dl_order.dbt", "W");
                grnt      = Tbfile("dl_grnt.dbt", "W");
                if(not mCheckGrnt(parrec.rec.dealid))//залога нет, создаем
                //if( locdeal.rec.FTYPE == 2 )
                  mspground = Tbfile("spground.dbt", "W");
                  mdmmdqlt  = Tbfile("mmdqlt.dbt", "W");
                  if(not mCreateGrnt(locdeal))
                    // Msgbox("Ошибка создания залога, запись в распоряжении № "+zalsize);
                  end;
                else//залог есть, добавляем
                //elif( locdeal.rec.FTYPE == 3 )
                  if(not mChgGrnt())
                    Msgbox("Ошибка Добавления залога, запись в распоряжении № "+zalsize);
                  end;
                end;
              end;
              zalsize = zalsize+1;
            end;
          else
            Msgbox("Не найдена сделка для залога");
          end;
        end;
      end;
    end;
  end;

end;

//точка входа
   var CDfnMask, CDfn, DirImport,DirArch, fname, fext,ii;
   var obj = ConvertFromExcel();
   array mas;
   mas(0)="Распоряжение по сделке          ";
   mas(1)="Распоряжение по залогу в сделке ";
   ii=menu(mas,"Укажите режим обработки","Укажите режим обработки");
   if ( ii < 0 )
      exit(1);
   end;

   
    ProcTimeFile = GetTimeInString(ProcTime, ".");
      DirImport = "..\\\\Import\\BR\\";      // не используется, см.ниже 

    CDfnMask = DirImport+"*.xlsx";
/*
    if(
      SelectFile( CDfn,  CDfnMask, "Выберите исходный файл СДЕЛОК"           ) and 
      Open      ( Report1 , CDfn+"."+ProcDate+"-"+ProcTimeFile+".rep"     )  )
      isobr = 0;
    else
      msgbox("Файл не выбран!");
      return false;
    end;
     DirImport = "\\sgo-fc01-r03.go.rshbank.ru\sofr_for_etl\inbox\import\BR\";

*/
    //  DirImport = "\\\\10.4.116.84\\SOFR_UPDATES_for_PROD\\!ОБМЕН\\Diling\\BR\\";

       DirImport = "\\\\sgo-fc01-r03.go.rshbank.ru\\sofr_for_etl\\inbox\\import\\BR\\";


   if ( ii == 1 )
     CDfn=DirImport+"3.xlsx";
   else
     CDfn=DirImport+"1.xlsx";
   end;

    obj.Main(CDfn);

    if(isobr==1)
      DirArch = SplitFile(CDfn, fname, fext) + "old\\";
      MakeDir(DirArch);
    
/*
      if(CopyFile(CDfn, DirArch+fname+fext))
        RemoveFile(CDfn);
      else
        msgbox("Ошибка при перемещении файла " + CDfn + " в папку " + DirArch);
      end;
*/  

     qque="select a.t_dealid,b.t_id,a.t_dealtype from ddl_tick_dbt a, ddl_leg_dbt b where a.t_dealcode='"+ddealcode+"' and b.t_dealid=a.t_dealid ";
     rs5 = LnGetRecordSet(qque);
     if(rs5 != null)
         if (rs5.moveNext) 
            qque="update ddl_leg_dbt set t_cost="+ssup+" where t_id="+rs5.value(1);
            rs55 = LnGetRecordSet(qque);
            
             if ( rs5.value(2) == 32300 )
              dda=СДАТ(locdeal.rec.DATEBEG);
              Ins_katt(rs5.value(0),4,1);
              Ins_katt(rs5.value(0),5,2);
              Ins_katt(rs5.value(0),7,2);
             end;


         end;
     end;


  
      msgbox("Распоряжение обработано !");
    end;

    exit(1);
/*
ddl_grnt_dbt
ddl_leg_dbt      - Транш сделки
ddl_order_dbt    - Договор залога
ddl_secur_dbt    - Ц/б по договору
ddl_tick_dbt     - 
doprkoper_dbt
doproper_dbt
dprccontract_dbt - 
dmmdqlt_dbt      - признак обеспечения
dmm_grnt_dbt
dprccalc_dbt 
*/