import PTinter,RSBDataSet,dl_plib,dlgCommon,funk,dl_kvlib; 
private  var d0,pId2,rs0,cmd2,{curdate},sql0,flag,rs05,que,rs1,imesid; 
private  var col2 = TArray();
private  var v_DealId = TArray(), v_count;



     d0={curdate};
     getdate(d0,"Введите дату:",10);
     sql0="select  c.t_dealid pId2, a.t_paymstatus paymstatus,c.t_flag1 prol,  c.t_dealcodets dealcodets, decode(c.t_dealtype,12300,'П',32300,'П',12305,'Р',32305,'Р') vop, e.t_shortname nam , c.t_dealcode dealcode,";

     sql0=sql0+ " to_char(c.t_dealdate,'dd.mm.yyyy') dealdate, TO_CHAR (d.t_start, 'dd.mm.yyyy') startdate, to_char(d.t_maturity,'dd.mm.yyyy') maturity ,(case when c.t_dealtype = 32300 or  c.t_dealtype = 12300 then TO_CHAR(d.t_principal,'99,999,999,999.00') else ' ' end) su1,";
     sql0=sql0+ " (case when c.t_dealtype = 32305 or  c.t_dealtype = 12305 then TO_CHAR(d.t_principal,'99,999,999,999.00') else ' ' end) su2,";
     sql0=sql0+ " ( select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid=d.t_pfi ) fiid2 , (CASE when c.t_dealstatus = 0 then  (case when d.t_price = 0 then 'Верификация сделки'  else 'Верификация сделки' end ) else ";
     sql0=sql0+ " (case when a.t_paymstatus = 32000 then'Сделка обработана' else     (select cc.t_name  from doproper_dbt aa , doprstep_dbt bb ,doprostep_dbt cc ";
     sql0=sql0+ " where aa.t_dockind=102 and aa.t_DocumentID=lpad(c.t_dealid,34,'0') and bb.t_id_operation=aa.t_id_operation ";
     sql0=sql0+ " and t_isexecute='R' and cc.t_blockid=bb.t_blockid and cc.t_number_step=bb.t_number_step ) end)  END) sta , ";

     sql0=sql0+ " (case when (select count(*) from DL_KVI_DBT b9 where b9.t_dealid=c.t_dealid ) > 0 then 'Выполнена'  else ";
     sql0=sql0+ " (case when (select count(*) from dwldlmm_dbt a5, ddl_tick_dbt b5 where b5.t_dealid=c.t_dealid and  a5.t_dealid=b5.t_dealid ) > 0 then 'Ошибка'  else  'В ожидании ' end) ";
     sql0=sql0+ "  end) stmt,";

     sql0=sql0+ " (case when (select count(*) from  DDL_GENAGR_DBT b5 where b5.t_genagrid=c.t_genagrid  and b5.t_deposit='X') = 0 then ' '  else ";
     sql0=sql0+ " (case when c.t_userfield4 = '1' then 'X'  else  '? ' end)  end) f115,";
     sql0=sql0+ " (case when (c.t_dealtype = 32300 or  c.t_dealtype = 12300)  then  decode(a.t_paymstatus,32000,'Cквитован',0,'?',1000,'?') else  '--------------' end) vpl, '--------------' vpl2, ";



     sql0=sql0+ " (case when (c.t_dealtype = 32305 or  c.t_dealtype = 12305)  then decode(a.t_paymstatus,32000,'Исполнен',3000,'Cформирован',3010,'Проконтролирован',0,'?',1000,'?') ";
     sql0=sql0+ " else '--------------'  end) isxpl, '--------------' isxpl2  ";
     sql0=sql0+ " ,(select ga.t_outpmtmin1 from ddl_genagr_dbt ga where t_genagrid = c.t_genagrid) as t_outpmtmin1";

     sql0=sql0+ " from  ddl_tick_dbt c, ddl_leg_dbt d, dparty_dbt e , dpmpaym_dbt a where c.t_bofficekind=102 and  (c.t_dealdate='"+СДАТ(d0)+"'or d.t_start = '" + СДАТ(d0) + "') ";
     sql0=sql0+ " and  d.t_dealid=c.t_dealid and d.t_legid=1  and e.t_partyid=c.t_partyid  and a.t_dockind=102 and a.t_documentid=c.t_dealid and a.t_purpose=9 and c.t_dealtype > 5000 ";

     sql0=sql0+ "UNION  (select  c.t_dealid pId2, a.t_paymstatus paymstatus,c.t_flag1 prol,c.t_dealcodets dealcodets, decode(c.t_dealtype,12300,'П',32300,'П',12305,'Р',32305,'Р') vop,e.t_shortname nam , c.t_dealcode dealcode,";

     sql0=sql0+ " to_char(c.t_dealdate,'dd.mm.yyyy') dealdate, TO_CHAR (d.t_start, 'dd.mm.yyyy') startdate, to_char(d.t_maturity,'dd.mm.yyyy') maturity ,(case when c.t_dealtype = 32300 or  c.t_dealtype = 12300 then TO_CHAR(d.t_principal,'99,999,999,999.00') else ' ' end) su1,";
     sql0=sql0+ " (case when c.t_dealtype = 32305 or  c.t_dealtype = 12305 then TO_CHAR(d.t_principal,'99,999,999,999.00') else ' ' end) su2,";

     sql0=sql0+ " ( select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid=d.t_pfi ) fiid2 ,";

     sql0=sql0+ " (case when a.t_paymstatus = 32000 then'Сделка обработана' else  'Плановое закрытие сделки' end) sta,";

     sql0=sql0+ " (case when (select count(*) from DL_KVI_DBT b9 where b9.t_dealid=c.t_dealid ) > 0 then 'Выполнена'  else ";
     sql0=sql0+ " (case when (select count(*) from dwldlmm_dbt a5, ddl_tick_dbt b5 where b5.t_dealid=c.t_dealid and  a5.t_dealid=b5.t_dealid ) > 0 then 'Ошибка'  else  'В ожидании ' end) ";
     sql0=sql0+ "  end) stmt, ' ' f115,";

     sql0=sql0+ " (case when (c.t_dealtype = 32305 or  c.t_dealtype = 12305) and a.t_paymstatus=32000 then  'Cквитован' else '-------------- ' end) vpl,";
     sql0=sql0+ " (case when (c.t_dealtype = 32305 or  c.t_dealtype = 12305) and  (select a2.t_paymstatus from dpmpaym_dbt a2 where a2.t_dockind=102 and a2.t_documentid=c.t_dealid and a2.t_purpose=11 AND a2.t_valuedate between '" + СДАТ(d0) +" ' and '" + СДАТ(d0 + 1) +" ') = 32000 then  'Cквитован' else '--------------' end) vpl2,";   // and a2.t_subpurpose=1


     sql0=sql0+ " (case when (c.t_dealtype = 32300 or  c.t_dealtype = 12300)  then decode(a.t_paymstatus,32000,'Исполнен',3000,'Cформирован',55,'Пролонгирован',3010,'Проконтролирован',0,'?',1000,'?') ";
     sql0=sql0+ " else '--------------'  end) isxpl, ";

     sql0=sql0+ " (case when (c.t_dealtype = 32300 or  c.t_dealtype = 12300)  then ";
     sql0=sql0+ "  decode((select nvl(aa1.t_paymstatus,0) from  dpmpaym_dbt aa1 where rownum=1 and aa1.t_dockind=102 and aa1.t_DocumentID=a.t_DocumentID and aa1.t_purpose=11) ";     // and  aa1.t_subpurpose=1
     sql0=sql0+ " ,3000,'Cформирован',3010,'Выполнен контроль',32000,'Исполнен',0,'?',1000,'?' ) ";
     sql0=sql0+ " else '--------------- '  end) isxpl2";

     sql0=sql0+ " ,(select ga.t_outpmtmin1 from ddl_genagr_dbt ga where t_genagrid = c.t_genagrid) as t_outpmtmin1";

     sql0=sql0+ "  from  ddl_tick_dbt c, ddl_leg_dbt d, dparty_dbt e , dpmpaym_dbt a where c.t_bofficekind=102 ";
     sql0=sql0+ "AND ((d.t_maturity = '"+СДАТ(d0)+"') or (d.t_maturity = '"+СДАТ(d0+1)+"' and (SELECT count(1) FROM ddl_genagr_dbt ga1 WHERE ga1.t_genagrid = c.t_genagrid and  ga1.t_outpmtmin1 = chr(88)) > 0 ))";
     sql0=sql0+ " and  d.t_dealid=c.t_dealid and d.t_legid=1  and e.t_partyid=c.t_partyid  and a.t_dockind=102 and a.t_documentid=c.t_dealid and a.t_purpose=10 and c.t_dealtype > 5000  )"; // and a.t_subpurpose=0  


     sql0=sql0+ " order by dealdate desc, paymstatus, vop desc , sta ";

     //  msgbox(sql0);

      cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );


  macro EvProc2 (rs0, cmd2, id, key )
     if (cmd2 == DLG_INIT)	// Инициализация
        if (pId2 != "0")  // Надо найти запись
           v_count = 0;
           while ( (rs0.value ("pId2") != pId2) And (Not rs0.EOF) )  
		if (ValType(rs0.value ("pId2")) == 26)
			v_DealId(v_count) = 0;
		else
			v_DealId(v_count)= rs0.value ("pId2");
		end;
                rs0.Move(1, RELATIVE);
		v_count = v_count + 1;
            end;


        end;
        GoToScroll(rs0, true);
     elif (cmd2 == DLG_KEY)
        pId2=rs0.value ("pId2");
        if(DLG_KEY_ENTER == Key)
           return CM_SELECT;
        elif(DLG_KEY_F5 == Key) 
           execmacrofile("dl_kvp.mac", "Kvitovka",d0) ;
           return CM_SELECT;

        elif(DLG_KEY_F7 == Key) 

          if (MsgBoxEx("Показывать отчет?",MB_YES+MB_NO,IND_YES) == IND_YES)
            execmacrofile("dl_print.mac", "Print_115fz", rs0.value ("pId2"), false, 0) ;
          else
            execmacrofile("dl_print.mac", "Print_115fz", rs0.value ("pId2"), true, (-1)) ;
          end;
   	 que = " update ddl_tick_dbt set t_userfield4='1' where t_dealid="+rs0.value ("pId2"); 
         rs1 = LnGetRecordSet(que);

           return CM_SELECT;

        elif(DLG_KEY_F3 == Key) 
           execmacrofile("dl_iplat.mac", "iplat",rs0.value ("pId2")) ;
           return CM_SELECT;
/*
        elif(DLG_KEY_F9 == Key) 
           execmacrofile("dl_graf.mac", "prog1", rs0.value ("pId2")) ;
           return CM_SELECT;
*/
        elif(DLG_KEY_F11 == Key) 
            execmacrofile("dl_mt.mac", "Kontr320",rs0.value ("pId2")) ;
           return CM_SELECT;

        elif(DLG_KEY_F12 == Key) 
           // execmacrofile("dl_kplat.mac", "kpaym", d0) ;
           execmacrofile("dv_pmbo", "pmfissiko") ;
           return CM_SELECT;

        elif(DLG_KEY_F2 == Key) 
         que = "select l.t_mesid from  dwldlmm_dbt d, dwlmeslnk_dbt l where l.t_objkind=512 and  l.t_direct<>'X'and d.t_dlmmid=l.t_objid and d.t_dealid="+rs0.value ("pId2");
         rs05 = LnGetRecordSet(que);
         if(rs05 != null)
           if (rs05.moveNext) 
	     imesid = rs05.value(0);
      	     que = " INSERT INTO DL_KVI_DBT  ( T_DEALID, T_ID0, T_ID ) VALUES ("+rs0.value ("pId2")+","+imesid+", 0)"; 
             rs1 = LnGetRecordSet(que);
           end;
         end;
         return CM_SELECT;

        elif(DLG_KEY_F10== Key) 
           execmacrofile("dl_kvpsd.mac", "Kvitovka",d0, rs0.value ("pId2")) ;
           return CM_SELECT;

        end;

     end;
  end;





  AddCol (col2, 0, "nam","Контрагент", 16);
  AddCol (col2, 1, "dealdate","Дата сделки", 10);
  AddCol (col2, 2, "dealcode","№ сделки", 10);
  AddCol (col2, 3, "dealcodets","№ сделки(вн)", 10);
  AddCol (col2, 4, "su1","Cумма требований", 15);
  AddCol (col2, 5, "su2","Сумма обязательств", 15);
  AddCol (col2, 6, "fiid2","Вал", 3);
  AddCol (col2, 7, "f115","Ф115", 4);
  AddCol (col2, 8, "dealdate","Дата начала", 10);
  AddCol (col2, 9, "startdate","Дата размещения", 10);  //SVE
  AddCol (col2, 10, "maturity","Дата окончания", 13);
  AddCol (col2, 11, "vop","Вид", 3);
  AddCol (col2, 12, "prol","Пролонг.", 7);
  AddCol (col2, 13, "sta","Статус обработки сделки", 20);
  AddCol (col2, 14, "stmt","Статус по квитовке МТ", 20);
  AddCol (col2, 15, "vpl","Статус Входящего платежа ОД", 22);
  AddCol (col2, 16, "isxpl","Статус Исходящего платежа ОД", 24);
  AddCol (col2, 17, "vpl2","Статус Входящего платежа %%", 22);
  AddCol (col2, 18, "isxpl2","Статус Исходящего платежа %%", 24);
  AddCol (col2, 19, "t_outpmtmin1","Платёж Т-1",10);

   while(RunScroll(cmd2, 20, col2, null, @EvProc2,"Монитор обработки новых сделок МБК за "+СДАТ(d0),"F2- Принудительная квитовка F3- Закрытие  F5- Панель квитовки F7- Форма115 F10- Квитовка по сделке F11 -СПИ  F12- Контроль платежей  ESC- Выход ", null, 0, 0) )
     cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );


   end;

   exit(1);
end;


