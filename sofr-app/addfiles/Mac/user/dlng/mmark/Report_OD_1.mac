


IMPORT RsbFormsInter, RsbDataSet, BankInter, SPInter;
IMPORT "globals.mac", "or_tpl_h.mac", "dlmisc.mac";

    PRIVATE VAR repTemplName = "Reports_OD.xlt";
    PRIVATE VAR repTemplSheet =  "OD_1";
    PRIVATE VAR _count = 0;

//класс панели параметров отчета
PRIVATE CLASS(TRsbPanel) CReportPanelParm()
    PRIVATE VAR
        fld_IsDate    = NULL, // признак "Дата"
        fld_Date      = NULL, // поле "Дата"
        fld_Format    = NULL; // поле "Формат отчета"

    VAR
        repPath = "",
        repFileName = "";

    MACRO repFilePath()
        return this.repPath + this.repFileName;
    END;

    MACRO isDate()
        return fld_IsDate.Checked;
    END;
    MACRO Set_isDate(newval: bool)
        fld_IsDate.Checked = newval;
    END;
    MACRO Date()
        return fld_Date.Value;
    END;
    MACRO Set_Date(newval : date)
        fld_Date.Value = newval;
    END;
    MACRO Format()
        return fld_Format.currentChoice;
    END;
    MACRO Set_Format(newval : integer)
        fld_Format.currentChoice = newval;
    END;

    MACRO eventHandler(EV)
        if (EV.keyCode == 316)
            close(-EV.keyCode);
        elif (EV.keyCode == 323)
            close(-EV.keyCode);
/*        elif (EV.keyCode == 13)
          Getstring(fld_Format.Value);
*/
        end;
    END;

    MACRO onFormatSelected(EV)
        var repPath_cache = this.repPath;
        if (Format == 1)
            this.repPath = "";
            this.repFileName = "";
        else
                if (SelectFolder (repPath_cache, repPath_cache, "", true))
                    this.repPath = repPath_cache + "\\";
                    this.repFileName = GetExlusiveFileName("xls");
                    fld_Format.Value = this.repFileName;
                elif (strlen(this.repFileName) == 0)
                    this.Set_Format(1);
                else
                    fld_Format.Value = this.repFileName;
                end;
        end;
    END;


    PRIVATE MACRO InitDefValue()
        this.Set_isDate(true);
        this.Set_Date({curdate});
        this.Set_Format(1);
    END;

    //constructor
    InitTRsbPanel();
    caption = "Параметры отчета";
    setPosition(50, 15);
    setSize(42, 5);
    status = "~F2~ Сформировать ~F3~ Выбор ~Space~ Установить/снять признак ~Esc~ Выход";

    // инициализация полей панели
    fld_IsDate           = TRsbCheckBox();
    fld_IsDate.name      = "fld_IsDate";
    fld_IsDate.dataType  = 12; //FT_CHR
    fld_IsDate.setPosition(2, 1);
    addControl(fld_IsDate);
    
    addLabel(TRsbLabel(4, 1, "На дату:"));
    fld_Date            = TRsbEditField();
    fld_Date.name       = "fld_Date";
    fld_Date.dataType   = 9; //FT_DATE;
    fld_Date.textLength = 10;
    fld_Date.setPosition(15, 1);
    fld_Date.setSize(10, 1);
    addControl(fld_Date);

    addLabel(TRsbLabel(2, 4, "Формат отчета:"));
    fld_Format = TRsbComboBox();
    fld_Format.name       = "fld_Format";
    fld_Format.dataType   = 7; //FT_STRING
    fld_Format.textLength = 22;
    fld_Format.setPosition(17, 4);
    fld_Format.setSize (22, 1);
    fld_Format.addChoice(1, "Вывести на экран");
    fld_Format.addChoice(2, "Сохранить в xls-файл");
    fld_Format.onItemSelected(r2m(this, "onFormatSelected"));
    addControl(fld_Format);

    addEventHandler(RSB_EV_KEY_PRESSED, r2m(this, "eventHandler"));

    InitDefValue();
END;

// тело отчета
CLASS CReport()

    PRIVATE VAR
        Rep = CTemplateXLS(),
        panel = CReportPanelParm(),
        BodyLine = NULL;
        
    PRIVATE MACRO Header()
            Rep.Sheet.Range("NH0").ClearComments();
            Rep.SetValue_NameCell("NH0", panel.Date);
    END;

    PRIVATE MACRO TableLine(NA1, NA2, NA3, NA4, NA5, NA6, NA7, NA8, NA9, NA10, NA11, NA12,
                            NA13, NA14, NA15, NA16, NA17, NA18, NA19, NA20, NA21, NA22, NA23, 
                            NA24, NA25, NA26, NA27, NA28, NA29, NA30, NA31, NA32, NA33, NA34, 
                            NA35, NA36, NA37, NA38, NA39, NA40, NA41, NA42 );

           Rep.SetValue_NameCell("NA1", NA1);   Rep.SetValue_NameCell("NA2", NA2);   Rep.SetValue_NameCell("NA3", NA3);
           Rep.SetValue_NameCell("NA4", NA4);   Rep.SetValue_NameCell("NA5", NA5);   Rep.SetValue_NameCell("NA6", NA6);
           Rep.SetValue_NameCell("NA7", NA7);   Rep.SetValue_NameCell("NA8", NA8);   Rep.SetValue_NameCell("NA9", NA9);
           Rep.SetValue_NameCell("NA10", NA10); Rep.SetValue_NameCell("NA11", NA11); Rep.SetValue_NameCell("NA12", NA12);
           Rep.SetValue_NameCell("NA13", NA13); Rep.SetValue_NameCell("NA14", NA14); Rep.SetValue_NameCell("NA15", NA15);
           Rep.SetValue_NameCell("NA16", NA16); Rep.SetValue_NameCell("NA17", NA17); Rep.SetValue_NameCell("NA18", NA18);
           Rep.SetValue_NameCell("NA19", NA19); Rep.SetValue_NameCell("NA20", NA20); Rep.SetValue_NameCell("NA21", NA21);
           Rep.SetValue_NameCell("NA22", NA22); Rep.SetValue_NameCell("NA23", NA23); Rep.SetValue_NameCell("NA24", NA24);
           Rep.SetValue_NameCell("NA25", NA25); Rep.SetValue_NameCell("NA26", NA26); Rep.SetValue_NameCell("NA27", NA27);
           Rep.SetValue_NameCell("NA28", NA28); Rep.SetValue_NameCell("NA29", NA29); Rep.SetValue_NameCell("NA30", NA30);
           Rep.SetValue_NameCell("NA31", NA31); Rep.SetValue_NameCell("NA32", NA32); Rep.SetValue_NameCell("NA33", NA33);
           Rep.SetValue_NameCell("NA34", NA34); Rep.SetValue_NameCell("NA35", NA34); Rep.SetValue_NameCell("NA36", NA36);
           Rep.SetValue_NameCell("NA37", NA37); Rep.SetValue_NameCell("NA38", NA38); Rep.SetValue_NameCell("NA39", NA39);
           Rep.SetValue_NameCell("NA40", NA40); Rep.SetValue_NameCell("NA41", NA41); Rep.SetValue_NameCell("NA42", NA42);

       BodyLine.AddStr;
    END;

    PRIVATE MACRO DataTable()
        private var
        SQL = "", rs = NULL ;
SQL =       "   SELECT count(*) coun_t  from dmcaccdoc_dbt ac, dfininstr_dbt fi";
SQL = SQL + "\n  WHERE     AC.T_CATNUM = 231 ";
SQL = SQL + "\n        AND AC.T_ISCOMMON = CHR (88) ";
SQL = SQL + "\n        AND FI.T_FIID = AC.T_FIID ";
SQL = SQL + "\n        AND (   AC.T_ACCOUNT LIKE '501%' ";
SQL = SQL + "\n             OR AC.T_ACCOUNT LIKE '502%' ";
SQL = SQL + "\n             OR AC.T_ACCOUNT LIKE '503%' ";
SQL = SQL + "\n             OR AC.T_ACCOUNT LIKE '505%') ";
SQL = SQL + "\n        AND ((   fi.T_EXPIRYDATE = TO_DATE ('01,01,0001', 'dd,mm,yyyy') ";
SQL = SQL + "\n             OR fi.T_EXPIRYDATE >= TO_DATE ('"+MakeDateStr(panel.Date,",", false, false, 1)+"', 'dd,mm,yyyy'))) ";

        rs = TRsbDataSet(SQL);
        if (rs.MoveNext)  _count =int(rs.value("coun_t")); end;

        rs = NULL;
        SQL =       "  SELECT FI.T_FI_CODE as A1, ";
SQL = SQL + "\n        DP.T_NAME    as A2, ";
SQL = SQL + "\n        A.T_BALANCE  as A3, ";
SQL = SQL + "\n        AC.T_ACCOUNT as A4 , ";
SQL = SQL + "\n        FI.T_NAME    as A5, ";
SQL = SQL + "\n        AV.T_LSIN    as A6, ";
SQL = SQL + "\n        PR.T_NAME    as A7, ";
SQL = SQL + "\n        av.T_QTY     as A8, ";
SQL = SQL + "\n        (SELECT T_ISO_NUMBER ";
SQL = SQL + "\n           FROM dfininstr_dbt ";
SQL = SQL + "\n          WHERE T_FIID = FI.T_FACEVALUEFI) as A9,";
/*для получения значений с помощью макрофункций */
SQL = SQL + "\n        (rsb_account.restall (A.T_ACCOUNT, ";
SQL = SQL + "\n                              A.T_chapter, ";
SQL = SQL + "\n                              A.T_CODE_CURRENCY, ";
SQL = SQL + "\n                              TO_DATE ('"+MakeDateStr(panel.Date,",", false, false, 1)+"', 'dd,mm,yyyy')))  REST, ";
SQL = SQL + "\n                                   ";
SQL = SQL + "\n         AV.T_INCIRCULATIONDATE, ";
SQL = SQL + "\n         FI.T_FACEVALUEFI,";
SQL = SQL + "\n         FI.T_FACEVALUE,";
SQL = SQL + "\n         FI.T_FIID ";

SQL = SQL + "\n   FROM dmcaccdoc_dbt ac, ";
SQL = SQL + "\n        dfininstr_dbt fi, " ;
SQL = SQL + "\n        daccount_dbt a, "   ;
SQL = SQL + "\n        ddp_dep_dbt dp, ";
SQL = SQL + "\n        DAVOIRISS_DBT av, ";
SQL = SQL + "\n        dparty_dbt pr ";
SQL = SQL + "\n  WHERE     AC.T_CATNUM = 231 ";
SQL = SQL + "\n        AND AC.T_ISCOMMON = CHR (88) ";
SQL = SQL + "\n        AND (   AC.T_ACCOUNT LIKE '501%' ";
SQL = SQL + "\n             OR AC.T_ACCOUNT LIKE '502%' ";
SQL = SQL + "\n             OR AC.T_ACCOUNT LIKE '503%' ";
SQL = SQL + "\n             OR AC.T_ACCOUNT LIKE '505%') ";
SQL = SQL + "\n        AND A.T_ACCOUNT = Ac.T_ACCOUNT ";
SQL = SQL + "\n        AND FI.T_FIID = AC.T_FIID ";

/* остатки на счетах стенда - нулевые....
SQL = SQL + "\n        and  (rsb_account.restall (A.T_ACCOUNT, ";
SQL = SQL + "\n                                   A.T_chapter, ";
SQL = SQL + "\n                                   A.T_CODE_CURRENCY, ";
SQL = SQL + "\n                                   TO_DATE ('"+MakeDateStr(panel.Date,",", false, false, 1)+"', 'dd,mm,yyyy'))) <> 0 ";
*/
SQL = SQL + "\n        AND ((   fi.T_EXPIRYDATE = TO_DATE ('01,01,0001', 'dd,mm,yyyy') ";
SQL = SQL + "\n             OR fi.T_EXPIRYDATE >= TO_DATE ('"+MakeDateStr(panel.Date,",", false, false, 1)+"', 'dd,mm,yyyy'))) ";
 //
SQL = SQL + "\n        AND dp.t_code = A.T_BRANCH ";
SQL = SQL + "\n        AND AV.T_FIID = FI.T_FIID ";
SQL = SQL + "\n        AND PR.T_PARTYID = fi.T_ISSUER ";

SQL = SQL + "\n   ORDER BY A.T_ACCOUNT, FI.T_FI_CODE, AV.T_INCIRCULATIONDATE ";
//Println(SQL); exit;


        rs = TRsbDataSet(SQL);
        return rs;
    END;
    
    PRIVATE MACRO Body()  
 private var SumNatCur = $0.0, Sum = 0.0, FIID, Nominal =$0.0 ,_i;
         var NA1, NA2, NA3, NA4, NA5, NA6, NA7, NA8, NA9, NA10, NA11, NA12,   
             NA13, NA14, NA15, NA16, NA17, NA18, NA19, NA20, NA21, NA22, NA23,
             NA24, NA25, NA26, NA27, NA28, NA29, NA30, NA31, NA32, NA33, NA34,
             NA35, NA36, NA37, NA38, NA39, NA40, NA41, NA42;                



         var rs = DataTable();

        BodyLine = Rep.RegisterTable("NTableLine","NTableHead","A1", "A2",  "A3",  "A4",  "A5",  "A6",  "A7",  "A8",  "A9",  "A10", 
                                                               "A11","A12", "A13", "A14", "A15", "A16", "A17", "A18", "A19", "A20",
                                                               "A21","A22", "A23", "A24", "A25", "A26", "A27", "A28", "A29", "A30",
                                                               "A31","A32", "A33", "A34", "A35", "A36", "A37", "A38", "A39", "A40",
                                                               "A41","A42");
           Initprogress(_count, null ,"Расчет показателей"); _i=0;
        while (rs.MoveNext)
           useprogress(_i=_i+1);
         NA1 = rs.value("A1"); NA2 = rs.value("A2"); NA3 = rs.value("A3"); NA4 = rs.value("A4"); NA5 = rs.value("A5"); 
         NA6 = rs.value("A6"); NA7 = rs.value("A7"); NA8 = rs.value("A8"); NA9 = rs.value("A9"); 
 
                 SumNatCur = $0.0; Sum = Money(rs.value("T_FACEVALUE")); FIID =rs.value("T_FACEVALUEFI");
                ConvSum(SumNatCur, Sum, panel.Date, FIID, NATCUR);      
         NA10 = SumNatCur; 
                         
                if (FIID != NATCUR) FIID =rs.value("T_FIID"); SP_GetNominal (FIID, panel.Date, Nominal);  else  Nominal = null; end;
         NA11 = Nominal;

         //                           NA21 = rs.value("A21");  NA31 = rs.value("A31");  NA41 = rs.value("A41");
         //  NA12 = rs.value("A12");  NA22 = rs.value("A22");  NA32 = rs.value("A32");  NA42 = rs.value("A42");  
         //  NA13 = rs.value("A13");  NA23 = rs.value("A23");  NA33 = rs.value("A33");                           
         //  NA14 = rs.value("A14");  NA24 = rs.value("A24");  NA34 = rs.value("A34");                           
         //  NA15 = rs.value("A15");  NA25 = rs.value("A25");  NA35 = rs.value("A35");                           
         //  NA16 = rs.value("A16");  NA26 = rs.value("A26");  NA36 = rs.value("A36");                           
         //  NA17 = rs.value("A17");  NA27 = rs.value("A27");  NA37 = rs.value("A37");                           
         //  NA18 = rs.value("A18");  NA28 = rs.value("A28");  NA38 = rs.value("A38");                           
         //  NA19 = rs.value("A19");  NA29 = rs.value("A29");  NA39 = rs.value("A39");                           
         //  NA20 = rs.value("A20");  NA30 = rs.value("A30");  NA40 = rs.value("A40");                           


         TableLine(NA1, NA2, NA3, NA4, NA5, NA6, NA7, NA8, NA9, NA10, NA11, NA12,
                   NA13, NA14, NA15, NA16, NA17, NA18, NA19, NA20, NA21, NA22, NA23,
                   NA24, NA25, NA26, NA27, NA28, NA29, NA30, NA31, NA32, NA33, NA34,
                   NA35, NA36, NA37, NA38, NA39, NA40, NA41, NA42 );
        end;
           remprogress;
         BodyLine.EndTable();
    END;

  MACRO GenerateReport()
    var LastNameFileTmp = "";

      if (panel.run() == -316)
          Rep.OpenTemplate(repTemplName, false);
          Rep.SheetChange(repTemplSheet, TRUE);
          Rep.Sheet.Activate();

          Header();

          Body();


          if (panel.Format == 2)
              LastNameFileTmp = SetOutPut(panel.repFilePath, true);
              LastNameFileTmp = SetOutPut(LastNameFileTmp, true);
              DelFile(panel.repFilePath);
              Rep.SaveAs(panel.repFilePath, WINREP_OUTPUT_EXCEL);
          else
              Rep.SaveAsTemplate(NULL, true);
          end;
      end;
  END;

END;
/************************************************************/

var Crep = CReport(0);

Crep.GenerateReport();
exit(1);


