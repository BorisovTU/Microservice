// Библиотека процедур дилинга
import fx_globals,dl_lib,dl_plib;

array masd;

 masd(0)=103 ;
 masd(1)=104 ;
 masd(2)=105 ;
 masd(3)=106 ;
 masd(4)=107 ;

var dda;


macro Ins_kat( par10, par11,par12)
  private var T_DOCUMENTID;
  private var  que0, rs0, cmd, v_attrid;
//,{oper};

  que0="select count(*) from  dobjatcor_dbt  where t_objecttype=103 and t_object = lpad("+par10+",34,'0') and t_groupid="+par11 ;
  rs0 = LnGetRecordSet(que0);
  if(rs0 != null)
     if (rs0.moveNext) 
        v_attrid =int(rs0.value(0)); 
     end;	
  end;

  if (v_attrid == 0 )
     que0="INSERT INTO dobjatcor_dbt (T_OBJECTTYPE,T_GROUPID,T_ATTRID,T_OBJECT,T_GENERAL,T_VALIDFROMDATE,T_OPER,T_VALIDTODATE,T_SYSDATE,T_SYSTIME,T_ISAUTO,T_ID) "+
     "VALUES (103,"+par11+","+par12+",LPAD("+par10+", 34,'0'),chr(88),to_date('"+dda+"'),"+{oper}+",to_date('31129999','DDMMYYYY'),trunc(sysdate),to_date('01010001'||to_char(sysdate,'hhmiss'),'DDMMYYYYhhmiss'),chr(88),dobjatcor_dbt_SEQ.Nextval)";
     // msgbox(que0);
      rs0 = LnGetRecordSet(que0);
  else
     que0="update dobjatcor_dbt set t_attrid = "+ par12+" where  t_objecttype=103  and t_object = lpad("+par10+",34,'0') and t_groupid="+par11 ;
     rs0 = LnGetRecordSet(que0);
  end;

end;



macro Ins_akat( par10, par11,par12,par13,par14)
  private var T_DOCUMENTID;
  private var  que0, rs0, cmd, v_attrid;
//,{oper};

  dda=par14;
  que0="select count(*) from  dobjatcor_dbt  where t_objecttype=4 and t_object = '01'||to_char("+par13+",'FM0xxxxxx')||'"+par10+"' and t_groupid="+par11 ;
  rs0 = LnGetRecordSet(que0);

  if(rs0 != null)
     if (rs0.moveNext) 
        v_attrid =int(rs0.value(0)); 
     end;	
  end;


  if (v_attrid == 0 )
     que0="INSERT INTO dobjatcor_dbt (T_OBJECTTYPE,T_GROUPID,T_ATTRID,T_OBJECT,T_GENERAL,T_VALIDFROMDATE,T_OPER,T_VALIDTODATE,T_SYSDATE,T_SYSTIME,T_ISAUTO,T_ID) "+
     "VALUES (4,"+par11+","+par12+", '01'||to_char("+par13+",'FM0xxxxxx')||'"+par10+"',chr(88),to_date('"+dda+"'),"+{oper}+",to_date('31129999','DDMMYYYY'),trunc(sysdate),to_date('01010001'||to_char(sysdate,'hhmiss'),'DDMMYYYYhhmiss'),chr(88),dobjatcor_dbt_SEQ.Nextval)";
      rs0 = LnGetRecordSet(que0);

  else
     que0="update dobjatcor_dbt set t_attrid = "+ par12+" where  t_objecttype=4  and t_object = '01'||to_char("+par13+",'FM0xxxxxx')||'"+par10+"' and t_groupid="+par11 ;
     rs0 = LnGetRecordSet(que0);
  end;

end;



MACRO CHD(ndealid);
  private var ii=5,i,vari,que,rs01;

  dda=MM_tickid(ndealid,"dealdate");
  dda=SDAT(dda);
  i=0;
  while (i < ii )
    if ( masd(i) == 103  )
       if ( ( MM_tickid(ndealid,"dealtype")  == 32300 ) or ( MM_tickid(ndealid,"dealtype")  == 32305 ) )
           Ins_kat(ndealid ,masd(i),1);
       end;

    elif ( masd(i) == 107  )
           Ins_kat(ndealid ,masd(i),11);

    elif ( masd(i) == 104  )
       if ( ( MM_tickid(ndealid,"dealtype")  == 12305 ) or ( MM_tickid(ndealid,"dealtype")  == 32305 ) )
          if ( MM_tickid(ndealid,"typedoc") == "D" )
             vari=12;
          else
             vari=13;
          end;
          Ins_kat(ndealid ,masd(i),vari);

       elif (  MM_tickid(ndealid,"dealtype")  == 12335 ) 
             vari=14;
             Ins_kat(ndealid ,masd(i),vari);

       end;


    elif ( masd(i) == 105  )
       if ( ( MM_tickid(ndealid,"dealtype")  == 12300 ) or ( MM_tickid(ndealid,"dealtype")  == 32300 ) )
          if ( MM_tickid(ndealid,"typedoc") == "D" )
             vari=4;
          else
             vari=5;
          end;
           Ins_kat(ndealid ,masd(i),vari);

       elif (  MM_tickid(ndealid,"dealtype")  == 12310 ) 
            // vari=9;
       end;

    elif ( masd(i) == 106  )

       if ( ( MM_tickid(ndealid,"dealtype")  == 12300 ) or ( MM_tickid(ndealid,"dealtype")  == 32300 ) )
          if ( substr(MM_tickid(ndealid,"dealcode"),1,4) == "IAM:" )
            vari=6;
          else
            vari=8;
          end;

          if ( MM_tickid(ndealid,"partyid") == _BANK_RF )
             vari=3;
             que="select count(*) from ddl_grnt_dbt where t_dealid="+ndealid;
             rs01 = LnGetRecordSet(que);
             if(rs01 != null)
               if (rs01.moveNext) 
                  if (int(rs01.value(0)) > 0 )
                     vari=1;
                  end;	
                end;
             end;

          elif ( MM_tickid(ndealid,"partyid") == 857 )
             que="select count(*) from ddl_grnt_dbt where t_dealid="+ndealid;
             rs01 = LnGetRecordSet(que);
             if(rs01 != null)
               if (rs01.moveNext) 
                  if (int(rs01.value(0)) > 0 )
                     vari=2;
                  end;	
                end;
             end;

          end;


       elif ( ( MM_tickid(ndealid,"dealtype")  == 12305 ) or ( MM_tickid(ndealid,"dealtype")  == 32305 ) )
          if ( substr(MM_tickid(ndealid,"dealcode"),1,4) == "IAM:" )
            vari=5;
          else
            vari=7;
          end;

       elif ( ( MM_tickid(ndealid,"dealtype")  == 12310 ) or ( MM_tickid(ndealid,"dealtype")  == 12335 ) )
          vari=4;
       end;
       Ins_kat(ndealid ,masd(i),vari);

    end;
    i=i+1;
  end;

END;
