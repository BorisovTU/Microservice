
IMPORT globals,OprInter,"cb_sql.mac",funk,mmcarry,mmcnst_j,mmlibr,dl_plib,dl_lib,dl_plat,dl_platv;

 record deal (dl_tick);
 record leg (dl_leg);

MACRO ExecuteStep(Buffer, Document)
   private var deal_pd,nbank,daz,ddata,samount,nrate, SumComm,SumComm2,CurComm,plid2,ground,Debet,credit,sclient,snalog,{curdate},nnal,plid;
   var  at = MM_Carry;

    SetBuff (deal,Document);
    ddata= СДАТ({curdate});
    daz=date(ddata);

                deal_pd = MMFirstDoc(DL_IBCDOC, deal.DealID, true);

                plid2=plat_dil0(deal.dealid,"102","11",ddata,"paymentid");
                SumComm2=plat_dil0(deal.dealid,"102","11",ddata,"baseamount");

                            if ( SumComm2 > 0 )
                 nnal=" ";
                 Ground  = MM_ground(deal.Dealid,13) ;

                CurComm=plat_dil0(deal.dealid,"102","11",ddata,"fiid");
                sclient=MM_tickid(deal.dealid,"partyid");
                snalog=MM_nalog(sclient);
               if (snalog > 0 )
                 SumComm=(SumComm2*snalog/100);
                 SumComm2=SumComm2-(SumComm2*snalog/100);
                 Debet=ПРИКРЕПИТЬ2("+% к погашению",deal.dealid);
                 nnal= ", налог "+string(snalog)+" %";

                 if(not deal_pd.OpenAccount("СЧЕТ_60323", credit, NULL, deal_pd.GetFIRoleByCategory("СЧЕТ_60323", 0), NULL, daz, 0))

                 end;    

                            if ( CurComm > 0 )
                 if (0 != Получить_Курс0(nrate, CurComm, daz))
                     Msgbox("Не возможно получить курс за ", {curdate});
                     return 1;
                 end;
                            else
                                nrate=1;
                            end;
                 samount= money(SumComm*nrate);

        	 at.AccountPayer    = credit;	  
        	 at.AccountReceiver = debet;
        	 at.FIIDPayer      = 0;
        	 at.FIIDReceiver   = CurComm;
        	 at.SumPayer       = samount;
        	 at.SumReceiver    = SumComm;

        	 at.Chapter        = 1;
        	 at.Ground         = ground;
        	 at.PaymentID      = plid2;
        	 if(not at.carry())
           		msgbox("Error !");
           		return false;
        	 end;
               end;

                Debet=ПРИКРЕПИТЬ2("+% к погашению",deal.dealid);
       	        credit=account_corr(CurComm,nbank);
                if (strlen(credit) == 1) 
                  credit=plat_dil0(deal.dealid,"102","11",ddata,"futurepayeraccount");
                elif (credit == "0") 
                  credit=plat_dil0(deal.dealid,"102","11",ddata,"futurepayeraccount");
                end;

                if (strlen(credit)  < 2 ) 
                  credit=plat_dil0(deal.dealid,"102","11",ddata,"futurereceiveraccount");
                end;

        	at.AccountPayer    = credit;	  
        	at.AccountReceiver = debet;
        	at.FIIDPayer      = CurComm;
        	at.FIIDReceiver   = CurComm;
        	at.SumPayer       = SumComm2;
        	at.SumReceiver    = SumComm2;

        	at.Chapter        = 1;
        	at.Ground         = ground;
        	at.PaymentID      = plid2;
        	if(not at.carry())
           		msgbox("Error !");
           		return false;
        	end;

                if(not InsertPaymentStat (plid2, PM_FINISHED))
                   MsgBox("Ошибка установки статуса платежа - Закрыт.");
                end;

                            end;

                plid=plat_dil0(deal.dealid,"102","10",ddata,"paymentid");
                SumComm=plat_dil0(deal.dealid,"102","10",ddata,"baseamount");

                          if ( SumComm >  0 )
                if (deal.dealtype == 12335)
                  Debet=ПРИКРЕПИТЬ2("ОДТФ",deal.dealid);
                else
                  Debet=ПРИКРЕПИТЬ2("ОД",deal.dealid);
                end;
       	        credit=account_corr(CurComm,nbank);
                if (strlen(credit) == 1) 
                  credit=plat_dil0(deal.dealid,"102","10",ddata,"futurepayeraccount");
                elif (credit == "0") 
                  credit=plat_dil0(deal.dealid,"102","10",ddata,"futurepayeraccount");
                end;

                if (strlen(credit)  < 2 ) 
                  credit=plat_dil0(deal.dealid,"102","10",ddata,"futurereceiveraccount");
                end;


                 Ground  = MM_ground(deal.Dealid,10) ;



        	at.AccountPayer    = credit;	  
        	at.AccountReceiver = debet;
        	at.FIIDPayer      = CurComm;
        	at.FIIDReceiver   = CurComm;
        	at.SumPayer       = SumComm;
        	at.SumReceiver    = SumComm;

        	at.Chapter        = 1;
        	at.Ground         = ground;
        	at.PaymentID      = plid;
        	if(not at.carry())
           		msgbox("Error !");
           		return false;
        	end;

                if(not InsertPaymentStat (plid, PM_FINISHED))
                   MsgBox("Ошибка установки статуса платежа - Закрыт.");
                end;

                           end;


   return 0;
END;



