/*
$Name: dl_mm520.mac
$Module: МБК
$Description: Шаг досрочного погашения
*/
IMPORT funk, mmlibr, dl_note_lib, dl_lib, dl_epaym, mmlb_j;
RECORD tick(dl_tick);
private var DateClose, SummaProc,amount=0 ;

private macro GetLegParam(_Tick)
private var deal_pd, v_categ, PFI,price, basis,ssu,day2,da0,TSummaProc=0;
    FILE leg (dl_leg); 
    leg.LegKind = LEG_KIND_DL_TICK;
    leg.DealID = _Tick.DealID;
    leg.LegID = 1;

    if (not GetEq(leg))
        mm_error ("Не найден транш сделки");
        return (-1);
    else

        if (tick.DealType == 12300)
            v_categ  = "-% к погашению";
        else
            v_categ  = "+% к погашению";
        end;

        PFI = Leg.PFI;
        DateClose = Leg.MATURITY;
        deal_pd = MMFirstDoc(DL_IBCDOC, tick.DealID, true);

        // sta=plat_zak(deal.dealid,"102","11",1,"paymstatus");


        ПолучитьОстатокСчета(deal_pd, v_categ, null, null, SummaProc, {curdate}, PFI);


           da0=СДАТ({curdate});
           da0=ДАТ("01"+substr(da0,3));
           day2=da0-1;

           da0=DAT(MM_leg(tick.DealID,"start",1));
           if ( da0 > day2)
             day2=da0;
           end;
           price= Новая_проц_ставка(tick.DealID,{curdate});
           ssu=MM_leg(tick.DealID,"principal",1);
           basis=MM_leg(tick.DealID,"basis",1);

           TSummaProc=round(РасчётПроцентнойСтавки(ssu, day2, {curdate},price, basis), 2);
           SummaProc=SummaProc+TSummaProc;
           amount=Leg.COST;

//        SummaProc = Leg.COST;

    end;

end;


MACRO ExecuteStep(Buffer, Document)
    SetBuff( tick, Document );

    if (GetLegParam(tick) == (-1) )
	return 1;
    end;
    private var epaym;

     epaym = CPanelEpaym(tick.dealid, true, DateClose, amount, SummaProc );
    if ( epaym.Run() );
	 return 0;
    else
	 return 1;
    end;
end;


MACRO PrintStepDocs (
                ID_Operation,  /* Номер экземпляра операции */
                ID_Step,       /* Номер шага операции */
                Kind_Operation,/* Вид операции */
                KindStep)      /* Вид шага операции */
    var oproper = TBfile("oproper.dbt"),
    dl_tick = TBfile("dl_tick.dbt") ;
    
    oproper.rec.ID_Operation = ID_Operation;
    
    if (not oproper.GetEq )
      mm_error( "Не найдена сделка ", ID_Operation );
      return 1;
    end;  

    ClearRecord( tick );
    
    if( (not RestoreFromUniID(oproper.rec.DocumentID, dl_tick, OBJTYPE_MMARKDEAL,oproper.rec.DocKind)) OR       
          (not GetEQ(dl_tick)) )    
      mm_error( "Не найдена сделка ");
      return 1;
    end;    

    Copy (tick, dl_tick);

    if (GetLegParam(tick) == (-1) )
	return 1;
    end;
    var SummaProcP = getNoteDifValue( tick.DealId , 104);
    if (ValType(SummaProcP) == V_UNDEF) 
	SummaProcP = 0.0;
    end;

    private var epaym = CPanelEpaym(tick.dealid, false, DateClose, SummaProc, SummaProcP );               
    epaym.Run();
    exit(1);

END;



/* Макрос постобработки */
MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

    private var v_money;
    SetBuff( tick, FirstDoc );
      
    //if (errTrn OR (CommitOrRollback==2))  /*SVE 528441 15.07.2021 при отмене вставки шага никакие данные не будут обновлены, поэтому нет необходимости обновлять платеж при ошибках*/
    if (CommitOrRollback == 2)
          if (GetLegParam(tick) == (-1) )
          	return 1;
          end;

	  DelNoteByKind(tick.DealId, 103);
	  DelNoteByKind(tick.DealId, 104);
//	   SetNoteDifValue(tick.DealId, 103, DateClose);
//	   SetNoteDifValue(tick.DealId, 104, SummaProc);
           SummaProc=MM_leg(tick.DealID,"cost",1);

          //PaymMainDateUpd(tick.DealId, DateClose);
          PaymProcUpd(tick.DealId, SummaProc, DateClose);

         return 1;
    end;

    return 1;
end;


// -------------
