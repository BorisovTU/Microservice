import PTinter,RSBDataSet,dl_plib,dlgCommon,funk; 
private  var flag,imes,rs05,que; 



macro mt(mdeaid,mid);

private  var cmd5,sss,sd0,ss0,sql0,soob=" ", cmd2,im,rs5,pole,sidk,zag,sdiller,rs092;
private  var col5=TArray();



//     sql0="select cc.t_name pole ,bb.t_value mtbank, cc.t_name,cc.t_name,bb2.t_value mtkontr, bb.t_index,bb2.t_mesid,bb.t_fieldid,aa.t_mesid imesid, ";
     sql0="select cc.t_name pole ,bb.t_value mtbank, cc.t_name,cc.t_name, bb.t_index,bb.t_fieldid,aa.t_mesid imesid, ";

     sql0=sql0+" (select 'X'  from dwlmes_dbt aa2,dwlmesval_dbt  bb2, dwltpfld_dbt cc2 where  aa2.t_mesid="+mid+" and bb2.t_mesid=aa2.t_mesid ";
     sql0=sql0+"  and cc2.t_tpfieldid=bb2.t_tpfieldid and bb2.t_value=bb.t_value   and bb2.t_fieldid=bb.t_fieldid )  srav,";

     sql0=sql0+" (select cc2.t_name  from dwlmes_dbt aa2,dwlmesval_dbt  bb2, dwltpfld_dbt cc2 where  aa2.t_mesid="+mid+" and bb2.t_mesid=aa2.t_mesid ";
     sql0=sql0+" and cc2.t_tpfieldid=bb2.t_tpfieldid "; 
     sql0=sql0+"  and  ((bb2.t_fieldid = bb.t_fieldid)  or (( bb.t_fieldid = 1748 ) and  bb2.t_fieldid=1747) or (( bb.t_fieldid = 1770 ) and  bb2.t_fieldid=1769) or (( bb.t_fieldid = 1792 ) and  bb2.t_fieldid=1791)  ";
     sql0=sql0+" or (( bb.t_fieldid = 1777 ) and  bb2.t_fieldid=1799 ) or (( bb.t_fieldid = 1792 ) and  bb2.t_fieldid=1814 ) ) ";
     sql0=sql0+" ) pole2, ";

// and  bb2.t_fieldid=bb.t_fieldid ) pole2,";

      sql0=sql0+" (select bb2.t_value  from dwlmes_dbt aa2,dwlmesval_dbt  bb2, dwltpfld_dbt cc2  where  aa2.t_mesid="+mid+" and bb2.t_mesid=aa2.t_mesid ";
     sql0=sql0+" and cc2.t_tpfieldid=bb2.t_tpfieldid ";
     sql0=sql0+"  and  ((bb2.t_fieldid = bb.t_fieldid)  or (( bb.t_fieldid = 1748 ) and  bb2.t_fieldid=1747) or (( bb.t_fieldid = 1770 ) and  bb2.t_fieldid=1769) or (( bb.t_fieldid = 1792 ) and  bb2.t_fieldid=1791)  ";
     sql0=sql0+" or (( bb.t_fieldid = 1777 ) and  bb2.t_fieldid=1799 ) or (( bb.t_fieldid = 1792 ) and  bb2.t_fieldid=1814 ) ) ";

     sql0=sql0+" ) mtkontr ";

//  and bb2.t_fieldid=bb.t_fieldid   ) mtkontr ";

     sql0=sql0+"from  dwlmes_dbt aa,  dwlmesval_dbt  bb  , dwltpfld_dbt cc , dwlmeslnk_dbt b, dwldlmm_dbt a ";
     sql0=sql0+" where b.t_objkind=512 and b.t_objid=a.t_dlmmid and a.t_dealid="+mdeaid+" and aa.t_mesid=b.t_mesid and  bb.t_mesid=aa.t_mesid and a.t_direct != 'X' ";

//     sql0=sql0+" and aa2.t_mesid="+mid+" and  bb2.t_mesid=aa2.t_mesid  and bb2.t_tpfieldid=cc.t_tpfieldid and bb2.t_fieldid=bb.t_fieldid ";
  
     sql0=sql0+" and cc.t_tpfieldid=bb.t_tpfieldid  and (cc.t_name='20' or  cc.t_name='22A' or cc.t_name='22B'  or cc.t_name='22C' or cc.t_name='82A' or cc.t_name='87A' or  cc.t_name='32A' or cc.t_name='34A' or ";
     sql0=sql0+" cc.t_name='15B' or cc.t_name='17R' or cc.t_name='30T' or cc.t_name='30V' or cc.t_name='30P' or cc.t_name='32B' or cc.t_name='30X' or cc.t_name='34E' or cc.t_name='37G' or ";
     sql0=sql0+" cc.t_name='57A' or  cc.t_name='15D' or cc.t_name='32H' or cc.t_name='15C' or cc.t_name='57D' or cc.t_name='56D' or cc.t_name='15E' or cc.t_name='15F' ) and cc.t_tpid=2 order by bb.t_index ";
     //  msgbox(sql0);
     cmd5 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );

  macro EvProc20 (rs09, cmd5, id, key )
   private var rs122,nnn,ss1,ss2,u1,u2,que,rs12,jk,ik;     
     if (cmd5 == DLG_INIT)	// Инициализация

        rs09.MoveFirst();          
        if (pole != "0")  // Надо найти запись
           while ( (rs09.value ("pole") != pole) And (Not rs09.EOF) )  
              rs09.Move(1, RELATIVE);
            end;
        end;
        GoToScroll(rs09, true);
     elif (cmd5 == DLG_KEY)
        if(DLG_KEY_ENTER == Key)  
          flag=1;
          imes=rs09.value ("imesid") ;
          return CM_CANCEL;
        end;
     end;
  end;

  AddCol (col5, 0, "pole","Поле", 5);
  AddCol (col5, 1, "mtbank"," Исходящее МТ ",50);
  AddCol (col5, 2, "srav","Сравн.",5);
  AddCol (col5, 3, "pole2","Поле", 5);
  AddCol (col5, 4, "mtkontr","Входящее МТ",50);


    sss="ENTER- Квитовка             ESC- Выход без квитовки " ;
    while(RunScroll(cmd5, 5, col5, null, @EvProc20," Квитовка swift mt320","ENTER- Квитовка             ESC- Выход без квитовки ", null, 1, 11,150,45) )
     cmd5 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );
 
    end;

end;




macro mes_reading(dealid)
    private var que,rs01,kvdat,kvcontr,mesid,dlmmid,nn;

    kvdat=СДАТ(zsdell(dealid,"dealdate"));
    kvdat=substr(kvdat,7)+substr(kvdat,4,2)+substr(kvdat,1,2);
    kvcontr=zsdell(dealid,"partyid");
    kvcontr=ПолучитьКодСубъекта(kvcontr,6);
    que="select bb.t_mesid,a.t_dlmmid  from  dwlmes_dbt aa , dwlmesval_dbt  bb, dwltpfld_dbt cc , dwlmeslnk_dbt b, dwldlmm_dbt a ";
    que=que+ " where  bb.t_mesid=aa.t_mesid and aa.t_agentcode='"+kvcontr+"' and  aa.t_direct='X'  and aa.t_tpschemid=51 ";
    que=que+ " and cc.t_tpfieldid=bb.t_tpfieldid and cc.t_name='30T' and bb.t_value='"+kvdat+"' and b.t_mesid=aa.t_mesid and b.t_objkind=512  and b.t_objid=a.t_dlmmid and a.t_dealid="+dealid+" order by bb.t_mesid";
    rs01 = LnGetRecordset(que);
    if(rs01 != null)
       while(rs01.moveNext)
         mesid=rs01.value(0);
         dlmmid=rs01.value(1);
         mt(dealid,mesid);
       end;
    end;

end;

//LKL
macro IsExistKvit(dealid)
private var quef, rsf, nn;

           quef="select count(*) from DL_KVI_DBT ee where t_dealid="+dealid; 
           rsf = LnGetRecordset(quef);
           if(rsf != null)
              while(rsf.moveNext)
                nn=int(rsf.value(0));
              end;
           end;
           if (nn>0 )
	      return True;
	   end;
	   return False;
end;

macro finish_kvit(dealid, imes, mesid, dlmmid)
private var quef, rsf, nn;
           // Привязка к сделке
           quef="UPDATE dwldlmm_dbt SET T_dealid ="+ dealid+" WHERE T_DLMMID="+DLMMID; 
           rsf = LnGetRecordset(quef);

           // Файл квитовки
           if ( IsExistKvit(dealid) )
             quef="UPDATE DL_KVI_DBT SET T_id ="+mesid+" WHERE T_Dealid="+dealid; 
           else
             quef="INSERT INTO DL_KVI_DBT Values("+dealid+","+imes+","+mesid+")";     
           end;
           rsf = LnGetRecordset(quef);

end;


macro AutoKvit(dealid)
    private var que,rs01, rs02, kvdat, kvcontr ,mesid, dlmmid, nn, forma, sfiid,count, imes_;
    private var sv_bank  = TArray;                                 
    private var sv_contr = TArray; 
    return;

    kvdat=СДАТ(zsdell(dealid,"dealdate"));
    kvdat=substr(kvdat,7)+substr(kvdat,4,2)+substr(kvdat,1,2);
    kvcontr=zsdell(dealid,"partyid");
    sfiid=zsdelp(dealid,"pfi");
    kvcontr=ПолучитьКодСубъекта(kvcontr,6);

    // Форма сообщения
    que="select aa.t_rlsformid from  dwlmes_dbt aa   , dwlmeslnk_dbt b, dwldlmm_dbt a ";
    que=que+" where b.t_objkind=512 and b.t_objid=a.t_dlmmid and a.t_dealid="+dealid+" and aa.t_mesid=b.t_mesid  and a.t_direct != 'X' ";
    rs01 = LnGetRecordSet(que);
    if(rs01 != null)
      if (rs01.moveNext) 
         forma=rs01.value(0);
      end;
    end;
    // Все входящие сообщения контрагента на дату
    que="select bb.t_mesid,a.t_dlmmid  from  dwlmes_dbt aa , dwlmesval_dbt  bb, dwltpfld_dbt cc , dwlmeslnk_dbt b, dwldlmm_dbt a ";
    que=que+ " where  bb.t_mesid=aa.t_mesid and aa.t_agentcode='"+kvcontr+"' and  aa.t_direct='X'  and aa.t_tpschemid=51 and aa.t_rlsformid="+forma;
    que=que+ " and cc.t_tpfieldid=bb.t_tpfieldid and cc.t_name='30T' and bb.t_value='"+kvdat+"' and b.t_mesid=aa.t_mesid and b.t_objkind=512  and b.t_objid=a.t_dlmmid and a.t_dealid=0 order by bb.t_mesid";
    // msgbox(que);
    rs01 = LnGetRecordset(que);
    if(rs01 != null)
      while(rs01.moveNext)
         flag=0;
         mesid=rs01.value(0);
         dlmmid=rs01.value(1);

         que = "select aa.t_mesid mesid, trim(bb.t_value) mtbank, trim(bb2.t_value) mtkontr, cc.t_name pole from  dwlmes_dbt aa,  dwlmesval_dbt  bb  , dwltpfld_dbt cc , dwlmes_dbt aa2,  dwlmesval_dbt  bb2 , dwlmeslnk_dbt b, dwldlmm_dbt a";
         que=que+" where b.t_objkind=512 and b.t_objid=a.t_dlmmid and a.t_dealid="+ string(dealid) +" and aa.t_mesid=b.t_mesid and  bb.t_mesid=aa.t_mesid and a.t_direct != 'X' "; 
         que=que+" and aa2.t_mesid="+ string(mesid) +" and  bb2.t_mesid=aa2.t_mesid  and bb2.t_tpfieldid=cc.t_tpfieldid and bb2.t_fieldid=bb.t_fieldid ";   
         que=que+" and cc.t_tpfieldid=bb.t_tpfieldid  and ( cc.t_name='22A' or cc.t_name='22B'  or cc.t_name='22C' or cc.t_name='82A' or cc.t_name='87A' or  cc.t_name='32A' or cc.t_name='34A' or "; 
         que=que+" cc.t_name='15B' or cc.t_name='17R' or cc.t_name='30T' or cc.t_name='30V' or cc.t_name='30P' or cc.t_name='32B' or cc.t_name='30X' or cc.t_name='34E' or cc.t_name='37G' or ";
         que=que+" cc.t_name='57A' or  cc.t_name='15D' or cc.t_name='15C' ) and cc.t_tpid=2  and bb2.t_value<>bb.t_value order by pole";

         //  msgbox(que);

        rs02 = LnGetRecordset(que);
        count = 0;
        if(rs02 != null)
            while( rs02.moveNext )
              sv_bank(count)  = rs02.value(1);
              sv_contr(count) = rs02.value(2);
              imes_ = rs02.value(0);
              count = count+1;
               // if (count > 4) break; end;

            end;

        end;
             if (count > 4) return;end;  
         end; 

       // if ((sv_bank(0) == sv_contr(1)) and (sv_bank(1) == sv_contr(0)) and (sv_bank(2) == sv_contr(3)) and (sv_bank(3) == sv_contr(2))) 
       if ((sv_bank(2) == sv_contr(3)) and (sv_bank(3) == sv_contr(2))) 

              finish_kvit(dealid, imes_, mesid, dlmmid);

       end;

       return;

    end;

end;
//~LKL

macro HandKvit(dealid)
    private var que,rs01,kvdat,kvcontr,mesid,dlmmid,nn,forma;
    kvdat=СДАТ(zsdell(dealid,"dealdate"));
    kvdat=substr(kvdat,7)+substr(kvdat,4,2)+substr(kvdat,1,2);
    kvcontr=zsdell(dealid,"partyid");
    kvcontr=ПолучитьКодСубъекта(kvcontr,6);

    // Форма сообщения

    que="select aa.t_rlsformid from  dwlmes_dbt aa   , dwlmeslnk_dbt b, dwldlmm_dbt a ";
    que=que+" where rownum=1 and b.t_objkind=512 and b.t_objid=a.t_dlmmid and a.t_dealid="+dealid+" and aa.t_mesid=b.t_mesid  and a.t_direct != 'X' ";
    rs01 = LnGetRecordSet(que);

    if(rs01 != null)
      if (rs01.moveNext) 
         forma=rs01.value(0);
      end;
    end;
    // Все входящие сообщения контрагента на дату
    que="select bb.t_mesid,a.t_dlmmid  from  dwlmes_dbt aa , dwlmesval_dbt  bb, dwltpfld_dbt cc , dwlmeslnk_dbt b, dwldlmm_dbt a ";
    que=que+ " where  bb.t_mesid=aa.t_mesid and aa.t_agentcode='"+kvcontr+"' and  aa.t_direct='X'  and aa.t_tpschemid=51 and aa.t_rlsformid="+forma;
    que=que+ " and cc.t_tpfieldid=bb.t_tpfieldid and cc.t_name='30T' and bb.t_value='"+kvdat+"' and b.t_mesid=aa.t_mesid and b.t_objkind=512  and b.t_objid=a.t_dlmmid and a.t_dealid=0 order by bb.t_mesid";
    rs01 = LnGetRecordset(que);
    if(rs01 != null)
       flag=(-2);
       while(rs01.moveNext)
         flag=0;
         mesid=rs01.value(0);
         dlmmid=rs01.value(1);
         mt(dealid,mesid);
         if (flag == 1)

           finish_kvit(dealid, imes, mesid, dlmmid);
//           msgbox("Квитовка сообщения выполнена!");
           return;
         end;
       end;
       if (flag==(-2))
	  msgbox("Входящее МТ отсутствует!");
       end;
    end;

end;

