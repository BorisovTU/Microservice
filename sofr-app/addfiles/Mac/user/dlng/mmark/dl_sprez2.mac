import fx_globals,InsCarryDoc, CurrInter, Проценты, MmarkInter, mmlibr, mmcarry, mmcnst_j, mmplib, dl_lib ,"calculate.mac";

PRIVATE FILE leg (dl_leg);
// PRIVATE FILE pm ("pmpaym") key 1 write;
PRIVATE RECORD tick (dl_tick);


/*----------------------------------------------------------------------------
    Выполнение шага
----------------------------------------------------------------------------*/
MACRO ES(Document)
    var deal_pd ,acc0, acc2, acc0p, s_addground, nrate, vsum, vsum2,sground;
    var  at  = MM_Carry;
    var  atp = MM_Carry;

    SetBuff (tick,Document);
    leg.LegKind = LEG_KIND_DL_TICK;
    leg.DealID = tick.DealID;
    leg.LegID = 1;

    if (not GetEq(leg))
        mm_error ("Не найден транш сделки");
        return 1;
    end;


    deal_pd = MMFirstDoc(DL_IBCDOC, tick.DealID, true);
    s_addground = GetGroundAddPart(tick);
    sground="Восстановление оценочного резерва ОД по "+tick.dealcode+"/"+nami(tick.partyid);

            if (tick.dealtype == 12305 )


                if ( tick.partyid == _BANK_RF )


     if(not deal_pd.FindNumberAccount("+КОР_Резерв, ОД3", acc0, NULL, deal_pd.GetFIRoleByCategory("+КОР_Резерв, ОД3", 0), NULL, {curdate}, 0))
        return 1;
     end;    

    if(not deal_pd.FindNumberAccount("+РС, кредиты%000", acc2, NULL, deal_pd.GetFIRoleByCategory("+РС, кредиты%000", 0), NULL, {curdate}, 0))
        return 1;
     end;    
                else

     if(not deal_pd.FindNumberAccount("+РС, кредиты%00", acc2, NULL, deal_pd.GetFIRoleByCategory("+РС, кредиты%0", 0), NULL, {curdate}, 0))
        return 1;
     end;    
     acc0 =MM_acc(tick.dealid,711);

                end;

            else
     if(not deal_pd.FindNumberAccount("+КОР_Резерв, ОД2", acc0, NULL, deal_pd.GetFIRoleByCategory("+КОР_Резерв, %0", 0), NULL, {curdate}, 0))
        return 1;
     end;    

     if(not deal_pd.FindNumberAccount("+РС, кредиты%0", acc2, NULL, deal_pd.GetFIRoleByCategory("+РС, кредиты%0", 0), NULL, {curdate}, 0))
        return 1;
     end;    
            end;

     vsum=RestA_(acc0,{curdate}, 1,0);

     if ( abs(vsum) > 0 )

          at.date_carry       = {curdate};
          at.AccountPayer    = acc0;	  
          at.AccountReceiver = acc2;
          at.FIIDPayer       = 0;
          at.FIIDReceiver    = 0;
          at.SumReceiver     = vsum;
          at.Chapter         = 1;
          at.Ground          = sground;
          if(not at.carry())
             msgbox("Error !");
             return false;
          end;
     end;

            if (tick.dealtype == 12305 )

                if ( tick.partyid == _BANK_RF )


    if(not deal_pd.FindNumberAccount("+РС, кредиты%000", acc2, NULL, deal_pd.GetFIRoleByCategory("+РС, кредиты%000", 0), NULL, {curdate}, 0))
        return 1;
     end;    



                else
     if(not deal_pd.FindNumberAccount("+РС, кредиты%00", acc2, NULL, deal_pd.GetFIRoleByCategory("+РС, кредиты%0", 0), NULL, {curdate}, 0))
        // return 1;
     end;    
                end;
     acc0 =MM_acc(tick.dealid,717);

            else
     if(not deal_pd.FindNumberAccount("+КОР_Резерв, %0", acc0, NULL, deal_pd.GetFIRoleByCategory("+КОР_Резерв, %0", 0), NULL, {curdate}, 0))
        // return 1;
     end;    

     if(not deal_pd.FindNumberAccount("+РС, кредиты%0", acc2, NULL, deal_pd.GetFIRoleByCategory("+РС, кредиты%0", 0), NULL, {curdate}, 0))
        // return 1;
     end;    
            end;
     sground="Восстановление оценочного резерва %% по "+tick.dealcode+"/"+nami(tick.partyid);
     vsum2=RestA_(acc0,{curdate}, 1,0);

     if ( abs(vsum2) > 0 )
          at.date_carry       = {curdate};
          at.AccountPayer    = acc0;	  
          at.AccountReceiver = acc2;
          at.FIIDPayer       = 0;
          at.FIIDReceiver    = 0;
          at.SumReceiver     = vsum2;
          at.SumPayer        = vsum2;

          at.Chapter         = 1;
          at.Ground          = sground;
          if(not at.carry())
             msgbox("Error !");
             return false;
          end;
     end;

    return 0;
END;
