import RSBDataSet,dlgCommon,funk,Календарь,PTInter,fx_globals,dl_lib;
private  var ac1,ac2,flag0,kkod,is,que1,que0,que,sid,rez,pzag,imp0,nnfiid,flag,datra,nmt,d0,sss,sd0,ss0,sql0,ik2,soob=" ",len1,len2, cmd2,im,rs5,pId2,sidk,zag,sdiller,rs02,datransh;
private  var col2=TArray();
private array masm;
var ncontr,npayer,nreceiver;

masm(0)="Ручной ввод     ";
masm(1)="Выбор из списка ";


MACRO Swift_acc(par1,par2)

  private var que,rs5,rez=0;
  que="select a.t_coraccount from dcorschem_dbt a where a.t_fiid="+par1+" and a.t_corrid= (select b.t_objectid from dobjcode_dbt b where b.t_codekind=6 and b.t_code='"+par2+"')";
  // msgbox(que);
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=rs5.value(0);
     end;
  end;
  return rez;
END;

macro sswift(s)

    private var ss1,rs1,que,ss;
    ss=string(s);
    ss1=0;
    que = "select a.t_objectid from  dobjcode_dbt a  where a.t_objecttype=3 and (a.t_codekind=6 and a.t_code='"+ss+"' or substr(a.t_code,1,8)= '"+ss+"')";
    rs1 = LnGetRecordset(que);
    if(rs1 != null)
      if (rs1.moveNext) 
         ss1=rs1.value(0);

      end;
    end;
    return(ss1);
end;


macro mm_par(par1,par2,par3)
 private var que,sa1,sa2,srez,rs51;
   srez=" ";
   que="select t_" +par3+" from dpmpaym_dbt  where t_dockind=102 and t_documentid="+par1+"  and t_purpose= "+par2;
   rs51 = LnGetRecordSet(que);
   if(rs51 != null)
     if (rs51.moveNext) 
        srez=rs51.value(0);
     end;
   end;
   return srez;
end;



MACRO Fxx_account(par1,par2)
  private var que,que0,rs5,rs6,rs7,rez="0",flag0=0;

// ------------
            que0=" from dmcaccdoc_dbt aa , dmccateg_dbt bb,  ddl_leg_dbt cc where  cc.t_dealid="+par1+"  and aa.t_docid=cc.t_id  and aa.t_currency= 0 and aa.t_catid=bb.t_id and bb.t_code='"+par2+"'";
            que="select count(*) " +que0;
            rs6 = LnGetRecordSet(que);
            if(rs6 != null)
              if (rs6.moveNext) 
                 if (rs6.value(0) > 0 )
                    // -----------------
                    flag0=1;
                    que="select aa.t_account " +que0;
                    rs7 = LnGetRecordSet(que);
                    if(rs7 != null)
                      if (rs7.moveNext) 
                           rez=rs7.value(0);
                      end;
                    end;
                    // -----------------
                 end;
              end;
           end;
// ------------
  return rez;
END;



MACRO Swift_acc01(par1,par2)
  private var que,rs5,rez=0;
  que="select a.t_coraccount from dcorschem_dbt a where a.t_fiid="+par1+" and a.t_corrid="+par2;
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=rs5.value(0);
     end;
  end;

  return rez;
END;




MACRO bank_spi(par1,par2)
  private var que,rs5,rez=0,nkol;


  if (par1 == _BANK0 ) 
    que="select count(*) from dsettacc_dbt a, dpmautoac_dbt b WHERE  b.t_fikind=1 and b.t_servicekind=2 and a.T_SETTACCID=b.T_SETTACCID and a.T_partyid="+ncontr+" and a.t_fiid="+par2 +" and b.t_purpose=1 ";
    rs5 = LnGetRecordSet(que);
    if(rs5 != null)
      if (rs5.moveNext) 
        nkol=int(rs5.value(0));
      end;
    end;
    
    if ( nkol > 0 )
       que="select a.t_bankcode from dsettacc_dbt a, dpmautoac_dbt b WHERE  b.t_fikind=1 and b.t_servicekind=2 and a.T_SETTACCID=b.T_SETTACCID and a.T_partyid="+ncontr+" and a.t_fiid="+par2 +" and b.t_purpose=1 ";
       rs5 = LnGetRecordSet(que);
       if(rs5 != null)
          if (rs5.moveNext) 
            rez=rs5.value(0);
            return rez;
          end;
       end;
    end;
  end;

  que="select a.t_bankcode,a.t_bankid,t_bankcodekind from dsettacc_dbt a, dpmautoac_dbt b WHERE  b.t_fikind=1 and b.t_servicekind=2 and a.T_SETTACCID=b.T_SETTACCID and a.T_partyid="+par1+" and a.t_fiid="+par2+" order by b.t_order";//KEA
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        if (rs5.value(2)  == 3 )
          rez= ПолучитьКодСубъекта(rs5.value(1),6);
        else
          rez=rs5.value(0);
        end;
     end;
  end;
  return rez;
END;


MACRO acc_spi(par1,par2,par3)
  private var que,rs5,rez=0;
  que="select a.t_account from dsettacc_dbt a, dpmautoac_dbt b WHERE  b.t_fikind=1 and b.t_servicekind=2 and a.T_SETTACCID=b.T_SETTACCID and a.T_partyid="+_BANK+" and a.t_fiid="+par2+" and t_bankcode='"+par1+"'";
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=rs5.value(0);
     end;
  end;
  return rez;
END;

MACRO acc_spik(par1,par2,par3)
  private var que,rs5,rez=0;
  que="select a.t_account from dsettacc_dbt a, dpmautoac_dbt b WHERE  b.t_purpose != 1 and b.t_fikind=1 and b.t_servicekind=2 and a.T_SETTACCID=b.T_SETTACCID and a.T_partyid="+par3+" and a.t_fiid="+par1+" and t_bankcode='"+par2+"'";
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=rs5.value(0);
     end;
  end;

  if ( rez == 0 )
    que="select a.t_account from dsettacc_dbt a, dpmautoac_dbt b WHERE  b.t_purpose != 1 and b.t_fikind=1 and b.t_servicekind=2 and a.T_SETTACCID=b.T_SETTACCID and a.T_partyid="+par3+" and a.t_fiid="+par1+" and t_bankid='"+sswift(par2)+"'";
    rs5 = LnGetRecordSet(que);
    if(rs5 != null)
       if (rs5.moveNext) 
          rez=rs5.value(0);
       end;
    end;
  end;

  return rez;

END;


MACRO prim72(par1)
  private var que,que0,rs5,rs55,rez=" ";
  que0=" from dnotetext_dbt where t_objecttype=102 and t_notekind=101 and t_documentid=lpad("+par1+",34,'0') ";
  que="select count(*)"+que0; 
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        if ( rs5.value(0) > 0 )
           que="select utl_raw.cast_to_varchar2(t_Text)"+que0;
	   rs55 = LnGetRecordSet(que);
  	   if(rs55 != null)
     	     if (rs55.moveNext) 
                 rez=rs55.value(0);
             end;
           end;
        end;
     end;
  end;
  return rez;
END;


MACRO number_corr(par1,par2)
  private var que,rs5,rez="0";

  que="select t_number from dcorschem_dbt where rownum=1 and t_fiid="+par1+" and t_corrid="+par2;
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=rs5.value(0);
     end;
  end;
  return rez;
END;



macro fixbank2(paymentid,zna,nn)
    private var bank,banks,acc,spaymentid,rs2,rs3,rs5,ac5;
       spaymentid=string(paymentid);


    if ( nn == 3 )
        banks=zna;
        bank=sswift(zna);



    if ( ValType (bank) == V_UNDEF )
       return;
    end;

    if (( bank == "0" ) or ( bank == 0 )) 
       return;
    end;




      que = "update dpmpaym_dbt SET  t_payerbankid ='"+bank+"'  where  t_paymentid="+spaymentid;
      rs2 = LnGetRecordset(que);

      que = "select  count(*)  from  dpmprop_dbt where t_DebetCredit = 0 and t_paymentid="+spaymentid;
      rs2 = LnGetRecordset(que);
      if(rs2 != null)
        if (rs2.moveNext) 
          if ((rs2.value(0) > 0 ) and (nnfiid > 0 ) )

                if (par_paym(spaymentid,"payer") == 1 )
            que = "update dpmprop_dbt SET t_CodeKind = 6, t_Codename='BIC', t_BankCode ='"+banks+"'  where  t_DebetCredit = 1 and  t_paymentid="+spaymentid;
            rs3 = LnGetRecordset(que);
            que = "update dpmpaym_dbt SET  t_payercodekind=6,t_payercode='"+ПолучитьКодСубъекта(npayer,6)+"' ,t_receivercodekind=6,t_receivercode = '"+ПолучитьКодСубъекта(nreceiver,6)+"'   where  t_paymentid="+spaymentid;
            rs3 = LnGetRecordset(que);
                end;
            if (par_paym(spaymentid,"payer") != 1 )
                que="select count(*) from dparty_dbt where t_notreSident = 'X' and t_partyid="+bank;
                rs3 = LnGetRecordset(que);
                if(rs3 != null)
                    if (rs3.moveNext) 
                       if (rs3.value(0) == 0 )
                        que = "update dpmprop_dbt SET t_CodeKind = 3, t_Codename='БИК'  where TO_NUMBER(t_BankCode) > 0 and  t_DebetCredit = 0 and  t_paymentid="+spaymentid;
                        rs5 = LnGetRecordset(que);
                       end;
                    end;
                end;
            end;


            ac5=account_corr(nnfiid,bank);
            if ( string(ac5) > 2 )
               que = "update dpmpaym_dbt SET  t_futurereceiveraccount ='"+ac5+"'  where  t_paymentid="+spaymentid;
               rs2 = LnGetRecordset(que);
               ac5=number_corr(nnfiid,bank);
               que = "update dpmprop_dbt SET  t_corschem= "+ac5+"  where  t_DebetCredit = 1 and  t_paymentid="+spaymentid;
               rs2 = LnGetRecordset(que);
            end;
          end;

        end;

      end;
    elif ( nn == 44 )
      que = "update dpmpaym_dbt SET  t_payerbankid ='"+bank+"'  where  t_paymentid="+spaymentid;
      rs2 = LnGetRecordset(que);
      if(rs2 != null)
      end;

    elif ( nn == 77 )
      que = "update dpmpaym_dbt SET  t_receiverbankid ='"+bank+"'   where  t_paymentid="+spaymentid;
      rs2 = LnGetRecordset(que);
      if(rs2 != null)
      end;

    elif ( nn == 4 )

      que = "update dpmpaym_dbt SET  t_payeraccount='"+zna+"'  where  t_paymentid="+spaymentid;
      rs2 = LnGetRecordset(que);
      if(rs2 != null)
      end;


    elif ( nn == 6 )
// --------------------
        banks=zna;
        bank=sswift(zna);

    if ( ValType (bank) == V_UNDEF )
       return;
    end;

    if (( bank == "0" ) or ( bank == 0 )) 
       return;
    end;


      que = "update dpmpaym_dbt SET  t_receiverbankid ='"+bank+"'   where  t_paymentid="+spaymentid;
      rs2 = LnGetRecordset(que);
      if(rs2 != null)
      end;
      que = "select  count(*)  from  dpmprop_dbt where t_DebetCredit = 1 and t_paymentid="+spaymentid;
      rs2 = LnGetRecordset(que);
      if(rs2 != null)
        if (rs2.moveNext) 

          if ((rs2.value(0) > 0 ) and (nnfiid > 0 ) )

                if (par_paym(spaymentid,"receiver") == 1 )
            que = "update dpmprop_dbt SET t_CodeKind = 6, t_Codename='BIC', t_BankCode ='"+banks+"'  where t_DebetCredit = 1 and  t_paymentid="+spaymentid;
            rs3 = LnGetRecordset(que);
            que = "update dpmpaym_dbt SET  t_payercodekind=6,t_payercode='"+ПолучитьКодСубъекта(npayer,6)+"' ,t_receivercodekind=6,t_receivercode = '"+ПолучитьКодСубъекта(nreceiver,6)+"'   where  t_paymentid="+spaymentid;
            rs3 = LnGetRecordset(que);

                end;

            if (par_paym(spaymentid,"receiver") != 1 )
                que="select count(*) from dparty_dbt where t_notreSident = 'X' and t_partyid="+bank;
                rs3 = LnGetRecordset(que);
                if(rs3 != null)
                    if (rs3.moveNext) 
                       if (rs3.value(0) == 0 )
                        que = "update dpmprop_dbt SET t_CodeKind = 3, t_Codename='БИК'  where TO_NUMBER(t_BankCode) > 0 and t_DebetCredit = 1 and  t_paymentid="+spaymentid;
                        rs5 = LnGetRecordset(que);
                       end;
                    end;
                end;
            end;




            ac5=account_corr(nnfiid,bank);
            if ( string(ac5) > 2 )
               que = "update dpmpaym_dbt SET  t_futurepayeraccount ='"+ac5+"'  where  t_paymentid="+spaymentid;
               rs3 = LnGetRecordset(que);
               ac5=number_corr(nnfiid,bank);
               que = "update dpmprop_dbt SET  t_corschem= "+ac5+"  where  t_DebetCredit = 0 and  t_paymentid="+spaymentid;
               rs3 = LnGetRecordset(que);
            end;


/*
// -- -- ПОСРЕДНИК -------
           que="select a.T_BANKCORRCODE,a.T_CORRACC from dsettacc_dbt a, dpmautoac_dbt b WHERE  b.t_fikind=1 and b.t_servicekind=2 and a.T_SETTACCID=b.T_SETTACCID and a.T_partyid="+_BANK+" and a.t_fiid="+nnfiid+" and t_bankcode='"+banks+"'";
           rs5 = LnGetRecordSet(que);
           if(rs5 != null)
             if (rs5.moveNext) 
                if ( strlen(rs5.value(0)) > 3 ) 
                   que = "update dpmprop_dbt SET t_CorrCodeKind = 6, t_CorrCodename='BIC', T_CORRCODE ='"+rs5.value(0)+"', T_CORRACC='"+rs5.value(1)+"'  where t_DebetCredit = 1 and  t_paymentid="+spaymentid;
                   rs3 = LnGetRecordset(que);
                   if(rs3 != null)
                   end;

                end;
             end;
           end;
// -------------
*/
          end;
        end;

      end;
    elif ( nn == 7 )
      que = "update dpmpaym_dbt SET  t_receiveraccount='"+zna+"'  where  t_paymentid="+spaymentid;
      rs2 = LnGetRecordset(que);
      if(rs2 != null)
      end;
// --------------------


    end;
end;




private macro ContrList(as0,as1)
   var Party = TRecHandler("party.dbt");
   private var rez0;
   if(ListPT(Party, NULL, NULL, as0, as1))
      rez0=Party.rec.partyId;
      return rez0;
   end; 

   return -1;
end;



MACRO spi99(pa1,pa2,pa3)

  private var que,rs5,rez=0;
  ac1=0;
  ac2=0;
  que="select a.t_bankid,a.t_account  from dsettacc_dbt a, dpmautoac_dbt b WHERE b.t_fikind=1 and b.t_servicekind=2 and a.T_SETTACCID=b.T_SETTACCID  and a.T_partyid="+pa1+" and a.t_fiid="+pa2+" and t_purpose="+pa3;
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        ac1=rs5.value(0);
        ac2=rs5.value(1);
     end;
  end;
END;

macro Kontr320n(id)
      private var acc0,payer,receiver,payerbankid,receiverbankid,bank=_bank,purpose,swbank,fflag=0,pu; 
      zag="";
      sid=string(id);
      que="select b.t_name  ,to_char(a.t_dealdate,'DD.MM.YYYY'), a.t_dealcode,d.t_paymentid paymentid,a.t_dealtype dealtype,  d.t_fiid fiid, d.t_purpose purpose,  d.t_payer  payer,d.t_payerbankid payerbankid,d.t_receiver receiver,d.t_receiverbankid  receiverbankid, d.t_receiveraccount receiveraccount, d.t_payeraccount payeraccount, c.t_ground ground, cc.t_ccy  nval ";
      que1=" from ddl_tick_dbt a , dparty_dbt  b, dpmpaym_dbt  d , dpmrmprop_dbt c, dfininstr_dbt cc ";
      que1=que1+" where a.t_dealid="+sid+" and b.t_partyid=a.t_partyid ";
      que1=que1+" and d.t_dockind=102 and d.t_documentid=a.t_dealid and c.t_paymentid=d.t_paymentid  and cc.t_fiid=d.t_fiid  order by d.t_purpose ";
      que0=que+que1;
       rs02 = LnGetRecordset(que0);
       if(rs02 != null)
         while(rs02.moveNext())
           nnfiid = rs02.value("fiid");
           npayer = rs02.value("payer") ;
           nreceiver = rs02.value("receiver") ;
           ncontr = 0;
           if  (rs02.value("fiid") > 0 )
              if (rs02.value("payer") == _BANK0 )
                ncontr =rs02.value("receiver") ;
                swbank=bank_spi(_BANK0,nnfiid);
                fixbank2(rs02.value("paymentid"),swbank,3);
                acc0=Swift_acc(rs02.value("fiid"),swbank);
                fixbank2(rs02.value("paymentid"),acc0,4);   
              end;
              if (rs02.value("receiver") == _BANK0 )
                ncontr =rs02.value("payer") ;
                swbank=bank_spi(_BANK0,nnfiid);
                fixbank2(rs02.value("paymentid"),swbank,6);
                acc0=Swift_acc(rs02.value("fiid"),swbank);
                fixbank2(rs02.value("paymentid"),acc0,7);   
              end;

              if  (rs02.value("receiver") != _BANK0 ) 
                swbank=bank_spi(rs02.value("receiver"),nnfiid);
                fixbank2(rs02.value("paymentid"),swbank,6);
                acc0=acc_spik(rs02.value("fiid"),swbank,rs02.value("receiver"));
                fixbank2(rs02.value("paymentid"),acc0,7);   
              end;

              if (rs02.value("payer") != _BANK0 )
                swbank=bank_spi(rs02.value("payer"),nnfiid);
                fixbank2(rs02.value("paymentid"),swbank,3);
                acc0=acc_spik(rs02.value("fiid"),swbank,rs02.value("payer"));
                fixbank2(rs02.value("paymentid"),acc0,4);   
              end;



           else

              if  ((rs02.value("receiver") != _BANK0 ) and (rs02.value("purpose")  != 11 ))
                  pu=9;
                  if (rs02.value("dealtype") == 12300 )
                    pu=10;
                  end;
                  spi99(rs02.value("receiver"),nnfiid,pu) ;
                   if ( ac1 > 0 )
                       fixbank2(rs02.value("paymentid"),ac1,77);
                       fixbank2(rs02.value("paymentid"),ac2,7);
                   end;
              end;


              if  ((rs02.value("payer") != _BANK0 )  and (rs02.value("purpose")  != 11 ))
                  pu=10;
                  if (rs02.value("dealtype") == 12305 )
                    pu=9;
                  end;

                  spi99(rs02.value("payer"),nnfiid,pu) ;
                   if ( ac1 > 0 )
                       fixbank2(rs02.value("paymentid"),ac1,44);
                       fixbank2(rs02.value("paymentid"),ac2,4);
                   end;
              end;

              if  ((rs02.value("receiver") != _BANK0 ) and (rs02.value("purpose") == 11 ) )
                  spi99(rs02.value("receiver"),nnfiid,11) ;
                   if ( ac1 > 0 )
                       fixbank2(rs02.value("paymentid"),ac1,77);
                       fixbank2(rs02.value("paymentid"),ac2,7);
                   end;
              end;

              if  ((rs02.value("payer") != _BANK0 )  and (rs02.value("purpose")  == 11 ))
                  spi99(rs02.value("payer"),nnfiid,11) ;
                   if ( ac1 > 0 )
                       fixbank2(rs02.value("paymentid"),ac1,44);
                       fixbank2(rs02.value("paymentid"),ac2,4);
                   end;
              end;




           end;

         end;
       end;


end;



// ------------------
macro Kontr320(id)
      private var acc0,payer,receiver,payerbankid,receiverbankid,bank=_bank,purpose,swbank,fflag=0,rs31,bank5; 
      zag="";
      sid=string(id);
      que="select b.t_name  ,to_char(a.t_dealdate,'DD.MM.YYYY'), a.t_dealcode,d.t_paymentid paymentid,  d.t_fiid fiid,  d.t_payer  payer,d.t_payerbankid payerbankid,d.t_receiver receiver,d.t_receiverbankid  receiverbankid, d.t_receiveraccount receiveraccount, d.t_payeraccount payeraccount, c.t_ground ground, cc.t_ccy  nval ";
      que1=" from ddl_tick_dbt a , dparty_dbt  b, dpmpaym_dbt  d , dpmrmprop_dbt c, dfininstr_dbt cc ";
      que1=que1+" where a.t_dealid="+sid+" and b.t_partyid=a.t_partyid ";
      que1=que1+" and d.t_dockind=102 and d.t_documentid=a.t_dealid and c.t_paymentid=d.t_paymentid  and cc.t_fiid=d.t_fiid  order by d.t_purpose,d.t_valuedate ";
      que0=que+que1;
       rs02 = LnGetRecordset(que0);
       if(rs02 != null)
         while(rs02.moveNext())
           nnfiid = rs02.value("fiid");
           npayer = rs02.value("payer") ;
           nreceiver = rs02.value("receiver") ;
           zag=zag+rs02.value("nval")+"   "+rs02.value("ground")+"      ";
            if  (rs02.value("fiid") > 100 )
              if (rs02.value("payer") == _BANK0 )
                swbank=bank_spi(_BANK0,nnfiid);
                fixbank2(rs02.value("paymentid"),swbank,3);
                acc0=Swift_acc(rs02.value("fiid"),swbank);
                fixbank2(rs02.value("paymentid"),acc0,4);   
              end;
              if (rs02.value("receiver") == _BANK0 )
                swbank=bank_spi(_BANK0,nnfiid);
                fixbank2(rs02.value("paymentid"),swbank,6);
                acc0=Swift_acc(rs02.value("fiid"),swbank);
                fixbank2(rs02.value("paymentid"),acc0,7);   
              end;
              if ( (rs02.value("receiver") != _BANK0 ) and (strlen(rs02.value("receiveraccount")) < 2 ) )
                swbank=bank_spi(_BANK0,nnfiid);
                acc0=acc_spik(rs02.value("fiid"),swbank,rs02.value("receiver"));
                fixbank2(rs02.value("paymentid"),acc0,7);   
              end;


            end;
         end;
       end;
           zag="Cделка № "+rs02.value(2);

    bank=_BANK0;
    sql0="select d.t_paymentid pId2, ( select dd.t_ccy from dfininstr_dbt dd where dd.t_fiid= d.t_fiid ) val ,d.t_baseamount su, ";
    sql0=sql0+" (case   when d.t_receiver !="+bank+" then 'Выгон' else ' ' end ) vigon , to_char(d.t_valuedate,'dd.mm.yyyy') da,";
    sql0=sql0+"  (case   when d.t_receiver != "+bank+" then RSI_RSBPARTY.GetPartyCode(d.t_payerbankid,6) else ' ' end ) bankv, ";
    sql0=sql0+"  (case   when d.t_receiver != "+bank+" then d.t_payeraccount else ' ' end ) accv  ,  ";
    sql0=sql0+"   RSI_RSBPARTY.GetPartyCode( d.t_receiver,6) polu,RSI_RSBPARTY.GetPartyCode(d.t_receiverbankid,6) bankp,";
    sql0=sql0+"   d.t_receiveraccount accp , d.t_payer payer  , d.t_receiver receiver , d.t_fiid fiidp";
    sql0=sql0+que1; 
      cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );

  macro EvProc2 (rs0, cmd2, id, key )
   private var rs122,nnn,ss1,ss2,u1,u2,que,rs12,jk,ik;     


     if (cmd2 == DLG_INIT)	// Инициализация
        rs0.MoveFirst();          
        if (pId2 != 0)  // Надо найти запись

           while ( (rs0.value ("pId2") != pId2) And (Not rs0.EOF) )  

              rs0.Move(1, RELATIVE);
            end;
        end;
        GoToScroll(rs0, true);

     elif (cmd2 == DLG_KEY)

        pId2=rs0.value ("pId2");

 
        if(DLG_KEY_ENTER == Key)
           if ( id == 3 )
            is=menu(masm,"Укажите вариант ввода данных:" ,"Укажите вариант ввода данных:");
            if ( is== 0 )
              u1=rs0.value ("bankv");
              getstring(u1,"Введите SWIFT банка выгона средств",20);
              fixbank2(rs0.value ("pId2"),u1,id);
            elif (is == 1 )
              kkod= ContrList(PTLIST_ALLSWIFT,PTLIST_ALLSWIFT);
              if ( kkod > 0 )
                u1=ПолучитьКодСубъекта(kkod,6);
                 fixbank2(rs0.value ("pId2"),u1,id);   
              end;
            end;
            if (rs0.value("payer")  == bank )
                acc0=Swift_acc(rs0.value("fiidp"),u1);
                fixbank2(rs0.value ("pId2"),acc0,4);   
            end;
            return CM_SELECT;

           elif ( id == 4 )
            u1=rs0.value ("accv");
            getstring(u1,"Введите лицевой счет банка выгона средств",20);
            fixbank2(rs0.value ("pId2"),u1,id);   
            return CM_SELECT;

           elif ( id == 6 )
            is=menu(masm,"Укажите вартант ввода данных:" ,"Укажите вартант ввода данных:");
            if ( is == 0 )
              u1=rs0.value ("bankp");
              getstring(u1,"Введите SWIFT банка получателя",20);
              fixbank2(rs0.value ("pId2"),u1,id);   

                que = "update dpmprop_dbt SET t_CodeKind = 6, t_Codename='BIC', t_BankCode ='"+u1+"'  where t_DebetCredit = 1 and  t_paymentid="+rs0.value ("pId2");
                rs31 = LnGetRecordset(que);
                que = "update dpmpaym_dbt SET  t_payercodekind=6,t_payercode='"+ПолучитьКодСубъекта(npayer,6)+"' ,t_receivercodekind=6,t_receivercode = '"+ПолучитьКодСубъекта(nreceiver,6)+"'   where  t_paymentid="+rs0.value ("pId2");
                rs31 = LnGetRecordset(que);

              return CM_SELECT;

            elif (is == 1 )

              kkod= ContrList(PTLIST_ALLSWIFT,PTLIST_ALLSWIFT);
              if ( kkod > 0 )
                u1=ПолучитьКодСубъекта(kkod,6);
                fixbank2(rs0.value ("pId2"),u1,id);   
              end;
            end;
            if (rs0.value("receiver")  == bank )
                acc0=Swift_acc(rs0.value("fiidp"),u1);
                fixbank2(rs0.value ("pId2"),acc0,7);   
            end;
            return CM_SELECT;

           elif ( id == 7 )
            u1=rs0.value ("accp");
            getstring(u1,"Введите лицевой счет банка получателя",20);
            if ( u1 == "-1" )
              u1="OVER ACCOUNT";
            end;
            if ( u1 == "-0" )
              u1="CASH";
            end;

            fixbank2(rs0.value ("pId2"),u1,id);   
            return CM_SELECT;

           end;
        elif(DLG_KEY_F9 == Key) 
          fflag=1;
          return CM_CANCEL;
        end;

     end;
  end;


  AddCol (col2, 0, "val","Валюта", 6);
  AddCol (col2, 1, "su","Сумма ", 15);
  AddCol (col2, 2, "vigon","Вид", 10);
  AddCol (col2, 3, "bankv","Банк выгона", 10);
  AddCol (col2, 4, "accv","Счет", 18);

  AddCol (col2, 5, "polu","Получатель", 10);
  AddCol (col2, 6, "bankp","Банк получателя", 15);
  AddCol (col2, 7, "accp","Счет", 18);
  AddCol (col2, 8, "da","Дата", 18);


    sss="ENTER- Ввод данных  F9-  Подтверждение   ESC- Выход без подтверждения " ;
    while(RunScroll(cmd2, 9, col2, null, @EvProc2,zag,sss, null, 2, 10,150,45) )
     cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );
    end;

    return fflag;


end;



macro Kontr300n(id,purp)
      private var acc0,payer,receiver,payerbankid,receiverbankid,bank=_bank,purpose,swbank,fflag=0; 
      zag="";
      sid=string(id);
      que="select b.t_name  ,to_char(a.t_date,'DD.MM.YYYY'), a.t_code,d.t_paymentid paymentid,  d.t_fiid fiid,  d.t_payer  payer,d.t_payerbankid payerbankid,d.t_receiver receiver,d.t_receiverbankid  receiverbankid, d.t_receiveraccount receiveraccount, d.t_payeraccount payeraccount, c.t_ground ground, cc.t_ccy  nval, ";
      que=que+" a.t_kind dealtype , d.t_purpose purpose , a.t_type typedoc ";
      que1=" from ddvndeal_dbt a , dparty_dbt  b, dpmpaym_dbt  d , dpmrmprop_dbt c, dfininstr_dbt cc ";
      que1=que1+" where a.t_id="+sid+" and b.t_partyid=a.t_contractor ";
      que1=que1+" and d.t_dockind=4813 and d.t_documentid=a.t_id and c.t_paymentid=d.t_paymentid  and cc.t_fiid=d.t_fiid ";
      if ( purp < 3 )
       que1=que1+" and d.t_purpose < 3 ";
      else
       que1=que1+" and d.t_purpose > 2 ";
      end;
      que0=que+que1;

       rs02 = LnGetRecordset(que0);
       if(rs02 != null)


         while(rs02.moveNext())
           nnfiid = rs02.value("fiid");
           zag=zag+rs02.value("nval")+"   "+rs02.value("ground")+"      ";
           if  (rs02.value("fiid") > 0 )
              // if (rs02.value("payerbankid") == _BANK0 )
              if (rs02.value("payer") == _BANK0 )

                swbank=bank_spi(_BANK0,nnfiid);
                fixbank2(rs02.value("paymentid"),swbank,3);
                acc0=Swift_acc(rs02.value("fiid"),swbank);
                fixbank2(rs02.value("paymentid"),acc0,4);   
              end;
              // if (rs02.value("receiverbankid") == _BANK0 )
              if (rs02.value("receiver") == _BANK0 )

                swbank=bank_spi(_BANK0,nnfiid);
                fixbank2(rs02.value("paymentid"),swbank,6);
                acc0=Swift_acc(rs02.value("fiid"),swbank);
                fixbank2(rs02.value("paymentid"),acc0,7);   
              end;
              if (rs02.value("receiver") != _BANK0 ) 
                swbank=bank_spi(_BANK0,nnfiid);
                fixbank2(rs02.value("paymentid"),swbank,6);
                acc0=acc_spik(rs02.value("fiid"),swbank,rs02.value("receiver"));

                fixbank2(rs02.value("paymentid"),acc0,7);   
              end;

              if ( (rs02.value("dealtype") == 30302 ) and (rs02.value("purpose") == 1 ) )
                if (rs02.value("typedoc") == 1 )
                  swbank="RUAGRUMM";
                else
                  swbank=ПолучитьКодСубъекта(rs02.value("receiver"),6);
                end;
                fixbank2(rs02.value("paymentid"),swbank,6);
                acc0="CASH";
                fixbank2(rs02.value("paymentid"),acc0,7);   
              end;

           end;
         end;
       end;


end;



// ---
macro Kontr300(id,purp)
      private var acc0,payer,receiver,payerbankid,receiverbankid,bank=_bank,purpose,swbank,fflag=0; 
      zag="";
      sid=string(id);
      que="select b.t_name  ,to_char(a.t_date,'DD.MM.YYYY'), a.t_code,d.t_paymentid paymentid,  d.t_fiid fiid,  d.t_payer  payer,d.t_payerbankid payerbankid,d.t_receiver receiver,d.t_receiverbankid  receiverbankid, d.t_receiveraccount receiveraccount, d.t_payeraccount payeraccount, c.t_ground ground, cc.t_ccy  nval, ";
      que=que+" a.t_kind dealtype , d.t_purpose purpose , a.t_type typedoc ";
      que1=" from ddvndeal_dbt a , dparty_dbt  b, dpmpaym_dbt  d , dpmrmprop_dbt c, dfininstr_dbt cc ";
      que1=que1+" where a.t_id="+sid+" and b.t_partyid=a.t_contractor ";
      que1=que1+" and d.t_dockind=4813 and d.t_documentid=a.t_id and c.t_paymentid=d.t_paymentid  and cc.t_fiid=d.t_fiid ";
      if ( purp < 3 )
       que1=que1+" and d.t_purpose < 3 ";
      else
       que1=que1+" and d.t_purpose > 2 ";
      end;
      que0=que+que1;

       rs02 = LnGetRecordset(que0);
       if(rs02 != null)


         while(rs02.moveNext())
           nnfiid = rs02.value("fiid");
           zag=zag+rs02.value("nval")+"   "+rs02.value("ground")+"      ";
           if  (rs02.value("fiid") > 0 )
              // if (rs02.value("payerbankid") == _BANK0 )
              if (rs02.value("payer") == _BANK0 )

                swbank=bank_spi(_BANK0,nnfiid);
                fixbank2(rs02.value("paymentid"),swbank,3);
                acc0=Swift_acc(rs02.value("fiid"),swbank);
                fixbank2(rs02.value("paymentid"),acc0,4);   
              end;
              // if (rs02.value("receiverbankid") == _BANK0 )
              if (rs02.value("receiver") == _BANK0 )

                swbank=bank_spi(_BANK0,nnfiid);
                fixbank2(rs02.value("paymentid"),swbank,6);
                acc0=Swift_acc(rs02.value("fiid"),swbank);
                fixbank2(rs02.value("paymentid"),acc0,7);   
              end;
              if ( (rs02.value("receiver") != _BANK0 ) and (strlen(rs02.value("receiveraccount")) < 2 ) )
                swbank=bank_spi(_BANK0,nnfiid);
                acc0=acc_spik(rs02.value("fiid"),swbank,rs02.value("receiver"));

                fixbank2(rs02.value("paymentid"),acc0,7);   
              end;

              if ( (rs02.value("dealtype") == 30302 ) and (rs02.value("purpose") == 1 ) )
                if (rs02.value("typedoc") == 1 )
                  swbank="RUAGRUMM";
                else
                  swbank=ПолучитьКодСубъекта(rs02.value("receiver"),6);
                end;
                fixbank2(rs02.value("paymentid"),swbank,6);
                acc0="CASH";
                fixbank2(rs02.value("paymentid"),acc0,7);   
              end;

           end;
         end;
       end;
           zag="Cделка № "+rs02.value(2)+"            "+zag;

    bank=_BANK0;
    sql0="select d.t_paymentid pId2, ( select dd.t_ccy from dfininstr_dbt dd where dd.t_fiid= d.t_fiid ) val ,d.t_baseamount su, ";
    sql0=sql0+" (case   when d.t_receiver !="+bank+" then 'Выгон' else ' ' end ) vigon , ";
    sql0=sql0+"  (case   when d.t_receiver != "+bank+" then RSI_RSBPARTY.GetPartyCode(d.t_payerbankid,6) else ' ' end ) bankv, ";
    sql0=sql0+"  (case   when d.t_receiver != "+bank+" then d.t_payeraccount else ' ' end ) accv  ,  ";
    sql0=sql0+"   RSI_RSBPARTY.GetPartyCode( d.t_receiver,6) polu,RSI_RSBPARTY.GetPartyCode(d.t_receiverbankid,6) bankp,";
    sql0=sql0+"   d.t_receiveraccount accp , d.t_payer payer  , d.t_receiver receiver , d.t_fiid fiidp";
    sql0=sql0+que1; 
      cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );

  macro EvProc2 (rs0, cmd2, id, key )
   private var rs122,nnn,ss1,ss2,u1,u2,que,rs12,jk,ik;     


     if (cmd2 == DLG_INIT)	// Инициализация
        rs0.MoveFirst();          
        if (pId2 != 0)  // Надо найти запись

           while ( (rs0.value ("pId2") != pId2) And (Not rs0.EOF) )  

              rs0.Move(1, RELATIVE);
            end;
        end;
        GoToScroll(rs0, true);

     elif (cmd2 == DLG_KEY)

        pId2=rs0.value ("pId2");

 
        if(DLG_KEY_ENTER == Key)
           if ( id == 3 )
            is=menu(masm,"Укажите вариант ввода данных:" ,"Укажите вариант ввода данных:");
            if ( is== 0 )
              u1=rs0.value ("bankv");
              getstring(u1,"Введите SWIFT банка выгона средств",20);
              fixbank2(rs0.value ("pId2"),u1,id);
            elif (is == 1 )
              kkod= ContrList(PTLIST_ALLSWIFT,PTLIST_ALLSWIFT);
              if ( kkod > 0 )
                 u1=ПолучитьКодСубъекта(kkod,6);
                 fixbank2(rs0.value ("pId2"),u1,id);   
              end;
            end;
            if (rs0.value("payer")  == bank )
                acc0=Swift_acc(rs0.value("fiidp"),u1);
                fixbank2(rs0.value ("pId2"),acc0,4);   
            end;
            return CM_SELECT;

           elif ( id == 4 )
            u1=rs0.value ("accv");
            getstring(u1,"Введите лицевой счет банка выгона средств",20);
            fixbank2(rs0.value ("pId2"),u1,id);   
            return CM_SELECT;

           elif ( id == 6 )
            is=menu(masm,"Укажите вариант ввода данных:" ,"Укажите вартант ввода данных:");
            if ( is == 0 )
              u1=rs0.value ("bankp");
              getstring(u1,"Введите SWIFT банка получателя",20);
              fixbank2(rs0.value ("pId2"),u1,id);   
            elif (is == 1 )

              kkod= ContrList(PTLIST_ALLSWIFT,PTLIST_ALLSWIFT);
              if ( kkod > 0 )
                u1=ПолучитьКодСубъекта(kkod,6);
                fixbank2(rs0.value ("pId2"),u1,id);   
              end;
            end;
            if (rs0.value("receiver")  == bank )
                acc0=Swift_acc(rs0.value("fiidp"),u1);
                fixbank2(rs0.value ("pId2"),acc0,7);   
            end;
  
           return CM_SELECT;

           elif ( id == 7 )
            u1=rs0.value ("accp");
            getstring(u1,"Введите лицевой счет банка получателя",20);
            if ( u1 == "-1" )
              u1="OVER ACCOUNT";
            end;
            if ( u1 == "-0" )
              u1="CASH";
            end;

            fixbank2(rs0.value ("pId2"),u1,id);   
            return CM_SELECT;

           end;
        elif(DLG_KEY_F9 == Key) 
          fflag=1;
          return CM_CANCEL;
        end;

     end;
  end;


  AddCol (col2, 0, "val","Валюта", 6);
  AddCol (col2, 1, "su","Сумма ", 15);
  AddCol (col2, 2, "vigon","Вид", 10);
  AddCol (col2, 3, "bankv","Банк выгона", 10);
  AddCol (col2, 4, "accv","Счет", 18);

  AddCol (col2, 5, "polu","Получатель", 10);
  AddCol (col2, 6, "bankp","Банк получателя", 15);
  AddCol (col2, 7, "accp","Счет", 18);

    sss="ENTER- Ввод данных  F9-  Подтверждение   ESC- Выход без подтверждения " ;
    while(RunScroll(cmd2, 8, col2, null, @EvProc2,zag,sss, null, 2, 10,150,45) )
     cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );
    end;

    return fflag;


end;



macro Kontr_plat(id)
      private var acc0,swbank,payer,receiver,payerbankid,receiverbankid,bank=_BANK0,nnfiid,zag; 

      sid=string(id);
      que="select b.t_name  ,to_char(a.t_SigningDate,'DD.MM.YYYY'), a.t_dealnumber, d.t_paymentid paymentid,  d.t_fiid fiid,  d.t_payer  payer,d.t_payerbankid payerbankid,d.t_receiver receiver,d.t_receiverbankid  receiverbankid, d.t_receiveraccount receiveraccount, d.t_payeraccount payeraccount ";
      que1=" from ddl_nett_dbt a , dparty_dbt  b, dpmpaym_dbt  d  ";
      que1=que1+" where a.t_NettingID="+sid+" and b.t_partyid=a.t_contractor ";
      que1=que1+" and d.t_dockind=140 and d.t_documentid=a.t_NettingID ";
      que0=que+que1;
       rs02 = LnGetRecordset(que0);
       if(rs02 != null)
         while(rs02.moveNext())
           nnfiid = rs02.value("fiid");
           if  (rs02.value("fiid") > 0 )
              if (rs02.value("payer") == _BANK0 )
                swbank=bank_spi(_BANK0,nnfiid);
                fixbank2(rs02.value("paymentid"),swbank,3);
                acc0=Swift_acc(rs02.value("fiid"),swbank);
                fixbank2(rs02.value("paymentid"),acc0,4);   
              end;
              if (rs02.value("receiver") == _BANK0 )
                swbank=bank_spi(_BANK0,nnfiid);
                fixbank2(rs02.value("paymentid"),swbank,6);
                acc0=Swift_acc(rs02.value("fiid"),swbank);
                fixbank2(rs02.value("paymentid"),acc0,7);   
              end;

              if  (rs02.value("receiver") != _BANK0 ) 
                swbank=bank_spi(_BANK0,nnfiid);
                fixbank2(rs02.value("paymentid"),swbank,6);
                acc0=acc_spik(rs02.value("fiid"),swbank,rs02.value("receiver"));
                fixbank2(rs02.value("paymentid"),acc0,7);   
              end;
           else
              if  (rs02.value("receiver") != _BANK0 ) 
                swbank=ПолучитьКодСубъекта(rs02.value("receiver"),6);
                fixbank2(rs02.value("paymentid"),swbank,6);
                acc0=acc_spik(rs02.value("fiid"),swbank,rs02.value("receiver"));
                fixbank2(rs02.value("paymentid"),acc0,7);   
              end;


           end;

         end;
       end;

end;


macro Kontr_netting(id)
      private var acc0,payer,receiver,payerbankid,receiverbankid,bank=_BANK0; 

      sid=string(id);
      que="select b.t_name  ,to_char(a.t_SigningDate,'DD.MM.YYYY'), a.t_dealnumber ";
      que1=" from ddl_nett_dbt a , dparty_dbt  b, dpmpaym_dbt  d  ";
      que1=que1+" where a.t_NettingID="+sid+" and b.t_partyid=a.t_contractor ";
      que1=que1+" and d.t_dockind=140 and d.t_documentid=a.t_NettingID ";
      que0=que+que1;
       rs02 = LnGetRecordset(que0);
       if(rs02 != null)
         if (rs02.moveNext) 
           zag="Платежи по сделке № "+rs02.value(2)+" за "+rs02.value(1)+", "+rs02.value(0);
         end;
       end;

    sql0="select d.t_paymentid pId2, ( select dd.t_ccy from dfininstr_dbt dd where dd.t_fiid= d.t_fiid ) val ,d.t_baseamount su, ";
    sql0=sql0+" (case   when d.t_receiver !="+bank+" then 'Выгон' else ' ' end ) vigon , ";
    sql0=sql0+"  (case   when d.t_receiver != "+bank+" then RSI_RSBPARTY.GetPartyCode(d.t_payerbankid,6) else ' ' end ) bankv, ";
    sql0=sql0+"  (case   when d.t_receiver != "+bank+" then d.t_payeraccount else ' ' end ) accv  ,  ";
    sql0=sql0+"   RSI_RSBPARTY.GetPartyCode( d.t_receiver,6) polu,RSI_RSBPARTY.GetPartyCode(d.t_receiverbankid,6) bankp,";
    sql0=sql0+"   d.t_receiveraccount accp , d.t_payer payer  , d.t_receiver receiver , d.t_fiid fiidp";
    sql0=sql0+que1; 
      cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );

  macro EvProc2 (rs0, cmd2, id, key )
   private var rs122,nnn,ss1,ss2,u1,u2,que,rs12,jk,ik;     


     if (cmd2 == DLG_INIT)	// Инициализация
        rs0.MoveFirst();          
        if (pId2 != 0)  // Надо найти запись

           while ( (rs0.value ("pId2") != pId2) And (Not rs0.EOF) )  

              rs0.Move(1, RELATIVE);
            end;
        end;
        GoToScroll(rs0, true);

     elif (cmd2 == DLG_KEY)

        pId2=rs0.value ("pId2");
 
        if(DLG_KEY_ENTER == Key)
           if ( id == 3 )
            is=menu(masm,"Укажите вариант ввода данных:" ,"Укажите вариант ввода данных:");
            if ( is== 0 )
              u1=rs0.value ("bankv");
              getstring(u1,"Введите SWIFT банка выгона средств",20);
              fixbank2(rs0.value ("pId2"),u1,id);
            elif (is == 1 )
              kkod= ContrList(PTLIST_ALLSWIFT,PTLIST_ALLSWIFT);
              if ( kkod > 0 )
                u1=ПолучитьКодСубъекта(kkod,6);
                 fixbank2(rs0.value ("pId2"),u1,id);   
              end;
            end;

            if (rs0.value("payer")  == bank )
                acc0=Swift_acc(rs0.value("fiidp"),u1);
                fixbank2(rs0.value ("pId2"),acc0,4);   
            end;
            return CM_SELECT;

           elif ( id == 4 )
            u1=rs0.value ("accv");
            getstring(u1,"Введите лицевой счет банка выгона средств",20);
            fixbank2(rs0.value ("pId2"),u1,id);   
            return CM_SELECT;

           elif ( id == 6 )
            is=menu(masm,"Укажите вартант ввода данных:" ,"Укажите вартант ввода данных:");
            if ( is== 0 )
              u1=rs0.value ("bankp");
              getstring(u1,"Введите SWIFT банка получателя",20);
              fixbank2(rs0.value ("pId2"),u1,id);   
             return CM_SELECT;


            elif (is == 1 )

              kkod= ContrList(PTLIST_ALLSWIFT,PTLIST_ALLSWIFT);
              if ( kkod > 0 )
                u1=ПолучитьКодСубъекта(kkod,6);
                fixbank2(rs0.value ("pId2"),u1,id);   
              end;
            end;
            if (rs0.value("receiver")  == bank )
                acc0=Swift_acc(rs0.value("fiidp"),u1);
                fixbank2(rs0.value ("pId2"),acc0,7);   
            end;
            return CM_SELECT;

           elif ( id == 7 )
            u1=rs0.value ("accp");
            getstring(u1,"Введите лицевой счет банка получателя",20);
            if ( u1 == "-1" )
              u1="OVER ACCOUNT";
            end;
            if ( u1 == "-0" )
              u1="CASH";
            end;

            fixbank2(rs0.value ("pId2"),u1,id);   
            return CM_SELECT;

           end;
        elif(DLG_KEY_F9 == Key) 
          return CM_CANCEL;
        end;

     end;
  end;


  AddCol (col2, 0, "val","Валюта", 6);
  AddCol (col2, 1, "su","Сумма ", 15);
  AddCol (col2, 2, "vigon","Вид", 10);
  AddCol (col2, 3, "bankv","Банк выгона", 10);
  AddCol (col2, 4, "accv","Счет", 18);

  AddCol (col2, 5, "polu","Получатель", 10);
  AddCol (col2, 6, "bankp","Банк получателя", 15);
  AddCol (col2, 7, "accp","Счет", 18);

    sss="ENTER- Ввод данных  F9-  Подтверждение   ESC- Выход без подтверждения " ;
    while(RunScroll(cmd2, 8, col2, null, @EvProc2,zag,sss, null, 2, 10,150,45) )
     cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );
    end;

    // exit(1);



end;



