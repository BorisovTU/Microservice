/* Панель установки типа и формы обеспечения для генсоглашения */
IMPORT RsbFormsInter, FIInter, rsexts, oralib, likepy, funk, dl_plib, "sprepfun.mac";

CLASS (tRsbPanel) pnl_SetTypeSecur(Document)
  private const FT_STRING = 7;

  const K_Enter = 13;
  const K_F3    = 317;
  const K_F2    = 316;
  const K_Alt_F3= 362;

  var ch_sql, ch_data;
  var upd_flag = true;
  var upd_lbl;
  var DocKind = Document.DocKind, 
      GenagrID = Document.GenagrID;

  macro getTypeSecurValues(elementID:integer, code:@string, name:@string)
    var sql = DL_RSDCommand("select * from dllvalues_dbt  where t_list = 4019 and t_element =?");
    sql.addParam(elementID);
    var Data = sql.execute();
    if(Data.movenext())
      code = Data.Code;
      name = Data.Name
    end;
  end;
  macro getFormSecurValues(elementID:integer, code:@string, name:@string)
    var sql = DL_RSDCommand("select * from dllvalues_dbt  where t_list = 4020 and t_element =?");
    sql.addParam(elementID);
    var Data = sql.execute();
    if(Data.movenext())
      code = Data.Code;
      name = Data.Name
    end;
  end;

  var curstr = 1;

  InitTRSBPanel();
  Caption = "Установка типа и формы обеспечения.";
  Status  = "~ESC~Выход  ~F2~Выполнить";
  setSize(85,5);
  SetPosition(30,10);

  curstr = curstr + 1;  
      var lbl_TypeSecur, TypeSecur_code, TypeSecur_name;
      getTypeSecurValues(Document.TypeSecur, @TypeSecur_code, @TypeSecur_name);
      lbl_TypeSecur = TRSBLabel(4, curstr,"Тип обеспечения:");
        addlabel (lbl_TypeSecur);
     var fld_TypeSecur_code = TRsbComboBox();
      fld_TypeSecur_code.name       = "fld_TypeSecur_code";
      fld_TypeSecur_code.dataType   = 7; //FT_STRING
      fld_TypeSecur_code.textLength = 3;
      fld_TypeSecur_code.setPosition(20, curstr);
      fld_TypeSecur_code.setSize (3, 1);
      ch_sql = DL_RSDCommand("select * from dllvalues_dbt  where t_list = 4019");
      ch_data = ch_sql.execute();
      while(ch_data.movenext())
        fld_TypeSecur_code.addChoice(ch_data.Element, ch_data.code);
      end;
      fld_TypeSecur_code.CurrentChoice = Document.TypeSecur;
      fld_TypeSecur_code.onItemSelected(r2m(this, "onTypeSecurSelected"));
      addControl(fld_TypeSecur_code);

      var fld_TypeSecur;
      fld_TypeSecur = TRSBEditField (FT_STRING);
      fld_TypeSecur.setPosition(25,curstr);
      fld_TypeSecur.setSize(50,1);
      fld_TypeSecur.name = "fld_TypeSecur";
      fld_TypeSecur.textLength = 100;
      fld_TypeSecur.editable = false;
      fld_TypeSecur.value = TypeSecur_name;
        addControl(fld_TypeSecur);

  curstr = curstr + 1;  
      var lbl_FormSecur, FormSecur_code, FormSecur_name;
      getFormSecurValues(Document.FormSecur, @FormSecur_code, @FormSecur_name);
      lbl_FormSecur = TRSBLabel(4, curstr,"Форма обеспечения:");
        addlabel (lbl_FormSecur);
     var fld_FormSecur_code = TRsbComboBox();
      fld_FormSecur_code.name       = "fld_FormSecur_code";
      fld_FormSecur_code.dataType   = 7; //FT_STRING
      fld_FormSecur_code.textLength = 3;
      fld_FormSecur_code.setPosition(20, curstr);
      fld_FormSecur_code.setSize (3, 1);
      ch_sql = DL_RSDCommand("select * from dllvalues_dbt  where t_list = 4020");
      ch_data = ch_sql.execute();
      while(ch_data.movenext())
        fld_FormSecur_code.addChoice(ch_data.Element, ch_data.code);
      end;
      fld_FormSecur_code.CurrentChoice = Document.FormSecur;
      fld_FormSecur_code.onItemSelected(r2m(this, "onFormSecurSelected"));
      addControl(fld_FormSecur_code);

      var fld_FormSecur;
      fld_FormSecur = TRSBEditField (FT_STRING);
      fld_FormSecur.setPosition(25,curstr);
      fld_FormSecur.setSize(50,1);
      fld_FormSecur.name = "fld_Order";
      fld_FormSecur.textLength = 100;
      fld_FormSecur.editable = false;
      fld_FormSecur.value = FormSecur_name;
        addControl(fld_FormSecur);

      var fld_editfld;
      fld_editfld = TRSBEditField (FT_STRING);
      fld_editfld.setPosition(75,curstr+1);
      fld_editfld.setSize(10,1);
      fld_editfld.name = "fld_Order";
      fld_editfld.textLength = 10;
      fld_editfld.editable = false;
      fld_editfld.value = "";
        addControl(fld_editfld);


    addEventHandler (RSB_EV_Key_Pressed, R2M(this,"on_KeyPressed"));

    MACRO on_KeyPressed(ev)
       var errflag = 0;
       var RepFlag = 0;
       IF (ev.KeyCode == K_F3)
        
       ELIF(ev.keyCode == K_F2) 
         if(upd_flag) 
           var upd_sql = RSDCommand("update ddl_repozdeal_dbt set t_typesecur = ?, t_formsecur = ? where t_dockind = ? and t_docid = ?");
               upd_sql.addParam("typesecur", rsdbp_in, fld_TypeSecur_code.CurrentChoice);
               upd_sql.addParam("formsecur", rsdbp_in, fld_FormSecur_code.CurrentChoice);
               upd_sql.addParam("dockind", rsdbp_in, DocKind);
               upd_sql.addParam("genagrid", rsdbp_in, GenagrID);
               upd_sql.execute(); upd_sql = null;
               upd_sql = RSDCommand("update ddl_genagr_dbt set t_typesecur = ?, t_formsecur = ? where t_dockind = ? and t_genagrid = ?");
               upd_sql.addParam("typesecur", rsdbp_in, fld_TypeSecur_code.CurrentChoice);
               upd_sql.addParam("formsecur", rsdbp_in, fld_FormSecur_code.CurrentChoice);
               upd_sql.addParam("dockind", rsdbp_in, DocKind);
               upd_sql.addParam("genagrid", rsdbp_in, GenagrID);
               upd_sql.execute(); upd_sql = null;

           fld_TypeSecur_code.editable = false;
           fld_FormSecur_code.editable = false;
           fld_editfld.value = "Сохранено!";
           upd_flag = false;
           this.redraw;
         end;
       END;
    END;
    MACRO onTypeSecurSelected(EV)
      var sql = DL_RSDCommand("select * from dllvalues_dbt  where t_list = 4019 and t_element = ?");
      sql.addParam(fld_TypeSecur_code.CurrentChoice);
      var data = sql.execute();
      while(data.movenext())
        fld_TypeSecur.value = data.Name;
        fld_editfld.value = "***";
        this.redraw;
      end;
      upd_flag = true;
    END;
    MACRO onFormSecurSelected(EV)
      var sql = DL_RSDCommand("select * from dllvalues_dbt  where t_list = 4020 and t_element = ?");
      sql.addParam(fld_FormSecur_code.CurrentChoice);
      var data = sql.execute();
      while(data.movenext())
        fld_FormSecur.value = data.Name;
        fld_editfld.value = "***";
        this.redraw;
      end;
      upd_flag = true;
    END;


END;


MACRO setTypeSecur(Document)
   
   var sql = DL_RSDCommand("select * from ddl_repozdeal_dbt where t_dockind = ? and t_docid = ? ");
   sql.addParam(Document.DocKind);
   sql.addParam(Document.GenagrID);
   var Data = sql.execute();
   IF (Data.MoveNext () )
     var pnlSetTypeSecur:TRSBpanel = pnl_SetTypeSecur(Document);
         pnlSetTypeSecur.run();
   ELSE 
     msgbox("Для выбранного ГС отсутствуют сформированные репозитарные параметры. \n Установите в панели параметров ГС признак репортинга, переведите ГC в отложенные и исполните вновь.");
   END;

END;