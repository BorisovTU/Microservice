/*LKL
Панель условий по портфелю
*/

IMPORT  dl_note_lib, funk, RSD, RSBDataSet, dlgCommon;
Private const kbF2 = 316, kbF3 = 317, kbF7 = 522, kbF9 =323, kbEnter = 13;

Class (TRecHandler) CPanelCportfolio ( _DealId )
    private var  DealId, CurrentField;
    private var v_codecond, v_namecond, v_attrcond;

    InitTRecHandler ("cportfol", "mbkadd.lbr", TRUE);
    DealId    = _DealId;

    Macro scrHandler ( rs, cmd, id, key )
        if ( (cmd == DLG_KEY) and (key == kbEnter) and (rs.RecCount) )
            return CM_SELECT;
        end;
    End;


    Macro ListPortfolio
        private var sql, cmd; 
        sql = "select t_attrid, t_name, t_fullname from dobjattr_dbt where t_objecttype=103 and t_groupid=1 and t_closedate=to_date('01010001','ddmmyyyy') and t_parentid=0";
        cmd = RSDRecordset(sql, RSDVAL_CLIENT, RSDVAL_STATIC );
        if ( RunScroll (cmd, 3, MakeArray ("t_attrid", "Код", 3, 2, 0, 0, "t_name", "Наименование", 40, 2, 40, 0, "t_fullname", "Полное наименование", 40, 2, 40, 0),
                        "ListPortfolio", R2M (this, "scrHandler"),"Справочник портфелей", "Enter Выбор  ESC Отмена", TRUE, 0, 0) )
            SetParm (1, cmd.value ("t_name"));
            SetParm (2, cmd.value ("t_fullname"));
            SetParm (3, cmd.value ("t_attrid"));
            return TRUE;
        end;
        return FALSE;
    End;


    Macro Handler ( dlg, cmd, id, key )

      if( (cmd == DLG_KEY) and (key == kbF9)  )

           if ( (strlen(this.("CONDITION")) == 0) or (strlen(this.("PORTFOLIO")) == 0 ) )
              msgbox("Не все условия определены!");
              return CM_IGNORE;
           end;
           UpdateFields (dlg);
//установитть в  примечания
  	   SetNoteDifValue(DealId, 110, this.("PORTFOLIO"));
	   SetNoteDifValue(DealId, 109, this.("CONDITION"));
//установить в сделку
           InsPortfolioAttr(DealId, v_attrcond);

           return CM_SAVE;

      elif (cmd == 5) //DLG_IN???
           CurrentField = id;

      elif( (cmd == DLG_KEY) and (key == kbF3) and ( CurrentField == 0 )  )
           ListPortfolio(dlg.(id), v_codecond, v_attrcond);
           UpdateFields (dlg);

      elif( (cmd == DLG_KEY) and (key == kbEnter) )

           return CM_IGNORE;
      end;
    End;


    Macro Init

      v_codecond = GetNoteDifValue(DealId, 109);
      if ( v_codecond == 0 )
         this.("CONDITION") = "";
      else
	 this.("CONDITION") = v_codecond;
      end;

      v_namecond =GetNoteDifValue(DealId, 110);
      if (v_namecond == 0)
          this.("PORTFOLIO") =  "";
      else
          this.("PORTFOLIO") =  v_namecond;
      end;

    End;

    
    Macro Run
        Init ();
        return RunDialog (this, R2M (this, "Handler"));
    End;

end;