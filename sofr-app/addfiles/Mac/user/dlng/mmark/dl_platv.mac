//-----------------------------------------------------------------------------------------
// Формирование платежей 
//-----------------------------------------------------------------------------------------

import funk,"cb_sql.mac","dl_class_fx.mac",dl_lib;
record pmpaymm ("pmpaym.dbt");
record pmrmpropm ("pmrmprop.dbt");
private var rs1,rs,ss,que,docc;
MACRO strana(s)
   private var ss,que,rs,rs1,ss1;
    ss=string(s);
    ss1=" ";
    que = "select t_nrcountry from  dparty_dbt   where  t_partyid='"+ss+"'";
    rs = LnGetRecordset(que);
                 if(rs != null)
                  if (rs.moveNext) 
                    if (strlen(rs.value(0)) < 2)
                      ss1="KZ ";
                    else
    ss1=" ";
    ss=rs.value(0);
    que = "select t_codelat2 from  dcountry_dbt   where  t_codelat3='"+ss+"'";
    rs1 = LnGetRecordset(que);
                 if(rs1 != null)
                  if (rs1.moveNext) 
                     ss1=trim(rs1.value(0))+" ";
                  end;
                 end;
                    end;
 		 end;
	        end;

 return(ss1);

END; 	


MACRO OSNOVANIE(sch)
 private var que,rsq,rez=" ";

    que="select t_nameaccount from daccount_dbt  where t_account='"+sch+"'";
    rs1 = LnGetRecordset(que);
                 if(rs1 != null)
                  if (rs1.moveNext) 
                     rez=rs1.value(0);
                  end;
                 end;
   return rez;

END;

macro platv(id1,ground,sch1,sch2,scroll)
private var newdada,BBDocID,bb,snalog,sclient;

     que = "select  *  from dpmpaym_dbt  where t_paymentid ="+id1; 
     rs1 = LnGetRecordset(que);
     if(rs1 != null)
      if (rs1.moveNext) 
        CopyRSetToFBuff( pmpaymm, rs1 ) ;
      end;
     end;


     ss=string(pmpaymm.paymentid);
     que = "select  *  from dpmrmprop_dbt  where t_paymentid='"+ss+"'";
     rs1 = LnGetRecordset(que);
     if(rs1 != null)
      if (rs1.moveNext) 
        CopyRSetToFBuff( pmrmpropm, rs1 ) ;
      end;
     end;

          bb = TBBPrimDocc();

          bb.m_fiid             =   pmpaymm.fiid;
          bb.m_Kind_Operation   =   13005;
          bb.m_Origin           =   1 ;
          bb.m_Oper             =   {oper};
          bb.m_docKind          = 27; 
          bb.m_docNumber        = execmacrofile("fx_lib", "MakeNumberv") ;
          bb.m_NumberPack       = 400;
          bb.m_Department       = 1;
          bb.m_valueDate        = pmpaymm.valuedate ;
          bb.m_docDate          = pmpaymm.valuedate ;


          if (strlen(pmpaymm.userfield1)  > 1 )
            bb.m_valueDate        = date(pmpaymm.userfield1) ;
            bb.m_docDate          = date(pmpaymm.userfield1) ;
          end;


          if (strlen(pmpaymm.userfield2)  > 1 )
            bb.m_valueDate        = date(pmpaymm.userfield2) ;
          end;

          if (pmpaymm.purpose == 11 ) 
            sclient=MM_tickid(pmpaymm.documentid,"partyid");
            snalog=MM_nalog(sclient);
            if (snalog > 0 )
                pmpaymm.baseamount=pmpaymm.baseamount-(pmpaymm.baseamount*snalog/100);
                ground=ground+", БЕЗ НАЛОГА "+string(snalog)+" % ";
            end;
          end;

          bb.m_receiverDpNode      = pmpaymm.paymentid;
          bb.m_Ground           = ground;
          bb.m_AmountDt         = pmpaymm.baseamount ;

          bb.m_BankpayerCode    = ПолучитьКодСубъекта ( pmpaymm.payerbankid,6);
          bb.m_payerBankName    = pmrmpropm.ReceiverBankName;
          bb.m_PayerAccount     = sch1;
          bb.m_Payername        = pmrmpropm.payerName;

          bb.m_BankReceiverCode = ПолучитьКодСубъекта ( pmpaymm.receiverbankid,6); 
          bb.m_ReceiverBankName = pmrmpropm.ReceiverBankName; 
          bb.m_ReceiverAccount  = sch2; 
          bb.m_ReceiverName     = pmrmpropm.ReceiverName; 
          bb.m_Receiver         = pmpaymm.receiver; 


          BBDocID = bb.Insert(scroll);
end;




