IMPORT fx_globals, funk, RSD, mmlibr, MmarkInter,dl_prol,dl_lib;
import  "dl_kvlib.mac","cb_sql.mac";

    record tick( dl_tick );
    record leg ( dl_leg );


MACRO ExecuteStep(Buffer, Document)
    private var i, s_id0, sql, rs0, rs01, s_messerr, s_messok,ii=1,plid;
    array masm; 

    SetBuff( tick, Document );
    plid=plat_dil(tick.dealid,"102","9","paymentid");
    sql="update DPMPAYM_DBT set T_USERTYPEDOCUMENT='1'  where t_paymentid="+plid;
    rs01 = LnGetRecordSet(sql);
    СоздатьСообщение (2, tick,leg); 
    sql="update DPMPAYM_DBT set T_USERTYPEDOCUMENT='0'  where t_paymentid="+plid;
    rs01 = LnGetRecordSet(sql);
    return 0 ;
END;
/*

MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -откат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */  


  private var sql,rs01,rs05;
  SetBuff(tick, FirstDoc );


  if ( CommitOrRollback == 1 )
        sql="select count(*) from dwldlmm_dbt a, ddl_tick_dbt b where b.t_dealid="+tick.dealid+" and  a.t_dealid=b.t_dealid"; 
        rs01 = LnGetRecordSet(sql);
        if(rs01 != null)
          if (rs01.moveNext) 
            if (int(rs01.value(0)) > 0 )
               sql="update dwldlmm_dbt set  t_dealcodeps=substr(t_dealcode,4), t_state=20  where t_dealid="+tick.dealid; 
               rs05 = LnGetRecordSet(sql);
            end;
          end;
        end;
  end;

  return 0;
END;


MACRO CheckStepAction( mes, primdoc, DocKind, ID_Operation )

  private var sql,rs01,rs05;
  SetBuff(tick, primdoc );
  if( mes == OP_BACKOUT_STEP )
        sql="select count(*) from dwldlmm_dbt a, ddl_tick_dbt b where b.t_dealid="+tick.dealid+" and  a.t_dealid=b.t_dealid"; 
        rs01 = LnGetRecordSet(sql);
        if(rs01 != null)
          if (rs01.moveNext) 
            if (int(rs01.value(0)) > 0 )
               sql="update dwldlmm_dbt set t_state=10  where t_dealid="+tick.dealid+" and t_state = 20"; 
               rs05 = LnGetRecordSet(sql);
            end;
          end;
        end;

  end;
  return 0;

END;
 */
