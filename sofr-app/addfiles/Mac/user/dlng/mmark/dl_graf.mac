/*
$Name:        dl_graf.mac
$Module:      МБ Кредиты
$Description: Пользовательский график платежей
*/
import RSBDataSet, oralib, likepy, cb_sql,funk,dlgCommon,dl_plib,mmDealDlg,dl_nplat;
private array map1,map2;


macro Histpaym1(pa1)
 private var que,rs51;

   que="select   T_AMOUNT,T_PAYERBANKID,T_PAYERACCOUNT,T_RECEIVERBANKID,T_RECEIVERACCOUNT,to_char(T_VALUEDATE,'DD.MM.YYYY') from dpmpaym_dbt  where t_paymentid="+pa1;
   rs51 = LnGetRecordSet(que);
   if(rs51 != null)
     if (rs51.moveNext) 
        map1(0)=rs51.value(0);
        map1(1)=rs51.value(1);
        map1(2)=rs51.value(2);
        map1(3)=rs51.value(3);
        map1(4)=rs51.value(4);
        map1(5)=rs51.value(5);
     end;
   end;
end;

macro Histpaym2(pa1)
 private var que,rs51,ii=0,pfix=0,{curdare},{oper};

   que="select   T_AMOUNT,T_PAYERBANKID,T_PAYERACCOUNT,T_RECEIVERBANKID,T_RECEIVERACCOUNT,to_char(T_VALUEDATE,'DD.MM.YYYY') from dpmpaym_dbt  where t_paymentid="+pa1;
   rs51 = LnGetRecordSet(que);
   if(rs51 != null)
     if (rs51.moveNext) 
        map2(0)=rs51.value(0);
        map2(1)=rs51.value(1);
        map2(2)=rs51.value(2);
        map2(3)=rs51.value(3);
        map2(4)=rs51.value(4);
        map2(5)=rs51.value(5);
     end;
   end;

   while(ii < 7) 
     if (map1(ii) != map2(ii) )
         pfix=1;
         ii=10;
     end;
     ii=ii+1;

   end;
   if ( pfix > 0 )
     que="insert into  DSTD_HISTPAYM_DBT (T_PAYMENTID,T_AMOUNT,T_PAYERBANKID,T_PAYERACCOUNT,T_RECEIVERBANKID,T_RECEIVERACCOUNT,T_VALUEDATE,T_AMOUNT2,T_PAYERBANKID2,T_PAYERACCOUNT2,T_RECEIVERBANKID2,T_RECEIVERACCOUNT2,T_VALUEDATE2,T_RESERVE,T_DATER,T_OPER) ";
     que=que+" values("+pa1+","+map1(0)+","+map1(1)+",'"+map1(2)+"',"+map1(3)+",'"+map1(4)+"','"+map1(5)+"',"+map2(0)+","+map2(1)+",'"+map2(2)+"',"+map2(3)+",'"+map2(4)+"','"+map2(5)+"',' ','"+СДАТ({curdate})+"',"+{oper}+" )"; 
     rs51 = LnGetRecordSet(que);
   end;


end;





macro prog1(idsde)

private var sql,sql2, cmd1,ss,ss1,que,rs2,subpu,ls,ls2,kau,datv;
private var rs0,rs3,ss5,rs00,gd0,gs0,ss0,gs1,gdd0,gdd1,gds1,gss,newda,nnss1,pada;
private var col1=TArray();
private var pId="0",legidid=1,CorrectFlag=true;
private var userGraphFlag = false, stat = 0;

    GetRegistryValue("РСХБ\\МБК ПОЛЬЗ ГРАФИК %",
        V_BOOL, userGraphFlag, stat);
		
    private var status;
	if (userGraphFlag)
		status = " F3- Параметры графика  F5- Дата платежа  f6- Дата валютирования  F8- Удаление  F9/F7/F10 -Ввод  F11 -пересчет %  F12- %% ставки ";
	else
		status = " F5- Дата платежа  f6- Дата валютирования  F8- Удаление  F9/F7/F10 -Ввод  F12- %% ставки ";
	end;


   sql="update ddl_tick_dbt SET  t_flag3 ='X'  where  t_dealid="+idsde;
   rs3 = LnGetRecordSet(sql);

   ss=string(idsde);
   sql="select a.t_baseamount psumma, (case when length(a.t_userfield1) > 1 then a.t_userfield1 else to_char(a.t_valuedate,'DD.MM.YYYY')  end)  pdat, (case when length(a.t_userfield2) > 1 then a.t_userfield2 else  (case when length(a.t_userfield1) > 1 then a.t_userfield1 else to_char(a.t_valuedate,'DD.MM.YYYY')  end) end)  pdatv,  a.t_valuedate  pdatr ,a.t_fiid fi, c.t_shortname ptip , replace(to_char(a.t_baseamount,'999,999,999,999.99'),',', '''') psum, a.t_paymentid pnum, (select u1.t_ccy from dfininstr_dbt u1 where u1.t_fiid= a.t_fiid ) pval, (select u2.t_shortname from dparty_dbt u2 where u2.t_partyid=a.t_payer) potp , (select u2.t_shortname from dparty_dbt u2 where u2.t_partyid=a.t_payerbankid)  pbotp, (select u2.t_shortname from dparty_dbt u2 where u2.t_partyid=a.t_receiver)  ppol, (select u2.t_shortname from dparty_dbt u2 where u2.t_partyid=a.t_receiverbankid)  pbpol , (select u3.t_shortname from dpmstatus_dbt u3 where u3.t_type=0 and u3.t_paymstatus=a.t_paymstatus ) pstat , a.t_fiid fiid, a.t_paymentId pId,  a.t_reserv1 ssh   from dpmpaym_dbt a, dpmrmprop_dbt b, dpmpurp_dbt c where a.t_docKind=102 and a.t_purpose > 8 and a.t_purpose=c.t_purpose and  a.t_paymentid=b.t_paymentid and a.t_documentid = '"+ss+"' order by a.t_purpose,a.t_valuedate";
   cmd1 = RSDRecordset(sql , RSDVAL_CLIENT, RSDVAL_STATIC );
  private macro GetBasePaymOD (dealid)
     var query = "select min(t_paymentid) from dpmpaym_dbt where t_dockind = 102 and t_purpose = 10 and t_documentid = " + idsde;
     var base_paym_od = LnGetRecordSet(query);
     if (base_paym_od.MoveNext())
        return base_paym_od.value(0);     
     end;
     return -1;      
  end;

  private macro EvProc (rs, cmd1, id, key )
     private var rs10,rs05,rs31,delta,paymid;
     var query, base_paym_od, base_paym, base_paymentid_od, base_paymentid, fiid, fiid_base_paym, new_paym, new_paymid;

     if (cmd1 == DLG_INIT)	// Инициализация
        rs.MoveFirst();          

        if (pId != "0")  // Надо найти запись
           while ( (rs.value ("pId") != pId) And (Not rs.EOF) )  
              rs.Move(1, RELATIVE);
            end;
        end;
        GoToScroll(rs, true);


     elif (cmd1 == DLG_KEY)
        pId=rs.value ("pId");

 
        if(DLG_KEY_ENTER == Key) // Редактирование платежа  

           if(26 != ValType(rs.value(0))) // Только если есть данные в скроллинге
              Histpaym1(rs.value ("pId"));
              if( OpenPaymentDlg(idSde, legidid, rs.value ("pdat"),rs.value ("pId"), rs.value ("psumma"), rs.value ("fi"), CorrectFlag) )
                 Histpaym2(rs.value ("pId"));
                 return CM_SELECT;
              else
                 return CM_IGNORE;
              end;
           end;

        elif(DLG_KEY_SHIFT_F2 == Key) 
            que = "update ddl_tick_dbt SET t_numberpack = 0  where t_dealid = "+idsde; 
            rs31 = LnGetRecordSet(que);
            return CM_SELECT;
           

        elif(DLG_KEY_F3 == Key) 
          if (userGraphFlag)
             mm_OpenDealDlg(idsde,1,0);
             if (zsdell(idsde,"flag3") == "X")
                sdelka_mm_op(idsde);
             end;
          end;
          return CM_SELECT;

        elif(DLG_KEY_F6 == Key) 
          datv=date(rs.value ("pdatv"));
          getdate(datv,"Введите дату валютирования платежа",10);
          que = "update dpmpaym_dbt SET  t_userfield2='"+СДАТ(datv)+"' where t_paymentid = "+rs.value ("pId"); 
          rs05 = LnGetRecordSet(que);
          return CM_SELECT;

        elif(DLG_KEY_F5 == Key) 
          datv=date(rs.value ("pdatv"));
          getdate(datv,"Введите дату платежа",10);
          que = "update dpmpaym_dbt SET  t_userfield1='"+СДАТ(datv)+"' where t_paymentid = "+rs.value ("pId"); 
          rs05 = LnGetRecordSet(que);
          return CM_SELECT;

        elif(DLG_KEY_SHIFT_F8 == Key) 
          que = "update dpmpaym_dbt SET  t_documentid=0 where t_paymentid = "+rs.value ("pId"); 
          rs05 = LnGetRecordSet(que);
          return CM_SELECT;

        elif(DLG_KEY_F8 == Key) // Удаление добавленного ранее перевода 
           if( DelAddedPayment(rs.value ("pId")) )
              return CM_SELECT;
           else
              return CM_DEFAULT;
           end;

//         elif((DLG_KEY_F11 == Key) and ("J" == StrFor(GetIdentProgram())))
         elif(DLG_KEY_F11 == Key) 
		   if (userGraphFlag)
			ПересчетПроцентовПоГрафику2(idsde);
		   end;
           return CM_SELECT;

        elif(DLG_KEY_F9 == Key)
           /*
           subpu=string(sdelka_new(idsde,10));
           sql2="select a.t_valuedate  pdat , c.t_shortname ptip , replace(to_char(a.t_baseamount,'999,999,999,999.99'),',', '''') psum, a.t_paymentid pnum, (select u1.t_ccy from dfininstr_dbt u1 where u1.t_fiid= a.t_fiid ) pval, (select u2.t_shortname from dparty_dbt u2 where u2.t_partyid=a.t_payer) potp , (select u2.t_shortname from dparty_dbt u2 where u2.t_partyid=a.t_payerbankid)  pbotp, (select u2.t_shortname from dparty_dbt u2 where u2.t_partyid=a.t_receiver)  ppol, (select u2.t_shortname from dparty_dbt u2 where u2.t_partyid=a.t_receiverbankid)  pbpol , (select u3.t_shortname from dpmstatus_dbt u3 where u3.t_type=0 and u3.t_paymstatus=a.t_paymstatus ) pstat , a.t_fiid fiid, a.t_paymentId pId,  a.t_reserv1 ssh, a.t_paymentid ppaymentid   from dpmpaym_dbt a, dpmrmprop_dbt b, dpmpurp_dbt c  where a.t_purpose=10 and a.t_subpurpose= '"+subpu+"' and t_dockind=102 and t_documentid = '"+string(idsde)+"' and c.t_purpose=a.t_purpose and  b.t_paymentid=a.t_paymentid ";
           rs10 = LnGetRecordSet(sql2);
           if(rs10 != null)
           if (rs10.moveNext)
           OpenPaymentDlg(idSde, legidid, rs10.value(0), rs10.value(11), rs10.value(2), rs10.value(10), CorrectFlag); 
           OpenPaymentDlg(idSde, legidid, rs.value ("pdat"),rs.value ("pId"), rs.value ("psumma"), rs.value ("fi"),CorrectFlag) 
           */
           
           /*Ищем базовый платеж по погашению ОД (тот который был создан при создании сделки), так как с него будем брать основную информацию для нового платежа*/
           base_paymentid_od = GetBasePaymOD(idsde);
           query = "select t_fiid from dpmpaym_dbt where t_paymentid = " + base_paymentid_od;
           fiid_base_paym = LnGetRecordSet(query);
           if (fiid_base_paym.MoveNext())              
              fiid = fiid_base_paym.value(0);
           end;
           /*SVE 526541 23.04.2021 Функция OpenPaymentDlg не подходит для создания платежа так как она рабоатет с уже существующим платежом, для создания нового платежа корректнее использовать NewPaymentDlg*/
           if (NewPaymentDlg(idsde,legidid, true, base_paymentid_od, fiid))
              if (GetTrue(true, "Корректировать последний платеж ОД ?"))
                 //  ----  корректировака последнего платежа ОД
                 /*ищем наш ново-созданный платеж*/
                 query = "select max(t_paymentid) from dpmpaym_dbt where t_dockind = 102 and t_purpose = 10 and t_documentid =  " + idsde;
                 new_paym = LnGetRecordSet(query);
                 if (new_paym.MoveNext())
                    new_paymid = new_paym.value(0);
                 end;
                 /*ищем сумму ново-введенного платежа*/
                 query = "select t_amount from dpmpaym_dbt where t_paymentid = " + new_paymid;
                 new_paym = LnGetRecordSet(query);
                 if (new_paym.MoveNext())
                    delta = new_paym.value(0);
                 end;
                 /*ищем сумму базового платежа по погашению ОД, которую будем корректировать*/
                 query = "select t_amount from dpmpaym_dbt where t_paymentid = " + base_paymentid_od;
                 base_paym_od = LnGetRecordSet(query);
                 if (base_paym_od.moveNext()) 
                    delta = base_paym_od.value(0) - delta;
                    query = "update dpmpaym_dbt SET t_FUTUREPAYERAMOUNT = '" + delta + "' ,  t_FUTURERECEIVERAMOUNT = '" + delta + "' ,  t_AMOUNT = '" + delta + "' , t_BASEAMOUNT = '" + delta + "' ,  t_PAYAMOUNT ='" + delta + "' ";
                    query = query + " where t_paymentid = '" + base_paymentid_od + "'"; 
                    base_paym_od = LnGetRecordSet(query);
                    if(base_paym_od != null)
                    end;                     
                 end;
                 // --------------------------------------------
              end;
           end;
           return CM_SELECT;
        elif(DLG_KEY_F7 == Key)
           /*
           subpu=string(sdelka_new(idsde,11));
           sql2="select to_char(a.t_valuedate,'dd.mm.yyyy')  pdat , c.t_shortname ptip , replace(to_char(a.t_baseamount,'999,999,999,999.99'),',', '''') psum, a.t_paymentid pnum, (select u1.t_ccy from dfininstr_dbt u1 where u1.t_fiid= a.t_fiid ) pval, (select u2.t_shortname from dparty_dbt u2 where u2.t_partyid=a.t_payer) potp , (select u2.t_shortname from dparty_dbt u2 where u2.t_partyid=a.t_payerbankid)  pbotp, (select u2.t_shortname from dparty_dbt u2 where u2.t_partyid=a.t_receiver)  ppol, (select u2.t_shortname from dparty_dbt u2 where u2.t_partyid=a.t_receiverbankid)  pbpol , (select u3.t_shortname from dpmstatus_dbt u3 where u3.t_type=0 and u3.t_paymstatus=a.t_paymstatus ) pstat , a.t_fiid fiid, a.t_paymentId pId,  a.t_reserv1 ssh, a.t_paymentid ppaymentid   from dpmpaym_dbt a, dpmrmprop_dbt b, dpmpurp_dbt c  where a.t_purpose=11 and a.t_subpurpose= '"+subpu+"' and t_dockind=102 and t_documentid = '"+string(idsde)+"' and c.t_purpose=a.t_purpose and  b.t_paymentid=a.t_paymentid ";
           rs10 = LnGetRecordSet(sql2);
           if(rs10 != null)
             if (rs10.moveNext) 
                OpenPaymentDlg(idSde, legidid, rs10.value(0), rs10.value(11), rs10.value(2), rs10.value(10), CorrectFlag); 
                paymid=(par_plat(rs10.value("ppaymentid"),"paymentid"));
                que="update dpmpaym_dbt SET t_paymstatus=1000  where t_paymentid = "+paymid; 
                rs31 = LnGetRecordSet(que);
             end;
           end;
           */

           /*Создаем новый платеж по процентам*/
           /*Ищем базовый платеж по процентам (тот который был создан при создании сделки), так как с него будем брать основную информацию для нового платежа*/
           query = "select min(t_paymentid), t_fiid from dpmpaym_dbt where t_dockind = 102 and t_purpose = 11 and t_documentid = " + idsde + " group by t_fiid";
           base_paym = LnGetRecordSet(query);
           if (base_paym.MoveNext())
              base_paymentid = base_paym.value(0);
              fiid = base_paym.value(1);
           end;
           /*SVE 526541 23.04.2021 Функция OpenPaymentDlg не подходит для создания платежа так как она рабоатет с уже существующим платежом, для создания нового платежа корректнее использовать NewPaymentDlg*/
           NewPaymentDlg(idsde,legidid, true, base_paymentid, fiid);
       
           return CM_SELECT;
        elif(DLG_KEY_F10 == Key)
           /*   
           subpu=string(sdelka_new(idsde,9));
           sql2="select a.t_valuedate  pdat , c.t_shortname ptip , replace(to_char(a.t_baseamount,'999,999,999,999.99'),',', '''') psum, a.t_paymentid pnum, (select u1.t_ccy from dfininstr_dbt u1 where u1.t_fiid= a.t_fiid ) pval, (select u2.t_shortname from dparty_dbt u2 where u2.t_partyid=a.t_payer) potp , (select u2.t_shortname from dparty_dbt u2 where u2.t_partyid=a.t_payerbankid)  pbotp, (select u2.t_shortname from dparty_dbt u2 where u2.t_partyid=a.t_receiver)  ppol, (select u2.t_shortname from dparty_dbt u2 where u2.t_partyid=a.t_receiverbankid)  pbpol , (select u3.t_shortname from dpmstatus_dbt u3 where u3.t_type=0 and u3.t_paymstatus=a.t_paymstatus ) pstat , a.t_fiid fiid, a.t_paymentId pId,  a.t_reserv1 ssh, a.t_paymentid ppaymentid   from dpmpaym_dbt a, dpmrmprop_dbt b, dpmpurp_dbt c  where a.t_purpose=9 and a.t_subpurpose= '"+subpu+"' and t_dockind=102 and t_documentid = '"+string(idsde)+"' and c.t_purpose=a.t_purpose and  b.t_paymentid=a.t_paymentid ";
           rs10 = LnGetRecordSet(sql2);
           if(rs10 != null)
             if (rs10.moveNext) 
                 OpenPaymentDlg(idSde, legidid, rs10.value(0), rs10.value(11), rs10.value(2), rs10.value(10), CorrectFlag); 
                 //   OpenPaymentDlg(idSde, legidid, rs.value ("pdat"),rs.value ("pId"), rs.value ("psumma"), rs.value ("fi"), CorrectFlag) 
           */

           /*Создаем новый платеж по предоставлению средств*/
           /*Ищем базовый платеж по предоставлению средств (тот который был создан при создании сделки), так как с него будем брать основную информацию для нового платежа*/
           query = "select min(t_paymentid), t_fiid from dpmpaym_dbt where t_dockind = 102 and t_purpose = 9 and t_documentid = " + idsde + " group by t_fiid";
           base_paym = LnGetRecordSet(query);
           if (base_paym.MoveNext())
              base_paymentid = base_paym.value(0);
              fiid = base_paym.value(1);
           end;
           /*SVE 526541 23.04.2021 Функция OpenPaymentDlg не подходит для создания платежа так как она рабоатет с уже существующим платежом, для создания нового платежа корректнее использовать NewPaymentDlg*/
           if (NewPaymentDlg(idsde,legidid, true, base_paymentid, fiid))
              if (GetTrue(true, "Корректировать последний платеж ОД ?"))
                 //  ----  корректировака последнего платежа ОД
                 /*ищем наш ново-созданный платеж*/
                 query = "select max(t_paymentid) from dpmpaym_dbt where t_dockind = 102 and t_purpose = 9 and t_documentid =  " + idsde;
                 new_paym = LnGetRecordSet(query);
                 if (new_paym.MoveNext())
                    new_paymid = new_paym.value(0);
                 end;
                 /*ищем сумму ново-введенного платежа*/
                 query = "select t_amount from dpmpaym_dbt where t_paymentid = " + new_paymid;
                 new_paym = LnGetRecordSet(query);
                 if (new_paym.MoveNext())
                    delta = new_paym.value(0);
                 end;
                 /*Ищем базовый платеж по погашениб ОД, который будем корректировать*/
                 base_paymentid_od = GetBasePaymOD(idsde);
                 /*ищем сумму базового платежа по погашению ОД, которую будем корректировать*/
                 query = "select t_amount from dpmpaym_dbt where t_paymentid = " + base_paymentid_od;
                 base_paym_od = LnGetRecordSet(query);
                 if (base_paym_od.moveNext()) 
                    delta = base_paym_od.value(0) + delta;
                    query = "update dpmpaym_dbt SET t_FUTUREPAYERAMOUNT = '" + delta + "' ,  t_FUTURERECEIVERAMOUNT = '" + delta + "' ,  t_AMOUNT = '" + delta + "' , t_BASEAMOUNT = '" + delta + "' ,  t_PAYAMOUNT ='" + delta + "' ";
                    query = query + " where t_paymentid = '" + base_paymentid_od + "'"; 
                    base_paym = LnGetRecordSet(query);
                    if(base_paym != null)
                    end;                     
                 end;
                 // --------------------------------------------
              end;
           end;
           return CM_SELECT;
        elif(DLG_KEY_SHIFT_F12 == Key) 
                     ss=string(rs.value ("pnum"));
                     if ( rs.value ("pstat") == "Закрыт")

                        que = "update dpmpaym_dbt SET t_paymstatus = 1000  where t_paymentid = '"+ss+"'";
                     else
                        que = "update dpmpaym_dbt SET t_paymstatus = 32000  where t_paymentid = '"+ss+"'";
                     end;
        	     rs2 = LnGetRecordSet(que);
                     return CM_SELECT;
        elif(DLG_KEY_F12 == Key)
                     // prog_ps(idsde,0);
                     execmacrofile("mm_ps.mac", "prog_ps",idsde,0) ;

                     return CM_SELECT;

        end;
     end;


  end;

  AddCol (col1, 0, "pdatr", "Дата расчета", 11);
  AddCol (col1, 1, "pdat",  "Дата платежа", 11);
  AddCol (col1, 2, "pdatv",  "Дата валютирования", 15);
  AddCol (col1, 3, "ptip",  "Тип", 15);
  AddCol (col1, 4, "psum",  "Сумма", 15);
  AddCol (col1, 5, "pval",  "Вал", 3);

  AddCol (col1, 6, "potp",  "Плательщик", 12);
  AddCol (col1, 7, "pbotp",  "Банк плат-ка", 12);
  AddCol (col1, 8, "ppol",  "Получатель", 12);
  AddCol (col1, 9, "pbpol",  "Банк получ.", 12);
  AddCol (col1, 10, "pstat",  "Статус", 15);
  AddCol (col1, 11, "pnum",  "Номер", 5);




  while( RunScroll(cmd1, 12, col1, null, @EvProc, "Платежи по сделке "+ zsdell(idsde,"dealcode")+" от "+СДАТ(zsdell(idsde,"dealdate")) +",   "+NAMI(zsdell(idsde,"partyid")), status, null, 0, 1) )
     cmd1 = RSDRecordset(sql , RSDVAL_CLIENT, RSDVAL_STATIC );
  end;
//  exit(1);

end;
