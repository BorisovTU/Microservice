import "cnv_main.mac", "cnv_error.mac", PTInter, dl_depo,funk,fx_globals;

/*////////////////////////////////////////
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!á†£‡„ß™† ·§•´Æ™ åÅä!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
*/////////////////////////////////////////

file CD       () txt 1024;         // ContractData - §†≠≠Î• Æ §Æ£Æ¢Æ‡†Â
file PD       () txt 1024;         // PlatData - §†≠≠Î• Æ Ø´†‚•¶†Â
file Report1  () txt 1024 write;   // ÇÎ¢Æ§ Ø‡•§¢†‡®‚•´Ï≠ÎÂ ‡•ß„´Ï‚†‚Æ¢


/*´Æ™†´Ï≠Î• ‰„≠™Ê®®*/
macro toRep1 (str)
   var stat = false;
   if(trim(str)!="")
      stat  = Insert(Report1, str);
   end;
   return stat;

end;

macro RepHeader(dt, tm, oper)
   var str;

   str =     "                             éíóÖí é áÄÉêìáäÖ ëÑÖãéä åÅä Ç RS-BANK V6.0\n";
   str = str+"\n";
   str = str+"Ñ†‚† ß†£‡„ß™®  : "+dt+"\n";
   str = str+"Ç‡•¨Ô ß†£‡„ß™® : "+tm+"\n";
   str = str+"éØ•‡†Ê®Æ≠®·‚   : "+oper+"\n";   
   str = str+"⁄ƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n";
   str = str+"≥ ≥ID                          ≥ÑÆ£Æ¢Æ‡ ¸         ≥Ç®§ Æ°·´„¶®¢†≠®Ô  ≥Ñ†‚† ≠†Á†´†   ≥Ñ†‚† Æ™Æ≠Á†≠®Ô≥çÆ¨•‡ ·Á•‚†                 ≥\n";
   str = str+"√ƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";
   toRep1(str);                                                                                                   
end;                                                                                 
                                                                                     
macro RepFooter(suc, er, tot)                                                       
   var str = "¿ƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ\n";
   str = str+"á†£‡„¶•≠Æ „·Ø•Ë≠Æ: "+suc+"\n";               
   str = str+"ç• ß†£‡„¶•≠Æ     : "+er+"\n";
   str = str+"Ç·•£Æ            : "+tot+"\n";
   toRep1(str);
end;

macro RepStr(_err   ,
             _code  ,
             _contr ,
             _kind  ,
             _beg   ,
             _end   ,
             _acc   )

var str = "≥"+string(_err   :1)   +"≥"+
              string(_code  :28:l)+"≥"+
              string(_contr :18:l)+"≥"+
              string(_kind  :18:l)+"≥"+
              string(_beg   :14:l)+"≥"+
              string(_end   :14:l) +"≥"+
              string(_acc   :28:l) +"≥";
   return toRep1(str);
end;



/******!!!!! éëçéÇçéâ äãÄëë !!!!!******/

class (Main_convert) Convert_MBKDeal()

   var CDFN; // = "..\\IMPORT\\SDEL.TXT";
   var CDFNMask = "..\\IMPORT\\SDEL*.TXT";

   var PLAT;  // = "..\\IMPORT\\PLAT.TXT";
   var PLATMask = "..\\IMPORT\\PLAT*.TXT";


   var ProcDate     = {curdate};
   var ProcTime     = Time();
   var ProcTimeFile = GetTimeInString(ProcTime, ".");

   // ØÆ „¨Æ´Á†≠®Ó ·Á®‚†•¨, Á‚Æ ÆË®°Æ™ ¢ ‚•™·‚• ≠•‚, ≠Æ •·´® Á‚Æ - ·‡†ß„ ®ß¨•≠®¨

   var success = 0;
   var error   = 0;
   var total   = 0;
   var ptotal  = 0;

   private var CONTRavarr     = Tarray;            // -1 Æ‚ ß†ØÆ´≠•≠≠Æ£Æ ¢ ·Ø‡†¢ÆÁ≠®™•
   private var CONTRavstr     = "1|2";

   DM = true;

//è´†‚•¶®
   var PDEALID;  
   var PTYPE;    
   var PRDATE;   
   var PVDATE;   
   var PAMOUNT;  
   var PFIID;    
   var POBANK;   
   var POACCOUNT;
   var PPBANK;   
   var PPACCOUNT;


   var count = 0;

   private macro ParcePossibleArrays()
      
   ParceArray(CONTRavarr, CONTRavstr, "|");
   end;


//    1. á†£‡„¶†•¨ ‰†©´Î
   private macro OpenFiles()
      if (
          SelectFile( CDfn,  CDfnMask, "ÇÎ°•‡®‚• ®·ÂÆ§≠Î© ‰†©´ ëÑÖãéä"              ) and 
          SelectFile( PLAT,  PLATMask, "ÇÎ°•‡®‚• ®·ÂÆ§≠Î© ‰†©´ èãÄíÖÜÖâ"            ) and 
          Open      ( CD      , CDfn                                       ) and
          Open      ( PD      , PLAT                                       ) and
//          Open      ( Report2 , CDfn+"."+ProcDate+"-"+ProcTimeFile+".fin"     ) and
          Open      ( Report1 , CDfn+"."+ProcDate+"-"+ProcTimeFile+".rep"     )  )
          RepHeader (ProcDate, Proctime, {oper});
         return true;
      else
         return false;
      end;
   end;

   private macro CloseFiles(sucess,error,total)
      RepFooter(success,error,total);
      Close   (CD);
      Close   (PD);
      Close   (Report1);
      Viewfile(Report1);
         return true;
   end;


   private macro Codefiid(par1)
      var nrez=0,rs50,que;
      que="select t_code_currency from daccount_dbt where t_account='"+par1+"'";
      rs50 = LnGetRecordset(que);
      if(rs50 != null)
        if (rs50.moveNext) 
          nrez=int(rs50.value(0));
        end;
      end;

      return(nrez);
   end;


  MACRO ëÑÄí(par1);
    private var rez;
    rez=substr(string(par1),1,10);   
    if ( substr(rez,1,1) == " ")
       rez="0"+substr(rez,2);
    end;
    return rez;
 end;


// ·Á®‚Î¢†≠®• ™Æ´®Á•·‚¢† ·‚‡Æ™ ¢ ‰†©´•
   private macro GetQuantity()
      while(Next(CD))
         strquantity = strquantity+1;
      end;
      rewind(CD);
   end;


Macro FormatDate(params)
    Private var newdata;
    if (strlen(params) > 1 )
      newdata=substr(params,1,2)+"."+substr(params,4,2)+".20"+substr(params,7,2);
    else
      newdata=params;
    end;
    return newdata;
End;


private macro Codeparty(par1,par2)
      var nrez="",rs50,que;
      que="SELECT nvl(sum(t_objectid),0) FROM dobjcode_dbt where t_code='"+par1+"' and t_codekind="+par2;

      nrez = (-1);
      rs50 = LnGetRecordset(que);
      if(rs50 != null)
        if (rs50.moveNext) 
          nrez=int(rs50.value(0));
        end;
      end;

      return(nrez);
   end;

   private macro Nparty(par1)
      var nrez=" ",rs50,que;
      que="SELECT t_shortname FROM dparty_dbt where t_partyid="+par1;
      rs50 = LnGetRecordset(que);
      if(rs50 != null)
        if (rs50.moveNext) 
          nrez=rs50.value(0);
        end;
      end;

      return(nrez);
   end;


   private macro forma0(parm0)
     var nid,kk2;
     nid=parm0;
     kk2=index(nid,"=");
     if ( kk2 > 0 )
       nid=substr(nid,kk2+1);
     end;
     return nid;
   end;

   macro dopi(pa1)
    private var jk=0,nns=0,kk,pa0;
    pa0=pa1;
    while (jk < 6 )
      kk=index(pa0,"/");
      if (kk > 0)
         pa0=substr(pa0,kk+1);
         nns=nns+1;
      end;
      jk=jk+1;
    end;
    return nns;
   end;

   private macro RetFilNum(FNum)

     if( FNum == "0")
   	return 1; 
     else	
   	return Int(FNum); 
     end;

   end;


   private macro Sdel_number(parm0)
     var nid,kk2;
     nid=parm0;
     kk2=index(nid,"àß¢•È•≠®• Å†≠™† êÆ··®® ¸");
     if ( kk2 > 0 )
       nid=substr(nid,kk2+25);
     else
       nid="0";
     end;

     kk2=index(nid," ");
     if ( kk2 > 0 )
       nid=substr(nid,1,kk2);
     end;
     return nid;
   end;



   /*ëóàíõÇÄçàÖ à éÅêÄÅéíäÄ ÑÄççõï CÑÖãéä*/

private macro ReadContentDeal()
      var stat;
      var str,que, rs1, rs0,vari,dat2,numb,numb0;
      var acc = tarray;

      var ob = TRecHandler ("deal", MakeArDeal());
      total = 0;
      que="select a.t_paymentid paymentid,to_char(a.t_valuedate,'dd.mm.yyyy') valuedate,a.t_baseamount amount ,b.t_ground ground from dpmpaym_dbt a , dpmrmprop_dbt b where a.t_dockind=322 and a.t_paymstatus=2990  and  substr(a.t_payeraccount,1,5) = '32002' and a.t_payerbankid="+_BANK_RF+ " and b.t_paymentid=a.t_paymentid";
      rs1 = LnGetRecordset(que);
      if (rs1 != null)
        while (rs1.moveNext())
            total = total + 1;
            ob.rec.DEALID    = "0";
            ob.rec.DEALTYPE  = "è";
            ob.rec.SOGL      = "";

            if(GenerateReference(30, numb0) != 0)
            end; 
            ob.rec.vNUMBER    = numb0;
            numb=Sdel_number(rs1.value("ground"));
            if ( numb != "0" )
             ob.rec.NUMBER   = numb;
            else
             ob.rec.NUMBER   = numb0;
            end;
            ob.rec.DEALDATE  = SDAT(rs1.value("valuedate"));
            ob.rec.BEGDATE   = SDAT(rs1.value("valuedate"));
            dat2=date(SDAT(rs1.value("valuedate")))+1;
            ob.rec.ENDDATE   = SDAT(dat2);
            ob.rec.CONTR     = _BANK_RF;
            ob.rec.FILIAL    = 1;
            ob.rec.PRINCIPAL = rs1.value("amount");
            ob.rec.PPRINCIPAL= 0.00;
            ob.rec.PFI       = "RUB";
            ob.rec.PRICE     = 0;
            ob.rec.NEWPRICE  = 0;
            ob.rec.PSLONG    = 0;
            ob.rec.BASIS     = "ACT/ACT";
            ob.rec.PPRICE    = "";
            ob.rec.DINDEX    = "";
            ob.rec.TRADER    = "";
            ob.rec.ACCOUNT   = "";
            ob.rec.PACCOUNT  = "";
            ob.rec.RACCOUNT  = "";
            ob.rec.RPACCOUNT = "";
            ob.rec.POB       = "";
            ob.rec.ZCONTRACT = "";
            ob.rec.ZNCONTRACT = "";
            ob.rec.OBAMOUNT  = 0;
            ob.rec.ZACCOUNT  = "";
            ob.rec.PPROLONG  = "";
            ob.rec.PDATE     = "";
            ob.rec.PMPRICE = -1;
            ob.rec.DPLAMOUNT = 0;
            ob.rec.SROK = 0;
            ob.rec.PRACCOUNT = "";
            ob.rec.PRPACCOUNT= "";
            ob.rec.COMMENT   = rs1.value("ground");

            if(not Err.IsError)
               success = success + 1;
            else
               error = error + 1;
            end;

            if (not Err.IsError)
                MSGBOX(ob.rec.vNUMBER);
                if  (_MoneyMarketDeal_CreateNew(ob) == 1)
                   error = error + 1;
                end;
            end;

            RepStr(iif(Err.IsError, "!", ""),
                   ob.rec.DEALID,
                   ob.rec.NUMBER,
                   iif(ob.rec.DEALTYPE == "è", "è‡®¢´•Á•≠®•", "ê†ß¨•È•≠®•"),
                   ob.rec.BEGDATE,
                   ob.rec.ENDDATE,
                   ob.rec.ACCOUNT);


            toRep1(Err.Rep());
            Err.Show();
            Err.ClearGlobal();
            UseProgress(total);

        end;
      end;


   end;


/*‚ÆÁ™† ¢ÂÆ§†*/
   macro Main()

         strquantity=10;
         InitProgress(strquantity,"èÆ§Æ¶§®‚•...", "á†£‡„ß™† ·§•´Æ™ åÅä");
         ReadContentDeal();
         RemProgress();
   end;
   InitMain_Convert();

end;


   var II0, ConvMBKDeal;

     ConvMBKDeal = Convert_MBKDeal();
     ConvMBKDeal.Main();
     exit(1);
 END;