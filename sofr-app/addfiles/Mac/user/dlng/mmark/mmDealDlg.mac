import dl_plib,oralib, likepy,fxPaymentDlg, fiInfo, dlgCommon, fxDealInfo, Календарь, SqlVBuilder, DateLib, StringLib, PartyInfo;


// Используемые записи
private record mmDeal (mbk,"monit.lbr") dialog;         // Панель диалога Сделки МБК
private record r_fi (fininstr, "bank.def");             // Запись финансового инструмента

private record r_accR ("account.dbt", "bank.def");      // Запись счетов
private record r_accC ("account.dbt", "bank.def");     // Запись валютных счетов
private var g_r_acc = r_accR;                           // Указатель на запись счетов (меняется по контексту с рублёвого на валютный)
private record r_party(party, "bank.def");              // Запись субъектов экономики


// Параметры оплаты по графику
private record dlgGrParams (mbk_gr, "monit.lbr") dialog;// Панель параметров сделки МБК (оплата по графику и плавающая % ставка)
private var g_IsRateTable = false;                      // Признак, используется ли таблица процентных ставок
private var g_index = -1;                               // id Индекса для плавающей ставки
private var g_dtType = 1;                               // id типа дат, относительно которой будут считаться курсы при плавающй ставке
private var g_correct = 0;                              // Корректировка %%
private var g_cntDate = 0;                              // Кол-во дней при смещении
private var g_pcType  = 0;                              // Тип %% (0 - фиксированный с оплатой в конце, 1 - плавающая % ставка, 2 - стандартная таблица ставок)
private var g_odDay = 0, g_odSum = 0, g_odDelay = 0,    // Поля таблицы dMmPyaMode_dbt
            g_pcDay = 0, g_pcSum = 0, g_pcDelay = 0,
            g_odPayType = 0, g_pcPayType = 0, g_OpenDeal = 0, g_subcredit = 0;

private var g__IsRateTable, g__index, g__dtType,  g__correct, g__cntDate, g__pcType;
private var g__odDay, ls, g__odSum, g__odDelay, g__pcDay, g__pcSum, g__pcDelay, g__odPayType, g__pcPayType;



private var g_bIsOverDraft = true, g_dopsogl = false;                      // Признаак "Договор овердрафт МБК"


// Наборы данных
private var rsDeal, rsLeg;      // Наборы данных с данными по сделке
private var rsMode,idid;             // Набор данных с данными по способу оплаты сделки МБК

// Данные по сделке в целом
private var g_bIsNewDeal=false; // Признак открытия формы сделки на добавление новой сделки

private var g_typeDoc;          // Тип сделки:
private var g_dealer = -1;      // Дилер
private var g_broker = -1;      // Брокер
private var g_portfolioId = 0;  // Id портфеля
private var g_dealId = null;    // Id сделки
private var g_legId  = null;    // Id транша сделки
private var g_dealDate = null;  // Дата сделки
private var g_maturity = null;  // Дата завершения сделки (планового возврата кредита)
private var g_factMaturity = null;// Дата фактического (досрочного) возврата кредита
private var g_start = null;     // Дата выдачи средств (кредита)
private var g_dealCode = null;  // Код сделки
private var g_dealCodeTs = null;// Код сделки в торговой системе
private var g_gensoglId = -1;   // Id генсоглашения в таблице договоров
private var g_zalogId = -1;     // Id договора залога в таблице договоров
private var g_firstStart = null;// Дата первой сделки в цепочке пролонгаций

private var g_creditor = -1;    // Кредитор
private var g_borrower = -1;    // Заёмщик


private var g_dealSum  = 0;     // Сумма привлечения/размещения
private var g_fiid     = 0;     // Валюта сделки
private var g_percent  = 0;     // Процентная ставка по кредиту
private var g_resSum   = 0;     // Сумма к возврату
private var g_fullBasis= 4;     // Id базиса начисления (Act/Act)

private var g_contr    = -1;    // Id контрагента по сделке

private var g_credPlaceIn;      // Id места зачисления кредитора
private var g_credPlaceOut;     // Id места списания кредитора
private var g_credPlaceInPc;    // Id места зачисления %% кредитора
private var g_borrPlaceIn;      // Id места зачисления заёмщика
private var g_borrPlaceOut;     // Id места списания заёмщика
private var g_borrPlaceOutPc;   // Id места списания %% заёмщика

private var g_credAccLoan =null;// Ссудный счёт кредитора
private var g_credAccPlus =null;// Доходный счёт кредитора
private var g_borrAccLoan =null;// Ссудный счёт заёмщика
private var g_borrAccMinus=null;// Расходный счёт заёмщика

private var g_schemaCin = -1;   // Id схемы кредитора при зачислении
private var g_schemaCout= -1;   // Id схемы кредитора при списании
private var g_schemaCinPc= -1;  // Id схемы кредитора при зачислении %%
private var g_schemaBin = -1;   // Id схемы заёмщика при зачислении
private var g_schemaBout= -1;   // Id схемы заёмщика при списании
private var g_schemaBoutPc= -1; // Id схемы заёмщика при списании %%

private var newd,reda, g__dealDate, g__start, g__maturity, g__dealSum, g__dealPercent, g__basis, g__BrokerTax; // Временные (предыдущ. значение)
private var g_old_CheckAHead = "", g_old_factMaturity = "",g_pcSum0,g_pcPayType0,g_pcDay0,g_pcDelay0,g_odSum0,g_odPayType0,g_odDay0,g_odDelay0;


// Типы сделок

private var aDealTypes = TArray(3);

aDealTypes(0) = "Размещение ";
aDealTypes(1) = "Привлечение ";

// aDealTypes(0) = "Размещение МБК";
// aDealTypes(1) = "Привлечение МБК";


private const МБК_Размещение  = 0;
private const МБК_Привлечение = 1;
private var g_dealType = МБК_Размещение;


private macro IsDealStatus(DealID, DealStatus)
   var sql = "select count(*) t_cnt from ddl_tick_dbt where t_DealID = :DealID and t_DealStatus = :DealStatus";
   sql = ExecSQLSelect(sql, MakeArray(SQLParam("DealID", DealID), SQLParam("DealStatus", DealStatus)), false);
   return (sql.MoveNext() and sql.value("t_cnt"));
end;




private macro ListDtTypeEvProc (dlg, cmd, id, key )
   if ( DLG_INIT == cmd )

   elif ( DLG_KEY == cmd )
      if(DLG_KEY_ENTER == Key)   // Сохранение по F9
        return CM_SELECT;
      end;
   end;

   return CM_DEFAULT;
end;


private macro ListDtType(dtTypeId, dtTypeName)


   var sql = "select * FROM dnamealg_dbt where t_iTypeAlg=2625";

   var rs = ExecSQLSelect(sql, null, false, RSDVAL_CLIENT, RSDVAL_STATIC);

   var col = TArray();
   private var period,i,j,dizm,ds,pa1,pa2;
   private array mas5;

            period=substr(GetAlgorithmName(2625, g_dtType),1,4);
            ds=ДАТ(g_start);
            dizm=ds;
            newd=dizm;
            pa2=GetAlgorithmName(2625, g_dtType);
            pa1=g_dtType;

        j=0;
       while (j == 0 )
           mas5(0)="  Дата начала периода по плавающей ставке : "+СДАТ(dizm);
           mas5(1)="  Смена периода                           : "+period;
           mas5(2)="  Подтверждение                             ";
           i=menu(mas5," ESC - отмена, <Enter> - Ввод параметров ", "Введите праматры по периоду плавающей ставки ");
          if (i == 0 )
            getdate(dizm,"Введите дату начала периода по плавающей ставке:");

             IF (dizm < ds )
                  MSGBOX(dizm," - дата меньше  даты выдачи МБК ! ");
                  dizm=ds;
             END;

            newd=dizm ;

          elif (i == 1 )
//  ---------------------------------------

   AddCol (col, 0, "t_iNumberAlg",  "№", 2, true);
   AddCol (col, 1, "t_szNameAlg",   "Дата", 12, true);

   if(RunScroll (rs, 2, col, "ListDtTypeScroll", @ListDtTypeEvProc, "Период смены процентной ставки",
                "~ESC~ выход, ~Enter~ выбор", true, 13, 12, 26, 10) )
      period=substr(rs.value("t_szNameAlg"),1,4);
      pa1=rs.value("t_iNumberAlg");
      pa2=rs.value("t_szNameAlg");

   end;

//  --------------------------------------
          elif (i == 2 )
            j=2;

            SetParm(0, pa1);
            SetParm(1, СДАТ(newd)+" "+pa2);
            return true;

          elif (i < 0 )
            j=2;
            return false;

         end;
       end;



end;







private macro SaveGraph()
   var sql  =  " merge into dMmPayMode_dbt pm  "
          +"     using (select :dealId t_dealId, :odPayType t_odPayType, :odDay t_odDay, :odSum t_odSum, :odDelay t_odDelay,  "
          +"         :pcPayType t_pcPayType, :pcDay t_pcDay, :pcSum t_pcSum, :pcDelay t_pcDelay from dual) sel on (pm.t_dealId = sel.t_dealId)  "
          +" when matched then update set pm.t_odPayType = sel.t_odPayType, pm.t_odDay = sel.t_odDay, pm.t_odSum = sel.t_odSum, pm.t_odDelay = sel.t_odDelay,  "
          +"     pm.t_pcPayType = sel.t_pcPayType, pm.t_pcDay = sel.t_pcDay, pm.t_pcSum = sel.t_pcSum, pm.t_pcDelay = sel.t_pcDelay  "
          +"     where pm.t_dealId = sel.t_dealId  "
          +" when not matched then insert (pm.t_dealId, pm.t_odPayType, pm.t_odDay, pm.t_odSum, pm.t_odDelay, pm.t_pcPayType, pm.t_pcDay, pm.t_pcSum, pm.t_pcDelay)  "
          +" values (sel.t_dealId, sel.t_odPayType, sel.t_odDay, sel.t_odSum, sel.t_odDelay, sel.t_pcPayType, sel.t_pcDay, sel.t_pcSum, sel.t_pcDelay); " ;
   //msgbox(sql);
   //msgbox(g_dealId, " - ", g_odPayType, " - ", g_odDay, " - ", g_odSum, " - ", g_odDelay, " - ", g_pcPayType, " - ", g_pcDay, " - ", g_pcSum, " - ", g_pcDelay);
   var params = MakeArray(SQLParam("dealId", g_dealId), SQLParam("odPayType", g_odPayType), SQLParam("odDay", g_odDay), SQLParam("odSum", g_odSum), SQLParam("odDelay", g_odDelay),
        SQLParam("pcPayType", g_pcPayType), SQLParam("pcDay", g_pcDay), SQLParam("pcSum", g_pcSum), SQLParam("pcDelay", g_pcDelay));

   var res = ExecSQL(sql, params, false);
   if(null == res)
      MsgBox("Ошибка записи параметров графика оплаты");
      return false;
   end;

   return true;
end;


//
// Процедура обработки событий скроллинга типов сделок
//
private macro DealTypeEvProc(rs, cmd, id, key)
  if (cmd == DLG_INIT)
     rs.MoveFirst();
     GoToScroll(rs, true);
  elif (cmd == DLG_KEY)
     if(DLG_KEY_ENTER == Key)     // Выбрать тип
        if(g_bIsNewDeal)
           return CM_SELECT;
        end;

        MsgBox("Смена типа сделки недопустима!");
        return CM_CANCEL;
     end;
  end;

  return CM_DEFAULT;
end;






//
// Сохранение предварительных данных перед отображением формы
//
private macro PreSave()
   // Если платежи не были заполнены -- предварительное заполнение данными со схемы по умолчанию
   var sql = " select * from ddl_tick_dbt t "
           + " inner join dPmPaym_dbt p "
           + " on p.t_documentId=t.t_dealId and t.t_dealId=:dealId and t.t_bOfficeKind=102  and p.t_docKind=t.t_bOfficeKind ";

   var params = MakeArray(SQLParam("dealId", g_dealId));
   var rs = ExecSQLSelect(sql, params, false);
   while(rs.MoveNext())
      SetDefPmntData(g_dealId, g_legId, rs.value("t_valueDate"), rs.value("t_paymentId"), rs.value("t_baseAmount"), rs.value("t_fiid"));
   end;
end;


//
// Сохранить схемы
//
private macro SaveSchemas()
   var sql = " select * from ddl_tick_dbt t "
           + " inner join dPmPaym_dbt p "
           + " on p.t_documentId=t.t_dealId and t.t_dealId=:dealId and t.t_bOfficeKind=102 and p.t_docKind=t.t_bOfficeKind order by p.t_purpose ";

   var params = MakeArray(SQLParam("dealId", g_dealId));
   var rs = ExecSQLSelect(sql, params, false);

   var accP1=null, accR1=null, accP2=null, accR2=null, accP3=null, accR3=null;


   g_credAccLoan = FormatAccountNum(mmDeal.credAccLoan,  false);
   g_borrAccLoan = FormatAccountNum(mmDeal.borrAccLoan,  false);
   g_borrAccMinus = FormatAccountNum(mmDeal.borrAccMinus,  false);
   g_credAccPlus = FormatAccountNum(mmDeal.credAccPlus,  false);

   accP1 = g_credAccLoan;
   accR1 = g_borrAccLoan;
   accP2 = accR1;
   accR2 = accP1;
   accP3 = g_borrAccMinus;
   accR3 = g_credAccPlus;

   while(rs.MoveNext())
      if(9 == rs.value("t_purpose"))    // Платёж по базовому активу
         SetPmntData(g_dealId, g_legId, rs.value("t_valueDate"), rs.value("t_paymentId"), rs.value("t_baseAmount"), rs.value("t_fiid"),
                 g_schemaCout, g_schemaBin, accP1, accR1);

      elif(10 == rs.value("t_purpose"))         // Платёж по контрактиву
         SetPmntData(g_dealId, g_legId, rs.value("t_valueDate"), rs.value("t_paymentId"), rs.value("t_baseAmount"), rs.value("t_fiid"),
                 g_schemaBout, g_schemaCin, accP2, accR2);

      elif(11 == rs.value("t_purpose"))         // Платёж по контрактиву
         SetPmntData(g_dealId, g_legId, rs.value("t_valueDate"), rs.value("t_paymentId"), rs.value("t_baseAmount"), rs.value("t_fiid"),
                 g_schemaBoutPc, g_schemaCinPc, accP3, accR3);
      end;
   end;
end;



private macro LastClosedPaymentDate(DealID)
   var sql = "select nvl(max(t_ValueDate), to_date('01.01.0001', 'DD.MM.YYYY')) t_ValueDate from dpmpaym_dbt p where p.t_DocKind = 102 and p.t_DocumentID = :DealID and p.t_PaymStatus = 32000";
   sql = ExecSQLSelect(sql, MakeArray(SQLParam("DealID", DealID)), false);
   if(sql.MoveNext())
     return Date(sql.value("t_ValueDate"));
   end;
end;



// Проверка на то, что в сделке не стоит флаг оплаты процентов помесячно
//
private macro CheckByMonth()
   return true;
end;


//


private macro EvDlgGrParamsProc (dlg, cmd, id, key )
   ClearRecord(r_fi);

   var tmp, tmp2;
   var docId; // Id генсоглашения или договора залога
   var fldCnt = 0;


   if ( DLG_INIT == cmd )


      if(0 == g_odPayType)
         DisableFields(dlgGrParams, FldIndex(dlgGrParams, "OdDay"));
         DisableFields(dlgGrParams, FldIndex(dlgGrParams, "OdSum"));
         DisableFields(dlgGrParams, FldIndex(dlgGrParams, "OdDelay"));
      end;

      if(0 == g_pcPayType)
         DisableFields(dlgGrParams, FldIndex(dlgGrParams, "PcDay"));
         DisableFields(dlgGrParams, FldIndex(dlgGrParams, "PcSum"));
         DisableFields(dlgGrParams, FldIndex(dlgGrParams, "PcDelay"));
      end;

  
      if(true == g_IsRateTable)
         EnableFields(dlgGrParams, FldIndex(dlgGrParams, "rateIndex"));
         EnableFields(dlgGrParams, FldIndex(dlgGrParams, "rateDtType"));
         EnableFields(dlgGrParams, FldIndex(dlgGrParams, "rateDtOffset"));
         EnableFields(dlgGrParams, FldIndex(dlgGrParams, "rateCorrection"));
      else
         DisableFields(dlgGrParams, FldIndex(dlgGrParams, "rateIndex"));
         DisableFields(dlgGrParams, FldIndex(dlgGrParams, "rateDtType"));
         DisableFields(dlgGrParams, FldIndex(dlgGrParams, "rateDtOffset"));
         DisableFields(dlgGrParams, FldIndex(dlgGrParams, "rateCorrection"));
      end;

  /*
      if (zsdell(idid,"dealstatus") > 0 )
         DisableFields(dlgGrParams);
      end;
  */


      UpdateFields(dlgGrParams);
   elif ( DLG_KEY == cmd )
      if( (DLG_KEY_F9 == Key) or (DLG_KEY_F2 == Key) )  // Сохранение по F9 и F2
 
         if((dlgGrParams.odDay < 0) or (dlgGrParams.odDay > 31))
            MsgBox("Дата погашения ОД некорректна!");
            return CM_IGNORE;
         end;
         if((dlgGrParams.pcDay < 0) or (dlgGrParams.pcDay > 31))
            MsgBox("Дата погашения %% некорректна!");
            return CM_IGNORE;
         end;

         if("X" == dlgGrParams.chkRateTable)
            if(-1 == g_index)
               MsgBox("Не выбран индекс");
               return CM_IGNORE;
            end;
         end;

         g_cntDate = dlgGrParams.rateDtOffset;
         g_correct = dlgGrParams.rateCorrection;

         g_odDay = dlgGrParams.odDay;
         g_odSum = FormatSum( dlgGrParams.OdSum, false );
         g_odDelay = dlgGrParams.odDelay;
         if(dlgGrParams.radioOdMonth=="X")
            g_odPayType = 1;
         elif(dlgGrParams.radioOdQuart=="X")
            g_odPayType = 2;
         else
            g_odPayType = 0;
         end;

         g_pcDay = dlgGrParams.pcDay;
         g_pcSum = FormatSum( dlgGrParams.pcSum, false );
         g_pcDelay = dlgGrParams.pcDelay;

         if(dlgGrParams.radioPcMonth=="X")
            g_pcPayType = 1;
         elif(dlgGrParams.radioPcQuart=="X")
            g_pcPayType = 2;
         else
            g_pcPayType = 0;
         end;

         if("X" == dlgGrParams.chkRateTable)
            g_pcType = 1;
            g_IsRateTable = true;

         else
            g_pcType = 0;
            g_IsRateTable = false;
         end;

         return CM_SAVE;

      elif (DLG_KEY_ESC == Key) // Закрытие окна по Escape
         if(false == GetTRUE(false, "Выйти без сохранения?"))
            return CM_IGNORE;
         end;

          // Возвращаем старые значения
         g_IsRateTable = g__IsRateTable;
         g_index = g__index;
         g_dtType = g__dtType;
         g_correct = g__correct;
         g_cntDate = g__cntDate;
         g_pcType = g__pcType;
         g_odDay = g__odDay;
         g_odSum = g__odSum;
         g_odDelay = g__odDelay;
         g_pcDay = g__pcDay;
         g_pcSum = g__pcSum;
         g_pcDelay = g__pcDelay;
         g_odPayType = g__odPayType;
         g_pcPayType = g__pcPayType;

         return CM_DEFAULT;
      elif(DLG_KEY_F3 == Key) // Выбор из списка
         if(FldIndex(dlgGrParams, "rateIndex") == id)
            ClearRecord(r_fi);
            tmp = 1;


            if ( ListFI(FIKIND_INDEX, tmp, r_fi) )
               g_index = r_fi.fiid;
               dlgGrParams.rateIndex = r_fi.name;
            end;
            updateFields(dlgGrParams, FldIndex(dlgGrParams, "rateIndex"));

         elif(FldIndex(dlgGrParams, "rateDtType") == id)
            ListDtType(g_dtType, dlgGrParams.rateDtType);
            updateFields(dlgGrParams, FldIndex(dlgGrParams, "rateDtType"));
         end;

      elif(DLG_KEY_SPACE == Key)

         if( (FldIndex(dlgGrParams, "radioOdMonth") == id)      // радиокнопка "Помесячно"
             or (FldIndex(dlgGrParams, "radioOdQuart") == id)// радиокнопка "Поквартально"
           )
            EnableFields(dlgGrParams, FldIndex(dlgGrParams, "OdDay"));
            EnableFields(dlgGrParams, FldIndex(dlgGrParams, "OdSum"));
            EnableFields(dlgGrParams, FldIndex(dlgGrParams, "OdDelay"));

            updateFields(dlgGrParams, FldIndex(dlgGrParams, "OdDay"));
            updateFields(dlgGrParams, FldIndex(dlgGrParams, "OdSum"));
            updateFields(dlgGrParams, FldIndex(dlgGrParams, "OdDelay"));

         elif(FldIndex(dlgGrParams, "radioOdClose") == id)      // радиокнопка "по дате закрытия"
            DisableFields(dlgGrParams, FldIndex(dlgGrParams, "OdDay"));
            DisableFields(dlgGrParams, FldIndex(dlgGrParams, "OdSum"));
            DisableFields(dlgGrParams, FldIndex(dlgGrParams, "OdDelay"));

            updateFields(dlgGrParams, FldIndex(dlgGrParams, "OdDay"));
            updateFields(dlgGrParams, FldIndex(dlgGrParams, "OdSum"));
            updateFields(dlgGrParams, FldIndex(dlgGrParams, "OdDelay"));

         elif( (FldIndex(dlgGrParams, "radioPcMonth") == id) // радиокнопка "Помесячно"
             or (FldIndex(dlgGrParams, "radioPcQuart") == id)// радиокнопка "Поквартально"
           )

            EnableFields(dlgGrParams, FldIndex(dlgGrParams, "PcDay"));
            EnableFields(dlgGrParams, FldIndex(dlgGrParams, "PcSum"));
            EnableFields(dlgGrParams, FldIndex(dlgGrParams, "PcDelay"));

            updateFields(dlgGrParams, FldIndex(dlgGrParams, "PcDay"));
            updateFields(dlgGrParams, FldIndex(dlgGrParams, "PcSum"));
            updateFields(dlgGrParams, FldIndex(dlgGrParams, "PcDelay"));

         elif(FldIndex(dlgGrParams, "radioPcClose") == id)      // радиокнопка "по дате закрытия"
            DisableFields(dlgGrParams, FldIndex(dlgGrParams, "PcDay"));
            DisableFields(dlgGrParams, FldIndex(dlgGrParams, "PcSum"));
            DisableFields(dlgGrParams, FldIndex(dlgGrParams, "PcDelay"));

            updateFields(dlgGrParams, FldIndex(dlgGrParams, "PcDay"));
            updateFields(dlgGrParams, FldIndex(dlgGrParams, "PcSum"));
            updateFields(dlgGrParams, FldIndex(dlgGrParams, "PcDelay"));
         end;

         if( (FldIndex(dlgGrParams, "radioOdClose") == id) or (FldIndex(dlgGrParams, "radioOdMonth") == id) or
                (FldIndex(dlgGrParams, "radioOdQuart") == id) )
            dlgGrParams.radioOdClose = "";
            dlgGrParams.radioOdMonth = "";
            dlgGrParams.radioOdQuart = "";
            dlgGrParams(id) = "X";
            updateFields(dlgGrParams, FldIndex(dlgGrParams, "radioOdClose"));
            updateFields(dlgGrParams, FldIndex(dlgGrParams, "radioOdMonth"));
            updateFields(dlgGrParams, FldIndex(dlgGrParams, "radioOdQuart"));

         elif( (FldIndex(dlgGrParams, "radioPcClose") == id) or (FldIndex(dlgGrParams, "radioPcMonth") == id) or
                (FldIndex(dlgGrParams, "radioPcQuart") == id) )
            dlgGrParams.radioPcClose = "";
            dlgGrParams.radioPcMonth = "";
            dlgGrParams.radioPcQuart = "";
            dlgGrParams(id) = "X";
            updateFields(dlgGrParams, FldIndex(dlgGrParams, "radioPcClose"));
            updateFields(dlgGrParams, FldIndex(dlgGrParams, "radioPcMonth"));
            updateFields(dlgGrParams, FldIndex(dlgGrParams, "radioPcQuart"));

/*
          elif(FldIndex(dlgGrParams, "chkRateTable") == id) // Отметка/снятие отметки использования таблицы ставок
            dlgGrParams.chkRateTable = IfThenElse("" == dlgGrParams.chkRateTable, "X", "");
            updateFields(mmDeal, FldIndex(dlgGrParams, "chkRateTable"));

            if("X" == dlgGrParams.chkRateTable)
               EnableFields(dlgGrParams, FldIndex(dlgGrParams, "rateIndex"));
               EnableFields(dlgGrParams, FldIndex(dlgGrParams, "rateDtType"));
               EnableFields(dlgGrParams, FldIndex(dlgGrParams, "rateDtOffset"));
               EnableFields(dlgGrParams, FldIndex(dlgGrParams, "rateCorrection"));
               //g_pcType = 1;
               //g_IsRateTable = true;
            else
               DisableFields(dlgGrParams, FldIndex(dlgGrParams, "rateIndex"));
               DisableFields(dlgGrParams, FldIndex(dlgGrParams, "rateDtType"));
               DisableFields(dlgGrParams, FldIndex(dlgGrParams, "rateDtOffset"));
               DisableFields(dlgGrParams, FldIndex(dlgGrParams, "rateCorrection"));
               //g_pcType = 0;
               //g_IsRateTable = false;
            end;
            updateFields(dlgGrParams, FldIndex(dlgGrParams, "rateIndex"));
            updateFields(dlgGrParams, FldIndex(dlgGrParams, "rateDtType"));
            updateFields(dlgGrParams, FldIndex(dlgGrParams, "rateDtOffset"));
            updateFields(dlgGrParams, FldIndex(dlgGrParams, "rateCorrection"));
 */
         end;

         if(FldIndex(dlgGrParams, "radioOdMonth") == id)
            g_odPayType = 1;
         elif(FldIndex(dlgGrParams, "radioOdQuart") == id)
            g_odPayType = 2;
         elif(FldIndex(dlgGrParams, "radioOdClose") == id)
            g_odPayType = 0;
         elif(FldIndex(dlgGrParams, "radioPcMonth") == id)
            g_pcPayType = 1;
         elif(FldIndex(dlgGrParams, "radioPcQuart") == id)
            g_pcPayType = 2;
         elif(FldIndex(dlgGrParams, "radioPcClose") == id)
            g_pcPayType = 0;
         end;

      end;

   elif ( DLG_SETFOCUS == cmd )
         if(FldIndex(dlgGrParams, "OdSum") == id)
            dlgGrParams.OdSum = FormatSum( dlgGrParams.OdSum, false );
            UpdateFields(dlgGrParams, FldIndex(dlgGrParams, "OdSum"));

         elif(FldIndex(dlgGrParams, "PcSum") == id)
            dlgGrParams.PcSum = FormatSum( dlgGrParams.PcSum, false );
            UpdateFields(dlgGrParams, FldIndex(dlgGrParams, "PcSum"));
         end;

   elif ( DLG_REMFOCUS == cmd )
      if(FldIndex(dlgGrParams, "OdSum") == id)
         dlgGrParams.OdSum = FormatSum( dlgGrParams.OdSum, true );
         UpdateFields(dlgGrParams, FldIndex(dlgGrParams, "OdSum"));

      elif(FldIndex(dlgGrParams, "PcSum") == id)
         dlgGrParams.PcSum = FormatSum( dlgGrParams.PcSum, true );
         UpdateFields(dlgGrParams, FldIndex(dlgGrParams, "PcSum"));
      end;
   end;

   return CM_DEFAULT;
end;


private macro GetAlgorithmName_(Type)
  if(Type == 1)
    return "дн.";
  elif(Type == 2)
    return "мес.";
  end;
end;


private macro ShowPayParams()
   dlgGrParams.OdDay = g_odDay;
   dlgGrParams.OdSum = FormatSum( g_odSum, true );
   dlgGrParams.OdDelay = g_odDelay;
   dlgGrParams.RadioOdClose = "";
   dlgGrParams.RadioOdMonth = "";
   dlgGrParams.RadioOdQuart = "";

   dlgGrParams.PcDay = g_pcDay;
   dlgGrParams.PcSum = FormatSum( g_pcSum, true );
   dlgGrParams.PcDelay = g_pcDelay;
   dlgGrParams.RadioPcClose = "";
   dlgGrParams.RadioPcMonth = "";
   dlgGrParams.RadioPcQuart = "";

   if(1 == g_odPayType)
      dlgGrParams.RadioOdMonth = "X";
   elif(2 == g_odPayType)
      dlgGrParams.RadioOdQuart = "X";
   else
      dlgGrParams.RadioOdClose = "X";
   end;

   if(1 == g_pcPayType)
      dlgGrParams.RadioPcMonth = "X";
   elif(2 == g_pcPayType)
      dlgGrParams.RadioPcQuart = "X";
   else
      dlgGrParams.RadioPcClose = "X";
   end;


   dlgGrParams.chkRateTable     = " ";
   // IfThenElse(g_IsRateTable, "X", "");

   dlgGrParams.rateIndex        = " ";
   //  CurrencyName(g_index);


    dlgGrParams.rateDtType       = " ";
   // СДАТ(newd)+" "+GetAlgorithmName_(g_dtType);
   dlgGrParams.rateDtOffset     = " ";
   // g_cntDate;
   dlgGrParams.rateCorrection   = " ";
   //g_correct;


   g__IsRateTable = g_IsRateTable;
   g__index = g_index;
   g__dtType = g_dtType;
   g__correct = g_correct;
   g__cntDate = g_cntDate;
   g__pcType = g_pcType;
   g__odDay = g_odDay;
   g__odSum = g_odSum;
   g__odDelay = g_odDelay;
   g__pcDay = g_pcDay;
   g__pcSum = g_pcSum;
   g__pcDelay = g_pcDelay;
   g__odPayType = g_odPayType;
   g__pcPayType = g_pcPayType;

   if (RunDialog (dlgGrParams, @EvDlgGrParamsProc))

      SaveGraph();
      fixir(g_dealId,g_odPayType,g_pcPayType);

      return true; // Пользователь сохранил данные
   end;
end;






//
// Заполнение полей формы
//
private macro InitFields(dealId, legId)
   var tmp, rs;
   clearRecord(mmDeal);

   legId = Int(legId);

   g_dealId = dealId;
   g_legId  = legId;

   var sql = "select * from ddl_tick_dbt  where t_dealid=:id and t_BofficeKind=102";

   var params = MakeArray(SQLParam("dealid", dealId));

   rsDeal = ExecSQLSelect(sql, params, false);

   var Temp = "", TempRes="";


   // Дата сделки, номер и коды сделки, системный и пользовательский типы и транспорт
   if(rsDeal.MoveNext())

      mmDeal.DealDate = g_dealDate = rsDeal.value("t_dealDate");
      mmDeal.DealCode = g_dealCode = rsDeal.value("t_dealCode");

      if(substr(g_dealCode, 2, 1) == "C")
        g_TypeDoc = "L";
      elif(substr(g_dealCode, 2, 1) == "D")
        g_TypeDoc = "D";
      end;
      mmDeal.TradeNumber = g_dealCodeTs = rsDeal.value("t_dealCodeTs");

      if("D" == rsDeal.value("t_typeDoc"))      // Межбанковский депозит
         mmDeal.radioDepo = "X";
         mmDeal.radioCred = "";
      else
         mmDeal.radioCred = "X";                // Межбанковский кредит
         mmDeal.radioDepo = "";
      end;

      mmDeal.radioEnd = "X";                    // Оплата в конце срока

      mmDeal.Note = rsDeal.value("t_comment");

      if (12300 == rsDeal.value("t_dealType"))   // 12300 -- привлечение
         g_dealType = МБК_Привлечение;
         mmDeal.dealType = aDealTypes(1);
         ///mmDeal.credAccLoan = FormatAccountNum(ПолучитьПрикреплённыйСчётПоКУ("СЧЕТ_313", g_dealId));
      else          // 12305 -- размещение
         g_dealType = МБК_Размещение;
         mmDeal.dealType = aDealTypes(0);
         ///mmDeal.borrAccLoan = FormatAccountNum(ПолучитьПрикреплённыйСчётПоКУ("СЧЕТ_320", g_dealId));
      end;
      ///mmDeal.credAccPlus = FormatAccountNum(ПолучитьПрикреплённыйСчётПоКУ("СЧЕТ_47427", g_dealId));

      mmDeal.chkAhead   = IfThenElse("" == SpecialValue0ToEmpty(rsDeal.value("t_flag5")), "", "X");
      g_old_CheckAHead = mmDeal.chkAhead; 
      mmDeal.chkOverDraft = IfThenElse("" == SpecialValue0ToEmpty(rsDeal.value("t_flag4")), "", "X");
      mmDeal.radioGraph = IfThenElse("" == SpecialValue0ToEmpty(rsDeal.value("t_flag3")), "", "X");
      mmDeal.radioEnd   = IfThenElse("" == SpecialValue0ToEmpty(rsDeal.value("t_flag3")), "X", "");
      if(mmDeal.chkOverDraft == "X")
         g_bIsOverDraft = true;
      end;
   else
   //   return false;
   end;

   // Доп.сведения по графику оплаты
   sql = "select * from dMmPayMode_dbt where t_dealid=:id";

   rsMode = ExecSQLSelect(sql, params, false);

   g_odDay = g_odSum = g_odDelay = g_pcDay = g_pcSum = g_pcDelay = 0;
   g_odPayType = g_pcPayType = 0;
   if(rsMode.MoveNext())
      g_odDay = rsMode.value("t_odDay");
      g_odSum = rsMode.value("t_odSum");
      g_odDelay = rsMode.value("t_odDelay");
      g_odPayType = rsMode.value("t_odPayType");
      g_pcDay = rsMode.value("t_pcDay");
      g_pcSum = rsMode.value("t_pcSum");
      g_pcDelay = rsMode.value("t_pcDelay");
      g_pcPayType = rsMode.value("t_pcPayType");
   end;


   return;

   sql = "select * from ddl_leg_dbt  where t_dealid=:deal and t_legId=:leg";
   params = MakeArray(SQLParam("deal", dealId), SQLParam("leg", legId));
   rsLeg = ExecSQLSelect(sql, params, false);

      // Финансовые инструменты, курсы и даты валютирования
   if(rsLeg.MoveNext())
      mmDeal.Duration = rsLeg.value("t_duration");
      mmDeal.Start    = g_start = rsLeg.value("t_start");
      mmDeal.Maturity = g_maturity = rsLeg.value("t_maturity");

      if("" == rsLeg.value("t_RejectDate")) // Дата не была задана => приравнять плановой
         mmDeal.FactMaturity = g_factMaturity = g_maturity;
      else
         mmDeal.FactMaturity = g_factMaturity = rsLeg.value("t_RejectDate");
      end;
      g_old_factMaturity = g_factMaturity;


      g_dealSum  = rsLeg.value("t_principal");
      mmDeal.dealSum  =  FormatSum(g_dealSum);
      g_fiid = rsLeg.value("t_pfi");
      mmDeal.dealFi = CurrencyISOLet(g_fiid);

      mmDeal.dealPercent = g_percent = rsLeg.value("t_Price") / Pow(10, rsLeg.value("t_Point"));
      g_resSum = rsLeg.value("t_cost");
      mmDeal.resSum = FormatSum(g_resSum);
      g_fullBasis   = Int(rsLeg.value("t_basis"));
      mmDeal.basis  = getDaysInYearOnBasis(rsLeg.value("t_basis"));
   end;

   // По оплате по графику
   g_index =  rsLeg.value("t_caption");
   g_dtType = rsLeg.value("t_typeDate");
   g_IsRateTable = IfThenElse("X" == rsLeg.value("t_tablePercent"), true, false);
   g_dtType = rsLeg.value("t_typeDate");
   g_cntDate = rsLeg.value("t_countDay");
   g_correct = rsLeg.value("t_correct");
   g_pcType  = rsLeg.value("t_typePercent");



   // Пролонгации
   var parentDealId, parentDealCode, parentDealDate, parentStart, parentPayAmount;
   if (mmGetParentDocInfo(g_dealId, parentDealId, parentDealCode, parentDealDate, parentStart, parentPayAmount))
      mmDeal.prevDealCode = parentDealCode;
      //mmDeal.prevDealAcc  = <???>;
      mmDeal.prevDealDate = Date(parentDealDate);
   end;

   var firstDealId, firstDealCode, firstDealDate, firstStart, firstPayAmount;
   if(mmGetFirstDocInfo(g_dealId, firstDealId, firstDealCode, firstDealDate, firstStart, firstPayAmount))
      g_firstStart = firstStart;
      mmDeal.firstDealCode = firstDealCode;
      mmDeal.firstDealDuration = Date(g_maturity)-Date(firstStart);
      mmDeal.firstDealDate = Date(firstDealDate);
   end;


   // Контрагент, брокер, клиент, дилер
   sql = "select t_partyId, t_brokerId, t_clientId, t_traderId, t_userField2 from ddl_tick_dbt where t_dealId=:deal";
   params = MakeArray(SQLParam("deal", dealId));
   rs = ExecSQLSelect(sql, params, false);
   var code="", name="";
   var bNeedNewTax=false;

   if(rs.MoveNext())
/*      FindParty(g_agent, code, name);
      mmDeal.AgentName = name;

      FindParty(rs.value(0), code, name);
      g_contr = rs.value(0);
      fxDeal.ContrName = name;
*/
      g_contr = rs.value(0);
/*****
      SetResSum();  // понадобится для брокера
******/



      if(0 == rsLeg.value("t_nkd"))
         bNeedNewTax = true;
      else      // Ставка по сделке уже задана
         mmDeal.BrokerTax = rsLeg.value("t_nkd");
      end;

      g_broker = rs.value(1);
  //    g__BrokerTax = 0;

   //   mmDeal.BrokerName = 0;


      tmp  = Double( SpecialValue0ToEmpty(rs.value(4)) ); // Реальная сумма комиссии брокеру по сделке!
      if(0!=tmp) mmDeal.BrokerSum = FormatSum(tmp); end;

      g_dealer = rs.value(3);

      mmDeal.DealerName = IfThenElse(0 == rsDeal.value("t_originId"), IfThenElse(-1 == g_dealer, {Name_Oper}, diGetPartyShortNameById(g_dealer))/*piGetOperName(rsDeal.value("t_oper"))*/, "Шлюз");
      mmDeal.DealerName = IfThenElse(g_dealer == mmDeal.DealerName, {Name_Oper}, mmDeal.DealerName);


      //FindParty(g_dealer, code, name);
///      mmDeal.DealerName = IfThenElse(0 == rsDeal.value("t_originId"), piGetOperName(rsDeal.value("t_oper")), "Шлюз");
   else
      return false;
   end;


   // Места и счета списания/зачисления
 //  FillPayerReceiver();

   // Генеральное соглашение и договор залога, актуальные для даты составления сделки
//   FillDocs();


   g_portfolioId = GetPortfolio(g_dealId);


   // Предыдущие состояния
   g__dealDate = g_dealDate;
   g__start = g_start;
   g__maturity = g_maturity;
   g__dealSum = g_dealSum;
   g__dealPercent = mmdeal.dealPercent;
   g__basis = mmDeal.basis;

end;

//
// Обработка события открытия диалога по вводу новой сделки
//
private macro OnNewDeal()
   var tmp = null;

   ClearRecord(mmDeal);

   g_legId = 1;
   if(g_subcredit)
     g_typeDoc = "U";
   else
     g_typeDoc = "L"; //по умолчанию
   end;
   mmDeal.radioCred = "X";
   g_contr = -1;
   g_old_CheckAHead = "";

   g_borrower = g_creditor = -1;
   g_fullBasis= 4;

/*   var code="", name="";
   FindParty(g_agent, code, name);
   fxDeal.AgentName = name;


*/
   if(g_subcredit == 6)
     g_portfolioId = 6;
     mmDeal.portfolio = GetPortfolioFullName(g_portfolioId);
   end;


   mmDeal.DealDate = g_dealDate = g__dealDate = {curdate};
   mmDeal.Start = g_start = g__start= {curdate};
   mmDeal.Maturity = g_maturity = g__maturity= DateAfterWorkDays({curdate}, 1);
   mmDeal.FactMaturity = g_old_factMaturity = g_factMaturity = g_maturity;

   mmDeal.duration = 1;
   mmDeal.radioEnd = "X";
   g_odDay = g_odSum = g_odDelay = g_pcDay = g_pcSum = g_pcDelay = 0;
   g_odPayType = g_pcPayType = 0;


   g_dealType = МБК_Размещение;
   mmDeal.dealType = aDealTypes(g_dealType);
   g_creditor = _SelfID;
//   FindParty(g_creditor, tmp, mmDeal.creditorName);

   g_fiid = 0;
   mmDeal.dealFi = CurrencyISOLet(g_fiid);

   mmDeal.basis = getDaysInYearOnBasis(g_fullBasis);

   // Инициализация дилера
///   g_dealer = GetAnyDealer();

   g_dealer = diGetPartyByOper({oper});

   mmDeal.DealerName = IfThenElse(-1 == g_dealer, {Name_Oper}, diGetPartyShortNameById(g_dealer));
   mmDeal.DealerName = IfThenElse(g_dealer == mmDeal.DealerName, {Name_Oper}, mmDeal.DealerName);


///   mmDeal.DealerName = {Name_Oper};

   mmDeal.chkOverdraft = "";
   g_bIsOverDraft = false;

   g_IsRateTable = false;
   g_index = -1;
   g_dtType = 1;
   g_correct = 0;
   g_cntDate = 0;
   g_pcType  = 0;
   g_odDay =  g_odSum = g_odDelay = g_pcDay = g_pcSum = g_pcDelay = g_odPayType = g_pcPayType = 0;
   g_bIsOverDraft = true;

   // номер сделки
 //  DL_GenRefByTypeDoc(OBJTYPE_CONVDEAL, tmp);
   tmp="00000000000000";
   mmDeal.DealCode = g_dealCode ="PC"+SUBSTR(tmp,3);
   mmDeal.TradeNumber = g_dealCodeTs = substr(tmp,9);;

//   ClearCred();
//   ClearBorr();
//   InitCreditor();
//   InitBorrower();

end;

//





// Открытие диалогового окна сделки
//
macro mm_OpenDealDlg(dealId, legId, SubCredit)
   g_subcredit = SubCredit; //Портфель
   if(g_subcredit == NULL)
     g_subcredit = 0;
   end;


   idid=dealId;
   g_gensoglId = g_zalogId = -1;
   g_schemaCin = g_schemaCout = g_schemaCinPc = g_schemaBin = g_schemaBout = g_schemaBoutPc = -1;
   g_broker = -1;
   reda=0;

   

   if(null != dealId)
      g_bIsNewDeal = false;
      reda=1;
      g_dealId = dealId;
      g_legId  = legId;
      //PreSave();

      InitFields(dealId, legId);

       g_start=(zsdelp(dealId,"start"));

       g_pcPayType0=g_pcPayType;
       g_pcDay0=g_pcDay;
       g_pcDelay0=g_pcDelay;
       g_pcSum0=g_pcSum;

       g_odPayType0=g_odPayType;
       g_odDay0=g_odDay;
       g_odDelay0=g_odDelay;
       g_odSum0=g_odSum;


      newd = g_start;


   else
      g_bIsNewDeal = true;
      OnNewDeal();
      newd = g_start;
   end;

            ShowPayParams();



 

   return false;
end;
