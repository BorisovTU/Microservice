/*
$Name: dl_lib.mac
$Module: МБК
$Description: Библиотека процедур дилинга
*/
import fx_globals,funk,ptinter, "dlquery.mac", globals, fiinter, OprInter, CTInter;
private array map1,map2;



MACRO MM_tickid(par1,par2)
  private var que,rs5,rez=0;
  que="select a.t_" +par2+"  from ddl_tick_dbt a  where a.t_dealid ="+par1; 
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=rs5.value(0);
     end;
  end;
  return rez;
END;

MACRO IsTF(dealtype)
   if ((dealtype == 12310) or (dealtype == 12335))
      return true;
   end;

   return false;
END;

MACRO IsOverdraft(dealtype)
   if (dealtype == 12301)
      return true;
   end;

   return false;
END;

// Получить пролонгирующую сделку
MACRO MM_GetProlongedDeal(DealKind, DealID)
   var Res, cmd;
   cmd = RSDCommand("SELECT DISTINCT docs.t_DocumentID " +
                        "FROM doprdocs_dbt docs "
                  "INNER JOIN doproper_dbt oper ON docs.t_ID_Operation = oper.t_ID_Operation " +
                        "WHERE docs.t_DocKind = " + DealKind + " AND oper.t_DocKind = " + DealKind + " AND oper.t_DocumentID = " + DealID);
   cmd.execute();
   Res = TRsbDataSet(cmd);
   if (Res.MoveNext)
      return int(Res.DocumentID);
   end;
   return 0;
END;

MACRO MM_LinkAccounts(DealKind, FromDealID, ToDealID)
   var que, rs;
   que = "insert into dmcaccdoc_dbt "
            "(select 0, t_iscommon, t_dockind, " + ToDealID + ", t_catid, t_catnum, t_chapter, t_account, t_currency, t_templnum, t_groupnum, "
            "t_periodid, t_activatedate, t_disablingdate, t_isusable, t_fiid, t_owner, t_place, t_issuer, t_kind_account, "
            "t_centr, t_centroffice, t_actiondate, t_fiid2, t_clientcontrid, t_bankcontrid, t_marketplaceid, t_marketplaceofficeid, "
            "t_firole, t_indexdate, t_departmentid, t_contractor, t_branch, t_corrdepartmentid, t_currencyeq, t_currencyeq_ratetype, "
            "t_currencyeq_ratedate, T_CURRENCYEQ_RATEEXTRA, T_MCBRANCH from dmcaccdoc_dbt oldaccdoc where t_dockind = " + DealKind + " and t_docid = " + FromDealID + " and t_catid != 802 " // исключить КУ "-%, Кр0"
            "and not exists(select 1 from dmcaccdoc_dbt accdoc where accdoc.t_dockind = oldaccdoc.t_dockind and accdoc.t_docid = " + ToDealID + " and accdoc.t_catid = oldaccdoc.t_catid and "
            "accdoc.t_firole = oldaccdoc.t_firole and accdoc.t_currency = oldaccdoc.t_currency))";

   rs = LnGetRecordSet(que);
END;

macro Histpaym10(pa1)
 private var que,rs51;
   que="select   T_AMOUNT,T_PAYERBANKID,T_PAYERACCOUNT,T_RECEIVERBANKID,T_RECEIVERACCOUNT,to_char(T_VALUEDATE,'DD.MM.YYYY') from dpmpaym_dbt  where t_paymentid="+pa1;
   rs51 = LnGetRecordSet(que);
   if(rs51 != null)
     if (rs51.moveNext) 
        map1(0)=rs51.value(0);
        map1(1)=rs51.value(1);
        map1(2)=rs51.value(2);
        map1(3)=rs51.value(3);
        map1(4)=rs51.value(4);
        map1(5)=rs51.value(5);
     end;
   end;
end;

macro Histpaym20(pa1)
   private var que,rs51,ii=0,pfix=0,{curdare},{oper};
   que="select   T_AMOUNT,T_PAYERBANKID,T_PAYERACCOUNT,T_RECEIVERBANKID,T_RECEIVERACCOUNT,to_char(T_VALUEDATE,'DD.MM.YYYY'), t_receiver from dpmpaym_dbt  where t_paymentid="+pa1;
   rs51 = LnGetRecordSet(que);
   if(rs51 != null)
     if (rs51.moveNext) 
        map2(0)=rs51.value(0);
        map2(1)=rs51.value(1);
        map2(2)=rs51.value(2);
        map2(3)=rs51.value(3);
        map2(4)=rs51.value(4);
        map2(5)=rs51.value(5);
     end;
   end;
   if ( rs51.value(6) != _BANK_RF )
      while(ii < 7) 
         if (map1(ii) != map2(ii) )
            pfix=1;
            ii=10;
         end;
         ii=ii+1;
      end;
      if ( pfix > 0 )
         que="insert into  DSTD_HISTPAYM_DBT (T_PAYMENTID,T_AMOUNT,T_PAYERBANKID,T_PAYERACCOUNT,T_RECEIVERBANKID,T_RECEIVERACCOUNT,T_VALUEDATE,T_AMOUNT2,T_PAYERBANKID2,T_PAYERACCOUNT2,T_RECEIVERBANKID2,T_RECEIVERACCOUNT2,T_VALUEDATE2,T_RESERVE,T_DATER,T_OPER) ";
         que=que+" values("+pa1+","+map1(0)+","+map1(1)+","+map1(2)+","+map1(3)+","+map1(4)+",'"+map1(5)+"',"+map2(0)+","+map2(1)+","+map2(2)+","+map2(3)+","+map2(4)+",'"+map2(5)+"',' ','"+string({curdate})+"',"+{oper}+" )"; 
         rs51 = LnGetRecordSet(que);
      end;
   end;
end;

macro par_paym(s1,s2)
   private var que,sa1,sa2,srez,rs51;
   sa1=string(s1);
   srez=0;
   que="select t_" +s2+" from dpmpaym_dbt  where t_paymentid="+s1;
   rs51 = LnGetRecordSet(que);
   if(rs51 != null)
     if (rs51.moveNext) 
        srez=rs51.value(0);
     end;
   end;

   return srez;
end;

macro GetCorrectAcc(fiid, purpose, partyid, acc_get) //SVE получение счета из СПИ
   var query = DL_RSDCommand("SELECT t_settaccid FROM dpmautoac_dbt WHERE t_servicekind = 2 AND t_fiid = ? AND t_purpose = ? AND t_partyid = ? AND ROWNUM = 1 ORDER BY t_order");
   query.AddParam(fiid);
   query.AddParam(purpose);
   query.AddParam(partyid);
   var data = query.Execute();   //Получение settaccid по которому сможем получить счет из СПИ, береться СПИ с самым маленьким значением сортировки, если под входные параметры подходит несколько вариантов
   if (data.MoveNext())
     query = DL_RSDCommand("SELECT t_account FROM dsettacc_dbt WHERE t_settaccid = ?");
     query.AddParam(data.settaccid);
     data = query.Execute;       //Получаем счет
     if (data.MoveNext())
       if ( data.account != "" )    
         return data.account;               //Возвращаем то что указано в СПИ
       else
         return "00000000000000000000";     //Если в СПИ пусто, то возвращаем 20 нулей 
       end;
     end;
   end;
   return "00000000000000000000";    //Если СПИ не удалось найти по данному субъекту, то также вернем 20 нулей
end;

MACRO pmpr(par1)
   var que,rs5,acc0, acc1,rs51,rs511,nop,sdealid,opp,acc99,bik,npartyid, bankid;
   var fiid, purpose;
   que="update dpmrmprop_dbt set t_number='"+string(par1)+"' where t_paymentid="+par1;
   rs5 = LnGetRecordSet(que);
   if (( par_paym(par1,"fiid") == 0 ) and (par_paym(par1,"baseamount") >= 100000000.00 ))
     que="update dpmrmprop_dbt set t_paymentkind='С' where t_paymentid="+par1;
     rs5 = LnGetRecordset(que);
   end;

   sdealid=par_paym(par1,"documentid");
   //que="select t_dealtype, t_partyid from ddl_tick_dbt where  t_dealid="+sdealid;
   que = "select tick.t_dealtype, tick.t_partyid, pm.t_receiverbankid from ddl_tick_dbt tick, dpmpaym_dbt pm " + 
         "where pm.t_paymentid = " + par1 + " and tick.t_dealid = " + sdealid;
   rs51 = LnGetRecordSet(que);
   if (rs51 != null)
      if (rs51.moveNext) 
         nop=rs51.value(0);
         npartyid=rs51.value(1);
         bankid = rs51.value(2);
         opp= execmacrofile("role_model.mac", "GetMainOperInGroup",102,nop) ;
         que="update dpmpaym_dbt set t_oper="+opp+" where t_paymentid="+par1;
         rs5 = LnGetRecordset(que);
      end;
   end;

   fiid = par_paym(par1,"fiid");
   if ( fiid == 0 ) 
      acc0= par_paym(par1,"receiveraccount");
      if ( not StrIsNumber(acc0) )            //SVE если счет не состоит полностью из цифр - заменяем корректным счетом
         purpose = par_paym(par1, "purpose");
         acc1 = GetCorrectAcc(fiid, purpose, npartyid, acc0);
      else
         acc1=acc0;
      end;
      if (( npartyid == _BANK_RF ) and isBuy(GetOperationGroup(MM_tickid(sdealid,"dealtype"))))
      else
         getstring(acc1,"Уточните счет получателя платежа",20);
         if (acc1 != "00000000000000000000" )
            if ( strlen(acc1) != 20 )
               msgbox("Внимание ! Длинна счета '"+acc1+"' не равно 20 !");
            end;
            bik = ПолучитьКодСубъекта( bankid, 3) ;  //SVE БИК берем согласно банку получателю из СПИ
            if (bik != "")  //SVE проверка ключа учитывает код БИК
               //bik=ПолучитьКодСубъекта( par_paym(par1,"receiver") , 3) ;
               acc99=execmacrofile("keyac_r.mac", "GetAccountKey", acc1,bik) ;    
               if ( acc1 != acc99 )
                  msgbox("Внимание ! Ключ в счете получателе не соотвествует рассчитанному ! "+substr(acc1,1,8)+"."+substr(acc1,9,1)+"."+substr(acc1,10)  +" /  вариант расчета "+substr(acc99,1,8)+"."+substr(acc99,9,1)+"."+substr(acc99,10));
               end;
            end;
         end;
      end;

      if ( acc1 != acc0 )
         que="update dpmpaym_dbt set t_receiveraccount='"+acc1+"' where t_paymentid="+par1;
         rs5 = LnGetRecordset(que);
      end;

      que="select count(*) from dpmprop_dbt where  t_debetcredit=1 and length(t_corracc) > 2  and t_paymentid="+par1;
      rs51 = LnGetRecordSet(que);
      if (rs51 != null)
         if (rs51.moveNext) 
            if (rs51.value(0) == 0 )
               que="select b.t_coracc, b.t_partyid from dpmprop_dbt a, dbankdprt_dbt b  where  a.t_debetcredit=1  and a.t_paymentid= "+par1+" and b.t_checkdata=t_bankcode ";
               rs511 = LnGetRecordSet(que);
               if (rs511 != null)
                  if (rs511.moveNext) 
                     acc0=rs511.value(0);
                     acc1=rs511.value(1);

                     que="update dpmprop_dbt set t_corracc='"+acc0+"' where t_debetcredit=1 and t_paymentid="+par1;
                     rs5 = LnGetRecordset(que);

                     que="update dpmrmprop_dbt set t_receivercorraccnostro='"+acc0+"' where t_paymentid="+par1;
                     rs5 = LnGetRecordset(que);

                     que="update dpmpaym_dbt set t_receiverbankid="+acc1+" where t_paymentid="+par1;
                     rs5 = LnGetRecordset(que);
                  end;
               end;
            end;
         end;
      end;
   end;
END;


macro plat_dil(s0,s1,s2,s3)
    private var que,sa1,sa2,srez,rs51;
    sa1=string(s0);
    srez=" ";
    que="select t_" +s3+" from dpmpaym_dbt  where t_documentid="+sa1+" and t_dockind="+s1+" and t_purpose="+s2;
    rs51 = LnGetRecordSet(que);
    if(rs51 != null)
      if (rs51.moveNext) 
        srez=rs51.value(0);
      end;
    end;
    return srez;
end;


MACRO CONTR_ID(pa1)
  private var que,rs5,rez="0";
  que="select t_objectid from dobjcode_DBT where t_code='"+pa1+"' AND T_CODEKIND=6";
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=rs5.value(0);
     end;
  end;
  return rez;

END;


macro plat_zak(s0,s1,s2,s3,s4)
    private var que,sa1,sa2,srez,rs51;
    sa1=string(s0);
    srez=" ";
    que="select t_" +s4+" from dpmpaym_dbt  where t_documentid="+sa1+" and t_dockind="+s1+" and t_purpose="+s2;// and t_subpurpose="+s3;
    rs51 = LnGetRecordSet(que);
    if(rs51 != null)
      if (rs51.moveNext) 
        srez=rs51.value(0);
      end;
    end;
    return srez;
end;



Macro Получить_Курс0 ( Rate, OtherFI, DateR, Type )
    var stat;
    record RATEDEF ( ratedef );
    SetParm (0, $0);
    if ( ValType (Type) == V_UNDEF )
        stat = ПолучитьКурс (RATEDEF, 0, OtherFI);
    else
        stat = ПолучитьКурс (RATEDEF, 0, OtherFI, Type);
    end;

    if ( stat != 0 ) return 1; end;
    stat = ПолучитьЗначениеКурса (RATEDEF, DateR);
    if ( stat != 0 ) return 1; end;

    SetParm (0, RATEDEF.RATE/10000);
    return 0;
End;


macro plat_dil0(s0,s1,s2,s3,s4)
    private var que,sa1,sa2,srez,rs51;
    sa1=string(s0);
    srez=" ";
    que="select t_" +s4+" from dpmpaym_dbt  where t_documentid="+sa1+" and t_dockind="+s1+" and t_purpose="+s2+" and t_valuedate='"+s3+"'";
    rs51 = LnGetRecordSet(que);
    if(rs51 != null)
      if (rs51.moveNext) 
        srez=rs51.value(0);
      end;
    end;
    return srez;
end;


macro plat_dil2(s0,s1,s2,s3)
    private var que,sa1,sa2,srez,rs51;
    sa1=string(s0);
    srez=" ";
    que="select t_" +s3+" from dpmpaym_dbt  where t_documentid="+sa1+" and t_dockind="+s1+" and t_purpose = 11  and t_valuedate='"+s2+"'";
    rs51 = LnGetRecordSet(que);
    if(rs51 != null)
      if (rs51.moveNext) 
        srez=rs51.value(0);
      end;
    end;
    return srez;
end;



MACRO CH_PROL0(dealid);
    private var su1,su2,rez;
    su1 = plat_dil(dealid,"102","9","baseamount");
    su2 = plat_dil(dealid,"102","10","baseamount");

    rez = su2;

    return rez;
END;


MACRO CH_PROL(dealid);
    private var su1,su2,rez;
    su1 = plat_dil(dealid,"102","9","baseamount");
    su2 = plat_dil(dealid,"102","10","baseamount");
    if ( su1 != su2)
       rez = su1-su2;
    else
       rez = su2;
    end;
    return rez;
END;

MACRO PCH_PROL(dealid);
    private var su1,su2,rez=0;
    su1 = plat_dil(dealid,"102","9","baseamount");
    su2 = plat_dil(dealid,"102","10","baseamount");
    if ( su1 != su2)
       rez = 1;
    end;
    return rez;
END;


MACRO DAT(s);
   private var ss,dd;
   ss=trim(substr(string(s),1,10));
   if (substr(ss,3,1) != "." )
     ss="0"+ss;
   end; 
   dd=date(ss);
   return(dd);
END;

MACRO SDAT(s);
   private var ss,dd;
   ss=trim(substr(string(s),1,10));
   if (substr(ss,3,1) != "." )
     ss="0"+ss;
   end; 
   return(ss);
END;

MACRO SROK(id1,id2,par3)
   private var r1,rs,que,ss1,ss;
   ss1=0;
   que = "select c.t_start,d.t_maturity from ddl_tick_dbt a, ddl_tick_dbt b, ddl_leg_dbt c, ddl_leg_dbt d where c.t_dealid=a.t_dealid and d.t_dealid=b.t_dealid and   b.t_dealid = "+id2+" and a.t_dealid="+id1;
   rs = LnGetRecordSet(que);
   if (rs != null)
      if (rs.moveNext) 
         r1=(DAT(rs.value(1))-DAT(rs.value(0)));
         r1=1*r1;

         if (r1 == 1)  
            ss1=30;
         elif ((r1 > 1)  and (r1< 8 ))
            ss1=31;
         elif ((r1 > 7) and (r1< 31 ))
            ss1=32;
         elif ((r1 > 30)  and (r1< 91 ))
            ss1=33;
         elif ((r1 > 90)  and (r1< 181 ))
            ss1=34;
         elif ((r1 > 180)  and (r1< 366 ))
            ss1=35;
         elif ((r1 > 365)  and (r1< 1095 ))
            ss1=36;
         elif (r1 > 1095)
            ss1=39;
         end;
      end;
   end;

 return(ss1);
end;


MACRO MM_nalog(par1)
  private var que,rs5,rez=0;
  que="select count(*) from DDL_GENAGR_DBT where t_dockind=4611 and  t_tax_amount > 0 and t_partyid="+par1;
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=int(rs5.value(0));
     end;
  end;
  if ( rez == 0 )
     return rez;
  else
     que="select t_tax_amount from DDL_GENAGR_DBT where  t_dockind=4611 and  t_partyid="+par1;
     rs5 = LnGetRecordSet(que);
     if(rs5 != null)
        if (rs5.moveNext) 
           rez=rs5.value(0);
        end;
     end;
  end;
  return rez;
END;

MACRO MM_nalog_deal(dealid)
  VAR НалогСтавка = 0, 
   party = TBfile("party.dbt", "R", 0);
   party.rec.PartyID = MM_tickid(dealid,"partyid");
   party.getEQ;
   
   if (MM_tickid(dealid,"genagrid") > 0)
      VAR genagr = TBfile("dl_genagr.dbt", "R", 0);
      genagr.rec.GenAgrID = MM_tickid(dealid,"genagrid");
      if (genagr.GetEQ)
         if (isBuy(GetOperationGroup(MM_tickid(dealid,"dealtype"))))
            if (genagr.rec.TaxContractor)
               НалогСтавка = genagr.rec.TaxContractorAmount;
            end;
         else
            if (genagr.rec.Tax)
               НалогСтавка = genagr.rec.Tax_Amount;
            end;            
         end;
      end;
   end;
   if (НалогСтавка == 0)
      if (isBuy(GetOperationGroup(MM_tickid(dealid,"dealtype"))))
         НалогСтавка = double(readNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 85, {curdate}, date(0,0,0)));
      else
         НалогСтавка = double(readNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 59, {curdate}, date(0,0,0)));
      end;
      if (VALTYPE(НалогСтавка) == V_UNDEF)
         НалогСтавка = 0;
      end;
   end;
   return НалогСтавка;
END;



MACRO MM_leg(par1,par2,par3)
  private var que,rs5,rez=0;
  que="select a.t_" +par2+"  from ddl_leg_dbt a, ddl_tick_dbt b  where a.t_dealid=b.t_dealid and a.t_legid ="+par3+" and b.t_bofficekind=102 and a.t_dealid="+par1; 
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=rs5.value(0);
     end;
  end;
  return rez;
END;


MACRO MM_zalog(par1)
  private var que,rs5,rez=0;
  que="select nvl(sum(t_amount),0)  from ddl_grnt_dbt where t_dealid="+par1;
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=rs5.value(0);
     end;
  end;
  return rez;
END;



MACRO MM_acc(par1,par2)
  private var que,rs5,rez=0;
  que="select t_account from dmcaccdoc_dbt where t_dockind=102 and t_catid="+par2+" and t_docid="+par1+" order by t_activatedate desc, t_id desc";
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=rs5.value(0);
     end;
  end;
  return rez;
END;

MACRO IN_DATE(par1)
  private var dd1,dd0,xx;
  Array masm;
  masm(1) ="JAN";
  masm(2) ="FEB";
  masm(3) ="MAR";
  masm(4) ="APR";
  masm(5) ="MAY";
  masm(6) ="JUN";
  masm(7) ="JUL";
  masm(8) ="AUG";
  masm(9) ="SEP";
  masm(10) ="OCT";
  masm(11) ="NOV";
  masm(12) ="DEC";
  dd0=SDAT(par1);
  xx=int(substr(dd0,4,2));
  dd1=substr(dd0,7,4)+masm(xx)+substr(dd0,1,2);

  return dd1;
END;

MACRO DOP_GROUND(par10,par11)
   private var rezz="0",que,rs10,rs11,i5;
   que="select count(*) from  DSTD_GROUND_DBT where t_tip="+par11+"  and  t_partyid="+MM_tickid(par10,"partyid");
   rs10 = LnGetRecordSet(que);
   if (rs10 != null)
      if (rs10.moveNext) 
         if ( int(rs10.value(0)) > 0 )
            que="select t_ground from  DSTD_GROUND_DBT where t_tip="+par11+" and  t_partyid="+MM_tickid(par10,"partyid");
            rs11 = LnGetRecordSet(que);
            if (rs11 != null)
               if (rs11.moveNext) 
                  rezz=rs11.value(0);
                  i5=index(rezz,"<DEAL0>");
                  if ( i5 > 0 )
                     rezz=substr(rezz,1,i5-1)+MM_tickid(par10,"dealcodets")+substr(rezz,i5+7);
                  end;

                  i5=index(rezz,"<D0>");
                  if ( i5 > 0 )
                     rezz=substr(rezz,1,i5-1)+IN_DATE(MM_tickid(par10,"dealdate"))+substr(rezz,i5+4);
                  end;

                  i5=index(rezz,"<D1>");
                  if ( i5 > 0 )
                     rezz=substr(rezz,1,i5-1)+IN_DATE(MM_leg(par10,"start",1))+substr(rezz,i5+4);
                  end;
               
                  i5=index(rezz,"<D2>");
                  if ( i5 > 0 )
                     rezz=substr(rezz,1,i5-1)+IN_DATE(MM_leg(par10,"maturity",1))+substr(rezz,i5+4);
                  end;
               end;
            end;
         end;
      end;
   end;

   return rezz;
END;

private macro GetPartyName(ID)
   if (ID == 0)
      return {Name_Bank};
   end;
   var party = TBfile("party");
   party.KeyNum = 0;
   party.rec.PartyID = ID;
   if ( not GetEq(party) )
      return ID;
   else
      return party.rec.Name;
   end;
end;

macro IsNotResident(PartyId)
  var party = Tbfile("party");
  party.KeyNum = 0;
  party.rec.PartyId = partyId;
  if ( GetEq(party) )
     if (party.rec.notresident == "X")
        return true;
     end;
  end;
  return false;
end;

macro IsAcc30111(dealid, purpose)
   var query = DL_RSDCommand("select t_futurepayeraccount, t_futurereceiveraccount from dpmpaym_dbt where t_documentid = ? and t_purpose = ?");
   query.AddParam(dealid);
   query.AddParam(purpose);
   var data = query.Execute();
   if ( data.MoveNext() )
     if ( (SubStr(data.futurepayeraccount, 1, 5) == "30111") or (SubStr(data.futurereceiveraccount, 1, 5) == "30111") )
        return true;
     end;
   end;
   return false;
end;

//teg функция по поределиению корсчета по СПИ
MACRO GetCorrAccouont(iFIID,iPartyID)
  private var quest,resQuest,resul="0";
  if ( iFIID == 0 )
     iPartyID=_BANK_RF;
  end;
  // que="select t_account from dcorschem_dbt where rownum=1 and t_fiid="+par1+" and t_corrid="+par2;
  quest= " select s.t_account acc  from dcorschem_dbt s, dbnkschem_dbt b "
        +"  where  b.t_fiid=s.t_fiid  and s.t_fiid="+iFIID
        +"   and b.t_fi_kind=s.t_fi_kind and b.t_schem=s.t_number and b.t_bankid= "+iPartyID
        +"   and rownum=1 ";
  resQuest = LnGetRecordSet(quest);
  if(resQuest != null)
     if (resQuest.moveNext) 
        resul=resQuest.value(0);
     end;
  end;
  return resul;
END;

MACRO MM_ground(par1,par2)
   private var rez,nclient,nnalog,dop=" ",dground,pa1,pa2,pa3,ii0,ij,ij0;
   private var cor_ac = GetCorrAccouont((mm_leg(par1,"pfi",1)),(MM_tickid(par1,"partyid")));//KEA IS 510092 
   if (par2 == 11 )
      rez="ПЕРЕЧИСЛЕНИЕ ПРОЦЕНТОВ ПО СДЕЛКЕ No "+MM_tickid(par1,"dealcodets")+" ОТ "+SDAT(MM_tickid(par1,"dealdate"))+". НДС НЕ ОБЛАГАЕТСЯ.";
      if (( MM_tickid(par1,"partyid") == _BANK_RF) and isBuy(GetOperationGroup(MM_tickid(par1,"dealtype"))))
        rez="Исполнение обязательств по кредиту Банка России No "+MM_tickid(par1,"dealcode")+" от "+SDAT(MM_tickid(par1,"dealdate"))+", погашение начисленных процентов.  Без налога  (НДС).";
      end;

      if (isSale(GetOperationGroup(MM_tickid(par1,"dealtype"))) AND IsTF(MM_tickid(par1,"dealtype")))
        rez="Проценты по рамбурсу "+MM_tickid(par1,"dealcode")+"/"+GetPartyName(MM_tickid(par1,"partyid"))+" REF "+MM_tickid(par1,"dealcodeTS");
      end;
      if (isBuy(GetOperationGroup(MM_tickid(par1,"dealtype"))) AND IsTF(MM_tickid(par1,"dealtype")))
        rez="ПЕРЕЧИСЛЕНИЕ ПРОЦЕНТОВ ПО СДЕЛКЕ ОВЕРДРАФТА ОТ "+SDAT(MM_tickid(par1,"dealdate"))+" "+GetPartyName(MM_tickid(par1,"partyid"));;
      end;
      
      if (( IsNotResident(MM_tickid(par1,"partyid") )) and (IsAcc30111(par1, par2)) )
         rez = "INTEREST AMOUNT UNDER LOAN AGR No "+MM_tickid(par1,"dealcodets")+" TD"+IN_DATE(MM_tickid(par1,"dealdate"))+" VD"+IN_DATE(MM_leg(par1,"start",1))+" MD"+IN_DATE(MM_leg(par1,"maturity",1))+" RUSSIAN AGRICULTURAL BANK IS COUNTERPARTY";
      end;
   elif (par2 == 509 )
      rez="Лимит задолженности "+GetPartyName(MM_tickid(par1,"partyid"))+" по "+MM_tickid(par1,"comment")+" согласно распоряжения ДПОФР №  от "+SDAT(MM_tickid(par1,"dealdate")); 
      if ( MM_tickid(par1,"partyid") == _BANK_RF)
         pa2=MM_tickid(par1,"comment");
         ij=index(pa2,"№");
         if ( ij > 0 )
            pa2=substr(pa2,ij);
            ii0=index(pa2,",");
            if (ii0 > 0 )
               pa2=substr(pa2,1,ii0-1);
            else
               pa2=" ";
            end;
         end;
         rez="Лимит задолженности ОПЕРАЦИОННОГО ДЕПАРТАМЕНТА БАНКА РОССИИ по Генеральному соглашению "+pa2+" согласно распоряжения ДПОФР №  от "+SDAT(MM_tickid(par1,"dealdate")); 
      end;
   elif (par2 == 572 )
      rez="Комиссия  "+GetPartyName(MM_tickid(par1,"partyid"))+" ПО СДЕЛКЕ No "+MM_tickid(par1,"dealcode")+" ОТ "+SDAT(MM_tickid(par1,"dealdate"));
      pa2=MM_tickid(par1,"parentid");

      if (( MM_tickid(par1,"partyid") == _BANK_RF) and (pa2 > 0 ))
         rez="Комиссия  по финансовым обязательствам и финансовым активам  по Договору  кредитной линии";
         rez=rez+ " No "+MM_tickid(pa2,"dealcode")+" ОТ "+SDAT(MM_tickid(pa2,"dealdate"))+",  СДЕЛКА No "+MM_tickid(par1,"dealcode")+" ОТ "+SDAT(MM_tickid(par1,"dealdate"))+" ОПЕРАЦИОННЫЙ ДЕПАРТАМЕНТ БАНКА РОССИИ";
      end;
   elif (par2 == 510 )
      rez="Списание лимита задолженности "+GetPartyName(MM_tickid(par1,"partyid"))+" по "+MM_tickid(par1,"comment")+" согласно распоряжения ДПОФР №  от "+SDAT(MM_tickid(par1,"dealdate")); 

      if ( MM_tickid(par1,"partyid") == _BANK_RF)
         pa2=MM_tickid(par1,"comment");
         ij=index(pa2,"№");
         if ( ij > 0 )
            pa2=substr(pa2,ij);
            ii0=index(pa2,",");
            if (ii0 > 0 )
               pa2=substr(pa2,1,ii0-1);
            else
               pa2=" ";
            end;
         end;
         rez="Списание лимита задолженности ОПЕРАЦИОННОГО ДЕПАРТАМЕНТА БАНКА РОССИИ по Генеральному соглашению "+pa2+" согласно распоряжения ДПОФР №  от "+SDAT(MM_tickid(par1,"dealdate")); 
      end;
   elif (par2 == 512 )
      rez="Корректировка лимита задолженности "+GetPartyName(MM_tickid(par1,"partyid"))+" по "+MM_tickid(par1,"comment")+" согласно распоряжения ДПОФР №  от "+SDAT({curdate}); 

      if ( MM_tickid(par1,"partyid") == _BANK_RF)
         pa2=MM_tickid(par1,"comment");
         ij=index(pa2,"№");
         if ( ij > 0 )
            pa2=substr(pa2,ij);
            ii0=index(pa2,",");
            if (ii0 > 0 )
               pa2=substr(pa2,1,ii0-1);
            else
               pa2=" ";
            end;
         end;
         rez="Корректировка лимита задолженности ОПЕРАЦИОННОГО ДЕПАРТАМЕНТА БАНКА РОССИИ по Генеральному соглашению "+pa2+" согласно распоряжения ДПОФР №  от "+SDAT({curdate}); 
      end;
   elif (par2 == 26 )
      if ( strlen(trim(MM_tickid(par1,"dealcodets"))) < 2 )
         rez="НАЧИСЛЕНИЕ ПРОЦЕНТОВ ПО СДЕЛКЕ No "+MM_tickid(par1,"dealcode")+" ОТ "+SDAT(MM_tickid(par1,"dealdate"));
      else
         rez="НАЧИСЛЕНИЕ ПРОЦЕНТОВ ПО СДЕЛКЕ No "+MM_tickid(par1,"dealcodets")+" ОТ "+SDAT(MM_tickid(par1,"dealdate"));
      end;
      if ( MM_tickid(par1,"partyid") == _BANK_RF)
         rez="НАЧИСЛЕНИЕ ПРОЦЕНТОВ ПО ДОГОВОРУ С ОПЕРАЦИОННЫМ ДЕПАРТАМЕНТОМ  БАНКА РОССИИ , кредит No "+MM_tickid(par1,"dealcode")+" ОТ "+SDAT(MM_tickid(par1,"dealdate"));
      end;
      if (isSale(GetOperationGroup(MM_tickid(par1,"dealtype"))) AND IsTF(MM_tickid(par1,"dealtype")))
         // rez="НАЧИСЛЕНИЕ ПРОЦЕНТОВ ПО СДЕЛКЕ No "+MM_tickid(par1,"dealcode")+" ОТ "+SDAT(MM_tickid(par1,"dealdate"));
         rez="Начисление процентов по аккредитиву "+MM_tickid(par1,"dealcode") +"/"+GetPartyName(MM_tickid(par1,"partyid"));
      end;

      if (isBuy(GetOperationGroup(MM_tickid(par1,"dealtype"))) AND IsTF(MM_tickid(par1,"dealtype")))
         //  rez="НАЧИСЛЕНИЕ ПРОЦЕНТОВ ПО СДЕЛКЕ ОВЕРДРАФТА ОТ "+SDAT(MM_tickid(par1,"dealdate"))+" "+GetPartyName(MM_tickid(par1,"partyid"));;
         rez="НАЧИСЛЕНИЕ ПРОЦЕНТОВ ПО СДЕЛКЕ МБК "+MM_tickid(par1,"dealcode") +"/"+GetPartyName(MM_tickid(par1,"partyid"));
      end;
   elif (par2 == 10 )
      if ( strlen(trim(MM_tickid(par1,"dealcodets"))) < 2 )
         rez="ВОЗВРАТ ПРИВЛЕЧЕННЫХ СРЕДСТВ ПО СДЕЛКЕ No "+MM_tickid(par1,"dealcode")+" ОТ "+SDAT(MM_tickid(par1,"dealdate"))+". НДС НЕ ОБЛАГАЕТСЯ.";
      else
         rez="ВОЗВРАТ ПРИВЛЕЧЕННЫХ СРЕДСТВ ПО СДЕЛКЕ No "+MM_tickid(par1,"dealcodets")+" ОТ "+SDAT(MM_tickid(par1,"dealdate"))+". НДС НЕ ОБЛАГАЕТСЯ.";
      end;
      if ( IsCLAIMSACQ(GetOperationGroup(MM_tickid(par1,"dealtype"))))
         rez="ПОГАШЕНИЕ ПРАВ ТРЕБОВАНИЯ ПО ДОГОВОРУ No "+MM_tickid(par1,"dealcode")+" ОТ "+SDAT(MM_tickid(par1,"dealdate"))+". НДС НЕ ОБЛАГАЕТСЯ.";
      end;

      if (( MM_tickid(par1,"partyid") == _BANK_RF) and ( MM_tickid(par1,"dealtype") == 12300 ))
         rez="Исполнение обязательств по кредиту Банка России No "+MM_tickid(par1,"dealcode")+" от "+SDAT(MM_tickid(par1,"dealdate"))+", погашение основного долга.  Без налога (НДС)";
      end;

      if (isSale(GetOperationGroup(MM_tickid(par1,"dealtype"))) AND IsTF(MM_tickid(par1,"dealtype")))
         rez="Возмещение сумммы оплаченных документов по рамбурсному требованию "+GetPartyName(MM_tickid(par1,"partyid"))+","+MM_tickid(par1,"dealcode")+" REF "+MM_tickid(par1,"dealcodeTS");
      end;

      if ( IsOverdraft(MM_tickid(par1,"dealtype")))
         // rez="ВОЗВРАТ ПРИВЛЕЧЕННЫХ СРЕДСТВ ПО СДЕЛКЕ ОВЕРДРАФТА ОТ "+SDAT(MM_tickid(par1,"dealdate"))+" "+GetPartyName(MM_tickid(par1,"partyid"));;
         rez="Возврат овердрафта по расчетам по корсчету " +GetPartyName(MM_tickid(par1,"partyid")) + ",(" +cor_ac+") за " + SDAT({curdate}); 
      end;

      if (( IsNotResident(MM_tickid(par1,"partyid") )) and (IsAcc30111(par1, par2)) )
         rez =  "PRINCIPAL AMOUNT UNDER LOAN AGR No "+MM_tickid(par1,"dealcodets")+" TD"+IN_DATE(MM_tickid(par1,"dealdate"))+" VD"+IN_DATE(MM_leg(par1,"start",1))+" MD"+IN_DATE(MM_leg(par1,"maturity",1))+" RUSSIAN AGRICULTURAL BANK IS COUNTERPARTY";
      end;
   elif (par2 == 55 )
      rez="ПРОЛОНГАЦИЯ СДЕЛКИ No "+MM_tickid(par1,"dealcodets")+" ОТ "+SDAT(MM_tickid(par1,"dealdate")) ;
   elif (par2 == 9 )
      rez="РАЗМЕЩЕНИЕ СРЕДСТВ ПО СДЕЛКЕ No "+MM_tickid(par1,"dealcodets")+" ОТ "+SDAT(MM_tickid(par1,"dealdate"))+". НДС НЕ ОБЛАГАЕТСЯ.";

      if ( IsCLAIMSACQ(GetOperationGroup(MM_tickid(par1,"dealtype"))))
        rez="ПРИОБРЕТЕНИЕ ПРАВ ТРЕБОВАНИЯ ПО ДОГОВОРУ No "+MM_tickid(par1,"dealcodets")+" ОТ "+SDAT(MM_tickid(par1,"dealdate"))+". НДС НЕ ОБЛАГАЕТСЯ.";
      end;

      if (( MM_tickid(par1,"partyid") == _BANK_RF) and ( isSale(GetOperationGroup(MM_tickid(par1,"dealtype"))) ))
         rez="ПЕРЕЧИСЛЕНИЕ СРЕДСТВ В ДЕПОЗИТ, ОТКРЫВАЕМЫЙ В БАНКЕ РОССИИ, ДОГОВОР 33490130 ОТ 03/05/2018. НДС НЕ ОБЛАГАЕТСЯ.";
      end;
   elif (par2 == 109 )
      rez="PRINCIPAL AMOUNT UNDER LOAN AGR No "+MM_tickid(par1,"dealcodets")+" TD"+IN_DATE(MM_tickid(par1,"dealdate"))+" VD"+IN_DATE(MM_leg(par1,"start",1))+" MD"+IN_DATE(MM_leg(par1,"maturity",1))+" RUSSIAN AGRICULTURAL BANK IS COUNTERPARTY";
      dground=DOP_GROUND(par1,9);
      if (dground != "0" )
         rez= dground;
      end;

      if ( isSale(GetOperationGroup(MM_tickid(par1,"dealtype"))) )
         rez="RUAGRUMM IS LENDER "+ ПолучитьКодСубъекта( MM_tickid(par1,"partyid"), 6)+" IS BORROW OF PMT UNDER LOAN AGR  "+MM_tickid(par1,"dealcodets");
         rez=rez+ "  TRADE DATE "+IN_DATE(MM_tickid(par1,"dealdate"))+" VALUE DATE "+IN_DATE(MM_leg(par1,"start",1))+" MATURITY DATE "+IN_DATE(MM_leg(par1,"maturity",1));
      end;
   elif (par2 == 110 )
      rez="PRINCIPAL AMOUNT UNDER LOAN AGR No "+MM_tickid(par1,"dealcodets")+" TD"+IN_DATE(MM_tickid(par1,"dealdate"))+" VD"+IN_DATE(MM_leg(par1,"start",1))+" MD"+IN_DATE(MM_leg(par1,"maturity",1))+" RUSSIAN AGRICULTURAL BANK IS COUNTERPARTY";
      
      /*SVE для сделок ТФ*/
      if (isSale(GetOperationGroup(MM_tickid(par1,"dealtype"))) AND IsTF(MM_tickid(par1,"dealtype"))) //ТФ, размещение, ОД
         rez = "PAYMENT UNDER " + MM_tickid(par1,"dealcodets") + " YR REF XXXXXXXXXX OUR REF " + MM_tickid(par1,"dealcode");
      end;
      if (isBuy(GetOperationGroup(MM_tickid(par1,"dealtype"))) AND IsTF(MM_tickid(par1,"dealtype"))) //ТФ, привелечение, ОД
         rez = "PAYMENT OF PRINCIPAL UNDER AGREEMENT DD " + IN_DATE(MM_leg(par1,"start",1)) + " REF " + MM_tickid(par1,"dealcodets");
      end;
   elif (par2 == 111 )
      rez="INTEREST AMOUNT UNDER LOAN AGR No "+MM_tickid(par1,"dealcodets")+" TD"+IN_DATE(MM_tickid(par1,"dealdate"))+" VD"+IN_DATE(MM_leg(par1,"start",1))+" MD"+IN_DATE(MM_leg(par1,"maturity",1))+" RUSSIAN AGRICULTURAL BANK IS COUNTERPARTY";
      if (isBuy(GetOperationGroup(MM_tickid(par1,"dealtype"))) AND IsTF(MM_tickid(par1,"dealtype"))) //ТФ, привелечение, проценты
         rez = "PAYMENT OF INTEREST UNDER AGREEMENT DD " + IN_DATE(MM_tickid(par1,"dealdate")) + " REF " + MM_tickid(par1,"dealcodets");
      end;
   elif (par2 == 90)
      rez="ПРИВЛЕЧЕНИЕ СРЕДСТВ ПО СДЕЛКЕ No "+MM_tickid(par1,"dealcodets")+" ОТ "+SDAT(MM_tickid(par1,"dealdate"))+". НДС НЕ ОБЛАГАЕТСЯ.";

      if (( MM_tickid(par1,"partyid") == _BANK_RF) and ( MM_tickid(par1,"dealtype") == 12300 ))
         rez="Предоставление кредита Банка России No "+MM_tickid(par1,"dealcode")+" от "+SDAT(MM_tickid(par1,"dealdate"))+". Без налога (НДС).";
      end;
      
      if ( IsOverdraft(MM_tickid(par1,"dealtype")) )
         //  rez="ПРИВЛЕЧЕНИЕ СРЕДСТВ ПО СДЕЛКЕ ОВЕРДРАФТА ОТ "+SDAT(MM_tickid(par1,"dealdate"))+" "+GetPartyName(MM_tickid(par1,"partyid"));
         rez="Предоставление овердрафта по расчетам по корсчету " +GetPartyName(MM_tickid(par1,"partyid")) + ",(" +cor_ac+") за " +SDAT(MM_tickid(par1,"dealdate"));
      end;
   elif (par2 == 13 )
      nclient=MM_tickid(paR1,"partyid");
      nnalog=MM_nalog_deal(par1);
      dop=" ";
      if ( nnalog > 0 )
         dop=trim(STRING(nnalog));
         ii0=0;
         while (ii0 < 2 )
            ij0=strlen(dop);
            ij=substr(dop,ij0);
            if (ij == "0")
               dop=substr(dop,1,ij0-1);
            end;
            ii0=ii0+1;
         end;

         pa1=execmacrofile("dl_plib.mac", "N_fiid",MM_leg(par1,"pfi",1)) ;
         pa3=execmacrofile("dl_plib.mac", "nami",nclient) ;

         pa2=plat_dil0(par1,"102","11",DAT({curdate}),"baseamount");
         rez=dop+"% Налог от суммы процентов МБК "+pa1+" "+string(pa2:a)+" "+pa3+" по сделке No "+MM_tickid(par1,"dealcodets")+" от "+SDAT(MM_tickid(par1,"dealdate")) ;

         if ( MM_tickid(par1,"dealtype") == 12335 )
            rez=dop+"% Налог от суммы процентов по аккредитиву "+MM_tickid(par1,"dealcode")+"/"+GetPartyName(MM_tickid(par1,"partyid"));
         end;
 
         return rez;
      end;

      if ( strlen(trim(MM_tickid(par1,"dealcodets"))) < 2 )
         rez="ПЕРЕЧИСЛЕНИЕ ПРОЦЕНТОВ ПО СДЕЛКЕ No "+MM_tickid(par1,"dealcode")+" ОТ "+SDAT(MM_tickid(par1,"dealdate"))+". "+dop;
      else
         rez="ПЕРЕЧИСЛЕНИЕ ПРОЦЕНТОВ ПО СДЕЛКЕ No "+MM_tickid(par1,"dealcodets")+" ОТ "+SDAT(MM_tickid(par1,"dealdate"))+". "+dop;
      end;

      if (( MM_tickid(par1,"partyid") == _BANK_RF) and ( MM_tickid(par1,"dealtype") == 12300 ))
         rez="Исполнение обязательств по кредиту Банка России No "+MM_tickid(par1,"dealcode")+" от "+SDAT(MM_tickid(par1,"dealdate"))+", погашение начисленных процентов.  Без налога  (НДС).";
      end;

      if ( IsOverdraft(MM_tickid(par1,"dealtype")) )
         // rez="ПЕРЕЧИСЛЕНИЕ ПРОЦЕНТОВ ПО СДЕЛКЕ ОВЕРДРАФТА ОТ "+SDAT(MM_tickid(par1,"dealdate"))+" "+GetPartyName(MM_tickid(par1,"partyid"));;
         rez="Оплата процентов за овердрафт по расчетам по корсчету " +GetPartyName(MM_tickid(par1,"partyid")) + ",(" +cor_ac+ "  согл. МТ950 от "+SDAT({curdate})+") "; 
      end;
   elif (par2 == 14 )
      nclient=MM_tickid(paR1,"partyid");
      pa1=execmacrofile("dl_plib.mac", "N_fiid",MM_leg(par1,"pfi",1)) ;
      pa3=execmacrofile("dl_plib.mac", "nami",nclient) ;

      pa2=plat_dil0(par1,"102","11",DAT({curdate}),"baseamount");
      rez="Перечисление процентов МБК "+pa1+" "+string(pa2:a)+" "+pa3+" по сделке No "+MM_tickid(par1,"dealcodets")+" от "+SDAT(MM_tickid(par1,"dealdate")) ;
   end;

   return rez;
END;

MACRO opmpr(par1,par2,par3)        //par1 - id платежа, par2 - id сделки, par3 - назначение платежа(purpose)
   var que,rs5,nground,pu,rs9;
   pu=par3;
   if (par_paym(par1,"fiid") > 0 )
      if (( par3 == 9 ) or ( par3 == 10 ) or ( par3 == 11 ))
         par3=par3+100;
      end;
   end;
   nground=MM_ground(par2,par3);

   que=" select d.t_paymentid from dpmpaym_dbt d  where  d.t_dockind=102 and d.t_documentid="+par2+" and d.t_purpose="+pu;
   rs9 = LnGetRecordSet(que);
   if(rs9 != null)
     while(rs9.moveNext())
       que="update dpmrmprop_dbt set t_ground='"+nground+"' where t_paymentid="+rs9.value(0);
       rs5 = LnGetRecordSet(que);
     end;
   end;
END;



MACRO account_corr(par1,par2)
   private var que,rs5,rez="0";
   if ( par1 == 0 )
      par2=_BANK_RF;
   end;
   que="select t_account from dcorschem_dbt where rownum=1 and t_fiid="+par1+" and t_corrid="+par2;
   rs5 = LnGetRecordSet(que);
   if (rs5 != null)
      if (rs5.moveNext) 
         rez=rs5.value(0);
      end;
   end;

   return rez;
END;
/*
//teg функция по поределиению корсчета по СПИ
MACRO GetCorrAccouont(iFIID,iPartyID)
  private var quest,resQuest,resul="0";
  if ( iFIID == 0 )
     iPartyID=_BANK_RF;
  end;
 // que="select t_account from dcorschem_dbt where rownum=1 and t_fiid="+par1+" and t_corrid="+par2;
  quest=" select s.t_account acc  from dcorschem_dbt s, dbnkschem_dbt b "
        +"  where  b.t_fiid=s.t_fiid  and s.t_fiid="+iFIID
        +"   and b.t_fi_kind=s.t_fi_kind and b.t_schem=s.t_number and b.t_bankid= "+iPartyID
        +"   and rownum=1 ";
  resQuest = LnGetRecordSet(quest);
  if(resQuest != null)
     if (resQuest.moveNext) 
        resul=resQuest.value(0);
     end;
  end;
  return resul;
END;
*/

/*ищем первичную сделку МБК*/
MACRO prol(par1)
    private var rs5,que,rez,jk=0;
    rez=0;
    while (jk < 100 )
       que = "select to_number(b.t_DocumentID) from doprdocs_dbt a, doproper_dbt b where a.t_id_operation=b.t_id_operation and a.t_dockind=102 and b.t_dockind=102 and a.t_DocumentID=lpad("+par1+",34,'0') and a.t_autokey in (select max(t_autokey) from doprdocs_dbt where t_documentid = a.t_documentid and t_dockind = 102) order by  a.t_id_operation desc";
       rs5 = LnGetRecordset(que);
       if (rs5 != null)
          if (rs5.moveNext) 
             if (rs5.value(0) > 0 )
                rez=int(rs5.value(0));
                par1=rez;
             else
                jk=101;
             end;
          end;
       end;
       jk=jk+1;
    end;

    return rez;
END;

/*была ли пролонгированная сделка МБК, 0 - не было, 1 - частично*/
MACRO new_prol1(par1)
  private var que,rs01,rez=2;
  que = "select count(*) from doprdocs_dbt a, doproper_dbt b where a.t_id_operation=b.t_id_operation and a.t_dockind=102 and b.t_dockind=102 and b.t_DocumentID=lpad("+par1+",34,'0')";
  rs01 = LnGetRecordSet(que);
  if(rs01 != null)
    if(rs01.moveNext) 
      rez=rs01.value(0);
    end;
  end;
  if(rez>0)/*смотрим, была ли это частичная пролонгация*/
    rez = 2;
    que = "select nvl(count(*),0) from doproper_dbt a,doprstep_dbt s where S.T_ID_OPERATION=A.T_ID_OPERATION and a.t_dockind=102 and S.T_NUMBER_STEP=510 and a.t_DocumentID=lpad("+par1+",34,'0')";
    rs01 = LnGetRecordSet(que);
    if(rs01 != null)
      if(rs01.moveNext) 
        if(rs01.value(0)>0)
          rez=1;
        end;
      end;
    end;
  end;
  return rez;
END;

/*возвращает пролонгированную сделку*/
MACRO next_prol(par1)
  private var que,rs01,rez;
  que = "select nvl(sum(b.t_DocumentID),0) from doprdocs_dbt a, doproper_dbt b where a.t_id_operation=b.t_id_operation and a.t_dockind=102 and b.t_dockind=102 and b.t_DocumentID=lpad("+par1+",34,'0')";
  rs01 = LnGetRecordSet(que);
  if(rs01 != null)
    if(rs01.moveNext) 
      rez=int(rs01.value(0));
    end;
  end;
  return rez;
END;
/*~sdid - 2935 - Гемпель*/

//LKL  
//корректировка  платежа ОД
macro PaymMainSummUpd( DealId, v_money )
   private  var que, rs, delta;
   delta=string(v_money);
   //que = "update dpmpaym_dbt SET t_FUTUREPAYERAMOUNT = '"+delta+"' ,  t_FUTURERECEIVERAMOUNT = '"+delta+"' ,  t_AMOUNT = '"+delta+"' , t_BASEAMOUNT = '"+delta+"' ,  t_PAYAMOUNT ='"+delta+"'";
   que = "update dpmpaym_dbt SET t_futurebaseamount = " + delta + ", t_FUTUREPAYERAMOUNT = " + delta + ", t_FUTURERECEIVERAMOUNT = " + delta;     /*SVE 538385 18.01.2022*/
   que=que+" where t_dockind=102 and t_purpose=10 and t_documentid ="+ string(DealId); 
   rs = LnGetRecordSet(que);
   
   return; 
end;

//корректировка  даты ОД
macro PaymMainDateUpd( DealId, v_date )
  private  var que, rs,paymid;
  que="select t_paymentid from dpmpaym_dbt where t_dockind=102 and t_documentid ="+ string(DealId)+ " and t_purpose=10 ORDER BY t_valuedate DESC";  //SVE 520106 16.12.2020 
  rs = LnGetRecordSet(que);
  if (rs != null)
     if (rs.moveNext) 
        paymid=rs.value(0);
     end;
  end;
  Histpaym10(paymid);
  
  que = "update dpmpaym_dbt SET t_VALUEDATE='"+SDAT(v_date)+"' where t_paymentid = " + paymid;         //SVE 520106 16.12.2020  
  rs = LnGetRecordSet(que);
  que = "update dpmrmprop_dbt SET t_DATE='"+SDAT(v_date)+"' where t_paymentid = " + paymid;            //SVE 520106 16.12.2020
  rs = LnGetRecordSet(que);
  Histpaym20(paymid);

  return; 
end;

//корректировка  платежа по процентам
macro PaymProcUpd( DealId, v_money, v_date )
   private  var que, rs, delta,paymid=0;
   // VVL DEF-28983 Если платежей по процентам несколько, попытаемся найти ближайший неисполненный
   que="select t_paymentid from dpmpaym_dbt where t_dockind=102 and t_documentid ="+ string(DealId)+" and  t_purpose=11 and t_valuedate >= '"+SDAT(v_date)+"' and t_paymstatus IN (0, 1000) ORDER BY t_valuedate ASC";
   rs = LnGetRecordSet(que);
   if (rs != null)
      if (rs.moveNext) 
         paymid=rs.value(0);
      end;
   end;
   
   if (paymid==0)
      que="select t_paymentid from dpmpaym_dbt where t_dockind=102 and t_documentid ="+ string(DealId)+" and  t_purpose=11 ORDER BY t_valuedate DESC"; //SVE 520106 16.12.2020
	  rs = LnGetRecordSet(que);
	  if (rs != null)
          if (rs.moveNext) 
              paymid=rs.value(0);
          end;
      end;
   end;
   Histpaym10(paymid);
   delta=string(v_money);
   que = "update dpmpaym_dbt SET t_FUTUREPAYERAMOUNT = "+delta+" ,  t_FUTURERECEIVERAMOUNT = "+delta+" ,  t_AMOUNT = "+delta+" , t_BASEAMOUNT = "+delta+" ,  t_PAYAMOUNT ="+delta+", t_VALUEDATE='"+SDAT(v_date)+"'";
   que=que + " where t_paymentid = " + paymid;          //SVE 520106 16.12.2020
   rs = LnGetRecordSet(que);
   que = "update dpmrmprop_dbt SET t_DATE='"+SDAT(v_date)+"' where t_paymentid = " + paymid;   //SVE 520106 16.12.2020
   rs = LnGetRecordSet(que);
   Histpaym20(paymid);
   
   return; 
end;

//Получить сумму платежа
macro GetSummPaymByPurpose( DealId, Purpose, SubPurpose )
   private  var que, rs, rez;
   que = "select t_amount from dpmpaym_dbt  where t_purpose="+string(Purpose)+" and t_subpurpose="+string(SubPurpose)+"  and t_documentid ="+ string(DealId); 
   rs = LnGetRecordSet(que);
   if (rs != null)
      if (rs.moveNext) 
         rez = rs.value(0)
      end;
   end;

   return rez; 
end;



//корректировка  платежа по размещению
macro PaymDemandsUpd( DealId, v_money )
   private  var que, rs, delta;
   delta=string(v_money);
   que = "update dpmpaym_dbt SET t_FUTUREPAYERAMOUNT = '"+delta+"' ,  t_FUTURERECEIVERAMOUNT = '"+delta+"' ,  t_AMOUNT = '"+delta+"' , t_BASEAMOUNT = '"+delta+"' ,  t_PAYAMOUNT ='"+delta+"'";
   que=que+" where t_dockind=102 and t_purpose=9 and t_documentid ="+ string(DealId); 
   rs = LnGetRecordSet(que);
    
   return; 
end;


//довесок в назначение платежа
macro GetGroundAddPart(deal)
  private var gadd;
  gadd = deal.dealcode+ " от "+SDAT(deal.dealdate)+" г. с контрагентом "+ GetPartyName(deal.partyid); 

  return gadd;
end;



//получение параметров уступки для сделки
macro IsPercentComUstup(DealId)
  private  var que, rs;
  que = "select decode(ascii(t_flag1),88,1,0) from dl_ustup_dbt where t_dealid = "+ String(DealId);
  rs = LnGetRecordSet(que);
  if (rs != null)
     if (rs.moveNext) 
        return 0;
        //return rs.value(0) ; 
     else
        return 0;
     end;	
  end;
end;


macro IsExistComUstup(DealId)
  private  var que, rs;
  que = "select decode(ascii(t_flag2),88,1,0)  from dl_ustup_dbt where t_dealid = "+ String(DealId);
  rs = LnGetRecordSet(que);
  if (rs != null)
     if (rs.moveNext) 
        return rs.value(0) ; 
     else
        return 0;
     end;	
  end;
end;

macro IsContragentComPayUstup(DealId)
  private  var que, rs;
  que = "select decode(ascii(t_flag3),88,1,0) from dl_ustup_dbt where t_dealid = "+ String(DealId);
  rs = LnGetRecordSet(que);
  if(rs != null)
     return 0;
     if (rs.moveNext) 
        return  rs.value(0) ; 
     else
        return 0;
     end;	
  end;
end;

macro GetFiidComUstup(DealId)
  private  var que, rs;
  que = "select t_fiid from dl_ustup_dbt where t_dealid = "+ String(DealId);
  rs = LnGetRecordSet(que);
  if(rs != null)
    if (rs.moveNext) 
       return  rs.value(0) ; 
    else
       return 0;
    end;	
  end;
end;

macro GetProcComUstup(DealId)
  private  var que, rs;
  que = "select t_price from dl_ustup_dbt where t_dealid = "+ String(DealId);
  rs = LnGetRecordSet(que);
  if(rs != null)
    if (rs.moveNext) 
       return  rs.value(0) ; 
    else
       return 0;
    end;	
  end;
end;


macro GetFiidCodeByName(fiidname)
  private  var que, rs;
  que = "select t.t_fiid from dfininstr_dbt t where t.t_ccy='"+fiidname+"'";
  rs = LnGetRecordSet(que);
  if(rs != null)
    if (rs.moveNext) 
       return  rs.value(0) ; 
    else
       return 0;
    end;	
  end;
end;

macro GetFiidCodeByCode(fiidcode)
  private  var que, rs;
  que = "select t_fiid from dfininstr_dbt where t_fi_kind=1 and t_fi_code='"+fiidcode+"'";
  rs = LnGetRecordSet(que);
  if(rs != null)
    if (rs.moveNext) 
       return  rs.value(0) ; 
    else
       return 0;
    end;	
  end;
end;


//Получить сумму финреза
macro GetSumFinRez(DealId, fiidval)
  private  var que, rs, sumvalin, sumrubin,  sumvalout, sumrubout, res, rate;

  sumvalin  = 0.0;
  sumrubin  = 0.0;
  sumvalout = 0.0;
  sumrubout = 0.0;
  rate = 0.0;

  que = "select t_fiid, sum(t_amount) from dpmpaym_dbt where t_documentid="+ string(DealId)+" and t_payer<>1  and t_purpose !=11  and t_purpose<20 /*and t_subpurpose<>2 and t_paymstatus=32000*/ group by t_fiid order by t_fiid"; 
  rs = LnGetRecordSet(que);
  if(rs != null)
    if (rs.moveNext) 
       if (rs.value(0) == 0)
          sumrubin =  rs.value(1);
       else
          sumvalin =  rs.value(1);
       end;
    end;
    if (rs.moveNext)
       if (rs.value(0) == 0)
          sumrubin =  rs.value(1);
       else
          sumvalin =  rs.value(1);
       end;
    end;	
  end;

  que = "select t_fiid, sum(t_amount) from dpmpaym_dbt where t_documentid="+ string(DealId)+" and t_payer=1  and t_purpose !=11 and t_purpose<20 /*and t_subpurpose<>2 and t_paymstatus=32000*/  group by t_fiid order by t_fiid"; 
  rs = LnGetRecordSet(que);
  if(rs != null)
    if (rs.moveNext) 
       if (rs.value(0) == 0)
          sumrubout =  rs.value(1) ;
       else
          sumvalout =  rs.value(1) ;
       end;
    end;
    if (rs.moveNext)
       if (rs.value(0) == 0)
          sumrubout =  rs.value(1) ;
       else
          sumvalout =  rs.value(1) ;
       end;
    end;	
  end; 
  //msgbox(sumvalout+"-"+sumrubout+"-"+sumvalin+"-"+sumrubin);
  if (fiidval == 0)
     res = sumrubin - sumrubout;
  else
     if ( Получить_Курс0(rate, fiidval, {curdate}) != 0 )
        Msgbox("Не возможно получить курс за ", {curdate});
        return 1;
     end;
     res = money(sumrubin/rate) + sumvalin - money(sumrubout/rate) - sumvalout;
     //msgbox(res);
  end;
  
  return res;
end;



MACRO prolpos(par1,par2)
    private var ndealid,rs5,que,rez,jk=0,sql0, ndealid2;
    rez=0;
    // ndealid=prol(par1);
    que = "select nvl(sum(b.t_DocumentID),0) from doprdocs_dbt a, doproper_dbt b where rownum=1 and  a.t_id_operation=b.t_id_operation and a.t_dockind=102 and b.t_dockind=102 and a.t_DocumentID=lpad("+par1+",34,'0') order by  a.t_id_operation desc";
    rs5 = LnGetRecordset(que);
    if(rs5 != null)
      if (rs5.moveNext) 
         if (rs5.value(0) > 0 )
             ndealid=int(rs5.value(0));
          end;
       end;
     end;
     ndealid2=par1;
     par1=ndealid;

     // sql0=" select a.t_dealid, a.t_dealdate  from ddl_tick_dbt a , ddl_leg_dbt b where b.t_dealid=a.t_dealid and to_char(b.t_maturity,'dd.mm.yyyy')='"+DAT(par2)+"' and (  a.t_dealid = "+par1;
     sql0=" select a.t_dealid, a.t_dealdate  from ddl_tick_dbt a , ddl_leg_dbt b where b.t_dealid=a.t_dealid  and b.t_dealid !="+ndealid2+" and (  a.t_dealid = "+par1;
     jk=0;

     while (jk < 100 )
        que = "select nvl(sum(a.t_DocumentID),0) from doprdocs_dbt a, doproper_dbt b where a.t_id_operation=b.t_id_operation and a.t_dockind=102 and b.t_dockind=102 and b.t_DocumentID=lpad("+par1+",34,'0')";
        rs5 = LnGetRecordset(que);
        if(rs5 != null)
          if (rs5.moveNext) 
             if (rs5.value(0) > 0 )
                rez=int(rs5.value(0));
                par1=rez;
                sql0=sql0+ " or a.t_dealid = "+rez;
             else
               jk=101;
            end;
         end;
       end;

       jk=jk+1;
    end;
    sql0=sql0+ ")  order by a.t_dealdate desc ";
    rs5 = LnGetRecordSet(sql0);
    if(rs5 != null)
      if (rs5.moveNext) 
        rez=int(rs5.value(0));
     end;
   end;

   return rez;
END;


