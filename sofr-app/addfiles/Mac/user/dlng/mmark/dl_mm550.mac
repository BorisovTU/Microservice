import InsCarryDoc, CurrInter, MmarkInter,mmlibr, mmcarry, mmcnst_j, mmplib,dl_lib,fx_globals,funk,fxPaymentDlg;

PRIVATE FILE leg (dl_leg);
PRIVATE RECORD tick (dl_tick);


/*----------------------------------------------------------------------------
    Выполнение шага
----------------------------------------------------------------------------*/
MACRO ExecuteStep(Buffer, Document)
    var deal_pd ,acc0,acc1,rez,nflag01,nflag02,nkamount,nkfiid,nvkom,rs5,que;
    var  at = MM_Carry;


    SetBuff (tick,Document);
    DL_PrepareCarryBuffer (Buffer);
    leg.LegKind = LEG_KIND_DL_TICK;
    leg.DealID = tick.DealID;
    leg.LegID = 1;

    if (not GetEq(leg))
        mm_error ("Не найден транш сделки");
        return 1;
    end;

    deal_pd = MMFirstDoc(DL_IBCDOC, tick.DealID, true);

/*
   входные данные
   dealid сделки
   nvkom - вид комиссии (оно равно t_suppurpose в платеже (dpmpaym_dbt)
   2- комиссия уступки
   3- комиссия за выданный кредит
   4- комиссия за управление


   acc - счет по расчетам
   nflag01    - кто платит комиссию   (0 - банк, 1 - контрагент);
   nflag02    - вариант комисии  (0 -  процент комиссии от суммы сделки, 1- фиксированная сумма процентов)
   nkamount   - суммма процентов или сумма комисиии
   nkfiid     - fiid валюты комиссии


     // КОМИССИЯ ЗА КРЕДИТ
     nvkom=3;
     nflag01 = 0;
     nflag02 = 0;
     nkamount = 10;
     nkfiid = 0;  // rub
*/

    que="select   T_CREDIT_TAX_AMOUNT ,  T_CREDIT_TAX_CUR,  T_CREDIT_TAX_TERM  from DDL_GENAGR_DBT where  T_CREDIT_TAX='X' and t_partyid="+tick.partyid+ " order by t_oper desc";
    rs5 = LnGetRecordSet(que);
    if(rs5 != null)
       if (rs5.moveNext) 
               nvkom=3;
               nflag02=0;
               nkamount=rs5.value(0);
               if ( nkamount < 0 )
                   nkamount=abs(nkamount);
                   nflag01=0;
               else
                   nflag01=1;
               end;
               if ( rs5.value(1) == 1 )
                  nkfiid = 0;
               else
                  nkfiid = 0;
               end;
    // ----------------------




             if(not deal_pd.OpenAccount("СЧЕТ_47440", acc0, NULL, deal_pd.GetFIRoleByCategory("СЧЕТ_47422", deal_pd.GetLeg().PFI), NULL, deal_pd.GetTick().DealDate, deal_pd.GetLeg().PFI))
               return 1;
             end; 
             if(not deal_pd.OpenAccount("СЧЕТ_47442", acc0, NULL, deal_pd.GetFIRoleByCategory("СЧЕТ_47422", deal_pd.GetLeg().PFI), NULL, deal_pd.GetTick().DealDate, deal_pd.GetLeg().PFI))
               return 1;
             end; 

    rez=execmacrofile("dl_pkom.mac","kom_plat", tick.DealID,nvkom,acc0,nflag01,nflag02,nkamount,nkfiid) ;



    if ( rez == 1 )
        msgbox("Платеж по комиссии не сформирован !");
    end;
    // -------------------------
       end;
    end;

/*

     // КОМИССИЯ ПО УПРАВЛЕНИЮ
     nvkom = 4 ;
     nflag01 = 0;
     nflag02 = 1;
     nkamount = 100;
     nkfiid = 7;  // usd
*/

    que="select   T_CONTROL_TAX_AMOUNT,  T_CONTROL_TAX_CUR,  T_CONTROL_TAX_TERM  from DDL_GENAGR_DBT where  T_CONTROL_TAX='X' and t_partyid="+tick.partyid;
    rs5 = LnGetRecordSet(que);
    if(rs5 != null)
       if (rs5.moveNext) 
               nvkom = 4 ;
               nflag02=0;
               nkamount=rs5.value(0);
               if ( nkamount < 0 )
                   nkamount=abs(nkamount);
                   nflag01=0;
               else
                   nflag01=1;
               end;
               if ( rs5.value(1) == 1 )
                  nkfiid = 0;
               else
                  nkfiid = 7;
               end;


    if ( nflag01 == 0 )
      if ((leg.pfi != nkfiid) and ( nkfiid == 0 ))
        if(not deal_pd.ActualAccount("СЧЕТ_47423B", acc0, NULL, deal_pd.GetFIRoleByCategory("СЧЕТ_47422", 0), NULL, deal_pd.GetTick().DealDate, 0))
          return 1;
        end; 
      else
        if(not deal_pd.ActualAccount("СЧЕТ_47423", acc0, NULL, deal_pd.GetFIRoleByCategory("СЧЕТ_47422", deal_pd.GetLeg().PFI), NULL, deal_pd.GetTick().DealDate, deal_pd.GetLeg().PFI))
          return 1;
        end; 
      end;
    else
      if ((leg.pfi != nkfiid) and ( nkfiid == 0 ))
        if(not deal_pd.ActualAccount("СЧЕТ_47422B", acc0, NULL, deal_pd.GetFIRoleByCategory("СЧЕТ_47422", 0), NULL, deal_pd.GetTick().DealDate, 0))
          return 1;
        end; 
      else
        if(not deal_pd.ActualAccount("СЧЕТ_47422", acc0, NULL, deal_pd.GetFIRoleByCategory("СЧЕТ_47422", deal_pd.GetLeg().PFI), NULL, deal_pd.GetTick().DealDate, deal_pd.GetLeg().PFI))
          return 1;
        end; 
      end;
    end;


    rez=execmacrofile("dl_pkom.mac","kom_plat", tick.DealID,nvkom,acc0,nflag01,nflag02,nkamount,nkfiid) ;
    if ( rez == 1 )
        msgbox("Платеж по комиссии не сформирован !");
    end;

    // -------------------------
       end;
    end;



    return rez;
END;



MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -откат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */  


  private var pplid;
  SetBuff(tick, FirstDoc );

  if ( CommitOrRollback == 2 )
     pplid=plat_dil0(tick.dealid,"102","72",SDAT({curdate}),"paymentid");
     DelAddedPayment(pplid) ;
  end;

END;







