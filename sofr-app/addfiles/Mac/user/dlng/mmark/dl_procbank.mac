/***********************************************************
 Сделки МБК за дату
************************************************************/

import RSBDataSet, dlgCommon,funk,dl_plib,"fiInfo.mac";
IMPORT FIInter,rsexts,oralib,likepy,rcw;


  MACRO  new_file(dir0,nname)
    FILE fn () txt  ;
    var DirList = TDirList;
    private var  name, nxltfile ,rez=0,ff;
        nxltfile = dir0+nname;
	DirList.List(nxltfile, "F");
        if( DirList.Count == 1 )
	     ff=dir0+nname;
	     if (not Open(fn,ff ))
	     else
                 rez=1;
	         Close (fn);
	     end;
        end;
        return rez;
  END;





     private var nach_tabl=6; // до строки 6 - "шапка" таблицы
     private var sql0, sql, pdir, xltfile, file_out, par0, ob,ii=1,jj=3, str, ind_cl_pos,{curdate},dat,S1,S2,d3,nnn,kd;
     private var dat2,is2,valuedate,price,acc0,que,rs45,irez,dealid,nndealid,vari,xltfile0,xltfile2;
     var obj = CreateObject("rsax", "TRsAxServer", "RsAxServer", false); 

     Var shell = CreateObject ("rsax", "TRsAxServer", "RsAxServer", false).CreateComObject ("WScript.Shell");
     Var MyDocument = shell.RegRead ("HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\\Personal");






      // dat={curdate};
      dat=date("30.04.2019");
      // getdate(dat,"Уточните дату отчета");
      dat2=dat;
      dat=СДАТ(dat);


         xltfile="cb0.xlsx";


	xltfile0=xltfile;
	xltfile2="..\\import\\BR\\" + xltfile;
	xltfile = "$" + MyDocument + "\\" + xltfile;

                if ( not copyfile(xltfile2,xltfile,true ) )
         	 msgbox("Недоступен файл на сервере приложений !");
                 return 0;
         	end;


    ob = obj.CreateComObject("Excel.Application");
    ob.Workbooks.Open(xltfile0);

      ob.Sheets("Депозит").Select;
         
     ii=2;
  
     while ( ii < 52)

         s1 = ob.Cells(ii,2).Value;   
         s2 = ob.Cells(ii,4).Value;   

         que="update ddl_tick_dbt set t_dealcodets='"+string(s2)+"' where t_dealcode= '"+string(s1)+"'";
         rs45 = LnGetRecordSet(que);
         if(rs45 != null)
           println(s1," = ",s2);
         else
           println("!!!!!!!!!!!!!!!  Сделка не обновлена",  s1);
         end;
		         
	 ii=ii+1;
     end;



    ob.Visible = true;
  //  ob.DisplayAlerts = false;
  //  ob.ActiveWorkbook.SaveAs(file_out);
  //  ob.ActiveWorkbook.Close(file_out);
  //  ob         = null;
      msgbox("Отчет сформирован !");

   // exit(1);
end;






