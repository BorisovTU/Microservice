/*
$Name: dl_epaym.mac
$Module: МБК
$Description: Панель условий досрочного гашения
*/
IMPORT dl_lib, dl_note_lib, funk, RSD;
Private const kbF2 = 316, kbF3 = 317, kbF7 = 522, kbF9 =323, kbEnter = 13;

Class (TRecHandler) CPanelEpaym ( _DealId, _IsEnable, _DateClose, _SummaProc, _SummaProcP )
    private var IsEnable, DateClose, SummaProc, SummaProcP, DealId;

    InitTRecHandler ("epaym", "mbkadd.lbr", TRUE);
    IsEnable  = _IsEnable;
    DateClose = _DateClose;
    SummaProc = _SummaProc;
    SummaProcP= _SummaProcP;
    DealId    = _DealId;

    Macro Handler ( dlg, cmd, id, key )

      if (not IsEnable)
       //disableFields( dlg, 3);
	disableFields( this);
      end;	
      if( (cmd == DLG_KEY) and (key == kbF9)  )
//        UpdateFields (dlg);
//         if ( IsEnable and (this.("CloseDateP") >= {curdate}) and  (this.("CloseDateP") < DateClose ) and (this.("SummaProcP")>=0) and (this.("SummaProcP")<=SummaProc) )
	   SetNoteDifValue(DealId, 103, DAT(this.("CloseDateP")));
	   SetNoteDifValue(DealId, 104, this.("SummaProcP"));
           //PaymMainDateUpd(DealId, this.("CloseDateP")); //VVL DEF-28983 Функция обновляет дату платежа по погашению ОД при досрочном погашении процентов, что приводит к ошибке
           PaymProcUpd(DealId, this.("SummaProcP"), this.("CloseDateP"));
           return CM_SAVE;
/*
         else
           msgbox("Проверьте корректность условий досрочного погашения!");
           return CM_CANCEL;
         end;
*/
      elif( (cmd == DLG_KEY) and (key == kbEnter)  )

           return CM_IGNORE;
      end;
    End;

    Macro Init
      private var regval;
      this.("CloseDate")  = DateClose;
      this.("CloseDateP") = {curdate};
      this.("SummaProc")  = SummaProc;
      this.("SummaProcP") = SummaProcP;
    End;

    
    Macro Run
        Init ();
        return RunDialog (this, R2M (this, "Handler"));
    End;

end;