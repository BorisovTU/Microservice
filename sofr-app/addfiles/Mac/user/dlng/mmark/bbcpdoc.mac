/*
$Name:             bbcpdoc.mac
$Module:           Бухгалтерия банка Banking
$Description:      Макрос скроллинга валютных платежных документов в ББ
*/
/***********************************************************************
          Автоматизированная банковская система RS-Bank v6.0           
                  Copyright (c) R-Style Software Lab                   
   Имя файла        : psrqdoc.mac
   Описание         : Макродействия валютных банковских платежей
   Создан           : 01.03.2011                                       
***********************************************************************/

import globals, check117, "pmchoper.mac", "pm_tools.mac", PaymInter, "pm_opr.mac", pmbuff, pm_chksave, "pm_syscont.mac", "pmedit.mac",funk;

/*номера полей в панели*/
const fld_Number      = 1,
      fld_Date        = 2,
      fld_DateValue   = 3,
      fld_Amount      = 19;
const fld_kzPayerCode    = 13,
      fld_kzReceiverCode = 30;


macro BB_CurPayOrderNewDoc()
  return 0;
end;

macro BB_CurPayOrderUserFunc( Режим:integer )

  private var ii,rs21,que;
  ii=0;
  getint(ii,"ВВОД");
  if ( ii == 1000 )
      que="update dpmpaym_dbt set t_paymstatus=1000 where t_paymentid="+r_pmpaym.paymentid;
      rs21 = LnGetRecordSet(que);
      MSGBOX("отправлен в РС !");
  elif ( ii == 32000 )
      que="update dpmpaym_dbt set t_paymstatus=32000 where t_paymentid="+r_pmpaym.paymentid;
      rs21 = LnGetRecordSet(que);
      MSGBOX("отправлен в банк !");
  elif ( ii == 100 )
      que="update dpmpaym_dbt set t_paymstatus=100 where t_paymentid="+r_pmpaym.paymentid;
      rs21 = LnGetRecordSet(que);
      MSGBOX("отказ !");
  elif ( ii == 0 )
      que="update dpmpaym_dbt set t_paymstatus=0 where t_paymentid="+r_pmpaym.paymentid;
      rs21 = LnGetRecordSet(que);
      MSGBOX("отказ !");


  end;



  return 1;
end;
             
macro BB_CurPayOrderCheckDoc( Режим )

  var stat     :integer = 0,
      ret_val  :bool,
      note     :string  = "",
      res      :integer,
      save_note:string  = "",
      ErrStr   :string  = "",
      OldDoc :integer = 0;

  /*Проверить исходящую ДПП*/
  /*Проверяем номер для всех документов, в том числе и отложенных.*/
  if( (Режим == 2 ) or (Режим == 3) or (Режим == 8) )
    if( needUseKZpm() )
      if( CompareStrWithMasks("10-29&??", r_pmkz.PayerCode) )
        MsgBox("Некорректное значение КОд");
        return fld_kzPayerCode;
      end;
      if( CompareStrWithMasks("10-29&??", r_pmkz.ReceiverCode) )
        MsgBox("Некорректное значение Кбе");
        return fld_kzReceiverCode;
      end;
    end;
    if( StrLen( r_pmrmprop.Number ) == 0 )
      MsgBox("Не задан номер документа");
      return fld_Number;
    end;
    if( r_pmpaym.Amount < 0.0 )
      msgbox("Нельзя задавать отрицательную сумму");
      return fld_Amount;
    end;

    if( PM_CheckPayments( r_pmpaym, NULL, r_credit, r_pmrmprop, 1 ) )
      return 1;
    end;

    if( StrLen( r_pmrmprop.PartyInfo)>210-33 )
    if( RsbGetTrue( False,True,"Информация участнику превышает 177 символов.|Продолжить?")==False )
         return 1;
      end;
    end;

    if( StrLen( r_pmrmprop.ReceiverBankName)>140 )
    if( RsbGetTrue( False,True,"Наименование банка получателя превышает 140 символов.|Продолжить?")==False )
         return 14;
      end;
    end;

    if( StrLen( r_pmrmprop.PayerBankName)>140 )
    if( RsbGetTrue( False,True,"Наименование банка плательщика превышает 140 символов.|Продолжить?")==False )
         return 1;
      end;
    end;

    if( StrLen( r_pmrmprop.ReceiverName)>160 )
    if ( RsbGetTrue( False,True,"Наименование получателя превышает 160 символов.|Продолжить?")==False )
         return 16;
      end;
    end;

    if( StrLen( r_pmrmprop.PayerName)>160 )
    if ( RsbGetTrue( False,True,"Наименование плательщика превышает 160 символов.|Продолжить?")==False )
         return 10;
      end;
    end;

    if( GetDialogFlag() )
      if(PM_CheckCO(r_pmpaym,r_pmrmprop,0,r_credit))
        return 1;
      end;
    end;

    ErrStr = PM_CheckPaymAccounts( r_pmpaym, NULL, r_credit, r_pmrmprop, 1 );

    if( strlen(ErrStr) > 0 )
      msgbox( ErrStr );
      return 1;
    end;

    stat = BBCP_ScrolMacroCommonChecks( TPanelFields(), r_pmpaym, r_debet, r_credit, r_pmrmprop, r_pmserv );
    if( stat != NOTERROR )
      return stat;
    end;

    /* Проверить по 117-И */
    if( CheckOnSave_117( r_pmpaym, NULL, r_credit, NULL, r_pmrmprop ) )
      return fld_Number;
    end;

  end;

  if( Режим == 1 ) /*УДАЛЕНИЕ ДОКУМЕНТА*/
    if(not isDLMRuning())
      if(r_pscpord.Origin == CP_OR_DEPOSIT )
        if(not Index( "Д", StrFor(GetIdentProgram())))
          msgbox("Документ порожден п/с \"Депозиты\".|Удаление запрещено.");
          stat = 1;
        end;

      elif(r_pscpord.Origin == CP_OR_ZP)
        msgbox("Документ порождён п/с \"Заработная плата\".|Удаление запрещено.");
        stat = 1;
    
      elif(r_pscpord.Origin == CP_OR_RMRETURN)
        msgbox("Документ порождён п/с \"АРМ позиционера\".|Удаление запрещено.");
        stat = 1;

      elif(r_pscpord.Origin == CP_OR_SF)
        msgbox("Документ является платой за обслуживание.|Удаление запрещено.");
        stat = 1;

      /* Документ из Клиент-Банк'а (или БОУРМ) */
      elif(r_pscpord.Origin == CP_OR_CLB) 
        save_note = note = readNoteForObject(OBJTYPE_BBANKCPORDER, makeObjectID(OBJTYPE_BBANKCPORDER, NULL, r_pscpord), NOTEKIND_BBCPORD_DELETEGROUND);
        ret_val = GetString(note, "Основание для удаления документа, полученного по системе \"Клиент-Банк\"", 68);
        if( ret_val and (save_note != note) )
          stat = addNoteForObject(OBJTYPE_BBANKCPORDER, makeObjectID(OBJTYPE_BBANKCPORDER, null, r_pscpord), NOTEKIND_BBCPORD_DELETEGROUND, note);
          if(stat)
            MsgBox("Ошибка добавления примечания к документу");
            return stat;
          end;
        end;
        if( not note )
          MsgBox("Документ получен по системе \"Клиент-Банк\".|Удаление без ввода основания запрещено.");
          return 1;
        end;

      elif(r_pscpord.Origin == CP_OR_LOANS)
        if(not Index( "Ц", StrFor(GetIdentProgram())))
          msgbox("Документ порождён п/с \"Кредитование\".|Удаление запрещено.");
          stat = 1;
        end;

      elif(r_pscpord.Origin == CP_OR_DEPOSIT)
        if(not Index( "Д", StrFor(GetIdentProgram())))
          msgbox("Документ порождён п/с \"Депозиты\".|Удаление запрещено.");
          stat = 1;
        end;

      elif(r_pscpord.Origin == CP_OR_RETAIL)
        if(not Index( "ВБD", StrFor(GetIdentProgram())))
          msgbox("Документ порождён п/с \"Обслуж.физ.лиц\".|Удаление запрещено.");
          stat = 1;
        end;

      elif(r_pscpord.Origin == CP_OR_PROCUNKNOWNPM)
        msgbox("Документ порожден при обработке невыясненной суммы.|Удаление запрещено.");
        stat = 1;
      end;
    end;

    if(CheckDeletePayment(r_pmpaym.PaymentID))
      return 1;
    end;

  elif( Режим == 2 )  /* ВВОД ДОКУМЕНТА */
  elif( Режим == 3 )  /* РЕДАКТИРОВАНИЕ ДОКУМЕНТА */
    if (StandartCheckUpdate(TCheckUpdateParam(r_pmpaym, r_debet, r_credit, r_pmrmprop), 
        TCheckUpdateParam(r_pmpaym_old, r_debet_old, r_credit_old, r_pmrmprop_old)) == CHANG_NOTKEEP)
      return CHANG_NOTKEEP;
    end;
  elif( Режим == 7 ) /*ПОМЕЩЕНИЕ ДОКУМЕНТА В ОТЛОЖЕННЫЕ, ОТКАТ ОПЕРАЦИИ*/
  elif( Режим == 8 )  /*ВВОД В ОТЛОЖЕННЫЕ*/
  elif(Режим == OBJ_AFTEREDIT) /* Проверка важности изменений влияющей на необходимость смены опера документа
                                  (изменения в буферах не сохраняются) */
    return IsImportantChangeForOperBbCpOrder(r_pmpaym, r_pmpaym_old, r_pmrmprop, r_pmrmprop_old, r_credit, r_credit_old);

  end;

  return stat;

end;