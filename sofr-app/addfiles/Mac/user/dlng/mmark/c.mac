import rsd;
var str = "XS0979891925; OJSC RUSS AGRIC BK(RSHB); price 112,80; vol. 300; BUY";
var Client ="ИП ХОБОТОВ ЛЕВ ЕВГЕНЬЕВИЧ/CC0001000010";

macro Splt (str_,char_):tarray;
   Var splitted=tarray;
   Var ind=1;
   Var pos=1;
   splitted[1]="";
   while(pos<=strlen(str_))
      if (substr(str_,pos,1)==char_)
         splitted[ind]=trim(splitted[ind]);
         ind=ind+1;
         splitted[ind]="";
         pos=pos+1;
      else
         splitted[ind]=splitted[ind]+substr(str_,pos,1);
         pos=pos+1;
      end;
   end;
   return splitted;
end;

Var data = Splt (str,";");
Var price = money (trim(substr(strSubst(data[3],",","."), 6)));
Var amount = int (trim(substr(data[4], 5)));
Var type_operation = 0;

if (substr(trim(data[5]),1,1) == "B")
   type_operation = 2183;
else
   type_operation = 2193;
end;

[#] (trim(data[1]));
[#] (trim(data[2]));
[##################] (price:l);
msgbox (price);

[##################] (amount);
[#######] (type_operation);

Macro NormValue (vl)
  if (valtype (vl) == 26)
     return "";
  end;
  return vl;
End;

Macro Get_tick (dealtype, price, principal, isin, code, nameClient)

   Var sql = rsdcommand ("select count (1) over () cnt, tick.t_dealid, tick.t_dealcode, tick.t_dealcodets, tick.t_partyid, tick.t_clientid, tick.t_pfi, leg.t_principal, leg.t_price, upper(pt.t_name) name "+ 
                         "  from ddl_tick_dbt tick, ddl_leg_dbt leg, davoiriss_dbt avoiriss, dparty_dbt pt, dobjcode_dbt obj "+
                         " where tick.t_bofficekind = 101 "+
                         "   and tick.t_dealtype = :1 "+
                         "   and tick.t_clientid = obj.t_objectid "+
                         "   and leg.t_dealid = tick.t_dealid "+
                         "   and leg.t_price = :2 "+
                         "   and leg.t_principal = :3 "+
                         "   and avoiriss.t_fiid = tick.t_pfi "+
                         "   and avoiriss.t_isin = :4 "+
                         "   and obj.t_code = :5 "+
                         "   and obj.t_objecttype = 3 "+
                         "   and pt.t_partyid = tick.t_clientid ");
   sql.AddParam (":1", RSDBP_IN, dealtype);
   sql.AddParam (":2", RSDBP_IN, price);
   sql.AddParam (":3", RSDBP_IN, principal);
   sql.AddParam (":4", RSDBP_IN, isin);
   sql.AddParam (":5", RSDBP_IN, code);
   Var x = rsdrecordset (sql);
   if (x.movenext)
      msgbox (1);
      if (x.value("cnt") > 1)
         msgbox ("найдено более одной сделки |для клиента "+x.value("name")+" /"+code +"|ценная бумага "+isin+"|цена "+price+" количество "+principal);
      end;
   else
      msgbox ("не найдено ни одной сделки |для клиента "+NameClient+" /"+code +"|ценная бумага "+isin+"|цена "+price+" количество "+principal+"| Заявка не будет сформирована");

   end;

End;
Get_tick (2193, 2900, 35,"RU000A0JREQ7", "CC00010000334", "xxxxxxxxx");


/*
while(next(infile))
  numstring=numstring+1;
  infile.str=ToANSI(infile.str);             
  data=splt(infile.str,";");
  if (strlen(trim(infile.str)) > 0)
    init_Deal (data, numstring);
  end;
end;
*/


