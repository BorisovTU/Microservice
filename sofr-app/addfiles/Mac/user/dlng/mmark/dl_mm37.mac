import InsCarryDoc, CurrInter, Проценты, MmarkInter, mmlibr, mmcarry, mmcnst_j, mmplib,dl_lib ;

PRIVATE FILE leg (dl_leg);
// PRIVATE FILE pm ("pmpaym") key 1 write;
PRIVATE RECORD tick (dl_tick);


/*----------------------------------------------------------------------------
    Выполнение шага
----------------------------------------------------------------------------*/
MACRO ExecuteStep(Buffer, Document)
    var deal_pd ,acc0,acc2, acc0p, s_addground;
    var  at  = MM_Carry;  //ОД
    var  atp = MM_Carry;  //Проценты
    var SumReceiver = 0;

    SetBuff (tick, Document);
    DL_PrepareCarryBuffer (Buffer);
    leg.LegKind = LEG_KIND_DL_TICK;
    leg.DealID = tick.DealID;
    leg.LegID = 1;

    if (not GetEq(leg))
        mm_error ("Не найден транш сделки");
        return 1;
    end;

    deal_pd = MMFirstDoc(DL_IBCDOC, tick.DealID, true);

     s_addground = GetGroundAddPart(tick);

     if(not deal_pd.OpenAccount("СЧЕТ_91418", acc0, NULL, deal_pd.GetFIRoleByCategory("СЧЕТ_91418", deal_pd.GetLeg().PFI), NULL, deal_pd.GetTick().DealDate, deal_pd.GetLeg().PFI))
        return 1;
     end;    
//SVE 488222
     //if(not deal_pd.OpenAccount("ВнебалСчетКорресп0", acc2, NULL, deal_pd.GetFIRoleByCategory("ВнебалСчетКорресп", deal_pd.GetLeg().PFI), NULL, deal_pd.GetTick().DealDate, deal_pd.GetLeg().PFI))
     var sql = DL_RSDCommand("select t_kind_account from daccount_dbt where t_account = ?");
     sql.AddParam(acc0);
     var data = sql.Execute();
     if ( data.MoveNext() )  //проверка типа счета
        if (data.kind_account = "А")  //если счет 91418 активный
           if(not deal_pd.OpenAccount("ВнебалСчетКорресп", acc2, NULL, FIROLE_CORACC_ACTIVE, NULL, deal_pd.GetTick().DealDate, NATCUR))
              return 1;
           end; 
        else  // если счет 91418 пассивный
           if(not deal_pd.OpenAccount("ВнебалСчетКорресп", acc2, NULL, FIROLE_CORACC_PASSIVE, NULL, deal_pd.GetTick().DealDate, NATCUR))
              return 1;
           end;
        end;
     else
        msgbox("Не удалось определить вид счета " + acc0 +" для определения счета по Кредиту");
        return 1;
     end;
     


          at.AccountPayer    = acc0;	  
          at.AccountReceiver = acc2;
          at.FIIDPayer       = leg.pfi;
          //at.FIIDReceiver    = leg.pfi;
          at.FIIDReceiver    = NATCUR;

          //SVE 488222 так как счет 99999 в рублях, а второй счет может быть в другой валюте, то необходимо конвертировать сумму
          SmartConvertSumDbl(SumReceiver, leg.principal, deal_pd.GetTick().DealDate, deal_pd.GetLeg().PFI, NATCUR, false);

          at.SumReceiver     = SumReceiver;
          at.Chapter         = 3;
          at.Ground          = "Отражение номинальной стоимости приобретенных прав требований (ОД) по договору № " + s_addground;
          if(not at.carry())
             msgbox("Error !");
             return false;
          end;

/*
// другой счет и сумма процентов - делать
     if(not deal_pd.OpenAccount("СЧЕТ_91418P", acc0p, NULL, deal_pd.GetFIRoleByCategory("СЧЕТ_91418P", deal_pd.GetLeg().PFI), NULL, deal_pd.GetTick().DealDate, deal_pd.GetLeg().PFI))
        return 1;
     end;    

          atp.AccountPayer    = acc0p;	  
          atp.AccountReceiver = acc2;
          atp.FIIDPayer       = leg.pfi;
          atp.FIIDReceiver    = leg.pfi;
          atp.SumReceiver     = GetSummPaymByPurpose(tick.DealID, 11, 1);
          atp.Chapter         = 3;
          atp.Ground          = "Отражение номинальной стоимости приобретенных прав требований (ПРОЦЕНТЫ) по договору № " + s_addground; 
          if(not atp.carry())
             msgbox("Error !");
             return false;
          end;
*/
    return 0;
END;

MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -откат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */  


  private var sql,rs01,rs05,pplid,acc4;
  SetBuff(tick, FirstDoc );

  if ( CommitOrRollback == 1 )
        sql="select count(*) from dwldlmm_dbt a, ddl_tick_dbt b where b.t_dealid="+tick.dealid+" and  a.t_dealid=b.t_dealid";
        rs01 = LnGetRecordSet(sql);
        if(rs01 != null)
          if (rs01.moveNext) 
            if (int(rs01.value(0)) > 0 )
               sql="update dwldlmm_dbt set  t_dealcodeps=substr(t_dealcode,4), t_state=20  where t_dealid="+tick.dealid; 
               rs05 = LnGetRecordSet(sql);
            end;
          end;
        end;

       if ( tick.dealtype == 12306 )
         pplid=plat_dil(tick.dealid,"102","9","paymentid");
         opmpr(pplid,tick.dealid,9);
         acc4 =MM_acc(tick.dealid,111);
         sql="update dpmpaym_dbt set t_payeraccount='"+acc4+"' where t_paymentid="+pplid;
         rs05 = LnGetRecordSet(sql);
         sql="update daccount_dbt set t_userfield3='1' where t_account='"+acc4+"'";
         // rs05 = LnGetRecordSet(sql);

         pplid=plat_zak(tick.dealid,"102","11",1,"paymentid");
         acc4 =MM_acc(tick.dealid,117);
         sql="update daccount_dbt set t_userfield3='1' where t_account='"+acc4+"'";
         // rs05 = LnGetRecordSet(sql);

         pplid=plat_zak(tick.dealid,"102","10",0,"paymentid");
         opmpr(pplid,tick.dealid,10);
         acc4 =MM_acc(tick.dealid,111);
         sql="update dpmpaym_dbt set t_payeraccount='"+acc4+"' where t_paymentid="+pplid;
         rs05 = LnGetRecordSet(sql);

         pplid=plat_zak(tick.dealid,"102","11",1,"paymentid");
         opmpr(pplid,tick.dealid,11);
         acc4 =MM_acc(tick.dealid,118);
         sql="update dpmpaym_dbt set t_payeraccount='"+acc4+"' where t_paymentid="+pplid;

       end;


  end;

  return 0;
END;
