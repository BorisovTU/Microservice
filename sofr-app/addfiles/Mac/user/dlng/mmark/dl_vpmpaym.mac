import funk;
RECORD tick(dl_tick);
PRIVATE VAR leg = TBfile("dl_leg");
array mas,mas2;
mas(0)="Платеж по ОД                  ";


MACRO PrintStepDocs (
                ID_Operation,  /* Номер экземпляра операции */
                ID_Step,       /* Номер шага операции */
                Kind_Operation,/* Вид операции */
                KindStep)      /* Вид шага операции */
               
    var oproper = TBfile("oproper.dbt"),
         dl_tick = TBfile("dl_tick.dbt") ;
    var que,rs01,idpm,kk,ii,sdop= " ",rs9;
    
    oproper.rec.ID_Operation = ID_Operation;
    
    if (not oproper.GetEq )
      msgbox( "Не найдена сделка ", ID_Operation );
      return 1;
    end;  

    ClearRecord( tick );
    
    if( (not RestoreFromUniID(oproper.rec.DocumentID, dl_tick, OBJTYPE_MMARKDEAL,oproper.rec.DocKind)) OR       
          (not GetEQ(dl_tick)) )    
      msgbox( "Не найдена сделка ");
      return 1;
    end;    

    Copy (tick, dl_tick);
    kk=0;
    que="select count(*) from doproper_dbt aa1 ,  doprdocs_dbt dd1, dpmpaym_dbt bb1 where aa1.t_dockind=102 and aa1.t_DocumentID=lpad("+tick.dealid+",34,'0')";
    que=que+"and dd1.t_id_operation=aa1.t_id_operation and (dd1.t_dockind=16 or dd1.t_dockind=27)   and bb1.t_paymentid=to_number(dd1.t_documentid)";
    rs01 = LnGetRecordSet(que);
    if(rs01 != null)
      if (rs01.moveNext) 
          kk=int(rs01.value(0));
      end;
    end;

    if ( kk == 2 )

      ii=0;
      que="select bb1.t_amount,bb1.t_paymentid from doproper_dbt aa1 ,  doprdocs_dbt dd1, dpmpaym_dbt bb1 where aa1.t_dockind=102 and aa1.t_DocumentID=lpad("+tick.dealid+",34,'0')";
      que=que+"and dd1.t_id_operation=aa1.t_id_operation and (dd1.t_dockind=16 or dd1.t_dockind=27)   and bb1.t_paymentid=to_number(dd1.t_documentid) order by bb1.t_paymentid ";
      rs9 = LnGetRecordSet(que);
      if(rs9 != null)
        while(rs9.moveNext())
          mas(ii)="Платеж на сумму "+string(rs9.value(0))+"                ";;
          mas2(ii)=rs9.value(1);
          ii=ii+1;
        end;
      end;

       ii=menu(mas,"Укажите вариант вывода информации","Укажите вариант вывода информации");
       if ( ii < 0 )
          exit(1); 
       end;

      sdop=" and t_paymentid="+mas2(ii);
      que="select bb1.t_paymentid from doproper_dbt aa1 ,  doprdocs_dbt dd1, dpmpaym_dbt bb1 where aa1.t_dockind=102 and aa1.t_DocumentID=lpad("+tick.dealid+",34,'0')";
      que=que+"and dd1.t_id_operation=aa1.t_id_operation and (dd1.t_dockind=16 or dd1.t_dockind=27)   and bb1.t_paymentid=to_number(dd1.t_documentid) "+sdop;
    else
      que="select bb1.t_paymentid from doproper_dbt aa1 ,  doprdocs_dbt dd1, dpmpaym_dbt bb1 where aa1.t_dockind=102 and aa1.t_DocumentID=lpad("+tick.dealid+",34,'0')";
      que=que+"and dd1.t_id_operation=aa1.t_id_operation and (dd1.t_dockind=16 or dd1.t_dockind=27)   and bb1.t_paymentid=to_number(dd1.t_documentid) order by bb1.t_paymentid ";
    end;

    rs01 = LnGetRecordSet(que);
    if(rs01 != null)
      if (rs01.moveNext) 
         execmacrofile("plpaym.mac", "PaymDlg2", 0,rs01.value (0)) ;
      end;
    end;

    exit(1);

END;
