/****************************************************/
/*Реестр активного МБК по состоянию на отчетную дату*/                                    
/*LKL                                               */
/****************************************************/
import "or_rep_h.mac", RsbDataSet,datelib,Календарь, FIInter;
import funk, dl_plib;

private var Rep : CMakeReport; /* Объект вида CMakeReport */ 
        var aa,sql,val,typ,rs0,daot,i,ii,jk,ost1=0,ost2=0,para1,para2,vals,typs,da1,da2,dox,rasx,tips,jj;
var koli;
const FontStyleTitel = "ex_FS(b)";
const FontStyleRow   = "";//"ex_FS(b)";

private macro SDAT0(s);
      private var ss;
      ss=trim(substr(string(s),1,10));
      if (substr(ss,3,1) != "." )
       ss="0"+ss;
      end; 

      return(ss);
end;

//Курс по FIID на дату
macro GetRateMain(FIID, D: date)
  var ft;
  record rate(ratedef);
  if (FIID == 0)
    return 1;
  end;
  ft = ПолучитьКурс(rate, NATCUR, FIID);
  if (ft == 0)
    ft = ПолучитьЗначениеКурса(rate, D);
  end;
  return ConvertSum($1, rate.rate, rate.scale, rate.point, rate.isinverse);
end;


private macro GetDND(dealid, bdt)
     private var que,rs,rez=" ", delta;

     que =   "select min(t.t_valuedate) from dpmpaym_dbt t where t.t_dockind=102 and t.t_documentid="+string(dealid)+" and t.t_purpose=11 and t.t_valuedate > to_date('"+da2+"','DD.MM.YYYY')";
     rs = LnGetRecordset(que);
     if(rs != null)
       if (rs.moveNext) 
         rez=rs.value(0);
       end;
     end;

     return (rez);
end; 


//остаток в рублях
private macro GetRestAcc(acc, dt)
     private var que,rs,rez=" ";
     que =       "select abs(rsb_account.restac(a.t_account, a.t_code_currency, to_date('"+sdat0(dt)+"','dd.mm.yyyy'), a.t_chapter,null,decode(a.t_chapter,5,a.t_code_currency,0) )) ";
     que = que + "from daccount_dbt a where a.t_account = '"+acc+"'";
     
     rs = LnGetRecordset(que);
     if(rs != null)
       if (rs.moveNext) 
         rez=rs.value(0);
       end;
     end;
     return money(rez);
end; 

private macro GetRestAccCur(acc, dt)
     private var que,rs,rez=" ";
     que =       "select abs(rsb_account.restall(a.t_account,a.t_chapter, a.t_code_currency, to_date('"+sdat0(dt)+"','dd.mm.yyyy'), null)) ";
     que = que + "from daccount_dbt a where a.t_account = '"+acc+"'";
     
     rs = LnGetRecordset(que);
     if(rs != null)
       if (rs.moveNext) 
         rez=rs.value(0);
       end;
     end;
     return money(rez);
end; 


private macro GetDebet(acc, dt1, dt2)
     private var que,rs,rez=" ";
     que =       "select abs(rsb_account.debeta(a.t_account,a.t_chapter, to_date('"+sdat0(dt1)+"','dd.mm.yyyy'), to_date('"+sdat0(dt2)+"','dd.mm.yyyy'), a.t_code_currency, null)) ";
     que = que + "from daccount_dbt a where a.t_account = '"+acc+"'";
     
     rs = LnGetRecordset(que);
     if(rs != null)
       if (rs.moveNext) 
         rez=rs.value(0);
       end;
     end;
     return money(rez);
end; 

private macro GetCredit(acc, dt1, dt2)
     private var que,rs,rez=" ";
     que =       "select abs(rsb_account.kredita(a.t_account,a.t_chapter, to_date('"+sdat0(dt1)+"','dd.mm.yyyy'), to_date('"+sdat0(dt2)+"','dd.mm.yyyy'), a.t_code_currency, null)) ";
     que = que + "from daccount_dbt a where a.t_account = '"+acc+"'";
     
     rs = LnGetRecordset(que);
     if(rs != null)
       if (rs.moveNext) 
         rez=rs.value(0);
       end;
     end;
     return money(rez);
end; 



private macro GetAccDPD(acc)
     private var que,rs,rez=" ";
     que =  "select max(t.t_RestDate ) "; 
//decode(to_char(nvl(max(rtbl.t_RestDate ),to_date('01.01.0001','dd.mm.yyyy')),'dd.mm.yyyy'),'01.01.0001',' ',to_char(nvl(max(rtbl.t_RestDate ),to_date('01.01.0001','dd.mm.yyyy')),'dd.mm.yyyy')) 
     que = que + "from  daccount_dbt a, drestdate_dbt t where   a.t_account = '"+acc+"' and t.t_accountid = a.t_accountid ";
     
     rs = LnGetRecordset(que);
     if(rs != null)
       if (rs.moveNext) 
         rez=rs.value(0);
       end;
     end;
     return rez;
end; 

private macro GetDelayDays(dealid, purpose) 
     private var que,rs,rez;
     que = "select nvl(min(t.t_valuedate),to_date('31122099','ddmmyyyy')) from dpmpaym_dbt t ";
     que = que +  "where t.t_dockind=102 and t.t_purpose="+string (purpose) +" and t.t_documentid="+ string(dealid)+" and t.t_paymstatus!=32000 ";
     que = que +  "and t.t_valuedate between to_date('"+sdat0(da1)+"','DD.MM.YYYY') and to_date('"+sdat0(da2)+"','DD.MM.YYYY')";
     rs = LnGetRecordset(que);
     if(rs != null)
       if (rs.moveNext) 
         rez=rs.value(0);
       end;
     end;
     return rez;
end;


/* Печать заголовка страниц */ 
macro PrintHead()
   private var St1 = "c:ex_BC(13421772):ex_FS(b):ex_B(rlt):ex_FZ(10)";
   private var REP_ELEM = REP_ELEM_TABL, i;

     Rep.AddPrintCell("Реестр активного ", 21, 0,"l:ex_FS(b):ex_FZ(12)", REP_ELEM_STR);
     Rep.AddPrintCell("МБК по состоянию ", 21, 0,"l:ex_FS(b):ex_FZ(12)", REP_ELEM_STR);
     Rep.AddPrintCell("на отчетную дату ", 21, 0,"l:ex_FS(b):ex_FZ(12)", REP_ELEM_STR);
     Rep.AddStr();
     Rep.AddPrintCell("Отчетная дата: ", 21, 0,"c:ex_FZ(12)", REP_ELEM_STR);
     Rep.AddPrintCell(string(da2), 21, 0,"c:ex_FZ(12)", REP_ELEM_STR);
     Rep.AddStr();
     Rep.AddPrintCell("", 21, 0,"l:ex_FS(b):ex_FZ(12)", REP_ELEM_STR);
     Rep.AddStr();

      Rep.AddPrintCell("Номер филиала",20, 0, St1, REP_ELEM);	
      Rep.AddPrintCell("Название филиала",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Номер балансового счета",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Номер лицевого счета",20, 0, St1, REP_ELEM);	
      Rep.AddPrintCell("Наименование лицевого счета",20, 0, St1, REP_ELEM);	
      Rep.AddPrintCell("Номер балансового счета учета начисленных процентов",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Номер лицевого счета учета начисленных процентов",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Наименование контрагента",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Номер договора",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Вид договора",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Дата выдачи",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Дата заключения договора",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Дата погашения",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Процентная ставка по договору",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Процентная ставка по последнему фиксингу (если применимо)",20, 0, St1, REP_ELEM);	
      Rep.AddPrintCell("DND по начисленным процентам (ближайшая дата погашения процентов)",20, 0, St1, REP_ELEM);	
      Rep.AddPrintCell("Исходящий остаток на отчетную дату, в рублях",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Начисленные проценты на отчетную дату, в рублях",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Признак просрочки",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Watch List",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Количество дней просрочки для осн. долга (если применимо)",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Количество дней просрочки для процентов (если применимо)",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Резерв под обесценение в соответствии с МСФО",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Амортизированная стоимость на отчетную дату до учета комиссии, в рублях",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Тип комиссии",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Регулярность уплаты комиссии (если применимо)",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Сумма единовременной комиссии, полученная за весь период (если применимо)",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Сумма регулярной комиссии, полученная в отчетном периоде (если применимо)",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Лицевой счет по учету комиссии (если применимо)",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Дата уплаты единовременной комиссии",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Дата последней уплаты комиссии",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Валюта",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Принадлежность контрагента к 30 крупнейшим российским банкам и их дочерним банкам по чистым активам",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Принадлежность контрагента к банкам стран ОЭСР/дочерним банкам стран ОЭСР",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Классификация для раскрытия по кредитному качеству (IFRS 7)",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Географический риск (по месту ведения бизнеса контрагента) (IFRS 7)",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Наличие обеспечения",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Рейтинговое агентство Moody's",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Рейтинговое агентство S&P",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Рейтинговое агентство Fitch Ratings",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Срок до погашения",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Наименование ГСЗ, к которой принадлежит контрагент (если применимо)",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Накопленная валютная переоценка по лицевому счету по учету задолженности по кредиту за весь период обращения инструмента",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Накопленная валютная переоценка по лицевому счету по учету начисленных процентов за отчетный период",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Начисления по лицевому счету по учету начисленных процентов за отчетный период (ОПУ)",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Уплата по лицевому счету по учету начисленных процентов за отчетный период (ОДДС)",20, 0, St1, REP_ELEM);
      Rep.AddStr(); 
      for (i,1,44)
        Rep.AddPrintCell(string(i),20, 0, St1, REP_ELEM);
        if ((i==4) or (i==10))
	        Rep.AddPrintCell(string(i)+".1",20, 0, St1, REP_ELEM);
        end;
      end;
      Rep.AddStr(); 

end;



macro First_Call() 
private var sfilename;
//   DefaultStringFont  = "Times New Roman";  
   DefaultStringFont  = "Arial";  
   DefaultFontSize    = 10;                                                                                                               
   DefaultWinRepOutput= WINREP_OUTPUT_EXCEL;
  /* Создадим объект класса CMakeReport */ 
   Rep = CMakeReport(); 
//       Rep.AddNewSheetBreak("Отчет за период "+sdat0(da1)+"-"+sdat0(da2));
//       Rep.MoveSheet(0,1);
//       Rep.SetCurSheet(0);	
       sfilename ="Отчет МСФО1 за период "+da1+"-"+da2;
       Rep.SetFileName(sfilename);

end; /* First_Call */ 


MACRO Last_Call(i) 
  private var j;
     for (j,1,46)
       if  (j ==1)
	       Rep.AddPrintCell("Итого", 20, 0, "r:c:" + FontStyleTitel);
       elif ((j==17) or (j==18) or (j==24) or (j==27) or (j==28) or (j==43) or (j==44) or (j==45) or (j==46))
	       Rep.AddPrintCell(0.0,20, 2, "r:a:" + FontStyleTitel);
       else
	       Rep.AddPrintCell("", 20, 0, "r:" + FontStyleTitel);
       end;
      end;
     Rep.AddStr(); 
//Посчитаем итоги по фактическим значениям
     rep.SetExecute("iSheet.Cells("+string(i+6)+", 17).formula=\"=(СУММ(Q3:Q"+string(i+5)+"))\""); 
     rep.SetExecute("iSheet.Cells("+string(i+6)+", 18).formula=\"=(СУММ(R3:R"+string(i+5)+"))\""); 
     rep.SetExecute("iSheet.Cells("+string(i+6)+", 24).formula=\"=(СУММ(X3:X"+string(i+5)+"))\""); 
     rep.SetExecute("iSheet.Cells("+string(i+6)+", 27).formula=\"=(СУММ(AA3:AA"+string(i+5)+"))\""); 
     rep.SetExecute("iSheet.Cells("+string(i+6)+", 28).formula=\"=(СУММ(AB3:AB"+string(i+5)+"))\""); 
     rep.SetExecute("iSheet.Cells("+string(i+6)+", 43).formula=\"=(СУММ(AQ3:AQ"+string(i+5)+"))\""); 
     rep.SetExecute("iSheet.Cells("+string(i+6)+", 44).formula=\"=(СУММ(AR3:AR"+string(i+5)+"))\""); 
     rep.SetExecute("iSheet.Cells("+string(i+6)+", 45).formula=\"=(СУММ(AS3:AT"+string(i+5)+"))\""); 
     rep.SetExecute("iSheet.Cells("+string(i+6)+", 46).formula=\"=(СУММ(AT3:AT"+string(i+5)+"))\""); 

     Rep.SetZoomType(ZOOM_TYPE_A4L);
     Rep.SetFlagShowZeroValue(false);

     Rep.PrintWinRep();// Печатаем отчёт в Excel 
     Rep.ShowWinRep(); // Делаем окно с Excel активным  
//     rep.objexcel.sheet(0).cells.wraptext=true;/*делаем перенос по длине*/
     rep = null;
END; /* Last_Call */ 


/* Циклический вызов макроса для формирования таблицы по  данным из выборки */ 
MACRO Cycle_Call(rs) 
  private var acc, rest, acc1, rest1,acc2, rest2, comisstype, comissper, accdpd1, accdpd2, IFRS7class, IFRS7geogr;
  private var restodrub, restprocrub, restodcur, delaydateod, delaydateproc, isdelay, delayod, delayproc;

      Rep.AddPrintCell(string(rs.value("depcode")), 20, 0, "r:" + FontStyleRow);
      Rep.AddPrintCell(rs.value("depname"), 20, 0, "r:" + FontStyleRow);
      Rep.AddPrintCell(substr(rs.value("accod"),1,3), 20, 0, "r:" + FontStyleRow);
      Rep.AddPrintCell(substr(rs.value("accod"),1,20), 20, 0, "r:" + FontStyleRow);
      Rep.AddPrintCell(trim(rs.value("accname")),20, 0, "r:" + FontStyleRow);
      Rep.AddPrintCell(substr(rs.value("accproc"),1,3), 20, 0, "r:" + FontStyleRow);
      Rep.AddPrintCell(substr(rs.value("accproc"),1,20), 20, 0, "r:" + FontStyleRow);
      Rep.AddPrintCell(trim(rs.value("contrname")), 20, 0, "r:" + FontStyleRow);
      Rep.AddPrintCell(rs.value("dognumber"), 20, 0, "r:" + FontStyleRow);
      Rep.AddPrintCell(rs.value("dogtype"), 20, 0, "r:" + FontStyleRow);
      Rep.AddPrintCell(date(rs.value("begdate")), 20, 0, "r:" + FontStyleRow);
      Rep.AddPrintCell(date(rs.value("dealdate")), 20, 0, "r:" + FontStyleRow);
      Rep.AddPrintCell(date(rs.value("enddate")), 20, 0, "r:" + FontStyleRow);
      Rep.AddPrintCell(rs.value("proc"), 20, 2, "r:a:" + FontStyleRow);
      Rep.AddPrintCell(Новая_проц_ставка(rs.value("dealid"), date(da2)), 20, 2, "r:a:" + FontStyleRow);
      Rep.AddPrintCell(date(GetDND(rs.value("dealid"),rs.value("begdate"))), 20, 0, "r:" + FontStyleRow);
      if (strlen(rs.value("accod")) == 20)
	      restodrub = GetRestAcc(rs.value("accod"), da2);
      else   
	      restodrub = 0.0;	
      end;	
      Rep.AddPrintCell(restodrub, 20, 2, "r:a:" + FontStyleRow);
      if (strlen(rs.value("accproc")) == 20)
	      restprocrub = GetRestAcc(rs.value("accproc"), da2);
      else   
	      restprocrub = 0.0;	
      end;	
      Rep.AddPrintCell(restprocrub,20, 2, "r:a:" + FontStyleRow);
      isdelay ="";
      delayod="";
      delayproc="";
      delaydateod = GetDelayDays(rs.value("dealid"), 18);
      if ( delaydateod != date(31,12,2099) ) 
	 isdelay = "324*";
         delayod = date(da2) - date(delaydateod)+1;
      end;
      delaydateproc = GetDelayDays(rs.value("dealid"), 19);
      if ( delaydateproc != date(31,12,2099) ) 
 	 isdelay = isdelay+"325*";
         delayproc = date(da2) - date(delaydateproc)+1;
      end;
      Rep.AddPrintCell(isdelay,      20, 0, "r:" + FontStyleRow);
      Rep.AddPrintCell(rs.value("watchlist"), 20, 0, "r" + FontStyleRow);
      Rep.AddPrintCell(delayod,      20, 0, "r:" + FontStyleRow); 
      Rep.AddPrintCell(delayod,      20, 0, "r:" + FontStyleRow); //???
      Rep.AddPrintCell("",      20, 0, "r:" + FontStyleRow); //Пока пусто
/*
      restodcur = 0.0;
      if (rs.value("pfi") == 0 )
         restodcur = restodrub;      
      elif ((rs.value("pfi") > 0) and (strlen(rs.value("accod")) == 20))
         restodcur = Money(round(GetRestAccCur(rs.value("accod"), da2) * GetRateMain(rs.value("pfi"), da2),2));
      end;
*/
      Rep.AddPrintCell(restodrub+restprocrub,     20, 2, "r:a:" + FontStyleRow); 
//comiss
      acc   = "";
      rest1 = 0;
      rest2 = 0;
      comissper = "";
      comisstype = "";
      accdpd1 = "";
      accdpd2 = "";

      if (strlen(trim(rs.value("acccomissper"))) == 20)
          rest1 = GetRestAcc(rs.value("acccomissper"), da2);
          accdpd1 = date(GetAccDPD(rs.value("acccomissper")));
      end;
      if (strlen(trim(rs.value("acccomissonce"))) == 20)
          rest2 = GetRestAcc(rs.value("acccomissonce"), da2);
          accdpd2 = date(GetAccDPD(rs.value("acccomissonce")));
      end;
      if (rest1 >  0 )
          acc = rs.value("acccomissper");
          comisstype = "Регулярная";
          comissper = "Иной";
      elif (rest2 >  0 )
          acc = rs.value("acccomissonce");
          comisstype = "Единовременная";
          comissper = "";
      end;
      Rep.AddPrintCell(comisstype,   20, 0, "r:" + FontStyleRow); 
      Rep.AddPrintCell(comissper,    20, 0, "r:" + FontStyleRow); 
      Rep.AddPrintCell(money(rest1), 20, 2, "r:" + FontStyleRow);
      Rep.AddPrintCell(money(rest2), 20, 2, "r:" + FontStyleRow);
      Rep.AddPrintCell(acc,          20, 0, "r:" + FontStyleRow); 
      Rep.AddPrintCell(accdpd1,      20, 0, "r:" + FontStyleRow);
      Rep.AddPrintCell(accdpd2,      20, 0, "r:" + FontStyleRow); 
      Rep.AddPrintCell(rs.value("cur"),       20, 0, "r:" + FontStyleRow);
      Rep.AddPrintCell(rs.value("top30"),     20, 0, "r:" + FontStyleRow); 
      Rep.AddPrintCell(rs.value("isOESR"),    20, 0, "r:" + FontStyleRow); 
      if ((rs.value("isnotresident") == "X") and (rs.value("isOESR") == "Да"))
          IFRS7class = "ОЭСР";
          IFRS7geogr = "ОЭСР";
      elif ((rs.value("isnotresident") == "X") and (rs.value("isOESR") == "Нет"))
          IFRS7class = "ПрБанки-нерезиденты";
          IFRS7geogr = "ДрСтраны";
      elif  (rs.value("top30") == "Да") 
          IFRS7class = "30КрРосБанков";
          IFRS7geogr = "Россия";
      else
          IFRS7class ="ДрРосБанки";
          IFRS7geogr = "Россия";
      end;
      Rep.AddPrintCell(IFRS7class,  20, 0, "r:" + FontStyleRow);
      Rep.AddPrintCell(IFRS7geogr,  20, 0, "r:" + FontStyleRow);
      Rep.AddPrintCell(trim(rs.value("qlty")),      20, 0, "r:" + FontStyleRow); 
      Rep.AddPrintCell(trim(rs.value("rateMoods")), 20, 0, "r:" + FontStyleRow); 
      Rep.AddPrintCell(trim(rs.value("rateStP")),   20, 0, "r:" + FontStyleRow); 
      Rep.AddPrintCell(trim(rs.value("rateFitch")), 20, 0, "r:" + FontStyleRow); 
      Rep.AddPrintCell((date(rs.value("enddate"))-date(rs.value("begdate"))),   20, 0, "r:" + FontStyleRow);
      Rep.AddPrintCell(trim(rs.value("GSZ")),       20, 0, "r:" + FontStyleRow);

      if ( (rs.value("pfi") == 0)  or (strlen(rs.value("accod")) != 20))
        Rep.AddPrintCell(0.0,      20, 2, "r:a:" + FontStyleRow);
      else
        Rep.AddPrintCell(GetRestAcc(rs.value("accod"), rs.value("begdate")) - GetRestAcc(rs.value("accod"), rs.value("enddate")), 20, 2, "r:a;" + FontStyleRow);
      end;                                                                                   	
      if ( (rs.value("pfi") == 0)  or (strlen(rs.value("accproc")) != 20))
        Rep.AddPrintCell(0.0,      20, 2, "r:a:" + FontStyleRow);
      else
        Rep.AddPrintCell( GetRestAcc(rs.value("accproc"),  rs.value("begdate")) - GetRestAcc(rs.value("accproc"), rs.value("enddate")), 20, 2, "r:a:" + FontStyleRow);
      end;

      if (strlen(rs.value("accproc")) ==20 )
        if (rs.value("dealtype") == 12300)
        Rep.AddPrintCell(GetCredit(rs.value("accproc"), da1, da2),    20, 2, "r:a:" + FontStyleRow); 
        if (delayproc > 0)
           Rep.AddPrintCell(GetDebet(rs.value("accproc"), da1, da2) - GetCredit(rs.value("accdelayproc"), da1, da2),    20, 2, "r:a:" + FontStyleRow); 
        else
           Rep.AddPrintCell(GetDebet(rs.value("accproc"), da1, da2), 20, 2, "r:a:" + FontStyleRow); 
        end;
        else
        Rep.AddPrintCell(GetDebet(rs.value("accproc"), da1, da2),    20, 2, "r:a:" + FontStyleRow); 
        if (delayproc > 0)
           Rep.AddPrintCell(GetCredit(rs.value("accproc"), da1, da2) - GetDebet(rs.value("accdelayproc"), da1, da2),    20, 2, "r:a:" + FontStyleRow); 
        else
           Rep.AddPrintCell(GetCredit(rs.value("accproc"), da1, da2), 20, 2, "r:a:" + FontStyleRow); 
        end;
        end;
      else
        Rep.AddPrintCell(0.0,    20, 2, "r:a:" + FontStyleRow); 
        Rep.AddPrintCell(0.0,    20, 2, "r:a:" + FontStyleRow); 
      end;




      Rep.AddStr();                          

END; /* Cycle_Call */ 



/* Вывод отчёта */
macro PrintRows()

  var rs,rs5;


   sql="select count(*) ";
   sql=sql+" from ddl_tick_dbt t , ddl_leg_dbt l  where t.t_bofficekind=102 and t.t_dealstatus > 0 and t.t_dealdate >= to_date('"+da1+"','DD.MM.YYYY') and t.t_dealdate <= to_date('"+da2+"','DD.MM.YYYY') ";  
   sql=sql+" and t.t_dealtype in (12300, 12305)  ";
   sql=sql+" and t.t_dealid=l.t_dealid and l.t_maturity > t.t_dealdate";

   rs5 = LnGetRecordSet(sql);
   if(rs5 != null)
     if (rs5.moveNext) 
        koli=int(rs5.value(0));
     end;
   end;

   InitProgress( koli, "Выполнение" );   
   jk=0;

   sql  =       "select  t.t_dealid as dealid, l.t_pfi as pfi, t.t_dealtype as dealtype, ";
   sql  = sql + "t.t_branch as depcode, ";
   sql  = sql + "(select  dep.t_name        from ddp_dep_dbt dep where dep.t_code = decode(t.t_branch, 0, 1, t.t_branch)) as depname, ";
   sql  = sql + "(select  da.t_account  from daccount_dbt da, dmcaccdoc_dbt a where a.t_docid = t.t_dealid and a.t_catid=111 and a.t_catnum=601 and a.t_account=da.t_account) as accod, ";

   sql  = sql + "(select  da.t_nameaccount  from daccount_dbt da, dmcaccdoc_dbt a where a.t_docid = t.t_dealid and a.t_catid=111 and a.t_catnum=601 and a.t_account=da.t_account) as accname, ";
   sql  = sql + "(select  da.t_account  from daccount_dbt da, dmcaccdoc_dbt a where a.t_docid = t.t_dealid and a.t_catid=decode(t.t_dealtype, 12305, 117, 118) and a.t_catnum=decode(t.t_dealtype, 12305, 621,622)  and a.t_account=da.t_account) as accproc, ";

   sql  = sql + "(select  da.t_account  from daccount_dbt da, dmcaccdoc_dbt a where a.t_docid = t.t_dealid and /*a.t_catid=111 and*/ a.t_catnum=5007 and a.t_account=da.t_account) as acccomissper, ";
   sql  = sql + "(select  da.t_account  from daccount_dbt da, dmcaccdoc_dbt a where a.t_docid = t.t_dealid and /*a.t_catid=111 and*/ a.t_catnum=5008 and a.t_account=da.t_account) as acccomissonce, ";
   sql  = sql + "(select  da.t_account  from daccount_dbt da, dmcaccdoc_dbt a where a.t_docid = t.t_dealid and /*a.t_catid=111 and*/ a.t_catnum=611  and a.t_account=da.t_account) as accdelayproc, ";

   sql  = sql + "p.t_name  as contrname, ";  
   sql  = sql + "p.t_notresident as isnotresident, ";
   sql  = sql + "t.t_dealcode as dognumber, ";

   sql  = sql + "case t.t_comment when chr(1) then 'кредит+финансы' else t.t_comment end as dogtype, ";
   sql  = sql + "trunc(l.t_start) as begdate,  ";
   sql  = sql + "trunc(t.t_dealdate) as dealdate, ";  
   sql  = sql + "trunc(l.t_maturity) as enddate, ";
   sql  = sql + "l.t_price/l.t_scale as proc, ";
   sql  = sql + "f.t_codeinaccount as cur, ";
   sql  = sql + "l.t_principal as od, ";
   sql  = sql + "decode((select rsb_struct.getint(t_text) from dnotetext_dbt where t_objecttype=103 and t_notekind=122 and t_documentid = lpad(t.t_dealid, 34,'0') and T_VALIDTODATE=to_date('31129999','DDMMYYYY')), 1, 'Да','Нет') as watchlist, ";
   sql  = sql + "decode((select rsb_struct.getlong(t_text) from dnotetext_dbt where t_objecttype=3 and t_notekind=104 and t_documentid = lpad(t.t_partyid, 10,'0') and T_VALIDTODATE=to_date('31129999','DDMMYYYY')), 1, 'Да','Нет') as top30, ";
   sql  = sql + "decode((select rsb_struct.getlong(t_text) from dnotetext_dbt where t_objecttype=3 and t_notekind=105 and t_documentid = lpad(t.t_partyid, 10,'0') and T_VALIDTODATE=to_date('31129999','DDMMYYYY')), 1, 'Да','Нет') as isOESR, ";
   sql  = sql + "(select rsb_struct.getString(t_text) from dnotetext_dbt where t_objecttype=3 and t_notekind=106 and t_documentid = lpad(t.t_partyid, 10,'0') and T_VALIDTODATE=to_date('31129999','DDMMYYYY')) as GSZ, ";
   sql  = sql + "decode(q.t_quality, 1, 'Н', 3, 'О', '') as qlty, "; 

   sql  = sql + "(select a.t_name           from dobjatcor_dbt ta, dobjattr_dbt a where  ta.t_objecttype = 3 and ta.t_groupid=19 and ta.t_object = lpad(t.t_partyid,10,'0') and ta.t_validtodate=to_date('31129999','DDMMYYYY') "; 
   sql  = sql + "and a.t_objecttype = 3 and a.t_groupid = 19 and ta.t_attrid=a.t_attrid and a.t_parentid = 110 ) as rateStP, ";

   sql  = sql + "(select a.t_name           from dobjatcor_dbt ta, dobjattr_dbt a where  ta.t_objecttype = 3 and ta.t_groupid=19 and ta.t_object = lpad(t.t_partyid,10,'0') and ta.t_validtodate=to_date('31129999','DDMMYYYY') "; 
   sql  = sql + "and a.t_objecttype = 3 and a.t_groupid = 19 and ta.t_attrid=a.t_attrid and a.t_parentid = 210 ) as  rateMoods,  "; 

   sql  = sql + "(select a.t_name           from dobjatcor_dbt ta, dobjattr_dbt a where  ta.t_objecttype = 3 and ta.t_groupid=19 and ta.t_object = lpad(t.t_partyid,10,'0') and ta.t_validtodate=to_date('31129999','DDMMYYYY')  "; 
   sql  = sql + "and a.t_objecttype = 3 and a.t_groupid = 19 and ta.t_attrid=a.t_attrid and a.t_parentid = 310 ) as  rateFitch  "; 

   sql  = sql + "from ddl_tick_dbt t, ddl_leg_dbt l, dfininstr_dbt f, dparty_dbt p, dpmpaym_dbt m, dmmdqlt_dbt q ";
   sql  = sql + "where t.t_bofficekind =102 and t.t_dealtype in (12300, 12305) and t.t_dealdate >= to_date('"+da1+"','DD.MM.YYYY') and t.t_dealdate <= to_date('"+da2+"','DD.MM.YYYY') and l.t_maturity > t.t_dealdate and t.t_dealstatus > 0 ";
   sql  = sql + "and t.t_dealid=l.t_dealid   and  f.t_fi_kind=1 and l.t_pfi=f.t_fiid  ";
   sql  = sql + "and t.t_partyid=p.t_partyid ";
   sql  = sql + "and m.t_dockind=102 and m.t_purpose=9 and t.t_dealid=m.t_documentid ";
   sql  = sql + "and t.t_dealid = q.t_dealid ";

   rs = LnGetRecordset(sql);

   if(rs != null)
     while(rs.moveNext)
          UseProgress(jk);

          Cycle_Call(rs); 

          jk=jk+1;
     end;
  end;
  RemProgress;   
end;



      
      da2={curdate};
      da1=date("01"+substr(string(da2),3));

      ВвестиДиапазонДат(da1, da2);
      da1 = sdat0(string(da1));
      da2 = sdat0(string(da2));
//getdate(da1,"Введите дату очета");

      First_Call(); 
      PrintHead();
      PrintRows();
      Last_Call(koli);
  
//      Rep.PrintWinRep();
//      Rep.ShowWinRep();

      exit(1);

end;





