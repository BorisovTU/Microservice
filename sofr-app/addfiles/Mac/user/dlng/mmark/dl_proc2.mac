import oralib, likepy, globals,fx_globals, CTInter;
IMPORT mmarkinter, OprInter,funk,dl_plib,dl_lib;

   private var que,rs9,ii,{curdate},da,dealid,rs5;
   var docKind=102, sql,nbank,fiid,debet,dealcode,sta;
   var exec, command1, command2, chainblockId,chainblockId0=21000019 ;

   da=‘„Ђ’({curdate});
   que=" select a.t_dealid from ddl_tick_dbt a, ddl_leg_dbt d where a.t_bofficekind=102 and a.t_dealstatus=10  and a.t_partyid ="+_BANK_RF+" and d.t_dealid=a.t_dealid  and d.t_maturity = to_date('"+da+"','dd.mm.yyyy')";

   rs9 = LnGetRecordSet(que);
   if(rs9 != null)
     while(rs9.moveNext())
       dealid=int(rs9.value(0));
         que= "select count(*)  from ddl_tick_dbt c1, doproper_dbt aa1 , doprstep_dbt bb1 ,doprostep_dbt cc1 where c1.t_dealid="+dealid+"  and  aa1.t_dockind=102 and ";
         que=que+ " aa1.t_DocumentID=lpad(c1.t_dealid,34,'0') and bb1.t_id_operation=aa1.t_id_operation  and cc1.t_blockid=bb1.t_blockid and cc1.t_number_step=bb1.t_number_step   and  (bb1.t_fact_date = '"+da+"' or bb1.t_isexecute='R')   and bb1.t_blockid="+chainblockId0;
//         que=que+ " aa1.t_DocumentID=lpad(c1.t_dealid,34,'0') and bb1.t_id_operation=aa1.t_id_operation  and bb1.t_isexecute='X'   and cc1.t_blockid=bb1.t_blockid and cc1.t_number_step=bb1.t_number_step   and t_fact_date = '"+da+"'  and bb1.t_blockid="+chainblockId0;
         rs5 = LnGetRecordSet(que);
         if(rs5 != null)
            if (rs5.moveNext) 
               if (int(rs5.value(0)) == 0 )
  // ---  blok cep  -------------------
  sql = "select s.t_id_operation, s.t_id_step, s.t_blockid, s.t_kind_operation, s.t_IsExecute from " 
  + " doproper_dbt o "
  + " inner join doprstep_dbt s on s.t_id_operation=o.t_id_operation and s.t_id_step = (select t_id_step from doprstep_dbt where t_id_operation = s.t_id_operation  and t_isexecute ='R'  )"
  + " where o.t_dockind = :dockind and o.t_documentid = lpad(:dealid, 34, '0')";
  chainblockId = 21000019;
  sql = ExecSqlSelect(sql, MakeArray(SqlParam("dockind", dockind), SqlParam("dealid", dealid)), false);     
  if(not sql.MoveNext())
    MsgBox("Ошибка поиcка сделки для закрытия неттинга id = "+dealid);

    return false;
  end;
  ii=int(sql.value("t_id_step"));
  

  command1 = "BEGIN :res := RSI_RsbOperation.InsertBranchTrn(:step, "+int(sql.value("t_id_operation"))+", "
  +ii+",'I', "+chainblockId+", 550, :dt, 0, 0); END;";
  exec = ExecSql(command1, MakeArray(SqlParam ("res",  V_INTEGER, RSDBP_RETVAL), 
                                     SqlParam ("step", V_INTEGER, RSDBP_RETVAL), 
                                     SqlParam ("dt", {curdate})), false);

  if(exec == null)
    MsgBox("Ошибка вставки цепочки ");
    return false;
  end;

  if(exec.value("res") != 0)
    MsgBox("Процедура вставки цепочки вернула ошибку, для документа id="+dealid);
    return false;
  end;
  // ----------------------------------------------

               end;
            end;
        end;
      end;

   end;

 end;


