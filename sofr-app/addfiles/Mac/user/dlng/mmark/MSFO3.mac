/*******************************************************************************
 DESCRIPTION  :   Отчет MSFO3 - Денежные средства и их эквиваленты по состоянию на отчетную дату.
 PROGRAMMED BY:   GYA
 CREATION DATE:   10.08.18
*******************************************************************************/
import "or_rep_h.mac", RsbDataSet, datelib, Календарь, PTInter;
import oralib, likepy, cb_sql;
import funk, dl_plib;

private var Rep : CMakeReport; /* Объект вида CMakeReport */ 
        var aa,sql,val,typ,rs0,daot,i,ii,jk,ost1=0,ost2=0,para1,para2,vals,typs,da1,da2,dox,rasx,tips,jj;
var lTrue = true, koli;
var IsApp = ":a";
var l="l";
var iMainMenu = -1,d,m,year;
var bHeaderPrinted = false;
const FontStyleTitel = ""; // "ex_FS(b)";
const FontStyleTitel2 = "r:ex_FS(b):ex_FZ(8)";


array mas1,mas2;
aa="                    ";


private macro SDAT0(s);
      private var ss;
      ss=trim(substr(string(s),1,10));
      if (substr(ss,3,1) != "." )
       ss="0"+ss;
      end; 

      return(ss);
end;

/* Печать заголовка страниц */                                                


macro PrintHeadd()
   var St1 = "c:ex_BC(13421772):ex_FS(b):ex_B(rlt):ex_FZ(10)";
   var St2 = "c:ex_BC(13421772):ex_FS(b):ex_B(rlb):ex_FZ(10)";
   var REP_ELEM = REP_ELEM_TABL,zago;
     Rep.AddPrintCell("Денежные средства и их эквиваленты по состоянию на отчетную дату", 80, 0,"l:ex_FS(b):ex_FZ(14)", REP_ELEM_STR);
     Rep.AddStr();
     Rep.AddPrintCell("Отчетная дата: "+string(da2), 30, 0,"c:ex_FZ(10)", REP_ELEM_STR);
     Rep.AddStr();
     Rep.AddEmptyStr(); 


      Rep.AddPrintCell("Номер филиала",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Название филиала",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Номер балансового счета",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Номер лицевого счета",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Наименование лицевого счета",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Номер балансового счета учета начисленных процентов",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Номер лицевого счета учета начисленных процентов",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Наименование контрагента",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Номер договора (если применимо)",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Вид договора",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Дата выдачи по договору (если применимо)",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Дата заключения договора",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Дата погашения по договору (если применимо)",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Процентная ставка по договору(заполняется для МБК до 30 дней)",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Процентная ставка по последнему фиксингу (если применимо)",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("DND по начисленным процентам (ближайшая дата погашения процентов",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Исходящий остаток на отчетную дату, в рублях",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Начисленные проценты на отчетную дату, в рублях",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Резерв под обесценение в соответствии с МСФО",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Амортизированная стоимость на отчетную дату до учета комиссии, в рублях",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Тип комиссии (если применимо)",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Регулярность уплаты комиссии (если применимо)",20, 0, St2, REP_ELEM);
      Rep.AddPrintCell("Сумма единовременной комиссии, полученная за весь период (если применимо)",20, 0, St2, REP_ELEM);
      Rep.AddPrintCell("Сумма регулярной комиссии, полученная в отчетном периоде (если применимо)",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Лицевой счет по учету комиссии (если применимо)",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Дата уплаты единовременной комиссии (если применимо)",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Дата последней уплаты комиссии",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Валюта",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Принадлежность контрагента к 30 крупнейшим российским банкам и их дочерним банкам по чистым активам",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Принадлежность контрагента к банкам стран ОЭСР/дочерним банкам стран ОЭСР",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Классификация для раскрытия по кредитному качеству (IFRS 7)",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Географический риск (по месту ведения бизнеса контрагента) (IFRS 7)",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Наличие обеспечения",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Рейтинговое агентство Moody's",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Рейтинговое агентство S&P",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Рейтинговое агентство Fitch Ratings",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Срок до погашения",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("Наименование ГСЗ, к которой принадлежит контрагент (если применимо)",20, 0, St1, REP_ELEM);
     
      Rep.AddStr();

      Rep.AddPrintCell("1",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("2",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("3",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("4",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("4.1",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("5",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("6",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("7",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("8",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("9",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("10",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("10.1",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("11",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("12",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("13",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("14",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("15",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("16",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("17",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("18",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("19",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("20",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("21",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("22",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("23",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("24",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("25",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("26",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("27",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("28",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("29",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("30",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("31",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("32",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("33",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("34",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("35",20, 0, St1, REP_ELEM);
      Rep.AddPrintCell("36",20, 0, St1, REP_ELEM);

      Rep.AddStr();

end;



MACRO SDEL(S,KS)
 PRIVATE VAR SW="                                                                                                      ";
 S=SUBSTR(S+SW,1,KS);
RETURN(S);
END;


macro Fiiid_namel(par1) 
    private var que,rs51,rez=" ";

     que="select t_ccy from dfininstr_dbt where  t_fiid="+string(par1);
     rs51 = LnGetRecordset(que);
     if(rs51 != null)
       if (rs51.moveNext) 
         rez=rs51.value(0);
       end;
     end;
     return rez;
end;

macro Fiid_Code_Name(par1) 
    private var que,rs51,rez=" ";

     que="select t_codeinaccount from dfininstr_dbt where  t_fiid="+string(par1);
     rs51 = LnGetRecordset(que);
     if(rs51 != null)
       if (rs51.moveNext) 
         rez=rs51.value(0);
       end;
     end;
     return rez;
end;

macro Dep_Num(par1) 
    private var que,rs51,rez=" ";

     que="select t_code from ddp_dep_dbt where  t_code="+string(par1);
     rs51 = LnGetRecordset(que);
     if(rs51 != null)
       if (rs51.moveNext) 
         rez=rs51.value(0);
       end;
     end;
     return rez;
end;

macro Dep_Name(par1) 
    private var que,rs51,rez=" ";

     que="select t_name from ddp_dep_dbt where  t_code="+string(par1);
     rs51 = LnGetRecordset(que);
     if(rs51 != null)
       if (rs51.moveNext) 
         rez=rs51.value(0);
       end;
     end;
     return rez;
end;

macro Acc_Name(par1) 
    private var que,rs51,rez=" ";

     que="select t_nameaccount from daccount_dbt where t_chapter=1 and t_account='"+string(par1)+"'";
     rs51 = LnGetRecordset(que);
     if(rs51 != null)
       if (rs51.moveNext) 
         rez=rs51.value(0);
       end;
     end;
     return rez;
end;

macro Проводка_доходы(par1,par2) 
    private var que,rs51,rez=" ";

     que="select count(*) from  doproper_dbt b ,doprstep_dbt a where  b.t_DocumentID = lpad('"+string(par1)+"',34,'0') ";   
     que=que+" and    b.t_dockind='"+string(par2)+"' and a.t_id_operation=b.t_id_operation  and a.t_number_step=80 and  a.t_isexecute='X' ";
     rs51 = LnGetRecordset(que);
     if(rs51 != null)
       if (rs51.moveNext) 
         rez=rs51.value(0);
       end;
     end;
     return rez;
end;

macro Проводка_доходы2(par1,par2) 
    private var que,rs51,rez=" ";

     que="select count(*) from  doproper_dbt b ,doprstep_dbt a where  b.t_DocumentID = lpad('"+string(par1)+"',34,'0') ";   
     que=que+" and    b.t_dockind='"+string(par2)+"' and a.t_id_operation=b.t_id_operation  and a.t_number_step=30 and  a.t_isexecute='X' ";
     rs51 = LnGetRecordset(que);
     if(rs51 != null)
       if (rs51.moveNext) 
         rez=rs51.value(0);
       end;
     end;
     return rez;
end;


MACRO ПРИКРЕПИТЬ33(nkat,id1);
    private var ss1,ss2,ss,rs1,que,rs;
     ss2="1";
     return (ss2);
END;

MACRO ПолучитьПрикреплённыйСчётПоКУ(nkat, dealId);
   var params:TArray;
   

   var sql = "select t_id from dmccateg_dbt  where  t_code=:cat";
   params = MakeArray(SQLParam("cat", nkat)); 
   var res = ExecSQLSelect(sql, params, false);               


   if(res.MoveNext())     
      sql = "select t_account from dmcaccdoc_dbt where t_dockind in (100, 102, 175) and t_docid=:doc and t_catid=:cat";
 
      params = MakeArray(SQLParam("doc", string(dealId)), SQLParam("cat", string(res.value(0)))); 
      res = ExecSQLSelect(sql, params, false);              

      if(res.MoveNext())  
         return res.value(0);
      end;         
   end;

   return "";
END;

private macro GetDND(dealid, bdt)
     private var que,rs,rez=" ", delta;

     que =   "select min(t.t_valuedate) from dpmpaym_dbt t where t.t_dockind=102 and t.t_documentid="+string(dealid)+" and t.t_purpose=11 and t.t_valuedate > to_date('"+da2+"','DD.MM.YYYY')";
     rs = LnGetRecordset(que);
     if(rs != null)
       if (rs.moveNext) 
         rez=rs.value(0);
       end;
     end;

     return (rez);
end; 

private macro GetAccDPD(acc)
     private var que,rs,rez=" ";
     que =  "select max(t.t_RestDate ) "; 
//decode(to_char(nvl(max(rtbl.t_RestDate ),to_date('01.01.0001','dd.mm.yyyy')),'dd.mm.yyyy'),'01.01.0001',' ',to_char(nvl(max(rtbl.t_RestDate ),to_date('01.01.0001','dd.mm.yyyy')),'dd.mm.yyyy')) 
     que = que + "from  daccount_dbt a, drestdate_dbt t where   a.t_account = '"+acc+"' and t.t_accountid = a.t_accountid ";
     
     rs = LnGetRecordset(que);
     if(rs != null)
       if (rs.moveNext) 
         rez=rs.value(0);
       end;
     end;
     return rez;
end; 

//остаток в рублях
private macro GetRestAcc(acc, dt)
     private var que,rs,rez=$0;
     que =       "select abs(rsb_account.restac(a.t_account, a.t_code_currency, to_date('"+sdat0(dt)+"','dd.mm.yyyy'), a.t_chapter,null,decode(a.t_chapter,5,a.t_code_currency,0) )) ";
     que = que + "from daccount_dbt a where a.t_account = '"+acc+"'";
     
     rs = LnGetRecordset(que);
     if(rs != null)
       if (rs.moveNext) 
         rez=rs.value(0);
       end;
     end;
     return money(rez);
end; 

private macro GetRestAccCur(acc, dt)
     private var que,rs,rez=$0;
     que =       "select abs(rsb_account.restall(a.t_account,a.t_chapter, a.t_code_currency, to_date('"+sdat0(dt)+"','dd.mm.yyyy'), null)) ";
     que = que + "from daccount_dbt a where a.t_account = '"+acc+"'";
     
     rs = LnGetRecordset(que);
     if(rs != null)
       if (rs.moveNext) 
         rez=rs.value(0);
       end;
     end;
     return money(rez);
end; 


private macro GetDebet(acc, dt1, dt2)
     private var que,rs,rez=" ";
     que =       "select abs(rsb_account.debeta(a.t_account,a.t_chapter, to_date('"+sdat0(dt1)+"','dd.mm.yyyy'), to_date('"+sdat0(dt2)+"','dd.mm.yyyy'), a.t_code_currency, null)) ";
     que = que + "from daccount_dbt a where a.t_account = '"+acc+"'";
     
     rs = LnGetRecordset(que);
     if(rs != null)
       if (rs.moveNext) 
         rez=rs.value(0);
       end;
     end;
     return money(rez);
end; 

private macro GetCredit(acc, dt1, dt2)
     private var que,rs,rez=" ";
     que =       "select abs(rsb_account.kredita(a.t_account,a.t_chapter, to_date('"+sdat0(dt1)+"','dd.mm.yyyy'), to_date('"+sdat0(dt2)+"','dd.mm.yyyy'), a.t_code_currency, null)) ";
     que = que + "from daccount_dbt a where a.t_account = '"+acc+"'";
     
     rs = LnGetRecordset(que);
     if(rs != null)
       if (rs.moveNext) 
         rez=rs.value(0);
       end;
     end;
     return money(rez);
end; 

private macro GetDelayDays(dealid, purpose) 
     private var que,rs,rez;
     que = "select nvl(min(t.t_valuedate),to_date('31122099','ddmmyyyy')) from dpmpaym_dbt t ";
     que = que +  "where t.t_dockind=102 and t.t_purpose="+string (purpose) +" and t.t_documentid="+ string(dealid)+" and t.t_paymstatus!=32000 ";
     que = que +  "and t.t_valuedate between to_date('"+sdat0(da1)+"','DD.MM.YYYY') and to_date('"+sdat0(da2)+"','DD.MM.YYYY')";
     rs = LnGetRecordset(que);
     if(rs != null)
       if (rs.moveNext) 
         rez=rs.value(0);
       end;
     end;
     return rez;
end;

private macro GetSumComiss(dealid, dealtype, acccom) 
     private var que,rs,rez=$0;
     que = "select t_sum_natcur from dacctrn_dbt where t_acctrnid in (select t_acctrnid from doprdocs_dbt where t_id_operation=(select t_id_operation from doproper_dbt where t_kind_operation=:kindop and t_dockind=102 and t_documentid=lpad(:docid,34,'0')) and t_dockind=1) and t_account_payer=:acc ";
     rs = ExecSQLSelect(que, MakeArray(
                                      SQLParam("kindop",  dealtype),
                                      SQLParam("docid",   dealid),
                                      SQLParam("acc",     acccom)
                                     ), false);
     if(rs != null)
       if (rs.moveNext) 
         rez=round(double(rs.value(0)),2);
       end;
     end;
     return rez;
end;


macro First_Call() 
   DefaultStringFont  = "Times New Roman";  
   DefaultFontSize    = 10;                                                                                                               
   DefaultWinRepOutput= WINREP_OUTPUT_EXCEL;
  /* Создадим объект класса CMakeReport */ 
   Rep = CMakeReport(); 
end; /* First_Call */ 


MACRO Last_Call(i) 
  private var j;
     for (j,1,38)
       if  (j ==1)
	       Rep.AddPrintCell("Итого", 20, 0, "r:c:" + FontStyleTitel2);
       elif ((j==17) or (j==18) or (j==20) or (j==23) or (j==24))
	       Rep.AddPrintCell(0.0,20, 2, "r:a:" + FontStyleTitel2);
       else
	       Rep.AddPrintCell("", 20, 0, "r:" + FontStyleTitel2);
       end;
      end;
     Rep.AddStr(); 
//Посчитаем итоги по фактическим значениям
     rep.SetExecute("iSheet.Cells("+string(i+6)+", 20).formula=\"=(СУММ(T6:T"+string(i+5)+"))\""); 
     rep.SetExecute("iSheet.Cells("+string(i+6)+", 21).formula=\"=(СУММ(U6:U"+string(i+5)+"))\""); 
     rep.SetExecute("iSheet.Cells("+string(i+6)+", 23).formula=\"=(СУММ(W6:W"+string(i+5)+"))\""); 
     rep.SetExecute("iSheet.Cells("+string(i+6)+", 26).formula=\"=(СУММ(Z6:Z"+string(i+5)+"))\""); 
     rep.SetExecute("iSheet.Cells("+string(i+6)+", 27).formula=\"=(СУММ(AA6:AA"+string(i+5)+"))\""); 

     Rep.AddEmptyStr(); 
 
     Rep.SetZoomType(ZOOM_TYPE_A4L);
     Rep.SetFlagShowZeroValue(false);

     Rep.PrintWinRep("TODAY"); // Печатаем отчёт в Excel 
//     Rep.ShowWinRep();         // Делаем окно с Excel активным  

END; /* Last_Call */ 





/* Циклический вызов макроса для формирования таблицы с данными */ 

MACRO Cycle_Call(rs) 
  private var acc,acc2,rest1=$0,rest2=$0,ku,КурсНБ,datnach,vidinstr,daku,sut1,sut2,,uslo,dapog,subank,sukontr,perval18,perproc18,perval28,perproc28;
  private var comisstype, comissper, accdpd1, accdpd2, IFRS7class, IFRS7geogr;

//  acc = ПолучитьПрикреплённыйСчётПоКУ("ОД", rs.value("dealid"));
//  acc2 = ПолучитьПрикреплённыйСчётПоКУ("-% к погашению", rs.value("dealid"));
    if (strlen(rs.value("accod")) == 20)
      rest1 = GetRestAcc(rs.value("accod"), da2);
    else 
      rest1 = 0.0;
    end;
    if (strlen(rs.value("accproc")) == 20)
      rest2 = GetRestAcc(rs.value("accproc"), da2);
    else 
      rest2 = 0.0;
    end;

      //Номер филиала
      Rep.AddPrintCell(Dep_Num(rs.value("depart")), 20, 0, "c:" + FontStyleTitel);
      //Название филиала
      Rep.AddPrintCell(Dep_Name(rs.value("depart")), 20, 0, "c:" + FontStyleTitel);
      //Номер балансового счета
      Rep.AddPrintCell(substr(rs.value("accod"),1,5), 20, 0, "c:" + FontStyleTitel);
      //Номер лицевого счета
      Rep.AddPrintCell(substr(rs.value("accod"),1,20), 20, 0, "c:" + FontStyleTitel);
      //Наименование лицевого счета
      Rep.AddPrintCell(trim(rs.value("accname")), 20, 0, "l:" + FontStyleTitel);
      //Номер балансового счета учета начисленных процентов
      Rep.AddPrintCell(substr(rs.value("accproc"),1,5), 20, 0, "c:" + FontStyleTitel);
      //Номер лицевого счета учета начисленных процентов
      Rep.AddPrintCell(substr(rs.value("accproc"),1,20), 20, 0, "c:" + FontStyleTitel);
      //Наименование контрагента
      Rep.AddPrintCell(rs.value("t_name"), 20, 0, "l:" + FontStyleTitel);
      //Номер договора (если применимо)
      Rep.AddPrintCell(rs.value("dognumber"), 20, 0, "l:" + FontStyleTitel);
      //Вид договора
      Rep.AddPrintCell(rs.value("dogtype"), 20, 0, "c:" + FontStyleTitel);
      //Дата выдачи по договору (если применимо)
      Rep.AddPrintCell(substr(string(rs.value("begdate")),1,10), 20, 0, "c:" + FontStyleTitel);
      //Дата заключения договора
      Rep.AddPrintCell(substr(string(rs.value("dealdate")),1,10), 20, 0, "c:" + FontStyleTitel);
      //Дата погашения по договору (если применимо)
      Rep.AddPrintCell(substr(string(rs.value("enddate")),1,10), 20, 0, "c:" + FontStyleTitel);
      //Процентная ставка по договору(заполняется для МБК до 30 дней)
      Rep.AddPrintCell(rs.value("proc"), 20, 2, "r:" + FontStyleTitel);
      //Процентная ставка по последнему фиксингу (если применимо)
      Rep.AddPrintCell(Новая_проц_ставка(rs.value("dealid"), date(da2)), 20, 2, "r:" + FontStyleTitel);
      //DND по начисленным процентам (ближайшая дата погашения процентов
      Rep.AddPrintCell(date(GetDND(rs.value("dealid"),rs.value("begdate"))), 20, 0, "c:" + FontStyleTitel);
      //Исходящий остаток на отчетную дату, в рублях
      Rep.AddPrintCell(rest1, 20, 2, "r:" + FontStyleTitel);
      //Начисленные проценты на отчетную дату, в рублях
      Rep.AddPrintCell(rest2, 20, 2, "r:" + FontStyleTitel);
      //Резерв под обесценение в соответствии с МСФО
      Rep.AddPrintCell("", 20, 0, "c:" + FontStyleTitel);
      //Амортизированная стоимость на отчетную дату до учета комиссии, в рублях
      Rep.AddPrintCell(rest1+rest2, 20, 2, "r:" + FontStyleTitel);

//comiss
      acc   = "";
      rest1 = 0;
      rest2 = 0;
      comissper = "";
      comisstype = "";
      accdpd1 = "";
      accdpd2 = "";

      if (strlen(trim(rs.value("acccomissper"))) == 20)
          rest1 = GetSumComiss(rs.value("dealid"),rs.value("dealtype"),rs.value("acccomissper"));
//          rest1 = GetRestAcc(rs.value("acccomissper"), da2);
          accdpd1 = date(GetAccDPD(rs.value("acccomissper")));
      end;
      if (strlen(trim(rs.value("acccomissonce"))) == 20)
          rest2 = GetSumComiss(rs.value("dealid"),rs.value("dealtype"),rs.value("acccomissonce"));
//          rest2 = GetRestAcc(rs.value("acccomissonce"), da2);
          accdpd2 = date(GetAccDPD(rs.value("acccomissonce")));
      end;
/*      if (rest1 >  0 )
          acc = rs.value("acccomissper");
          comisstype = "Регулярная";
          comissper = "Иной";
      elif (rest2 >  0 )
          acc = rs.value("acccomissonce");
          comisstype = "Единовременная";
          comissper = "";
      end;*/
      if (rest1 + rest2 >  0 )
          acc = rs.value("acccomissonce");
          comisstype = "Единовременная";
          comissper = "";
      end;
      //Тип комиссии (если применимо)
      Rep.AddPrintCell(comisstype, 20, 0, "c:" + FontStyleTitel);
      //Регулярность уплаты комиссии (если применимо)
      Rep.AddPrintCell(comissper, 20, 0, "c:" + FontStyleTitel);
      //Сумма единовременной комиссии, уплаченная за весь период (если применимо)
      Rep.AddPrintCell(money(rest1+rest2), 20, 2, "r:" + FontStyleTitel);
      //Сумма регулярной комиссии, уплаченная в отчетном периоде (если применимо)
      Rep.AddPrintCell(0.0, 20, 2, "r:" + FontStyleTitel);
      //Лицевой счет по учету комиссии (если применимо)
      Rep.AddPrintCell(acc, 20, 0, "c:" + FontStyleTitel);
      //Дата уплаты единовременной комиссии (если применимо)
      Rep.AddPrintCell(accdpd1, 20, 0, "c:" + FontStyleTitel);
      //Дата последней уплаты комиссии
      Rep.AddPrintCell(accdpd2, 20, 0, "c:" + FontStyleTitel);

      //Валюта
      Rep.AddPrintCell(Fiid_Code_Name(rs.value("pfi")), 20, 0, "c:" + FontStyleTitel);
      //Принадлежность контрагента к 30 крупнейшим российским банкам и их дочерним банкам по чистым активам
      Rep.AddPrintCell(rs.value("top30"), 20, 0, "c:" + FontStyleTitel);
      //Принадлежность контрагента к банкам стран ОЭСР/дочерним банкам стран ОЭСР
      Rep.AddPrintCell(rs.value("isOESR"), 20, 0, "c:" + FontStyleTitel);

      if ((rs.value("isnotresident") == "X") and (rs.value("isOESR") == "Да"))
          IFRS7class = "ОЭСР";
          IFRS7geogr = "ОЭСР";
      elif ((rs.value("isnotresident") == "X") and (rs.value("isOESR") == "Нет"))
          IFRS7class = "ПрБанки-нерезиденты";
          IFRS7geogr = "ДрСтраны";
      elif  (rs.value("top30") == "Да") 
          IFRS7class = "30КрРосБанков";
          IFRS7geogr = "Россия";
      else
          IFRS7class ="ДрРосБанки";
          IFRS7geogr = "Россия";
      end;

      //Классификация для раскрытия по кредитному качеству (IFRS 7)
      Rep.AddPrintCell(IFRS7class, 20, 0, "c:" + FontStyleTitel);
      //Географический риск (по месту ведения бизнеса контрагента) (IFRS 7)
      Rep.AddPrintCell(IFRS7geogr, 20, 0, "c:" + FontStyleTitel);
      //Наличие обеспечения
      Rep.AddPrintCell(trim(rs.value("qlty")), 20, 0, "c:" + FontStyleTitel);
      //Рейтинговое агентство Moody's
      Rep.AddPrintCell(trim(rs.value("rateMoods")), 20, 0, "c:" + FontStyleTitel);
      //Рейтинговое агентство S&P
      Rep.AddPrintCell(trim(rs.value("rateStP")), 20, 0, "c:" + FontStyleTitel);
      //Рейтинговое агентство Fitch Ratings
      Rep.AddPrintCell(trim(rs.value("rateFitch")), 20, 0, "c:" + FontStyleTitel);
      //Срок до погашения
//      Rep.AddPrintCell((date(rs.value("enddate"))-date(rs.value("begdate"))), 20, 0, "c:" + FontStyleTitel);
      Rep.AddPrintCell((date(rs.value("enddate"))-date(da2)), 20, 0, "c:" + FontStyleTitel);
      //Наименование ГСЗ, к которой принадлежит контрагент (если применимо)
      Rep.AddPrintCell(trim(rs.value("GSZ")), 20, 0, "c:" + FontStyleTitel);

      Rep.AddStr();
      jj=jj+1;

END; /* Cycle_Call */ 


/* Вывод отчёта */
macro PrintRows()
  var params : TArray;
  var rs,rs5;

   sql="select count(*)                                                                 "+
       "  from ddl_tick_dbt a , ddl_leg_dbt b , dparty_dbt c                            "+
       " where a.t_bofficekind=102 and a.t_dealstatus > 0                               "+
       "   and a.t_dealdate between to_date('"+string(da1)+"','dd.mm.yyyy')             "+
       "                        and to_date('"+string(da2)+"','dd.mm.yyyy')             "+
       "   and (a.t_dealtype=12305 or a.t_dealtype=12305)                               "+
       "   and b.t_dealid=a.t_dealid /*and b.t_maturity=a.t_dealdate*/                      "+
       "   and c.t_partyid=a.t_partyid                                                  ";
   rs5 = LnGetRecordSet(sql);
   if(rs5 != null)
     if (rs5.moveNext) 
        koli=int(rs5.value(0));
     end;
   end;

   InitProgress( koli, "Выполнение" );   


   jk=0;
   jj=1;
   sql=
       "select a.t_partyid as partyid, a.t_department as depart, c.t_name, trunc(a.t_dealdate) as dealdate, trunc(b.t_start) as begdate,  "+
       "       trunc(b.t_maturity) as enddate, a.t_dealid as dealid, b.t_principal as principal,              "+
       "       nvl((select  da.t_account  from daccount_dbt da, dmcaccdoc_dbt aa where aa.t_docid = a.t_dealid and aa.t_catid=111 and aa.t_catnum=601 and aa.t_account=da.t_account),'') as accod, "+
       "       nvl((select  da.t_nameaccount  from daccount_dbt da, dmcaccdoc_dbt aa where aa.t_docid = a.t_dealid and aa.t_catid=111 and aa.t_catnum=601 and aa.t_account=da.t_account),'') as accname, "+
       "       nvl((select  da.t_account  from daccount_dbt da, dmcaccdoc_dbt aa where aa.t_docid = a.t_dealid and aa.t_catid=decode(a.t_dealtype, 12305, 117, 118) and aa.t_catnum=decode(a.t_dealtype, 12305, 621,622)  and aa.t_account=da.t_account),'') as accproc, "+
       "       nvl((select  da.t_account  from daccount_dbt da, dmcaccdoc_dbt aa where aa.t_docid = a.t_dealid and /*a.t_catid=111 and*/ aa.t_catnum=5007 and aa.t_account=da.t_account),'') as acccomissper, "+
       "       nvl((select  da.t_account  from daccount_dbt da, dmcaccdoc_dbt aa where aa.t_docid = a.t_dealid and /*a.t_catid=111 and*/ aa.t_catnum=5008 and aa.t_account=da.t_account),'') as acccomissonce, "+
       "       b.t_cost as cost ,b.t_pfi as pfi  ,b.t_cfi as cfi,a.t_typedoc as typedoc, c.t_notresident as isnotresident,                "+
       "       a.t_dealcode as dealcode, b.t_point as point, b.t_price as price, b.t_price/b.t_scale as proc,  "+
       "       a.t_bofficekind as dockind, a.t_netting as netting, a.t_dealtype as dealtype,           "+
       "       a.t_dealcode as dognumber, case a.t_comment when chr(1) then 'кредит+финансы' else a.t_comment end as dogtype, "+
       "       decode((select rsb_struct.getlong(t_text) from dnotetext_dbt where t_objecttype=3 and t_notekind=104 and t_documentid = lpad(a.t_partyid, 10,'0') and T_VALIDTODATE=to_date('31129999','DDMMYYYY')), 1, 'Да','Нет') as top30, "+
       "       decode((select rsb_struct.getlong(t_text) from dnotetext_dbt where t_objecttype=3 and t_notekind=105 and t_documentid = lpad(a.t_partyid, 10,'0') and T_VALIDTODATE=to_date('31129999','DDMMYYYY')), 1, 'Да','Нет') as isOESR, "+
       "       (select rsb_struct.getString(t_text) from dnotetext_dbt where t_objecttype=3 and t_notekind=106 and t_documentid = lpad(a.t_partyid, 10,'0') and T_VALIDTODATE=to_date('31129999','DDMMYYYY')) as GSZ, "+
       "       decode(q.t_quality, 1, 'Н', 3, 'О', '') as qlty, "+ 
       "       (select aa.t_name           from dobjatcor_dbt ta, dobjattr_dbt aa where  ta.t_objecttype = 3 and ta.t_groupid=19 and ta.t_object = lpad(a.t_partyid,10,'0') and ta.t_validtodate=to_date('31129999','DDMMYYYY') "+ 
       "       and aa.t_objecttype = 3 and aa.t_groupid = 19 and ta.t_attrid=aa.t_attrid and aa.t_parentid = 110 ) as rateStP, "+
       "       (select aa.t_name           from dobjatcor_dbt ta, dobjattr_dbt aa where  ta.t_objecttype = 3 and ta.t_groupid=19 and ta.t_object = lpad(a.t_partyid,10,'0') and ta.t_validtodate=to_date('31129999','DDMMYYYY') "+ 
       "       and aa.t_objecttype = 3 and aa.t_groupid = 19 and ta.t_attrid=aa.t_attrid and aa.t_parentid = 210 ) as  rateMoods,  "+ 
       "       (select aa.t_name           from dobjatcor_dbt ta, dobjattr_dbt aa where  ta.t_objecttype = 3 and ta.t_groupid=19 and ta.t_object = lpad(a.t_partyid,10,'0') and ta.t_validtodate=to_date('31129999','DDMMYYYY')  "+ 
       "       and aa.t_objecttype = 3 and aa.t_groupid = 19 and ta.t_attrid=aa.t_attrid and aa.t_parentid = 310 ) as  rateFitch  "+ 
       "  from ddl_tick_dbt a , ddl_leg_dbt b , dparty_dbt c, dmmdqlt_dbt q                  "+
       " where a.t_bofficekind=102 and a.t_dealstatus > 0                                    "+
       "   and a.t_dealdate between to_date('"+string(da1)+"','dd.mm.yyyy')                  "+
       "                        and to_date('"+string(da2)+"','dd.mm.yyyy')                  "+
       "   and (a.t_dealtype=12305 or a.t_dealtype=12305)                                    "+
       "   and b.t_dealid=a.t_dealid /*and b.t_maturity=a.t_dealdate*/                       "+
       "   and c.t_partyid=a.t_partyid and a.t_dealid = q.t_dealid                           "+
       " order by dealdate,dealcode                                                          ";
println(sql);
   rs = LnGetRecordset(sql);

   if(rs != null)
     while(rs.moveNext)
       useprogress(jk);
       Cycle_Call (rs); 
       jk=jk+1;
     end;
  end;

  RemProgress;   
end;

      
da2={curdate};
da1=date("01"+substr(string(da2),3));

ВвестиДиапазонДат(da1, da2);

First_Call(); 
PrintHeadd();
PrintRows();
Last_Call(koli);
//Rep.AddNewSheetBreak("Лист1");
Rep.PrintWinRep();
Rep.ShowWinRep();

exit(1);






