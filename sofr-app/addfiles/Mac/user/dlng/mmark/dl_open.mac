import PTinter,RSBDataSet,dl_plib,dlgCommon,funk,dl_kvlib; 
private  var d0,pId2,rs0,cmd2,{curdate},sql0,flag,rs05,que,rs9,ppaymentid,rs5; 
private  var col2 = TArray();
private  var v_DealId = TArray(), v_count;


     d0={curdate};
     getdate(d0,"Введите дату:",10);


     sql0="select  a.t_paymentid,a.t_paymstatus  from  ddl_tick_dbt c, ddl_leg_dbt d, dparty_dbt e , dpmpaym_dbt a where   c.t_dealstatus < 20 and  c.t_bofficekind=102 and  c.t_dealdate < to_date('"+СДАТ(d0)+"','dd.mm.yyyy')";
     sql0=sql0+ " and d.t_dealid=c.t_dealid and d.t_legid=1  and e.t_partyid=c.t_partyid  and a.t_dockind=102 and a.t_documentid=c.t_dealid and a.t_purpose=9 and c.t_dealtype =12305  and d.t_maturity = to_date('"+СДАТ(d0)+"','dd.mm.yyyy') ";
     rs9 = LnGetRecordSet(sql0);
     if(rs9 != null)
       while(rs9.moveNext())
        if ( rs9.value(1) != 32000 )
            ppaymentid=rs9.value(0);
            que="update  dpmpaym_dbt set t_paymstatus=32000  where t_paymentid="+ppaymentid;
            rs5 = LnGetRecordSet(que);
        end;

       end;
     end;



     sql0="select c.t_dealid pId2,c.t_dealcodets dealcodets, decode(c.t_dealtype,12300,'П',32300,'П',12305,'Р',32305,'Р',32300,'П',32305,'Р')  vop,e.t_shortname nam , c.t_dealcode dealcode,";
     sql0=sql0+ " to_char(c.t_dealdate,'dd.mm.yyyy') dealdate,to_char(d.t_maturity,'dd.mm.yyyy') maturity ,(case when c.t_dealtype = 32300 or  c.t_dealtype = 12300 then TO_CHAR(d.t_principal,'999,999,999,999.00') else ' ' end) su1,";
     sql0=sql0+ " (case when c.t_dealtype = 32305 or  c.t_dealtype = 12305 then TO_CHAR(d.t_principal,'999,999,999,999.00') else ' ' end) su2,";

     sql0=sql0+ " (case when d.t_tablepercent = 'X' then (case when (select count(*) from DSTD_PLS_DBT ff where ff.t_id=c.t_dealid and ff.t_dizm='"+СДАТ(d0)+"') > 0 then 'Установлено' else '?' end )   else ' ' end ) sta,";

     sql0=sql0+ " ( case  when ";
     sql0=sql0+ " (select count(*)  from ddl_tick_dbt c1, doproper_dbt aa1 , doprstep_dbt bb1 ,doprostep_dbt cc1 where c1.t_dealid=c.t_dealid  and  aa1.t_dockind=102 and aa1.t_DocumentID=lpad(c1.t_dealid,34,'0') and bb1.t_id_operation=aa1.t_id_operation ";
     sql0=sql0+" and bb1.t_isexecute='X' and cc1.t_blockid=bb1.t_blockid and bb1.t_fact_date ='"+СДАТ(d0)+"' and cc1.t_number_step=bb1.t_number_step and cc1.t_symbOl='н') > 0 then 'Начислено' else ";
     sql0=sql0+ " (case when d.t_maturity = to_date('"+СДАТ(d0)+"','dd.mm.yyyy')  then '?'  else ' ' end)      end )  vpl, ";



     sql0=sql0+ " (case when (select count(*) from dpmpaym_dbt ee where ee.t_dockind=102 and ee.t_documentid=c.t_dealid and ee.t_valuedate= '"+СДАТ(d0)+"'  and ee.t_valuedate != d.t_maturity and ee.t_purpose=10 ) > 0  then  ";
     sql0=sql0+ " (case when (select count(*) from dpmpaym_dbt ee where ee.t_dockind=102 and ee.t_documentid=c.t_dealid and ee.t_valuedate= '"+СДАТ(d0)+"'  and ee.t_valuedate != d.t_maturity and ee.t_purpose=10 and ee.t_paymstatus > 2990) > 0  then 'Cформирован' else '?' end ) ";
     sql0=sql0+ "    else ' ' end)   isxpl, ";

     sql0=sql0+ " (case when (select count(*) from dpmpaym_dbt ee where ee.t_dockind=102 and ee.t_documentid=c.t_dealid and ee.t_valuedate= '"+СДАТ(d0)+"'  and ee.t_valuedate != d.t_maturity and ee.t_purpose=11 ) > 0  then  ";
     sql0=sql0+ " (case when (select count(*) from dpmpaym_dbt ee where ee.t_dockind=102 and ee.t_documentid=c.t_dealid and ee.t_valuedate= '"+СДАТ(d0)+"'  and ee.t_valuedate != d.t_maturity and ee.t_purpose=11 and ee.t_paymstatus  > 2900) > 0  then 'Cформирован' else '?' end ) ";
     sql0=sql0+ "    else ' ' end)   isxpl2, ";

     sql0=sql0+ " ( select dd.t_ccy  from  dfininstr_dbt dd where dd.t_fiid=d.t_pfi ) fiid2 ";
     sql0=sql0+ " ,(select ga.t_outpmtmin1 from ddl_genagr_dbt ga where t_genagrid = c.t_genagrid) as t_outpmtmin1";
     sql0=sql0+ " from  ddl_tick_dbt c, ddl_leg_dbt d, dparty_dbt e , dpmpaym_dbt a where c.t_dealtype !=12310 and  c.t_dealtype !=12335 and   c.t_dealstatus < 20 and  c.t_bofficekind=102 and  c.t_dealdate < '"+СДАТ(d0)+"'";
     sql0=sql0+ " and d.t_dealid=c.t_dealid and d.t_legid=1  and e.t_partyid=c.t_partyid  and a.t_dockind=102 and a.t_documentid=c.t_dealid and a.t_purpose=9 and c.t_dealtype > 5000 order by  a.t_paymstatus ,vop desc , sta ";
     //   msgbox(sql0);


    
      cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );

  macro EvProc2 (rs0, cmd2, id, key )
     if (cmd2 == DLG_INIT)	// Инициализация
        if (pId2 != "0")  // Надо найти запись
           v_count = 0;
           while ( (rs0.value ("pId2") != pId2) And (Not rs0.EOF) )  
		if (ValType(rs0.value ("pId2")) == 26)
			v_DealId(v_count) = 0;
		else
			v_DealId(v_count)= rs0.value ("pId2");
		end;
                rs0.Move(1, RELATIVE);
		v_count = v_count + 1;
            end;

        end;
        GoToScroll(rs0, true);                                                                                   
        elif (cmd2 == DLG_KEY)
        pId2=rs0.value ("pId2");
        if(DLG_KEY_ENTER == Key)                                                                                 
         return CM_SELECT;
        end;
     end;
  end;



  AddCol (col2, 0, "dealcode","№ сделки", 10);
  AddCol (col2, 1, "su1","Cумма требований", 15);
  AddCol (col2, 2, "su2","Сумма обязательств", 15);
  AddCol (col2, 3, "fiid2","Валюта", 5);
  AddCol (col2, 4, "dealcodets","№ сделки(вн)", 10);
  AddCol (col2, 5, "nam","Контрагент", 16);
  AddCol (col2, 6, "dealdate","Дата начала", 10);
  AddCol (col2, 7, "maturity","Дата окончания", 13);
  AddCol (col2, 8, "vop","Вид", 3);

  AddCol (col2, 9, "sta","Загрузка плавающих ставок", 20);
  AddCol (col2, 10, "vpl","Начисление процентов ", 17);
  AddCol (col2, 11, "isxpl","Частичное погашение ОД", 18);
  AddCol (col2, 12, "isxpl2","Частичное погашение %%", 19);
  AddCol (col2, 13, "t_outpmtmin1","Платёж Т-1",10);

   while(RunScroll(cmd2, 14, col2, null, @EvProc2,"Монитор обработки открытых сделок МБК за "+СДАТ(d0),"F3- Просмотр F5- Ручная квитовка  F8- Отмена квитовки по сделке F9- Автоквитовка  ESC- Выход ", null, 0, 0) )
     cmd2 = RSDRecordset(sql0 , RSDVAL_CLIENT, RSDVAL_STATIC );

   end;

   exit(1);
end;


