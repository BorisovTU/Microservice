/*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
  RS-Bank 5.1                                          R-Style Software Lab
ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*/
import InsCarryDoc, CurrInter, à®æ¥­âë, MmarkInter, mmlibr, mmcarry, mmcnst_j, mmplib,dl_lib,dl_prol,dl_plib ;
import oralib;

PRIVATE FILE leg (dl_leg);
PRIVATE FILE pm ("pmpaym") key 1 write;
PRIVATE RECORD tick2 (dl_tick);

var ®¬¥à‘¤¥«ª¨;
var ®¬¥à’à ­è  = 1;

PRIVATE VAR 
      new_paymentid,
      deal_pd,      
      IP_id = TArray,
      IPtype = TArray,
      PP_id = TArray,
      PPtype = TArray;

PRIVATE MACRO FindPaymByPurpose (DealID, purp, status)
var stat;
    pm.DocKind = DL_IBCDOC;
    pm.DocumentID = DealID;
    pm.Purpose = purp;
    pm.SubPurpose = 0;

    stat = GetGE(pm);
    while (stat)
        if((pm.DocKind == DL_IBCDOC) and
           (pm.DocumentID == DealID) and
           (pm.Purpose == purp) and
           (pm.PaymStatus == status))
            return true;
        end;
        stat = next(pm);
    end;
    return false;
end;


PRIVATE MACRO Prolongate_OD (OD_New, new_paymentid, ExecDate)
    /*…á«¨ ¥áâì ¢ë­¥á¥­­ë© ­  ¯à®«®­£ æ¨î ¯« â¥¦ ¯® „ ­ ¤® ¯¥à¥­¥áâ¨ áà¥¤áâ¢  á® áâ à®£® „ ­  ­®¢ë©*/    
    if (FindPaymByPurpose(tick.dealid, PM_PURP_PRINC_RET, PM_CARRYED_OUT_TO_PROLONG))
        if( pm.ValueDate > {curdate} )
           mm_error("à¥¦¤¥¢à¥¬¥­­®¥ ¢ë¯®«­¥­¨¥ è £  § ¯à¥é¥­®.");
           return false;
        end;
        
        if (not MM_PRLNG_InsertDocsPrinc (deal_pd, ExecDate, pm, OD_New))
            return false;
        end;

        IPtype.size = PPtype.size = IP_id.size = PP_id.size = 0;

        IP_id[0] = pm.PaymentID;
        IPtype[0] = OPR_ID_REAL;
        PP_id[0] = new_paymentid;
        PPtype[0] = OPR_ID_REAL;

        if( not PaymentsKvit( IP_id, IPtype, PP_id, PPtype, null, PMLINK_KIND_PROLONG) )
            mm_error( "è¨¡ª  á¢ï§ë¢ ­¨ï ¯« â¥¦¥©" );
            return false;
        end;
    end;

    return true;
END;

PRIVATE MACRO Capitalize_Perc (OD_New, new_paymentid, ExecDate)
    VAR stat, ‘ç¥âà®æ¥­â®¢, ‘ã¬¬ « â¥¦ _¢á¥£® = 0, sz;

    ‘ç¥âà®æ¥­â®¢ = MM_GetAutoPerc(leg.DealID, leg.LegID, PC_IBC_CON);
        IPtype.size = PPtype.size = IP_id.size = PP_id.size = 0;

    /*…á«¨ ¥áâì ¢ë­¥á¥­­ë© ­  ¯à®«®­£ æ¨î ¯« â¥¦ ¯® %% ­ ¤® ¢ë¯®«­¨âì ª ¯¨â «¨§ æ¨î ­  ­®¢ë© „*/
    /*­  á ¬®¬ ¤¥«¥ ¨å ¬®¦¥â ¡ëâì ­¥áª®«ìª® */
    stat = FindPaymByPurpose(tick.dealid, PM_PURP_PERCENT, PM_CARRYED_OUT_TO_PROLONG);
    while (stat and limiter (tick, pm) and
           (pm.Purpose == PM_PURP_PERCENT) and
           (pm.PaymStatus == PM_CARRYED_OUT_TO_PROLONG))

        if (pm.FuturePayerAmount)
            if (not InsertPcPay( ‘ç¥âà®æ¥­â®¢, pm.ValueDate, ExecDate, pm.FuturePayerAmount))
                mm_error ("è¨¡ª  ¯à¨ ®¯« â¥ ¯à®æ¥­â®¢");
                return false;
            end;

            ‘ã¬¬ « â¥¦ _¢á¥£® = ‘ã¬¬ « â¥¦ _¢á¥£® + pm.FuturePayerAmount;

            sz = IP_id.size;
            IP_id[sz] = pm.PaymentID;
            IPtype[sz] = OPR_ID_REAL;
            PP_id[sz] = new_paymentid;
            PPtype[sz] = OPR_ID_REAL;
        end;

        stat = next(pm);
    end;

    if (‘ã¬¬ « â¥¦ _¢á¥£®)
        if (not MM_PRLNG_InsertDocsPerc ( deal_pd, ExecDate, ‘ã¬¬ « â¥¦ _¢á¥£®, OD_New, leg ))
            return false;
        end;

        if( not PaymentsKvit( IP_id, IPtype, PP_id, PPtype, null, PMLINK_KIND_CAPITAL) )
            mm_error( "è¨¡ª  á¢ï§ë¢ ­¨ï ¯« â¥¦¥©" );
            return false;
        end;    
    end;

    return true;
END;

macro GetMcAccInfo(account, param)          /*SVE ¯®«ãç¥­¨¥ ­®¬¥à  è ¡«®­  ¯® ¡ « ­á®¢®¬ã ­®¬¥à  áç¥â */
   var query;
   if (param == "templnum")
      query = DL_RSDCommand("Select t_templnum from dmcaccdoc_dbt where t_account = ?");
   elif (param == "groupnum")
      query = DL_RSDCommand("Select t_groupnum from dmcaccdoc_dbt where t_account = ?");
   elif (param == "period")
      query = DL_RSDCommand("Select t_periodid from dmcaccdoc_dbt where t_account = ?");
   end;
   query.AddParam(account);
   var data = query.Execute();
   if (data.Movenext())

      return data.value(0);
   else
      return 1;
   end;
end;


macro InsAcc(dockind, dealid, acc, catid, catnum, duration,dda )
      var que, rs0, pid;
      var templnum, groupnum; //SVE
      que="select count(*) from dmcaccdoc_dbt t where t_docid="+dealid+" and t_catid = "+catid+" and t_dockind=102 ";
      rs0 = LnGetRecordSet(que);
       if(rs0 != null)
         if (rs0.moveNext) 
             if (rs0.value(0) > 0 )
                return 0; 
             end;
         end;
       end;

      if (duration == 0)
	      pid = 0;
      elif (duration == 1)
 	      pid = 1;
      elif ((duration>1) and (duration <= 7))
 	      pid = 2;
      elif ((duration>7) and (duration <= 31))
 	      pid = 3;
      elif ((duration>32) and (duration <= 91))
 	      pid = 4;
      elif ((duration>92) and (duration <= 181))
 	      pid = 5;
      elif ((duration>181) and (duration <= 367))
 	      pid = 6;
      elif ((duration>367) and (duration <= 1097))
 	      pid = 7;
      else
              pid = 8;
      end;
      templnum = GetMcAccInfo(acc, "templnum");    
      if (catnum == 601)
         /*SVE 496278 */
         groupnum = GetMcAccInfo(acc, "groupnum");
         pid = GetMcAccInfo(acc, "period");
      else
         groupnum = 0;
      end;
      que = "insert into dmcaccdoc_dbt "+ 
            "(t_dockind,      "+
            " t_catid,        "+
            " t_catnum,       "+
            " t_docid,        "+
            " t_account,      "+
            " t_actiondate,   "+
            " t_activatedate, "+
            " t_isusable,     "+
            " t_kind_account, "+
            " t_currency,     "+
            " t_fiid,         "+
            " t_templnum,     "+
            " t_groupnum,     "+
            " t_periodid,     "+
            " t_chapter,      "+
            " t_disablingdate,"+
            " t_iscommon,     "+ 
            " t_owner,        "+ 
            " t_place,        "+ 
            " t_issuer,       "+ 
            " t_departmentid, "+ 
            " t_branch,       "+ 
            " t_mcbranch,      "+ 
            " t_firole,       "+ 
            " t_centr,        "+ 
            " t_centroffice,  "+ 
            " t_clientcontrid,"+ 
            " t_bankcontrid,  "+ 
            " t_marketplaceid,"+ 
            " t_marketplaceofficeid,"+ 
            " t_indexdate,    "+ 
            " t_contractor,   "+ 
            " t_currencyeq,   "+
            " t_currencyeq_ratetype,"+
            " t_currencyeq_ratedate,"+
            " t_currencyeq_rateextra,"+
            " t_corrdepartmentid,"+ 
            " t_fiid2 )"+
            " values ("+
             String(dockind)+", " +
             String(catid) + ", " +
             String(catnum)+ ", " +    
             String(dealid)+","+
            "'"+ acc+"', "+
            " to_date('"+dda+"', 'DD.MM.YYYY'),"+
            " to_date('"+dda+"', 'DD.MM.YYYY'),"+
            " 'X', "+
            " (select t_kind_account from dbalance_dbt  where t_balance ='"+ substr(acc,1,5)+"'), "+
            " (select nvl((select t_fiid from dfininstr_dbt t where t_fi_kind=1 and t.t_fi_code='"+substr(acc,6,3)+"'), 0) from dual), "+
            " (select nvl((select t_fiid from dfininstr_dbt t where t_fi_kind=1 and t.t_fi_code='"+substr(acc,6,3)+"'), 0) from dual), "+
            templnum + ", "+
            groupnum + ", "+
            pid+", "+
            "1, "+
            " to_date('01010001', 'DDMMYYYY'),"+
            "chr(0), "+
            "-1,"+
            "-1,"+
            "-1,"+
            "1,"+
            "1,"+
            "1,"+
            "5,"+  //FiDoc
            "-1,"+
            "-1,"+
            "-1,"+
            "-1,"+
            "-1,"+
            "-1,"+
            "-1,"+
            "-1,"+
            "-1,"+
            "0,"+
            "0,"+
            "0.0,"+
            "0,"+
            "0 )";
      rs0 = LnGetRecordset(que);
end;



/*----------------------------------------------------------------------------
    ‚ë¯®«­¥­¨¥ è £ 
----------------------------------------------------------------------------*/
MACRO Ex99(Document)
    var ®¢ë©„ = "", new_deal_pd, new_paymentid,acc0,acc9,da;
    var  at = MM_Carry;

    SetBuff (tick2,Document);

    ®¬¥à‘¤¥«ª¨=prolpos(tick2.DealID,MM_leg(tick2.DealID,"start",1));

    deal_pd = MMFirstDoc(DL_IBCDOC, ®¬¥à‘¤¥«ª¨, true);
    da=SDAT(tick.dealdate);

      if (tick.DealType == 12305)
        if (not ‘ç¥â‘¤¥«ª¨("+% ª ¯®£ è¥­¨î", deal_pd, acc9)) 
            msgbox("no");
            return false; 
        end; 
	 InsAcc(102, tick2.DealID, acc9, 117, 621, 0,da);    //Š“ +% ª ¯®£ è¥­¨î
      elif (tick.DealType == 12300)
        if (not ‘ç¥â‘¤¥«ª¨("-% ª ¯®£ è¥­¨î", deal_pd, acc9)) 
            msgbox("no");
            return false; 
        end;
        InsAcc(102, tick2.DealID, acc9, 118, 622, 0,da);    //Š“ -% ª ¯®£ è¥­¨î
      end;

       acc0 =MM_acc(®¬¥à‘¤¥«ª¨,111);



    new_deal_pd = MMFirstDoc(DL_IBCDOC, tick2.DealID, true);

/*
      if(not new_deal_pd.OpenAccount(tdr_mainrest, ®¢ë©„, NULL, new_deal_pd.GetFIRoleByCategory(tdr_mainrest, new_deal_pd.GetLeg().PFI), NULL, new_deal_pd.GetTick().DealDate, new_deal_pd.GetLeg().PFI))
        return 1;
      end;    
*/




    if(not new_deal_pd.FindNumberAccount(tdr_mainrest, ®¢ë©„, NULL, new_deal_pd.GetFIRoleByCategory(tdr_mainrest, new_deal_pd.GetLeg().PFI), new_deal_pd.GetLeg().PFI))
        return 1;
    end;    

    if ( substr(®¢ë©„,1,5) ==  substr(acc0,1,5))
      InsAcc(102, tick2.DealID, acc0, 111, 601, leg.Duration,da); //Š“ „
    end;


    return 0;
END;


