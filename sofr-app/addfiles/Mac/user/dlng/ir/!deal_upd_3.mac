//import RSD, Globals;
import "dv_grfun.mac", "dv_categ.mac";
var rs_m, cmd_m, sql_m;
var sql_k,cmd_k, rs_k;
var sql_1,cmd_1, rs_1;
var sql_2,cmd_2, rs_2;
var sql_3,cmd_3, rs_3;
var sql_4,cmd_4, rs_4;
var ins_open_gr;
var ins_close_gr;
var ins_fair_gr;
var exec_flag;

var FD;
var ДатаИсполненияШага;
var ndeal = TRecHandler("dvndeal.dbt");
var GA    = TRecHandler("dl_genagr.dbt");
var FrVal = TRecHandler("dvnfrval");
var cmd_main, cmd_nDeal, cmd_GA , cmd_OpStep, sql_OpStep;
var rs_main,  rs_nDeal,  rs_GA,   rs_OpStep;
var ndealid ;
var gaid ;
var id_operation; 
var res_month;
const DocKind_Deal = 199;


CONST  DLGR_TEMPL_OPENDEAL = 46; //Заключение сделки
CONST  DLGR_TEMPL_OPENDEALREQUEST = 48; //Заключение сделки с ожиданием запроса
//CONST  DLGR_TEMPL_MAKEDEAL_CORRECTION  = 72; //Заключение сделки (корр. сообщ.)

CONST  DLGR_TEMPL_FAIRVALUE = 75; //Сообщение о Переоценке СС

//CONST  DLGR_TEMPL_CLOSECONTR = 51; //Закрытие договора
CONST  DLGR_TEMPL_CLOSECONTRREQUEST = 52; //Закрытие договора с ож. запроса
var pDeal;
var gr_cmd, gr_rs;
/*cmd_m = RSDCommand("select distinct t_dealid from DDVNLOADFRVAL_DBT where t_datefrval = to_date('310719', 'ddmmyy') and t_dealid = ?  ");
GetString(pDeal, "Input Trade_ID:");
cmd_m.addParam ("", rsdbp_in,  pDeal  );*/
sql_m = "select dvn.t_id t_dealid from ( " +
"  SELECT DISTINCT lF.t_dealid, GR.T_PLANDATE " +
"    FROM    DDVNLOADFRVAL_DBT LF " +
"         LEFT JOIN " +
"            ddlgrdeal_dbt gr " +
"         ON gr.t_docid = LF.T_DEALID AND GR.T_TEMPLNUM = 75 " +
"   WHERE LF.t_datefrval = TO_DATE ('310719', 'ddmmyy') " +
"ORDER BY gr.t_plandate DESC) t , ddvndeal_dbt dvn , prsn_bak prsn " +
"where t.t_dealid = dvn.t_id and dvn.t_contractor != 1181 and dvn.t_contractor = prsn.t_partyid and t_plandate is  null         " ;
cmd_m = rsdCommand(sql_m);
rs_m = RSDRecordset(cmd_m);
while (rs_m.movenext())
    print("Сделка id:" + rs_m.value("t_dealid"));
    
    cmd_k = null; rs_k = null;
    sql_k = "SELECT DISTINCT t_kind, OPRK.T_NAME " +
    "  FROM ddvndeal_dbt dvn, doprkoper_dbt oprk " +
    " WHERE t_id IN (SELECT DISTINCT t_dealid p_dialid " +
    "                  FROM DDVNLOADFRVAL_DBT " +
    "                 WHERE t_datefrval = TO_DATE ('310719', 'ddmmyy')) " +
    "       AND dvn.t_kind = OPRK.T_KIND_OPERATION " +
    "       and dvn.t_id = ? " ;
    cmd_k = RSDCommand(sql_k);
    cmd_k.AddParam("",rsdbp_in, rs_m.value("t_dealid"));
    rs_k = RSDRecordset(cmd_k);
    if (rs_k.movenext())
       println("   " + rs_k.value("t_kind")+":"+rs_k.value("t_name"));
    end;

//1. заключение договора
    print("Ищем график 'Заключение договора':         ");
    sql_1 =  "SELECT gr.t_templnum, T.T_NAME " +
    "  FROM ddlgrdeal_dbt gr, ddlgrtempl_dbt t " +
    " WHERE     gr.t_templnum = t.t_num " +
    "       AND gr.t_dockind = 199 " +
    "       AND gr.t_docid = ? " +
    "       AND gr.t_templnum IN (?, ?, ?) " ;
    cmd_1 = RSDCommand(sql_1);
    cmd_1.AddParam("",rsdbp_in, rs_m.value("t_dealid"));
    cmd_1.AddParam("",rsdbp_in, DLGR_TEMPL_OPENDEAL);
    cmd_1.AddParam("",rsdbp_in, DLGR_TEMPL_OPENDEALREQUEST);
    cmd_1.AddParam("",rsdbp_in, DLGR_TEMPL_MAKEDEAL_CORRECTION);
    rs_1 = RSDRecordset(cmd_1);
    if(rs_1.movenext())
      println("Найдено:" + rs_1.value("t_templnum")+"."+rs_1.value("t_name")); 
      ins_open_gr = false;
    else
      println("                                                                          !!!Необходима вставка графика!!!"); 
      ins_open_gr = true;
    end;

//2.
    print("Ищем график  ' Закрытие договора':         ");
    sql_2 =  "SELECT gr.t_templnum, T.T_NAME " +
    "  FROM ddlgrdeal_dbt gr, ddlgrtempl_dbt t " +
    " WHERE     gr.t_templnum = t.t_num " +
    "       AND gr.t_dockind = 199 " +
    "       AND gr.t_docid = ? " +
    "       AND gr.t_templnum IN (?, ?) " ;
    cmd_2 = RSDCommand(sql_2);
    cmd_2.AddParam("",rsdbp_in, rs_m.value("t_dealid"));
    cmd_2.AddParam("",rsdbp_in, DLGR_TEMPL_CLOSECONTR);
    cmd_2.AddParam("",rsdbp_in, DLGR_TEMPL_CLOSECONTRREQUEST);
    rs_2 = RSDRecordset(cmd_2);
    if(rs_2.movenext())
      println("Найдено:" + rs_2.value("t_templnum")+"."+rs_2.value("t_name")); 
      ins_close_gr = false;
    else
      println("                                                                          !!!Необходима вставка графика!!!"); 
      ins_close_gr = true;
    end;

//3.
    print("Ищем график   '  Сообщение СМ094':         ");
    sql_3 =  "SELECT gr.t_templnum, T.T_NAME " +
    "  FROM ddlgrdeal_dbt gr, ddlgrtempl_dbt t " +
    " WHERE     gr.t_templnum = t.t_num " +
    "       AND gr.t_dockind = 199 " +
    "       AND gr.t_docid = ? " +
    "       AND gr.t_templnum IN (?) " ;
    cmd_3 = RSDCommand(sql_3);
    cmd_3.AddParam("",rsdbp_in, rs_m.value("t_dealid"));
    cmd_3.AddParam("",rsdbp_in, DLGR_TEMPL_FAIRVALUE);
    rs_3 = RSDRecordset(cmd_3);
    if(rs_3.movenext())
      println("Найдено:" + rs_3.value("t_templnum")+"."+rs_3.value("t_name")); 
      ins_fair_gr = false;
    else
      println("                                                                          !!!Необходима вставка графика!!!"); 
      ins_fair_gr = true;
    end;


 //4.Вставка графиков  
    if(ins_close_gr or ins_fair_gr )

       cmd_nDeal  = DL_RSDCommand("Select * from ddvndeal_dbt where t_id = ?");
       cmd_nDeal.AddParam(-1);
       cmd_GA     = DL_RSDCommand("Select * from ddl_genagr_dbt where t_genagrid = ?");
       cmd_GA.AddParam(-1);
       sql_OpStep ="SELECT TRUNC (os.t_plan_date, 'MON') res_date, os.\* " +
        "    FROM doprstep_dbt os " +
        "   WHERE os.t_id_operation = ? " +
        "         AND ( (os.t_kind_operation = 12690 " +
        "                AND ( (os.t_blockid = 20000151 AND os.t_number_step = 60) " +
        "                     OR (os.t_blockid = 20000148 AND os.t_number_step = 35))) " +
        "              OR (os.t_kind_operation = 12695 " +
        "                  AND ( (os.t_blockid = 20000173 AND os.t_number_step = 60) " +
        "                       OR (os.t_blockid = 20000170 AND os.t_number_step = 25))) " +
        "              OR (os.t_kind_operation = 22710 " +
        "                  AND ( (os.t_blockid = 20000629 AND os.t_number_step = 60) " +
        "                       OR (os.t_blockid = 20000627 AND os.t_number_step = 35))) " +
        "              OR (os.t_kind_operation = 22720 " +
        "                  AND ( (os.t_blockid = 20000649 AND os.t_number_step = 60) " +
        "                       OR (os.t_blockid = 20000647 AND os.t_number_step = 35))) " +
        "              OR (os.t_kind_operation = 22695 " +
        "                  AND (os.t_blockid = 20000610 AND os.t_number_step = 60)) " +
        "              OR (os.t_kind_operation = 12715 " +
        "                  AND (os.t_blockid = 40000024 AND os.t_number_step = 60))) and OS.T_FACT_DATE != to_date('01010001', 'ddmmyyyy') " +
        "ORDER BY os.t_plan_date " ;

       cmd_OpStep = dl_RSDCommand(sql_OpStep);
       cmd_OpStep.AddParam(-1);

       println("Вставка отсутствующих графиков:");
       sql_4 =  "SELECT dvn.t_id, dvn.t_genagrid, oo.t_id_operation  " +
       "  FROM ddvndeal_dbt dvn, doproper_dbt oo " +
       " WHERE LPAD (dvn.T_ID, 34, 0) = oo.t_documentid " +
       "     and OO.T_DOCKIND = 199  " +
       "     AND dvn.t_id = ?         " ;
       cmd_4 = RSDCommand(sql_4);
       cmd_4.AddParam("",rsdbp_in, rs_m.value("t_dealid"));
       rs_4 = RSDRecordset(cmd_4);
       
       if (rs_4.movenext())
          ndealid = rs_4.value("t_id");
          gaid = rs_4.value("t_genagrid");
          id_operation = rs_4.value("t_id_operation"); 
         
         
           cmd_nDeal.m_params.value(0) = ndealid;
           rs_nDeal = cmd_nDeal.execute();
           if(rs_nDeal.moveNext())
             rs_nDeal.GetRecord().CopyTo( nDeal.rec );
           end;

           cmd_GA.m_params.value(0) = gaid;
           rs_GA = cmd_GA.execute();
           if(rs_GA.moveNext())
            rs_GA.GetRecord().CopyTo( GA.rec );
           end;
         if(ins_close_gr)
            println("  - Вставка открытия/закрытия договора");
            SetAllGrDealDV(nDeal,GA);
            InsertAllGrDealDV(); 
            println("  - Ok!"); 
         end;
  //       SetAllGrDealDV(nDeal,GA);
  //       InsertAllGrDealDV(); 


          if(ins_fair_gr)
            println("  - Вставка CM094");  
            FD = DVFirstDocNDeal(DocKind_Deal, ndeal);
            cmd_OpStep.m_params.value(0) = id_operation;
            rs_OpStep = cmd_OpStep.execute();
            res_month = null;
            while(rs_OpStep.movenext())
             ДатаИсполненияШага = date(rs_OpStep.Fact_Date);//ndeal.rec.Date;
             
           //  if(res_month != rs_OpStep.Res_Date) 
              gr_cmd = RSDCommand("Select 1 gr_vol from ddlgrdeal_dbt where t_templnum = 76 and t_plandate = to_date('"+ДатаИсполненияШага+"','dd.mm.yyyy') and t_docid = ?");
              gr_cmd.addparam("",rsdbp_in,nDeal.rec.id);
              gr_rs = RSDREcordset(gr_cmd);
              if (gr_rs.movenext())
                msgbox (gr_rs.value("gr_vol"));
              else 
  
                 if( InsertGrDealFairValueRevaluation(FD, ДатаИсполненияШага, DocKind_Deal) != 0 )
                  MsgBox("Ошибка вставки строки графика \"Переоценка справедливой стоимости\"");
                  return 1;
                 end;
              end;

          //   res_month = rs_OpStep.Res_Date;
           //  end;
                
            end;//rs_OpStep  
             println("  - Ok!")         
          end;
       end;
    end;
    
//1.
println("________________________________________________________________________________________________________________________________");
end;
