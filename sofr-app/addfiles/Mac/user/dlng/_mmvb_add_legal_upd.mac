/*
$Name:        _mmvb_add_legal_upd.mac
$Module:      Securities
$Description: Добавление сообщений об обновлении данных для юр.лиц, добавление атрибута TRD_RESTR=2.
*/
import "dlcontrmsg_mmvb.mac";

private const LoadToTE      = 1;   // Импорт сведений в торговую систему в режиме онлайн (1 - да, 0 - нет)
private const LKU           = 4;   // 4 Собственный клиент Участника
private const SENDER_NAME   = "";  // Краткое наименование нашего банка

private macro PathNoticeSvodMMVB()
  var RegistryPath = "SECUR\\PATH_NOTICE_SVOD";
  var Path = "", stat = 0;
 
  GetRegistryValue(RegistryPath, V_STRING, Path, stat);
  if(stat) 
     msgbox("Не задана настройка в реестре банка:|", RegistryPath);      
  end;

  return Path;
end;

private macro ПроверитьПутьДБО_ММВБ()
  var err = "";
  var dl = null;
  dl = TDirList(DL_GetFullPath(PathNoticeSvodMMVB()), "FD");
  if(dl.Count == 0)
    err = "Нет каталога или нет доступа к каталогу: " + DL_GetFullPath(PathNoticeSvodMMVB());
  end;
  return err;
end;

private macro GetFormatDate(_date)
   var y, mon, d;
   DateSplit (_date,d,mon,y);
   return string(L_Z(y, 4)) + "-" + string(L_Z(mon,2)) + "-" + string(L_Z(d,2));
end;

private macro GetFormatTime(_time)
   var h, m, s;
   TimeSplit(Time(),h,m,s);
   return string(L_Z(h,2)) + ":" + string(L_Z(m,2)) + ":" + string(L_Z(s, 2));
end;

private class (DL_XML) _TDlFileClientsXML(IndividualFile:Bool)
   private var m_MainNode,
               m_UniOurBankCode, m_UniClientCode,
               m_IndividualFile;

   private macro GetFileName()
      var y, mon, d, h, m, s;

      if(m_FileName == NULL)
/*ak
         m_FileName = "ECLIENTS_" + IIF(m_IndividualFile, this.GetUniClientCode(), this.GetUniOurBankCode()) + "_";*/
         m_FileName = "ECLIENTS_" + this.GetUniOurBankCode() + "_";
/*~ak*/
         DateSplit ({curdate},d,mon,y);
         TimeSplit(Time(),h,m,s);
         m_FileName = m_FileName + GetFormatDate({curdate}) + "_" + string(L_Z(h,2)) + string(L_Z(m,2)) + string(L_Z(s, 2));
      end;

      return m_FileName;
   end;

   macro GetDataXML()
      return m_MainNode.xml;
   end;

   macro SaveXml()
      var NamePath = "", NameFile = "", NamePathFile = "";

      if(m_MainNode != null)
         AddMainNode(m_MainNode);

         NamePath = DL_GetFullPath(PathNoticeSvodMMVB());

         if(not DL_CreateDirIfNotExists(NamePath))
            NameFile = GetFileName(); 
            NamePathFile = NamePath + NameFile + ".xml";
            m_xml.save(NamePathFile);
         end;
      end;

      return NamePathFile;
   end;

   macro GetUniOurBankCode()
      if(m_UniOurBankCode == null)
         m_UniOurBankCode = ПолучитьКодСубъекта({OurBank}, PTCK_MICEX);
         if(substr(m_UniOurBankCode,1,2) == "MC")
           m_UniOurBankCode = substr(m_UniOurBankCode,3);
         end;
      end;
      return m_UniOurBankCode;
   end;

   macro GetUniClientCode()
      if(m_UniClientCode == null)
         m_UniClientCode = "";
      end;
      return m_UniClientCode;
   end;

   private macro SetUniClientCode(xmlClient)
      if(xmlClient != null)
         var CLIENT_CODE = xmlClient.getElementsByTagName( "CLIENT_CODE" );
         if((CLIENT_CODE != null) and (CLIENT_CODE.Length > 0))
            if(CLIENT_CODE.item(0).attributes.Length > 0)
               var UniClientCode = CLIENT_CODE.item(0).getAttribute("UniClientCode");
               if((UniClientCode != null) and (ValType(UniClientCode) != V_SPECVAL))
                  m_UniClientCode = UniClientCode;
               end;
            end;
         end;
      end;
   end;

   private macro GetSfContrRH(xmlClient, RecFromSelect)
      if(xmlClient != null)
         var CLIENT = xmlClient.getElementsByTagName( "CLIENT" );
         if((CLIENT != null) and (CLIENT.Length > 0))
            if(CLIENT.Item(0).attributes.Length > 0)
               var ClientCodeXml = DL_XMLReader();
               if(ClientCodeXml.Load_xml(CLIENT.Item(0).xml))
                  var CLIENT_CODE = ClientCodeXml.getXML().getElementsByTagName( "CLIENT_CODE" );
                  var UniClientCode = CLIENT_CODE.Item(0).getAttribute("UniClientCode");
                  if(StrLen(UniClientCode) > 0)
                     var Query = "SELECT msf.* \n" +
                                 "  FROM ddlcontrmp_dbt contr, \n" +
                                 "       dsfcontr_dbt sf, \n" +
                                 "       dsfcontr_dbt msf, \n" +
                                 "       ddlcontr_dbt d \n" +
                                 " WHERE     sf.t_ID = contr.t_SfContrID \n" +
                                 "       AND d.t_dlcontrid = contr.t_dlcontrid \n" +
                                 "       AND msf.t_id = d.t_sfcontrid \n" +
                                 "       AND contr.t_mpcode = '" + UniClientCode + "' \n" ;

                     RecFromSelect.Clear();
                     if(DL_GetRecHandler(RecFromSelect, Query))
                        return true;
                     end;
                  end;
               end;
            end;
         end;
      end;
/* bpv operationid не должен заполняться внутренним id сообщения RS-Bank - поэтому такой вариант получения sfcontr использовать нельзя

      if(xmlClient != null)
         var CLIENT = xmlClient.getElementsByTagName( "CLIENT" );
         if((CLIENT != null) and (CLIENT.Length > 0))
            if(CLIENT.Item(0).attributes.Length > 0)
               var OperationId = CLIENT.Item(0).getAttribute("OperationId");
               if(SQL_ConvTypeInteger(int(OperationId)) > 0)
                  var Query = "SELECT sf.* " +
                              "  FROM ddlcontrmsg_dbt msg, ddlcontr_dbt contr, dsfcontr_dbt sf " +
                              " WHERE sf.t_ID = contr.t_SfContrID " +
                              "   AND contr.t_DlContrID = msg.t_DlContrID " +
                              "   AND msg.t_ID = " + int(OperationId);
   
                  if(DL_GetRecHandler(RecFromSelect, Query))
                     return true;
                  end;
               end;
            end;
         end;
      end;
 */
      return false;
   end;

   private macro GetClientOperation(xmlClient)
      var ClientOperationName = "";

      if(xmlClient != null)
         var CLIENT = xmlClient.getElementsByTagName( "CLIENT" );
         if((CLIENT != null) and (CLIENT.Length > 0))
            if(CLIENT.Item(0).attributes.Length > 0)
               var ClientOperation = CLIENT.Item(0).getAttribute("ClientOperation");
               ClientOperation = SQL_ConvTypeStr(ClientOperation);
               if(ClientOperation == "A")
                  ClientOperationName = "\"A\" - добавление информации о новом клиенте";
               elif(ClientOperation == "L")
                  ClientOperationName = "\"L\" - добавление клиенту новых кратких кодов";
               elif(ClientOperation == "R")
                  ClientOperationName = "\"R\" - удаление кратких кодов клиента на рынках";
               elif(ClientOperation == "D")
                  ClientOperationName = "\"D\" - полное удаление информации о клиенте";
               elif(ClientOperation == "U")
                  ClientOperationName = "\"U\" - изменение информации о личных данных клиента";
               end;
            end;
         end;
      end;

      return ClientOperationName;
   end;

   private macro Create_CLIENTS()
      var query, cmd, ds, xmlClient;
/*ak*/
      var ind, nummes = 1;
/*~ak*/
      var CLIENTS = CreateNode("CLIENTS");

/*ak
      if(m_IndividFile)
         CLIENTS.setAttribute("UniFirmId", GetUniClientCode());
      else
~ak*/
         CLIENTS.setAttribute("UniFirmId", GetUniOurBankCode());
/*ak
      end;
~ak*/

      CLIENTS.setAttribute("LoadToTE", LoadToTE);
      //CLIENTS.setAttribute("DocDate", GetFormatDate({curdate}));
      CLIENTS.setAttribute("DocDate", GetFormatDate(date)); // Golovkin

      query = " SELECT CM.T_ID FROM DDLCONTRMSG_DBT CM, DDLCONTRMSG_TMP CMT WHERE CM.T_ID = CMT.T_MSGID ORDER BY CM.T_CREATEDATE, CM.T_CREATETIME, CM.T_ID ";
      cmd = DL_RSDCommand(query);
      ds = cmd.Execute();
      while(ds.moveNext())
         xmlClient = Dl_XmlReader();
         if(xmlClient.Load_xml(DL_GetClobData("t_xml", "from DDLCONTRMSG_DBT where t_ID = "+Int(ds.ID))))
            if(xmlClient.GetXml().ChildNodes.Length > 0)
/*ak*/
               ind = 0;
               while(ind < xmlClient.GetXml().ChildNodes.item(0).attributes.length)
                 if(xmlClient.GetXml().ChildNodes.item(0).attributes.item(ind).nodename == "OperationId")
                   xmlClient.GetXml().ChildNodes.item(0).attributes.item(ind).nodevalue = string(nummes);
                   nummes = nummes + 1;
                   break;
                 end;
                 ind = ind + 1;
               end;
/*~ak*/
               if(m_IndividualFile)
                  SetUniClientCode(xmlClient.GetXml());
               else
                  // для сводного сообщения добавляем информацию в протокол
               end;

               CLIENTS.appendChild(xmlClient.GetXml().DocumentElement);
            end;
         end;
      end;
//UPG 73 определяется выше, в пользовательском коде
//      CLIENTS.setAttribute("UniFirmId", GetUniOurBankCode());

      return CLIENTS;
   end;

   private macro Create_DOC_REQUISITES()
      var DOC_REQUISITES = CreateNode("DOC_REQUISITES");

      DOC_REQUISITES.setAttribute("DOC_DATE", GetFormatDate({curdate}));
      DOC_REQUISITES.setAttribute("DOC_TIME", GetFormatTime(Time()));

      var RefID, RefNum;
      if(DL_GenerateNumberByReference( 207, 5, @RefID, @RefNum ))
         DOC_REQUISITES.setAttribute("DOC_NO", RefNum);
      else
         RefNum = "";
      end;

      DOC_REQUISITES.setAttribute("DOC_TYPE_ID", "ECLIENTS");
      DOC_REQUISITES.setAttribute("SENDER_ID", GetUniOurBankCode());
      var sn = SENDER_NAME;
/*      if(sn == "")
        sn = GetPartyShortNameByID({OurBank});
      end; */
      if(sn == "")
        sn = "АО Россельхозбанк"/*GetPartyShortNameByID({OurBank})*/;
      end;      
      DOC_REQUISITES.setAttribute("SENDER_NAME", sn);
      DOC_REQUISITES.setAttribute("RECEIVER_ID", "MM0000100000");
      DOC_REQUISITES.setAttribute("REMARKS", "Клиенты");

      var cmd, rs;
      StartCaptureOutput();
      [ 
        select substr(sys_guid(),9,12-length(?))||? t_guid from dual
      ];
      cmd = RsdCommand(EndCaptureOutput());
      cmd.AddParam("n1", RSDBP_IN, string(RefNum));
      cmd.AddParam("n2", RSDBP_IN, string(RefNum));
      rs = RSDRecordset(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);
      rs.movenext();
      DOC_REQUISITES.setAttribute("DOC_NO", rs.value("t_guid"));
/*~ak*/
      DOC_REQUISITES.setAttribute("DOC_TIME", GetFormatTime(Time()));
      //DOC_REQUISITES.setAttribute("DOC_DATE", GetFormatDate({curdate}));
      DOC_REQUISITES.setAttribute("DOC_DATE", GetFormatDate(date)); // Golovkin 

      return DOC_REQUISITES;
   end;

   private macro Create_FileCLIENT()
      m_MainNode = CreateNode("MICEX_DOC");

      m_MainNode.setAttribute("xsi:noNamespaceSchemaLocation", "MoexClients.xsd");
      m_MainNode.setAttribute("xmlns:xsi", "http://www.w3.org/2001/XMLSchema-instance");

      m_MainNode.appendChild(Create_DOC_REQUISITES());
      m_MainNode.appendChild(Create_CLIENTS());
   end;

   macro Construct(IndividualFile);
      m_MainNode = null;
      m_IndividualFile = IndividualFile;
      CreateXML("utf-8");

      Create_FileCLIENT();
   end;

   initDL_XML();
   this.Construct(IndividualFile);
end;





private macro GetExchangeCode(exchangeCode:@variant, MmvbCode, DlContrID)
  var stat = 0;
  exchangeCode.clear();
  exchangeCode.KeyNum = 2;
  exchangeCode.rec.MmvbCode = MmvbCode;
  if(not GetEQ(exchangeCode))
    stat = 1;
    MsgBox("Не удалось найти запись с биржевым кодом ММВБ " + MmvbCode);
  elif((DlContrID != null) and (DlContrID > 0) and (exchangeCode.rec.DlContrID != DlContrID))
    stat = 1;
    MsgBox("Не удалось найти запись с биржевым кодом ММВБ " + MmvbCode + " и DlContrID = " + DlContrID);
   end;
  return stat;
end;

private class (DL_XML) _TDlClientXML(DlContr, SfContr, DlContrMsg)
   private var m_MainNode,
               m_DlContr, m_SfContr, m_DlContrMsg, m_Kind,
               m_Client = TRecHandler("party.dbt"),
               m_UniClientCode, m_UniOurBankCode,
               m_stat = 0;

   macro GetClientXML()
      return m_MainNode.xml;
   end;

   macro GetStat()
      return m_stat;
   end;

   private macro GetUniClientCode()
      var CodeKind;
      if(m_UniClientCode == null)
         CodeKind = ПолучитьВидКодаДБОДляБиржи(m_DlContrMsg.rec.MarketID);
         if(CodeKind > 0)
           m_UniClientCode = DL_GetDlObjCodeOnDate(OBJTYPE_BROKERCONTR_DL, CodeKind, m_DlContr.rec.DlContrID/*, m_SfContr.rec.DateBegin*/);
         end;
      end;
      return m_UniClientCode;
   end;

   private macro GetUniOurBankCode()
      if(m_UniOurBankCode == null)
         m_UniOurBankCode = ПолучитьКодСубъекта({OurBank}, PTCK_MICEX);
         if(substr(m_UniOurBankCode,1,2) == "MC")
           m_UniOurBankCode = substr(m_UniOurBankCode,3);
         end;
      end;
      return m_UniOurBankCode;
   end;

   private macro GetClientOperation()
      var ClientOperation = "";
      if(m_Kind == OBJTYPE_DLCONTRMSG_MARKETREG)
         ClientOperation = "A";
      elif(m_Kind == OBJTYPE_DLCONTRMSG_MPREG)
         ClientOperation = "L";
      elif(m_Kind == OBJTYPE_DLCONTRMSG_MPCLOSE)
         ClientOperation = "R";
      elif(m_Kind == OBJTYPE_DLCONTRMSG_MARKETCLOSE)
         ClientOperation = "D";
      elif(m_Kind == OBJTYPE_DLCONTRMSG_CHNGPERSDATA)
         ClientOperation = "U";
      end;

      return ClientOperation;
   end;

   private macro GetMarketID(SfContr)
      var MarketID = "";

      if(SfContr.rec.ServKind == PTSK_STOCKDL)
         MarketID = "SE"; // Фондовый рынок
      elif(SfContr.rec.ServKind == PTSK_DV)
         MarketID = "FO"; // Срочный рынок
      elif(SfContr.rec.ServKind == PTSK_CM)
         MarketID = "CU"; // Валютный рынок
      end;

      return MarketID;
   end;

   private macro GetClient()
      if(m_Client.rec.PartyID == 0)
         m_Client.clear();
         ПолучитьСубъекта(m_SfContr.rec.PartyID, m_Client);
      end;

      return m_Client;
   end;

   private macro GetClientIDC( RecFromSelect:TRecHandler, PartyID, PaperKind ) :BOOL
      var Query = "SELECT * FROM DPERSNIDC_DBT WHERE T_PERSONID = " + PartyID + DL_IIF(PaperKind != null, " AND T_PAPERKIND = " + PaperKind, "");
      if(DL_GetRecHandler(RecFromSelect, Query))
         return true;
      end;
      return false;
   end;

   private macro GetSfContrRH( RecFromSelect:TRecHandler, SfContrID ) :BOOL
      var Query = "SELECT * FROM DSFCONTR_DBT WHERE T_ID = " + SfContrID;
      if(DL_GetRecHandler(RecFromSelect, Query))
         return true;
      end;
      return false;
   end;

   private macro GetIsIISContract()
      if(m_DlContr.rec.IIS == SET_CHAR)
         return "Y";
      else
         return "N";
      end;
   end;

   private macro GetClientCodeDescr() :STRING
      var ret = "", query, cmd, ds;
      if(GetClient().rec.PartyID > 0)
         query = " SELECT RSB_SECUR.Translit(replace(replace(trim(t_Name1 "+
                                                     " || CASE WHEN NVL(t_Name2, CHR(1)) = CHR(1) "+
                                                             " THEN '' "+
                                                             " ELSE substr(t_Name2, 1, 1) "+
                                                         " END "+
                                                     " || CASE WHEN NVL(t_Name3, CHR(1)) = CHR(1) "+
                                                             " THEN '' "+
                                                             " ELSE substr(t_Name3, 1, 1) "+
                                                         " END  "+
                                                       " ), '-', ''), ' ', '')) as FIO " +
                   " FROM DPERSN_DBT " +
                  " WHERE t_PersonID = ? ";

         cmd = DL_RSDCommand(query);
         cmd.AddParam(GetClient().rec.PartyID);

         ds = cmd.Execute();
         if(ds.moveNext())
            ret = SQL_ConvTypeStr(ds.FIO);
         end;
      end;
      return ret;
   end;

   private macro Create_CLIENT_MARKETS(DlContrMp)
      var SfContr = TRecHandler("sfcontr.dbt");
      var CLIENT_MARKETS = CreateNode("CLIENT_MARKETS");

      if(DL_GetSfContrRH(SfContr, DlContrMp.rec.SfContrID))
         CLIENT_MARKETS.setAttribute("ClientCode", DlContrMp.rec.MpCode);
         CLIENT_MARKETS.setAttribute("MarketId", GetMarketID(SfContr));
   
         if(((GetMarketID(SfContr) == "SE") or (GetMarketID(SfContr) == "FO")) and (GetClient().rec.LegalForm == PTLEGF_PERSN))
            CLIENT_MARKETS.setAttribute("isIISContract", GetIsIISContract());

            if((GetMarketID(SfContr) == "SE") and 
               ((m_Kind == OBJTYPE_DLCONTRMSG_MARKETREG) or
                (m_Kind == OBJTYPE_DLCONTRMSG_MPREG))
              )
              if(ИспользоватьСправочникКодов() and (m_stat == 0))
                var exchangeCode = Tbfile("exchangecode.dbt", "W", 2);
                if((m_stat = GetExchangeCode(exchangeCode, DlContrMp.rec.MpCode, DlContrMp.rec.DlContrID)) == 0)
                  exchangeCode.rec.MmvbDate = {curdate};
                  exchangeCode.rec.MmvbTime = time();
                  if(not exchangeCode.Update())
                    m_stat = 1;
                  end;
                end;
                if(m_stat != 0)
                  MsgBox("Не удалось найти/обновить дату исп. кода на фондовой секции, на записи с биржевым кодом ММВБ " + exchangeCode.rec.MmvbCode + " и DlContrID = " + DlContrMp.rec.DlContrID);
                end;
              end;
            end;
         end;
      end;

      CLIENT_MARKETS.setAttribute("isCrossTrades", "N");

      if((GetMarketID(SfContr) == "FO") and (GetClient().rec.LegalForm == PTLEGF_PERSN))
         CLIENT_MARKETS.setAttribute("ClientCodeDescr", GetClientCodeDescr());
      end;

      return CLIENT_MARKETS;
   end;

   private macro Create_CLIENT_CODE()
      var query, cmd, ds, DlContrMp = TRecHandler("dlcontrmp.dbt"),
          select  = " SELECT MP.* ",
          from    = " FROM DDLCONTRGENMSG_TMP GENMSG, DDLCONTRMP_DBT MP ",
          where   = " WHERE MP.T_ID = GENMSG.T_MpID ",
          orderBy = " ORDER BY GENMSG.T_ID ";
      var CLIENT_CODE = CreateNode("CLIENT_CODE");

      CLIENT_CODE.setAttribute("UniClientCode", GetUniClientCode());

      if((m_Kind == OBJTYPE_DLCONTRMSG_MARKETREG)
      or (m_Kind == OBJTYPE_DLCONTRMSG_MPREG)
      or (m_Kind == OBJTYPE_DLCONTRMSG_MPCLOSE)
      or (m_Kind == OBJTYPE_DLCONTRMSG_MARKETCLOSE))
         if(m_Kind == OBJTYPE_DLCONTRMSG_MARKETREG)
            where = where + " AND GENMSG.T_KIND IN (" + OBJTYPE_DLCONTRMSG_MARKETREG + "," + OBJTYPE_DLCONTRMSG_MPREG + ")";
         elif(m_Kind == OBJTYPE_DLCONTRMSG_MPREG)
            where = where + " AND GENMSG.T_KIND IN (" + OBJTYPE_DLCONTRMSG_MPREG + ")";
         elif(m_Kind == OBJTYPE_DLCONTRMSG_MPCLOSE)
            where = where + " AND GENMSG.T_KIND IN (" + OBJTYPE_DLCONTRMSG_MPCLOSE + ")";
         else
            where = where + " AND GENMSG.T_KIND IN (" + OBJTYPE_DLCONTRMSG_MPCLOSE + "," + OBJTYPE_DLCONTRMSG_MARKETCLOSE + ")";
         end;

         query = select + from + where + orderBy;
         cmd = DL_RSDCommand(query);
         ds = cmd.Execute();
         while((not m_stat) and ds.moveNext() and (ds.ID > 0))
            DlContrMp.clear();
            ds.GetRecord().CopyTo( DlContrMp.rec );
            CLIENT_CODE.appendChild(Create_CLIENT_MARKETS(DlContrMp));
         end;
      end;

      return CLIENT_CODE;
   end;

   private macro GetObjLink_cmd(ObjectType, ObjectID, AttrType/*, GroupID*/)
      var query, vGroupID = "", GroupID, i = 4;

      while (GetParm(i, GroupID))
         if(vGroupID != "")
            vGroupID = vGroupID + ",";
         end;
         vGroupID = vGroupID + GroupID;
         i = i + 1;
      end;

      query = " SELECT T_ATTRID FROM DOBJLINK_DBT WHERE T_OBJECTTYPE = " + ObjectType +
              "                                     AND T_OBJECTID = " + ObjectID +
              "                                     AND T_ATTRTYPE = " + AttrType +
              "                                     AND T_GROUPID IN (" + vGroupID +")";

      return DL_RSDCommand(query);
   end;

   // получить представителя субъекта
   private macro GetRepresentativePers(PartyID)
      var PersPartyID = UnknownParty, query, cmd, ds, pBuf = TRecHandler("party.dbt"), existsDefault = false, existsInDate = false;

      // Если субъект несовершеннолетний, то ищем его законных представителей:
      // 1. Мать/отца, через связанные объекты на субъекте 
      cmd = GetObjLink_cmd(OBJTYPE_PARTY, UniID(GetClient(), OBJTYPE_PARTY), OBJTYPE_PARTY, OBJROLE_PARTY_FATHER, OBJROLE_PARTY_MOTHER);
      ds = cmd.Execute();
      if(ds.moveNext())
         pBuf.Clear();
         if(RestoreFromUniID(ds.AttrID, pBuf, OBJTYPE_PARTY) and (pBuf.rec.PartyID > 0))
            PersPartyID = pBuf.rec.PartyID;
         end;
      // 2. иначе ищем представителя, который вызывается на субъекте по Alt+Y
      else
         query = " SELECT T_PROXYID, T_DOCDATE, T_VALIDITYDATE, T_ISDEFAULT FROM DPTPROXY_DBT WHERE T_PARTYID = " + PartyID;
         cmd = DL_RSDCommand(query);
         ds = cmd.Execute();
         while(ds.moveNext())
            if(PersPartyID == UnknownParty)
               PersPartyID = ds.ProxyID;
            end;
            
            if(({curdate} >= SQL_ConvTypeDate(ds.DocDate)) and ({curdate} <= SQL_ConvTypeDate(ds.ValidityDate)))
               if(not existsInDate)
                  PersPartyID = ds.ProxyID;
                  existsInDate = true;
               end;
               
               if(ds.IsDefault == SET_CHAR)
                  PersPartyID = ds.ProxyID;
                  break;
               end;
            elif((ds.IsDefault == SET_CHAR) and (not existsDefault))
               PersPartyID = ds.ProxyID;
               existsDefault = true;
            end;
         end;
      end;

      return PersPartyID;
   end;

   private macro SetNodesIn_CLIENT_INDIVIDUAL(PartyID, IsRepresentative, ParentNode)
      var stat = false;
      var ClientIDC = TRecHandler("persnidc.dbt"), node, DocNo, PersPartyID,
          existsDoc = false, PaperSeries = "";

      if(GetClientIDC(ClientIDC, PartyID, DOC_PASSPORT))
         PaperSeries = StrSubst(ClientIDC.rec.PaperSeries, " ", "");
         if((strlen(PaperSeries) > 0) and (strlen(ClientIDC.rec.PaperNumber) > 0))
            if(strlen(PaperSeries) > 3)
               DocNo = SubStr(PaperSeries, 1, 2) + " " + SubStr(PaperSeries, 3, 2) + " " + ClientIDC.rec.PaperNumber;
               node = CreateNode("PASSPORT_RF");
               node.setAttribute("DocNo", DocNo);
               ParentNode.appendChild(node);
               existsDoc = true;
               stat = true;
            end;
         else
            m_stat = 1;
            MsgBox("Для субъекта \"" + DL_GetPartyShortName(PartyID) + "\" не заданы параметры документа");
         end;
      elif(GetClientIDC(ClientIDC, PartyID, DOC_USSRPASS))
         PaperSeries = StrSubst(ClientIDC.rec.PaperSeries, " ", "");
         if((strlen(PaperSeries) > 0) and (strlen(ClientIDC.rec.PaperNumber) > 0))
            DocNo = PaperSeries + " " + ClientIDC.rec.PaperNumber;
            node = CreateNode("PASSPORT_USSR");
            node.setAttribute("DocNo", DocNo);
            ParentNode.appendChild(node);
            existsDoc = true;
            stat = true;
         else
            m_stat = 1;
            MsgBox("Для субъекта \"" + DL_GetPartyShortName(PartyID) + "\" не заданы параметры документа");
         end;
      elif(GetClientIDC(ClientIDC, PartyID, DOC_BIRTH_CERTIFICATE) and (not IsRepresentative))
         PaperSeries = StrSubst(ClientIDC.rec.PaperSeries, " ", "");
         if((strlen(PaperSeries) > 0) and (strlen(ClientIDC.rec.PaperNumber) > 0))
            DocNo = PaperSeries + " " + ClientIDC.rec.PaperNumber;
            node = CreateNode("BIRTH_CERTIFICATE");
            node.setAttribute("DocNo", DocNo);
            ParentNode.appendChild(node);
            stat = true;

            var REPRESENTATIVE_PERS = CreateNode("REPRESENTATIVE_PERS");
            PersPartyID = GetRepresentativePers(PartyID);
            if(PersPartyID != UnknownParty)
               if(SetNodesIn_CLIENT_INDIVIDUAL(PersPartyID, true, REPRESENTATIVE_PERS))
                  ParentNode.appendChild(REPRESENTATIVE_PERS);
               end;
            end;
         else
            m_stat = 1;
            MsgBox("Для субъекта \"" + DL_GetPartyShortName(PartyID) + "\" не заданы параметры документа");
         end;
      elif(GetClientIDC(ClientIDC, PartyID))
         if(strlen(ClientIDC.rec.PaperNumber) > 0)
            PaperSeries = StrSubst(ClientIDC.rec.PaperSeries, " ", "");
            DocNo = DL_IIF(strlen(PaperSeries) > 0, (PaperSeries + " "), "") + ClientIDC.rec.PaperNumber;
            node = CreateNode("OTHER_DOC");
            node.setAttribute("DocNo", DocNo);
            ParentNode.appendChild(node);
            existsDoc = true;
            stat = true;
         else
            m_stat = 1;
            MsgBox("Для субъекта \"" + DL_GetPartyShortName(PartyID) + "\" не заданы параметры документа");
         end;
      end;

      if( (not m_stat) and (not existsDoc) )
         m_stat = 1;
         MsgBox("Для субъекта \"" + DL_GetPartyShortName(PartyID) + "\" не задан документ, удостоверяющий личность");
      end;

      return stat;
   end;

   private macro Create_CLIENT_INDIVIDUAL(PartyID, IsClient)
      var ClientIDC = TRecHandler("persnidc.dbt"), node;
      var CLIENT_INDIVIDUAL = CreateNode("CLIENT_INDIVIDUAL");

      if(IsClient)
         CLIENT_INDIVIDUAL.setAttribute("isIISContract", GetIsIISContract());
      end;

      SetNodesIn_CLIENT_INDIVIDUAL(PartyID, false, CLIENT_INDIVIDUAL);

      return CLIENT_INDIVIDUAL;
   end;

   private macro GetIsSelfFirm()
      if( (GetClient().rec.PartyID == {OurBank} ) AND
          (DL_GetMainObjAttr( GetClient(), PARTY_ATTR_GROUP_PTTYPE, OBJTYPE_PARTY ) == PARTY_ATTR_PTTYPE_TRUSTMANAGER))
         return true;
      end;
      return false;
   end;

   private macro GetIsMainSingleDU()
      if((GetClient().rec.NotResident == UNSET_CHAR) AND
         (DL_GetMainObjAttr( GetClient(), PARTY_ATTR_GROUP_PTTYPE, OBJTYPE_PARTY ) == PARTY_ATTR_PTTYPE_TRUSTMANAGER))
         var cmd, ds, cnt = 0;
         cmd = GetObjLink_cmd(OBJTYPE_PARTY, UniID(GetClient(), OBJTYPE_PARTY), OBJTYPE_PARTY, 8/*Учредитель ДУ*/);
         ds = cmd.Execute();
         while(ds.moveNext())
            cnt = cnt + 1;
         end;

         if(cnt > 1)
            return true;
         end;
      end;

      return false;
   end;

   private macro GetIsMainPF()
      if((GetClient().rec.NotResident == UNSET_CHAR) AND
         (DL_GetMainObjAttr( GetClient(), PARTY_ATTR_GROUP_PTTYPE, OBJTYPE_PARTY ) == PARTY_ATTR_PTTYPE_TRUSTMANAGER))
         var cmd, ds;
         cmd = GetObjLink_cmd(OBJTYPE_PARTY, UniID(GetClient(), OBJTYPE_PARTY), OBJTYPE_PARTY, 9/*Фонд ДУ*/);
         ds = cmd.Execute();
         if(ds.moveNext())
            return true;
         end;
      end;

      return false;
   end;

   private macro Create_INN(val)
      var INN = CreateNode("INN");
      INN.setAttribute("DocNo", val);
      return INN;
   end;

   private macro Create_KIO(val)
      var KIO = CreateNode("KIO");
      KIO.setAttribute("DocNo", val);
      return KIO;
   end;

   private macro GetINN(PartyID, PTCK_Kind)
      var inn, slashInd, innNotKPP;

      inn = ПолучитьКодСубъекта(PartyID, PTCK_Kind);
      slashInd = Index(inn, "/");
      innNotKPP = DL_IIF(slashInd > 0, SubStr(inn, 1, slashInd - 1), inn);

      return innNotKPP;
   end;

   private macro Create_CLIENT_LEGAL_PERS(PartyID, IsClient)
      var innNotKPP, KIO, party = TRecHandler("party.dbt");
      var CLIENT_LEGAL_PERS = CreateNode("CLIENT_LEGAL_PERS");

      if(ПолучитьСубъекта(PartyID, party) == 0)
         if(IsClient)
            if(GetIsSelfFirm())
               CLIENT_LEGAL_PERS.setAttribute("isSelfFirm", "Y");
            end;
      
            if(GetIsMainSingleDU())
               CLIENT_LEGAL_PERS.setAttribute("isMainSingleDU", "Y");
               CLIENT_LEGAL_PERS.setAttribute("isMainGroupDU", "Y");
            end;
      
            if(GetIsMainPF())
               CLIENT_LEGAL_PERS.setAttribute("isMainPF", "Y");         
            end;
         end;
   
         innNotKPP = GetINN(PartyID, DL_IIF(party.rec.NotResident == UNSET_CHAR, PTCK_INN, PTCK_FOREIGN_INN));
   
         if((innNotKPP != null) and (innNotKPP != ""))
            innNotKPP = L_Z(innNotKPP, 10);
            CLIENT_LEGAL_PERS.appendChild(Create_INN(innNotKPP));
         else
            if(party.rec.NotResident == UNSET_CHAR)
               m_stat = 1;
               MsgBox("Для субъекта \"" + Party.rec.ShortName + "\" не задан ИНН");
            else
               KIO = ПолучитьКодСубъекта(party.rec.PartyID, PTCK_INN /*если ИНН = 5 символов, то это КИО*/);
               if((KIO != null) and (strlen(KIO) == 5))
                  CLIENT_LEGAL_PERS.appendChild(Create_KIO(KIO));
               else
                  m_stat = 1;
                  MsgBox("Для субъекта \"" + Party.rec.ShortName + "\" не задан ИНН/КИО");
               end;
            end;
         end;
      end;

      return CLIENT_LEGAL_PERS;
   end;

   private macro Create_CLIENT_SIMPLE()
      var CLIENT_SIMPLE = CreateNode("CLIENT_SIMPLE");

      CLIENT_SIMPLE.setAttribute("CountryCode", DL_GetCountryByCodeLat3(GetClient().rec.NrCountry).CodeNum3);
      CLIENT_SIMPLE.setAttribute("isQualInvestor", DL_IIF(IsQI(GetClient().rec.PartyID, m_DlContr.rec.SfContrID), "Y", "N" ));

      if(GetClient().rec.LegalForm == PTLEGF_INST)
         CLIENT_SIMPLE.setAttribute("TRD_RESTR", 2); 

         CLIENT_SIMPLE.appendChild(Create_CLIENT_LEGAL_PERS(GetClient().rec.PartyID, true));
      else
         CLIENT_SIMPLE.appendChild(Create_CLIENT_INDIVIDUAL(GetClient().rec.PartyID, true));
      end;

      return CLIENT_SIMPLE;
   end;

   private macro Create_CLIENT_DU(Party)
      var CLIENT_DU = CreateNode("CLIENT_DU");      
      
      if(ПолучитьСубъекта(Party.rec.PartyID, Party) == 0)
         CLIENT_DU.setAttribute("CountryCode", DL_GetCountryByCodeLat3(Party.rec.NrCountry).CodeNum3);

         if(IsQI(Party.rec.PartyID, m_DlContr.rec.SfContrID))
            CLIENT_DU.setAttribute("isQualInvestor", "Y");
         end;

         if(Party.rec.LegalForm == PTLEGF_PERSN)
            CLIENT_DU.appendChild(Create_CLIENT_INDIVIDUAL(Party.rec.PartyID, false));
         else
            CLIENT_DU.appendChild(Create_CLIENT_LEGAL_PERS(Party.rec.PartyID, false));
         end;
      end;

      return CLIENT_DU;
   end;

   private macro Create_PIF(val)
      var PIF = CreateNode("PIF");
      PIF.setAttribute("RegNum", val);
      return PIF;
   end;

   private macro Create_NPF_Reserv(val)
      var NPF_Reserv = CreateNode("NPF_Reserv");
      NPF_Reserv.setAttribute("INN", val);
      return NPF_Reserv;
   end;

   private macro Create_NPF_Save(val)
      var NPF_Save = CreateNode("NPF_Save");
      NPF_Save.setAttribute("INN", val);
      return NPF_Save;
   end;

   private macro Create_NPF_Ustav(val)
      var NPF_Ustav = CreateNode("NPF_Ustav");
      NPF_Ustav.setAttribute("INN", val);
      return NPF_Ustav;
   end;

   private macro Create_PF(inn, PartyID)
      var party = TRecHandler("party.dbt"), InfoIP;
      var PF = CreateNode("PF");
      PF.setAttribute("INN", inn);

      party.rec.PartyID = PartyID;
      InfoIP = ReadNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 72/*Код инвестиционного портфеля*/);
      if(InfoIP != null)
         PF.setAttribute("InfoIP", InfoIP);
      end;

      return PF;
   end;

   private macro Create_HomeMilitary(inn, PartyID)
      var party = TRecHandler("party.dbt"), InfoIP;
      var HomeMilitary = CreateNode("HomeMilitary");
      HomeMilitary.setAttribute("INN", inn);

      party.rec.PartyID = PartyID;
      InfoIP = ReadNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 72/*Код инвестиционного портфеля*/);
      if(InfoIP != null)
         HomeMilitary.setAttribute("InfoIP", InfoIP);
      end;

      return HomeMilitary;
   end;

   private macro Create_CLIENT_PF(Party)
      var FSFR, innNotKPP;
      var CLIENT_PF = CreateNode("CLIENT_PF");      

      if(IsQI(Party.rec.PartyID, m_DlContr.rec.SfContrID))
         CLIENT_PF.setAttribute("isQualInvestor", "Y");
      end;

      if( ВидСубъекта( Party.rec.PartyID, PTK_UNIT_INVESTMENT_FUND ) )
         FSFR = ПолучитьКодСубъекта(Party.rec.PartyID, PTCK_FSFR);
         if(FSFR != "")
            CLIENT_PF.appendChild(Create_PIF(FSFR));
         end;
      else
         innNotKPP = GetINN(Party.rec.PartyID, DL_IIF(party.rec.NotResident == UNSET_CHAR, PTCK_INN, PTCK_FOREIGN_INN));

         if((innNotKPP != null) and (innNotKPP != ""))
            if( ВидСубъекта( Party.rec.PartyID, PTK_NPF ) )
               CLIENT_PF.appendChild(Create_NPF_Save(innNotKPP));
            elif( ВидСубъекта( Party.rec.PartyID, PTK_FUNDRESERVENPF ) )
               CLIENT_PF.appendChild(Create_NPF_Reserv(innNotKPP));
            elif( ВидСубъекта( Party.rec.PartyID, PTK_PROPERTYFUNDNPF ) )
               CLIENT_PF.appendChild(Create_NPF_Ustav(innNotKPP));
            elif( ВидСубъекта( Party.rec.PartyID, PTK_PENSFOND ) )
               CLIENT_PF.appendChild(Create_PF(innNotKPP, Party.rec.PartyID));
            elif( ВидСубъекта( Party.rec.PartyID, PTK_ACCUMULATIONFUND ) )
               CLIENT_PF.appendChild(Create_HomeMilitary(innNotKPP, Party.rec.PartyID));
            end;
         else
            m_stat = 1;
            MsgBox("Для субъекта \"" + Party.rec.ShortName + "\" фонда ДУ не задан ИНН");
         end;
      end;

      return CLIENT_PF;
   end;

   private macro Create_CLIENT_INFO()
      var cmd, ds, pBuf = TRecHandler("party.dbt"), existsDU = false;
      var CLIENT_INFO = CreateNode("CLIENT_INFO");

      if( ВидСубъекта( GetClient().rec.PartyID, PTK_CLIENT ) )
         if(DL_GetMainObjAttr( GetClient(), PARTY_ATTR_GROUP_PTTYPE, OBJTYPE_PARTY ) == PARTY_ATTR_PTTYPE_TRUSTMANAGER)
            cmd = GetObjLink_cmd(OBJTYPE_PARTY, UniID(GetClient(), OBJTYPE_PARTY), OBJTYPE_PARTY, 8/*Учредитель ДУ*/);
            ds = cmd.Execute();
            while((not m_stat) and (ds.moveNext()))
               pBuf.Clear();
               if(RestoreFromUniID(ds.AttrID, pBuf, OBJTYPE_PARTY) and (pBuf.rec.PartyID > 0))
                  CLIENT_INFO.appendChild(Create_CLIENT_DU(pBuf));
                  existsDU = true;
               end;
            end;

            cmd = GetObjLink_cmd(OBJTYPE_PARTY, UniID(GetClient(), OBJTYPE_PARTY), OBJTYPE_PARTY, 9/*Фонд ДУ*/);
            ds = cmd.Execute();
            while((not m_stat) and (ds.moveNext()))
               pBuf.Clear();
               if(RestoreFromUniID(ds.AttrID, pBuf, OBJTYPE_PARTY) and (pBuf.rec.PartyID > 0))
                  CLIENT_INFO.appendChild(Create_CLIENT_PF(pBuf));
                  existsDU = true;
               end;
            end;

            if(not existsDU)
               m_stat = 1;
               MsgBox("Для доверительного управляющего \"" + GetClient().rec.ShortName + "\" не заполнены учредители и фонды ДУ.");
            end;
         else
            CLIENT_INFO.appendChild(Create_CLIENT_SIMPLE());
         end;
      end;

      return CLIENT_INFO;
   end;

   private macro Create_CLIENT()
      var CLIENT = CreateNode("CLIENT");

      CLIENT.setAttribute("ClientOperation", GetClientOperation());
      CLIENT.setAttribute("OperationId", m_DlContrMsg.rec.ID);
      CLIENT.setAttribute("LKU", LKU);
      
      if(((m_Kind == OBJTYPE_DLCONTRMSG_MARKETREG) OR (m_Kind == OBJTYPE_DLCONTRMSG_MPREG)) AND
         (GetUniClientCode() == ""))
         m_stat = 1;
         MsgBox("Для клиента \"" + GetClient().rec.ShortName + "\" на ДБО не задано значение единого краткого кода");
      end;

      if(not m_stat)
         CLIENT.appendChild(Create_CLIENT_CODE());
         if( (not m_stat) and ((m_Kind == OBJTYPE_DLCONTRMSG_MARKETREG) or (m_Kind == OBJTYPE_DLCONTRMSG_CHNGPERSDATA)) )
            CLIENT.appendChild(Create_CLIENT_INFO());
         end;
      end;

      m_MainNode = CLIENT;

   OnError(er)
      if(er.Code != 0)
         m_stat = er.Code;
      else
         m_stat = 1;
      end;
   end;

   macro Construct( DlContr, SfContr, DlContrMsg );
      m_DlContr = DlContr;
      m_SfContr = SfContr;
      m_DlContrMsg = DlContrMsg;
      m_Kind = m_DlContrMsg.rec.Kind;
      m_MainNode = null;
      CreateXML("utf-8");

      Create_CLIENT();
   end;

   initDL_XML();
   this.Construct( DlContr, SfContr, DlContrMsg );
END;

private macro _ФормФайлБиржСообщДБО(IndividualFile:Bool)
   var XMLFileName = "", DataXML = "", fileClients;

   fileClients = _TDlFileClientsXML(IndividualFile);
   DataXML = fileClients.GetDataXML();

   if(strlen(DataXML) > 0)
      XMLFileName = fileClients.SaveXml();
   end;

   return XMLFileName;
   
OnError(er)
   return "";
end;


private macro _СоздатьСообщениеДБО_ММВБ(Kind, MarketID, DlContr, SfContr)
  var stat = 0;
  var query, cmd, ds, xml_client = "", params, fullPathName = "";
  var dlcontrmsg = Tbfile("dlcontrmsg.dbt", "W", 0);

  if(not ПолучитьКодСубъекта({OurBank}, PTCK_MICEX))
    stat = 1;
    MsgBox("Для субъекта \"" + DL_GetPartyShortName({OurBank}) + "\" не задано значение кода на ММВБ");
  end;

  if(stat == 0)
    var erMsg = ПроверитьПутьДБО_ММВБ();
    if(erMsg != "")
      stat = 1;
      MsgBox(erMsg);
    end;
  end;

  if((stat == 0) and (Kind == OBJTYPE_DLCONTRMSG_CHNGPERSDATA))
    stat = DL_ОчиститьНеотправленныеСообщения(Kind, DlContr.rec.DlContrID, MarketID);
  end;

  // Создать запись о сообщении ДБО
  if(stat == 0)
    dlcontrmsg.clear();
    dlcontrmsg.rec.DlContrID = DlContr.rec.DlContrID;
    dlcontrmsg.rec.Kind = Kind;
    dlcontrmsg.rec.CreateDate = {curdate};
    dlcontrmsg.rec.CreateTime = Time();
    dlcontrmsg.rec.IsOnlineSendMes = DL_IIF(ОнлайнРегистрацияКлиентовНаБирже(), SET_CHAR, UNSET_CHAR);
    dlcontrmsg.rec.MarketID = MarketID;
    if(not dlcontrmsg.insert())
      stat = 1;
    end;
  end;

  if(stat == 0)
    // сформировать, в зависимости от вида сообщения, xml-узел CLIENT
    xml_client = _TDlClientXML(DlContr, SfContr, dlcontrmsg);
    stat = xml_client.GetStat();
  end;

  if((stat == 0) and (strlen(xml_client.GetClientXML()) > 0))
    query = " UPDATE DDLCONTRMSG_DBT SET T_XML = ? WHERE T_ID = ? ";
    params = makeArray(SQLParam("T_XML", xml_client.GetClientXML()),
                       SQLParam("T_ID", dlcontrmsg.rec.ID));
    execSQL(query, params, true);

    SQL_Execute("DELETE FROM DDLCONTRMSG_TMP");

    query = " INSERT INTO DDLCONTRMSG_TMP (T_MSGID) VALUES (?) ";
    params = makeArray(SQLParam("T_MSGID", dlcontrmsg.rec.ID));
    execSQL(query, params, true);

    fullPathName = _ФормФайлБиржСообщДБО(true);
  end;

  if((stat == 0) and (fullPathName == ""))
    stat = 1;
    MsgBox("Для клиента \"" + DL_GetPartyShortName(SfContr.rec.PartyID) + "\" не удалось сформировать файл сообщения");
  end;

  if(stat == 0)
    if(not LoadImageObj(fullPathName, OBJTYPE_BSCMSG_DL, UniID(dlcontrmsg, OBJTYPE_BSCMSG_DL), 1));
      stat = 1;
      MsgBox("К записи о сообщении не удалось прикрепить файл сообщения");
    end;
  end;

  if(stat == 0)
    if(not RemoveFile(fullPathName))
      stat = 1;
      MsgBox("Не удалось удалить файл \"" + fullPathName + "\"");
    end;
  end;

  return stat;
end;


private var ArrMes = TArray();

private macro printArrMes(dlContrMp:TRecHandler)
  if(ArrMes.size > 0)
    PrintLn("Информационные сообщения, при обработке субдоговора с кодом: " + dlContrMp.rec.MpCode + ":");

    for(var mes, ArrMes)
      PrintLn(mes);
    end;
  end;
end;

macro mmvb_msgbox(msg)
  ArrMes[ArrMes.Size] = msg;
end;

private macro SetupMsgHandler()
  ArrMes.size = 0;
  ReplaceMacro("MsgBox", "mmvb_msgbox");
end;

private macro RestoreMsgHandler()
  ReplaceMacro("MsgBox");
end;

private macro _DL_СоздатьНовоеСообщ(newMsgKind, MarketID, DlContr, SfContr, dlContrMp) :integer
  var stat:integer = 0, MpID:integer = null;

  if((dlContrMp != null) and (dlContrMp.rec.ID > 0))
    MpID = dlContrMp.rec.ID;
    stat = DL_AddDlContrGenMes(newMsgKind, MpID, MarketID);

    if(stat == 0)
      stat = _СоздатьСообщениеДБО_ММВБ(newMsgKind, MarketID, DlContr, SfContr);
    end;
    SQL_Execute("DELETE FROM DDLCONTRGENMSG_TMP");
  end;

  return stat;
end;

private macro ProcessRec(dlContr:TRecHandler, sfContr:TRecHandler, dlContrMp:TRecHandler)
  var stat:integer = 0, transactionStarted:bool = false, isSetupMsgHandler:bool = false;

  RslDefCon.BeginTrans();
  transactionStarted = true;

  SetupMsgHandler();
  isSetupMsgHandler = true;

  stat = _DL_СоздатьНовоеСообщ(OBJTYPE_DLCONTRMSG_CHNGPERSDATA, dlContrMp.rec.MarketID, dlContr, sfContr, dlContrMp);

  RestoreMsgHandler();
  isSetupMsgHandler = false;

  if(stat == 0)
    RslDefCon.CommitTrans();
  else
    RslDefCon.RollbackTrans();
  end;
  transactionStarted = false;

  if(stat != 0)
    PrintLn("Ошибка при создании сообщения по субдоговору с кодом: " + dlContrMp.rec.MpCode + ", код ДБО: " + sfContr.rec.Number + ", stat: " + stat);
  end;
  printArrMes(dlContrMp);

  return stat;
onError(er)
  if(transactionStarted)
    RslDefCon.RollbackTrans();
  end;
  if(isSetupMsgHandler)
    RestoreMsgHandler();
  end;
  return 1;
end;

private macro addmsg_legal_upd(MMVB_ID:integer)
  var stat:integer = 0, i:integer = 0,
  dlContrMp = TRecHandler("dlcontrmp.dbt"),
  dlContr = TRecHandler("dlcontr.dbt"),
  sfContr = TRecHandler("sfcontr.dbt");

  var sql = 
   " select mp.* "+
      " from ddlcontrmp_dbt mp, dsfcontr_dbt sfm, dparty_dbt p "+
     " where mp.t_SfContrId = sfm.t_Id "+
       " and mp.t_MarketId = ? "+
       " and sfm.t_DateClose = TO_DATE('01.01.0001', 'DD.MM.YYYY') "+
       " and sfm.t_ServKind = 1 "+
       " and sfm.t_ServKindSub = 8 "+
       " and p.t_PartyId = sfm.t_PartyId "+
//" AND mp.t_MpCode IN ('228484') "+
       " and p.t_LegalForm = " + PTLEGF_INST +
       " and not exists(SELECT 1 FROM dpartyown_dbt ptown WHERE ptown.t_PartyKind = "+PTK_CONFID_MANAGER+" AND ptown.t_PartyID = sfm.t_PartyId) "
       " and not exists(select 1 "+
                        " from ddlcontrmsg_dbt m "+
                       " where m.t_DlContrId = mp.t_DlContrId "+
                         " and m.t_MarketId = mp.t_MarketId "+
                         " and m.t_Kind = 7) ";

  var cmd = DL_RSDCommand(sql);
  cmd.addParam(MMVB_ID);

  InitProgress(cmd.GetCount(), "Обработка субдоговоров", "Обработка субдоговоров");

  var ds = cmd.Execute();
  while(ds.moveNext() and (stat == 0))
    ds.GetRecord().CopyTo(dlContrMp.rec);

    if(DL_GetRecHandler(dlContr, "SELECT DLCONTR.* FROM DDLCONTR_DBT DLCONTR WHERE DLCONTR.T_DLCONTRID = ?", dlContrMp.rec.DlContrID))
      if(DL_GetRecHandler(sfContr, "SELECT SFCONTR.* FROM DSFCONTR_DBT SFCONTR WHERE SFCONTR.T_ID = ?", dlcontr.rec.SfContrID))
        ProcessRec(dlContr, sfContr, dlContrMp);
      end;
    end;

    i = i + 1;
    UseProgress(i);
  end;
  RemProgress();
end;



private macro GetAMQPMOEXClientParams(host_:@string, vhost_:@string, user_:@string, password_:@string, port_:@integer, queue_:@string):integer
  var stat:integer = 0;
  var host, vhost, user, password, port, queue;

  GetRegistryValue("SECUR\\AMQPMOEXCLIENT\\HOST", V_STRING, host, stat);
  if(stat) return 1; end;

  GetRegistryValue("SECUR\\AMQPMOEXCLIENT\\VHOST", V_STRING, vhost, stat);
  if(stat) return 1; end;

  GetRegistryValue("SECUR\\AMQPMOEXCLIENT\\USER", V_STRING, user, stat);
  if(stat) return 1; end;

  GetRegistryValue("SECUR\\AMQPMOEXCLIENT\\PASSWORD", V_STRING, password, stat);
  if(stat) return 1; end;

  GetRegistryValue("SECUR\\AMQPMOEXCLIENT\\QUEUE", V_STRING, queue, stat);
  if(stat) return 1; end;

  GetRegistryValue("SECUR\\AMQPMOEXCLIENT\\PORT", V_INTEGER, port, stat);
  if(stat) return 1; end;

  host_ = host;
  vhost_ = vhost;
  user_ = user;
  password_ = password;
  port_ = port;
  queue_ = queue;  

  return 0;
end;

private macro GetErrDescr(er:variant) :string
  var errStr = "", i = 0;

  if(IsEqClass("TrslError", er))
    errStr = er.module + " "+er.line + " " + er.message;

    if(IsEqClass("TDbError", er.err))
      errStr = errStr + "\n:|" + er.err.Stat + "-" + er.err.Oper + "-" + er.err.Table + "-" + er.err.Message;

    elif(isEqClass("TRsdError", er.err))
      while(i < er.err.environment.ErrorCount)
        errStr = errStr + "\n" + er.err.environment.Error(i).Descr;
        i = i + 1;
      end;
    end;
  end;

  return errStr;
end;

var MQClient;
private macro CreateMQClient()
  var host, vhost, user, password, port, queue;
  if(GetAMQPMOEXClientParams(@host, @vhost, @user, @password, @port, @queue) == 0)
    MQClient = AMQPMOEXClient(host, vhost, user, password, port, queue);
    return 0;
  else
    return 1;
  end;
onError(er)
  return 1;
end;

private macro AddMesToMQ(partyID, dlContrID, dlContrMsgID, dataXML:@string, errMsg:@string)
  MQClient.publish(string(partyID), string(dlContrID), string(dlContrMsgID), dataXML);
  return 0;
onError(er)
  errMsg = GetErrDescr(er);
  return 1;
end;

private macro ТипСообщения(kind)
  if(kind == OBJTYPE_DLCONTRMSG_MARKETREG)
     return "Регистрация клиента на бирже";
  elif(kind == OBJTYPE_DLCONTRMSG_MPREG)
     return "Регистрация клиента на биржевой площадке";
  elif(kind == OBJTYPE_DLCONTRMSG_MPCLOSE)
     return "Закрытие биржевой площадки";
  elif(kind == OBJTYPE_DLCONTRMSG_MARKETCLOSE)
     return "Закрытие ДБО";
  elif(kind == OBJTYPE_DLCONTRMSG_CHNGPERSDATA)
     return "Изменение информации о личных данных клиента";
  else
    return string(kind);
  end;
end;

private macro _ДобавитьСообщВОчередьОтправки(PartyID, dlContrMsg, dataXML:@string, errMsg:@string)
  var stat = 0, statAddToMQ = 0, versionNew:integer = dlContrMsg.rec.Version;
  var sendMesState = DL_IIF(dlContrMsg.rec.SendMesState == 0, DLSENDMESSTATE_INQUEUE, DLSENDMESSTATE_REPEATINQUEUE);
  var transactionStarted:bool = false;

  RslDefCon.BeginTrans();
  transactionStarted = true;

  var DlContrMsgToUpd = TBFile("dlcontrmsg.dbt", "W", 0);
  DlContrMsgToUpd.rec.ID = dlContrMsg.rec.ID;

  if(DlContrMsgToUpd.GetEQ() and
     (DlContrMsgToUpd.rec.Version == dlContrMsg.rec.Version) and 
     (DlContrMsgToUpd.rec.SendMesState != DLSENDMESSTATE_SUCCESS))

    if(DlContrMsgToUpd.rec.SendMesState != sendMesState)
      DlContrMsgToUpd.rec.SendMesState = sendMesState;
      if(not DlContrMsgToUpd.Update())
        stat = 1;
        ErrMsg = "Не удалось обновить сообщение с DlContrMsgID=" + dlContrMsg.rec.ID + ", выставив на нем статус=" + sendMesState;
      end;
      if(not DlContrMsgToUpd.GetEQ())
        stat = 1;
        ErrMsg = "Не удалось получить обновленное состояние сообщения с DlContrMsgID=" + dlContrMsg.rec.ID;
      end;
      versionNew = versionNew + 1;
    end;

    if(stat == 0)
      if(DlContrMsgToUpd.rec.Version != versionNew) // запись уже где-то изменилась
        stat = 1;
        ErrMsg = "У обновленного сообщения отличается Version. Вероятно оно конкурентно изменено. Сообщение с DlContrMsgID=" + dlContrMsg.rec.ID;
      end;
    end;

    if(stat == 0)
      var erMsgMQ = "";
      statAddToMQ = AddMesToMQ(PartyID, dlContrMsg.rec.DlContrID, dlContrMsg.rec.ID, @dataXML, @erMsgMQ);
      if(statAddToMQ != 0)
        DlContrMsgToUpd.rec.SendMesState = DLSENDMESSTATE_ER_ADDINQUEUE;
        ErrMsg = erMsgMQ;

        if(not DlContrMsgToUpd.Update())
          stat = 1;
          ErrMsg = "Не удалось добавить сообщение в очередь. Сообщение с DlContrMsgID=" + dlContrMsg.rec.ID + "; " + erMsgMQ;
        end;
      end;
    end;
  end;

  if(stat == 0)
    RslDefCon.CommitTrans();
  else
    RslDefCon.RollbackTrans();
  end;
  transactionStarted = false;

  if((stat == 0) and (statAddToMQ != 0))
    stat = statAddToMQ;
  end;

  return stat;
OnError(er)
  if(transactionStarted)
    RslDefCon.RollbackTrans();
  end;
  ErrMsg = GetErrDescr(er);
  return 1;
end;

private macro AddMsgToMQ(MMVB_ID:integer)
  var stat = 0, dataXML = "", find = false, i=0, ErrMsg = "";
  var dlContrMsg = TRecHandler("dlcontrmsg.dbt"),
      dlContr = TRecHandler("dlcontr.dbt"), 
      sfContr = TRecHandler("sfcontr.dbt");

  if(CreateMQClient() == 0)
    var sql = "select m.* "+
               " from ddlcontrmsg_dbt m "+
              " where m.t_MarketId = ? "+
                " and m.t_Kind = 7 "+
                " and m.t_SendMesState = 0 "+
                " and m.t_IsOnlineSendMes = 'X' "+
                " and m.t_DlContrId IN (select mp.t_DlContrId "+
                                        " from ddlcontrmp_dbt mp, dsfcontr_dbt sfm, dparty_dbt p "+
                                       " where mp.t_SfContrId = sfm.t_Id "+
                                         " and mp.t_MarketId = m.t_MarketId "+
                                         " and sfm.t_DateClose = TO_DATE('01.01.0001', 'DD.MM.YYYY') "+
                                         " and sfm.t_ServKind = 1 "+
                                         " and sfm.t_ServKindSub = 8 "+
                                         " and p.t_PartyId = sfm.t_PartyId "+
                                         " and p.t_LegalForm = " +PTLEGF_INST +
//" AND mp.t_MpCode IN ('228484') "+
                                         " and not exists(SELECT 1 FROM dpartyown_dbt ptown WHERE ptown.t_PartyKind = "+PTK_CONFID_MANAGER+" AND ptown.t_PartyID = sfm.t_PartyId) "
                                      ")";

    var cmd = DL_RSDCommand(sql);
    cmd.addParam(MMVB_ID);

    InitProgress(cmd.GetCount(), "Добавление сообщений в очередь отправки", "Добавление сообщений в очередь отправки");

  [
                          Добавление сообщений в очередь отправки 
                                  за ########## г.
   ┌──────────────────────────────┬───────────────────────┬───────────────────────────────┬──────┬────────────────────────────────────────────────────────────┐
   │           Код ДБО            │ Наименование клиента  │         Тип сообщения         │ stat │                         Msg                                │
  ]
     ({CurDate});

    var ds = cmd.Execute();
    while(ds.moveNext())
      find = true;
      dlContrMsg.clear();
      ds.GetRecord().CopyTo(dlContrMsg.rec);

      if(DL_GetRecHandler(dlContr, "SELECT * FROM DDLCONTR_DBT WHERE T_DLCONTRID = "+dlContrMsg.rec.DlContrID) and
         DL_GetRecHandler(sfContr, "SELECT * FROM DSFCONTR_DBT WHERE T_ID = "+dlContr.rec.SfContrID)
        )
        dataXML = DL_GetDlContrMsgXml(dlContrMsg.rec.ID);
        if(strlen(dataXML) > 0)
          stat = _ДобавитьСообщВОчередьОтправки(sfContr.rec.PartyID, dlContrMsg, @dataXML, @ErrMsg);
        else
          stat = 1;
          ErrMsg = "Отсутствует тело xml-сообщения.";
        end;

  [├──────────────────────────────┼───────────────────────┼───────────────────────────────┼──────┼────────────────────────────────────────────────────────────┤
   │##############################│#######################│###############################│######│############################################################│]
           ( sfContr.rec.Number:w,
             DL_GetPartyShortName(sfContr.rec.PartyID):w,
             ТипСообщения(dlContrMsg.rec.Kind):w,
             string(stat):w,
             ErrMsg:w );

      end;
      i = i + 1;
      UseProgress(i);
    end;
  [└──────────────────────────────┴───────────────────────┴───────────────────────────────┴──────┴────────────────────────────────────────────────────────────┘];
    RemProgress();
    if(not find)
      [Нет сообщений для добавления в очередь.];
    end;
    
  else
    MsgBox("Ошибка при создании клиента подключения к очереди");
  end;
end;

private macro GetMarketId():integer
  var stat:integer = 0, MMVB_ID:integer = 0, i:integer = 0,
  MMVB_Code:string = "",
  dlContrMp = TRecHandler("dlcontrmp.dbt"),
  dlContr = TRecHandler("dlcontr.dbt"),
  sfContr = TRecHandler("sfcontr.dbt");

  GetRegistryValue("SECUR\\MICEX_CODE", V_STRING, MMVB_Code, stat);
  if(stat != 0)
    msgbox("Ошибка при получении значения настройки SECUR\\MICEX_CODE");
    return 0;
  elif(MMVB_Code == "")
    msgbox("Не задано значение настройки SECUR\\MICEX_CODE");
    return 0;
  else
    MMVB_ID = GetCodeParty(MMVB_Code, PTCK_CONTR);
  end;
  
  return MMVB_ID;
end;

private macro callFunc()
  var MMVB_ID:integer = GetMarketId();

  if(MMVB_ID > 0)
    addmsg_legal_upd(MMVB_ID);
    AddMsgToMQ(MMVB_ID);
  end;
end;

callFunc();
