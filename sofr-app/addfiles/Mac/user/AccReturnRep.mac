//shev 29.08.2019 отчет о загруженных проводках по возврату денежных средств
import "spRepFun.mac", "dlcontrfunc.mac", "nptxmfns_report.mac";

import Nptxmfns_form;
import rsbformsinter;
private const FT_DATE = 9;

    Macro Report_out(BegDate, EndDate, onOk, onErr)
    var Rep;
    var sheet = 1;
    var errorcount = 0;
    var period;
    
    Rep = CMakeReport("┌┬┬┬┬┬┬┬┬┬┬┬┬┐");
    Rep.SetDefaultFontName("Times New Roman");
    Rep.SetDefaultFontSize(12);
    Rep.SetFlagShowGrid(true);
    Rep.AddPrintCell("" , 16.12,1, "c:ex_FS(b):ex_B()");
    Rep.AddPrintCell("Журнал учета проводок возврата денежных средств с биржи за период " , 55, null, "c:ex_FS(b):ex_B()");
    
    Rep.AddPrintCell(date(begdate), 8, null, "c:ex_FS(b):ex_B()");
    Rep.AddPrintCell("-", 1, null, "c:ex_FS(b):ex_B()");
    Rep.AddPrintCell(date(enddate), 8, null, "c:ex_FS(b):ex_B()");
    Rep.AddStr();
    
    var sql;
    
       if (onOk)         
          Rep.AddPrintCell("Загруженные проводки" , 1000, null, "c:ex_FS(b):ex_B()");
          Rep.AddStr();
          sql = ExecSqlSelect("select t_pmid,t_valuedate, t_payeraccount, t_receiveraccount, t_amount,t_ground,decode(t_errcode,0,'OK'), t_errtext  from upminsofrlog_dbt where substr(t_receiveraccount,1,5) = '30424' and t_errcode = 0 and t_valuedate between :begdate and :enddate ",
                        MakeArray(SqlParam("begdate", BegDate),SqlParam("enddate", EndDate)));
   
          if (sql.movenext())
             Rep.AddPrintCell("Ид проводки" , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell("Дата проводки" , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell("Счет плательщика" , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell("Счет получателя" , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell("Сумма (руб)" , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell("Основание" , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell("Статус" , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell("Текст ошибки" , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddStr();
             Rep.AddPrintCell(sql.value(0) , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell(sql.value(1) , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell(sql.value(2) , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell(sql.value(3) , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell(sql.value(4) , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell(sql.value(5) , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell(sql.value(6) , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell(sql.value(7) , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddStr();
             while (sql.movenext())
                Rep.AddPrintCell(sql.value(0) , 16, null, "c:ex_FS(b):ex_B()");
                Rep.AddPrintCell(sql.value(1) , 16, null, "c:ex_FS(b):ex_B()");
                Rep.AddPrintCell(sql.value(2) , 16, null, "c:ex_FS(b):ex_B()");
                Rep.AddPrintCell(sql.value(3) , 16, null, "c:ex_FS(b):ex_B()");
                Rep.AddPrintCell(sql.value(4) , 16, null, "c:ex_FS(b):ex_B()");
                Rep.AddPrintCell(sql.value(5) , 16, null, "c:ex_FS(b):ex_B()");
                Rep.AddPrintCell(sql.value(6) , 16, null, "c:ex_FS(b):ex_B()");
                Rep.AddPrintCell(sql.value(7) , 16, null, "c:ex_FS(b):ex_B()");
                Rep.AddStr();
             end;
          else
             Rep.AddPrintCell("За указанный период не найдено проводок" , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddStr();
          end;
          sql = null;

       end;

       if (onErr)

          Rep.AddPrintCell("" , 200, null, "c:ex_FS(b):ex_B()");
          Rep.AddStr();
          Rep.AddPrintCell("" , 200, null, "c:ex_FS(b):ex_B()");
          Rep.AddStr();
          Rep.AddPrintCell("" , 200, null, "c:ex_FS(b):ex_B()");
          Rep.AddStr();
          Rep.AddPrintCell("" , 200, null, "c:ex_FS(b):ex_B()");
          Rep.AddStr();
          Rep.SetDefaultFontSize(18);

          Rep.AddPrintCell("Не загруженные проводки" , 150, null, "c:ex_FS(b):ex_B()");
          Rep.AddStr();
          sql = ExecSqlSelect("select t_pmid,t_valuedate, t_payeraccount, t_receiveraccount, t_amount,t_ground,'ERRORE', t_errtext  from upminsofrlog_dbt where substr(t_receiveraccount,1,5) = '30424'and t_errcode != 0 and t_valuedate between :begdate and :enddate ",
                        MakeArray(SqlParam("begdate", BegDate),SqlParam("enddate", EndDate)));
   
          if (sql.movenext())
             Rep.AddPrintCell("Ид проводки" , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell("Дата проводки" , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell("Счет плательщика" , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell("Счет получателя" , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell("Сумма (руб)" , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell("Основание" , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell("Статус" , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell("Текст ошибки" , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddStr();
             Rep.AddPrintCell(sql.value(0) , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell(sql.value(1) , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell(sql.value(2) , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell(sql.value(3) , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell(sql.value(4) , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell(sql.value(5) , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell(sql.value(6) , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddPrintCell(sql.value(7) , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddStr();
             while (sql.movenext())
                Rep.AddPrintCell(sql.value(0) , 16, null, "c:ex_FS(b):ex_B()");
                Rep.AddPrintCell(sql.value(1) , 16, null, "c:ex_FS(b):ex_B()");
                Rep.AddPrintCell(sql.value(2) , 16, null, "c:ex_FS(b):ex_B()");
                Rep.AddPrintCell(sql.value(3) , 16, null, "c:ex_FS(b):ex_B()");
                Rep.AddPrintCell(sql.value(4) , 16, null, "c:ex_FS(b):ex_B()");
                Rep.AddPrintCell(sql.value(5) , 16, null, "c:ex_FS(b):ex_B()");
                Rep.AddPrintCell(sql.value(6) , 16, null, "c:ex_FS(b):ex_B()");
                Rep.AddPrintCell(sql.value(7) , 16, null, "c:ex_FS(b):ex_B()");
                Rep.AddStr();
             end;
          else
             Rep.AddPrintCell("За указанный период не загруженных проводок не найдено" , 16, null, "c:ex_FS(b):ex_B()");
             Rep.AddStr();
          end;
          sql = null;

       end;

      /*Запуск Excel*/
     Rep.PrintWinRep("Сделки ПФИ");
     Rep.SetZoomType(ZOOM_TYPE_A4L); /*альбомная ориентация*/
     Rep.SetWinRepOutput();
     Rep.ShowWinRep();

    end;


class (TRsbPanel) RepZero

    InitTRsbPanel();
    setSize(25,10);
    setPosition(35,15);

    var DateBeg = {curdate};
    var DateEnd = {curdate};
    var OnOk, OnErr;
    var stat = 0;

    this.Status("F3 - выбор даты F2,F9 - выполнить");
    this.Caption("Формирование сводного поручения");

    addLabel(TRsbLabel(3, 1, "Период :"));
    var m_DateBeg:TRsbEditField = TRsbEditField(FT_DATE);
    m_DateBeg.setPosition(10,2);
    m_DateBeg.setSize(10,1);
    m_DateBeg.value = {curdate};
    m_DateBeg.enabled = true;
    m_DateBeg.Name = "DateBeg";
    addControl(m_DateBeg);

    var m_DateEnd:TRsbEditField = TRsbEditField(FT_DATE);
    m_DateEnd.setPosition(10,3);
    m_DateEnd.setSize(10,1);
    m_DateEnd.value = {curdate};
    m_DateEnd.Name = "DateEnd";
    addControl(m_DateEnd);
    var m_onOk:TRsbCheckBox = TRsbCheckBox;
    m_onOk.setPosition(3,5);
    m_onOk.name = "Загруженные проводки";
    m_onOk.checked = true;
    m_onOk.onChecked(R2M(this, "OnChecked"));

    addControl(m_onOk);
    var m_Label3:TRsbLabel = TRsbLabel(7, 5, "Загруженные проводки");
    addLabel(m_Label3);

    var m_onErr:TRsbCheckBox = TRsbCheckBox;
    m_onErr.setPosition(3,6);
    m_onErr.name = "Не загруженные проводки";
    m_onErr.checked = true;
    m_onErr.onChecked(R2M(this, "OnChecked"));

    addControl(m_onErr);
    var m_Label4:TRsbLabel = TRsbLabel(7, 6, "Не загруженные проводки");
    addLabel(m_Label4);


    m_DateBeg.addEventHandler(RSB_EV_KEY_PRESSED , R2M(this, "DATE_KEY_PRESSED"));
    m_DateEnd.addEventHandler(RSB_EV_KEY_PRESSED , R2M(this, "DATE_KEY_PRESSED"));
    addEventHandler(RSB_EV_KEY_PRESSED , R2M(this, "Panel_ButtonEvent"));


   macro OnChecked(RsbEvent:Object)
     if (RsbEvent.Id == RSB_EV_CONTROL_CHECKED)
     end;
    return true;
   end;



    macro Panel_ButtonEvent(RsbEvent)
       if((RsbEvent.keyCode == 316) or (RsbEvent.keyCode == 323))/*F2 F9*/
           stat = 0;
           DateBeg = m_DateBeg.Value;
           DateEnd = m_DateEnd.Value;
           onErr = m_onErr.checked;
           onOk = m_onOk.checked;
           Report_out(DateBeg, DateEnd, onOk, onErr);
           this.close(1);
       elif(RsbEvent.keyCode == 27) /**/
           stat = 1;
       end;
    end;

    macro DATE_KEY_PRESSED(RsbEvent)
       if(RsbEvent.keyCode == 317)
           RsbEvent.Source.value = GetDateByCalendar(RsbEvent.Source.value);
       end;
    end;

end;

var myPanel:TRsbPanel = RepZero;
myPanel.run;



























