import sfinter, RsbDataSet, rsd, sp_car, activex, or_rep_h;
var cmd, sql, stat, BegDate = {curdate}, NewTarifId;
//Private const NewTarif = "Инвестор";
Private const OldTarif = "Базовый";                    //Старый тариф
var OldTarifId;
import RsbFormsInter;

var NEwTPName = "";
var dateBegin;
var NewTarif;

PRIVATE MACRO AddCol (ar,ind, fld, head, width, rdonly, ty, dp)
   ar.value (ind * 6)     = fld;
   ar.value (ind * 6 + 1) = head;
   ar.value (ind * 6 + 2) = width;
   ar.value (ind * 6 + 3 ) = rdonly;   // fldType
   ar.value (ind * 6 + 4 ) = dp;//   decPoint
   ar.value (ind * 6 + 5 ) = 0;   // reserv
END;

  PRIVATE MACRO ClearTempTable()
     execSQL("BEGIN EXECUTE IMMEDIATE 'create global temporary table U_COM_DBO_CHANGE_DBT (t_objtype number, t_sfcontrid number) ON COMMIT PRESERVE ROWS NOCACHE'; EXCEPTION WHEN OTHERS THEN NULL; END;");
     execSQL("TRUNCATE TABLE U_COM_DBO_CHANGE_DBT;");
  END;

  PRIVATE MACRO DropTempTable()
     execSQL("BEGIN EXECUTE IMMEDIATE 'drop table U_COM_DBO_CHANGE_DBT'; EXCEPTION WHEN OTHERS THEN NULL; END;");
  END;

  PRIVATE MACRO LoadDlContrList
    var FullNameFile = "", file_xlsx, FileName,ExtName,DirName, Sheet, range, i = 1, j = 1, cnt = 0, DBO_NUM = "", number = "", InputDir = "";
    var cmd;

    InputDir = "..\\Import\\";
    if(not SelectFile(FullNameFile, InputDir + "DBOChangeTP_*.xls*", "Выберите файл для загрузки", 0, true))
      MsgBox("Отказ от загрузки");
      return false;
    else
       
       splitfile(FullNameFile, FileName, ExtName);
       FileName = FileName + ExtName;
       DirName = substr(FullNameFile, 1, index(FullNameFile, FileName) - 1);

//       file_xlsx = CDAOMSExcel(fname);
       if(not OpenExcelFile(FileName, false, true, DirName))
         MsgBox("Ошибка открытия файла \"" + FullNameFile + "\"");
     //    EndAction(1);
         return false;
       end;
       BegAction(0, "Ждите. Идет загрузка списка договоров....");
       j = 1;
       while(j <= ExcelApplication.Sheets.Count)

          Sheet = ExcelApplication.Sheets(j);
          i = 1;
          var err_dbo = false, err_do = false;
          while (ValType(Sheet.Cells(i, 1).Value) != V_UNDEF)
            err_dbo = false; err_do = false;
            DBO_NUM = string(Sheet.Cells(i, 1).Value:0:0);

            var sql_1 = "select '207' as t_objtype, sfc.t_id as sfc_id, sfc.t_number, sfplan.t_id as sfplan_id, \n"+
                        "                                                   sfplan.t_begin, \n"+
                        "                                                   sfplan.t_end     \n"+
                        "  from dsfcontr_dbt sfc left join dsfcontrplan_dbt sfplan on sfplan.t_sfcontrid = sfc.t_id and sfplan.t_end =to_date('01010001','ddmmyyyy')\n"+
                        " where sfc.t_number = ?\n"+
                        "   and sfc.t_servkind = 0 and sfc.T_DATECLOSE =  to_date('01010001','ddmmyyyy')\n";
            var cmd_1 = RSDCommand(sql_1);
                cmd_1.AddParam("", rsdbp_in, DBO_NUM);
            var rs_1 = RSDRecordset(cmd_1,1,1);
            if (rs_1.movenext)
              if (rs_1.value("sfplan_id") == NewTarif )
                println("Для ДБО " + DBO_NUM + "уже установлен необходимый ТП c " + rs_1.value("t_begin")); 
//                continue;
                err_dbo = true;
              end;
              if (rs_1.value("t_begin") > DateBegin-1 )
                println("Для ДБО " + DBO_NUM + "найден установленный равной или более поздней датой ТП c датой установки " + rs_1.value("t_begin")); 
                err_dbo = true;
              end;
           	if (not err_dbo)
           		cmd = RsdCommand("BEGIN "
                          		+ " INSERT INTO U_COM_DBO_CHANGE_DBT ( T_objtype, t_sfcontrid) values(?,?); "
                          		+ "END; ");
		
		
            		cmd.AddParam("", RSDBP_IN, rs_1.value("t_objtype"));
            		cmd.AddParam("", RSDBP_IN, rs_1.value("sfc_id"));
            		cmd.Execute();
              	println("ДБО " + DBO_NUM + "  добавлен в очередь обработки");
           	end;
              var sql_2 = String( 	"select '209' as t_objtype, sfc_s.t_id  as sfc_id, sfc_s.t_number, sfplan.t_id as sfplan_id,   \n"
              				,"                                                   sfplan.t_begin,   \n"
              				,"                                                   sfplan.t_end   \n"
              				,"  from dsfcontr_dbt sfc, ddlcontr_dbt dlc, ddlcontrmp_dbt mp, dsfcontr_dbt sfc_s left join dsfcontrplan_dbt sfplan on sfplan.t_sfcontrid = sfc_s.t_id and sfplan.t_end =to_date('01010001','ddmmyyyy')   \n"
              				," where sfc.t_number = ?   \n"
              				,"   and sfc.t_servkind = 0   \n"
              				,"   and dlc.t_sfcontrid = sfc.t_id   \n"
              				,"   and mp.t_dlcontrid = dlc.t_dlcontrid   \n"
              				,"   and sfc_s.t_id = mp.t_sfcontrid  and sfc_s.T_DATECLOSE =  to_date('01010001','ddmmyyyy') \n"        				);
            		var cmd_2 = RSDCommand(sql_2);
                	    cmd_2.AddParam("", rsdbp_in, DBO_NUM);
            		var rs_2 = RSDRecordset(cmd_2,1,1);
            		while (rs_2.movenext)
                        err_do = false;
              		if (rs_2.value("sfplan_id") == NewTarif )
                	       println("Для ДО " + rs_2.value("t_number") + "уже установлен необходимый ТП c " + rs_2.value("t_begin")); 
		//                continue;
                		err_do = true;
              		end;
              		if (rs_2.value("t_begin") > DateBegin-1 )
                		println("Для ДО " + rs_2.value("t_number") + "найден установленный более поздней датой ТП c датой установки " + rs_2.value("t_begin")); 
                		err_do = true;
              		end;
           			if (not err_do)
           				cmd = RsdCommand("BEGIN "
                          				+ " INSERT INTO U_COM_DBO_CHANGE_DBT ( T_objtype, t_sfcontrid) values(?,?); "
                          				+ "END; ");
				
				
            				cmd.AddParam("", RSDBP_IN, rs_2.value("t_objtype"));
            				cmd.AddParam("", RSDBP_IN, rs_2.value("sfc_id"));
            				cmd.Execute();
              			println("ДО " +  rs_2.value("t_number") + "  добавлен в очередь обработки");
           			end;
		
//                       else
//                         println("Для ДБО +" + DBO_NUM + " не найдены субдоговора для обработки");
                       end;

		

				
	
            else
              println("Не найден ДБО " + DBO_NUM); 
            end;
                        

            i = i + 1;
          end;
          j = j+1;
       end;
      EndAction(0);
      execSQL("COMMIT;");

    end;
    return true;

  OnError(_err)
    msgbox("Загрузка списка договоров из файла \"" + FullNameFile + "\" не выполнена " );
    return false;
  END;



Macro MassChngTariffExec()


   cmd = TrsbDataSet(" select * from dsfplan_dbt where UPPER(t_name) = UPPER('" + NEwTPName + "') ");
   if(cmd.movenext())
      NewTarifId = cmd.sfplanid;
   else
      MsgBox("Не удалось определить ID тарифа но наименованию " + NEwTPName);
      exit(1);
   end;

   ClearTempTable();

   If(GetTrue(false, "Загрузить список догворов для смены тарифного плана?"));
      If (not LoadDlContrList) 
         exit(1);
      end;
   end;
   sql = " DECLARE "
       + "   v_FuncobjID dfuncobj_dbt.t_ID%TYPE; "   
       + " BEGIN "
       + "   DELETE FROM ddl_differentid_tmp; "         
       + "   for c in (select t_objtype as t_kind, t_sfcontrid as t_id from U_COM_DBO_CHANGE_DBT)  loop "
       + "     INSERT INTO dfuncobj_dbt (t_ObjectType, t_ObjectID, t_FuncID, t_Param, t_Priority, t_Oper) "
       + "                       VALUES (c.t_Kind, c.t_ID, 7777,   to_char(c.t_ID)||';'||to_char(?)||';'|| to_char(?, 'DD.MM.YYYY'), 55, ?) " 
       + "     RETURNING t_ID INTO v_FuncobjID; "
       + "     INSERT INTO ddl_differentid_tmp (t_ID) VALUES (v_FuncobjID); "
       + "   END LOOP; "   
       + " END; ";
  
   cmd = RSDCommand(sql);
   cmd.addParam("", RSDBP_IN, NewTarifId);
   cmd.addParam("", RSDBP_IN, dateBegin);
   cmd.addParam("", RSDBP_IN, {oper});
   cmd.execute();
   
   Println("Время старта: " + Time()) ;
   var sqlCnt = DL_RSDCommand(" select 1 from ddl_differentid_tmp "); 
   var cnt = sqlCnt.GetCount();
   var ds;
   var i = 0;    
   var SLEEP_TIME_MS = 15000; //Время в мс, которое выжидаем, прежде чем снова проверять результаты выполнения задач - 15 секунд    
   var MIN_EXEC_COUNT = 3; //Минимальное количество повторных выполнений каждой из ошибочных записей, прежде чем выводить по ним отчёт 

   var isNotFinished:bool = true;
   var MAX_FUNCOBJ_ITERATION = 2880; //количество повторов с задержкой в 15 сек, ориентировочно 12 часов 
   InitProgress(cnt, "Перебор ДБО для смены Тарифного плана", "Перебор ДБО для смены Тарифного плана");

   while( isNotFinished /*and (i < MAX_FUNCOBJ_ITERATION)*/ )
     RslWait(SLEEP_TIME_MS); 
     cmd = DL_RSDCommand("SELECT count(1) cnt " + 
                         "  FROM ddl_differentid_tmp t, dfuncobj_dbt funcobj " +
                         " WHERE funcobj.t_ID = t.t_ID " +
                         "   AND NOT (funcobj.t_State IN(1) AND funcobj.t_ExecCount >= "+MIN_EXEC_COUNT+") "
                         "   AND funcobj.t_State not in(3, 2)"
                        );
     ds = cmd.Execute();

     if( ds.MoveNext())
       if(int(ds.cnt) == 0) 
         isNotFinished = false;
       end;
       UseProgress(cnt - int(ds.cnt));
     end;

     i = i + 1;
   end;

   if( isNotFinished )
      //Остановим все задачи, еще не завершившие выполнение
      cmd = RSDCommand("UPDATE dfuncobj_dbt " + 
                       "   SET t_State = 3 , " +
                       "       t_ErrorText = case when t_ErrorText is null then 'Превышено время ожидания funcobj!' else t_ErrorText end " +
                       " WHERE t_ID IN (SELECT t_ID FROM ddl_differentid_tmp)"
                      );
      cmd.Execute();
   else
      //Остановим очередные итерации для ошибочных записей, сменив их статус
      cmd = RSDCommand("UPDATE dfuncobj_dbt " + 
                       "   SET t_State = 3" +
                       " WHERE t_State IN(1,2) "+
                       "   AND t_ID IN (SELECT t_ID FROM ddl_differentid_tmp)"
                      );
      cmd.Execute();
   end;
   RemProgress();

   //Формируем протокол
   InitProgress(cnt, "Печать протокола", "Печать протокола");

   //Успешно обновленные ДБО/субдог.
   cmd = DL_RSDCommand("SELECT sf.t_number t_number " + 
                       "  FROM ddl_differentid_tmp t, dfuncobj_hist_dbt hist,  dsfcontr_dbt sf " +
                       " WHERE hist.t_FuncobjID = t.t_ID " +
                       "   AND hist.t_ObjectType = 207"  +
                       "   AND NOT EXISTS (SELECT 1 " +
                       "                     FROM dfuncobj_dbt funcobj " + 
                       "                    WHERE funcobj.t_ID = t.t_ID AND t_ObjectType = 207) " +
                       "   AND sf.t_ID =  hist.t_ObjectID" 
                      );
   ds = cmd.Execute();
   while( ds.MoveNext() )
      Println("Успешно установлен тариф для ДБО "+ ds.number );
   end;

   cmd = DL_RSDCommand("SELECT sf.t_number t_number " + 
                       "  FROM ddl_differentid_tmp t, dfuncobj_hist_dbt hist,  dsfcontr_dbt sf " +
                       " WHERE hist.t_FuncobjID = t.t_ID " +
                       "   AND hist.t_ObjectType = 209"  +
                       "   AND NOT EXISTS (SELECT 1 " +
                       "                     FROM dfuncobj_dbt funcobj " + 
                       "                    WHERE funcobj.t_ID = t.t_ID AND t_ObjectType = 209) " +
                       "   AND sf.t_ID =  hist.t_ObjectID" 
                      );
   ds = cmd.Execute();
   while( ds.MoveNext() )
      Println("Успешно установлен тариф для субдоговора "+ ds.number );
   end;

   //Необновленные ДБО/субдог.
   cmd = DL_RSDCommand("SELECT sf.t_number t_number, NVL(funcobj.t_ErrorCode, 0) t_ErrorCode, NVL(funcobj.t_ErrorText, chr(1)) t_ErrorText " + 
                       "  FROM ddl_differentid_tmp t, dfuncobj_dbt funcobj,  dsfcontr_dbt sf " +
                       " WHERE funcobj.t_ID = t.t_ID " +
                       "   AND funcobj.t_State = 3" +       
                       "   AND sf.t_ID =  funcobj.t_ObjectID "
                       "   AND funcobj.t_ObjectType = 207"
                      );
   ds = cmd.Execute();
   while( ds.MoveNext() )
      Println("Ошибка установки нового ТП для ДБО "+ ds.number + iif(ds.ErrorCode > 0, "Код ошибки "+string(ds.ErrorCode)+". ", "") +" "+ ds.ErrorText );
   end;

   cmd = DL_RSDCommand("SELECT sf.t_number t_number, NVL(funcobj.t_ErrorCode, 0) t_ErrorCode, NVL(funcobj.t_ErrorText, chr(1)) t_ErrorText " + 
                       "  FROM ddl_differentid_tmp t, dfuncobj_dbt funcobj,  dsfcontr_dbt sf " +
                       " WHERE funcobj.t_ID = t.t_ID " +
                       "   AND funcobj.t_State = 3" +       
                       "   AND sf.t_ID =  funcobj.t_ObjectID "
                       "   AND funcobj.t_ObjectType = 209"
                      );
   ds = cmd.Execute();
   while( ds.MoveNext() )
      Println("Ошибка установки нового ТП для субдоговора "+ ds.number + iif(ds.ErrorCode > 0, "Код ошибки "+string(ds.ErrorCode)+". ", "") +" "+ ds.ErrorText );
   end;
   RemProgress();
   Println("Время Окончания: " + Time()) ;

   ClearTempTable
End;


private class ProcParams()
    var dateBegin:date;
    var NewTarif = "";
end;

CLASS (tRsbPanel) pnl_ChangeTP ()
  private const FT_STRING = 7;
  private const FT_DATE = 9;

  const K_Enter = 13;
  const K_F3    = 317;
  const K_F2    = 316;
  const K_Alt_F3= 362;

  var curstr = 0;
  InitTRSBPanel();
  Caption = "Параметры выполнения операции";
  Status  = "~ESC~Выход  ~F2~Выполнить ~F3 Выбрать тариф";
  setSize(50,5);
  SetPosition(30,10);

  curstr = curstr + 1;  
      var lbl_SET_TP;
      lbl_SET_TP = TRSBLabel(4, curstr,"Устанавливаемый тариф:");
        addlabel (lbl_SET_TP);
  curstr = curstr + 1;  
      var fld_SET_TP;
      fld_SET_TP = TRSBEditField (FT_STRING);
      fld_SET_TP.setPosition(2,curstr);
      fld_SET_TP.setSize(45,1);
      fld_SET_TP.name = "fld_SET_TP";
      fld_SET_TP.textLength = 40;
//      fld_SET_TP.editable = false;
      fld_SET_TP.value = "";
      fld_SET_TP.addEventHandler(RSB_EV_KEY_PRESSED , R2M(this, "SET_TP_KEY_PRESSED"));
        addControl(fld_SET_TP);

  curstr = curstr + 1;  
    addLabel(TRsbLabel(3, curstr, "Дата:"));
    var m_DateBegin:TRsbEditField = TRsbEditField(FT_DATE);
    m_DateBegin.setPosition(10,curstr);
    m_DateBegin.setSize(10,1);
    m_DateBegin.value = {curdate};
    m_DateBegin.addEventHandler(RSB_EV_KEY_PRESSED , R2M(this, "DATEBEGIN_KEY_PRESSED"));
    addControl(m_DateBegin);
    
    addEventHandler(RSB_EV_KEY_PRESSED , R2M(this, "Panel_ButtonEvent"));



  macro DATEBEGIN_KEY_PRESSED(RsbEvent)
     if(RsbEvent.keyCode == 317)
         m_DateBegin.value = GetDateByCalendar(m_DateBegin.value);
     end;
  end;



  macro SET_TP_KEY_PRESSED(RsbEvent)
    macro EvProc2(rs, cmd, id, key)
       if (cmd == DLG_KEY)
        if (key == 13)
           NEwTPName = rs.value("t_name");
           return CM_SELECT;
        end;   
      end;
    end;

     if(RsbEvent.keyCode == 317)
      var col2 = tArray;
      AddCol (col2, 0, "t_num",    "номер",   3 ,  0,0);
      AddCol (col2, 1, "t_name",   "наименование",   50 ,  0,0);
        var sql2 = "select t_num,t_name from dsfplan_dbt group by t_num,t_name ";
        var rs2 = RSDrecordset(sql2, rsdval_client, rsdval_static);
        var retval1 =     runScroll(rs2, 2, col2, "Тарифные планы", "EvProc2", "", "", true );
        if (retval1)
          fld_SET_TP.value = NEwTPName;
        end;
     end;
  end;



  macro Panel_ButtonEvent(RsbEvent)
    if(RsbEvent.keyCode == 316)
         dateBegin = m_DateBegin.value;
         NewTarif = fld_SET_TP.value;
         MassChngTariffExec;
         exit;
     end;
  end;


end;







  var pnlChangeTP:TRSBpanel = pnl_ChangeTP();
  pnlChangeTP.run();

  DropTempTable();
  //exit(1);




//MassChngTariffExec();
