/*
$Name:        MassChngTariffExec.mac
$Module:      Ценные бумаги
$Description: Макрос массовой смены тарифных планов
*/

import sfinter, RsbDataSet, rsd, sp_car, activex, or_rep_h, "scsrvrepfun.mac";
var cmd, sql, stat, BegDate = {curdate}, NewTarifId;
Private const NewTarif = "Инвестор";
Private const OldTarif = "Базовый";                    //Старый тариф
var OldTarifId;

  PRIVATE MACRO ClearTempTable()
     execSQL("BEGIN EXECUTE IMMEDIATE 'CREATE TABLE U_COM_DLCONTR_DBT (T_EKK VARCHAR2(64))'; EXCEPTION WHEN OTHERS THEN NULL; END;");
     execSQL("BEGIN EXECUTE IMMEDIATE 'DROP INDEX U_COM_DLCONTR_DBT_IDX0'; EXCEPTION WHEN OTHERS THEN NULL; END;");
     execSQL("BEGIN EXECUTE IMMEDIATE 'CREATE UNIQUE INDEX U_COM_DLCONTR_DBT_IDX0 ON U_COM_DLCONTR_DBT (T_EKK ASC)'; EXCEPTION WHEN OTHERS THEN NULL; END;");
     execSQL("TRUNCATE TABLE U_COM_DLCONTR_DBT;");
  END;

  PRIVATE MACRO LoadDlContrList
    var FullNameFile = "", file_xlsx, FileName,ExtName,DirName, Sheet, range, i = 1, j = 1, cnt = 0, EKK = "", number = "", InputDir = "";
    var cmd;

    InputDir = "..\\Import\\";
    if(not SelectFile(FullNameFile, InputDir + "*.xls*", "Выберите файл для загрузки", 0, true))
      MsgBox("Отказ от загрузки");
      return false;
    else

       if (UseExcelApp)       
         splitfile(FullNameFile, FileName, ExtName);
         FileName = FileName + ExtName;
         DirName = substr(FullNameFile, 1, index(FullNameFile, FileName) - 1);

//       file_xlsx = CDAOMSExcel(fname);

         if(not OpenExcelFile(FileName, false, true, DirName))
           MsgBox("Ошибка открытия файла \"" + FullNameFile + "\"");
       //    EndAction(1);
           return false;
         end;
         BegAction(0, "Ждите. Идет загрузка списка ЕКК....");
         j = 1;
         while(j <= ExcelApplication.Sheets.Count)

           Sheet = ExcelApplication.Sheets(j);
           i = 1;
           while (ValType(Sheet.Cells(i, 1).Value) != V_UNDEF)
             EKK = string(Sheet.Cells(i, 1).Value:0:0);

             cmd = RsdCommand("BEGIN "
                           + " INSERT INTO U_COM_DLCONTR_DBT ( T_EKK) values(?); "
                           + "END; ");
             cmd.AddParam("", RSDBP_IN, EKK);
             cmd.Execute();

             i = i + 1;
           end;
           j = j+1;
         end;
       else
         var jvm = CreateObject("rsjvm", "TJavaHost", "GlobalJavaHost");
         var rc = jvm.callStaticMethod("ru.softlab.rsbank.poireports.ReportCreator", "getInstance");
         var book = rc.openWorkbook(FullNameFile);

         if (not book)
           MsgBox("Ошибка открытия файла \"" + FullNameFile + "\"");
         end;

         BegAction(0, "Ждите. Идет загрузка списка ЕКК....");
         j = 0;
         while(j < book.getSheetsCount())

           book.setActiveSheet(j);
           i = 0;

           while (book.getCellValue(book.getCellRangeAddress(i, i, 0, 0)))
             EKK = string(book.getCellValue(book.getCellRangeAddress(i, i, 0, 0)):0:0);

             cmd = RsdCommand("BEGIN "
                           + " INSERT INTO U_COM_DLCONTR_DBT ( T_EKK) values(?); "
                           + "END; ");
             cmd.AddParam("", RSDBP_IN, EKK);
             cmd.Execute();

             i = i + 1;
           end;
           j = j+1;
         end;

         book.close();
         book = null;
         rc = null;
       end;

      EndAction(0);
      execSQL("COMMIT;");

    end;
    return true;

  OnError(_err)
    msgbox("Загрузка списка ЕКК из файла \"" + FullNameFile + "\" не выполнена " );
    return false;
  END;


Macro MassChngTariffExec()
   var countStr = "";
   cmd = TrsbDataSet(" select * from dsfplan_dbt where UPPER(t_name) = UPPER('" + NewTarif + "') ");
   if(cmd.movenext())
      NewTarifId = cmd.sfplanid;
   else
      MsgBox("Не удалось определить ID тарифа но наименованию " + NewTarif);
      exit(1);
   end;

   cmd = TrsbDataSet(" select * from dsfplan_dbt where UPPER(t_name) = UPPER('" + OldTarif + "') ");
   If (cmd.movenext())
      OldTarifId = cmd.sfplanid;
   else
      MsgBox("Не удалось определить ID тарифа но наименованию " + OldTarif);
      exit(1);
   end;

   If(not GetDate(BegDate, "Введите дату начала действия нового тарифа"))
      MsgBox("Отмена смены тарифов, не указана дата");
      exit(1);
   end;

   ClearTempTable();

   If(GetTrue(false, "Загрузить список ЕКК для исключения смены тарифного плана?"));
      If (not LoadDlContrList) 
         exit(1);
      end;
   end;
   
   If((not GetString(countStr, "Введите количество договоров для обработки", 10)) OR (countStr == ""));
      MsgBox("Отмена смены тарифов, не указано количество договоров");
      exit(1);

   end;

   sql = " DECLARE "
       + "   v_FuncobjID dfuncobj_dbt.t_ID%TYPE; "   
       + "   OldTarifEndDate date   := :dtbeg;   "
       + "   OldTarifID      number := :newplanid; " 
       + " BEGIN "
       + "   DELETE FROM ddl_differentid_tmp; "         
       + "   FOR c IN(SELECT 207 t_Kind, sf.t_ID t_ID"
       + "              FROM dsfcontr_dbt sf LEFT JOIN dsfcontrplan_dbt sfplan ON sfplan.t_sfcontrid = sf.t_id   "
       + "                                                                    AND sfplan.t_begin <= OldTarifEndDate     "
       + "                                                                    AND (sfplan.t_end = TO_DATE ('01010001', 'ddmmyyyy')     "
       + "                                                                       OR sfplan.t_end >= OldTarifEndDate), ddlcontr_dbt dl, dparty_dbt party,  ddlobjcode_dbt code "
       + "             WHERE     dl.t_sfcontrid = sf.t_id "
       + "                   AND sf.t_servkind = 0 "
       + "                   AND sf.t_dateclose = TO_DATE ('01010001', 'ddmmyyyy') "
       + "                   AND party.t_partyid = SF.T_PARTYID "
       + "                   AND party.t_legalform = 2 /*and SF.T_PARTYID in (206088, 221074, 221079, 221078, 221077, 221074)*/"
       + "                   AND  code.t_objecttype = 207 and code.t_codekind = 1 and code.t_objectid = dl.t_dlcontrid and code.t_bankclosedate = to_date('01.01.0001','dd.mm.yyyy')"
       + "                   AND code.t_code not in (select t_ekk from  U_COM_DLCONTR_DBT) "
       + "                   AND code.t_code NOT IN (SELECT t_ekk FROM U_COM_DLCONTR_DBT) "
       + "                   AND sfplan.t_sfplanid = OldTarifID                           "         
       + "                   AND ( (sfplan.t_sfplanid IS NULL)                        "
       + "                   OR (sfplan.t_end = TO_DATE ('01010001', 'ddmmyyyy'))) "
       + "                   AND ROWNUM <= " + countStr +" ) LOOP "    
       + "     INSERT INTO dfuncobj_dbt (t_ObjectType, t_ObjectID, t_FuncID, t_Param, t_Priority, t_Oper) "
       + "                       VALUES (c.t_Kind, c.t_ID, 7777,   to_char(c.t_ID)||';'||to_char(?)||';'|| to_char(?, 'DD.MM.YYYY'), 55, ?) " 
       + "     RETURNING t_ID INTO v_FuncobjID; "
       + "     INSERT INTO ddl_differentid_tmp (t_ID) VALUES (v_FuncobjID); "
       + "   END LOOP; "   
       + "   FOR c1 IN( SELECT 209 t_Kind, mp.t_sfcontrid t_ID"
       + "              FROM ddlcontrmp_dbt mp, dsfcontr_dbt sf LEFT JOIN dsfcontrplan_dbt sfplan ON sfplan.t_sfcontrid = sf.t_id   "
       + "                                                                    AND sfplan.t_begin <= OldTarifEndDate     "
       + "                                                                    AND (sfplan.t_end = TO_DATE ('01010001', 'ddmmyyyy')     "
       + "                                                                       OR sfplan.t_end >= OldTarifEndDate),  ddlobjcode_dbt code "
       + "             WHERE     mp.t_dlcontrid IN ( (SELECT dl.t_dlcontrid "
       + "                                              FROM dsfcontr_dbt sf, "
       + "                                                   ddlcontr_dbt dl, "
       + "                                                   dfuncobj_hist_dbt hist, "
       + "                                                   ddl_differentid_tmp dif, "
       + "                                                   dparty_dbt party "
       + "                                             WHERE     dl.t_sfcontrid = sf.t_id "
       + "                                                   AND sf.t_servkind = 0 "
       + "                                                   AND sf.t_dateclose = "
       + "                                                         TO_DATE ('01010001', 'ddmmyyyy') "
       + "                                                   AND hist.t_ObjectType = 207 "
       + "                                                   AND hist.t_FuncID = 7777 "
       + "                                                   AND hist.t_FuncObjID = dif.t_ID "
       + "                                                   AND dl.t_sfcontrID = hist.t_objectID  "
       + "                                                   AND party.t_partyid = SF.T_PARTYID "
       + "                                                   AND party.t_legalform = 2)) "
       + "                   AND mp.t_mpclosedate = TO_DATE ('01010001', 'ddmmyyyy') "
       + "                   AND sf.t_id = mp.t_sfcontrid /*and SF.T_PARTYID in (206088, 221074, 221079, 221078, 221077, 221074)*/ "
       + "                   AND  code.t_objecttype = 207 and code.t_codekind = 1 and code.t_objectid = mp.t_dlcontrid and code.t_bankclosedate = to_date('01.01.0001','dd.mm.yyyy')"
       + "                   AND code.t_code not in (select t_ekk from  U_COM_DLCONTR_DBT) "
       + "                   AND sfplan.t_sfplanid = OldTarifID                           "         
       + "                   AND ( (sfplan.t_sfplanid IS NULL)                        "
       + "                     OR (sfplan.t_end = TO_DATE ('01010001', 'ddmmyyyy')))) LOOP "    
       + "     INSERT INTO dfuncobj_dbt (t_ObjectType, t_ObjectID, t_FuncID, t_Param, t_Priority, t_Oper) "
       + "                       VALUES (c1.t_Kind, c1.t_ID, 7777,   to_char(c1.t_ID)||';'||to_char(?)||';'|| to_char(?, 'DD.MM.YYYY'), 55, ?) " 
       + "     RETURNING t_ID INTO v_FuncobjID; "
       + "     INSERT INTO ddl_differentid_tmp (t_ID) VALUES (v_FuncobjID); "
       + "   END LOOP; "   
       + " END; ";
  
   cmd = RSDCommand(sql);
   cmd.addParam("", RSDBP_IN, BegDate-1);
   cmd.addParam("", RSDBP_IN, OldTarifId);

   cmd.addParam("", RSDBP_IN, NewTarifId);
   cmd.addParam("", RSDBP_IN, BegDate);
   cmd.addParam("", RSDBP_IN, {oper});
                      
   cmd.addParam("", RSDBP_IN, NewTarifId);
   cmd.addParam("", RSDBP_IN, BegDate);
   cmd.addParam("", RSDBP_IN, {oper});

   cmd.execute();
   
   Println("Время старта: " + Time()) ;
   var sqlCnt = DL_RSDCommand(" select 1 from ddl_differentid_tmp "); 
   var cnt = sqlCnt.GetCount();
   var ds;
   var i = 0;    
   var SLEEP_TIME_MS = 15000; //Время в мс, которое выжидаем, прежде чем снова проверять результаты выполнения задач - 15 секунд    
   var MIN_EXEC_COUNT = 3; //Минимальное количество повторных выполнений каждой из ошибочных записей, прежде чем выводить по ним отчёт 

   var isNotFinished:bool = true;
   var MAX_FUNCOBJ_ITERATION = 2880; //количество повторов с задержкой в 15 сек, ориентировочно 12 часов 
   InitProgress(cnt, "Перебор ДБО для смены Тарифного плана", "Перебор ДБО для смены Тарифного плана");

   while( isNotFinished /*and (i < MAX_FUNCOBJ_ITERATION)*/ )
     RslWait(SLEEP_TIME_MS); 
     cmd = DL_RSDCommand("SELECT count(1) cnt " + 
                         "  FROM ddl_differentid_tmp t, dfuncobj_dbt funcobj " +
                         " WHERE funcobj.t_ID = t.t_ID " +
                         "   AND NOT (funcobj.t_State IN(1) AND funcobj.t_ExecCount >= "+MIN_EXEC_COUNT+") "
                         "   AND funcobj.t_State not in(3, 2)"
                        );
     ds = cmd.Execute();

     if( ds.MoveNext())
       if(int(ds.cnt) == 0) 
         isNotFinished = false;
       end;
       UseProgress(cnt - int(ds.cnt));
     end;

     i = i + 1;
   end;

   if( isNotFinished )
      //Остановим все задачи, еще не завершившие выполнение
      cmd = RSDCommand("UPDATE dfuncobj_dbt " + 
                       "   SET t_State = 3 , " +
                       "       t_ErrorText = case when t_ErrorText is null then 'Превышено время ожидания funcobj!' else t_ErrorText end " +
                       " WHERE t_ID IN (SELECT t_ID FROM ddl_differentid_tmp)"
                      );
      cmd.Execute();
   else
      //Остановим очередные итерации для ошибочных записей, сменив их статус
      cmd = RSDCommand("UPDATE dfuncobj_dbt " + 
                       "   SET t_State = 3" +
                       " WHERE t_State IN(1,2) "+
                       "   AND t_ID IN (SELECT t_ID FROM ddl_differentid_tmp)"
                      );
      cmd.Execute();
   end;
   RemProgress();

   //Формируем протокол
   InitProgress(cnt, "Печать протокола", "Печать протокола");

   //Успешно обновленные ДБО/субдог.
   cmd = DL_RSDCommand("SELECT sf.t_number t_number " + 
                       "  FROM ddl_differentid_tmp t, dfuncobj_hist_dbt hist,  dsfcontr_dbt sf " +
                       " WHERE hist.t_FuncobjID = t.t_ID " +
                       "   AND hist.t_ObjectType = 207"  +
                       "   AND NOT EXISTS (SELECT 1 " +
                       "                     FROM dfuncobj_dbt funcobj " + 
                       "                    WHERE funcobj.t_ID = t.t_ID AND t_ObjectType = 207) " +
                       "   AND sf.t_ID =  hist.t_ObjectID" 
                      );
   ds = cmd.Execute();
   while( ds.MoveNext() )
      Println("Успешно установлен тариф для ДБО "+ ds.number );
   end;

   cmd = DL_RSDCommand("SELECT sf.t_number t_number " + 
                       "  FROM ddl_differentid_tmp t, dfuncobj_hist_dbt hist,  dsfcontr_dbt sf " +
                       " WHERE hist.t_FuncobjID = t.t_ID " +
                       "   AND hist.t_ObjectType = 209"  +
                       "   AND NOT EXISTS (SELECT 1 " +
                       "                     FROM dfuncobj_dbt funcobj " + 
                       "                    WHERE funcobj.t_ID = t.t_ID AND t_ObjectType = 209) " +
                       "   AND sf.t_ID =  hist.t_ObjectID" 
                      );
   ds = cmd.Execute();
   while( ds.MoveNext() )
      Println("Успешно установлен тариф для субдоговора "+ ds.number );
   end;

   //Необновленные ДБО/субдог.
   cmd = DL_RSDCommand("SELECT sf.t_number t_number, NVL(funcobj.t_ErrorCode, 0) t_ErrorCode, NVL(funcobj.t_ErrorText, chr(1)) t_ErrorText " + 
                       "  FROM ddl_differentid_tmp t, dfuncobj_dbt funcobj,  dsfcontr_dbt sf " +
                       " WHERE funcobj.t_ID = t.t_ID " +
                       "   AND funcobj.t_State = 3" +       
                       "   AND sf.t_ID =  funcobj.t_ObjectID "
                       "   AND funcobj.t_ObjectType = 207"
                      );
   ds = cmd.Execute();
   while( ds.MoveNext() )
      Println("Ошибка установки нового ТП для ДБО "+ ds.number + iif(ds.ErrorCode > 0, "Код ошибки "+string(ds.ErrorCode)+". ", "") +" "+ ds.ErrorText );
   end;

   cmd = DL_RSDCommand("SELECT sf.t_number t_number, NVL(funcobj.t_ErrorCode, 0) t_ErrorCode, NVL(funcobj.t_ErrorText, chr(1)) t_ErrorText " + 
                       "  FROM ddl_differentid_tmp t, dfuncobj_dbt funcobj,  dsfcontr_dbt sf " +
                       " WHERE funcobj.t_ID = t.t_ID " +
                       "   AND funcobj.t_State = 3" +       
                       "   AND sf.t_ID =  funcobj.t_ObjectID "
                       "   AND funcobj.t_ObjectType = 209"
                      );
   ds = cmd.Execute();
   while( ds.MoveNext() )
      Println("Ошибка установки нового ТП для субдоговора "+ ds.number + iif(ds.ErrorCode > 0, "Код ошибки "+string(ds.ErrorCode)+". ", "") +" "+ ds.ErrorText );
   end;
   RemProgress();
   Println("Время Окончания: " + Time()) ;
End;

MassChngTariffExec();
