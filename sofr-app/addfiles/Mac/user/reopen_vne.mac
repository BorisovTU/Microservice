/* Открытие площадок по внебирже, у которых есть остатки */
/* Список площадок
T_DLCONTRID    DBO_NUMBER   DBO_DATECLOSE  DO_NUMBER        DO_DATECLOSE
5150           35-40275       01.01.0001   35-40275_в       09.04.2022
7739           40270          01.01.0001   40270_в          12.09.2022
10328          8489052        01.01.0001   8489052_в        15.08.2022
13035          00/05-99180    01.01.0001   00/05-99180_в    11.04.2022
15543          78-645450      01.01.0001   78-645450_в      30.03.2022
15569          34/08-1131766  01.01.0001   34/08-1131766_в  06.06.2022
17755          22-64166       01.01.0001   22-64166_в       10.04.2022
53694          18575985       01.01.0001   18575985_в       20.04.2022
*/

import rsd, SfInter;
var sql_upd, cmd_upd;
var sfid = 0, tarifid = 0;
var state;
var err_txt = "";


var sql_str = "select mp_sf.t_id, dl.t_dlcontrid, sf_mp_p.t_sfplanid plan_sub, sf_p.t_sfplanid plan_main, mp_sf.t_number "+
              "  from "+
              "    ddlcontr_dbt dl, "+
              "    dsfcontr_dbt sf, "+
              "    ddlcontrmp_dbt mp, "+
              "    dsfcontr_dbt mp_sf, "+
              "    dsfcontrplan_dbt sf_mp_p, "+
              "    dsfcontrplan_dbt sf_p "+
              " where dl.t_sfcontrid = sf.t_id and sf.t_dateclose = to_date('01010001','ddmmyyyy') "+
              "   and mp.t_dlcontrid = dl.t_dlcontrid "+
              "   and mp_sf.t_id = mp.t_sfcontrid and mp_sf.t_servkind = 1 and mp_sf.t_servkindsub = 9 "+
              "   and ( mp_sf.t_dateclose != to_date('01010001','ddmmyyyy') or sf_mp_p.t_sfplanid != sf_p.t_sfplanid) "+
              "   and sf_p.t_sfcontrid = sf.t_id and sf_p.t_end = to_date('01010001','ddmmyyyy') "+
              "   and sf_mp_p.t_sfcontrid = mp_sf.t_id and sf_mp_p.t_end = to_date('01010001','ddmmyyyy') "+
              "   and sf.t_number in ( "+
              " '35-40275', "+
              " '40270', "+   
              " '8489052', "+ 
              " '00/05-99180', "+
              " '78-645450', "+
              " '34/08-1131766', "+
              " '22-64166', "+
              " '18575985' ) ";
var rs = RSDRecordSet(sql_str);
sql_upd = " update dsfcontr_dbt set t_dateclose = to_date('01010001','ddmmyyyy') "+
          "  where t_id = :pid and t_dateclose != to_date('01010001','ddmmyyyy') ";
while (rs.movenext)
  sfid = rs.value("t_id");
  cmd_upd = RSDCommand(sql_upd);
  cmd_upd.AddParam("pid", RSDBP_IN, sfid);
  cmd_upd.execute;

  tarifid = rs.value("plan_main");
  if (rs.value("plan_sub") != tarifid)
     state  = SfContrChangeSfPlan(sfid, tarifid, date(), false);
     if(state != 0)
        err_txt = String("Ошибка смены тарифа "+state);
     else 
        err_txt = "OK";
     end;
  end;

  println(rs.value("t_number") + "  " + err_txt);

end;



