//-----------------------------------------------------------------------------------------
// Š®­¢¥àâ æ¨ï ª®â¨à®¢®ª ¯® ­ «®£®¢®¬ã à¥£¨áâàã
// „.Œ « èª¥¢¨ç
//-----------------------------------------------------------------------------------------
import launcher, globals, "SCImpRate.mac";//, dealsInter, spInter;, "SCImpRate.mac"
//-----------------------------------------------------------------------------------------

Macro runMigration ( namefile )
    genObject ("TaxRatesImp").run (namefile);
End;
//-----------------------------------------------------------------------------------------

Macro runProc ( fname, num, linestart, lineend, logName, procSize )
    genObject ("CLotConvert").run (fname, num, linestart, lineend, logName, procSize);
end;
//-----------------------------------------------------------------------------------------

Private macro prepare ()
    /*if ( execSqlSelect ("select 1 from user_tables where table_name = 'USER_CNVHLPLOG'").moveNext () )
        if ( not execSql ("truncate table user_cnvhlplog") )
            return false;
        end;
    else
        if ( not execSql ("create global temporary table user_cnvhlplog (t_kind number not null, t_line number not null, t_context varchar2(4000)) on commit preserve rows") )
            return false;
        end;
    end;
	*/

    return TRUE;
End;
//-----------------------------------------------------------------------------------------
Private class CError(_context, _objecttype, _extid, _missid, _missidobjtype);
   var context = "", objecttype = "", extid = "", missid = "", missidobjtype = "";
   if (_context) context = _context; end;
   if (_objecttype) objecttype = _objecttype;end;
   if (_extid) extid = _extid;       end;
   if (_missid) missid = _missid;    end;
   if (_missidobjtype) missidobjtype = _missidobjtype;   end;
end;

Private class CProtokolData
    Private var outStr;
    Var logid;
	
    Macro SetLogid()
      Var sql = execSqlSelect ("select user_cnvhlplogex_seq.nextval from dual");
	  if (sql.MoveNext())
        logid = int (sql.value (0));
	  end;
    end;
	
    Macro add ( kind, line, err)
        //execSql ("insert into user_cnvhlplogex values (:1, :2, :3, :4, :5, :6, :7, systimestamp, :8)", 
        //        makeArray (sqlParam ("1", kind), sqlParam ("2", line), sqlParam ("3", SubStr(err.context,1,400)), sqlParam ("4", SubStr(err.objecttype,1,40)), sqlParam ("5", SubStr(err.extid,1,40)), sqlParam ("6", SubStr(err.missid,1,40)),sqlParam ("7", SubStr(err.missidobjtype,1,40)), sqlParam ("8", logid)));
	var cmd = RSDCommand("insert into user_cnvhlplogex(t_kind, t_line, t_context, t_objecttype, t_extid, t_missid, t_missidobjtype, t_timestamp, t_logid) values (?, ?, ?, ?, ?, null, null, systimestamp, ?)");
	cmd.AddParam("", RSDBP_IN, kind);
	cmd.AddParam("", RSDBP_IN, line);
	cmd.AddParam("", RSDBP_IN, SubStr(err.context,1,400));
	cmd.AddParam("", RSDBP_IN, SubStr(err.objecttype,1,40));
	cmd.AddParam("", RSDBP_IN, SubStr(err.extid,1,40));
//	cmd.AddParam("", RSDBP_IN, SubStr(err.missid,1,40));
//	cmd.AddParam("", RSDBP_IN, SubStr(err.missidobjtype,1,40));
	cmd.AddParam("", RSDBP_IN, logid);
	cmd.execute();

    End;


    Macro addLine ( kind, line, fiid, sincedate, rate )
        Var data = string ("³", line:8, "³", fiid:20:c, "³", sincedate:12:c, "³", rate:25:4, "³");
        add (kind, line, CError(data, "TAXRATE", fiid, "",""));
    End;
	SetLogid();
End;
//-----------------------------------------------------------------------------------------

Private class (CImpCommon) TaxRatesImp

    PRIVATE CLASS RateType( _TypeName:STRING, _IsMarketPlace:STRING )
      VAR TypeName      = _TypeName,
          IsMarketPlace = _IsMarketPlace;
    END;
    initCImpCommon ();
    Private var fiid, ratekind, torgplace, sincedate, rateval, rate, isrelative;
                				
 	Var nomcur, ratevalbycb, ratecur, protokolData = CProtokolData (), rtype = TArray();
	
    Private macro addError ( str, missid, missobjtype )
        errorStr = errorStr + ifThenElse (errorStr, ";\n", "") + str;
        protokolData.add (1, line, CError( str, "TAXRATE", fiid, missid, missobjtype));
        error = TRUE;
    End;

    Private macro addWarning ( str, missid, missobjtype )
        errorStr = errorStr + ifThenElse (errorStr, ";\n", "") + str;
        protokolData.add (2, line, CError( str, "TAXRATE", fiid, missid, missobjtype));
    End;

    Private macro addSkip ( str,  missid, missobjtype )
        errorStr = errorStr + ifThenElse (errorStr, ";\n", "") + str;
        protokolData.add (3, line, CError( str, "TAXRATE", fiid, missid, missobjtype));
        error = TRUE;
    End;

    Private macro clear ()
        fiid = ratekind = torgplace = sincedate = rateval = rate = isrelative = NULL;
        nomcur = ratecur = -1;
    End;
	
	Macro InitRType()
      var rs = TRsbDataSet("SELECT t_Type, t_TypeName, t_IsMarketPlace FROM dRATETYPE_dbt");
      rtype.Size = 0;
      while( rs.MoveNext() )
        rtype[int(SQL_ConvTypeInteger(RS.type))] = RateType(SQL_ConvTypeStr(rs.TypeName), SQL_ConvTypeStr(RS.IsMarketPlace));
      end;
    end;

    Private macro checkLine
        if ( not fldMandatory (fiid) )
            addError ("¥ ãª § ­® ®¡ï§ â¥«ì­®¥ ¯®«¥ FIID");
		else
           var sql = execSqlSelect ("select fi.t_fi_code, (select t_iso_number from dfininstr_dbt where t_fiid = fi.t_facevaluefi) rateval from dfininstr_dbt fi where fi.t_fiid = (select t_objectid from dobjcode_dbt where t_objecttype = 9 and t_codekind = 101 and t_code = :1)", makeArray (sqlParam ("1", string (fiid))));
           if ( not sql.MoveNext () )
               addError ("– á ª®¤®¬ " + fiid + " ­¥ ­ ©¤¥­ ");
               return error;
           else
               nomcur = sql.value (0);
			   ratevalbycb = sql.value (1);
           end;		
        end;
		
		if ( not fldMandatory (ratekind) )
            addError ("¥ ãª § ­® ®¡ï§ â¥«ì­®¥ ¯®«¥ RATEKIND");
        elif ( not inList (ratekind, "1", "2", "3", "4", "5") )
            addError ("¥¢¥à­® ãª § ­® §­ ç¥­¨¥ ¯®«ï RATEKIND (" + ratekind + "). Ž¦¨¤ «®áì §­ ç¥­¨¥ 1-5");
        end;
		if (ratekind == "5")
		  ratekind = "18";
		end;

		if ((torgplace) and ( not inList (torgplace, "1", "2", "3")))
            addError ("¥¢¥à­® ãª § ­® §­ ç¥­¨¥ ¯®«ï TORGPLACE (" + torgplace + "). Ž¦¨¤ «®áì §­ ç¥­¨¥ 1-3");
        end;

        if ( not fldMandatory (sincedate) )
            addError ("¥ ãª § ­® ®¡ï§ â¥«ì­®¥ ¯®«¥ SINCEDATE");
        elif ( not fldIsDate (sincedate) )
            addError ("¥¢¥à­® ãª § ­® ¯®«¥ SINCEDATE (" + sincedate + "), ®¦¨¤ «®áì DATE");
        end;

		if (not rateval)
  		  addWarning ("¥ ãª § ­® ®¡ï§ â¥«ì­®¥ ¯®«¥ RATEVAL");
  		  rateval = ratevalbycb;
		end;
        if ( not fldMandatory (rateval) )
//            addError ("¥ ãª § ­® ®¡ï§ â¥«ì­®¥ ¯®«¥ RATEVAL");
        else 
            //if ( rateval == "RUR" ) rateval = "RUB"; end;
            //sql = execSqlSelect ("select t_fi_code from dfininstr_dbt fi where fi.t_fi_kind = :1 and fi.t_ccy = :2", makeArray (sqlParam ("1", 1), sqlParam ("2", rateval)));
			sql = execSqlSelect ("select t_fi_code from dfininstr_dbt fi where fi.t_fi_kind = :1 and fi.t_iso_number = :2", makeArray (sqlParam ("1", 1), sqlParam ("2", rateval)));
            if ( not sql.moveNext () )
                addError ("¥¢¥à­® ãª § ­® ¯®«¥ RATEVAL, ¢ «îâ  á ª®¤®¬ " + rateval + " ­¥ ­ ©¤¥­ ");
            else
                ratecur = sql.value (0);
            end;
        end;
        if ( not fldMandatory (rate) )
            addError ("¥ ãª § ­® ®¡ï§ â¥«ì­®¥ ¯®«¥ RATE");
        elif ( not fldIsMoney (rate) )
            addError ("¥¢¥à­® ãª § ­® ¯®«¥ RATE (" + RATE + "), ®¦¨¤ «®áì MONEY");
        end;
		if (isrelative == "x")
		  isrelative = "1";
		else
		  isrelative = "0";
		end;
        if ( not fldIsBool (isrelative) )
            addError ("¥ª®àà¥ªâ­® ãª § ­® §­ ç¥­¨¥ ¯®«ï ISRELATIVE (" + isrelative + "), ®¦¨¤ «®áì BOOL");
        end;

        return error;
    End;

    Private macro save ()
     var codeerror = "", rparm = TRecHandler("rateparm");
	     
    rparm.Clear();
	rparm.rec.OtherFI = nomcur;
	if( (isrelative != NULL) AND (isrelative == true) )
      rparm.rec.IsRelative = "X";
    end;
	rparm.rec.Type = ratekind;
	if( rtype[rparm.rec.Type].IsMarketPlace == "X" )
      rparm.rec.Market_Place = 2;
	  rparm.rec.Section = 2;
	end;
    rparm.rec.Name = rtype[rparm.rec.Type].TypeName + " ¨§ ŒŒ‚";
    rparm.rec.FI_Code = ratecur;	
    rparm.rec.Scale = 1;
    rparm.rec.Point = 4;
    //rparm.rec.Rate = Money( floor( rate * pow(10,rparm.rec.Point)+0.5) );
	rparm.rec.Rate = rate * pow(10,rparm.rec.Point);
    rparm.rec.SinceDate = SinceDate;
    if (rparm.rec.Type == 1 )
      rparm.rec.IsDominant = "X";
    end;

    if( “áâ ­®¢¨âìŠãàá( rparm ) != 0 ) /*¢­ãâà¨ “áâ ­®¢¨âìŠãàá âà ­§ ªæ¨ï*/
      codeerror = "– " + rparm.rec.OtherFI + " ®è¨¡ª  ¯à¨ ãáâ ­®¢ª¥ ªãàá  " + rtype[rparm.rec.Type].TypeName + Geterrmsg() ;
      runError ("+");
 	end;
	
    return TRUE;

  OnError(err)

   if ( substr (err.message, strlen (err.message)) == "+" )
            errorStr = codeerror;
        else
            errorStr = trim (getLastRSDError ()+" "+codeerror);
        end;
        error = TRUE;
		return FALSE;
  end;    
  
  //End;

    Private macro printHeader
        [‡ £àã§ª  ª®â¨à®¢®ª ¯® ­ «®£®¢®¬ã à¥£¨áâàã];
        [” ©« #] (fName);
        [########## ########] (date (), time ());
        [ ]; [ ];
    End;

    Private macro printErrors
        Var sql = execSqlSelect ("select x.*, count (1) over () t_cnt from user_cnvhlplogex x where t_kind in (1, 3) and t_logid = :1 order by t_line", makeArray (sqlParam ("1", protokolData.logid))),
            y = sql.moveNext (), x = 0;

        if ( not y ) return; end;

        println ("‚ ¯à®æ¥áá¥ § £àã§ª¨ ¯à®¨§®è«¨ ®è¨¡ª¨ (", int (sql.value ("t_cnt")), " èâ.), § ¯¨á¨ ­¥ § £àã¦¥­ë:");
        [ÚÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
         ³ ü ¯/¯ ³ ‘âà®ª  ³                                       Ž¯¨á ­¨¥ ®è¨¡ª¨                                              ³
         ÃÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
        while ( y )
            [³#######³########³####################################################################################################³]
            (x = x+1, int (sql.value ("t_line")), sql.value ("t_context"):w);
            y = sql.moveNext ();
        end;
        [ÀÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
        [ ]; [ ];
    End;
	
    Private macro printWarnings
        Var sql = execSqlSelect ("select x.*, count (1) over () t_cnt from user_cnvhlplogex x where t_kind = 2 and t_logid = :1 order by t_line", makeArray (sqlParam ("1", protokolData.logid))),
            y = sql.moveNext (), x = 0;

        if ( not y ) return; end;

        println ("‚ ¯à®æ¥áá¥ § £àã§ª¨ ¯à®¨§®è«¨ á«¥¤ãîé¨¥ ¯à¥¤ã¯à¥¦¤¥­¨ï (", int (sql.value ("t_cnt")), " èâ.)");
        [ÚÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
         ³ ü ¯/¯ ³ ‘âà®ª  ³                                       Ž¯¨á ­¨¥ ¯à¥¤ã¯à¥¦¤¥­¨ï                                      ³
         ÃÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
        while ( y )
            [³#######³########³####################################################################################################³]
            (x = x+1, int (sql.value ("t_line")), sql.value ("t_context"):w);
            y = sql.moveNext ();
        end;
        [ÀÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
        [ ]; [ ];
    End;
	

    Private macro printLog
        Var sql = execSqlSelect ("select x.*, count (1) over () t_cnt from user_cnvhlplogex x where t_kind = 0 and t_logid = :1 order by t_line", makeArray (sqlParam ("1", protokolData.logid))),
            y = sql.moveNext (), x = 0;

        if ( not y ) 
            [‡ £àã¦¥­­ë¥ § ¯¨á¨ ®âáãâáâ¢ãîâ];
            return; 
        end;

        println ("‡ £àã¦¥­ë § ¯¨á¨ (", int (sql.value ("t_cnt")), " èâ.):");
        [ÚÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
         ³ ü ¯/¯ ³ ‘âà®ª  ³      Š®¤ –        ³    „ â     ³          Šãàá           ³
         ÃÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];

        while ( y )
            println ("³", x=x+1:7, sql.value ("t_context"));
            y = sql.moveNext ();
        end;
        [ÀÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
    End;

    Macro run ( namefile, numproc, linestart, lineend, logName, procSize )
        processNumber = numproc;
        if ( not openFile (namefile) )
            return;
        end;

        if ( procSize )
             fSize = procSize;
        end;

        if ( not prepare () )
            msgBox ("Žè¨¡ª  ¯®¤£®â®¢ª¨");
            return;
        end;
		
		InitRType();

        if ( logName )
            setOutput (logName);
        else
            setLog (numproc);
        end;

        printHeader ();

        if ( (linestart) and (linestart > 1) )
            setPosition (linestart);
        end;

        Var i = 0;
		nextLine ();
        while ( nextLine () )
            clear ();
            loadLine (fiid,         // 1
			          ratekind,     // 2  
					  torgplace,	// 3 
					  sincedate, 	// 4
					  rateval, 		// 5
					  rate, 		// 6
					  isrelative);  // 7
            if ( error )
                //protokolData.add (1, line, errorStr);
                saveerr (numproc);
            elif ( not save () )
                //protokolData.add (1, line, errorStr);
                saveerr (numproc);
            else
                protokolData.addLine (0, line, fiid, sincedate, rate);
            end;
            if ( (lineend) and (line >= lineend) ) break; end;

        end;

        printLogCommon (numproc, linestart, lineend);
        printErrors ();
		printWarnings();
        printLog ();
        viewFile (setoutput (NULL, TRUE));
    End;

End;
//-----------------------------------------------------------------------------------------

//Macro PreStep
//End;
//-----------------------------------------------------------------------------------------