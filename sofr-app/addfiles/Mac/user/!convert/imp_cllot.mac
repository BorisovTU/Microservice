//-----------------------------------------------------------------------------------------
// Конвертация остатков ценных бумаг
// В.Горленко
//-----------------------------------------------------------------------------------------
import launcher, globals, dealsInter, spInter, secinter;
//-----------------------------------------------------------------------------------------

Macro runMigration ( namefile )
    genObject ("CLotConvert").run (namefile);
End;
//-----------------------------------------------------------------------------------------

Macro runProc ( fname, num, linestart, lineend, logName, procSize )
    genObject ("CLotConvert").run (fname, num, linestart, lineend, logName, procSize);
end;
//-----------------------------------------------------------------------------------------

Private macro prepare ()
/*    if ( execSqlSelect ("select 1 from user_tables where table_name = 'USER_CNVHLPLOG'").moveNext () )
        if ( not execSql ("truncate table user_cnvhlplog") )
            return false;
        end;
    else
        if ( not execSql ("create global temporary table user_cnvhlplog (t_kind number not null, t_line number not null, t_context varchar2(4000)) on commit preserve rows") )
            return false;
        end;
    end;
 */
    return TRUE;
End;
//-----------------------------------------------------------------------------------------

Private class CError(_context, _objecttype, _extid, _missid, _missidobjtype);
   var context = "", objecttype = "", extid = "", missid = "", missidobjtype = "";
   if (_context) context = _context; end;
   if (_objecttype) objecttype = _objecttype;end;
   if (_extid) extid = _extid;       end;
   if (_missid) missid = _missid;    end;
   if (_missidobjtype) missidobjtype = _missidobjtype;   end;
end;


Private class CProtokolData
    Private var outStr;
	Var logid;
	
    Macro SetLogid()
      Var sql = execSqlSelect ("select user_cnvhlplogex_seq.nextval from dual");
       if (sql.MoveNext())
        logid = int (sql.value (0));
       end;
    end;

    Macro add ( kind, line, err)
        execSql ("insert into user_cnvhlplogex values (:1, :2, :3, :4, :5, :6, :7, systimestamp, :8)", 
                makeArray (sqlParam ("1", kind), sqlParam ("2", line), sqlParam ("3", SubStr(err.context,1,4000)), sqlParam ("4", SubStr(err.objecttype,1,40)), sqlParam ("5", SubStr(err.extid,1,40)), sqlParam ("6", SubStr(err.missid,1,40)),sqlParam ("7", SubStr(err.missidobjtype,1,40)),sqlParam ("8", logid)));
    End;

    Macro addLine ( kind, line, dealid, dealcode, fiid, amount, sum)
        Var fiName = "", sql = execSqlSelect ("select t_name from dfininstr_dbt where t_fiid = :1", makeArray (sqlParam ("1", fiid)));
        if ( sql.moveNext () )
            fiName = sql.value (0);
        end;
        Var data = string ("│", line:8, "│", dealId:10, "│", dealCode:14, "│", fiName:40, "│", amount:10, "│", sum:20, "│");
        add (kind, line, CError(data, "CLLOT", dealId, "",""));
    End;

    SetLogid();
   
/*
    Macro add ( kind, line, data )
        execSql ("insert into user_cnvhlplog values (:1, :2, :3)", makeArray (sqlParam ("1", kind), sqlParam ("2", line), sqlParam ("3", data)));
    End;

    Macro addLine ( kind, line, dealid, dealcode, fiid, amount, sum )
        Var fiName = "", sql = execSqlSelect ("select t_name from dfininstr_dbt where t_fiid = :1", makeArray (sqlParam ("1", fiid)));
        if ( sql.moveNext () )
            fiName = sql.value (0);
        end;
        Var data = string ("│", line:8, "│", dealId:10, "│", dealCode:14, "│", fiName:40, "│", amount:10, "│", sum:20, "│");
        add (kind, line, data);
    End;*/
End;
//-----------------------------------------------------------------------------------------

Private class (CImpCommon) CLotConvert
    initCImpCommon ();

    private var errorInf = CError();

    Private var dealcode, dealcodeEts, dealBegDate, dealBegTime, dealDate, dealTime, preOutlay, custody, portfolio, outlay, 
                fiid, amount, sum, price, point, priceCur, nkd, perc, client, contractid, party, oldfiid,
				overAmount, reservAmount, begDiscount, begBonus, begDiscountDate, begBonusDate, InterestIncome, DiscountIncome, Bonus,
				recalcDate, OldBegDiscount, NotCarryDiscount, OldBegBonus, NotWrtBonus, OwnerBegDate, blckdate, blcknumber,pfisum,typepos;
                				
    Var ifiid, icustody, iclient, icontractid, iparty, ipriceCur, iportfolio, BoardId, protokolData = CProtokolData ();

    Private macro clear ()
        dealcode = dealcodeEts = dealBegDate = dealBegTime = dealDate = dealTime = preOutlay = custody = portfolio = outlay =
        fiid = amount = sum = price = point = priceCur = nkd = perc = client = contractid = party = oldfiid =
		overAmount = reservAmount = begDiscount = begBonus = begDiscountDate = begBonusDate = InterestIncome = DiscountIncome = Bonus =
		recalcDate = OldBegDiscount = NotCarryDiscount = OldBegBonus = NotWrtBonus = OwnerBegDate = blckdate = blcknumber = pfisum = typepos = NULL;
        ifiid = icustody = iclient = icontractid = iparty = ipriceCur = iportfolio = -1;
        BoardId = 0;
    End;

    Private macro addError ( str, missid, missobjtype )
        errorStr = errorStr + ifThenElse (errorStr, ";\n", "") + str;
        protokolData.add (1, line, CError( str, "CLLOT", dealcode, missid, missobjtype));
        error = TRUE;
    End;

    Private macro addWarning ( str, missid, missobjtype )
        errorStr = errorStr + ifThenElse (errorStr, ";\n", "") + str;
        protokolData.add (2, line, CError( str, "CLLOT", dealcode, missid, missobjtype));
    End;

    Private macro addSkip ( str,  missid, missobjtype )
        errorStr = errorStr + ifThenElse (errorStr, ";\n", "") + str;
        protokolData.add (3, line, CError( str, "CLLOT", dealcode, missid, missobjtype));
        error = TRUE;
    End;


    Private macro checkLine
private macro s (s)
    return StrSubst(s," ","");
end;
        var sql="";
preOutlay         = s(StrSubst(preoutlay,         ".",","));            // 7
//custody   = StrSubst(StrSubst(StrSubst(custody,        "00#P#",""),"00#Y#",""),"00#Б#","");   // 8
outlay          = s(StrSubst(outlay,         ".",","));              //10
amount          = s(StrSubst(amount,         ".",","));              //12
sum             = s(StrSubst(sum,         ".",","));              //13
price           = s(StrSubst(price,         ".",","));              //14
point           = s(StrSubst(point,         ".",","));              //15
nkd             = s(StrSubst(nkd,         ".",","));              //17
perc            = s(StrSubst(perc,         ".",","));              //18
overAmount           = s(StrSubst(overamount,         ".",","));         	    //19
reservAmount          = s(StrSubst(reservamount,         ".",","));             //20
begDiscount           = s(StrSubst(begdiscount,         ".",","));             //21
begBonus          = s(StrSubst(begbonus,         ".",","));                  //22
InterestIncome         = s(StrSubst(interestincome,         ".",","));            //25
DiscountIncome         = s(StrSubst(discountincome,         ".",","));            //26
Bonus         = s(StrSubst(bonus,         ".",","));                     //27
//client= StrSubst(StrSubst(StrSubst(client,        "00#P#",""),"00#Y#",""),"00#Б#","");       //28 
OldBegDiscount         = s(StrSubst(oldbegdiscount,         ".",","));            //31
NotCarryDiscount         = s(StrSubst(notcarrydiscount,         ".",","));          //32
OldBegBonus         = s(StrSubst(oldbegdiscount,         ".",","));               //33
NotWrtBonus         = s(StrSubst(notwrtbonus,         ".",","));         		//34			  
//party  = StrSubst(StrSubst(StrSubst(party,        "00#P#",""),"00#Y#",""),"00#Б#","");      //35





/*
if ((fiid != "2010015155741" )
 and  (fiid != "2010000025834")
 and (fiid != "2010015155710")
// and (fiid != "2010015075903")
 and (fiid != "2010015156483")
)
addskip("Не сейчас ... ");
end;
*/
//if (typepos != "14")
/*if (portfolio != "6")
   addskip("Не сейчас ... ");
end;
*/
//portfolio = "2";

        if (portfolio == 7) 
/* по клиентскому лоту номер сделки сформируем ниже после проверки наличия договора и бумаги
*/

        else
           if (not fldMandatory (dealcode) )
               addError ("Не указано обязательное поле DEALCODE");
           end;
        end;

        if ( not fldMandatory (dealcodeEts) )
            //addError ("Не указано обязательное поле DEALCODETS");
        end;

        if (portfolio == 7) 
           if ( not fldMandatory (dealBegDate) )
               dealBegDate = date(31,12,2018);//{curdate};
           end;

           if ( not fldMandatory (dealDate) )
               dealDate = date(31,12,2018);//{curdate};
           end;
        else
           if ( not fldMandatory (dealBegDate) )
               addError ("Не указано обязательное поле DEALBEGDATE");
           elif ( not fldIsDate (dealBegDate) )
               addError ("Неверно указано поле DEALBEGDATE ("+dealBegDate+"), ожидалось DATE");
           end;

           if ( not fldMandatory (dealDate) )
               addError ("Не указано обязательное поле DEALDATE");
           elif ( not fldIsDate (dealDate) )
               addError ("Неверно указано поле DEALDATE ("+dealDate+"), ожидалось DATE");
           end;
        end;

        //if ( not fldMandatory (dealTime) )
            //addError ("Не указано обязательное поле DEALTIME");
        if ( (dealTime) and (not fldIsTime (dealTime)) )
            addError ("Неверно указано поле DEALTIME ("+dealTime+"), ожидалось TIME");
        end;

        if ( (preOutlay) and (not fldIsMoney2 (preOutlay)) )
            addError ("Неверно указано поле PREOUTLAY ("+preOutlay+"), ожидалось MONEY");
        end;

        
        if ( not fldMandatory (custody) )
//            custody = "241181";
		icustody = 4;
//            addError ("Не указано обязательное поле CUSTODY");
        else
            If(custody = "12885")
               custody = "00#Б#241181";
            end;
            if (custody == 0)
               icustody = {ourbank};
            else
               sql = execSqlSelect ("select t_partyid from dpartcode_dbt where t_code like '%'||:1 and t_codekind = 101", makeArray (sqlParam ("1", custody)));
               if ( not sql.MoveNext () )
                   addError ("Неверно указано значение поля CUSTODY, субъект с кодом "+custody+" не найден", custody, "PARTY");
               else
                   icustody = int (sql.value (0));
               end;
            end;
        end;

        ///*!!!*/portfolio = "КП";
        if ( not fldMandatory (portfolio) )
            addError ("Не указано обязательное поле PORTFOLIO");
        else
/*            sql = execSqlSelect ("select t_element from dllvalues_dbt where t_list = 1100 and t_code = :1", makeArray (sqlParam ("1", portfolio)));
            if ( not sql.moveNext () )
                addError ("Неверно указано поле PORTFOLIO, портфель с кодом "+portfolio+" не найден");
            else
                iportfolio = int (sql.value (0));
            end;*/
           if (portfolio == 1)
              iportfolio = 1; //ТП
           elif (portfolio == 2)
              iportfolio = 2;//ппр
           elif (portfolio == 3)
              iportfolio = 5;//ПУДП
           elif (portfolio == 4)
              iportfolio = 4;//пдо
           elif (portfolio == 6)
              iportfolio = 3;//пку
           elif (portfolio == 7)
              iportfolio = 0;//кп
           else
              addError ("Неверно указано поле PORTFOLIO, портфель с кодом "+portfolio+" не найден",PORTFOLIO, "PORTFOLIO");
           end;
        end;

        if ( not fldMandatory (outlay) )
            addError ("Не указано обязательное поле OUTLAY");
        elif ( (outlay) and (not fldIsMoney2 (outlay)) )
            addError ("Неверно указано поле OUTLAY ("+outlay+"), ожидалось MONEY");
        end;

        if ( not fldMandatory (fiid) )
            addError ("Не указано обязательное поле FIID");
        else
            sql = execSqlSelect ("select t_objectid from dobjcode_dbt where t_objecttype = 9 and t_code = :1 and t_codekind = 101", makeArray (sqlParam ("1", fiid)));
            if ( not sql.MoveNext () )
                addError ("Неверно указано значение поля FIID, ЦБ с кодом "+fiid+" не найдена", fiid, "AVOIRISS");
            else
                ifiid = int (sql.value (0));
            end;
        end;

        if ( not fldMandatory (amount) )
            addError ("Не указано обязательное поле AMOUNT");
        elif ( not fldIsMoney2 (amount) )
            addError ("Неверно указано поле AMOUNT ("+amount+"), ожидалось MONEY");
        end;

        if ( not fldMandatory (sum) )
            addError ("Не указано обязательное поле SUM");
        elif ( not fldIsMoney2 (sum) )
            addError ("Неверно указано поле SUM ("+sum+"), ожидалось MONEY");
        end;

        if (price = "0.0")

        elif ( not fldMandatory (price) )
            addError ("Не указано обязательное поле PRICE");
        elif ( not fldIsMoney2 (price) )
            addError ("Неверно указано поле PRICE ("+price+"), ожидалось MONEY");
        end;

        if ( not fldMandatory (overamount) )
            addError ("Не указано обязательное поле OVERAMOUNT");
        elif ( not fldIsMoney2 (overamount) )
            addError ("Неверно указано поле OVERAMOUNT ("+overamount+"), ожидалось MONEY");
        end;

                   point = 8; 
/*        if ( not fldMandatory (point) or (point == 0))
            if ( execSqlSelect ("select 1 from dpartyown_dbt where t_partykind = 3 and t_partyid = (select t_partyid from dpartcode_dbt where t_codekind=101 and t_code = :1)", makeArray (sqlParam ("1", party))).moveNext () )
                point = 6; //биржевая
            else
                point = 8; // небиржевая
            end;
        elif ( (point) and (not fldIsNumber (point)) )
            addError ("Неверно указано поле POINT ("+point+"), ожидалось NUMBER");
        end;
 */
        if (portfolio == 7) 
           ipricecur = 0;
        else
           if ( not fldMandatory (priceCur) )
               addError ("Не указано обязательное поле PRICECUR");
           else 
               if ( pricecur == "810" ) pricecur = "643"; end;
               sql = execSqlSelect ("select t_fiid from dfininstr_dbt where t_fi_kind = 1 and t_iso_number = :1", makeArray (sqlParam ("1", priceCur)));
               if ( not sql.moveNext () )
                   addError ("Неверно указано поле PRICECUR, валюта с кодом "+priceCur+" не найдена", pricecur, "CURRENCY");
               else
                   ipriceCur = int (sql.value (0));
               end;
           end;
        end;

        if ( not fldIsMoney2 (nkd) )
            addError ("Не указано обязательное поле NKD");
        elif ( not fldIsMoney2 (outlay) )
            addError ("Неверно указано поле NKD ("+nkd+"), ожидалось MONEY");
        end;

        if ( not fldMandatory (client) )
            addError ("Не указано обязательное поле CLIENT");
        else
            if (Client == 0)
               iclient = -1;
            elif  (Client == "00#Y#389866")
               sql = execSqlSelect ("select t_partyid from dsfcontr_dbt where t_id = (select distinct t_contrid from USER_CNVHLPCONTR where t_diascode = :1)", makeArray (sqlParam ("1", contractid)));
               if ( not sql.MoveNext () )
                   addError ("Неверно указано значение поля CLIENT, субъект с кодом "+client+" не найден", client, "PARTY");
               else
                   iclient = int (sql.value (0));
               end;
            else
               sql = execSqlSelect ("select t_partyid from dpartcode_dbt where t_code = :1 and t_codekind = 101", makeArray (sqlParam ("1", client)));
               if ( not sql.MoveNext () )
                   addError ("Неверно указано значение поля CLIENT, субъект с кодом "+client+" не найден", client, "PARTY");
               else
                   iclient = int (sql.value (0));
               end;
            end;
        end;

        if ( party )
            sql = execSqlSelect ("select t_partyid from dpartcode_dbt where t_code like '%'||:1 and t_codekind = 101", makeArray (sqlParam ("1", party)));
            if ( not sql.MoveNext () )

               sql = execSqlSelect ("select t_partyid from dpartcode_dbt where t_code like '%'"":1 and t_codekind = 101", makeArray (sqlParam ("1", "B"+party)));
               if ( not sql.MoveNext () )
                  addError ("Неверно указано значение поля PARTY, субъект с кодом "+party+" не найден", party, "PARTY");
               end;
               iparty = -1;
            else
                iparty = int (sql.value (0));
                if ( not execSqlSelect ("select 1 from dpmautoac_dbt where t_servicekind=1 and t_partyid = :1 and rownum = 1", makeArray (sqlParam ("1", iparty))).MoveNext () ) // СПИ нет
                    iparty = -1;
                end;
            end;
        end;

        if ( (iclient > 0) and (iclient != {ourbank}) and (contractid) )
            //sql = execSqlSelect ("select to_number (t_documentid) from dnotetext_dbt where t_objecttype = 659 and t_notekind = 101 and t_text = rpad (utl_raw.cast_to_raw (:1), 3000, '0')", makeArray (sqlParam ("1", contractid)));
            sql = execSqlSelect ("select t_contrid from user_cnvhlpcontr where t_diascode = :1", makeArray (sqlParam ("1", contractid)));
            if ( not sql.MoveNext () )
                addError ("Неверно указано поле CONTRACTID, ДО с кодом "+contractid+" не найден", contractid, "CONTRACT");
            else
                iContractId = int (sql.value (0));
            end;
        end;
		
        /*проверим не загружалась ли*/
        if ((portfolio != 7 ) and (execSqlSelect ("select 1 from ddl_tick_dbt where t_bofficekind = 127 and t_dealcode = :1", makeArray (sqlParam ("1", dealcode))).moveNext () ))
           addSkip("Уже загружалось");
        elif ((portfolio == 7 ) and (execSqlSelect ("select 1 from ddl_tick_dbt where t_bofficekind = 127 and t_clientcontrid = :1 and t_pfi = :2", makeArray (sqlParam ("1", icontractid),sqlParam ("2", ifiid))).moveNext () ))
          addSkip("Уже загружалось");
        end;

        /*сформируем код сделки*/
        if (portfolio == 7) 
           dealcode =SubStr(contractid,6) + "_" + substr(fiid,6);
        end;

        if ( not fldMandatory (ReservAmount) )
            addError ("Не указано обязательное поле ReservAmount");
        elif ( not fldIsMoney2 (ReservAmount) )
            addError ("Неверно указано поле ReservAmount ("+ReservAmount+"), ожидалось MONEY");
        end;

        if ( not fldMandatory (BegDiscount) )
            addError ("Не указано обязательное поле BegDiscount");
        elif ( not fldIsMoney2 (BegDiscount) )
            addError ("Неверно указано поле BegDiscount ("+BegDiscount+"), ожидалось MONEY");
        end;

	if ( not fldMandatory (BegBonus) )
            addError ("Не указано обязательное поле BegBonus");
        elif ( not fldIsMoney2 (BegBonus) )
            addError ("Неверно указано поле BegBonus ("+BegBonus+"), ожидалось MONEY");
        end;
        BegBonus = abs(begbonus);

	if ( not fldMandatory (InterestIncome) )
            addError ("Не указано обязательное поле InterestIncome");
        elif ( not fldIsMoney2 (InterestIncome) )
            addError ("Неверно указано поле InterestIncome ("+InterestIncome+"), ожидалось MONEY");
        end;

		if ( not fldMandatory (DiscountIncome) )
            addError ("Не указано обязательное поле DiscountIncome");
        elif ( not fldIsMoney2 (DiscountIncome) )
            addError ("Неверно указано поле DiscountIncome ("+DiscountIncome+"), ожидалось MONEY");
        end;
		
		if ( not fldMandatory (Bonus) )
            addError ("Не указано обязательное поле Bonus");
        elif ( not fldIsMoney2 (Bonus) )
            addError ("Неверно указано поле Bonus ("+Bonus+"), ожидалось MONEY");
        end;
		
	if (RecalcDate = "0.0")
           RecalcDate = date(0,0,0);
        elif (( RecalcDate ) and ( not fldIsDate (RecalcDate) ))
            addError ("Неверно указано поле RecalcDate ("+RecalcDate+"), ожидалось DATE");
        else 
           RecalcDate = date(0,0,0);
        end;
		
		if (( OldBegDiscount) and ( not fldIsMoney2 (OldBegDiscount) ))
            addError ("Неверно указано поле OldBegDiscount ("+OldBegDiscount+"), ожидалось MONEY");
        end;

		if (( NotCarryDiscount) and ( not fldIsMoney2 (NotCarryDiscount) ))
            addError ("Неверно указано поле NotCarryDiscount ("+NotCarryDiscount+"), ожидалось MONEY");
        end;

		if (( OldBegBonus) and ( not fldIsMoney2 (OldBegBonus) ))
            addError ("Неверно указано поле OldBegBonus ("+OldBegBonus+"), ожидалось MONEY");
        end;

		if (( NotWrtBonus) and ( not fldIsMoney2 (NotWrtBonus) ))
            addError ("Неверно указано поле NotWrtBonus ("+NotWrtBonus+"), ожидалось MONEY");
        end;
		
    /*    if (not fldIsDate (OwnerBegDate))
            addError ("Неверно указано значение поля OwnerBegDate ("+OwnerBegDate+"), ожидалось DATE");
        end;*/
		
        return error;
    End;

    Private macro save ()
        Var cnt = 0, code = dealcode;
        Var NominalCost = 0;
        while ( execSqlSelect ("select 1 from ddl_tick_dbt where t_bofficekind = 127 and t_dealcode = :1", makeArray (sqlParam ("1", code))).moveNext () )
            code = dealCode + "/" + (cnt=cnt+1);
        end;
        dealcode = code;
        If(FI_IsBond(ifiid))        
           NominalCost = abs(amount)* GetFaceValue( ifiid, dealDate);

           If(NominalCost>abs(sum))
              begDiscount = NominalCost - abs(sum);
           else
              begBonus = abs(sum) - NominalCost;
           end;
        end;*/
        record BoardPrm ("BoardPrm.rec");
        BoardPrm.DealType           = 2011;
        if ( amount < $0 )
            BoardPrm.DealType = 2010;
        end;
        BoardPrm.DealCode           = "CL/"+dealcode;
        BoardPrm.Client             = ifThenElse (iClient > 0, iClient, {OurBank});
        BoardPrm.ClientContr        = ifThenElse (iContractId > 0, iContractId, 0);
        BoardPrm.Amount             = abs (amount);
        BoardPrm.Price              = price;
        BoardPrm.Cost               = abs (sum);
        BoardPrm.Nkd                = nkd;
        BoardPrm.DealDate           = /*{curdate};*/dealDate;

        if ( iClient <= 0 )
            BoardPrm.Begbonusdate       = dealBegDate;
        end;
        if ( valType (dealTime) == V_TIME )
            BoardPrm.DealTime           = dealTime;
        end;
        BoardPrm.PreOutlay          = PreOutlay;
        BoardPrm.Fiid               = ifiid;
        BoardPrm.DeliveringFIID     = ifiid;
        BoardPrm.priceFi            = ipriceCur;
        BoardPrm.Custody            = iCustody;
        BoardPrm.DepoClientCustody  = {ourBank};
        BoardPrm.DepoContrCustody   = iCustody;
        BoardPrm.Department         = 1;
        BoardPrm.Oper               = 1;
        BoardPrm.DealState          = DL_PREPARING;
        if ( BoardPrm.DealType == 2011 )
            BoardPrm.Outlay = outlay;
            BoardPrm.LastOverDate = //date(29,6,2018);
            BoardPrm.BegDate = dealBegDate;
        end;
        BoardPrm.Point              = point;
        BoardPrm.Portfolio          = iportfolio;
        BoardPrm.Contragent         = iparty;

	 BoardPrm.OverAmount         = overAmount;
	 //BoardPrm.ReservAmount	 = reservAmount;
	 BoardPrm.BegDiscount	 = begDiscount;
	 BoardPrm.BegBonus		 = begBonus;
	 BoardPrm.BegDiscountDate	 = ifThenElse (iClient > 0,date(0,0,0),dealdate);//begDiscountDate;
	 BoardPrm.BegBonusDate	 = ifThenElse (iClient > 0, date(0,0,0), IfThenElse(begBonusDate,ifthenelse(date(begBonusDate)>dealdate,dealdate,begbonusdate), date(0,0,0)));//begBonusDate;
	 BoardPrm.InterestIncome	 = InterestIncome;
	 BoardPrm.DiscountIncome	 = DiscountIncome;
	 BoardPrm.RecalcDate         = recalcDate;
	 BoardPrm.OldBegDiscount	 = OldBegDiscount;
	 BoardPrm.NotCarryDiscount	 = NotCarryDiscount;
	 BoardPrm.OldBegBonus	 = OldBegBonus;
	 BoardPrm.NotWrtBonus	 = NotWrtBonus;
         BoardPrm.Bonus          = Bonus;
        //BoardPrm.BegDate            = OwnerBegDate;

        rslDefCon.beginTrans ();

        /*!!!*/
        if ( (not execSqlSelect ("select 1 from dpartyown_dbt where t_partykind=1 and t_partyid = :1", makeArray (sqlParam ("1", BoardPrm.Client))).moveNext ()) and
             execSqlSelect ("select 1 from dparty_dbt where t_partyid = :1", makeArray (sqlParam ("1", BoardPrm.Client))).moveNext () ) 
            myExecSql ("insert into dpartyown_dbt values (:1, 1, 0, 0, 0, 0)", makeArray (sqlParam ("1", BoardPrm.Client)));
            myExecSql ("insert into dclient_dbt select :1, decode (rownum, 1, 1, 2, 2, 3, 7, 4, 15), 0, to_date ('01010001', 'ddmmyyyy'), to_date ('01010001', 'ddmmyyyy'), 1, 0, 0, chr (1) from dual connect by level <= 4", makeArray (sqlParam ("1", BoardPrm.Client)));
            myExecSql ("insert into dptsvdp_dbt values (:1, 1, 1)", makeArray (sqlParam ("1", BoardPrm.Client)));
        end;
//execsql ("insert into vvg values (1, :1, systimestamp)", makeArray (sqlParam ("1", xx=xx+1)));        
        Var repeat = 1, ok = false;
        while ( (repeat > 0) and (not (ok = SP_InsertBoardLot (BoardPrm, BoardId, true))) )
            repeat = repeat - 1;
        end;
        if ( not ok )
            runError ("+");
        end;
        
//execsql ("insert into vvg values (2, :1, systimestamp)", makeArray (sqlParam ("1", xx)));        

        if ( (dealcodeEts) and (myExecSql ("update ddl_tick_dbt set t_dealcodets = :1 where t_dealid = :2", makeArray (sqlParam ("1", dealcodeEts), sqlParam ("2", BoardId))) == NULL) )
            runError ("-");
        end;

        rslDefCon.commitTrans ();

        return TRUE;
    OnError ( err )
        if ( rslDefCon.isInTrans () )
            rslDefCon.rollbackTrans ();
        end;

        if ( substr (err.message, strlen (err.message)) == "+" )
            errorStr = strsubst (GetErrMsg (), "|", "\n");
        else
            errorStr = getLastRSDError ();
        end;
        addError (errorStr);
//        error = TRUE;
        return FALSE;
    End;

    Private macro printHeader
        [Загрузка остатков ценных бумаг];
        [Файл #] (fName);
        [########## ########] (date (), time ());
        [ ]; [ ];
    End;

    Private macro printErrors
        Var sql = execSqlSelect ("select x.*, count (1) over () t_cnt from user_cnvhlplog x where t_kind = 1 order by t_line"),
            y = sql.moveNext (), x = 0;

        if ( not y ) return; end;

        println ("В процессе загрузки произошли ошибки (", int (sql.value ("t_cnt")), " шт.), записи не загружены:");
        [┌───────┬────────┬────────────────────────────────────────────────────────────────────────────────────────────────────┐
         │ № п/п │ Строка │                                       Описание ошибки                                              │
         ├───────┼────────┼────────────────────────────────────────────────────────────────────────────────────────────────────┤];
        while ( y )
            [│#######│########│####################################################################################################│]
            (x = x+1, int (sql.value ("t_line")), sql.value ("t_context"):w);
            y = sql.moveNext ();
        end;
        [└───────┴────────┴────────────────────────────────────────────────────────────────────────────────────────────────────┘];
        [ ]; [ ];
    End;

    Private macro printLog
        Var sql = execSqlSelect ("select x.*, count (1) over () t_cnt from user_cnvhlplog x where t_kind = 0 order by t_line"),
            y = sql.moveNext (), x = 0;

        if ( not y ) 
            [Загруженные записи отсутствуют];
            return; 
        end;

        println ("Загружены записи (", int (sql.value ("t_cnt")), " шт.):");
        [┌───────┬────────┬──────────┬──────────────┬────────────────────────────────────────┬──────────┬────────────────────┐
         │ № п/п │ Строка │  DealId  │  Код сделки  │                Название ЦБ             │Количество│        Сумма       │
         ├───────┼────────┼──────────┼──────────────┼────────────────────────────────────────┼──────────┼────────────────────┤];

        while ( y )
            println ("│", x=x+1:7, sql.value ("t_context"));
            y = sql.moveNext ();
        end;
        [└───────┴────────┴──────────┴──────────────┴────────────────────────────────────────┴──────────┴────────────────────┘];
    End;

    Macro run ( namefile, numproc, linestart, lineend, logName, procSize )
        processNumber = numproc;
        if ( not openFile (namefile) )
            return;
        end;

        if ( procSize )
             fSize = procSize;
        end;

        if ( not prepare () )
            msgBox ("Ошибка подготовки");
            return;
        end;

        if ( logName )
            setOutput (logName);
        else
            setLog (numproc);
        end;

        printHeader ();

        if ( (linestart) and (linestart > 1) )
            setPosition (linestart);
        end;

        SP_BeginInsertBoardLot ();
        Var i = 0;
		nextLine ();
        while ( nextLine () )
            clear ();
            loadLine (
			dealcode,    // 1
                      dealcodeEts, // 2
                      dealBegDate, // 3
                      dealBegTime, // 4
                      dealDate,    // 5
                      dealTime,    // 6
                      preOutlay,   // 7
                      custody,     // 8
                      portfolio,   // 9
                      outlay,      //10
                      fiid,        //11
                      amount,      //12
                      sum,         //13
                      price,       //14
                      point,       //15
                      priceCur,    //16
                      nkd,         //17
                      perc,        //18
					  overAmount,  	    //19
					  reservAmount,     //20
					  begDiscount,      //21
					  begBonus,         //22
					  begDiscountDate,  //23
					  begBonusDate,     //24
					  InterestIncome,   //25
					  DiscountIncome,   //26
					  Bonus,            //27
                      client,      //28 
                      contractid,  //29  
                      recalcDate,       //30
					  OldBegDiscount,   //31
					  NotCarryDiscount, //32
					  OldBegBonus,      //33
					  NotWrtBonus,		//34			  
                      party,       //35
                      oldfiid,      //36                      
                      OwnerBegDate,
                      blckdate,
blcknumber,
pfisum,
typepos
);    //37                        
            if ( error )
                //protokolData.add (1, line, errorStr);
                saveerr (numproc);
            elif ( not save () )
                //protokolData.add (1, line, errorStr);
                saveerr (numproc);
            else
                protokolData.addLine (0, line, BoardId, dealcode, ifiid, amount, sum);
            end;
            if ( (lineend) and (line >= lineend) ) break; end;

        end;

        SP_EndInsertBoardLot ();

        printLogCommon (numproc, linestart, lineend);
        //printErrors ();
        //printLog ();
        viewFile (setoutput (NULL, TRUE));
    End;

End;
//-----------------------------------------------------------------------------------------

Macro PreStep
    if ( not execSqlSelect ("select 1 from dpartyown_dbt where t_partykind=4 and t_partyid=:1", makeArray (sqlParam ("1", {OurBank}))).movenext () )
        execsql ("insert into dpartyown_dbt values (:1, 4, 0, 0, 0, 0)", makeArray (sqlParam ("1", {OurBank})));
    end;
End;
//-----------------------------------------------------------------------------------------