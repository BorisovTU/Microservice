//-----------------------------------------------------------------------------------------
// Конвертация договоров обслуживания
// В.Горленко
// для очистки при отладке
//delete from dsfcontr_Dbt; 
//delete from ddlcontrmp_dbt;
//delete from dnotetext_dbt where t_objecttype = 659;
//delete from ddlcontr_dbt;
//delete from dsettacc_dbt;
//delete from dpmautoac_dbt;

//-----------------------------------------------------------------------------------------
import launcher, globals;
private var isUpdate = true;//false;//true;
//-----------------------------------------------------------------------------------------

Macro runMigration ( namefile )
    genObject ("CSfcontrConvert").run (namefile);
End;
//-----------------------------------------------------------------------------------------

Macro runProc ( fname, num, linestart, lineend, logName, procSize )
    genObject ("CSfcontrConvert").run (fname, num, linestart, lineend, logName, procSize);
end;
//-----------------------------------------------------------------------------------------

Private macro prepare ()
    if ( execSqlSelect ("select 1 from user_tables where table_name = 'USER_CNVHLPLOG'").moveNext () )
        if ( not execSql ("truncate table user_cnvhlplog") )
            return false;
        end;
    else
        if ( not execSql ("create global temporary table user_cnvhlplog (t_kind number not null, t_line number not null, t_context varchar2(4000)) on commit preserve rows") )
            return false;
        end;
    end;

    if ( not execSqlSelect ("select 1 from dnotekind_dbt where t_objecttype = 659 and t_notekind = 101").moveNext () )
        if ( not execSql ("insert into dnotekind_dbt values (659, 101, 7, 'Код в Диасофт', chr (0), chr (0), chr (0), 0, chr (0), chr (1), 0, chr (0))") )
            return false;
        end;
    end;

/*    if ( not execSqlSelect ("select 1 from dnotekind_dbt where t_objecttype = 207 and t_notekind = 101").moveNext () )
        if ( not execSql ("insert into dnotekind_dbt values (207, 101, 7, 'Код в Диасофт', chr (0), chr (0), chr (0), 0, chr (0), chr (1), 0, chr (0))") )
            return false;
        end;
    end;

    if ( not execSqlSelect ("select 1 from dnotekind_dbt where t_objecttype = 659 and t_notekind = 102").moveNext () )
        if ( not execSql ("insert into dnotekind_dbt values (659, 102, 7, 'Уникальный код договора для ВУ', chr (0), chr (0), chr (0), 0, chr (0), chr (1), 0, chr (0))") )
            return false;
        end;
    end;

    if ( not execSqlSelect ("select 1 from dnotekind_dbt where t_objecttype = 207 and t_notekind = 102").moveNext () )
        if ( not execSql ("insert into dnotekind_dbt values (207, 102, 7, 'Уникальный код договора', chr (0), chr (0), chr (0), 0, chr (0), chr (1), 0, chr (0))") )
            return false;
        end;
    end;
  */
    if ( not execSqlSelect ("select 1 from dnotekind_dbt where t_objecttype = 207 and t_notekind = 101").moveNext () )
        if ( not execSql ("insert into dnotekind_dbt values (207, 101, 7, 'Счет Депо Владельца', chr (0), chr (0), chr (0), 0, chr (0), chr (1), 0, chr (0))") )
            return false;
        end;
    end;

    if ( not execSqlSelect ("select 1 from dnotekind_dbt where t_objecttype = 207 and t_notekind = 102").moveNext () )
        if ( not execSql ("insert into dnotekind_dbt values (207, 102, 7, 'Номер договора Депо', chr (0), chr (0), chr (0), 0, chr (0), chr (1), 0, chr (0))") )
            return false;
        end;
    end;

    if ( not execSqlSelect ("select 1 from dnotekind_dbt where t_objecttype = 207 and t_notekind = 103").moveNext () )
        if ( not execSql ("insert into dnotekind_dbt values (207, 103, 9, 'Дата договора Депо', chr (0), chr (0), chr (0), 0, chr (0), chr (1), 0, chr (0))") )
            return false;
        end;
    end;

    if ( not execSqlSelect ("select 1 from dnotekind_dbt where t_objecttype = 207 and t_notekind = 104").moveNext () )
        if ( not execSql ("insert into dnotekind_dbt values (207, 104, 7, 'Код торгового раздела', chr (0), chr (0), chr (0), 0, chr (0), chr (1), 0, chr (0))") )
            return false;
        end;
    end;
	
    if ( not execSqlSelect ("select 1 from dnotekind_dbt where t_objecttype = 207 and t_notekind = 105").moveNext () )
        if ( not execSql ("insert into dnotekind_dbt values (207, 105, 7, 'Раздел счета Депо Владельца', chr (0), chr (0), chr (0), 0, chr (0), chr (1), 0, chr (0))") )
            return false;
        end;
    end;
	
    if ( not execSqlSelect ("select 1 from dnotekind_dbt where t_objecttype = 207 and t_notekind = 106").moveNext () )
        if ( not execSql ("insert into dnotekind_dbt values (207, 106, 7, 'Раздел Торгового счета Депо', chr (0), chr (0), chr (0), 0, chr (0), chr (1), 0, chr (0))") )
            return false;
        end;
    end;

/*
    if ( not execSqlSelect ("select 1 from dobjgroup_dbt where t_objecttype = 659 and t_groupid = 101").moveNext () )
        if ( not execSql ("insert into dobjgroup_dbt values (659, 101, 'X', 'Зарегистрирован на бирже', chr (0), 101, chr (1), chr (0), 0, chr (0), 0, 0, chr (0), 'X', chr (0), chr (0), 'X', chr (0))") )
            return false;
        end;
    end;

    if ( not execSqlSelect ("select 1 from dobjattr_dbt where t_objecttype = 659 and t_groupid = 101").moveNext () )
        if ( not execSql ("insert into dobjattr_dbt values (659, 101, 1, 0, chr (1), chr (1), chr (1), chr (0), 0, 0, 'Да', 'Да', to_date ('01010001','ddmmyyyy'), to_date ('01010001','ddmmyyyy'), 0, chr (1), chr (1), chr (0))") )
            return false;
        end;
    end;
  */
    return TRUE;
End;
//-----------------------------------------------------------------------------------------

Private class CError(_context, _objecttype, _extid, _missid, _missidobjtype);
   var context = "", objecttype = "", extid = "", missid = "", missidobjtype = "";
   if (_context) context = _context; end;
   if (_objecttype) objecttype = _objecttype;end;
   if (_extid) extid = _extid;       end;
   if (_missid) missid = _missid;    end;
   if (_missidobjtype) missidobjtype = _missidobjtype;   end;
end;


Private class CProtokolData
    Private var outStr;
	Var logid;
	
    Macro SetLogid()
      Var sql = execSqlSelect ("select user_cnvhlplogex_seq.nextval from dual");
       if (sql.MoveNext())
        logid = int (sql.value (0));
       end;
    end;

    Macro add ( kind, line, err)
        execSql ("insert into user_cnvhlplogex values (:1, :2, :3, :4, :5, :6, :7, systimestamp, :8)", 
                makeArray (sqlParam ("1", kind), sqlParam ("2", line), sqlParam ("3", SubStr(err.context,1,400)), sqlParam ("4", SubStr(err.objecttype,1,40)), sqlParam ("5", SubStr(err.extid,1,40)), sqlParam ("6", SubStr(err.missid,1,40)),sqlParam ("7", SubStr(err.missidobjtype,1,40)),sqlParam ("8", logid)));
    End;

    Macro getKindName ( kind )
        Var sql = execSqlSelect ("select t_name from davrkinds_dbt where t_numlist = :1", makeArray (sqlParam ("1", kind)));
        if ( sql.moveNext () ) return sql.value (0); end;
    End;

    Macro addLine ( kind, line, contractid, partyid, begDate, number, accounts  )
//        Var data = string ("│", line:8, "│", avoirId:10, "│", getKindName (avoirkind):30, "│", name:40, "│");
        Var data = string ("│", line:8, "│", partyid:10, "│", begDate:10, "│", number:64, "│", ifThenElse (accounts [0], accounts [0], ""):20, "│");
        for (var x, 1, accounts.size-1, 1)
            data = data + "\n"+ string ("│", "":7, "│", "":8, "│", "":10, "│", "":10, "│", "":15, "│", trim (accounts [x]):20, "│");
        end;

        add (kind, line, CError(data, "CONTR", contractid, "",""));
    End;

    SetLogid();
end;

/*
Private class CProtokolData
    Private var outStr;

    Macro add ( kind, line, data )
        execSql ("insert into user_cnvhlplog values (:1, :2, :3)", makeArray (sqlParam ("1", kind), sqlParam ("2", line), sqlParam ("3", data)));
    End;

    Macro addLine ( kind, line, partyid, leftId, begDate, number, accounts )
        Var data = string ("│", line:8, "│", partyid:10, "│", leftId:14, "│", begDate:10, "│", number:15, "│", ifThenElse (accounts [0], accounts [0], ""):20, "│");
        for (var x, 1, accounts.size-1, 1)
            data = data + "\n"+ string ("│", "":7, "│", "":8, "│", "":10, "│", "":14, "│", "":10, "│", "":15, "│", trim (accounts [x]):20, "│");
        end;
        add (kind, line, data);
    End;
End;
*/
//-----------------------------------------------------------------------------------------
Macro GetMaxAccCode()
  var sql = execSqlSelect ("select nvl(Max(to_number(nvl(replace (sf.t_acccode, chr(1)), '0'))), 0)  from dsfcontr_dbt sf");
  if ( sql.MoveNext () )
    return int(sql.Value(0));
  end;
End;

Private class (CImpCommon) CSfcontrConvert
    initCImpCommon ();
    Private var isEdin, client, contr, kind, number, ordName, accCode, accCode2, begDate, account, subAccount, mmvbCode, contrvucode,
                contractId, email, psbCode, regDate, isReg, shoulder, isSpecRepo, isNalog, isQuik, note, isNotDepo,
                portf, isAnbrok, closeDate, sumAnbrok, nameAnbrok, startDateIis, endDateAnbrok, isLostPriv, iSubKind, isIis, iislastyear, IisFirstDate,FirstBrokName,
                FirstIisNum, IsAnotherIIS, AnotherIisNum, IisYear, IisInMoney, IisOutMoney, FinrezDeduct, FinCons, ServPlace, Tarif, DepoNum, Depodate, DepoAcc, DepoPart,
				DepoAccm, DepoPartm;
				
    Var accounts, partyid = -1, contrId = -1, ikind = 0, rsId = 0, protokolData = CProtokolData ();
    private var errorInf = CError();
	private var AddTarif = false; //true; грузить только тарифы
	private var isBackOffice = false, fcbo_acccode;
	
	if (isBackOffice)
	  fcbo_acccode = GetMaxAccCode();
	end;


    Private macro clear ()
        isEdin = client = contr = kind = number = ordName = accCode = begDate = account = subAccount = mmvbCode = contrvucode =
        contractId = email = psbCode = regDate = isReg = shoulder = isSpecRepo = isNalog = isQuik = note = FirstBrokName = 
        isNotDepo = portf = isAnbrok = closeDate = sumAnbrok = nameAnbrok = startDateIis = endDateAnbrok = iislastyear = IisFirstDate = 
        isLostPriv = isIis = FirstIisNum = IsAnotherIIS = AnotherIisNum = IisYear = IisInMoney = IisOutMoney = FinrezDeduct = FinCons = ServPlace =
        Tarif = DepoNum = Depodate = DepoAcc = DepoPart = DepoAccm = DepoPartm = NULL;
        partyid = contrid = -1;
        accounts = NULL;
        rsId = 0;
        iKind = 0;
        iSubKind = 0;
    End;

    Private macro addError ( str, missid, missobjtype )
        errorStr = errorStr + ifThenElse (errorStr, ";\n", "") + str;
        protokolData.add (1, line, CError( str, "CONTR", contractid, missid, missobjtype));
        error = TRUE;
    End;

    Private macro addWarning ( str, missid, missobjtype )
        errorStr = errorStr + ifThenElse (errorStr, ";\n", "") + str;
        protokolData.add (2, line, CError( str, "CONTR", contractid, missid, missobjtype));
    End;

    Private macro addSkip ( str,  missid, missobjtype )
        errorStr = errorStr + ifThenElse (errorStr, ";\n", "") + str;
        protokolData.add (3, line, CError( str, "CONTR", contractid, missid, missobjtype));
        error = TRUE;
    End;
	
	Private Macro GetAccCode(rv)
	  if (isBackOffice)
	    fcbo_acccode = fcbo_acccode + 1;
		return trim(string(fcbo_acccode));
      end;
	  return rv;
	End;

    Private macro checkLine
        var sql = "";
       //if ( isedin )
            if ( account )
                accounts = split (account, ",");
            else
                accounts = TArray ();
            end;
        /*else
            if ( subAccount )
                accounts = split (subAccount, ",");
            else
                accounts = TArray ();
            end;
        end;*/

        if ( not fldMandatory (client) )
           /*то пытаемся найти его из договора ЕБДО*/
           sql = execSqlSelect ("select t_partyid from dsfcontr_dbt where t_number = :1 and t_servkind = 0 and t_servkindsub = 0 ", makeArray (sqlParam ("1", string (number))));
           if ( not sql.MoveNext () )
              /*и как владельца счета*/
              sql = execSqlSelect ("select t_client from daccount_dbt where t_account = :1 and t_chapter = 1 ", makeArray (sqlParam ("1", string (account))));
              if ( not sql.MoveNext () )
                 /*надежды больше нет*/
                 addError ("Не указано обязательное поле CLIENT и нет соответствующего счета и договора, где можно было попробовать его найти");
                 return error;
              end;
           end;
           partyid = int (sql.value (0));
        else
            sql = execSqlSelect ("select t_partyid from dpartcode_dbt where t_codekind = 101 and t_code = :1", makeArray (sqlParam ("1", string (client))));
            if ( not sql.MoveNext () )
                /*то пытаемся найти его из договора ЕБДО*/
                sql = execSqlSelect ("select t_partyid from dsfcontr_dbt where t_number = :1 and t_servkind = 0 and t_servkindsub = 0 ", makeArray (sqlParam ("1", string (number))));
                if ( not sql.MoveNext () )
                   /*и как владельца счета*/
                   sql = execSqlSelect ("select t_client from daccount_dbt where t_account = :1 and t_chapter = 1 ", makeArray (sqlParam ("1", string (account))));
                   if ( not sql.MoveNext () )
                      /*надежды больше нет*/
                      addError ("Субъект c кодом "+client+" не найден", client, "PARTY");
                      return error;
                   end;
                end;
                partyid = int (sql.value (0));
            else
                partyid = int (sql.value (0));
            end;
        end;
        if ( contr )
            //if ( not fldIsNumber (contr) )
            //    addError ("Неверно указано значение поля CONTR ("+contr+"). Ожидался NUMBER");
            //else
                sql = execSqlSelect ("select t_partyid from dpartcode_dbt where t_codekind = 101 and t_code = :1", makeArray (sqlParam ("1", string (contr))));
                if ( not sql.MoveNext () )
                    //addError ("Субъект кодом "+contr+" не найден!");
                    contrid = {OurBank};
                else
                    contrid = int (sql.value (0));
                end;
            //end;
        end;

        /*!!!contrid = {HEADBANKID};*/

        /*if ( (isEdin) and (not fldIsBool (isEdin)) )
            addError ("Неверно укзано значение поля ISEDIN ("+isEdin+"), ожидалось BOOL");
        end;*/

        if ( not fldMandatory (kind) )
            addError ("Не указано значение обязательного поля KIND");
        elif ( not inList (kind, "1", "2", "3", "4", "5", "6") )
            addError ("Неверно указано значение поля KIND ("+kind+"), ожидалось значение 1 - 6");
        elif ( kind == "2" ) // валютный рынок
            iKind = 2;
            iSubKind = 8;
        elif ( inList (kind, "1", "3") ) // фондовый внебиржевой рынок
		    iKind = 1;
            iSubKind = 8;
            if ( kind == "3" )
                iSubKind = 9;
            end;
        elif ( kind == "4" ) // СВО (Собственные векселя банка)
            iKind = 8;
        elif ( kind == "5" ) // Учтенные векселя
            iKind = 14;
        elif ( kind == "6" ) // срочный рынок
            iKind = 15;
            iSubKind = 8;
        end;

        if ( not fldMandatory (number) )
            addError ("Не указано обязательное поле NUMBER");
        else
           /*Проверяем на повторную загрузку / догрузку данных*/
           var Dt = execSqlSelect ("select t_dlcontrid from ddlcontr_dbt where t_sfcontrid = ( select t_id from dsfcontr_dbt where t_number = '" +number+ "')");
           if ( Dt.moveNext () )

              var _pstfx = "";
              if (ikind == 15)
                 _pstfx = "_с";
              elif(ikind == 1)
                if (iSubKind == 8)
                   _pstfx = "_ф";
                elif (iSubKind == 9)
                   _pstfx = "_в";
                end;
              else
                 /*никаких больше не ждем*/
              end;

              Dt = execSqlSelect (" select t_id from dsfcontr_dbt where t_number = '" + (number+_pstfx)+ "' and t_servkind = " + iKind+ " and t_servkindsub = " + iSubKind+ "");
              if ( Dt.moveNext () )
                if (not NeedUpdate)
                 addSkip ("Договор "+ number +" уже загружался ");
				end;
              end;

           end;    
        end;

        if ( not fldMandatory (begDate) )
            addError ("Не указано значение обязательного поля BEGDATE");
        elif ( not fldIsDate (begDate) )
            addError ("Неверно указано значение поля BEGDATE ("+begDate+"), ожидалось DATE");
        end;

        /*if ( (regDate) and (not fldIsDate (regDate)) )
            addError ("Неверно указано значение поля REGDATE ("+regDate+"), ожидалось DATE");
        end;*/

        if ( (isIis) and (not fldIsBool (isIis)) )
            addError ("Неверно указано значение поля ISIIS ("+isIis+"), ожидалось BOOL");
        end;

        if ( (AccCode) and ( StrLen(AccCode) > 7) )
            addWarning (" Слишком длинное поле Кода в номере счета (Max: 8, Actual:"+string(StrLen(AccCode))+") будет обрезано до 7 символов");
            AccCode = SubStr(AccCode,1,7);
        end;

        /*if ( (shoulder) and (not fldIsNumber (shoulder)) )
            addError ("Неверно указано значение поля SHOULDER ("+shoulder+"), ожидалось NUMBER");
        end;*/

        /*if ( (isSpecRepo) and (not fldIsBool (isSpecRepo)) )
            addError ("Неверно указано значение поля ISSPECREPO ("+isSpecRepo+"), ожидалось BOOL");
        end;*/

        /*if ( (isNalog) and (not fldIsBool (isNalog)) )
            addError ("Неверно указано значение поля ISNALOG ("+isNalog+"), ожидалось BOOL");
        end;*/

        /*if ( (isQuik) and (not inList (isQuik, "1", "0")) )
            addError ("Неверно указано значение поля ISQUIK ("+isQuik+"), ожидалось 0 или 1");
        end;*/

        /*if ( (isNotDepo) and (not fldIsBool (isNotDepo)) )
            addError ("Неверно указано значение поля ISNOTDEPO ("+isNotDepo+"), ожидалось BOOL");
        end;*/

        /*if ( (isAnbrok) and (not fldIsBool (isAnbrok)) )
            addError ("Неверно указано значение поля ISANBROK ("+isAnbrok+"), ожидалось BOOL");
        end;*/

        if (not fldIsDate (closeDate))
            addError ("Неверно указано значение поля CLOSEDATE ("+closeDate+"), ожидалось DATE");
        end;

        if ( (kind != 3) and not fldMandatory (mmvbcode))
            addError ("Не указано значение обязательного поля MMVCODE");
        else
/*
           if (mmvbcode == contractId)
              contractId = StrSubst(StrSubst(contractId, "C","C"),"М","M"); //встречаются русские символы
           end;
           mmvbcode = StrSubst(StrSubst(mmvbcode, "C","C"),"М","M"); //встречаются русские символы
*/
        end;

        /*if ( (sumAnbrok) and (not fldIsMoney (sumAnbrok)) )
            addError ("Неверно указано значение поля SUMANBROK ("+sumAnbrok+"), ожидалось MONEY");
        end;*/

        /*if ( (startDateIis) and (not fldIsDate (startDateIis)) )
            addError ("Неверно указано значение поля STARTDATEIIS ("+startDateIis+"), ожидалось DATE");
        end;*/

        /*if ( (endDateAnbrok) and (not fldIsDate (endDateAnbrok)) )
            addError ("Неверно указано значение поля ENDDATEANBROK ("+endDateAnbrok+"), ожидалось DATE");
        end;*/

        /*if ( (isLostPriv) and (not fldIsBool (isLostPriv)) )
            addError ("Неверно указано значение поля ISLOSTPRIV ("+isLostPriv+"), ожидалось BOOL");
        end;*/

        return error;
    End;

    Private macro save ()
        Var dlId = 0, rez, isExist = false;
		isEdin = false;
		isSpecRepo = true;// = false;
		isNalog = false;
		isQuik = false;
		isNotDepo = false;
		isAnbrok = false;
		isLostPriv = false;
		
        rslDefCon.BeginTrans ();

      accCode = GetAccCode(accCode);
      /*Проверяем на повторную загрузку / догрузку данных*/
        var Dt = execSqlSelect ("select t_dlcontrid from ddlcontr_dbt where t_sfcontrid = ( select t_id from dsfcontr_dbt where t_number = '" +number+ "')");
      if ( Dt.moveNext () )

         var _pstfx = "";
         if (ikind == 15)
            _pstfx = "_с";
         elif(ikind == 1)
           if (iSubKind == 8)
              _pstfx = "_ф";
           elif (iSubKind == 9)
              _pstfx = "_в";
           end;
         else
            /*никаких больше не ждем*/
         end;

         Dt = execSqlSelect (" select m.t_dlcontrid,s.t_id from dsfcontr_dbt s, ddlcontrmp_dbt m where m.t_sfcontrid = s.t_id and s.t_number = '" + (number+_pstfx)+ "' and s.t_servkind = " + iKind+ " and s.t_servkindsub = " + iSubKind+ "");
         isExist = Dt.MoveNext();
         if ( IsExist and NeedUpdate)
            //addSkip ("Договор "+ number +" уже загружался ");

         /* >> БЛОК UPDATE*/
		    if (AddTarif == true)
			   if (Tarif)	
			      ExecMacroFile("add_sfplan.mac", "ScanContrs", contractId, Int(Tarif), rez);
			      AddWarning(rez);
			   end;
			else
				if  (DepoNum) 
					 if ( execSqlSelect ("select 1 from dnotetext_dbt where t_objecttype = 207 and t_notekind = 102 and t_documentid = lpad (:rsid, 34, '0')",makeArray (sqlParam ("rsid", dt.Value(0)))).moveNext ())
						if (myExecSql ("delete from  dnotetext_dbt where t_objecttype = 207 and t_notekind = 102 and t_documentid = lpad (:rsid, 34, '0')",makeArray (sqlParam ("rsid", dt.Value(0)))) == null)
						   runError ("-");
						end;
					 end;

					 if (myExecSql ("insert into dnotetext_dbt values (0, 207, lpad (:rsid, 34, '0'), 102, 0, to_date ('01010001','ddmmyyyy'), to_date ('01010001','ddmmyyyy'), rpad (utl_raw.cast_to_raw (:val), 3000, 0), to_date ('31129999','ddmmyyyy'), 1, 0)",
											   makeArray (sqlParam ("rsid", dt.value(0)), sqlParam ("val", DepoNum))) == NULL) 
						runError ("-");
					 end;
				end;
				if (DepoDate)
					 if ( execSqlSelect ("select 1 from dnotetext_dbt where t_objecttype = 207 and t_notekind = 103 and t_documentid = lpad (:rsid, 34, '0')",makeArray (sqlParam ("rsid", dt.Value(0)))).moveNext ())
						if (myExecSql ("delete from  dnotetext_dbt where t_objecttype = 207 and t_notekind = 103 and t_documentid = lpad (:rsid, 34, '0')",makeArray (sqlParam ("rsid", dt.Value(0)))) == null)
						   runError ("-");
						end;
					 end;

					 if (myExecSql ("declare val  varchar2(20):=:val; dval date:=to_date(val, 'DD.MM.YYYY'); begin insert into dnotetext_dbt values (0, 207, lpad (:rsid, 34, '0'), 103, 0, to_date ('01010001','ddmmyyyy'), to_date ('01010001','ddmmyyyy'), " + 
									 " rpad(utl_raw.substr(utl_raw.cast_from_binary_integer(to_char(dval,'DD'), 2),1,1) || utl_raw.substr(utl_raw.cast_from_binary_integer(to_char(dval,'MM'), 2),1,1) || utl_raw.substr(utl_raw.cast_from_binary_integer(to_char(dval,'YYYY'), 2),1,2), 3000, 0), " + 
									 " to_date ('31129999','ddmmyyyy'), 1, 0); end;",
											   makeArray (sqlParam ("val", DepoDate),sqlParam ("rsid", dt.value(0)))) == NULL) 
						runError ("-");
					 end;
				end;
				if (DepoAcc)
					 if ( execSqlSelect ("select 1 from dnotetext_dbt where t_objecttype = 207 and t_notekind = 104 and t_documentid = lpad (:rsid, 34, '0')",makeArray (sqlParam ("rsid", dt.Value(0)))).moveNext ())
						if (myExecSql ("delete from  dnotetext_dbt where t_objecttype = 207 and t_notekind = 104 and t_documentid = lpad (:rsid, 34, '0')",makeArray (sqlParam ("rsid", dt.Value(0)))) == null)
						   runError ("-");
						end;
					 end;

					 if (myExecSql ("insert into dnotetext_dbt values (0, 207, lpad (:rsid, 34, '0'), 104, 0, to_date ('01010001','ddmmyyyy'), to_date ('01010001','ddmmyyyy'), rpad (utl_raw.cast_to_raw (:val), 3000, 0), to_date ('31129999','ddmmyyyy'), 1, 0)",
											   makeArray (sqlParam ("rsid", dt.value(0)), sqlParam ("val", DepoAcc))) == NULL) 
						runError ("-");
					 end;
				end;
				if (DepoPart)
					 if ( execSqlSelect ("select 1 from dnotetext_dbt where t_objecttype = 207 and t_notekind = 106 and t_documentid = lpad (:rsid, 34, '0')",makeArray (sqlParam ("rsid", dt.Value(0)))).moveNext ())
						if (myExecSql ("delete from  dnotetext_dbt where t_objecttype = 207 and t_notekind = 106 and t_documentid = lpad (:rsid, 34, '0')",makeArray (sqlParam ("rsid", dt.Value(0)))) == null)
						   runError ("-");
						end;
					 end;

					 if (myExecSql ("insert into dnotetext_dbt values (0, 207, lpad (:rsid, 34, '0'), 106, 0, to_date ('01010001','ddmmyyyy'), to_date ('01010001','ddmmyyyy'), rpad (utl_raw.cast_to_raw (:val), 3000, 0), to_date ('31129999','ddmmyyyy'), 1, 0)",
											   makeArray (sqlParam ("rsid", dt.value(0)), sqlParam ("val", DepoPart))) == NULL) 
						runError ("-");
					 end;
				end;
				if (DepoAccm)
					 if ( execSqlSelect ("select 1 from dnotetext_dbt where t_objecttype = 207 and t_notekind = 101 and t_documentid = lpad (:rsid, 34, '0')",makeArray (sqlParam ("rsid", dt.Value(0)))).moveNext ())
						if (myExecSql ("delete from  dnotetext_dbt where t_objecttype = 207 and t_notekind = 101 and t_documentid = lpad (:rsid, 34, '0')",makeArray (sqlParam ("rsid", dt.Value(0)))) == null)
						   runError ("-");
						end;
					 end;

					 if (myExecSql ("insert into dnotetext_dbt values (0, 207, lpad (:rsid, 34, '0'), 101, 0, to_date ('01010001','ddmmyyyy'), to_date ('01010001','ddmmyyyy'), rpad (utl_raw.cast_to_raw (:val), 3000, 0), to_date ('31129999','ddmmyyyy'), 1, 0)",
											   makeArray (sqlParam ("rsid", dt.value(0)), sqlParam ("val", DepoAccm))) == NULL) 
						runError ("-");
					 end;
				end;
				if (DepoPartm)
					 if ( execSqlSelect ("select 1 from dnotetext_dbt where t_objecttype = 207 and t_notekind = 105 and t_documentid = lpad (:rsid, 34, '0')",makeArray (sqlParam ("rsid", dt.Value(0)))).moveNext ())
						if (myExecSql ("delete from  dnotetext_dbt where t_objecttype = 207 and t_notekind = 105 and t_documentid = lpad (:rsid, 34, '0')",makeArray (sqlParam ("rsid", dt.Value(0)))) == null)
						   runError ("-");
						end;
					 end;

					 if (myExecSql ("insert into dnotetext_dbt values (0, 207, lpad (:rsid, 34, '0'), 105, 0, to_date ('01010001','ddmmyyyy'), to_date ('01010001','ddmmyyyy'), rpad (utl_raw.cast_to_raw (:val), 3000, 0), to_date ('31129999','ddmmyyyy'), 1, 0)",
											   makeArray (sqlParam ("rsid", dt.value(0)), sqlParam ("val", DepoPartm))) == NULL) 
						runError ("-");
					 end;
				end;
              end;
		   end;

         /* << БЛОК UPDATE*/

		end;
		
    if ( not isExist) 


              /*BPV ищем договор с таким же номером. Если не находим, то при первой вставке нужно вставить вышестоящий Единый*/
              Dt = execSqlSelect ("select t_dlcontrid from ddlcontr_dbt where t_sfcontrid = ( select t_id from dsfcontr_dbt where t_number = '" +number+ "')");
        if ( not Dt.moveNext () )
           isEdin = true;
        else
           dlId = Dt.value(0);
        end;


        /*BPV просто ДО (договор обслуживания) вставляем всегда*/
        rsdStartCapture ();
        [insert into dsfcontr_dbt values (/*t_id*/ 0,
                                          /*t_objecttype*/ 0,
                                          /*t_fiid*/ ##,
                                          /*t_object*/ chr (1),
                                          /*t_partyid*/ :partyid,
                                          /*t_number*/ nvl (:num, chr (1)),
                                          /*t_datebegin*/ nvl (:dtbeg, to_date ('01010001','ddmmyyyy')),
                                          /*t_dateprolong*/ to_date ('01010001','ddmmyyyy'),
                                          /*t_dateclose*/ nvl (:dtclose, to_date ('01010001','ddmmyyyy')),
                                          /*t_paymethod*/ 1,
                                          /*t_name*/ nvl (:ordname, chr (1)),
                                          /*t_dateconc*/ nvl (:dtcon, to_date ('01010001','ddmmyyyy')),
                                          /*t_contractorid*/ nvl (:contr, -1),
                                          /*t_servkind*/ :kind,
                                          /*t_servkindsub*/ :subkind,
                                          /*t_setaccsearchalg*/ 1,
                                          /*t_invmethod*/ 1,
                                          /*t_payfiid*/ 0,
                                          /*t_payrateid*/ 7,
                                          /*t_payratepercent*/ 0,
                                          /*t_payratedatekind*/ 2,
                                          /*t_invoiceduration*/ 7,
                                          /*t_department*/ 1,
                                          /*t_acccode*/ nvl (:acccode, chr (1)),
                                          /*t_branch*/ 0,
                                          /*t_unioncontrid*/ 0,
                                          /*t_preacptid*/ 0) returning t_id into :id]
        (ifThenElse (isEdin, "0", "-1"));
        rsdEndCapture ();

               _pstfx = "";
        if (ikind == 15)
           _pstfx = "_с";
        elif(ikind == 1)
          if (iSubKind == 8)
             _pstfx = "_ф";
          elif (iSubKind == 9)
             _pstfx = "_в";
          end;
        else
           /*никаких больше не ждем*/
        end;

              if (StrLen( _pstfx+number) == 21)
                 _pstfx = strsubst(_pstfx,"_", "");
              elif (StrLen( _pstfx+number) > 21)
                 addWarning("Номер договора слишком длинный: " + number +  " обрезаем до 19 ");
                 _pstfx = strsubst(_pstfx,"_");
                 Number = SubStr(Number,1,18);
              end;


        Var rs = myExecSql (NULL, makeArray (sqlParam ("partyid",   partyid),
                                             sqlParam ("num",       (number + _pstfx)),
                                             sqlParam ("dtbeg",     begDate),
                                             sqlParam ("dtclose",   closeDate),
                                             sqlParam ("ordname",   ordName),
                                             sqlParam ("dtcon",     begDate),
                                             sqlParam ("contr",     contrId),
                                             sqlParam ("kind,",     iKind),
                                             sqlParam ("subkind",   ifThenElse (iKind, iSubKind, 0)),
                                             sqlParam ("acccode",   accCode),
                                             sqlParam ("id",        V_INTEGER, RSDBP_OUT)));
        if ( rs == NULL )
            runError ("-");
        end;

        rsId = int (rs.value ("id"));


        if ( isEdin /*or (Kind == "НЕТ") */) /*Если требуется вставляем соответствющий единый*/
	//if ( isIis )
            /*сначала соответствующую Единому запись в сфконтре*/
            rsdStartCapture ();
            [insert into dsfcontr_dbt values (/*t_id*/ 0,
                                              /*t_objecttype*/ 0,
                                              /*t_fiid*/ ##,
                                              /*t_object*/ chr (1),
                                              /*t_partyid*/ :partyid,
                                              /*t_number*/ nvl (:num, chr (1)),
                                              /*t_datebegin*/ nvl (:dtbeg, to_date ('01010001','ddmmyyyy')),
                                              /*t_dateprolong*/ to_date ('01010001','ddmmyyyy'),
                                              /*t_dateclose*/ nvl (:dtclose, to_date ('01010001','ddmmyyyy')),
                                              /*t_paymethod*/ 1,
                                              /*t_name*/ nvl (:ordname, chr (1)),
                                              /*t_dateconc*/ nvl (:dtcon, to_date ('01010001','ddmmyyyy')),
                                              /*t_contractorid*/ nvl (:contr, -1),
                                              /*t_servkind*/ :kind,
                                              /*t_servkindsub*/ :subkind,
                                              /*t_setaccsearchalg*/ 1,
                                              /*t_invmethod*/ 1,
                                              /*t_payfiid*/ 0,
                                              /*t_payrateid*/ 7,
                                              /*t_payratepercent*/ 0,
                                              /*t_payratedatekind*/ 2,
                                              /*t_invoiceduration*/ 7,
                                              /*t_department*/ 1,
                                              /*t_acccode*/ nvl (:acccode, chr (1)),
                                              /*t_branch*/ 0,
                                              /*t_unioncontrid*/ 0,
                                              /*t_preacptid*/ 0) returning t_id into :id]
            (ifThenElse (isEdin, "0", "-1"));
            rsdEndCapture ();

            rs = myExecSql (NULL, makeArray (sqlParam ("partyid",   partyid),
                                             sqlParam ("num",       number),
                                             sqlParam ("dtbeg",     begDate),
                                             sqlParam ("dtclose",   closeDate),
                                             sqlParam ("ordname",   ordName),
                                             sqlParam ("dtcon",     begDate),
                                             sqlParam ("contr",     -1),
                                             sqlParam ("kind,",     0),
                                             sqlParam ("subkind",   0),
                                             sqlParam ("acccode",   accCode),
                                             sqlParam ("id",        V_INTEGER, RSDBP_OUT)));
            if ( rs == NULL )
                runError ("-");
            end;

            var rsSfEdinId = int (rs.value ("id"));


            rsdStartCapture ();
            [insert into ddlcontr_dbt values (/*t_dlcontrid*/ 0,
                                              /*t_sfcontrid*/ :contrid,
                                              /*t_iis*/ nvl (:iis, chr (0)),
                                              /*t_unidepocontrid*/ 0,
                                              /*t_inextdepo*/ chr (0),
                                              /*t_usesubacc*/ 'X'/*chr (0)*/,
                                              /*t_iisfirstdate*/ to_date ('01010001','ddmmyyyy'),
                                              /*t_iisfirstbrokername*/ chr (1),
                                              /*t_iisfirstnumber*/ chr (1),
                                              /*t_iistransfer*/ nvl (:trans, chr (0)),
                                              /*t_iislastbrokername*/ nvl (:brok, chr (1)),
                                              /*t_iislastnumber*/ chr (1),
                                              /*t_iislastopendate*/ nvl (:startiis, to_date ('01010001','ddmmyyyy')),
                                              /*t_iislastclosedate*/ nvl (:endiis, to_date ('01010001','ddmmyyyy')),
                                              /*t_iislastyear*/ 0, 
                                              /*t_iislastinsum*/ :sumbrok,
                                              /*t_isslastoutsum*/ 0,
                                              /*t_iisclosebytransf*/ nvl (:isanbrok, chr (0)),
                                              /*t_iisbenefitdep*/ nvl (:lostpriv, chr (0)),
                                              /*t_iisenrolban*/ chr (0),
                                              /*t_repmethod*/ 1,
                                              /*t_email*/ nvl (:email, chr (1)),
                                              /*t_repoovernight*/ nvl (:repoover, chr (0)),
                                              /*t_leverage*/ 0,
                                              /*t_notpaybrkacc*/ chr (0),
                                              /*t_returntax*/ nvl (:nalog, chr (0)),
                                              /*t_usequik*/ nvl (:quik, chr (0)),
                                              /*t_iisdedfinres*/ chr (0)) returning t_dlcontrid into :id];
            rsdEndCapture ();
            rs = myExecSql (NULL, makeArray (sqlParam ("contrid",   rsSfEdinId),
                                             sqlParam ("iis",       ifThenElse (isIis, "X", StrFor(0))),
                                             sqlParam ("trans",     ifThenElse (nameanbrok, "X", StrFor(0))),
                                             sqlParam ("brok",      ifThenElse (nameanbrok,nameanbrok,StrFor(0))),
                                             sqlParam ("startiis",  ifThenElse (startDateIIS,startDateIIS,"")),
                                             sqlParam ("endiis",    ifThenElse (endDateanbrok,endDateanbrok,"")),
                                             //sqlParam ("isbrok",    ifThenElse (nameanbrok, "", "X")),
                                             //sqlParam ("iislastyear",   ifThenElse (iislastyear,iislastyear, 0)),
                                             sqlParam ("sumbrok",   ifThenElse (sumanbrok,sumanbrok, 0.0)),
                                             sqlParam ("isanbrok",  ifThenElse (isanbrok, "X", StrFor(0))),
                                             sqlParam ("lostpriv",  ifThenElse (isLostpriv, "X", StrFor(0))),
                                             sqlParam ("email",     ifThenElse (email,email,StrFor(1))),
                                             sqlParam ("repoover",  ifThenElse (isSpecRepo, StrFor(0), "X")),
                                             sqlParam ("nalog",     ifThenElse (isnalog, "X", StrFor(0))),
                                             sqlParam ("quik",      ifThenElse (isquik == "1", "X", StrFor(0))),
                                             sqlParam ("id",        V_INTEGER, RSDBP_OUT)));
            if ( rs == NULL )
                runError ("-");
            end;
            dlId = int (rs.value ("id"));
			
              if ( (deponum) and (myExecSql ("insert into dnotetext_dbt values (0, 207, lpad (:docid, 34, '0'), 102, 0, to_date ('01010001','ddmmyyyy'), to_date ('01010001','ddmmyyyy'), rpad (utl_raw.cast_to_raw (:val), 3000, 0), to_date ('31129999','ddmmyyyy'), 1, 0)",
                                             makeArray (sqlParam ("docid", dlId), sqlParam ("val", Deponum))) == NULL) )
                  runError ("-");
              elif ( (depodate) and (myExecSql ("declare val  varchar2(20) := :val; dval date := to_date(val, 'DD.MM.YYYY'); begin insert into dnotetext_dbt values (0, 207, lpad (:docid, 34, '0'), 103, 0, to_date ('01010001','ddmmyyyy'), to_date ('01010001','ddmmyyyy'), " + 
                                 " rpad(utl_raw.substr(utl_raw.cast_from_binary_integer(to_char(dval,'DD'), 2),1,1) || utl_raw.substr(utl_raw.cast_from_binary_integer(to_char(dval,'MM'), 2),1,1) || utl_raw.substr(utl_raw.cast_from_binary_integer(to_char(dval,'YYYY'), 2),1,2), 3000, 0), " + 
                                 " to_date ('31129999','ddmmyyyy'), 1, 0); end;",
                                             makeArray (sqlParam ("val", DepoDate),sqlParam ("docid", dlId))) == NULL) )
                  runError ("-");
              elif ( (depoacc) and (myExecSql ("insert into dnotetext_dbt values (0, 207, lpad (:docid, 34, '0'), 104, 0, to_date ('01010001','ddmmyyyy'), to_date ('01010001','ddmmyyyy'), rpad (utl_raw.cast_to_raw (:val), 3000, 0), to_date ('31129999','ddmmyyyy'), 1, 0)",
                                             makeArray (sqlParam ("docid", dlid), sqlParam ("val", DepoAcc))) == NULL) )
                  runError ("-");
              elif ( (depopart) and (myExecSql ("insert into dnotetext_dbt values (0, 207, lpad (:docid, 34, '0'), 106, 0, to_date ('01010001','ddmmyyyy'), to_date ('01010001','ddmmyyyy'), rpad (utl_raw.cast_to_raw (:val), 3000, 0), to_date ('31129999','ddmmyyyy'), 1, 0)",
                                             makeArray (sqlParam ("docid", dlid), sqlParam ("val", DepoPart))) == NULL) )
                  runError ("-");
              elif ( (depoaccm) and (myExecSql ("insert into dnotetext_dbt values (0, 207, lpad (:docid, 34, '0'), 101, 0, to_date ('01010001','ddmmyyyy'), to_date ('01010001','ddmmyyyy'), rpad (utl_raw.cast_to_raw (:val), 3000, 0), to_date ('31129999','ddmmyyyy'), 1, 0)",
                                             makeArray (sqlParam ("docid", dlid), sqlParam ("val", DepoAccm))) == NULL) )
                  runError ("-");
              elif ( (depopartm) and (myExecSql ("insert into dnotetext_dbt values (0, 207, lpad (:docid, 34, '0'), 105, 0, to_date ('01010001','ddmmyyyy'), to_date ('01010001','ddmmyyyy'), rpad (utl_raw.cast_to_raw (:val), 3000, 0), to_date ('31129999','ddmmyyyy'), 1, 0)",
                                             makeArray (sqlParam ("docid", dlid), sqlParam ("val", DepoPartm))) == NULL) )
                  runError ("-");
		      end;

		
		/*Добавим категорию 101*/
        rsdStartCapture ();
        [insert into dobjatcor_dbt
			values
			  (207,
			   101,
			   3,
			   lpad(to_char(:dlid), 34, '0'),
			   'X',
			   to_date('01010001', 'ddmmyyyy'),
			   1,
			   to_date('31129999', 'ddmmyyyy'),
			   to_date('01010001', 'ddmmyyyy'),
			   to_date('01010001', 'ddmmyyyy'),
			   chr(0),
			   0)
         ];
        rsdEndCapture ();
        rs = myExecSql (NULL, makeArray (sqlParam ("dlid",   dlId))); 		


			

        end;
        /*И затем связку Единого с ДО*/

        rsdStartCapture ();
        [insert into ddlcontrmp_dbt values (
                0
               ,:dlid
               ,:sfid
               ,2
               ,:mpcode
               ,:regdate
               ,to_date ('01010001','ddmmyyyy')
               ,0 )
         ];
        rsdEndCapture ();
            rs = myExecSql (NULL, makeArray (sqlParam ("dlid",   dlId),
                                             sqlParam ("sfid",   rsId),
                                             sqlParam ("mpcode",  MMVBCODE),
                                             sqlParam ("regdate", begdate))); /*Должно быть поле regdate,  пока не передали, но должны*/



        if ( (contractId)/* and (dlId == 0)*/ and (myExecSql ("insert into dnotetext_dbt values (0, 659, lpad (:docid, 10, '0'), 101, 0, to_date ('01010001','ddmmyyyy'), to_date ('01010001','ddmmyyyy'), rpad (utl_raw.cast_to_raw (:val), 3000, 0), to_date ('31129999','ddmmyyyy'), 1, 0)",
                                       makeArray (sqlParam ("docid", trim(string(rsId))), sqlParam ("val", contractId))) == NULL) )
            runError ("-");

        /*elif ( (contrvucode) and (dlId == 0) and (myExecSql ("insert into dnotetext_dbt values (0, 659, lpad (:fiid, 10, '0'), 102, 0, to_date ('01010001','ddmmyyyy'), to_date ('01010001','ddmmyyyy'), rpad (utl_raw.cast_to_raw (:val), 3000, 0), to_date ('31129999','ddmmyyyy'), 1, 0)",
                                       makeArray (sqlParam ("fiid", rsId), sqlParam ("val", contrvucode))) == NULL) )
            runError ("-");*/
        /*elif ( (isreg) and (dlId == 0) and (myExecSql ("insert into dobjatcor_dbt values (659, 101, 1, lpad (:1, 10, '0'), 'X', to_date ('01010001','ddmmyyyy'), 0, to_date ('31129999', 'ddmmyyyy'), to_date ('01010001','ddmmyyyy'), to_date ('01010001','ddmmyyyy'), chr (0), 0)", makeArray (sqlParam ("1", rsId))) == NULL) )
            runError ("-");*/
        end;

        if ( (iKind == 1) and (myExecSql ("insert into dpmwrtmet_dbt values (:1, :2, 2)", makeArray (sqlParam ("1", partyId), sqlParam ("2", rsId))) == NULL) )
            runError ("-");
        end;

        Var template;
//        if ( dlId == 0 )
            rsdStartCapture ();
            [insert all 
             into dsettacc_dbt values (dsettacc_dbt_seq.nextval,
                                       v_partyid,
                                       v_bankid,
                                       v_fiid,
                                       1,
                                       v_account,
                                       nvl (v_iin, chr (1)),
                                       nvl (v_recname, chr (1)),
                                       3,
                                       v_bik,
                                       nvl (v_bankname, chr (1)),
                                       -1,
                                       3,
                                       chr (1),
                                       chr (1),
                                       nvl (v_corracc, chr (1)),
                                       1,
                                       v_partyid,
                                       1,
                                       nvl (v_code, chr (1)),
                                       nvl (v_desc, chr (1)),
                                       v_order * 5,
                                       nvl (v_account, chr (1)),
                                       chr (0),
                                       chr (1))
             into dpmautoac_dbt values (v_partyid,
                                        v_fiid,
                                        0,
                                        0,
                                        dsettacc_dbt_seq.currval,
                                        1,
                                        v_servicekind,
                                        v_order * 5,
                                        chr (1),
                                        chr (1))
             into dsfssi_dbt values (659, 
                                     lpad (v_contrid, 10, '0'), 
                                     dsettacc_dbt_seq.currval,
                                     1,
                                     v_fiid,
                                     v_order*5,
                                     v_operdate,
                                     to_date ('01010001','ddmmyyyy'),
                                     to_date ('01010001','ddmmyyyy'),
                                     0,
                                     0,
                                     0,
                                     0)
             into dmcaccdoc_dbt values (/*t_id*/ 0,
                                        /*t_iscommon*/ 'X'/*chr (0)*/,
                                        /*t_dockind*/ 122,
                                        /*t_docid*/ v_contrid,
                                        /*t_catid*/ 70,
                                        /*t_catnum*/ 201,
                                        /*t_chapter*/ 1,
                                        /*t_account*/ v_account,
                                        /*t_currency*/ nvl ((select t_code_currency from daccount_dbt where t_chapter=1 and t_account = v_account), 
                                                 nvl ((select t_fiid from dfininstr_dbt where t_fi_kind=1 and t_fi_code = substr (v_account, 6, 3)), 0)),
                                        /*t_templnum*/ v_templ,
                                        /*t_groupnum*/ 0,
                                        /*t_periodid*/ 0,
                                        /*t_activatedate*/ nvl (v_operdate, trunc (sysdate)),
                                        /*t_disablingdate*/ to_date ('01010001','ddmmyyyy'),
                                        /*t_isusable*/ 'X',
                                        /*t_fiid*/ -1,
                                        /*t_owner*/ v_partyid,
                                        /*t_place*/ -1,
                                        /*t_issuer*/ -1,
                                        /*t_kind_account*/ 'П',
                                        /*t_centr*/ -1,
                                        /*t_centroffice*/ -1,
                                        /*t_actiondate*/ nvl (v_operdate, trunc (sysdate)),
                                        /*t_fiid2*/ 0,
                                        /*t_clientcontrid*/ v_contrid,
                                        /*t_bankcontrid*/ -1,
                                        /*t_marketplaceid*/ -1,
                                        /*t_marketplaceofficeid*/ -1,
                                        /*t_firole*/ 3,
                                        /*t_indexdate*/ -1,
                                        /*t_departmentid*/ 1,
                                        /*t_contractor*/ -1,
                                        /*t_branch*/ 1,
                                        /*t_corrdepartmentid*/ 0,
                                        /*t_currencyeq*/ -1,
                                        /*t_currencyeq_ratetype*/ 0,
                                        /*t_currencyeq_ratedate*/ 0,
                                        /*t_currencyeq_rateextra*/ 0,
                                        /*t_mcbranch*/ 1)

             with parm as (select :partyid v_partyid, :bankid v_bankid, :account v_account from dual)
             select (select v_partyid from parm) v_partyid,
                    (select v_bankid from parm) v_bankid,
                    nvl ((select t_code_currency from daccount_dbt where t_chapter=1 and t_account = (select v_account from parm)), 0) v_fiid,
                    :operdate v_operdate,
                    (select v_account from parm) v_account,
                    (select t_code from dpartcode_dbt where t_codekind=16 and t_partyid = (select v_partyid from parm)) v_iin,
                    (select t_name from dparty_dbt where t_partyid = (select v_partyid from parm)) v_recname,
                    (select t_code from dpartcode_dbt where t_codekind=3 and t_partyid = (select v_partyid from parm)) v_bik,
                    (select t_name from dparty_dbt where t_partyid = (select v_bankid from parm)) v_bankname,
                    chr (1) v_corracc,
                    (select t_code from dpartcode_dbt where t_codekind=1 and t_partyid = (select v_partyid from parm)) v_code,
                    chr (1) v_desc,
                    (select count (1)+1 from dsettacc_dbt where t_partyid = (select v_partyid from parm)) v_order,
                    :contrid v_contrid,
                    :kind v_servicekind,
                    :templ v_templ
             from dual];
            rsdEndCapture ();

            for (var x, accounts)
                var repeat = 20;

                if ( substr (trim (x), 1, 5) == "30606" )
      /*                    if ( substr (trim (x), 14, 1) == "5" )
                        template = 7;
                    elif ( substr (trim (x), 14, 1) == "3" )
                        template = 6;
                    else
                        template = 3;
                          end;             */
                              template = 3;
                      elif ( substr (trim (x), 1, 5) == "30603" )
                              template = 5;
                else
      /*                    if ( substr (trim (x), 14, 1) == "5" )
                        template = 4;
                    elif ( substr (trim (x), 14, 1) == "2" )
                        template = 5;
                    else
                        template = 1;
                          end;            */
                              template = 1;
                end;

                while ( repeat > 0 )
                    if ( myExecSql (NULL, makeArray (sqlParam ("partyid", partyid),
                                                     sqlParam ("bankid", {ourBank}),
                                                     sqlParam ("account", trim (x)),
                                                     sqlParam ("operdate", begDate),
                                                     sqlParam ("contrId", rsId),
                                                     sqlParam ("kind", iKind),
                                                     sqlParam ("templ", template))) != NULL )
                        break;
                    end;
                    repeat = repeat - 1;
                end;
                if ( repeat == 0 )
                   runError ("-");
                end;
            end;
  //      else

 /*  BPV в РСХБ не бывает СПИ на ЕБДО

          rsdStartCapture ();
            [insert into dmcaccdoc_dbt values (/*t_id*/ 0,
                                               /*t_iscommon*/ 'X'/*chr (0)*/,
                                               /*t_dockind*/ 207,
                                               /*t_docid*/ :dlid,
                                               /*t_catid*/ 542,
                                               /*t_catnum*/ 1302,
                                               /*t_chapter*/ 1,
                                               /*t_account*/ :acc1,
                                               /*t_currency*/ nvl ((select t_code_currency from daccount_dbt where t_chapter=1 and t_account = :acc2), 
                                                        nvl ((select t_fiid from dfininstr_dbt where t_fi_kind=1 and t_fi_code = substr (:acc3, 6, 3)), 0)),
                                               /*t_templnum*/ :templ,
                                               /*t_groupnum*/ 0,
                                               /*t_periodid*/ 0,
                                               /*t_activatedate*/ nvl (:dt1, trunc (sysdate)),
                                               /*t_disablingdate*/ to_date ('01010001','ddmmyyyy'),
                                               /*t_isusable*/ 'X',
                                               /*t_fiid*/ -1,
                                               /*t_owner*/ :client,
                                               /*t_place*/ -1,
                                               /*t_issuer*/ -1,
                                               /*t_kind_account*/ 'П',
                                               /*t_centr*/ -1,
                                               /*t_centroffice*/ -1,
                                               /*t_actiondate*/ nvl (:dt2, trunc (sysdate)),
                                               /*t_fiid2*/ 0,
                                               /*t_clientcontrid*/ :contr,
                                               /*t_bankcontrid*/ -1,
                                               /*t_marketplaceid*/ -1,
                                               /*t_marketplaceofficeid*/ -1,
                                               /*t_firole*/ 0,
                                               /*t_indexdate*/ -1,
                                               /*t_departmentid*/ 1,
                                               /*t_contractor*/ -1,
                                               /*t_branch*/ 1,
                                               /*t_corrdepartmentid*/ 0,
                                               /*t_currencyeq*/ -1,
                                               /*t_currencyeq_ratetype*/ 0,
                                               /*t_currencyeq_ratedate*/ 0,
                                               /*t_currencyeq_rateextra*/ 0,
                                               /*t_mcbranch*/ 1)];
            rsdEndCapture ();
            for (x, accounts)
                if ( substr (trim (x), 1, 5) == "30606" )
                    template = ifThenElse (substr (trim (x), 14, 1) == "5", 5, 3);
                elif ( substr (trim (x), 14, 1) == "2" )
                    template = 2;
                else
                    template = ifThenElse (substr (trim (x), 14, 1) == "5", 4, 1);
                end;
                if ( myExecSql (NULL, makeArray (sqlParam ("dlId",      dlId),
                                                 sqlParam ("acc1",      trim (x)),
                                                 sqlParam ("acc2",      trim (x)),
                                                 sqlParam ("acc3",      trim (x)),
                                                 sqlParam ("templ",     template),
                                                 sqlParam ("dt1",       begDate),
                                                 sqlParam ("client",    partyId),
                                                 sqlParam ("dt2",       begDate),
                                                 sqlParam ("contr",     rsId))) == NULL )
                    runError ("-");
                elif ( execSqlSelect ("select 1 from daccount_dbt where t_chapter=1 and t_account=:1", makeArray (sqlParam ("1", trim (x)))).moveNext () and myExecSql ("insert into ddlcontracc_dbt values (0, :1, (select t_accountid from daccount_dbt where t_chapter=1 and t_account=:2), 0)", makeArray (sqlParam ("1", dlId), sqlParam ("2", trim (x)))) == NULL )
                    runError ("-");
                end;
            end;*/
    //    end;

//              end;

        end;

        rslDefCon.commitTrans ();
        return TRUE;
    OnError
        if ( rslDefCon.isInTrans () )
            rslDefCon.rollbackTrans ();
        end;
        errorStr = getLastRSDError ();
        addError(errorStr);
        //error = TRUE;
        return FALSE;
    End;

    Private macro printHeader
        [Загрузка договоров обслуживания];
        [Файл #] (fName);
        [########## ########] (date (), time ());
        [ ]; [ ];
    End;

    Private macro printErrors
        Var sql = execSqlSelect ("select x.*, count (1) over () t_cnt from user_cnvhlplog x where t_kind = 1 order by t_line"),
            y = sql.moveNext (), x = 0;

        if ( not y ) return; end;

        println ("В процессе загрузки произошли ошибки (", int (sql.value ("t_cnt")), " шт.), записи не загружены:");
        [┌───────┬────────┬────────────────────────────────────────────────────────────────────────────────────────────────────┐
         │ № п/п │ Строка │                                       Описание ошибки                                              │
         ├───────┼────────┼────────────────────────────────────────────────────────────────────────────────────────────────────┤];
        while ( y )
            [│#######│########│####################################################################################################│]
            (x = x+1, int (sql.value ("t_line")), sql.value ("t_context"):w);
            y = sql.moveNext ();
        end;
        [└───────┴────────┴────────────────────────────────────────────────────────────────────────────────────────────────────┘];
        [ ]; [ ];
    End;

    Private macro printLog
        Var sql = execSqlSelect ("select x.*, count (1) over () t_cnt from user_cnvhlplog x where t_kind = 0 order by t_line"),
            y = sql.moveNext (), x = 0;

        if ( not y ) 
            [Загруженные записи отсутствуют];
            return; 
        end;

        println ("Загружены записи (", int (sql.value ("t_cnt")), " шт.):");
        [┌───────┬────────┬──────────┬──────────────┬──────────┬───────────────┬────────────────────┐
         │ № п/п │ Строка │ ИД в АБС │    Код НА    │   Дата   │     Номер     │                    │
         ├───────┼────────┼──────────┼──────────────┼──────────┼───────────────┼────────────────────┤];

        while ( y )
            println ("│", x=x+1:7, sql.value ("t_context"));
            y = sql.moveNext ();
        end;
        [└───────┴────────┴──────────┴──────────────┴──────────┴───────────────┴────────────────────┘];
    End;

    Macro run ( namefile, numproc, linestart, lineend, logName, procSize )
        processNumber = numproc;
        if ( not openFile (namefile) )
            return;
        end;

        if ( procSize )
             fSize = procSize;
        end;

        if ( not prepare () )
            msgBox ("Ошибка подготовки");
            return;
        end;

        NeedUpdate = false;//true;
		

        if ( logName )
            setOutput (logName);
        else
            setLog (numproc);
        end;

        printHeader ();

        if ( (linestart) and (linestart > 1) )
            setPosition (linestart);
        end;

        Var i = 0;
//		nextLine ();
        while ( nextLine () )
            clear ();
/*неполный старый формат*/
/*
            loadLine (contractId,    // 1 isEdin,
                      //contr,         // 3             // Поля перепутаны в источнике
                      //client,        // 2             // Поля перепутаны в источнике

                      client,        // 2             // Поля перепутаны в источнике
                      contr,         // 3             // Поля перепутаны в источнике

                      kind,          // 4
                      number,        // 5
                      ordName,       // 6
                      accCode,       // 7
                      begDate,       // 8
                      account,       // 9
                      //subAccount,    //    нет в требования к форматам
                      mmvbCode,      //10
					  isIis
                      //contrvucode,
                      //contractId,    // 1
                      //email, 
                      //psbCode, 
                      //regDate,       //11
                      //isReg, 
                      //shoulder, 
                      //isSpecRepo, 
                      //isNalog, 
                      //isQuik, 
                      //note, 
                      //isNotDepo,
                      //portf, 
                      //isAnbrok, 
                      //closeDate, 
                      //sumAnbrok, 
                      //nameAnbrok, 
                      //startDateIis, 
                      //endDateAnbrok, 
                      //isLostPriv
					  
                      );     */

   
            loadLine (contractId,    // 1 isEdin,
                      //contr,         // 3             // Поля перепутаны в источнике
                      //client,        // 2             // Поля перепутаны в источнике

                      client,        // 2             // Поля перепутаны в источнике
                      contr,         // 3             // Поля перепутаны в источнике

                      kind,          // 4
                      number,        // 5
                      ordName,       // 6
                      accCode,       // 7
                      begDate,       // 8
                      account,       // 9
                      //subAccount,    //    нет в требования к форматам
                      mmvbCode,      //10
                      regDate,       //11
                      email, 
                      isIis,
                      IisFirstDate,
                      FirstBrokName,
                      FirstIisNum,
                      IsAnotherIIS,
                      nameAnBrok, //AnotherBrokName,
                      AnotherIisNum,
                      StartDateIIS, //AnotherIisDate,
                      EndDateAnBrok, //AnotherIisCloseDate,
                      IisYear,
                      IisInMoney,
                      IisOutMoney,
                      FinrezDeduct,
                      FinCons,
                      ServPlace,
                      AccCode2,

                      Tarif,
                      DepoNum,
                      DepoDate,
                      DepoAcc,
                      DepoPart,
					  DepoAccm,
					  DepoPartm
                      //contrvucode,
                      //contractId,    // 1
                      
                      //psbCode, 
                
                      //isReg, 
                      //shoulder, 
                      //isSpecRepo, 
                      //isNalog, 
                      //isQuik, 
                      //note, 
                      //isNotDepo,
                      //portf, 
                      //isAnbrok, 
                      //closeDate, 
                      //sumAnbrok, 
                      //nameAnbrok, 
                      //startDateIis, 
                      //endDateAnbrok, 
                      //isLostPriv
					  
                      );
                      
            if ( error )
                //protokolData.add (1, line, errorStr);
                saveerr (numproc);
            elif ( not save () )
                //protokolData.add (1, line, errorStr);
                saveerr (numproc);
            else
                protokolData.addLine (0, line, contractId, rsId, begDate, number, accounts);
            end;
            if ( (lineend) and (line >= lineend) ) break; end;
        end;

        printLogCommon (numproc, linestart, lineend);
        //printErrors ();
        //printLog ();
        viewFile (setoutput (NULL, TRUE));
    End;

End;
//-----------------------------------------------------------------------------------------

Macro preStep
    if ( execSqlSelect ("select 1 from user_tables where table_name = 'USER_CNVHLPCONTR'").moveNext () )
	    if (not isUpdate) 
          //execSql ("truncate table user_cnvhlpcontr");
		end;
    else
        execSql ("create table user_cnvhlpcontr (t_contrid number, t_diascode varchar2 (30))");
        execSql ("create index user_cnvhlpcontr_idx0 on USER_CNVHLPCONTR (t_diascode)");
    end;
End;
//-----------------------------------------------------------------------------------------

Macro postStep
  if (not isUpdate)
    myExecSql ("insert into user_cnvhlpcontr select to_number (t_documentid), rtrim (utl_raw.cast_to_varchar2 (t_text), chr (0)) from dnotetext_dbt where t_objecttype = 659 and t_notekind = 101");
    myExecSql ("insert into user_cnvhlpcontr select to_number (t_documentid), rtrim (utl_raw.cast_to_varchar2 (t_text), chr (0)) from dnotetext_dbt where t_objecttype = 207 and t_notekind = 101");
  end;
End;
//-----------------------------------------------------------------------------------------