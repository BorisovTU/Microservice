/*
Добавление примечания в заявки клиента на сделку
*/
import activex, oralib, likepy, BankInter, DVInter, globals, rsd,RsbDataSet, PTInter,CTinter;

private const DEALID    = 1,
              VALUE_    = 2;

private macro iif(a,b,c)
    if(a)
        return b;
    else
        return c;
    end;
end;

//Заполняется буферная таблица данными из Excel
macro Load_Note()
  var DealID_Excel:string;
  var DealCode:string = "";
  var FullNameFile = "";
  var FileName = "";
  var TermPath = GetCurDir(true) + "\\TxtFile";
  var Userpath = "";
  var DirName = "";
  var ExtName = "";
  var frow = 1;
  var row = 1;
  var sheet, sql, query_insert, query_check, query_update;
  var valuedate:date =  Date(0, 0, 0);
  var ss = $0;
  var str;
  var DealID,FrVal = 0;
  var day = date();
  var ErrStr = "",ErrStat = false,IsOption = false;
  var all = 0,suc = 0, err = 0;
  var dt = StrSubSt(string(Date()),".","");
  var InfoLogFileName = GetTxtFileName( "load_ss_"+dt);
  var cmd,cmd1;
  var result,result1;
  var Request   = TRecHandler("dl_req.dbt");
  Request.Clear();

  /*Выбираем файл для обработки*/
  //if(not SelectFile(FullNameFile, "$D:\\*.xls*", "Выберите файл для загрузки", 0, true))
  //  MsgBox("Отказ от загрузки");
  //  return 0;
  //end;

  //Отделяем путь файла от имени
  ///splitfile(FullNameFile, FileName, ExtName);
  //FileName = FileName + ExtName;
  //DirName = substr(FullNameFile, 1, index(FullNameFile, FileName) - 1);

  //if (not copyfile("$" + DirName + FileName, "$" + TermPath + "\\" + FileName) )
  //  MsgBox("Ошибка при передаче файла на терминал");
  //end;

  /*Открываем файл*/
  //BegAction(1, "Обработка файла \"" +FullNameFile + "\". Ждите...");

  //if(not OpenExcelFile(FileName, false, true, DirName))
  //  MsgBox("Ошибка открытия файла \"" + DirName + "\\" + FileName + "\"");
  //  EndAction(1);
  //  return 0;
  //end;

  //sheet = ExcelApplication.Sheets(1);

 // SetOutput( InfoLogFileName, true ); //Пишем лог в файл. Начало
 // log.RepHeader(date(),time());
  /*Ищем первую строку*/
  //while(frow <= 5)
  //  if((valtype(sheet.cells(frow, DEALID).value) != V_UNDEF) and  ((strupr(sheet.cells(frow, DEALID).value) == "ID_DEAL")))
  //    break;
  //  end;
  //  frow = frow + 1;
  //end;
  //frow = frow + 1;
  //row = frow;
  //Бежим по файлу
  InitProgress(-1);
  row=0;
 // while (valtype(sheet.cells(row, DEALID).value) != V_UNDEF) 
 //   DealID_Excel = sheet.cells(row, DEALID).value;
 //   ss = sheet.cells(row, VALUE_).value;

   cmd1 = RSDCommand( "  SELECT deal, trader  "+
                      "   FROM temp_infotrader  "
                      );
   cmd1.execute();
   result1 = TRsbDataSet(cmd1);

  while (result1.movenext())
    UseProgress(row);
    cmd = RSDCommand( "  SELECT req.*  "+
                      "   FROM ddvdeal_dbt DVDeal, dspgrdoc_dbt SpGrDoc, dspgrdoc_dbt SpGrReq, "+
                      "        dspground_dbt SpGround,  ddl_req_dbt Req "+
                      "   WHERE  "+
                      "     DVDeal.T_CLIENT != -1 AND   "+
                      "     SpGrDoc.T_SOURCEDOCID = DVDeal.T_ID AND   "+
                      "     SpGround.T_SPGROUNDID = SpGrDoc.T_SPGROUNDID AND  "+
                      "     SpGround.T_KIND = 251 AND  "+
                      "     SpGround.T_SPGROUNDID = SpGrReq.T_SPGROUNDID  AND  "+
                      "     SpGrReq.T_SOURCEDOCID   <> SpGrDoc.T_SOURCEDOCID   AND  "+
                      "     SpGrReq.T_SOURCEDOCKIND <> SpGrDoc.T_SOURCEDOCKIND AND  "+
                      "     SpGrReq.T_SOURCEDOCKIND = Req.T_KIND  AND  "+
                      "     SpGrReq.T_SOURCEDOCID   = Req.T_ID AND     "+
                      "     DVDeal.t_Extcode=TRIM(:extCod) ");
    cmd.addParam( "extCod", RSDBP_IN, result1.value(0));
    cmd.execute();
    result = TRsbDataSet(cmd);

    if (result.movenext())
      result.Getrecord().Copyto(Request.rec);
      if( addNoteForObject( 149, 
                            UniID(Request, 149),
                            102, 
                            result1.value(1), 
                            Request.rec.Date ) )

            RunError("Ошибка при установке примечания  для объекта " );
         end;
    end;  
     Request.Clear();  
    all = all + 1;
    row = row + 1;
  end;
  RemProgress();
//  ExcelApplication.ActiveWorkbook.Close;
  EndAction(1);
onerror()
  //if (valtype(ExcelApplication) != V_UNDEF)
  //  ExcelApplication.ActiveWorkbook.Close;
  //end;
  EndAction(1);
End;

load_note();