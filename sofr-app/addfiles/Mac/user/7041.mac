//╤╧┴.эрўры№эюх Ёх°хэшх 

import globals, oralib, likepy, rsexts;
import captureoutput;
import dbo_spb_mass_open;
import dbo_spb_mass_send;
import dbo_edp_exec;
import MassUnloadQUIK_spb;
import MassUnloadRSHBBroker_spb;

CONST SPB_CODE = "ПАО СПБ";    /* код СПБ */
const XDAY_err_msg = "Ошибка проверки даты запуска";

MACRO u_GetClientID( KOD:string, CodeKind:integer ):INTEGER
  var PartyID;

  PartyID = ПолучитьКодСубъекта( KOD, CodeKind );
  if( PartyID <= 0 )
     return -1;
  end;
  return PartyID;
END;

//var SPBCode = (u_GetClientID( SPB_CODE, PTCK_CONTR ));


private const REGPATH = "РСХБ\\ДИРЕКТОРИИ\\SPBIMPORT";

Private macro CheckSPBDay()
//    return false;
    var stat = 0, XDate = "";
    var XDayRegPath = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ДАТА ВКЛЮЧЕНИЯ СПБ";
    GetRegistryValue(XDayRegPath, V_STRING, XDate, stat); 
    if(stat != 0)
      msgbox("Ошибка при получении значения настройки: " + XDayRegPath);
      return False;
    elif(XDate == "00.00.0000")
      msgbox("Значения настройки: " + XDayRegPath + " не задано.");
      return False;
    elif(Date(XDate) > {Curdate})
      msgbox("Дата включения СПБ еще не наступила.");
      return False;
    end;
    return True;
end;

Private macro CheckEDPDay()
//    return false;
    var stat = 0, XDate = "";
    var XDayRegPath = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ДАТА ВКЛЮЧЕНИЯ ЕДП";
    GetRegistryValue(XDayRegPath, V_STRING, XDate, stat); 
    if(stat != 0)
      msgbox("Ошибка при получении значения настройки: " + XDayRegPath);
      return False;
    elif(XDate == "00.00.0000")
      msgbox("Значения настройки: " + XDayRegPath + " не заданою");
      return False;
    elif(Date(XDate) > {Curdate})
      msgbox("Дата перехода на ЕДП еще не наступила.");
      return False;
    end;
    return True;
end;

private macro GetStrRegVal(regPath:string)
  var stat = 0, path = "";
  GetRegistryValue(regPath, V_STRING, path, stat);
  if(stat != 0)
    msgbox("Ошибка при получении значения настройки: " + regPath);
  elif(path == "")
    stat = 1;
    msgbox("Не задано значение настройки: " + regPath);
  end;
  return path;
end;

class (TArray) TStrCollector
   /*Очистить массив.*/
  macro ClearArray
    this.Size = 0;
  end;
  /*Добавить строку в массив.*/
  macro AddString( Str )
    this.(this.Size) = Str;
  end;
end;

private macro DeleteProcessItem(process:@rsdrecordset, errmsg:@string)
  var exec;
  StartCaptureOutput();
  [
    delete from uProcSPBContr_pr_dbt
    where t_subtype = ?
  ];
  exec = RsdCommand(EndCaptureOutput());
  exec.AddParam("processsubtype", RSDBP_IN, process.value("t_subtype"));
  exec.Execute();
  process.edit();
  process.value("t_isfinish") = "";
  process.value("t_status") = 0;
  process.value("t_statusname") = "Не обработан";
  process.value("t_statusmsg") = "";
  process.update();
  return true;
onError(erru)  
  errmsg = "onError: " + erru.message + " (модуль " + erru.module + ", строка " + erru.line + ")";
  SetDialogFlag(1);
  return false;
end;


macro createOutFile(errmsg:@string, result_protocol:@variant)
var sql, cmd, rs;

  sql = "  select * " +
        "    from (select p.t_partyid, p.t_shortname t_name, " +
        "                 (select oc.t_code " +
        "                    from dobjcode_dbt oc " +
        "                   where     oc.t_objecttype = 3 " +
        "                         and oc.t_codekind = 101 " +
        "                         and oc.t_objectid = p.t_partyid " +
        "                         and oc.t_state = 0) " +
        "                    t_code " +
        "            from dsfcontr_dbt sfc, dparty_dbt p " +
        "           where     sfc.t_partyid = p.t_partyid " +
        "                 and sfc.t_servkind = 0 " +
        "                 and (   sfc.t_dateclose = to_date ('01010001', 'ddmmyyyy') " +
        "                      or sfc.t_dateclose > :dt) " +
//        "                 and p.t_notresident != chr (88) " +
        "                ) t " +
        "group by t.t_partyid, t.t_name, t.t_code; " ;

    cmd = RSDCommand(sql);
    cmd.AddParam("dt", rsdbp_in, date());
    rs = RSDrecordset(cmd, rsdval_client, rsdval_static);
    var   EXPORT_FILENAME_TXT = "SPB_SFContr_OUT.txt";
    var n = 0, nerr = 0;
    var filePath = DL_GetFullPath(GetStrRegVal(REGPATH));
    var   XMLTxt = TStreamDoc(filePath + EXPORT_FILENAME_TXT , "C", "utf8");
      result_protocol.AddString(String("Формирование списка клиентов : "));
      result_protocol.AddString(String("----------------------------------- "));
    while (rs.movenext)
      if (valtype(rs.value("t_code")) != 26/*Specval0*/)
        XMLTxt.writeline(rs.value("t_code"));
        n = n + 1;
      else
        nerr = nerr + 1;
        result_protocol.AddString(String("Ошибка: ", rs.value("t_name"), "(partyid:",rs.value("t_name"),")  Не найден действующий ков ЦФТ."  ));
      end;
    end;
//CopyFile(data_filepath + data_filename, data_file_new_file) )
      result_protocol.AddString(String("----------------------------------- "));
      errmsg ="Создан файл: " + filePath + EXPORT_FILENAME_TXT;
      result_protocol.AddString(String("Обработано ", n, " клиентов." ));
      result_protocol.AddString(String("Зафиксировано ", nerr, " ошибок." ));
      result_protocol.AddString(String("----------------------------------- "));
      result_protocol.AddString(String("Создан файл: " + /*XMLTxt.name*/EXPORT_FILENAME_TXT));

      XMLTxt = null;

//      if(not CopyFile("..\\TXTFILE\\" + EXPORT_FILENAME_TXT , "..\\Export\\" + EXPORT_FILENAME_TXT ))
//         result_protocol.AddString(String("Ошибка копирования файла в директорию экспорта." ));
//      else
//         ReMoveFile("..\\TXTFILE\\" + EXPORT_FILENAME_TXT);
//         result_protocol.AddString(String("Файл размещен в директории экспорта:" + "..\\Export\\" + EXPORT_FILENAME_TXT ));
//      end; 


    return 1;
end;

macro CreateDBO()
end;

private macro Fill_UK_DBO(errmsg:@string, result_protocol:@variant)

  private macro InsAprovContrItem(ClientID, Number, SfcontrID)
    startcaptureoutput;
    	[declare 
    	       v_clientid       uSPBAprovContr_dbt.t_clientid%type  := :p_clientid;
            	v_Number         uSPBAprovContr_dbt.t_number%type    := :p_number;
            	v_sfcontrid      uSPBAprovContr_dbt.t_sfcontrid%type := :p_sfcontrid;
       	       v_retval number := :retval;
    	
             begin
    	    select count(1) into v_retval from uSPBAprovContr_dbt where t_sfcontrid = v_sfcontrid;
    	    if v_retval = 0 then
       	      insert into uSPBAprovContr_dbt(t_clientid, t_number, t_sfcontrid) values(v_clientid,v_number,v_sfcontrid);
    	    end if;
               :retval := v_retval;  
        	    commit;
    	    exception when others then
    	    :retval := -1;       
             end;];
    var sql = endcaptureoutput();
    var cmd = RSDCommand(sql);
        cmd.AddParam( "p_clientid", RSDBP_IN, ClientID );
        cmd.AddParam( "p_number", RSDBP_IN, Number );
        cmd.AddParam( "p_sfcontrid", RSDBP_IN, SFContrID );
        cmd.AddParam( "retval", RSDBP_OUT, V_INTEGER );
        cmd.execute();
        return cmd.value("retval");
  end;

  var sql:String = null, cmd:DL_RsdCommand = null, ds = null;
      
      sql = String( "select cftcode.t_code, sfc.t_number, sfc.t_id\n" 
                   ,"  from dsfcontr_dbt sfc, dobjcode_dbt cftcode\n"  
                   ," where sfc.t_partyid = 114800\n"  
                   ,"   and sfc.t_servkind = 0 and sfc.t_dateclose = to_date('01010001','ddmmyyyy') \n"  
                   ,"   and cftcode.t_objecttype = 3\n"  
                   ,"   and cftcode.t_codekind = 101\n"  
                   ,"   and cftcode.t_objectid = sfc.t_partyid;");
      ds = cmd.execute(sql);
      var n = 0;
      BegAction(0, "Ждите. Идет загрузка списка ....");
      while(ds.movenext())
        InsAprovContrItem(ds.code, ds.number, ds.id);
        result_protocol.AddString(ds.number);
        n = n + 1;
      end;
      endaction(0);
      errmsg = "Выполнено добавление договоров УК";
      result_protocol.AddString("Добавлено: " + n + "  договоров." );
      return 1;

onError(erru)  
     errmsg = "Ошибка обработки.";
  return true;
end;

macro loadAccessFile(errmsg:@string, result_protocol:@variant)
  var sql, cmd, rs;
  var exec;
  FILE inFile() txt;

  private const  OPEN_DIALOG_HEADER = "Выберите файл для загрузки одобренных договоров"; 

  macro insertAprContr(inFile)

        private macro InsAprovContrItem(ClientID, Number, SfcontrID)
        startcaptureoutput;
        	[declare 
        	       v_clientid       uSPBAprovContr_dbt.t_clientid%type  := :p_clientid;
                	v_Number         uSPBAprovContr_dbt.t_number%type    := :p_number;
                	v_sfcontrid      uSPBAprovContr_dbt.t_sfcontrid%type := :p_sfcontrid;
           	       v_retval number := :retval;
        	
                 begin
        	    select count(1) into v_retval from uSPBAprovContr_dbt where t_sfcontrid = v_sfcontrid;
        	    if v_retval = 0 then
           	      insert into uSPBAprovContr_dbt(t_clientid, t_number, t_sfcontrid) values(v_clientid,v_number,v_sfcontrid);
        	    end if;
                   :retval := v_retval;  
            	    commit;
        	    exception when others then
        	    :retval := -1;       
                 end;];
        var sql = endcaptureoutput();
        var cmd = RSDCommand(sql);
            cmd.AddParam( "p_clientid", RSDBP_IN, ClientID );
            cmd.AddParam( "p_number", RSDBP_IN, Number );
            cmd.AddParam( "p_sfcontrid", RSDBP_IN, SFContrID );
            cmd.AddParam( "retval", RSDBP_OUT, V_INTEGER );
            cmd.execute();
            return cmd.value("retval");
        end;

    var sql, cmd, rs;
    var v_cmd =RSDCommand("select t_id from dsfcontr_dbt where t_number = ?");
        v_cmd.AddParam("number",rsdbp_in, inFile(2));
        v_cmd = RSDRecordset(v_cmd, rsdval_client, rsdval_static);
    if(v_cmd.MoveNext())
//        cmd = RSDCommand("Insert into  (T_ClientID, T_NUMBER, T_SFCONTRID) values (?,?,?)");
//        cmd.addparam("clientid",  rsdbp_in,inFile(0));
//        cmd.addparam("number",    rsdbp_in,inFile(2));
//        cmd.addparam("sfcontrid", rsdbp_in,v_cmd.value("T_ID"));
//        cmd.execute;
      InsAprovContrItem(inFile(0),inFile(2),v_cmd.value("T_ID"));
    end;
  end;



  var   IMPORT_FILENAME_TXT = "SPB_SFContr_IN.txt";

  StartCaptureOutput();
[
      DECLARE
         retval    NUMBER := 0;
         sql_crt   VARCHAR2 (1000);
         sql_clr   VARCHAR2 (1000);
      BEGIN
         sql_crt :=
               'CREATE TABLE uSPBAprovContr_dbt '
            || '(t_clientID varchar2(20), T_NUMBER VARCHAR2(100 BYTE), t_sfcontrid number(10))';
         sql_clr := 'truncate table uSPBAprovContr_dbt';

         SELECT COUNT (1)
           INTO retval
           FROM user_tables
          WHERE UPPER (table_name) = 'USPBAPROVCONTR_DBT';

         IF retval = 0
         THEN
            EXECUTE IMMEDIATE (sql_crt);
         END IF;

        /* EXECUTE IMMEDIATE (sql_clr);*/
      END;];

   cmd = RSDCommand(EndCaptureOutput());
   cmd.execute;
   var TermPath = GetCurDir(true) + "\\TxtFile\\";
 
   var filePath = DL_GetFullPath(GetStrRegVal(REGPATH));
   var FullNameFile, fline;

   var n = 0;

    if(Open(inFile, filePath + "SPB_SFContr_IN.txt", "rsansi"))
       setdelim(";");
       while(next(inFile))
         n = n + 1;
         result_protocol.AddString(inFile(0));
         insertAprContr(inFile);
       end;



       BegAction(200, "Ждите. Идет загрузка списка ....");
       EndAction();
       errmsg = "Выполнена загрузка файла " + "SPB_SFContr_IN.txt";
       result_protocol.AddString("Выполнена загрузка файла " + "SPB_SFContr_IN.txt");
       result_protocol.AddString("Обработано: " + n + "  записей." );
       return 1;

    end;

onError(erru)  
  if (erru.code == 42)
     errmsg = "Ошибка открытия файла.";
  end;
  return true;
end;

macro InsertPartyNote(errmsg:@string , result_protocol:@variant)
  var cmd, rs;
  var numNoteKind;
  macro InsertSinglePartyNote(PartyID)
     addNoteForObject( 3, string(PartyID:o:10), numNoteKind, "Да",date());
  end;

  StartCaptureOutput();
  [  declare
       sql_ins varchar2(1000);
       retval number;
       pOBJECTTYPE number := 3;
       pNOTEKIND number;
       pNOTETYPE number := 7;
       pNAME varchar2(100):= 'Допущен к торгам на СПБ'; 
       pKEEPOLDVALUES char := chr(0);
       pNOTINUSE  char := chr(0);
       pISPROTECTED  char := chr(0);
       pMAXLEN number := 5;
       pNOTUSEFIELDUSE char := chr(0);
       pMACRONAME varchar2(20) := '';
       pDECPL number := 0;
       pISPROGONLY char := chr(0);
       res number := 0;
     begin
       sql_ins := 'INSERT INTO dnotekind_dbt VALUES (:OBJECTTYPE,:NOTEKIND,:NOTETYPE,:NAME,:KEEPOLDVALUES,:NOTINUSE,:ISPROTECTED,:MAXLEN,:NOTUSEFIELDUSE,:MACRONAME,:DECPL,:ISPROGONLY)';
       select count(1) into retval from dnotekind_dbt where T_OBJECTTYPE = 3 and T_NAME = 'Допущен к торгам на СПБ';
       if retval = 0 then
         select max (t_notekind) + 1 into pNOTEKIND  from dnotekind_dbt where T_OBJECTTYPE = 3; 
         execute immediate (sql_ins) using pOBJECTTYPE,pNOTEKIND,pNOTETYPE,pNAME,pKEEPOLDVALUES,pNOTINUSE,pISPROTECTED,pMAXLEN,pNOTUSEFIELDUSE,pMACRONAME,pDECPL,pISPROGONLY;
         commit;    
       end if;
       select  t_notekind into res from dnotekind_dbt where T_OBJECTTYPE = 3 and T_NAME = 'Допущен к торгам на СПБ';
       :numnotekind := res;
     end;  ];
  cmd = RSDCommand(EndCaptureOutput());
  cmd.AddParam("NumNoteKind", rsdbp_out, v_integer);
  cmd.Execute;
  numNoteKind  = cmd.Value("NumNoteKind");

  StartCaptureOutput();
  [   SELECT spb.T_NUMBER, sfc.t_partyid 
    FROM uSPBAprovContr_dbt spb, dsfcontr_dbt sfc
   WHERE     spb.t_sfcontrid = sfc.t_id; ];
  cmd = RSDCommand(EndCaptureOutput());

  rs = RSDRecordset(cmd, rsdval_client, rsdval_static);
  var n = 0;
  while(rs.movenext())
     InsertSinglePartyNote(rs.value("t_partyid"));
     n = n + 1;
  end;
  result_protocol.AddString("Выполнена установка примечаний на договора");
  result_protocol.AddString("Обработано: " + n + "  клиентов." );

  errmsg = "Выполнена установка примечаний на договора";
  return 1;

end;


macro ProcessSPB(errmsg:@string, result_protocol:@variant)
  StartCaptureOutput();
  [ SELECT spb.T_NAME, oc.t_objectid, sf.t_id, DL.T_DLCONTRID
    FROM uSPBAprovContr_dbt spb, dobjcode_dbt oc, dsfcontr_dbt sf, ddlcontr_dbt dl
     WHERE     oc.t_objecttype = 3
         AND oc.t_codekind = 101
         AND oc.t_code = spb.t_name
         AND SF.T_PARTYID = oc.t_objectid and sf.t_servkind = 0
         AND (   sf.t_dateclose = TO_DATE ('01010001', 'ddmmyyyy')
              OR sf.t_dateclose > :dt)
         AND DL.T_SFCONTRID = SF.T_ID ; ];
  var cmd = RSDCommand(EndCaptureOutput());
      cmd.AddParam("dt", rsdbp_in, {curdate});
  var rs = RSDRecordset(cmd, rsdval_client, rsdval_static);
  var n = 0;
       while(rs.movenext())
      //       ProcessOne(rs.value("T_DLCONTRID"),rs.value("t_objectid"));
             n = n + 1;
       end;
   result_protocol.AddString("Выполнено.");
   result_protocol.AddString("Обработано: " + n + "  договоров.");
   errmsg = "Выполнено.";
   return 1;
end;

private macro RunProcessItem(process:@rsdrecordset, errmsg:@string)

  var result_comm = tarray();
  var seanceid = 0;
  var resultproc;
  var exec;
  var result_protocol = TStrCollector;

  errmsg = "";

  /*Сохраняем результат*/
  macro SaveResult()

    var i = 0;

    /*Протокол работы*/
    while(i < result_protocol.size)
      StartCaptureOutput();
      [
        declare
          processsubtype number := ?;
          str varchar2(4000) := ?;
          cl clob := null;
        begin
          -- Читаем текущее значение
          begin
            select t_protocol
            into cl
            from uProcSPBContr_pr_dbt 
            where t_subtype = processsubtype 
            for update nowait;
          exception when no_data_found then
            insert into uProcSPBContr_pr_dbt values(processsubtype, null);
          end;
          -- Создаем CLOB при необходимости
          if(cl is null)then
            dbms_lob.createtemporary(cl, true);
          end if;
          -- Дописываем строку в CLOB
          dbms_lob.writeappend(cl, length(str), str);
          -- Сохраняем результат
          update uProcSPBContr_pr_dbt
          set t_protocol = cl
            where t_subtype = processsubtype ;
        end;
      ];
      exec = RsdCommand(EndCaptureOutput());
      exec.AddParam("processsubtype", RSDBP_IN, process.value("t_subtype"));
      exec.AddParam("str", RSDBP_IN, result_protocol.(i) + "\n");
      exec.Execute();
      i = i + 1;
    end;
  end;



  /*Создаем экземпляр процесса*/
  StartCaptureOutput();
  [
    declare
      processsubtype integer := ?;
      process_u uProcSPBContr_dbt%rowtype;
      res integer := 0;
    begin
      begin
        -- Захватываем запись
        select *
        into process_u
        from uProcSPBContr_dbt
        where t_subtype = processsubtype and
              (t_isfinish = chr(0) or t_isfinish = 'S')
        for update nowait;
        -- Результат
        res := process_u.t_count + 1;
      exception when others then
        null;
      end;
      ? := res;
    end;
  ];
  exec = RsdCommand(EndCaptureOutput());
  exec.AddParam("processsubtype", RSDBP_IN, process.value("t_subtype"));
  exec.AddParam("res", RSDBP_OUT, V_INTEGER);
  exec.Execute();
  if((valtype(exec.value("res")) != V_INTEGER) or (exec.value("res") <= 0))
    errmsg = "Процесс уже запущен/выполнен";
    return false;
  end;


  /*Запуск обработки процессов по типам*/
  errmsg = "";
  if(process.value("t_subtype") == 100)
    if (CheckEDPDay())
      resultproc = Exec_EDP_Connect();
    else 
     errmsg = XDAY_err_msg;
     resultproc = true;
    end;

  elif (process.value("t_subtype") == 101)
    if (CheckSPBDay())
      resultproc = createOutFile(@errmsg, @result_protocol);
    else 
     errmsg = XDAY_err_msg;
     resultproc = true;
    end;
 
 elif (process.value("t_subtype") == 102)
    if (CheckSPBDay())
    var ar_menu = TArray();
      ar_menu(0) = "Загрузка списка договоров предоставленных ЦФТ";
      ar_menu(1) = "Получение списка договоров УК";
      var choice = menu(ar_menu);  
      if (choice == 0)
        resultproc = loadAccessFile(@errmsg, @result_protocol);
      elif(choice == 1)
        resultproc = Fill_UK_DBO(@errmsg, @result_protocol);
      end;

    else 
      errmsg = XDAY_err_msg;
      resultproc = true;
    end;
    
  elif (process.value("t_subtype") == 103)
    if (CheckSPBDay())
      resultproc = InsertPartyNote(@errmsg, @result_protocol);
    else 
      errmsg = XDAY_err_msg;
      resultproc = true;
    end;

  elif (process.value("t_subtype") == 104)
    if (CheckSPBDay())
      resultproc = Exec_SPB_Mass_Open();
    else 
      errmsg = XDAY_err_msg;
      resultproc = true;
    end;

  elif (process.value("t_subtype") == 105)
    if (CheckSPBDay())
      resultproc = Exec_SPB_Mass_Send();
    else 
      errmsg = XDAY_err_msg;
      resultproc = true;
    end;

  elif (process.value("t_subtype") == 106)
    if (CheckSPBDay())
      resultproc = execMassUnloadQUIK_spb();
      errmsg = "Выполнено!";
    else 
      errmsg = XDAY_err_msg;
      resultproc = true;
    end;

  elif (process.value("t_subtype") == 107)
    if (CheckSPBDay())
      resultproc = execMassUnloadRSHBBroker_spb();
      errmsg = "Выполнено!";
    else 
      errmsg = XDAY_err_msg;
      resultproc = true;
    end;


  else
    errmsg = "Неизвестный процесс " + process.value("t_subtype");
    resultproc = false;
  end; 
  if(not resultproc)
     errmsg = "Неизвестная ошибка при обработке процесса";
  else
      SaveResult();
      process.edit();
      process.value("t_isfinish") = "X";
      process.value("t_status") = 10;
    if (errmsg != XDAY_err_msg )
      process.value("t_statusname") = "Обработан";
    else 
      process.value("t_statusname") = "Обработан с предупреждениями";
    end;
      process.value("t_statusmsg") = substr(errmsg,1,200);
      process.update();

  end;
  return true;
end;

  macro eInfoDialog(rs, cmd, id, key)

    file ReportOutFile() txt write;
    var ReportFileName;


    if(cmd == DLG_KEY)
      /*Esc*/
      if(key == 27)
        return CM_CANCEL;
      elif(key == 13)
        if(rs.RecCount > 0)
          var cmdLog, rsLog, strLog;
          var cmdLogs, rsLogs;
          var DLComm;
          var ind = 1, deltaind = 1024, idec;

            ReportFileName = GetTxtFileName("protocol");
            if(not Open(ReportOutFile, ReportFileName))
              msgboxex("Ошибка при открытии файла отчета|"+ReportFileName);
            end;
            strLog = "";
            while(ind > 0)
              StartCaptureOutput();
              [
                select nvl(dbms_lob.substr(process_oper_u.t_protocol, ?, ?),' ') t_log
                from uProcSPBContr_pr_dbt process_oper_u
                where process_oper_u.t_subtype = ?
              ];
              cmdLog = DL_RsdCommand(EndCaptureOutput());
              cmdLog.AddParam(deltaind);
              cmdLog.AddParam(1 + deltaind * (ind - 1));
              cmdLog.AddParam(rs.value("t_subtype"));
              rsLog = cmdLog.Execute();
              if((rsLog.moveNext()) and (rsLog.value("t_log") != " "))
                strLog = strLog + rsLog.value("t_log");
                while(index(strLog, "\n") > 0)
                  idec = index(strLog, "\n");
                  insert(ReportOutFile, substr(strLog, 1, idec-1));
                  strLog = substr(strLog, idec+1);
                end;
                ind = ind + 1;
              else
                if(strlen(strLog) > 0)
                  insert(ReportOutFile, strLog);
                end;
                ind = 0;
              end;
            end;
            close(ReportOutFile);
            viewfile(ReportFileName);



        end;
      end;
    end;
  end;


private macro RunProcess()

  var errmsg;
  var inprocessprogress = 0;

  macro makeArray():TArray
    var parm:variant, i:integer = 0, result:TArray = TArray( ParmCount(), ParmCount() );
    while( GetParm(i, parm) )
      result.value(i) = parm;
      i = i + 1;
    end;
    return result;
  end;

  var SaveNum = 0;
  macro eRunProcessDialog(rs, cmd, id, key)

    if(cmd == DLG_INIT)
      /*Позиционируемся*/
      if(SaveNum > 0)
        while(rs.movenext)
          if(SaveNum == rs.value("t_num"))
            GoToScroll(rs);
            break;
          end;
        end;
      end;
    elif(cmd == DLG_KEY)
      /*Esc*/
      if(key == 27)
        return CM_CANCEL;
      /*F2*/
      elif(key == 316)
        if((rs.value("t_isfinish") != "") and (rs.value("t_isfinish") != "S"))
          msgboxex("Процесс '" + rs.value("t_name") + "' обработан");
        elif(msgboxex("Выполнить обработку процесса '" + rs.value("t_name") + "'?", MB_YES + MB_NO, IND_YES) == IND_YES)
          BegAction(1, rs.value("t_name") + ". Ждите...");
          if(not RunProcessItem( @rs, @errmsg))
            updatescroll(rs, 5);
            EndAction(1);
            msgboxex("Ошибка при выполнении процесса '" + rs.value("t_name") + "'|" + errmsg);
          else
            EndAction(1);
            updatescroll(rs, 5);
          end;
        end;
        return CM_IGNORE;
      /*F8*/
      elif(key == 322)
        if(rs.value("t_isfinish") == "")
          msgboxex("Процесс '" + rs.value("t_name") + "' не обработан");
        elif(msgboxex("Удалить обработку процесса '" + rs.value("t_name") + "'?", MB_YES + MB_NO, IND_YES) == IND_YES)
          if(not DeleteProcessItem(@rs, @errmsg))
            updatescroll(rs, 5);
            msgboxex("Ошибка при удалении обработки процесса '" + rs.value("t_name") + "'|" + errmsg);
          else
            updatescroll(rs, 5);
          end;
        end;
        return CM_IGNORE;
//----------------------------
      /*Enter*/
      elif(key == 13)
        var cmdinfo, rsinfo;
        if(rs.value("t_isfinish") != "")

            StartCaptureOutput();
            [
              select chr(1) t_oprcode, 
                     'Протокол работы процедуры' t_oprname, 
                     chr(1) t_oprstatus,
                     process_oper_u.t_subtype
              from uProcSPBContr_pr_dbt process_oper_u
              where process_oper_u.t_subtype = ? 
            ];
            cmdInfo = RsdCommand(EndCaptureOutput());

          cmdInfo.AddParam("processsubtype", RSDBP_IN, rs.value("t_subtype"));
          rsInfo = RSDRecordset(cmdInfo, RSDVAL_CLIENT, RSDVAL_STATIC);
          RunScroll(rsInfo, 3, MakeArray("t_oprcode", "Код", 25, 2, -1, 0,
                                         "t_oprname", "Наименование", 30, 2, -1, 0,  
                                         "t_oprstatus", "Состояние", 20, 2, -1, 0), 
                    "_eInfoDialog", "eInfoDialog", rs.value("t_name"), "~Enter~ Информация ~Esc~ Выход", true);
        end;
        return CM_IGNORE;


//----------------------------
      end;
    end;
  end;


  var sql, cmd, rs;
  var exec;
  sql = "declare " +
        " retval number := 0; " +
        " sql_crt varchar2(1000); " +
        "begin " +
        "sql_crt := 'CREATE TABLE uProcSPBContr_dbt '|| " +
        "           '( T_SUBTYPE       NUMBER(5), T_NUM  NUMBER(5),'|| " +
        "           'T_NAME          VARCHAR2(100 BYTE), '|| " +
        "           'T_STATUS        NUMBER, '|| " +
        "           'T_STATUSNAME    VARCHAR2(30 BYTE), T_ISFINISH  CHAR(1 BYTE), T_COUNT  NUMBER(10),'|| " +
        "           'T_STATUSMSG     VARCHAR2(200 BYTE)) '; " +
        " " +
        "select count(1) into retval from user_tables where upper (table_name) = 'UPROCSPBCONTR_DBT'; " +
        "if retval = 0 then " +
        "  execute immediate (sql_crt); " +
        "end if;  " +
        "end; " ;
   cmd = RSDCommand(sql);
   cmd.execute;

  StartCaptureOutput();
  [
    declare
    begin
        merge into uProcSPBcontr_dbt p
        using
        (select t_subtype, t_num, t_status, t_isfinish, t_name
         from (select 100 t_subtype,  1 t_num, '------------' t_status, chr(0) t_isfinish, 'ЕДП.Подключение к единой денежной позиции' t_name from dual union all
               select 101 t_subtype,  2 t_num, 'Не обработан' t_status, chr(0) t_isfinish, 'СПБ.Формирование списка договоров в адрес ЦФТ' t_name from dual union all
               select 102 t_subtype,  3 t_num, 'Не обработан' t_status, chr(0) t_isfinish, 'СПБ.Загрузка списка договоров' t_name from dual union all
               select 104 t_subtype,  4 t_num, '------------' t_status, chr(0) t_isfinish, 'СПБ.Добавление площадки обслуживания' t_name from dual  union all
               select 105 t_subtype,  5 t_num, '------------' t_status, chr(0) t_isfinish, 'СПБ.Регистрация площадок обслуживания' t_name from dual union all
               select 106 t_subtype,  6 t_num, '------------' t_status, chr(0) t_isfinish, 'СПБ.Массовая выгрузка в Quik' t_name from dual union all
               select 107 t_subtype,  7 t_num, '------------' t_status, chr(0) t_isfinish, 'СПБ.Массовая выгрузка в РСХБ-Брокер' t_name from dual  )) p_new
        on ( p.t_subtype = p_new.t_subtype)
        when not matched then
          insert values(p_new.t_subtype, p_new.t_num, p_new.t_name, 0, p_new.t_status, p_new.t_isfinish, 0,chr(1));
    end;
  ];
  exec = RsdCommand(EndCaptureOutput());
  exec.Execute();

  var cmdQuery, cmdScroll, rsScroll;

  StartCaptureOutput();
  [
    select *
    from uProcSPBContr_dbt
    order by t_num, t_name
  ];
  cmdQuery = EndCaptureOutput();
  cmdScroll = RsdCommand(cmdQuery);
  rsScroll = RSDRecordset(cmdScroll, RSDVAL_CLIENT, RSDVAL_STATIC);
  while(RunScroll(rsScroll, 4, MakeArray("t_num", "№", 2, 2, -1, 0,
                                         "t_name", "Процесс", 40, 2, 2, 0, 
                                         "t_statusname", "Состояние", 17, 2, -1, 0, 
                                         "t_statusmsg", "", 50, 2, -1, 0), 
                        "eRunProcessDialog", "eRunProcessDialog", "ЕДП/СПБ. Начальное решение ", "~F2~ Обработать ~F8~ Сбросить ошибку", true))

    cmdScroll = RsdCommand(cmdQuery);
    rsScroll = RSDRecordset(cmdScroll, RSDVAL_CLIENT, RSDVAL_STATIC);
  end;




end;
runprocess();
exit(1);
