import rsd, captureoutput;

private var erru;


/*Создание сеанса*/
macro CreateSeance(opernum, kind, appfrom, appto, status, objkind, errmsg:@string, isparty)
  private macro CheckErrorRecord(appfrom, appto, status, objkind, errmsg:@string)
    var cmd, rs;
    StartCaptureOutput();
    [select count(1) as ErrRecs from dgtrecord_dbt gtrecord
                    join dgtobject_dbt gtobject on gtobject.t_objectid = gtrecord.t_objectid and 
                                                   gtobject.t_objectkind = ?
                    where gtrecord.t_applicationid_from = ? and
                          gtrecord.t_applicationid_to = ? and
                          gtrecord.t_statusid = 4
                                 and(  ((? = 1) and (gtrecord.t_clientid = 0))
                                 OR   ((? = -1) and (gtrecord.t_clientid != 0))
                                 OR   ((? = 0))
                                 );

    ];
    cmd = RSDCommand(EndCaptureOutput());
    cmd.AddParam("objkind", RSDBP_IN, objkind);
    cmd.AddParam("appfrom", RSDBP_IN, appfrom);
    cmd.AddParam("appto", RSDBP_IN, appto);
    cmd.AddParam("isparty1", RSDBP_IN, isparty);
    cmd.AddParam("isparty2", RSDBP_IN, isparty);
    cmd.AddParam("isparty3", RSDBP_IN, isparty);
    rs = RSDRecordset(cmd, rsdval_client, rsdval_static);
    if(rs.movenext)
      if(rs.value("ErrRecs") > 0)
        errmsg = "Найдены записи репликации в статусе \"Отказ в обработке\". Переведите их в статус \"Готов к обработке\" или \"Отвергнут\"."; 
        return false;
      end;
    end;
    return true;
  end;

  var seanceid, cmd;

  if ((not IsShedulerRunning()) and (not CheckErrorRecord(appfrom, appto, status, objkind, @errmsg)))
    return -100;
  end;

  /*Создаем сеанс*/
  StartCaptureOutput();
  [
    declare   
      v_opernum number(10) := ?;
      v_kind number(10) := ?;
      v_applicationid_from number(10) := ?;
      v_applicationid_to number(10) := ?;
      v_statusid number(10) := ?;
      v_objectkind number(10) := ?;
      v_SeanceID number(10) := 0; 
      v_errmsg varchar(200);
      v_isparty number(10) := ?;
      ErrRecs number(10) := 0;
    begin
      begin
        if(v_statusid > 0)then
          for r in (select gtrecord.t_recordid t_recordid, gtrecord.t_objectid t_objectid
                    from dgtrecord_dbt gtrecord
                    join dgtobject_dbt gtobject on gtobject.t_objectid = gtrecord.t_objectid and 
                                                   gtobject.t_objectkind = v_objectkind 
                    where gtrecord.t_applicationid_from = v_applicationid_from and
                          gtrecord.t_applicationid_to = v_applicationid_to and
                          gtrecord.t_statusid = v_statusid
                                 and(  ((v_isparty = 1) and (gtrecord.t_clientid = 0))
                                 OR   ((v_isparty = -1) and (gtrecord.t_clientid != 0))
                                 OR   ((v_isparty = 0))
                                 )
                   )
          loop
            -- Вставляем сеанс
            if(v_SeanceID = 0)then
              insert into dgtseance_dbt(T_DIRECTION, T_KIND, T_APPLICATIONID, T_RECORDSTATUS, T_ISOPERSTARTUP, T_STARTID, T_SYSDATE, T_SYSTIME)
              values(1/*импорт*/, v_kind, v_applicationid_from, v_statusid, chr(0), v_opernum, trunc(sysdate), to_date('01.01.0001 '||to_char(sysdate,'hh24:mi:ss'), 'dd.mm.yyyy hh24:mi:ss'))
              returning t_seanceid into v_SeanceID;
            end if;
            -- Связываем запись репликации с сеансом
            insert into dgtsncrec_dbt(T_SEANCEID, T_RECORDID, T_OBJECTID)
            values(v_SeanceID, r.t_recordid, r.t_objectid);
          end loop;
        else
          insert into dgtseance_dbt(T_DIRECTION, T_KIND, T_APPLICATIONID, T_RECORDSTATUS, T_ISOPERSTARTUP, T_STARTID, T_SYSDATE, T_SYSTIME)
          values(1/*импорт*/, v_kind, v_applicationid_from, v_statusid, chr(0), v_opernum, trunc(sysdate), to_date('01.01.0001 '||to_char(sysdate,'hh24:mi:ss'), 'dd.mm.yyyy hh24:mi:ss'))
          returning t_seanceid into v_SeanceID;
        end if;
      exception when others then
        rollback;
        v_errmsg := substr(sqlerrm, 1, 200);
        v_SeanceID := -99;
      end;
      ? := v_SeanceID;
      ? := v_errmsg;
    end;
  ];
  cmd = RSDCommand(EndCaptureOutput());
  cmd.AddParam("opernum", RSDBP_IN, opernum);
  cmd.AddParam("kind", RSDBP_IN, kind);
  cmd.AddParam("appfrom", RSDBP_IN, appfrom);
  cmd.AddParam("appto", RSDBP_IN, appto);
  cmd.AddParam("status", RSDBP_IN, status);
  cmd.AddParam("objkind", RSDBP_IN, objkind);
  cmd.AddParam("isparty", RSDBP_IN, isparty);
  cmd.AddParam("seanceid", RSDBP_OUT, V_INTEGER);
  cmd.AddParam("errmsg", RSDBP_IN_OUT, "");


  cmd.Execute();
  seanceid = cmd.value("seanceid");
  if((valtype(seanceid) != V_INTEGER) or (seanceid < 0))
    errmsg = cmd.value("errmsg");
    if((valtype(errmsg) != V_STRING) or (strlen(errmsg) <= 0))
      errmsg = "Неизвестная ошибка при создании сеанса";
    end;
    if(valtype(seanceid) != V_INTEGER)
      return -97;
    else
      return seanceid;
    end;
  else
    errmsg = "";
    return seanceid;
  end;
onError(erru)
  errmsg = "onError: " + erru.message + " (модуль " + erru.module + ", строка " + erru.line + ")";
  return -98;
end;


/*Завершение сеанса*/
macro FinishSeance(seanceid, recs:@integer, errrecs:@integer, errmsg:@string, wrnrecs:@integer)
  var cmd;
  /*Завершаем сеанс*/
  StartCaptureOutput();
  [
    declare   
      v_seanceid number(10) := ?;
      v_recs number(10) := 0;
      v_errrecs number(10) := 0;
      v_wrnrecs number(10) := 0;
      v_errmsg varchar(200);
    begin
      begin
        -- Считаем число записей репликации и ошибок
        select nvl(gtseance.t_errorcount,0) t_errrecs,
               nvl(gtseance.t_warningcount,0) t_wrnrecs, 
               (select count(1) 
                from dgtsncrec_dbt gtsncrec 
                where gtsncrec.t_seanceid = gtseance.t_seanceid) t_recs
        into v_errrecs, v_wrnrecs, v_recs
        from dgtseance_dbt gtseance
        where t_seanceid = v_seanceid;
        -- Проставляем дату и время окончания сеанса
        update dgtseance_dbt
        set t_enddate = trunc(sysdate),
            t_endtime = to_date('01.01.0001 '||to_char(sysdate,'hh24:mi:ss'), 'dd.mm.yyyy hh24:mi:ss')
        where t_seanceid = v_seanceid;
      exception when others then
        rollback;
        v_errmsg := substr(sqlerrm, 1, 200);
        v_recs := -59;
      end;
      ? := v_recs;
      ? := v_errrecs;
      ? := v_errmsg;
      ? := v_wrnrecs;
    end;
  ];
  cmd = RSDCommand(EndCaptureOutput());
  cmd.AddParam("seanceid", RSDBP_IN, seanceid);
  cmd.AddParam("recs", RSDBP_OUT, V_INTEGER);
  cmd.AddParam("errrecs", RSDBP_OUT, V_INTEGER);
  cmd.AddParam("errmsg", RSDBP_IN_OUT, "                                                                                                                                                                                                                            ");
  cmd.AddParam("wrnrecs", RSDBP_OUT, V_INTEGER);
  cmd.Execute();
  recs = cmd.value("recs");
  errrecs = cmd.value("errrecs");
  wrnrecs = cmd.value("wrnrecs");
  if((valtype(seanceid) != V_INTEGER) or (recs < 0))
    errmsg = cmd.value("errmsg");
    if((valtype(errmsg) != V_STRING) or (strlen(errmsg) <= 0))
      errmsg = "Неизвестная ошибка при завершении сеанса";
    end;
    if(valtype(recs) != V_INTEGER)
      return -69;
    else
      return recs;
    end;
  else
    errmsg = "";
    return recs;
  end;
onError(erru)
  errmsg = "onError: " + erru.message + " (модуль " + erru.module + ", строка " + erru.line + ")";
  return -79;
end;


/*Обработка ЗР в статусе 'Готов к обработке' для вида объекта*/
/*Возвращаети число записей репликации и -1 при ошибке*/
macro ProcessBO(app, opernum, objkind, seanceid:@integer, recs:@integer, errrecs:@integer, errmsg:@string, wrnrecs:@integer, IsParty)
  recs = 0;
  errrecs = 0;
  wrnrecs = 0;
  errmsg = "";
/*IsParty == 0 то по всем, IsParty == 1 то по собственным, IsParty = -1 то по клиентским*/
  If(valtype(IsParty) == v_undef)
      IsParty = 0;
  end;

  /*Создаем сеанс*/
  seanceid = CreateSeance(opernum,
                          2,   /*Из шлюза в БО*/
                          app,
                          11,  /*SRC-1 RS-Bank V.6 release 20*/
                          2,   /*Готов к обработке*/
                          objkind, 
                          @errmsg, IsParty);
  if(seanceid < 0)
    /*Транслируем ошибку*/
    errmsg = errmsg + " (" + seanceid + ")";
    return false;
  elif(seanceid == 0)
    /*Нет объектов для обработки*/
    return true;
  end;
  
  /*Запускаем обработку сеанса*/
  ExecMacroFile("gtBOsend", "Process", seanceid, "");

  /*Завершаем сеанс*/
  FinishSeance(seanceid, @recs, @errrecs, @errmsg, @wrnrecs);

  /*Возвращаем результат*/
  return true;
onError(erru)  
  errmsg = "onError: " + erru.message + " (модуль " + erru.module + ", строка " + erru.line + ")";
  return false;
end;


/*Загрузка gtImMVB4*/
macro ReceiveMVB4(opernum, parms, seanceid:@integer, recs:@integer, errrecs:@integer, errmsg:@string, wrnrecs:@integer)
  recs = 0;
  errrecs = 0;
  wrnrecs = 0;
  errmsg = "";

  /*Создаем сеанс*/
  seanceid = CreateSeance(opernum,
                          1,   /*Из файлов в шлюз*/
                          112, /*SRC-12 MOEX, xml-формат*/
                          11,  /*SRC-1 RS-Bank V.6 release 20*/
                          0,   /*Новые*/
                          0, 
                          @errmsg);
  if(seanceid < 0)
    /*Транслируем ошибку*/
    errmsg = errmsg + " (" + seanceid + ")";
    return false;
  elif(seanceid == 0)
    /*Нет объектов для обработки*/
    return true;
  end;

  /*Запускаем обработку сеанса*/
  ExecMacroFile("gtImMVB4", "Receive", seanceid, parms, true);

  /*Завершаем сеанс*/
  FinishSeance(seanceid, @recs, @errrecs, @errmsg, @wrnrecs);

  /*Возвращаем результат*/
  return true;
onError(erru)  
  errmsg = "onError: " + erru.message + " (модуль " + erru.module + ", строка " + erru.line + ")";
  return false;
end;

/*Загрузка СПБ*/
macro ReceiveSPB4(opernum, parms, seanceid:@integer, recs:@integer, errrecs:@integer, errmsg:@string, wrnrecs:@integer)
  recs = 0;
  errrecs = 0;
  wrnrecs = 0;
  errmsg = "";

  /*Создаем сеанс*/
  seanceid = CreateSeance(opernum,
                          1,   /*Из файлов в шлюз*/
                          131, /*SRC-27 ПАО СПБ, xml-формат*/
                          11,  /*SRC-1 RS-Bank V.6 release 20*/
                          0,   /*Новые*/
                          0, 
                          @errmsg);
  if(seanceid < 0)
    /*Транслируем ошибку*/
    errmsg = errmsg + " (" + seanceid + ")";
    return false;
  elif(seanceid == 0)
    /*Нет объектов для обработки*/
    return true;
  end;

  /*Запускаем обработку сеанса*/
  ExecMacroFile("gtImSPB4", "Receive", seanceid, parms, true);

  /*Завершаем сеанс*/
  FinishSeance(seanceid, @recs, @errrecs, @errmsg, @wrnrecs);

  /*Возвращаем результат*/
  return true;
onError(erru)  
  errmsg = "onError: " + erru.message + " (модуль " + erru.module + ", строка " + erru.line + ")";
  return false;
end;

/*Загрузка gtImCVVR*/
macro ReceiveCVVR(opernum, parms, seanceid:@integer, recs:@integer, errrecs:@integer, errmsg:@string, wrnrecs:@integer)
  recs = 0;
  errrecs = 0;
  wrnrecs = 0;
  errmsg = "";

  /*Создаем сеанс*/
  seanceid = CreateSeance(opernum,
                          1,   /*Из файлов в шлюз*/
                          129, /*MOEX_Комиссионные вознаграждения по валютному рынку, xml-формат*/
                          11,  /*SRC-1 RS-Bank V.6 release 20*/
                          0,   /*Новые*/
                          0, 
                          @errmsg);
  if(seanceid < 0)
    /*Транслируем ошибку*/
    errmsg = errmsg + " (" + seanceid + ")";
    return false;
  elif(seanceid == 0)
    /*Нет объектов для обработки*/
    return true;
  end;

  /*Запускаем обработку сеанса*/
  ExecMacroFile("gtImCVVR", "Receive", seanceid, parms, true);

  /*Завершаем сеанс*/
  FinishSeance(seanceid, @recs, @errrecs, @errmsg, @wrnrecs);

  /*Возвращаем результат*/
  return true;
onError(erru)  
  errmsg = "onError: " + erru.message + " (модуль " + erru.module + ", строка " + erru.line + ")";
  return false;
end;

/*Загрузка gtImCSV*/
macro ReceiveCSV(opernum, parms, seanceid:@integer, recs:@integer, errrecs:@integer, errmsg:@string, wrnrecs:@integer)
  recs = 0;
  errrecs = 0;
  wrnrecs = 0;
  errmsg = "";

  /*Создаем сеанс*/
  seanceid = CreateSeance(opernum,
                          1,   /*Из файлов в шлюз*/
                          119, /*SRC-19 MOEX, csv-формат*/
                          11,  /*SRC-1 RS-Bank V.6 release 20*/
                          0,   /*Новые*/
                          0, 
                          @errmsg);
  if(seanceid < 0)
    /*Транслируем ошибку*/
    errmsg = errmsg + " (" + seanceid + ")";
    return false;
  elif(seanceid == 0)
    /*Нет объектов для обработки*/
    return true;
  end;

  /*Запускаем обработку сеанса*/
  ExecMacroFile("gtImCSV", "Receive", seanceid, parms, true);

  /*Завершаем сеанс*/
  FinishSeance(seanceid, @recs, @errrecs, @errmsg, @wrnrecs);

  /*Возвращаем результат*/
  return true;
onError(erru)  
  errmsg = "onError: " + erru.message + " (модуль " + erru.module + ", строка " + erru.line + ")";
  return false;
end;

/*Загрузка gtImCSVP*/
macro ReceiveCSVP(opernum, parms, seanceid:@integer, recs:@integer, errrecs:@integer, errmsg:@string, wrnrecs:@integer)
  recs = 0;
  errrecs = 0;
  wrnrecs = 0;
  errmsg = "";

  /*Создаем сеанс*/
  seanceid = CreateSeance(opernum,
                          1,   /*Из файлов в шлюз*/
                          136, /*SRC-31 MOEX_Срочный рынок, Шлюз PAYMENTS*/
                          11,  /*SRC-1 RS-Bank V.6 release 20*/
                          0,   /*Новые*/
                          0, 
                          @errmsg);
  if(seanceid < 0)
    /*Транслируем ошибку*/
    errmsg = errmsg + " (" + seanceid + ")";
    return false;
  elif(seanceid == 0)
    /*Нет объектов для обработки*/
    return true;
  end;

  /*Запускаем обработку сеанса*/
  ExecMacroFile("gtImCSVP", "Receive", seanceid, parms, true);

  /*Завершаем сеанс*/
  FinishSeance(seanceid, @recs, @errrecs, @errmsg, @wrnrecs);

  /*Возвращаем результат*/
  return true;
onError(erru)  
  errmsg = "onError: " + erru.message + " (модуль " + erru.module + ", строка " + erru.line + ")";
  return false;
end;

/*Загрузка gtImCX99*/
macro ReceiveCX99(opernum, parms, seanceid:@integer, recs:@integer, errrecs:@integer, errmsg:@string, wrnrecs:@integer)
  recs = 0;
  errrecs = 0;
  wrnrecs = 0;
  errmsg = "";

  /*Создаем сеанс*/
  seanceid = CreateSeance(opernum,
                          1,   //Из файлов в шлюз
                          1001, //SRC-99 Загрузка CCX99 валютная брокерка
                          11,  //SRC-1 RS-Bank V.6 release 20
                          0,   //Новы
                          0, 
                          @errmsg);
  if(seanceid < 0)
    /*Транслируем ошибку*/
    errmsg = errmsg + " (" + seanceid + ")";
    return false;
  elif(seanceid == 0)
    /*Нет объектов для обработки*/
    return true;
  end;

  /*Запускаем обработку сеанса*/
  ExecMacroFile("gtImCX99", "Receive", seanceid, parms, true);

  /*Завершаем сеанс*/
  FinishSeance(seanceid, @recs, @errrecs, @errmsg, @wrnrecs);

  /*Возвращаем результат*/
  return true;
onError(erru)  
  errmsg = "onError: " + erru.message + " (модуль " + erru.module + ", строка " + erru.line + ")";
  return false;
end;

/*Загрузка gtImICVR*/
macro ReceiveICVR(opernum, parms, seanceid:@integer, recs:@integer, errrecs:@integer, errmsg:@string, wrnrecs:@integer)
  recs = 0;
  errrecs = 0;
  wrnrecs = 0;
  errmsg = "";

  /*Создаем сеанс*/
  seanceid = CreateSeance(opernum,
                          1,   //Из файлов в шлюз
                          127, //SRC-23 MOEX_Итоги клиринга по валютному рынку, xml-формат
                          11,  //SRC-1 RS-Bank V.6 release 20
                          0,   //Новые
                          0, 
                          @errmsg);
  if(seanceid < 0)
    /*Транслируем ошибку*/
    errmsg = errmsg + " (" + seanceid + ")";
    return false;
  elif(seanceid == 0)
    /*Нет объектов для обработки*/
    return true;
  end;

  /*Запускаем обработку сеанса*/
  ExecMacroFile("gtImICVR", "Receive", seanceid, parms, true);

  /*Завершаем сеанс*/
  FinishSeance(seanceid, @recs, @errrecs, @errmsg, @wrnrecs);

  /*Возвращаем результат*/
  return true;
onError(erru)  
  errmsg = "onError: " + erru.message + " (модуль " + erru.module + ", строка " + erru.line + ")";
  return false;
end;

/*Загрузка gtImVR*/
macro Receive__VR(opernum, parms, seanceid:@integer, recs:@integer, errrecs:@integer, errmsg:@string, wrnrecs:@integer)
  recs = 0;
  errrecs = 0;
  wrnrecs = 0;
  errmsg = "";

  /*Создаем сеанс*/
  seanceid = CreateSeance(opernum,
                          1,   //Из файлов в шлюз
                          118, //SRC-18 MOEX,валютный рынок xml-формат
                          11,  //SRC-1 RS-Bank V.6 release 20
                          0,   //Новые
                          0, 
                          @errmsg);
  if(seanceid < 0)
    /*Транслируем ошибку*/
    errmsg = errmsg + " (" + seanceid + ")";
    return false;
  elif(seanceid == 0)
    /*Нет объектов для обработки*/
    return true;
  end;

  /*Запускаем обработку сеанса*/
  ExecMacroFile("gtImVR", "Receive", seanceid, parms, true);

  /*Завершаем сеанс*/
  FinishSeance(seanceid, @recs, @errrecs, @errmsg, @wrnrecs);

  /*Возвращаем результат*/
  return true;
onError(erru)  
  errmsg = "onError: " + erru.message + " (модуль " + erru.module + ", строка " + erru.line + ")";
  return false;
end;

/*Загрузка gtImPMTS*/
macro ReceivePMTS(opernum, parms, seanceid:@integer, recs:@integer, errrecs:@integer, errmsg:@string, wrnrecs:@integer)
  recs = 0;
  errrecs = 0;
  wrnrecs = 0;
  errmsg = "";

  /*Создаем сеанс*/
  seanceid = CreateSeance(opernum,
                          1,   /*Из файлов в шлюз*/
                          133, /*SRC-28 ММВБ, Шлюз PAYMENTS*/
                          11,  /*SRC-1 RS-Bank V.6 release 20*/
                          0,   /*Новые*/
                          0, 
                          @errmsg);
  if(seanceid < 0)
    /*Транслируем ошибку*/
    errmsg = errmsg + " (" + seanceid + ")";
    return false;
  elif(seanceid == 0)
    /*Нет объектов для обработки*/
    return true;
  end;

  /*Запускаем обработку сеанса*/
  ExecMacroFile("gtImPMTS", "Receive", seanceid, parms, true);

  /*Завершаем сеанс*/
  FinishSeance(seanceid, @recs, @errrecs, @errmsg, @wrnrecs);

  /*Возвращаем результат*/
  return true;
onError(erru)  
  errmsg = "onError: " + erru.message + " (модуль " + erru.module + ", строка " + erru.line + ")";
  return false;
end;

/*Загрузка gtImSpbP*/
macro ReceiveSpbP(opernum, parms, seanceid:@integer, recs:@integer, errrecs:@integer, errmsg:@string, wrnrecs:@integer)
  recs = 0;
  errrecs = 0;
  wrnrecs = 0;
  errmsg = "";

  /*Создаем сеанс*/
  seanceid = CreateSeance(opernum,
                          1,   /*Из файлов в шлюз*/
                          134, /*SRC-29 ПАО СПБ, Шлюз PAYMENTS*/
                          11,  /*SRC-1 RS-Bank V.6 release 20*/
                          0,   /*Новые*/
                          0, 
                          @errmsg);
  if(seanceid < 0)
    /*Транслируем ошибку*/
    errmsg = errmsg + " (" + seanceid + ")";
    return false;
  elif(seanceid == 0)
    /*Нет объектов для обработки*/
    return true;
  end;

  /*Запускаем обработку сеанса*/
  ExecMacroFile("gtImSpbP", "Receive", seanceid, parms, true);

  /*Завершаем сеанс*/
  FinishSeance(seanceid, @recs, @errrecs, @errmsg, @wrnrecs);

  /*Возвращаем результат*/
  return true;
onError(erru)  
  errmsg = "onError: " + erru.message + " (модуль " + erru.module + ", строка " + erru.line + ")";
  return false;
end;

/*Загрузка gtImVRPM*/
macro ReceiveVRPM(opernum, parms, seanceid:@integer, recs:@integer, errrecs:@integer, errmsg:@string, wrnrecs:@integer)
  recs = 0;
  errrecs = 0;
  wrnrecs = 0;
  errmsg = "";

  /*Создаем сеанс*/
  seanceid = CreateSeance(opernum,
                          1,   /*Из файлов в шлюз*/
                          135, /*SRC-30 ММВБ_ВР, Шлюз PAYMENTS*/
                          11,  /*SRC-1 RS-Bank V.6 release 20*/
                          0,   /*Новые*/
                          0, 
                          @errmsg);
  if(seanceid < 0)
    /*Транслируем ошибку*/
    errmsg = errmsg + " (" + seanceid + ")";
    return false;
  elif(seanceid == 0)
    /*Нет объектов для обработки*/
    return true;
  end;

  /*Запускаем обработку сеанса*/
  ExecMacroFile("gtImVRPM", "Receive", seanceid, parms, true);

  /*Завершаем сеанс*/
  FinishSeance(seanceid, @recs, @errrecs, @errmsg, @wrnrecs);

  /*Возвращаем результат*/
  return true;
onError(erru)  
  errmsg = "onError: " + erru.message + " (модуль " + erru.module + ", строка " + erru.line + ")";
  return false;
end;

/*Загрузка СПВБ*/
macro ReceiveSPVB(opernum, parms, seanceid:@integer, recs:@integer, errrecs:@integer, errmsg:@string, wrnrecs:@integer)
  recs = 0;
  errrecs = 0;
  wrnrecs = 0;
  errmsg = "";

  /*Создаем сеанс*/
  seanceid = CreateSeance(opernum,
                          1,   /*Из файлов в шлюз*/
                          1002, /*SRC-27 ПАО СПБ, xml-формат*/
                          11,  /*SRC-1 RS-Bank V.6 release 20*/
                          0,   /*Новые*/
                          0, 
                          @errmsg);
  if(seanceid < 0)
    /*Транслируем ошибку*/
    errmsg = errmsg + " (" + seanceid + ")";
    return false;
  elif(seanceid == 0)
    /*Нет объектов для обработки*/
    return true;
  end;

  /*Запускаем обработку сеанса*/
  ExecMacroFile("gtImSРVB", "Receive", seanceid, parms, true);

  /*Завершаем сеанс*/
  FinishSeance(seanceid, @recs, @errrecs, @errmsg, @wrnrecs);

  /*Возвращаем результат*/
  return true;
onError(erru)  
  errmsg = "onError: " + erru.message + " (модуль " + erru.module + ", строка " + erru.line + ")";
  return false;
end;

/*Загрузка gtImSРVBcomiss*/
macro ReceiveSРVBcomiss(opernum, parms, seanceid:@integer, recs:@integer, errrecs:@integer, errmsg:@string, wrnrecs:@integer)
  recs = 0;
  errrecs = 0;
  wrnrecs = 0;
  errmsg = "";

  /*Создаем сеанс*/
  seanceid = CreateSeance(opernum,
                          1,   /*Из файлов в шлюз*/
                          1003, /*СПВБ, комиссии*/
                          11,  /*SRC-1 RS-Bank V.6 release 20*/
                          0,   /*Новые*/
                          0, 
                          @errmsg);
  if(seanceid < 0)
    /*Транслируем ошибку*/
    errmsg = errmsg + " (" + seanceid + ")";
    return false;
  elif(seanceid == 0)
    /*Нет объектов для обработки*/
    return true;
  end;

  /*Запускаем обработку сеанса*/
  ExecMacroFile("gtImSРVC", "Receive", seanceid, parms, true);

  /*Завершаем сеанс*/
  FinishSeance(seanceid, @recs, @errrecs, @errmsg, @wrnrecs);

  /*Возвращаем результат*/
  return true;
onError(erru)  
  errmsg = "onError: " + erru.message + " (модуль " + erru.module + ", строка " + erru.line + ")";
  return false;
end;
