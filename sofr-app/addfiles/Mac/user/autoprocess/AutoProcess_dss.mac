import AutoProcess;
CONST FIX_DATE = date(0,0,0);

private macro IIF(cond, ret1, ret2)
   if (cond)
     return ret1;
   else
     return ret2;
   end;
end;

/*-exec:101 -date:{operday} -opernum:1 -dialogflag:0 -processtype:1*/
private macro RunCalcEDP()
   var dt = date();
   if (( FIX_DATE == date(0,0,0)) and ( GetDateAfterWorkDays ({curdate}, 0) != date ()) ) //выходной
       exit (1);
   end;

   dt = GetDateAfterWorkDays (dt, -1);

   if (FIX_DATE != date(0,0,0))
      dt = FIX_DATE;
   end;

   var DataSet = TRsbDataSet("SELECT count(1) cnt " +
                        "  FROM dprocess_u_dbt t " +
                        " WHERE     t_subtype IN (701, 711, 721) " +
                        "       AND t_isfinish = CHR (88) " +
                        "       AND t_operdate = " + GetSqlDate(dt) +
                        "       AND EXISTS " +
                        "              (SELECT 1 " +
                        "                 FROM dprocess_u_dbt " +
                        "                WHERE     t_subtype = 702 " +
                        "                      AND t_status = 0 " +
                        "                      AND t_operdate = t.t_operdate) ") ;

   if (DataSet.movenext) 
      if (DataSet.cnt == 3)
         AutoProcess("-exec:101 -date:"+string(dt:f)+" -opernum:1 -dialogflag:0 -processtype:1 "+IIF(FIX_DATE != date(0,0,0), "-fixdate:1 ","")+"-subtypes:702,703,301,506");/*ышьшЄ√, ётхЁър, ёЄрЁЄ ┴╬, ёюсє*/
      end;
   end;
end;

private macro RunBrokReport()
   var dt = date();
   if (( FIX_DATE == date(0,0,0)) and ( GetDateAfterWorkDays ({curdate}, 0) != date ()) ) //выходной
       exit (1);
   end;

   dt = GetDateAfterWorkDays (dt, -1);

   if (FIX_DATE != date(0,0,0))
      dt = FIX_DATE;
   end;

   var DataSet = TRsbDataSet("SELECT count(1) cnt " +
                        "  FROM dprocess_u_dbt t " +
                        " WHERE     t_subtype IN (703, 508, 201, 219, 225) " +/*лимиты и заявки и сову*/
                        "       AND t_isfinish = CHR (88) " +
                        "       AND t_operdate = " + GetSqlDate(dt) +
                        "       AND EXISTS " +
                        "              (SELECT 1 " +
                        "                 FROM dprocess_u_dbt " +
                        "                WHERE     t_subtype = 601 " +
                        "                      AND t_status = 0 " +
                        "                      AND t_operdate = t.t_operdate) ") ;

   if (DataSet.movenext) 
      if (DataSet.cnt == 5)
         AutoProcess("-exec:101 -date:"+string(dt:f)+" -opernum:1 -dialogflag:0 -processtype:1 "+IIF(FIX_DATE != date(0,0,0), "-fixdate:1 ","")+"-subtypes:601");
      end;
   end;
end;


macro RunProcess()

   RunCalcEdp();
   RunBrokReport();

end;
