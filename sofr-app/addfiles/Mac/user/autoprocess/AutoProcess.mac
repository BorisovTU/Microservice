/**
  @file         AutoProcess.mac
  @brief        Биржевой автомат для обработки фондового рынка ММВБ и СПБ, валютного и срочного рынков ММВБ 
  
  #menu 
  - БО ЦБ\Сервисные операции\Обработка ценных бумаг\ММВБ. Обработка ценных бумаг
  - БО ЦБ\Сервисные операции\Обработка ценных бумаг\СПБ. Обработка БОЦБ
  - ФИССиКО\Сервисные операции\Обработка клиентских операций валютного рынка
  - ФИССиКО\Сервисные операции\Обработка информации по срочному рынку
  
  #tag
  - functional_block:ЗОД
  - functional_block:СО
  - code_type:GUI

  # changelog
  |date       |author       |tasks                                                     |note                                                        
  |-----------|-------------|----------------------------------------------------------|-------------------------------------------------------------
  |2023.12.12 |Жиц М.В.     |BIQ-14887                                                 | Реализация нового пункта БА фондового рынка ММВБ по расчету базовых сумм для ИнвестСоветника 
  |?          |?            |?                                                         | Создание           
  
*/

import globals;
import captureoutput, rsd, dlquery, cb_sql, oralib, likepy;
import CbReport_h;
import gtLibU;
import "AutoProcess_utils.mac";

import "u_common_email_utils.mac";
import "dldlngfun.mac";
import "dl_calendtls.mac";
import "DvOneTimeCommissCreator.mac";
                                                          
private var erru;

PRIVATE CONST SPB_CODE = "ПАО СПБ";    /* код СПБ */
PRIVATE CONST SPVB_CODE = "АО СПВБ";    ///< код СПВБ 

PRIVATE CONST LIMIT_CALEND_PARAMS = makeArray(
  DL_KeyPair("DayType",DL_CALLNK_MRKTDAY_TRADE),
  DL_KeyPair("MarketPlace", DL_CALLNK_MARKETPLACE_SEC)
);

private class DRecStruct(_OpDate:date, _Type: integer, _SubType: integer)
  var OpDate = _OpDate;
  var Type = _Type;
  var SubType = _SubType;
end;

private macro GetProcessRecordSet(OpDate, Type, SubType)
  var query = 
    "   SELECT ROWID, T_TYPE, t_operdate, t_subtype, t_num, t_status, t_wrnmsg, t_isfinish, t_name, "
   +"          t_statusname, t_count, t_countrecs, t_counterrors, t_countwarning,  "
   +"          TO_CHAR (t_starttime, 'dd.mm.yyyy hh24:mi:ss') t_starttime, "
   +"          TO_CHAR (t_Endtime, 'dd.mm.yyyy hh24:mi:ss') t_Endtime, "
   +"          t_errmsg "
   +"     FROM dprocess_u_dbt "
   +"    WHERE 1=1 "
   +  IIF(ValType(OpDate) == V_DATE, " AND t_operdate = " + GetSQLDate(OpDate), "" )
   +  IIF(ValType(Type) == V_INTEGER, " AND T_TYPE = " + String(Type), "" )
   +  IIF(ValType(SubType) == V_INTEGER, " AND t_subtype = " + String(SubType), "" )
   +" ORDER BY t_num, t_name ";
  return RSDRecordset(RsdCommand(query), RSDVAL_CLIENT, RSDVAL_STATIC);
end;

private macro GetProcessRecordSetFromObj(Obj:DRecStruct)
  return GetProcessRecordSet(Obj.OpDate, Obj.Type, Obj.SubType);
end;


Private macro getCurrentDateTime()
  var cdate = date();
  var ctime = time();

  var day, mon, year;
  var hour, min, sec;

  DateSplit(date(), day, mon, year);
  TimeSplit(time(), hour, min, sec);
  
  var str = string( day:2:o, ".", mon:2:o, ".", year, " ", hour:2:o, ":", min:2:o, ":", sec:2:o);

  return str;
end;

Private macro getNullDateTime()
  var cdate = date(0,0,0);
  var ctime = time(0,0,0);

  var day, mon, year;
  var hour, min, sec;

  DateSplit(cdate, day, mon, year);
  TimeSplit(ctime, hour, min, sec);
  
  var str = string( day:2:o, ".", mon:2:o, ".", year, " ", hour:2:o, ":", min:2:o, ":", sec:2:o);

  return str;
end;

private macro UpdateProcessItem(process:@rsdrecordset, isfin, state, statename, countr, counterr, countw, errmsg, isunkerr)
  var exec;
/*
    process.value("t_isfinish") = "E";
    process.value("t_status") = 3;
    process.value("t_statusname") = "Обработан с ошибками";
    process.value("t_countrecs") = recs;
    process.value("t_counterrors") = errrecs;
    process.value("t_countwarning") = wrnrecs;
    process.value("t_errmsg") = substr(errmsg,1,200);


    process.value("t_isfinish") = "E";
    process.value("t_status") = 2;
    process.value("t_statusname") = "Ошибка обработки";
    process.value("t_errmsg") = substr(errmsg,1,200);


*/
  If(not isunkerr)

     StartCaptureOutput();
     [
       update dprocess_u_dbt set t_count = t_count + 1, t_isfinish = ?, t_status = ?, t_statusname = ?, t_countrecs = ?, t_counterrors = ?, t_countwarning = ?, t_errmsg = ?, t_endtime = ?
       where t_type = ? and
             t_operdate = ? and
             t_subtype = ?
     ];
     exec = RsdCommand(EndCaptureOutput());

     exec.AddParam("isfinish", RSDBP_IN, isfin);
     exec.AddParam("status", RSDBP_IN, state);
     exec.AddParam("statusname", RSDBP_IN, statename);
     exec.AddParam("countrecs", RSDBP_IN, countr);
     exec.AddParam("counterrors", RSDBP_IN, counterr);
     exec.AddParam("countwarning", RSDBP_IN, countw);
     exec.AddParam("errmsg", RSDBP_IN, errmsg);
     exec.AddParam("EndTime", RSDBP_IN, getCurrentDateTime());
     exec.AddParam("processtype", RSDBP_IN, process.value("t_type"));
     exec.AddParam("operdate", RSDBP_IN, date(process.value("t_operdate")));
     exec.AddParam("processsubtype", RSDBP_IN, process.value("t_subtype"));
     exec.Execute();
  else
     StartCaptureOutput();
     [
       update dprocess_u_dbt set t_count = t_count + 1, t_isfinish = ?, t_status = ?, t_statusname = ?, t_errmsg = ?, t_EndTime = ?
       where t_type = ? and
             t_operdate = ? and
             t_subtype = ?
     ];
     exec = RsdCommand(EndCaptureOutput());

     exec.AddParam("isfinish", RSDBP_IN, isfin);
     exec.AddParam("status", RSDBP_IN, state);
     exec.AddParam("statusname", RSDBP_IN, statename);
     exec.AddParam("errmsg", RSDBP_IN, errmsg);
     exec.AddParam("EndTime", RSDBP_IN, getCurrentDateTime());
     exec.AddParam("processtype", RSDBP_IN, process.value("t_type"));
     exec.AddParam("operdate", RSDBP_IN, date(process.value("t_operdate")));
     exec.AddParam("processsubtype", RSDBP_IN, process.value("t_subtype"));
     exec.Execute();

  end;

End;

/*Удаление обработки процесса*/
private macro DeleteProcessItem(process:@rsdrecordset, errmsg:@string, Isrestart )
  var exec;
  StartCaptureOutput();
  [
    delete from dprocess_oper_u_dbt
    where t_type = ? and
          t_operdate = ? and
          t_subtype = ?
  ];
  exec = RsdCommand(EndCaptureOutput());
  exec.AddParam("processtype", RSDBP_IN, process.value("t_type"));
  exec.AddParam("operdate", RSDBP_IN, date(process.value("t_operdate")));
  exec.AddParam("processsubtype", RSDBP_IN, process.value("t_subtype"));
  exec.Execute();
  process.edit();
  process.value("t_isfinish") = "";
  process.value("t_status") = NotProccesed_Status;
  process.value("t_statusname") = "Не обработан";
  process.value("t_countrecs") = 0;
  process.value("t_counterrors") = 0;
  process.value("t_countwarning") = 0;
  process.value("t_errmsg") = "";
  If(Isrestart)
     process.value("t_starttime") = DTTM(Date(), Time());
  else
     process.value("t_starttime") = nullval;
  end;
  process.value("t_Endtime") = nullval;

  process.update();
  return true;
onError(erru)  
  errmsg = "onError: " + erru.message + " (модуль " + erru.module + ", строка " + erru.line + ")";
  SetDialogFlag(1);
  return false;
end;



Private Macro GetRecPrewProc(StrType, StrSubType, StrDate)
    var sql,cmd, rs ;
    
    sql = "select * from dprocess_u_dbt where t_type = ? and  t_subtype = ? and t_operdate = ? ";
    cmd = RSDCommand(sql);
    cmd.AddParam("p_type", rsdbp_in, StrType);
    cmd.AddParam("p_SubType", rsdbp_in, StrSubType);
    cmd.AddParam("p_date", rsdbp_in, StrDate);

    rs = RSDRecordset(cmd, rsdval_client, rsdval_static);
    return rs;


End;

Private Macro CheckPrewOper(StrType, StrSubType, StrDate)

Var cmd, rs;    
StartCaptureOutput();
   [
      select rec.* from  dgtsncrec_dbt sn,  dgtrecord_dbt rec, dprocess_oper_u_dbt proc where   sn.t_seanceid = proc.t_operid
      and rec.t_recordid = sn.t_recordid and rec.t_statusid = 2
      And proc.t_type = ? and proc.t_subtype = ? and proc.t_operdate = ? 
   ];

   cmd= DL_RsdCommand(EndCaptureOutput());
   cmd.AddParam(StrType);
   cmd.AddParam(StrSubType);
   cmd.AddParam(StrDate);
   rs = cmd.Execute();
   if(rs.moveNext())
      return true;
   else
      return false;
   end;

End;

Private macro CheckEDPDay(msg:@string)

    var stat = 0, XDate = "";
    var XDayRegPath = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ДАТА ВКЛЮЧЕНИЯ ЕДП";
    GetRegistryValue(XDayRegPath, V_STRING, XDate, stat); 
    if(stat != 0)
      msg = "Ошибка при получении значения настройки: " + XDayRegPath;
      msgbox(msg);
      return False;
    elif(XDate == "00.00.0000")
      msg = "Значение настройки " + XDayRegPath + " не задано";
      msgbox(msg);
      return False;
    elif(Date(XDate) > {Curdate})
      msg = "Дата перехода на ЕДП еще не наступила";
      msgbox(msg);
      return False;
    end;
    return True;
end;

private MACRO u_GetClientID( KOD:string, CodeKind:integer ):INTEGER
  var PartyID;

  PartyID = ПолучитьКодСубъекта( KOD, CodeKind );
  if( PartyID <= 0 )
     return -1;
  end;
  return PartyID;
END;


/*Настройка режима рассылки уведомлений*/
const SinglSend      = False; //Рассылка уведомления для каждого обработанного пункта
const MassSend       = true;  //Рассылка сводного уведомления после окончания обработки выбранных пунктов в задании

const SendWithShed   = True;  //Рассылка уведомлений в безинтерфейсном режиме запуска  (планировщик)
const SendWithManual = True;  //рассылка уведомлений в интерфейсном режиме запуска (пункт меню)

var Process_Array = Null;
    Process_Array = tArray();
var Send_Complete_Flag = False;
var dt_proc;

CLASS Proc_Instance(p_proc_name, p_proc_errmsg, p_proc_errcount, p_proc_wrncount)
   var proc_name = p_proc_name,
       proc_errmsg = p_proc_errmsg,
       proc_errcount = p_proc_errcount,
       proc_wrncount = p_proc_wrncount;
end;

class (TArray) TStrCollector
   /*Очистить массив.*/
  macro ClearArray
    this.Size = 0;
  end;
  /*Добавить строку в массив.*/
  macro AddString(Str)
    this.(this.Size) = Str;
  end;

  macro CopyArray(Arr:TArray)
    var i = 0;
    while (i < Arr.Size)
      if(Trim(Arr(i)) != "")
        this.(this.Size) = Arr(i);
      end;
      i = i + 1;
    end;        
  end;
end;

/*Отправка уведомлений*/
private macro SendSingleNotification(process, errmsg, errrecs, wrnrecs)
    var err_reg = 0,
        v_email_processor,
        email_group, 
        msg_text = "При выполнении пункта \"" + process.value("t_name") + "\" зафиксировано:\n ";    

    if ((not(SinglSend and SendWithManual)) and (not(SinglSend and SendWithShed and  IsShedulerRunning())))
//        return 0;
    end;

    GetRegistryValue("РСХБ\\ИНТЕГРАЦИЯ\\SEND_NOTIFY_BO", V_INTEGER, email_group, err_reg);
    if (err_reg)
      MsgBox("Ошибка получение значений настроек \"РСХБ\\ИНТЕГРАЦИЯ\\SEND_NOTIFY_BO\"");
    end;
    if (email_group)

         v_email_processor = c_email_proc_env();
         v_email_processor.m_get_email_group(email_group);
         v_email_processor.m_set_msg_head("СОФР - Обработка дня:" + process.value("t_name"));
         if(strlen(errmsg) > 0)
             v_email_processor.m_add_row_to_msg_text(errmsg);
         end;
         if(errrecs > 0)
             msg_text = msg_text + "ошибок: " + errrecs + "\n";
         end;
         if(wrnrecs > 0)
             msg_text = msg_text + " предупреждений:" + wrnrecs + ".\n";     
             msg_text = msg_text + "Необходимо оценить их влияние на обработку дня и принять меры при необходимости .";     
         end;      
             v_email_processor.m_add_row_to_msg_text(msg_text);
         v_email_processor.m_save_to_submit_grp(email_group, true);
         v_email_processor.m_submit_email_synch();
                           
    end;

 onerror(err)
   return 0;
end;

private macro SendNotificationEDPLimit(dt)
    var err_reg = 0,
        v_email_processor,
        email_group, 
        msg_text = "Расчет лимитов ЕДП выполнен при наличии ошибок и предупреждений в процедурах закрытия дня.\n ";
        msg_text = msg_text + "Требуется обратить внимание на протоколы соответствующих пунктов обработчиков и принять меры при необходимости.\n ";
        msg_text = msg_text + "\n";
    
    var sql = String( "with parm as (select ? as pdate from dual)\n" 
                     ,"select tbl.lvl, tbl.t_name, tbl.t_subtype, tbl.t_num, tbl.t_status, tbl.t_statusname, nvl(tbl.t_errmsg,chr(1)) as t_errmsg, tbl.t_counterrors, tbl.t_countwarning, tbl.t_operdate from (\n"  
                     ,"select t.*,(count(1) OVER (PARTITION BY t.lvl) - 1) as Count_Err\n"  
                     ," from (select 1 as lvl, 'фондовый рынок ММВБ' as t_name, 0 as t_subtype, 0 as t_num, -1 as t_status, '' as t_statusname, '' as t_errmsg, 0 as t_counterrors, 0 as t_countwarning, parm.pdate as t_operdate from dual, parm\n"  
                     ,"         union\n"  
                     ,"       select 1 as lvl, t.t_name,t.t_subtype , t.t_num,t.t_status, t.t_statusname, t.t_errmsg, t.t_counterrors, t.t_countwarning, t_operdate from dprocess_u_dbt t where\n"  
                     ,"       t.t_type = 1 and (t_status = 3 or (t_status = 10 and T_COUNTWARNING != 0))\n"  
                     ,"         union\n"  
                     ,"       select 3 as lvl, 'Валютный рынок' as t_name, 0 as t_subtype, 0 as t_num, -1 as t_status, '' as t_statusname, '' as t_errmsg, 0 as t_counterrors, 0 as t_countwarning, parm.pdate as t_operdate from dual, parm\n"  
                     ,"         union\n"  
                     ,"       select 3 as lvl, t.t_name,t.t_subtype , t.t_num,t.t_status, t.t_statusname, t.t_errmsg, t.t_counterrors, t.t_countwarning, t_operdate from dprocess_u_dbt t where\n"  
                     ,"       t.t_type = 3 and (t_status = 3 or (t_status = 10 and T_COUNTWARNING != 0))\n"  
                     ,"         union\n"  
                     ,"       select 4 as lvl, 'Срочный рынок' as t_name, 0 as t_subtype, 0 as t_num, -1 as t_status, '' as t_statusname, '' as t_errmsg, 0 as t_counterrors, 0 as t_countwarning, parm.pdate as t_operdate from dual, parm\n"  
                     ,"         union\n"  
                     ,"       select 4 as lvl, t.t_name,t.t_subtype , t.t_num,t.t_status, t.t_statusname, t.t_errmsg, t.t_counterrors, t.t_countwarning, t_operdate from dprocess_u_dbt t where\n"  
                     ,"       t.t_type = 2 and (t_status = 3 or (t_status = 10 and T_COUNTWARNING != 0))\n"  
                     ,"         union\n"  
                     ,"       select 2 as lvl, 'Фондовый рынок СПБ' as t_name, 0 as t_subtype, 0 as t_num, -1 as t_status, '' as t_statusname, '' as t_errmsg, 0 as t_counterrors, 0 as t_countwarning, parm.pdate as t_operdate from dual, parm\n"  
                     ,"         union\n"  
                     ,"       select 2 as lvl, t.t_name,t.t_subtype , t.t_num,t.t_status, t.t_statusname, t.t_errmsg, t.t_counterrors, t.t_countwarning, t_operdate from dprocess_u_dbt t where\n"  
                     ,"       t.t_type = 4 and (t_status = 3 or (t_status = 10 and T_COUNTWARNING != 0))\n"  
                     ,"    ) t, parm\n"  
                     ,"where t.t_operdate = parm.pDate) tbl\n"  
                     ,"where tbl.count_err != 0\n"  
                     ,"order by tbl.lvl, tbl.t_num\n"  
                     ,"");
    var cmd = RSDCommand(sql);
        cmd.AddParam("", rsdbp_in, dt);
    var rs = RSDRecordset(cmd, rsdval_client, rsdval_static);
    if (rs.movenext)
       if ((not(SinglSend and SendWithManual)) and (not(SinglSend and SendWithShed and  IsShedulerRunning())))
//          return 0;
       end;

       GetRegistryValue("РСХБ\\ИНТЕГРАЦИЯ\\SEND_NOTIFY_BO", V_INTEGER, email_group, err_reg);
       if (err_reg)
         MsgBox("Ошибка получение значений настроек \"РСХБ\\ИНТЕГРАЦИЯ\\SEND_NOTIFY_BO\"");
       end;
       if (email_group)

         v_email_processor = c_email_proc_env();
         v_email_processor.m_get_email_group(email_group);
         v_email_processor.m_set_msg_head("СОФР - Обработка дня. Статус обработки на момент расчета лимитов ЕДП.");
            msg_text = msg_text + rs.value("t_name") + ":\n";
            while(rs.movenext)
              if (rs.value("t_status") == -1)
                msg_text = msg_text + rs.value("t_name") + ":\n";
              else
                msg_text = msg_text + "    " + rs.value("t_name") + ":" + rs.value("t_statusname")  + "   Ошибки:" + int(rs.value("t_counterrors")) + "   Предупреждения:" + int(rs.value("t_countwarning")) + "   " + rs.value("t_errmsg") + "\n";
              end;
            end;
            v_email_processor.m_add_row_to_msg_text(msg_text);
            v_email_processor.m_save_to_submit_grp(email_group, true);
            v_email_processor.m_submit_email_synch();
       end;
    end;
 onerror(err)
   return 0;
end;

/*Отправка уведомлений при успешном повторном выполнении загрузки заявок в БО.*/
private macro SendNotificationReloadReq(process, errmsg, errrecs, wrnrecs)
    var err_reg = 0,
        v_email_processor,
        email_group, 
        msg_text = "",
        process_type_name = "", file_text = ""; 


    GetRegistryValue("РСХБ\\ИНТЕГРАЦИЯ\\SEND_NOTIFY_BO", V_INTEGER, email_group, err_reg);
    if (err_reg)
      MsgBox("Ошибка получение значений настроек \"РСХБ\\ИНТЕГРАЦИЯ\\SEND_NOTIFY_BO\"");
    end;

     if (process.value("t_type")== 1)
       process_type_name = " БО ЦБ.";
       file_text = "Файл SEM02 загружен и обработан.";
     elif (process.value("t_type") == 2)
       process_type_name = " Срочный рынок.";
       file_text = "Файлы fordlogF502.csv, oordlogF502.csv загружены и обработаны.";
     elif (process.value("t_type") == 3)
       process_type_name = " Валютный рынок.";
       file_text = "Файл CUX22 загружен и обработан.";
     end;

    if (email_group)

         v_email_processor = c_email_proc_env();
         v_email_processor.m_get_email_group(email_group);
         v_email_processor.m_set_msg_head("СОФР - Обработка дня "+process_type_name+":" + process.value("t_name"));
         v_email_processor.m_add_row_to_msg_text("Повторная загрузка поручений на сделки.");
         v_email_processor.m_add_row_to_msg_text(file_text + " Необходимо запустить формирование Отчета брокера");
         v_email_processor.m_add_row_to_msg_text("");
         if(wrnrecs > 0)
             msg_text = msg_text + " предупреждений:" + wrnrecs + ".";     
         end;      
         v_email_processor.m_add_row_to_msg_text(msg_text);
         v_email_processor.m_save_to_submit_grp(email_group, true);
         v_email_processor.m_submit_email_synch();
                          
    end;

 onerror(err)
   return 0;
end;

/// Отправка уведомления о том, что данные по ДС не загружены
private macro SendNotificationCCX99_EQ1()
  var v_email_processor,
      email_group;
  
  email_group = 18; // Группа рассылки с id 18 "RUDATA"
  
  v_email_processor = c_email_proc_env();
  v_email_processor.m_get_email_group(email_group);
  v_email_processor.m_set_msg_head("СОФР - Обработка дня: не загружены данные при выполнении пункта биржевого автомата Московской биржи: 'Загрузка в шлюз движений ДС'");
  v_email_processor.m_add_row_to_msg_text("При обработке пункта биржевого автомата  обнаружено отсутствие данных для загрузки. Пункт завершен с предупреждением. Необходимо проверить наличие файла CCX99_EQ1 и его загрузку в Payments.");
  v_email_processor.m_add_row_to_msg_text("");
  v_email_processor.m_add_row_to_msg_text("После появления файла и загрузки его в Payments  можно перевыполнить последовательно пункты БА \"Загрузка в шлюз движений ДС\" и потом \"Загрузка в БО движений ДС\".");
  v_email_processor.m_save_to_submit_grp(email_group, true);
  v_email_processor.m_submit_email_synch();
  
onError(err)
  return 0;
end;

/*Отправка уведомлений при необходимости перезапуска обработанного пункта из-за наличия по сеансу ЗР в статсе Готов к обработке.*/
private macro SendNotificationZR(process:@rsdrecordset)
    var err_reg = 0, cmd, 
        v_email_processor,
        email_group, 
        msg_text = "",
        process_type_name = "", file_text = ""; 

    GetRegistryValue("РСХБ\\ИНТЕГРАЦИЯ\\SEND_NOTIFY_BO", V_INTEGER, email_group, err_reg);
    if (err_reg)
      MsgBox("Ошибка получение значений настроек \"РСХБ\\ИНТЕГРАЦИЯ\\SEND_NOTIFY_BO\"");
    end;
/*
StartCaptureOutput();
   [
      select * from dprocess_u_dbt where t_type = ? and  t_subtype = ? and t_operdate = ?
   ];
   cmd= DL_RsdCommand(EndCaptureOutput());
   cmd.AddParam(StrType);
   cmd.AddParam(StrSubType);
   cmd.AddParam(StrDate);
   process = cmd.Execute();
   if(process.moveNext())
*/

     if (process.value("t_type")== 1)
       process_type_name = " БО ЦБ.";
       file_text = "По обработанному пункту " + process.value("t_name") + " остались Записи Репликации в статусе Готов к обработке. Пункт будет перезапущен " ;
     elif (process.value("t_type") == 2)
       process_type_name = " Срочный рынок.";
       file_text = "По обработанному пункту " + process.value("t_name") + " остались Записи Репликации в статусе Готов к обработке. Пункт будет перезапущен " ;
     elif (process.value("t_type") == 3)
       process_type_name = " Валютный рынок.";
       file_text = "По обработанному пункту " + process.value("t_name") + " остались Записи Репликации в статусе Готов к обработке. Пункт будет перезапущен " ;
     end;

    if (email_group)

         v_email_processor = c_email_proc_env();
         v_email_processor.m_get_email_group(email_group);
         v_email_processor.m_set_msg_head("СОФР - Обработка дня "+process_type_name+":" + process.value("t_name"));
         v_email_processor.m_add_row_to_msg_text(file_text);
         v_email_processor.m_add_row_to_msg_text("");
         v_email_processor.m_add_row_to_msg_text(msg_text);
         v_email_processor.m_save_to_submit_grp(email_group, true);
         v_email_processor.m_submit_email_synch();
                          
    end;
//  end;
 onerror(err)
   return 0;
end;

private macro SendNotification(Flag)

     private macro detGTRec_Error(process_type):RSDRecordset
       var sql,cmd, rs ;
       
       sql = "SELECT DISTINCT gtrec.t_clientid, p.t_name, p.t_shortname,  "+
             " (select c.t_code from dobjcode_dbt c where c.t_objecttype = 3 and c.t_codekind = 1 " + 
             "        and c.t_objectid = gtrec.t_clientid and c.t_state = 0) t_code " +
             "  FROM dgtrecord_dbt gtrec, dparty_dbt p                   "+
             " WHERE gtrec.t_clientid = p.t_partyid AND gtrec.t_statusid != 3       /*готов к обработке*/ "+
             "   AND gtrec.t_clientid != 0 AND gtrec.t_sysdate > trunc(sysdate)";
       if(valtype(process_type) != v_undef)
          if (process_type == 1)
            sql = sql + "   and gtrec.t_applicationid_from in (112/*БОЦБ*/, 133/*ММВБ, Шлюз PAYMENTS*/)";
          elif (process_type == 3)
            sql = sql + "   and gtrec.t_applicationid_from in (118/*валютка*/, 135/*ММВБ_ВР, Шлюз PAYMENTS*/)";
          end;
       end;
       cmd = RSDCommand(sql);

       rs = RSDRecordset(cmd, rsdval_client, rsdval_static);
       return rs;
     end;

      private macro getGrAcc_Error():RSDRecordset
       var sql,cmd, rs ;
       
       sql ="select t.t_clientid, p.t_name, p.t_shortname, " +
             " (select c.t_code from dobjcode_dbt c where c.t_objecttype = 3 and c.t_codekind = 1 " + 
             "        and c.t_objectid = t.t_clientid and c.t_state = 0) t_code " +
             "   from  " +
            "  (SELECT grdeal.t_dockind, " +
            "         grdeal.t_docid, " +
            "         gracc.t_accnum, " +
            "         gracc.t_state, " +
            "         gracc.t_factdate, TICK.T_CLIENTID " +
            "    FROM ddlgracc_dbt gracc, ddlgrdeal_dbt grdeal, ddl_tick_dbt tick " +
            "   WHERE     GRACC.T_GRDEALID = GRDEAL.T_ID " +
            "         and GRDEAL.T_DOCID = TICK.T_DEALID " +
            "         and TICK.T_CLIENTID != -1 " +
            "         AND gracc.t_accnum = 2 " +
            "         AND grdeal.t_plandate = ? " +
            "         AND gracc.t_state = 1 " +
            "         and grdeal.t_dockind in (101) " +
            "GROUP BY grdeal.t_dockind, " +
            "         grdeal.t_docid, " +
            "         gracc.t_accnum, " +
            "         gracc.t_state, " +
            "         gracc.t_factdate,  TICK.T_CLIENTID) t , dparty_dbt p  " +
            "         where t.t_clientid = p.t_partyid " +
            "         group by t.t_clientid, p.t_name, p.t_shortname; " ;

       cmd = RSDCommand(sql);
       cmd.AddParam("p_date", rsdbp_in, dt_proc);
       rs = RSDRecordset(cmd, rsdval_client, rsdval_static);
       return rs;
     end;

var err_reg = 0,
    v_email_processor,
    email_group, 
    msg_text = "", i = 0;

    if((not MassSend) or (not Flag))
        return 0;
    end;

    GetRegistryValue("РСХБ\\ИНТЕГРАЦИЯ\\SEND_NOTIFY_BO", V_INTEGER, email_group, err_reg);
    if (err_reg)
      MsgBox("Ошибка получение значений настроек \"РСХБ\\ИНТЕГРАЦИЯ\\SEND_NOTIFY_BO\"");
    end;

    var process_type, process_type_name = "";
    getparm(1, process_type);

    if(valtype(process_type) != v_undef)
      if (process_type == 1)
        process_type_name = " БО ЦБ."
      end;
      if (process_type == 3)
        process_type_name = " Валютный рынок."
      end;
    end;

    if ((not err_reg) and (email_group))
         v_email_processor = c_email_proc_env();
         v_email_processor.m_get_email_group(email_group);
         v_email_processor.m_set_msg_head("СОФР - Обработка дня." + process_type_name);
                 
         if((Process_Array.Size > 0) and (not Send_Complete_Flag))
           while (i < Process_Array.Size)
            msg_text = "";
            if(strlen(Process_Array[i].proc_errmsg) > 0)
               msg_text = Process_Array[i].proc_errmsg + ".";
            end;
            if((Process_Array[i].proc_errcount > 0) or (Process_Array[i].proc_wrncount > 0))
              msg_text = msg_text + " В ходе выполнения операции " + Process_Array[i].proc_name + " Зафиксировано: ";
              if(Process_Array[i].proc_errcount > 0)
                 msg_text = msg_text + Process_Array[i].proc_errcount + " ошибок";
                if(Process_Array[i].proc_wrncount > 0)
                  msg_text = msg_text + ", " + Process_Array[i].proc_wrncount + " предупреждений.";
                else
                  msg_text = msg_text + ".";
                end;
              else
                msg_text = msg_text + Process_Array[i].proc_wrncount + " предупреждений."; 
              end; 
            end;
            v_email_processor.m_add_row_to_msg_text(msg_text);  
            msg_text = ""; 
            i = i + 1;
           end;

//добавление информации о записях репликации в отказе и необработанных грайиках БУ/////////////////////////////////////////////////////////////////////////////////////////


             var rs_client: RSDRecordset;
             rs_client = detGTRec_Error(process_type);
             if (rs_client.movenext())
                v_email_processor.m_add_row_to_msg_text("_______________________________________________________________________________________________________________");
                v_email_processor.m_add_row_to_msg_text("Для след. клиентов в " + date + "  иммеются записи репликации в статусе 'Отказ обработки':");   
                rs_client.moveprev();       
                while (rs_client.movenext())
                   v_email_processor.m_add_row_to_msg_text("ID:" + rs_client.value(0) + "  Код:" + rs_client.value(3));
                end;
             end;   

             var rs_gracc: RSDRecordset;
             rs_gracc = getGrAcc_Error();
             if (rs_gracc.movenext())
                v_email_processor.m_add_row_to_msg_text("__________________________________________________________________________________________________________________");
                v_email_processor.m_add_row_to_msg_text("Для след. клиентов имеются сделки с необработанными графиками БУ, запланированными к обработке на " + dt_proc + " :");   
                rs_gracc.moveprev();       
                while (rs_gracc.movenext())
                   v_email_processor.m_add_row_to_msg_text("ID:" + rs_gracc.value(0) + "  Код:" + rs_gracc.value(3));
                end;
             end;   

    //      end;
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

          v_email_processor.m_save_to_submit_grp(email_group, true);
          v_email_processor.m_submit_email_synch();
          Send_Complete_Flag = True;
         end;
    end;

 onerror(err)
   return 0;
end;

/*Вставка записи в протокол*/
private macro InsertLog(mes)
  var exexlog = RSDCommand("begin rshb_brkrep.InsertLog(?); end;");
  exexlog.addParam("", RSDBP_IN, "shed " + date() + " " + time() + " " + mes);
  exexlog.execute();
end;

Private Macro SaveResultPrew(StrType, StrSubType, StrDate, seanceid)
  /*Сеанс работы со шлюзом*/
    var i = 0, exec;
    if(seanceid > 0)
      StartCaptureOutput();
      [
        insert into dprocess_oper_u_dbt values(?, ?, ?, ?, null)
      ];
      exec = RsdCommand(EndCaptureOutput());
      exec.AddParam("processtype", RSDBP_IN, StrType);
      exec.AddParam("operdate", RSDBP_IN, date(StrDate));
      exec.AddParam("processsubtype", RSDBP_IN, StrSubType);
      exec.AddParam("operationid", RSDBP_IN, seanceid);
      exec.Execute();
    end;

End;


Private macro CheckResultProcPrew(resultproc, process:@rsdrecordset, seanceid, recs, errrecs, errmsg, wrnrecs)

  /*Ошибка обработки*/
  if(not resultproc)
    if(strlen(errmsg) <= 0)
      errmsg = "Неизвестная ошибка при обработке процесса";
    end;
    SaveResultPrew( process.value("t_type"),process.value("t_subtype"), process.value("t_operdate"),  seanceid);
/*
    process.edit();
    process.value("t_isfinish") = "E";
    process.value("t_status") = 2;
    process.value("t_statusname") = "Ошибка обработки";
    process.value("t_errmsg") = substr(errmsg,1,200);
*/
    UpdateProcessItem(@process, "E", 2, "Ошибка обработки", substr(errmsg,1,200), true);
    process.update();

    SetDialogFlag(1);

    SendSingleNotification(process, errmsg, errrecs, wrnrecs);
    Process_Array[Process_Array.Size] = Proc_Instance(process.value("t_name"), errmsg, errrecs, wrnrecs);

    return false;

  /*Обработка с ошибками*/
  elif(errrecs > 0)
    SaveResultPrew( process.value("t_type"),process.value("t_subtype"), process.value("t_operdate"),  seanceid);
/*
    process.edit();
    process.value("t_isfinish") = "E";
    process.value("t_status") = 3;
    process.value("t_statusname") = "Обработан с ошибками";
    process.value("t_countrecs") = recs;
    process.value("t_counterrors") = errrecs;
    process.value("t_countwarning") = wrnrecs;
    process.value("t_errmsg") = substr(errmsg,1,200);
    process.update();
*/
    UpdateProcessItem(@process, "E", 3, "Обработан с ошибками", recs, errrecs, wrnrecs, substr(errmsg,1,200), false);
    SetDialogFlag(1);

    SendSingleNotification(process, errmsg, errrecs, wrnrecs);
    Process_Array[Process_Array.Size] = Proc_Instance(process.value("t_name"), errmsg, errrecs, wrnrecs);


  /*Успешная обработка*/
  else
    SaveResultPrew( process.value("t_type"),process.value("t_subtype"), process.value("t_operdate"),  seanceid);
/*
    process.edit();
    process.value("t_isfinish") = "X";
    process.value("t_status") = 10;
    if (wrnrecs > 0)
      process.value("t_statusname") = "Обработан с предупреждениями";
    else
    process.value("t_statusname") = "Обработан успешно";
    end;
    process.value("t_countrecs") = recs;
    process.value("t_counterrors") = errrecs;
    process.value("t_countwarning") = wrnrecs;
    process.value("t_errmsg") = substr(errmsg,1,200);
    process.update();
*/
    UpdateProcessItem(@process, "X", 10, iif(wrnrecs > 0, "Обработан с предупреждениями", "Обработан успешно"), recs, errrecs, wrnrecs, substr(errmsg,1,200), false);
    SetDialogFlag(1);

    if (wrnrecs > 0)
        SendSingleNotification(process, errmsg, errrecs, wrnrecs);
        Process_Array[Process_Array.Size] = Proc_Instance(process.value("t_name"), errmsg, errrecs, wrnrecs);
    end;
    return true;
  end;


onError(erru)  
  errmsg = "onError: " + erru.message + " (модуль " + erru.module + ", строка " + erru.line + ")";
  SetDialogFlag(1);
  return false;
End;

private macro WriteLogInClob(ProcType:integer, OperDate:date, SubType:integer, Protocol:string)
  StartCaptureOutput();
  [
    declare
      processtype number := ?;
      operdate date := ?;
      processsubtype number := ?;
      str varchar2(4000) := ?;
      cl clob := null;
    begin
      -- Читаем текущее значение
      begin
        select t_protocol
        into cl
        from dprocess_oper_u_dbt 
        where t_type = processtype and
              t_operdate = operdate and
              t_subtype = processsubtype and
              t_operid = 0
        for update nowait;
      exception when no_data_found then
        insert into dprocess_oper_u_dbt values(processtype, operdate, processsubtype, 0, null);
      end;
      -- Создаем CLOB при необходимости
      if(cl is null)then
        dbms_lob.createtemporary(cl, true);
      end if;
      -- Дописываем строку в CLOB
      dbms_lob.writeappend(cl, length(str), str);
      -- Сохраняем результат
      update dprocess_oper_u_dbt
      set t_protocol = cl
        where t_type = processtype and
              t_operdate = operdate and
              t_subtype = processsubtype and
              t_operid = 0;
    end;
  ];
  var exec = RsdCommand(EndCaptureOutput());
  exec.AddParam("processtype",    RSDBP_IN, ProcType);
  exec.AddParam("operdate",       RSDBP_IN, OperDate);
  exec.AddParam("processsubtype", RSDBP_IN, SubType);
  exec.AddParam("str",            RSDBP_IN, Protocol);
  exec.Execute();
end;


/*Обработка процесса*/
private macro RunProcessItem(opernum, process:@rsdrecordset, errmsg:@string)
  var recs = 0; 
  var errrecs = 0; 
  var wrnrecs = 0; 
  var result_comm = tarray();
  var result_protocol = TStrCollector;
  var seanceid = 0;
  var resultproc;
  var exec;
  var ProcessPrew: RSDRecordset;
  var startdate;
  /*Сохраняем результат*/
  macro SaveResult()
    /*Сервисные операции*/
    var i = 0;
    while(i < result_comm.size)
      StartCaptureOutput();
      [
        insert into dprocess_oper_u_dbt values(?, ?, ?, ?, null)
      ];
      exec = RsdCommand(EndCaptureOutput());
      exec.AddParam("processtype", RSDBP_IN, process.value("t_type"));
      exec.AddParam("operdate", RSDBP_IN, date(process.value("t_operdate")));
      exec.AddParam("processsubtype", RSDBP_IN, process.value("t_subtype"));
      exec.AddParam("operationid", RSDBP_IN, result_comm[i]);
      exec.Execute();
      i = i + 1;
    end;
    /*Сеанс работы со шлюзом*/
    if(seanceid > 0)
      StartCaptureOutput();
      [
        insert into dprocess_oper_u_dbt values(?, ?, ?, ?, null)
      ];
      exec = RsdCommand(EndCaptureOutput());
      exec.AddParam("processtype", RSDBP_IN, process.value("t_type"));
      exec.AddParam("operdate", RSDBP_IN, date(process.value("t_operdate")));
      exec.AddParam("processsubtype", RSDBP_IN, process.value("t_subtype"));
      exec.AddParam("operationid", RSDBP_IN, seanceid);
      exec.Execute();
    end;
    /*Протокол работы*/
    i = 0;
    while(i < result_protocol.size)
      //разбиваем протокол по порциям в 4000 символов, т.к. WriteLogInClob не принимает больше
      var splittedStr = StrSplit2(result_protocol[i],4000,true);
      if (splittedStr.size > 0)
        //добавляем последнему элементу перенос строки
        splittedStr[splittedStr.size-1] = splittedStr[splittedStr.size-1] + "\n";
        for (var curStr, splittedStr)
          WriteLogInClob(
            SQL_ConvTypeInteger(process.value("t_type")),
            SQL_ConvTypeDate(process.value("t_operdate")),
            SQL_ConvTypeInteger(process.value("t_subtype")),
            curStr
          );
        end;
      end;
      i = i + 1;
    end;
  end;

  //проверяем тут, чтобы процесс не поменял статус
  if(process.value("t_subtype") == 422)
    //равен ли GetProcessState любому из статусов NotProccesed_Status,Proccesed_Status
    if (find(MakeArray(NotProccesed_Status,Proccesed_Status), GetProcessStatus(702, date(process.value("t_operdate")))) >= 0)
      if (not GetTrue(false, "Не выполнен расчет лимитов ЕДП. Запрещено выполнять обработку сделок валютного рынка параллельно с расчетом лимитов ЕДП.|Продолжить выполнение?"))
        return true;
      end;
    end;
  elif (process.value("t_subtype") == 702)
    //равен ли GetProcessState любому из статусов Proccesed_Status
    if (find(MakeArray(Proccesed_Status), GetProcessStatus(422, date(process.value("t_operdate")))) >= 0)
      if (not GetTrue(false, "Обрабатывается Старт сделок БО валютного рынка. Запрещено выполнять обработку сделок валютного рынка параллельно с расчетом лимитов ЕДП.|Продолжить выполнение?"))
        return true;
      end;
    end;
  end;

  errmsg = "";
  SetDialogFlag(0);
  /*Создаем экземпляр процесса*/
  StartCaptureOutput();
  [
    declare
      processtype integer := ?;
      operdate date := ?;
      processsubtype integer := ?;
      process_u dprocess_u_dbt%rowtype;
      res integer := 0;
    begin
      begin
        -- Захватываем запись
        select *
        into process_u
        from dprocess_u_dbt
        where t_type = processtype and
              t_operdate = operdate and
              t_subtype = processsubtype and
              (t_isfinish = chr(0) or t_isfinish = 'S')
        for update nowait;
        -- Результат
        res := process_u.t_count + 1;
      exception when others then
        null;
      end;
      ? := res;
    end;
  ];
  exec = RsdCommand(EndCaptureOutput());
  exec.AddParam("processtype", RSDBP_IN, process.value("t_type"));
  exec.AddParam("operdate", RSDBP_IN, date(process.value("t_operdate")));
  exec.AddParam("processsubtype", RSDBP_IN, process.value("t_subtype"));
  exec.AddParam("res", RSDBP_OUT, V_INTEGER);
  exec.Execute();
  if((valtype(exec.value("res")) != V_INTEGER) or (exec.value("res") <= 0))
    SetDialogFlag(1);
    errmsg = "Процесс уже запущен/выполнен";
    return false;
  end;
  process.edit();
  process.value("t_isfinish") = "Z";
  process.value("t_status") = Proccesed_Status;
  process.value("t_statusname") = "Обрабатывается";
  process.value("t_starttime") = getCurrentDateTime();
  process.value("t_count") = exec.value("res");
  process.update();

  /*Запуск обработки процессов по типам*/
  errmsg = "";

  /*Загрузка в шлюз заявок на сделки*/
  if(process.value("t_subtype") == 101)
    if(DL_ИспользPaymentsПриИмпорте)
       resultproc = ReceivePMTS(opernum, "-imp_date:" + date(process.value("t_operdate")) + " -request:x -deals:  -deals_clearing:  -deals_bo:x -deals_seb:  -request_otc:  -deals_otc:  -nettoitog:  -ksuwrt: ", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    else
       resultproc = ReceiveMVB4(opernum, "-imp_date:" + date(process.value("t_operdate")) + " -Market:ММВБ -rates:  -comp:  -paym:  -request:x -deals:  -deals_clearing:  -deals_clearing_client:  -moneymotion:  -ksuwrt:  -deals_bo:x -deals_seb:  -deals_du:  -MarketSchemeDU", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;
  elif(process.value("t_subtype") == 108)
    resultproc = ReceivePMTS(opernum, "-imp_date:" + date(process.value("t_operdate")) + " -request:  -deals:  -deals_clearing:  -deals_bo:  -deals_seb:  -request_otc:x -deals_otc:  -nettoitog:  -ksuwrt: ", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
  elif(process.value("t_subtype") == 4010)
    if(DL_ИспользPaymentsПриИмпортеСПБ) 
       resultproc = ReceiveSpbP(opernum, "-imp_date:" + date(process.value("t_operdate")) + " -request:x -deals:  -deals_clearing_client:  -deals_bo:x -nettoitog:  -moneymotion: ", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);   
    else
       resultproc = ReceiveSPB4(opernum, "-imp_date:" + date(process.value("t_operdate")) + " -Market:ПАО СПБ -rates:  -comp:  -paym: -IncREPO: -request:x -deals:  -deals_clearing:  -deals_clearing_client:  -moneymotion:  -ksuwrt:  -deals_bo:x -deals_seb: -NettoItog: -deals_du:  -MarketSchemeDU", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;

  /*Загрузка в шлюз заключенных сделок*/
  elif(process.value("t_subtype") == 102)
    if(DL_ИспользPaymentsПриИмпорте)
       resultproc = ReceivePMTS(opernum, "-imp_date:" + date(process.value("t_operdate")) + " -request:  -deals:x -deals_clearing:  -deals_bo:x -deals_seb:x -request_otc:  -deals_otc:  -nettoitog:  -ksuwrt: ", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    else
       resultproc = ReceiveMVB4(opernum, "-imp_date:" + date(process.value("t_operdate")) + " -Market:ММВБ -rates:  -comp:  -paym:  -request:  -deals:x -deals_clearing:  -deals_clearing_client:  -moneymotion:  -ksuwrt:  -deals_bo:x -deals_seb:x  -deals_du:  -MarketSchemeDU", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;
    if(recs == 0)
       errmsg = "Отсутствуют загруженные данные, влияющие на расчет лимитов и дальнейшую обработку дня";
       resultproc = false;
    end;
  elif(process.value("t_subtype") == 109)
    resultproc = ReceivePMTS(opernum, "-imp_date:" + date(process.value("t_operdate")) + " -request:  -deals:  -deals_clearing:  -deals_bo:  -deals_seb:  -request_otc:  -deals_otc:x -nettoitog:  -ksuwrt: ", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
  elif(process.value("t_subtype") == 4020)
    if(DL_ИспользPaymentsПриИмпортеСПБ) 
       resultproc = ReceiveSpbP(opernum, "-imp_date:" + date(process.value("t_operdate")) + " -request:  -deals:x -deals_clearing_client:  -deals_bo:x -nettoitog:  -moneymotion: ", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);   
    else
       resultproc = ReceiveSPB4(opernum, "-imp_date:" + date(process.value("t_operdate")) + " -Market:ПАО СПБ -rates:  -comp:  -paym: -IncREPO: -request:  -deals:x -deals_clearing:  -deals_clearing_client:  -moneymotion:  -ksuwrt:  -deals_bo:x -deals_seb:x -NettoItog: -deals_du:  -MarketSchemeDU", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;
    if(recs == 0)
       errmsg = "Отсутствуют загруженные данные, влияющие на расчет лимитов и дальнейшую обработку дня";
       resultproc = false;
    end;

  /*Загрузка в шлюз сделок, принятых на клиринг*/
  elif(process.value("t_subtype") == 103)
    if(DL_ИспользPaymentsПриИмпорте)
       resultproc = ReceivePMTS(opernum, "-imp_date:" + date(process.value("t_operdate")) + " -request:  -deals:  -deals_clearing:x -deals_bo:x -deals_seb:  -request_otc:  -deals_otc:  -nettoitog:  -ksuwrt: ", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    else
       resultproc = ReceiveMVB4(opernum, "-imp_date:" + date(process.value("t_operdate")) + " -Market:ММВБ -rates:  -comp:  -paym:  -request:  -deals:  -deals_clearing:x -deals_clearing_client:  -moneymotion:  -ksuwrt:  -deals_bo:x -deals_seb:  -deals_du:  -MarketSchemeDU", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;
    if(recs == 0)
       errmsg = "Отсутствуют загруженные данные, влияющие на расчет лимитов и дальнейшую обработку дня";
       resultproc = false;
    end;
  elif(process.value("t_subtype") == 4030)
    if(DL_ИспользPaymentsПриИмпортеСПБ) 
       resultproc = ReceiveSpbP(opernum, "-imp_date:" + date(process.value("t_operdate")) + " -request:  -deals:  -deals_clearing_client:x -deals_bo:x -nettoitog:  -moneymotion: ", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);   
    else
       resultproc = ReceiveSPB4(opernum, "-imp_date:" + date(process.value("t_operdate")) + " -Market:ПАО СПБ -rates:  -comp:  -paym:  -request:  -deals:  -deals_clearing: -deals_clearing_client:x -moneymotion:  -ksuwrt:  -deals_bo:x -deals_seb:  -deals_du: -NettoItog: -MarketSchemeDU", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;

  /*Загрузка в шлюз движений ДС*/
  elif(process.value("t_subtype") == 104)                                                                                        //Sve 516409 250920 в параметре -IncRepo: убран параметр 'x'
    if(DL_ИспользPaymentsПриИмпортеВалютногоРынка) 
       resultproc = ReceiveVRPM(opernum, "-beg_date:" + date(process.value("t_operdate")) + "-end_date:" + date(process.value("t_operdate")) + "-requests:  -deals:  -own_deals:  -client_deals:  -margin:  -nettoitog:  -commissions:  -moneymotion:x -moneymotion_cm: ", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
       if ((resultproc == true) and (recs == 0))
         // Если данные не загружены, то выдадим предупреждение DEF-54657
         wrnrecs = 1;
         errmsg = "ПРЕДУПРЕЖДЕНИЕ: Нет данных в Payments (по файлу CCX99_EQ1)";
         SendNotificationCCX99_EQ1();
       end;
    else
       resultproc = ReceiveMVB4(opernum, "-imp_date:" + date(process.value("t_operdate")) + " -Market:ММВБ -rates:  -comp:  -paym:  -IncRepo: -request:  -deals:  -deals_clearing:  -deals_clearing_client:  -moneymotion:x -ksuwrt:  -deals_bo:  -deals_seb:  -deals_du:  -MarketSchemeDU", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;

  /*Загрузка в шлюз движений КСУ*/
  elif(process.value("t_subtype") == 105)
    if(DL_ИспользPaymentsПриИмпортеММВБЧасть2)
       resultproc = ReceivePMTS(opernum, "-imp_date:" + date(process.value("t_operdate")) + " -request:  -deals:  -deals_clearing:  -deals_bo:  -deals_seb:  -request_otc:  -deals_otc:  -nettoitog:  -ksuwrt:x", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    else
       resultproc = ReceiveMVB4(opernum, "-imp_date:" + date(process.value("t_operdate")) + " -Market:ММВБ -rates:  -comp:  -paym:  -request:  -deals:  -deals_clearing:  -deals_clearing_client:  -moneymotion:  -ksuwrt:x -deals_bo:  -deals_seb:  -deals_du:  -MarketSchemeDU", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;

  /* Загрузка в шлюз Итоговых нетто-ТО по ФИ */ // Golovkin 01.04.2020 NettoItog 
  elif(process.value("t_subtype") == 106)
    if(DL_ЕдиныйПулОбеспеченияСобств)
       if(DL_ИспользPaymentsПриИмпортеММВБЧасть2)
          resultproc = ReceivePMTS(opernum, "-imp_date:" + date(process.value("t_operdate")) + " -request:  -deals:  -deals_clearing:  -deals_bo:  -deals_seb:  -request_otc:  -deals_otc:  -nettoitog:x  -ksuwrt: ", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
       else
          resultproc = ReceiveMVB4(opernum, "-imp_date:" + date(process.value("t_operdate")) + " -Market:ММВБ -rates:  -comp:  -paym:  -request:  -deals:  -deals_clearing:  -deals_clearing_client:  -moneymotion: -NettoItog:x  -ksuwrt:  -deals_bo:  -deals_seb:  -deals_du:  -MarketSchemeDU", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
       end;
    else
      resultproc = true; // Golovkin если не единый пул, то не выполняем
    end; 
  elif(process.value("t_subtype") == 4040)
    if(DL_ИспользPaymentsПриИмпортеСПБЧасть2)
       resultproc = ReceiveSpbP(opernum, "-imp_date:" + date(process.value("t_operdate")) + " -request:  -deals:  -deals_clearing_client:  -deals_bo:  -nettoitog:x -moneymotion: ", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);   
    else
       resultproc = ReceiveSPB4(opernum, "-imp_date:" + date(process.value("t_operdate")) + " -Market:ПАО СПБ -rates:  -comp:  -paym:  -request:  -deals:  -deals_clearing:  -deals_clearing_client:  -moneymotion: -NettoItog:x  -ksuwrt:  -deals_bo:  -deals_seb:  -deals_du:  -MarketSchemeDU", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;

  elif(process.value("t_subtype") == 4110)
    if(DL_ИспользPaymentsПриИмпортеСПБЧасть2)
       resultproc = ReceiveSpbP(opernum, "-imp_date:" + date(process.value("t_operdate")) + " -request:  -deals:  -deals_clearing_client:  -deals_bo:  -nettoitog:  -moneymotion:x", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);   
    else
       resultproc = ReceiveSPB4(opernum, "-imp_date:" + date(process.value("t_operdate")) + " -Market:ПАО СПБ -rates:  -comp:  -paym:  -request:  -deals:  -deals_clearing:  -deals_clearing_client:  -moneymotion:x -NettoItog:  -ksuwrt:  -deals_bo:  -deals_seb:  -deals_du:  -MarketSchemeDU", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;
  elif(process.value("t_subtype") == 5010)
    resultproc = ReceiveSPVB(opernum, "-beg_date:" + date(process.value("t_operdate")) + "-end_date:" + date(process.value("t_operdate")), @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
  elif(process.value("t_subtype") == 5015) /*коммссии СПВБ*/
    resultproc = ReceiveSРVBcomiss(opernum, "-beg_date:" + date(process.value("t_operdate")) + "-end_date:" + date(process.value("t_operdate")), @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);

  elif(process.value("t_subtype") == 107) /*PNV Комиссионное вознаграждение*/
    if(DL_ЕдиныйПулОбеспеченияСобств)
       if(DL_ИспользPaymentsПриИмпортеВалютногоРынка) 
          resultproc = ReceiveVRPM(opernum, "-beg_date:" + date(process.value("t_operdate")) + "-end_date:" + date(process.value("t_operdate")) + "-requests:  -deals:  -own_deals:  -client_deals:  -margin:  -nettoitog:  -commissions:x -moneymotion:  -moneymotion_cm: ", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
       else
          resultproc = ReceiveCVVR(opernum, "-beg_date:" + date(process.value("t_operdate")) + "-end_date:" + date(process.value("t_operdate")), @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
       end;
    else
      resultproc = true; // Golovkin если не единый пул, то не выполняем
    end;
  /*Загрузка в шлюз биржевых данных*/
  elif(process.value("t_subtype") == 111)
    if(DL_ИспользPaymentsПриИмпортеСрочногоРынка) 
       resultproc = ReceiveCSVP(opernum, "-imp_date:" + date(process.value("t_operdate")) + " "
                                       + "-beg_date:" + date(process.value("t_operdate")) + " "
                                       + "-end_date:" + date(process.value("t_operdate")) + " "
                                       + "-futures:x -option:x -file_pos:x -file_deals:x -file_itog:x -file_request:  -file_coms:x "
                                       + "-com_code:МскБиржСбор -file_mon:x -impNewFutures:x -impNewOption:x ", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    else
       resultproc = ReceiveCSV(opernum, "-imp_date:" + date(process.value("t_operdate")) + " "
                                      + "-beg_date:" + date(process.value("t_operdate")) + " "
                                      + "-end_date:" + date(process.value("t_operdate")) + " "
                                      + "-futures:x -option:x -file_pos:x -file_deals:x -file_itog:x -file_request:  -file_coms:x "
                                      + "-com_code:МскБиржСбор -file_mon:x -impNewFutures:x -impNewOption:x ", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;
    if( (recs == 0) and not isHoliday(date(process.value("t_operdate")), 401) )
       errmsg = "Отсутствуют загруженные данные, влияющие на расчет лимитов и дальнейшую обработку дня";
       resultproc = false;
    end;
  
  /* Загрузка в шлюз заявок-поручений на сделки */
  elif(process.value("t_subtype") == 112)    
    if(DL_ИспользPaymentsПриИмпортеСрочногоРынка) 
       resultproc = ReceiveCSVP(opernum, "-imp_date:" + date(process.value("t_operdate")) + " "
                                       + "-beg_date:" + date(process.value("t_operdate")) + " "
                                       + "-end_date:" + date(process.value("t_operdate")) + " "
                                       + "-futures:x -option:x -file_pos:  -file_deals:  -file_itog:  -file_request:x -file_coms:  "
                                       + "-com_code:  -file_mon:  -impNewFutures:  -impNewOption:  ", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    else
       resultproc = ReceiveCSV(opernum, "-imp_date:" + date(process.value("t_operdate")) + " "
                                      + "-beg_date:" + date(process.value("t_operdate")) + " "
                                      + "-end_date:" + date(process.value("t_operdate")) + " "
                                      + "-futures:x -option:x -file_pos:  -file_deals:  -file_itog:  -file_request:x -file_coms:  "
                                      + "-com_code:  -file_mon:  -impNewFutures:  -impNewOption:  ", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;  
  //Загрузка в Шлюз переводов ДС клиентов SRC-99 панель IMP_PRM3 
  elif(process.value("t_subtype") == 121) 
    if(DL_ИспользPaymentsПриИмпортеВалютногоРынка) 
       resultproc = ReceiveVRPM(opernum, "-beg_date:" + date(process.value("t_operdate")) + "-end_date:" + date(process.value("t_operdate")) + "-requests:  -deals:  -own_deals:  -client_deals:  -margin:  -nettoitog:  -commissions:  -moneymotion:  -moneymotion_cm:x", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    else
       resultproc = ReceiveCX99(opernum, "-imp_date:" + date(process.value("t_operdate")) + " -Market:ММВБ -rates:  -comp:  -paym:  -request:  -deals:  -deals_clearing:  -deals_clearing_client:  -deals_bo:  -deals_seb:  -deals_du:  -MarketSchemeDU:  -nettoitog:  -moneymotion:x", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;
  
  //Загрузка в Шлюз итогов валютных торгов SRC-23 панель IMP_ITOG
  elif(process.value("t_subtype") == 122)
    if(DL_ИспользPaymentsПриИмпортеВалютногоРынка) 
       resultproc = ReceiveVRPM(opernum, "-beg_date:" + date(process.value("t_operdate")) + "-end_date:" + date(process.value("t_operdate")) + "-requests:  -deals:  -own_deals:  -client_deals:  -margin:  -nettoitog:x -commissions:  -moneymotion:  -moneymotion_cm: ", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    else 
       resultproc = ReceiveICVR(opernum, "-beg_date:" + date(process.value("t_operdate")) + "-end_date:" + date(process.value("t_operdate")), @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;
  
  //Загрузка в Шлюз сделок SRC-18 панель IMP_VR
  elif(process.value("t_subtype") == 123)
    if(DL_ИспользPaymentsПриИмпортеВалютногоРынка) 
       resultproc = ReceiveVRPM(opernum, "-beg_date:" + date(process.value("t_operdate")) + "-end_date:" + date(process.value("t_operdate")) + "-requests:  -deals:x -own_deals:  -client_deals:x -margin:  -nettoitog:  -commissions:  -moneymotion:  -moneymotion_cm: ", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    else
       resultproc = Receive__VR(opernum, "-beg_date:" + date(process.value("t_operdate")) + "-end_date:" + date(process.value("t_operdate")) + "-own_deals:  -client_deals:x   -ccx17:  -cux22:  -cux23:x", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;
    if(recs == 0)
       errmsg = "Отсутствуют загруженные данные, влияющие на расчет лимитов и дальнейшую обработку дня";
       resultproc = false;
    end;

  //Загрузка в Шлюз заявок SRC-18 панель IMP_VR
  elif(process.value("t_subtype") == 124)
    if(DL_ИспользPaymentsПриИмпортеВалютногоРынка) 
       resultproc = ReceiveVRPM(opernum, "-beg_date:" + date(process.value("t_operdate")) + "-end_date:" + date(process.value("t_operdate")) + "-requests:x -deals:  -own_deals:  -client_deals:  -margin:  -nettoitog:  -commissions:  -moneymotion:  -moneymotion_cm: ", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    else
       resultproc = Receive__VR(opernum, "-beg_date:" + date(process.value("t_operdate")) + "-end_date:" + date(process.value("t_operdate")) + "-own_deals:  -client_deals:x   -ccx17:  -cux22:x  -cux23:", @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;

  /*SVE в рамках темы 508997 добавлена трассировака на все пункты СО "Обработка ценных бумаг" файл без установленной трассировки будет лежать !ОБМЕН\Shaykov\AutoProcess.mac*/  
  /*Загрузка в БО заявок на сделки клиентов*/
  elif(process.value("t_subtype") == 201)
   // SetRSTrace(true);  //17-06-2020 по теме 511711
    ToRsTrace("Начало обработки п. Загрузка в БО заявок на сделки клиентов ");
    resultproc = ProcessBO(133/*SRC-28*/, opernum, 25/*Заявка на сделку с ц/б*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs, -1);
    if((recs == 0) and (errrecs == 0) and (errmsg == ""))
       resultproc = ProcessBO(112/*SRC-12*/, opernum, 25/*Заявка на сделку с ц/б*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs, -1);
    end;
    ToRsTrace("Окончание обработки п.7 Загрузка в БО заявок на сделки клиентов");
   // SetRSTrace(false);  //17-06-2020 по теме 511711

  /*Загрузка в БО заявок на сделки клиентов СПБ*/
  elif(process.value("t_subtype") == 4050)
    ToRsTrace("Начало обработки п. Загрузка в БО заявок на сделки клиентов СПБ");
    resultproc = ProcessBO(134/*SRC-29*/, opernum, 25/*Заявка на сделку с ц/б*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs, -1);
    if((recs == 0) and (errrecs == 0) and (errmsg == ""))
       resultproc = ProcessBO(131/*SRC-27*/, opernum, 25/*Заявка на сделку с ц/б*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs, -1);
    end;
    ToRsTrace("Окончание обработки п.7 Загрузка в БО заявок на сделки клиентов СПБ");

  /*Загрузка в БО заявок на сделки банка*/
  elif(process.value("t_subtype") == 209)
   // SetRSTrace(true);     //17-06-2020 по теме 511711
    ToRsTrace("Начало обработки п. Загрузка в БО заявок на сделки банка ");
    resultproc = ProcessBO(133/*SRC-28*/, opernum, 25/*Заявка на сделку с ц/б*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs, 1); 
    if((recs == 0) and (errrecs == 0) and (errmsg == ""))
       resultproc = ProcessBO(112/*SRC-12*/, opernum, 25/*Заявка на сделку с ц/б*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs, 1);
    end;
    ToRsTrace("Окончание обработки п.7 Загрузка в БО заявок на сделки банка");
   // SetRSTrace(false);   //17-06-2020 по теме 511711

  /*Загрузка в БО отчета биржи*/
  elif(process.value("t_subtype") == 202)
/*KD*/
/*Проверки отсутствия ЗР в статусе готов к обраотке по предыдущему пункту. При наличии - информирование и перезапуск пункта.*/
   If(CheckPrewOper(1, 201, process.value("t_operdate")))

      ProcessPrew = GetRecPrewProc(1, 201, process.value("t_operdate"));
      if (ProcessPrew.movenext())
         SendNotificationZR(@ProcessPrew);
         if(not DeleteProcessItem(@ProcessPrew, @errmsg, true))
            msgboxex("Ошибка при удалении обработки процесса '" + ProcessPrew.value("t_name") + "'|"+errmsg);
          else
            resultproc = ProcessBO(133/*SRC-28*/, opernum, 25/*Заявка на сделку с ц/б*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs, -1); 
            if((recs == 0) and (errrecs == 0) and (errmsg == ""))
               resultproc = ProcessBO(112/*SRC-12*/, opernum, 25/*Заявка на сделку с ц/б*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs, -1);
            end;
            CheckResultProcPrew(resultproc, @ProcessPrew, seanceid, recs, errrecs, errmsg, wrnrecs);
          end;

      end;

   end;
    resultproc = ProcessBO(133/*SRC-28*/, opernum, 80/*Отчет биржи*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    if((recs == 0) and (errrecs == 0) and (errmsg == ""))
       resultproc = ProcessBO(112/*SRC-12*/, opernum, 80/*Отчет биржи*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;
  elif(process.value("t_subtype") == 4060)  //СПБ
    resultproc = ProcessBO(134/*SRC-29*/, opernum, 80/*Отчет биржи*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    if((recs == 0) and (errrecs == 0) and (errmsg == ""))
       resultproc = ProcessBO(131/*SRC-27*/, opernum, 80/*Отчет биржи*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;

  /*Загрузка в БО клиентских сделок с ценными бумагами*/
  elif(process.value("t_subtype") == 203)
    resultproc = ProcessBO(133/*SRC-28*/, opernum, 21/*Сделка с ценными бумагами*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs, -1);
    if((recs == 0) and (errrecs == 0) and (errmsg == ""))
       resultproc = ProcessBO(112/*SRC-12*/, opernum, 21/*Сделка с ценными бумагами*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs, -1);
    end;
  elif(process.value("t_subtype") == 4070) //СПБ
    resultproc = ProcessBO(134/*SRC-29*/, opernum, 21/*Сделка с ценными бумагами*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs, -1);
    if((recs == 0) and (errrecs == 0) and (errmsg == ""))
       resultproc = ProcessBO(131/*SRC-27*/, opernum, 21/*Сделка с ценными бумагами*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs, -1);
    end;

  /*Загрузка в БО собственных сделок с ценными бумагами*/
  elif(process.value("t_subtype") == 210)
    resultproc = ProcessBO(133/*SRC-28*/, opernum, 21/*Сделка с ценными бумагами*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs, 1);
    if((recs == 0) and (errrecs == 0) and (errmsg == ""))
       resultproc = ProcessBO(112/*SRC-12*/, opernum, 21/*Сделка с ценными бумагами*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs, 1);
    end;
  /*Загрузка в БО клиентских сделок, принятых на клиринг*/
  elif(process.value("t_subtype") == 204)

    /*KD*/
    /*Проверки отсутствия ЗР в статусе готов к обработке по предыдущему пункту. При наличии - информирование и перезапуск пункта.*/
    If(CheckPrewOper(1, 203, process.value("t_operdate")))
      ProcessPrew = GetRecPrewProc(1, 203, process.value("t_operdate"));
      if (ProcessPrew.movenext())
         SendNotificationZR(@ProcessPrew);
         if(not DeleteProcessItem(@ProcessPrew, @errmsg, true))
            msgboxex("Ошибка при удалении обработки процесса '" + ProcessPrew.value("t_name") + "'|"+errmsg);
          else
            resultproc = ProcessBO(133/*SRC-28*/, opernum, 21/*Сделка с ценными бумагами*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs, -1);
            if((recs == 0) and (errrecs == 0) and (errmsg == ""))
               resultproc = ProcessBO(112/*SRC-12*/, opernum, 21/*Сделка с ценными бумагами*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs, -1);
            end;
            CheckResultProcPrew(resultproc, @ProcessPrew, seanceid, recs, errrecs, errmsg, wrnrecs);
          end;

      end;

   end;

    resultproc = ProcessBO(133/*SRC-28*/, opernum, 27/*Клиринг. Сделка с ценными бумагам*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs, -1);
    if((recs == 0) and (errrecs == 0) and (errmsg == ""))
       resultproc = ProcessBO(112/*SRC-12*/, opernum, 27/*Клиринг. Сделка с ценными бумагам*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs, -1);
    end;
  elif(process.value("t_subtype") == 4080) //СПБ
    resultproc = ProcessBO(134/*SRC-29*/, opernum, 27/*Клиринг. Сделка с ценными бумагам*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs, -1);
    if((recs == 0) and (errrecs == 0) and (errmsg == ""))
       resultproc = ProcessBO(131/*SRC-27*/, opernum, 27/*Клиринг. Сделка с ценными бумагам*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs, -1);
    end;

  /*Загрузка в БО собственных сделок, принятых на клиринг*/
  elif(process.value("t_subtype") == 230)
    resultproc = ProcessBO(133/*SRC-28*/, opernum, 27/*Клиринг. Сделка с ценными бумагам*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs, 1);
    if((recs == 0) and (errrecs == 0) and (errmsg == ""))
       resultproc = ProcessBO(112/*SRC-12*/, opernum, 27/*Клиринг. Сделка с ценными бумагам*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs, 1);
    end;

  /*Загрузка в БО движений ДС*/
  elif(process.value("t_subtype") == 205)
    resultproc = ProcessBO(135/*SRC-30*/, opernum, 56/*Движение ДС*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    if((recs == 0) and (errrecs == 0) and (errmsg == ""))
       resultproc = ProcessBO(112/*SRC-12*/, opernum, 56/*Движение ДС*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;

  /*Загрузка в БО движений КСУ*/ 
  elif(process.value("t_subtype") == 206)
    resultproc = ProcessBO(133/*SRC-28*/, opernum, 30/*Списание/зачисление КСУ*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    if((recs == 0) and (errrecs == 0) and (errmsg == ""))
       resultproc = ProcessBO(112/*SRC-12*/, opernum, 30/*Списание/зачисление КСУ*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;

  /*Загрузка в БО Итоговых нетто-ТО по ФИ*/ // Golovkin 01.04.2020 NettoItog 
  elif(process.value("t_subtype") == 207)
    if(DL_ЕдиныйПулОбеспеченияСобств)
       resultproc = ProcessBO(133/*SRC-28*/, opernum, 96/*Итоговые нетто-требования и нетто-обязательства*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
       if((recs == 0) and (errrecs == 0) and (errmsg == ""))
          resultproc = ProcessBO(112/*SRC-12*/, opernum, 96/*Итоговые нетто-требования и нетто-обязательства*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
       end;
    else
      resultproc = true; // Golovkin если не единый пул, то не выполняем
    end;
  elif(process.value("t_subtype") == 4100)
    resultproc = ProcessBO(134/*SRC-29*/, opernum, 96/*Итоговые нетто-требования и нетто-обязательства*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    if((recs == 0) and (errrecs == 0) and (errmsg == ""))
      resultproc = ProcessBO(131/*SRC-27*/, opernum, 96/*Итоговые нетто-требования и нетто-обязательства*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;
  elif(process.value("t_subtype") == 5030)
    resultproc = ProcessBO(1002/*SRC-40*/, opernum, 96/*Итоговые нетто-требования и нетто-обязательства*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
  elif(process.value("t_subtype") == 5040)
    resultproc = ProcessBO(1003/*SRC-41*/, opernum, 97/*Комиссионное вознаграждение*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);

  elif(process.value("t_subtype") == 4120)
    resultproc = ProcessBO(134/*SRC-29*/, opernum, 56/*Движение ДС*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    if((recs == 0) and (errrecs == 0) and (errmsg == ""))
      resultproc = ProcessBO(131/*SRC-27*/, opernum, 56/*Движение ДС*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;

  /*Загрузка котировок с СПБ*/
  elif(process.value("t_subtype") == 4130)
    if(DL_ИспользPaymentsПриИмпортеСПБЧасть2)
      resultproc = ExecMacroFile("spLibU", "LoadingQuoatesSPB_PM", date(process.value("t_operdate")), @result_protocol, @recs, @errrecs, @errmsg, @wrnrecs);
    else
      resultproc = ExecMacroFile("spLibU", "LoadingQuoatesSPB", date(process.value("t_operdate")), @result_protocol, @recs, @errrecs, @errmsg, @wrnrecs);
    end;

  elif(process.value("t_subtype") == 208) /*PNV*/
    if(DL_ЕдиныйПулОбеспеченияСобств)
      resultproc = ProcessBO(135/*SRC-30*/, opernum, 97/*Комиссионное вознаграждение*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
      if((recs == 0) and (errrecs == 0) and (errmsg == ""))
        resultproc = ProcessBO(129/*SRC-25*/, opernum, 97/*Комиссионное вознаграждение*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
      end;
    else
      resultproc = true; // Golovkin если не единый пул, то не выполняем
    end;
  /*Загрузка в БО производных инструментов*/
  elif(process.value("t_subtype") == 211)
    if(isHoliday(date(process.value("t_operdate")), 401))
      resultproc = true;
      errmsg = "Не предусмотрена обработка пункта в выходные дни";
    else
      resultproc = ProcessBO(136/*SRC-31*/, opernum, 8/*Производный инструмент*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
      if((recs == 0) and (errrecs == 0) and (errmsg == ""))
        resultproc = ProcessBO(119/*SRC-19*/, opernum, 8/*Производный инструмент*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
      end;
    end;
  /*Загрузка в БО курсов финансовых инструментов*/
  elif(process.value("t_subtype") == 212)
    if(isHoliday(date(process.value("t_operdate")), 401))
      resultproc = true;
      errmsg = "Не предусмотрена обработка пункта в выходные дни";
    else
      /*KD*/
      /*Проверки отсутствия ЗР в статусе готов к обработке по предыдущему пункту. При наличии - информирование и перезапуск пункта.*/
      if(CheckPrewOper(2, 211, process.value("t_operdate")))
        ProcessPrew = GetRecPrewProc(2, 211, process.value("t_operdate"));
        if (ProcessPrew.movenext())
          SendNotificationZR(@ProcessPrew);
          if(not DeleteProcessItem(@ProcessPrew, @errmsg, true))
            msgboxex("Ошибка при удалении обработки процесса '" + ProcessPrew.value("t_name") + "'|"+errmsg);
          else
            resultproc = ProcessBO(136/*SRC-31*/, opernum, 8/*Производный инструмент*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
            if((recs == 0) and (errrecs == 0) and (errmsg == ""))
              resultproc = ProcessBO(119/*SRC-19*/, opernum, 8/*Производный инструмент*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
            end;
            CheckResultProcPrew(resultproc, @ProcessPrew, seanceid, recs, errrecs, errmsg, wrnrecs);
          end;
        end;
      end;
      resultproc = ProcessBO(136/*SRC-31*/, opernum, 50/*Курс финансового инструмента*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
      if((recs == 0) and (errrecs == 0) and (errmsg == ""))
        resultproc = ProcessBO(119/*SRC-19*/, opernum, 50/*Курс финансового инструмента*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
      end;
    end;
  /*Загрузка в БО биржевых операций с ПИ*/
  elif(process.value("t_subtype") == 213)
    /*KD*/
    /*Проверки отсутствия ЗР в статусе готов к обработке по предыдущему пункту. При наличии - информирование и перезапуск пункта.*/
    If(CheckPrewOper(2, 212, process.value("t_operdate")))
      ProcessPrew = GetRecPrewProc(2, 212, process.value("t_operdate"));
      if (ProcessPrew.movenext())
         SendNotificationZR(@ProcessPrew);
         if(not DeleteProcessItem(@ProcessPrew, @errmsg, true))
            msgboxex("Ошибка при удалении обработки процесса '" + ProcessPrew.value("t_name") + "'|"+errmsg);
          else
             resultproc = ProcessBO(136/*SRC-31*/, opernum, 50/*Курс финансового инструмента*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
             if((recs == 0) and (errrecs == 0) and (errmsg == ""))
                resultproc = ProcessBO(119/*SRC-19*/, opernum, 50/*Курс финансового инструмента*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
             end;
            CheckResultProcPrew(resultproc, @ProcessPrew, seanceid, recs, errrecs, errmsg, wrnrecs);
          end;

      end;

   end;

    //SetRSTrace(true);     //17-06-2020 по теме 511711
   resultproc = ProcessBO(136/*SRC-31*/, opernum, 86/*Биржевая операция с ПИ*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
   if((recs == 0) and (errrecs == 0) and (errmsg == ""))
      resultproc = ProcessBO(119/*SRC-19*/, opernum, 86/*Биржевая операция с ПИ*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
   end;
   // SetRSTrace(false);    //17-06-2020 по теме 511711

  /*Загрузка в БО итоги дня по позиции ПИ*/
  elif(process.value("t_subtype") == 214)
    if(isHoliday(date(process.value("t_operdate")), 401))
      resultproc = true;
      errmsg = "Не предусмотрена обработка пункта в выходные дни";
    else
      /*KD*/
      /*Проверки отсутствия ЗР в статусе готов к обработке по предыдущему пункту. При наличии - информирование и перезапуск пункта.*/
      if(CheckPrewOper(2, 213, process.value("t_operdate")))
        ProcessPrew = GetRecPrewProc(2, 213, process.value("t_operdate"));
        if (ProcessPrew.movenext())
          SendNotificationZR(@ProcessPrew);
          if(not DeleteProcessItem(@ProcessPrew, @errmsg, true))
            msgboxex("Ошибка при удалении обработки процесса '" + ProcessPrew.value("t_name") + "'|"+errmsg);
          else
            resultproc = ProcessBO(136/*SRC-31*/, opernum, 86/*Биржевая операция с ПИ*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
            if((recs == 0) and (errrecs == 0) and (errmsg == ""))
              resultproc = ProcessBO(119/*SRC-19*/, opernum, 86/*Биржевая операция с ПИ*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
            end;
            CheckResultProcPrew(resultproc, @ProcessPrew, seanceid, recs, errrecs, errmsg, wrnrecs);
          end;
        end;
      end;
      resultproc = ProcessBO(136/*SRC-31*/, opernum, 87/*Итоги дня по позиции ПИ*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
      if((recs == 0) and (errrecs == 0) and (errmsg == ""))
        resultproc = ProcessBO(119/*SRC-19*/, opernum, 87/*Итоги дня по позиции ПИ*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
      end;
    end;
  /*Загрузка в БО разовой комиссии*/
  elif(process.value("t_subtype") == 215)
    if(isHoliday(date(process.value("t_operdate")), 401))
      resultproc = true;
      errmsg = "Не предусмотрена обработка пункта в выходные дни";
    else
      /*KD*/
      /*Проверки отсутствия ЗР в статусе готов к обработке по предыдущему пункту. При наличии - информирование и перезапуск пункта.*/
      if(CheckPrewOper(2, 214, process.value("t_operdate")))
        ProcessPrew = GetRecPrewProc(2, 214, process.value("t_operdate"));
        if (ProcessPrew.movenext())
          SendNotificationZR(@ProcessPrew);
          if(not DeleteProcessItem(@ProcessPrew, @errmsg, true))
            msgboxex("Ошибка при удалении обработки процесса '" + ProcessPrew.value("t_name") + "'|"+errmsg);
          else
            resultproc = ProcessBO(136/*SRC-31*/, opernum, 87/*Итоги дня по позиции ПИ*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
            if((recs == 0) and (errrecs == 0) and (errmsg == ""))
              resultproc = ProcessBO(119/*SRC-19*/, opernum, 87/*Итоги дня по позиции ПИ*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
            end;
            CheckResultProcPrew(resultproc, @ProcessPrew, seanceid, recs, errrecs, errmsg, wrnrecs);
          end;
        end;
      end;

      resultproc = ProcessBO(136/*SRC-31*/, opernum, 65/*Разовая комиссия*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
      if((recs == 0) and (errrecs == 0) and (errmsg == ""))
        resultproc = ProcessBO(119/*SRC-19*/, opernum, 65/*Разовая комиссия*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
      end;
      resultproc = resultproc and DvMoexClearingExecCommissCreator.CalcAndCreate(date(process.value("t_operdate")));
    end;
  /*Загрузка в БО отчета биржи*/
  elif(process.value("t_subtype") == 216)
    if(isHoliday(date(process.value("t_operdate")), 401))
      resultproc = true;
      errmsg = "Не предусмотрена обработка пункта в выходные дни";
    else
      resultproc = ProcessBO(136/*SRC-31*/, opernum, 80/*Отчета биржи*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
      if((recs == 0) and (errrecs == 0) and (errmsg == ""))
        resultproc = ProcessBO(119/*SRC-19*/, opernum, 80/*Отчета биржи*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
      end;
    end;
  /*Загрузка в БО обработка отчета по операции*/
  elif(process.value("t_subtype") == 217)
    if(isHoliday(date(process.value("t_operdate")), 401))
      resultproc = true;
      errmsg = "Не предусмотрена обработка пункта в выходные дни";
    else
      resultproc = ProcessBO(136/*SRC-31*/, opernum, 88/*Обработка отчета по операции*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
      if((recs == 0) and (errrecs == 0) and (errmsg == ""))
        resultproc = ProcessBO(119/*SRC-19*/, opernum, 88/*Обработка отчета по операции*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
      end;
    end;
  /*Загрузка в БО информации о гарантийном обеспечении*/
  elif(process.value("t_subtype") == 218)
    if(isHoliday(date(process.value("t_operdate")), 401))
      resultproc = true;
      errmsg = "Не предусмотрена обработка пункта в выходные дни";
    else
      resultproc = ProcessBO(136/*SRC-31*/, opernum, 94/*Обработка информации о ГО*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
      if((recs == 0) and (errrecs == 0) and (errmsg == ""))
        resultproc = ProcessBO(119/*SRC-19*/, opernum, 94/*Обработка информации о ГО*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
      end;
    end;
  /*Загрузка в БО заявок-поручений на сделки*/
  elif(process.value("t_subtype") == 219)
    resultproc = ProcessBO(136/*SRC-31*/, opernum, 95/*Заявка на сделку с ПИ*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    if((recs == 0) and (errrecs == 0) and (errmsg == ""))
      resultproc = ProcessBO(119/*SRC-19*/, opernum, 95/*Заявка на сделку с ПИ*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;

  //Загрузка в БО переводов SRC-99
  elif(process.value("t_subtype") == 221)
    resultproc = ProcessBO(135/*SRC-30*/, opernum, 5001/*Движение ДС ВБ*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    if((recs == 0) and (errrecs == 0) and (errmsg == ""))
       resultproc = ProcessBO(1001/*SRC-99*/, opernum, 5001/*Движение ДС ВБ*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;

  //Загрузка в БО итогов валютных торгов  SRC-23 DocKind=4633 OperKind=2835
  elif(process.value("t_subtype") == 222)
    resultproc = ProcessBO(135/*SRC-30*/, opernum, 96/*Итоговые нетто-требования и нетто-обязательства*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    if((recs == 0) and (errrecs == 0) and (errmsg == ""))
       resultproc = ProcessBO(127/*SRC-25*/, opernum, 96/*Итоговые нетто-требования и нетто-обязательства*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;

  //Загрузка в БО сделок           SRC-18 
  elif(process.value("t_subtype") == 223)
    resultproc = ProcessBO(135/*SRC-30*/, opernum, 54, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    if((recs == 0) and (errrecs == 0) and (errmsg == ""))
       resultproc = ProcessBO(118/*SRC-18*/, opernum, 54, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;

  //Загрузка в БО Отчета биржи SRC-18 
  elif(process.value("t_subtype") == 224)


     /*KD*/
    /*Проверки отсутствия ЗР в статусе готов к обработке по предыдущему пункту. При наличии - информирование и перезапуск пункта.*/
    If(CheckPrewOper(3, 223, process.value("t_operdate")))
      ProcessPrew = GetRecPrewProc(3, 223, process.value("t_operdate"));
      if (ProcessPrew.movenext())
         SendNotificationZR(@ProcessPrew);
         if(not DeleteProcessItem(@ProcessPrew, @errmsg, true))
            msgboxex("Ошибка при удалении обработки процесса '" + ProcessPrew.value("t_name") + "'|"+errmsg);
          else
            resultproc = ProcessBO(135/*SRC-30*/, opernum, 54, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
            if((recs == 0) and (errrecs == 0) and (errmsg == ""))
               resultproc = ProcessBO(118/*SRC-18*/, opernum, 54, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
            end;
            CheckResultProcPrew(resultproc, @ProcessPrew, seanceid, recs, errrecs, errmsg, wrnrecs);
          end;

      end;

   end;

    resultproc = ProcessBO(135/*SRC-30*/, opernum, 80, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    if((recs == 0) and (errrecs == 0) and (errmsg == ""))
       resultproc = ProcessBO(118/*SRC-18*/, opernum, 80, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;

  //Загрузка в БО заявок           SRC-18 
  elif(process.value("t_subtype") == 225)
    resultproc = ProcessBO(135/*SRC-30*/, opernum, 95, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    if((recs == 0) and (errrecs == 0) and (errmsg == ""))
       resultproc = ProcessBO(118/*SRC-18*/, opernum, 95, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;

  elif(process.value("t_subtype") == 226)/*загрузка ежемесячных комиссий*/
    resultproc = ProcessBO(135/*SRC-30*/, opernum, 97/*Комиссионное вознаграждение*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    if((recs == 0) and (errrecs == 0) and (errmsg == ""))
       resultproc = ProcessBO(1001/*SRC-99*/, opernum, 97/*Комиссионное вознаграждение*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
    end;

  /*Старт биржевых клиентских сделок БО*/
  elif(process.value("t_subtype") == 301)
    resultproc = ExecMacroFile("spLibU", "StartDeal", date(process.value("t_operdate")), @result_protocol, @recs, @errrecs, @errmsg, @wrnrecs, -1);


  /*Старт биржевых собственных сделок БО*/
  elif(process.value("t_subtype") == 303)
    resultproc = ExecMacroFile("spLibU", "StartDeal", date(process.value("t_operdate")), @result_protocol, @recs, @errrecs, @errmsg, @wrnrecs, 1);

  /*Загрузка котировок с ММВБ*/
  elif(process.value("t_subtype") == 302)
    if(DL_ИспользPaymentsПриИмпортеММВБЧасть2)
       resultproc = ExecMacroFile("spLibU", "LoadingQuoatesPM", date(process.value("t_operdate")), @result_protocol, @recs, @errrecs, @errmsg, @wrnrecs);
    else
       resultproc = ExecMacroFile("spLibU", "LoadingQuoates", date(process.value("t_operdate")), @result_protocol, @recs, @errrecs, @errmsg, @wrnrecs);
    end;

  /*Расчет комиссий*/
  elif(process.value("t_subtype") == 401)

     /*KD*/
    /*Проверки отсутствия ЗР в статусе готов к обработке по предыдущему пункту. При наличии - информирование и перезапуск пункта.*/
    If(CheckPrewOper(1, 204, process.value("t_operdate")))
      ProcessPrew = GetRecPrewProc(1, 204, process.value("t_operdate"));
      if (ProcessPrew.movenext())
         SendNotificationZR(@ProcessPrew);
         if(not DeleteProcessItem(@ProcessPrew, @errmsg, true))
            msgboxex("Ошибка при удалении обработки процесса '" + ProcessPrew.value("t_name") + "'|"+errmsg);
          else
            resultproc = ProcessBO(133/*SRC-28*/, opernum, 27/*Клиринг. Сделка с ценными бумагам*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs, -1);
            if((recs == 0) and (errrecs == 0) and (errmsg == ""))
               resultproc = ProcessBO(112/*SRC-12*/, opernum, 27/*Клиринг. Сделка с ценными бумагам*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs, -1);
            end;
            CheckResultProcPrew(resultproc, @ProcessPrew, seanceid, recs, errrecs, errmsg, wrnrecs);
          end;

      end;

   end;

    SetGlobalParameter("NOT_PRINT_CALCED_COMISS", "X"); //biq-11080
    resultproc = ExecMacroFile("spLibU", "CalcComiss", date(process.value("t_operdate")), @result_protocol, @recs, @errrecs, @errmsg, @wrnrecs);

  /*Обработка сделок*/
  elif ((process.value("t_subtype") == 411) or (process.value("t_subtype") == 416))
    if(isHoliday(date(process.value("t_operdate")), 401))
      resultproc = true;
      errmsg = "Не предусмотрена обработка пункта в выходные дни";
    else
      //если 411, то клиентские сделки = true
      resultproc = ExecMacroFile("dvLibU", "DV_EXEC", date(process.value("t_operdate")), (process.value("t_subtype") == 411), @result_protocol, @recs, @errrecs, @errmsg, @wrnrecs);
    end;
  /*Инициализация расчетов с биржей*/
  elif ((process.value("t_subtype") == 412) or (process.value("t_subtype") == 415))
    if(isHoliday(date(process.value("t_operdate")), 401))
      resultproc = true;
      errmsg = "Не предусмотрена обработка пункта в выходные дни";
    else    
      /*KD*/
      /*Проверки отсутствия ЗР в статусе готов к обработке по предыдущему пункту. При наличии - информирование и перезапуск пункта.*/
      if(CheckPrewOper(2, 218, process.value("t_operdate")))
        ProcessPrew = GetRecPrewProc(2, 218, process.value("t_operdate"));
        if (ProcessPrew.movenext())
          SendNotificationZR(@ProcessPrew);
          if(not DeleteProcessItem(@ProcessPrew, @errmsg, true))
            msgboxex("Ошибка при удалении обработки процесса '" + ProcessPrew.value("t_name") + "'|"+errmsg);
          else
            resultproc = ProcessBO(136/*SRC-31*/, opernum, 94/*Обработка информации о ГО*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
            if((recs == 0) and (errrecs == 0) and (errmsg == ""))
              resultproc = ProcessBO(119/*SRC-19*/, opernum, 94/*Обработка информации о ГО*/, @seanceid, @recs, @errrecs, @errmsg, @wrnrecs);
            end;
            CheckResultProcPrew(resultproc, @ProcessPrew, seanceid, recs, errrecs, errmsg, wrnrecs);
          end;
        end;
      end;
      //если 412, то клиентские сделки = true
      resultproc = ExecMacroFile("dvLibU", "DVOP_INIT", date(process.value("t_operdate")), (process.value("t_subtype") == 412), @result_protocol, @recs, @errrecs, @errmsg, @wrnrecs);
    end;
  /*Выполнение расчетов с биржей*/
  elif ((process.value("t_subtype") == 413) or (process.value("t_subtype") == 417))
    if(isHoliday(date(process.value("t_operdate")), 401))
      resultproc = true;
      errmsg = "Не предусмотрена обработка пункта в выходные дни";
    else
      //если 413, то клиентские сделки = true
      resultproc = ExecMacroFile("dvLibU", "DVOP_CALC", date(process.value("t_operdate")), (process.value("t_subtype") == 413), @result_protocol, @recs, @errrecs, @errmsg, @wrnrecs);
    end;
  /*Закрытие расчетов с биржей*/
  elif((process.value("t_subtype") == 414) or (process.value("t_subtype") == 418))
    if(isHoliday(date(process.value("t_operdate")), 401))
      resultproc = true;
      errmsg = "Не предусмотрена обработка пункта в выходные дни";
    else
      //если 414, то клиентские сделки = true
      resultproc = ExecMacroFile("dvLibU", "DVOP_CLOSE", date(process.value("t_operdate")), (process.value("t_subtype") == 414), @result_protocol, @recs, @errrecs, @errmsg, @wrnrecs);
    end;
  //Расчет комиссий валютный брокер
  elif(process.value("t_subtype") == 421)
    SetGlobalParameter("BO_ACT_INITIATOR", "ФИССиКО"); 
    SetGlobalParameter("NOT_PRINT_CALCED_COMISS", "X");//biq-11080 
    resultproc = ExecMacroFile("spLibU", "CalcComiss", date(process.value("t_operdate")), @result_protocol, @recs, @errrecs, @errmsg, @wrnrecs);

  //Исполнение сделок  
  elif(process.value("t_subtype") == 422)
    resultproc = ExecMacroFile("dvLibU", "Exec_DVNDEAL", date(process.value("t_operdate")), @result_protocol, @recs, @errrecs, @errmsg, @wrnrecs);
  elif(process.value("t_subtype") == 423)
    resultproc = ExecMacroFile("dvLibU", "RunCurItog", date(process.value("t_operdate")), @result_protocol, @recs, @errrecs, @errmsg, @wrnrecs);
  /*Расчет текущей справедливой стоимости*/
  elif(process.value("t_subtype") == 501)
    resultproc = ExecMacroFile("spLibU", "CalcFairValue", date(process.value("t_operdate")), opernum, @result_comm, @recs, @errrecs, @errmsg, @wrnrecs);

  /*Формирование сервисных операций*/
  elif(process.value("t_subtype") == 502)
    resultproc = ExecMacroFile("spLibU", "CreateSO", date(process.value("t_operdate")), opernum, @result_comm, @result_protocol, @recs, @errrecs, @errmsg, @wrnrecs);

  /*Начисление дохода/расхода*/
  elif(process.value("t_subtype") == 503)
    resultproc = ExecMacroFile("spLibU", "Income", date(process.value("t_operdate")), opernum, @result_comm, @recs, @errrecs, @errmsg, @wrnrecs);

  /*Переоценка*/
  elif(process.value("t_subtype") == 504)
    resultproc = ExecMacroFile("spLibU", "Revaluation", date(process.value("t_operdate")), opernum, @result_comm, @recs, @errrecs, @errmsg, @wrnrecs);

  /*Расчеты с биржей*/
  elif(process.value("t_subtype") == 505)
    resultproc = ExecMacroFile("spLibU", "Caclulations_With_Exchange", date(process.value("t_operdate")), opernum, @result_comm, @recs, @errrecs, @errmsg, @wrnrecs);
  elif(process.value("t_subtype") == 4090)
    resultproc = ExecMacroFile("spLibU", "Caclulations_With_Exchange", date(process.value("t_operdate")), opernum, @result_comm, @recs, @errrecs, @errmsg, @wrnrecs, u_GetClientID( SPB_CODE, PTCK_CONTR)/*СПБ PartyID*/);
  elif(process.value("t_subtype") == 5020)
    resultproc = ExecMacroFile("spLibU", "Caclulations_With_Exchange", date(process.value("t_operdate")), opernum, @result_comm, @recs, @errrecs, @errmsg, @wrnrecs, u_GetClientID( SPVB_CODE, PTCK_CONTR)/*СПБ PartyID*/);
  /*СОБУ по клиентским операциям*/
  elif(process.value("t_subtype") == 506)
    resultproc = ExecMacroFile("spLibU", "CreateSO_AccountingClient", date(process.value("t_operdate")), opernum, @result_comm, @result_protocol, @recs, @errrecs, @errmsg, @wrnrecs);

  /*dan BIQ-12191 перенумерация операций списаний ДС*/
  elif(process.value("t_subtype") == 507)
    resultproc = ExecMacroFile("NPTX_Renum", "execRenum_shed", date(process.value("t_operdate")), @result_protocol, @recs, @errrecs, @errmsg, @wrnrecs);
  /*Расчет лимитов*/
  elif(process.value("t_subtype") == 701) /*Фондовый рынок*/
    startdate = DL_GetMinDateOfCalends(
                  date(process.value("t_operdate")),
                  1,
                  DL_GetCalendarArrByParam(
                    DL_KeyPair("ObjectType",DL_CALLNK_MARKET),
                    DL_KeyPair("MarketPlace",DL_CALLNK_MARKETPLACE_SEC),
                    DL_KeyPair("DayType", DL_CALLNK_MRKTDAY_TRADE)
                  )
                );
    resultproc = ExecMacroFile("spLibU", "CalcLimits", startdate, 1,0,0,0, @result_protocol, @recs, @errrecs, @errmsg, @wrnrecs);
  elif(process.value("t_subtype") == 702) /*Фондовый рынок и ЕДП*/
    startdate = DL_GetMinDateOfCalends(
                  date(process.value("t_operdate")),
                  1,
                  DL_GetCalendarArrByParam(
                    DL_KeyPair("ObjectType",DL_CALLNK_MARKET),
                    DL_KeyPair("DayType", DL_CALLNK_MRKTDAY_TRADE)
                  )
                );
    var msg702 = "";
    if (CheckEDPDay(@msg702)) 
    resultproc = ExecMacroFile("spLibU", "CalcLimits", startdate, 1,0,0,1, @result_protocol, @recs, @errrecs, @errmsg, @wrnrecs);
    SendNotificationEDPLimit(date(process.value("t_operdate")));
    else
      resultproc = true;
      result_protocol.AddString(msg702);
    end;
  elif(process.value("t_subtype") == 703) /*Сверка по всем рынкам и выгрузка файла*/
    startdate = DL_GetMinDateOfCalends(
                  date(process.value("t_operdate")),
                  1,
                  DL_GetCalendarArrByParam(
                    DL_KeyPair("ObjectType",DL_CALLNK_MARKET),
                    DL_KeyPair("DayType", DL_CALLNK_MRKTDAY_TRADE)
                  )
                );
    resultproc = ExecMacroFile("spLibU", "CompareQUIK", startdate, 1,1,1,/*1,*/ @result_protocol, @recs, @errrecs, @errmsg, @wrnrecs);
  elif(process.value("t_subtype") == 719) /*Обмен данными СОФР-ЦФТ по Депо комиссиям*/
   resultproc = ExecMacroFile("spLibU", "ExchangeCommData", date(process.value("t_operdate")), int(process.value("t_type")), @result_comm, @recs, @errrecs, @errmsg, @wrnrecs);
  elif(process.value("t_subtype") == 731) /*Обработка депозитарных комиссий BIQ-10484 CCBO-5829*/
    resultproc = ExecMacroFile("naLibU", "processDepositsCommisions", date(process.value("t_operdate")),@result_protocol, @recs, @errrecs, @errmsg, @wrnrecs);
  elif(process.value("t_subtype") == 751) /*Формирование файла корректировок лимитов по Депо комиссиям*/
    resultproc = ExecMacroFile("naLibU", "formCorrectLimitsFile",     date(process.value("t_operdate")),@result_protocol, @recs, @errrecs, @errmsg, @wrnrecs);
  elif(process.value("t_subtype") == 721) /*Расчет валютный рынок*/
    startdate = DL_GetMinDateOfCalends(
                  date(process.value("t_operdate")),
                  1,
                  DL_GetCalendarArrByParam(
                    DL_KeyPair("ObjectType",DL_CALLNK_MARKET),
                    DL_KeyPair("DayType", DL_CALLNK_MRKTDAY_TRADE),
                    DL_KeyPair("MarketPlace",DL_CALLNK_MARKETPLACE_CUR)
                  )
                );
    resultproc = ExecMacroFile("spLibU", "CalcLimits", startdate, 0,1,0,0, @result_protocol, @recs, @errrecs, @errmsg, @wrnrecs);
  elif(process.value("t_subtype") == 711) /*Срочный рынок*/
    if(isHoliday(date(process.value("t_operdate")), 401))
      resultproc = true;
      errmsg = "Не предусмотрена обработка пункта в выходные дни";
    else
      startdate = DL_GetMinDateOfCalends(
                    date(process.value("t_operdate")),
                    1,
                    DL_GetCalendarArrByParam(
                    DL_KeyPair("ObjectType",DL_CALLNK_MARKET),
                    DL_KeyPair("DayType", DL_CALLNK_MRKTDAY_TRADE),
                    DL_KeyPair("MarketPlace",DL_CALLNK_MARKETPLACE_DV)
                  )
                );
      resultproc = ExecMacroFile("spLibU", "CalcLimits", startdate, 0,0,1,0, @result_protocol, @recs, @errrecs, @errmsg, @wrnrecs);
    end;
  /*СОВУ по клиентским операциям*/
  elif(process.value("t_subtype") == 508)
    resultproc = ExecMacroFile("spLibU", "CreateSO_InAccountingClient", date(process.value("t_operdate")), opernum, @result_comm, @recs, @errrecs, @errmsg, @wrnrecs);

  /*Формирование отчета брокера*/
  elif(process.value("t_subtype") == 601)
    resultproc = ExecMacroFile("spLibU", "BrokerRep", date(process.value("t_operdate")), opernum, @result_comm, @recs, @errrecs, @errmsg , @wrnrecs);
    //if(CheckEDPDay())
    //  resultproc = ExecMacroFile("dvLibU", "BrokerRep", date(process.value("t_operdate")), opernum, @result_comm, @recs, @errrecs, @errmsg , @wrnrecs);
    //end;
  /*Формирование отчета брокера*/
  elif(process.value("t_subtype") == 621)
    resultproc = ExecMacroFile("dvLibU", "BrokerRep", date(process.value("t_operdate")), opernum, @result_comm, @recs, @errrecs, @errmsg , @wrnrecs);

  /*Расчет базовых сумм для ИнвестСоветника*/
  elif(process.value("t_subtype") == 602)
    resultproc = ExecMacroFile("spLibU", "CalcBaseSum", date(process.value("t_operdate")), opernum, @result_comm, @recs, @errrecs, @errmsg, @wrnrecs);

  /*Списание задолженности по брокерским операциям*/
  elif(process.value("t_subtype") == 603)
    resultproc = ExecMacroFile("spLibU", "WrtOffDebtSum", date(process.value("t_operdate")), opernum, @result_protocol, @result_comm, @recs, @errrecs, @errmsg, @wrnrecs);

  /*Вынос на просрочку задолженности по брокерским операциям*/
  elif(process.value("t_subtype") == 604)
    resultproc = ExecMacroFile("spLibU", "EnrollDebtSum", date(process.value("t_operdate")), opernum, @result_protocol, @result_comm, @recs, @errrecs, @errmsg, @wrnrecs);

  /*Инициация процесса списания задолженностей со счетов в ЦФТ*/
  elif(process.value("t_subtype") == 605)
    resultproc = ExecMacroFile("spLibU", "InitWrtOffDebtSumToCFT", date(process.value("t_operdate")), @result_protocol, @recs, @errrecs, @errmsg, @wrnrecs);

  /*Отправка уведомлений об открытии ДБО/ИИС при открытии счетов в новых валютах*/
  elif(process.value("t_subtype") == 720)
    resultproc = ExecMacroFile("spLibU", "CheckAndSendDBOMessageForOpenAcc", date(process.value("t_operdate")), @result_protocol, @recs, @errrecs, @errmsg, @wrnrecs);

  /*Расчет НОБ по мат. выгоде*/
  elif(process.value("t_subtype") == 610)
    resultproc = ExecMacroFile("dvLibU", "CalcLucre", date(process.value("t_operdate")), opernum, @result_comm, @recs, @errrecs, @errmsg, @wrnrecs);
  
  /*Удержание НДФЛ по мат. выгоде*/
  elif(process.value("t_subtype") == 611)
    resultproc = ExecMacroFile("dvLibU", "HoldLucre", date(process.value("t_operdate")), opernum, @result_comm, @recs, @errrecs, @errmsg, @wrnrecs);
   
  /*Неизвестный процесс*/
  else
    errmsg = "Неизвестный процесс " + process.value("t_subtype");
    resultproc = false;
  end;
  /*Ошибка обработки*/
  if(not resultproc)
    if(strlen(errmsg) <= 0)
      errmsg = "Неизвестная ошибка при обработке процесса";
    end;
    SaveResult();
    process.edit();
    process.value("t_isfinish") = "E";
    process.value("t_status") = ErrorProccesed_Status;
    process.value("t_statusname") = "Ошибка обработки";
    process.value("t_errmsg") = substr(errmsg,1,200);
    process.value("t_EndTime") = getCurrentDateTime();
    process.update();
    SetDialogFlag(1);

    SendSingleNotification(process, errmsg, errrecs, wrnrecs);
    Process_Array[Process_Array.Size] = Proc_Instance(process.value("t_name"), errmsg, errrecs, wrnrecs);

    return false;

    SendSingleNotification(process, errmsg, errrecs, wrnrecs);
  /*Обработка с ошибками*/
  elif(errrecs > 0)
    SaveResult();
    process.edit();
    process.value("t_isfinish") = "E";
    process.value("t_status") = ProcWithError_Status;
    process.value("t_statusname") = "Обработан с ошибками";
    process.value("t_countrecs") = recs;
    process.value("t_counterrors") = errrecs;
    process.value("t_countwarning") = wrnrecs;
    process.value("t_errmsg") = substr(errmsg,1,200);
    process.value("t_EndTime") = getCurrentDateTime();
    process.update();
    SetDialogFlag(1);

    SendSingleNotification(process, errmsg, errrecs, wrnrecs);
    Process_Array[Process_Array.Size] = Proc_Instance(process.value("t_name"), errmsg, errrecs, wrnrecs);

    /*при повторной загрузке, если есть хоть одна обработанная запись, то напоминаем, что необходимо переформировать отчеты брокера*/
    if (     (process.value("t_count") > 1) 
         and (process.value("t_countrecs") > 0)
         and (    (process.value("t_subtype") == 201) /*клиентские заявки в БОЦБ*/
               or (process.value("t_subtype") == 225) /*клиентские заявки по валютному рынку*/
               or (process.value("t_subtype") == 219) /*клиентские заявки по срочному рынку*/
             )
       )
        SendNotificationReloadReq(process, errmsg, errrecs, wrnrecs);
    end;

    if ((process.value("t_subtype") == 201) or (process.value("t_subtype") == 105) or (process.value("t_subtype") == 506) or (process.value("t_subtype") == 4050))
       return true;
    else
       return false;
    end;

  /*Успешная обработка*/
  else
    SaveResult();
    process.edit();
    process.value("t_isfinish") = "X";
    process.value("t_status") = ProcSuccess_Status;
    if (wrnrecs > 0)
      process.value("t_statusname") = "Обработан с предупреждениями";
    else
    process.value("t_statusname") = "Обработан успешно";
    end;
    process.value("t_countrecs") = recs;
    process.value("t_counterrors") = errrecs;
    process.value("t_countwarning") = wrnrecs;
    process.value("t_errmsg") = substr(errmsg,1,200);
    process.value("t_EndTime") = getCurrentDateTime();
    process.update();
    SetDialogFlag(1);

    if (wrnrecs > 0)
        SendSingleNotification(process, errmsg, errrecs, wrnrecs);
        Process_Array[Process_Array.Size] = Proc_Instance(process.value("t_name"), errmsg, errrecs, wrnrecs);
    end;

    /*при повторной загрузке, если есть хоть одна обработанная запись, то напоминаем, что необходимо переформировать отчеты брокера*/
    if (     (process.value("t_count") > 1) 
         and (process.value("t_countrecs") > 0)
         and (    (process.value("t_subtype") == 201) /*клиентские заявки в БОЦБ ММВБ*/
               or (process.value("t_subtype") == 4050)/*клиентские заявки в БОЦБ СПБ */
               or (process.value("t_subtype") == 225) /*клиентские заявки по валютному рынку*/
               or (process.value("t_subtype") == 219) /*клиентские заявки по срочному рынку*/
             )
       )
        SendNotificationReloadReq(process, errmsg, errrecs, wrnrecs);
    end;
    return true;
  end;


onError(erru)  
  errmsg = "onError: " + erru.message + " (модуль " + erru.module + ", строка " + erru.line + ")";
  SetDialogFlag(1);
  return false;
end;


/*Диалоговый процесс*/
private macro RunProcessDialog(operdate, opernum, processtype)
  var inprocess = false;
  var multiProcArr = TArray();

  /**/
  macro makeArray():TArray
    var parm:variant, i:integer = 0, result:TArray = TArray( ParmCount(), ParmCount() );
    while( GetParm(i, parm) )
      result.value(i) = parm;
      i = i + 1;
    end;
    return result;
  end;


  /**/
  macro eInfoDialog(rs, cmd, id, key)
    file ReportOutFile() txt write;
    var ReportFileName;
    /*Обработка нажатия кнопок*/
    if(cmd == DLG_KEY)
      /*Esc*/
      if(key == 27)
        return CM_CANCEL;
      /*Enter*/
      elif(key == 13)
        if(rs.RecCount > 0)
          var cmdLog, rsLog, strLog;
          var cmdLogs, rsLogs;
          var DLComm;
          var ind = 1, deltaind = 1024, idec;
          /*Данные из протокола*/
          if(rs.value("t_operid")==0)
            ReportFileName = GetTxtFileName("protocol");
            if(not Open(ReportOutFile, ReportFileName))
              msgboxex("Ошибка при открытии файла отчета|"+ReportFileName);
            end;
            strLog = "";
            while(ind > 0)
              StartCaptureOutput();
              [
                select nvl(dbms_lob.substr(process_oper_u.t_protocol, ?, ?),' ') t_log
                from dprocess_oper_u_dbt process_oper_u
                where process_oper_u.t_type = ? and
                      process_oper_u.t_operdate = ? and
                      process_oper_u.t_subtype = ? and
                      process_oper_u.t_operid = ?
              ];
              cmdLog = DL_RsdCommand(EndCaptureOutput());
              cmdLog.AddParam(deltaind);
              cmdLog.AddParam(1 + deltaind * (ind - 1));
              cmdLog.AddParam(rs.value("t_type"));
              cmdLog.AddParam(date(rs.value("t_operdate")));
              cmdLog.AddParam(rs.value("t_subtype"));
              cmdLog.AddParam(rs.value("t_operid"));
              rsLog = cmdLog.Execute();
              if((rsLog.moveNext()) and (rsLog.value("t_log") != " "))
                strLog = strLog + rsLog.value("t_log");
                while(index(strLog, "\n") > 0)
                  idec = index(strLog, "\n");
                  insert(ReportOutFile, substr(strLog, 1, idec-1));
                  strLog = substr(strLog, idec+1);
                end;
                ind = ind + 1;
              else
                if(strlen(strLog) > 0)
                  insert(ReportOutFile, strLog);
                end;
                ind = 0;
              end;
            end;
            close(ReportOutFile);
            viewfile(ReportFileName);

          /*Данные из протокола*/
          elif(((rs.value("t_subtype") >= 300) and (rs.value("t_subtype") <= 499))   
               or (rs.value("t_subtype") == 701)
               or (rs.value("t_subtype") == 702)
               or (rs.value("t_subtype") == 703)
               or (rs.value("t_subtype") == 711)
               or (rs.value("t_subtype") == 721)
               or (rs.value("t_subtype") == 4130)
               or (rs.value("t_subtype") == 507)
               or (rs.value("t_subtype") == 731)
               or (rs.value("t_subtype") == 751)
               or ((rs.value("t_subtype") >= 100) and (rs.value("t_subtype") <= 299)) or (rs.value("t_subtype") == 4100) or (rs.value("t_subtype") == 4110) or (rs.value("t_subtype") == 4120) or ((rs.value("t_subtype") >= 5010) and (rs.value("t_subtype") <= 5040) and (rs.value("t_subtype") != 5020)) or ((rs.value("t_subtype") >= 4010) and  (rs.value("t_subtype") <= 4080)) 
              )
            ReportFileName = GetTxtFileName("protocol");
            if(not Open(ReportOutFile, ReportFileName))
              msgboxex("Ошибка при открытии файла отчета|"+ReportFileName);
            end;
            strLog = "";
            while(ind > 0)
              StartCaptureOutput();
              [
                select nvl(dbms_lob.substr(gtseance.t_log, ?, ?),' ') t_log
                from dgtseance_dbt gtseance
                where gtseance.t_seanceid = ?
              ];
              cmdLog = DL_RsdCommand(EndCaptureOutput());
              cmdLog.AddParam(deltaind);
              cmdLog.AddParam(1 + deltaind * (ind - 1));
              cmdLog.AddParam(rs.value("t_operid"));
              rsLog = cmdLog.Execute();
              if((rsLog.moveNext()) and (rsLog.value("t_log") != " "))
                strLog = strLog + rsLog.value("t_log");
                while(index(strLog, "\n") > 0)
                  idec = index(strLog, "\n");
                  insert(ReportOutFile, substr(strLog, 1, idec-1));
                  strLog = substr(strLog, idec+1);
                end;
                ind = ind + 1;
              else
                if(strlen(strLog) > 0)
                  insert(ReportOutFile, strLog);
                end;
                ind = 0;
              end;
            end;
            close(ReportOutFile);
            viewfile(ReportFileName);

          /*Расчет текущей справедливой стоимости*/
          /*Начисление дохода/расхода*/
          /*Переоценка*/
          elif((rs.value("t_subtype") == 501) or 
               (rs.value("t_subtype") == 503) or 
               (rs.value("t_subtype") == 504))
            DLComm = TRecHandler("dl_comm.dbt");
            StartCaptureOutput();
            [
              select *
              from ddl_comm_dbt
              where t_documentid = ?
            ];
            cmdLog = DL_RsdCommand(EndCaptureOutput());
            cmdLog.AddParam(rs.value("t_operid"));
            rsLog = cmdLog.Execute();
            if(rsLog.moveNext())
              ReportFileName = GetTxtFileName("protocol");
              if(not Open(ReportOutFile, ReportFileName))
                msgboxex("Ошибка при открытии файла отчета|"+ReportFileName);
              end;
              rsLog.GetRecord().CopyTo(DLComm.rec);
              setoutput(ReportFileName);
              execmacrofile("spordres", "Print_MemOrder", getmemaddrfrom(DLComm), false);
              setoutput(null);
              close(ReportOutFile);
              viewfile(ReportFileName);
            end;

          /*ВУ/БУ/ДУ*/
          elif(rs.value("t_subtype") == 502)
            DLComm = TRecHandler("dl_comm.dbt");
            StartCaptureOutput();
            [
              select *
              from ddl_comm_dbt
              where t_documentid = ?
            ];
            cmdLog = DL_RsdCommand(EndCaptureOutput());
            cmdLog.AddParam(rs.value("t_operid"));
            rsLog = cmdLog.Execute();
            if(rsLog.moveNext())
              rsLog.GetRecord().CopyTo(DLComm.rec);
              if(DLComm.rec.DocKind == 4613/*DL_INACCSRVOP*/)
                execmacrofile("scstartcnv", "PrintInAccByXMLToSTD", getmemaddrfrom(DLComm), DL_OUTREPORT_STD);
              elif(DLComm.rec.DocKind == 4616/*DL_DEPOACCSRVOP*/)
                execmacrofile("scstartdepo", "PrintDepoByXMLToSTD", getmemaddrfrom(DLComm), DL_OUTREPORT_STD);
              elif(DLComm.rec.DocKind == 4615/*0DL_SCACCOUNTING*/)
                execmacrofile("scstartacc", "PrintAccountingByXMLToSTD", getmemaddrfrom(DLComm), DL_OUTREPORT_STD);
              else
                msgboxex("Неизвестный вид операции");
              end;
            end;

          /*Расчеты с биржей*/
          elif((rs.value("t_subtype") == 505) or (rs.value("t_subtype") == 4090) or (rs.value("t_subtype") == 4100) or (rs.value("t_subtype") == 5020))
            /*Нечего показывать*/

          /*Формирование отчета брокера*/
          elif((rs.value("t_subtype") == 601) or (rs.value("t_subtype") == 621))
            DLComm = TRecHandler("scsrvrep.dbt");
            StartCaptureOutput();
            [
              select *
              from dscsrvrep_dbt
              where t_id = ?
            ];
            cmdLog = DL_RsdCommand(EndCaptureOutput());
            cmdLog.AddParam(rs.value("t_operid"));
            rsLog = cmdLog.Execute();
            if(rsLog.moveNext())
              rsLog.GetRecord().CopyTo(DLComm.rec); // Golovkin 18.03.2021
              execmacrofile("scstartsrvrep", "Печатать_Протокол", getmemaddrfrom(DLComm));
            end;


          elif(rs.value("t_subtype") == 506)
            DLComm = TRecHandler("dl_comm.dbt");
            StartCaptureOutput();
            [
              select *
              from ddl_comm_dbt
              where t_documentid = ?
                ];
                cmdLog = DL_RsdCommand(EndCaptureOutput());
            cmdLog.AddParam(rs.value("t_operid"));
                rsLog = cmdLog.Execute();
            if(rsLog.moveNext())
              rsLog.GetRecord().CopyTo(DLComm.rec);
              if(DLComm.rec.DocKind == 4613/*DL_INACCSRVOP*/)
                execmacrofile("scstartcnv", "PrintAccountingMsg"/*"PrintInAccByXMLToSTD"*/, getmemaddrfrom(DLComm), DL_OUTREPORT_STD);
              elif(DLComm.rec.DocKind == 4616/*DL_DEPOACCSRVOP*/)
                execmacrofile("scstartdepo", "PrintDepoByXMLToSTD", getmemaddrfrom(DLComm), DL_OUTREPORT_STD);
              elif(DLComm.rec.DocKind == 4615/*0DL_SCACCOUNTING*/)
                execmacrofile("scstartacc", "PrintAccountingMsg"/*"PrintAccountingByXMLToSTD"*/, getmemaddrfrom(DLComm), DL_OUTREPORT_STD);
                else
                msgboxex("Неизвестный вид операции");
              end;
            end;
          elif(rs.value("t_subtype") == 508)
            DLComm = TRecHandler("dl_comm.dbt");
            StartCaptureOutput();
            [
              select *
              from ddl_comm_dbt
              where t_documentid = ?
                ];
                cmdLog = DL_RsdCommand(EndCaptureOutput());
            cmdLog.AddParam(rs.value("t_operid"));
                rsLog = cmdLog.Execute();
            if(rsLog.moveNext())
              rsLog.GetRecord().CopyTo(DLComm.rec);
              if(DLComm.rec.DocKind == 4613/*DL_INACCSRVOP*/)
                execmacrofile("scstartcnv", "PrintInAccMsg"/*"PrintInAccByXMLToSTD"*/, getmemaddrfrom(DLComm), DL_OUTREPORT_STD);
              elif(DLComm.rec.DocKind == 4616/*DL_DEPOACCSRVOP*/)
                execmacrofile("scstartdepo", "PrintDepoByXMLToSTD", getmemaddrfrom(DLComm), DL_OUTREPORT_STD);
              elif(DLComm.rec.DocKind == 4615/*0DL_SCACCOUNTING*/)
                execmacrofile("scstartacc", "PrintAccountingByXMLToSTD", getmemaddrfrom(DLComm), DL_OUTREPORT_STD);
                else
                msgboxex("Неизвестный вид операции");
              end;
            end;

          elif((rs.value("t_subtype") == 602)
               or (rs.value("t_subtype") == 603)
               or (rs.value("t_subtype") == 604)
              )
            ReportFileName = GetTxtFileName("protocol");
            if(not Open(ReportOutFile, ReportFileName))
              msgboxex("Ошибка при открытии файла отчета|"+ReportFileName);
            end;
            strLog = "";
            while(ind > 0)
              StartCaptureOutput();
              if(rs.value("t_subtype") == 602)
                [
                  select nvl(dbms_lob.substr(op.t_log, ?, ?),' ') t_log
                  from ddl_basesumop_dbt op
                  where op.t_id = ?
                ];
              elif(rs.value("t_subtype") == 603)
                [
                  select nvl(dbms_lob.substr(op.t_log, ?, ?),' ') t_log
                  from ddl_wrtoffdebtsumop_dbt op
                  where op.t_id = ?
                ];
              else
                [
                  select nvl(dbms_lob.substr(op.t_log, ?, ?),' ') t_log
                  from ddl_enrolldebtsumop_dbt op
                  where op.t_id = ?
                ];
              end;
              cmdLog = DL_RsdCommand(EndCaptureOutput());
              cmdLog.AddParam(deltaind);
              cmdLog.AddParam(1 + deltaind * (ind - 1));
              cmdLog.AddParam(rs.value("t_operid"));
              rsLog = cmdLog.Execute();
              if((rsLog.moveNext()) and (rsLog.value("t_log") != " "))
                strLog = strLog + rsLog.value("t_log");
                while(index(strLog, "\n") > 0)
                  idec = index(strLog, "\n");
                  insert(ReportOutFile, substr(strLog, 1, idec-1));
                  strLog = substr(strLog, idec+1);
                end;
                ind = ind + 1;
              else
                if(strlen(strLog) > 0)
                  insert(ReportOutFile, strLog);
                end;
                ind = 0;
              end;
            end;
            close(ReportOutFile);
            viewfile(ReportFileName);

          elif((rs.value("t_subtype") == 610) or (rs.value("t_subtype") == 611))
            /*Нечего показывать*/

          else
            msgboxex("Просмотр информации в разработке");
          end;
        end;
        return CM_IGNORE;
      end;
    end;
  end;


  /**/
  var SaveNum = 0;
  macro eRunProcessDialog(rs, cmd, id, key)
    var cmdInfo, rsInfo;
    var errmsg;
    var pre_msg = "";

    /*Инициализация*/
    if(cmd == DLG_INIT)
      /*Позиционируемся*/
      if(SaveNum > 0)
        while(rs.movenext)
          if(SaveNum == rs.value("t_num"))
            GoToScroll(rs);
            break;
          end;
        end;
      end;
      /*Регистрируем групповую обработку*/
      AddMultiAction(rs, 316/*F2*/);
      AddMultiAction(rs, 322/*F8*/);

    /*Старт обработки выделенных записей*/
    elif(cmd == DLG_MSELSTART)
      if ((key == 316) or (key == 322))
        multiProcArr = null;
        multiProcArr = TArray();
        var askMsg = "";
        /*F2*/
        if(key == 316)
          askMsg = "Выполнить обработку выделеных процессов?";
        /*F8*/
        elif(key == 322)
          askMsg = "Удалить обработку выделеных процессов?";
        end;
        if (askMsg != "")
          if(msgboxex(askMsg, MB_YES + MB_NO, IND_YES) == IND_YES)
            inprocess = true;
          end;
        end;
      end;

    /*Завершение обработки выделенных записей*/
    elif(cmd == DLG_MSELEND)
      if (inprocess and ((key == 316) or (key == 322)) and (multiProcArr.size > 0))
       
        var inprocessprogress = 0;
        InitProgress(multiProcArr.size, "Ждите...", "Выполнение процессов");
        for (var curProc, multiProcArr)
          var curRecordSet = GetProcessRecordSetFromObj(curProc);
          if (curRecordSet.MoveNext())
            if (key == 316)
              if(curRecordSet.value("t_isfinish") == "")
                if(not RunProcessItem(opernum, @curRecordSet, @errmsg))
                  msgboxex("Ошибка при обработке процесса '" + curRecordSet.value("t_name") + "'|"+errmsg);
                  SendNotification(SendWithManual);
                  break;
                else
                  UseProgress((inprocessprogress = inprocessprogress + 1));
                end;
              elif(curRecordSet.value("t_isfinish") == "S")
                UseProgress((inprocessprogress = inprocessprogress + 1));
              else
                SendNotification(SendWithManual);
                msgboxex("Ошибка при обработке процесса '" + curRecordSet.value("t_name") + "'|Процесс обрабатывался ранее");
              end;
            elif (key == 322)
              if(not DeleteProcessItem(@curRecordSet, @errmsg))
                msgboxex("Ошибка при удалении обработки процесса '" + rs.value("t_name") + "'|"+errmsg);
                break;
              else
                UseProgress((inprocessprogress = inprocessprogress + 1));
              end;
            end;
          end;
        end;
        RemProgress();
        inprocess = false;

        if (key == 316)
          SendNotification(SendWithManual);
          msgboxex("Выполнение процессов завершено");
        elif (key == 322)
          msgboxex("Удаление обработки процессов завершено");
        end;
      end;
    /*Обработка очередной выделенной записи*/
    elif(cmd == DLG_MSEL)
      if(inprocess)
        /*F2*/
        if((key == 316) or (key == 322))
          multiProcArr[multiProcArr.size] = DRecStruct(
                                              SQL_ConvTypeDate(rs.value("t_operdate")),
                                              SQL_ConvTypeInteger(rs.value("t_type")),
                                              SQL_ConvTypeInteger(rs.value("t_subtype"))
                                            );
          return CM_MSEL_CONT_CLEAR;
        end;
      end;

    /*Обработка нажатия кнопок*/
    elif(cmd == DLG_KEY)
      /*Esc*/
      if(key == 27)
        return CM_CANCEL;
      /*F2*/
      elif(key == 316)
        if(rs.value("t_subtype") == 701)
          pre_msg = "Расчет лимитов фондового рынка вынесен в пункт 13.\"Расчет Лимитов Фондовый рынок и ЕДП\".\n 12ый пункт обработчика не требуется запускать отдельно.\n";
        end;
        if((rs.value("t_isfinish") != "") and (rs.value("t_isfinish") != "S"))
          msgboxex("Процесс '" + rs.value("t_name") + "' обработан");
        elif(msgboxex(pre_msg + "Выполнить обработку процесса '" + rs.value("t_name") + "'?", MB_YES + MB_NO, IND_YES) == IND_YES)
          BegAction(1, rs.value("t_name") + ". Ждите...");
          if(not RunProcessItem(opernum, @rs, @errmsg))
            updatescroll(rs, 5);
            EndAction(1);
            SendNotification(SendWithManual);
            msgboxex("Ошибка при выполнении процесса '" + rs.value("t_name") + "'|" + errmsg);
          else
            EndAction(1);
            SendNotification(SendWithManual);
            updatescroll(rs, 5);
          end;
        end;
        return CM_IGNORE;
      /*F5*/
      elif(key == 319)
        if(rs.value("t_isfinish") == "")
          rs.edit();
          rs.value("t_isfinish") = "S";
          rs.update();
          updatescroll(rs, 5);
        elif(rs.value("t_isfinish") == "S")
          rs.edit();
          rs.value("t_isfinish") = "";
          rs.update();
          updatescroll(rs, 5);
        else
          msgboxex("Пропустить можно только не обработанный процесс|Необходимо удалить обработку процесса");
        end;
      /*F8*/
      elif(key == 322)
        if(rs.value("t_isfinish") == "")
          msgboxex("Процесс '" + rs.value("t_name") + "' не обработан");
        elif(msgboxex("Удалить обработку процесса '" + rs.value("t_name") + "'?", MB_YES + MB_NO, IND_YES) == IND_YES)
          if(not DeleteProcessItem(@rs, @errmsg))
            updatescroll(rs, 5);
            msgboxex("Ошибка при удалении обработки процесса '" + rs.value("t_name") + "'|" + errmsg);
          else
            updatescroll(rs, 5);
          end;
        end;
        return CM_IGNORE;
      /*Enter*/
      elif(key == 13)
        if(rs.value("t_isfinish") != "")
          /*Сеанс шлюза*/
          if(((rs.value("t_subtype") >= 100) and (rs.value("t_subtype") <= 299)) or (rs.value("t_subtype") == 4100) or (rs.value("t_subtype") == 4110) or (rs.value("t_subtype") == 4120) or ((rs.value("t_subtype") >= 4010) and  (rs.value("t_subtype") <= 4080)) or ((rs.value("t_subtype") >= 5010) and (rs.value("t_subtype") <= 5040) and (rs.value("t_subtype") != 5020)))
            StartCaptureOutput();
            [
              select to_char(gtseance.t_sysdate,'dd.mm.yyyy')||' '||to_char(gtseance.t_systime,'hh24:mi:ss')||' ('||gtseance.t_seanceid||')' t_oprcode,
                     case when gtseance.t_kind is null then chr(1) when gtseance.t_kind = 1 then 'Сеанс загрузки в шлюз' when gtseance.t_kind = 2 then 'Сеанс отправки в БО' else chr(1) end t_oprname,
                     case when gtseance.t_errorcount is null then chr(1) when gtseance.t_errorcount > 0 then 'Загружено с ошибками' else 'Загружено без ошибок' end t_oprstatus,
                     process_oper_u.t_type,
                     process_oper_u.t_operdate,
                     process_oper_u.t_subtype,
                     process_oper_u.t_operid
              from dprocess_oper_u_dbt process_oper_u
              left join dgtseance_dbt gtseance on gtseance.t_seanceid = process_oper_u.t_operid
              where process_oper_u.t_type = ? and
                    process_oper_u.t_operdate = ? and
                    process_oper_u.t_subtype = ?
              order by t_operid
            ];
            cmdInfo = RsdCommand(EndCaptureOutput());
            cmdInfo.AddParam("processtype", RSDBP_IN, rs.value("t_type"));
            cmdInfo.AddParam("operdate", RSDBP_IN, date(rs.value("t_operdate")));
            cmdInfo.AddParam("processsubtype", RSDBP_IN, rs.value("t_subtype"));

          /*Проводка операций, оплата комиссий, расчет лимитов или сервисная операция*/
          elif(((rs.value("t_subtype") >= 300) and (rs.value("t_subtype") <= 599)) 
              or (rs.value("t_subtype") == 701)
              or (rs.value("t_subtype") == 702)
              or (rs.value("t_subtype") == 703)
              or (rs.value("t_subtype") == 711)
              or (rs.value("t_subtype") == 720)
              or (rs.value("t_subtype") == 721)
              or (rs.value("t_subtype") == 4130)
              or (rs.value("t_subtype") == 507)
              or (rs.value("t_subtype") == 4090)
              or (rs.value("t_subtype") == 605)
              )
            StartCaptureOutput();
            [
              select chr(1) t_oprcode, 
                     'Протокол работы процедуры' t_oprname, 
                     chr(1) t_oprstatus,
                     process_oper_u.t_type,
                     process_oper_u.t_operdate,
                     process_oper_u.t_subtype,
                     process_oper_u.t_operid
              from dprocess_oper_u_dbt process_oper_u
              where process_oper_u.t_type = ? and
                    process_oper_u.t_operdate = ? and
                    process_oper_u.t_subtype = ? and
                    process_oper_u.t_operid = 0
              union all
              select nvl(dl_comm.t_commcode, chr(1)) t_oprcode, 
                     nvl(oprkdoc.t_name, case when dl_comm.t_dockind = ########## then 'Расчет ТСС' else chr(1) end) t_oprname, 
                     nvl(namealg.t_sznamealg, chr(1)) t_oprstatus,
                     process_oper_u.t_type,
                     process_oper_u.t_operdate,
                     process_oper_u.t_subtype,
                     process_oper_u.t_operid
              from dprocess_oper_u_dbt process_oper_u
              left join ddl_comm_dbt dl_comm on dl_comm.t_documentid = process_oper_u.t_operid 
              left join dnamealg_dbt namealg on ((dl_comm.t_dockind     in (108,157) and namealg.t_itypealg = 3154) or 
                                                 (dl_comm.t_dockind not in (108,157) and namealg.t_itypealg = 7522)) and 
                                                namealg.t_inumberalg = dl_comm.t_commstatus
              left join doprkdoc_dbt oprkdoc on oprkdoc.t_dockind = dl_comm.t_dockind 
              where process_oper_u.t_type = ? and
                    process_oper_u.t_operdate = ? and
                    process_oper_u.t_subtype = ? and
                    process_oper_u.t_operid <> 0
              order by t_operid
            ](DL_CALCTSS);

            cmdInfo = RsdCommand(EndCaptureOutput());
            cmdInfo.AddParam("processtype", RSDBP_IN, rs.value("t_type"));
            cmdInfo.AddParam("operdate", RSDBP_IN, date(rs.value("t_operdate")));
            cmdInfo.AddParam("processsubtype", RSDBP_IN, rs.value("t_subtype"));

            cmdInfo.AddParam("processtype1", RSDBP_IN, rs.value("t_type"));
            cmdInfo.AddParam("operdate1", RSDBP_IN, date(rs.value("t_operdate")));
            cmdInfo.AddParam("processsubtype1", RSDBP_IN, rs.value("t_subtype"));

         /*Расчет базовых сумм*/
         elif(rs.value("t_subtype") == 602)
            StartCaptureOutput();
            [
              select chr(1) t_oprcode, 
                     'Протокол расчета базовых сумм' t_oprname, 
                     chr(1) t_oprstatus,
                     process_oper_u.t_type,
                     process_oper_u.t_operdate,
                     process_oper_u.t_subtype,
                     process_oper_u.t_operid
              from dprocess_oper_u_dbt process_oper_u
              /*left join ddl_basesumop_dbt bsop on bsop.t_id = process_oper_u.t_operid*/ 
              where process_oper_u.t_type = ? and
                    process_oper_u.t_operdate = ? and
                    process_oper_u.t_subtype = ? 
              order by t_operid
            ];
            cmdInfo = RsdCommand(EndCaptureOutput());
            cmdInfo.AddParam("processtype", RSDBP_IN, rs.value("t_type"));
            cmdInfo.AddParam("operdate", RSDBP_IN, date(rs.value("t_operdate")));
            cmdInfo.AddParam("processsubtype", RSDBP_IN, rs.value("t_subtype"));

         /*Списание/вынос на просрочку задолженности по брокерским операциям*/
         elif((rs.value("t_subtype") == 603)
              or (rs.value("t_subtype") == 604)
             )
            StartCaptureOutput();
            [
              select chr(1) t_oprcode, 
                     'Протокол '||decode(process_oper_u.t_subtype, 603, 'списания', 'выноса на просрочку')||' задолженности' t_oprname, 
                     chr(1) t_oprstatus,
                     process_oper_u.t_type,
                     process_oper_u.t_operdate,
                     process_oper_u.t_subtype,
                     process_oper_u.t_operid
              from dprocess_oper_u_dbt process_oper_u
              where process_oper_u.t_type = ? and
                    process_oper_u.t_operdate = ? and
                    process_oper_u.t_subtype = ? 
              order by t_operid
            ];
            cmdInfo = RsdCommand(EndCaptureOutput());
            cmdInfo.AddParam("processtype", RSDBP_IN, rs.value("t_type"));
            cmdInfo.AddParam("operdate", RSDBP_IN, date(rs.value("t_operdate")));
            cmdInfo.AddParam("processsubtype", RSDBP_IN, rs.value("t_subtype"));
            
          /*Расчет НОБ для НДФЛ*/
          elif(rs.value("t_subtype") == 610)
            StartCaptureOutput();
            [ SELECT TO_CHAR(op.t_operdate, 'DD.MM.YYYY') || ' ' || TO_CHAR(op.t_time, 'HH24:MI:SS') || ' ' || '(' || op.t_code || ')' t_oprcode,
                    'Расчет НОБ для НДФЛ' t_oprname,
                     namealg.t_sznamealg t_oprstatus,
                     process_oper_u.t_type,
                     process_oper_u.t_operdate,
                     process_oper_u.t_subtype,
                     process_oper_u.t_operid
                FROM DNPTXOP_DBT op 
                     INNER JOIN dprocess_oper_u_dbt process_oper_u ON op.t_id = process_oper_u.t_operid
                     LEFT JOIN dnamealg_dbt namealg ON namealg.t_itypealg = 3154 /*ALG_DL_COMM_OPSTATUS*/ and namealg.t_inumberalg = op.t_status
               WHERE op.t_operdate = ?
                 AND op.t_subkind_operation = 30 /*DL_TXBASECALC_OPTYPE_LUCRE*/
                 AND op.t_kind_operation = 2035
                 AND process_oper_u.t_subtype = ? 
            ];
            cmdInfo = RsdCommand(EndCaptureOutput());
            cmdInfo.AddParam("operdate", RSDBP_IN, date(rs.value("t_operdate")));
            cmdInfo.AddParam("processsubtype", RSDBP_IN, rs.value("t_subtype"));

          /*Удержание НДФЛ по мат. выгоде*/
          elif(rs.value("t_subtype") == 611)
            StartCaptureOutput();
            [ SELECT TO_CHAR(op.t_operdate, 'DD.MM.YYYY') || ' ' || TO_CHAR(op.t_time, 'HH24:MI:SS') || ' ' || '(' || op.t_code || ')' t_oprcode,
                    'Удержание НДФЛ' t_oprname,
                     namealg.t_sznamealg t_oprstatus,
                     process_oper_u.t_type,
                     process_oper_u.t_operdate,
                     process_oper_u.t_subtype,
                     process_oper_u.t_operid
                FROM DNPTXOP_DBT op
                     INNER JOIN dprocess_oper_u_dbt process_oper_u ON op.t_id = process_oper_u.t_operid
                     LEFT JOIN dnamealg_dbt namealg ON namealg.t_itypealg = 3154 /*ALG_DL_COMM_OPSTATUS*/ and namealg.t_inumberalg = op.t_status
               WHERE process_oper_u.t_operdate = ?
                 AND op.t_subkind_operation = 40 /*DL_TXHOLD_OPTYPE_LUCRE*/
                 AND op.t_kind_operation = 2038
                 AND process_oper_u.t_subtype = ?
            ];
            cmdInfo = RsdCommand(EndCaptureOutput());
            cmdInfo.AddParam("operdate", RSDBP_IN, date(rs.value("t_operdate")));
            cmdInfo.AddParam("processsubtype", RSDBP_IN, rs.value("t_subtype"));

          /*Отчет брокера*/
          elif((rs.value("t_subtype") >= 601) and (rs.value("t_subtype") < 4000) and (rs.value("t_subtype")!=731) and (rs.value("t_subtype")!=751)  )
            StartCaptureOutput();
            [
              select nvl(scsrvrep.t_code, chr(1)) t_oprcode, 
                     'Формирование отчета брокера' t_oprname, 
                     nvl(namealg.t_sznamealg, chr(1)) t_oprstatus,
                     process_oper_u.t_type,
                     process_oper_u.t_operdate,
                     process_oper_u.t_subtype,
                     process_oper_u.t_operid
              from dprocess_oper_u_dbt process_oper_u
              left join dscsrvrep_dbt scsrvrep on scsrvrep.t_id = process_oper_u.t_operid 
              left join dnamealg_dbt namealg on namealg.t_itypealg = 3170 and 
                                                namealg.t_inumberalg = scsrvrep.t_repstatus 
              where process_oper_u.t_type = ? and
                    process_oper_u.t_operdate = ? and
                    process_oper_u.t_subtype = ?
              order by t_operid
            ];
            cmdInfo = RsdCommand(EndCaptureOutput());
          cmdInfo.AddParam("processtype", RSDBP_IN, rs.value("t_type"));
          cmdInfo.AddParam("operdate", RSDBP_IN, date(rs.value("t_operdate")));
          cmdInfo.AddParam("processsubtype", RSDBP_IN, rs.value("t_subtype"));

          /*Обработка депозитарных комиссий  BIQ-10484 CCBO-5829  */
          /*Формирование файла корректировок лимитов BIQ-10484 CCBO-5829  */
          elif((rs.value("t_subtype") == 731) or (rs.value("t_subtype") == 751))
            StartCaptureOutput();
             if (rs.value("t_subtype") == 731) 
             [
              select nvl(scsrvrep.t_code, chr(1)) t_oprcode, 
                     'Обработка депозитарных комиссий' t_oprname, 
                     nvl(namealg.t_sznamealg, chr(1)) t_oprstatus,
                     process_oper_u.t_type,
                     process_oper_u.t_operdate,
                     process_oper_u.t_subtype,
                     process_oper_u.t_operid
              from dprocess_oper_u_dbt process_oper_u
              left join dscsrvrep_dbt scsrvrep on scsrvrep.t_id = process_oper_u.t_operid 
              left join dnamealg_dbt namealg on namealg.t_itypealg = 3170 and 
                                                namealg.t_inumberalg = scsrvrep.t_repstatus 
              where process_oper_u.t_type = ? and
                    process_oper_u.t_operdate = ? and
                    process_oper_u.t_subtype = ?
              order by t_operid
             ];
           else  
             [
              select nvl(scsrvrep.t_code, chr(1)) t_oprcode, 
                     'Формирование файла корректировок лимитов' t_oprname, 
                     nvl(namealg.t_sznamealg, chr(1)) t_oprstatus,
                     process_oper_u.t_type,
                     process_oper_u.t_operdate,
                     process_oper_u.t_subtype,
                     process_oper_u.t_operid
              from dprocess_oper_u_dbt process_oper_u
              left join dscsrvrep_dbt scsrvrep on scsrvrep.t_id = process_oper_u.t_operid 
              left join dnamealg_dbt namealg on namealg.t_itypealg = 3170 and 
                                                namealg.t_inumberalg = scsrvrep.t_repstatus 
              where process_oper_u.t_type = ? and
                    process_oper_u.t_operdate = ? and
                    process_oper_u.t_subtype = ?
              order by t_operid
             ];
           end;   
          cmdInfo = RsdCommand(EndCaptureOutput());
          cmdInfo.AddParam("processtype", RSDBP_IN, rs.value("t_type"));
          cmdInfo.AddParam("operdate", RSDBP_IN, date(rs.value("t_operdate")));
          cmdInfo.AddParam("processsubtype", RSDBP_IN, rs.value("t_subtype"));

          else
            return CM_IGNORE;
          end;
          rsInfo = RSDRecordset(cmdInfo, RSDVAL_CLIENT, RSDVAL_STATIC);
          RunScroll(rsInfo, 3, MakeArray("t_oprcode", "Код", 25, 2, -1, 0,
                                         "t_oprname", "Наименование", 30, 2, -1, 0,  
                                         "t_oprstatus", "Состояние", 20, 2, -1, 0), 
                    "_eInfoDialog", "eInfoDialog", rs.value("t_name"), "~Enter~ Информация ~Esc~ Выход", true);
        end;
        return CM_IGNORE;
      elif((key == 18/*Ctrl+R*/) or (key == 0))
        SaveNum = rs.value("t_num");
        return CM_SELECT;
      end;
    end;
  end;


  /*Точка входа*/
  var rsScroll;
  rsScroll = GetProcessRecordSet(operdate, processtype);
  while(RunScroll(rsScroll, 11, MakeArray("t_num", "№", 2, 2, -1, 0,
                                         "t_isfinish", "P", 2, 2, -1, 0,  
                                         "t_name", "Процесс", 40, 2, 2, 0, 
                                         "t_statusname", "Состояние", 17, 2, -1, 0, 
                                         "t_count", "Число обработок", 10, 2, -1, 0, 
                                         "t_countrecs", "Обработано", 10, 2, -1, 0, 
                                         "t_counterrors", "С ошибкой", 10, 2, -1, 0, 
                                         "t_countwarning", "С предупреждением", 10, 2, -1, 0,
                                         "t_starttime", "Начало", 20, 2, -1, 0,
                                         "t_Endtime", "Окончание", 20, 2, -1, 0, 
                                         "t_errmsg", "", 20, 2, -1, 0), 
                        "eRunProcessDialog", "eRunProcessDialog", string(iif(processtype== 1,"ММВБ. ",iif(processtype== 4,"СПБ. ","")),"Обработка операционного дня ") + operdate, "~F2~ Обработать ~F5~ Пропустить ~F8~ Очистить обработку ~Enter~ Информация ~Esc~ Выход", true))
    rsScroll = GetProcessRecordSet(operdate, processtype);
  end;
end;


/*Безинтерфейсный процесс*/
private macro RunProcessShed(operdate, opernum, processtype, subtypes)
  var cmdProcess, rsProcess, iProcess = 0;
  var errmsg = "";
  /*Все не завершенные и без признака "Пропустить"*/

  var sql = 

  "  select  rowid, T_TYPE, t_operdate, t_subtype, t_num, t_status, t_wrnmsg, t_isfinish, t_name, t_statusname, t_count, t_countrecs, t_counterrors, t_countwarning, "+
  "  to_char(t_starttime, 'dd.mm.yyyy hh24:mi:ss') t_starttime, to_char(t_Endtime, 'dd.mm.yyyy hh24:mi:ss') t_Endtime, t_errmsg "+
  "  from dprocess_u_dbt                      "+
  "  where t_operdate = ? and                 "+
  "        t_type = ? and                     "+
  "        ((t_isfinish not in ('X', 'S')) or ((t_isfinish = 'S') and ('-1' <> '"+subtypes+"'))) and   "+
  "        (('-1' = '"+subtypes+"') or (t_subtype in ("+subtypes+")))   "+
  "  order by t_num, t_name                   ";
  
  cmdProcess = RsdCommand(sql);
  cmdProcess.AddParam("operdate", RSDBP_IN, operdate);
  cmdProcess.AddParam("processtype", RSDBP_IN, processtype);
  rsProcess = RSDRecordset(cmdProcess, RSDVAL_CLIENT, RSDVAL_STATIC);
  while(rsProcess.movenext)
    if(iProcess == 0)
      InitProgress(int(rsProcess.RecCount), "Ждите...", "Выполнение процессов");
    end;
    if ( (rsProcess.value("t_isfinish") == "")
         or
        ((rsProcess.value("t_isfinish") == "S") and (subtypes != "-1") and (ValType(subtypes) !=V_UNDEF))
       )
      if(not RunProcessItem(opernum, @rsProcess, @errmsg))
        InsertLog("parm_break1=" + errmsg);
        break;
      end;
    else
      InsertLog("parm_break2=" + errmsg);
      break;
    end;
    iProcess = iProcess + 1;
    UseProgress(iProcess);
  end;
  if(iProcess > 0)
    RemProgress();
  end;
  InsertLog("exit=" + iProcess + "=" + errmsg);
end;


/*Автоматическая процедура*/
private macro RunProcess(operdate, opernum, dialogflag, processtype, subtypes)
  var exec;
  var df;

  if((processtype != 1) and (processtype != 2) and (processtype != 3) and (processtype != 4) and (processtype != 6))
    return;
  end;
  /* Golovkin 01.04.2020 
     Добавил 106 "Загрузка в шлюз Итоговых нетто-ТО по ФИ"
             207 "Загрузка в БО Итоговых нетто-ТО по ФИ"
  */
  /*Строим процесс*/
  StartCaptureOutput();
  [
    declare
      operdate date := ?;
      processtype integer := ?;
    begin
      --update dprocess_u_dbt set t_num = t_num + 1 where t_type = 1 and t_num >= 10
      --БОЦБ
      if(processtype = 1)then
        merge into dprocess_u_dbt p
        using
        (select t_subtype, t_num, t_isfinish, t_name
         from (select 101 t_subtype,  1 t_num, chr(0) t_isfinish, 'Загрузка в шлюз заявок на сделки' t_name from dual union all
               select 108 t_subtype,  2 t_num, chr(0) t_isfinish, 'Загрузка в шлюз заявок на внебиржевые сделки' t_name from dual union all
               select 102 t_subtype,  3 t_num, chr(0) t_isfinish, 'Загрузка в шлюз заключенных сделок' t_name from dual union all
               select 109 t_subtype,  4 t_num, chr(0) t_isfinish, 'Загрузка в шлюз заключенных внебиржевых сделок' t_name from dual union all
               select 103 t_subtype,  5 t_num, chr(0) t_isfinish, 'Загрузка в шлюз сделок, принятых на клиринг' t_name from dual union all               
               select 105 t_subtype,  6 t_num, chr(0) t_isfinish, 'Загрузка в шлюз движений КСУ' t_name from dual union all
               select 106 t_subtype,  7 t_num, chr(0) t_isfinish, 'Загрузка в шлюз Итоговых нетто-ТО по ФИ' t_name from dual union all
               select 107 t_subtype,  8 t_num, chr(0) t_isfinish, 'Загрузка в шлюз комиссионных вознаграждений по валютному рынку' t_name from dual union all
               select 201 t_subtype,  9 t_num, chr(0) t_isfinish, 'Загрузка в БО заявок на клиентские сделки' t_name from dual union all
               select 202 t_subtype, 10 t_num, chr(0) t_isfinish, 'Загрузка в БО отчета биржи' t_name from dual union all
               select 203 t_subtype, 11 t_num, chr(0) t_isfinish, 'Загрузка в БО клиентских сделок с ценными бумагами' t_name from dual union all
               select 204 t_subtype, 12 t_num, chr(0) t_isfinish, 'Загрузка в БО клиентских сделок, принятых на клиринг' t_name from dual union all
               select 401 t_subtype, 13 t_num,    'S' t_isfinish, 'Расчет комиссий' t_name from dual union all
               select 702 t_subtype, 14 t_num,    'S' t_isfinish, 'Расчет Лимитов Фондовый рынок и ЕДП' t_name from dual union all
               select 703 t_subtype, 15 t_num,    'S' t_isfinish, 'Сверка и выгрузка общего файла лимитов' t_name from dual union all
               select 719 t_subtype, 16 t_num,    'S' t_isfinish, 'Обмен данными СОФР-ЦФТ по Депо комиссиям' t_name from dual union all
               select 731 t_subtype, 17 t_num,    'S' t_isfinish, 'Обработка депозитарных комиссий' t_name from dual union all
               select 751 t_subtype, 18 t_num,    'S' t_isfinish, 'Формирование файла корректировок лимитов по Депо комиссиям' t_name from dual union all
               select 301 t_subtype, 19 t_num,    'S' t_isfinish, 'Старт биржевых клиентских сделок БО' t_name from dual union all
               select 506 t_subtype, 20 t_num,    'S' t_isfinish, 'СОБУ по клиентским операциям' t_name from dual union all
               select 508 t_subtype, 21 t_num,    'S' t_isfinish, 'СОВУ по клиентским операциям' t_name from dual union all
               select 610 t_subtype, 22 t_num,    'S' t_isfinish, 'Расчет НОБ по мат. выгоде' t_name from dual union all
               select 611 t_subtype, 23 t_num,    'S' t_isfinish, 'Удержание НДФЛ по мат. выгоде' t_name from dual union all
               select 104 t_subtype, 24 t_num, chr(0) t_isfinish, 'Загрузка в шлюз движений ДС' t_name from dual union all
               select 505 t_subtype, 25 t_num, chr(0) t_isfinish, 'Создание операций движения ДС' t_name from dual union all
               select 205 t_subtype, 26 t_num, chr(0) t_isfinish, 'Загрузка в БО движений ДС' t_name from dual union all
               select 206 t_subtype, 27 t_num, chr(0) t_isfinish, 'Загрузка в БО движений КСУ' t_name from dual union all
               select 207 t_subtype, 28 t_num, chr(0) t_isfinish, 'Загрузка в БО Итоговых нетто-ТО по ФИ' t_name from dual union all
               select 208 t_subtype, 29 t_num, chr(0) t_isfinish, 'Загрузка в БО комиссионных вознаграждений по валютному рынку' t_name from dual union all
               select 209 t_subtype, 30 t_num, chr(0) t_isfinish, 'Загрузка в БО заявок на собственные сделки' t_name from dual union all
               select 210 t_subtype, 31 t_num, chr(0) t_isfinish, 'Загрузка в БО собственных сделок с ценными бумагами' t_name from dual union all
               select 230 t_subtype, 32 t_num, chr(0) t_isfinish, 'Загрузка в БО собственных сделок, принятых на клиринг' t_name from dual union all
               select 302 t_subtype, 33 t_num, chr(0) t_isfinish, 'Загрузка котировок с ММВБ' t_name from dual union all
               select 303 t_subtype, 34 t_num, chr(0) t_isfinish, 'Старт биржевых собственных сделок БО' t_name from dual union all
               select 503 t_subtype, 35 t_num, chr(0) t_isfinish, 'Утреннее начисление дохода/расхода' t_name from dual union all 
               select 720 t_subtype, 36 t_num, chr(0) t_isfinish, 'Отправка уведомлений при открытии счетов в новых валютах' t_name from dual union all 
               select 603 t_subtype, 37 t_num,    'S' t_isfinish, 'Списание задолженности по брокерским операциям' t_name from dual union all
               select 604 t_subtype, 38 t_num,    'S' t_isfinish, 'Вынос на просрочку задолженности по брокерским операциям' t_name from dual union all
               select 605 t_subtype, 39 t_num,    'S' t_isfinish, 'Инициация процесса списания задолженностей со счетов в ЦФТ' t_name from dual union all
               select 501 t_subtype, 40 t_num,    'S' t_isfinish, 'Расчет текущей справедливой стоимости' t_name from dual union all
               select 502 t_subtype, 41 t_num,    'S' t_isfinish, 'Формирование сервисных операций' t_name from dual union all
               select 504 t_subtype, 42 t_num,    'S' t_isfinish, 'Переоценка' t_name from dual union all
               select 601 t_subtype, 43 t_num,    'S' t_isfinish, 'Формирование отчета брокера' t_name from dual union all
               select 507 t_subtype, 44 t_num,    'S' t_isfinish, 'Запуск процедуры перенумерации операций списания ДС' t_name from dual union all
               select 602 t_subtype, 45 t_num,    'S' t_isfinish, 'Расчет базовых сумм для ИнвестСоветника' t_name from dual
               )) p_new
        on (p.t_type = processtype and 
            p.t_operdate = operdate and 
            p.t_subtype = p_new.t_subtype)
        when not matched then
          insert values(processtype, operdate, p_new.t_subtype, p_new.t_num, p_new.t_name, 0, 'Не обработан', p_new.t_isfinish, 0, 0, 0, chr(1), 0, chr(1), null, null);
      --ФИССиКО
      elsif(processtype = 2) then 
        merge into dprocess_u_dbt p
        using
        (select t_subtype, t_num, t_isfinish, t_name
         from (select 111 t_subtype,  1 t_num, chr(0) t_isfinish, 'Загрузка в шлюз биржевых данных' t_name from dual union all
               select 211 t_subtype,  2 t_num, chr(0) t_isfinish, 'Загрузка в БО производных инструментов' t_name from dual union all
               select 212 t_subtype,  3 t_num, chr(0) t_isfinish, 'Загрузка в БО курсов финансовых инструментов' t_name from dual union all
               select 213 t_subtype,  4 t_num, chr(0) t_isfinish, 'Загрузка в БО биржевых операций с ПИ' t_name from dual union all
               select 214 t_subtype,  5 t_num, chr(0) t_isfinish, 'Загрузка в БО итоги дня по позиции ПИ' t_name from dual union all
               select 215 t_subtype,  6 t_num, chr(0) t_isfinish, 'Загрузка в БО разовой комиссии' t_name from dual union all
               select 216 t_subtype,  7 t_num, chr(0) t_isfinish, 'Загрузка в БО отчета биржи' t_name from dual union all
               select 217 t_subtype,  8 t_num, chr(0) t_isfinish, 'Загрузка в БО обработка отчета по операции' t_name from dual union all
               select 218 t_subtype,  9 t_num, chr(0) t_isfinish, 'Загрузка в БО информации о гарантийном обеспечении' t_name from dual union all
               select 412 t_subtype, 10 t_num, chr(0) t_isfinish, 'Инициализация расчетов с биржей по клиентам' t_name from dual union all
               select 411 t_subtype, 11 t_num, chr(0) t_isfinish, 'Обработка клиентских сделок' t_name from dual union all
               select 413 t_subtype, 12 t_num, chr(0) t_isfinish, 'Обработка расчетов с биржей по клиентам' t_name from dual union all
               select 414 t_subtype, 13 t_num, chr(0) t_isfinish, 'Закрытие расчетов с биржей по клиентам' t_name from dual union all
               select 711 t_subtype, 14 t_num, chr(0) t_isfinish, 'Расчет лимитов Срочный рынок' t_name from dual union all
               select 112 t_subtype, 15 t_num,    'S' t_isfinish, 'Загрузка в шлюз заявок-поручений на сделки' t_name from dual union all
               select 219 t_subtype, 16 t_num,    'S' t_isfinish, 'Загрузка в БО заявок-поручений на сделки' t_name from dual  union all
               select 415 t_subtype, 17 t_num, chr(0) t_isfinish, 'Инициализация расчетов с биржей по собственным сделкам' t_name from dual union all
               select 416 t_subtype, 18 t_num, chr(0) t_isfinish, 'Обработка собственных сделок ' t_name from dual union all
               select 417 t_subtype, 19 t_num, chr(0) t_isfinish, 'Обработка расчетов с биржей по собственным сделкам' t_name from dual union all
               select 418 t_subtype, 20 t_num, chr(0) t_isfinish, 'Закрытие расчетов с биржей по собственным сделкам' t_name from dual
               )) p_new 

        on (p.t_type = processtype and 
            p.t_operdate = operdate and 
            p.t_subtype = p_new.t_subtype)
        when not matched then
          insert values(processtype, operdate, p_new.t_subtype, p_new.t_num, p_new.t_name, 0, 'Не обработан', p_new.t_isfinish, 0, 0, 0, chr(1), 0, chr(1), null, null);
      elsif(processtype = 3) then
        merge into dprocess_u_dbt p
        using
        (select t_subtype, t_num, t_isfinish, t_name
         from (select 121 t_subtype,  1  t_num, chr(0) t_isfinish, 'Загрузка в Шлюз переводов и комиссий' t_name from dual union all
               select 221 t_subtype,  2  t_num, chr(0) t_isfinish, 'Загрузка в БО переводов' t_name from dual union all
               select 122 t_subtype,  3  t_num,    'S' t_isfinish, 'Загрузка в Шлюз итогов валютных торгов' t_name from dual union all
               select 222 t_subtype,  4  t_num,    'S' t_isfinish, 'Загрузка в БО итогов валютных торгов' t_name from dual union all
               select 226 t_subtype,  5  t_num, chr(0) t_isfinish, 'Загрузка в БО комиссий' t_name from dual union all
               select 123 t_subtype,  6  t_num, chr(0) t_isfinish, 'Загрузка в Шлюз сделок' t_name from dual union all
               select 223 t_subtype,  7  t_num, chr(0) t_isfinish, 'Загрузка в БО сделок ' t_name from dual union all
               select 224 t_subtype,  8  t_num, chr(0) t_isfinish, 'Загрузка в БО Отчета биржи' t_name from dual union all
               select 421 t_subtype,  9  t_num, chr(0) t_isfinish, 'Расчёт комиссий' t_name from dual union all
               select 721 t_subtype, 10  t_num, chr(0) t_isfinish, 'Расчет лимитов Валютный рынок' t_name from dual union all
               select 422 t_subtype, 11  t_num, chr(0) t_isfinish, 'Старт сделок БО' t_name from dual union all
               select 423 t_subtype, 12  t_num,    'S' t_isfinish, 'Обработка итогов' t_name from dual union all
               select 124 t_subtype, 13  t_num,    'S' t_isfinish, 'Загрузка в Шлюз заявок' t_name from dual union all
               select 225 t_subtype, 14  t_num,    'S' t_isfinish, 'Загрузка в БО заявок на сделки' t_name from dual
               )) p_new
        on (p.t_type = processtype and 
            p.t_operdate = operdate and 
            p.t_subtype = p_new.t_subtype)
        when not matched then
          insert values(processtype, operdate, p_new.t_subtype, p_new.t_num, p_new.t_name, 0, 'Не обработан', p_new.t_isfinish, 0, 0, 0, chr(1), 0, chr(1), null, null);
      --СПБ
      elsif(processtype = 4) then
        merge into dprocess_u_dbt p
        using
        (select t_subtype, t_num, t_isfinish, t_name
         from (select 4010 t_subtype,  1  t_num, chr(0) t_isfinish, 'Загрузка в шлюз заявок на сделки на бирже СПБ' t_name from dual union all
               select 4020 t_subtype,  2  t_num, chr(0) t_isfinish, 'Загрузка в шлюз заключенных сделок на бирже СПБ' t_name from dual union all
               select 4030 t_subtype,  3  t_num, chr(0) t_isfinish, 'Загрузка в шлюз сделок, принятых на клиринг на бирже СПБ' t_name from dual union all
               select 4040 t_subtype,  4  t_num, chr(0) t_isfinish, 'Загрузка в шлюз Итоговых нетто-ТО по ФИ на бирже СПБ' t_name from dual union all
               select 4050 t_subtype,  5  t_num, chr(0) t_isfinish, 'Загрузка в БО заявок на клиентские сделки на бирже СПБ' t_name from dual union all
               select 4060 t_subtype,  6  t_num, chr(0) t_isfinish, 'Загрузка в БО отчета биржи на бирже СПБ' t_name from dual union all
               select 4070 t_subtype,  7  t_num, chr(0) t_isfinish, 'Загрузка в БО клиентских сделок с ценными бумагами на бирже СПБ' t_name from dual union all
               select 4080 t_subtype,  8  t_num, chr(0) t_isfinish, 'Загрузка в БО клиентских сделок, принятых на клиринг на бирже СПБ' t_name from dual union all
               select 4090 t_subtype,  9  t_num, chr(0) t_isfinish, 'Создание операций движения ДС на бирже СПБ' t_name from dual union all
               select 4100 t_subtype, 10  t_num, chr(0) t_isfinish, 'Загрузка в БО Итоговых нетто-ТО по ФИ на бирже СПБ' t_name from dual union all
               select 4110 t_subtype, 11  t_num, chr(0) t_isfinish, 'Загрузка в шлюз движений ДС на бирже СПБ' t_name from dual union all
               select 4120 t_subtype, 12  t_num, chr(0) t_isfinish, 'Загрузка в БО движений ДС на бирже СПБ' t_name from dual union all
               select 4130 t_subtype, 13  t_num, chr(0) t_isfinish, 'Загрузка котировок с СПБ' t_name from dual
               )) p_new
        on (p.t_type = processtype and 
            p.t_operdate = operdate and 
            p.t_subtype = p_new.t_subtype)
        when not matched then
          insert values(processtype, operdate, p_new.t_subtype, p_new.t_num, p_new.t_name, 0, 'Не обработан', p_new.t_isfinish, 0, 0, 0, chr(1), 0, chr(1), null, null);
      elsif(processtype = 6) then
        merge into dprocess_u_dbt p
        using
        (select t_subtype, t_num, t_isfinish, t_name
         from (select 5010 t_subtype, 1  t_num, chr(0) t_isfinish, 'Загрузка в шлюз Итоговых нетто-ТО по ФИ на бирже СПВБ' t_name from dual union all
               select 5015 t_subtype, 2  t_num, chr(0) t_isfinish, 'Загрузка в шлюз комиссий по сделкам на бирже СПВБ ' t_name from dual union all
               select 5020 t_subtype, 3  t_num, chr(0) t_isfinish, 'Создание операций движения ДС на бирже СПВБ' t_name from dual union all
               select 5030 t_subtype, 4  t_num, chr(0) t_isfinish, 'Загрузка в БО Итоговых нетто-ТО по ФИ на бирже СПВБ' t_name from dual  union all
               select 5040 t_subtype, 5  t_num, chr(0) t_isfinish, 'Загрузка в БО комиссий по сделкам на бирже СПВБ' t_name from dual 
               )) p_new
        on (p.t_type = processtype and 
            p.t_operdate = operdate and 
            p.t_subtype = p_new.t_subtype)
        when not matched then
          insert values(processtype, operdate, p_new.t_subtype, p_new.t_num, p_new.t_name, 0, 'Не обработан', p_new.t_isfinish, 0, 0, 0, chr(1), 0, chr(1), null, null);
      end if;
    end;
  ];
  exec = RsdCommand(EndCaptureOutput());
  exec.AddParam("operdate", RSDBP_IN, operdate);
  exec.AddParam("processtype", RSDBP_IN, processtype);
  exec.Execute();

  var oldCritAct = CritActSuspend(true);

  /*Запускаем процесс*/
  df = GetDialogFlag();
  if(dialogflag)
    /*Интерфейсно*/
    RunProcessDialog(operdate, opernum, processtype);
  else
    /*Безинтерфейсно*/
    RunProcessShed(operdate, opernum, processtype, subtypes);
  end;
  SetDialogFlag(df);

  CritActSuspend(oldCritAct);

end;

/*Получить имя папки текстовых файлов*/
private macro GetTxtFileDir()
  var stat:integer = 0, Path:string = "";
 
  GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR", V_STRING, Path, stat);
  if(stat)
    MsgBox("Ошибка при получении значения настройки \"BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR\"");
  end;

  return Path;
end;

private macro processPath(p_path:string):string
  var l_str, l_p, l_path = "";

  p_path = trim( p_path );

  if( substr( p_path, 1, 2 ) == ".." ) /* ссылка на вышестоящий каталог */
    p_path = substr( p_path, 3 );

    l_str  = getCWD(false);
    l_p    = strbrk( l_str, "\\" );
    while( l_p != 0 )
      l_path = l_path + substr( l_str, 1, l_p - 1 ) + "\\";
      l_str  = substr( l_str, l_p + 1 );
      l_p    = strbrk( l_str, "\\" );
    end;
    return ( substr( l_path, 1, strlen( l_path ) - 1 ) + p_path );

  elif( substr( p_path, 1, 1 ) == "." ) /* ссылка на текущий каталог */
    return ( getCWD + substr( p_path, 2 ) );
  end;

  return p_path;
end;

/*Получение полного пути к каталогу*/
private macro GetFullPath(txtPath:string):string
  var Path = "", pLen = strlen(txtPath);

  if((pLen > 4) and (substr(txtPath, 1, 2) == "\\\\"))
    Path = txtPath;
    if(index(Path, "\\", pLen) == 0)
      Path = Path + "\\";
    end;
  else
    Path = processPath(txtPath) + "\\";
    if( substr( txtPath, 1, 1 ) == "\\" )
      Path = GetCurDir(true) + Path;
    end;
  end;

  return Path;
end;

/*Получение количества свободного места в каталоге*/
private macro GetFreeSpaceAvailable(path:string):numeric
  var drive, driveLetter:string;
  var freeSpace:numeric = numeric(0);
  var fso = ActiveX("Scripting.FileSystemObject");
  var fullPath:string = GetFullPath(path);
  var rootIndex:integer = Index(fullPath, ":");

  if(rootIndex > 0)
    driveLetter = SubStr(fullPath, 1, rootIndex);
    drive = fso.GetDrive(driveLetter);
    freeSpace = numeric(drive.FreeSpace());
  end;
  return freeSpace;
end;

/*Отправка e-mail сообщения об отсутствии места на диске*/
private macro SendNotificationAbsentFreeSpace():integer
  var stat:integer = 0, v_email_processor, email_group;

  GetRegistryValue("РСХБ\\ИНТЕГРАЦИЯ\\SEND_NOTIFY_BO", V_INTEGER, email_group, stat);
  if(stat)
    MsgBox("Ошибка при получении значения настройки \"РСХБ\\ИНТЕГРАЦИЯ\\SEND_NOTIFY_BO\"");
  end;
  if(email_group)
    v_email_processor = c_email_proc_env();
    v_email_processor.m_get_email_group(email_group);
    v_email_processor.m_set_msg_head("Недостаточно места на диске");
    v_email_processor.m_add_row_to_msg_text("На диске сервера приложений недостаточно свободного места. Работа биржевого автомата невозможна. Освободите место на диске и повторите запуск автомата");
    v_email_processor.m_save_to_submit_grp(email_group, true);
    v_email_processor.m_submit_email_synch();                        
  end;
  return 0;

onerror(err)
  return 1;
end;

/*Перевод мегабайт в байты*/
private macro MBToBytes(value:integer):numeric
  return numeric(numeric(value) * 1024 * 1024);
end;

/*Проверка наличия свободного места для формирования протокола в каталоге TxtFile*/
private macro CheckFreeSpace():bool
  var stat:integer = 0, minFreeSpace:integer = 0;
  var sql, cmd; 

  GetRegistryValue("РСХБ\\МИНИМАЛЬНОЕ МЕСТО НА ДИСКЕ", V_INTEGER, minFreeSpace, stat);
  if(stat)
    MsgBox("Ошибка при получении значения настройки \"РСХБ\\МИНИМАЛЬНОЕ МЕСТО НА ДИСКЕ\"");
    return false;
  else
    if(GetFreeSpaceAvailable(GetTxtFileDir()) <= MBToBytes(minFreeSpace))
      SendNotificationAbsentFreeSpace();

      /*Регистрация ошибки в мониторе событий*/
      sql = "DECLARE "
          + "   v_errtxt varchar2(1000); "
          + "   v_MsgID  itt_q_message_log.msgid%type; "
          + "BEGIN "
          + "   IT_EVENT.RegisterEvent(NULL, 'SOFR', 'AutoProcess', 'Ошибка: недостаточно места на диске', "
          + "                          '<XML ErrorCode=\"11\" Header=\"На диске сервера приложений недостаточно свободного места. Работа биржевого автомата невозможна. Освободите место на диске и повторите запуск автомата\"/>', "
          + "                          v_errtxt, v_MsgID); "
          + "END; ";
      cmd = RSDCommand(sql);
      cmd.execute();

      if(not IsShedulerRunning)
        MsgBox("На диске сервера приложений недостаточно свободного места. Работа биржевого автомата невозможна. Освободите место на диске и повторите запуск автомата");
      end;
      return false;
    end;
  end;
  return true;
end;

/*Запуск автоматической процедуры*/
macro AutoProcess(parm:variant)
  var sql, cmd, CurDateFormat = "";

  if(not CheckFreeSpace())
    return;
  end;

  sql = "SELECT * FROM NLS_SESSION_PARAMETERS WHERE PARAMETER = 'NLS_DATE_FORMAT'";
  cmd = TrsbDataset(sql);
  If(cmd.movenext())
     CurDateFormat = cmd.value;
//     MsgBox(CurDateFormat);
  End;

  sql = "alter session set nls_date_format='DD.MM.YYYY HH24:MI:SS'";
  cmd = RsDCommand(sql);
  cmd.execute();

  /*Планировщик*/
  if(IsShedulerRunning())
    /*Параметры запуска берем из задания планировщика*/
    parm = GetShedulerCommandLine();
  end;

  /*Читаем параметры процедуры*/
  var i;
  var dialogflag;
  /*-dialogflag:*/
  i = index(strlwr(parm), "-dialogflag:");
  if((i > 0) and (substr(parm, i + 12, 1) == "1"))
    dialogflag = true;
  else
    dialogflag = false;
  end;
  var processtype;
  /*-processtype:*/
  i = index(strlwr(parm), "-processtype:");
  if(i > 0)
    i = i + 13;
    processtype = "";
    while((codefor(substr(parm,i,1)) >= codefor("0")) and (codefor(substr(parm,i,1)) <= codefor("9")))
      processtype = processtype + substr(parm,i,1);
      i = i + 1;
    end;
    if(strlen(processtype) > 0)
      processtype = int(processtype)
    else
      processtype = 0;
    end;
  else
    processtype = 0;
  end;
  /*-date:*/
  var dt;
  i = index(strlwr(parm), "-date:");
  if(i > 0)
    i = i + 6;
    dt = "";
    while(((codefor(substr(parm,i,1)) >= codefor("0")) and (codefor(substr(parm,i,1)) <= codefor("9"))) or (substr(parm,i,1) == "."))
      dt = dt + substr(parm,i,1);
      i = i + 1;
    end;
    dt = date(dt)
  else
    dt = {curdate};
  end;

  /*-fixdate  для тестовых запусков в планировщике указываем -fixdate:1, для прода не указываем вовсе или=0*/
  var fixdate;
  i = index(strlwr(parm), "-fixdate:");
  if(i > 0)
    i = i + 9;
    fixdate= "";
    while((codefor(substr(parm,i,1)) >= codefor("0")) and (codefor(substr(parm,i,1)) <= codefor("9")))
      fixdate = fixdate + substr(parm,i,1);
      i = i + 1;
    end;
    if(strlen(fixdate) > 0)
      fixdate = int(fixdate)
    else
      fixdate = 0;
    end;
  else
    fixdate = 0;
  end;

  /*  Переопределение dt */
  if( IsShedulerRunning() and (not fixdate))
    if ( (GetDateAfterWorkDays (dt, 0) != date ()) and (processtype != 2) ) //выходной день (кроме Срочного рынка)
      exit (1);
    else 
      dt = GetDateAfterWorkDays (date ()/*dt*/, -1);
    end;
  elif(IsShedulerRunning())
    dt = GetDateAfterWorkDays (date ()/*dt*/, -1);
  end;

  /*-opernum*/
  var opernum;
  i = index(strlwr(parm), "-opernum:");
  if(i > 0)
    i = i + 9;
    opernum = "";
    while((codefor(substr(parm,i,1)) >= codefor("0")) and (codefor(substr(parm,i,1)) <= codefor("9")))
      opernum = opernum + substr(parm,i,1);
      i = i + 1;
    end;
    if(strlen(opernum) > 0)
      opernum = int(opernum)
    else
      opernum = {oper};
    end;
  else
    opernum = {oper};
  end;

  /*-subtypes*/
  var subtypes = "";
  i = index(strlwr(parm), "-subtypes:");
  if(i > 0)
    i = i + 10;
    subtypes = "";
    while((codefor(substr(parm,i,1)) >= codefor("0")) and (codefor(substr(parm,i,1)) <= codefor("9")) or  (substr(parm,i,1) == ","))
      subtypes = subtypes + substr(parm,i,1);
      i = i + 1;
    end;
    if(strlen(subtypes) <= 0)
      subtypes = "-1";
    end;
  else
    subtypes = "-1";
  end;

 
  /*Запускаем процедуру*/
  if(not IsShedulerRunning() and (not fixdate))
    if(not GetDate(dt, "Дата процедуры"))
      msgboxex("Отказ от обработки");
      return;
    end;
 /*KD*/
    If({curdate} != dt)
       If(not GetTrue(false, "Дата опер дня пользователя не совпадает с датой обработки, продолжить?"))
          msgboxex("Отказ от обработки");
          return;
       end;
    end;

    If({curdate} != GetDateAfterWorkDays(Date(), -1))
       If(not GetTrue(false, "Предположительно обрабатываемый день должен быть " + GetDateAfterWorkDays(Date(), -1) + ", а опер день пользователя другой, продолжить?"))
          msgboxex("Отказ от обработки");
          return;
       end;
    end;
  else
    InsertLog("parm1=" + parm);
    InsertLog("parm2=" + dt + "=" + opernum + "=" + string(dialogflag) + "=" + processtype);
  end;

  dt_proc = dt;
  RunProcess(dt, opernum, dialogflag, processtype, subtypes);
 
  SendNotification(SendWithShed, processtype);
  If(CurDateFormat != "")
     sql = "alter session set nls_date_format='" + CurDateFormat + "'";
     cmd = RsDCommand(sql);
     cmd.execute();
  end;

end;

