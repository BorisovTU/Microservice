/*
$Name:         AutoProcess_utils.mac
$Module:       БА
$Description:  Общие функции для биржевого автомата
*/
import "dlquery.mac";

const CALC_STOCK_COMISS_SUBTYPE = 401;
const CALC_STOCK_LIMIT_SUBTYPE  = 701;
const CALC_EDP_LIMIT_SUBTYPE    = 702;
const UNLOAD_LIMIT_SUBTYPE      = 703;
const VM_DEAL_START_SUBTYPE     = 422;

const ProcSuccess_Status          = 10, ProcSuccess_StatusName     = "Обработан успешно";
const ProcWithWarning_Status      = 10, ProcWithWarning_StatusName = "Обработан с предупреждениями";
const ProcWithError_Status        = 3,  ProcWithError_StatusName   = "Обработан с ошибками";
const NotProccesed_Status         = 0,  NotProccesed_StatusName    = "Не обработан";
const Proccesed_Status            = 1,  Proccesed_StatusName       = "Обрабатывается";
const ErrorProccesed_Status       = 2,  ErrorProccesed_StatusName  = "Ошибка обработки";
const SkipProc_Status             = -1;

macro GetProcessStatus(pSubTypeProcess:integer, pDateProcess:date)
  var sql, cmd, ds;
  var ProcStatus : integer = 0;
  sql = String( "select case proc.t_isfinish when 'S' then -1 else proc.t_status end as t_status\n"
               ,"  from dprocess_u_dbt proc\n"
               ," where proc.t_subtype = :pSubType\n"
               ,"   and proc.t_operdate = :pDate");
  cmd = DL_RSDCommand();
  cmd.AddParam(pSubTypeProcess);
  cmd.AddParam(pDateProcess);
  ds = cmd.Execute(sql);
  if(ds.MoveNext())
    ProcStatus = ds.Status;
  end;
  return ProcStatus;
end;