/*BIQ-10484 CCBO-5829 (CCBO-6443) */

import rsd, globals, DealsInter;
import "AutoProcess.mac", "limout.mac";

macro printProtokol(FileName, message, append) //append - признак дополнения в файл
  setOutput(FileName, append);
  println(message);
  setOutput(null);
end;


/*Обработка депозитарных комиссий*/
macro processDepositsCommisions(dt,result_protocol:@TStrCollector, recs:@integer, errrecs:@integer, errmsg:@string, wrnrecs:@integer)
  //dt = dt - 1 ; //debug
  recs = 0;
  errrecs = 0;
  wrnrecs = 0; // Пока возвращаем 0
  errmsg = "";
  result_protocol.ClearArray;
  var fileName = strsubst(GetCurDir(false),"\\Obj","") + strsubst(GetTxtFileName("processDepositsCommisions"
//                                                            +int(substr(string(date),1,2))+int(substr(string(date),4,2))+int(substr(string(date),7,4))+
//                                                            int(substr(string(time),1,2))+int(substr(string(time),4,2))+int(substr(string(time),7,2))
                                                      ),"..","");

//strsubst(GetCurDir(false),"\\Obj","") + strsubst(GetTxtFileName("test1"),"..","");

  var message;
  var query = 
    " SELECT t.t_id, t.t_code                                                                   " +
    "   FROM ddl_acc_dbt   t,                                                                   " +
    "        dfikinds_dbt  fikinds,                                                             " +
    "        dfininstr_dbt fininstr,                                                            " +
    "        dparty_dbt    party,                                                               " +
    "        dsfcontr_dbt  sfcontr,                                                             " +
    "        dnamealg_dbt  st                                                                   " +
    "  WHERE t.t_DocKind = 159 AND party.t_PartyID(+) = t.t_Client AND                          " +
    "        sfcontr.t_ID(+) = NVL(t.t_ClientContr, 0) AND                                      " +
    "        t.t_FIID = fininstr.t_FIID AND                                                     " +
    "        fininstr.t_FI_Kind = fikinds.t_FI_Kind AND st.t_iTypeAlg(+) = 3154 AND             " +
    "        st.t_iNumberAlg(+) = t.t_DocState AND t.t_BOffice = 5 AND                          " +
    "        (t.t_DATE > ? OR                                                                   " +
    "        t.t_DATE = ?) AND                                                                  " +
    "        (t.t_DATE < ? OR                                                                   " +
    "        t.t_DATE = ?)                                                                      "
  + "      AND t.t_OPERTYPE = 48 AND NOT                                                        " +
    "        (t.t_DocState = 2)                                                                 "
    ;
  var cmd = RSDCommand(query);
  cmd.AddParam("", rsdbp_in, dt);
  cmd.AddParam("", rsdbp_in, dt);
  cmd.AddParam("", rsdbp_in, dt);
  cmd.AddParam("", rsdbp_in, dt);
  var rs = RSDRecordset(cmd);
  printProtokol(fileName, "Протокол обработки депозитарных комиссий ",false);
  while(rs.moveNext())
    if (ExecuteDL_ACC(rs.value("t_id"),true)!=0)
      errrecs = errrecs + 1;
      message = "Ошибка в РОВУ обработки депозитарных комиссий № " + rs.value("t_code");
      result_protocol.AddString(message);
      printProtokol(fileName,message,true);
    else
      message = "Исполнено РОВУ обработки депозитарных комиссий № " + rs.value("t_code");
      result_protocol.AddString(message);
      printProtokol(fileName,message,true);
    end;
    recs = recs + 1;
  end;

  if (errrecs>0)
    var v_email_processor = c_email_proc_env();
    v_email_processor.m_get_email_group(16); //BrokerContract
    v_email_processor.m_set_msg_head("Ошибки обработки депозитарных комиссий за дату:"+dt);
    var text = "Обработка депозитарных комиссий "+ dt + "\n";
    v_email_processor.m_add_row_to_msg_text(text);
    if( not existFile ( fileName ) )
      msgbox( "Не найден файл протокола ", fileName );
      result_protocol.AddString( "Не найден файл протокола " + fileName );
      //return FALSE;
    end;
    v_email_processor.m_add_attach_to_list(fileName);
    v_email_processor.m_save_to_submit_grp(1, true); //BrokerContract
    if (v_email_processor.m_get_error_status)        
      wrnrecs = wrnrecs + 1; 
      errmsg = v_email_processor.get_service_msg;
      result_protocol.AddString(v_email_processor.get_service_msg);
      return true;
    end;
    v_email_processor.m_submit_email_synch();
    result_protocol.AddString("Письмо об ошибках отправлено: " + time());
  else
    result_protocol.AddString("Успешная обработка операций РОВУ. Обработано " + recs + " записей.");
    result_protocol.AddString("Ошибок " + errrecs);
    result_protocol.AddString("Предупреждений " + wrnrecs);
  end;
  return true;
onerror
  result_protocol.AddString("Ошибка при исполнении обработки депозитарных комиссий");
  errrecs = errrecs + 1;
  errmsg = "Ошибка при исполнении обработки депозитарных комиссий";
  return false;
end; 

/*Формирование файла корректировок лимитов по Депо комиссиям*/
macro formCorrectLimitsFile(dt,result_protocol:@TStrCollector, recs:@integer, errrecs:@integer, errmsg:@string, wrnrecs:@integer)
  //dt = dt - 1 ; //debug
  recs = 0;
  errrecs = 0;
  wrnrecs = 0; // Пока возвращаем 0
  errmsg = "";
  result_protocol.ClearArray;

  // поиск неисполненных РОВУ
  var query = 
    " SELECT t.t_id, t.t_code                                                                   " +
    "   FROM ddl_acc_dbt   t,                                                                   " +
    "        dfikinds_dbt  fikinds,                                                             " +
    "        dfininstr_dbt fininstr,                                                            " +
    "        dparty_dbt    party,                                                               " +
    "        dsfcontr_dbt  sfcontr,                                                             " +
    "        dnamealg_dbt  st                                                                   " +
    "  WHERE t.t_DocKind = 159 AND party.t_PartyID(+) = t.t_Client AND                          " +
    "        sfcontr.t_ID(+) = NVL(t.t_ClientContr, 0) AND                                      " +
    "        t.t_FIID = fininstr.t_FIID AND                                                     " +
    "        fininstr.t_FI_Kind = fikinds.t_FI_Kind AND st.t_iTypeAlg(+) = 3154 AND             " +
    "        st.t_iNumberAlg(+) = t.t_DocState AND t.t_BOffice = 5 AND                          " +
    "        (t.t_DATE > ? OR                                                                   " +
    "        t.t_DATE = ?) AND                                                                  " +
    "        (t.t_DATE < ? OR                                                                   " +
    "        t.t_DATE = ?)                                                                      "
  + "      AND t.t_OPERTYPE = 48 AND NOT                                                        " +
    "        (t.t_DocState = 2)                                                                 "
    ;
  var cmd = RSDCommand(query);
  cmd.AddParam("", rsdbp_in, dt);
  cmd.AddParam("", rsdbp_in, dt);
  cmd.AddParam("", rsdbp_in, dt);
  cmd.AddParam("", rsdbp_in, dt);
  var rs = RSDRecordset(cmd);

  // вывести неисполненные РОВУ в протокол
  while(rs.moveNext())
//    recs = recs + 1;
    wrnrecs = wrnrecs + 1;
    result_protocol.AddString("Предупреждение: не исполнено РОВУ обработки депозитарных комиссий № " + rs.value("t_code"));
  end;
  if (wrnrecs == 0)
    result_protocol.AddString("Неисполненных РОВУ обработки депозитарных комиссий нет за " + dt);
  end;

  var limitfile = "";
  // собственно, выгрузка корректировок лимитов в файл 
  limitCorOut(dt,true,null,null,true, @limitfile); // добавлены 2 параметра в рамках данного CCBO-5829

  if (ExistFile(limitfile))
    // вывод в протокол обработки пункта содержимого файла корректировок
    result_protocol.AddString("Файл "+limitfile);
    var limits = TStreamDoc(limitfile, "R");
    while (limits.readLine)
      recs = recs + 1;
      result_protocol.AddString(limits.str);
    end;
  
    if (wrnrecs==0)
      result_protocol.AddString("Успешное формирование файла корректировок лимитов по Депо комиссиям.");
    else
      result_protocol.AddString("Успешное формирование файла корректировок лимитов по Депо комиссиям. Есть предупреждения.");
    end;
  end;
  return true;
onerror(er)
  result_protocol.AddString("Ошибка при формирование файла корректировок лимитов по Депо комиссиям");
  errrecs = errrecs + 1;
  errmsg = "Ошибка при формирование файла корректировок лимитов по Депо комиссиям";
  return false;
end;

//processDepositsCommisions({curdate});

