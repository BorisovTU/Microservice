import globals;
import captureoutput, rsd, dlquery, cb_sql;
import CbReport_h;
import gtLibU, "mail.mac";


Private macro SC_InAccountingExecOp(commdate, opernum, num, contractkind/*1-клиенские, 0-собственные*/, documentid:@integer)
  var cmdD, rsD;

  var comm = TRecHandler("dl_comm.dbt"), stat = 0, nextnumb = 0;

  documentid = 0;

  GenerateReference(227, nextnumb);
  
  comm.rec.dockind = DL_INACCSRVOP/*4613*/;
  comm.rec.oper = opernum;
  comm.rec.division = 1;
  comm.rec.commstatus = 0;
  comm.rec.PartyId = -1;
  comm.rec.issuerID = -1;
  comm.rec.newFIID = -1;//код ФИ заполнять если ц/б, иначе -1
  comm.rec.commcode = nextnumb/* + num*/;
  comm.rec.commdate = commdate;//Дата операции
  comm.rec.operationkind = 0;//Вид действия
  comm.rec.opersubkind = 0;//Вид операции
  comm.rec.fiid = -1;// код ФИ заполнять если не ц/б, иначе -1
  comm.rec.contractkind = contractkind;
  comm.rec.clientid = -1;

  stat = SC_CreateDlCommOperation(comm);

  if(stat == 0)
     documentid = Int(comm.rec.DocumentID);
     stat = SC_ServOperExecuteSilent(DL_INACCSRVOP, Int(comm.rec.DocumentID));
  end;

  if(stat == 0)
    StartCaptureOutput();
    [ 
      select dl_comm.t_commstatus
      from ddl_comm_dbt dl_comm
      where dl_comm.t_documentid = ? and
            dl_comm.t_commstatus = 2
    ];
    cmdD = RSDCommand(EndCaptureOutput());
    cmdD.AddParam("documentid", RSDBP_IN, Int(comm.rec.DocumentID));
    cmdD.Execute();
    rsD = TRsbDataSet(cmdD);
    if(not rsD.movenext)
      return 1;
    end;
  end;

  return stat;
end;


Macro RunSOVU()

Var commdate, documentid;
  var Select, DataSet, Query;
var err = 0;

var v_email_processor = email_proc_env();

If( (Time() < Time(13,00,00)) OR (Time() > Time(18,00,00)) )
   exit(1);
end;

//Собственные
    Query = "select gr.t_plandate from ddlgrdeal_dbt gr, ddl_tick_dbt tick, ddlgracc_dbt ac, ddlgracc_dbt ac2 where gr.t_plandate < ?  and gr.t_plandate >= ? "
          + " and tick.t_clientid =-1 and tick.t_dealid = gr.t_docid and tick.t_bofficekind in (101) "
          + " and ac.t_state = 1 and ac.t_accnum = 3 "
          + " AND ac2.t_grdealid = ac.t_grdealid and ac2.t_state = 2 and ac2.t_accnum = 1 and ac.t_grdealid = gr.t_id "
          + " group by gr.t_plandate ";

    Select = DL_RSDCommand(Query);
    Select.AddParam(Date());
    Select.AddParam(Date()-10);
    DataSet = Select.Execute(Query);
    while(DataSet.MoveNext())
        commdate = date(sql_convtypedate(DataSet.plandate));
        If(commdate<={curdate})
   	   If(SC_InAccountingExecOp(commdate, 1, 1, 0/*1-клиенские, 0-собственные*/, @documentid) != 0)
	      err = err+1;
	   end;
	end;

    end;
//Клиентские
    Query = "select gr.t_plandate from ddlgrdeal_dbt gr, ddl_tick_dbt tick, ddlgracc_dbt ac, ddlgracc_dbt ac2 where gr.t_plandate < ?  and gr.t_plandate >= ? "
          + " and tick.t_clientid !=-1 and tick.t_dealid = gr.t_docid and tick.t_bofficekind in (101) "
          + " and ac.t_state = 1 and ac.t_accnum = 3 "
          + " AND ac2.t_grdealid = ac.t_grdealid and ac2.t_state = 2 and ac2.t_accnum = 1 and ac.t_grdealid = gr.t_id "
          + " group by gr.t_plandate ";

    Select = DL_RSDCommand(Query);
    Select.AddParam(Date());
    Select.AddParam(Date()-10);
    DataSet = Select.Execute(Query);
    while(DataSet.MoveNext())
        commdate = date(sql_convtypedate(DataSet.plandate));
        If(commdate<={curdate})

   	   If(SC_InAccountingExecOp(commdate, 1, 1, 1/*1-клиенские, 0-собственные*/, @documentid) != 0)
 	      err = err+1;
 	   end;
 	end;

    end;

    If(err != 0)

       v_email_processor.m_set_msg_head("Ошибка при выполнении автоматической операции ВУ");
       v_email_processor.m_add_email_to_list("SOFR-SUP@rshb.ru");
       v_email_processor.m_add_row_to_msg_text("Это сообщение отправлено автоматически.\nОшибка по операции РОВУ.\n Зайдите в список СО Внутренний учет " );

       //SetRSTrace(true);

       /* Сохраняем текст письма для отправки плановой процедурой */
       v_email_processor.m_save_to_submit();
       /* Отправляем все не отправленные письма */
       v_email_processor.m_submit_email();

    end;

End;

exit(1);