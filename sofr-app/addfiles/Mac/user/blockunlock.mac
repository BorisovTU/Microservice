import dlutils;

macro BlockByDlContrObj(dlcontrObj, blckDt)
  var stat = 0;
  if (dlcontrObj.rec.dlcontrid > 0)
    ConnectObjAttr(stat, OBJTYPE_BROKERCONTR_DL, UniID(dlcontrObj, OBJTYPE_BROKERCONTR_DL), 1/*Блокировка*/, 1/*Да*/, null, null, blckDt);
  end;
end;

macro DeBlockByDlContrObj(dlcontrObj, blckDt)
  var stat = 0;
  if (dlcontrObj.rec.dlcontrid > 0)
    DisconnectObjAttr(OBJTYPE_BROKERCONTR_DL,  UniID(dlcontrObj, OBJTYPE_BROKERCONTR_DL),1/*Блокировка*/ );
  end;
end;

macro BlockBySfContrId(sfcontrId, blckDt)
  var dlcontr = TBFile("dlcontr.dbt", "R", 1);
  dlcontr.rec.SfContrID = sfcontrId;
  if (dlcontr.GetEQ())
    BlockByDlContrObj(dlcontr, blckDt);
  end;
end;

macro BlockByDlContrId(dlcontrid, blckDt)
  var dlcontr = TBFile("dlcontr.dbt", "R", 0);
  dlcontr.rec.DlContrID = dlcontrid;
  if (dlcontr.GetEQ())
    BlockByDlContrObj(dlcontr, blckDt);
  end;
end;

macro DeBlockBySfContrId(sfcontrId)
  var dlcontr = TBFile("dlcontr.dbt", "R", 1);
  dlcontr.rec.SfContrID = sfcontrId;
  if (dlcontr.GetEQ())
    DeBlockByDlContrObj(dlcontr);
  end;
end;

macro DeBlockByDlContrId(dlcontrid)
  var dlcontr = TBFile("dlcontr.dbt", "R", 0);
  dlcontr.rec.DlContrID = dlcontrid;
  if (dlcontr.GetEQ())
    DeBlockByDlContrObj(dlcontr);
  end;
end;

macro FindSfContrIdByNumber(number)
  var result = -1;
  var sfcontr = TBfile("sfcontr.dbt", "R", 8);
  sfcontr.rec.number = number;
  if (sfcontr.GetEQ())
    result = sfcontr.rec.ID;
  end;
  return result;
end;

macro FindDlContrIdByEkk(number)
  var result = -1;
  var query =  
    " SELECT T_OBJECTID "
   +"   FROM DDLOBJCODE_DBT code "
   +"  WHERE     code.t_code = ? "
   +"        AND T_CODEKIND = 1 "
   +"        AND T_BANKCLOSEDATE = TO_DATE ('01.01.0001', 'DD.MM.YYYY') ";
  var cmd = DL_RSDCommand(query);
  cmd.AddParam(number);
  var dataSet = cmd.Execute();
  if (dataSet.MoveNext())
    result = dataSet.ObjectId;
  end;
  return result;  
end;

macro ExecBlockByNumber()
  var filePath = "";
  if (not SelectFile ( FilePath, "*.csv", "Выберите файл со списком номеров ДБО", 0, false ))
    return;
  end;

  var enc = "rsansi";
 
  var blockDate = {curdate};
  if (not GetDate(blockDate,"Введите дату блокировки"))
    return;
  end;

  if (not GetString(enc,"Введите кодировку файла"))
    return;
  end;

  var fileEkk = TStreamDoc (FilePath, "R", enc);

  var curLine = "";

  while (fileEkk.ReadLine(@curLine))
    var sfContrId = FindSfContrIdByNumber(Trim(curLine));
    if (sfContrId > 0)
      BlockBySfContrId(sfContrId, blockDate);
      println("Блокировка для договора " + Trim(curLine) + " выполнена.");
    else
      println("Не найдено ДБО с номером " + Trim(curLine) + ".");
    end;
  end;
end;

macro ExecBlockByEKK()
  var filePath = "";
  if (not SelectFile ( FilePath, "*.csv", "Выберите файл со списком ЕКК", 0, false ))
    return;
  end;

  var enc = "rsansi";
 
  var blockDate = {curdate};
  if (not GetDate(blockDate,"Введите дату блокировки"))
    return;
  end;

  if (not GetString(enc,"Введите кодировку файла"))
    return;
  end;

  var fileEkk = TStreamDoc (FilePath, "R", enc);

  var curLine = "";

  while (fileEkk.ReadLine(@curLine))
    var dlContrId = FindDlContrIdByEkk(Trim(curLine));
    if (dlContrId > 0)
      BlockByDlContrId(dlContrId, blockDate);
      println("Блокировка для ЕКК " + Trim(curLine) + " выполнена.");
    else
      println("Не найдено ДБО с ЕКК " + Trim(curLine) + ".");
    end;
  end;
end;

macro ExecDeBlockByNumber()
  var filePath = "";
  if (not SelectFile ( FilePath, "*.csv", "Выберите файл со списком номеров ДБО", 0, false ))
    return;
  end;

  var enc = "rsansi";
 
  if (not GetString(enc,"Введите кодировку файла"))
    return;
  end;

  var fileEkk = TStreamDoc (FilePath, "R", enc);

  var curLine = "";

  while (fileEkk.ReadLine(@curLine))
    var sfContrId = FindSfContrIdByNumber(Trim(curLine));
    if (sfContrId > 0)
      DeBlockBySfContrId(sfContrId);
      println("Разблокировка для договора " + Trim(curLine) + " выполнена.");
    else
      println("Не найдено ДБО с номером " + Trim(curLine) + ".");
    end;
  end;
end;

macro ExecDeBlockByEKK()
  var filePath = "";
  if (not SelectFile ( FilePath, "*.csv", "Выберите файл со списком ЕКК", 0, false ))
    return;
  end;

  var enc = "rsansi";
 
  if (not GetString(enc,"Введите кодировку файла"))
    return;
  end;

  var fileEkk = TStreamDoc (FilePath, "R", enc);

  var curLine = "";

  while (fileEkk.ReadLine(@curLine))
    var dlContrId = FindDlContrIdByEkk(Trim(curLine));
    if (dlContrId > 0)
      DeBlockByDlContrId(dlContrId);
      println("Разблокировка для ЕКК " + Trim(curLine) + " выполнена.");
    else
      println("Не найдено ДБО с номером " + Trim(curLine) + ".");
    end;
  end;
end;

macro ExecProcedure()
  var arr = TArray();
  arr[arr.size] = "Блокировка по списку с номерами ДБО";
  arr[arr.size] = "Блокировка по списку ЕКК";
  arr[arr.size] = "Разблокировка по списку с номерами ДБО";
  arr[arr.size] = "Разблокировка по списку ЕКК";
  var choose = Menu(arr, " ~Esc~ Выход  ~Enter~ Выбор", "Выберите действие");
  if (choose == 0)
    ExecBlockByNumber();
  elif (choose == 1)
    ExecBlockByEKK();
  elif (choose == 2)
    ExecDeBlockByNumber();
  elif (choose == 3)
    ExecDeBlockByEKK();
  end;
end;

ExecProcedure();