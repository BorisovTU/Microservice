import "sp_car.mac";
Private Macro AddRepoNote  ()

    Var cmd, DataSet, tick, FD, RepoNum = "", NextNum = 0; 

    var Query = " select tick.* from ddl_tick_dbt tick where tick.t_clientid = -1 and tick.t_bofficekind = 101 and tick.t_dealstatus = 10 " +
                " and rsb_secur.DealIsRepo(tick.t_dealid) != 0 "
                " and rsb_secur.IsBasket(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))!=1/* and tick.t_dealid = 159383*/"; 
    Cmd = DL_RSDCommand(Query);

    DataSet = Cmd.Execute();

    while(DataSet.MoveNext())
       FD = SpFirstDoc(LEG_KIND_DL_TICK, DataSet.dealid);
       RepoNum = "";
       NextNum = 0;
       RepoNum = ReadNoteForObject(OBJTYPE_SECDEAL, UniID(FD.tick,OBJTYPE_SECDEAL), 205);
       If(RepoNum == "")
          NextNum = Substr(FD.tick.rec.dealcode, strlen(FD.tick.rec.dealcode)-5);
          AddNoteForObject(OBJTYPE_SECDEAL, UniID(FD.tick,OBJTYPE_SECDEAL), 205, string(NextNum));
       end;

    end;


     Query = " select tick.* from ddl_tick_dbt tick where tick.t_clientid = -1 and tick.t_bofficekind = 101 and tick.t_dealstatus = 10 " +
                " and rsb_secur.DealIsRepo(tick.t_dealid) != 0 "
                " and rsb_secur.IsBasket(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1/* and tick.t_dealid = 159383*/"; 
    Cmd = DL_RSDCommand(Query);

    DataSet = Cmd.Execute();

    while(DataSet.MoveNext())
       FD = SpFirstDoc(LEG_KIND_DL_TICK, DataSet.dealid);
       RepoNum = "";
       NextNum = 0;
       RepoNum = ReadNoteForObject(OBJTYPE_SECDEAL, UniID(FD.tick,OBJTYPE_SECDEAL), 205);
       If(RepoNum == "")
          NextNum = FD.tick.rec.dealid;
          AddNoteForObject(OBJTYPE_SECDEAL, UniID(FD.tick,OBJTYPE_SECDEAL), 205, string(NextNum));
       end;

    end;


End;


AddRepoNote();