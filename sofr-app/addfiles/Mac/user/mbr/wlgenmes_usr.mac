/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 6.20                     */
/****************************************************************************/
/*                  Подсистема "Межбанковские расчеты"                      */
/*         Общие вспомогательные функции для генерации сообщений            */
/*                                                                          */
/*  Создан:  07.03.19                                   Рогалев А.А. (Rogl) */
/****************************************************************************/

import "wlglobal.mac", oralib, "wltools.mac", "bnk_ptlib.mac", RsbDataSet, PTInter;/*PNV*/

var Account_for_mt = "ACC YOUR INSTRUCTIONS";
record Account (account);

/*MDA 29.03.2019*/
record Acc399 (account);
/*MDA 29.03.2019*/

private var BankName; 
private var BankNameCorr; 
private var SwiftBankCode; 
private var SwiftBankCodeCorr; 
private var BicBankCode;
private var BicBankCodeCorr;
private var CorschemCorracc;
private var CorschemCorraccSetacc;/*PNV*/
private var CorschemBankID;

/*PNV*/
PRIVATE MACRO IsCorschem_LORO (corrid, FIid)

        FILE crs(corschem) key 1;
        crs.Number  = corrid;
        crs.FI_Kind = 1;
        crs.FIid = FIid;
        if( getEQ(crs) )
            if (crs.ISNOSTRO == SET_CHAR)
                return false;
            else
                return true;
            end;
        else
            return false;
        end;
END;
/*PNV*/ 

/*MDA 29.03.2019*/
/*Получим счет для случая продажи и если он Лоро и открыт в нашем банке*/
macro GetAccBnSale(fd)
  var query="",rsbQuery,bntype = 0;
  var retAcc = "";

  if (fd.nFI.rec.fiid != fd.nFI.rec.pricefiid)
    if( (not fd.IsExistAccount("+Форвард, расчеты", null, true, FIROLE_FIREQ, Acc399, null, fd.deal.rec.date, fd.nFi.rec.pricefiid)) and
      (not fd.OpenAccount("+Форвард, расчеты", null, false, FIROLE_FIREQ, Acc399, fd.deal.rec.date, fd.nFi.rec.pricefiid)) )
        RunError("|Ошибка при определении счета по категории '+Форвард, расчеты'");
    end;
    retAcc = Acc399.Account;
  else
    query = "SELECT g.t_attrid FROM dobjatcor_dbt g WHERE g.t_objecttype = 148 AND g.t_groupid = 202 AND g.t_object = lpad("+fd.deal.rec.id+", 34, '0')";
    rsbQuery = TRsbDataSet(query);
    if (rsbQuery.MoveNext())
      bntype = rsbQuery.attrid;
    end;

    if (bntype == 1) //предпоставка
      if( (not fd.IsExistAccount("-Незавершенные", null, true, null, Acc399, null, fd.deal.rec.date, fd.nFi.rec.pricefiid)) and
      (not fd.OpenAccount("-Незавершенные", null, false, null, Acc399, fd.deal.rec.date, fd.nFi.rec.pricefiid)) )
        RunError("|Ошибка при определении счета по категории '-Незавершенные'");
      end;
      retAcc = Acc399.Account;
    elif (bntype == 2) //предоплата
      if( (not fd.IsExistAccount("+Незавершенные", null, true, null, Acc399, null, fd.deal.rec.date, fd.nFi.rec.pricefiid)) and
      (not fd.OpenAccount("+Незавершенные", null, false, null, Acc399, fd.deal.rec.date, fd.nFi.rec.pricefiid)) )
        RunError("|Ошибка при определении счета по категории '+Незавершенные'");
      end;
      retAcc = Acc399.Account;
    end;
  end;
  return retAcc;
end;
/*MDA 29.03.2019*/

/*Имя банка на латиннице*/
macro GetPartyName(PartyID):string
    var rsbQuery,querystr = "";
    if ( partyID == -1)
        return "";
    end;
    querystr = "select  a.t_name, a.t_latname, nvl(b.t_institutionname, chr(1))"+ 
              "from dparty_dbt a "+ 
              "left join dptbicdir_dbt b on b.t_partyID = a.t_PartyID "+
              "where a.t_PartyID = "+partyID;  
    rsbQuery = TRsbDataSet(querystr);
    if (rsbQuery.MoveNext())
        if (rsbQuery.value(2) != "")
            return rsbQuery.value(2)
        elif (rsbQuery.Latname != "");
            return rsbQuery.LatName;   
        else
            return rsbQuery.Name;
        end;
    end;  
    return "";
end;

/*Код субъекта*/
macro GetParty_Code(partyID, CodeKind):string
   var rsbQuery,querystr = "";
   if ( partyID == -1)
      return "";
   end;
   querystr = "select pc.t_Code, pc.t_State   "+ 
              "from dpartcode_dbt pc          "+ 
              "where pc.t_PartyID = "+partyID +  
              "and pc.t_CodeKind = "+CodeKind;
   rsbQuery = TRsbDataSet(querystr);
   if (rsbQuery.MoveNext())
     return rsbQuery.Code;
   end;
   return ""; 
end;

/*Номер телефона банка*/
macro GetPartyPhoneNumber(partyID):string
  var PhoneNumber : string = "";
  FindAdressContactValue(PartyID, PTADDR_LEGAL, CNTADR_PHONENUMBER, PhoneNumber);
  if (PhoneNumber == "")
    FindAdressContactValue(PartyID, PTADDR_REAL, CNTADR_PHONENUMBER, PhoneNumber);
  elif (PhoneNumber == "")
    FindAdressContactValue(PartyID, PTADDR_POST, CNTADR_PHONENUMBER, PhoneNumber);
  end;
  return PhoneNumber;

end;

/*находит корсчет по ИД котрагента*/
macro FindCorrAcc(partyID):string
   var rsbQuery,querystr = "";
   if ( partyID == -1)
      return "";
   end; 
   querystr = "select  t_coraccount           "+ 
              "from dcorschem_dbt a           "+ 
              "where a.t_corrid = "+partyID;  
   rsbQuery = TRsbDataSet(querystr);
   if (rsbQuery.MoveNext())
        return rsbQuery.coraccount;  
   end;  
   return "";

end;

macro getCorrSchemInfo ( corschem_id, fiid ) /*PNV 513524*/
    Var sql = execSqlSelect ( " select sch.t_coraccount, sch.t_corrid from dcorschem_dbt sch where sch.t_number = :1 and t_fiid = :2 ", makeArray (sqlParam ("1", corschem_id), sqlParam ("2", fiid) )); /*PNV 513524*/
    if (sql.movenext ())
        CorschemCorracc = sql.value (0);
        CorschemBankID  = sql.value (1);
    else 
        CorschemCorracc = "";
        CorschemBankID  = -1;
    end;
end;

macro Записать_информацию_о_получателе (mt, str:@string, p_Payment) //Заполняется информация по получателю: банк, код банка, корсчет, счет, инн, банк-посредник, код банка-посредника
    //Общий подход для исходящих платежей:
        //Цель: сообщить контрагенту, по каким реквизитам мы перечисляем деньги
        //Вся эта информация берется из платежа, при этом реквизиты банка-получателя из корсхемы не участвуют в сообщении, в корсхеме может быть другой банк-получателя !!
        //Для платежей в валюте:
            //Заполняется информация банк-получатель(НЕ наш банк), его SWIFT-код, счет получателя в банке-получателе
            //Если есть банк-посредник, то он указывается в реквизитах с тегом VIA
        //Особенности платежей в рублях:
            //В случае, если банк-получателя является резидентом РФ, то:
            //   в качестве кода банка-получателя указывается его БИК и дополнительно корсчет в ЦБРФ и ИНН получателя. Банка-посредника в этом случае не может быть.
            //В случае, если банк-получателя является НЕрезидентом РФ, то:
            //   в качестве кода банка-получателя указывается его название и SWIFT-код, другие реквизиты не указываются.

    //Общий подход для входящих платежей:
        //Цель: сообщить контрагенту, по каким реквизитам необходимо перечислить деньги в наш банк
        //Для платежей в валюте:
            //В качестве банка-получателя указывается название банка-плательщика из корсхемы, его SWIFT-код и наш корсчет в банке-плательщике.
            //Читается так: нужно перечислить деньги на наш корсчет в таком-то банке
            //Если есть банк-посредник, то он указывается в реквизитах с тегом VIA
        //Для платежей в рублях:
            //В качестве кода банка-получателя указывается наш БИК, дополнительно наш корсчет в ЦБРФ, счет и ИНН получателя. Банка-посредника в этом случае не может быть.

    var pm = p_Payment.GetPM_PAYM().rec; 
    var dt = p_Payment.GetDEBET().rec; 
    var ct = p_Payment.GetCREDIT().rec; 
    var rm = p_Payment.GetPMRMPROP().rec;
    var settacc = TRecHandler("settacc"); /*PNV*/
    //msgbox(string(dt.debetcredit, ", bankcode=", dt.bankcode, ", ", ct.debetcredit, ", bankcode=",ct.bankcode));
    //msgbox(string("{Ourbank}=", {Ourbank}, ", PayerBankid=", pm.PayerBankid, ", ReceiverBankid=",pm.ReceiverBankid));

    SwiftBankCode = GetParty_Code(pm.ReceiverBankid, 6);
    BicBankCode = GetParty_Code(pm.ReceiverBankid, 3);
    BankName = GetPartyName(pm.ReceiverBankid);
    //InnBankCode = GetParty_Code(pm.ReceiverBankid, 16);
    SwiftBankCodeCorr = GetParty_Code(ct.Corrid, 6);
    BicBankCodeCorr = GetParty_Code(ct.Corrid, 3);
    BankNameCorr = GetPartyName(ct.Corrid);
    CorschemCorraccSetacc = ""; /*PNV*/

    if (pm.ReceiverBankid != {Ourbank}) 
        //исходящий платеж
        //Цель: сообщить контрагенту, по каким реквизитам мы перечисляем деньги
        //Вся эта информация берется из платежа, при этом реквизиты банка-получателя из корсхемы не участвуют в сообщении, в корсхеме может быть другой банк-получателя !!
        if (pm.BaseFIID != NATCUR)
            //Заполняется информация банк-получатель(НЕ наш банк), его SWIFT-код, счет получателя в банке-получателе
            //Если есть банк-посредник, то он указывается в реквизитах с тегом VIA
            str = str + BankName + "(SWIFT " + SwiftBankCode + ")" + SYMB_ENDL;
            str = str +  "ACC " + pm.ReceiverAccount + SYMB_ENDL;
            /*PNV i-support 501757*/ 
                if ( (mt == "MT399") and (BankNameCorr == "") and (SwiftBankCodeCorr == "") )
                    FindSETTACC_PMAUTO({Ourbank}, FIKIND_CURRENCY, pm.BaseFIID, PTSK_DV, 11080, 39, pm.ReceiverBankid, settacc);/*PNV операция-неттинг, платеж - результат неттинга*/         
                    if (settacc.rec.SettAccID > 0)
                        BankNameCorr = GetPartyName(settacc.rec.bankcorrid);
                        SwiftBankCodeCorr = GetParty_Code(settacc.rec.bankcorrid, 6);
                        CorschemCorraccSetacc = settacc.rec.corracc;
                    end;
                end;
           /*PNV i-support 501757*/
        else 
            if (mt == "MT399")/*PNV 508444 расчеты в рублях, значит пишем счет независимо от резидентства*/
                str = str +  "/" + pm.ReceiverAccount + SYMB_ENDL; 
                str = str +  "BIC " + BicBankCode + SYMB_ENDL; 
                str = str +  "CA " +  rm.ReceiverCorrAccNostro + SYMB_ENDL;
                str = str +  "INN " + rm.ReceiverINN + SYMB_ENDL; 

            /*MDA 29.03.2019 На резидентность нужно проверять контрагента , а не его банк!*/
            elif (PartyIsNotResident(pm.Receiver))
                //В случае, если банк-получателя является НЕрезидентом РФ, то:
                //   в качестве кода банка-получателя указывается его название и SWIFT-код, другие реквизиты не указываются.
                str = str + BankName + " (SWIFT " + SwiftBankCode + ")" + SYMB_ENDL;
                //str = str +  "ACC " + pm.ReceiverAccount + SYMB_ENDL;
            else
                //В случае, если банк-получателя является резидентом РФ, то:
                //   в качестве кода банка-получателя указывается его БИК и дополнительно корсчет в ЦБРФ и ИНН получателя. Банка-посредника в этом случае не может быть.
                str = str +  "/" + pm.ReceiverAccount + SYMB_ENDL; 
                str = str +  "BIC " + BicBankCode + SYMB_ENDL; 
                str = str +  "CA " +  rm.ReceiverCorrAccNostro + SYMB_ENDL;
                str = str +  "INN " + rm.ReceiverINN + SYMB_ENDL; 
            end;
        end;
        if (mt=="MT399")
           if ( (BankNameCorr != "") and (SwiftBankCodeCorr!= "") )
              str = str + "VIA " + BankNameCorr + "(SWIFT " + SwiftBankCodeCorr;
              /*PNV i-support 501757*/ 
             if (CorschemCorraccSetacc != "")
                  str = str + " acc." + CorschemCorraccSetacc;
             end;
             str = str + ")" + SYMB_ENDL;
             /*PNV i-support 501757*/ 
          end;
        end;
    else 

        //получатель платежа - наш банк
        //Цель: сообщить контрагенту, по каким реквизитам необходимо перечислить деньги в наш банк
        if (pm.BaseFIID != NATCUR)
            if (pm.PayerBankid != {Ourbank}) //входящий внешний платеж
                //В качестве банка-получателя указывается название банка-плательщика из корсхемы, его SWIFT-код и наш корсчет в банке-плательщике.
                //Читается так: нужно перечислить деньги на наш корсчет в таком-то банке
                //Если есть банк-посредник, то он указывается в реквизитах с тегом VIA
                if (mt == "MT399") /*PNV 504607 только для 399 - если ЛОРО, для остальных - по старому*/ 
                    if ( (dt.corschem != -1) and ( not IsCorschem_LORO (dt.corschem, pm.BaseFIID) ) )  
                          getCorrSchemInfo (dt.corschem, pm.BaseFIID);  /*PNV 513524*/       
                          SwiftBankCode = GetParty_Code(CorschemBankID, 6);
                          BankName = GetPartyName(CorschemBankID);
                          str = str + BankName + "(SWIFT " + SwiftBankCode + ")" + SYMB_ENDL; 
                          str = str + "ACC " + CorschemCorracc + SYMB_ENDL; 
                    else 
                          SwiftBankCode = GetParty_Code(pm.ReceiverBankid, 6);
                          BankName = GetPartyName(pm.ReceiverBankid);
                          str = str + BankName + "(" + SwiftBankCode + ")" + SYMB_ENDL; 
                          str = str + "ACC " + pm.ReceiverAccount + SYMB_ENDL;                     
                    end; 
                else /*PNV 504607*/
                     getCorrSchemInfo (dt.corschem, pm.BaseFIID); /*PNV 513524*/       
                     SwiftBankCode = GetParty_Code(CorschemBankID, 6);
                     BankName = GetPartyName(CorschemBankID);
                     str = str + BankName + "(SWIFT " + SwiftBankCode + ")" + SYMB_ENDL; 
                     str = str + "ACC " + CorschemCorracc + SYMB_ENDL; 
                 end;
                /*PNV i-support 501757*/ 
                if ( (mt == "MT399") and (BankNameCorr == "") and (SwiftBankCodeCorr == "") )
                    FindSETTACC_PMAUTO({Ourbank}, FIKIND_CURRENCY, pm.BaseFIID, PTSK_DV, 11080, 39, pm.PayerBankid, settacc);/*PNV операция-неттинг, платеж - результат неттинга*/         
                    if (settacc.rec.SettAccID > 0)
                        BankNameCorr = GetPartyName(settacc.rec.bankcorrid);
                        SwiftBankCodeCorr = GetParty_Code(settacc.rec.bankcorrid, 6);
                        CorschemCorraccSetacc = settacc.rec.corracc;
                    end;
                end;
               /*PNV i-support 501757*/
            else //внутрибанковский платеж
                //В качестве банка-получателя указывается название банка-плательщика из корсхемы, его SWIFT-код и наш корсчет в банке-плательщике.
                //Читается так: нужно перечислить деньги на наш корсчет в таком-то банке
                //Если есть банк-посредник, то он указывается в реквизитах с тегом VIA

                /*PNV i-support 497369 - новые требования. При расчетам внутри банка  должен указываться свифт и наименование Россельхозбанка
                 А также должны проставляться счета контрагента (их лоросчета у нас, если они получают на свои счета в РСХБ).
                 И наши счета 47408* на который контрагент должен поставить средтсва.
                */
                if ((dt.corschem != -1) and ( (pm.PayerBankid != {Ourbank}) and (pm.ReceiverBankid != {Ourbank}) ) )  /*PNV i-support 497369*/  
                    getCorrSchemInfo (dt.corschem, pm.BaseFIID); /*PNV 513524*/       
                    SwiftBankCode = GetParty_Code(CorschemBankID, 6);
                    BankName = GetPartyName(CorschemBankID);
                    str = str + BankName + "(SWIFT " + SwiftBankCode + ")" + SYMB_ENDL; 
                    str = str + "ACC " + CorschemCorracc + SYMB_ENDL; 
                else
                    SwiftBankCode = GetParty_Code(pm.PayerBankid, 6);
                    BankName = GetPartyName(pm.PayerBankid);
                    str = str + BankName + "(" + SwiftBankCode + ")" + SYMB_ENDL; 
                    str = str + "ACC " + pm.ReceiverAccount + SYMB_ENDL;                     
                end; 
            end;
        else
            //В качестве кода банка-получателя указывается наш БИК, дополнительно наш корсчет в ЦБРФ, счет и ИНН получателя. Банка-посредника в этом случае не может быть.
            //str = str +  {Name_Bank} + SYMB_ENDL;
            str = str +  "/" + Account_for_mt + SYMB_ENDL; 
            str = str +  "BIC " + {MFO_Bank} + SYMB_ENDL; 
            str = str +  "CA " + {CORAC_Bank} + SYMB_ENDL; 
            str = str +  "INN " + {INN_Bank} + SYMB_ENDL; 
        end;
        if (mt=="MT399")
          if ( (BankNameCorr != "") and (SwiftBankCodeCorr!= "") )
              str = str + "VIA " + BankNameCorr + "(SWIFT " + SwiftBankCodeCorr;
              /*PNV i-support 501757*/ 
             if (CorschemCorraccSetacc != "")
                  str = str + " acc." + CorschemCorraccSetacc;
             end;
             str = str + ")" + SYMB_ENDL;
             /*PNV i-support 501757*/ 
          end;
        end;
    end;
    
    /*  Очень сомнительная добавка, пока забанил
     if ( (SubStr(pm.PayerAccount,1,5)== "30109") or (SubStr(pm.PayerAccount,1,5)== "30111"))
       field_value = field_value +  "FROM YOUR ACC " + pm.PayerAccount + SYMB_ENDL;
    end;
    */
        
end; //Записать_информацию_о_получателе


macro Записать_информацию_о_получателе_MT36X (str:@string, p_Payment) //Заполняется информация по получателю: банк, код банка, корсчет, счет, инн, банк-посредник, код банка-посредника
    //Общий подход для исходящих платежей:
        //Цель: сообщить контрагенту, по каким реквизитам мы перечисляем деньги
        //Вся эта информация берется из платежа, при этом реквизиты банка-получателя из корсхемы не участвуют в сообщении, в корсхеме может быть другой банк-получателя !!
        //Для платежей в валюте:
            //Заполняется информация банк-получатель(НЕ наш банк), его SWIFT-код, счет получателя в банке-получателе
            //Если есть банк-посредник, то он указывается в реквизитах с тегом VIA
        //Особенности платежей в рублях:
            //В случае, если банк-получателя является резидентом РФ, то:
            //   в качестве кода банка-получателя указывается его БИК и дополнительно корсчет в ЦБРФ и ИНН получателя. Банка-посредника в этом случае не может быть.
            //В случае, если банк-получателя является НЕрезидентом РФ, то:
            //   в качестве кода банка-получателя указывается его название и SWIFT-код, другие реквизиты не указываются.

    //Общий подход для входящих платежей:
        //Цель: сообщить контрагенту, по каким реквизитам необходимо перечислить деньги в наш банк
        //Для платежей в валюте:
            //В качестве банка-получателя указывается название банка-плательщика из корсхемы, его SWIFT-код и наш корсчет в банке-плательщике.
            //Читается так: нужно перечислить деньги на наш корсчет в таком-то банке
            //Если есть банк-посредник, то он указывается в реквизитах с тегом VIA
        //Для платежей в рублях:
            //В качестве кода банка-получателя указывается наш БИК, дополнительно наш корсчет в ЦБРФ, счет и ИНН получателя. Банка-посредника в этом случае не может быть.

    var pm = p_Payment.GetPM_PAYM().rec; 
    var dt = p_Payment.GetDEBET().rec; 
    var ct = p_Payment.GetCREDIT().rec; 
    var rm = p_Payment.GetPMRMPROP().rec; 

    str = "";

    SwiftBankCode = GetParty_Code(pm.ReceiverBankid, 6);
    BicBankCode = GetParty_Code(pm.ReceiverBankid, 3);
    BankName = GetPartyName(pm.ReceiverBankid);
    //InnBankCode = GetParty_Code(pm.ReceiverBankid, 16);
    SwiftBankCodeCorr = GetParty_Code(ct.Corrid, 6);
    BicBankCodeCorr = GetParty_Code(ct.Corrid, 3);
    BankNameCorr = GetPartyName(ct.Corrid);

    if (pm.ReceiverBankid != {Ourbank}) 
        //исходящий платеж
        //Цель: сообщить контрагенту, по каким реквизитам мы перечисляем деньги
        //Вся эта информация берется из платежа, при этом реквизиты банка-получателя из корсхемы не участвуют в сообщении, в корсхеме может быть другой банк-получателя !!
        if (pm.BaseFIID != NATCUR)
            //Заполняется информация банк-получатель(НЕ наш банк), его SWIFT-код, счет получателя в банке-получателе
            //Если есть банк-посредник, то он указывается в реквизитах с тегом VIA
            if(CorschemCorracc)
              str = str + ":57A:/" + CorschemCorracc + SYMB_ENDL; 
              str = str + SwiftBankCode; 
            else
              str = str + ":57A:/" + IIF(SwiftBankCode == -1, {Ourbank}, SwiftBankCode); 
            end;

        else 
            if (PartyIsNotResident(pm.ReceiverBankid))
                //В случае, если банк-получателя является НЕрезидентом РФ, то:
                //   в качестве кода банка-получателя указывается его название и SWIFT-код, другие реквизиты не указываются.
                if(CorschemCorracc)
                  str = str + ":57A:/" + CorschemCorracc + SYMB_ENDL; 
                  str = str + SwiftBankCode; 
                else
                  str = str + ":57A:/" + IIF(SwiftBankCode == -1, {Ourbank}, SwiftBankCode); 
                end;
            else
                //В случае, если банк-получателя является резидентом РФ, то:
                //   в качестве кода банка-получателя указывается его БИК и дополнительно корсчет в ЦБРФ и ИНН получателя. Банка-посредника в этом случае не может быть.
                str = str + ":57D:/" + pm.ReceiverAccount + SYMB_ENDL; 
                str = str + "BIC " + BicBankCode + SYMB_ENDL; 
                str = str + "CA " +  rm.ReceiverCorrAccNostro + SYMB_ENDL;
                str = str + "INN " + rm.ReceiverINN; 
            end;
        end;
    else 

        //получатель платежа - наш банк
        //Цель: сообщить контрагенту, по каким реквизитам необходимо перечислить деньги в наш банк
        if (pm.BaseFIID != NATCUR)
            if (pm.PayerBankid != {Ourbank}) //входящий внешний платеж
                //В качестве банка-получателя указывается название банка-плательщика из корсхемы, его SWIFT-код и наш корсчет в банке-плательщике.
                //Читается так: нужно перечислить деньги на наш корсчет в таком-то банке
                //Если есть банк-посредник, то он указывается в реквизитах с тегом VIA
                getCorrSchemInfo (dt.corschem, pm.BaseFIID); /*PNV 513524*/       
                SwiftBankCode = GetParty_Code(CorschemBankID, 6);
                BankName = GetPartyName(CorschemBankID);
                if(CorschemCorracc)
                  str = str + ":57A:/" + CorschemCorracc + SYMB_ENDL; 
                  str = str + SwiftBankCode; 
                else
                  str = str + ":57A:/" + IIF(SwiftBankCode == -1, {Ourbank}, SwiftBankCode); 
                end;
            else //внутрибанковский платеж
                //В качестве банка-получателя указывается название банка-плательщика из корсхемы, его SWIFT-код и наш корсчет в банке-плательщике.
                //Читается так: нужно перечислить деньги на наш корсчет в таком-то банке
                //Если есть банк-посредник, то он указывается в реквизитах с тегом VIA
                getCorrSchemInfo (dt.corschem, pm.BaseFIID); /*PNV 513524*/       
                SwiftBankCode = GetParty_Code(CorschemBankID, 6);
                BankName = GetPartyName(CorschemBankID);
                if(CorschemCorracc)
                  str = str + ":57A:/" + CorschemCorracc + SYMB_ENDL; 
                  str = str + SwiftBankCode; 
                else
                  str = str + ":57A:/" + IIF(SwiftBankCode == -1, {Ourbank}, SwiftBankCode); 
                end;
            end;
        else
            //В качестве кода банка-получателя указывается наш БИК, дополнительно наш корсчет в ЦБРФ, счет и ИНН получателя. Банка-посредника в этом случае не может быть.
            //str = str +  {Name_Bank} + SYMB_ENDL;
            str = str + ":57D:/" + Account_for_mt + SYMB_ENDL; 
            str = str + "BIC " + {MFO_Bank} + SYMB_ENDL; 
            str = str + "CA " + {CORAC_Bank} + SYMB_ENDL; 
            str = str + "INN " + {INN_Bank}; 
        end;
    end;
end; //Записать_информацию_о_получателе_MT36X

