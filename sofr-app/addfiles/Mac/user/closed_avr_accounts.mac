import rsd;
import or_rep_h, globals, oralib, likepy;
import fiinter;
import "sp_categ.mac";
import RsbFormsInter;


var format_line = "c:ex_B(tblr):ex_FS()";
var format_head = "c:ex_FS(b):ex_B(tblr)";

macro createReport(date_begin, date_end)
    var query =
    "   SELECT DISTINCT mc.t_account,                                        " +
    "                   categ.t_code,                                        " +
    "                   categ.t_name cat,                                    " +
    "                   avr.t_fiid,                                          " +
    "                   avr.t_isin,                                          " +
    "                   avr.t_lsin,                                          " +
    "                   fin.t_fi_code,                                       " +
    "                   avrkind.t_name avrkindname,                          " +
    "                   fin.t_name avrname,                                  " +
    "                   fin.t_definition,                                    " +
    "                   fin.t_drawingdate,                                   " +
    "                   RSB_ACCOUNT.RESTAC (acnt.t_account,                  " +
    "                                       acnt.t_code_currency,            " +
    "                                       TRUNC (SYSDATE),                 " +
    "                                       acnt.t_chapter,                  " +
    "                                       0)                               " +
    "                      accrest                                           " +
    "     FROM dfininstr_dbt fin                                             " +
    "          INNER JOIN davoiriss_dbt avr                                  " +
    "             ON avr.t_fiid = fin.t_fiid AND avr.t_spisclosed = CHR (88) " +
    "          INNER JOIN dmcaccdoc_dbt mc                                   " +
    "             ON mc.t_fiid = avr.t_fiid AND t_chapter != 5               " +
    "          INNER JOIN dmccateg_dbt categ ON categ.t_id = mc.t_catid      " +
    "          INNER JOIN daccount_dbt acnt                                  " +
    "             ON     acnt.t_account = mc.t_account                       " +
    "                AND acnt.t_code_currency = mc.t_currency                " +
    "                AND acnt.t_chapter = mc.t_chapter                       " +
    "                AND acnt.t_open_close = CHR (0)                         " +
    "          INNER JOIN davrkinds_dbt avrkind                              " +
    "             ON     avrkind.t_fi_kind = fin.t_fi_kind                   " +
    "                AND avrkind.t_avoirkind = fin.t_avoirkind               " +
    "    WHERE fin.t_fi_kind = 2                                             " +
    " ORDER BY avr.t_fiid, categ.t_code                                      ";
    var cmd = DL_RSDCommand(query);
/*
        cmd.AddParam(date_begin);
        cmd.AddParam(date_end); 
*/        
    var Rep = CMakeReport();

    Rep.SetDefaultFontName("Times New Roman");
    Rep.SetDefaultFontSize(10);
    Rep.SetFlagShowGrid(true);

    Rep.AddPrintCell(" ", 10, 0, "c:ex_FS(b):ex_B()");
    Rep.AddStr();

    Rep.SetExecute("iBook.Sheets(1).Rows(2).WrapText = false;");
    Rep.SetExecute("iBook.Sheets(1).range(\"A2:G2\").Merge;");
    Rep.AddPrintCell("Открытые счета по закрытым бумагам", 10, 0, "c:ex_FS(b):ex_B()");
    Rep.AddStr();

    Rep.AddPrintCell(" ", 10, 0, "c:ex_FS(b):ex_B()");
    Rep.AddStr();

    Rep.AddPrintCell("Счет", 21, null, format_head);
    Rep.AddPrintCell("Категория учета", 50, null, format_head);
    Rep.AddPrintCell("Название КУ", 40, null, format_head);
    Rep.AddPrintCell("Остаток", 10, null, format_head);
    Rep.AddPrintCell("id бумаги", 10, null, format_head);
    Rep.AddPrintCell("Код бумаги", 10, null, format_head);
    Rep.AddPrintCell("ISIN", 15, null, format_head);
    Rep.AddPrintCell("Гос. номер", 20, null, format_head);
    Rep.AddPrintCell("Тип бумаги", 30, null, format_head);
    Rep.AddPrintCell("Название бумаги", 30, null, format_head);
    Rep.AddPrintCell("Описание", 30, null, format_head);
    Rep.AddPrintCell("Дата погашения", 10, null, format_head);
    Rep.AddStr();                  

    var cnt = cmd.GetCount();
    var i = 0;    
    InitProgress(cnt, "Сбор данных", "Сбор данных");

    var sql = cmd.Execute();

    while(sql.movenext)

        Rep.AddPrintCell(sql.account, 21, null, format_line);
        Rep.AddPrintCell(sql.code, 50, null, format_line);
        Rep.AddPrintCell(sql.cat, 40, null, format_line);
        Rep.AddPrintCell(sql.accrest, 10, null, format_line);
        Rep.AddPrintCell(sql.fiid, 10, null, format_line);
        Rep.AddPrintCell(sql.fi_code, 10, null, format_line);
        Rep.AddPrintCell(sql.isin, 15, null, format_line);
        Rep.AddPrintCell(sql.lsin, 20, null, format_line);
        Rep.AddPrintCell(sql.avrkindname, 30, null, format_line);
        Rep.AddPrintCell(sql.avrname, 30, null, format_line);
        Rep.AddPrintCell(sql.definition, 30, null, format_line);
        Rep.AddPrintCell(date(sql.drawingdate), 10, null, format_line);
        Rep.AddStr();   


        UseProgress(i = i + 1);
    end;

    RemProgress();

    Rep.SetFileName("closed_avr_accounts_"+date);
    Rep.PrintWinRep("closed_avr_accounts");
    Rep.SetZoomType(ZOOM_TYPE_A4L);
    Rep.SetWinRepOutput();
    Rep.ShowWinRep();        
end;

createReport();

