/*
$Name:        ChangeTarifResult.mac
$Module:      Ценные бумаги
$Description: Макрос отчета после массовой смены тарифных планов
*/

Import cb_sql, RsbDataSet;
Var sql, cmd, BegDate;
file outfile() txt WRITE;
private CONST ENCODE = "rsansi"; //"utf8" "rsoem";

/*Дату в строку*/
private macro GetDateS(dt:date)
  var i;
  datesplit(dt, i);
  if(i < 10)
    return "0" + substr(string(dt),2);
  else
    return string(dt);
  end;
end;


   var InfoLogFileName = "..\\export\\ChangeTarifResults.csv";
   if (not Open(outfile, InfoLogFileName, encode)) 
     MsgBox("Ошибка открытия файла для записи " + InfoLogFileName);
     exit(1);
   end;

//    	SetOutput( InfoLogFileName);
If(not GetDate(BegDate, "Введите дату начала действия нового тарифа, устанавливаемую при массовой смене"))
   MsgBox("Отмена формирования результатов смены Тарифа, не указана дата");
   exit(1);
end;
sql = " select sf.t_number, sf.t_datebegin, sfplan.t_name, cplan.t_begin   from dsfcontrplan_dbt cplan, "+ 
					  " dsfcontr_dbt sf, dsfplan_dbt sfplan where cplan.t_begin = " + GetSqlDate(BegDate) + 
					  " and exists(select 1 from dsfcontrplan_dbt where t_sfcontrid = cplan.t_sfcontrid and t_begin < " + GetSqlDate(BegDate) + ")" + 
					  " and sf.t_id = cplan.t_sfcontrid and sf.t_servkind = 0 and sfplan.t_sfplanid = cplan.t_sfplanid";
cmd = TrsbDataSet(sql);

While (cmd.movenext())
  Println(cmd.number, ";", sql_convTypeDate(cmd.datebegin), ";", cmd.name, ";", sql_convTypeDate(cmd.begin));
  outfile.str = cmd.number + ";" + GetDateS(sql_convTypeDate(cmd.datebegin))+ ";"+ cmd.name+ ";"+ GetDateS(sql_convTypeDate(cmd.begin));
  Insert(outfile);

End;
 close(outfile);
//        SetOutput( NULL );
        ViewFile( outfile );
exit(1);




                      