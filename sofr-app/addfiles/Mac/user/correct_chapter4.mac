import activex, globals, rsd, oralib, likepy, CurrInter, FIInter;

const ДатаПроводки = Date("04.02.2019");

macro StartTrans()
  RslDefCon.BeginTrans();
end;

macro EndTrans(err)
  if(err)
    RslDefCon.RollbackTrans();
    println("При выполнении возникли ошибки!");
  else
    RslDefCon.CommitTrans();
    //RslDefCon.RollbackTrans();
    println("Выполнено успешно");
  end;
end;


//Перед открытием копирует файл на терминал пользователя
macro OpenExcel ()
  var FileName = "";
  var DirName = "";
  var ExtName = "";
  var TermPath = GetCurDir(true);
  var FullName;

  if(not SelectFile(FullName, "*.xls*", "Выберите файл для загрузки *", 0, true))
    MsgBox("Отказ от загрузки");
    return false;
  end;

  //Отделяем путь файла от имени
  splitfile(FullName, FileName, ExtName);
  FileName = FileName + ExtName;
  DirName = substr(FullName, 1, index(FullName, FileName) - 1);

  /*Открываем файл*/
  //BegAction(1, "Обработка файла \"" + DirName + "\\" + FileName + "\". Ждите...");

  if(not OpenExcelFile(FileName, false, true, DirName))
    MsgBox("Ошибка открытия файла \"" + DirName + "\\" + FileName + "\"");
    EndAction(1);
    return false;
  end;

  return true;
onerror()
  return false;
End;

macro GetFIIDByIso (num):integer
  var sql = ExecSqlSelect("select t_fiid from dfininstr_dbt where t_iso_number = :num", MakeArray(SqlParam("num", num)), false);
  if (sql.MoveNext() )
    return sql.value(0);
  end;
  return -1;
End;

macro ВыполнитьПроводку (debet, credit, debetsum, creditsum, debetfiid, creditfiid, ground)
  var tr;

  tr = RsbAccTransaction();

  if( tr == NULL )
    return println("Ошибка при создании проводки");
  end;

  if (valtype(ground) == V_UNDEF)
    ground = "Корректировка остатков главы Г";
  end;

  tr.Chapter         = 4;
  tr.Date_Carry      = ДатаПроводки;
  tr.Number_Pack     = 925;
  tr.Numb_Document   = "";
  //tr.ResultCarry     = 1;
  tr.Kind_Oper       = "1";
  tr.Ground          = Ground;
  tr.Department      = 1;
  tr.Oper            = {oper};
  tr.FIIDPayer       = debetfiid;
  tr.FIIDReceiver    = creditfiid;
  tr.SumPayer        = debetsum;
  tr.SumReceiver     = creditsum;
  tr.AccountPayer    = debet;
  tr.AccountReceiver = credit;
  tr.Shifr_Oper      = "9";
  //tr.UserField3      =  USF3;

  if( not tr.Carry() )
     return println("Ошибка при выполнении проводки "+debet+"<->"+credit+" Сумма дебета: "+debetsum+" Сумма кредита: "+creditsum);
  else
     println("Выполнена проводка "+debet+"<->"+credit+" \"" + Ground + "\"");
     return true;
  end;

End;

macro Start ()
  var col_account = 2;
  var col_rest = 8;
  var col_currency = 1;
  var sheet_4 = 2;
  var sheet_5 = 3;
  var row = 2; //начинаются данные со второй строки
  var rest_sofr:money;
  var rest_sofr_rub:money;
  var sheet;
  var account:string, rest:money, currency:integer;
  var sql;
  var account_debet = "99996810400006666666";
  var accoun_credit = "99997810600007777777";
  var stat;


  var query_findacc = "select 1 from daccount_dbt "
      + " where t_account = :acc "
      + " and (t_close_date >= to_date('25.03.2019', 'dd.mm.yyyy') or t_close_date = to_Date('01.01.0001', 'dd.mm.yyyy'))";

  var query_rest = "select rsi_rsb_account.RestAll(:acc, 4, :cur, sysdate/*to_Date('25.03.2019', 'dd.mm.yyyy')*/, :cur2) from dual";

  if (not OpenExcel ())
    return;
  end;

  sheet = ExcelApplication.Sheets(sheet_4);

  InitProgress(-1, "Чтение файла " , "Чтение файла..");
  StartTrans();

  while (valtype(sheet.cells(row, col_account).value) != V_UNDEF)
    account = sheet.cells(row, col_account).value;
    rest = sheet.cells(row, col_rest).value;
    currency = GetFIIDByIso(sheet.cells(row, col_currency).value);
    rest_sofr_rub = $0;

    if (rest == 0)
      UseProgress(row = row + 1);
      continue;
    end;

    //println("\nОБрабатывается счет " + account);
    //println("fiid="+currency);

    if (currency < 0) 
      println("Ошибка! Не определена валюта счета " + account);
      UseProgress(row = row + 1);
      continue;
    end;

    if (StrLen(account) != 20)
      println("Ошибка! Не верный счет " + account);
      UseProgress(row = row + 1);
      continue;
    end;

    sql = ExecSqlSelect(query_findacc, MakeArray(SqlParam("acc", account)), false);
    if (not sql.MoveNext() )
      //println("Ошибка! Счет " + account + " не создан или закрыт!");
      UseProgress(row = row + 1);
      continue;
    end;

    sql = ExecSqlSelect(query_rest, MakeArray(SqlParam("acc", account),
                                              SqlParam("cur", currency),
                                              SqlParam("cur2", currency)), false);
    if (not sql.MoveNext)
      println("Ошибка! Не найден остаток на счёте");
      UseProgress(row = row + 1);
      continue;
    end;

    rest_sofr = sql.value(0);

    if (currency != 0)
    
      stat = ConvSum (rest_sofr_rub, rest_sofr, ДатаПроводки, currency, 0);
      if (stat != 0)
        println("Не найден курс валюты " , ПолучитьКодФинИн(currency), " за ", ДатаПроводки);
        UseProgress(row = row + 1);
        continue;
      end;
    end;

    //println(rest_sofr);
    //println(rest_sofr_rub);


    if (rest_sofr < 0)
      //проводка account_debet - account
      ВыполнитьПроводку (account_debet, account, abs(rest_sofr_rub), abs(rest_sofr), 0, currency);
    elif(rest_sofr > 0)
      //проводка account - accoun_credit
      ВыполнитьПроводку (account, accoun_credit, abs(rest_sofr), abs(rest_sofr_rub), currency, 0);
    end;
  

    UseProgress(row = row + 1);
  end;

  sheet = ExcelApplication.Sheets(sheet_5);
  row = 2;

  while (valtype(sheet.cells(row, col_account).value) != V_UNDEF)
    account = sheet.cells(row, col_account).value;
    rest = sheet.cells(row, col_rest).value;
    currency = GetFIIDByIso(sheet.cells(row, col_currency).value);
    rest_sofr_rub = $0;

    if (rest == 0)
      UseProgress(row = row + 1);
      continue;
    end;

    //println("\nОБрабатывается счет " + account);
    //println("fiid="+currency);

    if (currency < 0) 
      println("Ошибка! Не определена валюта счета " + account);
      UseProgress(row = row + 1);
      continue;
    end;

    if (StrLen(account) != 20)
      println("Ошибка! Не верный счет " + account);
      UseProgress(row = row + 1);
      continue;
    end;

    sql = ExecSqlSelect(query_findacc, MakeArray(SqlParam("acc", account)), false);
    if (not sql.MoveNext() )
      //println("Ошибка! Счет " + account + " не создан или закрыт!");
      UseProgress(row = row + 1);
      continue;
    end;

    sql = ExecSqlSelect(query_rest, MakeArray(SqlParam("acc", account),
                                              SqlParam("cur", currency),
                                              SqlParam("cur2", currency)), false);
    if (not sql.MoveNext)
      println("Ошибка! Не найден остаток на счёте");
      UseProgress(row = row + 1);
      continue;
    end;

    rest_sofr = sql.value(0);

    if (currency != 0)
    
      stat = ConvSum (rest_sofr_rub, rest_sofr, ДатаПроводки, currency, 0);
      if (stat != 0)
        println("Не найден курс валюты " , ПолучитьКодФинИн(currency), " за ", ДатаПроводки);
        UseProgress(row = row + 1);
        continue;
      end;
    end;

    //println(rest_sofr);
    //println(rest_sofr_rub);


    if (rest_sofr < 0)
      //проводка account_debet - account
      ВыполнитьПроводку (account_debet, account, abs(rest_sofr_rub), abs(rest_sofr), 0, currency);
    elif(rest_sofr > 0)
      //проводка account - accoun_credit
      ВыполнитьПроводку (account, accoun_credit, abs(rest_sofr), abs(rest_sofr_rub), currency, 0);
    end;
  

    UseProgress(row = row + 1);
  end;

  EndTrans();
  ExcelApplication.ActiveWorkbook.Close;
  RemProgress();

  onerror()
    if (valtype(ExcelApplication) != V_UNDEF)
      ExcelApplication.ActiveWorkbook.Close;
    end;
    if ( rslDefCon.isInTrans() )
      rslDefCon.rollbackTrans();
    end;
    RemProgress();
End;


Start();