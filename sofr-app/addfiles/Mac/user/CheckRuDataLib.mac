import cb_sql;
import календарь;

Macro CheckRuData()

  var rs = RSDRecordset("select sysdate from dual"); // Теперь берем системное время сервера Oracle
  var CurDTTM :DateTime = dttm(Date(), Time());
  if (rs.movenext)
    CurDTTM = rs.value(0);
  end;

  var SelDate :Date; // Дата для выборки = текущая дата с учетом загрузки из РуДата в 2:30
  var CurTime :Time;

  DtTmSplit(CurDTTM, SelDate, CurTime);

  if (CurTime < time("01:00"))
    SelDate = SelDate - 1;    
  end;

  var SelBeginDTTM = dttm(SelDate,     time("01:00"));
  var SelEndDTTM   = dttm(SelDate + 1, time("01:00"));

  var cmd, mes = "" ;
  cmd = RsdCommand(" select u.t_status from utableprocessin_dbt u where    " +
                   "           u.t_objecttype = 1 " +
                   "           and u.t_timestamp between :v_begindate and :v_enddate "); //смотрим на последнее задание за текущую дату

  cmd.addParam("v_begindate", RSDBP_IN, SelBeginDTTM);
  cmd.addParam("v_enddate",   RSDBP_IN, SelEndDTTM);
  cmd.execute();
  
  rs = RsdRecordset(cmd);

  if(rs.MoveNext())
    if(rs.value("t_status") != 4)
       mes = "\nНе загружены данные из RuData за дату " + SelDate;
    end;
  else
       mes = "\nНе загружены данные из RuData за дату " + SelDate;
  end;

  if(strlen(mes)>0)
    return("Внимание!!!"+mes);
  end;
  return "";
end;
