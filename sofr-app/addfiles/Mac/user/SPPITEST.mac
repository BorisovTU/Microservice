import RsbFormsInter, Global, or_rep_h,"cb_sql.mac";

const v_specval = 26;

private macro iif(a,b,c)
      if(a)
         return b;
      else
         return c;
      end;
   end;




CLASS OfferRep(pDAte)

var Report;
var vDAte   = pDAte;

var rn = 1;
var EXCEL_MONEY = "\"# ##0,00\"";
var sheet = 1,n_sheet = 2;
var count = 0;

var col1_len = 10,  col2_len = 12, col3_len = 15;
var col4_len = 40,  col5_len = 12,  col6_len = 18;
var col7_len = 9,   col8_len = 7, col9_len = 7;
var color  = 12632256;  
var ColorD = 16316664;
var ColorL = 15395562;

var head_format = "ex_FS(b):ex_B(tblr):ex_BC(" + color + ")";
var format      = "ex_FS():ex_B(tblr):ex_BC(" + color + ")";

private macro ДобавитьСтроку()
  Report.AddStr();rn = rn + 1;
end;

private macro ДобавитьПустуюСтроку()
   Report.AddEmptyStr();rn = rn + 1;
end; 

private macro ПечатьШапки ()        

    ДобавитьПустуюСтроку();

    Report.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
    Report.SetExecute("iBook.Sheets("+sheet+").Range(\"A"+(rn)+":E"+(rn)+"\").merge;");
   
    ДобавитьСтроку();

    Report.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
    Report.SetExecute("iBook.Sheets("+sheet+").Range(\"A"+(rn)+":E"+(rn)+"\").merge;");
    Report.AddPrintCell("Список лотов по выкупам с непройденным SPPI тестом.", col1_len, null, "r:ex_FS(b):ex_B()");
    ДобавитьСтроку();

    Report.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
    Report.SetExecute("iBook.Sheets("+sheet+").Range(\"A"+(rn)+":E"+(rn)+"\").merge;");
    Report.AddPrintCell("Дата отчета: " + string(vDate):f, col1_len, null, "l:ex_FS(b):ex_B()");
    ДобавитьСтроку();

    ДобавитьПустуюСтроку();

    rn = rn - 1;    

/*1*/   Report.AddPrintCell ("ID",         col1_len,  null, "c:" + head_format);
/*2*/   Report.AddPrintCell ("Дата покупки",  col2_len,  null,"c:" + head_format);
/*2*/   Report.AddPrintCell ("Код ц/б",   col3_len,  null,"c:" + head_format);
/*4*/   Report.AddPrintCell ("Наиминование",        col4_len,  null, "c:"+ head_format);
/*5*/   Report.AddPrintCell ("ISIN",       col5_len,  null, "c:" + head_format);
/*6*/   Report.AddPrintCell ("Счет",        col6_len,  null,"c:" + head_format); 





    ДобавитьСтроку;  color = colorD; head_format = "c:ex_FZ(8):ex_FS():ex_B(tblr):ex_BC(" + color + ")"; color = colorL;
/*1*/   Report.AddPrintCell ("1", col1_len,  null, head_format);
/*2*/   Report.AddPrintCell ("2", col2_len,  null, head_format);
/*3*/   Report.AddPrintCell ("3", col3_len,  null, head_format);
/*4*/   Report.AddPrintCell ("4", col4_len,  null, head_format);
/*5*/   Report.AddPrintCell ("5", col5_len,  null, head_format);
/*6*/   Report.AddPrintCell ("6", col6_len,  null, head_format);     
 











    Report.SetExecute("iBook.Sheets("+sheet+").Rows("+(rn)+").AutoFilter;");
    ДобавитьСтроку;
end;

private macro ПечатьБлокаДанных(_rs);
    if(valtype(_rs) != v_undef)
    format = "ex_FS():ex_B(tblr)";
    var test;
      while(_rs.movenext)
        Report.AddPrintCell(_rs.value("FIID"), col1_len, null, "l:"+format); // 1. 
        Report.AddPrintCell(date(_rs.value("Dat")), col2_len, null, "l:"+format); // 2.  
        Report.AddPrintCell(_rs.value("code"), col3_len, null, "l:"+format); // 3.  
	 Report.AddPrintCell(_rs.value("de"), col4_len, null, "l:"+format); // 4.       
 	Report.AddPrintCell(_rs.value("isin"), col5_len, null, "l:"+format); // 5. 
	 Report.AddPrintCell(_rs.value("account"), col6_len, null, "l:"+format); // 6.
      //	 Report.AddPrintCell(_rs.value("rest"), col7_len, null, "l:"+format); // 6.             
      
      
      
      
      
      
      
      
      
      
        ДобавитьСтроку;
                     
      end;
    end;
end;

macro run()
var SQL, cmd, rs;

  Report = CMakeReport("┌┬┬┬┬┬┬┬┬┬┬┬┐");
  Report.SetDefaultFontName("Times New Roman");
  Report.SetDefaultFontSize(12);
  //Report.SetFlagShowGrid(true);

  ПечатьШапки();


SQL = "select *                                                                                "+     
"from(                                                                                         "+     
" SELECT  s.t_fiid fiid,                                                                       "+     
"         (s.t_date) dat,                                                                      "+     
"         fin.t_fi_code code,                                                                  "+     
"         fin.t_definition de,                                                                 "+     
"         avr.t_isin isin,                                                                     "+     
"         d.t_account account,                                                                 "+     
"         RSB_ACCOUNT.RESTALL (da.t_account,                                                   "+     
"                              da.t_chapter,                                                   "+     
"                              da.t_code_currency,                                             "+     
"                              " + GetSQLDate(vDate) + " )                                     "+     
"                     rest                                                                     "+     
"    FROM dpmwrtsum_dbt s,                                                                     "+     
"         dobjatcor_dbt cor,                                                                   "+     
"         dfininstr_dbt fin,                                                                   "+     
"         davoiriss_dbt avr,                                                                   "+     
"         dmcaccdoc_dbt d,                                                                     "+     
"         daccount_dbt da                                                                      "+     
"   WHERE     s.t_portfolio = 1                                                                "+     
"  and  da.T_account = d.t_account                                                             "+     
"         AND s.t_amount > 0                                                                   "+     
"         and d.t_iscommon = chr(88)                                                           "+     
"         AND t_buy_sale =0                                                                    "+     
"         AND s.t_party = -1                                                                   "+     
"         and D.T_FIID = s.t_FIID                                                              "+     
"         AND s.t_state = 1                                                                    "+     
 "        and d.t_catnum = 231                                                                 "+     
 "        AND cor.t_objecttype = 12                                                            "+     
"         AND cor.t_groupid = 62                                                               "+     
"         AND cor.t_attrid = 2                                                                 "+     
"         AND cor.t_object = LPAD (s.t_fiid, 10, '0')                                          "+     
"         AND cor.t_validtodate = TO_DATE ('31.12.9999', 'dd.mm.yyyy')                         "+     
"         AND fin.t_fiid = s.t_fiid                                                            "+     
"         AND avr.t_fiid = s.t_fiid                                                            "+     
"         order by s.t_fiid,                                                                   "+     
 "       s.t_date)                                                                             "+     
"         where rest !=0                                                                       ";     


   
    cmd = RSDCommand(SQL);
    begaction(100,"Сбор данных...");
    rs = RSDRecordset(cmd, rsdval_client,rsdval_static);
      ПечатьБлокаДанных(rs);
      endaction;

      Report.PrintWinRep("Список лотов по выкупам с непройденным SPPI тестом.");
      Report.SetWinRepOutput();
      Report.ShowWinRep();

 





end;  

END;


CLASS (TRsbPanel) Pan
    initTRsbPanel();

    const Delta = 50;

    const K_Enter = 13;
    const K_F3    = 317;
    const K_F2    = 316;

    const BeginCalcDate_ID = 1;

    var curstr = 1;
    Caption = "Список лотов по выкупам с непройденным SPPI тестом.";
    Status = "~ESC~Выход ~F2~Выполнить";
    setSize(37,5);
    setPosition(30,10);
    var BeginCalcDate, dx;
    var RuDataFlag = 0;
    var InPortfolioFlag = 1;

    curstr = curstr+1;
    BeginCalcDate = TRsbEditField(V_DATE);
    BeginCalcDate.setPosition(16,curstr);
    BeginCalcDate.setSize(8,1);
    BeginCalcDate.name = "begincalcdate";
    BeginCalcDate.value = {curdate};
    addControl(BeginCalcDate);

    var m_LabelCD:TrsbLabel = TRsbLabel(2,curstr,"Дата отчета:");
    addLabel (m_LabelCD);

    addEventHandler(RSB_EV_KEY_PRESSED, R2M(this, "onKeyPressed"));
    
    macro onKeyPressed(ev)
        if (ev.KeyCode == K_F3)
           if (ev.id == BeginCalcDate_ID)
            BeginCalcDate.value = GetDateByCalendar({CurDate});
            this.redraw; 
           end;
        elif (ev.KeyCode == K_Enter)
            //this.update;
           // EndCalcDate.value = BeginCalcDate.value + Delta;
            this.redraw; 
        elif(ev.keyCode == K_F2)
                
         var myRep = OfferRep(BeginCalcDate.value);
         myRep.run;
        end;
    end; 
END;

var myPanel:TRsbPanel = Pan;
myPanel.run;
exit(1);
