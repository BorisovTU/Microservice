/*18.01.2020 Малашкевич. Выгрузка данных по по выплатам по векселям для нужд CRS. BIQ-5949*/
import RsbFormsInter, cbreport_h, cb_sql, "dl_util_xml_obj.mac";
import "DLReport_h.mac", "dlreport.mac", scsrvrepfun;

//private var _cond = " where rownum < 1000 ";
private var _cond = "";//" where t_gross_proceeds <> 0 or t_other_total <> 0 ";
private var isshow = false;
private var isCSV = false;/*DEF-20841*/
private var fullf = "";

PRIVATE CONST  C_FILENAME = "sofrbill_" + strsubst(strsubst(string(date()), " ", "0"), ".", "") + ".csv";

private macro getSQL(_Year)
  var sql = "with bpm as (select " + string(_Year) + " year,pm.t_receiveraccount, pm.t_receiver, trn.t_fiid_receiver, sum(round(trn.t_sum_receiver, 2)) sumpm\n" +
				"               from dpmpaym_dbt pm\n" + 
				"              inner join dpmdocs_dbt pmd\n" + 
				"                 on (pm.t_paymentid = pmd.t_paymentid)\n" + 
				"              inner join dacctrn_dbt trn\n" + 
				"                 on (pmd.t_acctrnid = trn.t_acctrnid)\n" + 
				"              where pm.t_dockind in (110, 141)\n" + 
//" and pm.t_receiveraccount = '40702810032000000171' " + //debug
				"                and regexp_like(pm.t_payeraccount, '^(52406|52501)')\n" + 
				"                and regexp_like(pm.t_receiveraccount, '^(40[1-8]|4[10-40])')\n" + 
				"                and exists (select 1\n" + 
				"                              from ddp_dep_dbt dp\n" + 
				"                              where dp.t_partyid = pm.t_receiverbankid)\n" + 
				"                and trn.t_date_carry between to_date('0101' || " + string(_Year) + ", 'ddmmyyyy')\n" + 
				"                                         and to_date('3112' || " + string(_Year) + ", 'ddmmyyyy')\n" + 
				"              group by pm.t_receiveraccount,\n" + 
				"                       pm.t_receiver,\n" + 
				"                       trn.t_fiid_receiver )\n" + 
				"select bpm.*,\n" + 
				"       ob16.t_code inn,\n" + 
				"       pn.t_name,\n" + 
				"       fi.t_ccy,\n" + 
				"       case\n" + 
				"         when bpm.year < 2021 then\n" + 
				"           ob101.t_code\n" + 
				"         else\n" + 
				"           ob101.t_code\n" + 
				"       end CFT,\n" + 
				"       ob102.t_code DIA,\n" + 
				"       nvl(ob108.t_code, ob101_2.t_code) BIS\n" + 
				"  from bpm\n" + 
				" inner join dpartyname_dbt pn\n" + 
				"    on (bpm.t_receiver = pn.t_partyid and pn.t_nametypeid = 1)\n" + 
				" inner join dfininstr_dbt fi\n" + 
				"    on (bpm.t_fiid_receiver = fi.t_fiid)\n" + 
				"  left join dobjcode_dbt ob16\n" + 
				"    on (ob16.t_objecttype = 3 and ob16.t_codekind = 16 and ob16.t_state = 0 and bpm.t_receiver = ob16.t_objectid)\n" + 
				"  left join dobjcode_dbt ob101\n" + 
				"    on (ob101.t_objecttype = 3 and ob101.t_codekind = 101 and ob101.t_state = 0 and bpm.t_receiver = ob101.t_objectid and regexp_like(ob101.t_code, '^\\d*$'))\n" + 
                "  left join dobjcode_dbt ob101_2 \n" + 
                "    on (ob101_2.t_objecttype = 3 and ob101_2.t_codekind = 101 and ob101_2.t_state = 0 and bpm.t_receiver = ob101_2.t_objectid and regexp_like(ob101_2.t_code, '^\\d{2}#.#'))\n" + 
				"  left join dobjcode_dbt ob102\n" + 
				"    on (ob102.t_objecttype = 3 and ob102.t_codekind = 102 and ob102.t_state = 0 and bpm.t_receiver = ob102.t_objectid)\n" + 
				"  left join dobjcode_dbt ob108\n" + 
				"    on (ob108.t_objecttype = 3 and ob108.t_codekind = 108 and ob108.t_state = 0 and bpm.t_receiver = ob108.t_objectid)\n" +
				" order by t_receiveraccount";
	return sql;
end;

private macro UnloadCSV(_Year)
  var folder = "";
  if (not SelectFolder(folder, null, "Выберите папку для выгрузки", true))
     folder = "..\\TxtFile";
  end;
  fullf = folder+"\\"+C_FILENAME;
  //var f = TStreamDoc(fullf, "C");
  /*
  var sql = getSQL(_Year);

  var nrecs = SQL_GetNRecs(sql);

  sql = TRsbDataSet(sql);
  InitProgress(nrecs, "Печать");
  nrecs = 0;
  //f.WriteLine("Календарный год;Наименование клиента;ИНН клиента;Номер счета клиента;Доход по векселям;Код валюты;"+
  //            "Id клиента в СОФР;Id клиента Диасофт;Id клиента в ГО БИСКвит;ID клиента в ЦФТ");                                               
  /while (sql.MoveNext() )
     f.WriteLine(
       string(int(sql.value("year")))  
     + ";" + sql.value("t_name")       
     + ";" + sql.value("inn")       	 
     + ";" + sql.value("t_receiveraccount")       
     + ";" + strsubst(String(sql_money(sql.value("sumpm"))), ".", ",")
     + ";" + sql.value("t_ccy") 
     + ";" + sql.value("t_receiver")
     + ";" + sql_string(sql.value("DIA"))  
     + ";" + sql_string(sql.value("BIS"))  
     + ";" + sql_string(sql.value("CFT"))); 
     UseProgress(nrecs=nrecs+1);
  end;
  RemProgress;
  f = null;
  MsgBox("Выгружено: " + fullf);
  */
end;

private macro PrintReport(_Year)

/***********************/
  //return;
   var Obtemp = CTemplateXLS();
   Obtemp.OpenTemplate("Report_PaymBillsCRS5949.xlsx", false);//имя шаблона
   Obtemp.SetXLSXFormat();
   var obcsvfile  = C_CSVFile(";");
   obcsvfile.FileOpen(string(UserNumber)+"_5949.csv",true);// цсв таблица
   var obtable;
   obtable  = Obtemp.RegisterTable("bodyline");

/********************/


  var sql = getSQL(_Year);

  var nrecs = SQL_GetNRecs(sql);

  sql = TRsbDataSet(sql);
  InitProgress(nrecs, "Печать");
  nrecs = 0;
                                               
  while (sql.MoveNext() )
    obcsvfile.AddCell(string(int(sql.value("year"))),null,true);
    obcsvfile.AddCell(sql.value("t_name"),null,true);
    obcsvfile.AddCell(sql.value("inn"),null,true);
    obcsvfile.AddCell(sql.value("t_receiveraccount"),null,true);
    obcsvfile.AddCell(sql_money(sql.value("sumpm")),null,true);
    obcsvfile.AddCell(sql.value("t_ccy"),null,true) ;
    obcsvfile.AddCell(sql.value("t_receiver"),null,true);
    obcsvfile.AddCell(sql_string(sql.value("DIA")),null,true);
    obcsvfile.AddCell(sql_string(sql.value("BIS")),null,true);
    obcsvfile.AddCell(sql_string(sql.value("CFT")),null,true);
    obcsvfile.addrow(true);
    UseProgress(nrecs=nrecs+1);
  end;
  RemProgress();

/**************************/
      Obcsvfile.fileclose();
	  //DEF-20841 при формировании в EXCEL - не нужно копировать CSV
	  if (isCSV)
        if( not CopyFile("..\\txtfile\\" + Obcsvfile.m_filename, "$" + fullf) )
            msgbox("Ошибка копирования файла");
        else
           MsgBox("Выгружено: " + fullf);
        end;
      end;
     // obcsvfile.FileOpen(string(UserNumber)+"_5949.txt",true);// цсв таблица
      Obtemp.SetValue_NameCell("bodyline");
      obtable.FillTabelFromCSV(obcsvfile.GetlsFileName);
      Obtemp.SaveAsTemplate("report_"+string(UserNumber)+"_5949",IIF (isshow, TRUE, false));
/***************************/

end;


class (TRsbPanel) Pan
   initTRsbPanel();
   var curstr = 2;
   Caption = "Выплаты по векселям для целей CRS";
   Status = "~ESC~Выход ~F2~Выполнить";
   setSize(30,9);
   setPosition(8,1);
   var _Year, _TypeAccVarMar;

   var yy;
   DateSplit({curdate},null,null,yy);
   var m_eYear:TRsbEditField = TRsbEditField(1/*FT_INT32*/);
   m_eYear.SetPosition(7,curstr);
   m_eYear.SetSize(4,1);
   m_eYear.editable = true;
   m_eYear.textLength = 4;
   m_eYear.name = "_Year";
   m_eYear.Value = yy-1;
   addControl (m_eYear);

   var m_Label1:TrsbLabel = TRsbLabel(2,curstr,"Год: ");
   addLabel (m_Label1);

   curstr = curstr + 2;
   var m_cCSV:TRsbCheckBox = TRsbCheckBox;
   m_cCSV.setPosition(4,curstr);
   m_cCSV.name = "m_cCSV";
   m_cCSV.checked = true;
   m_cCSV.onChecked(R2M(this, "OnChecked"));
   addControl (m_cCSV);
   var m_Label4:TrsbLabel = TRsbLabel(6,curstr,"Выгрузка в CSV");
   addLabel (m_Label4);

   curstr = curstr + 1;
   var m_cExcel:TRsbCheckBox = TRsbCheckBox;
   m_cExcel.setPosition(4,curstr);
   m_cExcel.name = "m_cExcel";
   m_cExcel.checked = true;
   m_cExcel.onChecked(R2M(this, "OnChecked"));
   addControl (m_cExcel);
   var m_Label5:TrsbLabel = TRsbLabel(6,curstr,"Выгрузка в Excel");
   addLabel (m_Label5);


   curstr = curstr + 2;
   var m_PushB_Run:TRsbPushButton = TRsbPushButton("Старт");
   m_PushB_Run.setPosition(6,curstr);
   m_PushB_Run.setSize(7,1);
   m_PushB_Run.onClicked(R2M(this, "_Run"));
   addControl(m_PushB_Run);

   var m_PushB_Canc:TRsbPushButton = TRsbPushButton("Отмена");
   m_PushB_Canc.setPosition(17,curstr);
   m_PushB_Canc.setSize(7,1);
   m_PushB_Canc.onClicked(R2M(this, "_Cancel"));
   addControl(m_PushB_Canc);


   addEventHandler(RSB_EV_KEY_PRESSED, R2M(this, "onKeyPressed"));
   addEventHandler(RSB_EV_CONTROL_CHECKED,R2M(this,"OnChecked"));

   macro OnChecked(RsbEvent:Object)
      if (RsbEvent.id == RSB_EV_CONTROL_CHECKED)
         if (RsbEvent.source.name == "m_cExcel")
            RsbEvent.source.checked = not RsbEvent.source.checked;
            this.redraw();
         elif (RsbEvent.source.name == "m_cCSV")
            RsbEvent.source.checked = not RsbEvent.source.checked;
            this.redraw();
         end;
      end;
      return true;
   end;

   macro onKeyPressed(RsbEvent)   
      if (RsbEvent.id = RSB_EV_KEY_PRESSED)
         if (RsbEvent.keycode == 316)
            this._Run(RsbEvent)
         end;   
      end;
   end;

   macro _Run(RsbEvent)
      if (m_eYear.Value < 2000)
        Msgbox("Укажите год отчетного периода!");
        return;
      end;
      //Msgbox("Прерывание");
      //return; //!!!!
      if (m_cCsv.checked)
         UnloadCSV(m_eYear.Value);
         isCSV = true; /*DEF-20841*/
      end;
      if (m_cExcel.checked)
         isshow = true;
      end; 
      PrintReport(m_eYear.Value); 
/*DEF-20841 Не забываем про обнуление*/
      isCSV = false; 
      isshow = false;/**/
   end;


   macro _Cancel(RsbEvent)
      if (RsbEvent.id == RSB_EV_BUTTON_CLICKED)
        close(0);
      end;

   end;
end;

private macro CanExec()
  var sql;
  sql = "select count(1) cnt from dacsgroupoper_dbt lg where (lg.t_groupid = 10027 or lg.t_groupid = 10010) and lg.t_oper = " + string({oper});
  sql = TRsbDataSet(sql);
  if (sql.MoveNext() )
     return int(sql.value("cnt")) > 0;
  end; 
  return false;
end;

if (not CanExec())
    MsgBox("У Вас нет прав на выпуск данного отчета!");
	exit(1);
end;

var Panel = Pan();
Pan.Run;
exit(1);