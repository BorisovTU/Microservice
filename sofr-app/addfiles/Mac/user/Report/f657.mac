
Import globals;
Import "or_rep_h.mac",oratools, rsd;
Import "f657_3_header.mac";
Import "f657_1_header.mac";
Import "f657_1_header2.mac";
Import "spRepFn2.mac";
Import "secinter.mac";
Import "f657_LoadInDep.mac";
Import "f657_Dialog.mac";

class repf657 (ParametrClass)       
//Родительский класс форма 657
  const SP_RATETYPE_TSS_reqcom = 14;
	var Rep:CMakeReport;
	var repDate = {curdate};
  var Department={OperDprtNode}; //код подразделения

	//Шапка таблицы
	var tableHeader:string ;

	//Заголовок окна Excell
	var winHeader:string;

  private var Deal    = TBFile( "dl_tick",  "R", 0 );   /*сделка*/
	private var RelatedDeal    = TBFile( "dl_tick",  "R", 0 );   /*связная сделка*/
	private var lot    = TBFile( "pmwrtsum",  "R", 0 );   /*сделка*/
  var DealChange = TRecHandler( "sptkchng" );
	var RelatedDealChange = TRecHandler( "sptkchng" );

	/*
		Ввод даты отчёта
	*/
    macro inputRepDate()
       if (not GetDate(repDate,"Отчетная дата:")) 
         exit(1) 
       end;
    end;

/*****************************************************************/
/*      Сообщения о нештатных ситуациях в серверной процедуре.   */
/*****************************************************************/
    macro ServErrors( cmd, mes, str_err )
      var i = 0;
      var env_err = cmd.Connection().Environment();
      if ( mes != "" )
            msgbox( mes + "|" + str_err );
            println( mes + " " + str_err );
      else  msgbox( str_err );
            println( str_err );
      end;
      while( i < env_err.ErrorCount )
        println( env_err.error(i).descr );
        i = i + 1;
      end;
    end;
/*****************************************************************/
/*                 Выполнение серверной процедуры.               */
/*****************************************************************/
    macro ExecCommand( cmd, mes )

      message( mes + " ~ Ждите...~" );
      cmd.execute;

      return TRUE;

      OnError( er );
      ServErrors( cmd, mes, er.message );
      return FALSE;

    end;

/*Общие методы */

  /*
		Получаем рейтинг эмиссии (ЦБ)
		inSecID - ID ЦБ
		codeRating - код считываемого рейтинга
		             варианты: S&P      (при использовании экранируем амперсанд - S\&P)
		                       Moody
		                       Fitch IBC
		                       АКРА
		                       Эксп. РА
		rtDate - дата рейтинга
	*/
    private macro getRatingSec(inSecID, codeRating, rtDate)
       var sql="select da.t_name "+
                 "from dobjattr_dbt da "+
                 "join dobjatcor_dbt dc on da.t_objecttype = dc.t_objecttype and da.t_groupid = dc.t_groupid and da.t_attrid = dc.t_attrid "+
                 "where dc.t_objecttype = 12 "+  //ценная бумага
                   "and dc.t_groupid = 53 "+     //рейтинг
                   "and dc.t_object = lpad( :inSecID , 10, '0') "+
                   "and dc.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy') "+
                   "and :rtDate between dc.t_validfromdate and dc.t_validtodate "+
                   "and (dc.t_sysdate, dc.t_systime) = (select max(o.t_sysdate), max(o.t_systime) from dobjatcor_dbt o "+       //выбираем последний рейтинг по текущему объекту
                                                                                                 "join dobjattr_dbt w on w.t_objecttype = o.t_objecttype and w.t_groupid = o.t_groupid and w.t_attrid = o.t_attrid "+
                                                                                                 "where o.t_objecttype = 12 "+  //ценная бумага
                                                                                                 "and o.t_groupid = 53 "+       //рейтинг
                                                                                                 "and o.t_object = lpad( :inSecID1 , 10, '0') "+
                                                                                                 "and o.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy') "+
                                                                                                 "and :rtDate1 between o.t_validfromdate and o.t_validtodate "+
                                                                                                 "and w.t_codelist=da.t_codelist) "+
                   "and da.t_codelist= :codeRating";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":inSecID", RSDBP_IN, inSecID);
	    cmd.addParam(":rtDate", RSDBP_IN, rtDate);
	    cmd.addParam(":inSecID1", RSDBP_IN, inSecID);
	    cmd.addParam(":rtDate1", RSDBP_IN, rtDate);
	    cmd.addParam(":codeRating", RSDBP_IN, codeRating);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "---";
        end;

    end;

  /*
		Получаем рейтинг эмитента
		inPartyid - ID эмитента
		codeRating - код считываемого рейтинга
		             варианты: S&P      (при использовании экранируем амперсанд - S\&P)
		                       Moody
		                       Fitch IBC
		                       АКРА
		                       Эксп. РА
		rtDate - дата рейтинга
	*/
    private macro getRatingIssuer(inPartyid, codeRating, rtDate)
       var sql="select da.t_name "+
                 "from dobjattr_dbt da "+
                 "join dobjatcor_dbt dc on da.t_objecttype = dc.t_objecttype and da.t_groupid = dc.t_groupid and da.t_attrid = dc.t_attrid "+
                 "where dc.t_objecttype = 3 "+   //субъект
                   "and dc.t_groupid = 19 "+     //рейтинг
                   "and dc.t_object = lpad( :inPartyid , 10, '0') "+
                   "and dc.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy') "+
                   "and :rtDate between dc.t_validfromdate and dc.t_validtodate "+                   
                   "and (dc.t_sysdate, dc.t_systime) = (select max(o.t_sysdate), max(o.t_systime) from dobjatcor_dbt o "+       //выбираем последний рейтинг по текущему объекту
                                                                                                 "join dobjattr_dbt w on w.t_objecttype = o.t_objecttype and w.t_groupid = o.t_groupid and w.t_attrid = o.t_attrid "+
                                                                                                 "where o.t_objecttype = 3 "+   //субъект
                                                                                                 "and o.t_groupid = 19 "+       //рейтинг
                                                                                                 "and o.t_object = lpad( :inPartyid1 , 10, '0') "+
                                                                                                 "and o.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy') "+
                                                                                                 "and :rtDate1 between o.t_validfromdate and o.t_validtodate "+
                                                                                                 "and w.t_codelist=da.t_codelist) "+
                   "and da.t_codelist= :codeRating";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":inPartyid", RSDBP_IN, inPartyid);
	    cmd.addParam(":rtDate", RSDBP_IN, rtDate);
	    cmd.addParam(":inPartyid1", RSDBP_IN, inPartyid);
	    cmd.addParam(":rtDate1", RSDBP_IN, rtDate);
	    cmd.addParam(":codeRating", RSDBP_IN, codeRating);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "---";
        end;

    end;

  /*
    Вернуть строку Признак международной организации
  */
    private macro getOrgInternational(inPartyid)
        // var sql="select a.t_name "+
        //         "from dobjattr_dbt a "+
        //         "join dobjatcor_dbt c on a.t_objecttype = c.t_objecttype and a.t_groupid = c.t_groupid and a.t_attrid = c.t_attrid "+
        //         "where c.t_objecttype = 3 "+   //Субъект
        //           "and c.t_groupid = 109 "+    //Признак международной организации
        //           "and c.t_object = lpad( :inPartyid, 10, '0') "+
        //           "and c.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy')";

        var sql = "select PY.T_PARTYID from dpartyown_dbt py where PY.T_PARTYID = :inPartyid and PY.T_PARTYKIND = 32;";

      var cmd = rsdCommand(sql);
      cmd.addParam(":inPartyid", RSDBP_IN, inPartyid);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return "ДА";
        else
            return "НЕТ";
        end;
      OnError
        return "---";
    end;


	/*
		Вернуть строку страна эмитента, или контрагента
	*/
	macro getIssuerCountry (PartyID)
	  var sql = "select p.t_nrcountry from dparty_dbt p where p.t_partyid =  :t_partyid ";
      var cmd = rsdCommand(sql);
      cmd.addParam(":t_partyid", RSDBP_IN, PartyID);
      cmd.Execute();
      var rs = rsdRecordSet(cmd);
      if (rs.MoveNext)
        if (getOrgInternational(PartyID) == "НЕТ")
          return rs.Value(0);
        else
          return "---";  
        end;
      else
        return "---";
      end;
	End;

  /*
		Вернуть страновую оценку эмитента
	*/
	macro getRatingCountry (PartyID)

	  var IssuerCountry=getIssuerCountry(PartyID);
	  if (IssuerCountry != "---")
	      var sql = "select p.t_riskclass from DCOUNTRY_DBT p where p.t_codelat3 = :IssuerCountry ";
          var cmd = rsdCommand(sql);
          cmd.addParam(":IssuerCountry", RSDBP_IN, IssuerCountry);
          cmd.Execute();
          var rs = rsdRecordSet(cmd);
          if (rs.MoveNext)
              return rs.Value(0);
          else
              return "---";
          end;
	  else
          return "---";
	  end;
	   
	End;

	
	/*
		Вернуть строку Эмитент
	*/
	macro getIssuer (FD)
	   //Comment macro
       return GetPartyShortNameByID(FI_GetIssuerOnDate(FD.fininstr, repDate + 1));
	End;

	/*
		Вернуть строку ОКВЭД эмитента
	*/
    private macro getOKVED(inPartyid)
        var sql="select a.t_nameobject "+
                "from dobjattr_dbt a "+
                "join dobjatcor_dbt c on a.t_objecttype = c.t_objecttype and a.t_groupid = c.t_groupid and a.t_attrid = c.t_attrid "+
                "where c.t_objecttype = 3 "+   //Субъект
                  "and c.t_groupid = 64 "+     //ОКВЭД
                  "and c.t_object = lpad( :inPartyid, 10, '0') "+
                  "and c.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy')";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":inPartyid", RSDBP_IN, inPartyid);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "---";
        end;

    end;

	/*
		Вернуть строку Признак SPV эмитента
	*/
    private macro getSPV(inPartyid)
        var sql="select a.t_name "+
                "from dobjattr_dbt a "+
                "join dobjatcor_dbt c on a.t_objecttype = c.t_objecttype and a.t_groupid = c.t_groupid and a.t_attrid = c.t_attrid "+
                "where c.t_objecttype = 3 "+   //Субъект
                  "and c.t_groupid = 108 "+    //Признак SPV
                  "and c.t_object = lpad( :inPartyid, 10, '0') "+
                  "and c.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy')";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":inPartyid", RSDBP_IN, inPartyid);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "---";
        end;

    end;

  /*
		Обращается на рынке (Да/Нет), (категория "Обращается на ОРЦБ")
	*/
    private macro getTradeMarket(inSecID)
        var sql="select a.t_name "+
                "from dobjattr_dbt a "+
                "join dobjatcor_dbt c on a.t_objecttype = c.t_objecttype and a.t_groupid = c.t_groupid and a.t_attrid = c.t_attrid "+
                "where c.t_objecttype = 12 "+  //ценная бумага
                  "and c.t_groupid = 17 "+     //категория "Обращается на ОРЦБ"
                  "and c.t_object = lpad( :inSecID, 10, '0') "+
                  "and c.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy')";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":inSecID", RSDBP_IN, inSecID);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "---";
        end;

    end;

  /*
		Признак наличия дефолта по выпуску (да/нет)
	*/
    private macro getCatDef(inSecID)
        var sql="select a.t_name "+
                "from dobjattr_dbt a "+
                "join dobjatcor_dbt c on a.t_objecttype = c.t_objecttype and a.t_groupid = c.t_groupid and a.t_attrid = c.t_attrid "+
                "where c.t_objecttype = 12 "+  //ценная бумага
                  "and c.t_groupid = 35 "+     //категория "Дефолтная"
                  "and c.t_object = lpad( :inSecID, 10, '0') "+
                  "and c.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy')";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":inSecID", RSDBP_IN, inSecID);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "---";
        end;

    end;

  /*
		Признак Ипотечное покрытие (да/нет)
	*/
    private macro getMortgageCoverage(inSecID)
        var sql="select a.t_name "+
                "from dobjattr_dbt a "+
                "join dobjatcor_dbt c on a.t_objecttype = c.t_objecttype and a.t_groupid = c.t_groupid and a.t_attrid = c.t_attrid "+
                "where c.t_objecttype = 12 "+   //ценная бумага
                  "and c.t_groupid = 60 "+     //категория "Ипотечное покрытие"
                  "and c.t_object = lpad( :inSecID, 10, '0') "+
                  "and c.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy')";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":inSecID", RSDBP_IN, inSecID);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "---";
        end;

    end;

  /*
		Признак нахождения в ломбардном списке (да/нет)
	*/
    private macro getLombard(inSecID)
        var sql="select a.t_name "+
                "from dobjattr_dbt a "+
                "join dobjatcor_dbt c on a.t_objecttype = c.t_objecttype and a.t_groupid = c.t_groupid and a.t_attrid = c.t_attrid "+
                "where c.t_objecttype = 12 "+   //ценная бумага
                  "and c.t_groupid = 61 "+     //категория "Ломбардный список"
                  "and c.t_object = lpad( :inSecID, 10, '0') "+
                  "and c.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy')";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":inSecID", RSDBP_IN, inSecID);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "---";
        end;

    end;

  /*
		Включение биржей в списки для расчета Индекса ММВБ 50 (да/нет)
	*/
    private macro getMMVB50(inSecID)
        var sql="select a.t_name "+
                "from dobjattr_dbt a "+
                "join dobjatcor_dbt c on a.t_objecttype = c.t_objecttype and a.t_groupid = c.t_groupid and a.t_attrid = c.t_attrid "+
                "where c.t_objecttype = 12 "+   //ценная бумага
                  "and c.t_groupid = 103 "+     //категория "В списках для расчета Индекса ММВБ 50"
                  "and c.t_object = lpad( :inSecID, 10, '0') "+
                  "and c.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy')";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":inSecID", RSDBP_IN, inSecID);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "---";
        end;

    end;

  /*
		Включение биржей в списки для расчета Индекса РТС 50 (да/нет)
	*/
    private macro getRTC50(inSecID)
        var sql="select a.t_name "+
                "from dobjattr_dbt a "+
                "join dobjatcor_dbt c on a.t_objecttype = c.t_objecttype and a.t_groupid = c.t_groupid and a.t_attrid = c.t_attrid "+
                "where c.t_objecttype = 12 "+   //ценная бумага
                  "and c.t_groupid = 104 "+     //категория "В списках для расчета Индекса РТС 50"
                  "and c.t_object = lpad( :inSecID, 10, '0') "+
                  "and c.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy')";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":inSecID", RSDBP_IN, inSecID);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "---";
        end;

    end;

  /*
		511-П_Признак активности и ликвидности рынка (да/нет)
	*/
    private macro get511SignLiquidMarket(inSecID)
        var sql="select a.t_name "+
                "from dobjattr_dbt a "+
                "join dobjatcor_dbt c on a.t_objecttype = c.t_objecttype and a.t_groupid = c.t_groupid and a.t_attrid = c.t_attrid "+
                "where c.t_objecttype = 12 "+   //ценная бумага
                  "and c.t_groupid = 64 "+     //категория 511-П_Признак активности и ликвидности рынка
                  "and c.t_object = lpad( :inSecID, 10, '0') "+
                  "and c.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy')";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":inSecID", RSDBP_IN, inSecID);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "---";
        end;

    end;

  /*
		511-П_Уровень иерархии оценки (1/2/3)
	*/
    private macro get511GradeLevel(inSecID)
        var sql="select a.t_name "+
                "from dobjattr_dbt a "+
                "join dobjatcor_dbt c on a.t_objecttype = c.t_objecttype and a.t_groupid = c.t_groupid and a.t_attrid = c.t_attrid "+
                "where c.t_objecttype = 12 "+   //ценная бумага
                  "and c.t_groupid = 65 "+     //категория 511-П_Уровень иерархии оценки
                  "and c.t_object = lpad( :inSecID, 10, '0') "+
                  "and c.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy')";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":inSecID", RSDBP_IN, inSecID);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "---";
        end;

    end;

  /*
		Облигации с залоговым обеспечением (да/нет)
	*/
    private macro getSecuredBonds(inSecID)
        var sql="select a.t_name "+
                "from dobjattr_dbt a "+
                "join dobjatcor_dbt c on a.t_objecttype = c.t_objecttype and a.t_groupid = c.t_groupid and a.t_attrid = c.t_attrid "+
                "where c.t_objecttype = 12 "+   //ценная бумага
                  "and c.t_groupid = 66 "+     //категория Облигации с залоговым обеспечением
                  "and c.t_object = lpad( :inSecID, 10, '0') "+
                  "and c.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy')";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":inSecID", RSDBP_IN, inSecID);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "Нет";
        end;

    end;

  /*
		Вложения, которые прямо или через третьих лиц обеспечены гарантией РФ (да/нет)
	*/
    private macro getGuaranteeRF(inSecID)
        var sql="select a.t_name "+
                "from dobjattr_dbt a "+
                "join dobjatcor_dbt c on a.t_objecttype = c.t_objecttype and a.t_groupid = c.t_groupid and a.t_attrid = c.t_attrid "+
                "where c.t_objecttype = 12 "+   //ценная бумага
                  "and c.t_groupid = 67 "+     //категория Вложения, которые прямо или через третьих лиц обеспечены гарантией РФ
                  "and c.t_object = lpad( :inSecID, 10, '0') "+
                  "and c.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy')";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":inSecID", RSDBP_IN, inSecID);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "Нет";
        end;

    end;

  /*
    Соответствие депозитария критериям п.1.2 Указания 2732-У (да/нет)
  */
    private macro getDepoCrit(inSecID)
        var sql="select a.t_name "+
                "from dobjattr_dbt a "+
                "join dobjatcor_dbt c on a.t_objecttype = c.t_objecttype and a.t_groupid = c.t_groupid and a.t_attrid = c.t_attrid "+
                "where c.t_objecttype = 12 "+   //ценная бумага
                  "and c.t_groupid = 68 "+     //категория Соответствие депозитария критериям п.1.2 Указания 2732-У
                  "and c.t_object = lpad( :inSecID, 10, '0') "+
                  "and c.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy')";

      var cmd = rsdCommand(sql);
      cmd.addParam(":inSecID", RSDBP_IN, inSecID);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "Да";
        end;

    end;

  /*
		Признак наличия банкротства по эмитенту (Да/Нет)
	*/
    private macro getIsBankrupt(inPartyid)
      var sql="select a.t_name "+
                "from dobjattr_dbt a "+
                "join dobjatcor_dbt c on a.t_objecttype = c.t_objecttype and a.t_groupid = c.t_groupid and a.t_attrid = c.t_attrid "+
                "where c.t_objecttype = 3 "+   //Субъект
                  "and c.t_groupid = 77 "+     //категория Является банкротом
                  "and c.t_object = lpad( :inPartyid, 10, '0') "+
                  "and c.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy')";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":inPartyid", RSDBP_IN, inPartyid);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "---";
        end;

    end;

  /*
		511-П_Источник котировки
	*/
    private macro get511SourceQuote(inSecID)
      var sql="select rsb_struct.getString(n.t_text) "+
                "from dnotetext_dbt n "+
                "where n.t_objecttype = 12 "+    //ценная бумага
                  "and n.t_notekind = 205 "+     //511-П_Источник котировки
                  "and n.t_documentid = lpad( :inSecID, 10, '0') "+
                  "and n.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy')";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":inSecID", RSDBP_IN, inSecID);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "---";
        end;

    end;

  /*
        511-П_Коэффициент ликвидности
	*/
    private macro get511LiquidRatio(inSecID)
        var sql="select rsb_struct.getString(n.t_text) "+
                "from dnotetext_dbt n "+
                "where n.t_objecttype = 12 "+    //ценная бумага
                  "and n.t_notekind = 206 "+     //511-П_Коэффициент ликвидности
                  "and n.t_documentid = lpad( :inSecID, 10, '0') "+
                  "and n.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy')";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":inSecID", RSDBP_IN, inSecID);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "---";
        end;

    end;

  /*
        Величина корректировки (511-П)
	*/
    private macro getValueAdjust(inSecID)
        var sql="select rsb_struct.getString(n.t_text) "+
                "from dnotetext_dbt n "+
                "where n.t_objecttype = 12 "+    //ценная бумага
                  "and n.t_notekind = 207 "+     //Величина корректировки (511-П)
                  "and n.t_documentid = lpad( :inSecID, 10, '0') "+
                  "and n.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy')";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":inSecID", RSDBP_IN, inSecID);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "---";
        end;

    end;

    /*
		Вернуть строку с "НФО" или "ФО"
    */
	private macro getNFO (inPartyid)
	var islegalform, isresident, isbank, isokved6group;

	var sql="select decode(p.t_legalform, 1, 'Y', 0) as islegalform, "+
	             "decode(p.t_notresident, chr(88), 'N', 'Y') as isresident, "+
	             "decode(o.t_partykind, 2, 'Y', 'N') as isbank "+
	             "from dparty_dbt p "+
	             "left join (select t_partyid, t_partykind "+
	                        "from dpartyown_dbt "+
	                        "where t_partykind = 2 "+ // PARTYKIND_BANK = 2 - банки
	                        ") o "+
	             "on p.t_partyid = o.t_partyid "+
	             "where p.t_partyid = :inPartyid";

	var cmd = rsdCommand(sql);
	cmd.addParam(":inPartyid", RSDBP_IN, inPartyid);
	cmd.Execute();
	var getData = TRsbDataSet(cmd);

	if (getData.MoveNext())
	  islegalform = getData.islegalform;
	  isresident = getData.isresident;
	  isbank = getData.isbank;
	else
	  islegalform = "N";
	  isresident = "N";
	  isbank = "N";
	end;

	if (isbank == "Y")
	return "ФО";
	end;

	if ((isresident == "Y") and (islegalform == "Y"))
	    sql="select 'Y' as isokved6group "+
	        "from dobjattr_dbt a, "+
	             "dobjatcor_dbt c "+
	        "where a.t_objecttype = c.t_objecttype "+
	           "and a.t_groupid = c.t_groupid "+
	           "and a.t_attrid = c.t_attrid "+
	           "and c.t_objecttype = 3 "+
	           "and c.t_groupid = 64 "+   //CATEG_OKVED
	           "and c.t_object = lpad( :inPartyid, 10, '0') "+
	           "and c.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy') "+
	           "and (a.t_nameobject like '64%' or a.t_nameobject like '65%' or a.t_nameobject like '66%')";
	    
	    cmd = rsdCommand(sql);
	    cmd.addParam(":inPartyid", RSDBP_IN, inPartyid);
	    cmd.Execute();
	    getData = TRsbDataSet(cmd);

	    if (getData.MoveNext())
	        isokved6group = getData.isokved6group;
	    else
	        isokved6group = "N";
	    end;

	    if (isokved6group == "Y")
	       return "ФО";
	    else
	       return "НФО";
	    end;

	else
	 //в ТЗ. - необходимо проанализировать случай нерезидента не ЮЛ
	  return "---";
	end;
	  return "---";

	end;

	/*
		Возвращает true если неттинг расчётный
	*/

	macro isEstimatedNetting (GenAgrID)
        var sql="select 1 from ddl_genagr_dbt gagr where gagr.t_GenAgrID = :t_GenAgrID and gagr.t_can_netting = 'X'";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":t_GenAgrID", RSDBP_IN, GenAgrID);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return true;
        else
            return false;
        end;
	End;

	/*
		Возвращает true если неттинг ликвидационный
	*/

	macro isDestroyNetting (GenAgrID)
        var sql="select 1 from ddl_genagr_dbt gagr where gagr.t_GenAgrID = :t_GenAgrID and gagr.t_can_liquidnetting = 'X'";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":t_GenAgrID", RSDBP_IN, GenAgrID);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return true;
        else
            return false;
        end;
	End;

	/*
		Возвращает true если неттинг ликвидационный
	*/

	macro getAgreementNumber (GenAgrID)
        var sql="select gagr.t_code from ddl_genagr_dbt gagr where gagr.t_GenAgrID = :t_GenAgrID";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":t_GenAgrID", RSDBP_IN, GenAgrID);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "---";
        end;
	End;	

   /* Получаем курс бумаги в рублях и валюте.
      Алгоритм работы: Курс вида "XXX" в валюте номинала за последний
      рабочий день, предшествующий отчетной дате; если за эту дату курс не
      введен, то выводится курс этого вида с наибольшей датой, не
      превышающей отчетную, если ВН - не рубли, то XXX пересчитывается в
      руб. по курсу на дату, предшествующую отчетной, если нет XXX в ВН, то
      берется XXX в рублях, если XXX ни в ВН, ни в рублях не найдена, то
      поле не заполняется.
      RateType - вид курса
      Price    - сюда запишем цену
      IsQuoted - флаг, котируемая бумага */
   macro GetRateByFininstr(   fininstr, RateType, PriceRUR:@Double, PriceCUR:@Double )
     var
        FIFrom         = fininstr.FIID,
        FITo           = fininstr.FaceValueFI,
        CnvDate        = RepDate,
        InformUser;

     PriceRUR       = "";
     PriceCUR       = "";
     /* Если некотируемой ц/б и курса вида "TCC", то в случае,
        когда курса нет, пользователя не информируем. */
     InformUser = 0;

     InitError();
     if( not ConvSumDbl( PriceCUR, 1, CnvDate, FIFrom, FITo, false, RateType ) )
     /* Не нашли курс. Сбрасываем ошибку после ConvSum.
        Пробуем найти курс в рублях. */
        InitError();

        FITo = NATCUR;

        if( not ConvSumDbl(PriceRUR, 1, CnvDate, FIFrom, FITo, false, RateType) ) 
      /* Не нашли курс. Сбрасываем ошибку после ConvSum.
         Выдаем предупрежедение пользователю. */

           if( InformUser )
             msgbox(
                   "Для ценной бумаги \"" + string(fininstr.FI_Code)
                 + "\" не удалось получить курс вида \""
                 + GetRateTypeName(RateType) + "\" на "
                 + DateToStr( CnvDate, true) );
           end;

           PriceRUR       = "";
           PriceCUR       = "";
           return false;

        end;
     else
      /* Нашли курс в валюте номинала. Переводим сумму в рубли. */
/*        if( (not SmartConvertSumDbl(  PriceRUR, PriceCUR, CnvDate, FITo, NATCUR )) and InformUser )
      /* Не смогли сконвертировать. */
            msgbox(
                GetCurrencyConvertErrorMsg(FITo, NATCUR, CnvDate) );
        end;*/
     end;

     return true;
   end;



 /* Получаем курс бумаги в рублях и валюте.
  Алгоритм работы: Курс вида "XXX" в валюте номинала за последний
  рабочий день, предшествующий отчетной дате; если за эту дату курс не
  введен, то выводится курс этого вида с наибольшей датой, не
  превышающей отчетную, если ВН - не рубли, то XXX пересчитывается в
  руб. по курсу на дату, предшествующую отчетной, если нет XXX в ВН, то
  берется XXX в рублях, если XXX ни в ВН, ни в рублях не найдена, то
  поле не заполняется.
  RateType - вид курса
  Price    - сюда запишем цену
  IsQuoted - флаг, котируемая бумага */
  macro GetRateInfo(   FD, RateType, PriceRUR:@Double, PriceCUR:@Double, IsQuoted )
   var
      FIFrom         = FD.fininstr.rec.FIID,
      FITo           = FD.fininstr.rec.FaceValueFI,
      CnvDate        = RepDate,
      InformUser;

   PriceRUR       = "";
   PriceCUR       = "";
   /* Если некотируемой ц/б и курса вида "TCC", то в случае,
      когда курса нет, пользователя не информируем. */
   //InformUser = IsQuoted or ((RateType !=  SP_RATETYPE_RightCost) and (RateType !=  SP_RATETYPE_TSS_reqcom));
   InformUser = 0;

   InitError();
   if( not ConvSumDbl( PriceCUR, 1, CnvDate, FIFrom, FITo, false, RateType ) )
   /* Не нашли курс. Сбрасываем ошибку после ConvSum.
      Пробуем найти курс в рублях. */
      InitError();

      FITo = NATCUR;

      if( not ConvSumDbl(PriceRUR, 1, CnvDate, FIFrom, FITo, false, RateType) ) 
    /* Не нашли курс. Сбрасываем ошибку после ConvSum.
       Выдаем предупрежедение пользователю. */

         if( InformUser )
            msgbox(
                 "Для ценной бумаги \"" + string(FD.fininstr.rec.FI_Code)
               + "\" не удалось получить курс вида \""
               + GetRateTypeName(RateType) + "\" на "
               + DateToStr( CnvDate, true) );
         end;

         PriceRUR       = "";
         PriceCUR       = "";
         return false;

      end;
   else
    /* Нашли курс в валюте номинала. Переводим сумму в рубли. */
      if( (not SmartConvertSumDbl(  PriceRUR, PriceCUR, CnvDate, FITo, NATCUR )) and InformUser )
    /* Не смогли сконвертировать. */
          msgbox(
              GetCurrencyConvertErrorMsg(FITo, NATCUR, CnvDate) );
      end;
   end;

   return true;
  end;

  /*ставка дохода по купону по fininstr*/
  macro getCoupRateByFininstr(fininstr, avoiriss)
        var IncomeRate, CoupDrawDate, DaysInYear, DaysInCoupon;
        var fiwarnt = TBFile( "fiwarnts", "R", 1 );
        if(( FI_IsBond(fininstr.FIID) ) AND ( FI_IsCouponAvoiriss(fininstr.FIID) ))
             if (avoiriss.begplacementdate == RepDate)/*в дату размещения купон еще не начался, но надо взять его ставку*/
                CoupDrawDate = GetCoupon_MaxDrDateOnFrDate( fininstr.FIID, RepDate + 1 );
             else
                CoupDrawDate = GetCoupon_MaxDrDateOnFrDate( fininstr.FIID, RepDate );
             end;
             if( CoupDrawDate != ZeroDate )
                fiwarnt.Clear();
                fiwarnt.rec.IsPartial   = UNSET_CHAR;
                fiwarnt.rec.FIID        = fininstr.FIID;
                fiwarnt.rec.DrawingDate = CoupDrawDate;
                if( fiwarnt.GetLE() and 
                    (fiwarnt.rec.IsPartial == UNSET_CHAR) and
                    (fiwarnt.rec.FIID == fininstr.FIID) and
                    (fiwarnt.rec.DrawingDate == CoupDrawDate)
                  ) 
                   if(fiwarnt.rec.IncomeRate != 0) 
                      IncomeRate = fiwarnt.rec.IncomeRate;
                   else
                     /*Заполняется только для купонных облигаций - ставка по купону, действующему на отчетную дату. 
                       Если для купона, действующего на отчетную дату ставка  указана в справочнике, то выводится именно она. 
                       Если ставка не указана, то вычисляется ставка по купону в % годовых по формуле: 100%*B*C/(N*T), 
                       где B- количество дней в году, C - сумма купона, N -сумма номинала, действующего на дату погашения купона, 
                       T - длительность купона. Величины T и B вычисляются в соответствии с методом, указанным в справочнике ценных бумаг, 
                       в поле "Базис расчета НКД". Длительность купона = дата погашения купона - дата начала действия купона + 1*/
                      ПолучитьПараметрыБазисаРасчетаКупона(avoiriss.NKDBase_Kind, fiwarnt.rec, RepDate, DaysInYear, DaysInCoupon);
                      
                      var v_FaceValueOnDate = DoubleToMoney(GetFaceValue(fininstr.FIID,fiwarnt.rec.DrawingDate));
                      
                      if( (v_FaceValueOnDate != $0) and (DaysInCoupon != 0 ) )
                         IncomeRate = 100.0 * DaysInYear * fiwarnt.rec.IncomeVolume / (v_FaceValueOnDate * DaysInCoupon);
                      else
                         IncomeRate = 0.0;
                      end;
                      
                      IncomeRate = ЧислоCЗаданнойТочностью( DoubleToMoney( IncomeRate), 4);
                   end;
                else
                   IncomeRate   = "";
                end;
                CoupDrawDate = date_as_string(1, CoupDrawDate);
             else
                CoupDrawDate = "";
                IncomeRate   = "";
             end;
          else
             CoupDrawDate = "";
             IncomeRate   = "";
        end;

        return IncomeRate;
  end;

  /*ставка дохода по купону*/
  macro getCoupRate(FD)
        var IncomeRate, CoupDrawDate, DaysInYear, DaysInCoupon;
        var fiwarnt = TBFile( "fiwarnts", "R", 1 );

        if(( FI_IsBond(FD.fininstr.rec.FIID) ) AND ( FI_IsCouponAvoiriss(FD.fininstr.rec.FIID) ))
             CoupDrawDate = GetCoupon_MaxDrDateOnFrDate( FD.fininstr.rec.FIID, RepDate );
             if( CoupDrawDate != ZeroDate )
                fiwarnt.Clear();
                fiwarnt.rec.IsPartial   = UNSET_CHAR;
                fiwarnt.rec.FIID        = FD.fininstr.rec.FIID;
                fiwarnt.rec.DrawingDate = CoupDrawDate;
                if( fiwarnt.GetLE() and 
                    (fiwarnt.rec.IsPartial == UNSET_CHAR) and
                    (fiwarnt.rec.FIID == FD.fininstr.rec.FIID) and
                    (fiwarnt.rec.DrawingDate == CoupDrawDate)
                  ) 
                   if(fiwarnt.rec.IncomeRate != 0) 
                      IncomeRate = fiwarnt.rec.IncomeRate;
                   else
                     /*Заполняется только для купонных облигаций - ставка по купону, действующему на отчетную дату. 
                       Если для купона, действующего на отчетную дату ставка  указана в справочнике, то выводится именно она. 
                       Если ставка не указана, то вычисляется ставка по купону в % годовых по формуле: 100%*B*C/(N*T), 
                       где B- количество дней в году, C - сумма купона, N -сумма номинала, действующего на дату погашения купона, 
                       T - длительность купона. Величины T и B вычисляются в соответствии с методом, указанным в справочнике ценных бумаг, 
                       в поле "Базис расчета НКД". Длительность купона = дата погашения купона - дата начала действия купона + 1*/
                      ПолучитьПараметрыБазисаРасчетаКупона(FD.avoiriss.rec.NKDBase_Kind, fiwarnt.rec, RepDate, DaysInYear, DaysInCoupon);
                      
                      var v_FaceValueOnDate = DoubleToMoney(GetFaceValue(FD.fininstr.rec.FIID,fiwarnt.rec.DrawingDate));
                      
                      if( (v_FaceValueOnDate != $0) and (DaysInCoupon != 0 ) )
                         IncomeRate = 100.0 * DaysInYear * fiwarnt.rec.IncomeVolume / (v_FaceValueOnDate * DaysInCoupon);
                      else
                         IncomeRate = 0.0;
                      end;
                      
                      IncomeRate = ЧислоCЗаданнойТочностью( DoubleToMoney( IncomeRate), 4);
                   end;
                else
                   IncomeRate   = "";
                end;
                CoupDrawDate = date_as_string(1, CoupDrawDate);
             else
                CoupDrawDate = "";
                IncomeRate   = "";
             end;
          else
             CoupDrawDate = "";
             IncomeRate   = "";
        end;

        return IncomeRate;
  end;

  macro getAccountRest (AccBuf)
    var sql = "declare  begin ? :=  rsb_account.restall(:account, :chapter,:currency, :repdate);  end;";
    var cmd = rsdCommand(sql);

    if(AccBuf == "----")
      return 0.00;
    end;

    cmd.AddParam( "account_rest", RSDBP_RETVAL, V_DOUBLE );
    cmd.addParam(":account", RSDBP_IN, AccBuf.rec.account);
    cmd.addParam(":chapter", RSDBP_IN, AccBuf.rec.chapter);
    cmd.addParam(":currency", RSDBP_IN, AccBuf.rec.code_currency);
    cmd.addParam(":repdate", RSDBP_IN, RepDate);
    cmd.Execute();


    if ((cmd.value("account_rest") == 0) or (cmd.value("account_rest") == NULL))
      return "Ошибка!!!";
    else 
      return cmd.value("account_rest");   
    end;
     
  End;

  /*
    Получить значение показателя обесценивания
  */
  macro getInDep(inISIN, inRepDate)
      var sql="select i.t_indicator from f657_ind_dep i "+
                                  "where i.t_isin = :inISIN "+
                                    "and i.t_date_load = (select max(di.t_date_load) from f657_ind_dep di "+
                                                                                   "where di.t_isin = :inISIN1 "+
                                                                                     "and di.t_date_load <= :inRepDate )";
      var cmd = rsdCommand(sql);
      cmd.addParam(":inISIN", RSDBP_IN, inISIN);
      cmd.addParam(":inISIN1", RSDBP_IN, inISIN);
      cmd.addParam(":inRepDate", RSDBP_IN, inRepDate);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return 0.00;
        end;
  end;

    /*
        Вернуть буфер счёта по переданному массиву категорий
    */
    macro getAccountFromCategoryName(FD, Счет, Currency, Categs)
        var cmd, RS;

        cmd = RSDCommand( " SELECT distinct accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter, categ.t_Code                             " +
                         "   FROM dmcaccdoc_dbt accdoc, dmccateg_dbt categ                                                                  " +
                         "  WHERE accdoc.t_CatID         = categ.t_ID                                                                       " +
                         "    AND accdoc.t_dockind       = ?                                                                                " +
                         "    AND accdoc.t_docid         = ?                                                                                " +
                         "    AND categ.t_LevelType      = 1                                                                                " +
                         "    AND categ.t_Code           in(?, ?)                                                                     "/* +
                         "    AND rsb_account.restall(accdoc.t_account, accdoc.t_chapter, accdoc.t_Currency, to_date(?, 'dd.mm.yyyy')) <> 0 " */);

        cmd.addParam( "", RSDBP_IN, DL_SECURLEG      );
        cmd.addParam( "", RSDBP_IN, FD.dl_leg.rec.ID );
        cmd.addParam( "", RSDBP_IN, Categs[0]        );
        cmd.addParam( "", RSDBP_IN, Categs[1]        );
        /*cmd.addParam( "", RSDBP_IN, Data.RepDate     );*/
        cmd.execute();

        RS = TRsbDataSet( cmd );
        while( RS.MoveNext() )
          if(GetAccount( RS.Chapter, RS.Currency, RS.Account, Счет, true ))
             SetParm(2, Счет);
             SetParm(3, RS.Currency);
             return true;
          end;
        end;

        SetParm(2, "");
        SetParm(3, "");
        return false;

    end;

    /*
      Вернуть строку номера счёта по имени категории и DealID сделки.
    */
    macro getAccountFromCategoryNameAndDealID (FD, Categ)
     var sql="select distinct accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter, categ.t_Code "+
                "from dmcaccdoc_dbt accdoc, dmccateg_dbt categ "+
                "where accdoc.t_CatID = categ.t_ID "+
                  "and categ.t_Code = :t_code "+  //категория учета +ОД
                  "and accdoc.t_docid = :dealid";

      var cmd = rsdCommand(sql);
      cmd.addParam(":t_code", RSDBP_IN, Categ);
      cmd.addParam(":dealid", RSDBP_IN, FD.tick.rec.dealid);
      
      cmd.Execute();
      var rs = rsdRecordSet(cmd);
      if (rs.MoveNext)
          return rs.Value(0);
      else
          return "---";
      end;
       
    End;


    /*
       Тип ценной бумаги
       Возвращает наименование системной категории
       "Код типа ц.б. для формы 711"
        
    */
    macro getAvoirKind (FD)
    
      var sql="select a.t_name "+
                "from dobjattr_dbt a "+
                "join dobjatcor_dbt c on a.t_objecttype = c.t_objecttype and a.t_groupid = c.t_groupid and a.t_attrid = c.t_attrid "+
                "where c.t_objecttype = 12 "+  //ценная бумага
                  "and c.t_groupid = 1 "+     //категория "Код типа ц.б. для формы 711"
                  "and c.t_object = lpad( :inSecID, 10, '0') "+
                  "and c.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy')";

      var cmd = rsdCommand(sql);
      cmd.addParam(":inSecID", RSDBP_IN, FD.fininstr.rec.fiid);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "---";
        end;
      
    End;

    /*
        Коэффициент для оценочного резерва
    */
    macro getCoeffEstimateRezerv(inSecID)
       //Comment macro
       
    
        var sql="select rsb_struct.getDouble(n.t_text) "+
                "from dnotetext_dbt n "+
                "where n.t_objecttype = 12 "+    //ценная бумага
                  "and n.t_notekind = 24 "+     //Коэффициент для оценочного резерва
                  "and n.t_documentid = lpad( :inSecID, 10, '0') "+
                  "and n.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy')";

      var cmd = rsdCommand(sql);
      cmd.addParam(":inSecID", RSDBP_IN, inSecID);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "---";
        end;
    End;

    /*
      Категория качества
    */
    private macro getCatergoryQuality(inSecID)
      var sql="select a.t_name "+
                "from dobjattr_dbt a "+
                "join dobjatcor_dbt c on a.t_objecttype = c.t_objecttype and a.t_groupid = c.t_groupid and a.t_attrid = c.t_attrid "+
                "where c.t_objecttype = 12 "+  //ценная бумага
                  "and c.t_groupid = 13 "+     //Категория качества
                  "and c.t_object = lpad( :inSecID, 10, '0') "+
                  "and c.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy')";

      var cmd = rsdCommand(sql);
      cmd.addParam(":inSecID", RSDBP_IN, inSecID);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "---";
        end;

    end;

    /*
      Проверить явдляется ли акцией эта бумага
    */
    macro isItShares(fininstr)
//      println(fininstr.fi_kind);
//      println(fininstr.AVOIRKIND);
//      println((fininstr.fi_kind == 2) AND ( (fininstr.AVOIRKIND == 1) OR (fininstr.AVOIRKIND == 2) OR (fininstr.AVOIRKIND == 20) ));
      return  (fininstr.fi_kind == 2) AND ( (fininstr.AVOIRKIND == 1) OR (fininstr.AVOIRKIND == 2) OR (fininstr.AVOIRKIND == 20) ) ;
    end;

  /*
	Поручители
  */
    private macro getGuarantor(inSecID)
      var sql="select rsb_struct.getString(n.t_text) "+
                "from dnotetext_dbt n "+
                "where n.t_objecttype = 12 "+    //ценная бумага
                  "and n.t_notekind = 105 "+     //511-П_Источник котировки
                  "and n.t_documentid = lpad( :inSecID, 10, '0') "+
                  "and n.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy')";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":inSecID", RSDBP_IN, inSecID);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "---";
        end;

    end;


    /*
       Возвращаем признак субординированной ЦБ
       Ввод:  fiid ценной бумаги
       Вывод: да  - 1, нет - 0
    */
    private macro getSubord(inFIID)
    var sql="select nvl(a.t_subordinated,0) from davoiriss_dbt a where a.t_fiid= :inFIID";
    
    var cmd = rsdCommand(sql);
    cmd.addParam(":inFIID", RSDBP_IN, inFIID);
    cmd.Execute();
    var getData = TRsbDataSet(cmd);
    var rs = rsdRecordSet(cmd);
    
        if (rs.MoveNext)
            if (rs.Value(0)=="X")
              return "ДА";
           else
              return "НЕТ";
           end;
       else
           return "НЕТ";
       end;
   
    end;



//-----Методы для формирования универасальных отчётов or_rep_h.mac----*/
	/*
	  Добавить ячейку к строке - формируем строку отчёта
	*/
	macro printCell(inValue)
		return Rep.AddPrintCell(inValue, 0, 2, "c", REP_ELEM_TABL);
    end;

    /*
	   Вывести строку
    */
    macro printRow()
		  Rep.AddStr();
    end;

    /*
    	Инциализируем класс Отчёта
    */
    macro initRep()
		  Rep=CMakeReport(tableHeader);
    end;

	  /*
    	Вывести заголовок
    */
    macro addHeader()
  		Rep.AddPrintCell("Дата: "+repDate,0, 0, "c:ex_FS(b):ex_FN(Arial):ex_FZ(8)", REP_ELEM_STR);
  		Rep.AddStr();
  		Rep.AddEmptyStr();
    end;

    /*
    	Показать окно отчёта
    */
    macro showRep()
  		Rep.SetWinRepOutput(0,0);                                     
  		Rep.AddWinRepOutput(WINREP_OUTPUT_EXCEL, WINREP_FORMAT_XLS);
  		Rep.SetZoomType(ZOOM_TYPE_A4L);
  		Rep.PrintWinRep(winHeader);
  		Rep.ShowWinRep(winHeader);
    end;
/*---------------------------------------------------------*/
	/*
		Запуск отчёта
	*/
    macro Run ()
    	inputRepDate();
  		initRep();
  		addHeader();
  		this.printTable();
  		showRep();
    end;
    
END;