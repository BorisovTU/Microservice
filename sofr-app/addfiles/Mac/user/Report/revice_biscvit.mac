import globals, BankInter, PaymInter, FMInter, PTInter, FIInter, likepy, oralib, wltools;
import "or_tpl_h.mac";

//читаем файл

var bis_id, bis_date, bis_sum_natval, bis_sum_inval, bis_payeracc, bis_receiveracc, bis_numdoc, bis_codeval;
var errcnt = 0;
var flag = false;
var NameFile = "..\\txtfile\\test_" + UserNumber() +".csv"; //Выходной файл с данными
var Name, Ext;
var obj :C_CSVFile = C_CSVFile();
var objExcel = CDAOMSExcel();
// Заполним файл данных 
Obj.FileOpen( NameFile, true);

macro Revice_TRN(bis_id)
 
//  var cmd = RsdCommand("select t_date_carry, t_fiid_payer, t_sum_natcur, t_sum_payer, t_account_payer, t_account_receiver, t_numb_document from dacctrn_dbt where t_acctrnid = " + TRIM(bis_id) );
  var cmd = RsdCommand("select to_char (t_date_carry,'DD/MM/YYYY') t_date_carry, t_fiid_payer, t_sum_natcur, t_sum_payer, t_account_payer, t_account_receiver, t_numb_document from dacctrn_dbt where T_USERFIELD4 = '" + bis_id + "'");

//  cmd.AddParam("", RSDBP_IN, bis_id);

  var rs = RsdRecordset(cmd);
  var acc, acc_bis;
  var sel, rs_sel;
  var cntobj = 0;
  if (rs.moveNext())
   
    if(bis_date != rs.value("t_date_carry"))     
     Obj.AddCell("Дата документа в БИСквит "+ string(bis_date) +  " не совпадает с датой документа в СОФР " + rs.value("t_date_carry"));
     Obj.AddRow();
       errcnt = errcnt + 1;
       cntobj = 1;
    end;

       acc = rs.value("t_account_payer");

                     sel =   "SELECT D.T_ACCOUNT, E.T_LEGALFORM                                                       "                                              
                             "FROM dmcaccdoc_dbt A, dmccateg_dbt B, dsfcontr_dbt C, dbrokacc_dbt D, dparty_dbt E      "
                             "WHERE A.T_ACCOUNT = '" + acc + "'                                                       "             
                             "AND A.T_ISCOMMON = 'X'                                                                  "
                             "AND E.T_PARTYID = C.T_PARTYID                                                           "
                             "AND B.T_ID = A.T_CATID                                                                  "
                             "AND (B.T_CODE = 'ДС клиента, ц/б'                                                       "
                             "AND SUBSTR(A.T_ACCOUNT, 1, 3) = '306'                                                   "
                             "OR  B.T_CODE = '+РасчетыКомисс1'                                                        "
                             "AND SUBSTR(A.T_ACCOUNT, 1, 5) = '47423')                                                "
                             "AND C.T_ID = A.T_CLIENTCONTRID                                                          "
                             "AND D.T_SERVKIND = C.T_SERVKIND                                                         "
                             "AND D.T_SERVKINDSUB = C.T_SERVKINDSUB                                                   "
                             "AND D.T_CURRENCY = A.T_CURRENCY                                                         "
                             "AND  SUBSTR(D.T_ACCOUNT, 1, 5) = SUBSTR(A.T_ACCOUNT, 1, 5) ;                            ";

       rs_sel = RsdRecordset(sel);

       if (rs_sel.moveNext())
           if(rs_sel.value("T_LEGALFORM") == 1)
               acc_bis = rs.value("t_account_payer");
           else
               acc_bis = rs_sel.value("t_account");
           end;
       else
           acc_bis = rs.value("t_account_payer");
       end;

    if(StrSubst(bis_payeracc, "-", "") != acc_bis)
       Obj.AddCell("Счет плательщика в БИСквит "+ StrSubst(bis_payeracc, "-", "") +  " не совпадает со счетом плательщика в СОФР " + string(acc_bis));
       Obj.AddRow();
       errcnt = errcnt + 1;
       cntobj = 1;
    end;
 
       rs_sel.close();

       acc = rs.value("t_account_receiver");

                     sel =   "SELECT D.T_ACCOUNT, E.T_LEGALFORM                                                       "                                              
                             "FROM dmcaccdoc_dbt A, dmccateg_dbt B, dsfcontr_dbt C, dbrokacc_dbt D, dparty_dbt E      "
                             "WHERE A.T_ACCOUNT = '" + acc + "'                                                       "             
                             "AND A.T_ISCOMMON = 'X'                                                                  "
                             "AND E.T_PARTYID = C.T_PARTYID                                                           "
                             "AND B.T_ID = A.T_CATID                                                                  "
                             "AND (B.T_CODE = 'ДС клиента, ц/б'                                                       "
                             "AND SUBSTR(A.T_ACCOUNT, 1, 3) = '306'                                                   "
                             "OR  B.T_CODE = '+РасчетыКомисс1'                                                        "
                             "AND SUBSTR(A.T_ACCOUNT, 1, 5) = '47423')                                                "
                             "AND C.T_ID = A.T_CLIENTCONTRID                                                          "
                             "AND D.T_SERVKIND = C.T_SERVKIND                                                         "
                             "AND D.T_SERVKINDSUB = C.T_SERVKINDSUB                                                   "
                             "AND D.T_CURRENCY = A.T_CURRENCY                                                         "
                             "AND  SUBSTR(D.T_ACCOUNT, 1, 5) = SUBSTR(A.T_ACCOUNT, 1, 5) ;                            ";

       rs_sel = RsdRecordset(sel);

       if (rs_sel.moveNext())
           if(rs_sel.value("T_LEGALFORM") == 1)
               acc_bis = rs.value("t_account_receiver");
           else
               acc_bis = rs_sel.value("t_account");
           end;
       else
           acc_bis = rs.value("t_account_receiver");
       end;

    if(StrSubst(bis_receiveracc, "-", "") != acc_bis)
       Obj.AddCell("Счет получателя в БИСквит "+ StrSubst(bis_receiveracc, "-", "") +  " не совпадает со счетом получателя в СОФР " + string(acc_bis));
       Obj.AddRow();
       errcnt = errcnt + 1;
       cntobj = 1;
    end;
       rs_sel.close();


    if((rs.value("t_fiid_payer") != "0") and (bis_codeval != "810"))
      if(StrSubst(bis_sum_inval, ",", "") != rs.value("t_sum_payer"))
         Obj.AddCell("Сумма платежа в БИСквит "+ string(bis_sum_inval) +  " не совпадает с суммой платежа в СОФР " + string(rs.value("t_sum_payer")));
         Obj.AddRow();
         errcnt = errcnt + 1;
         cntobj = 1;
      end;
    else
      if(StrSubst(bis_sum_natval, ",", "") != rs.value("t_sum_natcur"))
         Obj.AddCell("Сумма платежа в БИСквит "+ string(bis_sum_natval) +  " не совпадает с суммой платежа в СОФР " + string(rs.value("t_sum_natcur")));
         Obj.AddRow();
         errcnt = errcnt + 1;
         cntobj = 1;
      end;
    end;
/*
    if(bis_numdoc != rs.value("t_numb_document"))
       Obj.AddCell("Номер документа в БИСквит "+ string(bis_numdoc) +  " не совпадает с номером документа в СОФР " + string(rs.value("t_numb_document")));
       Obj.AddRow();
       errcnt = errcnt + 1;
       cntobj = 1;
    end;
*/
    if (cntobj == 1)

       Obj.AddCell("Проводка id = " + string(bis_id));   
       Obj.AddRow();

    end;

  else
     println("Не найден платеж с ID ", bis_id);
  end;
end;

  private macro StartImport()
    file CurFile() txt;
   var cnt = 0;
   var cntPSB = 0;

   var date_revise, date_file_name;
   date_revise = {curdate};


     SetDelim("\t");

   if (SelectFile (date_file_name, "*.*", "Выбирите файл для сверки", 0, true) == true)
     


     if (Open(CurFile, date_file_name))

               while(Next(CurFile))
                  cntPSB = cntPSB + 1;
               end;

               Rewind(CurFile);


      InitProgress (cntPSB, "Идет выполнение", "Выполнение сверки");

               while(Next(CurFile))
                  bis_id = CurFile(5);
                  bis_date = CurFile(4);
                  bis_numdoc = CurFile(7);
                  bis_payeracc = CurFile(8);
                  bis_receiveracc = CurFile(9);
                  bis_codeval = CurFile(10);
                  bis_sum_inval = CurFile(10);
                  bis_sum_natval = CurFile(11);

                  if(cnt > 0)
                    Revice_TRN(bis_id);
                  end;
                  if (StrBrk(CurFile.str, "\t") == StrLen(CurFile.str))
                      bis_id  = "";
                  end;
                  cnt = cnt + 1;
                  UseProgress (cnt);

               end;
/*
               while(Next(CurFile))
                  bis_id = CurFile(11);
                  bis_date = CurFile(2);
                  bis_numdoc = CurFile(9);
                  bis_payeracc = CurFile(4);
                  bis_receiveracc = CurFile(5);
                  bis_codeval = CurFile(10);
                  bis_sum_inval = CurFile(6);
                  bis_sum_natval = CurFile(7);

                  if(cnt > 0)
                    Revice_TRN(bis_id);
                  end;
                  if (StrBrk(CurFile.str, "\t") == StrLen(CurFile.str))
                      bis_id  = "";
                  end;
                  cnt = cnt + 1;
                  UseProgress (cnt);

               end;
*/
      flag = true;
  
       RemProgress;

     end;
   else
     
//     msgboxex ("Не выбран файл для сверки");
     exit(1);
   
   end;

   if((errcnt == 0) and (flag == true))
       println("Ошибок при сверке не обнаружено");
   end;


  end;

    StartImport();



  if(errcnt != 0)
    Obj.FileClose();
    SplitFile(NameFile, Name, Ext);
    if( not CopyFile(NameFile,"$Txtfile\\"+Name +  Ext) )
      msgbox("Ошибка копирования файла на терминал");
      exit( 1 );
    else
      if(objExcel.CreateApplication())
        if(objExcel.open(GetCurDir(true)+"\\TxtFile\\"+Name+Ext))
          objExcel.Application.Visible = true;
        end;
      end;
    end;
  end;

 


  