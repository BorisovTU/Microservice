/***********************************************************
/*23.09.2020 Выгрузка ДБО с изменениями условий (примечание 170). BIQ-6267. Новая вкладка ДРРК*/
************************************************************/

///import rsd; //RSBDataSet, dlgCommon,funk,dl_plib,"fiInfo.mac";
//IMPORT FIInter,rsexts,oralib,likepy,rcw;
IMPORT "likepy.mac", oralib, RsbDataSet, RsbFormsInter, "spserv.mac";
IMPORT RSD, or_rep_h, rsexts, dlgcommon;




private const FT_DATE = 9; 

var dat_rs;
var ret, day, mon, year, dat_rec, time_rec;  
/*
DateSplit(date, day,mon,year);
if (day < 10)
  day = string(0,day)
end;
  dat_rec =string (day,".",mon,".",year);

  time_rec = dat_rec+" "+string(time) ;
**/

 var sql_cnt = "with Coun AS "+
          "(select  prsn.t_personid persid, count(prsn.t_personid)  cnt  "+
          "FROM ddlcontr_dbt ddlcontr, dpersn_dbt prsn, dsfcontr_dbt sfcontr, "+
          "dobjcode_dbt code WHERE     "+
          "sfcontr.t_ID=ddlcontr.t_SfContrID AND prsn.t_PersonID=sfcontr.t_PartyID   "+
          "and code.t_objectid = prsn.t_PersonID   "+
          "AND code.t_objecttype = 3 and code.t_codekind = 1 and code.T_BANKCLOSEDATE = to_date('01.01.0001','DD.MM.YYYY')   "+
          "AND sfcontr.T_DATECLOSE = to_date('01.01.0001','DD.MM.YYYY')   "+
          "AND ddlcontr.t_iis != chr(88) "+ //28.09 исключим договора ИИС
          "group by  prsn.t_personid)  "+
          "select max(cnt) Cnt_Max from Coun ";

var sql_RS = "select  nvl(code.T_CODE,0) Code, prsn.T_NAME1 NAME1 ,  prsn.T_NAME2 NAME2, prsn.T_NAME3 NAME3,  "+
          "sfcontr.t_number Cntr_Num,  sfcontr.T_DATEBEGIN DT_BEG, rsb_struct.getdate(text.t_text) Dt_Chng "+
          "FROM ddlcontr_dbt ddlcontr, dpersn_dbt prsn, dsfcontr_dbt sfcontr, dnotetext_dbt text, dobjcode_dbt code WHERE   "+
          "sfcontr.t_ID=ddlcontr.t_SfContrID AND prsn.t_PersonID=sfcontr.t_PartyID "+
          "AND trim (LEADING '0' from text.t_documentid)=ddlcontr.t_dlcontrid and code.t_objectid = prsn.t_PersonID "+
          "AND code.t_objecttype = 3 and code.t_codekind = 1 and code.T_BANKCLOSEDATE = to_date('01.01.0001','DD.MM.YYYY') "+ //ID клиента в ГО. уточнить, этот ли нужен код?
          "AND text.t_objecttype = 207  "+ // договор брокерского обслуживания
          "AND text.t_notekind = 170  "+ //примечание 170 "Дата изменения в исходной системе"
          "AND text.t_validtodate = to_date('31.12.9999','DD.MM.YYYY') "+ //действующее примечание
          "AND sfcontr.T_DATECLOSE = to_date('01.01.0001','DD.MM.YYYY') "+ // действующий договор
          " AND rsb_struct.getdate(text.t_text) >= :0 "+ //даты внесения изменений, по примечанию 170
          " AND rsb_struct.getdate(text.t_text) <= :1 ";

var sql_DRRK = "select  distinct nvl(code.T_CODE,0) Code, prsn.T_NAME1 NAME1 ,  prsn.T_NAME2 NAME2, prsn.T_NAME3 NAME3  "+
          "FROM ddlcontr_dbt ddlcontr, dpersn_dbt prsn, dsfcontr_dbt sfcontr, " +
          "dobjcode_dbt code WHERE   "+
          "sfcontr.t_ID=ddlcontr.t_SfContrID AND prsn.t_PersonID=sfcontr.t_PartyID "+
          "AND code.t_objectid = prsn.t_PersonID "+
          "AND code.t_objecttype = 3 and code.t_codekind = 1 and code.T_BANKCLOSEDATE = to_date('01.01.0001','DD.MM.YYYY') "+ //ID клиента в ГО. уточнить, этот ли нужен код?
          "AND sfcontr.T_DATECLOSE = to_date('01.01.0001','DD.MM.YYYY') " + // действующий договор
         //" AND sfcontr.T_DATEbegin > to_date('01.03.2020','DD.MM.YYYY') ";//+ //;//ОТЛАДКА!!!
         " and code.T_CODE in ('00#P#13218251', '00#P#6238532','0#P#11446073','00#P#7946563','00#P#11448129','00#P#10110930','00#P#4921988') ";//ОТЛАДКА!!!

        
var sql_cntr_num = "select sfcontr.t_number Cntr_Num, sfcontr.T_DATEBEGIN  Dt_Beg,  "+
   "decode (text.t_text, '', '', rsb_struct.getdate(text.t_text)) Dt_Chng "+
    "           FROM ddlcontr_dbt ddlcontr "+
     "     left join dnotetext_dbt text on "+
      "    (  trim (LEADING '0' from text.t_documentid) = ddlcontr.t_dlcontrid  "+
      "      AND text.t_objecttype = 207  "+ // договор брокерского обслуживания
      "      AND text.t_notekind = 170  "+ //примечание 170 "Дата изменения в исходной системе"
      "      AND text.t_validtodate = to_date('31.12.9999','DD.MM.YYYY') "+
      "    ) "+
      "    inner join dsfcontr_dbt sfcontr on sfcontr.t_ID=ddlcontr.t_SfContrID "+
      "    inner join dpersn_dbt prsn on prsn.t_PersonID=sfcontr.t_PartyID  "+
      "    inner join dobjcode_dbt code  on code.t_objectid = prsn.t_PersonID "+
      "    WHERE "+
      "    code.t_objecttype = 3 and code.t_codekind = 1 and code.T_BANKCLOSEDATE = to_date('01.01.0001','DD.MM.YYYY') "+
      "    AND sfcontr.T_DATECLOSE = to_date('01.01.0001','DD.MM.YYYY') "+
      "    AND ddlcontr.t_iis != chr(88) "+ //28.09 исключим договора ИИС
      "    AND code.T_CODE = :0 ";

var sql_cntr_num_IIS = "select sfcontr.t_number Cntr_Num, sfcontr.T_DATEBEGIN  Dt_Beg,  "+
      "decode (text.t_text, '', '', rsb_struct.getdate(text.t_text)) Dt_Chng "+
      "           FROM ddlcontr_dbt ddlcontr "+
      "     left join dnotetext_dbt text on "+
      "    (  trim (LEADING '0' from text.t_documentid) = ddlcontr.t_dlcontrid  "+
      "      AND text.t_objecttype = 207  "+ // договор брокерского обслуживания
      "      AND text.t_notekind = 170  "+ //примечание 170 "Дата изменения в исходной системе"
      "      AND text.t_validtodate = to_date('31.12.9999','DD.MM.YYYY') "+
      "    ) "+
      "    inner join dsfcontr_dbt sfcontr on sfcontr.t_ID=ddlcontr.t_SfContrID "+
      "    inner join dpersn_dbt prsn on prsn.t_PersonID=sfcontr.t_PartyID  "+
      "    inner join dobjcode_dbt code  on code.t_objectid = prsn.t_PersonID "+
      "    WHERE "+
      "    code.t_objecttype = 3 and code.t_codekind = 1 and code.T_BANKCLOSEDATE = to_date('01.01.0001','DD.MM.YYYY') "+
      "    AND sfcontr.T_DATECLOSE = to_date('01.01.0001','DD.MM.YYYY') "+
      "    AND ddlcontr.t_iis = chr(88) "+
      "    AND code.T_CODE = :0  "; 
         
private  macro GetAccInfoToXls_DRRK (dt_beg, dt_end) 
   var sql_Xls, acc_prev="";
            var acc_cnt = 0;
    
                  sql_Xls = ExecSqlSelect(sql_RS, MakeArray( SqlParam("0", Dt_Beg),
                                  SqlParam("1", Dt_End),
                                  sqlParam("2", V_INTEGER, RSDBP_RETVAL)), false);

                  if (sql_Xls == null)
                    msgbox ("Ошибка выгрузки даннных в Excel.");
                  else 
                  //Заголовки Excel
                     var color = 65535;
                     var rs2;
                     var sheet = 1;
                     var rn = 0; 
                     var head_format = "c:ex_FS(b):ex_B(tblr):ex_BC(" + color + ")";
                     var line_format_l_b = "l:ex_B(tblr):ex_FZ(10):ex_FS(b)";
                     var Rep = CMakereport("");
                   

                      Rep.SetDefaultFontName("Times New Roman");
                      Rep.SetDefaultFontSize(10);
                      Rep.SetFlagShowGrid(true);
                     

                    //  Rep.SetExecute("iBook.Sheets("+sheet+").Rows().RowHeight = 15;");
                      Rep.SetExecute("iBook.Sheets("+sheet+").Columns(1).ColumnWidth = 20;");
                      Rep.SetExecute("iBook.Sheets("+sheet+").Columns(2).ColumnWidth = 15;");
                      Rep.SetExecute("iBook.Sheets("+sheet+").Columns(3).ColumnWidth = 15;");
                      Rep.SetExecute("iBook.Sheets("+sheet+").Columns(4).ColumnWidth = 15;");
                      Rep.SetExecute("iBook.Sheets("+sheet+").Columns(5).ColumnWidth = 20;");
                      Rep.SetExecute("iBook.Sheets("+sheet+").Columns(6).ColumnWidth = 20;");
                      Rep.SetExecute("iBook.Sheets("+sheet+").Columns(7).ColumnWidth = 25;");
                  
                      rn = rn + 1;
                     
                      Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"A"+rn+":B"+rn+":C"+rn+":D"+rn+":E"+rn+":F"+rn+":G"+rn+":H"+rn+":I"+rn+":J"+rn+":K"+rn+"\")");//.Merge;");
                      Rep.AddPrintCell("ID клиента в ГО",0, 0, head_format); 
                      Rep.AddPrintCell("Фамилия",0, 0, head_format);
                      Rep.AddPrintCell("Имя",0, 0, head_format); 
                      Rep.AddPrintCell("Отчество",0, 0, head_format);
                      Rep.AddPrintCell("№ договора",0, 0, head_format); 
                      Rep.AddPrintCell("Дата договора",0, 0, head_format);
                      Rep.AddPrintCell("Последняя Дата изменения условий Договора БО или ИИС в СОФР",0, 0, head_format);
               
                      Rep.AddStr();
                  
                      rn = rn + 1;
                  
                    while(sql_Xls.moveNext())
                                
                       Rep.AddPrintCell(string(sql_Xls.value("Code")),0, 0, line_format_l_b);
                       Rep.AddPrintCell(string(sql_Xls.value("Name1")),0, 0, line_format_l_b);
                       Rep.AddPrintCell(string(sql_Xls.value("Name2")),0, 0, line_format_l_b);
                       Rep.AddPrintCell(string(sql_Xls.value("Name3")),0, 0, line_format_l_b);
                       Rep.AddPrintCell(string(sql_Xls.value("Cntr_Num")),0, 0, line_format_l_b);
                       Rep.AddPrintCell(string(date(sql_Xls.value("Dt_Beg"))),0, 0, line_format_l_b);
                       Rep.AddPrintCell(string(date(sql_Xls.value("Dt_Chng"))),0, 0, line_format_l_b);
                     
                       Rep.AddStr();
                       rn = rn + 1;
             
                      acc_cnt = acc_cnt + 1;
         
                    end;  
          
                  end;  
     
            var sql_Max, sql_Cntr, Dt_Chng_last, Cntr_Chng_last, Cntr_Num, sql_Cntr_IIS; 
            var cntr_cnt = 0, cntr_cnt_max = 0;
            var load_to = "Excel";
            sheet = 2;
                 
                  sql_Max = ExecSqlSelect(sql_cnt, MakeArray( SqlParam("0", V_INTEGER, RSDBP_RETVAL)), false);
                  if (sql_Max.moveNext())
                
                   cntr_cnt_max = sql_Max.value("Cnt_Max");
                  end;

                  sql_Xls = ExecSqlSelect(sql_DRRK, MakeArray(sqlParam("0", V_INTEGER, RSDBP_RETVAL)), false);

                  if (sql_Xls == null)
                    msgbox ("Ошибка выгрузки даннных в Excel.");
                  else 
    
                      Rep.AddNewSheetBreak("Вар ДРРК") ;

                      Rep.SetDefaultFontName("Times New Roman");
                      Rep.SetDefaultFontSize(10);
                      Rep.SetFlagShowGrid(true);
    
                     
                     
                      Rep.SetExecute("iBook.Sheets("+sheet+").Columns(1).ColumnWidth = 20;");
                      Rep.SetExecute("iBook.Sheets("+sheet+").Columns(2).ColumnWidth = 15;");
                      Rep.SetExecute("iBook.Sheets("+sheet+").Columns(3).ColumnWidth = 15;");
                      Rep.SetExecute("iBook.Sheets("+sheet+").Columns(4).ColumnWidth = 15;");
                 
                                           rn = rn + 1;
                   
                      Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"A"+rn+":B"+rn+":C"+rn+":D"+rn+":E"+rn+":F"+rn+":G"+rn+":H"+rn+":I"+rn+":J"+rn+":K"+rn+"\")");//.Merge;");
                      Rep.AddPrintCell("ID клиента в ГО",0, 0, head_format); 
                      Rep.AddPrintCell("Фамилия",0, 0, head_format);
                      Rep.AddPrintCell("Имя",0, 0, head_format); 
                      Rep.AddPrintCell("Отчество",0, 0, head_format);
                      cntr_cnt=1;
                      while (cntr_cnt<=cntr_cnt_max)
                        Rep.AddPrintCell("№ договора БО"+cntr_cnt,0, 0, head_format); 
                        Rep.AddPrintCell("Дата договора БО"+cntr_cnt,10, 0, head_format);
                        cntr_cnt = cntr_cnt + 1;
                      end;
                      Rep.AddPrintCell("№ договора ИИС",0, 0, head_format); //28.09
                      Rep.AddPrintCell("Дата договора ИИС",10, 0, head_format); //28.09
                      Rep.AddPrintCell("Последняя Дата изменения условий Договора БО или ИИС в СОФР",10, 0, head_format);
                      Rep.AddPrintCell("Номер договора, в который внесены изменения",0, 0, head_format);
                      Rep.AddStr();

                      rn = rn + 1;
                 
                    while(sql_Xls.moveNext())
                       //     msgbox (string(sql_Xls.value("Code")));        
                       Rep.AddPrintCell(string(sql_Xls.value("Code")),0, 0, line_format_l_b);
                       Rep.AddPrintCell(string(sql_Xls.value("Name1")),0, 0, line_format_l_b);
                       Rep.AddPrintCell(string(sql_Xls.value("Name2")),0, 0, line_format_l_b);
                       Rep.AddPrintCell(string(sql_Xls.value("Name3")),0, 0, line_format_l_b);
                       cntr_cnt=1;
                       
                       sql_Cntr = ExecSqlSelect(sql_cntr_num, MakeArray( SqlParam("0", string(sql_Xls.value("Code"))),
                                                                        sqlParam("1", V_INTEGER, RSDBP_RETVAL)), false);
                      
                       Dt_Chng_last = date("01.01.1001") ;
                       Cntr_Chng_last ="";
                       Cntr_Num = string("0") ;
                      
                       while ((sql_Cntr.moveNext()) or (cntr_cnt<=cntr_cnt_max)) 
                         if ( Cntr_Num != sql_Cntr.value("Cntr_Num"))  
                            Rep.AddPrintCell(string(SpecialValue0ToEmpty(sql_Cntr.value("Cntr_Num"))),0, 0, line_format_l_b);
                            //Rep.AddPrintCell(string(date(SpecialValue0ToEmpty(sql_Cntr.value("Dt_Beg")))),0, 0, line_format_l_b);
                            Rep.AddPrintCell(date(SpecialValue0ToEmpty(sql_Cntr.value("Dt_Beg"))),0, 0, line_format_l_b);//30.09
                         else 
                            Rep.AddPrintCell(string(""),0, 0, line_format_l_b);
                           // Rep.AddPrintCell(string(""),0, 0, line_format_l_b);
                            Rep.AddPrintCell(date(""),0, 0, line_format_l_b); //30.09
                         end; 
                         Cntr_Num = sql_Cntr.value("Cntr_Num") ;

                         if (date(Dt_Chng_last) < NVL (SpecialValue0ToEmpty(date(substr(sql_Cntr.value("Dt_Chng"),1,8))), date("01.01.1001") ))
                          Dt_Chng_last = date(substr(sql_Cntr.value("Dt_Chng"),1,8)) ;
                          Cntr_Chng_last = sql_Cntr.value("Cntr_Num") ;
                         end;  
                         cntr_cnt=cntr_cnt+1;
                       end;   

                        sql_Cntr_IIS = ExecSqlSelect(sql_cntr_num_IIS, MakeArray( SqlParam("0", sql_Xls.value("Code")),
                                                                        sqlParam("1", V_INTEGER, RSDBP_RETVAL)), false); 
                        if (sql_Cntr_IIS.moveNext())
                          Rep.AddPrintCell(string(sql_Cntr_IIS.value("Cntr_Num")),0, 0, line_format_l_b);
                          //Rep.AddPrintCell(string(date(sql_Cntr_IIS.value("Dt_Beg"))),0, 0, line_format_l_b);
                          Rep.AddPrintCell(date(sql_Cntr_IIS.value("Dt_Beg")),0, 0, line_format_l_b); //.09

                          if (date (Dt_Chng_last) <  NVL (SpecialValue0ToEmpty(date(substr(sql_Cntr_IIS.value("Dt_Chng"),1,8))), date("01.01.1001") ))
                            Dt_Chng_last = date(substr(sql_Cntr_IIS.value("Dt_Chng"),1,8)) ;
                            Cntr_Chng_last = sql_Cntr_IIS.value("Cntr_Num") ;
                          end;
                        else 
                          Rep.AddPrintCell(string(""),0, 0, line_format_l_b);
                          //Rep.AddPrintCell(string(""),0, 0, line_format_l_b);
                          Rep.AddPrintCell(date(""),0, 0, line_format_l_b); //30.09
                        end;  
                        if (Dt_Chng_last == date("01.01.1001"))
                          Dt_Chng_last = ""; 
                        end;  
                      // Rep.AddPrintCell(string(Dt_Chng_last),0, 0, line_format_l_b);
                       Rep.AddPrintCell(date(Dt_Chng_last),0, 0, line_format_l_b); //30.09
                       Rep.AddPrintCell(string(Cntr_Chng_last),0, 0, line_format_l_b);
                      
                       Rep.AddStr();
                       rn = rn + 1;
             
                      acc_cnt = acc_cnt + 1;

                    end;  
            
            Rep.PrintWinRep("Вар RS");
            Rep.SetZoomType(ZOOM_TYPE_A4L); /*альбомная ориентация*/
            Rep.SetWinRepOutput();
            Rep.ShowWinRep();
            
                  end;  
         
          return acc_cnt;             
      end; 



class (TRsbPanel) InputPeriod
  InitTRsbPanel();
  setSize(27,8);
  setPosition(2,2);

//Поля для определения периода
      var m_sEditFld_Dt_Beg:Date = {curdate};
      ///var m_sEditFld_Dt_Beg:Date = date("08.04.2020"); // отладка!
      var m_EditField_Dt_Beg:TRsbEditField = TRsbEditField(FT_DATE);
      m_EditField_Dt_Beg.bindValue(this, "m_sEditFld_Dt_Beg", 20);
      m_EditField_Dt_Beg.setPosition(15,2);
      m_EditField_Dt_Beg.setSize(10,1);
      addControl(m_EditField_Dt_Beg);

      var m_sEditFld_Dt_End:Date = {curdate};
      var m_EditField_Dt_End:TRsbEditField = TRsbEditField(FT_DATE);
      m_EditField_Dt_End.bindValue(this, "m_sEditFld_Dt_End", 20);
      m_EditField_Dt_End.setPosition(15,4);
      m_EditField_Dt_End.setSize(10,1);
      addControl(m_EditField_Dt_End);
      

//Текстовые метки
      var m_LabelRB1_Dt_Beg:TRsbLabel = TRsbLabel(3, 2, "Начало периода:");
       addLabel(m_LabelRB1_Dt_Beg);
      var m_LabelRB1_Dt_End:TRsbLabel = TRsbLabel(3, 4, "Конец периода:");
       addLabel(m_LabelRB1_Dt_End);

//Кнопки 

      var m_PushB_RnnXls:TRsbPushButton = TRsbPushButton("В Excel");
      m_PushB_RnnXls.setPosition(4,6);
      m_PushB_RnnXls.setSize(7,1);
      m_PushB_RnnXls.onClicked(R2M(this, "RunnXls"));
      addControl(m_PushB_RnnXls);

      var m_PushB_Canc:TRsbPushButton = TRsbPushButton("Отмена");
      m_PushB_Canc.setPosition(16,6);
      m_PushB_Canc.setSize(7,1);
      m_PushB_Canc.onClicked(R2M(this, "Cancell"));
      addControl(m_PushB_Canc);

      macro Cancell(RsbEvent)
          if (RsbEvent.id == RSB_EV_BUTTON_CLICKED)
            close(0);
          end;
      return true;
      end;

      macro RunnXls(RsbEvent)
      var cnt;
          if (RsbEvent.id == RSB_EV_BUTTON_CLICKED)
            BegAction(1,"Выгрузка данных в Excel...");
            cnt = GetAccInfoToXls_DRRK (m_EditField_Dt_Beg.Value, m_EditField_Dt_End.Value);
            close(0);
        //  msgbox("Выгружено "+cnt+" счетов в Excel.");  
          end;
      return true;
      end;

   end;

  var panel = InputPeriod;

  panel.setCaption("Введите период:");
  
  panel.run;
 
  exit(1);
end;




