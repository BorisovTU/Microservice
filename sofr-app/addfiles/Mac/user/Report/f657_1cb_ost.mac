/********************************************************************************************
 DESCRIPTION  :   Отчет Ф657_1 Портфель ЦБ
 PROGRAMMED BY:   Суворов А.Г.
 CREATION DATE:   
********************************************************************************************/
Import "f657.mac", "scservop.mac"; //Импорт базового класса

private const
   /* Идентификаторы учетных портфелей. */
   PortfID_Undef             = 0,
   PortfID_Trade             = 1,   /* ТП */
   PortfID_Sale              = 2,   /* ППР */
   PortfID_Contr             = 3,   /* ПКУ */
   PortfID_Promissory        = 4,   /* ПДО */
   PortfID_Retire            = 5,   /* ПУДП */
   PortfID_Back              = 6,   /* ПВО */
   PortfID_Unadmitted_TP     = 7,   /* БПП_TП */
   PortfID_Unadmitted        = 7,   /* БПП */
   PortfID_OD_req            = 8,   /* ПВО_БПП */
   PortfID_OD_com            = 9,   /* -ОД */
   PortfID_Unadmitted_PPR    = 10,  /* БПП_ППР */
   PortfID_Unadmitted_RETIRE = 11,  /* БПП_ПУДП */
   PortfID_Unadmitted_CONTR  = 12,  /* БПП_ПКУ */
   PortfID_Back_KSU          = 13,  /* ПВО_КСУ */
   PortfID_Back_BPP_KSU      = 14;  /* ПВО_БПП_КСУ */

class (repf657) repf657_1()
//Применить конструктор родительского класса
    Initrepf657();

    var  account = TRecHandler( "account" ),
         dl_tick = TRecHandler( "dl_tick" ),
         dl_leg  = TRecHandler( "dl_leg" ),
        fininstr = Trechandler( "fininstr" ), /* фин. инструмент*/
        avoiriss = Trechandler( "avoiriss" ), /* бумага*/
        AvKindShName;

    var Group, LegKind, IsBack, selectbpp, pmwbpp, IsQuoted;
    
    //Конструктор 
    //Заголовок таблицы
    tableHeader = header_f657_1_2;
    //Заголовок окна
    winHeader = "Ф657_1";

    private macro IsEvroOblig(fininstr)
       var Dt = TRsbDataSet(" select "+ 
                            " RSB_FIINSTR.FI_AVRKINDSEQ("+fininstr.rec.fi_kind+", 28, "+fininstr.rec.avoirkind+") + " + 
                            " RSB_FIINSTR.FI_AVRKINDSEQ("+fininstr.rec.fi_kind+", 39, "+fininstr.rec.avoirkind+") + " + 
                            " RSB_FIINSTR.FI_AVRKINDSEQ("+fininstr.rec.fi_kind+", 41, "+fininstr.rec.avoirkind+") + " + 
                            " RSB_FIINSTR.FI_AVRKINDSEQ("+fininstr.rec.fi_kind+", 27, "+fininstr.rec.avoirkind+") + " + 
                            " RSB_FIINSTR.FI_AVRKINDSEQ("+fininstr.rec.fi_kind+", 43, "+fininstr.rec.avoirkind+")  evr " + 
                            "  from dual ");
       if (Dt.movenext())
          return Dt.Evr;
       else
          return 0; //ошибка, что-то пошло не так
       end;
    end;
    /****************Получаем значения для некоторых полей отчёта**************/
    /*
      Получить котировку (курс) за дату
      Здесь берётся курс за дату ...
      Для бумажек это процент... от чего то
                         
-- BPV по облигациям котировки обычно % от номинала. Если брать селектами, то нужно смотреть на признак relativeprice
-- лучше использовать что-нибудь готовое, хотя в плане курсов, с этим всегда проблемы ...

    */

     /*вспомогательная, скопирована из spserv.mac*/
     PRIVATE MACRO ПолучитьПрямойКурсПоТипу( RateRec, RateDate:DATE, fiidTo:INTEGER, fiidFrom:INTEGER, Type:INTEGER ):INTEGER
       VAR Data, Query, ErrorFlag = -1;
       if( Type > 0 )
          Query = RSDCommand(
                    "SELECT t_rateid "+
                    "  FROM (SELECT t_rateid "+
                    "            FROM (SELECT rate.t_rateid, rate.t_sincedate "+
                    "                    FROM dratedef_dbt rate "+
                    "                   WHERE rate.t_otherfi = ? "+ /*string(Fiid_from) */
                    "                     AND rate.t_FIID    = ? "+ /*string(FIIDT_to) */
                    "                     AND rate.t_type    = ? "+ /*string(type) */
                    "                     AND t_sincedate    = (SELECT MAX (t_sincedate) "+
                    "                                             FROM dratedef_dbt "+
                    "                                            WHERE     t_otherfi = rate.t_otherfi "+
                    "                                                  AND t_type    = rate.t_type  "+
                    "                                                  AND t_sincedate <= ? "+ /*RateDate*/
                    "                                          ) "+
                    "                  UNION "+
                    "                    SELECT r.t_rateid, h.t_sincedate "+
                    "                      FROM dratehist_dbt h, dratedef_dbt r "+
                    "                     WHERE     r.t_rateid    = h.t_rateid "+
                    "                           AND r.t_otherfi   = ? "+  /*string(Fiid_from) */
                    "                           AND r.t_FIID      = ? "+ /*string(FIIDT_to) */
                    "                           AND r.t_type      = ? "+ /*string(type) */
                    "                           AND h.t_sincedate = ( SELECT MAX (h2.t_sincedate) "+
                    "                                                   FROM dratehist_dbt h2, dratedef_dbt r2 "+
                    "                                                  WHERE r2.t_rateid  = h2.t_rateid "+
                    "                                                    AND r2.t_otherfi = r.t_otherfi "+
                    "                                                    AND r2.t_type    = r.t_type  "+
                    "                                                    AND h2.t_sincedate <= ?  "+ /*RateDate*/
                    "                                               ) "+
                    "                 ) "+
                    "        ORDER BY t_sincedate DESC "+
                    "       ) "+
                    " WHERE ROWNUM = 1 "
                            );
         Query.addParam( "", RSDBP_IN, fiidFrom );
         Query.addParam( "", RSDBP_IN, fiidTo );
         Query.addParam( "", RSDBP_IN, Type );
         Query.addParam( "", RSDBP_IN, RateDate );
         Query.addParam( "", RSDBP_IN, fiidFrom );
         Query.addParam( "", RSDBP_IN, fiidTo );
         Query.addParam( "", RSDBP_IN, Type );
         Query.addParam( "", RSDBP_IN, RateDate );
         Query.execute();
         Data = TRsbDataSet( Query );
         if( Data.MoveNext() )
             ErrorFlag = ПолучитьКурс( RateRec, SQL_ConvTypeInteger( Data.rateid ) ); 
         end;
       end;
       return ErrorFlag;
     END;  
     /*вспомогательная, скопирована из spserv.mac*/
     PRIVATE MACRO ПолучитьКурсПоТипу( RateRec, RateDate:DATE, fiidTo:INTEGER, fiidFrom:INTEGER, Type:INTEGER ):INTEGER
        VAR ErrorFlag = ПолучитьПрямойКурсПоТипу( RateRec, RateDate, fiidTo, fiidFrom, Type );
        if( ErrorFlag )
           ErrorFlag = ПолучитьПрямойКурсПоТипу( RateRec, RateDate, fiidFrom, fiidTo, Type );
           if( not ErrorFlag )
              RateRec.IsInverse = IIF( RateRec.IsInverse == SET_CHAR, UNSET_CHAR, SET_CHAR );
           end;
        end;
        return ErrorFlag;
     END;
     /* Котировка по ценной бумаге. Упрощенная, без учета обратных котировок, без учета облигаций с индексируемым номиналом*/
     /* IsRelative - сюда возвращаем признак, что котировка получилась в %  */
    private macro getAvrRate(fininstr, type, IsRelative:@string)
       macro CalcK( RateRec )
          return RateRec.Rate / RateRec.Scale / pow(10, RateRec.Point);
       end;
       record RateRec(ratedef);
       var errorFlag, RetVal = $0.0;
       ErrorFlag = ПолучитьКурсПоТипу( RateRec, RepDate, fininstr.rec.FaceValueFI, fininstr.rec.FIID, Type );
       if (not ErrorFlag)
          if( (ПолучитьЗначениеКурса( RateRec, RepDate) == 0) and (RateRec.OtherFI == fininstr.rec.FIID) )
             RetVal = CalcK(RateRec);
          end;
       end;
       //SetParm(2, RateRec.isRelative);
       isRelative = RateRec.isRelative;
       return RetVal;
  /*  этот кусок хорош, но возвращает все в абсолютном выражении. Оставлю для истории. */ 
  /* Пользователи попросили сделать чтоб было так, как было в их предыдущей системе, поэтому этот пришлось исключить. */
/*       var erFlag, SinceDate;
       var retval =  GetRateOnDate( RepDate, fininstr.rec.FIID, fininstr.rec.FaceValueFI, false, type, erFlag, SinceDate );
       if( erFlag == false )
          return RetVal;
       else
          return $0.0;
       end;  */
    end;
    /*эта функция все еще используется по валюте, но так лучше не делать. Обычно используется SmartConvertSum или подобное*/
    macro getQuotation (fiid, type)
       
      var sql = " SELECT x.rate " +
                "        FROM ( " +
//                " /*История после изменения*/ " +
                "              SELECT history.t_sincedate AS RateDate, " +
                "                nvl( history.t_rate / power(10, history.t_point),0) AS Rate " +
                "                FROM dratehist_dbt history, " +
                "                     dfininstr_dbt fininstr, " +
                "                     dratedef_dbt ratedef " +
                "               WHERE     ratedef.t_rateid = history.t_rateid " +
                "                     AND ratedef.t_otherfi = fininstr.t_fiid " +
                "                     AND fininstr.t_fiid =  ?" + //String(fiid) +
                "                     AND history.t_sincedate <= ?" + //GetSQLDate(repDate) +
                "                     AND RATEDEF.T_TYPE = ? " +
                "              UNION " +
//                "              /*Курс до изменения*/ " +
                "              SELECT d.t_sincedate AS RateDate, " +
                "                nvl( d.t_rate / power(10, d.t_point),0) AS Rate " +
                "                FROM dratedef_dbt d " +
                "               WHERE     D.T_OTHERFI = ? " +
                "                     AND D.T_SINCEDATE <= ? " +
                "                     AND D.T_TYPE = ?) x " +
                "    ORDER BY X.RateDate DESC ";

      var cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, fiid);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.addParam("", RSDBP_IN, type);
      cmd.addParam("", RSDBP_IN, fiid);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.addParam("", RSDBP_IN, type);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);
      
      if(getData.MoveNext)
       return Double(getData.Value(0));  
      else 
       return 0;
      end;


    End;
        
  /*
        Получить рыночную стоимость В рублёвом эквиваленте.
    */
    macro getMarketPriceRUR(MarketPriceCUR, fininstr, Data)
      var QoutationFace;
      if(fininstr.FaceValueFI == 0)
        return MarketPriceCUR;
      end;
      QoutationFace = getQuotation (fininstr.FaceValueFI, 7); //7 - Курс ЦБ
      return Money(MarketPriceCUR * QoutationFace);

    end;


    /*
        Получить рыночную стоимость В ВАЛЮТЕ бумаг
    */
    macro getMarketPriceCUR(AvarAmount, Quotation, fininstr, Data, IsRelative)
      if(ISRelative == StrFor(88))

         Quotation = GetFaceValue(fininstr.FIID, RepDate) * Quotation/100;
      
      end;

      return  Money(AvarAmount * Quotation + Data.COUPON_AMOUNT + Data.UNKD_WITH_COUPON);

    end;
    
    /*
      Получить средневзвешенную цену
    */

    macro getAveragePrice (fininstr, Data)
       //Comment macro
       var PriceRUR, PriceCUR;

       GetRateByFininstr(fininstr, SP_RATETYPE_MediumPrice, @PriceRUR, @PriceCUR);
       if (PriceCUR != 0)
          return "Да";
       else
          return "Нет";
       end;
    End;

    /*
        Количество дней просрочки
        
    */
    macro getDelinquencyDays (InvestmentsAccountNumber, fininstr)
      if((SubStr(InvestmentsAccountNumber,1,5) == "50505") and (RepDate > fininstr.drawingdate))
        return Date(RepDate) - Date(fininstr.drawingdate);
      else
        return 0;
      end;
       
    End;

    /*Процедура получения значения плавающей ставки купона*/
     Macro Get_float_rate(fininstr)
        var Dt =TRsbDataSet(" select "+ 
                            " RSB_FIINSTR.FI_AVRKINDSEQ("+fininstr.rec.fi_kind+", 17, "+fininstr.rec.avoirkind+")  evr " + 
                            "  from dual ");
        Dt.movenext();
        if (dt.value(0) ==1)
           var Sql = TRsbDataSet(" select t_floatingrate from davoiriss_dbt where t_fiid = " + fininstr.rec.fiid);
           sql.movenext();
           if (sql.value(0) == "X")
              return "Плавающая";
           else
              return "Фиксированная";
           end;
        else
           return "";
        end;
     end;

    //подсчет количества возвращаемых запросом записей
    private macro countForProgressBar(inSql)
        var cmd, countrec;
            
            cmd = rsdCommand("select count(*) c from ("+inSql+") tab");
            cmd.addParam("", RSDBP_IN, repDate);            
            cmd.execute();
            
            countrec = TRsbDataSet(cmd);
            
            if (countrec.MoveNext)
                return countrec.Value(0);
            else
                return 0;
            end;
    end;

    /**************************************************************************/
    /*
      Получить рекордсет fininstr
    */
    macro getFininstr(isin, lsin)
      
      var cmd;

      if ((isin == "") and (lsin != ""))
       cmd = rsdCommand("select f.* from dfininstr_dbt f, davoiriss_dbt a where f.t_fiid = a.t_fiid and a.t_lsin = ?");
       cmd.addParam("", RSDBP_IN, lsin); 
      elif((isin != "") and (lsin == ""))               
       cmd = rsdCommand("select f.* from dfininstr_dbt f, davoiriss_dbt a where f.t_fiid = a.t_fiid and a.t_isin = ?");
       cmd.addParam("", RSDBP_IN, isin);
      elif((isin != "") and (lsin != ""))               
       cmd = rsdCommand("select f.* from dfininstr_dbt f, davoiriss_dbt a where f.t_fiid = a.t_fiid and a.t_isin = ? and a.t_lsin = ?");
       cmd.addParam("", RSDBP_IN, isin);
       cmd.addParam("", RSDBP_IN, lsin); 
      else
        // msgbox("Надо по другому искать FIID. Поиск по lsin , isin -- не канает. Оба значения МОГУТ БЫТЬ ПУСТЫМИ!!!!");
         exit;
      end;

      cmd.Execute();
      var getData = TRsbDataSet(cmd);
      
      if(getData.MoveNext)
       return getData;  
      else 
       return false;
      end;

      onError
       return false;
    end;

    /*
      Получить рекордсет avoiriss
    */
    macro getAvoiriss(fiid)
      var cmd = rsdCommand("select a.* from davoiriss_dbt a where a.t_fiid = ?");
      cmd.addParam("", RSDBP_IN, fiid);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);
      
      if(getData.MoveNext)
       return getData;  
      else 
       return false;
      end;

      onError
       return false;
    end;
    
    /*
      Если значение не определено выводить "---"
    */

    macro ClearStr(str)
      If (str == null)
        return "---";
      else
        return str;
      end;

    end;

    macro isExistDataForReport(sql)
      //return false;
      var cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);
      
      if(getData.MoveNext)
       return true;  
      else 
       return false;
      end;

      onError
       return false;
    end;
    


    /*
      Получить Открытое количество ЦБ
    */

    macro getAvarAmount (fininstr, Data)
       
     var sql = " SELECT  SUM (NVL (T_AVRAMOUNT, 0)) T_AVRAMOUNT " +
               "         FROM DPORTFOLIO_TMP t " +
               "         Where t.t_portfid = ? and t.t_fiid = ? and t.t_account =  ? and t.report_dt = ?" +
               "     GROUP BY T_PORTFID, " +
               "              T_FIID, " +
               "              T_PARTYID, " +
               "              T_AVKINDSHNAME, " +
               "              T_ACCOUNT, " +
               "              T_BALANCE ";

      var cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, Data.PORTFOLIO);
      cmd.addParam("", RSDBP_IN, fininstr.FIID);
      cmd.addParam("", RSDBP_IN, Data.ACCOUNT_NUMBER_2);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);
      
      if(getData.MoveNext)
       return getData.Value(0);  
      else 
       return 0;
      end;

      // onError
      //  return 0;

    End;

    macro getESTRESERVE(fininstr, Data)
  
     var RetVal = $0.0;  
     var sql = 
         "SELECT  t_account, RSB_ACCOUNT.RESTALL(t_account, t_chapter,t_currency, ? ) rest  " +
         "  FROM dmcaccdoc_dbt ";
      if (Data.PORTFOLIO == 2)
         sql = sql +
         " WHERE t_catnum IN (1457, 1458) AND t_templnum = 5 and t_iscommon = CHR (88) AND t_fiid = ? " ;
      elif (Data.PORTFOLIO == 5)
         sql = sql +
         " WHERE t_catnum IN (1457, 1458) AND t_templnum in (1,3) and t_iscommon = CHR (88) AND t_fiid = ? " ;
      else
         //sql = sql +
         //" WHERE t_catnum IN (1457, 1458) and t_iscommon = CHR (88) AND t_fiid = ? " ;
        return 0;
      end;                                                                            
      var cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.addParam("", RSDBP_IN, fininstr.FIID);
     // cmd.addParam("", RSDBP_IN, Data.ACCOUNT_NUMBER_2);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);
      
      while(getData.MoveNext)
        RetVal = RetVal + getData.Value(1);  
      end;
      return RetVal; 
       
  /*     
     var sql = " SELECT  SUM (NVL (ESTRESERVE, 0)) ESTRESERVE" +
               "         FROM DPORTFOLIO_TMP t " +
               "         Where t.t_portfid = ? and t.t_fiid = ? and t.t_account =  ? and t.report_dt = ?" +
               "     GROUP BY T_PORTFID, " +
               "              T_FIID, " +
               "              T_PARTYID, " +
               "              T_AVKINDSHNAME, " +
               "              T_ACCOUNT, " +
               "              T_BALANCE ";

      var cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, Data.PORTFOLIO);
      cmd.addParam("", RSDBP_IN, fininstr.FIID);
      cmd.addParam("", RSDBP_IN, Data.ACCOUNT_NUMBER_2);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);
      
      if(getData.MoveNext)
       return getData.Value(0);  
      else 
       return 0;
      end;
          */
      // onError
      //  return 0;

    End;


    //сюда
    macro GetUNKD_WITH_COUPON_FIFO(fininstr, Data)
  
     var RetVal = $0.0;  
     var sql = " SELECT  doc.t_account, RSB_ACCOUNT.RESTALL(doc.t_account, doc.t_chapter,doc.t_currency, ? ) rest  "+
               "   FROM dmcaccdoc_dbt doc                                                                          "+
               "   left join dmccateg_dbt cat on doc.t_catnum = CAT.T_NUMBER                                       "+
               "   left join DMCTEMPL_DBT templ on DOC.T_TEMPLNUM = templ.t_number and templ.t_catid = CAT.T_ID    ";

      if (Data.PORTFOLIO == 7)
         sql = sql +
               "  WHERE doc.t_catnum IN (1208) AND doc.t_iscommon = CHR (88) AND doc.t_fiid = ? ";
      else
         sql = sql +
               "  WHERE doc.t_catnum IN (1207) AND doc.t_iscommon = CHR (88) AND doc.t_fiid = ? ";
      end;                                                                            
      var cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.addParam("", RSDBP_IN, fininstr.FIID);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);
      
      while(getData.MoveNext)
        RetVal = RetVal + getData.Value(1);  
      end;
      return RetVal; 
    End;

    macro GetUNKD_WITH_COUPON_SRVZ(fininstr, Data)
  
     var RetVal = $0.0;  
     var sql = " SELECT  doc.t_account, RSB_ACCOUNT.RESTALL(doc.t_account, doc.t_chapter,doc.t_currency, ? ) rest  "+
               "   FROM dmcaccdoc_dbt doc                                                                          "+
               "   left join dmccateg_dbt cat on doc.t_catnum = CAT.T_NUMBER                                       "+
               "   left join DMCTEMPL_DBT templ on DOC.T_TEMPLNUM = templ.t_number and templ.t_catid = CAT.T_ID    ";

      if (Data.PORTFOLIO == 7)
         sql = sql +
               "  WHERE doc.t_catnum IN (1207) AND doc.t_iscommon = CHR (88) AND doc.t_fiid = ? and TEMPL.T_VALUE4 = 1   ";
      else
         sql = sql +
               "  WHERE doc.t_catnum IN (1207) AND doc.t_iscommon = CHR (88) AND doc.t_fiid = ? and TEMPL.T_VALUE4 = 0   ";
      end;                                                                            
      var cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.addParam("", RSDBP_IN, fininstr.FIID);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);
      
      while(getData.MoveNext)
        RetVal = RetVal + getData.Value(1);  
      end;
      return RetVal; 
    End;

    macro GetCOUPON_AMOUNT_FIFO(fininstr, Data)
  
     var RetVal = $0.0;  
     var sql = " SELECT  doc.t_account, RSB_ACCOUNT.RESTALL(doc.t_account, doc.t_chapter,doc.t_currency, ? ) rest  "+
               "   FROM dmcaccdoc_dbt doc                                                                          "+
               "   left join dmccateg_dbt cat on doc.t_catnum = CAT.T_NUMBER                                       "+
               "   left join DMCTEMPL_DBT templ on DOC.T_TEMPLNUM = templ.t_number and templ.t_catid = CAT.T_ID    ";

      if (Data.PORTFOLIO == 7)
         sql = sql +
               "  WHERE doc.t_catnum IN (235) AND doc.t_iscommon = CHR (88) AND doc.t_fiid = ? and TEMPL.T_VALUE3 = 1 and TEMPL.T_VALUE4 in (1)";
      else
         sql = sql +
               "  WHERE doc.t_catnum IN (235) AND doc.t_iscommon = CHR (88) AND doc.t_fiid = ? and TEMPL.T_VALUE3 = 0 and TEMPL.T_VALUE4 in (1)";
      end;                                                                            
      var cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.addParam("", RSDBP_IN, fininstr.FIID);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);
      
      while(getData.MoveNext)
        RetVal = RetVal + getData.Value(1);  
      end;
      if (Data.PORTFOLIO == 7)
      sql = "select sum(amount)  from trshb_portfolio_pkl_2chd where portfolio  = 7 and isin = ? and report_dt =?";
      cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, data.isin);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.Execute();
      getData = TRsbDataSet(cmd);
      getData.movenext;
      retval = retval*data.amount/getData.value(0);
      end;    
      return RetVal; 
    End;

    macro GetCOUPON_AMOUNT_SRVZ(fininstr, Data)
  
     var RetVal = $0.0;  
     var sql = " SELECT  doc.t_account, RSB_ACCOUNT.RESTALL(doc.t_account, doc.t_chapter,doc.t_currency, ? ) rest  "+
               "   FROM dmcaccdoc_dbt doc                                                                          "+
               "   left join dmccateg_dbt cat on doc.t_catnum = CAT.T_NUMBER                                       "+
               "   left join DMCTEMPL_DBT templ on DOC.T_TEMPLNUM = templ.t_number and templ.t_catid = CAT.T_ID    ";

      if (Data.PORTFOLIO == 7)
         sql = sql +
               "  WHERE doc.t_catnum IN (235) AND doc.t_iscommon = CHR (88) AND doc.t_fiid = ? and TEMPL.T_VALUE3 = 1 and TEMPL.T_VALUE4 in (1)";
      else
         sql = sql +
               "  WHERE doc.t_catnum IN (235) AND doc.t_iscommon = CHR (88) AND doc.t_fiid = ? and TEMPL.T_VALUE3 = 0  and TEMPL.T_VALUE4 in (1)";
      end;                                                                            
      var cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.addParam("", RSDBP_IN, fininstr.FIID);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);
      
      while(getData.MoveNext)
        RetVal = RetVal + getData.Value(1);  
      end;
      if (Data.PORTFOLIO == 7)
      sql = "select sum(amount)  from trshb_portfolio_pkl_2chd where portfolio  = 7 and isin = ? and report_dt =?";
      cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, data.isin);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.Execute();
      getData = TRsbDataSet(cmd);
      getData.movenext;
      retval = retval*data.amount/getData.value(0);
      end;    
      return RetVal; 
    End;

    macro GetDISCOUNT_AMOUNT_FIFO(fininstr, Data)
  
     var RetVal = $0.0;  
     var sql = " SELECT  doc.t_account, RSB_ACCOUNT.RESTALL(doc.t_account, doc.t_chapter,doc.t_currency, ? ) rest  "+
               "   FROM dmcaccdoc_dbt doc                                                                          "+
               "   left join dmccateg_dbt cat on doc.t_catnum = CAT.T_NUMBER                                       "+
               "   left join DMCTEMPL_DBT templ on DOC.T_TEMPLNUM = templ.t_number and templ.t_catid = CAT.T_ID    ";

      if (Data.PORTFOLIO == 7)
         sql = sql +
               "  WHERE doc.t_catnum IN (235) AND doc.t_iscommon = CHR (88) AND doc.t_fiid = ? and TEMPL.T_VALUE3 = 1 and TEMPL.T_VALUE4 in (2)";
      else
         sql = sql +
               "  WHERE doc.t_catnum IN (235) AND doc.t_iscommon = CHR (88) AND doc.t_fiid = ? and TEMPL.T_VALUE3 = 0 and TEMPL.T_VALUE4 in (2)";
      end;                                                                            
      var cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.addParam("", RSDBP_IN, fininstr.FIID);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);
      
      while(getData.MoveNext)
        RetVal = RetVal + getData.Value(1);  
      end;
      if (Data.PORTFOLIO == 7)
      sql = "select sum(amount)  from trshb_portfolio_pkl_2chd where portfolio  = 7 and isin = ? and report_dt =?";
      cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, data.isin);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.Execute();
      getData = TRsbDataSet(cmd);
      getData.movenext;
      retval = retval*data.amount/getData.value(0);
      end;    
      return RetVal; 
    End;

    macro GetDISCOUNT_AMOUNT_SRVZ(fininstr, Data)
  
     var RetVal = $0.0;  
     var sql = " SELECT  doc.t_account, RSB_ACCOUNT.RESTALL(doc.t_account, doc.t_chapter,doc.t_currency, ? ) rest  "+
               "   FROM dmcaccdoc_dbt doc                                                                          "+
               "   left join dmccateg_dbt cat on doc.t_catnum = CAT.T_NUMBER                                       "+
               "   left join DMCTEMPL_DBT templ on DOC.T_TEMPLNUM = templ.t_number and templ.t_catid = CAT.T_ID    ";

      if (Data.PORTFOLIO == 7)
         sql = sql +
               "  WHERE doc.t_catnum IN (235) AND doc.t_iscommon = CHR (88) AND doc.t_fiid = ? and TEMPL.T_VALUE3 = 1 and TEMPL.T_VALUE4 in (2)";
      else
         sql = sql +
               "  WHERE doc.t_catnum IN (235) AND doc.t_iscommon = CHR (88) AND doc.t_fiid = ? and TEMPL.T_VALUE3 = 0  and TEMPL.T_VALUE4 in (2)";
      end;                                                                            
      var cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.addParam("", RSDBP_IN, fininstr.FIID);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);
      
      while(getData.MoveNext)
        RetVal = RetVal + getData.Value(1);  
      end;
      if (Data.PORTFOLIO == 7)
      sql = "select sum(amount)  from trshb_portfolio_pkl_2chd where portfolio  = 7 and isin = ? and report_dt =?";
      cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, data.isin);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.Execute();
      getData = TRsbDataSet(cmd);
      getData.movenext;
      retval = retval*data.amount/getData.value(0);
      end;    
      return RetVal; 
    End;

    macro GetPremium_AMOUNT_FIFO(fininstr, Data)
  
     var RetVal = $0.0;  
     var sql = " SELECT  doc.t_account, RSB_ACCOUNT.RESTALL(doc.t_account, doc.t_chapter,doc.t_currency, ? ) rest  "+
               "   FROM dmcaccdoc_dbt doc                                                                          "+
               "   left join dmccateg_dbt cat on doc.t_catnum = CAT.T_NUMBER                                       "+
               "   left join DMCTEMPL_DBT templ on DOC.T_TEMPLNUM = templ.t_number and templ.t_catid = CAT.T_ID    ";

      if (Data.PORTFOLIO == 7)
         sql = sql +
               "  WHERE doc.t_catnum IN (236) AND doc.t_iscommon = CHR (88) AND doc.t_fiid = ? and TEMPL.T_VALUE3 = 1 ";
      else
         sql = sql +
               "  WHERE doc.t_catnum IN (236) AND doc.t_iscommon = CHR (88) AND doc.t_fiid = ? and TEMPL.T_VALUE3 = 0 ";
      end;                                                                            
      var cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.addParam("", RSDBP_IN, fininstr.FIID);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);
      
      while(getData.MoveNext)
        RetVal = RetVal + getData.Value(1);  
      end;
      if (Data.PORTFOLIO == 7)
      sql = "select sum(amount)  from trshb_portfolio_pkl_2chd where portfolio  = 7 and isin = ? and report_dt =?";
      cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, data.isin);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.Execute();
      getData = TRsbDataSet(cmd);
      getData.movenext;
      retval = retval*data.amount/getData.value(0);
      end;    
      return RetVal; 
    End;

    macro GetPremium_AMOUNT_SRVZ(fininstr, Data)
  
     var RetVal = $0.0;  
     var sql = " SELECT  doc.t_account, RSB_ACCOUNT.RESTALL(doc.t_account, doc.t_chapter,doc.t_currency, ? ) rest  "+
               "   FROM dmcaccdoc_dbt doc                                                                          "+
               "   left join dmccateg_dbt cat on doc.t_catnum = CAT.T_NUMBER                                       "+
               "   left join DMCTEMPL_DBT templ on DOC.T_TEMPLNUM = templ.t_number and templ.t_catid = CAT.T_ID    ";

      if (Data.PORTFOLIO == 7)
         sql = sql +
               "  WHERE doc.t_catnum IN (236) AND doc.t_iscommon = CHR (88) AND doc.t_fiid = ? and TEMPL.T_VALUE3 = 1 ";
      else
         sql = sql +
               "  WHERE doc.t_catnum IN (236) AND doc.t_iscommon = CHR (88) AND doc.t_fiid = ? and TEMPL.T_VALUE3 = 0 ";
      end;                                                                            
      var cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.addParam("", RSDBP_IN, fininstr.FIID);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);
      
      while(getData.MoveNext)
        RetVal = RetVal + getData.Value(1);  
      end;
      if (Data.PORTFOLIO == 7)
      sql = "select sum(amount)  from trshb_portfolio_pkl_2chd where portfolio  = 7 and isin = ? and report_dt =?";
      cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, data.isin);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.Execute();
      getData = TRsbDataSet(cmd);
      getData.movenext;
      retval = retval*data.amount/getData.value(0);
      end;    
      return RetVal; 
    End;


    macro getMicexCode(fiid)
       
     var sql = 
               " SELECT nvl(t_code,f.t_isin) code " +
               "  FROM  davoiriss_dbt f left join dobjcode_dbt a on a.t_objectid = f.t_fiid " +
               " WHERE t_objecttype = 9 AND t_codekind = 11 AND t_objectid = f.t_fiid and f.t_fiid = ? " ;

      var cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, FIID);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);
      
      if(getData.MoveNext)
       return getData.Value(0);  
      else 
       return "---";
      end;

      // onError
      //  return 0;

    End;


    macro getCORRINTTOEIR (fininstr, Data)
    var RetVal = $0.0;  
     var sql = 
         "SELECT  t_account, RSB_ACCOUNT.RESTALL(t_account, t_chapter,t_currency, ? ) rest  " +
         "  FROM dmcaccdoc_dbt " +
         " WHERE t_catnum IN (1418, 1417) AND t_iscommon = CHR (88) AND t_fiid = ? " ;
      var cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.addParam("", RSDBP_IN, fininstr.FIID);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);
      
      while(getData.MoveNext)
        RetVal = RetVal + getData.Value(1);  
      end;
      return RetVal;


/*     var sql = " SELECT  SUM (NVL (CORRINTTOEIR, 0)) CORRINTTOEIR " +
               "         FROM DPORTFOLIO_TMP t " +
               "         Where t.t_portfid = ? and t.t_fiid = ? and t.t_account =  ? and t.report_dt = ?" +
               "     GROUP BY T_PORTFID, " +
               "              T_FIID, " +
               "              T_PARTYID, " +
               "              T_AVKINDSHNAME, " +
               "              T_ACCOUNT, " +
               "              T_BALANCE ";

      var cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, Data.PORTFOLIO);
      cmd.addParam("", RSDBP_IN, fininstr.FIID);
      cmd.addParam("", RSDBP_IN, Data.ACCOUNT_NUMBER_2);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);
      
      if(getData.MoveNext)
       return getData.Value(0);  
      else 
       return 0;
      end;*/
           
    End;

    private macro GetFirstAccBal(acc, portf)
       var RetVal = "";  
       if (portf == 7 /*БПП*/)
         var sql = 
                   "  SELECT SUBSTR (t_account_Payer, 1, 5) balacc" +
                   "    FROM dacctrn_dbt " +
                   "   WHERE t_account_receiver = ? AND t_state = 1 " +
                   "ORDER BY t_acctrnid  " ;
                    /*первая проводка по счету Портфель БПП как раз и есть проводка по переносу балансовой с Наш портфель на Портфель БПП*/ 
                    /*не лишним было бы смотреть в разрезе одного первичного документа, но ..*/
   
          var cmd = rsdCommand(sql);
          cmd.addParam("", RSDBP_IN, acc);
          cmd.Execute();
          var getData = TRsbDataSet(cmd);
          
          if(getData.MoveNext)
            RetVal = getData.Value(0);  
          end;
       else
          RetVal = SubStr(acc,1,5);
       end;
       return RetVal;
    end;

    private macro GetFirstAccBal9(acc, portf, fiid, repdate)
       var RetVal = "";  
       var sql, cmd, getdata;
       if (portf == 3 /*ПКУ*/  )                                                                                                                                                                                                     
         sql ="  select t_balance  from dmctempl_dbt where t_catid =  495 and                                                                                                                                            "+
                  "  t_value1 = decode ( rsb_fiinstr.FI_AvrKindsGetRoot( (select t_fi_kind from dfininstr_dbt where t_fiid = :fiid), (select t_avoirkind from dfininstr_dbt where t_fiid = :fiid1)), 17, 3, 20, 102,16 , 103) "+
                  "               and t_value2 =                                                                                                                                                                             "+
                  "              (SELECT min (CASE                                                                                                                                                                           "+
                  "                                WHEN o.t_partykind = 29 THEN 1                                                                                                                                            "+
                  "                                WHEN o.t_partykind = 15 THEN 100                                                                                                                                          "+
                  "                                WHEN o.t_partykind = 16 THEN 101                                                                                                                                          "+
                  "                                WHEN o.t_partykind = 17 THEN 103                                                                                                                                          "+
                  "                                WHEN p.t_notresident = CHR (88)                                                                                                                                           "+
                  "                                THEN                                                                                                                                                                      "+
                  "                                   CASE WHEN o.t_partykind = 2 THEN 3 ELSE 1000 END                                                                                                                       "+
                  "                                ELSE                                                                                                                                                                      "+
                  "                                   CASE WHEN o.t_partykind = 2 THEN 4 ELSE 9999 END                                                                                                                       "+
                  "                             END)                                                                                                                                                                         "+
                  "                                par                                                                                                                                                                       "+
                  "                        FROM dpartyown_dbt o, dparty_dbt P                                                                                                                                                "+
                  "                       WHERE p.t_partyid = RSI_RSB_FIInstr.FI_GetIssuerOnDate (:fiid2, :RepDate)  AND o.t_partyid = p.t_partyid group by p.t_partyid)                                                      "+
                  "                 and t_isclose = chr(0)                                                                                                                                                                   ";
   
          cmd = rsdCommand(sql);
          cmd.addParam("fiid", RSDBP_IN, fiid);
          cmd.addParam("fiid1", RSDBP_IN, fiid);
          cmd.addParam("fiid2", RSDBP_IN, fiid);
          cmd.addParam("RepDate", RSDBP_IN, repdate);
          cmd.Execute();
          getData = TRsbDataSet(cmd);
          
          if(getData.MoveNext)
            RetVal = getData.Value(0);  
          end;
       else
         sql =" select t_balance  from dmctempl_dbt where t_catid =  31 and t_value1 = :t_portfolioid                                                                                                                        "+
                  "  and t_value2 = decode ( rsb_fiinstr.FI_AvrKindsGetRoot( (select t_fi_kind from dfininstr_dbt where t_fiid = :fiid), (select t_avoirkind from dfininstr_dbt where t_fiid = :fiid1)), 17, 3, 20, 102,16 , 103) "+
                  "               and t_value3 =                                                                                                                                                                                 "+
                  "              (SELECT min (CASE                                                                                                                                                                               "+
                  "                                WHEN o.t_partykind = 29 THEN 1                                                                                                                                                "+
                  "                                WHEN o.t_partykind = 15 THEN 100                                                                                                                                              "+
                  "                                WHEN o.t_partykind = 16 THEN 101                                                                                                                                              "+
                  "                                WHEN o.t_partykind = 17 THEN 103                                                                                                                                              "+
                  "                                WHEN p.t_notresident = CHR (88)                                                                                                                                               "+
                  "                                THEN                                                                                                                                                                          "+
                  "                                   CASE WHEN o.t_partykind = 2 THEN 3 ELSE 1000 END                                                                                                                           "+
                  "                                ELSE                                                                                                                                                                          "+
                  "                                   CASE WHEN o.t_partykind = 2 THEN 4 ELSE 9999 END                                                                                                                           "+
                  "                             END)                                                                                                                                                                             "+
                  "                                par                                                                                                                                                                           "+
                  "                        FROM dpartyown_dbt o, dparty_dbt P                                                                                                                                                    "+
                  "                       WHERE p.t_partyid = RSI_RSB_FIInstr.FI_GetIssuerOnDate (:fiid2, :RepDate)  AND o.t_partyid = p.t_partyid group by p.t_partyid)                                                          "+
                  "                 and t_isclose = chr(0)                                                                                                                                                                       ";
          cmd = rsdCommand(sql);
          cmd.addParam("t_portfolioid", RSDBP_IN, portf);
          cmd.addParam("fiid", RSDBP_IN, fiid);
          cmd.addParam("fiid1", RSDBP_IN, fiid);
          cmd.addParam("fiid2", RSDBP_IN, fiid);
          cmd.addParam("RepDate", RSDBP_IN, repdate);
          cmd.Execute();
          getData = TRsbDataSet(cmd);
          
          if(getData.MoveNext)
            RetVal = getData.Value(0);  
          end;

       end;
       return RetVal;
    end;


    private macro getAccReserve(fiid, Portfolio, repdate)
       var RetVal = "";  
       var sql, cmd, getdata;
       sql =
             "SELECT ac.t_account " +
             "  FROM       dmcaccdoc_dbt a " +
             "          LEFT JOIN " +
             "             dmctempl_dbt mctempl " +
             "          ON     mctempl.t_catid = a.t_catid " +
             "             AND mctempl.t_number = a.t_templnum " +
             "             AND mctempl.t_isclose = CHR (0) " +
             "       LEFT JOIN " +
             "          dllvalues_dbt llval " +
             "       ON llval.t_list = 1100 AND llval.t_element = MCTEMPL.T_VALUE2, " +
             "       daccount_dbt ac " +
             " WHERE ac.t_account = a.t_account " +
             "       AND ( (ac.t_close_date >= :dat) " +
             "            OR (ac.t_close_date = TO_DATE ('01010001', 'ddmmyyyy'))) " +
             "       AND ac.t_chapter = a.t_chapter " +
             "       AND (    a.t_catnum = 241 " + /*Резерв ц/б*/
             "            AND a.t_fiid = :fiid " +
             "            AND a.t_iscommon = CHR (88) " +
             "            AND (   (:portf = 1 AND llval.t_code = 'ССПУ_ЦБ') " +
             "                 OR (:portf1 = 2 AND llval.t_code = 'СССД_ЦБ') " +
             "                 OR (:portf2 = 4 AND llval.t_code = 'ПДО') " +
             "                 OR (:portf3 = 5 AND llval.t_code = 'АС_ЦБ'))) " ;

        cmd = rsdCommand(sql);
        cmd.addParam("dat", RSDBP_IN, repdate);
        cmd.addParam("fiid", RSDBP_IN, fiid);
        cmd.addParam("portf", RSDBP_IN, portfolio);
        cmd.addParam("portf1", RSDBP_IN, portfolio);
        cmd.addParam("portf2", RSDBP_IN, portfolio);
        cmd.addParam("portf3", RSDBP_IN, portfolio);
        cmd.Execute();
        getData = TRsbDataSet(cmd);
        
        while(getData.MoveNext)
           if (RetVal == "")
              RetVal = getData.Value(0);  
           else
              RetVal = RetVal + "\n"+getData.Value(0);  
           end;
        end;
        if (RetVal == "")
           RetVal = "---";
        end;
        return RetVal;

    end;


    macro fillData(sql)
       //получаем список лотов

      var con, cmd;
      var statExec = TRUE;
      var RetExec : INTEGER = 0;

//      if(not isExistDataForReport(sql))
    if(GetTrue(null,"Пересчитать данные по лотам ? "))
        BegAction(6000,"Идёт сбор информации по лотам...", false);

        cmd = RsdCommand(/* con,*/ "" );

        cmd.CmdText = "begin rsFillPortfolio (?, ?, ?); end;";

        cmd.addParam( "", RSDBP_IN, repDate );
        cmd.addParam( "", RSDBP_IN, -1 );
        cmd.addParam( "", RSDBP_IN, 1); /*размазать переоценку и корректировку по БПП пропорционально количеству бумаг*/
        

        statExec = ExecCommand( cmd, " Сбор данных по портфелям " );
        if (not statExec)
          msgbox("Ошибка сбора данных по лотам!");
        end;
        cmd.close();

        EndAction();
      end;

    end;            
   

    macro printTable(sql)
       var fininstr;
       var avoiriss;
       var cmd = rsdCommand(sql);
       cmd.addParam("", RSDBP_IN, repDate);
       cmd.Execute();
       var Data = TRsbDataSet(cmd);
       
       /*Для прогрессбара*/
       var cnt = 0;
       var cntCount = int(countForProgressBar(sql));

       var AvarAmount;
       var Quotation;
       var MarketPriceCUR;
       var MarketPriceRUR;
       var IsRelative;
       var UNKD_WITH_COUPON,COUPON_AMOUNT, DISCOUNT_AMOUNT,PREMIUM_AMOUNT, Balance_price,OVERVALUE;

       InitProgress(cntCount,"Вывод на печать данных по портфелям","Вывод на печать данных по портфелям");
        While(Data.MoveNext)

                    
               fininstr = getFininstr(Data.ISIN, Data.REG_NUMBER); 
        
               if(fininstr == false)
                 println("isin = ", Data.ISIN, "  и Регистрационный номер = ",  Data.REG_NUMBER, " не найдены в справочнике ЦБ -- данные по лотам в отчёт не попали !!!");
               end;

               if(not fininstr == false)
                    avoiriss = getAvoiriss(fininstr.FIID);
                    AvarAmount = getAvarAmount(fininstr, Data);
                    /*средневзвешенная котировка по нашим, по еврооблигациям котировка Блумберг */
                    var Dbl_Course = 0.0, SinceDate, erFlag, err, Course = $0;
                    Dbl_Course = GetRateOnDate(data.report_dt, fininstr.fiid,fininstr.facevaluefi, false, 1001, erFlag, SinceDate );
/*if (fininstr.fiid == 2000)
quotation =0.1;
else*/ 
                    if ((valtype(SinceDate) != 0) and ((DATE(data.report_dt)-DATE(SinceDate))<30) and (Dbl_Course != 0))
                       Quotation = getAvrRate(fininstr, 1001, @IsRelative) ;
                    else
                       if (IsEvroOblig(fininstr))
                          Quotation = getAvrRate(fininstr, 23, @IsRelative) ; //23 - Цена закрытия Bloomberg
                          if (Quotation == 0)
                             Quotation = getAvrRate(fininstr, 4, @IsRelative); //4 - Средневзвешенная цена
                          end;
                       else
                          Quotation = getAvrRate(fininstr, 4, @IsRelative); //4 - Средневзвешенная цена
                          if (quotation == 0)
                             var fininstr1 = fininstr;
                             fininstr1.rec.FaceValueFI = 0;
                             Quotation = getAvrRate(fininstr1, 4, @IsRelative); //4 - Средневзвешенная цена
                          end;
                       end;
                    end;
//end;

                    MarketPriceCUR = getMarketPriceCUR(AvarAmount, Quotation, fininstr, Data, IsRelative);
                    MarketPriceRUR = getMarketPriceRUR(MarketPriceCUR, fininstr, Data);
                    printCell(GetMicexCode(fininstr.fiid));              //торговый код ценной бумаги !!!FIID
                    printCell(ClearStr(fininstr.name));                  //Наименование бумаги
                    printCell(ClearStr(Data.ACCOUNT_NUMBER_1));          //балансовый счет 2-го порядка, категория +ОД
                    printCell(Data.ACCOUNT_NUMBER_2);                    //лицевой счет вложений
                    if (substr(data.account_number_1, 1, 1) !="9")
                       printCell(GetFirstAccBal(Data.ACCOUNT_NUMBER_2, Data.PORTFOLIO));    //cчет второго порядка первоначального учета 
                    else
                       printCell(GetFirstAccBal9(Data.ACCOUNT_NUMBER_2, Data.PORTFOLIO, fininstr.fiid, Data.report_dt));    //cчет второго порядка первоначального учета 
                    end;
                    printCell(ClearStr(Data.CURRENCY));                  //валюта
                    printCell(ClearStr(Data.ISSUER));                    //эмитент
                    printCell(ClearStr(Data.IS_NFO));                    //ФО или НФО
                    printCell(getIssuerCountry(fininstr.issuer));        //cтрана эммитента

                    if (getOrgInternational(fininstr.issuer) == "ДА")
                       printCell("---");
                    else
                       printCell(ClearStr(Data.COUNTRY_RATING));            //страновая оценка                    
                    end;

                    printCell(getOrgInternational(fininstr.issuer));      //признак международной организации
                    printCell(ClearStr(Data.IS_OESR_EUROZONE));
                    printCell(ClearStr(Data.IS_STATE_BORROW));
                    printCell(ClearStr(Data.SECURITY_TYPE));             //тип ценной бумаги
                    printCell(ClearStr(Data.IS_SPV));                    //вернуть строку Признак SPV  эмитента (да/нет)
                    printCell(ClearStr(Data.IS_HYPO_COVER));             //признак ипотечного покрытия (да/нет)
                    printCell(ClearStr(Data.ISSUER_OKVED));              //ОКВЭД эмитента
                    printCell(getSubord(fininstr.fiid));                        //Субординированная
                    printCell(ClearStr(Data.ISSUER_RATING_SP));          //рейтинг эмитента (Standart&Poors)
                    printCell(ClearStr(Data.ISSUE_RATING_SP));           //рейтинг эмиссии (Standart&Poors)
                    printCell(ClearStr(Data.ISSUER_RATING_3453U_SP));
                    printCell(ClearStr(Data.ISSUE_RATING_3453U_SP));
                    printCell(ClearStr(Data.ISSUER_RATING_MOODYS));      //рейтинг эмитента (Moodys)
                    printCell(ClearStr(Data.ISSUE_RATING_MOODYS));       //рейтинг эмиссии (Moodys)
                    printCell(ClearStr(Data.ISSUER_RATING_3453U_MOODYS));
                    printCell(ClearStr(Data.ISSUE_RATING_3453U_MOODYS));
                    printCell(ClearStr(Data.ISSUER_RATING_FITCH));       //рейтинг эмитента (Fitch Ratings)
                    printCell(ClearStr(Data.ISSUE_RATING_FITCH));        //рейтинг эмиссии (Fitch Ratings)
                    printCell(ClearStr(Data.ISSUER_RATING_3453U_FITCH));
                    printCell(ClearStr(Data.ISSUE_RATING_3453U_FITCH));
                    printCell(ClearStr(Data.ISSUER_RATING_AKRA));        //рейтинг эмитента (АКРА)
                    printCell(ClearStr(Data.ISSUE_RATING_AKRA));         //рейтинг эмиссии (АКРА)
                    printCell(ClearStr(Data.ISSUER_RATING_EXPERT));      //рейтинг эмитента (Эксперт РА)
                    printCell(ClearStr(Data.ISSUE_RATING_EXPERT));       //рейтинг эмиссии (Эксперт РА)
                    printCell(getIsBankrupt(fininstr.issuer));           //признак наличия банкротства по эмитенту (да/нет) 
                    printCell(ClearStr(Data.REG_NUMBER));                //№гос. регистрации
                    printCell(ClearStr(Data.ISIN));                      //isin
                    printCell(getTradeMarket(fininstr.fiid));            //обращается на рынке (да/нет)
                    printCell(getCatDef(fininstr.fiid));                 //признак наличия дефолта по выпуску (да/нет)
                    printCell(getLombard(fininstr.fiid));                //Признак включения в ломбардный список БР
                    printCell(ClearStr(Data.IS_HYPO_COVER));             //признак ипотечного покрытия (да/нет)

/*                    if( String(Data.ISSUE_START_DT) == " 1.01.0001 (00:00:00.00)" )  
                      printCell("---");
                    else
                      printCell(Date(Data.ISSUE_START_DT));
                    end; //дата начала размещения
*/

                    printCell(date(avoiriss.begplacementdate));//дата начала размещения
                    if( (String(Data.REPAY_DT) == " 1.01.0001 (00:00:00.00)") OR (valtype(Data.REPAY_DT)==0) OR isItShares(fininstr) )//также проверяю является ли бумага акцией
                      printCell("---");
                    else
                      printCell(Date(Data.REPAY_DT));
                    end; //дата погашения ЦБ

                    if( (String(Data.COUPON_REPAY_DT) == " 1.01.0001 (00:00:00.00)") OR (valtype(Data.COUPON_REPAY_DT)==0) or isItShares(fininstr) )
                      printCell("---");
                    else
                      printCell(Date(Data.COUPON_REPAY_DT));
                    end; //дата погашения купона
                    printCell("---");                                   //Дата досрочного погашения ЦБ (досрочный выкуп)
                    printCell(GetFaceValue(fininstr.FIID, RepDate));    //номинал ЦБ !!!
                    printCell(Quotation,4);       //котировка
                    printCell(AvarAmount);                                   //открытое количество ЦБ ждём таблицу
//вот эти колонки надо править
                    printCell(ClearStr(Data.AMOUNT));                   //сумма = номинал ЦБ * открытое количество ЦБ
 
                    if (date(data.report_dt) <= date("01.01.2020"))
                       UNKD_WITH_COUPON  = abs(GetUNKD_WITH_COUPON_FIFO(fininstr, Data));
                       printCell(UNKD_WITH_COUPON);         //УНКД с учетом погашенных купонов
                       COUPON_AMOUNT = abs(GetCOUPON_AMOUNT_FIFO(fininstr, Data));
                       printCell(ClearStr(COUPON_AMOUNT));            //Начисленный купон
                       DISCOUNT_AMOUNT = abs(GetDISCOUNT_AMOUNT_FIFO(fininstr, Data));
                       printCell(ClearStr(DISCOUNT_AMOUNT));          //Начисленный дисконт
                       PREMIUM_AMOUNT = abs(GetPremium_AMOUNT_FIFO(fininstr, Data));
                       printCell(ClearStr(PREMIUM_AMOUNT));           //Премия
                       Balance_price = Data.AMOUNT + UNKD_WITH_COUPON + COUPON_AMOUNT + DISCOUNT_AMOUNT + PREMIUM_AMOUNT;
                       printCell(ClearStr(Balance_price));            //Балансовая стоимость RUR
                       printCell(ClearStr(Data.OVERVALUE));                //Переоценка RUR
                       printCell(ClearStr(BALANCE_PRICE + Data.OVERVALUE));  //ТСС
                       printCell(ClearStr(Data.RESERVE_AMOUNT));           //Резерв
                    else
                       UNKD_WITH_COUPON  = abs(GetUNKD_WITH_COUPON_SRVZ(fininstr, Data));
                       printCell(UNKD_WITH_COUPON);         //УНКД с учетом погашенных купонов
                       COUPON_AMOUNT = abs(GetCOUPON_AMOUNT_SRVZ(fininstr, Data));
                       printCell(ClearStr(COUPON_AMOUNT));            //Начисленный купон
                       DISCOUNT_AMOUNT = abs(GetDISCOUNT_AMOUNT_SRVZ(fininstr, Data));
                       printCell(ClearStr(DISCOUNT_AMOUNT));          //Начисленный дисконт
                       PREMIUM_AMOUNT = abs(GetPremium_AMOUNT_SRVZ(fininstr, Data));
                       printCell(ClearStr(PREMIUM_AMOUNT));           //Премия
                       Balance_price = Data.AMOUNT + UNKD_WITH_COUPON + COUPON_AMOUNT + DISCOUNT_AMOUNT + PREMIUM_AMOUNT;
                       printCell(ClearStr(Balance_price));            //Балансовая стоимость RUR
                       printCell(ClearStr(Data.OVERVALUE));                //Переоценка RUR
                       printCell(ClearStr(BALANCE_PRICE + Data.OVERVALUE));  //ТСС
                       printCell(ClearStr(Data.RESERVE_AMOUNT));           //Резерв

                    end;
                    printCell(GetCORRINTTOEIR(fininstr, Data));           //Коррекитровка
                    printCell(GetESTRESERVE(fininstr, Data));           //Оценочный
//досюда
                    printCell(getCatergoryQuality(fininstr.fiid));          //Категория качества 
                    printCell(money(getCoeffEstimateRezerv(fininstr.fiid)));               //Коэффициент для оценочного резерва
                    printCell(getGuarantor(fininstr.fiid));                      //Поручители 
  
                    if (SubStr(Data.ACCOUNT_NUMBER_1,1,3) == "504")
                       printCell(MarketPriceCUR);        //рыночная стоимость ценной бумаги (в валюте бумаги)
                       printCell(MarketPriceRUR);        //рыночная стоимость ценной бумаги (в рублевом эквиваленте)
                    else
                       printCell("---");
                       printCell("---");
                    end;

                    if (isItShares(fininstr))
                      //printCell(getMMVB50(fininstr.FIID));                //включение биржей в списки для расчета Индекса ММВБ 50 (да/нет)
                      //printCell(getRTC50(fininstr.FIID));                 //включение биржей в списки для расчета Индекса РТС 50 (да/нет)
                      printCell(getMMVB50(fininstr.FIID));                //включение биржей в списки для расчета Индекса ММВБ 50 (да/нет)
                      printCell(getRTC50(fininstr.FIID));                 //включение биржей в списки для расчета Индекса РТС 50 (да/нет)

                    else
                      printCell("---");
                      printCell("---");                      
                    end;
                    
                    printCell(ClearStr(getInDep(avoiriss.ISIN, RepDate))); //получить значение показателя обесценения
                    printCell(getLombard(fininstr.fiid));               //нахождение в ломбардном списке (да/нет)
                    printCell(string(Round(getCoupRateByFininstr(fininstr,avoiriss),4)));         //процентная ставка по ЦБ (ставка текущего купона из параметров бумаги)
                    printCell(getAveragePrice(fininstr));               //cредневзвешенная цена (да/нет)
                    printCell(get511SourceQuote(fininstr.fiid));        //511-П_Источник котировки
                    printCell(get511SignLiquidMarket(fininstr.fiid));   //511-П_Признак активности и ликвидности рынка (да/нет)
                    printCell(get511GradeLevel(fininstr.fiid));         //511-П_Уровень иерархии оценки (1/2/3)
                    printCell(get511LiquidRatio(fininstr.fiid));        //511-П_Коэффициент ликвидности
                    printCell(getValueAdjust(fininstr.fiid));           //Величина корректировки (511-П)
                    printCell(getSecuredBonds(fininstr.fiid));          //Облигации с залоговым обеспечением (да/нет)
                    printCell(getGuaranteeRF(fininstr.fiid));           //Вложения, которые прямо или через третьих лиц обеспечены гарантией РФ (да/нет)
                    printCell("---");
                    printCell("---");
                    printCell("---");
                    printCell("---");
                    printCell("---");
                    printCell("---");
                    printCell("---");
                    printCell("---");
                    printCell(getAccReserve(fininstr.fiid, Data.Portfolio, repdate));  //Лицевой счет резерва
                    printCell("---"); 
                    printCell(getDepoCrit(fininstr.fiid));              //Соответствие депозитария критериям п.1.2 Указания 2732-У
                    printCell(getDelinquencyDays(Data.ACCOUNT_NUMBER_2, fininstr));         //Количество дней просрочки*/
                    printcell(Get_float_rate(fininstr)); //признак плавающей ставки купона







                    printRow();
            end;
            cnt=cnt+1;
            UseProgress(cnt);
        end;
       RemProgress();
    end;

    macro addHeader()
      Rep.AddPrintCell("Портфель ЦБ за дату: "+repDate,0, 0, "c:ex_FS(b):ex_FN(Arial):ex_FZ(8)", REP_ELEM_STR);
      Rep.AddStr();
      Rep.AddEmptyStr();
    end;

    private macro printCell(inValue,round)
      return Rep.AddPrintCell(inValue, 0 , round, "c", REP_ELEM_TABL);
    end;

    macro Run ()

      //Главный запрос для отчёта                                                                    /*исключили счета 91314*/
//      var sql = "select * from tRSHB_Portfolio_PKL_2CHD p where p.report_dt = ? and portfolio not in (6,10) order by p.ACCOUNT_NUMBER_2";
      var sql = "select * from tRSHB_Portfolio_PKL_2CHD p where p.report_dt = ? and portfolio not in (6,10) order by substr(p.ACCOUNT_NUMBER_2,1,1), case when substr(p.ACCOUNT_NUMBER_2,1,1) = '9' then p.isin else  p.ACCOUNT_NUMBER_2 end";

      //setoutput("..\\657_1.txt");
      println("Начало выполнения:", String(Date())," -- ", String(Time()));

      dlgInput657(0)=this.repDate;
      dlgInput657(1)=this.Department;

      if (not RunDialog (dlgInput657, @event_dlgInput657)) 
          exit(1);
      else
          this.repDate=dlgInput657(0);//убрал -1
          this.Department=dlgInput657(1);
          runIndDep(repDate); //загрузка показателей обесценения
          initRep();
          addHeader();
          this.fillData(sql);
          this.printTable(sql);
          showRep();
      end;
      println("Окончание выполнения:", String(Date())," -- ", Time());
    end;

    
end;

var report = repf657_1();

    //запуск отчёта
    report.Run();

exit();