/*
*/
import activex, oralib, likepy, BankInter, DVInter, globals, rsd,RsbDataSet, PTInter,CTInter, "cb_sql.mac";
import "u_common_email_utils.mac", "dlquery.mac";

private const COL_KO1               = 1,
              COL_KO2               = 2,
              COL_KO3               = 3,
              COL_KO4               = 4,
              COL_KO5               = 5,
              COL_KO6               = 6,
              COL_KO7               = 7,
              COL_KO8               = 8, 
              COL_KO9               = 9, 
              COL_KO10              = 10, 
              COL_KO11              = 11, 
              COL_KO12              = 12, 
              COL_KO13              = 13, 
              COL_KO14              = 14, 
              COL_KO15              = 15, 
              COL_KO16              = 16; 


  private macro parseDate(s:String):date
    // DD-MM-YYYY
    var y:integer = 0;
    var m:integer = 0;
    var d:integer = 0;
    if(strlen(s) < 10)
        return Date(0,0,0);
    end;
    d = Int(SubStr(s,1,2));
    m = Int(SubStr(s,4,2));
    y = Int(SubStr(s,7,4));

    return Date(d,m,y);
  onerror
    return Date(0,0,0);
  end;
             


Private Macro ClearTable(RepDate)
   var query1, cmd1;
        query1 =   " DECLARE "
                + " BEGIN "
                + "   DELETE FROM User701_SSP_dbt where Repdate = "+getsqldate(RepDate) +"; "
                + " END; ";


        cmd1 = RSDCommand(query1);

        cmd1.execute();
End;

Private macro GetDate(RepDate)
   var day,mon,year;
   DateSplit(RepDate, day,mon,year);
   if (day < 10)
     day = string(0,day)
   end;
   If(mon <10)
      mon = string(0,mon);
   end;
     return string (day,".",mon,".",year);

End;

Private macro InsertTableKO (strko, RepDate)


 var sql, cmd;
 sql = "Insert into User701_SSP_dbt values(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, :11, :12, :13, :14, :15, :16)";
 cmd = RSDCommand(sql);
 cmd.AddParam("p01", RSDBP_IN, strko.KO2);
 cmd.AddParam("p02", RSDBP_IN, strko.KO3);
 cmd.AddParam("p03", RSDBP_IN, strko.KO4);
 cmd.AddParam("p04", RSDBP_IN, strko.KO5);
 cmd.AddParam("p05", RSDBP_IN, strko.KO6);
 cmd.AddParam("p06", RSDBP_IN, strko.KO7);
 cmd.AddParam("p07", RSDBP_IN, strko.KO8);
 cmd.AddParam("p08", RSDBP_IN, strko.KO9);
 cmd.AddParam("p09", RSDBP_IN, strko.KO10);
 cmd.AddParam("p10", RSDBP_IN, strko.KO11);
 cmd.AddParam("p11", RSDBP_IN, strko.KO12);
 cmd.AddParam("p12", RSDBP_IN, strko.KO13);
 cmd.AddParam("p13", RSDBP_IN, strko.KO14);
 cmd.AddParam("p14", RSDBP_IN, strko.KO15);
 cmd.AddParam("p15", RSDBP_IN, strko.KO16);
 cmd.AddParam("p16", RSDBP_IN, RepDate);

 cmd.Execute;

 return true;
end;


//Расположение загружаемого файла
var  reg_path, errcode;
 GetRegistryValue("РСХБ\\ДИРЕКТОРИИ\\KLIKO_701_IN", V_STRING, reg_path, errcode );
  if ( errcode != 0 )
    reg_path = "";
  end; 
var  arch_path;
 GetRegistryValue("РСХБ\\ДИРЕКТОРИИ\\arcdir", V_STRING, arch_path, errcode );
  if ( errcode != 0 )
    arch_path = "";
  end; 


private macro iif(a,b,c)
    if(a)
        return b;
    else
        return c;
    end;
end;

class StatusRecKO()
  var KO2              :date,
      KO3              :date,
      KO4              :string,
      KO5              :string,
      KO6              :string,
      KO7              :string,
      KO8              :string,
      KO9              :string,
      KO10             :string,
      KO11             :string,
      KO12             :string,
      KO13             :string,
      KO14             :string,
      KO15             :string,
      KO16             :string;

 end;


//Загрузка данных из Excel

macro OpLoadFile(FileName, TermPath, RepDate)

  var frow = 1;
  var row = 1;
  var StRecKO, StRecDR, StRecDRV, sheet, sheetcount;
  var all = 0,suc = 0, err = 0;
  var ErrStr = "",ErrStat = false,IsOption = false;

  /*Открываем файл*/
  BegAction(1, "Обработка файла \"" + TermPath + "\\" + FileName + "\". Ждите...");
  if(not OpenExcelFile(FileName, false, true, TermPath))
    MsgBox("Ошибка открытия файла \"" + TermPath + "\\" + FileName + "\"");
    EndAction(1);
    return 0;
  end;
  /**/
   sheetcount = 1;
   WHILE(ExcelApplication.Sheets.count >= sheetcount)                                       
        sheet = ExcelApplication.Sheets(sheetcount);
        
        frow = 1;
        row = 1;

        //  SetOutput( InfoLogFileName, true ); //Пишем лог в файл. Начало
        // log.RepHeader(date(),time());
        /*Ищем первую строку*/
        while(frow <= 20)
          if((valtype(sheet.cells(frow, COL_KO4).value) != V_UNDEF) and  ( (strupr(sheet.cells(frow, COL_KO4).value) == "КОД ВАЛЮТЫ") ) )
            break;
          end;
          frow = frow + 1;
        end;
        row = frow;
        //Бежим по файлу
        InitProgress(-1);
        while (valtype(sheet.cells(row, COL_KO4).value) != V_UNDEF) 

             if (strupr(sheet.cells(row, COL_KO4).value) == "КОД ВАЛЮТЫ") 
               row = row + 2;
               continue; 
             end;

             all = all + 1;
             
             StRecKO = StatusRecKO(); 
             StRecKO.KO2       = parseDate(sheet.cells(row, COL_KO2).value);
             StRecKO.KO3       = parseDate(sheet.cells(row, COL_KO3).value);
             StRecKO.KO4       = sheet.cells(row, COL_KO4).value;
             StRecKO.KO5       = sheet.cells(row, COL_KO5).value;
             StRecKO.KO6       = sheet.cells(row, COL_KO6).value;
             StRecKO.KO7       = sheet.cells(row, COL_KO7).value;
             StRecKO.KO8       = sheet.cells(row, COL_KO8).value;
             If(valtype(sheet.cells(row, COL_KO9).value) != V_UNDEF)
                StRecKO.KO9       = string(sheet.cells(row, COL_KO9).value:0:0);
             else
             StRecKO.KO9       = "";
             end;
             StRecKO.KO10       = sheet.cells(row, COL_KO10).value;
             If(valtype(sheet.cells(row, COL_KO11).value) != V_UNDEF)
                StRecKO.KO11       = sheet.cells(row, COL_KO11).value;
             else
                StRecKO.KO11       = "";
             end;

             If(valtype(sheet.cells(row, COL_KO12).value) != V_UNDEF)
                StRecKO.KO12       = sheet.cells(row, COL_KO12).value;
             else
                StRecKO.KO12       = "";
             end;

             If(valtype(sheet.cells(row, COL_KO13).value) != V_UNDEF)
                StRecKO.KO13       = sheet.cells(row, COL_KO13).value;
             else
                StRecKO.KO13       = "";
             end;

             If(valtype(sheet.cells(row, COL_KO14).value) != V_UNDEF)
                StRecKO.KO14       = sheet.cells(row, COL_KO14).value;
             else
                StRecKO.KO14       = "";
             end;

             If(valtype(sheet.cells(row, COL_KO15).value) != V_UNDEF)
                StRecKO.KO15       = sheet.cells(row, COL_KO15).value;
             else
                StRecKO.KO15       = "";
             end;

             If(valtype(sheet.cells(row, COL_KO16).value) != V_UNDEF)
                StRecKO.KO16       = sheet.cells(row, COL_KO16).value;
             else
                StRecKO.KO16       = "";
             end;
             
             If(valtype(StRecKO.KO2) != V_UNDEF)
                InsertTableKO(StRecKO, RepDate);
             end;
             UseProgress(row);

             ErrStr = "";
             ErrStat = false;
             //STrec = null;
             row = row + 1;
        
        
        end; //while
        RemProgress();
//     End;
     sheetcount = sheetcount+1;
  end;//eow sheet
  ExcelApplication.ActiveWorkbook.Close;


onerror()
  if (valtype(ExcelApplication) != V_UNDEF)
    ExcelApplication.ActiveWorkbook.Close;
  end;
  EndAction(1);

end;
macro OpLoad701(RepDate)

  var DealID_Excel:string;
  var DealCode:string = "";
  var FullNameFile = "";
  var FileName = "";
  var TermPath = GetCurDir(true) + "\\TxtFile";
  var Userpath = "";
  var DirName = "";
  var ExtName = "";
  var valuedate:date =  Date(0, 0, 0);
  var ss = $0;
  var str;
  var DealID,FrVal = 0;
  var day = date();
  var i = 0;
  var dt = StrSubSt(string(Date()),".","");
  var InfoLogFileName = GetTxtFileName( "load_kpur_"+dt);
 /*Выбираем файл для обработки*/

  ClearTable(Repdate);

  var List = TDirList(reg_path + "\\*" + GetDate(RepDate) + ".xlsx", "F");
  while( i < List.Count )
     FullNameFile = List.Name(i);
     DirName = splitfile(FullNameFile, FileName, ExtName);
     FileName = FileName + ExtName;

     if (not copyfile("$" + reg_path + FileName, "$" + TermPath + "\\" + FileName) )
       MsgBox("Ошибка при передаче файла на терминал");
     end;
     OpLoadFile(FileName, TermPath, RepDate);
     i = i + 1;
  end;
  
End;

//OpLoad701(Date("03.09.2021"));
