//ПФИ
/*
dvkind - сделка
1 - 2690 Форвард, 12690 Внебиржевой форвард
2 - 12695 Внебиржевой опцион
3 - 22710 Валютный СВОП
4 - 22720 Процентный СВОП
5 - 12745 Покупка/продажа
6 - 2715 СВОП
7 - 12730 Покупка/продажа
8 - 2735 Банкнотная сделка, 12735 Банкнотная сделка
*/

import globals, oralib, likepy, vslib, PTinter;
import or_rep_h, or_tpl_h, or_const;
import RsbDataSet,rsd,FIInter;
import "Dl_RepCreditRisk.mac";

var repdate = {curdate};
var OnlyCB:bool = false;

private macro iif(a,b,c)
    if(a)
        return b;
    else
        return c;
    end;
end;

Private Macro GetContr(dealcode)
   var sql="select t_partyid from ddl_tick_dbt where t_bofficekind = 101 and t_dealcode = :dcode";
   var cmd = rsdCommand(sql);
   cmd.addParam(":dcode", RSDBP_IN, dealcode);
   var rs = rsdRecordSet(cmd);
   if (rs.MoveNext)
      return rs.Value(0);
   else

      sql="select t_contractor from ddvndeal_dbt where t_code = :dcode";
      cmd = rsdCommand(sql);
      cmd.addParam(":dcode", RSDBP_IN, dealcode);
      rs = rsdRecordSet(cmd);
      if (rs.MoveNext)
         return rs.Value(0);
      else
         return -1;
      end;
   end;
End;

Private Macro GetCountryContr(dealcode)
   var sql="select c.t_countryid from ddl_tick_dbt t , dparty_dbt p, dcountry_dbt c where t.t_bofficekind = 101 and t.t_dealcode = :dcode and p.t_partyid = t.t_partyid and c.t_codelat3 = p.t_nrcountry";
   var cmd = rsdCommand(sql);
   cmd.addParam(":dcode", RSDBP_IN, dealcode);
   var rs = rsdRecordSet(cmd);
   if (rs.MoveNext)
      return rs.Value(0);
   else
      sql="select c.t_countryid from ddvndeal_dbt dv, dparty_dbt p, dcountry_dbt c where dv.t_code = :dcode and p.t_partyid = dv.t_contractor and c.t_codelat3 = p.t_nrcountry";
      cmd = rsdCommand(sql);
      cmd.addParam(":dcode", RSDBP_IN, dealcode);
      rs = rsdRecordSet(cmd);
      if (rs.MoveNext)
         return rs.Value(0);
      else
         return "";
      end;
   end;
End;


    private macro getRatingCountryRep(ObjType, ObjID, NoteKind, ParentId, rtDate)
       var sql="select da.t_name "+
                 "from dobjattr_dbt da "+
                 "join dobjatcor_dbt dc on da.t_objecttype = dc.t_objecttype and da.t_groupid = dc.t_groupid and da.t_attrid = dc.t_attrid "+
                 "where dc.t_objecttype = :ObjType "+  //ценная бумага
                   "and dc.t_groupid = :NoteKind "+     //рейтинг
                   "and dc.t_object =  lpad( :ObjID , 10, '0') "+
//                   "and dc.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy') "+
                   "and :rtDate between dc.t_validfromdate and dc.t_validtodate "+
                   "and (dc.t_sysdate, dc.t_systime) = (select max(o.t_sysdate), max(o.t_systime) from dobjatcor_dbt o "+       //выбираем последний рейтинг по текущему объекту
                                                                                                 "join dobjattr_dbt w on w.t_objecttype = o.t_objecttype and w.t_groupid = o.t_groupid and w.t_attrid = o.t_attrid "+
                                                                                                 "where o.t_objecttype = :ObjType1 "+  //ценная бумага
                                                                                                 "and o.t_groupid = :NoteKind1 "+       //рейтинг
                                                                                                 "and o.t_object = lpad( :ObjID1 , 10, '0') "+
//                                                                                                 "and o.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy') "+
                                                                                                 "and :rtDate1 between o.t_validfromdate and o.t_validtodate "+
                                                                                                 "and w.t_codelist=da.t_codelist) "+
                   "and da.t_parentid= :ParentId";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":ObjType", RSDBP_IN, ObjType);
	    cmd.addParam(":NoteKind", RSDBP_IN, NoteKind);
	    cmd.addParam(":ObjID", RSDBP_IN, ObjID);
	    cmd.addParam(":rtDate", RSDBP_IN, rtDate);

	    cmd.addParam(":ObjType1", RSDBP_IN, ObjType);
	    cmd.addParam(":NoteKind1", RSDBP_IN, NoteKind);
	    cmd.addParam(":ObjID1", RSDBP_IN, ObjID);
	    cmd.addParam(":rtDate1", RSDBP_IN, rtDate);
	    cmd.addParam(":ParentId", RSDBP_IN, ParentId);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "";
        end;

    end;


    private macro getRatingRepOnDate(ObjType, ObjID, NoteKind, ParentId, rtDate)
       var sql="select da.t_name "+
                 "from dobjattr_dbt da "+
                 "join dobjatcor_dbt dc on da.t_objecttype = dc.t_objecttype and da.t_groupid = dc.t_groupid and da.t_attrid = dc.t_attrid "+
                 "where dc.t_objecttype = :ObjType "+  //ценная бумага
                   "and dc.t_groupid = :NoteKind "+     //рейтинг
                   "and dc.t_object = lpad( :ObjID , 10, '0') "+
//                   "and dc.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy') "+
                   "and :rtDate between dc.t_validfromdate and dc.t_validtodate "+
                   "and (dc.t_sysdate, dc.t_systime) = (select max(o.t_sysdate), max(o.t_systime) from dobjatcor_dbt o "+       //выбираем последний рейтинг по текущему объекту
                                                                                                 "join dobjattr_dbt w on w.t_objecttype = o.t_objecttype and w.t_groupid = o.t_groupid and w.t_attrid = o.t_attrid "+
                                                                                                 "where o.t_objecttype = :ObjType1 "+  //ценная бумага
                                                                                                 "and o.t_groupid = :NoteKind1 "+       //рейтинг
                                                                                                 "and o.t_object = lpad( :ObjID1 , 10, '0') "+
//                                                                                                 "and o.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy') "+
                                                                                                 "and :rtDate1 between o.t_validfromdate and o.t_validtodate "+
                                                                                                 "and w.t_codelist=da.t_codelist) "+
                   "and da.t_parentid= :ParentId";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":ObjType", RSDBP_IN, ObjType);
	    cmd.addParam(":NoteKind", RSDBP_IN, NoteKind);
	    cmd.addParam(":ObjID", RSDBP_IN, ObjID);
	    cmd.addParam(":rtDate", RSDBP_IN, rtDate);

	    cmd.addParam(":ObjType1", RSDBP_IN, ObjType);
	    cmd.addParam(":NoteKind1", RSDBP_IN, NoteKind);
	    cmd.addParam(":ObjID1", RSDBP_IN, ObjID);
	    cmd.addParam(":rtDate1", RSDBP_IN, rtDate);
	    cmd.addParam(":ParentId", RSDBP_IN, ParentId);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "";
        end;

    end;

    private macro getRatingRep(ObjType, ObjID, NoteKind, ParentId, rtDate)
      var RatingValue = "";


      if((ObjType == 3) and ((ParentID == 459) or (ParentID == 483) or (ParentID == 505)))
        if(rtDate < date(19,01,2015))
          RatingValue = "";
        elif((rtDate >= date(19,01,2015)) and (rtDate < date(25,02,2022)))
          var query, cmd;
          var IsBank = 0;

          if(ObjID != 618) //ВЭБ.РФ не считаем КО
            query = "SELECT NVL((SELECT 1 FROM dpartyown_dbt WHERE t_PartyID = :PartyID AND t_PartyKind = 2 AND ROWNUM = 1), 0) as IsBank FROM DUAL";
            cmd = rsdCommand(query);
            cmd.addParam(":PartyID", RSDBP_IN, ObjID);
            cmd.Execute();
            var getData = TRsbDataSet(cmd);

            var rs = rsdRecordSet(cmd);
            if (rs.MoveNext)
              IsBank = rs.Value(0);
            end;
          end;

          if(IsBank == 1)
            RatingValue = GetRatingRepOnDate(ObjType, ObjID, NoteKind, ParentId, date(01,03,2014));
          else
            RatingValue = GetRatingRepOnDate(ObjType, ObjID, NoteKind, ParentId, date(01,12,2014));
          end;
        else
          RatingValue = GetRatingRepOnDate(ObjType, ObjID, NoteKind, ParentId, date(01,02,2022));
        end;
      else
        RatingValue = GetRatingRepOnDate(ObjType, ObjID, NoteKind, ParentId, rtDate);
      end;

      return RatingValue;
    end;

macro GetCurrDemLiab(dealcode,acc_mask)
  var sql,rs,query,query1,query2;
  var did = 0,dvkind = 0,type = 0;
  var CurrDemand,CurrLiability;

  query = "SELECT d.t_id,d.t_dvkind,d.t_type FROM ddvndeal_dbt d WHERE d.t_code = ?";
  sql = RSDCommand(query);
  sql.addParam("", RSDBP_IN, dealcode);
  sql.execute();

  rs = TRsbDataSet(sql);

  if (rs.MoveNext())
    did = rs.t_id;
    dvkind = rs.t_dvkind;
    type = rs.t_type;
  end;

  if (did != 0)
    query = "SELECT f.t_fiid,f.t_pricefiid FROM ddvnfi_dbt f WHERE f.t_dealid = ? ";
    if ( (dvkind == 1) or (dvkind == 2) ) //опцион и форвард
      sql = RSDCommand(query);
      sql.addParam("", RSDBP_IN, did);
      sql.execute();
      rs = TRsbDataSet(sql);
      if (rs.MoveNext())
        if (type == 1) //покупка БА
          CurrDemand = rs.t_fiid;
          CurrLiability = rs.t_pricefiid;
        else //соотвественно продажа
          CurrDemand = rs.t_pricefiid;
          CurrLiability = rs.t_fiid;
        end;
      end;
    elif (dvkind == 3) //Валютный своп, у него вторая нога - ПФИ
        query = query + " AND f.t_type = 2";
        sql = RSDCommand(query);
        sql.addParam("", RSDBP_IN, did);
        sql.execute();
        rs = TRsbDataSet(sql);
        if (rs.MoveNext())
          if (type == 5) //Покупка/продажа
            CurrDemand = rs.t_pricefiid;
            CurrLiability = rs.t_fiid;
          elif (type == 6) // Продажа/покупка
            CurrDemand = rs.t_fiid;
            CurrLiability = rs.t_fiid;
          end;
        end;
    elif (dvkind == 4) //процентный своп
      query1 = query + " AND f.t_type = 0";
      query2 = query + " AND f.t_type = 2";

      sql = RSDCommand(query1);
      sql.addParam("", RSDBP_IN, did);
      sql.execute();
      rs = TRsbDataSet(sql);

      if (rs.MoveNext())
        CurrLiability = rs.t_fiid;
      end;

      sql = RSDCommand(query2);
      sql.addParam("", RSDBP_IN, did);
      sql.execute();
      rs = TRsbDataSet(sql);

      if (rs.MoveNext())
        CurrDemand = rs.t_fiid;
      end;
    end;
  end;

  if (acc_mask == "933")
    return CurrDemand;
  else
    return CurrLiability;
  end;

end;

macro GetAccOnDateByDeal(dealcode,ondate,acc_mask)
  var sql,rs,query;
  var did = 0;
  var Acc="";
  query = "SELECT d.t_id FROM ddvndeal_dbt d WHERE d.t_code = ?";
  sql = RSDCommand(query);
  sql.addParam("", RSDBP_IN, dealcode);
  sql.execute();

  rs = TRsbDataSet(sql);

  if (rs.MoveNext())
    did = rs.t_id;
  end;
  //Определим что есть требование, а что обязательство
  if (did != 0)

    //Теперь отберем нужные нам счета , действующи в сделке на отчетную дату
    query = "SELECT z.t_account FROM "+
    " ( "+
    " SELECT m.* FROM dmcaccdoc_dbt m WHERE m.t_dockind = 199 AND m.t_docid = ? "+
    " AND ( "+
    " (m.t_isusable = chr(88) AND m.t_activatedate <= ?) OR "+
    " (m.t_isusable = chr(0) AND (? >= m.t_activatedate AND ? < m.t_disablingdate) ) "+
    " ) "+
    " ) z WHERE substr(z.t_account,1,3) = ? AND z.t_currency = ? ";
    sql = RSDCommand(query);
    sql.addParam("", RSDBP_IN, did);
    sql.addParam("", RSDBP_IN, ondate);
    sql.addParam("", RSDBP_IN, ondate);
    sql.addParam("", RSDBP_IN, ondate);
    sql.addParam("", RSDBP_IN, acc_mask);
    sql.addParam("", RSDBP_IN, GetCurrDemLiab(dealcode,acc_mask));
    sql.execute();
    rs = TRsbDataSet(sql);
    if (rs.MoveNext())
      Acc = rs.t_account;
    end;
  end;

  return Acc;

end;

macro GetRestAccOnDate(acc,ondate,eq):money
  var sql,rs,query;
  var cur,ch,rest = $0;
  query = "SELECT * FROM daccount_dbt a WHERE a.t_account = ?";
  sql = RSDCommand(query);
  sql.addParam("", RSDBP_IN, acc);
  sql.execute();
  rs = TRsbDataSet(sql);
  if (rs.MoveNext())
    query = "SELECT rsi_rsb_account.restall(?,?,?,?,?) AS rst FROM dual";
    sql = RSDCommand(query);
    sql.addParam("", RSDBP_IN, rs.t_account);
    sql.addParam("", RSDBP_IN, rs.t_chapter);
    sql.addParam("", RSDBP_IN, rs.t_code_currency);
    sql.addParam("", RSDBP_IN, ondate);
    sql.addParam("", RSDBP_IN, iif(eq,NATCUR,null));
    sql.execute();
    rs = TRsbDataSet(sql);
    if (rs.MoveNext())
      rest = rs.rst;
    end;
  end;

  return rest;
end;

macro GetCloseDate (maturity:date, expiry:date)
  var retVal:date = Date(0, 0, 0);
  if (maturity != retVal)
    retVal = maturity;
  elif (expiry != retVal)
    retVal = expiry;
  end;
  return retVal;
End;

private macro BaIsCB (baseac):bool
  if ( (strlen(baseac) > 3) and (Index(baseac,"ставка") == 0) )
    return true;
  else
    return false;
  end;
end;

private macro GetNatRateEmit(cb,type,dt)
  //type : 436 - АКРА , 367 - Эксперт РА
  var sql,rs;
  var ret = 0;
  sql = "SELECT nvl(SECUR_DWHINFO.GetRate( "+
  " (select f.t_issuer from dfininstr_dbt f, davoiriss_dbt av where av.t_fiid = f.t_fiid and av.t_isin = '"+cb+"' and av.t_spisclosed = chr(0)), "+
  " 3, 19, "+type+", to_date('"+dt+"','dd.mm.yyyy')), chr(0)) as rate FROM dual ";
  rs = ExecSqlSelect(sql);

  if (rs.MoveNext())
    ret = rs.value("rate");
  end;

  return ret;
end;

private macro IsBirzhDeal(deal):bool
  var sql,rs;
  var ret = false;
  sql = "select d.t_sector as sec from ddvndeal_dbt d where d.t_sector = chr(88) and d.t_code = :deal";
  rs = ExecSqlSelect(sql, MakeArray(SqlParam("deal", deal)), false);

  if (rs.MoveNext())
    if ( rs.value("sec") == SET_CHAR )
      ret = false;
    end;
  end;

  return ret;
end;

private macro GenAgrType(deal)
  var sql,rs;
  var ret = " ";
  sql = "SELECT nvl(ag.t_code,chr(0)) as Type "+
  " FROM DDL_GENAGR_DBT t, DLLVALUES_DBT dl, DIR_TYPEAGREEMENT_DBT ag "+
  " WHERE t.t_genagrid = "+
  " (select d.t_genagrid from ddvndeal_dbt d where d.t_code = :dealcode ) "+
  " AND dl.t_list = 4018 " +
  " AND dl.t_element = t.t_version_gs " +
  " AND ag.t_id = t.t_type_gs ";
  rs = ExecSqlSelect(sql, MakeArray(SqlParam("dealcode", deal)), false);

  if (rs.MoveNext())
    ret = rs.value("Type");
  end;

  return ret;

end;

macro f657_7 ()
  var printEngine = CTemplateXLS(NULL, NULL, NULL, NULL, NULL, NULL, true, false);
  var csvFile = C_CSVFile();
  var csvTable;
  var rn : Integer = 0;
  var fName = csvFile.CreateFullFileName("userF657_7_template_csv.txt");
  var count, sql, IsCB, DAcc, LAcc, DCur, LCur;

  if (not GetDate(repdate))
    return 0;
  end;

  if( MsgBoxEx("Формировать только по ценным бумагам ?", MB_YES + MB_NO, IND_NO) == IND_YES )
    OnlyCB = true;
  end;

  if(printEngine.UsePoi())
    printEngine.SetXLSXFormat();
  end;

  printEngine.CreateTotalBook();

  printEngine.OpenTemplate("userF657_7_template.xlsx", true);
  printEngine.SheetChange(1);

  csvTable = printEngine.RegisterTable("templateTable", "templateTableHeader", true);

  if (printEngine.UsePoi())
    csvFile.SetLimitRow(FLUSH_COUNT_XLSX);
  end;

  csvFile.FileOpen(fName, true);

  printEngine.SetValue_NameCell("templateTitle", "Информация о срочных сделках и сделках с ПФИ по состоянию за " + string(repdate));

  printEngine.CopyAllSheetInTotalBook(null, false, "TemplateHeader", 0, "Сделки ПФИ");
/*
  sql = " select dvndeal.t_code extcode, \n"
      + "       contractor.t_name contractor, \n"
      + "       case when isbank.t_partyid is null then 'Юр. лицо' \n"
      + "            else 'Кредитная организация' \n"
      + "       end contractorkind, \n"
      + "       contractor.t_nrcountry country, \n"
      + "       dvndeal.t_genagrid genagrid, \n"
      + "       (select (select t_code from DIR_TYPEAGREEMENT_DBT where t_id = genagr.t_type_gs) \n"
      + "                    from ddl_genagr_dbt genagr where t_genagrid = dvndeal.t_genagrid), ' ') genagrtype, \n"
      + "       dvndeal.* \n"
      + "from ddvndeal_dbt dvndeal, ddvnfi_dbt dvnfi, dparty_dbt contractor \n"
      + "left join dpartyown_dbt isbank on isbank.t_partyid = contractor.t_partyid and isbank.t_partykind = 2 \n"
      + "where 1=1 \n"
      + "      and contractor.t_partyid = dvndeal.t_contractor \n"
      + "      and dvndeal.t_sector <> chr(88) \n"
      + "      --and t_code in('381', '1007') \n"
      + "      --and dvndeal.t_kind = 12745 \n"
      + "      and dvnfi.t_dealid = dvndeal.t_id \n"
      + "      and dvnfi.t_type = case when (dvndeal.t_dvkind in (3, 4, 6)) then 2 else 0 end \n"
      + "      and :dt1 >= case when dvndeal.t_dvkind = 4 then t_begindate else t_date end \n"
      + "      and dvnfi.t_execdate >= :dt2 \n"
      + "order by dvndeal.t_id desc \n";
*/

  var Params:TArray;
  Params = makeArray(SQLParam("", repdate));
  count = 0;
  InitProgress(-1, "Сбор данных");
  execSQL ("DELETE FROM TRSHB_PFI_PKL_2CHD WHERE REPORT_DT = ?",Params);
  execSQL ("begin rsFillPFI(?);end;",Params);   //SOFR_PKL_Start.mac macro PFI(dateIn)
  RemProgress();
  //Добавляем в вывод сделки срочного рынка
  var cmd = " select distinct(fi.t_name),                                                                                                                                                                                                                                              "+
            "          'НКО НКЦ (АО)', ' ',                                                                                                                                                                                                                                             "+
            "           'Банк', 'ПФИ',                                                                                                                                                                                                                                                 "+
            "           'Российская Федерация',                                                                                                                                                                                                                                        "+
            "           '4', ' ', ' ', ' ', ' ',                                                                                                                                                                                                                                       "+
            "           'Фьючерс', fi.t_definition,                                                                                                                                                                                                                                    "+
            "           'Беспоставочная', 'Биржевая',                                                                                                                                                                                                                                  "+
            "           decode (ddv.t_type, 'S', 'Продажа', 'Покупка' ),                                                                                                                                                                                                               "+
            "           'date',                                                                                                                                                                                                                                                        "+
            "           fi.t_drawingdate,                                                                                                                                                                                                                                              "+
            "           CDOCT.T_ACCOUNT,                                                                                                                                                                                                                                               "+
            "           (select t_fi_code from dfininstr_dbt where t_fiid = acct.t_code_currency) as fiid,                                                                                                                                                                             "+
            "           abs(decode (acct.t_code_currency, 0, 0, trebsum.sss)) as trebsur,                                                                                                                                                                                              "+
            "           abs(decode (acct.t_code_currency, 0,nvl( trebsum.sss, 0),RSB_FIInstr.ConvSumtype(trebsum.sss,acct.t_code_currency, 0,7,:reportdate) )) as trebrur,                                                                                                             "+
            "           CDOCO.T_ACCOUNT,                                                                                                                                                                                                                                               "+
            "           (select t_fi_code from dfininstr_dbt where t_fiid = acco.t_code_currency) as fiid,                                                                                                                                                                             "+
            "           abs(decode (acco.t_code_currency, 0, 0, obsum.sss)) as obsur,                                                                                                                                                                                                  "+
            "           abs(decode (acco.t_code_currency, 0, obsum.sss,RSB_FIInstr.ConvSumtype(obsum.sss,acco.t_code_currency, 0,7,:reportdate) )) as obrur,                                                                                                                           "+
            "           ' ' , 0, 0, 'ДА', 'ДА', 'НЕТ',' ' ,' ',                                                                                                                                                                                                                        "+
            "           ddv.t_fiid, ddv.t_kind                                                                                                                                                                                                                                         "+
            "           from ddvdeal_dbt ddv                                                                                                                                                                                                                                           "+
            "           LEFT JOIN DFININSTR_DBT fi on FI.T_FIID = ddv.t_fiid                                                                                                                                                                                                           "+
            "           left join dmcaccdoc_dbt cdocT on CDOCT.T_DOCID = ddv.t_id and cdocT.t_catid = 781                                                                                                                                                                              "+
            "           left join daccount_dbt accT on ACCT.T_ACCOUNT = CDOCT.T_ACCOUNT                                                                                                                                                                                                "+
            "           left join (select t_rest as sss,t_accountid  from drestdate_dbt rd where t_restdate = (select max(t_restdate)from drestdate_dbt rd1 where t_restdate <=:reportdate and rd1.t_accountid = rd.t_accountid)) trebsum on trebsum.t_accountid =ACCT.T_ACCOUNTID      "+
            "           left join dmcaccdoc_dbt cdocO on CDOCO.T_DOCID = ddv.t_id and cdocO.t_catid = 782                                                                                                                                                                              "+
            "           left join daccount_dbt accO on ACCO.T_ACCOUNT = CDOCO.T_ACCOUNT                                                                                                                                                                                                "+
            "           left join (select t_rest as sss,t_accountid  from drestdate_dbt rd where t_restdate = (select max(t_restdate)from drestdate_dbt rd1 where t_restdate <=:reportdate and rd1.t_accountid = rd.t_accountid)) obsum on obsum.t_accountid =ACCo.T_ACCOUNTID          "+
            "           where ddv.t_client = -1 and ddv.t_date <= :reportdate and fi.t_drawingdate>=:reportdate and obsum.sss<>0 and trebsum.sss<>0                                                                                                                                    ";
  cmd = ExecSqlSelect(cmd, MakeArray(SqlParam("reportdate", repdate)), false);
  count = 0;
  InitProgress(-1, "Сбор данных");

  while (cmd.MoveNext())
    csvFile.AddCell(count+1);                                                     // 1. Номер п/п
    csvFile.AddCell(cmd.value(0));                                                // 2. Номер сделки
    csvFile.AddCell(cmd.value(1));                                                // 3. Контрагент
    csvFile.AddCell(cmd.value(2));                                                // 4. Ген. соглашение (RISDA/ISDA)
    csvFile.AddCell(cmd.value(3));                                                // 5. Вид контрагента
    csvFile.AddCell(cmd.value(4));                                                // 6. Тип сделки (ПФИ/Срочная)
    csvFile.AddCell(cmd.value(5));                                                // 7. Страна
    csvFile.AddCell(cmd.value(6));                                                // 8. Страновая оценка

    csvFile.AddCell(getRatingRep(3, 1181, 122, 110, RepDate)); //Рейтинг контрагента (Standart&Poors) в национальной валюте
    csvFile.AddCell(getRatingRep(3, 1181, 122, 459, RepDate)); //Рейтинг контрагента в соответствии с Указанием 3453-У (Standart&Poors) в национальной валюте

    csvFile.AddCell(getRatingRep(3, 1181, 122, 210, RepDate)); //Рейтинг контрагента (Moodys) в национальной валюте
    csvFile.AddCell(getRatingRep(3, 1181, 122, 483, RepDate)); //Рейтинг контрагента в соответствии с Указанием 3453-У (Moodys) в национальной валюте

    csvFile.AddCell(getRatingRep(3, 1181, 122, 310, RepDate)); //Рейтинг контрагента (Fitch Ratings) в национальной валюте
    csvFile.AddCell(getRatingRep(3, 1181, 122, 505, RepDate)); //Рейтинг контрагента в соответствии с Указанием 3453-У (Fitch Ratings) в национальной валюте

    csvFile.AddCell(getRatingRep(3, 1181, 123, 110, RepDate)); //Рейтинг контрагента (Standart&Poors) в иностранной валюте
    csvFile.AddCell(getRatingRep(3, 1181, 123, 459, RepDate)); //Рейтинг контрагента в соответствии с Указанием 3453-У (Standart&Poors) в иностранной валюте

    csvFile.AddCell(getRatingRep(3, 1181, 123, 210, RepDate)); //Рейтинг контрагента (Standart&Poors) в иностранной валюте
    csvFile.AddCell(getRatingRep(3, 1181, 123, 483, RepDate)); //Рейтинг контрагента в соответствии с Указанием 3453-У (Standart&Poors) в иностранной валюте

    csvFile.AddCell(getRatingRep(3, 1181, 123, 310, RepDate)); //Рейтинг контрагента (Standart&Poors) в иностранной валюте
    csvFile.AddCell(getRatingRep(3, 1181, 123, 505, RepDate)); //Рейтинг контрагента в соответствии с Указанием 3453-У (Standart&Poors) в иностранной валюте

    csvFile.AddCell(getRatingRep(OBJTYPE_PARTY, 1181, 122, 436, RepDate)); //рейтинг контрагента (АКРА)
    csvFile.AddCell(getRatingRep(OBJTYPE_PARTY, 1181, 122, 367, RepDate)); //рейтинг контрагента (Эксперт РА)
    csvFile.AddCell(getRatingRep(OBJTYPE_PARTY, 1181, 122, 610, RepDate)); //рейтинг контрагента (НКР)
    csvFile.AddCell(getRatingRep(OBJTYPE_PARTY, 1181, 122, 379, RepDate)); //рейтинг контрагента (НРА)

    csvFile.AddCell(getRatingCountryRep(5, 165, 101, 110, RepDate)); //Рейтинг страны контрагента  (Standart&Poors) в национальной валюте
    csvFile.AddCell(getRatingCountryRep(5, 165, 101, 210, RepDate)); //Рейтинг страны контрагента   (Moodys) в национальной валюте
    csvFile.AddCell(getRatingCountryRep(5, 165, 101, 310, RepDate)); //Рейтинг страны контрагента  (Fitch Ratings) в национальной валюте

    csvFile.AddCell(cmd.value(11));             // 13.Наименование инструмента
    csvFile.AddCell(cmd.value(12));           // 14.Базовый актив
    csvFile.AddCell(cmd.value(13));           // 15.Вид сделки (поставочная/ беспоставочная)
    csvFile.AddCell(cmd.value(14));           // 16.Вид сделки (биржевая/ внебиржевая)
    csvFile.AddCell(cmd.value(15));             // 17.Направление сделки  (покупка/продажа)
    /*если джойнить этот селект к предыдущему, то работает довольно долго, поэтому для дат заключения сделок отдельный селект*/
    var cmd1 = " SELECT listagg(TO_CHAR(t_date, 'dd.mm.yyyy'), '/ ') WITHIN GROUP (ORDER BY t_date) AS t_date                "+
               "   FROM (SELECT DISTINCT ddv.t_date, t_fiid,  t_kind                                                         "+
               "           FROM ddvdeal_dbt ddv                                                                              "+
               "                LEFT JOIN ddvdlturn_dbt turn                                                                 "+
               "                  ON ddv.t_id = TURN.T_DEALID                                                                "+
               "                     AND TURN.T_DATE = (SELECT MAX(turn2.t_date)                                             "+
               "                                          FROM ddvdlturn_dbt turn2                                           "+
               "                                         WHERE turn2.t_dealid = ddv.t_id  AND turn2.t_date <= :reportdate)   "+
               "          WHERE t_client = -NVL(1, UID)  AND turn.t_execution < ddv.t_amount                                 "+
               "            AND ddv.t_date <=:reportdate2)                                                                   "+
               "            where t_fiid = :fiid   and t_kind = :kind                                                        ";
    cmd1 = ExecSqlSelect(cmd1, MakeArray(SqlParam("reportdate", repdate), SqlParam("reportdate2", repdate),SqlParam("fiid", cmd.value(34)),SqlParam("kind", cmd.value(35)) ), false);
    cmd1.movenext();

    csvFile.AddCell(cmd1.value(0));                 // 18.Дата заключения сделки
    csvFile.AddCell(string(date(cmd.value(17)):f)); // 19.Дата окончания сделки
    csvFile.AddCell(cmd.value(18));                 // 18.Лицевой счет требований
    csvFile.AddCell(cmd.value(19));                 // 19.Валюта счета требований
    csvFile.AddCell(cmd.value(20));
    csvFile.AddCell(cmd.value(21));
    csvFile.AddCell(cmd.value(22));
    csvFile.AddCell(cmd.value(23));
    csvFile.AddCell(cmd.value(24));
    csvFile.AddCell(cmd.value(25));
    csvFile.AddCell(cmd.value(26));
    csvFile.AddCell(cmd.value(27));
    csvFile.AddCell(cmd.value(28));
    csvFile.AddCell(cmd.value(29)); //
    csvFile.AddCell(cmd.value(30));
    csvFile.AddCell(cmd.value(31));
    csvFile.AddCell(cmd.value(32));
    csvFile.AddCell(cmd.value(33));
    csvFile.AddCell("");
    csvFile.AddCell("");
    csvFile.AddCell("");
    csvFile.AddCell("");
    csvFile.AddCell("");
    csvFile.AddRow();
    UseProgress(count = count + 1);
    rn = rn + 1;
  end;

  //mda 02.03.2019 Чтобы не лазить в логику процедуры , внесем правки в отображаемую форму Excel
  //sql = "SELECT tpfi.* FROM TRSHB_PFI_PKL_2CHD tpfi  WHERE TPFI.REPORT_DT = :dt1";
  sql = "SELECT tpfi.DEAL_NUMBER, "+
  " tpfi.SUBJECT, " +
  " nvl(tpfi.AGREEMENT_TYPE,chr(0)) as AGREEMENT_TYPE, " +
  " tpfi.SUBJECT_TYPE, " +
  " tpfi.DEAL_TYPE, " +
  " tpfi.COUNTRY, " +
  " tpfi.COUNTRY_RATING, " +
  " nvl(tpfi.SUBJ_RATING,chr(0)) as SUBJ_RATING, " +
  " nvl(tpfi.SUBJ_RATING_3453U,chr(0)) as SUBJ_RATING_3453U, " +
  " tpfi.FINSTR_NAME, " +
  " tpfi.BASE_ACTIVE, " +
  " tpfi.DEAL_SUPPLY, " +
  " tpfi.DEAL_EXCHANGE, " +
  " tpfi.DEAL_DIRECTION, " +
  " tpfi.BEGIN_DT, " +
  " tpfi.END_DT, " +
  " nvl(tpfi.ACCOUNT_DEMAND,chr(0)) as ACCOUNT_DEMAND," +
  " nvl(tpfi.CURRENCY_DEMAND,chr(0)) as CURRENCY_DEMAND, " +
  " nvl(tpfi.AMOUNT_DEMAND_VAL,0) as AMOUNT_DEMAND_VAL, " +
  " nvl(tpfi.AMOUNT_DEMAND_RUR,0) as AMOUNT_DEMAND_RUR, " +
  " nvl(tpfi.ACCOUNT_LIABILITY,chr(0)) as ACCOUNT_LIABILITY, " +
  " nvl(tpfi.CURRENCY_LIABILITY,chr(0)) as CURRENCY_LIABILITY, " +
  " nvl(tpfi.AMOUNT_LIABILITY_VAL,0) as AMOUNT_LIABILITY_VAL, " +
  " nvl(tpfi.AMOUNT_LIABILITY_RUR,0) as AMOUNT_LIABILITY_RUR, " +
  " nvl(tpfi.ACCOUNT_SS,chr(0)) as ACCOUNT_SS, " +
  " nvl(tpfi.AMOUNT_SS_ACTIVE,0) as AMOUNT_SS_ACTIVE, " +
  " nvl(tpfi.AMOUNT_SS_LIABILITY,0) as AMOUNT_SS_LIABILITY, " +
  " nvl(tpfi.IS_LIQ_NETTING,chr(0)) as IS_LIQ_NETTING, " +
  " nvl(tpfi.IS_CLC_NETTING,chr(0)) as IS_CLC_NETTING, " +
  " nvl(tpfi.IS_REPOSITORY,chr(0)) as IS_REPOSITORY, " +
  " nvl(tpfi.SWAP_PRC_CHANGE_DT,DATE'0001-01-01') as SWAP_PRC_CHANGE_DT, " +
  " nvl(tpfi.SWAP_BAL_ACC_FLOAT_RATE,chr(0)) as SWAP_BAL_ACC_FLOAT_RATE " +
  " FROM TRSHB_PFI_PKL_2CHD tpfi  WHERE TPFI.REPORT_DT = :dt1";
  sql = ExecSqlSelect(sql, MakeArray(SqlParam("dt1", repdate)), false);

  rn = rn + 1;
  var fornum;
  while (sql.MoveNext())
    IsCB = false;
    if ( BaIsCB(sql.value("BASE_ACTIVE")) )
      IsCB = true;
    end;

    if ( OnlyCB and (IsCB == false) )
      rn = rn + 1;
      continue;
    end;
    /*MDA 19.03.2019*/
    if (IsCB == false)
      DAcc = GetAccOnDateByDeal(sql.value("DEAL_NUMBER"),repdate,"933");
      LAcc = GetAccOnDateByDeal(sql.value("DEAL_NUMBER"),repdate,"963");
      DCur = ПолучитьКодФинИн(GetCurrDemLiab(sql.value("DEAL_NUMBER"),"933"));
      LCur = ПолучитьКодФинИн(GetCurrDemLiab(sql.value("DEAL_NUMBER"),"963"));
    end;
    /*MDA 19.03.2019 END*/
    csvFile.AddCell(count+1);                              // 1. Номер п/п
    csvFile.AddCell(sql.value("DEAL_NUMBER"));             // 2. Номер сделки
    csvFile.AddCell(sql.value("SUBJECT"));                 // 3. Контрагент
    csvFile.AddCell(GenAgrType(sql.value("DEAL_NUMBER"))); // 4. Ген. соглашение (RISDA/ISDA)
    csvFile.AddCell(sql.value("SUBJECT_TYPE"));            // 5. Вид контрагента
    csvFile.AddCell(sql.value("DEAL_TYPE"));               // 6. Тип сделки (ПФИ/Срочная)
    csvFile.AddCell(sql.value("COUNTRY"));                 // 7. Страна
    csvFile.AddCell(sql.value("COUNTRY_RATING"));          // 8. Страновая оценка

    csvFile.AddCell(getRatingRep(3, GetContr(sql.value(0)), 122, 110, RepDate)); //Рейтинг контрагента (Standart&Poors) в национальной валюте
    csvFile.AddCell(getRatingRep(3, GetContr(sql.value(0)), 122, 459, RepDate)); //Рейтинг контрагента в соответствии с Указанием 3453-У (Standart&Poors) в национальной валюте

    csvFile.AddCell(getRatingRep(3, GetContr(sql.value(0)), 122, 210, RepDate)); //Рейтинг контрагента (Moodys) в национальной валюте
    csvFile.AddCell(getRatingRep(3, GetContr(sql.value(0)), 122, 483, RepDate)); //Рейтинг контрагента в соответствии с Указанием 3453-У (Moodys) в национальной валюте

    csvFile.AddCell(getRatingRep(3, GetContr(sql.value(0)), 122, 310, RepDate)); //Рейтинг контрагента (Fitch Ratings) в национальной валюте
    csvFile.AddCell(getRatingRep(3, GetContr(sql.value(0)), 122, 505, RepDate)); //Рейтинг контрагента в соответствии с Указанием 3453-У (Fitch Ratings) в национальной валюте

    csvFile.AddCell(getRatingRep(3, GetContr(sql.value(0)), 123, 110, RepDate)); //Рейтинг контрагента (Standart&Poors) в иностранной валюте
    csvFile.AddCell(getRatingRep(3, GetContr(sql.value(0)), 123, 459, RepDate)); //Рейтинг контрагента в соответствии с Указанием 3453-У (Standart&Poors) в иностранной валюте

    csvFile.AddCell(getRatingRep(3, GetContr(sql.value(0)), 123, 210, RepDate)); //Рейтинг контрагента (Standart&Poors) в иностранной валюте
    csvFile.AddCell(getRatingRep(3, GetContr(sql.value(0)), 123, 483, RepDate)); //Рейтинг контрагента в соответствии с Указанием 3453-У (Standart&Poors) в иностранной валюте

    csvFile.AddCell(getRatingRep(3, GetContr(sql.value(0)), 123, 310, RepDate)); //Рейтинг контрагента (Standart&Poors) в иностранной валюте
    csvFile.AddCell(getRatingRep(3, GetContr(sql.value(0)), 123, 505, RepDate)); //Рейтинг контрагента в соответствии с Указанием 3453-У (Standart&Poors) в иностранной валюте

    csvFile.AddCell(getRatingRep(OBJTYPE_PARTY, GetContr(sql.value(0)), 122, 436, RepDate)); //рейтинг контрагента (АКРА)
    csvFile.AddCell(getRatingRep(OBJTYPE_PARTY, GetContr(sql.value(0)), 122, 367, RepDate)); //рейтинг контрагента (Эксперт РА)
    csvFile.AddCell(getRatingRep(OBJTYPE_PARTY, GetContr(sql.value(0)), 122, 610, RepDate)); //рейтинг контрагента (НКР)
    csvFile.AddCell(getRatingRep(OBJTYPE_PARTY, GetContr(sql.value(0)), 122, 379, RepDate)); //рейтинг контрагента (НРА)

    csvFile.AddCell(getRatingCountryRep(5, GetCountryContr(sql.value(0)), 101, 110, RepDate)); //Рейтинг страны контрагента  (Standart&Poors) в национальной валюте
    csvFile.AddCell(getRatingCountryRep(5, GetCountryContr(sql.value(0)), 101, 210, RepDate)); //Рейтинг страны контрагента   (Moodys) в национальной валюте
    csvFile.AddCell(getRatingCountryRep(5, GetCountryContr(sql.value(0)), 101, 310, RepDate)); //Рейтинг страны контрагента  (Fitch Ratings) в национальной валюте

    csvFile.AddCell(sql.value("FINSTR_NAME"));               // 13.Наименование инструмента
    csvFile.AddCell(sql.value("BASE_ACTIVE"));               // 14.Базовый актив
    csvFile.AddCell(sql.value("DEAL_SUPPLY"));               // 15.Вид сделки (поставочная/ беспоставочная)
    csvFile.AddCell(sql.value("DEAL_EXCHANGE"));             // 16.Вид сделки (биржевая/ внебиржевая)
    csvFile.AddCell(sql.value("DEAL_DIRECTION"));            // 17.Направление сделки  (покупка/продажа)
    csvFile.AddCell(string(date(sql.value("BEGIN_DT")):f));  // 18.Дата заключения сделки
    csvFile.AddCell(string(date(sql.value("END_DT")):f));    // 19.Дата окончания сделки
    /*MDA 19.03.2019*/
    //csvFile.AddCell(sql.value("ACCOUNT_DEMAND"));          // 18.Лицевой счет требований
    csvFile.AddCell(iif(IsCB == false,DAcc,sql.value("ACCOUNT_DEMAND")));          // 18.Лицевой счет требований
    //csvFile.AddCell(sql.value("CURRENCY_DEMAND"));         // 19.Валюта счета требований
    csvFile.AddCell(iif(IsCB == false,DCur,sql.value("CURRENCY_DEMAND")));         // 19.Валюта счета требований
    If (valtype(sql.value("AMOUNT_DEMAND_VAL"))==26) fornum = sql.value("AMOUNT_DEMAND_VAL") else fornum = abs(sql.value("AMOUNT_DEMAND_VAL")) end;
    //csvFile.AddCell(fornum);                               // 20.Сумма требований (в ин.валюте)
    csvFile.AddCell(iif((sql.value("CURRENCY_DEMAND") == "810") or (sql.value("CURRENCY_DEMAND") == "643")," ",iif(IsCB == false,abs(GetRestAccOnDate(DAcc,repdate,false)),fornum)));                               // 20.Сумма требований (в ин.валюте)
    If (valtype(sql.value("AMOUNT_DEMAND_RUR"))==26) fornum = sql.value("AMOUNT_DEMAND_RUR") else fornum = abs(sql.value("AMOUNT_DEMAND_RUR")) end;
    //csvFile.AddCell(fornum);                               // 21.Сумма требований (в руб.экв-те)
    csvFile.AddCell(iif(IsCB == false,abs(GetRestAccOnDate(DAcc,repdate,true)),fornum));                               // 21.Сумма требований (в руб.экв-те)
    //csvFile.AddCell(sql.value("ACCOUNT_LIABILITY"));       // 22.Лицевой счет обязательств
    csvFile.AddCell(iif(IsCB == false,LAcc,sql.value("ACCOUNT_LIABILITY")));       // 22.Лицевой счет обязательств
    //csvFile.AddCell(sql.value("CURRENCY_LIABILITY"));      // 23.Валюта счета обязательств
    csvFile.AddCell(iif(IsCB == false,LCur,sql.value("CURRENCY_LIABILITY")));      // 23.Валюта счета обязательств
    If (valtype(sql.value("AMOUNT_LIABILITY_VAL"))==26) fornum = sql.value("AMOUNT_LIABILITY_VAL") else fornum = abs(sql.value("AMOUNT_LIABILITY_VAL")) end;
    //csvFile.AddCell(fornum);                               // 24.Сумма обязательств (в ин.валюте)
    csvFile.AddCell(iif((sql.value("CURRENCY_LIABILITY") == "810") or (sql.value("CURRENCY_LIABILITY") == "643")," ",iif(IsCB == false,GetRestAccOnDate(LAcc,repdate,false),fornum)));                               // 24.Сумма обязательств (в ин.валюте)
    If (valtype(sql.value("AMOUNT_LIABILITY_RUR"))==26) fornum = sql.value("AMOUNT_LIABILITY_RUR") else fornum = abs(sql.value("AMOUNT_LIABILITY_RUR")) end;
    //csvFile.AddCell(fornum);                               // 25.Сумма обязательств (в руб.эквиваленте)
    csvFile.AddCell(iif(IsCB == false,GetRestAccOnDate(LAcc,repdate,true),fornum));                               // 25.Сумма обязательств (в руб.эквиваленте)
    /*MDA 19.03.2019 END*/
    csvFile.AddCell(sql.value("ACCOUNT_SS"));              // 26.Лицевой счет по учету справедливой стоимости ПФИ'
    If (valtype(sql.value("AMOUNT_SS_ACTIVE"))==26) fornum = sql.value("AMOUNT_SS_ACTIVE") else fornum = abs(sql.value("AMOUNT_SS_ACTIVE")) end;
    csvFile.AddCell(fornum);                               // 27.Справедливая стоимость актива
    If (valtype(sql.value("AMOUNT_SS_LIABILITY"))==26) fornum = sql.value("AMOUNT_SS_LIABILITY") else fornum = abs(sql.value("AMOUNT_SS_LIABILITY")) end;
    csvFile.AddCell(fornum);                               // 28.Справедливая стоимость обязательства
    //csvFile.AddCell(sql.value("IS_LIQ_NETTING"));          // 29.Наличие в соглашении по сделке условия ликвидационного неттинга (ДА/НЕТ)
    csvFile.AddCell(iif(sql.value("DEAL_EXCHANGE") == "Внебиржевая","НЕТ","ДА"));          // 29.Наличие в соглашении по сделке условия ликвидационного неттинга (ДА/НЕТ)
    //csvFile.AddCell(sql.value("IS_CLC_NETTING"));          // 30.Наличие в соглашении по сделке условия расчетного неттинга (ДА/НЕТ)
    csvFile.AddCell(iif(sql.value("DEAL_EXCHANGE") == "Внебиржевая","НЕТ","ДА"));          // 30.Наличие в соглашении по сделке условия расчетного неттинга (ДА/НЕТ)
    csvFile.AddCell(iif(sql.value("DEAL_EXCHANGE") == "Внебиржевая","ДА","НЕТ"));           // 31.Сделка зарегистрирована в репозитарии (ДА/НЕТ)
    csvFile.AddCell(sql.value("SWAP_PRC_CHANGE_DT"));      // 32.Процентные свопы. Ближайшая дата пересмотра процентной ставки
    csvFile.AddCell(sql.value("SWAP_BAL_ACC_FLOAT_RATE")); // 33.Процентные свопы. № счета 2-го порядка позиции с плавающей процентной ставкой.
    csvFile.AddCell("");
    csvFile.AddCell("");
    csvFile.AddCell("");
    csvFile.AddCell("");
    csvFile.AddCell("");
    csvFile.AddRow();
    UseProgress(count = count + 1);
    rn = rn + 1;

  end;
  RemProgress();

  csvFile.FileClose();
  csvTable.FillTabelFromCSV(csvFile.GetlsFileName());
  csvTable.EndTable();

  printEngine.CopyAllSheetInTotalBook(null, false, csvTable.GetTableRange(), 0, "Сделки ПФИ");
  printEngine.Close();

  printEngine.SaveTotalBook();
onerror()
  RemProgress();
end;

f657_7();
CreditRisk_RunReport( repdate, 2, OnlyCB );
exit(1);
