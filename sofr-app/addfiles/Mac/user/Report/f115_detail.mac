//-----------------------------------------------------------------------------------------
// Расшифровка для формы 115
// В.Горленко
//-----------------------------------------------------------------------------------------
import globals, Календарь, oralib, likepy, rcw, "DLReport_h.mac";

Private const kbF2 = 316, kbF3 = 317, kbF9 = 323, kbESC = 27, kbSpace = 32;
Private var parm = genObject ("CParam"), sqlString;
Private const decsep = GetLocaleInfo (0, LOCALE_SDECIMAL, not IsStandAlone ());

parm.("date") = {curdate};
parm.("rep1") = parm.("rep2") = parm.("rep3") = parm.("rep4") = "X";

while ( parm.run () )
    execMacro ("makeReport");
end;
exit (1);
//-----------------------------------------------------------------------------------------

Private macro createXls
    return CreateObject ("rsax", "TRsAxServer", "FmAxServer", isStandalone ()).CreateComObject ("Excel.Application");
OnError
   return NULL;
End;
//-----------------------------------------------------------------------------------------

Private macro collectOutProc ( str )
    sqlString = sqlString + "\n" + trim (str);
End;
//-----------------------------------------------------------------------------------------

Private macro CaptureOutput
   sqlString = "";
   SetOutHandler (@collectOutProc);
End;
//-----------------------------------------------------------------------------------------
                     
Private macro StopCaptureOutput
    SetOutHandler ();
    return sqlString;
End;
//-----------------------------------------------------------------------------------------

private class RowHeight(pIndex, pHeight)
    var index = pIndex;
    var height = pHeight;
end;
//-----------------------------------------------------------------------------------------

Private macro getRestRezerv1 ( fiid, catnum, tpl )
    Var templ = 0;
    if ( inList (catnum, 1253, 231) )
        templ = 4;
    elif ( inList (catnum, 235, 1207)/* and (tpl == 1)*/ )
        templ = 13;
    else
        return $0;
    end;
    Var sum = $0, sql, x;
    sql = execSqlSelect ("select sum (rsb_account.restall (t_account, t_chapter, t_code_currency, :1-1, 0)) from daccount_dbt where (t_chapter, t_account, t_code_currency) in "+
                         "(select t_chapter, t_account, t_currency from dmcaccdoc_dbt f where t_catnum = 241 and exists (select 1 from dmctempl_dbt where t_value1 in :2 and t_catid = (select t_id from dmccateg_dbt where t_number = 241) and t_number = t_templnum) and t_fiid = :3)",
                         makeArray (sqlParam ("1", parm.("date")-1), sqlParam ("2", templ), sqlParam ("3", fiid)));
    if ( sql.moveNext () and (valType (sql.value (0)) != 26) )
        return money (sql.value (0));
    end;
    return $0;
End;
//-----------------------------------------------------------------------------------------

private macro getRestRezerv2 (account)
  var sql;
  sql = "select nvl(rsb_account.restall (t_account, t_chapter, t_currency, :1-1, 0), 0) "
      + "from dmcaccdoc_dbt where t_catnum = 246 and t_docid = (select t_accountid from daccount_dbt where t_account = :2) ";
  sql = execSqlSelect(sql, makeArray(sqlParam("1", parm.("date")), sqlParam("2", account)));
    if ( sql.moveNext () and (valType (sql.value (0)) != 26) )
        return money (sql.value (0));
    end;
    return $0;
End;
//-----------------------------------------------------------------------------------------

Private macro formatAccount ( acc )
    if ( acc == "" ) return ""; end;
    return substr (acc, 1, 5)+"-"+substr (acc, 6, 3)+"-"+substr (acc, 9, 1)+"-"+substr (acc, 10, 4)+"-"+substr (acc, 14);
End;
//-----------------------------------------------------------------------------------------

Private macro getData_13_22 ( isBank )
    begAction (100, "Отбор данных для П-57", false);
    captureOutput ();
    [with parm as (select :1 t_dt from dual)
     select t_balance, (select t_shortname from dparty_dbt where t_partyid=t_issuer) t_issuer, t_percent, t_categ, t_rop, sum (t_sum) t_sum, t_long, sum (t_sumreserv) t_sumreserv, sum(t_or_sumreserv) t_or_sumreserv,
            count(1) over() as t_Count
     from (
       select t_account, a.t_templnum, a.t_docid, a.t_catnum, v.t_bcnumber
             ,substr (t_account, 1, 5) t_balance
             ,v.t_issuer
             ,-rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0) t_sum
             ,nvl ((select rsb_struct.getDouble (t_text) from dnotetext_dbt where t_objecttype = 24 and t_notekind = 16 and t_documentid = lpad (v.t_bcid, 10, '0') and (select t_dt from parm) between t_date and t_validtodate),
                   nvl ((select rsb_struct.getDouble (t_text) from dnotetext_dbt where t_objecttype = 3 and t_notekind = 78 and t_documentid = lpad (v.t_issuer, 10, '0') and (select t_dt from parm) between t_date and t_validtodate), 0)
                  ) t_rop
             ,nvl ((select t_reservepercent from ddlreslnk_dbt where t_type = 2 and t_parentid = a.t_docid and t_reservekind = 0 and t_reservesubkind = 0 and t_lnkdate = (select max (t_lnkdate) from ddlreslnk_dbt where t_type = 2 and t_parentid = a.t_docid and t_reservekind = 0 and t_reservesubkind = 0 and t_lnkdate < (select t_dt from parm))), 0) t_percent
             ,nvl ((select t_qualitycategory from ddlreslnk_dbt where t_type = 2 and t_parentid = a.t_docid and t_reservekind = 0 and t_reservesubkind = 0 and t_lnkdate = (select max (t_lnkdate) from ddlreslnk_dbt where t_type = 2 and t_parentid = a.t_docid and t_reservekind = 0 and t_reservesubkind = 0 and t_lnkdate < (select t_dt from parm))), 1) t_categ
             ,nvl ((select sum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0)) from dmcaccdoc_dbt aa where t_catnum = decode (a.t_catnum, 462, 463, 1492, 1460) and exists (select 1 from dmctempl_dbt where t_catid=aa.t_catid and t_number=aa.t_templnum and t_value1=11) and t_dockind=164 and t_docid = a.t_docid), 0) t_sumreserv
             ,case when a.t_catnum != 1492 or t_bcpresentationdate = to_date ('01010001','ddmmyyyy') then 0 when (select t_dt from parm)-t_bcpresentationdate > 180 then 4 when (select t_dt from parm)-t_bcpresentationdate > 90 then 3 when (select t_dt from parm)-t_bcpresentationdate > 30 then 2 else 1 end t_long
             ,nvl((select t_reserveamount from ddlreslnk_dbt reslnk
                   where t_type = 2
                         and t_reservesubkind = 5
                         and t_reservekind = 1
                         and t_parentid = v.t_bcid
                         and t_lnkdate = (select max(t_lnkdate) from ddlreslnk_dbt
                                          where t_parentid = reslnk.t_parentid
                                                and t_type = reslnk.t_type
                                                and t_reservekind = reslnk.t_reservekind
                                                and t_reservesubkind = reslnk.t_reservesubkind)), 0) t_or_sumreserv
       from dvsbanner_dbt v
       inner join dmcaccdoc_dbt a on t_catnum in (462, 1492) and t_dockind = 164 and t_bcid = t_docid
       where rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) != 0
             and ### exists (select 1 from dpartyown_dbt where t_partyid = v.t_issuer and t_partykind = 2)
             and not exists (select 1 from dmctempl_dbt where a.t_catnum = 1492 and t_catid = a.t_catid and t_number=a.t_templnum and t_value1 = 1))
       group by t_balance, t_issuer, t_percent, t_categ, t_rop, t_long
       order by t_balance]
    (ifThenElse (isBank, "", "not"));

    var sql = execSqlSelect (StopCaptureOutput (), makeArray (sqlParam ("1", parm.("date"))));
    endAction();

    return sql;
End;
//-----------------------------------------------------------------------------------------

Private macro getData_14_24 ( isBank )
    begAction (100, "Отбор данных", false);
    captureOutput ();
    [with parm as (select :1 t_dt from dual)
    select tt.*, count(1) over() as t_Count from (
      select t_balance, xxx, t_fiid, t_account, t_catnum, t_issuer, t_sum, t_percent, t_categ, t_sumreserv, t_rop, t_long, t_ropsum, t_portf
             ,case when t_portf = 2 and t_balance in ('50218', '50718') /*эти выводим всегда*/ then 1
                   when t_portf = 2 and t_balance in ('50220', '50720') /*эти выводим только когда есть 50218 или 50718*/
                     then sum(case when t_balance in ('50218', '50718') then 1 else 0 end) over(partition by t_fiid)
                   /*GAA:502082 when t_portf = 2 then t_sumreserv *//*остальные 502* и 507* если  есть резерв*/
                   when t_portf = 2
                   /*GAA:502082 по счетам 502 должна отражаться информация в случае начилия остатка на счетах, а не наличия резерва*/
                     THEN (SELECT COUNT (1)
                            FROM dmcaccdoc_dbt
                           WHERE  (    (SUBSTR (t_account, 1, 3) = '502'/* or SUBSTR (t_account, 1, 3) = '507'*/)
                                     AND t_fiid = t.t_fiid
                                     AND rsb_account.restall (
                                             t_account,
                                             t_chapter,
                                             t_currency,
                                             (SELECT t_dt - 1 FROM parm),
                                             t_currency) != 0))
                   else 1
             end count_portf
             , t_sum_baz /*GAA:504937 */
      from (
        select substr (m.t_account, 1, 5) t_balance
               ,fin.t_issuer xxx
               ,fin.t_fiid
               ,m.t_account
               ,m.t_catnum
               ,(select t_shortname from dparty_dbt where t_partyid=fin.t_issuer) || ' ' || fin.t_name t_issuer
               ,/*GAA:50208, 06.02.2020, old:  case when t_catnum = 231 and mctempl.t_value1 <> 4
                     then (select nvl (sum (-rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0)), 0) from (select distinct t_currency, t_chapter, t_account from dmcaccdoc_dbt where t_catnum=1207 and t_fiid=fin.t_fiid))
                        + (select nvl (sum (-rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0)), 0) from (SELECT DISTINCT t_currency, y.t_chapter, t_account FROM dmcaccdoc_dbt y, dmctempl_dbt mct WHERE mct.t_catid = y.t_catid and t_value3 = 0 and t_value1 = mctempl.t_value1 and y.t_templnum =mct.t_number AND t_catnum = 236 AND t_fiid = fin.t_fiid))
                     else 0
                end + */-nvl (rsb_account.restall (m.t_account, m.t_chapter, m.t_currency, (select t_dt-1 from parm), 0), 0) t_sum
                ,nvl ((select rsb_struct.getString (t_text) from dnotetext_dbt where t_objecttype=12 and t_notekind=3 and t_documentid=lpad (fin.t_fiid, 10, '0') and (select t_dt from parm) between t_date and t_validtodate), '0') t_percent
                ,nvl ((select t_attrid from dobjatcor_dbt where t_objecttype=12 and t_groupid=13 and t_object=lpad (fin.t_fiid, 10, '0') and (select t_dt from parm) between t_validfromdate and t_validtodate), 1) t_categ
                ,nvl ((select sum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0)) from dmcaccdoc_dbt aa where t_catnum = 241 and exists (select 1 from dmctempl_dbt where t_catid=aa.t_catid and t_number=aa.t_templnum and t_value1=4) and t_fiid=fin.t_fiid
                 and t_iscommon = chr (88)  /*GAA: 504937  иначе будет задвоение суммы резерва*/), 0) t_sumreserv
                ,nvl ((select rsb_struct.getDouble (t_text) from dnotetext_dbt where t_objecttype=12 and t_notekind=24 and t_documentid=lpad (fin.t_fiid, 10, '0') and (select t_dt from parm) between t_date and t_validtodate), '0') t_rop
                ,case when t_catnum=231 and mctempl.t_value1 = 4 then
                      case when t_drawingdate = to_date ('01010001','ddmmyyyy') then 0
                           when (select t_dt from parm)-t_drawingdate > 180 then 4
                           when (select t_dt from parm)-t_drawingdate > 90 then 3
                           when (select t_dt from parm)-t_drawingdate > 30 then 2
                           else 1 end
                      else 0 end t_long
                ,abs(nvl((select sum(case when t_portfolio = 2 then t_estreserve else t_correstreserve end) /*GAA:502082*/
                         from dpmwrtsum_dbt
                         where      t_Trust = chr(0)
                              and t_Buy_Sale <> 2
                              and t_Amount <> 0.000000000000
                              and t_FIID = fin.t_fiid), 0)) t_ropsum
                 ,case when mccateg.t_class1 = 474 then mctempl.t_value1
                       when mccateg.t_class2 = 474 then mctempl.t_value2
                       when mccateg.t_class3 = 474 then mctempl.t_value3
                       when mccateg.t_class4 = 474 then mctempl.t_value4
                       when mccateg.t_class5 = 474 then mctempl.t_value5
                       when mccateg.t_class6 = 474 then mctempl.t_value6
                       when mccateg.t_class7 = 474 then mctempl.t_value7
                       when mccateg.t_class8 = 474 then mctempl.t_value8
                       else -1
                 end t_portf
                ,/*GAA:504937 Т.к. по новым требованиям банка нужно выводить отдельные строки по УНКД, Премии и вложениям, то посчитаем  базу для расчета резерва,*/
                case when t_catnum = 231 /*and mctempl.t_value1 <> 4*/
                          then (select nvl (sum (-rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0)), 0) from (select distinct t_currency, t_chapter, t_account from dmcaccdoc_dbt where t_catnum=1207 and t_fiid=fin.t_fiid))
                               + (select nvl (sum (-rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0)), 0) from (SELECT DISTINCT t_currency, y.t_chapter, t_account FROM dmcaccdoc_dbt y, dmctempl_dbt mct WHERE mct.t_catid = y.t_catid and t_value3 = 0 and t_value1 = mctempl.t_value1 and y.t_templnum =mct.t_number AND t_catnum = 236 AND t_fiid = fin.t_fiid))
                     when t_catnum = 1207
                          then (select nvl (sum (-rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0)), 0) from (select distinct t_currency, y11.t_chapter, t_account from dmcaccdoc_dbt y11, dmctempl_dbt mct11 WHERE mct11.t_catid = y11.t_catid /*and mct11.t_value1 <> 4*/ and y11.t_catnum = 231 AND y11.t_fiid = fin.t_fiid ))
                               + (select nvl (sum (-rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0)), 0) from (SELECT DISTINCT t_currency, y12.t_chapter, t_account FROM dmcaccdoc_dbt y12, dmctempl_dbt mct12 WHERE mct12.t_catid = y12.t_catid and t_value3 = 0 and t_value1 = mctempl.t_value1 and y12.t_templnum =mct12.t_number AND t_catnum = 236 AND t_fiid = fin.t_fiid))
                     when t_catnum = 236
                          then (select nvl (sum (-rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0)), 0) from (select distinct t_currency, t_chapter, t_account from dmcaccdoc_dbt where t_catnum=1207 and t_fiid=fin.t_fiid))
                               +(select nvl (sum (-rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0)), 0) from (select distinct t_currency, y2.t_chapter, t_account from dmcaccdoc_dbt y2, dmctempl_dbt mct2 WHERE mct2.t_catid = y2.t_catid /*and mct2.t_value1 <> 4*/ and y2.t_catnum = 231 AND y2.t_fiid = fin.t_fiid ))
                     else 0 end +
                - NVL (rsb_account.restall (m.t_account, m.t_chapter, m.t_currency, (SELECT t_dt - 1 FROM parm), 0), 0) t_sum_baz /*GAA*/
        from dmcaccdoc_dbt m, dfininstr_dbt fin, dmccateg_dbt mccateg, dmctempl_dbt mctempl
        where (   t_catnum in (231, 1253, 233, 1298, 1246, 1250, 1237, 1299, 1245/*GAA: 502082*/,1207)
            or (t_catnum = 236 /*GAA: 502082, old: and mctempl.t_value3=1*/))
            and rsb_account.restall (m.t_account, m.t_chapter, m.t_currency, (select t_dt-1 from parm), m.t_currency) != 0
            and fin.t_fiid = case when t_catnum in (231, 1253, 1250, 1237, 1299, 1245, 236/*GAA: 502082*/, 1207) then m.t_fiid when t_dockind = 176 then (select t_pfi from ddl_tick_dbt where t_dealid = (select t_dealid from ddl_leg_dbt where t_id = t_docid)) end
            --and fin.t_fiid = 15346
            and mccateg.t_id = m.t_catid
            and mctempl.t_catid = m.t_catid
            and mctempl.t_number = m.t_templnum
            and ### exists (select 1 from dpartyown_dbt where t_partykind = 2 and t_partyid = decode (substr (t_account, 4, 2), '18', (select t_partyid from ddl_tick_dbt where RSB_SECUR.IsRepo(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(t_DealType, t_BofficeKind))) = 0 and t_dealid=(select t_dealid from ddl_leg_dbt where t_id=t_docid and t_legid=0 and t_legkind=0)), fin.t_issuer))
            ) t
          group by t_fiid, t_account, t_balance, xxx, t_catnum, t_issuer, t_percent, t_categ, t_rop, t_long, t_portf, t_sum, t_sumreserv, t_ropsum, t_sum_baz /*GAA:504937 */
          order by t_balance) tt
    where t_portf <> 1
    and count_portf > 0]
    (ifThenElse (isBank, "", "not"));

    var sql = execSqlSelect (StopCaptureOutput (), makeArray (sqlParam ("1", parm.("date"))));
    endAction();

    return sql;
End;
//-----------------------------------------------------------------------------------------

Private macro getDate_16_25 ( isBank )
    begAction (100, "Отбор данных", false);
    captureOutput ();
    [with parm as (select :1 t_dt from dual)
     select substr (t_account, 1, 5) t_balance, t_fiid, t_account, t_catnum, (select t_shortname from dparty_dbt where t_partyid=(select t_partyid from ddl_tick_dbt where t_dealid=t.t_dealid)) t_issuer
           ,nvl (-rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0), 0) t_sum
           ,nvl ((select rsb_struct.getDouble (t_text) from dnotetext_dbt where t_objecttype=101 and t_notekind=3 and t_documentid=lpad (t_dealid, 34, '0') and (select t_dt from parm) between t_date and t_validtodate), 0) t_percent
           ,nvl ((select t_attrid from dobjatcor_dbt where t_objecttype=101 and t_groupid=13 and t_object=lpad (t_dealid, 34, '0') and (select t_dt from parm) between t_validfromdate and t_validtodate), 1) t_categ
           ,nvl ((select sum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0)) from dmcaccdoc_dbt aa where t_catnum = 242 and exists (select 1 from dmctempl_dbt where t_catid=aa.t_catid and t_number=aa.t_templnum and t_value1=decode (t.t_catnum, 609, 9, 8)) and exists (select 1 from ddl_leg_dbt where t_dealid=t.t_dealid and t_id=t_docid)), 0) t_sumreserv
           ,case when t_catnum=700 then
              (select case when t_expiry = to_date ('01010001','ddmmyyyy') then 0
                           when (select t_dt from parm)-t_expiry > 180 then 4
                           when (select t_dt from parm)-t_expiry > 90 then 3
                           when (select t_dt from parm)-t_expiry > 30 then 2
                           else 1 end
               from ddl_leg_dbt where t_dealid = t.t_dealid and t_legkind = 2)
             else 0 end t_long,
            count(1) over() as t_Count
     from (
       select (select t_pfi from ddl_tick_dbt where t_dealid = (select t_dealid from ddl_leg_dbt where t_id = t_docid)) t_fiid
             ,(select t_dealid from ddl_leg_dbt where t_id=t_docid) t_dealid
             ,t_account
             ,t_chapter
             ,t_currency
             ,t_catnum
             ,t_templnum
       from dmcaccdoc_dbt where t_catnum in (603, 700) and t_dockind = 176
       and rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) != 0
     ) t
     where ### exists (select 1 from dpartyown_dbt where t_partyid = (select t_partyid from ddl_tick_dbt where t_dealid=t.t_dealid) and t_partykind = 2)
     group by t_dealid, t_fiid, t_account, t_chapter, t_currency, t_catnum, t_templnum
     order by 1]
    (ifThenElse (isBank, "", "not"));

    var sql = execSqlSelect (StopCaptureOutput (), makeArray (sqlParam ("1", parm.("date"))));
    endAction();

    return sql;
End;
//-----------------------------------------------------------------------------------------

Private macro getData_18_27 ( isBank )
    begAction (100, "Отбор данных", false);
    captureOutput ();
    [with parm as (select :1 t_dt from dual)
        select tt.*, count(1) over() as t_Count
        from (
        select t_balance, t_issuer, sum(t_sum) t_sum, t_percent, t_categ, sum(t_sumreserv) t_sumreserv, t_rop, sum(t_ropsum) t_ropsum, t_long, /*GAA: 504937 */t_sum_baz
           from (select substr (t_account, 1, 5) t_balance -- векселя
                       ,(select t_shortname from dparty_dbt where t_partyid = (select t_issuer from dvsbanner_dbt where t_bcid=t_docid)) t_issuer
                       ,nvl (-rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0), 0) t_sum
                       ,nvl ((select t_reservepercent from ddlreslnk_dbt where t_type = 2 and t_parentid = t.t_docid and t_reservekind = 0 and t_reservesubkind = 0 and t_lnkdate = (select max (t_lnkdate) from ddlreslnk_dbt where t_type = 2 and t_parentid = t.t_docid and t_reservekind = 0 and t_reservesubkind = 0 and t_lnkdate < (select t_dt from parm))), 0) t_percent
                       ,nvl ((select t_qualitycategory from ddlreslnk_dbt where t_type = 2 and t_parentid = t.t_docid and t_reservekind = 0 and t_reservesubkind = 0 and t_lnkdate = (select max (t_lnkdate) from ddlreslnk_dbt where t_type = 2 and t_parentid = t.t_docid and t_reservekind = 0 and t_reservesubkind = 0 and t_lnkdate < (select t_dt from parm))), 1) t_categ
                       ,nvl ((select sum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0)) from dmcaccdoc_dbt aa where t_catnum = 463 and exists (select 1 from dmctempl_dbt where t_catid=aa.t_catid and t_number=aa.t_templnum and t_value1=12) and t_dockind=164 and t_docid = t.t_docid), 0) t_sumreserv
                       ,nvl ((select rsb_struct.getDouble (t_text) from dnotetext_dbt where t_objecttype = 24 and t_notekind = 16 and t_documentid = lpad (t.t_docid, 10, '0') and (select t_dt from parm) between t_date and t_validtodate),
                             nvl ((select rsb_struct.getDouble (t_text) from dnotetext_dbt where t_objecttype = 3 and t_notekind = 78 and t_documentid = (select lpad (t_issuer, 10, '0') from dvsbanner_dbt where t_bcid=t_docid) and (select t_dt from parm) between t_date and t_validtodate), 0)
                            ) t_rop
                       ,abs(nvl((select t_reserveamount from ddlreslnk_dbt reslnk
                             where t_type = 2
                                   and t_reservesubkind = 5
                                   and t_reservekind = 1
                                   and t_parentid = t.t_docid
                                   and t_lnkdate = (select max(t_lnkdate) from ddlreslnk_dbt
                                                    where t_parentid = reslnk.t_parentid
                                                          and t_type = reslnk.t_type
                                                          and t_reservekind = reslnk.t_reservekind
                                                          and t_reservesubkind = reslnk.t_reservesubkind)), 0)) t_ropsum
                       ,0 t_long
                       ,0 t_sum_baz /*GAA: 504937 */
                 from dmcaccdoc_dbt t where (t_catnum = 464 or (t_catnum = 1492 and t_templnum = 2))
                 and rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) != 0
                 and ### exists (select 1 from dpartyown_dbt where t_partykind = 2 and t_partyid = (select t_issuer from dvsbanner_dbt where t_bcid=t_docid))
                ) group by t_balance, t_issuer, t_percent, t_categ, t_rop, t_long
         union
         select t_balance, t_issuer, t_sum, t_percent, t_categ, t_sumreserv, t_rop, t_ropsum, t_long, /*GAA: 504937 */t_sum_baz
         from (select substr (t_account, 1, 5) t_balance -- ц. бумаги
                     ,(select (select t_shortname from dparty_dbt where t_partyid=t_issuer) || ' ' || t_name from dfininstr_dbt where t_fiid = t.t_fiid) t_issuer
                     ,nvl (-sum (rsb_account.restall (t_account, t.t_chapter, t.t_currency, (select t_dt-1 from parm), 0)), 0)
                      /*GAA:502082 06.02.2020, old: + nvl((select -rsb_account.restall (t_account, t.t_chapter, t_currency, (select t_dt-1 from parm), 0) from dmcaccdoc_dbt
                         where     t_catnum = 1207
                               and t_iscommon = 'X'
                               and t_fiid = t.t_fiid
                               and rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0) != 0
                               and substr(t_account, 1, 5) = substr(t.t_account, 1, 5)), 0)*/ t_sum
                     ,nvl ((select to_number (rtrim (rsb_struct.getString (t_text), chr (0))) from dnotetext_dbt where translate (rtrim (rsb_struct.getString (t_text), chr (0)), '_1234567890.', '_') is null and t_objecttype=12 and t_notekind=3 and t_documentid=lpad (t_fiid, 10, '0') and (select t_dt from parm) between t_date and t_validtodate), 0) t_percent
                     ,nvl ((select t_attrid from dobjatcor_dbt where t_objecttype = 12 and t_groupid = 13 and t_object = lpad (t_fiid, 10, '0') and (select t_dt from parm) between t_validfromdate and t_validtodate), 1) t_categ
                     ,nvl ((select sum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0)) from dmcaccdoc_dbt aa where t_catnum = 241 and exists (select 1 from dmctempl_dbt where t_catid=aa.t_catid and t_number=aa.t_templnum and t_value1=13) and t_iscommon = 'X' and t_fiid = t.t_fiid), 0) t_sumreserv
                     ,nvl ((select rsb_struct.getDouble (t_text) from dnotetext_dbt where t_objecttype=12 and t_notekind=24 and t_documentid=lpad (t.t_fiid, 10, '0') and (select t_dt from parm) between t_date and t_validtodate), '0') t_rop
                     ,abs(nvl((select sum(case when t_portfolio = 2 then t_estreserve else t_correstreserve end) /*GAA: 502082, old: sum(t_correstreserve) */
                            from dpmwrtsum_dbt
                            where      t_Trust = chr(0)
                                  and t_Buy_Sale <> 2
                                  and t_Amount <> 0.000000000000
                                  and t_FIID = t.t_fiid), 0)) t_ropsum
                     ,0 t_long
                     ,mctempl.t_value1 t_portf
                     /*GAA: 504937 */
                    ,sum (case when  mctempl.t_value4  <> 1
                                then nvl( (select sum(-rsb_account.restall (dmc.t_account, t.t_chapter, dmc.t_currency, (select t_dt-1 from parm), 0))
                                             from dmcaccdoc_dbt dmc, dmctempl_dbt tmp
                                            where dmc.t_iscommon = 'X'  and tmp.T_ISCLOSE <> 'X' and dmc.t_fiid = t.t_fiid and dmc.t_catid = tmp.t_catid and tmp.t_number = dmc.t_templnum and mctempl.t_value1 = tmp.t_value1 AND mctempl.t_value2 = tmp.t_value2 AND mctempl.t_value3 = tmp.t_value3 and tmp.t_value4 = 1), 0)
                                when  mctempl.t_value4 <> 2
                                then nvl((select sum(-rsb_account.restall (dmc.t_account, t.t_chapter, dmc.t_currency, (select t_dt-1 from parm), 0)) from dmcaccdoc_dbt dmc, dmctempl_dbt tmp
                                           where dmc.t_iscommon = 'X' and tmp.T_ISCLOSE <> 'X' and dmc.t_fiid = t.t_fiid and dmc.t_catid = tmp.t_catid and tmp.t_number = dmc.t_templnum and mctempl.t_value1 = tmp.t_value1 AND mctempl.t_value2 = tmp.t_value2 AND mctempl.t_value3 = tmp.t_value3 and tmp.t_value4 = 2), 0)
                                ELSE 0 end
                      + nvl (- rsb_account.restall (t_account, t.t_chapter, t.t_currency, (select t_dt-1 from parm), 0), 0)   )   t_sum_baz /*GAA: 504937 */
               from dmcaccdoc_dbt t, dmctempl_dbt mctempl
               where t_catnum in (235)
                     and exists (select 1 from dmctempl_dbt where t_catid=t.t_catid and t_number=t_templnum and t_value4 in (1,2))
                     and rsb_account.restall (t_account, t.t_chapter, t.t_currency, (select t_dt-1 from parm), t.t_currency) != 0 and t_iscommon = 'X'
                     and ### exists (select 1 from dpartyown_dbt where t_partykind = 2 and t_partyid = case when t_dockind=176 and substr (t_account, 4, 2)='18' then (select t_partyid from ddl_tick_dbt where t_dealid=(select t_dealid from ddl_leg_dbt where t_id=t_dealid)) else (select t_issuer from dfininstr_dbt where t_fiid=t.t_fiid) end)
                     and mctempl.t_catid = t.t_catid
                     --and t.t_fiid = 15346
                     and mctempl.t_number = t.t_templnum
                     and mctempl.t_value1 <> 1
               group by t_fiid, /*GAA:502082, old: substr (*/t_account/*, 1, 5)*/, t.t_chapter, mctempl.t_value1 /*GAA: 504937*/, mctempl.t_value4 ) m
         /* where t_portf <> 2 or t_balance='50218' or t_sumreserv<>0*/  /*GAA: 502082, old: where t_sumreserv<>0*/
         union
         select t_balance -- репо
               ,(select t_shortname from dparty_dbt where t_partyid = (select t_partyid from ddl_tick_dbt where t_dealid = t.t_dealid)) t_issuer
               ,nvl (sum (t_sum), 0) t_sum
               ,nvl ((select rsb_struct.getDouble (t_text) from dnotetext_dbt where t_objecttype=101 and t_notekind=3 and t_documentid=lpad (t_dealid, 34, '0') and (select t_dt from parm) between t_date and t_validtodate), 0) t_percent
               ,nvl ((select t_attrid from dobjatcor_dbt where t_objecttype=101 and t_groupid=13 and t_object=lpad (t_dealid, 34, '0') and (select t_dt from parm) between t_validfromdate and t_validtodate), 1) t_categ
               ,nvl ((select sum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0)) from dmcaccdoc_dbt aa where t_catnum in( 242) and exists (select 1 from dmctempl_dbt where t_catid=aa.t_catid and t_number=aa.t_templnum and t_value1 = decode (t.t_catnum, 611, 15, 16)) and exists (select 1 from ddl_leg_dbt where t_dealid=t.t_dealid and t_id=t_docid)), 0) t_sumreserv
               ,0 t_rop
               ,abs(nvl ((select sum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0)) from dmcaccdoc_dbt aa where t_catnum in (1490,1491) and exists (select 1 from dmctempl_dbt where t_catid=aa.t_catid and t_number=aa.t_templnum and t_value1 = decode (t.t_catnum, 611, 23, 25)) and exists (select 1 from ddl_leg_dbt where t_dealid=t.t_dealid and t_id=t_docid)), 0)) t_ropsum
               ,case when t_catnum=611 then
                  (select case when t_expiry = to_date ('01010001','ddmmyyyy') then 0
                               when (select t_dt from parm)-t_expiry > 180 then 4
                               when (select t_dt from parm)-t_expiry > 90 then 3
                               when (select t_dt from parm)-t_expiry > 30 then 2
                               else 1 end
                   from ddl_leg_dbt where t_dealid = t.t_dealid and t_legkind = 2)
                 else 0 end t_long
               ,0 t_sum_baz /*GAA: 504937*/
         from (
           select substr (t_account, 1, 5) t_balance
                 ,(select t_dealid from ddl_leg_dbt where t_id=t_docid) t_dealid
                 ,-rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0) t_sum
                 ,t_catnum
                 ,decode (substr (t_account, 4, 2), '18', (select t_partyid from ddl_tick_dbt where t_dealid=(select t_dealid from ddl_leg_dbt where t_id=t_docid)), (select t_issuer from dfininstr_dbt where t_fiid=m.t_fiid)) t_party
           from dmcaccdoc_dbt m where t_catnum in (611, 621) and t_dockind = 176
           and exists (select 1 from ddl_tick_dbt where t_dealid = (select t_dealid from ddl_leg_dbt where t_id=t_docid) and t_dealtype in (2122, 12122, 12123, 12132, 12133, 12134))
           and rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) != 0) t
         where ### exists (select 1 from dpartyown_dbt where t_partykind = 2 and t_partyid = t.t_party)
         group by t_catnum, t_balance, t_dealid
         order by 1) tt]
    (ifThenElse (isBank, "", "not"), ifThenElse (isBank, "", "not"), ifThenElse (isBank, "", "not"));

    var sql = execSqlSelect (StopCaptureOutput (), makeArray (sqlParam ("1", parm.("date"))));
    endAction();

    return sql;
End;
//-----------------------------------------------------------------------------------------

Private macro getData_17_26 ( isBank )
    begAction (100, "Отбор данных", false);
    captureOutput ();
    [with parm as (select :1 t_dt from dual)
     select t_balance
           ,t_nameaccount
           ,decode (t_kind_account, 'А', -1, 1)*rsb_account.restall (t_account, t_chapter, t_code_currency, (select t_dt-1 from parm), 0) t_sum
           ,(select count (1) from dsfcontr_dbt where t_object = a.t_account)
           ,nvl ((select rsb_struct.getDouble (t_text) from dnotetext_dbt where t_objecttype=4 and t_notekind=3 and t_documentid=lpad (t_chapter, 2, '0')||replace (to_char (t_code_currency, 'xxxxxx'), ' ', '0')||t_account and (select t_dt from parm) between t_date and t_validtodate), 0) t_percent
           ,nvl ((select t_attrid from dobjatcor_dbt where t_objecttype=4 and t_groupid=13 and t_object=lpad (t_chapter, 2, '0')||replace (to_char (t_code_currency, 'xxxxxx'), ' ', '0')||t_account and (select t_dt from parm) between t_validfromdate and t_validtodate), 1) t_categ
           ,nvl ((select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0) from dmcaccdoc_dbt where t_catnum = 246 and t_docid = a.t_accountid), 0) t_sumreserv
           ,case when t_balance in ('60201', '60202', '60203', '60204')
                 then nvl((select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0) from dmcaccdoc_dbt mm where t_catnum = 247 and exists(select 1 from dmctempl_dbt where t_catid=mm.t_catid and t_number=mm.t_templnum and t_value3 = 4) and t_docid = a.t_accountid)
                         - (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0) from dmcaccdoc_dbt mm where t_catnum = 248 and exists(select 1 from dmctempl_dbt where t_catid=mm.t_catid and t_number=mm.t_templnum and t_value3 = 4) and t_docid = a.t_accountid), 0)
                 else 0 end t_ropsum
           ,count(1) over() as t_Count];
    if ( isBank )
       [from daccount_dbt a where (((t_chapter, t_code_currency, t_account)
        in (select t_chapter, t_currency, t_account from dmcaccdoc_dbt mc where t_catnum in (217, 218, 219, 220, 1366/*GAA: 502082 */,5071)
            or (t_catnum = 641 and t_iscommon = 'X' and exists (select 1 from dpartyown_dbt where t_partykind = 2 and t_partyid = t_contractor)
                and exists (select 1 from dmctempl_dbt where t_catid = mc.t_catid and t_number = mc.t_templnum and not t_value1 in (2, 8)))))
          or (t_balance in ('60201', '60203')))
        and rsb_account.restall (t_account, t_chapter, t_code_currency, (select t_dt-1 from parm), t_code_currency) != 0];
    else
        [from daccount_dbt a where ((t_chapter=1 and exists (select 1 from daccbalance_dbt where t_accountid = a.t_accountid and t_numplan = 0 and t_balance in ('47901', '60202', '60204'))) or
                                    ((t_account, t_chapter, t_code_currency) in (select t_account, t_chapter, t_currency from dmcaccdoc_dbt mc
                                                where t_catnum = 641 and t_iscommon = 'X' and not exists (select 1 from dpartyown_dbt where t_partykind = 2 and t_partyid = t_contractor)
                                                      and exists (select 1 from dmctempl_dbt where t_catid = mc.t_catid and t_number = mc.t_templnum and not t_value1 in (2, 8)))))
         and rsb_account.restall (t_account, t_chapter, t_code_currency, (select t_dt-1 from parm), t_code_currency) != 0];
    end;
    [order by 1];

    var sql = execSqlSelect (StopCaptureOutput (), makeArray (sqlParam ("1", parm.("date"))));
    endAction();

    return sql;
End;
//-----------------------------------------------------------------------------------------

private macro getDate_15_23 ( isBank )
    begAction (100, "Отбор данных", false);
    captureOutput ();
    [with parm as (select :1 t_dt from dual)
      select t_balance, t_issuer, sum(t_sum) t_sum, t_percent, t_categ, sum(t_sumreserv) t_sumreserv, sum(t_ropsum) t_ropsum, count(1) over() as t_Count
      from (select substr (t_account, 1, 5) t_balance,
                   (select t_shortname from dparty_dbt where t_partyid = mcacc.t_contractor) t_issuer,
                   nvl (-rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0), 0) t_sum,
                   nvl ((select rsb_struct.getDouble (t_text) from dnotetext_dbt where t_objecttype=4 and t_notekind=3 and t_documentid=lpad (t_chapter, 2, '0')||replace (to_char (t_currency, 'xxxxxx'), ' ', '0')||t_account and (select t_dt-1 from parm) between t_date and t_validtodate), 0) t_percent,
                   nvl ((select t_attrid from dobjatcor_dbt where t_objecttype=4 and t_groupid=13 and t_object=lpad (t_chapter, 2, '0')||replace (to_char (t_currency, 'xxxxxx'), ' ', '0')||t_account and (select t_dt-1 from parm) between t_validfromdate and t_validtodate), 1) t_categ,
                   case when t_catnum = 311 then nvl((select sum(rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0))
                                                      from dmcaccdoc_dbt aa
                                                      where t_catnum = 242 and t_iscommon = chr(0) and t_docid in (select t_id from ddvndeal_dbt where t_contractor = 488)
                                                           and exists (select 1 from dmctempl_dbt where t_catid=aa.t_catid and t_number=aa.t_templnum and t_value1 in (7, 10))), 0)
                        else nvl ((select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0) from dmcaccdoc_dbt where t_catnum = 246 and t_docid = (select t_accountid from daccount_dbt where t_account = mcacc.t_account and t_chapter = mcacc.t_chapter and t_code_currency = mcacc.t_currency )), 0)
                   end t_sumreserv,
                   nvl((select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0) from dmcaccdoc_dbt mm where t_catnum = 247
                        and exists(select 1 from dmctempl_dbt where t_catid=mm.t_catid and t_number=mm.t_templnum and t_value3 = 4)
                        and t_docid = (select t_accountid from daccount_dbt where t_account = mcacc.t_account and t_chapter = mcacc.t_chapter and t_code_currency = mcacc.t_currency ))
                       - (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0) from dmcaccdoc_dbt mm where t_catnum = 248
                           and exists(select 1 from dmctempl_dbt where t_catid=mm.t_catid and t_number=mm.t_templnum and t_value3 = 4)
                           and t_docid = (select t_accountid from daccount_dbt where t_account = mcacc.t_account and t_chapter = mcacc.t_chapter and t_code_currency = mcacc.t_currency )), 0) t_ropsum
            from dmcaccdoc_dbt mcacc
            where t_catnum in (307, 311/*5074, 5010, 5130*/, 315/*5135*/)
                  --and t_dockind in (199, 4813, 4815)
                  and t_iscommon = 'X'
                  and rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) != 0
                  and ### exists (select 1 from dpartyown_dbt where t_partykind = 2 and t_partyid = mcacc.t_contractor)
            )
      group by t_balance, t_issuer, t_percent, t_categ
     order by 1]
    (ifThenElse (isBank, "", "not"));

    var sql = execSqlSelect (StopCaptureOutput (), makeArray (sqlParam ("1", parm.("date"))));
    endAction();

    return sql;
End;
//-----------------------------------------------------------------------------------------

PRIVATE CLASS (DL_CReportTemplate) f115_details_1
   macro BeginReport()
   end;

   MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
   END;

   macro Create()
      var A15 = 0;
      var Sum1 = 0, Sum2 = 0, Sum3 = 0;
      var i = 0, c = 0;
      var rez;

      SetActiveSheet("П-57");

      begAction (100, "Отбор данных для П-57", false);
      captureOutput ();
      [with parm as (select :1 t_dt from dual)
       select t.*, count (1) over () t_cnt from
         (select t_nameaccount
               ,NVL((select t_number||' от '||to_char (t_dateconc, 'dd.mm.yyyy') from dsfcontr_dbt where t_servkind=1 and t_contractorid = (select t_marketplaceid from dmcaccdoc_dbt where t_account=a.t_account and t_chapter=a.t_chapter and t_currency=a.t_code_currency and t_marketplaceid > 0 and rownum = 1)), chr(0)) t_contr
               ,t_account
               ,-rsb_account.restall (t_account, t_chapter, t_code_currency, (select t_dt-1 from parm), 0) t_rest
               ,'1' t_categ
               ,'0' t_rezerv
               ,0 t_fiid
               ,chr(0) t_portf
               ,1 t_part
               ,substr (t_account, 1, 8)||substr (t_account, 10) t_sort
               ,0 t_catnum
               ,0 t_templ
         from daccount_dbt a
         where (exists (select 1 from dmcaccdoc_dbt where (select t_dt from parm) between t_activatedate and decode (t_disablingdate, to_date ('01010001','ddmmyyyy'), to_date ('31129999','ddmmyyyy')) and
                t_catnum in (217, 219, 220, 218) and t_chapter = a.t_chapter and t_account = a.t_account and t_currency = a.t_code_currency) or
                t_balance in ('60201', '60202', '60203', '60204', '47901'))
           and rsb_account.restall (t_account, t_chapter, t_code_currency, (select t_dt-1 from parm), 0) != 0
         union all
         select NVL(case when t_catnum = 641 then (select t_nameaccount from daccount_dbt where t_account = t.t_account) else (select t_name from dfininstr_dbt where t_fiid=t.t_fiid) end, chr(0)) t_nameaccount
                ,chr(0) t_contrt
                ,t_account
                ,-rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0) t_rest
                ,nvl ((select (select t_nameobject from dobjattr_dbt where t_objecttype=12 and t_groupid=13 and t_attrid=t.t_attrid) from dobjatcor_dbt t where (select t_dt from parm) between t_validfromdate and t_validtodate and t_objecttype = 12 and t_groupid = 13 and (select t_dt from parm) between t_validfromdate and t_validtodate and t_object=lpad (t_fiid, 10, '0')), '1') t_categ
                ,nvl ((select rsb_struct.getString (t_text) from dnotetext_dbt t where t_objecttype = 12 and t_notekind = 3 and (select t_dt from parm) between t_date and t_validtodate and t_documentid = lpad (t_fiid, 10, '0')), '0') t_rezerv
                ,t_fiid
                ,case when t_catnum in (231, 1253) then 'вложение'
                      when t_catnum = 1207 then 'УНКД'
                      when t_catnum = 236 then 'премия'
                      when t_catnum = 235 and exists (select 1 from dmctempl_dbt where t_catid=(select t_catid from dmccateg_dbt where t_number=t_catnum) and t_value3=0 and t_value4 in (1, 4)) then 'купон'
                      when t_catnum = 235 and exists (select 1 from dmctempl_dbt where t_catid=(select t_catid from dmccateg_dbt where t_number=t_catnum) and t_value3=0 and t_value4 in (2, 5)) then 'дисконт'
                      else chr(0)
                 end t_portf
                 ,2 t_part
                 ,substr (t_account, 1, 8)||substr (t_account, 10) t_sort
                 ,t_catnum
                 ,nvl ((select t_value4 from dmctempl_dbt where t_catid=(select t_id from dmccateg_dbt where t_number = t.t_catnum) and t_number=t.t_templnum and t_value3=0 and t.t_catnum=235), 0) t_templ
         from (
            select t_catnum, t_templnum, t_fiid, t_currency, a.t_account, a.t_chapter
            from dmcaccdoc_dbt m 
            inner join daccount_dbt a on a.t_account=m.t_account and a.t_chapter=m.t_chapter and a.t_code_currency=m.t_currency
            where (t_catnum in (641, 1253, 1207) or 
                  (t_catnum = 236 and exists (select 1 from dmctempl_dbt where t_catid=m.t_catid and t_number=m.t_templnum and t_value3=0)) or
                  (t_catnum = 235 and exists (select 1 from dmctempl_dbt where t_catid=m.t_catid and t_number=m.t_templnum and t_value3=0 and t_value4 in (1,2,4,5))) or
                  (t_catnum = 235 and exists (select 1 from dmctempl_dbt where t_catid=m.t_catid and t_number=m.t_templnum and t_value4=1)) or
                  (t_catnum = 231 and not exists (select 1 from dmctempl_dbt where t_catid=m.t_catid and t_number=m.t_templnum and t_value1=1)))
            and t_iscommon = 'X' 
            and rsb_account.restall (a.t_account, a.t_chapter, a.t_code_currency, (select t_dt-1 from parm), 0) != 0
            group by t_catnum, t_templnum, t_fiid, t_currency, a.t_account, a.t_chapter) t
       union all
          select (select t_nameaccount from daccount_dbt where t_account = t.t_account and t_code_currency = t.t_currency and t_chapter = t.t_chapter) nameaccount,
                 chr(0) t_contrt,
                 t_account,
                 -rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0) t_rest,
                 nvl ((select (select t_nameobject from dobjattr_dbt where t_objecttype=12 and t_groupid=13 and t_attrid=t.t_attrid) from dobjatcor_dbt t where t_objecttype=101 and t_groupid=13 and t_object=lpad (t_dealid, 34, '0') and (select t_dt from parm) between t_validfromdate and t_validtodate), '1') t_categ,
                 to_char (nvl ((select sum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0)) from dmcaccdoc_dbt aa where t_catnum = 242 and exists (select 1 from dmctempl_dbt where t_catid=aa.t_catid and t_number=aa.t_templnum and t_value1 = decode (t.t_catnum, 611, 15, 16)) and exists (select 1 from ddl_leg_dbt where t_dealid=t.t_dealid and t_id=t_docid)), 0)) t_reserv,
                 (select t_pfi from ddl_tick_dbt where t_dealid = t.t_dealid) t_fiid,
                 chr(0) t_portf,
                 1 t_part,
                 substr (t_account, 1, 8)||substr (t_account, 10) t_sort,
                 t_catnum,
                 0 t_templ 
          from (
            select distinct t_account,
                   t_chapter,
                   t_currency,
                   (select t_dealid from ddl_leg_dbt where t_id=t_docid) t_dealid,
                   t_catnum,
                   t_fiid
            from dmcaccdoc_dbt m
            where     t_catnum in (611, 621) and t_dockind = 176
                  and (select t_dt from parm) between t_activatedate and decode (t_disablingdate, to_date ('01010001','ddmmyyyy'), to_date ('31129999','ddmmyyyy'))
                  and exists (select 1 from ddl_tick_dbt where t_dealid = (select t_dealid from ddl_leg_dbt where t_id=t_docid) and t_dealtype in (2122, 12122, 12123, 12132, 12133, 12134))
                  and rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) != 0) t
       ) t order by t_part, t_sort];

      Var sql = execSqlSelect (StopCaptureOutput (), makeArray (sqlParam ("1", parm.("date"))));
      if ( not sql.moveNext () )
         PrintFormatString(NULL, "N1_NoData", "Нет данных для отчета");
         endAction ();
      else
         endAction ();

         RegisterTable("N1_MainTable", NULL,
                       "N1_A1",
                       "N1_A2",
                       "N1_A3",
                       "N1_A4",
                       "N1_A5",
                       "N1_A6",
                       "N1_A7",
                       "N1_A8",
                       "N1_A9",
                       "N1_A10",
                       "N1_A11",
                       "N1_A12",
                       "N1_A13",
                       "N1_A14",
                       "N1_A15");
   
         initProgress (int (sql.value ("t_cnt")), "Esc Отмена", "П-57");
         i = c = 0;
         while ( true )
            if (  (not (substr (sql.value ("t_account"), 1, 3) == "501") ) or
                  (    (substr (sql.value ("t_account"), 1, 3) == "502") or (substr (sql.value ("t_account"), 1, 3) == "507") and (sql.value ("t_categ") == 1) )
               )
   
               if ( sql.value ("t_fiid") )
                   rez = getRestRezerv1 (sql.value ("t_fiid"), sql.value ("t_catnum"), sql.value ("t_templ"));
                   A15 = ifThenElse (rez > sql.value ("t_rest"), sql.value ("t_rest"), rez);
               else
                   A15 = getRestRezerv2 (sql.value ("t_account"));
               end;

               PrintTableLine("N1_A1", c+1, NULL,
                              "N1_A2", sql.value ("t_nameaccount"), NULL,
                              "N1_A3", sql.value ("t_contr"), NULL,
                              "N1_A4", formatAccount (sql.value ("t_account")), NULL,
                              "N1_A5", sql.value ("t_portf"), NULL,
                              "N1_A6", sql.value ("t_rest"), NULL,
                              "N1_A7", sql.value ("t_categ"), NULL,
                              "N1_A8", sql.value ("t_rezerv"), NULL,
                              "N1_A9", money (sql.value ("t_rest") * double (sql.value ("t_rezerv")) / 100.0), NULL,
                              "N1_A10", "", NULL,
                              "N1_A11", "", NULL,
                              "N1_A12", "", NULL,
                              "N1_A13", "", NULL,
                              "N1_A14", "", NULL,
                              "N1_A15", A15, NULL);
   
               sum1 = sum1 + money (sql.value ("t_rest"));
               sum2 = sum2 + money (sql.value ("t_rest") * double (sql.value ("t_rezerv")) / 100.0);
               sum3 = sum3 + money (A15);
   
               c = c + 1;
            end;

            useProgress (i = i + 1);
            if ( not sql.moveNext () )
               break;
            end;
            if ( (testEvent (1) == kbESC) and getTrue (true, "Прекратить формирование отчета?") )
               remProgress ();
               return false;
            end;
         end;
         remProgress ();
         EndTable();

         PrintFormatString(NULL, "N1_Itog_A6", sum1,
                                 "N1_Itog_A9", sum2,
                                 "N1_Itog_A15", sum3);
      end;
   end;

   macro EndReport()
   end;

   initDL_CReportTemplate(NULL, "Report_f115_detail_1.xls", false, false, NULL, true);
END;

PRIVATE CLASS (DL_CReportTemplate) f115_details_2
   macro BeginReport()
   end;

   MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
   END;

   macro Create()
      var Sum1 = 0, Sum2 = 0, Sum3 = 0;

      SetActiveSheet("П-67");

      begAction (100, "Отбор данных для П-67", false);
      captureOutput ();
      [with parm as (select :1 t_dt from dual)
       select t.*, count (1) over () t_cnt from
         (select t_nameaccount
               ,(select t_number||' от '||to_char (t_dateconc, 'dd.mm.yyyy') from dsfcontr_dbt where t_servkind=1 and t_contractorid = (select t_marketplaceid from dmcaccdoc_dbt where t_account=a.t_account and t_chapter=a.t_chapter and t_currency=a.t_code_currency and t_marketplaceid > 0 and rownum = 1)) t_contr
               ,t_account
               ,-rsb_account.restall (t_account, t_chapter, t_code_currency, (select t_dt-1 from parm), 0) t_rest
               ,nvl ((select (select t_nameobject from dobjattr_dbt where t_objecttype=4 and t_groupid=13 and t_attrid=t.t_attrid) from dobjatcor_dbt t where (select t_dt from parm) between t_validfromdate and t_validtodate and t_objecttype = 4 and t_groupid = 13 and t_object = lpad (t_chapter, 2, '0')||replace (to_char (t_code_currency, 'xxxxxx'), ' ', '0')||t_account),
                     nvl ((select (select t_nameobject from dobjattr_dbt where t_objecttype=3 and t_groupid=13 and t_attrid=t.t_attrid) from dobjatcor_dbt t where (select t_dt from parm) between t_validfromdate and t_validtodate and t_objecttype = 4 and t_groupid = 13 and t_object = lpad (t_chapter, 2, '0')||lpad (t_client, 10, '0')),
                          '1')) t_categ
               ,nvl ((select to_char (rsb_struct.getDouble (t_text)) from dnotetext_dbt t where t_objecttype = 4 and t_notekind = 3 and (select t_dt from parm) between t_date and t_validtodate and t_documentid = lpad (t_chapter, 2, '0')||replace (to_char (t_code_currency, 'xxxxxx'), ' ', '0')||t_account),
                     nvl ((select to_char (rsb_struct.getDouble (t_text)) from dnotetext_dbt t where t_objecttype = 4 and t_notekind = 3 and (select t_dt from parm) between t_date and t_validtodate and t_documentid = lpad (t_client, 10, '0')), '0')) t_rezerv
               ,0 t_rezaccsum
               ,chr(0) t_portf
               ,1 t_part
               ,substr (t_account, 1, 8)||substr (t_account, 10) t_sort
         from daccount_dbt a
         where exists (select 1 from dmcaccdoc_dbt where t_catnum in (603, 1366) and t_chapter = a.t_chapter and t_account = a.t_account and t_currency = a.t_code_currency)
           and rsb_account.restall (t_account, t_chapter, t_code_currency, (select t_dt-1 from parm), 0) != 0
         union all
         select (select t_shortname from dparty_dbt where t_partyid=(select t_issuer from dvsbanner_dbt where t_bcid = m.t_docid and m.t_dockind=164)) t_nameaccount
               ,chr(0) t_contr
               ,a.t_account
               ,-rsb_account.restall (a.t_account, a.t_chapter, t_code_currency, (select t_dt-1 from parm), 0) t_rest
               --,nvl ((select (select t_nameobject from dobjattr_dbt where t_objecttype=24 and t_groupid=3 and t_attrid=t.t_attrid) from dobjatcor_dbt t where (select t_dt from parm) between t_validfromdate and t_validtodate and t_objecttype = 12 and t_groupid = 13 and t_object = lpad (m.t_docid, 10, '0') and m.t_dockind = 164), '1') t_categ
               --,nvl ((select to_char (round (rsb_struct.getDouble (t_text), 4)) from dnotetext_dbt t where (select t_dt from parm) between t_date and t_validtodate and t_objecttype = 24 and t_notekind = 16 and t_documentid = lpad (m.t_docid, 10, '0') and m.t_dockind = 164), '0') t_rezerv
               ,nvl ((select to_char (t_qualitycategory) from ddlreslnk_dbt where t_type = 2 and t_parentid = m.t_docid and t_reservekind = decode (m.t_catnum, 464, 1, 0) and t_reservesubkind = 0 and t_lnkdate = (select max (t_lnkdate) from ddlreslnk_dbt where t_type = 2 and t_parentid = m.t_docid and t_reservekind = 0 and t_reservesubkind = 0 and t_lnkdate < (select t_dt from parm))), '1') t_categ
               ,nvl ((select to_char (t_reservepercent) from ddlreslnk_dbt where t_type = 2 and t_parentid = m.t_docid and t_reservekind = 0 and t_reservesubkind = decode (m.t_catnum, 464, 1, 0) and t_lnkdate = (select max (t_lnkdate) from ddlreslnk_dbt where t_type = 2 and t_parentid = m.t_docid and t_reservekind = 0 and t_reservesubkind = 0 and t_lnkdate < (select t_dt from parm))), '0') t_percent
               ,nvl(
                      case when m.t_catnum = 462 or (m.t_catnum = 1492 and exists (select 1 from dmctempl_dbt where t_catid=m.t_catid and t_number=m.t_templnum and t_value1 = -1))
                      then (select sum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0)) from dmcaccdoc_dbt f where t_catnum=decode (m.t_catnum, 462, 463, 1492, 1460) and t_docid = m.t_docid and exists (select 1 from dmctempl_dbt t where t.t_catid=f.t_catid and t.t_number=f.t_templnum and t_value1=11))
                      when m.t_catnum = 464 or (m.t_catnum = 1492 and exists (select 1 from dmctempl_dbt where t_catid=m.t_catid and t_number=m.t_templnum and t_value1 in (1,4)))
                      then (select sum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0)) from dmcaccdoc_dbt f where t_catnum=decode (m.t_catnum, 464, 463, 1492, 1460) and t_docid = m.t_docid and exists (select 1 from dmctempl_dbt t where t.t_catid=f.t_catid and t.t_number=f.t_templnum and t_value1=12))
                      else 0
                      end, 0
                   ) as t_rezaccsum
               ,case when m.t_catnum=462 then 'вложение'
                     when m.t_catnum=1492 and exists (select 1 from dmctempl_dbt where t_catid=m.t_catid and t_number=m.t_templnum and t_value1 = -1) then 'вложение'
                     when m.t_catnum=1492 and exists (select 1 from dmctempl_dbt where t_catid=m.t_catid and t_number=m.t_templnum and t_value1 in (1,4)) then 'ПДД'
                     when m.t_catnum=464 then 'ПДД'
                     else chr(0)
                end t_portf
               ,2 t_part
               ,substr (a.t_account, 1, 8)||substr (a.t_account, 10) t_sort
         from dmcaccdoc_dbt m
         inner join daccount_dbt a on a.t_chapter=m.t_chapter and a.t_account=m.t_account and a.t_code_currency = m.t_currency 
         where t_catnum in (462, 464, 1492) and (t_isusable = 'X' or (t_isusable = chr (0) and m.t_disablingdate >= (select t_dt from parm)))
           and rsb_account.restall (a.t_account, a.t_chapter, t_code_currency, (select t_dt-1 from parm), 0) != 0
       ) t order by t_part, t_sort];

      Var sql = execSqlSelect (StopCaptureOutput (), makeArray (sqlParam ("1", parm.("date"))));

      if ( not sql.moveNext () )
         PrintFormatString(NULL, "N2_NoData", "Нет данных для отчета");
         endAction ();
      else
         endAction ();

         initProgress (int (sql.value ("t_cnt")), "Esc Отмена", "П-67");
   
         RegisterTable("N2_MainTable", NULL,
                       "N2_A1",
                       "N2_A2",
                       "N2_A3",
                       "N2_A4",
                       "N2_A5",
                       "N2_A6",
                       "N2_A7",
                       "N2_A8",
                       "N2_A9",
                       "N2_A10",
                       "N2_A11",
                       "N2_A12",
                       "N2_A13",
                       "N2_A14",
                       "N2_A15");
   
         var i = 0;
         while ( true )
             PrintTableLine("N2_A1", i+1, NULL,
                            "N2_A2", sql.value ("t_nameaccount"), NULL,
                            "N2_A3", sql.value ("t_contr"), NULL,
                            "N2_A4", formatAccount (sql.value ("t_account")), NULL,
                            "N2_A5", sql.value ("t_portf"), NULL,
                            "N2_A6", sql.value ("t_rest"), NULL,
                            "N2_A7", sql.value ("t_categ"), NULL,
                            "N2_A8", sql.value ("t_rezerv"), NULL,
                            "N2_A9", money (sql.value ("t_rest") * double (sql.value ("t_rezerv")) / 100.0), NULL,
                            "N2_A10", "", NULL,
                            "N2_A11", "", NULL,
                            "N2_A12", "", NULL,
                            "N2_A14", "", NULL,
                            "N2_A15", sql.value ("t_rezaccsum"), NULL);
   
             sum1 = sum1 + money (sql.value ("t_rest"));
             sum2 = sum2 + money (sql.value ("t_rest") * double (sql.value ("t_rezerv")) / 100.0);
             sum3 = sum3 + money (sql.value ("t_rezaccsum"));
   
             useProgress (i = i + 1);
             if ( not sql.moveNext () )
                 break;
             end;
             if ( (testEvent (1) == kbESC) and getTrue (true, "Прекратить формирование отчета?") )
                 remProgress ();
                 return false;
             end;
         end;
         remProgress();

         EndTable();

         PrintFormatString(NULL, "N2_Itog_A6", sum1,
                                 "N2_Itog_A9", sum2,
                                 "N2_Itog_A15", sum3);
      end;
   end;

   macro EndReport()
   end;

   initDL_CReportTemplate(NULL, "Report_f115_detail_2.xls", false, false, NULL, true);
END;

PRIVATE CLASS (DL_CReportTemplate) f115_details_3()
   var start = 0, line:Integer = -1;
   var sum1 = $0, sum2 = $0;
   var rowHeights = TArray();
   var showZeroLines = (parm.("ShowZeroLines") == "X");

   private macro PrintHeader3()
      PrintFormatString(NULL, "N3_RepDate", "На " + String(Date(parm.("date")):f));
      CopyAllSheetInTotalBook("Сделки РЕПО", false, "N3_Header", 0);
   end;

   private macro PrintSubHeader3_1(fiid:Integer, deals:String, Num:Integer)
      var fiName = "", issuerName = "", contrName = "";
      var sql = execSqlSelect ("select t_name, (select t_shortname from dparty_dbt where t_partyid=t_issuer) from dfininstr_dbt where t_fiid = :1", makeArray (sqlParam ("1", fiid)));

      if ( sql.moveNext () )
         if ( valType (sql.value (0)) != 26 )
            fiName = sql.value (0);
         end;
         if ( valType (sql.value (1)) != 26 )
            issuerName = sql.value (1);
         end;
      end;

      sql = execSqlSelect ("select listagg (t_shortname, ', ') within group (order by t_shortname) from dparty_dbt where t_partyid in (select t_partyid from ddl_tick_dbt where t_dealid  in ("+deals+"))");
      if ( sql.moveNext () and (valType (sql.value (0)) != 26) )
          contrName = contrName + ifThenElse (contrName, ", ", "") + sql.value (0);
      end;

      Merge("N3_A1", "N3_A2");
      PrintTableLine("N3_Num", Num, NULL,
                     "N3_A1", "Ценные бумаги "+fiName+" (эмитент - "+issuerName+"), переданные без прекращения признания (контрагенты - "+contrName+"), в т.ч.", NULL,
                     "N3_A2", "", NULL,
                     "N3_A3", "-", NULL,
                     "N3_A4", "-", NULL,
                     "N3_A5", "-", NULL,
                     "N3_A6", "-", NULL,
                     "N3_A7", "-", NULL);

      rowHeights(rowHeights.size) = RowHeight(line + 3, 42);
      line = line + 1;
   end;

   private macro PrintA1(fiid:Integer, deals:String): String
      var Account = "";
      var sql = execSqlSelect ("select distinct t_account, "+
                               "       abs(rsb_account.restall (t_account, t_chapter, t_currency, :1-1, 0)) t_rest "+      //GAA:509618, new: abs()
                               "from dmcaccdoc_dbt a "+
                               "where (  (t_dockind = 176 and t_docid in (select t_id from ddl_leg_dbt where t_dealid in ("+deals+"))) or "+
                               "         (t_dockind=4620 and t_docid in (select t_id from ddl_tick_ens_dbt where t_dealid in ("+deals+")) and t_fiid="+fiid+")) "+
                               "     and t_catnum in (231, 233, 1298, 1237, 1245, 1246) "+
                               "     and 1 = case when a.t_catnum = 231 then (select t_value4 from dmctempl_dbt where t_number = a.t_templnum and t_catid = a.t_catid) else 1 end "+
                               "     and (t_isusable = 'X' or t_disablingdate >= :2)",
                               makeArray (sqlParam ("1", parm.("date")), sqlParam ("2", parm.("date"))));

      var blockStartLine = line;
      var description = "Стоимость ценных бумаг, переданных без прекращения признания:";
      var height = 31.5;

      while (sql.MoveNext())
         Account = string(sql.value ("t_account"));
         var rest = money (sql.value ("t_rest"));

         if ((rest == 0) and (not ShowZeroLines))
            continue;
         end;
         
         PrintTableLine("N3_Num", "", NULL,
                        "N3_A1", description, NULL,
                        "N3_A2", "Счет вложений для ценной бумаги", NULL,
                        "N3_A3", formatAccount (sql.value ("t_account")), NULL,
                        "N3_A4", "", NULL,
                        "N3_A5", rest, NULL,
                        "N3_A6", "-", NULL,
                        "N3_A7", "-", NULL);

         sum2 = sum2 + rest;
         rowHeights(rowHeights.size) = RowHeight(line + 3, height);
         height = 15.75;
         line = line + 1;
      end;
      
      if (blockStartLine == line)
         PrintTableLine("N3_Num", "", NULL,
                        "N3_A1", description, NULL,
                        "N3_A2", "Счет вложений для ценной бумаги", NULL,
                        "N3_A3", "", NULL,
                        "N3_A4", "", NULL,
                        "N3_A5", "", NULL,
                        "N3_A6", "-", NULL,
                        "N3_A7", "-", NULL);

         rowHeights(rowHeights.size) = RowHeight(line + 3, height);
         line = line + 1;
      end;
      
      return Account;
   end;

   private macro PrintA2(fiid:Integer)
      var sql = execSqlSelect ("select distinct t_account, -rsb_account.restall (t_account, t_chapter, t_currency, :1-1, 0) t_rest from dmcaccdoc_dbt t where t_catnum = 235 and exists (select 1 from dmctempl_dbt where t_catid = t.t_catid and t_value3 = 1 and t_value4 in (1, 4) and t_number = t.t_templnum) and t_fiid = :2",
                           makeArray (sqlParam ("1", parm.("date")), sqlParam ("2", fiid)));
      if ( sql.moveNext() and (ShowZeroLines or 
                               (Money(sql.Value("t_rest")) != 0)) )
         sum2 = sum2 + money (sql.value ("t_rest"));

         PrintTableLine("N3_Num", "", NULL,
                        "N3_A1", "", NULL,
                        "N3_A2", "Счет начисленного купона", NULL,
                        "N3_A3", formatAccount (sql.value ("t_account")), NULL,
                        "N3_A4", "", NULL,
                        "N3_A5", money (sql.value ("t_rest")), NULL,
                        "N3_A6", "-", NULL,
                        "N3_A7", "-", NULL);
      else
         PrintTableLine("N3_Num", "", NULL,
                        "N3_A1", "", NULL,
                        "N3_A2", "Счет начисленного купона", NULL,
                        "N3_A3", "", NULL,
                        "N3_A4", "", NULL,
                        "N3_A5", "", NULL,
                        "N3_A6", "-", NULL,
                        "N3_A7", "-", NULL);
      end;
      
      rowHeights(rowHeights.size) = RowHeight(line + 3, 15.75);
      line = line + 1;
   end;

   private macro PrintA3(fiid:Integer)
      var sql = execSqlSelect ("select distinct t_account, -rsb_account.restall (t_account, t_chapter, t_currency, :1-1, 0) t_rest from dmcaccdoc_dbt t where t_catnum = 235 and exists (select 1 from dmctempl_dbt where t_catid = t.t_catid and t_value3 = 1 and t_value4 in (2, 5) and t_number = t.t_templnum) and t_fiid = :2",
                               makeArray (sqlParam ("1", parm.("date")), sqlParam ("2", fiid)));
      if ( sql.moveNext() and (ShowZeroLines or 
                               (Money(sql.Value("t_rest")) != 0)) )
         sum2 = sum2 + money (sql.value ("t_rest"));

         PrintTableLine("N3_Num", "", NULL,
                        "N3_A1", "", NULL,
                        "N3_A2", "Счет начисленного дисконта", NULL,
                        "N3_A3", formatAccount (sql.value ("t_account")), NULL,
                        "N3_A4", "", NULL,
                        "N3_A5", money (sql.value ("t_rest")), NULL,
                        "N3_A6", "-", NULL,
                        "N3_A7", "-", NULL);
      else
         PrintTableLine("N3_Num", "", NULL,
                        "N3_A1", "", NULL,
                        "N3_A2", "Счет начисленного дисконта", NULL,
                        "N3_A3", "", NULL,
                        "N3_A4", "", NULL,
                        "N3_A5", "", NULL,
                        "N3_A6", "-", NULL,
                        "N3_A7", "-", NULL);
      end;
      
      rowHeights(rowHeights.size) = RowHeight(line + 3, 15.75);
      line = line + 1;
   end;

   private macro PrintA4(fiid:Integer, Account:String)
      var portf = -1;

      /*BPV попытка вывода счетов, когда бумага есть в двух портфелях. Запоминаем портфель для последующих селектов по счетам купона, дисконта, премии*/
      /* в целом логику по всему отчету нужно доработать для учета счетво в разрезе портфелей*/
      var sql = execSqlSelect(" select t_value1 portf from dmctempl_dbt t, dmcaccdoc_dbt a where a.t_account = :1 and (t_isusable = 'X' or t_disablingdate >= :2) and t.t_catid = a.t_catid and t_number = a.t_templnum",
                          makeArray (sqlParam ("1", Account), sqlParam ("2", parm.("date"))) );
      if (sql.movenext())
         portf = sql.value("portf");
      else 
         portf = -1;
      end;

  //    sql = execSqlSelect ("select distinct t_account, -rsb_account.restall (t_account, t_chapter, t_currency, :1-1, 0) t_rest from dmcaccdoc_dbt t where t_catnum = 236 and exists (select 1 from dmctempl_dbt where t_catid = t.t_catid and t_value3 = 1 and t_number = t.t_templnum) and t_fiid = :2",
      sql = execSqlSelect (
                            "SELECT DISTINCT t_account, " +
                            "                -rsb_account.restall (t.t_account, " +
                            "                                      t.t_chapter, " +
                            "                                      t.t_currency, " +
                            "                                      :1 - 1, " +
                            "                                      0 " +
                            "                                     ) " +
                            "                   t_rest " +
                            "  FROM dmcaccdoc_dbt t, dmctempl_dbt m " +
                            " WHERE     t_catnum = 236 " +
                            "       AND m.t_catid = t.t_catid " +
                            "       AND t.t_templnum = m.t_number " +
                            "       AND m.t_value3 = 1 " +
                            "       AND (( :2 = -1) or (m.t_value1 = :3)) " +
                            "       AND m.t_number = t.t_templnum " +
                            "       AND t_fiid = :4 " ,
                           makeArray (sqlParam ("1", parm.("date")), sqlParam ("2", portf),sqlParam ("3", portf), sqlParam ("4", fiid))
                          );
      if ( sql.moveNext() and (ShowZeroLines or 
                               (Money(sql.Value("t_rest")) != 0)) )
         sum2 = sum2 + money (sql.value ("t_rest"));

         PrintTableLine("N3_Num", "", NULL,
                        "N3_A1", "", NULL,
                        "N3_A2", "Счет начисленной премии", NULL,
                        "N3_A3", formatAccount (sql.value ("t_account")), NULL,
                        "N3_A4", "", NULL,
                        "N3_A5", money (sql.value ("t_rest")), NULL,
                        "N3_A6", "-", NULL,
                        "N3_A7", "-", NULL);
      else
         PrintTableLine("N3_Num", "", NULL,
                        "N3_A1", "", NULL,
                        "N3_A2", "Счет начисленной премии", NULL,
                        "N3_A3", "", NULL,
                        "N3_A4", "", NULL,
                        "N3_A5", "", NULL,
                        "N3_A6", "-", NULL,
                        "N3_A7", "-", NULL);
      end;
      
      rowHeights(rowHeights.size) = RowHeight(line + 3, 15.75);
      line = line + 1;
   end;

   private macro PrintA5(deals:String)
      var ExistData = false;
      var sql = execSqlSelect ("select t_account, -rsb_account.restall (t_account, t_chapter, t_currency, :1-1, 0) t_rest from dmcaccdoc_dbt a "+
                               "where t_dockind = 176 "+
                               "      and (t_catnum in (1208, 1238) or (t_catnum = 1207 and exists (select 1 from dmctempl_dbt where t_number = a.t_templnum and t_catid = a.t_catid and t_value4 = 1)) ) "+
                               "      and t_docid in (select t_id from ddl_leg_dbt where t_dealid in ("+deals+"))",
                               makeArray (sqlParam ("1", parm.("date"))));

      var blockStartLine = line;

      while (sql.MoveNext())
         var rest = Money(sql.Value("t_rest"));

         if ((rest == 0) and (not ShowZeroLines))
            continue;
         end;
         
         PrintTableLine("N3_Num", "", NULL,
                        "N3_A1", "", NULL,
                        "N3_A2", "Счет УНКД", NULL,
                        "N3_A3", formatAccount (sql.value ("t_account")), NULL,
                        "N3_A4", "", NULL,
                        "N3_A5", rest, NULL,
                        "N3_A6", "-", NULL,
                        "N3_A7", "-", NULL);

         sum2 = sum2 + money (sql.value ("t_rest"));
         rowHeights(rowHeights.size) = RowHeight(line + 3, 15.75);
         line = line + 1;
      end;

      if (blockStartLine == line)
         PrintTableLine("N3_Num", "", NULL,
                        "N3_A1", "", NULL,
                        "N3_A2", "Счет УНКД", NULL,
                        "N3_A3", "", NULL,
                        "N3_A4", "", NULL,
                        "N3_A5", "", NULL,
                        "N3_A6", "-", NULL,
                        "N3_A7", "-", NULL);

         rowHeights(rowHeights.size) = RowHeight(line + 3, 15.75);
         line = line + 1;
      end;
   end;

   private macro PrintA(fiid:Integer, deals:String)
      var Account = PrintA1(fiid, deals);
      PrintA2(fiid);
      PrintA3(fiid);
      PrintA4(fiid, Account);
      PrintA5(deals);

      MergeRow("N3_A1", "N3_A1", start + 1, line);
   end;

   private macro PrintB(deals:String)
      var dubl = "";
      var description = "Обеспеченная часть, риск на:";
      var B1, B2, B3, B4, B5, B6;
      var sql = execSqlSelect ("select accdoc.t_account, " +
                                      "rsb_account.restall (accdoc.t_account, accdoc.t_chapter, accdoc.t_currency, greatest(:1-1, (select acc.t_open_date from daccount_dbt acc where acc.t_account = accdoc.t_account)), 0) t_rest, " +
                                      "accdoc.t_docid " +
                                 "from dmcaccdoc_dbt accdoc " +
                                "where accdoc.t_dockind = 176 " +
                                  "and accdoc.t_catnum = 602 " +
                                  "and accdoc.t_docid in (select t_id from ddl_leg_dbt where t_dealid in ("+deals+")) " +
                                  "and :2-1 between accdoc.t_activatedate and case when accdoc.t_disablingdate > to_date('01.01.0001', 'DD.MM.YYYY') " +
                                                                                  "then accdoc.t_disablingdate " +
                                                                                  "else to_date('31.12.9999', 'DD.MM.YYYY') end",
                               makeArray (sqlParam ("1", parm.("date")), sqlParam ("2", parm.("date"))));

      var sql1;
      var blockStartLine = line;

      while (sql.MoveNext())
         if (Index(dubl, "%"+sql.value ("t_account")+"%") == 0)
            dubl = dubl + "%"+sql.value ("t_account")+"%";
            B1 = "Эмитента";
            B2 = formatAccount (sql.value ("t_account"));
            B3 = "";
            B4 = money (sql.value ("t_rest"));
            sum1 = sum1 + B4;
            
            if ((B4 == 0) and (not ShowZeroLines))
               Continue;
            end;

            sql1 = execSqlSelect ("select t_numinlist from dobjattr_dbt where t_objecttype=101 and t_groupid=14 and t_attrid=(select t_attrid from dobjatcor_dbt where t_objecttype=101 and t_groupid=14 and t_object=(select lpad (t_dealid, 34, '0') from ddl_leg_dbt where t_id = :1) and :2 between t_validfromdate and t_validtodate)",
                                  makeArray (sqlParam ("1", int (sql.value ("t_docid"))), sqlParam ("2", parm.("date"))));
            if ( sql1.moveNext () )
               B5 = int (sql1.value (0));
            else
               B5 = 1;
            end;

            sql1 = execSqlSelect ("select rsb_struct.getDouble (t_text) from dnotetext_dbt where t_objecttype=101 and t_notekind=6 and t_documentid=(select lpad (t_dealid, 34, '0') from ddl_leg_dbt where t_id = :1) and :2 between t_date and t_validtodate",
                                  makeArray (sqlParam ("1", int (sql.value ("t_docid"))), sqlParam ("2", parm.("date"))));
            if ( sql1.moveNext () )
               B6 = sql1.value (0);
            else
               B6 = 0;
            end;

            PrintTableLine("N3_Num", "", NULL,
                           "N3_A1", description, NULL,
                           "N3_A2", B1, NULL,
                           "N3_A3", B2, NULL,
                           "N3_A4", B3, NULL,
                           "N3_A5", B4, NULL,
                           "N3_A6", B5, NULL,
                           "N3_A7", B6, NULL);
            description = "";
            
            rowHeights(rowHeights.size) = RowHeight(line + 3, 15.75);
            line = line + 1;
         end;
      end;
         
      if (blockStartLine == line)
         PrintTableLine("N3_Num", "", NULL,
                        "N3_A1", description, NULL,
                        "N3_A2", "", NULL,
                        "N3_A3", "", NULL,
                        "N3_A4", "", NULL,
                        "N3_A5", "", NULL,
                        "N3_A6", "", NULL,
                        "N3_A7", "", NULL);

         rowHeights(rowHeights.size) = RowHeight(line + 3, 15.75);
         line = line + 1;
      end;

      PrintTableLine("N3_Num", "", NULL,
                     "N3_A1", "Итого по обеспеченной части", NULL,
                     "N3_A2", "", NULL,
                     "N3_A3", "", NULL,
                     "N3_A4", "", NULL,
                     "N3_A5", sum1, NULL,
                     "N3_A6", "", NULL,
                     "N3_A7", "", NULL);
      rowHeights(rowHeights.size) = RowHeight(line + 3, 15.75);
      line = line + 2;
   end;

   private macro PrintC(fiid:Integer)
      var C4, C5, C6;

      PrintTableLine("N3_Num", "", NULL,
                     "N3_A1", "Необеспеченная часть(в части сделок с ЦБ РФ), риск на:", NULL,
                     "N3_A2", "Эмитента", NULL,
                     "N3_A3", "-", NULL,
                     "N3_A4", "", NULL,
                     "N3_A5", "", NULL,
                     "N3_A6", "", NULL,
                     "N3_A7", "", NULL);

      Var row = ifThenElse (execSqlSelect ("select 1 from dpartyown_dbt where t_partyid = :1 and t_partykind = 29", makeArray (sqlParam ("1", fiid))).moveNext (), line, line+1);

      C4 = sum2-sum1;

      var sql = execSqlSelect ("select t_numinlist from dobjattr_dbt where t_objecttype=12 and t_groupid=13 and t_attrid=(select t_attrid from dobjatcor_dbt where t_objecttype=12 and t_groupid=13 and t_object=lpad (:1, 10, '0') and :2 between t_validfromdate and t_validtodate)",
                               makeArray (sqlParam ("1", fiid), sqlParam ("2", parm.("date"))));

      if ( sql.moveNext () )
          C5 = int (sql.value (0));
      else
          C5 = 1;
      end;

      sql = execSqlSelect ("select rsb_struct.getString (t_text) from dnotetext_dbt where t_objecttype=12 and t_notekind=3 and t_documentid=lpad (:1, 10, '0') and :2 between t_date and t_validtodate",
                           makeArray (sqlParam ("1", fiid), sqlParam ("2", parm.("date"))));

      if ( sql.moveNext () )
          C6 = int (sql.value (0));
      else
          C6 = 0;
      end;

      PrintTableLine("N3_Num", "", NULL,
                     "N3_A1", "Необеспеченная часть(в части сделок с ЦБ РФ), риск на:", NULL,
                     "N3_A2", "Контрагентов", NULL,
                     "N3_A3", "-", NULL,
                     "N3_A4", "", NULL,
                     "N3_A5", C4, NULL,
                     "N3_A6", C5, NULL,
                     "N3_A7", C6, NULL);
      rowHeights(rowHeights.size) = RowHeight(line + 2, 31.5);
      rowHeights(rowHeights.size) = RowHeight(line + 3, 31.5);
      line = line + 1;
   end;

   MACRO PrintMode():INTEGER
      return DL_OUTREPORT_EXCEL;
   END;

   macro BeginReport()
      CreateTotalBook();
   end;

   macro Create()
      SetActiveSheet("Сделки РЕПО");

      captureOutput ();
      [
        select t.*, count (1) over () t_cnt
        from (select tick.t_pfi,
                     listagg (tick.t_dealid, ',') within group (order by tick.t_dealid) t_deals
              from ddl_tick_dbt tick
              where tick.t_dealid = any (select t_dealid
                                           from ddl_leg_dbt l2
                                          where l2.t_legkind = 2
                                            and l2.t_maturity >= :1-1
                                            and exists (select *
                                                          from ddl_leg_dbt l1
                                                         where l1.t_dealid = l2.t_dealid
                                                           and l1.t_legkind = 0
                                                           and l1.t_maturity <= :2-1))
                and exists (select *
                              from dmcaccdoc_dbt mcacc
                             where mcacc.t_docid in (select t_id from ddl_leg_dbt where t_dealid = tick.t_dealid)
                               and mcacc.t_dockind = 176
                               and mcacc.t_catnum in (231, 233, 602, 1298, 1237, 1245, 1246)
                               and 1 = case when mcacc.t_catnum = 231 then (select t_value4 from dmctempl_dbt where t_number = mcacc.t_templnum and t_catid = mcacc.t_catid) else 1 end
                               and rsb_account.restall (mcacc.t_account, mcacc.t_chapter, mcacc.t_currency, :3-1, mcacc.t_currency) != 0)
              group by tick.t_pfi, tick.t_partyid
              union
              select distinct t_fiid,
                 listagg (t_dealid, ',') within group (order by t_dealid) t_deals
              from ddl_tick_ens_dbt ens
              where exists (select * from ddl_leg_dbt l2
                             where l2.t_legkind = 2
                               and l2.t_maturity >= :4-1
                               and l2.t_dealid = ens.t_dealid)
                and exists (select * from ddl_leg_dbt l1
                             where l1.t_legkind = 0
                               and l1.t_maturity <= :5-1
                               and l1.t_dealid = ens.t_dealid)
                and exists (select *
                              from dmcaccdoc_dbt mcacc
                             where mcacc.t_docid = ens.t_id
                               and mcacc.t_dockind = 4620
                               and mcacc.t_catnum in (231, 233, 1298, 1237, 1245, 1246)
                               and 1 = case when mcacc.t_catnum = 231 then (select t_value4 from dmctempl_dbt where t_number = mcacc.t_templnum and t_catid = mcacc.t_catid) else 1 end
                               and rsb_account.restall (mcacc.t_account, mcacc.t_chapter, mcacc.t_currency, :6-1, mcacc.t_currency) != 0)
          group by t_fiid) t
      ];
      Var sql = execSqlSelect(StopCaptureOutput(), makeArray (sqlParam ("1", parm.("date")),
                                                              sqlParam ("2", parm.("date")),
                                                              sqlParam ("3", parm.("date")),
                                                              sqlParam ("4", parm.("date")),
                                                              sqlParam ("5", parm.("date")),
                                                              sqlParam ("6", parm.("date")))), i = 0;

      if ( not sql.moveNext () )
         PrintFormatString(NULL, "N3_NoData", "Нет данных для отчета");
      else
         initProgress (int (sql.value ("t_cnt")), "Esc Отмена", "РЕПО");

         PrintHeader3();

         RegisterTable("N3_MainTable", NULL,
                       "N3_Num",
                       "N3_A1",
                       "N3_A2",
                       "N3_A3",
                       "N3_A4",
                       "N3_A5",
                       "N3_A6",
                       "N3_A7");
         i = 0;
         while ( true )
            start = line + 1;

            sum1 = sum2 = $0;
            PrintSubHeader3_1(int (sql.value ("t_pfi")), sql.value ("t_deals"), i + 1);
            PrintA(int (sql.value ("t_pfi")), sql.value ("t_deals"));
            PrintB(sql.value ("t_deals"));
            PrintC(int (sql.value ("t_pfi")));

            MergeRow("N3_Num", "N3_Num", start, line);

            useProgress (i=i+1);
            if ( not sql.moveNext () )
                break;
            end;
         end;

         EndTable();
         
         i = 0;
         while (i < rowHeights.size)
           SetRowHeight(rowHeights(i).index, rowHeights(i).height);
           i = i + 1;
         end;
         
         CopyAllSheetInTotalBook("Сделки РЕПО", false, GetTableRange(), 0);

         remProgress ();
      end;
   end;

   macro EndReport()
      SaveTotalBook();
   end;

   initDL_CReportTemplate(NULL, "Report_f115_detail_3.xls", true, false, NULL, true);
END;

PRIVATE CLASS (DL_CReportTemplate) f115_details_4()
   macro BeginReport()
      CreateTotalBook();
   end;

   MACRO PrintMode():INTEGER
      return DL_OUTREPORT_EXCEL;
   END;

   private macro PrintHeader()
      PrintFormatString(NULL, "N4_RepDate", string(parm.("date"):f));
      CopyAllSheetInTotalBook("Сводная расшифровка", false, "N4_Header", 0);
   end;

   private macro PrintA1()
      var A13_A14 = "", A15 = "", A20 = "";
      var calcres = $0, sumreserv = $0;
      var categ = 0;
      var PercCateg = TArray();
      var i = 0;
      var longVal = 0;
      var longArr = TArray();
      var sum = 0, rop = 0, percent = 0;
      var ExistData = true;
      var sum1 = $0;
      var num = 0;

      CopyAllSheetInTotalBook("Сводная расшифровка", false, "N4_Subheader_A1", 0);

      var sql = getData_13_22(true);
      if(sql.MoveNext())
         InitProgress(Int(sql.value("t_Count")), NULL, "Печать данных...");

         RegisterTable("N4_MainTable_A1", NULL,
                     "N4_A1_1",
                     "N4_A1_2",
                     "N4_A1_3",
                     "N4_A1_4",
                     "N4_A1_5",
                     "N4_A1_6",
                     "N4_A1_7",
                     "N4_A1_8",
                     "N4_A1_9",
                     "N4_A1_10",
                     "N4_A1_11",
                     "N4_A1_12",
                     "N4_A1_13",
                     "N4_A1_14",
                     "N4_A1_15",
                     "N4_A1_16",
                     "N4_A1_17",
                     "N4_A1_18",
                     "N4_A1_19",
                     "N4_A1_20");

         while(ExistData)
            sum = round(sql.value("t_sum")/1000.0, 0);
            sum1 = sum1 + sum;

            while(i < 5)
               PercCateg[i] = "";
               i = i + 1;
            end;

            categ = int(sql.value("t_categ"));
            percent = sql.value("t_percent");
            if(categ > 0)
               PercCateg[categ - 1] = string(percent:0:2, "%");
            end;

            i = 0;
            while(i < 4)
               longArr[i] = "";
               i = i + 1;
            end;

            longVal = int(sql.value("t_long"));
            if(longVal > 0)
               longArr[longVal - 1] = sum;
            end;

            calcres = round (percent * sum/100.0, 0);
            if(calcres > 0)
               A13_A14 = calcres;
            end;

            sumreserv = round(sql.value("t_sumreserv")/1000.0, 0);
            var sumresArr = TArray();
            i = 0;
            while(i < 4)
               sumresArr[i] = "";
               i = i + 1;
            end;

            if(sumreserv)
               A15 = sumreserv;
               if(categ > 1)
                  sumresArr[categ - 2] = sumreserv;
               end;
            end;

            rop = sql.value ("t_rop");
            if((valType(A15) == V_DOUBLE) and (round (rop * sum/100.0-A15, 0) != 0))
               A20 = round (rop * sum/100.0 - A15, 0);
            end;
            if(sql.value("t_or_sumreserv") != 0)
               A20 = round (sql.value("t_or_sumreserv")/1000.0, 0);
            end;

            PrintTableLine("N4_A1_1", sql.value ("t_balance"), NULL,
                           "N4_A1_2", sql.value ("t_issuer"), NULL,
                           "N4_A1_3", sum, NULL,
                           "N4_A1_4", PercCateg[0], NULL,
                           "N4_A1_5", PercCateg[1], NULL,
                           "N4_A1_6", PercCateg[2], NULL,
                           "N4_A1_7", PercCateg[3], NULL,
                           "N4_A1_8", PercCateg[4], NULL,
                           "N4_A1_9", longArr[0], NULL,
                           "N4_A1_10", longArr[1], NULL,
                           "N4_A1_11", longArr[2], NULL,
                           "N4_A1_12", longArr[3], NULL,
                           "N4_A1_13", A13_A14, NULL,
                           "N4_A1_14", A13_A14, NULL,
                           "N4_A1_15", A15, NULL,
                           "N4_A1_16", sumresArr[0], NULL,
                           "N4_A1_17", sumresArr[1], NULL,
                           "N4_A1_18", sumresArr[2], NULL,
                           "N4_A1_19", sumresArr[3], NULL,
                           "N4_A1_20", A20, NULL);

            ExistData = sql.MoveNext();
            UseProgress(num = num + 1);
         end;
         EndTable();

         CopyAllSheetInTotalBook("Сводная расшифровка", false, GetTableRange(), 0);

         PrintFormatString(NULL, "N4_Itog_A1_3", sum1);
         CopyAllSheetInTotalBook("Сводная расшифровка", false, "N4_Itog_A1", 0);

         RemProgress();
      end;
   end;

   private macro PrintA2()
      var A13_A14 = "", A15 = "", A20 = "";
      var calcres = $0, sumreserv = $0;
      var categ = 0;
      var PercCateg = TArray();
      var i = 0;
      var longVal = 0;
      var longArr = TArray();
      var sum = 0, rop = 0, ropsum = 0, percent = 0;
      var ExistData = true;
      var sum1 = $0;
      var num = 0;

      CopyAllSheetInTotalBook("Сводная расшифровка", false, "N4_Subheader_A2", 0);

      var sql = getData_14_24 (true);
      if(sql.MoveNext())
         InitProgress(Int(sql.value("t_Count")), NULL, "Печать данных...");

         RegisterTable("N4_MainTable_A2", NULL,
                     "N4_A2_1",
                     "N4_A2_2",
                     "N4_A2_3",
                     "N4_A2_4",
                     "N4_A2_5",
                     "N4_A2_6",
                     "N4_A2_7",
                     "N4_A2_8",
                     "N4_A2_9",
                     "N4_A2_10",
                     "N4_A2_11",
                     "N4_A2_12",
                     "N4_A2_13",
                     "N4_A2_14",
                     "N4_A2_15",
                     "N4_A2_16",
                     "N4_A2_17",
                     "N4_A2_18",
                     "N4_A2_19",
                     "N4_A2_20");

         while(ExistData)
            sum = round(sql.value("t_sum")/1000.0, 0);
            sum1 = sum1 + sum;

            i = 0;
            while(i < 5)
               PercCateg[i] = "";
               i = i + 1;
            end;

            categ = int(sql.value("t_categ"));
            percent = double(sql.value("t_percent"));
            if(categ > 0)
               PercCateg[categ - 1] = string(percent:0:2, "%");
            end;

            i = 0;
            while(i < 4)
               longArr[i] = "";
               i = i + 1;
            end;

            longVal = int(sql.value("t_long"));
            if(longVal > 0)
               longArr[longVal - 1] = sum;
            end;

            calcres = round (percent * round (sql.value ("t_sum_baz")/1000.0, 0)/100.0, 0);
            if( calcres > 0 )
               A13_A14 = calcres;
            end;

            sumreserv = round(sql.value("t_sumreserv")/1000.0, 0);
            var sumresArr = TArray();
            i = 0;
            while(i < 4)
               sumresArr[i] = "";
               i = i + 1;
            end;

            if(sumreserv)
               A15 = sumreserv;
               if(categ > 1)
                  sumresArr[categ - 2] = sumreserv;
               end;
            end;

            ropsum = sql.value("t_ropsum");
            rop = sql.value ("t_rop");
            if(ropsum)
               A20 = round (ropsum/1000.0, 0);
            elif ((valType(A15) == V_DOUBLE) and (round (rop * sum/100.0-A15, 0) != 0) )
               A20 = Abs(round(rop * sum/100.0 - A15, 0));
            end;

            PrintTableLine("N4_A2_1", sql.value ("t_balance"), NULL,
                           "N4_A2_2", sql.value ("t_issuer"), NULL,
                           "N4_A2_3", round (sql.value ("t_sum")/1000.0, 0), NULL,
                           "N4_A2_4", PercCateg[0], NULL,
                           "N4_A2_5", PercCateg[1], NULL,
                           "N4_A2_6", PercCateg[2], NULL,
                           "N4_A2_7", PercCateg[3], NULL,
                           "N4_A2_8", PercCateg[4], NULL,
                           "N4_A2_9", longArr[0], NULL,
                           "N4_A2_10", longArr[1], NULL,
                           "N4_A2_11", longArr[2], NULL,
                           "N4_A2_12", longArr[3], NULL,
                           "N4_A2_13", A13_A14, NULL,
                           "N4_A2_14", A13_A14, NULL,
                           "N4_A2_15", A15, NULL,
                           "N4_A2_16", sumresArr[0], NULL,
                           "N4_A2_17", sumresArr[1], NULL,
                           "N4_A2_18", sumresArr[2], NULL,
                           "N4_A2_19", sumresArr[3], NULL,
                           "N4_A2_20", A20, NULL);

            ExistData = sql.MoveNext();
            UseProgress(num = num + 1);
         end;
         EndTable();

         CopyAllSheetInTotalBook("Сводная расшифровка", false, GetTableRange(), 0);

         PrintFormatString(NULL, "N4_Itog_A2_3", sum1);
         CopyAllSheetInTotalBook("Сводная расшифровка", false, "N4_Itog_A2", 0);

         RemProgress();
      end;
   end;

   private macro PrintA3()
      var A13_A14 = "", A15 = "", A20 = "";
      var calcres = $0, sumreserv = $0;
      var categ = 0;
      var PercCateg = TArray();
      var i = 0;
      var longVal = 0;
      var longArr = TArray();
      var sum = 0, rop = 0, ropsum = 0, percent = 0;
      var ExistData = true;
      var sum1 = $0;
      var num = 0;

      CopyAllSheetInTotalBook("Сводная расшифровка", false, "N4_Subheader_A3", 0);

      var sql = getDate_15_23(true);
      if(sql.MoveNext())
         InitProgress(Int(sql.value("t_Count")), NULL, "Печать данных...");

         RegisterTable("N4_MainTable_A3", NULL,
                     "N4_A3_1",
                     "N4_A3_2",
                     "N4_A3_3",
                     "N4_A3_4",
                     "N4_A3_5",
                     "N4_A3_6",
                     "N4_A3_7",
                     "N4_A3_8",
                     "N4_A3_9",
                     "N4_A3_10",
                     "N4_A3_11",
                     "N4_A3_12",
                     "N4_A3_13",
                     "N4_A3_14",
                     "N4_A3_15",
                     "N4_A3_16",
                     "N4_A3_17",
                     "N4_A3_18",
                     "N4_A3_19",
                     "N4_A3_20");

         while(ExistData)
            sum = round(sql.value("t_sum")/1000.0, 0);
            sum1 = sum1 + sum;

            i = 0;
            while(i < 5)
               PercCateg[i] = "";
               i = i + 1;
            end;

            categ = int(sql.value("t_categ"));
            percent = double (sql.value ("t_percent"));
            if(categ > 0)
               PercCateg[categ - 1] = string(percent:0:2, "%");
            end;

            calcres = round (percent * sum/100.0, 0);
            if(calcres > 0)
               A13_A14 = calcres;
            end;

            sumreserv = round(sql.value("t_sumreserv")/1000.0, 0);
            var sumresArr = TArray();
            i = 0;
            while(i < 4)
               sumresArr[i] = "";
               i = i + 1;
            end;

            if(sumreserv)
               A15 = sumreserv;
               if(categ > 1)
                  sumresArr[categ - 2] = sumreserv;
               end;
            end;

            ropsum = sql.value ("t_ropsum");
            if(ropsum)
               A20 = round(ropsum/1000.0, 0);
            end;

            PrintTableLine("N4_A3_1", sql.value("t_balance"), NULL,
                           "N4_A3_2", sql.value("t_issuer"), NULL,
                           "N4_A3_3", sum, NULL,
                           "N4_A3_4", PercCateg[0], NULL,
                           "N4_A3_5", PercCateg[1], NULL,
                           "N4_A3_6", PercCateg[2], NULL,
                           "N4_A3_7", PercCateg[3], NULL,
                           "N4_A3_8", PercCateg[4], NULL,
                           "N4_A3_9", "", NULL,
                           "N4_A3_10", "", NULL,
                           "N4_A3_11", "", NULL,
                           "N4_A3_12", "", NULL,
                           "N4_A3_13", A13_A14, NULL,
                           "N4_A3_14", A13_A14, NULL,
                           "N4_A3_15", A15, NULL,
                           "N4_A3_16", sumresArr[0], NULL,
                           "N4_A3_17", sumresArr[1], NULL,
                           "N4_A3_18", sumresArr[2], NULL,
                           "N4_A3_19", sumresArr[3], NULL,
                           "N4_A3_20", A20, NULL);

            ExistData = sql.MoveNext();
            UseProgress(num = num + 1);
         end;
         EndTable();

         CopyAllSheetInTotalBook("Сводная расшифровка", false, GetTableRange(), 0);

         PrintFormatString(NULL, "N4_Itog_A3_3", sum1);
         CopyAllSheetInTotalBook("Сводная расшифровка", false, "N4_Itog_A3", 0);

         RemProgress();
      end;
   end;

   private macro PrintA4()
      var A13_A14 = "", A15 = "";
      var calcres = $0, sumreserv = $0;
      var categ = 0;
      var PercCateg = TArray();
      var i = 0;
      var longVal = 0;
      var longArr = TArray();
      var sum = 0, rop = 0, percent = 0;
      var ExistData = true;
      var sum1 = $0;
      var num = 0;

      CopyAllSheetInTotalBook("Сводная расшифровка", false, "N4_Subheader_A4", 0);

      var sql = getDate_16_25 (true);

      if(sql.MoveNext())
         InitProgress(Int(sql.value("t_Count")), NULL, "Печать данных...");

         RegisterTable("N4_MainTable_A4", NULL,
                     "N4_A4_1",
                     "N4_A4_2",
                     "N4_A4_3",
                     "N4_A4_4",
                     "N4_A4_5",
                     "N4_A4_6",
                     "N4_A4_7",
                     "N4_A4_8",
                     "N4_A4_9",
                     "N4_A4_10",
                     "N4_A4_11",
                     "N4_A4_12",
                     "N4_A4_13",
                     "N4_A4_14",
                     "N4_A4_15",
                     "N4_A4_16",
                     "N4_A4_17",
                     "N4_A4_18",
                     "N4_A4_19",
                     "N4_A4_20");

         while(ExistData)
            sum = round(sql.value("t_sum")/1000.0, 0);
            sum1 = sum1 + sum;

            i = 0;
            while(i < 5)
               PercCateg[i] = "";
               i = i + 1;
            end;

            categ = int(sql.value("t_categ"));
            percent = double (sql.value ("t_percent"));
            if(categ > 0)
               PercCateg[categ - 1] = string(percent:0:2, "%");
            end;

            i = 0;
            while(i < 4)
               longArr[i] = "";
               i = i + 1;
            end;

            longVal = int(sql.value("t_long"));
            if(longVal > 0)
               longArr[longVal - 1] = sum;
            end;

            calcres = round(percent * sum/100.0, 0);
            if(calcres > 0)
               A13_A14 = calcres;
            end;

            sumreserv = round(sql.value("t_sumreserv")/1000.0, 0);
            var sumresArr = TArray();
            i = 0;
            while(i < 4)
               sumresArr[i] = "";
               i = i + 1;
            end;

            if(sumreserv)
               A15 = sumreserv;
               if(categ > 1)
                  sumresArr[categ - 2] = sumreserv;
               end;
            end;

            PrintTableLine("N4_A4_1", sql.value("t_balance"), NULL,
                           "N4_A4_2", sql.value ("t_issuer"), NULL,
                           "N4_A4_3", sum, NULL,
                           "N4_A4_4", PercCateg[0], NULL,
                           "N4_A4_5", PercCateg[1], NULL,
                           "N4_A4_6", PercCateg[2], NULL,
                           "N4_A4_7", PercCateg[3], NULL,
                           "N4_A4_8", PercCateg[4], NULL,
                           "N4_A4_9", longArr[0], NULL,
                           "N4_A4_10", longArr[1], NULL,
                           "N4_A4_11", longArr[2], NULL,
                           "N4_A4_12", longArr[3], NULL,
                           "N4_A4_13", A13_A14, NULL,
                           "N4_A4_14", A13_A14, NULL,
                           "N4_A4_15", A15, NULL,
                           "N4_A4_16", sumresArr[0], NULL,
                           "N4_A4_17", sumresArr[1], NULL,
                           "N4_A4_18", sumresArr[2], NULL,
                           "N4_A4_19", sumresArr[3], NULL,
                           "N4_A4_20", "", NULL);

            ExistData = sql.MoveNext();

            UseProgress(num = num + 1);
         end;
         EndTable();

         CopyAllSheetInTotalBook("Сводная расшифровка", false, GetTableRange(), 0);

         PrintFormatString(NULL, "N4_Itog_A4_3", sum1);
         CopyAllSheetInTotalBook("Сводная расшифровка", false, "N4_Itog_A4", 0);

         RemProgress();
      end;
   end;

   private macro PrintA5()
      var A13_A14 = "", A15 = "", A20 = "";
      var calcres = $0, sumreserv = $0;
      var categ = 0;
      var PercCateg = TArray();
      var i = 0;
      var longVal = 0;
      var longArr = TArray();
      var sum = 0, rop = 0, ropsum = 0, percent = 0;
      var ExistData = true;
      var sum1 = $0;
      var num = 0;

      CopyAllSheetInTotalBook("Сводная расшифровка", false, "N4_Subheader_A5", 0);

      var sql = getData_17_26 (true);

      if(sql.MoveNext())
         InitProgress(Int(sql.value("t_Count")), NULL, "Печать данных...");

         RegisterTable("N4_MainTable_A5", NULL,
                       "N4_A5_1",
                       "N4_A5_2",
                       "N4_A5_3",
                       "N4_A5_4",
                       "N4_A5_5",
                       "N4_A5_6",
                       "N4_A5_7",
                       "N4_A5_8",
                       "N4_A5_9",
                       "N4_A5_10",
                       "N4_A5_11",
                       "N4_A5_12",
                       "N4_A5_13",
                       "N4_A5_14",
                       "N4_A5_15",
                       "N4_A5_16",
                       "N4_A5_17",
                       "N4_A5_18",
                       "N4_A5_19",
                       "N4_A5_20");

         while(ExistData)
            sum = round(sql.value("t_sum")/1000.0, 0);
            sum1 = sum1 + sum;

            i = 0;
            while(i < 5)
               PercCateg[i] = "";
               i = i + 1;
            end;

            categ = int(sql.value("t_categ"));
            percent = double (sql.value ("t_percent"));
            if(categ > 0)
               PercCateg[categ - 1] = string(percent:0:2, "%");
            end;

            calcres = round (percent * sum/100.0, 0);
            if(calcres > 0)
               A13_A14 = calcres;
            end;

            sumreserv = round(sql.value("t_sumreserv")/1000.0, 0);
            var sumresArr = TArray();
            i = 0;
            while(i < 4)
               sumresArr[i] = "";
               i = i + 1;
            end;

            if(sumreserv)
               A15 = sumreserv;
               if(categ > 1)
                  sumresArr[categ - 2] = sumreserv;
               end;
            end;

            ropsum = sql.value("t_ropsum");
            if(ropsum)
               A20 = round(ropsum/1000.0, 0);
            end;

            PrintTableLine("N4_A5_1", sql.value("t_balance"), NULL,
                           "N4_A5_2", sql.value ("t_nameaccount"), NULL,
                           "N4_A5_3", sum, NULL,
                           "N4_A5_4", PercCateg[0], NULL,
                           "N4_A5_5", PercCateg[1], NULL,
                           "N4_A5_6", PercCateg[2], NULL,
                           "N4_A5_7", PercCateg[3], NULL,
                           "N4_A5_8", PercCateg[4], NULL,
                           "N4_A5_9", "", NULL,
                           "N4_A5_10", "", NULL,
                           "N4_A5_11", "", NULL,
                           "N4_A5_12", "", NULL,
                           "N4_A5_13", A13_A14, NULL,
                           "N4_A5_14", A13_A14, NULL,
                           "N4_A5_15", A15, NULL,
                           "N4_A5_16", sumresArr[0], NULL,
                           "N4_A5_17", sumresArr[1], NULL,
                           "N4_A5_18", sumresArr[2], NULL,
                           "N4_A5_19", sumresArr[3], NULL,
                           "N4_A5_20", A20, NULL);

            ExistData = sql.MoveNext();

            UseProgress(num = num + 1);
         end;
         EndTable();

         CopyAllSheetInTotalBook("Сводная расшифровка", false, GetTableRange(), 0);

         PrintFormatString(NULL, "N4_Itog_A5_3", sum1);
         CopyAllSheetInTotalBook("Сводная расшифровка", false, "N4_Itog_A5", 0);

         RemProgress();
      end;
   end;

   private macro PrintA6()
      var A13_A14 = "", A15 = "", A20 = "";
      var calcres = $0, sumreserv = $0;
      var categ = 0;
      var PercCateg = TArray();
      var i = 0;
      var longVal = 0;
      var longArr = TArray();
      var sum = 0, rop = 0, ropsum = 0, percent = 0;
      var ExistData = true;
      var sum1 = $0;
      var num = 0;

      CopyAllSheetInTotalBook("Сводная расшифровка", false, "N4_Subheader_A6", 0);

      var sql = getData_18_27 (true);

      if(sql.MoveNext())
         InitProgress(Int(sql.value("t_Count")), NULL, "Печать данных...");
         RegisterTable("N4_MainTable_A6", NULL,
                       "N4_A6_1",
                       "N4_A6_2",
                       "N4_A6_3",
                       "N4_A6_4",
                       "N4_A6_5",
                       "N4_A6_6",
                       "N4_A6_7",
                       "N4_A6_8",
                       "N4_A6_9",
                       "N4_A6_10",
                       "N4_A6_11",
                       "N4_A6_12",
                       "N4_A6_13",
                       "N4_A6_14",
                       "N4_A6_15",
                       "N4_A6_16",
                       "N4_A6_17",
                       "N4_A6_18",
                       "N4_A6_19",
                       "N4_A6_20");

         while(ExistData)
            sum = round(sql.value("t_sum")/1000.0, 0);
            sum1 = sum1 + sum;

            i = 0;
            while(i < 5)
               PercCateg[i] = "";
               i = i + 1;
            end;

            categ = int(sql.value("t_categ"));
            percent = double (sql.value ("t_percent"));
            if(categ > 0)
               PercCateg[categ - 1] = string(percent:0:2, "%");
            end;

            i = 0;
            while(i < 4)
               longArr[i] = "";
               i = i + 1;
            end;

            longVal = int(sql.value("t_long"));
            if(longVal > 0)
               longArr[longVal - 1] = sum;
            end;

            calcres = round (percent * sum/100.0, 0);
            if(calcres > 0)
               A13_A14 = calcres;
            end;

            sumreserv = round(sql.value("t_sumreserv")/1000.0, 0);
            var sumresArr = TArray();
            i = 0;
            while(i < 4)
               sumresArr[i] = "";
               i = i + 1;
            end;

            if(sumreserv)
               A15 = sumreserv;
               if(categ > 1)
                  sumresArr[categ - 2] = sumreserv;
               end;
            end;

            ropsum = sql.value("t_ropsum");
            if(ropsum)
               A20 = round(ropsum/1000.0, 0);
            end;

            PrintTableLine("N4_A6_1", sql.value("t_balance"), NULL,
                           "N4_A6_2", sql.value ("t_issuer"), NULL,
                           "N4_A6_3", sum, NULL,
                           "N4_A6_4", PercCateg[0], NULL,
                           "N4_A6_5", PercCateg[1], NULL,
                           "N4_A6_6", PercCateg[2], NULL,
                           "N4_A6_7", PercCateg[3], NULL,
                           "N4_A6_8", PercCateg[4], NULL,
                           "N4_A6_9", longArr[0], NULL,
                           "N4_A6_10", longArr[1], NULL,
                           "N4_A6_11", longArr[2], NULL,
                           "N4_A6_12", longArr[3], NULL,
                           "N4_A6_13", A13_A14, NULL,
                           "N4_A6_14", A13_A14, NULL,
                           "N4_A6_15", A15, NULL,
                           "N4_A6_16", sumresArr[0], NULL,
                           "N4_A6_17", sumresArr[1], NULL,
                           "N4_A6_18", sumresArr[2], NULL,
                           "N4_A6_19", sumresArr[3], NULL,
                           "N4_A6_20", A20, NULL);

            ExistData = sql.MoveNext();

            UseProgress(num = num + 1);
         end;
         EndTable();

         CopyAllSheetInTotalBook("Сводная расшифровка", false, GetTableRange(), 0);

         PrintFormatString(NULL, "N4_Itog_A6_3", sum1);
         CopyAllSheetInTotalBook("Сводная расшифровка", false, "N4_Itog_A6", 0);

         RemProgress();
      end;
   end;

   private macro PrintA7()
      var A13_A14 = "", A15 = "", A20 = "";
      var calcres = $0, sumreserv = $0;
      var categ = 0;
      var PercCateg = TArray();
      var i = 0;
      var longVal = 0;
      var longArr = TArray();
      var sum = 0, rop = 0, ropsum = 0, percent = 0;
      var ExistData = true;
      var sum1 = $0;
      var num = 0;

      CopyAllSheetInTotalBook("Сводная расшифровка", false, "N4_Subheader_A7", 0);
  
      var sql = getData_13_22 (false);

      if(sql.MoveNext())
         InitProgress(Int(sql.value("t_Count")), NULL, "Печать данных...");

         RegisterTable("N4_MainTable_A7", NULL,
                       "N4_A7_1",
                       "N4_A7_2",
                       "N4_A7_3",
                       "N4_A7_4",
                       "N4_A7_5",
                       "N4_A7_6",
                       "N4_A7_7",
                       "N4_A7_8",
                       "N4_A7_9",
                       "N4_A7_10",
                       "N4_A7_11",
                       "N4_A7_12",
                       "N4_A7_13",
                       "N4_A7_14",
                       "N4_A7_15",
                       "N4_A7_16",
                       "N4_A7_17",
                       "N4_A7_18",
                       "N4_A7_19",
                       "N4_A7_20");

         while(ExistData)
            sum = round(sql.value("t_sum")/1000.0, 0);
            sum1 = sum1 + sum;

            i = 0;
            while(i < 5)
               PercCateg[i] = "";
               i = i + 1;
            end;

            categ = int(sql.value("t_categ"));
            percent = double (sql.value ("t_percent"));
            if(categ > 0)
               PercCateg[categ - 1] = string(percent:0:2, "%");
            end;

            i = 0;
            while(i < 4)
               longArr[i] = "";
               i = i + 1;
            end;

            longVal = int(sql.value("t_long"));
            if(longVal > 0)
               longArr[longVal - 1] = sum;
            end;

            calcres = round(percent * sum/100.0, 0);
            if(calcres > 0)
               A13_A14 = calcres;
            end;

            sumreserv = round(sql.value("t_sumreserv")/1000.0, 0);
            var sumresArr = TArray();
            i = 0;
            while(i < 4)
               sumresArr[i] = "";
               i = i + 1;
            end;

            if(sumreserv)
               A15 = sumreserv;
               if(categ > 1)
                  sumresArr[categ - 2] = sumreserv;
               end;
            end;

            rop = sql.value ("t_rop");
            if((valType (A15) == V_DOUBLE) and (round (rop * sum/100.0-A15, 0) != 0) )
               A20 = round(rop * sum/100.0 - A15, 0);
            end;

            PrintTableLine("N4_A7_1", sql.value("t_balance"), NULL,
                           "N4_A7_2", sql.value("t_issuer"), NULL,
                           "N4_A7_3", sum, NULL,
                           "N4_A7_4", PercCateg[0], NULL,
                           "N4_A7_5", PercCateg[1], NULL,
                           "N4_A7_6", PercCateg[2], NULL,
                           "N4_A7_7", PercCateg[3], NULL,
                           "N4_A7_8", PercCateg[4], NULL,
                           "N4_A7_9", longArr[0], NULL,
                           "N4_A7_10", longArr[1], NULL,
                           "N4_A7_11", longArr[2], NULL,
                           "N4_A7_12", longArr[3], NULL,
                           "N4_A7_13", A13_A14, NULL,
                           "N4_A7_14", A13_A14, NULL,
                           "N4_A7_15", A15, NULL,
                           "N4_A7_16", sumresArr[0], NULL,
                           "N4_A7_17", sumresArr[1], NULL,
                           "N4_A7_18", sumresArr[2], NULL,
                           "N4_A7_19", sumresArr[3], NULL,
                           "N4_A7_20", A20, NULL);

            ExistData = sql.MoveNext();

            UseProgress(num = num + 1);
         end;
         EndTable();

         CopyAllSheetInTotalBook("Сводная расшифровка", false, GetTableRange(), 0);

         PrintFormatString(NULL, "N4_Itog_A7_3", sum1);
         CopyAllSheetInTotalBook("Сводная расшифровка", false, "N4_Itog_A7", 0);

         RemProgress();
      end;
   end;

   private macro PrintA8()
      var A13_A14 = "", A15 = "", A20 = "";
      var calcres = $0, sumreserv = $0;
      var categ = 0;
      var PercCateg = TArray();
      var i = 0;
      var longVal = 0;
      var longArr = TArray();
      var sum = 0, rop = 0, ropsum = 0, percent = 0;
      var ExistData = true;
      var sum1 = $0;
      var num = 0;

      CopyAllSheetInTotalBook("Сводная расшифровка", false, "N4_Subheader_A8", 0);

      var sql = getDate_15_23 (false);

      if(sql.MoveNext())
         InitProgress(Int(sql.value("t_Count")), NULL, "Печать данных...");

         RegisterTable("N4_MainTable_A8", NULL,
                       "N4_A8_1",
                       "N4_A8_2",
                       "N4_A8_3",
                       "N4_A8_4",
                       "N4_A8_5",
                       "N4_A8_6",
                       "N4_A8_7",
                       "N4_A8_8",
                       "N4_A8_9",
                       "N4_A8_10",
                       "N4_A8_11",
                       "N4_A8_12",
                       "N4_A8_13",
                       "N4_A8_14",
                       "N4_A8_15",
                       "N4_A8_16",
                       "N4_A8_17",
                       "N4_A8_18",
                       "N4_A8_19",
                       "N4_A8_20");

         while(ExistData)
            sum = round(sql.value("t_sum")/1000.0, 0);
            sum1 = sum1 + sum;

            i = 0;
            while(i < 5)
               PercCateg[i] = "";
               i = i + 1;
            end;

            categ = int(sql.value("t_categ"));
            percent = double (sql.value ("t_percent"));
            if(categ > 0)
               PercCateg[categ - 1] = string(percent:0:2, "%");
            end;

            calcres = round (percent * sum/100.0, 0);
            if(calcres > 0)
               A13_A14 = calcres;
            end;

            sumreserv = round(sql.value("t_sumreserv")/1000.0, 0);
            var sumresArr = TArray();
            i = 0;
            while(i < 4)
               sumresArr[i] = "";
               i = i + 1;
            end;

            if(sumreserv)
               A15 = sumreserv;
               if(categ > 1)
                  sumresArr[categ - 2] = sumreserv;
               end;
            end;

            ropsum = sql.value("t_ropsum");
            rop = sql.value("t_rop");
            if(ropsum)
               A20 = round(ropsum/1000.0, 0);
            elif((valType(A15) == V_DOUBLE) and (round(rop * sum/100.0-A15, 0) != 0) )
               A20 = Abs(round(rop * sum/100.0 - A15, 0));
            end;

            PrintTableLine("N4_A8_1", sql.value("t_balance"), NULL,
                           "N4_A8_2", sql.value("t_issuer"), NULL,
                           "N4_A8_3", sum, NULL,
                           "N4_A8_4", PercCateg[0], NULL,
                           "N4_A8_5", PercCateg[1], NULL,
                           "N4_A8_6", PercCateg[2], NULL,
                           "N4_A8_7", PercCateg[3], NULL,
                           "N4_A8_8", PercCateg[4], NULL,
                           "N4_A8_9", "", NULL,
                           "N4_A8_10", "", NULL,
                           "N4_A8_11", "", NULL,
                           "N4_A8_12", "", NULL,
                           "N4_A8_13", A13_A14, NULL,
                           "N4_A8_14", A13_A14, NULL,
                           "N4_A8_15", A15, NULL,
                           "N4_A8_16", sumresArr[0], NULL,
                           "N4_A8_17", sumresArr[1], NULL,
                           "N4_A8_18", sumresArr[2], NULL,
                           "N4_A8_19", sumresArr[3], NULL,
                           "N4_A8_20", A20, NULL);

            ExistData = sql.MoveNext();

            UseProgress(num = num + 1);
         end;
         EndTable();

         CopyAllSheetInTotalBook("Сводная расшифровка", false, GetTableRange(), 0);

         PrintFormatString(NULL, "N4_Itog_A8_3", sum1);
         CopyAllSheetInTotalBook("Сводная расшифровка", false, "N4_Itog_A8", 0);

         RemProgress();
      end;
   end;

   private macro PrintA9()
      var A13_A14 = "", A15 = "", A20 = "";
      var calcres = $0, sumreserv = $0;
      var categ = 0;
      var PercCateg = TArray();
      var i = 0;
      var longVal = 0;
      var longArr = TArray();
      var sum = 0, rop = 0, ropsum = 0, percent = 0;
      var ExistData = true;
      var sum1 = $0;
      var num = 0;

      CopyAllSheetInTotalBook("Сводная расшифровка", false, "N4_Subheader_A9", 0);

      var sql = getData_14_24 (false);

      if(sql.MoveNext())
         InitProgress(Int(sql.value("t_Count")), NULL, "Печать данных...");

         RegisterTable("N4_MainTable_A9", NULL,
                       "N4_A9_1",
                       "N4_A9_2",
                       "N4_A9_3",
                       "N4_A9_4",
                       "N4_A9_5",
                       "N4_A9_6",
                       "N4_A9_7",
                       "N4_A9_8",
                       "N4_A9_9",
                       "N4_A9_10",
                       "N4_A9_11",
                       "N4_A9_12",
                       "N4_A9_13",
                       "N4_A9_14",
                       "N4_A9_15",
                       "N4_A9_16",
                       "N4_A9_17",
                       "N4_A9_18",
                       "N4_A9_19",
                       "N4_A9_20");

         while(ExistData)
            sum = round (sql.value ("t_sum")/1000.0, 0);
            sum1 = sum1 + sum;

            i = 0;
            while(i < 5)
               PercCateg[i] = "";
               i = i + 1;
            end;

            categ = int(sql.value("t_categ"));
            percent = double (sql.value ("t_percent"));
            if(categ > 0)
               PercCateg[categ - 1] = string(percent:0:2, "%");
            end;

            i = 0;
            while(i < 4)
               longArr[i] = "";
               i = i + 1;
            end;

            longVal = int(sql.value("t_long"));
            if(longVal > 0)
               longArr[longVal - 1] = sum;
            end;

            calcres = round(percent * round(sql.value ("t_sum_baz")/1000.0, 0)/100.0, 0);
            if(calcres > 0)
               A13_A14 = calcres;
            end;

            sumreserv = round(sql.value("t_sumreserv")/1000.0, 0);
            var sumresArr = TArray();
            i = 0;
            while(i < 4)
               sumresArr[i] = "";
               i = i + 1;
            end;

            if(sumreserv)
               A15 = sumreserv;
               if(categ > 1)
                  sumresArr[categ - 2] = sumreserv;
               end;
            end;

            rop = sql.value("t_rop");
            if((valType(A15) == V_DOUBLE) and (round(rop * sum/100.0-A15, 0) != 0))
               A20 = round(rop * sum/100.0 - A15, 0);
            end;

            ropsum = sql.value ("t_ropsum");
            if(ropsum)
               A20 = round (ropsum/1000.0, 0);
            end;

            PrintTableLine("N4_A9_1", sql.value("t_balance"), NULL,
                           "N4_A9_2", sql.value("t_issuer"), NULL,
                           "N4_A9_3", sum, NULL,
                           "N4_A9_4", PercCateg[0], NULL,
                           "N4_A9_5", PercCateg[1], NULL,
                           "N4_A9_6", PercCateg[2], NULL,
                           "N4_A9_7", PercCateg[3], NULL,
                           "N4_A9_8", PercCateg[4], NULL,
                           "N4_A9_9", longArr[0], NULL,
                           "N4_A9_10", longArr[1], NULL,
                           "N4_A9_11", longArr[2], NULL,
                           "N4_A9_12", longArr[3], NULL,
                           "N4_A9_13", A13_A14, NULL,
                           "N4_A9_14", A13_A14, NULL,
                           "N4_A9_15", A15, NULL,
                           "N4_A9_16", sumresArr[0], NULL,
                           "N4_A9_17", sumresArr[1], NULL,
                           "N4_A9_18", sumresArr[2], NULL,
                           "N4_A9_19", sumresArr[3], NULL,
                           "N4_A9_20", A20, NULL);

            ExistData = sql.MoveNext();

            UseProgress(num = num + 1);
         end;
         EndTable();

         CopyAllSheetInTotalBook("Сводная расшифровка", false, GetTableRange(), 0);

         PrintFormatString(NULL, "N4_Itog_A9_3", sum1);
         CopyAllSheetInTotalBook("Сводная расшифровка", false, "N4_Itog_A9", 0);

         RemProgress();
      end;
   end;

   private macro PrintA10()
      var A13_A14 = "", A15 = "", A20 = "";
      var calcres = $0, sumreserv = $0;
      var categ = 0;
      var PercCateg = TArray();
      var i = 0;
      var longVal = 0;
      var longArr = TArray();
      var sum = 0, rop = 0, ropsum = 0, percent = 0;
      var ExistData = true;
      var sum1 = $0;
      var num = 0;

      CopyAllSheetInTotalBook("Сводная расшифровка", false, "N4_Subheader_A10", 0);

      var sql = getDate_16_25 (false);

      if(sql.MoveNext())
         InitProgress(Int(sql.value("t_Count")), NULL, "Печать данных...");

         RegisterTable("N4_MainTable_A10", NULL,
                       "N4_A10_1",
                       "N4_A10_2",
                       "N4_A10_3",
                       "N4_A10_4",
                       "N4_A10_5",
                       "N4_A10_6",
                       "N4_A10_7",
                       "N4_A10_8",
                       "N4_A10_9",
                       "N4_A10_10",
                       "N4_A10_11",
                       "N4_A10_12",
                       "N4_A10_13",
                       "N4_A10_14",
                       "N4_A10_15",
                       "N4_A10_16",
                       "N4_A10_17",
                       "N4_A10_18",
                       "N4_A10_19",
                       "N4_A10_20");

         while(ExistData)
            sum = round(sql.value("t_sum")/1000.0, 0);
            sum1 = sum1 + sum;

            i = 0;
            while(i < 5)
               PercCateg[i] = "";
               i = i + 1;
            end;

            categ = int(sql.value("t_categ"));
            percent = double (sql.value ("t_percent"));
            if(categ > 0)
               PercCateg[categ - 1] = string(percent:0:2, "%");
            end;

            i = 0;
            while(i < 4)
               longArr[i] = "";
               i = i + 1;
            end;

            longVal = int(sql.value("t_long"));
            if(longVal > 0)
               longArr[longVal - 1] = sum;
            end;

            calcres = round (percent * sum/100.0, 0);
            if(calcres > 0)
               A13_A14 = calcres;
            end;

            sumreserv = round(sql.value("t_sumreserv")/1000.0, 0);
            var sumresArr = TArray();
            i = 0;
            while(i < 4)
               sumresArr[i] = "";
               i = i + 1;
            end;

            if(sumreserv)
               A15 = sumreserv;
               if(categ > 1)
                  sumresArr[categ - 2] = sumreserv;
               end;
            end;

            PrintTableLine("N4_A10_1", sql.value("t_balance"), NULL,
                           "N4_A10_2", sql.value("t_issuer"), NULL,
                           "N4_A10_3", sum, NULL,
                           "N4_A10_4", PercCateg[0], NULL,
                           "N4_A10_5", PercCateg[1], NULL,
                           "N4_A10_6", PercCateg[2], NULL,
                           "N4_A10_7", PercCateg[3], NULL,
                           "N4_A10_8", PercCateg[4], NULL,
                           "N4_A10_9", longArr[0], NULL,
                           "N4_A10_10", longArr[1], NULL,
                           "N4_A10_11", longArr[2], NULL,
                           "N4_A10_12", longArr[3], NULL,
                           "N4_A10_13", A13_A14, NULL,
                           "N4_A10_14", A13_A14, NULL,
                           "N4_A10_15", A15, NULL,
                           "N4_A10_16", sumresArr[0], NULL,
                           "N4_A10_17", sumresArr[1], NULL,
                           "N4_A10_18", sumresArr[2], NULL,
                           "N4_A10_19", sumresArr[3], NULL,
                           "N4_A10_20", "", NULL);

            ExistData = sql.MoveNext();

            UseProgress(num = num + 1);
         end;
         EndTable();

         CopyAllSheetInTotalBook("Сводная расшифровка", false, GetTableRange(), 0);

         PrintFormatString(NULL, "N4_Itog_A10_3", sum1);
         CopyAllSheetInTotalBook("Сводная расшифровка", false, "N4_Itog_A10", 0);

         RemProgress();
      end;
   end;

   private macro PrintA11()
      var A13_A14 = "", A15 = "", A20 = "";
      var calcres = $0, sumreserv = $0;
      var categ = 0;
      var PercCateg = TArray();
      var i = 0;
      var longVal = 0;
      var longArr = TArray();
      var sum = 0, rop = 0, ropsum = 0, percent = 0;
      var ExistData = true;
      var sum1 = $0;
      var num = 0;

      CopyAllSheetInTotalBook("Сводная расшифровка", false, "N4_Subheader_A11", 0);

      var sql = getData_17_26 (false);

      if(sql.MoveNext())
         InitProgress(Int(sql.value("t_Count")), NULL, "Печать данных...");

         RegisterTable("N4_MainTable_A11", NULL,
                       "N4_A11_1",
                       "N4_A11_2",
                       "N4_A11_3",
                       "N4_A11_4",
                       "N4_A11_5",
                       "N4_A11_6",
                       "N4_A11_7",
                       "N4_A11_8",
                       "N4_A11_9",
                       "N4_A11_10",
                       "N4_A11_11",
                       "N4_A11_12",
                       "N4_A11_13",
                       "N4_A11_14",
                       "N4_A11_15",
                       "N4_A11_16",
                       "N4_A11_17",
                       "N4_A11_18",
                       "N4_A11_19",
                       "N4_A11_20");

         while(ExistData)
            sum = round (sql.value ("t_sum")/1000.0, 0);
            sum1 = sum1 + sum;

            i = 0;
            while(i < 5)
               PercCateg[i] = "";
               i = i + 1;
            end;

            categ = int(sql.value("t_categ"));
            percent = double (sql.value ("t_percent"));
            if(categ > 0)
               PercCateg[categ - 1] = string(percent:0:2, "%");
            end;

            calcres = round (percent * sum/100.0, 0);
            if(calcres > 0)
               A13_A14 = calcres;
            end;

            sumreserv = round(sql.value("t_sumreserv")/1000.0, 0);
            var sumresArr = TArray();
            i = 0;
            while(i < 4)
               sumresArr[i] = "";
               i = i + 1;
            end;

            if(sumreserv)
               A15 = sumreserv;
               if(categ > 1)
                  sumresArr[categ - 2] = sumreserv;
               end;
            end;

            if(sql.value("t_ropsum"))
               A20 = round (sql.value ("t_ropsum")/1000.0, 0);
            end;

            PrintTableLine("N4_A11_1", sql.value("t_balance"), NULL,
                           "N4_A11_2", sql.value("t_nameaccount"), NULL,
                           "N4_A11_3", sum, NULL,
                           "N4_A11_4", PercCateg[0], NULL,
                           "N4_A11_5", PercCateg[1], NULL,
                           "N4_A11_6", PercCateg[2], NULL,
                           "N4_A11_7", PercCateg[3], NULL,
                           "N4_A11_8", PercCateg[4], NULL,
                           "N4_A11_9", "", NULL,
                           "N4_A11_10", "", NULL,
                           "N4_A11_11", "", NULL,
                           "N4_A11_12", "", NULL,
                           "N4_A11_13", A13_A14, NULL,
                           "N4_A11_14", A13_A14, NULL,
                           "N4_A11_15", A15, NULL,
                           "N4_A11_16", sumresArr[0], NULL,
                           "N4_A11_17", sumresArr[1], NULL,
                           "N4_A11_18", sumresArr[2], NULL,
                           "N4_A11_19", sumresArr[3], NULL,
                           "N4_A11_20", A20, NULL);

            ExistData = sql.MoveNext();

            UseProgress(num = num + 1);
         end;
         EndTable();

         CopyAllSheetInTotalBook("Сводная расшифровка", false, GetTableRange(), 0);

         PrintFormatString(NULL, "N4_Itog_A11_3", sum1);
         CopyAllSheetInTotalBook("Сводная расшифровка", false, "N4_Itog_A11", 0);

         RemProgress();
      end;
   end;

   private macro PrintA12()
      var A13_A14 = "", A15 = "", A20 = "";
      var calcres = $0, sumreserv = $0;
      var categ = 0;
      var PercCateg = TArray();
      var i = 0;
      var longVal = 0;
      var longArr = TArray();
      var sum = 0, rop = 0, ropsum = 0, percent = 0;
      var ExistData = true;
      var sum1 = $0;
      var num = 0;

      CopyAllSheetInTotalBook("Сводная расшифровка", false, "N4_Subheader_A12", 0);

      var sql = getData_18_27(false);

      if(sql.MoveNext())
         InitProgress(Int(sql.value("t_Count")), NULL, "Печать данных...");
         RegisterTable("N4_MainTable_A12", NULL,
                       "N4_A12_1",
                       "N4_A12_2",
                       "N4_A12_3",
                       "N4_A12_4",
                       "N4_A12_5",
                       "N4_A12_6",
                       "N4_A12_7",
                       "N4_A12_8",
                       "N4_A12_9",
                       "N4_A12_10",
                       "N4_A12_11",
                       "N4_A12_12",
                       "N4_A12_13",
                       "N4_A12_14",
                       "N4_A12_15",
                       "N4_A12_16",
                       "N4_A12_17",
                       "N4_A12_18",
                       "N4_A12_19",
                       "N4_A12_20");

         while(ExistData)
            sum = round(sql.value("t_sum")/1000.0, 0);
            sum1 = sum1 + sum;

            i = 0;
            while(i < 5)
               PercCateg[i] = "";
               i = i + 1;
            end;

            categ = int(sql.value("t_categ"));
            percent = double (sql.value ("t_percent"));
            if(categ > 0)
               PercCateg[categ - 1] = string(percent:0:2, "%");
            end;

            i = 0;
            while(i < 4)
               longArr[i] = "";
               i = i + 1;
            end;

            longVal = int(sql.value("t_long"));
            if(longVal > 0)
               longArr[longVal - 1] = sum;
            end;

            calcres = round (percent * sum/100.0, 0);
            if(calcres > 0)
               A13_A14 = calcres;
            end;

            sumreserv = round(sql.value("t_sumreserv")/1000.0, 0);
            var sumresArr = TArray();
            i = 0;
            while(i < 4)
               sumresArr[i] = "";
               i = i + 1;
            end;

            if(sumreserv)
               A15 = sumreserv;
               if(categ > 1)
                  sumresArr[categ - 2] = sumreserv;
               end;
            end;

            ropsum = sql.value("t_ropsum");
            rop = sql.value("t_rop");
            if(ropsum)
               A20 = round(ropsum/1000.0, 0);
            elif((valType(A15) == V_DOUBLE) and (round(rop * sum/100.0-A15, 0) != 0) )
               A20 = Abs(round(rop * sum/100.0 - A15, 0));
            end;

            PrintTableLine("N4_A12_1", sql.value ("t_balance"), NULL,
                           "N4_A12_2", sql.value ("t_issuer"), NULL,
                           "N4_A12_3", sum, NULL,
                           "N4_A12_4", PercCateg[0], NULL,
                           "N4_A12_5", PercCateg[1], NULL,
                           "N4_A12_6", PercCateg[2], NULL,
                           "N4_A12_7", PercCateg[3], NULL,
                           "N4_A12_8", PercCateg[4], NULL,
                           "N4_A12_9", longArr[0], NULL,
                           "N4_A12_10", longArr[1], NULL,
                           "N4_A12_11", longArr[2], NULL,
                           "N4_A12_12", longArr[3], NULL,
                           "N4_A12_13", A13_A14, NULL,
                           "N4_A12_14", A13_A14, NULL,
                           "N4_A12_15", A15, NULL,
                           "N4_A12_16", sumresArr[0], NULL,
                           "N4_A12_17", sumresArr[1], NULL,
                           "N4_A12_18", sumresArr[2], NULL,
                           "N4_A12_19", sumresArr[3], NULL,
                           "N4_A12_20", A20, NULL);

            ExistData = sql.MoveNext();

            UseProgress(num = num + 1);
         end;
         EndTable();

         CopyAllSheetInTotalBook("Сводная расшифровка", false, GetTableRange(), 0);

         PrintFormatString(NULL, "N4_Itog_A12_3", sum1);
         CopyAllSheetInTotalBook("Сводная расшифровка", false, "N4_Itog_A12", 0);

         RemProgress();
      end;
   end;

   macro Create()
      SetActiveSheet("Сводная расшифровка");

      initProgress (13, NULL, "Сводная расшифровка");

      PrintHeader();

      // Раздел 1
      PrintA1();
      useProgress (1);

      PrintA2();
      useProgress (2);

      PrintA3();
      useProgress(3);

      PrintA4();
      useProgress (4);

      PrintA5();
      useProgress (5);

      PrintA6();
      useProgress (6);

      PrintA7();
      useProgress (7);

      PrintA8();
      UseProgress(8);

      PrintA9();
      useProgress (9);

      PrintA10();
      useProgress (10);

      PrintA11();
      useProgress(11);

      PrintA12();
      useProgress(12);

      // Раздел 2. В разделе 2 никаких данных не печатается, поэтому просто копируем то, что есть в шаблоне
      CopyAllSheetInTotalBook("Сводная расшифровка", false, "N4_Part2", 0);
      useProgress(13);

      remProgress();
   end;

   macro EndReport()
      SaveTotalBook();
   end;

   initDL_CReportTemplate(NULL, "Report_f115_detail_4.xls", true, false, NULL, true);
END;

Private macro makeReport
   if(parm.("rep1"))
      f115_details_1().Run();
   end;
   if(parm.("rep2"))
      f115_details_2().Run();
   end;
   if(parm.("rep3"))
      f115_details_3().Run();
   end;
   if(parm.("rep4"))
      f115_details_4().Run();
   end;
End;

Private macro getRestRezerv ( fiid )
    Var sum = $0, sql, x;
    for (x, split (fiid, ","))
        sql = execSqlSelect ("select sum (rsb_account.restall (t_account, t_chapter, t_code_currency, :1-1, 0)) from daccount_dbt where (t_chapter, t_account, t_code_currency) in "+
                             "(select t_chapter, t_account, t_currency from dmcaccdoc_dbt f where t_catnum = 241 and exists (select 1 from dmctempl_dbt where t_value1 = 4 and t_catid = (select t_id from dmccateg_dbt where t_number = 241) and t_number = t_templnum) and t_fiid = :2)",
                             makeArray (sqlParam ("1", parm.("date")-1), sqlParam ("2", x)));
        if ( sql.moveNext () and (valType (sql.value (0)) != 26) )
            sum = sum + money (sql.value (0));
        end;
    end;
    return sum;
End;

//-----------------------------------------------------------------------------------------

Private macro mergeandset ( range, value, bold )
    range.merge ();
    range.value = value;
    if ( bold )
        range.font.bold = true;
    end;
End;
//-----------------------------------------------------------------------------------------

Private class (TRecHandler) CParam
    initTRecHandler ("f115", "f115_detail.lbr", TRUE);

    Macro handler ( dlg, cmd, id, key )
        if ( (cmd == DLG_KEY) and (key == kbF3) and (id == fldIndex ("date")) )
            dlg.(id) = getDateByCalendar (dlg.(id));
        elif ( (cmd == DLG_KEY) and (key == kbSpace) and inList (id, fldIndex ("rep1"), fldIndex ("rep2"), fldIndex ("rep3"), fldIndex ("rep4"), fldIndex("ShowZeroLines")) )
            dlg.(id) = ifThenElse (dlg.(id), "", "X");
        elif ( (cmd == DLG_KEY) and (key == kbF9) )
            return CM_IGNORE;
        elif ( (cmd == DLG_KEY) and (key == kbF2) )
            if ( dlg.("rep1") + dlg.("rep2") + dlg.("rep3") + dlg.("rep4") == "" )
                msgBox ("Необходимо указать вид сделок");
            else
                return CM_SAVE;
            end;
        end;
    End;

    Macro Run
        return runDialog (this, R2M (this, "Handler"));
    End;
End;
//-----------------------------------------------------------------------------------------
