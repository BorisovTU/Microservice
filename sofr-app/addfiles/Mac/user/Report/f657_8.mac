//Информация о сделках ПФИ с базовым активом- иностр. валюта по состоянию на дату 

import or_rep_h, globals, oralib, likepy,or_tpl_h;

const COLOR = 10192433;
const TXTCOLOR = -1;

macro f657_8 ():variant
  var Rep,csvFile,csvTable,fName;
  var repname;
  var rn:integer = 0;
  var sheet = 1;
  var count = 0;
  var repdate = {curdate};
  var sql, rs, code;


  if (not GetDate(repdate))
    return 0;
  end;


  /*19 колонок*/
  Rep = CTemplateXLS(NULL, NULL, NULL, NULL, NULL, NULL, true, false);
  if(Rep.UsePoi())
	Rep.SetXLSXFormat();
  end;
  
  Rep.CreateTotalBook();

  Rep.openTemplate("f_657_8_template.xlsx",true);
  Rep.SheetChange(1);
  

  csvTable = Rep.RegisterTable ("templateTable", "templateHeader", true);
  csvFile = C_CSVFile ();
  
  if (Rep.UseBigReport ())
      csvFile.SetLimitRow (FLUSH_COUNT_XLSX);
  end;
  
  Rep.CopyAllSheetInTotalBook (null, false, "templateHeader", 0, "template");

  fName = csvFile.CreateFullFileName ("f_657_8_csv.txt");
  csvFile.FileOpen (fName, true);

  sql = "select deal.t_id , deal.t_code code, deal.t_date dat, instr.t_fiid, fii.t_name fiid, pfi.t_optionstyle style, pfi.t_optiontype type, instr.t_issuer, part.t_shortname iussuer, "
        "     fii.t_fi_kind, fii.t_ccy ccy, deal.t_amount amount, deal.t_cost cost "
      "from   DDVDEAL_DBT deal, dfininstr_dbt instr, dfininstr_dbt fii, dfideriv_dbt pfi, dparty_dbt part "
      "where  deal.t_fiid = instr.t_fiid and instr.t_facevaluefi = fii.t_fiid and pfi.t_fiid = instr.t_fiid and instr.t_issuer = part.t_partyid "
      "and deal.t_date = :dt"; //MAA: iSupport - 522478

  sql = ExecSqlSelect(sql, makeArray(SqlParam("dt", repdate)), false); //MAA: iSupport - 522478

  count = 0;
  InitProgress(-1, "Построение");
  rn = rn + 1;
  while (sql.MoveNext())

    rn = rn + 1;
    csvFile.AddCell(sql.value("code"));
    csvFile.AddCell(sql.value("dat", null, V_DATE));
    csvFile.AddCell("");
    csvFile.AddCell("");
    csvFile.AddCell(sql.value("fiid"));
    csvFile.AddCell(sql.value("style"));
    csvFile.AddCell(sql.value("type"));
    csvFile.AddCell("");
    csvFile.AddCell(sql.value("iussuer"));
    csvFile.AddCell(sql.value("ccy"));
    csvFile.AddCell(sql.value("amount"));
    csvFile.AddCell(sql.value("cost"));
    csvFile.AddCell("");
    csvFile.AddCell("");
    csvFile.AddCell("");
    csvFile.AddCell("");
    csvFile.AddCell("");
    csvFile.AddCell("");
    csvFile.AddCell("");
    csvFile.AddRow(); 

  UseProgress(count = count + 1);
  end;
  RemProgress();

  csvFile.FileClose();
  csvTable.FillTabelFromCSV(csvFile.GetlsFileName());
  csvTable.EndTable();
  if(count > 0)
    Rep.CopyAllSheetInTotalBook(null, false, csvTable.GetTableRange(), 0, "template");
  end;
  Rep.Close();
  Rep.SaveTotalBook();

end;

f657_8();
exit(1);
