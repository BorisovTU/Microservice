import globals, or_rep_h, oralib, likepy, RSD, Календарь;
import  RsbFormsInter, SPInter,"spserv.mac";

const K_F2 = 316;
const K_F3 = 317;

var Rep, sql, cmd, rs;;
var repDate, p1Date, p2Date;

var repSource;
//получение портфеля
//select cls.t_name, VAL.T_NAME, val.t_element from dllclsval_dbt clv, dllclass_dbt cls, dllvalues_dbt val where CLV.T_CLASSIFICATOR = CLS.T_CLASSIFICATOR and clv.t_element = VAL.T_ELEMENT and val.t_list = clv.t_list  and clv.t_classificator = 1649;

//Переменные для варианта WindowsReports, поддерживающего POIReports
var csvFile, fName, csvTable, printEngine;
const SHEET_NAME = "F657_4";
const TEMPL_NAME = "Template_F657_4.xlsx";
const CSV_NAME   = "F657_4_csv.txt";

CLASS clF657_2 ()
var rn = 1;
var EXCEL_MONEY = "\"# ##0,00\"";
var sheet = 1;
var count = 0;
var head_format;

var col1_len = 12,
    col2_len = 7,
    col3_len = 18,
    col4_len = 8,  
    col5_len = 14,  
    col6_len = 15,
    col7_len = 15,   
    col8_len = 10,   
    col9_len = 14,
    col10_len = 12, 
    col11_len = 30, 
    col12_len = 15,
    col13_len = 10, 
    col14_len = 18, 
    col15_len = 30,
    col16_len = 15, 
    col17_len = 10;
var color  = 12632256;  
var ColorD = 16316664;
var ColorL = 15395562;

private macro ФорматСтроки(_fiid, _pFiid, _pRest)
  if(_fiid != _pFiid)
    if (color == colorL) 
       color = colorD;
    else 
       color = colorL;      
    end;  
  end;

  if (trim(_pRest) != "0" )
    return "ex_FS(b):ex_B(tblr):ex_BC(" + color + ")";
  else
    return "ex_FS():ex_B(tblr):ex_BC(" + color + ")";
  end;
end;

private macro FindACCandRest (_Fiid,_КУ,_BAl:@variant,_Acc:@variant,_Rest:@variant)

  var query = "  SELECT AC.T_BALANCE, " +
      "         ac.T_ACCOUNT, " +
      "         rsb_account.restall (mc.t_account,mc.t_chapter,mc.t_currency,SYSDATE)rest, " +
      "         mc.t_currency, " +
      "         RSB_FIINSTR.CONVSUM (rsb_account.restall (mc.t_account,mc.t_chapter,mc.t_currency,SYSDATE),mc.t_currency,0,SYSDATE)restnat " +
      "    FROM dfininstr_dbt fi, " +
      "         dmcaccdoc_dbt mc, " +
      "         Dmccateg_DBT cat, " +
      "         daccount_dbt ac " +
      "   WHERE RSI_RSB_FIInstr.FI_AvrKindsGetRoot (fi.t_fi_kind, fi.t_AvoirKind) = 17 " +
      "         AND fi.t_FIID = :Fiid " +
      "         AND MC.T_FIID(+) = fi.t_fiid " +
      "         AND cat.t_id = mc.t_catid " +
      "         AND cat.t_number = mc.t_catnum " +
      "         AND mc.t_account = ac.t_account " +
      "         AND mc.t_chapter = ac.t_chapter " +
      "         AND cat.t_Code = :KU  " +
      "GROUP BY fi.t_fiid,ac.t_account,mc.t_account,mc.t_chapter,mc.t_currency,AC.T_BALANCE " ;
  query = RsdCommand(query);
  query.addParam("Fiid"  , rsdbp_in , _Fiid );
  query.addParam("KU"  , rsdbp_in , _КУ );

  query = RSDRecordset(query, rsdval_client, rsdval_static);
  if(query.movenext())
    _Bal  = query.value("t_balance");
    _Acc  = query.value("t_account");
    _Rest = query.value("Rest");
  else
    _Bal  = "-----";
    _Acc  = "-----";
    _Rest = "-----";
  end;

end;

private macro ПечатьБлокаДанных(_rs);
  var format;
  var BAlAcc,Acc,RestAcc; 
  var PlacementDate;
  /*
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(11).NumberFormat = "+"\"# ##0,00\""+";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(12).NumberFormat = "+EXCEL_MONEY+";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(9).NumberFormat = "+EXCEL_MONEY+";");
  */
  while(_rs.movenext)
    FindACCandRest(_rs.value("t_fiid"),"Наш портфель ц/б",@BAlAcc,@Acc,@RestAcc);
    FindACCandRest(_rs.value("t_fiid"),"Наш портфель ц/б",@BAlAcc,@Acc,@RestAcc);

  /*1*/    csvFile.AddCell (_rs.value("t_definition"));
  /*2*/    csvFile.AddCell (BalAcc);
  /*3*/    csvFile.AddCell (Acc);
  /*4*/    csvFile.AddCell (_rs.value("facevalueccy"));
  /*5*/    csvFile.AddCell (_rs.value("t_isin"));
  /*6*/    csvFile.AddCell (string(date(_rs.value("t_firstdate")):f)); 
  /*7*/    csvFile.AddCell (string(date(_rs.value("T_DRAWINGDATE")):f));
  /*8*/    csvFile.AddCell (_rs.value("t_number"));
  /*9*/    csvFile.AddCell (_rs.value("T_INCOMERATE"));
  /*10*/   csvFile.AddCell (СуммаКупона(_rs.value("T_FIID"),1,_rs.value("T_DRAWINGDATE")));
  /*11*/   csvFile.AddCell (_rs.value("nominal"));
  /*12*/   csvFile.AddCell (_rs.value("sumAmount"));

    if ( date(_rs.value("t_PLACEMENTDATE")) != Date(0,0,0))
      PlacementDate = string(date(_rs.value("t_PLACEMENTDATE")):f);
    else
      PlacementDate = "Не определено";
    end;

  /*13*/   csvFile.AddCell (PlacementDate);
  /*14*/   csvFile.AddCell (string(date(_rs.value("t_fiDRAWINGDATE")):f));
  /*15*/   csvFile.AddCell (string(sql_convtypedate(_rs.value("t_dateoffer")):f));
  /*16*/   csvFile.AddCell (_rs.value("NKDBASE"));
      
    csvFile.AddRow();
  end;

  csvFile.FileClose();
  csvTable.FillTabelFromCSV(csvFile.GetlsFileName());
  csvTable.EndTable();

  printEngine.CopyAllSheetInTotalBook(null,         //Имя закладки,по умолчанию имя закладки из шаблона
                                    false, // true - на новый лист, false - на существующий(если имя листа отличается, всегда на новый лист)
                                    csvTable.GetTableRange(),     //Что копировать м.б. диапозон вида "A1:T60" или имя именованного диапозона
                                      0,
                                    SHEET_NAME) ;

end;

/*
  Инциализируем класс Отчёта
*/
macro initRep(templateName)
    printEngine=CTemplateXLS(NULL, NULL, NULL, NULL, NULL, NULL, true, false);

    if(printEngine.UsePoi())
      printEngine.SetXLSXFormat();
    end;

    printEngine.CreateTotalBook();

    InitProgress(-1, "", "");

    printEngine.OpenTemplate(templateName, true);
    printEngine.SheetChange(1);
   
end;

/*
  Показать окно отчёта
*/
macro showRep(FileName)
    printEngine.Close();
    printEngine.SaveTotalBook(FileName);
end;

macro run()

  initRep(TEMPL_NAME);

  printEngine.CopyAllSheetInTotalBook (null, false, "templateHeader", 0, SHEET_NAME);

  csvTable = printEngine.RegisterTable("tableRow", "tableHeader", true);
  csvFile = C_CSVFile();
  if (printEngine.UsePoi())
    csvFile.SetLimitRow(FLUSH_COUNT_XLSX);
  end;
  fName = csvFile.CreateFullFileName(CSV_NAME);
  csvFile.FileOpen(fName, true);

  SQL = "WITH mq " +
        "        AS (  SELECT v.t_fiid, " +
        "                     SUM (v.t_amount) sumAmount, " +
        "                     SUM (v.t_sum) SumS, " +
        "                     v.t_currency, " +
        "                     SUM (v.t_balancecost) sumBCost " +
        "                FROM v_scwrthistex2 v " +
        "               WHERE v.t_party = -1 AND v.t_state IN (1, 3) AND v.t_amount > 0 " +
        "                     AND v.t_instance = " +
        "                            (SELECT MAX (t.t_instance) " +
        "                               FROM v_scwrthistex t " +
        "                              WHERE v.t_sumid = t.t_sumid " +
        "                                    AND v.t_changedate = t.t_changedate) " +
        "                     AND v.t_changedate = " +
        "                            (SELECT MAX (tt.t_changedate) " +
        "                               FROM v_scwrthistex tt " +
        "                              WHERE v.t_sumid = tt.t_sumid " +
        "                                    AND tt.t_changedate <= :dt) " +
        "            GROUP BY v.t_fiid, v.t_currency) " +
        "  SELECT mq.t_fiid, " +
        "         fi.t_fi_code, " +
        "         fi.t_definition, " +
        "         fi.t_name, " +
        "         mq.sumAmount, " +
        "         mq.sumS, " +
        "         mq.t_currency, " +
        "         mq.sumBCost, " +
        "         obj.t_code, " +
        "         q1.t_numinlist, " +
        "         q1.t_name, " +
        "         q1.resproc, " +
        "         av.t_isin, " +
        "         (SELECT f1.t_ccy " +
        "            FROM dfininstr_dbt f1 " +
        "           WHERE f1.t_fiid = fi.T_FACEVALUEFI) " +
        "            FaceValueCCY, " +
        "          to_number(FW.T_NUMBER) T_NUMBER, " +
        "         fw.t_firstdate, " +
        "         FW.T_DRAWINGDATE, " +
        "         FW.T_INCOMERATE, " +
        "         RSB_FIINSTR.FI_GETNOMINALONDATE (fi.t_fiid, :dt1) nominal, " +
        "         case when AV.T_ENDPLACEMENTDATE = to_date( '01010001','ddmmyyyy') then av.t_BEGPLACEMENTDATE else av.t_ENDPLACEMENTDATE END   t_PLACEMENTDATE, "
        "         FI.T_DRAWINGDATE t_fiDRAWINGDATE, " +
        "         (SELECT T_SZNAMEALG FROM dnamealg_dbt WHERE T_ITYPEALG = 3108 AND T_INUMBERALG = AV.T_NKDBASE_KIND) NKDBASE," +
        "         (SELECT MIN(T_DATEREDEMPTION) OfferDate  FROM doffers_dbt  WHERE t_FIID = av.t_fiid AND T_DATEREDEMPTION > :dt2) t_dateoffer " +
        "      " +
        "    FROM mq " +
        "         LEFT JOIN dobjcode_dbt obj " +
        "            ON     obj.t_objectid = mq.T_FIID " +
        "               AND obj.t_objecttype = 9 " +
        "               AND obj.t_codekind = 11 " +
        "               AND obj.t_bankdate <= SYSDATE " +
        "               AND ( (obj.t_bankclosedate > SYSDATE) " +
        "                    OR (obj.t_bankclosedate = TO_DATE ('01010001', 'ddmmyyyy'))) " +
        "         LEFT JOIN (  SELECT TO_NUMBER (AtCor.t_Object) T_fiid, " +
        "                             Attr.t_NumInList, " +
        "                             attr.t_name, " +
        "                             pm_common. " +
        "                              GetNoteTextStr (TO_NUMBER (AtCor.t_Object), " +
        "                                              12, " +
        "                                              3, " +
        "                                              SYSDATE) " +
        "                                resProc " +
        "                        FROM dobjatcor_dbt AtCor, dobjattr_dbt Attr " +
        "                       WHERE     AtCor.t_ObjectType = 12 " +
        "                             AND AtCor.t_GroupID = 13 " +
        "                             AND Attr.t_AttrID = AtCor.t_AttrID " +
        "                             AND Attr.t_ObjectType = AtCor.t_ObjectType " +
        "                             AND Attr.t_GroupID = AtCor.t_GroupID " +
        "                    ORDER BY Attr.t_NumInList DESC) q1 " +
        "            ON q1.t_fiid = mq.t_fiid " +
        "         LEFT JOIN davoiriss_dbt av " +
        "            ON mq.t_fiid = av.t_fiid " +
        "         LEFT JOIN dfininstr_dbt fi " +
        "            ON mq.t_fiid = fi.t_fiid " +
        "         LEFT JOIN dfiwarnts_dbt fw " +
        "            ON     FW.T_FIID = AV.T_FIID " +
        "               AND fw.t_ispartial = CHR (0) " +
        "               AND FW.T_DRAWINGDATE BETWEEN :begdate AND :enddate " +
        "          LEFT JOIN DOFFERS_DBT offer on av.t_fiid = offer.t_fiid and  offer.T_DATEREDEMPTION >= :dt3 " +
        "         WHERE RSI_RSB_FIInstr.FI_AvrKindsGetRoot (fi.t_fi_kind, fi.t_AvoirKind) = 17 " +
        "         AND NOT fw.t_number IS NULL " +
        "ORDER BY FI.t_FIID,FW.T_DRAWINGDATE, FW.T_NUMBER " ;

    cmd = RSDCommand(sql);
    cmd.addParam("dt"  , rsdbp_in , repDate );
    cmd.addParam("dt1"  , rsdbp_in , repDate );
    cmd.addParam("dt2"  , rsdbp_in , repDate );
    cmd.addParam("begDate", rsdbp_in , p1Date );
    cmd.addParam("endDate"  , rsdbp_in , p2Date );
    cmd.NullConversion = true;

    cmd.addParam("dt3"  , rsdbp_in , repDate );
    rs = RSDRecordset(cmd, rsdval_client, rsdval_static);

    ПечатьБлокаДанных(rs);
    RemProgress();

    printEngine.SetAutoFilter(csvTable.GetTableRange(), SHEET_NAME);
    showRep("Report_F657_4");
  
  end;

END; // CLASS clF405

macro PnlProc(dlgPanel, cmd, id, key, numScroll)
  var CM_FLAG = CM_DEFAULT;

  if (cmd == DLG_INIT)
    repDate = p1Date = p2Date = {CurDate}; 
    dlgPanel.rec.repDate = dlgPanel.rec.startDate = dlgPanel.rec.endDate = {CurDate};
    
    UpdateFields(dlgPanel);
  elif(cmd==DLG_KEY)
//msgbox("key=" + key +"   " + "id="  + id);
    if (key ==K_F2)
      var f657_2 = clF657_2();
      repDate = dlgPanel.rec.repDate;
      p1Date = dlgPanel.rec.startDate;
      p2Date = dlgPanel.rec.endDate;
      begaction(100,"Сбор данных...");
      //UpdateFields(dlgPanel);
      f657_2.run;
      EndAction();
      msgbox("Отчет сформирован !");
    elif (key ==K_F3)
      if(id == 0)
        repDate = GetDateByCalendar({CurDate});
        dlgPanel.rec.repDate = repDate;
        UpdateFields(dlgPanel);

      elif(id == 1)
        p1Date = GetDateByCalendar({CurDate});
        if(p1Date < repDate)
        //  msgbox("Начало периода не может быть раньше даты отчета!");
        //  dlgPanel.rec.startDate = p1Date = repDate;
        dlgPanel.rec.startDate = p1Date;
        else
          dlgPanel.rec.startDate = p1Date;
        end;
        UpdateFields(dlgPanel);

      elif(id == 2)
        p2Date = GetDateByCalendar({CurDate});
        if(p2Date < p1Date)
          msgbox("Конец периода не может быть раньше начала периода!");
          dlgPanel.rec.endDate = p2Date = p1Date;
        else
          dlgPanel.rec.endDate = p2Date
        end;
        UpdateFields(dlgPanel);
     
      end;     
     //dlgPanel.rec.pDate = repdt;
       UpdateFields(dlgPanel);

    
    end;

  end;
  
end;

var pnl = tRecHandler("f657_4", "f657.lbr", true);
runDialog(pnl, @PnlProc);

exit(1);