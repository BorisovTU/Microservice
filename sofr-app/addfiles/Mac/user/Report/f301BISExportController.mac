/*
Эспорт расчетных данных формы 301 в файл формата БИСквит
ЧебанАА 18.09.2018
*/
import Globals, RcbCoreInter, ReptCBInter, BankInter, rsexts;

//класс данных для экспорта
class TDataStructForBIS
  var fileHeader,            //заголовок экспортного файла
      codeFromula=TArray,    //код формулы
      valRub_col=TArray,     //номер колонки значения в переменных 301 формы (рубли)
      valRub_row=TArray,     //номер строки значения в переменных 301 формы  (рубли)
      valCur_col=TArray,     //номер колонки значения в переменных 301 формы (валюта)
      valCur_row=TArray,     //номер строки значения в переменных 301 формы  (валюта)
      valueRub=TArray,       //значение показателя (рубли)
      valueCur=TArray,       //значение показателя (валюта)
      nameFormula=TArray;    //наименование формулы
end;


class TBISExportController()
    var exportData=TDataStructForBIS,
        dataBeginReport=ПредДатаОтчета,
        dataEndReport=ДатаОтчета;

    var Department="СОФР"; //код подразделения
    
    //получаем данные расчета формы 301
    private macro getDataFromForm301(col,row)
         var report = RcbApplication().currentReport; 
         var attributeValueIterator = report.attributeValue("ДанныеОтчета");      
         var valuaiterator = attributeValueIterator.createValueIterator();
         
             valuaiterator.movefirst;
             while (not valuaiterator.IsDone())
                   if ((valuaiterator.currentitem.fieldValue("row").scaled == row) and (valuaiterator.currentitem.fieldValue("column").scaled == col))
                       return valuaiterator.currentitem.fieldValue("value").scaled;
                   end;
                   valuaiterator.MoveNext(); 
             end;
             return 0; 
    end;

    //проверяем наличие файла экспорта
    private macro CheckFileExists(fullName)
      var UserChoice, DirList:TDirList=TDirList(fullName, "f");
          array itemChoice;
          array headMsg;
          itemChoice(0)="Перезаписать"; itemChoice(1)="Прервать";
          headMsg(0)="Файл " + fullName + " уже существует";

          if(DirList.Count>0)
            UserChoice=ConfWin(headMsg, itemChoice, 0);
            if(UserChoice == 1)
               return 1;
            end;
          end;
    end;

    //заголовок протокола экспорта
    private macro exportProtocolHeader()
        println("Форма 301");
        println("");
        println("ПРОТОКОЛ ЭКСПОРТА В БИСквит");
        println("");
        println("Период отчета с "+dataBeginReport+" по "+dataEndReport);
        println("Дата и время выпуска отчета "+date+" "+time);
        println("Исполнитель "+{oper});
        println("");
    end;


    //определяем параметры данных экспорта и заполяем класс данными расчета 301 формы
    macro initDataForExport()
       var i, val1;

          if (StrLen(Trim(String(dataBeginReport)))==9)
             dataBeginReport="0"+Trim(String(dataBeginReport));
          end;

          if (StrLen(Trim(String(dataEndReport)))==9)
             dataEndReport="0"+Trim(String(dataEndReport));
          end;

          exportData.fileHeader="\"OLAPDataBlock\" \"4.1D\" \"f301n\" \""+Department+"\" \""+StrSubst(String(dataEndReport),".","/")+"\" \""+StrSubst(String(dataEndReport),".","/")+"\" yes";

          exportData.codeFromula[0]="h301n_01_03";
          exportData.codeFromula[1]="h301n_01_04";
          exportData.codeFromula[2]="h301n_02_03";
          exportData.codeFromula[3]="h301n_02_04";
          exportData.codeFromula[4]="h301n_03_15";
          exportData.codeFromula[5]="h301n_04_21";
          exportData.codeFromula[6]="h301n_04_22";
          exportData.codeFromula[7]="h301n_04_28";
          exportData.codeFromula[8]="h301n_04_29";
          exportData.codeFromula[9]="h301n_05_21";
          exportData.codeFromula[10]="h301n_05_22";
          exportData.codeFromula[11]="h301n_05_29";
          exportData.codeFromula[12]="h301n_06_30";

          exportData.codeFromula[13]="h301n_07_33";
          exportData.codeFromula[14]="h301n_07_34";
          exportData.codeFromula[15]="h301n_07_35";
          exportData.codeFromula[16]="h301n_07_36";
          exportData.codeFromula[17]="h301n_08_33";
          exportData.codeFromula[18]="h301n_08_34";
          exportData.codeFromula[19]="h301n_08_35";
          exportData.codeFromula[20]="h301n_08_36";

          //row - номер строки отчета 301 формы, col - номер столбца отчета 301 формы
          //если параметр должен отсутствовать - устанавливаем col и row в 0
//Разделы 1, 2 зануляем, требование Банка.
/*
          exportData.valRub_col[0]=3; exportData.valRub_row[0]=1;        exportData.valCur_col[0]=8; exportData.valCur_row[0]=1;
          exportData.valRub_col[1]=4; exportData.valRub_row[1]=1;        exportData.valCur_col[1]=9; exportData.valCur_row[1]=1;
          exportData.valRub_col[2]=3; exportData.valRub_row[2]=2;        exportData.valCur_col[2]=8; exportData.valCur_row[2]=2;
          exportData.valRub_col[3]=4; exportData.valRub_row[3]=2;        exportData.valCur_col[3]=9; exportData.valCur_row[3]=2;
          exportData.valRub_col[4]=15; exportData.valRub_row[4]=3;        exportData.valCur_col[4]=0; exportData.valCur_row[4]=0;
          exportData.valRub_col[5]=21; exportData.valRub_row[5]=1;        exportData.valCur_col[5]=26; exportData.valCur_row[5]=1;
          exportData.valRub_col[6]=22; exportData.valRub_row[6]=1;        exportData.valCur_col[6]=27; exportData.valCur_row[6]=1;
          exportData.valRub_col[7]=28; exportData.valRub_row[7]=1;        exportData.valCur_col[7]=0; exportData.valCur_row[7]=0;
          exportData.valRub_col[8]=29; exportData.valRub_row[8]=1;        exportData.valCur_col[8]=0; exportData.valCur_row[8]=0;
          exportData.valRub_col[9]=21; exportData.valRub_row[9]=2;        exportData.valCur_col[9]=26; exportData.valCur_row[9]=2;
          exportData.valRub_col[10]=22; exportData.valRub_row[10]=2;      exportData.valCur_col[10]=27; exportData.valCur_row[10]=2;
          exportData.valRub_col[11]=29; exportData.valRub_row[11]=2;      exportData.valCur_col[11]=0; exportData.valCur_row[11]=0;
          exportData.valRub_col[12]=30; exportData.valRub_row[12]=3;      exportData.valCur_col[12]=0; exportData.valCur_row[12]=0;
*/

          exportData.valRub_col[0]=0; exportData.valRub_row[0]=0;        exportData.valCur_col[0]=0;   exportData.valCur_row[0]=0;
          exportData.valRub_col[1]=0; exportData.valRub_row[1]=0;        exportData.valCur_col[1]=0;   exportData.valCur_row[1]=0;
          exportData.valRub_col[2]=0; exportData.valRub_row[2]=0;        exportData.valCur_col[2]=0;   exportData.valCur_row[2]=0;
          exportData.valRub_col[3]=0; exportData.valRub_row[3]=0;        exportData.valCur_col[3]=0;   exportData.valCur_row[3]=0;
          exportData.valRub_col[4]=0; exportData.valRub_row[4]=0;       exportData.valCur_col[4]=0;   exportData.valCur_row[4]=0;
          exportData.valRub_col[5]=0; exportData.valRub_row[5]=0;       exportData.valCur_col[5]=0;  exportData.valCur_row[5]=0;
          exportData.valRub_col[6]=0; exportData.valRub_row[6]=0;       exportData.valCur_col[6]=0;  exportData.valCur_row[6]=0;
          exportData.valRub_col[7]=0; exportData.valRub_row[7]=0;       exportData.valCur_col[7]=0;   exportData.valCur_row[7]=0;
          exportData.valRub_col[8]=0; exportData.valRub_row[8]=0;       exportData.valCur_col[8]=0;   exportData.valCur_row[8]=0;
          exportData.valRub_col[9]=0; exportData.valRub_row[9]=0;       exportData.valCur_col[9]=0;  exportData.valCur_row[9]=0;
          exportData.valRub_col[10]=0; exportData.valRub_row[10]=0;     exportData.valCur_col[10]=0; exportData.valCur_row[10]=0;
          exportData.valRub_col[11]=0; exportData.valRub_row[11]=0;     exportData.valCur_col[11]=0;  exportData.valCur_row[11]=0;
          exportData.valRub_col[12]=0; exportData.valRub_row[12]=0;     exportData.valCur_col[12]=0;  exportData.valCur_row[12]=0;

          exportData.valRub_col[13]=33; exportData.valRub_row[13]=1;     exportData.valCur_col[13]=37;  exportData.valCur_row[13]=1;
          exportData.valRub_col[14]=34; exportData.valRub_row[14]=1;     exportData.valCur_col[14]=0;  exportData.valCur_row[14]=0;
          exportData.valRub_col[15]=35; exportData.valRub_row[15]=1;     exportData.valCur_col[15]=38;  exportData.valCur_row[15]=1;
          exportData.valRub_col[16]=36; exportData.valRub_row[16]=1;     exportData.valCur_col[16]=0;  exportData.valCur_row[16]=0;

          exportData.valRub_col[17]=33; exportData.valRub_row[17]=2;     exportData.valCur_col[17]=37;  exportData.valCur_row[17]=2;
          exportData.valRub_col[18]=34; exportData.valRub_row[18]=2;     exportData.valCur_col[18]=0;  exportData.valCur_row[18]=0;
          exportData.valRub_col[19]=35; exportData.valRub_row[19]=2;     exportData.valCur_col[19]=38;  exportData.valCur_row[19]=2;
          exportData.valRub_col[20]=36; exportData.valRub_row[20]=2;     exportData.valCur_col[20]=0;  exportData.valCur_row[20]=0;

          exportData.nameFormula[0]="Выборка~Обязательства КО до востребования перед нефинансовыми организациями~~~~~~~~~~~";
          exportData.nameFormula[1]="Выборка~Обязательства КО до востребования  перед физическими лицами~~~~~~~~~~~";
          exportData.nameFormula[2]="Выборка~Обязательства КО срочные перед нефинансовыми организациями~~~~~~~~~~~";
          exportData.nameFormula[3]="Выборка~Обязательства КО срочные перед физическими лицами~~~~~~~~~~~";
          exportData.nameFormula[4]="Выборка~Обязательства КО денежные средства~~~~~~~~~~~";
          exportData.nameFormula[5]="Выборка~Требования КО до года : неф.орг.~~~~~~~~~~~";
          exportData.nameFormula[6]="Выборка~Требования КО до года : физ.лиц~~~~~~~~~~~";
          exportData.nameFormula[7]="Выборка~Требования КО до года .: иностранные активы~~~~~~~~~~~";
          exportData.nameFormula[8]="Выборка~Требования КО до года .: иностранные пассивы~~~~~~~~~~~";
          exportData.nameFormula[9]="Выборка~Требования КО свыше 1 года . : неф.орг.~~~~~~~~~~~";
          exportData.nameFormula[10]="Выборка~Требования КО свыше 1 года . : физ.лиц~~~~~~~~~~~";
          exportData.nameFormula[11]="Выборка~Требования КО свыше 1 года иностранные пассивы~~~~~~~~~~~";
          exportData.nameFormula[12]="Выборка~Требования КО Собственные  средства КО за вычетом вложений в акции других КО~~~~~~~~~~~";

          exportData.nameFormula[13]="Выборка~(Гр.33,37) Межбанковские операции КО до года Обязательства перед : Кредитными организациями~~~~~~~~~~~";
          exportData.nameFormula[14]="Выборка~Межбанковские операции КО до года Обязательства перед Банком России~~~~~~~~~~~";
          exportData.nameFormula[15]="Выборка~(Гр.35,38)Межбанковские операции КО до года Требования к кредитным организациям -резидентам~~~~~~~~~~~";
          exportData.nameFormula[16]="Выборка~Межбанковские операции КО до года Требования к Банку России~~~~~~~~~~~";

          exportData.nameFormula[17]="Выборка~(Гр.33,37)Межбанковские операции КО Свыше года Обязательства перед : Кредитными организациями~~~~~~~~~~~";
          exportData.nameFormula[18]="Выборка~Межбанковские операции КО  Свыше  года Обязательства перед Банком России~~~~~~~~~~~";
          exportData.nameFormula[19]="Выборка~(Гр.35,38)Межбанковские операции КО  Свыше  года Требования к кредитным организациям -резидентам~~~~~~~~~~~";
          exportData.nameFormula[20]="Выборка~Межбанковские операции КО  Свыше  года Требования к Банку России~~~~~~~~~~~";

          //заполняем класс данных экспорта данными расчета 301 формы
          InitProgress (exportData.codeFromula.size, NULL, "Сбор данных из расчета 301 формы");
          for (i,0,exportData.codeFromula.size-1)
              exportData.valueRub[i]=Int(getDataFromForm301(exportData.valRub_col[i],exportData.valRub_row[i]));
              exportData.valueCur[i]=Int(getDataFromForm301(exportData.valCur_col[i],exportData.valCur_row[i]));
              UseProgress (i+1);
          end;
          RemProgress (i+1);

    end;

    //экспорт в файл
    macro saveDataToFile()
       var fPath, fName, fullName,
           day, mon, year, i;
          
          if (ПолучитьКаталогЭкспорта!="")
             fPath=StrSubst(ПолучитьКаталогЭкспорта,"\\","\\\\")+"\\\\";
          else
             msgbox("Не задан каталог экспорта файлов!!! || Меню Настройки->Параметры экспорта/импорта");
             println ("Не задан каталог экспорта файлов!!!");
             println ("Задайте его в меню подсистемы РеглОтч Настройки->Параметры экспорта/импорта");
             return 1;
          end;

          File fileID01 () txt write;
          
          DateSplit (date,day,mon,year);           
          fName="f301n_"+string(year)+string(mon)+string(day)+"."+Department;
          fullName=fPath+fName;
         
          if (CheckFileExists(fullName))
            println ("Файл экспорта уже существует: "+fullName);
            println ("Экспорт прерван пользователем!!!");
            return 1;
          end;
          
          open(fileID01,fullName,"rsoem",false,1);
          insert(fileID01,exportData.fileHeader);
          for (i,0,exportData.codeFromula.size-1)
              insert(fileID01,"\"f301n_01\" \""+exportData.codeFromula[i]+"\" \"\" \"\" "+exportData.valueRub[i]+" "+exportData.valueCur[i]+" "+
                    (exportData.valueRub[i]+exportData.valueCur[i])+" 0 0 0 0 0 0 0 0 0 \""+exportData.nameFormula[i]+"\"");
          end;
          insert(fileID01,".");
          close(fileID01);

          println ("Файл экспорта: "+fullName);
          println ("Количество выгруженных строк: "+(i+3));
    end;

    //проверить наличие расчета в текущей 301 форме
    macro checkCalcForm301()
      var report = RcbApplication().currentReport; 

          if (report.isCalculated==false)
             msgbox("Для запуска экспорта необходима расчитанная форма 301 || Выполните расчет формы 301 за "+dataBeginReport+" - "+dataEndReport+" период");
             exportProtocolHeader();
             println("Для запуска экспорта необходима расчитанная форма 301");
             println("Выполните расчет формы 301 за "+dataBeginReport+" - "+dataEndReport+" период");
             return 1;
          end;
          exportProtocolHeader();
          return 0;
    end;

end;

var clMain=TBISExportController();

if (clMain.checkCalcForm301()==0)
   clMain.initDataForExport();
   clMain.saveDataToFile();
end;
