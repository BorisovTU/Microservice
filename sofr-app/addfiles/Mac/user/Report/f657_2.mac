import globals, or_rep_h, oralib, likepy, RSD, Календарь;
import  RsbFormsInter, SPInter, "DlReport_h.mac";

private const V_SPECVAL = 26;
const K_F2 = 316;
const K_F3 = 317;


var Rep, sql, cmd, rs;;
var repDate, p1Date, p2Date;


var repSource;
//получение портфеля
//select cls.t_name, VAL.T_NAME, val.t_element from dllclsval_dbt clv, dllclass_dbt cls, dllvalues_dbt val where CLV.T_CLASSIFICATOR = CLS.T_CLASSIFICATOR and clv.t_element = VAL.T_ELEMENT and val.t_list = clv.t_list  and clv.t_classificator = 1649;

private class (DL_CReportTemplate) clF657_2_Report()
   MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
   END;

   macro BeginReport()
   end;

   private macro FindACCandRest (_Fiid,_КУ,_BAl:@variant,_Acc:@variant,_Rest:@variant)
      var query = "  SELECT AC.T_BALANCE, " +
          "         ac.T_ACCOUNT, " +
          "         rsb_account.restall (mc.t_account,mc.t_chapter,mc.t_currency,SYSDATE)rest, " +
          "         mc.t_currency, " +
          "         RSB_FIINSTR.CONVSUM (rsb_account.restall (mc.t_account,mc.t_chapter,mc.t_currency,SYSDATE),mc.t_currency,0,SYSDATE)restnat " +
          "    FROM dfininstr_dbt fi, " +
          "         dmcaccdoc_dbt mc, " +
          "         Dmccateg_DBT cat, " +
          "         daccount_dbt ac " +
          "   WHERE RSI_RSB_FIInstr.FI_AvrKindsGetRoot (fi.t_fi_kind, fi.t_AvoirKind) = 17 " +
          "         AND fi.t_FIID = :Fiid " +
          "         AND MC.T_FIID(+) = fi.t_fiid " +
          "         AND cat.t_id = mc.t_catid " +
          "         AND cat.t_number = mc.t_catnum " +
          "         AND mc.t_account = ac.t_account " +
          "         AND mc.t_chapter = ac.t_chapter " +
          "         AND cat.t_Code = :KU  " +
          "GROUP BY fi.t_fiid,ac.t_account,mc.t_account,mc.t_chapter,mc.t_currency,AC.T_BALANCE, mc.t_isUsable " +
          "ORDER BY mc.t_isUsable DESC, ABS(rest) DESC";
      query = RsdCommand(query);
      query.addParam("Fiid"  , rsdbp_in , _Fiid );
      query.addParam("KU"  , rsdbp_in , _КУ );

      query = RSDRecordset(query, rsdval_client, rsdval_static);
      if(query.movenext())
         _Bal  = query.value("t_balance");
         _Acc  = query.value("t_account");
         _Rest = query.value("Rest");
      else
         _Bal  = "-----";
         _Acc  = "-----";
         _Rest = "-----";
      end;
   end;

   macro Create()
      var BAlAcc, Acc, RestAcc, BAlAcc_res, Acc_res, RestAcc_res;
      var ExistData = true, num = 0;
      var A1 = "", A15 = "";

      InitProgress(-1, "Отбор данных", "Отбор данных");
      SetActiveSheet("F657_2");

      SQL = "WITH mq " +
      "        AS (  SELECT v.t_fiid, " +
      "                     SUM (v.t_amount) sumAmount, " +
      "                     SUM (v.t_sum) SumS, " +
      "                     v.t_currency, " +
      "                     SUM (v.t_balancecost) sumBCost " +
      "                FROM v_scwrthistex2 v " +
      "               WHERE v.t_party = -1 AND v.t_state IN (1, 3) AND v.t_amount > 0 " +
      "                     AND v.t_instance = " +
      "                            (SELECT MAX (t.t_instance) " +
      "                               FROM v_scwrthistex t " +
      "                              WHERE v.t_sumid = t.t_sumid " +
      "                                    AND v.t_changedate = t.t_changedate) " +
      "                     AND v.t_changedate = " +
      "                            (SELECT MAX (tt.t_changedate) " +
      "                               FROM v_scwrthistex tt " +
      "                              WHERE v.t_sumid = tt.t_sumid " +
      "                                    AND tt.t_changedate <= :dt) " +
      "            GROUP BY v.t_fiid, v.t_currency) " +
      "  SELECT mq.t_fiid, " +
      "         fi.t_fi_code, " +
      "         mq.sumAmount, " +
      "         mq.sumS, " +
      "         mq.t_currency, " +
      "         mq.sumBCost, " +
      "         obj.t_code, " +
      "         q1.t_numinlist, " +
      "         q1.t_name, " +
      "         q1.resproc, " +
      "         av.t_isin, " +
      "         (SELECT f1.t_ccy " +
      "            FROM dfininstr_dbt f1 " +
      "           WHERE f1.t_fiid = fi.T_FACEVALUEFI) " +
      "            FaceValueCCY, " +
      "         FW.T_NUMBER, " +
      "         fw.t_firstdate, " +
      "         FW.T_DRAWINGDATE, " +
      "         FW.T_INCOMERATE, " +
      "         RSB_FIINSTR.FI_GETNOMINALONDATE (fi.t_fiid, :dt1) nominal, " +
      "  (SELECT T_SZNAMEALG FROM dnamealg_dbt WHERE T_ITYPEALG = 3108 AND T_INUMBERALG = AV.T_NKDBASE_KIND) NKDBASE, " +
      "         count(1) over() as t_Count " +
      "    FROM mq " +
      "         LEFT JOIN dobjcode_dbt obj " +
      "            ON     obj.t_objectid = mq.T_FIID " +
      "               AND obj.t_objecttype = 9 " +
      "               AND obj.t_codekind = 11 " +
      "               AND obj.t_bankdate <= SYSDATE " +
      "               AND ( (obj.t_bankclosedate > SYSDATE) " +
      "                    OR (obj.t_bankclosedate = TO_DATE ('01010001', 'ddmmyyyy'))) " +
      "         LEFT JOIN (  SELECT TO_NUMBER (AtCor.t_Object) T_fiid, " +
      "                             Attr.t_NumInList, " +
      "                             attr.t_name, " +
      "                             pm_common. " +
      "                              GetNoteTextStr (TO_NUMBER (AtCor.t_Object), " +
      "                                              12, " +
      "                                              3, " +
      "                                              SYSDATE) " +
      "                                resProc " +
      "                        FROM dobjatcor_dbt AtCor, dobjattr_dbt Attr " +
      "                       WHERE     AtCor.t_ObjectType = 12 " +
      "                             AND AtCor.t_GroupID = 13 " +
      "                             AND Attr.t_AttrID = AtCor.t_AttrID " +
      "                             AND Attr.t_ObjectType = AtCor.t_ObjectType " +
      "                             AND Attr.t_GroupID = AtCor.t_GroupID " +
      "                    ORDER BY Attr.t_NumInList DESC) q1 " +
      "            ON q1.t_fiid = mq.t_fiid " +
      "         LEFT JOIN davoiriss_dbt av " +
      "            ON mq.t_fiid = av.t_fiid " +
      "         LEFT JOIN dfininstr_dbt fi " +
      "            ON mq.t_fiid = fi.t_fiid " +
      "         LEFT JOIN dfiwarnts_dbt fw " +
      "            ON     FW.T_FIID = AV.T_FIID " +
      "               AND fw.t_ispartial = CHR (0) " +
      "               AND FW.T_DRAWINGDATE BETWEEN :begdate AND :enddate " +
      "   WHERE RSI_RSB_FIInstr.FI_AvrKindsGetRoot (fi.t_fi_kind, fi.t_AvoirKind) = 17 " +
      "         AND NOT fw.t_number IS NULL " +
      " ORDER BY FW.T_DRAWINGDATE, FW.T_NUMBER " ;

      cmd = RSDCommand(sql);
      cmd.addParam("dt"  , rsdbp_in , repDate );
      cmd.addParam("dt1"  , rsdbp_in , repDate );
      cmd.addParam("begDate", rsdbp_in , p1Date );
      cmd.addParam("endDate"  , rsdbp_in , p2Date );

      rs = RSDRecordset(cmd, rsdval_client, rsdval_static);

      if(rs.MoveNext())
         RemProgress();
         InitProgress(Int(rs.value("t_Count")), "Печать отчета", "Печать отчета");

         RegisterTable("N1_MainTable", NULL,
                       "N1_A1",
                       "N1_A2",
                       "N1_A3",
                       "N1_A4",
                       "N1_A5",
                       "N1_A6",
                       "N1_A7",
                       "N1_A8",
                       "N1_A9",
                       "N1_A10",
                       "N1_A11",
                       "N1_A12",
                       "N1_A13",
                       "N1_A14",
                       "N1_A15",
                       "N1_A16");

         while(ExistData)
            FindACCandRest(rs.value("t_fiid"),"Наш портфель ц/б",@BAlAcc,@Acc,@RestAcc);
            FindACCandRest(rs.value("t_fiid"),"Резерв ц/б",@BAlAcc_res,@Acc_res,@RestAcc_res);

            if (ValType(rs.value("t_code")) != V_SPECVAL)
               A1 = rs.value("t_code");
            else
               A1 = "---";
            end;

            if(rs.value("resproc")!="")
               A15 = rs.value("resproc");
            else
               A15 = "-----";
            end;

            PrintTableLine("N1_A1", A1, NULL,
                           "N1_A2", BalAcc, NULL,
                           "N1_A3", Acc, NULL,
                           "N1_A4", rs.value("facevalueccy"), NULL,
                           "N1_A5", rs.value("t_isin"), NULL,
                           "N1_A6", string(date(rs.value("t_firstdate")):f), NULL,
                           "N1_A7", string(date(rs.value("T_DRAWINGDATE")):f), NULL,
                           "N1_A8", rs.value("t_number"), NULL,
                           "N1_A9", rs.value("T_INCOMERATE"), NULL,
                           "N1_A10", rs.value("nominal"), NULL,
                           "N1_A11", rs.value("sumAmount"), NULL,
                           "N1_A12", RestAcc_res, NULL,
                           "N1_A13", Acc_res, NULL,
                           "N1_A14", rs.value("t_name"), NULL,
                           "N1_A15", A15, NULL,
                           "N1_A16", rs.value("NKDBASE"), NULL);

            UseProgress(num = num + 1);
            ExistData = rs.MoveNext();
         end;

         EndTable();
         RemProgress();
      else
         PrintFormatString(NULL, "N1_NoData", "Нет данных для выполнения отчета");
         RemProgress();
      end;
   end;

   macro EndReport()
   end;

   initDL_CReportTemplate(NULL, "Report_clF657_2.xls", false, false, NULL, true);
end;

macro PnlProc(dlgPanel, cmd, id, key, numScroll)
  var CM_FLAG = CM_DEFAULT;

  if (cmd == DLG_INIT)
    repDate = p1Date = p2Date = {CurDate}; 
    dlgPanel.rec.repDate = dlgPanel.rec.startDate = dlgPanel.rec.endDate = {CurDate};
    
    UpdateFields(dlgPanel);
  elif(cmd==DLG_KEY)
    if (key ==K_F2)
      repDate = dlgPanel.rec.repDate;
      p1Date = dlgPanel.rec.startDate;
      p2Date = dlgPanel.rec.endDate;
      clF657_2_Report().Run();
    elif (key ==K_F3)
      if(id == 0)
        repDate = GetDateByCalendar({CurDate});
        dlgPanel.rec.repDate = repDate;
        UpdateFields(dlgPanel);

      elif(id == 1)
        p1Date = GetDateByCalendar({CurDate});
        if(p1Date < repDate)
        //  msgbox("Начало периода не может быть раньше даты отчета!");
        //  dlgPanel.rec.startDate = p1Date = repDate;
        dlgPanel.rec.startDate = p1Date;
        else
          dlgPanel.rec.startDate = p1Date;
        end;
        UpdateFields(dlgPanel);

      elif(id == 2)
        p2Date = GetDateByCalendar({CurDate});
        if(p2Date < p1Date)
          msgbox("Конец периода не может быть раньше начала периода!");
          dlgPanel.rec.endDate = p2Date = p1Date;
        else
          dlgPanel.rec.endDate = p2Date
        end;
        UpdateFields(dlgPanel);
      end;     
     //dlgPanel.rec.pDate = repdt;
       UpdateFields(dlgPanel);
    end;
  end;
end;



var pnl = tRecHandler("f657_2", "f657.lbr", true);
runDialog(pnl, @PnlProc);

exit(1);