/*
$Name:        repreclots.mac
$Module:      Ценные бумаги
$Description: Отчет "Сверка параметров лотов с данными бухгалтерского учета"
*/

import "repreclots_form.mac", "spRepFn2.mac", "globals.mac","dlmisc.mac";

file TempFile( "repporst.tmp" ) write;
var RepDate  = {curdate};
var RepDateStr;
var BegDate  = date("01.01.2019");

PRIVATE CONST DEBUG_TMP_TABLE       = TRUE;

var tmp_table = "DMsfo7_TMP";
if (DEBUG_TMP_TABLE)
   tmp_table = "DMsfo7_DBT";
end;


Private Macro GetBegDate(RepDate)

var day, mon, year, BegDate;
   datesplit( RepDate, day, mon, year );
   BegDate = date("01."+"01."+year);
   return BegDate;
End;


private macro date_as_string( form_num, _date, ShortYFormat )
     var day,mon,year,sep_ch,res = "";
     _date = SQL_ConvTypeDate(_date);
     if(( ValType(_date) != V_UNDEF ) AND (_date != date(0,0,0)))
        datesplit( date(_date), day, mon, year );
        if ( form_num == 1 ) sep_ch = ".";
        elif ( form_num = 2 ) sep_ch = "/";
        else sep_ch = "-";
        end;
        if ( day != 0 )
             res = L_Z(string(day:2),2) + sep_ch;
        else
             res = "  " + sep_ch;
        end;

        if ( mon != 0 )
             res = res + L_Z(string(mon:2),2) + sep_ch;
        else
             res = res + "  " + sep_ch;
        end;

        if( valtype(ShortYFormat) != v_undef )
             ShortYFormat = true;
        end;

        if ( year != 0 )
             if( ShortYFormat )
                  year = year - Int( year / 100 ) * 100;
                  res = res + L_Z(string(year:2),2);
             else
                  res = res + L_Z(string(year:4),4);
             end;
        else
             res = res + IIF( ShortYFormat, "  ", "    " );
        end;
     end;
     return res;
end;



private const StatLine = "Выпуск отчета \"Мсфо7\"";

/* Данные одной строки отчета. */
class TLineSummary
   var
      FIID,                 
      AvrName,              
      AvrType,              
      ISIN,                 
      portfaccount,
      BegPortfCode,
      BegPortfCost,
      BegYNKD, 
      BegBonusCost,
      BegNKD, 
      BegDiscount, 

      PrevYearCost, 
      PrevYnkd, 
      PrevIncome, 
      PrevDiscount, 
      PrevBonus, 
      BegOvervalue, 
      OverMsfo, 
      BegInttoeir, 
      BegItog,
 
      BuyCost, 
      BuyYnkd, 
      BuyBonus, 
      BuyDiscount, 

      ReclCost, 
      ReclYnkd, 
      ReclBonus, 
      ReclIncome, 
      ReclDiscount, 
      ReclOvervalue, 

      ToDUCost, 
      ToDUYnkd, 
      ToDUBonus, 
      ToDUIncome, 
      ToDUDiscount, 
      ToDUOvervalue, 

      FromDUCost, 
      FromDUYnkd, 
      FromDUBonus, 
      FromDUIncome, 
      FromDUDiscount, 
      FromDUOvervalue, 

      PeriodIncome, 
      PeriodDiscount,
      PeriodDrawYnkd, 
      PeriodDrawIncome, 
      PeriodDrawDiscount, 
      PeriodBonus,
      PeriodOvervalue, 
      EndOvervalueMsfo, 

      ObescCost, 
      ObescYnkd, 
      ObescBonus, 
      ObescIncome, 
      ObescDiscount, 
      ObescOvervalue, 

      SaleFinRez, 
      SaleCost,
      SaleYnkd, 
      SaleDiscount, 
      SaleIncome, 
      SaleBonus, 
      SaleOvervalue,
      SaleEps,

      EndPortf, 
      EndCost, 
      EndYnkd, 
      EndBonus, 
      EndIncome, 
      EndDiscount, 

      ValOverCost, 
      ValOverYnkd, 
      ValOverIncome, 
      ValOverDiscount, 
      ValOverBonus, 

      EndOvervalue, 
      DoocMsfo,
      EndInttoeir, 
      EndItog;

      record AccBuff(account);



   macro ClearSum()

      FIID			 = 0;                 
      AvrName 			 = "";
      AvrType                    = "";
      ISIN                       = "";
      portfaccount               = "";
      BegPortfCode               = "";
      BegPortfCost               = $0;
      BegYNKD                    = $0;
      BegBonusCost               = $0;
      BegNKD                     = $0;
      BegDiscount                = $0;
      PrevYearCost               = $0;
      PrevYnkd                   = $0;
      PrevIncome                 = $0;
      PrevDiscount               = $0;
      PrevBonus                  = $0;
      BegOvervalue               = $0;
      OverMsfo                   = "";
      BegInttoeir                = $0;
      BegItog                    = $0;
      BuyCost                    = $0;
      BuyYnkd                    = $0;
      BuyBonus                   = $0;
      BuyDiscount                = $0;
      ReclCost                   = $0;
      ReclYnkd                   = $0;
      ReclBonus                  = $0;
      ReclIncome                 = $0;
      ReclDiscount               = $0;
      ReclOvervalue              = $0;

      ToDUCost                   = $0;
      ToDUYnkd                   = $0;
      ToDUBonus                  = $0;
      ToDUIncome                 = $0;
      ToDUDiscount               = $0;
      ToDUOvervalue              = $0;

      FromDUCost                 = $0;
      FromDUYnkd                 = $0;
      FromDUBonus                = $0;
      FromDUIncome               = $0;
      FromDUDiscount             = $0;
      FromDUOvervalue            = $0;

      PeriodIncome               = $0;
      PeriodDiscount             = $0;
      PeriodDrawYnkd             = $0;
      PeriodDrawIncome           = $0;
      PeriodDrawDiscount         = $0;
      PeriodBonus                = $0;
      PeriodOvervalue            = $0;
      EndOvervalueMsfo           = $0;

      ObescCost                  = $0;
      ObescYnkd                  = $0;
      ObescBonus                 = $0;
      ObescIncome                = $0;
      ObescDiscount              = $0;
      ObescOvervalue             = $0;

      SaleFinRez                 = $0;
      SaleCost                   = $0;
      SaleYnkd                   = $0;
      SaleDiscount               = $0;
      SaleIncome                 = $0;
      SaleBonus                  = $0;
      SaleOvervalue              = $0;
      SaleEps                    = $0;

      EndPortf                   = "";
      EndCost                    = $0;
      EndYnkd                    = $0;
      EndBonus                   = $0;
      EndIncome                  = $0;
      EndDiscount                = $0;

      ValOverCost                = $0;
      ValOverYnkd                = $0;
      ValOverIncome              = $0;
      ValOverDiscount            = $0;
      ValOverBonus               = $0;

      EndOvervalue               = $0;
      DoocMsfo                   = $0;
      EndInttoeir                = $0;
      EndItog                    = $0;
   end;


   /* Конструктор */
   ClearSum();
end;

PRIVATE CLASS CRecMsfo7( Report:OBJECT )
  VAR m_Report = Report;

  MACRO BeginReport()

     m_Report.PrintFormatString( "", "N1_Title1", "На " + string(BegDate) + "(входящие остатки)"  );
     m_Report.PrintFormatString( "", "N1_Title2", "На " + string(RepDateStr) + "(исходящий остаток)"  );

     m_Report.PrintFormatString( "", "N1_Portf1", "Портфель на " + string(BegDate) + " (1, 1б, 2, 2_собств, 3)"  );


     m_Report.PrintFormatString( "", "N1_Val1", "Вал. переоценка до " + string(BegDate) + " - в части номинала"  );
     m_Report.PrintFormatString( "", "N1_Val2", "Вал. переоценка до " + string(BegDate) + " - в части УНКД"  );
     m_Report.PrintFormatString( "", "N1_Val3", "Вал. переоценка до " + string(BegDate) + " - в части КД"  );
     m_Report.PrintFormatString( "", "N1_Val4", "Вал. переоценка до " + string(BegDate) + " - в части дисконта"  );
     m_Report.PrintFormatString( "", "N1_Val5", "Вал. переоценка до " + string(BegDate) + " - в части Премии"  );

     m_Report.PrintFormatString( "", "N1_Itog1", "ИТОГО на " + string(BegDate) + " МСФО"  );

     m_Report.PrintFormatString( "", "N1_Dooc1", "Дооценка ЦБ по МСФО на " + string(RepDateStr));

     m_Report.PrintFormatString( "", "N1_Portf2", "Портфель на " + string(RepDateStr) + " (1, 1б, 2, 2_собств, 3)"  );


     m_Report.PrintFormatString( "", "N1_Val6", "Вал. переоценка до " + string(RepDateStr) + " - в части номинала"  );
     m_Report.PrintFormatString( "", "N1_Val7", "Вал. переоценка до " + string(RepDateStr) + " - в части УНКД"  );
     m_Report.PrintFormatString( "", "N1_Val8", "Вал. переоценка до " + string(RepDateStr) + " - в части КД"  );
     m_Report.PrintFormatString( "", "N1_Val9", "Вал. переоценка до " + string(RepDateStr) + " - в части дисконта"  );
     m_Report.PrintFormatString( "", "N1_Val10", "Вал. переоценка до " + string(RepDateStr) + " - в части Премии"  );

     m_Report.PrintFormatString( "", "N1_Itog2", "ИТОГО на " + string(RepDateStr) + " МСФО"  );
     
     m_Report.RegisterTable( "N1_MainTable", "",
                             "N1_AvrName", 
                             "N1_AvrType", 
                             "N1_ISIN",  
                             "N1_BegPortfCode", 
                             "N1_BegPortfCost", 
                             "N1_BegYNKD", 
                             "N1_BegBonusCost", 
                             "N1_BegNKD", 
                             "N1_BegDiscount", 
                             "N1_PrevYearCost",
                             "N1_PrevYnkd",
                             "N1_PrevIncome",
                             "N1_PrevDiscount",
                             "N1_PrevBonus",
                             "N1_BegOvervalue", 
                             "N1_OverMsfo", 
                             "N1_BegInttoeir",
                             "N1_BegItog",

                             "N1_BuyCost",
                             "N1_BuyYnkd",
                             "N1_BuyBonus",
                             "N1_BuyDiscount",
                             "N1_BuyCorr",

                             "N1_ReclCost",
                             "N1_ReclYncd",
                             "N1_ReclBonus",
                             "N1_ReclIncome",
                             "N1_ReclDiscount",
                             "N1_ReclOvervalue",
                             "N1_ReclCorr",

                             "N1_ToDUCost",
                             "N1_ToDUYncd",
                             "N1_ToDUBonus",
                             "N1_ToDUIncome",
                             "N1_ToDUDiscount",
                             "N1_ToDUOvervalue",
                             "N1_ToDUCorr",

                             "N1_FromDUCost",
                             "N1_FromDUYncd",
                             "N1_FromDUBonus",
                             "N1_FromDUIncome",
                             "N1_FromDUDiscount",
                             "N1_FromDUOvervalue",
                             "N1_FromDUCorr",

                             "N1_PeriodIncome",
                             "N1_PeriodDiscount",
                             "N1_PeriodDrawYnkd",
                             "N1_PeriodDrawIncome",
                             "N1_PeriodDrawDiscount",
                             "N1_PeriodBonus",
                             "N1_PeriodOvervalue",
                             "N1_EndOvervalueMsfo",

                             "N1_ObescCost",
                             "N1_ObescYnkd",
                             "N1_ObescBonus",
                             "N1_ObescIncome",
                             "N1_ObescDiscount",
                             "N1_ObescOvervalue",
                             "N1_ObescCorr",

                             "N1_SaleFinRez",
                             "N1_SaleCost",
                             "N1_SaleYnkd",
                             "N1_SaleDiscount",
                             "N1_SaleIncome",
                             "N1_SaleBonus",
                             "N1_SaleOvervalue",
                             "N1_SaleCorr",

                             "N1_EndPortf",
                             "N1_EndCost",
                             "N1_EndYnkd",
                             "N1_EndBonus",
                             "N1_EndIncome",
                             "N1_EndDiscount",

                             "N1_ValOverCost",
                             "N1_ValOverYnkd",
                             "N1_ValOverIncome",
                             "N1_ValOverDiscount",
                             "N1_ValOverBonus",
                             "N1_EndOvervalue",
                             "N1_DoocMsfo",
                             "N1_EndInttoeir",
                             "N1_EndItog"
                          );
         
  END;

  MACRO PrintTableLine()
      m_Report.PrintTableLine( "N1_AvrName",        	m_Report.AvrName(),          	     	null,
                               "N1_AvrType",        	m_Report.AvrType(),              	null,
                               "N1_ISIN",           	m_Report.ISIN(),     		     	null,
                               "N1_BegPortfCode",   	m_Report.BegPortfCode(),                null,
                               "N1_BegPortfCost",   	m_Report.BegPortfCost(),                null,
                               "N1_BegYNKD",        	m_Report.BegYNKD(),                     null,
                               "N1_BegBonusCost",   	m_Report.BegBonusCost(),                null,
                               "N1_BegNKD",         	m_Report.BegNKD(),          	    	null,
                               "N1_BegDiscount",    	m_Report.BegDiscount(),                 null,
                               "N1_PrevYearCost",   	m_Report.PrevYearCost(),                null,
                               "N1_PrevYnkd",       	m_Report.PrevYnkd(),                    null,
                               "N1_PrevIncome",     	m_Report.PrevIncome(),            	null,
                               "N1_PrevDiscount",   	m_Report.PrevDiscount(),                null,
                               "N1_PrevBonus",      	m_Report.PrevBonus(),            	null,
                               "N1_BegOvervalue",   	m_Report.BegOvervalue(),                null,
                               "N1_OverMsfo",       	m_Report.OverMsfo(),                    null,
                               "N1_BegInttoeir",    	m_Report.BegInttoeir(),                 null,
                               "N1_BegItog",        	m_Report.BegItog(),             	null,
                               "N1_BuyCost", 	    	m_Report.BuyCost(),         	     	null,
                               "N1_BuyYnkd",        	m_Report.BuyYnkd(),         	     	null,
                               "N1_BuyBonus",      	m_Report.BuyBonus(),           	     	null,
                               "N1_BuyDiscount",    	m_Report.BuyDiscount(),                 null,
                               "N1_BuyCorr",    	" ",                                    null,
                               "N1_ReclCost",       	m_Report.ReclCost(),         	     	null,
                               "N1_ReclYncd",       	m_Report.ReclYnkd(),     		null,
                               "N1_ReclBonus",      	m_Report.ReclBonus(),     		null,
                               "N1_ReclIncome",     	m_Report.ReclIncome(),       	     	null,
                               "N1_ReclDiscount",   	m_Report.ReclDiscount(),                null,
                               "N1_ReclOvervalue",  	m_Report.ReclOvervalue(),               null,
                               "N1_RecCorr",    	" ",                                    null,
                               "N1_ToDUCost",       	m_Report.ToDUCost(),   		     	null,
                               "N1_ToDUYncd",       	m_Report.ToDUYnkd(),         	     	null,
                               "N1_ToDUBonus",      	m_Report.ToDUBonus(),           	null,
                               "N1_ToDUIncome",     	m_Report.ToDUIncome(),                  null,
                               "N1_ToDUDiscount",   	m_Report.ToDUDiscount(),          	null,
                               "N1_ToDUOvervalue",  	m_Report.ToDUOvervalue(), 		null,
                               "N1_TiDUCorr",    	" ",                                    null,
                               "N1_FromDUCost",     	m_Report.FromDUCost(),      	     	null,
                               "N1_FromDUYncd",     	m_Report.FromDUYnkd(), 	             	null,
                               "N1_FromDUBonus",    	m_Report.FromDUBonus(),   	        null,
                               "N1_FromDUIncome",   	m_Report.FromDUIncome(),                null,
                               "N1_FromDUDiscount", 	m_Report.FromDUDiscount(),              null,
                               "N1_FromDUOvervalue",	m_Report.FromDUOvervalue(),             null,
                               "N1_FromDUCorr",    	" ",                                    null,
                               "N1_PeriodIncome",   	m_Report.PeriodIncome(),                null,
                               "N1_PeriodDiscount", 	m_Report.PeriodDiscount(),              null,
                               "N1_PeriodDrawYnkd", 	m_Report.PeriodDrawYnkd(),              null,
                               "N1_PeriodDrawIncome",	m_Report.PeriodDrawIncome(),            null,
                               "N1_PeriodDrawDiscount", m_Report.PeriodDrawDiscount(),          null,
                               "N1_PeriodBonus", 	m_Report.PeriodBonus(),                 null,
                               "N1_PeriodOvervalue",    m_Report.PeriodOvervalue(),             null,
                               "N1_EndOvervalueMsfo",   m_Report.EndOvervalueMsfo(),            null,
                               "N1_ObescCost", 		m_Report.ObescCost(),         		null,
                               "N1_ObescYnkd", 		m_Report.ObescYnkd(),     		null,
                               "N1_ObescBonus", 	m_Report.ObescBonus(),     		null,
                               "N1_ObescIncome", 	m_Report.ObescIncome(),       		null,
                               "N1_ObescDiscount", 	m_Report.ObescDiscount(),        	null,
                               "N1_ObescOvervalue",     m_Report.ObescOvervalue(),     		null,
                               "N1_ObescCorr",    	" ",                                    null,
                               "N1_SaleFinRez", 	m_Report.SaleFinRez(), 			null,
                               "N1_SaleCost", 		m_Report.SaleCost(), 			null,
                               "N1_SaleYnkd", 		m_Report.SaleYnkd(),   			null,
                               "N1_SaleDiscount", 	m_Report.SaleDiscount(),     		null,
                               "N1_SaleIncome", 	m_Report.SaleIncome(),     		null,
                               "N1_SaleBonus", 		m_Report.SaleBonus(), 			null,
                               "N1_SaleOvervalue", 	m_Report.SaleOvervalue(), 		null,
                               "N1_SaleCorr",    	m_Report.Saleeps(),                     null,
                               "N1_EndPortf", 		m_Report.EndPortf(),   			null,
                               "N1_EndCost", 		m_Report.EndCost(),     		null,
                               "N1_EndYnkd", 		m_Report.EndYnkd(),     		null,
                               "N1_EndBonus", 		m_Report.EndBonus(), 			null,
                               "N1_EndIncome", 		m_Report.EndIncome(), 			null,
                               "N1_EndDiscount", 	m_Report.EndDiscount(),     		null,
                               "N1_ValOverCost", 	m_Report.ValOverCost(), 		null,
                               "N1_ValOverYnkd", 	m_Report.ValOverYnkd(), 		null,
                               "N1_ValOverIncome", 	m_Report.ValOverIncome(), 		null,
                               "N1_ValOverDiscount",    m_Report.ValOverDiscount(), 		null,
                               "N1_ValOverBonus", 	m_Report.ValOverBonus(), 		null,
                               "N1_EndOvervalue", 	m_Report.EndOvervalue(), 		null,
                               "N1_DoocMsfo", 		m_Report.DoocMsfo(), 			null,
                               "N1_EndInttoeir", 	m_Report.EndInttoeir(), 		null,
                               "N1_EndItog", 		m_Report.EndItog(),   			null
                             );
  END;                                                                                                                                                                         

  MACRO PrintHeadLine(HeadLine:string)
      m_Report.merge( "N1_A1", "N1_A54" );
      m_Report.PrintTableLine( "N1_A1",  HeadLine, null)
  END;                                                                                                                                                                         

  MACRO EndReport();
     m_Report.EndTable();
//     m_Report.AddStandardFooter( "N1_" );
  END;         

END;

PRIVATE CLASS (DL_CReportTemplate) SP_Msfo7_Report
  var fininstr    = TRecHandler( "fininstr" );
  var WasCollectedData = false;
  var LineSumm = TLineSummary();
  var m_PrevPortf, m_PrevIsQouted, m_PrevFiid, m_PrevAccount;
  var m_H1, m_H2;

  PRIVATE MACRO PrintMode():INTEGER/*печатаем только в Excel, тк выбора нет*/
     return DL_OUTREPORT_EXCEL;
  END;                                                                                                                                                                         

   macro ConvertToRUB(p_account, p_rest)
       var rs, cmd, query, SumInNatCur, valstr, valnum;
       if (strlen(p_account) == 20 )
			valstr = substr(p_account, 6,3);
			if (valstr == "810") 
				return p_rest;
			elif  (valstr == "840") 
				valnum = 7;
			elif  (valstr == "978") 
				valnum = 8;
		 	else msgbox(valstr);
			end;
			SmartConvertSum(SumInNatCur, money(p_rest), RepDate, valnum, NATCUR, true);
			return SumInNatCur;
       end;
       onerror 
       return "";
   end;




  PRIVATE MACRO FillBegData(AvrLine)

           LineSumm.AvrName     	= AvrLine.AvrName;
           LineSumm.AvrType    		= AvrLine.AvrType;
           LineSumm.ISIN        	= AvrLine.ISIN;
           LineSumm.BegPortfCode        = AvrLine.BegPortfCode;
           LineSumm.BegPortfCost  	= AvrLine.BegPortfCost;
           LineSumm.BegYNKD  		= AvrLine.BegYNKD;
           LineSumm.BegNKD  		= AvrLine.BegNKD;

           LineSumm.portfaccount        = AvrLine.portfaccount;

           LineSumm.BegBonusCost 	= AvrLine.BegBonusCost;
           LineSumm.BegDiscount  	= AvrLine.BegDiscount;
           LineSumm.BegOvervalue  	= AvrLine.BegOvervalue;
           LineSumm.OverMsfo  		= AvrLine.OverMsfo;

           LineSumm.PrevYearCost  	= AvrLine.PrevYearCost;
           LineSumm.PrevYnkd  		= AvrLine.PrevYnkd;
           LineSumm.PrevIncome 		= AvrLine.PrevIncome;
           LineSumm.PrevDiscount  	= AvrLine.PrevDiscount;

           LineSumm.PrevBonus  		= AvrLine.PrevBonus;
           LineSumm.BegOvervalue	= AvrLine.BegOvervalue;
           LineSumm.OverMsfo		= AvrLine.OverMsfo;
           LineSumm.BegInttoeir		= AvrLine.BegInttoeir; 
           LineSumm.BegItog		= AvrLine.BegItog;

           LineSumm.BuyCost		= AvrLine.BuyCost; 
           LineSumm.BuyYnkd		= AvrLine.BuyYnkd; 
           LineSumm.BuyBonus		= AvrLine.BuyBonus; 
           LineSumm.BuyDiscount		= AvrLine.BuyDiscount; 

           LineSumm.ReclCost		= AvrLine.ReclCost;  
           LineSumm.ReclYnkd		= AvrLine.ReclYnkd;  
           LineSumm.ReclBonus		= AvrLine.ReclBonus;  
           LineSumm.ReclIncome		= AvrLine.ReclIncome;  
           LineSumm.ReclDiscount	= AvrLine.ReclDiscount;  
           LineSumm.ReclOvervalue	= AvrLine.ReclOvervalue;  

           LineSumm.ToDUCost		= AvrLine.ToDUCost;  
           LineSumm.ToDUYnkd		= AvrLine.ToDUYnkd;  
           LineSumm.ToDUBonus		= AvrLine.ToDUBonus;  
           LineSumm.ToDUIncome		= AvrLine.ToDUIncome;  
           LineSumm.ToDUDiscount	= AvrLine.ToDUDiscount;  
           LineSumm.ToDUOvervalue	= AvrLine.ToDUOvervalue;  

           LineSumm.FromDUCost		= AvrLine.FromDUCost;   
           LineSumm.FromDUYnkd		= AvrLine.FromDUYnkd;   
           LineSumm.FromDUBonus		= AvrLine.FromDUBonus;   
           LineSumm.FromDUIncome	= AvrLine.FromDUIncome;   
           LineSumm.FromDUDiscount	= AvrLine.FromDUDiscount;   
           LineSumm.FromDUOvervalue	= AvrLine.FromDUOvervalue;   

           LineSumm.PeriodIncome	= AvrLine.PeriodIncome;    
           LineSumm.PeriodDiscount	= AvrLine.PeriodDiscount;   
           LineSumm.PeriodDrawYnkd	= AvrLine.PeriodDrawYnkd;    
           LineSumm.PeriodDrawIncome	= AvrLine.PeriodDrawIncome;    
           LineSumm.PeriodDrawDiscount	= AvrLine.PeriodDrawDiscount;    
           LineSumm.PeriodBonus		= AvrLine.PeriodBonus;   
           LineSumm.PeriodOvervalue	= AvrLine.PeriodOvervalue;    
           LineSumm.EndOvervalueMsfo	= AvrLine.EndOvervalueMsfo;    

           LineSumm.ObescCost		= AvrLine.ObescCost; 
           LineSumm.ObescYnkd		= AvrLine.ObescYnkd; 
           LineSumm.ObescBonus		= AvrLine.ObescBonus; 
           LineSumm.ObescIncome		= AvrLine.ObescIncome; 
           LineSumm.ObescDiscount	= AvrLine.ObescDiscount; 
           LineSumm.ObescOvervalue	= AvrLine.ObescOvervalue; 

           LineSumm.SaleFinRez		= AvrLine.SaleFinRez; 
           LineSumm.SaleCost		= AvrLine.SaleCost;
           LineSumm.SaleYnkd		= AvrLine.SaleYnkd; 
           LineSumm.SaleDiscount	= AvrLine.SaleDiscount; 
           LineSumm.SaleIncome		= AvrLine.SaleIncome; 
           LineSumm.SaleBonus		= AvrLine.SaleBonus; 
           LineSumm.SaleOvervalue	= AvrLine.SaleOvervalue;
           LineSumm.SaleEps     	= AvrLine.SaleEps;


           LineSumm.EndPortf		= AvrLine.EndPortf;  
           LineSumm.EndCost		= AvrLine.EndCost;  
           LineSumm.EndYnkd		= AvrLine.EndYnkd;  
           LineSumm.EndBonus		= AvrLine.EndBonus;  
           LineSumm.EndIncome		= AvrLine.EndIncome;  
           LineSumm.EndDiscount		= AvrLine.EndDiscount;  

           LineSumm.ValOverCost		= AvrLine.ValOverCost;  
           LineSumm.ValOverYnkd		= AvrLine.ValOverYnkd;  
           LineSumm.ValOverIncome	= AvrLine.ValOverIncome;  
           LineSumm.ValOverDiscount	= AvrLine.ValOverDiscount;  
           LineSumm.ValOverBonus	= AvrLine.ValOverBonus;  

           LineSumm.EndOvervalue	= AvrLine.EndOvervalue;  
           LineSumm.DoocMsfo		= AvrLine.DoocMsfo; 
           LineSumm.EndInttoeir		= AvrLine.EndInttoeir;  
           LineSumm.EndItog		= AvrLine.EndItog; 

  END;


  PRIVATE MACRO PrintData(ObjReport:OBJECT)
     var Query, Select, AvrLine, Nrec, count, IsLinePrint = false;

     SetActiveSheet( "Мсфо7" );
     ObjReport.BeginReport();


     InitProgress(-1, StatLine, "Формируется отбор данных для отчета");

    VAR cmd_1 = RSDCommand("call RSHB_USERMsfo7.InsIntoTmpTable(?, ?)");
                            
    cmd_1.addParam( "", RSDBP_IN, BegDate );
    cmd_1.addParam( "", RSDBP_IN, RepDate );
    cmd_1.execute();





     Query =  " select * from DMsfo7_DBT ";

     Select = DL_RSDCommand(Query);
     
     Nrec = Select.GetCount();
     RemProgress();
     if(Nrec > 0)
       InitProgressBar( ToInt(Nrec), StatLine, "Обработка отобранных данных" );

       AvrLine = Select.Execute();

       LineSumm.ClearSum();
       while( AvrLine.MoveNext() )
                UseProgressBar;

                FillBegData(AvrLine);
                ObjReport.PrintTableLine();
                LineSumm.ClearSum();

  	       RemProgressBar;
        end;
 	       ObjReport.EndReport();

     end;
  END;                                                                                                                                                                         

  PRIVATE MACRO ExecuteReport(ObjReport:OBJECT)
//     m_H1 = m_H2 = null;
/*
     if( not CollectData() )
        msgbox("Нет данных для формирования отчета");
        return;
     end;
*/


    if (DEBUG_TMP_TABLE)

        execSQL("BEGIN EXECUTE IMMEDIATE 'Create Table DMsfo7_DBT( " +
                "      FIID Number(10),                  " +
                "      AvrName varchar2(164),               " +
                "      AvrType varchar2(35),               " +
                "      ISIN varchar2(25),   " +
                "      BegPortfCode varchar2(5) default 0, " +
                "      PortfAccount   varchar2(20) default chr(1), " +
                "      code_currency Number(10),  " +
                "      BegPortfCost Number(32,12) default 0, " +
                "       " +
                "      YnkdAccount   varchar2(20) default chr(1), " +
                "      IncomeAccount varchar2(20) default chr(1), " +
                "      DiscountAccount varchar2(20) default chr(1),               " +
                "      IntoEirAccount varchar2(20) default chr(1), " +
                "      RealizAccount varchar2(20) default chr(1), " +
                " " +
                "      BegYNKD Number(32,12) default 0,  " +
                "      BegBonusCost Number(32,12) default 0, " +
                "      BegNKD Number(32,12) default 0,  " +
                "      BegDiscount Number(32,12) default 0,  " +
                " " +
                "      PrevYearCost Number(32,12) default 0,  " +
                "      PrevYnkd Number(32,12) default 0,  " +
                "      PrevIncome Number(32,12) default 0,  " +
                "      PrevDiscount Number(32,12) default 0,  " +
                "      PrevBonus Number(32,12) default 0,  " +
                "      BegOvervalue Number(32,12) default 0,  " +
                "      OverMsfo Number(32,12) default 0,  " +
                "      BegInttoeir Number(32,12) default 0,  " +
                "      BegItog Number(32,12) default 0, " +
                "  " +
                "      BuyCost Number(32,12) default 0,  " +
                "      BuyYnkd Number(32,12) default 0,  " +
                "      BuyBonus Number(32,12) default 0,  " +
                "      BuyDiscount Number(32,12) default 0,  " +
                " " +
                "      ReclCost Number(32,12) default 0,  " +
                "      ReclYnkd Number(32,12) default 0,  " +
                "      ReclBonus Number(32,12) default 0,  " +
                "      ReclIncome Number(32,12) default 0,  " +
                "      ReclDiscount Number(32,12) default 0,  " +
                "      ReclOvervalue Number(32,12) default 0,  " +
                " " +
                "      ToDUCost Number(32,12) default 0,  " +
                "      ToDUYnkd Number(32,12) default 0,  " +
                "      ToDUBonus Number(32,12) default 0,  " +
                "      ToDUIncome Number(32,12) default 0,  " +
                "      ToDUDiscount Number(32,12) default 0,  " +
                "      ToDUOvervalue Number(32,12) default 0,  " +
                " " +
                "      FromDUCost Number(32,12) default 0,  " +
                "      FromDUYnkd Number(32,12) default 0,  " +
                "      FromDUBonus Number(32,12) default 0,  " +
                "      FromDUIncome Number(32,12) default 0,  " +
                "      FromDUDiscount Number(32,12) default 0,  " +
                "      FromDUOvervalue Number(32,12) default 0,  " +
                " " +
                "      PeriodIncome Number(32,12) default 0,  " +
                "      PeriodDiscount Number(32,12) default 0, " +
                "      PeriodDrawYnkd Number(32,12) default 0,  " +
                "      PeriodDrawIncome Number(32,12) default 0,  " +
                "      PeriodDrawDiscount Number(32,12) default 0,  " +
                "      PeriodBonus Number(32,12) default 0, " +
                "      PeriodOvervalue Number(32,12) default 0,  " +
                "      EndOvervalueMsfo Number(32,12) default 0,  " +
                " " +
                "      ObescCost Number(32,12) default 0,  " +
                "      ObescYnkd Number(32,12) default 0,  " +
                "      ObescBonus Number(32,12) default 0,  " +
                "      ObescIncome Number(32,12) default 0,  " +
                "      ObescDiscount Number(32,12) default 0,  " +
                "      ObescOvervalue Number(32,12) default 0,  " +
                " " +
                "      SaleFinRez Number(32,12) default 0,  " +
                "      SaleCost Number(32,12) default 0, " +
                "      SaleYnkd Number(32,12) default 0,  " +
                "      SaleDiscount Number(32,12) default 0,  " +
                "      SaleIncome Number(32,12) default 0,  " +
                "      SaleBonus Number(32,12) default 0,  " +
                "      SaleOvervalue Number(32,12) default 0, " +
                "      SaleEps Number(32,12) default 0, " +

                " " +
                "      EndPortf Number(32,12) default 0,  " +
                "      EndCost Number(32,12) default 0,  " +
                "      EndYnkd Number(32,12) default 0,  " +
                "      EndBonus Number(32,12) default 0,  " +
                "      EndIncome Number(32,12) default 0,  " +
                "      EndDiscount Number(32,12) default 0,  " +
                " " +
                "      ValOverCost Number(32,12) default 0,  " +
                "      ValOverYnkd Number(32,12) default 0,  " +
                "      ValOverIncome Number(32,12) default 0,  " +
                "      ValOverDiscount Number(32,12) default 0,  " +
                "      ValOverBonus Number(32,12) default 0,  " +
                " " +
                "      EndOvervalue Number(32,12) default 0,  " +
                "      DoocMsfo Number(32,12) default 0, " +
                "      EndInttoeir Number(32,12) default 0,  " +
                "      EndItog Number(32,12) default 0 " +
                "      )'; EXCEPTION WHEN OTHERS THEN NULL; END; ");

    else


        execSQL("BEGIN EXECUTE IMMEDIATE 'CREATE GLOBAL TEMPORARY TABLE DMsfo7_DBT( " +
                "      FIID Number(10),                  " +
                "      AvrName varchar2(164),               " +
                "      AvrType varchar2(35),               " +
                "      ISIN varchar2(25),   " +
                "      BegPortfCode varchar2(5) default 0, " +
                "      PortfAccount   varchar2(20) default chr(1), " +
                "      code_currency Number(10),  " +
                "      BegPortfCost Number(32,12) default 0, " +
                "       " +
                "      YnkdAccount   varchar2(20) default chr(1), " +
                "      IncomeAccount varchar2(20) default chr(1), " +
                "      DiscountAccount varchar2(20) default chr(1),               " +
                "      IntoEirAccount varchar2(20) default chr(1), " +
                "      RealizAccount varchar2(20) default chr(1), " +
                " " +
                "      BegYNKD Number(32,12) default 0,  " +
                "      BegBonusCost Number(32,12) default 0, " +
                "      BegNKD Number(32,12) default 0,  " +
                "      BegDiscount Number(32,12) default 0,  " +
                " " +
                "      PrevYearCost Number(32,12) default 0,  " +
                "      PrevYnkd Number(32,12) default 0,  " +
                "      PrevIncome Number(32,12) default 0,  " +
                "      PrevDiscount Number(32,12) default 0,  " +
                "      PrevBonus Number(32,12) default 0,  " +
                "      BegOvervalue Number(32,12) default 0,  " +
                "      OverMsfo Number(32,12) default 0,  " +
                "      BegInttoeir Number(32,12) default 0,  " +
                "      BegItog Number(32,12) default 0, " +
                "  " +
                "      BuyCost Number(32,12) default 0,  " +
                "      BuyYnkd Number(32,12) default 0,  " +
                "      BuyBonus Number(32,12) default 0,  " +
                "      BuyDiscount Number(32,12) default 0,  " +
                " " +
                "      ReclCost Number(32,12) default 0,  " +
                "      ReclYnkd Number(32,12) default 0,  " +
                "      ReclBonus Number(32,12) default 0,  " +
                "      ReclIncome Number(32,12) default 0,  " +
                "      ReclDiscount Number(32,12) default 0,  " +
                "      ReclOvervalue Number(32,12) default 0,  " +
                " " +
                "      ToDUCost Number(32,12) default 0,  " +
                "      ToDUYncd Number(32,12) default 0,  " +
                "      ToDUBonus Number(32,12) default 0,  " +
                "      ToDUIncome Number(32,12) default 0,  " +
                "      ToDUDiscount Number(32,12) default 0,  " +
                "      ToDUOvervalue Number(32,12) default 0,  " +
                " " +
                "      FromDUCost Number(32,12) default 0,  " +
                "      FromDUYnkd Number(32,12) default 0,  " +
                "      FromDUBonus Number(32,12) default 0,  " +
                "      FromDUIncome Number(32,12) default 0,  " +
                "      FromDUDiscount Number(32,12) default 0,  " +
                "      FromDUOvervalue Number(32,12) default 0,  " +
                " " +
                "      PeriodIncome Number(32,12) default 0,  " +
                "      PeriodDiscount Number(32,12) default 0, " +
                "      PeriodDrawYnkd Number(32,12) default 0,  " +
                "      PeriodDrawIncome Number(32,12) default 0,  " +
                "      PeriodDrawDiscount Number(32,12) default 0,  " +
                "      PeriodBonus Number(32,12) default 0, " +
                "      PeriodOvervalue Number(32,12) default 0,  " +
                "      EndOvervalueMsfo Number(32,12) default 0,  " +
                " " +
                "      ObescCost Number(32,12) default 0,  " +
                "      ObescYnkd Number(32,12) default 0,  " +
                "      ObescBonus Number(32,12) default 0,  " +
                "      ObescIncome Number(32,12) default 0,  " +
                "      ObescDiscount Number(32,12) default 0,  " +
                "      ObescOvervalue Number(32,12) default 0,  " +
                " " +
                "      SaleFinRez Number(32,12) default 0,  " +
                "      SaleCost Number(32,12) default 0, " +
                "      SaleYnkd Number(32,12) default 0,  " +
                "      SaleDiscount Number(32,12) default 0,  " +
                "      SaleIncome Number(32,12) default 0,  " +
                "      SaleBonus Number(32,12) default 0,  " +
                "      SaleOvervalue Number(32,12) default 0, " +
                "      SaleEps Number(32,12) default 0, " +
                " " +
                "      EndPortf Number(32,12) default 0,  " +
                "      EndCost Number(32,12) default 0,  " +
                "      EndYnkd Number(32,12) default 0,  " +
                "      EndBonus Number(32,12) default 0,  " +
                "      EndIncome Number(32,12) default 0,  " +
                "      EndDiscount Number(32,12) default 0,  " +
                " " +
                "      ValOverCost Number(32,12) default 0,  " +
                "      ValOverYnkd Number(32,12) default 0,  " +
                "      ValOverIncome Number(32,12) default 0,  " +
                "      ValOverDiscount Number(32,12) default 0,  " +
                "      ValOverBonus Number(32,12) default 0,  " +
                " " +
                "      EndOvervalue Number(32,12) default 0,  " +
                "      DoocMsfo Number(32,12) default 0, " +
                "      EndInttoeir Number(32,12) default 0,  " +
                "      EndItog Number(32,12) default 0 " +
                "      ) ON COMMIT PRESERVE ROWS'; EXCEPTION WHEN OTHERS THEN NULL; END; ");


    end;
     PrintData(ObjReport);

     var i:integer = 0;

  END;

  PRIVATE MACRO Create()
//     ClearGlobalTmp( "drepporst_tmp" );
     ExecuteReport(CRecMsfo7(this));
  END;



  MACRO AvrName()
     return LineSumm.AvrName;
  END;


  MACRO AvrType()
     return LineSumm.AvrType;
  END;


  MACRO ISIN()
     return LineSumm.ISIN;
  END;

  MACRO BegPortfCode()
     If(LineSumm.BegPortfCode == "5")
        return 3;
     elIf(LineSumm.BegPortfCode == "7")
        return Substr(LineSumm.portfaccount, 1, 5);
     elIf(LineSumm.BegPortfCode == "4")
        return "50505";
     else
        return LineSumm.BegPortfCode;
     end;
  END;

  MACRO BegPortfCost()
     return LineSumm.BegPortfCost;
  END;

  MACRO BegYNKD()
     return LineSumm.BegYNKD;
  END;

  MACRO BegBonusCost()
     return LineSumm.BegBonusCost;
  END;

  MACRO BegNKD()
     return LineSumm.BegNKD;
  END;

  MACRO BegDiscount()
     return LineSumm.BegDiscount;
  END;

  MACRO PrevYearCost()
     return LineSumm.PrevYearCost;
  end;

  MACRO PrevIncome()
     return LineSumm.PrevIncome;
  END;

  MACRO PrevDiscount()
     return LineSumm.PrevDiscount;
  END;

  MACRO PrevBonus()
     return LineSumm.PrevBonus;
  END;

  MACRO PrevYnkd()
        return LineSumm.PrevYnkd;
  END;

  MACRO BegOvervalue()
        return LineSumm.BegOvervalue;
  END;

  MACRO OverMsfo()
     return LineSumm.OverMsfo;
  END;

  MACRO BegInttoeir():string
     return LineSumm.BegInttoeir;
  END;

  MACRO BegItog()
     return LineSumm.BegItog;
  END;

  MACRO BuyCost()
     return LineSumm.BuyCost;
  END;



  MACRO BuyYnkd()
     return LineSumm.BuyYnkd;
  END;

  MACRO BuyBonus()
     return LineSumm.BuyBonus;
  END;

  MACRO BuyDiscount()
     return LineSumm.BuyDiscount;
  END;

  MACRO ReclCost()
     return LineSumm.ReclCost;
  END;

  MACRO ReclYnkd()
     return LineSumm.ReclYnkd;
  END;

  MACRO ReclBonus()
     return LineSumm.ReclBonus;
  END;

  MACRO ReclIncome()
        return LineSumm.ReclIncome;
  END;

  MACRO ReclDiscount()
     return LineSumm.ReclDiscount;
  END;

  MACRO ReclOvervalue()
     return LineSumm.ReclOvervalue;
  END;

  MACRO ToDUCost()
     return LineSumm.ToDUCost;
  END;

  MACRO ToDUYnkd()
     return LineSumm.ToDUYnkd;
  END;

  MACRO ToDUBonus()
     return LineSumm.ToDUBonus;
  END;

  MACRO ToDUIncome()
     return LineSumm.ToDUIncome;
  END;

  MACRO ToDUDiscount()
     return LineSumm.ToDUDiscount;
  END;

  MACRO ToDUOvervalue()
     return LineSumm.ToDUOvervalue;
  END;

  MACRO FromDUCost()
     return LineSumm.FromDUCost;
  END;

  MACRO FromDUYnkd()
        return LineSumm.FromDUYnkd;
  END;

  MACRO FromDUBonus()
     return LineSumm.FromDUBonus;
  END;

  MACRO FromDUIncome()
     return LineSumm.FromDUIncome;
  END;

  MACRO FromDUDiscount()
     return LineSumm.FromDUDiscount;
  END;

  MACRO FromDUOvervalue()
     return LineSumm.FromDUOvervalue;
  END;

  MACRO PeriodIncome()
     return LineSumm.PeriodIncome;
  END;

  MACRO PeriodDiscount()
        return LineSumm.PeriodDiscount;
  END;

  MACRO PeriodDrawYnkd()
     return LineSumm.PeriodDrawYnkd;
  END;

  MACRO PeriodDrawIncome()
     return LineSumm.PeriodDrawIncome;
  END;

  MACRO PeriodDrawDiscount()
     return LineSumm.PeriodDrawDiscount;
  END;

  MACRO PeriodBonus()
     return LineSumm.PeriodBonus;
  END;

  MACRO PeriodOvervalue()
        return LineSumm.PeriodOvervalue;
  END;

  MACRO EndOvervalueMsfo()
     return LineSumm.EndOvervalueMsfo;
  END;

  MACRO ObescCost()
     return LineSumm.ObescCost;
  END;

  MACRO ObescYnkd()
     return LineSumm.ObescYnkd;
  END;


  MACRO ObescBonus()
     return LineSumm.ObescBonus;
  END;

  MACRO ObescIncome()
        return LineSumm.ObescIncome;
  END;

  MACRO ObescDiscount()
     return LineSumm.ObescDiscount;
  END;

  MACRO ObescOvervalue()
     return LineSumm.ObescOvervalue;
  END;

  MACRO SaleFinRez()
     return LineSumm.SaleFinRez;
  END;

  MACRO SaleCost()
     return LineSumm.SaleCost;
  END;

  MACRO SaleYnkd()
        return LineSumm.SaleYnkd;
  END;

  MACRO SaleDiscount()
     return LineSumm.SaleDiscount;
  END;

  MACRO SaleIncome()
     return LineSumm.SaleIncome;
  END;

  MACRO SaleBonus()
     return LineSumm.SaleBonus;
  END;

  MACRO SaleOvervalue()
     return LineSumm.SaleOvervalue;
  END;

  MACRO SaleEps()
     return LineSumm.SaleEps;
  END;


  MACRO EndPortf()

     If(LineSumm.EndPortf == "5")
        return 3;
     elIf(LineSumm.EndPortf == "7")
        return Substr(LineSumm.portfaccount, 1, 5);
     elIf(LineSumm.EndPortf == "4")
        return "50505";
     else
        return LineSumm.EndPortf;
     end;

  END;

  MACRO EndCost()
     return LineSumm.EndCost;
  END;

  MACRO EndYnkd()
     return LineSumm.EndYnkd;
  END;

  MACRO EndBonus()
     return LineSumm.EndBonus;
  END;

  MACRO EndIncome()
     return LineSumm.EndIncome;
  END;




  MACRO EndDiscount()
     return LineSumm.EndDiscount;
  END;
  MACRO ValOverCost()
     return LineSumm.ValOverCost;
  END;
  MACRO ValOverYnkd()
     return LineSumm.ValOverYnkd;
  END;
  MACRO ValOverIncome()
     return LineSumm.ValOverIncome;
  END;




  MACRO ValOverDiscount()
     return LineSumm.ValOverDiscount;
  END;
  MACRO ValOverBonus()
     return LineSumm.ValOverBonus;
  END;
  MACRO EndOvervalue()
     return LineSumm.EndOvervalue;
  END;


  MACRO DoocMsfo()
     return LineSumm.DoocMsfo;
  END;


  MACRO EndInttoeir()
     return LineSumm.EndInttoeir;
  END;

  MACRO EndItog()
     return LineSumm.EndItog;
  END;
  
  initDL_CReportTemplate( NULL, "MSFO7_Report.xlsx" );
END;

macro MakeReports()
  Dl_CallInsertStat(DL_OUTREPORT_EXCEL);
  SP_Msfo7_Report().Run();
end; 

If(GetDate(RepDate, "Введите дату окончания отчета"))
else
   exit(1);
end;

/* Отчет выпускается на конец предыдущей даты включетельно*/
RepDateStr = RepDate;
RepDate = RepDate - 1;

/*Дата начала - 1 января года даты RepDate */

BegDate  = GetBegDate(RepDate);
//BegDate  = date("01.01.2019");

 
MakeReports();
exit(1);
