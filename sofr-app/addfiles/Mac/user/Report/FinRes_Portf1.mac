IMPORT SPInter, FIInter, "globals.mac", "mc_lib.mac", "secinter.mac", "CbReport_h.mac";              

VAR Query, Query1, Query2, SumID, Portfolio, ok, ok1;
VAR DataSet, rsd, DataSet1,DataSet2;
VAR fi_code = -1;
VAR fin = TBFile ("fininstr");
VAR DataRep;
VAR ALL = TArray(),
    TP  = TArray(),
    PPr = TArray(),
    PVO = TArray(),
    PKU = TArray();
PRIVATE VAR acc, acc2, acc1;
VAR RepParm;

VAR fldBegDate = 0,
    fldEndDate = 1,
    fldPortf   = 2, 
    fldAvoir   = 3;
RECORD finin ("fininstr");
RECORD avr   ("avoiriss");

PRIVATE RECORD dlg("FR_PORTF", "mfk.lbr") dialog;

PRIVATE VAR TableWidth = 132; /* Ширина таблицы*/
VAR Rep; // = CMakeReport();
VAR PrintTP = false, PrintPPR = false, PrintPVO = false , PrintPKU = false;

const SHEET_NAME = "Отчет";

VAR Header =    "┌─────────────┬─────────────┬──────────────────────┬──────────────────────┬──────────────────────────┬─────────────────────────────┬──────────────────────────┬───────────────────────┬───────────────┐\n"+
                "│Номер сделки │     Дата    │   Портфель           │     Количество       │      Сумма по Дебету     │       Сумма по Кредиту      │  Счет доходов/расходов   │ Финансовый результат  │Дата реализации│\n"+
                "│  продажи    │  поставки   │    │    │        │           │        │     │               │\n"+
                "├─────────────┼─────────────┼──────────────────────┼──────────────────────┼──────────────────────────┼─────────────────────────────┼──────────────────────────┼───────────────────────┼───────────────┤";
// Rep = CMakeReport(Header);

CLASS RepData   /* Параметры выпуска отчёта */
    var BegDate = {curdate} - 1,
        EndDate = {curdate} - 1,
        Avoir = -1,       /* По всем бумагам */
        Portf = -1;       /* Все портфели */

    /* Проинициализировать поля диалога */
    dlg.BegDate = {CurDate} - 1;
    dlg.EndDate = {CurDate} - 1;
    dlg.Portf   = "ВСЕ";
    dlg.Avoir   = "ВСЕ";
END;




// CLASS (CB_CReportTemplate) FinResReport( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI:BOOL, UseBigReportMode:BOOL, FocreFormatRep:INTEGER )
CLASS (CB_CReportTemplate) FinResReport( )

  var table_started = false;
  var first_table = true;
  const FIRST_HEADER_COPY_ADDR = "A4";
  const FIRST_TABLE_COPY_ADDR = "A6";

  MACRO PrintMode():INTEGER
    return DL_OUTREPORT_EXCEL;
  END;

MACRO PrintLine( A0, A1, A2, A3, A4, A5, A6, A7, A8 )

  PrintTableLine( "N1_DealCode", A0, null,
                  "N1_DealDate", A1, null,
                  "N1_Portf", A2, null,
                  "N1_Amount", A3, null,
                  "N1_SumDeb", A4, null,
                  "N1_SumCre", A5, null,
                  "N1_Acc", A6, null,
                  "N1_Fres", A7, null,
                  "N1_Date", A8, null
                );
end;


macro begintable(name:string)
  PrintFormatString("", "H2_CBName", name);
  if(not first_table)
    CopyAllSheetInTotalBook(SHEET_NAME, false, "N1_Header", 0, SHEET_NAME, true);
  end;

  RegisterTable( "N1_TableRow", "N1_Header",
    "N1_DealCode",
    "N1_Date",
    "N1_Portf",
    "N1_Amount",
    "N1_SumDeb",
    "N1_SumCre",
    "N1_Acc",
    "N1_Fres",
    "N1_Date"
  );
  table_started = true;
end;

macro EndTable()
  EndTable();

  if(first_table)
    first_table = false;
    CopyAllSheetInTotalBook(SHEET_NAME, true, "H1_Header", 0, SHEET_NAME, true);
  else
    CopyAllSheetInTotalBook(SHEET_NAME, false, GetTableRange(), 0, SHEET_NAME, true);
  end;

  table_started = false;
end;


MACRO PrintHeader ()
  var period:string;
    // Rep.AddPrintCell("Финансовый результат по операциям с ц/б за период", TableWidth, 0, "l", REP_ELEM_STR);
    // Rep.AddStr();
    // Rep.AddPrintCell("с "+string (RepParm.BegDate)+" по " + String(RepParm.EndDate), TableWidth, 0, "l", REP_ELEM_STR);
    // Rep.AddStr();
    // Rep.AddEmptyStr();
  period = "с "+string (RepParm.BegDate)+" по " + String(RepParm.EndDate);
  PrintFormatString("", "H1_Period", period);
  
  // CopyAllSheetInTotalBook(SHEET_NAME, true, "H1_Header", 0, SHEET_NAME, true);

END;

MACRO PrintAvoirHeader (securname)
    // Rep.AddPrintCell("Ценная бумага: "+ securname, TableWidth, 0, "l", REP_ELEM_STR);
    // Rep.AddStr();
  if(table_started)
    EndTable();
  end;

  begintable("Ценная бумага: "+ securname);
END;

MACRO BeginReport()
  CreateTotalBook();
  SetActiveSheet(SHEET_NAME);
  PrintHeader();
END;

MACRO EndReport()
  if(table_started)
    EndTable();
  end;
  
  SaveTotalBook();
END;

MACRO ПолучитьПроводкиНаШагах (DataSet2, DataSet, IDLot, PortfLot, All, TP, PPR, PVO, PKU, ACC2)
    var Query;
    var Docs, str;
    var SumCredit = $0, SumCredit_TP = $0, SumCredit_PPR = $0, SumCredit_PVO = $0, SumCredit_PKU = $0, SumCredit_All =$0;
    var SumDebet = $0, SumDebet_tp = $0, SumdEBET_PPR = $0,   SumDebet_pvO = $0, SumDebet_PKU = $0, SumDebet_other = $0; 
    var FR = $0, FR1_ = $0, FR1 = $0, FR_TP =$0, FR_PPR =$0, FR_PVO =$0, FR_PKU =$0, SERVDOCID = 0;
    var Sum = $0, Sum_TP = $0, Sum_PPR = $0, Sum_PVO = $0, Sum_Comm = $0, Sum_Comm_TP = $0, Sum_Comm_PPR = $0, Sum_Comm_PKU = $0, Sum_Comm_PVO = $0;
    var Amount = 0, Amount_TP = 0, Amount_PPR = 0 , Amount_PVO = 0, Amount_PKU = 0, Amount_notFR = 0;
    var N1_DealCode, N1_DealDate, N1_Portf, N1_Amount, N1_SumDeb, N1_SumCre, N1_Acc, N1_Fres, N1_Date; 
    if ((ACC2 == "") and (DataSet.opr_id != -1))/*BAI*/
        Query = " Select doc.* from dacctrn_dbt doc, doprdocs_dbt oprdocs where " +
                " oprdocs.t_ID_Operation = " + String (DataSet.opr_id) + " and " +
                " oprdocs.t_DocKind = 1 and " +
                " oprdocs.t_acctrnid = doc.t_acctrnid "+ 
                " and doc.t_chapter=1 "+
                " UNION "+
                " SELECT doc.* "+
                "  FROM dacctrn_dbt doc "+
                " WHERE doc.t_chapter = 1 "+
                "       AND DOC.T_NUMB_DOCUMENT = '" + DataSet2.Dealcode + "' ";
  
    elif ((ACC2 == "") and (DataSet.opr_id1 != -1))/*BAI*/
        Query = "         SELECT GRD.T_SERVDOCID, doc.* " +
                "  FROM DDLGRDOC_DBT grd, dacctrn_dbt doc, DDLGRDEAL_DBT gr " +
                " WHERE     GRD.T_DOCID = doc.t_acctrnid " +
                "       AND GR.T_ID = GRD.T_GRDEALID " +
                "       and ( (SUBSTR (doc.t_account_payer, 1, 5) = '61210') " +
                "              OR (SUBSTR (doc.t_account_receiver, 1, 5) = '61210') " +
                "              OR (SUBSTR (doc.t_account_receiver, 1, 3) = '106') " +
                "              oR (SUBSTR (doc.t_account_payer, 1, 3) = '106')) " +
                "        and GRD.T_DOCKIND = 1 and DOC.T_STATE = 1 "+
                "       AND GR.T_DOCID = " + String (DataSet.opr_id1);
    else 
        query = " SELECT *  FROM dacctrn_dbt doc ";
        query = query + " WHERE doc.t_chapter = 1 /*and doc.t_number_pack = 0*/ ";
        query = query + "   AND doc.t_date_carry >= " + GetSQLDate (RepParm.BegDate);    
        query = query + "   AND doc.t_date_carry <= " + GetSQLDate (RepParm.EndDate);         
        query = query + "   AND ( (doc.t_account_payer = '" + ACC2 + "') or (doc.t_account_receiver = '" + ACC2 + "') )";
        query = query + "   AND NOT EXISTS ( SELECT 1 FROM doprdocs_dbt oprdocs WHERE oprdocs.t_dockind = 1 ";
        query = query + "    and oprdocs.t_acctrnid = doc.t_acctrnid  ) and DOC.T_STATE = 1";
    end;
    Docs = TRsbDataSet(query);
    While (Docs.Movenext()) 
           if ((SubStr (Docs.Account_Receiver, 1, 3) != "706") and
               (SubStr (Docs.Account_Payer, 1, 3) != "706") )
                if (SubStr(Docs.Account_Payer, 1, 5) == "61210")
                    if   ( (SubStr (Docs.Account_Receiver, 1, 3) == "501") or
                           (SubStr (Docs.Account_Receiver, 1, 3) == "506") 
                          )
                         SumDebet_TP = SumDebet_TP + docs.Sum_natcur;
                    elif   ( (SubStr (Docs.Account_Receiver, 1, 3) == "502") or
                             (SubStr (Docs.Account_Receiver, 1, 3) == "507")
                           )
                          SumDebet_PPR = SumDebet_PPR + docs.Sum_natcur;
                    elif   ( (SubStr (Docs.Account_Receiver, 1, 3) == "427") or
                             (SubStr (Docs.Account_Receiver, 1, 3) == "428") or
                             (SubStr (Docs.Account_Receiver, 1, 3) == "429") or
                             (SubStr (Docs.Account_Receiver, 1, 3) == "430") or
                             (SubStr (Docs.Account_Receiver, 1, 3) == "431") or
                             (SubStr (Docs.Account_Receiver, 1, 3) == "432") or
                             (SubStr (Docs.Account_Receiver, 1, 3) == "433") or
                             (SubStr (Docs.Account_Receiver, 1, 3) == "434") or
                             (SubStr (Docs.Account_Receiver, 1, 3) == "435") or
                             (SubStr (Docs.Account_Receiver, 1, 3) == "436") or
                             (SubStr (Docs.Account_Receiver, 1, 3) == "437") or
                             (SubStr (Docs.Account_Receiver, 1, 3) == "438") or
                             (SubStr (Docs.Account_Receiver, 1, 3) == "439") or
                             (SubStr (Docs.Account_Receiver, 1, 3) == "440") or
                             (SubStr (Docs.Account_Receiver, 1, 3) == "315") or
                             (SubStr (Docs.Account_Receiver, 1, 3) == "316") or
                             (SubStr (Docs.Account_Receiver, 1, 3) == "423") or
                             (SubStr (Docs.Account_Receiver, 1, 3) == "426") or
                             (SubStr (Docs.Account_Receiver, 1, 3) == "329") 
                            ) 
                             SumDebet_PVO = SumDebet_PVO + docs.Sum_natcur;
                    elif  ( (SubStr (Docs.Account_Receiver, 1, 5) == "50905") or
                            (SubStr (Docs.Account_Receiver, 1, 5) == "47403") or
                            (SubStr (Docs.Account_Receiver, 1, 5) == "47404") or
                            (SubStr (Docs.Account_Receiver, 1, 5) == "47422") or 
                            (SubStr (Docs.Account_Receiver, 1, 5) == "47423") or
                            (SubStr (Docs.Account_Receiver, 1, 5) == "30602")  ) /*PNV, брокерская комиссия*/
                             Sum_Comm = Sum_Comm + docs.Sum_natcur;
                     elif  ((SubStr (Docs.Account_Receiver, 1, 5) == "60204")  or /*PNV, прецедент. Проводка на 60204 - учитываем в SumDebet_other*/
                            (SubStr (Docs.Account_Receiver, 1, 5) == "60101")  or /*ААИ Айс 309122*/
                            (SubStr (Docs.Account_Receiver, 1, 5) == "60102")  or 
                            (SubStr (Docs.Account_Receiver, 1, 5) == "60103")  or 
                            (SubStr (Docs.Account_Receiver, 1, 5) == "60104")  or  
                            (SubStr (Docs.Account_Receiver, 1, 3) == "526") )   /*PNV тема 322656*/
                             SumDebet_other = SumDebet_other + docs.Sum_natcur;   
                     end;
                     SumDebet = SumDebet + docs.Sum_natcur;
                 end;
                 if (SubStr(Docs.Account_Receiver, 1, 5) == "61210")
                     if  ((SubStr (Docs.Account_Payer, 1, 3) == "502") OR (SubStr (Docs.Account_Payer, 1, 3) == "306"))
                           SumCredit_PPR = SumCredit_PPR + docs.Sum_natcur;
                     else
                           SumCredit_All = SumCredit_All + docs.Sum_natcur;
                     end;
                     SumCredit = SumCredit + docs.Sum_natcur;
                 end;
           else 
                 if (SubStr (Docs.Account_Payer, 1, 5) == "61210")
                     FR = FR + docs.Sum_natcur;
                     acc = Docs.Account_Receiver;
                 elif (SubStr (Docs.Account_Receiver, 1, 5) == "61210")
                     FR = FR +(-1)*docs.Sum_natcur;
                     acc = docs.Account_Payer;
                 elif (SubStr (Docs.Account_Receiver, 1, 3) == "106")
                     FR1_ =  FR1_ + docs.Sum_natcur;
                     acc1 = docs.Account_Payer;
                 elif (SubStr (Docs.Account_Payer, 1, 3) == "106")
                     FR1 = FR1 + docs.Sum_natcur;
                     acc1 = Docs.Account_Receiver;
                 end;                   
                 if (DataSet.opr_id1 != -1)
                     SERVDOCID =  Docs.SERVDOCID;
                 end;
           end;
 end;
 if ((SumCredit == $0) and (SumDebet == $0) and (FR == $0))
      return false;
 end;

 if (FR != SumCredit - SumDebet)
     msgbox ("Неверный фин. результат по сделке (" + FR + ") д.б. " + string (SumCredit - SumDebet));
    // return false;
 end;

 if (SumDebet != SumDebet_TP + SumDebet_PPR + SumDebet_PVO + Sum_Comm + SumDebet_other)
    var str1 = "Ошибка при подсчете сумм по дебету 61210, сделка номер" + DataSet.num; 
        str1 = str1 + " SumDebet = " + SumDebet;
        str1 = str1 + ", SumDebet_TP = " + SumDebet_TP + ", SumDebet_PVO =" + SumDebet_PVO + ", Sum_Comm =" + Sum_Comm + ", SumDebet_other =" + SumDebet_other;
    msgbox (str1);
    return false;
 end;

 if (SumCredit != SumCredit_PPR + SumCredit_ALL)
    msgbox ("Ошибка при подсчете сумм по кредиту 61210");
    return false;
 end;
 
 if (ACC2 == "") /*BAI*/
      str = "select buylot.t_DealID, buylot.t_Portfolio, lnk.t_BalanceCostBuy, lnk.t_BalanceCostSale, lnk.t_BalanceCostBD, lnk.t_CostBuy, lnk.t_NKDBuyAmount, lnk.t_Amount LnkAmount, buylot.t_Amount BuyAmount, buylot.t_Kind, lnk.T_OVERCHANGE " +
            "  from dpmwrtlnk_dbt lnk, dpmwrtsum_dbt buylot, dpmwrtsum_dbt salelot, ddlrq_dbt rq  " +
            " where     salelot.t_SumID = lnk.t_SaleID " +
            "       and buylot.t_SumID  = lnk.t_BuyID " +
            "       and RQ.T_ID = SALELOT.T_DOCID ";
      if (DataSet.opr_id != -1)
          str = str +  "       and salelot.t_SumID in (select t_sumid from dpmwrtsum_dbt where t_id_operation = "+DataSet.opr_id+" and t_buy_sale=1) ";
      elif (DataSet.opr_id1 != -1)
          str = str +  "       and salelot.t_SumID in (select t_sumid from dpmwrtsum_dbt where t_id_operation = " + SERVDOCID + " and t_buy_sale = 1) and RQ.T_DOCID = " + DataSet.opr_id1 ;
      end;
      str = str + " order by buylot.t_Portfolio ";

     Query = RSDCommand(str);
     Query.execute();
     var OVERCHANGE_TP = 0, OVERCHANGE_PPR = 0, OVERCHANGE_PVO = 0, OVERCHANGE = 0, OVERCHANGE_PKU = 0;
     RSD = TRsbDataSet(Query);
     while( RSD.MoveNext() )
           if ((RSD.rec.Portfolio == KINDPORT_BACK) and (PortfLot != KINDPORT_BACK))
                Amount_PVO =  Amount_PVO + RSD.rec.LnkAmount; 
           elif (RSD.rec.Portfolio == KINDPORT_TRADE)
                Amount_TP = Amount_TP + RSD.rec.LnkAmount;
           elif (RSD.rec.Portfolio == KINDPORT_SALE)
                Amount_PPR = Amount_PPR + RSD.rec.LnkAmount;
                OVERCHANGE_PPR = OVERCHANGE_PPR + RSD.rec.OVERCHANGE;
           elif (RSD.rec.Portfolio == 3)/*PNV - ПКУ*/
                Amount_PKU =  Amount_PKU + RSD.rec.LnkAmount; 
           else
                Amount_notFR = Amount_notFR + RSD.rec.LnkAmount;
           end;
           Amount = Amount + RSD.rec.LnkAmount;      
     end;
     Amount = Amount - Amount_notFR;
     if (Sum_Comm != $0)
        if(amount != $0)
         sum_comm_tp  = round ( (sum_comm/amount)*amount_TP, 2);
         sum_comm_ppr = round ( (sum_comm/amount)*amount_PPR, 2);
         sum_comm_pvo = round ( (sum_comm/amount)*amount_PVO, 2);
         sum_comm_pku = round ( (sum_comm/amount)*amount_PKU, 2);
        else
         sum_comm_tp  = $0;
         sum_comm_ppr = $0;
         sum_comm_pvo = $0;
         sum_comm_pku = $0;
          msgbox ("Ошибка деление на 0. amount = 0, Amount_notFR = " + Amount_notFR + " dealid="+DataSet.num+";");
        end;
         if ((sum_comm_tp + sum_comm_ppr + sum_comm_pvo) != sum_comm)
             if (max (Amount_TP, Amount_PPR, Amount_PVO, Amount_PKU) == Amount_TP)
                 sum_comm_tp = sum_comm - sum_comm_ppr - sum_comm_pvo - sum_comm_pku;
             elif (max (Amount_TP, Amount_PPR, Amount_PVO, Amount_PKU) == Amount_PPR)
                 sum_comm_ppr = sum_comm - sum_comm_tp - sum_comm_pvo - sum_comm_pku;
             elif (max (Amount_TP, Amount_PPR, Amount_PVO, Amount_PKU) == Amount_PKU)
                 sum_comm_pku = sum_comm - sum_comm_tp - sum_comm_ppr - sum_comm_pvo;
             elif (max (Amount_TP, Amount_PPR, Amount_PVO, Amount_PKU) == Amount_PVO)
                 sum_comm_pvo = sum_comm - sum_comm_tp - sum_comm_ppr - sum_comm_pku;
             end;
         end;
     end;    
     SumDebet_TP = SumDebet_TP + Sum_Comm_TP + SumDebet_other;
     SumDebet_PPR = SumDebet_PPR + Sum_Comm_PPR + SumDebet_other;
     SumDebet_PVO = SumDebet_PVO + Sum_Comm_PVO + SumDebet_other;
     SumDebet_PKU = SumDebet_PKU + Sum_Comm_PKU + SumDebet_other;

      if(amount != $0)
        SumCredit_TP = round ((SumCredit_All/Amount)*Amount_TP, 2);
        SumCredit_PPR = SumCredit_PPR + round ((SumCredit_All/Amount)*Amount_PPR, 2);
        SumCredit_PVO = round ((SumCredit_All/Amount)*Amount_PVO, 2);
        SumCredit_PKU = round ((SumCredit_All/Amount)*Amount_PKU, 2);
      else
        SumCredit_TP = $0;
        SumCredit_PPR = SumCredit_PPR + $0;
        SumCredit_PVO = $0;
        SumCredit_PKU = $0;

      end;

     if ((sumcredit_tp + sumcredit_ppr + sumcredit_pvo + sumcredit_pKU) != sumcredit)
         if (max (Amount_TP, Amount_PPR, Amount_PVO, Amount_PKU) == Amount_TP)
             sumcredit_tp = sumcredit - sumcredit_ppr - sumcredit_pvo - sumcredit_pKU;
         elif (max (Amount_TP, Amount_PPR, Amount_PVO, Amount_PKU) == Amount_PPR)
             sumcredit_ppr = sumcredit - sumcredit_tp - sumcredit_pvo - sumcredit_pKU;
         elif (max (Amount_TP, Amount_PPR, Amount_PVO, Amount_PKU) == Amount_PVO)
              sumcredit_pvo = sumcredit - sumcredit_tp - sumcredit_ppr - sumcredit_pKU;
         elif (max (Amount_TP, Amount_PPR, Amount_PVO, Amount_PKU) == Amount_PKU)
              sumcredit_pvo = sumcredit - sumcredit_tp - sumcredit_ppr - sumcredit_pvo;
         end;
     end;

     if (Amount_TP != 0)
         FR_TP = SumCredit_TP - SumDebet_TP;
         if (PrintTP)
             TP[0] = FR_TP;
             TP[1] = Amount_TP;
             TP[2] = SumDebet_TP;
             TP[3] = SumCredit_TP;
         end;
     end;

     if (Amount_PPR != 0)
         FR_PPR = SumCredit_PPR - SumDebet_PPR;
         if (PrintPPR)
             PPR[0] = FR_PPR;
             PPr[1] = Amount_PPR;
             PPR[2] = SumDebet_PPR;
             PPR[3] = SumCredit_PPR;
         end;
     end;

     if (Amount_PVO != 0)
         FR_PVO = SumCredit_PVO - SumDebet_PVO;
         if (PrintPVO)
             PVO[0] = FR_PVO;
             PVO[1] = Amount_PVO;
             PVO[2] = SumDebet_PVO;
             PVO[3] = SumCredit_PVO;
         end;
     end;

     if (Amount_PKU != 0)
         if (PrintPVO)
             FR_PKU = SumCredit_PKU - SumDebet_PKU;
             PKU[0] = FR_PKU;
             PKU[1] = Amount_PKU;
             PKU[2] = SumDebet_PKU;
             PKU[3] = SumCredit_PKU;
         end;
     end;

     if (FR != FR_TP + FR_PPR + FR_PVO + FR_PKU)
         msgbox ("Ошибка при разбиении фин.результата по портфелям");
         return false;
     end;

     if ((TP.Size != 0) or (PPR.Size != 0) or (PVO.size != 0) or (PKU.size != 0))
          All[0] = FR;
          All[1] = Amount + Amount_notFR;
          All[2] = SumDebet;
          All[3] = SumCredit;
     end;
  else/*if (ACC2=="") BAI*/ 
     if ((SumCredit_TP != 0) or (SumDebet_TP!=0) )
          FR_TP = SumCredit_TP - SumDebet_TP;
          if (PrintTP)
              TP[0] = FR_TP;
              TP[1] = SumID;/*BAI*/
              TP[2] = SumDebet_TP;
              TP[3] = SumCredit_TP;
         end;
     end;

     if ((SumCredit_PPR != 0) or (SumDebet_PPR!=0))
         FR_PPR = SumCredit_PPR - SumDebet_PPR;
         if (PrintPPR)
             PPR[0] = FR_PPR;
             if ((DataSet.opr_id == -1) and (DataSet.opr_id1 == -1))
                 PPr[1] = "Нет данных";/*BAI*/
             elif(DataSet.opr_id1 != -1)
                 PPr[1] = SumID;/*BAI*/
             else
                 PPr[1] = SumID;/*BAI*/
             end;
             PPR[2] = SumDebet_PPR;
             PPR[3] = SumCredit_PPR;
         end;
    end;

    if ((SumCredit_PVO != 0) or (SumDebet_PVO!=0))
         FR_PVO = SumCredit_PVO - SumDebet_PVO;
         if (PrintPVO)
             PVO[0] = FR_PVO;
             PVO[1] = SumID;/*BAI*/
             PVO[2] = SumDebet_PVO;
             PVO[3] = SumCredit_PVO;
         end;
    end;

    if ((SumCredit_PKU != 0) or (SumDebet_PKU!=0))
        if (PrintPKU)
            FR_PKU = SumCredit_PKU- SumDebet_PKU;
            PKU[0] = FR_PKU;
            PKU[1] = SumID;/*BAI*/
            PKU[2] = SumDebet_PKU;
            PKU[3] = SumCredit_PKU;
        end;
    end;
    if ((TP.Size != 0) or (PPR.Size != 0) or (PVO.size != 0))/*BAI*/
         All[0] = 1;
         All[1] = 1;
         All[2] = 1;
         All[3] = 1;
    end;
  end;/*if (ACC2=="") BAI*/
  SetParm (4+1, All);
  SetParm (5+1, TP);
  SetParm (6+1, PPR);
  SetParm (7+1, PVO);
  SetParm (8+1, PKU);
  SetParm (9+1, Acc);
  if ((Fr1 != 0) or (Fr1_ != 0))
       if (Fr1_ != 0)
           Fr1 = (-1)* Fr1_;
       end;
  end;

  if ((TP.Size != 0) and PrintTP)
      // Rep.AddStr();
      if ((DataSet.opr_id == -1) and (DataSet.opr_id1 == -1))
          // Rep.AddFormatCell("Проводка выполнена вручную. Нет данных","r"); 
          // Rep.AddFormatCell("Нет данных","r");
          N1_DealCode = "Проводка выполнена вручную. Нет данных";
          N1_DealDate = "Нет данных";
      elif (DataSet.opr_id1 != -1)
          // Rep.AddFormatCell(DataSet2.DealCode,"r"); 
          // Rep.AddFormatCell(SQL_ConvTypeDate(DataSet2.DealDate),"r")
          N1_DealCode = DataSet2.DealCode;
          N1_DealDate = SQL_ConvTypeDate(DataSet2.DealDate);
     else
          // Rep.AddFormatCell(DataSet2.DealCode,"r"); 
          // Rep.AddFormatCell(SQL_ConvTypeDate(DataSet2.DealDate),"r"); 
          N1_DealCode = DataSet2.DealCode;
          N1_DealDate = SQL_ConvTypeDate(DataSet2.DealDate);
     end;

    //  Rep.AddFormatCell("Торговый портфель","r"); 
    //  Rep.AddFormatCell(TP[1],"r"); 
    //  Rep.AddPrintCell((TP[2]),"r"); 
    //  Rep.AddPrintCell((TP[3]),"r"); 
    //  Rep.AddFormatCell(string(acc),"r"); 
    //  Rep.AddPrintCell((TP[0]),"r");
    //  Rep.AddFormatCell(SQL_ConvTypeDate(DataSet.value("carry")),"r");
     N1_Portf = "Торговый портфель";
     N1_Amount = TP[1];
     N1_SumDeb = (TP[2]);
     N1_SumCre = (TP[3]);
     N1_Acc =  string(acc);
     N1_Fres = (TP[0]);
     N1_Date = SQL_ConvTypeDate(DataSet.value("carry"));

     PrintLine(N1_DealCode, N1_DealDate, N1_Portf, N1_Amount, N1_SumDeb, N1_SumCre, N1_Acc, N1_Fres, N1_Date);
                  
     if ((OVERCHANGE_TP != 0) and (FR1 != 0))
          //  Rep.AddStr();
          //  Rep.AddFormatCell(DataSet2.DealCode,"r"); 
          //  Rep.AddFormatCell(SQL_ConvTypeDate(DataSet2.DealDate),"r");
          //  Rep.AddFormatCell("Торговый портфель","r"); 
          //  Rep.AddFormatCell(TP[1],"r"); 
          //  Rep.AddPrintCell(0,"C");
          //  Rep.AddPrintCell(0,"C"); 
          //  Rep.AddFormatCell(string(acc1),"r"); 
          //  Rep.AddPrintCell(OVERCHANGE_TP,"r");
          //  Rep.AddFormatCell(SQL_ConvTypeDate(DataSet.value("carry")),"r");

           N1_DealCode = DataSet2.DealCode;
           N1_DealDate = SQL_ConvTypeDate(DataSet2.DealDate); 
           N1_Portf = "Торговый портфель";
           N1_Amount = TP[1];
           N1_SumDeb = 0; 
           N1_SumCre = 0; 
           N1_Acc = string(acc1);
           N1_Fres = OVERCHANGE_TP;
           N1_Date = SQL_ConvTypeDate(DataSet.value("carry"));
           PrintLine(N1_DealCode, N1_DealDate, N1_Portf, N1_Amount, N1_SumDeb, N1_SumCre, N1_Acc, N1_Fres, N1_Date);
     end;
  end;

  if ((PPR.Size != 0) and PrintPPR)
      // Rep.AddStr();
      if ((DataSet.opr_id == -1) and (DataSet.opr_id1 == -1))
          // Rep.AddFormatCell("Проводка выполнена вручную. Нет данных","r"); 
          // Rep.AddFormatCell("Нет данных","r");
          N1_DealCode = "Проводка выполнена вручную. Нет данных";
          N1_DealDate = "Нет данных";
      elif (DataSet.opr_id1 != -1)
          // Rep.AddFormatCell(DataSet2.DealCode,"r"); 
          // Rep.AddFormatCell(SQL_ConvTypeDate(DataSet2.DealDate),"r"); 
          N1_DealCode = DataSet2.DealCode;
          N1_DealDate = SQL_ConvTypeDate(DataSet2.DealDate); 
      else
          // Rep.AddFormatCell(DataSet2.DealCode,"r"); 
          // Rep.AddFormatCell(SQL_ConvTypeDate(DataSet2.DealDate),"r"); 
          N1_DealCode = DataSet2.DealCode;
          N1_DealDate = SQL_ConvTypeDate(DataSet2.DealDate); 
      end;

      // Rep.AddFormatCell("Портфель для перепродажи","r"); 
      // Rep.AddFormatCell(PPR[1],"r"); 
      // Rep.AddPrintCell((PPR[2]),"r"); 
      // Rep.AddPrintCell((PPR[3]),"r"); 
      // Rep.AddFormatCell(string(acc),"r"); 
      // Rep.AddPrintCell((PPR[0]),"r"); 
      // Rep.AddFormatCell(SQL_ConvTypeDate(DataSet.value("carry")),"r");
      N1_Portf = "Портфель для перепродажи";
      N1_Amount = PPR[1];
      N1_SumDeb = (PPR[2]);
      N1_SumCre = (PPR[3]);
      N1_Acc =  string(acc);
      N1_Fres = (PPR[0]);
      N1_Date = SQL_ConvTypeDate(DataSet.value("carry"));

      PrintLine(N1_DealCode, N1_DealDate, N1_Portf, N1_Amount, N1_SumDeb, N1_SumCre, N1_Acc, N1_Fres, N1_Date);
      if ((OVERCHANGE_PPR != 0) and (FR1 != 0))
            // Rep.AddStr();
            // Rep.AddFormatCell(DataSet2.DealCode,"r"); 
            // Rep.AddFormatCell(SQL_ConvTypeDate(DataSet2.DealDate),"r");
            // Rep.AddFormatCell("Портфель для перепродажи","r"); 
            // Rep.AddFormatCell(PPR[1],"r"); 
            // Rep.AddPrintCell(0,"C");
            // Rep.AddPrintCell(0,"C"); 
            // Rep.AddFormatCell(string(acc1),"r"); 
            // Rep.AddPrintCell(OVERCHANGE_PPR,"r");
            // Rep.AddFormatCell(SQL_ConvTypeDate(DataSet.value("carry")),"r");
            N1_DealCode = DataSet2.DealCode;
            N1_DealDate = SQL_ConvTypeDate(DataSet2.DealDate); 
            N1_Portf = "Портфель для перепродажи";
            N1_Amount = PPR[1];
            N1_SumDeb = 0; 
            N1_SumCre = 0; 
            N1_Acc = string(acc1);
            N1_Fres = OVERCHANGE_PPR;
            N1_Date = SQL_ConvTypeDate(DataSet.value("carry"));
            PrintLine(N1_DealCode, N1_DealDate, N1_Portf, N1_Amount, N1_SumDeb, N1_SumCre, N1_Acc, N1_Fres, N1_Date);
      end;
  end;
  if ((PVO.Size != 0) and PrintPVO)
      // Rep.AddStr();
      if ((DataSet.opr_id == -1) and (DataSet.opr_id1 == -1))
          // Rep.AddFormatCell("Проводка выполнена вручную. Нет данных","r"); 
          // Rep.AddFormatCell("Нет данных","r");
          N1_DealCode = "Проводка выполнена вручную. Нет данных";
          N1_DealDate = "Нет данных"; 
      elif (DataSet.opr_id1 != -1)
          //  Rep.AddFormatCell(DataSet2.DealCode,"r"); 
          //  Rep.AddFormatCell(SQL_ConvTypeDate(DataSet2.DealDate),"r");
           N1_DealCode = DataSet2.DealCode;
           N1_DealDate = SQL_ConvTypeDate(DataSet2.DealDate);   
      else
          //  Rep.AddFormatCell(DataSet2.DealCode,"r"); 
          //  Rep.AddFormatCell(SQL_ConvTypeDate(DataSet2.DealDate),"r");
           N1_DealCode = DataSet2.DealCode;
           N1_DealDate = SQL_ConvTypeDate(DataSet2.DealDate);  
      end;

      // Rep.AddFormatCell("Портфель обратного РЕПО","r"); 
      // Rep.AddFormatCell(PVO[1],"r"); 
      // Rep.AddPrintCell((PVO[2]),"r"); 
      // Rep.AddPrintCell((PVO[3]),"r"); 
      // Rep.AddFormatCell(string(acc),"r"); 
      // Rep.AddPrintCell((PVO[0]),"r"); 
      // Rep.AddFormatCell(SQL_ConvTypeDate(DataSet.value("carry")),"r");
      N1_Portf = "Портфель обратного РЕПО";
      N1_Amount = PVO[1];
      N1_SumDeb = (PVO[2]);
      N1_SumCre = (PVO[3]);
      N1_Acc =  string(acc);
      N1_Fres = (PVO[0]);
      N1_Date = SQL_ConvTypeDate(DataSet.value("carry"));
      PrintLine(N1_DealCode, N1_DealDate, N1_Portf, N1_Amount, N1_SumDeb, N1_SumCre, N1_Acc, N1_Fres, N1_Date);

      if ((OVERCHANGE_PVO != 0) and (FR1 != 0)) 
            // Rep.AddStr();
            // Rep.AddFormatCell(DataSet2.DealCode,"r"); 
            // Rep.AddFormatCell(SQL_ConvTypeDate(DataSet2.DealDate),"r");
            // Rep.AddFormatCell("Портфель обратного РЕПО","r"); 
            // Rep.AddFormatCell(PVO[1],"r"); 
            // Rep.AddPrintCell(0,"C");
            // Rep.AddPrintCell(0,"C");
            // Rep.AddFormatCell(string(acc1),"r"); 
            // Rep.AddPrintCell(OVERCHANGE_PVO,"r"); 
            // Rep.AddFormatCell(SQL_ConvTypeDate(DataSet.value("carry")),"r");
            N1_DealCode = DataSet2.DealCode;
            N1_DealDate = SQL_ConvTypeDate(DataSet2.DealDate); 
            N1_Portf = "Портфель обратного РЕПО";
            N1_Amount = PVO[1];
            N1_SumDeb = 0; 
            N1_SumCre = 0; 
            N1_Acc = string(acc1);
            N1_Fres = OVERCHANGE_PVO;
            N1_Date = SQL_ConvTypeDate(DataSet.value("carry"));
            PrintLine(N1_DealCode, N1_DealDate, N1_Portf, N1_Amount, N1_SumDeb, N1_SumCre, N1_Acc, N1_Fres, N1_Date);
      end;
  end;
  if ((PKU.Size != 0) and PrintPKU)
      // Rep.AddStr();
      if ((DataSet.opr_id == -1) and (DataSet.opr_id1 == -1))
          // Rep.AddFormatCell("Проводка выполнена вручную. Нет данных","r"); 
          // Rep.AddFormatCell("Нет данных","r");
          N1_DealCode = "Проводка выполнена вручную. Нет данных";
          N1_DealDate = "Нет данных"; 
      elif (DataSet.opr_id1 != -1)
          //  Rep.AddFormatCell(DataSet2.DealCode,"r"); 
          //  Rep.AddFormatCell(SQL_ConvTypeDate(DataSet2.DealDate),"r"); 
           N1_DealCode = DataSet2.DealCode;
           N1_DealDate = SQL_ConvTypeDate(DataSet2.DealDate);   
      else
          //  Rep.AddFormatCell(DataSet2.DealCode,"r"); 
          //  Rep.AddFormatCell(SQL_ConvTypeDate(DataSet2.DealDate),"r"); 
           N1_DealCode = DataSet2.DealCode;
           N1_DealDate = SQL_ConvTypeDate(DataSet2.DealDate);   
      end;

      // Rep.AddFormatCell("Портфель контрольного участия","r"); 
      // Rep.AddFormatCell(PKU[1],"r"); 
      // Rep.AddPrintCell((PKU[2]),"r"); 
      // Rep.AddPrintCell((PKU[3]),"r"); 
      // Rep.AddFormatCell(string(acc),"r"); 
      // Rep.AddPrintCell((PKU[0]),"r"); 
      // Rep.AddFormatCell(SQL_ConvTypeDate(DataSet.value("carry")),"r");
      N1_Portf = "Портфель контрольного участия";
      N1_Amount = PKU[1];
      N1_SumDeb = (PKU[2]);
      N1_SumCre = (PKU[3]);
      N1_Acc =  string(acc);
      N1_Fres = (PKU[0]);
      N1_Date = SQL_ConvTypeDate(DataSet.value("carry"));
      PrintLine(N1_DealCode, N1_DealDate, N1_Portf, N1_Amount, N1_SumDeb, N1_SumCre, N1_Acc, N1_Fres, N1_Date);

      if ((OVERCHANGE_PKU != 0) and (FR1 != 0)) 
            // Rep.AddStr();
            // Rep.AddFormatCell(DataSet2.DealCode,"r"); 
            // Rep.AddFormatCell(SQL_ConvTypeDate(DataSet2.DealDate),"r");
            // Rep.AddFormatCell("Портфель контрольного участия","r"); 
            // Rep.AddFormatCell(PKU[1],"r"); 
            // Rep.AddPrintCell(0,"C");
            // Rep.AddPrintCell(0,"C");
            // Rep.AddFormatCell(string(acc1),"r"); 
            // Rep.AddPrintCell(OVERCHANGE_PKU,"r"); 
            // Rep.AddFormatCell(SQL_ConvTypeDate(DataSet.value("carry")),"r");
            N1_DealCode = DataSet2.DealCode;
            N1_DealDate = SQL_ConvTypeDate(DataSet2.DealDate); 
            N1_Portf = "Портфель контрольного участия";
            N1_Amount = PKU[1];
            N1_SumDeb = 0; 
            N1_SumCre = 0; 
            N1_Acc = string(acc1);
            N1_Fres = OVERCHANGE_PKU;
            N1_Date = SQL_ConvTypeDate(DataSet.value("carry"));
            PrintLine(N1_DealCode, N1_DealDate, N1_Portf, N1_Amount, N1_SumDeb, N1_SumCre, N1_Acc, N1_Fres, N1_Date);
      end;
  end;
  //  Rep.AddStr();
           
   return true;
END;

MACRO AvoirRep () /*BAI*/

  if (RepParm.Avoir != -1) /*Бумага выбрана*/
     fin.AddFilter ("t_fiid = '" + string(RepParm.Avoir) + "'");
     if (fin.Next())
         fi_code = fin.rec.FI_Code;
     else
         msgbox ("Не найдена ценная бумага с кодом = " + fi_code);
     end;
     fin.DropFilter();
 end;
 Query = " SELECT doc.t_chapter AS chapter, (SELECT t_fi_code ";
 Query = Query + "                  FROM dfininstr_dbt ";
 Query = Query + "                 WHERE t_fiid = doc.t_fiid_payer) AS cur, ";
 Query = Query + "       doc.t_account_payer AS debet, doc.t_account_receiver AS credit, ";
 Query = Query + "       doc.t_sum_payer AS amouint, doc.t_date_carry AS dat, ";
 Query = Query + "       doc.t_numb_document AS num, doc.t_ground AS ground, ";
 Query = Query + "       NVL ((SELECT t_id_operation ";
 Query = Query + "               FROM doprdocs_dbt ";
 Query = Query + "              WHERE t_acctrnid = doc.t_acctrnid), -1) AS opr_id, ";
 Query = Query + " NVL ( (SELECT GR.T_DOCID  ";
 Query = Query + "               FROM DDLGRDOC_DBT grdoc, DDLGRDEAL_DBT gr ";
 Query = Query + "              WHERE grdoc.t_docid = doc.t_acctrnid and grdoc.t_dockind = 1 ";
 Query = Query + "                    AND GR.T_ID = grdoc.T_GRDEALID), ";
 Query = Query + "               -1) AS opr_id1,  ";
 Query = Query + "       fin.t_fiid AS secur, fin.t_name AS securname, ";
 Query = Query + "       doc.t_date_carry AS carry";
 Query = Query + "  FROM dacctrn_dbt doc, dfininstr_dbt fin ";
 Query = Query + " WHERE (   (SUBSTR (doc.t_account_payer, 1, 5) = '61210') ";
 Query = Query + "        OR (SUBSTR (doc.t_account_receiver, 1, 5) = '61210')) ";
 Query = Query + "   AND doc.t_date_carry >= " + GetSQLDate (RepParm.BegDate);
 Query = Query + "   AND doc.t_date_carry <= " + GetSQLDate (RepParm.EndDate);
 if (RepParm.Avoir != -1) /*Бумага выбрана*/
     Query = Query + "   AND  fin.t_fiid = " + fin.rec.fiid;
 end;
 Query = Query + "   AND LPAD (fin.t_codeinaccount, 7, '0') = ";
 Query = Query + "          LPAD ";
 Query = Query + "             ((CASE ";
 Query = Query + "                  WHEN (SUBSTR (doc.t_account_payer, 1, 5) = '61210') ";
 Query = Query + "                     THEN SUBSTR (doc.t_account_payer, 16, 5) ";
 Query = Query + "                  ELSE SUBSTR (doc.t_account_receiver, 16, 5) ";
 Query = Query + "               END ),7,'0') ";
 Query = Query + "   AND (   doc.t_account_payer IN (SELECT DISTINCT (t_account) ";
 Query = Query + "          FROM dmcaccdoc_dbt accdoc ";
 Query = Query + "         WHERE t_catnum = 37) ";
 Query = Query + "        OR doc.t_account_receiver IN (SELECT DISTINCT (t_account) ";
 Query = Query + "             FROM dmcaccdoc_dbt accdoc ";
 Query = Query + "            WHERE t_catnum = 15) ";
 Query = Query + "       ) and DOC.T_STATE = 1  order by secur,doc.t_date_carry";

 DataSet = TRSBDataSet (Query, RSDVAL_CLIENT, RSDVAL_STATIC );
 DataSet.MoveLast();
 var count = DataSet.GetRecCount();
 var stat = DataSet.MoveFirst(); 

 InitProgress( count, "Отчет по финрезу",   "Просмотр проводок" );

 ok1 = -1;
 Var Num = 0;
 While (stat)
        ok = DataSet.securname;
        if (ok != ok1)
            PrintAvoirHeader(DataSet.securname);
            ok1 = DataSet.securname;
        end;
        All.size = 0;
        TP.size  = 0;
        PPR.size = 0;
        PVO.size = 0;
        PKU.size = 0;
        acc2 = "";

        if ((DataSet.opr_id == -1) and (DataSet.opr_id1 == -1))
            if(SUBSTR(DataSet.debet,1,5) == "61210")
               acc  = DataSet.credit;
               acc2 = DataSet.debet;
            else
               acc = DataSet.debet;
               acc2 = DataSet.credit;
            end;
            SumID = -1;
            Portfolio = -1;
        elif (DataSet.opr_id1 != -1)
            acc = "";
            Query2 = "  SELECT t2.t_dealcode, ";
            Query2 = Query2 + "       t2.t_portfolioid AS Portfolio, ";
            Query2 = Query2 + "       t3.t_principal AS SumID, ";
            Query2 = Query2 + "       t3.t_maturity, ";
            Query2 = Query2 + "       t2.t_dealdate AS dealdate ";
            Query2 = Query2 + "  FROM ddl_tick_dbt t2, ddl_leg_dbt t3 ";
            Query2 = Query2 + " WHERE     t2.t_dealid = " + DataSet.opr_id1;
            Query2 = Query2 + "       AND t3.t_dealid = t2.t_dealid ";
            Query2 = Query2 + "       AND (CASE ";
            Query2 = Query2 + "               WHEN ( (t2.t_dealtype = 2121) OR (t2.t_dealtype = 2131) OR (t2.t_dealtype = 2132) OR (t2.t_dealtype = 2122)) ";
            Query2 = Query2 + "               THEN  1 ";
            Query2 = Query2 + "               ELSE  0 ";
            Query2 = Query2 + "            END) = t3.t_legkind ";
            Query2 = Query2 + "       AND t3.t_legid = 0 ";
            DataSet2 = TRSBDataSet (Query2);
            DataSet2.MoveNext();
            SumID = DataSet2.SumID;
            Portfolio = DataSet2.Portfolio;
        else
            acc = "";
            Query2 = " select  t2.t_dealcode, t2.t_portfolioid as Portfolio, t3.t_principal as SumID, t3.t_maturity, t2.t_dealdate as dealdate ";
            Query2 = Query2 + "from        doproper_dbt t1, ddl_tick_dbt t2,  ddl_leg_dbt t3 ";
            Query2 = Query2 + "where  t1.t_id_operation = " + DataSet.opr_id;
            Query2 = Query2 + "   AND t2.t_dealid = TO_NUMBER (t1.t_documentid) ";
            Query2 = Query2 + "   AND t3.t_dealid = t2.t_dealid ";
            Query2 = Query2 + "   AND (CASE WHEN ((t2.t_dealtype = 2121) OR (t2.t_dealtype = 2131)) THEN 1 ELSE 0  END ) = t3.t_legkind ";
            Query2 = Query2 + "   AND t3.t_legid = 0 ";
            DataSet2 = TRSBDataSet (Query2);
            DataSet2.MoveNext();
            SumID = DataSet2.SumID;
            Portfolio = DataSet2.Portfolio;
         end;
         ПолучитьПроводкиНаШагах(DataSet2, DataSet, SumID, Portfolio, ALL, TP, PPR, PVO, PKU, ACC2);
         Num = Num + 1;
         UseProgress( Num );
         stat = DataSet.MoveNext();
  end;
  RemProgress;
  if (DataSet.debet == NULL)
      var Query1 = " SELECT doc.t_chapter AS chapter, (SELECT t_fi_code ";
          Query1 = Query1 + "                  FROM dfininstr_dbt ";
          Query1 = Query1 + "                 WHERE t_fiid = doc.t_fiid_payer) AS cur, ";
          Query1 = Query1 + "       doc.t_account_payer AS debet, doc.t_account_receiver AS credit, ";
          Query1 = Query1 + "       doc.t_sum_payer AS amouint, doc.t_date_carry AS dat, ";
          Query1 = Query1 + "       doc.t_numb_document AS num, doc.t_ground AS ground, ";
          Query1 = Query1 + "       NVL ((SELECT t_id_operation ";
          Query1 = Query1 + "               FROM doprdocs_dbt ";
          Query1 = Query1 + "              WHERE t_acctrnid = doc.t_acctrnid), -1) AS opr_id, ";
          Query1 = Query1+ "       fin.t_fiid AS secur, fin.t_name AS securname, ";
          Query1 = Query1 + "       doc.t_date_carry AS carry";
          Query1 = Query1 + "  FROM dacctrn_dbt doc, dfininstr_dbt fin ";
          Query1 = Query1 + " WHERE (   (SUBSTR (doc.t_account_payer, 1, 5) = '61210') ";
          Query1 = Query1 + "        OR (SUBSTR (doc.t_account_receiver, 1, 5) = '61210')) ";
          Query1 = Query1 + "   AND doc.t_date_carry >= " + GetSQLDate (RepParm.BegDate);
          Query1 = Query1 + "   AND doc.t_date_carry <= " + GetSQLDate (RepParm.EndDate);
      if (RepParm.Avoir != -1) /*Бумага выбрана*/
          Query1 = Query1 + "   AND  fin.t_fiid = " + fin.rec.fiid;
      end;
      Query1 = Query1 + "   AND LPAD (fin.t_codeinaccount, 7, '0') = ";
      Query1 = Query1 + "          LPAD ";
      Query1 = Query1 + "             ((CASE ";
      Query1 = Query1 + "                  WHEN (SUBSTR (doc.t_account_payer, 1, 5) = '61210') ";
      Query1 = Query1 + "                     THEN SUBSTR (doc.t_account_payer, 16, 5) ";
      Query1 = Query1 + "                  ELSE SUBSTR (doc.t_account_receiver, 16, 5) ";
      Query1 = Query1 + "               END ),7,'0') ";
      Query1 = Query1 + "   AND (   doc.t_account_payer IN (SELECT DISTINCT (t_account) ";
      Query1 = Query1 + "          FROM dmcaccdoc_dbt accdoc ";
      Query1 = Query1 + "         WHERE t_catnum = 37) ";
      Query1 = Query1 + "        OR doc.t_account_receiver IN (SELECT DISTINCT (t_account) ";
      Query1 = Query1 + "             FROM dmcaccdoc_dbt accdoc ";
      Query1 = Query1 + "            WHERE t_catnum = 15) ";
      Query1 = Query1  + "         or (SUBSTR (doc.t_account_payer, 1, 2) = '30')";
      Query1 = Query1 + "                    )";
      Query1 = Query1 + "        order by secur,doc.t_date_carry";
      var DataSet1 = TRSBDataSet (Query1, RSDVAL_CLIENT, RSDVAL_STATIC );
      DataSet1.MoveLast();
      count = DataSet1.GetRecCount();
      stat = DataSet1.MoveFirst(); 
      Num = 0;
      InitProgress( count, "Отчет по финрезу",   "Просмотр проводок" );
      ok1 = -1;
      While (stat)
             ok = DataSet1.securname;
             if (ok != ok1)
                 PrintAvoirHeader(DataSet1.securname);
                 ok1 = DataSet1.securname;
             end;
             All.size = 0;
             TP.size  = 0;
             PPR.size = 0;
             PVO.size = 0;
             acc2 = "";
             if (DataSet1.opr_id == -1)
                 if(SUBSTR(DataSet1.debet,1,5) == "61210")
                    acc  = DataSet1.credit;
                    acc2 = DataSet1.debet;
                 else
                    acc = DataSet1.debet;
                    acc2 = DataSet1.credit;
                 end;
                 SumID = -1;
                 Portfolio = -1;
             else
                 acc = "";
                 Query2 = " select  t2.t_dealcode, t2.t_portfolioid as Portfolio, t3.t_principal as SumID, t3.t_maturity, t2.t_dealdate as dealdate ";
                 Query2 = Query2 + "from        doproper_dbt t1, ddl_tick_dbt t2,  ddl_leg_dbt t3 ";
                 Query2 = Query2 + "where  t1.t_id_operation = " + DataSet1.opr_id;
                 Query2 = Query2 + "   AND t2.t_dealid = TO_NUMBER (t1.t_documentid) ";
                 Query2 = Query2 + "   AND t3.t_dealid = t2.t_dealid ";
                 Query2 = Query2 + "   AND (CASE WHEN ((t2.t_dealtype = 2121) OR (t2.t_dealtype = 2131)) THEN 1 ELSE 0  END ) = t3.t_legkind ";
                 Query2 = Query2 + "   AND t3.t_legid = 0 ";
                 DataSet2 = TRSBDataSet (Query2);
                 DataSet2.MoveNext();
                 SumID = DataSet2.SumID;
                 Portfolio = DataSet2.Portfolio;
             end;
             ПолучитьПроводкиНаШагах(DataSet2,DataSet1, SumID, Portfolio, ALL, TP, PPR, PVO, ACC2);
             Num = Num + 1;
             UseProgress( Num );
             stat = DataSet.MoveNext();
      end;
      RemProgress;
  end;
END;

MACRO Create( NumCopy:INTEGER )
  AvoirRep();
END;

  // CB_CReportTemplate( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI:BOOL, UseBigReportMode:BOOL, FocreFormatRep:INTEGER )
  initCB_CReportTemplate(NULL, "FinRes_Portf1_report.xlsx", true, null, null, true, true);
  // initCB_CReportTemplate(NULL, "FinRes_Portf1_report.xlsx", true, null, null, true, false);

end; // class FinResReport

MACRO SelectAvoir()
   if (ListAvoiriss (0, finin, avr, true))
       RepParm.Avoir = finin.FIID;
       dlg.Avoir = finin.FI_Code+" "+finin.Name;
   end;
END;

MACRO SelectPortf ()
   var p = TArray();
   var cl = -1;

   p[0] = "Торговый портфель";
   p[1] = "Портфель для перепродажи";
   p[2] = "Портфель обратного РЕПО";
   cl = Menu (p);
   if (cl >= 0)
      RepParm.Portf = cl;
      dlg.Portf = p[cl];
   end;
END;

MACRO DlgHandler(dlg, cmd, id, key)
   if ((cmd == DLG_REMFOCUS) and (id == fldBegDate))
          RepParm.BegDate = dlg.BegDate;
   elif ((cmd == DLG_REMFOCUS) and (id == fldEndDate))
          RepParm.EndDate = dlg.EndDate;
   elif (cmd == DLG_KEY)
      if (key == 317) /*F3*/
           if (id == fldAvoir)     /* Выбор финансового инструмента */
               SelectAvoir;
           elif (id == fldPortf)   /* Выбор владельца */
               SelectPortf;
           else
               return CM_IGNORE;
           end;
           UpdateFields (dlg);
           return CM_IGNORE;
      elif (key == 32)        /* Space */
           if (id == fldAvoir)     /* Выбор финансового инструмента */
               dlg.Avoir = "ВСЕ";
               RepParm.Avoir = -1;
           elif (id == fldPortf)   /* Выбор портфеля */
               dlg.Portf = "ВСЕ";
               RepParm.Portf = -1;
           else
               return CM_IGNORE;
           end;
           UpdateFields (dlg);
           return CM_IGNORE;
      elif ((key == 323) or ((key == 316)))   /* F2, F9 - выпустить отчёт */
            RepParm.BegDate = dlg.BegDate;
            RepParm.EndDate = dlg.EndDate;
            return CM_SAVE;
      end;                     
  end;
  return CM_DEFAULT;
END;

RepParm = RepData();

if (not RunDialog(dlg, "DlgHandler"))
   exit();
end;

if (RepParm.Portf == -1)
    PrintTP = true;
    PrintPPR = true;
    PrintPVO = true;
    PrintPKU = true;
elif (RepParm.Portf == 0)
    PrintTP = true;
elif (RepParm.Portf == 1)
    PrintPPR = true;
elif (RepParm.Portf == 2)
    PrintPVO = true;
end;
Rep = FinResReport( );
Rep.Run();
// PrintHeader();
// AvoirRep (); /*BAI*/

// if (rep.isDataExist)
//     Rep.PrintWinRep();
//     Rep.ShowWinRep();
// end; 
