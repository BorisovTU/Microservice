//ПФИ 
/*
dvkind - сделка
1 - 2690 Форвард, 12690 Внебиржевой форвард
2 - 12695 Внебиржевой опцион
3 - 22710 Валютный СВОП
4 - 22720 Процентный СВОП
5 - 12745 Покупка/продажа
6 - 2715 СВОП
7 - 12730 Покупка/продажа
8 - 2735 Банкнотная сделка, 12735 Банкнотная сделка
*/

import or_rep_h, globals, oralib, likepy, vslib, PTinter;
import RsbDataSet,rsd,FIInter;

private macro iif(a,b,c)
    if(a)
        return b;
    else
        return c;
    end;
end;

macro GetCurrDemLiab(dealcode,acc_mask)
  var sql,rs,query,query1,query2;
  var did = 0,dvkind = 0,type = 0;
  var CurrDemand,CurrLiability;

  query = "SELECT d.t_id,d.t_dvkind,d.t_type FROM ddvndeal_dbt d WHERE d.t_code = ?";
  sql = RSDCommand(query);
  sql.addParam("", RSDBP_IN, dealcode);
  sql.execute();

  rs = TRsbDataSet(sql);

  if (rs.MoveNext())
    did = rs.t_id;
    dvkind = rs.t_dvkind;
    type = rs.t_type;
  end;

  if (did != 0)
    query = "SELECT f.t_fiid,f.t_pricefiid FROM ddvnfi_dbt f WHERE f.t_dealid = ? ";
    if ( (dvkind == 1) or (dvkind == 2) ) //опцион и форвард
      sql = RSDCommand(query);
      sql.addParam("", RSDBP_IN, did);
      sql.execute();
      rs = TRsbDataSet(sql);
      if (rs.MoveNext())
        if (type == 1) //покупка БА
          CurrDemand = rs.t_fiid;
          CurrLiability = rs.t_pricefiid;
        else //соотвественно продажа
          CurrDemand = rs.t_pricefiid;
          CurrLiability = rs.t_fiid;
        end;
      end;
    elif (dvkind == 3) //Валютный своп, у него вторая нога - ПФИ
        query = query + " AND f.t_type = 2";
        sql = RSDCommand(query);
        sql.addParam("", RSDBP_IN, did);
        sql.execute();
        rs = TRsbDataSet(sql);
        if (rs.MoveNext())
          if (type == 5) //Покупка/продажа
            CurrDemand = rs.t_pricefiid;
            CurrLiability = rs.t_fiid;
          elif (type == 6) // Продажа/покупка
            CurrDemand = rs.t_fiid;
            CurrLiability = rs.t_fiid;
          end; 
        end;
    elif (dvkind == 4) //процентный своп
      query1 = query + " AND f.t_type = 0";
      query2 = query + " AND f.t_type = 2";

      sql = RSDCommand(query1);
      sql.addParam("", RSDBP_IN, did);
      sql.execute();
      rs = TRsbDataSet(sql);

      if (rs.MoveNext())
        CurrLiability = rs.t_fiid;
      end;

      sql = RSDCommand(query2);
      sql.addParam("", RSDBP_IN, did);
      sql.execute();
      rs = TRsbDataSet(sql);

      if (rs.MoveNext())
        CurrDemand = rs.t_fiid;
      end;
    end;
  end;

  if (acc_mask == "933")
    return CurrDemand;
  else
    return CurrLiability;
  end;

end;

macro GetAccOnDateByDeal(dealcode,ondate,acc_mask)
  var sql,rs,query;
  var did = 0;
  var Acc="";
  query = "SELECT d.t_id FROM ddvndeal_dbt d WHERE d.t_code = ?";
  sql = RSDCommand(query);
  sql.addParam("", RSDBP_IN, dealcode);
  sql.execute();

  rs = TRsbDataSet(sql);

  if (rs.MoveNext())
    did = rs.t_id;
  end;
  //Определим что есть требование, а что обязательство
  if (did != 0)

    //Теперь отберем нужные нам счета , действующи в сделке на отчетную дату
    query = "SELECT z.t_account FROM "+
    " ( "+
    " SELECT m.* FROM dmcaccdoc_dbt m WHERE m.t_dockind = 199 AND m.t_docid = ? "+
    " AND ( "+
    " (m.t_isusable = chr(88) AND m.t_activatedate <= ?) OR "+
    " (m.t_isusable = chr(0) AND (? >= m.t_activatedate AND ? < m.t_disablingdate) ) "+
    " ) "+
    " ) z WHERE substr(z.t_account,1,3) = ? AND z.t_currency = ? ";
    sql = RSDCommand(query);
    sql.addParam("", RSDBP_IN, did);
    sql.addParam("", RSDBP_IN, ondate);
    sql.addParam("", RSDBP_IN, ondate);
    sql.addParam("", RSDBP_IN, ondate);
    sql.addParam("", RSDBP_IN, acc_mask);
    sql.addParam("", RSDBP_IN, GetCurrDemLiab(dealcode,acc_mask));
    sql.execute();
    rs = TRsbDataSet(sql);
    if (rs.MoveNext())
      Acc = rs.t_account;
    end;
  end;

  return Acc;

end;

macro GetRestAccOnDate(acc,ondate,eq):money
  var sql,rs,query;
  var cur,ch,rest = $0;
  query = "SELECT * FROM daccount_dbt a WHERE a.t_account = ?";
  sql = RSDCommand(query);
  sql.addParam("", RSDBP_IN, acc);
  sql.execute();
  rs = TRsbDataSet(sql);
  if (rs.MoveNext())
    query = "SELECT rsi_rsb_account.restall(?,?,?,?,?) AS rst FROM dual";
    sql = RSDCommand(query);
    sql.addParam("", RSDBP_IN, rs.t_account);
    sql.addParam("", RSDBP_IN, rs.t_chapter);
    sql.addParam("", RSDBP_IN, rs.t_code_currency);
    sql.addParam("", RSDBP_IN, ondate);
    sql.addParam("", RSDBP_IN, iif(eq,NATCUR,null));
    sql.execute();
    rs = TRsbDataSet(sql);
    if (rs.MoveNext())
      rest = rs.rst;
    end;
  end;

  return rest;
end;

macro GetCloseDate (maturity:date, expiry:date)
  var retVal:date = Date(0, 0, 0);
  if (maturity != retVal) 
    retVal = maturity;
  elif (expiry != retVal)
    retVal = expiry;
  end;
  return retVal;
End;

private macro BaIsCB (baseac):bool
  if ( (strlen(baseac) > 3) and (Index(baseac,"ставка") == 0) )
    return true;
  else
    return false;
  end;
end;

private macro GetNatRateEmit(cb,type,dt)
  //type : 436 - АКРА , 367 - Эксперт РА
  var sql,rs;
  var ret = 0;
  sql = "SELECT nvl(SECUR_DWHINFO.GetRate( "+
  " (select f.t_issuer from dfininstr_dbt f, davoiriss_dbt av where av.t_fiid = f.t_fiid and av.t_isin = '"+cb+"' and av.t_spisclosed = chr(0)), "+
  " 3, 19, "+type+", to_date('"+dt+"','dd.mm.yyyy')), chr(0)) as rate FROM dual ";
  rs = ExecSqlSelect(sql);

  if (rs.MoveNext())
    ret = rs.value("rate");
  end;

  return ret;
end;

private macro IsBirzhDeal(deal):bool
  var sql,rs;
  var ret = false;
  sql = "select d.t_sector as sec from ddvndeal_dbt d where d.t_sector = chr(88) and d.t_code = :deal";
  rs = ExecSqlSelect(sql, MakeArray(SqlParam("deal", deal)), false); 

  if (rs.MoveNext())
    if ( rs.value("sec") == SET_CHAR )
      ret = false;
    end;
  end;

  return ret;
end;

private macro GenAgrType(deal)
  var sql,rs;
  var ret = " ";
  sql = "SELECT nvl(ag.t_code,chr(0)) as Type "+
  " FROM DDL_GENAGR_DBT t, DLLVALUES_DBT dl, DIR_TYPEAGREEMENT_DBT ag "+
  " WHERE t.t_genagrid = "+
  " (select d.t_genagrid from ddvndeal_dbt d where d.t_code = :dealcode ) "+
  " AND dl.t_list = 4018 " +
  " AND dl.t_element = t.t_version_gs " +
  " AND ag.t_id = t.t_type_gs ";
  rs = ExecSqlSelect(sql, MakeArray(SqlParam("dealcode", deal)), false);

  if (rs.MoveNext())
    ret = rs.value("Type");
  end;

  return ret;

end;

macro f657_7 ()
  var color = 16777062;
  var head_format = "c:ex_FS(b):ex_B(tblr):ex_BC(" + color + ")";
  var line_format = "r:ex_B(tblr):ex_FZ(8)";
  var line_format_l = "l:ex_B(tblr):ex_FZ(8)";
  var repdate = {curdate};
  var rn:integer = 0;
  var sheet = 1;
  var count = 0;
  var Rep, sql;
  var IsCB:bool = false;
  var OnlyCB:bool = false;
  var DAcc,LAcc,DCur,LCur; /* MDA */
  if (not GetDate(repdate))
    return 0;
  end;

  if( MsgBoxEx("Формировать только по ценным бумагам ?", MB_YES + MB_NO, IND_NO) == IND_YES )
    OnlyCB = true;
  end;

  /*33 колоноки*/
  Rep = CMakereport("┌─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┐");

  Rep.SetDefaultFontName("Times New Roman");
  Rep.SetDefaultFontSize(10);
  Rep.SetFlagShowGrid(true);
  Rep.SetExecute("iBook.Sheets("+sheet+").Rows().RowHeight = 12.75;");

  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(1).ColumnWidth = 8;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(2).ColumnWidth = 11;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(3).ColumnWidth = 30;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(4).ColumnWidth = 11.57;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(5).ColumnWidth = 10;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(6).ColumnWidth = 10;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(7).ColumnWidth = 16;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(8).ColumnWidth = 8.57;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(9).ColumnWidth = 10.29;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(10).ColumnWidth = 10.29;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(11).ColumnWidth = 11;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(12).ColumnWidth = 11;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(13).ColumnWidth = 11.86;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(14).ColumnWidth = 23;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(15).ColumnWidth = 11;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(16).ColumnWidth = 11;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(17).ColumnWidth = 8;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(18).ColumnWidth = 10;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(19).ColumnWidth = 10;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(20).ColumnWidth = 17.43;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(21).ColumnWidth = 10.29;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(22).ColumnWidth = 11;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(23).ColumnWidth = 11;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(24).ColumnWidth = 17.43;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(25).ColumnWidth = 10.29;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(26).ColumnWidth = 11;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(27).ColumnWidth = 11;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(28).ColumnWidth = 17.43;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(29).ColumnWidth = 11;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(30).ColumnWidth = 11;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(31).ColumnWidth = 11;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(32).ColumnWidth = 11;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(33).ColumnWidth = 10.29;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(34).ColumnWidth = 11;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(35).ColumnWidth = 11;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(36).ColumnWidth = 13.86;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(37).ColumnWidth = 11;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(38).ColumnWidth = 11;");

  rn = rn + 1;
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"A"+rn+":F"+rn+"\").merge;");
  Rep.AddPrintCell("Информация о срочных сделках и сделках с ПФИ по состоянию на " + string(repdate), 0, 0, "r:ex_B():ex_FS():ex_FZ(8)");

  //Rep.AddPrintCell("Информация о сделках ПФИ с базовым активом- иностр. валюта ", 0, 0, );
  Rep.AddStr();


  rn = rn + 1;
  Rep.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").RowHeight = 127.5;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"M"+rn+":N"+rn+"\").RowHeight = 30.5;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"AH"+rn+":AI"+rn+"\").RowHeight = 30.5;");
  
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"A"+rn+":A"+(rn+1)+"\").Merge;"); 
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"B"+rn+":B"+(rn+1)+"\").Merge;"); 
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"C"+rn+":C"+(rn+1)+"\").Merge;"); 
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"D"+rn+":D"+(rn+1)+"\").Merge;"); 
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"E"+rn+":E"+(rn+1)+"\").Merge;"); 
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"F"+rn+":F"+(rn+1)+"\").Merge;"); 
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"G"+rn+":G"+(rn+1)+"\").Merge;"); 
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"H"+rn+":H"+(rn+1)+"\").Merge;"); 
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"I"+rn+":I"+(rn+1)+"\").Merge;"); 
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"J"+rn+":J"+(rn+1)+"\").Merge;"); 
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"K"+rn+":K"+(rn+1)+"\").Merge;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"L"+rn+":L"+(rn+1)+"\").Merge;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"M"+rn+":M"+(rn+1)+"\").Merge;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"N"+rn+":N"+(rn+1)+"\").Merge;");
  //Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"O"+rn+":O"+(rn+1)+"\").Merge;");
  //Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"P"+rn+":P"+(rn+1)+"\").Merge;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"Q"+rn+":Q"+(rn+1)+"\").Merge;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"R"+rn+":R"+(rn+1)+"\").Merge;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"S"+rn+":S"+(rn+1)+"\").Merge;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"T"+rn+":T"+(rn+1)+"\").Merge;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"U"+rn+":U"+(rn+1)+"\").Merge;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"V"+rn+":V"+(rn+1)+"\").Merge;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"W"+rn+":W"+(rn+1)+"\").Merge;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"X"+rn+":X"+(rn+1)+"\").Merge;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"Y"+rn+":Y"+(rn+1)+"\").Merge;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"Z"+rn+":Z"+(rn+1)+"\").Merge;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"AA"+rn+":AA"+(rn+1)+"\").Merge;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"AB"+rn+":AB"+(rn+1)+"\").Merge;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"AC"+rn+":AC"+(rn+1)+"\").Merge;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"AD"+rn+":AD"+(rn+1)+"\").Merge;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"AE"+rn+":AE"+(rn+1)+"\").Merge;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"AF"+rn+":AF"+(rn+1)+"\").Merge;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"AG"+rn+":AG"+(rn+1)+"\").Merge;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"O"+rn+":P"+rn+"\").Merge;");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"AH"+rn+":AI"+rn+"\").Merge;");

  //Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"AH"+rn+":AH"+(rn+1)+"\").Merge;");
  //Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"AI"+rn+":AI"+(rn+1)+"\").Merge;");

  //Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"A"+rn+":AF"+rn+"\").VerticalAlignment = "+ALIGN_CENTER+";");
  //Добавляем заголовок


  Rep.AddStr();
  rn = rn + 1;

  Rep.AddPrintCell("№ сделки п/п",                                                             0, 0, head_format);
  Rep.AddPrintCell("Номер сделки",                                                             0, 0, head_format);
  Rep.AddPrintCell("Контрагент",                                                               0, 0, head_format);
  Rep.AddPrintCell("Соглашение на основании которого заключена сделка (RISDA/ISDA)",           0, 0, head_format);
  Rep.AddPrintCell("Вид контрагента (КО/ЮЛ)",                                                  0, 0, head_format);
  Rep.AddPrintCell("Тип сделки (ПФИ/срочная)",                                                 0, 0, head_format);
  Rep.AddPrintCell("Страна",                                                                   0, 0, head_format);
  Rep.AddPrintCell("Страновая оценка",                                                         0, 0, head_format);
  Rep.AddPrintCell("Рейтинг контрагента на отчетную дату",                                     0, 0, head_format);
  Rep.AddPrintCell("Рейтинг контрагента в соответствии с  Указанием 3453-У",                   0, 0, head_format);
  Rep.AddPrintCell("Национальный рейтинг Эмитента контрагента на отчетную дату АКРА",          0, 0, head_format);
  Rep.AddPrintCell("Национальный рейтинг Эмитента контрагента на отчетную дату Эксперт РА",    0, 0, head_format);
  Rep.AddPrintCell("Наименование инструмента",                                                 0, 0, head_format);
  Rep.AddPrintCell("Базовый актив ",                                                           0, 0, head_format);
  Rep.AddPrintCell("Вид сделки",                                                               0, 0, head_format);
  Rep.AddPrintCell("",                                                                         0, 0, head_format);
  Rep.AddPrintCell("Направление сделки  (покупка/продажа)",                                    0, 0, head_format);
  Rep.AddPrintCell("Дата заключения сделки",                                                   0, 0, head_format);
  Rep.AddPrintCell("Дата окончания сделки",                                                    0, 0, head_format);
  Rep.AddPrintCell("Лицевой счет требований (базового актива)",                                0, 0, head_format);
  Rep.AddPrintCell("Валюта требований",                                                        0, 0, head_format);
  Rep.AddPrintCell("Сумма требований (в ин.валюте)",                                           0, 0, head_format);
  Rep.AddPrintCell("Сумма требований (в руб.экв-те)",                                          0, 0, head_format);
  Rep.AddPrintCell("Лицевой счет обязательств ",                                               0, 0, head_format);
  Rep.AddPrintCell("Валюта счета обязательств ",                                               0, 0, head_format);
  Rep.AddPrintCell("Сумма обязательств (в ин.валюте)",                                         0, 0, head_format);
  Rep.AddPrintCell("Сумма обязательств (в руб.эквиваленте)",                                   0, 0, head_format);
  Rep.AddPrintCell("Лицевой счет по учету справедливой стоимости ПФИ",                         0, 0, head_format);
  Rep.AddPrintCell("Справедливая стоимость актива",                                            0, 0, head_format);
  Rep.AddPrintCell("Справедливая стоимость обязательства",                                     0, 0, head_format);
  Rep.AddPrintCell("Наличие в соглашении по сделке условия ликвидационного неттинга (ДА/НЕТ)", 0, 0, head_format);
  Rep.AddPrintCell("Наличие в соглашении по сделке условия расчетного неттинга (ДА/НЕТ)",      0, 0, head_format);
  Rep.AddPrintCell("Сделка зарегистрирована в репозитарии (ДА/НЕТ)",                           0, 0, head_format);
  Rep.AddPrintCell("Процентные свопы",                                                         0, 0, head_format);
  Rep.AddPrintCell("",                                                                         0, 0, head_format);
  Rep.AddStr();


  rn = rn + 1;
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"A"+rn+":AI"+rn+"\").VerticalAlignment = "+ALIGN_CENTER+";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"K"+rn+":L"+rn+"\").RowHeight = 87;");
  //Rep.SetExecute("iBook.Sheets("+sheet+").Range(\"AG"+rn+":AH"+rn+"\").Interior.Color =  " + COLOR + " ;");

  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);                                                                                 
  Rep.AddPrintCell("постановочная/ беспоставочная", 0, 0, head_format);
  Rep.AddPrintCell("биржевая/ внебиржевая", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("", 0, 0, head_format);
  Rep.AddPrintCell("Ближайшая дата пересмотра процентной ставки",                   0, 0, head_format);
  Rep.AddPrintCell("№ счета 2-го порядка позиции с плавающей процентной ставкой.",  0, 0, head_format);
  Rep.AddStr();


  rn = rn + 1;
  //while (count < 33)
  /*
  while (count < 35)
    Rep.AddPrintCell(count = count + 1, 0, 0, "c:ex_B(tblr)");
  end;
  rep.AddStr();*/
  
/*
  sql = " select dvndeal.t_code extcode, \n"
      + "       contractor.t_name contractor, \n"
      + "       case when isbank.t_partyid is null then 'Юр. лицо' \n"
      + "            else 'Кредитная организация' \n"
      + "       end contractorkind, \n"
      + "       contractor.t_nrcountry country, \n"
      + "       dvndeal.t_genagrid genagrid, \n"
      + "       (select (select t_code from DIR_TYPEAGREEMENT_DBT where t_id = genagr.t_type_gs) \n"
      + "                    from ddl_genagr_dbt genagr where t_genagrid = dvndeal.t_genagrid), ' ') genagrtype, \n"
      + "       dvndeal.* \n"
      + "from ddvndeal_dbt dvndeal, ddvnfi_dbt dvnfi, dparty_dbt contractor \n"
      + "left join dpartyown_dbt isbank on isbank.t_partyid = contractor.t_partyid and isbank.t_partykind = 2 \n"
      + "where 1=1 \n"
      + "      and contractor.t_partyid = dvndeal.t_contractor \n"
      + "      and dvndeal.t_sector <> chr(88) \n"
      + "      --and t_code in('381', '1007') \n"
      + "      --and dvndeal.t_kind = 12745 \n"
      + "      and dvnfi.t_dealid = dvndeal.t_id \n"
      + "      and dvnfi.t_type = case when (dvndeal.t_dvkind in (3, 4, 6)) then 2 else 0 end \n"
      + "      and :dt1 >= case when dvndeal.t_dvkind = 4 then t_begindate else t_date end \n"
      + "      and dvnfi.t_execdate >= :dt2 \n"
      + "order by dvndeal.t_id desc \n";
*/

  var Params:TArray;
  Params = makeArray(SQLParam("", repdate));
  count = 0;
  InitProgress(-1, "Сбор данных");
  execSQL ("DELETE FROM TRSHB_PFI_PKL_2CHD WHERE REPORT_DT = ?",Params);                                                                                                                                                                                                               
  execSQL ("begin rsFillPFI(?);end;",Params);   //SOFR_PKL_Start.mac macro PFI(dateIn)                                                                                                                                                                                                 
  RemProgress();                                                                                                                                                                                                                                                                       
  //Добавляем в вывод сделки срочного рынка                                                                                                                                                                                                                                            
  var cmd = " select distinct(fi.t_name),                                                                                                                                                                                                                                              "+  
            "          'Банк НКЦ AО', ' ',                                                                                                                                                                                                                                             "+            
            "           'Банк', 'ПФИ',                                                                                                                                                                                                                                                 "+             
            "           'Российская Федерация',                                                                                                                                                                                                                                        "+             
            "           '4', ' ', ' ', ' ', ' ',                                                                                                                                                                                                                                       "+             
            "           'Фьючерс', fi.t_definition,                                                                                                                                                                                                                                    "+             
            "           'Беспоставочная', 'Биржевая',                                                                                                                                                                                                                                  "+             
            "           decode (ddv.t_type, 'S', 'Продажа', 'Покупка' ),                                                                                                                                                                                                               "+             
            "           'date',                                                                                                                                                                                                                                                        "+
            "           fi.t_drawingdate,                                                                                                                                                                                                                                              "+ 
            "           CDOCT.T_ACCOUNT,                                                                                                                                                                                                                                               "+             
            "           (select t_fi_code from dfininstr_dbt where t_fiid = acct.t_code_currency) as fiid,                                                                                                                                                                             "+             
            "           abs(decode (acct.t_code_currency, 0, 0, trebsum.sss)) as trebsur,                                                                                                                                                                                              "+             
            "           abs(decode (acct.t_code_currency, 0,nvl( trebsum.sss, 0),RSB_FIInstr.ConvSumtype(trebsum.sss,acct.t_code_currency, 0,7,:reportdate) )) as trebrur,                                                                                                             "+             
            "           CDOCO.T_ACCOUNT,                                                                                                                                                                                                                                               "+             
            "           (select t_fi_code from dfininstr_dbt where t_fiid = acco.t_code_currency) as fiid,                                                                                                                                                                             "+             
            "           abs(decode (acco.t_code_currency, 0, 0, obsum.sss)) as obsur,                                                                                                                                                                                                  "+             
            "           abs(decode (acco.t_code_currency, 0, obsum.sss,RSB_FIInstr.ConvSumtype(obsum.sss,acco.t_code_currency, 0,7,:reportdate) )) as obrur,                                                                                                                           "+             
            "           ' ' , 0, 0, 'ДА', 'ДА', 'НЕТ',' ' ,' ',                                                                                                                                                                                                                        "+
            "           ddv.t_fiid, ddv.t_kind                                                                                                                                                                                                                                         "+
            "           from ddvdeal_dbt ddv                                                                                                                                                                                                                                           "+             
            "           LEFT JOIN DFININSTR_DBT fi on FI.T_FIID = ddv.t_fiid                                                                                                                                                                                                           "+             
            "           left join dmcaccdoc_dbt cdocT on CDOCT.T_DOCID = ddv.t_id and cdocT.t_catid = 781                                                                                                                                                                              "+             
            "           left join daccount_dbt accT on ACCT.T_ACCOUNT = CDOCT.T_ACCOUNT                                                                                                                                                                                                "+             
            "           left join (select t_rest as sss,t_accountid  from drestdate_dbt rd where t_restdate = (select max(t_restdate)from drestdate_dbt rd1 where t_restdate <:reportdate and rd1.t_accountid = rd.t_accountid)) trebsum on trebsum.t_accountid =ACCT.T_ACCOUNTID      "+             
            "           left join dmcaccdoc_dbt cdocO on CDOCO.T_DOCID = ddv.t_id and cdocO.t_catid = 782                                                                                                                                                                              "+             
            "           left join daccount_dbt accO on ACCO.T_ACCOUNT = CDOCO.T_ACCOUNT                                                                                                                                                                                                "+             
            "           left join (select t_rest as sss,t_accountid  from drestdate_dbt rd where t_restdate = (select max(t_restdate)from drestdate_dbt rd1 where t_restdate <:reportdate and rd1.t_accountid = rd.t_accountid)) obsum on obsum.t_accountid =ACCo.T_ACCOUNTID          "+             
            "           where ddv.t_client = -1 and ddv.t_date <= :reportdate and fi.t_drawingdate>=:reportdate and obsum.sss<>0 and trebsum.sss<>0                                                                                                                                    ";
  cmd = ExecSqlSelect(cmd, MakeArray(SqlParam("reportdate", repdate)), false);
  count = 0;
  InitProgress(-1, "Сбор данных");

  while (cmd.MoveNext())
    Rep.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = true;");

    Rep.AddPrintCell(count+1, 0, 0, line_format);                              // 1. Номер п/п
    Rep.AddPrintCell(cmd.value(0), 0, 0, line_format);             // 2. Номер сделки
    Rep.AddPrintCell(cmd.value(1), 0, 0, line_format_l);               // 3. Контрагент
    Rep.AddPrintCell(cmd.value(2), 0, 0, line_format);          // 4. Ген. соглашение (RISDA/ISDA)
    Rep.AddPrintCell(cmd.value(3), 0, 0, line_format);            // 5. Вид контрагента
    Rep.AddPrintCell(cmd.value(4), 0, 0, line_format);               // 6. Тип сделки (ПФИ/Срочная)
    Rep.AddPrintCell(cmd.value(5), 0, 0, line_format_l);               // 7. Страна
    Rep.AddPrintCell(cmd.value(6), 0, 0, line_format);          // 8. Страновая оценка
    Rep.AddPrintCell(cmd.value(7), 0, 0, line_format);             // 9. Рейтинг контрагента на отчетную дату
    Rep.AddPrintCell(cmd.value(8), 0, 0, line_format);       // 10.Рейтинг контрагента в соответствии с  Указанием 3453-У
    Rep.AddPrintCell(cmd.value(9), 0, 0, line_format); //11 Национальный рейтинг Эмитента АКРА
    Rep.AddPrintCell(cmd.value(10), 0, 0, line_format); //12 Национальный рейтинг Эмитента Эксперт РА
    Rep.AddPrintCell(cmd.value(11), 0, 0, line_format);             // 13.Наименование инструмента
    Rep.AddPrintCell(cmd.value(12), 0, 0, line_format_l);           // 14.Базовый актив 
    Rep.AddPrintCell(cmd.value(13), 0, 0, line_format_l);           // 15.Вид сделки (поставочная/ беспоставочная)
    Rep.AddPrintCell(cmd.value(14), 0, 0, line_format_l);         // 16.Вид сделки (биржевая/ внебиржевая)
    Rep.AddPrintCell(cmd.value(15), 0, 0, line_format);          // 17.Направление сделки  (покупка/продажа)
    /*если джойнить этот селект к предыдущему, то работает довольно долго, поэтому для дат заключения сделок отдельный селект*/
    var cmd1 = " SELECT listagg(TO_CHAR(t_date, 'dd.mm.yyyy'), '/ ') WITHIN GROUP (ORDER BY t_date) AS t_date                "+
               "   FROM (SELECT DISTINCT ddv.t_date, t_fiid,  t_kind                                                         "+
               "           FROM ddvdeal_dbt ddv                                                                              "+
               "                LEFT JOIN ddvdlturn_dbt turn                                                                 "+
               "                  ON ddv.t_id = TURN.T_DEALID                                                                "+
               "                     AND TURN.T_DATE = (SELECT MAX(turn2.t_date)                                             "+
               "                                          FROM ddvdlturn_dbt turn2                                           "+
               "                                         WHERE turn2.t_dealid = ddv.t_id  AND turn2.t_date <= :reportdate)   "+
               "          WHERE t_client = -NVL(1, UID)  AND turn.t_execution < ddv.t_amount                                 "+
               "            AND ddv.t_date <=:reportdate2)                                                                   "+
               "            where t_fiid = :fiid   and t_kind = :kind                                                        ";
    cmd1 = ExecSqlSelect(cmd1, MakeArray(SqlParam("reportdate", repdate), SqlParam("reportdate2", repdate),SqlParam("fiid", cmd.value(34)),SqlParam("kind", cmd.value(35)) ), false);


    Rep.AddPrintCell(cmd.value(16), 0, 0, line_format);          // 18.Дата заключения сделки
    Rep.AddPrintCell(date(cmd.value(17)), 0, 0, line_format);            // 19.Дата окончания сделки
    Rep.AddPrintCell(cmd.value(18), 0, 0, line_format);          // 18.Лицевой счет требований
    Rep.AddPrintCell(cmd.value(19), 0, 0, line_format);         // 19.Валюта счета требований
    Rep.AddPrintCell(cmd.value(20), 0, 0, line_format);   
    Rep.AddPrintCell(cmd.value(21), 0, 0, line_format_l); 
    Rep.AddPrintCell(cmd.value(22), 0, 0, line_format);   
    Rep.AddPrintCell(cmd.value(23), 0, 0, line_format);   
    Rep.AddPrintCell(cmd.value(24), 0, 0, line_format);   
    Rep.AddPrintCell(cmd.value(25), 0, 0, line_format_l); 
    Rep.AddPrintCell(cmd.value(26), 0, 0, line_format);   
    Rep.AddPrintCell(cmd.value(27), 0, 0, line_format);   
    Rep.AddPrintCell(cmd.value(28), 0, 0, line_format);   
    Rep.AddPrintCell(cmd.value(29), 0, 0, line_format); //
    Rep.AddPrintCell(cmd.value(30), 0, 0, line_format); 
    Rep.AddPrintCell(cmd.value(31), 0, 0, line_format);  
    Rep.AddPrintCell(cmd.value(32), 0, 0, line_format_l);
    Rep.AddPrintCell(cmd.value(33), 0, 0, line_format_l);
    Rep.AddStr(); 
    UseProgress(count = count + 1);
    rn = rn + 1;
  end;    







  //mda 02.03.2019 Чтобы не лазить в логику процедуры , внесем правки в отображаемую форму Excel
  //sql = "SELECT tpfi.* FROM TRSHB_PFI_PKL_2CHD tpfi  WHERE TPFI.REPORT_DT = :dt1";
  sql = "SELECT tpfi.DEAL_NUMBER, "+
  " tpfi.SUBJECT, " +
  " nvl(tpfi.AGREEMENT_TYPE,chr(0)) as AGREEMENT_TYPE, " +
  " tpfi.SUBJECT_TYPE, " +
  " tpfi.DEAL_TYPE, " +
  " tpfi.COUNTRY, " +
  " tpfi.COUNTRY_RATING, " +
  " nvl(tpfi.SUBJ_RATING,chr(0)) as SUBJ_RATING, " +
  " nvl(tpfi.SUBJ_RATING_3453U,chr(0)) as SUBJ_RATING_3453U, " +
  " tpfi.FINSTR_NAME, " +
  " tpfi.BASE_ACTIVE, " +
  " tpfi.DEAL_SUPPLY, " +
  " tpfi.DEAL_EXCHANGE, " +
  " tpfi.DEAL_DIRECTION, " +
  " tpfi.BEGIN_DT, " +
  " tpfi.END_DT, " +
  " nvl(tpfi.ACCOUNT_DEMAND,chr(0)) as ACCOUNT_DEMAND," +
  " nvl(tpfi.CURRENCY_DEMAND,chr(0)) as CURRENCY_DEMAND, " +
  " nvl(tpfi.AMOUNT_DEMAND_VAL,0) as AMOUNT_DEMAND_VAL, " +
  " nvl(tpfi.AMOUNT_DEMAND_RUR,0) as AMOUNT_DEMAND_RUR, " +
  " nvl(tpfi.ACCOUNT_LIABILITY,chr(0)) as ACCOUNT_LIABILITY, " +
  " nvl(tpfi.CURRENCY_LIABILITY,chr(0)) as CURRENCY_LIABILITY, " +
  " nvl(tpfi.AMOUNT_LIABILITY_VAL,0) as AMOUNT_LIABILITY_VAL, " +
  " nvl(tpfi.AMOUNT_LIABILITY_RUR,0) as AMOUNT_LIABILITY_RUR, " +
  " nvl(tpfi.ACCOUNT_SS,chr(0)) as ACCOUNT_SS, " +
  " nvl(tpfi.AMOUNT_SS_ACTIVE,0) as AMOUNT_SS_ACTIVE, " +
  " nvl(tpfi.AMOUNT_SS_LIABILITY,0) as AMOUNT_SS_LIABILITY, " +
  " nvl(tpfi.IS_LIQ_NETTING,chr(0)) as IS_LIQ_NETTING, " +
  " nvl(tpfi.IS_CLC_NETTING,chr(0)) as IS_CLC_NETTING, " +
  " nvl(tpfi.IS_REPOSITORY,chr(0)) as IS_REPOSITORY, " +
  " nvl(tpfi.SWAP_PRC_CHANGE_DT,DATE'0001-01-01') as SWAP_PRC_CHANGE_DT, " +
  " nvl(tpfi.SWAP_BAL_ACC_FLOAT_RATE,chr(0)) as SWAP_BAL_ACC_FLOAT_RATE " +
  " FROM TRSHB_PFI_PKL_2CHD tpfi  WHERE TPFI.REPORT_DT = :dt1";
  sql = ExecSqlSelect(sql, MakeArray(SqlParam("dt1", repdate)), false);



  rn = rn + 1;
  var fornum;
  while (sql.MoveNext())
    IsCB = false;
    if ( BaIsCB(sql.value("BASE_ACTIVE")) )
      IsCB = true;
    end;

    if ( OnlyCB and (IsCB == false) )
      rn = rn + 1;
      continue;
    end;
    /*MDA 19.03.2019*/
    if (IsCB == false)
      DAcc = GetAccOnDateByDeal(sql.value("DEAL_NUMBER"),repdate,"933");
      LAcc = GetAccOnDateByDeal(sql.value("DEAL_NUMBER"),repdate,"963");
      DCur = ПолучитьКодФинИн(GetCurrDemLiab(sql.value("DEAL_NUMBER"),"933"));
      LCur = ПолучитьКодФинИн(GetCurrDemLiab(sql.value("DEAL_NUMBER"),"963"));
    end;
    /*MDA 19.03.2019 END*/
    Rep.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = true;");

    Rep.AddPrintCell(count+1, 0, 0, line_format);                              // 1. Номер п/п
    Rep.AddPrintCell(sql.value("DEAL_NUMBER"), 0, 0, line_format);             // 2. Номер сделки
    Rep.AddPrintCell(sql.value("SUBJECT"), 0, 0, line_format_l);               // 3. Контрагент
    //Rep.AddPrintCell(sql.value("AGREEMENT_TYPE"), 0, 0, line_format);          // 4. Ген. соглашение (RISDA/ISDA)
    Rep.AddPrintCell(GenAgrType(sql.value("DEAL_NUMBER")), 0, 0, line_format);          // 4. Ген. соглашение (RISDA/ISDA)
    Rep.AddPrintCell(sql.value("SUBJECT_TYPE"), 0, 0, line_format);            // 5. Вид контрагента
    Rep.AddPrintCell(sql.value("DEAL_TYPE"), 0, 0, line_format);               // 6. Тип сделки (ПФИ/Срочная)
    Rep.AddPrintCell(sql.value("COUNTRY"), 0, 0, line_format_l);               // 7. Страна
    Rep.AddPrintCell(sql.value("COUNTRY_RATING"), 0, 0, line_format);          // 8. Страновая оценка
    Rep.AddPrintCell(sql.value("SUBJ_RATING"), 0, 0, line_format);             // 9. Рейтинг контрагента на отчетную дату
    Rep.AddPrintCell(sql.value("SUBJ_RATING_3453U"), 0, 0, line_format);       // 10.Рейтинг контрагента в соответствии с  Указанием 3453-У
    if (IsCB)
      Rep.AddPrintCell(GetNatRateEmit(sql.value("BASE_ACTIVE"),436,repdate), 0, 0, line_format); //11 Национальный рейтинг Эмитента АКРА
      Rep.AddPrintCell(GetNatRateEmit(sql.value("BASE_ACTIVE"),367,repdate), 0, 0, line_format); //12 Национальный рейтинг Эмитента Эксперт РА
    end;
    Rep.AddPrintCell(sql.value("FINSTR_NAME"), 0, 0, line_format);             // 13.Наименование инструмента
    Rep.AddPrintCell(sql.value("BASE_ACTIVE"), 0, 0, line_format_l);           // 14.Базовый актив 
    Rep.AddPrintCell(sql.value("DEAL_SUPPLY"), 0, 0, line_format_l);           // 15.Вид сделки (поставочная/ беспоставочная)
    Rep.AddPrintCell(sql.value("DEAL_EXCHANGE"), 0, 0, line_format_l);         // 16.Вид сделки (биржевая/ внебиржевая)
    Rep.AddPrintCell(sql.value("DEAL_DIRECTION"), 0, 0, line_format);          // 17.Направление сделки  (покупка/продажа)
    Rep.AddPrintCell(date(sql.value("BEGIN_DT")), 0, 0, line_format);          // 18.Дата заключения сделки
    Rep.AddPrintCell(date(sql.value("END_DT")), 0, 0, line_format);            // 19.Дата окончания сделки
    /*MDA 19.03.2019*/
    //Rep.AddPrintCell(sql.value("ACCOUNT_DEMAND"), 0, 0, line_format);          // 18.Лицевой счет требований
    Rep.AddPrintCell(iif(IsCB == false,DAcc,sql.value("ACCOUNT_DEMAND")), 0, 0, line_format);          // 18.Лицевой счет требований
    //Rep.AddPrintCell(sql.value("CURRENCY_DEMAND"), 0, 0, line_format);         // 19.Валюта счета требований
    Rep.AddPrintCell(iif(IsCB == false,DCur,sql.value("CURRENCY_DEMAND")), 0, 0, line_format);         // 19.Валюта счета требований
    If (valtype(sql.value("AMOUNT_DEMAND_VAL"))==26) fornum = sql.value("AMOUNT_DEMAND_VAL") else fornum = abs(sql.value("AMOUNT_DEMAND_VAL")) end;
    //Rep.AddPrintCell(fornum, 0, 0, line_format);                               // 20.Сумма требований (в ин.валюте)
    Rep.AddPrintCell(iif((sql.value("CURRENCY_DEMAND") == "810") or (sql.value("CURRENCY_DEMAND") == "643")," ",iif(IsCB == false,abs(GetRestAccOnDate(DAcc,repdate,false)),fornum)), 0, 0, line_format);                               // 20.Сумма требований (в ин.валюте)
    If (valtype(sql.value("AMOUNT_DEMAND_RUR"))==26) fornum = sql.value("AMOUNT_DEMAND_RUR") else fornum = abs(sql.value("AMOUNT_DEMAND_RUR")) end;
    //Rep.AddPrintCell(fornum, 0, 0, line_format);                               // 21.Сумма требований (в руб.экв-те)
    Rep.AddPrintCell(iif(IsCB == false,abs(GetRestAccOnDate(DAcc,repdate,true)),fornum), 0, 0, line_format);                               // 21.Сумма требований (в руб.экв-те)
    //Rep.AddPrintCell(sql.value("ACCOUNT_LIABILITY"), 0, 0, line_format);       // 22.Лицевой счет обязательств
    Rep.AddPrintCell(iif(IsCB == false,LAcc,sql.value("ACCOUNT_LIABILITY")), 0, 0, line_format);       // 22.Лицевой счет обязательств
    //Rep.AddPrintCell(sql.value("CURRENCY_LIABILITY"), 0, 0, line_format);      // 23.Валюта счета обязательств
    Rep.AddPrintCell(iif(IsCB == false,LCur,sql.value("CURRENCY_LIABILITY")), 0, 0, line_format);      // 23.Валюта счета обязательств
    If (valtype(sql.value("AMOUNT_LIABILITY_VAL"))==26) fornum = sql.value("AMOUNT_LIABILITY_VAL") else fornum = abs(sql.value("AMOUNT_LIABILITY_VAL")) end;
    //Rep.AddPrintCell(fornum, 0, 0, line_format);                               // 24.Сумма обязательств (в ин.валюте)
    Rep.AddPrintCell(iif((sql.value("CURRENCY_LIABILITY") == "810") or (sql.value("CURRENCY_LIABILITY") == "643")," ",iif(IsCB == false,GetRestAccOnDate(LAcc,repdate,false),fornum)), 0, 0, line_format);                               // 24.Сумма обязательств (в ин.валюте)
    If (valtype(sql.value("AMOUNT_LIABILITY_RUR"))==26) fornum = sql.value("AMOUNT_LIABILITY_RUR") else fornum = abs(sql.value("AMOUNT_LIABILITY_RUR")) end;
    //Rep.AddPrintCell(fornum, 0, 0, line_format);                               // 25.Сумма обязательств (в руб.эквиваленте)
    Rep.AddPrintCell(iif(IsCB == false,GetRestAccOnDate(LAcc,repdate,true),fornum), 0, 0, line_format);                               // 25.Сумма обязательств (в руб.эквиваленте)
    /*MDA 19.03.2019 END*/
    Rep.AddPrintCell(sql.value("ACCOUNT_SS"), 0, 0, line_format);              // 26.Лицевой счет по учету справедливой стоимости ПФИ'
    If (valtype(sql.value("AMOUNT_SS_ACTIVE"))==26) fornum = sql.value("AMOUNT_SS_ACTIVE") else fornum = abs(sql.value("AMOUNT_SS_ACTIVE")) end;
    Rep.AddPrintCell(fornum, 0, 0, line_format);                               // 27.Справедливая стоимость актива
    If (valtype(sql.value("AMOUNT_SS_LIABILITY"))==26) fornum = sql.value("AMOUNT_SS_LIABILITY") else fornum = abs(sql.value("AMOUNT_SS_LIABILITY")) end;
    Rep.AddPrintCell(fornum, 0, 0, line_format);                               // 28.Справедливая стоимость обязательства
    //Rep.AddPrintCell(sql.value("IS_LIQ_NETTING"), 0, 0, line_format);          // 29.Наличие в соглашении по сделке условия ликвидационного неттинга (ДА/НЕТ)
    Rep.AddPrintCell(iif(sql.value("DEAL_EXCHANGE") == "Внебиржевая"," ","ДА"), 0, 0, line_format);          // 29.Наличие в соглашении по сделке условия ликвидационного неттинга (ДА/НЕТ)
    //Rep.AddPrintCell(sql.value("IS_CLC_NETTING"), 0, 0, line_format);          // 30.Наличие в соглашении по сделке условия расчетного неттинга (ДА/НЕТ)
    Rep.AddPrintCell(iif(sql.value("DEAL_EXCHANGE") == "Внебиржевая"," ","ДА"), 0, 0, line_format);          // 30.Наличие в соглашении по сделке условия расчетного неттинга (ДА/НЕТ)
    Rep.AddPrintCell(sql.value("IS_REPOSITORY"), 0, 0, line_format);           // 31.Сделка зарегистрирована в репозитарии (ДА/НЕТ)
    Rep.AddPrintCell(sql.value("SWAP_PRC_CHANGE_DT"), 0, 0, line_format);      // 32.Процентные свопы. Ближайшая дата пересмотра процентной ставки
    Rep.AddPrintCell(sql.value("SWAP_BAL_ACC_FLOAT_RATE"), 0, 0, line_format); // 33.Процентные свопы. № счета 2-го порядка позиции с плавающей процентной ставкой.
    Rep.AddStr(); 
    UseProgress(count = count + 1);
    rn = rn + 1;
    
  end;
  RemProgress();

  /*Запуск Excel*/
  Rep.PrintWinRep("Сделки ПФИ");
  Rep.SetZoomType(ZOOM_TYPE_A4L); /*альбомная ориентация*/
  Rep.SetWinRepOutput();
  Rep.ShowWinRep();

onerror()
  RemProgress();
end;

f657_7();
exit(1);