//-----------------------------------------------------------------------------------------
// Расшифровка для формы 125
// В.Горленко
//-----------------------------------------------------------------------------------------
import /*для listDepartment без ВСП*/ globals, Календарь, oralib, likepy, rcw, spInter, vsInter, vsbnrfd;

Private const kbF2 = 316, kbF3 = 317, kbF9 = 323, kbESC = 27, kbEnter = 13, kbSpace = 32;
Private var parm = genObject ("CParam"), sqlString, fName, csvTable, csvFile;
Private var decsep = GetLocaleInfo (0, LOCALE_SDECIMAL, IsStandAlone ()),
            thosep = execMacro2 ("getThousand");

parm.("date") = {curdate};

while ( parm.run () )
    execMacro ("makeReport");
end;
exit (1);
//-----------------------------------------------------------------------------------------

Private macro getThousand
    Var shell = CreateObject ("rsax", "TRsAxServer", "RsAxServer", false).CreateComObject ("WScript.Shell");
    return shell.RegRead ("HKEY_CURRENT_USER\\Control Panel\\International\\sThousand");
onError
    return " ";
End;
//-----------------------------------------------------------------------------------------

Private macro createXls
//    return CreateObject ("rsax", "TRsAxServer", "FmAxServer", isStandalone ()).CreateComObject ("Excel.Application");
//    var printEngine = CTemplateXLS(NULL, NULL, NULL, NULL, NULL, NULL, true, false);
    var printEngine = CTemplateSXLSX(NULL);
    if(printEngine.UsePoi())
        printEngine.SetXLSXFormat();
    end;

//    printEngine.CreateTotalBook();

    return printEngine;

OnError
   return NULL;
End;
//-----------------------------------------------------------------------------------------

Private macro collectOutProc ( str )
    sqlString = sqlString + "\n" + trim (str);
End;
//-----------------------------------------------------------------------------------------

Private macro CaptureOutput
   sqlString = "";
   SetOutHandler (@collectOutProc);
End;
//-----------------------------------------------------------------------------------------
                     
Private macro StopCaptureOutput
    SetOutHandler ();
    return sqlString;
End;
//-----------------------------------------------------------------------------------------

Private macro calcFiAmount ( fi, portfel )
    Var sql = execSqlSelect ("select nvl (sum (t_amount), 0) from v_scwrthistex s where t_department = 1 and t_amount > 0 and t_fiid = :1 and t_instance = (select max (t_instance) from v_scwrthistex where t_sumid=s.t_sumid and t_changedate < :2) and exists (select 1 from dllvalues_dbt where t_list = 1100 and t_code = :3 /*in ('СССД_ЦБ', 'ССПУ_ЦБ', 'АС_ЦБ')*/ and t_element = t_portfolio) and t_date < :4 and t_state in (1, 3)",
                             makeArray (sqlParam ("1", fi), sqlParam ("2", parm.("date")), sqlParam ("3", portfel), sqlParam ("4", parm.("date"))));
    if ( sql.moveNext () )
        return money (sql.value (0));
    end;
    return $0;
End;
//-----------------------------------------------------------------------------------------

Private macro СуммаЧП ( dt, fiid, cost, fiFace, rubCost:@money )
    rubCost = $0;
    Var sql = "select t_sum, rsb_fiinstr.ConvSum (cast(t_sum AS integer), :1, 0, :2, 2) from (select nvl (sum (:3 * t_incomerate/greatest (1, t_incomeScale)/100.0), 0) t_sum from dfiwarnts_dbt where t_ispartial = 'X' and t_fiid = :4 and t_drawingdate < :5) subq1";
    sql = execSqlSelect (sql, makeArray (sqlParam ("1", fiFace), sqlParam ("2", parm.("date")), sqlParam ("3", cost), sqlParam ("4", fiid), sqlParam ("5", dt)));
    if ( sql.moveNext () )
        rubCost = money (sql.value (1));
        return money (sql.value (0));
    end;
    return $0;
End;
//-----------------------------------------------------------------------------------------

Private macro ДатаОферты ( fiid, drdate )
    Var sql = "select nvl (min (/*t_begindateoffer*/t_dateredemption), :1) from doffers_dbt where t_fiid = :2 and /*t_begindateoffer*/t_dateredemption > :3";
    sql = execSqlSelect (sql, makeArray (sqlParam ("1", drdate), sqlParam ("2", fiid), sqlParam ("3", parm.("date"))));
    if ( sql.moveNext () )
        return date (sql.value (0));
    end;
    return date (0,0,0);
End;
//-----------------------------------------------------------------------------------------

Private macro getReplayDate ( id )
    Var p, sql = execSqlSelect ("select t_id from ddl_leg_dbt where t_legkind=1 and t_legid=0 and t_dealid = :1", makeArray (sqlParam ("1", id)));
    if ( sql.moveNext () and (execStoredFunc ("rsb_bill.GetBnrPlanRepayDate", V_INTEGER, makeArray (sqlParam ("1", int (sql.value (0))), p=sqlParam ("2", V_DATE, RSDBP_OUT))) == 0) )
        return date (p.value);
    end;
    return date (0,0,0);
End;
//-----------------------------------------------------------------------------------------

Private macro getVsPercentSum ( id )
    Var perc, sql = execSqlSelect ("select t_contractid, t_enddate from dprccontract_dbt where t_objecttype=651 and t_objectid=:1", makeArray (sqlParam ("1", id)));

    if ( sql.moveNext () and ПроцентыКНачислениюПоПДВекселя (int (sql.value (0)), min (date (sql.value (1)), parm.("date")), perc));
        return perc;
    end;
    return $0;
End;
//-----------------------------------------------------------------------------------------

Private macro getReportDate ( dt )
    Var mm, yy;
    dateSplit (dt, null, mm, yy);
    return date (1, mm, yy)-1;
End;
//-----------------------------------------------------------------------------------------

Private macro getMBKPrcSum ( dealId, amount, percent )
    Var result = makeArray ($0, $0, $0, $0, $0, $0, $0, $0, $0, $0, $0, $0, $0, $0, $0, $0, $0, $0),
        sql = execSqlSelect ("select t_isfactpaym, rsb_fiinstr.ConvSum (t_baseamount, t_basefiid, 0, :1, 2) t_natsum, t_baseamount, t_basefiid, t_valuedate from dpmpaym_dbt where t_documentid = lpad (to_char(:2), 34, '0') and t_dockind = 102 and t_purpose = 11 and t_valuedate >= :3 order by t_valuedate",
                             makeArray (sqlParam ("1", parm.("date")), sqlParam ("2", dealId), sqlParam ("3", parm.("date")))),
        days, first = true, sum;
    while ( sql.moveNext () )
        days = date (sql.value ("t_valuedate")) - parm.("date");
        sum = money (sql.value ("t_natsum"));
        if ( (sql.value ("t_isfactpaym") != "X") and first )
            first = false;
            sum = amount * percent * (days+1) / 100 / 365;
        end;
        if ( (days >= 0) and (days <= 1) )
            result [0] = result [0] + sum;
        elif ( (days > 1) and (days <= 5) )
            result [1] = result [1] + sum;
        elif ( (days > 5) and (days <= 10) )
            result [2] = result [2] + sum;
        elif ( (days > 10) and (days <= 20) )
            result [3] = result [3] + sum;
        elif ( (days > 20) and (days <= 30) )
            result [4] = result [4] + sum;
        elif ( (days > 30) and (days <= 90) )
            result [5] = result [5] + sum;
        elif ( (days > 90) and (days <= 180) )
            result [6] = result [6] + sum;
        elif ( (days > 180) and (days <= 270) )
            result [7] = result [7] + sum;
        elif ( (days > 270) and (days <= 365) )
            result [8] = result [8] + sum;
        elif ( (days > 365) and (days <= 365*2) )
            result [9] = result [9] + sum;
        elif ( (days > 365*2) and (days <= 365*3) )
            result [10] = result [10] + sum;
        elif ( (days > 365*3) and (days <= 365*4) )
            result [11] = result [11] + sum;
        elif ( (days > 365*4) and (days <= 365*5) )
            result [12] = result [12] + sum;
        elif ( (days > 365*5) and (days <= 365*7) )
            result [13] = result [13] + sum;
        elif ( (days > 365*7) and (days <= 365*10) )
            result [14] = result [14] + sum;
        elif ( (days > 365*10) and (days <= 365*15) )
            result [15] = result [15] + sum;
        elif ( (days > 365*15) and (days <= 365*20) )
            result [16] = result [16] + sum;
        else
            result [17] = result [17] + money (sql.value ("t_natsum"));
        end;
    end;
    return result;
End;
//-----------------------------------------------------------------------------------------

Private macro getREPOPercentSum ( id )
    Var sql = execSqlSelect ("select nvl (sum (rsb_fiinstr.ConvSum (t_amount, t_fiid, 0, :1, 2)), 0) from ddlrq_dbt where t_dockind = 101 and t_docid = :2 and t_type = 3",
                             makeArray (sqlParam ("1", parm.("date")), sqlParam ("2", id)));
    sql.moveNext ();
    return sql.value (0);
End;

macro getCharNameCell ( num )
	var name_cell  = TArray;
	//VBA //columnLetters = columnLetters & """" & Split(ws.Cells(1, i).Address, "$")(1) & """" & ", "
	name_cell(0) = "A";
	name_cell(1) = "B";
	name_cell(2) = "C";
	name_cell(3) = "D";
	name_cell(4) = "E";
	name_cell(5) = "F";
	name_cell(6) = "G";
	name_cell(7) = "H";
	name_cell(8) = "I";
	name_cell(9) = "J";
	name_cell(10) = "K";
	name_cell(11) = "L";
	name_cell(12) = "M";
	name_cell(13) = "N";
	name_cell(14) = "O";
	name_cell(15) = "P";
	name_cell(16) = "Q";
	name_cell(17) = "R";
	name_cell(18) = "S";
	name_cell(19) = "T";
	name_cell(20) = "U";
	name_cell(21) = "V";
	name_cell(22) = "W";
	name_cell(23) = "X";
	name_cell(24) = "Y";
	name_cell(25) = "Z";
	name_cell(26) = "AA";
	name_cell(27) = "AB";
	name_cell(28) = "AC";
	name_cell(29) = "AD";
	name_cell(30) = "AE";
	name_cell(31) = "AF";
	name_cell(32) = "AG";
	name_cell(33) = "AH";
	name_cell(34) = "AI";
	name_cell(35) = "AJ";
	name_cell(36) = "AK";
	name_cell(37) = "AL";
	name_cell(38) = "AM";
	name_cell(39) = "AN";
	name_cell(40) = "AO";
	name_cell(41) = "AP";
	name_cell(42) = "AQ";
	name_cell(43) = "AR";
	name_cell(44) = "AS";
	name_cell(45) = "AT";
	name_cell(46) = "AU";
	name_cell(47) = "AV";
	name_cell(48) = "AW";
	name_cell(49) = "AX";
	return(name_cell(num))
end;	


//-----------------------------------------------------------------------------------------


Private macro makeReport1 ( xls )
    begAction (100, "Анализ данных. Ждите...", false);
    captureOutput ();
    [with parm as (select :1 t_dt from dual)
     select /*+ FIRST_ROWS (5)*/ 
            f.t_fiid 
           ,t_name 
           ,h.t_account 
           ,(select t_code from dllvalues_dbt where t_list = 1100 and t_element = (select t_value1 from dmctempl_dbt where t_catid = h.t_catid and t_number = h.t_templnum)) t_portfel 
           ,(select t_isin from davoiriss_dbt where t_fiid = f.t_fiid) t_isin 
           ,(select t_fi_code from dfininstr_dbt where t_fiid = f.t_facevaluefi) t_curname 
           ,t_facevaluefi 
           ,t_facevalue 
           ,rsb_fiinstr.ConvSum (t_facevalue, t_facevaluefi, 0, (select t_dt-1 from parm), 0) t_natvalue 
           ,(select t_attrid from dobjatcor_dbt where t_objecttype=12 and t_groupid=13 and t_object=lpad (to_char(f.t_fiid), 10, '0') and (select t_dt from parm) between t_validfromdate and t_validtodate) t_categ 
           ,t_drawingdate 
           ,count (1) over () t_cnt 
     from dfininstr_dbt f inner join dmcaccdoc_dbt h on h.t_catnum=231 and h.t_fiid=f.t_fiid and h.t_iscommon = 'X' and rsb_account.restall (h.t_account, h.t_chapter, h.t_currency, (select t_dt-1 from parm), h.t_currency) != 0 where t_fi_kind = 2 and RSI_RSB_FIInstr.FI_AvrKindsGetRoot (f.t_fi_kind, f.t_AvoirKind) in (17/*, 20*/)
     and exists (select 1 from v_scwrthistex s where t_amount > 0 and t_fiid = f.t_fiid and 
                                                   t_instance = (select max (t_instance) from v_scwrthistex where t_sumid=s.t_sumid and t_changedate < (select t_dt from parm)) and 
                                                   exists (select 1 from dllvalues_dbt where t_list = 1100 and t_code in ('СССД_ЦБ', 'ССПУ_ЦБ', 'АС_ЦБ') and t_element = t_portfolio) 
                                                   and t_date < (select t_dt from parm) 
                                                   and t_state in (1, 3)) 
     /*and exists ((select 1 from dmcaccdoc_dbt m where t_catnum=231 and t_iscommon = 'X' and t_fiid = f.t_fiid and t_activatedate = (select max (t_activatedate) from dmcaccdoc_dbt where t_catnum=231 and t_iscommon = 'X' and t_fiid = f.t_fiid and rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) != 0) and rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) != 0))*/
     /*and rsb_secur.GetMainObjAttr (12, lpad (t_fiid, 10, '0'), 13, (select t_dt-1 from parm)) in (1, 2)*/
    order by 2 ];

//debugbreak;    
    Var sql = execSqlSelect (stopCaptureOutput (), makeArray (sqlParam ("1", parm.("date")))), i = 0, warnt, rubCost;
    endAction ();

    Var name, account, isin, facevalue, curname, natvalue, drawdate, fiid, offdate, fiAmount, first, prc;
    Var line = 2; //Первая строка = шапка отчета, начинаем со второй


    xls.SheetChange ("ЦБ"); /*1*/
var Table = xls.RegisterTable("templateTable");		
    Table.SetValueCell("DateReport", getReportDate (parm.("date")));    
    
    if ( not sql.moveNext () )
        Table.SetValueCell("templateTable", "Нет данных для отчета");
        return;
    end;
    
    i = 0;
    initProgress (int (sql.value ("t_cnt")), "", "Обработка данных - цб");
    while ( true )
        if ( (valType (sql.value ("t_categ")) == V_DOUBLE) and inList (int (sql.value ("t_categ")), 1, 2) and (valType (sql.value ("t_account")) != 26) and (sql.value ("t_account") != "") )
            name    = sql.value ("t_name");
            account = sql.value ("t_account");
            isin    = sql.value ("t_isin");
            facevalue = sql.value ("t_facevalue");
            curname = sql.value ("t_curname");
            natvalue = sql.value ("t_natvalue");
            drawdate = date (sql.value ("t_drawingdate"));
            fiid    = int (sql.value ("t_fiid"));
            fiAmount = calcFiAmount (int (sql.value ("t_fiid")), sql.value ("t_portfel"));
            offdate = ДатаОферты (fiid, drawdate);

            warnt = execSqlSelect ("select * from dfiwarnts_dbt where t_ispartial = chr (0) and t_fiid = :1 and t_drawingdate >= :2 and ((t_drawingdate <= :3) or :4 between t_firstdate+1 and t_drawingdate) order by t_drawingdate",
                                   makeArray (sqlParam ("1", int (sql.value ("t_fiid"))), sqlParam ("2", parm.("date")), sqlParam ("3", offdate), sqlParam ("4", offdate)));
            first = true;
            prc = $0;
            while ( warnt.moveNext () )
                
                Table.SetValueCell("N1_A", name);
                Table.SetValueCell("N1_B", substr (account, 1, 5));
                Table.SetValueCell("N1_C", account);   
                Table.SetValueCell("N1_D", isin);
                Table.SetValueCell("N1_E", facevalue - СуммаЧП (date (warnt.value ("t_drawingdate")), int (sql.value ("t_fiid")), money (sql.value ("t_facevalue")), int (sql.value ("t_facevaluefi")), @rubCost)  );
                Table.SetValueCell("N1_F", curname); // csvFile.AddCell(sql.value ("t_curname"));
                
                Table.SetValueCell("N1_G", natvalue - rubCost);
                Table.SetValueCell("N1_H", drawdate);
                Table.SetValueCell("N1_I", fiAmount);
                Table.SetValueCell("N1_J", warnt.value ("t_number"));
                Table.SetValueCell("N1_K",  date (warnt.value ("t_firstdate")));
                Table.SetValueCell("N1_L",  date (warnt.value ("t_drawingdate")));

                if ( warnt.value ("t_incomerate") != 0 )
                    prc = warnt.value ("t_incomerate");
                    Table.SetValueCell("N1_M",  prc );
                else
                    if ( (prc == 0) and (warnt.value ("t_relativeincome") != "X") )
                        execSqlSelect ("select RSI_RSB_FIINSTR.CalcNKD_Ex_NoRound (:1, :2, 1, 1, 0) from dual", makeArray (sqlParam ("1", int (sql.value ("t_fiid"))), sqlParam ("2", date (warnt.value ("t_drawingdate"))))).moveNext ();
                        prc = execSqlSelect ("select round (RSI_RSB_FIInstr.FI_ReturnIncomeRate(), 2) from dual");
                        prc.moveNext ();
                        prc = prc.value (0);
                    end;
                    Table.SetValueCell("N1_M",  prc );
                end;
                Table.SetValueCell("N1_N", offdate ); /*14*/

                //csvFile.AddCell("=ЛЕВСИМВ(R[0]C[-12];3)");
                Table.SetValueCell("N1_O", "=LEFT(C"+"$"+line+";3)"); /*15*/  //фиксировать строку в формуле!! приходится из-за сдвига строки при вставке на величину шапки отчета
                //csvFile.AddCell("=ЕСЛИ(RC[-2]<>\"\";ЕСЛИ(RC[-4]<=RC[-2];RC[-4];RC[-2]);RC[-4])");
                Table.SetValueCell("N1_P", "=IF(LEN(TRIM(N"+"$"+line+"))>0;IF(L"+"$"+line+"<=N"+"$"+line+";L"+"$"+line+";N"+"$"+line+");L"+"$"+line+")"); /*16*/
                if ( first )
                    first = false;
                    Table.SetValueCell("N1_Q", ""); //csvFile.AddCell();
                    //csvFile.AddCell("=R[-"+(line-1)+"]C[0]");
//                  csvFile.AddCell("=R"+(line-2)); //от DateReport
                    Table.SetValueCell("N1_R", "=$R$1"); //от DateReport
                else
                    //csvFile.AddCell("=ЕСЛИ(И(RC[-14]=R[-1]C[-14];RC[-13]=R[-1]C[-13]);\"истина\";\"ложь\")");
                    Table.SetValueCell("N1_Q", "=IF(AND(C"+"$"+line+"=C"+"$"+(line-1)+";D"+"$"+line+"=D"+"$"+(line-1)+");\"истина\";\"ложь\")"); /*17*/
                    //csvFile.AddCell("=R[-1]C[-6]");
                    Table.SetValueCell("N1_R", "=L"+"$"+(line-1)); /*18*/
                end;
                //csvFile.AddCell("=RC[-3]-RC[-8]+1");
                Table.SetValueCell("N1_S", "=P"+"$"+line+"-K"+"$"+line+"+1"); /*19*/
                //csvFile.AddCell("=ЕСЛИ(RC[-4]-RC[-2]>0;RC[-4]-RC[-2];0)");
                Table.SetValueCell("N1_T", "=IF(P"+"$"+line+"-R"+"$"+line+">0;P"+"$"+line+"-R"+"$"+line+";0)"); /*20*/
                //csvFile.AddCell("=RC[-5]-R1C18"); 
                Table.SetValueCell("N1_U", "=P"+"$"+line+"-$R$1"); /*21*/
                Table.SetValueCell("N1_V", 365);
                //csvFile.AddCell("=ЕСЛИОШИБКА(ЕСЛИ(RC[-3]=0;0;RC[-14]*RC[-16]*RC[-10]/100*RC[-3]/RC[-1]);0)");
                Table.SetValueCell("N1_W", "=IFERROR(IF(T"+"$"+line+"=0;0;I"+"$"+line+"*G"+"$"+line+"*M"+"$"+line+"/100*T"+"$"+line+"/V"+"$"+line+");0)"); /*23*/
                //csvFile.AddCell("=ЕСЛИ(RC21>=0;ЕСЛИ(RC21<=1;RC23;0);0)");
                Table.SetValueCell("N1_X", "=IF(U"+"$"+line+">=0;IF(U"+"$"+line+"<=1;W"+"$"+line+";0);0)"); /*24*/
                //csvFile.AddCell("=ЕСЛИ(RC21>1;ЕСЛИ(RC21<=5;RC23;0);0)");
                Table.SetValueCell("N1_Y", "=IF(U"+"$"+line+">1;IF(U"+"$"+line+"<=5;W"+"$"+line+";0);0)"); /*25*/
                //csvFile.AddCell("=ЕСЛИ(RC21>5;ЕСЛИ(RC21<=10;RC23;0);0)");
                Table.SetValueCell("N1_Z", "=IF(U"+"$"+line+">5;IF(U"+"$"+line+"<=10;W"+"$"+line+";0);0)"); /*26*/
                //csvFile.AddCell("=ЕСЛИ(RC21>10;ЕСЛИ(RC21<=20;RC23;0);0)");
                Table.SetValueCell("N1_AA", "=IF(U"+"$"+line+">10;IF(U"+"$"+line+"<=20;W"+"$"+line+";0);0)"); /*27*/
                //csvFile.AddCell("=ЕСЛИ(RC21>20;ЕСЛИ(RC21<=30;RC23;0);0)");
                Table.SetValueCell("N1_AB", "=IF(U"+"$"+line+">20;IF(U"+"$"+line+"<=30;W"+"$"+line+";0);0)"); /*28*/
                //csvFile.AddCell("=ЕСЛИ(RC21>30;ЕСЛИ(RC21<=90;RC23;0);0)");
                Table.SetValueCell("N1_AC", "=IF(U"+"$"+line+">30;IF(U"+"$"+line+"<=90;W"+"$"+line+";0);0)"); /*29*/
                //csvFile.AddCell("=ЕСЛИ(RC21>90;ЕСЛИ(RC21<=180;RC23;0);0)");
                Table.SetValueCell("N1_AD", "=IF(U"+"$"+line+">90;IF(U"+"$"+line+"<=180;W"+"$"+line+";0);0)"); /*30*/
                //vFile.AddCell("=ЕСЛИ(RC21>180;ЕСЛИ(RC21<=270;RC23;0);0)");
                Table.SetValueCell("N1_AE", "=IF(U"+"$"+line+">180;IF(U"+"$"+line+"<=270;W"+"$"+line+";0);0)"); /*31*/
                //csvFile.AddCell("=ЕСЛИ(RC21>270;ЕСЛИ(RC21<=365;RC23;0);0)");
                Table.SetValueCell("N1_AF", "=IF(U"+"$"+line+">270;IF(U"+"$"+line+"<=365;W"+"$"+line+";0);0)"); /*32*/
                //csvFile.AddCell("=ЕСЛИ(RC21>365;ЕСЛИ(RC21<=365*2;RC23;0);0)");
                Table.SetValueCell("N1_AG", "=IF(U"+"$"+line+">365;IF(U"+"$"+line+"<=365*2;W"+"$"+line+";0);0)"); /*33*/
                //csvFile.AddCell("=ЕСЛИ(RC21>365*2;ЕСЛИ(RC21<=365*3;RC23;0);0)");
                Table.SetValueCell("N1_AH", "=IF(U"+"$"+line+">365*2;IF(U"+"$"+line+"<=365*3;W"+"$"+line+";0);0)"); /*34*/
                //csvFile.AddCell("=ЕСЛИ(RC21>365*3;ЕСЛИ(RC21<=365*4;RC23;0);0)");
                Table.SetValueCell("N1_AI", "=IF(U"+"$"+line+">365*3;IF(U"+"$"+line+"<=365*4;W"+"$"+line+";0);0)"); /*35*/
                //csvFile.AddCell("=ЕСЛИ(RC21>365*4;ЕСЛИ(RC21<=365*5;RC23;0);0)");
                Table.SetValueCell("N1_AJ", "=IF(U"+"$"+line+">365*4;IF(U"+"$"+line+"<=365*5;W"+"$"+line+";0);0)"); /*36*/
                //csvFile.AddCell("=ЕСЛИ(RC21>365*5;ЕСЛИ(RC21<=365*7;RC23;0);0)");
                Table.SetValueCell("N1_AK", "=IF(U"+"$"+line+">365*5;IF(U"+"$"+line+"<=365*7;W"+"$"+line+";0);0)"); /*37*/
                //csvFile.AddCell("=ЕСЛИ(RC21>365*7;ЕСЛИ(RC21<=365*10;RC23;0);0)");
                Table.SetValueCell("N1_AL", "=IF(U"+"$"+line+">365*7;IF(U"+"$"+line+"<=365*10;W"+"$"+line+";0);0)"); /*38*/
                //csvFile.AddCell("=ЕСЛИ(RC21>365*10;ЕСЛИ(RC21<=365*15;RC23;0);0)");
                Table.SetValueCell("N1_AM", "=IF(U"+"$"+line+">365*10;IF(U"+"$"+line+"<=365*15;W"+"$"+line+";0);0)"); /*39*/
                //csvFile.AddCell("=ЕСЛИ(RC21>365*15;ЕСЛИ(RC21<=365*20;RC23;0);0)");
                Table.SetValueCell("N1_AN", "=IF(U"+"$"+line+">365*15;IF(U"+"$"+line+"<=365*20;W"+"$"+line+";0);0)"); /*40*/
                //csvFile.AddCell("=ЕСЛИ(RC21>365*20;ЕСЛИ(RC21<=1000000;RC23;0);0)");
                Table.SetValueCell("N1_AO", "=IF(U"+"$"+line+">365*20;IF(U"+"$"+line+"<=1000000;W"+"$"+line+";0);0)"); /*41*/
                Table.AddStr();
                line = line + 1;
            end;        
        else
        end;

        useProgress (i = i+1);

        if ( (testEvent (1) == kbESC) and getTrue (true, "Прекратить формирование отчета?") )
            remProgress ();
            return false;
        end;

        if ( not sql.moveNext () )    
            break;
        end;
    end;
  
    Table.EndTable();
    xls.SetAutoFilter ("A1:AO1", "ЦБ");
        
    remProgress ();
    return true
    
End;
//-----------------------------------------------------------------------------------------

Private macro makeReport2 ( xls )
    Var line = 2, val, sql, i = 0;
    begAction (100, "Анализ данных. Ждите...", false);
    captureOutput ();
    [with parm as (select :1 t_dt from dual)
     select t_bcid
           ,t_kind
           ,t_account
           ,(select (select t_fi_code from dfininstr_dbt where t_fiid=t_code_currency) from daccount_dbt where t_chapter=1 and t_account=t.t_account) t_ficode
           ,(select t_balance from daccount_dbt where t_chapter=1 and t_account=t.t_account) t_balance
           ,(select t_kind_account from daccount_dbt where t_chapter=1 and t_account=t.t_account) t_kind_account
           ,(select t_nameaccount from daccount_dbt where t_chapter=1 and t_account=t.t_account) t_nameaccount
           ,(select t_shortname from dparty_dbt where t_partyid=t_issuer) t_partyname
           ,decode ((select t_kind_account from daccount_dbt where t_chapter=1 and t_account=t.t_account), 'А', -1, 1)*decode ((select t_code_currency from daccount_dbt where t_chapter=1 and t_account=t.t_account), 0, 0, rsb_account.restall (t_account, 1, (select t_code_currency from daccount_dbt where t_chapter=1 and t_account=t.t_account), (select t_dt-1 from parm), (select t_code_currency from daccount_dbt where t_chapter=1 and t_account=t.t_account))) t_restcurr
           ,decode ((select t_kind_account from daccount_dbt where t_chapter=1 and t_account=t.t_account), 'А', -1, 1)*rsb_account.restall (t_account, 1, (select t_code_currency from daccount_dbt where t_chapter=1 and t_account=t.t_account), (select t_dt-1 from parm), 0) t_restrub
           ,'В' t_typeacc
           ,case when t_catnum in (1492, 450, 451, 462) then 'Вексель'
                 when t_catnum = 464 and exists (select 1 from dmctempl_dbt where t_number=t.t_templnum and t_catid=t.t_catid and t_value4 in (1,4)) then 'ПрцДУВ'
                 when t_catnum = 1492 and t_percordisc = 1 then 'ПрцДУВ'
                 when t_catnum = 464 and exists (select 1 from dmctempl_dbt where t_number=t.t_templnum and t_catid=t.t_catid and t_value4 in (2,5)) then 'ДисДУВ'
                 when t_catnum = 1492 and t_percordisc != 1 then 'ДисДУВ'
                 when t_catnum in (1482,452) then 'КупЦБ'
                 when t_catnum in (1384,1481) then 'ДискЦБ'
            end t_purpacc
           ,decode (t_kind, 0, (select t_dateofpayment from ddl_order_dbt o where t_dockind = 109 and exists (select 1 from dvsordlnk_dbt where t_linkkind = 0 and t_contractid=o.t_contractid and t_bcid=t.t_bcid)),
                            1, (select t_valuedate from dpmpaym_dbt where t_dockind=141 and t_purpose=1 and t_subpurpose=1 and t_documentid=(select t_contractid from dvsordlnk_dbt where t_bcid=t.t_bcid and t_linkkind=1))) t_opendate
           ,trim (trim (t_bcseries)||' '||trim (t_bcnumber)) t_number
           ,case when t_kind = 1 then to_date ('01010001', 'ddmmyyyy') else decode (t_bctermformula, 20, (select t_maturity from ddl_leg_dbt where t_legkind=1 and t_legid=0 and t_dealid = t_bcid and t.t_kind = 0), to_date ('01010001','ddmmyyyy')) end t_dtear
           ,t_percordisc
           ,decode (t_kind, 0, null, 1, nvl ((select t_qualitycategory from ddlreslnk_dbt r where t_type = 2 and t_parentid = t_bcid and t_reservekind = 0 and t_reservesubkind = 0 and t_lnkdate = (select max (t_lnkdate) from ddlreslnk_dbt where t_type = 2 and t_parentid = t_bcid and t_reservekind = 0 and t_reservesubkind = 0 and t_lnkdate < (select t_dt from parm))), 1)) t_qulity
           ,(select decode (t_formula, 1, t_price/10000, 0) from ddl_leg_dbt where t_dealid=t_bcid and t_legkind=1 and t_legid=0) t_perc
           ,count (1) over () t_cnt
     from (
       select t_bcid
             ,decode (bnr.t_issuer, 1, 0, 1) t_kind
             ,mc.t_account
             ,mc.t_catnum
             ,mc.t_catid
             ,mc.t_templnum
             ,bnr.t_issuer
             ,t_bcseries
             ,t_bcnumber
             ,t_bctermformula
             ,(select t_formula from ddl_leg_dbt where t_legkind=1 and t_legid=0 and t_dealid = bnr.t_bcid) t_percordisc
       from dvsbanner_dbt bnr
       inner join dmcaccdoc_dbt mc on ((bnr.t_issuer = 1 and t_catnum in (450, 451)) or (bnr.t_issuer != 1 and ((t_catnum=462) or ((t_catnum= 1492) and (t_templnum=1)))) or (bnr.t_issuer = 1 and t_catnum in (1384, 1481, 452, 1482)) or (bnr.t_issuer != 1 and ((t_catnum = 464) or (t_catnum = 1492) and (t_templnum = 2))))   
                 and rsb_account.restall (t_account, mc.t_chapter, mc.t_currency, (select t_dt-1 from parm), mc.t_currency) != 0 and t_dockind = 164 and t_docid=bnr.t_bcid 
       where ((bnr.t_issuer != 1 and exists (select 1 from dvsbnrbck_dbt where t_newabcstatus = 100/*Учтен*/ and t_bcid=bnr.t_bcid and t_abcstatus='X' and t_changedate = 
                                                (select max (t_changedate) from dvsbnrbck_dbt where t_bcid=bnr.t_bcid and t_abcstatus='X' and t_changedate < (select t_dt from parm)))) or
              (bnr.t_issuer = 1  and exists (select 1 from dvsbnrbck_dbt where t_newabcstatus in (20/*Выдан*/, 25/*В залоге*/) and t_bcid=bnr.t_bcid and t_bcstatus='X' and t_changedate = 
                                                (select max (t_changedate) from dvsbnrbck_dbt where t_bcid=bnr.t_bcid and t_bcstatus='X' and t_changedate < (select t_dt from parm)))))
     ) t order by t_bcid];
    sql = execSqlSelect (stopCaptureOutput (), makeArray (sqlParam ("1", parm.("date"))));
    endAction ();

    xls.SheetChange ("Векселя Сертификаты");/*2*/

var Table = xls.RegisterTable("templateTable2");	
    
    if ( not sql.moveNext () )
		Table.SetValueCell("templateTable2", "Нет данных для отчета");
        return;
    end;
	Table.SetValueCell("DateReport2", getReportDate (parm.("date")));

    initProgress (int (sql.value ("t_cnt")), "", "Обработка данных - векселя");
    
    while ( true )
	    Table.SetValueCell("N2_A", sql.value ("t_balance"));
		Table.SetValueCell("N2_B", sql.value ("t_ficode"));
		Table.SetValueCell("N2_C", sql.value ("t_account"));
		Table.SetValueCell("N2_D", sql.value ("t_kind_account"));
		Table.SetValueCell("N2_E", sql.value ("t_nameaccount"));
		Table.SetValueCell("N2_F", sql.value ("t_partyname"));
		Table.SetValueCell("N2_G", money(sql.value ("t_restcurr")) );
		Table.SetValueCell("N2_H", money(sql.value ("t_restrub")) );		
		Table.SetValueCell("N2_I", sql.value ("t_typeacc"));
		Table.SetValueCell("N2_J", sql.value ("t_purpacc"));
		Table.SetValueCell("N2_K", date(sql.value ("t_opendate")) );
		Table.SetValueCell("N2_L", "");
		Table.SetValueCell("N2_M", sql.value ("t_number"));

		Table.SetValueCell("N2_N", date(sql.value ("t_dtear")) );
		
        val = getReplayDate (int (sql.value ("t_bcid")));
        if ( (val < parm.("date")-1) or (sql.value ("t_balance") == "52301"))
            val = date("00.00.0000");
        end;
		Table.SetValueCell("N2_O", val);
		Table.SetValueCell("N2_P", ifThenElse (sql.value ("t_percordisc") == 1, "Процентный", "Дисконтный"));
        if ( valType (sql.value ("t_qulity")) != 26 )
            Table.SetValueCell("N2_Q", int (sql.value ("t_qulity")) );
        elif ( sql.value ("t_percordisc") == 1 ) // Процентный
            Table.SetValueCell("N2_Q", "не заполнено" );
        else
            Table.SetValueCell("N2_Q", "" );
        end;
		Table.SetValueCell("N2_R", sql.value ("t_perc"));
        //xls.cells (line, 19).FormulaR1C1 = "=ЕСЛИ(RC[-4]=\"00.00.0000\";0;ЕСЛИ(И(RC[-5]<>\"\";RC[-5]<R1C15);0;ЕСЛИ(RC[-5]>R1C15;RC[-5]-R1C15;RC[-4]-R1C15)))";
        //двойные кавычки "ломают" формулу при импорте из CSV, поэтому проверяем на длину строки
		Table.SetValueCell("N2_S", "=IF(OR((O"+"$"+line+"=\"00.00.0000\");(LEN(TRIM(O"+"$"+line+"))=0));0;IF(AND(LEN(TRIM(N"+"$"+line+"))>0;N"+"$"+line+"<$O$1);0;IF(AND(LEN(TRIM(N"+"$"+line+"))>0;N"+"$"+line+">$O$1);N"+"$"+line+"-$O$1;O"+"$"+line+"-$O$1)))");
        //правильнее делать проверку на минимальную дату Excel, но в алгоритме по другому
        //csvFile.AddCell( "=IF((O"+"$"+line+"<=DATE(1900; 1; 1)) OR (ISBLANK(O"+"$"+line+"));0;IF(AND(LEN(TRIM(N"+"$"+line+"))>0;N"+"$"+line+"<$O$1);0;IF(AND(LEN(TRIM(N"+"$"+line+"))>0;N"+"$"+line+">$O$1);N"+"$"+line+"-$O$1;O"+"$"+line+"-$O$1)))" ); /*19*/      

        //xls.cells (line, 20).FormulaR1C1 = "=ЕСЛИ(И(RC[-10]=\"Вексель\";RC[-4]=\"Процентный\");RC[-12]*RC[-2]/100/365*RC[-1];0)";
        Table.SetValueCell("N2_T", "=IF(AND(J"+"$"+line+"=\"Вексель\";P"+"$"+line+"=\"Процентный\");H"+"$"+line+"*R"+"$"+line+"/100/365*S"+"$"+line+";0)" ); /*20*/
        //xls.cells (line, 21).FormulaR1C1 = "=ЕСЛИ(RC19>=0;ЕСЛИ(RC19<=1;RC20;0);0)";
        Table.SetValueCell("N2_U", "=IF($S"+"$"+line+">=0;IF($S"+"$"+line+"<=1;$T"+"$"+line+";0);0) ");       /*21*/
        //xls.cells (line, 22).FormulaR1C1 = "=ЕСЛИ(RC19>1;ЕСЛИ(RC19<=5;RC20;0);0)";
        Table.SetValueCell("N2_V", "=IF($S"+"$"+line+">1;IF($S"+"$"+line+"<=5;$T"+"$"+line+";0);0) ");        /*22*/
        //xls.cells (line, 23).FormulaR1C1 = "=ЕСЛИ(RC19>5;ЕСЛИ(RC19<=10;RC20;0);0)";
        Table.SetValueCell("N2_W", "=IF($S"+"$"+line+">5;IF($S"+"$"+line+"<=10;$T"+"$"+line+";0);0) ");       /*23*/      
        //xls.cells (line, 24).FormulaR1C1 = "=ЕСЛИ(RC19>10;ЕСЛИ(RC19<=20;RC20;0);0)";
        Table.SetValueCell("N2_X", "=IF($S"+"$"+line+">10;IF($S"+"$"+line+"<=20;$T"+"$"+line+";0);0) ");      /*24*/  
        //xls.cells (line, 25).FormulaR1C1 = "=ЕСЛИ(RC19>20;ЕСЛИ(RC19<=30;RC20;0);0)";
        Table.SetValueCell("N2_Y", "=IF($S"+"$"+line+">20;IF($S"+"$"+line+"<=30;$T"+"$"+line+";0);0) ");      /*25*/
        //xls.cells (line, 26).FormulaR1C1 = "=ЕСЛИ(RC19>30;ЕСЛИ(RC19<=90;RC20;0);0)";
        Table.SetValueCell("N2_Z", "=IF($S"+"$"+line+">30;IF($S"+"$"+line+"<=90;$T"+"$"+line+";0);0) ");      /*26*/
        //xls.cells (line, 27).FormulaR1C1 = "=ЕСЛИ(RC19>90;ЕСЛИ(RC19<=180;RC20;0);0)";
        Table.SetValueCell("N2_AA", "=IF($S"+"$"+line+">90;IF($S"+"$"+line+"<=180;$T"+"$"+line+";0);0) ");     /*27*/
        //xls.cells (line, 28).FormulaR1C1 = "=ЕСЛИ(RC19>180;ЕСЛИ(RC19<=270;RC20;0);0)";
        Table.SetValueCell("N2_AB", "=IF($S"+"$"+line+">180;IF($S"+"$"+line+"<=270;$T"+"$"+line+";0);0) ");    /*28*/
        //xls.cells (line, 29).FormulaR1C1 = "=ЕСЛИ(RC19>270;ЕСЛИ(RC19<=365;RC20;0);0)";
        Table.SetValueCell("N2_AC", "=IF($S"+"$"+line+">270;IF($S"+"$"+line+"<=365;$T"+"$"+line+";0);0) ");    /*29*/
        //xls.cells (line, 30).FormulaR1C1 = "=ЕСЛИ(RC19>365;ЕСЛИ(RC19<=365*2;RC20;0);0)";
        Table.SetValueCell("N2_AD", "=IF($S"+"$"+line+">365;IF($S"+"$"+line+"<=365*2;$T"+"$"+line+";0);0) ");  /*30*/
        //xls.cells (line, 31).FormulaR1C1 = "=ЕСЛИ(RC19>365*2;ЕСЛИ(RC19<=365*3;RC20;0);0)";
        Table.SetValueCell("N2_AE", "=IF($S"+"$"+line+">365*2;IF($S"+"$"+line+"<=365*3;$T"+"$"+line+";0);0) "); /*31*/
        //xls.cells (line, 32).FormulaR1C1 = "=ЕСЛИ(RC19>365*3;ЕСЛИ(RC19<=365*4;RC20;0);0)";
        Table.SetValueCell("N2_AF", "=IF($S"+"$"+line+">365*3;IF($S"+"$"+line+"<=365*4;$T"+"$"+line+";0);0) "); /*32*/
        //xls.cells (line, 33).FormulaR1C1 = "=ЕСЛИ(RC19>365*4;ЕСЛИ(RC19<=365*5;RC20;0);0)";
        Table.SetValueCell("N2_AG", "=IF($S"+"$"+line+">365*4;IF($S"+"$"+line+"<=365*5;$T"+"$"+line+";0);0) "); /*33*/
        //xls.cells (line, 34).FormulaR1C1 = "=ЕСЛИ(RC19>365*5;ЕСЛИ(RC19<=365*7;RC20;0);0)";
        Table.SetValueCell("N2_AH", "=IF($S"+"$"+line+">365*5;IF($S"+"$"+line+"<=365*7;$T"+"$"+line+";0);0) "); /*34*/
        //xls.cells (line, 35).FormulaR1C1 = "=ЕСЛИ(RC19>365*7;ЕСЛИ(RC19<=365*10;RC20;0);0)";
        Table.SetValueCell("N2_AI", "=IF($S"+"$"+line+">365*7;IF($S"+"$"+line+"<=365*10;$T"+"$"+line+";0);0) "); /*35*/
        //xls.cells (line, 36).FormulaR1C1 = "=ЕСЛИ(RC19>365*10;ЕСЛИ(RC19<=365*15;RC20;0);0)";
        Table.SetValueCell("N2_AJ", "=IF($S"+"$"+line+">365*10;IF($S"+"$"+line+"<=365*15;$T"+"$"+line+";0);0) "); /*36*/
        //xls.cells (line, 37).FormulaR1C1 = "=ЕСЛИ(RC19>365*15;ЕСЛИ(RC19<=365*20;RC20;0);0)";
        Table.SetValueCell("N2_AK", "=IF($S"+"$"+line+">365*15;IF($S"+"$"+line+"<=365*20;$T"+"$"+line+";0);0) "); /*37*/
        //xls.cells (line, 38).FormulaR1C1 = "=ЕСЛИ(RC19>365*20;RC20;0)";
        Table.SetValueCell("N2_AL", "=IF($S"+"$"+line+">365*20;$T"+"$"+line+";0) "); /*38*/

	    Table.AddStr();
		
        line = line + 1;
        useProgress (i=i+1);

        if ( (testEvent (1) == kbESC) and getTrue (true, "Прекратить формирование отчета?") )
            remProgress ();
            return false;
        end;
        
        if ( not sql.moveNext () ) break; end;
    end;

    Table.EndTable();
    xls.SetAutoFilter ("A1:AL1", "Векселя Сертификаты");     
	
    remProgress ();
    return true
    
End;
//-----------------------------------------------------------------------------------------

Private macro makeReport3 ( xls )
    Var line = 2, oferta, sql, i = 0, warnt, part, prc, prc1;
    begAction (100, "Анализ данных. Ждите...", false);
    captureOutput ();
    [with parm as (select :1 t_dt from dual)
    select (select t_balance from daccount_dbt where t_chapter=mc.t_chapter and t_account=mc.t_account and t_code_currency=mc.t_currency) t_balance
           ,(select t_fi_code from dfininstr_dbt where t_fiid=t_currency) t_ficode
           ,t_account
           ,(select t_kind_account from daccount_dbt where t_chapter=mc.t_chapter and t_account=mc.t_account and t_code_currency=mc.t_currency) t_kind_account
           ,(select t_name from dfininstr_dbt where t_fiid=mc.t_fiid) t_name
           ,(select t_isin from davoiriss_dbt where t_fiid=mc.t_fiid) t_isin
           ,(select t_qty from davoiriss_dbt where t_fiid=mc.t_fiid) t_qty
           ,(select t_facevalue from dfininstr_dbt where t_fiid=mc.t_fiid) t_fval
           ,(select t_issued from dfininstr_dbt where t_fiid=mc.t_fiid) t_issued
           ,(select t_drawingdate from dfininstr_dbt where t_fiid=mc.t_fiid) t_drawingdate
           ,(select t_nameaccount from daccount_dbt where t_chapter=mc.t_chapter and t_account=mc.t_account and t_code_currency=mc.t_currency) t_nameaccount
           ,decode (t_currency, 0, 0, rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency)) t_restcurr
           ,rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0) t_restrub
           ,(select t_open_date from daccount_dbt where (t_chapter,t_account,t_code_currency)=(select t_chapter,t_account,t_currency from dmcaccdoc_dbt where t_catnum=1359 and t_fiid=mc.t_fiid and t_isusable='X' and t_iscommon='X')) t_opendate
           ,mc.t_fiid t_docid
           ,count (1) over () t_cnt
     from dmcaccdoc_dbt mc where t_catnum in (1359, 1362/*, 1363*/) and t_iscommon = 'X' and (t_isusable = 'X' or t_disablingdate > (select t_dt from parm))
     and rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) != 0];
    sql = execSqlSelect (stopCaptureOutput (), makeArray (sqlParam ("1", parm.("date"))));
    endAction ();

    xls.SheetChange ("Собств облигации");/*3*/
var Table = xls.RegisterTable("templateTable3");		
    Table.SetValueCell("DateReport3", getReportDate (parm.("date")));


    if ( not sql.moveNext () )
        Table.SetValueCell("templateTable3", "Нет данных для отчета");
        return;
    end;

    initProgress (int (sql.value ("t_cnt")), "", "Обработка данных - Собственные облигации");

    while ( true )
        Table.SetValueCell("N3_A", sql.value ("t_balance"));       /*1*/
        Table.SetValueCell("N3_B", sql.value ("t_ficode"));
        Table.SetValueCell("N3_C", sql.value ("t_account"));   
        Table.SetValueCell("N3_D", sql.value ("t_kind_account"));  /*4*/
        Table.SetValueCell("N3_E", sql.value ("t_name"));
        Table.SetValueCell("N3_F", sql.value ("t_isin"));          /*6*/
        Table.SetValueCell("N3_G", sql.value ("t_qty"));
        Table.SetValueCell("N3_H", sql.value ("t_fval"));          /*8*/
		Table.SetValueCell("N3_I", "");
		Table.SetValueCell("N3_J", "");
        Table.SetValueCell("N3_K", SQL_ConvTypeDate(sql.value ("t_issued")));
        Table.SetValueCell("N3_L", SQL_ConvTypeDate(sql.value ("t_drawingdate")));   /*12*/ //дата = время?
        oferta = ДатаОферты (int (sql.value ("t_docid")), date (1,1,1900));
        if ( inList (oferta, date (0,0,0), date (1,1,1900)) )
            oferta = "-";
        end;        
        Table.SetValueCell("N3_M", oferta);                        /*13*/
        Table.SetValueCell("N3_N", sql.value ("t_nameaccount"));   /*14*/
        Table.SetValueCell("N3_O", sql.value ("t_restcurr"));
        Table.SetValueCell("N3_P", sql.value ("t_restrub"));       /*16*/
        Table.SetValueCell("N3_Q", SQL_ConvTypeDate(sql.value ("t_opendate")));
        Table.SetValueCell("N3_R", SQL_ConvTypeDate(sql.value ("t_drawingdate")));   /*18*/ //дата = время?
        line = line + 1;
        Table.AddStr();

        warnt = execSqlSelect ("select * from dfiwarnts_dbt where t_ispartial = chr (0) and t_fiid = :1 order by t_drawingdate",
                               makeArray (sqlParam ("1", int (sql.value ("t_docid")))));

        prc = $0;
        while ( warnt.moveNext () )
            Table.SetValueCell("N3_A", sql.value ("t_balance"));       /*1*/
            Table.SetValueCell("N3_B", sql.value ("t_ficode"));
            Table.SetValueCell("N3_C", sql.value ("t_account"));   
            Table.SetValueCell("N3_D", sql.value ("t_kind_account"));  /*4*/
            Table.SetValueCell("N3_E", sql.value ("t_name"));
            Table.SetValueCell("N3_F", sql.value ("t_isin"));          /*6*/
            Table.SetValueCell("N3_G", sql.value ("t_qty"));
            part = СуммаЧП (date (warnt.value ("t_drawingdate")), int (sql.value ("t_docid")), 0, 0);
            Table.SetValueCell("N3_H", money (sql.value ("t_fval") - part));   /*8*/
            Table.SetValueCell("N3_I", warnt.value ("t_number"));      /*9*/
            if ( warnt.value ("t_incomerate") != 0 )
                Table.SetValueCell("N3_J", warnt.value ("t_incomerate"));  /*10*/
            else
                if ( (warnt.value ("t_incomerate") == 0) and (warnt.value ("t_relativeincome") != "X") )
                    execSqlSelect ("select RSI_RSB_FIINSTR.CalcNKD_Ex_NoRound (:1, :2, 1, 1, 0) from dual", makeArray (sqlParam ("1", int (sql.value ("t_docid"))), sqlParam ("2", date (warnt.value ("t_drawingdate"))))).moveNext ();
                    prc1 = execSqlSelect ("select round (RSI_RSB_FIInstr.FI_ReturnIncomeRate(), 2) from dual");
                    prc1.moveNext ();
                    prc1 = prc1.value (0);
                    if ( prc1 != 0 )
                        Table.SetValueCell("N3_J", prc1);              /*10*/
                    else
                        Table.SetValueCell("N3_J", "опр эмитент");     /*10*/
                    end;
                else
                    Table.SetValueCell("N3_J", "опр эмитент");         /*10*/
                end;
            end;
            Table.SetValueCell("N3_K", date (warnt.value ("t_drawingdate"))); /*11*/
            Table.SetValueCell("N3_L", "");    /*12*/
            Table.SetValueCell("N3_M", oferta);    /*13*/ 
            Table.SetValueCell("N3_N", sql.value ("t_nameaccount"));   /*14*/
            Table.SetValueCell("N3_O", sql.value ("t_restcurr"));
            Table.SetValueCell("N3_P", sql.value ("t_restrub"));       /*16*/
            Table.SetValueCell("N3_Q", SQL_ConvTypeDate(sql.value ("t_opendate")));
            Table.SetValueCell("N3_R", SQL_ConvTypeDate(sql.value ("t_drawingdate")));   /*18*/ //дата = время?

            if ( warnt.value ("t_incomerate") != 0 )
                prc = warnt.value ("t_incomerate");
                Table.SetValueCell("N3_S", prc);  /*19*/
            else
                if ( (warnt.value ("t_incomerate") == 0) and (warnt.value ("t_relativeincome") != "X") )
                    execSqlSelect ("select RSI_RSB_FIINSTR.CalcNKD_Ex_NoRound (:1, :2, 1, 1, 0) from dual", makeArray (sqlParam ("1", int (sql.value ("t_docid"))), sqlParam ("2", date (warnt.value ("t_drawingdate"))))).moveNext ();
                    prc1 = execSqlSelect ("select round (RSI_RSB_FIInstr.FI_ReturnIncomeRate(), 2) from dual");
                    prc1.moveNext ();
                    prc1 = prc1.value (0);
                    if ( prc1 != 0 )
                        prc = prc1;
                        Table.SetValueCell("N3_S", prc);   /*19*/
                    else
                        Table.SetValueCell("N3_S", prc);   /*19*/
                    end;
                else
                    Table.SetValueCell("N3_S", prc);   /*19*/
                end;
            end;
			
            //xls.cells (line, 20).FormulaR1C1 = "=ЕСЛИ(R[-1]C[-9]<R[-1]C[-7];R[-1]C[-9];R[-1]C[-7])";
            Table.SetValueCell("N3_T", "=IF(K"+"$"+(line-1)+"<M"+"$"+(line-1)+";K"+"$"+(line-1)+";M"+"$"+(line-1)+")");
            //xls.cells (line, 21).FormulaR1C1 = "=ЕСЛИ(RC[-10]<RC[-8];RC[-10];RC[-8])";
            Table.SetValueCell("N3_U", "=IF(K"+"$"+line+"<M"+"$"+line+";K"+"$"+line+";M"+"$"+line+")");
            //xls.cells (line, 22).FormulaR1C1 = "=ЕСЛИ(RC[-1]<R1C1;0;ЕСЛИ(RC[-2]<R1C1;RC21-R1C1;RC21-RC20))";
            Table.SetValueCell("N3_V", "=IF(U"+"$"+line+"<$A$1;0;IF(T"+"$"+line+"<$A$1;$U"+"$"+line+"-$A$1;$U"+"$"+line+"-$T"+"$"+line+"))");
            //xls.cells (line, 23).FormulaR1C1 = "=ЕСЛИ(RC22=0;0;(RC21-RC20)/ДОЛЯГОДА(RC20;RC21;1))";
            Table.SetValueCell("N3_W", "=IF($V"+"$"+line+"=0;0;($U"+"$"+line+"-$T"+"$"+line+")/YEARFRAC($T"+"$"+line+";$U"+"$"+line+";1))");          /*??*/
            //xls.cells (line, 24).FormulaR1C1 = "=ЕСЛИ(RC22=0;0;RC19%*RC22/RC23*RC16)";
            Table.SetValueCell("N3_X", "=IF($V"+"$"+line+"=0;0;$S"+"$"+line+"%*$V"+"$"+line+"/$W"+"$"+line+"*$P"+"$"+line+")");
            //xls.cells (line, 25).FormulaR1C1 = "=ЕСЛИ(RC21-R1C1<0;0;RC21-R1C1)";
            Table.SetValueCell("N3_Y", "=IF($U"+"$"+line+"-$A$1<0;0;$U"+"$"+line+"-$A$1)");
            
            //xls.cells (line, 26).FormulaR1C1 = "=ЕСЛИ(RC25>=0;ЕСЛИ(RC25<=1;RC24;0);0)";
            Table.SetValueCell("N3_Z", "=IF($Y"+"$"+line+">=0;IF($Y"+"$"+line+"<=1;$X"+"$"+line+";0);0)");
            //xls.cells (line, 27).FormulaR1C1 = "=ЕСЛИ(RC25>1;ЕСЛИ(RC25<=5;RC24;0);0)";
            Table.SetValueCell("N3_AA", "=IF($Y"+"$"+line+">1;IF($Y"+"$"+line+"<=5;$X"+"$"+line+";0);0)");
            //xls.cells (line, 28).FormulaR1C1 = "=ЕСЛИ(RC25>5;ЕСЛИ(RC25<=10;RC24;0);0)";
            Table.SetValueCell("N3_AB", "=IF($Y"+"$"+line+">5;IF($Y"+"$"+line+"<=10;$X"+"$"+line+";0);0)");
            //xls.cells (line, 29).FormulaR1C1 = "=ЕСЛИ(RC25>10;ЕСЛИ(RC25<=20;RC24;0);0)";
            Table.SetValueCell("N3_AC", "=IF($Y"+"$"+line+">10;IF($Y"+"$"+line+"<=20;$X"+"$"+line+";0);0)");
            //xls.cells (line, 30).FormulaR1C1 = "=ЕСЛИ(RC25>20;ЕСЛИ(RC25<=30;RC24;0);0)";
            Table.SetValueCell("N3_AD", "=IF($Y"+"$"+line+">20;IF($Y"+"$"+line+"<=30;$X"+"$"+line+";0);0)");
            //xls.cells (line, 31).FormulaR1C1 = "=ЕСЛИ(RC25>30;ЕСЛИ(RC25<=90;RC24;0);0)";
            Table.SetValueCell("N3_AE", "=IF($Y"+"$"+line+">30;IF($Y"+"$"+line+"<=90;$X"+"$"+line+";0);0)");
            //xls.cells (line, 32).FormulaR1C1 = "=ЕСЛИ(RC25>90;ЕСЛИ(RC25<=180;RC24;0);0)";
            Table.SetValueCell("N3_AF", "=IF($Y"+"$"+line+">90;IF($Y"+"$"+line+"<=180;$X"+"$"+line+";0);0)");
            //xls.cells (line, 33).FormulaR1C1 = "=ЕСЛИ(RC25>180;ЕСЛИ(RC25<=270;RC24;0);0)";
            Table.SetValueCell("N3_AG", "=IF($Y"+"$"+line+">180;IF($Y"+"$"+line+"<=270;$X"+"$"+line+";0);0)");
            //xls.cells (line, 34).FormulaR1C1 = "=ЕСЛИ(RC25>270;ЕСЛИ(RC25<=365;RC24;0);0)";
            Table.SetValueCell("N3_AH", "=IF($Y"+"$"+line+">270;IF($Y"+"$"+line+"<=365;$X"+"$"+line+";0);0)");
            //xls.cells (line, 35).FormulaR1C1 = "=ЕСЛИ(RC25>365;ЕСЛИ(RC25<=365*2;RC24;0);0)";
            Table.SetValueCell("N3_AI", "=IF($Y"+"$"+line+">365;IF($Y"+"$"+line+"<=365*2;$X"+"$"+line+";0);0)");
            //xls.cells (line, 36).FormulaR1C1 = "=ЕСЛИ(RC25>365*2;ЕСЛИ(RC25<=365*3;RC24;0);0)";
            Table.SetValueCell("N3_AJ", "=IF($Y"+"$"+line+">365*2;IF($Y"+"$"+line+"<=365*3;$X"+"$"+line+";0);0)");
            //xls.cells (line, 37).FormulaR1C1 = "=ЕСЛИ(RC25>365*3;ЕСЛИ(RC25<=365*4;RC24;0);0)";
            Table.SetValueCell("N3_AK", "=IF($Y"+"$"+line+">365*3;IF($Y"+"$"+line+"<=365*4;$X"+"$"+line+";0);0)");
            //xls.cells (line, 38).FormulaR1C1 = "=ЕСЛИ(RC25>365*4;ЕСЛИ(RC25<=365*5;RC24;0);0)";
            Table.SetValueCell("N3_AL", "=IF($Y"+"$"+line+">365*4;IF($Y"+"$"+line+"<=365*5;$X"+"$"+line+";0);0)");
            //xls.cells (line, 39).FormulaR1C1 = "=ЕСЛИ(RC25>365*5;ЕСЛИ(RC25<=365*7;RC24;0);0)";
            Table.SetValueCell("N3_AM", "=IF($Y"+"$"+line+">365*5;IF($Y"+"$"+line+"<=365*7;$X"+"$"+line+";0);0)");
            //xls.cells (line, 40).FormulaR1C1 = "=ЕСЛИ(RC25>365*7;ЕСЛИ(RC25<=365*10;RC24;0);0)";
            Table.SetValueCell("N3_AN", "=IF($Y"+"$"+line+">365*7;IF($Y"+"$"+line+"<=365*10;$X"+"$"+line+";0);0)");
            //xls.cells (line, 41).FormulaR1C1 = "=ЕСЛИ(RC25>365*10;ЕСЛИ(RC25<=365*15;RC24;0);0)";
            Table.SetValueCell("N3_AO", "=IF($Y"+"$"+line+">365*10;IF($Y"+"$"+line+"<=365*15;$X"+"$"+line+";0);0)");
            //xls.cells (line, 42).FormulaR1C1 = "=ЕСЛИ(RC25>365*15;ЕСЛИ(RC25<=365*20;RC24;0);0)";
            Table.SetValueCell("N3_AP", "=IF($Y"+"$"+line+">365*15;IF($Y"+"$"+line+"<=365*20;$X"+"$"+line+";0);0)");
            //xls.cells (line, 43).FormulaR1C1 = "=ЕСЛИ(RC25>365*20;RC24;0)";
            Table.SetValueCell("N3_AQ", "=IF($Y"+"$"+line+">365*20;$X"+"$"+line+";0)");
            Table.AddStr();
            line = line + 1;
        end;
        useProgress (i=i+1);
        if ( not sql.moveNext () ) break; end;
    end;

    captureOutput ();
    [with parm as (select :1 t_dt from dual)
     select t_balance
           ,t_ficode
           ,t_account
           ,t_kind_account
           ,(select 'Дисконт '||t_name from dfininstr_dbt where t_fiid=t_pfi) t_name
           ,(select t_isin from davoiriss_dbt where t_fiid=t_pfi) t_isin
           ,(select t_qty from davoiriss_dbt where t_fiid=t_pfi) t_qty
           ,(select t_facevalue from dfininstr_dbt where t_fiid=t_pfi) t_fval
           ,t_nameaccount
           ,decode (t_code_currency, 0, 0, rsb_account.restall (t_account, t_chapter, t_code_currency, (select t_dt-1 from parm), t_code_currency)) t_restcurr
           ,rsb_account.restall (t_account, t_chapter, t_code_currency, (select t_dt-1 from parm), 0) t_restrub
           ,t_open_date
           ,(select t_drawingdate from dfininstr_dbt where t_fiid=t_pfi) t_drawingdate
     from (
       select t_balance
             ,(select t_fi_code from dfininstr_dbt where t_fiid=t_code_currency) t_ficode
             ,t_account
             , t_chapter
             ,t_code_currency
             ,t_kind_account
             ,(select t_fiid from dfininstr_dbt f where exists (select 1 from dmcaccdoc_dbt where t_catnum=1404 and t_dockind=5 and t_docid=f.t_fiid and t_account=t.t_account and t_chapter=t.t_chapter and t_currency=t.t_code_currency)) t_pfi
             ,t_nameaccount
             ,t_open_date
       from daccount_dbt t where (t_chapter, t_account, t_code_currency) in (select t_chapter, t_account, t_currency from dmcaccdoc_dbt where t_catnum = 1404 and t_iscommon = chr (0) and t_dockind = 5)
       and rsb_account.restall (t_account, t_chapter, t_code_currency, (select t_dt-1 from parm), t_code_currency) != 0)];
    sql = execSqlSelect (stopCaptureOutput (), makeArray (sqlParam ("1", parm.("date"))));

    while ( sql.moveNext () )
		Table.SetValueCell("N3_A", sql.value ("t_balance"));       /*1*/
		Table.SetValueCell("N3_B", sql.value ("t_ficode"));
		Table.SetValueCell("N3_C", sql.value ("t_account"));   
		Table.SetValueCell("N3_D", sql.value ("t_kind_account"));  /*4*/
		Table.SetValueCell("N3_E", sql.value ("t_name"));
		Table.SetValueCell("N3_F", sql.value ("t_isin"));          /*6*/
		Table.SetValueCell("N3_G", sql.value ("t_qty"));
		Table.SetValueCell("N3_H", sql.value ("t_fval"));          /*8*/
		
		Table.SetValueCell("N3_I", "");          /*9*/
		Table.SetValueCell("N3_J", "");          /*10*/
		Table.SetValueCell("N3_K", "");          /*11*/
		Table.SetValueCell("N3_L", "");          /*12*/
		Table.SetValueCell("N3_M", "");          /*13*/
        Table.SetValueCell("N3_N", sql.value ("t_nameaccount"));   /*14*/
        Table.SetValueCell("N3_O", sql.value ("t_restcurr"));
        Table.SetValueCell("N3_P", sql.value ("t_restrub"));       /*16*/
        Table.SetValueCell("N3_Q", SQL_ConvTypeDate(sql.value ("t_open_date"))); 
        Table.SetValueCell("N3_R", SQL_ConvTypeDate(sql.value ("t_drawingdate")));   /*18*/
    
        line = line + 1;
        Table.AddStr();
    end;
    remProgress ();
	
    Table.EndTable();	
    xls.SetAutoFilter ("A1:AE1", "Собств облигации");
    
End;
//-----------------------------------------------------------------------------------------

Private macro makeReport4 ( xls )
    Var line = 2, oferta, sql, i = 0;
    begAction (100, "Анализ данных. Ждите...", false);
    captureOutput ();
    [with parm as (select :1 t_dt from dual)
     select a.t_balance
           ,(select t_fi_code from dfininstr_dbt where t_fiid=t_currency) t_ficode
           ,a.t_account
           ,a.t_kind_account
           ,a.t_nameaccount
           ,(select t_shortname from dparty_dbt where t_partyid = (select t_partyid from ddl_tick_dbt where t_dealid = t.t_dealid)) t_clientname
           ,decode (a.t_kind_account, 'А', -1, 1)*decode (t_currency, 0, 0, rsb_account.restall (a.t_account, a.t_chapter, a.t_code_currency, (select t_dt-1 from parm), t_code_currency)) t_restcurr
           ,decode (a.t_kind_account, 'А', -1, 1)*rsb_account.restall (a.t_account, a.t_chapter, a.t_code_currency, (select t_dt-1 from parm), 0) t_restrub
           ,(select t_factdate from ddlrq_dbt where t_docid = t_dealid and t_dealpart = 1 and t_type = 2 and t_dockind = 101) t_opendate
           ,(select decode (t_factdate, to_date ('01010001','ddmmyyyy'), t_plandate, t_factdate) from ddlrq_dbt where t_docid = t_dealid and t_dealpart = 2 and t_type = 2 and t_dockind = 101) t_closedate
           ,(select abs (t_incomerate) from ddl_leg_dbt where t_id=t_docid) t_rate
           ,(select '№ '||t_dealcode||' от '||to_char (t_dealdate, 'dd.mm.yyyy') from ddl_tick_dbt where t_dealid = t.t_dealid) t_number
           ,t.t_dealid
           ,count (1) over () t_cnt
     from (
       select (select t_dealid from ddl_leg_dbt where t_id = t_docid) t_dealid, m.*
       from dmcaccdoc_dbt m where t_catnum in (602, 603) and t_isusable = 'X'
       and rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) != 0) t
     inner join daccount_dbt a on a.t_chapter=t.t_chapter and a.t_account=t.t_account and t_code_currency=t.t_currency];
    sql = execSqlSelect (stopCaptureOutput (), makeArray (sqlParam ("1", parm.("date"))));
    endAction ();


    xls.SheetChange ("РЕПО");/*4*/
var Table = xls.RegisterTable("templateTable4");	
    Table.SetValueCell("DateReport4", getReportDate (parm.("date")));

    if ( not sql.moveNext () )
        Table.SetValueCell("templateTable4", "Нет данных для отчета");
        return;
    end;

    initProgress (int (sql.value ("t_cnt")), "", "Обработка данных - РЕПО");

    while ( true )
	    Table.SetValueCell("N4_A", sql.value ("t_balance"));       /*1*/
        Table.SetValueCell("N4_B", sql.value ("t_ficode"));
        Table.SetValueCell("N4_C", sql.value ("t_account"));   
        Table.SetValueCell("N4_D", sql.value ("t_kind_account"));  /*4*/
        Table.SetValueCell("N4_E", sql.value ("t_nameaccount"));
        Table.SetValueCell("N4_F", sql.value ("t_clientname"));    /*6*/
        Table.SetValueCell("N4_G", sql.value ("t_restcurr"));
        Table.SetValueCell("N4_H", sql.value ("t_restrub"));       /*8*/
        Table.SetValueCell("N4_I", "В");
        Table.SetValueCell("N4_J", "");/*10*/
        Table.SetValueCell("N4_K", date(sql.value ("t_opendate")));
        Table.SetValueCell("N4_L", date (sql.value ("t_closedate")) - date (sql.value ("t_opendate"))); /*12*/
        Table.SetValueCell("N4_M", date (sql.value ("t_closedate")));
        Table.SetValueCell("N4_N", sql.value ("t_rate"));          /*14*/
        Table.SetValueCell("N4_O", "Да");
        Table.SetValueCell("N4_P", sql.value ("t_number"));        /*16*/
        

        //xls.cells (line, 17).FormulaR1C1 = "=RC13-R1C13";
        Table.SetValueCell("N4_Q", "=$M"+"$"+line+"-$M$1");
        //xls.cells (line, 18).FormulaR1C1 = "=RC[-10]*RC[-4]/365*RC[-1]/100";
        Table.SetValueCell("N4_R", "=H"+"$"+line+"*N"+"$"+line+"/365*Q"+"$"+line+"/100");
        //xls.cells (line, 19).FormulaR1C1 = "=ЕСЛИ(RC17>=0;ЕСЛИ(RC17<=1;RC18;0);0)";
        Table.SetValueCell("N4_S", "=IF($Q"+"$"+line+">=0;IF($Q"+"$"+line+"<=1;$R"+"$"+line+";0);0)");
        //xls.cells (line, 20).FormulaR1C1 = "=ЕСЛИ(RC17>1;ЕСЛИ(RC17<=5;RC18;0);0)";
        Table.SetValueCell("N4_T", "=IF($Q"+"$"+line+">1;IF($Q"+"$"+line+"<=5;$R"+"$"+line+";0);0)");
        //xls.cells (line, 21).FormulaR1C1 = "=ЕСЛИ(RC17>5;ЕСЛИ(RC17<=10;RC18;0);0)";
        Table.SetValueCell("N4_U", "=IF($Q"+"$"+line+">5;IF($Q"+"$"+line+"<=10;$R"+"$"+line+";0);0)");
        //xls.cells (line, 22).FormulaR1C1 = "=ЕСЛИ(RC17>10;ЕСЛИ(RC17<=20;RC18;0);0)";
        Table.SetValueCell("N4_V", "=IF($Q"+"$"+line+">10;IF($Q"+"$"+line+"<=20;$R"+"$"+line+";0);0)");
        //xls.cells (line, 23).FormulaR1C1 = "=ЕСЛИ(RC17>20;ЕСЛИ(RC17<=30;RC18;0);0)";
        Table.SetValueCell("N4_W", "=IF($Q"+"$"+line+">20;IF($Q"+"$"+line+"<=30;$R"+"$"+line+";0);0)");
        //xls.cells (line, 24).FormulaR1C1 = "=ЕСЛИ(RC17>30;ЕСЛИ(RC17<=90;RC18;0);0)";
        Table.SetValueCell("N4_X", "=IF($Q"+"$"+line+">30;IF($Q"+"$"+line+"<=90;$R"+"$"+line+";0);0)");
        //xls.cells (line, 25).FormulaR1C1 = "=ЕСЛИ(RC17>90;ЕСЛИ(RC17<=180;RC18;0);0)";
        Table.SetValueCell("N4_Y", "=IF($Q"+"$"+line+">90;IF($Q"+"$"+line+"<=180;$R"+"$"+line+";0);0)");
        //xls.cells (line, 26).FormulaR1C1 = "=ЕСЛИ(RC17>180;ЕСЛИ(RC17<=270;RC18;0);0)";
        Table.SetValueCell("N4_Z", "=IF($Q"+"$"+line+">180;IF($Q"+"$"+line+"<=270;$R"+"$"+line+";0);0)");
        //xls.cells (line, 27).FormulaR1C1 = "=ЕСЛИ(RC17>270;ЕСЛИ(RC17<=365;RC18;0);0)";
        Table.SetValueCell("N4_AA", "=IF($Q"+"$"+line+">270;IF($Q"+"$"+line+"<=365;$R"+"$"+line+";0);0)");
        //xls.cells (line, 28).FormulaR1C1 = "=ЕСЛИ(RC17>365;ЕСЛИ(RC17<=265*2;RC18;0);0)"; /*??? 265 ???*/
        Table.SetValueCell("N4_AB", "=IF($Q"+"$"+line+">365;IF($Q"+"$"+line+"<=365*2;$R"+"$"+line+";0);0)");
        //xls.cells (line, 29).FormulaR1C1 = "=ЕСЛИ(RC17>365*2;ЕСЛИ(RC17<=265*3;RC18;0);0)";
        Table.SetValueCell("N4_AC", "=IF($Q"+"$"+line+">365*2;IF($Q"+"$"+line+"<=365*3;$R"+"$"+line+";0);0)");
        //xls.cells (line, 30).FormulaR1C1 = "=ЕСЛИ(RC17>365*3;ЕСЛИ(RC17<=265*4;RC18;0);0)";
        Table.SetValueCell("N4_AD", "=IF($Q"+"$"+line+">365*3;IF($Q"+"$"+line+"<=365*4;$R"+"$"+line+";0);0)");
        //xls.cells (line, 31).FormulaR1C1 = "=ЕСЛИ(RC17>365*4;ЕСЛИ(RC17<=265*5;RC18;0);0)";
        Table.SetValueCell("N4_AE", "=IF($Q"+"$"+line+">365*4;IF($Q"+"$"+line+"<=365*5;$R"+"$"+line+";0);0)");
        //xls.cells (line, 32).FormulaR1C1 = "=ЕСЛИ(RC17>365*5;ЕСЛИ(RC17<=265*7;RC18;0);0)";
        Table.SetValueCell("N4_AF", "=IF($Q"+"$"+line+">365*5;IF($Q"+"$"+line+"<=365*7;$R"+"$"+line+";0);0)");
        //xls.cells (line, 33).FormulaR1C1 = "=ЕСЛИ(RC17>365*7;ЕСЛИ(RC17<=265*10;RC18;0);0)";
        Table.SetValueCell("N4_AG", "=IF($Q"+"$"+line+">365*7;IF($Q"+"$"+line+"<=365*10;$R"+"$"+line+";0);0)");
        //xls.cells (line, 34).FormulaR1C1 = "=ЕСЛИ(RC17>365*10;ЕСЛИ(RC17<=265*15;RC18;0);0)";
        Table.SetValueCell("N4_AH", "=IF($Q"+"$"+line+">365*10;IF($Q"+"$"+line+"<=365*15;$R"+"$"+line+";0);0)");
        //xls.cells (line, 35).FormulaR1C1 = "=ЕСЛИ(RC17>365*15;ЕСЛИ(RC17<=265*20;RC18;0);0)";
        Table.SetValueCell("N4_AI", "=IF($Q"+"$"+line+">365*15;IF($Q"+"$"+line+"<=365*20;$R"+"$"+line+";0);0)");
        //xls.cells (line, 36).FormulaR1C1 = "=ЕСЛИ(RC17>365*20;RC[-18];0)";
        Table.SetValueCell("N4_AJ", "=IF($Q"+"$"+line+">365*20;$R"+"$"+line+";0)");
        Table.AddStr();
        line = line + 1;
        useProgress (i=i+1);
        if ( not sql.moveNext () ) break; end;
    end;
    remProgress ();
	
	Table.EndTable();
    xls.SetAutoFilter ("A1:AJ1", "РЕПО");
    
End;
//-----------------------------------------------------------------------------------------

Private macro makeReport5 ( xls )
    Var line = 2, oferta, sql, i = 0, j;
    begAction (100, "Анализ данных. Ждите...", false);
    captureOutput ();
    [with parm as (select :1 t_dt from dual)
     select m.t_account
           ,(select t_balance from daccount_dbt where t_chapter=m.t_chapter and t_code_currency=m.t_currency and t_account=m.t_account) t_balance
           ,(select t_kind_account from daccount_dbt where t_chapter=m.t_chapter and t_code_currency=m.t_currency and t_account=m.t_account) t_kind_account
           ,(select t_code from ddl_genagr_dbt where t_genagrid = t.t_genagrid) t_contrnum
           ,(select t_shortname from dparty_dbt where t_partyid = t.t_partyid) t_clntname
           ,decode ((select t_kind_account from daccount_dbt where t_chapter=m.t_chapter and t_code_currency=m.t_currency and t_account=m.t_account), 'А', -1, 1)*decode (t_currency, 0, 0, rsb_account.restall (m.t_account, m.t_chapter, t_currency, (select t_dt-1 from parm), t_currency)) t_restcurr
           ,decode ((select t_kind_account from daccount_dbt where t_chapter=m.t_chapter and t_code_currency=m.t_currency and t_account=m.t_account), 'А', -1, 1)*rsb_account.restall (m.t_account, m.t_chapter, t_currency, (select t_dt-1 from parm), 0) t_restrub
           ,l.t_maturity
           ,(select t_price/100 from ddl_leg_dbt where t_dealid = t.t_dealid) t_percent
           ,nvl (decode (r.t_qualitycategory, 1, (select t_qualitycategory from dmm_qcateg_dbt where t_dealid=t.t_dealid and t_lnkdate = (select max (t_lnkdate) from dmm_qcateg_dbt where t_dealid=t.t_dealid and t_lnkdate < (select t_dt from parm))),
                                              2, (select t_attrid from dobjatcor_dbt where t_objecttype=3 and t_groupid=13 and t_object = lpad (to_char(t.t_partyid), 10, '0') and (select t_dt-1 from parm) between t_validfromdate and t_validtodate)), 1) t_quality
           ,nvl (decode (r.t_reservepercent, 1, (select t_reservepercent from dmm_qcateg_dbt where t_dealid=t.t_dealid and t_lnkdate = (select max (t_lnkdate) from dmm_qcateg_dbt where t_dealid=t.t_dealid and t_lnkdate < (select t_dt from parm))),
                                             2, (select rsb_struct.getDouble (t_text) from dnotetext_dbt where t_objecttype=3 and t_documentid=lpad (to_char(t.t_partyid), 10, '0') and t_notekind=3 and (select t_dt-1 from parm) between t_date and t_validtodate)), 0) t_prcrez
           ,(select t_nrcountry from dparty_dbt where t_partyid = t.t_partyid) t_country
           ,t.t_dealid
           ,count (1) over () t_cnt
     from ddl_tick_dbt t
     inner join ddl_leg_dbt l on l.t_dealid = t.t_dealid
     inner join dmcaccdoc_dbt m on m.t_catnum in (601, 700, 701) and t_isusable = 'X' and m.t_dockind = 102 and t_docid = t.t_dealid and rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) != 0
     left outer join (select * from ddlresset_dbt r where t_module = 'J' and t_setdate = (select max (t_setdate) from ddlresset_dbt where t_module = 'J' and t_setdate < (select t_dt from parm))) r on 1=1
     where t_bofficekind = 102 and (l.t_maturity >= (select t_dt from parm) or l.t_maturity = to_date ('01010001','ddmmyyyy'))
     and (t.t_department = :2 or :3 = 0)];
    sql = execSqlSelect (stopCaptureOutput (), makeArray (sqlParam ("1", parm.("date")), sqlParam ("2", parm.dprt), sqlParam ("3", parm.dprt)));
    endAction ();

    xls.SheetChange ("МБК");/*3*/
var Table = xls.RegisterTable("templateTable5");	
	
    if ( not sql.moveNext () )
        Table.SetValueCell("templateTable5", "Нет данных для отчета");
        return;
    end;
    
    initProgress (int (sql.value ("t_cnt")), "", "Обработка данных - МБК");

    while ( true )
	    Table.SetValueCell("N5_A", sql.value ("t_balance"));     /*1*/
        Table.SetValueCell("N5_B", sql.value ("t_account"));
        Table.SetValueCell("N5_C", sql.value ("t_kind_account"));   
        Table.SetValueCell("N5_D", sql.value ("t_contrnum"));    /*4*/
        Table.SetValueCell("N5_E", sql.value ("t_clntname"));
        Table.SetValueCell("N5_F", sql.value ("t_restcurr"));    /*6*/
        Table.SetValueCell("N5_G", sql.value ("t_restrub"));
        Table.SetValueCell("N5_H", date (sql.value ("t_maturity")));
        Table.SetValueCell("N5_I", sql.value ("t_percent"));       /*9*/
        Table.SetValueCell("N5_J", sql.value ("t_quality"));       /*10*/
        Table.SetValueCell("N5_K", sql.value ("t_prcrez"));        
        Table.SetValueCell("N5_L", sql.value ("t_country"));       /*12*/
        Table.SetValueCell("N5_M", "=SUM(N"+"$"+line+":AE"+"$"+line+")");
        j = 0;
        for ( var c, getMBKPrcSum (int (sql.value ("t_dealid")), money (sql.value ("t_restrub")), sql.value ("t_percent")) )
            //xls.cells (line, j+14).value = c;
			Table.SetValueCell("N5_"+getCharNameCell(j+13), c); 
            j = j + 1;
        end;
        Table.AddStr();
        line = line + 1;
        useProgress (i=i+1);
        if ( not sql.moveNext () ) break; end;
    end;

    remProgress ();
	Table.EndTable();
    xls.SetAutoFilter ("A1:AE1", "МБК");

End;
//-----------------------------------------------------------------------------------------

Private macro makeReport
    Var xls, cntSheet = 1, s = 1;
    Var coeff_del = 0;

    if ( (xls = createXls ()) == NULL )
        msgbox ("Невозможно запустить табличный редактор");
        return;
    end;
    
    xls.OpenTemplate ("f_125_detail.xlsx", true);

    for (Var x, 1, 5, 1)
        if ( parm.("rep"+x) )
            execMacro ("makeReport"+x, xls);
        else
            if (xls.SheetDelete(x-coeff_del))
                coeff_del = coeff_del + 1;
            end;
        end;
    end;


//  xls.SaveTotalBook (null, false);
//  xls.RowHeigh(1, 20); //this.Sheet.Range("A"+String(Row+1)).RowHeight = Double(Height);
//  xls.SetAutoFit( "", xls.SheetName() ) : bool
//    xls.SetAutoFit("A:AO", "ЦБ");
    
//        xls.SaveAsTotalbook ("Расшифровка формы 125 на "+parm.("date"), true);
        xls.SaveAsTemplate("Расшифровка формы 125 на "+parm.("date"), true);
        xls.close ();
        xls = NULL;

End;
//-----------------------------------------------------------------------------------------

Private class (TRecHandler) CParam
    Var dprt = 0;
    initTRecHandler ("f125", "f125_detail.lbr", TRUE);

    Macro handler ( dlg, cmd, id, key )
        if ( (cmd == DLG_KEY) and (key == kbF3) and (id == fldIndex ("date")) )
            dlg.(id) = getDateByCalendar (dlg.(id));
        elif ( (cmd == DLG_KEY) and (key == kbF9) )
            return CM_IGNORE;
        elif ( (cmd == DLG_KEY) and (key == kbF2) )
            return CM_SAVE;
        elif ( (cmd == DLG_KEY) and (key == kbSpace) and inList (id, fldIndex ("rep1"), fldIndex ("rep2"), fldIndex ("rep3"), fldIndex ("rep4"), fldIndex ("rep5")) )
            dlg.(id) = ifThenElse (dlg.(id), "", "X");
        elif ( (cmd == DLG_KEY) and (key == kbSpace) and (id == fldIndex ("dprt")) )
            dlg.(id) = "Все";
            dprt = 0;
        elif ( (cmd == DLG_KEY) and (key == kbF3) and listDepartment (key = TRecHandler ("dp_dep")) )
            dlg.(id) = key.("name");
            dprt = key.("code");
        end;
    End;

    Macro Run
        this.("rep1") = this.("rep2") = this.("rep3") = this.("rep4") = this.("rep5") = "X";
        this.("dprt") = "Все";
        return runDialog (this, R2M (this, "Handler"));
    End;
End;
//-----------------------------------------------------------------------------------------
