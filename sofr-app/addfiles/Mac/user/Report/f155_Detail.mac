/*
$Name:         f155_Detail.mac
$Module:       ФИССиКО
$Description:  В.Горленко. Расшифровка для формы 155
*/
import globals, Календарь, oralib, likepy, rcw, rsexts, "cb_sql.mac";
import "Dl_RepCreditRisk.mac";

Private const kbF2 = 316, kbF3 = 317, kbF5 = 319, kbF9 = 323, kbESC = 27, kbSpace = 32;
Private var parm = genObject ("CParam"), xls, fName, csvTable, csvFile, sqlString, transport;
Private var isNeedAutoFilterForeignCur = false;
Private var isNeedAutoFilterSecurities = false;
Private var decsep = GetLocaleInfo (0, LOCALE_SDECIMAL, IsStandAlone ()),
            thosep = execMacro2 ("getThousand");
Private var SHEET_NAME_CURR = "Ин. валюта", SHEET_NAME_SEC = "ц.б.";
parm.("date") = {curdate};
parm.("rep1") = parm.("rep2") = parm.("rep3") = "X";

while ( parm.run () )
    execMacro ("makeReport");
end;
exit (1);
//-----------------------------------------------------------------------------------------

Private macro getThousand
    Var shell = CreateObject ("rsax", "TRsAxServer", "RsAxServer", false).CreateComObject ("WScript.Shell");
    return shell.RegRead ("HKEY_CURRENT_USER\\Control Panel\\International\\sThousand");
onError
    return " ";
End;
//-----------------------------------------------------------------------------------------

Private macro getDprtCode ( dprt )
    Var sql = execSqlSelect ("select t_name from ddp_dep_dbt where t_code = :1", makeArray (sqlParam ("1", dprt)));
    if ( sql.moveNext () )
        return sql.value (0);
    end;
    return "";
End;
//-----------------------------------------------------------------------------------------

Private macro createXls
    var printEngine = CTemplateXLS(NULL, NULL, NULL, NULL, NULL, NULL, true, false);

    if(printEngine.UsePoi())
        printEngine.SetXLSXFormat();
    end;

    printEngine.CreateTotalBook();

    return printEngine;
OnError
   return NULL;
End;
//-----------------------------------------------------------------------------------------

Private macro collectOutProc ( str )
    sqlString = sqlString + "\n" + trim (str);
End;
//-----------------------------------------------------------------------------------------

Private macro convertNullStr( val )
  if ( ( ValType( val ) == 26 ) or ( ValType( val ) == V_UNDEF ) ) 
    return "";
  else
    if ( val == StrFor( 1 ) )
      return "";
    else
      return val;
    end;
  end;
end;  
//-----------------------------------------------------------------------------------------

Private macro CaptureOutput
   sqlString = "";
   SetOutHandler (@collectOutProc);
End;
//-----------------------------------------------------------------------------------------

Private macro StopCaptureOutput
    SetOutHandler ();
    return sqlString;
End;
//-----------------------------------------------------------------------------------------

Private macro OraDate ( dt )
    if ( dt == NULL )
        return date (0,0,0);
    elif ( ValType (dt) == 26 )
        return date (0,0,0);
    elif ( dt == Date (2,1,1)-1 )
        return Date (0,0,0);
    end;
    return Date (dt);
End;
//-----------------------------------------------------------------------------------------

Private macro makeReport
    if ( parm.("rep1") or parm.("rep2"))
        if ( parm.("class") )
            transport = genObject ("CTarnsport");
            if ( transport.done )
                return;
            end;
        end;

        if ( (xls = createXls ()) == NULL )
            msgbox ("Невозможно запустить табличный редактор");
            return;
        end;

        //if ( not xls.application.UseSystemSeparators )
        //    decsep = xls.application.DecimalSeparator;
        //    thosep = xls.application.ThousandsSeparator;
        //end;

        decsep = ",";
        thosep = " ";

        if ( parm.("rep1") )
            if ( not execMacro2 ("makeReport1") )
                csvFile.FileClose ();
                csvFile = NULL;
                csvTable = NULL;
                xls.close ();
                xls = NULL;
                return;
            end;
            // Имена листов задаются в процессе заполнения листов данными
            /*if ( parm.("rep2") )
                xls.Sheets (1).Name = "Ин. валюта";
                xls.Sheets.add ();
                xls.Sheets (1).Name = "ц.б.";
                xls.Sheets (2).move (xls.Sheets (1));
                xls.Sheets (2).select ();
            end;*/
        end;
        if ( parm.("rep2") )
            if ( not execMacro2 ("makeReport2") )
                csvFile.FileClose ();
                csvFile = NULL;
                csvTable = NULL;
                xls.close ();
                xls = NULL;
                return;
            end;
        end;

        if ( parm.("class") )
            transport.save ();
        end;

        xls.SaveTotalBook (null, false);
        if (isNeedAutoFilterForeignCur)
            xls.SetAutoFilter ("A4:AY4", SHEET_NAME_CURR);
        end;
        if (isNeedAutoFilterSecurities)
            xls.SetAutoFilter ("A4:AI4", SHEET_NAME_SEC);
        end;
        xls.SaveAsTotalbook ("Расшифровка формы 155 на "+parm.("date"), true);
        xls = NULL;
    end;

    if ( parm.("rep3") )
        CreditRisk_RunReport ( parm.("date") );
    end;
End;


    private macro getRatingCountryRep(ObjType, ObjID, NoteKind, ParentId, rtDate)

       var sql="select da.t_name "+
                 "from dobjattr_dbt da "+
                 "join dobjatcor_dbt dc on da.t_objecttype = dc.t_objecttype and da.t_groupid = dc.t_groupid and da.t_attrid = dc.t_attrid "+
                 "JOIN dcountry_dbt dco ON  dco.t_codelat3 = :ObjID " +
                 "where dc.t_objecttype = :ObjType "+  //ценная бумага
                   "and dc.t_groupid = :NoteKind "+     //рейтинг
                   "and dc.t_object =  lpad( dco.t_countryid , 10, '0') "+
                   "and :rtDate between dc.t_validfromdate and dc.t_validtodate "+
                   "and (dc.t_sysdate, dc.t_systime) = (select max(o.t_sysdate), max(o.t_systime) from dobjatcor_dbt o "+       //выбираем последний рейтинг по текущему объекту
                                                                                                 "join dobjattr_dbt w on w.t_objecttype = o.t_objecttype and w.t_groupid = o.t_groupid and w.t_attrid = o.t_attrid "+
                                                                                                 "where o.t_objecttype = :ObjType1 "+  //ценная бумага
                                                                                                 "and o.t_groupid = :NoteKind1 "+       //рейтинг
                                                                                                 "and o.t_object = lpad( dco.t_countryid , 10, '0') "+
                                                                                                 "and :rtDate1 between o.t_validfromdate and o.t_validtodate "+
                                                                                                 "and w.t_codelist=da.t_codelist) "+
                   "and da.t_parentid= :ParentId";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":ObjID", RSDBP_IN, ObjID);
	    cmd.addParam(":ObjType", RSDBP_IN, ObjType);
	    cmd.addParam(":NoteKind", RSDBP_IN, NoteKind);
	    cmd.addParam(":rtDate", RSDBP_IN, rtDate);

	    cmd.addParam(":ObjType1", RSDBP_IN, ObjType);
	    cmd.addParam(":NoteKind1", RSDBP_IN, NoteKind);
	    cmd.addParam(":rtDate1", RSDBP_IN, rtDate);
	    cmd.addParam(":ParentId", RSDBP_IN, ParentId);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "";
        end;

    end;


    private macro getRatingRepOnDate(ObjType, ObjID, NoteKind, ParentId, rtDate)
       var sql="select da.t_name "+
                 "from dobjattr_dbt da "+
                 "join dobjatcor_dbt dc on da.t_objecttype = dc.t_objecttype and da.t_groupid = dc.t_groupid and da.t_attrid = dc.t_attrid "+
                 "where dc.t_objecttype = :ObjType "+  //ценная бумага
                   "and dc.t_groupid = :NoteKind "+     //рейтинг
                   "and dc.t_object = lpad( :ObjID , 10, '0') "+
                   "and :rtDate between dc.t_validfromdate and dc.t_validtodate "+
                   "and (dc.t_sysdate, dc.t_systime) = (select max(o.t_sysdate), max(o.t_systime) from dobjatcor_dbt o "+       //выбираем последний рейтинг по текущему объекту
                                                                                                 "join dobjattr_dbt w on w.t_objecttype = o.t_objecttype and w.t_groupid = o.t_groupid and w.t_attrid = o.t_attrid "+
                                                                                                 "where o.t_objecttype = :ObjType1 "+  //ценная бумага
                                                                                                 "and o.t_groupid = :NoteKind1 "+       //рейтинг
                                                                                                 "and o.t_object = lpad( :ObjID1 , 10, '0') "+
                                                                                                 "and :rtDate1 between o.t_validfromdate and o.t_validtodate "+
                                                                                                 "and w.t_codelist=da.t_codelist) "+
                   "and da.t_parentid= :ParentId";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":ObjType", RSDBP_IN, ObjType);
	    cmd.addParam(":NoteKind", RSDBP_IN, NoteKind);
	    cmd.addParam(":ObjID", RSDBP_IN, ObjID);
	    cmd.addParam(":rtDate", RSDBP_IN, rtDate);

	    cmd.addParam(":ObjType1", RSDBP_IN, ObjType);
	    cmd.addParam(":NoteKind1", RSDBP_IN, NoteKind);
	    cmd.addParam(":ObjID1", RSDBP_IN, ObjID);
	    cmd.addParam(":rtDate1", RSDBP_IN, rtDate);
	    cmd.addParam(":ParentId", RSDBP_IN, ParentId);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "";
        end;

    end;

    private macro getRatingRep(ObjType, ObjID, NoteKind, ParentId, rtDate)
      var RatingValue = "";


      if((ObjType == 3) and ((ParentID == 459) or (ParentID == 483) or (ParentID == 505)))
        if(rtDate < date(19,01,2015))
          RatingValue = "";
        elif((rtDate >= date(19,01,2015)) and (rtDate < date(25,02,2022)))
          var query, cmd;
          var IsBank = 0;

          if(ObjID != 618) //ВЭБ.РФ не считаем КО
            query = "SELECT NVL((SELECT 1 FROM dpartyown_dbt WHERE t_PartyID = :PartyID AND t_PartyKind = 2 AND ROWNUM = 1), 0) as IsBank FROM DUAL";
            cmd = rsdCommand(query);
            cmd.addParam(":PartyID", RSDBP_IN, ObjID);
            cmd.Execute();
            var getData = TRsbDataSet(cmd);

            var rs = rsdRecordSet(cmd);
            if (rs.MoveNext)
              IsBank = rs.Value(0);
            end;
          end;

          if(IsBank == 1)
            RatingValue = GetRatingRepOnDate(ObjType, ObjID, NoteKind, ParentId, date(01,03,2014));
          else
            RatingValue = GetRatingRepOnDate(ObjType, ObjID, NoteKind, ParentId, date(01,12,2014));
          end;
        else
          RatingValue = GetRatingRepOnDate(ObjType, ObjID, NoteKind, ParentId, date(01,02,2022));
        end;
      else
        RatingValue = GetRatingRepOnDate(ObjType, ObjID, NoteKind, ParentId, rtDate);
      end;

      return RatingValue;
    end;

//-----------------------------------------------------------------------------------------

Private macro getReiting ( id )
    Var sql = execSqlSelect ("select (select (select t_name from dobjattr_dbt where t_objecttype=3 and t_groupid=19 and t_attrid = x.t_parentid) from dobjattr_dbt x where t_objecttype=3 and t_groupid=19 and t_attrid=a.t_attrid), (select t_name from dobjattr_dbt where t_objecttype=3 and t_groupid=19 and t_attrid=a.t_attrid) "+
                             "from dobjatcor_dbt a where t_objecttype = 3 and t_object = lpad (:1, 10, '0') and t_groupid = 19 and :2 between t_validfromdate and t_validtodate "+
                             "and (select t_numinlist from dobjattr_dbt where t_objecttype=3 and t_groupid=19 and t_attrid=a.t_attrid) = "+
                             "  (select min ((select t_numinlist from dobjattr_dbt where t_objecttype=3 and t_groupid=19 and t_attrid=a.t_attrid)) from dobjatcor_dbt a where t_objecttype = 3 and t_object = lpad (:3, 10, '0') and t_groupid = 19 and :4 between t_validfromdate and t_validtodate)",
                             makeArray (sqlParam ("1", id), sqlParam ("2", parm.("date")), sqlParam ("3", id), sqlParam ("4", parm.("date"))));
    if ( sql.moveNext () )
        //return string (sql.value (0), "/", sql.value (1));
        return strSubst (strSubst (strSubst (sql.value (1), "(RU)", ""), ".ru", ""), "ru", "");
    end;
    return "";
End;
//-----------------------------------------------------------------------------------------

Private macro getReitingA ( id, a )
    Var sql = execSqlSelect ("select (select t_name from dobjattr_dbt where t_objecttype=3 and t_groupid=19 and t_attrid = f.t_attrid) from dobjatcor_dbt f where t_objecttype=3 and t_groupid=19 and t_object=lpad (:1, 10, '0') and :2 between t_validfromdate and t_validtodate "+
                             "and exists (select 1 from dobjattr_dbt where t_objecttype = 3 and t_groupid=19 and t_attrid = f.t_attrid and t_codelist = :3)",
                            makeArray (sqlParam ("1", id), sqlParam ("2", parm.("date")), sqlParam ("3", a)));
    if ( sql.moveNext () )
        return sql.value (0);
    end;
    return "";
End;
//----------------------------------------------------------------------------------------

Private macro fillReport1 ( sql, i, t )
    csvFile.AddCell(convertNullStr(sql.value ("t_extcode")));
    csvFile.AddCell(convertNullStr(sql.value ("t_contrname")));
    csvFile.AddCell(convertNullStr(sql.value ("t_sogl")));
    csvFile.AddCell(convertNullStr(sql.value ("t_contrkind")));
    csvFile.AddCell(convertNullStr(sql.value ("t_dealtype")));
    csvFile.AddCell(convertNullStr(sql.value ("t_contrcountry")));
    csvFile.AddCell(convertNullStr(getRatingRep(3, int (sql.value ("t_contractor")), 122, 110, parm.("date")))); //рейтинг контрагента (Standart&Poors) в национальной валюте
    csvFile.AddCell(convertNullStr(getRatingRep(3, int (sql.value ("t_contractor")), 122, 459, parm.("date")))); //рейтинг контрагента (Standart&Poors) в национальной валюте по 3453
    csvFile.AddCell(convertNullStr(getRatingRep(3, int (sql.value ("t_contractor")), 122, 210, parm.("date")))); //рейтинг контрагента (Moodys)  в национальной валюте
    csvFile.AddCell(convertNullStr(getRatingRep(3, int (sql.value ("t_contractor")), 122, 483, parm.("date")))); //рейтинг контрагента (Moodys)  в национальной валюте по 3453
    csvFile.AddCell(convertNullStr(getRatingRep(3, int (sql.value ("t_contractor")), 122, 310, parm.("date")))); //рейтинг контрагента (Fitch Ratings)  в национальной валюте
    csvFile.AddCell(convertNullStr(getRatingRep(3, int (sql.value ("t_contractor")), 122, 505, parm.("date")))); //рейтинг контрагента (Fitch Ratings)  в национальной валюте по 3453
    csvFile.AddCell(convertNullStr(getRatingRep(3, int (sql.value ("t_contractor")), 123, 110, parm.("date")))); //рейтинг контрагента (Standart&Poors) в иностранной валюте
    csvFile.AddCell(convertNullStr(getRatingRep(3, int (sql.value ("t_contractor")), 123, 459, parm.("date")))); //рейтинг контрагента (Standart&Poors) в иностранной валюте по 3453
    csvFile.AddCell(convertNullStr(getRatingRep(3, int (sql.value ("t_contractor")), 123, 210, parm.("date")))); //рейтинг контрагента (Moodys)  в иностранной валюте
    csvFile.AddCell(convertNullStr(getRatingRep(3, int (sql.value ("t_contractor")), 123, 483, parm.("date")))); //рейтинг контрагента (Moodys)  в иностранной валюте по 3453
    csvFile.AddCell(convertNullStr(getRatingRep(3, int (sql.value ("t_contractor")), 123, 310, parm.("date")))); //рейтинг контрагента (Fitch Ratings)  в иностранной валюте
    csvFile.AddCell(convertNullStr(getRatingRep(3, int (sql.value ("t_contractor")), 123, 505, parm.("date")))); //рейтинг контрагента (Fitch Ratings)  в иностранной валюте по 3453
    csvFile.AddCell(convertNullStr(getRatingRep(OBJTYPE_PARTY, int (sql.value ("t_contractor")), 122, 436, parm.("date")))); //рейтинг контрагента (АКРА)
    csvFile.AddCell(convertNullStr(getRatingRep(OBJTYPE_PARTY, int (sql.value ("t_contractor")), 122, 367, parm.("date")))); //рейтинг контрагента (Эксперт РА)
    csvFile.AddCell(convertNullStr(getRatingRep(OBJTYPE_PARTY, int (sql.value ("t_contractor")), 122, 610, parm.("date")))); //рейтинг контрагента (НКР)
    csvFile.AddCell(convertNullStr(getRatingRep(OBJTYPE_PARTY, int (sql.value ("t_contractor")), 122, 379, parm.("date")))); //рейтинг контрагента (НРА)
    csvFile.AddCell(convertNullStr(getRatingCountryRep(5, sql.value ("t_contrcountry"), 101, 110, parm.("date"))));  //рейтинг страны  (Standart&Poors) в национальной валюте
    csvFile.AddCell(convertNullStr(getRatingCountryRep(5, sql.value ("t_contrcountry"), 101, 210, parm.("date"))));  //рейтинг страны  (Moodys) в национальной валюте
    csvFile.AddCell(convertNullStr(getRatingCountryRep(5, sql.value ("t_contrcountry"), 101, 310, parm.("date"))));  //рейтинг страны  (Fitch Ratings) в национальной валюте
    csvFile.AddCell(convertNullStr(sql.value ("t_finame")));
    csvFile.AddCell(convertNullStr(sql.value ("t_BA")));
    csvFile.AddCell(convertNullStr(sql.value ("t_dealkind1")));
    csvFile.AddCell(convertNullStr(sql.value ("t_dealkind2")));
    csvFile.AddCell(convertNullStr(sql.value ("t_napr")));
    csvFile.AddCell(convertNullStr(sql.value ("t_date")));
    csvFile.AddCell(convertNullStr(sql.value ("t_enddate")));
    csvFile.AddCell(convertNullStr(sql.value ("t_acc1")));
    csvFile.AddCell(convertNullStr(sql.value ("t_sum1")));
    csvFile.AddCell(convertNullStr(sql.value ("t_sumnat1")));
    csvFile.AddCell(convertNullStr(sql.value ("t_sum2")));
    csvFile.AddCell(convertNullStr(sql.value ("t_sumnat2")));
    csvFile.AddCell(convertNullStr(sql.value ("t_acc2")));
    csvFile.AddCell(convertNullStr(sql.value ("t_sum3")));
    csvFile.AddCell(convertNullStr(sql.value ("t_sumnat3")));
    csvFile.AddCell(convertNullStr(sql.value ("t_sum4")));
    csvFile.AddCell(convertNullStr(sql.value ("t_sumnat4")));
    csvFile.AddCell(convertNullStr(sql.value ("t_acc3")));
    csvFile.AddCell(convertNullStr(sql.value ("t_sum5")));
    csvFile.AddCell(convertNullStr(sql.value ("t_sum6")));
    csvFile.AddCell(convertNullStr(sql.value ("t_liqnetting")));
    csvFile.AddCell(convertNullStr(sql.value ("t_netting")));
    csvFile.AddCell("");

    var valForCell49;
    if ( ( sql.value ("t_finame") == "Процентный СВОП" ) or ( sql.value ("t_finame") == "Валютно-процентный СВОП" ) ) /*PNV i-support 499675*/
        if(oraDate (sql.value ("t_fixdate")) > Date("01.01.0001"))
           valForCell49 = oraDate (sql.value ("t_fixdate"));
        elif( oraDate((sql.value ("t_lastfixdate"))) > oraDate(sql.value ("last_day_")) )
           valForCell49 = oraDate (sql.value ("last_day_"));
        else
           valForCell49 =  " ";
        end;
        if ( (valForCell49 != " ") AND (valForCell49 > oraDate(sql.value ("t_enddate"))) )
           valForCell49 = oraDate (sql.value ("t_enddate")) -1;
        end;
	    if ( sql.value ("t_extcode") == "IRS:508" )
	       valForCell49 =  " ";
	    end;
    end;
    csvFile.AddCell(convertNullStr(valForCell49));
    csvFile.AddCell(convertNullStr(sql.value ("t_bal")));
    csvFile.AddCell(convertNullStr("=AN" + String(i+1)));
    csvFile.AddRow();

    if ( parm.("class") )
        transport.addRow (convertNullStr(sql.value ("t_extcode")),
                          convertNullStr(sql.value ("t_finame")),
                          convertNullStr(sql.value ("t_napr")),
                          convertNullStr(sql.value ("t_ba")),
                          convertNullStr(sql.value ("t_acc3")),
                          convertNullStr(ifThenElse (sql.value ("t_sum5"), sql.value ("t_sum5"), sql.value ("t_sum6"))),
                          convertNullStr(sql.value ("t_sumnat1")),
                          convertNullStr(sql.value ("t_sumnat3")),
                          convertNullStr(sql.value ("t_sum5")),
                          convertNullStr(sql.value ("t_sum6")),
                          t);
    end;
End;
//-----------------------------------------------------------------------------------------

Private macro fillReport2 ( sql, i, f13 )
    csvFile.AddCell(i+1);
    csvFile.AddCell(convertNullStr(sql.value ("t_dealcodets")));
    csvFile.AddCell(convertNullStr(sql.value ("t_contrname")));
    csvFile.AddCell(convertNullStr(sql.value ("t_sogl")));
    csvFile.AddCell(convertNullStr(sql.value ("t_contrkind")));
    csvFile.AddCell(convertNullStr(sql.value ("t_dealtype")));
    csvFile.AddCell(convertNullStr(sql.value ("t_contrcountry")));
    csvFile.AddCell(convertNullStr(sql.value ("t_countryrisk")));
    csvFile.AddCell("");
    csvFile.AddCell(convertNullStr(getReiting (int (sql.value ("t_partyid")))));
    csvFile.AddCell(convertNullStr(getReitingA (int (sql.value ("t_issuer")), "АКРА")));
    csvFile.AddCell(convertNullStr(getReitingA (int (sql.value ("t_issuer")), "Эксп. РА")));
    csvFile.AddCell(convertNullStr(sql.value ("t_finame")));
    csvFile.AddCell(convertNullStr(sql.value ("t_BA")));
    csvFile.AddCell(convertNullStr(sql.value ("t_dealkind1")));
    csvFile.AddCell(convertNullStr(sql.value ("t_dealkind2")));
    csvFile.AddCell(convertNullStr(sql.value ("t_napr")));
    csvFile.AddCell(convertNullStr(sql.value ("t_date")));
    csvFile.AddCell(convertNullStr(sql.value ("t_enddate")));
    csvFile.AddCell(convertNullStr(sql.value ("t_acc1")));
    csvFile.AddCell(convertNullStr(sql.value ("t_fiacc1")));
    csvFile.AddCell(convertNullStr(sql.value ("t_sum1")));
    csvFile.AddCell(convertNullStr(sql.value ("t_sumnat1")));
    csvFile.AddCell(convertNullStr(sql.value ("t_acc2")));
    csvFile.AddCell(convertNullStr(sql.value ("t_fiacc2")));
    csvFile.AddCell(convertNullStr(sql.value ("t_sum2")));
    csvFile.AddCell(convertNullStr(sql.value ("t_sumnat2")));
    csvFile.AddCell(convertNullStr(sql.value ("t_acc3")));
    csvFile.AddCell(convertNullStr(sql.value ("t_sum3")));
    csvFile.AddCell(convertNullStr(sql.value ("t_sum4")));
    csvFile.AddCell(convertNullStr(sql.value ("t_liqnetting")));
    csvFile.AddCell(convertNullStr(sql.value ("t_netting")));
    csvFile.AddCell("");
    csvFile.AddCell("");
    csvFile.AddCell("");
    csvFile.AddRow();

    if ( parm.("class") )
        transport.addRow (convertNullStr(sql.value ("t_dealcodets")),
                          convertNullStr(sql.value ("t_finame")),
                          convertNullStr(sql.value ("t_napr")),
                          "цб",
                          convertNullStr(sql.value ("t_acc3")),
                          convertNullStr(ifThenElse (sql.value ("t_sum3"), sql.value ("t_sum3"), sql.value ("t_sum4"))),
                          convertNullStr(sql.value ("t_sumnat1")),
                          convertNullStr(sql.value ("t_sumnat2")),
                          convertNullStr(sql.value ("t_sum3")),
                          convertNullStr(sql.value ("t_sum4")),
                          1,
                          f13);
    end;
End;
//-----------------------------------------------------------------------------------------

Private macro makeReport1
    var SHEET_NAME = SHEET_NAME_CURR;
    begAction (100, "Отбор сделок", false);
    testEvent (1);
    captureOutput ();
    [with parm as (select :1 t_dt from dual)
     select t.*,
            case when t_dvkind=4 then case
                                           when t_type = 7 /*Fix/Float*/ then substr(t_acc1, 1, 5) /*треб*/
                                           when t_type = 8 /*Float/Fix*/ then substr(t_acc2, 1, 5) /*обяз*/
                                           when t_napr = 'Покупка' then substr(t_acc1, 1, 5)
                                           when t_napr = 'Продажа' then substr(t_acc2, 1, 5)
                                           when t_napr is null then substr(t_acc1, 1, 5) || ', ' || substr(t_acc2, 1, 5)

                                      end
            end as t_bal
     from (
         select deal.t_code t_extcode
               ,deal.t_dvkind
               ,deal.t_type
               ,(select t_shortname from dparty_dbt where t_partyid = deal.t_contractor) t_contrname
               ,(select t_nrcountry from dparty_dbt where t_partyid = deal.t_contractor) t_contrcountry
               ,decode (deal.t_sector, 'X', '', (select trim ((select t_code from dllvalues_dbt where t_list = 4016 and t_element = t_authorform)||' Договор № '||t_code||' от '||to_char (t_date_genagr, 'dd.mm.yyyy')) from ddl_genagr_dbt where t_genagrid =  deal.t_genagrid)) t_sogl
               ,nvl ((select 'Банк' from dpartyown_dbt where t_partykind = 2 and t_partyid = deal.t_contractor), (select decode (t_legalform, 1, 'ЮЛ', 'ФЛ') from dparty_dbt where t_partyid = t_contractor)) t_contrkind
               ,decode (t_DVKind, 5, 'срочная', 'ПФИ') t_dealtype
               ,deal.t_contractor
               , case WHEN EXISTS (SELECT 1 FROM ddvnfi_dbt WHERE t_dealid = deal.t_id AND EXISTS (SELECT 1 FROM dfininstr_dbt WHERE t_fiid = ddvnfi_dbt.t_fiid AND t_fi_kind = 3)) then
                     case when t_dvkind = 2 then case when deal.t_optiontype = 1 and deal.t_type = 1 /*buy put*/
                                                 then 'Покупка опциона floor'
                                                 when deal.t_optiontype = 1 and deal.t_type = 2 /*sell put*/
                                                 then 'Продажа опциона floor'
                                                 when deal.t_optiontype = 2 and deal.t_type = 1 /*buy call*/
                                                 then 'Покупка опциона cap'
                                                 when deal.t_optiontype = 2 and deal.t_type = 2 /*sell call*/
                                                 then 'Продажа опциона cap'
                                       end
                      end

               else decode (t_dvkind,
                        1, 'Форвард',
                        2, decode (deal.t_type, 1, 'Покупка', 2, 'Продажа')||' опциона на '||decode (deal.t_optiontype, 1/*Put*/, 'продажу ', 2/*Call*/, 'покупку ')||
                                                      case when exists (select 1 from ddvnfi_dbt where t_dealid = deal.t_id and exists (select 1 from dfininstr_dbt where t_fiid=ddvnfi_dbt.t_fiid and t_fi_kind=1)) then 'валюты'
                                                           when exists (select 1 from ddvnfi_dbt where t_dealid = deal.t_id and exists (select 1 from dfininstr_dbt where t_fiid=ddvnfi_dbt.t_fiid and t_fi_kind=6)) then 'драг. металлов' end,
                        3, 'СВОП',
                        6, 'СВОП',
                        --4, case when exists (select 1 from ddvnfi_dbt where t_dealid = deal.t_id and t_exectype = 0) then 'Процентный СВОП' else 'Валютно-процентный СВОП' end,
                        4, case when (select t_fiid from ddvnfi_dbt where t_dealid = deal.t_id and t_type = 0) = (select t_fiid from ddvnfi_dbt where t_dealid = deal.t_id and t_type = 2)
                                then 'Процентный СВОП'
                                else 'Валютно-процентный СВОП'
                           end,
                        5, decode (deal.t_type, 1, 'Покупка', 2, 'Продажа')||
                                                      case when exists (select 1 from ddvnfi_dbt where t_dealid = deal.t_id and exists (select 1 from dfininstr_dbt where t_fiid=ddvnfi_dbt.t_fiid and t_fi_kind=1)) then 'валюты'
                                                           when exists (select 1 from ddvnfi_dbt where t_dealid = deal.t_id and exists (select 1 from dfininstr_dbt where t_fiid=ddvnfi_dbt.t_fiid and t_fi_kind=6)) then 'драг. металлов' end
                       ) end t_finame
               , case WHEN EXISTS (SELECT 1 FROM ddvnfi_dbt WHERE t_dealid = deal.t_id AND EXISTS (SELECT 1 FROM dfininstr_dbt WHERE t_fiid = ddvnfi_dbt.t_fiid AND t_fi_kind = 3)) then 'Процентная ставка'
                     else case when deal.t_kind = 22720 then 'Процентная ставка'
                               when exists (select 1 from ddvnfi_dbt where t_dealid = deal.t_id and exists (select 1 from dfininstr_dbt where t_fiid=ddvnfi_dbt.t_fiid and t_fi_kind=1)) then 'Валюта'
                               when exists (select 1 from ddvnfi_dbt where t_dealid = deal.t_id and exists (select 1 from dfininstr_dbt where t_fiid=ddvnfi_dbt.t_fiid and t_fi_kind=7)) then (select t_name from dfininstr_dbt where t_fiid = (select ddvnfi_dbt.t_fiid from ddvnfi_dbt where t_dealid = deal.t_id ))
                               when exists (select 1 from ddvnfi_dbt where t_dealid = deal.t_id and exists (select 1 from dfininstr_dbt where t_fiid=ddvnfi_dbt.t_fiid and t_fi_kind=6)) then 'Драг. металл' end end t_BA
               ,case when exists (select 1 from ddvnfi_dbt where t_dealid = deal.t_id and t_exectype = 1) then 'Поставочная' else 'Беспоставочная' end t_dealkind1
               ,case when deal.t_sector = 'X' or exists (select 1 from dpartyown_dbt where t_partyid=deal.t_contractor and t_partykind=3) then 'биржевая' else 'внебиржевая' end t_dealkind2
               ,case when t_dvkind in (1, 5) then decode (deal.t_type, 1, 'Покупка', 2, 'Продажа')
                     when t_dvkind = 2 then case when deal.t_optiontype = 1 and deal.t_type = 1 /*buy put*/
                                                 then 'Продажа'
                                                 when deal.t_optiontype = 1 and deal.t_type = 2 /*sell put*/
                                                 then 'Покупка'
                                                 when deal.t_optiontype = 2 and deal.t_type = 1 /*buy call*/
                                                 then 'Покупка' /* old:'Продажа' pdv DEF-14759 */
                                                 when deal.t_optiontype = 2 and deal.t_type = 2 /*sell call*/
                                                 then 'Продажа'/* old:'Покупка' pdv DEF-14759 */
                                       end
                     when t_dvkind in (3, 6) then decode (deal.t_type, 5, 'Продажа', 6, 'Покупка')
                     when t_dvkind = 4 then case when exists (select 1 from ddvnfi_dbt where t_dealid = deal.t_id and t_type = 0 and t_rateid = -1) and exists (select 1 from ddvnfi_dbt where t_dealid=deal.t_id and t_type = 2 and t_rateid = -1)
                                                   and exists (select 1 from ddvnfi_dbt where t_dealid = deal.t_id and t_type = 0 and t_fiid = 0)
                                               then 'Покупка'/*PNV i-support 499675 Покупка\продажа*/
                                               when exists (select 1 from ddvnfi_dbt where t_dealid = deal.t_id and t_type = 0 and t_rateid = -1) and exists (select 1 from ddvnfi_dbt where t_dealid=deal.t_id and t_type = 2 and t_rateid = -1)
                                                   and exists (select 1 from ddvnfi_dbt where t_dealid = deal.t_id and t_type = 0 and t_fiid <> 0)
                                               then 'Продажа'/*PNV i-support 499675 Покупка\продажа*/
                                               when exists (select 1 from ddvnfi_dbt where t_dealid=deal.t_id and t_type=0 and t_rateid!=-1) and exists (select 1 from ddvnfi_dbt where t_dealid=deal.t_id and t_type=2 and t_rateid=-1)
                                               then 'Продажа'
                                               when exists (select 1 from ddvnfi_dbt where t_dealid=deal.t_id and t_type=0 and t_rateid=-1) and exists (select 1 from ddvnfi_dbt where t_dealid=deal.t_id and t_type=2 and t_rateid!=-1)
                                               then 'Покупка'
                                          end
                end t_napr
               ,t_date
               ,case when t_dvkind in (3, 6) then (select t_paydate from ddvnfi_dbt where t_dealid = deal.t_id and t_type = 0) else (select t_execdate from ddvnfi_dbt where t_dealid=deal.t_id and t_type=0 and t_opendate = chr (0)) end t_enddate
               ,(select listagg (t_account, ', ') within group (order by t_account) from dmcaccdoc_dbt where (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) from dual) != 0 and t_catnum in (303, 1224, 1228, 1213,5016) and t_docid = deal.t_id and ((select t_dt from parm) between t_activatedate and decode (t_disablingdate, to_date ('01010001','ddmmyyyy'), to_date ('31129999','ddmmyyyy'), t_disablingdate))) t_acc1
               ,(select -sum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency)) from dmcaccdoc_dbt where t_catnum in (303, 1224, 1228, 1213,5016) and t_dockind in (199,4815) and t_docid = deal.t_id and ((select t_dt from parm) between t_activatedate and decode (t_disablingdate, to_date ('01010001','ddmmyyyy'), to_date ('31129999','ddmmyyyy'), t_disablingdate))) t_sum1
               ,(select -sum (rsb_fiinstr.convsum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency), t_currency, 0, (select t_dt-1 from parm), 2)) from dmcaccdoc_dbt where t_catnum in (303, 1224, 1228, 1213,5016) and t_dockind in (199,4815) and t_docid = deal.t_id and ((select t_dt from parm) between t_activatedate and decode (t_disablingdate, to_date ('01010001','ddmmyyyy'), to_date ('31129999','ddmmyyyy'), t_disablingdate))) t_sumnat1
               ,(select sum (t_paymentsum) from ddvnpmgr_dbt where t_dealid=deal.t_id and t_side = 2 and not exists (select 1 from ddvnacdl_dbt where t_dealid=deal.t_id and t_paykind=70 and t_date=t_paydate and t_date > (select t_dt from parm))) t_sum2
               ,(select sum (rsb_fiinstr.ConvSum (t_paymentsum, (select t_fiid from ddvnfi_dbt where t_type=0 and t_dealid=deal.t_id), 0, (select t_dt-1 from parm), 2)) from ddvnpmgr_dbt where t_dealid=deal.t_id and t_side = 2 and not exists (select 1 from ddvnacdl_dbt where t_dealid=deal.t_id and t_paykind=70 and t_date=t_paydate and t_date > (select t_dt from parm))) t_sumnat2
               ,(select listagg (t_account, ', ') within group (order by t_account) from dmcaccdoc_dbt where (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) from dual) != 0 and t_catnum in (304, 1225, 1229, 1214,5019) and t_docid = deal.t_id and ((select t_dt from parm) between t_activatedate and decode (t_disablingdate, to_date ('01010001','ddmmyyyy'), to_date ('31129999','ddmmyyyy'), t_disablingdate))) t_acc2
               ,(select sum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency)) from dmcaccdoc_dbt where t_catnum in (304, 1225, 122, 1214,5019) and t_docid = deal.t_id and ((select t_dt from parm) between t_activatedate and decode (t_disablingdate, to_date ('01010001','ddmmyyyy'), to_date ('31129999','ddmmyyyy'), t_disablingdate))) t_sum3
               ,(select sum (rsb_fiinstr.convsum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency), t_currency, 0, (select t_dt-1 from parm), 2)) from dmcaccdoc_dbt where t_catnum in (304, 1225, 122, 1214,5019) and t_docid = deal.t_id and ((select t_dt from parm) between t_activatedate and decode (t_disablingdate, to_date ('01010001','ddmmyyyy'), to_date ('31129999','ddmmyyyy'), t_disablingdate))) t_sumnat3
               ,(select sum (t_paymentsum) from ddvnpmgr_dbt where t_dealid=deal.t_id and t_side = 1 and not exists (select 1 from ddvnacdl_dbt where t_dealid=deal.t_id and t_paykind=70 and t_date=t_paydate and t_date > (select t_dt from parm))) t_sum4
               ,(select sum (rsb_fiinstr.ConvSum (t_paymentsum, (select t_fiid from ddvnfi_dbt where t_type=2 and t_dealid=deal.t_id), 0, (select t_dt-1 from parm), 2)) from ddvnpmgr_dbt where t_dealid=deal.t_id and t_side = 1 and not exists (select 1 from ddvnacdl_dbt where t_dealid=deal.t_id and t_paykind=70 and t_date=t_paydate and t_date > (select t_dt from parm))) t_sumnat4
               ,(select listagg (t_account, ', ') within group (order by t_account) from dmcaccdoc_dbt where t_catnum in (1217, 1218,5013,5014) and rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) != 0 and t_docid = deal.t_id and ((select t_dt from parm) between t_activatedate and decode (t_disablingdate, to_date ('01010001','ddmmyyyy'), to_date ('31129999','ddmmyyyy'), t_disablingdate))) t_acc3      /*PNV счет 526* с остатком может быть только один, проверять дату действия не нужно*/
               ,(select -sum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency)) from dmcaccdoc_dbt where t_catnum in (1217,5013) and t_docid = deal.t_id and ((select t_dt from parm) between t_activatedate and decode (t_disablingdate, to_date ('01010001','ddmmyyyy'), to_date ('31129999','ddmmyyyy'), t_disablingdate))) t_sum5                                                                             /*PNV счсчет 526* с остатком может быть только один, проверять дату действия не нужно*/
               ,(select sum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency)) from dmcaccdoc_dbt where t_catnum in (1218,5014) and t_docid = deal.t_id and ((select t_dt from parm) between t_activatedate and decode (t_disablingdate, to_date ('01010001','ddmmyyyy'), to_date ('31129999','ddmmyyyy'), t_disablingdate))) t_sum6                                                                              /*PNV счсчет 526* с остатком может быть только один, проверять дату действия не нужно*/
               ,nvl ((select 'ДА' from ddl_genagr_dbt where t_can_liquidnetting = 'X' and t_genagrid =  deal.t_genagrid), 'НЕТ') t_liqnetting
               ,case when exists (select 1 from dpmpaym_dbt where t_netting = 'X' and t_dockind = deal.t_dockind and t_documentid = deal.t_id) then 'ДА' else 'НЕТ' end t_netting
               , NVL((SELECT min(t_fixdate) FROM dv_dvnpmgr WHERE     t_dealid = deal.t_id AND t_type = 3 AND t_fixdate BETWEEN (select t_dt from parm) and (select last_day(t_dt) from parm)), to_date('01.01.0001','DD.MM.YYYY')) t_fixdate /*PNV дата фиксации - наименьшая из дат фиксации графика за отчетный период (месяца)*/
               , NVL((SELECT max(t_fixdate) FROM dv_dvnpmgr WHERE t_dealid = deal.t_id AND t_type = 3), to_date('01.01.0001','DD.MM.YYYY')) t_lastfixdate
               ,(select decode (rsi_rsbcalendar.isWorkDay (last_day (t_dt)), 1, last_day (t_dt), rsi_rsbcalendar.GetDateAfterWorkDay (last_day (t_dt), -1)) from parm) last_day_ /*PNV последний рабочий день месяца*/
               ,NVL((SELECT max(t_fixdays) FROM ddvnfi_dbt WHERE t_dealid = deal.t_id and t_rateid > 0), 0) t_fixday /*PNV*/
               ,case when t_dvkind = 4 and T_SWAPTYPE <> 3 then (SELECT MAX (t_begdate) FROM dv_dvnpmgr WHERE t_dealid = deal.t_id) else (select t_dt from parm) end t_begdate
               ,t_id
               ,count (1) over () t_cnt
         from ddvndeal_dbt deal
         inner join doproper_dbt oper on oper.t_dockind = deal.t_dockind and oper.t_documentid = lpad (deal.t_id, 34, '0')
         where deal.t_department = :2
         and t_client = -1  -- Не клиентская
         and exists (select 1 from ddvnfi_dbt where t_dealid = deal.t_id and exists (select 1 from dfininstr_dbt where t_fiid=ddvnfi_dbt.t_fiid and t_fi_kind in (1, 6, 3, 7))) --PNV 518394
         and deal.t_dvkind in (1/*форвард*/, 2/*опцион*/, 3/*валютный своп*/, 4/*процентный своп*/, 5/*покупка/продажа Т+3*/, 6/*СВОП*/)
         and t_date < (select t_dt from parm)
         and (oper.t_end_date = to_date ('01010001','ddmmyyyy') or oper.t_end_date >= (select t_dt from parm))
         and (t_sector = 'X' or exists (select 1 from doprstep_dbt where t_kind_action = 110 and t_id_operation = oper.t_id_operation and t_isexecute = 'X' and t_accountdate <= (select t_dt from parm)))/*PNV 514461*/
         and case when t_dvkind in (3,6) then (select greatest (t_execdate, t_supldate) from ddvnfi_dbt where t_dealid = deal.t_id and t_type = 2) WHEN t_dvkind IN (2) and (DEAL.T_CHANGEDATE > DEAL.T_begindate) then DEAL.T_CHANGEDATE else (select t_execdate from ddvnfi_dbt where t_dealid=deal.t_id and t_type=0 and t_opendate = chr (0)) end >= (select t_dt from parm)/*PNV i-support 503025*/
         --and deal.t_id = 380551
         order by deal.t_id) t];

    Var sqlDeal = execSqlSelect (StopCaptureOutput (), makeArray (sqlParam ("1", parm.("date")), sqlParam ("2", {OperDprt}))), i = 0, recCount1 = 0, recCount2 = 0;

    captureOutput ();
    [with parm as (select :1 t_dt from dual)
     select '' t_extcode
           ,'' t_contrname
           ,'' t_contrcountry
           ,'' t_sogl
           ,'' t_contrkind
           ,'' t_dealtype
           ,0 t_contractor
           ,'' t_finame
           ,'' t_dealkind1
           ,'' t_dealkind2
           ,'' t_napr
           ,null t_date
           ,null t_enddate
           ,'' t_acc1
           ,'' t_sum1
           ,'' t_sumnat1
           ,'' t_sum2
           ,'' t_sumnat2
           ,'' t_acc2
           ,'' t_sum3
           ,'' t_sumnat3
           ,'' t_sum4
           ,'' t_sumnat4
           ,'' t_acc3
           ,'' t_sum5
           ,'' t_sum6
           ,'' t_liqnetting
           ,'' t_netting
           ,'' t_fixdate
           ,'' t_bal
           ,0 t_id
           ,count (1) over () t_cnt
     from ddvfipos_dbt where 1=0]; // позиции пока не обрабатываем - их нет

    Var sqlPos = execSqlSelect (StopCaptureOutput (), makeArray (sqlParam ("1", parm.("date")), sqlParam ("2", {OperDprt})));

    captureOutput ();
    [with parm as (select :0 t_dt from dual)
     select t.*
            ,(select t_account from dmcaccdoc_dbt where (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) from dual) != 0 and t_catnum in (303, 1224, 1228, 1213) and t_docid = t.t_id
                                                       --and t_firole = case when t.t_type = 0 then case when t_napr = 'Покупка' then 30 else 5 end when t.t_type = 2 then case when t_napr = 'Покупка' then 5 else 30 end end) t_acc1
                                                         and t_firole = case when t_napr = 'Продажа' then 30 else 5 end) t_acc1
            ,(select t_account from dmcaccdoc_dbt where (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) from dual) != 0 and t_catnum in (304, 1225, 122, 1214) and t_docid = t.t_id
                                                       --and t_firole != case when t.t_type = 0 then case when t_napr = 'Покупка' then 31 else 150 end when t.t_type = 2 then case when t_napr = 'Покупка' then 150 else 31 end end) t_acc2
                                                       and t_firole != case when t_napr = 'Продажа' then 31 else 150 end) t_acc2
            ,-(select (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) from dual) from dmcaccdoc_dbt where (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) from dual) != 0 and t_catnum in (303, 1224, 1228, 1213) and t_docid = t.t_id
                                                       --and t_firole = case when t.t_type = 0 then case when t_napr = 'Покупка' then 30 else 5 end when t.t_type = 2 then case when t_napr = 'Покупка' then 5 else 30 end end) t_sum1
                                                       and t_firole = case when t_napr = 'Продажа' then 30 else 5 end) t_sum1
            ,-(select (select rsb_fiinstr.convsum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency), t_currency, 0, (select t_dt-1 from parm), 2) from dual) from dmcaccdoc_dbt where (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) from dual) != 0 and t_catnum in (303, 1224, 1228, 1213) and t_docid = t.t_id
                                                       and t_firole = case when t_napr = 'Продажа' then 30 else 5 end) t_sumnat1
            ,(select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) from dmcaccdoc_dbt where (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) from dual) != 0 and t_catnum in (304, 1225, 122, 1214) and t_docid = t.t_id
                                                       --and t_firole != case when t.t_type = 0 then case when t_napr = 'Покупка' then 31 else 150 end when t.t_type = 2 then case when t_napr = 'Покупка' then 150 else 31 end end) t_sum3
                                                       and t_firole != case when t_napr = 'Продажа' then 31 else 150 end) t_sum3
            ,(select rsb_fiinstr.convsum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency), t_currency, 0, (select t_dt-1 from parm), 2) from dmcaccdoc_dbt where (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) from dual) != 0 and t_catnum in (304, 1225, 122, 1214) and t_docid = t.t_id
                                                       --and t_firole != case when t.t_type = 0 then case when t_napr = 'Покупка' then 31 else 150 end when t.t_type = 2 then case when t_napr = 'Покупка' then 150 else 31 end end) t_sumnat3
                                                       and t_firole != case when t_napr = 'Продажа' then 31 else 150 end) t_sumnat3
     from (select :1 t_extcode
                 ,:2 t_contrname
                 ,:3 t_contrcountry
                 ,:4 t_sogl
                 ,:5 t_contrkind
                 ,:6 t_dealtype
                 ,:7 t_contractor
                 ,:8 t_finame
                 ,:9 t_BA
                 ,:10 t_dealkind1
                 ,:11 t_dealkind2
                 ,case when (select t_type from ddvndeal_dbt where t_id=d.t_dealid)=5 then decode (d.t_type, 2, 'Продажа', 'Покупка') else decode (d.t_type, 2, 'Покупка', 'Продажа') end t_napr
                 ,:12 t_date
                 ,t_paydate t_enddate
                 --,greatest (t_execdate, t_supldate) t_enddate
                 --,(select t_account from dmcaccdoc_dbt where (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) from dual) != 0 and t_catnum in (303, 1224, 1228, 1213) and t_docid = d.t_dealid and t_firole = decode (d.t_type, 0, 5, 2, 30)) t_acc1
                 --,-(select (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) from dual) from dmcaccdoc_dbt where (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) from dual) != 0 and t_catnum in (303, 1224, 1228, 1213) and t_docid = d.t_dealid and t_firole = decode (d.t_type, 0, 5, 2, 30)) t_sum1
                 --,-(select (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0) from dual) from dmcaccdoc_dbt where (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) from dual) != 0 and t_catnum in (303, 1224, 1228, 1213) and t_docid = d.t_dealid and t_firole = decode (d.t_type, 0, 5, 2, 30)) t_sumnat1
                 ,:13 t_sum2
                 ,:14 t_sumnat2
                 --,(select t_account from dmcaccdoc_dbt where (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) from dual) != 0 and t_catnum in (304, 1225, 122, 1214) and t_docid = d.t_dealid and t_firole != decode (d.t_type, 0, 150, 2, 31)) t_acc2
                 --,(select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) from dmcaccdoc_dbt where (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) from dual) != 0 and t_catnum in (304, 1225, 122, 1214) and t_docid = d.t_dealid and t_firole != decode (d.t_type, 0, 150, 2, 31)) t_sum3
                 --,(select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0) from dmcaccdoc_dbt where (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) from dual) != 0 and t_catnum in (304, 1225, 122, 1214) and t_docid = d.t_dealid and t_firole != decode (d.t_type, 0, 150, 2, 31)) t_sumnat3
                 ,:15 t_sum4
                 ,:16 t_sumnat4
                 ,decode (d.t_type, 2, :17, '') t_acc3
                 ,decode (d.t_type, 2, :18, '') t_sum5
                 ,decode (d.t_type, 2, :19, '') t_sum6
                 ,:20 t_liqnetting
                 ,:21 t_netting
                 ,:22 t_fixdate
                 ,:23 t_bal
                 ,d.t_dealid t_id
                 ,d.t_type
           from ddvnfi_dbt d where t_dealid = :24 and t_paydate >= (select t_dt from parm)) t
           order by t_type];
    Var querySVOP = StopCaptureOutput (), sqlSVOP;

    if ( sqlDeal.moveNext () )
         reccount1 = int (sqlDeal.value ("t_cnt"));
    end;
    if ( sqlPos.moveNext () )
        reccount2 = int (sqlPos.value ("t_cnt"));
    end;

    endAction ();
    testEvent (1);

    if ( reccount1 + reccount2 == 0 )
        xls.OpenTemplate ("userF155_noData.xlsx", true);
        xls.SheetChange (SHEET_NAME);
        xls.CopyAllSheetInTotalBook (null, false, "A1", 0, SHEET_NAME);
        xls.Close();
        return true;
    end;

    // Подготовлен шаблон userF155_foreignCurrency.xlsx
    /*
    xls.cells.font.size = 8;
    xls.Range ("A1:AU1").merge ();
    xls.Range("A2:A3").merge ();
    xls.Range("B2:B3").merge ();
    xls.Range("C2:C3").merge ();
    xls.Range("D2:D3").merge ();
    xls.Range("E2:E3").merge ();
    xls.Range("F2:F3").merge ();

    xls.Range("G2:G3").merge ();
    xls.Range("H2:H3").merge ();
    xls.Range("I2:I3").merge ();
    xls.Range("J2:J3").merge ();
    xls.Range("K2:K3").merge ();
    xls.Range("L2:L3").merge ();
    xls.Range("M2:M3").merge ();
    xls.Range("N2:N3").merge ();
    xls.Range("O2:O3").merge ();
    xls.Range("P2:P3").merge ();
    xls.Range("Q2:Q3").merge ();
    xls.Range("R2:R3").merge ();
    xls.Range("S2:S3").merge ();
    xls.Range("T2:T3").merge ();
    xls.Range("U2:U3").merge ();

    xls.Range("V2:V3").merge ();
    xls.Range("W2:W3").merge ();

    xls.Range("X2:X3").merge ();
    xls.Range("Y2:Y3").merge ();
    xls.Range("Z2:Z3").merge ();
    xls.Range("AA2:AA3").merge ();
    xls.Range("AB2:AC2").merge ();
    xls.Range("AD2:AD3").merge ();
    xls.Range("AE2:AE3").merge ();
    xls.Range("AF2:AF3").merge ();
    xls.Range("AG2:AG3").merge ();
    xls.Range("AH2:AH3").merge ();
    xls.Range("AI2:AI3").merge ();
    xls.Range("AJ2:AJ3").merge ();
    xls.Range("AK2:AK3").merge ();

    xls.Range("AL2:AL3").merge ();
    xls.Range("AM2:AM3").merge ();
    xls.Range("AN2:AN3").merge ();
    xls.Range("AO2:AO3").merge ();
    xls.Range("AP2:AP3").merge ();
    xls.Range("AQ2:AQ3").merge ();
    xls.Range("AR2:AR3").merge ();
    xls.Range("AS2:AS3").merge ();
    xls.Range("AT2:AT3").merge ();

    xls.Range("AU2:AU2").merge ();
    xls.Range("AV2:AV2").merge ();
    xls.Range("AW2:AX2").merge ();
    xls.Range("AY2:AY3").merge ();


    xls.cells (1, 1).HorizontalAlignment = -4108;
    xls.cells (1, 1).value = "Информация по сделкам ПФИ с базовым активом - иностар. валюта по состоянию на "+parm.("date");
    xls.cells (1, 1).font.size = 10;
    xls.cells (1, 1).font.bold = true;
    xls.Cells.HorizontalAlignment = -4108;
    xls.Cells.VerticalAlignment = -4160;
    xls.Cells.WrapText = true;
    xls.Range ("A2:AY4").Interior.Pattern = 1;
    xls.Range ("A2:AY4").Interior.PatternColorIndex = -4105;
    xls.Range ("A2:AY4").Interior.ThemeColor = 10;
    xls.Range ("A2:AY4").Interior.TintAndShade = 0.399975585192419;
    xls.columns (1).NumberFormat =
    xls.columns (33).NumberFormat =
    xls.columns (38).NumberFormat =
    xls.columns (43).NumberFormat = "@";
    xls.columns (34).NumberFormat =
    xls.columns (35).NumberFormat =
    xls.columns (36).NumberFormat =
    xls.columns (37).NumberFormat =
    xls.columns (39).NumberFormat =
    xls.columns (40).NumberFormat =
    xls.columns (41).NumberFormat =
    xls.columns (42).NumberFormat =
    xls.columns (44).NumberFormat =
    xls.columns (45).NumberFormat = "#"+thosep+"##0"+decsep+"00";
    xls.Range ("A2:BG4").NumberFormat = "Основной";
    xls.cells (2,  1).value = "Номер сделки";
    xls.cells (2,  2).value = "Контрагент";
    xls.cells (2,  3).value = "Соглашение на основании которого заключена сделка (RISDA/ISDA)";
    xls.cells (2,  4).value = "Вид контрагента (Банк/ЮЛ)";
    xls.cells (2,  5).value = "Тип сделки (ПФИ/Срочная)";
    xls.cells (2,  6).value = "Страна";

    xls.cells (2, 7).value = "Рейтинг контрагента (Standart&Poors) в национальной валюте";
    xls.cells (2, 8).value = "Рейтинг контрагента в соответствии с Указанием 3453-У (Standart&Poors) в национальной валюте";

    xls.cells (2, 9).value = "Рейтинг контрагента (Moodys) в национальной валюте";
    xls.cells (2, 10).value = "Рейтинг контрагента в соответствии с Указанием 3453-У (Moodys) в национальной валюте";

    xls.cells (2, 11).value = "Рейтинг контрагента (Fitch Ratings) в национальной валюте";
    xls.cells (2, 12).value = "Рейтинг контрагента в соответствии с Указанием 3453-У (Fitch Ratings) в национальной валюте";

    xls.cells (2, 13).value = "Рейтинг контрагента (Standart&Poors) в иностранной валюте";
    xls.cells (2, 14).value = "Рейтинг контрагента в соответствии с Указанием 3453-У (Standart&Poors) в иностранной валюте";

    xls.cells (2, 15).value = "Рейтинг контрагента (Moodys) в иностранной валюте";
    xls.cells (2, 16).value = "Рейтинг контрагента в соответствии с Указанием 3453-У (Moodys) в иностранной валюте";

    xls.cells (2, 17).value = "Рейтинг контрагента (Fitch Ratings) в иностранной валюте";
    xls.cells (2, 18).value = "Рейтинг контрагента в соответствии с Указанием 3453-У (Fitch Ratings) в иностранной валюте";

    xls.cells (2, 19).value = "Рейтинг контрагента (АКРА)";
    xls.cells (2, 20).value = "Рейтинг контрагента (Эксперт РА)";
    xls.cells (2, 21).value = "Рейтинг контрагента (НКР)";
    xls.cells (2, 22).value = "Рейтинг контрагента (НРА)";

    xls.cells (2, 23).value = "Рейтинг страны контрагента  (Standart&Poors) в национальной валюте";
    xls.cells (2, 24).value = "Рейтинг страны контрагента   (Moodys) в национальной валюте";
    xls.cells (2, 25).value = "Рейтинг страны контрагента  (Fitch Ratings) в национальной валюте";

    xls.cells (2, 26).value = "Наименование инструмента";
    xls.cells (2, 27).value = "Базовый актив";
    xls.cells (2, 28).value = "Вид сделки";
    xls.cells (3, 28).value = "поставочная/ беспоставочная";
    xls.cells (3, 29).value = "биржевая/ внебиржевая";

    xls.cells (2, 30).value = "Направление сделки (покупка/ продажа)";
    xls.cells (2, 31).value = "Дата заключения сделки";
    xls.cells (2, 32).value = "Дата окончания сделки";
    xls.cells (2, 33).value = "Лицевой счет требований (базового актива)";
    xls.cells (2, 34).value = "Сумма требований (в ин. валюте)";
    xls.cells (2, 35).value = "Сумма требований (в руб. экв-те)";
    xls.cells (2, 36).value = "Сумма требований по промежуточным платежам (в ин. валюте)";
    xls.cells (2, 37).value = "Сумма требований по промежуточным платежам (в руб. экв-те)";
    xls.cells (2, 38).value = "Лицевой счет обязательств";
    xls.cells (2, 39).value = "Сумма обязательств в ин. валюте";
    xls.cells (2, 40).value = "Сумма обязательств в руб. экв-те";
    xls.cells (2, 41).value = "Сумма обязательств по промежуточным платежам (в ин. валюте)";
    xls.cells (2, 42).value = "Сумма оюязательств по промежуточным платежам (в руб. экв-те)";
    xls.cells (2, 43).value = "Лицевой счет по учету справедливой стоимости ПФИ";
    xls.cells (2, 44).value = "Справедливая стоимость актива";
    xls.cells (2, 45).value = "Справедливая стоимость обязательств";
    xls.cells (2, 46).value = "Наличие в соглашении по сделке условия ликвидационного неттинга (Да/Нет)";
    xls.cells (2, 47).value = "Наличие в соглашении по сделке условия расчетного неттинга (Да/Нет)";
    xls.cells (2, 48).value = "Сделка зарегистрирована в репозитарии (Да/Нет";
    xls.cells (2, 49).value = "Процентные свопы";
    xls.cells (3, 49).value = "Ближайшая дата пересмотра процентной ставки";
    xls.cells (3, 50).value = "№ счета 2-го порядка позици с плавающей процентной ставкой";
    xls.cells (2, 51).value = "Рыночная стоимость (в руб. экв-те)";

    for (Var c, makeArray (10, 30, 30, 8, 8, 6, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 12, 15, 12, 10, 10, 8, 8, 20, 14, 14, 14, 14, 22, 14, 14, 14, 14, 22, 14, 14, 10, 10, 10, 10, 10, 14))
        xls.Columns (i = i+1).ColumnWidth = c;
        xls.cells (4, i).value = i;
    end;
    */

    xls.OpenTemplate ("userF155_foreignCurrency.xlsx", true);
    xls.SheetChange (SHEET_NAME);

    csvTable = xls.RegisterTable ("templateTable", "templateTableHeader", true);
    csvFile = C_CSVFile ();

    if (xls.UseBigReport ())
        csvFile.SetLimitRow (FLUSH_COUNT_XLSX);
    end;

    xls.SetValue_NameCell ("templateTitle", "Информация по сделкам ПФИ с базовым активом - иностр. валюта по состоянию на "+parm.("date"));

    xls.CopyAllSheetInTotalBook (null, false, "templateHeader", 0, SHEET_NAME);

    fName = csvFile.CreateFullFileName ("userF155_foreignCurrency_csv.txt");
    csvFile.FileOpen (fName, true);

    i = 0;
    initProgress (reccount1 + reccount2, "Esc отмена", "Обработка сделок с иностранной валютой");
    while ( reccount1 )
        if ( inList (sqlDeal.value ("t_dvkind"), 3, 6) ) // своп
            sqlSVOP = execSqlSelect (querySVOP, makeArray (sqlParam ("0", parm.("date")),
                                                           sqlParam ("1", sqlDeal.value ("t_extcode")),
                                                           sqlParam ("2", sqlDeal.value ("t_contrname")),
                                                           sqlParam ("3", sqlDeal.value ("t_contrcountry")),
                                                           sqlParam ("4", sqlDeal.value ("t_sogl")),
                                                           sqlParam ("5", sqlDeal.value ("t_contrkind")),
                                                           sqlParam ("6", sqlDeal.value ("t_dealtype")),
                                                           sqlParam ("7", sqlDeal.value ("t_contractor")),
                                                           sqlParam ("8", sqlDeal.value ("t_finame")),
                                                           sqlParam ("9", sqlDeal.value ("t_ba")),
                                                           sqlParam ("10", sqlDeal.value ("t_dealkind1")),
                                                           sqlParam ("11", sqlDeal.value ("t_dealkind2")),
                                                           sqlParam ("12", sqlDeal.value ("t_date")),
                                                           sqlParam ("13", sqlDeal.value ("t_sum2")),
                                                           sqlParam ("14", sqlDeal.value ("t_sumnat2")),
                                                           sqlParam ("15", sqlDeal.value ("t_sum4")),
                                                           sqlParam ("16", sqlDeal.value ("t_sumnat4")),
                                                           sqlParam ("17", sqlDeal.value ("t_acc3")),
                                                           sqlParam ("18", sqlDeal.value ("t_sum5")),
                                                           sqlParam ("19", sqlDeal.value ("t_sum6")),
                                                           sqlParam ("20", sqlDeal.value ("t_liqnetting")),
                                                           sqlParam ("21", sqlDeal.value ("t_netting")),
                                                           sqlParam ("22", sqlDeal.value ("t_fixdate")),
                                                           sqlParam ("23", sqlDeal.value ("t_bal")),
                                                           sqlParam ("25", sqlDeal.value ("t_id"))));
            Var t = 1;
            while ( sqlSVOP.moveNext () )
                fillReport1 (sqlSVOP, i, t);
                t = t + 1;
                i = i + 1;
            end;
            i = i - 1;
        else
            fillReport1 (sqlDeal, i, 1);
        end;

        useProgress (i = i+1);
        if ( not sqlDeal.moveNext () )
            break;
        end;
        if ( (testEvent (1) == kbESC) and getTrue (true, "Прекратить формирование отчета?") )
            remProgress ();
            return false;
        end;
    end;
    while ( reccount2 )
        fillReport1 (sqlPos, i, 1);
        useProgress (i = i+1);
        if ( not sqlPos.moveNext () )
            break;
        end;
        if ( (testEvent (1) == kbESC) and getTrue (true, "Прекратить формирование отчета?") )
            remProgress ();
            return false;
        end;
    end;

    // Подготовлен шаблон userF155_foreignCurrency.xlsx
    /*
    Var range = xls.range ("A2:AY"+(i+4));
    range.Borders (7).LineStyle = 1;
    range.Borders (8).LineStyle = 1;
    range.Borders (9).LineStyle = 1;
    range.Borders (10).LineStyle = 1;
    range.Borders (11).LineStyle = 1;
    range.Borders (12).LineStyle = 1;
    xls.cells (5, 2).select ();
    xls.activeWindow.freezePanes = true;
    xls.Range("A4:AY4").AutoFilter ();
    xls.cells (1, 1).select ();
    */

    csvFile.FileClose ();

    csvTable.FillTabelFromCSV (csvFile.GetlsFileName ());
    csvTable.EndTable ();

    xls.CopyAllSheetInTotalBook (null, false, csvTable.GetTableRange(), 0, SHEET_NAME);
    xls.Close ();

    isNeedAutoFilterForeignCur = true;

    remProgress ();
    return true
End;
//-----------------------------------------------------------------------------------------

Private macro makeReport2
    var SHEET_NAME = SHEET_NAME_SEC;
    begAction (100, "Отбор сделок", false);
    testEvent (1);

    captureOutput ();
    [with parm as (select :1 t_dt from dual)
     select deal.t_code t_dealcodets
           ,(select t_shortname from dparty_dbt where t_partyid = deal.t_contractor) t_contrname
           ,decode (deal.t_sector, 'X', '', (select trim ((select t_code from dllvalues_dbt where t_list = 4016 and t_element = t_authorform)||' Договор № '||t_code||' от '||to_char (t_date_genagr, 'd.mm.yyyy')) from ddl_genagr_dbt where t_genagrid =  deal.t_genagrid)) t_sogl
           ,nvl ((select 'Банк' from dpartyown_dbt where t_partykind = 2 and t_partyid = deal.t_contractor), (select decode (t_legalform, 1, 'ЮЛ', 'ФЛ') from dparty_dbt where t_partyid = deal.t_contractor)) t_contrkind
           ,decode (t_DVKind, 5, 'срочная', 'ПФИ') t_dealtype
           ,(select t_nrcountry from dparty_dbt where t_partyid = deal.t_contractor) t_contrcountry
           ,(select (select t_riskclass from dcountry_dbt where t_codelat3 = t_nrcountry) from dparty_dbt where t_partyid = deal.t_contractor) t_countryrisk
           ,deal.t_contractor t_partyid
           ,nvl((select t_issuer from dfininstr_dbt f where t_fiid = (select t_fiid from ddvnfi_dbt where t_dealid=deal.t_id and t_type=0)),-1) t_issuer
           ,decode (t_dvkind,
                    1, 'Форвард',
                    2, decode (deal.t_type, 1, 'Покупка', 2, 'Продажа')||' опциона на '||decode (deal.t_optiontype, 1/*Put*/, 'продажу ', 2/*Call*/, 'покупку ')||
                                                  case when exists (select 1 from ddvnfi_dbt where t_dealid = deal.t_id and exists (select 1 from dfininstr_dbt where t_fiid=ddvnfi_dbt.t_fiid and t_fi_kind=1)) then 'валюты'
                                                       when exists (select 1 from ddvnfi_dbt where t_dealid = deal.t_id and exists (select 1 from dfininstr_dbt where t_fiid=ddvnfi_dbt.t_fiid and t_fi_kind=6)) then 'драг. металлов' end,
                    5, decode (deal.t_type, 1, 'Покупка', 2, 'Продажа')||
                                                 case when exists (select 1 from ddvnfi_dbt where t_dealid = deal.t_id and exists (select 1 from dfininstr_dbt where t_fiid=ddvnfi_dbt.t_fiid and t_fi_kind=1)) then 'валюты'
                                                      when exists (select 1 from ddvnfi_dbt where t_dealid = deal.t_id and exists (select 1 from dfininstr_dbt where t_fiid=ddvnfi_dbt.t_fiid and t_fi_kind=6)) then 'драг. металлов' end
                   ) t_finame
           ,(select decode (t_fi_kind, 3, t_fi_code, 2, (select decode (nvl (t_isin, chr (1)), chr (1), t_lsin, t_isin) from davoiriss_dbt where t_fiid=f.t_fiid)) from dfininstr_dbt f where t_fiid = (select t_fiid from ddvnfi_dbt where t_dealid=deal.t_id and t_type=0)) t_BA
           ,case when exists (select 1 from ddvnfi_dbt where t_dealid = deal.t_id and t_exectype = 1) then 'Поставочная' else 'Беспоставочная' end t_dealkind1
           ,case when deal.t_sector = 'X' or exists (select 1 from dpartyown_dbt where t_partyid=deal.t_contractor and t_partykind=3) then 'биржевая' else 'внебиржевая' end t_dealkind2
           ,case when t_dvkind in (1, 5) then decode (deal.t_type, 1, 'Покупка', 2, 'Продажа')
                 when t_dvkind=2 then decode (deal.t_optiontype, 1/*Put*/, 'Продажа', 2/*Call*/, 'Покупка')
            end t_napr
           ,t_date
           ,(select t_execdate from ddvnfi_dbt where t_dealid=deal.t_id and t_type=0 and t_opendate = chr (0)) t_enddate
           ,(select listagg (t_account, ', ') within group (order by t_account) from dmcaccdoc_dbt where (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) from dual) != 0 and t_catnum in (1228, 1224, 1213, 303) and t_docid = deal.t_id) t_acc1
           ,(select listagg ((select t_ccy from dfininstr_dbt where t_fiid = t_currency), ', ') within group (order by t_currency) from dmcaccdoc_dbt where (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) from dual) != 0 and t_catnum in (1228, 1224, 1213, 303) and t_docid = deal.t_id) t_fiacc1
           ,(select -sum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency)) from dmcaccdoc_dbt where t_currency != 0 and t_catnum in (1228, 1224, 1213, 303) and t_docid = deal.t_id) t_sum1
           ,(select -sum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0)) from dmcaccdoc_dbt where t_catnum in (1228, 1224, 1213, 303) and t_docid = deal.t_id) t_sumnat1
           ,(select listagg (t_account, ', ') within group (order by t_account) from dmcaccdoc_dbt where (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) from dual) != 0 and t_catnum in (1229, 1225, 1214, 304) and t_docid = deal.t_id) t_acc2
           ,(select listagg ((select t_ccy from dfininstr_dbt where t_fiid = t_currency), ', ') within group (order by t_currency) from dmcaccdoc_dbt where (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) from dual) != 0 and t_catnum in (1229, 1225, 1214, 304) and t_docid = deal.t_id) t_fiacc2
           ,(select sum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency)) from dmcaccdoc_dbt where t_currency != 0 and t_catnum in (1229, 1225, 1214, 304) and t_docid = deal.t_id) t_sum2
           ,(select sum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0)) from dmcaccdoc_dbt where t_catnum in (1229, 1225, 1214, 304) and t_docid = deal.t_id) t_sumnat2
           ,(select listagg (t_account, ', ') within group (order by t_account) from dmcaccdoc_dbt where t_catnum in (1217, 1218) and rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) != 0 and t_docid = deal.t_id) t_acc3
           ,(select -sum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency)) from dmcaccdoc_dbt where t_catnum = 1217 and t_docid = deal.t_id) t_sum3
           ,(select sum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency)) from dmcaccdoc_dbt where t_catnum = 1218 and t_docid = deal.t_id) t_sum4
           ,nvl ((select 'ДА' from ddl_genagr_dbt where t_can_liquidnetting = 'X' and t_genagrid =  deal.t_genagrid), 'НЕТ') t_liqnetting
           ,decode (deal.t_netting, 'X', 'ДА', 'НЕТ') t_netting
           ,t_id
           ,count (1) over () t_cnt
     from ddvndeal_dbt deal
     inner join doproper_dbt oper on oper.t_dockind = deal.t_dockind and oper.t_documentid = lpad (deal.t_id, 34, '0')
     where deal.t_department = :2
     and t_client = -1  -- Не клиентская
     and exists (select 1 from ddvnfi_dbt where t_dealid = deal.t_id and exists (select 1 from dfininstr_dbt where t_fiid=ddvnfi_dbt.t_fiid and t_fi_kind in (2, 3)))
     and deal.t_dvkind in (1/*форвард*/, 2/*опцион*/, 5/*покупка/продажа Т+3*/)
     and t_date <= (select t_dt from parm)
     and (oper.t_end_date = to_date ('01010001','ddmmyyyy') or oper.t_end_date >= (select t_dt from parm))
     and (t_sector = 'X' or exists (select 1 from doprstep_dbt where t_kind_action = 110 and t_id_operation = oper.t_id_operation and t_isexecute = 'X' and t_fact_date <= (select t_dt from parm)))
     --and exists (select 1 from dacctrn_dbt where t_date_carry <= (select t_dt from parm) and t_chapter = 4 and t_acctrnid in (select t_acctrnid from doprdocs_dbt where t_dockind = 1 and t_id_operation = oper.t_id_operation))];
    Var sqlFISSIKO = execSqlSelect (StopCaptureOutput (), makeArray (sqlParam ("1", parm.("date")), sqlParam ("2", {operDprt}))), i = 0, recCount1 = 0, recCount2 = 0, recCount3 = 0;


    captureOutput ();
    [with parm as (select :1 t_dt from dual)
     select deal.t_dealcodets
           ,(select t_shortname from dparty_dbt where t_partyid = deal.t_partyid) t_contrname
           ,decode (deal.t_sector, 'X', '', (select trim ((select t_code from dllvalues_dbt where t_list = 4016 and t_element = t_authorform)||' Договор № '||t_code||' от '||to_char (t_date_genagr, 'd.mm.yyyy')) from ddl_genagr_dbt where t_genagrid =  deal.t_genagrid)) t_sogl
           ,nvl ((select 'Банк' from dpartyown_dbt where t_partykind = 2 and t_partyid = deal.t_partyid), (select decode (t_legalform, 1, 'ЮЛ', 'ФЛ') from dparty_dbt where t_partyid = deal.t_partyid)) t_contrkind
           ,'Срочная' t_dealtype
           ,(select t_nrcountry from dparty_dbt where t_partyid = deal.t_partyid) t_contrcountry
           ,(select (select t_riskclass from dcountry_dbt where t_codelat3 = t_nrcountry) from dparty_dbt where t_partyid = deal.t_partyid) t_countryrisk
           ,deal.t_partyid
           ,nvl((select t_issuer from dfininstr_dbt where t_fiid = deal.t_pfi),-1) t_issuer
           ,(select t_isin from davoiriss_dbt where t_fiid = deal.t_pfi) t_finame
           ,(select decode (t_fi_kind, 3, t_fi_code, 2, (select decode (nvl (t_isin, chr (1)), chr (1), t_lsin, t_isin) from davoiriss_dbt where t_fiid=deal.t_pfi)) from dfininstr_dbt where t_fiid = deal.t_pfi) t_BA
           ,'Поставочная' t_dealkind1
           ,case when t_dealtype in (12143, 12153) or (t_dealtype in (12183, 12193) and exists (select 1 from dpartyown_dbt where t_partykind=3 and t_partyid=deal.t_partyid)) or (t_dealtype in (2162, 2172) and deal.t_marketid > 0) then 'Биржевая' else 'Внебиржевая' end t_dealkind2
           ,case when t_dealtype in (12143, 12183, 2162) then 'Покупка' else 'Продажа' end t_napr
           ,t_dealdate t_date
           ,(select greatest (max (t_maturity), max (t_expiry)) from ddl_leg_dbt where t_dealid = deal.t_dealid) t_enddate
           ,(select listagg (t_account, ', ') within group (order by t_account) from dmcaccdoc_dbt where (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) from dual) != 0 and t_catnum in (303, 318) and t_docid = deal.t_dealid) t_acc1
           ,(select listagg ((select t_ccy from dfininstr_dbt where t_fiid = t_currency), ', ') within group (order by t_currency) from dmcaccdoc_dbt where (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) from dual) != 0 and t_catnum in (303, 318) and t_docid = deal.t_dealid) t_fiacc1
           ,(select -sum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency)) from dmcaccdoc_dbt where t_currency != 0 and t_catnum in (303, 318) and t_docid = deal.t_dealid) t_sum1
           ,(select -sum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0)) from dmcaccdoc_dbt where t_catnum in (303, 318) and t_docid = deal.t_dealid) t_sumnat1
           ,(select listagg (t_account, ', ') within group (order by t_account) from dmcaccdoc_dbt where (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) from dual) != 0 and t_catnum in (304, 317) and t_docid = deal.t_dealid) t_acc2
           ,(select listagg ((select t_ccy from dfininstr_dbt where t_fiid = t_currency), ', ') within group (order by t_currency) from dmcaccdoc_dbt where (select rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) from dual) != 0 and t_catnum in (304, 317) and t_docid = deal.t_dealid) t_fiacc2
           ,(select sum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency)) from dmcaccdoc_dbt where t_currency != 0 and t_catnum in (304, 317) and t_docid = deal.t_dealid) t_sum2
           ,(select sum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), 0)) from dmcaccdoc_dbt where t_catnum in (304, 317) and t_docid = deal.t_dealid) t_sumnat2
           ,(select listagg (t_account, ', ') within group (order by t_account) from dmcaccdoc_dbt where t_catnum in (1217, 1218) and rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency) != 0 and t_docid = deal.t_dealid) t_acc3
           ,(select -sum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency)) from dmcaccdoc_dbt where t_catnum = 1217 and t_docid = deal.t_dealid) t_sum3
           ,(select sum (rsb_account.restall (t_account, t_chapter, t_currency, (select t_dt-1 from parm), t_currency)) from dmcaccdoc_dbt where t_catnum = 1218 and t_docid = deal.t_dealid) t_sum4
           ,nvl ((select 'ДА' from ddl_genagr_dbt where t_can_liquidnetting = 'X' and t_genagrid =  deal.t_genagrid), 'НЕТ') t_liqnetting
           ,decode (deal.t_netting, 'X', 'ДА', 'НЕТ') t_netting
           ,t_dealid t_id
           ,count (1) over () t_cnt
     from ddl_tick_dbt deal
     inner join doproper_dbt oper on oper.t_dockind = 101 and oper.t_documentid = lpad (deal.t_dealid, 34, '0')
     where deal.t_department = :2
     and t_dealtype in (12143/*Покупка ц/б биржевая*/, 12183/*Покупка ц/б внебиржевая*/, 2162/*Покупка ц/б через брокера*/, 12153/*Продажа ц/б биржевая*/, 12193/*Продажа ц/б внебиржевая*/, 2172/*Продажа ц/б через брокера*/)
     and t_dealdate <= (select t_dt from parm)
     and deal.t_clientid = -1
     and (oper.t_end_date = to_date ('01010001','ddmmyyyy') or oper.t_end_date > (select t_dt from parm))
     and (select min (t_maturity) from ddl_leg_dbt where t_dealid=deal.t_dealid)-t_dealdate > 3 -- срочная
     and exists (select 1 from ddlgracc_dbt f where t_state = 2 and t_factdate = (select max (t_factdate) from ddlgracc_dbt where t_grdealid=f.t_grdealid and t_factdate <= (select t_dt from parm)) and
           t_grdealid = (select t_id from ddlgrdeal_dbt where t_templnum = 3 and t_dockind = 101 and t_docid = deal.t_dealid)) -- постановка на внебаланс == Ф
     and not exists (select 1 from ddlgracc_dbt f where t_state = 2 and t_factdate = (select max (t_factdate) from ddlgracc_dbt where t_grdealid=f.t_grdealid and t_factdate <= (select t_dt from parm)) and
            t_grdealid = (select t_id from ddlgrdeal_dbt where t_templnum = 8 and t_dockind = 101 and t_docid = deal.t_dealid)) -- постановка на баланс != Ф];

    Var sqlBOCB = execSqlSelect (StopCaptureOutput (), makeArray (sqlParam ("1", parm.("date")), sqlParam ("2", {operDprt})));

    captureOutput ();
    [with parm as (select :1 t_dt from dual)
     select '' t_dealcodets
           ,'' t_contrname
           ,'' t_sogl
           ,'' t_contrkind
           ,'' t_dealtype
           ,'' t_contrcountry
           ,'' t_countryrisk
           ,0
           ,'' t_finame
           ,'' t_BA
           ,'' t_dealkind1
           ,'' t_dealkind2
           ,'' t_napr
           ,'' t_date
           ,'' t_enddate
           ,'' t_acc1
           ,'' t_fiacc1
           ,'' t_sum1
           ,'' t_sumnat1
           ,'' t_acc2
           ,'' t_fiacc2
           ,'' t_sum2
           ,'' t_sumnat2
           ,'' t_acc3
           ,'' t_sum3
           ,'' t_sum4
           ,'' t_liqnetting
           ,'' t_netting
           ,0 t_id
           ,count (1) over () t_cnt
     from ddvfipos_dbt where 1=0]; // позиции пока не обрабатываем - их нет

    Var sqlPos = execSqlSelect (StopCaptureOutput (), makeArray (sqlParam ("1", parm.("date"))));

    if ( sqlFISSIKO.moveNext () )
        reccount1 = int (sqlFISSIKO.value ("t_cnt"));
    end;
    if ( sqlBOCB.moveNext () )
        reccount2 = int (sqlBOCB.value ("t_cnt"));
    end;
    if ( sqlPos.moveNext () )
        reccount3 = int (sqlPos.value ("t_cnt"));
    end;

    endAction ();
    testEvent (1);

    if ( reccount1 + reccount2 + reccount3 == 0 )
        xls.OpenTemplate ("userF155_noData.xlsx", true);
        xls.SheetChange (SHEET_NAME);
        xls.CopyAllSheetInTotalBook (null, false, "A1", 0, SHEET_NAME);
        xls.Close();
        return true;
    end;

    // Подготовлен шаблон userF155_securities.xlsx
    /*
    xls.cells.font.size = 8;
    xls.Range ("A1:AI1").merge ();
    xls.Range("A2:A3").merge ();
    xls.Range("B2:B3").merge ();
    xls.Range("C2:C3").merge ();
    xls.Range("D2:D3").merge ();
    xls.Range("E2:E3").merge ();
    xls.Range("F2:F3").merge ();
    xls.Range("G2:G3").merge ();
    xls.Range("H2:H3").merge ();
    xls.Range("I2:I3").merge ();
    xls.Range("J2:J3").merge ();
    xls.Range("K2:K3").merge ();
    xls.Range("L2:L3").merge ();
    xls.Range("M2:M3").merge ();
    xls.Range("N2:N3").merge ();
    xls.Range("O2:P2").merge ();
    xls.Range("Q2:Q3").merge ();
    xls.Range("R2:R3").merge ();
    xls.Range("S2:S3").merge ();
    xls.Range("T2:T3").merge ();
    xls.Range("U2:U3").merge ();
    xls.Range("V2:V3").merge ();
    xls.Range("W2:W3").merge ();
    xls.Range("X2:X3").merge ();
    xls.Range("Y2:Y3").merge ();
    xls.Range("Z2:Z3").merge ();
    xls.Range("AA2:AA3").merge ();
    xls.Range("AB2:AB3").merge ();
    xls.Range("AC2:AC3").merge ();
    xls.Range("AD2:AD3").merge ();
    xls.Range("AE2:AE3").merge ();
    xls.Range("AF2:AF3").merge ();
    xls.Range("AG2:AG3").merge ();
    xls.Range("AH2:AI2").merge ();

    xls.cells (1, 1).HorizontalAlignment = -4108;
    xls.cells (1, 1).value = "Информация о срочных сделках с ПФИ по состоянию на "+parm.("date");
    xls.cells (1, 1).font.size = 10;
    xls.cells (1, 1).font.bold = true;
    xls.Cells.HorizontalAlignment = -4108;
    xls.Cells.VerticalAlignment = -4160;
    xls.Cells.WrapText = true;

    xls.Range ("A2:AI4").Interior.Pattern = 1;
    xls.Range ("A2:AI4").Interior.PatternColorIndex = -4105;
    xls.Range ("A2:AI4").Interior.ThemeColor = 10;
    xls.Range ("A2:AI4").Interior.TintAndShade = 0.399975585192419;
    xls.columns (2).NumberFormat =
    xls.columns (20).NumberFormat =
    xls.columns (24).NumberFormat =
    xls.columns (28).NumberFormat = "@";
    xls.columns (21).NumberFormat =
    xls.columns (22).NumberFormat =
    xls.columns (23).NumberFormat =
    xls.columns (26).NumberFormat =
    xls.columns (27).NumberFormat =
    xls.columns (29).NumberFormat =
    xls.columns (30).NumberFormat = "#"+thosep+"##0"+decsep+"00";
    xls.Range ("A2:BG4").NumberFormat = "Основной";
    xls.cells (2,  1).value = "№ п/п";
    xls.cells (2,  2).value = "Номер сделки";
    xls.cells (2,  3).value = "Контрагент";
    xls.cells (2,  4).value = "Соглашение на основании которого заключена слеока (RISDA/ISDA)";
    xls.cells (2,  5).value = "Вид контрагента (КО/ЮЛ)";
    xls.cells (2,  6).value = "Тип сделки (ПФИ/срочная)";
    xls.cells (2,  7).value = "Страна";
    xls.cells (2,  8).value = "Страновая оценка";
    xls.cells (2,  9).value = "Рейтинг контрагента на отчетную дату";
    xls.cells (2, 10).value = "Рейтинг контрагента в соответствии с Указанием 3453-У";
    xls.cells (2, 11).value = "Национальный рейтинг Эмитента контрагента на отчетную дату AKPA";
    xls.cells (2, 12).value = "Национальный рейтинг Эмитента контрагента на отчетныю дату Эксперт РА";
    xls.cells (2, 13).value = "Наименование инструмента";
    xls.cells (2, 14).value = "Базовый актив";
    xls.cells (2, 15).value = "Вид сделки";
    xls.cells (3, 15).value = "поставочная/ беспоставочная";
    xls.cells (3, 16).value = "биржевая/ внебиржевая";
    xls.cells (2, 17).value = "Направление сделки (покупка/продажа)";
    xls.cells (2, 18).value = "Дата заключения сделки";
    xls.cells (2, 19).value = "Дата окончания сделки";
    xls.cells (2, 20).value = "Лицевой счет требований";
    xls.cells (2, 21).value = "Валюта счета требований";
    xls.cells (2, 22).value = "Сумма требований (в ин. валюте)";
    xls.cells (2, 23).value = "Сумма требований (в руб. экв-те)";
    xls.cells (2, 24).value = "Лицевой счет обязательств";
    xls.cells (2, 25).value = "Валюта счета обязательств";
    xls.cells (2, 26).value = "Сумма обязательств в ин. валюте";
    xls.cells (2, 27).value = "Сумма обязательств в руб. экв-те";
    xls.cells (2, 28).value = "Лицевой счет по учету справедливой стоимости ПФИ";
    xls.cells (2, 29).value = "Справедливая стоимость актива";
    xls.cells (2, 30).value = "Справедливая стоимость обязательств";
    xls.cells (2, 31).value = "Наличие в соглашении по сделке условия ликвидационного неттинга";
    xls.cells (2, 32).value = "Наличие в соглашении по сделке условия расчетного неттинга";
    xls.cells (2, 33).value = "Сделка зарегистрирована в репозитарии";
    xls.cells (2, 34).value = "Процентные свопы";
    xls.cells (3, 34).value = "Ближайшая дата пересмотра процентной ставки";
    xls.cells (3, 35).value = "№ счета 2-го порядка позици с плавающей процентной ставкой";

    for (Var c, makeArray (8, 10, 30, 30, 8, 8, 6, 10, 10, 10, 10, 10, 15, 12, 10, 10, 8, 8, 8, 22, 10, 14, 14, 22, 10, 14, 14, 22, 14, 14, 10, 10, 10, 10, 10))
        xls.Columns (i = i+1).ColumnWidth = c;
        xls.cells (4, i).value = i;
    end;
    */

    xls.OpenTemplate ("userF155_securities.xlsx", true);
    xls.SheetChange (SHEET_NAME);

    csvTable = xls.RegisterTable ("templateTable", "TemplateTableHeader", true);
    csvFile = C_CSVFile ();

    if (xls.UseBigReport ())
        csvFile.SetLimitRow (FLUSH_COUNT_XLSX);
    end;

    xls.SetValue_NameCell ("templateTitle", "Информация о срочных сделках с ПФИ по состоянию на "+parm.("date"));

    xls.CopyAllSheetInTotalBook (null, false, "TemplateHeader", 0, SHEET_NAME);

    fName = csvFile.CreateFullFileName ("userF155_securities_csv.txt");
    csvFile.FileOpen (fName, true);

    i = 0;
    initProgress (reccount1 + reccount2 + reccount3, "Esc отмена", "Обработка сделок с ценными бумагами");
    while ( reccount1 )
        fillReport2 (sqlFISSIKO, i);
        useProgress (i = i+1);
        if ( not sqlFISSIKO.moveNext () )
            break;
        end;
        if ( (testEvent (1) == kbESC) and getTrue (true, "Прекратить формирование отчета?") )
            remProgress ();
            return false;
        end;
    end;
    while ( reccount2 )
        fillReport2 (sqlBOCB, i, true);
        useProgress (i = i+1);
        if ( not sqlBOCB.moveNext () )
            break;
        end;
        if ( (testEvent (1) == kbESC) and getTrue (true, "Прекратить формирование отчета?") )
            remProgress ();
            return false;
        end;
    end;
    while ( reccount3 )
        fillReport2 (sqlPos, i);
        useProgress (i = i+1);
        if ( not sqlPos.moveNext () )
            break;
        end;
        if ( (testEvent (1) == kbESC) and getTrue (true, "Прекратить формирование отчета?") )
            remProgress ();
            return false;
        end;
    end;

    // Подготовлен шаблон userF155_securities.xlsx
    /*
    Var range = xls.range ("A2:AI"+(i+4));
    range.Borders (7).LineStyle = 1;
    range.Borders (8).LineStyle = 1;
    range.Borders (9).LineStyle = 1;
    range.Borders (10).LineStyle = 1;
    range.Borders (11).LineStyle = 1;
    range.Borders (12).LineStyle = 1;
    xls.rows (4).select ();
    xls.activeWindow.freezePanes = true;
    xls.Range("A4:AI4").AutoFilter ();
    xls.cells (1, 1).select ();
    */

    csvFile.FileClose ();
    csvTable.FillTabelFromCSV (csvFile.GetlsFileName ());
    csvTable.EndTable ();

    
    xls.CopyAllSheetInTotalBook (null, false, csvTable.GetTableRange(), 0, SHEET_NAME);
    xls.Close ();

    isNeedAutoFilterSecurities = true;

    remProgress ();

    return true;
End;
//-----------------------------------------------------------------------------------------

Private class CBookmark ( bm )
    Var bookmark = bm;
End;
//-----------------------------------------------------------------------------------------


Private class (ToolsDataAdapter) CDataSet ( p_fields, data )
    Var list = data,
        curRec = TRecHandler ("rec", p_fields),
        fields = p_fields,
        navigator = -1;

    initToolsDataAdapter ();
    setCurrentRecord (curRec);

    Macro initRec ( rec )
        copy (curRec, rec);
    End;

    Macro recCount
        return list.size;
    End;

    Macro value ( fld )
        return curRec.(fld);
    End;

    Macro moveFirst
        if ( list.size )
            initRec (list [navigator = 0]);
            return true;
        end;
        return false;
    End;

    Macro moveLast
        if ( list.size )
            initRec (list [navigator = list.size-1]);
            return true;
        end;
        return false;
    End;

    Macro moveNext
        if ( navigator < list.size-1 )
            initRec (list [navigator = navigator + 1]);
            return true;
        end;
        return false;
    End;

    Macro movePrev
        if ( navigator > 0 )
            initRec (list [navigator = navigator - 1]);
            return true;
        end;
        return false;
    End;

    Macro getBookmark
        if ( navigator >= 0 )
            return CBookmark (list [navigator].("id"));
        end;
        return false;
    End;

    Macro moveToBookmark ( bm )
        Var x = 0;
        while ( x < list.size )
            if ( list [x].("id") == bm.bookmark )
                initRec (list [navigator=x]);
                return true;
            end;
            x = x + 1;
        end;
        return false;
    End;

    Macro recordUpdate
        if ( navigator >= 0 )
            copy (list [navigator], curRec);
        end;
        return true;
    End;

    Macro recordDelete
        if ( navigator >= 0 )
            Var t = navigator;
            while ( t < list.size-2 )
                list [t] = list [t+1];
                t = t + 1;
            end;
            list.size = list.size - 1;
            if ( navigator > list.size-1 )
                navigator = list.size-1;
                initRec (list [navigator]);
            end;
        end;
        return true;
    End;

    Macro recordInsert
        Var t = list.size;
        while ( t > navigator + 1 )
            list [t] = list [t-1];
            t = t - 1;
        end;
        curRec.("id") = list.size+1;
        Var rec = TRecHandler (rec, fields);
        copy (rec, curRec);
        list [navigator=navigator+1] = rec;
        updateScroll (this, 4);
        return true;
    End;
End;
//-----------------------------------------------------------------------------------------

Private class CTarnsport ( forEdit )
    Var done = false, folder, fName, fNameIt, records = TArray (), dateFirst, dateLast, dprt;
    Var fields = makeArray ("id", V_INTEGER, 4, 0, 0,
                            "sym1", V_STRING, 41, 40, 0,
                            "sym2", V_INTEGER, 2, 0, 0,
                            "sym3", V_STRING, 31, 30, 0,
                            "sym4", V_STRING, 21, 20, 0,
                            "val1", V_MONEY, 20, 2, 0,
                            "val2", V_MONEY, 20, 2, 0,
                            "val3", V_MONEY, 20, 2, 0,
                            "val4", V_MONEY, 20, 2, 0,
                            "val5", V_MONEY, 20, 2, 0,
                            "val6", V_MONEY, 20, 2, 0,
                            "val7", V_MONEY, 20, 2, 0,
                            "val8", V_MONEY, 20, 2, 0,
                            "val9", V_MONEY, 20, 2, 0,
                            "val10", V_MONEY, 20, 2, 0,
                            "val11", V_MONEY, 20, 2, 0,
                            "val12", V_MONEY, 20, 2, 0,
                            "txt", V_STRING, 801, 800, 0);

    if ( forEdit )
    else
        this.init ();
    end;

    Macro getAccName ( acc )
        Var sql = ExecSqlSelect ("select t_nameaccount from daccount_dbt where t_chapter=1 and t_account=:1", makeArray (sqlParam ("1", acc)));
        if ( sql.moveNext () ) return sql.value (0); end;
        return "";
    End;

    Macro addRow ( code, inst, napr, ba, acc, rest, treb, obaz, ssa, ssp, transh, f13 )
        Var rec = tRecHandler ("rec", fields);
        rec.("sym1") = "f155_2_";

        if ( f13 )
            rec.("sym1") = rec.("sym1") + "1_3";
            rec.("txt") = "ценные бумаги";
        elif ( (inst == "Форвард") and (ba == "Валюта") )
            rec.("sym1") = rec.("sym1") + "1_1";
            rec.("txt") = "иностранная валюта";
        elif ( (inst == "Форвард") and (ba == "Драг. металл") )
            rec.("sym1") = rec.("sym1") + "1_2";
            rec.("txt") = "драгоценные металы";
        elif ( (inst == "Форвард") and (ba == "цб") )
            rec.("sym1") = rec.("sym1") + "1_3";
            rec.("txt") = "ценные бумаги";
        elif ( (index (inst, "опцион")) and (ba == "Валюта") )
            rec.("sym1") = rec.("sym1") + "2_1";
            rec.("txt") = "иностранная валюта";
        elif ( (index (inst, "опцион")) and (ba == "Драг. металл") )
            rec.("sym1") = rec.("sym1") + "2_2";
            rec.("txt") = "драгоценные металлы";
        elif ( (index (inst, "опцион")) and (ba == "цб") )
            rec.("sym1") = rec.("sym1") + "2_3";
            rec.("txt") = "ценные бумаги";
        elif ( (inst == "СВОП") and (ba == "Валюта") )
            rec.("sym1") = rec.("sym1") + "4_1";
            rec.("txt") = "иностранная валюта";
        elif ( (inst == "СВОП") and (ba == "Драг. металл") )
            rec.("sym1") = rec.("sym1") + "4_2";
            rec.("txt") = "драгоценные бумаги";
        elif ( inst == "Процентный СВОП" )
            rec.("sym1") = rec.("sym1") + "4_3";
            rec.("txt") = "процентная ставка";
        elif ( inst == "Валютно-процентный СВОП" )
            rec.("sym1") = rec.("sym1") + "4_4";
            rec.("txt") = "иностранная валюта и процентная ставка";
        else
            return;
        end;

        rec.("sym1") = rec.("sym1") + ";";

        if ( ba == "Валюта" )
            rec.("sym1") = rec.("sym1") + "вал";
        elif ( ba == "Драг. металл" )
            rec.("sym1") = rec.("sym1") + "драг";
        elif ( ba == "цб" )
            rec.("sym1") = rec.("sym1") + "ЦБ";
        else
            rec.("sym1") = rec.("sym1") + "ПФИЦБ";
        end;
        rec.("sym1") = rec.("sym1") + ","+code + " " + transh;
        rec.("sym2") = 1;
        rec.("sym3") = string (substr (acc, 1, 20), ",", records.size+1);
        rec.("val1") = ifThenElse (valType (rest) == 26, $0, rest);
        rec.("val5") = ifThenElse (valType (treb) == 26, $0, treb);
        rec.("val6") = ifThenElse (valType (obaz) == 26, $0, obaz);
        rec.("val11") = ifThenElse (valType (ssa) == 26, $0, ssa);
        rec.("val12") = ifThenElse (valType (ssp) == 26, $0, ssp);

        rec.("txt") = rec.("txt") + "~" + "0" + "~" + "" + "~" + "" + "~" + "" + "~" + substr (acc, 1, 5) + "~" +
                      getAccName (acc) + "~" + "" + "~" + "" + "~";
        if ( napr == "Покупка" )
            rec.("txt") = rec.("txt") + "Buy";
        elif ( napr == "Продажа" )
            rec.("txt") = rec.("txt") + "Sell";
        elif ( napr == "Покупка/продажа" )
            rec.("txt") = rec.("txt") + "Buy/Sell";
        end;
        rec.("txt") = rec.("txt") + "~" + split (rec.("sym1"), ";") [1];

        records [records.size] = rec;
    End;

    Macro formatDate ( dt )
        Var d, m, y;
        dateSplit (dt, d, m, y);
        return string (d:2:o, "/", m:2:o, "/", y);
    End;

    Macro format ( val )
        if ( valType (val) == V_MONEY )
            if ( round (val, 0) == val )
                return string (val:0:0);
            else
                return string (val:0:2);
            end;
        elif ( valType (val) == V_DATE )
            return "\""+formatDate (val)+"\"";
        else
            return "\""+strsubst (val, "\"", "\"\"")+"\"";
        end;
    End;

    Macro makeString ( rec )
        return string (format (rec.("sym1")), " ",
                       format (rec.("sym2")), " ",
                       format (rec.("sym3")), " ",
                       format (rec.("sym4")), " ",
                       format (rec.("val1")), " ",
                       format (rec.("val2")), " ",
                       format (rec.("val3")), " ",
                       format (rec.("val4")), " ",
                       format (rec.("val5")), " ",
                       format (rec.("val6")), " ",
                       format (rec.("val7")), " ",
                       format (rec.("val8")), " ",
                       format (rec.("val9")), " ",
                       format (rec.("val10")), " ",
                       format (rec.("val11")), " ",
                       format (rec.("val12")), " ",
                       format (rec.("txt"))
                      );
    End;

    Macro makeHeader ( it )
        return string (format ("OLAPDataBlock"), " ",
                       format ("4.1D153"), " ",
                       format ("f155"+it+"_2_3"), " ",
                       format (getDprtCode ({operDprt})), " ",
                       format (dateFirst), " ",
                       format (dateLast), " ",
                       ifThenElse (parm.("final"), "yes", "no"));
    End;

    Macro extractFormula ( str )
        Var i = index (str, "~");
        if ( i )
            return substr (str, 1, i-1);
        end;
        return "";
    End;

    Macro makeTotal
        Var fields = MakeArray ("sum1", V_MONEY, 12, 2, 0,
                                "sum2", V_MONEY, 12, 2, 0,
                                "sum3", V_MONEY, 12, 2, 0,
                                "sum4", V_MONEY, 12, 2, 0,
                                "sum5", V_MONEY, 12, 2, 0,
                                "sum6", V_MONEY, 12, 2, 0,
                                "sum7", V_MONEY, 12, 2, 0,
                                "txt",  V_STRING, 100, 100, 0),
            total = Tarray (), rec;
        for (Var x, records)
            if ( substr (x.("sym1"), 1, 7) == "f155_2_" )
                if ( total [int (substr (x.("sym1"), 8, 1))*100+int (substr (x.("sym1"), 10, 1))] == NULL )
                    rec = total [int (substr (x.("sym1"), 8, 1))*100+int (substr (x.("sym1"), 10, 1))] = TRecHandler ("total", fields);
                    rec.("txt") = extractFormula (x.("txt"));
                else
                    rec = total [int (substr (x.("sym1"), 8, 1))*100+int (substr (x.("sym1"), 10, 1))];
                end;
                if ( index (x.("txt"), "~Buy~") )
                    rec.("sum1") = rec.("sum1") + x.("val5");
                elif ( index (x.("txt"), "~Shell~") )
                    rec.("sum2") = rec.("sum2") + x.("val6");
                end;
                rec.("sum3") = rec.("sum3") + x.("val9");
                rec.("sum4") = rec.("sum4") + x.("val10");
                rec.("sum5") = rec.("sum5") + x.("val8");
                rec.("sum6") = rec.("sum6") + x.("val11");
                rec.("sum7") = rec.("sum7") + x.("val12");
            end;
        end;

        file f () txt write;
        if ( not open (f, getTxtFileName ("tmp155it")) )
            msgbox ("Ошибка создания файла итогов");
            return;
        end;
        insert (f, makeHeader ());
        for (x, 0, total.size-1, 1)
            if ( total [x] )
                insert (f, string (format (string ("f155_2_", int (x/100), "_", x-int (x/100)*100)), " ",
                                   format (""), " ",
                                   format (""), " ",
                                   format (""), " ",
                                   format (total [x].("sum1")), " ",
                                   format (total [x].("sum2")), " ",
                                   format (round (total [x].("sum3")/1000.0, 0)), " ",
                                   format (round (total [x].("sum4")/1000.0, 0)), " ",
                                   format (round (total [x].("sum5")/1000.0, 0)), " ",
                                   format (total [x].("sum6")), " ",
                                   format (total [x].("sum7")), " ",
                                   format (total [x].("txt"))));
            end;
        end;
        insert (f, ".");
        close (f);
        if ( fNameIt == NULL )
            fNameIt = mergeFile (splitFile (fName), "f155it_2_3", dprt);
        end;
        if ( not copyFile (getTxtFileName ("tmp155it"), "$"+fNameIt) )
            msgbox ("Ошибка передачи файла итогов на терминал");
        end;
    End;

    Macro save
        file f () txt write;
        if ( not open (f, getTxtFileName ("tmp155")) )
            msgbox ("Ошибка!|Не удалось создать файл ", getTxtFileName ("tmp155"));
            return;
        end;
        insert (f, makeHeader ("it"));
        for (Var l, records)
            insert (f, makeString (l));
        end;
        insert (f, ".");
        close (f);

        if ( not copyFile (getTxtFileName ("tmp155"), "$"+fName) )
            msgbox ("Ошибка! Не удалось сохранить файл ", fName);
            return;
        end;
        makeTotal ();
    End;

    Macro init
        done = false;
        if ( not SelectFolder (folder, "", "Укажите путь для сохранения классов", true) )
            done = true;
        elif ( tdirList (folder, "D").count == 0 )
            msgBox ("Указанный путь не существует");
            done = true;
        else
            fName = mergeFile (folder, "f155_2_3", getDprtCode ({operDprt}));
            fNameIt = mergeFile (folder, "f155it_2_3", getDprtCode ({operDprt}));
            if ( ((TDirList (fName, "F").count) or (TDirList (fNameIt, "F").count)) and (not getTrue (true, "Файлы классов в указанном каталоге уже существуют. Заменить?")) )
                done = true;
            end;
        end;

        Var mon, year;
        dateSplit (dateShift (parm.("date"), 0, -1, 0), null, mon, year);
        dateFirst = date (1, mon, year);
        dateSplit (parm.("date"), null, mon, year);
        dateLast = date (1, mon, year)-1;
    End;

    Macro splitString ( val )
        Var res = Tarray (), x = 1, q  = false, s = 0, c;
        setParm (2, res);

        while ( x <= strlen (val) )
            c = substr (val, x, 1);
            if ( (c == "\"") and (not q) )
                q = true;
                s = x + 1;
            elif ( (c == "\"") and q and ((substr (val, x+1, 1) == " ") or (x == strlen (val))) )
                res [res.size] = substr (val, s, x-s);
                s = 0;
                q = false;
            elif ( (c == " ") and (s == 0) and (not q) )
                s = x + 1;
            elif ( (c == " ") and (s > 0) and (not q) )
                res [res.size] = substr (val, s, x-s);
                s = x + 1;
            end;
            x = x + 1;
        end;
        if ( s )
            res [res.size] = substr (val, s);
        end;
    End;

    Macro Handler ( rs, cmd, id, key )
        if ( (cmd == DLG_KEY) and (key == kbF2) and getTrue (true, "Сохранить данные в файл "+fName) )
            this.save ();
        elif ( (cmd == DLG_KEY) and (key == kbESC) and (not getTrue (true, "Вы действительно хотите выйти?")) )
            return CM_IGNORE;
        end;

    End;

    Macro runEdit
        file f () txt;
        var str, rec;
        if ( not selectFile (fName, "f155_2_3*."+getDprtCode ({operDprt}), null, null, true) )
            return;
        end;
        if ( not copyFile ("$"+fName, gettxtFileName ("tmp155")) )
            msgbox ("Ошибка копирования файла "+fName+" на сервер");
            return;
        elif ( not open (f, getTxtFIleName ("tmp155")) )
            msgbox ("Ошибка открытия файла");
            return;
        end;
        if ( not next (f) )
            msgbox ("Нарушена структура файла");
            return;
        end;
        splitString (f.str, str);
        if ( str.size < 7 )
            msgbox ("Нарушена структура файла");
            return;
        end;

        dprt = str [3];
        dateFirst = date (strSubst (str [4], "/", "."));
        dateLast = date (strSubst (str [5], "/", "."));

        initProgress (-1, NULL, "Загрузка файла");
        while ( next (f) )
            if ( substr (f.str, 1, 1) == "." )
                break;
            end;
            str = NULL;
            splitString (f.str, str);
            if ( str.size < 17 )
                msgbox ("Нарушена структура файла");
                remProgress ();
                return;
            end;
            rec = tRecHandler ("rec", fields);
            rec.("sym1") = str [0];
            rec.("sym2") = str [1];
            rec.("sym3") = str [2];
            rec.("sym4") = str [3];
            rec.("val1") = money (str [4]);
            rec.("val2") = money (str [5]);
            rec.("val3") = money (str [6]);
            rec.("val4") = money (str [7]);
            rec.("val5") = money (str [8]);
            rec.("val6") = money (str [9]);
            rec.("val7") = money (str [10]);
            rec.("val8") = money (str [11]);
            rec.("val9") = money (str [12]);
            rec.("val10") = money (str [13]);
            rec.("val11") = money (str [14]);
            rec.("val12") = money (str [15]);
            rec.("txt") = str [16];
            rec.("id") = records.size+1;
            records [records.size] = rec;
            useProgress (records.size);
        end;
        remProgress ();

        Var rs = CDataSet (fields, records);
        runScroll (rs, 17, makeArray ("sym1", "sym1", 30, 0, 30, 0,
                                      "sym2", "sym2", 3, 0, 0, 0,
                                      "sym3", "sym3", 20, 0, 21, 0,
                                      "sym4", "sym4", 12, 0, 10, 0,
                                      "val1", "val1", 12, 0, 2, 0,
                                      "val2", "val2", 12, 0, 2, 0,
                                      "val3", "val3", 12, 0, 2, 0,
                                      "val4", "val4", 12, 0, 2, 0,
                                      "val5", "val5", 12, 0, 2, 0,
                                      "val6", "val6", 12, 0, 2, 0,
                                      "val7", "val7", 12, 0, 2, 0,
                                      "val8", "val8", 12, 0, 2, 0,
                                      "val9", "val9", 12, 0, 2, 0,
                                      "val10", "val10", 12, 0, 2, 0,
                                      "val11", "val11", 12, 0, 2, 0,
                                      "val12", "val12", 12, 0, 2, 0,
                                      "txt", "txt", 50, 0, 50, 0),
                   "f155classedit", r2m (this, "handler"), "Расшифровка формы 155 по подразделению "+dprt+" за период с "+dateFirst+" по "+dateLast,
                   "Esc Выход  F2 Созранить  F8 Удалить  F9 Добавить", false, 0, 0);
    End;
End;
//-----------------------------------------------------------------------------------------

Private class (TRecHandler) CParam
    initTRecHandler ("f155", "f155_detail.lbr", TRUE);
    Macro handler ( dlg, cmd, id, key )

        if ( (cmd == DLG_KEY) and (key == kbF3) and (id == fldIndex ("date")) )
            dlg.(id) = getDateByCalendar (dlg.(id));
        elif ( (cmd == DLG_KEY) and (key == kbSpace) and inList (id, fldIndex ("rep1"), fldIndex ("rep2"), fldIndex ("rep3"), fldIndex ("class"), fldIndex ("final")) )
            dlg.(id) = ifThenElse (dlg.(id), "", "X");
        elif ( (cmd == DLG_KEY) and (key == kbF9) )
            return CM_IGNORE;
        elif ( (cmd == DLG_KEY) and (key == kbF5) )
            CTarnsport (true).runEdit ();
        elif ( (cmd == DLG_KEY) and (key == kbF2) )
            if ( dlg.("rep1") + dlg.("rep2") + dlg.("rep3") == "" )
                msgBox ("Необходимо указать вид сделок");
            else
                return CM_SAVE;
            end;
        end;
    End;

    Macro Run
        return runDialog (this, R2M (this, "Handler"));
    End;
End;
//-----------------------------------------------------------------------------------------
