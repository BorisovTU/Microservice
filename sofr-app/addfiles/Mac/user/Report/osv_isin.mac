/*
$Name:        osv_isin.mac
$Module:      
$Description: ОСВ по счетам вложений ЦБ
$Programmer:  Котов C.
*/
import osv_isin_panel, ReportUser;
import captureoutput;


PRIVATE CLASS (TX_ReportUser) osv_isin_Report
  private var m_BeginDate, m_DateEnd, m_Null;

  /*Создание отчета*/
  PRIVATE MACRO Create()

    /*Счет по маске*/
    macro AccountMask(acc)
      if(strlen(acc) <= 1)
        return "-";
      elif(strlen(acc) != 20)
        return acc;
      else
        return substr(acc,1,5) + "-" + substr(acc,6,3) + "-" + substr(acc,9,1) + "-" + substr(acc,10,4) + "-" + substr(acc,14);
      end;
    end;

    /*Балансовый счет*/
    macro AccountBal(acc)
      if(strlen(acc) < 5)
        return "-";
      else
        return substr(acc,1,5);
      end;
    end;

    /*Валюта счета*/
    macro AccountCur(acc)
      if(strlen(acc) < 8)
        return "-";
      else
        return substr(acc,6,3);
      end;
    end;

/*Точка входа*/
    var cnt=1;
    var m_cmd;

    /*Отключаем все индикаторы*/
    if(m_UseTemplate)
      m_ObjTemplateXLS.SetFlagShowIndicator(false);
    else
      __BUG_Global_m_ObjTemplateXLS.SetFlagShowIndicator(false);
    end;
    m_ProgressIndicator = CreateProgressIndicator(true);

    /*Даты отчета*/
    m_BeginDate = m_Form.GetFieldValue(PNFLD_BEGINDATE);
    m_DateEnd = m_Form.GetFieldValue(PNFLD_ENDDATE);
    m_Null = m_Form.GetFieldValue(PNFLD_NULL);


    SetActiveSheet("ОСВ по счетам вложений ЦБ");
    InitProgress(int(1), "Ждите...", "Выборка данных для таблицы \"ОСВ по счетам вложений ЦБ\"");

    StartCaptureOutput();
    [  
              select count(*) cnt 
                from daccount_dbt acc
               where substr(acc.t_account,1,1) = '5'
                 and acc.t_open_date <= ?
                 and (acc.t_close_date = to_date('01010001','DDMMYYYY') or acc.t_close_date >= ?)
    ];
    m_cmd = RsdCommand(EndCaptureOutput());
    m_cmd.AddParam("", RSDBP_IN, m_DateEnd);
    m_cmd.AddParam("", RSDBP_IN, m_BeginDate);
    m_cmd.Execute();
    m_RS = TRsbDataSet(m_cmd);
    if(m_RS.movenext)
      cnt = m_RS.value("cnt");
    end;

    PrintFormatString("", "reportname", "ОСВ по счетам вложений ЦБ. Период отчета " + string(date(m_BeginDate):f) + " - " + string(date(m_DateEnd):f) + """");

    RegisterTable( "rep_str", "",
                   "account",
                   "nameaccount",
                   "in_a",
                   "in_p",
                   "dbt",
                   "crd",
                   "out_a",
                   "out_p",
                   "isin",
                   "ground");

    if(cnt > 0)
      RemProgress();
      InitProgress(int(cnt), "Ждите...", "Формирование таблицы \"ОСВ по счетам вложений ЦБ\"");

      StartCaptureOutput();
      [  
              select t_account,
                     t_nameaccount,
                     case t_kind_account when 'А' then -t_in else 0 end t_in_a,
                     case t_kind_account when 'П' then  t_in else 0 end t_in_p,
                     t_dbt,
                     t_crd,
                     case t_kind_account when 'А' then -t_out else 0 end t_out_a,
                     case t_kind_account when 'П' then  t_out else 0 end t_out_p,
                     t_isin,
                     (select case 
                               when (mcaccdoc.t_catnum = 235) and (mctempl.t_value4 = 2) then 'Дисконт'
                               when ((mcaccdoc.t_catnum = 235) and (mctempl.t_value4 = 1)) or (t_account in ('50505810000000050037',
                                                                                                             '50218810099008001001',
                                                                                                             '50218810399008001002',
                                                                                                             '50218810699008001003',
                                                                                                             '50218810999008001004')) then 'НКД'
                               when (mcaccdoc.t_catnum in (1207, 1208, 1238)) then 'УНКД'
                               when (mcaccdoc.t_catnum = 236) then 'Премия'
                               when (mcaccdoc.t_catnum = 1492) and (mcaccdoc.t_firole = 5) then 'Счет вложений'
                               when (mcaccdoc.t_catnum = 1492) and (mcaccdoc.t_firole = 42) then 'Процентный доход'
                               when (mcaccdoc.t_catnum = 464) and (mcaccdoc.t_firole = 43) then 'Дисконт'
                               when (mcaccdoc.t_catnum = 464) and (mcaccdoc.t_firole = 42) then 'Процентный доход'
                               when (mcaccdoc.t_catnum in (231, 1253, 233, 1237, 1298, 1299 )) then 'Счет вложений'
                               when (substr(t_account,1,5) in ('50264','50265','50428','50429' )) then 'Корректировка стоимости'
                               when (mcaccdoc.t_catnum in (152,162,1001,1002,1247,1248,1249,1250,1428,1429,1463,1464,1465,1466,1467,1468,1477,1478,1479,1480 )) then 'Переоценка'
                               else ''
                             end
                        from dmcaccdoc_dbt mcaccdoc, dmctempl_dbt mctempl
                       where mcaccdoc.t_catid = mctempl.t_catid
                         and mcaccdoc.t_templnum = mctempl.t_number
                         and mcaccdoc.t_account = tmp.t_account
                         and rownum = 1) t_ground                     
               from(select  t_account,
                            t_nameaccount,
                            acc.t_kind_account,
                            rsb_account.restac(t_account,t_code_currency,?-1,acc.t_chapter,0,0) t_in,
                            rsb_account.debetac(t_account,acc.t_chapter,t_code_currency,?,?,0)  t_dbt,
                            rsb_account.kreditac(t_account,acc.t_chapter,t_code_currency,?,?,0)  t_crd,
                            rsb_account.restac(t_account,t_code_currency,?,acc.t_chapter,0,0) t_out,
                            (select nvl(av.t_isin,chr(1)) from dmcaccdoc_dbt mcacc, davoiriss_dbt av where mcacc.t_account = acc.t_account and av.t_fiid=mcacc.t_fiid and rownum=1) as t_isin,
                            unkd_with_coupon, coupon_amount, discount_amount, premium_amount, balance_price, overvalue
                      from daccount_dbt acc,
                           (select account_number_2, unkd_with_coupon, coupon_amount, discount_amount, premium_amount, balance_price, overvalue from tRSHB_Portfolio_PKL_2CHD where report_dt = ? and rownum = 1) t,
                           dbalance_dbt b
                     where (substr(acc.t_account,1,1) = '5' or substr(acc.t_account,1,3) = '106') and acc.t_chapter = 1
                       and acc.t_open_date <= ?
                       and (acc.t_close_date = to_date('01010001','DDMMYYYY') or acc.t_close_date >= ?)
                       and t.account_number_2(+) = acc.t_account
                       and b.t_balance = acc.t_balance
                       and b.t_inumplan = 0
                       and b.t_chapter = 1) tmp
      ];//                 where t_in!=0 or t_dbt!=0 or t_crd!=0 or t_out!=0
      m_cmd = RsdCommand(EndCaptureOutput());
      m_cmd.AddParam("", RSDBP_IN, m_BeginDate);

      m_cmd.AddParam("", RSDBP_IN, m_BeginDate);
      m_cmd.AddParam("", RSDBP_IN, m_DateEnd);

      m_cmd.AddParam("", RSDBP_IN, m_BeginDate);
      m_cmd.AddParam("", RSDBP_IN, m_DateEnd);

      m_cmd.AddParam("", RSDBP_IN, m_DateEnd);

      m_cmd.AddParam("", RSDBP_IN, m_DateEnd);

      m_cmd.AddParam("", RSDBP_IN, m_DateEnd);
      m_cmd.AddParam("", RSDBP_IN, m_BeginDate);

      m_cmd.Execute();
      m_RS = TRsbDataSet(m_cmd);
      cnt = 0;

      while(m_RS.movenext)
        if((m_Null=="X")or
           (m_RS.value("t_in_a")!=0)or
           (m_RS.value("t_in_p")!=0)or
           (m_RS.value("t_dbt")!=0)or
           (m_RS.value("t_crd")!=0)or
           (m_RS.value("t_out_a")!=0)or
           (m_RS.value("t_out_p")!=0))
          /*Выводим строку отчета*/
          PrintTableLine("account",       AccountMask(m_RS.value("t_account")), null,
                         "nameaccount",   m_RS.value("t_nameaccount"),          null,
                         "in_a",          m_RS.value("t_in_a"),                 null,
                         "in_p",          m_RS.value("t_in_p"),                 null,
                         "dbt",           m_RS.value("t_dbt"),                  null,
                         "crd",           m_RS.value("t_crd"),                  null,
                         "out_a",         m_RS.value("t_out_a"),                null,
                         "out_p",         m_RS.value("t_out_p"),                null,
                         "isin",          m_RS.value("t_isin"),                 null,
                         "ground",        m_RS.value("t_ground"),               null);
        end;
        cnt = cnt + 1;
        UseProgress(cnt);
      end;
    end;

    RemProgress();
    InitProgress(int(1), "Ждите...", "Отображение таблицы \"ОСВ по счетам вложений ЦБ\"");
    EndTable();
    RemProgress();

  END;
 
  initTX_RegistrReport(osv_isin_Panel(), "osv_isin.xlsx");

END;

/*Точка входа*/
var r = osv_isin_Report();
r.InitReport("ОСВ", null);
r.Run();

exit(1);
