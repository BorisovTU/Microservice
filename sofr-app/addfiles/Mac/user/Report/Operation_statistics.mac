/*
$Name:        Operation_statistics.mac
$Module:      Ядро Securities
$Description: Статистика операций за период
*/

import oralib, likepy, or_rep_h, globals, RsbFormsInter, Календарь, "dl_calendcore.mac";

private const kbESC = 27, kbF2 = 316, kbF3 = 317, kbF9 = 323, kbEnter = 13;
private const FT_STRING  = 7;
private var sqlString:string;

//Получить идентификатор биржи ММВБ
private macro GetMMVB_ID()
  var stat = 0;
  var MMVB_Code = "", _MMVB_ID = -1;

  GetRegistryValue("SECUR\\MICEX_CODE", V_STRING, MMVB_Code, stat);
  if(stat != 0)
     msgbox("Ошибка при получении значения настройки SECUR\\MICEX_CODE");
  elif(MMVB_Code == "")
     msgbox("Не задано значение настройки SECUR\\MICEX_CODE");
  else
     _MMVB_ID = GetCodeParty(MMVB_Code, PTCK_CONTR);
  end;

  return _MMVB_ID;
end; 

//-----------------------------------------------------------------------------------------
private macro collectOutProc ( str )
    sqlString = sqlString + "\n" + trim (str);
End;

private macro CaptureOutput
   sqlString = "";
   SetOutHandler (@collectOutProc);
End;
                     
private macro StopCaptureOutput
    SetOutHandler ();
    return sqlString;
End;
//-----------------------------------------------------------------------------------------

// Панель задания периода
private class (TRsbPanel) CValueDatePanel
        var m_LabelValueDate:TRsbLabel;
        var m_StartDate:TRsbEditField   = TRsbEditField(V_DATE);
        var m_EndDate:TRsbEditField     = TRsbEditField(V_DATE); 

  macro onKeyPressed(RsbEvent:Object)
      
    if(RsbEvent.keyCode == kbESC)   
       RsbEvent.keyCode = kbF9;
       this.close(27);
    end;   

    if( (RsbEvent.keyCode == kbF2) or (RsbEvent.keyCode == kbEnter) )
        this.close(0);
    end;

    if (RsbEvent.keyCode == kbF3)
      if (StrUpr(RsbEvent.source.name) == "START_DATE")
        m_StartDate.Value = GetDateByCalendar(m_StartDate.Value);
      elif (StrUpr(RsbEvent.source.name) == "END_DATE")
        m_EndDate.Value = GetDateByCalendar(m_EndDate.Value);
      end;
    end;
  end;

  initTRsbPanel();
  setSize(30,5);
  setPosition(40,5);
  setCaption("Введите период отчета");
  setStatus("F2 Выполнить  ESC Отмена");

  // дата начала
  m_LabelValueDate = TRsbLabel(2,2,"дата начала");
  addLabel(m_LabelValueDate);

  m_StartDate.setPosition(15,2);
  m_StartDate.setSize(8,1);
  m_StartDate.name = "START_DATE";
  m_StartDate.Value = {curdate};
  //m_StartDate.onKeyPressed( R2M(this, "onKeyPressed") );
  addControl(m_StartDate);

  // дата окончания
  m_LabelValueDate = TRsbLabel(2,3,"дата окончания");
  addLabel(m_LabelValueDate);

  m_EndDate.setPosition(15,3);
  m_EndDate.setSize(8,1);
  m_EndDate.Value = {curdate};
  m_EndDate.name = "END_DATE";
  addControl(m_EndDate);
  
  addEventHandler(RSB_EV_KEY_PRESSED,R2M(this,"onKeyPressed"));

END;

macro Rep_OperationStatistics ()
  var Rep, sql, BeginPeriod, EndPeriod;
  var rn:integer = 0, sheet:integer = 1;
  var panel = CValueDatePanel();
  var format_name = "l:ex_B()";
  var format_count = "c:ex_B():ex_FS()";
  var format_head2 = "c:ex_B():ex_FS(b)";
  var filename = "";
  var dvCalendarId:integer = 0;
  var dvEndPeriod:date = date(0,0,0);

  if (panel.run())
    return;
  end;

  WriteFiscLog( OLstrproc, "Выпуск отчета Статистика операций в СОФР");

  BeginPeriod = panel.m_StartDate.value;
  EndPeriod = panel.m_EndDate.value;

  if (BeginPeriod == EndPeriod) 
    filename = "Статистика операций_" + BeginPeriod;
  else
    filename = "Статистика операций_" + BeginPeriod + "-" + EndPeriod;
  end;

  var ObjPrint:CTemplateXLS = CTemplateXLS(NULL, NULL, NULL, NULL, NULL, NULL, true); // основной объект отчёта
  ObjPrint.CreateTotalBook();
  var stat =  ObjPrint.OpenTemplate("OperationStatistics.xls");


/*
  Rep = CMakeReport(NULL, NULL, NULL, NULL, TRUE );

  Rep.SetDefaultFontName("Times New Roman");
  Rep.SetDefaultFontSize(11);
  Rep.SetFlagShowGrid(true);

  //Rep.SetExecute("iBook.Sheets("+sheet+").Columns(2).NumberFormat = \"# ##0"+GetLocaleInfo (0, LOCALE_SDECIMAL, IsStandAlone ())+"00\";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(2).NumberFormat = \"# ##0\";");
*/
  BegAction(0, "Ждите, формируется список ...", false);

  //ZMV DEF-47710 Сначала получим календарь для срочки, найдем ближайшую к дате отчета рабочую дату (если она приходится на выходной день) и используем ее при отборе данных по открытым контрактам 
  dvCalendarId = DL_GetCalendByDynParam(158,
                                        makeArray(
                                           DL_KeyPair("ObjectType", DL_CALLNK_MARKET),
                                           DL_KeyPair("DayType", DL_CALLNK_MRKTDAY_SETTL),         
                                           DL_KeyPair("Market", GetMMVB_ID()),
                                           DL_KeyPair("MarketPlace", DL_CALLNK_MARKETPLACE_DV)
                                        )
                                       );
  if(IsWorkDay(EndPeriod, dvCalendarId))
    dvEndPeriod = EndPeriod;
  else
    dvEndPeriod = GetDateAfterWorkDays(EndPeriod, -1, dvCalendarId);
  end;

  CaptureOutput();
  [with parm as (select :1 t_begindate, :2 t_enddate from dual) ,
      ddvndeal as (select 
                      sum(case when t_client=-1 and t_dvkind<>8 and t_sector = chr(88) then 1 else 0 end ) fissiko_all_ex ,
                      sum(case when t_client=-1 and t_dvkind<>8 and t_sector = chr(0) then 1 else 0 end ) fissiko_all_nonex,
                      sum(case when t_dvkind = 8 then 1 else 0 end ) banknote_deals,
                      sum(case when t_dvkind in(3, 4, 6) and t_client=-1 and t_sector = chr(88) then 1 else 0 end )  swap_ex,
                      sum(case when t_dvkind in(3, 4, 6) and t_client=-1 and t_sector = chr(0) then 1 else 0 end )  swap_nonex,
                      sum(case when t_dvkind in (1,5,7,9) and t_client=-1 and not exists (select 1 from dpartyown_dbt where t_partykind=2 and t_partyid=d.t_contractor)  then 1 else 0 end )  fissiko_505,
                      sum(case when t_ispfi = chr(88)  and not exists (select 1 from dpartyown_dbt where t_partykind=2 and t_partyid = d.t_contractor)  then 1 else 0 end )  fissiko_bd_sd,
                      sum(case when t_client > 0 then 1 else 0 end )  d_brok_nonexchange
                   from ddvndeal_dbt d where t_date between (select t_begindate from parm) and (select t_enddate from parm)  ),
      acctrn as (select /*+ materialize */ * from dacctrn_dbt t where t_date_carry between (select t_begindate from parm) and (select t_enddate from parm) and not t_chapter in (21, 22) ),
      fiid_cnt as (select /*+ materialize leading(max_instance) use_nl(v) index(v.vbcex.BC DPMWRTBC_DBT_IDX1) */ t_fiid, t_state 
               from (select /*+ leading(max_date) use_nl(max_instance) index(max_instance.vbcex.BC RSHB_DPMWRTBC_DBT_IDX0) */ 
                           MAX (max_instance.t_instance) t_instance ,max_date.t_sumid, max_date.t_changedate 
                     from (SELECT t_sumid , MAX (t.t_changedate) t_changedate 
                           FROM v_scwrthistex t WHERE t_party=-1 and t_contract = 0 and t.t_changedate <= (select t_enddate from parm) group by t_sumid) max_date 
                      join  v_scwrthistex max_instance on  max_date.t_sumid = max_instance.t_sumid AND max_date.t_changedate = max_instance.t_changedate
                      group by max_date.t_sumid, max_date.t_changedate ) max_instance
                    join v_scwrthistex v  on max_instance.t_instance = v.t_instance and max_instance.t_sumid = v.t_sumid and max_instance.t_changedate = v.t_changedate
           where  t_amount > 0 group by t_fiid,t_state )
  select /*ФИССиКО собственные сделки*/
         --(select count(1) from ddvndeal_dbt where t_date between (select t_begindate from parm) and (select t_enddate from parm) and t_client=-1 and t_dvkind<>8 and t_sector = chr(88)) fissiko_all_ex, --все сделки фиссико, кроме банкнот. Биржа
         (select fissiko_all_ex from ddvndeal) fissiko_all_ex, --все сделки фиссико, кроме банкнот. Биржа
        -- (select count(1) from ddvndeal_dbt where t_date between (select t_begindate from parm) and (select t_enddate from parm) and t_client=-1 and t_dvkind<>8 and t_sector = chr(0)) fissiko_all_nonex, --все сделки фиссико, кроме банкнот. Внебиржа
         (select fissiko_all_nonex from ddvndeal) fissiko_all_nonex, ---все сделки фиссико, кроме банкнот. Внебиржа
        -- (select count(1) from ddvndeal_dbt where t_dvkind = 8 and t_date between (select t_begindate from parm) and (select t_enddate from parm)) banknote_deals, --банкноты
         (select banknote_deals from ddvndeal) banknote_deals, --банкноты
         --(select count(1) from ddvndeal_dbt where t_dvkind in(3, 4, 6) and t_date between (select t_begindate from parm) and (select t_enddate from parm) and t_client=-1 and t_sector = chr(88)) swap_ex, --своп. Биржа
         (select swap_ex from ddvndeal) swap_ex, --своп. Биржа
         --(select count(1) from ddvndeal_dbt where t_dvkind in(3, 4, 6) and t_date between (select t_begindate from parm) and (select t_enddate from parm) and t_client=-1 and t_sector = chr(0)) swap_nonex, --своп. Внебиржа
         (select swap_nonex from ddvndeal) swap_nonex, --своп. Внебиржа
         (SELECT count(1) FROM ddl_nett_dbt nett WHERE t_kind_operation = 11080 AND t_signingdate BETWEEN (select t_begindate from parm) AND (select t_enddate from parm) AND t_clientid <= 0 AND EXISTS
              (SELECT 1 FROM ddvndeal_dbt dvndeal WHERE EXISTS (SELECT 1 FROM dpmpaym_dbt WHERE TO_NUMBER (t_documentid) = dvndeal.t_id AND t_dockind = dvndeal.t_dockind
                                 AND t_paymentid IN (SELECT DISTINCT t_InitialPayment FROM dpmlink_dbt pmlink WHERE pmlink.t_DocKind = nett.t_dockind AND pmlink.t_DocumentID = nett.t_nettingid AND pmlink.t_LinkKind=1)) and t_sector = chr(88))) netting_ex, --неттинг. Биржа
         (SELECT count(1) FROM ddl_nett_dbt nett WHERE t_kind_operation = 11080 AND t_signingdate BETWEEN (select t_begindate from parm) AND (select t_enddate from parm) AND t_clientid <= 0 AND EXISTS
              (SELECT 1 FROM ddvndeal_dbt dvndeal WHERE EXISTS (SELECT 1 FROM dpmpaym_dbt WHERE TO_NUMBER (t_documentid) = dvndeal.t_id AND t_dockind = dvndeal.t_dockind
                                 AND t_paymentid IN (SELECT DISTINCT t_InitialPayment FROM dpmlink_dbt pmlink WHERE pmlink.t_DocKind = nett.t_dockind AND pmlink.t_DocumentID = nett.t_nettingid AND pmlink.t_LinkKind=1)) and t_sector = chr(0))) netting_nonex, --неттинг. Внеиржа
         (select count(1) from ddvcsa_dbt where t_begdate < (select t_begindate from parm) and (t_enddate > (select t_enddate from parm) or t_enddate=to_date('01.01.0001', 'dd.mm.yyyy'))) csa, --CSA
         (select count(1) from ddvcsapm_dbt where t_date between (select t_begindate from parm) and (select t_enddate from parm)) csa_pm, --платежи CSA
        -- (select count(1) from ddvndeal_dbt d where t_dvkind in (1,5,7,9) and t_date between (select t_begindate from parm) and (select t_enddate from parm) and t_client=-1 and not exists (select 1 from dpartyown_dbt where t_partykind=2 and t_partyid=d.t_contractor)) fissiko_505, --конверсионные сделки с контрагентами - не кредитными организациями
         (select fissiko_505 from ddvndeal) fissiko_505, --конверсионные сделки с контрагентами - не кредитными организациями
        -- (select count(1) from ddvndeal_dbt d where t_ispfi = chr(88) and t_date between (select t_begindate from parm) and (select t_enddate from parm) and not exists (select 1 from dpartyown_dbt where t_partykind=2 and t_partyid=d.t_contractor)) fissiko_bd_sd, --бивалютные и структурные депозиты, т.е. сделки ПФИ с некредитными организациями
         (select fissiko_bd_sd from ddvndeal) fissiko_bd_sd, --бивалютные и структурные депозиты, т.е. сделки ПФИ с некредитными организациями
         (select count(1) from acctrn t -- dacctrn_dbt t where t_date_carry between (select t_begindate from parm) and (select t_enddate from parm) and not t_chapter in (21, 22) 
            where exists (select 1 /*+leading(docs) index(docs DOPRDOCS_DBT_IDX6) use_nl(oper) index(oper DOPROPER_DBT_IDX0 ) */ from doproper_dbt oper, doprdocs_dbt docs where docs.t_acctrnid = t.t_acctrnid and docs.t_dockind=1 and docs.t_id_operation=oper.t_id_operation
                 and ( exists (select 1 from ddvndeal_dbt where t_client=-1 and t_dockind =oper.t_dockind and t_kind=oper.t_kind_operation and t_id = to_number(oper.t_documentid) )
                    or exists (select 1 from ddl_nett_dbt where t_clientid<=0 and t_kind_operation=11080 and t_dockind =oper.t_dockind and t_kind_operation = oper.t_kind_operation and t_nettingid =to_number(oper.t_documentid) )
                    or exists (select 1 from ddvoper_dbt where t_operkind=12602 and t_dockind = oper.t_dockind and t_operkind =oper.t_kind_operation and t_id =to_number(oper.t_documentid) )
                    or exists (select 1 from  ddvcsa_dbt  where  4626 =oper.t_dockind and 2795 =oper.t_kind_operation and t_csaid =to_number(oper.t_documentid)))))
          +(select count(1) from acctrn trn -- dacctrn_dbt trn where t_date_carry between (select t_begindate from parm) and (select t_enddate from parm) and not t_chapter in (21, 22) 
               where t_number_pack in (30, 35, 70, 80)
               and not exists (select 1 from doprdocs_dbt where t_dockind=1 and t_acctrnid=trn.t_acctrnid)) fissiko_acctrn, --проводки фиссико
         /*МБК*/
         (select count(1) from ddl_tick_dbt where t_bofficekind = 102 and t_dealdate between (select t_begindate from parm) and (select t_enddate from parm)) mbk_deals, --кол-во операций МБК за период
         (select count(1) from ddl_tick_dbt where t_bofficekind = 102 and t_dealdate < (select t_enddate from parm) and (t_closedate = to_date('01.01.0001', 'dd.mm.yyyy') or t_closedate > (select t_enddate from parm))) mbk_opendeals, --кол-во открытых сделок на отчетную дату
         (select count(1) from acctrn acct -- dacctrn_dbt where t_date_carry between (select t_begindate from parm) and (select t_enddate from parm) and not t_chapter in (21, 22) 
           where  exists  --t_acctrnid in
             -- (select docs.t_acctrnid from doproper_dbt oper, doprdocs_dbt docs, ddl_tick_dbt tick where tick.t_bofficekind=102 and tick.t_bofficekind=oper.t_dockind and tick.t_dealtype=oper.t_kind_operation and tick.t_dealid=to_number(oper.t_documentid) and docs.t_dockind=1 and docs.t_id_operation=oper.t_id_operation )) mbk_acctrn, --проводки мбк
              (select /*+ leading(docs) index(docs DOPRDOCS_DBT_IDX6) use_nl(oper) */ 1 from doproper_dbt oper, doprdocs_dbt docs, ddl_tick_dbt tick where acct.t_acctrnid = docs.t_acctrnid and tick.t_bofficekind=102 and tick.t_bofficekind=oper.t_dockind and tick.t_dealtype=oper.t_kind_operation and tick.t_dealid=to_number(oper.t_documentid) and docs.t_dockind=1 and docs.t_id_operation=oper.t_id_operation )) mbk_acctrn, --проводки мбк

         /*Ценные бумаги (сторонние)*/
         (select count(1) from ddl_tick_dbt where t_bofficekind = 101 and t_marketid=-1 and t_clientid=-1 and t_dealdate between (select t_begindate from parm) and (select t_enddate from parm)) secur_deals_nonexchange, --внебиржевые сделки
         (select count(1) from ddl_tick_dbt where t_bofficekind = 101 and t_marketid> 0 and t_clientid=-1 and t_dealdate between (select t_begindate from parm) and (select t_enddate from parm)) secur_deals_exchange, --биржевые сделки
         (select count(1) from doffers_dbt o where not exists (select 1 from dfininstr_dbt f where exists (select 1 from ddp_dep_dbt where t_partyid=f.t_issuer) and f.t_fiid=o.t_fiid) and t_begindateoffer between (select t_begindate from parm) and (select t_enddate from parm)) secur_offers, --оферты
         (select count(1) from ddl_tick_dbt where t_bofficekind = 117 and t_dealtype = 12021 and t_clientid=-1 and t_dealdate between (select t_begindate from parm) and (select t_enddate from parm)) secur_repays, --погашения
         (select count(1) from acctrn t --dacctrn_dbt t where t_date_carry between (select t_begindate from parm) and (select t_enddate from parm) and not t_chapter in (21, 22) 
           where  ( exists(select /*+ leading(grdoc) index(grdoc DDLGRDOC_DBT_IDX3)*/ 1 from   ddlgrdeal_dbt grdeal, ddlgrdoc_dbt grdoc  where grdoc.t_docid = t.t_acctrnid and grdoc.t_grdealid = grdeal.t_id and grdoc.t_dockind = 1
                        and ( exists (select /*+ index(tick DDL_TICK_DBT_IDX0 )*/ 1 from ddl_tick_dbt tick where tick.t_bofficekind in (101, 117, 127) and tick.t_clientid=-1 and grdeal.t_dockind = tick.t_bofficekind and grdeal.t_docid = tick.t_dealid) 
                              or exists (select 1 from ddl_comm_dbt c where t_dockind=4621 and t_clientid<=0 and exists (select 1 from dfininstr_dbt where t_fi_kind=2 and t_fiid=c.t_fiid and not t_issuer in (select t_partyid from ddp_dep_dbt))
                                     and grdeal.t_dockind = t_dockind and grdeal.t_docid = t_documentid )))
               or exists(select /*+ leading(docs) index(docs DOPRDOCS_DBT_IDX6) use_nl(opr) */ 1 from doprdocs_dbt docs, doproper_dbt opr where docs.t_acctrnid = t.t_acctrnid and docs.t_id_operation = opr.t_id_operation and docs.t_dockind = 1
                         and (  exists (select 1 from dfininstr_dbt where t_fi_kind=2 and not t_issuer in (select t_partyid from ddp_dep_dbt) and opr.t_dockind = 5 and opr.t_kind_operation= 2007 and to_number(opr.t_documentid)= t_fiid)
                             or exists (select 1 from ddl_tick_dbt where t_bofficekind in(101, 117) and t_clientid=-1 and opr.t_dockind = t_bofficekind and opr.t_kind_operation = t_dealtype and to_number(opr.t_documentid) = t_dealid )                                   
                             or exists (select 1 from  ddl_comm_dbt where t_dockind=107 and t_clientid<=0  and opr.t_dockind = t_dockind and opr.t_kind_operation=t_operationkind and to_number(opr.t_documentid)= t_documentid )
                      )))  ) secur_acctrn, --проводки ЦБ
         /*(select count(1) from (SELECT distinct t_fiid FROM v_scwrthistex v WHERE t_state IN (1, 3) AND t_amount > 0 and v.t_party=-1 and v.t_contract = 0
                 AND decode(t_instance,(SELECT MAX (t_instance) FROM v_scwrthistex WHERE v.t_sumid = t_sumid AND v.t_changedate = t_changedate),1,0)=1
                 AND decode(v.t_changedate,(SELECT MAX (t.t_changedate) FROM v_scwrthistex t WHERE v.t_sumid = t_sumid AND t.t_changedate <= (select t_enddate from parm)),1,0)=1))*/ 
          (select count(distinct t_fiid ) from fiid_cnt WHERE t_state IN (1, 3))      
                 secur_amount, --Кол-во цен. бум. в портфеле (на конец периода)
         /*Ценные бумаги (собственные, кроме векселей)*/
         /*(select count(1) from (SELECT t_fiid FROM v_scwrthistex v WHERE t_state IN (20, 21) AND t_amount > 0 AND v.t_party = -1 and v.t_contract = 0
                 AND decode(t_instance,(SELECT MAX (t_instance) FROM v_scwrthistex WHERE v.t_sumid = t_sumid AND v.t_changedate = t_changedate),1,0)=1
                 AND decode(v.t_changedate,(SELECT MAX (t.t_changedate) FROM v_scwrthistex t WHERE v.t_sumid = t_sumid AND t.t_changedate <= (select t_enddate from parm)),1,0)= 1
               group by t_fiid))*/
          (select count(distinct t_fiid ) from fiid_cnt WHERE t_state IN (20, 21))      
             oeb_portf, --количество на сопровождении
         (select count(1) from doffers_dbt o where exists (select 1 from dfininstr_dbt f where exists (select 1 from ddp_dep_dbt where t_partyid = f.t_issuer) and f.t_fiid=o.t_fiid) and T_DATEREDEMPTION between (select t_begindate from parm) and (select t_enddate from parm)) oeb_offers, --оферты
         (select count(1) from ddl_tick_dbt where t_bofficekind = 4832 and t_dealdate between (select t_begindate from parm) and (select t_enddate from parm)) oeb_repays, --кол-во выплат
         (select count(1) from acctrn t -- dacctrn_dbt t where t_date_carry between (select t_begindate from parm) and (select t_enddate from parm) and not t_chapter in (21, 22)
             where ( exists ( select /*+ leading(docs) index(docs DOPRDOCS_DBT_IDX6) use_nl(opr) */ 1 from -- (t.t_acctrnid in
                 -- (select docs.t_acctrnid from 
                doprdocs_dbt docs, doproper_dbt opr where t.t_acctrnid = docs.t_acctrnid and  (opr.t_dockind=4833 or (opr.t_dockind= 5 and exists (select 1 from dfininstr_dbt f where t_fiid=to_number(opr.t_documentid) and t_fi_kind=2 and t_issuer in (select t_partyid from ddp_Dep_dbt))))
                            and docs.t_id_operation = opr.t_id_operation and docs.t_dockind = 1)
                  or  exists ( select /*+ leading(grdoc) index(docs DDLGRDOC_DBT_IDX3) */ 1 from -- ( t.t_acctrnid in
                -- (select grdoc.t_docid from 
                ddlgrdeal_dbt grdeal, ddlgrdoc_dbt grdoc where grdoc.t_docid = t.t_acctrnid and (grdeal.t_dockind in (4832, 4830) or (grdeal.t_dockind=4621 and exists (select 1 from ddl_comm_dbt c where t_documentid=grdeal.t_docid and t_dockind=grdeal.t_dockind and exists (select 1 from dfininstr_dbt where t_fi_kind=2 and t_fiid=c.t_fiid and t_issuer in (select t_partyid from ddp_dep_dbt)))))
                            and grdoc.t_grdealid = grdeal.t_id and grdoc.t_dockind = 1))) oeb_acctrn, --проводки по собственным ценным бумагам
         /*Векселя*/
         (select count(1) from (select distinct t_contractid, t_dockind from dvsordlnk_dbt l where not exists (select 1 from dvsbanner_dbt b where exists (select 1 from ddp_dep_dbt where t_partyid=b.t_issuer) and b.t_bcid=l.t_bcid) and l.t_interestchargedate between (select t_begindate from parm) and (select t_enddate from parm))) va_deals, --кол-во сделок (учтенные)
         (select count(1) from (select distinct t_contractid, t_dockind from dvsordlnk_dbt l where exists (select 1 from dvsbanner_dbt where t_issuer=1 and t_bcid=l.t_bcid) and l.t_interestchargedate between (select t_begindate from parm) and (select t_enddate from parm) and t_dockind = 109)) vs_deals, --кол-во сделок (собственные ГО)
         (select count(1) from dvsbanner_dbt where t_issuer in (select t_partyid from ddp_dep_dbt) and t_issuedate <= (select t_enddate from parm) and (t_repaymentdate = to_date('01.01.0001', 'dd.mm.yyyy') or t_repaymentdate > (select t_enddate from parm))) vs_banners, --Кол-во собственых векселей на бухгалтерском сопровождении
         (select count(1) from dvsbanner_dbt where t_issuer in (select t_partyid from ddp_dep_dbt) and t_issuedate between (select t_begindate from parm) and (select t_enddate from parm)) vs_issue, --Кол-во выпущенных векселей за период
         (select count(1) from dvsbanner_dbt where t_issuer in (select t_partyid from ddp_dep_dbt) and t_repaymentdate between (select t_begindate from parm) and (select t_enddate from parm)) vs_repayment, --Кол-во погашенных векселей за период
         (select count(1) from dacctrn_dbt where t_number_pack in (50, 55) and t_date_carry between (select t_begindate from parm) and (select t_enddate from parm)) veksel_acctrn, --проводки по векселям
         /*Срочный рынок (собственные операции)*/
         (select count(1) from (select * from ddvdeal_dbt where t_date between (select t_begindate from parm) and (select t_enddate from parm) and t_client = -1 --cделки, заключенные за период отчета
                                union all
                                select deal.* from ddvdeal_dbt deal where deal.t_client = -1 and deal.t_date < (select t_begindate from parm) and (select max(t_date) from ddvdlturn_dbt where t_dealid = deal.t_id) >= (select t_begindate from parm)) --сделки, открытые на начало периода
         ) forts_deals, --кол-во сделок
         nvl((select sum(abs(t_longposition-t_shortposition)) from ddvfiturn_dbt where t_client = -1 and t_date = :3), 0) open_positions, --кол-во открытых контрактов на отчетную дату
         (select count(1) from acctrn t -- dacctrn_dbt t where t_date_carry between (select t_begindate from parm) and (select t_enddate from parm) and not t_chapter in (21, 22) 
          where exists --t_acctrnid in
                --(select docs.t_acctrnid 
                ( select /*+ leading(docs) index(docs DOPRDOCS_DBT_IDX6) use_nl(oper) */ 1
                from ddvoper_Dbt dvoper, doproper_dbt oper, doprdocs_dbt docs where t.t_acctrnid = docs.t_acctrnid and dvoper.t_dockind = 194 and dvoper.t_flag1=1 and dvoper.t_dockind=oper.t_dockind and dvoper.t_operkind=oper.t_kind_operation and dvoper.t_id=to_number(oper.t_documentid) and docs.t_dockind=1 and docs.t_id_operation=oper.t_id_operation)) forts_acctrn, --проводки по срочному рынку
         /*Брокерские операции. Есть мнение, что кол-во клиентов и кол-во новых клиентов следует искать, отталкиваясь от договоров обслуживания*/
         --(select count(1) from dparty_dbt p where t_partyid in (select t_partyid from dclient_dbt where t_servicekind in (1, 15) and t_startdate between (select t_begindate from parm) and (select t_enddate from parm)) and not exists (select 1 from dclient_dbt where t_partyid=p.t_partyid and t_servicekind in (1, 15) and t_startdate <= (select t_startdate-1 from parm))) brok_new_clients, --кол-во новых клиентов за период
         (select count(1) from (select distinct t_partyid From dsfcontr_Dbt sf where t_servkind = 0 and t_datebegin between (select t_begindate from parm) and (select t_enddate from parm) and not exists (select 1 from dsfcontr_dbt where t_servkind = 0 and t_partyid = sf.t_partyid and t_datebegin < (select t_begindate from parm) and (t_dateclose > (select t_begindate from parm) or t_dateclose = to_date('01.01.0001', 'dd.mm.yyyy'))))) brok_new_clients, --кол-во новых клиентов за период
         (select count(1) from (select distinct t_partyid From dsfcontr_Dbt sf where t_servkind = 0 and t_dateclose between (select t_begindate from parm) and (select t_enddate from parm) and not exists (select 1 from dsfcontr_dbt where t_servkind = 0 and t_partyid = sf.t_partyid and t_datebegin < (select t_enddate from parm) and (t_dateclose > (select t_enddate from parm) or t_dateclose = to_date('01.01.0001', 'dd.mm.yyyy'))))) brok_closed_clients, -- кол-во закрытых клиентов за период
         --(select count(1) from dparty_dbt where t_partyid in (select t_partyid from dclient_dbt where t_servicekind in (1, 15) and t_startdate <= (select t_enddate from parm) and (t_finishdate = to_date('01.01.0001', 'dd.mm.yyyy') or t_finishdate > (select t_enddate from parm)))) brok_clients, --кол-во клиентов на конец периода
         (select count(1) from (select distinct t_partyid From dsfcontr_Dbt where t_servkind = 0 and t_datebegin <= (select t_enddate from parm) and (t_dateclose > (select t_enddate from parm) or t_dateclose = to_date('01.01.0001','dd.mm.yyyy')))) brok_clients, --кол-во клиентов на конец периода
         (select count(1) From dsfcontr_dbt where t_servkind = 0 and t_datebegin between (select t_begindate from parm) and (select t_enddate from parm)) brok_contr_new, -- Кол-во новых договоров брокерского обслуживания за период
         (select count(1) From dsfcontr_dbt where t_servkind = 0 and t_dateclose between (select t_begindate from parm) and (select t_enddate from parm)) brok_contr_closed, -- Кол-во закрытых договоров брокерского обслуживания за период
         (select count(1) From dsfcontr_Dbt where t_servkind = 0 and t_datebegin <= (select t_enddate from parm) and (t_dateclose > (select t_enddate from parm) or t_dateclose = to_date('01.01.0001','dd.mm.yyyy'))) brok_contracts, -- Кол-во договоров брокерского обслуживания на отчетную дату
         (select count(1) from dscsrvrepobj_dbt where t_createdate between (select t_begindate from parm) and (select t_enddate from parm)) brok_reports, --кол-во брокерских отчетов за период
         (select count(1) from ddl_tick_dbt where t_bofficekind = 101 and (t_marketid > 0 and RSB_SECUR.IsOTC(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(t_DealType, t_BofficeKind))) = 0) and t_clientid > 0 and t_dealdate between (select t_begindate from parm) and (select t_enddate from parm)) 
                + (select count(1) from ddvdeal_dbt where t_client > 0 and t_date between (select t_begindate from parm) and (select t_enddate from parm)) brok_exchange, --кол-во биржевых сделок
         (select count(1) from ddl_tick_dbt where t_bofficekind = 101 and (t_marketid = -1 or RSB_SECUR.IsOTC(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(t_DealType, t_BofficeKind))) = 1) and t_clientid > 0 and t_dealdate between (select t_begindate from parm) and (select t_enddate from parm))
             --   + (select count(1) from ddvndeal_dbt where t_client > 0 and t_date between (select t_begindate from parm) and (select t_enddate from parm)) brok_nonexchange, --кол-во внебиржевых сделок
                  + (select d_brok_nonexchange from ddvndeal) brok_nonexchange, --кол-во внебиржевых сделок
         (select count(1) from dnptxop_dbt where t_subkind_operation = 20 and t_operdate between (select t_begindate from parm) and (select t_enddate from parm)) brok_out, --кол-во выводов денежных средств с брокерского счета
         (select count(1) from acctrn t -- dacctrn_dbt t where t_date_carry between (select t_begindate from parm) and (select t_enddate from parm) and not t_chapter in (21, 22) 
            where ( exists (select /*+ leading(grdoc) index(grdoc DDLGRDOC_DBT_IDX3 ) index(tick DDL_TICK_DBT_IDX0)*/ 1 from  ddlgrdoc_dbt grdoc, ddlgrdeal_dbt grdeal, ddl_tick_dbt tick 
                             where grdoc.t_docid = t.t_acctrnid and grdoc.t_grdealid = grdeal.t_id and grdoc.t_dockind=1 and grdeal.t_dockind = tick.t_bofficekind and grdeal.t_docid = tick.t_dealid and tick.t_bofficekind in (101, 117, 127) and tick.t_clientid>0)
                or exists(select /*+ leading(docs) index(docs DOPRDOCS_DBT_IDX6) use_nl(opr) */ 1 from doprdocs_dbt docs, doproper_dbt opr where docs.t_acctrnid = t.t_acctrnid and docs.t_id_operation = opr.t_id_operation and docs.t_dockind=1
                           and ( exists ( select 1 from ddl_tick_dbt where t_bofficekind in(101, 117) and t_clientid>0 and opr.t_dockind = t_bofficekind and opr.t_kind_operation= t_dealtype and to_number(opr.t_documentid)= t_dealid )
                                or exists ( select 1 from dnptxop_dbt where t_dockind=4607 and t_client>0 and opr.t_dockind = t_dockind and opr.t_kind_operation=t_kind_operation and to_number(opr.t_documentid)=t_id )
                                or exists ( select 1 from ddl_acc_dbt where t_dockind=159 and t_client>0 and opr.t_dockind = t_dockind and opr.t_kind_operation=t_operkind and to_number(opr.t_documentid)=t_id )
                                or exists ( select 1 from ddvoper_Dbt where t_dockind=194 and t_flag1=2 and opr.t_dockind = t_dockind and opr.t_kind_operation= t_operkind and to_number(opr.t_documentid)=t_id )
                )))
                                  ) brok_acctrn --Проводки брокерских операций
  from dual];


  /*
  [with parm as (select :1 t_begindate, :2 t_enddate from dual) 
  select /*ФИССиКО собственные сделки*/
         --(select count(1) from ddvndeal_dbt where t_date between (select t_begindate from parm) and (select t_enddate from parm)) + (select count(1) from ddvdeal_dbt where t_date between (select t_begindate from parm) and (select t_enddate from parm)) fissiko_all,
         (select count(1) from ddvndeal_dbt where t_date between (select t_begindate from parm) and (select t_enddate from parm) and t_client=-1 and t_dvkind<>8 and t_sector = chr(88)) fissiko_all_ex, --все сделки фиссико, кроме банкнот. Биржа
         (select count(1) from ddvndeal_dbt where t_date between (select t_begindate from parm) and (select t_enddate from parm) and t_client=-1 and t_dvkind<>8 and t_sector = chr(0)) fissiko_all_nonex, --все сделки фиссико, кроме банкнот. Внебиржа
         (select count(1) from ddvndeal_dbt where t_dvkind = 8 and t_date between (select t_begindate from parm) and (select t_enddate from parm)) banknote_deals, --банкноты
         --(select count(1) from ddvndeal_dbt where t_dvkind = 3 and t_date between (select t_begindate from parm) and (select t_enddate from parm)) swap_currency, --валютный своп
         --(select count(1) from ddvndeal_dbt where t_dvkind = 4 and t_date between (select t_begindate from parm) and (select t_enddate from parm)) swap_percent, --процентный своп
         (select count(1) from ddvndeal_dbt where t_dvkind in(3, 4, 6) and t_date between (select t_begindate from parm) and (select t_enddate from parm) and t_client=-1 and t_sector = chr(88)) swap_ex, --своп. Биржа
         (select count(1) from ddvndeal_dbt where t_dvkind in(3, 4, 6) and t_date between (select t_begindate from parm) and (select t_enddate from parm) and t_client=-1 and t_sector = chr(0)) swap_nonex, --своп. Внебиржа
         (SELECT count(1) FROM ddl_nett_dbt nett WHERE t_kind_operation = 11080 AND t_signingdate BETWEEN (select t_begindate from parm) AND (select t_enddate from parm) AND t_clientid <= 0 AND EXISTS
              (SELECT 1 FROM ddvndeal_dbt dvndeal WHERE EXISTS (SELECT 1 FROM dpmpaym_dbt WHERE TO_NUMBER (t_documentid) = dvndeal.t_id AND t_dockind = dvndeal.t_dockind
                                 AND t_paymentid IN (SELECT DISTINCT t_InitialPayment FROM dpmlink_dbt pmlink WHERE pmlink.t_DocKind = nett.t_dockind AND pmlink.t_DocumentID = nett.t_nettingid AND pmlink.t_LinkKind=1)) and t_sector = chr(88))) netting_ex, --неттинг. Биржа
         (SELECT count(1) FROM ddl_nett_dbt nett WHERE t_kind_operation = 11080 AND t_signingdate BETWEEN (select t_begindate from parm) AND (select t_enddate from parm) AND t_clientid <= 0 AND EXISTS
              (SELECT 1 FROM ddvndeal_dbt dvndeal WHERE EXISTS (SELECT 1 FROM dpmpaym_dbt WHERE TO_NUMBER (t_documentid) = dvndeal.t_id AND t_dockind = dvndeal.t_dockind
                                 AND t_paymentid IN (SELECT DISTINCT t_InitialPayment FROM dpmlink_dbt pmlink WHERE pmlink.t_DocKind = nett.t_dockind AND pmlink.t_DocumentID = nett.t_nettingid AND pmlink.t_LinkKind=1)) and t_sector = chr(0))) netting_nonex, --неттинг. Внеиржа
         (select count(1) from ddvcsa_dbt where t_begdate < (select t_begindate from parm) and (t_enddate > (select t_enddate from parm) or t_enddate=to_date('01.01.0001', 'dd.mm.yyyy'))) csa, --CSA
         (select count(1) from ddvcsapm_dbt where t_date between (select t_begindate from parm) and (select t_enddate from parm)) csa_pm, --платежи CSA
         (select count(1) from ddvndeal_dbt d where t_dvkind in (1,5,7,9) and t_date between (select t_begindate from parm) and (select t_enddate from parm) and t_client=-1 and not exists (select 1 from dpartyown_dbt where t_partykind=2 and t_partyid=d.t_contractor)) fissiko_505, --конверсионные сделки с контрагентами - не кредитными организациями
         (select count(1) from ddvndeal_dbt d where t_ispfi = chr(88) and t_date between (select t_begindate from parm) and (select t_enddate from parm) and not exists (select 1 from dpartyown_dbt where t_partykind=2 and t_partyid=d.t_contractor)) fissiko_bd_sd, --бивалютные и структурные депозиты, т.е. сделки ПФИ с некредитными организациями
         (select count(1) from dacctrn_dbt t where t_date_carry between (select t_begindate from parm) and (select t_enddate from parm) and not t_chapter in (21, 22) 
            and exists (select 1 from doproper_dbt oper, doprdocs_dbt docs where docs.t_acctrnid = t.t_acctrnid and docs.t_dockind=1 and docs.t_id_operation=oper.t_id_operation
                 and ( exists (select 1 from ddvndeal_dbt where t_client=-1 and t_dockind =oper.t_dockind and t_kind=oper.t_kind_operation and t_id = to_number(oper.t_documentid) )
                    or exists (select 1 from ddl_nett_dbt where t_clientid<=0 and t_kind_operation=11080 and t_dockind =oper.t_dockind and t_kind_operation = oper.t_kind_operation and t_nettingid =to_number(oper.t_documentid) )
                    or exists (select 1 from ddvoper_dbt where t_operkind=12602 and t_dockind = oper.t_dockind and t_operkind =oper.t_kind_operation and t_id =to_number(oper.t_documentid) )
                    or exists (select 1 from  ddvcsa_dbt  where  4626 =oper.t_dockind and 2795 =oper.t_kind_operation and t_csaid =to_number(oper.t_documentid)))))
         --(select count(1) from dacctrn_dbt where t_date_carry between (select t_begindate from parm) and (select t_enddate from parm) and not t_chapter in (21, 22) and t_acctrnid in
         --     (select docs.t_acctrnid from doproper_dbt oper, doprdocs_dbt docs, (select t_id dealid, t_dockind dockind, t_kind kind from ddvndeal_dbt where t_client=-1
         --                                                                        union select t_nettingid dealid, t_dockind dockind, t_kind_operation kind from ddl_nett_dbt where t_clientid<=0 and t_kind_operation=11080
         --                                                                        union select t_id dealid, t_dockind dockind, t_operkind kind from ddvoper_dbt where t_operkind=12602
         --                                                                        union select t_csaid dealid, 4626 dockind, 2795 kind from ddvcsa_dbt) deal
         --    where deal.dockind=oper.t_dockind and deal.kind=oper.t_kind_operation and deal.dealid=to_number(oper.t_documentid) and docs.t_dockind=1 and docs.t_id_operation=oper.t_id_operation))
          +(select count(1) from dacctrn_dbt trn where t_date_carry between (select t_begindate from parm) and (select t_enddate from parm) and not t_chapter in (21, 22) and t_number_pack in (30, 35, 70, 80) and not exists (select 1 from doprdocs_dbt where t_dockind=1 and t_acctrnid=trn.t_acctrnid)) fissiko_acctrn, --проводки фиссико
         /*МБК*/
         (select count(1) from ddl_tick_dbt where t_bofficekind = 102 and t_dealdate between (select t_begindate from parm) and (select t_enddate from parm)) mbk_deals, --кол-во операций МБК за период
         (select count(1) from ddl_tick_dbt where t_bofficekind = 102 and t_dealdate < (select t_enddate from parm) and (t_closedate = to_date('01.01.0001', 'dd.mm.yyyy') or t_closedate > (select t_enddate from parm))) mbk_opendeals, --кол-во открытых сделок на отчетную дату
         (select count(1) from dacctrn_dbt where t_date_carry between (select t_begindate from parm) and (select t_enddate from parm) and not t_chapter in (21, 22) and t_acctrnid in
              (select docs.t_acctrnid from doproper_dbt oper, doprdocs_dbt docs, ddl_tick_dbt tick where tick.t_bofficekind=102 and tick.t_bofficekind=oper.t_dockind and tick.t_dealtype=oper.t_kind_operation and tick.t_dealid=to_number(oper.t_documentid) and docs.t_dockind=1 and docs.t_id_operation=oper.t_id_operation )) mbk_acctrn, --проводки мбк
         /*Ценные бумаги (сторонние)*/
         (select count(1) from ddl_tick_dbt where t_bofficekind = 101 and t_marketid=-1 and t_clientid=-1 and t_dealdate between (select t_begindate from parm) and (select t_enddate from parm)) secur_deals_nonexchange, --внебиржевые сделки
         (select count(1) from ddl_tick_dbt where t_bofficekind = 101 and t_marketid> 0 and t_clientid=-1 and t_dealdate between (select t_begindate from parm) and (select t_enddate from parm)) secur_deals_exchange, --биржевые сделки
         (select count(1) from doffers_dbt o where not exists (select 1 from dfininstr_dbt f where exists (select 1 from ddp_dep_dbt where t_partyid=f.t_issuer) and f.t_fiid=o.t_fiid) and t_begindateoffer between (select t_begindate from parm) and (select t_enddate from parm)) secur_offers, --оферты
         (select count(1) from ddl_tick_dbt where t_bofficekind = 117 and t_dealtype = 12021 and t_clientid=-1 and t_dealdate between (select t_begindate from parm) and (select t_enddate from parm)) secur_repays, --погашения
         (select count(1) from dacctrn_dbt t where t_date_carry between (select t_begindate from parm) and (select t_enddate from parm) and not t_chapter in (21, 22) 
           and ( exists(select 1 from   ddlgrdeal_dbt grdeal, ddlgrdoc_dbt grdoc  where grdoc.t_docid = t.t_acctrnid and grdoc.t_grdealid = grdeal.t_id and grdoc.t_dockind = 1
                        and ( exists (select /*+ index(tick DDL_TICK_DBT_IDX0 )*/ 1 from ddl_tick_dbt tick where tick.t_bofficekind in (101, 117, 127) and tick.t_clientid=-1 and grdeal.t_dockind = tick.t_bofficekind and grdeal.t_docid = tick.t_dealid) 
                              or exists (select 1 from ddl_comm_dbt c where t_dockind=4621 and t_clientid<=0 and exists (select 1 from dfininstr_dbt where t_fi_kind=2 and t_fiid=c.t_fiid and not t_issuer in (select t_partyid from ddp_dep_dbt))
                                     and grdeal.t_dockind = t_dockind and grdeal.t_docid = t_documentid )))
             or exists(select 1 from doprdocs_dbt docs, doproper_dbt opr where docs.t_acctrnid = t.t_acctrnid and docs.t_id_operation = opr.t_id_operation and docs.t_dockind = 1
                         and (  exists (select 1 from dfininstr_dbt where t_fi_kind=2 and not t_issuer in (select t_partyid from ddp_dep_dbt) and opr.t_dockind = 5 and opr.t_kind_operation= 2007 and to_number(opr.t_documentid)= t_fiid)
                             or exists (select 1 from ddl_tick_dbt where t_bofficekind in(101, 117) and t_clientid=-1 and opr.t_dockind = t_bofficekind and opr.t_kind_operation = t_dealtype and to_number(opr.t_documentid) = t_dealid )                                   
                             or exists (select 1 from  ddl_comm_dbt where t_dockind=107 and t_clientid<=0  and opr.t_dockind = t_dockind and opr.t_kind_operation=t_operationkind and to_number(opr.t_documentid)= t_documentid )
            )))
         --select count(1) from dacctrn_dbt t where t_date_carry between (select t_begindate from parm) and (select t_enddate from parm) and not t_chapter in (21, 22) and ( (t.t_acctrnid in
         --        (select docs.t_acctrnid from doprdocs_dbt docs, doproper_dbt opr,
         --                               (select t_fiid t_dealid, 5 t_dockind, 2007 t_kind from dfininstr_dbt where t_fi_kind=2 and not t_issuer in (select t_partyid from ddp_dep_dbt) union
         --                                select t_dealid, t_bofficekind t_dockind, t_dealtype t_kind from ddl_tick_dbt where t_bofficekind in(101, 117) and t_clientid=-1 union
         --                                select t_documentid t_dealid, t_dockind, t_operationkind t_kind from ddl_comm_dbt where t_dockind=107 and t_clientid<=0) deal
         --         where opr.t_dockind = deal.t_dockind and opr.t_kind_operation=deal.t_kind and to_number(opr.t_documentid)=deal.t_dealid and docs.t_id_operation = opr.t_id_operation and docs.t_dockind = 1)
         --    or t.t_acctrnid in
         --        (select grdoc.t_docid from ddlgrdeal_dbt grdeal, ddlgrdoc_dbt grdoc,
         --                             (select t_dealid, t_bofficekind t_dockind from ddl_tick_dbt where t_bofficekind in (101, 117, 127) and t_clientid=-1 union
         --                              select t_documentid t_dealid, t_dockind from ddl_comm_dbt c where t_dockind=4621 and t_clientid<=0 and exists (select 1 from dfininstr_dbt where t_fi_kind=2 and t_fiid=c.t_fiid and not t_issuer in (select t_partyid from ddp_dep_dbt))) deal
         --         where grdeal.t_dockind = deal.t_dockind and grdeal.t_docid = deal.t_dealid and grdoc.t_grdealid = grdeal.t_id and grdoc.t_dockind = 1)))
         ) secur_acctrn, --проводки ЦБ
         (select count(1) from (SELECT distinct t_fiid FROM v_scwrthistex v WHERE t_state IN (1, 3) AND t_amount > 0 and v.t_party=-1 and v.t_contract = 0
                 AND decode(t_instance,(SELECT MAX (t_instance) FROM v_scwrthistex WHERE v.t_sumid = t_sumid AND v.t_changedate = t_changedate),1,0)=1
                 AND decode(v.t_changedate,(SELECT MAX (t.t_changedate) FROM v_scwrthistex t WHERE v.t_sumid = t_sumid AND t.t_changedate <= (select t_enddate from parm)),1,0)=1)) secur_amount, --Кол-во цен. бум. в портфеле (на конец периода)
         /*Ценные бумаги (собственные, кроме векселей)*/
         (select count(1) from (SELECT t_fiid FROM v_scwrthistex v WHERE t_state IN (20, 21) AND t_amount > 0 AND v.t_party = -1 and v.t_contract = 0
                 AND decode(t_instance,(SELECT MAX (t_instance) FROM v_scwrthistex WHERE v.t_sumid = t_sumid AND v.t_changedate = t_changedate),1,0)=1
                 AND decode(v.t_changedate,(SELECT MAX (t.t_changedate) FROM v_scwrthistex t WHERE v.t_sumid = t_sumid AND t.t_changedate <= (select t_enddate from parm)),1,0)= 1
               group by t_fiid)) oeb_portf, --количество на сопровождении
         (select count(1) from doffers_dbt o where exists (select 1 from dfininstr_dbt f where exists (select 1 from ddp_dep_dbt where t_partyid = f.t_issuer) and f.t_fiid=o.t_fiid) and T_DATEREDEMPTION between (select t_begindate from parm) and (select t_enddate from parm)) oeb_offers, --оферты
         (select count(1) from ddl_tick_dbt where t_bofficekind = 4832 and t_dealdate between (select t_begindate from parm) and (select t_enddate from parm)) oeb_repays, --кол-во выплат
         (select count(1) from dacctrn_dbt t where t_date_carry between (select t_begindate from parm) and (select t_enddate from parm) and not t_chapter in (21, 22) and ( (t.t_acctrnid in
                (select docs.t_acctrnid from doprdocs_dbt docs, doproper_dbt opr where (opr.t_dockind=4833 or (opr.t_dockind= 5 and exists (select 1 from dfininstr_dbt f where t_fiid=to_number(opr.t_documentid) and t_fi_kind=2 and t_issuer in (select t_partyid from ddp_Dep_dbt))))
                            and docs.t_id_operation = opr.t_id_operation and docs.t_dockind = 1) or t.t_acctrnid in
                (select grdoc.t_docid from ddlgrdeal_dbt grdeal, ddlgrdoc_dbt grdoc where (grdeal.t_dockind in (4832, 4830) or (grdeal.t_dockind=4621 and exists (select 1 from ddl_comm_dbt c where t_documentid=grdeal.t_docid and t_dockind=grdeal.t_dockind and exists (select 1 from dfininstr_dbt where t_fi_kind=2 and t_fiid=c.t_fiid and t_issuer in (select t_partyid from ddp_dep_dbt)))))
                            and grdoc.t_grdealid = grdeal.t_id and grdoc.t_dockind = 1)))) oeb_acctrn, --проводки по собственным ценным бумагам
         /*Векселя*/
         (select count(1) from (select distinct t_contractid, t_dockind from dvsordlnk_dbt l where not exists (select 1 from dvsbanner_dbt b where exists (select 1 from ddp_dep_dbt where t_partyid=b.t_issuer) and b.t_bcid=l.t_bcid) and l.t_interestchargedate between (select t_begindate from parm) and (select t_enddate from parm))) va_deals, --кол-во сделок (учтенные)
         (select count(1) from (select distinct t_contractid, t_dockind from dvsordlnk_dbt l where exists (select 1 from dvsbanner_dbt where t_issuer=1 and t_bcid=l.t_bcid) and l.t_interestchargedate between (select t_begindate from parm) and (select t_enddate from parm) and t_dockind = 109)) vs_deals, --кол-во сделок (собственные ГО)
         (select count(1) from dvsbanner_dbt where t_issuer in (select t_partyid from ddp_dep_dbt) and t_issuedate <= (select t_enddate from parm) and (t_repaymentdate = to_date('01.01.0001', 'dd.mm.yyyy') or t_repaymentdate > (select t_enddate from parm))) vs_banners, --Кол-во собственых векселей на бухгалтерском сопровождении
         (select count(1) from dvsbanner_dbt where t_issuer in (select t_partyid from ddp_dep_dbt) and t_issuedate between (select t_begindate from parm) and (select t_enddate from parm)) vs_issue, --Кол-во выпущенных векселей за период
         (select count(1) from dvsbanner_dbt where t_issuer in (select t_partyid from ddp_dep_dbt) and t_repaymentdate between (select t_begindate from parm) and (select t_enddate from parm)) vs_repayment, --Кол-во погашенных векселей за период
         (select count(1) from dacctrn_dbt where t_number_pack in (50, 55) and t_date_carry between (select t_begindate from parm) and (select t_enddate from parm)) veksel_acctrn, --проводки по векселям
         /*Срочный рынок (собственные операции)*/
         (select count(1) from (select * from ddvdeal_dbt where t_date between (select t_begindate from parm) and (select t_enddate from parm) and t_client = -1 --cделки, заключенные за период отчета
                                union all
                                select deal.* from ddvdeal_dbt deal where deal.t_client = -1 and deal.t_date < (select t_begindate from parm) and (select max(t_date) from ddvdlturn_dbt where t_dealid = deal.t_id) >= (select t_begindate from parm)) --сделки, открытые на начало периода
         ) forts_deals, --кол-во сделок
         nvl((select sum(abs(t_longposition-t_shortposition)) from ddvfiturn_dbt where t_client = -1 and t_date = :3), 0) open_positions, --кол-во открытых контрактов на отчетную дату
         (select count(1) from dacctrn_dbt t where t_date_carry between (select t_begindate from parm) and (select t_enddate from parm) and not t_chapter in (21, 22) and t_acctrnid in
                (select docs.t_acctrnid from ddvoper_Dbt dvoper, doproper_dbt oper, doprdocs_dbt docs where dvoper.t_dockind = 194 and dvoper.t_flag1=1 and dvoper.t_dockind=oper.t_dockind and dvoper.t_operkind=oper.t_kind_operation and dvoper.t_id=to_number(oper.t_documentid) and docs.t_dockind=1 and docs.t_id_operation=oper.t_id_operation)) forts_acctrn, --проводки по срочному рынку
         /*Брокерские операции. Есть мнение, что кол-во клиентов и кол-во новых клиентов следует искать, отталкиваясь от договоров обслуживания*/
         --(select count(1) from dparty_dbt p where t_partyid in (select t_partyid from dclient_dbt where t_servicekind in (1, 15) and t_startdate between (select t_begindate from parm) and (select t_enddate from parm)) and not exists (select 1 from dclient_dbt where t_partyid=p.t_partyid and t_servicekind in (1, 15) and t_startdate <= (select t_startdate-1 from parm))) brok_new_clients, --кол-во новых клиентов за период
         (select count(1) from (select distinct t_partyid From dsfcontr_Dbt sf where t_servkind = 0 and t_datebegin between (select t_begindate from parm) and (select t_enddate from parm) and not exists (select 1 from dsfcontr_dbt where t_servkind = 0 and t_partyid = sf.t_partyid and t_datebegin < (select t_begindate from parm) and (t_dateclose > (select t_begindate from parm) or t_dateclose = to_date('01.01.0001', 'dd.mm.yyyy'))))) brok_new_clients, --кол-во новых клиентов за период
         (select count(1) from (select distinct t_partyid From dsfcontr_Dbt sf where t_servkind = 0 and t_dateclose between (select t_begindate from parm) and (select t_enddate from parm) and not exists (select 1 from dsfcontr_dbt where t_servkind = 0 and t_partyid = sf.t_partyid and t_datebegin < (select t_enddate from parm) and (t_dateclose > (select t_enddate from parm) or t_dateclose = to_date('01.01.0001', 'dd.mm.yyyy'))))) brok_closed_clients, -- кол-во закрытых клиентов за период
         --(select count(1) from dparty_dbt where t_partyid in (select t_partyid from dclient_dbt where t_servicekind in (1, 15) and t_startdate <= (select t_enddate from parm) and (t_finishdate = to_date('01.01.0001', 'dd.mm.yyyy') or t_finishdate > (select t_enddate from parm)))) brok_clients, --кол-во клиентов на конец периода
         (select count(1) from (select distinct t_partyid From dsfcontr_Dbt where t_servkind = 0 and t_datebegin <= (select t_enddate from parm) and (t_dateclose > (select t_enddate from parm) or t_dateclose = to_date('01.01.0001','dd.mm.yyyy')))) brok_clients, --кол-во клиентов на конец периода
         (select count(1) From dsfcontr_dbt where t_servkind = 0 and t_datebegin between (select t_begindate from parm) and (select t_enddate from parm)) brok_contr_new, -- Кол-во новых договоров брокерского обслуживания за период
         (select count(1) From dsfcontr_dbt where t_servkind = 0 and t_dateclose between (select t_begindate from parm) and (select t_enddate from parm)) brok_contr_closed, -- Кол-во закрытых договоров брокерского обслуживания за период
         (select count(1) From dsfcontr_Dbt where t_servkind = 0 and t_datebegin <= (select t_enddate from parm) and (t_dateclose > (select t_enddate from parm) or t_dateclose = to_date('01.01.0001','dd.mm.yyyy'))) brok_contracts, -- Кол-во договоров брокерского обслуживания на отчетную дату
         (select count(1) from dscsrvrepobj_dbt where t_createdate between (select t_begindate from parm) and (select t_enddate from parm)) brok_reports, --кол-во брокерских отчетов за период
         (select count(1) from ddl_tick_dbt where t_bofficekind = 101 and (t_marketid > 0 and RSB_SECUR.IsOTC(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(t_DealType, t_BofficeKind))) = 0) and t_clientid > 0 and t_dealdate between (select t_begindate from parm) and (select t_enddate from parm)) + (select count(1) from ddvdeal_dbt where t_client > 0 and t_date between (select t_begindate from parm) and (select t_enddate from parm)) brok_exchange, --кол-во биржевых сделок
         (select count(1) from ddl_tick_dbt where t_bofficekind = 101 and (t_marketid = -1 or RSB_SECUR.IsOTC(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(t_DealType, t_BofficeKind))) = 1) and t_clientid > 0 and t_dealdate between (select t_begindate from parm) and (select t_enddate from parm)) + (select count(1) from ddvndeal_dbt where t_client > 0 and t_date between (select t_begindate from parm) and (select t_enddate from parm)) brok_nonexchange, --кол-во внебиржевых сделок
         (select count(1) from dnptxop_dbt where t_subkind_operation = 20 and t_operdate between (select t_begindate from parm) and (select t_enddate from parm)) brok_out, --кол-во выводов денежных средств с брокерского счета
         (select count(1) from dacctrn_dbt t where t_date_carry between (select t_begindate from parm) and (select t_enddate from parm) and not t_chapter in (21, 22) 
            and ( exists (select /*+ index(tick DDL_TICK_DBT_IDX0)*/ 1 from  ddlgrdoc_dbt grdoc, ddlgrdeal_dbt grdeal, ddl_tick_dbt tick 
                             where grdoc.t_docid = t.t_acctrnid and grdoc.t_grdealid = grdeal.t_id and grdoc.t_dockind=1 and grdeal.t_dockind = tick.t_bofficekind and grdeal.t_docid = tick.t_dealid and tick.t_bofficekind in (101, 117, 127) and tick.t_clientid>0)
                or exists(select 1 from doprdocs_dbt docs, doproper_dbt opr where docs.t_acctrnid = t.t_acctrnid and docs.t_id_operation = opr.t_id_operation and docs.t_dockind=1
                           and ( exists ( select 1 from ddl_tick_dbt where t_bofficekind in(101, 117) and t_clientid>0 and opr.t_dockind = t_bofficekind and opr.t_kind_operation= t_dealtype and to_number(opr.t_documentid)= t_dealid )
                                or exists ( select 1 from dnptxop_dbt where t_dockind=4607 and t_client>0 and opr.t_dockind = t_dockind and opr.t_kind_operation=t_kind_operation and to_number(opr.t_documentid)=t_id )
                                or exists ( select 1 from ddl_acc_dbt where t_dockind=159 and t_client>0 and opr.t_dockind = t_dockind and opr.t_kind_operation=t_operkind and to_number(opr.t_documentid)=t_id )
                                or exists ( select 1 from ddvoper_Dbt where t_dockind=194 and t_flag1=2 and opr.t_dockind = t_dockind and opr.t_kind_operation= t_operkind and to_number(opr.t_documentid)=t_id )
                )))
          -- select count(1) from dacctrn_dbt t where t_date_carry between (select t_begindate from parm) and (select t_enddate from parm) and not t_chapter in (21, 22) and ((t.t_acctrnid in 
          --       (select docs.t_acctrnid from doprdocs_dbt docs, doproper_dbt opr,
          --                              (select t_dealid, t_bofficekind t_dockind, t_dealtype t_kind from ddl_tick_dbt where t_bofficekind in(101, 117) and t_clientid>0 union
          --                               select t_id t_dealid, t_dockind, t_kind_operation t_kind from dnptxop_dbt where t_dockind=4607 and t_client>0 union
          --                               select t_id t_dealid, t_dockind, t_operkind t_kind from ddl_acc_dbt where t_dockind=159 and t_client>0 union
          --                               select t_id t_dealid, t_dockind, t_operkind t_kind from ddvoper_Dbt where t_dockind=194 and t_flag1=2) deal
          --        where opr.t_dockind = deal.t_dockind and opr.t_kind_operation=deal.t_kind and to_number(opr.t_documentid)=deal.t_dealid and docs.t_id_operation = opr.t_id_operation and docs.t_dockind=1)
          --    or t.t_acctrnid in (select grdoc.t_docid from ddlgrdeal_dbt grdeal, ddlgrdoc_dbt grdoc, (select t_dealid, t_bofficekind t_dockind from ddl_tick_dbt where t_bofficekind in (101, 117, 127) and t_clientid>0) deal
          --                        where grdeal.t_dockind = deal.t_dockind and grdeal.t_docid = deal.t_dealid and grdoc.t_grdealid = grdeal.t_id and grdoc.t_dockind=1)))
                                  ) brok_acctrn --Проводки брокерских операций
  from dual];
 */

  sql = ExecSqlSelect(StopCaptureOutput(), MakeArray(SqlParam("1", BeginPeriod), SqlParam("2", EndPeriod), SqlParam("3", dvEndPeriod)));

  if (not Sql.MoveNext() )
    MsgBox("Ошибка при сборе данных");
    return;
  end;


  rn = rn + 1;

  ObjPrint.SetValue_NameCell("TitleBA", "Статистика операций за период с "+BeginPeriod+" по "+EndPeriod);           

  //-------------------------------------------------------------------------------------------------
  //AddRow("ФИССиКО", "", true);
  ObjPrint.SetValue_NameCell("FX_1", sql.value("fissiko_all_ex")+sql.value("swap_ex")+sql.value("netting_ex"));           
  ObjPrint.SetValue_NameCell("FX_2", sql.value("fissiko_all_nonex")+sql.value("swap_nonex")+sql.value("netting_nonex"));  
  ObjPrint.SetValue_NameCell("FX_3", sql.value("csa"));                                                                   
  ObjPrint.SetValue_NameCell("FX_4", sql.value("csa_pm"));                                                                
  ObjPrint.SetValue_NameCell("FX_5", sql.value("banknote_deals"));                                                        
  ObjPrint.SetValue_NameCell("FX_6", sql.value("fissiko_505"));                                                           
  ObjPrint.SetValue_NameCell("FX_7", sql.value("fissiko_bd_sd"));                                                         
  ObjPrint.SetValue_NameCell("FX_8", sql.value("fissiko_acctrn"));                                                        

  //-------------------------------------------------------------------------------------------------
  // AddRow("МБК", "", true);
  ObjPrint.SetValue_NameCell("MBK_1", sql.value("mbk_deals"));                                                                       
  ObjPrint.SetValue_NameCell("MBK_2", sql.value("mbk_opendeals"));                                                                   
  ObjPrint.SetValue_NameCell("MBK_3", sql.value("mbk_acctrn"));                                                                      

  //-------------------------------------------------------------------------------------------------
  //AddRow("Ценные бумаги (сторонние)", "", true);

  ObjPrint.SetValue_NameCell("CBO_1", sql.value("secur_amount"));           
  ObjPrint.SetValue_NameCell("CBO_2", sql.value("secur_deals_nonexchange"));
  ObjPrint.SetValue_NameCell("CBO_3", sql.value("secur_deals_exchange"));   
  ObjPrint.SetValue_NameCell("CBO_4", sql.value("secur_offers"));           
  ObjPrint.SetValue_NameCell("CBO_5", sql.value("secur_repays"));           
  ObjPrint.SetValue_NameCell("CBO_6", sql.value("secur_acctrn"));           

  //-------------------------------------------------------------------------------------------------
  //AddRow("Ценные бумаги (собственные, кроме векселей)", "", true);
  ObjPrint.SetValue_NameCell("CBI_1", sql.value("oeb_portf")); 
  ObjPrint.SetValue_NameCell("CBI_2", sql.value("oeb_offers"));
  ObjPrint.SetValue_NameCell("CBI_3", sql.value("oeb_repays"));
  ObjPrint.SetValue_NameCell("CBI_4", sql.value("oeb_acctrn"));

  //-------------------------------------------------------------------------------------------------
  // AddRow("Векселя", "", true);
  ObjPrint.SetValue_NameCell("PN_1", sql.value("va_deals"));     
  ObjPrint.SetValue_NameCell("PN_2", sql.value("vs_deals"));     
  ObjPrint.SetValue_NameCell("PN_3", sql.value("vs_banners"));   
  ObjPrint.SetValue_NameCell("PN_4", sql.value("vs_issue"));     
  ObjPrint.SetValue_NameCell("PN_5", sql.value("vs_repayment")); 
  ObjPrint.SetValue_NameCell("PN_6", sql.value("veksel_acctrn"));

  //-------------------------------------------------------------------------------------------------
  // AddRow("Срочный рынок (собственные сделки)", "", true);
  ObjPrint.SetValue_NameCell("FM_1", sql.value("forts_deals"));   
  ObjPrint.SetValue_NameCell("FM_2", sql.value("open_positions"));
  ObjPrint.SetValue_NameCell("FM_3", sql.value("forts_acctrn"));  

  //-------------------------------------------------------------------------------------------------
  // AddRow("Брокерские операции", "", true);
  ObjPrint.SetValue_NameCell("BO_1",  sql.value("brok_new_clients"));   
  ObjPrint.SetValue_NameCell("BO_2",  sql.value("brok_closed_clients"));
  ObjPrint.SetValue_NameCell("BO_3",  sql.value("brok_clients"));       
  ObjPrint.SetValue_NameCell("BO_4",  sql.value("brok_contr_new"));     
  ObjPrint.SetValue_NameCell("BO_5",  sql.value("brok_contr_closed"));  
  ObjPrint.SetValue_NameCell("BO_6",  sql.value("brok_contracts"));     
  ObjPrint.SetValue_NameCell("BO_7",  sql.value("brok_reports"));       
  ObjPrint.SetValue_NameCell("BO_8",  sql.value("brok_exchange"));      
  ObjPrint.SetValue_NameCell("BO_9",  sql.value("brok_nonexchange"));   
  ObjPrint.SetValue_NameCell("BO_10", sql.value("brok_out"));           
  ObjPrint.SetValue_NameCell("BO_11", sql.value("brok_acctrn"));        

  EndAction();
 
//  ObjPrint.RenameSheet( filename );

  ObjPrint.CopyAllSheetInTotalBook(); // кидаем закладку в книгу
  ObjPrint.Close(FALSE);

  ObjPrint.SaveTotalBook(filename+".xls");
//  ObjPrint.SaveTotalBook("Operation_statistics.xls");
  
  WriteFiscLog( OLfinproc , "Окончание выпуска отчета Статистика операций в СОФР");

onerror()
  EndAction();
End;

Rep_OperationStatistics();
exit(1);
