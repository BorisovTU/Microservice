/*
$Name:        rep_for_reconsilation.mac
$Module:      
$Description: Отчет по сделкам с ЦБ в СОФР для целей реконсиляции
$Programmer:  Котов C.
*/
import rep_for_reconsilation_panel, ReportUser;
import captureoutput;


PRIVATE CLASS (TX_ReportUser) rep_for_reconsilation_Report
  var m_BeginDate, /*SVE 27.05.2020 ошибка переопределения m_EndDate*/ EndDate, m_ClientID;

  /*Создание отчета*/
  PRIVATE MACRO Create()

    /*Счет по маске*/
    macro AccountMask(acc)
      if(strlen(acc) <= 1)
        return "-";
      elif(strlen(acc) != 20)
        return acc;
      else
        return substr(acc,1,5) + "-" + substr(acc,6,3) + "-" + substr(acc,9,1) + "-" + substr(acc,10,4) + "-" + substr(acc,14);
      end;
    end;

    /*Балансовый счет*/
    macro AccountBal(acc)
      if(strlen(acc) < 5)
        return "-";
      else
        return substr(acc,1,5);
      end;
    end;

    /*Валюта счета*/
    macro AccountCur(acc)
      if(strlen(acc) < 8)
        return "-";
      else
        return substr(acc,6,3);
      end;
    end;

    /*Разрядность*/
    macro depth(n)
      if(ValType(n)==v_undef)
        return null;
      end;
      var d = 0;
      const num_err = 0.00000001;
      const num_max = 9;
      n = abs(n);
      n = n - int(n+num_err);
      while((n>num_err)and(d<num_max))
        d = d + 1;
        n = n * 10;
        n = n - int(n+num_err);
      end;
      return d;
    end;

/*Точка входа*/
    var cnt=-1;
    var m_cmd;

    /*Отключаем все индикаторы*/
    if(m_UseTemplate)
      m_ObjTemplateXLS.SetFlagShowIndicator(false);
    else
      __BUG_Global_m_ObjTemplateXLS.SetFlagShowIndicator(false);
    end;
    m_ProgressIndicator = CreateProgressIndicator(true);

    /*Даты отчета*/
    m_BeginDate = m_Form.GetFieldValue(PNFLD_COMTRAVR_BEGINDATE);
    //m_EndDate = m_Form.GetFieldValue(PNFLD_COMTRAVR_ENDDATE);   SVE 27.05.2020 ошибка переопределения
    EndDate = m_Form.GetFieldValue(PNFLD_COMTRAVR_ENDDATE);
    m_ClientID = m_Form.GetFieldValue(PNFLD_COMTRAVR_CLIENT_CODE);

    SetActiveSheet("Отчет по сделкам");
    InitProgress(int(1), "Ждите...", "Выборка данных для таблицы \"Отчет по сделкам с ЦБ для целей реконсиляции\"");

    //PrintFormatString("", "reportname", "Отчет по сделкам с ЦБ в СОФР для целей реконсиляции. Период отчета " + string(date(m_BeginDate):f) + " - " + string(date(m_EndDate):f) + """");     SVE 27.05.2020
    PrintFormatString("", "reportname", "Отчет по сделкам с ЦБ в СОФР для целей реконсиляции. Период отчета " + string(date(m_BeginDate):f) + " - " + string(date(EndDate):f) + """");

    RegisterTable( "rep_str", "",
                   "T_DEALCODE",
                   "T_DEALDATE",
                   "T_DEALTYPE",
                   "T_SZNAMEALG",
                   "T_CLIENTID",
                   "T_CLIENTCONTRID",
                   "T_PARTYID",
                   "T_FI_CODE",
                   "T_ISIN",
                   "T_NAME",
                   "T_TAXGROUP",
                   "T_PRINCIPAL",
                   "T_TOTALCOST",
                   "T_CFI",
                   "T_PAYDATE1",
                   "T_PAYDATE2",
                   "T_CHANGEDATE",
                   "T_REJECTDATE",
                   "T_REJECTDATE2",
                   "T_CLOSEDATE",
                   "T_DEALCODETS",
                   "T_DEALID",
                   "T_ISNETTING",
                   "T_DEPARTMENT",
                   "T_SUPPLYDATE",
                   "T_SUPPLYTIME",
                   "T_SUPPLYDATE2",
                   "T_SUPPLYTIME2",
                   "T_OPER",
                   "T_USERFIELD1",
                   "T_USERFIELD2",
                   "T_USERFIELD3",
                   "T_USERFIELD4",
                   "T_COMMENT",
                   "T_AVOIRKIND",
                   "T_ISIN2",
                   "T_NKD",
                   "T_NKDFIID",
                   "T_NKD2",
                   "T_NKDFIID2",
                   "T_COMSUM",
                   "T_PRICE",
                   "T_PAYFIID",
                   "T_PRICE2",
                   "T_PAYFIID2");


      StartCaptureOutput();
      [          SELECT /*+FIRST_ROWS LEADING(t)*/
                        count(1) over() cnt,
                        t.t_dealcode,--Код
                        t.t_dealdate,--Дата
                        RSB_SECUR.GetDealTypeName(t.t_DealType)t_DealType,--Вид
                        namealg.t_szNameAlg,--Статус
                        RSB_SECUR.GetDealClientShortName(decode(t.t_ClientID,-1,?,t.t_ClientID))t_ClientID,--Клиент
                        RSB_SECUR.GetDealSfContrNumber(t.t_ClientContrID)t_ClientContrID,--№ договора
                        RSB_SECUR.GetDealContrShortName(t.t_PartyID)t_PartyID,--Контрагент
                        fininstr.t_FI_Code,--Код ЦБ
                        avoiriss.t_isin,--ISIN
                        fininstr.t_Name,--Наименование
                        avoiriss.t_TaxGroup,--Группа НУ
                        dl_leg.t_Principal,--Кол-во
                        dl_leg.t_TotalCost,--Сумма
                        RSB_SECUR.GetDealFICcy(dl_leg.t_CFI)t_CFI,--Валюта
                        RSB_SECUR.GetDealPayDate1(dl_leg.t_MaturityIsPrincipal,dl_leg.t_Maturity,dl_leg.t_Expiry)t_PayDate1,--Дата опл.
                        RSB_SECUR.GetDealPayDate2(t.t_DealID, 2)t_PayDate2,--Дата опл.2ч
                        t.t_changedate,--Дата изм.
                        dl_leg.t_RejectDate,--Дата отказа
                        RSB_SECUR.GetDealRejectDate2(t.t_DealID, 2)t_RejectDate2,--Дата отк.2ч
                        t.t_closedate,--Дата закр.
                        t.t_dealcodets,--Код внешний
                        t.t_dealid,--ID сделки
                        t.t_isnetting,--Неттинг
                        RSB_SECUR.GetDealDepName(t.t_Department)t_Department,--Филиал
                        RSB_SECUR.GetDealSupplyDate1(dl_leg.t_MaturityIsPrincipal,dl_leg.t_Maturity,dl_leg.t_Expiry)t_SupplyDate,--Дата поставки
                        dl_leg.t_SupplyTime,--Время поставки
                        RSB_SECUR.GetDealSupplyDate2(t.t_DealID, 2)t_SupplyDate2,--Дата поставки 2ч.
                        RSB_SECUR.GetDealSupplyTime2(t.t_DealID, 2)t_SupplyTime2,--Время поставки 2ч
                        RSB_SECUR.GetDealOperName(t.t_Oper)t_Oper,--Исполнитель
                        t.t_userfield1,--ПП1 
                        t.t_userfield2,--ПП2 
                        t.t_userfield3,--ПП3 
                        t.t_userfield4,--ПП4
                        t.t_comment,--Комментарий
                        avoiriss.t_isin t_isin2,-- 1) ISIN (rep3)
                        dl_leg.t_nkd,-- 2) НКД (из сделки)
                        RSB_SECUR.GetDealFICcy(dl_leg.t_nkdfiid)t_nkdfiid,-- 2) НКД (из сделки)
                        dl_leg2.t_nkd t_nkd2,-- 2) НКД (из сделки) ч2
                        RSB_SECUR.GetDealFICcy(dl_leg2.t_nkdfiid)t_nkdfiid2,-- 2) НКД (из сделки) ч2
                        (SELECT sum(t_sum)
                           FROM ddlcomis_dbt c
                          WHERE t_dockind = 101
                            AND t_docid = t.t_dealid
                            AND t_comnumber in (SELECT t_number
                                                  FROM dsfcomiss_dbt t
                                                 WHERE t_feetype = 1
                                                   AND t_code in ('МскБиржКлирНов','МскБиржНов'))) t_comsum, -- 3) комиссия ММВБ (МскБиржКлирНов)
                        cast(nvl(dl_leg.t_price,0) as number(32,12)) t_price,-- 4) Цена
                        RSB_SECUR.GetDealFICcy(dl_leg.t_payfiid)t_payfiid,-- 4) Цена
                        cast(nvl(dl_leg2.t_price,0) as number(32,12)) t_price2,-- 4) Цена ч2
                        RSB_SECUR.GetDealFICcy(dl_leg2.t_payfiid)t_payfiid2,-- 4) Цена ч2
                        (SELECT avrkinds.t_name FROM davrkinds_dbt avrkinds WHERE avrkinds.t_fi_kind = fininstr.t_fi_kind AND avrkinds.t_avoirkind = fininstr.t_avoirkind AND rownum = 1) t_AvoirKind,
                        dl_leg2.t_totalcost t_totalcost2
                         FROM ddl_tick_dbt  t,
                              davoiriss_dbt avoiriss,
                              ddl_leg_dbt   dl_leg,
                              ddl_leg_dbt   dl_leg2,
                              dfininstr_dbt fininstr,
                              dnamealg_dbt  namealg
                        WHERE dl_leg.t_LegKind = 0 AND dl_leg.t_DealID = t.t_DealID AND
                              dl_leg.t_LegID = 0 AND 
                              dl_leg2.t_LegKind(+) = 2 AND dl_leg2.t_DealID(+) = t.t_DealID AND
                              dl_leg2.t_LegID(+) = 0 AND 
                              fininstr.t_FIID = t.t_PFI AND
                              avoiriss.t_FIID = fininstr.t_FIID AND namealg.t_iTypeAlg(+) = 3155 AND
                              namealg.t_iNumberAlg(+) = t.t_DealStatus AND
                              t.t_BOfficeKind in (101,4830)
                          AND t.t_DealDate between ? and ?
                          AND ((-1 = ?) or
                               (decode(t.t_ClientID,-1,?,t.t_ClientID) = ?))
                        ORDER BY t.t_bofficekind,
                                 t.t_dealstatus,
                                 t.t_dealdate,
                                 t.t_dealtime,
                                 t.t_pfi,
                                 t.t_dealid
      ];
      m_cmd = RsdCommand(EndCaptureOutput());
      m_cmd.AddParam("", RSDBP_IN, {OurBank});
      m_cmd.AddParam("", RSDBP_IN, m_BeginDate);
      //m_cmd.AddParam("", RSDBP_IN, m_EndDate);  SVE  27.05.2020
      m_cmd.AddParam("", RSDBP_IN, EndDate);
      m_cmd.AddParam("", RSDBP_IN, m_ClientID);
      m_cmd.AddParam("", RSDBP_IN, {OurBank});
      m_cmd.AddParam("", RSDBP_IN, m_ClientID);

      m_cmd.Execute();
      m_RS = TRsbDataSet(m_cmd);

      var v_LocaleDecimalSeparator = GetLocaleInfo(0,LOCALE_SDECIMAL,(NOT IsStandAlone()));
      var k = 100000;

      while(m_RS.movenext)
          if(cnt==-1)
            RemProgress();
            cnt = m_RS.value("cnt");
            InitProgress(int(cnt), "Ждите...", "Формирование таблицы \"Отчет по сделкам с ЦБ для целей реконсиляции\"");
            cnt = 0;
          end;
          /*Выводим строку отчета*/
          PrintTableLine("T_DEALCODE",      m_RS.value("T_DEALCODE"),         null,
                         "T_DEALDATE",      date(m_RS.value("T_DEALDATE")),   null,
                         "T_DEALTYPE",      m_RS.value("T_DEALTYPE"),         null,
                         "T_SZNAMEALG",     m_RS.value("T_SZNAMEALG"),        null,
                         "T_CLIENTID",      m_RS.value("T_CLIENTID"),         null,
                         "T_CLIENTCONTRID", m_RS.value("T_CLIENTCONTRID"),    null,
                         "T_PARTYID",       m_RS.value("T_PARTYID"),          null,
                         "T_FI_CODE",       m_RS.value("T_FI_CODE"),          null,
                         "T_ISIN",          m_RS.value("T_ISIN"),             null,
                         "T_NAME",          m_RS.value("T_NAME"),             null,
                         "T_TAXGROUP",      m_RS.value("T_TAXGROUP"),         null,
                         "T_PRINCIPAL",     m_RS.value("T_PRINCIPAL"),        null,
                         "T_TOTALCOST",     m_RS.value("T_TOTALCOST"),        null,
                         "T_CFI",           m_RS.value("T_CFI"),              null,
                         "T_PAYDATE1",      date(m_RS.value("T_PAYDATE1")),   null,
                         "T_PAYDATE2",      date(m_RS.value("T_PAYDATE2")),   null,
                         "T_CHANGEDATE",    date(m_RS.value("T_CHANGEDATE")), null,
                         "T_REJECTDATE",    date(m_RS.value("T_REJECTDATE")), null,
                         "T_REJECTDATE2",   date(m_RS.value("T_REJECTDATE2")),null,
                         "T_CLOSEDATE",     date(m_RS.value("T_CLOSEDATE")),  null,
                         "T_DEALCODETS",    m_RS.value("T_DEALCODETS"),       null,
                         "T_DEALID",        m_RS.value("T_DEALID"),           null,
                         "T_ISNETTING",     m_RS.value("T_ISNETTING"),        null,
                         "T_DEPARTMENT",    m_RS.value("T_DEPARTMENT"),       null,
                         "T_SUPPLYDATE",    date(m_RS.value("T_SUPPLYDATE")), null,
                         "T_SUPPLYTIME",    iif(time(m_RS.value("T_SUPPLYTIME"))==time(0,0,0),"",time(m_RS.value("T_SUPPLYTIME"))), null,
                         "T_SUPPLYDATE2",   date(m_RS.value("T_SUPPLYDATE2")),null,
                         "T_SUPPLYTIME2",   iif(time(m_RS.value("T_SUPPLYTIME2"))==time(0,0,0),"",time(m_RS.value("T_SUPPLYTIME2"))), null,
                         "T_OPER",          m_RS.value("T_OPER"),             null,
                         "T_USERFIELD1",    m_RS.value("T_USERFIELD1"),       null,
                         "T_USERFIELD2",    m_RS.value("T_USERFIELD2"),       null,
                         "T_USERFIELD3",    m_RS.value("T_USERFIELD3"),       null,
                         "T_USERFIELD4",    m_RS.value("T_USERFIELD4"),       null,
                         "T_COMMENT",       m_RS.value("T_COMMENT"),          null,
                         "T_AVOIRKIND",     m_RS.value("T_AVOIRKIND"),        null,
                         "T_ISIN2",         m_RS.value("T_ISIN2"),            null,
                         "T_NKD",           m_RS.value("T_NKD"),              null,
                         "T_NKDFIID",       m_RS.value("T_NKDFIID"),          null,
                         "T_NKD2",          m_RS.value("T_NKD2"),             null,
                         "T_NKDFIID2",      m_RS.value("T_NKDFIID2"),         null,
                         "T_COMSUM",        m_RS.value("T_COMSUM"),           null,
                         //"T_PRICE",         m_RS.value("T_PRICE"),            9,//depth(m_RS.value("T_PRICE")),
                         "T_PRICE",         "="+strsubst(string(m_RS.value("T_PRICE")*k),".",v_LocaleDecimalSeparator)+"/"+k,null,
                         "T_PAYFIID",       m_RS.value("T_PAYFIID"),          null,
                         //"T_PRICE2",        m_RS.value("T_PRICE2"),           9,//depth(m_RS.value("T_PRICE2")),
                         "T_PRICE2",        "="+strsubst(string(m_RS.value("T_PRICE2")*k),".",v_LocaleDecimalSeparator)+"/"+k,null,
                         "T_PAYFIID2",      m_RS.value("T_PAYFIID2"),         null,
                         "T_TOTALCOST2",    m_RS.value("T_TOTALCOST2"),       null
                         );

        cnt = cnt + 1;
        UseProgress(cnt);
      end;

    RemProgress();
    InitProgress(int(1), "Ждите...", "Отображение таблицы \"Отчет по сделкам с ЦБ для целей реконсиляции\"");
    EndTable();
    RemProgress();

  END;
 
  initTX_RegistrReport(rep_for_reconsilation_Panel(), "rep_for_reconsilation.xlsx");

END;

/*Точка входа*/
var r = rep_for_reconsilation_Report();
r.InitReport("Отчет по сделкам", null);
r.Run();

exit(1);
