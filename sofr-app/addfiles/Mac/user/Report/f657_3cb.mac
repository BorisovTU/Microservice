/********************************************************************************************
 DESCRIPTION  :   Отчет Ф657_3 РЕПО
 PROGRAMMED BY:   Суворов А.Г.
 CREATION DATE:   
********************************************************************************************/
Import "f657.mac"; //Импорт базового класса
Import "f657_3_data.mac"; //Импорт классов структуры данных (промежуточный сбор данных в структуру для последующей печати)

class (repf657) repf657_3()
    //Применить конструкото родительского класса
    Initrepf657();
MACRO ЧислоCЗаданнойТочностью1(A,B)
  RETURN A;
END;

    //Конструктор 
    //Заголовок таблицы
    tableHeader = header_f657_3;
    //Заголовок окна
    winHeader = "Ф657_3";
    var ReportData;

    //---------------------Главный рекордсет - выборка по которой формируется отчёт----------------------    
    private macro getMainData(repDate)
      var sql = " select docs_main.t_DocID, "+
                "       RSB_SECUR.IsBuy(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick_main.t_DealType, tick_main.t_BofficeKind))) isBuy "+      
                " from "+
                " (select distinct rq.t_DocID"+
                "    from ddlrq_dbt rq, ddl_tick_dbt tick, ddl_leg_dbt leg"+
                "   where  "+
                "      rq.t_Type = :t_Type " +                                                                                                                                                                      
                "      and rq.t_DocID = tick.t_dealid " +
                "      and tick.t_BOfficeKind = rq.t_DocKind " +
                "      and tick.t_BOfficeKind = :t_BOfficeKind " + 
                //"      and tick.t_ClientID = -1 " +
                "      and tick.t_DealDate <= :repDate " +
                "      and leg.t_legkind = :t_legkind " +
                "      and leg.t_dealid = tick.t_dealid " +
                "      and leg.t_legid = 0 " +
                "      and leg.t_OperState >= :t_OperState" +
                "      and RSB_SECUR.IsRepo(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1 "+ /*Фильтр по РЕПО*/
                "      and (select count(1) from v_rqhistex pmrq " + /*для РЕПО проверяем, что не было оплаты либо по 1 либо по 2 части*/
                "                      where pmrq.t_DocID = tick.t_dealid " +
                "                        and pmrq.t_DocKind = tick.t_BOfficeKind " +
                "                        and pmrq.t_Type in (:t_Type2)" +
                "                        and pmrq.t_DealPart in (1,2) " +
                "                        and (pmrq.t_FactDate = to_date('01.01.0001','DD.MM.YYYY') " +
                "                            or pmrq.t_FactDate > :repDate2 )" +
                "                        and pmrq.t_Instance = (select MAX(h1.t_Instance) " +
                "                                                 from v_rqhistex h1 " +
                "                                                 where h1.t_DocID    = pmrq.t_DocID    " +
                "                                                   and h1.t_DocKind  = pmrq.t_DocKind  " +
                "                                                   and h1.t_Type     = pmrq.t_Type     " +
                "                                                   and h1.t_FIID     = pmrq.t_FIID     " +
                "                                                   and h1.t_DealPart = pmrq.t_DealPart " +
                "                                                   and h1.t_Num      = pmrq.t_Num      " +
                "                                                  and h1.t_ChangeDate <= :repDate3 " +
                "                                              )" +
                "                    ) > 0 " +
                " group by rq.t_DocID order by rq.t_DocID) docs_main inner join ddl_tick_dbt tick_main on docs_main.t_DocID = tick_main.t_dealid ";
                  //msgbox(sql);
                  // exit;


      var cmd = rsdCommand(sql);
      cmd.addParam(":t_Type", RSDBP_IN, DLRQ_TYPE_DELIVERY);
      cmd.addParam(":t_BOfficeKind", RSDBP_IN, DL_SECURITYDOC);
      cmd.addParam(":repDate", RSDBP_IN, repDate);
      cmd.addParam(":t_legkind", RSDBP_IN, LEG_KIND_DL_TICK);
      cmd.addParam(":t_OperState", RSDBP_IN, DL_LEG_INITIAL);
      cmd.addParam(":t_Type2", RSDBP_IN, DLRQ_TYPE_PAYMENT);
      cmd.addParam(":repDate2", RSDBP_IN, repDate);
      cmd.addParam(":repDate3", RSDBP_IN, repDate);
      cmd.Execute();
      return rsdRecordSet(cmd);
    end;
    
    /*
      Количество строк отчёта
    */  
    private macro getTheNumberOfRows(repDate)
      var sql = " select count(t_DocID) deal_count from " +
                "(select distinct rq.t_DocID"+
                "    from ddlrq_dbt rq, ddl_tick_dbt tick, ddl_leg_dbt leg"+
                "   where  "+
                "      rq.t_Type = :t_Type " +                                                                                                                                                                      
                "      and rq.t_DocID = tick.t_dealid " +
                "      and tick.t_BOfficeKind = rq.t_DocKind " +
                "      and tick.t_BOfficeKind = :t_BOfficeKind " + 
                //"      and tick.t_ClientID = -1 " +
                "      and tick.t_DealDate <= :repDate " +
                "      and leg.t_legkind = :t_legkind " +
                "      and leg.t_dealid = tick.t_dealid " +
                "      and leg.t_legid = 0 " +
                "      and leg.t_OperState >= :t_OperState" +
                "      and RSB_SECUR.IsRepo(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1 "+ /*Фильтр по РЕПО*/
                "      and (select count(1) from v_rqhistex pmrq " + /*для РЕПО проверяем, что не было оплаты либо по 1 либо по 2 части*/
                "                      where pmrq.t_DocID = tick.t_dealid " +
                "                        and pmrq.t_DocKind = tick.t_BOfficeKind " +
                "                        and pmrq.t_Type in (:t_Type2)" +
                "                        and pmrq.t_DealPart in (1,2) " +
                "                        and (pmrq.t_FactDate = to_date('01.01.0001','DD.MM.YYYY') " +
                "                            or pmrq.t_FactDate > :repDate2 )" +
                "                        and pmrq.t_Instance = (select MAX(h1.t_Instance) " +
                "                                                 from v_rqhistex h1 " +
                "                                                 where h1.t_DocID    = pmrq.t_DocID    " +
                "                                                   and h1.t_DocKind  = pmrq.t_DocKind  " +
                "                                                   and h1.t_Type     = pmrq.t_Type     " +
                "                                                   and h1.t_FIID     = pmrq.t_FIID     " +
                "                                                   and h1.t_DealPart = pmrq.t_DealPart " +
                "                                                   and h1.t_Num      = pmrq.t_Num      " +
                "                                                  and h1.t_ChangeDate <= :repDate3 " +
                "                                              )" +
                "                    ) > 0 " +
                " group by rq.t_DocID order by rq.t_DocID) ";
      var cmd = rsdCommand(sql);
      cmd.addParam(":t_Type", RSDBP_IN, DLRQ_TYPE_DELIVERY);
      cmd.addParam(":t_BOfficeKind", RSDBP_IN, DL_SECURITYDOC);
      cmd.addParam(":repDate", RSDBP_IN, repDate);
      cmd.addParam(":t_legkind", RSDBP_IN, LEG_KIND_DL_TICK);
      cmd.addParam(":t_OperState", RSDBP_IN, DL_LEG_INITIAL);
      cmd.addParam(":t_Type2", RSDBP_IN, DLRQ_TYPE_PAYMENT);
      cmd.addParam(":repDate2", RSDBP_IN, repDate);
      cmd.addParam(":repDate3", RSDBP_IN, repDate);
      cmd.Execute();
      var rs = rsdRecordSet(cmd);


      
      if (rs.MoveNext)
        return int(rs.Value("deal_count"));
      else
        return 0;
      end;
    end;


    /*
        Вернуть строку с номером счёта по переданному массиву категорий
    */
    macro getAccountFromCategoryName(FD, Счет, Currency, Categs)
        var cmd, RS;

        cmd = RSDCommand( " SELECT distinct accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter, categ.t_Code                             " +
                         "   FROM dmcaccdoc_dbt accdoc, dmccateg_dbt categ                                                                  " +
                         "  WHERE accdoc.t_CatID         = categ.t_ID                                                                       " +
                         "    AND accdoc.t_dockind       = ?                                                                                " +
                         "    AND accdoc.t_docid         = ?                                                                                " +
                         "    AND categ.t_LevelType      = 1                                                                                " +
                         "    AND categ.t_Code           in(?, ?)                                                                     "/* +
                         "    AND rsb_account.restall(accdoc.t_account, accdoc.t_chapter, accdoc.t_Currency, to_date(?, 'dd.mm.yyyy')) <> 0 " */);

        cmd.addParam( "", RSDBP_IN, DL_SECURLEG      );
        cmd.addParam( "", RSDBP_IN, FD.dl_leg.rec.ID );
        cmd.addParam( "", RSDBP_IN, Categs[0]        );
        cmd.addParam( "", RSDBP_IN, Categs[1]        );
        /*cmd.addParam( "", RSDBP_IN, Data.RepDate     );*/
        cmd.execute();

        RS = TRsbDataSet( cmd );
        while( RS.MoveNext() )
          if(GetAccount( RS.Chapter, RS.Currency, RS.Account, Счет, true ))
             SetParm(2, Счет);
             SetParm(3, RS.Currency);
             return true;
          end;
        end;

        SetParm(2, "");
        SetParm(3, "");
        return false;

    end;

    /*
        Если входной параметр DealType = "Обратное" и мы передаём в качестве параметра DealID сделки типа "Обратное РЕПО", то 
        метод возвращает DealID сделки "Прямого РЕПО", первая часть которой продана из первой части сделки обратного репо, за дату.
        

        Если входной параметр DealType = "Прямое" и мы передаём в качестве параметра DealID сделки типа "Прямое РЕПО", то 
        Возвращает DealID Сделки  "Обратное РЕПО", по первой части которой была продана первая часть сделки прямого репо, за дату
        
    */
    macro getRelatedDealIDRepoINRepo(DealID, DealType)
    
      var sql = "   SELECT s.t_dealid                                                                                                   " +
                "     FROM dpmwrtsum_dbt s,                                                                                             " + /*Лот ц/б*/
                "          dpmwrtsum_dbt b,                                                                                             " + /*Лот ц/б*/
                "          dpmwrtlnk_dbt k,                                                                                             " + /*Связь списания лотов*/
                "          ddl_tick_dbt t,                                                                                              " + /*Паспорт сделки*/
                "          ddl_leg_dbt l,                                                                                               " + /*Транши сделки*/
                "          davoiriss_dbt a                                                                                              " + /*Ценная бумага*/
                "    WHERE     s.t_sumid IN (  SELECT t_sumid                                                                           " +
                "                                FROM (SELECT w.t_sumid, w.t_changedate                                                 " +
                "                                        FROM dpmwrtbc_dbt w                                                            " +
                "                                       WHERE     w.t_portfolio = :t_portfolio1                                         " +
                "                                             AND (SELECT b.t_portfolio                                                 " +
                "                                                    FROM dpmwrtbc_dbt b                                                " +
                "                                                   WHERE b.t_sumid = w.t_sumid AND b.t_changedate = w.t_changedate     " +
                "                                                         AND b.t_instance =                                            " +
                "                                                                (SELECT MAX (m.t_instance)                             " +
                "                                                                   FROM dpmwrtbc_dbt m                                 " +
                "                                                                  WHERE m.t_changedate <= :repdate1                    " +
                "                                                                        AND m.t_sumid = b.t_sumid)) = :t_portfolio2    " + 
                "                                             AND NOT EXISTS                                                            " +
                "                                                    (SELECT *                                                          " +
                "                                                       FROM dpmwrtsum_dbt e                                            " +
                "                                                      WHERE e.t_sumid = w.t_sumid AND e.t_changedate <= :t_changedate1) " + 
                "                                      UNION ALL                                                                        " +
                "                                      SELECT w.t_sumid, w.t_changedate                                                 " +
                "                                        FROM dpmwrtsum_dbt w                                                           " +
                "                                       WHERE w.t_portfolio = :t_portfolio3 AND w.t_changedate <= :t_changedate2)       " +
                "                            GROUP BY t_sumid)                                                                          " +
                "          AND k.t_saleid = s.t_parent                                                                                  " +
                "          AND k.t_createdate <= :t_createdate                                                                          " +
                "          AND b.t_sumid = k.t_buyid                                                                                    " +
                "          AND b.t_buy_sale = :t_buy_sale                                                                               " +
                "          AND t.t_dealid = s.t_dealid                                                                                  " +
                "          AND l.t_dealid = s.t_dealid                                                                                  " +
                "          AND l.t_legkind = 0                                                                                          " +
                "          AND a.t_fiid = t.t_pfi                                                                                       ";

                /*Определяем что ищем прямое по обратному или наоборот*/
                if(DealType == "Обратное")
                  sql = sql + " AND b.t_dealid =  :t_dealid ";
                elif(DealType == "Прямое")
                  sql = sql + " AND s.t_dealid =  :t_dealid ";
                else
                  RunError("Не вернгое значание параметра =" + DealType + " ожидается --Прямое-- или --Обратное--");
                end;

                /*Сортировка*/

                sql = sql + " ORDER BY s.t_dealcode ";

                  // setoutput("..\\657_3.txt");   
                  // println(KINDPORT_BASICDEBT);
                  // println(RepDate);
                  // println(KINDPORT_BASICDEBT);
                  // println(RepDate);
                  // println(KINDPORT_BASICDEBT);
                  // println(RepDate);
                  // println(FD.tick.rec.DealID);
                  // println(RepDate);
                  // println(PM_WRITEOFF_SUM_BUY_BO);
                  // println(sql);

                var cmd = rsdCommand(sql);
                cmd.addParam(":t_portfolio1", RSDBP_IN, KINDPORT_BASICDEBT);
                cmd.addParam(":repdate1", RSDBP_IN, RepDate);
                cmd.addParam(":t_portfolio2", RSDBP_IN, KINDPORT_BASICDEBT);
                cmd.addParam(":t_changedate1", RSDBP_IN, RepDate);
                cmd.addParam(":t_portfolio3", RSDBP_IN, KINDPORT_BASICDEBT);
                cmd.addParam(":t_changedate2", RSDBP_IN, RepDate);
                cmd.addParam(":t_createdate", RSDBP_IN, RepDate);
                cmd.addParam(":t_buy_sale", RSDBP_IN, PM_WRITEOFF_SUM_BUY_BO);
                cmd.addParam(":t_dealid", RSDBP_IN, DealID);
                cmd.Execute();
                var rs = rsdRecordSet(cmd);
                if (rs.MoveNext)
                  return int(rs.Value(0));
                else
                  return 0;
                end;

    end;

    //---------------------секция методов для получения данных для полей отчёта----------------------    
    
    //Номер сделки
    private macro getDataForColumn_01 (FD)
        return FD.tick.rec.dealcode;
    End;

    //Тип сделки 1 (прямое РЕПО / обратное РЕПО)
    private macro getDataForColumn_02 (FD)
       if (IsBUY(FD.Group))
         return "Обратное РЕПО";
       else
         return "Прямое РЕПО";
       end;
    End;

    //Тип сделки 2 (биржевая / внебиржевая)
    private macro getDataForColumn_03 (FD)
       if (IsEXCHANGE(GetOpGroup(FD.tick.rec)))
         return "биржевая";
       else
         return "внебиржевая";
       end;
    End;

    //Тип сделки 3 ("РЕПО в РЕПО": да/нет)
    private macro getDataForColumn_04 (FD, RelatedDealID)
       if ( IsBUY(FD.Group) )
         return "Нет";
       else
          if(RelatedDealID > 0)
            return "Да";
          else
            return "Нет";
          end;
       end;
    End;

    //Контрагент по сделке
    private macro getDataForColumn_05 (FD)
      var PartyID;
      if (FD.tick.rec.PartyID != -1) 
        PartyID = FD.tick.rec.PartyID;
      elif (IsEXCHANGE(GetOpGroup(FD.tick.rec)))
        PartyID = FD.tick.rec.MarketID;
      elif (IsBROKER(GetOpGroup(FD.tick.rec)))
        PartyID = FD.tick.rec.BrokerID;
      end;

      if (PartyID != -1)
        return GetPartyFullNameByID( PartyID, false, false );
      else
        return "";
      end;
    End;

    //Рейтинг контрагента (Выше "В" / нет)
    private macro getDataForColumn_06 (FD)
      return "----";
    End;

    //Рейтинг контрагента в соответствии с  Указанием 3453-У
    private macro getDataForColumn_07 (FD)
      return "----";
    End;

    //Страна контрагента
    private macro getDataForColumn_08 (FD)
       return getIssuerCountry(FD.tick.rec.PartyID);
    End;

    //Дата заключения сделки
    private macro getDataForColumn_09 (FD)
       return FD.tick.rec.dealdate;
    End;    

    //Дата исполнения по первой части сделки
    private macro getDataForColumn_10 (FD)
      return FD.dl_leg.rec.maturity;
    End;

    //Дата исполнения по второй части сделки
    private macro getDataForColumn_11 (FD)
      return FD.dl_leg.rec.maturity;
    End;

    //Наличие в соглашении по сделке условия ликвидационного неттинга (ДА/НЕТ)
    private macro getDataForColumn_12 (FD)
      return IIF(isEstimatedNetting(FD.tick.rec.GenAgrID),"ДА", "НЕТ");
    End;

    //Наличие в соглашении по сделке условия расчетного неттинга (ДА/НЕТ)
    private macro getDataForColumn_13 (FD)
      return IIF(isDestroyNetting(FD.tick.rec.GenAgrID),"ДА", "НЕТ");
    End;

    //Номер Соглашения по неттингу
    private macro getDataForColumn_14 (FD)
       var AgreementNumber = getAgreementNumber(FD.tick.rec.GenAgrID);
       return IIF( AgreementNumber != "",AgreementNumber, "----");
    End;

    //Сделка зарегистрирована в репозитарии (ДА/НЕТ)
    private macro getDataForColumn_15 (FD)
      return "НЕТ";
    End;

    //Лицевой счет по учету ценных бумаг
    private macro getDataForColumn_16 (AccountForAssetsBuff)
      if (AccountForAssetsBuff != "----")
        return string(AccountForAssetsBuff.rec.account);
      else
        return AccountForAssetsBuff;
      end;
    End;

    //"Валюта лицевого счета по учету ЦБ" 
    private macro getDataForColumn_17 (CurrencyOfAccountForAssets)
      return CurrencyOfAccountForAssets;
    End;

    //Наименование выпуска ценных бумаг
    private macro getDataForColumn_18 (FD)
      //return data.Value("NumberOfIssue");
      return FD.fininstr.rec.name + " Выпуск №" + FD.avoiriss.rec.issue;
    End;

    //ISIN
    private macro getDataForColumn_19 (FD)
      return FD.avoiriss.rec.isin;
    End;

    //Тип ценной бумаги
    private macro getDataForColumn_20 (FD)
      return getAvoirKind(FD);
    End;

    //Эмитент
    private macro getDataForColumn_21 (FD)
       return getIssuer (FD);
    End;

    //ФО/НФО
    private macro getDataForColumn_22 (FD)
      var PartyID;
        if (FD.tick.rec.PartyID != -1) 
          PartyID = FD.tick.rec.PartyID;
        elif (IsEXCHANGE(GetOpGroup(FD.tick.rec)))
          PartyID = FD.tick.rec.MarketID;
        elif (IsBROKER(GetOpGroup(FD.tick.rec)))
          PartyID = FD.tick.rec.BrokerID;
        end;
        if (PartyID != -1)
          return getNFO(PartyID);
        else
          return "";
        end;    
       
    End;

    //Страна эмитента
    private macro getDataForColumn_23 (FD)
       return getIssuerCountry(FD.fininstr.rec.ISSUER);
    End;

    //Страновая оценка
    private macro getDataForColumn_24 (FD)
      return getRatingCountry (FD.fininstr.rec.ISSUER);
    End;

    //SPV
    private macro getDataForColumn_25 (FD)
      return getSPV(FD.fininstr.rec.ISSUER);
    End;

    //Ипотечное покрытие (да/нет) 
    private macro getDataForColumn_26 (FD)
      return getMortgageCoverage(FD.fininstr.rec.fiid);
    End;

    //Рейтинг Эмитента (Standart&Poors)
    private macro getDataForColumn_27 (FD)
      return getRatingIssuer(FD.fininstr.rec.issuer, "S\&P", repDate);
    End;

    //Рейтинг эмиссии (Standart&Poors)
    private macro getDataForColumn_28 (FD)
      return getRatingSec(FD.fininstr.rec.fiid, "S\&P", repDate);
    End;

    //Рейтинг Эмитента в соответствии с  Указанием 3453-У (Standart&Poors)
    private macro getDataForColumn_29 (FD)
      return "----";
    End;

    //Рейтинг эмиссии в соответствии с  Указанием 3453-У (Standart&Poors)
    private macro getDataForColumn_30 (FD)
      return "----";
    End;

    //Рейтинг Эмитента (Moodys )
    private macro getDataForColumn_31 (FD)
      return getRatingIssuer(FD.fininstr.rec.issuer, "Moody", repDate);
    End;

    //Рейтинг эмиссии (Moodys)
    private macro getDataForColumn_32 (FD)
      return getRatingSec(FD.fininstr.rec.fiid, "Moody", repDate);
    End;

    //Рейтинг Эмитента в соответствии с  Указанием 3453-У (Moodys )
    private macro getDataForColumn_33 (FD)
      return "----";
    End;

    //Рейтинг эмиссии в соответствии с  Указанием 3453-У (Moodys )
    private macro getDataForColumn_34 (FD)
      return "----";
    End;

    //Рейтинг Эмитента (Fitch Ratings)
    private macro getDataForColumn_35 (FD)
      return getRatingIssuer(FD.fininstr.rec.issuer, "Fitch IBC", repDate);
    End;

    //Рейтинг эмиссии (Fitch Ratings)
    private macro getDataForColumn_36 (FD)
       return getRatingSec(FD.fininstr.rec.fiid, "Fitch IBC", repDate);
    End;

    //Рейтинг Эмитента в соответствии с  Указанием 3453-У (Fitch Ratings)
    private macro getDataForColumn_37 (FD)
      return "----";
    End;

    //Рейтинг эмиссии в соответствии с  Указанием 3453-У (Fitch Ratings)
    private macro getDataForColumn_38 (FD)
      return "----";
    End;

    //Дата начала размещения ЦБ
    private macro getDataForColumn_39 (FD)
      if(FD.avoiriss.rec.begplacementdate == "")
        return "----";
      else 
        return FD.avoiriss.rec.begplacementdate;
      end;
    End;

    //Количество ценных бумаг (шт.)
    /*
      Параметры:
        DealHasExtraString - Признак что сделку нужно отображать двумя строчками
                      суммыи количество будут разделены на две части
                      1 часть = Сумма "Обратного Репо" - Сумма "Репо в Репо"
                      2 часть = Сумма "Репо в Репо"
        ThisIsExtraString - Признак что текущая строка для вставки является дополнительной                              
        DealChange - структура по основной строке сделки
        RelatedDealChange - структура по связной строке сделки
    */
    private macro getDataForColumn_40(DealHasExtraString, ThisIsExtraString, DealChange, RelatedDealChange)
      // return FD.Principal(RepDate);
      if(DealHasExtraString) 
        if (NOT ThisIsExtraString)/*Это не дополнительная строка*/
          return DealChange.rec.OldPrincipal - RelatedDealChange.rec.OldPrincipal;
        else
          return RelatedDealChange.rec.OldPrincipal;
        end;
      else
          return DealChange.rec.OldPrincipal;
      end;
    End;

    //Балансовая стоимость ценных бумаг 
    /*
        Параметры:
        DealHasExtraString - Признак что сделку нужно отображать двумя строчками
                              суммы и количество будут разделены на две части
                              1 часть = Сумма "Обратного Репо" - Сумма "Репо в Репо"
                              2 часть = Сумма "Репо в Репо"
        ThisIsExtraString - Признак что текущая строка для вставки является дополнительной                              
        AccountForAssetsBuff - буфер счёта по учёту ценных бумаг
        RelatedAccountForAssetsBuff - буфер счёта по учёту ценных бумаг связная сделка
    */
    private macro getDataForColumn_41(DealHasExtraString, ThisIsExtraString, AccountForAssetsBuff, RelatedAccountForAssetsBuff)
      
      if(DealHasExtraString)/*У сделки есть связная сделка*/
        if (NOT ThisIsExtraString)/*Это не дополнительная строка*/
            return ЧислоCЗаданнойТочностью1(money(getAccountRest(AccountForAssetsBuff)) - money(getAccountRest(RelatedAccountForAssetsBuff)));
        else
            return ЧислоCЗаданнойТочностью1(money(getAccountRest(RelatedAccountForAssetsBuff)),2);
        end;
      else
        return ЧислоCЗаданнойТочностью1(money(getAccountRest(AccountForAssetsBuff)),2);
      end;
      
    End;

    //Переоценка ценных бумаг 
    private macro getDataForColumn_42(FD)
      return FD.rec.OverAmount;
    End;    

    //ТСС
    private macro getDataForColumn_43(FD)
    var PriceRUR, PriceCUR;
      GetRateInfo(FD, SP_RATETYPE_RightCost, @PriceRUR, @PriceCUR, ExistNOSS(FD.avoiriss, RepDate));
      return ЧислоCЗаданнойТочностью1(money(PriceRUR),4);
    End;

    //Лицевой счет по учету денежных средств
    private macro getDataForColumn_44(AccountForMoneyBuff)
      if (AccountForMoneyBuff != "----")
        return string(AccountForMoneyBuff.rec.account);
      else
        return AccountForMoneyBuff;
      end;
    End;

    //Валюта лицевого счета по учету денежных средств
    private macro getDataForColumn_45(CurrencyOfAccountForMoney)
      return CurrencyOfAccountForMoney;
    End;

    //Сумма денежных средств
    /*
        Параметры:
        DealHasExtraString - Признак что сделку нужно отображать двумя строчками
                              суммы и количество будут разделены на две части
                              1 часть = Сумма "Обратного Репо" - Сумма "Репо в Репо"
                              2 часть = Сумма "Репо в Репо"
        ThisIsExtraString - Признак что текущая строка для вставки является дополнительной                              
        AccountForMoneyBuff - буфер счёта по учёту денежных средств
        RelatedAccountForMoneyBuff - буфер счёта по учёту денежных средств связной сделки
    */
    private macro getDataForColumn_46(DealHasExtraString, ThisIsExtraString, AccountForMoneyBuff, RelatedAccountForMoneyBuff)
      if(DealHasExtraString)
        if (NOT ThisIsExtraString)/*Это не дополнительная строка*/
          return ЧислоCЗаданнойТочностью1(money(getAccountRest(AccountForMoneyBuff)) - money(getAccountRest(RelatedAccountForMoneyBuff)));
        else
          return ЧислоCЗаданнойТочностью1(money(getAccountRest(RelatedAccountForMoneyBuff)),2);
        end;
      else
        return ЧислоCЗаданнойТочностью1(money(getAccountRest(AccountForMoneyBuff)),2);
      end;
    End;

    //Лицевой счет по учету начисленных процентов по размещенным (привлеченным) средствам
    private macro getDataForColumn_47(AccountForPercentBuff)
      if (AccountForPercentBuff != "----")
        return string(AccountForPercentBuff.rec.account);
      else
        return AccountForPercentBuff;
      end;
    End;

    //
    private macro getDataForColumn_48(DealHasExtraString, ThisIsExtraString, AccountForPercentBuff, RelatedAccountForPercentBuff)
      if(DealHasExtraString)
        if (NOT ThisIsExtraString)/*Это не дополнительная строка*/
          return ЧислоCЗаданнойТочностью1(money(getAccountRest(AccountForPercentBuff)) - money(getAccountRest(RelatedAccountForPercentBuff)));
        else
          return ЧислоCЗаданнойТочностью1(money(getAccountRest(RelatedAccountForPercentBuff)),2);
        end;
      else
        return ЧислоCЗаданнойТочностью1(money(getAccountRest(AccountForPercentBuff)),2);
      end;
    End;

    //
    private macro getDataForColumn_49(FD)
      return "----";
    End;

    //
    private macro getDataForColumn_50(FD)
      return "----";
    End;

    //
    private macro getDataForColumn_51(FD)
      return "----";
    End;

    //
    private macro getDataForColumn_52(FD)
      return "----";
    End;

    //
    private macro getDataForColumn_53(FD)
      return "----";
    End;

    macro getIncRateOnDate(FD)
        var cmd, RS;

        cmd = RSDCommand( " SELECT RSB_SECUR.GetIncRateOnDate(?, ?, ?) IncomeRate from dual");

        cmd.addParam( "", RSDBP_IN, FD.tick.rec.DealID);
        cmd.addParam( "", RSDBP_IN, FD.tick.rec.BOfficeKind);
        cmd.addParam( "", RSDBP_IN, repDate);
        cmd.execute();

        RS = TRsbDataSet( cmd );
        if( RS.MoveNext() )
          return RS.IncomeRate;
        end;

        return 0;
    end;

    //Процентная ставка
    private macro getDataForColumn_54(FD, FD2)
      return IIF(FD2.dl_leg.rec.IsFlRate == SET_CHAR, getIncRateOnDate(FD),  FD.dl_leg.rec.IncomeRate);
    End;

    //
    private macro getDataForColumn_55(FD)
      return "----";
    End;

    //
    private macro getDataForColumn_56(FD)
      return "----";
    End;

    macro getExtraDataFromTmp ( PortfID,
                                Account,
                                FIID,
                                IsQuoted)

          var sql = "select tmp.* " +
                    "  from f657tmpTable tmp " +
                    " where  " +
                    "  t_account = :t_account " +
                    "  and t_portfid = :t_portfid " +
                    "  and t_fiid = :t_fiid " +
                    "  and t_isquoted = :t_isquoted " +
                    "  and rownum = 1";

          var cmd = rsdCommand(sql);
          cmd.addParam(":t_account", RSDBP_IN, Account);
          cmd.addParam(":t_portfid", RSDBP_IN, PortfID);
          cmd.addParam(":t_fiid", RSDBP_IN, FIID);
          cmd.addParam(":t_isquoted", RSDBP_IN, IsQuoted);
          
          cmd.Execute();
            return rsdRecordSet(cmd);
          OnError 
            return false;
    End;

    /*
      Заполняет буферы счетов и валюты
      FD - первичный документ сделки (один транш)
      AccountForAssetsBuff - сюда возвращаем буфер счёта по учёту ценных бумаг
      CurrencyOfAccountForAssets - сюда возвращаем валюту счёта по учёту ценных бумаг

      AccountForMoneyBuff - сюда возвращаем буфер счёта по учету денежных средств
      CurrencyOfAccountForMoney - сюда возвращаем валюту по учету денежных средств
    */
    macro getAcountsAndCurrencies (FD, 
                                  AccountForAssetsBuff, 
                                  CurrencyOfAccountForAssets, 
                                  AccountForMoneyBuff, 
                                  CurrencyOfAccountForMoney,
                                  AccountForPercentBuff,
                                  FD2
                                  )
        /*----------------------Получить счета и валюты основная строка--------------------------------*/
      var Categs = TArray(); /*список категорий счетов для проверки*/          
      var Currency = -1;
      file fininstr (fininstr) key 0;
        //Лицевой счет по учету ценных бумаг
        //Получаем счёт по следующим категориям:
        //"Ц/б, ПВО"
        //"Ц/б, ПВО_БПП" -- предположительно "Репо в Репо"
        //"Ц/б, ПВО_БПП, Корзина"
        //Ищем методом из отчёта outblrep.mac  ПолучитьЛицевойСчетРЕПО(FD, Счет)
        Categs[0] = "Ц/б, ПВО";
        Categs[1] = IIF(FD.НуженСчетКорзина(), "Ц/б, ПВО_БПП, Корзина", "Ц/б, ПВО_БПП");

        if( getAccountFromCategoryName(FD, AccountForAssetsBuff, Currency, Categs) )
          /*Ищем код валюты счёта*/
          ClearRecord(fininstr);
          fininstr.FIID = Currency;
          if (GETEQ(fininstr))
            CurrencyOfAccountForAssets = fininstr.Ccy;//"Валюта лицевого счета по учету ЦБ" 
          else
            CurrencyOfAccountForAssets = "----"; 
          end;
          SetParm(2,AccountForAssetsBuff);
          SetParm(3,CurrencyOfAccountForAssets);
        else
           SetParm(2,"----");
           SetParm(3,"----"); 
        end;

        //Лицевой счет по учету денежных средств
        //Получаем счёт по следующим категориям:
        //"+ОД"
        //"-ОД"
        //"+ОД, Корзина"
        //"-ОД, Корзина"
        Categs = TArray();
        Categs[0] = IIF(FD.НуженСчетКорзина(), "+ОД, Корзина", "+ОД");/*"+ОД, Корзина" для конкретной ц\б надо искать!!*/
        Categs[1] = IIF(FD.НуженСчетКорзина(), "-ОД, Корзина", "-ОД");/*"-ОД, Корзина" для конкретной ц\б надо искать!!*/

        if( getAccountFromCategoryName(FD, AccountForMoneyBuff, Currency, Categs) )
            /*Ищем код валюты счёта*/
            ClearRecord(fininstr);
            fininstr.FIID = Currency;
            if (GETEQ(fininstr))
              CurrencyOfAccountForMoney = fininstr.Ccy;//"Валюта счета по учету денежных средств
            else
              CurrencyOfAccountForMoney = "----"; 
            end;
            SetParm(4,AccountForMoneyBuff);
            SetParm(5,CurrencyOfAccountForMoney);
        else
            SetParm(4,"----");
            SetParm(5,"----");
        end;

        //Лицевой счет по учету денежных средств
        //Получаем счёт по следующим категориям:
        //"+ОД"
        //"-ОД"
        //"+ОД, Корзина"
        //"-ОД, Корзина"
        Categs = TArray();
        Categs[0] = IIF(FD.НуженСчетКорзина(), "+ОД, Корзина", "+ОД");/*"+ОД, Корзина" для конкретной ц\б надо искать!!*/
        Categs[1] = IIF(FD.НуженСчетКорзина(), "-ОД, Корзина", "-ОД");/*"-ОД, Корзина" для конкретной ц\б надо искать!!*/

        if( getAccountFromCategoryName(FD, AccountForMoneyBuff, Currency, Categs) )
            /*Ищем код валюты счёта*/
            ClearRecord(fininstr);
            fininstr.FIID = Currency;
            if (GETEQ(fininstr))
              CurrencyOfAccountForMoney = fininstr.Ccy;//"Валюта счета по учету денежных средств
            else
              CurrencyOfAccountForMoney = "----"; 
            end;
            SetParm(4,AccountForMoneyBuff);
            SetParm(5,CurrencyOfAccountForMoney);
        else
            SetParm(4,"----");
            SetParm(5,"----");
        end;        

        //Лицевой счет по учету начисленных процентов по размещенным (привлеченным) средствам
        //"+% к погашению"
        //"-% к погашению"
        Categs = TArray();
        var IncomeRate = IIF(FD2.dl_leg.rec.IsFlRate == SET_CHAR, getIncRateOnDate(FD),  FD.dl_leg.rec.IncomeRate);
        if (IsBUY(FD.Group)) /*Обратное РЕПО*/
          if (IncomeRate > 0)
             Categs[0]  = "+% к погашению";
          else
             Categs[0] = "-% к погашению";
          end;
        else
          if (IncomeRate > 0)
             Categs[0] = "-% к погашению";
          else
             Categs[0] = "+% к погашению";
          end;
        end;


        if( getAccountFromCategoryName(FD, AccountForPercentBuff, Currency, Categs) )
            SetParm(6,AccountForPercentBuff);
        else
            SetParm(6,"----");
        end;                

        /*-----------------------------------------------------------------------------*/          
          
       End;   
    //------------------------------------------------------------------------------
    /*
        Вставить строку в массив (данные для печати)
        Параметры:
        DealID - ИД сделки на которой стоим в основном цикле
        RelatedDealID - DealID связной сделки если есть. 
                        В случае если MainDealDerection = "Обратное", то здесь 
                        RelatedDealID будет DealID сделки "РЕПО в РЕПО"
        DealHasExtraString - Признак что сделку нужно отображать двумя строчками
                              суммы и количество будут разделены на две части
                              1 часть = Сумма "Обратного Репо" - Сумма "Репо в Репо"
                              2 часть = Сумма "Репо в Репо"
        ThisIsExtraString - Признак что текущая строка для вставки я вляется дополнительной                              
    */
    macro SaveLine (DealID, RelatedDealID, DealHasExtraString, ThisIsExtraString);
      var FD_first_part, //Первая часть сделки (класс - первичные документы для работы с категориями учета в сделках)
          FD_second_part; //Вторая часть сделки (класс - первичные документы для работы с категориями учета в сделках)
      
      var FD_first_part_related, /*Первая часть связной сделки*/
          FD_second_part_related; /*Вторая часть связной сделки*/

          /*для определения счетов и валют*/

      var AccountForAssetsBuff = TRecHandler( "account" ); //Лицевой счет по учету ценных бумаг
      var AccountForMoneyBuff = TRecHandler( "account" ); //Счёт учёта денежных средств
      var AccountForPercentBuff = TRecHandler( "account" ); //Лицевой счет по учету начисленных процентов по размещенным (привлеченным) средствам
      
      var RelatedAccountForAssetsBuff = TRecHandler( "account" ); //Связная сделка: Лицевой счет по учету ценных бумаг
      var RelatedAccountForMoneyBuff = TRecHandler( "account" ); //Связная сделка: Счёт учёта денежных средств
      var RelatedAccountForPercentBuff = TRecHandler( "account" ); //Связная сделка: Лицевой счет по учету начисленных процентов по размещенным (привлеченным) средствам


      var CurrencyOfAccountForAssets;
      var CurrencyOfAccountForMoney;

      var RelatedCurrencyOfAccountForAssets;
      var RelatedCurrencyOfAccountForMoney;

        /*Получить FD для Основной строки*/
        Deal.Clear();                            
        Deal.rec.DealID = DealID;
        
        if( Deal.GetEQ() )
          //Первый транш (часть) сделки
          FD_first_part = SPFirstDoc( Deal, LEG_KIND_DL_TICK );
          FD_first_part.SetCurPFI(FD_first_part.tick.rec.PFI);

          //Второй транш (часть) сделки
          FD_second_part = SPFirstDoc( LEG_KIND_DL_TICK_BACK, Deal.rec.DealID );
          FD_second_part.SetCurPFI(FD_second_part.tick.rec.PFI);

          //Заполнить структуру изменений условий по сделке
          DealChange.Clear();
          SP_GetDealParmsByDate(FD_first_part.tick, RepDate, DealChange, false, false);
          /*Получить счета и валюты*/
          getAcountsAndCurrencies (FD_first_part, AccountForAssetsBuff, CurrencyOfAccountForAssets, AccountForMoneyBuff, CurrencyOfAccountForMoney, AccountForPercentBuff, FD_second_part);
        end;


        /*Получить FD связной сделки для дополнительной строки*/
        if(DealHasExtraString) /*Это "Обратное РЕПО" и у этой сделки есть связная сделка "РЕПО в РЕПО"*/
            /*Получаем FD связной сделки*/
            RelatedDeal.Clear();                            
            RelatedDeal.rec.DealID = RelatedDealID;
            
            if( RelatedDeal.GetEQ() ) 
              //Первый транш (часть) сделки
              FD_first_part_related = SPFirstDoc( RelatedDeal, LEG_KIND_DL_TICK );
              FD_first_part_related.SetCurPFI(FD_first_part.tick.rec.PFI);

              //Второй транш (часть) сделки
              FD_second_part_related = SPFirstDoc( LEG_KIND_DL_TICK_BACK, RelatedDeal.rec.DealID );
              FD_second_part_related.SetCurPFI(FD_second_part.tick.rec.PFI);

              //Заполнить структуру изменений условий по сделке
              RelatedDealChange.Clear();
              SP_GetDealParmsByDate(FD_first_part.tick, RepDate, RelatedDealChange, false, false);
              /*Получить счета и валюты*/
              getAcountsAndCurrencies (FD_first_part_related, RelatedAccountForAssetsBuff, RelatedCurrencyOfAccountForAssets, RelatedAccountForMoneyBuff, RelatedCurrencyOfAccountForMoney, RelatedAccountForPercentBuff, FD_second_part);
            end;
        end;      

        /*Добавим строчки в массив*/
        ReportData.AddLine( 
              getDataForColumn_01(FD_first_part),
              getDataForColumn_02(FD_first_part),
              getDataForColumn_03(FD_first_part),
              getDataForColumn_04(FD_first_part, RelatedDealID),
              getDataForColumn_05(FD_first_part),
              getDataForColumn_06(FD_first_part),
              getDataForColumn_07(FD_first_part),
              getDataForColumn_08(FD_first_part),
              getDataForColumn_09(FD_first_part),
              getDataForColumn_10(FD_first_part),
              getDataForColumn_11(FD_second_part),
              getDataForColumn_12(FD_first_part),
              getDataForColumn_13(FD_first_part),
              getDataForColumn_14(FD_first_part),
              getDataForColumn_15(FD_first_part),
              getDataForColumn_16(AccountForAssetsBuff),
              getDataForColumn_17(CurrencyOfAccountForAssets),
              getDataForColumn_18(FD_first_part),
              getDataForColumn_19(FD_first_part),
              getDataForColumn_20(FD_first_part),
              getDataForColumn_21(FD_first_part),
              getDataForColumn_22(FD_first_part),
              getDataForColumn_23(FD_first_part),
              getDataForColumn_24(FD_first_part),
              getDataForColumn_25(FD_first_part),
              getDataForColumn_26(FD_first_part),
              getDataForColumn_27(FD_first_part),
              getDataForColumn_28(FD_first_part),
              getDataForColumn_29(FD_first_part),
              getDataForColumn_30(FD_first_part),
              getDataForColumn_31(FD_first_part),
              getDataForColumn_32(FD_first_part),
              getDataForColumn_33(FD_first_part),
              getDataForColumn_34(FD_first_part),
              getDataForColumn_35(FD_first_part),
              getDataForColumn_36(FD_first_part),
              getDataForColumn_37(FD_first_part),
              getDataForColumn_38(FD_first_part),
              getDataForColumn_39(FD_first_part),
              getDataForColumn_40(DealHasExtraString, ThisIsExtraString, DealChange, RelatedDealChange),
              getDataForColumn_41(DealHasExtraString, ThisIsExtraString, AccountForAssetsBuff, RelatedAccountForAssetsBuff),
              getDataForColumn_42(FD_first_part.pmwrtsum),
              getDataForColumn_43(FD_first_part),
              getDataForColumn_44(AccountForMoneyBuff),
              getDataForColumn_45(CurrencyOfAccountForMoney),
              getDataForColumn_46(DealHasExtraString, ThisIsExtraString, AccountForMoneyBuff, RelatedAccountForMoneyBuff),
              getDataForColumn_47(AccountForPercentBuff),
              getDataForColumn_48(DealHasExtraString, ThisIsExtraString, AccountForPercentBuff, RelatedAccountForPercentBuff),
              getDataForColumn_49(FD_first_part),
              getDataForColumn_50(FD_first_part),
              getDataForColumn_51(FD_first_part),
              getDataForColumn_52(FD_first_part),
              getDataForColumn_53(FD_first_part),
              getDataForColumn_54(FD_first_part, FD_second_part),
              getDataForColumn_55(FD_first_part),
              getDataForColumn_56(FD_first_part)
          );        


    End;
    /*Получить данные для печати*/
    macro FillData()
      var i = 0; 
      var data = getMainData(repDate);
      var DealID; /*для идентификатора сделки основная строка*/
      var RelatedDealID = 0;
      var DealHasExtraString = false; /*Признак что сделку нужно отображать двумя строчками
                                        суммыи количество будут разделены на две части
                                        1 часть = Сумма "Обратного Репо" - Сумма "Репо в Репо"
                                        2 часть = Сумма "Репо в Репо"*/
      var ThisIsExtraString = false;/*Признак что текущая строка является дополнительной*/

      /*Создаём экземпляр структуры для хранения промежуточных данных*/
      ReportData = Tf657_3_data_array();

      InitProgress( getTheNumberOfRows(repDate), "Отчет \" Форма 657_3 отчёт по сделкам РЕПО\"", 
                    "Сделки РЕПО" );

      while (data.MoveNext)

          DealID = data.Value("t_DocID"); /*для большей читаемости*/

          if (data.Value("isBuy")) /*проверям является ли текущая сделка "Обратным РЕПО"*/
            /*Параметр DealType = "Обратное" мы передаём в качестве параметра - DealID сделки типа "Обратное РЕПО"
              метод возвращает DealID сделки "Прямого РЕПО", первая часть которой продана из первой части 
              сделки обратного репо, за дату отчёта.*/          
            RelatedDealID = getRelatedDealIDRepoINRepo(DealID, "Обратное"); /*Кладём в переменную DealID связной сделки "Прямое РЕПО"*/

            DealHasExtraString = RelatedDealID > 0;/*Признак что сделку нужно отображать двумя строчками
                                                      суммы и количество будут разделены на две части
                                                      1 часть = Сумма "Обратного Репо" - Сумма "Репо в Репо"
                                                      2 часть = Сумма "Репо в Репо"*/
            if (DealHasExtraString)               
              /*
                Если мы стоим на основной сделки типа "Обратное РЕПО" и по этой сделке 
                есть связная сделка типа "Прямое РЕПО", то добавляем дополнительную строчку
                в которой часть полей вычисляем по основной сделки "Обратное РЕПО" и 
                связной с ней сделки "РЕПО в РЕПО" (Прямое РЕПО)
              */

              /*Основная строка*/
              ThisIsExtraString = false;
              SaveLine (DealID, RelatedDealID, DealHasExtraString, ThisIsExtraString);

              /*Дополнительная строка*/
              ThisIsExtraString = true;
              SaveLine (DealID, RelatedDealID, DealHasExtraString, ThisIsExtraString);
            else
              /*Основная строка*/
              ThisIsExtraString = false;
              SaveLine (DealID, RelatedDealID, DealHasExtraString, ThisIsExtraString);
            end;

          else
            /*Параметр DealType = "Прямое" и мы передаём в качестве параметра - DealID сделки типа "Прямое РЕПО"
            метод возвращает DealID сделки  "Обратное РЕПО", по первой части которой была продана первая часть 
            сделки прямого репо, за дату отчёта*/
            RelatedDealID = getRelatedDealIDRepoINRepo(DealID, "Прямое"); /*Кладём в переменную DealID связной сделки "Обратное РЕПО"*/
            DealHasExtraString = false;
            ThisIsExtraString = false;
            SaveLine (DealID, RelatedDealID, DealHasExtraString, ThisIsExtraString);
          end;        

        // println(dataMain.Value("t_dealcode"));
        
        UseProgress( i = i + 1 );

      end;

   End;

    
    /*Напечатать данные*/
    macro printTable()
      var currCounter = 0;
      /*Заполнить данные*/
      FillData();
      while (currCounter < ReportData.size)
        printCell(ReportData[currCounter].Column_1);  //Номер сделки
        printCell(ReportData[currCounter].Column_2);  //Тип сделки 1 (прямое РЕПО / обратное РЕПО)
        printCell(ReportData[currCounter].Column_3);  //Тип сделки 2 (биржевая / внебиржевая)
        printCell(ReportData[currCounter].Column_4);  //Тип сделки 3 ("РЕПО в РЕПО": да/нет)
        printCell(ReportData[currCounter].Column_5);  //Контрагент по сделке
        printCell(ReportData[currCounter].Column_6);  //Рейтинг контрагента (Выше "В" / нет) -- не может быть информации в БД банка
        printCell(ReportData[currCounter].Column_7);  //Рейтинг контрагента в соответствии с  Указанием 3453-У
        printCell(ReportData[currCounter].Column_8);  //Страна контрагента
        printCell(ReportData[currCounter].Column_9);  //Дата заключения сделки
        printCell(ReportData[currCounter].Column_10); //Дата исполнения по первой части сделки
        printCell(ReportData[currCounter].Column_11); //Дата исполнения по второй части сделки
        printCell(ReportData[currCounter].Column_12); //Наличие в соглашении по сделке условия ликвидационного неттинга (ДА/НЕТ)
        printCell(ReportData[currCounter].Column_13); //Наличие в соглашении по сделке условия расчетного неттинга (ДА/НЕТ)
        printCell(ReportData[currCounter].Column_14); //Номер Соглашения по неттингу
        printCell(ReportData[currCounter].Column_15); //Сделка зарегистрирована в репозитарии (ДА/НЕТ)
        printCell(ReportData[currCounter].Column_16); //Лицевой счет по учету ценных бумаг
        printCell(ReportData[currCounter].Column_17); //"Валюта лицевого счета по учету ЦБ" 
        printCell(ReportData[currCounter].Column_18); //Наименование выпуска ценных бумаг
        printCell(ReportData[currCounter].Column_19); //ISIN
        printCell(ReportData[currCounter].Column_20); //Тип ценной бумаги
        printCell(ReportData[currCounter].Column_21); //Эмитент        
        printCell(ReportData[currCounter].Column_22); //ФО/НФО
        printCell(ReportData[currCounter].Column_23); //Страна эмитента
        printCell(ReportData[currCounter].Column_24); //Страновая оценка
        printCell(ReportData[currCounter].Column_25); //SPV
        printCell(ReportData[currCounter].Column_26); //Ипотечное покрытие (да/нет) 
        printCell(ReportData[currCounter].Column_27); //Рейтинг Эмитента (Standart&Poors)
        printCell(ReportData[currCounter].Column_28); //Рейтинг эмиссии (Standart&Poors)
        printCell(ReportData[currCounter].Column_29); //Рейтинг Эмитента в соответствии с  Указанием 3453-У (Standart&Poors)
        printCell(ReportData[currCounter].Column_30); //Рейтинг эмиссии в соответствии с  Указанием 3453-У (Standart&Poors)
        printCell(ReportData[currCounter].Column_31); //Рейтинг Эмитента (Moodys )
        printCell(ReportData[currCounter].Column_32); //Рейтинг эмиссии (Moodys) 
        printCell(ReportData[currCounter].Column_33); //Рейтинг Эмитента в соответствии с  Указанием 3453-У (Moodys )
        printCell(ReportData[currCounter].Column_34); //Рейтинг эмиссии в соответствии с  Указанием 3453-У (Moodys )
        printCell(ReportData[currCounter].Column_35); //Рейтинг Эмитента (Fitch Ratings)
        printCell(ReportData[currCounter].Column_36); //Рейтинг эмиссии (Fitch Ratings)
        printCell(ReportData[currCounter].Column_37); //Рейтинг Эмитента в соответствии с  Указанием 3453-У (Fitch Ratings)
        printCell(ReportData[currCounter].Column_38); //Рейтинг эмиссии в соответствии с  Указанием 3453-У (Fitch Ratings)
        printCell(ReportData[currCounter].Column_39); //Дата начала размещения ЦБ
        printCell(ReportData[currCounter].Column_40); //Количество ценных бумаг (шт.)
        printCell(ReportData[currCounter].Column_41); //Балансовая стоимость ценных бумаг 
        printCell(ReportData[currCounter].Column_42); //Переоценка ценных бумаг 
        printCell(ReportData[currCounter].Column_43); //ТСС
        printCell(ReportData[currCounter].Column_44); //Лицевой счет по учету денежных средств
        printCell(ReportData[currCounter].Column_45); //Валюта лицевого счета по учету денежных средств
        printCell(ReportData[currCounter].Column_46); //Сумма денежных средств 
        printCell(ReportData[currCounter].Column_47); //Лицевой счет по учету начисленных процентов по размещенным (привлеченным) средствам
        printCell(ReportData[currCounter].Column_48); //Сумма начисленных процентов по размещенным (привлеченным) средствам
        printCell(ReportData[currCounter].Column_49); //
        printCell(ReportData[currCounter].Column_50); //
        printCell(ReportData[currCounter].Column_51); //
        printCell(ReportData[currCounter].Column_52); //
        printCell(ReportData[currCounter].Column_53); //
        printCell(ReportData[currCounter].Column_54); //Процентная ставка
        printCell(ReportData[currCounter].Column_55); //
        printCell(ReportData[currCounter].Column_56); //
        printRow();
        currCounter = currCounter + 1;
      end;
    end;
   

    
end;

var report = repf657_3();
    //Запуск отчёта
    report.Run();
    // exit(1);

