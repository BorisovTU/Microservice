import payminter;
import rsd, RsbDataSet;
import RsbFormsInter;
import captureoutput;
import globals, "spRepFun.mac";
private var fill, dt1, dt2, chk_errors, chk_reject, chk_control, chk_others, chk_secur, chk_dv, chk_v, chk_mbk, chk_manual;


private const FT_DATE = 9;

class (TRsbPanel) SvodPanel

    InitTRsbPanel();
    setSize(30,6);
    setPosition(35,15);

    var DateBeg = {curdate};
    var DateEnd = {curdate};
    var stat = 0;

    this.Status = "F3 - выбор даты F2,F9 - выполнить";
    this.Caption = "Формирование скроллинга НПР2";

    addLabel(TRsbLabel(3, 1, "Период :"));
    var m_DateBeg:TRsbEditField = TRsbEditField(FT_DATE);
    m_DateBeg.setPosition(10,2);
    m_DateBeg.setSize(10,1);
    m_DateBeg.value = DateBeg;
    m_DateBeg.enabled = true;
    m_DateBeg.Name = "DateBeg";
    addControl(m_DateBeg);

    var m_DateEnd:TRsbEditField = TRsbEditField(FT_DATE);
    m_DateEnd.setPosition(10,3);
    m_DateEnd.setSize(10,1);
    m_DateEnd.value = DateEnd;
    m_DateEnd.Name = "DateEnd";
    addControl(m_DateEnd);
    m_DateBeg.addEventHandler(RSB_EV_KEY_PRESSED , R2M(this, "DATE_KEY_PRESSED"));
    m_DateEnd.addEventHandler(RSB_EV_KEY_PRESSED , R2M(this, "DATE_KEY_PRESSED"));
    addEventHandler(RSB_EV_KEY_PRESSED , R2M(this, "Panel_ButtonEvent"));


    macro Panel_ButtonEvent(RsbEvent)
       if((RsbEvent.keyCode == 316) or (RsbEvent.keyCode == 323))/*F2 F9*/
           stat = 0;
           DateBeg = m_DateBeg.Value;
           DateEnd = m_DateEnd.Value;
           this.close(1);
       elif(RsbEvent.keyCode == 27) /**/
           stat = 1;
       end;
    end;

    macro DATE_KEY_PRESSED(RsbEvent)
       if(RsbEvent.keyCode == 317)
           RsbEvent.Source.value = GetDateByCalendar(RsbEvent.Source.value);
       end;
    end;
end;

/*Выбор клиентов*/
macro payments_controll()

  /*Обработчик скроллинга*/
  macro NPR2_Scroll(rs, cmd, id, key)
    var errmsg, ars;
    /*Обработчик*/
    if(cmd == DLG_KEY)
      /*Esc*/
      if(key == 27)
        return CM_CANCEL;
      /*Alt+R*/
      elif(key == 275)
        return CM_SELECT;
      /*Alt+S*/
      end;
    end;
  end;
  /*Точка входа*/
  var que, rs, cmd;
     var panel = SvodPanel;
   panel.run;

  que = "select T_LOADDATE, "
      + "       T_FIRMID, "
      + "       T_EKK, "
      + "       to_char(T_TIMESTAMP, 'dd.mm.yyyy hh24:mi:ss') TimeStamp, "
      + "       T_EVENTYPE, "
      + "       T_ENTITYNUMBER, "
      + "       T_PORTFOLIOVALUE, "
      + "       T_INITMARGIN, "
      + "       T_MINMARGIN, "
      + "       T_RCV1, "
      + "       T_RCV2, "
      + "       t_risklevel, "
      + "       t_futposition_type, "
      + "       t_futtotalasset "
      + "  from DRCV_DBT "
      + " where t_loaddate >= " + getsqldate(panel.DateBeg)
      + "   and t_loaddate <= " + getsqldate(panel.DateEnd)
      + " order by T_LoadDate, T_EKK, T_TimeStamp";
  cmd = RsdCommand(que);
//  cmd.addParam("", RSDBP_IN, panel.DateBeg);
//  cmd.addParam("", RSDBP_IN, panel.DateEnd);

  rs = RSDRecordset(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);
  while(RunScroll(rs, 14, MakeArray("T_LoadDate", "Дата загрузки", 12, 2, -1, 0, 
                                   "T_FirmID", "Код Фирмы",15, 2, -1, 0,  
                                   "T_EKK", "Код клиента", 15, 2, -1, 0,
                                   "TimeStamp", "Метка времени", 18, 0, -1, 0,
                                   "T_EvenType", "Тип события", 11, 2, -1, 0, 
                                   "T_EntityNumber", "номер заявки/сделки", 19, 2, -1, 0, 
                                   "T_PortfolioValue", "Стоимость портфеля", 19, 2, 2, 0,
                                   "T_InitMargin", "Начальная маржа", 10, 2, 2, 0, 
                                   "T_MinMargin", "Минимальная маржа", 10, 2, 2, 0, 
                                   "T_RCV1", "НПР1", 7, 2, 2, 0,
                                   "T_RCV2", "НПР2", 7, 2, 2, 0,
                                   "t_risklevel", "Уровень риска", 11, 2, 0, 0,
                                   "t_futposition_type", "Тип позиции по ПФИ", 15, 2, 0, 0,
                                   "t_futtotalasset", "Общая стоимость портфеля", 17, 2, 2, 0
                                   ), 
                  null, "NPR2_Scroll", "Журнал НПР2 ", "~F4~ Поиск ~Ctrl+Shift+F5~ Фильтр ~Ctrl+Shift+F11~ Выгрузка в Excell ~Alt+R~ Обновить список ~Esc~ Выход", true))
    cmd = RsdCommand(que);
    rs = RSDRecordset(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);
  end;

end;
    

payments_controll();
exit(1);