/********************************************************************************************
 DESCRIPTION  :   Отчет Ф657_1 Портфель ЦБ
 PROGRAMMED BY:   Чебан А.А.
 CREATION DATE:
********************************************************************************************/
Import "f657.mac"; //Импорт базового класса
import or_tpl_h;

private const
   /* Идентификаторы учетных портфелей. */
   PortfID_Undef             = 0,
   PortfID_Trade             = 1,   /* ТП */
   PortfID_Sale              = 2,   /* ППР */
   PortfID_Contr             = 3,   /* ПКУ */
   PortfID_Promissory        = 4,   /* ПДО */
   PortfID_Retire            = 5,   /* ПУДП */
   PortfID_Back              = 6,   /* ПВО */
   PortfID_Unadmitted_TP     = 7,   /* БПП_TП */
   PortfID_Unadmitted        = 7,   /* БПП */
   PortfID_OD_req            = 8,   /* ПВО_БПП */
   PortfID_OD_com            = 9,   /* -ОД */
   PortfID_Unadmitted_PPR    = 10,  /* БПП_ППР */
   PortfID_Unadmitted_RETIRE = 11,  /* БПП_ПУДП */
   PortfID_Unadmitted_CONTR  = 12,  /* БПП_ПКУ */
   PortfID_Back_KSU          = 13,  /* ПВО_КСУ */
   PortfID_Back_BPP_KSU      = 14;  /* ПВО_БПП_КСУ */

class (repf657) repf657_1()
//Применить конструктор родительского класса
    Initrepf657();

    // ADD 14.11.2024. Переменные для варианта WindowsReports, поддерживающего POIReports
    var csvFile, fName, csvTable, printEngine;

    var  account = TRecHandler( "account" ),
         dl_tick = TRecHandler( "dl_tick" ),
         dl_leg  = TRecHandler( "dl_leg" ),
        fininstr = Trechandler( "fininstr" ), /* фин. инструмент*/
        avoiriss = Trechandler( "avoiriss" ), /* бумага*/
        AvKindShName;

    var Group, LegKind, IsBack, selectbpp, pmwbpp, IsQuoted;

    //Конструктор
    //Заголовок таблицы
    tableHeader = header_f657_1;
    //Заголовок окна
    winHeader = "Ф657_1";


/**
 * Функция получения курса заданного типа
 * @param SumB     Исходная сумма
 * @param pFromFI  Исходный Фин. инструмент
 * @param pToFI    Фин. инструмент, в который надо пересчитать
 * @param pType    Тип курса
 * @param pbdate   Дата курса
 * @param pround   признак округл. до копеек, по умолч. не округл.
 * @return NUMBER  Возвращается значение суммы
 */

    macro ConvSumtype (
        pFromFI,
        pToFI,
        pbdate
      )
      var cmd;
      var result = false;
      var statExec;

      cmd = RsdCommand(/* con,*/ "" );

      cmd.CmdText = "begin ? := NVL (RSB_FIInstr.ConvSumtype (1, " +
                                            "   ?, " +
                                            "   ?, " +
                                            "   12, " +
                                            "   ?), " +
                                            "0); end;";


      cmd.AddParam( "retval", RSDBP_RETVAL, V_MONEY );
      cmd.addParam( "", RSDBP_IN, pFromFI );
      cmd.addParam( "", RSDBP_IN, pToFI );
      cmd.addParam( "", RSDBP_IN, pbdate );

      statExec = ExecCommand( cmd, " Получить сумму конверсии ТСС... " );

      result  = cmd.value( "retval" );

      if(result != "")
        cmd.close();
        return result;
      else
        cmd.close();
        return 0;
      end;

    End;



//---------------------секция методов для получения данных----------------------
    //Торговый код ценной бумаги
    private macro fillColumn01 (FD)
       return FD.fininstr.rec.fi_code;
    End;

    //Балансовый счет 2-го порядка, категория +ОД
    private macro fillColumn02 (InvestmentsAccountNumber)
        if (InvestmentsAccountNumber != "")
            return SubStr(InvestmentsAccountNumber,1,5);
        else
            return "---";
        end;
    End;

    //Лицевой счет вложений
    private macro fillColumn03 (InvestmentsAccountNumber)
        if (InvestmentsAccountNumber != "")
            return InvestmentsAccountNumber;
        else
            return "---";
        end;
    End;

    //cчет второго порядка первоначального учета
    private macro fillColumn04 (FD)
        var sql="select distinct accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter, categ.t_Code "+
                          "from dmcaccdoc_dbt accdoc, dmccateg_dbt categ "+
                          "where accdoc.t_CatID = categ.t_ID "+
                            "and categ.t_Code like 'Наш портфель ц/б' "+   //категория учета Наш портфель ц/б
                            "and accdoc.t_docid = :dealid";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":dealid", RSDBP_IN, FD.tick.rec.dealid);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return SubStr(rs.Value(0),1,5);
        else
            return "---";
        end;
    End;

    //Валюта
    private macro fillColumn05 (FD)
       return GetFinInstrCcy (FD.fininstr.rec.FaceValueFI, true );
    End;

    //Эмитент
    private macro fillColumn06 (FD)
       return getIssuer (FD);
    End;

    //ФО или НФО
    private macro fillColumn07 (FD)
       return getNFO(FD.fininstr.rec.issuer);
    End;

    //Страна эммитента
    private macro fillColumn08 (FD)
       return getIssuerCountry(FD.fininstr.rec.issuer);
    End;

    //Страновая оценка
    private macro fillColumn09 (FD)
       return getRatingCountry(FD.fininstr.rec.issuer);
    End;

    //Вернуть строку Признак международной организации
    private macro fillColumn10 (FD)
       return getOrgInternational(FD.fininstr.rec.issuer);
    End;

    //
    private macro fillColumn11 ()
       return "---";
    End;

    //
    private macro fillColumn12 ()
       return "---";
    End;

    //тип ценной бумаги
    private macro fillColumn13 (FD)
       return getAvoirKind(FD);
    End;

    //вернуть строку Признак SPV эмитента (да/нет)
    private macro fillColumn14 (FD)
       return getSPV(FD.fininstr.rec.issuer);
    End;

    //признак ипотечного покрытия (да/нет)
    private macro fillColumn15 (FD)
       return getMortgageCoverage(FD.fininstr.rec.fiid);
    End;

    //ОКВЭД эмитента
    private macro fillColumn16 (FD)
       return getOKVED(FD.fininstr.rec.issuer);
    End;

    //
    private macro fillColumn17 ()
       return "---";
    End;

    //рейтинг Эмитента (Standart&Poors)
    private macro fillColumn18 (FD)
       return getRatingIssuer(FD.fininstr.rec.issuer, "S\&P", repDate);
    End;

    //рейтинг эмиссии (Standart&Poors)
    private macro fillColumn19 (FD)
       return getRatingSec(FD.fininstr.rec.fiid, "S\&P", repDate);
    End;

    //
    private macro fillColumn20 ()
       return "---";
    End;

    //
    private macro fillColumn21 ()
       return "---";
    End;

    //рейтинг Эмитента (Moodys)
    private macro fillColumn22 (FD)
       return getRatingIssuer(FD.fininstr.rec.issuer, "Moody", repDate);
    End;

    //рейтинг эмиссии (Moodys)
    private macro fillColumn23 (FD)
       return getRatingSec(FD.fininstr.rec.fiid, "Moody", repDate);
    End;

    //
    private macro fillColumn24 ()
       return "---";
    End;

    //
    private macro fillColumn25 ()
       return "---";
    End;

    //рейтинг эмитента (Fitch Ratings)
    private macro fillColumn26 (FD)
       return getRatingIssuer(FD.fininstr.rec.issuer, "Fitch IBC", repDate);
    End;

    //рейтинг эмиссии (Fitch Ratings)
    private macro fillColumn27 (FD)
       return getRatingSec(FD.fininstr.rec.fiid, "Fitch IBC", repDate);
    End;

    //
    private macro fillColumn28 ()
       return "---";
    End;

    //
    private macro fillColumn29 ()
       return "---";
    End;

    //рейтинг эмитента (АКРА)
    private macro fillColumn30 (FD)
       return getRatingIssuer(FD.fininstr.rec.issuer, "АКРА", repDate);
    End;

    //рейтинг эмиссии (АКРА)
    private macro fillColumn31 (FD)
       return getRatingSec(FD.fininstr.rec.fiid, "АКРА", repDate);
    End;

    //рейтинг эмитента (Эксперт РА)
    private macro fillColumn32 (FD)
       return getRatingIssuer(FD.fininstr.rec.issuer, "Эксп. РА", repDate);
    End;

    //рейтинг эмиссии (Эксперт РА)
    private macro fillColumn33 (FD)
       return getRatingSec(FD.fininstr.rec.fiid, "Эксп. РА", repDate);
    End;

    //Признак наличия банкротства по эмитенту (Да/Нет)
    private macro fillColumn34 (FD)
       return getIsBankrupt(FD.fininstr.rec.issuer);
    End;

    //№гос. регистрации
    private macro fillColumn35 (FD)
       return FD.avoiriss.rec.LSIN;
    End;

    //isin
    private macro fillColumn36 (FD)
      if (FD.avoiriss.rec.ISIN != "")
       return FD.avoiriss.rec.ISIN;
      else
       return "---";
      end;
    End;

    //Обращается на рынке (да/нет)
    private macro fillColumn37 (FD)
       return getTradeMarket(FD.fininstr.rec.fiid);
    End;

    //Признак наличия дефолта по выпуску (да/нет)
    private macro fillColumn38 (FD)
       return getCatDef(FD.fininstr.rec.fiid);
    End;

    //нахождение в ломбардном списке (да/нет)
    private macro fillColumn39 (FD)
       return getLombard(FD.fininstr.rec.fiid);
    End;

    //признак ипотечного покрытия (да/нет)
    private macro fillColumn40 (FD)
       return getMortgageCoverage(FD.fininstr.rec.fiid);
    End;

    //дата начала размещения
    private macro fillColumn41 (FD)
      if(FD.avoiriss.rec.begplacementdate == "")
        return "01.01.0001";
      else
        return Date(FD.avoiriss.rec.begplacementdate);
      end;
    End;

    //дата погашения ЦБ
    private macro fillColumn42 (FD)
      if( FD.fininstr.rec.drawingdate == "")
        return "01.01.0001";

      else
        return  Date(FD.fininstr.rec.drawingdate);
      end;
    End;

    //дата погашения купона
    private macro fillColumn43 (FD)
      var date_cupon;
       if (FI_IsCouponAvoiriss(FD.fininstr.rec.FIID))
          date_cupon = GetCoupon_MaxDrDate( FD.fininstr.rec.FIID, RepDate + 1 );
//          println(
//            "date_cupon1 = ", date_cupon);
          date_cupon = GetCoupon_MaxDrDateOnFrDate(FD.fininstr.rec.FIID, (RepDate + 1));
//          println(
//            "date_cupon2 = ", date_cupon);
//          println(date_cupon);
          if(date_cupon == "")
	    return "01.01.0001";

          else
            return Date(date_cupon);
          end;
       else
            return "01.01.0001";
       end;
    End;

    //
    private macro fillColumn44 ()
       return "---";
    End;

    //номинал ЦБ
    private macro fillColumn45 (FD)
       return money(GetFaceValue(FD.fininstr.rec.FIID, RepDate));
    End;

    //котировка - рыночная стоимость ценной бумаги (в рублевом эквиваленте)
    private macro fillColumn46 (FD)
       var PriceRUR, PriceCUR;

       GetRateInfo(FD, SP_RATETYPE_MarketPrice, @PriceRUR, @PriceCUR, ExistNOSS(FD.avoiriss, RepDate));
       return double(PriceRUR/10);
    End;

    //открытое количество ЦБ
    private macro fillColumn47 (Amount)
       return money(Amount);
    End;

    //открытое количество ЦБ
    private macro fillColumn48 (getDataLot)
       return money(getDataLot.t_sum);
    End;

    //УНКД с учетом погашенных купонов
    private macro fillColumn49 (getdatalot)
       return money(getdatalot.NKDAmount);
    End;

    //Начисленный купон
    private macro fillColumn50 (getdatalot)
       return money(getdatalot.InterestIncome);
    End;

    //Начисленный дисконт
    private macro fillColumn51 (getdatalot)
       return money(getdatalot.DiscountIncome);
    End;

    //Премия
    private macro fillColumn52 (getdatalot)
       return money(getdatalot.NotWrtBonus);
    End;

    //Балансовая стоимость RUR
    private macro fillColumn53 (getdatalot)
    var PereOcenka = getdatalot.t_OverAmount;
      if(PereOcenka<0)
        PereOcenka = PereOcenka * (-1);
      end;
       return money(getdatalot.BalanceCost + PereOcenka);
    End;

    //Переоценка RUR
    private macro fillColumn54 (getdatalot)
       return money(getdatalot.OverAmount);
    End;

    //ТСС
    private macro fillColumn55 (FD)
       var PriceRUR, PriceCUR;

       GetRateInfo(FD, SP_RATETYPE_RightCost, @PriceRUR, @PriceCUR, ExistNOSS(FD.avoiriss, RepDate));
       return money(PriceRUR);

/*       return ConvSumtype(FD.fininstr.rec.FIID,
                          FD.fininstr.rec.FaceValueFI,
                          RepDate);*/
    End;

    //Резерв
    private macro fillColumn56 (ReservAmount, ReservAmount2732)
       if (ReservAmount2732 > 0)
          return ReservAmount2732;
       else
          return ReservAmount;
       end;
    End;

    //
    private macro fillColumn57 ()
       return "---";
    End;

    //рыночная стоимость ценной бумаги (в валюте бумаги)
    private macro fillColumn58 (FD)
       var PriceRUR, PriceCUR;

       GetRateInfo(FD, SP_RATETYPE_MarketPrice, @PriceRUR, @PriceCUR, ExistNOSS(FD.avoiriss, RepDate));
       return money(PriceCUR);
    End;

    //рыночная стоимость ценной бумаги (в рублевом эквиваленте)
    private macro fillColumn59 (FD)
       var PriceRUR, PriceCUR;

       GetRateInfo(FD, SP_RATETYPE_MarketPrice, @PriceRUR, @PriceCUR, ExistNOSS(FD.avoiriss, RepDate));
       return money(PriceRUR);
    End;

    //включение биржей в списки для расчета Индекса ММВБ 50 (да/нет)
    private macro fillColumn60 (FD)
       return getMMVB50(FD.fininstr.rec.fiid);
    End;

    //включение биржей в списки для расчета Индекса РТС 50 (да/нет)
    private macro fillColumn61 (FD)
       return getRTC50(FD.fininstr.rec.fiid);
    End;

    //получить значение показателя обесценения
    private macro fillColumn62 (FD)
       return Money(Round(getInDep(FD.avoiriss.rec.ISIN),2));
    End;

    //нахождение в ломбардном списке (да/нет)
    private macro fillColumn63 (FD)
       return getLombard(FD.fininstr.rec.fiid);
    End;

    //процентная ставка по ЦБ (ставка текущего купона из параметров бумаги)
    private macro fillColumn64 (FD)
        return Money(Round(getCoupRate(FD),2));
    End;

    //cредневзвешенная цена (да/нет)
    private macro fillColumn65 (FD)
       var PriceRUR, PriceCUR;

       GetRateInfo(FD, SP_RATETYPE_MediumPrice, @PriceRUR, @PriceCUR, ExistNOSS(FD.avoiriss, RepDate));
       if (PriceCUR != 0)
          return "Да";
       else
          return "Нет";
       end;
    End;

    //511-П_Источник котировки
    private macro fillColumn66 (FD)
       return get511SourceQuote(FD.fininstr.rec.fiid);
    End;

    //511-П_Признак активности и ликвидности рынка (да/нет)
    private macro fillColumn67 (FD)
       return get511SignLiquidMarket(FD.fininstr.rec.fiid);
    End;

    //511-П_Уровень иерархии оценки (1/2/3)
    private macro fillColumn68 (FD)
       return get511GradeLevel(FD.fininstr.rec.fiid);
    End;

    //511-П_Коэффициент ликвидности
    private macro fillColumn69 (FD)
       return get511LiquidRatio(FD.fininstr.rec.fiid);
    End;

    //Величина корректировки (511-П)
    private macro fillColumn70 (FD)
       return getValueAdjust(FD.fininstr.rec.fiid);
    End;

    //Облигации с залоговым обеспечением (да/нет)
    private macro fillColumn71 (FD)
       return getSecuredBonds(FD.fininstr.rec.fiid);
    End;

    //Вложения, которые прямо или через третьих лиц обеспечены гарантией РФ (да/нет)
    private macro fillColumn72 (FD)
       return getGuaranteeRF(FD.fininstr.rec.fiid);
    End;

    //
    private macro fillColumn73 ()
       return "---";
    End;

    //
    private macro fillColumn74 ()
       return "---";
    End;

    //
    private macro fillColumn75 ()
       return "---";
    End;

    //
    private macro fillColumn76 ()
       return "---";
    End;

    //
    private macro fillColumn77 ()
       return "---";
    End;

    //
    private macro fillColumn78 ()
       return "---";
    End;

    //
    private macro fillColumn79 ()
       return "---";
    End;

    //
    private macro fillColumn80 ()
       return "---";
    End;

    //
    private macro fillColumn81 (AccReserv2732, AccReserv)
      if (AccReserv2732 != "---")
        return AccReserv2732;
      else
        return AccReserv;
      end;
    End;

    //
    private macro fillColumn82 ()
       return "---";
    End;

    //соответствие депозитария критериям п.1.2 Указания 2732-У
    private macro fillColumn83 (FD)
       return getDepoCrit(FD.fininstr.rec.fiid);
    End;

    //
    private macro fillColumn84 (FD, InvestmentsAccountNumber)
      if((SubStr(InvestmentsAccountNumber,1,5) == "50505") and (RepDate > FD.fininstr.rec.drawingdate))
        return RepDate - FD.fininstr.rec.drawingdate;
      else
        return 0;
      end;
    End;

    //Лицевой счет вложений
    private macro fillColumn85 (InvestmentsAccountNumber)
        if (InvestmentsAccountNumber != "")
            return InvestmentsAccountNumber;
        else
            return "---";
        end;
    End;

    //PortfID
    private macro fillColumn86 (PortfID)
       return PortfID;
    End;

    //FIID - id финансового инструмента
    private macro fillColumn87 (FD)
       return FD.fininstr.rec.fiid;
    End;

    //котируемая/некотируемая
    private macro fillColumn88 (FD)
       if (ExistNOSS(FD.avoiriss, RepDate))
           return 1;
       else
           return 0;
       end;
    End;




//------------------------------------------------------------------------------

   macro getReservAmountRUR(
        BOfficeKind,
        v_Buy_Sale,
        v_dealid,
        v_ReservAmount,
        v_RepDate
        )

        var cmd;
        var result = false;
        var statExec;

        cmd = RsdCommand(/* con,*/ "" );

        cmd.CmdText = "begin ? := user_f657.getReservAmountRUR(?, " +
                                            "   ?, " +
                                            "   ?, " +
                                            "   ?, " +
                                            "   ?); end;";

        cmd.AddParam( "retval", RSDBP_RETVAL, V_MONEY );
        cmd.addParam( "", RSDBP_IN, BOfficeKind);
        cmd.addParam( "", RSDBP_IN, v_Buy_Sale);
        cmd.addParam( "", RSDBP_IN, v_dealid );
        cmd.addParam( "", RSDBP_IN, v_ReservAmount);
        cmd.addParam( "", RSDBP_IN, v_RepDate);

        statExec = ExecCommand( cmd, " Получить сумму резерва... " );

        result  = cmd.value( "retval" );

        if(result != "")
          cmd.close();
          return result;
        else
          cmd.close();
          return 0;
        end;

   end;


/*
 * Функция определения суммы конверсии за дату
 * @param SumB     Исходная сумма
 * @param pFromFI  Исходная Фин. инструмент
 * @param pbdate   Дата курса
 * @return NUMBER  Возвращается значение суммы
*/

    macro SumConv (
        SumB,
        pFromFI,
        pbdate
      )
      var cmd;
      var result = false;
      var statExec;

      cmd = RsdCommand(/* con,*/ "" );

      cmd.CmdText = "begin ? := RSB_FIInstr.ConvSum (?, " +
                                          "   ?, " +
                                          "   PM_COMMON.NATCUR, " +
                                          "   ?); end;";

      cmd.AddParam( "retval", RSDBP_RETVAL, V_MONEY );
      cmd.addParam( "", RSDBP_IN, SumB );
      cmd.addParam( "", RSDBP_IN, pFromFI );
      cmd.addParam( "", RSDBP_IN, pbdate );

      statExec = ExecCommand( cmd, " Получить сумму конверсии... " );

      result  = cmd.value( "retval" );

      if(result != "")
        cmd.close();
        return result;
      else
        cmd.close();
        return 0;
      end;

    End;



/*
  Проверить является ли бумага облигацией (Бондом)
*/

    macro checkBond (avoirkind)
      var cmd;
      var result = false;
      var statExec;

      cmd = RsdCommand(/* con,*/ "" );

      cmd.CmdText = "begin ? := user_f657.checkBond(?); end;";

      cmd.AddParam( "retval", RSDBP_RETVAL, V_INTEGER );
      cmd.addParam( "", RSDBP_IN, avoirkind );

      statExec = ExecCommand( cmd, " Проверка на бонд " );

      result  = cmd.value( "retval" );

      if(result != "")
        cmd.close();
        return result;
      else
        cmd.close();
        return "Не определено";
      end;

    End;




/*
  Вернуть номинал на дату
*/

    macro getNominalOnDate (fiid)
      var cmd;
      var Nominal = 0;
      var statExec;

      cmd = RsdCommand(/* con,*/ "" );

      cmd.CmdText = "begin ? := user_f657.getNominalOnDate(?,?); end;";

      cmd.AddParam( "retval", RSDBP_RETVAL, V_MONEY );
      cmd.addParam( "", RSDBP_IN, fiid );
      cmd.addParam( "", RSDBP_IN, repDate  );

      statExec = ExecCommand( cmd, " Поиск номинала " );

      Nominal  = cmd.value( "retval" );
//      println(Nominal);
      if(Nominal != "")
        cmd.close();
        return Nominal;
      else
        return 0;
        cmd.close();
      end;

    End;



    macro ConvDate(v_date)
	var dd, mm, yy;
        var StrDate = String(v_date);
        dd = Substr(StrDate,1,2);
        dd = iif(strlen(dd)<2,"0" + dd, dd);
        mm = Substr(StrDate,4,2);
        yy = Substr(StrDate,7,4);
//        println("---");
//                println(dd);
//                println(mm);
//                println(yy);
//        println("---");
        return dd + "." + mm + "." + yy;

    end;


    //Определим FIID бумаги с ISIN = "RU000A0ZZSH5"
    macro AllowedFIID(fiid)

    return true;
        var sql = "select f.t_fiid " +
                  "   from davoiriss_dbt c, dfininstr_dbt f " +
                  "   where f.t_fiid = c.t_fiid " +
                  "  and c.t_isin in ( " +
                                  " 'RU000A0JNZQ1', " +
                                  " 'RU000A0ZYYN4', " +
                                  " 'RU000A0JXN21', " +
                                  " 'RU000A0ZYDU3', " +
                                  " 'XS0548633659', " +
                                  " 'RU000A0JTK38', " +
                                  " 'RU000A0ZYRY5', " +
                                  " 'XS1701384494', " +
                                  " 'XS1912654677', " +
                                  " 'RU000A0JUAT3', " +
                                  " 'XS0979891925', " +
                                  " 'RU000A0JR4A1', " +
                                  " 'RU000A0JU9G2', " +
                                  " 'RU000A0JUAH8', " +
                                  " 'RU000A0JWPW1'" +
                                  " )";


        var cmd = rsdCommand(sql);

        cmd.Execute();
        var rs = rsdRecordSet(cmd);



        while (rs.MoveNext)
          if( rs.Value(0) == fiid)
              return true;
	  end;
        end;

      onerror
        return false;
    end;


  /*
    Возвращает все данные из временной таблицы в единственном экземпляре
    для заданных параметров
  */

  macro getSumIDFromGroupTmp ( PortfID,
                              Account,
                              FIID,
                              IsQuoted)

        var sql = "select tmp.t_sumid " +
                  "  from f657tmpGroupTable tmp " +
                  " where  " +
                  "  t_account = :t_account " +
                  "  and t_portfid = :t_portfid " +
                  "  and t_fiid = :t_fiid " +
                  "  and t_isquoted = :t_isquoted " +
                  "  and rownum = 1";

        var cmd = rsdCommand(sql);
        cmd.addParam(":t_account", RSDBP_IN, Account);
        cmd.addParam(":t_portfid", RSDBP_IN, PortfID);
        cmd.addParam(":t_fiid", RSDBP_IN, FIID);
        cmd.addParam(":t_isquoted", RSDBP_IN, IsQuoted);

        cmd.Execute();
        var rs = rsdRecordSet(cmd);

        if(rs.MoveNext)
          return rs.Value(0);
        else
          return 0;
        end;
      onerror
        return 0;

  End;


   macro ПолучитьУчетныйПортфель( LotBuy, Group )

      if( ((LotBuy.Portfolio == KINDPORT_TRADE) and (LotBuy.State == PM_WRTSUM_FORM)
             and (LotBuy.Buy_Sale == PM_WRITEOFF_SUM_BUY)) )
         return PortfID_Trade;

      elif( ((LotBuy.Portfolio == KINDPORT_SALE) and (LotBuy.State == PM_WRTSUM_FORM)
               and (LotBuy.Buy_Sale == PM_WRITEOFF_SUM_BUY)) )
         return PortfID_Sale;

      elif( ((LotBuy.Portfolio == KINDPORT_RETIRE) and (LotBuy.State == PM_WRTSUM_FORM)
              and (LotBuy.Buy_Sale == PM_WRITEOFF_SUM_BUY)) )
         return PortfID_Retire;

      elif( ((LotBuy.Portfolio == KINDPORT_CONTR) and (LotBuy.State == PM_WRTSUM_FORM)
              and (LotBuy.Buy_Sale == PM_WRITEOFF_SUM_BUY)) )
         return PortfID_Contr;

      elif( ((LotBuy.Portfolio == KINDPORT_PROMISSORY) and (LotBuy.State == PM_WRTSUM_FORM)
             and (LotBuy.Amount != 0) and (LotBuy.Buy_Sale == PM_WRITEOFF_SUM_BUY)) )
         return PortfID_Promissory;
      /*В портфель ПВО отбираются лоты, изначально купленные по сделкам обратного РЕПО БПП, не проданные впоследствии*/
      elif( (LotBuy.BlockKind == 2) )
         return PortfID_Back;
      /*Для портфеля БПП в отчет отбираются лоты, которые проданы из портфелей "ТП", "ППР", "ПУДП", "ПКУ" и имеют признак "БПП"*/
      elif( (LotBuy.Portfolio == KINDPORT_TRADE) and
             (LotBuy.State == PM_WRTSUM_SALE_BPP)
          )
         return PortfID_Unadmitted_TP;
      elif( (LotBuy.Portfolio == KINDPORT_SALE) and
             (LotBuy.State == PM_WRTSUM_SALE_BPP)
          )
         return PortfID_Unadmitted_PPR;
      elif( (LotBuy.Portfolio == KINDPORT_RETIRE) and
             (LotBuy.State == PM_WRTSUM_SALE_BPP)
          )
         return PortfID_Unadmitted_RETIRE;
      elif( (LotBuy.Portfolio == KINDPORT_CONTR) and
             (LotBuy.State == PM_WRTSUM_SALE_BPP)
          )
         return PortfID_Unadmitted_CONTR;
      elif( (LotBuy.Buy_Sale == PM_WRITEOFF_SUM_SALE) and ((LotBuy.AmountBD != 0)) and (IsTwoPart(Group)
                and (LotBuy.State == PM_WRTSUM_NOTFORM))
          )
         return PortfID_OD_com; /* -ОД*/
      elif( (LotBuy.BlockKind == 1) )
         return PortfID_OD_req;  /*ПВО_БПП*/
      elif( (LotBuy.BlockKind == 4))
         return PortfID_Back_KSU;
      elif( (LotBuy.BlockKind == 3))
         return PortfID_Back_BPP_KSU;
      end;

      return PortfID_Undef;
   end;
//------------------------------------------------------------------------------
    private macro Portfolio()
            /*БПП*/
      var Select = " SELECT T1.* " +
                   "   FROM (SELECT /*+LEADING(wrtsum)*/ V1.*, 0 as BlockKind FROM v_scwrthistex V1, dpmwrtsum_dbt wrtsum " +
                   "          WHERE wrtsum.t_SumID = V1.t_SumID " +
                   "            AND wrtsum.t_buy_sale = " + string(PM_WRITEOFF_SUM_BUY) +
                   "            AND wrtsum.t_party    = -1 " +
                   "            AND wrtsum.t_dockind  = " + string(DLDOC_PAYMENT) +
                   "            AND wrtsum.t_kind     = 210 " +
                   "            AND wrtsum.t_Department = " + Department +
                   "            AND V1.t_state = " + string(PM_WRTSUM_SALE_BPP) +
                   "            AND V1.t_portfolio in ("+string(KINDPORT_TRADE)+", "+string(KINDPORT_SALE)+", "+string(KINDPORT_RETIRE)+", "+string(KINDPORT_CONTR)+")) T1 " +
                            " WHERE T1.t_instance = (SELECT MAX (V11.t_instance) " +
                            "                          FROM v_scwrthistex V11 " +
                            "                         WHERE V11.t_sumid = T1.t_sumid " +
                            "                           AND V11.t_changedate <= " + GetSQLDate(repDate) + ") "+
         "UNION"
          /*"ТП" /"ППР" / "ПУДП" / "ПДО" / "ПКУ"*/

                  " SELECT T2.* " +
                  "   FROM (SELECT /*+LEADING(wrtsum)*/ V2.*, 0 as BlockKind FROM v_scwrthistex V2, dpmwrtsum_dbt wrtsum " +
                  "          WHERE wrtsum.t_SumID = V2.t_SumID " +
                  "            AND wrtsum.t_buy_sale = " + string(PM_WRITEOFF_SUM_BUY) +
                  "            AND wrtsum.t_party = -1 " +
                  "            AND wrtsum.t_dockind in(" + string(DLDOC_PAYMENT) + ", " +
                                                           string(DL_ISSUE_UNION) + ", " +
                                                           string(DL_MOVINGDOC) + ") " +
                  "            AND wrtsum.t_Department = " + Department +
                  "            AND wrtsum.t_kind in(20,210,40,110,130,90) " +
                  "            AND V2.t_Amount != 0 " +
                  "            AND V2.t_state = " + string(PM_WRTSUM_FORM) +
                  "            AND V2.t_Portfolio in ("+string(KINDPORT_TRADE)+", "+string(KINDPORT_SALE)+", "+string(KINDPORT_CONTR)+", "+string(KINDPORT_RETIRE)+", "+string(KINDPORT_PROMISSORY)+")) T2 " +
                          " WHERE T2.t_instance = (SELECT MAX (V22.t_instance) " +
                          "                          FROM v_scwrthistex V22 " +
                          "                         WHERE V22.t_sumid = T2.t_sumid " +
                          "                           AND V22.t_changedate <= " + GetSQLDate(repDate) + ") "+
          "UNION "+
          /* ПВО (РЕПО/зачисления) */
           " SELECT T3.* " +
               "   FROM (SELECT /*+LEADING(wrtsum)*/ V3.*, 2 as BlockKind FROM v_scwrthistex V3, dpmwrtsum_dbt wrtsum " +
               "          WHERE wrtsum.t_SumID = V3.t_SumID " +
               "            AND wrtsum.t_Party = -1 " +
               "            AND wrtsum.t_dockind in(" + string(DLDOC_PAYMENT) + ", " + string(DL_ISSUE_UNION) + ") " +
               "            AND wrtsum.t_Department = " + Department +
               "            AND ( (V3.t_State = " + string(PM_WRTSUM_FORM) + " and " +
               "                   wrtsum.t_DealID = (select tick.t_DealID " +
               "                                        from ddl_tick_dbt tick " +
               "                                       where tick.t_DealID = wrtsum.t_DealID " +
               "                                         and rsb_secur.IsTwoPart(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1 " +
               "                                         and ( tick.t_DealStatus < 20 or " +
               "                                               (tick.t_DealStatus = 20 and tick.t_CloseDate > " + GetSQLDate(repDate) + ") " +
               "                                             ) " +
               "                                     ) and " +
               "                   V3.t_AmountBD = 0 " +
               "                  ) " +
               "                  OR " +
               "                  wrtsum.t_kind in(40,110,130) " +
               "                )" +
               "            AND V3.t_Portfolio = " + string(KINDPORT_BACK) +
               "            AND (V3.t_Amount > 0 OR " +
               "                 Exists( select 1 " +
               "                           from v_scwrthistex V333 " +
               "                          where V333.t_State = " + string(PM_WRTSUM_NOTFORM) +
               "                            and V333.t_Portfolio = " + KINDPORT_BASICDEBT +
               "                            and V333.t_Source = V3.t_SumID "  +
               "                            and V333.t_Amount > 0 " +
               "                            and V333.t_instance =(SELECT MAX (t_instance) " +
               "                                                    FROM v_scwrthistex " +
               "                                                   WHERE t_sumid = V333.t_sumid " +
               "                                                     AND t_changedate <= "+ GetSQLDate(repDate) + " ) " +
               "                       ) " +
               "                )" +
               "        ) T3 " +
               " WHERE T3.t_instance = (SELECT MAX (V33.t_instance) " +
               "                          FROM v_scwrthistex V33 " +
               "                         WHERE V33.t_sumid = T3.t_sumid " +
               "                           AND V33.t_changedate <= " + GetSQLDate(repDate) + ") "+
           "UNION "+
           /*ПВО_БПП*/
                  " SELECT T4.* " +
                                 "   FROM (SELECT /*+LEADING(wrtsum)*/ V4.*, 1 as BlockKind FROM v_scwrthistex V4, dpmwrtsum_dbt wrtsum " +
                                 "          WHERE wrtsum.t_SumID = V4.t_SumID " +
                                 "            AND wrtsum.t_Party = -1 " +
                                 "            AND wrtsum.t_dockind = " + string(DLDOC_PAYMENT) +
                                 "            AND wrtsum.t_Buy_Sale = " + PM_WRITEOFF_SUM_BUY +
                                 "            AND wrtsum.t_Department = " + Department +
                                 "            AND wrtsum.t_DealID = (select tick.t_DealID " +
                                 "                                     from ddl_tick_dbt tick " +
                                 "                                    where tick.t_DealID = wrtsum.t_DealID " +
                                 "                                      and rsb_secur.IsTwoPart(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1 " +
                                 "                                      and ( tick.t_DealStatus < 20 or " +
                                 "                                            (tick.t_DealStatus = 20 and tick.t_CloseDate > " + GetSQLDate(repDate) + ")" +
                                 "                                          ) " +
                                 "                                  ) " +
                                 "            AND V4.t_Amount > 0 " +
                                 "            AND V4.t_Portfolio = " + string(KINDPORT_BASICDEBT) +
                                 "            AND V4.t_State = " + string(PM_WRTSUM_NOTFORM) +
                                 "            AND Exists( SELECT buy1.t_SumID from dpmwrtsum_dbt buy1 where buy1.t_SumID = V4.t_Source and buy1.t_Portfolio = " + KINDPORT_BACK + ") " +
                                 "        ) T4 " +
                                 " WHERE T4.t_instance = (SELECT MAX (V44.t_instance) " +
                                 "                          FROM v_scwrthistex V44 " +
                                 "                         WHERE V44.t_sumid = T4.t_sumid " +
                                 "                           AND V44.t_changedate <= " + GetSQLDate(repDate) + ") "+
            "UNION "+
            /* - ОД */
                                 " SELECT T5.* " +
                                 "   FROM (SELECT /*+LEADING(wrtsum)*/ V5.*, 0 as BlockKind FROM v_scwrthistex V5, dpmwrtsum_dbt wrtsum " +
                                 "          WHERE wrtsum.t_SumID = V5.t_SumID " +
                                 "            AND wrtsum.t_Party = -1 " +
                                 "            AND wrtsum.t_dockind = " + string(DLDOC_PAYMENT) +
                                 "            AND wrtsum.t_Buy_Sale = " + string(PM_WRITEOFF_SUM_SALE) +
                                 "            AND wrtsum.t_Department = " + Department +
                                 "            AND wrtsum.t_DealID = (select tick.t_DealID " +
                                 "                                     from ddl_tick_dbt tick " +
                                 "                                    where tick.t_DealID = wrtsum.t_DealID " +
                                 "                                      and rsb_secur.IsTwoPart(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1 " +
                                 "                                      and ( tick.t_DealStatus < 20 or " +
                                 "                                            (tick.t_DealStatus = 20 and tick.t_CloseDate > " + GetSQLDate(repDate) + ")" +
                                 "                                          ) " +
                                 "                                  ) " +
                                 "            AND V5.t_AmountBD > 0 " +
                                 "            AND V5.t_State = " + string(PM_WRTSUM_NOTFORM) +
                                 "        ) T5 " +
                                 " WHERE T5.t_instance = (SELECT MAX (V55.t_instance) " +
                                 "                          FROM v_scwrthistex V55 " +
                                 "                         WHERE V55.t_sumid = T5.t_sumid " +
                                 "                           AND V55.t_changedate <= " + GetSQLDate(repDate) + ") "+
            "UNION "+
            /* ПВО КСУ */
                                 " SELECT T6.* " +
                                 "   FROM (SELECT /*+LEADING(wrtsum)*/ V6.*, 4 as BlockKind FROM v_scwrthistex V6, dpmwrtsum_dbt wrtsum " +
                                 "          WHERE wrtsum.t_SumID = V6.t_SumID " +
                                 "            AND wrtsum.t_Party = -1 " +
                                 "            AND wrtsum.t_dockind  = " + string(DLDOC_PAYMENT) +
                                 "            AND wrtsum.t_Department = " + Department +
                                 "            AND V6.t_State = " + string(PM_WRTSUM_FORM) +
                                 "            AND V6.t_Portfolio = " + string(KINDPORT_BACK_KSU) +
                                 "            AND V6.t_Amount > 0 " +
                                 "        ) T6 " +
                                 " WHERE T6.t_instance = (SELECT MAX (V66.t_instance) " +
                                 "                          FROM v_scwrthistex V66 " +
                                 "                         WHERE V66.t_sumid = T6.t_sumid " +
                                 "                           AND V66.t_changedate <= " + GetSQLDate(repDate) + ") "+
            "UNION "+
            /*ПВО_БПП_КСУ*/
                                 " SELECT T7.* " +
                                 "   FROM (SELECT /*+LEADING(wrtsum)*/ V7.*, 3 as BlockKind FROM v_scwrthistex V7, dpmwrtsum_dbt wrtsum " +
                                 "          WHERE wrtsum.t_SumID = V7.t_SumID " +
                                 "            AND wrtsum.t_Party = -1 " +
                                 "            AND wrtsum.t_dockind = " + string(DLDOC_PAYMENT) +
                                 "            AND wrtsum.t_Buy_Sale = " + PM_WRITEOFF_SUM_BUY +
                                 "            AND wrtsum.t_Department = " + Department +
                                 "            AND wrtsum.t_DealID = (select tick.t_DealID " +
                                 "                                     from ddl_tick_dbt tick " +
                                 "                                    where tick.t_DealID = wrtsum.t_DealID " +
                                 "                                      and ( tick.t_DealStatus < 20 "+
                                 "                                           or (    tick.t_DealStatus = 20 " +
                                 "                                               and (   tick.t_CloseDate > " + GetSQLDate(repDate) +
                                 "                                                    or rsb_secur.DealIsRepo(tick.t_DealID)=0 or rsb_secur.DealIsLoan(tick.t_DealID)=0"+
                                 "                                                   )"+
                                 "                                              )"+
                                 "                                          )"+
                                 "                                  ) " +
                                 "            AND V7.t_Amount > 0 " +
                                 "            AND V7.t_Portfolio = " + string(KINDPORT_BACK_BPP_KSU) +
                                 "            AND V7.t_State = " + string(PM_WRTSUM_NOTFORM) +
                                 "            AND Exists( SELECT buy1.t_SumID from dpmwrtsum_dbt buy1 where buy1.t_SumID = V7.t_Source and buy1.t_Portfolio = " + KINDPORT_BACK_KSU + ") " +
                                 "        ) T7 " +
                                 " WHERE T7.t_instance = (SELECT MAX (V77.t_instance) " +
                                 "                          FROM v_scwrthistex V77 " +
                                 "                         WHERE V77.t_sumid = T7.t_sumid " +
                                 "                           AND V77.t_changedate <= " + GetSQLDate(repDate) + ")";
         return Select;
    end;

    //подсчет количества возвращаемых запросом записей
    private macro countForProgressBar(inSql)
        var cmd, countrec;

            cmd = rsdCommand("select count(1) c from ("+inSql+") tab");
            cmd.execute();

            countrec = TRsbDataSet(cmd);

            if (countrec.MoveNext)
                return countrec.Value(0);
            else
                return 0;
            end;
    end;

    //процедура очистки временной таблицы
    private macro truncateF657TMPTABLE()
      var sql= "begin "+
               "delete from F657TMPTABLE; "+
               "delete from f657tmpGroupTable; "+
               "delete from dportfolio657_1; "+
               "commit; "+
               "end; ";

      var cmd = rsdCommand(sql);
      cmd.Execute();
    end;

    macro fillData()
       //получаем список лотов

      /*var con, cmd;
      var statExec = TRUE;
      var RetExec : INTEGER = 0;


      cmd = RsdCommand(/* con,*/ "" );

      cmd.CmdText = "begin ? := user_f657.FetchPortfolioData(?,?); end;";

      cmd.AddParam( "retval", RSDBP_RETVAL, V_INTEGER );
      cmd.addParam( "", RSDBP_IN, repDate );
      cmd.addParam( "", RSDBP_IN, -1  );

      statExec = ExecCommand( cmd, " Заполнение Реестра обязательств. " );

      RetExec = cmd.value( "retval" );

      cmd.close();*/



       /*для счетов*/

       var InvestmentsAccountNumber = "---"; //Номер лицевого счёта

       var AccReserv = "---";
       var AccReserv2732 = "---";
       var ReservAmount2732 = 0;
       var ReservAmount = 0;
       record acnt_ov_negative(account);
       record acnt_ov_positive(account);
       var FIRoleR = null;
       var isQuoted;

       var PereOcenka;
       var BalanceCost;
       var PriceRUR = 0, PriceCUR = 0;
       var MarketPriceRUR = 0, MarketPriceCUR = 0;
       /*-----------*/

       var cmd = rsdCommand(Portfolio()), cmdIns;
       var cnt=0, cntRec;
       var sql;

       /*Числовые значения*/
       var Amount = 0;               //Открытое количество ЦБ
       /*Валюта*/
       var SummaCur = 0;             //Сумма (валюта)
       var NKDCur = 0;               //УНКД с учетом погашенных купонов (валюта)
       var InterestIncomeCur = 0;    //Начисленный купон (валюта)
       var DiscountIncomeCur = 0;       //Начисленный дисконт (валюта)
       var BonusCur = 0;             //Премия (валюта)
       var BalCostCur = 0;           //Балансовая стоимость (валюта)
       var OverAmountCur = 0;        //Переоценка (валюта)
       var ReservAmountCur = 0;      //Резерв (валюта)

       /*Рубли*/
       var SummaRur = 0;             //Сумма
       var NKDRur = 0;               //УНКД с учетом погашенных купонов
       var InterestIncomeRur = 0;    //Начисленный купон
       var DiscountIncomeRur = 0;       //Начисленный дисконт
       var BonusRur = 0;             //Премия
       var BalCostRur = 0;           //Балансовая стоимость
       var OverAmountRur = 0;        //Переоценка
       var ReservAmountRur = 0;      //Резерв

       /*-----------*/
       cntRec=Int(countForProgressBar(Portfolio()));


       InitProgress(cntRec,"Сбор данных по портфелям во временную таблицу","Сбор данных по портфелям во временную таблицу");

       //очистка временной таблицы
       truncateF657TMPTABLE();

       cmd.addParam(":repDate", RSDBP_IN, repDate);
       cmd.Execute();
       var getDataLot = TRsbDataSet(cmd);
       var FD, PortfID;

      /*Счёт из пакета*/
       var statExec = TRUE;
       var RetExec : INTEGER = 0;

       var isBond;
      /*Заполняем временную таблицу для группировки данных*/

      while (getDataLot.MoveNext())
        if (AllowedFIID(getDataLot.FIID))//фильтр по ЦБ
          if ( ПолучитьСделкуПоЛоту(getDataLot, dl_tick, true, true) OR
                   (NOT ПолучитьФинИн( getDataLot.FIID, fininstr, avoiriss ))
                )
                 Group = GetOperationGroup(dl_tick.rec.DealType);
                 /* Получим учетный портфель. */
                PortfID = ПолучитьУчетныйПортфель(getDataLot, Group);
                if( PortfID != PortfID_Undef )

/*--------------------------------------Получаем FD-----------------------------------------------------------------------*/
                    FD = NULL;

                    if( (PortfID == PortfID_Unadmitted_TP) or (PortfID == PortfID_Unadmitted_PPR) or (PortfID == PortfID_Unadmitted_RETIRE) or (PortfID == PortfID_Unadmitted_CONTR) )

                       selectbpp = RSDCommand("select * from dpmwrtsum_dbt where t_SumID = ?");
                       selectbpp.addParam("", RSDBP_IN, getDataLot.Parent);
                       selectbpp.execute();

                       pmwbpp = TRsbDataSet(selectbpp);

                       if( pmwbpp.movenext() )
                          if( ПолучитьСделкуПоЛоту(pmwbpp, dl_tick, true, true) )
                             FD = repSPFirstDoc( dl_tick, false, getDataLot.SumID );
                          end;
                       end;
                    end;

                    if( (PortfID == PortfID_OD_req) or (PortfID == PortfID_OD_com) or (PortfID == PortfID_Back_BPP_KSU))
                       FD = repSPFirstDoc( LEG_KIND_DL_TICK, getDataLot.DealID, getDataLot.SumID );
                    end;

                    if( FD == NULL )
                       LegKind = GetLegKindByLotDeal(getDataLot, dl_tick.rec);
                       IsBack  = (LegKind == LEG_KIND_DL_TICK_BACK);
                       FD = repSPFirstDoc(dl_tick, IsBack, getDataLot.SumID);
                    end;
/*--------------------------------------Получаем FD-----------------------------------------------------------------------*/

                    //Определяем роль финансового инструмента
//println(PortfID);
//println(getDataLot.Portfolio);
                    if( (PortfID == PortfID_Unadmitted_TP) and (getDataLot.Portfolio == KINDPORT_SALE) )
                       FIRoleR = FIROLE_BA_PPR;
                    elif( PortfID == PortfID_Sale )
                       FIRoleR = FIROLE_BA_PPR_BPP;
                    elif( PortfID == PortfID_Retire )
                       FIRoleR = FIROLE_BA_PUDP;
                    elif( PortfID == PortfID_Promissory )
                       FIRoleR = FIROLE_BAINPROMISSORY;
                    elif( (PortfID == PortfID_Contr) or
                          ((PortfID == PortfID_Unadmitted_TP) and (getDataLot.Portfolio == KINDPORT_CONTR))
                        )
                       FIRoleR = FIROLE_BAINCONTR;
                    end;

//                    FIRoleR = GetFIRoleByPortfolio(getDataLot.Portfolio);
//                    FIRoleR = 17;


                    /*Получаем счёт лота*/
                    InvestmentsAccountNumber = MC_GetAccountNumber(
                            IIF((PortfID == KINDPORT_CONTR), "Наш портфель ПКУ, ц/б", "Наш портфель ц/б"),
                            FD,
                            RepDate,
                            1, FD.fininstr.rec.FacevalueFI, FIRoleR
//                            1, FD.fininstr.rec.FacevalueFI, GetFIRoleByPortfolio(getDataLot.Portfolio)
                          );
                    //println(InvestmentsAccountNumber);
                    isBond = checkBond(FD.fininstr.rec.AvoirKind);

                   /*Определяем котируемость бумаги*/
                   if (ExistNOSS(FD.avoiriss, RepDate))
                       isQuoted = 1;
                   else
                       isQuoted = 0;
                   end;

                    /*Определяем f47//открытое количество ЦБ */
                    if( (PortfID == PortfID_OD_req) or (PortfID == PortfID_OD_com) )
                        Amount = getDataLot.AmountBD;
                    else
                        Amount = getDataLot.Amount;
                    end;

                    //f48//сумма = номинал ЦБ * открытое количество ЦБ
                    if(getDataLot.begbonus != 0)
                      SummaCur = Amount * getNominalOnDate(getDataLot.FIID);
                    else
                      SummaCur = getDataLot.Cost;
                    end;

                    /*Получить сумму в рублях*/
                    If (FD.fininstr.rec.FacevalueFI != 0) /*Если валюта номинала не РУБЛИ*/
                      SummaRur = SumConv(
                                        SummaCur,
                                        FD.fininstr.rec.FacevalueFI,
                                        RepDate
                                        );
                    else
                      SummaRur = SummaCur;
                    end;


                    /*Определяем //f49//УНКД с учетом погашенных купонов*/
                    if( (PortfID != PortfID_OD_req) AND (PortfID != PortfID_OD_com) )/*для портфелей +\-ОД колонки по НКД и Затратам пустые*/
                      if(isBond) /*Проверить на бонднонутость*/
                        NKDCur = getdatalot.NKDAmount;
                        /*Получить НКД в рублях*/
                        If (FD.fininstr.rec.FacevalueFI != 0) /*Если валюта номинала не РУБЛИ*/
                          NKDRur = SumConv(
                                            NKDCur,
                                            FD.fininstr.rec.FacevalueFI,
                                            RepDate
                                            );
                        else
                          NKDRur = NKDCur;
                        end;

                      end;
                    end;


                    //println(FD.avoiriss.rec.isin, " -- " ,String(isBond), " -- ", SummaRur);

                    if(FD.fininstr.rec.FacevalueFI != 0) /*Если валюта номинала не РУБЛИ*/
//println("Валюта номинала НЕ РУБЛИ");
                      if(isBond) /*Проверить на бонднонутость*/

                              if( (PortfID == PortfID_Trade) or (PortfID == PortfID_Sale) or (PortfID == PortfID_Retire)
                                    or ( (PortfID == PortfID_Unadmitted) and (getDataLot.Portfolio != KINDPORT_CONTR) )
                                )

                                    /*Определяем УНКД с учётом погашенных купонов*/
                                    InterestIncomeCur = getdatalot.InterestIncome;
                                    InterestIncomeRur = SumConv(
                                                                InterestIncomeCur,
                                                                FD.fininstr.rec.FacevalueFI,
                                                                RepDate
                                                                );

                                    /*Определяем начисленный дисконт*/
                                    DiscountIncomeCur = getdatalot.DiscountIncome;
                                    DiscountIncomeRur = SumConv(
                                                                DiscountIncomeCur,
                                                                FD.fininstr.rec.FacevalueFI,
                                                                RepDate
                                                               );

                                   BonusCUR = getdatalot.BegBonus - getdatalot.Bonus;
                                   BonusRUR = SumConv(
                                                      BonusCUR,
                                                      FD.fininstr.rec.FacevalueFI,
                                                      RepDate
                                                      );
                              end;//проверка на бондонутость

                              /*Под стоимостью вложений будем понимать:
                              ТП, ППР, ПДО, ТП/ППР БПП и т.д. - чистая стоимость (cost) + НКД (NKDAMOUNT)
                              ПВО - проще всего текущую стоимость  - balancecost
                              Под стоимостью в +/-ОД - стоимость в ОД (balancecostbd)
                              Затраты и НКД в +/-ОД не выводятся (по факту затраты в ПВО тоже 0)*/

                              if( (PortfID != PortfID_OD_req) and (PortfID != PortfID_OD_com) and (PortfID != PortfID_Back) )/*для портфелей +\-ОД колонки по НКД и Затратам пустые*/
                                 if( (PortfID == PortfID_Contr) or ( (PortfID == PortfID_Unadmitted)
                                        and (getDataLot.Portfolio == KINDPORT_CONTR) ) )
                                    BalCostRUR = getDataLot.BalanceCost;
                                 else
                                    BalCostCUR = getDataLot.BalanceCost - (getDataLot.begbonus - getDataLot.bonus);
                                 end;
                              elif (PortfID == PortfID_Back)
                                    BalCostCUR = getDataLot.BalanceCost - (getDataLot.begbonus - getDataLot.bonus);
                              elif( (PortfID == PortfID_OD_req) or (PortfID == PortfID_OD_com) )
                                    BalCostCUR = getDataLot.BalanceCostBD;
                              end;

                              if ( NOT ( (PortfID == PortfID_Contr) or ( (PortfID == PortfID_Unadmitted) and (getDataLot.Portfolio == KINDPORT_CONTR) ) ) )
                                 /* Валюта номинала не рубли. */
                                 BalCostRUR = SumConv(
                                                  BalCostCUR,
                                                  FD.fininstr.rec.FacevalueFI,
                                                  RepDate
                                                  );
                              end;

                          end;

                    else /*Если валюта номинала == РУБЛИ*/
//println("Валюта номинала рубли");
                      if(isBond) /*Проверить на бондонутость*/
                           /*ПД для УП "ТП", "ППР", "ПУДП" "БПП", "ПВО"*/
                           /*ДД для УП "ТП", "ППР", "ПУДП" "БПП"*/
                           if( (PortfID == PortfID_Trade) or (PortfID == PortfID_Sale) or (PortfID == PortfID_Retire) or (PortfID == PortfID_Back) or (PortfID == PortfID_Promissory)
                                    or ( (PortfID == PortfID_Unadmitted) and (getDataLot.Portfolio != KINDPORT_CONTR) )
                                )

                              InterestIncomeRUR = getDataLot.InterestIncome;

                              if ( PortfID != PortfID_Back )
                                 DiscountIncomeRUR = getDataLot.DiscountIncome;
                              end;
                           end;

                           BonusRUR = getDataLot.BegBonus - getDataLot.Bonus;
                      end;

                      if( (PortfID != PortfID_OD_req) and (PortfID != PortfID_OD_com) and (PortfID != PortfID_Back) )
                          BalCostRUR = getDataLot.BalanceCost - (getDataLot.begbonus - getDataLot.bonus);
                      elif (PortfID == PortfID_Back)
                          BalCostRUR = getDataLot.BalanceCost - (getDataLot.begbonus - getDataLot.bonus);
                      elif( (PortfID == PortfID_OD_req) or (PortfID == PortfID_OD_com) )
                          BalCostRUR = getDataLot.BalanceCostBD;
                      end;

                    end;/*FD.fininstr.rec.FacevalueFI != 0*/

                    //Резерв
                    ReservAmountCur = getdatalot.ReservAmount;
                    ReservAmountRur = getReservAmountRUR(FD.tick.rec.BOfficeKind, getDataLot.Buy_Sale, getDataLot.DealID, getDataLot.ReservAmount, RepDate);

/*                    println("ReservAmountRur = ",ReservAmountRur);
                    println(FD.tick.rec.BOfficeKind);
                    println(getDataLot.Buy_Sale);
                    println(getDataLot.DealID);
                    println(getDataLot.ReservAmount);*/
                    //Переоценка

                    if( (PortfID == PortfID_Sale) or (PortfID == PortfID_Unadmitted) or (PortfID == PortfID_Back) or (PortfID == PortfID_Trade) )
                      OverAmountRur = getdatalot.OverAmount;
                    elif( (PortfID == PortfID_OD_req) or (PortfID == PortfID_OD_com) )
                      OverAmountRur = getdatalot.OverAmountBD;
                    end;

                    //Балансовая стоимость
                    // if(PereOcenka<0)
                    //    BalCostCur = money(getdatalot.BalanceCost + PereOcenka*(-1))
                    // else
	                   //   BalCostCur = money(getdatalot.BalanceCost)
                    // end;

                    /*вставляем во временную таблицу для группировок*/
/*

                                            println(Amount);                                                         //f47//открытое количество ЦБ
                                            println(SummaCur);                                                //f48//сумма = номинал ЦБ * открытое количество ЦБ
                                            println(NKDCur);                                                  //f49//УНКД с учетом погашенных купонов
                                            println(InterestIncomeCur);                                       //f50//Начисленный купон
                                            println(DiscountIncomeCur);                                       //f51//Начисленный дисконт
                                            println(BonusCur);                                                //f52//Премия
                                            println(BalCostCur);
                                            println(OverAmountCur);
                                            println(ReservAmountCur);
                                            println(SummaRur);                                                //f48//сумма = номинал ЦБ * открытое количество ЦБ
                                            println(NKDRur);                                                  //f49//УНКД с учетом погашенных купонов
                                            println(InterestIncomeRur);                                       //f50//Начисленный купон
                                            println(DiscountIncomeRur);                                       //f51//Начисленный дисконт
                                            println(BonusRur);                                                //f52//Премия
                                            println(BalCostRur);
                                            println(OverAmountRur);
                                            println(ReservAmountRur);                  */
                    BalCostRur = SummaRur  + NKDRur + InterestIncomeRur + DiscountIncomeRur + BonusRur;
                    sql="insert into f657tmpGroupTable values (" +
                                            "'" + InvestmentsAccountNumber +"'," +
                                            PortfID +"," +
                                            getdatalot.fiid +"," +
                                            isQuoted +"," +
                                            getdatalot.t_sumid +"," +
                                            0 +"," +
                                            Amount +"," +                                                         //f47//открытое количество ЦБ
                                            money(SummaCur) +"," +                                                //f48//сумма = номинал ЦБ * открытое количество ЦБ
                                            money(NKDCur) +"," +                                                  //f49//УНКД с учетом погашенных купонов
                                            money(InterestIncomeCur) +"," +                                       //f50//Начисленный купон
                                            money(DiscountIncomeCur) +"," +                                       //f51//Начисленный дисконт
                                            money(BonusCur) +"," +                                                //f52//Премия
                                            money(BalCostCur) +"," +
                                            money(OverAmountCur) +"," +
                                            money(ReservAmountCur) +"," +

                                            money(SummaRur) +"," +                                                //f48//сумма = номинал ЦБ * открытое количество ЦБ
                                            money(NKDRur) +"," +                                                  //f49//УНКД с учетом погашенных купонов
                                            money(InterestIncomeRur) +"," +                                       //f50//Начисленный купон
                                            money(DiscountIncomeRur) +"," +                                       //f51//Начисленный дисконт
                                            money(BonusRur) +"," +                                                //f52//Премия
                                            money(BalCostRur) +"," +
                                            money(OverAmountRur) +"," +
                                            money(ReservAmountRur) +
                                           ")";//рыночная стоимость ценной бумаги (в рублевом эквиваленте)
//println(sql);
                    cmdIns = RsdCommand(sql);
                    cmdIns.Execute;

                end;//PortfID
             end; //фильтр по ЦБ
          end;//ПолучитьСделкуПоЛоту
          cnt=cnt+1;
          UseProgress(cnt);
      end;//While

       RemProgress();
    end;            //macro

    macro printTable()
      var cmd = rsdCommand("select " +
                            "    tmp.t_account, " +
                            "    tmp.t_portfid, " +
                            "    tmp.t_fiid, " +
                            "    tmp.t_isquoted, " +
                            "    sum(tmp.Amount) sum_Amount," +
                            "    sum(tmp.SummaCur) sum_SummaCur," +
                            "    sum(tmp.NKDCur) sum_NKDCur," +
                            "    sum(tmp.InterestIncomeCur) sum_InterestIncomeCur," +
                            "    sum(tmp.DiscountIncomeCur) sum_DiscountIncomeCur," +
                            "    sum(tmp.BonusCur) sum_BonusCur," +
                            "    sum(tmp.BalCostCur) sum_BalCostCur," +
                            "    sum(tmp.OverAmountCur) sum_OverAmountCur," +
                            "    sum(tmp.ReservAmountRur) sum_ReservAmountRur, " +
                            "    sum(tmp.SummaRur) sum_SummaRur," +
                            "    sum(tmp.NKDRur) sum_NKDRur," +
                            "    sum(tmp.InterestIncomeRur) sum_InterestIncomeRur," +
                            "    sum(tmp.DiscountIncomeRur) sum_DiscountIncomeRur," +
                            "    sum(tmp.BonusRur) sum_BonusRur," +
                            "    sum(tmp.BalCostRur) sum_BalCostRur," +
                            "    sum(tmp.OverAmountRur) sum_OverAmountRur," +
                            "    sum(tmp.ReservAmountRur) sum_ReservAmountRur " +
                            "       " +
                            "    from f657tmpGroupTable tmp " +
                            "  group by  " +
                            "    t_fiid, " +
                            "    t_account, " +
                            "    t_portfid, " +
                            "    t_isquoted "
                            );



       cmd.Execute();
       var getMainData = TRsbDataSet(cmd);
       var SumID;

       var cmdLotDetails;
       var dataLotDetails;
       /*резерв*/
       var AccReserv = "---";
       var AccReserv2732 = "---";

       var FIRoleR = null;
       var FD = Null;


       /*Для прогрессбара*/
       var cnt = 0;
       var cntCount = int(countForProgressBar("Select t_account from f657tmpGroupTable group by  " +
                            "    t_fiid, " +
                            "    t_account, " +
                            "    t_portfid, " +
                            "    t_isquoted "));

       InitProgress(cntCount,"Вывод на печать данных по портфелям","Вывод на печать данных по портфелям");

        While(getMainData.MoveNext)
            /*Получаем SUmID первого попавшегося лота для данного fiif, счёта, портфеля и котируемости*/
            SumID = getSumIDFromGroupTmp ( getMainData.t_portfid, getMainData.t_account, getMainData.t_fiid, getMainData.t_isquoted);
            /*Делаем выборку по лоту с найденным SumID*/
            //println("Select *  from ( " + Portfolio() + " ) LotGroup where LotGroup.t_sumid = ?");
            cmdLotDetails = RSDCommand("select * from dpmwrtsum_dbt where t_SumID = ?");
            cmdLotDetails.addParam("", RSDBP_IN, SumID);
            cmdLotDetails.execute();
            dataLotDetails = TRsbDataSet(cmdLotDetails);


            if(dataLotDetails.MoveNext)
    /*--------------------------------------Получаем FD-----------------------------------------------------------------------*/
                FD = NULL;

                if( (getMainData.t_PortfID == PortfID_Unadmitted_TP) or (getMainData.t_PortfID == PortfID_Unadmitted_PPR) or (getMainData.t_PortfID == PortfID_Unadmitted_RETIRE) or (getMainData.t_PortfID == PortfID_Unadmitted_CONTR) )

                   selectbpp = RSDCommand("select * from dpmwrtsum_dbt where t_SumID = ?");
                   selectbpp.addParam("", RSDBP_IN, dataLotDetails.Parent);
                   selectbpp.execute();

                   pmwbpp = TRsbDataSet(selectbpp);

                   if( pmwbpp.movenext() )
                      if( ПолучитьСделкуПоЛоту(pmwbpp, dl_tick, true, true) )
                         FD = repSPFirstDoc( dl_tick, false, dataLotDetails.SumID );
                      end;
                   end;
                end;

                if( (getMainData.t_PortfID == PortfID_OD_req) or (getMainData.t_PortfID == PortfID_OD_com) or (getMainData.t_PortfID == PortfID_Back_BPP_KSU))
                   FD = repSPFirstDoc( LEG_KIND_DL_TICK, dataLotDetails.DealID, dataLotDetails.SumID );
                end;

                if( FD == NULL )
                   LegKind = GetLegKindByLotDeal(dataLotDetails, dl_tick.rec);
                   IsBack  = (LegKind == LEG_KIND_DL_TICK_BACK);
                   FD = repSPFirstDoc(dl_tick, IsBack, dataLotDetails.SumID);
                end;
    /*--------------------------------------Получаем FD-----------------------------------------------------------------------*/

                //Определяем роль финансового инструмента
                if( (getMainData.t_PortfID == PortfID_Unadmitted_TP) and (dataLotDetails.Portfolio == KINDPORT_SALE) )
                   FIRoleR = FIROLE_BA_PPR;
                elif( getMainData.t_PortfID == PortfID_Sale )
                   FIRoleR = FIROLE_BA_PPR_BPP;
                elif( getMainData.t_PortfID == PortfID_Retire )
                   FIRoleR = FIROLE_BA_PUDP;
                elif( getMainData.t_PortfID == PortfID_Promissory )
                   FIRoleR = FIROLE_BAINPROMISSORY;
                elif( (getMainData.t_PortfID == PortfID_Contr) or
                      ((getMainData.t_PortfID == PortfID_Unadmitted_TP) and (dataLotDetails.Portfolio == KINDPORT_CONTR))
                    )
                   FIRoleR = FIROLE_BAINCONTR;
                end;

                /*Счета резервов*/
                AccReserv = MC_GetAccountNumber(
                      "Резерв ц/б",
                      FD,
                      RepDate,
                      1, FD.fininstr.rec.FacevalueFI, FIRoleR
                    );


          //getExtraData = getExtraDataFromTmp ( getMainData.t_portfid, getMainData.t_account, getMainData.t_fiid, getMainData.t_isquoted);

          //if(getExtraData.movenext)

                    printCell(fillColumn01(FD));      //торговый код ценной бумаги
                    printCell("---");
                    printCell(substr(getMainData.t_account,1,5));      //балансовый счет 2-го порядка, категория +ОД
                    printCell(getMainData.t_account);      //лицевой счет вложений
                    printCell(fillColumn04(FD));      //cчет второго порядка первоначального учета
                    printCell(fillColumn05(FD));      //валюта
                    printCell(fillColumn06(FD));      //эмитент
                    printCell(fillColumn07(FD));      //ФО или НФО
                    printCell(fillColumn08(FD));      //cтрана эммитента
                    printCell(fillColumn09(FD));      //страновая оценка
                    printCell(fillColumn10(FD));      //признак международной организации
                    printCell(fillColumn11(FD));
                    printCell(fillColumn12(FD));
                    printCell(fillColumn13(FD));      //тип ценной бумаги
                    printCell(fillColumn14(FD));      //вернуть строку Признак SPV  эмитента (да/нет)
                    printCell(fillColumn15(FD));      //признак ипотечного покрытия (да/нет)
                    printCell(fillColumn16(FD));      //ОКВЭД эмитента
                    printCell(fillColumn17(FD));
                    printCell(fillColumn18(FD));      //рейтинг эмитента (Standart&Poors)
                    printCell(fillColumn19(FD));      //рейтинг эмиссии (Standart&Poors)
                    printCell(fillColumn20(FD));
                    printCell(fillColumn21(FD));
                    printCell(fillColumn22(FD));      //рейтинг эмитента (Moodys)
                    printCell(fillColumn23(FD));      //рейтинг эмиссии (Moodys)
                    printCell(fillColumn24(FD));
                    printCell(fillColumn25(FD));
                    printCell(fillColumn26(FD));      //рейтинг эмитента (Fitch Ratings)
                    printCell(fillColumn27(FD));      //рейтинг эмиссии (Fitch Ratings)
                    printCell(fillColumn28(FD));
                    printCell(fillColumn29(FD));
                    printCell(fillColumn30(FD));      //рейтинг эмитента (АКРА)
                    printCell(fillColumn31(FD));      //рейтинг эмиссии (АКРА)
                    printCell(fillColumn32(FD));      //рейтинг эмитента (Эксперт РА)
                    printCell(fillColumn33(FD));      //рейтинг эмиссии (Эксперт РА)
                    printCell(fillColumn34(FD));      //признак наличия банкротства по эмитенту (да/нет)
                    printCell(fillColumn35(FD));      //№гос. регистрации
                    printCell(fillColumn36(FD));      //isin
                    printCell(fillColumn37(FD));      //обращается на рынке (да/нет)
                    printCell(fillColumn38(FD));      //признак наличия дефолта по выпуску (да/нет)
                    printCell(fillColumn39(FD));      //нахождение в ломбардном списке (да/нет)
                    printCell(fillColumn40(FD));      //признак ипотечного покрытия (да/нет)

                    if(String(fillColumn41(FD)) == " 1.01.0001 (00:00:00.00)")
                      printCell("---");
                    else
                      printCell(Date(fillColumn41(FD)));
                    end; //дата начала размещения

                    if(String(fillColumn42(FD)) == " 1.01.0001 (00:00:00.00)")
                      printCell("---");
                    else
                      printCell(Date(fillColumn42(FD)));
                    end; //дата погашения ЦБ

                    if(String(fillColumn43(FD)) == " 1.01.0001 (00:00:00.00)")
                      printCell("---");
                    else
                      printCell(Date(fillColumn43(FD)));
                    end; //дата погашения купона

                    printCell(fillColumn44(FD));
                    printCell(money(fillColumn45(FD)));                //номинал ЦБ
                    printCell(money(fillColumn46(FD)));                //котировка
                    printCell(money(getMainData.sum_Amount));             //открытое количество ЦБ
                    printCell(money(getMainData.sum_SummaRur));             //сумма = номинал ЦБ * открытое количество ЦБ
                    printCell(money(getMainData.sum_NKDRur));             //УНКД с учетом погашенных купонов
                    printCell(money(getMainData.sum_InterestIncomeRur));             //Начисленный купон
                    printCell(money(getMainData.sum_DiscountIncomeRur));             //Начисленный дисконт
                    printCell(money(getMainData.sum_BonusRur));             //Премия
                    printCell(money(getMainData.sum_BalCostRur));             //Балансовая стоимость RUR
                    printCell(money(getMainData.sum_OverAmountRur));             //Переоценка RUR
                    printCell(fillColumn55(FD));                       //ТСС
                    printCell(money(getMainData.sum_ReservAmountRur));             //Резерв
                    printCell(fillColumn57(FD));                       //
                    printCell(fillColumn58(FD));                       //рыночная стоимость ценной бумаги (в валюте бумаги)
                    printCell(fillColumn59(FD));                       //рыночная стоимость ценной бумаги (в рублевом эквиваленте)
                    printCell(fillColumn60(FD));                       //включение биржей в списки для расчета Индекса ММВБ 50 (да/нет)
                    printCell(fillColumn61(FD));                       //включение биржей в списки для расчета Индекса РТС 50 (да/нет)
                    printCell(fillColumn62(FD));                       //получить значение показателя обесценения
                    printCell(fillColumn63(FD));                       //нахождение в ломбардном списке (да/нет)
                    printCell(fillColumn64(FD));                       //процентная ставка по ЦБ (ставка текущего купона из параметров бумаги)
                    printCell(fillColumn65(FD));                       //cредневзвешенная цена (да/нет)
                    printCell(fillColumn66(FD));                       //511-П_Источник котировки
                    printCell(fillColumn67(FD));                       //511-П_Признак активности и ликвидности рынка (да/нет)
                    printCell(fillColumn68(FD));                       //511-П_Уровень иерархии оценки (1/2/3)
                    printCell(fillColumn69(FD));                       //511-П_Коэффициент ликвидности
                    printCell(fillColumn70(FD));                       //Величина корректировки (511-П)
                    printCell(fillColumn71(FD));                       //Облигации с залоговым обеспечением (да/нет)
                    printCell(fillColumn72(FD));                       //Вложения, которые прямо или через третьих лиц обеспечены гарантией РФ (да/нет)
                    printCell(fillColumn73(FD));
                    printCell(fillColumn74(FD));
                    printCell(fillColumn75(FD));
                    printCell(fillColumn76(FD));
                    printCell(fillColumn77(FD));
                    printCell(fillColumn78(FD));
                    printCell(fillColumn79(FD));
                    printCell(fillColumn80(FD));
                    printCell(fillColumn81(AccReserv2732, AccReserv));     //Лицевой счет резерва
                    printCell(fillColumn82(FD));
                    printCell(fillColumn83(FD));     //Соответствие депозитария критериям п.1.2 Указания 2732-У
                    printCell(fillColumn84(FD));     //Количество дней просрочки
//                    printCell(SumID);
                    printRow();

            // else
            //   msgbox("Дополнительных данных не найдено!!!");
            end; //dataLotDetails.MoveNext

            cnt=cnt+1;
            UseProgress(cnt);
        end;
       RemProgress();
    end;

    /*
    	Вывести заголовок
      UPD 14.11.2024: Переопределение метода из f657.mac
    */
    macro addHeader()
      printEngine.SetValue_NameCell("templateTitle", "Портфель ЦБ на дату: "+repDate);
      //printEngine.CopyAllSheetInTotalBook(null, false, "TemplateHeader", 0, "Ф657_1");
    end;

    /*
	  Добавить ячейку к строке - формируем строку отчёта
     UPD 14.11.2024: Переопределение метода из f657.mac
	*/
	macro printCell(inValue)
		return csvFile.AddCell(inValue);
   end;

    /*
	   Вывести строку
      UPD 14.11.2024: Переопределение метода из f657.mac
    */
    macro printRow()
		  csvFile.AddRow();
    end;

    /*
    	Инциализируем класс Отчёта
      UPD 14.11.2024: Переопределение метода из f657.mac
    */
    macro initRep()
         // DEF-82511
         // printEngine=CTemplateXLS(NULL, NULL, NULL, NULL, NULL, NULL, true, false);
         printEngine = CTemplateSXLSX(NULL);

         csvFile = C_CSVFile();
         fName = csvFile.CreateFullFileName("userF657_1_type1_csv.txt");

         if(printEngine.UsePoi())
            printEngine.SetXLSXFormat();
         end;

         //printEngine.CreateTotalBook();

         printEngine.OpenTemplate("userF657_1_type1.xlsx", true);
         printEngine.SheetChange(1);

         csvTable = printEngine.RegisterTable("templateTable", "templateTableHeader", true);

         if (printEngine.UsePoi())
             csvFile.SetLimitRow(FLUSH_COUNT_XLSX);
         end;

         csvFile.FileOpen(fName, true);
    end;

    /*
    	Показать окно отчёта
      UPD 14.11.2024: Переопределение метода из f657.mac
    */
    macro showRep()
      csvFile.FileClose();
      csvTable.FillTabelFromCSV(csvFile.GetlsFileName());
      csvTable.EndTable();

      //printEngine.CopyAllSheetInTotalBook(null, false, csvTable.GetTableRange(), 0, "Ф657_1");
      printEngine.SaveAsTemplate("Report", true);
      printEngine.Close();

      //printEngine.SaveTotalBook();
    end;

    macro Run ()
      //setoutput("..\\657_1.txt");
      println("Начало выполнения:", String(Date())," -- ", String(Time()));
      dlgInput657(0)=this.repDate;
      dlgInput657(1)=this.Department;
      if (not RunDialog (dlgInput657, @event_dlgInput657))
          exit(1);
      else
          this.repDate=dlgInput657(0);//убрал -1
          this.Department=dlgInput657(1);
          runIndDep(repDate); //загрузка показателей обесценения
          initRep();
          addHeader();
          this.fillData();
          this.printTable();
          showRep();
      end;
      println("Окончание выполнения:", String(Date())," -- ", Time());
    end;



end;

var report = repf657_1();

    //запуск отчёта
    report.Run();

exit();