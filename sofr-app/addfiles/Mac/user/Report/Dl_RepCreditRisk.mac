/*
$Name: Dl_RepCreditRisk.mac
$Module: Ядро Securities
$Description: <Отчеты> / <Расшифровки> / <Форма 155> / флаг <Расшифровки к расчету кредитного риска>
*/
import "mctplprm.mac", "dlquery.mac", "dldlngfun.mac";

PRIVATE CONST MODE_CREDITRISK_ANNEX1 = 1,
              MODE_CREDITRISK_ANNEX2 = 2;

PRIVATE CLASS (DL_CReportTemplate) Dl_RepCreditRisk_Report( RepDate:Date, AnnexMode:Integer, OnlySC:Bool )

  PRIVATE VAR m_RS, m_NumStr = 0,
              m_RepDate = RepDate,
              m_AnnexMode = AnnexMode,
              m_OnlySC = OnlySC,
              m_IsExistsData = false;

  PRIVATE MACRO IIF( condition, value_true, value_false )
    if( condition )
       return value_true;
    else
       return value_false;
    end;
  END;

  PRIVATE MACRO PrintMode():INTEGER
    return DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO BeginReport( NumCopy:INTEGER )
    SetActiveSheet( IIF(m_AnnexMode == MODE_CREDITRISK_ANNEX1, "Приложение 1", "Приложение 2") );
  END;

  PRIVATE MACRO PrintReportHead()
    PrintFormatString(  "",
                        "N1_H1", "Информация о сделках ПФИ для расчета кредитного риска по состоянию на " + m_RepDate
                     );

    if( m_AnnexMode == MODE_CREDITRISK_ANNEX1 )
       RegisterTable( "N1_MainTable", "#",
                      "N1_DealCode", "N1_Contractor", "N1_GenAgr", "N1_IsLiquidNetting", "N1_IsNetting", "N1_InRepository", "N1_PFICategory", "N1_PFISubCategory", "N1_PFIVolType", "N1_DocKindName",
                      "N1_BAKind", "N1_GoodsType", "N1_VolatilityValue", "N1_SecurFlag", "N1_SecurIssuer", "N1_ExecType", "N1_IsExchange", "N1_BuySale", "N1_BankPosition", "N1_StartDate",
                      "N1_EndDate", "N1_StartDateBA", "N1_EndDateBA", "N1_PFINominal", "N1_NominalCurrency", "N1_NumNominalExch", "N1_ReqAcc", "N1_ReqSum", "N1_ReqSumRub", "N1_ReqPmgrSum",
                      "N1_ReqPmgrSumRub", "N1_OblAcc", "N1_OblSum", "N1_OblSumRub", "N1_OblPmgrSum", "N1_OblPmgrSumRub", "N1_FairValueAcc", "N1_FairValueActive", "N1_FairValuePassive", "N1_DateOfInterestRate",
                      "N1_FloatRateAcc", "N1_ReceiveRate", "N1_PayRate", "N1_OptionType", "N1_OptionPrice", "N1_OptionCost", "N1_OptionStyle", "N1_IsMargin", "N1_MarginKind", "N1_MarginFrequency",
                      "N1_MarginLimSum", "N1_MarginLimCurr", "N1_MarginLimSumRub", "N1_MinPaySum", "N1_MinPayCurr", "N1_MinPaySumRub", "N1_SecurityAccVM", "N1_SecuritySumVM", "N1_SecurityCurrVM", "N1_SecuritySumRubVM",
                      "N1_MinRealizPeriod", "N1_FactNumDays", "N1_PretrialSettlement", "N1_ReceivedSecurAcc", "N1_TransferredSecurAcc", "N1_SecuritySumChO", "N1_SecurityCurrChO", "N1_SecuritySumRubChO", "N1_SecurityType", "N1_SecurityISIN",
                      "N1_SecurityIssuer", "N1_ContractorKind", "N1_PeriodCls", "N1_Country", "N1_StandartPoorsRub", "N1_StandartPoorsRub2", "N1_MoodysRub", "N1_MoodysRub2", "N1_FitchRatingsRub", "N1_FitchRatingsRub2",
                      "N1_StandartPoorsCurr", "N1_StandartPoorsCurr2", "N1_MoodysCurr", "N1_MoodysCurr2", "N1_FitchRatingsCurr", "N1_FitchRatingsCurr2",
                      "N1_AkraRatingContr", "N1_ExpRaRatingContr", "N1_NCRRatingContr", "N1_NRARatingContr", "N1_StandartPoorsCountry", "N1_MoodysCountry", "N1_FitchRatingsCountry"
                    );
    else
       RegisterTable( "N1_MainTable", "#",
                      "N1_DealCode", "N1_Contractor", "N1_GenAgr", "N1_IsLiquidNetting", "N1_IsNetting", "N1_InRepository", "N1_PFICategory", "N1_PFISubCategory", "N1_PFIVolType", "N1_DocKindName",
                      "N1_BAKind", "N1_GoodsType", "N1_VolatilityValue", "N1_SecurFlag", "N1_SecurIssuer", "N1_ExecType", "N1_IsExchange", "N1_BuySale", "N1_BankPosition", "N1_StartDate",
                      "N1_EndDate", "N1_StartDateBA", "N1_EndDateBA", "N1_PFINominal", "N1_NominalCurrency", "N1_NumNominalExch", "N1_ReqAcc", "N1_ReqSum", "N1_ReqSumRub", "N1_ReqPmgrSum",
                      "N1_ReqPmgrSumRub", "N1_OblAcc", "N1_OblSum", "N1_OblSumRub", "N1_OblPmgrSum", "N1_OblPmgrSumRub", "N1_FairValueAcc", "N1_FairValueActive", "N1_FairValuePassive", "N1_DateOfInterestRate",
                      "N1_FloatRateAcc", "N1_ReceiveRate", "N1_PayRate", "N1_OptionType", "N1_OptionPrice", "N1_OptionCost", "N1_OptionStyle", "N1_IsMargin", "N1_MarginKind", "N1_MarginFrequency",
                      "N1_MarginLimSum", "N1_MarginLimCurr", "N1_MarginLimSumRub", "N1_MinPaySum", "N1_MinPayCurr", "N1_MinPaySumRub", "N1_SecurityAccVM", "N1_SecuritySumVM", "N1_SecurityCurrVM", "N1_SecuritySumRubVM",
                      "N1_MinRealizPeriod", "N1_FactNumDays", "N1_PretrialSettlement", "N1_ReceivedSecurAcc", "N1_TransferredSecurAcc", "N1_SecuritySumChO", "N1_SecurityCurrChO", "N1_SecuritySumRubChO", "N1_SecurityType", "N1_SecurityISIN",
                      "N1_SecurityIssuer", "N1_ContractorKind", "N1_PeriodCls", "N1_Country", "N1_StandartPoorsRub", "N1_StandartPoorsRub2", "N1_MoodysRub", "N1_MoodysRub2", "N1_FitchRatingsRub", "N1_FitchRatingsRub2",
                      "N1_StandartPoorsCurr", "N1_StandartPoorsCurr2", "N1_MoodysCurr", "N1_MoodysCurr2", "N1_FitchRatingsCurr", "N1_FitchRatingsCurr2", "N1_AkraRatingContr", "N1_ExpRaRatingContr", "N1_NCRRatingContr", "N1_NRARatingContr",
                      "N1_StandartPoorsCountry", "N1_MoodysCountry", "N1_FitchRatingsCountry", "N1_511P_QuotationSource", "N1_511P_ActiveAndLiquid", "N1_511P_HierarchyLevel", "N1_511P_LiquidCoeff", "N1_511P_CorrectionValue"
                    );
    end;
  END;

  PRIVATE MACRO PrintLine()
     var IsMargin = (m_Rs.Margining=="Да");
     var IsPrcSwap = (Index(m_Rs.DocKindName,"Процентный СВОП") != 0);

     PrintTableLine( /*1 */ "N1_DealCode",            m_RS.DealCode,                                            null,
                     /*2 */ "N1_Contractor",          m_RS.ContractorName,                                      null,
                     /*3 */ "N1_GenAgr",              m_RS.GenAgrInfo,                                          null,
                     /*4 */ "N1_IsLiquidNetting",     m_RS.IsLiquidNetting,                                     null,
                     /*5 */ "N1_IsNetting",           m_RS.IsNetting,                                           null,
                     /*6 */ "N1_InRepository",        "",                                                       null, //не заполняется
                     /*7 */ "N1_PFICategory",         m_Rs.PFICategory,                                         null,
                     /*8 */ "N1_PFISubCategory",      m_Rs.PFISubCategory,                                      null,
                     /*9 */ "N1_PFIVolType",          m_Rs.PFIVolType,                                          null,
                     /*10*/ "N1_DocKindName",         m_Rs.DocKindName,                                         null,
                     /*11*/ "N1_BAKind",              m_Rs.BAKind,                                              null,
                     /*12*/ "N1_GoodsType",           m_Rs.GoodsType,                                           null,
                     /*13*/ "N1_VolatilityValue",     "",                                                       null, //не заполняется
                     /*14*/ "N1_SecurFlag",           m_Rs.SecurFlag,                                           null,
                     /*15*/ "N1_SecurIssuer",         m_Rs.SecurIssuer,                                         null,
                     /*16*/ "N1_ExecType",            m_Rs.ExecType,                                            null,
                     /*17*/ "N1_IsExchange",          m_Rs.IsExchange,                                          null,
                     /*18*/ "N1_BuySale",             m_Rs.BuySale,                                             null,
                     /*19*/ "N1_BankPosition",        m_Rs.BankPosition,                                        null,
                     /*20*/ "N1_StartDate",           m_RS.StartDate,                                           null,
                     /*21*/ "N1_EndDate",             SQL_ConvTypeDate(m_RS.EndDate),                           null,
                     /*22*/ "N1_StartDateBA",         SQL_ConvTypeDate(m_RS.StartDateBA),                       null,
                     /*23*/ "N1_EndDateBA",           SQL_ConvTypeDate(m_RS.EndDateBA),                         null,
                     /*24*/ "N1_PFINominal",          abs(m_Rs.PFINominal),                                     null,
                     /*25*/ "N1_NominalCurrency",     m_Rs.NominalCurrency,                                     null,
                     /*26*/ "N1_NumNominalExch",      iif(m_RS.NumNominalExch!=0, m_RS.NumNominalExch, ""),     null,
                     /*27*/ "N1_ReqAcc",              m_Rs.ReqAcc,                                              null,
                     /*28*/ "N1_ReqSum",              iif(m_RS.ReqAcc!="", abs(m_Rs.ReqSum), ""),               null,
                     /*29*/ "N1_ReqSumRub",           iif(m_RS.ReqAcc!="", abs(m_Rs.ReqSumRub), ""),            null,
                     /*30*/ "N1_ReqPmgrSum",          iif(IsPrcSwap, m_Rs.ReqPmgrSum, ""),                      null,
                     /*31*/ "N1_ReqPmgrSumRub",       iif(IsPrcSwap, m_Rs.ReqPmgrSumRub, ""),                   null,
                     /*32*/ "N1_OblAcc",              m_Rs.OblAcc,                                              null,
                     /*33*/ "N1_OblSum",              iif(m_RS.OblAcc!="", m_Rs.OblSum, ""),                    null,
                     /*34*/ "N1_OblSumRub",           iif(m_RS.OblAcc!="", m_Rs.OblSumRub, ""),                 null,
                     /*35*/ "N1_OblPmgrSum",          iif(IsPrcSwap, m_Rs.OblPmgrSum, ""),                      null,
                     /*36*/ "N1_OblPmgrSumRub",       iif(IsPrcSwap, m_Rs.OblPmgrSumRub, ""),                   null,
                     /*37*/ "N1_FairValueAcc",        m_Rs.FairValueAcc,                                        null,
                     /*38*/ "N1_FairValueActive",     iif(m_RS.FairValueActive!=0, abs(m_Rs.FairValueActive), ""), null,
                     /*39*/ "N1_FairValuePassive",    iif(m_RS.FairValuePassive!=0, abs(m_Rs.FairValuePassive), ""), null,
                     /*40*/ "N1_DateOfInterestRate",  SQL_ConvTypeDate(m_Rs.DateOfInterestRate),                null,
                     /*41*/ "N1_FloatRateAcc",        m_Rs.FloatRateAcc,                                        null,
                     /*42*/ "N1_ReceiveRate",         iif(IsPrcSwap, iif(m_Rs.ReceiveRateType=="",String(ЧислоCЗаданнойТочностью(m_Rs.ReceiveFixRate,m_Rs.ReceiveFixRatePoint)),m_Rs.ReceiveRateType), ""), iif(IsPrcSwap and (m_Rs.ReceiveRateType==""),m_Rs.ReceiveFixRatePoint,null),
                     /*43*/ "N1_PayRate",             iif(IsPrcSwap, iif(m_Rs.PayRateType=="",String(ЧислоCЗаданнойТочностью(m_Rs.PayFixRate,m_Rs.PayFixRatePoint)),m_Rs.PayRateType), ""), iif(IsPrcSwap and (m_Rs.PayRateType==""),m_Rs.PayFixRatePoint,null),
                     /*44*/ "N1_OptionType",          m_Rs.OptionType,                                          null,
                     /*45*/ "N1_OptionPrice",         iif((m_Rs.OptionType!="")and(m_RS.OptionPrice>=0), String(ЧислоCЗаданнойТочностью(m_RS.OptionPrice,m_RS.OptionPricePoint)), ""), iif((m_Rs.OptionType!="")and(m_RS.OptionPrice>=0), m_RS.OptionPricePoint, null),
                     /*46*/ "N1_OptionCost",          iif((m_Rs.OptionType!="")and(m_RS.OptionCost!=-1), String(ЧислоCЗаданнойТочностью(m_RS.OptionCost,m_RS.OptionCostPoint)), ""), iif((m_Rs.OptionType!="")and(m_RS.OptionCost!=-1), m_RS.OptionCostPoint, null),
                     /*47*/ "N1_OptionStyle",         m_Rs.OptionStyle,                                         null,
                     /*48*/ "N1_IsMargin",            m_Rs.Margining,                                           null,
                     /*49*/ "N1_MarginKind",          m_Rs.MarginKind,                                          null,
                     /*50*/ "N1_MarginFrequency",     iif(IsMargin and (m_Rs.MarginFrequency>=0), m_Rs.MarginFrequency, ""), null,
                     /*51*/ "N1_MarginLimSum",        iif(IsMargin, m_Rs.PartyMarginLimSum, ""),                null,
                     /*52*/ "N1_MarginLimCurr",       m_Rs.PartyMarginLimCurr,                                  null,
                     /*53*/ "N1_MarginLimSumRub",     iif(IsMargin, m_Rs.PartyMarginLimSumRub, ""),             null,
                     /*54*/ "N1_MinPaySum",           iif(IsMargin, m_Rs.PartyMinPaySum, ""),                   null,
                     /*55*/ "N1_MinPayCurr",          m_Rs.PartyMinPayCurr,                                     null,
                     /*56*/ "N1_MinPaySumRub",        iif(IsMargin, m_Rs.PartyMinPaySumRub, ""),                null,
                     /*57*/ "N1_SecurityAccVM",       m_Rs.SecurityAcc,                                         null,
                     /*58*/ "N1_SecuritySumVM",       iif(IsMargin, m_Rs.SecuritySum, ""),                      null,
                     /*59*/ "N1_SecurityCurrVM",      m_Rs.SecurityCurr,                                        null,
                     /*60*/ "N1_SecuritySumRubVM",    iif(IsMargin, m_Rs.SecuritySumRub, ""),                   null,
                     /*61*/ "N1_MinRealizPeriod",     "",                                                       null, //не заполняется
                     /*62*/ "N1_FactNumDays",         iif(IsMargin and (m_Rs.FactNumDays>=0), m_Rs.FactNumDays, ""), null,
                     /*63*/ "N1_PretrialSettlement",  "",                                                       null, //не заполняется
                     /*64*/ "N1_ReceivedSecurAcc",    m_Rs.ReceivedSecurAcc,                                    null,
                     /*65*/ "N1_TransferredSecurAcc", m_Rs.TransferredSecurAcc,                                 null,
                     /*66*/ "N1_SecuritySumChO",      iif(IsMargin, m_Rs.SecuritySum2, ""),                     null,
                     /*67*/ "N1_SecurityCurrChO",     m_Rs.SecurityCurr2,                                       null,
                     /*68*/ "N1_SecuritySumRubChO",   iif(IsMargin, m_Rs.SecuritySumRub2, ""),                  null,
                     /*69*/ "N1_SecurityType",        m_Rs.SecurityType,                                        null,
                     /*70*/ "N1_SecurityISIN",        "",                                                       null, //не заполняется
                     /*71*/ "N1_SecurityIssuer",      "",                                                       null, //не заполняется
                     /*72*/ "N1_ContractorKind",      m_Rs.ContractorKind,                                      null,
                     /*73*/ "N1_PeriodCls",           m_Rs.PeriodCls,                                           null,
                     /*74*/ "N1_Country",             m_Rs.Country,                                             null,
                     /*75*/ "N1_StandartPoorsRub",    m_Rs.StandartPoorsRub,                                    null,
                     /*76*/ "N1_StandartPoorsRub2",   m_Rs.StandartPoorsRub2,                                   null,
                     /*77*/ "N1_MoodysRub",           m_Rs.MoodysRub,                                           null,
                     /*78*/ "N1_MoodysRub2",          m_Rs.MoodysRub2,                                          null,
                     /*79*/ "N1_FitchRatingsRub",     m_Rs.FitchRatingsRub,                                     null,
                     /*80*/ "N1_FitchRatingsRub2",    m_Rs.FitchRatingsRub2,                                    null,
                     /*81*/ "N1_StandartPoorsCurr",   m_Rs.StandartPoorsCurr,                                   null,
                     /*82*/ "N1_StandartPoorsCurr2",  m_Rs.StandartPoorsCurr2,                                  null,
                     /*83*/ "N1_MoodysCurr",          m_Rs.MoodysCurr,                                          null,
                     /*84*/ "N1_MoodysCurr2",         m_Rs.MoodysCurr2,                                         null,
                     /*85*/ "N1_FitchRatingsCurr",    m_Rs.FitchRatingsCurr,                                    null,
                     /*86*/ "N1_FitchRatingsCurr2",   m_Rs.FitchRatingsCurr2,                                   null,
                     /*87*/ "N1_AkraRatingContr",     m_Rs.AKRARating,                                          null,
                     /*88*/ "N1_ExpRaRatingContr",    m_Rs.ExpertRating,                                        null,
                     /*89*/ "N1_NCRRatingContr",      m_Rs.NRCRating,                                           null,
                     /*90*/ "N1_NRARatingContr",      m_Rs.NRARating,                                           null,
                     /*91*/ "N1_StandartPoorsCountry",m_Rs.StandartPoorsCountry,                                null,
                     /*92*/ "N1_MoodysCountry",       m_Rs.MoodysCountry,                                       null,
                     /*93*/ "N1_FitchRatingsCountry", m_Rs.FitchRatingsCountry,                                 null
                   );
     m_NumStr = m_NumStr + 1;
  END;

  PRIVATE MACRO PrintLine_Annex2()
     var IsMargin = (m_Rs.Margining=="Да");
     var IsPrcSwap = (Index(m_Rs.DocKindName,"Процентный СВОП") != 0);

     PrintTableLine( /*1 */ "N1_DealCode",            m_RS.DealCode,                                            null,
                     /*2 */ "N1_Contractor",          m_RS.ContractorName,                                      null,
                     /*3 */ "N1_GenAgr",              m_RS.GenAgrInfo,                                          null,
                     /*4 */ "N1_IsLiquidNetting",     m_RS.IsLiquidNetting,                                     null,
                     /*5 */ "N1_IsNetting",           m_RS.IsNetting,                                           null,
                     /*6 */ "N1_InRepository",        "",                                                       null, //не заполняется
                     /*7 */ "N1_PFICategory",         m_Rs.PFICategory,                                         null,
                     /*8 */ "N1_PFISubCategory",      m_Rs.PFISubCategory,                                      null,
                     /*9 */ "N1_PFIVolType",          m_Rs.PFIVolType,                                          null,
                     /*10*/ "N1_DocKindName",         m_Rs.DocKindName,                                         null,
                     /*11*/ "N1_BAKind",              m_Rs.BAKind,                                              null,
                     /*12*/ "N1_GoodsType",           m_Rs.GoodsType,                                           null,
                     /*13*/ "N1_VolatilityValue",     "",                                                       null, //не заполняется
                     /*14*/ "N1_SecurFlag",           m_Rs.SecurFlag,                                           null,
                     /*15*/ "N1_SecurIssuer",         m_Rs.SecurIssuer,                                         null,
                     /*16*/ "N1_ExecType",            m_Rs.ExecType,                                            null,
                     /*17*/ "N1_IsExchange",          m_Rs.IsExchange,                                          null,
                     /*18*/ "N1_BuySale",             m_Rs.BuySale,                                             null,
                     /*19*/ "N1_BankPosition",        m_Rs.BankPosition,                                        null,
                     /*20*/ "N1_StartDate",           m_RS.StartDate,                                           null,
                     /*21*/ "N1_EndDate",             SQL_ConvTypeDate(m_RS.EndDate),                           null,
                     /*22*/ "N1_StartDateBA",         SQL_ConvTypeDate(m_RS.StartDateBA),                       null,
                     /*23*/ "N1_EndDateBA",           SQL_ConvTypeDate(m_RS.EndDateBA),                         null,
                     /*24*/ "N1_PFINominal",          abs(m_Rs.PFINominal),                                     null,
                     /*25*/ "N1_NominalCurrency",     m_Rs.NominalCurrency,                                     null,
                     /*26*/ "N1_NumNominalExch",      iif(m_RS.NumNominalExch!=0, m_RS.NumNominalExch, ""),     null,
                     /*27*/ "N1_ReqAcc",              m_Rs.ReqAcc,                                              null,
                     /*28*/ "N1_ReqSum",              iif(m_RS.ReqAcc!="", abs(m_Rs.ReqSum), ""),               null,
                     /*29*/ "N1_ReqSumRub",           iif(m_RS.ReqAcc!="", abs(m_Rs.ReqSumRub), ""),            null,
                     /*30*/ "N1_ReqPmgrSum",          iif(IsPrcSwap, m_Rs.ReqPmgrSum, ""),                      null,
                     /*31*/ "N1_ReqPmgrSumRub",       iif(IsPrcSwap, m_Rs.ReqPmgrSumRub, ""),                   null,
                     /*32*/ "N1_OblAcc",              m_Rs.OblAcc,                                              null,
                     /*33*/ "N1_OblSum",              iif(m_RS.OblAcc!="", m_Rs.OblSum, ""),                    null,
                     /*34*/ "N1_OblSumRub",           iif(m_RS.OblAcc!="", m_Rs.OblSumRub, ""),                 null,
                     /*35*/ "N1_OblPmgrSum",          iif(IsPrcSwap, m_Rs.OblPmgrSum, ""),                      null,
                     /*36*/ "N1_OblPmgrSumRub",       iif(IsPrcSwap, m_Rs.OblPmgrSumRub, ""),                   null,
                     /*37*/ "N1_FairValueAcc",        m_Rs.FairValueAcc,                                        null,
                     /*38*/ "N1_FairValueActive",     iif(m_RS.FairValueActive!=0, abs(m_Rs.FairValueActive), ""), null,
                     /*39*/ "N1_FairValuePassive",    iif(m_RS.FairValuePassive!=0, abs(m_Rs.FairValuePassive), ""), null,
                     /*40*/ "N1_DateOfInterestRate",  SQL_ConvTypeDate(m_Rs.DateOfInterestRate),                null,
                     /*41*/ "N1_FloatRateAcc",        m_Rs.FloatRateAcc,                                        null,
                     /*42*/ "N1_ReceiveRate",         iif(IsPrcSwap, iif(m_Rs.ReceiveRateType=="",String(ЧислоCЗаданнойТочностью(m_Rs.ReceiveFixRate,m_Rs.ReceiveFixRatePoint)),m_Rs.ReceiveRateType), ""), iif(IsPrcSwap and (m_Rs.ReceiveRateType==""),m_Rs.ReceiveFixRatePoint,null),
                     /*43*/ "N1_PayRate",             iif(IsPrcSwap, iif(m_Rs.PayRateType=="",String(ЧислоCЗаданнойТочностью(m_Rs.PayFixRate,m_Rs.PayFixRatePoint)),m_Rs.PayRateType), ""), iif(IsPrcSwap and (m_Rs.PayRateType==""),m_Rs.PayFixRatePoint,null),
                     /*44*/ "N1_OptionType",          m_Rs.OptionType,                                          null,
                     /*45*/ "N1_OptionPrice",         iif((m_Rs.OptionType!="")and(m_RS.OptionPrice>=0), String(ЧислоCЗаданнойТочностью(m_RS.OptionPrice,m_RS.OptionPricePoint)), ""), iif((m_Rs.OptionType!="")and(m_RS.OptionPrice>=0), m_RS.OptionPricePoint, null),
                     /*46*/ "N1_OptionCost",          iif((m_Rs.OptionType!="")and(m_RS.OptionCost!=-1), String(ЧислоCЗаданнойТочностью(m_RS.OptionCost,m_RS.OptionCostPoint)), ""), iif((m_Rs.OptionType!="")and(m_RS.OptionCost!=-1), m_RS.OptionCostPoint, null),
                     /*47*/ "N1_OptionStyle",         m_Rs.OptionStyle,                                         null,
                     /*48*/ "N1_IsMargin",            m_Rs.Margining,                                           null,
                     /*49*/ "N1_MarginKind",          m_Rs.MarginKind,                                          null,
                     /*50*/ "N1_MarginFrequency",     iif(IsMargin and (m_Rs.MarginFrequency>=0), m_Rs.MarginFrequency, ""), null,
                     /*51*/ "N1_MarginLimSum",        iif(IsMargin, m_Rs.PartyMarginLimSum, ""),                null,
                     /*52*/ "N1_MarginLimCurr",       m_Rs.PartyMarginLimCurr,                                  null,
                     /*53*/ "N1_MarginLimSumRub",     iif(IsMargin, m_Rs.PartyMarginLimSumRub, ""),             null,
                     /*54*/ "N1_MinPaySum",           iif(IsMargin, m_Rs.PartyMinPaySum, ""),                   null,
                     /*55*/ "N1_MinPayCurr",          m_Rs.PartyMinPayCurr,                                     null,
                     /*56*/ "N1_MinPaySumRub",        iif(IsMargin, m_Rs.PartyMinPaySumRub, ""),                null,
                     /*57*/ "N1_SecurityAccVM",       m_Rs.SecurityAcc,                                         null,
                     /*58*/ "N1_SecuritySumVM",       iif(IsMargin, m_Rs.SecuritySum, ""),                      null,
                     /*59*/ "N1_SecurityCurrVM",      m_Rs.SecurityCurr,                                        null,
                     /*60*/ "N1_SecuritySumRubVM",    iif(IsMargin, m_Rs.SecuritySumRub, ""),                   null,
                     /*61*/ "N1_MinRealizPeriod",     "",                                                       null, //не заполняется
                     /*62*/ "N1_FactNumDays",         iif(IsMargin and (m_Rs.FactNumDays>=0), m_Rs.FactNumDays, ""), null,
                     /*63*/ "N1_PretrialSettlement",  "",                                                       null, //не заполняется
                     /*64*/ "N1_ReceivedSecurAcc",    m_Rs.ReceivedSecurAcc,                                    null,
                     /*65*/ "N1_TransferredSecurAcc", m_Rs.TransferredSecurAcc,                                 null,
                     /*66*/ "N1_SecuritySumChO",      iif(IsMargin, m_Rs.SecuritySum2, ""),                     null,
                     /*67*/ "N1_SecurityCurrChO",     m_Rs.SecurityCurr2,                                       null,
                     /*68*/ "N1_SecuritySumRubChO",   iif(IsMargin, m_Rs.SecuritySumRub2, ""),                  null,
                     /*69*/ "N1_SecurityType",        m_Rs.SecurityType,                                        null,
                     /*70*/ "N1_SecurityISIN",        "",                                                       null, //не заполняется
                     /*71*/ "N1_SecurityIssuer",      "",                                                       null, //не заполняется
                     /*72*/ "N1_ContractorKind",      m_Rs.ContractorKind,                                      null,
                     /*73*/ "N1_PeriodCls",           m_Rs.PeriodCls,                                           null,
                     /*74*/ "N1_Country",             m_Rs.Country,                                             null,
                     /*75*/ "N1_StandartPoorsRub",    m_Rs.StandartPoorsRub,                                    null,
                     /*76*/ "N1_StandartPoorsRub2",   m_Rs.StandartPoorsRub2,                                   null,
                     /*77*/ "N1_MoodysRub",           m_Rs.MoodysRub,                                           null,
                     /*78*/ "N1_MoodysRub2",          m_Rs.MoodysRub2,                                          null,
                     /*79*/ "N1_FitchRatingsRub",     m_Rs.FitchRatingsRub,                                     null,
                     /*80*/ "N1_FitchRatingsRub2",    m_Rs.FitchRatingsRub2,                                    null,
                     /*81*/ "N1_StandartPoorsCurr",   m_Rs.StandartPoorsCurr,                                   null,
                     /*82*/ "N1_StandartPoorsCurr2",  m_Rs.StandartPoorsCurr2,                                  null,
                     /*83*/ "N1_MoodysCurr",          m_Rs.MoodysCurr,                                          null,
                     /*84*/ "N1_MoodysCurr2",         m_Rs.MoodysCurr2,                                         null,
                     /*85*/ "N1_FitchRatingsCurr",    m_Rs.FitchRatingsCurr,                                    null,
                     /*86*/ "N1_FitchRatingsCurr2",   m_Rs.FitchRatingsCurr2,                                   null,
                     /*87*/ "N1_AkraRatingContr",     m_Rs.AKRARating,                                          null,
                     /*88*/ "N1_ExpRaRatingContr",    m_Rs.ExpertRating,                                        null,
                     /*89*/ "N1_NCRRatingContr",      m_Rs.NRCRating,                                           null,
                     /*90*/ "N1_NRARatingContr",      m_Rs.NRARating,                                           null,
                     /*91*/ "N1_StandartPoorsCountry",m_Rs.StandartPoorsCountry,                                null,
                     /*92*/ "N1_MoodysCountry",       m_Rs.MoodysCountry,                                       null,
                     /*93*/ "N1_FitchRatingsCountry", m_Rs.FitchRatingsCountry,                                 null,
                     /*94*/ "N1_511P_QuotationSource","",                                                       null, //не заполняется
                     /*95*/ "N1_511P_ActiveAndLiquid","",                                                       null, //не заполняется
                     /*96*/ "N1_511P_HierarchyLevel", "",                                                       null, //не заполняется
                     /*97*/ "N1_511P_LiquidCoeff",    "",                                                       null, //не заполняется
                     /*98*/ "N1_511P_CorrectionValue","",                                                       null  //не заполняется
                   );
     m_NumStr = m_NumStr + 1;
  END;

  MACRO CreateData_DV_NDEAL()
     var sql, exec;
     InitProgress(-1, "Подготовка данных по внебиржевым сделкам модуля \"ФИССиКО\"", "Подготовка данных по внебиржевым сделкам модуля \"ФИССиКО\"");
     sql = "DECLARE "
         + "BEGIN "
         + "    rsb_dl_pficreditrisk.CreateData_DV_NDEAL(?);"
         + "END; ";

     exec = RSDCommand(sql);
     exec.AddParam("", RSDBP_IN, m_RepDate);
     exec.execute();

     RemProgress();
  END;

  MACRO CreateData_DV_POS()
     var sql, exec;
     InitProgress(-1, "Подготовка данных по позициям модуля \"ФИССиКО\"", "Подготовка данных по позициям модуля \"ФИССиКО\"");
     sql = "DECLARE "
         + "BEGIN "
         + "    rsb_dl_pficreditrisk.CreateData_DV_POS(?);"
         + "END; ";

     exec = RSDCommand(sql);
     exec.AddParam("", RSDBP_IN, m_RepDate);
     exec.execute();

     RemProgress();
  END;

  MACRO CreateData_SC()
     var sql, exec;
     InitProgress(-1, "Подготовка данных по сделкам модуля \"Бэк-офис ценных бумаг\"", "Подготовка данных по сделкам модуля \"Бэк-офис ценных бумаг\"");
     sql = "DECLARE "
         + "BEGIN "
         + "    rsb_dl_pficreditrisk.CreateData_SC(?);"
         + "END; ";

     exec = RSDCommand(sql);
     exec.AddParam("", RSDBP_IN, m_RepDate);
     exec.execute();

     RemProgress();
  END;

  MACRO PrintData()
     var query, cnt = 0;
     var ProgressIndicator = TProgressBar();
     var cmd = DL_RSDCommand();
     query = "select tmp.* from ddl_pficreditrisk_tmp tmp "
           + "  order by tmp.t_GenAgrInfo, tmp.t_PFICategory, "
           + "           case when tmp.t_PFICategory = 'Товарные' then tmp.t_PFISubCategory "
           + "                else (case when tmp.t_Part = 2 then NVL((select t2.t_NominalCurrency "
           + "                                                           from ddl_pficreditrisk_tmp t2 "
           + "                                                          where t2.t_DealID = tmp.t_DealID "
           + "                                                            and t2.t_DocKind = tmp.t_DocKind "
           + "                                                            and t2.t_Part = 0 ), tmp.t_NominalCurrency) "
           + "                           else tmp.t_NominalCurrency "
           + "                      end) "
           + "           end, "
           + "           tmp.t_DealCode, tmp.t_Part ";

     cnt = cmd.GetCount(query);
     if( cnt > 0 )
        ProgressIndicator.init(cnt, "Вывод данных в отчет", "Вывод данных в отчет");
        PrintReportHead();
        m_IsExistsData = true;
        m_RS = cmd.execute(query);

        while( m_RS.MoveNext() )
           if( m_AnnexMode == MODE_CREDITRISK_ANNEX1 )
              PrintLine();
           else
              PrintLine_Annex2();
           end;
           ProgressIndicator.Use;
        end;

        ProgressIndicator.Remove;
     end;
  END;

  PRIVATE MACRO Create()
     SetXLSXFormat();

     m_IsExistsData = false;
     SQL_Truncate( "ddl_pficreditrisk_tmp" );

     if( not m_OnlySC )
        CreateData_DV_NDEAL();
        CreateData_DV_POS();
     end;
     CreateData_SC();

     PrintData();
  END;

  PRIVATE MACRO EndReport()
     if( m_IsExistsData )
        EndTable();
     else
        msgbox("Нет данных для формирования отчета.");
     end;
  END;

  initDL_CReportTemplate( null, IIF(m_AnnexMode == MODE_CREDITRISK_ANNEX1, "Report_CreditRisk.xlsx", "Report_CreditRisk2.xlsx"), null, null, null, true, false );
END;

MACRO CreditRisk_RunReport( RepDate:DATE, AnnexMode:INTEGER, OnlySC:BOOL )
  if( ValType(AnnexMode) == V_UNDEF )
     AnnexMode = MODE_CREDITRISK_ANNEX1;
  end;
  if( ValType(OnlySC) == V_UNDEF )
     OnlySC = false;
  end;
  Dl_RepCreditRisk_Report( RepDate, AnnexMode, OnlySC ).Run();
  Dl_CallInsertStat( DL_OUTREPORT_EXCEL );
  exit(1);
END;
