/*
Добавление примечания в заявки клиента на сделку
*/
import activex, oralib, likepy, BankInter, DVInter, globals, rsd,RsbDataSet, PTInter,CTinter;

private const DEALID    = 1,
              VALUE_    = 2;

private macro iif(a,b,c)
    if(a)
        return b;
    else
        return c;
    end;
end;

macro Load_Note()
  var row = 1;
  var cmd,cmd1;
  var result,result1;
  var dvdeal    = TRecHandler("dvdeal.dbt");

  DVDeal.Clear();
  if ( not execSqlSelect ("select 1 from dnotekind_dbt where t_objecttype = 140 and t_notekind = 102").moveNext () )
        if ( not execSql ("insert into dnotekind_dbt values (140, 102, 7, 'Тип заявки на бирже', chr (0), chr (0), chr (0), 0, chr (0), chr (1), 0, chr (0))") )
            return false;
        end;
  end;
  InitProgress(-1);
  row=0;

 cmd1 = RSDCommand( "  SELECT  "+
     " (SELECT t1.t_stringval FROM dgtrecprm_dbt t1 WHERE t1.t_recordid= req.t_recordid AND t1.t_koprmid=103 ) codeD, "+
     " (SELECT t2.t_intval FROM dgtrecprm_dbt t2 WHERE t2.t_recordid= req.t_recordid AND t2.t_koprmid=701 ) typeD "+
     " FROM             "+ 
     " (SELECT /*+FIRST_ROWS*/ t.t_recordid    "+
     " FROM dgtrecord_dbt t, dgtobject_dbt gt_objsc,  "+
     " dgtkact_dbt gtkact, dgtkobj_dbt gtkobj, dgtstatus_dbt gtstatus,  "+
     " dgtrsbankcode_dbt RsCode, dgtapp_dbt Src, dgtapp_dbt Tgt    "+
     " WHERE  ( gtkobj.t_Code=86 ) AND  (t.t_APPLICATIONID_TO=11 AND t.t_StatusID=gtstatus.t_StatusID(+)  "+
     " AND t.t_ActionID=gtkact.t_ActionID(+) AND t.t_ObjectID=gt_objsc.t_ObjectID(+)   "+
     " AND gt_objsc.t_ObjectKind=gtkobj.t_ObjectKind(+) AND t.t_ApplicationID_From=Src.t_ApplicationID(+)   "+
     " AND t.t_ApplicationID_To=Tgt.t_ApplicationID(+) AND t.t_ObjectID=RsCode.t_ObjectID(+))) req  "+
     " WHERE  NVL( (SELECT t3.t_intval FROM dgtrecprm_dbt t3 WHERE t3.t_recordid= req.t_recordid AND t3.t_koprmid=701 ),55)<>55 "
                     ); 
   cmd1.execute();
   result1 = TRsbDataSet(cmd1);

  while (result1.movenext())
    UseProgress(row);
    cmd = RSDCommand( "  SELECT dvdeal.*  "+
                      "   FROM ddvdeal_dbt DVDeal  "+
                      "   WHERE  DVDeal.t_code=TRIM(:Cod) ");
    cmd.addParam( "Cod", RSDBP_IN, result1.value(0));
    cmd.execute();
    result = TRsbDataSet(cmd);

    if (result.movenext())
      result.Getrecord().Copyto(dvdeal.rec);
         if( addNoteForObject( 140,
                               UniID(dvdeal, 140),
                               102,
                               iif(result1.value(1)==0,"Безадресная заявка", iif(result1.value(1)==1,"Результат экспирации","Адресная заявка")),
                               dvdeal.rec.Date )
           )
             Println("Ошибка при установке примечания \"Тип заявки на бирже\" для объекта " + result1.value(0));
             
         end;
    end;  
     DVDeal.Clear();  
    row = row + 1;
  end;
  RemProgress();
  Println("Обработано строк : " + row); 
  EndAction(1);
onerror()
  EndAction(1);
End;

load_note();