import календарь, oralib, likepy, globals;

Private macro IIF(condition, value_true, value_false)
  If(condition)
    return value_true;
  else
    return value_false;
  end;
end;

//Simanov. Пользовательская функция. День с видом обслуживания "Розничное" считается рабочим
macro usr_GetDateAfterWorkDays (_dt, DayOffset, CalendarID)
  var dt = execStoredFunc("RSI_RsbCalendar_User.GetDateAfterWorkDay", V_DATE,
                           makeArray( sqlParam("1", _dt, RSDBP_IN), sqlParam("2", DayOffset,  RSDBP_IN), sqlParam("3", CalendarID, RSDBP_IN)));
  return dt;
End;

var DepID:integer = 1;
var dt = Date();
var DptCount = 97;//Количество филиалов для обработки

/* Golovkin 08.04.2021 ID : 522270 изменил на 40 Календарь сервисных операций БОЦБ, т.к. только в этом календаре стоит обслуживание по субботам */
if ( usr_GetDateAfterWorkDays (dt, 0, 40) != dt ) //выходной  /* Golovkin 08.04.2021 ID : 522270 Было 10002, потом 0, стало 40 */
  DptCount = 1;
end;
var nextworkdate = usr_GetDateAfterWorkDays (dt, 1, 40);     /* Golovkin 08.04.2021 ID : 522270 Было 10002, потом 0, стало 40 */
var secondworkdate = usr_GetDateAfterWorkDays (dt, 2, 40);   /* Golovkin 08.04.2021 ID : 522270 Было 10002, потом 0, стало 40 */

setDialogFlag (0);
while (DepID <= DptCount)
  //День уже открыт, устанавливается текущий день
  if ( execSqlSelect ("select 1 from dcurdate_dbt where t_curdate=:1 and t_branch=:2", makeArray (sqlParam ("1", dt), sqlParam("2", DepID))).moveNext () ) // уже открыт
    execSql ("begin update dcurdate_dbt set t_ismain = chr (0) where t_ismain='X' and t_branch=:1; update dcurdate_dbt set t_ismain ='X' where t_curdate = :2 and t_branch=:3; end;",
             makeArray (sqlParam("1", DepID), sqlParam ("2", dt), sqlParam("3", DepID)), false);
    setOperDay (dt);
  elif ( cb_OpenDate (DepID, dt)) //Открывается день и устанавливается текущий
    execSql ("begin update dcurdate_dbt set t_ismain = chr (0) where t_ismain = 'X' and t_branch=:1; update dcurdate_dbt set t_ismain = 'X' where t_curdate = :2 and t_branch=:3; end;",
             makeArray (sqlParam("1", DepID), sqlParam ("2", dt), sqlParam("3", DepID)), false);
    setOperDay (dt);
  end;

  //открывается следующий рабочий день i-support 507557
  cb_OpenDate (DepID, IIF(DepID == 1, dt+1, nextworkdate));
  cb_OpenDate (DepID, IIF(DepID == 1, dt+2, secondworkdate));

  DepID = DepID + 1;
end;
exit (1);