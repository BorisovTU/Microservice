/*
$Name:        paymswift_sp.mac
$Description: Работа с платежами
$Programmer:  Кротов А.
*/
import dlquery;
import captureoutput;
import oprinter, payminter;


/*Вставка/удаление SWIFT сообщения по платежу на постобработке выполнения/отката шага*/
macro PostStepSWIFT(CommitOrRollback, /*1-выполнение шага,2 -откат шага*/
                    errTrn,           /* Статус выполнения шага-!0-произошла ошибка */
                    FirstDoc,         /* Указатель на первичный документ */
                    ID_Operation,     /* Номер экземпляра операции */
                    Num_Step,         /* Номер шага операции(из настроек) */
                    Kind_Operation,   /* Вид операции */
                    KindDoc,          /* Вид первичного документа */
                    KindStep,         /* Вид шага операции */
                    ID_Step)
  record tick(dl_tick);
  var cmdPM, rsPM = null, contrid = null;

  /*При ошибке ничего не делаем*/
  if(errTrn)
    return;
  end;

  /*Ищем платежи*/
  if((KindDoc == DL_SECURITYDOC /*Покупка/продажа ц/б*/) or (KindDoc == 107 /*Документ свертки*/) or (KindDoc == 4607 /*Списание/зачисление денежных*/))
    SetBuff(tick, FirstDoc);
    /*Выполнение шага*/
    if(CommitOrRollback == 1)
      StartCaptureOutput();
      [ 
        select pmpaym.t_paymentid t_paymentid
        from doprdocs_dbt oprdocs
        join dpmpaym_dbt pmpaym on pmpaym.t_paymentid = substr(oprdocs.t_documentid,13) and
                                   pmpaym.t_dockind = ########## and
                                   pmpaym.t_documentid = ? and
                                   pmpaym.t_chapter = 1 and
                                   pmpaym.t_netting = chr(0) and
                                   pmpaym.t_paymstatus = ########## and
                                   (pmpaym.t_fiid_futurepayacc != 0 or pmpaym.t_fiid_futurerecacc != 0) and
                                   (exists(select 1 from ddp_dep_dbt dp_dep where dp_dep.t_partyid = pmpaym.t_payerbankid) or
                                    exists(select 1 from ddp_dep_dbt dp_dep where dp_dep.t_partyid = pmpaym.t_payer)) and
                                   not exists(select 1 from ddp_dep_dbt dp_dep where dp_dep.t_partyid = pmpaym.t_receiverbankid)
        where oprdocs.t_id_operation = ? and
              oprdocs.t_id_step = ? and
              oprdocs.t_dockind = 451 /*Связка с изменением статуса платежа*/
      ](KindDoc, PM_READY_TO_SEND);
      cmdPM = RSDCommand(EndCaptureOutput());
      cmdPM.AddParam("docid", RSDBP_IN, tick.dealid);
      cmdPM.AddParam("id_operation", RSDBP_IN, ID_Operation);
      cmdPM.AddParam("id_step", RSDBP_IN, ID_Step);
      cmdPM.Execute();
      rsPM = TRsbDataSet(cmdPM);
      contrid = tick.partyid;
    end;
  else
    msgboxex("Платеж для SWIFT-сообщения не найден|"+"KindDoc="+KindDoc+"|Kind_Operation="+Kind_Operation+"|ID_Operation="+ID_Operation+"|Num_Step="+Num_Step+"|ID_Step="+ID_Step);
    return 1;
  end;

  /*Проходим по платежам платеж*/
  if((rsPM != null)/*Выполнение шага*/ or (CommitOrRollback == 2)/*Откат шага*/)
    ExecMacroFile("paymswift", "ModifySWIFT", rsPM, CommitOrRollback, ID_Operation, ID_Step);
  end;

  /*Возвращаем результат*/
  return 1;
end;
