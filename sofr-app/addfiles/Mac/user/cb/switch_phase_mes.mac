import "mail.mac";
import dlmisc;

var phase, mail, groupname = "", operday, i = 0;
GetCmdLineParm("phase", phase, V_STRING);
GetCmdLineParm("mail",  mail, V_STRING);
GetCmdLineParm("day",  operday, V_DATE);
var v_email_processor = email_proc_env();
var mail_arr;
if ((phase == "1")or
    (phase == "2")or
    (phase == "3")or
    (phase == "4"))

   var cmd = RsdCommand("select d.t_name from DOPDACGRP_DBT a, DOPDGROUP_DBT d where d.t_groupid=a.t_groupid and a.t_state=chr(88) and a.t_bankdate = ?");

   cmd.addParam("", RSDBP_IN, operday);
   cmd.execute();
    
   var rs = RsdRecordset(cmd);

   while(rs.MoveNext())
     groupname = groupname + ", \"" + rs.value(0) + "\"";
     i = i + 1;
   end;

   if (i == 1)
     groupname =  "по группе " + substr(groupname,2,strlen(groupname)-1);
   elif (i > 1)
     groupname =  "по группам " + substr(groupname,2,strlen(groupname)-1);
   end;

   mail_arr = SplitString(mail, ",");
   i = 0;
   if (mail_arr.Size > 0)

     while (i < mail_arr.Size)
       v_email_processor.m_add_email_to_list(mail_arr(i));
       i = i + 1;
     end;

     v_email_processor.m_set_msg_head("Уведомление о завершении операций");
     v_email_processor.m_add_row_to_msg_text("Обработка операций за " +  operday  + " " + groupname + " завершена");

     /* Сохраняем текст письма для отправки плановой процедурой */
     v_email_processor.m_save_to_submit();
     /* Отправляем все неотправленные письма */
     setoutput("..\\txtfile\\sw_ph.txt",true);
     println("Обработка операций за " +  operday  + " " + groupname + " завершена");
     setoutput();
     v_email_processor.m_submit_email();

  end;

end;