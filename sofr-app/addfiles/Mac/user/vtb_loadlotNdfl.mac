/*
$Name:         vtb_LoadLotNdfl.mac
$Module:       Ценные бумаги
$Description:  Загрузка НДФЛ-зачислений
*/

/*----------------------------------------------------------
   Формат:
   GKK|SecondName|FirstName|MiddleName|Phone|AgrNo|ISIN|Transh|SecName|OperNo|DatePos|Qty|Curr|Price|Amount|ACI|Cms|ValueRur|CmsRur|Storage|Nominal|NominalCurr|PriceQty|DboNo
   Автор: Кадин Д.                                          */
/*----------------------------------------------------------*/
import rsd, rsexts, dlcontrfunc, rsbformsinter;
import "usr_open_files.mac";
import BankInter;
import "vtb_createenroll.mac";

// private CONST ENCODE = "rsansi"; //"utf8" "rsoem"; 16062022 bpv выбирается при запуске
private CONST OUTDIR = "..\\Export"; 

private const NOTEKIND_GUID = 404; //Примечание "GUID депозитарного зачисления"
private const OBJGROUP_VTBNDFL = 210; // Категория Зачисления ВТБ для НДФЛ 

private const LOAD_DATAFILE = false; // 

private const NKD_IN_COST = true; // 

private CONST NDFL_GKK               ="GKK";
private CONST NDFL_SecondName        ="SecondName";
private CONST NDFL_FirstName         ="FirstName";
private CONST NDFL_MiddleName        ="MiddleName";
private CONST NDFL_Phone             ="Phone";
private CONST NDFL_AgrNo             ="AgrNo";
private CONST NDFL_ISIN              ="ISIN";
private CONST NDFL_LSIN              ="Transh";
private CONST NDFL_SecName           ="SecName";
private CONST NDFL_OperNo            ="OperNo";
private CONST NDFL_DatePos           ="DatePos";
private CONST NDFL_Qty               ="Qty";
private CONST NDFL_Curr              ="Curr";
private CONST NDFL_Price             ="Price";
private CONST NDFL_Amount            ="Amount";
private CONST NDFL_ACI               ="ACI";
private CONST NDFL_Cms               ="Cms";
private CONST NDFL_ValueRur          ="ValueRur";
private CONST NDFL_CmsRur            ="CmsRur";
private CONST NDFL_Storage           ="Storage";
private CONST NDFL_Nominal           ="Nominal";
private CONST NDFL_NominalCurr       ="NominalCurr";
private CONST NDFL_PriceQty          ="PriceQty";
private CONST NDFL_DboNo             ="DboNo";
private CONST NDFL_NotCountedOnIIS   ="NotCountedOnIIS";



private var _MMVB_ID = MMVB_ID();
private var _SPB_ID = SPB_ID();

private var encode = "rsansi";
private var CheckOpNo = false;

private var clientCodeKindForSearch = 109;

Private Macro CheckDepoBoard(ClientID, ContrID, Fiid, Isin)
   var cmd = RsdCommand(" select tick.*, leg.t_price, leg.t_principal from ddl_tick_dbt tick, dnotetext_dbt text, ddl_leg_dbt leg where tick.t_bofficekind = 127 and tick.t_dealtype = 2011 "+
            " AND text.t_objecttype = 101 and text.t_documentid = LPAD(tick.t_dealid, 34, '0') and leg.t_legkind = 0 and leg.t_dealid = tick.t_dealid and text.t_notekind = 404 "+
            " AND tick.t_clientid = ? and tick.t_clientcontrid in (select mp.t_sfcontrid from ddlcontrmp_dbt mp where mp.t_dlcontrid  = (select t_dlcontrid from ddlcontrmp_dbt where t_sfcontrid = ? )) " + 
                        " and ( tick.t_pfi = ? or tick.t_pfi in (select t_fiid from davoiriss_dbt a where t_isin like ?||'%')) " );
   cmd.AddParam("", RSDBP_IN, ClientID);
   cmd.AddParam("", RSDBP_IN, ContrID);
   cmd.AddParam("", RSDBP_IN, Fiid);
   cmd.AddParam("", RSDBP_IN, Isin);

   var rs = RsdRecordSet(cmd);
   if (rs.movenext())
      return 0;
   else
      return 1;
   end;

End;
Private Macro CheckOperNo(OperNo)
   var cnt = 1;
   var sql = " select 1 from ddl_tick_dbt tick where tick.t_bofficekind = 127 and tick.t_dealtype = 2011 and tick.t_DealCode = ? ";
   var cmd = RsdCommand(sql);
   cmd.AddParam("", RSDBP_IN, OperNo);
   var rs = RsdRecordSet(cmd);
   if (rs.movenext())
      cmd = RsdCommand(sql);
      cmd.AddParam("", RSDBP_IN, OperNo+"("+string(cnt)+")");
      rs = RsdRecordSet(cmd);
      while (rs.movenext())
         cnt = cnt+1;
         cmd = RsdCommand(sql);
         cmd.AddParam("", RSDBP_IN, OperNo+"("+string(cnt)+")");
         rs = RsdRecordSet(cmd);
      end;
      return OperNo+"("+string(cnt)+")";
   else
      return OperNo;
   end;
End;

private class FileFields()
   private var fields = TArray();

   private class FileField(_name, _id)
      var name, id;
      name = _name;
      id   = _id;
   end;

   macro FieldsCount()
      return fields.size;
   end;

   macro addField(_name, _id)
      fields(fields.size) = FileField(_name, _id);
   end;

   macro GetId(_name)
      var i=0;
      for (i, fields) 
         if (StrUpr(i.name) == StrUpr(_name))
            return i.id;
         end;
      end;
      return -1;
   end;

end;



private class Logger()

    var proc_file = "";

    macro CreateLogTable()
       SQL_Execute(
         "CREATE TABLE UVTB_NDFL_LOG \n" +
         "( \n" +
         "  T_OPERDATE DATE, \n" +
         "  T_SYSDATE DATE, \n" +
         "  T_FILE VARCHAR2(200), \n" +
         "  T_GKK       VARCHAR2(200 BYTE), \n" +
         "  T_DEALCODE  VARCHAR2(200 BYTE), \n" +
         "  T_ISIN      VARCHAR2(200 BYTE), \n" +
         "  T_LSIN      VARCHAR2(200 BYTE), \n" +
         "  T_QTY       VARCHAR2(200 BYTE), \n" +
         "  T_DATE      VARCHAR2(200 BYTE), \n" +
         "  T_STATE     VARCHAR2(200 BYTE), \n" +
         "  T_S         VARCHAR2(2000 BYTE) \n" +
         "); \n" );
    OnError(e)
    end;

    macro CreateDataTable() //Структура устарела
       SQL_Execute(
         "CREATE TABLE uvtb_data \n" +
         "( \n" +
         "   t_file          VARCHAR2 (200), \n" +
         "   t_state         VARCHAR2 (200), \n" +
         "   GKK             VARCHAR2 (200), \n" +
         "   SecondName      VARCHAR2 (200), \n" +
         "   FirstName       VARCHAR2 (200), \n" +
         "   MiddleName      VARCHAR2 (200), \n" +
         "   Phone           VARCHAR2 (200), \n" +
         "   AgrNo           VARCHAR2 (200), \n" +
         "   ISIN            VARCHAR2 (200), \n" +
         "   Transh          VARCHAR2 (200), \n" +
         "   SecName         VARCHAR2 (200), \n" +
         "   OperNo          VARCHAR2 (200), \n" +
         "   DatePos         VARCHAR2 (200), \n" +
         "   Qty             VARCHAR2 (200), \n" +
         "   Curr            VARCHAR2 (200), \n" +
         "   Price           VARCHAR2 (200), \n" +
         "   Amount          VARCHAR2 (200), \n" +
         "   ACI             VARCHAR2 (200), \n" +
         "   Cms             VARCHAR2 (200), \n" +
         "   ValueRur        VARCHAR2 (200), \n" +
         "   CmsRur          VARCHAR2 (200), \n" +
         "   Storage         VARCHAR2 (200), \n" +
         "   Nominal         VARCHAR2 (200), \n" +
         "   NominalCurr     VARCHAR2 (200), \n" +
         "   PriceQty        VARCHAR2 (200), \n" +
         "   DboNo           VARCHAR2 (200), \n" +
         "   NotCountedOnIIS VARCHAR2 (200), \n" +
         "   t_id number(10) \n" +
         "); \n"  );
    OnError(e)
    end;



    private macro InsertRec(f1,f2,f3,f4,f5,f6,f7,f8)
       var cmd = RSDCommand(" insert into UVTB_NDFL_LOG values(?,sysdate,?,?,?,?,?,?,?,?,?)");
       cmd.addParam("", RSDBP_IN,{curdate});
       cmd.addParam("", RSDBP_IN,proc_file);
       cmd.addParam("", RSDBP_IN,f1);
       cmd.addParam("", RSDBP_IN,f2);
       cmd.addParam("", RSDBP_IN,f3);
       cmd.addParam("", RSDBP_IN,f4);
       cmd.addParam("", RSDBP_IN,f5);
       cmd.addParam("", RSDBP_IN,f6);
       cmd.addParam("", RSDBP_IN,f7);
       cmd.addParam("", RSDBP_IN,f8);
       cmd.execute();
    end;

    macro InsData(f1,f2,f3,f4,f5,f6,f7,f8, f9, f10, f11,f12,f13,f14,f15,f16,f17,f18,f19,f20,f21,f22,f23,f24,f25)
       var cmd = RSDCommand(" insert into UVTB_DATA values(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)");
       cmd.addParam("", RSDBP_IN,proc_file);
       cmd.addParam("", RSDBP_IN,"-1");
       cmd.addParam("", RSDBP_IN,f1);
       cmd.addParam("", RSDBP_IN,f2);
       cmd.addParam("", RSDBP_IN,f3);
       cmd.addParam("", RSDBP_IN,f4);
       cmd.addParam("", RSDBP_IN,f5);
       cmd.addParam("", RSDBP_IN,f6);
       cmd.addParam("", RSDBP_IN,f7);
       cmd.addParam("", RSDBP_IN,f8);
       cmd.addParam("", RSDBP_IN,f9);
       cmd.addParam("", RSDBP_IN,f10);
       cmd.addParam("", RSDBP_IN,f11);
       cmd.addParam("", RSDBP_IN,f12);
       cmd.addParam("", RSDBP_IN,f13);
       cmd.addParam("", RSDBP_IN,f14);
       cmd.addParam("", RSDBP_IN,f15);
       cmd.addParam("", RSDBP_IN,f16);
       cmd.addParam("", RSDBP_IN,f17);
       cmd.addParam("", RSDBP_IN,f18);
       cmd.addParam("", RSDBP_IN,f19);
       cmd.addParam("", RSDBP_IN,f20);
       cmd.addParam("", RSDBP_IN,f21);
       cmd.addParam("", RSDBP_IN,f22);
       cmd.addParam("", RSDBP_IN,f23);
       cmd.execute();
    end;


    macro RepHeader(dt, tm)
       var str;
       str =     "                             ОТЧЕТ о загрузке  \n";
       str = str+"\n";
       str = str+"Дата загрузки  : "+dt+"\n";
       str = str+"Время загрузки : "+tm+"\n";
       str = str+"┌─┬────────────────┬───────────────┬─────────────┬─────────────┬───────────┬──────────────────────┬─────────────┬───────────────────────────────────────────────────────────────────────────────────────────┐\n";
       str = str+"│ │Код клиента ВТБ │Номер сделки   │ISIN         │госрег       │ Кол-во    │ Дата-время           │Статус       │Комментарий                                                                                │\n";
       str = str+"├─┼────────────────┼───────────────┼─────────────┼─────────────┼───────────┼──────────────────────┼─────────────┼───────────────────────────────────────────────────────────────────────────────────────────┤";
       println(str);                                                                   
    end;                                                                               
                                                                                       
    macro RepFooter(suc, er, tot, outfname)                                            
       var str = "└─┴────────────────┴───────────────┴─────────────┴─────────────┴───────────┴──────────────────────┴─────────────┴───────────────────────────────────────────────────────────────────────────────────────────┘\n";
       str = str+"Загружено успешно: "+suc+"\n";
       str = str+"Не загружено     : "+er+"\n";
       str = str+"Всего            : "+tot+"\n";
       str = str+"Файл протокол    : "+outfname+"\n";
      println(str);
    end;

    macro RepStr(_err,_code, _num,  _isin, _lsin, _amnt, _dt, _stat,_comm)
        var status;
        _comm = strsubst(_comm,strfor(10)," ");
        if (_stat == 0)
            status = "Загружено";
        elif (_stat == 1)
            status = "Не загружено";
        elif (_stat == 2)
            status = "Обновлено";
       elif (_stat == 3)
           status = "Дубль";
        end;

       [│#│################│###############│#############│#############│###########│######################│#############│###########################################################################################│]
       (string(_err  ):1   , 
        string(_code ):16:l, 
        string(_num  ):15:l,
        string(_isin ):13:l,
        string(_lsin ):13:l,
        string(_amnt ):11:l,
        string(_dt   ):22:l,
        string(status):13:l,
        string(_comm ):w);

       InsertRec(_code,_num,_isin,_lsin,_amnt,_dt,status,_comm);

    end;
    macro AddStr(_str)
       println(_str);
    end;
end;

private macro GetCurrByISO(IsoCode, Fiid:@integer)
   var cmd = RsdCommand("select t_fiid from dfininstr_dbt where t_Iso_Number = ?");
   if(IsoCode == "810") 
      IsoCode = "643";
   end;
   cmd.AddParam("", RSDBP_IN, IsoCode);
   var rs = RsdRecordSet(cmd);
   if (rs.movenext())
      fiid = rs.Value(0);
      return 0;
   else
      fiid = -1;
      return 1;
   end;
end;


Private macro GetContrIDByClient(Client, Storage, ContrID:@integer, ContrDate:@date, s_DboNo )
  if ( ValType(s_DboNo) != V_STRING )
      s_DboNo ="";
  else
      s_DboNo =Trim(s_DboNo);
  end;
  var query, query1, cmd, cmd1, DataSet, DataSet1, servkind = -1, servkindsub= -1, market= -1; 
  
  If(Storage == "1")
     servkind = 1;
     servkindsub = 9;
     Market = -1;
  elif(Storage == "2")
     servkind = 1;
     servkindsub = 8;
     Market = 2;
  elif(Storage == "3")
     servkind = 1;
     servkindsub = 8;
     Market = 151337;
  end;

  if (s_DboNo == "") 
    query =   "select dl.t_dlcontrid from dsfcontr_dbt sf, ddlcontr_dbt dl where sf.t_partyid = ? and sf.t_servkind = 0 and sf.t_dateclose = to_date('01010001','ddmmyyyy') " + 
         " and dl.t_sfcontrid = sf.t_id and DL.T_IIS != 'X' order by sf.t_datebegin,dl.t_dlcontrid ";
    cmd = DL_RSDCommand(query);        
    cmd.addParam(Client);
  else
    query =   "select dl.t_dlcontrid  from dsfcontr_dbt sf, ddlcontr_dbt dl where sf.t_partyid = ? and sf.t_number  = ? " +
          " and sf.t_servkind = 0 and sf.t_dateclose = to_date('01010001','ddmmyyyy') and dl.t_sfcontrid = sf.t_id order by sf.t_datebegin,dl.t_dlcontrid ";
    cmd = DL_RSDCommand(query);        
    cmd.addParam(Client);
    cmd.addParam(s_DboNo);
  end;  

  DataSet = cmd.Execute();
  If(DataSet.moveNext())
    var dlcontr = DataSet.dlcontrid; //DEF-80688
    /*query1 = "select mp.*, contr.t_datebegin from dsfcontr_dbt contr, ddlcontrmp_dbt mp, ddlcontr_dbt d where d.t_dlcontrid = mp.t_dlcontrid and d.t_iis <> chr(88) and contr.t_partyid = ? and contr.t_servkind = ? and contr.t_servkindsub =  ? " +  
                  " and contr.t_dateclose = to_date('01010001','ddmmyyyy') and mp.t_sfcontrid = contr.t_id  and t_marketid =  ? "; */
  
    query1 = "select mp.*, contr.t_datebegin from dsfcontr_dbt contr, ddlcontrmp_dbt mp, ddlcontr_dbt d where d.t_dlcontrid = ? and d.t_dlcontrid = mp.t_dlcontrid and contr.t_servkind = ? and contr.t_servkindsub =  ? " +  
                  " and contr.t_dateclose = to_date('01010001','ddmmyyyy') and mp.t_sfcontrid = contr.t_id  and t_marketid =  ? ";
    cmd1 = DL_RSDCommand(query1);
    //cmd1.addParam(Client);
    cmd1.addParam(dlcontr);
    cmd1.addParam(servkind);
    cmd1.addParam(servkindsub);
    cmd1.addParam(Market);
    DataSet1 = cmd1.Execute();
    while(DataSet1.moveNext())
       ContrID =  DataSet1.sfcontrid;
       ContrDate = DataSet1.datebegin;
       return 1;
    end;
    //if(Storage == "3")
      /* query1 = "select mp.*, contr.t_datebegin from dsfcontr_dbt contr, ddlcontrmp_dbt mp, ddlcontr_dbt d where d.t_dlcontrid = mp.t_dlcontrid and d.t_iis <> chr(88) and contr.t_partyid = ? and contr.t_servkind = ?  and contr.t_servkindsub =  8 " +  
                  "  and contr.t_dateclose = to_date('01010001','ddmmyyyy') and mp.t_sfcontrid = contr.t_id  and t_marketid = 2 "; */
    query1 = "select mp.*, contr.t_datebegin from dsfcontr_dbt contr, ddlcontrmp_dbt mp, ddlcontr_dbt d where d.t_dlcontrid = ? and d.t_dlcontrid = mp.t_dlcontrid and contr.t_servkind = ?  and contr.t_servkindsub =  8 " +  
                  "  and contr.t_dateclose = to_date('01010001','ddmmyyyy') and mp.t_sfcontrid = contr.t_id  and t_marketid = 2 ";
    cmd1 = DL_RSDCommand(query1);
       //cmd1.addParam(Client);
    cmd1.addParam(dlcontr);
    cmd1.addParam(servkind);
    DataSet1 = cmd1.Execute();
    while(DataSet1.moveNext())
       ContrID =  DataSet1.sfcontrid;
       ContrDate = DataSet1.datebegin;
       return 1;
    end;
    //end;
    return -1;  
  end;
  return 0;
end;

private macro GetLastValue(DealDate)
   var yyyy = 0, num = 0;
   DateSplit(DealDate,null,null,yyyy);
   var dt = TRsbDataSet(
         "  select num from  (SELECT CASE " +
         "            WHEN INSTR (num, '/') > 0 " +
         "            THEN " +
         "               SUBSTR (num, 1, INSTR (num, '/') - 1) " +
         "            ELSE " +
         "               num " +
         "         END " +
         "            num, " +
         "         t_dealcode " +
         "    FROM (SELECT SUBSTR (REPLACE (t_dealcode, '/ДЕПО'), " +
         "                         INSTR (t_dealcode, '/') + 1) " +
         "                    num, " +
         "                 t_dealcode " +
         "            FROM ddl_tick_dbt t " +
         "           WHERE     t_bofficekind = 127 " +
         "                 AND t_dealtype = 2011 " +
         "                 AND t_dealcode LIKE '%/ДЕПО' " +
         "                 AND t_dealdate >= TO_DATE ('0101"+string(yyyy)+"', 'ddmmyyyy')  " + 
         "                 AND t_dealdate <= TO_DATE ('3112"+string(yyyy)+"', 'ddmmyyyy'))) " +
         "ORDER BY LENGTH (num) DESC, num DESC "  );
   if (Dt.movenext())
      num = int(dt.num);
   else
      num = 0;
   end;
   return num;
end;

private macro GetNextValue(DealDate)
   var yyyy = 0;
   DateSplit(DealDate,null,null,yyyy);
   var Dt = TRsbDataSet(" select vtb_loadlot_"+string(yyyy)+"_seq.nextval n from dual");
   if (Dt.movenext())
      return dt.n;
   end;
OnError(e)
   var l = GetLastValue(DealDate)+1;
   DateSplit(DealDate,null,null,yyyy);
   var cmd = rsdcommand(" CREATE SEQUENCE vtb_loadlot_"+string(yyyy)+"_seq START WITH "+string(l)+" MAXVALUE 9999999999999999999999999999  NOCYCLE NOCACHE");
   cmd.execute();
   Dt = TRsbDataSet(" select vtb_loadlot_"+string(yyyy)+"_seq.nextval n from dual");
   if (Dt.movenext())
      return dt.n;
   end;
end;

private macro GetDealCode(DealDate, ContrID, ContrNum, num:@integer)

   var cmd = RsdCommand("select t_code from ddlobjcode_dbt where t_objecttype = 207 and t_codekind = 1 and t_bankclosedate = to_date('01010001','ddmmyyyy') and t_objectid = ( " + 
                         "  select t_dlcontrid from ddlcontrmp_dbt where t_sfcontrid = ? )");
   cmd.addParam("", RSDBP_IN, ContrID);
   var Dt = RsdRecordSet(cmd);
   var ClientCode = "", RetVal = "";
   if (Dt.movenext())
      ClientCode = Dt.Value("t_code");
   else
      return "-1";
   end;

/*   if (num == -1)
      num = GetLastValue(DealDate)+1;
   end;*/
   num = GetNextValue(DealDate);
   RetVal = ClientCode+"/"+string(num)+"/ДЕПО";
   cmd = RsdCommand("select 1 from ddl_tick_dbt where t_bofficekind = 127 and t_dealcode = ?");
   cmd.addParam("",RSDBP_IN,RetVal);
   Dt = RsdRecordSet(cmd);
   while (Dt.movenext())
      num = num + 1;
      RetVal = ClientCode+"/"+string(num)+"/ДЕПО";
      cmd = RsdCommand("select 1 from ddl_tick_dbt where t_bofficekind = 127 and t_dealcode = ?");
      cmd.addParam("",RSDBP_IN,RetVal);
      Dt = RsdRecordSet(cmd);
   end;
   return RetVal;
end;

private macro GetAvoiriss(s_Isin, s_Lsin, Avoirkind:@integer)
   var cmd = RsdCommand(" select f.t_fiid, f.t_avoirkind from davoiriss_dbt a, dfininstr_dbt f where f.t_fiid = a.t_fiid and a.t_isin = ?");
   cmd.addParam("", RSDBP_IN, s_Isin);
   var Dt = RsdRecordSet(cmd);
   if (Dt.movenext)
      avoirkind = Dt.Value("t_AvoirKind");
      return Dt.Value("t_fiid");
   else
      Dt = cmd = null;
      cmd = RsdCommand(" select f.t_fiid, f.t_avoirkind from davoiriss_dbt a, dfininstr_dbt f where f.t_fiid = a.t_fiid and a.t_isin = ?");
      cmd.addParam("", RSDBP_IN, s_Lsin);
      Dt = RsdRecordSet(cmd);
      if (Dt.movenext)
         avoirkind = Dt.Value("t_AvoirKind");
         return Dt.Value("t_fiid");
      end;
   end;
   avoirkind = -1;
   return -1;
end;

private macro GetContract(s_contrNum, s_ContrMP)
   var cmd = RsdCommand("select t_dlcontrid from ddlcontr_dbt d, dsfcontr_Dbt sf where d.t_sfcontrid = sf.t_id and sf.t_number = ? ");
       cmd.addParam("",RSDBP_IN, s_ContrNum);
   var Dt = RsdRecordSet(cmd);
   var dlcontrid = 0, contrid = 0, sql = "";
   if (Dt.movenext())
      dlcontrid = Dt.Value("t_dlcontrid");
      if (s_ContrMP == "OTC")
         sql = "select sf.t_id from dsfcontr_dbt sf, ddlcontrmp_dbt mp where sf.t_servkind = 1 and sf.t_servkindsub = 9 " + 
                          " and sf.t_id = mp.t_sfcontrid and mp.t_dlcontrid = ?";
      else
         sql = "select sf.t_id from dsfcontr_dbt sf, ddlcontrmp_dbt mp where sf.t_servkind = 1 and sf.t_servkindsub = 8 " + 
                          " and sf.t_id = mp.t_sfcontrid and mp.t_dlcontrid = ? and mp.t_marketid = ?";
      end;
      cmd = RsdCommand(sql);
      cmd.addParam("",RSDBP_IN, dlcontrid);
      if (s_ContrMP == "MOEX")
         cmd.addParam("",RSDBP_IN, _MMVB_ID);
      elif(s_ContrMP == "SPB")
         cmd.addParam("",RSDBP_IN, _SPB_ID);
      end;

      Dt = RsdRecordSet(cmd);
      if (Dt.movenext())
         ContrId = Dt.Value("t_id");
      else
         ContrId = -2;
      end;
   else
      Contrid = -1;
   end;
   return contrid;
end;

private macro GetDt(s_DateTime)
   var s = s_DateTime, dd = "", mm = "", yyyy = "";
   if (index(s,".") > 0)/*дата есть*/
      if (index(s," ") > 0)/*и время наверное есть*/
         s = trim(SubStr(s_DateTime, 1, index(s_DateTime," ")-1));
      end;
      dd = int(trim(SubStr(s, 1, index(s,".")-1)));
      s = trim(SubStr(s, index(s,".")+1));
      mm = int(trim(SubStr(s, 1, index(s,".")-1)));
      s = trim(SubStr(s, index(s,".")+1));
      yyyy = int(trim(SubStr(s, 1)));
      return date(dd,mm,yyyy);
   else
      return "";
   end;
end;

private macro GetTm(s_DateTime)
   var s = s_DateTime, hh = "", mm = "", ss = "";
   if (index(s,":") > 0)/*время есть*/
      if (index(s," ") > 0)/*и дата наверное есть*/
         s = trim(SubStr(s_DateTime, index(s_DateTime," ")));
      end;
      hh = int(trim(SubStr(s, 1, index(s,":")-1)));
      s = trim(SubStr(s, index(s,":")+1));
      mm = int(trim(SubStr(s, 1, index(s,":")-1)));
      s = trim(SubStr(s, index(s,":")+1));
      if (index(s,".") > 0)/*и дата наверное есть*/
         ss = int(trim(SubStr(s, 1, index(s,".")-1)));
      else
         ss = int(trim(SubStr(s, 1)));
      end;
      return time(hh,mm,ss);
   else
      return "";
   end;
end;

private macro InsertOutStr(outfile, strfile, delim, fieldcount, fieldnum, msg)
   var c = 0, str = "";
   while(c < fieldcount)
      if ((ValType(fieldnum) != V_UNDEF) and (c == fieldnum))
         if (c == 0)
            str = msg;
         else
            str = str + delim + strfile(c)/*msg*/;
         end;
      else
         if (c == 0)
            str = strfile(c);
         else
            str = str + delim + strfile(c);
         end;
      end;
      c = c + 1;
   end;
   outfile.str = str;
   insert(outfile)
end;

private macro ResetSeq()
   var cmd = RsdCommand(" BEGIN " +
                        " FOR i IN (SELECT * " +
                        "             FROM USER_SEQUENCES " +
                        "            WHERE sequence_name LIKE UPPER ('vtb_loadlot%')) " +
                        "  LOOP                                                       " +
                        "    EXECUTE IMMEDIATE 'drop SEQUENCE ' || i.sequence_name;   " +
                        "  END LOOP;                                                  " +
                        " END;");
   cmd.execute();
end;

macro eScrollDialog(rs, cmd, id, key)
   if(cmd == DLG_KEY)
      if(key == 27) /** Esc */
         return CM_CANCEL;
      elif(key == 13) /** Enter */
         return CM_SELECT;
      end;
   end;
end;

macro getClientCodeKind(defaultCodeKind, x, y)
   var cmd = RsdCommand (" SELECT t_codekind, t_name, t_definition              " +
                         "   FROM dobjkcode_dbt                                 " +
                         "  WHERE t_objecttype = 3 AND t_codekind IN (101, 109) ");
   var rs = RSDRecordset(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);

   var columns = MakeArray("t_codekind",   "Вид кода", 10, 2, -1, 0,
                           "t_name",       "Название", 20, 2, -1, 0,  
                           "t_definition", "Описание", 40, 2, -1, 0);
   
   if(RunScroll(rs, 3, columns, null, "eScrollDialog", "Выберите вид кода", " ~Enter~ Выбор  ~Esc~ Выход", true, x, y))
      setParm(0, string(rs.value("t_codekind")));
      return true;
   end;

   setParm(0, defaultCodeKind);
   return false;
end;

private const FT_STRING = 7;

class (TRsbPanel) RunPanel
    InitTRsbPanel();
    setSize(30, 7);
    setPosition(35,15);
    
    var Encode = "rsansi";
    var stat = 0;
    var fileSource = true;
    var tableSource = false;
    
    addLabel(TRsbLabel(3, 2, "Кодировка :"));
    var m_Encode:TRsbComboBox = TRsbComboBox();
    m_Encode.setPosition(12,2);
    m_Encode.setSize(10,1);
    m_Encode.enabled = true;
    m_Encode.Name = "m_Encode";
    m_Encode.addChoice(1,"ANSI1251");
    m_Encode.addChoice(2,"OEM866");
    m_Encode.addChoice(3,"UTF-8 (65001)");
    m_Encode.currentChoice = 1;
    addControl(m_Encode);
    m_Encode.addEventHandler(RSB_EV_KEY_PRESSED , R2M(this, "KEY_PRESSED"));

    addLabel(TRsbLabel(3, 3, "Вид кода :"));
    var ClientCodeKind = string(clientCodeKindForSearch);
    var m_codekind = TRsbEditField(FT_STRING);
    m_codekind.setPosition(12, 3);
    m_codekind.setSize(5, 1);
    m_codekind.bindValue(this, "ClientCodeKind", 100);
    m_codekind.name = "m_codekind";

    addControl(m_codekind);
    m_codekind.addEventHandler(RSB_EV_KEY_PRESSED , R2M(this, "KEY_PRESSED_CODES"));

    var m_fileSource  = TRsbRadioButton(1);
    m_fileSource.setPosition(4, 4); 
    m_fileSource.Name = "rb1";
    m_fileSource.bindValue(this, "fileSource");
    m_fileSource.checked = fileSource; 
    addControl(m_fileSource);
    addLabel(TRsbLabel(6, 4, "Загрузка из файла"));

    var m_tableSource = TRsbRadioButton(1);
    m_tableSource.setPosition(4, 5); 
    m_tableSource.Name = "rb2";
    m_tableSource.bindValue(this, "tableSource"); 
    m_tableSource.checked = tableSource;
    addControl(m_tableSource);
    addLabel(TRsbLabel(6, 5, "Загрузка из таблицы"));

    addEventHandler(RSB_EV_KEY_PRESSED , R2M(this, "Panel_ButtonEvent"));

    macro KEY_PRESSED_CODES(RsbEvent)
       private var x,y,px,py,width,height;

       if(rsbEvent.KeyCode == KEY_F3)
          GetPosition(px, py);
          RsbEvent.source.GetPosition(x, y);
          RsbEvent.source.GetSize(width, height);
          
          getClientCodeKind(RsbEvent.source.value, x + px, y + py + height);
       end;
    end;
    
    macro Panel_ButtonEvent(RsbEvent)
       if((RsbEvent.keyCode == 316) or (RsbEvent.keyCode == 323))/*F2 F9*/
           stat = 0;
           if (m_Encode.currentChoice == 1)
              Encode = "rsansi";
           elif (m_Encode.currentChoice == 2)
              Encode = "rsoem";
           elif (m_Encode.currentChoice == 3)
              Encode = "utf8";
           end;
           this.close(1);
       elif(RsbEvent.keyCode == 27) /**/
           stat = 1;
       end;
    end; 
    macro KEY_PRESSED(RsbEvent)
       if(RsbEvent.keyCode == 13)
          stat = 0;
          close(1);
       end;
    end;  
end;


private macro CheckExistsBoard(OpNo, ClientID, ClientContrID, Fiid, Amount, BoardID:@integer, DealCode:@string, DealDate:@date, TaxOwnBegDate:@date)
   var cmd = RsdCommand(" SELECT t.t_DealID, t.t_dealcode, t.t_dealdate, nvl(t.t_TaxOwnBegDate, to_date('01010001', 'ddmmyyyy')) t_TaxOwnBegDate   " +
             "   FROM  ddl_tick_dbt t, ddlrq_dbt rq " +
             "  WHERE     t.t_bofficekind = 127                       " +
             "        AND t.t_clientid = ?                       " +
             "        AND t.t_dealcode like ?||'%'                       " +
             "        AND t.t_clientcontrid  in (select t_sfcontrid from ddlcontrmp_dbt where t_dlcontrid =  (select t_dlcontrid from ddlcontrmp_dbt where t_sfcontrid =  ?)) " +
             "        AND t.t_pfi = ?                       " +
             "        AND ((? = -1) or (rq.t_amount = ?)) " +
             "        and rq.t_dockind = t.t_bofficekind  " +
             "        and rq.t_docid = t.t_dealid   and rq.t_type=8 and rq.t_fiid = t.t_pfi and rq.t_dealpart = 1 "  );
   cmd.addParam("",RSDBP_IN, ClientID);
   cmd.addParam("",RSDBP_IN, OpNo);
   cmd.addParam("",RSDBP_IN, ClientContrID);
   cmd.addParam("",RSDBP_IN, Fiid);
   cmd.addParam("",RSDBP_IN, Amount);
   cmd.addParam("",RSDBP_IN, Amount);
   var Dt = RsdRecordSet(cmd);
   if (Dt.movenext())
      DealCode = Dt.Value("t_DealCode");
      DealDate = Dt.Value("t_DealDate");
      BoardID = Dt.Value("t_DealID");
      TaxOwnBegDate = Dt.Value("t_TaxOwnBegDate");
      return true;
   end;
   DealCode = "";
   BoardID = -1;
   return false;
end;


private macro GetDelta(ClientID, Fiid)
   var cmd = RsdCommand(" select t_depo_sum-t_ndfl_sum d  from UVTB_CHECKOP_DBT t where t_clientid = ? and t_pfi = ? " );
   cmd.addParam("",RSDBP_IN, ClientID);
   cmd.addParam("",RSDBP_IN, Fiid);
   var Dt = RsdRecordSet(cmd);
   if (Dt.movenext())
      return Dt.value(0);
   end;
   return 0;

end;

private macro UpdateTaxOwnDate(OpNo, ClientID, Fiid, TaxOwnBegDate_old, TaxOwnBegDate_new, msg:@string)
   var cmd = RsdCommand(
            "DECLARE \n" +
            "   taxownbegdate_old   DATE := ?; \n" +
            "   taxownbegdate   DATE := ?; \n" +
            "   clientid        NUMBER (10) := ?; \n" +
            "   fiid            NUMBER (10) := ?; \n" +
            "   opno            VARCHAR2 (30) := ?; \n" +
            "BEGIN \n" +
            "   FOR i \n" +
            "      IN (SELECT t.t_DealID, \n" +
            "                 t.t_dealcode, \n" +
            "                 t.t_dealdate, \n" +
            "                 t.t_TaxOwnBegDate \n" +
            "            FROM ddl_tick_dbt t \n" +
            "           WHERE     t.t_bofficekind = 127 \n" +
            "                 AND t.t_clientid = clientid \n" +
            "                 AND t.t_dealcode LIKE opno||'%' \n" +
            "                 AND t.t_pfi = fiid) \n" +
            "   LOOP \n" +
            "      UPDATE ddl_tick_dbt \n" +
            "         SET t_taxownbegdate = taxownbegdate \n" +
            "       WHERE t_dealid = i.t_dealid; \n" +
            "       UPDATE ddl_leg_Dbt set t_start = taxownbegdate \n" +
            "       WHERE t_dealid = i.t_dealid and t_legkind = 0 and t_legid = 0; \n" +
            "      UPDATE ddlsum_dbt \n" +
            "         SET t_date = taxownbegdate \n" +
            "       WHERE     t_dockind = 127 \n" +
            "             AND t_docid = i.t_dealid \n" +
            "             AND t_date = taxownbegdate_old; \n" +
            "   END LOOP; \n" +
            "END; \n" );
   cmd.addParam("",RSDBP_IN, TaxOwnBegDate_old);
   cmd.addParam("",RSDBP_IN, TaxOwnBegDate_new);
   cmd.addParam("",RSDBP_IN, ClientID);
   cmd.addParam("",RSDBP_IN, Fiid);
   cmd.addParam("",RSDBP_IN, OpNo);

   cmd.Execute();

   msg = "";
   return 0;
OnError(e)
   msg = "Sql Error";
   return 1;
end;

class TVtbRow()
   var ErrStat, ErrStr;

   var Client          = "",
       ContrNum        = "",
       ContrMp         = "",
       ClientPrev      = "",  
       ContrNumPrev    = "",
       ContrMpPrev     = "", 
       Isin            = "",
       Lsin            = "",
       Amount          = "",
       Guid            = "",
       DateTime        = "",
       Scale           = "",
       OperType        = "",
       Point           = "",
       Qty             = "",
       Curr            = "",
       Price           = "",
       ACI             = "",
       CmsRur          = "",
       OperNo          = "",
       Storage         = "",
       DboNo           = "",
       NotCountedOnIIS = "";

   var Clientid   = null,
       Dealid     = null,
       Dealstatus = null,
       Dealcode   = null,
       Fiid       = null;

   macro setErrState(_errStat, _errStr)
      ErrStat = _errStat;
      ErrStr = _errStr;
   end;

   macro aftermath()

   end;
end;

class (TVtbRow) TVtbTableRow(_rsbDataset)
   InitTVtbRow();

   var recid = null;

   macro constructor(rsbDataset)
      Client   = rsbDataset.value("GKK");
      Isin     = rsbDataset.value("ISIN");
      Lsin     = rsbDataset.value("TRANSH");
      Qty      = rsbDataset.value("Qty");
      Curr     = rsbDataset.value("Curr");
      OperNo   = rsbDataset.value("OperNo");
      Price    = rsbDataset.value("Price");
      Amount   = rsbDataset.value("Amount");
      DateTime = rsbDataset.value("DatePos");
      ACI      = rsbDataset.value("ACI");
      CmsRur   = rsbDataset.value("CmsRur");
      Storage  = rsbDataset.value("Storage");

      recid = rsbDataset.value("t_id");
      clientid = rsbDataset.value("t_clientid");
      Fiid = rsbDataset.value("t_fiid");
   end;

   macro aftermath()
      var comment = "", loadstate = "OKL";

      if(ErrStat != null)
         if(ErrStat > 0)
            comment = ErrStr;
         end;

         if(ErrStat == 1)
            loadstate = "EL";
         elif(ErrStat == 3)
            loadstate = "OKM";
         end;

         var setCmd = rsdCommand(" UPDATE uvtb_data                        " +
                                 "    SET (t_dealid, t_dealcode) =         " +
                                 "            (SELECT t_dealid, t_dealcode " +
                                 "               FROM ddl_tick_dbt         " +
                                 "              WHERE t_dealid = :1),      " +
                                 "        t_state = :2,                    " +
                                 "        t_comment = :3                   " +
                                 "  WHERE t_id = :4                        ");   
         setCmd.AddParam("", RSDBP_IN, dealid);
         setCmd.AddParam("", RSDBP_IN, loadstate);
         setCmd.AddParam("", RSDBP_IN, comment);
         setCmd.AddParam("", RSDBP_IN, recid);

         setCmd.execute();
      end;
   end;

   macro destructor()
      //msgbox("destruction");
   end;

   constructor(_rsbDataset);
end;

class (TVtbRow) TVtbFileRow(_datafile, _fields)
   InitTVtbRow();

   macro constructor(datafile, fields)
      Client   = StrSubst(trim(datafile(Fields.GetID(NDFL_GKK))),"\"","");
      Isin     = trim(datafile(Fields.GetID(NDFL_ISIN)));
      Lsin     = trim(datafile(Fields.GetID(NDFL_LSIN)));
      Qty      = trim(datafile(Fields.GetID(NDFL_Qty)));
      Curr     = trim(datafile(Fields.GetID(NDFL_Curr)));
      OperNo   = trim(datafile(Fields.GetID(NDFL_OperNo)));
      Price    = trim(datafile(Fields.GetID(NDFL_Price)));
      Amount   = trim(datafile(Fields.GetID(NDFL_Amount)));
      DateTime = trim(datafile(Fields.GetID(NDFL_DatePos)));
      ACI      = trim(datafile(Fields.GetID(NDFL_ACI)));
      CmsRur   = trim(datafile(Fields.GetID(NDFL_CmsRur)));
      Storage  = trim(datafile(Fields.GetID(NDFL_Storage)));
      if (Fields.GetID(NDFL_DboNo) >=0)
         DboNo    = trim(datafile(Fields.GetID(NDFL_DboNo)));
      else
         DboNo    = "";     
      end;
      NotCountedOnIIS = UNSET_CHAR;
      if (Fields.GetID(NDFL_NotCountedOnIIS) >=0)
         if (trim(datafile(Fields.GetID(NDFL_NotCountedOnIIS))) == "1")
            NotCountedOnIIS = SET_CHAR;
         end;
      end;
   end;

   constructor(_datafile, _fields);
end;

macro createBoardByRow(vtbRow:TVtbRow, CheckOpNo)
   if(not CheckOpNo)
      CheckOpNo = true;
   end;

   if(not vtbRow)
      return false;
   end;

   if(StrLen(vtbRow.Client) == 0)
      vtbRow.setErrState(1, "Не задано поле \""+NDFL_GKK+"\"");
      return false;
   end;

   if((StrLen(vtbRow.Isin) == 0) and (StrLen(vtbRow.Lsin) == 0))
      vtbRow.setErrState(1, "Не заданы поля \""+NDFL_ISIN+"\" и \""+NDFL_LSIN+"\"");
      return false;
   end;

   if(StrLen(vtbRow.Qty) == 0)
      vtbRow.setErrState(1, "Не задано поле \""+NDFL_Qty+"\"");
      return false;
   end;

   if(StrLen(vtbRow.Curr) == 0)
      vtbRow.setErrState(1, "Не задано поле \""+NDFL_Curr+"\"");
      return false;
   end;
   
   var CurFiid = -1;
   GetCurrByISO(vtbRow.Curr, @CurFiid);

   If(CurFiid == -1)
      vtbRow.setErrState(1, "Не удалось определить валюту по значению \""+vtbRow.Curr+"\"");
      return false;
   end;

   if(StrLen(vtbRow.OperNo) == 0)
      vtbRow.setErrState(1, "Не задано поле \""+NDFL_OperNo+"\"");
      return false;
   end;

   if(StrLen(vtbRow.Price) == 0)
      vtbRow.setErrState(1, "Не задано поле \""+NDFL_Price+"\"");
      return false;
   end;

   if(StrLen(vtbRow.Amount) == 0)
      vtbRow.setErrState(1, "Не задано поле \""+NDFL_Amount+"\"");
      return false;
   end;

   if(StrLen(vtbRow.DateTime) == 0)
      vtbRow.setErrState(1, "Не задано поле \""+NDFL_DatePos+"\"");
      return false;
   end;

   var DealDate = GetDt(vtbRow.DateTime);
   if(DealDate == "")
      vtbRow.setErrState(1, "Не удалось получить дату из \""+vtbRow.DateTime+"\"");
      return false;
   end;

   var DealTime = GetTm(vtbRow.DateTime);
   if(DealTime == "")
      DealTime = Time("10:30:00");
   end;

   if(StrLen(vtbRow.ACI) == 0)
      vtbRow.setErrState(1, "Не задано поле \""+NDFL_ACI+"\"");
      return false;            
   end;

   if(StrLen(vtbRow.CmsRur) == 0)
      vtbRow.CmsRur = "0.0";
   end;

   if(StrLen(vtbRow.Storage) == 0)
      vtbRow.setErrState(1, "Не задано поле \""+NDFL_Storage+"\"");
      return false;
   end;

   if((ValType(vtbRow.ClientID) == 26) or (not vtbRow.ClientID))
      vtbRow.ClientID = GetCodeParty(vtbRow.Client, clientCodeKindForSearch);
   end;

   if (vtbRow.ClientID <= 0)
      vtbRow.setErrState(1, "Не найден клиент с видом кода "+clientCodeKindForSearch+" = \""+vtbRow.Client+"\"");
      return false;
   end;

   var ContrID, Contrdate;
   var Dbo = GetContrIDByClient(vtbRow.ClientID, vtbRow.Storage, @ContrID, @Contrdate,vtbRow.DboNo);
   If(Dbo >= 2) //DEF-80688
      vtbRow.setErrState(1, "Более одного ДБО по клиенту с кодом \""+vtbRow.Client+"\"");
      return false;
   elif(Dbo == 0)
      vtbRow.setErrState(1, "Не найден ДБО "+vtbRow.DboNo+" по клиенту с кодом \""+vtbRow.Client+"\"");
      return false;
   elif(Dbo == -1)   
      vtbRow.setErrState(1, "Не удалось определить площадку по клиенту с кодом \""+vtbRow.Client+"\" и месту хранения \""+vtbRow.Storage+"\"");
      return false;
   else
      If(ContrID == -1)
         vtbRow.setErrState(1, "Не удалось определить площадку по клиенту с кодом \""+vtbRow.Client+"\" и месту хранения \""+vtbRow.Storage+"\"");
         return false;
      end;
   end;

   if(ContrID > 0)
      var cmd = RsdCommand("update dclient_dbt c set c.t_startdate = ? where C.T_PARTYID = ?  and ? < c.t_startdate and c.t_servicekind = ? and c.t_startdate <> to_date('01010001','ddmmyyyy')");
      cmd.addParam("", RSDBP_IN, Contrdate);
      cmd.addParam("", RSDBP_IN, vtbRow.ClientID);
      cmd.addParam("", RSDBP_IN, Contrdate);
      cmd.addParam("", RSDBP_IN, 1);
      cmd.Execute();
   end;

   if (vtbRow.Isin == "G?'0B10RZP78") vtbRow.Isin = "GB00B10RZP78"; end; /*кривой исин*/

   var AvoirKind;
   vtbRow.Fiid = GetAvoiriss(vtbRow.Isin, vtbRow.Lsin, @AvoirKind);
   if(vtbRow.Fiid < 0 )
      vtbRow.setErrState(1, "Не найдена ценная бумага по ISIN \""+vtbRow.Isin+"\" и гос.рег \""+vtbRow.lsin+"\"");
      return false;
   end;

   vtbRow.Point = 10;

   var CustodyID;
   if(vtbRow.Storage == "3")
      CustodyID = GetCodeParty("00#Б#239654",1); //1450;
   elif (vtbRow.Storage == "2")
      CustodyID = GetCodeParty("НРД",1); //4;
   elif (vtbRow.Storage == "1")
      CustodyID = {OurBank};
   else
      vtbRow.setErrState(1, "Неизвестная торговая площадка \""+vtbRow.Storage+"\"");
      return false;
   end;

   If(Contrdate == date(0,0,0))
      Contrdate = date("21.04.2022");  //Дата первой загрузки Депо остатков
   end;

   vtbRow.DealCode = vtbRow.OperNo + "_NDFL";
   var BoardID, DealCode1, DealDate1, TaxOwnBegDate, msg;
   if (CheckOpNo)
      if(CheckExistsBoard(vtbRow.DealCode, vtbRow.ClientID, ContrID, vtbRow.Fiid, vtbRow.Qty, @BoardID, @DealCode1, @DealDate1, @TaxOwnBegDate) )
         vtbRow.Dealid = BoardID;
         vtbRow.Dealcode = DealCode1;

         if(TaxOwnBegDate != DealDate)
            if(UpdateTaxOwnDate(vtbRow.DealCode, vtbRow.ClientID, vtbRow.Fiid, TaxOwnBegDate/*старая дата приобретения*/, DealDate/*Дата приобретения из файла*/, @msg) == 0)
               vtbRow.setErrState(2, "По операции "+vtbRow.OperNo+" обновлена дата нач.приобретения: с " + TaxOwnBegDate + " на " + DealDate);
            else
               vtbRow.setErrState(1, "Ошибка обновления даты нач.приобретения " + DealCode1);
            end;
         end;

         if(GetDelta(vtbRow.ClientID, vtbRow.Fiid) != double(vtbRow.Qty) )
            vtbRow.setErrState(3, "Ошибка. Операция "+vtbRow.OperNo+" уже загружалась: " + DealCode1);
            return false;
         end;
      end;
   end;

   vtbRow.DealCode = CheckOperNo(vtbRow.DealCode);
   var stat = CheckDepoBoard(vtbRow.ClientID, ContrID, vtbRow.Fiid, vtbRow.ISIN);
   If(stat == 1)
      vtbRow.setErrState(1, "Ошибка. Не найдено ДЕПО зачисление по клиенту  = " + vtbRow.Client + " и ценной бумаге " + vtbRow.ISIN);
      return false;
   end;

   var Amount;
   if((NKD_IN_COST) and (double(vtbRow.ACI) != 0))
      Amount = double(vtbRow.Amount) - double(vtbRow.ACI);
   else
      Amount = double(vtbRow.Amount);
   end;

   stat = CreateDepoBoardWithPrice (vtbRow.DealCode, 
                                    {curdate}, 
                                    DealTime,
                                    vtbRow.ClientID,
                                    ContrID,
                                    vtbRow.Fiid,
                                    vtbRow.Qty, 
                                    int(vtbRow.Point),
                                    CustodyID,
                                    false /*IsSingle*/, 1, CurFiid, vtbRow.Price, Amount, vtbRow.ACI, vtbRow.CmsRur, DealDate,
                                    @msg, @BoardID, vtbRow.NotCountedOnIIS);

   if (stat == 0)
      vtbRow.Dealid = BoardID; 

      if(    ( not DisconnectObjAttr(OBJTYPE_SECDEAL,  string(BoardID:o:34), OBJGROUP_VTBNDFL) ) 
          OR ( not ConnectObjAttr(stat, OBJTYPE_SECDEAL, string(BoardID:o:34), OBJGROUP_VTBNDFL, 1, null, null, {curdate}) )  
          OR ( stat != 0 )
        )
          vtbRow.setErrState(1, msg);
          return false;
      end;

      vtbRow.setErrState(0, vtbRow.DealCode);
   else 
      vtbRow.setErrState(1, msg);
      return false;
   end;

   return true;
end;

class TVtbSource()
   private var currentVtbRow = null;
   var currentRowNum = 0; /** Это строка в файле или в рекордсете */
   var ErrStr = "";
   var Errors = TArray();

   var RecordsAll = 0;
   var RecordsSuccess = 0;
   var RecordsErrors = 0;

   macro getRecCount()
      return -1;
   end;

   macro getNextRow()
      currentVtbRow = null;
   
      return false;
   end;

   macro Row()
      return currentVtbRow;
   end;

   macro RowNum()
      return currentRowNum;
   end;

   macro Prepare()
      return true;
   end;

   macro FinishHim()
   end;

   macro aftermath()
   end;

   macro getLogName()
      return "";
   end;

   macro getProcFileName()
      var dt = StrSubSt(string(Date()),".","")+StrSubSt(string(Time()),":","");
      return "uvtb_data_" + dt + ".csv";
   end;
end;

macro updateClientCodes(fullupdate)
   if(fullupdate == null)
      fullupdate = false;
   end;

   var sql = " UPDATE uvtb_data vtbdata                                      " +
             "    SET t_clientid =                                           " +
             "            (SELECT t_partyid                                  " +
             "               FROM dpartcode_dbt                              " +
             "              WHERE t_codekind = 109 AND t_code = vtbdata.GKK) ";
   if(not fullupdate)
      sql = sql + "  WHERE vtbdata.t_clientid IS NULL ";
   end;

   var setCmd = rsdCommand(sql);

   begAction(0, "Обновление кодов");
   setCmd.execute();
   endAction();
end;

macro updateFininstrs(fullupdate)
   if(fullupdate == null)
      fullupdate = false;
   end;

   var sql = " UPDATE uvtb_data vtbdata                      " +
             "    SET vtbdata.t_fiid =                       " +
             "            (SELECT fin.t_fiid                 " +
             "               FROM davoiriss_dbt fin          " +
             "              WHERE fin.t_isin = vtbdata.isin) ";
   if(not fullupdate)
      sql = sql + "  WHERE vtbdata.t_fiid IS NULL ";
   end;

   var setCmd = rsdCommand(sql);

   begAction(0, "Обновление id финансовых инструментов");
   setCmd.execute();
   endAction();
end;


class (TVtbSource) TVtbTableSource()
   initTVtbSource;

   var vtbDataSet = null;
   var vtbsql = " SELECT *                      " +
                "   FROM UVTB_DATA              " +
                "  WHERE t_state IN ('R', 'EL') ";
   
   macro getRecCount()
      var recCount = 0; 
      var rsbCount = TRsbDataSet("SELECT COUNT(*) cnt FROM ("+vtbsql+")");
      if(rsbCount.movenext)
         recCount = int(rsbCount.cnt);
      end;

      return recCount;
   end;

   macro initDataSet()
      vtbDataSet = rsdRecordset(vtbsql);
   end;



   macro markToDelete(rsdealid)
      var setCmd = rsdCommand(" UPDATE ddl_tick_dbt                      " +
                              "    SET t_dealcode = t_dealcode || '_DEL' " +
                              "  WHERE t_dealid = :1                     " +
                              "    AND t_dealcode NOT LIKE '%_DEL        ");   
      setCmd.AddParam("", RSDBP_IN, rsdealid);
      setCmd.execute();
   end;

   macro updateVtbState(vtbid, state, rsid, comment)
      var setCmd = rsdCommand(" UPDATE uvtb_data                        " +
                              "    SET (t_dealid, t_dealcode) =         " +
                              "            (SELECT t_dealid, t_dealcode " +
                              "               FROM ddl_tick_dbt         " +
                              "              WHERE t_dealid = :1),      " +
                              "        t_state = :2,                    " +
                              "        t_comment = :3                   " +
                              "  WHERE t_id = :4                        ");   
      setCmd.AddParam("", RSDBP_IN, rsid);
      setCmd.AddParam("", RSDBP_IN, state);
      setCmd.AddParam("", RSDBP_IN, comment/*"mapping"*/);
      setCmd.AddParam("", RSDBP_IN, vtbid);

      setCmd.execute();
   end;

   macro aftermath()
      var comment = "", loadstate = "OKL";

      if(Row().ErrStat != null)
         if(Row().ErrStat > 0)
            comment = Row().ErrStr;
         end;

         if(Row().ErrStat == 1)
            loadstate = "EL";
         elif(Row().ErrStat == 3)
            loadstate = "OKM";
         end;

         updateVtbState(Row().recid, loadstate, Row().dealid, comment);
      end;
   end;

   macro madMapping(vtbRow)
      var sql = " SELECT t_id vtbid, t_dealid rsid, t_dealcode                                   " +
                "   FROM (  SELECT ROWNUM rn, t_id                                               " +
                "             FROM uvtb_data vtb_data                                            " +
                "            WHERE     vtb_data.operno = :1                                      " +
                "                  AND vtb_data.qty = :2                                         " +
                "                  AND vtb_data.t_dealid IS NULL                                 " +
                "         ORDER BY t_id) vtbdeals                                                " +
                "        LEFT JOIN                                                               " + // left join для случая когда VTB сделок может быть больше чем зачислений в RS
                "        (  SELECT ROWNUM rn, tick.t_dealid, tick.t_dealcode                     " +
                "             FROM ddl_tick_dbt tick                                             " +
                "                  INNER JOIN ddl_leg_dbt leg                                    " +
                "                      ON     leg.T_DEALID = tick.t_dealid                       " +
                "                         AND leg.t_legkind = 0                                  " +
                "                         AND leg.t_legid = 0                                    " +
                "            WHERE     tick.T_BOFFICEKIND = 127                                  " +
                "                  AND tick.T_DEALTYPE = 2011                                    " +
                "                  AND tick.t_dealcode LIKE :3 || '_NDFL%'                       " +
                "                  AND leg.t_principal = :4                                      " +
                "                  AND EXISTS                                                    " +
                "                          (SELECT 1                                             " +
                "                             FROM dobjatcor_dbt cor                             " +
                "                            WHERE     cor.t_objecttype = 101                    " +
                "                                  AND cor.t_groupid = 210                       " +
                "                                  AND t_object = LPAD (tick.t_dealid, 34, '0')) " +
                "                  AND NOT EXISTS                                                " +
                "                          (SELECT 1                                             " +
                "                             FROM uvtb_data uvtb                                " +
                "                            WHERE uvtb.t_dealid = tick.t_dealid)                " +
                "         ORDER BY tick.t_dealid) rsdeals                                        " +
                "            ON rsdeals.rn = vtbdeals.rn                                         " + // union чтобы убрать дубли
                " UNION                                                                          " +
                " SELECT t_id vtbid, t_dealid rsid, t_dealcode                                   " +
                "   FROM (  SELECT ROWNUM rn, t_id                                               " +
                "             FROM uvtb_data vtb_data                                            " +
                "            WHERE     vtb_data.operno = :5                                      " +
                "                  AND vtb_data.qty = :6                                         " +
                "                  AND vtb_data.t_dealid IS NULL                                 " +
                "         ORDER BY t_id) vtbdeals                                                " +
                "        RIGHT JOIN                                                              " + // right join для случая когда зачислений в RS может быть больше чем сделок VTB
                "        (  SELECT ROWNUM rn, tick.t_dealid, tick.t_dealcode                     " +
                "             FROM ddl_tick_dbt tick                                             " +
                "                  INNER JOIN ddl_leg_dbt leg                                    " +
                "                      ON     leg.T_DEALID = tick.t_dealid                       " +
                "                         AND leg.t_legkind = 0                                  " +
                "                         AND leg.t_legid = 0                                    " +
                "            WHERE     tick.T_BOFFICEKIND = 127                                  " +
                "                  AND tick.T_DEALTYPE = 2011                                    " +
                "                  AND tick.t_dealcode LIKE :7 || '_NDFL%'                       " +
                "                  AND leg.t_principal = :8                                      " +
                "                  AND EXISTS                                                    " +
                "                          (SELECT 1                                             " +
                "                             FROM dobjatcor_dbt cor                             " +
                "                            WHERE     cor.t_objecttype = 101                    " +
                "                                  AND cor.t_groupid = 210                       " +
                "                                  AND t_object = LPAD (tick.t_dealid, 34, '0')) " +
                "                  AND NOT EXISTS                                                " +
                "                          (SELECT 1                                             " +
                "                             FROM uvtb_data uvtb                                " +
                "                            WHERE uvtb.t_dealid = tick.t_dealid)                " +
                "         ORDER BY tick.t_dealid) rsdeals                                        " +
                "            ON rsdeals.rn = vtbdeals.rn                                         ";
      var cmd = rsdCommand(sql);
      cmd.AddParam("", RSDBP_IN, vtbRow.OperNo);
      cmd.AddParam("", RSDBP_IN, vtbRow.Qty ); 
      cmd.AddParam("", RSDBP_IN, vtbRow.OperNo);
      cmd.AddParam("", RSDBP_IN, vtbRow.Qty );
      cmd.AddParam("", RSDBP_IN, vtbRow.OperNo);
      cmd.AddParam("", RSDBP_IN, vtbRow.Qty );
      cmd.AddParam("", RSDBP_IN, vtbRow.OperNo);
      cmd.AddParam("", RSDBP_IN, vtbRow.Qty );

      var rsb = TRsbDataSet(cmd);
      while(rsb.movenext)
         if((vtbRow.recid == rsb.vtbid) and (rsb.rsid != nullVal))
            vtbRow.dealid = rsb.rsid;
            vtbRow.dealcode = rsb.dealcode;
         end;

         if((rsb.vtbid == nullVal) or (rsb.vtbid == null))
            markToDelete(rsb.rsid);
         elif((rsb.rsid == nullVal) or (rsb.rsid == null))
            updateVtbState(rsb.vtbid, "R", null, "");
         else
            updateVtbState(rsb.vtbid, "OKM", int(rsb.rsid), "");
            this.RecordsSuccess = this.RecordsSuccess + 1;
            this.RecordsAll = this.RecordsAll + 1;
         end;
      end;
   end;

   macro mapOne(vtbRow)
      var cmdRsDeals, rsRsDeals;
      cmdRsDeals = rsdCommand(" SELECT COUNT (*) cnt, MAX (t_dealid) dealid, MAX (t_dealcode) dealcode      " +
                              "   FROM ddl_tick_dbt tick                                                    " +
                              "  WHERE     tick.T_BOFFICEKIND = 127                                         " +
                              "        AND tick.T_DEALTYPE = 2011                                           " +
                              "        AND tick.t_clientid = :1                                             " +
                              "        AND tick.t_dealcode LIKE :2 || '_NDFL%'                              " +
                              "        AND EXISTS                                                           " +
                              "                (SELECT 1                                                    " +
                              "                   FROM dobjatcor_dbt cor                                    " +
                              "                  WHERE     cor.t_objecttype = 101                           " +
                              "                        AND cor.t_groupid = 210                              " +
                              "                        AND t_object = LPAD (tick.t_dealid, 34, '0'))        " +
                              "        AND (   NOT EXISTS                                                   " +
                              "                    (SELECT 1                                                " +
                              "                       FROM uvtb_data uvtb                                   " +
                              "                      WHERE uvtb.t_dealid = tick.t_dealid)                   " +
                              "             OR EXISTS                                                       " +
                              "                    (SELECT 1                                                " +
                              "                       FROM uvtb_data vtb                                    " +
                              "                      WHERE vtb.t_id = :3 AND vtb.t_dealid = tick.t_dealid)) ");

      cmdRsDeals.AddParam("", RSDBP_IN, vtbRow.clientid );
      cmdRsDeals.AddParam("", RSDBP_IN, vtbRow.OperNo );
      cmdRsDeals.AddParam("", RSDBP_IN, vtbRow.recid );

      rsRsDeals = TRsbDataSet(cmdRsDeals);
      if(rsRsDeals.movenext)
         if(rsRsDeals.cnt == 0)
            updateVtbState(vtbRow.recid, "R", null, "");
         elif(rsRsDeals.cnt == 1)
            vtbRow.dealid = int(rsRsDeals.dealid);
            vtbRow.dealcode = rsRsDeals.dealcode;
            updateVtbState(vtbRow.recid, "OKM", int(rsRsDeals.dealid), "");
            this.RecordsSuccess = this.RecordsSuccess + 1;
            this.RecordsAll = this.RecordsAll + 1;
         elif(rsRsDeals.cnt > 1)
            madMapping(vtbRow);
         end;
      end;
   end;

   macro mapAll()
     var ret_val = 0;

     var cmd = RsdCommand( "begin ? := RSHB_VTB_LOADLOTNDFL.mapAll(); end;" );

     cmd.addParam( "ret_val", V_INTEGER, RSDBP_OUT);

     SQL_Execute( cmd, "Маппинг зачислений...", false );

     this.RecordsErrors = this.RecordsErrors + ret_val;

     var rsbCount = TRsbDataSet("SELECT COUNT(1) cnt FROM UVTB_DATA where t_state = 'OKM' ");
     var recCount = 0;

     if(rsbCount.movenext)
       recCount = int(rsbCount.cnt);
     end;

     this.RecordsSuccess = this.RecordsSuccess + recCount;
     this.RecordsAll = this.RecordsAll + recCount;	
   end;

   macro Prepare()
      updateClientCodes(false);
      updateFininstrs(false);
      mapAll();
      initDataSet();

      return true;
   end;

   macro getNextRow()
      if(not vtbDataSet.movenext)
         return false;
      end;

      currentRowNum = currentRowNum + 1;
      currentVtbRow = TVtbTableRow(vtbDataSet);

      return true;
   end;

   macro getLogName()
      return "UVTB_DATA";
   end;

end;

private file vtbdatafile() txt;
private file outfile() txt WRITE;
class (TVtbSource) TVtbFileSource()
   initTVtbSource;

   SetDelim("|");

   var FullFileName;
   var FileMask = "*.csv";
   var Fields = FileFields();
   var c_file = c_txt_file();

   /*создаем лог файл*/
   var namf="", extf=".csv";
   var dt = StrSubSt(string(Date()),".","")+StrSubSt(string(Time()),":","");
   var outfname = "";

   macro initFields()
      var fieldIndex = 0;

      next(vtbdatafile);
      while(vtbdatafile(fieldIndex) != "")
         Fields.AddField(vtbdatafile(fieldIndex), fieldIndex);
         fieldIndex = fieldIndex + 1;
      end;

      currentRowNum = currentRowNum + 1;
   end;
   
   macro Prepare()
      if (Fields.GetID(NDFL_GKK) == -1)
         Errors[Errors.size] = "Отсутствует обязательная колонка: \""+NDFL_GKK+"\"";
      end;
      if (Fields.GetID(NDFL_OperNo) == -1)
         Errors[Errors.size] = "Отсутствует обязательная колонка: \""+NDFL_OperNo+"\"";
      end;
      if (Fields.GetID(NDFL_DatePos) == -1)
         Errors[Errors.size] = "Отсутствует обязательная колонка: \""+NDFL_DatePos+"\"";
      end;
      if ((Fields.GetID(NDFL_ISIN) == -1) and (Fields.GetID(NDFL_LSIN) == -1))
         Errors[Errors.size] = "Отсутствует обязательная колонка: \""+NDFL_ISIN+"\"  или \""+NDFL_LSIN+"\"";
      end;
      if (Fields.GetID(NDFL_Qty) == -1)
         Errors[Errors.size] = "Отсутствует обязательная колонка: \""+NDFL_Qty+"\"";
      end;
      if (Fields.GetID(NDFL_Curr) == -1)
         Errors[Errors.size] = "Отсутствует обязательная колонка: \""+NDFL_Curr+"\"";
      end;
      if (Fields.GetID(NDFL_Price) == -1)
         Errors[Errors.size] = "Отсутствует обязательная колонка: \""+NDFL_Price+"\"";
      end;
      if (Fields.GetID(NDFL_Amount) == -1)
         Errors[Errors.size] = "Отсутствует обязательная колонка: \""+NDFL_Amount+"\"";
      end;
      if (Fields.GetID(NDFL_ACI) == -1)
         Errors[Errors.size] = "Отсутствует обязательная колонка: \""+NDFL_ACI+"\"";
      end;
      if (Fields.GetID(NDFL_Cms) == -1)
         Errors[Errors.size] = "Отсутствует обязательная колонка: \""+NDFL_Cms+"\"";
      end;
      if (Fields.GetID(NDFL_Storage) == -1)
         Errors[Errors.size] = "Отсутствует обязательная колонка: \""+NDFL_Storage+"\"";
      end; 

      return Errors.size == 0;  
   end;

   macro openFile(ENCODE)
      var stat, openFileError;

      stat = c_file.openFile(vtbdatafile, FileMask, true, false, FullFileName, ENCODE, @openFileError);
       
      if(valtype(stat) == V_UNDEF)
         ErrStr = "Файл не выбран";
         return false;      
      end;

      if(stat == false)
         ErrStr = openFileError;
         return false;
      end;

      FullFileName = c_file.localFileName;

      initFields();

      SplitFile(FullFileName, namf, extf);
      outfname = OUTDIR + "\\" + namf + "_ndfl_out_" + dt + extf;
      if (not Open(outfile, outfname, encode)) 
         ErrStr = "Ошибка открытия файла лога " + outfname;
         return false;
      end;

      outfile.str = vtbdatafile.str;
      Insert(outfile);

      return true;
   end;

   macro FinishHim()
      c_file.closeFile(vtbdatafile);
      close(outfile);   
   end;

   macro aftermath()
      InsertOutStr(outfile, vtbdatafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), Row().ErrStr);
   end;

   macro getNextRow()
      if(not next(vtbdatafile))
         return false;
      end;

      currentRowNum = currentRowNum + 1;
      currentVtbRow = TVtbFileRow(vtbdatafile, Fields);

      return true;
   end;

   macro getLogName()
      return outfname;
   end;

   macro getProcFileName()
      SplitFile(FullFileName, namf, extf);

      return namf + extf; 
   end;
end;

macro loadBySource(VtbSource:TVtbSource)
   var log = Logger();
   var dt = StrSubSt(string(Date()),".","")+StrSubSt(string(Time()),":","");
   var InfoLogFileName = GetTxtFileName( "loadlot2_NDFL"+dt);
   var RecN,RecS,RecE ;
   RecN = 0;
   RecS = 0;
   RecE = 0;
   
   log.CreateLogTable();/** создаем таблицу логов если ее нет */
   log.proc_file = VtbSource.getProcFileName();

   SetOutput( InfoLogFileName, true ); // Пишем лог в файл. Начало
   log.RepHeader(date(), time());

   if(VtbSource.Prepare())
      InitProgress(VtbSource.getRecCount, "Загрузка зачислений", "Загрузка зачислений");
      while(VtbSource.getNextRow())
         if(not createBoardByRow(VtbSource.Row()))
            log.RepStr("X", VtbSource.Row().Client, 
                            VtbSource.Row().OperNo, 
                            VtbSource.Row().Isin, 
                            VtbSource.Row().Lsin, 
                            VtbSource.Row().Qty, 
                            VtbSource.Row().DateTime, 
                            VtbSource.Row().ErrStat, 
                            VtbSource.Row().ErrStr+", строка "+VtbSource.RowNum());
            
            VtbSource.RecordsErrors = VtbSource.RecordsErrors + 1;
            RecE = RecE  + 1;
         else
            VtbSource.RecordsSuccess = VtbSource.RecordsSuccess + 1;
            RecS = RecS  + 1;
         end;

         VtbSource.aftermath();

         VtbSource.RecordsAll = VtbSource.RecordsAll + 1;
         RecN = RecN  + 1;
         UseProgress(RecN);
      end;

      RemProgress();
   else
      for(var PrepError, VtbSource.Errors)
         log.RepStr("X", "", "", "", "", "", "","", PrepError);
      end;
   end;
   
   //log.RepFooter(suc,err,suc+err, outfname);

   log.RepFooter(RecS, RecE, (RecS + RecE), VtbSource.getLogName());
   SetOutput( NULL, true ); //Пишем лог в файл. Конец

   VtbSource.FinishHim();

   ViewFile(InfoLogFileName);
end;

macro runLoadLot3NDFL(errp:@string , result_protocol:@variant)
   var panel = RunPanel;
   panel.setStatus(" ~F3~ Выбор  ~F2~,~F9~ Выполнить  ~Esc~ Выход");
   panel.setCaption("Загрузка цен НДФЛ");
   panel.run;

   if(panel.stat == 1)
      errp = "Не подтвержден выбор кодировки.";
      Return false;
   end;

   var encode = panel.encode;
   clientCodeKindForSearch = int(panel.ClientCodeKind);
  
   var VtbSource:TVtbSource = null;
   if(panel.fileSource)
      VtbSource = TVtbFileSource();

      if(not VtbSource.openFile(ENCODE))
         errp = VtbSource.ErrStr;
         return false;
      end;
   else
      VtbSource = TVtbTableSource();
   end;

   var StartTime = time();
   loadBySource(VtbSource);

   errp = "";
   result_protocol.addString("Обработано " + VtbSource.RecordsAll + " строк " );
   result_protocol.addString("Не загружено " + VtbSource.RecordsErrors + " записей " );
   result_protocol.addString("Загружено " + VtbSource.RecordsSuccess + " новых записей " );
   result_protocol.addString("Файл протокол: " + VtbSource.getLogName() );
   result_protocol.addString("Старт " + StartTime);
   result_protocol.addString("Окончание " + time() );
   
   return true;
end;

macro runLoadLot2NDFL(errp:@string , result_protocol:@variant)


   var ErrStr = "",ErrStat = false;
   var row = 0, c = 0;
   var suc = 0, err = 0;
   var log = Logger();
   var dt = StrSubSt(string(Date()),".","")+StrSubSt(string(Time()),":","");
   var InfoLogFileName = GetTxtFileName( "loadlot2_NDFL"+dt);
   var DataSet;

   var cur_file_mask = "*.csv";
   file datafile() txt;
   file outfile() txt WRITE;
   SetDelim("|");

   var DealCode, DealDate, DealTime, ClientID, ContrID = -1, CustodyID, BoardID, msg = "", Fiid, Amount, Dbo, CurFiid = -1, Contrdate = date(0,0,0), OperDate = date(0,0,0);
   var DealCode1, DealDate1, TaxOwnBegDate;
      
   var c_file = c_txt_file();
   //var c_file_out = c_txt_file();
   var FullFileName;
   var stat;

   var s_Client = "",
       s_ContrNum = "",
       s_ContrMp = "",
       s_ClientPrev = "",  
       s_ContrNumPrev = "",
       s_ContrMpPrev = "", 
       s_Isin = "",
       s_Lsin = "",
       s_Amount = "",
       s_Guid = "",
       s_DateTime = "",
       s_Scale = "",
       s_OperType = "",
       s_Point = "",
       s_Qty = "",
       s_Curr= "",
       s_Price  = "",
       s_ACI  = "",
       s_CmsRur  = "",
       s_OperNo  = "",
       s_Storage = "",
       s_DboNo = "";
              
   var AvoirKind = -1, num = -1;

   var sql_str, cmd, rs;
   var panel = RunPanel;
   panel.setStatus(" ~F3~ Выбор  ~F2~,~F9~ Выполнить  ~Esc~ Выход");
   panel.setCaption("Загрузка цен НДФЛ");
   panel.run;

   if (panel.stat == 1)
      MsgBox("Не подтвержден выбор кодировки.");
      Return false;
   end;

   encode = panel.encode;
   clientCodeKindForSearch = int(panel.ClientCodeKind);

   GetTrue(CheckOpNo, "Проверять загружаемые операции на дубли по Коду операции и количеству?");

   stat = c_file.openFile(datafile, cur_file_mask, true, false, FullFileName, ENCODE);

   if ( (valtype(stat) == V_UNDEF) or (stat == false) )
      errp = "Ошибка открытия файла " + FullFileName;
      return false;
   end;
   /*создаем лог файл*/
   var namf="", extf="";
   SplitFile(c_file.localFileName, namf, extf);
   var outfname = OUTDIR+"\\" + namf + "_ndfl_out_"+dt + extf;
   if (not Open(outfile, outfname, encode)) 
     errp = "Ошибка открытия файла лога " + outfname;
     return false;
   end;

   log.CreateLogTable();/*создаем таблицу логов если ее нет*/
   log.proc_file = namf+extf;

   /*Открываем файл*/
   BegAction(1, "Обработка файла \"" + c_file.localFileName + "\". Ждите...");

   /* формат файла, первая строка - всегда заголовок, данные со второй строки
   
   запись в файле GKK|SecondName|FirstName|MiddleName|Phone|AgrNo|ISIN|Transh|SecName|OperNo|DatePos|Qty|Curr|Price|Amount|ACI|Cms|ValueRur|CmsRur|Storage|Nominal|PriceQty|DboNo|NotCountedOnIIS
1   GKK
2   Фамилия
3   Имя 
4   Отчество
5   Телефон
6   Номер соглашения ВТБ 
7   ISIN
8   Номер государственной регистрации ЦБ
9   Наименование ЦБ
10  №операции/сделки
11  Дата покупки
12  Кол-во, шт.
13  Валюта сделки
14  Цена
15  Сумма сделки 
16  НКД
17  Комиссионные затраты
18  Сумма сделки (вкл. НКД), руб.
19  Комиссионные затраты, руб.
20  Место хранения ценных ценных
21 Номинал на дату приобретения
22 Price*Qty
23 DboNo
24 Ц/б не учитывались на ИИС

     */
   /*
   if (GetTrue(false, " Обновить счетчики нумерации сделок? | При многопоточном запуске обновлять счетчики можно только при запуске первого потока"))
      ResetSeq();
   end;
   */
   var tmstart = time();
   next(datafile);


  /* есть требование о произвольном порядке полей в файле. Собираем заголовок*/
   var Fields = FileFields();
   c = 0;
   while(datafile(c) != "")
      Fields.AddField(datafile(c),c);
      c = c + 1;
   end;

   SetOutput( InfoLogFileName, true ); //Пишем лог в файл. Начало
   log.RepHeader(date(),time());
   /*Проверяем обязательные поля*/
   stat = 0;
   if (Fields.GetID(NDFL_GKK) == -1)
      log.RepStr("X",s_Client, s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
      log.RepStr("X", "", "", "", "", "", "","", "Отсутствует обязательная колонка: \""+NDFL_GKK+"\"" );
      stat = 1;
   end;
   if (Fields.GetID(NDFL_OperNo) == -1)
      log.RepStr("X", "", "", "", "", "", "","", "Отсутствует обязательная колонка: \""+NDFL_OperNo+"\"" );
      stat = 1;
   end;
   if (Fields.GetID(NDFL_DatePos) == -1)
      log.RepStr("X", "", "", "", "", "", "","", "Отсутствует обязательная колонка: \""+NDFL_DatePos+"\"" );
      stat = 1;
   end;
   if ((Fields.GetID(NDFL_ISIN) == -1) and (Fields.GetID(NDFL_LSIN) == -1))
      log.RepStr("X", "", "", "", "", "", "","", "Отсутствует обязательная колонка: \""+NDFL_ISIN+"\"  или \""+NDFL_LSIN+"\"" );
      stat = 1;
   end;
   if (Fields.GetID(NDFL_Qty) == -1)
      log.RepStr("X", "", "", "", "", "", "","", "Отсутствует обязательная колонка: \""+NDFL_Qty+"\"" );
      stat = 1;
   end;
   if (Fields.GetID(NDFL_Curr) == -1)
      log.RepStr("X", "", "", "", "", "", "","", "Отсутствует обязательная колонка: \""+NDFL_Curr+"\"" );
      stat = 1;
   end;
   if (Fields.GetID(NDFL_Price) == -1)
      log.RepStr("X", "", "", "", "", "", "","", "Отсутствует обязательная колонка: \""+NDFL_Price+"\"" );
      stat = 1;
   end;

   if (Fields.GetID(NDFL_Amount) == -1)
      log.RepStr("X", "", "", "", "", "", "","", "Отсутствует обязательная колонка: \""+NDFL_Amount+"\"" );
      stat = 1;
   end;
   if (Fields.GetID(NDFL_ACI) == -1)
      log.RepStr("X", "", "", "", "", "", "","", "Отсутствует обязательная колонка: \""+NDFL_ACI+"\"" );
      stat = 1;
   end;
   if (Fields.GetID(NDFL_Cms) == -1)
      log.RepStr("X", "", "", "", "", "", "","", "Отсутствует обязательная колонка: \""+NDFL_Cms+"\"" );
      stat = 1;
   end;
   if (Fields.GetID(NDFL_Storage) == -1)
      log.RepStr("X", "", "", "", "", "", "","", "Отсутствует обязательная колонка: \""+NDFL_Storage+"\"" );
      stat = 1;
   end;

   if ( not stat)

      row = 2;
      //Бежим по файлу
      InitProgress(-1);
      SP_BeginInsertBoardLot ();
      outfile.str = datafile.str;
      Insert(outfile);
      while (next(datafile))
         if (StrLen(trim(datafile.str)) == 0)
            continue;
         end;

         s_ClientPrev = s_Client;
         s_ContrNumPrev = s_ContrNum;
         s_ContrMpPrev = s_ContrMp;
         s_Client = s_ContrNum = s_ContrMp = s_Isin = s_Lsin = s_Amount = s_Guid = s_DateTime = s_Scale = s_Point = s_OperType = s_Qty = s_Curr = s_Price = s_Amount = s_ACI = s_CmsRur = s_Storage = s_OperNo = s_DboNo = "";
         BoardID = 0;

         s_Client   = StrSubst(trim(datafile(Fields.GetID(NDFL_GKK))),"\"","");
         s_Isin     = trim(datafile(Fields.GetID(NDFL_ISIN)));
         s_Lsin     = trim(datafile(Fields.GetID(NDFL_LSIN)));
         s_Qty      = trim(datafile(Fields.GetID(NDFL_Qty)));
         s_Curr     = trim(datafile(Fields.GetID(NDFL_Curr)));

         s_OperNo   = trim(datafile(Fields.GetID(NDFL_OperNo)));
         s_Price    = trim(datafile(Fields.GetID(NDFL_Price)));
         s_Amount   = trim(datafile(Fields.GetID(NDFL_Amount)));
         s_DateTime = trim(datafile(Fields.GetID(NDFL_DatePos)));

         s_ACI      = trim(datafile(Fields.GetID(NDFL_ACI)));
         s_CmsRur   = trim(datafile(Fields.GetID(NDFL_CmsRur)));
         s_Storage  = trim(datafile(Fields.GetID(NDFL_Storage)));      

         if (Fields.GetID(NDFL_DboNo) >=0)
           s_DboNo    = trim(datafile(Fields.GetID(NDFL_DboNo)));
         end;          

         if (LOAD_DATAFILE)
            log.CreateDataTable();/*создаем таблицу если ее нет*/
            log.InsData(s_Client, 
                        trim(datafile(Fields.GetID(NDFL_SecondName))),
                        trim(datafile(Fields.GetID(NDFL_FirstName))),
                        trim(datafile(Fields.GetID(NDFL_MiddleName))),
                        trim(datafile(Fields.GetID(NDFL_Phone))),
                        trim(datafile(Fields.GetID(NDFL_AgrNo))),
                        s_Isin,
                        trim(datafile(Fields.GetID(NDFL_LSIN))),
                        trim(datafile(Fields.GetID(NDFL_SecName))),
                        s_OperNo,
                        s_DateTime,
                        s_Qty,
                        s_Curr,
                        s_price,
                        s_AMOUNT,
                        s_Aci,
                        trim(datafile(Fields.GetID(NDFL_Cms))),
                        trim(datafile(Fields.GetID(NDFL_ValueRur))),
                        trim(datafile(Fields.GetID(NDFL_CmsRur))),
                        s_Storage,
                        trim(datafile(Fields.GetID(NDFL_Nominal))),
                        trim(datafile(Fields.GetID(NDFL_NominalCurr))),
                        trim(datafile(Fields.GetID(NDFL_PriceQty))) );
            row = row + 1;
            UseProgress(row);
            continue;
         end;

         if (StrLen(s_Client) == 0)
            ErrStat = 1;
            ErrStr = "Не задано поле \""+NDFL_GKK+"\", строка "+row;
            log.RepStr("X",s_Client,s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
            InsertOutStr(outfile, datafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), ErrStr);
            row = row + 1;
            UseProgress(row);
            err = err + 1;
            continue;
         end;

          if ((StrLen(s_Isin) == 0)
            and (StrLen(s_Isin) == 0))
            ErrStat = 1;
            ErrStr = "Не заданы поля \""+NDFL_ISIN+"\" и \""+NDFL_LSIN+"\", строка "+row;
            log.RepStr("X",s_Client, s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
            InsertOutStr(outfile, datafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), ErrStr);
            row = row + 1;
            UseProgress(row);
            err = err + 1;
            continue;
         end;

         if (StrLen(s_Qty) == 0)
            ErrStat = 1;
            ErrStr = "Не задано поле \""+NDFL_Qty+"\", строка "+row;
            log.RepStr("X",s_Client,s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
            InsertOutStr(outfile, datafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), ErrStr);
            row = row + 1;
            UseProgress(row);
            err = err + 1;
            continue;
         end;

         if (StrLen(s_Curr) == 0)
            ErrStat = 1;
            ErrStr = "Не задано поле \""+NDFL_Curr+"\", строка "+row;
            log.RepStr("X",s_Client,s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
            InsertOutStr(outfile, datafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), ErrStr);
            row = row + 1;
            UseProgress(row);
            err = err + 1;
            continue;
         end;
         CurFiid = -1;
         GetCurrByISO(s_Curr, @CurFiid);
         If(CurFiid == -1)
            ErrStat = 1;
            ErrStr = "Не удалось определить валюту по значению \""+s_Curr+"\", строка "+row;
            log.RepStr("X",s_Client,s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
            InsertOutStr(outfile, datafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), ErrStr);
            row = row + 1;
            UseProgress(row);
            err = err + 1;
            continue;
         end;


         if (StrLen(s_OperNo) == 0)
            ErrStat = 1;
            ErrStr = "Не задано поле \""+NDFL_OperNo+"\", строка "+row;
            log.RepStr("X",s_Client,s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
            InsertOutStr(outfile, datafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), ErrStr);
            row = row + 1;
            UseProgress(row);
            err = err + 1;
            continue;
         end;

         if (StrLen(s_Price) == 0)
            ErrStat = 1;
            ErrStr = "Не задано поле \""+NDFL_Price+"\", строка "+row;
            log.RepStr("X",s_Client,s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
            InsertOutStr(outfile, datafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), ErrStr);
            row = row + 1;
            UseProgress(row);
            err = err + 1;
            continue;
         end;

         if (StrLen(s_Amount) == 0)
            ErrStat = 1;
            ErrStr = "Не задано поле \""+NDFL_Amount+"\", строка "+row;
            log.RepStr("X",s_Client,s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
            InsertOutStr(outfile, datafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), ErrStr);
            row = row + 1;
            UseProgress(row);
            err = err + 1;
            continue;
         end;

         if (StrLen(s_DateTime) == 0)
            ErrStat = 1;
            ErrStr = "Не задано поле \""+NDFL_DatePos+"\", строка "+row;
            log.RepStr("X",s_Client,s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
            InsertOutStr(outfile, datafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), ErrStr);
            row = row + 1;
            UseProgress(row);
            err = err + 1;
            continue;
         end;

         DealDate = GetDt(s_DateTime);
         if (DealDate == "")
            ErrStat = 1;
            ErrStr = "Не удалось получить дату из \""+s_DateTime+"\", строка "+row;
            log.RepStr("X",s_Client,s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
            InsertOutStr(outfile, datafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), ErrStr);
            row = row + 1;
            UseProgress(row);
            err = err + 1;
            continue;
         end;
         DealTime = GetTm(s_DateTime);
         if (DealTime == "")
/*
            ErrStat = 1;
            ErrStr = "Не удалось получить время из \""+s_DateTime+"\", строка "+row;
            log.RepStr("X",s_Client,s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
            InsertOutStr(outfile, datafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), ErrStr);
            row = row + 1;
            UseProgress(row);
            err = err + 1;
            continue;
*/
            DealTime = Time("10:30:00");
         end;

/*

         s_ACI      = trim(datafile(Fields.GetID(NDFL_ACI)));
         s_CmsRur   = trim(datafile(Fields.GetID(NDFL_CmsRur)));
         s_Storage  = trim(datafile(Fields.GetID(NDFL_Storage)));

*/

         if (StrLen(s_ACI) == 0)
            ErrStat = 1;
            ErrStr = "Не задано поле \""+NDFL_ACI+"\", строка "+row;
            log.RepStr("X",s_Client,s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
            InsertOutStr(outfile, datafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), ErrStr);
            row = row + 1;
            UseProgress(row);
            err = err + 1;
            continue;
         end;

         if (StrLen(s_CmsRur) == 0)
            s_CmsRur = "0.0";
           /*
            ErrStat = 1;
            ErrStr = "Не задано поле \""+NDFL_CmsRur+"\", строка "+row;
            log.RepStr("X",s_Client,s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
            InsertOutStr(outfile, datafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), ErrStr);
            row = row + 1;
            UseProgress(row);
            err = err + 1;
            continue; */
         end;

         if (StrLen(s_Storage) == 0)
            ErrStat = 1;
            ErrStr = "Не задано поле \""+NDFL_Storage+"\", строка "+row;
            log.RepStr("X",s_Client,s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
            InsertOutStr(outfile, datafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), ErrStr);
            row = row + 1;
            UseProgress(row);
            err = err + 1;
            continue;
         end;
         if ( ( s_ClientPrev == "") or (s_Client != s_ClientPrev) or ErrStat)
            ClientID = GetCodeParty(s_Client, clientCodeKindForSearch);
            if (ClientID <= 0)
               ErrStat = 1;
               ErrStr = "Не найден клиент с видом кода "+clientCodeKindForSearch+" = \""+s_Client+"\", строка "+row;
               log.RepStr("X",s_Client,s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
               InsertOutStr(outfile, datafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), ErrStr);
               row = row + 1;
               UseProgress(row);
               err = err + 1;
               continue;
            end;
         end;
         Dbo = GetContrIDByClient(ClientID, s_Storage, @ContrID, @Contrdate,s_DboNo);
         If(Dbo == 2)
            ErrStat = 1;
            ErrStr = "Более одного ДБО по клиенту с кодом \""+s_Client+"\", строка "+row;
            log.RepStr("X",s_Client, s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
            InsertOutStr(outfile, datafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), ErrStr);
            row = row + 1;
            UseProgress(row);
            err = err + 1;
            continue;
         elif(Dbo == 0)
            ErrStat = 1;
            ErrStr = "Не найден ДБО "+s_DboNo+" по клиенту с кодом \""+s_Client+"\", строка "+row;
            log.RepStr("X",s_Client, s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
            InsertOutStr(outfile, datafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), ErrStr);
            row = row + 1;
            UseProgress(row);
            err = err + 1;
            continue;
         elif(Dbo == -1)
            ErrStat = 1;
            ErrStr = "Не удалось определить площадку по клиенту с кодом \""+s_Client+"\" и месту хранения \""+s_Storage+"\", строка "+row;
            log.RepStr("X",s_Client, s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
            InsertOutStr(outfile, datafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), ErrStr);
            row = row + 1;
            UseProgress(row);
            err = err + 1;
            continue;
         else
            If(ContrID == -1)
               ErrStat = 1;
               ErrStr = "Не удалось определить площадку по клиенту с кодом \""+s_Client+"\" и месту хранения \""+s_Storage+"\", строка "+row;
               log.RepStr("X",s_Client, s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
               InsertOutStr(outfile, datafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), ErrStr);
               row = row + 1;
               UseProgress(row);
               err = err + 1;
               continue;
            end;
         end;

         if (ContrID > 0)
            cmd = RsdCommand("update dclient_dbt c set c.t_startdate = ? where C.T_PARTYID = ?  and ? < c.t_startdate and c.t_servicekind = ? and c.t_startdate <> to_date('01010001','ddmmyyyy')");
            cmd.addParam("", RSDBP_IN, Contrdate);
            cmd.addParam("", RSDBP_IN, ClientID);
            cmd.addParam("", RSDBP_IN, Contrdate);
            cmd.addParam("", RSDBP_IN, 1);
            cmd.Execute();
         end;


         if (s_Isin == "G?'0B10RZP78") s_Isin = "GB00B10RZP78"; end; /*кривой исин*/

         Fiid = GetAvoiriss(s_Isin, s_Lsin, @AvoirKind);
         if (Fiid < 0 )
            ErrStat = 1;
            ErrStr = "Не найдена ценная бумага по ISIN \""+s_Isin+"\" и гос.рег \""+s_lsin+"\", строка "+row;
            log.RepStr("X",s_Client, s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
            InsertOutStr(outfile, datafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), ErrStr);
            row = row + 1;
            UseProgress(row);
            err = err + 1;
            continue;
         end;

         s_Point = 10;

         if (s_Storage == "3")
            CustodyID = GetCodeParty("00#Б#239654",1); //1450;
         elif (s_Storage == "2")
            CustodyID = GetCodeParty("НРД",1); //4;
         elif (s_Storage == "1")
            CustodyID = {OurBank};
         else
            ErrStat = 1;
            ErrStr = "Неизвестная торговая площадка \""+s_Storage+"\", строка "+row;
            log.RepStr("X",s_Client, s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
            InsertOutStr(outfile, datafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), ErrStr);
            row = row + 1;
            UseProgress(row);
            err = err + 1;
            continue;
         end;


         If(Contrdate == date(0,0,0))
             Contrdate = date("21.04.2022");  //Дата первой загрузки Депо остатков
         end;

         DealCode = s_OperNo + "_NDFL";
         if (CheckOpNo)
            if ( CheckExistsBoard(DealCode, ClientID, ContrID, Fiid, s_Qty, @BoardID, @DealCode1, @DealDate1, @TaxOwnBegDate) )

               if (TaxOwnBegDate != DealDate)

                  if (UpdateTaxOwnDate(DealCode, ClientID, Fiid, TaxOwnBegDate/*старая дата приобретения*/, DealDate/*Дата приобретения из файла*/, @msg) == 0)
                     ErrStat = 2;//Обновлено
                     ErrStr = "По операции "+s_OperNo+" обновлена дата нач.приобретения: с " + TaxOwnBegDate + " на " + DealDate;
                     log.RepStr("X",s_Client, s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
                  else
                     ErrStat = 1;
                     ErrStr = "Ошибка обновления даты нач.приобретения "  + @DealCode1;
                     log.RepStr("X",s_Client, s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
                  end;
               end;

               if (GetDelta(ClientID, Fiid) != double(s_Qty) )
                   ErrStat = 1;
                   ErrStr = "Ошибка. Операция "+s_OperNo+" уже загружалась: " + @DealCode1;
                   log.RepStr("X",s_Client, s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
                   InsertOutStr(outfile, datafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), ErrStr);
                   row = row + 1;
                   UseProgress(row);
                   err = err + 1;
                   continue;
               end;
            end;
         end;
         DealCode = CheckOperNo(DealCode);

         stat = CheckDepoBoard(ClientID, ContrID, Fiid, s_ISIN);
         If(stat == 1)
             ErrStat = 1;
             ErrStr = "Ошибка. Не найдено ДЕПО зачисление по клиенту  = " + s_Client + " и ценной бумаге " + s_ISIN;
             log.RepStr("X",s_Client, s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
             InsertOutStr(outfile, datafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), ErrStr);
             row = row + 1;
             UseProgress(row);
             err = err + 1;
             continue;
         end;
         //#DEF-46373
         /*if(DealDate > Contrdate)
           OperDate = DealDate;
         else
           If(Contrdate >= date("21.04.2022"))
              OperDate = Contrdate;
           else
              OperDate = date("21.04.2022");
           end;
         end;*/
         OperDate = {curdate};

         if ((NKD_IN_COST) and (double(s_ACI) != 0))
            Amount = double(s_Amount) - double(s_ACI);
         else
            Amount = double(s_Amount);
         end;

         stat = CreateDepoBoardWithPrice (
                                   DealCode, OperDate/*Contrdate*//*date("21.04.2022")*/, DealTime,
                                   ClientID,
                                   ContrID,
                                   Fiid,
                                   s_Qty, int(s_Point),
                                   CustodyID,
                                   false /*IsSingle*/, 1, CurFiid, s_Price, Amount, s_ACI, s_CmsRur, DealDate,
                                   @msg, @BoardID
                                    );

         if (stat == 0)
//            AddNoteForObject(OBJTYPE_SECDEAL, string(BoardID:o:34) , NOTEKIND_GUID, s_Guid);
              if( ( not DisconnectObjAttr(OBJTYPE_SECDEAL,  string(BoardID:o:34), OBJGROUP_VTBNDFL) ) OR
                  ( not ConnectObjAttr(stat, OBJTYPE_SECDEAL, string(BoardID:o:34), OBJGROUP_VTBNDFL, 1, null, null, {curdate}) )  OR
              ( stat != 0 ))
                  ErrStat = 1;
                  ErrStr = msg;
                  log.RepStr("X",s_Client, s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
                  InsertOutStr(outfile, datafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), ErrStr);
                  row = row + 1;
                  UseProgress(row);
                  err = err + 1;
                  continue;
              end;

            ErrStat = 0;
            ErrStr = DealCode;
            //log.RepStr("",s_Client, s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
            //InsertOutStr(outfile, datafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), string(BoardID));
            suc = suc + 1;
         else 
            ErrStat = 1;
            ErrStr = msg;
            log.RepStr("X",s_Client, s_OperNo, s_Isin, s_Lsin, s_Qty, s_DateTime, ErrStat, ErrStr);
            InsertOutStr(outfile, datafile, "|", Fields.FieldsCount, Fields.GetID(NDFL_PriceQty), ErrStr);
            row = row + 1;
            UseProgress(row);
            err = err + 1;
            continue;
         end;

         row = row+1;
         UseProgress(row);
         ErrStr = "";
         ErrStat = false;
      end;
      RemProgress();
      SP_EndInsertBoardLot ();

   else
      log.AddStr("Неверный формат файла");
   end;

   log.RepFooter(suc,err,suc+err, outfname);
   SetOutput( NULL, true ); //Пишем лог в файл. Конец

   c_file.closeFile(datafile);
   close(outfile);
   ViewFile( InfoLogFileName );

   errp = "";
   result_protocol.addString("Обработано " + row + " строк " );
   result_protocol.addString("Не загружено " + err + " записей " );
   result_protocol.addString("Загружено " + suc + " новых записей " );
   result_protocol.addString("Файл протокол: " + outfname );
   result_protocol.addString("Старт " + tmstart);
   result_protocol.addString("Окончание " + time() );
   return true;

End;



private macro CreateTable()
   var cmd;
   cmd = RsdCommand(
        "BEGIN \n" +
        "   EXECUTE IMMEDIATE 'CREATE TABLE UDEPOOP_READYEXEC (T_DEALID NUMBER(10) NOT NULL,T_CLIENTID NUMBER(10),T_SFCONTRID  NUMBER(10),T_DLCONTRID  NUMBER(10),T_PFI NUMBER(10),T_PRINCIPAL  NUMBER(32,12))'; \n" +
        "EXCEPTION \n" +
        "   WHEN OTHERS \n" +
        "   THEN \n" +
        "      NULL; \n" +
        "END; \n" );
   cmd.Execute();
   cmd = RsdCommand(
        "    BEGIN \n" +
        "       EXECUTE IMMEDIATE 'CREATE TABLE UNDFLOP_READYEXEC (T_DEALID NUMBER(10) NOT NULL,T_CLIENTID NUMBER(10),T_SFCONTRID  NUMBER(10),T_DLCONTRID  NUMBER(10),T_PFI        NUMBER(10),T_PRINCIPAL  NUMBER(32,12))'; \n" +
        "    EXCEPTION \n" +
        "       WHEN OTHERS \n" +
        "       THEN \n" +
        "          NULL; \n" +
        "    END; \n" );
   cmd.Execute();

   cmd = RsdCommand(
        "    BEGIN \n" +
        "       EXECUTE IMMEDIATE 'CREATE INDEX UNDFLOP_READYEXEC_IDX1 ON UNDFLOP_READYEXEC (T_CLIENTID, T_PFI)'; \n" +
        "    EXCEPTION \n" +
        "       WHEN OTHERS \n" +
        "       THEN \n" +
        "          NULL; \n" +
        "    END; \n" );
   cmd.Execute();

   cmd = RsdCommand(
        "    BEGIN \n" +
        "       EXECUTE IMMEDIATE 'CREATE INDEX UNDFLOP_READYEXEC_IDX2 ON UNDFLOP_READYEXEC (T_DLCONTRID, T_PFI)'; \n" +
        "    EXCEPTION \n" +
        "       WHEN OTHERS \n" +
        "       THEN \n" +
        "          NULL; \n" +
        "    END; \n" );
   cmd.Execute();

   cmd = RsdCommand(
        "    BEGIN \n" +
        "       EXECUTE IMMEDIATE 'CREATE INDEX UDEPOOP_READYEXEC_IDX2 ON UDEPOOP_READYEXEC (T_DLCONTRID, T_PFI)'; \n" +
        "    EXCEPTION \n" +
        "       WHEN OTHERS \n" +
        "       THEN \n" +
        "          NULL; \n" +
        "    END; \n" );
   cmd.Execute();


   cmd = RsdCommand(
        "    BEGIN \n" +
        "       EXECUTE IMMEDIATE 'DROP TABLE UVTB_CHECKOP_DBT'; \n" +
        "    EXCEPTION \n" +
        "       WHEN OTHERS \n" +
        "       THEN \n" +
        "          NULL; \n" +
        "    END; \n" );
   cmd.Execute();

   cmd = RsdCommand(
        "    BEGIN \n" +
        "       EXECUTE IMMEDIATE 'CREATE TABLE UVTB_CHECKOP_DBT (T_DEALID_NDFL NUMBER(10),T_DEALID_DEPO NUMBER(10) NOT NULL,T_SFCONTRID NUMBER(10),T_DLCONTRID NUMBER(10),T_CLIENTID NUMBER(10),T_PFI NUMBER(10),T_PRINCIPAL NUMBER(32,12),T_PRINCIPAL_DEPO  NUMBER(32,12),T_NDFL_SUM NUMBER,T_DEPO_SUM NUMBER)'; \n" +
        "    EXCEPTION \n" +
        "       WHEN OTHERS \n" +
        "       THEN \n" +
        "          NULL; \n" +
        "    END; \n" );
   cmd.Execute();

   cmd = RsdCommand(
        "    BEGIN \n" +
        "       EXECUTE IMMEDIATE 'CREATE INDEX UVTB_CHECKOP_DBT_IDX0 ON UVTB_CHECKOP_DBT (T_DEALID_NDFL)'; \n" +
        "    EXCEPTION \n" +                                   
        "       WHEN OTHERS \n" +
        "       THEN \n" +
        "          NULL; \n" +
        "    END; \n" );
   cmd.Execute();
   cmd = RsdCommand(
        "    BEGIN \n" +
        "       EXECUTE IMMEDIATE 'CREATE INDEX UVTB_CHECKOP_DBT_IDX1 ON UVTB_CHECKOP_DBT(T_CLIENTID)'; \n" +
        "    EXCEPTION \n" +                                   
        "       WHEN OTHERS \n" +
        "       THEN \n" +
        "          NULL; \n" +
        "    END; \n" );
   cmd.Execute();

end;

private macro ReFillTable()
   var cmd;
   cmd = RsdCommand(
        "BEGIN \n" +
        "   EXECUTE IMMEDIATE ' truncate table UDEPOOP_READYEXEC '; \n" +
        "   EXECUTE IMMEDIATE ' truncate table UNDFLOP_READYEXEC '; \n" +
        "   EXECUTE IMMEDIATE ' truncate table UVTB_CHECKOP_DBT '; \n" +
        "END; \n" );
   cmd.Execute();
   EndAction(0);
   Message(" Подготовка данных. Шаг 1/6 Депо зачисления");
   BegAction(0, " Подготовка данных. Шаг 1/6 Депо зачисления");
   cmd = RsdCommand(
        "insert into uDEPOOP_ReadyExec  \n" +
        "SELECT tick.t_dealid, tick.t_clientid, tick.t_clientcontrid as t_sfcontrid, mp.t_dlcontrid, decode(leg.T_PFI,2544,60775,leg.T_PFI) t_pfi, leg.T_PRINCIPAL * CASE WHEN tick.t_dealtype IN (2011, 32011) THEN 1 WHEN tick.t_dealtype IN (2010) THEN -1 END t_principal \n" +
        "  FROM ddl_tick_dbt tick, dnotetext_dbt text, dobjcode_dbt code, ddlcontrmp_dbt mp, ddl_leg_dbt leg \n" +
        "WHERE     tick.t_bofficekind = 127 \n" +
        "       AND text.t_objecttype = 101 \n" +
        "       AND text.t_documentid = LPAD (tick.t_dealid, 34, '0') \n" +
        "       AND text.t_notekind = 404 \n" +
        "       AND code.T_OBJECTTYPE = 3 \n" +
        "       AND code.T_CODEKIND = 101 \n" +
        "       AND code.T_OBJECTID = tick.T_CLIENTID \n" +
        "       AND code.t_state = 0 \n" +
        "       and mp.T_SFCONTRID = tick.t_clientcontrid \n" +
        "       and leg.t_legkind = 0 and leg.t_legid = 0 and leg.t_dealid = tick.t_dealid; \n" 
        //"       and Not Exists(SELECT 1 FROM dobjatcor_dbt cor WHERE cor.t_ObjectType = 101 and cor.t_Object = LPAD (tick.t_dealid, 34, '0') and cor.t_GroupID = 111 and cor.t_AttrID = 2); \n" DEF-48874
        );
   cmd.Execute();
   EndAction(0);

   BegAction(1, " Подготовка данных. Шаг 2/6 ВТБ зачисления");
   Message(" Подготовка данных. Шаг 2/6 ВТБ зачисления");
   cmd = RsdCommand(
        " insert into uNDFLOP_ReadyExec SELECT  \n" +
        "tick.t_dealid, tick.t_clientid, tick.t_clientcontrid as t_sfcontrid, mp.t_dlcontrid, decode(leg.T_PFI,2544,60775,leg.T_PFI) T_PFI, leg.T_PRINCIPAL  \n" +
        "  FROM ddl_tick_dbt tick, dobjatcor_dbt cor, ddlcontrmp_dbt mp, ddl_leg_dbt leg  \n" +
        " WHERE     tick.t_bofficekind = 127  \n" +
       // "       AND tick.t_dealstatus != 20  \n" +
        "       AND tick.t_dealdate <= SYSDATE  \n" +
        "       AND cor.t_objecttype = 101  \n" +
        "       AND cor.t_object = LPAD (tick.t_dealid, 34, '0')  \n" +
        "       AND cor.t_groupid = 210  \n" +
        "       and mp.T_SFCONTRID = tick.t_clientcontrid  \n" +
        "       and leg.t_legkind = 0 and leg.t_legid = 0 and  leg.t_dealid = tick.t_dealid; \n" );
   cmd.Execute();
   EndAction(0);

   BegAction(1, " Подготовка данных. Шаг 3/6 Учет конвертаций");
   Message(" Подготовка данных. Шаг 3/6 Учет конвертаций");
   cmd = RsdCommand(
        "DELETE FROM uDEPOOP_ReadyExec \n" +
        "      WHERE t_dealid IN \n" +

          " ( SELECT o.t_dealid  " +
          "                    FROM uDEPOOP_ReadyExec o, ddl_tick_dbt t  " +
          "                   WHERE                        /*o.t_clientid = 116019 and */  " +
          "                        t.t_dealid = o.t_dealid  " +
          "                        and O.T_PRINCIPAL < 0 " +
          "                         AND EXISTS  " +
          "                                (SELECT 1  " +
          "                                   FROM uDEPOOP_ReadyExec o1, ddl_tick_dbt t1  " +
          "                                  WHERE     o1.t_dealid = t1.t_dealid  " +
          "                                        AND t1.t_dealdate = t.t_dealdate  " +
          "                                        AND t1.t_pfi = t.t_pfi  " +
          "                                        AND t1.t_clientcontrid <>  " +
          "                                               t.t_clientcontrid  " +
          "                                        AND o.t_principal = -o1.t_principal  " +
          "                                        AND o.t_dlcontrid = o1.t_dlcontrid)  " +
          "                                        and exists ( select 1 from U_CONV_ADR_DATA_DBT d where d.t_fiid_new = t.t_pfi and D.T_FLAG1 = chr(88)) ) "); 
   cmd.Execute();
   EndAction(0);

   BegAction(1, " Подготовка данных. Шаг 4/6 Учет переводов");
   Message(" Подготовка данных. Шаг 4/6 Учет переводов");
   cmd = RsdCommand(
        "DELETE FROM uDEPOOP_ReadyExec \n" +
        "      WHERE t_dealid IN \n" +
        "               (  SELECT o.t_dealid \n" +
        "                    FROM uDEPOOP_ReadyExec o, ddl_tick_dbt t \n" +
        "                   WHERE                        /*o.t_clientid = 116019 and */ \n" +
        "                        t.t_dealid = o.t_dealid \n" +
        "                         AND EXISTS \n" +
        "                                (SELECT 1 \n" +
        "                                   FROM uDEPOOP_ReadyExec o1, ddl_tick_dbt t1 \n" +
        "                                  WHERE     o1.t_dealid = t1.t_dealid \n" +
        "                                        AND t1.t_dealdate = t.t_dealdate \n" +
        "                                        AND t1.t_pfi = t.t_pfi \n" +
        "                                        AND t1.t_clientcontrid <> \n" +
        "                                               t.t_clientcontrid \n" +
        "                                        AND o.t_principal = -o1.t_principal \n" +
        "                                        AND o.t_dlcontrid = o1.t_dlcontrid) \n" +
        "                ) \n" );
   cmd.Execute();
   EndAction(0);

   BegAction(1, " Подготовка данных. Шаг 5/6 Сверка остатков");
   Message(" Подготовка данных. Шаг 5/6 Сверка остатков");
   cmd = RsdCommand(
        "  insert into  UVTB_CHECKOP_DBT   \n" +
        "  select   \n" +
        "  op_ndfl.t_dealid t_dealid_ndfl,  \n" +
        "  op_depo.t_dealid t_dealid_depo,  \n" +
        "  op_depo.t_sfcontrid, op_depo.t_dlcontrid, op_depo.t_clientid, op_depo.t_pfi, op_ndfl.t_principal, op_depo.t_principal t_principal_depo,  \n" +
        "  (SELECT SUM (op.t_principal)  \n" +
        "          FROM uNDFLOP_ReadyExec op \n" +
        "         WHERE op.T_DLCONTRID = op_ndfl.T_DLCONTRID  \n" +
        "               AND op.T_pfi = op_ndfl.T_pfi)  t_ndfl_sum,      (SELECT SUM (op_depo.t_principal)  \n" +
        "          FROM uDEPOOP_ReadyExec op_depo  \n" +
        "         WHERE op_depo.T_DLCONTRID = op_ndfl.T_DLCONTRID  \n" +
        "               AND op_depo.T_pfi = op_ndfl.T_pfi) t_depo_sum    \n" +
        "   from uDEPOOP_ReadyExec op_depo left join uNDFLOP_ReadyExec op_ndfl on  op_depo.T_DLCONTRID = op_ndfl.T_DLCONTRID  \n" +
        "               AND op_depo.T_pfi = op_ndfl.T_pfi \n" );

   cmd.Execute();
   EndAction(0);
   BegAction(1, " Подготовка данных. Шаг 6/6 Обновление статистики");
   Message(" Подготовка данных. Шаг 6/6 Обновление статистики");
   cmd = RsdCommand(
        "BEGIN \n" +
        "        dbms_stats.gather_table_stats(ownname => SYS_CONTEXT('USERENV','CURRENT_SCHEMA'), \n" +
        "        tabname => 'UVTB_CHECKOP_DBT', \n" +
        "        estimate_percent => DBMS_STATS.AUTO_SAMPLE_SIZE, \n" +
        "        cascade=>TRUE, method_opt=>'FOR ALL COLUMNS SIZE AUTO'); \n" +
        "  END; \n" );
   cmd.Execute();
   EndAction(0);


end;


macro runProcessLot2NDFL(errp:@string , result_protocol:@variant)
   Var cmd, DataSet, er, cmd1;
   var ArrDeal = tarray(),recs = 0, errrecs = 0, RunDate = {curdate}, documentid, i = 0;
      
   EndAction(0);
   CreateTable();
   ReFillTable();
      
   var nCount :integer = 0;
   var nSql = "select t_dealid_ndfl from (select op.* from uVTB_checkOp_dbt op, ddl_tick_dbt tick where op.t_dealid_ndfl = tick.t_dealid and op.t_depo_sum = op.t_ndfl_sum and tick.t_dealstatus != 20 order by op.t_clientid) group by t_dealid_ndfl";
   var nCmd = Dl_RsDCommand();
   
   endaction(0);
   begaction(1, "Подсчет количества необработанных операций");
   Message("Подсчет количества необработанных операций");

   var nRecs = nCMD.GetCount(nSql);
   nCount = nRecs;
   endaction(0);

   GetInt(nCount, "Введите размер обрабатываемой пачки.\n Всего к обработке имеется " + nRecs + " записей. \n ");
   

   if (nCount > 0)
     nSql = String("select * from (", nSql, ") t where rownum <= " + nCount);
   else
     return true;
   end;

   Initprogress(2, "Исполнение операций зачисления ВТБ для НДФЛ", "Этапы проведения операций зачисления цб");

   cmd = RsdCommand (nSql);

   cmd.addParam("",RSDBP_IN, RunDate);
   begaction(1, "Выполняется отбор сделок зачисления для обработки");
   Message("Выполняется отбор сделок зачисления для обработки");
   DataSet = RsdRecordSet(cmd);
   
   while (DataSet.movenext())
      
      ArrDeal[recs] = DataSet.value("t_dealid_ndfl");
      recs = recs + 1;
   end;
   endaction(0);
     
   result_protocol.addString("Отобрано сделок зачисления " + recs );

   result_protocol.addString("Старт проведения сделок зачисления " + time() );
   begaction(1, "Выполняется проведение сделок зачисления");
   Message("Выполняется проведение сделок зачисления");
   if(SP_ExecDeal(ArrDeal, false, RunDate) != 0)
      result_protocol.AddString("Ошибка при проведении сделок зачисления '");
      errrecs = errrecs + 1;
   else
      result_protocol.AddString("проведение сделок выполнено " + time());
   end;
   endaction(0);
   UseProgress(i = i + 1);

   Remprogress();

   
   return true;

OnError(er)
      result_protocol.AddString("Ошибка при проведении сделок зачисления ' " + er.Message);
      return false;

End;

macro getLink(vtbid)

   var rs = TRsbDataSet(" SELECT vtb_data.operno, tick.t_dealcode                                  " +
                        "   FROM uvtb_data  vtb_data                                               " +
                        "        INNER JOIN ddl_tick_dbt tick ON tick.t_dealid = vtb_data.t_dealid " +
                        "  WHERE vtb_data.t_id = "+vtbid+"                                         ");
   if(rs.movenext)
      setParm(1, rs);
      return true;
   end;

   return false;
end;

macro linkDealToVtbOperation(vtbOpid, dealid)
   /** Убираем старые привязки */
   var eraseCmd = rsdCommand(" UPDATE uvtb_data                                             " +
                             "    SET t_dealid = 0, t_dealcode = CHR (1), t_state = CHR (1) " +
                             "  WHERE t_dealid = :1                                         ");
   eraseCmd.AddParam("", RSDBP_IN, dealid);
   eraseCmd.execute();

   /** Делаем новую */
   var setCmd = rsdCommand(" UPDATE uvtb_data                        " +
                           "    SET (t_dealid, t_dealcode) =         " +
                           "            (SELECT t_dealid, t_dealcode " +
                           "               FROM ddl_tick_dbt         " +
                           "              WHERE t_dealid = :1),      " +
                           "        t_state = 'OKF'                  " +
                           "  WHERE t_id = :2                        ");   
   setCmd.AddParam("", RSDBP_IN, dealid);
   setCmd.AddParam("", RSDBP_IN, vtbOpid);

   setCmd.execute();
end;

//const KEY_F2 = 316;
const KEY_F6 = 320;
const KEY_CTRL_R = 18;

var SaveDealid = 0;
macro eRunOpList(rs, cmd, id, key)
   if(cmd == DLG_INIT)
      if(SaveDealid > 0)
         while(rs.movenext)
            if(SaveDealid == rs.value("t_dealid"))
              GoToScroll(rs);
              break;
            end;
         end;
      end;
   elif(cmd == DLG_KEY)
      if(key == KEY_F2)
         var doLink = true;
         if(rs.value("t_opCode") != "")
            GetTrue(doLink, "Операция "+rs.value("t_dealcode")+" уже связана с исходной записью "+rs.value("t_opCode")+". |При продолжении связка будет удалена. Продолжить?");
         end;

         var lnkOp;
         if(doLink and getLink(rs.value("parentid"), lnkOp))
            GetTrue(doLink, "Исходная запись "+lnkOp.operno+" уже связана с операций "+lnkOp.dealcode+". Заменить привязку?");
         end;

         if(doLink)
            linkDealToVtbOperation(rs.value("parentid"), rs.value("t_dealid"));
         else
            return CM_IGNORE;
         end;

         SaveDealid = rs.value("t_dealid");
         return CM_SELECT;         
      end;
   end;
end;

macro RunClientEnrolListByFiid(vtbrow, fiid)
   var sql = " SELECT tick.t_dealcode,                                                          " +
             "        NVL (vtbdata.operno, chr(1)) t_opCode,                                    " +
             "        tick.t_dealdate,                                                          " +
             "        NVL (TO_DATE (vtbdata.DATEPOS, 'dd.mm.yyyy hh24:mi:ss'),                  " +
             "             TO_DATE ('01.01.0001 00:00:00', 'dd.mm.yyyy hh24:mi:ss')) t_buydate, " +
             "        avr.t_isin,                                                               " +
             "        fin.t_name t_finame,                                                      " +
             "        leg.t_principal,                                                          " +
             "        leg.t_price,                                                              " +
             "        alg.T_SZNAMEALG t_dealstate,                                              " +
             "        party.t_name,                                                             " +
             "        contr.t_number,                                                           " +
             "        tick.t_dealid,                                                            " +
             "        "+int(vtbrow.recid)+" parentid                                            " +
             "   FROM ddl_tick_dbt tick                                                         " +
             "        INNER JOIN ddl_leg_dbt leg ON leg.t_dealid = tick.t_dealid                " +
             "        INNER JOIN dfininstr_dbt fin ON fin.t_fiid = tick.t_pfi                   " +
             "        INNER JOIN davoiriss_dbt avr ON avr.t_fiid = tick.t_pfi                   " +
             "        INNER JOIN dparty_dbt party ON party.t_partyid = tick.t_clientid          " +
             "        INNER JOIN dsfcontr_dbt contr ON contr.t_id = tick.t_clientcontrid        " +
             "        INNER JOIN dnamealg_dbt alg                                               " +
             "            ON alg.T_INUMBERALG = tick.T_DEALSTATUS AND alg.T_ITYPEALG = 3155     " +
             "        LEFT JOIN UVTB_DATA vtbdata ON vtbdata.T_DEALID = tick.t_dealid           " +
             "  WHERE     tick.t_bofficekind = 127                                              " +
             "        AND tick.t_dealtype = 2011                                                " +
             "        AND tick.t_clientid = "+vtbrow.clientid+"                                 " +
             "        AND tick.t_flag3 = CHR (88)                                               " +
             "        AND EXISTS                                                                " +
             "                (SELECT 1                                                         " +
             "                   FROM dobjatcor_dbt cor                                         " +
             "                  WHERE     cor.t_objecttype = 101                                " +
             "                        AND cor.t_groupid = 210                                   " +
             "                        AND t_object = LPAD (tick.t_dealid, 34, '0'))             ";

   if((fiid == null) or (fiid == nullVal))
      fiid = -1;
   end;

   if(fiid != 0)
      sql = sql + " AND tick.t_pfi = "+fiid;
   end;

   var rs = RSDRecordset(sql, RSDVAL_CLIENT, RSDVAL_STATIC);
   while(
   RunScroll(rs, 11, MakeArray("t_dealcode", "Код операции",           20,  2, -1, 0,
                               "t_opCode"  , "Код связанной операции", 10,  2, -1, 0,
                               "t_dealdate", "Дата операции",          10,  2, -1, 0,
                               "t_buydate",  "Дата исходной покупки",  10,  2, -1, 0,
                               "t_name",     "ФИО клиента",            80,  2, -1, 0,
                               "t_number",   "Номер договора",         20,  2, -1, 0,
                               "t_isin",     "ISIN",                   20,  2, -1, 0,
                               "t_finame",   "Наименование выпуска",   20,  2, -1, 0,
                               "t_principal","Количество",             10,  2, -1, 0,
                               "t_price",    "Цена",                   10,  2, -1, 0,
                               "t_dealstate","Статус",                 10,  2, -1, 0
                              ),
             "eRunOpList", "eRunOpList", "Просмотр и привязка операций",
             "~F2~ Выполнить привязку ~Esc~ Выход")
   )
      /** если runScroll вернул true, то было нажато F2 и вернулось CM_SELECT */
      vtbrow.dealid = rs.value("t_dealid");
      vtbrow.dealcode = rs.value("t_dealcode");

      rs = RSDRecordset(sql, RSDVAL_CLIENT, RSDVAL_STATIC);
   end;
end;

macro getClientIdByGkk(gkk)
   var cmd = rsdCommand(" SELECT t_objectid                                                            " +
                        "   FROM dobjcode_dbt                                                          " +
                        "  WHERE t_codekind = 109 AND t_objecttype = 3 AND t_state = 0 AND t_code = :1 ");
   cmd.AddParam("", RSDBP_IN, gkk);
   
   var rs = rsdRecordset(cmd);
   if(rs.movenext)
      return rs.value("t_objectid");
   end;

   return 0;
end;

var rowsLoaded = 0;
var rowsLoadedEarlier = 0;
var rowsMappingErrors = 0;
var rowsLoadingErrors = 0;
var rowsClientNotFound = 0;
macro loadByRow(rs:@rsdrecordset, errMsg:@string)
   if(getClientIdByGkk(rs.value("GKK")) == 0) 
      rowsClientNotFound = rowsClientNotFound + 1;
      return;
   end;



   var VtbRow = TVtbTableRow(rs);

   if(VtbRow.dealid == null)
      TVtbTableSource().mapOne(VtbRow);
      if(VtbRow.dealid != null)
         rs.edit();
         rs.value("T_DEALID") = VtbRow.Dealid;
         rs.value("T_DEALCODE") = VtbRow.DealCode;
         rs.value("T_STATE") = "OKM";
         rs.update();

         rowsLoadedEarlier = rowsLoadedEarlier + 1;
         return;
      end;
   end;

   if(not createBoardByRow(VtbRow))
      errMsg = VtbRow.ErrStr;

      rs.edit();
      rs.value("T_COMMENT") = VtbRow.ErrStr;
      rs.update();

      rowsLoadingErrors = rowsLoadingErrors + 1;
   end;

   if(VtbRow.Clientid != null)
      rs.edit();
      rs.value("T_CLIENTID") = VtbRow.Clientid;
      rs.update();
   end;

   if(VtbRow.Dealid != null)
      rs.edit();
      rs.value("T_DEALID") = VtbRow.Dealid;
      rs.value("T_DEALCODE") = VtbRow.DealCode;
      
      if(not VtbRow.ErrStat)
         rs.value("T_STATE") = "OKL";
         rs.value("T_COMMENT") = "";
         rowsLoaded = rowsLoaded + 1;

         SP_ExecDeal(int(VtbRow.Dealid), false);

      elif(VtbRow.ErrStat == 3) // Уже было загружено
         rs.value("T_STATE") = "OKM";
         rowsLoadedEarlier = rowsLoadedEarlier + 1;
      end;
      
      rs.update();
   end;

end;

const KEY_ESC = 27;
class (TRsbPanel) TUvtbDataScrollFilterPanel(initObject)
   InitTRsbPanel();
   setSize(63, 10);
   setPosition(35, 15);
   setCaption("Фильтр");
   setStatus("~F2~ Применить  ~Esc~ Выход");

   class (TRsbEditField) EditField(typeFld: integer, x: integer, y: integer, width: integer, height: integer, bindVal, active: bool, fieldName: string, panel)
      var bindString = string(bindVal);
      
      initTRsbEditField(typeFld);
      setPosition(x, y);
      setSize(width, height);
      
      if(active == false) 
         editable = focusable = false; 
      end;

      if(typeFld == FT_STRING)
         bindValue( panel, bindVal, 100 );
      elif(bindVal != null)
         value = bindVal; 
      end;

      if(panel != null)
         panel.addControl(this); 
      end;

      if(fieldName != null) 
         name = fieldName; 
      end;
   end;

   addLabel(TRsbLabel(3, 2, "Код ГКК:"));
   var gkkCode:String = initObject.gkkCode;
   var m_gkkCode = EditField( FT_STRING, 10, 2, 20, 1, "gkkCode", true, "m_gkkCode", this );

   addLabel(TRsbLabel(3, 4, "ISIN:"));
   var isin:String = initObject.isin;
   var m_isin = EditField( FT_STRING, 10, 4, 20, 1, "isin", true, "m_isin", this );

   addLabel(TRsbLabel(3, 6, "Статус:"));
   var state:String = initObject.state;
   var m_state = EditField( FT_STRING, 10, 6, 5, 1, "state", true, "m_state", this );

   addLabel(TRsbLabel(3, 8, "Клиент:")); 
   var ClientID = initObject.ClientID, ClientCode = initObject.ClientCode, ClientName = initObject.ClientName;
    
   var m_clientcode = EditField( FT_STRING, 10, 8, 15, 1, "ClientCode", true, "m_clientcode", this );
   var m_clientname = EditField( FT_STRING, 26, 8, 35, 1, "ClientName", false, "m_clientname", this );

   m_clientcode.rawType = FBT;

   addEventHandler(RSB_EV_KEY_PRESSED, R2M(this, "Panel_ButtonEvent"));

   macro Panel_ButtonEvent(RsbEvent)
      if(RsbEvent.keyCode == KEY_F2)
         close(1);
      elif(RsbEvent.keyCode == KEY_ESC)
         close(0);
      elif(RsbEvent.keyCode == KEY_F3)
        //Выбор клиента
        if(StrUpr(RsbEvent.source.name) == "M_CLIENTCODE")
          var Choise = Dl_ScrollW(  " select pt.t_PartyID, pt.t_ShortName as ClientName, RSB_SECUR.SC_GetObjCodeOnDate("+OBJTYPE_PARTY+", 1, pt.t_PartyID) as ClientCode "
                                 + "   from dparty_dbt pt "
                                 + "  where pt.t_PartyID in (select t_PartyID from dclient_dbt) ", "Клиенты", 10, 5,
                                 "ClientCode", "Код клиента", 20,
                                 "ClientName", "Краткое наименование", 61);
          if (Choise != null)
            ClientID           = Choise.value("t_PartyID");
            ClientCode = m_clientcode.value = Choise.value("ClientCode");
            ClientName = m_clientname.value = Choise.value("ClientName");
          end;
        end;
      elif(RsbEvent.keyCode == KEY_SPACE)
        if(StrUpr(RsbEvent.source.name) == "M_CLIENTCODE")
          ClientID           = -1;
          ClientCode = m_clientcode.value = "";
          ClientName = m_clientname.value = "";
        end;
      end;
   end;
end;

class TUvtbDataScrollFilter()
   var gkkCode = "";
   var isin = "";
   var state = "";
   var ClientID = -1;
   var ClientCode = "";
   var ClientName = "";

   var UvtbDataScrollFilterStr = "";

   macro initFilterByPanel(panel)
      gkkCode = panel.gkkCode;
      isin = panel.isin;
      state = panel.state;
      ClientID = panel.ClientID;
      ClientCode = panel.ClientCode;
      ClientName = panel.ClientName;
   end;

   macro createFilterStr()
      var resultFilter = "";
      if(gkkCode != "")
         if(resultFilter != "")
            resultFilter = resultFilter + " AND ";
         end;
         resultFilter = resultFilter + " VTBDATA.GKK like '%" + gkkCode + "%'";
      end;

      if(isin != "")
         if(resultFilter != "")
            resultFilter = resultFilter + " AND ";
         end;
         resultFilter = resultFilter + " VTBDATA.isin like '%" + isin + "%'";
      end;

      if(state != "")
         if(resultFilter != "")
            resultFilter = resultFilter + " AND ";
         end;
         resultFilter = resultFilter + " VTBDATA.t_state like '%" + state + "%'";
      end;

      if(ClientID > 0)
         if(resultFilter != "")
            resultFilter = resultFilter + " AND ";
         end;
         resultFilter = resultFilter + " VTBDATA.t_ClientID = " + ClientID;
      end;

      if(resultFilter != "")
         resultFilter = " WHERE " + resultFilter + " ";
      end;

      UvtbDataScrollFilterStr = resultFilter;

      return UvtbDataScrollFilterStr;
   end;

end;

var UvtbDataScrollFilterObj = TUvtbDataScrollFilter();

var currentPage = 0;
var SaveVtbDataId = 0;
var inprocessprogress = 0;

const  KEY_CTRL_LEFT   =371;
const  KEY_CTRL_UP     =397;
const  KEY_CTRL_RIGHT  =372;
const  KEY_CTRL_DOWN   =401;
const  KEY_CTRL_P      =16;
const  KEY_CTRL_F2     =351;
const  KEY_F5          =319;
const  KEY_F8          =322;
macro eRunProcessDialog(rs, cmd, id, key)
   var newPage = currentPage;
   array  a;

   if(cmd == DLG_INIT)
      if(SaveVtbDataId > 0)
         while(rs.movenext)
            if(SaveVtbDataId == rs.value("t_id"))
               GoToScroll(rs);
               break;
            end;
         end;
      end;

      AddMultiAction(rs, KEY_F2);
      AddMultiAction(rs, KEY_F8);
   /*Старт обработки выделенных записей*/
   elif(cmd == DLG_MSELSTART)
      inprocessprogress = 0;
      rowsLoaded = 0;
      rowsLoadedEarlier = 0;
      rowsMappingErrors = 0;
      rowsLoadingErrors = 0;
      rowsClientNotFound = 0;
      if(msgboxex("Выполнить обработку выделеных записей?", MB_YES + MB_NO, IND_YES) == IND_YES)
         InitProgress(int(GetMultiCount()), "Ждите...", "Обработка записей");
      else
         return CM_MSEL_STOP_KEEP;
      end;
   elif(cmd == DLG_MSELEND)
      RemProgress();
      if(key == KEY_F2)
         msgboxex("Обработка завершена.|| Загружено "        +rowsLoaded+
                                      "|| Ранее загружено "  +rowsLoadedEarlier+
                                      "|| Ошибка маппинга "  +rowsMappingErrors+
                                      "|| Ошибка загрузки "  +rowsLoadingErrors+
                                      "|| Не найден клиент " +rowsClientNotFound+" ");
      else
         msgboxex("Обработка завершена");
      end;
      UpdateScroll(rs, 5);
   elif(cmd == DLG_MSEL)
      if(key == KEY_F2)
         if(     not (rs.value("T_STATE") == "OKM") 
             and not (rs.value("T_STATE") == "OKL"))
            loadByRow(@rs);
         else
            rowsLoadedEarlier = rowsLoadedEarlier + 1;
         end;

         inprocessprogress = inprocessprogress + 1;
         UseProgress(inprocessprogress);
         return CM_MSEL_CONT_CLEAR;
      elif(key == KEY_F8)
         rs.edit();
         rs.value("T_STATE")    = null;
         rs.value("T_COMMENT")  = null;
         rs.value("T_DEALID")   = nullVal;
         rs.value("T_DEALCODE") = nullVal;
         rs.update();
      end;
   elif(cmd == DLG_KEY)
      if(key == KEY_F5)
         var panel = TUvtbDataScrollFilterPanel(UvtbDataScrollFilterObj);
         var panelstate = panel.run();

         if(panelstate == 1)
            UvtbDataScrollFilterObj.initFilterByPanel(panel);
            UvtbDataScrollFilterObj.createFilterStr();
            return CM_SELECT;
         end;

         return CM_IGNORE;
      elif(key == KEY_F6)
         if(rs.value("T_CLIENTID") == nullVal)
            msgbox("Клиент не задан");
            return CM_IGNORE;
         end;
         a(0) = "Просмотр загруженных операций по выпуску";
         a(1) = "Просмотр всех загруженных операций клиента";
         var resultChoice = Menu(a, NULL, NULL, 4, 6);
         var vtbrow = TVtbTableRow(rs);
         if(resultChoice == 0)
            RunClientEnrolListByFiid(vtbrow, vtbrow.fiid);
         elif(resultChoice == 1)
            RunClientEnrolListByFiid(vtbrow, 0);
         end;

         if(vtbrow.dealid != null)
            rs.edit();
            rs.value("T_DEALID") = VtbRow.Dealid;
            rs.value("T_DEALCODE") = VtbRow.DealCode;
            rs.value("T_STATE") = "OKF";
            rs.update();

            UpdateScroll(rs, 2);
            return CM_SAVE;            
         else
            return CM_IGNORE;
         end;
      elif(key == KEY_F2)
         if(    (rs.value("T_STATE") == "OKM") 
             or (rs.value("T_STATE") == "OKL"))

            msgBox("Запись уже была загружена");
            return CM_IGNORE;
         end;
         var errMsg = "";
         loadByRow(@rs, @errMsg);

         if(errMsg != "")
            msgBox(errMsg);
         end;

         UpdateScroll(rs, 2);
         return CM_SAVE;

      elif(key == KEY_CTRL_F2)
         if((ValType(rs.value("t_id")) == V_INTEGER) and (rs.value("t_id") > 0))
           loadBySource(TVtbTableSource());
         end;
         return CM_SELECT;
      elif(key == KEY_F8)
         if((ValType(rs.value("t_id")) == V_INTEGER) and (rs.value("t_id") > 0))
           rs.edit();
           rs.value("T_STATE")    = null;
           rs.value("T_COMMENT")  = null;
           rs.value("T_DEALID")   = nullVal;
           rs.value("T_DEALCODE") = nullVal;
           rs.update();
         end;

         UpdateScroll(rs, 2);
         return CM_SELECT;
      elif(key == KEY_CTRL_DOWN)
         newPage = currentPage - 1;
         if(newPage >= 0)
            currentPage = newPage;
            return CM_SELECT;
         end;

         return CM_IGNORE; 
      elif(key == KEY_CTRL_UP)
         currentPage = currentPage + 1;
         return CM_SELECT;
      elif(key == KEY_CTRL_P)
         if(GetInt(newPage, "Введите номер страницы:") and (newPage > 0))
            currentPage = newPage-1;
            return CM_SELECT;
         end;

         return CM_IGNORE; 
      elif(key == KEY_CTRL_R)
          if(ValType(rs.value("t_id")) == V_INTEGER)
            SaveVtbDataId = rs.value("t_id");
          else 
            SaveVtbDataId = 0;
          end;
         return CM_SELECT;      
      end;
   end;
end;

var pgSize = 10000;
macro getUvtbScrollSql()
   return "   SELECT ALG.T_SZNAMEALG, VTBDATA.*,                                           " +
          "          RSB_SECUR.SC_GetObjCodeOnDate("+OBJTYPE_PARTY+", 101 /*CFT*/, TICK.T_CLIENTID) AS CFTCODE " +
          "     FROM UVTB_DATA VTBDATA                                                     " +
          "          LEFT JOIN DDL_TICK_DBT TICK ON TICK.T_DEALID = VTBDATA.T_DEALID       " +
          "          LEFT JOIN DNAMEALG_DBT ALG                                            " +
          "              ON ALG.T_INUMBERALG = TICK.T_DEALSTATUS AND ALG.T_ITYPEALG = 3155 " + 
          "   "+UvtbDataScrollFilterObj.UvtbDataScrollFilterStr+"                          " + 
          " ORDER BY VTBDATA.GKK, VTBDATA.ISIN                                             ";
end;

macro getPagesCount()
   var pgsql = TRsbDataSet("SELECT CEIL (COUNT (*) / "+pgSize+") pgcnt FROM ("+getUvtbScrollSql()+")");
   if(pgsql.movenext)
      return int(pgsql.pgcnt);
   end;

   return 0;
end;

macro RunUvtbDataScroll()
   var wrappedSql = SQL_WrapSelect(getUvtbScrollSql(), currentPage, pgSize);

   var rs = RSDRecordset(wrappedSql, RSDVAL_CLIENT, RSDVAL_STATIC);
   rs.UpdateCommand = RsdCommand(" UPDATE UVTB_DATA        " +
                                 "    SET t_clientid = :1, " +
                                 "        t_dealcode = :2, " +
                                 "        t_dealid   = :3, " +
                                 "        t_state    = :4, " +
                                 "        t_comment  = :5  " +
                                 "  WHERE t_id = :6        ");
   rs.UpdateCommand.AddUserCmdParam ("",  "T_CLIENTID", RSDRVER_NEWVAL);          
   rs.UpdateCommand.AddUserCmdParam ("",  "T_DEALCODE", RSDRVER_NEWVAL);          
   rs.UpdateCommand.AddUserCmdParam ("",  "T_DEALID",   RSDRVER_NEWVAL);          
   rs.UpdateCommand.AddUserCmdParam ("",  "T_STATE",    RSDRVER_NEWVAL);          
   rs.UpdateCommand.AddUserCmdParam ("",  "T_COMMENT",  RSDRVER_NEWVAL);             
   rs.UpdateCommand.AddUserCmdParam ("",  "T_ID",       RSDRVER_OLDVAL);

   while(
   RunScroll(rs, 35, MakeArray("GKK"          , "Код ГКК",                                                                           10, 2, -1, 0,
                               "CFTCODE"      , "Код CFT",                                                                           10, 2, -1, 0,
                               "SECONDNAME"   , "Фамилия",                                                                           10, 2, -1, 0,
                               "FIRSTNAME"    , "Имя"    ,                                                                           10, 2, -1, 0,
                               "MIDDLENAME"   , "Отчество",                                                                          10, 2, -1, 0,
                               "PHONE"        , "Телефон",                                                                           10, 2, -1, 0,
                               "AGRNO"        , "Номер договора ВТБ",                                                                10, 2, -1, 0,
                               "ISIN"         , "ISIN",                                                                              10, 2, -1, 0,
                               "TRANSH"       , "Транш",                                                                             10, 2, -1, 0,
                               "SECNAME"      , "Наименование ц/б",                                                                  10, 2, -1, 0,
                               "OPERNO"       , "Код операции приобретения",                                                         10, 2, -1, 0,
                               "DATEPOS"      , "Дата приобретения",                                                                 10, 2, -1, 0,
                               "QTY"          , "Количество",                                                                        10, 2, -1, 0,
                               "CURR"         , "Валюта сделки",                                                                     10, 2, -1, 0,
                               "PRICE"        , "Цена приобретения",                                                                 10, 2, -1, 0,
                               "AMOUNT"       , "Сумма сделки",                                                                      10, 2, -1, 0,
                               "ACI"          , "НКД",                                                                               10, 2, -1, 0,
                               "CMS"          , "Комиссионные затраты",                                                              10, 2, -1, 0,
                               "VALUERUR"     , "Сумма сделки (вкл НКД), руб",                                                       10, 2, -1, 0,
                               "CMSRUR"       , "Комиссионные затраты, руб",                                                         10, 2, -1, 0,
                               "STORAGE"      , "Место хранения",                                                                    10, 2, -1, 0,
                               "NOMINAL"      , "Номинал",                                                                           10, 2, -1, 0,
                               "NOMINALCURR"  , "Валюта номинала",                                                                   10, 2, -1, 0,
                               "PRICEQTY"     , "Цена*Количество",                                                                   10, 2, -1, 0,
                               "T_ID"         , "ID - уникальный идентификатор",                                                     10, 2, -1, 0,
                               "T_DEALID"     , "Идентификатор связанного НДФЛ-зачисления в СОФР",                                   10, 2, -1, 0,
                               "T_SZNAMEALG"  , "Статус связанного НДФЛ-зачисления",                                                 10, 2, -1, 0,
                               "T_CLIENTID"   , "Идентификатор Клиента в СОФР",                                                      10, 2, -1, 0,
                               "T_FIID"       , "Идентификатор ценной бумаги в СОФР, соответствующий полю ISIN",                     10, 2, -1, 0,
                               "T_FIID_NEW"   , "Новый идентификатор ценной бумаги в СОФР, если исходный выпуск был сконвертирован", 10, 2, -1, 0,
                               "T_AMOUNT_NEW" , "Новое количество ценной бумаги в СОФР, если исходный выпуск был сконвертирован",    10, 2, -1, 0,
                               "T_DEALCODE"   , "Код связанного НДФЛ-зачисления",                                                    10, 2, -1, 0,
                               "T_STATE"      , "Статус записи",                                                                     10, 2, -1, 0,
                               "T_COMMENT"    , "Комментарий",                                                                       10, 2, -1, 0,
                               "T_SYSDATE"    , "Дата последнего обновления",                                                        10, 2, -1, 0),
             "eRunProcessDialog", "eRunProcessDialog", "Исходные данные по ценам от ВТБ (стр. "+(currentPage+1)+"/"+getPagesCount()+")", 
             "~Ctrl-Shift-F5~ Фильтр ~Ctrl-R~ Обновить ~F6~ Выбор действия ~F2~ Обработать ~Ctrl-F2~ Обработать все записи ~F8~ Сбросить статус и ошибку ~Ctrl-UP/DOWN~ ~Ctrl-P~ Переключить страницу ~F5~ Фильтр ~Esc~ Выход")
    ) 
       wrappedSql = SQL_WrapSelect(getUvtbScrollSql(), currentPage, pgSize);
       rs = RSDRecordset(wrappedSql, RSDVAL_CLIENT, RSDVAL_STATIC);

       rs.UpdateCommand = RsdCommand(" UPDATE UVTB_DATA        " +
                                     "    SET t_clientid = :1, " +
                                     "        t_dealcode = :2, " +
                                     "        t_dealid   = :3, " +
                                     "        t_state    = :4, " +
                                     "        t_comment  = :5  " +
                                     "  WHERE t_id = :6        ");
       rs.UpdateCommand.AddUserCmdParam ("",  "T_CLIENTID", RSDRVER_NEWVAL);          
       rs.UpdateCommand.AddUserCmdParam ("",  "T_DEALCODE", RSDRVER_NEWVAL);          
       rs.UpdateCommand.AddUserCmdParam ("",  "T_DEALID",   RSDRVER_NEWVAL);          
       rs.UpdateCommand.AddUserCmdParam ("",  "T_STATE",    RSDRVER_NEWVAL);          
       rs.UpdateCommand.AddUserCmdParam ("",  "T_COMMENT",  RSDRVER_NEWVAL);             
       rs.UpdateCommand.AddUserCmdParam ("",  "T_ID",       RSDRVER_OLDVAL);

    end;
end;

//runLoadLot2();
