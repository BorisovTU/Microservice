import DealsInter, CTInter;
import dbo_message_main_c;
import rshb_lib;
import func_lib;
import dlcontrfunc;
import dbo_change2edp;

const C_PRIORITY = 99; //приоритет задания фанкобж

//var log_del = false;
//var fi_list = "810";
//"810, 840, 978, 826, 756";

var flownum;
   var cnum: integer;
   var rs = execSQLselect("SELECT RSBSESSIONDATA.CNum FROM dual", null, true);
    if(rs and rs.moveNext())
      FlowNum = rs.value(0);
    end;
private macro insertTimelog(pOperation)
   var cmd;
   cmd = rsdCommand("begin\n rshb_user.insertDateLog(?);\n end;");
   cmd.addParam("Operation", rsdbp_in, pOperation);
   cmd.Execute;
   end;
   private macro  runTimeShift()
   var cmd;
   cmd = RSDCommand("Select * from dlog");
   runscroll(RSDRecordset(cmd, rsdval_client, rsdval_static));
end;

private class TRslScroll ()
   var scr_name  = "";    
   var scr_ronly = true;
   var colInfo;

   var title   = "";
   var st_line = "";

   //
   macro numCol
      if (colInfo)
         return colInfo.size / 6
      end
   end;

   //                            
   macro RmvCol
      colInfo = null;
   end;

   //
   macro is_pos(sql)
      gotoscroll(sql);
      if ((sql.Value(0) != null) and (sql.Value(0) != nullval))
         return true;
      end;
      return false;
   end;

   //
   macro AddCol(fld, head, width, fldtype, decpoint) 
      var ind = 0;    
      if (not colInfo)
         colInfo = TArray;
      end;       
      ind = colInfo.Size/6;
      colInfo.value (ind * 6)      = fld;
      colInfo.value (ind * 6 + 1)  = head;
      colInfo.value (ind * 6 + 2)  = width;
      colInfo.value (ind * 6 + 3 ) = fldType;
      colInfo.value (ind * 6 + 4 ) = decPoint;
      colInfo.value (ind * 6 + 5 ) = 0;
   end;

   macro on_scr_key_13(sql, field, key_kod)
      if ((Valtype(sql.value("t_message")) != V_UNDEF) and 
          (Valtype(sql.value("t_message")) != 26))
         msgbox(sql.value("t_message"));
      end;
   end;
   macro on_scr_key_32(sql, field, key_kod)
   end;
   macro on_scr_key_PLUS(sql, field, key_kod)
   end;
   macro on_scr_key_MINUS(sql, field, key_kod)
   end;
   macro on_scr_key_F2(sql, field, key_kod)
   end;
   macro on_scr_key_F3(sql, field, key_kod)
   end;
   macro on_scr_key_F5(sql, field, key_kod)
   end;
   macro on_scr_key_F6(sql, field, key_kod)
   end;
   macro on_scr_key_F7(sql, field, key_kod)
   end;
   macro on_scr_key_F8(sql, field, key_kod)
   end;
   macro on_scr_key_F9(sql, field, key_kod)
   end;
   macro on_scr_key_AltF6(sql, field, key_kod)
   end;
   macro on_scr_key_AltF8(sql, field, key_kod)
   end;
   macro on_scr_key_AltF9(sql, field, key_kod)
   end;
   macro on_scr_key_AltF10(sql, field, key_kod)
   end;
   macro on_scr_key_CtrlF8(sql, field, key_kod)
   end;
   macro on_scr_key_Esc(sql, field, key_kod)
   end;
   macro on_scr_key_Ctrl_R(sql, field, key_kod)
   end;
   macro on_scr_key_empty(sql, field, key_kod)
   end;
   macro on_scr_init(sql, field, key_kod)
   end;
   macro on_scr_mlt_beg(sql, field, key_kod)
   end;
   macro on_scr_mlt_end(sql, field, key_kod)
   end;
   macro on_scr_mlt_sel(sql, field, key_kod)
   end;
   macro on_scr_preinit(sql, field, key_kod)
   end;

   /************************************/
   macro EvProc (sql, event, field, key_kod)
      //execmacrofile("all_event_dlg.mac", "decode_event", sql, event, field, key_kod, null);
      if (event == DLG_INIT)
         on_scr_init(sql, event, field, key_kod);
      end;
      if (event == DLG_PREINIT)
         on_scr_preinit(sql, event, field, key_kod);
      end;
      if (event == DLG_MSELSTART)
         return on_scr_mlt_beg(sql, field, key_kod);
      end;
      if (event == DLG_MSEL)
         return on_scr_mlt_sel(sql, field, key_kod);
      end;
      if (event == DLG_MSELEND)
         return on_scr_mlt_end(sql, field, key_kod);
      end;
      if (event == DLG_KEY)
         if    (key_kod==316)
               return on_scr_key_f2(sql, field, key_kod);
         elif  (key_kod==317)
               return on_scr_key_f3(sql, field, key_kod);
         elif  (key_kod==319)
               return on_scr_key_f5(sql, field, key_kod);
         elif  (key_kod==320)
               return on_scr_key_f6(sql, field, key_kod);
         elif  (key_kod==321)
               return on_scr_key_f7(sql, field, key_kod);
         elif  (key_kod==322)
               return on_scr_key_f8(sql, field, key_kod);
         elif  (key_kod==323)
               return on_scr_key_f9(sql, field, key_kod);
         elif  (key_kod==365) //ALT_F6
               return on_scr_key_altf6(sql, field, key_kod);
         elif  (key_kod==367) //ALT_F8
               return on_scr_key_altf8(sql, field, key_kod);
         elif  (key_kod==368) //ALT_F9
               return on_scr_key_altf9(sql, field, key_kod);
         elif  (key_kod==369) //ALT_F10
               return on_scr_key_altf10(sql, field, key_kod);
         elif  (key_kod==357) //CTRL_F8
               return on_scr_key_ctrlf8(sql, field, key_kod);
         elif  (key_kod==32)  //SPACE
               return on_scr_key_32(sql, field, key_kod);
         elif  (key_kod==13)  //ENTER)
               return on_scr_key_13(sql, field, key_kod);
         elif  (key_kod==217) //ESC
               return on_scr_key_Esc(sql, field, key_kod);
         elif  (key_kod == 43)  //PLUS серый
               return on_scr_key_PLUS(sql, field, key_kod);
         elif  (key_kod == 45)  //MINUS серый
               return on_scr_key_MINUS(sql, field, key_kod);
         elif  (key_kod == 0)
               return on_scr_key_empty(sql, field, key_kod);
         elif  (key_kod == 18) //CTRL_R
               return on_scr_key_Ctrl_R(sql, field, key_kod);
         end;
      end; 
   
      //   msgbox(event
      //          ,"|DLG_KEY - ",dlg_Key
      //          ,"|DLG_MOUSE - ",dlg_Mouse
      //          ,"|DLG_DESTROY - ",dlg_destroy
      //          ,"|DLG_save - ",dlg_save
      //          ,"|DLG_outloop - ",dlg_outloop
      //          ,"|DLG_inloop - ",dlg_inloop
      //          ,"|DLG_preinit - ",dlg_preinit
      //          ,"|DLG_init - ",dlg_init
      //          ,"|DLG_setfocus - ",dlg_setfocus
      //          ,"|DLG_remfocus - ",dlg_remfocus
      //          ,"|DLG_inrec - ",dlg_inrec
      //          ,"|DLG_outrec - ",dlg_outrec
      //          ,"|Key_Kod - ",key_kod
      //         );   
   end;

   macro Run (rs, X, Y, CX, CY)
   return RunScroll (rs, numCol, colInfo, scr_name, R2M(this,"EvProc"), title, st_line, scr_ronly, X, Y, CX, CY);
   end;

   onerror(err);
      msgbox(err.Message);
      return false;
end;

// результат в таблицу скроллинга
private macro sav_err(p_Msg, p_Rwd)
   var sqls, rsdc;
   sqls = String( 
                  "BEGIN   \n"
                 ,"   UPDATE Dbo_Edp_Tmp t SET t.t_Message = t.t_Message || ' ' || Substr(:p_Err, 1, 200), t_Countsend = 0 WHERE t.ROWID = :p_Rwd;   \n"
                 ,"END;   \n"
                );
   rsdc = rsdcommand(sqls);
   rsdc.AddParam("p_Err", RSDBP_IN, p_Msg);
   rsdc.AddParam("p_Dlid", RSDBP_IN, p_Rwd);
   rsdc.execute;

   onerror(e);
      rsdc = null;
end;

// результат в таблицу скроллинга
/*private macro clr_err(p_Rwd)
   var sqls, rsdc;
   sqls = String( 
                  "BEGIN   \n"
                 ,"   UPDATE Dbo_Edp_Tmp t SET t.t_Message = chr(0) WHERE t.ROWID = :p_Rwd;   \n"
                 ,"END;   \n"
                );
   rsdc = rsdcommand(sqls);
   rsdc.AddParam("p_Dlid", RSDBP_IN, p_Rwd);
   rsdc.execute;

   onerror(e);
      rsdc = null;
end;
  */
   
class (TRslScroll) TMsgScroll_EDP
   var fl_end = false, v_lin = 0;

   macro CheckTable();
     var cmd;
       StartCaptureOutput();
     [
           DECLARE
              retval    NUMBER := 0;
              sql_crt   VARCHAR2 (1000);
              sql_clr   VARCHAR2 (1000);
           BEGIN
              sql_crt :=
                    'CREATE TABLE DBO_EDP_TMP AS SELECT * from Dbo_Message_Tmp where 1 != 1 ';
              sql_clr := 'truncate table DBO_EDP_TMP';
              SELECT COUNT (1)
                INTO retval
                FROM user_tables
               WHERE UPPER (table_name) = 'DBO_EDP_TMP';
              IF retval = 0
              THEN
                 EXECUTE IMMEDIATE (sql_crt);
              END IF;
           END;];
        cmd = RSDCommand(EndCaptureOutput());
        cmd.execute();
   end;
   macro sel_contr()
     CheckTable();
     if (not gettrue(false, "Обновить данные временной таблицы?"))
        return true;
     end;
     var edp_rs = RSDRecordset("Select count(1) as in_progress from Dbo_Edp_Tmp where t_countsend != 0 or t_message is not  null");
         if(     (edp_rs)
             and (edp_rs.movenext) 
             and (edp_rs.value("in_progress") > 0) 
             and (not gettrue(false, "В таблице есть данные обработки.\n Вы действительно хотите очистить и заполнить ее заново?\n Текущие данные будут удалены.")))
            return true;
         end;
      //return true;
      var sqls, rsdc;
      sqls = String( 
                     "DECLARE   \n"
                    ,"   v_Msg Dbo_Edp_Tmp.t_Message%TYPE;   \n"
                    ,"   v_Err VARCHAR2(2000);   \n"
                    ,"   v_RegUL CHAR(1) := RSB_COMMON.GetRegFlagValue ('РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ВЕДЕНИE ЕДП ЮЛ');\n"
                    ,"BEGIN   \n"
                    ,"   DELETE FROM Dbo_Edp_Tmp;   \n"
                    ,"   INSERT INTO Dbo_Edp_Tmp   \n"
                    ,"      (t_Dlid   \n"
                    ,"      ,t_Name   \n"
                    ,"      ,t_Partyid   \n"
                    ,"      ,t_Number   \n"
                    ,"      ,t_Datebegin   \n"
                    ,"      ,t_State   \n"
                    ,"      ,t_Issend   \n"
                    ,"      ,t_Datecreate   \n"
                    ,"      ,t_Datesend   \n"
                    ,"      ,t_Email   \n"
                    ,"      ,t_Countsend   \n"
                    ,"      ,t_Resend   \n"
                    ,"      ,t_EDP)   \n"
                    ,"      SELECT Dl.t_Dlcontrid   \n"
                    ,"            ,Sfn.t_Name   \n"
                    ,"            ,Sfn.t_Partyid   \n"
                    ,"            ,Sfn.t_Number   \n"
                    ,"            ,Sfn.t_Datebegin   \n"
                    ,"            ,(SELECT Atr.t_Name   \n"
                    ,"                FROM Dobjatcor_Dbt Atc   \n"
                    ,"               INNER JOIN Dobjattr_Dbt Atr   \n"
                    ,"                  ON (Atr.t_Objecttype = Atc.t_Objecttype AND Atc.t_Groupid = Atr.t_Groupid AND   \n"
                    ,"                     Atc.t_Attrid = Atr.t_Attrid)   \n"
                    ,"               WHERE Atc.t_Objecttype = 207   \n"
                    ,"                 AND Atc.t_Groupid = 101   \n"
                    ,"                 AND SYSDATE BETWEEN Atc.t_Validfromdate AND Atc.t_Validtodate   \n"
                    ,"                 AND Atc.t_Object = Lpad(Dl.t_Dlcontrid, 34, '0')) t_State   \n"
                    ,"            ,Decode((SELECT COUNT(1)   \n"
                    ,"                      FROM Ddlcontrmsg_Dbt m   \n"
                    ,"                     WHERE m.t_Dlcontrid = Dl.t_Dlcontrid   \n"
                    ,"                       AND m.t_Kind = 500)   \n"
                    ,"                   ,0   \n"
                    ,"                   ,Chr(0)   \n"
                    ,"                   ,Chr(88)) t_Issend   \n"
                    ,"            ,(SELECT MIN(m.t_Createdate)   \n"
                    ,"                FROM Ddlcontrmsg_Dbt m   \n"
                    ,"               WHERE m.t_Dlcontrid = Dl.t_Dlcontrid   \n"
                    ,"                 AND m.t_Kind = 500) t_Datecreate   \n"
                    ,"            ,(SELECT MIN(m.t_Senddate)   \n"
                    ,"                FROM Ddlcontrmsg_Dbt m   \n"
                    ,"               WHERE m.t_Dlcontrid = Dl.t_Dlcontrid   \n"
                    ,"                 AND m.t_Kind = 500) t_Datesend   \n"
                    ,"            ,Dl.t_Email   \n"
                    ,"            ,0 t_Countsend   \n"
                    ,"            ,Chr(0) t_Resend   \n"
                    ,"            ,Decode( (SELECT count(1)  \n"
                    ,"                      FROM dsfcontr_dbt s, dobjatcor_dbt a  \n"
                    ,"                       WHERE     s.t_servkindsub = 8  \n"
                    ,"                        AND a.t_objecttype = 659  \n"
                    ,"                        AND a.t_groupid = 102  \n"
                    ,"                        AND a.t_attrid = 1  \n"
                    ,"                        AND a.t_object = LPAD (s.t_id, 10, '0')  \n"
                    ,"                        AND s.t_id IN (SELECT t_sfcontrid  \n"
                    ,"                                         FROM ddlcontrmp_dbt  \n"
                    ,"                                        WHERE t_dlcontrid = Dl.t_Dlcontrid))  \n"
                    ,"                     ,0   \n"
                    ,"                     ,chr(0)  \n"
                    ,"                     ,chr(88)) EDP  \n"
                    ,"        FROM Ddlcontr_Dbt Dl   \n"
                    ,"       INNER JOIN Dsfcontr_Dbt Sfn   \n"
                    ,"          ON (Sfn.t_Id = Dl.t_Sfcontrid) \n"
                    ,"       INNER JOIN Dparty_Dbt pt   \n"
                    ,"          ON (Sfn.t_PartyId = Pt.t_partyid) \n"
                    ,"       LEFT JOIN Dpersn_Dbt persn   \n"
                    ,"          ON (Sfn.t_PartyId = persn.t_personid) \n"
                    ,"            where sfn.t_partyid <> 1 and ((v_RegUL = CHR(88)) or ((pt.t_legalform <> 1) and (persn.t_isemployer = chr(0))) ) and (sfn.t_dateclose = to_date('01010001','ddmmyyyy')or sfn.t_dateclose > :dateclose);   \n"
                    ,"   COMMIT;   \n"
                    ,"EXCEPTION   \n"
                    ,"   WHEN OTHERS THEN   \n"
                    ,"      ROLLBACK;   \n"
                    ,"      :p_Err := v_Err;   \n"
                    ,"END;   \n"
                   );
      rsdc = rsdcommand(sqls);
      rsdc.AddParam("p_Err", RSDBP_OUT, v_string, 2000);
      rsdc.AddParam("p_DateClose", RSDBP_in,{Curdate});
      rsdc.execute;
      if (not rsdc)        
         runerror("Ошибка получения списка договоров");
      end;
      sqls = rsdc.Value("p_Err");
      if ((sqls != null) and (sqls != nullval))
         runerror("Ошибка получения данных по договору", sqls);
      end;    
      rsdc = null;
      return true;   
      onerror(e)                                            
         rsdc = null;
         if ((e.Err != null) or (e.Err != nullval))
            msgbox(e.Err);
         else 
            msgbox(e.Message + " " + e.Module + " " + e.Line);
         end;                
         return false;
   end;

   macro clear_ds
      var sqls, rsdc;
      rsdc = rsdcommand("BEGIN DELETE FROM Dbo_Edp_Tmp; COMMIT; END;");
      rsdc.execute;
      rsdc = null;
   end;
   
   macro create_DS
      var sqls, rsdc, rsds, rsdu;
      sqls = String( "SELECT t_Dlid   \n"
                    ,"      ,t_Number   \n"
                    ,"      ,t_Name   \n"
                    ,"      ,t_State   \n"
                    ,"      ,t_Issend   \n"
                    ,"      ,t_Message   \n"
                    ,"      ,t_EDP   \n"
                    ,"      ,t_Avrexch   \n"
                    ,"      ,t_Outexch   \n"
                    ,"      ,t_Dvexch   \n"
                    ,"      ,t_Moneyexch   \n"
                    ,"      ,t_Datebegin   \n"
                    ,"      ,t_Datecreate   \n"
                    ,"      ,t_Datesend   \n"
                    ,"      ,t_Email   \n"
                    ,"      ,t_Countsend   \n"
                    ,"      ,case when t_edp = chr(88) then 'обработка завершена' else decode (t_Countsend,0, '','обрабатывается (Поток '||t_Countsend ||')') end t_status_work    \n"
                    ,"      ,t_Partyid   \n"
                    ,"      ,ROWID rwd   \n"
                    ,"  FROM Dbo_Edp_Tmp   \n"
                    ," ORDER BY t_Datebegin DESC, t_Datecreate   \n"
                   );
      rsdc = rsdcommand(sqls);
      rsds = rsdrecordset(rsdc, RSDVAL_CLIENT, RSDVAL_STATIC);
      rsdu = rsdcommand("BEGIN UPDATE Dbo_Edp_Tmp l SET l.t_Countsend = :p_Sel WHERE l.Rowid = :p_Rwd and l.t_Countsend = 0 and t_edp != chr(88); END;");
      rsdu.AddUserCmdParam("p_Sel", "t_Countsend", RSDRVER_NEWVAL);
      rsdu.AddUserCmdParam("p_Rwd", "Rwd", RSDRVER_OLDVAL);
      rsds.UpdateCommand = rsdu;
      rsds.Open;
      return rsds;
      onerror(e)                                            
         rsdc = null;
         msgbox(e.Message + " " + e.Module + " " + e.Line);
         return null;
   end;        

   macro upd_line(p_dli)
      var sqls, rsdc;
      sqls = String( 
                     "DECLARE   \n"
                    ,"   v_Dli VARCHAR2(50) := :p_Dli;   \n"
                    ,"BEGIN   \n"
                    ,"   UPDATE Dbo_Edp_Tmp t  \n"
                    ,"      SET (t_Name   \n"
                    ,"         ,t_Partyid   \n"
                    ,"         ,t_Number   \n"
                    ,"         ,t_Datebegin   \n"
                    ,"         ,t_State   \n"
                    ,"         ,t_Issend   \n"
                    ,"         ,t_Datecreate   \n"
                    ,"         ,t_Datesend   \n"
                    ,"         ,t_Email   \n"
                    ,"         ,t_Countsend   \n"
                    ,"         ,t_Resend    \n"
                    ,"         ,t_EDP) =   \n"
                    ,"          (SELECT Sfn.t_Name   \n"
                    ,"                 ,Sfn.t_Partyid   \n"
                    ,"                 ,Sfn.t_Number   \n"
                    ,"                 ,Sfn.t_Datebegin   \n"
                    ,"                 ,(SELECT Atr.t_Name   \n"
                    ,"                     FROM Dobjatcor_Dbt Atc   \n"
                    ,"                    INNER JOIN Dobjattr_Dbt Atr   \n"
                    ,"                       ON (Atr.t_Objecttype = Atc.t_Objecttype AND Atc.t_Groupid = Atr.t_Groupid AND   \n"
                    ,"                          Atc.t_Attrid = Atr.t_Attrid)   \n"
                    ,"                    WHERE Atc.t_Objecttype = 207   \n"
                    ,"                      AND Atc.t_Groupid = 101   \n"
                    ,"                      AND SYSDATE BETWEEN Atc.t_Validfromdate AND Atc.t_Validtodate   \n"
                    ,"                      AND Atc.t_Object = Lpad(Dl.t_Dlcontrid, 34, '0')) t_State   \n"
                    ,"                 ,Decode((SELECT COUNT(1)   \n"
                    ,"                           FROM Ddlcontrmsg_Dbt m   \n"
                    ,"                          WHERE m.t_Dlcontrid = Dl.t_Dlcontrid   \n"
                    ,"                            AND m.t_Kind = 500)   \n"
                    ,"                        ,0   \n"
                    ,"                        ,Chr(0)   \n"
                    ,"                        ,Chr(88)) t_Issend   \n"
                    ,"                 ,(SELECT MIN(m.t_Createdate)   \n"
                    ,"                     FROM Ddlcontrmsg_Dbt m   \n"
                    ,"                    WHERE m.t_Dlcontrid = Dl.t_Dlcontrid   \n"
                    ,"                      AND m.t_Kind = 500) t_Datecreate   \n"
                    ,"                 ,(SELECT MIN(m.t_Senddate)   \n"
                    ,"                     FROM Ddlcontrmsg_Dbt m   \n"
                    ,"                    WHERE m.t_Dlcontrid = Dl.t_Dlcontrid   \n"
                    ,"                      AND m.t_Kind = 500) t_Datesend   \n"
                    ,"                 ,Dl.t_Email   \n"
                    ,"                 ,0 t_Countsend   \n"
                    ,"                 ,Chr(0) t_Resend   \n"
                    ,"            ,Decode( (SELECT count(1)  \n"
                    ,"                      FROM dsfcontr_dbt s, dobjatcor_dbt a  \n"
                    ,"                       WHERE     s.t_servkindsub = 8  \n"
                    ,"                        AND a.t_objecttype = 659  \n"
                    ,"                        AND a.t_groupid = 102  \n"
                    ,"                        AND a.t_attrid = 1  \n"
                    ,"                        AND a.t_object = LPAD (s.t_id, 10, '0')  \n"
                    ,"                        AND s.t_id IN (SELECT t_sfcontrid  \n"
                    ,"                                         FROM ddlcontrmp_dbt  \n"
                    ,"                                        WHERE t_dlcontrid = Dl.t_Dlcontrid))  \n"
                    ,"                     ,0   \n"
                    ,"                     ,chr(0)  \n"
                    ,"                     ,chr(88)) EDP  \n"
                    ,"             FROM Ddlcontr_Dbt Dl   \n"
                    ,"            INNER JOIN Dsfcontr_Dbt Sfn   \n"
                    ,"               ON (Sfn.t_Id = Dl.t_Sfcontrid)   \n"
                    ,"            WHERE Dl.t_Dlcontrid = t.t_Dlid) WHERE t.ROWID = v_Dli;   \n"
                    ,"   COMMIT;   \n"
                    ,"EXCEPTION   \n"
                    ,"   WHEN OTHERS THEN   \n"
                    ,"      ROLLBACK;   \n"
                    ,"END;   \n"
                   );
      rsdc = rsdcommand(sqls);
      rsdc.AddParam("p_Dli", RSDBP_IN, p_dli);
      rsdc.execute;                         
      rsdc = null;
      onerror(e);
   end;

   macro upd_line2(p_dli)
      var sqls, rsdc;
      sqls = String( 
                     "DECLARE   \n"
                    ,"   v_Dli VARCHAR2(50) := :p_Dli;   \n"
                    ,"BEGIN   \n"
                    ,"   UPDATE Dbo_Edp_Tmp t  \n"
                    ,"      SET  t_Countsend  = -1 WHERE t.ROWID = v_Dli;   \n"
                    ,"   COMMIT;   \n"
                    ,"EXCEPTION   \n"
                    ,"   WHEN OTHERS THEN   \n"
                    ,"      ROLLBACK;   \n"
                    ,"END;   \n"
                   );
      rsdc = rsdcommand(sqls);
      rsdc.AddParam("p_Dli", RSDBP_IN, p_dli);
      rsdc.execute;                         
      rsdc = null;
      onerror(e);
   end;


   macro sel_save(sql)
      sql.Edit;
      sql.Value("t_Countsend") = FlowNum/*2*/;
      sql.Update;
   end;
   
   macro sel_work(add_del)       

      var i = 0, v_ob, sqls, rsdc, rsds, t_st, err = ""  ;
      sqls = "SELECT t.t_dlid,t.t_Partyid, t.Rowid rwd, COUNT(1) over() r_all, row_number() over(ORDER BY t.t_dlid) n_all FROM Dbo_Edp_Tmp t WHERE t.t_countsend = " + FlowNum + " ORDER BY t.t_dlid ";
      rsdc = rsdcommand(sqls);
      rsds = rsdrecordset(rsdc, RSDVAL_CLIENT_IF_NEEDED, RSDVAL_FORWARD_ONLY);
      rsds.Open;
      rsds.MoveNext();
      t_st = time();
      Initprogress(int(rsds.Value("r_All")), "", "Обработка");
      SetDialogFlag(0);
      while (true)
         if (add_del < 0)
         else
               //ЕДП
//              clr_err(rsds.Value("rwd"));
              if (ДоговорЕДП(rsds.Value("t_Dlid")))
                sav_err("На договоре уже установлен признак ЕДП", rsds.Value("rwd"));
              else
                /* if ( Change2edpTrn(rsds.Value("t_Dlid"), @err) != 0)
                    sav_err(err, rsds.Value("rwd"));  
                 end;*/

                 sql_execute(" INSERT INTO DFUNCOBJ_DBT  ( T_ID, T_OBJECTTYPE, T_OBJECTID, T_FUNCID, T_PARAM, T_PRIORITY) VALUES " +
                             " ( 0, 0, "+string(rsds.Value("t_Dlid"))+", 7785, '"+string(rsds.Value("t_Dlid"))+";', "+C_PRIORITY+");  ");

              end;
               upd_line2(rsds.Value("rwd"));
         end;
         if (not rsds.MoveNext())
            break;
         end;
         SetDialogFlag(1);
         Useprogress(int(rsds.Value("n_All")));
         SetDialogFlag(0);
      end;            
      if (v_Ob)
         v_Ob.isLast = true;
         v_Ob.cls_word();
      end;
      rsds.Close;
      rsdc = rsds = null;
      SetDialogFlag(1);
      remprogress();
      //msgbox(time - t_st);
   end;
   
   macro on_scr_init(sql, field, key_kod)
      AddMultiAction(sql, 316);
      AddMultiAction(sql, 322);
      while (sql.MoveNext())
         if (int(sql.Value("t_Dlid")) == v_lin)
            gotoscroll(sql);
            break;
         end;
      end;                                     
      if ((sql.Value("t_Dlid") != null) and (sql.Value("t_Dlid") != nullval) and (int(sql.Value("t_Dlid")) != v_lin))
         sql.MoveFirst();
         gotoscroll(sql);
      end;                     
      v_lin = -1;
   end;

   macro on_scr_mlt_beg(sql, field, key_kod)
      fl_end = false;
      if (key_kod == 316)
         v_lin = -1;
         if (msgboxex("Запустить подключение к ЕДП для выделенных клиентов?", MB_YES + MB_NO, IND_YES) == IND_NO)
            return cm_ignore;
         end;
      end;
      if (key_kod == 322)
         v_lin = -1;
         if (msgboxex("Удалить субдоговоры по выделенным записям?", MB_YES + MB_NO, IND_YES) == IND_NO)
            return cm_ignore;
         end;
      end;
   end;

   macro on_scr_mlt_end(sql, field, key_kod)  
      fl_end = true;
      // обработка отобранных
      if (key_kod == 316)   
         sel_work(1);
      end;   
      if (key_kod == 322)
         sel_work(-1);
      end;   
   end;

   macro on_scr_mlt_sel(sql, field, key_kod)
      if (key_kod == 316)
         if (v_lin < 0) 
            v_lin = int(sql.Value("t_Dlid"));
         end;
      end;
      sel_save(sql);
      return CM_MSEL_CONT_CLEAR;
   end;

   macro on_scr_key_empty(sql, field, key_kod)
      if (fl_end)        
         return cm_select;
      end;
   end;

   macro on_scr_key_F2(sql, field, key_kod)
      if (not is_pos(sql))
         return cm_ignore;
      end;

      if (msgboxex("Запустить установку режима ЕДП для клиента?", MB_YES + MB_NO, IND_YES) == IND_YES)
         v_Lin = int(sql.Value("t_Dlid"));
         sel_save(sql);
         // обработка отобранных
         insertTimelog("Старт обработки");
         sel_work(1);
         insertTimelog("Конец обработки");
         return cm_select;
      end;             
      return cm_ignore;
   end;

   macro on_scr_key_F8(sql, field, key_kod)
      if (not is_pos(sql))
         return cm_ignore;
      end;
      if (msgboxex("Удалить субдоговор?", MB_YES + MB_NO, IND_YES) == IND_YES)
         v_Lin = int(sql.Value("t_Dlid"));
         sel_save(sql);
         // обработка отобранных
         sel_work(-1);    
         return cm_select;
         runTimeShift();
      end;   
      return cm_ignore;
   end;

   macro on_scr_key_F7(sql, field, key_kod)
      if (not is_pos(sql))
         return cm_ignore;
      end;
      var dt = trsbdataset(" select (select  count(1) from dfuncobj_dbt where t_funcid = 7785 and t_state = 0) wt,   " +
                           " (select  count(1) from dfuncobj_dbt where t_funcid = 7785 and t_state = 20) wr from dual ");
      if (dt.movenext())
         msgbox("Ожидает: " + int(dt.wt) + "| В работе: "+ int(dt.wr));
      end;   
      return cm_ignore;
   end;

   macro on_scr_key_AltF9(sql, field, key_kod)
      if (GetTrue(false, "Отключить задание 10002 ?"))
         sql_execute (" update DSS_SHEDULER_DBT t " +
                      " set T.T_SHEDULERTYPE = 0 " +
                      " where t_id = 10002");
         msgbox("Отключено");
      end;
   end;

   macro on_scr_key_AltF10(sql, field, key_kod)
      if (GetTrue(false, "Включить задание 10002 ?"))
         sql_execute (" update DSS_SHEDULER_DBT t " +
                      " set T.T_SHEDULERTYPE = 2 " +
                      " where t_id = 10002");
         msgbox("Включено");
      end;
   end;

   macro on_scr_key_AltF8(sql, field, key_kod)
      if (GetTrue(false, "Очистить очередь заданий (удалить задания перевода на ЕДП) ?") )
         sql_execute (" delete from dfuncobj_dbt where t_funcid = 7785 and t_state in (0, 20)");
         sql_execute (" update dbo_edp_tmp set t_countsend = 0 where t_countsend <> 0 " );
         msgbox("Очередь очищена");
      end;
   end;

   macro on_scr_key_Ctrl_R(sql, field, key_kod)
      if (not is_pos(sql))
         v_lin = -1;
      end;
      v_Lin = int(sql.Value("t_Dlid"));
      if (not sel_contr())
         return cm_ignore;
      end;                
      return cm_select;
   end;
   
   macro run_list()
      var rsds;     

      if (not sel_contr())
         return false;
      end;
      AddCol ("t_number",    "Номер",            18);
      AddCol ("T_name",      "Наименование ",    25);
      AddCol ("T_state",     "Статус договора ", 10);
      AddCol ("T_status_work", "Статус обработки ", 25);
      AddCol ("T_message",   "Ошибки форм-ния",  25);
      AddCol ("T_EDP",       "ЕДП",              5 );
      AddCol ("t_datebegin", "Заключен",         8 );
      AddCol ("t_issend",    "Отправлено",       5 );
      AddCol ("t_datecreate","Создано",          8 );
      AddCol ("t_datesend",  "Отправлено",       8 );
      AddCol ("t_email",     "e-mail",           20);
      AddCol ("t_Dlid",      "dlid",             5 );
      rsds = create_ds();
      if (rsds == null)
         return false;
      end;           
      v_lin = -1;
         while (Run(rsds))    
            rsds = create_ds();
            if (rsds == null)
               return false;
            end;           
         end;   
       // clear_ds();
   end;

   InitTRslScroll();
   scr_name = "FILTR_CONTRACT";
   title    = "Договоры";
   st_line  = "ESC-Выход  F2-Создать  Shift(Вниз/Вверх)-Выделить F7-Просмотреть кол-во записей в обработке AltF8-очистить очередь заданий AltF9-Отключить 10002 AltF10-Включить 10002";
end;

macro Exec_EDP_Connect()
   TMsgScroll_EDP.run_list;
   exit(1);
end;
