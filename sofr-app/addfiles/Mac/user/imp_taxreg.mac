//-----------------------------------------------------------------------------------------
// Š®­¢¥àâ æ¨ï ­ «®£®¢®£® à¥£¨áâà 
//-----------------------------------------------------------------------------------------
import launcher, globals, dealsInter, spInter;
//-----------------------------------------------------------------------------------------

Macro runMigration ( namefile )
    genObject ("TaxRegConvert").run (namefile);
End;
//-----------------------------------------------------------------------------------------

Macro runProc ( fname, num, linestart, lineend, logName, procSize )
    genObject ("CLotConvert").run (fname, num, linestart, lineend, logName, procSize);
end;
//-----------------------------------------------------------------------------------------

Private macro prepare ()
    if ( execSqlSelect ("select 1 from user_tables where table_name = 'USER_CNVHLPLOG_DU'").moveNext () )
        if ( not execSql ("truncate table user_cnvhlplog_du") )
            return false;
        end;
    else
      //  if ( not execSql ("create global temporary table user_cnvhlplog_DU (t_kind number not null, t_line number not null, t_context varchar2(4000)) on commit preserve rows") )
  if ( not execSql ("create table user_cnvhlplog_DU (t_kind number not null, t_line number not null, t_context varchar2(4000))") )
            return false;
        end;
    end;

    return TRUE;
End;
//-----------------------------------------------------------------------------------------

Private class CProtokolData
    Private var outStr;

    Macro add ( kind, line, data )
        execSql ("insert into user_cnvhlplog_du values (:1, :2, :3)", makeArray (sqlParam ("1", kind), sqlParam ("2", line), sqlParam ("3", data)));
    End;

    Macro addLine ( kind, line, dealid, dealcode, fiid, amount, sum )
        Var fiName = "", sql = execSqlSelect ("select t_name from dfininstr_dbt where t_fiid = :1", makeArray (sqlParam ("1", fiid)));
        if ( sql.moveNext () )
            fiName = sql.value (0);
        end;
        Var data = string ("³", line:8, "³", dealId:10, "³", dealCode:24, "³", fiName:40, "³", amount:10, "³", sum:20, "³");
        add (kind, line, data);
    End;
End;
//-----------------------------------------------------------------------------------------

Private class (CImpCommon) TaxRegConvert
    initCImpCommon ();
    Private var id, sname, isin, kind, dealdate, ppsdate,nominal, amount,price, outlay, price_bal, price_mar, realiz, rest, cost_nu,         
                other_outlay, cost, cost_overamount, overamount, outlay_amort, overamount_wa, unkd, nkd_d, nkd1_d, contrnum, portf, dealcode;
                				
    Var portfolio, point, dealtime, dealcodeEts; 
	Var ifiid, icustody, iclient, icontractid, iparty, ipriceCur, iportfolio, BoardId, protokolData = CProtokolData ();

    Private macro clear ()
        id = sname = isin = kind = dealdate = ppsdate = nominal = amount=price= outlay= price_bal= price_mar= realiz= rest= cost_nu= 
                other_outlay= cost= cost_overamount= overamount= outlay_amort= overamount_wa= unkd= nkd_d= nkd1_d= contrnum= portf = dealcode = NULL;
        ifiid = icustody = iclient = icontractid = iparty = ipriceCur = iportfolio = -1;
        BoardId = 0;
    End;

    Private macro checkLine
var sql;
        if ( not fldMandatory (id) )
            addError ("¥ ãª § ­® ®¡ï§ â¥«ì­®¥ ¯®«¥ ID");
        end;

        if ( not fldMandatory (dealdate) )
            addError ("¥ ãª § ­® ®¡ï§ â¥«ì­®¥ ¯®«¥ DEALDATE");
        elif ( not fldIsDate (dealdate) )
            addError ("¥¢¥à­® ãª § ­® ¯®«¥ DEALDATE ("+dealDate+"), ®¦¨¤ «®áì DATE");
        end;

        portfolio =  "‘‘‘„_–";
        if ( not fldMandatory (portfolio) )
            addError ("¥ ãª § ­® ®¡ï§ â¥«ì­®¥ ¯®«¥ PORTFOLIO");
        else
            sql = execSqlSelect ("select t_element from dllvalues_dbt where t_list = 1100 and t_code = :1", makeArray (sqlParam ("1", portfolio)));
            if ( not sql.moveNext () )
                addError ("¥¢¥à­® ãª § ­® ¯®«¥ PORTFOLIO, ¯®àâä¥«ì á ª®¤®¬ "+portfolio+" ­¥ ­ ©¤¥­");
            else
                iportfolio = int (sql.value (0));
            end;
        end;

        if ( not fldMandatory (isin) )
            addError ("¥ ãª § ­® ®¡ï§ â¥«ì­®¥ ¯®«¥ ISIN");
        else
            if (isin != "x")
               sql = execSqlSelect ("select t_fiid from davoiriss_dbt cb where t_isin = :1", makeArray (sqlParam ("1", isin)));
               if ( not sql.MoveNext () )
                  addError ("¥¢¥à­® ãª § ­® §­ ç¥­¨¥ ¯®«ï ISIN, – á ª®¤®¬ "+isin+" ­¥ ­ ©¤¥­ ");
               else
                  ifiid = int (sql.value (0));
               end;
            else
               addError ("’à¥¡ã¥âáï ãª § âì ®¤­® ¨§ §­ ç¥­¨© ISIN ¨«¨ LSIN");
            end;
        end;

        if ( not fldMandatory (amount) )
            addError ("¥ ãª § ­® ®¡ï§ â¥«ì­®¥ ¯®«¥ 'Š®«¨ç¥áâ¢® æ¥­­ëå ¡ã¬ £'");
        elif ( not fldIsMoney2 (amount) )
            addError ("¥¢¥à­® ãª § ­® ¯®«¥ 'Š®«¨ç¥áâ¢® æ¥­­ëå ¡ã¬ £' (" + amount +" ), ®¦¨¤ «®áì MONEY");
        end;

        if ( not fldMandatory (cost) )
            addError ("¥ ãª § ­® ®¡ï§ â¥«ì­®¥ ¯®«¥ '‘â®¨¬®áâì æ¥­­ëå ¡ã¬ £'");
        elif ( not fldIsMoney2 (cost) )
            addError ("¥¢¥à­® ãª § ­® ¯®«¥ '‘â®¨¬®áâì æ¥­­ëå ¡ã¬ £' (" + cost +" ), ®¦¨¤ «®áì MONEY");
        end;

        if ( not fldMandatory (cost_nu) )
            addError ("¥ ãª § ­® ®¡ï§ â¥«ì­®¥ ¯®«¥ '‘â®¨¬®áâì æ¥­­ëå ¡ã¬ £ ¯® ­ «®£®¢®¬ã ¯®àâä¥«î'");
        elif ( not fldIsMoney2 (cost_nu) )
            addError ("¥¢¥à­® ãª § ­® ¯®«¥ '‘â®¨¬®áâì æ¥­­ëå ¡ã¬ £ ¯® ­ «®£®¢®¬ã ¯®àâä¥«î' (" + cost_nu +" ), ®¦¨¤ «®áì MONEY");
        end;

        if ( not fldMandatory (outlay) )
            addError ("¥ ãª § ­® ®¡ï§ â¥«ì­®¥ ¯®«¥ '‡ âà âë'");
        elif ( not fldIsMoney2 (outlay) )
            addError ("¥¢¥à­® ãª § ­® ¯®«¥ '‡ âà âë' (" + outlay +" ), ®¦¨¤ «®áì MONEY");
        end;

        if ( not fldMandatory (overamount) )
            addError ("¥ ãª § ­® ®¡ï§ â¥«ì­®¥ ¯®«¥ '¥à¥®æ¥­ª '");
        elif ( not fldIsMoney2 (overamount) )
            addError ("¥¢¥à­® ãª § ­® ¯®«¥ '¥à¥®æ¥­ª ' (" + overamount +" ), ®¦¨¤ «®áì MONEY");
        end;


        if (( price ) and ( not fldIsMoney2 (price) ))
            addError ("¥¢¥à­® ãª § ­® ¯®«¥ PRICE ("+price+"), ®¦¨¤ «®áì MONEY");
        end;

        point = 6; //¡¨à¦¥¢ ï       !!! ’à¥¡ã¥âáï ãâ®ç­¨âì 
        //point = 8; // ­¥¡¨à¦¥¢ ï

        if ( not fldMandatory (unkd) )
            addError ("¥ ãª § ­® ®¡ï§ â¥«ì­®¥ ¯®«¥ 'Š„ ã¯« ç¥­­ë© ¯à¨ ¯à¨®¡à¥â¥­¨¨'");
        elif ( not fldIsMoney2 (unkd) )
            addError ("¥¢¥à­® ãª § ­® ¯®«¥ 'Š„ ã¯« ç¥­­ë© ¯à¨ ¯à¨®¡à¥â¥­¨¨' ("+unkd+"), ®¦¨¤ «®áì MONEY");
        end;

        if ( not fldMandatory (nkd_d) )
            addError ("¥ ãª § ­® ®¡ï§ â¥«ì­®¥ ¯®«¥ 'Š„ ­  ¤ âã ¯¥à¥¤ ç¨'");
        elif ( not fldIsMoney2 (nkd_d) )
            addError ("¥¢¥à­® ãª § ­® ¯®«¥ 'Š„ ­  ¤ âã ¯¥à¥¤ ç¨' ("+nkd_d+"), ®¦¨¤ «®áì MONEY");
        end;


        iClient = -1;
        iCustody = 4;
        iContractId = -1;
        ipriceCur = 0;
        dealcode ="ARNU_DU_20201026_"+id;
        return error;
    End;

    Private macro save ()

        Var cnt = 0, code = dealcode;
        while ( execSqlSelect ("select 1 from ddl_tick_dbt where t_bofficekind = 127 and t_dealcode = :1", makeArray (sqlParam ("1", code))).moveNext () )
            code = dealCode + "/" + (cnt=cnt+1);
        end;
        dealcode = code;
        record BoardPrm ("BoardPrm.rec");
        BoardPrm.DealType           = 2011;
        BoardPrm.DealCode           = dealcode;
        BoardPrm.Client             = ifThenElse (iClient > 0, iClient, {OurBank});
        BoardPrm.ClientContr        = ifThenElse (iContractId > 0, iContractId, 0);
        BoardPrm.Amount             = abs (amount);
        BoardPrm.Price              = price;
        BoardPrm.Cost               = abs (cost_nu);
        BoardPrm.Nkd                = unkd;
        BoardPrm.InterestIncome	    = nkd_d;
        BoardPrm.DealDate           = dealdate;

        if ( iClient <= 0 )
            BoardPrm.Begbonusdate       = dealdate;
        end;
        if ( valType (dealTime) == V_TIME )
            BoardPrm.DealTime           = dealTime;
        end;
        BoardPrm.PreOutlay          = 0;
        BoardPrm.Fiid               = ifiid;
        BoardPrm.DeliveringFIID     = ifiid;
        BoardPrm.priceFi            = ipriceCur;
        BoardPrm.Custody            = iCustody;
        BoardPrm.DepoClientCustody  = {ourBank};
        BoardPrm.DepoContrCustody   = iCustody;
        BoardPrm.Department         = 1;
        BoardPrm.Oper               = 9999;
        BoardPrm.DealState          = DL_PREPARING;
        if ( BoardPrm.DealType == 2011 )
            BoardPrm.Outlay = outlay;
            BoardPrm.LastOverDate =
            BoardPrm.BegDate = dealdate;/*áî¤  á¨è­¨ª ­¥ ¤ ¥â ¯®áâ ¢¨âì ¤ âã ®â«¨ç­ãî ®â dealdate*/
           // BoardPrm.TaxBegDate = ppsdate;/*áî¤  á¨è­¨ª â®¦¥ ­¥ ¤ ¥â ¯®áâ ¢¨âì ¤ âã ®â«¨ç­ãî ®â dealdate -  ¯¤¥©â¨¬ ­¨¦¥ ¯àï¬® ¢ dlsum*/
           // BoardPrm.TaxOutlay = outlay; /*áî¤  á¨è­¨ª â®¦¥ ­¥ ¤ ¥â ­¨ç¥£® § ¯¨áâì, ¬®¦­® â®«ìª® ¤«ï ”‹ -  ¯¤¥©â¨¬ ­¨¦¥ ¯àï¬® ¢ dlsum*/
        end;
        BoardPrm.Point              = point;
        BoardPrm.Portfolio          = iportfolio;
        BoardPrm.Contragent         = iparty;

	 BoardPrm.OverAmount         = overAmount;
/*	 BoardPrm.ReservAmount	 = reservAmount;
	 BoardPrm.BegDiscount	 = begDiscount;
	 BoardPrm.BegBonus		 = begBonus;
	 BoardPrm.BegDiscountDate	 = begDiscountDate;
	 BoardPrm.BegBonusDate	 = begBonusDate;
	 BoardPrm.InterestIncome	 = InterestIncome;
	 BoardPrm.DiscountIncome	 = DiscountIncome;
	 BoardPrm.RecalcDate         = recalcDate;
	 BoardPrm.OldBegDiscount	 = OldBegDiscount;
	 BoardPrm.NotCarryDiscount	 = NotCarryDiscount;
	 BoardPrm.OldBegBonus	 = OldBegBonus;
	 BoardPrm.NotWrtBonus	 = NotWrtBonus;
     BoardPrm.BegDate            = OwnerBegDate;
*/

   //  BoardPrm.UseInTax = "X"; // ¯® á®¡áâ¢¥­­ë¬ API àã£ ¥âáï, â.ª. ¯ à ¬¥âà ïª®¡ë â®«ìª® ¤«ï ”‹
	 
        rslDefCon.beginTrans ();

        /*!!!*/
        if ( (not execSqlSelect ("select 1 from dpartyown_dbt where t_partykind=1 and t_partyid = :1", makeArray (sqlParam ("1", BoardPrm.Client))).moveNext ()) and
             execSqlSelect ("select 1 from dparty_dbt where t_partyid = :1", makeArray (sqlParam ("1", BoardPrm.Client))).moveNext () ) 
            myExecSql ("insert into dpartyown_dbt values (:1, 1, 0, 0, 0, 0)", makeArray (sqlParam ("1", BoardPrm.Client)));
            myExecSql ("insert into dclient_dbt select :1, decode (rownum, 1, 1, 2, 2, 3, 7, 4, 15), 0, to_date ('01010001', 'ddmmyyyy'), to_date ('01010001', 'ddmmyyyy'), 1, 0, 0, chr (1) from dual connect by level <= 4", makeArray (sqlParam ("1", BoardPrm.Client)));
            myExecSql ("insert into dptsvdp_dbt values (:1, 1, 1)", makeArray (sqlParam ("1", BoardPrm.Client)));
        end;
//execsql ("insert into vvg values (1, :1, systimestamp)", makeArray (sqlParam ("1", xx=xx+1)));        
        Var repeat = 1, ok = false;
        while ( (repeat > 0) and (not (ok = SP_InsertBoardLot (BoardPrm, BoardId, true))) )
            repeat = repeat - 1;
        end;
        if ( not ok )
            runError (GetErrMsg());
        end;
        
//execsql ("insert into vvg values (2, :1, systimestamp)", makeArray (sqlParam ("1", xx)));        

        if ( (dealcodeEts) and (myExecSql ("update ddl_tick_dbt set t_dealcodets = :1 where t_dealid = :2", makeArray (sqlParam ("1", dealcodeEts), sqlParam ("2", BoardId))) == NULL) )
            runError ("-");
        end;

        if ( (myExecSql ("update ddl_leg_dbt set t_relativeprice = chr(88), t_expiry = :2, t_maturity = :3 where t_dealid = :4", makeArray (sqlParam ("2", ppsdate),sqlParam ("3", ppsdate),sqlParam ("4", BoardId))) == NULL) )
            runError ("-");
        end;

        if (  (myExecSql ("update ddl_tick_dbt set t_FLAG3 = Chr(88) where t_dealid = :1", makeArray (sqlParam ("1", BoardId))) == NULL) )
            runError ("-");
        end;

        if (  (myExecSql (
                          " UPDATE ddlsum_dbt                                                               "+
                          "    SET T_SUM =                                                                  "+
                          "           (SELECT   RSI_RSB_FIINSTR.FI_GETNOMINALONDATE (t_pfi, t_maturity)     "+
                          "                   * t_price                                                     "+
                          "                   / 100                                                         "+
                          "                   * t_principal                                                 "+
                          "              FROM ddl_leg_Dbt                                                   "+
                          "             WHERE t_dealid = :1),                                               "+
                          "        T_DATE = :2                                                              "+//¤ â  ‘ ¡¥à¥âáï ­ «®£ ¬¨ ®âáî¤ 
                          "  WHERE T_Dockind = 127 AND t_docid = :3 AND t_kind = 1230                       ",
               makeArray (sqlParam ("1", BoardId), sqlParam ("2", ppsdate), sqlParam ("3", BoardId))) == NULL) )
            runError ("-");
        end;

        if (  (myExecSql (
                          " UPDATE ddlsum_dbt                                                               "+
                          "    SET T_SUM = :1,                                                              "+
                          "        T_DATE = :2                                                              "+
                          "  WHERE T_Dockind = 127 AND t_docid = :3 AND t_kind = 1250                       ",
               makeArray (sqlParam ("1", outlay), sqlParam ("2", ppsdate), sqlParam ("3", BoardId))) == NULL) )
            runError ("-");
        end;
        if (  (myExecSql (
                          "Insert into DDLCOMIS_DBT \n" +
                          "   (T_ID, T_DOCKIND, T_DOCID, T_CONTRACT, T_FEETYPE, T_COMNUMBER, T_SUM, T_NDS, T_DATE, T_PLANPAYDATE,  " 
                          " T_FACTPAYDATE, T_INPUTMEDIUM, T_SERVOPERID, T_ISBACK, T_VERSION, T_RECEIVERID, T_PARENT, T_GROUND, T_RUNCARRY, T_MONTHAMORTSUM, T_COMTYPE, T_STARTAMORTDATE, T_SETTLECODE) \n" +
                          " Values \n" +
                          "   (0, 127, :1, :2, 1,  \n" +
                          "    60, :3, 0, :4, :5,  \n" +
                          "    :6, '', 0, chr(0),  \n" +
                          "    0, 0, 0, CHR(1), CHR(0),  \n" +
                          "    0, 0, TO_DATE('01/01/0001 00:00:00', 'MM/DD/YYYY HH24:MI:SS'), CHR(1)); \n" ,
              makeArray (sqlParam ("1", BoardID), sqlParam ("2", iContractId), sqlParam ("3", outlay), sqlParam ("4", ppsdate), sqlParam ("5", ppsdate), sqlParam ("6", ppsdate))) == NULL) )
            runError ("-");
        end;


        if (  (myExecSql ("update ddl_tick_dbt set t_dealstatus = 20 where t_dealid = :1", makeArray (sqlParam ("1", BoardId))) == NULL) )
            runError ("-");
        end;

        if (  (myExecSql ("update ddl_tick_dbt set t_ofbu = chr(88) where t_dealid = :1", makeArray (sqlParam ("1", BoardId))) == NULL) )
            runError ("-");
        end;

        if (  (myExecSql ("update ddlrq_dbt set t_state = 2, t_plandate = :1, t_factdate = :2 where t_docid = :3 and t_dockind = 127", makeArray (sqlParam ("1", ppsdate),sqlParam ("2", ppsdate),sqlParam ("3", BoardId))) == NULL) )
            runError ("-");
        end;

        rslDefCon.commitTrans ();

        return TRUE;
    OnError ( err )
        if ( rslDefCon.isInTrans () )
            rslDefCon.rollbackTrans ();
        end;

        if ( substr (err.message, strlen (err.message)) == "+" )
            errorStr = strsubst (GetErrMsg (), "|", "\n");
        else
            errorStr = getLastRSDError ();
        end;
        error = TRUE;
        return FALSE;
    End;

    Private macro printHeader
        [‡ £àã§ª  ­ «®£®¢®£® à¥£¨áâà ];
        [” ©« #] (fName);
        [########## ########] (date (), time ());
        [ ]; [ ];
    End;

    Private macro printErrors
        Var sql = execSqlSelect ("select x.*, count (1) over () t_cnt from user_cnvhlplog_du x where t_kind = 1 order by t_line"),
            y = sql.moveNext (), x = 0;

        if ( not y ) return; end;

        println ("‚ ¯à®æ¥áá¥ § £àã§ª¨ ¯à®¨§®è«¨ ®è¨¡ª¨ (", int (sql.value ("t_cnt")), " èâ.), § ¯¨á¨ ­¥ § £àã¦¥­ë:");
        [ÚÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
         ³ ü ¯/¯ ³ ‘âà®ª  ³                                       Ž¯¨á ­¨¥ ®è¨¡ª¨                                              ³
         ÃÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
        while ( y )
            [³#######³########³####################################################################################################³]
            (x = x+1, int (sql.value ("t_line")), sql.value ("t_context"):w);
            y = sql.moveNext ();
        end;
        [ÀÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
        [ ]; [ ];
    End;

    Private macro printLog
        Var sql = execSqlSelect ("select x.*, count (1) over () t_cnt from user_cnvhlplog_du x where t_kind = 0 order by t_line"),
            y = sql.moveNext (), x = 0;

        if ( not y ) 
            [‡ £àã¦¥­­ë¥ § ¯¨á¨ ®âáãâáâ¢ãîâ];
            return; 
        end;

        println ("‡ £àã¦¥­ë § ¯¨á¨ (", int (sql.value ("t_cnt")), " èâ.):");
        [ÚÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
         ³ ü ¯/¯ ³ ‘âà®ª  ³  RecId   ³  Š®¤ á¤¥«ª¨            ³                 §¢ ­¨¥ –             ³Š®«¨ç¥áâ¢®³        ‘ã¬¬        ³
         ÃÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];

        while ( y )
            println ("³", x=x+1:7, sql.value ("t_context"));
            y = sql.moveNext ();
        end;
        [ÀÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
    End;

    Macro run ( namefile, numproc, linestart, lineend, logName, procSize )
        processNumber = numproc;
        if ( not openFile (namefile) )
            return;
        end;

        if ( procSize )
             fSize = procSize;
        end;

        if ( not prepare () )
            msgBox ("Žè¨¡ª  ¯®¤£®â®¢ª¨");
            return;
        end;

        if ( logName )
            setOutput (logName);
        else
            setLog (numproc);
        end;

        printHeader ();

        if ( (linestart) and (linestart > 1) )
            setPosition (linestart);
        end;

        SP_BeginInsertBoardLot ();
        Var i = 0;
//		nextLine ();
        while ( nextLine () )
            clear ();
            loadLine (id,                         // 1
                      sname,                      // 2
                      isin,                       // 3
                      dealdate,                   // 4
                      ppsdate,                    // 5
                      kind,                       //   6
                      nominal,                    //   7
                      amount,                     //   8
                      price,                      //   9
                      outlay,                     //   10
                      price_bal,//æ¥­  ¤«ï ®¯à¥¤¥«¥­¨ï ¡ « ­á®¢®© áâ®¨¬®áâ¨ 11
                      price_mar,                  //                          12
                      realiz,                     //                          13
                      rest,                       //                          14
                      cost_nu,                    //                          15
                      other_outlay,               //                          16
                      cost,                       //                          17
                      cost_overamount,            //                          18
                      overamount,                 //                          19
                      outlay_amort,               //                          20
                      overamount_wa,              //                          21
                      unkd,                       //                          22
                      nkd_d,                      //                          23
                      nkd1_d,                     //                          24
                      contrnum,                   //                          25
                      portf                       //                          26
                      );
            if ( error )
                protokolData.add (1, line, errorStr);
                saveerr (numproc);
            elif ( not save () )
                protokolData.add (1, line, errorStr);
                saveerr (numproc);
            else
                protokolData.addLine (0, line, id, dealcode, ifiid, amount, cost);
            end;
            if ( (lineend) and (line >= lineend) ) break; end;

        end;

        SP_EndInsertBoardLot ();

        printLogCommon (numproc, linestart, lineend);
        printErrors ();
        printLog ();
        viewFile (setoutput (NULL, TRUE));
    End;

End;
//-----------------------------------------------------------------------------------------

//Macro PreStep
//End;
//-----------------------------------------------------------------------------------------