import DealsInter, CTInter;
import dbo_message_main_c;
import rshb_lib;
import func_lib;
import dlcontrfunc;

var fi_list_send = "810";//"810, 840, 978, 826, 756";

var flownum_SPB_SEND;

   var cnum_spb_send: integer;
   var rs_spb_send = execSQLselect("SELECT RSBSESSIONDATA.CNum FROM dual", null, true);
    if(rs_spb_send and rs_spb_send.moveNext())
      flownum_SPB_SEND = rs_spb_send.value(0);
    end;

private macro GetStrRegVal(regPath:string)
  var stat = 0, path = "";
  GetRegistryValue(regPath, V_STRING, path, stat);
  if(stat != 0)
    msgbox("Ошибка при получении значения настройки: " + regPath);
  elif(path == "")
    stat = 1;
    msgbox("Не задано значение настройки: " + regPath);
  end;
  return path;
end;

//Загрузка файла из депозитария DIAS
private macro LoadDiasDepoFile()
  private const  OPEN_DIALOG_HEADER = "Выберите файл для загрузки данных из депозитария DIAS"; 
  private const REGPATH = "РСХБ\\ДИРЕКТОРИИ\\SPBIMPORT";

  private const spbaccmark1 = "-3939-"; 
  private const spbaccmark2 = "-6939-"; 
  private const SPB_Trade_ACC_Note  = 115;
  private const MMVB_Trade_ACC_Note = 106;

  FILE inFile() txt;

  class DepoItem(FileRec)
    var RecID:String          = FileRec(0);
    var ContractNumber:String = FileRec(1);
    var ContractDate          = FileRec(2);
    var DEPONumber:String     = FileRec(3);
    var DEPODate                = FileRec(4);
    var DEPOCloseDate         = FileRec(5);
    var DEPOID:String         = FileRec(6);
    var AccDEPONumber:String  = FileRec(7);
    var SectionCode:String    = FileRec(8);
  end;

    private macro m_dias_depo_data_load(DepoUnit:object)
       var v_sql_cl, v_cmd_cl;
       var cmd1, rs1, cmdrez, rsrez;
       var Error = 0;
       var errortext = "";
       var TradeAccNoteKind;

          cmd1 = "select ddlcontr.t_dlcontrid from "+
                 " ddlcontr_dbt ddlcontr "+
                 " left join dsfcontr_dbt sfcontr on sfcontr.t_id = ddlcontr.T_SFCONTRID "+
                 " where sfcontr.t_number = :inparam ";
          cmd1 = rsdcommand(cmd1);
          cmd1.AddParam("inparam", RSDBP_IN, DepoUnit.ContractNumber);
          rs1 = RsdRecordset(cmd1);
          rs1.movenext;
          if (valtype(rs1.value(0))== 26)
             error = 1;
             errortext = "Не найден Договор БО"
          else
             if ((index(DepoUnit.SectionCode,spbaccmark1) > 0) or  (index(DepoUnit.SectionCode,spbaccmark2) > 0))
             TradeAccNoteKind = SPB_Trade_ACC_Note;
                else
             TradeAccNoteKind = MMVB_Trade_ACC_Note;
             end;
        
             if ((substr(DepoUnit.AccDEPONumber, 1, 1) == "К") or ((substr(DepoUnit.AccDEPONumber, 1, 1) == "K"))) //не знаю, кириллица или латиница, поэтому на всякий случай
             if (addnoteforobject(207,string(rs1.value(0):34:o),101,DepoUnit.AccDEPONumber) == 1)
                   error = 2;
                errortext = "Невозможно вставить примечание";
                end;
             if (addnoteforobject(207,string(rs1.value(0):34:o),105,DepoUnit.SectionCode) == 1)
                   error = 2;
                errortext = "Невозможно вставить примечание";
                end;
          elif ((substr(DepoUnit.AccDEPONumber, 1, 1) == "Т") or ((substr(DepoUnit.AccDEPONumber, 1, 1) == "T"))) //не знаю, кириллица или латиница, поэтому на всякий случай
                if (addnoteforobject(207,string(rs1.value(0):34:o),104,DepoUnit.AccDEPONumber) == 1)
                error = 2;
                   errortext = "Невозможно вставить примечание";
             end;
                if (addnoteforobject(207,string(rs1.value(0):34:o),TradeAccNoteKind,DepoUnit.SectionCode) == 1)
                error = 2;
                   errortext = "Невозможно вставить примечание";
             end;
             elif ((substr(DepoUnit.AccDEPONumber, 1, 1) == "M") or ((substr(DepoUnit.AccDEPONumber, 1, 1) == "М"))) //не знаю, кириллица или латиница, поэтому на всякий случай
             if (addnoteforobject(207,string(rs1.value(0):34:o),107,DepoUnit.AccDEPONumber) == 1)
                   error = 2;
                errortext = "Невозможно вставить примечание";
                end;
             if (addnoteforobject(207,string(rs1.value(0):34:o),108,DepoUnit.SectionCode) == 1)
                   error = 2;
                errortext = "Невозможно вставить примечание";
                end;
          elif ((substr(DepoUnit.AccDEPONumber, 1, 3) == "D-0") or ((substr(DepoUnit.AccDEPONumber, 1, 3) == "Д-0"))) //не знаю, кириллица или латиница, поэтому на всякий случай
                if (addnoteforobject(207,string(rs1.value(0):34:o),101,DepoUnit.AccDEPONumber) == 1)
                error = 2;
                   errortext = "Невозможно вставить примечание";
             end;
                if (addnoteforobject(207,string(rs1.value(0):34:o),105,DepoUnit.SectionCode) == 1)
                error = 2;
                   errortext = "Невозможно вставить примечание";
             end;
             elif ((substr(DepoUnit.AccDEPONumber, 1, 3) == "D-T") or ((substr(DepoUnit.AccDEPONumber, 1, 3) == "Д-Т"))) //не знаю, кириллица или латиница, поэтому на всякий случай
             if (addnoteforobject(207,string(rs1.value(0):34:o),104,DepoUnit.AccDEPONumber) == 1)
                   error = 2;
                errortext = "Невозможно вставить примечание";
                end;
             if (addnoteforobject(207,string(rs1.value(0):34:o),106,DepoUnit.SectionCode) == 1)
                   error = 2;
                errortext = "Невозможно вставить примечание";
                end;

          elif ((substr(DepoUnit.AccDEPONumber, 1, 1) == "D") or ((substr(DepoUnit.AccDEPONumber, 1, 1) == "Д")) and (substr(DepoUnit.AccDEPONumber, 3, 1) != "Д")) //не знаю, кириллица или латиница, поэтому на всякий случай
                if (addnoteforobject(207,string(rs1.value(0):34:o),101,DepoUnit.AccDEPONumber) == 1)
                error = 2;
                   errortext = "Невозможно вставить примечание";
             end;
                if (addnoteforobject(207,string(rs1.value(0):34:o),105,DepoUnit.SectionCode) == 1)
                error = 2;
                   errortext = "Невозможно вставить примечание";
             end;
             end;

          if (valtype(DepoUnit.DEPONumber)!= 26)
                if (addnoteforobject(207,string(rs1.value(0):34:o),102,DepoUnit.DEPONumber) == 1)
                error = 2;
                   errortext = "Невозможно вставить примечание";
             end;
             end;
          if (valtype(DepoUnit.DEPODate)!= 26)
                if (addnoteforobject(207,string(rs1.value(0):34:o),103,date(DepoUnit.DEPODate))== 1)
                error = 2;
                   errortext = "Невозможно вставить примечание";
             end;
             end;
          if (valtype(DepoUnit.DEPOCloseDate)!= 26)
           //     if (addnoteforobject(207,string(rs1.value(0):34:o),110,date(DepoUnit.DEPOCloseDate))== 1)
           //       error = 2;
           //       errortext = "Невозможно вставить примечание";
           //     end;
          end;

             // BIQ-7089 Гераськина Т.В.
             // UpdateStatusContractFromDepo(rs1.value(0));
          end;
          println(errortext);
    end;

  var LoadDir = DL_GetFullPath(GetStrRegVal(REGPATH));;
  var FullNameFile; 
  if(not SelectFile(FullNameFile,/* "$" +*/ LoadDir + "*.txt*", "Выберите файл для загрузки", 0, false)) //true - терминал false - сервер
    MsgBox("Отказ от загрузки");
    return 0;
  end;
  println(FullNameFile+":");
  var n = 0;
  var DepoUnit;
  if(Open(inFile, FullNameFile, "rsansi"))
     setdelim(";");
     BegAction(200, "Ждите. Идет обработка файла ....");
     while(next(inFile))
       n = n + 1;
       DepoUnit = DepoItem(inFile);

       m_dias_depo_data_load(DepoUnit);
     end;
     EndAction();
  end;

end;

private macro u_dttm()
  return strsubst(strsubst(string(date, time),".",""),":","");
end;

private macro CheckValue(val:variant)
 private CONST v_SPECVAL = 26;

    if(valtype(val) == V_UNDEF)
        return ""/*0*/;
    end;

    if(valtype(val) == v_SPECVAL)
        return ""/*0*/;
    end;

    if(valtype(val) == v_DTTM)
        return string(sql_ConvTypeDate(val):f);
    end;

    if(trim(string(val)) == "")
        return "";
    end;

    if(valtype(val) == v_DOUBLE)
       return int(val);
    end;

    return string(val);

end;//macro CheckValue

private macro GetUploadData(dlid)
 var str;
 startcaptureoutput();
    [SELECT dlc.t_dlcontrid as ContractID,
          dlc.t_sfcontrid,
       sfc/*_spb*/.t_number as ContractNumber,
       sfc_spb.t_datebegin as ContractDate,
       sfc_spb.t_number/*sfc_spb.t_name*/ as ContractName,
       3 AS typetp,
       (SELECT fi.t_ccy
          FROM dfininstr_dbt fi
         WHERE t_fiid = a.t_code_currency) AS Funds ,
       DECODE (p.t_legalform, 1, 2, 1) AS ClientType,
       spb.t_clientid AS ClientID,
       '0000' AS BranchID,
         /* (SELECT t_code
             FROM ddlobjcode_dbt
            WHERE     t_objectid = dlc.t_dlcontrid
                  AND t_objecttype = 207
               AND t_codekind = 1)*/mp.t_mpcode AS CodeCli,
          (SELECT t_code
             FROM ddlobjcode_dbt
            WHERE     t_objectid = dlc.t_dlcontrid
                  AND t_objecttype = 207
               AND t_codekind = 2) AS ClientRegistrationCodeSPBEX,
       a.t_account as AccCliBrok,
       a.t_open_date as AccDateOpen,
       DECODE (ac.t_catnum,  201, 1,  5087, 2,  0) AS acctype,
       DECODE (scq.t_state,  0, 2,  1, 1,  0) AS KvalInv,
       scq.t_regdate AS DateStKI,
       scq.t_changedate AS DateEndKI
      FROM uspbaprovcontr_dbt spb,
          dsfcontr_dbt sfc,
          ddlcontr_dbt dlc,
       dparty_dbt p LEFT JOIN dscqinv_dbt scq ON scq.t_partyid = p.t_partyid,
       ddlcontrmp_dbt mp LEFT JOIN dmcaccdoc_dbt ac ON     ac.t_clientcontrid = mp.t_sfcontrid
                                                       AND ac.t_chapter = 1
                                                       AND ac.t_iscommon = CHR (88)
                                                       AND ac.t_catnum NOT IN
                                                              (531, 560) LEFT JOIN daccount_dbt a ON     ac.t_chapter = a.t_chapter
                                                                                                     AND ac.t_currency = a.t_code_currency
                                                                                                     AND ac.t_account = a.t_account,
       dsfcontr_dbt sfc_spb                                                                                              
      WHERE spb.t_sfcontrid = sfc.t_id
          AND sfc.t_id = dlc.t_sfcontrid
       AND sfc.t_partyid = p.t_partyid
       AND dlc.t_dlcontrid = ########
       AND mp.t_dlcontrid = dlc.t_dlcontrid
       AND mp.t_marketid = ########
       AND sfc_spb.t_id = MP.T_SFCONTRID;
                                                                                                                                                  ](dlid, SPBCode);
   var cmd =RSDRecordset(RSDCommand(EndCaptureOutput()), rsdval_client, rsdval_static);
   return cmd;
end;

private CONST SPB_CODE = "ПАО СПБ";    /* код СПБ */
//вставка задания
private macro InsUserInEvent( ObjectType :integer, Status :integer) :integer
var Query :string = "",
    cmd,
    ReqId :integer = 0;

 Query = " DECLARE " +
         "  v_ObjectType      utableprocessin_dbt.T_OBJECTTYPE%TYPE := :p_ObjectType; " +
         "  v_Status          utableprocessin_dbt.T_STATUS%TYPE := :p_Status; " +
         "  v_RecId           utableprocessin_dbt.T_RECID%TYPE := :p_RecId; " +
         " BEGIN " +
         "  BEGIN " +
         "   INSERT INTO utableprocessin_dbt( T_TIMESTAMP, T_OBJECTTYPE, T_STATUS) " +
         "   VALUES( SYSDATE, v_ObjectType, v_Status) RETURNING T_RECID INTO v_RecId; " +
         "   :p_RecId := v_RecId; " +
         "  EXCEPTION " +
         "   WHEN OTHERS THEN " +
         "   BEGIN " +
         "    :p_RecId := -1; " +
         "   END; " +
         "  END; " +
         " END; ";

 cmd = RSDCommand( Query );
 cmd.AddParam( "p_ObjectType", RSDBP_IN, ObjectType );
 cmd.AddParam( "p_Status", RSDBP_IN, Status );
 cmd.AddParam( "p_RecId", RSDBP_OUT, V_INTEGER );
 cmd.execute();

 if( ( ValType(cmd.value("p_RecId")) ==  V_UNDEF ) or ( ValType(cmd.value("p_RecId")) ==  26 ) or ( cmd.value("p_RecId") ==  -1 ))
  ReqId = 0;
 else
  ReqId = cmd.value("p_RecId");
 end;
 cmd.Close;

 return ReqId;

onError(err)
 return -1;
end;

//Помечаем в табличке допущенных договоров, что уведомление отправлено
private macro mark_as_sent(DLID)
  var sql, cmd;
  sql = " UPDATE uSPBAprovContr_dbt spb "+
        "   SET spb.t_is_send = CHR (88) "+
        " WHERE spb.t_sfcontrid IN (SELECT dlc.t_sfcontrid  "+
        "                             FROM ddlcontr_dbt dlc "+
        "                            WHERE dlc.t_dlcontrid = ?) ";
  cmd = RSDCommand(sql);
  cmd.AddParam("dlcontrid", rsdbp_in, DLID);

  cmd.execute;
end;

private macro mark_as_upload(DLID)
  var sql, cmd;
  sql = " UPDATE uSPBAprovContr_dbt spb "+
        "   SET spb.t_is_upload = CHR (88) "+
        " WHERE spb.t_sfcontrid IN (SELECT dlc.t_sfcontrid  "+
        "                             FROM ddlcontr_dbt dlc "+
        "                            WHERE dlc.t_dlcontrid = ?) ";
  cmd = RSDCommand(sql);
  cmd.AddParam("dlcontrid", rsdbp_in, DLID);

  cmd.execute;
end;

private MACRO u_GetClientID( KOD:string, CodeKind:integer ):INTEGER
  var PartyID;

  PartyID = ПолучитьКодСубъекта( KOD, CodeKind );
  if( PartyID <= 0 )
     return -1;
  end;
  return PartyID;
END;

//var SPBCode = (u_GetClientID( SPB_CODE, PTCK_CONTR ));

//Функция генерации единого кода на бирже в субдоговорах
private macro uGetPersonalCodeSub( SFNumb )
   var PersonalCode;

    var partyid = 148764;

      //Берем краткий код клиента на ммвб
      //var Query = "select t_code from dobjcode_dbt where t_objectid = :id and t_codekind = 8 and T_BANKCLOSEDATE > :dat";
      // gtv: ЕКК хранится в виде кода 1 к договору
      var Query = "select distinct cod.t_code "+
      "  from            "+       
      "        DDLCONTRMP_dbt  mp, "+                    
      "        ddlcontr_dbt dl,    "+
      "        ddlobjcode_dbt cod    "+
      " where mp.t_dlcontrid = DL.T_DLCONTRID ";

      Query = Query + "   and dl.t_sfcontrid = (select t_id from dsfcontr_dbt where t_servkind = 0 and t_number = :numb ) ";
      Query = Query + 
      "   and cod.t_objecttype = 207          "+
      "   and cod.t_objectid = dl.t_dlcontrid "+
      "   and cod.t_codekind = 1              "+
      "   and ( cod.t_bankclosedate = to_date('01.01.0001','dd.mm.yyyy') or (cod.t_bankclosedate > :dat) )";
      Query = RSDCommand(Query);

      Query.AddParam("numb", RSDBP_IN, StrSubst(StrSubst(StrSubst(StrSubst(SFNumb,"_ю",""),"_с",""),"_ф",""),"_в","")  );
      Query.AddParam("dat", RSDBP_IN, {curdate});
      var rs = RsdRecordset(Query);
      rs.Movenext();

      if (valtype(rs.value(0))== 26)

         //если краткий код клиента на ммвб не задан, берется последнее значение референса и по принципу вышестоящей функции генерится единый код клиента
         var CMD = "select t_lastvalue from dmeter_dbt where t_seqid = 1000002";
         cmd = RSDCommand(cmd);
         var rs1 = RsdRecordset(cmd);
         rs1.movenext;

         var val = rs1.value(0);
         var Query1 = "select t_isemployer from dpersn_dbt where t_personid = :1 and t_isemployer = chr(88)";
         Query1 = RSDCommand(Query1);
         Query1.AddParam("1", RSDBP_IN, partyid);
         var rs2 = RsdRecordset(Query1);

         if (rs2.MoveNext)
               PersonalCode = string("5", val);
         elif (index(StrUpr(SFNumb),"ИИС" ) > 0)
            PersonalCode = string("6", val);
         else
            var  Query2 = "select party.t_legalform, "+
                          "case when isb.num = 1 then 'X' end as isbank, "+
                          "case when isdu.num = 1 then 'X' end as istrust "+
                          "from dparty_dbt party "+
                          "left join(select PTOWN.T_PARTYID, count(*) as num from dpartyown_dbt ptown where PTOWN.T_PARTYKIND = 2 group by PTOWN.T_PARTYID) isb on  isb.T_PARTYID = party.t_partyid "+
                          "left join(select PTOWN.T_PARTYID, count(*) as num from dpartyown_dbt ptown where PTOWN.T_PARTYKIND = 65 group by PTOWN.T_PARTYID) isdu on  isdu.T_PARTYID = party.t_partyid "+
                          "where party.t_partyid = :patyid ";
            Query2= RSDCommand(Query2);
            Query2.AddParam("patyid", RSDBP_IN, partyid);
            var rs3 = RsdRecordset(Query2);

            while (rs3.MoveNext)
               if (rs3.value(0)==2)
                  PersonalCode = string("4", val);
               else
                  if (rs3.value(1)=="X")
                     PersonalCode = string("1", val);
                  elif(rs3.value(2)=="X")
                     PersonalCode = string("3", val);
                  else
                     PersonalCode = string("2", val);
                  end;
               end;
            end;
         end;
      else
         PersonalCode = rs.value(0);
      end;

         PersonalCode = "S"+PersonalCode;

   return PersonalCode;
end;



private macro GenClientCode_fx(partyid)
var isUnic = false;
var ClientCode = "";
var sql, cmd, rs;
sql = "select count(1) isExist from ddlcontrmp_dbt where t_mpcode = ?";
cmd = RSDCommand(sql);
cmd.AddParam("ClientCode", rsdbp_in, ClientCode);
while (not isUnic)
  ClientCode = GeneratePersonalCode(partyid, null,null,15,null);
  cmd.param(0).value = ClientCode;
  rs = RSDRecordset(cmd, rsdval_client, rsdval_static);
  if(rs.movenext)
    if(rs.value("isExist") == 0)
      rs = null;
      cmd = null;
      isUnic = true;
      return ClientCode;
    end;
  end; 
end;
return ClientCode;
end;

private macro   uGenerateUnicClientCode_FX(numREF)
   var ClientCode;
   var sql = "begin \n ? := rshb_user.uGenerateUnicClientCode_FX(?, ?,?,?,?); \n end;";
   var cmd = RSDCommand(sql);
       cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
       cmd.AddParam("pRefnum", rsdbp_in, numREF);
       cmd.AddParam("pOperDPRT", rsdbp_in, {OperDPRT});
       cmd.AddParam("pOperDPRTNode", rsdbp_in, {OperDPRTNode});
       cmd.AddParam("pDate", rsdbp_in, {Curdate});
       cmd.AddParam("p_Code", RSDBP_OUT, V_STRING, ClientCode);
       cmd.Execute();
   var  stat = SQL_ConvType(cmd.value("p_Stat"));
   ClientCode = SQL_ConvType(cmd.value("p_Code"));
   return ClientCode;
end;


private macro insertTimelog(pOperation)
var cmd;
cmd = rsdCommand("begin\n rshb_user.insertDateLog(?);\n end;");
cmd.addParam("Operation", rsdbp_in, pOperation);
cmd.Execute;
end;
private macro  runTimeShift()
var cmd;
cmd = RSDCommand("Select * from dlog");
runscroll(RSDRecordset(cmd, rsdval_client, rsdval_static));
end;

private class TRslScroll ()
   var scr_name  = "";    
   var scr_ronly = true;
   var colInfo;

   var title   = "";
   var st_line = "";
   //
   macro numCol
   if (colInfo)
      return colInfo.size / 6
   end
   end;
   //                            
   macro RmvCol
   colInfo = null;
   end;
   //
   macro is_pos(sql)
   gotoscroll(sql);
   if ((sql.Value(0) != null) and (sql.Value(0) != nullval))
      return true;
   end;
   return false;
   end;
   //
   macro AddCol(fld, head, width, fldtype, decpoint) 
   var ind = 0;    
   if (not colInfo)
      colInfo = TArray;
   end;       
   ind = colInfo.Size/6;
   colInfo.value (ind * 6)      = fld;
   colInfo.value (ind * 6 + 1)  = head;
   colInfo.value (ind * 6 + 2)  = width;
   colInfo.value (ind * 6 + 3 ) = fldType;
   colInfo.value (ind * 6 + 4 ) = decPoint;
   colInfo.value (ind * 6 + 5 ) = 0;
   end;

   macro on_scr_key_13(sql, field, key_kod)
   end;
   macro on_scr_key_32(sql, field, key_kod)
   end;
   macro on_scr_key_PLUS(sql, field, key_kod)
   end;
   macro on_scr_key_MINUS(sql, field, key_kod)
   end;
   macro on_scr_key_F2(sql, field, key_kod)
   end;
   macro on_scr_key_Ctrl_F2(sql, field, key_kod)
   end;
   macro on_scr_key_F3(sql, field, key_kod)
   end;
   macro on_scr_key_Ctrl_F3(sql, field, key_kod)
   end;
   macro on_scr_key_F5(sql, field, key_kod)
   end;
   macro on_scr_key_F6(sql, field, key_kod)
   end;
   macro on_scr_key_F7(sql, field, key_kod)
   end;
   macro on_scr_key_F8(sql, field, key_kod)
   end;
   macro on_scr_key_F9(sql, field, key_kod)
   end;
   macro on_scr_key_AltF6(sql, field, key_kod)
   end;
   macro on_scr_key_AltF8(sql, field, key_kod)
   end;
   macro on_scr_key_AltF9(sql, field, key_kod)
   end;
   macro on_scr_key_CtrlF8(sql, field, key_kod)
   end;
   macro on_scr_key_Esc(sql, field, key_kod)
   end;
   macro on_scr_key_Ctrl_R(sql, field, key_kod)
   end;
   macro on_scr_key_empty(sql, field, key_kod)
   end;
   macro on_scr_init(sql, field, key_kod)
   end;
   macro on_scr_mlt_beg(sql, field, key_kod)
   end;
   macro on_scr_mlt_end(sql, field, key_kod)
   end;
   macro on_scr_mlt_sel(sql, field, key_kod)
   end;
   macro on_scr_preinit(sql, field, key_kod)
   end;
   /************************************/
   macro EvProc (sql, event, field, key_kod)
      //execmacrofile("all_event_dlg.mac", "decode_event", sql, event, field, key_kod, null);
      if (event == DLG_INIT)
         on_scr_init(sql, event, field, key_kod);
      end;
      if (event == DLG_PREINIT)
         on_scr_preinit(sql, event, field, key_kod);
      end;
      if (event == DLG_MSELSTART)
         return on_scr_mlt_beg(sql, field, key_kod);
      end;
      if (event == DLG_MSEL)
         return on_scr_mlt_sel(sql, field, key_kod);
      end;
      if (event == DLG_MSELEND)
         return on_scr_mlt_end(sql, field, key_kod);
      end;
      if (event == DLG_KEY)
//         msgbox(key_kod);
         if    (key_kod==316)
               return on_scr_key_f2(sql, field, key_kod);
         elif  (key_kod==317) //F3
               return on_scr_key_f3(sql, field, key_kod);
         elif  (key_kod==352) //Ctrl+F3
               return on_scr_key_Ctrl_F3(sql, field, key_kod);
         elif  (key_kod==319)
               return on_scr_key_f5(sql, field, key_kod);
         elif  (key_kod==320)
               return on_scr_key_f6(sql, field, key_kod);
         elif  (key_kod==321)
               return on_scr_key_f7(sql, field, key_kod);
         elif  (key_kod==322)
               return on_scr_key_f8(sql, field, key_kod);
         elif  (key_kod==323)
               return on_scr_key_f9(sql, field, key_kod);
         elif  (key_kod==365) //ALT_F6
               return on_scr_key_altf6(sql, field, key_kod);
         elif  (key_kod==367) //ALT_F8
               return on_scr_key_altf8(sql, field, key_kod);
         elif  (key_kod==368) //ALT_F9
               return on_scr_key_altf9(sql, field, key_kod);
         elif  (key_kod==357) //CTRL_F8
               return on_scr_key_ctrlf8(sql, field, key_kod);
         elif  (key_kod==32)  //SPACE
               return on_scr_key_32(sql, field, key_kod);
         elif  (key_kod==13)  //ENTER)
               return on_scr_key_13(sql, field, key_kod);
         elif  (key_kod==217) //ESC
               return on_scr_key_Esc(sql, field, key_kod);
         elif  (key_kod == 43)  //PLUS серый
               return on_scr_key_PLUS(sql, field, key_kod);
         elif  (key_kod == 45)  //MINUS серый
               return on_scr_key_MINUS(sql, field, key_kod);
         elif  (key_kod == 0)
               return on_scr_key_empty(sql, field, key_kod);
         elif  (key_kod == 18) //CTRL_R
               return on_scr_key_Ctrl_R(sql, field, key_kod);
         end;
      end; 
   
//   msgbox(event
//          ,"|DLG_KEY - ",dlg_Key
//          ,"|DLG_MOUSE - ",dlg_Mouse
//          ,"|DLG_DESTROY - ",dlg_destroy
//          ,"|DLG_save - ",dlg_save
//          ,"|DLG_outloop - ",dlg_outloop
//          ,"|DLG_inloop - ",dlg_inloop
//          ,"|DLG_preinit - ",dlg_preinit
//          ,"|DLG_init - ",dlg_init
//          ,"|DLG_setfocus - ",dlg_setfocus
//          ,"|DLG_remfocus - ",dlg_remfocus
//          ,"|DLG_inrec - ",dlg_inrec
//          ,"|DLG_outrec - ",dlg_outrec
//          ,"|Key_Kod - ",key_kod
//         );   
         
   end;

   macro Run (rs, X, Y, CX, CY)
   return RunScroll (rs, numCol, colInfo, scr_name, R2M(this,"EvProc"), title, st_line, scr_ronly, X, Y, CX, CY);
   end;

onerror(err);
   msgbox(err.Message);
   return false;
end;

// результат в таблицу скроллинга
private macro sav_err(p_Msg, p_Rwd)
   var sqls, rsdc;
   sqls = String( 
                  "BEGIN   \n"
                 ,"   UPDATE DBO_SPB_SEND_TMP t SET t.t_Message = t.t_Message || ' ' || Substr(:p_Err, 1, 200), t_Countsend = 0 WHERE t.ROWID = :p_Rwd;   \n"
                 ,"END;   \n"
                );
   rsdc = rsdcommand(sqls);
   rsdc.AddParam("p_Err", RSDBP_IN, p_Msg);
   rsdc.AddParam("p_Dlid", RSDBP_IN, p_Rwd);
   rsdc.execute;
onerror(e);
   rsdc = null;
end;
   

// сохранить код
private macro obj_code_save(p_Obj_Tp, p_Obj_Id, p_Cod_Kd, p_Cod_Vl, p_Cod_Dt)
   var sqls, rsdc;
   sqls = String( 
                  "DECLARE   \n"
                 ,"   v_Obj_Tp Dobjcode_Dbt.t_Objecttype%TYPE := :p_Obj_Tp;   \n"
                 ,"   v_Obj_Id Dobjcode_Dbt.t_Objectid%TYPE := :p_Obj_Id;   \n"
                 ,"   v_Cod_Kd Dobjcode_Dbt.t_Codekind%TYPE := :p_Cod_Kd;   \n"
                 ,"   v_Cod_Vl Dobjcode_Dbt.t_Code%TYPE := :p_Cod_Vl;   \n"
                 ,"   v_Cod_Dt Dobjcode_Dbt.t_Bankdate%TYPE := :p_Dat;   \n"
                 ,"   r_Cod    Dobjcode_Dbt%ROWTYPE;   \n"
                 ,"   r_Kcd    Dobjkcode_Dbt%ROWTYPE;   \n"
                 ,"   v_Res    PLS_INTEGER := 0;   \n"
                 ,"   v_Err    VARCHAR2(2000);   \n"
                 ,"   Ex_Er EXCEPTION;   \n"
                 ,"   Ex_Ok EXCEPTION;   \n"
                 ,"BEGIN   \n"
                 ,"   v_Cod_Dt := Coalesce(v_Cod_Dt, Rsbsessiondata.Curdate, Trunc(SYSDATE));   \n"
                 ,"   BEGIN   \n"
                 ,"      IF TRIM(TRIM(Chr(1) FROM v_Cod_Vl)) IS NULL THEN   \n"
                 ,"         v_Err := 'Пустое значение кода не сохраняется';   \n"
                 ,"         RAISE Ex_Er;   \n"
                 ,"      END IF;   \n"
                 ,"      -- Непредусмотренный вид кода для объекта   \n"
                 ,"      BEGIN   \n"
                 ,"         SELECT *   \n"
                 ,"           INTO r_Kcd   \n"
                 ,"           FROM Dobjkcode_Dbt c   \n"
                 ,"          WHERE c.t_Objecttype = v_Obj_Tp   \n"
                 ,"            AND c.t_Codekind = v_Cod_Kd;   \n"
                 ,"      EXCEPTION   \n"
                 ,"         WHEN No_Data_Found THEN   \n"
                 ,"            v_Err := 'Непредусмотренный вид кода ' || v_Cod_Kd || ' для данного вида объекта ' || v_Obj_Tp;   \n"
                 ,"            RAISE Ex_Er;   \n"
                 ,"      END;   \n"
                 ,"      CASE v_Obj_Tp   \n"
                 ,"         WHEN 3 THEN   \n"
                 ,"            SELECT COUNT(1)   \n"
                 ,"              INTO v_Res   \n"
                 ,"              FROM Dobjalcod_Dbt Alc   \n"
                 ,"             WHERE Alc.t_Objecttype = v_Obj_Tp   \n"
                 ,"               AND (Alc.t_Objectkind = 0 OR EXISTS   \n"
                 ,"                    (SELECT 1   \n"
                 ,"                       FROM Dpartyown_Dbt Pto   \n"
                 ,"                      WHERE Pto.t_Partyid = v_Obj_Id   \n"
                 ,"                        AND Pto.t_Partykind = Alc.t_Objectkind   \n"
                 ,"                        AND Pto.t_Subkind = Alc.t_Objsubkind));   \n"
                 ,"         WHEN 9 THEN   \n"
                 ,"            SELECT COUNT(1)   \n"
                 ,"              INTO v_Res   \n"
                 ,"              FROM Dobjalcod_Dbt Alc   \n"
                 ,"             WHERE Alc.t_Objecttype = v_Obj_Tp   \n"
                 ,"               AND (Alc.t_Objectkind = 0 OR EXISTS   \n"
                 ,"                    (SELECT 1   \n"
                 ,"                       FROM Dfininstr_Dbt Fi   \n"
                 ,"                      WHERE Fi.t_Fiid = v_Obj_Id   \n"
                 ,"                        AND Fi.t_Fi_Kind = Alc.t_Objectkind   \n"
                 ,"                        AND Alc.t_Objsubkind IN (Fi.t_Avoirkind, 0)));   \n"
                 ,"         ELSE   \n"
                 ,"            v_Res := 1;   \n"
                 ,"      END CASE;   \n"
                 ,"      IF v_Res <= 0 THEN   \n"
                 ,"         v_Err := 'Непредусмотренный вид кода ' || v_Cod_Kd || ' для данного подвида объекта ' || v_Obj_Tp;   \n"
                 ,"         RAISE Ex_Er;   \n"
                 ,"      END IF;   \n"
                 ,"      -- наличие действующего кода у объекта   \n"
                 ,"      IF r_Kcd.t_Duplicate = 'X' THEN   \n"
                 ,"         SELECT COUNT(1)   \n"
                 ,"           INTO v_Res   \n"
                 ,"           FROM Dobjcode_Dbt t   \n"
                 ,"          WHERE t.t_Objecttype = v_Obj_Tp   \n"
                 ,"            AND t.t_Objectid = v_Obj_Id   \n"
                 ,"            AND t.t_Codekind = v_Cod_Kd   \n"
                 ,"            AND t.t_Code = v_Cod_Vl   \n"
                 ,"            AND t.t_Bankdate <= v_Cod_Dt   \n"
                 ,"            AND (t.t_State = 0 OR t.t_Bankclosedate > v_Cod_Dt);   \n"
                 ,"         IF v_Res > 0 THEN   \n"
                 ,"            RAISE Ex_Ok;   \n"
                 ,"         END IF;   \n"
                 ,"      ELSE   \n"
                 ,"         SELECT COUNT(1)   \n"
                 ,"           INTO v_Res   \n"
                 ,"           FROM Dobjcode_Dbt t   \n"
                 ,"          WHERE t.t_Objecttype = v_Obj_Tp   \n"
                 ,"            AND t.t_Objectid = v_Obj_Id   \n"
                 ,"            AND t.t_Codekind = v_Cod_Kd   \n"
                 ,"            AND t.t_Bankdate <= v_Cod_Dt   \n"
                 ,"            AND (t.t_State = 0 OR t.t_Bankclosedate > v_Cod_Dt);   \n"
                 ,"         IF v_Res > 0 THEN   \n"
                 ,"            v_Err := 'Код типа ' || v_Cod_Kd || ' присутствует у объекта на указанную дату';   \n"
                 ,"            RAISE Ex_Er;   \n"
                 ,"         END IF;   \n"
                 ,"      END IF;   \n"
                 ,"      -- наличие подобного кода в базе кроме разрешенных индексом   \n"
                 ,"      IF NOT ((v_Obj_Tp = 3 AND v_Cod_Kd IN (16, 27, 12, 68)) OR (v_Obj_Tp = 9 AND v_Cod_Kd IN (18))) THEN   \n"
                 ,"         SELECT COUNT(1)   \n"
                 ,"           INTO v_Res   \n"
                 ,"           FROM Dobjcode_Dbt t   \n"
                 ,"          WHERE t.t_Objecttype = v_Obj_Tp   \n"
                 ,"            AND t.t_Codekind = v_Cod_Kd   \n"
                 ,"            AND t.t_Code = v_Cod_Vl   \n"
                 ,"            AND (t.t_State = 0 OR t.t_Bankclosedate > v_Cod_Dt);   \n"
                 ,"         IF v_Res > 0 THEN   \n"
                 ,"            v_Err := 'Код ' || v_Cod_Vl || ' принадлежит другому объекту';   \n"
                 ,"            RAISE Ex_Er;   \n"
                 ,"         END IF;   \n"
                 ,"      END IF;   \n"
                 ,"      r_Cod.t_Objecttype    := v_Obj_Tp;   \n"
                 ,"      r_Cod.t_Objectid      := v_Obj_Id;   \n"
                 ,"      r_Cod.t_Codekind      := v_Cod_Kd;   \n"
                 ,"      r_Cod.t_Code          := v_Cod_Vl;   \n"
                 ,"      r_Cod.t_State         := 0;   \n"
                 ,"      r_Cod.t_Bankdate      := v_Cod_Dt;   \n"
                 ,"      r_Cod.t_Sysdate       := Trunc(SYSDATE);   \n"
                 ,"      r_Cod.t_Systime       := To_Date('01010001 ' || To_Char(SYSDATE, 'HH24MISS'), 'DDMMYYYY HH24MISS');   \n"
                 ,"      r_Cod.t_Userid        := Rsbsessiondata.Oper;   \n"
                 ,"      r_Cod.t_Branch        := 0;   \n"
                 ,"      r_Cod.t_Numsession    := 0;   \n"
                 ,"      r_Cod.t_Unique        := Chr(88);   \n"
                 ,"      r_Cod.t_Autokey       := NULL;   \n"
//                 ,"      r_Cod.t_Bankclosedate := To_Date('31129999', 'DDMMYYYY');   \n"
                 ,"      r_Cod.t_Bankclosedate := To_Date('01010001', 'DDMMYYYY');   \n"
                 ,"      r_Cod.t_Normcode      := Chr(1);   \n"
                 ,"      INSERT INTO Dobjcode_Dbt VALUES r_Cod;   \n"
                 ,"   EXCEPTION   \n"
                 ,"      WHEN Ex_Ok THEN   \n"
                 ,"         v_Err := NULL;   \n"
                 ,"      WHEN OTHERS THEN   \n"
                 ,"         v_Err := Nvl(v_Err, Dbms_Utility.Format_Error_Stack || ' ' || Dbms_Utility.Format_Error_Backtrace);   \n"
                 ,"   END;   \n"
                 ,"   :p_Err := v_Err;   \n"
                 ,"END;   \n"
                );
   rsdc = rsdcommand(sqls);
   if ((p_Obj_Tp == null) or (p_Obj_Tp == nullval) or (p_Obj_Tp <= 0))
      return "Вид объекта не указан " + p_Obj_Tp;
   end;
   rsdc.AddParam("p_Obj_Tp", RSDBP_IN, p_Obj_Tp);
   if ((p_Obj_Id == null) or (p_Obj_Id == nullval) or (p_Obj_Id <= 0))
      return "Объект не указан " + p_Obj_Id;
   end;
   rsdc.AddParam("p_Obj_Id", RSDBP_IN, p_Obj_Id);
   if ((p_Cod_Kd == null) or (p_Cod_Kd == nullval) or (p_Cod_Kd <= 0))
      return "Вид кода не указан " + p_Cod_Kd;
   end;
   rsdc.AddParam("p_Cod_Kd", RSDBP_IN, p_Cod_Kd);
   if ((p_Cod_Kd == null) or (p_Cod_Kd == nullval) or (valtype(p_Cod_Vl) != v_String))
      return "Значение кода не указано " + p_Cod_Vl;
   end;
   rsdc.AddParam("p_Cod_Vl", RSDBP_IN, p_Cod_Vl);
   if ((p_Cod_Dt == null) or (p_Cod_Dt == nullval))
      p_Cod_Dt = "";
   end;
   rsdc.AddParam("p_Cod_Dt", RSDBP_IN, {Curdate}/*p_Cod_Dt*/);
   rsdc.AddParam("p_Err", RSDBP_OUT, v_string, 2000);
   rsdc.execute;                 
   sqls = rsdc.Value("p_Err");
   rsdc = null;
   if ((sqls != null) and (sqls != nullval))
      return sqls;
   end; 
   return "";             
onerror(e);
   rsdc = null;
   if ((e.Err != null) and (e.Err != nullval))
      return e.Err;
   else        
      return e.Message + " " + e.Module + " " + e.Line;
   end;           
end;
// открыть счета субдоговора
private macro Open_Accounts(p_contr, p_Curr, p_Date, p_Ctg)
   var FD = DL_SubContrFD(p_contr);
   var fi_rec, err_txt;
   
   macro Acc2Sfc(chp, acc, cur)
      var sqls, rsdc;
      record sfspi("sfspiins.rec");
      ClearRecord(sfspi); 
      
      sfspi.ServiceKind      = FD.GetSubContr.rec.servkind;
      sfspi.FeeType          = 0;
      sfspi.FeeNumber        = 0;
      sfspi.FIID             = cur;
      sfspi.Account          = acc;
      sfspi.Chapter          = chp;
      sfspi.Branch           = 0;
      sfspi.CorrAcc          = "";
      sfspi.BankCorrName     = "";
      sfspi.BankCorrCodeKind = 3;
      sfspi.BankCorrCode     = "";
      sfspi.BankCorrID       = -1;
      sfspi.NoAccept         = "";
      sqls = String( 
                     "BEGIN   \n"
                    ,"   SELECT Nvl(MAX(s.t_Order), 0) + 1   \n"
                    ,"     INTO :p_Ret   \n"
                    ,"     FROM Dsfssi_Dbt s   \n"
                    ,"    WHERE s.t_Objecttype = 659   \n"
                    ,"      AND s.t_Objectid = :p_Sfc;   \n"
                    ,"END;   \n"
                   );
      rsdc = rsdcommand(sqls);
      rsdc.AddParam("p_Ret", RSDBP_OUT, v_integer  );
      rsdc.AddParam("p_Sfc", RSDBP_IN, p_Contr);
      rsdc.execute;
      sfspi.Order            = rsdc.Value("p_Ret");
      rsdc = null;
      sfspi.CodeKind         = PTCK_CONTR;  
      sqls = String( 
                     "DECLARE   \n"
                    ,"   v_Prt Dparty_Dbt.t_Partyid%TYPE := :p_Prt;   \n"
                    ,"   v_Cdk Dobjcode_Dbt.t_Codekind%TYPE := :p_Cdk;   \n"
                    ,"   v_Nam Dparty_Dbt.t_Shortname%TYPE;   \n"
                    ,"   v_Inn Dobjcode_Dbt.t_Code%TYPE;   \n"
                    ,"   v_Cod Dobjcode_Dbt.t_Code%TYPE;   \n"
                    ,"BEGIN   \n"
                    ,"   BEGIN   \n"
                    ,"      SELECT Pt.t_Shortname, Oc.t_Code, Oc16.t_Code   \n"
                    ,"        INTO v_Nam, v_Cod, v_Inn   \n"
                    ,"        FROM Dparty_Dbt Pt   \n"
                    ,"        LEFT JOIN Dobjcode_Dbt Oc   \n"
                    ,"          ON (Oc.t_Objecttype = 3 AND Oc.t_Objectid = Pt.t_Partyid AND Oc.t_Codekind = v_Cdk AND Oc.t_State = 0)   \n"
                    ,"        LEFT JOIN Dobjcode_Dbt Oc16   \n"
                    ,"          ON (Oc16.t_Objecttype = 3 AND Oc16.t_Objectid = Pt.t_Partyid AND Oc16.t_Codekind = 16 AND Oc16.t_State = 0)   \n"
                    ,"       WHERE Pt.t_Partyid = v_Prt;   \n"
                    ,"   EXCEPTION   \n"
                    ,"      WHEN OTHERS THEN   \n"
                    ,"         NULL;   \n"
                    ,"   END;   \n"
                    ,"   :p_Nam := v_Nam;   \n"
                    ,"   :p_Cod := v_Cod;   \n"
                    ,"   :p_Inn := v_Inn;   \n"
                    ,"END;   \n"
                   );
      rsdc = rsdcommand(sqls);
      rsdc.AddParam("p_Prt", RSDBP_IN, FD.GetSubContr.rec.Partyid);
      rsdc.AddParam("p_Cdk", RSDBP_IN, sfspi.CodeKind);
      rsdc.AddParam("p_Nam", RSDBP_OUT, v_string, 500);
      rsdc.AddParam("p_Cod", RSDBP_OUT, v_string);
      rsdc.AddParam("p_Inn", RSDBP_OUT, v_string);
      rsdc.execute;
      sfspi.RecName = SQL_ConvTypeStr(rsdc.Value("p_Nam"));
      sfspi.Code = SQL_ConvTypeStr(rsdc.Value("p_Cod"));
      sfspi.INN = SQL_ConvTypeStr(rsdc.Value("p_Inn"));
      rsdc = null;
      sqls = String( 
                     "DECLARE   \n"
                    ,"   v_Dpt Dsfcontr_Dbt.t_Department%TYPE := :p_Dpt;   \n"
                    ,"   v_Cur Dfininstr_Dbt.t_Fiid%TYPE := :p_Cur;   \n"
                    ,"   v_Prt Dparty_Dbt.t_Partyid%TYPE;   \n"
                    ,"   v_Nam Dparty_Dbt.t_Shortname%TYPE;   \n"
                    ,"   v_Cod Dobjcode_Dbt.t_Code%TYPE;   \n"
                    ,"   v_Cdk Dobjcode_Dbt.t_Codekind%TYPE;   \n"
                    ,"BEGIN   \n"
                    ,"   \n"
                    ,"   BEGIN   \n"
                    ,"      SELECT Pt.t_Partyid   \n"
                    ,"            ,Pt.t_Shortname   \n"
                    ,"            ,CASE   \n"
                    ,"                WHEN v_Cur = 0 THEN   \n"
                    ,"                 Oc3.t_Code   \n"
                    ,"                ELSE   \n"
                    ,"                 Nvl(Oc6.t_Code, Oc3.t_Code)   \n"
                    ,"             END   \n"
                    ,"            ,CASE   \n"
                    ,"                WHEN v_Cur = 0 THEN   \n"
                    ,"                 Oc3.t_Codekind   \n"
                    ,"                ELSE   \n"
                    ,"                 Nvl(Oc6.t_Codekind, Oc3.t_Codekind)   \n"
                    ,"             END   \n"
                    ,"        INTO v_Prt, v_Nam, v_Cod, v_Cdk   \n"
                    ,"        FROM Ddp_Dep_Dbt t   \n"
                    ,"       INNER JOIN Dparty_Dbt Pt   \n"
                    ,"          ON (Pt.t_Partyid = t.t_Partyid)   \n"
                    ,"        LEFT JOIN Dobjcode_Dbt Oc3   \n"
                    ,"          ON (Oc3.t_Objecttype = 3 AND Oc3.t_Objectid = Pt.t_Partyid AND Oc3.t_Codekind = 3 AND Oc3.t_State = 0)   \n"
                    ,"        LEFT JOIN Dobjcode_Dbt Oc6   \n"
                    ,"          ON (Oc6.t_Objecttype = 3 AND Oc6.t_Objectid = Pt.t_Partyid AND Oc6.t_Codekind = 6 AND Oc6.t_State = 0)   \n"
                    ,"       WHERE t.t_Code = v_Dpt;   \n"
                    ,"   EXCEPTION   \n"
                    ,"      WHEN OTHERS THEN   \n"
                    ,"         NULL;   \n"
                    ,"   END;   \n"
                    ,"   :p_Prt := v_Prt;   \n"
                    ,"   :p_Nam := v_Nam;   \n"
                    ,"   :p_Cod := v_Cod;   \n"
                    ,"   :p_Cdk := v_Cdk;   \n"
                    ,"END;   \n"
                   );
      rsdc = rsdcommand(sqls);
      rsdc.AddParam("p_Dpt", RSDBP_IN, FD.GetSubContr.rec.Department);
      rsdc.AddParam("p_Cur", RSDBP_IN, cur);
      rsdc.AddParam("p_Prt", RSDBP_OUT, v_integer);
      rsdc.AddParam("p_Nam", RSDBP_OUT, v_string, 500);
      rsdc.AddParam("p_Cod", RSDBP_OUT, v_string);
      rsdc.AddParam("p_Cdk", RSDBP_OUT, v_integer);
      rsdc.execute;   
      sqls  = rsdc.Value("p_Prt");
      if ((sqls == null) or (sqls == nullval))
         sqls = -1;
      end;
      sfspi.BankID = sqls;
      sfspi.BankName = SQL_ConvTypeStr(rsdc.Value("p_Nam")); 
      sqls = rsdc.Value("p_Cdk");
      if ((sqls == null) or (sqls == nullval))
         sqls = -1;
      end;
      sfspi.BankCodeKind = sqls;  
      sfspi.BankCode = SQL_ConvTypeStr(rsdc.Value("p_Cod"));
      rsdc = null;
      if (p_ctg == CATEG_SUBCONTRACT)
         sfspi.ShortName        = "ДС клиента";
      elif (p_ctg == CATEG_SUBCONTRACT_COM)
         sfspi.ShortName        = "Расчеты по комиссии";
      else
         sfspi.ShortName        = sfspi.Order;
      end;
      sfspi.Description      = sfspi.ShortName;
      if (SFSaveSfSSI(p_contr, sfspi) != 0)
         return GetErrMsg();
      end;
      return "";
   onerror(e)          
      rsdc = null;
      return e.Message + " " + e.Module + " " + e.Line;
   end;

   macro open_Account(ctg, cur)
      record acc(account);
      ClearRecord(acc);
      if (false == FD.OpenAccount(ctg, NULL, NULL, acc, p_Date, cur.id, p_Date ))
         return "Ошибка при открытии счета по категории " + ctg + GetErrMsg();
      end;
      if (ctg == CATEG_SUBCONTRACT)   
         //привязка счета к договору  
         err_txt = Acc2Sfc(acc.Chapter, acc.Account, acc.Code_Currency, ctg);
      end;
      return err_txt;
   onerror (e)
      return e.Message + " " + e.Module + " " + e.Line;
   end;
   
   for (fi_Rec, p_Curr)
      //CATEG_SUBCONTRACT = "ДС клиента, ц/б"; // catnum = 201 
      err_txt = open_Account(CATEG_SUBCONTRACT, fi_rec);
      if (strlen(trim(err_txt)) > 0)
         return err_txt;
      end;
      //CATEG_SUBCONTRACT_COM     = "+РасчетыКомисс1"; // catnum = 5087
      err_txt = open_Account(CATEG_SUBCONTRACT_COM, fi_rec);
      if (strlen(trim(err_txt)) > 0)
         return err_txt;
      end;
      //CATEG_SUBCONTRACT_VU      = "ДС Клиента, ВУ"; // catnum = 531
      err_txt = open_Account(CATEG_SUBCONTRACT_VU, fi_rec);
      if (strlen(trim(err_txt)) > 0)
         return err_txt;
      end;
      //CATEG_SUBCONTRACT_VU_CALC = "ДС, Расч. с клиентом, ВУ"; // catnum = 533
      err_txt = open_Account(CATEG_SUBCONTRACT_VU_CALC, fi_rec);
      if (strlen(trim(err_txt)) > 0)
         return err_txt;
      end;
   end;   
   return err_txt;
end;
// создать договор
private macro crt_subcontr(p_Dlid, p_Sk, p_Ssk, p_Rwd)
   var sqls, rsdc, fi_lst, fi_rec, err_txt = "", obj_cat, obj_not;
   var v_Is_Open = 0, v_res = 0, v_Sf_Prt = 0, v_Mp_Iis = 0, v_Mp_Ekk = "", v_Mp_eks = false, v_Mp_Beg ;
   var DlContrMp = TRecHandler("dlcontrsubprm.rec");
   //
   class TFI_Struct(p_fi_id, p_fi_code, p_fi_ccy, p_fi_name)
      var id = p_Fi_id;
      var code = p_Fi_code;
      var ccy = p_Fi_ccy;
      var name = p_Fi_name;   
   end;
   // получить список валют
   macro get_fi_lst(p_Val)
      var sqls, rsdc, rsds;
      if ((p_val == null) or (p_val == nullval) or (strlen(trim(p_Val)) == 0))
         p_val = fi_list_send;
      end;
      fi_lst = Tarray;
      sqls = String( 
                     "WITH Prm AS   \n"
                    ," (SELECT :p_Val v_Val FROM Dual),   \n"
                    ,"Lst AS   \n"
                    ," (SELECT TRIM(Regexp_Substr(v_Val, '[^,]+', 1, LEVEL)) Val   \n"
                    ,"    FROM Prm   \n"
                    ,"  CONNECT BY Regexp_Substr(v_Val, '[^,]+', 1, LEVEL) IS NOT NULL)   \n"
                    ,"SELECT Fi.t_Fiid, Lst.Val t_Fi_Code, Fi.t_Ccy, Fi.t_Name FROM Lst LEFT JOIN Dfininstr_Dbt Fi ON Fi.t_Fi_Code = Lst.Val   \n"
                   );
      rsdc = rsdcommand(sqls);
      rsdc.AddParam("p_val", RSDBP_IN, p_val);
      rsds = rsdrecordset(rsdc, RSDVAL_CLIENT_IF_NEEDED, RSDVAL_FORWARD_ONLY);
      rsds.Open;
      while (rsds.MoveNext)
         if ((rsds.Value("t_Fiid") == null) or (rsds.Value("t_Fiid") == nullval))
            rsds.Value("t_Fiid") = -1;
            runerror(rsds.Value("t_Fi_Code") + " неизвестный код валюты");
         end; 
         if ((rsds.Value("t_Ccy") == null) or (rsds.Value("t_Ccy") == nullval))
            rsds.Value("t_Ccy") = "???";
         end; 
         if ((rsds.Value("t_Name") == null) or (rsds.Value("t_Name") == nullval))
            rsds.Value("t_Name") = "Неизвестный код валюты";
         end; 
         fi_lst[fi_lst.Size] = TFI_Struct(rsds.Value("t_Fiid"), rsds.Value("t_Fi_Code"), rsds.Value("t_Ccy"), rsds.Value("t_Name"));
      end;
      rsds.Close;
      rsds = null;
      rsdc = null;
      return "";
   onerror(e);
      rsds = null;
      rsdc = null;
      fi_lst = Tarray;
      return e.Message + " " + e.Module + " " + e.Line;
   end;      
   // обновление ДО
   macro Update_Sfcontr(p_sfi, p_par, p_mpc, p_mpd)
      var sqls, rsdc;
      sqls = String( 
                     "BEGIN   \n"
                    ,"   UPDATE Dsfcontr_Dbt SET t_Paymethod = :p_Par WHERE t_Id = :p_Sfi;   \n"
                    ,"END;   \n"
                   );
      rsdc = rsdcommand(sqls);
      rsdc.AddParam("p_Par", RSDBP_IN, p_par);
      rsdc.AddParam("p_Sfi", RSDBP_IN, p_sfi);
      rsdc.AddParam("p_Mpc", RSDBP_IN, p_Mpc);
      rsdc.AddParam("p_Mpd", RSDBP_IN, p_Mpd);
      rsdc.AddParam("p_Sfm", RSDBP_IN, p_sfi);
      rsdc.execute;       
      rsdc = null;
   onerror(e);
         rsdc = null;
   end;
   //отключить открытие договоров     
   //return true;
   err_txt = get_fi_Lst(fi_list_send);
   if (strlen(trim(err_txt)) > 0)
      sav_err(err_txt, p_Rwd);
      return false;
   end;

   //Получить информацию о ЕДП
   var EDP = False;
   var sql_edp = string ("SELECT * \n"
                         ,"   FROM dsfcontr_dbt sfc \n"
                         ,"  WHERE     sfc.t_servkindsub = 8 \n"
                         ,"        AND sfc.t_id IN (SELECT dlc.t_sfcontrid \n"
                         ,"                           FROM ddlcontrmp_dbt dlc \n"
                         ,"                          WHERE dlc.t_dlcontrid = :pDlID) \n"
                         ,"        AND EXISTS                                        \n"
                         ,"               (SELECT 1                                  \n"
                         ,"                  FROM dobjatcor_dbt                      \n"
                         ,"                 WHERE     t_objecttype = 659             \n"
                         ,"                       AND t_groupid = 102                \n"
                         ,"                       AND t_attrid = 1                   \n"
                         ,"                       AND t_object = LPAD (sfc.t_id, 10, '0'))\n"  );
    var cmd_edp = RSDCommand(sql_edp);
         cmd_edp.AddParam("pDlID", rsdbp_in, p_Dlid);
    var rs_edp = RSDRecordset(cmd_edp, rsdval_client, rsdval_static) ;
    if(rs_edp.MoveNext())
       EDP = True;
    end;

   // получить данные для договора
   sqls = String( 
                  "DECLARE   \n"
                 ,"   v_Dli    Ddlcontr_Dbt.t_Dlcontrid%TYPE := :p_Dli;   \n"
                 ,"   v_Sk     PLS_INTEGER := :p_Sk;   \n"
                 ,"   v_Ssk    PLS_INTEGER := :p_Ssk;   \n"
                 ,"   v_Mp_Iis PLS_INTEGER := 0;   \n"
                 ,"   v_Sf_Trf Dsfcontrplan_Dbt.t_Sfplanid%TYPE;   \n"
                 ,"   r_Sfc    Dsfcontr_Dbt%ROWTYPE;   \n"
                 ,"   r_Dlp    Ddlcontrmp_Dbt%ROWTYPE;   \n"
                 ,"   v_Is_Opn PLS_INTEGER;   \n"
                 ,"   v_Res    PLS_INTEGER;   \n"
                 ,"   Ex_Er EXCEPTION;   \n"
                 ,"   Ex_Ok EXCEPTION;   \n"
                 ,"   v_Err VARCHAR2(2000);   \n"
                 ,"BEGIN   \n"
                 ,"   BEGIN   \n"
                 ,"      -- наличие договора для вида обслуживания   \n"
                 ,"      SELECT COUNT(1)   \n"
                 ,"        INTO v_Is_Opn   \n"
                 ,"        FROM Ddlcontrmp_Dbt Dlp   \n"
                 ,"       INNER JOIN Dsfcontr_Dbt Sf   \n"
                 ,"          ON (Sf.t_Id = Dlp.t_Sfcontrid)   \n"
                 ,"       WHERE Dlp.t_Dlcontrid = v_Dli   \n"
                 ,"         AND Sf.t_Servkind = v_Sk   \n"
                 ,"         AND Sf.t_Servkindsub = v_Ssk AND DLP.T_MARKETID = " + SPBCode +" ;   \n"
                 ,"      IF v_Is_Opn > 0 THEN   \n"
                 ,"         RAISE Ex_Ok;   \n"
                 ,"      END IF;   \n"
                 ,"      -- данные договора   \n"
                 ,"      SELECT Sf.t_Partyid, Substr(Pt.t_Name, 1, 100), Sf.t_Number, Oc.t_Code, Decode(Dl.t_Iis, Chr(88), 1, 0), Sf.t_Datebegin    \n"
                 ,"        INTO r_Sfc.t_Partyid, r_Sfc.t_Name, r_Sfc.t_Number, r_Dlp.t_Mpcode, v_Mp_Iis, r_Sfc.t_Datebegin   \n"
                 ,"        FROM Ddlcontr_Dbt Dl   \n"
                 ,"       INNER JOIN Dsfcontr_Dbt Sf   \n"
                 ,"          ON (Sf.t_Id = Dl.t_Sfcontrid)   \n"
                 ,"       INNER JOIN Dparty_Dbt Pt   \n"
                 ,"          ON (Pt.t_Partyid = Sf.t_Partyid)   \n"
                 ,"        LEFT JOIN Dobjcode_Dbt Oc   \n"
                 ,"          ON (Oc.t_Objecttype = 207 AND Oc.t_Codekind = 1 AND Oc.t_Objectid = Dl.t_Dlcontrid AND Oc.t_State = 0)   \n"
                 ,"       WHERE Dl.t_Dlcontrid = v_Dli;   \n"
                 ,"      -- тарифный план   \n"
                 ,"      BEGIN   \n"
                 ,"         SELECT t.t_Sfplanid INTO v_Sf_Trf FROM Dsfplan_Dbt t WHERE Upper(t.t_Name) = 'БАЗОВЫЙ';   \n"
                 ,"      EXCEPTION   \n"
                 ,"         WHEN OTHERS THEN   \n"
                 ,"            v_Sf_Trf := 0;   \n"
                 ,"      END;   \n"
                 ,"   EXCEPTION   \n"
                 ,"      WHEN Ex_Ok THEN   \n"
                 ,"         v_Err := NULL;   \n"
                 ,"      WHEN No_Data_Found THEN   \n"
                 ,"         v_Err := 'Ошибка получения данных по договору Брокерского обслуживания ID=' || v_Dli;   \n"
                 ,"      WHEN OTHERS THEN   \n"
                 ,"         v_Err := Nvl(v_Err, Dbms_Utility.Format_Error_Stack || ' ' || Dbms_Utility.Format_Error_Backtrace);   \n"
                 ,"   END;   \n"
                 ,"   :p_Err    := v_Err;   \n"
                 ,"   :p_Is_Opn := v_Is_Opn;   \n"
                 ,"   :p_Sf_Nam := r_Sfc.t_Name;   \n"
                 ,"   :p_Sf_Nmb := r_Sfc.t_Number;   \n"
                 ,"   :p_Sf_Prt := r_Sfc.t_Partyid;   \n"
                 ,"   :p_Sf_Beg := r_Sfc.t_Datebegin;   \n"
                 ,"   :p_Sf_Trf := v_Sf_Trf;   \n"
                 ,"   :p_Mp_Cod := r_Dlp.t_Mpcode;   \n"
                 ,"   :p_Mp_Iis := v_Mp_Iis;   \n"
                 ,"END;   \n"
                );
   rsdc = rsdcommand(sqls);
   rsdc.AddParam("p_Dli", RSDBP_IN, p_dlid);
   rsdc.AddParam("p_Sk",  RSDBP_IN, p_Sk);
   rsdc.AddParam("p_Ssk", RSDBP_IN, p_Ssk);
   rsdc.AddParam("p_Err", RSDBP_out, v_String, 2000);
   rsdc.AddParam("p_Is_Opn", RSDBP_out, v_integer);
   rsdc.AddParam("p_Sf_Nam", RSDBP_out, v_string, 200);
   rsdc.AddParam("p_Sf_Nmb", RSDBP_out, v_string);
   rsdc.AddParam("p_Sf_Prt", RSDBP_out, v_integer);
   rsdc.AddParam("p_Sf_Beg", RSDBP_out, v_date);
   rsdc.AddParam("p_Sf_Trf", RSDBP_out, v_integer);
   rsdc.AddParam("p_Mp_Cod", RSDBP_out, v_string);
   rsdc.AddParam("p_Mp_Iis", RSDBP_out, v_integer);
   rsdc.execute;
   sqls = rsdc.Value("p_Err");
   if ((sqls != null) and (sqls != nullval))
      runerror("Ошибка получения данных для создания договора ", string("Ошибка получения данных для создания договора ", sqls));
   end;
   if (int(rsdc.Value("p_Is_Opn")) > 0)
      rsdc = null;
//      sav_err("", p_Rwd);
      return false;
   end;
   DlContrMp.Clear;
   DlContrMp.rec.SERVKIND   = p_Sk;
   DlContrMp.rec.SUBKIND    = p_Ssk;
   DlContrMp.rec.ROLE       = 2;                //Роль ПУРЦБ
   DlContrMp.rec.MPREGDATE  = {curdate};        //Дата регистрации клиента на площадке
   DlContrMp.rec.DATECONC   = {curdate};        //Дата заключения
   DlContrMp.rec.DATEBEGIN  = {curdate};        //Дата начала
   DlContrMp.rec.NAME       = SQL_ConvTypeStr(rsdc.Value("p_Sf_Nam"));
   DlContrMp.rec.NUMBER     = SQL_ConvTypeStr(rsdc.Value("p_Sf_Nmb"))+"_s";
   DlContrMp.rec.SFPLANID   = int(rsdc.Value("p_Sf_Trf"));
   DlContrMp.rec.MarketID   = SPBCode;

   v_Sf_Prt = int(rsdc.Value("p_Sf_Prt"));
   v_Mp_Iis = int(rsdc.Value("p_Mp_Iis"));
   
   v_Mp_Ekk = uGetPersonalCodeSub( rsdc.Value("p_Sf_Nmb"));

   v_Mp_Beg = rsdc.Value("p_Sf_Beg");
   rsdc = null;
   if (p_Sk == 15) 
      DlContrMp.rec.NUMBER = string(DlContrMp.rec.NUMBER, "_s");
   end;   
   if ((v_Mp_Ekk == null) or (v_Mp_Ekk == nullval))
      v_Mp_Ekk = "";
   end;
   //
   // создание договора
   //                    

   RslDefCon.BeginTrans();                   
   //Код в номере счета
   v_res = GenerateReference(127, DlContrMp.rec.ACCCODE);
   if (v_res != 0)
      runerror("Ошибка получения данных для создания договора ", string("Ошибка генерации кода в номере счета ", GetErrMsg()));
   end;
   PT_BindClientWithBranch(v_Sf_Prt, p_Sk, {OperDprt});           // поставить субъекта на обслуживание
   v_mp_Eks = True;
   if (v_mp_Eks)                                                  // сохранить код биржы
      err_txt = obj_code_save(207, p_dlid, 2, v_Mp_Ekk, v_Mp_Beg);
      if (strlen(trim(err_txt)) > 0)
         RunError(err_txt, err_txt);
      end;      
   end;
   if (strlen(trim(v_Mp_Ekk)) == 0)
      // кода нет, надо генерировать
      v_Mp_eks = true;
      v_Mp_Ekk = GeneratePersonalCode(v_Sf_Prt, (v_Mp_Iis > 0), false, false);
      if (strlen(trim(v_Mp_Ekk)) == 0)
         runerror("Ошибка получения данных для создания договора ", string("Ошибка генерации кода Биржи", GetErrMsg()));
      end;
      if ((p_Sk == 21) and (substr(v_Mp_Ekk, 1, 2) != "CU"))
     DlContrMp.rec.MPCODE = string("CU", v_Mp_Ekk);
      end;  
   else
      DlContrMp.rec.MPCODE = v_Mp_Ekk;
      if ((p_Sk == 21) and (substr(DlContrMp.rec.MPCODE, 1, 2) != "CU"))
         DlContrMp.rec.MPCODE = string("CU", DlContrMp.rec.MPCODE);
      end;   
   end;
   // сохранить данные субдоговора, чтобы потом исправить в таблице
   v_Mp_Ekk = DlContrMp.rec.MPCODE;
   v_Mp_Beg = DlContrMp.rec.MPREGDATE;
   v_res = DL_AddSubContrToDLCONTR(p_dlid, DlContrMp, err_txt);   // создать договор
   if (v_res != 0)
      RunError(err_txt, err_txt);
   end;
   Update_Sfcontr(DlContrMp.rec.sfcontrid, 1, v_Mp_Ekk, v_Mp_Beg);  // исправление в ДО
   // добавить категории на ДО
   if (v_Mp_Iis > 0)
      // Договор ИИС
      obj_cat = RsbObjCategories(659, string(DlContrMp.rec.sfcontrid:o));
      v_res = Obj_Cat.ConnectAttr(3, 1, null, null, date());
      if (v_res > 0)
         err_txt = String("Ошибка " + v_res + " установки категории 'Договор ИИС', значение ", 1);
         RunError(err_txt, err_txt);
      end;
   end;   
   obj_not = RsbObjNotes(659, string(DlContrMp.rec.sfcontrid:10:o));
   v_res = obj_not.AddNote(102, "RUB", date());
   obj_not.Save();
   if (strlen(trim(err_txt)) > 0)
      RunError(err_txt, err_txt);
   end;      
   if (RslDefCon.IsInTrans())
      RslDefCon.CommitTrans();
   end;        
   // открыть счета

  var fi_arr = TArray;
  fi_arr[0] = 0;
  fi_arr[1] = 7;
  fi_arr[2] = 8;
  fi_arr[3] = 19;
  var st_edp;    

  if(EDP)
    //  ставим категорию едп 
    var  ObjCat = RsbObjCategories(659, string(DlContrMp.rec.sfcontrid:o:10));
         st_edp = ObjCat.ConnectAttr(102, 1, NULL, NULL, {curdate} );
         if(st_edp == 0)
           st_edp = ObjCat.Save(string(DlContrMp.rec.sfcontrid:o:10));
         end;
  end;

  var j =  fi_arr.size;
  var i = 0;

  while (i < j )
//   OpenAccAndBindToContract("ДС клиента, ц/б", DlContrMp.rec.sfcontrid, fi_arr[i], "", err_txt, DlContrMp.rec.DATEBEGIN);
//   if (strlen(trim(err_txt)) > 0)
//      RunError(err_txt, err_txt);
//   end;      
   ReOpenAccAndBindToContract(CATEG_SUBCONTRACT, DlContrMp.rec.sfcontrid, fi_arr[i], "", err_txt, DlContrMp.rec.DATEBEGIN);
   if (strlen(trim(err_txt)) > 0)
      RunError(err_txt, err_txt);
   end;
   ReOpenAccAndBindToContract(CATEG_SUBCONTRACT_COM, DlContrMp.rec.sfcontrid, fi_arr[i], "", err_txt, DlContrMp.rec.DATEBEGIN);
   if (strlen(trim(err_txt)) > 0)
      RunError(err_txt, err_txt);
   end;
   ReOpenAccAndBindToContract(CATEG_SUBCONTRACT_VU, DlContrMp.rec.sfcontrid, fi_arr[i], "", err_txt, DlContrMp.rec.DATEBEGIN);
   if (strlen(trim(err_txt)) > 0)
      RunError(err_txt, err_txt);
   end;      
   ReOpenAccAndBindToContract(CATEG_SUBCONTRACT_VU_CALC, DlContrMp.rec.sfcontrid, fi_arr[i], "", err_txt, DlContrMp.rec.DATEBEGIN);
   if (strlen(trim(err_txt)) > 0)
      RunError(err_txt, err_txt);
   end;






   i = i + 1;
  end;

   return true;
onerror(e)
   rsdc = null;
   if (RslDefCon.IsInTrans())
      RslDefCon.RollbackTrans();
   end;                  
   if ((e.Err != null) and (e.Err != nullval))
      sav_err(e.Err, p_Rwd);
   else        
      sav_err(e.Message + " " + e.Module + " " + e.Line, p_Rwd);
   end;           
   return false;
end;

class (TRslScroll) TMsgScroll_Send
   var fl_end = false, v_lin = 0;

   macro CheckTable_SPB_SEND();
     var cmd;
       StartCaptureOutput();
     [
           DECLARE
              retval    NUMBER := 0;
              sql_crt   VARCHAR2 (1000);
              sql_clr   VARCHAR2 (1000);
           BEGIN
              sql_crt :=
                    'CREATE TABLE DBO_SPB_SEND_TMP AS SELECT * from Dbo_Message_Tmp where 1 != 1 ';
              sql_clr := 'truncate table DBO_SPB_SEND_TMP';

              SELECT COUNT (1)
                INTO retval
                FROM user_tables
               WHERE UPPER (table_name) = 'DBO_SPB_SEND_TMP';

              IF retval = 0
              THEN
                 EXECUTE IMMEDIATE (sql_crt);
              END IF;

           END;];

        cmd = RSDCommand(EndCaptureOutput());
        cmd.execute();
   end;

   macro sel_contr()
   CheckTable_SPB_SEND();
   if (not gettrue(false, "Обновить данные временной таблицы?"))
      return true;
   end;
     var spb_send_rs = RSDRecordset("Select count(1) as in_progress from Dbo_spb_send_Tmp where t_countsend != 0 or t_message is not  null");
         if(     (spb_send_rs)
             and (spb_send_rs.movenext) 
             and (spb_send_rs.value("in_progress") > 0) 
             and (not gettrue(false, "В таблице есть данные обработки.\n Вы действительно хотите очистить и заполнить ее заново?\n Текущие данные будут удалены.")))
            return true;
         end;
   //return true;
   var sqls, rsdc;
   sqls = String( 
                  "DECLARE   \n"
                 ,"   v_Msg DBO_SPB_SEND_TMP.t_Message%TYPE;   \n"
                 ,"   v_Err VARCHAR2(2000);   \n"
                 ,"BEGIN   \n"
                 ,"   DELETE FROM DBO_SPB_SEND_TMP;   \n"
                 ,"   INSERT INTO DBO_SPB_SEND_TMP   \n"
                 ,"      (t_Dlid   \n"
                 ,"      ,t_Name   \n"
                 ,"      ,t_Partyid   \n"
                 ,"      ,t_Number   \n"
                 ,"      ,t_Datebegin   \n"
                 ,"      ,t_Avrexch_spb     \n"
                 ,"      ,t_State   \n"
                 ,"      ,t_Email   \n"
                 ,"      ,t_Countsend   \n"
                 ,"      ,t_Resend   \n"
                 ,"      ,t_EDP   \n"
//                 ,"      ,t_SPB_allow \n"
                 ,"      ,t_Client_Booking  \n"
                 ,"      ,t_Client_Online, t_SPB_Send, t_depo_spb, t_dias_upload)    \n"
                 ,"      SELECT Dl.t_Dlcontrid   \n"
                 ,"            ,Sfn.t_Name   \n"
                 ,"            ,Sfn.t_Partyid   \n"
                 ,"            ,Sfn.t_Number   \n"
                 ,"            ,Sfn.t_Datebegin   \n"
                 ,"         ,Decode((SELECT COUNT(1)   \n"
                 ,"                       FROM Ddlcontrmp_Dbt Dlp   \n"
                 ,"                      INNER JOIN Dsfcontr_Dbt Sf   \n"
                 ,"                         ON (Sf.t_Id = Dlp.t_Sfcontrid)   \n"
                 ,"                      WHERE Dlp.t_Dlcontrid = Dl.t_Dlcontrid   \n"
                 ,"                        AND Sf.t_Servkind = 1   \n"
                 ,"                        AND Sf.t_Servkindsub = 8 and Dlp.t_marketid =  "+SPBCode+")   \n"
                 ,"                    ,0   \n"
                 ,"                    ,Chr(0)   \n"
                 ,"                    ,Chr(88)) Avrexch_spb                 \n"
                 ,"            ,(SELECT Atr.t_Name   \n"
                 ,"                FROM Dobjatcor_Dbt Atc   \n"
                 ,"               INNER JOIN Dobjattr_Dbt Atr   \n"
                 ,"                  ON (Atr.t_Objecttype = Atc.t_Objecttype AND Atc.t_Groupid = Atr.t_Groupid AND   \n"
                 ,"                     Atc.t_Attrid = Atr.t_Attrid)   \n"
                 ,"               WHERE Atc.t_Objecttype = 207   \n"
                 ,"                 AND Atc.t_Groupid = 101   \n"
                 ,"                 AND SYSDATE BETWEEN Atc.t_Validfromdate AND Atc.t_Validtodate   \n"
                 ,"                 AND Atc.t_Object = Lpad(Dl.t_Dlcontrid, 34, '0')) t_State   \n"
                 ,"            ,Dl.t_Email   \n"
                 ,"            ,0 t_Countsend   \n"
                 ,"            ,Chr(0) t_Resend   \n"
                 ,"            ,Decode( (SELECT count(1)  \n"
                 ,"                      FROM dsfcontr_dbt s, dobjatcor_dbt a  \n"
                 ,"                       WHERE     s.t_servkindsub = 8  \n"
                 ,"                        AND a.t_objecttype = 659  \n"
                 ,"                        AND a.t_groupid = 102  \n"
                 ,"                        AND a.t_attrid = 1  \n"
                 ,"                        AND a.t_object = LPAD (s.t_id, 10, '0')  \n"
                 ,"                        AND s.t_id IN (SELECT t_sfcontrid  \n"
                 ,"                                         FROM ddlcontrmp_dbt  \n"
                 ,"                                        WHERE t_dlcontrid = Dl.t_Dlcontrid))  \n"
                 ,"                     ,0   \n"
                 ,"                     ,chr(0)  \n"
                 ,"                     ,chr(88)) EDP  \n"
 //                ,"             ,Decode((SELECT count(1)  \n"
 //                ,"               FROM dnotetext_dbt nt  \n"
 //                ,"              WHERE     nt.t_objecttype = 3  \n"
 //                ,"                    AND nt.t_notekind = 88  \n"
 //                ,"                    AND nt.t_documentid = LPAD (Sfn.t_Partyid, 10, '0')  \n"
 //                ,"                    AND instr (upper(UTL_RAW.CAST_TO_VARCHAR2 (nt.t_text)),'ДА') > 0)  \n"
 //                ,"                    , 0  \n"
 //                ,"                    ,chr(0)  \n"
 //                ,"                    ,chr(88)) SPB_Allow  \n"
                 ,"            ,decode( (SELECT COUNT (1)  \n"
                 ,"              FROM ddlcontrmsg_dbt contrmsg  \n"
                 ,"             WHERE     contrmsg.t_dlcontrid = Dl.t_Dlcontrid  \n"
                 ,"                   AND contrmsg.t_kind = 9  \n"
                 ,"                   AND contrmsg.T_SENDMESSTATE = 310  \n"
                 ,"                   AND contrmsg.t_marketid = "+SPBCode+")  \n"
                 ,"                   ,0  \n"
                 ,"                   ,chr(0)  \n"
                 ,"                   ,chr(88)) Client_Booking  \n"
                 ,"            ,decode( (SELECT COUNT (1)  \n"
                 ,"              FROM ddlcontrmsg_dbt contrmsg  \n"
                 ,"             WHERE     contrmsg.t_dlcontrid = Dl.t_Dlcontrid  \n"
                 ,"                   AND contrmsg.t_kind = 2  \n"
                 ,"                   AND contrmsg.T_SENDMESSTATE = 310  \n"
                 ,"                   AND contrmsg.t_marketid = "+SPBCode+")  \n"
                 ,"                   ,0  \n"
                 ,"                   ,chr(0)  \n"
                 ,"                   ,chr(88)) Client_Online  \n"
                 ,"      ,DECODE (                                           \n"
                 ,"          (SELECT COUNT (1)                               \n"
                 ,"             FROM USPBAPROVCONTR_DBT spbapr               \n"
                 ,"            WHERE     spbapr.t_sfcontrid = DL.T_SFCONTRID \n"
                 ,"                  AND spbapr.t_is_send = CHR (88)),       \n"
                 ,"          0, CHR (0),                                     \n"
                 ,"          CHR (88))                                       \n"
                 ,"          SBP_Send                                        \n"
                 ,"        ,DECODE (                                                 \n"
                 ,"            (SELECT COUNT (1)                                     \n"
                 ,"               FROM dnotetext_dbt                                 \n"
                 ,"              WHERE     t_objecttype = 207                        \n"
                 ,"                    AND t_notekind = 115                          \n"
                 ,"                    AND t_documentid = LPAD (Dl.t_Dlcontrid , 34, '0')),   \n"
                 ,"            0, CHR (0),                                           \n"
                 ,"            CHR (88)) t_depo_SPB                                  \n"
                 ,"        ,DECODE (                                                 \n"
                 ,"            (SELECT COUNT (1)                                     \n"
                 ,"             FROM USPBAPROVCONTR_DBT spbapr                       \n"
                 ,"            WHERE     spbapr.t_sfcontrid = DL.T_SFCONTRID         \n"
                 ,"                  AND spbapr.t_is_upload = CHR (88)),             \n"
                 ,"            0, CHR (0),                                           \n"
                 ,"            CHR (88)) t_Dias_upload                               \n"   
                 ,"        FROM Ddlcontr_Dbt Dl  inner join  uSPBAprovContr_dbt spb   on (spb.t_sfcontrid = DL.T_SFCONTRID) \n"
                 ,"       INNER JOIN Dsfcontr_Dbt Sfn   \n"
                 ,"          ON (Sfn.t_Id = Dl.t_Sfcontrid) where sfn.t_partyid <> 1 and (sfn.t_dateclose = to_date('01010001','ddmmyyyy')or sfn.t_dateclose > :dateclose);   \n"
                 ,"   COMMIT;   \n"
                 ,"EXCEPTION   \n"
                 ,"   WHEN OTHERS THEN   \n"
                 ,"      ROLLBACK;   \n"
                 ,"      :p_Err := v_Err;   \n"
                 ,"END;   \n"
                );
   rsdc = rsdcommand(sqls);
   rsdc.AddParam("p_Err", RSDBP_OUT, v_string, 2000);
   rsdc.AddParam("p_DateClose", RSDBP_in,{Curdate});
   rsdc.execute;
   if (not rsdc)        
      runerror("Ошибка получения списка договоров");
   end;
   sqls = rsdc.Value("p_Err");
   if ((sqls != null) and (sqls != nullval))
      runerror("Ошибка получения данных по договору", sqls);
   end;    
   rsdc = null;
   return true;   
   onerror(e)                                            
      rsdc = null;
      if ((e.Err != null) or (e.Err != nullval))
         msgbox(e.Err);
      else 
         msgbox(e.Message + " " + e.Module + " " + e.Line);
      end;                
      return false;
   end;

   macro clear_ds
   var sqls, rsdc;
   rsdc = rsdcommand("BEGIN DELETE FROM DBO_SPB_SEND_TMP; COMMIT; END;");
   rsdc.execute;
   rsdc = null;
   end;
   
   macro create_DS
   var sqls, rsdc, rsds, rsdu;
   sqls = String( "SELECT t_Dlid   \n"
                 ,"      ,t_Number   \n"
                 ,"      ,t_Name   \n"
                 ,"      ,t_State   \n"
                 ,"      ,t_Message   \n"
                 ,"      ,t_EDP   \n"
 //                ,"      ,t_SPB_Allow \n"
                 ,"      ,t_Client_Booking  \n"
                 ,"      ,t_Client_Online  \n"
                 ,"      ,t_dias_upload    \n"
                 ,"      ,t_Depo_SPB       \n"
                 ,"      , t_SPB_Send   \n"
                 ,"      ,t_Avrexch_SPB   \n"
                 ,"      ,t_Datebegin   \n"
                 ,"      ,t_Email   \n"
                 ,"      ,t_Countsend   \n"
                 ,"      ,case when t_edp = chr(88) then 'обработка завершена' else decode (t_Countsend,0, '','обрабатывается (Поток '||t_Countsend ||')') end t_status_work    \n"
                 ,"      ,t_Partyid   \n"
                 ,"      ,ROWID rwd   \n"
                 ,"  FROM DBO_SPB_SEND_TMP where t_Avrexch_SPB = chr(88)  \n"
                 ," ORDER BY t_Client_Online desc ,t_dias_upload desc, t_Depo_SPB desc, t_SPB_send desc, t_Datebegin DESC  \n"
                );
   rsdc = rsdcommand(sqls);
   rsds = rsdrecordset(rsdc, RSDVAL_CLIENT, RSDVAL_STATIC);
   rsdu = rsdcommand("BEGIN UPDATE DBO_SPB_SEND_TMP l SET l.t_Countsend = :p_Sel WHERE l.Rowid = :p_Rwd; END;");
   rsdu.AddUserCmdParam("p_Sel", "t_Countsend", RSDRVER_NEWVAL);
   rsdu.AddUserCmdParam("p_Rwd", "Rwd", RSDRVER_OLDVAL);
   rsds.UpdateCommand = rsdu;
   rsds.Open;
   return rsds;
   onerror(e)                                            
      rsdc = null;
      msgbox(e.Message + " " + e.Module + " " + e.Line);
      return null;
   end;        

   macro upd_line(p_dli)
   var sqls, rsdc;
      
   sqls = String( 
                  "DECLARE   \n"
                 ,"   v_Dli VARCHAR2(50) := :p_Dli;   \n"
                 ,"BEGIN   \n"
                 ,"   UPDATE DBO_SPB_SEND_TMP t  \n"
                 ,"      SET (t_Name   \n"
                 ,"         ,t_Partyid   \n"
                 ,"         ,t_Number   \n"
                 ,"         ,t_Datebegin   \n"
                 ,"         ,t_Avrexch_spb   \n"
                 ,"         ,t_State   \n"
                 ,"         ,t_Email   \n"
                 ,"         ,t_Countsend   \n"
                 ,"         ,t_Resend    \n"
                 ,"         ,t_EDP  \n"
//                 ,"         ,t_SPB_Allow  \n"
                 ,"         ,t_Client_Booking  \n"
                 ,"         ,t_Client_Online, t_SPB_Send, t_depo_spb, t_dias_upload) =   \n"
                 ,"          (SELECT Sfn.t_Name   \n"
                 ,"                 ,Sfn.t_Partyid   \n"
                 ,"                 ,Sfn.t_Number   \n"
                 ,"                 ,Sfn.t_Datebegin   \n"
                 ,"         ,Decode((SELECT COUNT(1)   \n"
                 ,"                       FROM Ddlcontrmp_Dbt Dlp   \n"
                 ,"                      INNER JOIN Dsfcontr_Dbt Sf   \n"
                 ,"                         ON (Sf.t_Id = Dlp.t_Sfcontrid)   \n"
                 ,"                      WHERE Dlp.t_Dlcontrid = Dl.t_Dlcontrid   \n"
                 ,"                        AND Sf.t_Servkind = 1   \n"
                 ,"                        AND Sf.t_Servkindsub = 8 and Dlp.t_marketid = "+SPBCode+")   \n"
                 ,"                    ,0   \n"
                 ,"                    ,Chr(0)   \n"
                 ,"                    ,Chr(88)) Avrexch_spb                 \n"
                 ,"                 ,(SELECT Atr.t_Name   \n"
                 ,"                     FROM Dobjatcor_Dbt Atc   \n"
                 ,"                    INNER JOIN Dobjattr_Dbt Atr   \n"
                 ,"                       ON (Atr.t_Objecttype = Atc.t_Objecttype AND Atc.t_Groupid = Atr.t_Groupid AND   \n"
                 ,"                          Atc.t_Attrid = Atr.t_Attrid)   \n"
                 ,"                    WHERE Atc.t_Objecttype = 207   \n"
                 ,"                      AND Atc.t_Groupid = 101   \n"
                 ,"                      AND SYSDATE BETWEEN Atc.t_Validfromdate AND Atc.t_Validtodate   \n"
                 ,"                      AND Atc.t_Object = Lpad(Dl.t_Dlcontrid, 34, '0')) t_State   \n"
                 ,"                 ,Dl.t_Email   \n"
                 ,"                 ,0 t_Countsend   \n"
                 ,"                 ,Chr(0) t_Resend   \n"
                 ,"            ,Decode( (SELECT count(1)  \n"
                 ,"                      FROM dsfcontr_dbt s, dobjatcor_dbt a  \n"
                 ,"                       WHERE     s.t_servkindsub = 8  \n"
                 ,"                        AND a.t_objecttype = 659  \n"
                 ,"                        AND a.t_groupid = 102  \n"
                 ,"                        AND a.t_attrid = 1  \n"
                 ,"                        AND a.t_object = LPAD (s.t_id, 10, '0')  \n"
                 ,"                        AND s.t_id IN (SELECT t_sfcontrid  \n"
                 ,"                                         FROM ddlcontrmp_dbt  \n"
                 ,"                                        WHERE t_dlcontrid = Dl.t_Dlcontrid))  \n"
                 ,"                     ,0   \n"
                 ,"                     ,chr(0)  \n"
                 ,"                     ,chr(88)) EDP  \n"
//                 ,"             ,Decode((SELECT count(1)  \n"
//                 ,"               FROM dnotetext_dbt nt  \n"
//                 ,"              WHERE     nt.t_objecttype = 3  \n"
//                 ,"                    AND nt.t_notekind = 88  \n"
//                 ,"                    AND nt.t_documentid = LPAD (Sfn.t_Partyid, 10, '0')  \n"
//                 ,"                    AND instr (upper(UTL_RAW.CAST_TO_VARCHAR2 (nt.t_text)),'ДА') > 0)  \n"
//                 ,"                    , 0  \n"
//                 ,"                    ,chr(0)  \n"
//                 ,"                    ,chr(88)) SPB_Allow  \n"
                 ,"            ,decode( (SELECT COUNT (1)  \n"
                 ,"              FROM ddlcontrmsg_dbt contrmsg  \n"
                 ,"             WHERE     contrmsg.t_dlcontrid = Dl.t_Dlcontrid  \n"
                 ,"                   AND contrmsg.t_kind = 9  \n"
                 ,"                   AND contrmsg.T_SENDMESSTATE = 310  \n"
                 ,"                   AND contrmsg.t_marketid = "+SPBCode+")  \n"
                 ,"                   ,0  \n"
                 ,"                   ,chr(0)  \n"
                 ,"                   ,chr(88)) Client_Booking  \n"
                 ,"            ,decode( (SELECT COUNT (1)  \n"
                 ,"              FROM ddlcontrmsg_dbt contrmsg  \n"
                 ,"             WHERE     contrmsg.t_dlcontrid = Dl.t_Dlcontrid  \n"
                 ,"                   AND contrmsg.t_kind = 2  \n"
                 ,"                   AND contrmsg.T_SENDMESSTATE = 310  \n"
                 ,"                   AND contrmsg.t_marketid = "+SPBCode+")  \n"
                 ,"                   ,0  \n"
                 ,"                   ,chr(0)  \n"
                 ,"                   ,chr(88)) Client_Online  \n"
                 ,"      ,DECODE (                                           \n"
                 ,"          (SELECT COUNT (1)                               \n"
                 ,"             FROM USPBAPROVCONTR_DBT spbapr               \n"
                 ,"            WHERE     spbapr.t_sfcontrid = DL.T_SFCONTRID \n"
                 ,"                  AND spbapr.t_is_send = CHR (88)),       \n"
                 ,"          0, CHR (0),                                     \n"
                 ,"          CHR (88))                                       \n"
                 ,"          SBP_Send                                        \n"
                 ,"        ,DECODE (                                                 \n"
                 ,"            (SELECT COUNT (1)                                     \n"
                 ,"               FROM dnotetext_dbt                                 \n"
                 ,"              WHERE     t_objecttype = 207                        \n"
                 ,"                    AND t_notekind = 115                          \n"
                 ,"                    AND t_documentid = LPAD (Dl.t_Dlcontrid , 34, '0')),   \n"
                 ,"            0, CHR (0),                                           \n"
                 ,"            CHR (88)) t_depo_SPB                                  \n"
                 ,"        ,DECODE (                                                 \n"
                 ,"            (SELECT COUNT (1)                                     \n"
                 ,"             FROM USPBAPROVCONTR_DBT spbapr                       \n"
                 ,"            WHERE     spbapr.t_sfcontrid = DL.T_SFCONTRID         \n"
                 ,"                  AND spbapr.t_is_upload = CHR (88)),             \n"
                 ,"            0, CHR (0),                                           \n"
                 ,"            CHR (88)) t_Dias_upload                               \n"   
                 ,"             FROM Ddlcontr_Dbt Dl inner join  uSPBAprovContr_dbt spb   on (spb.t_sfcontrid = DL.T_SFCONTRID)  \n"
                 ,"            INNER JOIN Dsfcontr_Dbt Sfn   \n"
                 ,"               ON (Sfn.t_Id = Dl.t_Sfcontrid)   \n"
                 ,"            WHERE Dl.t_Dlcontrid = t.t_Dlid) WHERE t.ROWID = v_Dli;   \n"
                 ,"   COMMIT;   \n"
                 ,"EXCEPTION   \n"
                 ,"   WHEN OTHERS THEN   \n"
                 ,"      ROLLBACK;   \n"
                 ,"END;   \n"
                );
   rsdc = rsdcommand(sqls);
   rsdc.AddParam("p_Dli", RSDBP_IN, p_dli);
   rsdc.execute;                         
   rsdc = null;
   onerror(e);
   end;

   macro sel_save(sql)
   sql.Edit;
   sql.Value("t_Countsend") = flownum_SPB_SEND/*2*/;
   sql.Update;
   end;
   
   macro sel_work(add_upl)       
   var i = 0, v_ob, sqls, rsdc, rsds, t_st  ;
   var v_sqls, v_rsdc, v_rsds;
   var msg_txt = "";
   var msg_txt_add = "";
   var REGPATH_upl = "РСХБ\\ДИРЕКТОРИИ\\SPBIMPORT";
   var data_upl, str_upl;
   var EXPORT_FILENAME_TXT = "SPB_DIASOFT_OUT_" + u_dttm + ".txt";
   var filePath = DL_GetFullPath(GetStrRegVal(REGPATH_upl));
   var XMLTxt;

   
   sqls = "SELECT t.t_dlid,t.t_Partyid, t.t_client_online, t.t_spb_send, t.t_DIAS_UPLOAD, t.Rowid rwd, COUNT(1) over() r_all, row_number() over(ORDER BY t.t_dlid) n_all FROM DBO_SPB_SEND_TMP t WHERE t.t_countsend = " + flownum_SPB_SEND;

   if(add_upl == 1)
     v_sqls =string(sqls, " and (t.t_client_online = chr(0) or t.t_spb_send = chr(88) or t.t_depo_spb = chr(0))") ;
     msg_txt = "Выбраны договора по которым формирование и отправка не будут выполнены.\n Из процедуры исключатся договора для которых:";
     msg_txt_add = "\n1. Не выполнена активация договора('Cl.-Online'); \n2. Не получена выгрузка из Диасофт('Получен счет Депо');\n3. Отправка уведомления уже выполнялась('СПБ.Уведомл.');";
   elif(add_upl == -1)
     v_sqls =string(sqls, " and (t.t_client_online = chr(0) or t.t_DIAS_UPLOAD = chr(88))") ;
     msg_txt = "Выбраны договора по которым выгрузка в ДИАСОФТ не будет выполнена.\n Из процедуры исключатся договора для которых:";
     msg_txt_add = "\n1. Не выполнена активация договора('Cl.-Online'); \n2. Выгрузка из Диасофт уже осуществлялась('Выгр. в DIAS');";
     XMLTxt = TStreamDoc(filePath + EXPORT_FILENAME_TXT , "C", "rsansi");
   end;

   v_rsdc = RSDCommand(v_sqls);
   v_rsds = RSDRecordset(v_rsdc, RSDVAL_CLIENT, RSDVAL_STATIC);

   if(v_rsds.movenext())
     msgboxex(msg_txt + msg_txt_add, MB_OK , IND_OK, "Внимание!");
   end;

   sqls = string(sqls, " ORDER BY t.t_dlid ");
   rsdc = rsdcommand(sqls);
   rsds = rsdrecordset(rsdc, RSDVAL_CLIENT_IF_NEEDED, RSDVAL_FORWARD_ONLY);

   rsds.Open;
   rsds.MoveNext();
   t_st = time();
   Initprogress(int(rsds.Value("r_All")), "", "Обработка");
   SetDialogFlag(0);
   while (true)
      if (add_upl < 0)
        if((rsds.value("t_client_online") == "X") and (rsds.value("t_DIAS_UPLOAD") == ""))
            data_upl = GetUploadData(rsds.Value("t_Dlid"));
            
            while(data_upl.movenext())
              str_upl = string(CheckValue(data_upl.value("ContractID")), ";",
                               CheckValue(data_upl.value("ContractNumber")), ";",
                               CheckValue(data_upl.value("ContractDate")), ";",
                               CheckValue(data_upl.value("ContractName")), ";",
                               CheckValue(data_upl.value("TypeTP")), ";",
                               CheckValue(data_upl.value("Funds")), ";",
                               CheckValue(data_upl.value("ClientType")), ";",
                               CheckValue(data_upl.value("ClientID")), ";",
                               CheckValue(data_upl.value("BranchID")), ";",
                               CheckValue(data_upl.value("CodeCli")), ";",
                               CheckValue(data_upl.value("ClientRegistrationCodeSPBEX")), ";",
                               CheckValue(data_upl.value("AccCliBrok")), ";",
                               CheckValue(data_upl.value("AccDateOpen")), ";",
                               CheckValue(data_upl.value("AccType")), ";",
                               CheckValue(data_upl.value("KvalInv")), ";",
                               CheckValue(data_upl.value("DateStKI")), ";",
                               CheckValue(data_upl.value("DateEndKI")) );            
            XMLTxt.writeline(str_upl);
              str_upl = "";
            end;  
            mark_as_upload(rsds.Value("t_Dlid"));
            upd_line(rsds.Value("rwd"));
        end;
      else
        
        if((rsds.value("t_client_online") == "X") and (rsds.value("t_spb_send") == ""))
            
            if (v_Ob == null)
               v_Ob = dboMessage(rsds.Value("t_Dlid"));
            else
               v_Ob.ddl_id = rsds.Value("t_Dlid");
               v_Ob.Constructor;
            end;
           if (v_Ob and (v_Ob.statsend != -1))    
               if (rsds.Value("n_All") < rsds.Value("r_All"))
                  v_Ob.isLast = false; 
               end;
               v_Ob.CreateMessage(true, true/*false*/, true, false, "");
               if (v_Ob.statsend == -1)
                  sav_err(v_Ob.statMes, rsds.Value("rwd"));
               end;
               mark_as_sent(rsds.value("t_Dlid"));//установливаем пометку о отправке
            else
               if (v_Ob)
                  sav_err(v_Ob.statMes, rsds.Value("rwd"));
               else
                  sav_err("Объект уведомления не создан", rsds.Value("rwd"));
                  v_Ob = null;
               end;
            end;

            upd_line(rsds.Value("rwd"));
            // обновление аккаунта Quik 
            //execMacrofile("global_utils_intgr.mac","m_make_event_to_process",5025, int(rsds.Value("t_Partyid")),9);
            //обновление РСХБ-Брокер
            //execMacrofile("global_utils_intgr.mac","m_make_event_to_process",5026, int(rsds.Value("t_Partyid")),9);
        end; 
        upd_line(rsds.Value("rwd"));
      end;
      if (not rsds.MoveNext())
         XMLTxt = null;
         break;
      end;
      SetDialogFlag(1);
      Useprogress(int(rsds.Value("n_All")));
      SetDialogFlag(0);
   end;            
   if (v_Ob)
      v_Ob.isLast = true;
      v_Ob.cls_word();
   end;
   rsds.Close;
   rsdc = rsds = null;
   SetDialogFlag(1);
   remprogress();
   //msgbox(time - t_st);
   end;
   
   macro on_scr_init(sql, field, key_kod)
   AddMultiAction(sql,  21);
   AddMultiAction(sql, 316);
   AddMultiAction(sql, 322);
   while (sql.MoveNext())
      if (int(sql.Value("t_Dlid")) == v_lin)
         gotoscroll(sql);
         break;
      end;
   end;                                     
   if ((sql.Value("t_Dlid") != null) and (sql.Value("t_Dlid") != nullval) and (int(sql.Value("t_Dlid")) != v_lin))
      sql.MoveFirst();
      gotoscroll(sql);
   end;                     
   v_lin = -1;
   end;

   macro on_scr_mlt_beg(sql, field, key_kod)
     fl_end = false;
     if (key_kod == 316)
        v_lin = -1;
           if (msgboxex("Сформировать и отправить уведомления для выделенных клиентов?", MB_YES + MB_NO, IND_YES) == IND_NO)
             return cm_ignore;
           end;
     end;
     if (key_kod == 322)
     end;
     if (key_kod == 21)

           if (msgboxex("Выполнить выгрузку в ДИАСОФТ для выделенных клиентов?", MB_YES + MB_NO, IND_YES) == IND_NO)
             return cm_ignore;
           end;
     end;

   end;

   macro on_scr_mlt_end(sql, field, key_kod)  
   fl_end = true;
   // обработка отобранных
   if (key_kod == 316)   
      sel_work(1);
   end;   
   if (key_kod == 21)
      sel_work(-1);
   end;   
   end;

   macro on_scr_mlt_sel(sql, field, key_kod)
   if (key_kod == 316)
      if (v_lin < 0) 
         v_lin = int(sql.Value("t_Dlid"));
      end;
   end;
   sel_save(sql);
   return CM_MSEL_CONT_CLEAR;
   end;

   macro on_scr_key_empty(sql, field, key_kod)
   if (fl_end)        
      return cm_select;
   end;
   end;

   macro on_scr_key_F2(sql, field, key_kod)
   if (not is_pos(sql))
      return cm_ignore;
   end;
      if (msgboxex("Сформировать и отправить уведомление для клиента?", MB_YES + MB_NO, IND_YES) == IND_YES)
      
      v_Lin = int(sql.Value("t_Dlid"));
      sel_save(sql);
      // обработка отобранных
      insertTimelog("Старт обработки");
      sel_work(1);
      insertTimelog("Конец обработки");
      return cm_select;
   end;             
   return cm_ignore;
   end;

   macro on_scr_key_F3(sql, field, key_kod)
   var RecID;
   if (not is_pos(sql))
      return cm_ignore;
   end;
          if (msgboxex("Обработать выгрузку ДИАСОФТ?", MB_YES + MB_NO, IND_YES) == IND_YES)
            LoadDiasDepoFile();
        msgboxex("Скроллинг будет закрыт для обновления данных.", MB_OK , IND_OK, "Обработка закончена!");
      return cm_cancel;
   end;             
   return cm_ignore;
   end;

   macro on_scr_key_F8(sql, field, key_kod)
   if (not is_pos(sql))
      return cm_ignore;
   end;
   if (msgboxex("Удалить субдоговор?", MB_YES + MB_NO, IND_YES) == IND_YES)
      v_Lin = int(sql.Value("t_Dlid"));
      sel_save(sql);
      // обработка отобранных
      sel_work(-1);    
      return cm_select;
      runTimeShift();
   end;   
   return cm_ignore;
   end;

   macro on_scr_key_Ctrl_R(sql, field, key_kod)
   if (not is_pos(sql))
      v_lin = -1;
   end;
   v_Lin = int(sql.Value("t_Dlid"));
   if (not sel_contr())
      return cm_ignore;
   end;                
   return cm_select;
   end;
   
   macro run_list()
   var rsds;     

   if (not sel_contr())
      return false;
   end;
   AddCol ("t_number",        "Номер",            18);
   AddCol ("T_name",          "Наименование ",    25);
   AddCol ("T_state",         "Статус договора ", 10);
   AddCol ("T_status_work", "Статус обработки ", 25);
   AddCol ("T_message",       "Ошибки форм-ния",  15);
   AddCol ("T_EDP",           "ЕДП",              5 );
//   AddCol ("T_SPB_Allow",     "Допуск к СПб",     12);
   AddCol ("t_avrexch_SPB",   "СПБ.Фонд ",        8 );
   AddCol ("t_Client_Booking","Cl.-Booking ",     10);
   AddCol ("t_Client_Online", "Cl.-Online",       9);
   AddCol ("t_dias_upload",   "Выгр. в DIAS",     12);
   AddCol ("t_DEPO_SPB",      "Получен счет Депо",15);
   AddCol ("t_SPB_Send",      "СПБ.Уведомл.",     15);
   AddCol ("t_datebegin",     "Заключен",         8 );
   AddCol ("t_email",         "e-mail",           20);
   AddCol ("t_Dlid",          "dlid",             5 );
   rsds = create_ds();
   if (rsds == null)
      return false;
   end;           
   v_lin = -1;
   while (Run(rsds))    
      rsds = create_ds();
      if (rsds == null)
         return false;
      end;           
   end;   
    // clear_ds();
   end;

InitTRslScroll();
scr_name = "FILTR_CONTRACT";
title    = "Договоры";
   st_line  = "ESC-Выход   Ctrl+U-Вынрузка в DIAS    F3-Обработать ответ DIAS    F2-Создать уведомление    Shift(Вниз/Вверх)-Выделить";
end;

macro  Exec_SPB_Mass_Send()
   TMsgScroll_Send.run_list;
   exit(1);
end;