/*
$Name:         vtb_stat.mac
$Module:       Ценные бумаги
$Description:  Отчет по статистике загрузки
*/

import cb_sql, sp_class;

PRIVATE CONST BEGDATE_CHECK_NOB = date(21,04,2022);

private macro iif(a,b,c)
  if (a) return b else return c end;
end;

private class _Report(_dt)
   private var dt = _dt;

   private var _НДФЛ_ВсегоЗчс = 0;
   private var _НДФЛ_ВсегоЗагружено = 0;
   private var _НДФЛ_ВсегоОбработано = 0;
   private var _НДФЛ_ВсегоНеОбработано = 0;
   private var _НДФЛ_ВсегоНеОбработано_ткНеЗагружено = 0;
   private var _НДФЛ_ВсегоНеЗагружено = 0;
   private var _НДФЛ_ВсегоНеЗагруженоКД = 0;

   private var _КлиентыВТБ_Всего = 0;
   private var _КлиентыВТБ_НаДату = 0;

   private var _ДЕПО_Всего = 0;
   private var _ДЕПО_ВсеЦены = 0;
   private var _ДЕПО_ЧастичноЦены = 0;
   private var _ДЕПО_ЧастичноЦены_НулевыеОтВТБ = 0;
   private var _ДЕПО_НетЦен = 0;
   private var _ДЕПО_НетЦен_НулевыеОтВТБ = 0;

   private var _КлиентыQUIK_Всего = 0;
   private var _КлиентыQUIK_ВсеЦены = 0;
   private var _КлиентыQUIK_ЧастичноЦены = 0;
   private var _КлиентыQUIK_НетЦен = 0;

   private var _ЛимитыQUIK_Всего = 0;
   private var _ЛимитыQUIK_СЦенами = 0;
   private var _ЛимитыQUIK_БезЦен = 0;

   private var _КлиентыВнеб_Всего = 0;
   private var _КлиентыВнеб_ВсеЦены = 0;
   private var _КлиентыВнеб_ЧастичноЦены = 0;
   private var _КлиентыВнеб_НетЦен = 0;

   private var _ПозицииВнеб_Всего = 0;
   private var _ПозицииВнеб_СЦенами = 0;
   private var _ПозицииВнеб_БезЦен = 0;

   private var _КлиентыТолькоВнеб_Всего = 0;
   private var _КлиентыТолькоВнеб_ВсеЦены = 0;
   private var _КлиентыТолькоВнеб_ЧастичноЦены = 0;
   private var _КлиентыТолькоВнеб_НетЦен = 0;

   private var _НОБ_Рассчитано = 0;
   private var _НОБ_РассчитатьНеобходимо = 0;

   private class ErrRec(s,cnt, cnt_cl)
      var _s, _cnt, _cnt_cl;
      _s = s;
      _cnt = cnt;
      _cnt_cl = cnt_cl;
      macro ErrText()
         return _s;
      end;
      macro Count()
         return _cnt;
      end;
      macro Count_cl()
         return _cnt_cl;
      end;
   end;

   private macro ClientQueryDt(_alias, _field)
      var q = "";

      if ((ValType(dt) != V_UNDEF) and (dt != ""))
         q = _alias + "." +  _field + " in ( select t_objectid from dobjcode_dbt where t_codekind = 109 and t_objecttype = 3 and t_state = 0 and t_bankdate <= " + GetSQLDate(dt)+")";
      else
         q = " 1=1 ";
      end;
      return q;
   end;

   macro КлиентыНаДату()
      return dt;
   end;

   private macro ExistsTable(tname)
     var sql = " select * from USER_OBJECTS where object_type = 'TABLE' and OBJECT_NAME = upper('"+tname+"') ";
     var Dt = TRsbDataSet(sql);
     if (Dt.movenext())
        return true;
     end;
   end;

   macro НДФЛ_ВсегоЗчс()
      return this.НДФЛ_ВсегоЗагружено() + this.НДФЛ_ВсегоНеЗагружено();
   end;

   macro НДФЛ_ВсегоЗагружено()
     var sql = " select count(1) cnt from UNDFLOP_READYEXEC t where " + ClientQueryDt("t","t_clientid");
     if (_НДФЛ_ВсегоЗагружено == 0)
        var Dt = TRsbDataSet(sql);
        Message("НДФЛ_ВсегоЗагружено");
        if (Dt.movenext())
           _НДФЛ_ВсегоЗагружено = Dt.cnt;
        end;
        //EndAction(50);
     end;
     return _НДФЛ_ВсегоЗагружено;
   end;

   macro НДФЛ_ВсегоНеЗагружено()
     if (ExistsTable("uvtb_ndfl_log"))
        var sql = " select count(1) cnt from uvtb_ndfl_log l where " + 
             "  not exists (select 1 from UVTB_CHECKOP_DBT t where T.T_CLIENTID = (select t_objectid from dobjcode_dbt where t_codekind = 109 and t_objecttype = 3 and t_state = 0 and t_code = t_gkk)  \n" +
             " and t.t_pfi = (select t_fiid from davoiriss_dbt a where a. t_isin = l.t_isin)  \n" +
             " and T.T_DEPO_SUM = t.t_ndfl_sum ) \n" +
" and t_s not like 'Не найден клиент с видом кода%' " +
" and t_s not like 'Не найден ДБО%' " +
" and t_s not like '%загружалась%' " +
" and t_s not like 'Не задано поле \"Curr\"%'  and t_operdate = (select max(t_operdate) from uvtb_ndfl_log)";
        if (_НДФЛ_ВсегоНеЗагружено == 0)
           var Dt = TRsbDataSet(sql);
           Message("НДФЛ_ВсегоНеЗагружено");
           if (Dt.movenext())
              _НДФЛ_ВсегоНеЗагружено = Dt.cnt;
           end;
           //EndAction(50);
        end;
     else
        _НДФЛ_ВсегоНеЗагружено = "Отсутствует лог в БД";
     end;
     return _НДФЛ_ВсегоНеЗагружено;
   end;

   macro НДФЛ_ВсегоНеЗагруженоКД()
     if (ExistsTable("uvtb_ndfl_log") and ExistsTable("uvtb_kd"))
        var sql = " select count(1) cnt from uvtb_ndfl_log l where t_operdate = (select max(t_operdate) from uvtb_ndfl_log) " + 
             "  and not exists (select 1 from UVTB_CHECKOP_DBT t where T.T_CLIENTID = (select t_objectid from dobjcode_dbt where t_codekind = 109 and t_objecttype = 3 and t_state = 0 and t_code = t_gkk)  \n" +
             " and t.t_pfi = (select t_fiid from davoiriss_dbt a where a. t_isin = l.t_isin)  \n" +
             " and T.T_DEPO_SUM = t.t_ndfl_sum ) \n" +
" and t_s not like 'Не найден клиент с видом кода%' " +
" and t_s not like '%загружалась%' " +
" and t_s not like 'Не найден ДБО%' " +
                  " and exists (select 1 from uvtb_kd where isin = t_isin or newisin = t_isin) " ;
        if (_НДФЛ_ВсегоНеЗагруженоКД == 0)
           var Dt = TRsbDataSet(sql);
           Message("_НДФЛ_ВсегоНеЗагруженоКД");
           if (Dt.movenext())
              _НДФЛ_ВсегоНеЗагруженоКД = Dt.cnt;
           end;
           //EndAction(50);
        end;
     else
        _НДФЛ_ВсегоНеЗагруженоКД = "Отсутствует лог в БД";
     end;
     return _НДФЛ_ВсегоНеЗагруженоКД;
   end;


   macro НДФЛ_ВсегоОбработано()
     var sql = " select count(1) cnt from UNDFLOP_READYEXEC o, ddl_tick_dbt t where t.t_dealid = o.t_dealid and t.t_dealstatus = 20 and " + ClientQueryDt("o","t_clientid");
     if (_НДФЛ_ВсегоОбработано == 0)
        var Dt = TRsbDataSet(sql);
        Message("НДФЛ_ВсегоОбработано");
        if (Dt.movenext())
           _НДФЛ_ВсегоОбработано = Dt.cnt;
        end;
        //EndAction(50);
     end;
     return _НДФЛ_ВсегоОбработано;
   end;

   macro НДФЛ_ВсегоНеОбработано()
     var sql = " select count(1) cnt from UNDFLOP_READYEXEC o, ddl_tick_dbt t where t.t_dealid = o.t_dealid and t.t_dealstatus <> 20 and " + ClientQueryDt("o","t_clientid");
     if (_НДФЛ_ВсегоНеОбработано == 0)
        Message("НДФЛ_ВсегоНеОбработано");
        var Dt = TRsbDataSet(sql);
        if (Dt.movenext())
           _НДФЛ_ВсегоНеОбработано = Dt.cnt;
        end;
        //EndAction(50);
     end;
     return _НДФЛ_ВсегоНеОбработано;
   end;

   macro НДФЛ_ВсегоНеОбработано_ткНеЗагружено()
     var sql = " select count(1) cnt from UNDFLOP_READYEXEC o, ddl_tick_dbt t where t.t_dealid = o.t_dealid and t.t_dealstatus <> 20 and " + ClientQueryDt("o","t_clientid") + 
               " and exists (select 1 from uvtb_ndfl_log where t_operdate = (select max(t_operdate) from uvtb_ndfl_log) and t.t_dealcode like t_dealcode||'%')";
     if (_НДФЛ_ВсегоНеОбработано_ткНеЗагружено == 0)
        Message("НДФЛ_ВсегоНеОбработано_ткНеЗагружено");
        var Dt = TRsbDataSet(sql);
        if (Dt.movenext())
           _НДФЛ_ВсегоНеОбработано_ткНеЗагружено = Dt.cnt;
        end;
        //EndAction(50);
     end;
     return _НДФЛ_ВсегоНеОбработано_ткНеЗагружено;
   end;

   macro КлиентыВТБ_Всего()
     var sql = " select count(1) cnt from dobjcode_dbt where t_codekind = 109 and t_objecttype = 3 and t_state = 0 and t_bankdate <= " + GetSQLDate(dt) ;
     if (_КлиентыВТБ_Всего == 0)
        var Dt = TRsbDataSet(sql);
        Message("КлиентыВТБ_Всего");
        if (Dt.movenext())
           _КлиентыВТБ_Всего = Dt.cnt;
        end;
        //EndAction(50);
     end;
     return _КлиентыВТБ_Всего;
   end;

   macro КлиентыQUIK_Всего()
     var sql = " select count(1) cnt  from (select t_client  from ddl_limitsecurites_dbt t where t_market_kind = 'фондовый' and t_limit_kind = 2 and t_open_balance <> 0  and " + ClientQueryDt("t", "t_client") + " group by t_client)"; 
     if (_КлиентыQUIK_Всего == 0)
        var Dt = TRsbDataSet(sql);
        Message("КлиентыQUIK_Всего");
        if (Dt.movenext())
           _КлиентыQUIK_Всего = Dt.cnt;
        end;
        //EndAction(50);
     end;
     return _КлиентыQUIK_Всего;
   end;

   macro КлиентыQUIK_ВсеЦены()
     var sql =  
         "  select count(t_client_code) cnt from (select t_client_code from DDL_LIMITSECURITES_DBT t3 \n" +
         "       where t3.t_limit_kind = 2   \n " 
         "and t_market_kind = 'фондовый' \n" +
         "and t_wa_position_price <> 0 \n" +
         "and t_open_balance <> 0  \n" +
         "and   not exists (select 1 from DDL_LIMITSECURITES_DBT  \n" +
         "       where t_limit_kind = 2   \n" +
         "       and t_client_code = t3.t_client_code and t_market_kind = 'фондовый' and t_wa_position_price = 0) \n" +
         " and "  + ClientQueryDt("t3", "t_client") +  
         "       group by t_client_code) \n" ;

     if (_КлиентыQUIK_ВсеЦены == 0)
        var Dt = TRsbDataSet(sql);
        Message("КлиентыQUIK_ВсеЦены");
        if (Dt.movenext())
           _КлиентыQUIK_ВсеЦены = Dt.cnt;
        end;
        //EndAction(50);
     end;
     return _КлиентыQUIK_ВсеЦены;
   end;

   macro КлиентыQUIK_ЧастичноЦены()
     var sql =  
         "  select count(t_client_code) cnt from (select t_client_code from DDL_LIMITSECURITES_DBT t3 \n" +
         "       where t3.t_limit_kind = 2   \n " 
         "and t_market_kind = 'фондовый' \n" +
         "and t_wa_position_price <> 0 \n" +
         "and t_open_balance <> 0  \n" +
         "and   exists (select 1 from DDL_LIMITSECURITES_DBT  \n" +
         "       where t_limit_kind = 2   \n" +
         "       and t_client_code = t3.t_client_code and t_market_kind = 'фондовый' and t_wa_position_price = 0) \n" +
         " and "  + ClientQueryDt("t3", "t_client") +  
         "       group by t_client_code) \n" ;

     if (_КлиентыQUIK_ЧастичноЦены == 0)
        var Dt = TRsbDataSet(sql);
        Message("КлиентыQUIK_ЧастичноЦены");
        if (Dt.movenext())
           _КлиентыQUIK_ЧастичноЦены = Dt.cnt;
        end;
        //EndAction(50);
     end;
     return _КлиентыQUIK_ЧастичноЦены;
   end;

   macro КлиентыQUIK_НетЦен()
     var sql =  
         "  select count(t_client_code) cnt from (select t_client_code from DDL_LIMITSECURITES_DBT t3 \n" +
         "       where t3.t_limit_kind = 2   \n " 
         "and t_market_kind = 'фондовый' \n" +
         "and t_wa_position_price = 0 \n" +
         "and t_open_balance <> 0  \n" +
         "and  not exists (select 1 from DDL_LIMITSECURITES_DBT  \n" +
         "       where t_limit_kind = 2   \n" +
         "       and t_client_code = t3.t_client_code and t_market_kind = 'фондовый' and t_wa_position_price <> 0) \n" +
         " and "  + ClientQueryDt("t3", "t_client") +  
         "       group by t_client_code) \n" ;

     if (_КлиентыQUIK_НетЦен == 0)
        var Dt = TRsbDataSet(sql);
        Message("КлиентыQUIK_НетЦен");
        if (Dt.movenext())
           _КлиентыQUIK_НетЦен = Dt.cnt;
        end;
        //EndAction(50);
     end;
     return _КлиентыQUIK_НетЦен;
   end;

   macro ЛимитыQUIK_Всего()
     var sql =  
         "  select count(1) cnt from DDL_LIMITSECURITES_DBT t3 \n" +
         "       where t3.t_limit_kind = 2   \n " 
         "and t_market_kind = 'фондовый' \n" +
         "and t_open_balance <> 0  \n" +
         " and "  + ClientQueryDt("t3", "t_client");  

     if (_ЛимитыQUIK_Всего == 0)
        var Dt = TRsbDataSet(sql);
        Message("ЛимитыQUIK_Всего");
        if (Dt.movenext())
           _ЛимитыQUIK_Всего = Dt.cnt;
        end;
        //EndAction(50);
     end;
     return _ЛимитыQUIK_Всего;
   end;


   macro ЛимитыQUIK_СЦенами()
     var sql =  
         "  select count(1) cnt from DDL_LIMITSECURITES_DBT t3 \n" +
         "       where t3.t_limit_kind = 2   \n " 
         "and t_market_kind = 'фондовый' \n" +
         "and t_wa_position_price <> 0 \n" +
         "and t_open_balance <> 0  \n" +
         " and "  + ClientQueryDt("t3", "t_client");  

     if (_ЛимитыQUIK_СЦенами == 0)
        var Dt = TRsbDataSet(sql);
        Message("ЛимитыQUIK_СЦенами");
        if (Dt.movenext())
           _ЛимитыQUIK_СЦенами = Dt.cnt;
        end;
        //EndAction(50);
     end;
     return _ЛимитыQUIK_СЦенами;
   end;

   macro ЛимитыQUIK_БезЦен()
     var sql =  
         "  select count(1) cnt from DDL_LIMITSECURITES_DBT t3 \n" +
         "       where t3.t_limit_kind = 2   \n " 
         "and t_market_kind = 'фондовый' \n" +
         "and t_wa_position_price = 0 \n" +
         "and t_open_balance <> 0  \n" +
         " and "  + ClientQueryDt("t3", "t_client");  

     if (_ЛимитыQUIK_БезЦен == 0)
        var Dt = TRsbDataSet(sql);
        Message("ЛимитыQUIK_БезЦен");
        if (Dt.movenext())
           _ЛимитыQUIK_БезЦен = Dt.cnt;
        end;
        //EndAction(50);
     end;
     return _ЛимитыQUIK_БезЦен;
   end;

  private macro CreateTable1()
     SQL_Execute(
        "begin  \n" +
        "execute immediate \n" +
        "'CREATE TABLE UVTB_PRICESLEG_DBT'|| \n" +
        "'(T_DEALID     NUMBER(10)                       NOT NULL,'|| \n" +
        "'  T_DEALCODE   VARCHAR2(30 BYTE),'|| \n" +
        "'  T_DEALDATE   DATE,'|| \n" +
        "'  T_DEALTYPE   NUMBER(5),'|| \n" +
        "'  T_PRINCIPAL  NUMBER,'|| \n" +
        "'  T_PFI        NUMBER(10),'|| \n" +
        "'  T_CLIENTID   NUMBER(10), '|| \n" +
        "'  T_PRICE      FLOAT(53))'; \n" +
        "exception when others then null; end; \n" );

  end;

  private macro FillTable1()
     SQL_Execute(
        " insert into uvtb_pricesleg_dbt  SELECT t.t_DealID, t.t_dealcode, t.t_dealdate, t.t_dealtype, CASE WHEN t.t_dealtype IN (2011, 32011) THEN 1 ELSE -1 END * l.t_principal t_principal, t.t_pfi, t.t_clientid, l.t_price \n" +
        "   FROM dnotetext_dbt n, ddl_tick_dbt t, ddl_leg_dbt l  \n" +
        "  WHERE     n.t_documentid = LPAD (t.t_dealid, 34, '0')  \n" +
        "        AND n.t_notekind = 404  \n" +
        "        AND t_objecttype = 101                           \n" +
        "        AND t.t_bofficekind = 127 --and T.T_DEALTYPE = 2011           \n" +
        "        and t.t_dealdate >= to_date('21042022','ddmmyyyy') \n" +
        "        and t.t_dealid = l.t_dealid and l.t_legkind = 0 and l.t_legid = 0    ;   \n" );
  end;

  private macro DeleteTransfers()
     SQL_Execute(
     "   DELETE FROM uvtb_pricesleg_dbt  \n" +
     "      WHERE t_dealid IN  \n" +
     "               (  SELECT o.t_dealid  \n" +
     "                    FROM uvtb_pricesleg_dbt o  \n" +
     "                   WHERE EXISTS  \n" +
     "                                (SELECT 1 FROM uvtb_pricesleg_dbt o1  \n" +
     "                                  WHERE    o.t_dealdate = o1.t_dealdate  \n" +
     "                                        AND o.t_pfi = o1.t_pfi  \n" +
     "                                        AND o.t_principal = -o1.t_principal  \n" +
     "                                        AND o.t_clientid = o1.t_clientid))  \n");
  end;

   macro ДЕПО_Всего()
     var sql =  
        // "  select count(1) cnt from ( select t_clientid from uvtb_pricesleg_dbt е group by t_clientid and "  + ClientQueryDt("t", "t_client") + ")    ";
         "  select count(1) cnt from (select t_clientid from UDEPOOP_READYEXEC t where "  + ClientQueryDt("t", "t_clientid") + " group by t_clientid) ";
     if (_ДЕПО_Всего == 0)
       // CreateTable1();
       // FillTable1();
       // DeleteTransfers();
        var Dt = TRsbDataSet(sql);
        Message("_КлиентыТолькоВнеб_Всего");
        if (Dt.movenext())
           _ДЕПО_Всего = Dt.cnt;
        end;
        //EndAction(50);
     end;
     return _ДЕПО_Всего;
   end;

   macro ДЕПО_ВсеЦены()
     var sql =  
        "select count(1) cnt from ( \n" +
        "  SELECT d.t_clientid \n" +
        "    FROM  ddl_leg_dbt l, UDEPOOP_READYEXEC d \n" +
        "   WHERE   l.t_legkind = 0 \n" +
        "         AND l.t_legid = 0 \n" +
        "         AND d.t_dealid = l.t_dealid \n" +
        "         AND l.t_price <> 0 and " + ClientQueryDt("d", "t_clientid") +"\n" +
        "         AND NOT EXISTS \n" +
        "                    (SELECT 1 \n" +
        "                       FROM ddl_leg_dbt l1, UDEPOOP_READYEXEC d1 \n" +
        "                      WHERE    l1.t_legkind = 0 \n" +
        "                            AND l1.t_legid = 0 \n" +
        "                            AND l1.t_dealid = d1.t_dealid \n" +
        "                            AND D1.T_CLIENTID = d.t_clientid \n" +
        "                            AND d1.t_pfi <> d.t_pfi \n" +
        "                            AND l1.t_price = 0) \n" +
        "GROUP BY d.t_clientid) \n" ;


     if (_ДЕПО_ВсеЦены == 0)
        var Dt = TRsbDataSet(sql);
        Message("_ДЕПО_ВсеЦены");
        if (Dt.movenext())
           _ДЕПО_ВсеЦены = Dt.cnt;
        end;
        //EndAction(50);
     end;
     return _ДЕПО_ВсеЦены;
   end;

   macro ДЕПО_ЧастичноЦены()
     var sql =  
        "select count(1) cnt from ( \n" +
        "  SELECT d.t_clientid \n" +
        "    FROM  ddl_leg_dbt l, UDEPOOP_READYEXEC d \n" +
        "   WHERE   l.t_legkind = 0 \n" +
        "         AND l.t_legid = 0 \n" +
        "         AND d.t_dealid = l.t_dealid \n" +
        "         AND l.t_price = 0 and " + ClientQueryDt("d", "t_clientid") +"\n" +
        "         AND   EXISTS \n" +
        "                    (SELECT 1 \n" +
        "                       FROM ddl_leg_dbt l1, UDEPOOP_READYEXEC d1 \n" +
        "                      WHERE    l1.t_legkind = 0 \n" +
        "                            AND l1.t_legid = 0 \n" +
        "                            AND l1.t_dealid = d1.t_dealid \n" +
        "                            AND D1.T_CLIENTID = d.t_clientid \n" +
        "                            AND d1.t_pfi <> d.t_pfi \n" +
        "                            AND l1.t_price <> 0) \n" +
        "GROUP BY d.t_clientid) \n" ;

     if (_ДЕПО_ЧастичноЦены == 0)
        var Dt = TRsbDataSet(sql);
        Message("_ДЕПО_ЧастичноЦены");
        if (Dt.movenext())
           _ДЕПО_ЧастичноЦены = Dt.cnt;
        end;
        //EndAction(50);
     end;
     return _ДЕПО_ЧастичноЦены;
   end;

   macro ДЕПО_ЧастичноЦены_НулевыеОтВТБ()
     var sql =  
        "select count(1) cnt from ( \n" +
        "  SELECT d.t_clientid \n" +
        "    FROM  ddl_leg_dbt l, UDEPOOP_READYEXEC d \n" +
        "   WHERE   l.t_legkind = 0 \n" +
        "         AND l.t_legid = 0 \n" +
        "         AND d.t_dealid = l.t_dealid \n" +
        "         AND l.t_price = 0 and " + ClientQueryDt("d", "t_clientid") +"\n" +
        "         AND   EXISTS \n" +
        "                    (SELECT 1 \n" +
        "                       FROM ddl_leg_dbt l1, UDEPOOP_READYEXEC d1 \n" +
        "                      WHERE    l1.t_legkind = 0 \n" +
        "                            AND l1.t_legid = 0 \n" +
        "                            AND l1.t_dealid = d1.t_dealid \n" +
        "                            AND D1.T_CLIENTID = d.t_clientid \n" +
        "                            AND d1.t_pfi <> d.t_pfi \n" +
        "                            AND l1.t_price <> 0) \n" +
        "                            and  \n" +
        "                             EXISTS  \n" +
        "                    (SELECT 1  \n" +
        "                       FROM ddl_leg_dbt l2, UNDFLOP_READYEXEC d2  \n" +
        "                      WHERE    l2.t_legkind = 0  \n" +
        "                            AND l2.t_legid = 0  \n" +
        "                            AND l2.t_dealid = d2.t_dealid  \n" +
        "                            AND D2.T_CLIENTID = d.t_clientid  \n" +
        "                            AND d2.t_pfi = d.t_pfi  \n" +
        "                            AND l2.t_price = 0)  \n" +
        "GROUP BY d.t_clientid) \n" ;

     if (_ДЕПО_ЧастичноЦены_НулевыеОтВТБ == 0)
        var Dt = TRsbDataSet(sql);
        Message("ДЕПО_ЧастичноЦены_НулевыеОтВТБ");
        if (Dt.movenext())
           _ДЕПО_ЧастичноЦены_НулевыеОтВТБ = Dt.cnt;
        end;
        //EndAction(50);
     end;
     return _ДЕПО_ЧастичноЦены_НулевыеОтВТБ;
   end;


   macro ДЕПО_НетЦен()
     var sql =  
        "select count(1) cnt from ( \n" +
        "  SELECT d.t_clientid \n" +
        "    FROM  ddl_leg_dbt l, UDEPOOP_READYEXEC d \n" +
        "   WHERE   l.t_legkind = 0 \n" +
        "         AND l.t_legid = 0 \n" +
        "         AND d.t_dealid = l.t_dealid \n" +
        "         AND l.t_price = 0 and " + ClientQueryDt("d", "t_clientid") +"\n" +
        "         AND  not EXISTS \n" +
        "                    (SELECT 1 \n" +
        "                       FROM ddl_leg_dbt l1, UDEPOOP_READYEXEC d1 \n" +
        "                      WHERE    l1.t_legkind = 0 \n" +
        "                            AND l1.t_legid = 0 \n" +
        "                            AND l1.t_dealid = d1.t_dealid \n" +
        "                            AND D1.T_CLIENTID = d.t_clientid \n" +
        "                            AND d1.t_pfi <> d.t_pfi \n" +
        "                            AND l1.t_price <> 0) \n" +

        "GROUP BY d.t_clientid) \n" ;


     if (_ДЕПО_НетЦен == 0)
        var Dt = TRsbDataSet(sql);
        Message("_ДЕПО_НетЦен");
        if (Dt.movenext())
           _ДЕПО_НетЦен = Dt.cnt;
        end;
        //EndAction(50);
     end;
     return _ДЕПО_НетЦен;
   end;

   macro ДЕПО_НетЦен_НулевыеОтВТБ()
     var sql =  
        "select count(1) cnt from (  \n" +
        "  SELECT d.t_clientid  \n" +
        "    FROM  ddl_leg_dbt l, UDEPOOP_READYEXEC d  \n" +
        "   WHERE   l.t_legkind = 0  \n" +
        "         AND l.t_legid = 0  \n" +
        "         AND d.t_dealid = l.t_dealid  \n" +
        "         AND l.t_price = 0   and " +  ClientQueryDt("d", "t_clientid") +"\n" +
        "         AND  not EXISTS  \n" +
        "                    (SELECT 1  \n" +
        "                       FROM ddl_leg_dbt l1, UDEPOOP_READYEXEC d1  \n" +
        "                      WHERE    l1.t_legkind = 0  \n" +
        "                            AND l1.t_legid = 0  \n" +
        "                            AND l1.t_dealid = d1.t_dealid  \n" +
        "                            AND D1.T_CLIENTID = d.t_clientid  \n" +
        "                            AND d1.t_pfi <> d.t_pfi  \n" +
        "                            AND l1.t_price <> 0) \n" +
        "                            and  \n" +
        "                             EXISTS  \n" +
        "                    (SELECT 1  \n" +
        "                       FROM ddl_leg_dbt l2, UNDFLOP_READYEXEC d2  \n" +
        "                      WHERE    l2.t_legkind = 0  \n" +
        "                            AND l2.t_legid = 0  \n" +
        "                            AND l2.t_dealid = d2.t_dealid  \n" +
        "                            AND D2.T_CLIENTID = d.t_clientid  \n" +
        "                            AND d2.t_pfi = d.t_pfi  \n" +
        "                            AND l2.t_price = 0)  \n" +
        "GROUP BY d.t_clientid \n" +
        ")  \n" ;
     if (_ДЕПО_НетЦен_НулевыеОтВТБ == 0)
        var Dt = TRsbDataSet(sql);
        Message("ДЕПО_НетЦен_НулевыеОтВТБ");
        if (Dt.movenext())
           _ДЕПО_НетЦен_НулевыеОтВТБ = Dt.cnt;
        end;
        //EndAction(50);
     end;
     return _ДЕПО_НетЦен_НулевыеОтВТБ;
   end;

/*
  private var _ПозицииВнеб_Всего = 0;
  private var _ПозицииВнеб_СЦенами = 0;
  private var _ПозицииВнеб_БезЦен = 0;
 */
   macro КлиентыВнеб_Всего(only_ex)
     var sql =  
        "  select count(1) cnt from ( \n" +
        "  SELECT d2.t_clientid \n" +
        "    FROM  ddl_leg_dbt l2, UDEPOOP_READYEXEC d2 \n" +
        "WHERE   l2.t_legkind = 0 \n" +
        "         AND l2.t_legid = 0 \n" +
        "         AND d2.t_dealid = l2.t_dealid and " + ClientQueryDt("d2", "t_clientid") +"\n" +
        "          and not exists (select 1 from ddl_limitsecurites_dbt s where s.t_limit_kind = 2 and t_market_kind = 'фондовый' " + iif (only_ex, "", "and s.t_security = l2.t_pfi") + " and d2.t_clientid = s.t_client) group by d2.t_clientid)  \n" ;

   //  if (_КлиентыВнеб_Всего == 0)
        var Dt = TRsbDataSet(sql);
        Message("_КлиентыВнеб_Всего");
        if (Dt.movenext())
           _КлиентыВнеб_Всего = Dt.cnt;
        end;
        //EndAction(50);
   //  end;
     return _КлиентыВнеб_Всего;
   end;

   macro КлиентыВнеб_НетЦен(only_ex)
     var sql =  
         "  select count(1) cnt from ( \n" +
         "  SELECT d2.t_clientid \n" +
         "    FROM  ddl_leg_dbt l2, UDEPOOP_READYEXEC d2 \n" +
         "WHERE   l2.t_legkind = 0 \n" +
         "         AND l2.t_legid = 0 \n" +
         "         AND d2.t_dealid = l2.t_dealid and " + ClientQueryDt("d2", "t_clientid") +"\n" +
         "         AND l2.t_price = 0 \n" +
         "                  AND  not EXISTS \n" +
         "                    (SELECT 1 \n" +
         "                       FROM ddl_leg_dbt l1, UDEPOOP_READYEXEC d1 \n" +
         "                      WHERE    l1.t_legkind = 0 \n" +
         "                            AND l1.t_legid = 0 \n" +
         "                            AND l1.t_dealid = d1.t_dealid \n" +
         "                            AND D1.T_CLIENTID = d2.t_clientid \n" +
         "                            AND d1.t_pfi <> d2.t_pfi \n" +
         "                            AND l1.t_price <> 0) \n" +
         "          and not exists (select 1 from ddl_limitsecurites_dbt s where s.t_limit_kind = 2 and t_market_kind = 'фондовый' " + iif (only_ex, "", "and s.t_security = l2.t_pfi") + " and d2.t_clientid = s.t_client) group by d2.t_clientid)  \n" ;

   //  if (_КлиентыВнеб_НетЦен == 0)
        var Dt = TRsbDataSet(sql);
        Message("_КлиентыВнеб_НетЦен");
        if (Dt.movenext())
           _КлиентыВнеб_НетЦен = Dt.cnt;
        end;
        //EndAction(50);
   //  end;
     return _КлиентыВнеб_НетЦен;
   end;

   macro КлиентыВнеб_ВсеЦены(only_ex)
     var sql =  
         "  select count(1) cnt from ( \n" +
         "  SELECT d2.t_clientid \n" +
         "    FROM  ddl_leg_dbt l2, UDEPOOP_READYEXEC d2 \n" +
         "WHERE   l2.t_legkind = 0 \n" +
         "         AND l2.t_legid = 0 \n" +
         "         AND d2.t_dealid = l2.t_dealid and " + ClientQueryDt("d2", "t_clientid") +"\n" +
         "         AND l2.t_price <> 0 \n" +
         "                  AND  not EXISTS \n" +
         "                    (SELECT 1 \n" +
         "                       FROM ddl_leg_dbt l1, UDEPOOP_READYEXEC d1 \n" +
         "                      WHERE    l1.t_legkind = 0 \n" +
         "                            AND l1.t_legid = 0 \n" +
         "                            AND l1.t_dealid = d1.t_dealid \n" +
         "                            AND D1.T_CLIENTID = d2.t_clientid \n" +
         "                            AND d1.t_pfi <> d2.t_pfi \n" +
         "                            AND l1.t_price = 0) \n" +
         "          and not exists (select 1 from ddl_limitsecurites_dbt s where s.t_limit_kind = 2 and t_market_kind = 'фондовый' " + iif ( only_ex, "", "and s.t_security = l2.t_pfi") + " and d2.t_clientid = s.t_client) group by d2.t_clientid)  \n" ;

   //  if (_КлиентыВнеб_ВсеЦены == 0)
        var Dt = TRsbDataSet(sql);
        Message("_КлиентыВнеб_ВсеЦены");
        if (Dt.movenext())
           _КлиентыВнеб_ВсеЦены = Dt.cnt;
        end;
        //EndAction(50);
   //  end;
     return _КлиентыВнеб_ВсеЦены;
   end;

   macro КлиентыВнеб_ЧастичноЦены(only_ex)
     var sql =  
         "  select count(1) cnt from ( \n" +
         "  SELECT d2.t_clientid \n" +
         "    FROM  ddl_leg_dbt l2, UDEPOOP_READYEXEC d2 \n" +
         "WHERE   l2.t_legkind = 0 \n" +
         "         AND l2.t_legid = 0 \n" +
         "         AND d2.t_dealid = l2.t_dealid and " + ClientQueryDt("d2", "t_clientid") +"\n" +
         "         AND l2.t_price <> 0 \n" +
         "                  AND   EXISTS \n" +
         "                    (SELECT 1 \n" +
         "                       FROM ddl_leg_dbt l1, UDEPOOP_READYEXEC d1 \n" +
         "                      WHERE    l1.t_legkind = 0 \n" +
         "                            AND l1.t_legid = 0 \n" +
         "                            AND l1.t_dealid = d1.t_dealid \n" +
         "                            AND D1.T_CLIENTID = d2.t_clientid \n" +
         "                            AND d1.t_pfi <> d2.t_pfi \n" +
         "                            AND l1.t_price = 0) \n" +
         "          and not exists (select 1 from ddl_limitsecurites_dbt s where s.t_limit_kind = 2 and t_market_kind = 'фондовый' " + iif ( only_ex, "", "and s.t_security = l2.t_pfi") + " and d2.t_clientid = s.t_client) group by d2.t_clientid)  \n" ;

    // if (_КлиентыВнеб_ЧастичноЦены == 0)
        var Dt = TRsbDataSet(sql);
        Message("_КлиентыВнеб_ЧастичноЦены");
        if (Dt.movenext())
           _КлиентыВнеб_ЧастичноЦены = Dt.cnt;
        end;
        //EndAction(50);
    // end;
     return _КлиентыВнеб_ЧастичноЦены;
   end;

   macro НОБ_Рассчитано()
     var sql =  
         "select count(1) cnt from dnptxop_dbt t \n" +
         "where t_dockind = 4605  \n" +
         " and " + ClientQueryDt("t", "t_client") +"\n" + 
         "and t_operdate = (select max(t_operdate) from dnptxop_dbt   where t_dockind = 4605  and t_code like 'VTB%')  \n" +
         "and t_code like 'VTB%' \n" ;

     if (_НОБ_Рассчитано == 0)
        var Dt = TRsbDataSet(sql);
        Message("НОБ_Рассчитано");
        if (Dt.movenext())
           _НОБ_Рассчитано = Dt.cnt;
        end;
        //EndAction(50);
     end;
     return _НОБ_Рассчитано;
   end;


   macro НОБ_РассчитатьНеобходимо()
     var sql =  
        "select count(oc.t_Client) cnt \n" +
        "                     from (select DISTINCT op.t_Client \n" +
        "                             from dnptxop_dbt op \n" +
        "                            where op.t_DocKind = 4605 \n" +
        "                              and op.t_OperDate >= " + GetSQLDate(BEGDATE_CHECK_NOB) + "\n" +
        "                              and op.t_IIS != 'X' \n" +
        "                          ) oc \n" +
        "                    where  " + ClientQueryDt("oc", "t_client") +"\n" 
        "                          AND EXISTS(SELECT 1  \n" +
        "                               FROM dobjcode_dbt \n" +
        "                              WHERE t_objectid = oc.t_Client \n" +
        "                                AND t_objecttype = 3 \n" +
        "                                AND t_codekind = 109 \n" +
        "                                AND t_state = 0) \n" ;


     if (_НОБ_РассчитатьНеобходимо == 0)
        var Dt = TRsbDataSet(sql);
        Message("_НОБ_РассчитатьНеобходимо");
        if (Dt.movenext())
           _НОБ_РассчитатьНеобходимо = Dt.cnt;
        end;
        //EndAction(50);
     end;
     return _НОБ_РассчитатьНеобходимо;
   end;



   macro GetArrErrors(namefile)
     var s="",dt1;
     private var ArrErrors = TArray();
     if (ExistsTable("uvtb_ndfl_log"))
        var sql = 
             "select s, cnt from ( \n" +
             "select s, count(1) cnt from  \n" +
             "(select  \n" +
             "case when t_s like '%Не найдено ДЕПО зачисление по%' then 'Не найдено ДЕПО зачисление' \n" +
             "when t_s like '%Не найдена ценная бумага по%' then 'Не найдена ценная бумага' \n" +
             "when t_s like '%Операция %уже загружалась%' then 'Операция уже загружалась' \n" +
             "when t_s like '%Не найден клиент с видом кода 109%' then 'Не найден клиент с видом кода 109' \n" +
             "when t_s like '%Не задано поле \"Curr\"%' then 'Не задано поле \"Curr\"' \n" +
             "when t_s like '%Не заданы поля \"ISIN\"%' then 'Не задано поле \"ISIN\"' \n" +
             "when t_s like '%Не задано поле \"Price\"%' then 'Не задано поле \"Price\"' \n" +
             "when t_s like '%Не найден ДБО%' then 'Не найден ДБО' \n" +
             "when t_s like '%Не удалость определить площадку%' then 'Не удалость определить площадку' \n" +
             "when t_s like '%Более одного ДБО по клиенту%' then 'Более одного ДБО по клиенту' \n" +
             "else t_s \n" +
             "end s \n" +
             " from uvtb_ndfl_log l where t_operdate = (select max(t_operdate) from uvtb_ndfl_log) "+
             " and not exists (select 1 from UVTB_CHECKOP_DBT t where T.T_CLIENTID = (select t_objectid from dobjcode_dbt where t_codekind = 109 and t_objecttype = 3 and t_state = 0 and t_code = t_gkk)  \n" +
             " and t.t_pfi = (select t_fiid from davoiriss_dbt a where a. t_isin = l.t_isin)  \n" +
             " and T.T_DEPO_SUM = t.t_ndfl_sum ) \n" +
" and t_s not like 'Не найден клиент с видом кода%' " +
" and t_s not like '%загружалась%' " +
" and t_s not like 'Не найден ДБО%' " ;

             if (ValType(namefile) != V_UNDEF)
                sql = sql + " and t_file like '%"+namefile+"%' ";
             end;
             sql = sql + ") group by s) order by cnt desc \n" ;

        var Dt = TRsbDataSet(sql);
        while (Dt.movenext())
           s = replace(Dt.s,"'","&quot;"); // DEF-56841, нужно экранировать одинарную кавычку, т.к. с ней sql не выполнится
           if (dt.s == "Операция уже загружалась") s = "Операция%уже загружалась"; end;
           if (dt.s == "Не задано поле \"ISIN\"") s = "Не заданы поля \"ISIN\""; end;
           sql = " select count(1) cnt from( select t_gkk from  uvtb_ndfl_log l  where t_operdate = (select max(t_operdate) from uvtb_ndfl_log) and t_s like '%"+s+"%'"+
             " and not exists (select 1 from UVTB_CHECKOP_DBT t where T.T_CLIENTID = (select t_objectid from dobjcode_dbt where t_codekind = 109 and t_objecttype = 3 and t_state = 0 and t_code = t_gkk)  \n" +
             " and t.t_pfi = (select t_fiid from davoiriss_dbt a where a. t_isin = l.t_isin)  \n" +
             " and T.T_DEPO_SUM = t.t_ndfl_sum ) \n" ;
           if (ValType(namefile) != V_UNDEF)
             sql = sql + " and t_file like '%"+namefile+"%' ";
           end;
           sql = sql + " group by t_gkk)";
           dt1 = TRsbDataSet(sql);
           dt1.movenext();
           ArrErrors[ArrErrors.size] = ErrRec(dt.s,dt.cnt, dt1.cnt);
        end;
      end;
      return ArrErrors;
   end;

end;

macro RunStatReport(errp:@string , result_protocol:@variant)
   var dt = date(21,6,2022);


   if (not GetDate(dt, "Отчет по срезу клиентов  за дату"));
     result_protocol.AddString(" Не задана дата " );
     return true;
   end;

   var Rep = _Report(dt);


     var R = CMakeReport("┌┬┬┬┬┬┬┬┬┬┬┬┐");

     private macro PrintValStr(s,v,d)
       R.AddPrintCell(s, 60, null, "l:ex_FS(b):ex_B(tblr)");
       R.AddPrintCell(v, 20, null, "r:ex_FS():ex_B(tblr)");
       if (ValType(d) != V_UNDEF) R.AddPrintCell(d, 20, null, "r:ex_FS():ex_B(tblr)");end;
       R.AddStr();
     end;

     BegAction(5, "Формирование отчета");

     R.SetDefaultFontName("Times New Roman");
     R.SetDefaultFontSize(12);
     R.SetFlagShowGrid(true);

     R.SetExecute("iBook.Sheets(1).Rows(1).WrapText = false;");
     R.AddEmptyStr();
     R.AddEmptyStr();
     R.AddPrintCell("Статистика на дату " + Rep.КлиентыНаДату(), 101, null, "c:ex_FS(b):ex_B()");
     R.AddStr();


     var EXCEL_MONEY = "\"##0,0000;-##0,0000;##0,0000\"";
     R.SetExecute("iBook.Sheets(1).Columns(2).NumberFormat = "+EXCEL_MONEY+";");
     R.AddEmptyStr();
   
     PrintValStr("Количество записей в 4-х реестрах ВТБ				",Rep.НДФЛ_ВсегоЗчс());
     PrintValStr("Из них загружено записей						",Rep.НДФЛ_ВсегоЗагружено());
     PrintValStr("Из них обработано записей					",Rep.НДФЛ_ВсегоОбработано());
     PrintValStr("Из них не обработано записей					",Rep.НДФЛ_ВсегоНеОбработано());
     PrintValStr("Из них не загружено записей					",Rep.НДФЛ_ВсегоНеЗагружено(),"Из-за КД:" + Rep.НДФЛ_ВсегоНеЗагруженоКД());
     R.AddEmptyStr();
     PrintValStr("Загружено клиентов (на "+Rep.КлиентыНаДату()+")			",Rep.КлиентыВТБ_Всего());
     PrintValStr("   Из них клиентов по которым были загружены Депо зачисления	",Rep.ДЕПО_Всего());
     PrintValStr("      Из них цена рассчитана полностью по клиентам		",Rep.ДЕПО_ВсеЦены());
     PrintValStr("      Из них цена рассчитана частично по клиентам		",Rep.ДЕПО_ЧастичноЦены(),"Передана нулевая цена:"+Rep.ДЕПО_ЧастичноЦены_НулевыеОтВТБ());
     PrintValStr("      Из них цена не рассчитана по клиентам			",Rep.ДЕПО_НетЦен(), "Передана нулевая цена:"+Rep.ДЕПО_НетЦен_НулевыеОтВТБ());
     R.AddEmptyStr();
     PrintValStr("   Из них клиентов с торгуемыми бумагами (по данным лимитов QUIK)",Rep.КлиентыQUIK_Всего());   
     PrintValStr("      Из них цена рассчитана полностью по клиентам	      ",Rep.КлиентыQUIK_ВсеЦены());    
     PrintValStr("      Из них цена рассчитана частично по клиентам	      ",Rep.КлиентыQUIK_ЧастичноЦены());
     PrintValStr("      Из них цена не рассчитана по клиентам	              ",Rep.КлиентыQUIK_НетЦен());
     PrintValStr("   Количество позиций в текущих лимитах QUIK	              ",Rep.ЛимитыQUIK_Всего());
     PrintValStr("      Из них цена рассчитана по позициям	                      ",Rep.ЛимитыQUIK_СЦенами());
     PrintValStr("      Из них цена нулевая              	                      ",Rep.ЛимитыQUIK_БезЦен());
     R.AddEmptyStr();
     PrintValStr("   Из них клиентов с НЕторгуемыми бумагами			",Rep.КлиентыВнеб_Всего());
     PrintValStr("      Из них цена рассчитана полностью по клиентам		",Rep.КлиентыВнеб_ВсеЦены());
     PrintValStr("      Из них цена рассчитана частично по клиентам		",Rep.КлиентыВнеб_ЧастичноЦены());  
     PrintValStr("      Из них цена не рассчитана по клиентам	        	",Rep.КлиентыВнеб_НетЦен()); 
     R.AddEmptyStr();
     PrintValStr("   Из них клиентов только с неторгуемыми ЦБ			",Rep.КлиентыВнеб_Всего(true));                    
     PrintValStr("      Из них полностью с ценами по клиентам			",Rep.КлиентыВнеб_ВсеЦены(true));                  
     PrintValStr("      Из них рассчитано частично по клиентам			",Rep.КлиентыВнеб_ЧастичноЦены(true));             
     PrintValStr("      Из них не расчитаны цены по клиентам			",Rep.КлиентыВнеб_НетЦен(true));                   
     R.AddEmptyStr();                                                                                
     PrintValStr("   Из них рассчитана НОБ по клиентам				",Rep.НОБ_РассчитатьНеобходимо());
     PrintValStr("      Из них НОБ расчитан полностью по клиентам			",Rep.НОБ_Рассчитано());
     PrintValStr("      Из них не исполнены зачисления или иные ошибки по клиентам	",0);
     R.AddEmptyStr();                                                                                
     R.AddEmptyStr();                                                                                
    
     var i, ar = TArray();
     ar = rep.GetArrErrors();
     for (i, ar)
         PrintValStr(i.ErrText,i.Count, i.Count_cl);
     end;

     var Dt1 = TrsbDataSet("select t_file from uvtb_ndfl_log where t_operdate = (select max(t_operdate) from uvtb_ndfl_log) group by t_file");
     while (Dt1.movenext())
        R.AddEmptyStr();                                                                                
        PrintValStr(Dt1.t_file,"");
        ar = rep.GetArrErrors(dt1.t_file);
        for (i, ar)
            PrintValStr(i.ErrText,i.Count, i.Count_cl);
        end;
     end;

     R.PrintWinRep("Отчет");
     R.SetZoomType(ZOOM_TYPE_A4L);
     R.SetWinRepOutput();
     R.ShowWinRep();



     result_protocol.AddString("Количество записей в 4-х реестрах ВТБ				"+Rep.НДФЛ_ВсегоЗчс());
     result_protocol.AddString("Из них загружено записей						"+Rep.НДФЛ_ВсегоЗагружено());
     result_protocol.AddString("Из них обработано записей					"+Rep.НДФЛ_ВсегоОбработано());
     result_protocol.AddString("Из них не обработано записей					"+Rep.НДФЛ_ВсегоНеОбработано(), Rep.НДФЛ_ВсегоНеОбработано_ткНеЗагружено);
     result_protocol.AddString("Из них не загружено записей					"+Rep.НДФЛ_ВсегоНеЗагружено());
     result_protocol.AddString("");
     result_protocol.AddString("Загружено клиентов (на "+Rep.КлиентыНаДату()+")			"+Rep.КлиентыВТБ_Всего());
     result_protocol.AddString("   Из них клиентов по которым были загружены Депо зачисления	"+Rep.ДЕПО_Всего());
     result_protocol.AddString("      Из них цена рассчитана полностью по клиентам		"+Rep.ДЕПО_ВсеЦены());
     result_protocol.AddString("      Из них цена рассчитана частично по клиентам		"+Rep.ДЕПО_ЧастичноЦены());
     result_protocol.AddString("      Из них цена не рассчитана по клиентам			"+Rep.ДЕПО_НетЦен());
     result_protocol.AddString("");
     result_protocol.AddString("   Из них клиентов с торгуемыми бумагами (по данным лимитов QUIK)"+Rep.КлиентыQUIK_Всего());   
     result_protocol.AddString("      Из них цена рассчитана полностью по клиентам	      "+Rep.КлиентыQUIK_ВсеЦены());    
     result_protocol.AddString("      Из них цена рассчитана частично по клиентам	      "+Rep.КлиентыQUIK_ЧастичноЦены());
     result_protocol.AddString("      Из них цена не рассчитана по клиентам	              "+Rep.КлиентыQUIK_НетЦен());
     result_protocol.AddString("   Количество позиций в текущих лимитах QUIK	              "+Rep.ЛимитыQUIK_Всего());
     result_protocol.AddString("      Из них цена рассчитана по позициям	                      "+Rep.ЛимитыQUIK_СЦенами());
     result_protocol.AddString("      Из них цена нулевая              	                      "+Rep.ЛимитыQUIK_БезЦен());
     result_protocol.AddString("");
     result_protocol.AddString("   Из них клиентов с НЕторгуемыми бумагами			"+Rep.КлиентыВнеб_Всего());
     result_protocol.AddString("      Из них цена рассчитана полностью по клиентам		"+Rep.КлиентыВнеб_ВсеЦены());
     result_protocol.AddString("      Из них цена рассчитана частично по клиентам		"+Rep.КлиентыВнеб_ЧастичноЦены());  
     result_protocol.AddString("      Из них цена не рассчитана по клиентам	        	"+Rep.КлиентыВнеб_НетЦен()); 
     result_protocol.AddString("");
     result_protocol.AddString("   Из них клиентов только с неторгуемыми ЦБ			"+Rep.КлиентыВнеб_Всего(true));                    
     result_protocol.AddString("      Из них полностью с ценами по клиентам			"+Rep.КлиентыВнеб_ВсеЦены(true));                  
     result_protocol.AddString("      Из них рассчитано частично по клиентам			"+Rep.КлиентыВнеб_ЧастичноЦены(true));             
     result_protocol.AddString("      Из них не расчитаны цены по клиентам			"+Rep.КлиентыВнеб_НетЦен(true));                   
     result_protocol.AddString("");
     result_protocol.AddString("   Из них необходимо пересчитать НОБ по клиентам		"+Rep.НОБ_РассчитатьНеобходимо());
     result_protocol.AddString("      Из них НОБ расчитан полностью по клиентам			"+Rep.НОБ_Рассчитано());
     result_protocol.AddString("      Из них не исполнены зачисления или иные ошибки по клиентам	"+0);
     result_protocol.AddString("");
     result_protocol.AddString("");
     result_protocol.AddString("Отчет сформирован " + time());
     EndAction();
     Message(" ");
return true;
OnError(er)
      result_protocol.AddString("Ошибка при формировании отчета ' " + er.Message + " Module:" + er.Module + " Line:" + er.Line);
      return false;
end;

   exit(1);

/*
[Статистика на дату	########## ](Rep.КлиентыНаДату());
[Количество записей в 4-х реестрах ВТБ	#############](Rep.НДФЛ_ВсегоЗчс():13:0);
[Из них загружено записей	        #############](Rep.НДФЛ_ВсегоЗагружено():13:0);
[Из них обработано записей	        #############](Rep.НДФЛ_ВсегоОбработано():13:0);   
[Из них не обработано записей	        #############](Rep.НДФЛ_ВсегоНеОбработано():13:0);   
[Из них не загружено записей	        #############](Rep.НДФЛ_ВсегоНеЗагружено():13:0);

[Загружено клиентов (на ##########)   ####################](Rep.КлиентыНаДату(), Rep.КлиентыВТБ_Всего():13:0);
[];
[	Из них клиентов по которым были загружены Депо зачисления     	######## ](Rep.ДЕПО_Всего():8:0);
[		Из них цена полностью по клиентам			######## ](Rep.ДЕПО_ВсеЦены():8:0);
[		Из них цена рассчитана частично по клиентам		######## ](Rep.ДЕПО_ЧастичноЦены():8:0);  
[		Из них цена не рассчитана по клиентам	        	######## ](Rep.ДЕПО_НетЦен():8:0); 
[];
[	Из них клиентов с торгуемыми бумагами (по данным лимитов QUIK)	######## ](Rep.КлиентыQUIK_Всего():8:0);
[		Из них цена рассчитана полностью по клиентам		######## ](Rep.КлиентыQUIK_ВсеЦены():8:0);
[		Из них цена рассчитана частично по клиентам		######## ](Rep.КлиентыQUIK_ЧастичноЦены():8:0);  
[		Из них цена не рассчитана по клиентам	        	######## ](Rep.КлиентыQUIK_НетЦен():8:0); 
[	Количество позиций в текущих лимитах QUIK	                ######## ](Rep.ЛимитыQUIK_Всего():8:0); 
[		Из них цена рассчитана по позициям		        ######## ](Rep.ЛимитыQUIK_СЦенами():8:0); 
[		Из них цена нулевая              	        	######## ](Rep.ЛимитыQUIK_БезЦен():8:0); 
[                                                                                        ] ;
[	Из них клиентов с НЕторгуемыми бумагами				######## ](Rep.КлиентыВнеб_Всего():8:0);
[		Из них цена рассчитана полностью по клиентам		######## ](Rep.КлиентыВнеб_ВсеЦены():8:0);
[		Из них цена рассчитана частично по клиентам		######## ](Rep.КлиентыВнеб_ЧастичноЦены():8:0);  
[		Из них цена не рассчитана по клиентам	        	######## ](Rep.КлиентыВнеб_НетЦен():8:0); 

[	Из них клиентов только с неторгуемыми ЦБ			######## ](Rep.КлиентыВнеб_Всего(true):8:0);                    
[		Из них полностью с ценами по клиентам			######## ](Rep.КлиентыВнеб_ВсеЦены(true):8:0);                  
[		Из них рассчитано частично по клиентам			######## ](Rep.КлиентыВнеб_ЧастичноЦены(true):8:0);             
[		Из них не расчитаны цены по клиентам			######## ](Rep.КлиентыВнеб_НетЦен(true):8:0);                   
[                                                                                        ];
[      Из них рассчитана НОБ по клиентам	                        ########](Rep.НОБ_РассчитатьНеобходимо());
[	Из них НОБ расчитан полностью по клиентам			########](Rep.НОБ_Рассчитано());
[	Из них не исполнены зачисления или иные ошибки по клиентам	              ];
*/
