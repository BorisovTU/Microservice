IMPORT "qracctools.mac";

private macro findScqracc(p_Storage, p_Fiid, p_AccCode, p_PartCode)
  var sql, cmd, x_AccID : integer = 0;

  sql =  "DECLARE "
       + "  x_AccID number := -1; "
       + "BEGIN "
       + "  SELECT q.t_accountid INTO x_AccID FROM dscqracc_dbt q "
       + "  WHERE "
       + "     q.t_StorageId  = :p_Storage and q.t_Fiid = :p_Fiid "
       + "   and q.t_DepoAccCode = :p_AccCode and q.t_DepoPartCode = nvl(:p_PartCode, chr(1)) "
       + "   and rownum = 1 "
       + "   ; "
       + "   :p_AccID := x_AccID; "
       + "EXCEPTION WHEN OTHERS THEN "
       + "   :p_AccID := -1; "
       + "END; "
  ;
  cmd = RSDCommand(sql);
  cmd.addParam("p_Storage", RSDBP_IN, p_Storage);
  cmd.addParam("p_Fiid", RSDBP_IN, p_Fiid);
  cmd.addParam("p_AccCode", RSDBP_IN, p_AccCode);
  cmd.addParam("p_PartCode", RSDBP_IN, p_PartCode);
  cmd.addParam("p_AccID", RSDBP_OUT, V_INTEGER);
  cmd.execute();
  x_AccID = cmd.value("p_AccID");

   return x_AccID;
end;

private macro correctScqraccDate(p_Acc, p_OnDate)
  var sql, cmd, x_Ret : integer = -1;

  sql =  "DECLARE "
       + "  x_Acc NUMBER := :p_Acc; "
       + "  x_Cs NUMBER; "
       + "  x_OnDate DATE := :p_OnDate; "
       + "BEGIN "
       + "  update dacctrn_dbt r "
       + "     set r.t_date_carry = x_OnDate, r.t_date_rate = x_OnDate "
       + "     where r.t_accountid_payer = x_Acc "
       + "     returning t_accountid_receiver into x_Cs; "
       + "  update daccount_dbt r "
       + "    set r.t_open_date = x_OnDate "
       + "    where r.t_accountid in (x_Acc, x_Cs); "
       + "  update drestdate_dbt r "
       + "    set r.t_restdate = x_OnDate "
       + "    where r.t_accountid in (x_Acc, x_Cs); "
       + "  commit; "
       + "   :p_Ret := 0; "
       + "EXCEPTION WHEN OTHERS THEN "
       + "   :p_Ret := -1; "
       + "END; "
  ;
  cmd = RSDCommand(sql);
  cmd.addParam("p_Acc", RSDBP_IN, p_Acc);
  cmd.addParam("p_OnDate", RSDBP_IN, p_OnDate);
  cmd.addParam("p_Ret", RSDBP_OUT, V_INTEGER);
  cmd.execute();
  x_Ret = cmd.value("p_Ret");

   return x_Ret;
end;


macro AddQrAcc( p_StorageID:integer, p_FIID: integer, p_DpAcc: string, p_DpPart: string, p_Rest:money, p_OnDate:date )

    var ScQrAccTO = TRecHandler("scqracc.dbt");
    var err: integer;
    var erStr: string;
    var x_AccID : integer = -1;

    ScQrAccTO.Clear();
    ScQrAccTO.rec.StorageId = p_StorageID;
    ScQrAccTO.rec.Fiid      = p_FIID;
    ScQrAccTO.rec.DepoAccCode = p_DpAcc;
    ScQrAccTO.rec.DepoPartCode = p_DpPart;

    println("");
    println("AddQrAcc(), p_StorageID: " + string(p_StorageID) + ", p_FIID: "+string(p_FIID) + ", p_DpAcc: " + string(p_DpAcc) + ", p_DpPart: " + string(p_DpPart));
    x_AccID = findScqracc(p_StorageID, p_FIID, p_DpAcc, p_DpPart);
    println("x_AccID: " + string(x_AccID));
    if (x_AccID == -1 )
      println("Не существует записи КДУ");
      err = СоздатьЗаписьВРегистреКДУ(ScQrAccTO, {curdate}, p_Rest, ErStr);      
      println("err: " + string(err) + ", ErStr: " + string(ErStr) );
      if(err == 0) 
        x_AccID = findScqracc(p_StorageID, p_FIID, p_DpAcc, p_DpPart);
        println("x_AccID: " + string(x_AccID));
      end;
    end;

    // теперь нужно произвести корректировку дат для счета
    if (x_AccID != -1 )
      println("Корректировка дат ");
      err = correctScqraccDate(x_AccID, p_OnDate);
      println("err: " + string(err) );
    end;

    if (err == 0)
      println("Обработано успешно");
      return 1;
    else 
      println("Ошибка обработки");
      return 0;
    end;
end;

var Processed: integer = 0;
var MustProcessed: integer = 9;

println("DEF-61943 start");
// АО "ВТБ Регистратор
Processed = Processed + AddQrAcc( 114230, 2110, "59", "", $6299300, date(4,3,2015));  	// lsin = '1-01-10154-Z'
Processed = Processed + AddQrAcc( 114230, 2111, "59", "", $106999, date(4,3,2015));	// lsin = '2-01-10154-Z'
// АО "СД "ИНФИНИТУМ
Processed = Processed + AddQrAcc( 115111, 2024, "1", "", $60000, date(22,5,2014));    	// isin = 'RU000A0ZZMH8'
Processed = Processed + AddQrAcc( 115111, 2001, "1", "", $10000, date(22,5,2014));    	// isin = 'RU000A0ZZME5'
Processed = Processed + AddQrAcc( 115111, 2000, "1", "", $10000, date(28,5,2014));    	// isin = 'RU000A0ZZMG0'
Processed = Processed + AddQrAcc( 115111, 1215, "1", "", $10000, date(26,3,2013));    	// isin = 'RU000A0ZZMG0'
// АО "Новый Регистратор"
Processed = Processed + AddQrAcc( 131470, 2278, "5", "", $7700, date(1,1,2019));    	// lsin = '1-01-80179-N'
Processed = Processed + AddQrAcc( 131470, 2220, "17", "", $111112, date(1,1,2019));    	// lsin = '1-01-50529-A'
// АО "Регистраторское общество "СТАТУС"
Processed = Processed + AddQrAcc( 131466, 432, "1003545", "", $6300, date(1,1,2019)); 	// lsin = '1-01-10567-A'

println("");
println("Обработано: "+string(Processed));
println("Нужно было обработать: "+string(MustProcessed));
if(Processed == MustProcessed) 
  println("Обработаны все счета");
else 
  println("Обработаны не все счета");
end;

println("");
println("DEF-61943 end");



