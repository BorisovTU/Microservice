IMPORT CbLogger;
IMPORT RSD;

/**
@brief 				Скрипт копирования данных из таблицы SOFR_DIASDEPORESTFULL в 
*/
macro MoveDiasRest()
  var sql, cmd, parallelCount: INTEGER = 6;
 
  LogIt("MoveDiasRest() start");

  sql =  "DECLARE "
       + "BEGIN "
       + "    rshb_dias_utl.MoveDiasRest(?); "
       + "END; "
  ;
    
  cmd = RSDCommand(sql);
  cmd.addParam("", RSDBP_IN, parallelCount);
  cmd.execute();

  LogIt("MoveDiasRest() end");
end;


/**
@brief 				Скрипт переключения таблиц сверки данных с Диасофт на новый комплект. 
*/
macro FixView()
  var sql, cmd, p_Ret:INTEGER;
 
  LogIt("FixView() start");

  sql =  "DECLARE "
       + " x_Ret number := :Ret; "
       + "BEGIN "
       + "    rshb_dias_utl.FixView(x_Ret); "
       + "    :Ret := x_Ret; "
       + "END; "
  ;
    
  cmd = RSDCommand(sql);
  cmd.addParam("Ret", RSDBP_OUT, V_INTEGER);
  cmd.execute();
  p_Ret = cmd.value("Ret");

  if(p_Ret = 0)
    LogIt("Скрипт переключения отработал корректно");
    LogIt("Созданы представления SOFR_DIASDEPORESTFULL");
  else
    LogIt("Произошла ошибка при выполнении процедуры rshb_dias_utl.FixView()");
    LogIt("Смотри журнал");
    LogIt("FixView: "+string(p_Ret));
  end;
end;

InitCbLog(1, "DEF-61499");
LogIt("DEF-61499 start");

MoveDiasRest(); // копирование данных
FixView();      // фиксация представлений

LogIt("DEF-61499 end");