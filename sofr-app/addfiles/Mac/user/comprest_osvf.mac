import RSD;

const K_ENTER   = 13;
const K_ESC     = 27;
const K_F5      = 319;
const K_F6      = 320;

PRIVATE MACRO AddCol (ar,ind, fld, head, width, rdonly,  dp)
   ar.value (ind * 6)     = fld;
   ar.value (ind * 6 + 1) = head;
   ar.value (ind * 6 + 2) = width;
   ar.value (ind * 6 + 3 ) = rdonly;   // fldType
   ar.value (ind * 6 + 4 ) = dp;//   decPoint
   ar.value (ind * 6 + 5 ) = 0;   // reserv
END;

var shift = 0, kind = 0, cdate = date(9,1,2019), dsum = $0.00;

macro Scroll
   var sql, cmd, rs, col1, need = true,Column = TArray(),i, ColumnValue, ColumnName, NumColumns = 0, titl;

   macro EvProc(rs, cmd, id, key)
     var  CM_DEFAULT = null;
     if (cmd == DLG_INIT)
        EndAction;
     elif (cmd == DLG_KEY)
        if (key == K_F5)
          if (getDate(cdate, "Укажите дату:"))
             need = true;
             return CM_SELECT;
          end;
        elif (key == K_F6)
          if (getMoney(dsum, "Укажите сумму:"))
             need = true;
             if (rs.RecCount > 0)
              return CM_SELECT;
             end;
          end;
        elif (key == K_ESC)
          return 2;
        end;
     end;
     return CM_DEFAULT;
  end;

   col1 = TArray;   

   AddCol (col1, 0, "acc",           "Счет",    20,  true);
   AddCol (col1, 1, "sin_cur_rest",  "Валютный вх остаток СОФР", 20, true, 2);
   AddCol (col1, 2, "cin_cur_rest",  "Валютный вх остаток БИС", 20, true, 2);
   AddCol (col1, 3, "dev1",       "Расхождение",       20, true, 2);
   AddCol (col1, 4, "sin_rub_rest",  "Рублевый вх остаток СОФР", 20, true, 2);
   AddCol (col1, 5, "cin_rub_rest",  "Рублевый вх остаток БИС", 20, true, 2);
   AddCol (col1, 6, "dev2",       "Расхождение",       20, true, 2);
   AddCol (col1, 7, "sdeb_cur",  "Дт оборот валюта СОФР", 20, true, 2);
   AddCol (col1, 8, "cdeb_cur",  "Дт оборот валюта БИС", 20, true, 2);
   AddCol (col1, 9, "dev3",       "Расхождение",       20, true, 2);
   AddCol (col1,10, "sdeb_rub",  "Дт оборот рубли СОФР", 20, true, 2);
   AddCol (col1,11, "cdeb_rub",  "Дт оборот рубли БИС", 20, true, 2);
   AddCol (col1,12, "dev4",       "Расхождение",       20, true, 2);
   AddCol (col1,13, "scrd_cur",  "Кт оборот валюта СОФР", 20, true, 2);
   AddCol (col1,14, "ccrd_cur",  "Кт оборот валюта БИС", 20, true, 2);
   AddCol (col1,15, "dev5",       "Расхождение",       20, true, 2);
   AddCol (col1,16, "scrd_rub",  "Кт оборот рубли СОФР", 20, true, 2);
   AddCol (col1,17, "ccrd_rub",  "Кт оборот рубли БИС", 20, true, 2);
   AddCol (col1,18, "dev6",       "Расхождение",       20, true, 2);
   AddCol (col1,19, "sout_cur_rest",  "Валютный исх остаток СОФР", 20, true, 2);
   AddCol (col1,20, "cout_cur_rest",  "Валютный исх остаток БИС", 20, true, 2);
   AddCol (col1,21, "dev7",       "Расхождение",       20, true, 2);
   AddCol (col1,22, "sout_rub_rest",  "Рублевый исх остаток СОФР", 20, true, 2);
   AddCol (col1,23, "cout_rub_rest",  "Рублевый исх остаток БИС", 20, true, 2);
   AddCol (col1,24, "dev8",       "Расхождение",       20, true, 2);

   while (need)
      need = false;
      BegAction(0, "Ждите, формируется список ...", false);
      sql =
"select nvl(s.acc, c.acc) acc\n" +
"      , s.in_cur_rest sin_cur_rest\n" + 
"      , c.in_cur_rest cin_cur_rest\n" + 
"      , nvl(s.in_cur_rest,0) - nvl(c.in_cur_rest,0) dev1\n" + 
"      , s.in_rub_rest sin_rub_rest\n" + 
"      , c.in_rub_rest cin_rub_rest\n" + 
"      , nvl(s.in_rub_rest,0) - nvl(c.in_rub_rest,0) dev2\n" + 
"      , s.deb_cur sdeb_cur\n" + 
"      , c.deb_cur cdeb_cur\n" + 
"      , nvl(s.deb_cur,0) - nvl(c.deb_cur,0) dev3\n" + 
"      , s.deb_rub sdeb_rub\n" + 
"      , c.deb_rub cdeb_rub\n" + 
"      , nvl(s.deb_rub,0) - nvl(c.deb_rub,0) dev4\n" + 
"      , s.crd_cur scrd_cur\n" + 
"      , c.crd_cur ccrd_cur\n" + 
"      , nvl(s.crd_cur,0) - nvl(c.crd_cur,0) dev5\n" + 
"      , s.crd_rub scrd_rub\n" + 
"      , c.crd_rub ccrd_rub\n" + 
"      , nvl(s.crd_rub,0) - nvl(c.crd_rub,0) dev6\n" + 
"      , s.out_cur_rest sout_cur_rest\n" + 
"      , c.out_cur_rest cout_cur_rest\n" + 
"      , nvl(s.out_cur_rest,0) - nvl(c.out_cur_rest,0) dev7\n" + 
"      , s.out_rub_rest sout_rub_rest\n" + 
"      , c.out_rub_rest cout_rub_rest\n" + 
"      , nvl(s.out_rub_rest,0) - nvl(c.out_rub_rest,0) dev8\n" + 
"  from (\n" + 
"select stbl.*\n" + 
"  from ( select ra.t_account acc,\n" + 
"          fi.t_fi_code cur,\n" + 
"          nvl(rc.t_rest, 0) in_cur_rest,\n" + 
"          nvl(rr.t_rest, 0) in_rub_rest,\n" + 
"          nvl(rcd.t_debet, 0) + nvl(rcd.t_debetspod, 0) deb_cur,\n" + 
"          nvl(rrd.t_debet, 0) + nvl(rrd.t_debetspod, 0) deb_rub,\n" + 
"          nvl(rcd.t_credit, 0) + nvl(rcd.t_creditspod, 0) crd_cur,\n" + 
"          nvl(rrd.t_credit, 0) + nvl(rrd.t_creditspod, 0) crd_rub,\n" + 
"          coalesce(rcd.t_rest,rcu.t_rest, 0) out_cur_rest,\n" + 
"          coalesce(rrd.t_rest,rru.t_rest, 0) out_rub_rest\n" + 
"  from daccount_dbt ra\n" + 
"  inner join dfininstr_dbt fi\n" + 
"     on (ra.t_code_currency = fi.t_fiid)\n" + 
"  left join drestdate_dbt rc\n" + 
"    on (rc.t_accountid = ra.t_accountid  and rc.t_restcurrency =  decode(ra.t_code_currency, 0, -100, ra.t_code_currency) and rc.t_restdate = (select max(t_restdate) from drestdate_dbt where t_accountid = ra.t_accountid and t_restcurrency = decode(ra.t_code_currency, 0, -100, ra.t_code_currency) and t_restdate < to_date(:cdate, 'dd.mm.yyyy')))\n" + 
"  left join drestdate_dbt rr\n" + 
"    on (rr.t_accountid = ra.t_accountid  and rr.t_restcurrency =  0 and rr.t_restdate = (select max(t_restdate) from drestdate_dbt where t_accountid = ra.t_accountid and t_restcurrency = 0 and t_restdate < to_date(:cdate, 'dd.mm.yyyy')))\n" + 
"  left join drestdate_dbt rcu\n" + 
"    on (rcu.t_accountid = ra.t_accountid  and rcu.t_restcurrency =  decode(ra.t_code_currency, 0, -100, ra.t_code_currency) and rcu.t_restdate = (select max(t_restdate) from drestdate_dbt where t_accountid = ra.t_accountid and t_restcurrency = decode(ra.t_code_currency, 0, -100, ra.t_code_currency) and t_restdate <= to_date(:cdate, 'dd.mm.yyyy')))\n" + 
"  left join drestdate_dbt rru\n" + 
"    on (rru.t_accountid = ra.t_accountid  and rru.t_restcurrency =  0 and rru.t_restdate = (select max(t_restdate) from drestdate_dbt where t_accountid = ra.t_accountid and t_restcurrency = 0 and t_restdate <= to_date(:cdate, 'dd.mm.yyyy')))\n" + 
"  left join drestdate_dbt rcd\n" + 
"    on (rcd.t_accountid = ra.t_accountid  and rcd.t_restcurrency =  decode(ra.t_code_currency, 0, -100, ra.t_code_currency) and rcd.t_restdate = to_date(:cdate, 'dd.mm.yyyy'))\n" + 
"  left join drestdate_dbt rrd\n" + 
"    on (rrd.t_accountid = ra.t_accountid  and rrd.t_restcurrency =  0 and rrd.t_restdate = to_date(:cdate, 'dd.mm.yyyy'))\n" + 
"  WHERE (ra.t_account in (select distinct replace(acc, '-') from bis_balancef)) \n" + 
"    and (ra.t_open_close = chr(0) or  (ra.t_close_date >= to_date(:cdate, 'dd.mm.yyyy')))\n" + 
") stbl) s\n" + 
"  full join\n" + 
" (select ctbl.*\n" + 
" from (select replace(acc, '-') acc, nvl(cur, '810') cur,\n" + 
"    to_number(case when trim(in_cur_rest) = '-' then\n" + 
"                               '0'\n" + 
"                            when instr(inr_dc, 'Дб') > 0 then\n" + 
"                              replace( '-' || replace(in_cur_rest, ' '), ',')\n" + 
"                            else\n" + 
"                              replace(replace(in_cur_rest, ' '), ',', '')\n" + 
"                     end, '999999999999999999999999.999999999999999') in_cur_rest,\n" + 
"    to_number(case when trim(in_rub_rest) = '-' then\n" + 
"                               '0'\n" + 
"                            when instr(inr_dc, 'Дб') > 0 then\n" + 
"                              replace( '-' || replace(in_rub_rest, ' '), ',')\n" + 
"                            else\n" + 
"                              replace(replace(in_rub_rest, ' '), ',', '')\n" + 
"                     end, '999999999999999999999999.999999999999999') in_rub_rest,\n" + 
"    to_number(case when trim(deb_cur) = '-' then\n" + 
"                               '0'\n" + 
"                            else\n" + 
"                              replace(replace(deb_cur, ' '), ',' )\n" + 
"                     end, '999999999999999999999999.999999999999999') deb_cur,\n" + 
"    to_number(case when trim(deb_rub) = '-' then\n" + 
"                               '0'\n" + 
"                            else\n" + 
"                              replace(replace(deb_rub, ' '), ',' )\n" + 
"                     end, '999999999999999999999999.999999999999999') deb_rub,\n" + 
"    to_number(case when trim(crd_cur) = '-' then\n" + 
"                               '0'\n" + 
"                            else\n" + 
"                              replace(replace(crd_cur, ' '), ',' )\n" + 
"                     end, '999999999999999999999999.999999999999999') crd_cur,\n" + 
"    to_number(case when trim(crd_rub) = '-' then\n" + 
"                               '0'\n" + 
"                            else\n" + 
"                              replace(replace(crd_rub, ' '), ',' )\n" + 
"                     end, '999999999999999999999999.999999999999999') crd_rub,\n" + 
"    to_number(case when trim(out_cur_rest) = '-' then\n" + 
"                               '0'\n" + 
"                            when instr(outr_dc, 'Дб') > 0 then\n" + 
"                              replace( '-' || replace(out_cur_rest, ' '), ',')\n" + 
"                            else\n" + 
"                              replace(replace(out_cur_rest, ' '), ',', '')\n" + 
"                     end, '999999999999999999999999.999999999999999') out_cur_rest,\n" + 
"    to_number(case when trim(out_rub_rest) = '-' then\n" + 
"                               '0'\n" + 
"                            when instr(outr_dc, 'Дб') > 0 then\n" + 
"                              replace( '-' || replace(out_rub_rest, ' '), ',')\n" + 
"                            else\n" + 
"                              replace(replace(out_rub_rest, ' '), ',', '')\n" + 
"                     end, '999999999999999999999999.999999999999999') out_rub_rest\n" + 
"    from bis_balancef\n" + 
"  where bdate = to_date(:cdate,'dd.mm.yyyy')\n" + 
") ctbl ) c\n" + 
"  on (s.acc = c.acc)\n" + 
"where (s.acc is null or c.acc is null)\n" +
"  or (((s.in_rub_rest <> c.in_rub_rest)  and (abs(s.in_rub_rest - c.in_rub_rest) >:csum) )\n" + 
"    or ((s.in_cur_rest <> c.in_cur_rest)  and (abs(s.in_cur_rest - c.in_cur_rest) >:csum) )\n" + 
"    or ((s.out_cur_rest <> c.out_cur_rest)  and (abs(s.out_cur_rest - c.out_cur_rest) >:csum) )\n" + 
"    or ((s.out_rub_rest <> c.out_rub_rest)  and (abs(s.out_rub_rest - c.out_rub_rest) >:csum) )\n" + 
"    or ((s.deb_rub <> c.deb_rub)  and (abs(s.deb_rub - c.deb_rub) >:csum) )\n" + 
"    or ((s.deb_cur <> c.deb_cur)  and (abs(s.deb_cur - c.deb_cur) >:csum) )\n" + 
"    or ((s.crd_rub <> c.crd_rub)  and (abs(s.crd_rub - c.crd_rub) >:csum) )\n" + 
"    or ((s.crd_cur <> c.crd_cur)  and (abs(s.crd_cur - c.crd_cur) >:csum) )\n" + 
"   )\n" + 
"  order by s.acc";



      cmd = RSDCommand(sql);
      cmd.AddParam("cdate1", RSDBP_IN, strsubst(string(cdate), " ", "0"));
      cmd.AddParam("cdate2", RSDBP_IN, strsubst(string(cdate), " ", "0"));
      cmd.AddParam("cdate3", RSDBP_IN, strsubst(string(cdate), " ", "0"));
      cmd.AddParam("cdate4", RSDBP_IN, strsubst(string(cdate), " ", "0"));
      cmd.AddParam("cdate5", RSDBP_IN, strsubst(string(cdate), " ", "0"));
      cmd.AddParam("cdate6", RSDBP_IN, strsubst(string(cdate), " ", "0"));
      cmd.AddParam("cdate7", RSDBP_IN, strsubst(string(cdate), " ", "0"));
      cmd.AddParam("cdate8", RSDBP_IN, strsubst(string(cdate), " ", "0"));
      cmd.AddParam("csum1",  RSDBP_IN, dsum);
      cmd.AddParam("csum2",  RSDBP_IN, dsum);
      cmd.AddParam("csum3",  RSDBP_IN, dsum);
      cmd.AddParam("csum4",  RSDBP_IN, dsum);
      cmd.AddParam("csum5",  RSDBP_IN, dsum);
      cmd.AddParam("csum6",  RSDBP_IN, dsum);
      cmd.AddParam("csum7",  RSDBP_IN, dsum);
      cmd.AddParam("csum8",  RSDBP_IN, dsum);


      rs = RSDRecordset(cmd , null, RSDVAL_STATIC );

   //   EndAction;
      if (dsum == $0.00)
        titl = " (все расхождения)";
      else
        titl = " (расхождения более " + trim(string(dsum:20:2)) + ")";
      end;
      if (RunScroll (rs, 25, col1, "test" ,"EvProc","Сверка остатков по ОСВ (срочный рынок) за " + strsubst(string(cdate), " ", "0") + titl  ,"F5 - Изменить дату  F6 - Изменить сумму  ESC - Выход", true, 1, 1))
       //   return rs1;
      end;
   end;

return null;

end;
if (getDate(cdate, "Укажите дату:"))
  Scroll;
end;
exit(1);