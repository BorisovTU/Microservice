import activex, oralib, likepy, BankInter, DVInter, globals, rsd,RsbDataSet, PTInter,CTinter,"cb_sql.mac" ;

macro correct_transactionVU()
var er = 0;
var cmd, row,badrow,okRow,result;
var NeedUpdate;
var accTrn = RsbAccTransaction;

row=0;
okRow=0;
badrow=0;
//UseProgress(row); 
  cmd = RSDCommand( "    SELECT /*trn.t_account_payer, trn.t_account_receiver*/   " +
                     "      trn.t_acctrnid                                      " +
                     "     FROM doproper_dbt do , ddvoper_dbt op ,doprdocs_dbt opr, dacctrn_dbt trn  " +
                     "     WHERE    " +
                     "     do.t_kind_operation=12600  " +
                     "     AND do.t_documentid=lpad(op.t_id,34,'0')  " +
                     "     AND op.t_flag1=1 " +
                     "     AND opr.t_dockind=1 " +
                     "     AND opr.t_id_operation=do.t_id_operation " +
                     "     AND trn.t_acctrnid = opr.t_acctrnid " +
                     "     AND trn.t_chapter=21 " +
                     "     AND NOT (trn.t_account_payer= '10810990000000000268' AND trn.t_account_receiver='10810990000000000001') " 
                           );
   cmd.execute();
   InitProgress(SQL_GetNRecs(cmd.cmdtext));
   result = TRsbDataSet(cmd);
   while (result.movenext())
      er = accTrn.Find(result.value(0));
      if(er == 0)
        NeedUpdate= false; 
        if (accTrn.accountpayer=="10810990000000000001")
          accTrn.accountpayer   ="10810990000000000268";
          NeedUpdate=true;
        elif (accTrn.accountreceiver=="10810990000000000001")  
          accTrn.accountreceiver   ="10810990000000000268";
          Needupdate=true;
        end;  
        if (NeedUpdate)
          if (not accTrn.Update())
            badrow=badrow+1;
            Println("Ошибка при обновлении проводки с идентификатором ="+result.value(0));
          else
            okRow=okRow+1;  
          end ;
        end;  
      end;
    UseProgress(row=row+1);
   end; 
     
  RemProgress();
  Println("Обработано строк : " + row); 
  Println("Успешно обрабтано -"+ okRow);
  Println("С ошибкой         -"+badrow);
  row=row-badrow-okRow;
  Println("Пропущено         -"+row);
 // EndAction(1);
onerror()
  EndAction(1); 
end;

correct_transactionVU();