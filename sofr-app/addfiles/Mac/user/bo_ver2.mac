import Oralib, rsd,globals, likepy, RsbDataSet;
private record deal     (dl_tick);
private record panel    (reentry4, "BO_oper.lbr" ) dialog;
private record errpanel (err4    , "BO_oper.lbr" ) dialog;
private record panel2   (reentry5, "BO_oper.lbr" ) dialog;
private record errpanel2(err5    , "BO_oper.lbr" ) dialog;

private var _code = 0, _dealId = 0; 
private var Deal_main, Deal_dlg;
private var Deal_pay, Deal_get,  Deal_pay_dlg, Deal_get_dlg;

private class CDeal (id)
      var dealId, currency,  price, NKD, PayDate, SupDate, dealDate, convers;
      var summ_BA, cur_BA, price_BA;

      macro InitFields ()
            this.dealId   = 0;
            this.dealDate = date(0,0,0);
            this.currency  = 0;
            this.price  = 0;
            this.NKD  = 0;
            this.PayDate = date(0,0,0);
            this.SupDate = date(0,0,0);
      end;

      macro getDealInfo (id, type)
            var sql, rs;                                                                                                                                               
            sql ="  select tick. t_dealdate, fi.t_codeinaccount, fiv.t_facevalue, leg.t_price, leg.t_nkd,                                                              "+
                 "  (select  t_plandate from ddlgrdeal_dbt where t_dockind = 101 and t_templnum = 15 and t_docid = tick.t_dealid),                                     "+
                 "  (select  t_plandate from ddlgrdeal_dbt where t_dockind = 101 and t_templnum = 17 and t_docid = tick.t_dealid)                                      "+
                 "    from ddl_tick_dbt tick                                                                                                                           "+
                 "  join ddl_leg_dbt leg  on leg.t_dealid = tick.t_dealid                                                                                              "+
                 "  join dfininstr_dbt fi on leg.t_cfi =fi.t_fiid                                                                                                      "+
                 "  join DV_FI_FACEVALUE_HIST fiv on FIV.T_FIID = LEG.T_PFI and (fiv.t_enddate>=  tick. t_dealdate or fiv.t_enddate = to_date('01010001', 'ddmmyyyy')) "+
                 "        and FIV.T_BEGDATE <=tick.t_dealdate                                                                                                          "+
                 "  where tick.t_dealid = :dealid                                                                                                                      ";
      
            sql = rsdcommand (sql);
            
            sql.addParam(":dealid", RSDBP_IN, id);
            rs  = rsdrecordset (sql);

      return rs;
        OnError(er)
           MsgBox (er.Message,"| Модуль: ",er.Module,"| строка: ",er.Line );
           return false;
      end;

      macro compareWithDeal (deal2)
            /*01.09.2020 RAS 515250*/
            var pointer, queryP, sqlP, dataP;
            sqlP ="  SELECT t_point " +
                      "FROM ddl_leg_dbt " +
                     "WHERE t_dealid = ?";
            
            queryP = RSDCommand( sqlP );
            queryP.addParam("", RSDBP_IN, this.dealId );
            queryP.execute();
            
            dataP = TRsbDataSet(queryP);
            if( dataP.movenext() )
              pointer = dataP.Point;
            end;
            if( pointer == NULL )
              pointer = 8;
            end;
            /*~RAS*/
            if ( 
                 (this.dealDate != deal2.dealDate) or
                 (this.currency != deal2.currency  ) or
                 (round(this.price, /*8*/pointer)    != round(deal2.price, /*8*/pointer))  or //RAS 515250
                 //(this.NKD      != deal2.NKD)  or
                 (round(double(this.NKD), pointer) != round(double(deal2.NKD), pointer))  or // Golovkin 20.10.2021 ID : 534708 у RSL какие-то проблемы со сравнением 2071.2400 Numeric и 2071.2400 Double 
                 (this.PayDate  != deal2.PayDate)  or
                 (this.SupDate  != deal2.SupDate ) 
                ) 
                 return false;
            else 
               return true;
            end;
      end;
 
     macro loadDealInfo (id, type)
            private var m_rs = getDealInfo (id, type);  
              
            if (m_rs.movenext () )
                 this.dealId   = id;
                 this.dealDate = m_rs.value(0);
                 this.currency = m_rs.value(1);
                 this.price    = m_rs.value(3);
                 this.NKD      = m_rs.value(4);
                 this.PayDate  = m_rs.value(5);
                 this.SupDate  = m_rs.value(6);
            else
                 InitFields();   
            end;
      end;

      macro _extObj()
            return this;
      end;
      
      if (id != null )
         loadDealInfo (id);
      else
         InitFields();    
      end;   
end;

private class (CDeal) CDealOption (id)
      var  price1, PayDate1, SupDate1,price2, PayDate2, SupDate2, NKD1, NKD2;



      macro InitFields ()
            _extObj.InitFields();
            this.price1    = 0;
            this.NKD1      = 0;
            this.PayDate1  = date(0,0,0);
            this.SupDate1  = date(0,0,0);
            this.price2    = 0;
            this.NKD2      = 0;
            this.PayDate2  = date(0,0,0);
            this.SupDate2  = date(0,0,0);
      end;

      macro getDealInfo (id, type)
            var sql, rs;
            sql ="   select tick. t_dealdate, fi.t_codeinaccount, fiv.t_facevalue, leg1.t_price,leg1.t_nkd,                                                                    "+
                 "   (select  t_plandate from ddlgrdeal_dbt where t_dockind = 101 and t_templnum = 15 and t_docid = tick.t_dealid),                                            "+
                 "   (select  t_plandate from ddlgrdeal_dbt where t_dockind = 101 and t_templnum = 17 and t_docid = tick.t_dealid),                                            "+
                 "   LEG2.T_PRICE, leg2.t_nkd,                                                                                                                                 "+
                 "   (select  t_plandate from ddlgrdeal_dbt where t_dockind = 101 and t_templnum = 31 and t_docid = tick.t_dealid),                                            "+
                 "   (select  t_plandate from ddlgrdeal_dbt where t_dockind = 101 and t_templnum = 34 and t_docid = tick.t_dealid)                                             "+
                 "     from ddl_tick_dbt tick                                                                                                                                  "+
                 "   join ddl_leg_dbt leg1  on leg1.t_dealid = tick.t_dealid  and leg1.t_id = (select min(leg3.t_id)from ddl_leg_dbt leg3 where leg3.t_dealid = tick.t_dealid) "+
                 "   join ddl_leg_dbt leg2  on leg2.t_dealid = tick.t_dealid  and leg2.t_id = (select max(leg4.t_id)from ddl_leg_dbt leg4 where leg4.t_dealid = tick.t_dealid) "+                                                                                        
                 "   join dfininstr_dbt fi on leg1.t_cfi =fi.t_fiid                                                                                                            "+
                 "   join DV_FI_FACEVALUE_HIST fiv on FIV.T_FIID = LEG1.T_PFI and (fiv.t_enddate>=  tick. t_dealdate or fiv.t_enddate = to_date('01010001', 'ddmmyyyy'))       "+
                 "         and FIV.T_BEGDATE <=tick.t_dealdate                                                                                                                 "+
                 "   where tick.t_dealid = :dealid                                                                                                                             ";

            sql = rsdcommand (sql);
            sql.addParam(":dealid", RSDBP_IN, id);
            rs  = rsdrecordset (sql);

      return rs;
        OnError(er)
           MsgBox (er.Message,"| Модуль: ",er.Module,"| строка: ",er.Line );
           return false;
      end;

      macro _compareWithDeal (deal2)
//msgboxex(valtype(deal2.paydate)+"|"+valtype(deal2.paydate)+"|"+V_DATE);
//            if (_extObj.compareWithDeal(deal2) )
                if ( (this.dealDate != deal2.dealDate  )  or
                     (this.currency != deal2.currency  )  or
                  //   (this.SumNom   != deal2.sumNom    )  or
                     (this.price1   != deal2.price1    )  or
                     (this.NKD1     != deal2.NKD1      )  or
                     (this.PayDate1 != deal2.PayDate1  )  or
                     (this.SupDate1 != deal2.SupDate1  )  or
                     (this.price2   != deal2.price2    )  or
                     (this.NKD2     != deal2.NKD2      )  or
                     (this.PayDate2 != deal2.PayDate2  )  or
                     (this.SupDate2 != deal2.SupDate2  )

                    ) 
                     return false;
                else return true;
                end;
  //          else return false;
    //        end;    
      end;
      macro loadDealInfo (id, type)
            private var m_rs = getDealInfo (id, type);  
              
            if (m_rs.movenext () )
                 this.dealId    = id;
                 this.dealDate  = m_rs.value(0);
                 this.currency  = m_rs.value(1);
                 this.price1    = m_rs.value(3);
                 this.nkd1      = m_rs.value(4);
                 this.PayDate1  = m_rs.value(5);
                 this.SupDate1  = m_rs.value(6);
                 this.price2    = m_rs.value(7);
                 this.nkd2      = m_rs.value(8);
                 this.PayDate2  = m_rs.value(9);
                 this.SupDate2  = m_rs.value(10);
            else
                 InitFields();   
            end;
      end;

      InitCDeal(id);    
end;

private Macro PanelErr (dlg, cmd, id, key ) 
   if (cmd == DLG_INIT)

      dlg.dealDate  = Deal_dlg.dealDate;  
      dlg.currency  = Deal_dlg.currency;
//      dlg.SumNom    = Deal_dlg.SumNom; 
      dlg.price     = Deal_dlg.price;
      dlg.NKD       = Deal_dlg.NKD; 
      dlg.PayDate   = Deal_dlg.PayDate;
      dlg.SupDate   = Deal_dlg.SupDate;

      dlg.xDealDate  = Deal_main.dealDate;   
      dlg.xcurrency  = Deal_main.currency; 
  //    dlg.xSumNom    = round(Deal_main.SumNom,4);   
      dlg.xprice     = Deal_main.price;   
      dlg.xNKD       = Deal_main.NKD;
      dlg.xPayDate   = Deal_main.PayDate; 
      dlg.xSupDate   = Deal_main.SupDate;
      
      updateFields (dlg);
   
   end;
   if ( cmd == DLG_KEY )
      if ( key == 27 ) 
         return CM_CANCEL;
      else
         return CM_IGNORE;
      end;
   end;
End;

private Macro PanelErr2 (dlg, cmd, id, key ) 
   if (cmd == DLG_INIT)

      dlg.dealDate  = Deal_dlg.dealDate;  
      dlg.currency  = Deal_dlg.currency;
//      dlg.SumNom    = Deal_dlg.SumNom; 
      dlg.price1    = Deal_dlg.price1;
      dlg.NKD1      = Deal_dlg.NKD1;
      dlg.PayDate1  = Deal_dlg.PayDate1;
      dlg.SupDate1  = Deal_dlg.SupDate1;
      dlg.price2    = Deal_dlg.price2;
      dlg.NKD2      = Deal_dlg.NKD2;
      dlg.PayDate2  = Deal_dlg.PayDate2;
      dlg.SupDate2  = Deal_dlg.SupDate2;


      dlg.xDealDate  = Deal_main.dealDate;   
      dlg.xcurrency  = Deal_main.currency; 
//      dlg.xSumNom    = Deal_main.SumNom;   
      dlg.xprice1    = Deal_main.price1;   
      dlg.xNKD1      = Deal_main.NKD1;
      dlg.xPayDate1  = Deal_main.PayDate1; 
      dlg.xSupDate1  = Deal_main.SupDate1;
      dlg.xprice2    = Deal_main.price2;   
      dlg.xNKD2      = Deal_main.NKD2;
      dlg.xPayDate2  = Deal_main.PayDate2; 
      dlg.xSupDate2  = Deal_main.SupDate2;
//msgboxex(Deal_main.paydate+"|"+valtype(Deal_main.paydate)+"|"+V_DATE+"|"+V_DTTM);

      updateFields (dlg);
   
   end;
   if ( cmd == DLG_KEY )
      if ( key == 27 ) 
         return CM_CANCEL;
      else
         return CM_IGNORE;
      end;
   end;
End;

private Macro PanelErr3 (dlg, cmd, id, key ) 
   if (cmd == DLG_INIT)
      //--введено
      dlg.dealDate  = Deal_pay_dlg.dealDate;  
      dlg.currency  = Deal_pay_dlg.currency; 
      //--в сделке
      dlg.xDealDate  = Deal_pay.dealDate;   
      dlg.xExecdate  = Deal_pay.execdate;
      
      //обязательствва
      //--введено
      dlg.SumNom   = Deal_pay_dlg.SumNom;
      dlg.price    = Deal_pay_dlg.price; 
      //--в сделке
      dlg.xSumm_BA   = Deal_pay.summ_BA; 
      dlg.xCur_BA    = Deal_pay.cur_BA;   
      
      //требования
      //--введено
      dlg.NKD = Deal_get_dlg.NKD;
      dlg.PayDate  = Deal_get_dlg.PayDate; 
      dlg.SupDate  = Deal_get_dlg.SupDate; 
      //--в сделке
      dlg.xGet_Summ_BA   = Deal_get.summ_BA; 
      dlg.xGet_Cur_BA    = Deal_get.cur_BA;   

      updateFields (dlg);
   
   end;
   if ( cmd == DLG_KEY )
      if ( key == 27 ) 
         return CM_CANCEL;
      else
         return CM_IGNORE;
      end;
   end;
End;




private Macro mainPanel (dlg, cmd, id, key ) 
var conv,NKD_Con, price_Con, principal, er;
      if (cmd == DLG_INIT)
          Deal_main = CDeal (_dealId, 0);
          Deal_dlg  = CDeal ();
          conv = ExecSqlSelect(" SELECT nvl(rsb_struct.getstring (t_text),' ')        "+
                               "    FROM dnotetext_dbt                               "+
                               "   WHERE     t_notekind = 300                        "+
                               "         AND t_objecttype = 101                      "+
                               "         AND t_documentid = LPAD (:dlcontrid, 34, 0) ", makeArray(SqlParam("dlcontrid", _dealId))); 
          conv.movenext();  
          if (valtype(conv.value(0)) != 26)
             dlg.convers  = conv.value(0); 
             updateFields (dlg);
          end;

      elif (cmd == DLG_KEY)
            if ((key == 323) or (key == 316))  //F9 или F2
/*               if (dlg.cur_BA == "810")
                   dlg.cur_BA = "643"; 
               end; */
               Deal_dlg.dealDate  = dlg.dealDate;
               Deal_dlg.currency  = dlg.currency;
               Deal_dlg.price     = dlg.price;
               Deal_dlg.NKD       = dlg.NKD;
               Deal_dlg.PayDate   = dlg.PayDate;
               Deal_dlg.SupDate   = dlg.SupDate;
               if (not Deal_main.compareWithDeal (Deal_dlg ))
                  msgbox ("Верификация не выполнена !");
                  _code = 1;
                  rundialog ( errpanel, "PanelErr" );
               else 
                  NKD_Con = ExecSqlSelect(" SELECT rsb_struct.getmoney (t_text)                "+                                             
                                       "    FROM dnotetext_dbt                               "+                                             
                                       "   WHERE     t_notekind = 152                        "+                                             
                                       "         AND t_objecttype = 101                      "+                                             
                                       "         AND t_documentid = LPAD (:dlcontrid, 34, 0) ", makeArray(SqlParam("dlcontrid", _dealId))); 
                  NKD_Con.movenext();
                  if((valtype(NKD_con.value(0))!=26) and (NKD_con.value(0)!=deal_dlg.NKD) )
                     er = 1;                                                                   
                  end;
                  price_Con = ExecSqlSelect(" SELECT rsb_struct.getdouble (t_text)                "+                                             
                                       "    FROM dnotetext_dbt                               "+                                             
                                       "   WHERE     t_notekind = 154                        "+                                             
                                       "         AND t_objecttype = 101                      "+                                             
                                       "         AND t_documentid = LPAD (:dlcontrid, 34, 0) ", makeArray(SqlParam("dlcontrid", _dealId))); 
                  price_Con.movenext();
                  principal = ExecSqlSelect(" select round(t_cost,2)  from ddl_leg_dbt where t_dealid = :dealid ", makeArray(SqlParam("dealid", _dealId))); 
                  principal.movenext();
                  if((valtype(price_Con.value(0))!=26) and (round(price_Con.value(0) - NKD_con.value(0),2/*GAA:503547, old: 9*/) !=round(principal.value(0),2/*GAA:503547, old:9*/)) )
                     er = 1;                                                                   
                  end;
                  if (er==1)
                     msgbox ("Верификация не выполнена !  Имеются расхожения с Кондор.");
                     _code = 1;
                  else
                     msgbox ("Верификация выполнена !");
                     _code = 0;
                  end;
               end; 
               return CM_CANCEL;
            elif (key == 27) //Esc
               msgbox ("Верификация не выполнена !");
               _code = 1;
               return CM_CANCEL;
            elif (key == 13);
               if(id == FldIndex(dlg, "supdate")) 
                 setfocus(dlg,0);
                 return CM_IGNORE;   
               end;
            end;
      end;
End;

private Macro mainPanel2 (dlg, cmd, id, key )       
var conv, NKD_Con, price_Con, NKD_con2, price_con2,  principal,principal2, er;;      
      if (cmd == DLG_INIT)
          Deal_main = CDealOption (_dealId, 0);
          Deal_dlg  = CDealOption ();
          conv = ExecSqlSelect(" SELECT nvl(rsb_struct.getstring (t_text),' ')        "+
                               "    FROM dnotetext_dbt                               "+
                               "   WHERE     t_notekind = 300                        "+
                               "         AND t_objecttype = 101                      "+
                               "         AND t_documentid = LPAD (:dlcontrid, 34, 0) ", makeArray(SqlParam("dlcontrid", _dealId))); 
          conv.movenext();  
          if (valtype(conv.value(0)) != 26)
             dlg.convers  = conv.value(0); 
             updateFields (dlg);
          end;
      elif (cmd == DLG_KEY)
            if (key == 323)  //F9
               Deal_dlg.dealDate  = dlg.dealDate;
               Deal_dlg.currency  = dlg.currency;
               Deal_dlg.price1    = dlg.price1;
               Deal_dlg.NKD1      = dlg.NKD1;
               Deal_dlg.PayDate1  = dlg.PayDate1;
               Deal_dlg.SupDate1  = dlg.SupDate1;
               Deal_dlg.price2    = dlg.price2;
               Deal_dlg.NKD2      = dlg.NKD2;
               Deal_dlg.PayDate2  = dlg.PayDate2;
               Deal_dlg.SupDate2  = dlg.SupDate2;
               
               if (not Deal_main._compareWithDeal (Deal_dlg ))
                  msgbox ("Верификация не выполнена !");
                  _code = 1;
                  rundialog ( errpanel2, "PanelErr2" );
               else
                  NKD_Con = ExecSqlSelect(" SELECT rsb_struct.getmoney (t_text)                "+                                             
                                       "    FROM dnotetext_dbt                               "+                                             
                                       "   WHERE     t_notekind = 152                        "+                                             
                                       "         AND t_objecttype = 101                      "+                                             
                                       "         AND t_documentid = LPAD (:dlcontrid, 34, 0) ", makeArray(SqlParam("dlcontrid", _dealId))); 
                  NKD_Con.movenext();

                  if((valtype(NKD_con.value(0))!=26) and (NKD_con.value(0)!=deal_dlg.NKD1) )
                     er = 1;                                                                   
                  end;

                  NKD_Con2 = ExecSqlSelect(" SELECT rsb_struct.getmoney (t_text)                "+                                             
                                       "    FROM dnotetext_dbt                               "+                                             
                                       "   WHERE     t_notekind = 153                        "+                                             
                                       "         AND t_objecttype = 101                      "+                                             
                                       "         AND t_documentid = LPAD (:dlcontrid, 34, 0) ", makeArray(SqlParam("dlcontrid", _dealId))); 
                  NKD_Con2.movenext();

                  if((valtype(NKD_con2.value(0))!=26) and (NKD_con2.value(0)!=deal_dlg.NKD2) )
                     er = 1;                                                                   
                  end;

                  price_Con = ExecSqlSelect(" SELECT rsb_struct.getdouble (t_text)                "+                                             
                                       "    FROM dnotetext_dbt                               "+                                             
                                       "   WHERE     t_notekind = 154                        "+                                             
                                       "         AND t_objecttype = 101                      "+                                             
                                       "         AND t_documentid = LPAD (:dlcontrid, 34, 0) ", makeArray(SqlParam("dlcontrid", _dealId))); 
                  price_Con.movenext();
                  principal = ExecSqlSelect(" select t_cost  from ddl_leg_dbt where t_dealid = :dealid and t_id = (select min(leg3.t_id)from ddl_leg_dbt leg3 where leg3.t_dealid = :t_dealid) ",
                                               makeArray(SqlParam("dealid", _dealId), SqlParam("t_dealid", _dealId))); 
                  principal.movenext();
                  if((valtype(price_Con.value(0))!=26) and (price_Con.value(0) - NKD_con.value(0) !=principal.value(0)) )
                     er = 1;                                                                   
                  end;

                  price_Con2 = ExecSqlSelect(" SELECT rsb_struct.getdouble (t_text)                "+                                             
                                       "    FROM dnotetext_dbt                               "+                                             
                                       "   WHERE     t_notekind = 155                        "+                                             
                                       "         AND t_objecttype = 101                      "+                                             
                                       "         AND t_documentid = LPAD (:dlcontrid, 34, 0) ", makeArray(SqlParam("dlcontrid", _dealId))); 
                  price_Con2.movenext();
                  principal2 = ExecSqlSelect(" select t_cost  from ddl_leg_dbt where t_dealid = :dealid and t_id = (select max(leg3.t_id)from ddl_leg_dbt leg3 where leg3.t_dealid = :t_dealid) ",
                                               makeArray(SqlParam("dealid", _dealId), SqlParam("t_dealid", _dealId))); 
                  principal2.movenext();
                  if((valtype(price_Con2.value(0))!=26) and (price_Con2.value(0) - NKD_con2.value(0)!=principal2.value(0)) )
                     er = 1;                                                                   
                  end;

                  if (er==1)
                     msgbox ("Верификация не выполнена !  Имеются расхожения с Кондор.");
                     _code = 1;
                  else
                  msgbox ("Верификация выполнена !");
                  _code = 0;
                  end;
               end; 
               return CM_CANCEL;
            elif (key == 27) //Esc
               msgbox ("Верификация не выполнена !");
               _code = 1;
               return CM_CANCEL;
            elif (key == 13);
               if(id == FldIndex(dlg, "supdate")) 
                 setfocus(dlg,0);
                 return CM_IGNORE;   
               end;          
            end;
      end;
End;

private macro IsSubstitutionDeal(dealID:integer):bool
   var query = "select 1 "
             + "  from dual "
             + " where categ_read.get_attr_id(p_object_type => 101, "
             + "                              p_group_id    => 120, "
             + "                              p_object      => lpad(:dealid, 34, '0'), "
             + "                              p_date        => :dt) = 1 ";
   return ExecSQLselectPrmDyn(query, dealID, {curdate}).MoveNext();
end;

macro ExecuteStep( doc, FDoc )
   
   SetBuff(deal, FDoc);
   
   _dealId = deal.dealid;

   if (IsSubstitutionDeal(_dealId))
      return 0;
   end;
  
   var sql = ExecSqlSelect("select t_systypes from doprkoper_dbt where t_kind_operation = :indata ", makeArray(SqlParam("indata", deal.dealtype)));
   sql.movenext();
   if (index( sql.value(0),"v" )!= 0)
      if (index( sql.value(0),"t" )!= 0)
         rundialog ( panel2, "mainPanel2" );
      else
         rundialog ( panel, "mainPanel" );
      end;
   else
      return 0;
   end;

   return _code;
end;