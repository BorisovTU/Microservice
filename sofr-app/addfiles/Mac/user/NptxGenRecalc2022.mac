import rsd, secinter, "or_exl_h.mac", "u_common_email_utils.mac";


private const firstrow = 2;

private var outdir, repfilename, repfile, r = firstrow-1, succnt = 0, miscnt = 0, errcnt = 0, totalcnt = 0;
private var y, mon, d, h, m, s;
private var gSQL = "";


file protocol() txt write;


GetRegistryValue( "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\WORKDIR", V_STRING, outdir );
DateSplit(Date(), d, mon, y);
TimeSplit(Time(), h, m, s); 

Open(protocol, outdir + "\\" + "ГенерацияПересчетов_" +string(y:4:o,".",mon:2:o,".",d:2:o) + "_" + string(h:2:o,".",m:2:o,".",s:2:o) + ".log");


private macro SqlHandler(str)
  gSQL = gSQL + str;
end;


macro CreateNptxopRecalvVTB(D1:date,          //Дата, с которой делать проверки для пересчетов
                            OperDate:date,     //Дата, которой создаются операции пересчета
                            UniCodeStr:string, //Часть кода для операций
                            p_clientID :integer,   
			       errp:@string
			    
                           )
  var query, cmd;

  gSQL = "";

  SetOutHandler(@SqlHandler);

[ DECLARE
    v_nptxop                    DNPTXOP_DBT%ROWTYPE;
    TYPE ListNPTXOP_t IS TABLE OF DNPTXOP_DBT%ROWTYPE;
    v_ListNPTXOP                ListNPTXOP_t := ListNPTXOP_t ();

    TYPE nptxobj_t IS TABLE OF DNPTXOBJ_DBT%ROWTYPE INDEX BY BINARY_INTEGER;
    v_nptxobj nptxobj_t;

    v_BegDate DATE;
    v_OperDate DATE;
    v_SubKind NUMBER;
    v_i       NUMBER := 1;
    v_f       NUMBER := 1;
    v_UniCodeStr VARCHAR2(15);

    PROCEDURE insertOP(p_begdate IN DATE, p_operdate IN DATE, p_prevdate IN DATE, pSubKind IN NUMBER, p_PartyID IN NUMBER, p_UniCodeStr IN VARCHAR2)
    IS
      v_OperDprt                  NUMBER (10) := 1;
      v_oper                      NUMBER (10) := 1;
      v_Kind_Operation            NUMBER (10) := 2035;
      OBJTYPE_NPTXCALC   CONSTANT NUMBER (5) := 132;
      REFOBJ_NPTXCALC    CONSTANT NUMBER (5) := 1;

      function Get_Count_OP_Name(OP_name in varchar2) return number is
       i number := 0;
      begin 
       select count(1) into i from dnptxop_dbt where t_code like OP_Name and t_dockind = 4605;
        return i;
      end;

     function Get_OP_Name(OP_name in varchar2) return varchar2 is
       i number := 0;
       flag_exit number := 0;
       New_OP_Name varchar2(100);
     begin

      if Get_Count_OP_Name(OP_name) > 0 then
       i := i+1;
       loop
         EXIT WHEN flag_exit = 1;
           if Get_Count_OP_Name(OP_name||'_'||i) = 0 then 
           New_OP_Name := OP_name||'_'||i;
           flag_exit := 1;
         else
           i := i+1;   
         end if;
       end loop;
      else 
        New_OP_Name := OP_name;
      end if;
      return New_OP_Name;
     end;

    BEGIN
        v_nptxop.t_Code := Get_OP_Name(p_UniCodeStr||'_' ||v_i||'_'||p_PartyID);
        v_nptxop.t_ID := dnptxop_dbt_seq.NEXTVAL;
        v_nptxop.t_DocKind := RSI_NPTXC.DL_CALCNDFL;
        v_nptxop.t_OperDate := p_operdate;
        v_nptxop.t_Kind_Operation := v_Kind_Operation;
        v_nptxop.t_Client := p_PartyID;
        v_nptxop.t_Department := v_OperDprt;
        v_nptxop.t_Oper := v_oper;
        v_nptxop.t_Status := RSI_NPTXC.DL_TXOP_Prep;
        v_nptxop.t_SubKind_Operation := pSubKind;
        v_nptxop.t_IIS := CNST.UNSET_CHAR;
        --ЗПУ
        v_nptxop.t_Account := RSI_RsbOperation.ZERO_STR;
        v_nptxop.t_AccountTax := RSI_RsbOperation.ZERO_STR;
        v_nptxop.t_BegRecalcDate := p_begdate;
        v_nptxop.t_CalcNDFL := CNST.SET_CHAR;
        v_nptxop.t_Contract := 0;
        v_nptxop.t_Currency := 0;
        v_nptxop.t_CurrencySum := 0;
        v_nptxop.t_CurrentYear_Sum := 0;
        v_nptxop.t_EndRecalcDate := p_prevdate;
        v_nptxop.t_FIID := -1;
        v_nptxop.t_FlagTax := CNST.UNSET_CHAR;
        v_nptxop.t_LimitStatus := 0;
        v_nptxop.t_MarketPlace := 0;
        v_nptxop.t_MarketPlace2 := 0;
        v_nptxop.t_MarketSector := 0;
        v_nptxop.t_MarketSector2 := 0;
        v_nptxop.t_Method := 0;
        v_nptxop.t_OutCost := 0;
        v_nptxop.t_OutSum := 0;
        v_nptxop.t_Partial := CNST.UNSET_CHAR;
        v_nptxop.t_Place := 0;
        v_nptxop.t_Place2 := 0;
        v_nptxop.t_PlaceKind := 0;
        v_nptxop.t_PlaceKind2 := 0;
        v_nptxop.t_PrevDate := p_prevdate;
        v_nptxop.t_PrevTaxSum := 0;
        v_nptxop.t_Recalc := CNST.SET_CHAR;
        v_nptxop.t_Tax := 0;
        v_nptxop.t_TaxBase := 0;
        v_nptxop.t_TaxSum := 0;
        v_nptxop.t_TaxSum2 := 0;
        v_nptxop.t_TaxToPay := 0;
        v_nptxop.t_Time := NPTAX.UnknownTime;
        v_nptxop.t_TotalTaxSum := 0;
        v_nptxop.t_TOUT := 0;
        v_nptxop.t_TaxDp := 0;
        v_ListNPTXOP.EXTEND ();
        v_ListNPTXOP (v_ListNPTXOP.LAST) := v_nptxop;

        v_i := v_i + 1;
    END;

  BEGIN
    v_i := 1;

    v_BegDate    := ? /*1*/;
    v_OperDate    := ? /*2*/;
    v_UniCodeStr := ? /*3*/;

    FOR cData IN ( select oc.t_Client,
                          (select count(1)
                             from dnptxop_dbt op
                            where op.t_DocKind = 4605
                              and op.t_OperDate >= v_BegDate
                              and op.t_SubKind_Operation = 10 --Окончание года
                              and op.t_IIS != 'X'
                              and op.t_Client = oc.t_Client
                          ) as CntEndYear,
                          (SELECT MAX(op.t_OperDate)
                             FROM DNPTXOP_DBT op
                            WHERE op.t_DocKind = 4605
                              AND op.t_Client = oc.t_Client
                              AND op.t_IIS != 'X'
                              AND t_Recalc = chr(0) /*DEF-31726 Неверный расчет финансового результата и суммы возврата НДФЛ*/
                              AND op.t_OperDate >= v_BegDate
                          ) as PrevOpDate
                     from (select DISTINCT op.t_Client
                             from dnptxop_dbt op
                            where op.t_DocKind = 4605
                              and op.t_OperDate >= v_BegDate
                              and op.t_IIS != 'X'
                          ) oc
                    where 
                         oc.t_client = ?                 )
    LOOP

         v_SubKind := 20; --Обычный расчет
         
         IF cData.CntEndYear > 0 THEN
           v_SubKind := 10; --Окончание года
         END IF;

         insertOP(v_BegDate, /*v_OperDate DEF-31726*/cData.PrevOpDate, cData.PrevOpDate, v_SubKind, cData.t_Client, v_UniCodeStr);
    END LOOP;

    --Вставки
    IF v_ListNPTXOP.COUNT > 0
    THEN
      FORALL i IN v_ListNPTXOP.FIRST .. v_ListNPTXOP.LAST
        INSERT INTO DNPTXOP_DBT
             VALUES v_ListNPTXOP (i);

      v_ListNPTXOP.DELETE;
    END IF;

  END;
];

  SetOutHandler(NULL);

  cmd = RSDCommand(gSQL);
  
  cmd.addParam("", RSDBP_IN, D1);         /*1*/
  cmd.addParam("", RSDBP_IN, OperDate);   /*2*/
  cmd.addParam("", RSDBP_IN, UniCodeStr); /*3*/
  cmd.addParam("", RSDBP_IN, p_ClientID);  /*4*/

 

  cmd.execute();

  return true;

OnError(er)
  return false
end;

private macro ProcessRow()
  var client, clientId, clientIdLen, clientName, clientNameLen, IIS, contrNumber,;
  var err;
  var cmd, rs;

  client = repfile.GetValue(r,0);

  if(client == "")
    return false;
  end;

  totalcnt = totalcnt + 1;

  client = strsubst(client, " ", "");
  clientId = int(client);
  if (not   CreateNptxopRecalvVTB(date(1,1,2022),          //Дата, с которой делать проверки для пересчетов
                            date(31,12,2022),     //Дата, которой создаются операции пересчета
                            "rec2022", //Часть кода для операций
                            clientID,   
			       @err ))
    errcnt = errcnt + 1;
    Insert(protocol, string(clientId," : Error" ));
  else 
    succnt = succnt + 1;
    Insert(protocol, string(clientId," : OK" ));

  end;
  r = r + 1;
  return true;
OnError(e)
  errcnt = errcnt + 1;
  Insert(protocol, e.Message,"(Модуль:",e.Module,", строка:",e.Line,")");
  return true;
end;

if (SelectFile(repfilename, "..\\Import\\*.xls*"))
  repfile = CDAOMSExcel();

  repfile.Open(repfilename);
//  repfile.SheetChange("Контроль");
  while (ProcessRow())
    totalcnt = totalcnt + 1;
  end;

  Insert(protocol);
  Insert(protocol, "количество успешно обработанных записей : " + succnt);
  Insert(protocol, "количество ошибок обработки: " + errcnt);
  Insert(protocol, "всего записей: " + (errcnt+succnt));
end;

Close(protocol);
ViewFile(protocol);
exit(1);