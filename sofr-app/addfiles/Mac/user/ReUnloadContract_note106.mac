import dlquery;

import rsd;
import "global_utils_intgr.mac", "func_lib.mac";

macro uContrUnloadDepo(_dlcid, SilentMode)
   var v_etl = true, stat;
   var cmd, rs;
   var objecttype;
   if((valtype(SilentMode) == v_undef) or (SilentMode == Null))
     SilentMode = False;
   end;
   GetRegistryValue(DEPO_UNLOAD_TYPE, V_BOOL, v_etl, stat);
   if (stat>0)
      v_etl = true; // не найдено - значит, ETL
   end;

   if (v_etl)
      objecttype = 9;
   else 
      objecttype = 8207;
   end;

   cmd = "select * from utableprocessevent_dbt where t_objecttype = :objtype and t_status < 4 and t_objectid = :obid";
   cmd = RSDCommand(cmd);
   cmd.AddParam("objtype", RSDBP_IN, objecttype);
   cmd.AddParam("obid", RSDBP_IN, _dlcid);
   rs =  RsdRecordset(cmd);
   rs.movenext;
     if (valtype(rs.value(0)) == 26)
        m_make_event_to_process(objecttype, _dlcid);
        if(not SilentMode)
	  println("Событие создано");
	  return 1;	
        end;
     else
        if(not SilentMode)
	  println("Повторная выгрузка невозможна. По данному договору есть незаконченое событие.");		
	  return 0;
        end;
     end;
end;

var sqls, cmds, rss;
var n = 0;

BegAction(1, "Обработка. Ждите...");
sqls = String( 
               "select to_number(note.t_documentid) as t_objectid, sfc.t_number   \n"
              ,"               from dnotetext_dbt note, ddlcontr_dbt dlc, dsfcontr_dbt sfc   \n"
              ,"               where to_number(note.t_documentid) = dlc.t_dlcontrid   \n"
              ,"                 and sfc.t_id = dlc.t_sfcontrid   \n"
              ,"                 and note.t_objecttype = 207   \n"
              ,"                 and note.t_notekind = 104   \n"
              ,"                 and utl_raw.cast_to_varchar2(note.t_text) like ('K-%')   \n"
              ,"              union   \n"
              ,"              select dlc.t_dlcontrid as t_objectid, sfc.t_number   \n"
              ,"                from dsfcontr_dbt sfc, ddlcontr_dbt dlc   \n"
              ,"                left join dobjatcor_dbt atcor   \n"
              ,"                  on atcor.t_objecttype = 207   \n"
              ,"                 and atcor.t_groupid = 101   \n"
              ,"                 and atcor.t_object = lpad(dlc.t_dlcontrid, 34, 0)   \n"
              ,"                 and atcor.t_validtodate = to_date('31129999', 'ddmmyyyy')   \n"
              ,"               where dlc.t_sfcontrid = sfc.t_id   \n"
              ,"                 and sfc.t_servkindsub = 0   \n"
              ,"                 and atcor.t_attrid != 4 /*Новый*/   \n"
              ,"                 and not exists (select 1 from dnotetext_dbt nt104 where nt104.t_objecttype = 207 and nt104.t_notekind = 106   \n"
              ,"                 and nt104.t_documentid  = lpad(dlc.t_dlcontrid, 34 , 0))   \n"
             );
cmds = dl_RSDCommand(sqls);
rss = cmds.Execute();
println("обработано:");
println("_______________________");
while(rss.movenext())
  print(rss.Number:64); print(":  ");
  uContrUnloadDepo( rss.ObjectID, false);
  n = n + 1;
end;
println("_______________________");
println("обработка завершена: " + n + "  шт.");
EndAction(1);
