import dealsinter, cb_sql;
import captureoutput;
import "dlquery.mac";
import vtb_loadlot;
import vtb_CreateEnroll;
//import LoadCodeMatch;

private macro LoadFile()

end;

private macro ProcessRecords()

end;

/* class (TArray) TStrCollector
   /*Очистить массив.*/
  macro ClearArray
    this.Size = 0;
  end;
  /*Добавить строку в массив.*/
  macro AddString( Str )
    this.(this.Size) = Str;
  end;
end;*/

private macro SetState(Id, State, Comment)
  var rs = RsdCommand    ( " BEGIN update u_vtb_lots_dbt         " +
                                            "set t_state = ?, t_comment = ? "+
                                            " where T_ID = ?; COMMIT; END; ");
  rs.AddParam ("", RSDBP_IN, State);          
  rs.AddParam ("", RSDBP_IN, Comment);          
  rs.AddParam ("", RSDBP_IN, Id); 
  rs.Execute;
end;

private macro RunProcessItem(process:@rsdrecordset, errmsg:@string)

  if ( (VTB_CreateBoardByRec(process.value("t_id"), true, @errmsg) != 0) and (index(errmsg, "же существует операция") == 0))
     SetState(process.value("t_id"), "Ошибка", errmsg);
     /*process.Edit();
     process.value("t_state") = "Ошибка";
     process.value("t_Comment") = errmsg;
     process.Update();*/
  else
     SetState(process.value("t_id"), "Обработано", errmsg);
     /*process.Edit();
     process.value("t_state") = "Обработано";
     process.value("t_Comment") = errmsg;
     process.Update();*/
  end;
  return true;
end;

private macro ResetErr(process:@rsdrecordset)
   process.Edit();
   process.value("t_state") = StrFor(1);
   process.value("t_comment") = StrFor(1);
   process.Update();
end;

private macro eInfoDialog(rs, cmd, id, key)

   file ReportOutFile() txt write;
   var ReportFileName;


   if(cmd == DLG_KEY)
      /*Esc*/
      if(key == 27)
         return CM_CANCEL;
      elif(key == 13)
      end;
   end;
end;


    
macro RunLoadLotScroll()

  var errmsg;
  var inprocess = false;
  var inprocessprogress;

  macro makeArray():TArray
    var parm:variant, i:integer = 0, result:TArray = TArray( ParmCount(), ParmCount() );
    while( GetParm(i, parm) )
      result.value(i) = parm;
      i = i + 1;
    end;
    return result;
  end;

  var SaveNum = 0;
  macro eRunProcessDialog(rs, cmd, id, key)

//msgbox(key);
    if(cmd == DLG_INIT)
      /*Позиционируемся*/
      if(SaveNum > 0)
        while(rs.movenext)
          if(SaveNum == rs.value("t_id"))
            GoToScroll(rs);
            break;
          end;
        end;
      end;
      AddMultiAction(rs, 316/*F2*/);
      AddMultiAction(rs, 322/*F8*/);
    /*Старт обработки выделенных записей*/
    elif(cmd == DLG_MSELSTART)
      /*F2 F8*/
      if((key == 316) or (key == 322))
        if(msgboxex("Выполнить обработку выделеных записей?", MB_YES + MB_NO, IND_YES) == IND_YES)
          inprocess = true;
          inprocessprogress = 0;
          InitProgress(int(GetMultiCount()), "Ждите...", "Обработка записей");
        end;
      end;
    /*Завершение обработки выделенных записей*/
    elif(cmd == DLG_MSELEND)
      /*F2*/
      if((key == 316) or (key == 322))
        if(inprocess)
          inprocess = false;
          RemProgress();
          msgboxex("Обработка завершена");
        end;
      end;
      UpdateScroll(rs,5);
//      return CM_MSEL_STOP_CLEARALL;
    elif(cmd == DLG_MSEL)
      if(inprocess)
        /*F2*/
        if(key == 316)
          if(rs.value("t_state") != "Обработано") 
             if (rs.value("t_number") != nullval)
                RunProcessItem(@rs, @errmsg);
                updatescroll(rs, 5);
             end;
          end;
          inprocessprogress = inprocessprogress + 1;
          UseProgress(inprocessprogress);
          return CM_MSEL_CONT_CLEAR;
        /*F8*/
        elif(key == 322)
           //ResetErr(@rs);
           SetState(rs.value("t_id"), StrFor(1), StrFor(1));
           updatescroll(rs, 5);
        end;
      end;
    elif(cmd == DLG_KEY)
      /*Esc*/
      if(key == 27)
        return CM_CANCEL;
      /*F2*/
      elif(key == 316)
        if(rs.value("t_state") == "Обработано") 
          msgboxex("Операция '" + rs.value("t_operno") + "' обработана");
        elif(msgboxex("Выполнить обработку  '" + rs.value("t_operno") + "'?", MB_YES + MB_NO, IND_YES) == IND_YES)
          if (rs.value("t_number") == nullval)
             msgboxex("Нет связанного договора в СОФР");
             SetState(rs.value("t_id"), StrFor(1), StrFor(1));
          else
             BegAction(1, rs.value("t_operno") + ". Ждите...");
             if(not RunProcessItem( @rs, @errmsg))
               updatescroll(rs, 5);
               EndAction(1);
               msgboxex("Ошибка при обработке '" + rs.value("t_operno") + "'|" + errmsg);
             else
               EndAction(1);
               updatescroll(rs, 5);
             end;
           end;
        end;
        SaveNum = rs.value("t_id");
        return CM_SELECT;
      /*F8*/
      elif(key == 322)
        if((rs.value("t_state") == "Обработано" ) or (rs.value("t_state") == "Ошибка")) 
           if (msgboxex("Сбросить статус обработки? ", MB_YES + MB_NO, IND_YES) == IND_YES)
//              ResetErr(@rs);
              SetState(rs.value("t_id"), StrFor(1), StrFor(1));
              updatescroll(rs, 5);
           end;
           SaveNum = rs.value("t_id");
           return CM_SELECT;
        end;
      /*Enter*/
      elif(key == 13)
        msgbox(rs.Value("t_comment"));
        return CM_IGNORE;
//----------------------------
      elif(key == 18/*Ctrl+R*/)
        SaveNum = rs.value("t_id");
        return CM_SELECT;
      end;
    end;
  end;


  var sql, cmd, rs;


  var cmdQuery, cmdScroll, rsScroll;

  StartCaptureOutput();
  [
     select 
     t_id,
     t_secondname,
     t_firstname,
     t_middlename,
     t_phone,
     t_agrno,
     t_isin,
     t_transh,
     t_secname,
     t_operno,
     t_datepos,
     t_qty,
     t_curr,
     t_price,
     t_amount,
     t_aci,
     t_cms,
     t_valuerur,
     t_cmsrur,
     t_stor,
     c.t_code_vtb, (select t_number from dsfcontr_dbt where t_id = d.t_sfcontrid) t_number,
      t_state, t_comment
      from u_vtb_lots_dbt t 
      left join USR_CONTRACT_MATCH c on t.t_agrno = c.t_contract_number_vtb left join ddlcontr_dbt d on d.t_dlcontrid = c.t_dlid
      order by t_id
   ];
  cmdQuery = EndCaptureOutput();
  cmdScroll = RsdCommand(cmdQuery);
  rsScroll = RSDRecordset(cmdScroll, RSDVAL_CLIENT, RSDVAL_STATIC);
  rsScroll.UpdateCommand = RsdCommand    ( " BEGIN update u_vtb_lots_dbt         " +
//                                            "set {{?,?}} "+
                                            " set t_state = ?, t_comment = ? "
                                            " where T_ID = ?; COMMIT; END; ");
  rsScroll.UpdateCommand.AddUserCmdParam ("",  "T_STATE",   RSDRVER_CHANGE);          
  rsScroll.UpdateCommand.AddUserCmdParam ("",  "T_COMMENT", RSDRVER_CHANGE);          
  rsScroll.UpdateCommand.AddUserCmdParam ("",  "T_ID",      RSDRVER_OLDVAL); 

  while(RunScroll(rsScroll, 24, MakeArray("t_id", "Id", 2, 2, -1, 0,
                                         "t_code_vtb","Код ВТБ", 10,2,-1,0,
                                         "t_number","Договор СОФР", 10,2,-1,0,
                                         "t_state","Статус", 5,2,-1,0,
                                         "t_secondname", "Ф", 10, 2, -1, 0, 
                                         "t_firstname", "И", 10, 2, -1, 0, 
                                         "t_middlename", "О", 10, 2, -1, 0, 
                                         "t_phone", "тел", 10, 2, -1, 0, 
                                         "t_agrno", "Номер договора", 10, 2, 2, 0, 
                                         "t_isin", "ISIN", 10, 2, -1, 0, 
                                         "t_transh", "Транщ", 10, 2, -1, 0, 
                                         "t_secname", "ФИ", 10, 2, -1, 0, 
                                         "t_operno", "Номер операции", 10, 2, -1, 0,
                                         "t_datepos", "Дата", 10, 2, -1, 0, 
                                         "t_qty", "Кол-во", 10, 2, -1, 0,
                                         "t_curr", "Вал", 3, 2, -1, 0, 
                                         "t_price", "Цена", 8, 2, -1, 0, 
                                         "t_amount", "Стоимость", 10, 2, -1, 0, 
                                         "t_aci", "НКД", 10, 2, -1, 0, 
                                         "t_cms", "Комисс", 10, 2, -1, 0, 
                                         "t_valuerur", "Стоимость РУБ", 10, 2, -1, 0, 
                                         "t_cmsrur", "Комисс РУБ", 10, 2, -1, 0,
                                         "t_stor","Место хр.", 5,2,-1,0, 
                                         "t_comment","Комментарий", 20,2,-1,0 
                                          ), 
                        "eRunProcessDialog", "eRunProcessDialog", "Список лотов ВТБ ", "~F2~ Обработать ", true))
    cmdScroll = RsdCommand(cmdQuery);
    rsScroll = RSDRecordset(cmdScroll, RSDVAL_CLIENT, RSDVAL_STATIC);
    rsScroll.UpdateCommand = RsdCommand    ( " BEGIN update u_vtb_lots_dbt         " +
                                            "set {{?,?}} "+
                                            " where T_ID = ?; COMMIT; END; ");
    rsScroll.UpdateCommand.AddUserCmdParam ("",  "T_STATE",   RSDRVER_CHANGE);          
    rsScroll.UpdateCommand.AddUserCmdParam ("",  "T_COMMENT", RSDRVER_CHANGE);          
    rsScroll.UpdateCommand.AddUserCmdParam ("",  "T_ID",      RSDRVER_OLDVAL); 
  end;
end;
//runprocess();
//exit(1);
      