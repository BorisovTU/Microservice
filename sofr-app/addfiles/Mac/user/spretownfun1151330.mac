/*
$Name:         spretownfun.mac 
$Module:       Ценные бумаги
$Description:  Операция погашения выпуска/купона ОЭБ. Функции
*/
import "sp_car.mac", "SCPeriodComm.mac";
const LIC_MSG_DEMO_MODE_OFF = 932;

private macro GetIsIIS(OwnerID:integer, dat:date, isIIS:@bool, ContractID:@integer)
  var query, cmd, DataSet;

  isIIS = false;
  ContractID = 0;

  query =   " select NVL((select sf.t_ID "
          + "               from dsfcontr_dbt sf "
          + "              where sf.t_ServKind = " + PTSK_STOCKDL
          + "                and sf.t_PartyID = ? "
          + "                and sf.t_DateBegin <= ? "
          + "                and (sf.t_DateClose = "+GetSQLDate(date(0,0,0))+" or sf.t_DateClose >= ?) "
          + "                and rsi_npto.CheckContrIIS(sf.t_ID) = 0 "
          + "                and rownum = 1"
          + "            ), 0) as NotIISSfContrID, "
          + "        NVL((select sf.t_ID "
          + "               from dsfcontr_dbt sf "
          + "              where sf.t_ServKind = " + PTSK_STOCKDL
          + "                and sf.t_PartyID = ? "
          + "                and sf.t_DateBegin <= ? "
          + "                and (sf.t_DateClose = "+GetSQLDate(date(0,0,0))+" or sf.t_DateClose >= ?) "
          + "                and rsi_npto.CheckContrIIS(sf.t_ID) = 1 "
          + "                and rownum = 1"
          + "            ), 0) as IISSfContrID "
          + "   from dual";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(OwnerID);
  cmd.AddParam(dat);
  cmd.AddParam(dat);
  cmd.AddParam(OwnerID);
  cmd.AddParam(dat);
  cmd.AddParam(dat);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    ContractID = int(DataSet.NotIISSfContrID);
    isIIS = false;
    if(ContractID == 0)
      ContractID = int(DataSet.IISSfContrID);
      if(ContractID > 0)
         isIIS = true;
      else
         isIIS = false;
      end;
    end;
  end;

end;

macro ОЭБ_ВычислитьВыплатыПоПогашению(FIID:integer, Number_Coupon:string, dat:date, PayFIID:integer, СуммаНалогаЮЛН:@money, СуммаНалогаФЛН:@money, СуммаНалогаФЛР:@money, IncNominal:bool, СуммаНалогаФЛР15:@money)
  var DataSet, cmd, query;
  var НалоговаяБаза = $0, НалоговаяБазаРуб = $0, НалоговаяБазаРуб15 = $0;
  var СуммаНалога  = $0, СуммаНалога15 = $0;
  var СуммаНом = $0, СуммаКуп = $0;
  var Nominal = $0;
  var Circulate = 0, TaxGroupNPTX = 0, TaxGroupNUTX = 0;
  var onwtaxCache = RsbSQLInsert("scowntax.tmp");
  var owntaxArr = TArray();
  var fin = TBfile("fininstr.dbt");
  var fiw = TBFile("fiwarnts.dbt");
  var party = TRecHandler("party.dbt");
  var FactReceiverID = -1;
  var Rate = 0;
  var err = 0;
  var Sum2 = 0.0, Sum3 = 0.0, Sum4 = 0.0, Sum5 = 0.0;
  var Year = 0;
  DateSplit(dat, NULL, NULL, Year);
  var BegDate = date(1, 1, Year);
  var SumQuery, SumSelect, SumDS;
  var IsCoprBondAfter2018_bef2021 = false;
  var isIIS = false;
  var ContractID = 0;

  СуммаНалогаЮЛН = $0; 
  СуммаНалогаФЛН = $0; 
  СуммаНалогаФЛР = $0;
  СуммаНалогаФЛР15 = $0;

  SQL_Execute("DELETE FROM DSCOWNTAX_TMP", "", false );

  fin.Clear();
  fin.rec.FIID = FIID;
  
  if(not fin.GetEQ())
    msgbox("Не найдена ц/б с идентификатором " + FIID);
    return 1;
  end;

  if(Number_Coupon != "")
  fiw.Clear();
  fiw.rec.FIID      = FIID;
  fiw.rec.IsPartial = UNSET_CHAR;
  fiw.rec.Number    = Number_Coupon;

  if(not fiw.GetEQ())
    msgbox("Не найден купон с номером " + Number_Coupon);
    return 1;
  end;
  end;

  Nominal = GetFaceValue(FIID, dat);

  query =  " select NPTO.Market1date(?, ?) t_Circulate, "
         + "        NPTO.GetPaperTaxGroupNPTX(?) t_TaxGroupNPTX, "
         + "        RSI_NUTX.GetNUTaxGroup(?, ?) t_TaxGroupNUTX"
         + "   from dual";

  cmd = Dl_RSDCommand(query);

  cmd.AddParam(fin.rec.FIID);
  cmd.AddParam(dat);
  cmd.AddParam(fin.rec.FIID);
  cmd.AddParam(fin.rec.FIID);
  cmd.AddParam(dat);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    Circulate    = int(DataSet.Circulate);
    TaxGroupNPTX = int(DataSet.TaxGroupNPTX);
    TaxGroupNUTX = int(DataSet.TaxGroupNUTX);
  end;

  query =   " select sh.t_ID as SHID, sh.t_OwnerID as Party, "
          + "        (sh.t_Total+ (CASE WHEN sh.t_Denominator != 0 THEN sh.t_Numerator/sh.t_Denominator ELSE 0 END)) as Amount, "
          + "        pt.t_LegalForm, "
          + "        (CASE WHEN pt.t_LegalForm = "+PTLEGF_PERSN+" THEN sh.t_OwnerID "
          + "              WHEN pt.t_LegalForm = "+PTLEGF_INST+" AND RSB_SECUR.IsTaxResident(sh.t_OwnerID, ?) = 0 THEN RSI_NUTX.GetFactReceiverForNUTX(sh.t_OwnerID) "
          + "              ELSE -1 END) as FactReceiverID "
          + "   from dscownlist_dbt ls, dscownhist_dbt sh, dparty_dbt pt "
          + "  where ls.t_FIID = ? "
          + "    and ls.t_Number_Coupon = ? "
          + "    and sh.t_ListID = ls.t_ListID "
          + "    and (sh.t_AccType = '01' or sh.t_IsFullOpen = CHR(0)) "
          + "    and (sh.t_ExcludeDate = "+GetSQLDate(date(0,0,0))+" or sh.t_ExcludeDate > ?)"
          + "    and pt.t_PartyID = sh.t_OwnerID ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(dat);
  cmd.AddParam(fin.rec.FIID);
  cmd.AddParam(Number_Coupon);
  cmd.AddParam(dat);

  DataSet = cmd.Execute();
   
  while((not err) and (DataSet.moveNext())) //для каждого владельца

    Rate = 0.0;
    СуммаНалога = $0;
    СуммаНалога15 = $0;
    FactReceiverID = int(DataSet.FactReceiverID);

    if(ПолучитьСубъекта(DataSet.Party, party) != 0 )
      msgbox("Не найден субъект с идентификатором " + DataSet.Party);
      return 1;
    end;

    СуммаКуп = $0;
    if(Number_Coupon != "")
    СуммаКуп = СуммаКупона(fin.rec.FIID, int(DataSet.Amount), fiw.rec.DrawingDate);
    end;


    if(FactReceiverID > 0)
      if(ПолучитьСубъекта(FactReceiverID, party) != 0 )
        msgbox("Не найден субъект с идентификатором " + FactReceiverID);
        return 1;
      end;

      if((dat < date(01,01,2021)) and 
         (fin.rec.FaceValueFI == NATCUR) and 
         (DL_NPTX_IsCorpBondAfter2018(fin.rec.FIID, Number_Coupon))
        )
        IsCoprBondAfter2018_bef2021 = true;
      end;

      if((party.rec.LegalForm == PTLEGF_PERSN) and (IsCoprBondAfter2018_bef2021 == true))
        НалоговаяБаза = DL_NPTX_GetTaxBaseCorpBondAfter2018(fin.rec.FIID, Number_Coupon, int(DataSet.Amount));
      else
        НалоговаяБаза = СуммаКуп;
      end;

      if(fin.rec.FaceValueFI != PayFIID)
        if( not SmartConvertSum(НалоговаяБаза, НалоговаяБаза, dat, fin.rec.FaceValueFI, PayFIID, true))
          return 1;
        end;
      end;
      if(fin.rec.FaceValueFI != NATCUR)
        if( not SmartConvertSum(НалоговаяБазаРуб, НалоговаяБаза, dat, fin.rec.FaceValueFI, NATCUR, true))
          return 1;
        end;
      else
        НалоговаяБазаРуб = НалоговаяБаза;
      end;
  
      НалоговаяБаза    = round(НалоговаяБаза, 2);
      НалоговаяБазаРуб = round(НалоговаяБазаРуб, 2);
      НалоговаяБазаРуб15 = $0;

      if(party.rec.LegalForm == PTLEGF_PERSN)

        if((Year >= 2021) and (party.rec.NotResident == UNSET_CHAR))
          GetIsIIS(party.rec.PartyID, dat, @isIIS, @ContractID);

          Sum2 = GetRubSumByClient(party.rec.PartyID, IIF(isIIS==true, TXOBJ_BASEG5, TXOBJ_BASEG2), date(1,1,Year), dat, null, null, null, null);

          if((НалоговаяБазаРуб+Sum2) > NPTX_LIMINCOME_MAX15)
            if(Sum2 > NPTX_LIMINCOME_MAX15)
              НалоговаяБазаРуб15 = НалоговаяБазаРуб;
              НалоговаяБазаРуб   = $0;
            else
              НалоговаяБазаРуб15 = НалоговаяБазаРуб + Sum2 - NPTX_LIMINCOME_MAX15;
              НалоговаяБазаРуб   = НалоговаяБазаРуб - НалоговаяБазаРуб15;
            end;
          end;

          Rate = NPTXGENTAXRATE_RESIDENT;
//          СуммаНалога = round(НалоговаяБазаРуб * Rate, 2);
          СуммаНалога = round(НалоговаяБазаРуб * Rate, 0); /*DAN*/
          СуммаНалогаФЛР   = СуммаНалогаФЛР   + СуммаНалога;

          СуммаНалога15 = round(НалоговаяБазаРуб15 * NPTXGENTAXRATE_RESIDENT_15, 2);
          СуммаНалогаФЛР15 = СуммаНалогаФЛР15 + СуммаНалога15;

        else
          var NptxObjKind2, NptxObjKind3;
  
          NptxObjKind2 = TXOBJ_PLUSG_1011;
          NptxObjKind3 = TXOBJ_PAIDGENERAL;
  
          if(IsCoprBondAfter2018_bef2021 == true)
            if(party.rec.NotResident == UNSET_CHAR)
              NptxObjKind2 = TXOBJ_PLUS35_3023;
              NptxObjKind3 = TXOBJ_PAID_35;
            end;
          end;
  
          SumQuery = "select " +
                     "(" +
                     "   select nvl(sum(nptxobjSum2.t_Sum0), 0) as t_Sum2 " +
                     "   from dnptxobj_dbt nptxobjSum2, dnptxobdc_dbt obdc, doproper_dbt oproper" +
                     "   where nptxobjSum2.t_Kind = ? " +
                     "     and nptxobjSum2.t_Client = party.t_PartyID" +
                     "     and nptxobjSum2.t_Date between ? and ?" +
                     "     and obdc.t_ObjID = nptxobjSum2.t_ObjID" +
                     "     and oproper.t_ID_Operation = obdc.t_DocID" +
                     "     and oproper.t_DocKind = " + string(DL_RETIREMENT_OWN) +
                     "     and rsb_secur.IsRET_COUPON(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(oproper.t_Kind_Operation, oproper.t_DocKind))) <> 0 " + //Погашение купона ВО (СЭБ)
                     ") t_Sum2," +
                     "(" +
                     "   select nvl(sum(nptxobjSum3.t_Sum0), 0) as t_Sum3" +
                     "   from dnptxobj_dbt nptxobjSum3, dnptxobdc_dbt obdc, doproper_dbt oproper" +
                     "   where nptxobjSum3.t_Kind = ? " + 
                     "     and nptxobjSum3.t_Client = party.t_PartyID" +
                     "     and nptxobjSum3.t_Date between ? and ?" +
                     "     and obdc.t_ObjID = nptxobjSum3.t_ObjID" +
                     "     and oproper.t_ID_Operation = obdc.t_DocID" +
                     "     and oproper.t_DocKind = " + string(DL_RETIREMENT_OWN) +
                     "     and rsb_secur.IsRET_COUPON(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(oproper.t_Kind_Operation, oproper.t_DocKind))) <> 0 " + //Погашение купона ВО (СЭБ)
                     ") as t_Sum3 " +
                     "from dparty_dbt party " +
                     "where party.t_PartyID = ?";
  
          SumSelect = DL_RSDCommand(SumQuery);
          SumSelect.AddParam(NptxObjKind2);
          SumSelect.AddParam(BegDate);
          SumSelect.AddParam(dat);
          SumSelect.AddParam(NptxObjKind3);
          SumSelect.AddParam(BegDate);
          SumSelect.AddParam(dat);
          SumSelect.AddParam(party.rec.PartyID);
          
          SumDS = SumSelect.Execute();
  
          if(SumDS.MoveNext())
             Sum2 = SumDS.Sum2;
             Sum3 = SumDS.Sum3;
          end;
    /*DAN i-suuport 512416*/
    //    Sum4 = НалоговаяБазаРуб + Sum2;
          Sum4 = НалоговаяБазаРуб;
  
          if(party.rec.NotResident == SET_CHAR)
              if(ПолучитьЗначениеПримечанияНаДату(party.rec.PartyID, PARTY_NOTE_KIND_NPTX_RATE_NOTRES, dat, @Rate) != 0) //если нет примечания
              Rate = NPTXGENTAXRATE_NOTRESIDENT;       
            end;
    
    //        СуммаНалога = round(Sum4 * Rate, 2) - Sum3;
	      СуммаНалога = round(Sum4 * Rate, 0) /*- Sum3*/; /*DAN i-suuport 512416*/
            СуммаНалогаФЛН = СуммаНалогаФЛН + СуммаНалога;
          else
  
            if(IsCoprBondAfter2018_bef2021 == true)
              Rate = 0.35;
            else
              Rate = NPTXGENTAXRATE_RESIDENT;
            end;
  
    //       СуммаНалога = round(Sum4 * Rate, 2) - Sum3;
	     СуммаНалога = round(Sum4 * Rate, 0) /*- Sum3*/; /*DAN i-suuport 512416*/
            СуммаНалогаФЛР = СуммаНалогаФЛР + СуммаНалога;
          end;
        end;

      elif((party.rec.LegalForm == PTLEGF_INST) and (IsNeresidentForNUTX(party.rec.PartyID, dat)))
  
        if(TaxGroupNUTX == NUTAXGROUP_20)
          Rate = GetTaxRateNUTX(INCOME_KIND_PERC, dat, FactReceiverID);
        elif(TaxGroupNUTX == NUTAXGROUP_15)
          var IfMarket = FIIfMarketNUTX(fin.rec.FIID, dat);
          if(IfMarket)
            Rate = GetTaxRateNUTX(INCOME_KIND_PRIVPERC, dat, FactReceiverID);
          else
            Rate = GetTaxRateNUTX(INCOME_KIND_PERC, dat, FactReceiverID);
          end;
        end;

/*DAN Проверка на налоговое освобождение */
        var NUTX_query, NUTX_cmd, NUTX_DataSet;
        NUTX_query = "SELECT taxe.T_HASCONFIRM,  taxe.t_note1 " +
                     "  FROM DPTAXEXEMP_DBT taxe " +
                     " WHERE taxe.T_PARTYID = ? AND ? BETWEEN taxe.T_STARTDATE AND taxe.T_ENDDATE " ;
        NUTX_cmd = DL_RSDCommand(NUTX_query);
        NUTX_cmd.AddParam(FactReceiverID);
        NUTX_cmd.AddParam(dat);
        NUTX_DataSet = NUTX_cmd.Execute();
        if ((NUTX_DataSet.MoveNext) and (NUTX_DataSet.HASCONFIRM == SET_CHAR))
          if(StrISNumber(NUTX_DataSet.Note1))  
            Rate = double(NUTX_DataSet.Note1) / 100;
          else
            Rate = 0;
          end;
        end; 
/*DAN*/

//      СуммаНалога = round(НалоговаяБазаРуб * Rate, 2);
        СуммаНалога = round(НалоговаяБазаРуб * Rate, 0); /*DAN */
        СуммаНалогаЮЛН = СуммаНалогаЮЛН + СуммаНалога;
      else
        НалоговаяБаза = $0;
        НалоговаяБазаРуб = $0;
        НалоговаяБазаРуб15 = $0;
      end;
    else
        НалоговаяБаза = $0;
        НалоговаяБазаРуб = $0;
        НалоговаяБазаРуб15 = $0;
    end;

    СуммаНом = $0;
    if(IncNominal == true)
      СуммаНом = round(Nominal*int(DataSet.Amount), 2);
    end;

    var sz = owntaxArr.size;
    owntaxArr[sz] = TRecHandler("scowntax.tmp");

    owntaxArr[sz].Clear();
    owntaxArr[sz].rec.SHID           = DataSet.SHID;
    owntaxArr[sz].rec.FactReceiverID = IIF(FactReceiverID <= 0, DataSet.Party, FactReceiverID);
    owntaxArr[sz].rec.PaySum         = СуммаНом + СуммаКуп;
    owntaxArr[sz].rec.PayCur         = fin.rec.FaceValueFI;
    owntaxArr[sz].rec.TaxBaseSum     = НалоговаяБазаРуб;
    owntaxArr[sz].rec.TaxBaseSum15   = НалоговаяБазаРуб15;
    owntaxArr[sz].rec.TaxRate        = Rate * 100.0;
    owntaxArr[sz].rec.TaxSum         = СуммаНалога;
    owntaxArr[sz].rec.TaxSum15       = СуммаНалога15;
    owntaxArr[sz].rec.NomSum         = СуммаНом;
    owntaxArr[sz].rec.CoupSum        = СуммаКуп;
  end;
   
  if((not err) and (owntaxArr.size > 0))
    onwtaxCache.AddRecordArray(owntaxArr);

    if(not onwtaxCache.Insert())
      err = 1;
    end;
  end;
  
  return err;
end;

macro ОЭБ_РассчитатьВыплатыПоПогашению(FD, dat:date)
  var TaxSum = 1;
  var rRqAcc = TRecHandler("dlrqacc.dbt");
  var rSA    = TRecHandler("settacc.dbt");
  var DlRq   = TRecHandler("dlrq.dbt");
  var party  = TRecHandler("party.dbt");
  var TaxReceiverID = -1, FactReceiverID = -1;
  var err = 0;   
  var СуммаНалогаЮЛН = $0, СуммаНалогаФЛН = $0, СуммаНалогаФЛР = $0, СуммаНалогаФЛР15 = $0;
  var Rate = 0;
  
  err = ОЭБ_ВычислитьВыплатыПоПогашению(FD.tick.rec.PFI, FD.tick.rec.Number_Coupon, dat, FD.dl_leg.rec.PayFIID, @СуммаНалогаЮЛН, @СуммаНалогаФЛН, @СуммаНалогаФЛР, IIF(IsRET_ISSUE(FD.Group), true, false), @СуммаНалогаФЛР15);

  if((not err) and (FD.avrserv() != NULL) and (FD.avrserv().rec.TaxAgent == SET_CHAR))

    if(ПолучитьСубъекта({OurBank}, party) == 0 )
      TaxReceiverID = party.rec.TaxInstitution;
    else
      msgbox("Не найден субъект с идентификатором " + {OurBank});
      err = 1;
    end;

    if((not err) and (TaxReceiverID == -1))
      msgbox("Для банка не указана налоговая инспекция");
      err = 1;
    end;
  
    if((not err) and (СуммаНалогаЮЛН > 0))
  
      rRqAcc.Clear();
      if(ПолучитьПлатежныеРеквизитыСубъектаПоСделке(FD.tick.rec.BofficeKind, FD.tick.rec.DealID, TaxReceiverID, DLRQ_SUBKIND_CURRENCY, NATCUR, DLRQ_TYPE_TAX_ULN, rRqAcc) != 0) //нет подходящих платежных реквизитов
        rSA.Clear();
        if(SP_GetPartySETTACC(TaxReceiverID, 0, NATCUR, FIKIND_CURRENCY, PTSK_STOCKDL, rSA, FD.tick.rec.DealType, PM_PURP_TAXINCOME_NJ) == 0)
          //создать новые платежные реквизиты
          rRqAcc.rec.ID               = 0;     
          rRqAcc.rec.DocKind          = FD.tick.rec.BofficeKind;     
          rRqAcc.rec.DocID            = FD.tick.rec.DealID;     
          rRqAcc.rec.SubKind          = DLRQ_SUBKIND_CURRENCY;     
          rRqAcc.rec.Type             = DLRQ_TYPE_TAX_ULN;     
          rRqAcc.rec.Party            = TaxReceiverID;     
          rRqAcc.rec.FIID             = rSA.rec.FIID;                 
          rRqAcc.rec.BankID           = rSA.rec.BankID;               
          rRqAcc.rec.Chapter          = rSA.rec.Chapter;              
          rRqAcc.rec.Account          = rSA.rec.Account;         
          rRqAcc.rec.BankCodeKind     = rSA.rec.BankCodeKind;         
          rRqAcc.rec.BankCode         = rSA.rec.BankCode;        
          rRqAcc.rec.BankName         = rSA.rec.BankName;        
          rRqAcc.rec.BankCorrID       = rSA.rec.BankCorrID;           
          rRqAcc.rec.BankCorrCodeKind = rSA.rec.BankCorrCodeKind;     
          rRqAcc.rec.BankCorrCode     = rSA.rec.BankCorrCode;    
          rRqAcc.rec.BankCorrName     = rSA.rec.BankCorrName;    
          rRqAcc.rec.CorrAcc          = rSA.rec.CorrAcc;         
  
        else
          msgbox("Не найдена СПИ по деньгам для субъекта с ID = "+TaxReceiverID);
          err = 1;
        end;
      end;

      if(not err)
        DlRq.Clear();
        DlRq.rec.DocKind  = FD.tick.rec.BofficeKind;
        DlRq.rec.DocID    = FD.tick.rec.DealID;     
        DlRq.rec.DealPart = 1;
        DlRq.rec.Kind     = DLRQ_KIND_COMMIT;
        DlRq.rec.SubKind  = DLRQ_SUBKIND_CURRENCY;
        DlRq.rec.Type     = DLRQ_TYPE_TAX_ULN;
        DlRq.rec.Amount   = СуммаНалогаЮЛН;
        DlRq.rec.FIID     = NATCUR;
        DlRq.rec.Party    = TaxReceiverID;
        DlRq.rec.RqAccID  = rRqAcc.rec.ID;
        DlRq.rec.PlaceID  = iif(rRqAcc.rec.BANKCORRID > 0, rRqAcc.rec.BANKCORRID, rRqAcc.rec.BANKID);
        DlRq.rec.State    = DLRQ_STATE_PLAN;
        DlRq.rec.PlanDate = FD.dl_leg.rec.Expiry;
        DlRq.rec.FactDate = date(0,0,0);
       
        if( DL_CreateDLRQ(DlRq, dat, DLRQ_ACTION_CREATE, NULL, rRqAcc) != 0 )
           msgbox( "Ошибка при создании ТО по налогу по сделке с ID = "+string(FD.tick.rec.DealID)+": "+GetErrMsg() );
           err = 1;
        end;
      end;
    end;

    if((not err) and (СуммаНалогаФЛН > 0))
  
      rRqAcc.Clear();
      if(ПолучитьПлатежныеРеквизитыСубъектаПоСделке(FD.tick.rec.BofficeKind, FD.tick.rec.DealID, TaxReceiverID, DLRQ_SUBKIND_CURRENCY, NATCUR, DLRQ_TYPE_TAX_FLN, rRqAcc) != 0) //нет подходящих платежных реквизитов
        rSA.Clear();
        if(SP_GetPartySETTACC(TaxReceiverID, 0, NATCUR, FIKIND_CURRENCY, PTSK_STOCKDL, rSA, FD.tick.rec.DealType, PM_PURP_TAXINCOME_IND) == 0)
          //создать новые платежные реквизиты
          rRqAcc.rec.ID               = 0;     
          rRqAcc.rec.DocKind          = FD.tick.rec.BofficeKind;     
          rRqAcc.rec.DocID            = FD.tick.rec.DealID;     
          rRqAcc.rec.SubKind          = DLRQ_SUBKIND_CURRENCY;     
          rRqAcc.rec.Type             = DLRQ_TYPE_TAX_FLN;     
          rRqAcc.rec.Party            = TaxReceiverID;     
          rRqAcc.rec.FIID             = rSA.rec.FIID;                 
          rRqAcc.rec.BankID           = rSA.rec.BankID;               
          rRqAcc.rec.Chapter          = rSA.rec.Chapter;              
          rRqAcc.rec.Account          = rSA.rec.Account;         
          rRqAcc.rec.BankCodeKind     = rSA.rec.BankCodeKind;         
          rRqAcc.rec.BankCode         = rSA.rec.BankCode;        
          rRqAcc.rec.BankName         = rSA.rec.BankName;        
          rRqAcc.rec.BankCorrID       = rSA.rec.BankCorrID;           
          rRqAcc.rec.BankCorrCodeKind = rSA.rec.BankCorrCodeKind;     
          rRqAcc.rec.BankCorrCode     = rSA.rec.BankCorrCode;    
          rRqAcc.rec.BankCorrName     = rSA.rec.BankCorrName;    
          rRqAcc.rec.CorrAcc          = rSA.rec.CorrAcc;         
  
        else
          msgbox("Не найдена СПИ по деньгам для субъекта с ID = "+TaxReceiverID);
          err = 1;
        end;
      end;

      if(not err)
        DlRq.Clear();
        DlRq.rec.DocKind  = FD.tick.rec.BofficeKind;
        DlRq.rec.DocID    = FD.tick.rec.DealID;     
        DlRq.rec.DealPart = 1;
        DlRq.rec.Kind     = DLRQ_KIND_COMMIT;
        DlRq.rec.SubKind  = DLRQ_SUBKIND_CURRENCY;
        DlRq.rec.Type     = DLRQ_TYPE_TAX_FLN;
        DlRq.rec.Amount   = СуммаНалогаФЛН;
        DlRq.rec.FIID     = NATCUR;
        DlRq.rec.Party    = TaxReceiverID;
        DlRq.rec.RqAccID  = rRqAcc.rec.ID;
        DlRq.rec.PlaceID  = iif(rRqAcc.rec.BANKCORRID > 0, rRqAcc.rec.BANKCORRID, rRqAcc.rec.BANKID);
        DlRq.rec.State    = DLRQ_STATE_PLAN;
        DlRq.rec.PlanDate = FD.dl_leg.rec.Expiry;
        DlRq.rec.FactDate = date(0,0,0);
       
        if( DL_CreateDLRQ(DlRq, dat, DLRQ_ACTION_CREATE, NULL, rRqAcc) != 0 )
           msgbox( "Ошибка при создании ТО по налогу по сделке с ID = "+string(FD.tick.rec.DealID)+": "+GetErrMsg() );
           err = 1;
        end;
      end;
  
    end;

    if((not err) and (СуммаНалогаФЛР > 0))
  
      rRqAcc.Clear();
      if(ПолучитьПлатежныеРеквизитыСубъектаПоСделке(FD.tick.rec.BofficeKind, FD.tick.rec.DealID, TaxReceiverID, DLRQ_SUBKIND_CURRENCY, NATCUR, DLRQ_TYPE_TAX_FLR, rRqAcc) != 0) //нет подходящих платежных реквизитов
        rSA.Clear();
        if(SP_GetPartySETTACC(TaxReceiverID, 0, NATCUR, FIKIND_CURRENCY, PTSK_STOCKDL, rSA, FD.tick.rec.DealType, PM_PURP_TAXINCOME_IND) == 0)
          //создать новые платежные реквизиты
          rRqAcc.rec.ID               = 0;     
          rRqAcc.rec.DocKind          = FD.tick.rec.BofficeKind;     
          rRqAcc.rec.DocID            = FD.tick.rec.DealID;     
          rRqAcc.rec.SubKind          = DLRQ_SUBKIND_CURRENCY;     
          rRqAcc.rec.Type             = DLRQ_TYPE_TAX_FLR;     
          rRqAcc.rec.Party            = TaxReceiverID;     
          rRqAcc.rec.FIID             = rSA.rec.FIID;                 
          rRqAcc.rec.BankID           = rSA.rec.BankID;               
          rRqAcc.rec.Chapter          = rSA.rec.Chapter;              
          rRqAcc.rec.Account          = rSA.rec.Account;         
          rRqAcc.rec.BankCodeKind     = rSA.rec.BankCodeKind;         
          rRqAcc.rec.BankCode         = rSA.rec.BankCode;        
          rRqAcc.rec.BankName         = rSA.rec.BankName;        
          rRqAcc.rec.BankCorrID       = rSA.rec.BankCorrID;           
          rRqAcc.rec.BankCorrCodeKind = rSA.rec.BankCorrCodeKind;     
          rRqAcc.rec.BankCorrCode     = rSA.rec.BankCorrCode;    
          rRqAcc.rec.BankCorrName     = rSA.rec.BankCorrName;    
          rRqAcc.rec.CorrAcc          = rSA.rec.CorrAcc;         
  
        else
          msgbox("Не найдена СПИ по деньгам для субъекта с ID = "+TaxReceiverID);
          err = 1;
        end;
      end;
  
      if(not err)
        DlRq.Clear();
        DlRq.rec.DocKind  = FD.tick.rec.BofficeKind;
        DlRq.rec.DocID    = FD.tick.rec.DealID;     
        DlRq.rec.DealPart = 1;
        DlRq.rec.Kind     = DLRQ_KIND_COMMIT;
        DlRq.rec.SubKind  = DLRQ_SUBKIND_CURRENCY;
        DlRq.rec.Type     = DLRQ_TYPE_TAX_FLR;
        DlRq.rec.Amount   = СуммаНалогаФЛР;
        DlRq.rec.FIID     = NATCUR;
        DlRq.rec.Party    = TaxReceiverID;
        DlRq.rec.RqAccID  = rRqAcc.rec.ID;
        DlRq.rec.PlaceID  = iif(rRqAcc.rec.BANKCORRID > 0, rRqAcc.rec.BANKCORRID, rRqAcc.rec.BANKID);
        DlRq.rec.State    = DLRQ_STATE_PLAN;
        DlRq.rec.PlanDate = FD.dl_leg.rec.Expiry;
        DlRq.rec.FactDate = date(0,0,0);
       
        if( DL_CreateDLRQ(DlRq, dat, DLRQ_ACTION_CREATE, NULL, rRqAcc) != 0 )
           msgbox( "Ошибка при создании ТО по налогу по сделке с ID = "+string(FD.tick.rec.DealID)+": "+GetErrMsg() );
           err = 1;
        end;
      end;
    end;

    if((not err) and (СуммаНалогаФЛР15 > 0))

      rRqAcc.Clear();
      if(ПолучитьПлатежныеРеквизитыСубъектаПоСделке(FD.tick.rec.BofficeKind, FD.tick.rec.DealID, TaxReceiverID, DLRQ_SUBKIND_CURRENCY, NATCUR, DLRQ_TYPE_TAX_FLR_ADD, rRqAcc) != 0) //нет подходящих платежных реквизитов
        rSA.Clear();
        if(SP_GetPartySETTACC(TaxReceiverID, 0, NATCUR, FIKIND_CURRENCY, PTSK_STOCKDL, rSA, FD.tick.rec.DealType, PM_PURP_TAXINCOME_IND) == 0)
          //создать новые платежные реквизиты
          rRqAcc.rec.ID               = 0;     
          rRqAcc.rec.DocKind          = FD.tick.rec.BofficeKind;     
          rRqAcc.rec.DocID            = FD.tick.rec.DealID;     
          rRqAcc.rec.SubKind          = DLRQ_SUBKIND_CURRENCY;     
          rRqAcc.rec.Type             = DLRQ_TYPE_TAX_FLR_ADD;     
          rRqAcc.rec.Party            = TaxReceiverID;     
          rRqAcc.rec.FIID             = rSA.rec.FIID;                 
          rRqAcc.rec.BankID           = rSA.rec.BankID;               
          rRqAcc.rec.Chapter          = rSA.rec.Chapter;              
          rRqAcc.rec.Account          = rSA.rec.Account;         
          rRqAcc.rec.BankCodeKind     = rSA.rec.BankCodeKind;         
          rRqAcc.rec.BankCode         = rSA.rec.BankCode;        
          rRqAcc.rec.BankName         = rSA.rec.BankName;        
          rRqAcc.rec.BankCorrID       = rSA.rec.BankCorrID;           
          rRqAcc.rec.BankCorrCodeKind = rSA.rec.BankCorrCodeKind;     
          rRqAcc.rec.BankCorrCode     = rSA.rec.BankCorrCode;    
          rRqAcc.rec.BankCorrName     = rSA.rec.BankCorrName;    
          rRqAcc.rec.CorrAcc          = rSA.rec.CorrAcc;         

        else
          msgbox("Не найдена налоговая СПИ для субъекта с ID = "+TaxReceiverID);
          err = 1;
        end;
      end;

      if(not err)
        DlRq.Clear();
        DlRq.rec.DocKind  = FD.tick.rec.BofficeKind;
        DlRq.rec.DocID    = FD.tick.rec.DealID;     
        DlRq.rec.DealPart = 1;
        DlRq.rec.Kind     = DLRQ_KIND_COMMIT;
        DlRq.rec.SubKind  = DLRQ_SUBKIND_CURRENCY;
        DlRq.rec.Type     = DLRQ_TYPE_TAX_FLR_ADD;
        DlRq.rec.Amount   = СуммаНалогаФЛР15;
        DlRq.rec.FIID     = NATCUR;
        DlRq.rec.Party    = TaxReceiverID;
        DlRq.rec.RqAccID  = rRqAcc.rec.ID;
        DlRq.rec.PlaceID  = iif(rRqAcc.rec.BANKCORRID > 0, rRqAcc.rec.BANKCORRID, rRqAcc.rec.BANKID);
        DlRq.rec.State    = DLRQ_STATE_PLAN;
        DlRq.rec.PlanDate = FD.dl_leg.rec.Expiry;
        DlRq.rec.FactDate = date(0,0,0);
       
        if( DL_CreateDLRQ(DlRq, dat, DLRQ_ACTION_CREATE, NULL, rRqAcc) != 0 )
           msgbox( "Ошибка при создании ТО по налогу по сделке с ID = "+string(FD.tick.rec.DealID)+": "+GetErrMsg() );
           err = 1;
        end;
      end;
    end;
  end;

  if((not err) and (FD.ExistRqPayIncome()))
    var PayImcome = FD.GetRQ(DLRQ_TYPE_PAYINCOME).rec.Amount - СуммаНалогаЮЛН - СуммаНалогаФЛН - СуммаНалогаФЛР - СуммаНалогаФЛР15;
    
    FD.GetRQ(DLRQ_TYPE_PAYINCOME).rec.Amount = PayImcome;
  end;

  if(not err)
    err = SC_SaveOwnTaxFromTMP();
  end;

  return err;
end;

macro ПолучитьКодКомиссииОЭБ_ПГКУП()
  return "ПГ_КУП";
end;

macro ПолучитьКодКомиссииОЭБ_ПГВЫП()
  return "ПГ_ВЫП";
end;

//Рассчитать комиссию платежному агенту при погашении ц/б или купона ОЭБ
macro ОЭБ_РассчитатьКомиссиюПАПриПогашении(FD, CommCode:string, dat:date, Sum:@money, NDS:@money)
  var err = 0, errMes = "";
  var ArrComSums = TArray();
  var query, cmd, DataSet;
  var rRqAcc = TRecHandler("dlrqacc.dbt");
  var rSA    = TRecHandler("settacc.dbt");
  var dlcomis= TRecHandler("dlcomis.dbt");
  var SfContrID = 0;

  Sum = $0;
  NDS = $0;

  if((FD.avrserv() == NULL) or (FD.avrserv().rec.PartyContrP <= 0))
    msgbox("В параметрах обслуживания выпуска ц/б не указан договор с платежным агентом");
    return 1;
  end;
  
  if(FD.avrserv().rec.PartyP == {OurBank})
    return 0;
  end;
  
  SfContrID = FD.avrserv().rec.PartyContrP;


  query =   " select contr.t_ContractorID, concom.t_ID as ConComID, concom.t_CommNumber, cm.t_FIID_COMM, cm.t_PayNDS, cm.t_ReceiverID "
          + "   from dsfcontr_dbt contr, dsfconcom_dbt concom, dsfcomiss_dbt cm "
          + "  where contr.t_ID = ? "
          + "    and concom.t_ObjectType = " + OBJTYPE_SFCONTR
          + "    and concom.t_ObjectID = contr.t_ID " 
          + "    and concom.t_FeeType = " + SF_FEE_TYPE_SINGLE
          + "    and (concom.t_DateBegin = "+GetSQLDate(date(0,0,0))+" or concom.t_DateBegin <= ?) "
          + "    and cm.t_FeeType = concom.t_FeeType "
          + "    and cm.t_Number = concom.t_CommNumber "
          + "    and cm.t_Code = ? ";

  cmd = DL_RSdCommand(query);

  cmd.AddParam(SfContrID);
  cmd.AddParam(dat);
  cmd.AddParam(CommCode);

  DataSet = cmd.Execute();
  
  if(DataSet.MoveNext())
    if(SfCalcOprSfCom(SfContrID, DataSet.CommNumber, FD.tick, FD.tick.rec.BOfficeKind, $0, -1, NULL, NULL, Sum, NDS) == false)
      Sum = $0;
      NDS = $0;
      msgbox( "Ошибка расчета сумм периодической комиссии с номером "+DataSet.CommNumber+".\n" + errMes) ;
      err = 1;
    end;

    if((not err) and (Sum > 0))
      rRqAcc.Clear();
      if(ПолучитьПлатежныеРеквизитыСубъектаПоСделке(FD.tick.rec.BofficeKind, FD.tick.rec.DealID, DataSet.ReceiverID, DLRQ_SUBKIND_CURRENCY, DataSet.t_FIID_COMM, DLRQ_TYPE_COMISS, rRqAcc) != 0) //нет подходящих платежных реквизитов
        rSA.Clear();
        if(SP_GetPartySETTACC(DataSet.ReceiverID, 0, DataSet.FIID_COMM, FIKIND_CURRENCY, 0, rSA) == 0)
          //создать новые платежные реквизиты
          rRqAcc.rec.ID               = 0;     
          rRqAcc.rec.DocKind          = FD.tick.rec.BofficeKind;     
          rRqAcc.rec.DocID            = FD.tick.rec.DealID;     
          rRqAcc.rec.SubKind          = DLRQ_SUBKIND_CURRENCY;     
          rRqAcc.rec.Type             = DLRQ_TYPE_COMISS;     
          rRqAcc.rec.Party            = DataSet.ReceiverID;     
          rRqAcc.rec.FIID             = rSA.rec.FIID;                 
          rRqAcc.rec.BankID           = rSA.rec.BankID;               
          rRqAcc.rec.Chapter          = rSA.rec.Chapter;              
          rRqAcc.rec.Account          = rSA.rec.Account;         
          rRqAcc.rec.BankCodeKind     = rSA.rec.BankCodeKind;         
          rRqAcc.rec.BankCode         = rSA.rec.BankCode;        
          rRqAcc.rec.BankName         = rSA.rec.BankName;        
          rRqAcc.rec.BankCorrID       = rSA.rec.BankCorrID;           
          rRqAcc.rec.BankCorrCodeKind = rSA.rec.BankCorrCodeKind;     
          rRqAcc.rec.BankCorrCode     = rSA.rec.BankCorrCode;    
          rRqAcc.rec.BankCorrName     = rSA.rec.BankCorrName;    
          rRqAcc.rec.CorrAcc          = rSA.rec.CorrAcc;         

          if( DL_InsertDLRQACC(rRqAcc) )
            msgbox("Ошибка вставки платежных реквизитов для комиссии с номером \""+DataSet.CommNumber+"\" по сделке с ID = "+string(FD.tick.rec.DealID)+": "+GetErrMsg());
            err = 1;
          end;
        else
          msgbox("Не найдена СПИ по деньгам для субъекта с ID = "+DataSet.ReceiverID);
          err = 1;
        end;
      end;

      if(not err)
        dlcomis.Clear();
        dlcomis.rec.DOCKIND     = FD.tick.rec.BofficeKind;
        dlcomis.rec.DOCID       = FD.tick.rec.DealID;
        dlcomis.rec.CONTRACT    = SfContrID;
        dlcomis.rec.FEETYPE     = SF_FEE_TYPE_SINGLE;
        dlcomis.rec.COMNUMBER   = DataSet.CommNumber;

        if(DataSet.PayNDS == SF_NOT_ADD_TAX)
          dlcomis.rec.SUM = Sum + NDS;
        else 
          dlcomis.rec.SUM = Sum; 
        end;
        
        dlcomis.rec.NDS         = NDS;
        dlcomis.rec.DATE        =
        dlcomis.rec.PLANPAYDATE = 
        dlcomis.rec.FACTPAYDATE = dat;
        dlcomis.rec.INPUTMEDIUM = GetInputMedium(INPUTMEDIUM_CALC);

        dlcomis.rec.IMMATERIAL  = UNSET_CHAR;
                    
        if( not OprInsertDLCOMIS( dlcomis ) )
          msgbox(GetErrMsg());
          err = 1;
        end;
      end;
    end;
  end;

  return err;
end;


macro ОЭБ_НДРПриПогашКупона(FD, dat:date, ID_Operation:integer, ID_Step:integer)
  var query, cmd, DataSet;
  var err = 0;
  var СуммаВыплаты = $0, СуммаВыплатыРуб = $0;
  var СуммаНалога  = $0, СуммаНалога15 = $0;
  var Circulate = 0, TaxGroupNPTX = 0, TaxGroupNUTX = 0;
  var Kind = 0;
  var TaxReceiverID = -1, FactReceiverID = -1, OwnerID = -1;
  var ContractID = 0;
  var IsIIS = false;
  var party = TRecHandler("party.dbt");
  var fin   = TBFile("fininstr.dbt");
  var ErrNum = 0;
  var IsCoprBondAfter2018_bef2021 = false;
  var TaxBaseSum35 = $0;

  fin.Clear();
  fin.rec.FIID = FD.tick.rec.PFI;
  
  if(not fin.GetEQ())
    msgbox("Не найдена ц/б с идентификатором " + FD.tick.rec.PFI);
    return 1;
  end;

  if((dat < date(01,01,2021)) and 
     (fin.rec.FaceValueFI == NATCUR) and 
     (DL_NPTX_IsCorpBondAfter2018(fin.rec.FIID, FD.tick.rec.Number_Coupon))
    )
    IsCoprBondAfter2018_bef2021 = true;
  end;

  query =  " select NPTO.Market1date(?, ?) t_Circulate, "
         + "        NPTO.GetPaperTaxGroupNPTX(?) t_TaxGroupNPTX, "
         + "        RSI_NUTX.GetNUTaxGroup(?, ?) t_TaxGroupNUTX"
         + "   from dual";

  cmd = Dl_RSDCommand(query);

  cmd.AddParam(FD.tick.rec.PFI);
  cmd.AddParam(dat);
  cmd.AddParam(FD.tick.rec.PFI);
  cmd.AddParam(FD.tick.rec.PFI);
  cmd.AddParam(dat);
  
  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    Circulate    = int(DataSet.Circulate);
    TaxGroupNPTX = int(DataSet.TaxGroupNPTX);
    TaxGroupNUTX = int(DataSet.TaxGroupNUTX);

    query =   " select sh.t_OwnerID, tx.t_FactReceiverID, tx.t_PaySum, tx.t_PayCur, tx.t_TaxSum, tx.t_TaxRate, tx.t_TaxBaseSum, tx.t_TaxBaseSum15, tx.t_TaxSum15, "
            + "        NVL((select sf.t_ID "
            + "               from dsfcontr_dbt sf "
            + "              where sf.t_ServKind = " + PTSK_STOCKDL
            + "                and sf.t_PartyID = sh.t_OwnerID "
            + "                and sf.t_DateBegin <= ? "
            + "                and (sf.t_DateClose = "+GetSQLDate(date(0,0,0))+" or sf.t_DateClose >= ?) "
            + "                and rsi_npto.CheckContrIIS(sf.t_ID) = 0 "
            + "                and rownum = 1"
            + "            ), 0) as NotIISSfContrID, "
            + "        NVL((select sf.t_ID "
            + "               from dsfcontr_dbt sf "
            + "              where sf.t_ServKind = " + PTSK_STOCKDL
            + "                and sf.t_PartyID = sh.t_OwnerID "
            + "                and sf.t_DateBegin <= ? "
            + "                and (sf.t_DateClose = "+GetSQLDate(date(0,0,0))+" or sf.t_DateClose >= ?) "
            + "                and rsi_npto.CheckContrIIS(sf.t_ID) = 1 "
            + "                and rownum = 1"
            + "            ), 0) as IISSfContrID "
            + "   from dscownlist_dbt ls, dscownhist_dbt sh, dscowntax_dbt tx "
            + "  where ls.t_FIID = ? "
            + "    and ls.t_Number_Coupon = ? "
            + "    and sh.t_ListID = ls.t_ListID "
            + "    and tx.t_SHID = sh.t_ID "
            + "    and (tx.t_TaxSum > 0 or tx.t_TaxSum15 > 0) ";
 
    cmd = DL_RSDCommand(query);

    cmd.AddParam(dat);
    cmd.AddParam(dat);
    cmd.AddParam(dat);
    cmd.AddParam(dat);
    cmd.AddParam(FD.tick.rec.PFI);
    cmd.AddParam(FD.tick.rec.Number_Coupon);

    DataSet = cmd.Execute();

    while((not err) and (DataSet.moveNext())) //для каждого владельца

      OwnerID = DataSet.OwnerID;

      if(ПолучитьСубъекта(OwnerID, party) != 0 )
        msgbox("Не найден субъект с идентификатором " + OwnerID);
        return 1;
      end;

      FactReceiverID = DataSet.FactReceiverID;

      if(FactReceiverID == -1)
        continue;
      end;

      if(ПолучитьСубъекта(FactReceiverID, party) != 0 )
        msgbox("Не найден субъект с идентификатором " + FactReceiverID);
        return 1;
      end;

      GetIsIIS(OwnerID, dat, @isIIS, @ContractID);

      СуммаВыплаты = DataSet.PaySum;
      if(DataSet.PayCur != FD.dl_leg.rec.PayFIID)
        if( not SmartConvertSum(СуммаВыплаты, СуммаВыплаты, dat, DataSet.PayCur, FD.dl_leg.rec.PayFIID, true))
          return 1;
        end;
      end;
      if(DataSet.PayCur != NATCUR)
        if( not SmartConvertSum(СуммаВыплатыРуб, СуммаВыплаты, dat, DataSet.PayCur, NATCUR, true))
          return 1;
        end;
      else
        СуммаВыплатыРуб = СуммаВыплаты;
      end;

      СуммаВыплаты    = round(СуммаВыплаты, 2);
      СуммаВыплатыРуб = round(СуммаВыплатыРуб, 2);

      СуммаНалога = DataSet.TaxSum;
      СуммаНалога15 = DataSet.TaxSum15;

      if(party.rec.LegalForm == PTLEGF_PERSN)

        if((IsCoprBondAfter2018_bef2021 == true) and (DataSet.TaxRate == 35))
          TaxBaseSum35 = money(DataSet.TaxBaseSum);

          if(TaxBaseSum35 != 0)
            err = DL_NPTX_InsertTaxObject( dat                   // Дата НДР
                                          ,FactReceiverID        // Клиент
                                          ,TXOBJ_DIR_IN          // Направление
                                          ,2                     // Уровень
                                          ,""                    // Признак "Пользовательский"
                                          ,TXOBJ_PROCSEC_TS_35   // Вид НДР
                                          ,TaxBaseSum35          // Сумма дохода/расхода
                                          ,NATCUR                // Валюта дохода/расхода
                                          ,TXOBJ_KIND1020        // Вид аналитики 1
                                          ,FD.tick.rec.DealID    // Аналитика 1
                                          ,0                     // Вид аналитики 2
                                          ,-1                    // Аналитика 2
                                          ,TXOBJ_KIND3010        // Вид аналитики 3
                                          ,FD.tick.rec.PFI       // Аналитика 3
                                          ,TXOBJ_KIND4010        // Вид аналитики 4
                                          ,Circulate             // Аналитика 4
                                          ,TXOBJ_KIND5010        // Вид аналитики 5
                                          ,TaxGroupNPTX          // Аналитика 5
                                          ,IIF(ContractID > 0, TXOBJ_KIND6020, 0) // Вид аналитики 6
                                          ,ContractID            // Аналитика 6
                                          ,""                    // Комментарий
                                          ,ID_Operation          // ID операции
                                          ,ID_Step               // ID шага операции
                                          ,1 );                  // Признак вызова не из операции расчета НОБ
          
            if(not err)
              err = DL_NPTX_InsertTaxObject( dat                   // Дата НДР
                                            ,FactReceiverID        // Клиент
                                            ,TXOBJ_DIR_IN          // Направление
                                            ,5                     // Уровень
                                            ,""                    // Признак "Пользовательский"
                                            ,TXOBJ_PLUS35_3023     // Вид НДР
                                            ,TaxBaseSum35          // Сумма дохода/расхода
                                            ,NATCUR                // Валюта дохода/расхода
                                            ,TXOBJ_KIND1020        // Вид аналитики 1
                                            ,FD.tick.rec.DealID    // Аналитика 1
                                            ,0                     // Вид аналитики 2
                                            ,-1                    // Аналитика 2
                                            ,TXOBJ_KIND3010        // Вид аналитики 3
                                            ,FD.tick.rec.PFI       // Аналитика 3
                                            ,TXOBJ_KIND4010        // Вид аналитики 4
                                            ,Circulate             // Аналитика 4
                                            ,TXOBJ_KIND5010        // Вид аналитики 5
                                            ,TaxGroupNPTX          // Аналитика 5
                                            ,IIF(ContractID > 0, TXOBJ_KIND6020, 0) // Вид аналитики 6
                                            ,ContractID            // Аналитика 6
                                            ,""                    // Комментарий
                                            ,ID_Operation          // ID операции
                                            ,ID_Step               // ID шага операции
                                            ,1 );                  // Признак вызова не из операции расчета НОБ
            end;

            if(not err)
              err = DL_NPTX_InsertTaxObject( dat                   // Дата НДР
                                            ,FactReceiverID        // Клиент
                                            ,TXOBJ_DIR_IN          // Направление
                                            ,7                     // Уровень
                                            ,""                    // Признак "Пользовательский"
                                            ,TXOBJ_BASE_35         // Вид НДР
                                            ,TaxBaseSum35          // Сумма дохода/расхода
                                            ,NATCUR                // Валюта дохода/расхода
                                            ,TXOBJ_KIND1020        // Вид аналитики 1
                                            ,FD.tick.rec.DealID    // Аналитика 1
                                            ,0                     // Вид аналитики 2
                                            ,-1                    // Аналитика 2
                                            ,TXOBJ_KIND3010        // Вид аналитики 3
                                            ,FD.tick.rec.PFI       // Аналитика 3
                                            ,TXOBJ_KIND4010        // Вид аналитики 4
                                            ,Circulate             // Аналитика 4
                                            ,TXOBJ_KIND5010        // Вид аналитики 5
                                            ,TaxGroupNPTX          // Аналитика 5
                                            ,IIF(ContractID > 0, TXOBJ_KIND6020, 0) // Вид аналитики 6
                                            ,ContractID            // Аналитика 6
                                            ,""                    // Комментарий
                                            ,ID_Operation          // ID операции
                                            ,ID_Step               // ID шага операции
                                            ,1 );                  // Признак вызова не из операции расчета НОБ
            end;

            if((not err) and (DataSet.TaxSum != 0))
              err = DL_NPTX_InsertTaxObject( dat                   // Дата НДР
                                            ,FactReceiverID        // Клиент
                                            ,TXOBJ_DIR_OUT         // Направление
                                            ,8                     // Уровень
                                            ,""                    // Признак "Пользовательский"
                                            ,TXOBJ_PAID_35         // Вид НДР
                                            ,money(DataSet.TaxSum) // Сумма дохода/расхода
                                            ,NATCUR                // Валюта дохода/расхода
                                            ,TXOBJ_KIND1020        // Вид аналитики 1
                                            ,FD.tick.rec.DealID    // Аналитика 1
                                            ,0                     // Вид аналитики 2
                                            ,-1                    // Аналитика 2
                                            ,TXOBJ_KIND3010        // Вид аналитики 3
                                            ,FD.tick.rec.PFI       // Аналитика 3
                                            ,TXOBJ_KIND4010        // Вид аналитики 4
                                            ,Circulate             // Аналитика 4
                                            ,TXOBJ_KIND5010        // Вид аналитики 5
                                            ,TaxGroupNPTX          // Аналитика 5
                                            ,IIF(ContractID > 0, TXOBJ_KIND6020, 0) // Вид аналитики 6
                                            ,ContractID            // Аналитика 6
                                            ,""                    // Комментарий
                                            ,ID_Operation          // ID операции
                                            ,ID_Step               // ID шага операции
                                            ,1 );                  // Признак вызова не из операции расчета НОБ
            end;
          
          end;
        else

          err = DL_NPTX_InsertTaxObject( dat                   // Дата НДР
                                        ,FactReceiverID        // Клиент
                                        ,TXOBJ_DIR_IN          // Направление
                                        ,2                     // Уровень
                                        ,""                    // Признак "Пользовательский"
                                        ,TXOBJ_PROCSEC_TS      // Вид НДР
                                        ,СуммаВыплаты          // Сумма дохода/расхода
                                        ,FD.dl_leg.rec.PayFIID // Валюта дохода/расхода
                                        ,TXOBJ_KIND1020        // Вид аналитики 1
                                        ,FD.tick.rec.DealID    // Аналитика 1
                                        ,0                     // Вид аналитики 2
                                        ,-1                    // Аналитика 2
                                        ,TXOBJ_KIND3010        // Вид аналитики 3
                                        ,FD.tick.rec.PFI       // Аналитика 3
                                        ,TXOBJ_KIND4010        // Вид аналитики 4
                                        ,Circulate             // Аналитика 4
                                        ,TXOBJ_KIND5010        // Вид аналитики 5
                                        ,TaxGroupNPTX          // Аналитика 5
                                        ,TXOBJ_KIND6020        // Вид аналитики 6
                                        ,ContractID            // Аналитика 6
                                        ,""                    // Комментарий
                                        ,ID_Operation          // ID операции
                                        ,ID_Step               // ID шага операции
                                        ,1 );                  // Признак вызова не из операции расчета НОБ
          if(not err)
            Kind = IIF(IsIIS == true, TXOBJ_PLUSG_1011_IIS, TXOBJ_PLUSG_1011);
            
            err = DL_NPTX_InsertTaxObject( dat                   // Дата НДР
                                          ,FactReceiverID        // Клиент
                                          ,TXOBJ_DIR_IN          // Направление
                                          ,5                     // Уровень
                                          ,""                    // Признак "Пользовательский"
                                          ,Kind                  // Вид НДР
                                          ,СуммаВыплатыРуб       // Сумма дохода/расхода
                                          ,NATCUR                // Валюта дохода/расхода
                                          ,TXOBJ_KIND1020        // Вид аналитики 1
                                          ,FD.tick.rec.DealID    // Аналитика 1
                                          ,0                     // Вид аналитики 2
                                          ,-1                    // Аналитика 2
                                          ,TXOBJ_KIND3010        // Вид аналитики 3
                                          ,FD.tick.rec.PFI       // Аналитика 3
                                          ,TXOBJ_KIND4010        // Вид аналитики 4
                                          ,Circulate             // Аналитика 4
                                          ,TXOBJ_KIND5010        // Вид аналитики 5
                                          ,TaxGroupNPTX          // Аналитика 5
                                          ,IIF(ContractID > 0, TXOBJ_KIND6020, 0) // Вид аналитики 6
                                          ,ContractID            // Аналитика 6
                                          ,""                    // Комментарий
                                          ,ID_Operation          // ID операции
                                          ,ID_Step               // ID шага операции
                                          ,1 );                  // Признак вызова не из операции расчета НОБ
          end;
          
          if(not err)
            Kind = IIF(IsIIS == true, TXOBJ_BASEGENERAL_IIS, TXOBJ_BASEGENERAL);
            
            err = DL_NPTX_InsertTaxObject( dat                   // Дата НДР
                                          ,FactReceiverID        // Клиент
                                          ,TXOBJ_DIR_IN          // Направление
                                          ,7                     // Уровень
                                          ,""                    // Признак "Пользовательский"
                                          ,Kind                  // Вид НДР
                                          ,СуммаВыплатыРуб       // Сумма дохода/расхода
                                          ,NATCUR                // Валюта дохода/расхода
                                          ,TXOBJ_KIND1020        // Вид аналитики 1
                                          ,FD.tick.rec.DealID    // Аналитика 1
                                          ,0                     // Вид аналитики 2
                                          ,-1                    // Аналитика 2
                                          ,TXOBJ_KIND3010        // Вид аналитики 3
                                          ,FD.tick.rec.PFI       // Аналитика 3
                                          ,TXOBJ_KIND4010        // Вид аналитики 4
                                          ,Circulate             // Аналитика 4
                                          ,TXOBJ_KIND5010        // Вид аналитики 5
                                          ,TaxGroupNPTX          // Аналитика 5
                                          ,IIF(ContractID > 0, TXOBJ_KIND6020, 0) // Вид аналитики 6
                                          ,ContractID            // Аналитика 6
                                          ,""                    // Комментарий
                                          ,ID_Operation          // ID операции
                                          ,ID_Step               // ID шага операции
                                          ,1 );                  // Признак вызова не из операции расчета НОБ
          end;
          
          if(not err)
            Kind = IIF(IsIIS == true, TXOBJ_BASEG5, TXOBJ_BASEG2);
            
            err = DL_NPTX_InsertTaxObject( dat                   // Дата НДР
                                          ,FactReceiverID        // Клиент
                                          ,TXOBJ_DIR_IN          // Направление
                                          ,7                     // Уровень
                                          ,""                    // Признак "Пользовательский"
                                          ,Kind                  // Вид НДР
                                          ,СуммаВыплатыРуб       // Сумма дохода/расхода
                                          ,NATCUR                // Валюта дохода/расхода
                                          ,TXOBJ_KIND1020        // Вид аналитики 1
                                          ,FD.tick.rec.DealID    // Аналитика 1
                                          ,0                     // Вид аналитики 2
                                          ,-1                    // Аналитика 2
                                          ,TXOBJ_KIND3010        // Вид аналитики 3
                                          ,FD.tick.rec.PFI       // Аналитика 3
                                          ,TXOBJ_KIND4010        // Вид аналитики 4
                                          ,Circulate             // Аналитика 4
                                          ,TXOBJ_KIND5010        // Вид аналитики 5
                                          ,TaxGroupNPTX          // Аналитика 5
                                          ,IIF(ContractID > 0, TXOBJ_KIND6020, 0) // Вид аналитики 6
                                          ,ContractID            // Аналитика 6
                                          ,""                    // Комментарий
                                          ,ID_Operation          // ID операции
                                          ,ID_Step               // ID шага операции
                                          ,1 );                  // Признак вызова не из операции расчета НОБ
          end;
          
          if((not err) and (СуммаНалога > 0))
            
            Kind = IIF(IsIIS == true, TXOBJ_PAIDGENERAL_IIS, TXOBJ_PAIDGENERAL);
            
            err = DL_NPTX_InsertTaxObjectTaxPay( dat                   // Дата НДР
                                          ,FactReceiverID        // Клиент
                                          ,TXOBJ_DIR_OUT         // Направление
                                          ,8                     // Уровень
                                          ,""                    // Признак "Пользовательский"
                                          ,Kind                  // Вид НДР
                                          ,СуммаНалога           // Сумма дохода/расхода
                                          ,NATCUR                // Валюта дохода/расхода
                                          ,TXOBJ_KIND1020        // Вид аналитики 1
                                          ,FD.tick.rec.DealID    // Аналитика 1
                                          ,0                     // Вид аналитики 2
                                          ,-1                    // Аналитика 2
                                          ,TXOBJ_KIND3010        // Вид аналитики 3
                                          ,FD.tick.rec.PFI       // Аналитика 3
                                          ,TXOBJ_KIND4010        // Вид аналитики 4
                                          ,Circulate             // Аналитика 4
                                          ,TXOBJ_KIND5010        // Вид аналитики 5
                                          ,TaxGroupNPTX          // Аналитика 5
                                          ,IIF(ContractID > 0, TXOBJ_KIND6020, 0) // Вид аналитики 6
                                          ,ContractID            // Аналитика 6
                                          ,""                    // Комментарий
                                          ,ID_Operation          // ID операции
                                          ,ID_Step               // ID шага операции
                                          ,1 );                  // Признак вызова не из операции расчета НОБ
          end;

          if((not err) and (СуммаНалога15 > 0))
            
            Kind = IIF(IsIIS == true, TXOBJ_PAIDGENERAL_15_IIS, TXOBJ_PAIDGENERAL_15);
            
            err = DL_NPTX_InsertTaxObjectTaxPay( dat                   // Дата НДР
                                                ,FactReceiverID        // Клиент
                                                ,TXOBJ_DIR_OUT         // Направление
                                                ,8                     // Уровень
                                                ,""                    // Признак "Пользовательский"
                                                ,Kind                  // Вид НДР
                                                ,СуммаНалога15         // Сумма дохода/расхода
                                                ,NATCUR                // Валюта дохода/расхода
                                                ,TXOBJ_KIND1020        // Вид аналитики 1
                                                ,FD.tick.rec.DealID    // Аналитика 1
                                                ,0                     // Вид аналитики 2
                                                ,-1                    // Аналитика 2
                                                ,TXOBJ_KIND3010        // Вид аналитики 3
                                                ,FD.tick.rec.PFI       // Аналитика 3
                                                ,TXOBJ_KIND4010        // Вид аналитики 4
                                                ,Circulate             // Аналитика 4
                                                ,TXOBJ_KIND5010        // Вид аналитики 5
                                                ,TaxGroupNPTX          // Аналитика 5
                                                ,IIF(ContractID > 0, TXOBJ_KIND6020, 0) // Вид аналитики 6
                                                ,ContractID            // Аналитика 6
                                                ,""                    // Комментарий
                                                ,ID_Operation          // ID операции
                                                ,ID_Step               // ID шага операции
                                                ,1                     // Признак вызова не из операции расчета НОБ
                                                );                     // Вид налоговой базы
          end;
        end;

      elif(party.rec.LegalForm == PTLEGF_INST)
        if((not err) AND (not ErrNum))
           err = DL_NUTX_InsertTaxObjectOnStep( dat                   // Дата НДР
                                                 ,OwnerID               // Клиент
                                                 ,FactReceiverID        // Фактический получатель дохода
                                                 ,NUTXOBJ_DIR_IN        // Направление
                                                 ,2                     // Уровень
                                                 ,""                    // Признак "Пользовательский"
                                                 ,NUTXOBJ_PLUS_11       // Вид НДР
                                                 ,СуммаВыплаты          // Сумма дохода/расхода
                                                 ,FD.dl_leg.rec.PayFIID // Валюта дохода/расхода
                                                 ,TXOBJ_KIND1020        // Вид аналитики 1
                                                 ,FD.tick.rec.DealID    // Аналитика 1
                                                 ,0                     // Вид аналитики 2
                                                 ,-1                    // Аналитика 2
                                                 ,TXOBJ_KIND3010        // Вид аналитики 3
                                                 ,FD.tick.rec.PFI       // Аналитика 3
                                                 ,TXOBJ_KIND4010        // Вид аналитики 4
                                                 ,Circulate             // Аналитика 4
                                                 ,TXOBJ_KIND5010        // Вид аналитики 5
                                                 ,TaxGroupNUTX          // Аналитика 5
                                                 ,TXOBJ_KIND6020        // Вид аналитики 6
                                                 ,ContractID            // Аналитика 6
                                                 ,"" )                  // Комментарий
                                                 ;
           if(err)
             if(err == LIC_MSG_DEMO_MODE_OFF)
               ErrNum = LIC_MSG_DEMO_MODE_OFF;
               err = 0;
             else
               err = 1;
             end;
           end;
        end;
        if( (not err) AND ( not ErrNum) )
          var sum = round(СуммаВыплатыРуб * DataSet.TaxRate / 100.0, 2);

          if(sum > 0)
            if(0 != DL_NUTX_InsertTaxObjectOnStep( dat                   // Дата НДР
                                                  ,OwnerID               // Клиент
                                                  ,FactReceiverID        // Фактический получатель дохода
                                                  ,NUTXOBJ_DIR_OUT       // Направление
                                                  ,5                     // Уровень
                                                  ,""                    // Признак "Пользовательский"
                                                  ,NUTXOBJ_DUETAX        // Вид НДР
                                                  ,sum                   // Сумма дохода/расхода
                                                  ,NATCUR                // Валюта дохода/расхода
                                                  ,TXOBJ_KIND1020        // Вид аналитики 1
                                                  ,FD.tick.rec.DealID    // Аналитика 1
                                                  ,0                     // Вид аналитики 2
                                                  ,-1                    // Аналитика 2
                                                  ,TXOBJ_KIND3010        // Вид аналитики 3
                                                  ,FD.tick.rec.PFI       // Аналитика 3
                                                  ,TXOBJ_KIND4010        // Вид аналитики 4
                                                  ,Circulate             // Аналитика 4
                                                  ,TXOBJ_KIND5010        // Вид аналитики 5
                                                  ,TaxGroupNUTX          // Аналитика 5
                                                  ,TXOBJ_KIND6020        // Вид аналитики 6
                                                  ,ContractID            // Аналитика 6
                                                  ,"" )                  // Комментарий
             )
               err = 1;
            end;
          end;
        end;

        if((not err) AND (not ErrNum))
          if(0 != DL_NUTX_InsertTaxObjectOnStep( dat                   // Дата НДР
                                                ,OwnerID               // Клиент
                                                ,FactReceiverID        // Фактический получатель дохода
                                                ,NUTXOBJ_DIR_OUT       // Направление
                                                ,8                     // Уровень
                                                ,""                    // Признак "Пользовательский"
                                                ,NUTXOBJ_PAIDTAX       // Вид НДР
                                                ,СуммаНалога           // Сумма дохода/расхода
                                                ,NATCUR                // Валюта дохода/расхода
                                                ,TXOBJ_KIND1020        // Вид аналитики 1
                                                ,FD.tick.rec.DealID    // Аналитика 1
                                                ,0                     // Вид аналитики 2
                                                ,-1                    // Аналитика 2
                                                ,TXOBJ_KIND3010        // Вид аналитики 3
                                                ,FD.tick.rec.PFI       // Аналитика 3
                                                ,TXOBJ_KIND4010        // Вид аналитики 4
                                                ,Circulate             // Аналитика 4
                                                ,TXOBJ_KIND5010        // Вид аналитики 5
                                                ,TaxGroupNUTX          // Аналитика 5
                                                ,TXOBJ_KIND6020        // Вид аналитики 6
                                                ,ContractID            // Аналитика 6
                                                ,"" )                  // Комментарий
           )
             err = 1;
          end;
        end;

      end;


    end;
  end;

  return err;
end;

macro ПолучитьОснованиеПроводкиПоКомиссииОЭБ_ПА(ID)
    macro set_template(s, t, v)
        var i = 1;
        while (i <= strlen(s))
            if (substr(s,i,strlen(t)) == t)
                return substr(s,1,i-1) + v + substr(s, i + strlen(t));
            end;
            i = i + 1;
        end;
        return s;
    end;

    var dlcomis = TRecHandler("DLCOMIS.dbt");
    var sfcomis = TRecHandler("SFCOMISS.dbt");

    var RS = TRsbDataSet("SELECT * FROM DDLCOMIS_DBT DLCOMIS " +
                         " WHERE T_ID = " + string(ID));
    if (RS.MoveNext())
        RS.GetRecord().CopyTo(dlcomis.rec);
    else
        return "";
    end;

    RS = TRsbDataSet("SELECT * FROM DSFCOMISS_DBT SFCM " +
                     " WHERE SFCM.T_FEETYPE = " + DLCOMIS.rec.FEETYPE +
                     " AND SFCM.T_NUMBER = " + DLCOMIS.rec.COMNUMBER);
    if (RS.MoveNext())
        RS.GetRecord().CopyTo(sfcomis.rec);
    else
        return "";
    end;

    var GroudStr = readNoteForObject(OBJTYPE_SFCOMISS, MakeObjectID(OBJTYPE_SFCOMISS, NULL, sfcomis), 1);

    if (GroudStr == "")
        if (sfcomis.rec.code == ПолучитьКодКомиссииОЭБ_ПГКУП())
            GroudStr = "Оплата комиссии за выплату дохода по купону № *№ купона* неконв. проц. докум. обл. *банк* (№ гос.рег.*выпуск*)";
        elif (sfcomis.rec.code == ПолучитьКодКомиссииОЭБ_ПГВЫП())
            GroudStr = "Оплата комиссии за выплату номинала неконв. проц. докум. обл. *банк* (№ гос.рег.*выпуск*)";
        end;
    end;

    var avr = "";
    var bank_name = "";
    var coupon = "";
    var exp_date = zerodate;

    RS = TRsbDataSet("select avr.T_LSIN av from DAVOIRISS_DBT avr, DDL_TICK_DBT tick where avr.T_FIID = tick.T_PFI and tick.T_BOFFICEKIND = " + DLCOMIS.rec.DOCKIND + " and tick.T_DEALID = " + DLCOMIS.rec.DOCID);
    if (RS.MoveNext())
        avr = rs.av;
    end;

    RS = TRsbDataSet("select pt.T_shortname name from DPARTY_DBT pt where pt.t_partyid = " + {OurBank});
    if (RS.MoveNext())
        bank_name = rs.name;
    end;

    RS = TRsbDataSet("select DDL_TICK_DBT.T_NUMBER_COUPON coupon from DDL_TICK_DBT where T_BOFFICEKIND = " + DLCOMIS.rec.DOCKIND + " AND T_DEALID = " + DLCOMIS.rec.DOCID);
    if (RS.MoveNext())
        coupon = rs.coupon;
    end;

    RS = TRsbDataSet("select leg.T_EXPIRY exp_date from DDL_LEG_DBT leg, DDL_TICK_DBT tick where tick.T_BOFFICEKIND = " + DLCOMIS.rec.DOCKIND + " and tick.T_DEALID = " + DLCOMIS.rec.DOCID + " AND  leg.T_DEALID = tick.T_DEALID and leg.T_LEGKIND = 0 and leg.T_LEGID = 0 ");
    if (RS.MoveNext())
        exp_date = rs.exp_date;
    end;

    GroudStr = set_template(GroudStr, "*выпуск*", avr);
    GroudStr = set_template(GroudStr, "*банк*", bank_name);
    GroudStr = set_template(GroudStr, "*№ купона*", coupon);
    GroudStr = set_template(GroudStr, "*дата погашения*", exp_date);
    
    return GroudStr;
end;