// ReSendMessage.mac
// отправка сообщений для клиентов 

import dbo_message_mass;

var sql_str, rs;
var cnt = 0;
var pf, v_error;

println(time());

sql_str = 
"select d.t_dlcontrid, m.t_sendmesstate, s.t_number, s.t_datebegin, s.t_name , t_senddate "+
"  from ddlcontrmsg_dbt m, ddlcontr_dbt d, dsfcontr_dbt s "+
" where m.t_dlcontrid = d.t_dlcontrid and s.t_id = d.t_sfcontrid "+
//онлайн регистрация клиента или площадки
"   and t_kind in (1,2) and t_isonlinesendmes = chr(88) "+
// нет онлайн закрытия
"   and not exists (select 1 from  ddlcontrmsg_dbt m2 where m2.t_dlcontrid = d.t_dlcontrid "+
"                      and m2.t_isonlinesendmes = chr(88) and m2.t_kind in (3,4)) "+
// нет отправки уведомления
"   and not exists (select 1 from  ddlcontrmsg_dbt m3 where m3.t_dlcontrid = d.t_dlcontrid and m3.t_kind = 500) "+
// ошибочные 
"   and t_sendmesstate in (102, 103) "+
// только статус = "Обработка завершена" 
"   and exists (select 1 from dobjatcor_dbt o where o.t_objecttype = 207 and o.t_groupid = 101 "+
"                  and o.t_attrid = 3 and (o.t_validtodate >= sysdate or o.t_validtodate = to_date('01.01.0001','dd.mm.yyyy')) "+
"                  and lpad(d.t_dlcontrid,34,'0') = o.t_object ) ";

InitProgress(-1);

  rs = RSDRecordSet(sql_str);
  while (rs.movenext)
SetDialogFlag(0);
      pf = dboMessage(rs.value("t_dlcontrid")).CreateMessage(true,true,true);
      if (pf.StatSend != 1)   // ошибка
         v_error = pf.NumberDBO+" "+pf.Prt_Fnam + pf.statMes;
         println(v_error);
      else
         v_error = "OK";
      end;
SetDialogFlag(1);

      cnt = cnt+1;
      pf = null;
      UseProgress(cnt);
  end;
  RemProgress();
println(time());

  if (cnt > 0)
     msgbox("Отправлено: "+cnt+" сообщений.");
  else 
     msgbox("Нет записей");
  end;


exit(0);


