import spserv, cb_sql;
import "usr_open_files.mac";

/*
drop table u_vtb_lots_dbt;
create table u_vtb_lots_dbt
( t_id number(10),
t_SecondName varchar2(100),
t_FirstName varchar2(100),
t_MiddleName varchar2(100),
t_Phone varchar2(50),
t_AgrNo varchar2(50),
t_ISIN varchar2(25),
t_Transh varchar2(50),
t_SecName varchar2(100),
t_OperNo varchar2(50),
t_DatePos DATE,
t_Qty number(32,12),
t_Curr varchar2(3),
t_Price number(32,12),
t_Amount number(32,12),
t_Aci number(32,12),
t_Cms number(32,12),
t_ValueRur number(32,12),
t_CmsRur number(32,12),
t_stor varchar2(20),
t_State varchar2(20),
T_Comment varchar2(200));
CREATE UNIQUE INDEX U_VTB_LOTS_DBT_IDX0 ON U_VTB_LOTS_DBT (T_ID);
CREATE UNIQUE INDEX U_VTB_LOTS_DBT_IDX1 ON U_VTB_LOTS_DBT (T_OperNo);
CREATE SEQUENCE u_vtb_lots_dbt_SEQ   START WITH 1
  MAXVALUE 9999999999999999999999999999
  MINVALUE 1   NOCYCLE   NOCACHE   NOORDER;
CREATE OR REPLACE TRIGGER "u_vtb_lots_dbt_AINC" 
 BEFORE INSERT OR UPDATE OF t_id ON u_vtb_lots_dbt  FOR EACH ROW
DECLARE
 v_id INTEGER;
BEGIN
 IF (:new.t_id = 0 OR :new.t_id IS NULL) THEN
   SELECT u_vtb_lots_dbt_seq.nextval INTO :new.t_id FROM dual;
 ELSE
   select last_number into v_id from user_sequences where sequence_name = upper ('u_vtb_lots_dbt_SEQ');
   IF :new.t_id >= v_id THEN
     RAISE DUP_VAL_ON_INDEX;
   END IF;
 END IF;
END;
/


*/



private macro CheckCreateTable()

   var sql = "declare " +
        " retval number := 0; " +
        " sql_crt varchar2(4000); " +
        "begin " +
        "sql_crt := ' create table u_vtb_lots_dbt '|| " +
        "           '( t_id number(10),           '|| " +
        "           't_SecondName varchar2(100),  '|| " +
        "           't_FirstName varchar2(100),   '|| " +
        "           't_MiddleName varchar2(100),  '|| " +
        "           't_Phone varchar2(50),        '|| " +
        "           't_AgrNo varchar2(50),        '|| " +
        "           't_ISIN varchar2(25),         '|| " +
        "           't_Transh varchar2(50),       '|| " +
        "           't_SecName varchar2(100),     '|| " +
        "           't_OperNo varchar2(50),       '|| " +
        "           't_DatePos DATE,              '|| " +
        "           't_Qty number(32,12),         '|| " +
        "           't_Curr varchar2(3),          '|| " +
        "           't_Price number(32,12),       '|| " +
        "           't_Amount number(32,12),      '|| " +
        "           't_Aci number(32,12),         '|| " +
        "           't_Cms number(32,12),         '|| " +
        "           't_ValueRur number(32,12),    '|| " +
        "           't_CmsRur number(32,12),      '|| " +
        "           't_stor varchar2(20),         '|| " +
        "           't_State varchar2(20),        '|| " +
        "           'T_Comment varchar2(200));    '|| " +
        "           'CREATE UNIQUE INDEX U_VTB_LOTS_DBT_IDX0 ON U_VTB_LOTS_DBT (T_ID);    '|| " +
        "           'CREATE UNIQUE INDEX U_VTB_LOTS_DBT_IDX1 ON U_VTB_LOTS_DBT (T_OperNo);'|| " +
        "           'CREATE SEQUENCE u_vtb_lots_dbt_SEQ   START WITH 1                    '|| " +
        "           '  MAXVALUE 9999999999999999999999999999                              '|| " +
        "           '  MINVALUE 1   NOCYCLE   NOCACHE   NOORDER;                          '|| " +
        "           'CREATE OR REPLACE TRIGGER u_vtb_lots_dbt_AINC                        '|| " +
        "           ' BEFORE INSERT OR UPDATE OF t_id ON u_vtb_lots_dbt  FOR EACH ROW     '|| " +
        "           'DECLARE                                                              '|| " +
        "           ' v_id INTEGER;                                                       '|| " +
        "           'BEGIN                                                                '|| " +
        "           ' IF (:new.t_id = 0 OR :new.t_id IS NULL) THEN                        '|| " +
        "           '   SELECT u_vtb_lots_dbt_seq.nextval INTO :new.t_id FROM dual;       '|| " +
        "           ' ELSE                                                                '|| " +
        "           '   select last_number into v_id from user_sequences where sequence_name = upper (''u_vtb_lots_dbt_SEQ'');'|| " +
        "           '   IF :new.t_id >= v_id THEN                                                                           '|| " +
        "           '     RAISE DUP_VAL_ON_INDEX;                                                                           '|| " +
        "           '   END IF;                                                                                             '|| " +
        "           ' END IF;                                                                                               '|| " +
        "           'END;                                                                                                   '; " +
        " " +
        "select count(1) into retval from user_tables where upper (table_name) = 'U_VTB_LOTS_DBT'; " +
        "if retval = 0 then " +
        "  execute immediate (sql_crt); " +
        "end if;  " +
        "end; " ;
   var cmd = RSDCommand(sql);
   cmd.execute;
end;


private macro InsRec(    InputFile0,
                         InputFile1,
                         InputFile2,
                         InputFile3,
                         InputFile4,
                         InputFile5,
                         InputFile6,
                         InputFile7,
                         InputFile8,
                         InputFile9,
                         InputFile10,
                         InputFile11,
                         InputFile12,
                         InputFile13,
                         InputFile14,
                         InputFile15,
                         InputFile16,
                         InputFile17,
                         InputFile18
                         )

   var sql_str, cmd, rs;
   var res = "OK";
   
   sql_str = "declare "+
             "    v_Err varchar2(2000);"+
             " begin "+
             "    begin "+
             "      insert into u_vtb_lots_dbt values (0, :0, :1, :2, :3, :4, :5, :6, :7, :8, to_date('"+InputFile9+"', 'dd.mm.yyyy hh24:mi:ss'),TO_NUMBER(:10), :11, TO_NUMBER(:12), TO_NUMBER(:13), TO_NUMBER(:14), TO_NUMBER(:15),TO_NUMBER(:16), TO_NUMBER(:17), :18, chr(1), chr(1));"
             "       v_Err := 'OK'; "+
             "    exception "+
             "       when DUP_VAL_ON_INDEX then v_Err := 'Дублирование номера операции'; "+
             "       when OTHERS then v_Err := 'Ошибка вставки: '|| SQLERRM; "+
             "    end; "+
             "    :p_Err := v_Err; "+
             "end; ";
             
   cmd = RSDCommand(sql_str);
   cmd.AddParam("0", RSDBP_IN,InputFile0); 
   cmd.AddParam("1", RSDBP_IN,InputFile1); 
   cmd.AddParam("2", RSDBP_IN,InputFile2); 
   cmd.AddParam("3", RSDBP_IN,InputFile3); 
   cmd.AddParam("4", RSDBP_IN,InputFile4);   
   cmd.AddParam("5", RSDBP_IN,InputFile5); 
   cmd.AddParam("6", RSDBP_IN,InputFile6); 
   cmd.AddParam("7", RSDBP_IN,InputFile7);
   cmd.AddParam("8", RSDBP_IN,InputFile8);
   //cmd.AddParam ("9", RSDBP_IN,InputFile(9)),
   cmd.AddParam("10", RSDBP_IN,InputFile10);
   cmd.AddParam("11", RSDBP_IN,InputFile11);
   cmd.AddParam("12", RSDBP_IN,InputFile12);
   cmd.AddParam("13", RSDBP_IN,InputFile13);
   cmd.AddParam("14", RSDBP_IN,InputFile14);
   cmd.AddParam("15", RSDBP_IN,InputFile15);
   cmd.AddParam("16", RSDBP_IN,InputFile16);
   cmd.AddParam("17", RSDBP_IN,InputFile17);
   cmd.AddParam("18", RSDBP_IN,InputFile18);
   cmd.AddParam("p_Err", RSDBP_OUT, v_string, 2000);
   cmd.execute;
   if ((cmd.Value("p_Err") != null) and (cmd.Value("p_Err") != nullval))
      res = cmd.Value("p_Err");
   end;

   return res;
onError(e)
   return e.message;
end;


macro VTB_LoadLots(err:@string, result_protocol:@variant)

   var FullNameFile;
   file InputFile() txt;
   var c_file = c_txt_file();
   var cur_file_mask = "*.csv";
   var count = 0, errcount = 0, i = 0;
//   var log = Logger();
//   var dt = StrSubSt(string(Date()),".","")+StrSubSt(string(Time()),":","");
//   var InfoLogFileName = GetTxtFileName( "load_lots_"+dt);

  /* if(not SelectFile(FullNameFile, "..\\Import\\*.csv", "Выберите файл для загрузки", 0, true))
      err = "Отказ от загрузки";
      return false;
   end;*/

   var stat = c_file.openFile(InputFile, cur_file_mask, true, false, FullNameFile, "rsansi");

   if ( (valtype(stat) == V_UNDEF) or (stat == false) )
      err = "Ошибка открытия файла ";
      result_protocol.addString(err );
      return false;
   end;


   SetDelim("|");

   if ( not (open (InputFile, FullNameFile) ))
       err = "Не удалось открыть файл данных " + FullNameFile;
       result_protocol.addString(err );
       return false;
   end;

   CheckCreateTable();

   next(InputFile);
   initprogress(-1, "Загрузка файла");
   while (next(InputFile))
      if (InsRec (
        InputFile(0), 
        InputFile(1), 
        InputFile(2), 
        InputFile(3), 
        InputFile(4),   
        InputFile(5), 
        InputFile(6), 
        InputFile(7),
        InputFile(8),
        InputFile(9),
        InputFile(10),
        InputFile(11),
        InputFile(12),
        InputFile(13),
        InputFile(14),
        InputFile(15),
        InputFile(16),
        InputFile(17),
        InputFile(18)
          ) == "OK" )
         count = count + 1;
      else
         errcount = errcount + 1;
      end;
      UseProgress(i=i+1);
   end;
   RemProgress;
   result_protocol.addString("Не загружено " + errcount + " записей " );
   result_protocol.addString("Загружено " + count + " новых записей " );
   msgbox("Загрузка выполнена|Не загружено " + errcount + " записей|Загружено " + count + " новых записей ");
   return true;
end;

