import oralib, likepy, ptinter, globals, fiinter, rcw, oprinter;
import RsbFormsInter, "scincfun.mac";

var PathIn   ="\\\\sgo-fc01-r03.go.rshbank.ru\\sofr_for_etl\\inbox\\acctrnupd\\"     ,
    PathArh  ="\\\\sgo-fc01-r03.go.rshbank.ru\\sofr_for_etl\\inbox\\acctrnupd\\Arh\\";


Private macro OpenExcel
    return CreateObject ("rsax", "TRsAxServer", "RsBankAxServer", isStandAlone ()).CreateComObject ("Excel.Application");
OnError
    return NULL;
End;

Private macro OpenExcelFile ( fName )
    Var ex = OpenExcel ();
    if ( ex == NULL )
        MsgBox ("Ошибка открытия MS-Excel");
        return NULL;
    end;
    ex.Workbooks.Open (fName);
    return ex;
OnError
    ex = NULL;
    MsgBox ("Ошибка открытия файла ", fName);
    return NULL;
End;

Private Macro NotNull ( val )
    if ( val == NULL ) return false; end;
    if ( ValType (val) == 26 ) return false; end;
    return true;
End;


Private macro CnvInt (text)
    var ret = string (text), ind = index (ret,".");
    if (ind == 0)
       return ret;
    else
       return substr (ret, 1, ind-1);
    end;
End;

macro AcctrnUPD(AcctrnId, BisId);
   var sql, cmd, sql2, sql3, sql4, sql5;
   cmd = null;
   sql = ExecSqlSelect("select * from dacctrn_dbt where t_acctrnid = :1", MakeArray(SqlParam("1", AcctrnId)), false);
   sql.movenext();
   //проверяем что есть проводка с таким ид
   if (valtype(sql.value(0))==26)
   return 1;
   //проверяем что юф4 на проводке пустое
   elif((sql.value(54)!="") and (valtype(sql.value(54))!= 26))
      return 2;
   else
      var tmp = substr(BisId, 1, 1);
      if ((tmp == "1") or (tmp == "2") or (tmp == "3") or (tmp == "4") or (tmp == "5") or (tmp == "6") or (tmp == "7") or (tmp == "8") or (tmp == "9"))
         cmd =rsdcommand( "update dacctrn_dbt set t_userfield4 = :1 where t_acctrnid = :2");
         cmd.AddParam (":1", RSDBP_IN, BisId);            
         cmd.AddParam (":6", RSDBP_IN, AcctrnId);            
         cmd.execute;
      
         cmd = null;
         return 0;
      else 
         return 3;
      end;
   end;
   
end;

Private macro LoadBIS  (ex, EndLine)

   Var str = "", error = FALSE, sql, cnt = 0;
   Var Line = 1, Col = 1, EndCol = 0;
   while( trim (string(ex.Cells (Line, Col ).Value)) != "1.")    
     line = line+1;
   end;
   Var N1 = ""; 
   Var N2 = ""; 
   Var N3 = ""; 
   Var N4 = ""; 
   Var N5 = ""; 
   Var N6 = ""; 
   Var N7 = ""; 
   Var N8 = ""; 
   Var N9 = ""; 
   Var N10= ""; 
   Var N11= ""; 
   Var N12= ""; 
   Var N13= ""; 
   Var N14= ""; 
   Var N15= ""; 
   Var N16= ""; 
   Var N17= ""; 
   Var N18= ""; 
   Var N19= ""; 
   Var N20= ""; 
   Var N21= ""; 
   Var N22= ""; 
   Var N23= ""; 
   Var N24= ""; 
   Var N25= ""; 
   var Rep;
   var sheet = 1;
   var errorcode;

   Rep = CMakeReport("┌┬┬┬┬┬┬┬┬┬┬┬┬┐");

   Rep.SetDefaultFontName("Times New Roman");
   Rep.SetDefaultFontSize(14);
   Rep.SetFlagShowGrid(true);

   Rep.AddPrintCell("DOCKKIND",            9.7,  null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("DEALID",              7.7,  null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("DEAL_CODE",           11.7, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("KIND_OPERATION",      15.9, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("OPERATIONID",         12.7, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("STEPNAME",            37.7, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("ACCTRNID",            9.7,  null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("RESULTBISQUITID",     17.0, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("TRN_DATE",            25.4, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("TRN_PACK",            9.7,  null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("TRN_DOPINFO",         12.7, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("TRN_PAYERACCOUNT",    22.0, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("TRN_RECEIVERACCOUNT", 22.0, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("TRN_DESCRIPTION",     17.0, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("TRN_CURRENCY_CODE",   19.0, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("TRN_AMOUNT",          11.7, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("TRN_U4",              12.7, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("DEALPAYMENT_ID",      15.9, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("DEALPAYMENT_AMOUNT",  19.4, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("DEALPAYMENT_U4",      15.9, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("PAYMENT_ID",          11.7, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("PAYMENT_DOCKIND",     17.0, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("PAYMENT_AMOUNT",      15.9, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("PAYMENT_U4",          12.7, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("ID",                  12.7, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("RESULTCODE",          16.2, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("RESULTTEXT",          30.0, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddStr();                                       

   Rep.AddPrintCell("1.",  9.7,  null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("2.",  7.7,  null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("3.",  11.7, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("4.",  15.9, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("5.",  12.7, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("6.",  37.7, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("7.",  9.7,  null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("8.",  17.0, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("9.",  25.4, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("10.", 9.7,  null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("11.", 12.7, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("12.", 22.0, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("13.", 22.0, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("14.", 17.0, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("15.", 19.0, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("16.", 11.7, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("17.", 12.7, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("18.", 15.9, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("19.", 19.4, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("20.", 15.9, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("21.", 11.7, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("22.", 17.0, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("23.", 15.9, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("24.", 12.7, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("25.", 12.7, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("26.", 16.2, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddPrintCell("27.", 30.0, null, "ex_FS(b):ex_B(tblr):ex_BC(12632256)");
   Rep.AddStr();

   line = line+1;

   EndLine = EndLine + 1;
   InitProgress (EndLine - Line, NULL, "Чтение файла");
   while ( Line<=EndLine )
      UseProgress (cnt = cnt+1);
      if ( NotNull (ex.Cells (Line, Col+1).Value) )
         N1 = CnvInt (ex.Cells (Line, Col).Value);          
         N2 = CnvInt (ex.Cells (Line, Col+1).Value);          
         N3 = trim (string(ex.Cells (Line, Col+2 ).Value)); 
         N4 = CnvInt (ex.Cells (Line, Col+3).Value);          
         N5 = CnvInt (ex.Cells (Line, Col+4).Value);          
         N6 = trim (string(ex.Cells (Line, Col+5 ).Value)); 
         N7 = CnvInt (ex.Cells (Line, Col+6).Value);          
         N8 = trim (string(ex.Cells (Line, Col+7 ).Value));
         N9 = string (substr(ex.Cells (Line, Col+8 ).Value,1, 10)); 
         N10= CnvInt (ex.Cells (Line, Col+9).Value);          
         N11= trim (string(ex.Cells (Line, Col+10).Value)); 
         N12= trim (string(ex.Cells (Line, Col+11).Value)); 
         N13= trim (string(ex.Cells (Line, Col+12).Value)); 
         N14= trim (string(ex.Cells (Line, Col+13).Value)); 
         N15= CnvInt (ex.Cells (Line, Col+14).Value);          
         N16= CnvInt (ex.Cells (Line, Col+15).Value);          
         N17= CnvInt (ex.Cells (Line, Col+16).Value);          
         N18= trim (string(ex.Cells (Line, Col+17).Value)); 
         N19= trim (string(ex.Cells (Line, Col+18).Value)); 
         N20= trim (string(ex.Cells (Line, Col+19).Value)); 
         N21= trim (string(ex.Cells (Line, Col+20).Value)); 
         N22= trim (string(ex.Cells (Line, Col+21).Value));         
         N23= trim (string(ex.Cells (Line, Col+22).Value)); 
         N24= trim (string(ex.Cells (Line, Col+23).Value)); 
         N25= trim (string(ex.Cells (Line, Col+24).Value)); 

         errorcode = AcctrnUPD(N7, N25);

         Rep.AddPrintCell(N1 ,  9.7,  null, "r");
         Rep.AddPrintCell(N2 ,  7.7,  null, "r");
         Rep.AddPrintCell(N3 ,  11.7, null, "r");
         Rep.AddPrintCell(N4 ,  15.9, null, "r");
         Rep.AddPrintCell(N5 ,  12.7, null, "r");
         Rep.AddPrintCell(N6 ,  37.7, null, "r");
         Rep.AddPrintCell(N7 ,  9.7,  null, "r");
         Rep.AddPrintCell(N8 ,  17.0, null, "r");
         Rep.AddPrintCell(N9 ,  25.4, null, "r");
         Rep.AddPrintCell(N10, 9.7,  null, "r");
         Rep.AddPrintCell(N11, 12.7, null, "r");
         Rep.AddPrintCell(N12, 22.0, null, "r");
         Rep.AddPrintCell(N13, 22.0, null, "r");
         Rep.AddPrintCell(N14, 17.0, null, "r");
         Rep.AddPrintCell(N15, 19.0, null, "r");
         Rep.AddPrintCell(N16, 11.7, null, "r");
         Rep.AddPrintCell(N17, 12.7, null, "r");
         Rep.AddPrintCell(N18, 15.9, null, "r");
         Rep.AddPrintCell(N19, 19.4, null, "r");
         Rep.AddPrintCell(N20, 15.9, null, "r");
         Rep.AddPrintCell(N21, 11.7, null, "r");
         Rep.AddPrintCell(N22, 17.0, null, "r");
         Rep.AddPrintCell(N23, 15.9, null, "r");
         Rep.AddPrintCell(N24, 12.7, null, "r");
         Rep.AddPrintCell(N25, 12.7, null, "r");
         Rep.AddPrintCell(errorcode, 16.2, null, "r");

         if (errorcode == 0)
            Rep.AddPrintCell("Успешно", 30.0, null, "r");
         elif (errorcode ==1)
            Rep.AddPrintCell("Не найдена проводка с указанным ИД", 30.0, null, "r");
         elif (errorcode ==2)
            Rep.AddPrintCell("Поле для добавления не пустое", 30.0, null, "r");
         elif (errorcode ==3)
            Rep.AddPrintCell("Некорректное значение для вставки", 30.0, null, "r");
         end;

         Rep.AddStr();

        line = line+1;
      else
         RemProgress ();

         ex.Quit ();
         ex = NULL;
      end;
   end;
Rep.PrintWinRep("Отчет");
Rep.SetZoomType(ZOOM_TYPE_A4L);
Rep.SetWinRepOutput();
Rep.ShowWinRep();

End;


Private macro LoadData

    Var fName, ex, cnt = 0;

    if ( not SelectFile (fName, (PathIn+"*.*"), NULL, NULL, TRUE) )
        return FALSE;
    elif ( (ex = OpenExcelFile (fName)) == NULL )
        return FALSE;
    end;

    Var Line = ex.ActiveSheet.UsedRange.Row,
        EndLine = ex.ActiveSheet.UsedRange.Rows.Count,
        Col = ex.ActiveSheet.UsedRange.Column,
        EndCol = 0;
        line = line+2;
    while ( NotNull (ex.Cells (Line, Col+EndCol).Value) )
       Var Dprt = String (ex.Cells (Line, Col+EndCol).Value);
       EndCol = EndCol + 1;
    end;

    Var ColumnCount = 25;  
    if   ( EndCol == ColumnCount ) 
       if (msgboxex ("Загрузка ИД БИСКВИТ ?", MB_YES+MB_NO, IND_YES)==IND_YES)
           LoadBIS ( ex, EndLine );
       else
           msgboxex ("Отказ от загрузки");
           ex.Quit ();
           ex = NULL;
           return FALSE;
       end;
    else
       MsgBox ("Нарушена структура файла.|Заголовок таблицы не содержит необходимое количество колонок "+EndCol);
       ex.Quit ();
       ex = NULL;
       return FALSE;
    end

End;

LoadData;
exit(0);