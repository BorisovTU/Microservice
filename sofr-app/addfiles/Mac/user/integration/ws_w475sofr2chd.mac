/**                                                                                                             
 @file ws_w475sofr2chd.mac                                                                                          
 @brief Сервис обработчика потоков. Запуск по Sheduler.
                                                                                                                                                                                                                                                                                                                            
 # changeLog                                                                                                    
 |date       |author         |tasks               |note                                                         
 |-----------|---------------|--------------------|-------------------------------------------------------------
 |2024.04.04 |Шестаков Д.В.  |BIQ-15436           |Создание макроса для планировщика                                                                                                                                                                                                                                                                                          
*/ 

import w475sofr2chd;
import DatesUtility,Календарь;

CONST ACCOUNTING_CALENDAR = 10003;

/**
   @brief Проверка на третий рабочий день в месяце, если удовлетворяет условию, то запуск выгрузки рузультатов БО в таблицу dkl11sofr2dwh_dbt 
  */ 
Macro ws_check_third_workday()
    var DATENUMBER:integer,
        StrErr:string,
        dayUnload:date,
        firstDtMonth:date;

    GetRegistryValue("РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ДАТА АВТ. ВЫГРУЗКИ", V_INTEGER, DATENUMBER, StrErr);

    var m_datesUtility = TDatesUtility;
        firstDtMonth =  m_datesUtility.getFirstDayInMonth(Date());

    if(IsWorkday(firstDtMonth,ACCOUNTING_CALENDAR)==0)
        firstDtMonth = GetDateAfterWorkDays(firstDtMonth, 1, ACCOUNTING_CALENDAR);
    end;

    dayUnload = GetDateAfterWorkDays(firstDtMonth, DATENUMBER-1, ACCOUNTING_CALENDAR);

    if(Date() == dayUnload )
        MainCalc_Run();
    end;   
end;
