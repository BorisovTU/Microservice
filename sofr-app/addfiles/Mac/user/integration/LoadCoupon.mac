import "LoadRudata.mac", cb_sql, FIInter;
//var AVOIRKIND_BOND = 17; 

var Fin;
var LoadDate = "290119";
var sql_upd = "", SQL, Param;


var Fin1;
var FI1 = TRecHandler( "fininstr" );
var AV1 = TRecHandler( "avoiriss" );
var WR1 = TRecHandler( "fiwarnts" );


  //fin = получитьфинин(_FIID, FI, AV,null, WR);


// Сохраняем текущие купончики
//SQL_Execute(" create table dfiwarnts_dbt_bkup290119 as select * from dfiwarnts_dbt ", null, false );

 
//очищаем текущие купончики
/* SQL =   "DELETE  FROM dfiwarnts_dbt T "
      + " WHERE     t_ispartial = CHR (0) "
      + "       AND t.T_DRAWINGDATE > :date1 "
      + "       AND t.T_FIRSTDATE > :date2 "
      + "       AND (SELECT RSB_FIINSTR. "
      + "                    FI_AVRKINDSGETROOT (f.t_fi_kind, f.t_avoirkind) "
      + "              FROM dfininstr_dbt f "
      + "             WHERE f.t_fiid = t.t_fiid) = 17 ";
 Param = Null;
    Param = makeArray( SQLParam("date1", {CurDate}),
                      SQLParam("date2", {CurDate}));
                      
  execSQL ( SQL, Param );

  SQL = "";Param = Null;
*/

/* SQL = "SELECT fin.t_fiid,fin.t_definition,(SELECT c.t_code "
      + "    FROM dobjcode_dbt c "
      + "    WHERE     c.t_objecttype = 9 AND c.t_codekind = 104 AND c.t_objectid = FIN.T_FIID AND c.t_state = 0 and c.t_code != chr(1))  RDCode "
      + "     FROM dfininstr_dbt fin "
      + "       WHERE       RSI_RSB_FIInstr.FI_AvrKindsGetRoot( fin.t_fi_kind, fin.t_AvoirKind ) =  17"; */


// собираем в кулачек бумажки
SQL =  "SELECT fin.t_fiid,fin.t_definition, SIF.FINTOOLID RDCode, FIN.T_DRAWINGDATE , SIF.ENDMTYDATE "
      + "     FROM dfininstr_dbt fin,  SOFR_INFO_FINTOOLREFERENCEDATA sif  "
      + "       WHERE       RSI_RSB_FIInstr.FI_AvrKindsGetRoot( fin.t_fi_kind, fin.t_AvoirKind ) =  17 and SIF.FINTOOLID = (SELECT c.t_code  "
      + "    FROM dobjcode_dbt c  "
      + "    WHERE     c.t_objecttype = 9 AND c.t_codekind = 104 AND c.t_objectid = FIN.T_FIID AND c.t_state = 0 and c.t_code != chr(1))   "
      + "   and fin.t_isclosed != chr(88) "
      + "    and SIF.ENDMTYDATE > to_date('29012019','ddmmyyyy')";

Param = TArray(); //makeArray( SQLParam("AVOIRKIND", AVOIRKIND_BOND) );

var dset = execSQLselect( sql, Param );

var oldFile = SetOutput("..\\LOGS\\LoadCupon.out", True);
var i = 0;


// 
InitProgress(SQL_GetNRecs(sql),"Вжух", "Вжух");
 while ( DSet.MoveNext )
   if (ValType(DSet.Value("RDCode")) != 26)
//     println("Обработка ценной бумаги FIID:" + dset.value("t_fiid") );


 //update если бумажка внезапно гасится раньше чем мы ожидаем 
/*if(  DSet.Value("T_DRAWINGDATE") != DSet.Value("ENDMTYDATE" ))
msgbox("Обновление даты купона");
    sql_upd = " update table dfininstr_dbt fin set fin.t_drawingdate = :drDate where fin.t_fiid = :pFiid";
 var   Params = makeArray( SQLParam("drDate", dset.value("ENDMTYDATE")),
                        SQLParam("pFiid" , dSet.Value("t_fiid")));
     execSQL( sql_upd, Params );          
     println("Обновлена дата гашения у бумаги: " + dSet.Value("t_fiid") +"   "  + DSet.Value("T_DRAWINGDATE") + " >>> " + DSet.Value("ENDMTYDATE" ));
end;*/


/*
проверка действующего купона на корректность
*/
fin1 = получитьфинин(dset.value("t_fiid"), FI1, AV1);
println("#Обработка цб DEF:" + FI1.rec.definition + "  ISIN:" + AV1.rec.isin + "  Г.РЕГ:" + AV1.rec.lsin + "     FI_ID:" + FI1.rec.fiid + "     FI_CODE:" + FI1.rec.fi_code );
     LoadCoupon( dset.value("t_fiid"), dset.value("RDCode"), 1 );
   end;
   UseProgress(i=i+1);
 end;
remprogress;

SetOutput(Null,Null);
SetOutput(oldFile);
