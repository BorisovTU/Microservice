import RSD;

macro uSVtoNull (val)
   if (valtype(val) == 26)
      return 0;
    else
      return val;
   end;
end;

Macro Getvalute(ContrId)
var rez = "";
var cmd = "SELECT fi.t_ccy "+
    " FROM dsfssi_dbt ssi "+
    " left join dfininstr_dbt fi on SSI.T_FIID = fi.t_fiid "+
    " WHERE ssi.t_objecttype = 659 AND ssi.t_objectid = lpad(:cntr_id,10,'0')";
cmd = RSDCommand(cmd);
cmd.AddParam("cntr_id", RSDBP_IN, ContrId);
var rs =  RsdRecordset(cmd);
	rs.movenext;
	if (valtype(rs.value(0))!= 26)
		rez = rez + rs.value(0);
		while (rs.moveNext)
		rez = rez +", " +rs.value(0);
		end;
	end;
return rez;
end;

macro TableInsert(ContractID:TArray)
var param = "";
var rezval = "";
var n = 1;
var cmdIns;

param = param + ContractID[0];

while (n<= ContractID.Size-1)
param = param + ", "+ contractId[n];
n = n+1;
end;

var cmd = "SELECT dl.t_dlcontrid, "+
"          contr.t_number, "+
"          to_char(contr.t_datebegin, 'dd.mm.yyyy'), "+
"          decode (subcontr.t_servkindsub , 8 , 1, 9 , 2) as typetp, "+
"          decode (party.t_legalform, 1,2,2,1) as legalform, "+
"          objcode.t_code, "+
"          dep.t_name, "+
"          ddlcontr.t_mpcode, "+
"          subcontr.t_id "+
"    FROM ddlcontr_dbt dl  "+
"    left join ddlcontrmp_dbt ddlcontr on dl.t_dlcontrid = DDLCONTR.T_DLCONTRID "+
"     left join dsfcontr_dbt contr on DL.T_SFCONTRID = contr.t_id  "+
"     left join  dsfcontr_dbt subcontr on DDLCONTR.T_SFCONTRID = subcontr.t_id and subcontr.t_servkind = 1 "+
"     LEFT JOIN dparty_dbt party ON contr.t_partyid = party.t_partyid "+
"     left join dobjcode_dbt objcode on objcode.T_objecttype = 3 and objcode.t_codekind = 1 and OBJCODE.T_OBJECTID = contr.t_partyid "+
"     left join ddp_dep_dbt dep on contr.t_department = dep.t_code "+
"     where subcontr.t_servkindsub is not null and  dl.t_dlcontrid IN ( "+param + " ) ";
cmd = RSDCommand(cmd);
var rs =  RsdRecordset(cmd);
	while (rs.moveNext)
		rezval = Getvalute(rs.value(8));
		cmdIns = "INSERT INTO SOFR_CONTRACTBOOUT (CONTRACTID, "+
"                                CONTRACTNUMBER, "+
"                                CONTRACTDATE, "+
"                                TYPETP, "+
"                                funds, "+
"                                CLIENTTYPE, "+
"                                CLIENTID, "+
"                                BRANCHID, "+
"                                codecli, t_timestamp) "+
"                              values(:0, :1,to_date(:2, 'dd.mm.yyyy'), :3,:Funds, :4, :5, :6, :7, systimestamp) ";
		cmdIns = RSDCommand(cmdIns);
		cmdIns.AddParam("0", RSDBP_IN, uSVtoNull(rs.value(0)));
		cmdIns.AddParam("1", RSDBP_IN, uSVtoNull(rs.value(1)));
		cmdIns.AddParam("2", RSDBP_IN, uSVtoNull(rs.value(2)));
		cmdIns.AddParam("3", RSDBP_IN, uSVtoNull(rs.value(3)));
		cmdIns.AddParam("Funds", RSDBP_IN, rezval);
		cmdIns.AddParam("4", RSDBP_IN, uSVtoNull(rs.value(4)));

		cmdIns.AddParam("5", RSDBP_IN,uSVtoNull( rs.value(5)));
		cmdIns.AddParam("6", RSDBP_IN, uSVtoNull(rs.value(6)));
		cmdIns.AddParam("7", RSDBP_IN, uSVtoNull(rs.value(7)));
             	cmdIns.execute;
		rezval = null;
		cmdins = null;
	end;
end;

var ContractNumber;
getString(ContraCTNUMBER);
var cmdDel = "truncate table SOFR_CONTRACTBOOUT";
cmddel = rsdCommand(cmddel);
cmddel.execute;
var cmd = " SELECT dl.t_dlcontrid "+
"     FROM ddlcontr_dbt dl "+
"     left join dsfcontr_dbt contr on DL.T_SFCONTRID = contr.t_id "+
"     where CONTR.T_number = :Contractnumber ";
cmd  = RSDCommand(cmd);
cmd.AddParam("Contractnumber", RSDBP_IN, ContraCTNUMBER);
var myArray = tArray;
var n= 0;
var rs = RsdRecordset(cmd);
rs.movenext;
if (valtype(rs.value(0)) == 26)
msgbox("Не найден договор с номером " + Contractnumber);
else
myArray(n) = rs.value(0);
Tableinsert(myArray);
end;


