/*-----------------------------------------------------*/
/* Передача из СОФР информации по Статусам Сделок      */
/*                                                     */
/* Автор: Гераськина Т.                                */
/*
   toDo  - отбор сделок для выгрузки статуса

*/
/*----------------------------------------------*/
import "ws_msg_transform_sec.mac"; /* Инструментарий для преобразования сообщений */
import spserv, sp_class;
//import "usr_table_int.mac"; /* Инструментарий для работы с пользовательскими таблицами */
import "email_notifyfun.mac";
import "secur_prc_msg_transform.mac";

/* Пользовательская настойка реестра - путь определяется на момент подготовки адаптера */
/*private const URL_LOC_REG_PATH = "http://10.18.121.18:1414/ModullarWebService";
private const HOST_LOC_REG_PATH = "10.18.121.18:1414";
private const SOAPACTION_LOC_REG_PATH = "\"http://systematica.ru/ModullarWebService/IModullarWebService/Run\"";
*/

/* Константы, определяемые на этапе тестирования - когда есть доступ к внешним сервисам */
private const REQ_ROOT_NS_ALIAS = "";
private const REQ_NS_LIST       = "";

/* Пользовательская настойка реестра  */
private const RUN_USERNAME =     "РСХБ\\ИНТЕГРАЦИЯ\\INTEGR_SERV_PRM\\EXT_SERVICES\\UPDATESTATUSDEAL\\USERNAME";
private const RUN_USERPASSWORD = "РСХБ\\ИНТЕГРАЦИЯ\\INTEGR_SERV_PRM\\EXT_SERVICES\\UPDATESTATUSDEAL\\USERPASSWORD";
private const RUN_RULENAME =     "РСХБ\\ИНТЕГРАЦИЯ\\INTEGR_SERV_PRM\\EXT_SERVICES\\UPDATESTATUSDEAL\\RULENAME";

private const URL_LOC_REG_PATH =        "РСХБ\\ИНТЕГРАЦИЯ\\INTEGR_SERV_PRM\\EXT_SERVICES\\UPDATESTATUSDEAL\\URL";
private const HOST_LOC_REG_PATH =       "РСХБ\\ИНТЕГРАЦИЯ\\INTEGR_SERV_PRM\\EXT_SERVICES\\UPDATESTATUSDEAL\\HOST";
private const SOAPACTION_LOC_REG_PATH = "РСХБ\\ИНТЕГРАЦИЯ\\INTEGR_SERV_PRM\\EXT_SERVICES\\UPDATESTATUSDEAL\\SOAPACTION";


const EXPORT_DEAL_ROLLED_BACK = 201;  // Статус "Разблокировать в Кондор"
const CATEGORY_DEAL = 102; // Категория "Сделка Кондор";

private file attr("objattr.dbt") key 0;

// класс для заполнения извне
private class c_StatusDeal(p_req_data_obj)
   var ExternalID   : string;    // ИД сделки во внешней системе Да
   var DealID       : string;    // ИД сделки в СОФР Да
   var DealNumber   : string;    // Номер сделки Да
   var DealTime     : datetime;      // Дата, время заключения сделки Да
   var Status       : string;    // Текущий статус сделки Да
   
end;

private macro CheckTypeRQ(Type)
   return ( (Type == DLRQ_TYPE_PAYMENT) or
            (Type == DLRQ_TYPE_DELIVERY) or
            (Type == DLRQ_TYPE_COMPPAYM) or
            (Type == DLRQ_TYPE_COMPDELIVERY) or
            (Type == DLRQ_TYPE_PAYMREPOCOUP) or
            (Type == DLRQ_TYPE_PAYMREPOPART) )
end;


/* Класс для работы с таблицей usr_status_deal */
/*class (c_usr_tbl_base) c_usr_status_deal()
   private class gen_usr_status_deal()
      var id          :integer;
      var status      :integer;
      var type_doc    :integer;
      var number_flow :integer;
      var date_op     :date;
   end;

   private macro init_table_obj()
      new_val_obj = gen_usr_status_deal();
      where_val_obj = gen_usr_status_deal();
   end;

   Initc_usr_tbl_base("usr_status_deal");

   init_table_obj();
end;    */

// заполнение класса параметрами объекта Сделка 
macro CreateObjectForExport(Сделка, Действие, _TypeDeal)
   private record  deal(dl_tick);
   private record  deal2(dl_tick);

   private var obj;
   private var err_txt;
   var rq = TRecHandler("dlrq.dbt");
   var rq_arr = TArray;
   var FD, FD2;
   var tmp_flow;
   var dlrq;
   record finin(fininstr);
   var type_avoir;
   var cnt_rq, cnt_all_rq;
   var sql_str, rs;

   var dealstatus = -1;
   var dealid;
   var objecttype;
   var hasError = false;
   var ObjCat;
   
   if (StrUpr(_TypeDeal) == "VNDEAL")
      dealstatus = Сделка.state;
      dealid = String(Сделка.id:o:34);
      //if ( (Сделка.kind == 2710) or (Сделка.kind == 12710) or (Сделка.kind == 26901) )
      if (Сделка.dockind == 199)
         objecttype = 145;  // внебиржевая операция с ПИ
      else
         objecttype = 148; // конверсионная операция 
      end;
   elif (StrUpr(_TypeDeal) == "DEAL")
      if (valType(Сделка) == V_MEMADDR)
        SetBuff( deal, Сделка ); 
        FD = SPFirstDoc( deal );
      elif ( (valType(Сделка) == V_STRUC) or (valType(Сделка) == V_FILE) )
        FD = SPFirstDoc( Сделка );
      elif ( (ValType(Сделка) == V_GENOBJ) and (StrUpr(GenClassName(Сделка)) == StrUpr("SPFirstDoc")) )
        FD = Сделка;
      else
        return null;
      end;   
      dealstatus = FD.tick.rec.dealstatus;
      dealid = String(FD.tick.rec.dealid:o:34);
      objecttype = FD.tick.rec.bofficekind;
   elif (StrUpr(_TypeDeal) == "MBK")
      objecttype = 103;
      sql_str = "select t_dealid, t_dealstatus, t_dealdate, t_dealtype "+
                "  from ddl_tick_dbt where t_bofficekind=102 and t_dealcode='"+Сделка.dealcode+"'";
      rs = RSDRecordSet(sql_str);
      if (rs.movenext)
        dealstatus = rs.value("t_dealstatus");
        dealid = String(rs.value("t_dealid"):o:34);
      end;
   end;
   
   if (dealstatus != 0)
      hasError = true;
      err_txt = "Неподходящий статус сделки.|Сделка должна быть в состоянии \"Отложена\"";
   else
      ObjCat = RsbObjCategories( objecttype, dealid );
      if ( (ObjCat.GetMainAttr( CATEGORY_DEAL, date(31,12,9999), attr ) == 0)
            and (attr.Numinlist == "1")  // Да
          )
         hasError = false;
      else
         hasError = true;
         err_txt = "Неподходящий тип сделки (не Кондор+) |или дата установки категории больше текущей ";
      end;
   end;
   
   if (not hasError)
      if (StrUpr(_TypeDeal) == "VNDEAL")
         obj = c_StatusDeal();

         obj.ExternalID   = Сделка.extcode;
         obj.DealID       = Сделка.code;
         obj.DealNumber   = Сделка.code;
         obj.Status       = Действие;  // Статус сделки в бэкофисной системе
      elif (StrUpr(_TypeDeal) == "DEAL")
         obj = c_StatusDeal();
      
         obj.ExternalID   = FD.tick.rec.dealcodeTS;
         obj.DealID       = FD.tick.rec.DealCode;
         obj.DealNumber   = FD.tick.rec.dealcode;
         var dtt = dttm(FD.tick.rec.dealdate, FD.tick.rec.dealtime);
         obj.DealTime     = dtt;
         obj.Status       = Действие;  // Статус сделки в бэкофисной системе
      elif (StrUpr(_TypeDeal) == "MBK")
         obj = c_StatusDeal();

         obj.ExternalID   = Сделка.dealcodeTS;
         obj.DealID       = Сделка.dealcode;
         obj.DealNumber   = Сделка.dealcode;
         obj.Status       = Действие;  // Статус сделки в бэкофисной системе

      end;
   else
      msgbox(err_txt);
      obj = NULL;
   end;

   return obj;

onerror(err)
  
   
end;

class c_SendStatusDealRequest(Incomedata) // по сути копия класса c_StatusDeal
   var ExternalID   : string;    // ИД сделки во внешней системе Да
   var DealID       : string;    // ИД сделки в СОФР Да
   var DealNumber   : string;    // Номер сделки Да
   var DealTime     ; //: date;      // Дата, время заключения сделки Да
   var Status       : string;    // Текущий статус сделки Да
   
   private macro uInitPrime(IncomeData)
  
      if(ValType(IncomeData) != V_UNDEF)
         ExternalID = uTryToGetPropS(IncomeData, "ExternalID");
         DealID = uTryToGetPropS(IncomeData, "DealID");
         DealNumber = uTryToGetPropS(IncomeData, "DealNumber");
         DealTime = uTryToGetPropS(IncomeData, "DealTime");
         Status = uTryToGetPropS(IncomeData, "Status");
      end;
      
   end;
   
   macro is_empty_obj()
      private var ret = false;
      private var empty_prm_list = TArray;

      if((ValType(ExternalID) == V_UNDEF) and
         (ValType(DealID) == V_UNDEF) and
         (ValType(DealNumber) == V_UNDEF) and
         (ValType(DealTime) == V_UNDEF) and
         (ValType(Status) == V_UNDEF))
         ret = true;
      end;

      if((not ret) and (empty_prm_list.size != 0))
         RunError(make_prm_absense_msg(empty_prm_list));
      end;

      return ret;
   end; /* macro is_empty_obj() */
   
   uInitPrime(IncomeData); 
      
end;

private class c_ExportDealResponse(IncomeData)
   var ReqID        :String   // 1   Уникальный идентификатор запроса, на который сформирован ответ 
      ,SenderID     :String   // 0-1 Идентификатор (код) Абонента, кому адресован ответ
      ,ResultCode   :String   // 0-1 Результат обработки входного запроса. Справочник (Код)
      ,ResultText   :String;  // 0-1 Результат обработки входного запроса. Текст
end;

/* Корневой элемент ответа - AS ID - как пришел */
private class adp_ExportDealResponse(IncomeData)
   private class c_Result
      var Code : integer;  // Поле Код, обязательное: Да
      var Text : string;   // Поле Текст, обязательное: Нет
   end;

   var ReqID      : string;   // ИД исходного запроса, обязательное: Да
//   var SenderId   : string;   // Код АС-получателя ответа, обязательное: Нет
   var ExternalID : string;   // ИД сделки во внешней системе, обязательное: Нет
   var DealID     : string;   // ИД сделки в СОФР, обязательное: Нет
   var Result     : c_Result; // обязательное: Да

   var aux_buff;

   /* Кратность параметров в соответствии со схемой/спецификацией */
   private macro uInitPrime(IncomeData)
      var err_txt;
      
      /* !!! Фактически, здесь могут быть также трансформации,                 !!! */
      /* !!! связанные с различием получаемой и ожидаемой инициатором структур !!! */
      if(ValType(IncomeData) != V_UNDEF)
         ReqID = uTryToGetPropS(IncomeData, "ReqID");
         //SenderID = uTryToGetPropS(IncomeData, "SenderID");
         ExternalID = uTryToGetPropS(IncomeData, "ExternalID");
         DealID = uTryToGetPropS(IncomeData, "DealID");
         
         aux_buff = uTryToGetPropS(IncomeData, "Result");
         if (ValType(IncomeData) != V_UNDEF)
            Result.Code = uTryToGetPropS(aux_buff, "Code");
            Result.Text = uTryToGetPropS(aux_buff, "Text");
         else
            err_txt = string(InErrComPart, "Result");
            RunError(err_txt, c_err_obj(err_txt,"No param")); 
         end;
      end;
   end;

   uInitPrime(IncomeData);
end; /* class adp_ExportDealResponse(IncomeData) */


/* Основной класс работы с сервисом */
private class (c_secur_ext_ws_processor) c_ExportStatusDealProcessor(IncomeData_main)

   private class cc_ExportStatusDeal(IncomeData)
      var UpdateStatusDeal_req; /* !!! По названию корневого тега запроса !!! */

      private macro uInitPrime(IncomeData)
         UpdateStatusDeal_req = c_SendStatusDealRequest(IncomeData);
         if(UpdateStatusDeal_req.is_empty_obj())
            RunError(string(InErrComPart, "UpdateStatusDeal_req"));
         end;
      end;

      uInitPrime(IncomeData);
   end; /* private class cc_ExportStatusDeal(IncomeData) */

   private macro uInitPrime_main(IncomeData_main)
      // определимся с классом.
      var obj, DefineDealType; 
      var err_txt;
      if (Valtype(IncomeData_main) != V_GENOBJ)
        err_txt = "Неверный тип входящего параметра, ожидается class";
        RunError(err_txt, c_err_obj(err_txt,-101));
      end;
      
      obj = cc_ExportStatusDeal(IncomeData_main);
      
      set_req_obj(obj);
   end;


   /*----------------------------------------------*/
   /* Метод получения сообщения запроса из объекта */
   /*----------------------------------------------*/
   /*      Перегруженный метод базового класса     */
   /*----------------------------------------------*/
   macro m_make_req_msg(p_root_ns_alias, p_ns_list)
      private var v_ret = true;
      private var v_username = NULL;
      private var v_userpassword = NULL;
      private var v_ruleName = NULL;
      private var xmltxt;

      private var v_wrap_obj;

      if(v_ret)
         vg_req_msg = c_secur_msg_converter.m_secur_external_req(vg_req_obj);
         
         v_username     = uGetRegistryParam(RUN_USERNAME, V_STRING);
         v_userpassword = uGetRegistryParam(RUN_USERPASSWORD, V_STRING);
         v_ruleName     = uGetRegistryParam(RUN_RULENAME, V_STRING);

         CaptureOutput;
         println("<Run xmlns=\"http://systematica.ru/ModullarWebService\">");
         println("   <userName>"+v_username+"</userName>");
         println("   <userPassword>"+v_userpassword+"</userPassword>");
         println("   <ruleName>"+v_ruleName+"</ruleName>");
         println("   <message><![CDATA[ ");
         println("   "+vg_req_msg);
         println("     ]]></message> " );
         println("</Run>");

         xmltxt = StopCaptureOutput;
         
         v_wrap_obj = c_secur_msg_converter();

         if(v_wrap_obj.m_wrap_req_in_soap(xmltxt,
                                          p_root_ns_alias,
                                          p_ns_list))
            vg_req_msg = v_wrap_obj.get_result_msg();
         else
            vg_service_msg = vg_req_msg.get_service_msg();
            v_ret = false;
         end;

         v_wrap_obj = null;
      end;

      return v_ret;

   onError(err)
      v_ret = false;
      vg_service_msg = string("При формировании сообщения запроса возникла ошибка: ",
                              c_usr_err_obj.obtain_err_msg(err));

      return v_ret;
   end; /* macro m_make_req_msg() */

   Initc_secur_ext_ws_processor();

   uInitPrime_main(IncomeData_main);
end; /* private class c_ExportStatusDealProcessor() */


/*-------------------------------------------------------------------*/
/* Адаптер для вызова сервиса "Выгрузка статуса сделки"              */
/*-------------------------------------------------------------------*/
macro ExportStatusDeal(ReqData)
   var service_processor = NULL;
   var RespData = NULL;
   var PrepObj = NULL;
   var RespObj = NULL;
   var RespErr = NULL;
   var aux_buff_a, aux_buff_i;

   var v_url, v_host, v_soapaction;

   if ( (ReqData == NULL) or (ValType(ReqData) == V_UNDEF) )
      return null;
   end;

   service_processor = c_ExportStatusDealProcessor(ReqData);


   /* Подготовка сообщения для отправки */
   if(not service_processor.m_make_req_msg(REQ_ROOT_NS_ALIAS, REQ_NS_LIST))
      RunError(service_processor.get_service_msg());
   end;

   v_url        = uGetRegistryParam(URL_LOC_REG_PATH, V_STRING);
   v_host       = uGetRegistryParam(HOST_LOC_REG_PATH, V_STRING);
   v_soapaction = uGetRegistryParam(SOAPACTION_LOC_REG_PATH, V_STRING);

   /* Отправка запроса */
   BegAction(2000,"Ожидание ответа от сервера. Запрос ...");
   if(not service_processor.uCallExtServiceViaWinHttp(v_url, modulename(), "EXPORTSTATUSDEAL", v_host, v_soapaction))
      RunError(string("Code: ", service_processor.get_service_code(),
                      "Text: ", service_processor.get_service_msg()));
   end; 
   EndAction();

   /* Получение объекта ответа в том виде, в котором он пришел */
   if(not service_processor.m_make_resp_obj())
      RunError(service_processor.get_service_msg());
   end;

   /* Преобразование объектов ответа к ожидаемому формату */
   RespData = adp_ExportDealResponse(service_processor.get_resp_obj());
   /* Преобразование объекта к виду, ожидаемому Системой */


//test
/*   RespData.ReqID = 11;
   RespData.SenderId   = 0;
   RespData.ExternalID = ReqData.ExternalID;   
   RespData.DealID     = ReqData.DealID;
   RespData.Result.Code = -100;
   RespData.Result.Text = "Текст ошибки";

   var long_txt = String( 
"   RespData.ReqID       = "+ RespData.ReqID      + "\n"+
"   RespData.SenderId    = "+ RespData.SenderId   + "\n"+
"   RespData.ExternalID  = "+ RespData.ExternalID + "\n"+   
"   RespData.DealID      = "+ RespData.DealID     + "\n"+
"   RespData.Result.Code = "+ RespData.Result.Code+ "\n"+
"   RespData.Result.Text = "+ RespData.Result.Text);   */


//   AddNotifyToDbt("Ошибка обработки статуса", long_txt, "geraskina@softlab.ru");
//   SendNotyfyToEmail(false, true);




   /* !!! Далее, в зависимости от способа вызова этого макроса, могут идти   !!! */
   /* !!! дальнейшие шаги для приведения полученного ответа к жалаемому виду !!! */

   /* Для понимания пришла ошибка или нормальный результат проверяем наличие параметра ReqID */
   if(ValType(uTryToGetPropS(RespData, "ReqID")) != V_UNDEF)
//      PrepObj = adp_RSCReqFindAccountsResponse(RespData);
      PrepObj = RespData;

      /*---------------------*/
      /* Anti-Zombie - begin */
      /*RespObj = c_ExportDealResponse();
      RespObj.ReqID = PrepObj.ReqID;
      RespObj.SenderID = PrepObj.SenderID;
      RespObj.ResultCode = PrepObj.ResultCode;
      RespObj.ResultText = PrepObj.ResultText;*/
      /* Anti-Zombie - end */
      /*-------------------*/
   else
      /* Сообщение с ошибкой обрабатывается выше */
      /* Неизвестный формат ответного сообщения */
      /*RespObj = RSCFaultResponse;
      RespObj.ReqID = REQUEST_ID;
      RespObj.faultType = UNIVERSAL_ERROR_TYPE;
      RespObj.faultCode = UNIVERSAL_ERROR_CODE;
      RespObj.faultString = "Выгрузка статуса сделок: неизвестный формат ответного сообщения";        */
   end;

    msgbox("OK");

   return RespObj;

onError(err)
   EndAction();
/*   RespErr = RSCFaultResponse;
   RespErr.ReqID = REQUEST_ID;
   RespErr.faultType = UNIVERSAL_ERROR_TYPE;
   RespErr.faultCode = UNIVERSAL_ERROR_CODE;
   RespErr.faultString = string("Выгрузка статуса сделок: ", uTryToGetPropS(err, "message")); 

   return RespErr;*/
end; /* macro ExportStatusDeal(ReqData) */


/*---------------------------------------*/
/*              Точка входа              */
/*---------------------------------------*/
/* ReqData - данные для отправки         */
/*---------------------------------------*/
macro UpdateStatusDeal(ReqData, _doit)
//!!временно
  if (_doit)
   return ExportStatusDeal(ReqData);
  end;
end;


//ws_exp_StatusDeal(1,1);

