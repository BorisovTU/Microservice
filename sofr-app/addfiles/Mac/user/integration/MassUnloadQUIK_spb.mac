/* BIQ-7041
MassUnloadQUIK_spb

СОФР должен отобрать действующие договоры с признаком выгрузки клиента в QUIK и РСХБ-Брокер, проставленным UID и типом авторизации "двухфакторная авторизация" и попадающие под открытие торговой площадки на СПБ и выгрузить обновление данных по таким договорам. 

*/
import dlcontrfunc;
import global_utils_intgr;

macro ExecMassUnloadQUIK_spb()

   var sql_str, rs, cmd;
   var marketid_spb = ПолучитьБиржуПоВидуКодаДБО(DLCCK_SPB_BIDCODE); 
   var codekind = 105;
   var num_rows=0, cnt=0;
   
   sql_str = "SELECT dl.t_dlcontrid dl_id, cntr.t_number, cntr.t_name, dl.t_iis, cntr.t_partyid , "+
             "       cntr_mp.t_id cntr_id,  cntr_mp.t_servkind, cntr_mp.t_servkindsub, mp.t_id mp_id, mp.t_mpcode "+
             "  FROM dsfcontr_dbt cntr, "+
             "       ddlcontr_dbt dl, "+
             "       ddlcontrmp_dbt mp, "+
             "       dsfcontr_dbt cntr_mp "+
             "WHERE dl.t_sfcontrid = cntr.t_id "+
             "  AND dl.t_dlcontrid = mp.t_dlcontrid "+
             "  AND cntr_mp.t_id = mp.t_sfcontrid "+
             "  AND cntr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') "+
             "  AND cntr_mp.t_servkind = 1 and cntr_mp.t_servkindsub = 8 "+
             "  AND mp.t_mpclosedate = to_date('01.01.0001','dd.mm.yyyy') and mp.t_marketid = :marketid"+
             "  AND exists (select 1 from dobjatcor_dbt o where o.t_objecttype = 207 and o.t_groupid = 170 "+
             "                 and o.t_attrid = 2 and (o.t_validtodate >= :dt or o.t_validtodate = to_date('01.01.0001','dd.mm.yyyy')) "+
             "                 and lpad(dl.t_dlcontrid,34,'0') = o.t_object ) "+
             "   and exists (select 1 from dobjatcor_dbt o where o.t_objecttype = 3 and o.t_groupid = 171 "+
             "                  and o.t_attrid = 1 and (o.t_validtodate >= :dt or o.t_validtodate = to_date('01.01.0001','dd.mm.yyyy')) "+
             "                  and lpad(cntr.t_partyid,10,'0') = o.t_object) "+
             "   and exists (select 1 from dobjcode_dbt where t_ObjectType = 3 "+
             "                  and t_codekind = :codekind and t_objectid = cntr.t_partyid"+
             "                  and t_BankCloseDate = TO_DATE('01010001', 'DDMMYYYY') )";
             
   var sql_str2 = "select count(*) from ("+sql_str+")";
   cmd = RSDCommand(sql_str2);
   
   cmd.AddParam("marketid", RSDBP_IN, marketid_spb);
   cmd.AddParam("dt1", RSDBP_IN, date());
   cmd.AddParam("dt2", RSDBP_IN, date());
   cmd.AddParam("codekind", RSDBP_IN, codekind);
   rs = RSDRecordSet(cmd );
   if (rs.movenext )
      num_rows = Int(rs.value(0));
   end;
   rs.close; cmd.close; rs = null; cmd = null;

   cmd = RSDCommand(sql_str);
   cmd.AddParam("marketid", RSDBP_IN, marketid_spb);
   cmd.AddParam("dt1", RSDBP_IN, date());
   cmd.AddParam("dt2", RSDBP_IN, date());
   cmd.AddParam("codekind", RSDBP_IN, codekind);
   rs = RSDRecordSet(cmd );

   InitProgress(num_rows);

   while (rs.movenext)
      m_make_event_to_process(5025, rs.value("t_partyid"));
      cnt = cnt+1;
      UseProgress(cnt);
   end;
   RemProgress();
   return True;
end;