/****************************************************\
 *           Cherednichenko 09.12.2019              *
 * Выгрузка данных по сделкам Condor+ из базы ПРОДа *
\****************************************************/

import rsbdataset;
import "clob_to_string.mac";

// Макрос выгрузки данных Кондор-СОФР
MACRO downloaddata()
  var sqltext, rs;   // sql queries and results
  var strBuf:string; // буфер для перевода из клоб в текст
  var i;             // счетчики
  var SelDate;

  GetDate(SelDate);
  file datafile("condor_sofr_deals.csv") txt write;  //scv файл

  sqltext = " select xr1.* from dxr_log_dbt xr1 join dxr_log_dbt xr2 on 1=1 "
	  + " and xr1.t_reqid = xr2.t_reqid "
	  + " and xr1.t_kind = 1 "
	  + " and xr2.t_kind = 3 "
	  + " and xr2.t_func = 'ProcessDeals' ";
  if (SelDate == "")
   sqltext = sqltext + " and xr1.t_sysdate = trunc(sysdate) "
   else
    sqltext = sqltext + " and xr1.t_sysdate = to_date('" + SelDate + "', 'dd.mm.yyyy') "
  end;

  rs = RsdRecordSet(sqltext);

  if ( Open( datafile ) )
    while (rs.movenext())
      i = 0;
      while (i < rs.fldCount)
/*
0T_ID			0
1T_LOGTYPE,		0
2T_KIND,		1
3T_REQID,		req
4T_SESSIONID,		23
5T_OPER,		9997
6T_DATE,		n
7T_SYSDATE,		n
8T_SYSTIME,		n
9T_MESSAGE,		n
10T_ERRORCODE,	0
11T_OFFLINEFILE,	n
12T_OFFLINENUM,	0
13T_MACRO,		ws_ProcessDeals
14T_FUNC,		ProcessDeals
15T_ROLE,		1
16T_URL,		n
17T_LOGIN,		n
18T_METHOD,		n
19T_LOGICALID,	n
20T_DIRECTION,	0
21T_SOURCE,		n
22T_DESTINATION	n
*/


        if (i == 9) // Переводим t_message из clob в текстовый вид
          strBuf = GetClobData(rs.value(0), 32000, "DXR_LOG_DBT", "T_MESSAGE");
	  elif (i == 0)
           strBuf = "NULL";
	  elif (i == 1)
           strBuf = "0";
/*
	  elif (i == 3)
           strBuf = "11111111";
*/
	  elif (i == 10)
           strBuf = "0";
         elif (i == 11)
           strBuf = "NULL";
         elif (i == 12)
           strBuf = "0";
         elif (i == 13)
           strBuf = "ws_ProcessDeals";
         elif (i == 14)
           strBuf = "ProcessDeals";
         elif (i == 16)
           strBuf = "NULL";
         elif (i == 17)
           strBuf = "NULL";
         elif (i == 18)
           strBuf = "NULL";
         elif (i == 19)
           strBuf = "NULL";
         elif (i == 21)
           strBuf = "NULL";
         elif (i == 22)
           strBuf = "NULL";
         else
          strBuf = rs.value(i);
          if ((i == 6) or (i == 7))
            strBuf = SubStr(strBuf, 1, 10);
          elif (i == 8)
            strBuf = "01.01.0001 " + SubStr(strBuf, 13, 8);
          end;
        end;
        Insert( datafile, strBuf + "|", StrLen(strBuf) + 1 );
      i = i + 1;
      end;
      Insert( datafile, "");
    end;
    Close( datafile );
  else
    msgbox("Ошибка создания файла выгрузки!");
  end;

  if (SelDate != "")
    msgBox("Данные за " + SelDate + " выгружены.\nПожалуйста, переложите файл \"TxtFile\\condor_sofr_deals.csv\" в папку обмена!");
     else
    msgBox("Данные за текущий день выгружены.\nПожалуйста, переложите файл \"TxtFile\\condor_sofr_deals.csv\" в папку обмена!");
  end;

END;

downloaddata();

