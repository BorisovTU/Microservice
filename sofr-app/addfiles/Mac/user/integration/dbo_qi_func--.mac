/*
$Name:        dbo_qi_func.mac
$Module:      Интеграция с внешними системами
$Description: Уведомление квал.инвесторов
*/

/* BIQ-9185 Уведомление квал.инвесторов
   Гераськина Т.В.
   На основе dbo_message_main.mac
*/
import rsexts, rsd;
import "u_common_email_utils.mac";
import or_rep_h;

const INCLUSION_QI = 506;
const TEST_QI = 503;
const EXCLUSION_QI = 504; 
const NOTEKIND_TEMPLATE_QI = 108;
const NOTEKIND_DATE_EXCLUSION_QI = 201;


class dboMessage_qi(_dlcontrid, _messagekind)
   var ddl_id = _dlcontrid, isLast = true, mess_kind = _messagekind; 
   
   var PartyId = 0, Prt_Lfrm = 0, Prt_FNam = "", Prt_Nnam = ""; 
   var Cnt_Eml = "", Cnt_Iis = "", Cnt_Dbeg, Cnt_Stat = 0, Cnt_Emsg = 0;

   const wdFormatPDF = 17;

   private var oWrd, oDoc, IsNtr = isStandalone();

   private var PATH_OUT;
   private var FileDirForm;
   var Mess = "";

   var TemplName = "";
   var Templ_Dir = "";

   var place, doname, donnam, doeml;

   var statMes = "";
   var statsend = 0;
   
   var statfix = 0;
   var fixmes = "";

   var GODBO = "";
   var partyForm = "";
   var NameDP   = "";
   var NumberDBO = "";
   var NumberBO = "";
   var NameBO   = "";
   var FolderName = "";
   var FormFilename = "";
   var FormFilename_clear = "";
   var TempFileName = "";
   var w_ext = ".docx";

   var FormFilenamePDF = "";
   var MessPDF = "";
   var pdfSaveStat = false;
   var TestQIName, test_num;
   
   var msgid = 0, id_uqi = 0;
   
   var Shubl = 1;

   private macro IIF(val, retval, retval2)
      if (Val)
         return retval;
      else
         return retval2;
      end;
   end;

   statMes = "Сообщение уже было сформировано";

   // пустая SQL строка
   macro emp_str(p_par)
      if ((p_par == null) or (p_par == nullval) or (p_par == strfor(1)) or (p_par == strfor(0)) or (p_par == "01.01.0001"))
         return "";
      end;
      return p_Par;
   end;

   // клиент - ГО
   macro isGOClient(p_par)
      return ((p_Par == "") or (p_par == "00"));
   end;

   // наличие сообщения по договору
   macro isExistsMessage() 
      return Cnt_Emsg > 0;
      // реализация с обращением к базе
      var sqls, rsdc;
      sqls = String( 
                     "DECLARE   \n"
                    ,"   v_Ret INTEGER;   \n"
                    ,"BEGIN   \n"
                    ,"   SELECT COUNT(1)   \n"
                    ,"     INTO v_Ret   \n"
                    ,"     FROM Ddlcontrmsg_Dbt Msg, Dimgdata_Dbt Dim, Dimage_Dbt Dig   \n"
                    ,"    WHERE Dim.t_Objectid = Lpad(Msg.t_Id, 34, '0')   \n"
                    ,"      AND Dig.t_Imageid = Dim.t_Imageid   \n"
                    ,"      AND Msg.t_Kind = :p_kind   \n"
                    ,"      AND Msg.t_Dlcontrid = :p_dlId   \n"
                    ,"      AND Dim.t_ObjectType = 208;   \n" //shev def-29032
                    ,"   :p_Ret := v_Ret;   \n"
                    ,"END;   \n"
                   );
      rsdc = rsdcommand(sqls);
      rsdc.AddParam("p_kind", RSDBP_IN, mess_kind);
      rsdc.AddParam("p_dlId", RSDBP_IN, ddl_id);
      rsdc.AddParam("p_Ret", RSDBP_OUT, v_integer);
      rsdc.execute;
      sqls = int(rsdc.Value("p_Ret"));
      rsdc = null;
      return sqls > 0;  
   onerror(e);
      return false;   
   end;
   

   // собрать данные по договору
   macro constructor()
      var sqls, rsdc, rsds, StrErr;
      statMes = "";
      statsend = 0;
      isLast = true;
      sqls = String( 
                     "DECLARE   \n"
                    ,"   v_dlId   Ddlcontr_Dbt.t_Dlcontrid%TYPE := :p_dlId;   \n"
                    ,"   v_kind   Ddlcontrmsg_Dbt.t_Kind%TYPE := :p_kind;   \n"
                    ,"   v_objecttype Dimgdata_Dbt.t_objecttype%TYPE := :p_objecttype;   \n"
                    ,"   v_Partyid  Dparty_Dbt.t_Partyid%TYPE;   \n"
                    ,"   v_Prt_Lfrm Dparty_Dbt.t_Legalform%TYPE;   \n"
                    ,"   v_Prt_Fnam Dparty_Dbt.t_Name%TYPE;   \n"
                    ,"   v_Prt_Nnam Dparty_Dbt.t_Name%TYPE;   \n"
                    ,"   v_Prt_Empl NUMBER(5);   \n"
                    ,"   v_Cnt_Numb Dsfcontr_Dbt.t_Number%TYPE;   \n"
                    ,"   v_Cnt_Name Dsfcontr_Dbt.t_Name%TYPE;   \n"
                    ,"   v_Cnt_Dbeg DATE;   \n"
                    ,"   v_Cnt_Emsg NUMBER(5);   \n"
                    ,"   v_Cnt_Iis  Ddlcontr_Dbt.t_Iis%TYPE;   \n"
                    ,"   v_Godbo    VARCHAR2(50);   \n"
                    ,"   v_Cnt_Eml  Ddlcontr_Dbt.t_Email%TYPE;   \n"
                    ,"   v_Do_Name  Dparty_Dbt.t_Name%TYPE;   \n"
                    ,"   v_Do_Plac  Dadress_Dbt.t_Place%TYPE;   \n"
                    ,"   v_Do_Nnam  Dparty_Dbt.t_Normalizedname%TYPE;   \n"
                    ,"   v_Do_Eml   Dcontact_Dbt.t_Value%TYPE;   \n"
                    ,"   v_Err      VARCHAR2(2000);   \n"
                    ,"BEGIN   \n"
                    ,"   BEGIN   \n"
                    ,"      SELECT Dp.t_Partyid   \n"
                    ,"            ,Dp.t_Name Prt_Name   \n"
                    ,"            ,Dp.t_Normalizedname Nrm_Name   \n"
                    ,"            ,Dp.t_Legalform Prt_Lf   \n"
                    ,"            ,Dsf.t_Name Dsf_Name   \n"
                    ,"            ,Dsf.t_Number Dsf_Numb   \n"
                    ,"            ,Dsf.t_Datebegin Dsf_Datb   \n"
                    ,"            ,Dl.t_Iis   \n"
                    ,"            ,Dl.t_Email   \n"
                    ,"        INTO v_Partyid   \n"
                    ,"            ,v_Prt_Fnam   \n"
                    ,"            ,v_Prt_Nnam   \n"
                    ,"            ,v_Prt_Lfrm   \n"
                    ,"            ,v_Cnt_Name   \n"
                    ,"            ,v_Cnt_Numb   \n"
                    ,"            ,v_Cnt_Dbeg   \n"
                    ,"            ,v_Cnt_Iis   \n"
                    ,"            ,v_Cnt_Eml   \n"
                    ,"        FROM Ddlcontr_Dbt Dl   \n"
                    ,"       INNER JOIN Dsfcontr_Dbt Dsf ON (Dsf.t_Id = Dl.t_Sfcontrid)   \n"
                    ,"       INNER JOIN Dparty_Dbt Dp    ON (Dp.t_Partyid = Dsf.t_Partyid)   \n"
                    ,"       WHERE Dl.t_Dlcontrid = v_dlId;   \n"
                    ,"      -- наличие сообщений по договору   \n"
                    ,"      SELECT Decode(COUNT(1), 0, 0, 1)   \n"
                    ,"        INTO v_Cnt_Emsg   \n"
                    ,"        FROM Ddlcontrmsg_Dbt Msg, Dimgdata_Dbt Dim, Dimage_Dbt Dig   \n"
                    ,"       WHERE Dim.t_Objectid = Lpad(Msg.t_Id, 34, '0')   \n"
                    ,"         AND Dig.t_Imageid = Dim.t_Imageid   \n"
                    ,"         AND Msg.t_Kind = v_kind   \n"
//shev def-29032
                    ,"         AND dim.t_objecttype = v_objecttype   \n"
                    ,"         AND Msg.t_Dlcontrid = v_dlId;   \n"
                    ,"      -- наименование филиала, очень похоже на рег.номер КО   \n"
                    ,"      IF TRIM(v_Godbo) IS NOT NULL THEN   \n"
                    ,"         v_Do_Name := '3349/' || v_Godbo;   \n"
                    ,"         BEGIN   \n"
                    ,"            SELECT Decode(Adr.t_Place, Chr(1), Adr.t_District, Adr.t_Place), Prt.t_Normalizedname   \n"
                    ,"              INTO v_Do_Plac, v_Do_Nnam   \n"
                    ,"              FROM Ddp_Dep_Dbt Dpt   \n"
                    ,"             INNER JOIN Dparty_Dbt Prt   \n"
                    ,"                ON (Prt.t_Partyid = Dpt.t_Partyid)   \n"
                    ,"             INNER JOIN Dadress_Dbt Adr   \n"
                    ,"                ON (Adr.t_Partyid = Dpt.t_Partyid AND Adr.t_Type = 1)   \n"
                    ,"             WHERE Dpt.t_Name = v_Godbo || '00';   \n"
                    ,"         EXCEPTION   \n"
                    ,"            WHEN OTHERS THEN   \n"
                    ,"               v_Do_Name := 'АО РОССЕЛЬХОЗБАНК';   \n"
                    ,"               v_Do_Plac := 'Москва';   \n"
                    ,"         END;   \n"
                    ,"         BEGIN   \n"
                    ,"            SELECT '<' || Cnt.t_Value || '>'   \n"
                    ,"              INTO v_Do_Eml   \n"
                    ,"              FROM Ddp_Dep_Dbt Dpt   \n"
                    ,"             INNER JOIN Dcontact_Dbt Cnt   \n"
                    ,"                ON (Cnt.t_Partyid = Dpt.t_Partyid AND Cnt.t_Contactkind = 5 AND Cnt.t_Contacttype = 8)   \n"
                    ,"             WHERE Dpt.t_Name = v_Godbo || '00';   \n"
                    ,"         EXCEPTION   \n"
                    ,"            WHEN OTHERS THEN   \n"
                    ,"               v_Do_Eml := '';   \n"
                    ,"         END;   \n"
                    ,"      ELSE   \n"
                    ,"         v_Do_Name := 'АО Россельхозбанк';   \n"
                    ,"         v_Do_Plac := 'Москва';   \n"
                    ,"      END IF;   \n"
                    ,"      v_Do_Plac := Nvl(TRIM(TRIM(Chr(1) FROM v_Do_Plac)), 'Москва');   \n"
                    ,"   EXCEPTION   \n"
                    ,"      WHEN No_Data_Found THEN   \n"
                    ,"         v_Err := 'Данные для договора не найдены: '||v_dlId;   \n"
                    ,"      WHEN OTHERS THEN   \n"
                    ,"         v_Err := 'Ошибка поиска данных для договора: '||v_dlId||' '|| SQLERRM;   \n"
                    ,"   END;   \n"
                    ,"   :p_Partyid  := v_Partyid;   \n"
                    ,"   :p_Prt_Lfrm := v_Prt_Lfrm;   \n"
                    ,"   :p_Prt_Fnam := v_Prt_Fnam;   \n"
                    ,"   :p_Prt_Nnam := v_Prt_Nnam;   \n"
                    ,"   :p_Cnt_Numb := v_Cnt_Numb;   \n"
                    ,"   :p_Cnt_Name := v_Cnt_Name;   \n"
                    ,"   :p_Cnt_Dbeg := v_Cnt_Dbeg;   \n"
                    ,"   :p_Cnt_Emsg := v_Cnt_Emsg;   \n"
                    ,"   :p_Cnt_Iis  := v_Cnt_Iis;   \n"
                    ,"   :p_Cnt_Eml  := v_Cnt_Eml;   \n"
                    ,"   :p_Godbo    := v_Godbo;   \n"
                    ,"   :p_Do_Name  := v_Do_Name;   \n"
                    ,"   :p_Do_Plac  := v_Do_Plac;   \n"
                    ,"   :p_Do_Nnam  := v_Do_Nnam;   \n"
                    ,"   :p_Do_Eml   := v_Do_Eml;   \n"
                    ,"   :p_Err      := v_Err;   \n"
                    ,"END;   \n"
                   );
      rsdc = rsdcommand(sqls);
      rsdc.AddParam("p_dlid", RSDBP_IN, ddl_id);
      rsdc.AddParam("p_kind", RSDBP_IN, mess_kind);
      rsdc.AddParam("p_objecttype", RSDBP_IN, 208);
      rsdc.AddParam("p_Partyid", RSDBP_OUT, v_integer);
      rsdc.AddParam("p_Prt_Lfrm", RSDBP_OUT, v_integer);
      rsdc.AddParam("p_Prt_Fnam", RSDBP_OUT, v_string, 500);
      rsdc.AddParam("p_Prt_Nnam", RSDBP_OUT, v_string, 500);
      rsdc.AddParam("p_Cnt_Numb", RSDBP_OUT, v_string, 500);
      rsdc.AddParam("p_Cnt_Name", RSDBP_OUT, v_string, 500);
      rsdc.AddParam("p_Cnt_Dbeg", RSDBP_OUT, v_date);
      rsdc.AddParam("p_Cnt_Emsg", RSDBP_OUT, v_integer);
      rsdc.AddParam("p_Cnt_Iis", RSDBP_OUT, v_string);
      rsdc.AddParam("p_Cnt_Eml", RSDBP_OUT, v_string, 500);
      rsdc.AddParam("p_Godbo", RSDBP_OUT, v_string);
      rsdc.AddParam("p_Do_Name", RSDBP_OUT, v_string, 500);
      rsdc.AddParam("p_Do_Plac", RSDBP_OUT, v_string, 500);
      rsdc.AddParam("p_Do_Nnam", RSDBP_OUT, v_string, 500);
      rsdc.AddParam("p_Do_Eml", RSDBP_OUT, v_string, 500);
      rsdc.AddParam("p_Err", RSDBP_OUT, v_string, 2000);
      rsdc.execute;   
      if ((rsdc.Value("p_Err") != null) and (rsdc.Value("p_Err") != nullval))
         runerror("Ошибка получения данных по договору", rsdc.Value("p_Err"));
      end;
      PartyId   = int(rsdc.value("p_Partyid"));
      Prt_Lfrm  = int(rsdc.value("p_Prt_Lfrm"));
      if (Prt_Lfrm == 1)
         PartyForm = "Юридическое лицо";
      elif (Prt_Lfrm == 2)
         PartyForm = "Физическое лицо";
      end;
      Prt_Fnam  = emp_str(rsdc.value("p_Prt_Fnam"));
      Prt_Nnam  = emp_str(rsdc.value("p_Prt_Nnam"));
      if ((Prt_Nnam == null) or (Prt_Nnam == nullval))
         Prt_Nnam = strsubst(strupr(Prt_Fnam), "-", " ");
         Prt_Nnam = strsubst(strupr(Prt_Nnam), "Ё", "Е ");
         Prt_Nnam = strsubst(strupr(Prt_Nnam), "ё", "е");
         while (index(Prt_Nnam, "  ") > 0)
            Prt_Nnam = strsubst(Prt_Nnam, "  ", " ");
         end;
      end;
      NumberDBO = emp_str(rsdc.value("p_Cnt_Numb"));
      NumberDBO = emp_str(NumberDBO);
      NameBO    = rsdc.value("p_Cnt_Name");
      if (strlen(trim(NameBO)) == 0)
         NameBO = Prt_Fnam;
      end;
      Cnt_Dbeg = rsdc.value("p_Cnt_Dbeg"); 
      Cnt_Emsg = int(rsdc.value("p_Cnt_Emsg")); 
      NumberBO  = NumberDBO; 
      Cnt_Iis   = emp_str(rsdc.Value("p_Cnt_Iis"));
      Cnt_Eml = emp_str(rsdc.Value("p_Cnt_Eml"));

      GODBO  = rsdc.value("p_Godbo");
      GODBO  = emp_str(GODBO); ;
      place  = rsdc.value("p_Do_Plac");
      place  = emp_str(place);
      doname = rsdc.value("p_Do_Name");
      doname = emp_str(doname); 
      donnam = rsdc.value("p_Do_Nnam");
      donnam = emp_str(donnam); 
      doeml  = rsdc.value("p_Do_Eml");
      doeml  = emp_str(doeml); 

      if (PartyId == 114800) 
         NameDP = NameBO;
      else   
         NameDP = Prt_Fnam;
      end;

      PATH_OUT = "";
     
      if (isGOClient(GODBO))
         GetRegistryValue("РСХБ\\ДИРЕКТОРИИ\\OUT\\ГО", V_STRING, PATH_OUT, StrErr);
         FolderName = "";
      else 
         GetRegistryValue("РСХБ\\ДИРЕКТОРИИ\\OUT\\ФИЛИАЛ", V_STRING, PATH_OUT, StrErr);
         FolderName = GODBO + "00 " + strSubst(substr(donnam,1,41),"\"","") + "\\";
      end;
      GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEMPLSDIR", V_STRING, Templ_Dir, StrErr);
      FileDirForm = "..\\txtFile\\";

      FormFilename_clear = NumberDBO + "_" + NameBO+"_QI";
      FormFilename_clear = strSubst(FormFilename_clear,"\"","");
      FormFilename_clear = strSubst(FormFilename_clear,"\\","-");
      FormFilename_clear = strSubst(FormFilename_clear,"/","-");

   onerror(e);
      if ((e.Err != null) or (e.Err != nullval))
         statMes = e.Err;
      else 
         statMes = e.Message;
      end;
      statsend = -1;
   end;
   
   // полное имя файла из относительного
   macro abs_path(p)
      var i = 0, l = 0, pth = "";
      if (substr(p, 1, 1) != ".")
         return p;
      end;        
      if (IsNtr)
         pth = GetCurDir(false);
         while (true)
            i = index(pth, "\\", l + 1);
            if (i == 0)
               break;
            else
               l = i;
            end;
         end;       
         if (l > 0)
            pth = substr(pth, 1, l - 1);
         end;
      else
         pth = GetCurDir(true);
      end;
      p = strsubst(p, "..", "");
      return string(pth, p); 
   end;
   
   // закрыть Word
   macro cls_word()
      if (oDoc)
         // закрыть без сохранения, так как сохранение уже могло не выполниться
         // после этого Word в скрытом режиме держит обращение к пользователю
         oDoc.Close(false);
      end;   
      oDoc = null;
      if (isLast)
         if (oWrd)
            oWrd.Quit;
         end;   
         oWrd = null;
      end;  
   onerror(e)
      if (oWrd)
         oWrd.Quit;
      end;   
      oDoc = oWrd = null;
   end;  
   
   // коррекция терминального имени для копирования
   macro fnam4copy(p)
   if (not isNtr)
      if (substr(p, 1, 1) == "$")
         return p;
      end;
      return string("$", p);
   end;
   return p;
   end;
   
   // открыть Word
   macro opn_word(fnam)
      if (oWrd == null)     
         if (IsNtr)
            oWrd = ActiveX("Word.Application", NULL, false);
         else
            oWrd = CreateObject("rsax", "TRsAxServer", "RsAxServer", false).CreateComObject("Word.Application", false);
         end;
      end;   
      oWrd.DisplayAlerts = 0;
      oWrd.Visible = false;
      oDoc = oWrd.Documents.Open(fnam);
      return true;
   onerror (e);
      return false;
   end;
   
   // значение из Word - пустое
   macro nrm_wstr(p_val)
      p_val = emp_str(p_val);
      p_val = strsubst(p_val, strfor(0), "");
      p_val = strsubst(p_val, strfor(1), "");
      p_val = strsubst(p_val, strfor(7), "");
      p_val = strsubst(p_val, strfor(9), "");
      p_val = strsubst(p_val, strfor(10), "");
      p_val = strsubst(p_val, strfor(13), "");
      p_val = strsubst(p_val, " ", "");
      p_val = trim(p_val);
      return p_val;
   end;
   
   // закладки 
   macro fill_bmk
      var bmks, bmkc, nam_b = "", val_b = "";     
      bmks = oDoc.Bookmarks;
      bmkc = bmks.Count;
      while (bmkc > 0)
         nam_b = Strupr(bmks.item(1).Name); 
         if (index(nam_b, "FULLNAME") > 0)  
            val_b = TestQIName; 
          else
            bmks.item(1).delete;
         end;
         bmks.item(1).Range.Text = val_b;
         if (bmkc == bmks.Count)
            bmks.item(1).delete;
         else   
         end;
         bmkc = bmks.Count;
      end;
   end;

   macro save_pdf()
       MessPDF = abs_path(toAnsi(MessPDF));
       oDoc.SaveAs(MessPDF, wdFormatPDF);
       pdfSaveStat = true;
   onerror(e)
       pdfSaveStat = false; 
   end;

   // формирование текста уведомления
   macro Head_Form(p_Templ)
      var tpl_dir, strErr, fil_nam = "", count = 0, str = "", i = 0;
      var tpl_nam = "";
      //доставить шаблон в место формирования
      tpl_nam = FindPath(toANSI(p_Templ), Templ_Dir);
      if (strlen(trim(tpl_nam)) == 0)
         runerror("Ошибка поиска шаблона", "Ошибка поиска шаблона " + p_Templ);
      end;  
      fil_nam = abs_path(toAnsi(MESS));
      MESS = fil_nam;
      if (NOT CopyFile(tpl_nam, fnam4copy(fil_nam), false, "Копирование шаблона"))
         runerror("Ошибка получения шаблона", "Ошибка получения шаблона " + toOem(tpl_nam));
      end;
      if (not opn_word(fil_nam))
         cls_word();
         runerror("Ошибка открытия файла", "Ошибка открытия файла " + toOem(fil_nam));
      end;
      fill_bmk();
      oDoc.Save;
      save_pdf();
      cls_word();
      return "";
   onerror(e)
      if (e.Err)
         if (IsEqClass ("TRsComErr", e.err))
            count = e.err.Count;
            i = 0;
            while (i < count)
               str = string(str, e.err.Message(i), " (Code = ",e.err.Code(i), ", Level = ",e.err.Level(i), ")", strfor(10));
               i = i + 1
            end;
            str = str + " " + e.Module + " " + e.Line + " " + e.Message;
         elif (valtype(e.err) == v_string)
            str = e.err;
         else
            str = e.Module + " " + e.Line + " " + e.Message;
         end;  
      else
         str = e.Module + " " + e.Line + " " + e.Message;
      end;    
      //если ошибки работы с Word то надо полностью закрывать Word для этой сессии
      //иначе дальнешее поведение непредсказуемо
      isLast = true;
      cls_word();
      return str;
   end;
   
   // создать уведомление
   macro CreateNotification()
      FormFilenamePDF = FormFilename_clear + test_num + ".pdf";
      FormFilename    = FormFilename_clear + test_num + w_ext;

      Mess = string(FileDirForm, FormFilename);
      MessPDF = string(FileDirForm, FormFilenamePDF);

      return Head_Form(TemplName);
   end;
   
   
   macro CreateNotification_byRep()
      var DT = string(Date:f);
      var TM = string(Time:f);
      var Rep = CMakeReport;
      var FileFrom;

      Shubl = Shubl + 1;

      FormFilename    = FormFilename_clear + test_num + "_" + StrSubst(DT, ".", "") + "_" + StrSubst(TM, ":", "")+ w_ext;
      Mess = string(FileDirForm, FormFilename);

      Rep.RegisterForm("testnki" + Shubl, TemplName, FormFilename,"FULLNAME");
      Rep.AddDoc("testnki" + Shubl,"FULLNAME");
      Rep.AddDocFields("FULLNAME", TestQIName);

      Rep.SetFlagShowReport(false);
      Rep.CreateTemplateData();
      Rep.ShowTemplateRep();
      Rep.ClearRegisterForm("testnki" + Shubl);

      if(isStandAlone())
          FileFrom = "..\\txtfile\\";
      else
          FileFrom = "$txtfile\\";
      end;
      FileFrom = FileFrom+FormFilename;

      MakeDir(string(PATH_OUT, FolderName));
      Mess = string(PATH_OUT, FolderName, FormFilename);

      // перенос файла
      if (not CopyFile(FileFrom, Mess))
         runerror("Ошибка формирования уведомления", "Не удалось скопировать файл " + FormFilename + " в директорию " + string(PATH_OUT, FolderName));
      end;

   end;

   // выгрузка сообщения в файл
   macro downLoadMessage()
      var sqls, rsdc, rsds;
      sqls = String( 
                     "SELECT Dbms_Lob.Getlength(Dig.t_Fmtblobdata_Xxxx) Siz Dig.t_Fmtblobdata_Xxxx Val   \n"
                    ,"  FROM Ddlcontrmsg_Dbt Msg, Dimgdata_Dbt Dim, Dimage_Dbt Dig   \n"
                    ," WHERE Lpad(Msg.t_Id, 34, '0') = Dim.t_Objectid   \n"
                    ,"   AND Msg.t_Kind = :p_kind   \n"
                    ,"   AND Dim.t_Imageid = Dig.t_Imageid   \n"
                    ,"   AND Msg.t_Dlcontrid = :p_dlId   \n"
                   );
      rsdc = RsdCommand(sqls);
      rsdc.addParam("p_kind" ,RSDBP_IN, mess_kind);
      rsdc.addParam("p_dlId" ,RSDBP_IN, ddl_id);
      rsds = rsdrecordset(rsdc,RSDVAL_CLIENT_IF_NEEDED,RSDVAL_FORWARD_ONLY);
      if (rsds.MoveNext)
         rsds.Fld("val").Read(sqls, Int(rsds.Value("siz")));
      end;
      rsds = null;
      rsdc = TStream(FileDirForm + FormFilename, "WA");
      rsdc.write2(sqls);
      rsdc = null;
      onerror(err);
   end;
   
   // имя файла - сообщения
   macro getMessageNameInDB()
      var sqls, rsdc;
      sqls = String( 
                     "DECLARE   \n"
                    ,"   v_Ret Dimgdata_Dbt.t_Filename%TYPE;   \n"
                    ,"   v_msgid Ddlcontrmsg_Dbt.t_id%TYPE;   \n"
                    ,"BEGIN   \n"
                    ,"   BEGIN   \n"
                    ,"      SELECT t_Filename, t_id   \n"
                    ,"        INTO v_Ret, v_msgid   \n"
                    ,"        FROM (SELECT Dim.t_Filename, Msg.t_id   \n"
                    ,"                FROM Ddlcontrmsg_Dbt Msg, Dimgdata_Dbt Dim, Dimage_Dbt Dig   \n"
                    ,"               WHERE Dim.t_Objectid = Lpad(Msg.t_Id, 34, '0')   \n"
                    ,"                 AND Dig.t_Imageid = Dim.t_Imageid   \n"
                    ,"                 AND Msg.t_Kind = :p_kind   \n"
                    ,"                 AND Msg.t_Dlcontrid = :p_dlId   \n"
                    ,"                 AND Dim.t_ObjectType = 208   \n" 
                    ,"               ORDER BY Msg.t_Createdate DESC, Msg.t_Createtime DESC)   \n"
                    ,"       WHERE Rownum = 1;   \n"
                    ,"   EXCEPTION   \n"
                    ,"      WHEN OTHERS THEN   \n"
                    ,"         v_Ret := NULL;   \n"
                    ,"   END;   \n"
                    ,"   :p_Ret := v_Ret;   \n"
                    ,"   :p_msgid := v_msgid;   \n"
                    ,"END;   \n"
                   );
      rsdc = rsdcommand(sqls);
      rsdc.AddParam("p_kind", RSDBP_IN, mess_kind);
      rsdc.AddParam("p_dlId", RSDBP_IN, ddl_id);
      rsdc.AddParam("p_Ret", RSDBP_OUT, v_string, 200);
      rsdc.AddParam("p_msgid", RSDBP_OUT, v_integer);
      rsdc.execute;
      sqls = rsdc.Value("p_Ret");
      msgid = rsdc.Value("p_msgid");
      rsdc = null;
      if ((sqls != null) and (sqls != nullval))
         FormFilename = sqls;
      end;
   end;
   
   // отправка уведомления
   macro SendNotification()  
      private macro GetFullPath( Path )
          var fullpath;
          if( substr( Path, 1, 2 ) == ".." ) /* ссылка на вышестоящий каталог */
            Path = substr(Path, 3 );
          end;
          if( substr( Path, 1, 1 ) == "\\" ) /* ссылка на вышестоящий каталог */
            Path = substr(Path, 2 );
          end;
          fullpath =   strsubst( GetCurDir(false) , "\\Obj","")  + "\\" + Path ; 
        // получить полный путь
        return fullpath;
      end;;
      var Eml, emailText, Subject, v_email_processor;
      var templ_dir;
      var Attachement_name_file = "899-ОД-1-4-заявление об отказе от статуса квал.инвестора.docx";
      var Attachement_name_src, Attachement_name;
      var strerr;                                              
      GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEMPLSDIR", V_STRING, Templ_Dir, StrErr);
      //def-29032 заявление не вкладывается
      Attachement_name_src = FindPath(toANSI(Attachement_name_file), Templ_Dir);
      Attachement_name = string(PATH_OUT, FolderName, Attachement_name_file);

      if (NOT CopyFile(Attachement_name_src, Attachement_name, false, "Копирование шаблона"))
         runerror("Ошибка получения шаблона", "Ошибка получения шаблона " + toOem(Attachement_name_src));
      end;

      Eml = Cnt_Eml;

      if ((ValType(Eml) == V_UNDEF) or (ValType(Eml) == 26) or (trim(eml) == StrFor(1)))
         statMes = "Сообщение сформировано, но не отправлено. Не задан email";
         statsend = 2;
         return;
      end;
      
      if (mess_kind == TEST_QI)
         Subject = "Уведомление о результатах тестирования НКИ. " + Numberdbo + "_" + NameBO;
         Emailtext = String("Добрый день!",
                            "\n",
                            "\nВ соответствии с условиями Регламента оказания брокерских услуг АО \x22Россельхозбанк\x22 направляем Вам уведомление о результатах тестирования в целях совершения (заключения) сделок (договоров) со сложными финансовыми инструментами, требующими проведения тестирования физического лица, не признанного квалифицированным инвестором. ",
                            "\n",
                            "\nТелефоны поддержки клиентов 8 (800) 100-40-40; +7 (495) 651-60-91",
                            "\n",
                            "\nДанное письмо было отправлено автоматически.\n\n ");
         Attachement_name = "";
      elif (mess_kind == EXCLUSION_QI)
         Subject = "Уведомление о праве подачи заявления на исключение из реестра квалифицированных инвесторов. " + Numberdbo + "_" + NameBO;
         Emailtext = String("Добрый день!",
                            "\n",
                            "\nВ соответствии с условиями Регламента оказания брокерских услуг АО \x22Россельхозбанк\x22, Регламента принятия решения о признании лица квалифицированным инвестором в АО \x22Россельхозбанк\x22 направляем Вам уведомление о праве подачи заявления на исключение из реестра квалифицированных инвесторов.",
                            "\n",
                            "\nТелефоны поддержки клиентов 8 (800) 100-40-40; +7 (495) 651-60-91",
                            "\n",
                            "\nДанное письмо было отправлено автоматически.\n\n ");
      elif (mess_kind == INCLUSION_QI)
         Subject = "Уведомление о последствиях признания квалифицированным инвестором. " + Numberdbo + "_" + NameBO;
         Emailtext = String("Добрый день!",
                            "\n",
                            "\nВ соответствии с условиями Регламента оказания брокерских услуг АО \x22Россельхозбанк\x22, Регламента принятия решения о признании лица квалифицированным инвестором в АО \x22Россельхозбанк\x22 направляем Вам уведомление о последствиях признания физического лица квалифицированным инвестором.",
                            "\n",
                            "\nТелефоны поддержки клиентов 8 (800) 100-40-40; +7 (495) 651-60-91",   
                            "\n",
                            "\nДанное письмо было отправлено автоматически.\n\n ");
      else
         // лишнее дожно фильтроваться раньше, но проверку добавим
         runerror("Неизвестный тип сообщения по квал.инвестору: "+mess_kind);
      end;

      v_email_processor = c_email_proc_env();
      v_email_processor.m_add_email_to_list(Eml);
      v_email_processor.m_set_msg_head(Subject);
      v_email_processor.m_add_attach_to_list(mess);
      if (strlen(trim(Attachement_name)) != 0)
         v_email_processor.m_add_attach_to_list(Attachement_name);
      end;
      v_email_processor.m_add_row_to_msg_text(emailText);
      // Сохраняем текст письма для отправки плановой процедурой 
      v_email_processor.m_save_to_submit_synch();
      // Отправляем все не отправленные письма
      v_email_processor.m_submit_email_synch();

      if(v_email_processor.m_get_error_status())
         statMes = "Сообщение сформировано, но не отправлено: " + v_email_processor.get_service_msg();
         statsend = 2;
      else
         statMes = "Сообщение отправлено";
         statsend = 1;
      end;
   end;
   
   // сохранить сообщение в образах
   macro ReForm()
      var v_msg = "", sqls, rsdc;
//      RslDefCon.BeginTrans();
      sqls = String( 
                     "DECLARE   \n"
                    ,"   v_dlId Ddlcontr_Dbt.t_Dlcontrid%TYPE := :p_dlId;   \n"
                    ,"   v_Snd_St NUMBER(5) := :p_Snd_St;   \n"
                    ,"   v_kind NUMBER(5) := :p_kind;   \n"
                    ,"   v_Err    VARCHAR2(2000);   \n"
                    ,"   v_Msg    Ddlcontrmsg_Dbt.t_Id%TYPE;   \n"
                    ,"   Ex_Er EXCEPTION;   \n"
                    ,"BEGIN   \n"
                    ,"   BEGIN   \n"
                    ,"      IF v_dlId IS NOT NULL THEN   \n"
                    ,"         INSERT INTO Ddlcontrmsg_Dbt   \n"
                    ,"            (t_Dlcontrid, t_Kind, t_Createdate, t_Createtime, t_Senddate, t_Sendtime)   \n"
                    ,"         VALUES   \n"
                    ,"            (v_dlId   \n"
                    ,"            ,v_kind   \n"
                    ,"            ,Trunc(SYSDATE)   \n"
                    ,"            ,To_Date('01010001 ' || To_Char(SYSDATE, 'HH24MISS'), 'DDMMYYYY HH24MISS')   \n"
                    ,"            ,CASE v_Snd_St   \n"
                    ,"                WHEN 1 THEN   \n"
                    ,"                 Trunc(SYSDATE)   \n"
                    ,"                ELSE   \n"
                    ,"                 NULL   \n"
                    ,"             END   \n"
                    ,"            ,CASE v_Snd_St   \n"
                    ,"                WHEN 1 THEN   \n"
                    ,"                 To_Date('01010001 ' || To_Char(SYSDATE, 'HH24MISS'), 'DDMMYYYY HH24MISS')   \n"
                    ,"                ELSE   \n"
                    ,"                 NULL   \n"
                    ,"             END)   \n"
                    ,"         RETURNING t_Id INTO v_Msg;   \n"
                    ,"      END IF;   \n"
                    ,"   EXCEPTION   \n"
                    ,"      WHEN OTHERS THEN   \n"
                    ,"         v_Err := Nvl(v_Err, Dbms_Utility.Format_Error_Stack || ' ' || Dbms_Utility.Format_Error_Backtrace);   \n"
                    ,"         v_Msg := NULL;   \n"
                    ,"   END;   \n"
                    ,"   :p_Msg := Lpad(v_Msg, 34, '0');   \n"
                    ,"   :p_Err := v_Err;   \n"
                    ,"END;   \n"
                   );
      rsdc = rsdcommand(sqls);
      rsdc.AddParam("p_dlid", RSDBP_IN, ddl_id);
      rsdc.AddParam("p_snd_st", RSDBP_IN, statsend);
      rsdc.AddParam("p_kind", RSDBP_IN, mess_kind);
      rsdc.AddParam("p_Msg", RSDBP_OUT, v_string, 50);
      rsdc.AddParam("p_Err", RSDBP_OUT, v_string, 2000);
      rsdc.execute;
      v_msg = rsdc.Value("p_err");   
      if ((v_Msg != null) and (v_msg != nullval))
         runerror(v_msg, v_Msg);
      end;
      v_msg = rsdc.Value("p_Msg");   
      msgid = v_msg;
      rsdc = null;
      if (not LoadImageObj(Mess, 208, v_Msg, 1))
         v_Msg = "К записи о сообщении не удалось прикрепить файл сообщения";
         runerror(v_msg, v_Msg);
      end;
/*      if (RslDefCon.IsInTrans())
         RslDefCon.CommitTrans();
      end;        */
   onError(e)
      rsdc = null;
      statsend = 3;
/*      if (RslDefCon.IsInTrans())
         RslDefCon.RollbackTrans();
      end; */                 
      if ((e.Err != null) and (e.Err != nullval))
         statMes = e.Err;
      else        
         statMes = e.Message;
      end; 
   end;   
   
   // создать сообщение
   macro CreateMessage(reformMessage, sendEmail, isgood, text_mess)
      var FileFrom, FileFromPDF, FileFromDOC; 

      macro remove_tmp()
         RemoveFile(FileFromDOC);
         if (pdfSaveStat) // удаление pdf
            RemoveFile(FileFromPDF);
         end;
      end;
      
      if (not reformMessage) 
         reformMessage = false;
      end;
      if (not sendEmail) 
         sendEmail = false;
      end;
      
      if (not isgood)
         isgood = false;
      end;

      if (text_mess)
         TestQIName = text_mess.groupname;
         test_num = text_mess.Code;
      end;

      if (not test_num)
         test_num = "0";
      end;
      
      if (mess_kind == TEST_QI)
         if (isgood)
            TemplName = "QITestResult_good" + w_ext;
         else
            TemplName = "QITestResult_bad" + w_ext;
         end;
      elif (mess_kind == EXCLUSION_QI)
         TemplName = "QIExclusion" + w_ext;
      elif (mess_kind == INCLUSION_QI)
         TemplName = "QIInclusion" + w_ext;
      else 
         runerror("Неизвестный тип сообщения по квал.инвестору: "+mess_kind);
      end;

      if (not isExistsMessage or reformMessage)
/*         statMes = CreateNotification();

         // локальный путь для трехзвенки
         FileFromDOC = fnam4copy(Mess);
         FileFromPDF = fnam4copy(MessPDF); 
         
         if (strlen(trim(statMes)) > 0)
            runerror("Ошибка формирования уведомления", "Ошибка формирования сообщения " + FormFilename + " " + statMes);
         end;
         MakeDir(string(PATH_OUT, FolderName));

         if( false /*pdfSaveStat */ ) /*pdf работает, но отключен до тех пор, пока не научимся хорошо нумеровать Уведомления*/
            FileFrom = FileFromPDF;
            Mess = string(PATH_OUT, FolderName, FormFilenamePDF);
         else
            FileFrom = FileFromDOC;
            Mess = string(PATH_OUT, FolderName, FormFilename);
         end;
         
         // перенос файла
         if (not CopyFile(FileFrom, Mess))
            runerror("Ошибка формирования уведомления", "Не удалось скопировать файл " + FormFilename + " в директорию " + string(PATH_OUT, FolderName));
         end;

         // удаление временных
         remove_tmp();*/
         
         CreateNotification_byRep();

         // отправка уведомления
         if (sendEmail)
            SendNotification(); 
         else
            statsend = 2;
         end;
         ReForm();

      else
         if (sendEmail)
            getMessageNameInDB();
            Mess = string(PATH_OUT, FolderName, FormFilename);
            SendNotification();
         end;
      end;
      
      return this;
   onerror(e)   
      if ((e.Err != null) and (e.Err != nullval))
         statMes = e.Err;
      else   
         statMes = e.Message;
      end;   
      statsend = -1;
      // удаление временных
      remove_tmp();
      return this;
   end;

   macro FixUQIAccreditation(p_Accreditation, p_transparent_id)
      var sqls, rsdc;
      var v_err;
      sqls = String( 
                     "DECLARE   \n"
                    ,"   v_partyid number(10) := :p_partyid;   \n"
                    ,"   v_kind number(10) := :p_kind;   \n"
                    ,"   v_send_date date;   \n"
                    ,"   v_send_result VARCHAR2(200);   \n"
                    ,"   v_dlcontrid number(10) := :p_dlcontrid;   \n"
                    ,"   v_msgid number(10) := :p_msgid;   \n"
                    ,"   v_statsend number(10) := :p_statsend;   \n"
                    ,"   v_statmes varchar2(200) := :p_statmes;   \n"
                    ,"   v_accred_date date := :p_accred_date;   \n"
                    ,"   v_accred_code VARCHAR2(200) := :p_accred_code;   \n"
                    ,"   v_accred_result VARCHAR2(200) := :p_accred_result;   \n"
                    ,"   v_jmsmessageid varchar2(200) := :p_jmsmessageid;   \n"
                    ,"   v_ekk varchar2(64);   \n"
                    ,"   v_id number(10);   \n"
                    ,"   v_Err    VARCHAR2(2000);   \n"
                    ,"BEGIN   \n"
                    ,"   BEGIN   \n"
                    ,"      IF v_dlcontrid IS NOT NULL THEN   \n"
                    ,"        BEGIN \n"
                    ,"           select t_code into v_ekk \n"
                    ,"             from ddlobjcode_dbt  \n"
                    ,"            where t_objecttype = 207 and t_codekind = 1 and t_objectid = v_dlcontrid \n"
                    ,"              and t_bankclosedate = to_date('01010001','ddmmyyyy'); \n"
                    ,"        EXCEPTION \n"
                    ,"           WHEN no_data_found then v_ekk := chr(1); \n"
                    ,"        END; \n"
                    ,"        IF v_statsend = 1 then  \n"
                    ,"          BEGIN \n"
                    ,"             select nvl(m.t_senddate,to_date('01010001','ddmmyyyy')) into v_send_date \n"
                    ,"               from ddlcontrmsg_dbt m \n"
                    ,"              where m.t_id = v_msgid; \n"
                    ,"             if v_send_date > to_date('01010001','ddmmyyyy') then \n"
                    ,"                 v_send_result := 'Отправлено'; \n"
                    ,"             else \n"
                    ,"                 v_send_result := 'Не отправлено'; \n"
                    ,"             end if; \n"
                    ,"          EXCEPTION \n"
                    ,"             WHEN no_data_found then v_send_date := null; \n"
                    ,"                                     v_send_result := Nvl(v_Err, Dbms_Utility.Format_Error_Stack || ' ' || Dbms_Utility.Format_Error_Backtrace); \n"
                    ,"          END; \n"
                    ,"        ELSE \n"
                    ,"          v_send_date := null; \n"
                    ,"          v_send_result := v_statmes; \n"
                    ,"        END IF; \n"   
                    ,"        INSERT INTO uqiaccreditation_dbt   \n"
                    ,"            ( t_id, t_partyid, t_kind, t_ekk, t_accred_date, t_accred_code, \n"
                    ,"              t_accred_result, t_send_date, t_send_status, t_send_result, t_dlcontrid, t_msgid, t_jmsmessageid) \n"
                    ,"         VALUES   \n"
                    ,"            (0 \n"
                    ,"            ,v_partyid   \n"
                    ,"            ,v_kind   \n"
                    ,"            ,v_ekk   \n"
                    ,"            ,v_accred_date   \n"
                    ,"            ,v_accred_code   \n"
                    ,"            ,v_accred_result   \n"
                    ,"            ,v_send_date   \n"
                    ,"            ,v_statsend   \n"
                    ,"            ,v_send_result   \n"
                    ,"            ,v_dlcontrid \n"
                    ,"            ,v_msgid \n"
                    ,"            ,v_jmsmessageid)   \n"
                    ,"         RETURNING t_Id INTO v_id;   \n"
                    ,"      END IF;   \n"
                    ,"   EXCEPTION   \n"
                    ,"      WHEN OTHERS THEN   \n"
                    ,"         v_Err := Nvl(v_Err, Dbms_Utility.Format_Error_Stack || ' ' || Dbms_Utility.Format_Error_Backtrace);   \n"
                    ,"         v_id := NULL;   \n"
                    ,"   END;   \n"
                    ,"   :p_id := v_id;   \n"
                    ,"   :p_Err := v_Err;   \n"
                    ,"END;   \n"
                   );
      rsdc = rsdcommand(sqls);
      rsdc.AddParam("p_partyid", RSDBP_IN, PartyId);
      rsdc.AddParam("p_kind", RSDBP_IN, mess_kind);
      rsdc.AddParam("p_dlcontrid", RSDBP_IN, ddl_id);
      rsdc.AddParam("p_msgid", RSDBP_IN, msgid);
      rsdc.AddParam("p_statsend", RSDBP_IN, statsend);
      rsdc.AddParam("p_statmes", RSDBP_IN, statMes);
      
      if (ValTYpe(p_Accreditation) == V_GENOBJ)
         rsdc.AddParam("p_accred_date", RSDBP_IN, p_Accreditation.Date_acc);
         rsdc.AddParam("p_accred_code", RSDBP_IN, p_Accreditation.Code);
         if (p_Accreditation.IsSuccess)
            rsdc.AddParam("p_accred_result", RSDBP_IN, "Успешно");
         else
            rsdc.AddParam("p_accred_result", RSDBP_IN, "Не успешно");
         end;
      else
         rsdc.AddParam("p_accred_date", RSDBP_IN, null);
         rsdc.AddParam("p_accred_code", RSDBP_IN, null);
         rsdc.AddParam("p_accred_result", RSDBP_IN, null);
      end;
      
      if (p_transparent_id)
         rsdc.AddParam("p_jmsmessageid", RSDBP_IN, p_transparent_id);
      else 
         rsdc.AddParam("p_jmsmessageid", RSDBP_IN, null);
      end;
      
      rsdc.AddParam("p_id", RSDBP_OUT, v_string, 50);
      rsdc.AddParam("p_Err", RSDBP_OUT, v_string, 2000);
      rsdc.execute;
      v_err = rsdc.Value("p_Err");
      if ((v_err != null) and (v_err != nullval))
         runerror(v_err, v_err);
      end;
      id_uqi = rsdc.Value("p_id");   
      rsdc = null;
      statfix = 0;
      fixmes = "OK";

      return this;
   onerror(e)
      statfix = e.code;
      fixmes = e.message + getFullCmdErrorText(rsdc);
      return this;
   end;

   macro UpdateUQIAccreditation(p_id)
      var sqls, rsdc;
      var v_err;
      sqls = String( 
                     "DECLARE   \n"
                    ,"   v_send_date date;   \n"
                    ,"   v_send_result VARCHAR2(200);   \n"
                    ,"   v_statsend number(10) := :p_statsend;   \n"
                    ,"   v_statmes varchar2(200) := :p_statmes;   \n"
                    ,"   v_msgid number(10) := :p_msgid;   \n"
                    ,"   v_id number(10) := :p_id;   \n"
                    ,"   v_Err    VARCHAR2(2000);   \n"
                    ,"BEGIN   \n"
                    ,"   BEGIN   \n"
                    ,"      IF v_statsend = 1 then  \n"
                    ,"        BEGIN \n"
                    ,"           select nvl(m.t_senddate,to_date('01010001','ddmmyyyy')) into v_send_date \n"
                    ,"             from ddlcontrmsg_dbt m \n"
                    ,"            where m.t_id = v_msgid; \n"
                    ,"           if v_send_date > to_date('01010001','ddmmyyyy') then \n"
                    ,"               v_send_result := 'Отправлено'; \n"
                    ,"           else \n"
                    ,"               v_send_result := 'Не отправлено'; \n"
                    ,"           end if; \n"
                    ,"        EXCEPTION \n"
                    ,"           WHEN no_data_found then v_send_date := null; \n"
                    ,"                                   v_send_result := Nvl(v_Err, Dbms_Utility.Format_Error_Stack || ' ' || Dbms_Utility.Format_Error_Backtrace); \n"
                    ,"        END; \n"
                    ,"      ELSE \n"
                    ,"        v_send_date := null; \n"
                    ,"        v_send_result := v_statmes; \n"
                    ,"      END IF; \n"   
                    ,"      INSERT INTO UQIACCREDITATION_STEP_DBT (T_STEPID, T_ACCREDID, T_TIMESTAMP, T_STATUS, T_COMMENT) \n"
                    ,"      VALUES (0, v_id, sysdate, v_statsend, v_send_result); \n"
                    ,"      UPDATE uqiaccreditation_dbt   \n"
                    ,"         SET t_send_date = v_send_date, t_send_status = v_statsend, t_send_result = v_send_result  \n"
                    ,"       WHERE t_id = v_id; \n"
                    ,"   EXCEPTION   \n"
                    ,"      WHEN OTHERS THEN   \n"
                    ,"         v_Err := Nvl(v_Err, Dbms_Utility.Format_Error_Stack || ' ' || Dbms_Utility.Format_Error_Backtrace);   \n"
                    ,"   END;   \n"
                    ,"   :p_Err := v_Err;   \n"
                    ,"END;   \n"
                   );
      rsdc = rsdcommand(sqls);
      rsdc.AddParam("p_statsend", RSDBP_IN, statsend);
      rsdc.AddParam("p_statmes", RSDBP_IN, statMes);
      rsdc.AddParam("p_msgid", RSDBP_IN, msgid);
      rsdc.AddParam("p_id", RSDBP_IN, p_id);
      rsdc.AddParam("p_Err", RSDBP_OUT, v_string, 2000);
      rsdc.execute;
      v_err = rsdc.Value("p_Err");
      if ((v_err != null) and (v_err != nullval))
         runerror(v_err, v_err);
      end;
      rsdc = null;
      statfix = 0;
      fixmes = "OK";

      return this;
   onerror(e)
      statfix = e.code;
      fixmes = e.message + getFullCmdErrorText(rsdc);
      return this;
   end;


   constructor();
end;

// действующий ДБО клиента с наименьшим значением поля "Дата открытия"
// если 2 договора открыты в один день, то с меньшим ddlcontr_dbt.t_dlcontrid (в скроллинге ДБО порядок такой)
macro FindFirstContract(_partyid, _repdate)
   var res = -1;
   var sql_str, cmd, rs;

   sql_str = " select dl.t_dlcontrid, sf.* "+ 
             "   from ddlcontr_dbt dl, "+
             "        dsfcontr_dbt sf "+
             "  where dl.t_sfcontrid = sf.t_id "+
             "    and sf.t_partyid = :p "+
             "    and (sf.t_dateclose > :dt1 or sf.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') ) "+
             "    and sf.t_datebegin = (select min(t_datebegin) from dsfcontr_dbt sf1 "+
             "                           where sf1.t_partyid = sf.t_partyid "+
             "                             and (sf1.t_dateclose > :dt2 or sf1.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') ) "+
             "                          ) "+
             "  order by dl.t_dlcontrid ";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("p", RSDBP_IN, _partyid);
   cmd.AddParam("dt1", RSDBP_IN, _repdate);
   cmd.AddParam("dt2", RSDBP_IN, _repdate);
   rs = RSdRecordSet(cmd);
   if (rs.movenext)
      res = rs.value("t_dlcontrid");
   end;

   return res;
end;

macro FindQIInclusionMessage(_partyid, _repdate)
   var sql_str, rs, cmd;
   var res = -1;
   sql_str = "select 1 from dscqinv_dbt qi "+
             " where qi.t_partyid = :partyid "+
             "   and qi.t_state = 1 "+
             "   and qi.t_regdate = :repdate "+
             "   and not exists (select 1 "+
             "                     from ddlcontrmsg_dbt m, "+
             "                          ddlcontr_dbt d, "+
             "                          dsfcontr_dbt s "+
             "                    where m.t_dlcontrid = d.t_dlcontrid "+
             "                    and d.t_sfcontrid = s.t_id  "+
             "                    and s.t_partyid = qi.t_partyid  "+
             "                    and t_kind = :inclusion) ";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("partyid", RSDBP_IN, _partyid);
   cmd.AddParam("repdate", RSDBP_IN, _repdate);
   cmd.AddParam("inclusion", RSDBP_IN, INCLUSION_QI);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      res = rs.value(0);
   end;
   return res;
end;

macro InsEvent_QI(_partyid, _typeaction)
   const CV_TYPE = 5070; /* Тип Отправка уведомления о включении в реестр КИ */

   var v_sql :string = "",
       v_cmd;

   v_sql =         "INSERT INTO uTableProcessEvent_dbt( t_objecttype, t_objectid, t_type, t_status, t_timestamp ) ";
   v_sql = v_sql + " ( SELECT :p_objecttype1,:p_objectid1, :p_typeaction, 1, SYSDATE FROM DUAL ";
   v_sql = v_sql + "   WHERE NOT EXISTS(SELECT t_recid FROM utableprocessevent_dbt ";
   v_sql = v_sql + "                     WHERE t_objecttype = :p_objecttype2 ";
   v_sql = v_sql + "                       AND t_objectid = :p_objectid2 ";
   v_sql = v_sql + "                       AND t_type = :p_typeaction ";
   v_sql = v_sql + "                       AND TRUNC(t_timestamp) = TRUNC(SYSDATE) ";
   v_sql = v_sql + "                       AND t_status IN (1, 2)) ";  /* статус 4 исключаем, так как обновлений может быть несколько. Наверное. */
   v_sql = v_sql + "     AND ROWNUM = 1 ) "; /* На всякий случай */

   v_cmd = RSDCommand(v_sql);
   v_cmd.addParam("p_objecttype1", RSDBP_IN, CV_TYPE);
   v_cmd.addParam("p_objectid1", RSDBP_IN, _partyid);
   v_cmd.addParam("p_typeaction1", RSDBP_IN, _typeaction);
   v_cmd.addParam("p_objecttype2", RSDBP_IN, CV_TYPE);
   v_cmd.addParam("p_objectid2", RSDBP_IN, _partyid);
   v_cmd.addParam("p_typeaction2", RSDBP_IN, _typeaction);
   v_cmd.execute();

   v_cmd.close(); v_cmd = null; v_sql = null;

onError(err)

end;


