/*
$Name:        func_lib.mac
$Module:      Интеграция с внешними системами
$Description: Библиотека общих функций
*/
import rsd, likepy, oralib;
import CTInter;
import ptinter;
import "global_utils_intgr.mac";
import "ws_msg_transform_sec.mac";     /* Инструментарий для преобразования сообщений */
import cb_sql;
import "u_common_email_utils.mac";
import "usr_table_int.mac";
import "global_classes.mac";

const PARTY_CODEKIND_ABS   = 101;
const PARTY_CODEKIND_ABS_RESERV = 1102;
const PARTY_CODEKIND_CIF   = 102;
const PARTY_CODEKIND_MAIN  = 1;  	// заменить на PTCK_CONTR
const PARTY_CODEKIND_LICENSE = 17;      // заменить на PTCK_ORCBLICENSE
const PARTY_CODEKIND_SNILS = 63;
const PARTY_CODEKIND_TAX = 28;          // заменить на PTCK_MNS
const PARTY_CODEKIND_SHORTCODE = 8;     // заменить на PTCK_MICEX
const PARTY_CODEKIND_VTB = 109;         // код клиента ВТБ
const PARTY_CODEKIND_CDI = 110;         // Код AC CDI

const CONTRACT_NOTEKIND_CONS = 150;     // финансовый консультант
const CONTRACT_NOTEKIND_CONDITIONDATE = 170;     // дата изменения данных

const CONTRACT_NOTEKIND_CodeRF = 120;       // Код РФ
const CONTRACT_NOTEKIND_DossierURL = 121;   // Ссылка на досье
const CONTRACT_NOTEKIND_DossierID = 122;   // Идентификатор обобщенного досье в АСОА

// BIQ-7382 Примечания договора БО с информацией от Депозитария
const CONTRACT_NOTEKIND_Depo_Account = 101;           // Счет Депо Владельца
const CONTRACT_NOTEKIND_Depo_ContractNumber = 102;    // Номер договора Депо
const CONTRACT_NOTEKIND_Depo_ContractDate = 103;      // Дата заключения договора Депо
const CONTRACT_NOTEKIND_Depo_TradeAccount = 104;      // Торговый счет Депо
const CONTRACT_NOTEKIND_Depo_AccountPart = 105;       // Раздел счета Депо Владельца
const CONTRACT_NOTEKIND_Depo_TradeAccountPart = 106;  // Раздел Торгового счета Депо
const CONTRACT_NOTEKIND_Depo_VnebAccount = 107;       // Счет Депо для расчетов на внеб. (3-х сторонний договор)
const CONTRACT_NOTEKIND_Depo_VnebAccountPart = 108;   // Раздел счета Депо для расч. на внеб.(3-х сторонний договор)
const CONTRACT_NOTEKIND_Depo_TradeAccountPart_Spb = 115; // Раздел торгового счёта депо СПБ 

const CONTARCT_NOTEKIND_VTB_CONTRACTNUM = 130;
const CONTARCT_NOTEKIND_VTB_CONTRACTDATE = 131;
const CONTARCT_NOTEKIND_DATE_CLOSE_ISANOTHERCONTRACT = 175;
const CONTARCT_NOTEKIND_REASON_UNLOAD_PROHIBIT = 109;


const CONTRACT_CATEGORY_STATUS = 101;   // статус договора БО
const CONTRACT_CATEGORY_TYPEDOSSIER = 120; // тип досье
const CONTRACT_CATEGORY_ISCON = 121; // Сведения о наличии или отсутствии ИИС у другого проф.участника
const CONTRACT_CATEGORY_RISKLEVEL = 103; // Уровень риска клиента
const CONTRACT_CATEGORY_ISQUIK = 170; // тип подключения
const CONTRACT_CATEGORY_ISCURRENTACCOUNTS = 123; // BIQ-7910, true - выплаты на текущий счет, false - выплаты на счет БО
const CONTRACT_CATEGORY_BLOCK_SIGN = 1; // BIQ-8258, признак блокировки
const CONTRACT_CATEGORY_CDI_PARTYTYPE = 150; // тип субъекта в CDI

const SUBCONTRACT_NOTEKIND_MMVBCURRENCY = 102;

const CONTRACT_EMAIL_GRP = 16; 


const ACCOUNT_NOTEKIND_PURPOSE = 112;   // назначение счета Бисквит

const NOTEKIND_USERCODE = 200;

const MASTER_SYSTEMID      = "CIFLE";
const SOFR_SYSTEMID        = "SOFR";

const SERV_SUBKIND_STOCK      = 8;
const SERV_SUBKIND_STOCK_OVER = 9;

const UREFERENCE_PARTY_CODE = 110;
const UREFERENCE_ACC_NUM = 1000008;


const KIND_BROKERCONTRACT  = 1,                             /* Внутренние константы, чтобы классифицировать какого вида договор */
      KIND_SUBCONTRACT     = 2;

// BIQ-7785 Гераськина Т.В. тип пользовательского счета для ЕДП
const USERTYPEACCOUNT_EDP = "Е";  // кириллица chr(133) 

const SUBCONTRACT_CATEGORY_EDP = 102; 

// BIQ-7426 Гераськина Т.В. виды кодов для ЕКК MOEX и SPB
// BIQ-7382
const CODEKIND_DLCONTR_MOEX = 1,
      CODEKIND_DLCONTR_SPB = 2; // пока не определено

// BIQ-7382
const DEPO_UNLOAD_TYPE = "РСХБ\\ИНТЕГРАЦИЯ\\ДЕПОЗИТАРИЙ_ETL";

// BIQ-7785
const DBO_UNLOAD_TYPE = "РСХБ\\ИНТЕГРАЦИЯ\\ДБО_XML";

// BIQ-8786
const CONTRACT_NOTEKIND_TARIFFID_REPO   = 145;
const CONTRACT_NOTEKIND_TARIFFPLAN_REPO = 146;
const CONTRACT_NOTEKIND_BINDDATE_REPO   = 147;

// BIQ-7294
const C_QUEUE_OUT_ID = 2;
const REG_TIMEOUT_SNOB = "COMMON\\СНОБ\\ВРЕМЯ ОТВЕТА ОТ ХРАНИЛИЩА СНОБ";

//BIQ-10268
const REG_CDI_ACTIVE = "РСХБ\\ИНТЕГРАЦИЯ\\ВЗАИМОДЕЙСТВИЕ С AC CDI\\АКТИВНО";
const SERV_CDI_FIND_ORG   = 5053,
      SERV_CDI_GET_ORG    = 5054,
      SERV_CDI_UPDATE_ORG = 5055,
      SERV_CDI_CREATE_ORG = 5056;

macro GetPartyShortName_integr( PartyID : integer ) : string
   var select : string = "select t_ShortName "
                         "  from dparty_dbt "
                         " where t_PartyID = :PartyID";
 
   var params : TArray = TArray();
   params[params.size] = SQLParam( "PartyID", PartyID );
 
   var rset : RsdRecordset = execSQLselect( select, params );
   if( rset AND rset.moveNext() )
      return rset.Value( 0 );
   else
      return "";
   end;
end;

//shev 26.09.2019
macro GetPartyName_integr( PartyID : integer,Party_Name, Length_name ) : string
   var select : string = "select t_Name, length(t_Name) "
                         "  from dparty_dbt "
                         " where t_PartyID = :PartyID";
 
   var params : TArray = TArray();
   params[params.size] = SQLParam( "PartyID", PartyID );
 
   var rset : RsdRecordset = execSQLselect( select, params );
   if( rset AND rset.moveNext() )
      setparm(1,rset.value(0));
      setparm(2,rset.value(1));
   else
      setparm(1,0);
      setparm(2,"");
   end;
end;




// Аналог функции из ws_party.mac 
// Входящие параметры:
//   in_CodeKind - вид кода субъекта
//   in_Code     - код субъекта
//   in_FromDate - дата, на которую определяется значение кода. Необязательный параметр
// Возвращаемый параметр:
//   m_PartyID - ID субъекта. Если субъект не найден, возвращается -1
//                            Если найдено 2 субъекта с одинаковым кодом, возвращается -1
// Примеры: v =  GetPartyID_byPartyCode(101, "0004", date(13,3,2017));
//          v =  GetPartyID_byPartyCode(101, "0004");
macro GetPartyID_byPartyCode
(
  in_CodeKind:integer, 
  in_Code:string,
  in_FromDate:date
)
  var m_PartyID : integer = -1;
  var query, rs;
  var params : TArray;
  query =         "SELECT t_ObjectID ";
  query = query + "  FROM dobjcode_dbt ";
  query = query + " WHERE t_ObjectType = :ObjectType ";
  query = query + "   AND t_CodeKind = :CodeKind ";
  query = query + "   AND t_Code = :Code ";

  if((in_FromDate != null) and (in_FromDate != date(0,0,0)))
    query = query + "   AND t_BankDate <= :FromDate ";
    query = query + "   AND :ToDate < DECODE(t_BankCloseDate, TO_DATE('01010001', 'DDMMYYYY'), TO_DATE('31129999', 'DDMMYYYY'), t_BankCloseDate)";
    params = makeArray(SQLParam("ObjectType", OBJTYPE_PARTY)
                      ,SQLParam("CodeKind"  , in_CodeKind)
                      ,SQLParam("Code"      , in_Code)
                      ,SQLParam("FromDate"  , in_FromDate)
                      ,SQLParam("ToDate"    , in_FromDate)
                      );
  else
    query = query + "   AND t_BankCloseDate = TO_DATE('01010001', 'DDMMYYYY')";
    params = makeArray(SQLParam("ObjectType", OBJTYPE_PARTY)
                      ,SQLParam("CodeKind"  , in_CodeKind)
                      ,SQLParam("Code"      , in_Code)
                      );
  end;

  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    m_PartyID = rs.value(0);
    if(rs.moveNext())
      m_PartyID = -1;
    end;
  end;                         
  rs.close(); rs = null; query = null;

  return m_PartyID;
end;


// получение кода субъекта
// прямое обращение к базе
macro GetPartyCode_ByNumber(in_partyid, in_codekind, out_bankdate)
  var mCode : string = "";
  var query, rs;
  var params : TArray;
  query =         "SELECT t_Code, t_bankdate ";
  query = query + "  FROM dobjcode_dbt ";
  query = query + " WHERE t_ObjectType = :ObjectType ";
  query = query + "   AND t_CodeKind = :CodeKind ";
  query = query + "   AND t_ObjectID = :ObjectID ";
  query = query + "   AND t_BankCloseDate = TO_DATE('01010001', 'DDMMYYYY')";
  params = makeArray( SQLParam("ObjectType", OBJTYPE_PARTY)
                     ,SQLParam("CodeKind"  , in_codekind)
                     ,SQLParam("ObjectID"  , in_partyid)
                     );
  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext()) // если множественный, значит, первый по порядку
    mCode = rs.value(0);
    SetParm(2,rs.value(1));
  end;
  rs.close(); rs = null; query = null;

  return mCode;
end;

// получение кода объекта
// прямое обращение к базе
macro GetObjCode_ByObjectid(in_objectid, in_objecttype, in_codekind)
  var mCode : string = "";
  var query, rs;
  var params : TArray;
  query =         "SELECT t_Code ";
  query = query + "  FROM dobjcode_dbt ";
  query = query + " WHERE t_ObjectType = :ObjectType ";
  query = query + "   AND t_CodeKind = :CodeKind ";
  query = query + "   AND t_ObjectID = :ObjectID ";
  query = query + "   AND t_BankCloseDate = TO_DATE('01010001', 'DDMMYYYY')";
  params = makeArray( SQLParam("ObjectType", in_objecttype)
                     ,SQLParam("CodeKind"  , in_codekind)
                     ,SQLParam("ObjectID"  , in_objectid)
                     );
  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext()) // если множественный, значит, первый по порядку
    mCode = rs.value(0);
  end;
  rs.close(); rs = null; query = null;

  return mCode;
end;

macro GetObjAttrNameObject_byName(objectType, groupID, name): String
  var result = null;
  
  var cmd = RSDCommand("SELECT oa.t_nameObject " +
                         "FROM  dObjAttr_dbt oa " +
                        "WHERE oa.t_objectType = :objectType " +
                          "AND oa.t_groupID = :groupID " +
                          "AND oa.t_Name = :name");
  cmd.AddParam("objectType", RSDBP_IN, objectType);
  cmd.AddParam("groupID", RSDBP_IN, groupID);
  cmd.AddParam("name", RSDBP_IN, name);
  
  var rs = RSDRecordset(cmd);
  
  if (rs.MoveNext())
    result = rs.Value("t_nameObject");
  end;
  
  return result;
OnError(err)
  return null;
end;

// Получение идентификатора тарифа "Базовый"
// если не найден - возвращает 0
macro FindBasicTarif()
   var sql_str, rs, cmd;
   var res = 0;
   
   sql_str = "select t_sfplanid from dsfplan_dbt where upper(t_name) = 'БАЗОВЫЙ'";
   rs = RSDRecordSet(sql_str);
   if (rs.movenext)
      res = rs.value("t_sfplanid");
   end;
   rs.close; rs = null;
   return res;
end;

// пользовательская обработка NULL
macro usr_nvlx(_value)
   var res;
   if ( (ValType(_value) == V_UNDEF) or (ValType(_value) == 26) or (_value == NULL) or (_value == StrFor(1)) or (_value == StrFor(0)) )
      res = "";
   else
      res = _value;
   end;
   return res;
end;

// Получение региона по его коду ОКАТО
macro GetRegionCode(_code)
   var sql_str, rs, cmd;
   var temp_str = "";
   var res = "";
   
   sql_str = "select t_coderegion, t_nameregion, t_okato from dptregion_dbt where lpad(t_okato,5,'0') = :code";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("code", RSDBP_IN, _code);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      res = rs.value("t_nameregion");
      SetParm(1, rs.value("t_coderegion"));
      SetParm(2, rs.value("t_okato"));
   end;

   rs.close; cmd.close; rs = null; cmd = null;
   return res;
end;

// Получение региона по его коду (согласно ФНС)
macro GetRegionCode_ByCode(_code)
   var sql_str, rs, cmd;
   var temp_str = "";
   var res = "";
   
   sql_str = "select t_coderegion, t_nameregion, t_okato from dptregion_dbt where t_coderegion = :code";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("code", RSDBP_IN, _code);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      res = rs.value("t_nameregion");
      SetParm(1, rs.value("t_coderegion"));
      SetParm(2, rs.value("t_okato"));
   end;

   rs.close; cmd.close; rs = null; cmd = null;
   return res;
end;

// код административной единицы
macro GetCodeAdmUnit(_str, _type)
   var sql_str, rs, cmd;
   var temp_str = "", temp_str_orig = "";
   var res = "";
   var sstr = StrUpr(_str);
   var clear_str = _str;
   var pos = 0;
   
   if (_type == "CITY")
      sql_str = "select Upper(t_place) t_place, t_place t_place_orig from dadmterr_dbt where t_districtlevel = 'X'";
   elif (_type == "PLACE")
      sql_str = "select Upper(t_place) t_place, t_place t_place_orig from dadmterr_dbt where t_placelevel = 'X'";
   elif (_type == "PROVINCE")
      sql_str = "select Upper(t_place) t_place, t_place t_place_orig from dadmterr_dbt where t_provincelevel = 'X'";
   elif (_type == "STREET")
      sql_str = "select Upper(t_place) t_place, t_place t_place_orig from dadmterr_dbt where t_streetlevel = 'X'";
   elif (_type == "REGION")
      sql_str = "select Upper(t_place) t_place, t_place t_place_orig from dadmterr_dbt where t_regionlevel = 'X'";
   else
      sql_str = "";
   end;
   
   if (sql_str)
      rs = RSDRecordSet(sql_str);
      while (rs.movenext)
         temp_str = rs.value("t_place")+" ";
         temp_str_orig =  rs.value("t_place_orig")+" ";
         pos = Index(sstr, temp_str);
         if ( pos > 0)
            res = trim(temp_str_orig);
            clear_str = StrSubst(clear_str, temp_str, "");
            clear_str = StrSubst(clear_str, temp_str_orig, "");
            break; 
         else
            temp_str = " " + rs.value("t_place");
            temp_str_orig = " " + rs.value("t_place_orig");
            if (Index(sstr, temp_str) > 0)
               res = trim(temp_str_orig);
               clear_str = StrSubst(clear_str, temp_str, "");
               clear_str = StrSubst(clear_str, temp_str_orig, "");
               break;
            end;
         end;
      end;
   end;
   
   rs.close; rs = null;
   //Setparm(0,clear_str);  есть проблема с областями + есть вероятность порезать лишнее в имени города
   return res;
end;

// аналог функции из addr_ref.mac
// входной параметр - класс адреса TWsAdres (ws_party_lib)
macro usr_GenResultAddressUser(AddressRec)
  var Result:string = "";   // <PostIndex>,<Region>,<Province>,<District>,<Place>,<Street>,<House>,<<NumCorps>,<Flat>
  
  Result = Result + usr_nvlx(AddressRec.PostIndex);
  Result = Result + ",";
  
  if( ValType(AddressRec.Region) != V_UNDEF )
    Result = Result + AddressRec.Region ;//+ " " + usr_nvlx(AddressRec.CodeRegion);
  end;
  Result = Result + ",";
  
  if( ValType(AddressRec.Province) != V_UNDEF )
    Result = Result + AddressRec.Province ;//+ " " + usr_nvlx(AddressRec.CodeProvince);
  end;
  Result = Result + ",";
  
  if( ValType(AddressRec.District) != V_UNDEF )
    Result = Result + AddressRec.District ;//+ " " + usr_nvlx(AddressRec.CodeDistrict);
  end;
  Result = Result + ",";
  
  if( ValType(AddressRec.Place) != V_UNDEF )
    Result = Result + AddressRec.Place ;//+ " " + usr_nvlx(AddressRec.CodePlace);
  end;
  Result = Result + ",";
  
  if( ValType(AddressRec.Street) != V_UNDEF )
    Result = Result + AddressRec.Street ;//+ " " + usr_nvlx(AddressRec.CodeStreet);
  end;
  Result = Result + ",";
  
  if( ValType(AddressRec.House) != V_UNDEF )
    Result = Result + AddressRec.House;
  end;
  Result = Result + ",";
  
  if( ValType(AddressRec.NumCorps) != V_UNDEF )
    Result = Result + AddressRec.NumCorps;
  end;
  
  if( ValType(AddressRec.Flat) != V_UNDEF )
    Result = Result + ", " + AddressRec.Flat;
  end;

  return Result;
end;


/* Поиск договора по номеру и id клиента */
macro UsrSec_GetContract_byNum4Clnt(in_cntr_num, in_client_id)
   var ret = -1;
   var sql, cmd, rs;

   sql =       "SELECT cntr.t_id ";
   sql = sql + "  FROM dsfcontr_dbt cntr ";
   sql = sql + " WHERE cntr.t_partyid = :p_client_id ";
   sql = sql + "   AND cntr.t_number = :p_cntr_num ";
   sql = sql + "   AND cntr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') ";

   cmd = RSDCommand(sql);
   cmd.addParam("p_client_id", RSDBP_IN, in_client_id);
   cmd.addParam("p_cntr_num", RSDBP_IN, in_cntr_num);

   rs = RSDRecordSet(cmd);
   if(rs.movenext())
      ret = rs.value("t_id");
   end;

   rs.close(); cmd.close(); rs = null; cmd = null; sql = null;

   return ret;
end;

// Поиск субъекта по строковому partyid
macro GetPartyID_byStringPartyID
(
  in_partyid:string
)
  var m_PartyID = -1;
  var query, rs;
  var params : TArray;
  query =         "SELECT t_PartyID ";
  query = query + "  FROM dparty_dbt ";
  query = query + " WHERE t_PartyID = to_number(:PartyID)";
  params = makeArray(SQLParam("PartyID", in_partyid));
  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    m_PartyID = rs.value(0);
  end;
  rs.close(); rs = null; query = null;

  return m_PartyID;
onError(e)
   // если входящий параметр не похож на число
   return -1;
end;

// Поиск даты рождения субъекта по partyid
macro GetBirthDay_byPartyID
(
  in_partyid:integer
)
  var m_BirthDay = date("00.00.00");
  var query, rs;
  var params : TArray;
  query = " SELECT T_BORN FROM dpersn_dbt " +
          " WHERE T_PERSONID = :PartyID ";

  params = makeArray(SQLParam("PartyID", in_partyid));
  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    m_BirthDay = rs.value(0);
  end;
  rs.close(); rs = null; query = null;

  return m_BirthDay;
onError(e)
   return date("00.00.00");
end;

// Формирование кода с решетками      
macro MakeCodeABS(_code_value_number, _filial, _kind_client)
  var num_filial, type_client, code_value;

  if (ValType(_filial) != V_UNDEF)
     num_filial = substr(_filial,1,2);
  else
     num_filial = "00";
  end;
  if (_kind_client == 1)   // ЮЛ
     type_client = "Y";
  elif (_kind_client == 2) // Банк
     type_client = "Б";
  elif (_kind_client == 3) // ИП
     type_client = "P";
  end;
  code_value = String(num_filial,"#",type_client,"#",_code_value_number);
  return code_value;

end;

// получение кода национальной валюты
macro GetFiCodeNatCur()
  var fi_code = "-1";
  var query, rs;
  var params : TArray;
  query =         "SELECT t_fi_code ";
  query = query + "  FROM dfininstr_dbt ";
  query = query + " WHERE t_FIID = 0";
  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    fi_code = rs.value(0);
  end;
  rs.close(); rs = null; query = null;

  return fi_code;
end;

// Получение БИКа/СВИФТа (что найдется первым) по наименованию филиала
macro GetBankCode(_num)
  var bankcode = "";
  var bankcodekind = 0;
  var query, rs;
  var params : TArray;
  query =         "SELECT objcode.t_codekind, objcode.t_code ";
  query = query + "  FROM dobjcode_dbt objcode, ";
  query = query + "       dparty_dbt party, ";
  query = query + "       ddp_dep_dbt dep ";
  query = query + " WHERE objcode.t_objecttype = 3 and objcode.t_codekind in ( 3,6 ) and objcode.t_objectid = dep.t_partyid";
  query = query + "   AND party.t_partyid = dep.t_partyid";
  query = query + "   AND dep.t_name = :n;";
  params = makeArray(SQLParam("n", _num));
  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    bankcode = rs.value("t_code");
    bankcodekind = rs.value("t_codekind");
  end;
  rs.close(); rs = null; query = null;

  SetParm(1,bankcodekind);
  return bankcode;
end;

// Получение кода филиала по его названию
macro GetFilialCode(_name)
  var code = 1;
  var query, rs;
  var params : TArray;
  if ( (_name == "00") or (_name == "0000") )
      code = 1;
  else
     query =         "SELECT dep.t_code ";
     query = query + "  FROM ddp_dep_dbt dep ";
     query = query + " WHERE dep.t_name = :n";
     params = makeArray(SQLParam("n", _name));
     rs = execSQLselect(query, params, true);
     if(rs and rs.moveNext())
       code = rs.value("t_code");
     end;
     rs.close(); rs = null; query = null;
  end;
  return code;
end;

// Получаение кода филиала по номеру брокерского договора 
macro GetNumFilialBy_AgreementNumber(_AgreementNumber)
   var pos, tmp_str;
   var res = 1;
   var v_AgreementNumber = StrSubst(_AgreementNumber,"-ИИС","");

   pos = Index(_AgreementNumber,"-");
   if ( (pos > 0) and (pos < 8) ) // защита от дефисов в середине номера
      tmp_str = SubStr(_AgreementNumber,1,2);  // формат 01-50001 или 00/01-50001 
      tmp_str = tmp_str + "00";
      res = GetFilialCode(tmp_str);
   else
      res = 1;   // ГО
   end;
   if (res == 1)
      SetParm(1, "0000");
   else
      SetParm(1, tmp_str);
   end;
   
   return res;
end;

// Установить уровень риска и его обоснование для субъекта
macro SetRiskLevel(_partyid, _RiskLevel, _RiskReason)
   var sql_str, cmd;
   var RiskLevel, RiskReason;
   
   if (StrUpr(_RiskLevel) == "ОБЫЧНЫЙ")
      RiskLevel = 1;
   else
      RiskLevel = 2;
   end;
   
   if (_RiskReason)
      RiskReason = _RiskReason;
   else
      RiskReason = " ";
   end;
   
   sql_str = "Insert into DPTRISKLEVEL_DBT "+
             "  (T_PARTYID, T_BEGINDATE, T_RISKLEVEL, T_ISFORCED, T_OPER, T_GROUND) "+
             " Values "+
             "  (:partyid, sysdate, :RiskLevel, chr(0), :oper, :ground) ";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("partyid", RSDBP_IN, _partyid);
   cmd.AddParam("RiskLevel", RSDBP_IN, RiskLevel);
   cmd.AddParam("oper", RSDBP_IN, {oper});
   cmd.AddParam("ground", RSDBP_IN, RiskReason);
   cmd.execute;
   
   cmd = NULL;
   
end;

/* Принадлежность субъекта */
macro SetPartyOwn(p_PartyID, p_partykind)
   var sql_str, cmd;
   sql_str = " declare "+
             "      vcnt number := 0; "+
             "      vpartyid number := :partyid; "+
             "      vpartykind number := :partykind; "+
             " begin "+
             "      select count(*) cnt  into vcnt  "+
             "       from dpartyown_dbt where t_partyid = vpartyid and t_partykind = vpartykind; "+
             "     if vcnt = 0 then "+
             "          insert into dpartyown_dbt "+
             "          values(vpartyid, vpartykind, 0,0,0,0); "+
             "     end if; "+
             " end; ";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("partyid", RSDBP_IN, p_PartyID);
   cmd.AddParam("partykind", RSDBP_IN, p_partykind);
   cmd.execute;   
end;


/* Выгодоприобретатель */
macro SetBeneficiary(_partyid, _beneficiaryid, _begindate, _enddate)
   var sql_str, cmd;

   sql_str = " declare "+
             "      vcnt number := 0; "+
             "      vpartyid number := :partyid; "+
             "      vbeneficiaryid number := :beneficiaryid; "+
             "      voper number := :oper; "+
             "      vbegdate date := :begindate; "+
             "      venddate date := :enddate; "+
             "      vdate date := :dt; "+
             "      vtime date := :tm; "+
             "      EMPTY_DATE date := TO_DATE('01/01/0001 00:00:00', 'MM/DD/YYYY HH24:MI:SS'); "+
             " begin "+   
             "     select count(*) cnt  into vcnt  "+
             "       from dptbeneficiary_dbt where t_partyid = vpartyid and t_beneficiaryid = vbeneficiaryid; "+
             "     if vcnt = 0 then "+
             "        Insert into DPTBENEFICIARY_DBT "+
             "          (  T_ID, T_PARTYID, T_BENEFICIARYID, T_GROUNDDOCKIND, T_GROUNDDOCNUMBER, T_GROUNDDOCDATE, "+
             "             T_GROUNDDOCVALIDITY, T_COMMENT, T_BEGINDATE, T_ENDDATE, T_IDENTRENEWDATE, T_NOTCOMPLETEIDENT, "+
             "             T_INPUTSYSDATE, T_INPUTSYSTIME, T_INPUTOPER, T_LASTEDITSYSDATE, T_LASTEDITSYSTIME, T_LASTEDITOPER) "+
             "        Values "+
             "          (  0, vpartyid, vbeneficiaryid, 0, chr(1), EMPTY_DATE, "+
             "             EMPTY_DATE, chr(1), vbegdate, venddate, EMPTY_DATE, chr(0), "+
             "             vdate, vtime, voper, EMPTY_DATE, EMPTY_DATE, 0);"+
             "     end if; "+
             " end; ";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("partyid", RSDBP_IN, _partyid);
   cmd.AddParam("beneficiaryid", RSDBP_IN, _beneficiaryid);
   cmd.AddParam("oper", RSDBP_IN, {oper});
   cmd.AddParam("begindate", RSDBP_IN, _begindate);
   cmd.AddParam("enddate", RSDBP_IN, _enddate);      
   cmd.AddParam("dt", RSDBP_IN, date());      
   cmd.AddParam("tm", RSDBP_IN, time());      
   cmd.execute;
   
   // считаем, что все прошло удачно
   SetPartyOwn(_beneficiaryid, PTK_BENEFIT);
end;

/* Бенефициарный владелец */
macro SetBenefOwner(_partyid, _benefownerid, _begindate, _enddate)
   var sql_str, cmd;

   sql_str = " declare "+
             "      vcnt number := 0; "+
             "      vpartyid number := :partyid; "+
             "      vbenefownerid number := :benefownerid; "+
             "      voper number := :oper; "+
             "      vbegdate date := :begindate; "+
             "      venddate date := :enddate; "+
             "      vdate date := :dt; "+
             "      vtime date := :tm; "+
             "      EMPTY_DATE date := TO_DATE('01/01/0001 00:00:00', 'MM/DD/YYYY HH24:MI:SS'); "+
             " begin "+   
             "     select count(*) cnt  into vcnt  "+
             "       from dptbeneowner_dbt where t_partyid = vpartyid and t_beneownerid = vbenefownerid; "+
             "     if vcnt = 0 then "+
             "        Insert into DPTBENEOWNER_DBT "+
             "          (  T_ID, T_PARTYID, T_BENEOWNERID, T_COMMENT, T_BEGINDATE, "+
             "             T_ENDDATE, T_IDENTRENEWDATE, T_INPUTSYSDATE, T_INPUTSYSTIME, T_INPUTOPER, "+
             "             T_LASTEDITSYSDATE, T_LASTEDITSYSTIME, T_LASTEDITOPER, T_OWNPRC, T_DECISIONNUMBER, T_DECISIONDATE) "+
             "        Values "+
             "          (  0, vpartyid, vbenefownerid, chr(1), vbegdate, "+
             "             venddate, EMPTY_DATE, vdate, vtime, voper, "+
             "             EMPTY_DATE, EMPTY_DATE, 0, 100, chr(1), EMPTY_DATE);"+
             "     end if; "+
             " end; ";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("partyid", RSDBP_IN, _partyid);
   cmd.AddParam("benefownerid", RSDBP_IN, _benefownerid);
   cmd.AddParam("oper", RSDBP_IN, {oper});
   cmd.AddParam("begindate", RSDBP_IN, _begindate);
   cmd.AddParam("enddate", RSDBP_IN, _enddate);   
   cmd.AddParam("dt", RSDBP_IN, date());      
   cmd.AddParam("tm", RSDBP_IN, time());      
   cmd.execute;
   
   // считаем, что все прошло удачно
   SetPartyOwn(_benefownerid, 68);
end;

/* Доверитель */
macro SetLegalProxy(_partyid, _proxyid, _begindate, _enddate)
   var sql_str, cmd;

   sql_str = " declare "+
             "      vcnt number := 0; "+
             "      vpartyid number := :partyid; "+
             "      vproxyid number := :proxyid; "+
             "      voper number := :oper; "+
             "      vbegdate date := :begindate; "+
             "      venddate date := :enddate; "+
             "      EMPTY_DATE date := TO_DATE('01/01/0001 00:00:00', 'MM/DD/YYYY HH24:MI:SS'); "+
             " begin "+   
             "     select count(*) cnt  into vcnt  "+
             "       from dlegalproxy_dbt where t_partyid = vpartyid and t_proxyid = vproxyid; "+
             "     if vcnt = 0 then "+
             "        Insert into DLEGALPROXY_DBT "+
             "          (  T_ID, T_PARTYID, T_ACCOUNT, T_PROXYID, T_NUMBER, "+
             "             T_FI, T_MAXSUM, T_NOOPERPRIV, T_BEGINDATE, T_ENDDATE, "+
             "             T_GROUND, T_ISCLOSED, T_REJECTGROUND, T_CHANGEDATE, T_CHANGETIME, T_OPER) "+
             "        Values "+
             "          (  0, vpartyid, chr(1),vproxyid, 1, "+
             "             0, 0, chr(0), vbegdate, venddate, "+
             "             chr(1), chr(0), chr(1), EMPTY_DATE, EMPTY_DATE, voper);"+
             "     end if; "+
             " end; ";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("partyid", RSDBP_IN, _partyid);
   cmd.AddParam("proxyid", RSDBP_IN, _proxyid);
   cmd.AddParam("oper", RSDBP_IN, {oper});
   cmd.AddParam("begindate", RSDBP_IN, _begindate);
   cmd.AddParam("enddate", RSDBP_IN, _enddate);
   cmd.execute;
end;

macro SetCoupledSubject(_partyid, _CoupledSubject)
   var vbegindate, venddate, vcoupledpartyid;
   
   if (ValType(_CoupledSubject.StartDate) != V_UNDEF)
      vbegindate = _CoupledSubject.StartDate;
   else
      vbegindate = {curdate};
   end;
   if (ValType(_CoupledSubject.EndDate) != V_UNDEF)
      venddate = _CoupledSubject.EndDate;
   else
      venddate = date(0,0,0);
   end;
   
   vcoupledpartyid = GetPartyID_byPartyCode(PTCK_CONTR, _CoupledSubject.CSubjectId.ObjectId);
   if (vcoupledpartyid > 0)
      if ( StrUpr(_CoupledSubject.RoleCode.RecordCode) == StrUpr("БенефициарныйВладелец") )
         SetBenefOwner(_partyid, vcoupledpartyid, vbegindate, venddate);
      elif ( StrUpr(_CoupledSubject.RoleCode.RecordCode) == StrUpr("Выгодоприобретатель") )
         SetBeneficiary(_partyid, vcoupledpartyid, vbegindate, venddate);
      elif ( StrUpr(_CoupledSubject.RoleCode.RecordCode) == StrUpr("Доверитель") )
         SetLegalProxy(_partyid, vcoupledpartyid, vbegindate, venddate);
      end;
   end;
end;

macro GetSingleSign(_objecttype, _groupid)
   var sql_str;
   var cmd, rs;

   sql_str = "select t_type from dobjgroup_dbt where t_objecttype = :objecttype and t_groupid = :groupid";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("objecttype", RSDBP_IN, _objecttype);
   cmd.AddParam("groupid", RSDBP_IN, _groupid);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
     if (rs.value("t_type") == "X")
       return true;
     end;
   end;

   rs.close; cmd.close; rs = null; cmd = null;
   return false;
end;


/* Наименование субъекта*/
macro SetPartyNames(p_PartyID, p_namekind, p_namevalue)
   var sql_str, cmd;
   sql_str = "{call RSI_RSBPARTY.AddPartyName( :p_PartyID, :p_namekind, :p_namevalue )}";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("p_PartyID", RSDBP_IN, p_PartyID);
   cmd.AddParam("p_namekind", RSDBP_IN, p_namekind);
   cmd.AddParam("p_namevalue", RSDBP_IN, p_namevalue);
   cmd.execute;

end;

// категории
macro SetCategories(p_PartyID, p_categories)
   private record client("party.dbt");
   var ObjCat;
   var IsAttr, stat, err_txt;
   var category_parm;
   var ObjID = String(p_PartyID:o:10);
   var Dt;

   ObjCat = RsbObjCategories( OBJTYPE_PARTY, ObjID);
   
   for (category_parm, p_categories)
//       if (category_parm.IsSingle)
         if (category_parm.Dt != null)
           Dt = category_parm.Dt;
         else
           Dt = {curdate};
         end; 
         IsAttr = ObjCat.IsAttrPresense(category_parm.GroupID, NULL, "", category_parm.Value, true, Dt);
         if (IsAttr)
            // такая категория уже установлена
            //stat = ObjCat.DisconnectAttr(category_parm.GroupID, 0);
         else
            stat = ObjCat.ConnectAttr(category_parm.GroupID, NULL, "",  category_parm.Value, Dt );
            if (stat > 0)
               err_txt = String("Ошибка "+stat+" установки категории ",category_parm.GroupID,", значение ",category_parm.Value);
               RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
            end;      
            SetParm(2,true);
         end;
/*      else
         stat = ObjCat.ConnectAttr(category_parm.GroupID, NULL, "",  category_parm.Value, {curdate} );
         if (stat > 0)
            err_txt = String("Ошибка "+stat+" установки категории ",category_parm.GroupID,", значение ",category_parm.Value);
            RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
         end;      
         SetParm(2,true);
      end;   */
   end;
   
   if(stat == 0)
      stat = ObjCat.Save(ObjID);
   end;

end;

// сотрудники
macro SetEmployees(p_PartyID, p_employees)
   var Party:RsbParty;
   var Officer, employees_parm;
   var cnt = 0;
   Party = RsbParty(p_PartyID);
   
   for (employees_parm, p_employees)

      Officer = Party.Officer;
      Officer.New();
      Officer.PersonID = employees_parm.PersonID;
      Officer.Post = employees_parm.Post;
      Officer.IsFirstPerson = employees_parm.IsFirstPerson;
      Officer.IsSecondPerson = employees_parm.IsSecondPerson;
      
      cnt = cnt+1;
   end;
         
   if (cnt > 0)
      Party.Update();
   end;
   
end;


// табельный номер пользователя
macro u_getUserCode( oper )
   // gtv: теперь примечание на пользователе
   /* var sql = execSqlSelect("select t_code from dpartcode_dbt where t_codekind=:1 and t_partyid=(select t_partyid from dperson_dbt where t_oper=:2)",
                           makeArray(sqlParam("1", PARTY_CODEKIND_ABS), 
                                     sqlParam("2", oper)));
   if( sql.moveNext() )
      return string(sql.value(0));
   end;
   return "";*/

   var res = "";
   var sl;

   var ObjectType = 92;   //пользователь
   var ObjectID = String(oper:o:10);

   res = readNoteForObject( ObjectType, ObjectID, NOTEKIND_USERCODE );
   if (res)
     res = trim(res);
     sl = StrLen(res);
     res = MkStr("0",8-sl)+res;
   else
     res = null;
   end;

   return res;

end;

// поиск ЕД БО по номеру 
macro FindDlContrByNumber(p_cntr_num, p_clnt:@integer)
   var sql_str, rs, cmd;
   var res = -1;
   var clntid = -1;
   
   sql_str = "SELECT cntr.t_id cntr_id, dl.t_dlcontrid dl_id, dl.t_email, cntr.t_partyid "+
             " FROM dsfcontr_dbt cntr, "+
             "      ddlcontr_dbt dl "+
             "WHERE dl.t_sfcontrid = cntr.t_id "+
             "  AND cntr.t_number = :p_cntr_num "+
             "  AND cntr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') ";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("p_cntr_num", RSDBP_IN, p_cntr_num);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      res = rs.value("dl_id");
      p_clnt = rs.value("t_partyid");
   end;
   
   return res;
end;


// Доп.реквзит "Тип договора" для счетов
macro acc_get_contract_code(p_balance_num, p_account_num, p_fiid, p_curdate, p_opendate)
   const vc_default_ret = "Расчет";
   var ret;
   var v_sql, v_cmd, v_rs;

   var accfile = TBFile("account.dbt", "r", 0);
   var ObjectType;
   var ObjectID;

   accfile.rec.chapter = 1;
   accfile.rec.account = p_account_num;
   accfile.rec.code_currency = p_fiid;
   ObjectType = OBJTYPE_ACCOUNT;
   ObjectID = UniID(accfile, ObjectType);

   if (accfile.getEQ())
      ret = readNoteForObject( ObjectType, ObjectID, ACCOUNT_NOTEKIND_PURPOSE, p_curdate );
      if (not ret)
         ret = readNoteForObject( ObjectType, ObjectID, ACCOUNT_NOTEKIND_PURPOSE, date() );
      end;
   end;

   if (not ret)
     if ( (p_balance_num == "32401") or (p_balance_num == "32402") )
        v_sql = 
          " SELECT t_DocKind   "+
          "   FROM dmcaccdoc_dbt mcacc "+
          "  WHERE mcacc.t_account = :p_account_num and mcacc.t_currency = :p_fiid  ";
        v_cmd = RSDCommand(v_sql);
        v_cmd.AddParam("p_account_num", RSDBP_IN, p_account_num);
        v_cmd.AddParam("p_fiid", RSDBP_IN, p_fiid);
        v_rs = RSDRecordSet(v_cmd);
        if (v_rs.movenext)
           if (v_rs.value("t_DocKind") == 102)
              ret = "ПрсМБК";
           elif ( (v_rs.value("t_DocKind") == 199) or (v_rs.value("t_DocKind") == 4813) or (v_rs.value("t_DocKind") == 4815) )
              ret = "ПрсКнв";
           else
              ret = "ПрЗПРС"; 
           end;    
        end;

     elif ( (p_balance_num == "32501") or (p_balance_num == "32502") )
        v_sql = 
          " SELECT t_DocKind   "+
          "   FROM dmcaccdoc_dbt mcacc "+
          "  WHERE mcacc.t_account = :p_account_num and mcacc.t_currency = :p_fiid  ";
        v_cmd = RSDCommand(v_sql);
        v_cmd.AddParam("p_account_num", RSDBP_IN, p_account_num);
        v_cmd.AddParam("p_fiid", RSDBP_IN, p_fiid);
        v_rs = RSDRecordSet(v_cmd);
        if (v_rs.movenext)
           if (v_rs.value("t_DocKind") == 102)
              ret = "ПрсПрМ";
           else
              ret = "ПрЗПРС";
           end;
        end;

//shev 010620 isup510726

     elif (p_balance_num == "47408")  

        v_sql = 
          "  select t_fiid from ddvnfi_dbt where t_dealid in    "+
          " ( select t_docid from dmcaccdoc_dbt where t_account = :p_account_num)  "+
          " and t_fiid in (2574,2575,2576,2577) ";

        v_cmd = RSDCommand(v_sql);
        v_cmd.AddParam("p_account_num", RSDBP_IN, p_account_num);
        v_cmd.AddParam("p_fiid", RSDBP_IN, p_fiid);
        v_rs = RSDRecordSet(v_cmd);
        if (v_rs.movenext)
              ret = "ОбДМ";
        else
           v_sql = null; v_cmd = null; v_rs=null;

           v_sql = 
             " SELECT t_DocKind   "+
             "   FROM dmcaccdoc_dbt mcacc "+
             "  WHERE mcacc.t_account = :p_account_num and mcacc.t_currency = :p_fiid  "+
             "  and t_dockind in(101,176,117)  ";
           v_cmd = RSDCommand(v_sql);
           v_cmd.AddParam("p_account_num", RSDBP_IN, p_account_num);
           v_cmd.AddParam("p_fiid", RSDBP_IN, p_fiid);
           v_rs = RSDRecordSet(v_cmd);
           if (v_rs.movenext)
                 ret = "ОбЦБ";
           end;
        end;

     elif (p_balance_num == "47407") 

        v_sql = 
          "  select t_fiid from ddvnfi_dbt where t_dealid in    "+
          " ( select t_docid from dmcaccdoc_dbt where t_account = :p_account_num)  "+
          " and t_fiid in (2574,2575,2576,2577) ";

           v_cmd = RSDCommand(v_sql);
           v_cmd.AddParam("p_account_num", RSDBP_IN, p_account_num);
           v_cmd.AddParam("p_fiid", RSDBP_IN, p_fiid);
           v_rs = RSDRecordSet(v_cmd);
           if (v_rs.movenext)
                 ret = "ОбДМ";
           else
              v_sql = null; v_cmd = null; v_rs=null;
   
              v_sql = 
                " SELECT t_DocKind   "+
                "   FROM dmcaccdoc_dbt mcacc "+
                "  WHERE mcacc.t_account = :p_account_num and mcacc.t_currency = :p_fiid  "+
                "  and t_dockind in(199,4813,4815)  ";
              v_cmd = RSDCommand(v_sql);
              v_cmd.AddParam("p_account_num", RSDBP_IN, p_account_num);
              v_cmd.AddParam("p_fiid", RSDBP_IN, p_fiid);
              v_rs = RSDRecordSet(v_cmd);
              if (v_rs.movenext)
                    ret = "ТрЦБ";
              end;
           end;

//shev 180820 isup 514564
     elif ((p_balance_num == "47421") or (p_balance_num =="47424"))  

        v_sql = 
          "  select t_fiid from ddvnfi_dbt where t_dealid in    "+
          " ( select t_docid from dmcaccdoc_dbt where t_account = :p_account_num)  "+
          " and t_fiid in (2574,2575,2576,2577) ";

        v_cmd = RSDCommand(v_sql);
        v_cmd.AddParam("p_account_num", RSDBP_IN, p_account_num);
        v_cmd.AddParam("p_fiid", RSDBP_IN, p_fiid);
        v_rs = RSDRecordSet(v_cmd);
        if (v_rs.movenext)
              ret = "ДмТОПе";
        end;

     elif ( (p_balance_num == "52601") or (p_balance_num == "52602") )
        v_sql = 
          " SELECT f.t_exectype   "+
          "   FROM ddvnfi_dbt f, dmcaccdoc_dbt mcacc "+
          "  WHERE f.t_dealid = mcacc.t_docid and mcacc.t_account = :p_account_num and mcacc.t_currency = :p_fiid And rownum = 1 ";
        v_cmd = RSDCommand(v_sql);
        v_cmd.AddParam("p_account_num", RSDBP_IN, p_account_num);
        v_cmd.AddParam("p_fiid", RSDBP_IN, p_fiid);
        v_rs = RSDRecordSet(v_cmd);
        if (v_rs.movenext)
           if (v_rs.value("t_exectype") == 0)
              ret = "ПФИбп";
           elif (v_rs.value("t_exectype") == 1)
              ret = "ПФИп";
           end;
        end;

     end;
   end;


   if (not ret)
      // поиск по категории + шаблон
      v_sql = 
        " SELECT u2.t_shortname2   "+
        "   FROM                   "+
        "   ubalanceRSHB2_dbt u2,  "+
        "   dmcaccdoc_dbt mcacc,   "+
        "   dmctempl_dbt templ     "+
        "  WHERE u2.t_balance = :p_balance_num                                    "+    
        "    and mcacc.t_account = :p_account_num and mcacc.t_currency = :p_fiid  "+
        "    and mcacc.t_catnum = u2.t_categcode                                  "+
        "    and templ.t_catid = mcacc.t_catid                                    "+
        "    and mcacc.t_templnum = templ.t_number                                "+
        "    and templ.t_number = u2.t_categtemplate                              "+
        "    and u2.t_startdate = (select max(t_startdate) from ubalanceRSHB2_dbt u22                         "+
        "                           where u2.t_balance = u22.t_balance and u2.t_categcode = u22.t_categcode   "+
        "                             and u2.t_categtemplate = u22.t_categtemplate and u22.t_startdate <= :dt1)"+
        "    and u2.t_enddate = (select min(t_enddate) from ubalanceRSHB2_dbt u33                             "+
        "                         where u2.t_balance = u33.t_balance and u2.t_categcode = u33.t_categcode     "+
        "                           and u2.t_categtemplate = u33.t_categtemplate and u33.t_enddate >= :dt2)    ";
        
      v_cmd = RSDCommand(v_sql);
      v_cmd.AddParam("p_balance_num", RSDBP_IN, p_balance_num);
      v_cmd.AddParam("p_account_num", RSDBP_IN, p_account_num);
      v_cmd.AddParam("p_fiid",        RSDBP_IN, p_fiid);
      v_cmd.AddParam("dt1",           RSDBP_IN, p_opendate);
      v_cmd.AddParam("dt2",           RSDBP_IN, p_opendate);
      v_rs = RSDRecordSet(v_cmd);
      if (v_rs.movenext)
         ret = v_rs.value("t_shortname2");
      end;
   end;

   if (not ret)
      // поиск по категории без шаблона
      v_sql = 
        " SELECT u2.t_shortname2   "+
        "   FROM ubalanceRSHB2_dbt u2,  "+
        "        dmcaccdoc_dbt mcacc    "+
        "  WHERE u2.t_balance = :p_balance_num                                    "+
        "    and mcacc.t_account = :p_account_num and mcacc.t_currency = :p_fiid  "+
        "    and mcacc.t_catnum = u2.t_categcode                                  "+
        "    and nvl(u2.t_categtemplate,0) = 0                                    "+
        "    and u2.t_startdate = (select max(t_startdate) from ubalanceRSHB2_dbt u22                         "+
        "                           where u2.t_balance = u22.t_balance and u2.t_categcode = u22.t_categcode   "+
        "                             and u2.t_categtemplate = u22.t_categtemplate and u22.t_startdate <= :dt1)"+
        "    and u2.t_enddate = (select min(t_enddate) from ubalanceRSHB2_dbt u33                             "+
        "                         where u2.t_balance = u33.t_balance and u2.t_categcode = u33.t_categcode     "+
        "                           and u2.t_categtemplate = u33.t_categtemplate and u33.t_enddate >= :dt2)    ";
      v_cmd = RSDCommand(v_sql);
      v_cmd.AddParam("p_balance_num", RSDBP_IN, p_balance_num);
      v_cmd.AddParam("p_account_num", RSDBP_IN, p_account_num);
      v_cmd.AddParam("p_fiid",        RSDBP_IN, p_fiid);
      v_cmd.AddParam("dt1",           RSDBP_IN, p_opendate);
      v_cmd.AddParam("dt2",           RSDBP_IN, p_opendate);
      v_rs = RSDRecordSet(v_cmd);
      if (v_rs.movenext)
         ret = v_rs.value("t_shortname2");
      end;
   end;

/*   if (not ret)
      // вексели 50505
      // 04022019 - определяем по таблице
      v_sql = 
        " SELECT mcacc.t_dockind   "+
        "   FROM dmcaccdoc_dbt mcacc    "+
        "  WHERE mcacc.t_account = :p_account_num and mcacc.t_currency = :p_fiid  "+
        "    and rownum = 1                                  ";
      v_cmd = RSDCommand(v_sql);
      v_cmd.AddParam("p_account_num", RSDBP_IN, p_account_num);
      v_cmd.AddParam("p_fiid", RSDBP_IN, p_fiid);
      v_rs = RSDRecordSet(v_cmd);
      if (v_rs.movenext)
         if (v_rs.value("t_dockind") == 164)
	    ret = "Вексел";
	 end;
      end;
   end; */

   if (not ret)
      v_sql =         "SELECT t_balance, DECODE(NVL(t_shortname, chr(88)), chr(0), chr(88), chr(1), chr(88), NVL(t_shortname, chr(88))) v_shortname ";
      v_sql = v_sql + "  FROM ubalanceRSHB_dbt ";
      v_sql = v_sql + " WHERE t_balance = :p_balance_num ";

      v_cmd = RSDCommand(v_sql);
      v_cmd.addParam("p_balance_num", RSDBP_IN, p_balance_num);

      v_rs = RSDRecordSet(v_cmd);
      if(v_rs.movenext())
         if(v_rs.value("v_shortname") == strfor(88))
            ret = vc_default_ret;
         else
            ret = v_rs.value("v_shortname");
         end;
      else
         ret = vc_default_ret;
      end; 

      v_rs.close(); v_cmd.close(); v_rs = null; v_cmd = null; v_sql = null;
   end;


   return ret;
end;


macro GetActualDealID(_dealid)
  var sql_str, rs, cmd;
  var res = 0;

  sql_str = "select to_number(doc.t_documentid) next_deal   "+
            "  from doprdocs_dbt doc,                       "+
            "       doproper_dbt opr                        "+
            " where doc.t_id_operation = opr.t_id_operation "+
            "   and doc.t_dockind = opr.t_dockind           "+
            "   and opr.t_dockind = 102                     "+
            "   and opr.t_DocumentID = lpad(:dealid,34,'0') ";
  cmd = RSDCommand(sql_str);
  cmd.AddParam("dealid", RSDBP_IN, _dealid);
  rs = RSDRecordSet(cmd);
  while (rs.movenext)
    res = Int(rs.value("next_deal"));
  end;

  return res;
end;


macro GetActualDeal(_dealid, _repdate)
  var sql_str, rs, cmd;
  var next_deal = _dealid;
  var next_deal_prev;
  var cur_deal;

  sql_str = "select (select max(leg.t_maturity) from ddl_leg_dbt leg where leg.t_dealid = tick.t_dealid) maturity_date, "+
            "       tick.t_dealcode,      "+                                                                                
            "       tick.t_dealdate t_activatedate, "+                                                                                
            "       tick.t_partyid,         "+
            "       tick.t_dealdate,        "+
            "       tick.t_dealid,          "+
            "       tick.t_dealtype,        "+
            "       tick.t_istradefinance   "+
            "  from ddl_tick_dbt tick       "+
            " where tick.t_dealid = :dealid ";

  while (next_deal > 0)
     cmd = RSDCommand(sql_str);
     cmd.AddParam("dealid", RSDBP_IN, next_deal);
     rs = RSDRecordSet(cmd);
     if (rs.movenext)
        if (rs.value("maturity_date") <= _repdate) //сделка просрочена, проверим пролонгации
           next_deal_prev = next_deal;
           next_deal = GetActualDealID(next_deal);
           if (next_deal == next_deal_prev)
              next_deal = 0;
           end;
        else
           next_deal = 0;
        end;
     end;
  end;

  return rs;
end;


// класс параметров для DealEndDate
class c_DealEndDate()
  var StartDate         :date;
  var Value             :date;
  var TypeDeal          :integer;
  var IdCust_our        :integer;
  var DealId            :integer;
  var FIID              :integer;
  var ContractNum       :string;
  var ContractDate      :date;
  var IdCust_fi         :integer;
  var flag_continue     :bool;
  var StartDateTermCode :date;
  var ValueTermCode     :string;
end;

// счета без срока
macro FindDeadLine(_account, _currency, _balance, _purpose, _opendate, _res)
  var sql_str, cmd, rs;
  var res = c_DealEndDate;
  res.flag_continue = true;

  res.StartDate = _res.StartDate;
  res.Value = _res.Value;
  res.StartDateTermCode = _res.StartDateTermCode;
  res.TypeDeal = _res.TypeDeal;       
  res.ValueTermCode = _res.ValueTermCode;
  res.IdCust_our = _res.IdCust_our;
  res.DealId = _res.DealId;
  res.FIID = _res.FIID;
  res.ContractNum = _res.ContractNum;
  res.ContractDate = _res.ContractDate;
  res.IdCust_fi = _res.IdCust_fi;

  sql_str = "select t_purpose, nvl(t_isuse, 'X') t_isuse, nvl(t_dealenddate,'-') t_dealenddate, "+
            "       nvl(t_termcode,'Не заполнять') t_termcode from ubalanceRSHBDED_dbt where t_balance = :bal ";
  if (StrLen(_purpose) > 1)
    sql_str = sql_str + "and (t_purpose is null or t_purpose = :purpose)";
  end;

  cmd = RSDCommand(sql_str);
  cmd.AddParam("bal", RSDBP_IN, _balance);
  if (StrLen(_purpose) > 1)
     cmd.AddParam("purpose", RSDBP_IN, _purpose);
  end;

  rs = RSDRecordSet(cmd);
  if (rs.movenext)
    if (rs.value("t_isuse") == "-")  //балансовый не используется, обнуляем все правила
       res.StartDate = NULL;
       res.Value = NULL;
       res.StartDateTermCode = NULL;
       res.ValueTermCode = NULL;
       res.flag_continue = false;
    else
       if (StrUpr(rs.value("t_dealenddate")) == "НЕ ЗАПОЛНЯТЬ")   // если строго указано обнулить
          res.StartDate = NULL;
          res.Value = NULL;
       end;
       if ( (rs.value("t_termcode") == "сб") or (rs.value("t_termcode") == "св") or (rs.value("t_termcode") == "спр") )   // если заполнено значимым параметром
          res.StartDateTermCode = _opendate;
          res.ValueTermCode = rs.value("t_termcode");
       else
          res.StartDateTermCode = NULL;
          res.ValueTermCode = NULL;
       end;
       res.flag_continue = false;
    end;
  end;

/*
  if (      (substr(_balance,1,3) == "505") 
        or  (substr(_balance,1,3) == "317") or (substr(_balance,1,3) == "318") 
        or  (substr(_balance,1,3) == "324") or (substr(_balance,1,3) == "325") 
        or  (substr(_balance,1,3) == "459")
        or  (substr(_balance,1,3) == "524")
       )
    res.StartDate = NULL;
    res.Value = NULL;
    res.StartDateTermCode = _opendate;
    res.ValueTermCode = "спр";
    res.flag_continue = false;
  elif (      (substr(_balance,1,3) == "506") or (substr(_balance,1,3) == "507") 
          or  (_balance == "50905") 
          or  (_balance == "60101") or (_balance == "60102")
          or  (_balance == "52301")
        )
    res.StartDate = NULL;
    res.Value = NULL;
    res.StartDateTermCode = _opendate;
    res.ValueTermCode = "св";
    res.flag_continue = false;
  elif ( (_balance == "47423") and (_purpose == "КомПр") )
    res.StartDate = NULL;
    res.Value = NULL;
    res.StartDateTermCode = _opendate;
    res.ValueTermCode = "св";
    res.flag_continue = false;
  elif ( (_balance == "30221") or (_balance == "30222") )
    res.StartDate = NULL;
    res.Value = NULL;
    res.StartDateTermCode = _opendate;
    res.ValueTermCode = "сб";
    res.flag_continue = false;
  end;
*/  

  return res;
end;

// дата окончания для бумаг с купонами
macro GetDealEndDate_ByWar(res:@object)
  var sql_str, rs, cmd;
  var vcurdate = date();

  sql_str = "select t_firstdate, t_drawingdate from dfiwarnts_dbt "+
            " where t_fiid = :pfiid and t_IsPartial != 'X'"+
            "   and :pdate between  t_firstdate and t_drawingdate ";
  cmd = RSDCommand(sql_str);
  cmd.AddParam("pfiid", RSDBP_IN, res.fiid);
  cmd.AddParam("pdate", RSDBP_IN, vcurdate);
  rs = RSDRecordSet(cmd);
  if (rs.movenext)
    res.StartDate = rs.value("t_firstdate");
    res.Value = rs.value("t_drawingdate");
  else
    // даты остаются старыми
  end;

end;

// счета, открытые по бумаге
macro FindAvoir(_account, _currency)
  var sql_str_list, sql_str_body;
  var sql_str, sql_str2, rs, cmd, cmd2, rs2;
  var vcnt = 0;
  var vfiid = -1;
  var res = c_DealEndDate;
  res.flag_continue = true;

  sql_str_list = "select count(*) cnt ";
  sql_str_body = "  from dmcaccdoc_dbt mcacc "+
                 " where mcacc.t_account = :paccount "+
                 "   and mcacc.t_currency = :pcur "+
                 "   and mcacc.t_iscommon = chr(0) "+
                 "   and mcacc.t_dockind = 5 ";
  sql_str = sql_str_list + sql_str_body;
             
  cmd = RSDCommand(sql_str);
  cmd.AddParam("paccount", RSDBP_IN, _account);
  cmd.AddParam("pcur",     RSDBP_IN, _currency);
  
  rs = RSDRecordSet(cmd);
  if (rs.movenext)
    vcnt = rs.value("cnt");
    if (vcnt == 1)
      res = c_DealEndDate;
      
      sql_str_list = "select t_activatedate, t_docid ";
      sql_str2 = sql_str_list + sql_str_body;
      cmd2 = RSDCommand(sql_str2);
      cmd2.AddParam("paccount", RSDBP_IN, _account);
      cmd2.AddParam("pcur",     RSDBP_IN, _currency);
      rs2 = RSDRecordSet(cmd2);
      if (rs2.movenext)
        vfiid = rs2.value("t_docid");
        res.FIID = vfiid;
        res.StartDate = SQL_ConvTypeDate( rs2.value("t_activatedate") );
      end;
      sql_str2 = null; rs2.close; rs2 = null; cmd2.close; cmd2 = null;

      sql_str2 = "select t_drawingdate, t_issuer "+
                 "  from dfininstr_dbt where t_fiid = :fiid";
      cmd2 = RSDCommand(sql_str2);
      cmd2.AddParam("fiid", RSDBP_IN, vfiid);
      rs2 = RSDRecordSet(cmd2);
      res.IdCust_our = -1;
      if (rs2.movenext)
        res.Value = SQL_ConvTypeDate( rs2.value("t_drawingdate") );
        res.IdCust_our = rs2.value("t_issuer");
      end;
      res.TypeDeal = 5;

      sql_str2 = null; rs2.close; rs2 = null; cmd2.close; cmd2 = null;
      res.flag_continue = false;
    end;
  end;
  rs.close; cmd.close;  sql_str = null; rs = null; cmd = null;
  
  return res;
  
end;

// счета по контрагенту по CSA
macro FindDealCSA(_account, _currency)
  var sql_str_list, sql_str_body;
  var sql_str, sql_str2, rs, cmd, rs2, cmd2;
  var vcnt = 0;
  var res = c_DealEndDate;
  res.flag_continue = true;
     
  sql_str_list = " SELECT count(*) cnt ";
  sql_str_body = "   FROM dmcaccdoc_dbt mcacc,        "+
                 "        ddvcsa_dbt csa,             "+
                 "        dmccateg_dbt mccat          "+
                 "  WHERE mcacc.t_Account = :paccount "+
                 "    and mcacc.t_currency = :pcur    "+
                 "    AND mcacc.t_IsCommon = CHR(0)   "+
                 "    AND mcacc.t_DocKind = 4626      "+
                 "    and mccat.t_id = mcacc.t_catid  "+
                 "    and csa.t_csaid = mcacc.t_docid ";
  sql_str = sql_str_list + sql_str_body;
  cmd = RSDCommand(sql_str);
  cmd.AddParam("paccount", RSDBP_IN, _account);
  cmd.AddParam("pcur",     RSDBP_IN, _currency);
  
  rs = RSDRecordSet(cmd);
    if (rs.movenext)
      vcnt = rs.value("cnt");
      if (vcnt == 1)
        sql_str_list = " SELECT mcacc.t_activatedate,           "+
                       "        mcacc.t_DocKind, mcacc.t_docid, "+
                       "        mcacc.t_contractor,             "+
                       "        csa.t_csaid, csa.t_number,      "+
                       "        csa.t_begdate, csa.t_enddate    ";
        sql_str2 = sql_str_list + sql_str_body;
        cmd2 = RSDCommand(sql_str2);
        cmd2.AddParam("paccount", RSDBP_IN, _account);
        cmd2.AddParam("pcur",     RSDBP_IN, _currency);
        rs2 = RSDRecordSet(cmd2);
        if (rs2.movenext)
          res.StartDate = SQL_ConvTypeDate( rs2.value("t_begdate") );
          res.Value = SQL_ConvTypeDate( rs2.value("t_enddate") );
          res.TypeDeal = rs2.value("t_DocKind");
          res.IdCust_our = rs2.value("t_contractor");
          res.DealID = rs2.value("t_docid");
          res.ContractNum  = rs2.value("t_number");
          res.ContractDate = rs2.value("t_begdate");
          res.flag_continue = false;
        end;
        sql_str2 = null; rs2.close; rs2 = null; cmd2.close; cmd2 = null;
      end;
    end;
    rs.close; cmd.close;  sql_str = null; rs = null; cmd = null;
  
  return res;
end;

// вексели
macro FindBill(_account, _currency)
  var sql_str_list, sql_str_body;
  var sql_str, sql_str2, rs, cmd, rs2, cmd2;
  var vcnt = 0;
  var res = c_DealEndDate;
  res.flag_continue = true;

  var vstartdate, vmaturity,  vexpiry;
  
  sql_str_list = " SELECT count(*) cnt ";
  sql_str_body = "   FROM (select max(t_activatedate) t_activatedate, mcacc.t_account, "+
                 "                mcacc.t_dockind, mcacc.t_iscommon, mcacc.t_docid,    "+
                 "                mcacc.t_currency                                     "+
                 "           from dmcaccdoc_dbt mcacc                                  "+
                 "       group by mcacc.t_account, mcacc.t_dockind,                    "+
                 "                mcacc.t_iscommon, mcacc.t_docid, mcacc.t_currency) mcacc, "+
                 "        DVSBANNER_DBT ban,                                           "+
                 "        ddl_leg_dbt leg                                              "+
                 "  where mcacc.t_account = :paccount                                  "+
                 "    and mcacc.t_currency = :pcur                                     "+
                 "    and mcacc.t_iscommon = chr(0)                                    "+
                 "    and mcacc.t_dockind = 164                                        "+
                 "    and ban.t_bcid = mcacc.t_docid                                   "+
                 "    and leg.t_dealid = ban.t_bcid and leg.t_legid = 0                "+
                 "    and leg.t_legkind = 1";
  sql_str = sql_str_list + sql_str_body;
  cmd = RSDCommand(sql_str);
  cmd.AddParam("paccount",  RSDBP_IN, _account);
  cmd.AddParam("pcur",      RSDBP_IN, _currency);
  rs = RSDRecordSet(cmd);
  if (rs.movenext)
    vcnt = rs.value("cnt");
    if (vcnt == 1)
      sql_str_list = " select mcacc.t_activatedate, ban.t_registrationdate, "+
                     "        case "+
          //           "       when  leg.t_expiry > to_date('01.01.0001','dd.mm.yyyy') then leg.t_expiry "+
                     "          when leg.t_maturity > to_date('01.01.0001','dd.mm.yyyy') and leg.t_maturity > :pdate1 then leg.t_maturity "+
                     "          when leg.t_maturity > to_date('01.01.0001','dd.mm.yyyy') and leg.t_maturity < :pdate2 then "+
                     "            case  "+
                     "              when  leg.t_expiry > to_date('01.01.0001','dd.mm.yyyy') then leg.t_expiry "+
                     "              else leg.t_maturity "+
                     "            end   "+
                     "          else add_months(leg.t_start,12) "+
                     "        end t_enddate,  "+
                     "        ban.t_bcseries, ban.t_bcnumber, ban.t_registrationdate, "+
                     "        case when ban.t_issuer in (select t_partyid from ddp_dep_dbt) then "+
                     "          (select distinct t_contractor from ddl_order_dbt "+
                     "            where t_contractid in (select t_contractid from dvsordlnk_dbt "+
                     "                                   where t_bcid = ban.t_bcid and t_dockind in (109,113) and t_linkkind = 0) and rownum = 1 ) "+
                     "            else ban.t_issuer end t_holder ";
      sql_str2 = sql_str_list + sql_str_body;
      cmd2 = RSDCommand(sql_str2);
      cmd2.AddParam("pdate1",   RSDBP_IN, {curdate});
      cmd2.AddParam("pdate2",   RSDBP_IN, {curdate});
      cmd2.AddParam("paccount", RSDBP_IN, _account);
      cmd2.AddParam("pcur",     RSDBP_IN, _currency);
      rs2 = RSDRecordSet(cmd2);
      if (rs2.movenext)
        res.StartDate = SQL_ConvTypeDate( rs2.value("t_registrationdate") );
        res.Value = SQL_ConvTypeDate( rs2.value("t_enddate") );
        res.TypeDeal = 164;
        res.IdCust_our   = rs2.value("t_holder");
        res.ContractNum  = SQL_ConvTypeStr(rs2.value("t_bcseries"))+" "+SQL_ConvTypeStr(rs2.value("t_bcnumber"));
        res.ContractDate = rs2.value("t_registrationdate");

        res.flag_continue = false;
      end;
      sql_str2 = null; rs2.close; rs2 = null; cmd2.close; cmd2 = null;

    end;
  end;
  rs.close; cmd.close;  sql_str = null; rs = null; cmd = null;

  return res;
end;

// валютные сделки
macro FindDealCurrency(_account, _currency)
  var sql_str_list, sql_str_body;
  var sql_str, sql_str2, rs, cmd, rs2, cmd2;
  var vcnt = 0;
  var res = c_DealEndDate;
  res.flag_continue = true;
  
  sql_str_list = "  select count(*) cnt ";
  sql_str_body = "    from dmcaccdoc_dbt mcacc,                 "+
                 "         ddvndeal_dbt vnd,                    "+
                 "         dmccateg_dbt mccat                   "+
                 "   where mcacc.t_account = :paccount          "+
                 "     and mcacc.t_currency = :pcur             "+
                 "     and mcacc.t_iscommon = chr(0)            "+
                 "     and mcacc.t_dockind IN (199, 4813, 4815) "+
                 "     and mccat.t_id = mcacc.t_catid           "+
                 "     and vnd.t_id = mcacc.t_docid";
  sql_str = sql_str_list + sql_str_body;
  cmd = RSDCommand(sql_str);
  cmd.AddParam("paccount",  RSDBP_IN, _account);
  cmd.AddParam("pcur",      RSDBP_IN, _currency);
  rs = RSDRecordSet(cmd);
  if (rs.movenext)
    vcnt = rs.value("cnt");
    if (vcnt == 1)
      sql_str_list = "  SELECT mcacc.t_activatedate, "+     
                     "         (select max(t_execdate) from ddvnfi_dbt  dd where dd.t_dealid = vnd.t_id) maturity_date, "+
                     "         mcacc.t_DocKind, "+
                     "         vnd.t_contractor, vnd.t_id, mccat.t_updatemode, vnd.t_code, vnd.t_date  ";
      sql_str2 = sql_str_list + sql_str_body;
      cmd2 = RSDCommand(sql_str2);
      cmd2.AddParam("paccount", RSDBP_IN, _account);
      cmd2.AddParam("pcur",     RSDBP_IN, _currency);
      rs2 = RSDRecordSet(cmd2);
      if (rs2.movenext)
        res.StartDate = SQL_ConvTypeDate( rs2.value("t_activatedate") );
        res.Value = SQL_ConvTypeDate( rs2.value("maturity_date") );
        res.TypeDeal = rs2.value("t_DocKind");
        res.IdCust_our = rs2.value("t_contractor");
        res.DealID = rs2.value("t_id");
        if ( rs2.value("t_updatemode") == 0 )
           res.ContractNum  = rs2.value("t_code");
           res.ContractDate = rs2.value("t_date");
        end;
        res.flag_continue = false;
      end;
      sql_str2 = null; rs2.close; rs2 = null; cmd2.close; cmd2 = null;
    end;
  end;
  rs.close; cmd.close;  sql_str = null; rs = null; cmd = null;
  
  return res;
end;

// Cherednichenko 2020.11.16 is 518653 IM4058662 - Для своп сделок новая ф-я поиска dealenddate для счета
macro FindSwapDeal(_account, _currency)
  var sql_str_list, sql_str_body;
  var sql_str, sql_str2, rs, cmd, rs2, cmd2;
  var vcnt = 0;
  var res = c_DealEndDate;
  res.flag_continue = true;

  var sql_per, rs_per, cmd_per;
  var sql_tmp, rs_tmp, cmd_tmp;
  var part = -1; // часть (нога) сделки, -1 = неопределено, 0 - первая часть, 2 - вторая часть
  var sidecnt, dealkind;
  var dealid;

// Проверим, swap ли это и определим id сделки
// Cherednichenko 2021-09-03 is532458  у л/с в СОФР обнаружилось две сделки, поэтому ищем наличие хотя бы одной swap
/*
  sql_tmp = " select t_kind, t_id from ddvndeal_dbt where t_id = "+
            " (select t_docid from dmcaccdoc_dbt where t_account = :paccount and t_dockind = 199 and t_chapter = 4) ";
*/
  sql_tmp = " select a.t_kind, a.t_id from ddvndeal_dbt a, dmcaccdoc_dbt b where 1=1 "
          + " and a.t_id = b.t_docid "
          + " and b.t_dockind = :pdockind "
          + " and b.t_chapter = :pchapter "
          + " and a.t_kind = :pkind "
          + " and b.t_account = :paccount ";

  cmd_tmp = RSDCommand(sql_tmp);
  cmd_tmp.AddParam("pdockind",  RSDBP_IN, 199);
  cmd_tmp.AddParam("pchapter",  RSDBP_IN, 4);
  cmd_tmp.AddParam("pkind",  RSDBP_IN, 22710);
  cmd_tmp.AddParam("paccount",  RSDBP_IN, _account);
  rs_tmp = RSDRecordSet(cmd_tmp);
  if ( rs_tmp.movenext )
    dealkind = rs_tmp.value("t_kind");
    dealid =  rs_tmp.value("t_id");
  end;
  sql_tmp = null; rs_tmp.close; rs_tmp = null; cmd_tmp.close; cmd_tmp = null;
  if ( dealkind == 22710 ) //Только для swap!
  
// определим принадлежность счета к части сделки
// проверим не сделка ли это только со второй частью
    sql_tmp = " select count(1) cnt from DDVNDEAL_DBT a, ddvnfi_dbt b where 1=1              "+
              " and b.t_dealid = a.t_id                                                      "+
              " and a.t_id = (select T_docid from DMCACCDOC_DBT where t_account = :paccount) "+
              " and a.t_date = b.t_execdate                                                  "+
              " and a.t_kind =  22710                                                        ";
    cmd_tmp = RSDCommand(sql_tmp);
    cmd_tmp.AddParam("paccount",  RSDBP_IN, _account);
    rs_tmp = RSDRecordSet(cmd_tmp);
    if (rs_tmp.movenext)
      sidecnt = rs_tmp.value("cnt");
      if (sidecnt > 0)
        part = 2;
      end;
    end;
    sql_tmp = null; rs_tmp.close; rs_tmp = null; cmd_tmp.close; cmd_tmp = null;
                
// если сделка из двух частей определим часть
    if ((ValType(part) == V_UNDEF) or (part == -1))
      sql_tmp = " select 1 from dmcaccdoc_dbt tout where 1=1                                                                                    "+
                " and t_docid = :pdealid1                                                                                                         "+
                " and t_chapter = 4                                                                                                             "+
                " AND T_DOCKIND = 199                                                                                                           "+
                " and t_periodid = (select min(t_periodid) from dmcaccdoc_dbt tin where t_docid = :pdealid2 and t_chapter = 4 AND T_DOCKIND = 199) "+
                " and t_account = :paccount                                                                                                     ";
      cmd_tmp = RSDCommand(sql_tmp);
      cmd_tmp.AddParam("pdealid1",  RSDBP_IN, dealid);
      cmd_tmp.AddParam("pdealid2",  RSDBP_IN, dealid);
      cmd_tmp.AddParam("paccount",  RSDBP_IN, _account);
      rs_tmp = RSDRecordSet(cmd_tmp);
      if (rs_tmp.movenext and (rs_tmp.value(0) == 1))
        part = 0;
       else
        part = 2;
      end;
      sql_tmp = null; rs_tmp.close; rs_tmp = null; cmd_tmp.close; cmd_tmp = null;
    end;
  
////////////////////  
  
    sql_str_list = "  select count(*) cnt ";
    sql_str_body = "    from dmcaccdoc_dbt mcacc,                 "+
                   "         ddvndeal_dbt vnd,                    "+
                   "         dmccateg_dbt mccat                   "+
                   "   where mcacc.t_account = :paccount          "+
                   "     and mcacc.t_currency = :pcur             "+
                   "     and mcacc.t_iscommon = chr(0)            "+
                   "     and mcacc.t_dockind IN (199, 4813, 4815) "+
                   "     and mccat.t_id = mcacc.t_catid           "+
                   "     and vnd.t_id = mcacc.t_docid             "+
                   "     and vnd.t_kind = 22710 -- только SWAP    ";
    sql_str = sql_str_list + sql_str_body;
    cmd = RSDCommand(sql_str);
    cmd.AddParam("paccount",  RSDBP_IN, _account);
    cmd.AddParam("pcur",      RSDBP_IN, _currency);
    rs = RSDRecordSet(cmd);
    if (rs.movenext)
      vcnt = rs.value("cnt");
      if (vcnt == 1)
        sql_str_list = "  SELECT mcacc.t_activatedate, "+     
                       "         (select max(t_execdate) from ddvnfi_dbt  dd where dd.t_dealid = vnd.t_id and t_type = :ptype) maturity_date, "+
                       "         mcacc.t_DocKind, "+
                       "         vnd.t_contractor, vnd.t_id, mccat.t_updatemode, vnd.t_code, vnd.t_date  ";
        sql_str2 = sql_str_list + sql_str_body;
        cmd2 = RSDCommand(sql_str2);
        cmd2.AddParam("ptype", RSDBP_IN, part);
        cmd2.AddParam("paccount", RSDBP_IN, _account);
        cmd2.AddParam("pcur",     RSDBP_IN, _currency);
        rs2 = RSDRecordSet(cmd2);
        if (rs2.movenext)
          res.StartDate = SQL_ConvTypeDate( rs2.value("t_activatedate") );
          res.Value = SQL_ConvTypeDate( rs2.value("maturity_date") );
          res.TypeDeal = rs2.value("t_DocKind");
          res.IdCust_our = rs2.value("t_contractor");
          res.DealID = rs2.value("t_id");
          if ( rs2.value("t_updatemode") == 0 )
             res.ContractNum  = rs2.value("t_code");
             res.ContractDate = rs2.value("t_date");
          end;
          res.flag_continue = false;
        end;
        sql_str2 = null; rs2.close; rs2 = null; cmd2.close; cmd2 = null;
      end;
    end;
    rs.close; cmd.close;  sql_str = null; rs = null; cmd = null;
    end;
  
  return res;
end;

// сделки по ценным бумагам
macro FindAvoirDeal(_account, _currency)
  var sql_str_list, sql_str_body;
  var sql_str, sql_str2, rs, cmd, rs2, cmd2;
  var vcnt = 0;
  var res = c_DealEndDate;
  res.flag_continue = true;
  
  sql_str_list = " select count(*) cnt ";
  sql_str_body = "   from dmcaccdoc_dbt mcacc,          "+
                 "        ddl_tick_dbt tick,            "+
                 "        dmccateg_dbt mccat            "+
                 "  where mcacc.t_account = :paccount   "+
                 "    and mcacc.t_currency = :pcur      "+
                 "    and mcacc.t_iscommon = chr(0)     "+
                 "    and mcacc.t_dockind = 101         "+
                 "    and mccat.t_updatemode = 0        "+   // только подсделочные счета
                 "    and mccat.t_id = mcacc.t_catid    "+
                 "    and tick.t_dealid = mcacc.t_docid ";
  sql_str = sql_str_list + sql_str_body;
  cmd = RSDCommand(sql_str);
  cmd.AddParam("paccount",  RSDBP_IN, _account);
  cmd.AddParam("pcur",      RSDBP_IN, _currency);
  rs = RSDRecordSet(cmd);
  if (rs.movenext)
    vcnt = rs.value("cnt");
    if (vcnt == 1)
      sql_str_list = "SELECT mcacc.t_activatedate, "+
                     "       (select max(leg.t_maturity) from ddl_leg_dbt leg where leg.t_dealid = tick.t_dealid) maturity_date,  "+
                     "       (select max(leg.t_pfi) from ddl_leg_dbt leg where leg.t_dealid = tick.t_dealid) t_pfi,  "+
                     "       tick.t_partyid, tick.t_dealid, mcacc.t_fiid, mccat.t_updatemode, tick.t_dealcode, tick.t_dealdate ";
      sql_str2 = sql_str_list + sql_str_body;
      cmd2 = RSDCommand(sql_str2);
      cmd2.AddParam("paccount", RSDBP_IN, _account);
      cmd2.AddParam("pcur",     RSDBP_IN, _currency);

      rs2 = RSDRecordSet(cmd2);
      if (rs2.movenext)
        res.StartDate = SQL_ConvTypeDate( rs2.value("t_activatedate") );
        res.Value = SQL_ConvTypeDate( rs2.value("maturity_date") );
        res.TypeDeal = 101;
        res.IdCust_our = rs2.value("t_partyid");
        res.DealID = rs2.value("t_dealid");
        res.FIID = rs2.value("t_fiid");
        if ( rs2.value("t_updatemode") == 0 )
          res.ContractNum  = rs2.value("t_dealcode");
          res.ContractDate = rs2.value("t_dealdate");
        end;
        res.IdCust_fi = rs2.value("t_pfi"); 
        res.flag_continue = false;
      end;
      sql_str2 = null; rs2.close; rs2 = null; cmd2.close; cmd2 = null;

      if ( (substr(_account,1,5) == "50218") or (substr(_account,1,5) == "50418") or (substr(_account,1,5) == "50618") )
        sql_str2 = "select t_drawingdate, t_issuer "+
                   "  from dfininstr_dbt where t_fiid = :fiid";
        cmd2 = RSDCommand(sql_str2);
        cmd2.AddParam("fiid", RSDBP_IN, res.IdCust_fi);
        rs2 = RSDRecordSet(cmd2);
        res.IdCust_our = -1;
        if (rs2.movenext)
          res.IdCust_our = rs2.value("t_issuer");
        end;
        sql_str2 = null; rs2.close; rs2 = null; cmd2.close; cmd2 = null;
      end;

    end;
  end;
  rs.close; cmd.close;  sql_str = null; rs = null; cmd = null;

  return res;
end;

// сделки РЕПО, счет по 1 ноге
macro FindREPODeal_1leg(_account, _currency)
  var sql_str_list, sql_str_body;
  var sql_str, sql_str2, rs, cmd, rs2, cmd2;
  var vcnt = 0;
  var res = c_DealEndDate;
  res.flag_continue = true;
  
  sql_str_list = " select count(*) cnt ";
  sql_str_body = "   from dmcaccdoc_dbt mcacc,        "+
                 "        ddl_leg_dbt leg             "+
                 "  where mcacc.t_account = :paccount "+
                 "    and mcacc.t_currency = :pcur    "+
                 "    and mcacc.t_iscommon = chr(0)   "+
                 "    and mcacc.t_dockind = 176       "+
                 "    and leg.t_id = mcacc.t_docid ";
  sql_str = sql_str_list + sql_str_body;
  cmd = RSDCommand(sql_str);
  cmd.AddParam("paccount",  RSDBP_IN, _account);
  cmd.AddParam("pcur",      RSDBP_IN, _currency);
  rs = RSDRecordSet(cmd);
  if (rs.movenext)
    vcnt = rs.value("cnt");
    if (vcnt == 1)
      sql_str2 = 
             " select tick.t_dealdate t_activatedate, max(legs.t_maturity) "+
             "        t_maturity, tick.t_partyid, tick.t_dealid, mcacc.t_fiid, "+
             "        mccat.t_updatemode, tick.t_dealcode, tick.t_dealdate, "+
             "        leg.t_pfi "+
             "   from  dmcaccdoc_dbt mcacc,              "+ 
             "         ddl_leg_dbt leg,                  "+ 
             "         ddl_tick_dbt tick,                "+
             "         ddl_leg_dbt legs,                 "+
             "         dmccateg_dbt mccat                "+
             "  where mcacc.t_account = :paccount        "+ 
             "    and mcacc.t_currency = :pcur           "+
             "    and mcacc.t_iscommon = chr(0)          "+ 
             "    and mcacc.t_dockind = 176              "+ 
             "    and tick.t_dealid = leg.t_dealid       "+ 
             "    and leg.t_id = mcacc.t_docid           "+
             "    and mccat.t_id = mcacc.t_catid         "+
             "    and legs.t_dealid = tick.t_dealid and legs.t_legid = 0 and legs.t_legkind in (0, 2) "+
             " group by tick.t_dealdate, tick.t_partyid, tick.t_dealid, "+
             "          mcacc.t_fiid, mccat.t_updatemode, tick.t_dealcode, tick.t_dealdate, leg.t_pfi ";
      cmd2 = RSDCommand(sql_str2);
      cmd2.AddParam("paccount", RSDBP_IN, _account);
      cmd2.AddParam("pcur",     RSDBP_IN, _currency);
      rs2 = RSDRecordSet(cmd2);
      if (rs2.movenext)
        if ( rs2.value("t_updatemode") == 0 )  // только подсделочные
          res.StartDate = SQL_ConvTypeDate( rs2.value("t_activatedate") );
          res.Value = SQL_ConvTypeDate( rs2.value("t_maturity") );
          res.TypeDeal = 176;
          res.IdCust_our = rs2.value("t_partyid");
          res.DealID = rs2.value("t_dealid");
          res.FIID = rs2.value("t_fiid");
          res.ContractNum  = rs2.value("t_dealcode");
          res.ContractDate = rs2.value("t_dealdate");
          res.IdCust_fi = rs2.value("t_pfi"); 
          res.flag_continue = false;
        end;
      end;
      sql_str2 = null; rs2.close; rs2 = null; cmd2.close; cmd2 = null;

      if ( (substr(_account,1,5) == "50218") or (substr(_account,1,5) == "50418") or (substr(_account,1,5) == "50618") )
        sql_str2 = "select t_drawingdate, t_issuer "+
                   "  from dfininstr_dbt where t_fiid = :fiid";
        cmd2 = RSDCommand(sql_str2);
        cmd2.AddParam("fiid", RSDBP_IN, res.IdCust_fi);
        rs2 = RSDRecordSet(cmd2);
        res.IdCust_our = -1;
        if (rs2.movenext)
          res.IdCust_our = rs2.value("t_issuer");
        end;
        sql_str2 = null; rs2.close; rs2 = null; cmd2.close; cmd2 = null;
      end;

    end;
  end;
  rs.close; cmd.close;  sql_str = null; rs = null; cmd = null;
  
  return res;
end;

// сделки РЕПО, счет по 2 ногам
macro FindREPODeal_2legs(_account, _currency)
  var sql_str_list, sql_str_body;
  var sql_str, sql_str2, rs, cmd, rs2, cmd2;
  var vcnt = 0;
  var res = c_DealEndDate;
  res.flag_continue = true;
  
  sql_str_list = " select count(distinct leg.t_dealid) cnt ";
  sql_str_body = "   from dmcaccdoc_dbt mcacc, "+
                 "        ddl_leg_dbt leg "+
                 "  where mcacc.t_account = :paccount "+
                 "    and mcacc.t_currency = :pcur    "+
                 "    and mcacc.t_iscommon = chr(0) "+
                 "    and mcacc.t_dockind = 176 "+
                 "    and leg.t_id = mcacc.t_docid ";
  sql_str = sql_str_list + sql_str_body;
  cmd = RSDCommand(sql_str);
  cmd.AddParam("paccount",  RSDBP_IN, _account);
  cmd.AddParam("pcur",      RSDBP_IN, _currency);
  rs = RSDRecordSet(cmd);
  if (rs.movenext)
    vcnt = rs.value("cnt");
    if (vcnt == 1)
      sql_str2 = 
         " select min(mcacc.t_activatedate) t_activatedate,             "+
         "        max(leg.t_maturity) t_maturity, max(leg.t_pfi) t_pfi, "+
         "        tick.t_partyid, tick.t_dealid, mcacc.t_fiid,          "+
         "        mccat.t_updatemode, tick.t_dealcode, tick.t_dealdate  "+ 
         "   from  dmcaccdoc_dbt mcacc,                                 "+
         "         ddl_leg_dbt leg,                                     "+
         "         ddl_tick_dbt tick,                                   "+ 
         "         dmccateg_dbt mccat                                   "+
         "  where mcacc.t_account = :paccount                           "+
         "    and mcacc.t_currency = :pcur                              "+
         "    and mcacc.t_iscommon = chr(0)                             "+
         "    and mcacc.t_dockind = 176                                 "+
         "    and leg.t_id = mcacc.t_docid                              "+
         "    and mccat.t_id = mcacc.t_catid                            "+
         "    and leg.t_dealid = tick.t_dealid                          "+
         " group by tick.t_partyid, tick.t_dealid, mcacc.t_fiid,        "+
         "          mccat.t_updatemode, tick.t_dealcode, tick.t_dealdate";
      cmd2 = RSDCommand(sql_str2);
      cmd2.AddParam("paccount", RSDBP_IN, _account);
      cmd2.AddParam("pcur",     RSDBP_IN, _currency);
      rs2 = RSDRecordSet(cmd2);
      if (rs2.movenext)
        if ( rs2.value("t_updatemode") == 0 )  // только подсделочные
          res.StartDate = SQL_ConvTypeDate( rs2.value("t_activatedate") );
          res.Value = SQL_ConvTypeDate( rs2.value("t_maturity") );
          res.TypeDeal = 176;
          res.IdCust_our = rs2.value("t_partyid");
          res.DealID = rs2.value("t_dealid");
          res.FIID = rs2.value("t_fiid");
          res.ContractNum  = rs2.value("t_dealcode");
          res.ContractDate = rs2.value("t_dealdate");
          res.IdCust_fi = rs2.value("t_pfi"); 
          res.flag_continue = false;
        end;
      end;
      sql_str2 = null; rs2.close; rs2 = null; cmd2.close; cmd2 = null;

      if ( (substr(_account,1,5) == "50218") or (substr(_account,1,5) == "50418") or (substr(_account,1,5) == "50618") )
        sql_str2 = "select t_drawingdate, t_issuer "+
                   "  from dfininstr_dbt where t_fiid = :fiid";
        cmd2 = RSDCommand(sql_str2);
        cmd2.AddParam("fiid", RSDBP_IN, res.IdCust_fi);
        rs2 = RSDRecordSet(cmd2);
        res.IdCust_our = -1;
        if (rs2.movenext)
           res.IdCust_our = rs2.value("t_issuer");
        end;
        sql_str2 = null; rs2.close; rs2 = null; cmd2.close; cmd2 = null;
      end;

    end;
    rs.close; cmd.close;  sql_str = null; rs = null; cmd = null;
  end;

  return res;
end;


// сделки IRS
macro FindIRSDeal(_account, _currency)
  var sql_str_list, sql_str_body;
  var sql_str, sql_str2, rs, cmd, rs2, cmd2;
  var vcnt = 0;
  var repdate = date();
  var flag_found = false;
  var flag_in_diapason = false;
  var begdate, enddate;

  var res = c_DealEndDate;
  res.flag_continue = true;

  sql_str_list = " select count (distinct gr.t_dealid) cnt ";
  sql_str_body = "   from dmcaccdoc_dbt mcacc,             "+
                 "        ddvnpmgr_dbt gr                  "+
                 "  where mcacc.t_account = :paccount      "+
                 "    and mcacc.t_currency = :pcur         "+
                 "    and mcacc.t_iscommon = chr(0)        "+
                 "    and mcacc.t_dockind = 4811           "+
                 "    and gr.t_id = mcacc.t_docid          ";
                                                           
                                                           
  sql_str = sql_str_list + sql_str_body;                   
  cmd = RSDCommand(sql_str);
  cmd.AddParam("paccount",  RSDBP_IN, _account);
  cmd.AddParam("pcur",      RSDBP_IN, _currency);
  rs = RSDRecordSet(cmd);
  if (rs.movenext)
    vcnt = rs.value("cnt");
    if (vcnt == 1)
      sql_str2 = 
        " select mcacc.t_activatedate, mcacc.t_disablingdate, mcacc.t_isusable, "+
        "        gr.t_dealid, gr.t_begdate, gr.t_enddate, "+
        "        (select max(t_execdate) from ddvnfi_dbt  dd where dd.t_dealid = dvn.t_id) maturity_date, "+
        "        dvn.t_contractor, dvn.t_id, mccat.t_updatemode, dvn.t_code, dvn.t_date "+
        "   from dmcaccdoc_dbt mcacc, "+
        "        dmccateg_dbt mccat, "+                                  
        "        ddvnpmgr_dbt gr, "+ 
        "        ddvndeal_dbt dvn "+          
        "  where mcacc.t_account = :paccount "+
        "    and mcacc.t_currency = :pcur "+
        "    and mcacc.t_iscommon = chr(0) "+     
        "    and mcacc.t_dockind = 4811 "+       
        "    and gr.t_id = mcacc.t_docid "+
        "    and dvn.t_id = gr.t_dealid "+
        "    and mccat.t_id = mcacc.t_catid ";

      cmd2 = RSDCommand(sql_str2);
      cmd2.AddParam("paccount", RSDBP_IN, _account);
      cmd2.AddParam("pcur",     RSDBP_IN, _currency);

      rs2 = RSDRecordSet(cmd2);
      flag_found = false;
      while (rs2.movenext) // цикл по графику
        flag_in_diapason = true;
/* 2021-03-29 Cherednichenko всегда берем дату окончания промежуточного платежа
//        if (rs2.value("t_isusable") == "X")
           begdate = SQL_ConvTypeDate( rs2.value("t_begdate") );
           enddate = SQL_ConvTypeDate( rs2.value("t_enddate") );
           if ( (begdate <= repdate) and (repdate <= enddate) )  // попадаем в диапазон
             res.StartDate = begdate;
             res.Value = enddate;
             flag_found = true;
           end;
        end;
*/
        res.StartDate = SQL_ConvTypeDate( rs2.value("t_begdate") );
        res.Value = SQL_ConvTypeDate( rs2.value("t_enddate") );
      end;

      // спозиционировались на последней записи
/* 2021-03-29 Cherednichenko всегда берем дату окончания промежуточного платежа
      if ( rs2.value("t_updatemode") == 0 )  // только подсделочные
        if (rs2.value("t_isusable") == "X")
           if (not flag_found) //в графике не нашли, берем из сделки
              res.StartDate = SQL_ConvTypeDate( rs2.value("t_date") );
              res.Value = SQL_ConvTypeDate( rs2.value("maturity_date") );
           end;
        else
           res.StartDate = SQL_ConvTypeDate( rs2.value("t_activatedate") );
           res.Value = SQL_ConvTypeDate( rs2.value("t_disablingdate") );
        end;
*/
      if (flag_in_diapason)
        res.TypeDeal = 4811;
        res.IdCust_our = rs2.value("t_contractor");
        res.DealID = rs2.value("t_id");
        res.ContractNum  = rs2.value("t_code");
        res.ContractDate = rs2.value("t_date");
        res.flag_continue = false;
      end;
      sql_str2 = null; rs2.close; rs2 = null; cmd2.close; cmd2 = null;

    end;
    rs.close; cmd.close;  sql_str = null; rs = null; cmd = null;
  end;

  return res;
end;

// сделки IRS - для счетов, связанных со сделкой
macro FindIRSDeal_ByDeal(_account, _currency)
  var sql_str_list, sql_str_body;
  var sql_str, sql_str2, sql_str3, rs, cmd, rs2, cmd2, rs3, cmd3;
  var vcnt = 0;
  var repdate = date();
  var flag_found = false;
  var begdate, enddate;
  var dealid = 0, side = -1;
  var isnominal = false;

  var res = c_DealEndDate;
  res.flag_continue = true;

// 2020-12-25 Cherednichenko is515797 даты номинальных платежей определяются по датам сделки
// проверим принадлежность 
  sql_str3 = " select ku.t_catnum, d.t_begindate, p.t_execdate               "+
             " from DDVNDEAL_DBT d, DDVNFI_DBT p, dmcaccdoc_dbt ku where 1=1 "+
             " and p.t_dealid = d.t_id                                       "+
             " and ku.t_docid = d.t_id                                       "+
             " and ku.t_account = :paccount                                  "+
             " and ku.t_currency = :pcur                                     "+
             " and ku.t_iscommon = chr(0)                                    "+
             " and ku.t_dockind = 199                                        "+
             " and d.t_kind = 22720                                          ";
  cmd3 = RSDCommand(sql_str3);
  cmd3.AddParam("paccount",  RSDBP_IN, _account);
  cmd3.AddParam("pcur",      RSDBP_IN, _currency);
  rs3 = RSDRecordSet(cmd3);
  if (rs3.movenext)
    if ( (rs3.value("t_catnum") == 1224) or (rs3.value("t_catnum") == 1225) )
      res.StartDate = SQL_ConvTypeDate( rs3.value("t_begindate") );
      res.Value = SQL_ConvTypeDate( rs3.value("t_execdate") );
      res.flag_continue = false;
      isnominal = true;
    end;
    sql_str3 = null; rs3.close; rs3 = null; cmd3.close; cmd3 = null;
  end;
  if (not isnominal) //is515797 теперь ищем по графику, только если это НЕ по номинальным платежам
    sql_str_list = "  select count(*) cnt ";
    sql_str_body = "    from dmcaccdoc_dbt mcacc,                 "+
                   "         ddvndeal_dbt vnd,                    "+
                   "         dmccateg_dbt mccat                   "+
                   "   where mcacc.t_account = :paccount          "+
                   "     and mcacc.t_currency = :pcur             "+
                   "     and mcacc.t_iscommon = chr(0)            "+
                   "     and mcacc.t_dockind = 199                "+
                   "     and mccat.t_id = mcacc.t_catid           "+
                   "     and vnd.t_id = mcacc.t_docid             "+
                   "     and vnd.t_kind = 22720                   "; // только IRS
    sql_str = sql_str_list + sql_str_body;
    cmd = RSDCommand(sql_str);
    cmd.AddParam("paccount",  RSDBP_IN, _account);
    cmd.AddParam("pcur",      RSDBP_IN, _currency);
    rs = RSDRecordSet(cmd);
    if (rs.movenext)
      vcnt = rs.value("cnt");
      if (vcnt == 1)
        sql_str2 = "select vnd.t_id, mcacc.t_kind_account  "+ sql_str_body;
        cmd2 = RSDCommand(sql_str2);
        cmd2.AddParam("paccount", RSDBP_IN, _account);
        cmd2.AddParam("pcur",     RSDBP_IN, _currency);
        rs2 = RSDRecordSet(cmd2);
        if (rs2.movenext)
           dealid = rs2.value("t_id");
           if (rs2.value("t_kind_account") == "А")
             side = 2;
// 2020-06-04 Cherednichenko для IRS при пассивном счете сторона = 1, при неопределенном - 0
           elif (rs2.value("t_kind_account") == "П")
             side = 1;
           elif (rs2.value("t_kind_account") == "0")
             side = 0;
           end;
        end;
        rs2.close; cmd2.close; rs2 = null; cmd2 = null; sql_str2 = null;
  
        sql_str2 = 
          " select gr.t_dealid, gr.t_begdate, gr.t_enddate, gr.t_side, "+
          "        (select max(t_execdate) from ddvnfi_dbt  dd where dd.t_dealid = dvn.t_id) maturity_date, "+
          "        dvn.t_contractor, dvn.t_id, dvn.t_code, dvn.t_date "+
          "   from ddvnpmgr_dbt gr, "+ 
          "        ddvndeal_dbt dvn "+          
          "  where dvn.t_id = gr.t_dealid "+
          "    and dvn.t_id = :vid " +
          "    order by t_side desc "; // сначала значимая сторона сделки
// Сторона проверяется только в цикле графика       "    and gr.t_side = :side ";
  
        cmd2 = RSDCommand(sql_str2);
        cmd2.AddParam("vid", RSDBP_IN, dealid);      
// Сторона проверяется только в цикле графика     cmd2.AddParam("side", RSDBP_IN, side);
  
        rs2 = RSDRecordSet(cmd2);
        flag_found = false;
        while (rs2.movenext) // цикл по графику
          begdate = SQL_ConvTypeDate( rs2.value("t_begdate") );
          enddate = SQL_ConvTypeDate( rs2.value("t_enddate") );
          if ( (begdate <= repdate) and (repdate <= enddate)            // попадаем в диапазон 
                  and (rs2.value("t_side") == side) and (side != 0) )   // Cherdednicheko и в нужную, но не в 0 сторону
            res.StartDate = begdate;
            res.Value = enddate;
            flag_found = true;
          end;
        end;
  
        // Циклом сверху мы спозиционировались на последней записи
  
        if ((not flag_found) and (valtype(rs2.value("t_contractor")) !=26)               // в графике не нашли, берем из сделки
                and ( (rs2.value("t_side") == side ) or (rs2.value("t_side") == "0" )))  // Cherdednicheko при условии нужной (в т.ч. нулевой) стороны, чтобы не зацепить противоположную
          res.StartDate = SQL_ConvTypeDate( rs2.value("t_date") );
          res.Value = SQL_ConvTypeDate( rs2.value("maturity_date") );
          res.flag_continue = false;
        end;
  
        if (valtype(rs2.value("t_contractor")) !=26)
          res.TypeDeal = 199;
          res.IdCust_our = rs2.value("t_contractor");
          res.DealID = rs2.value("t_id");
          res.ContractNum  = rs2.value("t_code");
          res.ContractDate = rs2.value("t_date");
        end;
  
        sql_str2 = null; rs2.close; rs2 = null; cmd2.close; cmd2 = null;
      //end;
      end;
      rs.close; cmd.close;  sql_str = null; rs = null; cmd = null;
    end;
  end;

  return res;
end;


// ближайшая дата выплаты процентов по графику
macro MBK_GetNextPrc(_dealid, _repdate, _type)
  var sql_str, cmd, rs;
  var res = date(0,0,0);

  sql_str = 
     " select a.t_baseamount psumma,                                                                              "+
     "  a.t_valuedate ,                                                                                           "+
     "  a.t_fiid fi,                                                                                              "+
     "  a.t_purpose,                                                                                              "+
     "  c.t_shortname ptip ,                                                                                      "+
     "  a.t_paymentid pnum,                                                                                       "+
     "  (select u3.t_shortname from dpmstatus_dbt u3 where u3.t_type=0 and u3.t_paymstatus=a.t_paymstatus ) pstat "+ 
     "   from dpmpaym_dbt a, dpmpurp_dbt c where a.t_docKind=102 and a.t_purpose > 8                              "+
     "   and a.t_purpose=c.t_purpose                                                                              "+
     "   and a.t_documentid = :pdealid                                                                            ";

  if (_type == "END")
     sql_str = sql_str + 
        "   and a.t_valuedate = (select min(t_valuedate) from dpmpaym_dbt a2                        "+
        "                         where a2.t_dockind = a.t_docKind and a2.t_purpose = a.t_purpose   "+
        "                           and a.t_documentid = a2.t_documentid and t_valuedate >= :pdate) ";
  elif (_type == "START")
     sql_str = sql_str +    
        "   and a.t_valuedate = (select max(t_valuedate) from dpmpaym_dbt a2                      "+
        "                         where a2.t_dockind = a.t_docKind and a2.t_purpose = a.t_purpose "+
        "                       and a.t_documentid = a2.t_documentid and t_valuedate <= :pdate)   ";
  end;
  sql_str = sql_str + "  and c.t_shortname = 'Проценты' ";

  cmd = RSDCommand(sql_str);
  cmd.AddParam("dealid", RSDBP_IN, _dealid);
  cmd.AddParam("pdate", RSDBP_IN, _repdate);
  rs = RSDRecordSet(cmd);

  while (rs.movenext)
     res = rs.value("t_valuedate");
  end;

  return res;
end;

// сделки МБК
macro FindDealMBK (_account, _currency)
  var sql_str_list, sql_str_body;
  var sql_str, sql_str2, rs, cmd, rs2, cmd2;
  var vcnt = 0;
  var actual_rs;
  var prc_date, dealdate;
  
  var res = c_DealEndDate;
  res.flag_continue = true;
  
  sql_str_list = " select count(*) cnt ";
  sql_str_body = "   from  dmcaccdoc_dbt mcacc,         "+
                 "         ddl_tick_dbt tick,           "+
                 "         dmccateg_dbt mccat           "+
                 "  where mcacc.t_account = :paccount   "+
                 "    and mcacc.t_currency = :pcur      "+
                 "    and mcacc.t_iscommon = chr(0)     "+
                 "    and mcacc.t_dockind = 102         "+
                 "    and tick.t_dealid = mcacc.t_docid "+
                 "    and mccat.t_id = mcacc.t_catid    "+
                 "    and mccat.t_updatemode = 0        "+
                 "    and tick.t_dealid = (select min(m.t_docid) from dmcaccdoc_dbt m "+
                 "                          where m.t_Account = mcacc.t_Account and m.t_IsCommon = mcacc.t_IsCommon "+
                 "                            and m.t_DocKind = mcacc.t_DocKind and m.t_catid = mcacc.t_catid ) ";
  sql_str = sql_str_list + sql_str_body;
  cmd = RSDCommand(sql_str);
  cmd.AddParam("paccount",  RSDBP_IN, _account);
  cmd.AddParam("pcur",      RSDBP_IN, _currency);

  rs = RSDRecordSet(cmd);
  if (rs.movenext)
    vcnt = rs.value("cnt");
    if (vcnt == 1)
      sql_str_list = " SELECT mcacc.t_activatedate,     "+
                     "        (select max(leg.t_maturity) from ddl_leg_dbt leg where leg.t_dealid = tick.t_dealid) maturity_date, "+
                     "        tick.t_partyid, tick.t_dealid, "+
                     "        mccat.t_updatemode, tick.t_dealcode, tick.t_dealdate, mccat.t_groupid ";
      sql_str2 = sql_str_list + sql_str_body;
      cmd2 = RSDCommand(sql_str2);
      cmd2.AddParam("paccount", RSDBP_IN, _account);
      cmd2.AddParam("pcur",     RSDBP_IN, _currency);

      rs2 = RSDRecordSet(cmd2);
      if (rs2.movenext)
        actual_rs = GetActualDeal(Int(rs2.value("t_dealid")), {curdate});
        res.StartDate = SQL_ConvTypeDate( actual_rs.value("t_activatedate") );
        res.Value = SQL_ConvTypeDate( actual_rs.value("maturity_date") ); 
        res.TypeDeal = 102;
        res.IdCust_our = actual_rs.value("t_partyid");
        res.DealID = actual_rs.value("t_dealid");
        dealdate = actual_rs.value("t_dealdate");
        if ( rs2.value("t_updatemode") == 0 )
          res.ContractNum  = actual_rs.value("t_dealcode");
          res.ContractDate = dealdate;
        end;
        
        //if (Substr(_account,1,3) == "474") // счета процентов
        if (rs2.value("t_groupid") == 104) // группа "% к погашению"
          prc_date = MBK_GetNextPrc(res.DealID, date(), "END");
          if (prc_date > date(0,0,0))
             res.Value = prc_date;
             prc_date = MBK_GetNextPrc(res.DealID, date(), "START");
             if ( (prc_date > date(0,0,0)) and (prc_date < res.Value ))
                res.StartDate = prc_date;
             else
                res.StartDate = dealdate;
             end;
          end;
        end;
        
        res.flag_continue = false;
        actual_rs.close; actual_rs = null;
      end; 
      sql_str2 = null; rs2.close; rs2 = null; cmd2.close; cmd2 = null;
    end;
  end;
  rs.close; cmd.close;  sql_str = null; rs = null; cmd = null;
  
  return res;
end;

// общие счета
macro FindGeneralAccount(_account, _currency, _open_date)
  var sql_str_list, sql_str_body;
  var sql_str, sql_str2, rs, cmd, rs2, cmd2;
  var vcnt = 0;
  var vfiid = -1;
  var res = c_DealEndDate;
  res.flag_continue = true;
  
  sql_str2 =  " select min(mcacc.t_activatedate) t_activatedate,  "+
              "        mcacc.t_fiid, fininstr.t_fi_kind           "+
              "   from  dmccateg_dbt mccat,                       "+
              "         dmcaccdoc_dbt mcacc,                      "+
              "         dfininstr_dbt fininstr                    "+
              "  where t_account = :paccount                      "+
              "    and mcacc.t_currency = :pcur                   "+
              "    and mccat.t_id = mcacc.t_catid and t_updatemode in (0,1) "+
              "    and fininstr.t_fi_kind in (2, 4) "+   //  ФИ + производные инструменты
              "    and fininstr.t_fiid = mcacc.t_fiid "+
              "    and mcacc.t_fiid > 0 "+
              "group by mcacc.t_fiid, fininstr.t_fi_kind ";
  cmd2 = RSDCommand(sql_str2);
  cmd2.AddParam("paccount",  RSDBP_IN, _account);
  cmd2.AddParam("pcur",      RSDBP_IN, _currency);

  rs2 = RSDRecordSet(cmd2);
  if (rs2.movenext)
    vfiid = rs2.value("t_fiid");
    res.FIID = vfiid;
    res.StartDate = SQL_ConvTypeDate( rs2.value("t_activatedate") );
    if (rs2.value("t_fi_kind") == 4)
       res.StartDate = _open_date;
    end;
  end;
  sql_str2 = null; rs2.close; rs2 = null; cmd2.close; cmd2 = null;

  sql_str2 = "select t_drawingdate, t_issuer "+
             "  from dfininstr_dbt where t_fiid = :fiid";
  cmd2 = RSDCommand(sql_str2);
  cmd2.AddParam("fiid", RSDBP_IN, vfiid);
  rs2 = RSDRecordSet(cmd2);
  res.IdCust_our = -1;
  if (rs2.movenext)
    res.Value = SQL_ConvTypeDate( rs2.value("t_drawingdate") );
    res.IdCust_our = rs2.value("t_issuer");
  end;
  res.TypeDeal = 1;

  sql_str2 = null; rs2.close; rs2 = null; cmd2.close; cmd2 = null;

  return res;
end;

// получение DealEndDate 
macro GetDealEndDate(p_account, p_currency, p_balance, p_purpose, p_opendate)
  var sql_str, rs, cmd;
  var sql_str2, rs2, cmd2;
  var flag_continue = true;

  var vcnt = 0;
  var vfiid = -99;
  var res = c_DealEndDate;
  res.flag_continue = true;

  var actual_rs;
  
  
  if (res.flag_continue)
    res = FindAvoir(p_account, p_currency);
  end;
  
  if (res.flag_continue)
    res = FindDealCSA(p_account, p_currency);
  end;
  
  if (res.flag_continue)
    res = FindBill(p_account, p_currency);
  end;
  
  if (res.flag_continue)
    res = FindIRSDeal_ByDeal(p_account, p_currency);  // счета привязаны к сделке, даты из графика
  end;

// Cherednichenko 2020.11.16 is 518653 IM4058662 - Для своп сделок новая ф-я поиска dealenddate для счета
  if (res.flag_continue)
    res = FindSwapDeal(p_account, p_currency);  // счета привязаны к сделке своп
  end;

  if (res.flag_continue)
    res = FindDealCurrency(p_account, p_currency);
  end;

  if (res.flag_continue)
    res = FindIRSDeal(p_account, p_currency);       // счета привязаны к графику
  end;

  if (res.flag_continue)
    res = FindAvoirDeal(p_account, p_currency);
  end;
  
  if (res.flag_continue)
    res = FindREPODeal_1leg(p_account, p_currency);
  end;
  
  if (res.flag_continue)
    res = FindREPODeal_2legs(p_account, p_currency);
  end;
  
  if (res.flag_continue)
    res = FindDealMBK(p_account, p_currency);
  end;

  if (res.flag_continue) 
    res = FindGeneralAccount(p_account, p_currency, p_opendate);
  end;
  
  if ( ( (substr(p_balance,1,3) == "501") or (substr(p_balance,1,3) == "502") or (substr(p_balance,1,3) == "504") ) 
        and ( (p_purpose == "ПКДУ") or (p_purpose == "ПКДН") )
       )
    GetDealEndDate_ByWar(@res);
  elif ( (p_balance == "52501")
        and (p_purpose == "КупЦБ") 
        and (ValType(res.fiid) != V_UNDEF)
       )
    GetDealEndDate_ByWar(@res);
  end;

  res = FindDeadLine(p_account, p_currency, p_balance, p_purpose, p_opendate, res);

  if (ValType(res.IdCust_our) == V_UNDEF)
    sql_str =  " select count(distinct t_contractor) cnt "+
               "   from  dmcaccdoc_dbt mcacc "+
               "  where mcacc.t_account = :paccount "+
               "    and mcacc.t_currency = :pcur    "+
               "    and mcacc.t_iscommon = chr(0) "+
               "    and t_dockind in ( 101, 199, 4813, 4815, 102) ";

    cmd = RSDCommand(sql_str);
    cmd.AddParam("paccount", RSDBP_IN, p_account);
    cmd.AddParam("pcur",     RSDBP_IN, p_currency);

    rs = RSDRecordSet(cmd);
    if (rs.movenext)
      vcnt = rs.value("cnt");
      if (vcnt == 1)
        sql_str2 = " SELECT distinct t_contractor       "+
                   "   FROM dmcaccdoc_dbt mcacc         "+
                   "  WHERE mcacc.t_Account = :paccount "+
                   "    AND mcacc.t_currency = :pcur    "+
                   "    AND mcacc.t_IsCommon = CHR(0)   "+
                   "    AND mcacc.t_DocKind in ( 101, 199, 4813, 4815, 102) ";
        cmd2 = RSDCommand(sql_str2);
        cmd2.AddParam("paccount", RSDBP_IN, p_account);
        cmd2.AddParam("pcur",     RSDBP_IN, p_currency);
        rs2 = RSDRecordSet(cmd2);
        if (rs2.movenext)
          if (ValType(rs2.value("t_contractor")) != 26 )
          res.IdCust_our = rs2.value("t_contractor");
          res.TypeDeal = 1;
          flag_continue = false;
        end;
        end;
        sql_str2 = null; rs2.close; rs2 = null; cmd2.close; cmd2 = null;              

      end;
    end;
    rs.close; cmd.close;  sql_str = null; rs = null; cmd = null;              
  end;

  if (ValType(res.IdCust_our) == V_UNDEF)
    sql_str = "  select count(distinct tick.t_partyid) cnt   "+
              "    from  dmcaccdoc_dbt mcacc,                "+
              "          ddl_tick_dbt tick                   "+
              "   where mcacc.t_account = :paccount          "+
              "     and mcacc.t_currency = :pcur             "+
              "     and mcacc.t_iscommon = chr(0)            "+
              "     and tick.t_bofficekind = mcacc.t_dockind "+
              "     and tick.t_dealid = mcacc.t_docid ";
    cmd = RSDCommand(sql_str);
    cmd.AddParam("paccount", RSDBP_IN, p_account);
    cmd.AddParam("pcur",     RSDBP_IN, p_currency);

    rs = RSDRecordSet(cmd);
    if (rs.movenext)
      vcnt = rs.value("cnt");
      if (vcnt == 1)
        sql_str2 = " SELECT distinct tick.t_partyid               "+
                   "   FROM  dmcaccdoc_dbt mcacc,                 "+
                   "         ddl_tick_dbt tick                    "+
                   "  WHERE mcacc.t_Account = :paccount           "+
                   "    AND mcacc.t_currency = :pcur              "+
                   "    AND mcacc.t_IsCommon = CHR(0)             "+
                   "    AND tick.t_bofficekind = mcacc.t_dockind  "+
                   "    AND tick.t_dealid = mcacc.t_docid         ";
        cmd2 = RSDCommand(sql_str2);
        cmd2.AddParam("paccount", RSDBP_IN, p_account);
        cmd2.AddParam("pcur",     RSDBP_IN, p_currency);
        rs2 = RSDRecordSet(cmd2);
        if (rs2.movenext)
          res.IdCust_our = rs2.value("t_partyid");
          res.TypeDeal = 1;
          flag_continue = false;
        end;
        sql_str2 = null; rs2.close; rs2 = null; cmd2.close; cmd2 = null;
      end;
    end;
    rs.close; cmd.close;  sql_str = null; rs = null; cmd = null;
  end;

  if (ValType(res.IdCust_our) == V_UNDEF)
    sql_str =  " select count(distinct vn.t_contractor) cnt "+
               "   from  dmcaccdoc_dbt mcacc,               "+
               "         ddvndeal_dbt vn                    "+
               "  where mcacc.t_account = :paccount         "+
               "    and mcacc.t_currency = :pcur            "+
               "    and mcacc.t_iscommon = chr(0)           "+
               "    and vn.t_id = mcacc.t_docid             "+
               "    and mcacc.t_dockind in (199, 4813, 4815)";
    cmd = RSDCommand(sql_str);
    cmd.AddParam("paccount", RSDBP_IN, p_account);
    cmd.AddParam("pcur",     RSDBP_IN, p_currency);

    rs = RSDRecordSet(cmd);
    if (rs.movenext)
      vcnt = rs.value("cnt");
      if (vcnt == 1)
        sql_str2 = " select vn.t_contractor                     "+
                   "   from  dmcaccdoc_dbt mcacc,               "+
                   "         ddvndeal_dbt vn                    "+
                   "  where mcacc.t_account = :paccount         "+
                   "    and mcacc.t_currency = :pcur            "+
                   "    and mcacc.t_iscommon = chr(0)           "+
                   "    and vn.t_id = mcacc.t_docid             "+
                   "    and mcacc.t_dockind in (199, 4813, 4815) ";
        cmd2 = RSDCommand(sql_str2);
        cmd2.AddParam("paccount", RSDBP_IN, p_account);
        cmd2.AddParam("pcur",     RSDBP_IN, p_currency);
        rs2 = RSDRecordSet(cmd2);
        if (rs2.movenext)
          res.IdCust_our = rs2.value("t_contractor");
          res.TypeDeal = 1;
          flag_continue = false;
        end;         
        sql_str2 = null; rs2.close; rs2 = null; cmd2.close; cmd2 = null;

      end;
    end;
    rs.close; cmd.close;  sql_str = null; rs = null; cmd = null;
  end;

  if (Valtype(res) == V_Undef)
    res = NULL;
  elif (res.Value == date(0,0,0))
//     res = null;
  end;

  return res;
end;

macro GetSynthAccByMC_Bisquit( Account :string, fiid: integer, chapter: integer ) :string //фунция поиска сводного счета
   var Query :string = "",
       DataSet :RsdRecordset,
       Params :TArray, 
       res : string,
       usertypeaccount : string,
       accountid = 0,
       categ_name;

// BIQ-7785 Гераськина Т.В Поиск счета зависит от типа - ЕДП или нет
    Query = "select t_usertypeaccount, t_accountid from daccount_dbt acc "+
            " where t_account = :acc and t_code_currency = :curcode and t_chapter = :chapter ";
    Params = makeArray( SQLParam("acc", Account), SQLParam("curcode", fiid), SQLParam("chapter", chapter) );
    DataSet = execSQLselect( Query, Params );

    if( (DataSet.MoveNext) and ( ValType( DataSet.value( 0, NULL, V_STRING) ) != V_UNDEF ) 
      and ( ValType( DataSet.value( 0, NULL, V_STRING) ) != 26 ) )
       usertypeaccount = DataSet.value( 0, NULL, V_STRING);
       accountid = DataSet.value( 1, NULL, V_INTEGER);
    end;

// gtv: оптимизация запроса для ЕДП
// поиск по таблице соответствий для сверки
    if ( (ValType(accountid) != V_UNDEF) and (accountid > 0) )
      Query = " select b.t_account from "+
              "      DBROKACC_ACC_DBT  bacc, "+
              "      dbrokacc_dbt b "+
              "  where bacc.t_accountid = :accountid "+
              "    and bacc.t_brokacc_key = b.t_autokey ";

      Params = makeArray( SQLParam("accountid", accountid) );
      DataSet = execSQLselect( Query, Params );

      if( (DataSet.MoveNext) and ( ValType( DataSet.value( 0, NULL, V_STRING) ) != V_UNDEF ) 
        and ( ValType( DataSet.value( 0, NULL, V_STRING) ) != 26 ) )
        res = DataSet.value( 0, NULL, V_STRING);
      end;
    end;

    if (not res)
       if (Substr(Account, 1, 3) == "306")
          categ_name = "ДС клиента, ц/б";
       elif (Substr(Account, 1, 5) == "47423")
          categ_name = "+РасчетыКомисс1";
       elif ( (Substr(Account, 1, 5) == "45815") or (Substr(Account, 1, 5) == "45817")) 
          categ_name = "Треб. с н.с. брок";
       else 
          categ_name = "";
       end;

       if ((Index(usertypeaccount, USERTYPEACCOUNT_EDP) > 0) or (categ_name == "Треб. с н.с. брок")) // счет ЕДП или КУ "Треб. с н.с. брок", где для внебиржи используется тот же сводник, что и для ЕДП
//gtv: для ЕДП servkind = 0, поэтому обращаться к dsfcontr_dbt нет смысла
//в dmcaccdoc_dbt проверим наличие счета
          Query = " SELECT brok.T_ACCOUNT " +
                  " FROM dmcaccdoc_dbt mcdoc, dmccateg_dbt mccat, dbrokacc_dbt brok " +
                  " WHERE mcdoc.T_ACCOUNT = :Acc " +
                  "  AND mccat.T_ID = mcdoc.T_CATID " +
                  "  AND mccat.T_CODE = :categ_name " +
                  "  AND brok.T_SERVKIND = 0 " +
                  "  AND brok.T_SERVKINDSUB = 0 " +
                  "  AND brok.T_CURRENCY = mcdoc.T_CURRENCY " +
                  "  AND SUBSTR(brok.T_ACCOUNT, 1, 5) = SUBSTR(mcdoc.T_ACCOUNT, 1, 5) "
                  "  and (mcdoc.T_ISCOMMON = 'X' or ( ( mcdoc.T_ISCOMMON = chr(0) ) and (mcdoc.t_disablingdate <> to_date('01010001','ddmmyyyy')) and (mcdoc.t_dockind = 0) ) ) ";
       else
   // Cherednichenko 2020-10-09 - В связи с правками в функционале изменяется алгоритм поиск сводного счета is:516945
          Query = " SELECT D.T_ACCOUNT " +
                  " FROM dmcaccdoc_dbt A, dmccateg_dbt B, dsfcontr_dbt C, dbrokacc_dbt D " +
                  " WHERE A.T_ACCOUNT = :Acc " +
                  // "  AND A.T_ISCOMMON = 'X' " +
                  "  AND B.T_ID = A.T_CATID " +
                  "  AND B.T_CODE = :categ_name " +
                  "  AND C.T_ID = A.T_CLIENTCONTRID " +
                  "  AND D.T_SERVKIND = C.T_SERVKIND " +
                  "  AND D.T_SERVKINDSUB = C.T_SERVKINDSUB " +
                  "  AND D.T_CURRENCY = A.T_CURRENCY " +
                  "  AND  SUBSTR(D.T_ACCOUNT, 1, 5) = SUBSTR(A.T_ACCOUNT, 1, 5) "
                  "  and (A.T_ISCOMMON = 'X' or ( ( A.T_ISCOMMON = chr(0) ) and (t_disablingdate <> to_date('01010001','ddmmyyyy')) and (t_dockind = 0) ) ) ";
       end;
   //BIQ-7785

       Params = makeArray( SQLParam("Acc", Account), SQLParam("categ_name", categ_name) );   
       DataSet = execSQLselect( Query, Params );

       if( (DataSet.MoveNext) and ( ValType( DataSet.value( 0, NULL, V_STRING) ) != V_UNDEF ) 
         and ( ValType( DataSet.value( 0, NULL, V_STRING) ) != 26 ) )
        res = DataSet.value( 0, NULL, V_STRING);
       end;
    end;

    if (not res)  // если не нашли, то попробуем с dockind = 3001, так как DL_SubContrFD открывает именно такую связку
        Query = " SELECT D.T_ACCOUNT " +
                " FROM dmcaccdoc_dbt A, dmccateg_dbt B, dsfcontr_dbt C, dbrokacc_dbt D " +
                " WHERE A.T_ACCOUNT = :Acc " +
                "  AND B.T_ID = A.T_CATID " +
                "  AND B.T_CODE = :categ_name " +
                "  AND C.T_ID = A.T_CLIENTCONTRID " +
                "  AND D.T_SERVKIND = C.T_SERVKIND " +
                "  AND D.T_SERVKINDSUB = C.T_SERVKINDSUB " +
                "  AND D.T_CURRENCY = A.T_CURRENCY " +
                "  AND SUBSTR(D.T_ACCOUNT, 1, 5) = SUBSTR(A.T_ACCOUNT, 1, 5) "
                "  and A.T_ISCOMMON = chr(0) and t_dockind = 3001 ";
       Params = makeArray( SQLParam("Acc", Account), SQLParam("categ_name", categ_name) );
       DataSet = execSQLselect( Query, Params );

       if( (DataSet.MoveNext) and ( ValType( DataSet.value( 0, NULL, V_STRING) ) != V_UNDEF ) 
         and ( ValType( DataSet.value( 0, NULL, V_STRING) ) != 26 ) )
          res = DataSet.value( 0, NULL, V_STRING);
       end;
    end;


    return res;

onError(err)
    return Account;
end;

/**
@brief Создать событие 
@param[in] _objecttype тип объекта (dfunc_dbt)
@param[in] _objectid id объекта 
@param[in] _type тип события 
@param[in] _addstatus дополнительные статусы в виде строки через запятую, считаем, что строка корректная
@param[in] _note примечание, по умолчанию - пусто
@param[in] _status статус, по умолчанию - 1

По умолчанию добавляются события с типом 2 при условии, что в таблице нет других записей по этому объекту, кроме успешных
*/
macro PutInProcess(_objecttype, _objectid, _type, _addstatus, _note, _status)
  var sql_str, rs, cmd;
  var reqid = -1;
  var ptype, pstatus;
  var v_filter_status, v_note;
  
  if (ValType(_type) == V_INTEGER)
     ptype = _type;
  else 
     ptype = 2;
  end;
  if (ValType(_status) == V_INTEGER)
     pstatus = _status;
  else 
     pstatus = 1;
  end;

  if(ValType(_addstatus) == V_STRING)
     v_filter_status = " b.t_status not in ("+_addstatus+")";
  else
     v_filter_status = " b.t_status <> 4 ";
  end;

  if(ValType(_note) == V_STRING)
     v_note = _note;
  else 
     v_note = "";
  end;


  sql_str = "SELECT t_recid, t_objectid, t_status, t_type "+
            "  FROM uTableProcessEvent_dbt a "+
            " WHERE t_objecttype = :object_type "+
            "   AND t_objectid = :object_id "+
            "   AND t_recid = ( SELECT MAX(b.t_recid) "+
            "                     FROM uTableProcessEvent_dbt B "+
            "                    WHERE b.t_objecttype = a.t_objecttype "+
            "                      AND b.t_objectid = a.t_objectid "+
            "                      AND " + v_filter_status + ") ";
  cmd = RSDCommand(sql_str);
  cmd.AddParam("object_type", RSDBP_IN, _objecttype);
  cmd.AddParam("object_id", RSDBP_IN, _objectid);
  rs = RSDRecordSet(cmd);
  if (rs.movenext)
    reqid = rs.value("t_recid");
  end;
  rs.close; rs = null; cmd.close; cmd = null;
  
  if (reqid > 0) // запись есть
  else
    sql_str = " INSERT INTO uTableProcessEvent_dbt( t_timestamp, t_objecttype, t_objectid, t_type, t_status, t_note ) "+
              " VALUES( sysdate, :object_type, :object_id, :type, :status, :note_value) ";
    cmd = RSDCommand(sql_str);
    cmd.AddParam("object_type", RSDBP_IN, _objecttype);
    cmd.AddParam("object_id", RSDBP_IN, _objectid);
    cmd.AddParam("type", RSDBP_IN, ptype);
    cmd.AddParam("status", RSDBP_IN, pstatus);
    cmd.AddParam("note_value", RSDBP_IN, v_note);
    cmd.execute;
    cmd.close; cmd = null;
  end;
end;


class c_IntegrationSymbolicIdentifierXType
   var ObjectId : string;
   var SystemId : string;
   var SystemNodeId : string;
end;

class c_IntegrationDictionaryRecordXType
   var RecordCode       : string; 
   var RecordTitle      : string;
   var Note             : string;
   var SystemId         : string;
   var SystemNodeId     : string;
   var Desc             : string;
   var DictionaryCode   : string;
end;


macro getValueFromProperty(_obj, _nameproperty, _nametag, _isrequired)
   var res: variant;
   var vnametag;
   var err_txt;
   res = uTryToGetPropS(_obj, _nameproperty);
   if (_isrequired)
      if(ValType(res) == V_UNDEF)
         vnametag = _nametag+"."+_nameproperty;
         err_txt = ERR_TEXT_NO_IN_MSG +": "+vnametag;
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM));
      end;
   end;
   
   return res;
end;

macro getDictionaryFromProperty (_obj, _nameproperty, _nametag, _isrequired)
   var res: c_IntegrationDictionaryRecordXType;
   var vnametag = _nametag+"."+_nameproperty;
   var err_txt;
   var aux_buff;

   aux_buff = uTryToGetPropS(_obj, _nameproperty);
   if(ValType(aux_buff) == V_UNDEF)
      if (_isrequired)
         err_txt = ERR_TEXT_NO_IN_MSG +": "+vnametag;
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM));
      end;
   else
      res = c_IntegrationDictionaryRecordXType;
      res.RecordCode     = getValueFromProperty(aux_buff, "RecordCode"      , vnametag, true);
      res.RecordTitle    = getValueFromProperty(aux_buff, "RecordTitle"     , vnametag);
      res.Note           = getValueFromProperty(aux_buff, "Note"            , vnametag);
      res.SystemId       = getValueFromProperty(aux_buff, "SystemId"        , vnametag);
      res.SystemNodeId   = getValueFromProperty(aux_buff, "SystemNodeId"    , vnametag);
      res.Desc           = getValueFromProperty(aux_buff, "Desc"            , vnametag);
      res.DictionaryCode = getValueFromProperty(aux_buff, "DictionaryCode"  , vnametag);
   end;
      
   return res;
end;

macro getSymbolFromProperty(_obj, _nameproperty, _nametag, _isrequired)
   var res: c_IntegrationSymbolicIdentifierXType;
   var vnametag = _nametag+"."+_nameproperty;
   var err_txt;
   var aux_buff;

   aux_buff = uTryToGetPropS(_obj, _nameproperty);
   if(ValType(aux_buff) == V_UNDEF)
      if (_isrequired)
         err_txt = ERR_TEXT_NO_IN_MSG +": "+vnametag;
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM));
      end;
   else
      res = c_IntegrationSymbolicIdentifierXType;
      res.ObjectId      = getValueFromProperty(aux_buff, "ObjectId"     , vnametag, true);
      res.SystemId      = getValueFromProperty(aux_buff, "SystemId"     , vnametag);
      res.SystemNodeId  = getValueFromProperty(aux_buff, "SystemNodeId" , vnametag);
   end;
   
   return res;
end;

/* BIQ-7089 Гераськина Т.В. Сервис используется не только для закрытия, но и для обновления договора */
/* _typeaction: 1 - обновление, 3 - закрытие, 2 - вызов при смене ТП у договора  */
macro InsEvent_UpdateContract(_contrid, _typeaction)

   const CV_TYPE = 5100; /* Тип Запуск выгрузки закрытия */

   var v_sql :string = "",
       v_cmd;

   v_sql =         "INSERT INTO uTableProcessEvent_dbt( t_objecttype, t_objectid, t_type, t_status, t_timestamp ) ";
   v_sql = v_sql + " ( SELECT :p_objecttype1,:p_objectid1, :p_typeaction, 1, SYSDATE FROM DUAL ";
   v_sql = v_sql + "   WHERE NOT EXISTS(SELECT t_recid FROM utableprocessevent_dbt ";
   v_sql = v_sql + "                     WHERE t_objecttype = :p_objecttype2 ";
   v_sql = v_sql + "                       AND t_objectid = :p_objectid2 ";
   v_sql = v_sql + "                       AND t_type = :p_typeaction ";
   v_sql = v_sql + "                       AND TRUNC(t_timestamp) = TRUNC(SYSDATE) ";
   v_sql = v_sql + "                       AND t_status IN (1, 2)) ";  /* статус 4 исключаем, так как обновлений может быть несколько. Наверное. */
   v_sql = v_sql + "     AND ROWNUM = 1 ) "; /* На всякий случай */

   v_cmd = RSDCommand(v_sql);
   v_cmd.addParam("p_objecttype1", RSDBP_IN, CV_TYPE);
   v_cmd.addParam("p_objectid1", RSDBP_IN, _contrid);
   v_cmd.addParam("p_typeaction1", RSDBP_IN, _typeaction);
   v_cmd.addParam("p_objecttype2", RSDBP_IN, CV_TYPE);
   v_cmd.addParam("p_objectid2", RSDBP_IN, _contrid);
   v_cmd.addParam("p_typeaction2", RSDBP_IN, _typeaction);
   v_cmd.execute();

   v_cmd.close(); v_cmd = null; v_sql = null;

onError(err)

end;

// проверка наличия примечания с номером договора Депо - косвенный признак, что выгрузка была успешной
macro CheckNoteConractDepo(_dlcontrid)
  var sql_str, cmd, rs;
  var objecttype = 207, objectid = String(_dlcontrid:o:34);
  var res = 0;

  sql_str = "select count(*) cnt from dnotetext_dbt n "+
            " where n.t_objecttype = :objecttype and n.t_notekind = :notekind "+
            "   and n.t_documentid = :dlcontrid and n.t_validtodate > sysdate ";
  cmd = RSDCommand(sql_str);
  cmd.AddParam("objecttype", RSDBP_IN, objecttype);
  cmd.AddParam("notekind", RSDBP_IN, CONTRACT_NOTEKIND_Depo_ContractNumber);
  cmd.AddParam("dlcontrid", RSDBP_IN, objectid);
  rs = RSDRecordSet(cmd);
  if (rs.movenext)
     res = rs.value("cnt");
  end;
  return res;
end;

// BIQ-9825 Гераськина Т.В.
/* статусная модель - получение положительного ответа из ММВБ */
macro UpdateStatusContractFromMOEX(_dlcontrid);
   var new_status;
   var err, AttrCode=0;
   var objecttype = 207, objectid = String(_dlcontrid:o:34);

   GetMainObjAttr(err, objecttype, objectid, CONTRACT_CATEGORY_STATUS, AttrCode);

   // BIQ-9825 Гераськина Т.В.
   // при получении ответа от ММВБ, если ответ от Депозитария уже был, то статус = Обработка завершена (3), 
   //   если не было = Проведена регистрация на ММВБ (5)

   new_status = 5;
   
   if (valType(AttrCode) == V_UNDEF)
      AttrCode = 0;
   end;
   if ((AttrCode == 0) or (AttrCode == 4))  // категория пустая или статус "новый"
     new_status = 5;  // ММВБ удачно
   elif (AttrCode == 1)  // получено подтверждение депозитария 
     new_status = 3;  // обработка завершена
   elif (AttrCode == 2) // получено подтверждение АСОА 
     // в BIQ-7089 невозможная ветка
     if (CheckNoteConractDepo(_dlcontrid) > 0 )
        new_status = 3;    // обработка завершена
     else 
        new_status = 5;
     end;
   elif (AttrCode == 5)  // как это понимать? 
     new_status = 5;  //  ММВБ удачно
   elif (AttrCode == 3)  // обработка завершена (второй раз пришел запрос?)
     //err_txt = "Текущее состояние договора: <Обработка завершена>. Обновление невозможно";
     //RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
     new_status = 3;     // обработка завершена
   end;

   if (AttrCode != new_status)
      DisconnectObjAttr(objecttype, objectid, CONTRACT_CATEGORY_STATUS, 0);
      ConnectObjAttr(err, objecttype, objectid, CONTRACT_CATEGORY_STATUS, new_status);

      if (new_status == 3) // если обработка завершает цепочку, то отправляются уведомления
        PutInProcess(5207, _dlcontrid); // для отправки уведомления
        PutInProcess(6207, _dlcontrid); // для UploadDoc
        InsEvent_UpdateContract(_dlcontrid, 1); /* BIQ-7089 перевод в состояние "действующий" */
      end;
   end;

end;



/* статусная модель - получение ответа из Депозитария */
macro UpdateStatusContractFromDepo(_dlcontrid);
   var new_status;
   var err, AttrCode;
   var objecttype = 207, objectid = String(_dlcontrid:o:34);

   GetMainObjAttr(err, objecttype, objectid, CONTRACT_CATEGORY_STATUS, AttrCode);

   // BIQ-7089 Гераськина Т.В.
   // отправка досье в АСОА больше не производится, статус с "Новый" (=4) меняется на "Обработка завершена" (=3)
   // старая смена статусов оставлена для истории

   // BIQ-9825 Гераськина Т.В.
   // в смену статусов вмешалась ММВБ: регистрация онлайн может быть до или после запроса в Депозитарий
   new_status = 1;
   //new_status = 3;

   
   if (valType(AttrCode) == V_UNDEF)
      AttrCode = 0;
   end;

   if (AttrCode == 5)  // если статус = Проведена регистрация на ММВБ, то доп.проверка не нужна, и так понятно, что онлайн, и что ОК
   elif (AttrCode == 3)  // если обработка завершена, нечего проверять
   else 
      // BIQ-7033 проверка статуса регистрации на бирже
      var send_mes = true;
      var contr_str = "";
      var sql_str, cmd, rs;

      sql_str = "select m.t_sendmesstate, s.t_number, s.t_datebegin, s.t_name, "+
                "       case when length(m.t_respdata) > 1 then "+
                "          lower(EXTRACTVALUE(XMLType(m.t_respdata), '/MICEX_ERROR','xmlns=""http://www.moex.com/application/output""')) "+
                "       else '' end t_respdata "+
                "  from ddlcontrmsg_dbt m, ddlcontr_dbt d, dsfcontr_dbt s "+                                                     
                " where m.t_dlcontrid = d.t_dlcontrid and s.t_id = d.t_sfcontrid "+
                "   and  m.t_dlcontrid = :p_id and t_kind in (1,2) and t_isonlinesendmes = chr(88) /*and t_respdate > to_date('01.01.0001','dd.mm.yyyy')*/ "+
                " order by t_senddate desc ";
      cmd = RSDCommand(sql_str);
      cmd.AddParam("p_id", RSDBP_IN, _dlcontrid);
      rs = RSDRecordSet(cmd);
      if (rs.movenext) 
         if (rs.value("t_sendmesstate") != 210) // последняя не успешная заявка
            // def-27825 SD8265368||545519||301398||Ошибка ММВБ. duplicate key value.. already exist (86 договоров)
            if ( ( (rs.value("t_sendmesstate") == 102) or (rs.value("t_sendmesstate") == 103) ) and  
                 (Index( rs.value("t_respdata"), "duplicate") > 0) )
               send_mes = true;
            else 
               send_mes = false;
               contr_str = rs.value("t_number")+" от "+date(rs.value("t_datebegin"))+" "+rs.value("t_name");
            end;
         end;
      end;
      rs.close; cmd.close; rs = null; cmd = null;

      if (send_mes) // или успешно отправлено, или не онлайн
         AttrCode = 5; // те же действия, что и при "Проведена регистрация на ММВБ"
      end;
   end;

   if ((AttrCode == 0) or (AttrCode == 4))  // категория пустая или статус "новый"
     new_status = 1;     // Депозитарий подтверждено
     //new_status = 3;
   elif (AttrCode == 1)  // получено подтверждение депозитария (второй раз пришел запрос?)
     new_status = 1;     // Депозитарий подтверждено
     // в BIQ-7089 невозможная ветка 
     //new_status = 3;
   elif (AttrCode == 2) // получено подтверждение АСОА 
     // в BIQ-7089 невозможная ветка
     //new_status = 3;    // обработка завершена
     new_status = 1;
   elif (AttrCode == 3)  // обработка завершена (второй раз пришел запрос?)
     //err_txt = "Текущее состояние договора: <Обработка завершена>. Обновление невозможно";
     //RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
     new_status = 3;     // обработка завершена
   elif (AttrCode == 5)  // ММВБ успешно
     new_status = 3;     // обработка завершена
   end;


   if (AttrCode != new_status)
      DisconnectObjAttr(objecttype, objectid, CONTRACT_CATEGORY_STATUS, 0);
      ConnectObjAttr(err, objecttype, objectid, CONTRACT_CATEGORY_STATUS, new_status);
   end;

   if (new_status == 3) // если обработка завершает цепочку, то отправляются уведомления
       //PutInProcess(objecttype, _dlcontrid); // для UpdateDossier BIQ-7089 Гераськина Т.В. отправка досье в АСОА больше не производится
       PutInProcess(5207, _dlcontrid); // для отправки уведомления
       PutInProcess(6207, _dlcontrid); // для UploadDoc
       InsEvent_UpdateContract(_dlcontrid, 1); /* BIQ-7089 перевод в состояние "действующий" */
   end;

onError(err)
   var err_txt = String(err.message," Модуль: ", err.Module, " строка: ", err.Line, ". ",getFullCmdErrorText(cmd));
   runError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
end;

// BIQ-7335 Вид объекта по его коду
macro FindObjectKindNRD(_code)
   var sql_str, rs, cmd;
   var res = -1;
   
   sql_str = "select t_element from dnptxkind_dbt where t_code =:code";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("code", RSDBP_IN, _code);
   rs = RSDRecordSet(cmd);
   if (rs.movenext) // код уникальный
      res = rs.value(0);
   end;
   
   return res;
onError(err)
   return -1;
end;

// BIQ-7382 формирование оповещения для Депозитария по почте
private class (c_usr_tbl_base) c_usr_tbl_uTableProcessEvent()
   private class gen_uTableProcessEvent()
      var T_RECID :integer,
          T_TIMESTAMP :date,
          T_OBJECTTYPE :integer,
          T_OBJECTID :integer,
          T_TYPE :integer,
          T_STATUS :integer,
          T_NOTE :string,
          T_MESSAGEID :integer,
          T_RESULTCODE :string,
          T_RESULTTEXT :string,
          T_ATTEMPTS :integer;
   end;

   private macro init_table_obj()
      new_val_obj = gen_uTableProcessEvent();
      where_val_obj = gen_uTableProcessEvent();
   end;

   Initc_usr_tbl_base("uTableProcessEvent_dbt");

   init_table_obj();
end;

macro  SendShortNotification(_dlcontrid, _objecttype, _objectid, _number, _datebegin, _shortname)
   var sql_str, rs, cmd;
   var err,AttrDepo;

   sql_str = " SELECT sf.*                                               "+
             "   FROM ddlcontrmp_dbt mp, dsfcontr_dbt sf                 "+
             "  WHERE mp.T_SFCONTRID = sf.T_ID                           "+
             "    AND mp.T_DLCONTRID = :dlcontrid AND sf.T_SERVKIND = 1  "+
             "    AND sf.t_servkindsub = 8 ";

   cmd = RSDCommand(sql_str);
   cmd.addParam("dlcontrid", RSDBP_IN, _dlcontrid);
   rs = RSDRecordSet (cmd);

   if (rs.movenext() )    // фондовый рынок
      GetMainObjAttr(err, _objecttype, _objectid, 180, AttrDepo);
      if (AttrDepo != 1)
         if (AttrDepo == 2)
            DisconnectObjAttr(_objecttype, _objectid, 180, 0);
            ConnectObjAttr(err, _objecttype, _objectid, 180, 1);
         else
            var v_email = c_email_proc_env();
                 
            var emailText = "Информируем о заключении брокерского соглашения ("+
                             _number+" от "+              
                             string(date(_datebegin))+")_"+                  
                             _shortname;
            v_email.m_set_msg_head(emailText);
            v_email.m_add_row_to_msg_text(emailText);
            v_email.m_save_to_submit_grp(CONTRACT_EMAIL_GRP, true);
            v_email.m_submit_email_synch();
            ConnectObjAttr(err, _objecttype, _objectid, 180, 1);

            // BIQ-7031
            var ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
            ProcessEventTbl.New_Val_Obj.T_STATUS = 2;
            ProcessEventTbl.New_Val_Obj.T_OBJECTTYPE = 99;
            ProcessEventTbl.New_Val_Obj.T_OBJECTID = _dlcontrid;
            ProcessEventTbl.New_Val_Obj.T_TYPE = -1;
            ProcessEventTbl.New_Val_Obj.T_TIMESTAMP = dttm(date(), time());
            ProcessEventTbl.New_Val_Obj.T_NOTE = "Признак нового договора, для уведомления для Депозитария";
            ProcessEventTbl.Insert() 
            // BIQ-7031

         end;
      end;
   end;
end;

// BIQ-7033 вставка события для биржи
// так как необходимо создавать событие после основной транзакции, вынесено в отдельную функцию
// входящий параметр - массив ID договоров
macro InsertEventForMoex (p_dlcontrid_arr)
   var temp_id;
   var sql_str, rs;
   if ( ValType(p_dlcontrid_arr) == V_GENOBJ )
     if (p_dlcontrid_arr.size > 0)
        for (temp_id, p_dlcontrid_arr)
          if (temp_id > 0)
               //gtv: проверка на дублирование, так как необработанная запись нужна одна
               sql_str = "select count(*) cnt from dfuncobj_dbt "+
                         " where t_objecttype = 7033 and t_objectid = "+temp_id+" and t_funcid = 7033 and t_state in (0, 20, 1)";
               rs = RSDRecordSet(sql_str);
               if (rs.movenext)
                  if (rs.value("cnt") == 0)
                      ExecMacroFile("usequence_job.mac", "InsertSequenceJobUsrObj", 
                                        temp_id,
                                        7033,
                                        temp_id,
                                        "7033",
                                        Null,
                                        null);
                  end;
               end;
               rs.close; rs = null; 
          end;
        end;
      end;
   end;
end;


//BIQ-7031 определение, новый ли договор
//используется в интеграции и для ручного запуска
macro CheckContractForNovelty(_dlcontrid)
   var v_error;
   var AttrDepo, new_depo = false, sql_str, cmd, rs;

   // Проверим категорию во избежание пересечения планировщиков
   GetMainObjAttr(v_error, 207, string(_dlcontrid:34:o), 180, AttrDepo);
   if (AttrDepo != 1)
      if (AttrDepo == 2)
      else
         new_depo = true;
      end;
   end;

   if (not new_depo) // возможно, категория заполнена только что
     sql_str = "select t_recid from utableprocessevent_dbt "+
               " where t_objecttype = 99 and t_objectid = :p_id and t_status = 2 and t_type = -1";
     cmd = RSDCommand(sql_str);
     cmd.AddParam("p_id", RSDBP_IN, _dlcontrid);
     rs = RSDRecordSet(cmd);
     if (rs.movenext) // хотя бы одно событие найдено
        new_depo = true;
     end;
     rs.close; cmd.close; rs = null; cmd = null;
   end;

   return new_depo;
end;

//BIQ-7031 определение, новый ли договор
//используется в интеграции и для ручного запуска
macro FixEvent99(_dlcontrid)
   var sql_str, cmd;

   //зафиксируем событие 99, все, какие есть в статусе 2 по договору
   sql_str = "update utableprocessevent_dbt "+
             "   set t_status = 4 "+
             " where t_objecttype = 99 and t_objectid = :p_id and t_status = 2 and t_type = -1";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("p_id", RSDBP_IN, _dlcontrid);
   cmd.execute;
   cmd.close; cmd = null;
end;

macro GetMpCodeSpb(_dlcontrid, _marketid)
   var sql_str, cmd, rs;
   var res = "-1";

   sql_str = "SELECT dl.t_dlcontrid, dl.t_sfcontrid,sf.t_number, sf.t_partyid, mp.t_marketid, mp.t_mpcode "+
             "  FROM dsfcontr_dbt sf, "+
             "       ddlcontr_dbt dl, "+
             "       dparty_dbt p, "+
             "       ddlcontrmp_dbt mp, "+
             "       dsfcontr_dbt cntr "+
             " WHERE sf.t_id = dl.t_sfcontrid  "+
             "   AND sf.t_partyid = p.t_partyid "+ 
             "   AND dl.t_dlcontrid = :p_dlcontrid "+
             "   AND cntr.t_id = mp.t_sfcontrid  "+
             "   AND mp.t_dlcontrid = dl.t_dlcontrid "+
             "   AND mp.t_mpclosedate = to_date('01.01.0001','dd.mm.yyyy') "+
             "   AND cntr.t_servkind = 1 "+
             "   AND MP.T_MARKETID = :p_marketid";
   cmd = RSdCommand(sql_str);
   cmd.AddParam("p_dlcontrid", RSDBP_IN, _dlcontrid);
   cmd.AddParam("p_marketid", RSDBP_IN, _marketid);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      res = rs.value("t_mpcode");
   end;
                 
   return res;
end;


// получение кода по бирже для договора
// прямое обращение к базе
macro GetDLObjCode_ByObjectid(in_objectid, in_objecttype, in_codekind)
  var mCode : string = "";
  var query, rs;
  var params : TArray;
  query =         "SELECT t_Code ";
  query = query + "  FROM ddlobjcode_dbt ";
  query = query + " WHERE t_ObjectType = :ObjectType ";
  query = query + "   AND t_CodeKind = :CodeKind ";
  query = query + "   AND t_ObjectID = :ObjectID ";
  query = query + "   AND t_BankCloseDate = TO_DATE('01010001', 'DDMMYYYY')";
  params = makeArray( SQLParam("ObjectType", in_objecttype)
                     ,SQLParam("CodeKind"  , in_codekind)
                     ,SQLParam("ObjectID"  , in_objectid)
                     );
  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext()) // если множественный, значит, первый по порядку
    mCode = rs.value(0);
  end;
  rs.close(); rs = null; query = null;

  return mCode;
end;

// поиск соответствия кодов
macro FindCodeMatch(_code_abs)
  var sql_str, cmd, rs, res="-1";

  sql_str = "select t_code_vtb "+
            "  from usr_code_match "+
            " where t_code_abs = :code_abs "+
            "   and t_partyid = 0";
  cmd = RSDCommand(sql_str);
  cmd.AddParam("code_abs", RSDBP_IN, _code_abs);
  rs = RSDRecordSet(cmd);
  if (rs.movenext)
     res = rs.value("t_code_vtb");
  end;
  rs.close; cmd.close;

  return res;
end;

macro MarkCodesMatch(_code_abs, _partyid);
  var sql_str, cmd;
  sql_str = "update usr_code_match "+
            "   set t_partyid = :partyid "+
            " where t_code_abs = :code_abs; ";
  cmd = RSDCommand(sql_str);
  cmd.AddParam("partyid", RSDBP_IN, _partyid);
  cmd.AddParam("code_abs", RSDBP_IN, _code_abs);
  cmd.execute;
  cmd.close;
end;


class c_contract_vtb
  var contract_number,
      contract_date,
      r
end;

/* на момент поиска соответствия договора код уже обработан и обновлен в таблице */
/* одинаково справедливо и для когда-то обработанного клиента, и для только что обработанного */
macro FindContractMatch(_partyid, _iis)
  var sql_str, cmd, rs;
  var res = c_contract_vtb;
  var v_iis=0;
  res.r = "-1";

  if (_iis) // логическое
     v_iis = 1;
  else 
     v_iis = 0;
  end;
  sql_str ="select contract.t_code_vtb, contract.t_iis, contract.t_contract_number_vtb, "+
           "        to_date(substr(contract.t_contract_date,1,10),'yyyy-mm-dd') dt, "+
           "        contract.rowid "+
           "  from "+
           "     usr_contract_match contract, "+                                                                      
           "     usr_code_match codes "+                                                                             
           "where codes.t_code_vtb = contract.t_code_vtb and codes.t_partyid = :partyid "+
           "  and contract.t_iis = :iis "+
           "  and contract.t_dlid = 0";
  cmd = RSDCommand(sql_str);
  cmd.AddParam("code_vtb", RSDBP_IN, _partyid);
  cmd.AddParam("iis", RSDBP_IN, _iis);
  rs = RSDRecordSet(cmd);
  if (rs.movenext)
     res.contract_number = rs.value("t_contract_number_vtb");
     res.contract_date = date(rs.value("dt"));
     res.r = rs.value("rowid");
  end;
  return res;
end;


macro UpdateContractmatch(_r, _dlid)
  var sql_str, cmd;

  sql_str = "update usr_contract_match set t_dlid = :dlid where rowid = :r";
  cmd = RSDCommand(sql_str);
  cmd.AddParam("dlid", RSDBP_IN, _dlid);
  cmd.AddParam("r", RSDBP_IN, _r);
  cmd.execute;
  cmd.close;
end;


// BIQ-8786 тарифные планы
macro GetTariffNotetext(p_ObjectType, p_objectid, p_notekind, p_date, p_validtodate)
   var sql_str, rs, cmd;
   var res = NULL;
   sql_str = " select t_notekind, trim(replace(rsb_struct.getstring(t_text), chr(0), '')) notevalue, "+
             "        t_date, t_validtodate "+
             " from dnotetext_dbt "+
             "where t_objecttype = :p_ObjectType and t_documentid = :p_objectid and t_notekind = :p_notekind "+
             "  and t_validtodate between :p_date and :p_validtodate";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("p_ObjectType", RSDBP_IN, p_ObjectType);
   cmd.AddParam("p_objectid", RSDBP_IN, p_objectid);
   cmd.AddParam("p_notekind", RSDBP_IN, p_notekind);
   cmd.AddParam("p_date", RSDBP_IN, p_date);
   cmd.AddParam("p_validtodate", RSDBP_IN, p_validtodate);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      res = rs.value("notevalue");
   end;
   return res;
end;

// контейнер для исходящих сервисов - сбор информации по ТП по dsfcontr_dbt.t_id
macro GetTariffRecord(_sfcontrid, _dlcontrid)
   var sql_str, cmd, rs;
   var res = TArray;
   var temp;
   var ai = 0;
   var objectid = String(_dlcontrid:o:34);
   var objecttype = 207;
   var flag_notpersonal = true;
   var tariff_id_repo, tarif_date;
   var binddate, unbinddate, unbinddate2;
   var date_begin;
   var tariff_repo = TArray;
   
   sql_str =" select sfplan.t_id, sfplan.t_sfcontrid, sfplan.t_sfplanid, "+
            "        sfplan.t_begin as BindDate, sfplan.t_end as UnbindDate, "+
            "        tp.t_sfplanid, tp.t_num as TariffId, tp.t_name as TariffPlan, "+
            "        tp.t_begin as BeginDate, tp.t_end as EndDate, decode(tp.t_comment,chr(1),' ',tp.t_comment) t_comment, tp.t_hidden, "+
            "        nvl((select 1 from dobjatcor_dbt where t_objecttype = 57 and t_groupid = 101 "+
            "              and t_attrid = 1 and t_object = lpad(tp.t_sfplanid,10,'0') and t_validtodate > sysdate),0) as ind "+
            "  from dsfcontrplan_dbt sfplan, "+
            "         dsfplan_dbt tp, "+
            "         dsfcontr_dbt sf "+
            "  where sfplan.t_sfcontrid = sf.t_id "+
            "  and sfplan.t_sfplanid = tp.t_sfplanid "+
            "  and ( sfplan.t_end = to_date('01010001','ddmmyyyy') or sfplan.t_end >= :pdate ) "+
            "  and sf.t_id = :p_sfcontrid ";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("pdate", RSDBP_IN, date());
   cmd.AddParam("p_sfcontrid", RSDBP_IN, _sfcontrid);
   rs = RSDRecordSet(cmd);
   while (rs.movenext)
      temp = c_Tariff;
   
      temp.TariffId = c_IntegrSymId;
      temp.TariffId.ObjectId = rs.value("TariffId");
      temp.TariffId.SystemId = "SOFR";
      temp.TariffId.SystemNodeId = "0000";
      
      temp.TariffPlan = c_IntegrDictRec;
      temp.TariffPlan.RecordCode = rs.value("TariffPlan");
      temp.TariffPlan.SystemId = "SOFR";
      temp.TariffPlan.SystemNodeId = "0000";
      
      temp.TariffKind = c_IntegrDictRec;
      temp.TariffKind.RecordCode = "BROKERAGE";
      temp.TariffKind.SystemId = "SOFR";
      temp.TariffKind.SystemNodeId = "0000";
      
      if (rs.value("ind") == 1)
         temp.IsIndividual = true;
         //flag_notpersonal = false; //индивидуальные тарифы тоже выгружаются
      else 
         temp.IsIndividual = false;
      end;
      
      temp.Comment      = rs.value("t_comment");
//      temp.Description  = "";
      temp.BeginDate    = rs.value("BeginDate");
      temp.EndDate      = rs.value("EndDate");
      if ( (temp.EndDate == date(0,0,0)) or (temp.EndDate == " 1.01.0001") )
         temp.EndDate = null;
      end;
      temp.BindDate     = rs.value("BindDate");
      tarif_date = temp.BindDate;
      temp.UnbindDate   = rs.value("UnbindDate");
      if ( (temp.UnbindDate == date(0,0,0)) or (temp.UnbindDate == " 1.01.0001") )
         temp.UnbindDate = null;
      end;
      
      if (rs.value("t_hidden") == StrFor(88))
         temp.IsHidden = true;
      else 
         temp.IsHidden = false;
      end;
      
      res.value(ai) = temp;
      temp = null;
      ai = ai+1;
   end;
   
   if (flag_notpersonal)
      tariff_repo.size = 0;
      ai = 0;
      sql_str = "   select t_notekind, rsb_struct.getdate(t_text) notevalue, "+
                "          t_date, t_validtodate "+
                "     from dnotetext_dbt "+
                "    where t_objecttype = :1 and t_documentid = :2 and t_notekind = :3 "+
                " order by t_validtodate desc";
      cmd = RSDCommand(sql_str);
      cmd.AddParam("1", RSDBP_IN, ObjectType);
      cmd.AddParam("2", RSDBP_IN, objectid);
      cmd.AddParam("3", RSDBP_IN, CONTRACT_NOTEKIND_BINDDATE_REPO);
      rs = RSDRecordSet(cmd);
      while (rs.movenext)
         binddate = rs.value("notevalue");
         if (binddate == date(0,0,0))
         else 
            temp = c_Tariff;
            temp.BindDate = binddate;
            temp.UnBindDate = rs.value("t_validtodate");
               
            tariff_id_repo = GetTariffNotetext(ObjectType, objectid, CONTRACT_NOTEKIND_TARIFFID_REPO, temp.BindDate, temp.UnBindDate);
            
            if (ValType(tariff_id_repo) == V_UNDEF)
               temp = NULL;
            elif (tariff_id_repo == "")
               temp = NULL;
            else
               temp.TariffId = c_IntegrSymId;
               temp.TariffId.ObjectId = tariff_id_repo;
               temp.TariffId.SystemId = "SOFR";
               temp.TariffId.SystemNodeId = "0000";

               temp.TariffPlan = c_IntegrDictRec;
               temp.TariffPlan.RecordCode = GetTariffNotetext( ObjectType, objectid, CONTRACT_NOTEKIND_TARIFFPLAN_REPO, temp.BindDate, temp.UnBindDate);
               if (not temp.TariffPlan.RecordCode)
                   temp.TariffPlan.RecordCode = "Пусто";
               end;
               temp.TariffPlan.SystemId = "SOFR";
               temp.TariffPlan.SystemNodeId = "0000";
             
               temp.TariffKind = c_IntegrDictRec;
               temp.TariffKind.RecordCode = "REPO";
               temp.TariffKind.SystemId = "SOFR";
               temp.TariffKind.SystemNodeId = "0000";
            end;
            
            if (ValType(temp) != V_UNDEF)
               tariff_repo.value(ai) = temp;
               temp = null;
               ai = ai+1;
            end;
            
            if (binddate <= date())
               break;
            end;
         end;
      end;
      
      ai = 0;
      while (ai < tariff_repo.size)
         unbinddate = tariff_repo.value(ai).unbinddate;
         if (unbinddate == date(31,12,9999))
            tariff_repo.value(ai).unbinddate = NULL;
         end;
         for (temp, res)
            unbinddate2 = temp.unbinddate;
            if (Valtype(unbinddate2) == V_UNDEF)
               unbinddate2 = date(31,12,9999);
            end;
            if (unbinddate2 == date(0,0,0))
               unbinddate2 = date(31,12,9999);
            end;

            if ( (unbinddate2 == date(31,12,9999)) and (unbinddate == date(31,12,9999)) )
               tariff_repo.value(ai).IsIndividual = temp.IsIndividual;
            elif ( (unbinddate2 < date(31,12,9999)) and (unbinddate < date(31,12,9999)) )
               if ( unbinddate2 >= unbinddate) 
                  tariff_repo.value(ai).IsIndividual = temp.IsIndividual;
               end;
            end;
         end;
         
         if (Valtype(tariff_repo.value(ai).IsIndividual) == V_UNDEF)
            tariff_repo.value(ai).IsIndividual = false; 
         end;

         ai = ai+1;
      end;
         
      ai = res.size();
      for (temp, tariff_repo)
         if (ValType(temp) != V_UNDEF)
            res.value(ai) = temp;
            ai = ai+1;
         end;
      end;
      
   end;
   
   return res;
end;

//gtv для DEF-28122 - нужна возможность добавлять строковые параметры в dfuncobj
macro InsertSequenceJobUsrObjString(p_ObjectId, p_ObjectType, p_ObjectTypeCode, p_Param, p_Priority)
// InsertSequenceJobUsrObj не позволяет добавить параметры со строковыми значениями
  var sql_str, cmd;
  var v_funcobjid = 0;

sql_str = 
"declare "+
"  v_ObjectId number(10) := :p_ObjectId; "+
"  v_ObjectType number(10) := :p_ObjectType; "+
"  v_ObjectTypeCode varchar2(200) := :p_ObjectTypeCode; "+
"  v_Param  varchar2(500) := :p_Param; "+
"  v_Priority number(10) := :p_Priority; "+
"  v_element number(10); "+
"  v_funcid number(10); "+
"  v_funcobjid number(10) := 0; "+
"begin "+
"  if v_Priority is null then "+
"     v_Priority := 0; "+
"  end if; "+
"  v_funcid := 0;  "+
"  begin "+
"     select l.t_element, f.t_funcid into v_element, v_funcid "+
"       from dllvalues_dbt l, dfunc_dbt f "+
"      where f.t_funcid = l.t_flag and l.t_list = USR_PKG_IMPORT_SOFR.GetOBJECT_SYNCH "+
"        and l.t_code = v_ObjectTypeCode "+
"        and l.t_element > 5001; "+
"  exception "+
"     when no_data_found then  v_funcid := 0; "+
"  end; "+
"  if v_funcid > 0 then "+
"     v_Param := to_char(v_ObjectId)||';'||to_char(v_ObjectType)||';'||v_Param; "+
"     insert into dfuncobj_dbt( T_OBJECTTYPE, T_OBJECTID, T_FUNCID, T_PARAM, T_PRIORITY ) "+
"     values (v_element, v_ObjectId, v_funcid, v_Param, v_Priority) "+
"     returning t_id into v_funcobjid; "+
"  end if; "+
"  :p_ret := v_funcobjid; "+
"end;";

   cmd = RSDCommand(sql_str);
   cmd.AddParam("p_ObjectId", RSDBP_IN, p_ObjectId);
   cmd.AddParam("p_ObjectType", RSDBP_IN, p_ObjectType);
   cmd.AddParam("p_ObjectTypeCode", RSDBP_IN, p_ObjectTypeCode);
   cmd.AddParam("p_Param", RSDBP_IN, p_Param);
   cmd.AddParam("p_Priority", RSDBP_IN, p_Priority);
   cmd.Addparam("p_ret", RSDBP_OUT, V_INTEGER);
   cmd.execute;
   v_funcobjid = cmd.value("p_ret");
   cmd.close;

   return v_funcobjid;
end;

// получение номера типа данных по имени сервиса
macro GetNumDataType(pnameservice)
   var res = -1;
   var sql_str, cmd, rs;

   sql_str = "select t_id from DDATATYPEWS_DBT where T_PARMIP = :pservice";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("pservice", RSDBP_IN, pnameservice);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      res = rs.value(0);
   end;

   return res;
end;

/**
@brief Проверка, нужно ли отправлять данные в CDI
@param[in] in_partyid ID субъекта
@param[in] in_date дата 
@return true - нужно отправлять данные / false - не нужно

В CDI отправляются данные по ЮЛ или по ФЛ с признаком ИП/ФЛЧП в категории 150
Не отправляются данные по субъектам с признаком Эмитент DEF-87146
*/
macro NeedSendCDI (in_partyid, in_date)
  var sql_str, cmd, rs;
  var res = false;

  sql_str = " SELECT 1 "+
            "   FROM dparty_dbt party "+
            "  WHERE party.t_partyid = :p_partyid "+
            "    AND (party.t_legalform = 1  "+
            "        OR (party.t_legalform = 2 and party.t_locked = chr(0) and "+
            "             (EXISTS (SELECT 1 "+
            "                        FROM dobjatcor_dbt  o, "+
            "                             dobjattr_dbt a "+
            "                       WHERE o.t_objecttype = :objt "+
            "                         AND o.t_groupid = :gr "+
            "                         AND o.t_object = LPAD (party.t_partyid, 10, '0') "+
            "                         AND o.t_objecttype = a.t_objecttype "+
            "                         AND o.t_groupid = a.t_groupid "+
            "                         AND o.t_validfromdate <= :p_date1 "+
            "                         AND o.t_validtodate > :p_date2 "+
            "                         AND a.t_numinlist in ('IE','PP') "+
            "                     ) "+ 
            "              OR (select prs.t_isemployer "+ 
            "                    from dpersn_dbt prs "+
            "                   where prs.t_personid = party.t_partyid "+
            "                 ) = chr(88) "+
            "             ) "+
            "           ) "+
            "         ) "+
            "    AND NOT EXISTS(SELECT 1 FROM dPartyOwn_dbt po WHERE po.t_partyID = party.t_partyID AND po.t_partyKind = 5 /*PTK_ISSUER*/) ";
  cmd = RSDCommand(sql_str);
  cmd.AddParam("p_partyid", RSDBP_IN, in_partyid);
  cmd.AddParam("objt", RSDBP_IN, OBJTYPE_PARTY);
  cmd.AddParam("gr", RSDBP_IN, CONTRACT_CATEGORY_CDI_PARTYTYPE);
  cmd.AddParam("p_date1", RSDBP_IN, in_date);
  cmd.AddParam("p_date2", RSDBP_IN, in_date);

  rs = RSDRecordSet(cmd);
  if (rs.moveNext() )
     res = true;
  end;
  return res;

end;

macro ConvertSumCurrency(amount:money, from:integer, to:integer, dt:date):money
  var sum = execStoredFunc( "RSI_RSB_FIInstr.ConvSum", V_MONEY, MakeArray(SqlParam("SumB",    amount),
                                                                          SqlParam("pFromFI", from),
                                                                          SqlParam("pToFI",   to),
                                                                          SqlParam("pbdate",  dt),
                                                                          SqlParam("pround",  2)
                                                                          ));

  if (valtype(sum) == 26) 
    sum = 0;
  end;
  return sum;
End;

/* Обрезать число, оставив только заданное количество символов (справа). Нули слева обрезаются. "0" прверащается в "1"
  strNum - обрезаемое число (как строка)
  len - количество символов, которое нужно оставить

  Примеры:
  CutNum("000", 6) = "1"
  CutNum("050", 6) = "50"
  CutNum("875654", 6) = "875654"
  CutNum("9875654", 6) = "875654"
  CutNum("200000654", 6) = "654"
*/
macro CutNum(strNum:string, len:integer):string
  if (StrLen(strNum) > len) 
    strNum = SubStr(strNum, StrLen(strNum) - (len - 1));
  end;

  var result:string = string(int(strNum)); //через конвертацию в int легко отбрасываются лидирующие нули

  if (result == "0") 
    result = "1";
  end;

  return result;
end;