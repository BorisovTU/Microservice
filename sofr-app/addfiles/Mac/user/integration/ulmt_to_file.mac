//А.Киселев 08.11.2018
import globals, oralib, likepy, rsexts;


private const EXPORT_FILENAME_TXT = "lmt";


private var CNum = string(UserNumber());



private macro FileRemove( PathTXT :string, PathExport :string, LastStr :string ) :bool //файл без рудиментов CLOB в конце

file TxtSource() txt;
file TxtDist() txt write;

var i :integer = 0;

 if( not Open( TxtSource, PathTXT,"ansi" )) 
  MsgBox( "Ошибка открытия файла импорта " + PathTXT );
  return false;
 end;

 if( not Open( TxtDist, PathExport,"ansi" ) )
  MsgBox( "Ошибка открытия файла импорта " + PathExport );
  Close(TxtSource);
  return false;
 end;

 while( Next( TxtSource ) )

  if( Index(TxtSource.str, LastStr) > 0 ) //последняя строка
//   Insert( TxtDist, TxtSource.str );
//   Insert( TxtDist, "" );
   Break;
  else
   Insert( TxtDist, TxtSource.str );
  end;

  i = i + 1;
 end;

 Close(TxtSource);
 Close(TxtDist);

 if(not RemoveFile(PathTXT))
  MsgBox("Не могу удалить временный файл " + PathTXT + ".");
  return false;
 end;


 return true;
end;


macro CreateOutputFileLMT( Export_Path :string) :integer
var Query :string = "",
    Params :TArray,
    Params_1 :TArray,
    DataSet :RsdRecordset,
    DataSet_1 :RsdRecordset,
    ObjXML,
    XMLTxt,
    cmd,
    LengthBuf,
    FlExists :bool = false,
    RefValue :string = "";


  Query = " SELECT DBMS_LOB.GETLENGTH(T_FILE), T_FILENAME " +
          " FROM ulob_txt_tmp";

  DataSet_1 = execSQLselect( Query );

  while( DataSet_1.MoveNext )
   FlExists = true;

   ObjXML = TRecHandler("ClobRead", makeArray("Clob", V_STRING, DataSet_1.value(0, null, V_INTEGER), 0, 0));

   LengthBuf = DataSet_1.value(0, null, V_INTEGER);

   DataSet = Null;
   cmd = Null;

   cmd = RSDCommand(" SELECT T_FILENAME, T_FILE FROM ulob_txt_tmp " +
                    " WHERE T_FILENAME = ? ");
   cmd.AddParam("FileName", RSDBP_IN, DataSet_1.value(1, null, V_STRING));

   DataSet = RSDRecordset(cmd, null, RSDVAL_STATIC);

   if( DataSet.MoveNext )
    DataSet.Fld(1).Read(ObjXML);
    XMLTxt = TStreamDoc("..\\TXTFILE\\" + EXPORT_FILENAME_TXT + CNum + ".txt", "C", "utf8");
    XMLTxt.WriteLine(ObjXML.rec.Clob, LengthBuf);
    XMLTxt = null;
   end;

   ObjXML = Null;

   RefValue = Export_Path + "\\" + DataSet_1.value(1, Null, V_STRING);

   //боремся с рудиментами в конце файла похоже на ошибки инструмента!!!!!!!!!!!!
   if( not FileRemove("..\\TXTFILE\\" + EXPORT_FILENAME_TXT + CNum + ".txt",
     "..\\TXTFILE\\" + DataSet_1.value(1, Null, V_STRING) + CNum + ".txt", DataSet_1.value(1, Null, V_STRING) ) )
    return false;
   end;

   //копирование в ресурс из реестра
   if( not CopyFile( "..\\TXTFILE\\" + DataSet_1.value(1, Null, V_STRING) + CNum + ".txt", RefValue ) ) 
    MsgBox( "Ошибка копирования файла  " + DataSet_1.value(1, Null, V_STRING) + CNum + ".txt" );
    return 1;
   else
    if(not RemoveFile("..\\TXTFILE\\" + DataSet_1.value(1, Null, V_STRING) + CNum + ".txt"))
     MsgBox("Не могу удалить временный файл " + DataSet_1.value(1, Null, V_STRING) + CNum + ".txt" + ".");
     return 1;
    end;

   end;


  end;

  if( FlExists )

   Query = " DELETE ulob_txt_tmp ";
   execSQL( Query );

  end;

  if( not FlExists )

   MsgBox( "Нет данных для экспорта.");
   return 1;

  end;

  DataSet_1 = Null;
  Params = Null;

  return 0;

onError(err)

  DataSet_1 = Null;
  Params = Null;

  return 1;

end;



//!!!!!!!!!! только для тестирования
//CreateOutputFileLMT("$C:\\RsBank60" );
//!!!!!!!!!! только для тестирования

