//А.Киселев 17.05.2019 "Отчет-сверка проводок выгруженных в Бисквит из СОФР".

import globals, ActiveX, oralib, likepy, rsexts;
import "global_utils_intgr.mac", "u_common_email_utils.mac";


private const EXPORT_XML_FILENAME_TXT = "for_entcompare",
              CV_EMAIL_GRP_ETCOMPARE = 3; //группа сверки проводок загруженных в БИСКВИТ из СОФР



private const Excel_RUS = 1049, //значение локализации для русского Excel
              HEADER_FILENAME_TXT = "header_entcompare",
              BODY_FILENAME_TXT = "body_entcompare",
              FOOTER_FILENAME_TXT = "footer_entcompare"; 

private const xlPasteFormats = -4122,
              xlContinuous = 1,
              xlMedium = -4138,
              xlThin = 2,
              xlNone = -4142,
              xlEdgeLeft = 7,
              xlEdgeTop = 8,
              xlEdgeBottom = 9,
              xlEdgeRight = 10,
              xlDiagonalDown = 5,
              xlDiagonalUp = 6,
              xlInsertDeleteCells = 1,
              xlDelimited = 1,
              xlTextQualifierNone = -4142,
              xlRight  = -4152,
              xlLeft   = -4131,
              xlCenter = -4108,
              xlThemeColorLight1 = 2,
              xlThemeColorDark1 = 1,
              xlThemeColorDark2 = 3,
              xlLandscape = 2,

              SymbSeparator = "|";


private var LocalPathExcel = "",
            XLSExport_Path :string = "",
            CellNumX :integer,
            CellNumY :integer,
            CellNumDeltaY :integer = 0,
            CntAccountRow :integer = 0,
            CellYSectionBodySeparate :TArray = TArray(),
            SizeOfHeader :integer = 9, //3,
            SizeOfDeltaHeader :integer = 7,
            SizeOfFooter :integer = 5, //7,
            Max_X :integer = 13, //количество колонок
            PartyCnt :integer = 0,
            RowCnt :integer = 0,
            CNum = string(UserNumber),
            ExcelLanguage = 0,
            ExcelDecimalSeparator = "",
            FlOpenTxtFile :bool = false;




//преобразование bool в integer
private macro Bool_Int( Btype :bool) :integer

 if( (Valtype(Btype) != V_UNDEF) and (Btype) )
  return 1;
 else
  return 0;
 end;

end;
//преобразование bool в integer

//из массива объектов формируем SQL-строку
private macro GetSQLStrFromArray( ParamProcess :object );
const BEGIN_SQL_STR = " SELECT ",
      END_SQL_STR = " FROM DUAL ",
      SEPARATOR = ", ";

var Query :string = "",
    i :integer = 0,
    fl_first_str :bool = false;

              
 if( (ValType( uTryToGetPropS( ParamProcess, "AccEntries" ) ) == V_UNDEF) or (ValType( ParamProcess.AccEntries ) == V_UNDEF) or ( ParamProcess.AccEntries.Size == 0 ) )
  Query = " SELECT -1 AS ID, '' AS PERSN, '' AS ACC_D, '' AS ACC_C FROM DUAL ";
 else

  while( i < ParamProcess.AccEntries.Size )
   if( ( ParamProcess.AccEntries[i].PersN != "-1" ) and ( ParamProcess.AccEntries[i].PayerAccount != "-1" ) and ( ParamProcess.AccEntries[i].ReceiverAccount != "-1" ) ) //признак неудаленного элемента массива

    if( fl_first_str )
     Query = Query + " UNION ALL ";
    else
     fl_first_str = true;
    end;

    Query = Query + BEGIN_SQL_STR + string(i) + " AS ID" + SEPARATOR + GetSQLString( ParamProcess.AccEntries[i].PersN ) + " AS PERSN" + SEPARATOR + GetSQLString( ParamProcess.AccEntries[i].PayerAccount ) + " AS ACC_D" + SEPARATOR + GetSQLString( ParamProcess.AccEntries[i].ReceiverAccount ) + " AS ACC_C" + END_SQL_STR;
   end;
   i = i + 1;
  end;

 end;

 if( Query == "" )
  Query = " SELECT -1 AS ID, '' AS PERSN, '' AS ACC_D, '' AS ACC_C FROM DUAL "; //все элементы были удалены
 end;

 Query = Query + " ORDER BY 1";

 return Query;

end;



 /*
    Новая Excel-книга  без шаблона
    Входные параметры (необязательные):
       Visible       - признак отображения приложения на экране;
 */
 private macro NewExcelWorkbook_ ( Visible, ExcelFileName :string )

  if(ExcelApplication == null)
     if (isStandAlone())
        ExcelApplication = ActiveX("Excel.Application", null, true);
     else
        if (startAX == null)
           startAX = CreateObject("rsax", "TRsAxServer", "LoansAxServer", isStandalone());
        end;
        ExcelApplication = startAX.CreateComObject("Excel.Application");
     end;
  end;

  if( (Valtype(ExcelFileName) == V_UNDEF) or (Valtype(ExcelFileName) == 26) )
   ExcelApplication.Workbooks.Add(1);
  else
   ExcelApplication.Workbooks.Add( ExcelFileName );
  end;

  if (ValType (Visible) == V_BOOL)
    ExcelApplication.Visible = Visible;
  end;
  ActiveSheet = ExcelApplication.ActiveSheet;
  return true;

 onError (err)
    ExcelError(err, false);
    return true;
//    Exit(1);
 end;


 private macro TranslateExcelFormula(Formula :string, LocalCode :integer) :string // получаем название формулы на языке локализации RUS / US International
 const Excel_RUS = 1049;                                                          // по любому из двух извесных названий
 var RUS_Formula :TArray,
     US_Formula :TArray,
     Index_;

  RUS_Formula = MakeArray("ЕСЛИ",
                          "СУММ",
                          "ОКРУГЛ");
  US_Formula = MakeArray("IF",
                         "SUM",
                         "ROUND");

  Index_ = find( RUS_Formula, Formula );
  if( Index_ < 0 )
   Index_ = find( US_Formula, Formula );
   if( Index_ < 0 )
    return Formula;
   end
  end;
  if ( LocalCode == Excel_RUS)
   return RUS_Formula[Index_];
  else
   return US_Formula[Index_];
  end
 end;


 private macro GetFormatedField(FieldValue :variant, FirstSeparator :string, LastSeparator :string) :string //форматировать значение поля и цеплять разделители
 var SepPos :integer = 0,
     SymSep :string = ",.";

  if( (ValType(FieldValue) ==  V_UNDEF) or (ValType(FieldValue) ==  V_STRING) and (FieldValue == "") or (ValType(FieldValue) ==  26) or
   (ValType(FieldValue) ==  V_DATE) and ( (string(FieldValue) == " 1.01.0001") or (FieldValue == date("00.00.0000")) ) )
   return FirstSeparator + "" + LastSeparator;
  else
   if( (ValType(FieldValue) ==  V_DATE) or (ValType(FieldValue) ==  V_DTTM) )
    FieldValue = StrSubst( string(date(FieldValue):10), " ", "0" );
   elif( ((ValType(FieldValue) ==  V_MONEY) or (ValType(FieldValue) ==  V_DOUBLE)) and (Index(FieldValue, ExcelDecimalSeparator) == 0) )
    FieldValue = string(FieldValue);
    if( ExcelDecimalSeparator == ",")
     SepPos = Index(FieldValue,".");
    else
     SepPos = Index(FieldValue,",");
    end;
    if( SepPos > 0)
     FieldValue = SubStr( FieldValue, 1, SepPos - 1 ) + ExcelDecimalSeparator + SubStr( FieldValue, SepPos+1 );
    end;
   end;
    return FirstSeparator + string(FieldValue) + LastSeparator;
  end;
 end;



//получим курсор
private macro GetDataSet( DataSet :@RsdRecordset, QueryType :integer, ReqId :string, ParamProcess :object ) :integer
var Query :string = "",
    Params :TArray,
    FlAcc :integer = 0,
    SQLStrFromArray :string = "",
    error;

 if( QueryType == 0 )


  //курсор в tmp
  DataSet = Null;
  SQLStrFromArray = GetSQLStrFromArray( ParamProcess );

/*
SELECT  F.T_COUNTER, F.T_USERID, F.T_OPDATE, F.T_DOCDATE, 
  NVL( F.T_ACCT_DB, ( SELECT G.T_ACCT_DB FROM uloadentforcompare_dbt G
                                  WHERE  G.T_IDBISCOTTO = F.T_IDBISCOTTO
                                    AND   G.T_ACCT_CR IS NULL AND G.T_ACCT_DB IS NOT NULL )  )  AS T_ACCT_DB,
  NVL ( F.T_ACCT_CR, ( SELECT G.T_ACCT_CR FROM uloadentforcompare_dbt G
                                   WHERE  G.T_IDBISCOTTO = F.T_IDBISCOTTO
                                     AND   G.T_ACCT_DB IS NULL AND G.T_ACCT_CR IS NOT NULL )  )  AS T_ACCT_CR,
  ( CASE WHEN  F.T_ACCT_DB IS NULL THEN ( SELECT G.T_CURRENCY FROM uloadentforcompare_dbt G
                                                                     WHERE  G.T_IDBISCOTTO = F.T_IDBISCOTTO
                                                                      AND   G.T_ACCT_CR IS NULL AND G.T_ACCT_DB IS NOT NULL  ) ELSE F. T_CURRENCY END ) AS T_CURRENCY_DB,                                  
  ( CASE WHEN  F.T_ACCT_CR IS NULL THEN ( SELECT G.T_CURRENCY FROM uloadentforcompare_dbt G
                                                                    WHERE  G.T_IDBISCOTTO = F.T_IDBISCOTTO
                                                                      AND   G.T_ACCT_DB IS NULL AND G.T_ACCT_CR IS NOT NULL  ) ELSE F. T_CURRENCY END ) AS T_CURRENCY_CR,                                  
  ( CASE WHEN  F.T_ACCT_DB IS NULL THEN ( SELECT G.T_AMTCUR FROM uloadentforcompare_dbt G
                                                                     WHERE  G.T_IDBISCOTTO = F.T_IDBISCOTTO
                                                                      AND   G.T_ACCT_CR IS NULL AND G.T_ACCT_DB IS NOT NULL  ) ELSE F.T_AMTCUR END ) AS T_AMTCUR_DB,                                  
  ( CASE WHEN  F.T_ACCT_CR IS NULL THEN ( SELECT G.T_AMTCUR FROM uloadentforcompare_dbt G
                                                                    WHERE  G.T_IDBISCOTTO = F.T_IDBISCOTTO
                                                                      AND   G.T_ACCT_DB IS NULL AND G.T_ACCT_CR IS NOT NULL  ) ELSE F.T_AMTCUR END ) AS T_AMTCUR_CR,                                  
  F.T_AMTRUB, 
  F.T_DETAILS,  F.T_DOCNUM,  F.T_ACCTRNID,  F.T_IDBISCOTTO,  F.T_REQID
FROM uloadentforcompare_dbt F
WHERE F.T_IDBISCOTTO = '164554512'
 AND  ( F.T_ACCT_DB IS NULL AND F.T_ACCT_CR IS NOT NULL
  OR F.T_ACCT_DB IS NOT NULL AND F.T_ACCT_CR IS NULL )


AND RSB_MASK.CompareStringWithMask('306*', T_ACCT_DB ) > 0 


( SELECT 0 AS ID, chr(1) AS PERSN, '306*' AS ACC_D, chr(1) AS ACC_C FROM DUAL  ORDER BY 1 ) Z

(  SELECT -1, '', '' FROM DUAL  ORDER BY 1 ) Z

*/


  Query =   
            // --из СОФР в БИСКВИТ проводки БИСКВИТ отсутствуют в СОФР кроме полу-проводок
           "  SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB, " +
           "   T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 1 AS T_ERR_CODE, " +
           "   USR_PKG_IMPORT_SOFR.GetStrEventErr( 0, 1, T_ACCTRNID ) AS T_ERR_TEXT, " +
           "   0 AS T_OPER, '' AS T_MODULE " +
           "  FROM uloadentforcompare_dbt C " +
           "  WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
           "                    WHERE V.T_BISCOTTOID = C.T_IDBISCOTTO ) " +
           "   AND  C.T_AUTOKEY NOT IN( ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dacctrn_dbt B " +

           "   , ( " + SQLStrFromArray + " ) Z " +

           "                              WHERE A.T_REQID = :ReqId_1 " +
           "                               AND ( Z.ID < 0 " +
           "                                OR ( Z.ACC_D = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_ACCOUNT_PAYER ) > 0 ) " +
           "                                AND ( Z.ACC_C = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_ACCOUNT_RECEIVER ) > 0 ) " +

           "                                 AND ( Z.PERSN = CHR(1) " +
           "                                  OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
           "                                                                                        WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
           "                                                                                        WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
           "                                                                                        ELSE Y.T_PERS_NUMBER_BISQUIT END ) AS T_PERS_NUMBER_BISQUIT " +
           "                                                                               FROM ( SELECT NVL(( SELECT U.T_NAME FROM dllvalues_dbt U " +
           "                                                                                                   WHERE U.T_LIST = 5005 " +
           "                                                                                                    AND U.T_ELEMENT = B.T_NUMBER_PACK ), '9090909') AS CNTRPERSNUMBER, " +
           "                                                                                       NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
           "                                                                                              WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
           "                                                                                                               WHERE V.T_OBJECTTYPE = 92 " +
           "                                                                                                                AND V.T_NOTEKIND = 200 " +
           "                                                                                                                AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
           "                                                                                                                AND V.T_DATE <= B.T_DATE_CARRY ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
           "                                                                                       ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
           "                                                                                                                                         WHERE W.T_CODE = B.T_DEPARTMENT ) END ) AS T_BRANCH " +
           "                                                                                      FROM DUAL ) Y ) ) > 0 ) " +
           "                                   ) " +

           "                               AND EXISTS( SELECT 1 FROM  utableprocessevent_dbt D " +
           "                                           WHERE D.T_OBJECTID = A.T_ACCTRNID " +
           "                                            AND D.T_OBJECTTYPE IN (1, 501) " +
           "                                            AND D.T_TYPE = 1 " +
           "                                            AND D.T_STATUS IN(4, 5) " +
           "                                            AND D.T_MESSAGEID IS NOT NULL " +
           "                                            AND D.T_MESSAGEID > 0 " +
//           "                                            AND D.T_RESULTCODE = 0 " +
           "                                            AND NOT EXISTS( SELECT 1 FROM utableprocessevent_dbt I " +
           "                                                            WHERE I.T_OBJECTID = D.T_OBJECTID " +
           "                                                             AND I.T_OBJECTTYPE = D.T_OBJECTTYPE " +
           "                                                             AND I.T_TYPE = 3 " +
           "                                                             AND I.T_RECID >  D.T_RECID ) ) " +

           "                               AND A.T_OPDATE BETWEEN :DateBegin_1 AND :DateEnd_1 " +
           "                               AND A.T_OPDATE = B.T_DATE_CARRY " +

           "                               AND ( B.T_ACCOUNT_PAYER = A.T_ACCT_DB " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_DB ) ) " +

           "                               AND ( B.T_ACCOUNT_RECEIVER = A.T_ACCT_CR " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_CR ) ) " +

           "                               AND B.T_DATE_CARRY = A.T_OPDATE " +
           "                               AND B.T_ACCTRNID = A.T_ACCTRNID ) ) " +
           "   AND C.T_REQID = :ReqId_2 " +
           "   AND C.T_ACCTRNID > 0 " +
           "   AND C.T_ACCT_DB IS NOT NULL " +
           "   AND C.T_ACCT_CR IS NOT NULL " +
           
           "  UNION ALL " +

            // --из СОФР в БИСКВИТ проводки БИСКВИТ отсутствуют в СОФР только полу-проводоки
           "  SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB, " +
           "   T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 1 AS T_ERR_CODE, " +
           "   USR_PKG_IMPORT_SOFR.GetStrEventErr( 0, 1, T_ACCTRNID ) AS T_ERR_TEXT, " +
           "   0 AS T_OPER, '' AS T_MODULE " +
           "  FROM uloadentforcompare_dbt C " +
           "  WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
           "                    WHERE V.T_BISCOTTOID = C.T_IDBISCOTTO ) " +
           "   AND C.T_AUTOKEY NOT IN( ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dacctrn_dbt B " +

           "   , ( " + SQLStrFromArray + " ) Z " +

           "                              WHERE A.T_REQID = :ReqId_1_1 " +
           "                               AND (Z.ID < 0 " +
           "                                OR ( Z.ACC_D = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_ACCOUNT_PAYER ) > 0 ) " +
           "                                AND ( Z.ACC_C = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_ACCOUNT_RECEIVER ) > 0) " +
           "                                 AND ( Z.PERSN = CHR(1) " +
           "                                  OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
           "                                                                                        WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
           "                                                                                        WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
           "                                                                                        ELSE Y.T_PERS_NUMBER_BISQUIT END ) AS T_PERS_NUMBER_BISQUIT " +
           "                                                                               FROM ( SELECT NVL(( SELECT U.T_NAME FROM dllvalues_dbt U " +
           "                                                                                                   WHERE U.T_LIST = 5005 " +
           "                                                                                                    AND U.T_ELEMENT = B.T_NUMBER_PACK ), '9090909') AS CNTRPERSNUMBER, " +
           "                                                                                       NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
           "                                                                                              WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
           "                                                                                                               WHERE V.T_OBJECTTYPE = 92 " +
           "                                                                                                                AND V.T_NOTEKIND = 200 " +
           "                                                                                                                AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
           "                                                                                                                AND V.T_DATE <= B.T_DATE_CARRY ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
           "                                                                                       ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
           "                                                                                                                                         WHERE W.T_CODE = B.T_DEPARTMENT ) END ) AS T_BRANCH " +
           "                                                                                      FROM DUAL ) Y ) ) > 0 ) " +
           "                                    ) " +

           "                               AND EXISTS( SELECT 1 FROM  utableprocessevent_dbt D " +
           "                                           WHERE D.T_OBJECTID = A.T_ACCTRNID " +
           "                                            AND D.T_OBJECTTYPE IN (1, 501) " +
           "                                            AND D.T_TYPE = 1 " +
           "                                            AND D.T_STATUS IN(4, 5) " +
           "                                            AND D.T_MESSAGEID IS NOT NULL " +
           "                                            AND D.T_MESSAGEID > 0 " +
//           "                                            AND D.T_RESULTCODE = 0 " +
           "                                            AND NOT EXISTS( SELECT 1 FROM utableprocessevent_dbt I " +
           "                                                            WHERE I.T_OBJECTID = D.T_OBJECTID " +
           "                                                             AND I.T_OBJECTTYPE = D.T_OBJECTTYPE " +
           "                                                             AND I.T_TYPE = 3 " +
           "                                                             AND I.T_RECID >  D.T_RECID ) ) " +

           "                               AND A.T_OPDATE BETWEEN :DateBegin_1_1 AND :DateEnd_1_1 " +
           "                               AND A.T_OPDATE = B.T_DATE_CARRY " +

           "                               AND  B.T_ACCOUNT_PAYER = /*A.T_ACCT_DB*/ " +

           "                                NVL( A.T_ACCT_DB, ( SELECT G.T_ACCT_DB FROM uloadentforcompare_dbt G " +
           "                                                    WHERE  G.T_IDBISCOTTO = C.T_IDBISCOTTO " +
           "                                                     AND G.T_REQID = A.T_REQID " +
           "                                                     AND   G.T_ACCT_CR IS NULL AND G.T_ACCT_DB IS NOT NULL )  ) " +


           "                               AND B.T_ACCOUNT_RECEIVER = /*A.T_ACCT_CR*/ " +

           "                                NVL ( A.T_ACCT_CR, ( SELECT G.T_ACCT_CR FROM uloadentforcompare_dbt G " +
           "                                                     WHERE  G.T_IDBISCOTTO = C.T_IDBISCOTTO " +
           "                                                      AND G.T_REQID = A.T_REQID " +
           "                                                       AND   G.T_ACCT_DB IS NULL AND G.T_ACCT_CR IS NOT NULL )  ) " +


           "                               AND B.T_DATE_CARRY = A.T_OPDATE " +
           "                               AND B.T_ACCTRNID = A.T_ACCTRNID ) ) " +
           "   AND C.T_REQID = :ReqId_2_1 " +
           "   AND C.T_ACCTRNID > 0 " +
           "   AND  ( C.T_ACCT_DB IS NULL AND C.T_ACCT_CR IS NOT NULL " +
           "    OR C.T_ACCT_DB IS NOT NULL AND C.T_ACCT_CR IS NULL ) " +

           "  UNION ALL " +



            // --из СОФР в БИСКВИТ проводки БИСКВИТ присутствуют в СОФР, не соответствуют реквизиты кроме полу-проводок

           "  SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB, " +
           "   T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 2 AS T_ERR_CODE, 'Из СОФР в БИСКВИТ. Присутствует в СОФР, не соответствуют реквизиты: ' || " +
           "   USR_PKG_IMPORT_SOFR.GetDifferenceStrErr( 0, C.T_ACCT_DB, C.T_ACCT_CR, C.T_AMTCUR, C.T_AMTRUB, C.T_CURRENCY, C.T_DETAILS, C.T_DOCNUM, " +
           "    C.T_ACCTRNID, C.T_IDBISCOTTO, C.T_REQID ) AS T_ERR_TEXT, " +
           "    ( SELECT R.T_OPER FROM dacctrn_dbt R WHERE R.T_ACCTRNID = C.T_ACCTRNID ) AS T_OPER, " +
           "    ( SELECT W.T_BOFFICE FROM rshb_fd_groups W " +
           "      WHERE W.T_GROUPID IN(( SELECT O.T_GROUPID FROM dacsgroupoper_dbt O " +
           "                             WHERE O.T_OPER = ( SELECT R.T_OPER FROM dacctrn_dbt R " +
           "                                                WHERE R.T_ACCTRNID = C.T_ACCTRNID ))) " +
           "       AND ROWNUM = 1 ) AS T_MODULE " +

           "  FROM uloadentforcompare_dbt C " +
           "  WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
           "                    WHERE V.T_BISCOTTOID = C.T_IDBISCOTTO ) " +
           "   AND C.T_AUTOKEY IN( ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dacctrn_dbt B " +

           "   , ( " + SQLStrFromArray + " ) Z " +

           "                              WHERE A.T_REQID = :ReqId_3 " + 
           "                               AND (Z.ID < 0 " +
           "                                OR ( Z.ACC_D = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_ACCOUNT_PAYER ) > 0 ) " +
           "                                AND ( Z.ACC_C = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_ACCOUNT_RECEIVER ) > 0) " + 
           "                                 AND ( Z.PERSN = CHR(1) " +
           "                                  OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
           "                                                                                        WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
           "                                                                                        WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
           "                                                                                        ELSE Y.T_PERS_NUMBER_BISQUIT END ) AS T_PERS_NUMBER_BISQUIT " +
           "                                                                               FROM ( SELECT NVL(( SELECT U.T_NAME FROM dllvalues_dbt U " +
           "                                                                                                   WHERE U.T_LIST = 5005 " +
           "                                                                                                    AND U.T_ELEMENT = B.T_NUMBER_PACK ), '9090909') AS CNTRPERSNUMBER, " +
           "                                                                                       NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
           "                                                                                              WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
           "                                                                                                               WHERE V.T_OBJECTTYPE = 92 " +
           "                                                                                                                AND V.T_NOTEKIND = 200 " +
           "                                                                                                                AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
           "                                                                                                                AND V.T_DATE <= B.T_DATE_CARRY ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
           "                                                                                       ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
           "                                                                                                                                         WHERE W.T_CODE = B.T_DEPARTMENT ) END ) AS T_BRANCH " +
           "                                                                                      FROM DUAL ) Y ) ) > 0 ) " +
           "                                    ) " +

           "                               AND A.T_OPDATE BETWEEN :DateBegin_2 AND :DateEnd_2 " +
           "                               AND A.T_OPDATE = B.T_DATE_CARRY " +
//           "                               AND ( :FlAcc_3 = 0 OR :Acc_3 IN( A.T_ACCT_DB, A.T_ACCT_CR ) ) " +

           "                               AND ( B.T_ACCOUNT_PAYER = A.T_ACCT_DB " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_DB ) ) " +

           "                               AND ( B.T_ACCOUNT_RECEIVER = A.T_ACCT_CR " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_CR ) ) " +

           "                               AND B.T_DATE_CARRY = A.T_OPDATE " +
           "                               AND B.T_ACCTRNID = A.T_ACCTRNID ) ) " +
           "   AND C.T_ACCTRNID > 0 " +
           "   AND C.T_ACCT_DB IS NOT NULL " +
           "   AND C.T_ACCT_CR IS NOT NULL " +
           "   AND EXISTS( SELECT 1 FROM dacctrn_dbt D " +
           "               WHERE D.T_ACCTRNID = C.T_ACCTRNID " +
           "                AND ( D.T_ACCOUNT_PAYER <> C.T_ACCT_DB " +
           "                       AND NOT EXISTS( SELECT 1 FROM dbrokacc_dbt E " +
           "                                       WHERE E.T_ACCOUNT =  C.T_ACCT_DB ) " +
           "                      OR D.T_ACCOUNT_RECEIVER <> C.T_ACCT_CR " +
           "                       AND NOT EXISTS( SELECT 1 FROM dbrokacc_dbt E " +
           "                                       WHERE E.T_ACCOUNT =  C.T_ACCT_CR ) " +

           "                      OR ( CASE WHEN D.T_FIID_PAYER = 0 AND D.T_FIID_RECEIVER = 0 OR C.T_AMTCUR = 0 /*переоценка*/ THEN 0 " +
           "                                ELSE /*конверсия*/ ( CASE WHEN D.T_FIID_PAYER <> 0 THEN D.T_SUM_PAYER " +
           "                                                          WHEN D.T_FIID_RECEIVER <> 0 THEN D.T_SUM_RECEIVER END ) END ) <> C.T_AMTCUR " +

           "                      OR D.T_SUM_NATCUR <> C.T_AMTRUB " +

/*поле валюта не сверяем
           "                      OR C.T_CURRENCY <> ( SELECT F.T_CODEINACCOUNT FROM dfininstr_dbt F " +
           "                                           WHERE F.T_FIID = D.T_FIID_PAYER ) " +
*/
//!!!           "                      OR D.T_GROUND <> C.T_DETAILS " +
/*поле номер документа не сверяем
           "                      OR D.T_NUMB_DOCUMENT <> C.T_DOCNUM " +
*/
           "                    )) " +
           "   AND EXISTS( SELECT 1 FROM  utableprocessevent_dbt D " +
           "               WHERE D.T_OBJECTID = C.T_ACCTRNID " +
           "                AND D.T_OBJECTTYPE IN (1, 501) " +
           "                AND D.T_TYPE = 1 " +
           "                AND D.T_STATUS = 4 " +
           "                AND D.T_MESSAGEID IS NOT NULL " +
           "                AND D.T_MESSAGEID > 0 " +
//           "                AND D.T_RESULTCODE = 0 " +
           "                AND NOT EXISTS( SELECT 1 FROM utableprocessevent_dbt I " +
           "                                WHERE I.T_OBJECTID = D.T_OBJECTID " +
           "                                 AND I.T_OBJECTTYPE = D.T_OBJECTTYPE " +
           "                                 AND I.T_TYPE = 3 " +
           "                                 AND I.T_RECID >  D.T_RECID ) ) " +
           
           "  UNION ALL " +

            // --из СОФР в БИСКВИТ проводки БИСКВИТ присутствуют в СОФР, не соответствуют реквизиты  только полу-проводки

           "  SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB, " +
           "   T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 2 AS T_ERR_CODE, 'Из СОФР в БИСКВИТ. Присутствует в СОФР, не соответствуют реквизиты: ' || " +
           "   USR_PKG_IMPORT_SOFR.GetDifferenceStrErr( 1, C.T_ACCT_DB, C.T_ACCT_CR, C.T_AMTCUR, C.T_AMTRUB, C.T_CURRENCY, C.T_DETAILS, C.T_DOCNUM, " +
           "    C.T_ACCTRNID, C.T_IDBISCOTTO, C.T_REQID ) AS T_ERR_TEXT, " +
           "    ( SELECT R.T_OPER FROM dacctrn_dbt R WHERE R.T_ACCTRNID = C.T_ACCTRNID ) AS T_OPER, " +
           "    ( SELECT W.T_BOFFICE FROM rshb_fd_groups W " +
           "      WHERE W.T_GROUPID IN(( SELECT O.T_GROUPID FROM dacsgroupoper_dbt O " +
           "                             WHERE O.T_OPER = ( SELECT R.T_OPER FROM dacctrn_dbt R " +
           "                                                WHERE R.T_ACCTRNID = C.T_ACCTRNID ))) " +
           "       AND ROWNUM = 1 ) AS T_MODULE " +

           "  FROM uloadentforcompare_dbt C " +
           "  WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
           "                    WHERE V.T_BISCOTTOID = C.T_IDBISCOTTO ) " +
           "   AND C.T_AUTOKEY IN( ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dacctrn_dbt B " +

           "   , ( " + SQLStrFromArray + " ) Z " +

           "                              WHERE A.T_REQID = :ReqId_3_1 " + 
           "                               AND (Z.ID < 0 " +
           "                                OR ( Z.ACC_D = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_ACCOUNT_PAYER ) > 0 ) " +
           "                                AND ( Z.ACC_C = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_ACCOUNT_RECEIVER ) > 0) " +
           "                                 AND ( Z.PERSN = CHR(1) " +
           "                                  OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
           "                                                                                        WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
           "                                                                                        WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
           "                                                                                        ELSE Y.T_PERS_NUMBER_BISQUIT END ) AS T_PERS_NUMBER_BISQUIT " +
           "                                                                               FROM ( SELECT NVL(( SELECT U.T_NAME FROM dllvalues_dbt U " +
           "                                                                                                   WHERE U.T_LIST = 5005 " +
           "                                                                                                    AND U.T_ELEMENT = B.T_NUMBER_PACK ), '9090909') AS CNTRPERSNUMBER, " +
           "                                                                                       NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
           "                                                                                              WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
           "                                                                                                               WHERE V.T_OBJECTTYPE = 92 " +
           "                                                                                                                AND V.T_NOTEKIND = 200 " +
           "                                                                                                                AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
           "                                                                                                                AND V.T_DATE <= B.T_DATE_CARRY ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
           "                                                                                       ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
           "                                                                                                                                         WHERE W.T_CODE = B.T_DEPARTMENT ) END ) AS T_BRANCH " +
           "                                                                                      FROM DUAL ) Y ) ) > 0 ) " +
           "                                    ) " +

           "                               AND A.T_OPDATE BETWEEN :DateBegin_2_1 AND :DateEnd_2_1 " +
           "                               AND A.T_OPDATE = B.T_DATE_CARRY " +
           "                               AND  B.T_ACCOUNT_PAYER = /*A.T_ACCT_DB*/ " +
           "                                NVL( A.T_ACCT_DB, ( SELECT G.T_ACCT_DB FROM uloadentforcompare_dbt G " +
           "                                                    WHERE  G.T_IDBISCOTTO = C.T_IDBISCOTTO " +
           "                                                     AND G.T_REQID = A.T_REQID " +
           "                                                     AND   G.T_ACCT_CR IS NULL AND G.T_ACCT_DB IS NOT NULL )  ) " +

           "                               AND B.T_ACCOUNT_RECEIVER = /*A.T_ACCT_CR*/ " +
           "                                NVL ( A.T_ACCT_CR, ( SELECT G.T_ACCT_CR FROM uloadentforcompare_dbt G " +
           "                                                     WHERE  G.T_IDBISCOTTO = C.T_IDBISCOTTO " +
           "                                                       AND G.T_REQID = A.T_REQID " +
           "                                                       AND   G.T_ACCT_DB IS NULL AND G.T_ACCT_CR IS NOT NULL )  ) " +


           "                               AND B.T_DATE_CARRY = A.T_OPDATE " +
           "                               AND B.T_ACCTRNID = A.T_ACCTRNID ) ) " +
           "   AND C.T_ACCTRNID > 0 " +
           "   AND  ( C.T_ACCT_DB IS NULL AND C.T_ACCT_CR IS NOT NULL " +
           "    OR C.T_ACCT_DB IS NOT NULL AND C.T_ACCT_CR IS NULL ) " +

           "   AND EXISTS( SELECT 1 FROM dacctrn_dbt D " +
           "               WHERE D.T_ACCTRNID = C.T_ACCTRNID " +
           "                AND ( D.T_ACCOUNT_PAYER <> /*C.T_ACCT_DB*/ " +
           "                 NVL( C.T_ACCT_DB, ( SELECT G.T_ACCT_DB FROM uloadentforcompare_dbt G " +
           "                                     WHERE  G.T_IDBISCOTTO = C.T_IDBISCOTTO " +
           "                                      AND G.T_REQID = C.T_REQID " +
           "                                      AND   G.T_ACCT_CR IS NULL AND G.T_ACCT_DB IS NOT NULL )  ) " +

           "                      OR D.T_ACCOUNT_RECEIVER <> /*C.T_ACCT_CR*/ " +
           "                        NVL ( C.T_ACCT_CR, ( SELECT G.T_ACCT_CR FROM uloadentforcompare_dbt G " +
           "                                             WHERE  G.T_IDBISCOTTO = C.T_IDBISCOTTO " +
           "                                               AND G.T_REQID = C.T_REQID " +
           "                                               AND   G.T_ACCT_DB IS NULL AND G.T_ACCT_CR IS NOT NULL )  ) " +


           "                      OR D.T_SUM_PAYER <> ( CASE WHEN C.T_ACCT_DB IS NULL THEN ( SELECT G.T_AMTCUR FROM uloadentforcompare_dbt G " +
           "                                                                                 WHERE  G.T_IDBISCOTTO = C.T_IDBISCOTTO " +
           "                                                                                  AND G.T_REQID = C.T_REQID " +
           "                                                                                  AND G.T_ACCTRNID = C.T_ACCTRNID " +
           "                                                                                  AND  G.T_ACCT_CR IS NULL AND G.T_ACCT_DB IS NOT NULL ) " +
           "                                            ELSE C.T_AMTCUR END ) " +
           "                       OR D.T_SUM_RECEIVER <> ( CASE WHEN C.T_ACCT_CR IS NULL THEN ( SELECT G.T_AMTCUR FROM uloadentforcompare_dbt G " +
           "                                                                                      WHERE G.T_IDBISCOTTO = C.T_IDBISCOTTO " +
           "                                                                                        AND G.T_REQID = C.T_REQID " +
           "                                                                                        AND G.T_ACCTRNID = C.T_ACCTRNID " +
           "                                                                                        AND G.T_ACCT_DB IS NULL AND G.T_ACCT_CR IS NOT NULL ) " +
           "                                                 ELSE C.T_AMTCUR END ) " +
           "                      OR D.T_SUM_NATCUR <> C.T_AMTRUB " +
/*поле валюта не сверяем
           "                      OR C.T_CURRENCY <> ( SELECT F.T_CODEINACCOUNT FROM dfininstr_dbt F " +
           "                                           WHERE F.T_FIID = D.T_FIID_PAYER ) " +
*/
//!!!           "                      OR D.T_GROUND <> C.T_DETAILS " +
/*поле номер документа не сверяем
           "                      OR D.T_NUMB_DOCUMENT <> C.T_DOCNUM " +
*/
           "                    )) " +
           "   AND EXISTS( SELECT 1 FROM  utableprocessevent_dbt D " +
           "               WHERE D.T_OBJECTID = C.T_ACCTRNID " +
           "                AND D.T_OBJECTTYPE IN (1, 501) " +
           "                AND D.T_TYPE = 1 " +
           "                AND D.T_STATUS = 4 " +
           "                AND D.T_MESSAGEID IS NOT NULL " +
           "                AND D.T_MESSAGEID > 0 " +
//           "                AND D.T_RESULTCODE = 0 " +
           "                AND NOT EXISTS( SELECT 1 FROM utableprocessevent_dbt I " +
           "                                WHERE I.T_OBJECTID = D.T_OBJECTID " +
           "                                 AND I.T_OBJECTTYPE = D.T_OBJECTTYPE " +
           "                                 AND I.T_TYPE = 3 " +
           "                                 AND I.T_RECID >  D.T_RECID ) ) " +
           
           "  UNION ALL " +


            // --из СОФР в БИСКВИТ проводки БИСКВИТ присутствуют в СОФР, задвоенные в БИСКВИТ кроме полу-проводок

           "  SELECT D.T_AUTOKEY, D.T_COUNTER, D.T_USERID, D.T_OPDATE, D.T_DOCDATE, D.T_ACCT_DB, D.T_ACCT_CR, D.T_CURRENCY, D.T_AMTCUR, D.T_AMTRUB, " +
           "   D.T_DETAILS, D.T_DOCNUM, D.T_ACCTRNID, D.T_IDBISCOTTO, D.T_REQID, 3 AS T_ERR_CODE, 'Из СОФР в БИСКВИТ. Присутствует в СОФР, задвоенные в БИСКВИТ' AS T_ERR_TEXT, " +
           "   0 AS T_OPER, '' AS T_MODULE " +
           "  FROM uloadentforcompare_dbt D, " +
           "  ( " +
           "  SELECT T_ACCTRNID, MAX( T_AUTOKEY ) AS T_AUTOKEY_DOUBLE, MIN( T_AUTOKEY ) AS T_AUTOKEY_PRIOR  FROM uloadentforcompare_dbt C " +
           "  WHERE C.T_AUTOKEY IN( ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dacctrn_dbt B " +

           "   , ( " + SQLStrFromArray + " ) Z " +

           "                              WHERE A.T_REQID = :ReqId_4 " +
           "                               AND (Z.ID < 0 " +
           "                                OR ( Z.ACC_D = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_ACCOUNT_PAYER ) > 0 ) " +
           "                                AND ( Z.ACC_C = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_ACCOUNT_RECEIVER ) > 0) " +
           "                                 AND ( Z.PERSN = CHR(1) " +
           "                                  OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
           "                                                                                        WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
           "                                                                                        WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
           "                                                                                        ELSE Y.T_PERS_NUMBER_BISQUIT END ) AS T_PERS_NUMBER_BISQUIT " +
           "                                                                               FROM ( SELECT NVL(( SELECT U.T_NAME FROM dllvalues_dbt U " +
           "                                                                                                   WHERE U.T_LIST = 5005 " +
           "                                                                                                    AND U.T_ELEMENT = B.T_NUMBER_PACK ), '9090909') AS CNTRPERSNUMBER, " +
           "                                                                                       NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
           "                                                                                              WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
           "                                                                                                               WHERE V.T_OBJECTTYPE = 92 " +
           "                                                                                                                AND V.T_NOTEKIND = 200 " +
           "                                                                                                                AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
           "                                                                                                                AND V.T_DATE <= B.T_DATE_CARRY ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
           "                                                                                       ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
           "                                                                                                                                         WHERE W.T_CODE = B.T_DEPARTMENT ) END ) AS T_BRANCH " +
           "                                                                                      FROM DUAL ) Y ) ) > 0 ) " +
           "                                     ) " +

           "                               AND A.T_OPDATE BETWEEN :DateBegin_3 AND :DateEnd_3 " +
           "                               AND A.T_OPDATE = B.T_DATE_CARRY " +

           "                               AND ( B.T_ACCOUNT_PAYER = A.T_ACCT_DB " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_DB ) ) " +

           "                               AND ( B.T_ACCOUNT_RECEIVER = A.T_ACCT_CR " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_CR ) ) " +

           "                               AND B.T_DATE_CARRY = A.T_OPDATE " +
           "                               AND B.T_ACCTRNID = A.T_ACCTRNID ) ) " +
           "   AND C.T_ACCTRNID > 0 " +
           "   AND C.T_ACCT_DB IS NOT NULL " +
           "   AND C.T_ACCT_CR IS NOT NULL " +
           "   AND EXISTS( SELECT 1 FROM  utableprocessevent_dbt D " +
           "               WHERE D.T_OBJECTID = C.T_ACCTRNID " +
           "                AND D.T_OBJECTTYPE IN (1, 501) " +
           "                AND D.T_TYPE = 1 " +
           "                AND D.T_STATUS = 4 " +
           "                AND D.T_MESSAGEID IS NOT NULL " +
           "                AND D.T_MESSAGEID > 0 " +
//           "                AND D.T_RESULTCODE = 0 " +
           "                AND NOT EXISTS( SELECT 1 FROM utableprocessevent_dbt I " +
           "                                WHERE I.T_OBJECTID = D.T_OBJECTID " +
           "                                 AND I.T_OBJECTTYPE = D.T_OBJECTTYPE " +
           "                                 AND I.T_TYPE = 3 " +
           "                                 AND I.T_RECID >  D.T_RECID ) ) " +

           "  GROUP BY T_ACCTRNID " +
           "  HAVING COUNT(T_ACCTRNID) > 1 " +
           "  ) A " +
           "  WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
           "                    WHERE V.T_BISCOTTOID = D.T_IDBISCOTTO ) " +
           "   AND D.T_AUTOKEY = A.T_AUTOKEY_DOUBLE " +
           
           "  UNION ALL " +


            // --проводки БИСКВИТ присутствуют в СОФР, задвоенные в БИСКВИТ только полу-проводки

           "  SELECT D.T_AUTOKEY, D.T_COUNTER, D.T_USERID, D.T_OPDATE, D.T_DOCDATE, D.T_ACCT_DB, D.T_ACCT_CR, D.T_CURRENCY, D.T_AMTCUR, D.T_AMTRUB, " +
           "   D.T_DETAILS, D.T_DOCNUM, D.T_ACCTRNID, D.T_IDBISCOTTO, D.T_REQID, 3 AS T_ERR_CODE, 'Из СОФР в БИСКВИТ. Присутствует в СОФР, задвоенные в БИСКВИТ' AS T_ERR_TEXT, " +
           "   0 AS T_OPER, '' AS T_MODULE " +
           "  FROM uloadentforcompare_dbt D, " +
           "  ( " +
           "  SELECT T_ACCTRNID, MAX( T_AUTOKEY ) AS T_AUTOKEY_DOUBLE, MIN( T_AUTOKEY ) AS T_AUTOKEY_PRIOR  FROM uloadentforcompare_dbt C " +
           "  WHERE C.T_AUTOKEY IN( ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dacctrn_dbt B " +

           "   , ( " + SQLStrFromArray + " ) Z " +

           "                              WHERE A.T_REQID = :ReqId_4_1 " +
           "                               AND (Z.ID < 0 " +
           "                                OR ( Z.ACC_D = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_ACCOUNT_PAYER ) > 0 ) " +
           "                                AND ( Z.ACC_C = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_ACCOUNT_RECEIVER ) > 0) " +
           "                                 AND ( Z.PERSN = CHR(1) " +
           "                                  OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
           "                                                                                        WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
           "                                                                                        WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
           "                                                                                        ELSE Y.T_PERS_NUMBER_BISQUIT END ) AS T_PERS_NUMBER_BISQUIT " +
           "                                                                               FROM ( SELECT NVL(( SELECT U.T_NAME FROM dllvalues_dbt U " +
           "                                                                                                   WHERE U.T_LIST = 5005 " +
           "                                                                                                    AND U.T_ELEMENT = B.T_NUMBER_PACK ), '9090909') AS CNTRPERSNUMBER, " +
           "                                                                                       NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
           "                                                                                              WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
           "                                                                                                               WHERE V.T_OBJECTTYPE = 92 " +
           "                                                                                                                AND V.T_NOTEKIND = 200 " +
           "                                                                                                                AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
           "                                                                                                                AND V.T_DATE <= B.T_DATE_CARRY ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
           "                                                                                       ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
           "                                                                                                                                         WHERE W.T_CODE = B.T_DEPARTMENT ) END ) AS T_BRANCH " +
           "                                                                                      FROM DUAL ) Y ) ) > 0 ) " +
           "                                    ) " +

           "                               AND A.T_OPDATE BETWEEN :DateBegin_3_1 AND :DateEnd_3_1 " +
           "                               AND A.T_OPDATE = B.T_DATE_CARRY " +

           "                               AND  B.T_ACCOUNT_PAYER = /*A.T_ACCT_DB*/ " +
           "                                 NVL( A.T_ACCT_DB, ( SELECT G.T_ACCT_DB FROM uloadentforcompare_dbt G " +
           "                                                     WHERE  G.T_IDBISCOTTO = A.T_IDBISCOTTO " +
           "                                                      AND G.T_REQID = A.T_REQID " +
           "                                                      AND   G.T_ACCT_CR IS NULL AND G.T_ACCT_DB IS NOT NULL )  ) " +

           "                               AND B.T_ACCOUNT_RECEIVER = /*A.T_ACCT_CR*/ " +
           "                                 NVL ( A.T_ACCT_CR, ( SELECT G.T_ACCT_CR FROM uloadentforcompare_dbt G " +
           "                                                      WHERE  G.T_IDBISCOTTO = A.T_IDBISCOTTO " +
           "                                                        AND G.T_REQID = A.T_REQID " +
           "                                                        AND   G.T_ACCT_DB IS NULL AND G.T_ACCT_CR IS NOT NULL )  ) " +

           "                               AND B.T_DATE_CARRY = A.T_OPDATE " +
           "                               AND B.T_ACCTRNID = A.T_ACCTRNID ) ) " +
           "   AND C.T_ACCTRNID > 0 " +
           "   AND  ( C.T_ACCT_DB IS NULL AND C.T_ACCT_CR IS NOT NULL " +
           "    OR C.T_ACCT_DB IS NOT NULL AND C.T_ACCT_CR IS NULL ) " +
           "   AND EXISTS( SELECT 1 FROM  utableprocessevent_dbt D " +
           "               WHERE D.T_OBJECTID = C.T_ACCTRNID " +
           "                AND D.T_OBJECTTYPE IN (1, 501) " +
           "                AND D.T_TYPE = 1 " +
           "                AND D.T_STATUS = 4 " +
           "                AND D.T_MESSAGEID IS NOT NULL " +
           "                AND D.T_MESSAGEID > 0 " +
//           "                AND D.T_RESULTCODE = 0 " +
           "                AND NOT EXISTS( SELECT 1 FROM utableprocessevent_dbt I " +
           "                                WHERE I.T_OBJECTID = D.T_OBJECTID " +
           "                                 AND I.T_OBJECTTYPE = D.T_OBJECTTYPE " +
           "                                 AND I.T_TYPE = 3 " +
           "                                 AND I.T_RECID >  D.T_RECID ) ) " +

           "  GROUP BY T_ACCTRNID " +
           "  HAVING COUNT(T_ACCTRNID) > 2 " +
           "  ) A " +
           "  WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
           "                    WHERE V.T_BISCOTTOID = D.T_IDBISCOTTO ) " +
           "   AND D.T_AUTOKEY = A.T_AUTOKEY_DOUBLE " +

           "  UNION ALL " +

            // --из СОФР в БИСКВИТ проводки СОФР отсутствуют в БИСКВИТ кроме полу-проводок
/*
           "  SELECT -1 AS T_AUTOKEY, CHR(0) AS T_COUNTER, CHR(0) AS T_USERID, C.T_DATE_CARRY AS T_OPDATE, C.T_DATE_CARRY AS T_DOCDATE, C.T_ACCOUNT_PAYER AS T_ACCT_DB, " +
           "   C.T_ACCOUNT_RECEIVER AS T_ACCT_CR, " +
           "   ( SELECT F.T_CODEINACCOUNT FROM dfininstr_dbt F " +
           "     WHERE F.T_FIID = C.T_FIID_PAYER ) AS T_CURRENCY, " +
           "   C.T_SUM_PAYER AS T_AMTCUR, C.T_SUM_NATCUR AS T_AMTRUB, " +
           "   C.T_GROUND AS T_DETAILS, C.T_NUMB_DOCUMENT AS T_DOCNUM, C.T_ACCTRNID, CHR(0) AS T_IDBISCOTTO, CHR(0) AS T_REQID, 4 AS T_ERR_CODE, 'Из СОФР в БИСКВИТ. Присутствует в СОФР, Отсутствует в БИСКВИТ' AS T_ERR_TEXT, " +
           "   0 AS T_OPER, '' AS T_MODULE " +
           "  FROM dacctrn_dbt C " +
           "  WHERE C.T_DATE_CARRY BETWEEN :DateBegin_5 AND :DateEnd_5 " +
           "   AND C.T_ACCTRNID NOT IN( ( SELECT B.T_ACCTRNID FROM dacctrn_dbt B, uloadentforcompare_dbt A " +

           "   , ( " + SQLStrFromArray + " ) Z " +

           "                              WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
           "                                                WHERE V.T_BISCOTTOID = A.T_IDBISCOTTO ) " +
           "                               AND A.T_REQID = :ReqId_5 " +
           "                               AND (Z.ID < 0 " +
           "                                OR ( Z.ACC_D = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_ACCOUNT_PAYER ) > 0 ) " +
           "                                AND ( Z.ACC_C = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_ACCOUNT_RECEIVER ) > 0) " +
           "                                 AND ( Z.PERSN = CHR(1) " +
           "                                  OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
           "                                                                                        WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
           "                                                                                        WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
           "                                                                                        ELSE Y.T_PERS_NUMBER_BISQUIT END ) AS T_PERS_NUMBER_BISQUIT " +
           "                                                                               FROM ( SELECT NVL(( SELECT U.T_NAME FROM dllvalues_dbt U " +
           "                                                                                                   WHERE U.T_LIST = 5005 " +
           "                                                                                                    AND U.T_ELEMENT = B.T_NUMBER_PACK ), '9090909') AS CNTRPERSNUMBER, " +
           "                                                                                       NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
           "                                                                                              WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
           "                                                                                                               WHERE V.T_OBJECTTYPE = 92 " +
           "                                                                                                                AND V.T_NOTEKIND = 200 " +
           "                                                                                                                AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
           "                                                                                                                AND V.T_DATE <= B.T_DATE_CARRY ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
           "                                                                                       ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
           "                                                                                                                                         WHERE W.T_CODE = B.T_DEPARTMENT ) END ) AS T_BRANCH " +
           "                                                                                      FROM DUAL ) Y ) ) > 0 ) " +
           "                                    ) " +

           "                               AND A.T_ACCTRNID > 0 " +
           "                               AND A.T_OPDATE BETWEEN :DateBegin_4 AND :DateEnd_4 " +
           "                               AND B.T_DATE_CARRY = A.T_OPDATE " +
           "                               AND A.T_ACCT_DB IS NOT NULL " +
           "                               AND A.T_ACCT_CR IS NOT NULL " +

           "                               AND ( A.T_ACCT_DB = B.T_ACCOUNT_PAYER " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_DB ) ) " +

           "                               AND ( A.T_ACCT_CR = B.T_ACCOUNT_RECEIVER " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_CR ) ) " +

           "                               AND A.T_OPDATE = B.T_DATE_CARRY " +
           "                               AND A.T_ACCTRNID = B.T_ACCTRNID ) ) " +
           "   AND EXISTS( SELECT 1 FROM  utableprocessevent_dbt D " +
           "               WHERE D.T_OBJECTID = C.T_ACCTRNID " +
           "                AND D.T_OBJECTTYPE IN (1, 501) " +
           "                AND D.T_TYPE = 1 " +
           "                AND D.T_STATUS IN( 4, 5 ) " + //!!!исключаем коллизии - ошибка выгрузки в БИСКВИТ
           "                AND D.T_MESSAGEID IS NOT NULL " +
           "                AND D.T_MESSAGEID > 0 " +
//           "                AND D.T_RESULTCODE = 0 " +
           "                AND NOT EXISTS( SELECT 1 FROM utableprocessevent_dbt I " +
           "                                WHERE I.T_OBJECTID = D.T_OBJECTID " +
           "                                 AND I.T_OBJECTTYPE = D.T_OBJECTTYPE " +
           "                                 AND I.T_TYPE = 3 " +
           "                                 AND I.T_RECID >  D.T_RECID ) ) " +
           
           "  UNION ALL " +
*/
            // --из СОФР в БИСКВИТ проводки СОФР отсутствуют в БИСКВИТ в том числе полу-проводки

           "  SELECT -1 AS T_AUTOKEY, CHR(0) AS T_COUNTER, CHR(0) AS T_USERID, C.T_DATE_CARRY AS T_OPDATE, C.T_DATE_CARRY AS T_DOCDATE, C.T_ACCOUNT_PAYER AS T_ACCT_DB, " +
           "   C.T_ACCOUNT_RECEIVER AS T_ACCT_CR, " +
           "   ( SELECT F.T_CODEINACCOUNT FROM dfininstr_dbt F " +
           "     WHERE F.T_FIID = C.T_FIID_PAYER ) AS T_CURRENCY, " +
           "   C.T_SUM_PAYER AS T_AMTCUR, C.T_SUM_NATCUR AS T_AMTRUB, " +
           "   C.T_GROUND AS T_DETAILS, C.T_NUMB_DOCUMENT AS T_DOCNUM, C.T_ACCTRNID, CHR(0) AS T_IDBISCOTTO, CHR(0) AS T_REQID, 4 AS T_ERR_CODE, " +
           "   USR_PKG_IMPORT_SOFR.GetStrEventErr( 1, 1, T_ACCTRNID ) AS T_ERR_TEXT, " +
//            'Из СОФР в БИСКВИТ. Присутствует в СОФР, Отсутствует в БИСКВИТ' AS T_ERR_TEXT, " +
           "   0 AS T_OPER, '' AS T_MODULE " +
           "  FROM dacctrn_dbt C " +

           "   , ( " + SQLStrFromArray + " ) X " +

           "  WHERE C.T_DATE_CARRY BETWEEN :DateBegin_5_1 AND :DateEnd_5_1 " +
           "                               AND (X.ID < 0 " +
           "                                OR ( X.ACC_D = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( X.ACC_D, C.T_ACCOUNT_PAYER ) > 0 ) " +
           "                                AND ( X.ACC_C = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( X.ACC_C, C.T_ACCOUNT_RECEIVER ) > 0) " +
           "                                 AND ( X.PERSN = CHR(1) " +
           "                                  OR RSB_MASK.CompareStringWithMask(X.PERSN, ( SELECT ( CASE WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
           "                                                                                        WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
           "                                                                                        WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
           "                                                                                        ELSE Y.T_PERS_NUMBER_BISQUIT END ) AS T_PERS_NUMBER_BISQUIT " +
           "                                                                               FROM ( SELECT NVL(( SELECT U.T_NAME FROM dllvalues_dbt U " +
           "                                                                                                   WHERE U.T_LIST = 5005 " +
           "                                                                                                    AND U.T_ELEMENT = C.T_NUMBER_PACK ), '9090909') AS CNTRPERSNUMBER, " +
           "                                                                                       NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
           "                                                                                              WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
           "                                                                                                               WHERE V.T_OBJECTTYPE = 92 " +
           "                                                                                                                AND V.T_NOTEKIND = 200 " +
           "                                                                                                                AND V.T_DOCUMENTID = LPAD( TO_CHAR( C.T_OPER ), 10, '0') " +
           "                                                                                                                AND V.T_DATE <= C.T_DATE_CARRY ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
           "                                                                                       ( CASE WHEN C.T_DEPARTMENT = 1 THEN '0000' ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
           "                                                                                                                                         WHERE W.T_CODE = C.T_DEPARTMENT ) END ) AS T_BRANCH " +
           "                                                                                      FROM DUAL ) Y ) ) > 0 ) " +
           "                                  ) " +

           "   AND C.T_ACCTRNID NOT IN( ( SELECT B.T_ACCTRNID FROM dacctrn_dbt B, uloadentforcompare_dbt A " +

           "   , ( " + SQLStrFromArray + " ) Z " +

           "                              WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
           "                                                WHERE V.T_BISCOTTOID = A.T_IDBISCOTTO ) " +
           "                               AND A.T_REQID = :ReqId_5 " +
           "                               AND (Z.ID < 0 " +
           "                                OR ( Z.ACC_D = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_ACCOUNT_PAYER ) > 0 ) " +
           "                                AND ( Z.ACC_C = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_ACCOUNT_RECEIVER ) > 0) " +
           "                                 AND ( Z.PERSN = CHR(1) " +
           "                                  OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
           "                                                                                        WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
           "                                                                                        WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
           "                                                                                        ELSE Y.T_PERS_NUMBER_BISQUIT END ) AS T_PERS_NUMBER_BISQUIT " +
           "                                                                               FROM ( SELECT NVL(( SELECT U.T_NAME FROM dllvalues_dbt U " +
           "                                                                                                   WHERE U.T_LIST = 5005 " +
           "                                                                                                    AND U.T_ELEMENT = B.T_NUMBER_PACK ), '9090909') AS CNTRPERSNUMBER, " +
           "                                                                                       NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
           "                                                                                              WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
           "                                                                                                               WHERE V.T_OBJECTTYPE = 92 " +
           "                                                                                                                AND V.T_NOTEKIND = 200 " +
           "                                                                                                                AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
           "                                                                                                                AND V.T_DATE <= B.T_DATE_CARRY ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
           "                                                                                       ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
           "                                                                                                                                         WHERE W.T_CODE = B.T_DEPARTMENT ) END ) AS T_BRANCH " +
           "                                                                                      FROM DUAL ) Y ) ) > 0 ) " +
           "                                    ) " +

           "                               AND A.T_ACCTRNID > 0 " +
           "                               AND A.T_OPDATE BETWEEN :DateBegin_4 AND :DateEnd_4 " +
           "                               AND B.T_DATE_CARRY = A.T_OPDATE " +
           "                               AND A.T_ACCT_DB IS NOT NULL " +
           "                               AND A.T_ACCT_CR IS NOT NULL " +

           "                               AND ( A.T_ACCT_DB = B.T_ACCOUNT_PAYER " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_DB ) ) " +

           "                               AND ( A.T_ACCT_CR = B.T_ACCOUNT_RECEIVER " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_CR ) ) " +

           "                               AND A.T_OPDATE = B.T_DATE_CARRY " +
           "                               AND A.T_ACCTRNID = B.T_ACCTRNID ) ) " +

           "   AND C.T_ACCTRNID NOT IN( ( SELECT B.T_ACCTRNID FROM dacctrn_dbt B, uloadentforcompare_dbt A " +

           "   , ( " + SQLStrFromArray + " ) Z " +

           "                              WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
           "                                                WHERE V.T_BISCOTTOID = A.T_IDBISCOTTO ) " +
           "                               AND A.T_REQID = :ReqId_5_1 " +
           "                               AND (Z.ID < 0 " +
           "                                OR ( Z.ACC_D = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_ACCOUNT_PAYER ) > 0 ) " +
           "                                AND ( Z.ACC_C = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_ACCOUNT_RECEIVER ) > 0) " +
           "                                 AND ( Z.PERSN = CHR(1) " +
           "                                  OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
           "                                                                                        WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
           "                                                                                        WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
           "                                                                                        ELSE Y.T_PERS_NUMBER_BISQUIT END ) AS T_PERS_NUMBER_BISQUIT " +
           "                                                                               FROM ( SELECT NVL(( SELECT U.T_NAME FROM dllvalues_dbt U " +
           "                                                                                                   WHERE U.T_LIST = 5005 " +
           "                                                                                                    AND U.T_ELEMENT = B.T_NUMBER_PACK ), '9090909') AS CNTRPERSNUMBER, " +
           "                                                                                       NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
           "                                                                                              WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
           "                                                                                                               WHERE V.T_OBJECTTYPE = 92 " +
           "                                                                                                                AND V.T_NOTEKIND = 200 " +
           "                                                                                                                AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
           "                                                                                                                AND V.T_DATE <= B.T_DATE_CARRY ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
           "                                                                                       ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
           "                                                                                                                                         WHERE W.T_CODE = B.T_DEPARTMENT ) END ) AS T_BRANCH " +
           "                                                                                      FROM DUAL ) Y ) ) > 0 ) " +
           "                                    ) " +

           "                               AND A.T_ACCTRNID > 0 " +
           "                               AND A.T_OPDATE BETWEEN :DateBegin_4_1 AND :DateEnd_4_1 " +
           "                               AND B.T_DATE_CARRY = A.T_OPDATE " +
           "                               AND  ( A.T_ACCT_DB IS NULL AND A.T_ACCT_CR IS NOT NULL " +
           "                                OR A.T_ACCT_DB IS NOT NULL AND A.T_ACCT_CR IS NULL ) " +

           "                               AND  NVL( A.T_ACCT_DB, ( SELECT G.T_ACCT_DB FROM uloadentforcompare_dbt G " +
           "                                                        WHERE  G.T_IDBISCOTTO = A.T_IDBISCOTTO " +
           "                                                         AND G.T_REQID = A.T_REQID " +
           "                                                         AND  G.T_ACCT_CR IS NULL AND G.T_ACCT_DB IS NOT NULL )  ) = B.T_ACCOUNT_PAYER " +

           "                               AND  NVL ( A.T_ACCT_CR, ( SELECT G.T_ACCT_CR FROM uloadentforcompare_dbt G " +
           "                                                         WHERE  G.T_IDBISCOTTO = A.T_IDBISCOTTO " +
           "                                                           AND G.T_REQID = A.T_REQID " +
           "                                                           AND  G.T_ACCT_DB IS NULL AND G.T_ACCT_CR IS NOT NULL )  ) = B.T_ACCOUNT_RECEIVER " +

           "                               AND A.T_OPDATE = B.T_DATE_CARRY " +
           "                               AND A.T_ACCTRNID = B.T_ACCTRNID ) ) " + 
           "   AND EXISTS( SELECT 1 FROM  utableprocessevent_dbt D " +
           "               WHERE D.T_OBJECTID = C.T_ACCTRNID " +
           "                AND D.T_OBJECTTYPE IN (1, 501) " +
           "                AND D.T_TYPE = 1 " +
           "                AND D.T_STATUS IN( 4, 5 ) " + //!!!исключаем коллизии - ошибка выгрузки в БИСКВИТ
           "                AND D.T_MESSAGEID IS NOT NULL " +
           "                AND D.T_MESSAGEID > 0 " +
//           "                AND D.T_RESULTCODE = 0 " +
           "                AND NOT EXISTS( SELECT 1 FROM utableprocessevent_dbt I " +
           "                                WHERE I.T_OBJECTID = D.T_OBJECTID " +
           "                                 AND I.T_OBJECTTYPE = D.T_OBJECTTYPE " +
           "                                 AND I.T_TYPE = 3 " +
           "                                 AND I.T_RECID >  D.T_RECID ) ) " +
           "  UNION ALL " +

            // --из СОФР в БИСКВИТ платежи БИСКВИТ отсутствуют в СОФР
           "  SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB, " +
           "   T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 1 AS T_ERR_CODE, " +
//             'Из СОФР в БИСКВИТ. Отсутствует в СОФР' AS T_ERR_TEXT, " +
           "   USR_PKG_IMPORT_SOFR.GetStrEventErr( 0, 501, T_ACCTRNID * -1 ) AS T_ERR_TEXT, " +
           "   0 AS T_OPER, '' AS T_MODULE " +
           "  FROM uloadentforcompare_dbt C " +
           "  WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
           "                    WHERE V.T_BISCOTTOID = C.T_IDBISCOTTO ) " +
           "   AND  C.T_AUTOKEY NOT IN( ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dpmpaym_dbt B " +

           "   , ( " + SQLStrFromArray + " ) Z " +

           "                              WHERE A.T_REQID = :ReqId_1_2 " +
           "                               AND (Z.ID < 0 " +
           "                                OR ( Z.ACC_D = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_FUTUREPAYERACCOUNT ) > 0 " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_PAYERACCOUNT ) > 0 ) " +
           "                                AND ( Z.ACC_C = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_FUTURERECEIVERACCOUNT ) > 0 " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_RECEIVERACCOUNT ) > 0 ) " + 
           "                                 AND ( Z.PERSN = CHR(1) " +
           "                                  OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
           "                                                                                        WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
           "                                                                                        WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
           "                                                                                        ELSE Y.T_PERS_NUMBER_BISQUIT END ) AS T_PERS_NUMBER_BISQUIT " +
           "                                                                               FROM ( SELECT NVL(( SELECT U.T_NAME FROM dllvalues_dbt U " +
           "                                                                                                   WHERE U.T_LIST = 5005 " +
           "                                                                                                    AND U.T_ELEMENT = B.T_NUMBERPACK ), '9090909') AS CNTRPERSNUMBER, " +
           "                                                                                       NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
           "                                                                                              WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
           "                                                                                                               WHERE V.T_OBJECTTYPE = 92 " +
           "                                                                                                                AND V.T_NOTEKIND = 200 " +
           "                                                                                                                AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
           "                                                                                                                AND V.T_DATE <= B.T_VALUEDATE ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
           "                                                                                       ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
           "                                                                                                                                         WHERE W.T_CODE = B.T_DEPARTMENT ) END ) AS T_BRANCH " +
           "                                                                                      FROM DUAL ) Y ) ) > 0 ) " +
           "                                 ) " +
 
           "                               AND EXISTS( SELECT 1 FROM  utableprocessevent_dbt D " +
           "                                           WHERE D.T_OBJECTID = A.T_ACCTRNID * -1 " +
           "                                            AND D.T_OBJECTTYPE = 501 " +
           "                                            AND D.T_TYPE IN( 1, 2 ) " +
           "                                            AND D.T_STATUS = 4 " +
           "                                            AND D.T_MESSAGEID IS NOT NULL " +
           "                                            AND D.T_MESSAGEID > 0 " +
//           "                                            AND D.T_RESULTCODE = 0 " +
           "                                            AND NOT EXISTS( SELECT 1 FROM utableprocessevent_dbt I " +
           "                                                            WHERE I.T_OBJECTID = D.T_OBJECTID " +
           "                                                             AND I.T_OBJECTTYPE = D.T_OBJECTTYPE " +
           "                                                             AND I.T_TYPE = 3 " +
           "                                                             AND I.T_RECID >  D.T_RECID ) ) " +

           "                               AND A.T_OPDATE BETWEEN :DateBegin_1_2 AND :DateEnd_1_2 " +
           "                               AND A.T_OPDATE = B.T_VALUEDATE " +
/*теперь нам все равно какие счета
           "                               AND ( B.T_FUTUREPAYERACCOUNT = A.T_ACCT_DB " +
           "                                OR B.T_PAYERACCOUNT = A.T_ACCT_DB " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_DB ) ) " +

           "                               AND ( B.T_FUTURERECEIVERACCOUNT = A.T_ACCT_CR " +
           "                                OR B.T_RECEIVERACCOUNT = A.T_ACCT_CR " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_CR ) ) " +
*/
           "                               AND B.T_VALUEDATE = A.T_OPDATE " +
           "                               AND B.T_PAYMENTID = A.T_ACCTRNID * -1 ) ) " +
           "   AND C.T_REQID = :ReqId_2_2 " +
           "   AND C.T_ACCTRNID < 0 " +
           "   AND C.T_ACCT_DB IS NOT NULL " +
           "   AND C.T_ACCT_CR IS NOT NULL " +
           "  UNION ALL " +

            // --из СОФР в БИСКВИТ платежи БИСКВИТ присутствуют в СОФР, не соответствуют реквизиты
           "  SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB, " +
           "   T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 2 AS T_ERR_CODE, 'Из СОФР в БИСКВИТ. Присутствует в СОФР, не соответствуют реквизиты: ' || " +
           "   USR_PKG_IMPORT_SOFR.GetDifferenceStrErr( 2, C.T_ACCT_DB, C.T_ACCT_CR, C.T_AMTCUR, C.T_AMTRUB, C.T_CURRENCY, C.T_DETAILS, C.T_DOCNUM, " +
           "    C.T_ACCTRNID, C.T_IDBISCOTTO, C.T_REQID ) AS T_ERR_TEXT, " +
           "    ( SELECT R.T_OPER FROM dpmpaym_dbt R WHERE R.T_PAYMENTID = C.T_ACCTRNID * -1 ) AS T_OPER, " +
           "    ( SELECT W.T_BOFFICE FROM rshb_fd_groups W " +
           "      WHERE W.T_GROUPID IN(( SELECT O.T_GROUPID FROM dacsgroupoper_dbt O " +
           "                             WHERE O.T_OPER = ( SELECT R.T_OPER FROM dpmpaym_dbt R " +
           "                                                WHERE R.T_PAYMENTID = C.T_ACCTRNID * -1 ))) " +
           "       AND ROWNUM = 1 ) AS T_MODULE " +

           "  FROM uloadentforcompare_dbt C " +
           "  WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
           "                    WHERE V.T_BISCOTTOID = C.T_IDBISCOTTO ) " +
           "    AND     C.T_AUTOKEY IN( ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dpmpaym_dbt B " +
           "   , ( " + SQLStrFromArray + " ) Z " +
           "                              WHERE A.T_REQID = :ReqId_3_2 " + 
           "                               AND (Z.ID < 0 " +
           "                                OR ( Z.ACC_D = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_FUTUREPAYERACCOUNT ) > 0 " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_PAYERACCOUNT ) > 0 ) " +
           "                                AND ( Z.ACC_C = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_FUTURERECEIVERACCOUNT ) > 0 " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_RECEIVERACCOUNT ) > 0 ) " +
           "                                 AND ( Z.PERSN = CHR(1) " +
           "                                  OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
           "                                                                                        WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
           "                                                                                        WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
           "                                                                                        ELSE Y.T_PERS_NUMBER_BISQUIT END ) AS T_PERS_NUMBER_BISQUIT " +
           "                                                                               FROM ( SELECT NVL(( SELECT U.T_NAME FROM dllvalues_dbt U " +
           "                                                                                                   WHERE U.T_LIST = 5005 " +
           "                                                                                                    AND U.T_ELEMENT = B.T_NUMBERPACK ), '9090909') AS CNTRPERSNUMBER, " +
           "                                                                                       NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
           "                                                                                              WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
           "                                                                                                               WHERE V.T_OBJECTTYPE = 92 " +
           "                                                                                                                AND V.T_NOTEKIND = 200 " +
           "                                                                                                                AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
           "                                                                                                                AND V.T_DATE <= B.T_VALUEDATE ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
           "                                                                                       ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
           "                                                                                                                                         WHERE W.T_CODE = B.T_DEPARTMENT ) END ) AS T_BRANCH " +
           "                                                                                      FROM DUAL ) Y ) ) > 0 ) " +
           "                                 ) " +

           "                               AND A.T_OPDATE BETWEEN :DateBegin_2_2 AND :DateEnd_2_2 " +
           "                               AND A.T_OPDATE = B.T_VALUEDATE " +
/*теперь нам все равно какие счета
           "                               AND ( B.T_FUTUREPAYERACCOUNT = A.T_ACCT_DB " +
           "                                OR B.T_PAYERACCOUNT = A.T_ACCT_DB " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_DB ) ) " +

           "                               AND ( B.T_FUTURERECEIVERACCOUNT = A.T_ACCT_CR " +
           "                                OR B.T_RECEIVERACCOUNT = A.T_ACCT_CR " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_CR ) ) " +
*/
           "                               AND B.T_VALUEDATE = A.T_OPDATE " +
           "                               AND B.T_PAYMENTID = A.T_ACCTRNID * -1 ) ) " +
           "   AND C.T_ACCTRNID < 0 " +
           "   AND C.T_ACCT_DB IS NOT NULL " +
           "   AND C.T_ACCT_CR IS NOT NULL " +
           "   AND EXISTS( SELECT 1 FROM dpmpaym_dbt D " +
           "               WHERE D.T_PAYMENTID = C.T_ACCTRNID * -1 " +
           "                AND ( D.T_PAYERACCOUNT <> C.T_ACCT_DB " +
           "                AND D.T_FUTUREPAYERACCOUNT <> C.T_ACCT_DB " +
           "                       AND NOT EXISTS( SELECT 1 FROM dbrokacc_dbt E " +
           "                                       WHERE E.T_ACCOUNT =  C.T_ACCT_DB ) " +
           "                      OR D.T_RECEIVERACCOUNT <> C.T_ACCT_CR " +
           "                       AND D.T_FUTURERECEIVERACCOUNT <> C.T_ACCT_CR " +
           "                       AND NOT EXISTS( SELECT 1 FROM dbrokacc_dbt E " +
           "                                       WHERE E.T_ACCOUNT =  C.T_ACCT_CR ) " +
           "                      OR ( CASE WHEN D.T_FIID = 0 AND D.T_PAYFIID = 0 OR C.T_AMTCUR = 0 /*переоценка*/ THEN 0 ELSE D.T_AMOUNT END ) <> C.T_AMTCUR " +
//!!!           "                      OR D.T_SUM_NATCUR <> C.T_AMTRUB " +

/*поле валюта не сверяем
           "                      OR C.T_CURRENCY <> ( SELECT F.T_CODEINACCOUNT FROM dfininstr_dbt F " +
           "                                           WHERE F.T_FIID = D.T_FIID ) " +
*/
//!!!           "                      OR D.T_GROUND <> C.T_DETAILS " +
//           "                      OR 'paym' || TO_CHAR(D.T_PAYMENTID) <> C.T_DOCNUM " +
           "                    )) " +
           "   AND EXISTS( SELECT 1 FROM  utableprocessevent_dbt D " +
           "               WHERE D.T_OBJECTID = C.T_ACCTRNID * -1 " +
           "                AND D.T_OBJECTTYPE = 501 " +
           "                AND D.T_TYPE IN( 1, 2 ) " +
           "                AND D.T_STATUS = 4 " +
           "                AND D.T_MESSAGEID IS NOT NULL " +
           "                AND D.T_MESSAGEID > 0 " +
//           "                AND D.T_RESULTCODE = 0 " +
           "                AND NOT EXISTS( SELECT 1 FROM utableprocessevent_dbt I " +
           "                                WHERE I.T_OBJECTID = D.T_OBJECTID " +
           "                                 AND I.T_OBJECTTYPE = D.T_OBJECTTYPE " +
           "                                 AND I.T_TYPE = 3 " +
           "                                 AND I.T_RECID >  D.T_RECID ) ) " +


           "  UNION ALL " +


            // --из СОФР в БИСКВИТ платежи БИСКВИТ присутствуют в СОФР, задвоенные в БИСКВИТ

           "  SELECT D.T_AUTOKEY, D.T_COUNTER, D.T_USERID, D.T_OPDATE, D.T_DOCDATE, D.T_ACCT_DB, D.T_ACCT_CR, D.T_CURRENCY, D.T_AMTCUR, D.T_AMTRUB, " +
           "   D.T_DETAILS, D.T_DOCNUM, D.T_ACCTRNID, D.T_IDBISCOTTO, D.T_REQID, 3 AS T_ERR_CODE, 'Из СОФР в БИСКВИТ. Присутствует в СОФР, задвоенные в БИСКВИТ' AS T_ERR_TEXT, " +
           "   0 AS T_OPER, '' AS T_MODULE " +
           "  FROM uloadentforcompare_dbt D, " +
           "  ( " +
           "  SELECT T_ACCTRNID, MAX( T_AUTOKEY ) AS T_AUTOKEY_DOUBLE, MIN( T_AUTOKEY ) AS T_AUTOKEY_PRIOR  FROM uloadentforcompare_dbt C " +
           "  WHERE C.T_AUTOKEY IN( ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dpmpaym_dbt B " +

           "   , ( " + SQLStrFromArray + " ) Z " +

           "                              WHERE A.T_REQID = :ReqId_4_2 " +
           "                               AND (Z.ID < 0 " +
           "                                OR ( Z.ACC_D = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_FUTUREPAYERACCOUNT ) > 0 " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_PAYERACCOUNT ) > 0 ) " +
           "                                AND ( Z.ACC_C = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_FUTURERECEIVERACCOUNT ) > 0 " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_RECEIVERACCOUNT ) > 0) " +
           "                                 AND ( Z.PERSN = CHR(1) " +
           "                                  OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
           "                                                                                        WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
           "                                                                                        WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
           "                                                                                        ELSE Y.T_PERS_NUMBER_BISQUIT END ) AS T_PERS_NUMBER_BISQUIT " +
           "                                                                               FROM ( SELECT NVL(( SELECT U.T_NAME FROM dllvalues_dbt U " +
           "                                                                                                   WHERE U.T_LIST = 5005 " +
           "                                                                                                    AND U.T_ELEMENT = B.T_NUMBERPACK ), '9090909') AS CNTRPERSNUMBER, " +
           "                                                                                       NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
           "                                                                                              WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
           "                                                                                                               WHERE V.T_OBJECTTYPE = 92 " +
           "                                                                                                                AND V.T_NOTEKIND = 200 " +
           "                                                                                                                AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
           "                                                                                                                AND V.T_DATE <= B.T_VALUEDATE ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
           "                                                                                       ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
           "                                                                                                                                         WHERE W.T_CODE = B.T_DEPARTMENT ) END ) AS T_BRANCH " +
           "                                                                                      FROM DUAL ) Y ) ) > 0 ) " +
           "                                   ) " +

           "                               AND A.T_OPDATE BETWEEN :DateBegin_3_2 AND :DateEnd_3_2 " +
           "                               AND A.T_OPDATE = B.T_VALUEDATE " +

           "                               AND ( B.T_FUTUREPAYERACCOUNT = A.T_ACCT_DB " +
           "                                OR B.T_PAYERACCOUNT = A.T_ACCT_DB " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_DB ) ) " +

           "                               AND ( B.T_FUTURERECEIVERACCOUNT = A.T_ACCT_CR " +
           "                                OR B.T_RECEIVERACCOUNT = A.T_ACCT_CR " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_CR ) ) " +

           "                               AND B.T_VALUEDATE = A.T_OPDATE " +
           "                               AND B.T_PAYMENTID = A.T_ACCTRNID * -1 ) ) " +
           "   AND C.T_ACCTRNID < 0 " +
           "   AND C.T_ACCT_DB IS NOT NULL " +
           "   AND C.T_ACCT_CR IS NOT NULL " +
           "   AND EXISTS( SELECT 1 FROM  utableprocessevent_dbt D " +
           "               WHERE D.T_OBJECTID = C.T_ACCTRNID * -1 " +
           "                AND D.T_OBJECTTYPE = 501 " +
           "                AND D.T_TYPE = 1 " +
           "                AND D.T_STATUS = 4 " +
           "                AND D.T_MESSAGEID IS NOT NULL " +
           "                AND D.T_MESSAGEID > 0 " +
//           "                AND D.T_RESULTCODE = 0 " +
           "                AND NOT EXISTS( SELECT 1 FROM utableprocessevent_dbt I " +
           "                                WHERE I.T_OBJECTID = D.T_OBJECTID " +
           "                                 AND I.T_OBJECTTYPE = D.T_OBJECTTYPE " +
           "                                 AND I.T_TYPE = 3 " +
           "                                 AND I.T_RECID >  D.T_RECID ) ) " +

           "  GROUP BY T_ACCTRNID " +
           "  HAVING COUNT(T_ACCTRNID) > 1 " +
           "  ) A " +
           "  WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
           "                    WHERE V.T_BISCOTTOID = D.T_IDBISCOTTO ) " +
           "   AND D.T_AUTOKEY = A.T_AUTOKEY_DOUBLE " +

           "  UNION ALL " +

            // --из СОФР в БИСКВИТ платежи СОФР отсутствуют в БИСКВИТ

           "  SELECT -1 AS T_AUTOKEY, CHR(0) AS T_COUNTER, CHR(0) AS T_USERID, C.T_VALUEDATE AS T_OPDATE, C.T_VALUEDATE AS T_DOCDATE, C.T_PAYERACCOUNT AS T_ACCT_DB, " +
           "   C.T_RECEIVERACCOUNT AS T_ACCT_CR, " +
           "   ( SELECT F.T_CODEINACCOUNT FROM dfininstr_dbt F " +
           "     WHERE F.T_FIID = C.T_FIID ) AS T_CURRENCY, " +
           "   C.T_AMOUNT AS T_AMTCUR, C.T_BASEAMOUNT AS T_AMTRUB, " +
           "   H.T_GROUND AS T_DETAILS, TO_CHAR( C.T_PAYMENTID ) AS T_DOCNUM, C.T_PAYMENTID, CHR(0) AS T_IDBISCOTTO, CHR(0) AS T_REQID, 4 AS T_ERR_CODE, " +
           "   USR_PKG_IMPORT_SOFR.GetStrEventErr( 1, 501, C.T_PAYMENTID ) AS T_ERR_TEXT, " +
//               'Из СОФР в БИСКВИТ. Присутствует в СОФР, Отсутствует в БИСКВИТ' AS T_ERR_TEXT, " +
           "   0 AS T_OPER, '' AS T_MODULE " +
           "  FROM dpmpaym_dbt C, dpmrmprop_dbt H " +

           "   , ( " + SQLStrFromArray + " ) X " +

           "  WHERE C.T_VALUEDATE BETWEEN :DateBegin_5_2 AND :DateEnd_5_2 " +
           "   AND H.T_PAYMENTID = C.T_PAYMENTID " +
           "   AND (X.ID < 0 " +
           "    OR ( X.ACC_D = CHR(1) " +
           "     OR RSB_MASK.CompareStringWithMask( X.ACC_D, C.T_PAYERACCOUNT ) > 0 ) " +
           "    AND ( X.ACC_C = CHR(1) " +
           "     OR RSB_MASK.CompareStringWithMask( X.ACC_C, C.T_RECEIVERACCOUNT ) > 0) ) " +

           "   AND C.T_PAYMENTID NOT IN( ( SELECT B.T_PAYMENTID FROM dpmpaym_dbt B, uloadentforcompare_dbt A " +

           "   , ( " + SQLStrFromArray + " ) Z " +

           "                              WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
           "                                                WHERE V.T_BISCOTTOID = A.T_IDBISCOTTO ) " +
           "                               AND A.T_REQID = :ReqId_5_2 " +
           "                               AND (Z.ID < 0 " +
           "                                OR ( Z.ACC_D = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_FUTUREPAYERACCOUNT ) > 0 " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_PAYERACCOUNT ) > 0 ) " +
           "                                AND ( Z.ACC_C = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_FUTURERECEIVERACCOUNT ) > 0 " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_RECEIVERACCOUNT ) > 0) " +
           "                                 AND ( Z.PERSN = CHR(1) " +
           "                                  OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
           "                                                                                        WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
           "                                                                                        WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
           "                                                                                        ELSE Y.T_PERS_NUMBER_BISQUIT END ) AS T_PERS_NUMBER_BISQUIT " +
           "                                                                               FROM ( SELECT NVL(( SELECT U.T_NAME FROM dllvalues_dbt U " +
           "                                                                                                   WHERE U.T_LIST = 5005 " +
           "                                                                                                    AND U.T_ELEMENT = B.T_NUMBERPACK ), '9090909') AS CNTRPERSNUMBER, " +
           "                                                                                       NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
           "                                                                                              WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
           "                                                                                                               WHERE V.T_OBJECTTYPE = 92 " +
           "                                                                                                                AND V.T_NOTEKIND = 200 " +
           "                                                                                                                AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
           "                                                                                                                AND V.T_DATE <= B.T_VALUEDATE ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
           "                                                                                       ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
           "                                                                                                                                         WHERE W.T_CODE = B.T_DEPARTMENT ) END ) AS T_BRANCH " +
           "                                                                                      FROM DUAL ) Y ) ) > 0 ) " +
           "                                  ) " +

           "                               AND A.T_ACCTRNID < 0 " +
           "                               AND A.T_OPDATE BETWEEN :DateBegin_4_2 AND :DateEnd_4_2 " +
           "                               AND B.T_VALUEDATE = A.T_OPDATE " +
           "                               AND A.T_ACCT_DB IS NOT NULL " +
           "                               AND A.T_ACCT_CR IS NOT NULL " +

           "                               AND ( A.T_ACCT_DB = B.T_FUTUREPAYERACCOUNT " +
           "                                OR A.T_ACCT_DB = B.T_PAYERACCOUNT " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_DB ) ) " +

           "                               AND ( A.T_ACCT_CR = B.T_FUTURERECEIVERACCOUNT " +
           "                                OR A.T_ACCT_CR = B.T_RECEIVERACCOUNT " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_CR ) ) " +

           "                               AND A.T_OPDATE = B.T_VALUEDATE " +
           "                               AND A.T_ACCTRNID = B.T_PAYMENTID  * -1 ) ) " +

           "   AND C.T_PAYMENTID NOT IN( ( SELECT B.T_PAYMENTID FROM dpmpaym_dbt B, uloadentforcompare_dbt A " +

           "   , ( " + SQLStrFromArray + " ) Z " +

           "                              WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
           "                                                WHERE V.T_BISCOTTOID = A.T_IDBISCOTTO ) " +
           "                               AND A.T_REQID = :ReqId_5_2_1 " +
           "                               AND (Z.ID < 0 " +
           "                                OR ( Z.ACC_D = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_FUTUREPAYERACCOUNT ) > 0 " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_PAYERACCOUNT ) > 0 ) " +
           "                                AND ( Z.ACC_C = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_FUTURERECEIVERACCOUNT ) > 0 " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_RECEIVERACCOUNT ) > 0) " +
           "                                 AND ( Z.PERSN = CHR(1) " +
           "                                  OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
           "                                                                                        WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
           "                                                                                        WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
           "                                                                                        ELSE Y.T_PERS_NUMBER_BISQUIT END ) AS T_PERS_NUMBER_BISQUIT " +
           "                                                                               FROM ( SELECT NVL(( SELECT U.T_NAME FROM dllvalues_dbt U " +
           "                                                                                                   WHERE U.T_LIST = 5005 " +
           "                                                                                                    AND U.T_ELEMENT = B.T_NUMBERPACK ), '9090909') AS CNTRPERSNUMBER, " +
           "                                                                                       NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
           "                                                                                              WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
           "                                                                                                               WHERE V.T_OBJECTTYPE = 92 " +
           "                                                                                                                AND V.T_NOTEKIND = 200 " +
           "                                                                                                                AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
           "                                                                                                                AND V.T_DATE <= B.T_VALUEDATE ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
           "                                                                                       ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
           "                                                                                                                                         WHERE W.T_CODE = B.T_DEPARTMENT ) END ) AS T_BRANCH " +
           "                                                                                      FROM DUAL ) Y ) ) > 0 ) " +
           "                                 ) " +

           "                               AND A.T_ACCTRNID < 0 " +
           "                               AND A.T_OPDATE BETWEEN :DateBegin_4_2_1 AND :DateEnd_4_2_1 " +
           "                               AND B.T_VALUEDATE = A.T_OPDATE " +
           "                               AND  ( A.T_ACCT_DB IS NULL AND A.T_ACCT_CR IS NOT NULL " +
           "                                OR A.T_ACCT_DB IS NOT NULL AND A.T_ACCT_CR IS NULL ) " +

           "                               AND  ( NVL( A.T_ACCT_DB, ( SELECT G.T_ACCT_DB FROM uloadentforcompare_dbt G " +
           "                                                          WHERE  G.T_IDBISCOTTO = A.T_IDBISCOTTO " +
           "                                                           AND G.T_REQID = A.T_REQID " +
           "                                                           AND  G.T_ACCT_CR IS NULL AND G.T_ACCT_DB IS NOT NULL )  ) = B.T_FUTUREPAYERACCOUNT " +
           "                                OR    NVL( A.T_ACCT_DB, ( SELECT G.T_ACCT_DB FROM uloadentforcompare_dbt G " +
           "                                                          WHERE  G.T_IDBISCOTTO = A.T_IDBISCOTTO " +
           "                                                           AND G.T_REQID = A.T_REQID " +
           "                                                           AND  G.T_ACCT_CR IS NULL AND G.T_ACCT_DB IS NOT NULL )  ) = B.T_PAYERACCOUNT ) " +

           "                               AND  ( NVL ( A.T_ACCT_CR, ( SELECT G.T_ACCT_CR FROM uloadentforcompare_dbt G " +
           "                                                         WHERE  G.T_IDBISCOTTO = A.T_IDBISCOTTO " +
           "                                                           AND G.T_REQID = A.T_REQID " +
           "                                                           AND  G.T_ACCT_DB IS NULL AND G.T_ACCT_CR IS NOT NULL )  ) = B.T_FUTURERECEIVERACCOUNT " +
           "                                OR    NVL ( A.T_ACCT_CR, ( SELECT G.T_ACCT_CR FROM uloadentforcompare_dbt G " +
           "                                                           WHERE  G.T_IDBISCOTTO = A.T_IDBISCOTTO " +
           "                                                            AND G.T_REQID = A.T_REQID " +
           "                                                            AND  G.T_ACCT_DB IS NULL AND G.T_ACCT_CR IS NOT NULL )  ) = B.T_RECEIVERACCOUNT ) " +

           "                               AND A.T_OPDATE = B.T_VALUEDATE " +
           "                               AND A.T_ACCTRNID = B.T_PAYMENTID  * -1 ) ) " + 
           "   AND EXISTS( SELECT 1 FROM  utableprocessevent_dbt D " +
           "               WHERE D.T_OBJECTID = C.T_PAYMENTID " +
           "                AND D.T_OBJECTTYPE = 501 " +
           "                AND D.T_TYPE = 1 " +
           "                AND D.T_STATUS IN( 4, 5 ) " + //!!!исключаем коллизии - ошибка выгрузки в БИСКВИТ
           "                AND D.T_MESSAGEID IS NOT NULL " +
           "                AND D.T_MESSAGEID > 0 " +
//           "                AND D.T_RESULTCODE = 0 " +
           "                AND NOT EXISTS( SELECT 1 FROM utableprocessevent_dbt I " +
           "                                WHERE I.T_OBJECTID = D.T_OBJECTID " +
           "                                 AND I.T_OBJECTTYPE = D.T_OBJECTTYPE " +
           "                                 AND I.T_TYPE = 3 " +
           "                                 AND I.T_RECID >  D.T_RECID ) ) " +

           "  UNION ALL " +

            // --из БИСКВИТ в СОФР платежи БИСКВИТ отсутствуют в СОФР
           "  SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB, " +
           "   T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 1 AS T_ERR_CODE, " +
           "   USR_PKG_IMPORT_SOFR.GetStrEventErr( 2, -1, TO_NUMBER( T_IDBISCOTTO ) ) AS T_ERR_TEXT, " +
//         'Из БИСКВИТ в СОФР. Отсутствует в СОФР' AS T_ERR_TEXT, " +
           "   0 AS T_OPER, '' AS T_MODULE " +
           "  FROM uloadentforcompare_dbt C " +
           "  WHERE EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
           "                WHERE V.T_BISCOTTOID = C.T_IDBISCOTTO " +
            "                AND V.T_DOCKIND IN(322, 320) ) " +
           "   AND  C.T_AUTOKEY NOT IN( ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dpmpaym_dbt B " +

           "   , ( " + SQLStrFromArray + " ) Z " +

           "                              WHERE A.T_REQID = :ReqId_1_3 " +
           "                               AND (Z.ID < 0 " +
           "                                OR ( Z.ACC_D = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_FUTUREPAYERACCOUNT ) > 0 " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_PAYERACCOUNT ) > 0 ) " +
           "                                AND ( Z.ACC_C = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_FUTURERECEIVERACCOUNT ) > 0 " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_RECEIVERACCOUNT ) > 0 ) " + 
           "                                 AND ( Z.PERSN = CHR(1) " +
           "                                  OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
           "                                                                                        WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
           "                                                                                        WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
           "                                                                                        ELSE Y.T_PERS_NUMBER_BISQUIT END ) AS T_PERS_NUMBER_BISQUIT " +
           "                                                                               FROM ( SELECT NVL(( SELECT U.T_NAME FROM dllvalues_dbt U " +
           "                                                                                                   WHERE U.T_LIST = 5005 " +
           "                                                                                                    AND U.T_ELEMENT = B.T_NUMBERPACK ), '9090909') AS CNTRPERSNUMBER, " +
           "                                                                                       NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
           "                                                                                              WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
           "                                                                                                               WHERE V.T_OBJECTTYPE = 92 " +
           "                                                                                                                AND V.T_NOTEKIND = 200 " +
           "                                                                                                                AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
           "                                                                                                                AND V.T_DATE <= B.T_VALUEDATE ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
           "                                                                                       ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
           "                                                                                                                                         WHERE W.T_CODE = B.T_DEPARTMENT ) END ) AS T_BRANCH " +
           "                                                                                      FROM DUAL ) Y ) ) > 0 ) " +
           "                                 ) " +
 
           "                               AND A.T_OPDATE BETWEEN :DateBegin_1_3 AND :DateEnd_1_3 " +
           "                               AND A.T_OPDATE = B.T_VALUEDATE " +
/*
           "                               AND ( B.T_FUTUREPAYERACCOUNT = A.T_ACCT_DB " +
           "                                OR B.T_PAYERACCOUNT = A.T_ACCT_DB " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_DB ) ) " +

           "                               AND ( B.T_FUTURERECEIVERACCOUNT = A.T_ACCT_CR " +
           "                                OR B.T_RECEIVERACCOUNT = A.T_ACCT_CR " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_CR ) ) " +
*/
           "                               AND B.T_VALUEDATE = A.T_OPDATE " +
           "                               AND B.T_PAYMENTID = A.T_ACCTRNID * -1 ) ) " +
           "   AND C.T_REQID = :ReqId_2_3 " +
           "   AND C.T_ACCTRNID < 0 " +
           "   AND C.T_ACCT_DB IS NOT NULL " +
           "   AND C.T_ACCT_CR IS NOT NULL " +

           "  UNION ALL " +

            // --из БИСКВИТ в СОФР платежи БИСКВИТ присутствуют в СОФР, не соответствуют реквизиты
           "  SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB, " +
           "   T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 2 AS T_ERR_CODE, 'Из БИСКВИТ в СОФР. Присутствует в СОФР, не соответствуют реквизиты: ' || " +
           "   USR_PKG_IMPORT_SOFR.GetDifferenceStrErr( 2, C.T_ACCT_DB, C.T_ACCT_CR, C.T_AMTCUR, C.T_AMTRUB, C.T_CURRENCY, C.T_DETAILS, C.T_DOCNUM, " +
           "    C.T_ACCTRNID, C.T_IDBISCOTTO, C.T_REQID ) AS T_ERR_TEXT, " +
           "    ( SELECT R.T_OPER FROM dpmpaym_dbt R WHERE R.T_PAYMENTID = C.T_ACCTRNID * -1 ) AS T_OPER, " +
           "    ( SELECT W.T_BOFFICE FROM rshb_fd_groups W " +
           "      WHERE W.T_GROUPID IN(( SELECT O.T_GROUPID FROM dacsgroupoper_dbt O " +
           "                             WHERE O.T_OPER = ( SELECT R.T_OPER FROM dpmpaym_dbt R " +
           "                                                WHERE R.T_PAYMENTID = C.T_ACCTRNID * -1 ))) " +
           "       AND ROWNUM = 1 ) AS T_MODULE " +

           "  FROM uloadentforcompare_dbt C " +
           "  WHERE EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
           "                WHERE V.T_BISCOTTOID = C.T_IDBISCOTTO " +
           "                 AND V.T_DOCKIND IN(322, 320)  ) " +
           "    AND     C.T_AUTOKEY IN( ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dpmpaym_dbt B " +
           "   , ( " + SQLStrFromArray + " ) Z " +
           "                              WHERE A.T_REQID = :ReqId_3_3 " + 
           "                               AND (Z.ID < 0 " +
           "                                OR ( Z.ACC_D = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_FUTUREPAYERACCOUNT ) > 0 " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_PAYERACCOUNT ) > 0 ) " +
           "                                AND ( Z.ACC_C = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_FUTURERECEIVERACCOUNT ) > 0 " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_RECEIVERACCOUNT ) > 0 ) " +
           "                                 AND ( Z.PERSN = CHR(1) " +
           "                                  OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
           "                                                                                        WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
           "                                                                                        WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
           "                                                                                        ELSE Y.T_PERS_NUMBER_BISQUIT END ) AS T_PERS_NUMBER_BISQUIT " +
           "                                                                               FROM ( SELECT NVL(( SELECT U.T_NAME FROM dllvalues_dbt U " +
           "                                                                                                   WHERE U.T_LIST = 5005 " +
           "                                                                                                    AND U.T_ELEMENT = B.T_NUMBERPACK ), '9090909') AS CNTRPERSNUMBER, " +
           "                                                                                       NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
           "                                                                                              WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
           "                                                                                                               WHERE V.T_OBJECTTYPE = 92 " +
           "                                                                                                                AND V.T_NOTEKIND = 200 " +
           "                                                                                                                AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
           "                                                                                                                AND V.T_DATE <= B.T_VALUEDATE ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
           "                                                                                       ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
           "                                                                                                                                         WHERE W.T_CODE = B.T_DEPARTMENT ) END ) AS T_BRANCH " +
           "                                                                                      FROM DUAL ) Y ) ) > 0 ) " +
           "                                 ) " +

           "                               AND A.T_OPDATE BETWEEN :DateBegin_2_3 AND :DateEnd_2_3 " +
           "                               AND A.T_OPDATE = B.T_VALUEDATE " +

           "                               AND ( B.T_FUTUREPAYERACCOUNT = A.T_ACCT_DB " +
           "                                OR B.T_PAYERACCOUNT = A.T_ACCT_DB " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_DB ) ) " +

           "                               AND ( B.T_FUTURERECEIVERACCOUNT = A.T_ACCT_CR " +
           "                                OR B.T_RECEIVERACCOUNT = A.T_ACCT_CR " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_CR ) ) " +

           "                               AND B.T_VALUEDATE = A.T_OPDATE " +
           "                               AND B.T_PAYMENTID = A.T_ACCTRNID * -1 ) ) " +
           "   AND C.T_ACCTRNID < 0 " +
           "   AND C.T_ACCT_DB IS NOT NULL " +
           "   AND C.T_ACCT_CR IS NOT NULL " +
           "   AND EXISTS( SELECT 1 FROM dpmpaym_dbt D " +
           "               WHERE D.T_PAYMENTID = C.T_ACCTRNID * -1 " +
           "                AND ( D.T_PAYERACCOUNT <> C.T_ACCT_DB " +
           "                AND D.T_FUTUREPAYERACCOUNT <> C.T_ACCT_DB " +
           "                       AND NOT EXISTS( SELECT 1 FROM dbrokacc_dbt E " +
           "                                       WHERE E.T_ACCOUNT =  C.T_ACCT_DB ) " +
           "                      OR D.T_RECEIVERACCOUNT <> C.T_ACCT_CR " +
           "                       AND D.T_FUTURERECEIVERACCOUNT <> C.T_ACCT_CR " +
           "                       AND NOT EXISTS( SELECT 1 FROM dbrokacc_dbt E " +
           "                                       WHERE E.T_ACCOUNT =  C.T_ACCT_CR ) " +
           "                      OR ( CASE WHEN D.T_FIID = 0 AND D.T_PAYFIID = 0 OR C.T_AMTCUR = 0 /*переоценка*/ THEN 0 ELSE D.T_AMOUNT END ) <> C.T_AMTCUR " +
//!!!           "                      OR D.T_SUM_NATCUR <> C.T_AMTRUB " +
/*поле валюта не сверяем
           "                      OR C.T_CURRENCY <> ( SELECT F.T_CODEINACCOUNT FROM dfininstr_dbt F " +
           "                                           WHERE F.T_FIID = D.T_FIID ) " +
*/
//!!!           "                      OR D.T_GROUND <> C.T_DETAILS " +
//           "                      OR 'paym' || TO_CHAR(D.T_PAYMENTID) <> C.T_DOCNUM " +
           "                    )) " +

           "  UNION ALL " +

            // --из БИСКВИТ в СОФР платежи БИСКВИТ присутствуют в СОФР, задвоенные в БИСКВИТ

           "  SELECT D.T_AUTOKEY, D.T_COUNTER, D.T_USERID, D.T_OPDATE, D.T_DOCDATE, D.T_ACCT_DB, D.T_ACCT_CR, D.T_CURRENCY, D.T_AMTCUR, D.T_AMTRUB, " +
           "   D.T_DETAILS, D.T_DOCNUM, D.T_ACCTRNID, D.T_IDBISCOTTO, D.T_REQID, 3 AS T_ERR_CODE, 'Из БИСКВИТ в СОФР. Присутствует в СОФР, задвоенные в БИСКВИТ' AS T_ERR_TEXT, " +
           "   0 AS T_OPER, '' AS T_MODULE " +
           "  FROM uloadentforcompare_dbt D, " +
           "  ( " +
           "  SELECT T_ACCTRNID, MAX( T_AUTOKEY ) AS T_AUTOKEY_DOUBLE, MIN( T_AUTOKEY ) AS T_AUTOKEY_PRIOR  FROM uloadentforcompare_dbt C " +
           "  WHERE C.T_AUTOKEY IN( ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dpmpaym_dbt B " +

           "   , ( " + SQLStrFromArray + " ) Z " +

           "                              WHERE A.T_REQID = :ReqId_4_4 " +
           "                               AND (Z.ID < 0 " +
           "                                OR ( Z.ACC_D = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_FUTUREPAYERACCOUNT ) > 0 " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_PAYERACCOUNT ) > 0 ) " +
           "                                AND ( Z.ACC_C = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_FUTURERECEIVERACCOUNT ) > 0 " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_RECEIVERACCOUNT ) > 0) " +
           "                                 AND ( Z.PERSN = CHR(1) " +
           "                                  OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
           "                                                                                        WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
           "                                                                                        WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
           "                                                                                        ELSE Y.T_PERS_NUMBER_BISQUIT END ) AS T_PERS_NUMBER_BISQUIT " +
           "                                                                               FROM ( SELECT NVL(( SELECT U.T_NAME FROM dllvalues_dbt U " +
           "                                                                                                   WHERE U.T_LIST = 5005 " +
           "                                                                                                    AND U.T_ELEMENT = B.T_NUMBERPACK ), '9090909') AS CNTRPERSNUMBER, " +
           "                                                                                       NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
           "                                                                                              WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
           "                                                                                                               WHERE V.T_OBJECTTYPE = 92 " +
           "                                                                                                                AND V.T_NOTEKIND = 200 " +
           "                                                                                                                AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
           "                                                                                                                AND V.T_DATE <= B.T_VALUEDATE ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
           "                                                                                       ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
           "                                                                                                                                         WHERE W.T_CODE = B.T_DEPARTMENT ) END ) AS T_BRANCH " +
           "                                                                                      FROM DUAL ) Y ) ) > 0 ) " +
           "                                   ) " +

           "                               AND A.T_OPDATE BETWEEN :DateBegin_3_4 AND :DateEnd_3_4 " +
           "                               AND A.T_OPDATE = B.T_VALUEDATE " +

           "                               AND ( B.T_FUTUREPAYERACCOUNT = A.T_ACCT_DB " +
           "                                OR B.T_PAYERACCOUNT = A.T_ACCT_DB " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_DB ) ) " +

           "                               AND ( B.T_FUTURERECEIVERACCOUNT = A.T_ACCT_CR " +
           "                                OR B.T_RECEIVERACCOUNT = A.T_ACCT_CR " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_CR ) ) " +

           "                               AND B.T_VALUEDATE = A.T_OPDATE " +
           "                               AND B.T_PAYMENTID = A.T_ACCTRNID * -1 ) ) " +
           "   AND C.T_ACCTRNID < 0 " +
           "   AND C.T_ACCT_DB IS NOT NULL " +
           "   AND C.T_ACCT_CR IS NOT NULL " +

           "  GROUP BY T_ACCTRNID " +
           "  HAVING COUNT(T_ACCTRNID) > 1 " +
           "  ) A " +
           "  WHERE EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
           "                WHERE V.T_BISCOTTOID = D.T_IDBISCOTTO " +
           "                 AND V.T_DOCKIND IN(322, 320)  ) " +
           "   AND D.T_AUTOKEY = A.T_AUTOKEY_DOUBLE " +


           "  UNION ALL " +

            // --из БИСКВИТ в СОФР платежи СОФР отсутствуют в БИСКВИТ
/*
           "  SELECT -1 AS T_AUTOKEY, CHR(0) AS T_COUNTER, CHR(0) AS T_USERID, C.T_VALUEDATE AS T_OPDATE, C.T_VALUEDATE AS T_DOCDATE, C.T_PAYERACCOUNT AS T_ACCT_DB, " +
           "   C.T_RECEIVERACCOUNT AS T_ACCT_CR, " +
           "   ( SELECT F.T_CODEINACCOUNT FROM dfininstr_dbt F " +
           "     WHERE F.T_FIID = C.T_FIID ) AS T_CURRENCY, " +
           "   C.T_AMOUNT AS T_AMTCUR, C.T_BASEAMOUNT AS T_AMTRUB, " +
           "   H.T_GROUND AS T_DETAILS, TO_CHAR( C.T_PAYMENTID ) AS T_DOCNUM, C.T_PAYMENTID, CHR(0) AS T_IDBISCOTTO, CHR(0) AS T_REQID, 4 AS T_ERR_CODE, " +
           "   USR_PKG_IMPORT_SOFR.GetStrEventErr( 3, -1, C.T_PAYMENTID ) AS T_ERR_TEXT, " +
//    'Из БИСКВИТ в СОФР. Присутствует в СОФР, Отсутствует в БИСКВИТ' AS T_ERR_TEXT, " +
           "   0 AS T_OPER, '' AS T_MODULE " +
           "  FROM dpmpaym_dbt C, dpmrmprop_dbt H " +

           "   , ( " + SQLStrFromArray + " ) X " +

           "  WHERE C.T_VALUEDATE BETWEEN :DateBegin_5_5 AND :DateEnd_5_5 " +
           "   AND EXISTS( SELECT 1 FROM upmbiscotto_dbt V " +
           "               WHERE V.T_PMID = C.T_PAYMENTID " +
           "               AND V.T_DOCKIND IN(322, 320) ) " +
           "   AND H.T_PAYMENTID = C.T_PAYMENTID " +
           "   AND (X.ID < 0 " +
           "    OR ( X.ACC_D = CHR(1) " +
           "     OR RSB_MASK.CompareStringWithMask( X.ACC_D, C.T_PAYERACCOUNT ) > 0 ) " +
           "    AND ( X.ACC_C = CHR(1) " +
           "     OR RSB_MASK.CompareStringWithMask( X.ACC_C, C.T_RECEIVERACCOUNT ) > 0) " +
           "    AND ( X.PERSN = CHR(1) " +
           "     OR RSB_MASK.CompareStringWithMask(X.PERSN, ( SELECT ( CASE WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
           "                                                           WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
           "                                                           WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
           "                                                           ELSE Y.T_PERS_NUMBER_BISQUIT END ) AS T_PERS_NUMBER_BISQUIT " +
           "                                                  FROM ( SELECT NVL(( SELECT U.T_NAME FROM dllvalues_dbt U " +
           "                                                                      WHERE U.T_LIST = 5005 " +
           "                                                                       AND U.T_ELEMENT = C.T_NUMBERPACK ), '9090909') AS CNTRPERSNUMBER, " +
           "                                                          NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
           "                                                                 WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
           "                                                                                  WHERE V.T_OBJECTTYPE = 92 " +
           "                                                                                   AND V.T_NOTEKIND = 200 " +
           "                                                                                   AND V.T_DOCUMENTID = LPAD( TO_CHAR( C.T_OPER ), 10, '0') " +
           "                                                                                   AND V.T_DATE <= C.T_VALUEDATE ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
           "                                                          ( CASE WHEN C.T_DEPARTMENT = 1 THEN '0000' ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
           "                                                                                                            WHERE W.T_CODE = C.T_DEPARTMENT ) END ) AS T_BRANCH " +
           "                                                         FROM DUAL ) Y ) ) > 0 ) " +


           "       ) " +

           "   AND C.T_PAYMENTID NOT IN( ( SELECT B.T_PAYMENTID FROM dpmpaym_dbt B, uloadentforcompare_dbt A " +

           "   , ( " + SQLStrFromArray + " ) Z " +

           "                              WHERE EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
           "                                            WHERE V.T_BISCOTTOID = A.T_IDBISCOTTO " +
           "                                             AND V.T_DOCKIND IN(322, 320)  ) " +
           "                               AND A.T_REQID = :ReqId_5_5 " +
           "                               AND (Z.ID < 0 " +
           "                                OR ( Z.ACC_D = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_FUTUREPAYERACCOUNT ) > 0 " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_PAYERACCOUNT ) > 0 ) " +
           "                                AND ( Z.ACC_C = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_FUTURERECEIVERACCOUNT ) > 0 " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_RECEIVERACCOUNT ) > 0) " +
           "                                 AND ( Z.PERSN = CHR(1) " +
           "                                  OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
           "                                                                                        WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
           "                                                                                        WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
           "                                                                                        ELSE Y.T_PERS_NUMBER_BISQUIT END ) AS T_PERS_NUMBER_BISQUIT " +
           "                                                                               FROM ( SELECT NVL(( SELECT U.T_NAME FROM dllvalues_dbt U " +
           "                                                                                                   WHERE U.T_LIST = 5005 " +
           "                                                                                                    AND U.T_ELEMENT = B.T_NUMBERPACK ), '9090909') AS CNTRPERSNUMBER, " +
           "                                                                                       NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
           "                                                                                              WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
           "                                                                                                               WHERE V.T_OBJECTTYPE = 92 " +
           "                                                                                                                AND V.T_NOTEKIND = 200 " +
           "                                                                                                                AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
           "                                                                                                                AND V.T_DATE <= B.T_VALUEDATE ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
           "                                                                                       ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
           "                                                                                                                                         WHERE W.T_CODE = B.T_DEPARTMENT ) END ) AS T_BRANCH " +
           "                                                                                      FROM DUAL ) Y ) ) > 0 ) " +
           "                                  ) " +

//           "                               AND A.T_ACCTRNID < 0 " +
           "                               AND A.T_OPDATE BETWEEN :DateBegin_4_5 AND :DateEnd_4_5 " +
           "                               AND B.T_VALUEDATE = A.T_OPDATE " +
           "                               AND A.T_ACCT_DB IS NOT NULL " +
           "                               AND A.T_ACCT_CR IS NOT NULL " +

           "                               AND ( A.T_ACCT_DB = B.T_FUTUREPAYERACCOUNT " +
           "                                OR A.T_ACCT_DB = B.T_PAYERACCOUNT " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_DB ) ) " +

           "                               AND ( A.T_ACCT_CR = B.T_FUTURERECEIVERACCOUNT " +
           "                                OR A.T_ACCT_CR = B.T_RECEIVERACCOUNT " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_CR ) ) " +

           "                               AND A.T_OPDATE = B.T_VALUEDATE " +
           "                               AND A.T_ACCTRNID = B.T_PAYMENTID  /** -1*/ ) ) " +

           "   AND C.T_PAYMENTID NOT IN( ( SELECT B.T_PAYMENTID FROM dpmpaym_dbt B, uloadentforcompare_dbt A " +

           "   , ( " + SQLStrFromArray + " ) Z " +

           "                              WHERE EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
           "                                            WHERE V.T_BISCOTTOID = A.T_IDBISCOTTO " +
           "                                             AND V.T_DOCKIND IN(322, 320)  ) " +
           "                               AND A.T_REQID = :ReqId_5_5_1 " +
           "                               AND (Z.ID < 0 " +
           "                                OR ( Z.ACC_D = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_FUTUREPAYERACCOUNT ) > 0 " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_PAYERACCOUNT ) > 0 ) " +
           "                                AND ( Z.ACC_C = CHR(1) " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_FUTURERECEIVERACCOUNT ) > 0 " +
           "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_RECEIVERACCOUNT ) > 0) " +
           "                                 AND ( Z.PERSN = CHR(1) " +
           "                                  OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
           "                                                                                        WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
           "                                                                                        WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
           "                                                                                        ELSE Y.T_PERS_NUMBER_BISQUIT END ) AS T_PERS_NUMBER_BISQUIT " +
           "                                                                               FROM ( SELECT NVL(( SELECT U.T_NAME FROM dllvalues_dbt U " +
           "                                                                                                   WHERE U.T_LIST = 5005 " +
           "                                                                                                    AND U.T_ELEMENT = B.T_NUMBERPACK ), '9090909') AS CNTRPERSNUMBER, " +
           "                                                                                       NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
           "                                                                                              WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
           "                                                                                                               WHERE V.T_OBJECTTYPE = 92 " +
           "                                                                                                                AND V.T_NOTEKIND = 200 " +
           "                                                                                                                AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
           "                                                                                                                AND V.T_DATE <= B.T_VALUEDATE ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
           "                                                                                       ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
           "                                                                                                                                         WHERE W.T_CODE = B.T_DEPARTMENT ) END ) AS T_BRANCH " +
           "                                                                                      FROM DUAL ) Y ) ) > 0 ) " +
           "                                 ) " +

//           "                               AND A.T_ACCTRNID < 0 " +
           "                               AND A.T_OPDATE BETWEEN :DateBegin_4_5_1 AND :DateEnd_4_5_1 " +
           "                               AND B.T_VALUEDATE = A.T_OPDATE " +
           "                               AND  ( A.T_ACCT_DB IS NULL AND A.T_ACCT_CR IS NOT NULL " +
           "                                OR A.T_ACCT_DB IS NOT NULL AND A.T_ACCT_CR IS NULL ) " +

           "                               AND  ( NVL( A.T_ACCT_DB, ( SELECT G.T_ACCT_DB FROM uloadentforcompare_dbt G " +
           "                                                          WHERE  G.T_IDBISCOTTO = A.T_IDBISCOTTO " +
           "                                                           AND G.T_REQID = A.T_REQID " +
           "                                                           AND  G.T_ACCT_CR IS NULL AND G.T_ACCT_DB IS NOT NULL )  ) = B.T_FUTUREPAYERACCOUNT " +
           "                                OR    NVL( A.T_ACCT_DB, ( SELECT G.T_ACCT_DB FROM uloadentforcompare_dbt G " +
           "                                                          WHERE  G.T_IDBISCOTTO = A.T_IDBISCOTTO " +
           "                                                           AND G.T_REQID = A.T_REQID " +
           "                                                           AND  G.T_ACCT_CR IS NULL AND G.T_ACCT_DB IS NOT NULL )  ) = B.T_PAYERACCOUNT ) " +

           "                               AND  ( NVL ( A.T_ACCT_CR, ( SELECT G.T_ACCT_CR FROM uloadentforcompare_dbt G " +
           "                                                         WHERE  G.T_IDBISCOTTO = A.T_IDBISCOTTO " +
           "                                                           AND G.T_REQID = A.T_REQID " +
           "                                                           AND  G.T_ACCT_DB IS NULL AND G.T_ACCT_CR IS NOT NULL )  ) = B.T_FUTURERECEIVERACCOUNT " +
           "                                OR    NVL ( A.T_ACCT_CR, ( SELECT G.T_ACCT_CR FROM uloadentforcompare_dbt G " +
           "                                                           WHERE  G.T_IDBISCOTTO = A.T_IDBISCOTTO " +
           "                                                            AND G.T_REQID = A.T_REQID " +
           "                                                            AND  G.T_ACCT_DB IS NULL AND G.T_ACCT_CR IS NOT NULL )  ) = B.T_RECEIVERACCOUNT ) " +

           "                               AND A.T_OPDATE = B.T_VALUEDATE " +
           "                               AND A.T_ACCTRNID = B.T_PAYMENTID  /** -1*/ ) ) " +

           "  UNION ALL " +
*/
            // --из БИСКВИТ в СОФР операции БИСКВИТ отсутствуют в СОФР
           "  SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB, " +
           "   T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 1 AS T_ERR_CODE, 'Из БИСКВИТ в СОФР. Отсутствует в СОФР' AS T_ERR_TEXT, " +
           "   0 AS T_OPER, '' AS T_MODULE " +
           "  FROM uloadentforcompare_dbt C " +
           "  WHERE EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
           "                WHERE V.T_BISCOTTOID = C.T_IDBISCOTTO " +
            "                AND V.T_DOCKIND NOT IN(322, 320) ) " +
           "   AND  C.T_AUTOKEY NOT IN( ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dnptxop_dbt B " +

           "   , ( " + SQLStrFromArray + " ) Z " +

           "                              WHERE A.T_REQID = :ReqId_1_6 " +
           "                               AND (Z.ID < 0 " +
           "                                OR ( Z.ACC_D = CHR(1) " +
           "                                      OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_ACCOUNT ) > 0 ) " +
           "                                     AND ( Z.PERSN = CHR(1) " +
           "                                  OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
           "                                                                                        WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
           "                                                                                        WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
           "                                                                                        ELSE Y.T_PERS_NUMBER_BISQUIT END ) AS T_PERS_NUMBER_BISQUIT " +
           "                                                                               FROM ( SELECT '9090909' AS CNTRPERSNUMBER, " +
           "                                                                                       NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
           "                                                                                              WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
           "                                                                                                               WHERE V.T_OBJECTTYPE = 92 " +
           "                                                                                                                AND V.T_NOTEKIND = 200 " +
           "                                                                                                                AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
           "                                                                                                                AND V.T_DATE <= B.T_OPERDATE ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
           "                                                                                       ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
           "                                                                                                                                         WHERE W.T_CODE = B.T_DEPARTMENT ) END ) AS T_BRANCH " +
           "                                                                                      FROM DUAL ) Y ) ) > 0 ) " +
           "                                 ) " +
 
           "                               AND A.T_OPDATE BETWEEN :DateBegin_1_6 AND :DateEnd_1_6 " +
           "                               AND A.T_OPDATE = B.T_OPERDATE " +
/*
           "                               AND ( B.T_ACCOUNT = A.T_ACCT_DB " +
           "                                OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
           "                                           WHERE D.T_ACCOUNT =  A.T_ACCT_DB ) ) " +
*/
           "                               AND B.T_OPERDATE = A.T_OPDATE " +
           "                               AND B.T_ID = A.T_ACCTRNID * -1 ) ) " +
           "   AND C.T_REQID = :ReqId_2_6 " +
           "   AND C.T_ACCTRNID < 0 " +
           "   AND C.T_ACCT_DB IS NOT NULL " +
           "   AND C.T_ACCT_CR IS NOT NULL ";



  Params = makeArray( SQLParam( "ReqId_1", ReqId ),
                      SQLParam( "DateBegin_1", ParamProcess.DateIn ),
                      SQLParam( "DateEnd_1", ParamProcess.DateOut ),
                      SQLParam( "ReqId_2", ReqId ),
                      SQLParam( "ReqId_1_1", ReqId ),
                      SQLParam( "DateBegin_1_1", ParamProcess.DateIn ),
                      SQLParam( "DateEnd_1_1", ParamProcess.DateOut ),
                      SQLParam( "ReqId_2_1", ReqId ),

                      SQLParam( "ReqId_3", ReqId ),
                      SQLParam( "DateBegin_2", ParamProcess.DateIn ),
                      SQLParam( "DateEnd_2", ParamProcess.DateOut ),
                      SQLParam( "ReqId_3_1", ReqId ),
                      SQLParam( "DateBegin_2_1", ParamProcess.DateIn ),
                      SQLParam( "DateEnd_2_1", ParamProcess.DateOut ),

                      SQLParam( "ReqId_4", ReqId ),
                      SQLParam( "DateBegin_3", ParamProcess.DateIn ),
                      SQLParam( "DateEnd_3", ParamProcess.DateOut ),
                      SQLParam( "ReqId_4_1", ReqId ),
                      SQLParam( "DateBegin_3_1", ParamProcess.DateIn ),
                      SQLParam( "DateEnd_3_1", ParamProcess.DateOut ),

                      SQLParam( "DateBegin_5_1", ParamProcess.DateIn ),
                      SQLParam( "DateEnd_5_1", ParamProcess.DateOut ),
                      SQLParam( "ReqId_5", ReqId ),
                      SQLParam( "DateBegin_4", ParamProcess.DateIn ),
                      SQLParam( "DateEnd_4", ParamProcess.DateOut ),
//                      SQLParam( "DateBegin_5_1", ParamProcess.DateIn ),
//                      SQLParam( "DateEnd_5_1", ParamProcess.DateOut ),
                      SQLParam( "ReqId_5_1", ReqId ),
                      SQLParam( "DateBegin_4_1", ParamProcess.DateIn ),
                      SQLParam( "DateEnd_4_1", ParamProcess.DateOut ),

                      SQLParam( "ReqId_1_2", ReqId ),
                      SQLParam( "DateBegin_1_2", ParamProcess.DateIn ),
                      SQLParam( "DateEnd_1_2", ParamProcess.DateOut ),
                      SQLParam( "ReqId_2_2", ReqId ),

                      SQLParam( "ReqId_3_2", ReqId ),
                      SQLParam( "DateBegin_2_2", ParamProcess.DateIn ),
                      SQLParam( "DateEnd_2_2", ParamProcess.DateOut ),

                      SQLParam( "ReqId_4_2", ReqId ),
                      SQLParam( "DateBegin_3_2", ParamProcess.DateIn ),
                      SQLParam( "DateEnd_3_2", ParamProcess.DateOut ),

                      SQLParam( "DateBegin_5_2", ParamProcess.DateIn ),
                      SQLParam( "DateEnd_5_2", ParamProcess.DateOut ),
                      SQLParam( "ReqId_5_2", ReqId ),
                      SQLParam( "DateBegin_4_2", ParamProcess.DateIn ),
                      SQLParam( "DateEnd_4_2", ParamProcess.DateOut ),
//                      SQLParam( "DateBegin_5_1", ParamProcess.DateIn ),
//                      SQLParam( "DateEnd_5_1", ParamProcess.DateOut ),
                      SQLParam( "ReqId_5_2_1", ReqId ),
                      SQLParam( "DateBegin_4_2_1", ParamProcess.DateIn ),
                      SQLParam( "DateEnd_4_2_1", ParamProcess.DateOut ),

                      SQLParam( "ReqId_1_3", ReqId ),
                      SQLParam( "DateBegin_1_3", ParamProcess.DateIn ),
                      SQLParam( "DateEnd_1_3", ParamProcess.DateOut ),
                      SQLParam( "ReqId_2_3", ReqId ),

                      SQLParam( "ReqId_3_3", ReqId ),
                      SQLParam( "DateBegin_2_3", ParamProcess.DateIn ),
                      SQLParam( "DateEnd_2_3", ParamProcess.DateOut ),

                      SQLParam( "ReqId_4_4", ReqId ),
                      SQLParam( "DateBegin_3_4", ParamProcess.DateIn ),
                      SQLParam( "DateEnd_3_4", ParamProcess.DateOut ),

//                      SQLParam( "DateBegin_5_5", ParamProcess.DateIn ),
//                      SQLParam( "DateEnd_5_5", ParamProcess.DateOut ),
//                      SQLParam( "ReqId_5_5", ReqId ),
//                      SQLParam( "DateBegin_4_5", ParamProcess.DateIn ),
//                      SQLParam( "DateEnd_4_5", ParamProcess.DateOut ),
//                      SQLParam( "DateBegin_5_1", ParamProcess.DateIn ),
//                      SQLParam( "DateEnd_5_1", ParamProcess.DateOut ),
//                      SQLParam( "ReqId_5_5_1", ReqId ),
//                      SQLParam( "DateBegin_4_5_1", ParamProcess.DateIn ),
//                      SQLParam( "DateEnd_4_5_1", ParamProcess.DateOut ),

                      SQLParam( "ReqId_1_6", ReqId ),
                      SQLParam( "DateBegin_1_6", ParamProcess.DateIn ),
                      SQLParam( "DateEnd_1_6", ParamProcess.DateOut ),
                      SQLParam( "ReqId_2_6", ReqId ) ); 
  DataSet = execSQLselect( Query, Params );


 end;

 return 0;


onError(err)

 return 1;
 
end;
//получим курсор


private macro TxtDataToExcel( DataSet :@RsdRecordset, HeaderTxt, BodyTxt, FooterTxt, ParamProcess :object, ReqId :string, Fl_SetDialog :integer, FlSummary :integer )
var Query :string = "",
    Params :TArray,
    VisibleRunReport = False,
    outl,
    outputl,
    PartFileNameOut = "",
    i = 0,
    StrBuf :string = "",
    FlFirstString :bool = false;

  if( ( ValType(Fl_SetDialog) == V_UNDEF ) or ( ValType(Fl_SetDialog) == 26 ) )
   Fl_SetDialog = 0;
  end;

  if (ExcelApplication == null)
   if(NewExcelWorkbook_(VisibleRunReport))
    ActiveSheet.Activate();
    LocalPathExcel = ExcelApplication.DefaultFilePath;
   else
    if( Fl_SetDialog == 1 )
     MsgBox("Ошибка при открытии книги Excel.");
     Exit(1);
    end;
    return false;
   end;
   ExcelLanguage = ExcelApplication.LanguageSettings.LanguageID(2);//русская или нет локализация Excel
   ExcelDecimalSeparator = ExcelApplication.DecimalSeparator;


 //текстовые файлы для экспорта данных отчета
   if( not Open( HeaderTxt, HEADER_FILENAME_TXT + CNum + ".txt" ) )
    ExcelApplication.Workbooks.Close();
    ExcelApplication.Quit;
    ExcelApplication = null;
    if( Fl_SetDialog == 1 )
     MsgBox( "Ошибка открытия файла импорта " + HEADER_FILENAME_TXT + CNum + ".txt" );
     Exit(1);
    end;
    return false;
   end;

   if( not Open( BodyTxt, BODY_FILENAME_TXT + CNum + ".txt" ) )
    ExcelApplication.Workbooks.Close();
    ExcelApplication.Quit;
    ExcelApplication = null;
    Close(HeaderTxt);
    if( Fl_SetDialog == 1 )
     MsgBox( "Ошибка открытия файла импорта " + BODY_FILENAME_TXT + CNum + ".txt" );
     Exit(1);
    end;
    return false;
   end;


   if( not Open( FooterTxt, FOOTER_FILENAME_TXT + CNum + ".txt" ) )
    ExcelApplication.Workbooks.Close();
    ExcelApplication.Quit;
    ExcelApplication = null;
    Close(HeaderTxt);
    Close(BodyTxt);
    if( Fl_SetDialog == 1 )
     MsgBox( "Ошибка открытия файла импорта " + FOOTER_FILENAME_TXT + CNum + ".txt" );
     Exit(1);
    end;
    return false;
   end;


   //header

   StrBuf = "Отчет о расхождениях в проводках выгруженных в БИСКВИТ из СОФР";
   Insert( HeaderTxt, StrBuf, StrLen(StrBuf) );
   Insert( HeaderTxt, "");
   Insert( HeaderTxt, "");

   StrBuf = "В ответ на запрос СОФР: " + ReqId;
   Insert( HeaderTxt, StrBuf, StrLen(StrBuf) );
   Insert( HeaderTxt, "");

   StrBuf = "Период: с " + StrSubst( string(date(ParamProcess.DateIn):10), " ", "0" ) + " по " + StrSubst( string(date(ParamProcess.DateOut):10), " ", "0" );
   Insert( HeaderTxt, StrBuf, StrLen(StrBuf) );
   Insert( HeaderTxt, "");

   if( (ValType(uTryToGetPropS( ParamProcess, "AccEntries" )) != V_UNDEF) and (ValType(ParamProcess.AccEntries) != V_UNDEF)  and (ValType(ParamProcess.AccEntries) != 26) and
       (ParamProcess.AccEntries.Size > 0) )
    i = 0;
    StrBuf =  "";
    while( i < ParamProcess.AccEntries.Size )
     StrBuf = StrBuf + "Табельный номер сотрудника: " + ParamProcess.AccEntries[i].PersN + " Счет: Д" + ParamProcess.AccEntries[i].PayerAccount + " К" +  ParamProcess.AccEntries[i].ReceiverAccount + ";\n";
     i = i + 1;
    end;
    CntAccountRow = i;
   else
    StrBuf = "Табельный номер сотрудника: Все; Счет: Все";
   end;
   Insert( HeaderTxt, StrBuf, StrLen(StrBuf) );
   Insert( HeaderTxt, "");
   Insert( HeaderTxt, "");
   Insert( HeaderTxt, "");



   StrBuf = "ID БИСКВИТ" + SymbSeparator +
            "ID СОФР" + SymbSeparator +
            "Номер документа" + SymbSeparator +
            "Счет дебет" + SymbSeparator +
            "Счет кредит" + SymbSeparator +
            "Валюта" + SymbSeparator +
            "Сумма в валюте счета" + SymbSeparator +
            "Сумма в нац. валюте" + SymbSeparator +
            "Дата проводки" + SymbSeparator +
            "Ошибка" + SymbSeparator +
            "Назначение" + SymbSeparator +
            "Операционист" + SymbSeparator +
            "Модуль";
   Insert( HeaderTxt, StrBuf, StrLen(StrBuf) );
   Insert( HeaderTxt, "");

   StrBuf = "1" + SymbSeparator +
            "2" + SymbSeparator +
            "3" + SymbSeparator +
            "4" + SymbSeparator +
            "5" + SymbSeparator +
            "6" + SymbSeparator +
            "7" + SymbSeparator +
            "8" + SymbSeparator +
            "9" + SymbSeparator +
            "10" + SymbSeparator +
            "11" + SymbSeparator +
            "12" + SymbSeparator +
            "13";
   Insert( HeaderTxt, StrBuf, StrLen(StrBuf) );
   Insert( HeaderTxt, "");
   //header

   //footer
   Insert( FooterTxt, "");

   StrBuf = "Всего записей " + SymbSeparator;
   Insert( FooterTxt, StrBuf, StrLen(StrBuf) );
   Insert( FooterTxt, "");
   Insert( FooterTxt, "");
   //footer
 //текстовые файлы для экспорта данных отчета

   CellNumDeltaY = 1; //смешение при вставке промежуточных строк-заголовков
   CellNumX = 1;
  end;


  if( FlOpenTxtFile )
   PartyCnt = PartyCnt + 1;
//T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB,
//T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, T_ERR_CODE,  T_ERR_TEXT

   RowCnt = RowCnt + 1;
   StrBuf = //GetFormatedField( RowCnt, "", SymbSeparator) +
            GetFormatedField( DataSet.value("T_IDBISCOTTO", Null, V_STRING), "", SymbSeparator) +
            GetFormatedField( DataSet.value("T_ACCTRNID", Null, V_INTEGER), "", SymbSeparator) +
            GetFormatedField( DataSet.value("T_DOCNUM", Null, V_STRING), "", SymbSeparator) +
            GetFormatedField( DataSet.value("T_ACCT_DB", Null, V_STRING), "", SymbSeparator) +
            GetFormatedField( DataSet.value("T_ACCT_CR", Null, V_STRING), "", SymbSeparator) +
            GetFormatedField( DataSet.value("T_CURRENCY", Null, V_STRING), "", SymbSeparator) +
            GetFormatedField( DataSet.value("T_AMTCUR", Null, V_MONEY), "", SymbSeparator) +
            GetFormatedField( DataSet.value("T_AMTRUB", Null, V_MONEY), "", SymbSeparator) +
            GetFormatedField( DataSet.value("T_OPDATE", Null, V_DATE), "", SymbSeparator) +
            GetFormatedField( DataSet.value("T_ERR_TEXT", Null, V_STRING), "", SymbSeparator) +
            GetFormatedField( DataSet.value("T_DETAILS", Null, V_STRING), "", SymbSeparator) +
            GetFormatedField( DataSet.value("T_OPER", Null, V_INTEGER), "", SymbSeparator) +
            GetFormatedField( DataSet.value("T_MODULE", Null, V_STRING), "", "");

   Insert( BodyTxt, StrBuf, StrLen(StrBuf) );
   Insert( BodyTxt, "");

  else

   StrBuf = "" + SymbSeparator +
            "" + SymbSeparator +
            "" + SymbSeparator +
            "" + SymbSeparator +
            "" + SymbSeparator +
            "" + SymbSeparator +
            "" + SymbSeparator +
            "" + SymbSeparator +
            "" + SymbSeparator +
            "" + SymbSeparator +
            "" + SymbSeparator +
            "" + SymbSeparator +
            "";

   Insert( BodyTxt, StrBuf, StrLen(StrBuf) );
   Insert( BodyTxt, "");

  end;


end;





//Отчет-сверка проводок выгруженных в Бисквит из СОФР !!!!!!!!!В параметрах будет вместо фильтра ReqId соответственно нужно будет поменять SQL-запрос и его параметры
macro EntCompareRep( ReqId :string, ParamProcess: object, Fl_SetDialog :integer ) :bool

var DataSet :RsdRecordset,
    i :integer = 0,
    outl = "",
    Fulloutputl = "",
    FileNameOut = "",
    StrBuf :string = "",
    ColumnType,
    state :integer = 0,
    ErrCode,
    Params :TArray,
    Dt,
    Mn,
    Year,
    Query :string,
    RefValue :string = "",
    v_email_processor;


file HeaderTxt() txt write;  //текстовый файл заголовка отчета
file BodyTxt() txt write;  //текстовый файл содержания отчета
file FooterTxt() txt write;  //текстовый файл подвала отчета


 if( ( ValType(Fl_SetDialog) == V_UNDEF ) or ( ValType(Fl_SetDialog) == 26 ) )
  Fl_SetDialog = 0;
 end;

 if( Fl_SetDialog == 1 )
  InitProgress(-1, "Обработка данных.", "Обработка данных.");
 end;

//распарсить параметры в объект для SQL-запроса и шапки

 CellNumY = 0; //смещение от шапки
 CellYSectionBodySeparate = Null;
 CellYSectionBodySeparate = TArray();
 LocalPathExcel = "";
 CellNumX = 0;
 CellNumDeltaY = 0;
 PartyCnt = 0;
 RowCnt = 0;
 ExcelLanguage = 0;
 ExcelDecimalSeparator = "";
 FlOpenTxtFile = false;


 CellYSectionBodySeparate[CellYSectionBodySeparate.size] = CellNumY + SizeOfHeader;

 state = GetDataSet( @DataSet, 0, ReqId, ParamProcess ); //получим курсор расхождений проводок

 if( Fl_SetDialog == 1 )
  RemProgress;                                                    
  InitProgress(-1, "Формирование отчета.", "Формирование отчета");
 end;

 while(DataSet.MoveNext())
  FlOpenTxtFile = true;
  TxtDataToExcel( @DataSet, HeaderTxt, BodyTxt, FooterTxt, ParamProcess, ReqId, Fl_SetDialog );
  if( Fl_SetDialog == 1 )
   UseProgress(i=i+1);
  end;
 end;


 if( not FlOpenTxtFile ) //если запросы к секциям body возвращали пустой курсор
  TxtDataToExcel( @DataSet, HeaderTxt, BodyTxt, FooterTxt, ParamProcess, ReqId, Fl_SetDialog );
  FlOpenTxtFile = true;
 end;

 CellNumDeltaY = CellNumDeltaY + 1;
 CellYSectionBodySeparate[CellYSectionBodySeparate.size] = CellNumY + SizeOfHeader - 1 + PartyCnt + CellNumDeltaY;

 if(ExcelApplication != null)
  Insert( HeaderTxt,"" );
  Insert( FooterTxt,"" );

  Close(HeaderTxt);
  Close(BodyTxt);
  Close(FooterTxt);

  // загружаем шапку
  if( not CopyFile(HEADER_FILENAME_TXT + CNum + ".txt", "$" + LocalPathExcel + "\\" + HEADER_FILENAME_TXT + CNum + ".txt") )
   ExcelApplication.Workbooks.Close();
   ExcelApplication.Quit;
   ExcelApplication = null;
   if( Fl_SetDialog == 1 )
    MsgBox( "Ошибка копирования файла импорта " + HEADER_FILENAME_TXT + CNum + ".txt" );
    Exit(1);
   end;
   return false;
  end;

  if( not CopyFile(BODY_FILENAME_TXT + CNum + ".txt", "$" + LocalPathExcel + "\\" + BODY_FILENAME_TXT + CNum + ".txt"))
   ExcelApplication.Workbooks.Close();
   ExcelApplication.Quit;
   ExcelApplication = null;
   if( Fl_SetDialog == 1 )
    MsgBox( "Ошибка копирования файла импорта " + BODY_FILENAME_TXT + CNum + ".txt" );
    Exit(1);
   end;
   return false;
  end;

  if( not CopyFile(FOOTER_FILENAME_TXT + CNum + ".txt", "$" + LocalPathExcel + "\\" + FOOTER_FILENAME_TXT + CNum + ".txt"))
   ExcelApplication.Workbooks.Close();
   ExcelApplication.Quit;
   ExcelApplication = null;
   if( Fl_SetDialog == 1 )
    MsgBox( "Ошибка копирования файла импорта " + FOOTER_FILENAME_TXT + CNum + ".txt" );
    Exit(1);
   end;
   return false;
  end;



  ActiveSheet.Rows( string(SizeOfHeader + 9) + ":1").Select;
  ExcelApplication.Selection.Delete; // Shift = xlUp; =-4162


  ColumnType = TArray; // Получим массив форматов
  ColumnType.CvtToSafeArray = true; // Для передачи в COM-объект tarray-я как Array - VBA!!!
  for( i, 0, Max_X-1, 1)
   ColumnType[ColumnType.Size] = 1;  //колонки типа General общий
  end;


  // загружаем шапку
  ActiveSheet.QueryTables.Add( /*Connection:= */"TEXT;" + LocalPathExcel + "\\" + "header_entcompare" + CNum + ".txt", 
                               /*Destination:=*/ ActiveSheet.Range("$A$1") );
  ActiveSheet.QueryTables(ActiveSheet.QueryTables.Count).Name = "header";
  ActiveSheet.QueryTables(ActiveSheet.QueryTables.Count).FieldNames = True;
  ActiveSheet.QueryTables(ActiveSheet.QueryTables.Count).RowNumbers = False;
  ActiveSheet.QueryTables(ActiveSheet.QueryTables.Count).FillAdjacentFormulas = False;
  ActiveSheet.QueryTables(ActiveSheet.QueryTables.Count).PreserveFormatting = True;
  ActiveSheet.QueryTables(ActiveSheet.QueryTables.Count).RefreshOnFileOpen = False;
  ActiveSheet.QueryTables(ActiveSheet.QueryTables.Count).RefreshStyle = xlInsertDeleteCells;
  ActiveSheet.QueryTables(ActiveSheet.QueryTables.Count).SavePassword = False;
  ActiveSheet.QueryTables(ActiveSheet.QueryTables.Count).SaveData = True;
  ActiveSheet.QueryTables(ActiveSheet.QueryTables.Count).AdjustColumnWidth = True;
  ActiveSheet.QueryTables(ActiveSheet.QueryTables.Count).RefreshPeriod = 0;
  ActiveSheet.QueryTables(ActiveSheet.QueryTables.Count).TextFilePromptOnRefresh = False;
  ActiveSheet.QueryTables(ActiveSheet.QueryTables.Count).TextFilePlatform = 866;
  ActiveSheet.QueryTables(ActiveSheet.QueryTables.Count).TextFileStartRow = 1;
  ActiveSheet.QueryTables(ActiveSheet.QueryTables.Count).TextFileParseType = xlDelimited;
  ActiveSheet.QueryTables(ActiveSheet.QueryTables.Count).TextFileTextQualifier = xlTextQualifierNone;
  ActiveSheet.QueryTables(ActiveSheet.QueryTables.Count).TextFileConsecutiveDelimiter = False;
  ActiveSheet.QueryTables(ActiveSheet.QueryTables.Count).TextFileTabDelimiter = False;
  ActiveSheet.QueryTables(ActiveSheet.QueryTables.Count).TextFileSemicolonDelimiter = False;
  ActiveSheet.QueryTables(ActiveSheet.QueryTables.Count).TextFileCommaDelimiter = False;
  ActiveSheet.QueryTables(ActiveSheet.QueryTables.Count).TextFileSpaceDelimiter = False;
  ActiveSheet.QueryTables(ActiveSheet.QueryTables.Count).TextFileOtherDelimiter = "|";

  ActiveSheet.QueryTables(ActiveSheet.QueryTables.Count).TextFileColumnDataTypes = ColumnType;
  ActiveSheet.QueryTables(ActiveSheet.QueryTables.Count).TextFileTrailingMinusNumbers = True;
  ActiveSheet.QueryTables(ActiveSheet.QueryTables.Count).Refresh;
  ActiveSheet.QueryTables(ActiveSheet.QueryTables.Count).BackgroundQuery = False;

//  ActiveWorkbook.Connections("Connection").Refresh;

  ActiveSheet.Range("A" + string(SizeOfHeader + CntAccountRow + 1)).Select;
  // загружаем шапку

  ColumnType = Null;
  ColumnType = TArray; // Получим массив форматов
  ColumnType.CvtToSafeArray = true; // Для передачи в COM-объект tarray-я как Array - VBA!!!
  for( i, 0, Max_X-1, 1)
   if( i == 1 ) //колонки типа General общий
    ColumnType[ColumnType.Size] = 1;
   else  //колонки типа текст
    ColumnType[ColumnType.Size] = 2; 
   end;
  end;


  // загружаем содержимое
  ActiveSheet.QueryTables.Add( /*Connection:= */"TEXT;" + LocalPathExcel + "\\" + "body_entcompare" + CNum + ".txt", 
                               /*Destination:= */ActiveSheet.Range("$A$" + string(SizeOfHeader + CntAccountRow + 1)) );
  ActiveSheet.QueryTables(1).Name = "body";
  ActiveSheet.QueryTables(1).FieldNames = True;
  ActiveSheet.QueryTables(1).RowNumbers = False;
  ActiveSheet.QueryTables(1).FillAdjacentFormulas = False;
  ActiveSheet.QueryTables(1).PreserveFormatting = True;
  ActiveSheet.QueryTables(1).RefreshOnFileOpen = False;
  ActiveSheet.QueryTables(1).RefreshStyle = xlInsertDeleteCells;
  ActiveSheet.QueryTables(1).SavePassword = False;
  ActiveSheet.QueryTables(1).SaveData = True;
  ActiveSheet.QueryTables(1).AdjustColumnWidth = True;
  ActiveSheet.QueryTables(1).RefreshPeriod = 0;
  ActiveSheet.QueryTables(1).TextFilePromptOnRefresh = False;
  ActiveSheet.QueryTables(1).TextFilePlatform = 866;
  ActiveSheet.QueryTables(1).TextFileStartRow = 1;
  ActiveSheet.QueryTables(1).TextFileParseType = xlDelimited;
  ActiveSheet.QueryTables(1).TextFileTextQualifier = xlTextQualifierNone;
  ActiveSheet.QueryTables(1).TextFileConsecutiveDelimiter = False;
  ActiveSheet.QueryTables(1).TextFileTabDelimiter = False;
  ActiveSheet.QueryTables(1).TextFileSemicolonDelimiter = False;
  ActiveSheet.QueryTables(1).TextFileCommaDelimiter = False;
  ActiveSheet.QueryTables(1).TextFileSpaceDelimiter = False;
  ActiveSheet.QueryTables(1).TextFileOtherDelimiter = "|";

  ActiveSheet.QueryTables(1).TextFileColumnDataTypes = ColumnType;
  ActiveSheet.QueryTables(1).TextFileTrailingMinusNumbers = True;
  ActiveSheet.QueryTables(1).Refresh;
  ActiveSheet.QueryTables(1).BackgroundQuery = False;
//  ActiveSheet.Range(ActiveSheet.Cells(1,5),ActiveSheet.Cells(1,5)).Select;
  // загружаем содержимое

  // загружаем подвал


  ActiveSheet.QueryTables.Add( /*Connection:= */"TEXT;" + LocalPathExcel + "\\" + "footer_entcompare" + CNum + ".txt", 
                               /*Destination:= */ActiveSheet.Range("$A$" + string( CellYSectionBodySeparate[CellYSectionBodySeparate.Size-1] + CntAccountRow )) );
  ActiveSheet.QueryTables(1).Name = "footer";
  ActiveSheet.QueryTables(1).FieldNames = True;
  ActiveSheet.QueryTables(1).RowNumbers = False;
  ActiveSheet.QueryTables(1).FillAdjacentFormulas = False;
  ActiveSheet.QueryTables(1).PreserveFormatting = True;
  ActiveSheet.QueryTables(1).RefreshOnFileOpen = False;
  ActiveSheet.QueryTables(1).RefreshStyle = xlInsertDeleteCells;
  ActiveSheet.QueryTables(1).SavePassword = False;
  ActiveSheet.QueryTables(1).SaveData = True;
  ActiveSheet.QueryTables(1).AdjustColumnWidth = True;
  ActiveSheet.QueryTables(1).RefreshPeriod = 0;
  ActiveSheet.QueryTables(1).TextFilePromptOnRefresh = False;
  ActiveSheet.QueryTables(1).TextFilePlatform = 866;
  ActiveSheet.QueryTables(1).TextFileStartRow = 1;
  ActiveSheet.QueryTables(1).TextFileParseType = xlDelimited;
  ActiveSheet.QueryTables(1).TextFileTextQualifier = xlTextQualifierNone;
  ActiveSheet.QueryTables(1).TextFileConsecutiveDelimiter = False;
  ActiveSheet.QueryTables(1).TextFileTabDelimiter = False;
  ActiveSheet.QueryTables(1).TextFileSemicolonDelimiter = False;
  ActiveSheet.QueryTables(1).TextFileCommaDelimiter = False;
  ActiveSheet.QueryTables(1).TextFileSpaceDelimiter = False;
  ActiveSheet.QueryTables(1).TextFileOtherDelimiter = "|";
  ActiveSheet.QueryTables(1).TextFileTrailingMinusNumbers = True;
  ActiveSheet.QueryTables(1).Refresh;
  ActiveSheet.QueryTables(1).BackgroundQuery = False;

  // загружаем подвал

  //форматирование
  //шапка
  ActiveSheet.Columns(1).ColumnWidth = 12;
  ActiveSheet.Columns(2).ColumnWidth = 12;
  ActiveSheet.Columns(3).ColumnWidth = 20;
  ActiveSheet.Columns(4).ColumnWidth = 25;
  ActiveSheet.Columns(5).ColumnWidth = 25;
  ActiveSheet.Columns(6).ColumnWidth = 9;
  ActiveSheet.Columns(7).ColumnWidth = 20;
  ActiveSheet.Columns(8).ColumnWidth = 20;
  ActiveSheet.Columns(9).ColumnWidth = 15;
  ActiveSheet.Columns(10).ColumnWidth = 50;
  ActiveSheet.Columns(11).ColumnWidth = 80;
  ActiveSheet.Columns(12).ColumnWidth = 14;
  ActiveSheet.Columns(13).ColumnWidth = 10;


//  ActiveSheet.Rows(2).RowHeight = 86;

  ActiveSheet.Range(ActiveSheet.Cells(1,CellNumX),ActiveSheet.Cells( CellNumY + SizeOfFooter + CellYSectionBodySeparate[CellYSectionBodySeparate.Size-1] - 1, Max_X-CellNumX + 1)).Select;

  ExcelApplication.Selection.VerticalAlignment = xlCenter;
  ExcelApplication.Selection.WrapText = True;
  ExcelApplication.Selection.Font.Name = "Times New Roman";
  ExcelApplication.Selection.Font.Size = 9;

  for( i, 1, (7 + CntAccountRow), 1)
   ActiveSheet.Range(ActiveSheet.Cells(CellNumY + i,CellNumX),ActiveSheet.Cells(CellNumY + i, Max_X - CellNumX + 1)).Select;
   if( i == 1 )
    ExcelApplication.Selection.Font.Size = 10;
    ExcelApplication.Selection.Font.Bold = True;
   end;

   ExcelApplication.Selection.MergeCells = True;

   if( (i == 3) or (i == 4) or (i >= 5) and ( i < (7 + CntAccountRow - 2) ) )
    ExcelApplication.Selection.HorizontalAlignment = xlLeft;
   else
    ExcelApplication.Selection.HorizontalAlignment = xlCenter;
   end;
/*
   if( i == 6 )
    ActiveSheet.Rows("""" + string(i) + ":" + string(i) + """").RowHeight = 31;
   end;
*/
  end;


  ActiveSheet.Range(ActiveSheet.Cells(CellNumY + SizeOfHeader + CntAccountRow - 1,CellNumX),ActiveSheet.Cells(CellNumY + SizeOfHeader + CntAccountRow,Max_X-CellNumX + 1)).Select;
  ExcelApplication.Selection.Borders(xlDiagonalDown).LineStyle = xlNone;
  ExcelApplication.Selection.Borders(xlDiagonalUp).LineStyle = xlNone;
  ExcelApplication.Selection.Borders(xlEdgeLeft).LineStyle = xlContinuous;
  ExcelApplication.Selection.Borders(xlEdgeLeft).ColorIndex = 0;
  ExcelApplication.Selection.Borders(xlEdgeLeft).TintAndShade = 0;
  ExcelApplication.Selection.Borders(xlEdgeLeft).Weight = xlThin;
  ExcelApplication.Selection.Borders(xlEdgeTop).LineStyle = xlContinuous;
  ExcelApplication.Selection.Borders(xlEdgeTop).ColorIndex = 0;
  ExcelApplication.Selection.Borders(xlEdgeTop).TintAndShade = 0;
  ExcelApplication.Selection.Borders(xlEdgeTop).Weight = xlThin;
  ExcelApplication.Selection.Borders(xlEdgeBottom).LineStyle = xlContinuous;
  ExcelApplication.Selection.Borders(xlEdgeBottom).ColorIndex = 0;
  ExcelApplication.Selection.Borders(xlEdgeBottom).TintAndShade = 0;
  ExcelApplication.Selection.Borders(xlEdgeBottom).Weight = xlThin;
  ExcelApplication.Selection.Borders(xlEdgeRight).LineStyle = xlContinuous;
  ExcelApplication.Selection.Borders(xlEdgeRight).ColorIndex = 0;
  ExcelApplication.Selection.Borders(xlEdgeRight).TintAndShade = 0;
  ExcelApplication.Selection.Borders(xlEdgeRight).Weight = xlThin;
  ExcelApplication.Selection.Borders(xlInsideVertical).LineStyle = xlContinuous;
  ExcelApplication.Selection.Borders(xlInsideVertical).ColorIndex = 0;
  ExcelApplication.Selection.Borders(xlInsideVertical).TintAndShade = 0;
  ExcelApplication.Selection.Borders(xlInsideVertical).Weight = xlThin;
  ExcelApplication.Selection.Borders(xlInsideHorizontal).LineStyle = xlContinuous;
  ExcelApplication.Selection.Borders(xlInsideHorizontal).ColorIndex = 0;
  ExcelApplication.Selection.Borders(xlInsideHorizontal).TintAndShade = 0;
  ExcelApplication.Selection.Borders(xlInsideHorizontal).Weight = xlThin;
  ExcelApplication.Selection.HorizontalAlignment = xlCenter;
  ExcelApplication.Selection.Interior.ThemeColor = xlThemeColorDark1;
  ExcelApplication.Selection.Interior.PatternColorIndex = xlAutomatic;
  ExcelApplication.Selection.Interior.TintAndShade = -0.249977111117893;
  ExcelApplication.Selection.Font.ColorIndex = xlAutomatic;
  ExcelApplication.Selection.Font.Bold = True;


//  ActiveSheet.Rows("""" + string(12) + ":" + string(12) + """").RowHeight = 31;
//  ActiveSheet.Rows("""" + string(13) + ":" + string(13) + """").RowHeight = 50;
  //шапка


  //таблица
  //форматирование строк
  ActiveSheet.Range(ActiveSheet.Cells(CellYSectionBodySeparate[0] + CntAccountRow + 1 , CellNumX ),ActiveSheet.Cells(CellYSectionBodySeparate[1] + CntAccountRow - 1, Max_X-CellNumX + 1 )).Select;
  ExcelApplication.Selection.Borders(xlDiagonalDown).LineStyle = xlNone;
  ExcelApplication.Selection.Borders(xlDiagonalUp).LineStyle = xlNone;
  ExcelApplication.Selection.Borders(xlEdgeLeft).LineStyle = xlContinuous;
  ExcelApplication.Selection.Borders(xlEdgeLeft).ColorIndex = 0;
  ExcelApplication.Selection.Borders(xlEdgeLeft).TintAndShade = 0;
  ExcelApplication.Selection.Borders(xlEdgeLeft).Weight = xlThin;
  ExcelApplication.Selection.Borders(xlEdgeTop).LineStyle = xlContinuous;
  ExcelApplication.Selection.Borders(xlEdgeTop).ColorIndex = 0;
  ExcelApplication.Selection.Borders(xlEdgeTop).TintAndShade = 0;
  ExcelApplication.Selection.Borders(xlEdgeTop).Weight = xlThin;
  ExcelApplication.Selection.Borders(xlEdgeBottom).LineStyle = xlContinuous;
  ExcelApplication.Selection.Borders(xlEdgeBottom).ColorIndex = 0;
  ExcelApplication.Selection.Borders(xlEdgeBottom).TintAndShade = 0;
  ExcelApplication.Selection.Borders(xlEdgeBottom).Weight = xlThin;
  ExcelApplication.Selection.Borders(xlEdgeRight).LineStyle = xlContinuous;
  ExcelApplication.Selection.Borders(xlEdgeRight).ColorIndex = 0;
  ExcelApplication.Selection.Borders(xlEdgeRight).TintAndShade = 0;
  ExcelApplication.Selection.Borders(xlEdgeRight).Weight = xlThin;
  ExcelApplication.Selection.Borders(xlInsideVertical).LineStyle = xlContinuous;
  ExcelApplication.Selection.Borders(xlInsideVertical).ColorIndex = 0;
  ExcelApplication.Selection.Borders(xlInsideVertical).TintAndShade = 0;
  ExcelApplication.Selection.Borders(xlInsideVertical).Weight = xlThin;
  ExcelApplication.Selection.Borders(xlInsideHorizontal).LineStyle = xlContinuous;
  ExcelApplication.Selection.Borders(xlInsideHorizontal).ColorIndex = 0;
  ExcelApplication.Selection.Borders(xlInsideHorizontal).TintAndShade = 0;
  ExcelApplication.Selection.Borders(xlInsideHorizontal).Weight = xlThin;

  if( PartyCnt > 0 )
   ActiveSheet.Range(ActiveSheet.Cells(CellYSectionBodySeparate[0] + CntAccountRow + 1, CellNumX + 6 ),ActiveSheet.Cells(CellYSectionBodySeparate[1] + CntAccountRow - 1, CellNumX + 7 )).Select;
   ExcelApplication.Selection.HorizontalAlignment = xlRight;
   ExcelApplication.Selection.NumberFormat = "#" + " " /*ExcelDecimalSeparator*/ + "##0" + ExcelDecimalSeparator + "00" /*"000"*/;
  end;
  //таблица



  //подвал
  ActiveSheet.Cells(CellYSectionBodySeparate[CellYSectionBodySeparate.Size-1] + CntAccountRow + 1, CellNumX + 1).value = string( PartyCnt );
  //подвал

  ActiveSheet.Range(ActiveSheet.Cells(1, 1),ActiveSheet.Cells(1, 1)).Select;
/*
  ActiveSheet.PageSetup.Orientation = xlLandscape;
  ExcelApplication.ActiveWindow.View = 2;
  ActiveSheet.PageSetup.PrintArea = "A1:Q"+(CellNumY + SizeOfHeader + CntAccountRow + SizeOfFooter + PartyCnt + CellNumDeltaY);
  ActiveSheet.VPageBreaks(1).Location = ActiveSheet.Range("P1");
  ActiveSheet.PageSetup.PrintArea = "A1:P"+(CellNumY + SizeOfHeader + CntAccountRow + SizeOfFooter - 1 + PartyCnt + CellNumDeltaY);
  ExcelApplication.ActiveWindow.View = 1;
*/

  //форматирование
//   ActiveSheet.PageSetup.RightFooter = "Страница &P";
  ExcelApplication.Visible = false;
  ExcelApplication.DisplayAlerts = false;
  ExcelApplication.ActiveWorkBook.SaveAs(LocalPathExcel + "\\" + EXPORT_XML_FILENAME_TXT + CNum + ".xlsx");
//   ExcelApplication.Visible = true;
//   ExcelApplication.DisplayAlerts = true;
  ExcelApplication.Workbooks.Close();
  ExcelApplication.Quit;
  ExcelApplication = null;

  if(not RemoveFile("$" + LocalPathExcel + "\\" + HEADER_FILENAME_TXT + CNum + ".txt"))
   if( Fl_SetDialog == 1 )
    MsgBox("Не могу удалить временный файл " + string(LocalPathExcel + "\\" + HEADER_FILENAME_TXT + CNum + ".txt") + ".");
   end;
  end;
  if(not RemoveFile(HEADER_FILENAME_TXT + CNum + ".txt"))
   if( Fl_SetDialog == 1 )
    MsgBox("Не могу удалить временный файл " + string(HEADER_FILENAME_TXT + CNum + ".txt") + ".");
   end;
  end;

  if(not RemoveFile("$" + LocalPathExcel + "\\" + BODY_FILENAME_TXT + CNum + ".txt"))
   if( Fl_SetDialog == 1 )
    MsgBox("Не могу удалить временный файл " + string(LocalPathExcel + "\\" + BODY_FILENAME_TXT + CNum + ".txt") + ".");
   end;
  end;
  if(not RemoveFile(BODY_FILENAME_TXT + CNum + ".txt"))
   if( Fl_SetDialog == 1 )
    MsgBox("Не могу удалить временный файл " + string(BODY_FILENAME_TXT + CNum + ".txt") + ".");
   end;
  end;

  if(not RemoveFile("$" + LocalPathExcel + "\\" + FOOTER_FILENAME_TXT + CNum + ".txt"))
   if( Fl_SetDialog == 1 )
    MsgBox("Не могу удалить временный файл " + string(LocalPathExcel + "\\" + FOOTER_FILENAME_TXT + CNum + ".txt") + ".");
   end;
  end;
  if(not RemoveFile(FOOTER_FILENAME_TXT + CNum + ".txt"))
   if( Fl_SetDialog == 1 )
    MsgBox("Не могу удалить временный файл " + string(FOOTER_FILENAME_TXT + CNum + ".txt") + ".");
   end;
  end;

 else
  if( Fl_SetDialog == 1 )
   MsgBox("Не найдены данные за указанный период.");
  end;

   //отправляем в почту
   v_email_processor = Null;
   v_email_processor = c_email_proc_env();
   v_email_processor.m_set_msg_head("СОФР - Отчет результат сверки проводок загруженных в БИСКВИТ из СОФР.");
   v_email_processor.m_add_row_to_msg_text("Результат сверки проводок загруженных в БИСКВИТ из СОФР в файле расхождения отсутствуют. " );
   v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_ETCOMPARE, true);
   v_email_processor.m_submit_email_synch();
   v_email_processor = Null;
   //отправляем в почту

  return true;
 end;

 if( Fl_SetDialog == 1 )
  RemProgress;
 end;


 //флаг выгрузки взведен
 if( FlOpenTxtFile )

   GetRegistryValue("РСХБ\\ИНТЕГРАЦИЯ\\ДИРЕКТОРИИ\\EXPORT\\ENTRYCOMPAREDIR", V_STRING, XLSExport_Path);

   DateSplit ( ParamProcess.DateOut, Dt, Mn, Year );
   RefValue = StrSubst( string(Dt:2), " ", "0" ) + StrSubst( string(Mn:2), " ", "0" ) +
    SubStr(StrSubst( string(Year), " ", "0" ), 3) ;
                                                                                         
   //копирование в ресурс из реестра
   RemoveFile(XLSExport_Path + "\\" + RefValue + ".xlsx");

   if( not CopyFile( "$" + LocalPathExcel + "\\" + EXPORT_XML_FILENAME_TXT + CNum + ".xlsx",
    XLSExport_Path + "\\" + RefValue + ".xlsx" ) )
    if( Fl_SetDialog == 1 )
     MsgBox( "Ошибка копирования файла  " + EXPORT_XML_FILENAME_TXT + CNum + ".xlsx" );
    end;
    return false;
   end;

   //отправляем в почту
   v_email_processor = Null;
   v_email_processor = c_email_proc_env();
   v_email_processor.m_set_msg_head("СОФР - Отчет результат сверки проводок загруженных в БИСКВИТ из СОФР.");
   v_email_processor.m_add_row_to_msg_text("Результат сверки проводок загруженных в БИСКВИТ из СОФР в файле " + 
    XLSExport_Path + "\\" + RefValue + ".xlsx" + ". Приложен.");
   v_email_processor.m_add_attach_to_list( XLSExport_Path + "\\" + RefValue + ".xlsx" );
   v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_ETCOMPARE, true);
   v_email_processor.m_submit_email_synch();
   v_email_processor = Null;
   //отправляем в почту
 end;
 // флаг выгрузки взведен

 // открываем пользователю локальную книгу
 if( ( Fl_SetDialog == 1 ) and (ExcelApplication == null) )

  while( 1==1 )

   if(not RenameFile("$" + LocalPathExcel + "\\" + EXPORT_XML_FILENAME_TXT + CNum + ".xlsx",
    "$" + LocalPathExcel + "\\" + "bebecuporos" + CNum + ".xlsx" ))
    if( Fl_SetDialog == 1 )
     if( MsgBoxEx( "Не могу скопировать временный файл. Файл " + "bebecuporos" + CNum + ".xlsx" + " существует. Удалить?", MB_YES+MB_NO, IND_NO, "Предупреждение", "") == IND_NO )
      return false;
     else
      if(not RemoveFile("$" + LocalPathExcel + "\\" + "bebecuporos" + CNum + ".xlsx" ))
       if( MsgBoxEx( "Не могу удалить файл " + "bebecuporos" + CNum + ".xlsx" + " занят другим приложением. Повторить?", MB_YES+MB_NO, IND_NO, "Предупреждение", "") == IND_NO )
        return false;
       end;
      end;
     end;
    else
     return false;
    end;
   else
    Break;
   end;

  end;


  if( ( Fl_SetDialog == 1 ) and ( NewExcelWorkbook_(/*VisibleRunReport*/ false, LocalPathExcel + "\\" + "bebecuporos" + CNum + ".xlsx" ) ) )
   ActiveSheet.Activate();
   ExcelApplication.Visible = true;
   ExcelApplication.DisplayAlerts = true;
   ExcelApplication = null;

  else
   if( Fl_SetDialog == 1 )
    MsgBox("Ошибка при открытии книги Excel.");
    Exit(1);
   end;
   return false;
  end;
 end;
 // открываем пользователю локальную книгу

/*
 if( Fl_SetDialog == 1 )
  MsgBox( "Выгрузка образа в ЭА завершена.");
 end;
*/

onError(err)

 return false;

end;
//Отчет-сверка проводок выгруженных в Бисквит из СОФР



