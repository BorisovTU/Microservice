//-----------------------------------------------------------------------------------------
// Получение ответа СОФР результата обработки данных по счетам бухгалтерского учета
// В.Горленко
//-----------------------------------------------------------------------------------------
import global_utils_intgr, email_notifyfun, likepy;

Private const EMAIL_SUBJECT = "Ошибка. Загрузка данных по счетам бухгалтерского учета";
Private var EMAIL_RECEIVER = "";
//-----------------------------------------------------------------------------------------

Private macro getProperty ( obj, property )
    if ( genPropId (obj, property) < 0 )
        return NULL;
    end;

    return uTryToGetPropS (obj, property);
onError
    return NULL;
End;
//-----------------------------------------------------------------------------------------

Private macro sendMail ( email, subject, body );
    AddNotifyToDbt(subject, body, email);
    SendNotyfyToEmail ();

    return TRUE;
OnError
    return FALSE;
End;
//-----------------------------------------------------------------------------------------

Macro openAccount_resp ( response )
    Var result = getProperty (response, "OpenAccountResult"), responseCode, responseNote, mailBody = "";
    if ( result == NULL )
        return false;
    elif ( (responseCode = getProperty (result, "responseCode")) == NULL )
        return false;
    end;

    if ( string (responseCode) == "0" ) // Успешные ситуации никак не обрабатываем
        return TRUE; 
    end;

    responseNote = getProperty (result, "responseNote");

    mailBody = "OpenAccount:\n" + "Код ошибки: "+responseCode+ifThenElse (responseNote, " ("+responseNote+")", "");

    for ( Var prop, makeArray ("accountId", "filialId", "contractCode", "balanceAccount", "currencyCode", "accountName", "accountNumber") )
        if ( getProperty (result, prop) )
            mailBody = mailBody + "\n\t"+prop+": "+getProperty (result, prop);
        end;
    end;

    if ( not (EMAIL_RECEIVER) )
        return false;
    end;

    return sendMail (EMAIL_RECEIVER, EMAIL_SUBJECT, mailBody);
End;
//-----------------------------------------------------------------------------------------