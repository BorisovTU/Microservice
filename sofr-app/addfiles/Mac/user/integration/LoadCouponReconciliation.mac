/*-------------------------------------------*/
/* Сервис Сверка данных по купонным графикам */
/* Реконсиляция                              */
/* Автор: Синицын А.                         */
/*					     */
/*-------------------------------------------*/
import "global_utils_intgr.mac"; 
import "com_fin_instr_rates.mac";
import "secur_prc_msg_transform.mac"; /* Функционал преобразования сообщений */
import "u_common_email_utils.mac";

private const CV_Coupon_DEFAULT_CODE = 0;
private const CV_Coupon_ERROR_CODE = -1;
private const CV_EMAIL_HEAD = "Ошибка. Реконсиляция данных по купонным графикам";
private const CV_EMAIL_ROW_HEAD = "LoadCouponReconciliation: ";
private const CV_EMAIL_RECEIVER = "";

/*-------------------*/
/* Описание объектов */
/*-------------------*/

/* Данные запроса сервиса данных по купонным графикам */
private class c_LoadCouponReconciliation_req
   var ReqID          : string  /* (  1) ИД запроса */
      ,SenderId       : string  /* (0-1) Код АС-источника сведений */
/*      ,ArhPeriodDepth : integer /* Глубина архивных дат из графика НКД, начиная от текущей sysdate*/*/
      ,RepDate : date /* Дата реконсиляции, определяет наличие бумаги в портфеле sysdate*/

end;

private class c_Result_Coupon
   var Code : integer /* (  1) Код */
      ,Text : string; /* (0-1) Описание */
end;

private class c_CouponParm_resp
   var ISIN         : string; // Код бумажки
   var TYPE_INCOME  : string; // Тип записи о купоне
   var DRAWING_DATE : Date;   // Дата выплаты
   var BOND_NAME    : string; // 
   var INCOME_RATE  : double; // Ставка в %%
   var INCOME_VOLUME: double; // Величина купона в денежных единицах
/*      ,Result    : object; /* (1) c_Result_Coupon */ */
end;

/* Данные ответа сервиса сверки данных по купонам */
private class c_LoadCouponReconciliation_resp
   var ReqID    : string  /* (  1) ИД исходного запроса */
      ,SenderId : string  /* (0-1) Код АС-получателя ответа */
      ,Result   : object  /* (  1) Результат обработки запроса c_Result_Coupon */
      ,CouponList : object; /* (0-n) Результат загрузки купонных графиков TArray c_CouponParm_resp */
end;

/* Ответ сервиса */
private class c_out_obj
   var LoadCouponReconciliation_resp = c_LoadCouponReconciliation_resp;
end;

/*---------------------------------------------------*/
/* Класс с реализацией основного функционала сервиса */
/*---------------------------------------------------*/
private class (c_LoadCouponReconciliation_req) c_LoadCouponReconciliation_req_proc(p_income_data)
   /* Признак наличия ошибок */
   private var vg_is_error;
   /* Статусы для структуры верхнего уровня */
   private var vg_hl_error;
   /* Список зарегистрированных статусов для структур нижнего уровня */
   private var vg_ll_error_list;

   /* Метод получения признака наличия ошибок */
   macro m_get_error_status()
      return vg_is_error;
   end;

   /* Метод получения статуса для структуры верхнего уровня */
   macro m_get_hl_error()
      return vg_hl_error;
   end;

   /* Метод получения кода статуса для структур нижнего уровня */
   macro m_get_ll_error_code(p_index)
      return vg_ll_error_list.value(p_index).Code;
   end;

   /* Метод получения текста статуса для структур нижнего уровня */
   macro m_get_ll_error_text(p_index)
      return vg_ll_error_list.value(p_index).Text;
   end;

   private macro m_add_text_to_err(p_src_text, p_add_text)
      private var v_ret = "";

      if(strlen(p_src_text) != 0)
         v_ret = string(p_src_text, "|", p_add_text);
      else
         v_ret = p_add_text;
      end;

      return v_ret;
   end; /* macro m_add_text_to_err() */

   /* Конструктор */
   private macro m_init_prime(p_income_data)
      private var v_aux_buff;
      private var v_aux_cntr;

      vg_is_error = false;
      vg_hl_error = c_Result_Coupon;
      vg_hl_error.Code = 0; /* Значение по умолчанию - ошибок нет */
      vg_hl_error.Text = "OK";
      vg_ll_error_list = TArray;

      if(p_income_data != V_UNDEF)
         ReqID = uTryToGetPropS(p_income_data, "ReqID");
         if(ValType(ReqID) == V_UNDEF)
            vg_is_error = true;
            vg_hl_error.Code = CV_Coupon_ERROR_CODE;
            vg_hl_error.Text = m_add_text_to_err(vg_hl_error.Text, string(InErrComPart, "ReqID"));
            ReqID = XmlRpcRequestId();
         end;

         SenderId = uTryToGetPropS(p_income_data, "SenderId");
         if(ValType(SenderId) == V_UNDEF)
            vg_is_error = true;
            vg_hl_error.Code = CV_Coupon_ERROR_CODE;
            vg_hl_error.Text = m_add_text_to_err(vg_hl_error.Text, string(InErrComPart, "SenderId"));
//            SenderId = XmlRpcRequestId();
         end;

         RepDate = uTryToGetPropS(p_income_data, "RepDate");
         if(ValType(RepDate) == V_UNDEF)
            vg_is_error = true;
            vg_hl_error.Code = CV_Coupon_ERROR_CODE;
            vg_hl_error.Text = m_add_text_to_err(vg_hl_error.Text, string(InErrComPart, "RepDate"));
         end;
      end;
   onError(err)
      /* Записываем в ошибку структуры верхнего уровня структуры */
      vg_is_error = true;
      vg_hl_error.Code = CV_Coupon_ERROR_CODE;
      vg_hl_error.Text = m_add_text_to_err(vg_hl_error.Text,
                                           string("При обработке входных параметров возникла ошибка: ",
                                                  c_usr_err_obj.obtain_err_msg(err)));
   end;

   Initc_LoadCouponReconciliation_req();

   m_init_prime(p_income_data);
end; /* class c_LoadCouponReconciliation_req_proc() */

/*---------------------*/
/* ТОЧКА ВХОДА СЕРВИСА */
/*---------------------*/
macro LoadCouponReconciliation(p_income_data)
   private var v_aux_cntr, v_cmd, v_rs, v_SQL;
   private var v_income_data = NULL;
   var v_email_processor = NULL;
   var v_transformator = NULL;
   var v_service_processor = NULL;
   var v_save_processor = NULL;
   var v_resp_obj = NULL;
   var v_resp_doc;

   private var v_logger_obj;    /* Объект для работы с журналом */
   private var v_log_id;        /* Идентификатор записи в журнале (если требуется что-то добавить) */

   v_resp_obj = c_out_obj;

   /*
   /* Инициализация письма */
   v_email_processor = c_email_proc_env;
   v_email_processor.m_set_msg_head(CV_EMAIL_HEAD);
   /* !!! - Необходимо где-то брать список адресов для отправки уведомлений - !!! */
   v_email_processor.m_add_email_to_list(CV_EMAIL_RECEIVER);
   */

   if(ValType(p_income_data) != V_UNDEF)
      /* Преобразуем запрос в объектный вид - begin */
      v_transformator = c_secur_msg_converter();
      if(not v_transformator.m_decode_escaped_char(p_income_data))
         RunError(v_transformator.get_service_msg(), c_usr_err_obj(v_transformator.get_service_msg()));
      end;
      if(not v_transformator.m_make_pure_msg_from_ifx(v_transformator.get_pure_msg()))
         RunError(v_transformator.get_service_msg(), c_usr_err_obj(v_transformator.get_service_msg()));
      end;

      v_logger_obj = uws_exchng_logger(null, null, XmlRpcRequestId(), "LoadCouponReconciliation", modulename(), NULL, v_transformator.get_pure_msg());
      v_log_id = v_logger_obj.get_log_id();

      v_income_data = v_transformator.m_secur_internal_req(v_transformator.get_pure_msg());
      /* Преобразуем запрос в объектный вид - end */

      v_service_processor = c_LoadCouponReconciliation_req_proc(v_income_data);

      /* Общие параметры структуры верхнего уровня */
      v_resp_obj.LoadCouponReconciliation_resp.ReqID    = v_service_processor.ReqID;
      v_resp_obj.LoadCouponReconciliation_resp.SenderId = v_service_processor.SenderId;
      v_resp_obj.LoadCouponReconciliation_resp.Result   = v_service_processor.m_get_hl_error();

      if(not v_service_processor.m_get_error_status())
         /* Формируем данные графиков */
	v_resp_obj.LoadCouponReconciliation_resp.CouponList = TArray;

   	v_cmd = NULL;
   	v_rs  = NULL;
/*
   	v_SQL = "with dat as ( " +
            " SELECT /*+ INDEX (w DFIWARNTS_DBT_IDX2) INDEX  (F DAVOIRISS_DBT_IDX0)*/ " +
            "       F.T_ISIN ISIN," +
            "       'INTEREST' TYPE_INCOME," +
            "       w.t_drawingdate DRAWING_DATE," +
            "       (select i.t_name from dfininstr_dbt i where i.t_fiid = w.t_fiid) BOND_NAME, " +
            "       trim(to_char(w.t_incomerate,'99999999999999999990.'||DECODE(w.t_incomepoint,0,'00',lpad('0',w.t_incomepoint,'9'))))  INCOME_RATE," +
            "       trim(to_char(w.t_incomevolume,'99999999999999999990.'||DECODE(w.t_incomepoint,0,'00',lpad('0',w.t_incomepoint,'9')))) INCOME_VOLUME" +
            "     FROM dfiwarnts_dbt w" +
            "          inner join davoiriss_dbt F on F.t_fiid = w.t_fiid" +
            "    WHERE w.t_drawingdate >= trunc(sysdate)-:p1 " +
            "      and w.t_ispartial <> CHR(88) " +
            " UNION ALL " +
            " SELECT /*+ INDEX  (w DFIWARNTS_DBT_IDX2) INDEX (F DAVOIRISS_DBT_IDX0) */ " +
            "       F.T_ISIN ISIN," +
            "       'PRINCIPAL' TYPE_INCOME," +
            "       w.t_drawingdate DRAWING_DATE," +
            "       i.t_name BOND_NAME, " +
	    "       '0.00' INCOME_RATE," +
            "       (select trim(to_char(sum(w1.t_incomevolume), '99999999999999999990.'||DECODE(w.t_incomepoint,0,'00',lpad('0',w.t_incomepoint,'9')))) " +
	    "                         from dfiwarnts_dbt w1 " +
	    "                         where w1.t_fiid = w.t_fiid " +
            "                           and w1.t_ispartial != CHR(88) " +
	    "                  ) INCOME_VOLUME" +
	    "     FROM dfiwarnts_dbt w" +
	    "          inner join davoiriss_dbt F on F.t_fiid = w.t_fiid " +
	    "          inner join dfininstr_dbt i on i.t_fiid = w.t_fiid " +
	    "    WHERE w.t_drawingdate >= trunc(sysdate)-:p2 " +
	    "      and w.t_ispartial <> CHR(88) " +
	    "      and i.t_drawingdate = w.t_drawingdate ) " +
	    " select * from dat d " +
	    "    order by d.ISIN, d.TYPE_INCOME, d.DRAWING_DATE ";

      JOIN dpmwrtsum_dbt wrt ON (wrt.t_fiid = fi.t_fiid and wrt.t_portfolio in (1, 2, 5)) 
      JOIN davrkinds_dbt av_k ON (fi.t_avoirkind = av_k.t_avoirkind AND av_k.t_fi_kind = fi.t_fi_kind AND av_k.t_root = 17)
      JOIN davoiriss_dbt avr ON (avr.t_fiid = fi.t_fiid)
      JOIN dllvalues_dbt ll ON (ll.t_list = 1100 AND ll.t_element = wrt.t_portfolio) 
WHERE   wrt.T_DATE <= TO_DATE ('31-01-2020','dd-mm-yyyy')

*/
/*
   v_SQL = "with fi_dat as ( select * FROM ( " +
                     " SELECT /*+INDEX (avr DAVOIRISS_DBT_IDX0) PARALLEL_AUTO*/ fi.t_fiid,  " +
                         "   cnt(wrt.t_amount) as t_count " +
                           "  FROM dfininstr_dbt fi " +
                              "    JOIN dpmwrtsum_dbt wrt ON (wrt.t_fiid = fi.t_fiid and wrt.t_portfolio in (1, 2, 5))  " +
                                "  JOIN davrkinds_dbt av_k ON (fi.t_avoirkind = av_k.t_avoirkind AND av_k.t_fi_kind = fi.t_fi_kind AND av_k.t_root = 17) " +
                                "  JOIN davoiriss_dbt avr ON (avr.t_fiid = fi.t_fiid) " +
                                "  JOIN dllvalues_dbt ll ON (ll.t_list = 1100 AND ll.t_element = wrt.t_portfolio)  " +
                         "   WHERE  wrt.T_DATE <= :p1 " +
                                   "  AND fi.t_fi_kind = 2 " +
                          "  GROUP BY fi.t_fiid) " +
                          " where t_count > 0), " +
*/

   v_SQL = "with fi_dat as ( SELECT /*+INDEX (avr DAVOIRISS_DBT_IDX0) */  " +
                        "  fi.t_fiid " +
                        "   FROM dfininstr_dbt fi " +
                             "  JOIN davrkinds_dbt av_k ON (fi.t_avoirkind = av_k.t_avoirkind AND av_k.t_fi_kind = fi.t_fi_kind AND av_k.t_root = 17) " +
                             "  JOIN davoiriss_dbt avr ON (avr.t_fiid = fi.t_fiid) " +
                    "  WHERE fi.t_drawingdate >= :p1 - 90), " +
      "   cop as (SELECT /*+INDEX (w DFIWARNTS_DBT_IDX2) INDEX (F DAVOIRISS_DBT_IDX0)*/  " +
                 "   w.t_fiid, " +
                 "  F.T_ISIN ISIN,  " +
                 "   'INTEREST' TYPE_INCOME,  " +
                 "   w.t_drawingdate DRAWING_DATE,  " +
                 "   (select i.t_name from dfininstr_dbt i where i.t_fiid = w.t_fiid) BOND_NAME,   " +
                 "   trim(to_char(w.t_incomerate,'99999999999999999990.'||DECODE(w.t_incomepoint,0,'00',lpad('0',w.t_incomepoint,'9'))))  INCOME_RATE,  " +
                 "   trim(to_char(w.t_incomevolume,'99999999999999999990.'||DECODE(w.t_incomepoint,0,'00',lpad('0',w.t_incomepoint,'9')))) INCOME_VOLUME  " +
                 " FROM dfiwarnts_dbt w  " +
                    "   inner join davoiriss_dbt F on F.t_fiid = w.t_fiid  " +
                " WHERE w.t_ispartial <> CHR(88)  " +
                "  and exists (select 1 from fi_dat fd where fd.t_fiid = w.t_fiid) ), " +
       "  nom as (SELECT /*+INDEX (w DFIWARNTS_DBT_IDX2) INDEX  (F DAVOIRISS_DBT_IDX0)*/  " +
                 "  w.t_fiid, " +
                 "  F.T_ISIN ISIN,  " +
                 "  'PRINCIPAL' TYPE_INCOME,  " +
                 "  w.t_drawingdate DRAWING_DATE,  " +
                 "  (select i.t_name from dfininstr_dbt i where i.t_fiid = w.t_fiid) BOND_NAME,   " +
                 "  trim(to_char(w.t_incomerate,'99999999999999999990.'||DECODE(w.t_incomepoint,0,'00',lpad('0',w.t_incomepoint,'9')))) INCOME_RATE, " +
                 "  CASE WHEN w.t_RelativeIncome = CHR(0) THEN " +
                 "               trim(to_char(w.t_IncomeVolume,'99999999999999999990.'||DECODE(w.t_incomepoint,0,'00',lpad('0',w.t_incomepoint,'9')))) " +
                 "         ELSE " +
                 "               trim(to_char(ROUND(fi.t_facevalue * w.t_IncomeRate / GREATEST(1, w.t_IncomeScale) / 100, w.t_IncomePoint),'99999999999999999990.'||DECODE(w.t_incomepoint,0,'00',lpad('0',w.t_incomepoint,'9'))))  " +
                 "  END INCOME_VOLUME " +
                 " FROM dfiwarnts_dbt w " +
                 "     inner join davoiriss_dbt F on F.t_fiid = w.t_fiid " +
                 "     inner join  dfininstr_dbt fi on fi.t_fiid = w.t_fiid " +
               " WHERE w.t_ispartial = CHR(88)  " +
               "  and exists (select 1 from fi_dat fd where fd.t_fiid = w.t_fiid) ), " +
       " nom1 as (select /*+INDEX (F DAVOIRISS_DBT_IDX0)*/  " +
                       " fi.t_fiid, " +
                       " F.T_ISIN ISIN,  " +
                       " 'PRINCIPAL' TYPE_INCOME,  " +
                       " fi.t_drawingdate DRAWING_DATE, " +
                       " fi.t_name BOND_NAME,  " +
                       " trim(to_char(RSI_RSB_FIInstr.FI_GetNominalOnDate(fi.t_FIID, :p2)/fi.t_facevalue*100,'99999999999999999990.'||DECODE(fi.t_point,0,'00',lpad('0',fi.t_point,'9')))) INCOME_RATE, " +
                       " trim(to_char(RSI_RSB_FIInstr.FI_GetNominalOnDate(fi.t_FIID, :p3),'99999999999999999990.'||DECODE(fi.t_point,0,'00',lpad('0',fi.t_point,'9')))) INCOME_VOLUME  " +
                  " FROM dfininstr_dbt fi   " +
                      "  inner join davoiriss_dbt F on F.t_fiid = fi.t_fiid  " +
                 " where not exists (select 1 from nom n where n.t_fiid = fi.t_fiid) " +
                 " and exists (select 1 from fi_dat fd where fd.t_fiid = fi.t_fiid) " +
                " ), " +
       " rep_dat1 as ( " +
      " select * from cop  " +
          "  union all      " +
      " select * from nom1), " +
       " rep_data as (  " +
      " select * from rep_dat1  " +
          "  union all   " +
      " select * from nom) " +
"select /*+PARALLEL_AUTO*/ ISIN, DRAWING_DATE, BOND_NAME, TYPE_INCOME, INCOME_RATE, INCOME_VOLUME from rep_data   " +
   " where ISIN is not null " +
     " and ISIN != chr(0) " +
     " and ISIN != chr(1) " +
      " order by ISIN, TYPE_INCOME, DRAWING_DATE ";

	  v_cmd = RsdCommand(v_SQL);
	  v_cmd.addParam("p1", RSDBP_IN, v_service_processor.RepDate);
	  v_cmd.addParam("p2", RSDBP_IN, v_service_processor.RepDate);
	  v_cmd.addParam("p3", RSDBP_IN, v_service_processor.RepDate);
	  v_cmd.execute();

          v_rs = RsdRecordset(v_cmd);

          while (v_rs.moveNext())
		v_aux_cntr = v_resp_obj.LoadCouponReconciliation_resp.CouponList.Size;
	        v_resp_obj.LoadCouponReconciliation_resp.CouponList.value(v_aux_cntr) = c_CouponParm_resp;  
		v_resp_obj.LoadCouponReconciliation_resp.CouponList.value(v_aux_cntr).ISIN          = v_rs.value("ISIN");
		v_resp_obj.LoadCouponReconciliation_resp.CouponList.value(v_aux_cntr).TYPE_INCOME   = v_rs.value("TYPE_INCOME");
		v_resp_obj.LoadCouponReconciliation_resp.CouponList.value(v_aux_cntr).DRAWING_DATE  = v_rs.value("DRAWING_DATE"); 
		v_resp_obj.LoadCouponReconciliation_resp.CouponList.value(v_aux_cntr).BOND_NAME     = v_rs.value("BOND_NAME"); 
		v_resp_obj.LoadCouponReconciliation_resp.CouponList.value(v_aux_cntr).INCOME_RATE   = v_rs.value("INCOME_RATE");
		v_resp_obj.LoadCouponReconciliation_resp.CouponList.value(v_aux_cntr).INCOME_VOLUME = v_rs.value("INCOME_VOLUME");
          end;

      else
         /* Зафиксированы ошибки на верхнем уровне структуры */
         v_resp_obj.LoadCouponReconciliation_resp.CouponList = TArray;
      end;

   else
      /* Ошибка в структуру верхнего уровня - не переданы входные данные */
      v_resp_obj.LoadCouponReconciliation_resp.ReqID       = XmlRpcRequestId(); /* Поскольку не можем взять информацию из входящего объекта */
      v_resp_obj.LoadCouponReconciliation_resp.Result      = c_Result_Coupon;
      v_resp_obj.LoadCouponReconciliation_resp.Result.Code = CV_Coupon_ERROR_CODE;
      v_resp_obj.LoadCouponReconciliation_resp.Result.Text = "Не переданы данные купонных графиков";
      v_resp_obj.LoadCouponReconciliation_resp.CouponList  = TArray;
/*
      v_email_processor.m_add_row_to_msg_text(string(CV_EMAIL_ROW_HEAD,
                                              v_resp_obj.LoadCouponReconciliation_resp.ReqID, " - ",
                                              v_resp_obj.LoadCouponReconciliation_resp.Result.Text));
*/
   end;
/*
   /* Сохраняем текст письма для отправки плановой процедурой */
   v_email_processor.m_save_to_submit();
   /* Отправляем все не отправленные письма */
   v_email_processor.m_submit_email();
*/
   /* Преобразуем объектный вид ответа в документ требуемого формата - begin */
   v_resp_doc = v_transformator.m_secur_internal_resp(v_resp_obj);
   /* Преобразуем объектный вид ответа в документ требуемого формата - end */

   v_logger_obj.add_response(v_resp_doc, null, null, null, modulename, null);
   v_logger_obj.add_error_info(v_resp_obj.LoadCouponReconciliation_resp.Result.Code, v_resp_obj.LoadCouponReconciliation_resp.Result.Text);

   return v_resp_doc;

onError(err)
   if(ValType(v_resp_obj.LoadCouponReconciliation_resp.ReqID) == V_UNDEF)
      v_resp_obj.LoadCouponReconciliation_resp.ReqID = XmlRpcRequestId();
   end;
   v_resp_obj.LoadCouponReconciliation_resp.Result      = NULL;
   v_resp_obj.LoadCouponReconciliation_resp.Result      = c_Result_Coupon;
   v_resp_obj.LoadCouponReconciliation_resp.Result.Code = CV_Coupon_ERROR_CODE;
   v_resp_obj.LoadCouponReconciliation_resp.Result.Text = c_usr_err_obj.obtain_err_msg(err);

   /* Преобразуем объектный вид ответа в документ требуемого формата - begin */
   v_resp_doc = v_transformator.m_secur_internal_resp(v_resp_obj);
   /* Преобразуем объектный вид ответа в документ требуемого формата - end */

   v_logger_obj.add_response(v_resp_doc, null, null, null, modulename);
   v_logger_obj.add_error_info(v_resp_obj.LoadCouponReconciliation_resp.Result.Code, v_resp_obj.LoadCouponReconciliation_resp.Result.Text);

   return v_resp_doc;
end; /* macro LoadCouponReconciliation() */
