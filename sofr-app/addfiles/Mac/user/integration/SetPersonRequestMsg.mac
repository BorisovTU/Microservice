/**
 @file SetPersonRequestMsg.mac
 @brief Интеграция с внешними системами. Адаптер для загрузки клиентов - физ.лиц
 
 Интеграция с внешними системами. Адаптер для загрузки клиентов - физ.лиц
 Подразумевается, что в рамках запроса приходит всегда 1 клиент
 Обрабатываются ТОЛЬКО клиенты ГО (Filial.ObjectId = 0000)
 
  # tag
 - functional_block:Клиенты_Регистрация_на_бирже
 - code_type:BP_Step
 - Интеграция
 
  # changeLog
 |date       |author       |tasks                                                     |note                                                        
 |-----------|-------------|----------------------------------------------------------|-------------------------------------------------------------
 |02.07.2024 |Велигжанин АВ|DEF-68239                                                 | OpenAllAccounts(), добавил проверку для валюты
 |           |             |                                                          | на присутствие в настройке СПИСОК_ВАЛЮТ
 |14.02.2024 |Жиц М.В.     |BOSS-2110                                                 | Время установки примечаний по тарифам РЕПО исправлено с 12-часового 
 |           |             |                                                          | на 24-часовое                                                                                                                                                 
 |23.11.2023 |Шишкин Е.В.  |BOSS-2491                                                 | Выгружаем в депозитарий только новые договора
 |26.10.2023 |Жиц М.В.     |DEF-52846                                                 | Заполнение поля MarketCodeSPB кодом открытой площадки СПб
 |25.09.2023 |Топорков Д.В.|DEF-51435                                                 | Генерация биржевого кода с повторением для разных фирм
 |?          |Гераськина Т.|?                                                         | Создание                   
 */
import "ws_msg_transform_sec.mac"; /* Инструментарий для преобразования сообщений */
import "ws_party.mac";             /* Сервис */
import rcw;
import "func_lib.mac";
//import "PersonGetXref.mac";
import "CdiGetXref.mac";
import DealsInter;
import "rshb_lib.mac";
import SFInter, dlcontrfunc;
import "global_classes.mac";
import "u_common_email_utils.mac";
import "dlutils.mac";
import "SendNotifITP.mac";
//import "usequence_job.mac";

private var g_error_text = "OK";
private var g_transparent_id = "";

private file attr("objattr.dbt") key 0;
private file attrcor("objatcor.dbt") key 0;

private const CURRENCY_LIST = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\СПИСОК_ВАЛЮТ";
private var g_accrec_arr = TArray;
private var g_err_arr = TArray;
private var g_flag_debt = false;

// def-28035 количество дней вынесено в настройку
private const DAYS_CONTRACT_EXPIRE = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\МАКС ГЛУБИНА ДАТЫ ДОГОВОРА";

//BIQ-8786 дата обновления тарифов
private const DATE_RENEW_TARIF = "РСХБ\\ИНТЕГРАЦИЯ\\ДАТА ОБНОВЛЕНИЯ ТАРИФОВ";

//boss-3520 включение/выключение возможности загруки нескольких ДБО
private const SEVERAL_DBO = "РСХБ\\ИНТЕГРАЦИЯ\\ЗАГРУЗКА_НЕСКОЛЬКИХ_ДБО";

private const  DLCONTR_MESSAGE_REFUSAL_CHNG_TARIFF = 650;

private macro SetPersonAddDBLog(p_text)
  execSQL("begin it_log.log(?,it_log.C_MSG_TYPE__DEBUG); end;", makeArray(SQLParam("msg", SubStr(("setperson: " + p_text),1,4000))), true);
end;

//dan Временное решение для использования расширенного списка фирм на срочном рынке
//DEF-36150 F505 исчерпан, список фирм перенесен в справочник 5053 Брокерские фирмы для срочного рынка (FirmId) 
private const NUMBER_LLVALUE_FIRMID = 5053;

  //список возможных фирм: 
/*  var ar_FirmID = TArray();
      ar_FirmID[0] = "F502";
      ar_FirmID[1] = "F504";
      ar_FirmID[2] = "F505"; */

  private macro CheckSeqNotEnded(FirmID)
     var max_count = 46655; // максимальное значение счетчика
     var sql = "SELECT last_number   \n"
               "  FROM all_sequences \n"
               "  WHERE sequence_name = 'U_' || UPPER (:FirmID) || '_SEQ'; " ;
     var cmd = RSDCommand(sql);
         cmd.AddParam("FirmID", rsdbp_in, FirmID);
     var rs = RSDRecordset(cmd, rsdval_client, rsdval_static);
     if ((rs.MoveNext()) and (rs.value("last_number") >= max_count))
       return 0;
     end;
       return 1;
  end;

  private macro GetCurFirmID()
     var CurFirmID;
     var item_FirmID;
     var sql_str, rs, cmd;

     sql_str = "select t_code from dllvalues_dbt where t_list = "+NUMBER_LLVALUE_FIRMID+" order by t_element";
     rs = RSDRecordSet(sql_str);
     while (rs.movenext)
        CurFirmID = rs.value("t_code");
        if(CheckSeqNotEnded(CurFirmID))
          break;
        end;
     end;
     return CurFirmID;
  end;

  private macro getContact(p_client_id, p_kind, p_type)
     var sql_str, rs, cmd;
     var res = "";
     
     sql_str = "SELECT t_value "+
               "  FROM dcontact_dbt "+
               " WHERE t_partyid = :p_client_id "+
               "   AND t_addresstype in ( 0,1) "+ 
               "   AND t_ismain = 'X' "+    
               "   AND t_contactkind = :p_kind "+ 
               "   AND t_contacttype = :p_type "; 
     cmd = RSDCommand(sql_str);
     cmd.AddParam("p_client_id", RSDBP_IN, p_client_id);
     cmd.AddParam("p_kind", RSDBP_IN, p_kind);
     cmd.AddParam("p_type", RSDBP_IN, p_type);
     rs = RSDRecordSet(cmd);
  
     if (rs.movenext)  
        res = rs.value(0);
     end;
     
     return res;
  end;

  private macro CheckChangeContact(Phone_old,Phone_contact_new)

    var i = 0, count = Phone_contact_new.size;

    while(count > i)
      if(Phone_contact_new[i].category == CV_CONTACT_TYPE_MOBILE)
         if(Phone_contact_new[i].value != Phone_old)
            return true;
         end;
         return false;
      end;
      i=i+1;
    end;
    return false;
  end;


  /**
  @brief Функция для генерации кода для торговой фирмы с повтором на случай смены sequence
  @param[in] personid Party ID
  @param[in] IIS Признак IIS
  @param[in] IsIP Признак
  @param[in] servkind Вид обслуживания
  @param[in] UndrWr 
  @param[in] FirmID ID торговой фирмы "F502" и т.п.
  @param[in] codekind Номер поля
  @return Биржевой краткий код
  
  # SetParam
  - FirmID ID торговой фирмы "F502" и т.п.
  @note Обновляется в случае, если биржевой краткий код сгенерирован для другого FirmID
  
  Так как для торговой фирмы может быть пересоздан Sequence (DEF-36300), то при вызове GeneratePersonalCode 
  возможна ситуация, когда sequence для текущей торговой фирмы будет просмотрен полностью без нахождения
  кода пригодного к использованию (DEF-51435). В этом случае попробуем сгенерировать код еще раз.
  */
  private macro GeneratePersonalCodeWithRepeat(personid, IIS, IsIP, servkind, UndrWr, FirmID, codekind)
    var currentFirmID = FirmID;
    var previousFirmID = null;
    var shortCode = null;
    
    while (previousFirmID != currentFirmID)
      shortCode = GeneratePersonalCode(personid, IIS, IsIP, servkind, UndrWr, currentFirmID, codekind);
      previousFirmID = currentFirmID;
      
      if (shortCode == null) ///> GeneratePersonalCode не нашла "свободный" номер для currentFirmID
        currentFirmID = GetCurFirmID(); ///> Попробуем проверить, может текущий sequence изменился, если нет, то выйдем из while
      end;
    end;
    
    if (FirmID != currentFirmID)    
      SetParm(5 /*FirmID*/, currentFirmID); ///> Обновим внешнюю переменную
    end;
    
    return shortCode;
  end;

//def-54394
  /**
  @brief Функция для сверки паспортных дынных из ЦФТ и паспортных дынных в СОФР
  @param[in] Partyid id клиента в СОФР
  @param[in] DocSeries серия паспорта клиента
  @param[in] DocNumber номер паспорта клиента
  @return Если серия и номер паспорта совпадают у имеющегося клиента, то возвращается true
  */
private macro CheckDocNumberWithoutSpace( Partyid, DocSeries, DocNumber ) 
 
 var Query :string = "",
     DataSet :RsdRecordset,
     Params :TArray;
 var paper_old, paper_new;
 

 Query = " select replace(d.t_paperseries||d.t_papernumber,' ') from dpersnidc_dbt d "+
         " where t_isnotvalid = chr (0) and t_personid = :persnid order by decode (t_ismain, 'X', 0, 1) " ;
 
 Params = makeArray( SQLParam("persnid", Partyid));
 DataSet = execSQLselect( Query, Params );
 
 if(DataSet.MoveNext )
    paper_old = DataSet.value(0, Null, V_INTEGER);
 end;

 Query = null; Params= null; DataSet = null;

 Query = " select replace(':p_DocSeries'||':p_DocNumber',' ') from dual ";
 
 Params = makeArray( SQLParam("p_DocSeries", DocSeries),
                     SQLParam("p_DocNumber", DocNumber));
 DataSet = execSQLselect( Query, Params );
 
 if(DataSet.MoveNext )
    paper_new =  DataSet.value(0, Null, V_INTEGER);
 end;

 if(paper_new == paper_old)
    return true;
 else
    return false;
 end;

end;

//def-54394
  /**
  @brief Функция для получения паспортных дынных клиента в СОФР
  @param[in] Partyid id клиента в СОФР
  @param[in] DocSeries серия паспорта клиента
  @param[in] DocNumber номер паспорта клиента
  @return возвращает серия или номер в зависимости от параметров DocSeries и DocNumber
  */
private macro GetDocNumber(Partyid,paperseries,papernumber)

 var Query :string = "",
     DataSet :RsdRecordset,
     Params :TArray;

 Query = " select d.t_paperseries,d.t_papernumber from dpersnidc_dbt d  "+
         " where t_isnotvalid = chr (0) and t_personid = :persnid order by decode (t_ismain, 'X', 0, 1) " ;
 
 Params = makeArray( SQLParam("persnid", Partyid));
 DataSet = execSQLselect( Query, Params );
 
 if(DataSet.MoveNext )
    if(paperseries == true)
       return DataSet.value(0, Null, V_INTEGER);
    elif(papernumber == true)
       return DataSet.value(1, Null, V_INTEGER);
    end;
 end;

end;

//05052022 shev insert в dobjatcor_dbt
// DEF-40913, DEF-41360 Ошибка установки категории
private macro InsAttr(objtype,groupid,attrid,objid,pcurdate)
   var sql, params, cmd; 

sql = 
"declare "+
"   vid         number; "+
"   vobjecttype number := :pobjtype; "+
"   vgroupid    number := :pgroupid; "+
"   vattrid     number; "+
"   vobject     varchar2(35 byte) := :pobject; "+
"   vattrid_new number := :pattrid; "+
"   vfromdate   date := :pfromdate; "+
"   vtodate     date := :ptodate; "+
"   voper       number := :poper; "+
"begin "+
"   begin  "+
"      select t_id, t_attrid into vid, vattrid "+
"        from dObjAtCor_dbt  "+
"       where t_objecttype = vobjecttype "+
"         and t_groupid = vgroupid  "+
"         and t_object = vobject "+
"         and t_validtodate = to_date('31129999','ddmmyyyy'); "+
"   exception "+
"      when no_data_found then vid := 0;  "+
"   end; "+
"   if vid = 0 then  "+
"      insert into dObjAtCor_dbt (t_objectType, t_groupId, t_attrId, t_object, t_general,  "+
"                                 t_validFromDate, t_oper, t_validToDate, t_sysDate, t_sysTime, t_isAuto) "+
"      values (vobjecttype, vgroupid, vattrid_new, vobject, 'X',  "+
"              vfromdate, voper, vtodate, to_date(to_char(sysdate, 'DD.MM.YYYY'), 'DD.MM.YYYY'), TO_DATE('01.01.0001 ' || TO_CHAR(sysdate, 'HH24.MI.SS'), 'DD.MM.YYYY HH24.MI.SS'), 'X'); "+
"   else  "+
"      if vattrid <> vattrid_new then "+
"         update dObjAtCor_dbt "+
"            set t_attrId = vattrid_new, t_sysDate = to_date(to_char(sysdate, 'DD.MM.YYYY'), 'DD.MM.YYYY'), t_sysTime = TO_DATE('01.01.0001 ' || TO_CHAR(sysdate, 'HH24.MI.SS'), 'DD.MM.YYYY HH24.MI.SS') "+
"         where t_id = vid; "+
"      end if; "+
"   end if; "+
"end; ";

   params = MakeArray(SQLParam("pobjtype", ObjType), 
                      SQLParam("pgroupid", GroupId),
                      SQLParam("pobject", ObjId),
                      SQLParam("pattrid", AttrId), 
                      SQLParam("pfromdate", pcurdate), 
                      SQLParam("ptodate", date("31.12.9999")),
                      SQLParam("poper", {Oper}) ); 
 
   cmd = ExecSQL(sql, params, false);
   if(null == cmd) 
      return false;
   end; 

   return true; 
end;


//получим FIID из ISO кода валюты
private macro GetFiidFromCodeISO( FiKind :integer, FiCode :string ) :integer
var Query :string = "",
    DataSet :RsdRecordset,
    Params :TArray;


 Query = " SELECT T_FIID FROM dfininstr_dbt " +
         " WHERE T_FI_KIND = :FiKind " +
         "  AND T_FI_CODE = :FiCode ";

 Params = makeArray( SQLParam("FiKind", FiKind),
                     SQLParam("FiCode", FiCode) );
 DataSet = execSQLselect( Query, Params );

 if( DataSet.MoveNext )
  return DataSet.value(0, Null, V_INTEGER);
 else
  return -1;
 end;

end;

// 17-03-2020 Cherednichenko проверка дублирования события для выгрузки ДБО в utableprocessevent
private macro EventDoubling(p_objecttype, p_ObjectID)
  var rs:object;
  var select:string;
  var params:TArray;

  select = "select * from utableprocessevent_dbt where 1=1 "+
                            " and t_status = 1 "+
                            " and t_objecttype = :objecttype "+
                            " and t_objectid = :ObjectID ";
  params = makeArray( SQLParam("objecttype", p_objecttype),
                      SQLParam("ObjectID", p_ObjectID) );
  rs = execSQLselect( select, params, FALSE );
  if( rs.MoveNext() )
    return true;    
  else
    return false;
  end;
end;


//gtv: служебная метка в трассу
private macro ServPutIntoTrace(_text)
   var sql_str, rs;
   sql_str = "select 'serv_message', '"+_text+"', sysdate from dual";
   rs = RSDRecordSet(sql_str);
   rs.movenext;
   rs.close; rs = null;
end;


// поиск ЕД БО по номеру и клиенту, чтобы задействовать индекс
private macro FindDlContrByNumberAndClient(p_client_id, p_cntr_num, p_exist_email:@string, p_usequik:@bool, p_sfcontrid:@integer)
   var sql_str, rs, cmd;
   var res = -1;
   
   sql_str = "SELECT cntr.t_id cntr_id, dl.t_dlcontrid dl_id, dl.t_email, nvl(dl.t_usequik, chr(0)) t_usequik, "+
             "       dl.t_iisfirstdate, dl.t_iisfirstbrokername, dl.t_iisfirstnumber "+
             " FROM dsfcontr_dbt cntr, "+
             "      ddlcontr_dbt dl "+
             "WHERE dl.t_sfcontrid = cntr.t_id "+
             "  AND cntr.t_partyid = :p_client_id "+
             "  AND cntr.t_number = :p_cntr_num "+
             "  AND cntr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') ";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("p_client_id", RSDBP_IN, p_client_id);
   cmd.AddParam("p_cntr_num", RSDBP_IN, p_cntr_num);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      res = rs.value("dl_id");
      p_exist_email = rs.value("t_email");
      p_usequik = rs.value("t_usequik");
      p_sfcontrid = rs.value("cntr_id");
   end;
   
   return res;
end;

// поиск ЕД БО 
private macro FindDlContrAfterOpen(p_dlcontrid)
   var sql_str, rs, cmd;
   var res = -1;
   
   sql_str = "SELECT cntr.t_id cntr_id, dl.t_dlcontrid dl_id, dl.t_email, nvl(dl.t_usequik, chr(0)) t_usequik, "+
             "       dl.t_iistransfer, dl.t_iisfirstdate, dl.t_iisfirstbrokername, dl.t_iisfirstnumber "+
             " FROM dsfcontr_dbt cntr, "+
             "      ddlcontr_dbt dl "+
             "WHERE dl.t_sfcontrid = cntr.t_id "+
             "  AND dl.t_dlcontrid = :p_dlcontrid ";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("p_dlcontrid", RSDBP_IN, p_dlcontrid);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      res = rs.value("cntr_id");
   end;
   
   return res;
end;

// поиск предыдущего договора
private macro FindAnotherContractByCodeClient(_isIIS, _personid)
   var sql_str, rs, cmd, IsSeveralDBO:bool = false;
   var res = "OK";
   var IIS, iis_str = "";
   
   if ((ValType(_isIIS) != V_UNDEF) and (_isIIS))
      IIS = " chr(88) ";
      iis_str = "ИИС ";
   else
      IIS = " chr(0) ";
      iis_str = "БО ";
   end;

   GetRegistryValue (SEVERAL_DBO, V_BOOL, IsSeveralDBO);

   if (not IsSeveralDBO)
      sql_str = "SELECT cntr.t_id cntr_id, dl.t_dlcontrid, cntr.t_number, cntr.t_datebegin "+
                " FROM dsfcontr_dbt cntr, "+
                "      ddlcontr_dbt dl, "+
                "      dobjcode_dbt code "+
                "WHERE dl.t_sfcontrid = cntr.t_id "+
                "  AND cntr.t_partyid = code.t_objectid and code.t_objecttype = 3 and code.t_codekind = 101 and code.t_bankclosedate = to_date('01010001','dd.mm.yyyy') "+
                "  AND code.t_code = :p_client_id "+
                "  AND dl.t_iis = "+IIS+
                "  AND cntr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') ";
      cmd = RSDCommand(sql_str);
      cmd.AddParam("p_client_id", RSDBP_IN, _personid);
      rs = RSDRecordSet(cmd);
      if (rs.movenext)
         res = iis_str + rs.value("t_number") + " от " + date(rs.value("t_datebegin"));
      else
         res = "OK";
      end;
   else
      res = "OK";
   end;
   
   return res;
end;


private macro FillTableDouble(_cntr_num, _cntr_date,  _personid, _text )
   var sql_str, cmd;

   sql_str = "INSERT INTO  USR_DOUBLECONTRACT_DBT "+
             "   (  T_DATE, T_TRANSPARENT_ID, T_PARTYCODE, T_CONTRACT_NUM, T_CONTRACT_DATE, T_TEXT ) "+
             " VALUES (systimestamp, :pid, :code, :num, :dt, :t) ";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("pid", RSDBP_IN, g_transparent_id);
   cmd.AddParam("code", RSDBP_IN, _personid);
   cmd.AddParam("num", RSDBP_IN, _cntr_num);
   cmd.AddParam("dt", RSDBP_IN, _cntr_date);
   cmd.AddParam("t", RSDBP_IN, _text);
   cmd.execute;
   cmd.close;
end;

// Описание контакта
private class adp_Contact(IncomeData, _nametag_up)
   var IsPrimary     :bool;      // Признак основного контакта          Нет
   var IsNotification:bool;      // Признак контакта для уведомлений    Нет
   var ContactCode   :string;    // Значение                            Да
   
   // символьные
   var ContactID     ;           // ИД контакта в АБС                   Нет
   
   // справочники
   var ContactType   ;           // Тип контакта                        Да
   var ContactProfile;           // Назначение                          Нет
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      var nametag_up = "Contact";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      IsPrimary      = getValueFromProperty(IncomeData, "IsPrimary"        , nametag_up);
      IsNotification = getValueFromProperty(IncomeData, "IsNotification"   , nametag_up);
      ContactCode    = getValueFromProperty(IncomeData, "ContactCode"      , nametag_up, true);
      
      ContactID      = getSymbolFromProperty(IncomeData, "ContactID"       , nametag_up);
      
      ContactType    = getDictionaryFromProperty(IncomeData, "ContactType"    , nametag_up, true);
      ContactProfile = getDictionaryFromProperty(IncomeData, "ContactProfile" , nametag_up);
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Описание ДУЛ
private class adp_Credential(IncomeData, _nametag_up)
   var DocSeries     :String; // Серия                Нет
   var DocNumber     :String; // Номер                Да
   var IssueDate     :Date;   // Дата выдачи          Да
   var EndDate       :Date;   // Дата окончания       Нет
   var IssuerName    :String; // Кем выдан            Да
   var IssuerCode    :String; // Код подразделения    Нет
   
   // символьные
   var CredentialID  ;  // ИД ДУЛ в АБС               Нет
   
   // справочники
   var DocTypeCode   ;  // Код вида документа         Да
   var mDocTypeCode; 
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      var nametag_up = "Credential";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      DocTypeCode    = getDictionaryFromProperty(IncomeData, "DocTypeCode", nametag_up, true);
      
      DocSeries      = getValueFromProperty(IncomeData, "DocSeries"  , nametag_up);
      DocNumber      = getValueFromProperty(IncomeData, "DocNumber"  , nametag_up, true);
      EndDate        = getValueFromProperty(IncomeData, "EndDate"    , nametag_up);
      IssuerCode     = getValueFromProperty(IncomeData, "IssuerCode" , nametag_up);
      
      CredentialID   = getSymbolFromProperty(IncomeData, "CredentialID", nametag_up);
      
      if (StrUpr(DocTypeCode.RecordCode) == "СНИЛС")
         IssueDate      = getValueFromProperty(IncomeData, "IssueDate"  , nametag_up);
         IssuerName     = getValueFromProperty(IncomeData, "IssuerName" , nametag_up);
      else
         IssueDate      = getValueFromProperty(IncomeData, "IssueDate"  , nametag_up, true);
         IssuerName     = getValueFromProperty(IncomeData, "IssuerName" , nametag_up, true);
      end;
      // теперь DocTypeCode содержит код ФНС
      mDocTypeCode = DocTypeCode.RecordCode;
      /*if (StrUpr(DocTypeCode.RecordCode) == "ПАСПОРТ")
         mDocTypeCode = 21;
      elif (StrUpr(DocTypeCode.RecordCode) == StrUpr("ЗагрПаспорт"))
         mDocTypeCode = 22;
      else
         mDocTypeCode = DocTypeCode;
      end; */
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Страна
private class adp_Citizenship(IncomeData, _nametag_up)
   var CitizenshipNumber  :String;  // Номер гражданства в АБС     Да
   
   // справочники
   var CitizenshipCode    ;         // Код страны                  Да

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      var nametag_up = "Citizenship";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      CitizenshipNumber = getValueFromProperty(IncomeData, "CitizenshipNumber", nametag_up, true);
      
      CitizenshipCode   = getDictionaryFromProperty(IncomeData, "CitizenshipCode", nametag_up, true);
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Единичный адрес
private class adp_Address(IncomeData, _nametag_up)
   var AddressFullString   : String;   // Адрес одной строкой        Нет
   var District            : String;   // Район                      Нет
   var City                : String;   // Город                      Нет
   var Locality            : String;   // Населенный пункт           Нет
   var Street              : String;   // Улица                      Нет
   var House               : String;   // Дом (владение)             Нет
   var Building            : String;   // Корпус                     Нет
   var Apartment           : String;   // Квартира/офис              Нет
   var PostCode            : String;   // Почтовый индекс            Нет
   var Structure           : String;   // Строение                   Нет
   var HouseFiasGUID       : String;   // Код ФИАС                   Нет
   
   // символьные
   var AddressID           ;   // ИД адреса в АБС            Да
   
   // справочники
   var AddressType         ;   // Тип адреса        Да
   var CountryCode         ;   // Код страны        Да
   var RegionGNI           ;   // Код региона ГНИ   Нет
   var AddressRegionCode   ;   // Код региона       Нет
   
   var mAddressType;
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      var err_txt;
      var nametag_up = "Address";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      AddressFullString = getValueFromProperty(IncomeData, "AddressFullString"   , nametag_up);
      District          = getValueFromProperty(IncomeData, "District"            , nametag_up);
      City              = getValueFromProperty(IncomeData, "City"                , nametag_up);
      Locality          = getValueFromProperty(IncomeData, "Locality"            , nametag_up);
      Street            = getValueFromProperty(IncomeData, "Street"              , nametag_up);
      House             = getValueFromProperty(IncomeData, "House"               , nametag_up);
      Building          = getValueFromProperty(IncomeData, "Building"            , nametag_up);
      Apartment         = getValueFromProperty(IncomeData, "Apartment"           , nametag_up);
      PostCode          = getValueFromProperty(IncomeData, "PostCode"            , nametag_up);
      Structure         = getValueFromProperty(IncomeData, "Structure"           , nametag_up);
      HouseFiasGUID     = getValueFromProperty(IncomeData, "HouseFiasGUID"       , nametag_up);
      
      AddressID         = getSymbolFromProperty(IncomeData, "AddressID", nametag_up, true);
      
      AddressType       = getDictionaryFromProperty(IncomeData, "AddressType"       , nametag_up, true);
      CountryCode       = getDictionaryFromProperty(IncomeData, "CountryCode"       , nametag_up, true);
      RegionGNI         = getDictionaryFromProperty(IncomeData, "RegionGNI"         , nametag_up);
      AddressRegionCode = getDictionaryFromProperty(IncomeData, "AddressRegionCode" , nametag_up);
      
      if ( StrUpr(AddressType.RecordCode) == StrUpr("АдрПроп") )
         mAddressType = 5; // Адрес места регистрации
      elif ( StrUpr(AddressType.RecordCode) == StrUpr("АдрФакт") )
         mAddressType = 2; // физический
      elif ( StrUpr(AddressType.RecordCode) == StrUpr("АдрПочт") )
         mAddressType = 3; // почтовый
      elif ( StrUpr(AddressType.RecordCode) == StrUpr("АдрМРож") )
         mAddressType = 7; // 
      elif ( StrUpr(AddressType.RecordCode) == StrUpr("АдрМраб") )
         mAddressType = 9; // 
      else
         err_txt = string("Недопустимое значение "+nametag_up+".AddressType.RecordCode=",AddressType.RecordCode);
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
      end;

   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Сведения о бенифициарном владельце
private class adp_BenefInfo(IncomeData, _nametag_up)
   var BehefOprKind  : String;      // Тип опроса клиента            Нет
   var BenefVlKind   : String;      // Тип выявленного бенефициара   Да
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      var nametag_up = "BenefInfo";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      BehefOprKind   = getValueFromProperty(IncomeData, "BehefOprKind"  , nametag_up);
      BenefVlKind    = getValueFromProperty(IncomeData, "BenefVlKind"   , nametag_up, true);
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Связанный субъект
private class adp_CoupledSubject(IncomeData, _nametag_up)
   var StartDate     : date;        // Начало действия связи      Да
   var EndDate       : date;        // Окончание действия связи   Нет
   
   // символьные
   var CSubjectID    ;              // ИД субъекта в АБС          Да
   
   // справочники
   var RoleCode      ;              // Код роли                   Да
   var CSubjectKind  ;              // Тип субъекта               Да
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      var nametag_up = "CoupledSubject";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
   
      StartDate   = getValueFromProperty(IncomeData, "StartDate"  , nametag_up, true);
      EndDate     = getValueFromProperty(IncomeData, "EndDate"    , nametag_up);
      
      CSubjectID  = getSymbolFromProperty(IncomeData, "CSubjectID", nametag_up, true);
      
      RoleCode    = getDictionaryFromProperty(IncomeData, "RoleCode"       , nametag_up, true);
      CSubjectKind= getDictionaryFromProperty(IncomeData, "CSubjectKind"   , nametag_up, true);
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// ГВК
private class adp_GVK(IncomeData, _nametag_up)
   var GVKCode    ;  // Код группы                  Да    Справочник

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      var err_txt;
      var nametag_up = "GVK";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      GVKCode = getDictionaryFromProperty(IncomeData, "GVKCode", nametag_up, true);
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// ОКВЭД
private class adp_OKVED(IncomeData, _nametag_up)
   var OKVEDType  ; // Тип классификатора ОКВЭД   Да     Справочник
   var OKVEDCode  ; // Код ОКВЭД                  Да     Справочник
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      var err_txt;
      var nametag_up = "OKVED";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      OKVEDCode = getDictionaryFromProperty(IncomeData, "OKVEDCode", nametag_up, true);
      OKVEDType = getDictionaryFromProperty(IncomeData, "OKVEDType", nametag_up, true);
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Информация о торговых площадках по Договорам
private class adp_TradingPlatforms(IncomeData, _nametag_up)
   var TradingPlatformCode;      // Код торговой площадки   Да     Справочник
   var TradingPlatformCurrency;  // Числовой код валюты     Да     Справочник
   var CurrencyMMVBType;
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      var err_txt;
      var nametag_up = "TradingPlatformInfo";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      TradingPlatformCode     = getDictionaryFromProperty(IncomeData, "TradingPlatformCode"     , nametag_up, true);
      TradingPlatformCurrency = getDictionaryFromProperty(IncomeData, "TradingPlatformCurrency" , nametag_up, true);
      CurrencyMMVBType        = getDictionaryFromProperty(IncomeData, "CurrencyMMVBType" , nametag_up);
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// BIQ-8786 тарифные планы
// Тариф обслуживания
private class (c_Tariff) adp_Tariff(IncomeData, _nametag_up)
   Initc_Tariff;
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      var err_txt;
      var nametag_up = "Tariff";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      IsIndividual= getValueFromProperty(IncomeData, "IsIndividual"  , nametag_up, true);
      Comment     = getValueFromProperty(IncomeData, "Comment"       , nametag_up);
      Description = getValueFromProperty(IncomeData, "Description"   , nametag_up);
      IsHidden    = getValueFromProperty(IncomeData, "IsHidden"      , nametag_up);
      BeginDate   = getValueFromProperty(IncomeData, "BeginDate"     , nametag_up);
      EndDate     = getValueFromProperty(IncomeData, "EndDate"       , nametag_up);
      BindDate    = getValueFromProperty(IncomeData, "BindDate"      , nametag_up);
      UnbindDate  = getValueFromProperty(IncomeData, "UnbindDate"    , nametag_up);
      
      TariffId    = getSymbolFromProperty(IncomeData, "TariffId", nametag_up, true);
      
      TariffKind  = getDictionaryFromProperty(IncomeData, "TariffKind", nametag_up, true);
      TariffPlan  = getDictionaryFromProperty(IncomeData, "TariffPlan", nametag_up, true);
      
      // допустимые значения TariffKind
      /*if ( StrUpr(TariffKind.RecordCode) == "BROKERAGE" )
      elif ( StrUpr(TariffKind.RecordCode) == "REPO" )
      elif ( StrUpr(TariffKind.RecordCode) == "UNDEFINED" )
      else
         err_txt = string("Недопустимое значение "+nametag_up+".TariffKind.RecordCode=",TariffKind.RecordCode);
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
      end;*/
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// договор Брокерского обслуживания
private class adp_AgreementInfo(IncomeData, _nametag_up, _PersonID)
   var AgreementNumber     : string;      // Номер договора Брокерского обслуживания              Да
   var AgreementDate       : date;        // Дата заключения договора Брокерского обслуживания    Да
   var ConditionDate       : date;        // Дата изменений условий
   var IsAnotherContract   : bool;        // Признак намерений перевода активов ИИС3 от другого проф участника  Нет
   var IsIISContract       : bool;        // Признак ИИС                                          Нет
   var IISType             : string;      // Тип ИИС                                              Нет 
   var IsOldIISContract    : bool;        // Отсутствие договоров ИИС старого типа                Нет
   var IsLimitContract     : bool;        // Наличие ИИС3 у всех проф участников не более двух    Нет
   var IsTransformationFlag: bool;        // Признак трансформации ИИС                            Нет
   var TransformationDate  : date;        // Дата трансформации ИИС                               Нет
   var RiskLevelBrok       : String;      // Уровень риска клиента                                Нет
   //var IsQuik              : string;      // Использование QUIK для подачи поручений             Нет
   var IsQuik;  // TArray    Теперь будет массив, потому что через запятую
   
   // BIQ-7910 поменялась структура
   // примечание: некоторые поля добавлены были до 7910, приведено в соответствие
   var DossierURL       : string;   // Ссылка на досье                                      Нет
   var IsCurrentAccounts   : bool;  // BIQ-7910, true - выплаты на текущий счет, false - выплаты на счет брокерского обслуживания  Да
   var ListAcctsBrok    : String;   // Список текущих счетов                                       Нет
   // BIQ-7683 Гераськина Т.В. для списка ListAcctsBrok список БИКов счетов
   var BIC              : String;   // Список БИКов                                                Нет
   var DossierId;                   // контейнер Идентификатор обобщенного досье в АСОА            Нет
   
   var QUIK_;
   var SKP_;
   var PAPER_;
   var PHONE_;
   var FAKT2_;

   var TradingPlatformsList;           // Список торговых площадках, относящихся к Договору
   
   // BIQ-8786 тарифные планы
   var TariffList;      //Список тарифов    Да
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up, _PersonID)
      var err_txt, aux_buff;
      var nametag_up = "AgreementInfo";
      var temp_str, pos = 0, ttt, ai;
      var state = false;

      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      AgreementNumber      = getValueFromProperty(IncomeData, "AgreementNumber"     , nametag_up, true);
      AgreementDate        = getValueFromProperty(IncomeData, "AgreementDate"       , nametag_up, true);
      ConditionDate        = getValueFromProperty(IncomeData, "ConditionDate"       , nametag_up);
      IsAnotherContract    = getValueFromProperty(IncomeData, "IsAnotherContract"   , nametag_up);
      IsIISContract        = getValueFromProperty(IncomeData, "IsIISContract"       , nametag_up);
      IISType              = getValueFromProperty(IncomeData, "IISType"             , nametag_up); 
      IsOldIISContract     = getValueFromProperty(IncomeData, "IsOldIISContract"    , nametag_up);
      IsLimitContract      = getValueFromProperty(IncomeData, "IsLimitContract"     , nametag_up);
      IsTransformationFlag = getValueFromProperty(IncomeData, "IsTransformationFlag", nametag_up);
      TransformationDate   = getValueFromProperty(IncomeData, "TransformationDate"  , nametag_up);
      RiskLevelBrok        = getValueFromProperty(IncomeData, "RiskLevelBrok"       , nametag_up);
      //IsQuik               = getValueFromProperty(IncomeData, "IsQuik"             , nametag_up);

      IsQuik = TArray;
      temp_str = getValueFromProperty(IncomeData, "IsQuik", nametag_up);
      if (ValType(temp_str) != V_UNDEF)
         pos = Index(temp_str,",");
         ai = 0;
         while (pos > 0)
            ttt = Substr(temp_str,1,pos-1);
            IsQuik.value(ai) = ttt;
            temp_str = Substr(temp_str,pos+1);
            pos = Index(temp_str,",");
            ai = ai+1;
         end;
         if ( StrLen(temp_str) > 0 )
            IsQuik.value(ai) = temp_str;      // последний элемент
         end;
      end;

      for (ttt, IsQuik)
        if (ttt == "СКПЭП")
           SKP_ = true;
        elif (ttt == "QUIK")
           QUIK_ = true;
        elif (ttt == "2ФАКТ")
           FAKT2_ = true;
        elif (ttt == "БУМАЖН")
           PAPER_ = true;
        elif (ttt == "ТЕЛЕФОН")
           PHONE_ = true;
        end;
      end;
      
      var dlcontr_id_number = FindDlContrByNumber(AgreementNumber, null);
      if (dlcontr_id_number > 0)  // договор найден
      else  // проверка только для "новых"
         // def-28035 количество дней вынесено в настройку
         var days_expire = uGetRegistryParam(DAYS_CONTRACT_EXPIRE, V_INTEGER);
         if (valtype(days_expire) != V_INTEGER) // настройка не задана вообще/не найдена
            days_expire = 14; 
         end;
         if (days_expire > 0) // если настройка = 0, считается, что ограничений нет
            if ( ({curdate} - AgreementDate) > days_expire )
               //err_txt = string("Дата договора "+AgreementDate+". Обрабатываются договора не старше 7 календарных дней ");
               //RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
               // gtv: договора не обрабатываем, но клиента обновляем
               g_error_text = string("Дата договора "+AgreementDate+". Обрабатываются договора не старше "+days_expire+" календарных дней ");
               AgreementNumber = NULL;
               AgreementDate = NULL;
            end;
         end;
         state = FindAnotherContractByCodeClient(IsIISContract, _PersonID.ObjectID);
         if (state != "OK")
            g_error_text = string("Обновление данных: у клиента есть открытый договор ",state);
            FillTableDouble(AgreementNumber, AgreementDate,  _PersonID.ObjectID, g_error_text );
            AgreementNumber = NULL;
            AgreementDate = NULL;
         end;
      end;
      
      DossierURL = getValueFromProperty(IncomeData, "DossierURL", nametag_up);
      IsCurrentAccounts = getValueFromProperty(IncomeData, "IsCurrentAccounts", nametag_up, true);
      ListAcctsBrok     = getValueFromProperty(IncomeData, "ListAcctsBrok", nametag_up);
      // BIQ-7683 Гераськина Т.В. для списка ListAcctsBrok список БИКов счетов
      BIC         = getValueFromProperty(IncomeData, "BIC", nametag_up);
      DossierId   = getSymbolFromProperty(IncomeData, "DossierId", nametag_up);

      if (valtype(AgreementNumber) != V_UNDEF )
         aux_buff = uTryToGetPropS(IncomeData, "TradingPlatformsList");
         if(ValType(aux_buff) == V_GENOBJ)
            TradingPlatformsList = TArray;
            aux_buff = 0;
            while(IncomeData.TradingPlatformsList.size > aux_buff)
               TradingPlatformsList.value(TradingPlatformsList.size) = adp_TradingPlatforms(IncomeData.TradingPlatformsList.value(aux_buff), nametag_up);
               aux_buff = aux_buff + 1;
            end;
         elif(ValType(aux_buff) == V_UNDEF)
            if (dlcontr_id_number > 0)  // договор найден
            else
               err_txt = string("Задан договор "+AgreementNumber+" и отсутствуют торговые площадки ");
               RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
            end;
         else
            err_txt = string(InErrNotObj, nametag_up+".TradingPlatformsList");
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
         end;  
      end;
      
      // BIQ-8786 тарифные планы
      aux_buff = uTryToGetPropS(IncomeData, "TariffList");
      if(ValType(aux_buff) == V_GENOBJ)
         TariffList = TArray;
         aux_buff = 0;

         // BIQ-8786 дата принудительного обновления тарифа Базовый
         var TarifSplitDate_str = "", TarifSplitDate = date(31,12,9999);
         var temp_date, temp_tar;
         var g = GetRegistryValue (DATE_RENEW_TARIF, V_STRING, TarifSplitDate_str);
         if (ValType(g) != V_UNDEF)
            if ( (StrLen(TarifSplitDate_str) == 10) and (TarifSplitDate_str != "00.00.0000") ) 
               TarifSplitDate = date(TarifSplitDate_str);
            end;
         end;
         if (TarifSplitDate < date(31,12,9999))
            var NewTarif = "ИНВЕСТОР", NewTarifId = 0;
            var cmd = TrsbDataSet(" select * from dsfplan_dbt where UPPER(t_name) = UPPER('" + NewTarif + "') ");
            If (cmd.movenext())
               NewTarifId = cmd.num;
            end;
         end;

         var flag_do = true;
         while(IncomeData.TariffList.size > aux_buff)
            ai = TariffList.size;
            temp_tar = adp_Tariff(IncomeData.TariffList.value(aux_buff), nametag_up);
            if (NewTarifId > 0)
               // если смены Базового нет, а это все еще действующий тариф, то так тому и быть
               if  (StrUpr(temp_tar.TariffPlan.RecordCode) == "БАЗОВЫЙ") 
                  if (Valtype(temp_tar.UnbindDate) == V_UNDEF)
                     flag_do = false;
                  else 
                     if ( (temp_tar.UnbindDate == date(0,0,0)) or (temp_tar.UnbindDate == " 1.01.0001") )
                        flag_do = false;
                     else 
                        flag_do = true;
                     end;
                  end;
               else 
                  flag_do = true;
               end;

               if (flag_do)
                  if ( (StrUpr(temp_tar.TariffPlan.RecordCode) == "БАЗОВЫЙ") and (AgreementDate < TarifSplitDate)  
                           and (temp_tar.BindDate < TarifSplitDate) and (temp_tar.UnbindDate > TarifSplitDate) )
                     TariffList.value(ai+1) = c_Tariff;
                     TariffList.value(ai+1).TariffId = c_IntegrSymId;
                     TariffList.value(ai+1).TariffId.ObjectId = NewTarifId;
                     TariffList.value(ai+1).TariffPlan = c_IntegrDictRec;
                     TariffList.value(ai+1).TariffPlan.RecordCode = NewTarif;
                     TariffList.value(ai+1).TariffKind = c_IntegrDictRec;
                     TariffList.value(ai+1).TariffKind.RecordCode = temp_tar.TariffKind.RecordCode;
                     TariffList.value(ai+1).IsIndividual = temp_tar.IsIndividual;
                     TariffList.value(ai+1).Comment = temp_tar.Comment;
                     TariffList.value(ai+1).BeginDate = temp_tar.BeginDate;
                     TariffList.value(ai+1).EndDate = temp_tar.EndDate;
                     TariffList.value(ai+1).BindDate = TarifSplitDate+1;
                     TariffList.value(ai+1).UnbindDate = temp_tar.UnbindDate;
                     TariffList.value(ai+1).IsHidden = temp_tar.IsHidden;

                     temp_tar.UnbindDate = TarifSplitDate;
                  end; 
               end;
            end;
            TariffList.value(ai) = temp_tar;
            temp_tar = null;

            aux_buff = aux_buff + 1;
         end;
      elif(ValType(aux_buff) == V_UNDEF)
         err_txt = string(InErrComPart, nametag_up+".TariffList");
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
      else
         err_txt = string(InErrNotObj, nametag_up+".TariffList");
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
      end;
      
   end;

   uInitPrime(IncomeData, _nametag_up, _PersonID);
end;

// Person
private class c_Person(IncomeData)
   var LastName         : String;   // Фамилия                                                     Да
   var FirstName        : String;   // Имя                                                         Да
   var MiddleName       : String;   // Отчество                                                    Нет
// 2021-01-15 Cherednicheno is521652 Изменился формат даты входящего сообщения
//   var BirthDate        : String;   // Дата рождения                                               Нет   "возможно: 00.00.ГГГГ / 00.ММ.ГГГГ / ДД.ММ.ГГГГ"
   var BirthDate        : date;     // Дата рождения                                               Нет   "возможно: 00.00.ГГГГ / 00.ММ.ГГГГ / ДД.ММ.ГГГГ"
   var BirthPlace       : String;   // Место рождения                                              Нет
   var FIOLat           : String;   // ФИО латиницей                                               Нет
   var PadegFIOdat      : String;   // ФИО клиента в дательном падеже                              Нет
   var PadegFIOrod      : String;   // ФИО клиента в родительном падеже                            Нет
   var INN              : String;   // ИНН                                                         Нет
   var SuspiciousPerson : String;   // Признак подозрительного клиента                             Нет
   var CategoryDiasoft  : String;   // Категория клиента относительно Диасофт                      Нет
   var RiskLevel        : String;   // Уровень риска                                               Нет
   var RiskReason       : String;   // Обоснование риска                                           Нет
   var RPDL             : String;   // Статус ПДЛ (РПДЛ)                                           Нет
   var PDLDLPMO         : String;   // Статус ПДЛ (ДЛПМО)                                          Нет
   var IPDL             : String;   // Статус ИПДЛ                                                 Нет
   var IPDLrodstv       : String;   // ИПДЛ (степень родства)                                      Нет
   var PDDateAgr        : date;     // Дата оформления согласия на обработку персональных данных   Нет
   var FinConsBrok      : String;   // Финансовый консультант                                      Нет
   var PoinSaleBrok     : String;   // Наименование точки продаж                                   Нет
   var NumberSecBrok    : String;   // Количество покупаемых бумаг                                 Нет
   var QualifiedInvestor: String;   // 707. Квалифицированный инвестор                             Нет
   var UNKg             : String;   // Уникальный номер клиента глобальный                         Нет
   var Consent          : String;   // Согласие на передачу сведений в БКИ                         Нет
   var Document         : String;   // Номер документа                                             Нет
   var DateVid          : date;     // Дата выдачи документа                                       Нет
   var OrgVid           : String;   // Орган, выдавший свидетельство                               Нет
   var IssueName        : String;   // Выдан                                                       Нет
   var KPP              : String;   // Код причины постановки на учет                              Нет
   var OGRN             : String;   // Основной государственный рег. номер                         Нет
   var NumberPFR        : String;   // Страховой номер ПФР                                         Нет
   var SMBusinesses     : String;   // Субъект малого и среднего предпринимат                      Нет
   var SubjectCode      : String;   // Код субъекта кредитной истории                              Нет
   var HeadFIO          : String;   // ФИО руководителя                                            Нет

   // справочники
   var TypePerson       ;     // Отношения с Банком                        Да   "Клиент / Нет"
   var TypeClient       ;     // Тип клиента                               Нет
   var Gender           ;     // Пол                                       Да   "Мужской / Женский"
   var TaxStatus        ;     // Код страны налогового резидентства        Да
   var FATCA            ;     // FATCA-статус Возможные значения Да/Нет    Да 
   var CRS              ;     // Статус клиента в целях CRS                Да 
   var RegionCode       ;     // КодРегиона                                Да
   var Entity           ;     // Субъект                                   Нет
   var Ownership        ;     // Форма собственности                       Нет
   var TypeDocument     ;     // Код документа                             Нет
   var KindOfEntrepreneur;    // Признак клиента - ИП                      Нет 
   
   // символьные 
   var PersonID         ;     // Идентификатор клиента в филиале        Да
   var SOFRId           ;     // ИД в СОФР                              Нет
   var CIFId            ;     // Идентификатор клиента в филиале        Нет

   // списки
   var ContactsList;                // Список контактов                             Нет
   var CredentialList;              // Список ДУЛ                                   Нет
   var CitizenshipList;             // Гражданство (список)                         Нет
   var AddressList;                 // Список адресов                               Нет
   var BenefInfo;                   // Сведения о бенифициарном владельце           Нет
   var CoupledSubjectList;          // Перечень связанных субъектов                 Нет
   var GVKList;                     // Группы взаимосвязанных клиентов              Нет
   var OKVEDList;                   // Список ОКВЭД                                 Нет
   var AgreementInfoList;           // Список договоров Брокерского обслуживания    Нет
   
   var mNumfilial = 1;  // по умолчанию - ГО
   var mNameFilial = "0000";

   var agreement_temp;

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)   
      var err_txt;
      var aux_buff;

      private var nametag_up = "SetPersonRequestMsg.SetPersonRequest.Person";
      
      LastName          = getValueFromProperty(IncomeData, "LastName"           , nametag_up, true);
      FirstName         = getValueFromProperty(IncomeData, "FirstName"          , nametag_up, true);
      MiddleName        = getValueFromProperty(IncomeData, "MiddleName"         , nametag_up);
      BirthDate         = getValueFromProperty(IncomeData, "BirthDate"          , nametag_up);
      BirthPlace        = getValueFromProperty(IncomeData, "BirthPlace"         , nametag_up);
      FIOLat            = getValueFromProperty(IncomeData, "FIOLat"             , nametag_up);
      PadegFIOdat       = getValueFromProperty(IncomeData, "PadegFIOdat"        , nametag_up);
      PadegFIOrod       = getValueFromProperty(IncomeData, "PadegFIOrod"        , nametag_up);
      INN               = getValueFromProperty(IncomeData, "INN"                , nametag_up);
      SuspiciousPerson  = getValueFromProperty(IncomeData, "SuspiciousPerson"   , nametag_up);
      CategoryDiasoft   = getValueFromProperty(IncomeData, "CategoryDiasoft"    , nametag_up);
      RiskLevel         = getValueFromProperty(IncomeData, "RiskLevel"          , nametag_up);
      RiskReason        = getValueFromProperty(IncomeData, "RiskReason"         , nametag_up);
      RPDL              = getValueFromProperty(IncomeData, "RPDL"               , nametag_up);
      PDLDLPMO          = getValueFromProperty(IncomeData, "PDLDLPMO"           , nametag_up);
      IPDL              = getValueFromProperty(IncomeData, "IPDL"               , nametag_up);
      IPDLrodstv        = getValueFromProperty(IncomeData, "IPDLrodstv"         , nametag_up);
      PDDateAgr         = getValueFromProperty(IncomeData, "PDDateAgr"          , nametag_up);
      FinConsBrok       = getValueFromProperty(IncomeData, "FinConsBrok"        , nametag_up);
      PoinSaleBrok      = getValueFromProperty(IncomeData, "PoinSaleBrok"       , nametag_up);
      //ListAcctsBrok     = getValueFromProperty(IncomeData, "ListAcctsBrok"      , nametag_up);
      // BIQ-7683 Гераськина Т.В. для списка ListAcctsBrok список БИКов счетов
      //BIC               = getValueFromProperty(IncomeData, "BIC"                , nametag_up);
      NumberSecBrok     = getValueFromProperty(IncomeData, "NumberSecBrok"      , nametag_up);
      QualifiedInvestor = getValueFromProperty(IncomeData, "QualifiedInvestor"  , nametag_up);
      UNKg              = getValueFromProperty(IncomeData, "UNKg"               , nametag_up);
      Consent           = getValueFromProperty(IncomeData, "Consent"            , nametag_up);
      Document          = getValueFromProperty(IncomeData, "Document"           , nametag_up);
      DateVid           = getValueFromProperty(IncomeData, "DateVid"            , nametag_up);
      OrgVid            = getValueFromProperty(IncomeData, "OrgVid"             , nametag_up);
      IssueName         = getValueFromProperty(IncomeData, "IssueName"          , nametag_up);
      KPP               = getValueFromProperty(IncomeData, "KPP"                , nametag_up);
      OGRN              = getValueFromProperty(IncomeData, "OGRN"               , nametag_up);
      NumberPFR         = getValueFromProperty(IncomeData, "NumberPFR"          , nametag_up);
      SMBusinesses      = getValueFromProperty(IncomeData, "SMBusinesses"       , nametag_up);
      SubjectCode       = getValueFromProperty(IncomeData, "SubjectCode"        , nametag_up);
      HeadFIO           = getValueFromProperty(IncomeData, "HeadFIO"            , nametag_up);
      
      TypePerson           = getDictionaryFromProperty(IncomeData, "TypePerson"           , nametag_up, true);
      TypeClient           = getDictionaryFromProperty(IncomeData, "TypeClient"           , nametag_up);
      Gender               = getDictionaryFromProperty(IncomeData, "Gender"               , nametag_up, true);
      TaxStatus            = getDictionaryFromProperty(IncomeData, "TaxStatus"            , nametag_up, true);
      FATCA                = getDictionaryFromProperty(IncomeData, "FATCA"                , nametag_up, true);
      CRS                  = getDictionaryFromProperty(IncomeData, "CRS"                  , nametag_up, true);
      RegionCode           = getDictionaryFromProperty(IncomeData, "RegionCode"           , nametag_up, true);
      Entity               = getDictionaryFromProperty(IncomeData, "Entity"               , nametag_up);
      Ownership            = getDictionaryFromProperty(IncomeData, "Ownership"            , nametag_up);
      TypeDocument         = getDictionaryFromProperty(IncomeData, "TypeDocument"         , nametag_up);
      KindOfEntrepreneur   = getDictionaryFromProperty(IncomeData, "KindOfEntrepreneur"   , nametag_up);

      PersonID    = getSymbolFromProperty(IncomeData, "PersonID" , nametag_up, true);
      SOFRId      = getSymbolFromProperty(IncomeData, "SOFRId"   , nametag_up);
      CIFId       = getSymbolFromProperty(IncomeData, "CIFId"    , nametag_up);
     
      // клиенты ДБО
      if (ValType(FinConsBrok) != V_UNDEF)
         if (FinConsBrok == "Сервер обработки сообщений")
            FinConsBrok = "ДБО";
         end;
      end;

      // проверка значения по спискам
      if(ValType(TypePerson.RecordCode) != V_UNDEF)
/*         if ( (StrUpr(TypePerson.RecordCode) == StrUpr("Клиент")) or (StrUpr(TypePerson.RecordCode) == StrUpr("Нет")) ) 
         else
            err_txt = string("Недопустимое значение "+nametag_up+".TypePerson.RecordCode =",TypePerson.RecordCode);
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
         end; */
      end;
      if(ValType(Gender.RecordCode) != V_UNDEF)
         if ( (StrUpr(Gender.RecordCode) == StrUpr("Мужской")) or (StrUpr(Gender.RecordCode) == StrUpr("Женский")) ) 
         else
            err_txt = string("Недопустимое значение "+nametag_up+".Gender.RecordCode =",Gender.RecordCode);
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
         end;
      end;
      
      aux_buff = uTryToGetPropS(IncomeData, "ContactsList");
      if(ValType(aux_buff) == V_GENOBJ)
         ContactsList = TArray;
         aux_buff = 0;
         while(IncomeData.ContactsList.size > aux_buff)
            ContactsList.value(ContactsList.size) = adp_Contact(IncomeData.ContactsList.value(aux_buff), nametag_up);
            aux_buff = aux_buff + 1;
         end;
      elif(ValType(aux_buff) == V_UNDEF)
      else
         err_txt = string(InErrNotObj, nametag_up+".ContactsList");
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
      end;  

      aux_buff = uTryToGetPropS(IncomeData, "CredentialList");
      if(ValType(aux_buff) == V_GENOBJ)
         CredentialList = TArray;
         aux_buff = 0;
         while(IncomeData.CredentialList.size > aux_buff)
            CredentialList.value(CredentialList.size) = adp_Credential(IncomeData.CredentialList.value(aux_buff));
            aux_buff = aux_buff + 1;
         end;
      elif(ValType(aux_buff) == V_UNDEF)
      else
         err_txt = string(InErrNotObj, nametag_up+".CredentialList");
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
      end;  
      
      aux_buff = uTryToGetPropS(IncomeData, "CitizenshipList");
      if(ValType(aux_buff) == V_GENOBJ)
         CitizenshipList = TArray;
         aux_buff = 0;
         while(IncomeData.CitizenshipList.size > aux_buff)
            CitizenshipList.value(CitizenshipList.size) = adp_Citizenship(IncomeData.CitizenshipList.value(aux_buff));
            aux_buff = aux_buff + 1;
         end;
      elif(ValType(aux_buff) == V_UNDEF)
      else
         err_txt = string(InErrNotObj, nametag_up+".CitizenshipList");
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
      end;  
      
      aux_buff = uTryToGetPropS(IncomeData, "AddressList");
      if(ValType(aux_buff) == V_GENOBJ)
         AddressList = TArray;
         aux_buff = 0;
         while(IncomeData.AddressList.size > aux_buff)
            AddressList.value(AddressList.size) = adp_Address(IncomeData.AddressList.value(aux_buff));
            aux_buff = aux_buff + 1;
         end;
      elif(ValType(aux_buff) == V_UNDEF)
      else
         err_txt = string(InErrNotObj, nametag_up+".AddressList");
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
      end;  
      
      aux_buff = uTryToGetPropS(IncomeData, "BenefInfo");
      if(ValType(aux_buff) == V_GENOBJ)
         BenefInfo = adp_BenefInfo(aux_buff);
      elif(ValType(aux_buff) == V_UNDEF)
      else
         err_txt = string(InErrNotObj, nametag_up+".BenefInfo");
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
      end;  
      
      aux_buff = uTryToGetPropS(IncomeData, "GVKList");
      if(ValType(aux_buff) == V_GENOBJ)
         GVKList = TArray;
         aux_buff = 0;
         while(IncomeData.GVKList.size > aux_buff)
            GVKList.value(GVKList.size) = adp_GVK(IncomeData.GVKList.value(aux_buff), nametag_up+".GVKList");
            aux_buff = aux_buff + 1;
         end;
      elif(ValType(aux_buff) == V_UNDEF)
      else
         err_txt = string(InErrNotObj, nametag_up+".GVKList");
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
      end;        

      aux_buff = uTryToGetPropS(IncomeData, "OKVEDList");
      if(ValType(aux_buff) == V_GENOBJ)
         OKVEDList = TArray;
         aux_buff = 0;
         while(IncomeData.OKVEDList.size > aux_buff)
            OKVEDList.value(OKVEDList.size) = adp_OKVED(IncomeData.OKVEDList.value(aux_buff), nametag_up+".OKVEDList");
            aux_buff = aux_buff + 1;
         end;
      elif(ValType(aux_buff) == V_UNDEF)
      else
         err_txt = string(InErrNotObj, nametag_up+".OKVEDList");
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
      end; 

      aux_buff = uTryToGetPropS(IncomeData, "CoupledSubjectList");
      if(ValType(aux_buff) == V_GENOBJ)
         CoupledSubjectList = TArray;
         aux_buff = 0;
         while(IncomeData.CoupledSubjectList.size > aux_buff)
            CoupledSubjectList.value(CoupledSubjectList.size) = adp_CoupledSubject(IncomeData.CoupledSubjectList.value(aux_buff), nametag_up+".CoupledSubjectList");
            aux_buff = aux_buff + 1;
         end;
      elif(ValType(aux_buff) == V_UNDEF)
      else
         err_txt = string(InErrNotObj, nametag_up+".CoupledSubjectList");
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
      end;  

      aux_buff = uTryToGetPropS(IncomeData, "AgreementInfoList");
      if(ValType(aux_buff) == V_GENOBJ)
         AgreementInfoList = TArray;
         aux_buff = 0;
         while(IncomeData.AgreementInfoList.size > aux_buff)
            agreement_temp = adp_AgreementInfo(IncomeData.AgreementInfoList.value(aux_buff), nametag_up+".AgreementInfoList", PersonID);
            if ( (ValType(agreement_temp) == V_GENOBJ) and (ValType(agreement_temp.AgreementNumber) != V_UNDEF) )
               AgreementInfoList.value(AgreementInfoList.size) = agreement_temp;
            end;
            aux_buff = aux_buff + 1;
         end;
         if (AgreementInfoList.size > 0)
            mNumfilial = GetNumFilialBy_AgreementNumber(AgreementInfoList.value(0).AgreementNumber, mNameFilial);
         end;
      elif(ValType(aux_buff) == V_UNDEF)
      else
         err_txt = string(InErrNotObj, nametag_up+".AgreementInfoList");
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
      end;  
      
   end; /* macro uInitPrime() */

   uInitPrime(IncomeData);
end;


// классы параметров для создания и обновления субъекта
private class c_PersonParm(p_req_data_obj)
   var UserID              : String;   // Операционист                           Да
   var RequestID           ;           // ИД запроса                             Да
   var FilialID            ;           // Код филиала                            Да
   var BranchID            ;           // Код подразделения                      Да
 
   var Person;                         // Данные клиента                         Да

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(p_req_data_obj)
      private var aux_buff;
      private var err_txt;
      private var nametag_up = "SetPersonRequestMsg.SetPersonRequest";

      UserID      = getValueFromProperty(p_req_data_obj, "UserID"    , nametag_up, true);
     
      RequestID   = getSymbolFromProperty(p_req_data_obj, "RequestID", nametag_up, true);
      FilialId    = getSymbolFromProperty(p_req_data_obj, "FilialId" , nametag_up, true);
      if (FilialId.ObjectID != "0000")
         err_txt = string("Филиал "+FilialId.ObjectID+" не подлежит обработке. Обрабатываются только клиенты ГО");
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
      end;

      BranchID    = getSymbolFromProperty(p_req_data_obj, "BranchID" , nametag_up, true);
      
      aux_buff = getValueFromProperty(p_req_data_obj, "Person", nametag_up, true);
      if(ValType(aux_buff) != V_UNDEF)
         if(ValType(aux_buff) == V_GENOBJ)
            Person = c_Person(aux_buff);
         else
            err_txt = string(InErrNotObj, "Person");
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
         end;
      end;
   end; /* macro uInitPrime() */

   uInitPrime(p_req_data_obj);      
end;


// Найти, существует ли такой счет 
private macro FindAcc(currency, accnumber, accrec)
   var accfile = TBFile("account.dbt", "r", 0);

   accfile.rec.chapter = 1;
   accfile.rec.account = accnumber;
   accfile.rec.code_currency = currency;

   if (accfile.getEQ())
     copy(accrec, accfile);
   else
     accrec.rec.account = accnumber;
     accrec.rec.code_currency = currency;
   end;
end;


private macro FindOpenAccount(_accnum, _partyid)
   var curr = substr(_accnum,6,3);
   var accrec = TRecHandler("account.dbt");
   var stat, err_txt;
   record fininstr(fininstr);
   record account ("account.dbt");
   record accblnc ("accblnc.dbt");

//shev поломалась функция, рубли всегда возвращает, поменял на запрос   
// ПолучитьФинИнПоISO (curr, fininstr);

   fininstr.fiid = GetFiidFromCodeISO(1,curr);

   // поиск и заполнение структуры
   FindAcc(fininstr.fiid, _accnum, accrec);
   if (accrec.rec.accountid > 0) // счет есть
   else
      clearrecord (account);
      clearrecord (accblnc);
   
      account.Chapter = 1;
      account.Account = _accnum;
      account.Code_Currency = fininstr.fiid;
      account.Balance = substr(_accnum,1,5);
      account.Kind_account = "П";
      account.Type_account = "Ф";
      account.Oper = {oper};
      account.Client = _partyid;
      account.Open_Date = {curdate};
 
      account.Department = {OperDprt};
      account.Branch = {OperDprt};

      accblnc.Chapter = account.chapter;
      accblnc.account = account.account;
      accblnc.Code_Currency = account.Code_Currency;
      accblnc.Balance0 = account.balance;
      stat=Create_Account (account, accblnc);
      if (stat!=0)
         err_txt = "Ошибка открытия счета: "+GetErrMessage(stat);
         RunError(err_txt, c_err_obj(err_txt, stat));
      end;
   end;
   
end;

private macro GetBICbyAcc(_num_acc)
  var sql_str, rs, cmd;
  var BIC = "";
  var f_code = substr(_num_acc, 10, 2) + "00";

  sql_str =   " select NVL((select obj.t_code from dobjcode_dbt obj where obj.t_objecttype = 3 and obj.t_codekind = 3 and obj.t_objectid = dep.t_partyid and obj.t_state = 0), CHR(1)) as ACC_BankCode "
            + "   from ddp_dep_dbt dep "
            + "  where dep.t_name = ? ";

  cmd = RSDCommand(sql_str);
  cmd.AddParam("partyid", RSDBP_IN, f_code);
  rs = RSDRecordSet(cmd);
  if (rs.movenext)
    BIC = rs.value("ACC_BankCode");
  end;

  return BIC;
end;

// BIQ-7683 Гераськина Т.В. для списка ListAcctsBrok список БИКов счетов
private macro GetSetAcc(_num_acc, _BIC, _bankCodeKind, _partyid);
   var sql_str, rs, cmd;
   record fininstr(fininstr);
   var ISO_Number = "";
   var BIC = _BIC;

   var SetAcc_temp;
   var numfil_agreement,pos;
   var _NumAgreement;

   SetAcc_temp = TWsSettAcc;
   SetAcc_temp.Chapter = 1;
   SetAcc_temp.FICOde = substr(_num_acc, 6, 3);
   SetAcc_temp.Account = _num_acc;

   ISO_Number = SetAcc_temp.FICOde;
   if(ISO_Number == "810")
     ISO_Number = "643";
   end;

   ПолучитьФинИнПоISO(SetAcc_temp.FICOde, fininstr);

   sql_str = "select t_settaccid, t_order from dsettacc_dbt "+
             " where t_partyid = :partyid and t_account = :account and t_chapter = :chapter and t_fiid = :fiid";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("partyid", RSDBP_IN, _partyid);
   cmd.AddParam("account", RSDBP_IN, _num_acc);
   cmd.AddParam("chapter", RSDBP_IN, SetAcc_temp.Chapter);
   cmd.AddParam("fiid"   , RSDBP_IN, fininstr.FIID);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      SetAcc_temp.Order = rs.value("t_order");
      SetAcc_temp.Action = "MODIFY";
   else
      SetAcc_temp.Order = 0;
      SetAcc_temp.Action = "ADD";
   end;

   // BIQ-7683 Гераськина Т.В. для списка ListAcctsBrok список БИКов счетов
/*   if (not _Namefilial)
      SetAcc_temp.BankCode = GetBankCode(1, SetAcc_temp.BankCodeKind);
   else
      SetAcc_temp.BankCode = GetBankCode(_Namefilial, SetAcc_temp.BankCodeKind);
   end;*/

   if(not BIC)
     BIC = GetBICbyAcc(_num_acc);
   end;

   SetAcc_temp.BankCode = BIC;
   SetAcc_temp.BankCodeKind = _bankCodeKind;

   SetAcc_temp.ShortName = "Доход ЦБ";
   
   return SetAcc_temp;
end;

private class c_trade_platform(IncomeData)
   var NameTrade;
   var Curr = TArray;
   
   private macro uInitPrime(IncomeData)
      var temp_str, pos1, pos2, ttt;
      pos1 = Index(IncomeData,"(");
      pos2 = Index(IncomeData,")");
      temp_str = IncomeData;
            
      if ( (pos1 > 0) and (pos2 > 0) ) // название площадки
         NameTrade = Substr(IncomeData,1,pos1-1);
         temp_str = Substr(IncomeData,pos1+1,pos2-pos1-1);
         pos1 = Index(temp_str,",");
      end;
      while (pos1 > 0)
         ttt = Substr(temp_str,1,pos1-1);
         Curr.value(Curr.size) = ttt;
         temp_str = Substr(temp_str,pos1+1);
         pos1 = Index(temp_str,",");
      end;
      if ( StrLen(temp_str) > 0 )
         Curr.value(Curr.size) = temp_str;
      end;
   end;
   uInitPrime(IncomeData);
end;

private class c_trade_Contract(IncomeData)
   var NumContract;
   var TradePlatform = TArray;
   
   private macro uInitPrime(IncomeData)
      var temp_str, pos, ttt;
      var delim = ";";
      
      temp_str = IncomeData;
      pos = Index(temp_str,delim);
      if (pos > 0) // номер договора
         NumContract = Substr(temp_str,1,pos-1);
         temp_str = Substr(temp_str,pos+1);
         pos = Index(temp_str,delim);
      end;
      while (pos > 0)
         ttt = Substr(temp_str,1,pos-1);
         TradePlatform.value(TradePlatform.size) = c_trade_platform(ttt);
         temp_str = Substr(temp_str,pos+1);
         pos = Index(temp_str,delim);
      end;
      if ( StrLen(temp_str) > 0 )
         TradePlatform.value(TradePlatform.size) = c_trade_platform(temp_str);
      end;
   end;
   uInitPrime(IncomeData);
end;

private macro GetCurrPartyCountry(p_PartyID)
   var sql_str, rs, cmd;
   var res = "";
   
   if(p_PartyID > 0)
     sql_str = "SELECT t_NRCountry "+
               " FROM dparty_dbt "+
               "WHERE t_PartyID = :p_partyid ";
     cmd = RSDCommand(sql_str);
     cmd.AddParam("p_partyid", RSDBP_IN, p_PartyID);
     rs = RSDRecordSet(cmd);
     if (rs.movenext)
        res = rs.value("t_NRCountry");
     end;
   end;
   
   return res;
end;

// данные, подготовленные для вставки/обновления
private class adp_Party(IncomeData, _partyid)
   var PersnParam /*: TWsPersn*/;    // Атрибуты физического лица 
   var InstParam  /*: TWsInst*/;     // Атрибуты юридического лица 
   var ClientParam /*: TArray*/;     // Атрибуты клиента по виду обслуживния
   var Codes /*: TArray*/;           // Атрибуты кодов субъекта 
   var Addresses/* : TArray*/;       // Список адресов субъекта экономики
   var Contacts /*: TArray*/;        // Список контактной информация субъекта экономики
   var PersnPapers /*: TArray*/;     // Список документов, удостоверяющих личность субъекта экономики
   var RegDocs /*: TArray*/;         // Список регистрационных документов субъекта экономики
   var PartyNotes /*: TArray*/;      // Список примечаний субъекта экономики
   var PersnNotes /*: TArray*/;      // Список примечаний субъекта - физического лица
   var SettAccs /*: TArray*/;        // СПИ субъекта (массив структур TWsSettAcc)
   var Codes_weak;

   var Names : TArray;           // Список наименований субъекта
   var Categories: TArray;       // Список категорий субъекта экономики
   var Employees: TArray;        // Список сотрудников организации

   var PartyCode; /*: TWsPartyCode*/  /* Код субъекта для поиска. */ 
   var Notes_weak;
   
   private var Code_temp : TWsPartyCode;  
   private var Name_temp, Category_temp, Contacts_temp, address_temp, paper_temp, note_temp, SetAcc_temp;  
   
   var aux_buff;
   var DUL;
   var stt, pos, temp_str, ttt;
   var code_value, num_filial;
   var pp;
   var MainChecked;
   var Structure_building, NumCopr_building;

   var GVK, OKVED;
   var email_contract;
   var v_IsSingle;
   var mAdr, address_temp_ni;

   var OKATO_gni;

   // BIQ-7683 Гераськина Т.В. для списка ListAcctsBrok список БИКов счетов
   var err_txt;
   var AccBrok, BICBrok, ai, BankCodeKind;
   var IsInner;

   var code_vtb;
   
   // физик 
   PersnParam = TWsPersn;
   InstParam = NULL;
      
   PersnParam.LastName = trim(IncomeData.Person.LastName);
   PersnParam.FirstName = trim(IncomeData.Person.FirstName);
   PersnParam.Patronymic = trim(IncomeData.Person.MiddleName);
      
   if (ValType(IncomeData.Person.TaxStatus) != V_UNDEF)
      if(GetCurrPartyCountry(_partyid) != StrUpr(IncomeData.Person.TaxStatus.RecordCode))
        if (StrUpr(IncomeData.Person.TaxStatus.RecordCode) == "RUS")
           PersnParam.IsNotResident = false;
        else
           PersnParam.IsNotResident = true;
        end;
        PersnParam.NRCountry  = StrUpr(IncomeData.Person.CitizenShipList[0].CitiZenShipCode.RecordCode);  
        //shev      PersnParam.NRCountry  = StrUpr(IncomeData.Person.TaxStatus.RecordCode);  //Справочник ?
      end;
   end;

// 2021-01-15 Cherednicheno is521652 Изменился формат даты входящего сообщения
//   PersnParam.BirthDate = date(IncomeData.Person.BirthDate);  //????
   PersnParam.BirthDate = IncomeData.Person.BirthDate;  //????
   PersnParam.BirthPlace = IncomeData.Person.BirthPlace;
   PersnParam.PlaceWork = NULL;
   if (ValType(IncomeData.Person.Gender) != V_UNDEF)
      if (StrUpr(IncomeData.Person.Gender.RecordCode) == StrUpr("Мужской"))
         PersnParam.Male = 1;
      end;
   end;
   
   if (ValType(IncomeData.Person.KindOfEntrepreneur) != V_UNDEF)
      if ( (IncomeData.Person.KindOfEntrepreneur == "Предпр") or  (IncomeData.Person.KindOfEntrepreneur == "Пред_юр") )
         PersnParam.IsEmployer = true;
      end;
   end;
   
   // коды субъекта
   Codes = TArray;

   if (ValType(IncomeData.Person.INN) != V_UNDEF)
      Code_temp = TWsPartyCode;
      Code_temp.CodeKind = PTCK_INN;
      Code_temp.Code = IncomeData.Person.INN;
      if (ValType(IncomeData.Person.KPP) != V_UNDEF)
         Code_temp.Code = Code_temp.Code + "/" + IncomeData.Person.KPP;
      end;
      Codes.value(Codes.size) = Code_temp;

      pp = GetPartyID_byPartyCode(PTCK_MNS, substr(IncomeData.Person.INN,1,4));
      if (pp > 0)
         PersnParam.TaxInstitution = pp;
      end;

   end;
   
   /* SOFRId - это partyid
   if (ValType(IncomeData.Person.SOFRId) != V_UNDEF)
      Code_temp = TWsPartyCode;
      Code_temp.CodeKind = PTCK_CONTR;
      Code_temp.Code = IncomeData.Person.SOFRId.ObjectID;
      Codes.value(Codes.size) = Code_temp;
   end;*/
  
   // код Бисквит
   if (ValType(IncomeData.Person.PersonID) != V_UNDEF)
      Code_temp = TWsPartyCode;
      Code_temp.CodeKind = PARTY_CODEKIND_ABS;
      
/*      if (ValType(IncomeData.FilialId) != V_UNDEF)
         num_filial = IncomeData.FilialId.ObjectId;
      else
         num_filial = "0000";
      end; */
      num_filial = "0000";
// 2021-01-13 Cherednichenko Код ЦФТ без префикса Бисквита
//      Code_temp.Code = MakeCodeABS(IncomeData.Person.PersonID.ObjectID, num_filial, 3);
      Code_temp.Code = IncomeData.Person.PersonID.ObjectID;
      Codes.value(Codes.size) = Code_temp;
      
      // если указан код ЦФТ, значит, это и код 1 тоже
      // code_value = IncomeData.Person.PersonID.ObjectID;
      code_value = Code_temp.Code; // совпадает с кодом PARTY_CODEKIND_ABS
   else
      // если не указан - последовательность
      if (GenerateReference( UREFERENCE_PARTY_CODE, code_value ) != 0)
         code_value = StrFor(1);
      end;
   end;

   Code_temp = TWsPartyCode;
   Code_temp.CodeKind = PTCK_CONTR;
   Code_temp.Code = code_value;
   Codes.value(Codes.size) = Code_temp;

   /* код CIF не сохраняем
   if (ValType(IncomeData.Person.CIFId) != V_UNDEF)   
      Code_temp = TWsPartyCode;
      Code_temp.CodeKind = PARTY_CODEKIND_CIF;
      Code_temp.Code = IncomeData.Person.CIFId.ObjectId;
      Codes.value(Codes.size) = Code_temp;
   end; */
   
   if (ValType(IncomeData.Person.OGRN) != V_UNDEF)
      Code_temp = TWsPartyCode;
      Code_temp.CodeKind = 27;
// 2020-10-31 Cherednichenko is 518118 Физ.лицу пришел ОГРН, по ТКС решено исправить присваивание, а не убирать его
//      Code_temp.Code = IncomeData.OGRN;
      Code_temp.Code = IncomeData.Person.OGRN;
      Codes.value(Codes.size) = Code_temp;
   end;
   
   Codes_weak = TArray;
   // СНИЛС
   if (ValType(IncomeData.Person.NumberPFR) != V_UNDEF)
      Code_temp = TWsPartyCode;
      Code_temp.CodeKind = PARTY_CODEKIND_SNILS;
      Code_temp.Code = IncomeData.Person.NumberPFR;
      Codes_weak.value(Codes_weak.size) = Code_temp;
   end;

   //Код ВТБ
   code_vtb = FindCodeMatch(code_value);
   if (code_vtb != "-1")
      Code_temp = TWsPartyCode;
      Code_temp.CodeKind = PARTY_CODEKIND_VTB;
      Code_temp.Code = code_vtb;
      Codes_weak.value(Codes_weak.size) = Code_temp;
   end;
   
   // наименования
   Names = TArray;

   if (ValType(IncomeData.Person.FIOLat) != V_UNDEF)
      Name_temp = adp_Names;
      Name_temp.PartyNameID = 3;    // полное наименование латиницей
      Name_temp.Name = IncomeData.Person.FIOLat;
      Names.value(Names.size) = Name_temp;
   end;
   
   // категории
   Categories = TArray;
   
   // Признак подозрительного клиента
   if (ValType(IncomeData.Person.SuspiciousPerson) != V_UNDEF)
      Category_temp = adp_Categories;
      Category_temp.GroupID = 54;
      if (StrUpr(IncomeData.Person.SuspiciousPerson) == "ДА")
         Category_temp.Value = 1;
      else
         Category_temp.Value = 2;
      end;
      Category_temp.IsSingle = GetSingleSign(OBJTYPE_PARTY, Category_temp.GroupID);
      Categories.value(Categories.size) = Category_temp;
   end;   
   
   // FATCA
   if (ValType(IncomeData.Person.FATCA) != V_UNDEF)
      Category_temp = adp_Categories;
      Category_temp.GroupID = 108;
      if (StrUpr(IncomeData.Person.FATCA.RecordCode) == "ДА")
         Category_temp.Value = 1;
      else
         Category_temp.Value = 2;
      end;
      Category_temp.IsSingle = GetSingleSign(OBJTYPE_PARTY, Category_temp.GroupID);
      Categories.value(Categories.size) = Category_temp;  
   end;
   
   // CRS
   if (ValType(IncomeData.Person.CRS) != V_UNDEF)
      Category_temp = adp_Categories;
      Category_temp.GroupID = 109;
      if (StrUpr(IncomeData.Person.CRS.RecordCode) == "ДА")
         Category_temp.Value = 1;
      else
         Category_temp.Value = 2;
      end;
      Category_temp.IsSingle = GetSingleSign(OBJTYPE_PARTY, Category_temp.GroupID);
      Categories.value(Categories.size) = Category_temp;   
   end;
   
   // Субъект малого и среднего предпринимательства
   if (ValType(IncomeData.Person.SMBusinesses) != V_UNDEF)
      Category_temp = adp_Categories;
      Category_temp.GroupID = 39;
      Category_temp.Value = IncomeData.Person.SMBusinesses;
      Category_temp.IsSingle = GetSingleSign(OBJTYPE_PARTY, Category_temp.GroupID);
      Categories.value(Categories.size) = Category_temp;
   end;
   
   // Код ОКФС
   if (ValType(IncomeData.Person.Ownership) != V_UNDEF)
      Category_temp = adp_Categories;
      Category_temp.GroupID = 27;
      Category_temp.Value = IncomeData.Person.Ownership.RecordCode;
      Category_temp.IsSingle = GetSingleSign(OBJTYPE_PARTY, Category_temp.GroupID);
      Categories.value(Categories.size) = Category_temp;
   end;
         
   // Группа взаимосвязанных субъектов
   if (ValType(IncomeData.Person.GVKList) != V_UNDEF)
      v_IsSingle = GetSingleSign(OBJTYPE_PARTY, 20);
      for (GVK, IncomeData.Person.GVKList)
         Category_temp = adp_Categories;
         Category_temp.GroupID = 20;
         Category_temp.Value = GVK.GVKCode.RecordCode;
         Category_temp.IsSingle = v_IsSingle;
         Categories.value(Categories.size) = Category_temp;
      end;
   end;
         
   // ОКВЭД
   if (ValType(IncomeData.Person.OKVEDList) != V_UNDEF)
      v_IsSingle = GetSingleSign(OBJTYPE_PARTY, 17);
      for (OKVED, IncomeData.Person.OKVEDList)
         Category_temp = adp_Categories;
         Category_temp.GroupID = 17;
         Category_temp.Value = OKVED.OKVEDCode.RecordCode;
         Category_temp.IsSingle = v_IsSingle;
         Categories.value(Categories.size) = Category_temp;
      end;
   end;
   
   // ДУЛ
   aux_buff = ValType(IncomeData.Person.CredentialList);  // тип элемента 
   if(aux_buff == V_GENOBJ)
      PersnPapers = TArray;
      MainChecked = false;
      aux_buff = 0;
      while(IncomeData.Person.CredentialList.size > aux_buff)
/*         if (StrUpr(IncomeData.Person.CredentialList.value(aux_buff).mDocTypeCode) == "91" )
            Codes_weak = TArray;
            Code_temp = TWsPartyCode;
            Code_temp.CodeKind = PARTY_CODEKIND_SNILS;
            Code_temp.Code = IncomeData.Person.CredentialList.value(aux_buff).DocNumber;
            Codes_weak.value(Codes_weak.size) = Code_temp;
         else*/
            paper_temp = TWsPaper;
            paper_temp.Kind = IncomeData.Person.CredentialList.value(aux_buff).mDocTypeCode;
//def-54394 
            if(valtype(_partyid) != V_UNDEF)
               if(CheckDocNumberWithoutSpace(_partyid,IncomeData.Person.CredentialList.value(aux_buff).DocSeries,IncomeData.Person.CredentialList.value(aux_buff).DocNumber) == true)                   
                  paper_temp.Series = GetDocNumber(_partyid, true,false);
                  paper_temp.Number = GetDocNumber(_partyid, false,true);
               else
                  paper_temp.Series = IncomeData.Person.CredentialList.value(aux_buff).DocSeries;
                  paper_temp.Number = IncomeData.Person.CredentialList.value(aux_buff).DocNumber;
               end;
            else
                paper_temp.Series = IncomeData.Person.CredentialList.value(aux_buff).DocSeries;
                paper_temp.Number = IncomeData.Person.CredentialList.value(aux_buff).DocNumber;
            end;

            paper_temp.IssuedDate = IncomeData.Person.CredentialList.value(aux_buff).IssueDate;
            paper_temp.ValidToDate = IncomeData.Person.CredentialList.value(aux_buff).EndDate;
            paper_temp.Issuer = IncomeData.Person.CredentialList.value(aux_buff).IssuerName;
            paper_temp.IssuerCode = IncomeData.Person.CredentialList.value(aux_buff).IssuerCode;

            //    var CredentialID  ; // ИД ДУЛ в АБС                  Да
            // gtv: для документов без серии задаем пробел
            if (not paper_temp.Series)
               paper_temp.Series = " ";
            end;
            if ( (IncomeData.Person.CredentialList.value(aux_buff).mDocTypeCode == 21) and (not PersnParam.IsNotResident) ) // паспорт гражданина РФ
               paper_temp.IsMain = true;
               MainChecked = true;
            elif ( (IncomeData.Person.CredentialList.value(aux_buff).mDocTypeCode == 10) and (PersnParam.IsNotResident) ) // иностранный паспорт
               paper_temp.IsMain = true;
               MainChecked = true;
            end;
            PersnPapers.value(PersnPapers.size) = paper_temp;
         //end;
         aux_buff = aux_buff + 1;
      end;
      if (not MainChecked)
         PersnPapers.value(0).IsMain = true;
      end;
   end;
    
   // адреса
   aux_buff = ValType(IncomeData.Person.AddressList);  // тип элемента 
   if(aux_buff == V_GENOBJ)
      Addresses = TArray;
      aux_buff = 0;
      while(IncomeData.Person.AddressList.size > aux_buff)
         address_temp = TWsAdres;
         address_temp.Type = TArray;
         mAdr = IncomeData.Person.AddressList.value(aux_buff).mAddressType; 
         address_temp.Type.value(address_temp.Type.size) = mAdr;
         address_temp.Country = IncomeData.Person.AddressList.value(aux_buff).CountryCode.RecordCode;
         address_temp.PostIndex = IncomeData.Person.AddressList.value(aux_buff).PostCode;
         if (ValType(IncomeData.Person.AddressList.value(aux_buff).AddressRegionCode) != V_UNDEF)
            address_temp.Region = GetRegionCode(IncomeData.Person.AddressList.value(aux_buff).AddressRegionCode.RecordCode, address_temp.RegionNumber, address_temp.Okato);
            address_temp.CodeRegion = GetCodeAdmUnit(address_temp.Region, "REGION");
         end;
         //address_temp.Region = IncomeData.Person.AddressList.value(aux_buff).District;    // область
         
         if (Valtype(IncomeData.Person.AddressList.value(aux_buff).District) != V_UNDEF)
            address_temp.Province = IncomeData.Person.AddressList.value(aux_buff).District;  // район
            address_temp.CodeProvince = GetCodeAdmUnit(address_temp.Province, "PROVINCE");
         end;
         if (Valtype(IncomeData.Person.AddressList.value(aux_buff).Locality) != V_UNDEF)
            address_temp.Place = IncomeData.Person.AddressList.value(aux_buff).Locality;         // населенный пункт
            address_temp.CodePlace = GetCodeAdmUnit(address_temp.Place, "PLACE");
         end;
         if (Valtype(IncomeData.Person.AddressList.value(aux_buff).City) != V_UNDEF)
            address_temp.District = IncomeData.Person.AddressList.value(aux_buff).City;  // город
            address_temp.CodeDistrict = GetCodeAdmUnit(address_temp.District, "CITY");
         end;
         if (Valtype(IncomeData.Person.AddressList.value(aux_buff).Street) != V_UNDEF)
            address_temp.Street = IncomeData.Person.AddressList.value(aux_buff).Street;      // улица
            address_temp.CodeStreet = GetCodeAdmUnit(address_temp.Street, "STREET");
         end;
         address_temp.House = IncomeData.Person.AddressList.value(aux_buff).House;        // дом
         address_temp.NumCorps = IncomeData.Person.AddressList.value(aux_buff).Building;  // корпус
         address_temp.Flat = IncomeData.Person.AddressList.value(aux_buff).Apartment;     // квартира
         // строение
         if (ValType(IncomeData.Person.AddressList.value(aux_buff).Structure) != V_UNDEF)
            Structure_building = Trim(IncomeData.Person.AddressList.value(aux_buff).Structure);
            if (ValType(IncomeData.Person.AddressList.value(aux_buff).Building) == V_UNDEF)
               address_temp.NumCorps = IncomeData.Person.AddressList.value(aux_buff).Structure;
            else
               NumCopr_building = Trim(IncomeData.Person.AddressList.value(aux_buff).Building);
               address_temp.NumCorps = NumCopr_building + " стр " + Structure_building;
               if ( StrLen(address_temp.NumCorps) > 10 )
                  if ( StrLen(NumCopr_building) + StrLen(Structure_building) > 5) 
                     address_temp.NumCorps = NumCopr_building + " " + Structure_building;
                  end;
               end;
            end;
         end;

         if (ValType(address_temp.Adress) == V_UNDEF)
             address_temp.Adress = usr_GenResultAddressUser(address_temp);
         end;
         
         if (not PersnParam.TaxInstitution)
            if (ValType(IncomeData.Person.AddressList.value(aux_buff).RegionGNI) != V_UNDEF)
               pp = GetPartyID_byPartyCode(PTCK_MNS, IncomeData.Person.AddressList.value(aux_buff).RegionGNI.RecordCode+"00");
               if (pp > 0)
                  PersnParam.TaxInstitution = pp;
               end;
            end;
         end;

         //var AddressID     ;   // ИД адреса в АБС            Да
         //var HouseFiasGUID : String;   // Код ФИАС                   Нет
         
         Addresses.value(Addresses.size) = address_temp;
         aux_buff = aux_buff + 1;

         if (mAdr == 5)
            OKATO_gni = address_temp.Okato;

            address_temp_ni = TWsAdres;

            address_temp_ni.Type = TArray;
            address_temp_ni.Type.value(address_temp_ni.Type.size) = 4;
            address_temp_ni.Country = address_temp.Country;
            address_temp_ni.PostIndex = address_temp.PostIndex;
            address_temp_ni.Region = address_temp.Region;
            address_temp_ni.CodeRegion = address_temp.CodeRegion;
            address_temp_ni.RegionNumber = address_temp.RegionNumber;
            address_temp_ni.Okato = address_temp.Okato;
            address_temp_ni.Province = address_temp.Province;
            address_temp_ni.CodeProvince = address_temp.CodeProvince;
            address_temp_ni.Place = address_temp.Place;
            address_temp_ni.CodePlace = address_temp.CodePlace;
            address_temp_ni.District = address_temp.District;
            address_temp_ni.CodeDistrict = address_temp.CodeDistrict;
            address_temp_ni.Street = address_temp.Street;
            address_temp_ni.CodeStreet = address_temp.CodeStreet;
            address_temp_ni.House = address_temp.House;
            address_temp_ni.NumCorps = address_temp.NumCorps;
            address_temp_ni.Flat = address_temp.Flat;
            address_temp_ni.NumCorps = address_temp.NumCorps;
            address_temp_ni.Adress = address_temp.Adress;
                        
            Addresses.value(Addresses.size) = address_temp_ni;
         end;

      end;
   end;  

   // Код ОКАТО
   if (ValType(OKATO_gni) != V_UNDEF)
      Category_temp = adp_Categories;
      Category_temp.GroupID = 12;
      OKATO_gni = OKATO_gni+MkStr("0",11-StrLen(OKATO_gni));
      Category_temp.Value = OKATO_gni; 
      Category_temp.IsSingle = GetSingleSign(OBJTYPE_PARTY, Category_temp.GroupID);
      if(valtype(_partyid) == V_UNDEF) //DEF-68042 только для нового клиента ставим дату ОКАТО равную дате договора
        if (IncomeData.Person.AgreementInfoList != null) 
          if (IncomeData.Person.AgreementInfoList[0].AgreementDate != null)
            if  (IncomeData.Person.AgreementInfoList[0].AgreementDate < {curdate})
              Category_temp.Dt = IncomeData.Person.AgreementInfoList[0].AgreementDate; //берем дату первого договора
            end;  
          end;   
        end;
      end;
      Categories.value(Categories.size) = Category_temp;
   end;

   
   // контакты
   aux_buff = ValType(IncomeData.Person.ContactsList);  // тип элемента 
   if ( aux_buff == V_GENOBJ )
      Contacts = TArray;
      aux_buff = 0;
      while(IncomeData.Person.ContactsList.size > aux_buff)
         Contacts_temp = TWsContactInfo;
         if (IncomeData.Person.ContactsList.value(aux_buff).IsPrimary)
            //Contacts_temp.IsMain = true;
         end;
         Contacts_temp.AdresType = 1;  // юридический
         Contacts_temp.Value = IncomeData.Person.ContactsList.value(aux_buff).ContactCode;
         
         if ( StrUpr(IncomeData.Person.ContactsList.value(aux_buff).ContactType.RecordCode) == StrUpr("E-mail") )
            Contacts_temp.Kind = 5;       // адрес электронной почты
            email_contract = Contacts_temp.Value;
            Contacts_temp.Category = 8;  // gtv: для всех ставим "для отчетов"
/*            if ( StrUpr(IncomeData.Person.ContactsList.value(aux_buff).ContactProfile.RecordCode) == StrUpr("Рабочий") )
               Contacts_temp.Category = 1001;
            else
               Contacts_temp.Category = 0;
            end;*/
            if ( StrUpr(IncomeData.Person.ContactsList.value(aux_buff).ContactProfile.RecordCode) == StrUpr("БрокОбсл") )
               Contacts_temp.Category = 1005;
               email_contract = Contacts_temp.Value;
            end;

         elif ( StrUpr(IncomeData.Person.ContactsList.value(aux_buff).ContactType.RecordCode) == StrUpr("Телефон") )
            Contacts_temp.Kind = 1;       // телефон
            if ( StrUpr(IncomeData.Person.ContactsList.value(aux_buff).ContactProfile.RecordCode) == StrUpr("Рабочий") )
               Contacts_temp.Category = 2;
            elif ( StrUpr(IncomeData.Person.ContactsList.value(aux_buff).ContactProfile.RecordCode) == StrUpr("Мобильный") )
               Contacts_temp.Category = 1;
            elif ( StrUpr(IncomeData.Person.ContactsList.value(aux_buff).ContactProfile.RecordCode) == StrUpr("БрокОбсл") )
               Contacts_temp.Category = 1004;
            else
               Contacts_temp.Category = 3;
            end;
         end;
      
         Contacts.value(Contacts.size) = Contacts_temp;
         aux_buff = aux_buff + 1;
      end;
   end;

   if ( (ValType(IncomeData.Person.PadegFIOrod) != V_UNDEF) or (ValType(IncomeData.Person.PadegFIOdat) != V_UNDEF) 
        or (ValType(IncomeData.Person.RPDL) != V_UNDEF) or (ValType(IncomeData.Person.PDLDLPMO) != V_UNDEF) or (ValType(IncomeData.Person.IPDL) != V_UNDEF)
      )
      PersnNotes = TArray;
   
      if (ValType(IncomeData.Person.PadegFIOrod) != V_UNDEF)
         note_temp = TWsNote;
         note_temp.NoteKind = 49;
         note_temp.NoteText = IncomeData.Person.PadegFIOrod;
         note_temp.Date = {curdate};
         PersnNotes.value(PersnNotes.size) = note_temp;
      end;
      if (ValType(IncomeData.Person.PadegFIOdat) != V_UNDEF)
         note_temp = TWsNote;
         note_temp.NoteKind = 52;
         note_temp.NoteText = IncomeData.Person.PadegFIOdat;
         note_temp.Date = {curdate};
         PersnNotes.value(PersnNotes.size) = note_temp;
      end;
      if (ValType(IncomeData.Person.RPDL) != V_UNDEF)
         note_temp = TWsNote;
         note_temp.NoteKind = 75;
         note_temp.NoteText = IncomeData.Person.RPDL;
         note_temp.Date = {curdate};
         PersnNotes.value(PersnNotes.size) = note_temp;
      end;
      if (ValType(IncomeData.Person.PDLDLPMO) != V_UNDEF)
         note_temp = TWsNote;
         note_temp.NoteKind = 75;
         note_temp.NoteText = IncomeData.Person.PDLDLPMO;
         note_temp.Date = {curdate};
         PersnNotes.value(PersnNotes.size) = note_temp;
      end;
      if (ValType(IncomeData.Person.IPDL) != V_UNDEF)
         note_temp = TWsNote;
         note_temp.NoteKind = 75;
         note_temp.NoteText = IncomeData.Person.IPDL;
         note_temp.Date = {curdate};
         PersnNotes.value(PersnNotes.size) = note_temp;
      end;

      // дистрибутивно не заполняется
      Notes_weak = TArray(PersnNotes);
      PersnNotes = null;
      
   end;
   
   // Список текущих счетов
   // BIQ-7910 блок перенесен внутрь AgreementInfo
   AccBrok = TArray;
   BICBrok = TArray;
   var ai_acc = 0;
   var ai_bic = 0;
   var temp_agreement;
   
   if (ValType(IncomeData.Person.AgreementInfoList) == V_GENOBJ)
      for (temp_agreement, IncomeData.Person.AgreementInfoList)
         if ( (ValType(temp_agreement.ListAcctsBrok) != V_UNDEF) and (StrLen(Trim(temp_agreement.ListAcctsBrok)) > 0) )
            // массив брокерских счетов
            temp_str = temp_agreement.ListAcctsBrok;
            pos = Index(temp_str,",");
            while (pos > 0)
               ttt = Substr(temp_str,1,pos-1);
               AccBrok(ai_acc) = ttt;
               ai_acc = ai_acc+1;
               temp_str = Substr(temp_str,pos+1);
               pos = Index(temp_str,",");
            end;
            if ( StrLen(temp_str) > 0 ) // последний элемент
               AccBrok(ai_acc) = temp_str;
            end;   
            pos = 0;

            IsInner = false;
            // BIQ-7683 Гераськина Т.В. для списка ListAcctsBrok список БИКов счетов
            // проверим, что с тегом BIC
            // если передан единственный счет в  ListAcctsBrok, то тег может быть пустым
            if (AccBrok.size > 1)
               if ( (ValType(temp_agreement.BIC) == V_UNDEF) or (StrLen(Trim(temp_agreement.BIC)) == 0) )
                  //а если счетов несколько, а тег пустой - значит все счета относятся к филиалу договора БО
                  /*err_txt = "Передан список счетов, но не передан список БИКов";
                  RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));*/
                  IsInner = true;
               end;
            end;

            temp_str = temp_agreement.BIC;
            pos = Index(temp_str,",");
            while (pos > 0)
               ttt = Substr(temp_str,1,pos-1);
               BICBrok(ai_bic) = ttt;
               ai_bic = ai_bic+1;
               temp_str = Substr(temp_str,pos+1);
               pos = Index(temp_str,",");
            end;
            if ( StrLen(temp_str) > 0 ) // последний элемент может быть пустым
               BICBrok(ai_bic) = temp_str;
            else
               BICBrok(ai_bic) = "";
            end;
            pos = 0;
            
            if (IsInner) // для внутренних счетов проверки нет
            else
               if (AccBrok.size != BICBrok.size)
                  err_txt = "Количество счетов ListAcctsBrok и БИКов BIC не совпадает";
                  RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
               end;
            end;
        end;
      end;
   end;
   
   var settt;
   var wasacc = false;
   if (AccBrok.size > 0)
      SettAccs = TArray;
      ai = 0;

      while (ai < AccBrok.size)
         if (IsInner) //  внутренние счета
            BICBrok(ai) = IncomeData.Person.mNameFilial;  // если не указан, взять из филиала договора БО
            BICBrok(ai) = GetBankCode(BICBrok(ai), BankCodeKind); // значение БИКа
         else
            BankCodeKind = 3; // если указан, то считаем, что БИК
            if (not BICBrok(ai))
               BICBrok(ai) = GetBICbyAcc(AccBrok(ai));
            end;
         end;
         
         SetAcc_temp = GetSetAcc(AccBrok(ai), BICBrok(ai), BankCodeKind, _partyid);
         wasacc = false;
         for (settt, SettAccs)
            if (settt.Account == SetAcc_temp.Account)
               wasacc = true;
               break;
            end;
         end;
         if (not wasacc)
         SettAccs.value(SettAccs.size) = SetAcc_temp;
         end;
         ai = ai+1;
      end;
   else 
      AccBrok = null;
      BICBrok = null;
   end;
   
/*  ???
      FinConsBrok       = getValueFromProperty(IncomeData, "FinConsBrok"        , nametag_up);
      PoinSaleBrok      = getValueFromProperty(IncomeData, "PoinSaleBrok"       , nametag_up);
      QualifiedInvestor = getValueFromProperty(IncomeData, "QualifiedInvestor"  , nametag_up);
      UNKg              = getValueFromProperty(IncomeData, "UNKg"               , nametag_up);
      HeadFIO           = getValueFromProperty(IncomeData, "HeadFIO"            , nametag_up);
      TypePerson           = getDictionaryFromProperty(IncomeData, "TypePerson"           , nametag_up, true);
   var CitizenshipList;             // Гражданство (список)                         Нет
???  */

/*  не обрабатываем
      TypeClient           = getDictionaryFromProperty(IncomeData, "TypeClient"           , nametag_up);
      CategoryDiasoft   = getValueFromProperty(IncomeData, "CategoryDiasoft"    , nametag_up);
      IPDLrodstv        = getValueFromProperty(IncomeData, "IPDLrodstv"         , nametag_up);
      PDDateAgr         = getValueFromProperty(IncomeData, "PDDateAgr"          , nametag_up);
      BenefInfo = adp_BenefInfo(aux_buff);
      NumberSecBrok     = getValueFromProperty(IncomeData, "NumberSecBrok"      , nametag_up);
      Consent           = getValueFromProperty(IncomeData, "Consent"            , nametag_up);      
      Entity               = getDictionaryFromProperty(IncomeData, "Entity"               , nametag_up);      
      Document          = getValueFromProperty(IncomeData, "Document"           , nametag_up);
      DateVid           = getValueFromProperty(IncomeData, "DateVid"            , nametag_up);
      OrgVid            = getValueFromProperty(IncomeData, "OrgVid"             , nametag_up);
      IssueName         = getValueFromProperty(IncomeData, "IssueName"          , nametag_up);
      SubjectCode       = getValueFromProperty(IncomeData, "SubjectCode"        , nametag_up);
      TypeDocument         = getDictionaryFromProperty(IncomeData, "TypeDocument"         , nametag_up);
      RegionCode           = getDictionaryFromProperty(IncomeData, "RegionCode"           , nametag_up, true);
      */
 
end;


macro SetCodesWeak(p_PartyID, p_Codes_weak)
   var codes_parm;
   var sql_str, rs, cmd;
   var cnt;
   var objectid = -1, code_exist = "-1";
   var err_txt;
   
   for (codes_parm, p_Codes_weak)
      sql_str = "select t_objectid from dobjcode_dbt where t_objecttype = 3 and t_codekind = :codekind and t_code = :code and t_state = 0";
      cmd = RSDCommand(sql_str);
      cmd.AddParam("codekind", RSDBP_IN, codes_parm.CodeKind);
      cmd.AddParam("code", RSDBP_IN, codes_parm.code);
      rs = RSDRecordSet(cmd);
      if (rs.movenext)
         objectid = rs.value("t_objectid");
      end;
      cmd.close; rs.close; cmd = null; rs = null;
      
      if (objectid <= 0 )
         sql_str = "select t_code from dobjcode_dbt where t_objecttype = 3 and t_codekind = :codekind and t_objectid = :objectid and t_state = 0";
         cmd = RSDCommand(sql_str);
         cmd.AddParam("codekind", RSDBP_IN, codes_parm.CodeKind);
         cmd.AddParam("objectid", RSDBP_IN, p_PartyID);
         rs = RSDRecordSet(cmd);
         if (rs.movenext)
            code_exist = rs.value("t_code");
         end;
         cmd.close; rs.close; cmd = null; rs = null;
         if (code_exist == "-1")
            sql_str =   "Insert into DOBJCODE_DBT "+
                        "   (T_OBJECTTYPE, T_CODEKIND, T_OBJECTID, T_CODE, T_STATE, "+
                        "    T_BANKDATE, T_SYSDATE, T_SYSTIME, T_USERID, T_BRANCH, "+
                        "    T_NUMSESSION, T_UNIQUE, T_AUTOKEY, T_BANKCLOSEDATE, T_NORMCODE) "+
                        " Values "+
                        "   (3, :codekind, :objectid, :code, 0, "+
                        "    :bankdate, sysdate, sysdate, :oper, 1, "+
                        "    0, 'X', 0, TO_DATE('01/01/0001 00:00:00', 'MM/DD/YYYY HH24:MI:SS'), chr(1)) ";
            cmd = RSDCommand(sql_str);
            cmd.AddParam("codekind", RSDBP_IN, codes_parm.CodeKind);
            cmd.AddParam("objectid", RSDBP_IN, p_PartyID);
            cmd.AddParam("code", RSDBP_IN, codes_parm.code);
            cmd.AddParam("bankdate", RSDBP_IN, {curdate});
            cmd.AddParam("oper", RSDBP_IN, {oper});
            cmd.execute;
            cmd.close; cmd = null; 

         elif (code_exist != codes_parm.code)
            sql_str = "update dobjcode_dbt set t_code = :code, T_BANKDATE = :bankdate where t_objecttype = 3 and t_codekind = :codekind and t_objectid = :objectid";
            cmd = RSDCommand(sql_str);
            cmd.AddParam("code", RSDBP_IN, codes_parm.code);
            cmd.AddParam("bankdate", RSDBP_IN, {curdate});
            cmd.AddParam("codekind", RSDBP_IN, codes_parm.CodeKind);
            cmd.AddParam("objectid", RSDBP_IN, objectid);
            cmd.execute;
            cmd.close; cmd = null; 
         else
            // тот же код у того же субъекта
         end;
      else
         if (objectid != p_PartyID)
            err_txt = "Существует код "+codes_parm.CodeKind+": "+codes_parm.code+" у субъекта "+objectid;
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
         else
            // тот же код у того же субъекта
         end;
      end;
   end;
   
end;


// ручная установка примечаний
macro SetNotesWeak(p_PartyID, p_Notes_weak)
   var notes_parm;
   var notes;
   var ObjectType = OBJTYPE_PARTY;
   var ObjectId = string(p_PartyID:o:10);
   
   for (notes_parm, p_Notes_weak)
      notes = readNoteForObject( ObjectType, ObjectId, notes_parm.NoteKind);
      if ( (not notes) OR // пустое
           ( (notes) and (notes != notes_parm.NoteText) ) )
         addNoteForObject( ObjectType, ObjectId, notes_parm.NoteKind, notes_parm.NoteText, notes_parm.Date);
      end;
   end;

end;


// инициализация параметров единого договора
private macro InitDlContrPrm()
   var DlContrPrm = TRecHandler("dlcontrprm.rec");
   
   ClearRecord(DlContrPrm);
   DlContrPrm.rec.DLCONTRID = 0;             //Идентификатор. При создании нового ДБО, если больше нуля, то установить = 0
   DlContrPrm.rec.DEPARTMENT = {OperDprt};   //Филиал. Если 0, то ошибка "Филиал должен быть задан"
   //DlContrPrm.rec.NUMBER = "";             //Номер договора.  Если не заполнен, то при вставке выделится автоматически
   //DlContrPrm.rec.ACCCODE = "";                // Код в номере л/с. Если не заполнен, то при вставке выделится автоматически 
   //DlContrPrm.rec.NAME   = "";             //Название
   DlContrPrm.rec.DATEBEGIN = {curdate};     //Дата открытия. Если 01.01.0001, то ошибка "Не задана дата открытия ДБО"
   DlContrPrm.rec.PARTYID = 0;               //Клиент. Если <= 0, то ошибка "Не задан идентификатор клиента". Если > 0, то найти запись в DPARTY_DBT, где DPARTY_DBT.rec.T_PARTYID = переданному значению. Если не найдена, то ошибка "Субъект с заданным идентификатором не найден".
   //DlContrPrm.rec.MARKETCODE = "";             //Единый код на бирже. Если не заполнен, то при вставке выделится автоматически при необходимости
   //DlContrPrm.rec.PLANID = 0;              //Единый тарифный план. По умолчанию 0. Если не найдена, то ошибка "Указанный единый тарифный план не найден в списке тарифных планов".
   //DlContrPrm.rec.IIS = StrFor(0);             //Признак договора ИИС. Если задан, а клиент не является физлицом, то ошибка "Нельзя устанавливать признак договора ИИС для клиента не являющегося физ. лицом"
   //DlContrPrm.UNIDEPOCONTRID = 0;          //Идентификатор СДО депо. По умолчанию 0. Если не найдена, то ошибка "Не найден указанный сводный договор депозитарного обслуживания".
   //DlContrPrm.rec.INEXTDEPO = StrFor(0);       //Признак "Обслуживание в стороннем депозитарии"
   DlContrPrm.rec.USESUBACC = StrFor(0);       //Признак "Открывать субсчета для брокерских счетов"
   //DlContrPrm.rec.IISFIRSTDATE = date(0,0,0);  //Дата открытия первого ИИС для клиента. Если T_IIS не задан, то 01.01.0001
   //DlContrPrm.rec.IISFIRSTBROKERNAME = "";     //Наименование брокера, у которого был открыт первый ИИС клиента. Если T_IIS не задан, то очистить
   //DlContrPrm.rec.IISFIRSTNUMBER = "";         //Номер первого договора ИИС клиента. Если T_IIS не задан, то очистить
   //DlContrPrm.rec.IISTRANSFER = StrFor(0);     //Признак открытия ИИС с переводом от брокера. Если T_IIS не задан, то очистить
   //DlContrPrm.rec.IISLASTBROKERNAME = "";      //Наименование брокера, закрывающего ИИС клиента. Если T_IIS не задан, то очистить
   //DlContrPrm.rec.IISLASTNUMBER = "";          //Номер договора на ведение ИИС у брокера. Если T_IIS не задан, то очистить
   //DlContrPrm.rec.IISLASTOPENDATE = date(0,0,0);  //Дата открытия ИИС клиента у брокера. Если T_IIS не задан, то 01.01.0001
   //DlContrPrm.rec.IISLASTCLOSEDATE = date(0,0,0); //Дата закрытия ИИС клиента у брокера. Если T_IIS не задан, то 01.01.0001
   //DlContrPrm.rec.IISLASTYEAR = 0;             //Налоговый период, в котором произошло закрытие договора ИИС у брокера. Если T_IIS не задан, то 0
   //DlContrPrm.rec.IISLASTINSUM = 0;            //Сумма внесенных на ИИС денежных средств с начала налогового периода. Если T_IIS не задан, то 0
   //DlContrPrm.rec.ISSLASTOUTSUM = 0;           //Сумма изъятых с ИИС денежных средств с начала налогового периода. Если T_IIS не задан, то 0
   //DlContrPrm.rec.IISBENEFITDEP = null;        //Признак потери клиентом налоговых льгот по ИИС. Если T_IIS не задан, то очистить
   //DlContrPrm.rec.IISENROLBAN = null;          //Признак запрета зачисления денежных средств на ИИС. Если T_IIS не задан, то очистить
   //DlContrPrm.rec.REPMETHOD = 2;           //Способ получения отчетов. Если не задан, то 1 /*Дополнительные офисы*/ Если не найдена, то ошибка "Указан неизвестный способ получения отчетов"
   //DlContrPrm.rec.EMAIL = "1@test.com";    //Электронный адрес рассылки. Не обяз.
   //DlContrPrm.rec.REPOOVERNIGHT = StrFor(0);   //Признак согласия клиента на РЕПО овернайт
   //DlContrPrm.rec.LEVERAGE = 0;                //Плечо
   //DlContrPrm.rec.NOTPAYBRKACC = StrFor(0);    //Признак запрета выплат на брокерский счета
   //DlContrPrm.rec.RETURNTAX = StrFor(0);       //Признак согласия клиента на возврат излишне удержанного налога
   //DlContrPrm.rec.USEQUIK = StrFor(0);         //Признак использования клиентом приложения "Quik-брокер".
   //DlContrPrm.rec.IISDEDFINRES = StrFor(0);    //Предоставлять вычет по финансовому результату. Если T_IIS не задан, то очистить
   return DlContrPrm;
end;

// инициализация площадки
private macro InitDlContrMp()
   var DlContrMp = TRecHandler("dlcontrsubprm.rec");
   ClearRecord(DlContrMp);
   
   DlContrMp.rec.SERVKIND   = 0;    //Вид обслуживания
   DlContrMp.rec.SUBKIND    = 0;    //Подвид площадки
   DlContrMp.rec.ROLE       = 1;     //Роль ПУРЦБ
   //DlContrMp.rec.MPCODE     = 4;   //Краткий код клиента, данный при регистрации на торговой площадке биржи
   //DlContrMp.rec.MPREGDATE  = {curdate};   //Дата регистрации клиента на площадке
   //DlContrMp.rec.MPCLOSEDATE =	01.01.0001  //Дата прекращения обслуживания клиента на площадке
   DlContrMp.rec.NUMBER     = "";  //Номер субдоговора
   //DlContrMp.rec.ACCCODE    = ; //Код в номере счета
   DlContrMp.rec.NAME       = ""; //Название
   DlContrMp.rec.DATECONC   = {curdate};  //Дата заключения
   DlContrMp.rec.DATEBEGIN  = {curdate};  //Дата начала
   //DlContrMp.rec.DATEPROLONG =	01.01.0001  //Дата пролонгации
   //DlContrMp.rec.DATECLOSE  =	01.01.0001  //Дата закрытия
   DlContrMp.rec.SFPLANID   = 0;  //Идентификатор тарифного плана
   DlContrMp.rec.MarketID   = 0; // идентификатор биржи. Обязателен к заполнению для биржевой площадки.
   DlContrMp.rec.firmid     = ""; // Код фирмы/участника торгов

   return DlContrMp;
end;


// наименование длинное или короткое
private macro GetPartyName(_partyid, _isshort)
   var res = NULL;
   var sql_str, cmd, rs;
   sql_str = " select t_shortname, t_name "+
             " from dparty_dbt where t_partyid = :partyid";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("partyid", RSDBP_IN, _partyid);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      if (_isshort)
         res = rs.value("t_shortname");
      else
         res = rs.value("t_name");
      end;
   end;
   rs.close; cmd.close; rs = NULL; cmd = NULL;
   return res;
end;


// проверка удостоверений
private macro  CheckEqualPersnPapers(_PersnPapers, _PartyID)
   var sql_str, cmd,  rs;
   var papers_exist = TArray;
   var paper_temp;
   var pp;
   var cnt_equal = 0;
   var res = false;

   sql_str = "select ( select t_codedocum from dpaprkind_dbt k where k.t_paperkind = p.t_paperkind) t_paperkind, "+
             "       t_paperseries, t_papernumber, t_paperissueddate,"+
             "       t_paperissuer, t_paperissuercode, t_ismain, t_validtodate "+
             "  from dpersnidc_dbt p where t_personid = :personid";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("personid", RSDBP_IN, _PartyID);
   rs = RSDRecordSet(cmd);
   papers_exist.size = 0;
   while (rs.movenext)
      paper_temp = TWsPaper;
      paper_temp.Kind = rs.value("t_paperkind");
      paper_temp.Series = rs.value("t_paperseries");
      paper_temp.Number = rs.value("t_papernumber");
      paper_temp.IssuedDate = rs.value("t_paperissueddate");
      paper_temp.ValidToDate = rs.value("t_validtodate");
      paper_temp.Issuer = rs.value("t_paperissuer");
      paper_temp.IssuerCode = rs.value("t_paperissuercode");
      if (rs.value("t_ismain") == "X")
         paper_temp.IsMain = true;
      else
         paper_temp.IsMain = false;
      end;
      papers_exist.value(papers_exist.size) = paper_temp;
   end;
    rs.close; cmd.close; rs = null; cmd = null;
   paper_temp = null;

   if ( (papers_exist.size > 0) and (papers_exist.size == _PersnPapers.size) )
      for (pp, _PersnPapers) // пришедшие в XML
         for (paper_temp, papers_exist) // существующие
            if ( (pp.Kind == paper_temp.Kind) and
                 (pp.Series == paper_temp.Series) and
                 (pp.Number == paper_temp.Number) and
                 (pp.IssuedDate == paper_temp.IssuedDate) and
                 //(pp.ValidToDate == paper_temp.ValidToDate) and
                 (pp.Issuer == paper_temp.Issuer) and
                 (pp.IssuerCode == paper_temp.IssuerCode) and
                 (pp.IsMain == paper_temp.IsMain) 
                  )        
                cnt_equal = cnt_equal+1;
            end;
         end;
      end;
      if (cnt_equal == papers_exist.size)
         res = true;
      end;
   end;
   return res;
end;


   
/* BIQ-7785 процедуры вынесены в dlcontrfunc.mac
// Привязка счета к субдоговору
private macro AddAccToSubContr(category, contractid, accrec, errstr)
end;

// Открыть счет для субдоговора 
private macro usrIntgr_ОткрытьСубсчетДляСубдоговора(category:string, SubContrID:integer, Currency:integer, AccAddr, ErrStr, _dateED, inConditionDate, NewSubContractIDs)
end;

// Открыть и привязать счет к договору
private macro OpenAccAndBindToContract(category, contractid, currency, accnumber, error, _dateED, inConditionDate, NewSubContractIDs):integer
   end;

*/

private class c_acc_foropen
   var account,
       currency,
       category;
end;


macro FindOpenAccBefore(_acc_foropen)
   var acc;
   var res = null;
   for (acc, g_accrec_arr)
      if ( (acc.currency == _acc_foropen.currency)
           and 
           (acc.category == _acc_foropen.category) )
         res = acc;
      end;
   end;
   return res;
end;

private macro OpenAccountByCategory(_categ, _sub_id, _servsubkind, _flag_edp, _accrec)
   var accrec_temp, accrec_found;
   var acc = TRecHandler("account.dbt");
   private var stat, err_txt;

   //DEF-70512 необходима проверка, существует ли счет в mcaccdoc, даже если СПИ не найдена
   var sql_str, cmd, rs;
   var acc_exist = "-";
   sql_str = String("select t_account from dmcaccdoc_dbt mcacc, dmccateg_dbt mc \n",
                    " where mc.t_id = mcacc.t_catid and mc.t_code = :catcode \n",
                    "   and mcacc.t_clientcontrid = :contrid and mcacc.t_currency = :codecur \n",
                    "   and mcacc.t_isusable = 'X' ");
   cmd = RSDCommand(sql_str);
   cmd.AddParam("catcode", RSDBP_IN, _categ);
   cmd.AddParam("contrid", RSDBP_IN, _sub_id);
   cmd.AddParam("codecur", RSDBP_IN, _accrec.rec.code_currency);
   rs = RSDRecordSet(cmd);
   if (rs.movenext())
      acc_exist = rs.value("t_account");
   end;

   if (acc_exist != "-") // счет по КУ уже существует и активный, нужно создать СПИ
      if (_categ == CATEG_SUBCONTRACT)
         //привязка счета к договору
         ClearRecord(acc);
         FindAcc(_accrec.rec.code_currency, acc_exist, acc);
         stat = AddAccToSubContr(_categ, _sub_id, acc, err_txt);   
         if (stat != 0)
            RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
         end;
      end;
   else

      ClearRecord(acc);
      Copy(acc,_accrec);

      if (_flag_edp and (_servsubkind == SERV_SUBKIND_STOCK))
         accrec_temp = c_acc_foropen();
         accrec_temp.currency = _accrec.rec.code_currency;
         accrec_temp.category = _categ;
         accrec_found = FindOpenAccBefore(accrec_temp);
         if (ValType(accrec_found) != V_UNDEF)
            acc.rec.account = accrec_found.account; 
         end;
         accrec_temp = null;
      end;
      stat = OpenAccAndBindToContract(_categ, _sub_id, acc, err_txt);
      if(stat != 0)
         RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
      end;
      if (_flag_edp and (_servsubkind == SERV_SUBKIND_STOCK) and (ValType(accrec_found) == V_UNDEF) ) // новый счет
         accrec_found = c_acc_foropen();
         accrec_found.currency = acc.rec.code_currency;
         accrec_found.account = acc.rec.account;
         accrec_found.category = _categ;
         g_accrec_arr.value(g_accrec_arr.size) = accrec_found;
      end;
   end;

end;

private macro OpenAllAccounts(_sub_id, _accrec, inConditionDate, NewSubContractIDs, _flag_edp, _servsubkind, FiidList)
   private var SContr, SubIsNew = false;
   private var err_txt;
   private var prev_date = NULL;

   //Переключение на нужный опер.день (дата открытия ДБО/дата внесения изменений) для открытия счетов, если он больше текущего опер.дня
   if(ValType(_accrec.rec.open_date) == V_DATE)
     if({curdate} < _accrec.rec.open_date)
       prev_date = {curdate};
       setOperDay(_accrec.rec.open_date);
     end;
   end;
   if(ValType(inConditionDate) != V_UNDEF)
     if({curdate} < inConditionDate)
       prev_date = {curdate};
       setOperDay(inConditionDate);
     end;
   end;

   // DEF-68239, проверка валюты на присутствие в настройке СПИСОК_ВАЛЮТ
   if((_accrec.rec.code_currency != 0) and (Index(FiidList, string( _accrec.rec.code_currency )) <= 0) )
     return; // нет в списке, на выход
   end;

/*def-60699
   if ( ValType(_accrec.rec.open_date) == V_DATE)
      if ( ({curdate} - _accrec.rec.open_date) > 7 )
         _accrec.rec.open_date = {curdate}; // иначе старые договора не обновить
      end;
   else 
      _accrec.rec.open_date = {curdate};
   end;
*/

 // Является ли субдоговор новым?
   for (SContr, NewSubContractIDs)
     if (SContr == _sub_id)
       SubIsNew = true;
     end;
   end;

   // 2020-03-04 - Cherednichenko - Если субдоговор новый - дата открытия счета = дате открытия субдоговора
   if (SubIsNew)
     // дата уже задана в _accrec.rec.open_date
   // 2020-03-10 - Cherednichenko - иначе - дате изменения субдоговора
   else
     if(ValType(inConditionDate) != V_UNDEF)
       _accrec.rec.open_date = inConditionDate;
     else
       err_txt = string("Не найдена дата изменения договора " + _sub_id);
       RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
     end;
   end;

   if(ValType(_accrec.rec.open_date) == V_UNDEF)
     err_txt = string("Не определена дата открытия счета для договора " + _sub_id);
     RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
   end;

//   stat = OpenAccAndBindToContract(CATEG_SUBCONTRACT, _sub_id, _fiid_sub, "", err_txt, v_AgreementDate, new_sub, new_ed, inConditionDate);
//   stat = OpenAccAndBindToContract(CATEG_SUBCONTRACT, _sub_id, _fiid_sub, "", err_txt, v_AgreementDate, inConditionDate, NewSubContractIDs);

   OpenAccountByCategory(CATEG_SUBCONTRACT, _sub_id, _servsubkind, _flag_edp, _accrec);
   OpenAccountByCategory(CATEG_SUBCONTRACT_COM, _sub_id, _servsubkind, _flag_edp, _accrec);
   OpenAccountByCategory(CATEG_SUBCONTRACT_VU, _sub_id, _servsubkind, _flag_edp, _accrec);
   OpenAccountByCategory(CATEG_SUBCONTRACT_VU_CALC, _sub_id, _servsubkind, _flag_edp, _accrec);

   //Возвращаем использовавщийся ранее опер.день
   if(prev_date != NULL)
     setOperDay (prev_date);
   end;
end;

macro FillExistAccounts(p_dlcontrid)
   var sql_str, rs, cmd;
   var accrec_found;
   sql_str = "SELECT distinct t.t_servkindsub, ac.t_account, ac.t_currency, ac.t_catnum,ac.t_templnum,ac.t_chapter, "+                          
             "       (SELECT t_code FROM dmccateg_dbt WHERE t_number = ac.t_catnum AND t_leveltype = 1) catname "+
             "  FROM ddlcontrmp_dbt mp, dsfcontr_dbt t, dmcaccdoc_dbt ac, daccount_dbt a "+
             " WHERE ac.t_clientcontrid = t.t_id AND ac.t_owner = t.t_partyid AND ac.t_iscommon = CHR (88) AND ac.t_catnum NOT IN (531, 560) "+                                                     
             "   AND  t.t_id = mp.t_sfcontrid AND mp.t_dlcontrid = :p_dlcontrid AND t.t_servkindsub = 8 "+
             "   AND ac.t_chapter = a.t_chapter AND ac.t_currency = a.t_code_currency AND ac.t_account = a.t_account "+        
             "   AND ac.t_chapter = 1 AND a.t_open_close = chr(0) ";                           
   cmd = RSDCommand(sql_str);
   cmd.AddParam("p_dlcontrid", RSDBP_IN, p_dlcontrid);
   rs = RSDRecordSet(cmd);
   while (rs.movenext)
      accrec_found = c_acc_foropen();
      accrec_found.currency = rs.value("t_currency");
      accrec_found.account = rs.value("t_account");
      accrec_found.category = rs.value("catname");
      g_accrec_arr.value(g_accrec_arr.size) = accrec_found;
      accrec_found = null;
   end;
end;


// поиск субдоговора по ddlcontr_dbt.t_dlcontrid
private macro FindDlContrMp(p_dlcontrid, p_servkind, p_servkindsub, p_marketid, p_datebegin, p_acccode)
   var sql_str, rs, cmd;
   var res = -1;
   var datebeg = {curdate};
   var acccode;
      
   sql_str = "SELECT cntr.t_id cntr_id, cntr.t_servkind, cntr.t_servkindsub, mp.t_id mp_id, cntr.t_datebegin, cntr.t_acccode "+
             "  FROM dsfcontr_dbt cntr, "+
             "       ddlcontrmp_dbt mp "+
             "WHERE cntr.t_id = mp.t_sfcontrid "+
             "  AND cntr.t_servkind = :p_servkind "+
             "  AND cntr.t_servkindsub = :p_servkindsub "+
             "  AND mp.t_dlcontrid = :p_dlcontrid "+
//             "  AND mp.t_mpclosedate = to_date('01.01.0001','dd.mm.yyyy') "+
             "  AND cntr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') " ;
   if (p_servkindsub == SERV_SUBKIND_STOCK)
      sql_str = sql_str + "  AND mp.t_marketid = :p_marketid ";
   end;

   cmd = RSDCommand(sql_str);
   cmd.AddParam("p_servkind", RSDBP_IN, p_servkind);
   cmd.AddParam("p_servkindsub", RSDBP_IN, p_servkindsub);
   cmd.AddParam("p_dlcontrid", RSDBP_IN, p_dlcontrid);
   if (p_servkindsub == SERV_SUBKIND_STOCK)
      cmd.AddParam("p_marketid", RSDBP_IN, p_marketid);
   end;
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      res = rs.value("cntr_id");
      datebeg = rs.value("t_datebegin");
      acccode = rs.value("t_acccode");
   end;
   Setparm(4, datebeg);
   Setparm(5, acccode);

   return res;
end;


// поиск биржевой площадки (любой) по ddlcontr_dbt.t_dlcontrid
private macro FindDlContrMp_STOCK(p_dlcontrid, p_servkind)
   var sql_str, rs, cmd;
   var res = -1;
      
   sql_str = "SELECT count(*) cnt"+
             "  FROM dsfcontr_dbt cntr, "+
             "       ddlcontrmp_dbt mp "+
             "WHERE cntr.t_id = mp.t_sfcontrid "+
             "  AND cntr.t_servkind = :p_servkind "+
             "  AND mp.t_dlcontrid = :p_dlcontrid "+
//             "  AND mp.t_mpclosedate = to_date('01.01.0001','dd.mm.yyyy') ";
             "  AND cntr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') " ;
   cmd = RSDCommand(sql_str);
   cmd.AddParam("p_servkind", RSDBP_IN, p_servkind);
   cmd.AddParam("p_dlcontrid", RSDBP_IN, p_dlcontrid);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      res = rs.value("cnt");
   end;
   
   return res;
end;


// поиск СПИ ПЗО по dsfcontr_dbt.t_id
private macro FindDlContrMpSSI(p_cntr_id, p_fiid)
   var sql_str, rs, cmd;
   var res = -1;
   
   sql_str = "SELECT settacc.t_settaccid, settacc.t_fiid "+
             "  FROM dsfssi_dbt ssi, "+
             "       dsettacc_dbt settacc "+
             " WHERE ssi.t_objecttype = 659 "+
             "   AND ssi.t_setaccid = settacc.t_settaccid "+
             "   AND ssi.t_objectid = lpad(:p_cntr_id,10,'0') "+
             "   AND ssi.t_fiid = :p_fiid ";

   cmd = RSDCommand(sql_str);
   cmd.AddParam("p_cntr_id", RSDBP_IN, p_cntr_id);
   cmd.AddParam("p_fiid", RSDBP_IN, p_fiid);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      res = rs.value("t_settaccid");
   end;

   return res;
end;

// простановка клиента на обслуживание
private macro AddServKind(_partyid, _servkind, _department, _dt)
   var party_rec = RSBParty(_partyid);
   var stat, err_txt;
   var date_agree = _dt;
   if (date_agree > {curdate})
      date_agree = {curdate};
   end;
   party_rec.FullName = party_rec.FullName;
   stat = PT_BindClientWithBranch(party_rec.partyid, _servkind, _department, NULL, date_agree);
   if(not stat)
      err_txt = "Ошибка установки вида обслуживания "+_servkind+" при открытии ЕД БО";
      RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
   end;
   party_rec.Update;
   party_rec = NULL;
end;

// метод формирования оплаты комиссии
private macro UpdatePayMethod(_subid, _nummethod)
   var sql_str;
   var cmd;
   sql_str = "update dsfcontr_dbt set t_paymethod = :paymethod where t_id = :subid";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("paymethod", RSDBP_IN, _nummethod);
   cmd.AddParam("subid", RSDBP_IN, _subid);
   cmd.execute;
   cmd.close;

end;

private macro UpdateContractEmail(_dlcontr_id, _email_contract)
   var sql_str;
   var cmd;
   sql_str = "update ddlcontr_dbt set t_email = :email where t_dlcontrid = :id";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("email", RSDBP_IN, _email_contract);
   cmd.AddParam("id", RSDBP_IN, _dlcontr_id);
   cmd.execute;
   cmd.close;

end;

private macro UpdateContractEmail_ByNewEmail(p_client_id, _email_contract)
   var sql_str;
   var cmd;
   sql_str = "update ddlcontr_dbt set t_email = :email where t_dlcontrid in ( "+
             "  SELECT dl.t_dlcontrid dl_id "+
             "    FROM dsfcontr_dbt cntr, "+
             "         ddlcontr_dbt dl "+
             "   WHERE dl.t_sfcontrid = cntr.t_id "+
             "     AND cntr.t_partyid = :p_client_id "+
             "     AND cntr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') ) "+
             " and t_email != :email";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("email", RSDBP_IN, _email_contract);
   cmd.AddParam("p_client_id", RSDBP_IN, p_client_id);
   cmd.execute;
   cmd.close;
end;


macro FindMPCode(_code, _servkind, _servkindsub, _code2)
   var sql_str, rs, cmd;
   var res = false;

   if (_servkind == 15)
      sql_str = "  SELECT cntr.t_id cntr_id, cntr.t_servkind, cntr.t_servkindsub, mp.t_id mp_id "+
                "    FROM dsfcontr_dbt cntr,                                                    "+
                "         ddlcontrmp_dbt mp                                                     "+
                "  WHERE cntr.t_id = mp.t_sfcontrid                                             "+
                "    AND cntr.t_servkind = :p_servkind                                          "+
                "    AND cntr.t_servkindsub = :p_servkindsub                                    "+
                "    AND (mp.t_mpcode like :mpcode or mp.t_mpcode like :mpcode2 )               " ;
                //"    AND mp.t_mpclosedate = to_date('01.01.0001','dd.mm.yyyy')                  ";    // условие отключено, потому что случился прецедент
      cmd = RSDCommand(sql_str);
      cmd.AddParam("p_servkind", RSDBP_IN, _servkind);
      cmd.AddParam("p_servkindsub", RSDBP_IN, _servkindsub);
      cmd.AddParam("mpcode", RSDBP_IN, _code);  
      if (_code2)
         cmd.AddParam("mpcode2", RSDBP_IN, _code2);
      else 
         cmd.AddParam("mpcode2", RSDBP_IN, "CODE");
      end;

   else
      //gtv: ищем код не по площадке, а по ЕКК
      sql_str = "select cod.t_code from ddlobjcode_dbt cod "+                                                           
                " where cod.t_objecttype = 207           "+                                                           
                "   and cod.t_codekind = 1               "+                                                           
                "   and ( cod.t_bankclosedate = to_date('01.01.0001','dd.mm.yyyy') or (cod.t_bankclosedate > :dat) ) "
                "   and t_code like :mpcode";                                                                   
      cmd = RSDCommand(sql_str);
      cmd.AddParam("dat", RSDBP_IN, {curdate});
      cmd.AddParam("mpcode", RSDBP_IN, _code);
   end;
   rs = RSDRecordSet(cmd); 
   if (rs.movenext)
      res = true;
   end;

   return res;
end;

macro FindMPCode_ByDealid(_dlid, _servkind, _servkindsub, _marketid)
   var sql_str, rs, cmd;
   var res = "";

   sql_str = "  SELECT mp.t_mpcode "+
             "    FROM dsfcontr_dbt cntr,                  "+
             "         ddlcontrmp_dbt mp                   "+
             "  WHERE cntr.t_id = mp.t_sfcontrid           "+
             "    AND cntr.t_servkind = :p_servkind        "+
             "    AND cntr.t_servkindsub = :p_servkindsub  "+
             "    AND mp.t_dlcontrid = :dlid               "+
             "    AND mp.t_marketid = :marketid            "+
             "  AND cntr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') " ;
//             "    AND (   mp.t_mpclosedate = to_date('01.01.0001','dd.mm.yyyy') "+  /*DEF-52846 отбираем только открытые площадки*/
//             "         OR mp.t_mpclosedate > :dat)         ";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("p_servkind", RSDBP_IN, _servkind);
   cmd.AddParam("p_servkindsub", RSDBP_IN, _servkindsub);
   cmd.AddParam("dlid", RSDBP_IN, _dlid);  
   cmd.AddParam("marketid", RSDBP_IN, _marketid);
   cmd.AddParam("dat", RSDBP_IN, {curdate});  
   rs = RSDRecordSet(cmd); 
   if (rs.movenext)
      res = rs.value(0);
   end;

   return res;
end;


macro CheckCodeMICEX(_code, _servkind, _servkindsub, _partyid, _IsIIS, pCurFirmID)
   var partyid_found;
   var short_code = _code;
   var short_code_prev;
   var number_code, pos;
   var exist_mpcode;
   var err_txt;
   var short_code_prev2 = "CODE";

   var sql_str, rs, cmd;

   // не актуально, так как код 8 не используется
/*   partyid_found = GetPartyID_byPartyCode(PTCK_MICEX, short_code); 
   while (partyid_found > 0)  // существует такой код
      exist_mpcode = FindMPCode(_code, _servkind, _servkindsub);
      if (exist_mpcode) // код 8 есть и есть код в площадке, все нормально
         short_code = GeneratePersonalCode(_partyid, _IsIIS, false, false);    
         partyid_found = GetPartyID_byPartyCode(PTCK_MICEX, short_code); 
      else
         err_txt = "Существует код 8 "+_code+" и нет торговой площадки, где есть такой код";
         RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
      end;
   end; */

   // нашли код, которого ни у кого нет
   if (_servkind == PTSK_STOCKDL)
      pos = Index(_code, "S"); //BIQ-7041 код СПБ 
      if (pos > 0)
        number_code = Int(Substr(_code,3))-1;
      else
        number_code = Int(Substr(_code,2))-1;
      end;
      short_code_prev = String("_", number_code);
      short_code_prev2 = String("S_", number_code); // BIQ-7041 код СПБ
   elif (_servkind == 15)
      return short_code;
   elif (_servkind == 21)
      // BIQ-7041 gtv: единый код для ММВБ, СПБ и валютной 
/*      pos = Index(_code, "CU");
      if (pos > 0)
         number_code = Int(Substr(_code,4))-1;
         short_code_prev = String("_", number_code);
         short_code_prev2 = String("CU_", number_code);
      else
         err_txt = "Некорректно сформирован код клиента для валютной биржи "+_code;
         RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
      end;  */
      number_code = Int(Substr(_code,2))-1;
      short_code_prev = String("_", number_code); // short_code_prev2 не требуется
   end;

   exist_mpcode = FindMPCode(short_code_prev, _servkind, _servkindsub, short_code_prev2);
   if (not exist_mpcode)
       err_txt = "Не найдено предыдущее значение кода на бирже "+short_code_prev;
       RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
   end;

   return short_code;

onError(e)
   err_txt = "Ошибка при поиске и проверке краткого кода клиента на бирже "+e.message;
   RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
end;

macro FindEKK(in_ObjectType, in_CodeKind, in_ObjectId)
  var query, rs;
  var params : TArray;
  var m_Code = "-1";

  query =         "SELECT t_Code ";
  query = query + "  FROM ddlobjcode_dbt ";
  query = query + " WHERE t_ObjectType = :ObjectType ";
  query = query + "   AND t_ObjectID = :ObjectID ";
  query = query + "   AND t_CodeKind = :CodeKind ";
  query = query + "   AND t_BankDate <= :FromDate ";
  query = query + "   AND t_BankCloseDate = TO_DATE('01010001', 'DDMMYYYY')";

  params = makeArray(SQLParam("ObjectType", in_ObjectType)
                    ,SQLParam("ObjectID"  , in_ObjectId)
                    ,SQLParam("CodeKind"  , in_CodeKind)
                    ,SQLParam("FromDate"  , date())
                    );
  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    m_Code = rs.value(0);
  end;                         
  rs.close(); rs = null; query = null;

  return m_Code;
end;


macro SetContractCategories(_AgreementInfo, _objecttype, _objectid, RiskLevelBrok_exist, IsCurrentAccounts_exist, need_close:@bool, _newcontr)
   var ObjCat;
   var RiskLevelBrok_str, IsAnotherContract_str, IsQuik_str;
   var AttrID_old = 0, IsAttr = false;
   var stat, err_txt;
   var sql_str, cmd, rs, AttrID_old_found = false;
   var SKP_exist = false, QUIK_exist = false, FAKT2_exist = false, PAPER_exist = false, PHONE_exist = false;
   var attrid_str = "";
   var attr_acc = 0;

   // проверка взаимоисключений по категории "Тип подключения"
   if ( (_AgreementInfo.SKP_) or (_AgreementInfo.QUIK_) ) // СКПЭП
      AttrID_old = 2;
   else
      if  ( (_AgreementInfo.FAKT2_) or (_AgreementInfo.PAPER_) or (_AgreementInfo.PHONE_) )  // двухфакторная
         AttrID_old = 1;
         if (not _AgreementInfo.FAKT2_)
            _AgreementInfo.FAKT2_ = true; // бонус, если нет СКП ЭП
         end;
      else
         AttrID_old = 0;
      end;
   end;

   // проверяем, что в текущих категориях
   sql_str = "select t_attrid from dobjatcor_dbt where t_objecttype = :objecttype and t_object = :objectid and t_groupid = :groupid";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("objecttype", RSDBP_IN, _objecttype);
   cmd.AddParam("objectid", RSDBP_IN, _objectid);
   cmd.AddParam("groupid", RSDBP_IN, CONTRACT_CATEGORY_ISQUIK);
   rs = RSDRecordSet(cmd);
   while (rs.movenext)
     if (rs.value("t_attrid") == 1)
         SKP_exist = true;
     elif (rs.value("t_attrid") == 2)
         FAKT2_exist = true;
     elif (rs.value("t_attrid") == 3)
         QUIK_exist = true;
     elif (rs.value("t_attrid") == 4)
         PAPER_exist = true;
     elif (rs.value("t_attrid") == 5)
         PHONE_exist = true;
     end;
     if (rs.value("t_attrid") == AttrID_old)
        AttrID_old_found = true;
     end;
   end;
   cmd.close; cmd = null;
   rs.close; rs = null;

   // Disconnect отказывается работать
   /* ObjCat = RsbObjCategories(_objecttype, _objectid);
   IsAttr = ObjCat.IsAttrPresense(CONTRACT_CATEGORY_ISQUIK, AttrID_old, null, null, null, date());
   if (IsAttr)
      stat = ObjCat.DisconnectAttr(CONTRACT_CATEGORY_ISQUIK, AttrID_old); 
      ObjCat.Save(_objectid);
   end;*/

   attrid_str = "";
   if (_AgreementInfo.SKP_ != SKP_exist)
      attrid_str = " and t_attrid in (1 ";
   end;
   if (_AgreementInfo.FAKT2_ != FAKT2_exist)
      if (StrLen(attrid_str) > 0 )
         attrid_str = attrid_str + ", 2";
      end;
   end;
   if (_AgreementInfo.QUIK_ != QUIK_exist)
      if (StrLen(attrid_str) > 0 )
         attrid_str = attrid_str + ", 3";
      end;
   end;
   if (_AgreementInfo.QUIK_ != PAPER_exist)
      if (StrLen(attrid_str) > 0 )
         attrid_str = attrid_str + ", 4";
      end;
   end;
   if (_AgreementInfo.QUIK_ != PHONE_exist)
      if (StrLen(attrid_str) > 0 )
         attrid_str = attrid_str + ", 5";
      end;
   end;

   if (StrLen(attrid_str) > 0 )
      attrid_str = attrid_str + ")";
   end;

   if (StrLen(attrid_str) > 0 )
      sql_str = "delete from dobjatcor_dbt where t_objecttype = :objecttype and t_object = :objectid and t_groupid = :groupid "+attrid_str;
      cmd = RSDCommand(sql_str);
      cmd.AddParam("objecttype", RSDBP_IN, _objecttype);
      cmd.AddParam("objectid", RSDBP_IN, _objectid);
      cmd.AddParam("groupid", RSDBP_IN, CONTRACT_CATEGORY_ISQUIK);
      cmd.execute;
      cmd.close; cmd = null;
   end;

   if (not need_close)
      if (AttrID_old_found and (AttrID_old == 2))
         need_close = true;
      end;
   end;

   if ( (ValType(_AgreementInfo.IsAnotherContract) != V_UNDEF) or (ValType(_AgreementInfo.RiskLevelBrok) != V_UNDEF) 
          or (ValType(_AgreementInfo.IsQuik) != V_UNDEF) or (ValType(_AgreementInfo.IsCurrentAccounts) != V_UNDEF) )  // категории договора

      // DEF-33954 категории должны иметь дату договора только для нового договора, а не при обновлении
      var CategoryDate;
      if (_newcontr)
         CategoryDate = _AgreementInfo.AgreementDate;
      else 
         CategoryDate = date();
      end;

      ObjCat = RsbObjCategories(_objecttype, _objectid);

      if (_newcontr)
         if (ValType(_AgreementInfo.IsAnotherContract) != V_UNDEF) 
            if (_AgreementInfo.IsAnotherContract)
               IsAnotherContract_str = "Да";
            else
               IsAnotherContract_str = "Нет";
            end;  
            stat = ObjCat.ConnectAttr(CONTRACT_CATEGORY_ISCON, NULL, "", IsAnotherContract_str, CategoryDate );
            if (stat > 0)
               err_txt = String("Ошибка "+stat+" установки категории ",CONTRACT_CATEGORY_ISCON,", значение ",IsAnotherContract_str);
               RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
            end;
//shev biq-8258
            if (_AgreementInfo.IsAnotherContract)
               stat = ObjCat.ConnectAttr(CONTRACT_CATEGORY_BLOCK_SIGN, NULL, "", "1", CategoryDate );
               if (stat > 0)
                  err_txt = String("Ошибка "+stat+" установки категории ",CONTRACT_CATEGORY_BLOCK_SIGN,", значение ","Да");
                  RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
               end;
            end;
         end;
      end;
//boss-7205
      RiskLevelBrok_str = "4";
/*
      if (ValType(_AgreementInfo.RiskLevelBrok) != V_UNDEF)  // уровень риска
         if (_AgreementInfo.RiskLevelBrok == "КСУР")
            RiskLevelBrok_str = "1";
         elif (_AgreementInfo.RiskLevelBrok == "КПУР")
            RiskLevelBrok_str = "2";
         elif (_AgreementInfo.RiskLevelBrok == "КОУР")
            RiskLevelBrok_str = "3";
         end;

         if (_AgreementInfo.RiskLevelBrok == "NONE")
           sql_str = " delete from dobjatcor_dbt where t_objecttype = :objecttype and t_object = :objectid and t_groupid = :groupid ";
           cmd = RSDCommand(sql_str);
           cmd.AddParam("objecttype", RSDBP_IN, _objecttype);
           cmd.AddParam("objectid", RSDBP_IN, _objectid);
           cmd.AddParam("groupid", RSDBP_IN, CONTRACT_CATEGORY_RISKLEVEL);
           cmd.execute;
           cmd.close; cmd = null;
         else
           if ((ValType(RiskLevelBrok_str) != V_UNDEF) and (RiskLevelBrok_str > 0) and (RiskLevelBrok_str < 4))
             if ( (StrUpr(RiskLevelBrok_str) != StrUpr(RiskLevelBrok_exist)) or (not RiskLevelBrok_exist) )
// 2021-02-12 Cherednichenko is523091 Дата категории равна дате договора
//                stat = ObjCat.ConnectAttr(CONTRACT_CATEGORY_RISKLEVEL, NULL, "", RiskLevelBrok_str, date() );
                stat = ObjCat.ConnectAttr(CONTRACT_CATEGORY_RISKLEVEL, NULL, "", RiskLevelBrok_str, CategoryDate );
                if (stat > 0)
                   err_txt = String("Ошибка "+stat+" установки категории ",CONTRACT_CATEGORY_RISKLEVEL,", значение ",_AgreementInfo.RiskLevelBrok);
                   RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
                end;
             end;
           else
             err_txt = String("Ошибка установки категории: передано неуставное значение RiskLevelBrok: ",_AgreementInfo.RiskLevelBrok);
             RunError(err_txt, c_err_obj(err_txt, 7));
           end;
         end;
      end;
*/
      if ( (StrUpr(RiskLevelBrok_str) != StrUpr(RiskLevelBrok_exist)) or (not RiskLevelBrok_exist) )
           stat = ObjCat.ConnectAttr(CONTRACT_CATEGORY_RISKLEVEL, NULL, "", RiskLevelBrok_str, CategoryDate );
           if (stat > 0)
              err_txt = String("Ошибка "+stat+" установки категории ",CONTRACT_CATEGORY_RISKLEVEL,", значение ",_AgreementInfo.RiskLevelBrok);
              RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
           end;
      end;

//boss-7205

      if (ValType(_AgreementInfo.IsQuik) != V_UNDEF)  // тип подключения
         // оставлено для истории
         /*if (AgreementInfo.IsQuik == "СКПЭП")
            IsQuik_str = "1";
         elif (AgreementInfo.IsQuik == "2ФАКТ")
            IsQuik_str = "2";
         elif (AgreementInfo.IsQuik == "QUIK")
//                     IsQuik_str = "3";
            IsQuik_str = "1";
         elif (AgreementInfo.IsQuik == "БУМАЖН")
            IsQuik_str = "4";
         elif (AgreementInfo.IsQuik == "ТЕЛЕФОН")
            IsQuik_str = "5";
         end;

         stat = ObjCat.ConnectAttr(CONTRACT_CATEGORY_ISQUIK, NULL, "", IsQuik_str, date() );
         if (stat > 0)
            err_txt = String("Ошибка "+stat+" установки категории ",CONTRACT_CATEGORY_ISQUIK,", значение ",_AgreementInfo.IsQuik);
            RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
         end; */

         if ( (_AgreementInfo.SKP_) or (_AgreementInfo.QUIK_) )
            IsQuik_str = 1;
// 2021-02-12 Cherednichenko is523091 Дата категории равна дате договора
//            stat = ObjCat.ConnectAttr(CONTRACT_CATEGORY_ISQUIK, IsQuik_str, "", "", date() );

            stat = ObjCat.ConnectAttr(CONTRACT_CATEGORY_ISQUIK, IsQuik_str, "", "", CategoryDate );
            if (stat > 0)
               err_txt = String("Ошибка "+stat+" установки категории ",CONTRACT_CATEGORY_ISQUIK,", значение ",_AgreementInfo.IsQuik);
               RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
            end;
         end;
         if (_AgreementInfo.FAKT2_)
            IsQuik_str = 2;
            stat = ObjCat.ConnectAttr(CONTRACT_CATEGORY_ISQUIK, IsQuik_str, "", "", CategoryDate );
            if (stat > 0)
               err_txt = String("Ошибка "+stat+" установки категории ",CONTRACT_CATEGORY_ISQUIK,", значение ",_AgreementInfo.IsQuik);
               RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
            end;
         end;
         if (_AgreementInfo.PAPER_)
            IsQuik_str = 4;
            stat = ObjCat.ConnectAttr(CONTRACT_CATEGORY_ISQUIK, IsQuik_str, "", "", CategoryDate );
            if (stat > 0)
               err_txt = String("Ошибка "+stat+" установки категории ",CONTRACT_CATEGORY_ISQUIK,", значение ",_AgreementInfo.IsQuik);
               RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
            end;
         end;
         if (_AgreementInfo.PHONE_)
            IsQuik_str = 5;
            stat = ObjCat.ConnectAttr(CONTRACT_CATEGORY_ISQUIK, IsQuik_str, "", "", CategoryDate );
            if (stat > 0)
               err_txt = String("Ошибка "+stat+" установки категории ",CONTRACT_CATEGORY_ISQUIK,", значение ",_AgreementInfo.IsQuik);
               RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
            end;
         end;

         if ((_AgreementInfo.SKP_) or (_AgreementInfo.QUIK_) )
           ObjCat.SetMainAttr(CONTRACT_CATEGORY_ISQUIK,1);
         elif (_AgreementInfo.FAKT2_)
           ObjCat.SetMainAttr(CONTRACT_CATEGORY_ISQUIK,2);
         end;

      end;

      if (_newcontr)
// 2020-04-27 Cherdnichenko - Дата открытия категории равна дате открытия договора, иначе она не видна в интерфейсе в соотв. опердень
         stat = ObjCat.ConnectAttr(CONTRACT_CATEGORY_STATUS, 4, "", "", _AgreementInfo.AgreementDate );
      end;   

      if (ValType(_AgreementInfo.IsCurrentAccounts) != V_UNDEF)  // Выплата доходов на текущий счет
         if (_AgreementInfo.IsCurrentAccounts)
            attr_acc = 1/*Да*/;
         else
            attr_acc = 2/*Нет*/;
         end;

         if ((attr_acc == 1/*Да*/) and 
             (ValType(_AgreementInfo.IsIISContract) != V_UNDEF) and (_AgreementInfo.IsIISContract) and
             (ValType(_AgreementInfo.IISType) != V_UNDEF) and (_AgreementInfo.IISType == "ИИС3")
            )
           err_txt = String("Ошибка установки категории \"Выплата доходов на текущий счет\", для договора ИИС с типом \"ИИС-III\" выплата доходов на текущий счет недоступна");
           RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
         end;

         if ( (string(attr_acc) != IsCurrentAccounts_exist) or (not IsCurrentAccounts_exist) )
           stat = ObjCat.ConnectAttr(CONTRACT_CATEGORY_ISCURRENTACCOUNTS, attr_acc, "", "", CategoryDate );
           if (stat > 0)
             err_txt = String("Ошибка "+stat+" установки категории \"Выплата доходов на текущий счет\", значение ",_AgreementInfo.IsCurrentAccounts);
             RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
           end;
         end;
      end;

      if(stat == 0)
         stat = ObjCat.Save(_objectid);
      end;
      ObjCat = null;
   end;

   if ((ValType(_AgreementInfo.IsCurrentAccounts) == V_UNDEF) and (IsCurrentAccounts_exist == "1"/*Да*/) and 
       (ValType(_AgreementInfo.IsIISContract) != V_UNDEF) and (_AgreementInfo.IsIISContract) and
       (ValType(_AgreementInfo.IISType) != V_UNDEF) and (_AgreementInfo.IISType == "ИИС3")
      )
     err_txt = String("Для договора ИИС с типом \"ИИС-III\" выплата доходов на текущий счет недоступна. Необходимо изменить значение тега IsCurrentAccounts");
     RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
   end;   
end;

// выгрузка в QUIK и РСХБ-Брокер
macro CheckAndPushUnloadQUIKBroker(_partyid,needupdate);
   var sql_str, rs, cmd;
   var FoundBad = false; // признак отсутствия значения категории "Двухфакторная авторизация"
   var ObjCat;
   var EventNumber;

   // DEF-33954 категория СКП больше не имеет такой вес, важна только последняя категория по дате
   // основные проверки будут в usp_Import
   //FoundBad = CheckCategory_SKP(_partyid);
   if (FoundBad)
     //  ничего не делать
   else
     // ДБО уже есть, клиент тем более должен быть
     ObjCat = RsbObjCategories(3, string(_partyid:10:o));
     if (ObjCat.GetMainAttr( 170, date(), attr, attrcor ) == 0)   // категория "выгружено в рсхб-брокер"
        if (attrcor.attrid == 1)    // если выгрузка уже прошла удачно
           //обновление РСХБ-Брокер
           EventNumber = 5026;
           if (not EventDoubling(EventNumber, _partyid))
              if(needupdate)
                 m_make_event_to_process(EventNumber, _partyid, 11);
              else
                 m_make_event_to_process(EventNumber, _partyid);
              end;
           end;
        end;
     end;
     ObjCat = NULL;

     sql_str ="select t_code from dobjcode_dbt where t_ObjectType = 3 "+
              "     and t_codekind = :codekind and t_objectid = :objid"+
              "     and t_BankCloseDate = TO_DATE('01010001', 'DDMMYYYY') ";
     cmd = RSDCommand(sql_str);
     cmd.AddParam("codekind", RSDBP_IN, 105);
     cmd.AddParam("objid", RSDBP_IN, _partyid);
     rs = RSDRecordSet(cmd);
     if (rs.movenext)   // есть код квика
        // обновление аккаунта Quik 
        EventNumber = 5025;
        if (not EventDoubling(EventNumber, _partyid))
          m_make_event_to_process(EventNumber, _partyid);
        end;
     end;
   end;
end;

macro естьНенулевыеЛоты( sfID )
   var selectLot, rsLot, cmdLot;
   var stat = 0;
   selectLot = " SELECT * FROM dpmwrtcl_dbt wrtcl "
             + "  WHERE     t_contract = ?"
             + "        AND wrtcl.t_begdate <= ? "
             + "        AND wrtcl.t_enddate >= ? "
             + "        AND ROWNUM = 1 " 
             ;
   cmdLot = RSDCommand(selectLot);
   cmdLot.AddParam("", RSDBP_IN, sfID);
   cmdLot.AddParam("", RSDBP_IN, date());
   cmdLot.AddParam("", RSDBP_IN, date());
   rsLot = RSDRecordSet(cmdLot);
   if(rsLot.moveNext)
     stat = 1;
   end;
   return stat;
end; 

macro естьНезакрытыеТО( sfID )
   var selectTO, rsTO, cmdTO;
   var stat = 0;
   selectTO = " SELECT 1 "
             +" FROM DDLRQ_DBT rq , "
             +" DDL_TICK_DBT tick "
             +" WHERE rq.t_state not in (" + DLRQ_STATE_EXEC + "," + DLRQ_STATE_REJECT + "," + DLRQ_STATE_GO_CLOSE + ") " 
             +" AND rq.t_docKind = tick.t_bofficekind "
             +" AND rq.t_docID = tick.t_dealID "
             +" AND tick.t_ClientContrID = ? "
             +" AND ROWNUM = 1 "
             +" UNION "
             +" SELECT 1  "
             +" FROM DDLRQ_DBT rq , "
             +" DNPTXOP_DBT nptxop "
             +" WHERE rq.t_state not in (" + DLRQ_STATE_EXEC + "," + DLRQ_STATE_REJECT + "," + DLRQ_STATE_GO_CLOSE + ") " 
             +" AND rq.t_docKind = nptxop.T_DOCKIND "
             +" AND rq.t_docID = nptxop.t_ID "
             +" AND nptxop.t_docKind = " + DL_WRTMONEY
             +" AND nptxop.t_Contract = ? "
             +" AND ROWNUM = 1 "
             ;
   cmdTO = RSDCommand(selectTO);
   cmdTO.AddParam("", RSDBP_IN, sfID);
   cmdTO.AddParam("", RSDBP_IN, sfID);
   rsTO = RSDRecordSet(cmdTO);
   if(rsTO.moveNext )
     stat = 1;
   end;
   return stat;
end; 

// Закрытие площадок, которые отсутствовали в запросе
macro FindAndCloseSubContr(_old_subid, _dlcontr_id)
   var old_subid_str;
   var ai_sub;
   var sql_str, rs, cmd;
   var close_subid = TArray;
   var res;
   
   // массив заведомо имеет элементы
   old_subid_str = _old_subid.value(0);
   if (_old_subid.size > 1)
      ai_sub = 1;
      while (ai_sub < _old_subid.size)
         old_subid_str = old_subid_str+","+_old_subid.value(ai_sub);
         ai_sub = ai_sub+1;
      end;
   end;
   // проверим, есть ли площадки, не переданные в запросе
   sql_str = "select Cntr.t_id "+
             "  From Dsfcontr_Dbt Cntr, "+
             "       Ddlcontrmp_Dbt Mp "+
             "Where Cntr.T_Id = Mp.T_Sfcontrid "+
             "  And Cntr.T_Id not in ("+old_subid_str+")  "+
             "  And Mp.T_Dlcontrid = "+ _dlcontr_id +
//             "  And Mp.T_Mpclosedate = To_Date('01.01.0001','Dd.Mm.Yyyy') ";
             "  AND cntr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') " ;
   rs = RSDRecordSet(sql_str);
   while (rs.movenext)
      if(NOT (естьНенулевыеЛоты(rs.value("t_id")) OR ( естьНезакрытыеТО(rs.value("t_id")))) )
         close_subid.value(close_subid.size) = rs.value("t_id");
      end;
   end;
   rs.close; rs = null; sql_str = null;
   
   // нашли "лишние" площадки, нужно закрыть
   if (close_subid.size > 0)
      // чтобы не закрыть счета, снимем признак 
      sql_str = "update ddlcontr_dbt set t_usesubacc = chr(0) where t_dlcontrid = :dlcontrid";
      cmd = RSDCommand(sql_str);
      cmd.AddParam("dlcontrid", RSDBP_IN, _dlcontr_id);
      cmd.execute;
      ai_sub = 0;
      while (ai_sub < close_subid.size)
         res = DL_CloseSubContrInDLCONTR(_dlcontr_id, close_subid.value(ai_sub), date());
         ai_sub = ai_sub+1;
      end;
   end;
end;

// BIQ-8786 тарифные планы
class c_Tariff_In()
   var TariffId   : variant;
   var TariffPlan : string;
   var BindDate   : date;
   var UnbindDate : date;
   var IsIndividual : bool;
end;

MACRO binddate_asc(key, elem)
   if (key.BindDate > elem.BindDate)
      return +1;
   elif(key.BindDate < elem.BindDate)
      return -1;
   end;
   return 0;
END;

// _TariffList заведомо заполнен и является массивом
macro FindTarifFromTariffList(_TariffList)
   var res = TArray;
   var temp_tariff;
   var rs, cmd, sql_str;
   var tarif_repo = c_Tariff_In;
   var tarif_brok = c_Tariff_In;
   tarif_repo.TariffId = -1;
   var tarif_repo_arr = TArray;
   var ai_brok = 0;
   var ai_repo = 0;
   var err_txt;
   
   sql_str = "select t_sfplanid from dsfplan_dbt where t_num = :n";
   
   for (temp_tariff, _TariffList)
      tarif_brok = c_Tariff_In;
      tarif_brok.TariffId = -1;
      if (temp_tariff.TariffKind.RecordCode == "BROKERAGE")
         cmd = RSDCommand(sql_str);
         cmd.AddParam("n", RSDBP_IN, temp_tariff.TariffId.Objectid);
         rs = RSDRecordSet(cmd);
         if (rs.moveNext)
            tarif_brok.TariffId = rs.value(0);
            tarif_brok.TariffPlan = temp_tariff.TariffPlan.RecordCode;
            tarif_brok.BindDate   = temp_tariff.BindDate;
            tarif_brok.UnbindDate = temp_tariff.UnbindDate;
            tarif_brok.IsIndividual = temp_tariff.IsIndividual;
         end;
         if (tarif_brok.TariffId == -1)
            err_txt = "Тариф "+temp_tariff.TariffId.Objectid+" не найден";
            RunError(err_txt, c_err_obj(err_txt, "004"));
         else 
            res.value(ai_brok) = tarif_brok;
            tarif_brok = null;
            ai_brok = ai_brok+1;
         end;
      elif (temp_tariff.TariffKind.RecordCode == "REPO")
         tarif_repo = c_Tariff_In;
         tarif_repo.TariffId   = temp_tariff.TariffId.Objectid;
         tarif_repo.TariffPlan = temp_tariff.TariffPlan.RecordCode;
         tarif_repo.BindDate   = temp_tariff.BindDate;
         tarif_repo.UnbindDate = temp_tariff.UnbindDate;
         tarif_repo.IsIndividual = temp_tariff.IsIndividual;
         tarif_repo_arr.value(ai_repo) = tarif_repo;
         tarif_repo = null;
         ai_repo = ai_repo+1;
      end;
   end;
   SetParm(1, tarif_repo_arr);
   
   return res;
end;

macro CreateTarifNote(  p_ObjectType, p_DocumentID, p_NoteKind, 
                        p_value, p_date, p_validtodate)
   var sql_str, rs, cmd;
   if (ValType(p_validtodate) == V_UNDEF)
      p_validtodate = date(31,12,9999);
   end;
   sql_str = 
String(
"  declare \n"
,"   v_ObjectType number := :p_ObjectType; \n"                                                              
,"   v_DocumentID varchar2(100) := :p_DocumentID; \n"                                                       
,"   v_NoteKind number := :p_NoteKind; \n"                                                                 
,"   v_date date := :p_date; \n"                                                                           
,"   v_time date := to_date('01010001'||to_char(sysdate,'hh24miss'),'DDMMYYYYhh24miss'); \n"                   
,"   v_validtodate date := :p_validtodate; \n"                                                              
,"   v_oper number := :p_oper; \n"                                                                        
,"   v_value_str varchar2(100) :=  :p_value_str; \n"                                                                
,"   v_value_date date :=  :p_value_date; \n"                                                               
,"   v_cnt number; \n"
,"   v_oldvalue_str varchar2(3000); \n"
,"   v_oldvalue_date date; \n"
,"   v_newvalue RAW(1500); \n"
,"   v_id number; \n"
,"begin \n"
,"   RSB_Struct.readStruct('dnotetext_dbt'); \n"
,"   if v_value_str is not null then \n"
,"      v_newvalue := RSB_Struct.PutString('t_text', rpad('0',3000, '0'), v_value_str, (-1)*53);\n"
,"   elsif v_value_date is not null then \n"
,"      v_newvalue := RSB_Struct.PutDate('t_text', rpad('0',3000, '0'), v_value_date, (-1)*53); \n"
,"   end if; \n"
,"   select count(*) into v_cnt \n"
,"     from DNOTETEXT_DBT \n"
,"   where t_objecttype = v_ObjectType and t_documentid = v_DocumentID \n"
,"     and t_notekind = v_NoteKind and t_validtodate = to_date('31.12.9999','dd.mm.yyyy') and t_date < v_date; \n"
,"   if v_cnt > 0 then \n"
,"      begin \n"
,"         update DNOTETEXT_DBT set t_validtodate = v_date-1 \n"
,"          where t_objecttype = v_ObjectType and t_documentid = v_DocumentID \n"                             
,"            and t_notekind = v_NoteKind and t_validtodate = to_date('31.12.9999','dd.mm.yyyy') and t_date < v_date; \n"
,"      exception \n"
,"         when DUP_VAL_ON_INDEX then \n"
,"            delete from DNOTETEXT_DBT \n"
,"             where t_objecttype = v_ObjectType and t_documentid = v_DocumentID \n"
,"               and t_notekind = v_NoteKind and t_validtodate = v_date-1; \n"
,"            update DNOTETEXT_DBT set t_validtodate = v_date-1 \n"
,"             where t_objecttype = v_ObjectType and t_documentid = v_DocumentID \n"
,"               and t_notekind = v_NoteKind and t_validtodate = to_date('31.12.9999','dd.mm.yyyy') and t_date < v_date; \n"
,"      end; \n"
,"   end if; \n"
,"   begin  \n"
,"      if v_value_str is not null then \n"
,"         select replace(RSB_Struct.GetString(t_text),chr(0),''), t_id into v_oldvalue_str, v_id\n"
,"           from DNOTETEXT_DBT \n"
,"          where t_objecttype = v_ObjectType and t_documentid = v_DocumentID \n"
,"            and t_notekind = v_NoteKind and t_date = v_date and t_validtodate = v_validtodate; \n"
,"         if v_oldvalue_str <> v_value_str then \n"
,"            update DNOTETEXT_DBT set t_text = v_newvalue \n"
,"             where t_id = v_id; \n"
,"         end if;\n"
,"      elsif v_value_date is not null then  \n"
,"         select RSB_Struct.GetDate(t_text), t_id into v_oldvalue_date, v_id \n"
,"           from DNOTETEXT_DBT \n"
,"          where t_objecttype = v_ObjectType and t_documentid = v_DocumentID \n"
,"            and t_notekind = v_NoteKind and t_date = v_date and t_validtodate = v_validtodate; \n"
,"         if v_oldvalue_date <> v_value_date then  \n"
,"            update DNOTETEXT_DBT set t_text = v_newvalue \n"
,"             where t_id = v_id; \n"
,"         end if; \n"
,"      end if; \n"
,"   exception \n"
,"      when no_data_found then \n"
,"         delete from DNOTETEXT_DBT \n"
,"          where t_objecttype = v_ObjectType and t_documentid = v_DocumentID \n"
,"            and t_notekind = v_NoteKind and t_date >= v_date;  \n"
,"         INSERT into DNOTETEXT_DBT \n"
,"         (t_objecttype, t_documentid, t_notekind, t_oper, \n"
,"          t_date, t_time, t_text, t_validtodate, t_branch, t_numsession) \n"
,"         VALUES (v_objecttype, v_documentid, v_notekind, v_oper, \n"
,"                 v_date, v_time, v_newvalue, v_validtodate, 1, 0); \n"
,"   end; \n"
,"end; "
);
   cmd  = rsdcommand(sql_str);
   cmd.AddParam("p_ObjectType", RSDBP_IN, p_ObjectType);
   cmd.AddParam("p_DocumentID", RSDBP_IN, p_DocumentID);
   cmd.AddParam("p_NoteKind", RSDBP_IN, p_NoteKind);
   cmd.AddParam("p_date", RSDBP_IN, p_date);
   cmd.AddParam("p_validtodate", RSDBP_IN, p_validtodate);
   cmd.AddParam("p_oper", RSDBP_IN, {oper});
   if (p_NoteKind == 147)
      cmd.AddParam("p_value_str", RSDBP_IN, NULL);
      cmd.AddParam("p_value_date", RSDBP_IN, p_value);
   else 
      cmd.AddParam("p_value_str", RSDBP_IN, p_value);
      cmd.AddParam("p_value_date", RSDBP_IN, NULL);
   end;
   cmd.execute;
   cmd.close;
   cmd = null;
onerror(e)
   var err_txt = "Ошибка добавления примечания "+p_NoteKind+" к документу " + getFullCmdErrorText(cmd);
   RunError(err_txt, c_err_obj(err_txt, "004"));
end;

macro AddTariffRepo(tarif_repo, objecttype, objectid)
   var temp_tarif_repo = null;
   var stat;
   
   for (temp_tarif_repo, tarif_repo)
      if (temp_tarif_repo.IsIndividual) // DEF-48137 индивидуальные тарифы игнорируем
      else 
         CreateTarifNote(  objecttype, objectid, CONTRACT_NOTEKIND_TARIFFID_REPO, 
                                 temp_tarif_repo.TariffId, temp_tarif_repo.BindDate, temp_tarif_repo.UnbindDate);
         CreateTarifNote(  objecttype, objectid, CONTRACT_NOTEKIND_TARIFFPLAN_REPO, 
                                 temp_tarif_repo.TariffPlan, temp_tarif_repo.BindDate, temp_tarif_repo.UnbindDate);
         CreateTarifNote(  objecttype, objectid, CONTRACT_NOTEKIND_BINDDATE_REPO, 
                               temp_tarif_repo.BindDate, temp_tarif_repo.BindDate, temp_tarif_repo.UnbindDate);
      end;
   end;
end;

/*
@brief Отправка по почте сообщения клиенту о невозможности смены тарифного плана
@param[in] Dlcontrid  ID договора
@param[in] partyID  ID клиента
@param[in] FIO  ФИО клиента
@param[in] sfDateBegin  Дата открытия ДБО
@param[in] sfNumber  Номер ДБО
@param[in] resultDesc Текст для письма
@return    Статус отправки письма. -1 - Email не найден, 1 - ошибка, 0 - успешно отправлено/уже отправлено
*/
macro sendEmailDebt(DlContrID: integer, partyID: integer, FIO: string, sfDateBegin: date, sfNumber: string, resultDesc: string)
   var sql            :String,
       cmd            :Object,
       ds             :Object,
       ClntEmail      :String,
       Subject        :String,
       EmailText      :String,
       ErrMsg         :String,
       query          :Object,
       v_email_processor :Object,
       err_txt        :String,
       newId          :Integer;

   //Проверим, что еще не создавали сообщение на договоре в эту дату
    cmd = DL_RSDCommand("SELECT 1 " +
                         "  FROM ddlcontrmsg_dbt " +
                         " WHERE t_DlContrID = ? " +
                         "   AND t_Kind = ? " +
                         "   AND t_CreateDate = ? "
                        );
    cmd.AddParam(DlContrID);
    cmd.AddParam(DLCONTR_MESSAGE_REFUSAL_CHNG_TARIFF);
    cmd.AddParam(Date());
    ds = cmd.Execute();
     
    if(ds.MoveNext())
      return 0;
    end;

   query = RSDCommand("INSERT INTO ddlcontrmsg_dbt (t_DlContrID, t_Kind, t_CreateDate, t_CreateTime, t_MarketID) " +
                         "                    VALUES (?, ?, ?, ?, ?) RETURNING t_ID INTO ?");
   query.AddParam("", RSDBP_IN, DlContrID);
   query.AddParam("", RSDBP_IN, DLCONTR_MESSAGE_REFUSAL_CHNG_TARIFF);
   query.AddParam("", RSDBP_IN, Date());
   query.AddParam("", RSDBP_IN, Time());
   query.AddParam("", RSDBP_IN, -1);
   query.addParam("ID", RSDBP_OUT, V_INTEGER);
   query.Execute();
   newId = query.value("ID"); 

    ClntEmail = USER_GetClientRepEmail(DlContrID, PartyID);
    if(ClntEmail == "")
      ErrMsg = "Не удалось опеределить Email клиента " + FIO;
      return -1;
    end;

   Subject = "Договор брокерского обслуживания № " + sfNumber + " от " + string(sfDateBegin:f) + ". Смена тарифного плана";

   EmailText = "Уважаемый " + FIO + "!\n"
               + "\n"
               + "на момент обработки Заявления у Вас есть задолженность перед Банком по Договору брокерского обслуживания в размере " + resultDesc + "."
               + "\n"
               + "Изменение тарифного плана осуществляется Банком не ранее следующего рабочего дня после полного погашения задолженности, указанной выше. "
               + "После погашения задолженности Вы сможете повторить попытку внесения изменений в Соглашение в части перехода на тарифный план \x22Трейдер\x22 не ранее следующего рабочего дня. "
               + "\n"
               + "*- размер задолженности может быть изменен в процессе обработки операций. Детальную информацию можно получить из Отчета брокера или в приложении Свои инвестиции.\n"
               + "\n"
               + "С уважением, АО \x22Россельхозбанк\x22";

   v_email_processor = c_email_proc_env();  
   v_email_processor.m_set_msg_head(Subject);
   v_email_processor.m_add_email_to_list(ClntEmail);
   v_email_processor.m_add_row_to_msg_text(EmailText);
   v_email_processor.m_save_to_submit_synch();
   v_email_processor.m_submit_email_synch();

   if(v_email_processor.m_get_error_status())
      ErrMsg = "Ошибка при отправке письма клиенту: " + v_email_processor.get_service_msg();
      return 1;
   end;

   //Установим время отправки в сообщении на договоре, если успешно отправили
   query = RSDCommand("UPDATE ddlcontrmsg_dbt " +
                     "   SET t_SendDate = ?, " +
                     "       t_SendTime = ? " +
                     " WHERE t_id = ? "
                     );
   query.AddParam("", RSDBP_IN, Date());
   query.AddParam("", RSDBP_IN, Time());
   query.AddParam("", RSDBP_IN, newId);
   query.Execute();

   return 0;

onerror(e)
   err_txt = "Ошибка отправки уведомления клиенту о невозможности смены тарифного плана, для ДБО с номером " + sfNumber;
   RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
end;

/*
@brief  Поиск суммарной задолженности на текущую дату по всем типам задолженности по ДБО клиента
@param[in] sfcontrId  ID договора
@param[in] dlContrPrm  Структура с параматрами ДБО
@param[out] resultDesc  Текст, задолженность по валютам
@param[out] resultCode 1 - есть задолженность, 0 - нет задолженности
*/
macro FindDebtAll(sfcontrId: integer, dlContrPrm: object,  resultDesc: @string, resultCode: @integer)
  var sql            :String,
      cmd            :Object,
      err_txt        :String,
      errObj         :Object;

  sql = " DECLARE "
   + "      v_debts debt_table := debt_table(); "
   + "      v_dlcontrid number:= ?; "
   + "      v_result_desc VARCHAR2(4000):= ' '; "
   + "      v_result_code NUMBER:= 0; "
   + "   BEGIN "
   + "      WITH DEBT_SUM AS  "
   + "         (SELECT SUM(sfdef.t_Sum) as debtVal, "
   + "                 com.t_Code as debtType, "
   + "                 mp.t_DlContrID as DlContrID, "
   + "                 sfdef.t_FIID_Sum as Currency "
   + "            FROM dsfcomiss_dbt com, dsfdef_dbt sfdef, ddlcontrmp_dbt mp "
   + "           WHERE com.t_Code in ('БрокерФикс', 'ИнвестСоветник') "
   + "             AND sfdef.t_FeeType = 1 "
   + "             AND sfdef.t_CommNumber = com.t_Number "
   + "             AND sfdef.t_Status = 10 "
   + "             AND mp.t_SfContrID = sfdef.t_SfContrID "
   + "             AND mp.t_DlContrID = v_dlcontrid "
   + "             AND sfdef.t_PlanPayDate < SYSDATE/*<ChangeDate>*/ "
   + "            GROUP BY mp.t_DlContrID, com.t_Code, sfdef.t_FIID_Sum), "
   + "      DEBT_EXPIRED AS "
   + "         (SELECT SUM(rstr.t_DebtSum) as debtVal, "
   + "                 'Прочая задолженность' as debtType, "
   + "                 rstr.t_DlContrID as DlContrID, "
   + "                 rstr.t_DebtCurrency as Currency "
   + "            FROM ddl_debtreestr_dbt rstr "
   + "           WHERE rstr.t_DebtSum <> 0 "
   + "             AND rstr.t_DebtDate <= SYSDATE/*<ChangeDate>*/ "
   + "             AND rstr.t_State = 1/*DEBTREESTR_STATE_ACTIVE*/ "
   + "             AND rstr.t_DlContrID = v_dlcontrid "
   + "             AND Rsb_Secur.GetMainObjAttr(207, LPAD(rstr.t_DlContrID, 34, '0'), 105, SYSDATE/*<ChangeDate>*/) <> 1 "
   + "           GROUP BY rstr.t_DlContrID, rstr.t_DebtCurrency), "
   + "      DEBT_DEAL_COM_2023 AS "
   + "         (SELECT SUM(u.t_ReqSum - u.t_Payed_Tr) as debtVal, "
   + "                 'Долг 2023 года' as debtType, "
   + "                 u.t_DlContrID as DlContrID, "
   + "                 u.t_FIID as Currency "
   + "            FROM u_compay_dbt u " 
   + "           WHERE u.t_CalcID = (SELECT MAX(u1.t_CalcID) FROM u_compay_dbt u1) "
   + "             AND u.t_SysDate IS NOT NULL "
   + "             AND (u.t_ReqSum - u.t_Payed_Tr) <> 0 "
   + "             AND u.t_DlContrID = v_dlcontrid "
   + "           GROUP BY u.t_DlContrID, u.t_FIID), "
   + "   AllDebtSum as (  "
   + "    SELECT Currency, SUM(debtVal) as debtVal, dlcontrid "
   + "      FROM (SELECT * FROM DEBT_SUM "
   + "            UNION ALL "
   + "            SELECT * FROM DEBT_EXPIRED "
   + "            UNION ALL "
   + "            SELECT * FROM DEBT_DEAL_COM_2023) "
   + "      GROUP BY dlcontrid, Currency) "
   + "    SELECT debt_row_type(Currency, debtVal, dlcontrid) "
   + "      BULK COLLECT INTO v_debts "
   + "      FROM AllDebtSum; "
   + "    IF v_debts.COUNT > 0 THEN "
   + "      WITH REST_SUM AS    "
   + "         (SELECT t_Code_Currency,  "
   + "               RSB_Account.restac(t_Account, t_Code_Currency, sysdate, t_Chapter, null) t_Rest,  "
   + "               t_ccy,  "
   + "               t_dlcontrid  "
   + "         FROM (SELECT DISTINCT acc.t_AccountID, acc.t_Account, acc.t_Chapter, acc.t_Code_Currency, sf.t_PartyID, fin.t_ccy, "
   + "                     mp.t_dlcontrid  "
   + "                  FROM ddlcontrmp_dbt mp, dsfcontr_dbt sf, dmccateg_dbt cat, dmcaccdoc_dbt mc, daccount_dbt acc,DFININSTR_DBT FIN   "
   + "                  WHERE mc.t_CatID = cat.t_ID "
   + "                  AND mc.t_Owner = sf.t_PartyID  "
   + "                  AND mc.t_ClientContrID = sf.t_ID "
   + "                  AND mc.t_IsCommon = 'X'  "
   + "                  AND acc.t_Account = mc.t_Account  "
   + "                  AND acc.t_Chapter = mc.t_Chapter  "
   + "                  AND acc.t_Code_Currency = mc.t_Currency  "
   + "                  AND acc.t_Open_Date <= sysdate  "
   + "                  AND acc.t_Close_Date = TO_DATE('01.01.0001','DD.MM.YYYY') "
   + "                  AND cat.t_LevelType = 1  "
   + "                  and mp.t_dlcontrid = v_dlcontrid "
   + "                  AND FIN.T_FIID = acc.t_code_currency  "
   + "                  AND cat.t_Code in ('ДС клиента, ц/б')  "
   + "                  AND sf.t_ID = mp.t_SfContrID)),   "
   + "         itog as (      "      
   + "         ( SELECT debtVal,  "
   + "               t_Rest,  "
   + "               t_dlcontrid,  "
   + "               t_Code_Currency,   "
   + "               t_ccy   "
   + "         FROM   "
   + "         (SELECT SUM(t_Rest) AS t_Rest,  "
   + "               t_dlcontrid,   "
   + "               t_Code_Currency,   "
   + "               t_ccy  "
   + "         FROM rest_sum r   "
   + "         GROUP BY t_dlcontrid,t_Code_Currency,t_ccy) t  "
   + "         INNER JOIN TABLE(v_debts) d   "
   + "                     ON t.t_Code_Currency = d.currency   "
   + "                  AND t.t_dlcontrid = d.dlcontrid   "
   + "         WHERE t.t_Rest < d.debtVal   "
   + "         ))  "
   + "         SELECT LISTAGG(REPLACE(TO_CHAR(debtVal),',','.') || '-' || t_ccy || '*', ', ') WITHIN GROUP (ORDER BY t_Code_Currency) as result_desc  "
   + "         INTO v_result_desc  "
   + "         FROM itog;   "
   + "         IF TRIM(v_result_desc) IS NOT NULL THEN  "
   + "           v_result_code:= 1;  "
   + "         END IF;  "
   + "      END IF; "
  
   + "   :p_desc := v_result_desc;  "
   + "   :p_code := v_result_code;  "
   + "   EXCEPTION   "
   + "      WHEN OTHERS  "
   + "            THEN "
   + "     :p_desc := SQLERRM;  "
   + "     :p_code := -1;  "
   + "   END; "; 


  cmd = RSDCommand(sql);
  cmd.AddParam("Dlcontrid",   RSDBP_IN, dlContrPrm.rec.DLCONTRID);

  cmd.addParam("p_desc",  RSDBP_OUT, V_STRING, 1000);
  cmd.addParam("p_code",  RSDBP_OUT, V_INTEGER);
  cmd.Execute(); 

  resultDesc  =  SQL_ConvTypeStr(cmd.value("p_desc"));
  resultCode  = cmd.value("p_code");

  cmd.close(); cmd = NULL;

  if(resultCode == 1)
      err_txt = String(dlContrPrm.rec.number,". Невозможно сменить тарифный план на Трейдер по причине наличия на ДБО задолженности.");
      errObj = c_err_obj(err_txt,"200");
      g_err_arr(g_err_arr.size) = errObj;

      sendEmailDebt(dlContrPrm.rec.DLCONTRID, 
                    dlContrPrm.rec.PartyID, 
                    dlContrPrm.rec.Name, 
                    dlContrPrm.rec.datebegin, 
                    dlContrPrm.rec.number, 
                    resultDesc);

  end;

onerror(e)
   err_txt = "Ошибка проверки наличия задолженности при смене тарифного плана, для ДБО с номером " + dlContrPrm.rec.number;
   RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
end;

// BIQ-8786 тарифные планы
// _TariffList заведомо заполнен и является массивом
macro UpdateTarifContract(_TariffList, _sfcontrid, _dlid, _DlContrPrm)
   var new_planid = -1;
   var temp_tariff;
   var state = true;
   var rs, cmd, sql_str;
   var err_txt;
   var new_plan = TArray;
   var temp_new_plan;
   var temp_sf;
   var sfid_list = TArray;
   var ai;
   var tarif_repo = TArray;
   var temp_tarif_repo;
   var flag_ya = false;
   var resultDesc = "";
   var resultCode = 0;
   var isVeiwDebt = false;
   
   private class c_sf_tp
      var sfcontrid = 0;
      var sfplanid = 0;
      var ind = 0;
      var sfdatebegin = date();
   end;
   
   sql_str ="select sf.t_sfcontrid, sp.t_sfplanid, sf.t_datebegin, "+
            "       nvl((select 1 from dobjatcor_dbt at where at.t_objecttype = 57 and at.t_groupid = 101 "+
            "              and at.t_attrid = 1 and at.t_object = lpad(sp.t_sfplanid,10,'0') and at.t_validtodate > sysdate),0) as ind "+
            "  from ( "+
            "     select t_id as t_sfcontrid, t_datebegin from dsfcontr_dbt where t_id = :sfid "+
            "        union "+
            "     select mp.t_sfcontrid, sf.t_datebegin "+
            "       from ddlcontrmp_dbt mp, dsfcontr_dbt sf "+
            "      where sf.t_id = mp.t_sfcontrid and sf.t_dateclose = to_date('01010001','ddmmyyyy') "+
            "        and mp.t_dlcontrid = :dlid ) sf, "+
            "     dsfcontrplan_dbt sp "+
            " where sf.t_sfcontrid = sp.t_sfcontrid and sp.t_begin <= sysdate and (sp.t_end = to_date('01010001','ddmmyyyy') or sp.t_end >= sysdate)";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("sfid", RSDBP_IN, _sfcontrid);
   cmd.AddParam("dlid", RSDBP_IN, _dlid);
   rs = RSDRecordSet(cmd);
   sfid_list.size = 0;
   ai = 0;
   temp_sf = null;
   while (rs.moveNext)
      temp_sf = c_sf_tp;
      temp_sf.sfcontrid = Int(rs.value("t_sfcontrid"));
      temp_sf.sfplanid = Int(rs.value("t_sfplanid"));
      temp_sf.ind = Int(rs.value("ind"));
      temp_sf.sfdatebegin = rs.value("t_datebegin");
      sfid_list.value(ai) = temp_sf;
      ai = ai+1;
      temp_sf = null;
   end;
   
   sql_str = "select t_sfplanid from dsfplan_dbt where t_num = :n";
   new_plan.size = 0;
   tarif_repo.size = 0;
   for (temp_tariff, _TariffList)
      flag_ya = false;
      if (Valtype(temp_tariff.UnbindDate) != V_UNDEF)
         if ( (temp_tariff.UnbindDate == date(0,0,0)) or (temp_tariff.UnbindDate == " 1.01.0001") or (temp_tariff.UnbindDate > date()) )
            flag_ya = true;
         end;
      else 
         flag_ya = true;
      end;
      if (flag_ya)
         if (temp_tariff.TariffKind.RecordCode == "BROKERAGE")
            temp_new_plan = c_Tariff_In;
            temp_new_plan.TariffId = -1;

            cmd = RSDCommand(sql_str);
            cmd.AddParam("n", RSDBP_IN, Int(temp_tariff.TariffId.Objectid));
            cmd.AddParam("dlid", RSDBP_IN, _dlid);
            rs = RSDRecordSet(cmd);
            if (rs.movenext)
               temp_new_plan.TariffId = rs.value(0);
            end;
            if (temp_new_plan.TariffId == -1)
               err_txt = "Тариф "+temp_tariff.TariffId.Objectid+" не найден";
               RunError(err_txt, c_err_obj(err_txt, "004"));
            end;
            temp_new_plan.TariffPlan = temp_tariff.TariffPlan.RecordCode;
            temp_new_plan.BindDate = temp_tariff.BindDate;
            temp_new_plan.UnbindDate = temp_tariff.UnbindDate;
            temp_new_plan.IsIndividual = temp_tariff.IsIndividual;
            new_plan.value(new_plan.size) = temp_new_plan;
            temp_new_plan = null;
         elif (temp_tariff.TariffKind.RecordCode == "REPO")
            temp_tarif_repo = c_Tariff_In;
            temp_tarif_repo.TariffId   = temp_tariff.TariffId.Objectid;
            temp_tarif_repo.TariffPlan = temp_tariff.TariffPlan.RecordCode;
            temp_tarif_repo.BindDate   = temp_tariff.BindDate;
            temp_tarif_repo.UnbindDate   = temp_tariff.UnbindDate;
            temp_tarif_repo.IsIndividual = temp_tariff.IsIndividual;
            tarif_repo.value(tarif_repo.size) = temp_tarif_repo;
         end;
      end;
      
   end;
   
   if (new_plan.size == 0) // нет ни одного действующего
      err_txt = "В списке тарифов не найдено ни одного действующего";
      RunError(err_txt, c_err_obj(err_txt, "004"));
   else 
      ai = 0;
      while (ai < new_plan.size)
         if (ValType(new_plan.value(ai).binddate) == V_UNDEF) 
            new_plan.value(ai).binddate = date();
         end;
         if ( new_plan.value(ai).binddate == date(0,0,0)) 
            new_plan.value(ai).binddate = date();
         end;

         if (ValType(new_plan.value(ai).unbinddate) == V_UNDEF)  
            new_plan.value(ai).unbinddate = date(0,0,0);
         end;

         if (ValType(new_plan.value(ai).IsIndividual) == V_UNDEF)  
            new_plan.value(ai).IsIndividual = false;
         end;

         ai = ai+1;
      end;
      qsort(new_plan, "binddate_asc"); // упорядочим по дате начала тарифа, так как не можем вставлять ТП в середину периода
   end;

   if (tarif_repo.size > 0) 
      qsort(tarif_repo, "binddate_asc"); // упорядочим по дате начала тарифа, так как не можем вставлять ТП в середину периода
   end;
   
   for (temp_sf, sfid_list)
      for (temp_new_plan, new_plan)
         if (temp_new_plan.IsIndividual) // DEF-48137 индивидуальные тарифы игнорируем
         else 
            if ( (temp_sf.sfplanid == temp_new_plan.TariffId) and (temp_new_plan.BindDate <= date()) ) // текущий план совпадает
            else
               if (temp_sf.sfdatebegin > temp_new_plan.BindDate)
                  temp_new_plan.BindDate = temp_sf.sfdatebegin;
               end;
               //Если новый текущий план Трейдер, проверяем задолженность
               if(not isVeiwDebt and (temp_new_plan.TariffId == 17))
                  FindDebtAll(_sfcontrid, _DlContrPrm, @resultDesc, @resultCode);
                  isVeiwDebt = true;

                  if(resultCode > 0) 
                     g_flag_debt = true;
                  end;
               end;
               
               if (resultCode == 0)
                  state  = SfContrChangeSfPlan(temp_sf.sfcontrid, temp_new_plan.TariffId, temp_new_plan.BindDate, false);
                  if(state != 0)
                     err_txt = String("Ошибка смены тарифа ",temp_sf.sfplanid ," на ",temp_new_plan.TariffId," ",temp_new_plan.TariffPlan,": ",GetErrMessage(state));
                     RunError(err_txt, c_err_obj(err_txt, "004"));
                  end;
               end;
            end; // if
         end;
      end; // for temp_new_plan
   end; // for temp_sf
 
   if ((tarif_repo.size > 0) and not g_flag_debt)
      AddTariffRepo(tarif_repo, 207, String(_dlid:o:34));
   end;

onerror(e)
   err_txt = e.message + getFullCmdErrorText(cmd);
   SetPersonAddDBLog(err_txt);
   RunError(err_txt, c_err_obj(err_txt, "004"));
end;

// DEF-36714
macro UpdateNameSubContract(p_dlcontr_id, p_partyname)
   var sql_str, cmd;
   var err_txt;

   sql_str = "UPDATE dsfcontr_dbt "+
             "   SET t_name = :pname1 "+
             " WHERE t_id in ( SELECT t_sfcontrid FROM ddlcontrmp_dbt where t_dlcontrid = :pdlid) "+
             "   AND t_name <> :pname2 ";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("pname1",RSDBP_IN, p_partyname);
   cmd.AddParam("pdlid" ,RSDBP_IN, p_dlcontr_id);
   cmd.AddParam("pname2",RSDBP_IN, p_partyname);
   cmd.execute;
   cmd.close;
   cmd = null;

onerror(e)
   err_txt = e.message + getFullCmdErrorText(cmd);
   SetPersonAddDBLog(err_txt);
   RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
end;



/**
@brief   			Добавление fiid в список разрешенных валют (список используется при открытии счетов для проверки), см. DEF-68239
@param[in] fiid       		Валюта для добавления
@param[out] ValidList   	Строка со списком разрешенных валют
@param[out] ValidDelimiter   	Символ-разделитель
*/
macro AddValidFiid(fiid: integer, ValidList: @string, ValidDelimiter: @string)
  var fiidStr: string = string(fiid);
  if(Index(ValidList, fiidStr) <= 0) 
    ValidList = ValidList + ValidDelimiter + fiidStr;
    ValidDelimiter = ",";
  end;
end;

macro PutCatForEmptyValue(_objcat, _groupid, _attrid, _date)
   var Attrcode = 0;
   var stat = 0;

   if (_objcat.GetMainAttr(_groupid, date(), attr, attrcor ) == 0)
     if (attrcor.attrid > 0) // категория уже установлена
        Attrcode = 0;
     else 
        Attrcode = _attrid;
     end;
   else 
     Attrcode = _attrid;
   end;
   if (Attrcode > 0)
      stat = _objcat.ConnectAttr(_groupid, Attrcode, NULL, NULL, _date );
   end;
   return stat;
end;


/* Непосредственное открытие брокерского договора*/
macro OpenContract(_partyid, _AgreementInfoList, _email_contract, _FinConsBrok, inConditionDate, out_dlcontrid:@TArray)
   private var err_txt;
   var stat;
   record fininstr(fininstr);
   
   var DlContrPrm;
   var DlContrMp;
   //var party_rec = RSBParty(_partyid); // нельзя использовать одновременно с DL_AddSubContrToDLCONTR
   
   var short_code, tarif_id = 0, short_code_sub;
   var nextval;
   var short_code_exist;

   var sub_id, rs;
   var sql_str, cmd;
   var dlcontr_id, ssi_FIID;
   
   var AgreementInfo, TradingPlatformInfo, TradingPlatformCurrency;
   var ServKind, ServKindSub, SubName, SubNumber, filialcode, pos;
   
   var partyid_found;
   var date_sub;
   
   var new_ed = false;
   var new_sub = false;

   var SubContr;
   var SubContrArr = TArray;

   var STOCK_acc_arr = TArray;
   var STOCK_OVER_acc_arr = TArray;
   var FORTS_acc_arr = TArray;
   var CURRENCY_acc_arr = TArray;
   var SPB_acc_arr = TArray;

   var FIID_LIST: string = "";
   var FIID_DELIMITER: string = ""; 

   var fiid_sub, fiid_sub_arr = TArray;
   var ai, ai_acc;
   var subcontr_temp, flag_subcontr;

   var partyname, partyname_short;
   var exist_email, usequik, new_quik;
   var IsIIS = false;
   var sfcontr_SERVKIND, sfcontr_SUBKIND, sfcontr_marketid;
   var dlcontr_id_number, partyid_number, partycode_number;

   var objecttype = 207, objectid;
   var FinConsBrok, FinConsBrok_exist;
   var ObjCat;
   var RiskLevelBrok_exist, IsCurrentAccounts_exist, IsQuik_exist;
   var Conditiondate_exist; 

   var v_email_processor;
   var v_email_head;
   var v_email_body;

   var HasAnotherStock = -1;

   var objecttype_sub = 659;
   var objectid_sub;
   var MMVB_value, MMVB_sub_code;
   var v_currency_list, temp_str, temp_single, ai_cur = 0;
   var MMVB_value_exist;
 
   var NewSubContractIDs = TArray;

   // BIQ-8786 тарифные планы
   // Тариф обслуживания передается внутри AgreementInfo
   //tarif_id = FindBasicTarif();     // тариф "Базовый"
   var tarif_id_repo = TArray;
   var tarif_id_brok = TArray;
   var new_sfcontrid = -1;
   
   var need_close = false;
   // BIQ-7382 Признак выгрузки ETL в Депозитарий
   var v_etl = uGetRegistryParam(DEPO_UNLOAD_TYPE, V_BOOL);

   //dan получим текущее значение FirmID
   var CurFirmID = GetCurFirmID();
   
   out_dlcontrid = TArray;

   // BIQ-7785, в настройке дата начала ЕПД
   var flag_edp = false;
   var Attrcode=0;
   var EdpDate = "", getreg = GetRegistryValue ("РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ДАТА ВКЛЮЧЕНИЯ ЕДП", V_STRING, EdpDate );
   if (ValType(getreg) != V_UNDEF)
      if ((EdpDate != "00.00.0000") and ({curdate} >= date(EdpDate)))
         flag_edp = true;
      end;
   end;

   // BIQ-7041 биржа СПБ
   var marketid;
   var marketid_moex = ПолучитьБиржуПоВидуКодаДБО(DLCCK_USC); // по умолчанию ММВБ
   var marketid_spb = ПолучитьБиржуПоВидуКодаДБО(DLCCK_SPB_BIDCODE); 
   var stock_codekind = CODEKIND_DLCONTR_MOEX;
   var old_subid = TArray;

   var flag_spb = false;
   var SpbDate = "";
   getreg = GetRegistryValue ("РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ДАТА ВКЛЮЧЕНИЯ СПБ", V_STRING, SpbDate);
   if (ValType(getreg) != V_UNDEF)
      if ((SpbDate != "00.00.0000") and ({curdate} >= date(SpbDate)))
         flag_spb = true;
      end;
   end;

   // gtv: для ЕДП счетчик для acccode для биржи (t_servkindsub = 8) запускаем один раз
   var new_acccode = "";
   var accrec_edp = TRecHandler("account.dbt"); // первый открытый счет, чтобы не запускать открытие по другим площадкам
   var date_sub_exist, acccode_exist;

   // BIQ-7426 Гераськина Т.В. будем возвращать список кодов ЕКК
   var EKK_MOEX, EKK_SPB;
   var MarketCode = TArray;
   var tmp_MarketCode; 

   var contract_vtb = c_contract_vtb();

   // gtv: для кодов ЕКК
   SetGlobalParameter("CodeContractEKK", "");
   
   var v_sfcontrid;

   for (AgreementInfo, _AgreementInfoList)
      if ((ValType(AgreementInfo.IsIISContract) != V_UNDEF) and (AgreementInfo.IsIISContract))
         IsIIS = true;
      else
         IsIIS = false;
      end;
      g_flag_debt = false;
      FinConsBrok_exist = NULL;
      RiskLevelBrok_exist = NULL;
      IsCurrentAccounts_exist = NULL;
      Conditiondate_exist = NULL;
      ObjCat = NULL;
      dlcontr_id = FindDlContrByNumberAndClient(_partyid, AgreementInfo.AgreementNumber, @exist_email, @usequik, @v_sfcontrid);
      if (dlcontr_id < 0)
         dlcontr_id_number = FindDlContrByNumber(AgreementInfo.AgreementNumber, @partyid_number);
         if (dlcontr_id_number > 0)  // договор найден
           if (_partyid != partyid_number)
              partycode_number = GetPartyCode_ByNumber(partyid_number, PTCK_CONTR);
              err_txt = "Договор "+AgreementInfo.AgreementNumber+" открыт на другого клиента: "+partycode_number;
              RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
           end;
         end;
      else
         objectid = String(dlcontr_id:o:34);
         FinConsBrok_exist = readNoteForObject( ObjectType, objectid, CONTRACT_NOTEKIND_CONS );
         Conditiondate_exist = readNoteForObject( ObjectType, objectid, CONTRACT_NOTEKIND_CONDITIONDATE );
                          
         ObjCat = RsbObjCategories(ObjectType, objectid);
         if (ObjCat.GetMainAttr( CONTRACT_CATEGORY_RISKLEVEL, date(), attr ) == 0)
            RiskLevelBrok_exist = attr.Numinlist;
         end;
         if (ObjCat.GetMainAttr( CONTRACT_CATEGORY_ISCURRENTACCOUNTS, date(), attr ) == 0)
            IsCurrentAccounts_exist = attr.Numinlist;
         end;
         // абсолютно все равно, что там заполнено
         /*if (ObjCat.GetMainAttr( CONTRACT_CATEGORY_ISQUIK, date(), attr ) == 0)
            IsQuik_exist = attr.Numinlist;
         end;    */

         ObjCat = NULL;
      end;

      tarif_id_brok = FindTarifFromTariffList(AgreementInfo.TariffList, tarif_id_repo);
      if (tarif_id_brok.size == 0)
         err_txt = "Тариф не найден";
         RunError(err_txt, c_err_obj(err_txt, "004"));
      elif (tarif_id_brok.size == 1)
         tarif_id = tarif_id_brok.value(0).TariffId;
      else 
         qsort(tarif_id_brok, "binddate_asc");
         tarif_id = tarif_id_brok.value(0).TariffId;
      end;

      g_accrec_arr.size = 0;

      partyname_short = GetPartyName(_partyid, true);
      partyname = GetPartyName(_partyid, false);

      if (dlcontr_id < 0) // договор не найден, открываем
         new_ed = true;

         // код не ищем, а генерим заново для ЕД
         /*if (IsIIS)
            short_code = "";
         end;*/
         short_code = "";

         if (not short_code)     // для ЕД не нужно, только для площадок UPD: оказалось, что нельзя оставлять код пустым, так как генерируется внутренним механизмом при открытии ЕД 
            short_code = GeneratePersonalCode(_partyid, IsIIS, false, DO_SERVKIND_STOCKDL);    // Единый код на бирже
            // без доп.проверок. Доп.проверки при заведении площадки
            ServPutIntoTrace("Сгенерирован ЕКК: "+short_code);
         end;
         SetGlobalParameter("CodeContractEKK", short_code);
                                                 
         // открытие ЕД
         DlContrPrm = TRecHandler("dlcontrprm.rec");
         DlContrPrm.Clear;
         DlContrPrm = InitDlContrPrm();
         // обычный единый договор
         // единый брокерский договор
         pos = Index(AgreementInfo.AgreementNumber,"-");
         if (pos > 0)
            filialcode = GetFilialCode(Substr(AgreementInfo.AgreementNumber,1,pos-1)+"00");
         else
            filialcode = 1;
         end;
         
         DlContrPrm.rec.DEPARTMENT = {OperDprt};
         DlContrPrm.rec.NUMBER     = AgreementInfo.AgreementNumber;
         DlContrPrm.rec.DATEBEGIN  = AgreementInfo.AgreementDate;
         DlContrPrm.rec.NAME       = partyname_short; //"Единый договор БО";  
         DlContrPrm.rec.UNIDEPOCONTRID = 0; 
         DlContrPrm.rec.PARTYID    = _partyid; 
//         DlContrPrm.rec.MARKETCODE = short_code;
         DlContrPrm.rec.PLANID     = tarif_id;
         DlContrPrm.rec.USESUBACC  = StrFor(0);
         if (ValType(AgreementInfo.IsQuik) != V_UNDEF)  // признак квика
//           if ( (AgreementInfo.IsQuik == "СКПЭП") or (AgreementInfo.IsQuik == "QUIK") ) 
           if ( (AgreementInfo.Quik_) or (AgreementInfo.SKP_) )
              DlContrPrm.rec.USEQUIK = StrFor(88);
           end;
         end;
         if (AgreementInfo.IsAnotherContract)
           DlContrPrm.rec.iistransfer        = "X";  // чекбокс "Переводом от налогового агента:"
           DlContrPrm.rec.iisfirstdate       = "00.00.00"; // поле "ИИС впервые открыт"
           DlContrPrm.rec.iisfirstbrokername = "\x01"; // поле "у налогового агента"
           DlContrPrm.rec.iisfirstnumber     = "\x01"; // поле "№ договора"
         end;

  
         if (ValType(_email_contract) != V_UNDEF)
            DlContrPrm.rec.EMAIL = _email_contract;
         end;

         if (IsIIS)
            DlContrPrm.rec.IIS = StrFor(88);
            if ((ValType(AgreementInfo.IISType) == V_UNDEF) or (AgreementInfo.IISType == "")) 
               DlContrPrm.rec.IISType = DLCONTR_IISTYPE_IIS;
            elif (AgreementInfo.IISType == "ИИС3")
               DlContrPrm.rec.IISType = DLCONTR_IISTYPE_IIS3;
               if ((ValType(AgreementInfo.IsLimitContract) != V_UNDEF) and (AgreementInfo.IsLimitContract)) 
                  DlContrPrm.rec.IIS3NotMore2 = StrFor(88);
               end;
               if ((ValType(AgreementInfo.IsOldIISContract) != V_UNDEF) and (AgreementInfo.IsOldIISContract)) 
                  DlContrPrm.rec.IISNotExistOldType = StrFor(88);
               end; 
            else
               err_txt = "Непредвиденное значение IISType";
               RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
            end;
         end;

         date_sub = AgreementInfo.AgreementDate;

//         ServPutIntoTrace("DlContrPrm.rec.MARKETCODE: "+DlContrPrm.rec.MARKETCODE);

      else
         new_ed = false;

         //short_code = GetPartyCode_ByNumber(_partyid, PTCK_MICEX);
         // код не ищем, а генерим заново всегда
         date_sub = {curdate};

         if ( (ValType(_email_contract) != V_UNDEF)  // во входящем XML есть почта
               or 
              (ValType(AgreementInfo.IsQuik) != V_UNDEF)  // признак квика
               or
              (ValType(AgreementInfo.IsTransformationFlag) != V_UNDEF) // признак трансформации ИИС
             )
             
              DlContrPrm = TRecHandler("dlcontrprm.rec");
              stat = DL_Fill_DLContrPrmByDLContr(DlContrPrm, dlcontr_id, tarif_id, short_code); 


              if (  (ValType(_email_contract) != V_UNDEF) and 
                    ( (ValType(exist_email) == V_UNDEF)  // не задана в текущем договоре
                      or ( (ValType(exist_email) != V_UNDEF) and  (StrUpr(exist_email) != StrUpr(_email_contract)) ) // задана, но не совпадает
                     ) 
                 )    
                 DlContrPrm.rec.EMAIL = _email_contract;
              end;
              if (ValType(AgreementInfo.IsQuik) != V_UNDEF)
//                 if ( (AgreementInfo.IsQuik == "СКПЭП") or (AgreementInfo.IsQuik == "QUIK") ) 
                 if ( (AgreementInfo.Quik_) or (AgreementInfo.SKP_) )
                    new_quik = strfor(88);
                 else
                    new_quik = strfor(0);
                 end;

                 if ( (ValType(usequik) == V_UNDEF)  // не задан в текущем договоре
                        or ( (ValType(usequik) != V_UNDEF) and  (usequik != new_quik) ) // задана, но не совпадает
                    )
                    DlContrPrm.rec.USEQUIK = new_quik;
                 end;
              end; 

              if ((ValType(AgreementInfo.IsTransformationFlag) != V_UNDEF) and (AgreementInfo.IsTransformationFlag))
                 if (DlContrPrm.rec.IISIsTransformed != StrFor(88)) // ранее трансформация не обрабатывалась
                    if ((DlContrPrm.rec.IISType == DLCONTR_IISTYPE_IIS) and (ValType(AgreementInfo.IISType) != V_UNDEF) and (AgreementInfo.IISType == "ИИС3")) 
                       DlContrPrm.rec.IISType = DLCONTR_IISTYPE_IIS3;
                       DlContrPrm.rec.IISIsTransformed = StrFor(88);
                       if (ValType(AgreementInfo.TransformationDate) != V_UNDEF)
                          DlContrPrm.rec.IISTransformDate = AgreementInfo.TransformationDate;
                       end;
                       DlContrPrm.rec.IIS3NotMore2 = StrFor(88);
                       DlContrPrm.rec.IISNotExistOldType = StrFor(88);
                    else
                       err_txt = "Невозможно обработать трансформацию договора ИИС. Параметры Типа ИИС текущего договора и договора из сообщения не соответствуют";
                       RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
                    end;
                 end;
              end;

              // DEF-36714 смена ФИО
              if (DlContrPrm.rec.Name != partyname_short)
                 DlContrPrm.rec.Name = partyname_short;
                 // обработка площадок ниже, но все равно там не API, так что обновим всех сразу
                 // в случае ошибки транзакция откатится целиком
                 // история изменения имени субъекта фиксируется в Alt+H самого субъекта, на договоре следов не будет
                 UpdateNameSubContract(dlcontr_id, partyname);
                 // DEF-35472 наименования счетов
                 execmacrofile("dlcontrfunc", "ChangeNameAccount", _partyid);

              end;

              stat = DL_UpdateDLCONTR(DlContrPrm, err_txt); 
              if (stat != 0)
                 RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
              end;

               UpdateTarifContract(AgreementInfo.TariffList, v_sfcontrid, dlcontr_id, DlContrPrm);
              //заменить на функцию обновления
              //UpdateContractEmail(dlcontr_id, _email_contract);
         end;

         objectid = String(dlcontr_id:o:34);
         if (ValType(_FinConsBrok) != V_UNDEF)  // во входящем XML есть фин.консультант
            if (    (ValType(FinConsBrok_exist) == V_UNDEF)  // не задано в текущем договоре
                 or ( (ValType(FinConsBrok_exist) != V_UNDEF) and  (StrUpr(FinConsBrok_exist) != StrUpr(_FinConsBrok)) ) // задано, но не совпадает
                )
              stat = addNoteForObject(objecttype, objectid, CONTRACT_NOTEKIND_CONS, _FinConsBrok);
              if(stat)
                err_txt = "Ошибка добавления примечания к документу";
                RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
              end;
            end;
         end;

         if (ValType(AgreementInfo.ConditionDate) != V_UNDEF) 
            // если основные данные измененились
            if ((ValType(Conditiondate_exist) != V_UNDEF) and  (AgreementInfo.ConditionDate > Conditiondate_exist ))
               CheckAndPushUnloadQUIKBroker(_partyid,false);
            end;
            if (    (ValType(Conditiondate_exist) == V_UNDEF)  // не задано в текущем договоре
                 or ( (ValType(Conditiondate_exist) != V_UNDEF) and  (Conditiondate_exist != AgreementInfo.ConditionDate) ) // задано, но не совпадает
                )
               stat = addNoteForObject(objecttype, objectid, CONTRACT_NOTEKIND_CONDITIONDATE, AgreementInfo.ConditionDate);
               if(stat)
                 err_txt = "Ошибка добавления примечания к документу";
                 RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
               end;  
            end;

         end;
         
         contract_vtb = FindContractMatch(_partyid, IsIIS);
         if (contract_vtb.r != "-1");
            stat = addNoteForObject(objecttype, objectid, CONTARCT_NOTEKIND_VTB_CONTRACTNUM, contract_vtb.contract_number);
            if(stat)
              err_txt = "Ошибка добавления примечания к документу";
              RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
            end;  
            stat = addNoteForObject(objecttype, objectid, CONTARCT_NOTEKIND_VTB_CONTRACTDATE, contract_vtb.contract_date);
            if(stat)
              err_txt = "Ошибка добавления примечания к документу";
              RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
            end;  
            UpdateContractmatch(contract_vtb.r, dlcontr_id);
         end;
      

         SetContractCategories(AgreementInfo, objecttype, objectid, RiskLevelBrok_exist, IsCurrentAccounts_exist, @need_close);

         // сразу заполним существующие счета
         FillExistAccounts(dlcontr_id);
//DEF-72454
         var err;
         GetMainObjAttr(err, objecttype, String(dlcontr_id:o:34), CONTRACT_CATEGORY_STATUS, AttrCode);
         if (AttrCode == 3) // обработка завершена
            InsEvent_UpdateContract(dlcontr_id, 1); /* DEF-64455 */
         end;

      end;
      
      STOCK_acc_arr.size = 0;
      STOCK_OVER_acc_arr.size = 0;
      FORTS_acc_arr.size = 0;
      CURRENCY_acc_arr.size = 0;
      SPB_acc_arr.size = 0;

      // валюты для валютной биржи
      v_currency_list        = uGetRegistryParam(CURRENCY_LIST, V_STRING);
      ai_cur = 0;
      if ( (ValType(v_currency_list) != V_UNDEF) and (StrLen(Trim(v_currency_list)) > 0) )
         temp_str = v_currency_list;
         temp_single = "";
         pos = Index(temp_str,",");
         while (pos > 0)
            temp_single = Substr(temp_str,1,pos-1);
            if (temp_single == "RUR") temp_single = "RUB" end; // на всякий случай
            if (ПолучитьФинИнПоISO (temp_single, fininstr))
               CURRENCY_acc_arr.value(ai_cur) = fininstr.FIID;
               AddValidFiid(fininstr.FIID, @FIID_LIST, @FIID_DELIMITER);  // DEF-68239, добавляем валюту к списку FIID_LIST
               ai_cur = ai_cur + 1;
            else 
               // не найдено - ничего не делаем
            end;
            temp_str = Substr(temp_str,pos+1);
            pos = Index(temp_str,",");
         end;
         if ( StrLen(temp_str) > 0 )
            if (temp_str == "RUR") temp_str = "RUB" end; // на всякий случай
            if (ПолучитьФинИнПоISO (temp_str, fininstr))
               CURRENCY_acc_arr.value(ai_cur) = fininstr.FIID;
               AddValidFiid(fininstr.FIID, @FIID_LIST, @FIID_DELIMITER);  // DEF-68239, добавляем валюту к списку FIID_LIST
               ai_cur = ai_cur + 1;
            else 
               // не найдено - ничего не делаем
            end;
         end;
      else
         CURRENCY_acc_arr.value(0) = 19;
         CURRENCY_acc_arr.value(1) = 8;
         CURRENCY_acc_arr.value(2) = 20;
         CURRENCY_acc_arr.value(3) = 0;
         CURRENCY_acc_arr.value(4) = 7;
         FIID_LIST = "0,7,8,19,20"; // DEF-68239, cписок для проверки валют
      end;

      // gtv: для ЕДП счетчик для acccode для биржи (t_servkindsub = 8) запускаем один раз
      if (flag_edp)
         new_acccode = "";
      end;


      if (ValType(AgreementInfo.TradingPlatformsList) != V_UNDEF)

         for (TradingPlatformInfo, AgreementInfo.TradingPlatformsList)
            // открытие субдоговоров

            // валюты
            TradingPlatformCurrency = TradingPlatformInfo.TradingPlatformCurrency.RecordCode;
            if (TradingPlatformCurrency == "RUR") TradingPlatformCurrency = "RUB" end;
            if (ПолучитьФинИнПоISO (TradingPlatformCurrency, fininstr))
            else
               err_txt = "Не найдена валюта с кодом: "+TradingPlatformCurrency;
               RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
            end;

            marketid = marketid_moex; // по умолчанию ММВБ
            stock_codekind = CODEKIND_DLCONTR_MOEX;
            short_code_sub = "";

            if (TradingPlatformInfo.TradingPlatformCode.RecordCode == "ММВБ") 
               ServKind    = PTSK_STOCKDL;                              // фондовый рынок
               ServKindSub = SERV_SUBKIND_STOCK;                        // Подвид площадки - биржа
               SubNumber   = AgreementInfo.AgreementNumber+"_ф";            // Номер субдоговора
               SubName     = partyname; //"Субдоговор по фондовой секции - биржа";   // Название
               if (new_ed)
                  STOCK_acc_arr.value(STOCK_acc_arr.size) = fininstr.FIID;
               end;

            elif (TradingPlatformInfo.TradingPlatformCode.RecordCode == "ВНЕБ")
               ServKind    = PTSK_STOCKDL;                                 // фондовый рынок
               ServKindSub = SERV_SUBKIND_STOCK_OVER;                      // Подвид площадки - внебиржа
               SubNumber   = AgreementInfo.AgreementNumber+"_в";               // Номер субдоговора
               SubName     = partyname; //"Субдоговор по фондовой секции - внебиржа";   // Название
               if (new_ed)
                  STOCK_OVER_acc_arr.value(STOCK_OVER_acc_arr.size) = fininstr.FIID;
               end;
               marketid = -1;

            elif (TradingPlatformInfo.TradingPlatformCode.RecordCode == "FORTS")
               if (fininstr.FIID == 0) // только нац.валюта
                  ServKind    = 15;                                           // срочные контракты
                  ServKindSub = SERV_SUBKIND_STOCK;                           // Подвид площадки - биржа
                  SubNumber   = AgreementInfo.AgreementNumber+"_с";               // Номер субдоговора
                  SubName     = partyname;	//"Субдоговор по срочной секции";               // Название
                  if (new_ed)
                     FORTS_acc_arr.value(FORTS_acc_arr.size) = fininstr.FIID;
                  end;
               else 
                  ServKind = 0;
               end;
            elif (TradingPlatformInfo.TradingPlatformCode.RecordCode == "MMVB")
               ServKind = 21;   // валютная биржа
               ServKindSub = SERV_SUBKIND_STOCK;                      // Подвид площадки 
               SubNumber   = AgreementInfo.AgreementNumber+"_v";               // Номер субдоговора
               SubName     = partyname; //"Субдоговор по валютной бирже";   // Название
               /*if (new_ed)   // игнорируем список валют, всегда 5 валют
                  CURRENCY_acc_arr.value(CURRENCY_acc_arr.size) = fininstr.FIID;
               end;*/ 
               if (ValType(TradingPlatformInfo.CurrencyMMVBType) != V_UNDEF)  
                  MMVB_value = TradingPlatformInfo.CurrencyMMVBType.RecordCode;
                  if (MMVB_value == "RUR") MMVB_value = "RUB" end;
               else
                  MMVB_value = "RUB";
               end;
               // BIQ-4152 след.строка обнуляет весь предыдущий разбор, площадка не откроется, если ServKind = 0. 
               // ServKind = 0; // не считаем ошибкой, но и не обрабатываем

            // BIQ-7041 Новый тип площадки SPB
            elif (TradingPlatformInfo.TradingPlatformCode.RecordCode == "СПБ")
               if (flag_spb)
                  ServKind    = PTSK_STOCKDL;                              // фондовый рынок
                  ServKindSub = SERV_SUBKIND_STOCK;                        // Подвид площадки - биржа
                  SubNumber   = AgreementInfo.AgreementNumber+"_s";               // Номер субдоговора
                  SubName     = partyname; //"Субдоговор по бирже СПБ";   // Название
                  if (new_ed)   
                     SPB_acc_arr.value(SPB_acc_arr.size) = fininstr.FIID;
                  end; 
                  marketid = marketid_spb; 
                  stock_codekind = CODEKIND_DLCONTR_SPB; 
               else
                  ServKind = 0;
               end;
            else
               err_txt = "Неизвестная торговая площадка: "+TradingPlatformInfo.TradingPlatformCode.RecordCode;
               RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
            end;


            if (new_ed)
               sub_id = -1;
            else
               sub_id = FindDlContrMp(dlcontr_id, ServKind, ServKindSub, marketid, date_sub_exist, acccode_exist);
            end;

            if (ServKind > 0)
               if (sub_id < 0) // площадка не найдена, открываем
                  // простановка на обслуживание
                  AddServKind(_partyid, ServKind, {OperDprt}, AgreementInfo.AgreementDate);

                  if (new_ed)
                    flag_subcontr = true;
                    for (subcontr_temp,SubContrArr)
                       if ( (subcontr_temp.rec.SERVKIND == ServKind) and (subcontr_temp.rec.SUBKIND == ServKindSub) 
                              and (subcontr_temp.rec.MarketID == marketid) )   //BIQ-7041 доп.проверка на вид биржи у площадки
                          flag_subcontr = false;
                          break;
                       end;
                    end;

                    if (flag_subcontr)
                       // формирование кода, только если субдоговор нужен
                       if (ServKind == PTSK_STOCKDL)    // фондовый рынок
                          if (ServKindSub == SERV_SUBKIND_STOCK)  // биржа
                             if (not short_code) 
                                // BIQ-7041 генерация кода по бирже
                                short_code = GeneratePersonalCode(_partyid, IsIIS, false, DO_SERVKIND_STOCKDL, null, null, stock_codekind);    // Единый код на бирже
                                short_code_sub = short_code;
                                // gtv 05042022: при массовой вставке проверка всегда будет падать
                                //short_code = CheckCodeMICEX(short_code, ServKind, ServKindSub, _partyid, IsIIS);
                             else
                                short_code_sub = short_code;
                             end;
                             if (stock_codekind == 2) // Спб
                                // gtv 06042022: после ЕДП все коды одни и те же, перестаем вызывать функцию
                                //short_code_sub = GeneratePersonalCode(_partyid, IsIIS, false, DO_SERVKIND_STOCKDL, null, null, stock_codekind);    // Единый код на бирже
                                short_code_sub = short_code;
                                // gtv 05042022: при массовой вставке проверка всегда будет падать
                                //short_code_sub = CheckCodeMICEX(short_code_sub, ServKind, ServKindSub, _partyid, IsIIS);
                                EKK_SPB = short_code_sub;
                             end;
                          else                                   // внебиржа
                             short_code_sub = "";
                          end;
                       elif (ServKind == 15)                                     // срочные контракты
                          short_code_sub = GeneratePersonalCodeWithRepeat(_partyid, IsIIS, false, DO_SERVKIND_FORTS, null, CurFirmID, stock_codekind);
                          // gtv 05042022: при массовой вставке проверка всегда будет падать
                          //short_code_sub = CheckCodeMICEX(short_code_sub, ServKind, ServKindSub, _partyid, IsIIS, CurFirmID);
                       elif (ServKind == 21)                                     // валютная биржа
                          // gtv 06042022: после ЕДП все коды одни и те же, перестаем вызывать функцию
                          //short_code_sub = GeneratePersonalCode(_partyid, IsIIS, false, DO_SERVKIND_CURRDL, null, null, stock_codekind);
                          short_code_sub = short_code;
                          // gtv 05042022: при массовой вставке проверка всегда будет падать
                          //short_code_sub = CheckCodeMICEX(short_code_sub, ServKind, ServKindSub, _partyid, IsIIS);
                          MMVB_sub_code = short_code_sub;
                          //short_code_sub = "NEW_CODE";
                       end;

                       ai = SubContrArr.size;
                       SubContrArr.value(ai) = TRecHandler("dlcontrsubprm.rec");
                       SubContrArr.value(ai).Clear;
                       SubContrArr.value(ai) = InitDlContrMp();
                       SubContrArr.value(ai).rec.SERVKIND   = ServKind;
                       SubContrArr.value(ai).rec.SUBKIND    = ServKindSub;
                       SubContrArr.value(ai).rec.NUMBER     = SubNumber;
                       SubContrArr.value(ai).rec.NAME       = SubName;
                       SubContrArr.value(ai).rec.ROLE       = 2;     //Роль ПУРЦБ
                       SubContrArr.value(ai).rec.MPCODE     = short_code_sub;   //Краткий код клиента, данный при регистрации на торговой площадке биржи
                       SubContrArr.value(ai).rec.MPREGDATE  = date();   //Дата регистрации клиента на площадке
                       //SubContrArr.value(ai).rec.MPCLOSEDATE =	01.01.0001  //Дата прекращения обслуживания клиента на площадке
                       // gtv: для ЕДП счетчик для acccode для биржи (t_servkindsub = 8) запускаем один раз
                       if (flag_edp and (ServKindSub == SERV_SUBKIND_STOCK))
                          if (not new_acccode)  // только если еще не задан
                             GenerateReference(127, new_acccode);    
                          end;
                          SubContrArr.value(ai).rec.ACCCODE    = new_acccode; //Код в номере счета
                       else
                          GenerateReference(127, nextval);    
                          SubContrArr.value(ai).rec.ACCCODE    = nextval; //Код в номере счета
                       end;
                       SubContrArr.value(ai).rec.DATECONC   = date_sub;  //Дата заключения
                       SubContrArr.value(ai).rec.DATEBEGIN  = date_sub;  //Дата начала
                       //DlContrMp.rec.DATEPROLONG =	01.01.0001  //Дата пролонгации
                       //DlContrMp.rec.DATECLOSE  =	01.01.0001  //Дата закрытия
                       SubContrArr.value(ai).rec.SFPLANID   = tarif_id;  //Идентификатор тарифного плана
                       SubContrArr.value(ai).rec.MarketID   = marketid;

                       if (ServKind == 15)
                          SubContrArr.value(ai).rec.firmid = /*"F502"*/ CurFirmID;//dan получение текущекй фирмы из списка
                       end;

                       ServPutIntoTrace("SubContrArr.value(ai).rec.MPCODE: " +SubContrArr.value(ai).rec.MPCODE);

                       CheckAndPushUnloadQUIKBroker(_partyid, true);
                    end;

                  else
                    // формирование кода, только если нужен субдоговор
                    if (ServKind == PTSK_STOCKDL)    // фондовый рынок
                       if (ServKindSub == SERV_SUBKIND_STOCK)  // биржа

// gtv: дополнение на основании переписки Thursday, February 17, 2022 4:52 PM Начальное решение по СПб 
// В случае, если в СОФР пришёл запрос SetPerson(), содержащий площадку СПБ, и при этом в СОФР:
// 1) такой договор существует (т.е. пришёл запрос на обновление);
// 2) дата открытия договора меньше 15.02.2022;
// 3) по договору в СОФР отсутствует площадка СПБ,
// то в СОФР просто не выполнять никаких действий по обработке площадки (не добавлять её). Тогда и в Депозитарий ничего не будет отправляться.
                          // здесь ветка для старого договора и новой площадки
//DEF-35817 ограничение на Спб убираем, ограничение переехало в макрос выгрузки в Депозитарий
                          //if ( (stock_codekind == 2)
                          //     and (AgreementInfo.AgreementDate < date(15,2,2022))
                          //    )
                          //   continue; // переходим к следующей площадке
                          //else // DEF-22082 для старого договора и новой площадки Спб генерируется новый код
                             short_code = FindEKK(207, 1, dlcontr_id);
                          //end;

                          if (not short_code)
                             short_code = GeneratePersonalCode(_partyid, IsIIS, false, DO_SERVKIND_STOCKDL, null, null, stock_codekind);    // Единый код на бирже
                          end;
                          // gtv 05042022: при массовой вставке проверка всегда будет падать
                          //short_code = CheckCodeMICEX(short_code, ServKind, ServKindSub, _partyid, IsIIS);
                          short_code_sub = short_code;
                       else                                   // внебиржа
                          short_code_sub = "";
                       end;
                    elif (ServKind == 15)                                     // срочные контракты
                       //short_code_sub = GeneratePersonalCode(_partyid, IsIIS, false, DO_SERVKIND_FORTS, null, null, stock_codekind);
                       short_code_sub = GeneratePersonalCodeWithRepeat(_partyid, IsIIS, false, DO_SERVKIND_FORTS, null, CurFirmID, stock_codekind);
                       // gtv 05042022: при массовой вставке проверка всегда будет падать
                       //short_code_sub = CheckCodeMICEX(short_code_sub, ServKind, ServKindSub, _partyid, IsIIS);
                    elif (ServKind == 21)                                     // валютная биржа
                       //short_code_sub = GeneratePersonalCode(_partyid, IsIIS, false, DO_SERVKIND_CURRDL);
                       //short_code_sub = CheckCodeMICEX(short_code_sub, ServKind, ServKindSub, _partyid, IsIIS);
                       // для площадки к существующему договору
                       short_code_sub = FindEKK(207, 1, dlcontr_id);
                       if (short_code_sub == "-1")
                          err_txt = "Ну удалось получить ЕКК для договора "+AgreementInfo.AgreementNumber;
                          RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
                       else
                          short_code_sub = "CU"+short_code_sub;
                       end;
                    end;

                    //HasAnotherStock = FindDlContrMp_STOCK(dlcontr_id, ServKind); // поиск другой биржевой/внебиржевой площадки

                    DlContrMp = TRecHandler("dlcontrsubprm.rec");  
                    DlContrMp.Clear;
                    DlContrMp = InitDlContrMp();
                    DlContrMp.rec.SERVKIND   = ServKind;
                    DlContrMp.rec.SUBKIND    = ServKindSub;
                    DlContrMp.rec.NUMBER     = SubNumber;
                    DlContrMp.rec.NAME       = SubName;
                    DlContrMp.rec.ROLE       = 2;     //Роль ПУРЦБ
                    DlContrMp.rec.MPCODE     = short_code_sub;   //Краткий код клиента, данный при регистрации на торговой площадке биржи
                    DlContrMp.rec.MPREGDATE  = date();   //Дата регистрации клиента на площадке
                    //DlContrMp.rec.MPCLOSEDATE =	01.01.0001  //Дата прекращения обслуживания клиента на площадке
                    // gtv: для ЕДП счетчик для acccode для биржи (t_servkindsub = 8) запускаем один раз
                    if (flag_edp and (ServKindSub == SERV_SUBKIND_STOCK))
                       if (not new_acccode)  // только если еще не задан
                          GenerateReference(127, new_acccode);    
                       end;
                       DlContrMp.rec.ACCCODE    = new_acccode; //Код в номере счета
                    else
                       GenerateReference(127, nextval);  
                       DlContrMp.rec.ACCCODE    = nextval; //Код в номере счета
                    end;
                    DlContrMp.rec.DATECONC   = date_sub;  //Дата заключения
                    DlContrMp.rec.DATEBEGIN  = date_sub;  //Дата начала
                    //DlContrMp.rec.DATEPROLONG =	01.01.0001  //Дата пролонгации
                    //DlContrMp.rec.DATECLOSE  =	01.01.0001  //Дата закрытия
                    DlContrMp.rec.SFPLANID   = tarif_id;  //Идентификатор тарифного плана
                    DlContrMp.rec.MarketID   = marketid;
                    if (ServKind == 15)
                       DlContrMp.rec.firmid = /*"F502"*/ CurFirmID;//dan получение текущекй фирмы из списка
                    end;

                    ServPutIntoTrace("DlContrMp.rec.MPCODE: " +DlContrMp.rec.MPCODE);

                    stat = DL_AddSubContrToDLCONTR(dlcontr_id, DlContrMp, err_txt);
                    if (stat != 0)
                       RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
                    end;
        
                    // BIQ-7033 новое событие для измененного договора
                    out_dlcontrid.value(out_dlcontrid.size) =  DlContrPrm.rec.DLCONTRID;

                    sub_id = DlContrMp.rec.sfcontrid;
// 2020.03.20 Cherednichenko - добавим в список новых субдоговоров
                    NewSubContractIDs(NewSubContractIDs.size) = sub_id;

                    UpdatePayMethod(sub_id, 1);
//boss-2491 убираем выгрузку в депозитарий при добавление площадок.
/*
// 17-03-2020 Cherednichenko - Проверяем дублирование событий
                    if (v_etl)
                       if ( not EventDoubling(9, dlcontr_id) )
                         m_make_event_to_process(9, dlcontr_id);
                       end;
                    else
                       // BIQ-7382 выгрузка в Депозитарий Гераськина Т.В.
                       if (ServKind == 1) // только для биржи
                          if ( not EventDoubling(8207, dlcontr_id) )
                            m_make_event_to_process(8207, dlcontr_id);
                          end;
                       end;
                    end;
*/
                    old_subid.value(old_subid.size) = sub_id;

                    new_sub = true;
                    DlContrMp = NULL;

                    CheckAndPushUnloadQUIKBroker(_partyid,false);

                    // отправка письма
                    /*if (ServKind == PTSK_STOCKDL)    // фондовый рынок
                       if (HasAnotherStock <= 0) // не нашли ничего, свежий дилинг
                          partyname_short = GetPartyName(_partyid, true);
                          v_email_processor = c_email_proc_env();
                          v_email_head =  "Информируем о  заключении брокерского соглашения ("+
                                           AgreementInfo.AgreementNumber+" от "+              
                                           AgreementInfo.AgreementDate+")_"+                  
                                           partyname_short;                                  
                          v_email_body = v_email_head;
                          v_email_processor.m_set_msg_head(v_email_head);
                          v_email_processor.m_add_row_to_msg_text(v_email_body);
                          v_email_processor.m_save_to_submit_grp(CONTRACT_EMAIL_GRP, true);
                          v_email_processor.m_submit_email_synch(); 
                       end;
                    end;*/

                    objectid_sub = String(sub_id:o:10);
                    // примечание к субдоговору - основная валюта
                    if (ServKind == 21)
                       if (ValType(MMVB_value) != V_UNDEF)  
//2021-02-12 Cherednichenko is523091 Дата примечания равна дате договора
//                            stat = addNoteForObject(objecttype_sub, objectid_sub, SUBCONTRACT_NOTEKIND_MMVBCURRENCY, MMVB_value);
                            stat = addNoteForObject(objecttype_sub, objectid_sub, SUBCONTRACT_NOTEKIND_MMVBCURRENCY, MMVB_value, AgreementInfo.AgreementDate);
                       end;
                    end;

                    //BIQ-7785 Гераськина Т.В. категория ЕДП для новых договоров по бирже = Да
                    if (flag_edp)
                       //if (AgreementInfo.IsConsolidatedCashPosition)  // Признак наличия ЕДП
                          if (ServKindSub == 8) // все по бирже
//shev переделал на insert
//                             ObjCat = RsbObjCategories(objecttype_sub, objectid_sub);
//                             stat = ObjCat.ConnectAttr(SUBCONTRACT_CATEGORY_EDP, 1, NULL, NULL, AgreementInfo.AgreementDate );
//                             if(stat == 0)
//                                stat = ObjCat.Save(objectid_sub);
//                             else
                            if(InsAttr(objecttype_sub,SUBCONTRACT_CATEGORY_EDP,1,objectid_sub, AgreementInfo.AgreementDate) == false)
                               err_txt = "Ошибка при установке признака EDP";
                               RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
                            end;
//                            end;
//                             ObjCat = null;
                          end;
                       //end;
                    else  // если флаг не включен
                       if (ServKindSub == 8) // все по бирже
//shev переделал на insert
//                          ObjCat = RsbObjCategories(objecttype_sub, objectid_sub);
//                          stat = ObjCat.ConnectAttr(SUBCONTRACT_CATEGORY_EDP, 2, NULL, NULL, AgreementInfo.AgreementDate );
//                          if(stat == 0)
//                             stat = ObjCat.Save(objectid_sub);
//                          else
                       if(InsAttr(objecttype_sub,SUBCONTRACT_CATEGORY_EDP,2,objectid_sub, AgreementInfo.AgreementDate) == false)
                          err_txt = "Ошибка при установке признака EDP";
                          RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
                       end;
//                          end;
//                          ObjCat = null;
                       end;
                    end;

                    if ((ServKind == 1) and (ServKindSub == 8))
                      ObjCat = RsbObjCategories(objecttype_sub, objectid_sub);
                      stat = ObjCat.ConnectAttr(6/*Предоставлять брокеру право использования ценных бумаг в его интересах*/, 1/*Да*/, 
                                                NULL, NULL, AgreementInfo.AgreementDate );
                      if(stat == 0)
                         stat = ObjCat.Save(objectid_sub);
                      else
                         err_txt = "Ошибка при установке категории \"Предоставлять брокеру право использования ценных бумаг в его интересах\"";
                         RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
                      end;

                      stat = ObjCat.ConnectAttr(7/*Перевод активов на новый номер ТКС произведен*/, 2/*Нет*/, 
                                                NULL, NULL, AgreementInfo.AgreementDate );
                      if(stat == 0)
                         stat = ObjCat.Save(objectid_sub);
                      else
                         err_txt = "Ошибка при установке категории \"Перевод активов на новый номер ТКС произведен\"";
                         RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
                      end;

                      stat = ObjCat.ConnectAttr(8/*Заявление клиента о переводе на обособленный учет*/, 2/*Нет*/, 
                                                NULL, NULL, AgreementInfo.AgreementDate );
                      if(stat == 0)
                         stat = ObjCat.Save(objectid_sub);
                      else
                         err_txt = "Ошибка при установке категории \"Заявление клиента о переводе на обособленный учет\"";
                         RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
                      end;
                    end;
                  end;
                  date_sub_exist = date_sub;
               else
                   // только для 21
                   objectid_sub = String(sub_id:o:10);
                   if (ServKind == 21)
                      if (ValType(MMVB_value) != V_UNDEF)  
                         MMVB_value_exist = readNoteForObject( objecttype_sub, objectid_sub, SUBCONTRACT_NOTEKIND_MMVBCURRENCY );
                         if (    (ValType(MMVB_value_exist) == V_UNDEF)  // не задано в текущем договоре
                              or ( (ValType(MMVB_value_exist) != V_UNDEF) and  (StrUpr(MMVB_value_exist) != StrUpr(MMVB_value)) ) // задано, но не совпадает
                             )
//2021-02-12 Cherednichenko is523091 Дата примечания равна дате договора
//                            stat = addNoteForObject(objecttype_sub, objectid_sub, SUBCONTRACT_NOTEKIND_MMVBCURRENCY, MMVB_value);
                            stat = addNoteForObject(objecttype_sub, objectid_sub, SUBCONTRACT_NOTEKIND_MMVBCURRENCY, MMVB_value, AgreementInfo.AgreementDate);
                         end;
                      end;
                   end;

                   // BIQ-7785 Гераськина Т.В. если площадка уже есть, проверим ЕДП
                   // DEF-24224 если при открытии не установился признак ЕДП
                   if (ServKindSub == 8)  // по всей бирже
                      if (flag_edp)
                         Attrcode = 0;
                         ObjCat = RsbObjCategories(objecttype_sub, objectid_sub);
                         if (ObjCat.GetMainAttr( SUBCONTRACT_CATEGORY_EDP, date(), attr, attrcor ) == 0)
                            Attrcode = attrcor.attrid;
                         end;
                         if (Attrcode == 1)    // если стоит ЕДП
                         else
                             stat = ObjCat.ConnectAttr(SUBCONTRACT_CATEGORY_EDP, 1, NULL, NULL, AgreementInfo.AgreementDate );
                             if(stat == 0)
                                stat = ObjCat.Save(objectid_sub);
                             else
                                err_txt = "Ошибка при установке признака ЕДП";
                                RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
                             end;
                         end;
                         ObjCat = null;
                      end;
                   end;

                   if ((ServKind == 1) and (ServKindSub == 8))

                     ObjCat = RsbObjCategories(objecttype_sub, objectid_sub);
                     stat = PutCatForEmptyValue(ObjCat, 6/*Предоставлять брокеру право использования ценных бумаг в его интересах*/, 1/*Да*/, AgreementInfo.AgreementDate);
                     if(stat == 0)
                        stat = ObjCat.Save(objectid_sub);
                     else
                        err_txt = "Ошибка при установке категории \"Предоставлять брокеру право использования ценных бумаг в его интересах\"";
                        RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
                     end;

                     stat = PutCatForEmptyValue(ObjCat, 7/*Перевод активов на новый номер ТКС произведен*/, 2/*Нет*/, AgreementInfo.AgreementDate);
                     if(stat == 0)
                        stat = ObjCat.Save(objectid_sub);
                     else
                        err_txt = "Ошибка при установке категории \"Перевод активов на новый номер ТКС произведен\"";
                        RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
                     end;

                     stat = PutCatForEmptyValue(ObjCat, 8/*Заявление клиента о переводе на обособленный учет*/, 2/*Нет*/, AgreementInfo.AgreementDate);
                     if(stat == 0)
                        stat = ObjCat.Save(objectid_sub);
                     else
                        err_txt = "Ошибка при установке категории \"Заявление клиента о переводе на обособленный учет\"";
                        RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
                     end;

                     ObjCat = null;
                   end;
                  
                  old_subid.value(old_subid.size) = sub_id;
               end;

               if (ServKind == 21)
                  if (not new_ed) 
                     fiid_sub_arr = TArray(CURRENCY_acc_arr);
                     for (fiid_sub, fiid_sub_arr)
                        ssi_FIID = FindDlContrMpSSI(sub_id, fiid_sub);
                        if (ssi_FIID < 0) // валюта не найдена, открываем
                            ClearRecord(accrec_edp);
                            accrec_edp.rec.open_date = date_sub_exist; // дата открытия субдоговора
                            accrec_edp.rec.account = "";
                            accrec_edp.rec.code_currency = fiid_sub;
                            OpenAllAccounts(sub_id, accrec_edp, inConditionDate, NewSubContractIDs, flag_edp, ServKindSub, FIID_LIST);
                        end;
                     end;
                     // передача во вне
                     if ( (not new_ed) and (not new_sub) )  // для нового договора / субдоговора запись одна и она уже есть
// 17-03-2020 Cherednichenko - Проверяем дублирование событий
                       if (v_etl)
                          if ( not EventDoubling(9, dlcontr_id) )
                            m_make_event_to_process(9, dlcontr_id);
                          end;
                       end;
                     end;
                  end;
               else
                  TradingPlatformCurrency = TradingPlatformInfo.TradingPlatformCurrency.RecordCode;
                  if (TradingPlatformCurrency == "RUR") TradingPlatformCurrency = "RUB" end;
                  if (ПолучитьФинИнПоISO (TradingPlatformCurrency, fininstr))
                     if (not new_ed) 
                        ssi_FIID = FindDlContrMpSSI(sub_id, fininstr.FIID);
                        if (ssi_FIID < 0) // валюта не найдена, открываем
                            ClearRecord(accrec_edp);
                            accrec_edp.rec.open_date = date_sub_exist; // дата открытия субдоговора
                            accrec_edp.rec.account = "";
                            accrec_edp.rec.code_currency = fininstr.FIID;
                            
                            OpenAllAccounts(sub_id, accrec_edp, AgreementInfo.ConditionDate, NewSubContractIDs, flag_edp, ServKindSub, FIID_LIST);

                           // передача во вне
                           if ( (not new_ed) and (not new_sub) )  // для нового договора / субдоговора запись одна и она уже есть
//boss-2491
/*
// 17-03-2020 Cherednichenko - Проверяем дублирование событий
                              if (v_etl)
                                 if ( not EventDoubling(9, dlcontr_id) ) // 17-03-2020 Cherednichenko - Проверяем дублирование событий
                                   m_make_event_to_process(9, dlcontr_id);
                                 end;
                              else
                                 // BIQ-7382 выгрузка в Депозитарий Гераськина Т.В.
                                 if (ServKind == 1) // только для биржи И был открыт новый счет
                                    if ( not EventDoubling(8207, dlcontr_id) )
                                      m_make_event_to_process(8207, dlcontr_id);
                                    end;
                                 end;
                              end;
*/
                           end;
                        end;
                     end;

                  else
                     err_txt = "Не найдена валюта с кодом: "+TradingPlatformCurrency;
                     RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
                  end;
               end;
            end;
         end;
       
      end;

      if (new_ed)
         // открытие ЕД
         if (DlContrPrm.rec.PARTYID > 0)
            stat = DL_CreateDLCONTR(DlContrPrm, NULL, SubContrArr, err_txt); 
            if (stat != 0)
               RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
            end;
            dlcontr_id = DlContrPrm.rec.DLCONTRID;

            objectid = String(dlcontr_id:o:34);
            // примечание к договору
            if (ValType(_FinConsBrok) != V_UNDEF) 
               stat = addNoteForObject(objecttype, objectid, CONTRACT_NOTEKIND_CONS, _FinConsBrok);
               if(stat)
                 err_txt = "Ошибка добавления примечания к документу";
                 RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
               end;
            end;

            if (ValType(AgreementInfo.ConditionDate) != V_UNDEF) 
               stat = addNoteForObject(objecttype, objectid, CONTRACT_NOTEKIND_CONDITIONDATE, AgreementInfo.ConditionDate);
               if(stat)
                 err_txt = "Ошибка добавления примечания к документу";
                 RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
               end;
            end;
            
            new_sfcontrid = FindDlContrAfterOpen(dlcontr_id);
            if (tarif_id_brok.size > 1)
               stat  = SfContrChangeSfPlan(new_sfcontrid, tarif_id_brok.value(1).TariffId, tarif_id_brok.value(1).BindDate, false);
               if(stat != 0)
                  err_txt = String("Ошибка смены тарифа ",tarif_id ," на ",tarif_id_brok.value(1).TariffId," ",tarif_id_brok.value(1).TariffPlan,": ",GetErrMessage(stat));
                  RunError(err_txt, c_err_obj(err_txt, "004"));
               end;
            end;

            if ((tarif_id_repo.size> 0) and not g_flag_debt)
               AddTariffRepo(tarif_id_repo, objecttype, objectid);
            end;

            contract_vtb = FindContractMatch(_partyid, IsIIS);
            if (contract_vtb.r != "-1");
               stat = addNoteForObject(objecttype, objectid, CONTARCT_NOTEKIND_VTB_CONTRACTNUM, contract_vtb.contract_number);
               if(stat)
                 err_txt = "Ошибка добавления примечания "+CONTARCT_NOTEKIND_VTB_CONTRACTNUM+" к документу";
                 RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
               end;  
               stat = addNoteForObject(objecttype, objectid, CONTARCT_NOTEKIND_VTB_CONTRACTDATE, contract_vtb.contract_date);
               if(stat)
                 err_txt = "Ошибка добавления примечания "+CONTARCT_NOTEKIND_VTB_CONTRACTDATE+" к документу";
                 RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
               end;  
               UpdateContractmatch(contract_vtb.r, dlcontr_id);
            end;

//shev biq-8258
            if ((ValType(AgreementInfo.IsIISContract) != V_UNDEF) and (AgreementInfo.IsIISContract))
              if (ValType(AgreementInfo.IsAnotherContract) != V_UNDEF)  
                if (AgreementInfo.IsAnotherContract)
                  stat = addNoteForObject(objecttype, objectid, CONTARCT_NOTEKIND_DATE_CLOSE_ISANOTHERCONTRACT, AgreementInfo.AgreementDate+30);
                  if(stat)
                    err_txt = "Ошибка добавления примечания "+CONTARCT_NOTEKIND_DATE_CLOSE_ISANOTHERCONTRACT+" к документу";
                    RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
                  end;
                  stat = addNoteForObject(objecttype, objectid, CONTARCT_NOTEKIND_REASON_UNLOAD_PROHIBIT, "Ожидание Подтверждающих Документов");
                  if(stat)
                    err_txt = "Ошибка добавления примечания "+CONTARCT_NOTEKIND_REASON_UNLOAD_PROHIBIT+" к документу";
                    RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
                  end;  
                end;
              end;
            end;
//shev вставляем задание на выгрузку сообщения о регистрации клиента на биржу
// gtv вынесено за пределы SetPerson, чтобы транзакция была завершена
/*            InsertSequenceJobUsrObj(DlContrPrm.rec.DLCONTRID,
                                 7033,
                                 DlContrPrm.rec.DLCONTRID,
                                 "7033",
                                 Null,
                                 null);  */
           out_dlcontrid.value(out_dlcontrid.size) =  DlContrPrm.rec.DLCONTRID;

           SetContractCategories(AgreementInfo, objecttype, objectid, RiskLevelBrok_exist, IsCurrentAccounts_exist, @need_close, true);

//            for (SubContr, SubContrArr)
            ai = 0;
            while (ai < SubContrArr.size)
               sfcontr_SERVKIND = SubContrArr.value(ai).rec.SERVKIND;
               sfcontr_SUBKIND = SubContrArr.value(ai).rec.SUBKIND;
               sfcontr_marketid = SubContrArr.value(ai).rec.MarketID;

               rs = RSDRecordSet("select sf_sub.t_id sub from "+
                                   "    DDLCONTRMP_dbt  mp, "+
                                   "    dsfcontr_dbt sf_sub, "+
                                   "    ddlcontr_dbt dl "+
                                   "where   "+
                                   "    DL.T_DLCONTRID = "+dlcontr_id+
                                   "    and mp.t_dlcontrid = DL.T_DLCONTRID "+
                                   "    and sf_sub.t_id = mp.t_sfcontrid "+
                                   "    and sf_sub.t_servkind = "+sfcontr_SERVKIND+
                                   "    and sf_sub.t_servkindsub = "+sfcontr_SUBKIND+
                                   "    and mp.t_marketid = "+sfcontr_marketid);
               if (rs.movenext)
                  sub_id = rs.value("sub");
                  UpdatePayMethod(sub_id, 1);

                  objectid_sub = String(sub_id:o:10);
                  if (sfcontr_SERVKIND == 21)
                     if (ValType(MMVB_value) != V_UNDEF)  
//2021-02-12 Cherednichenko is523091 Дата примечания равна дате договора
//                       stat = addNoteForObject(objecttype_sub, objectid_sub, SUBCONTRACT_NOTEKIND_MMVBCURRENCY, MMVB_value);
                       stat = addNoteForObject(objecttype_sub, objectid_sub, SUBCONTRACT_NOTEKIND_MMVBCURRENCY, MMVB_value, AgreementInfo.AgreementDate);
                     end;

                  else 

                      var  path = true; // по умолчанию через kafka
                      GetRegistryValue("РСХБ\\ИНТЕГРАЦИЯ\\ДЕПОЗИТАРИЙ_KAFKA", V_BOOL, path);
                      if(path == false)
                        if (not v_etl)
                          if (sfcontr_SERVKIND == 1) // только биржа
                            // BIQ-7382 выгрузка в Депозитарий Гераськина Т.В.
                            if ( not EventDoubling(8207, dlcontr_id) )
                              m_make_event_to_process(8207, dlcontr_id);
                            end;
                          end;
                        end;
                     end;
                  end;

                  //BIQ-7785 Гераськина Т.В. категория ЕДП для новых договоров по бирже = Да
                  if (flag_edp)
                     //if (AgreementInfo.IsConsolidatedCashPosition)  // Признак наличия ЕДП
                        if (sfcontr_SUBKIND == 8) // все по бирже
//shev переделал на insert
//                           ObjCat = RsbObjCategories(objecttype_sub, objectid_sub);
//                           stat = ObjCat.ConnectAttr(SUBCONTRACT_CATEGORY_EDP, 1, NULL, NULL, AgreementInfo.AgreementDate );
//                           if(stat == 0)
//                              stat = ObjCat.Save(objectid_sub);
//                           else
                          if(InsAttr(objecttype_sub,SUBCONTRACT_CATEGORY_EDP,1,objectid_sub, AgreementInfo.AgreementDate) == false)
                             err_txt = "Ошибка при установке признака EDP";
                             RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
                          end;
//                           end;
//                           ObjCat = null;
                        end;
                     //end;
                  else  // если флаг не включен
                     if (sfcontr_SERVKIND == 8) // все по бирже
//shev переделал на insert
//                        ObjCat = RsbObjCategories(objecttype_sub, objectid_sub);
//                        stat = ObjCat.ConnectAttr(SUBCONTRACT_CATEGORY_EDP, 2, NULL, NULL, AgreementInfo.AgreementDate );
//                        if(stat == 0)
//                           stat = ObjCat.Save(objectid_sub);
//                        else
                       if(InsAttr(objecttype_sub,SUBCONTRACT_CATEGORY_EDP,2,objectid_sub, AgreementInfo.AgreementDate) == false)
                          err_txt = "Ошибка при установке признака EDP";
                          RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
                       end;
//                        end;
//                        ObjCat = null;
                     end;
                  end;
                  
                  if ((sfcontr_SERVKIND == 1) and (sfcontr_SUBKIND == 8))
                      ObjCat = RsbObjCategories(objecttype_sub, objectid_sub);
                      stat = ObjCat.ConnectAttr(6/*Предоставлять брокеру право использования ценных бумаг в его интересах*/, 1/*Да*/, 
                                                NULL, NULL, AgreementInfo.AgreementDate );
                      if(stat == 0)
                         stat = ObjCat.Save(objectid_sub);
                      else
                         err_txt = "Ошибка при установке категории \"Предоставлять брокеру право использования ценных бумаг в его интересах\"";
                         RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
                      end;

                      stat = ObjCat.ConnectAttr(7/*Перевод активов на новый номер ТКС произведен*/, 2/*Нет*/, 
                                                NULL, NULL, AgreementInfo.AgreementDate );
                      if(stat == 0)
                         stat = ObjCat.Save(objectid_sub);
                      else
                         err_txt = "Ошибка при установке категории \"Перевод активов на новый номер ТКС произведен\"";
                         RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
                      end;

                      stat = ObjCat.ConnectAttr(8/*Заявление клиента о переводе на обособленный учет*/, 2/*Нет*/, 
                                                NULL, NULL, AgreementInfo.AgreementDate );
                      if(stat == 0)
                         stat = ObjCat.Save(objectid_sub);
                      else
                         err_txt = "Ошибка при установке категории \"Заявление клиента о переводе на обособленный учет\"";
                         RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
                      end;
                  end;


                  if (tarif_id_brok.size > 1)
                     stat  = SfContrChangeSfPlan(sub_id, tarif_id_brok.value(1).TariffId, tarif_id_brok.value(1).BindDate, false);
                     if(stat != 0)
                        err_txt = String("Ошибка смены тарифа ",tarif_id ," на ",tarif_id_brok.value(1).TariffId," ",tarif_id_brok.value(1).TariffPlan,": ",GetErrMessage(stat));
                        RunError(err_txt, c_err_obj(err_txt, "004"));
                     end;
                  end;
               end;   

               if  ( (sfcontr_SERVKIND == PTSK_STOCKDL) and (sfcontr_SUBKIND == SERV_SUBKIND_STOCK) )
                  if (sfcontr_marketid == marketid_moex)
                     fiid_sub_arr = TArray(CURRENCY_acc_arr/*STOCK_acc_arr*/);
                  else
                     fiid_sub_arr = TArray(SPB_acc_arr);
                  end;
               elif  ( (sfcontr_SERVKIND == PTSK_STOCKDL) and (sfcontr_SUBKIND == SERV_SUBKIND_STOCK_OVER) )
                  fiid_sub_arr = TArray(STOCK_OVER_acc_arr);
               elif (sfcontr_SERVKIND == 15)
                  fiid_sub_arr = TArray(FORTS_acc_arr);
               elif (sfcontr_SERVKIND == 21)
                  fiid_sub_arr = TArray(CURRENCY_acc_arr);
               end;

// 2020-05-25 Cherednichenko - Новый единый договор означает открытие новых субдоговором. Добавим текущий в список новых субдоговоров.
               NewSubContractIDs(NewSubContractIDs.size) = sub_id;
               for (fiid_sub, fiid_sub_arr)
                  ClearRecord(accrec_edp);
                  accrec_edp.rec.open_date = SubContrArr.value(ai).rec.DATEBEGIN; // дата открытия субдоговора
                  accrec_edp.rec.account = "";
                  accrec_edp.rec.code_currency = fiid_sub;
                  OpenAllAccounts(sub_id, accrec_edp, inConditionDate, NewSubContractIDs, flag_edp, sfcontr_SUBKIND, FIID_LIST);
                end;
               ai = ai+1;

            end;

         end;

         // передача во вне
// 17-03-2020 Cherednichenko - Проверяем дублирование событий
         if (v_etl)
            if ( not EventDoubling(9, dlcontr_id) )
              m_make_event_to_process(9, dlcontr_id);
            end;
         end;

         //BIQ-7426 Гераськина Т.В. 
         EKK_MOEX = GetDLObjCode_ByObjectid(dlcontr_id, 207, CODEKIND_DLCONTR_MOEX);
//         EKK_SPB = ""; // код появляется только после бронирования и активации на бирже Спб // вернулись обратно к коду площадки

         DlContrPrm = NULL;
         SubContrArr.size = 0;
//biq-7840
         path = true; // по умолчанию через kafka
         GetRegistryValue("РСХБ\\ИНТЕГРАЦИЯ\\ДЕПОЗИТАРИЙ_KAFKA", V_BOOL, path);
         if(path == true)
         var sql_it, cmd_it;
         
         sql_it = "BEGIN                       "+
               "   IT_DIASOFT.SendBrokerContractDepo("+dlcontr_id+"); "+
               "END;  ";
          
         cmd_it = RSDCommand(sql_it);
         cmd_it.execute();
         
         cmd_it.close(); cmd_it = NULL; sql_it = NULL;
         end;

      else
         //BIQ-7426 Гераськина Т.В. если ДБО существует, получим ЕКК
         EKK_MOEX = GetDLObjCode_ByObjectid(dlcontr_id, 207, CODEKIND_DLCONTR_MOEX);
//         EKK_SPB = GetDLObjCode_ByObjectid(dlcontr_id, 207, CODEKIND_DLCONTR_SPB);   //вернулись обратно к коду площадки
         EKK_SPB = FindMPCode_ByDealid(dlcontr_id, PTSK_STOCKDL, SERV_SUBKIND_STOCK, marketid_spb);
         
         if (old_subid.size > 0)
            FindAndCloseSubContr(old_subid, dlcontr_id);
         end;

      end;

      //BIQ-7426 Гераськина Т.В. 
      if (EKK_MOEX or EKK_SPB)
         tmp_MarketCode = c_MarketCode();
         tmp_MarketCode.ContractNumber = AgreementInfo.AgreementNumber;
         if (EKK_MOEX)
            tmp_MarketCode.MarketCodeMOEX = EKK_MOEX;
         end;
         if (EKK_SPB)
            tmp_MarketCode.MarketCodeSPB = EKK_SPB; 
         end;
         MarketCode(MarketCode.size) = tmp_MarketCode;
         EKK_MOEX = null;
         EKK_SPB = null;
         tmp_MarketCode = null;
      end;

   end;

   if (need_close)
      m_make_event_to_process(5025, _partyid);
      m_make_event_to_process(5026, _partyid);
   end;
   
   if (out_dlcontrid.size == 0)
      out_dlcontrid = NULL;
   end;


   return MarketCode; //BIQ-7426 Гераськина Т.В. будем возвращать список кодов
end;


// непосредственная обработка единичной записи
// формирование класса ошибок по единичной записи
macro InsertPerson_single(p_req_data_obj, p_transparent_id, out_WillMakeCIFCode:@bool, 
                          out_MasterExternalId:@c_IntegrationSymbolicIdentifierXType, out_dlcontrid:@TArray) 
   var req_obj_serv = NULL;
   var pparty = NULL;
   var resp_obj_serv = NULL;

   private var resp_resultCode, resp_resultText;
   
   private var party_name, party_link;
   
   private var PartyID_found = -1;
   
   // BIQ-7006  Гераськина замена  PersonGetXref на CdiGetXref_req
/*   private var PersonGetXref_req = NULL;
   private var PersonGetXref_resp = NULL;*/
   private var CdiGetXref_resp = NULL;
   private var PersonId_CDI, CodeFromCDI;

   private var CIFContracytReference = NULL;
   private var SOFRId = NULL;
   private var vINN;
   
   private var object_contr = -1, num_filial, pos, code_value_number, code_value, code_number;
   private var err_txt;
   private var wCode, CoupledSubject;
   private var CodeFromCIF, p_WillMakeCIFCode = false;

   private var SetAcc_temp;

   var InsertPersonOut; // BIQ-7426 Гераськина Т.В. класс ответа вместо ErrorAction
   private var vSize = 0;
   
   g_transparent_id = p_transparent_id;

   out_WillMakeCIFCode = false;

   // входящие параметры
   req_obj_serv = c_PersonParm(p_req_data_obj);

   // BIQ-7426 Гераськина Т.В. класс ответа расширен и теперь содержит все данные по клиенту
   InsertPersonOut = c_InsertPersonOut();
   InsertPersonOut.ClientID = NULL;       // partyid
   InsertPersonOut.ErrorList = NULL;      // список ошибок
   InsertPersonOut.MarketCodeList = NULL; // список кодов ЕКК
  
   var lockUniID = "DEF-72001";
   if ((Valtype(req_obj_serv.Person.SOFRId) != V_UNDEF) and (Valtype(req_obj_serv.Person.SOFRId.ObjectID) != V_UNDEF) and (req_obj_serv.Person.SOFRId.ObjectID != ""))
     lockUniID = req_obj_serv.Person.SOFRId.ObjectID;
   elif ((Valtype(req_obj_serv.Person.PersonID) != V_UNDEF) and (Valtype(req_obj_serv.Person.PersonID.ObjectID) != V_UNDEF) and (req_obj_serv.Person.PersonID.ObjectID != ""))
     lockUniID = req_obj_serv.Person.PersonID.ObjectID;
   end;
   var lockObject = UniConcurrentLocker(lockUniID, 10000);
   if (not lockObject.lock())
     InsertPersonOut.ErrorList = TArray;
     vSize = InsertPersonOut.ErrorList.size;
     InsertPersonOut.ErrorList.value(vSize) = c_Error;
     InsertPersonOut.ErrorList.value(vSize).ErrorCode = ERR_CODE_TECH_ERROR;
     InsertPersonOut.ErrorList.value(vSize).ErrorDesc = "Ошибка создания блокировки " + lockUniID;
      
     return InsertPersonOut;
   end;
   
   //поиск Субъекта в БД СОФР по переданным идентификаторам: ИД в АБС, ИД в СОФР (если передан);
   if (Valtype(req_obj_serv.Person.SOFRId) != V_UNDEF)
      PartyID_found = GetPartyID_byStringPartyID(req_obj_serv.Person.SOFRId.ObjectID); // поиск по коду в СОФР
   end;
   
   // PersonID (код АБС)
   if ( (PartyID_found <= 0) // субъект не найден
      and  (Valtype(req_obj_serv.Person.PersonID) != V_UNDEF) )
    
      num_filial = "0000";
      // код АБС
      code_number = PARTY_CODEKIND_ABS;
      code_value = req_obj_serv.Person.PersonID.ObjectID;

/*   maa130121 - код ЦФТ больше не содержит доп. символов: только одни цифры
      pos = 0;
      pos = Index(code_value,"#");
      if (pos == 3)
         code_value_number = Substr(code_value,6);
         code_number = PARTY_CODEKIND_ABS_RESERV;
      else
         code_value = MakeCodeABS(code_value, num_filial, 3);
      end;
*/
      PartyID_found = GetPartyID_byPartyCode(code_number, code_value);
   else
// нашли субъекта сверяем с кодом 101 11.12.202
      num_filial = "0000";
      // код АБС
      code_number = PARTY_CODEKIND_ABS;
      code_value = req_obj_serv.Person.PersonID.ObjectID;

/*   maa130121 - код ЦФТ больше не содержит доп. символов: только одни цифры
      pos = 0;
      pos = Index(code_value,"#");
      if (pos == 3)
         code_value_number = Substr(code_value,6);
         code_number = PARTY_CODEKIND_ABS_RESERV;
      else
         code_value = MakeCodeABS(code_value, num_filial, 3);
      end;
*/

      if( PartyID_found != GetPartyID_byPartyCode(code_number, code_value))

         //BIQ-7426 Гераськина Т.В. изменен ответ
         InsertPersonOut.ErrorList = TArray;
         vSize = InsertPersonOut.ErrorList.size;
         InsertPersonOut.ErrorList.value(vSize) = c_Error;
         InsertPersonOut.ErrorList.value(vSize).ErrorCode = ERR_CODE_TECH_ERROR;
         InsertPersonOut.ErrorList.value(vSize).ErrorDesc = "У субъекта физ.лица не соответствуют коды 101";
      
         return InsertPersonOut;

// 2021-01-15 Cherednicheno is521652 Изменился формат даты входящего сообщения
//      elif( date(req_obj_serv.Person.BirthDate) != GetBirthDay_byPartyID(PartyID_found)  )
      elif( req_obj_serv.Person.BirthDate != GetBirthDay_byPartyID(PartyID_found)  )

         //BIQ-7426 Гераськина Т.В. изменен ответ
         InsertPersonOut.ErrorList = TArray;
         vSize = InsertPersonOut.ErrorList.size;
         InsertPersonOut.ErrorList.value(vSize) = c_Error;
         InsertPersonOut.ErrorList.value(vSize).ErrorCode = ERR_CODE_TECH_ERROR;
         InsertPersonOut.ErrorList.value(vSize).ErrorDesc = "У субъекта физ.лица не соответствуют даты рождения";
      
         return InsertPersonOut;

      end

   end;

   if (PartyID_found <= 0) // субъект не найден
      // Если Субъект не найден, то производится поиск Клиента в CIF	
/* 2021-03-01 Cherendichenko is524018 Поиск происходит только по PersonID.
      if (Valtype(req_obj_serv.Person.CIFId) != V_UNDEF)
         PersonGetXref_req = c_PersonGetXrefRequest;
         PersonGetXref_req.OperationalExternalId.ObjectId = req_obj_serv.Person.CIFId.ObjectID;
         PersonGetXref_req.OperationalExternalId.SystemId = req_obj_serv.Person.CIFId.SystemId;
         PersonGetXref_req.OperationalExternalId.SystemNodeId = req_obj_serv.Person.CIFId.SystemNodeId;
      elif (Valtype(req_obj_serv.Person.PersonID) != V_UNDEF) 
         PersonGetXref_req = c_PersonGetXrefRequest;
         PersonGetXref_req.OperationalExternalId.ObjectId = req_obj_serv.Person.PersonID.ObjectID;
         PersonGetXref_req.OperationalExternalId.SystemId = req_obj_serv.Person.PersonID.SystemId;
         PersonGetXref_req.OperationalExternalId.SystemNodeId = req_obj_serv.Person.PersonID.SystemNodeId;
      end;
*/
      // BIQ-7006 Замена PersonGetXref на CdiGetXref
/*      if (Valtype(req_obj_serv.Person.PersonID) != V_UNDEF) 
         PersonGetXref_req = c_PersonGetXrefRequest;
         PersonGetXref_req.OperationalExternalId.ObjectId = req_obj_serv.Person.PersonID.ObjectID;
         PersonGetXref_req.OperationalExternalId.SystemId = "CFT";
         PersonGetXref_req.OperationalExternalId.SystemNodeId = "CFT";
      end;
      if (ValType(PersonGetXref_req) != V_UNDEF)
         /* 20190103 - kva - добавлена передача "сквозного" id для целей логирования */
         PersonGetXref_resp = PersonGetXref(PersonGetXref_req, NULL, p_transparent_id);
         if (ValType(PersonGetXref_resp) != V_UNDEF)  // ответ получен
            CodeFromCIF = PersonGetXref_resp.GetSystemXref("SOFR");
            if (CodeFromCIF.ObjectId != "-1")
               PartyID_found = GetPartyID_byStringPartyID(CodeFromCIF.ObjectId);  // здесь должен быть PartyID
            end;
            if (PartyID_found < 0)
               out_WillMakeCIFCode = true;
            end;
         else
            out_WillMakeCIFCode = true;
         end;
      end;  */
      if (Valtype(req_obj_serv.Person.PersonID) != V_UNDEF) 
         CdiGetXref_resp = CdiGetXrefReq (req_obj_serv.Person.PersonID, p_transparent_id);
         if (ValType(CdiGetXref_resp) != V_UNDEF)  // ответ получен
            CodeFromCDI = CdiGetXref_resp.GetSystemXref("SOFR");
            if (CodeFromCDI.ExtIdPartySourceId.ObjectId != "-1")
              PartyID_found = GetPartyID_byStringPartyID(CodeFromCDI.ExtIdPartySourceId.ObjectId);  // здесь должен быть PartyID
            end;
            if (PartyID_found < 0)
               out_WillMakeCIFCode = true;
               CodeFromCDI = CdiGetXref_resp.GetSystemXref("CFT");
               PersonId_CDI = CodeFromCDI.PartyId;  // код CDI
            end;
         else
            out_WillMakeCIFCode = true;
         end;

      end;
    end;
   

   if (out_WillMakeCIFCode)
/*  2021-03-01 Cherendichenko is524018 Создание кроссылок только по PersonID.
      if (Valtype(req_obj_serv.Person.CIFId) != V_UNDEF)
         out_MasterExternalId.ObjectId = req_obj_serv.Person.CIFId.ObjectID;
         out_MasterExternalId.SystemId = req_obj_serv.Person.CIFId.SystemId;
         out_MasterExternalId.SystemNodeId = req_obj_serv.Person.CIFId.SystemNodeId;
      elif (Valtype(req_obj_serv.Person.PersonID) != V_UNDEF) 
         out_MasterExternalId.ObjectId = req_obj_serv.Person.PersonID.ObjectID;
         out_MasterExternalId.SystemId = req_obj_serv.Person.PersonID.SystemId;
         out_MasterExternalId.SystemNodeId = req_obj_serv.Person.PersonID.SystemNodeId;
      end;
*/   /*
      if (Valtype(req_obj_serv.Person.PersonID) != V_UNDEF) 
         PersonGetXref_req = c_PersonGetXrefRequest;
         PersonGetXref_req.OperationalExternalId.ObjectId = req_obj_serv.Person.PersonID.ObjectID;
         PersonGetXref_req.OperationalExternalId.SystemId = "CFT";
         PersonGetXref_req.OperationalExternalId.SystemNodeId = "CFT";
      end;  */
      // BIQ-7006 Замена PersonCreateXref на CdiCreateXref
      // Сохраним ID CDI, считаем, что ссылка на АБС уже есть, поэтому этот ID тоже в наличии
      if (ValType(PersonId_CDI) != V_UNDEF)
         out_MasterExternalId = PersonId_CDI;
      end;
   end;


/* 2020-10-30 is 518060, 511265 Срочно и критично отключено в рамках инцидентов по темам
   if (PartyID_found <= 0)    // все еще не нашли субъекта
      // проверка по ИНН, так как все равно не даст создать
      if (ValType(req_obj_serv.Person.INN) != V_UNDEF)
         vINN = req_obj_serv.Person.INN;
         PartyID_found = GetPartyID_byPartyCode(PTCK_INN, vINN);
      end;
   end;
*/
         
   if (PartyID_found > 0) // субъект найден в АБС
      //	Производится обновление данных по Субъекту, в соответствии с полученными значениями, обработка данных прекращается, формируется ответное сообщение, которое возвращается в Адаптер;
      pparty = adp_Party(req_obj_serv, PartyID_found);
      var pname_old = GetPartyName(PartyID_found, false);

      if (CheckEqualPersnPapers(pparty.PersnPapers, PartyID_found))
         pparty.PersnPapers = null;  // если ДУЛ совпадают с существующими, то не передаем
      end;

      var phone_old = getContact(PartyID_found, CV_CONTACT_KIND_PHONE, CV_CONTACT_TYPE_MOBILE);

      UpdateParty(
                   PartyID_found
                  ,pparty.PartyCode
                  ,pparty.PersnParam
                  ,pparty.InstParam
                  ,pparty.ClientParam
                  ,pparty.Codes
                  ,pparty.Addresses
                  ,pparty.Contacts
                  ,pparty.PersnPapers
                  ,pparty.RegDocs
                  ,pparty.PartyNotes
                  ,pparty.PersnNotes
                  ,pparty.SettAccs
                 );
      resp_obj_serv = PartyID_found;
      // процедура ничего не возвращает, поэтому если не выпало в ошибку, считаем, что все нормально
      resp_resultCode = 0;
      resp_resultText = "OK";

//def-59325 если изменился номер телефона, то выгрузим в брокер     
      if(CheckChangeContact(phone_old,pparty.Contacts))
         CheckAndPushUnloadQUIKBroker(PartyID_found,true);
      end;

      // BIQ-7426 Гераськина Т.В. класс ответа расширен и теперь содержит все данные по клиенту
      //SetParm(1,resp_obj_serv);
      InsertPersonOut.ClientID = resp_obj_serv; 

      var sql, cmd, ErrorCode,ErrorDesc ;

      sql = "call it_broker.Client_info('<XML action = \"UPD\" tab = \"DPARTY_DBT\" pkcol = \"T_PARTYID\" pk = \""+PartyID_found+"\"/>', ?, ?);";
      //sql = "call it_broker.Client_info('<CDC><XML_action>UPD</XML_action><tab>DPARTY_DBT</tab><pkcol>T_PARTYID</pkcol><pk>"+PartyID_found+"</pk></CDC>', ?, ?);";

      cmd = RSDCommand(sql);
      cmd.addParam("ErrorCode", RSDBP_OUT, V_INTEGER);
      cmd.addParam("ErrorDesc", RSDBP_OUT, V_STRING);
      cmd.execute();

      ErrorCode = cmd.value("ErrorCode");
      ErrorDesc = cmd.value("ErrorDesc");
   
      cmd.close(); cmd = NULL; sql = NULL;


   else  // субъект не найден
      //            k.	Если Субъект не найден, то производится создание нового Субъекта в СОФР. При этом: 
      //               i.	В параметрах Субъекта сохраняются: Идентификатор Клиента в АБС, и Глобальный идентификатор, полученный из CIF. 
      //               ii.	Формируется запись в Таблицу Событий по Типу Объекта = <Кросс-ссылка Субъекта>.
      pparty = adp_Party(req_obj_serv, PartyID_found);
         
   /* Вызываем сервис */
      resp_obj_serv = InsertParty(
                                  pparty.PersnParam
                                 ,pparty.InstParam
                                 ,pparty.ClientParam
                                 ,pparty.Codes
                                 ,pparty.Addresses
                                 ,pparty.Contacts
                                 ,pparty.PersnPapers
                                 ,pparty.RegDocs
                                 ,pparty.PartyNotes
                                 ,pparty.PersnNotes
                                 ,pparty.SettAccs
                                );

      if (ValType(resp_obj_serv) == V_UNDEF)
         resp_resultCode = ERR_CODE_TECH_ERROR;
         resp_resultText = getErrMsg();
      else
         resp_resultCode = 0;
         resp_resultText = "OK";
         
         // BIQ-7426 Гераськина Т.В. класс ответа расширен и теперь содержит все данные по клиенту
         //SetParm(1,resp_obj_serv);
         InsertPersonOut.ClientID = resp_obj_serv;
      end;
   end;
   
   if (resp_resultCode == 0)

      // наименования
//      if (ValType(pparty.Names) != V_UNDEF)  // переменная объявлена как массив
      if (pparty.Names.size > 0) 
         for (party_name, pparty.Names)
            SetPartyNames(resp_obj_serv, party_name.PartyNameID, party_name.Name);
         end;
      end;
   
      // открываем счета постфактум, так как нужен клиент 
      // BIQ-7683 Гераськина Т.В. для списка ListAcctsBrok список БИКов счетов
      if ( (Valtype(pparty.SettAccs) != V_UNDEF) and (pparty.SettAccs.size > 0) )
         var our_bic_ = GetBankCode("0000");
         for (SetAcc_temp, pparty.SettAccs) 
            if (SetAcc_temp.BankCode == our_bic_)
               FindOpenAccount(SetAcc_temp.Account, resp_obj_serv);
            end;
         end;
      end;
   
      // категории, передаем массив
      SetCategories(resp_obj_serv, pparty.Categories);
         
      // Codes_weak
      if (ValType(pparty.Codes_weak) != V_UNDEF)
         SetCodesWeak(resp_obj_serv, pparty.Codes_weak);
      end;
      
      // Notes_weak
      if (ValType(pparty.Notes_weak) != V_UNDEF)
         SetNotesWeak(resp_obj_serv, pparty.Notes_weak);
      end;

      // уровень риска
      if (ValType(req_obj_serv.Person.RiskLevel) != V_UNDEF)
         SetRiskLevel(resp_obj_serv, req_obj_serv.Person.RiskLevel, req_obj_serv.Person.RiskReason);
      end;
      
      // связанные субъекты
      if (ValType(req_obj_serv.Person.CoupledSubjectList) != V_UNDEF)
         for (CoupledSubject, req_obj_serv.Person.CoupledSubjectList)
            SetCoupledSubject(resp_obj_serv, CoupledSubject);
         end;
      end;

      if (pparty.code_vtb != "-1")
         MarkCodesMatch(pparty.code_value, resp_obj_serv);
      end;
      
      // открываем договор брокерского обслуживания
      if (ValType(req_obj_serv.Person.AgreementInfoList) != V_UNDEF)
//SetRSTrace(true);  //17-06-2020 по теме 511711
         object_contr = OpenContract(resp_obj_serv, req_obj_serv.Person.AgreementInfoList, pparty.email_contract, 
                                     req_obj_serv.Person.FinConsBrok, req_obj_serv.Person.Agreement_temp.ConditionDate, @out_dlcontrid);
//SetRSTrace(false);  //17-06-2020 по теме 511711
         // BIQ-7426 Гераськина Т.В. открытие договора возвращает массив кодов ЕКК для всех открытых договоров БО
         if(ValType(object_contr) == V_GENOBJ)
            if (object_contr.size > 0)
               InsertPersonOut.MarketCodeList = object_contr;
            else 
               InsertPersonOut.MarketCodeList = NULL;
            end;
         else 
            InsertPersonOut.MarketCodeList = NULL;
         end;
         
      else
          // DEF-35472 смена ФИО
         var pname = GetPartyName(resp_obj_serv, false);
         if (Pname_old != pname)

            var rs_k = RSDRecordSet("select dl.t_dlcontrid from "+
                                    "     dsfcontr_dbt sf,  ddlcontr_dbt dl "+
                                    "     where sf.t_id = DL.T_SFCONTRID "+
                                    "     and sf.t_partyid = "+resp_obj_serv);

            if (rs_k.movenext)                                                
               UpdateNameSubContract(rs_k.value("t_dlcontrid"), pname);
            end;
            execmacrofile("dlcontrfunc", "ChangeNameAccount", resp_obj_serv);
         end;

         // принадлежности
         SetPartyOwn(resp_obj_serv, PTK_CONTR); // контрагент по сделкам
         SetPartyOwn(resp_obj_serv, PTK_PACT ); // контрагент по договорам
      end;
      // обновление всех почт в открытых договорах
      if (ValType(pparty.email_contract) != V_UNDEF)
         UpdateContractEmail_ByNewEmail(resp_obj_serv, pparty.email_contract);
      end;
      
      //BIQ-7426 Гераськина Т.В. изменен ответ
      InsertPersonOut.ErrorList = NULL;
   else 
      //BIQ-7426 Гераськина Т.В. изменен ответ
      InsertPersonOut.ErrorList = TArray;
      vSize = InsertPersonOut.ErrorList.size;
      InsertPersonOut.ErrorList.value(vSize) = c_Error;
      InsertPersonOut.ErrorList.value(vSize).ErrorCode = resp_resultCode;
      InsertPersonOut.ErrorList.value(vSize).ErrorDesc = resp_resultText;
      
   end;
   
   return InsertPersonOut;
      
onError(err)
   /* Получаем объектный вид ответа */
   //BIQ-7426 Гераськина Т.В. изменен ответ
   InsertPersonOut.ErrorList = TArray;
   vSize = InsertPersonOut.ErrorList.size;
   InsertPersonOut.ErrorList.value(vSize) = c_Error;
   InsertPersonOut.ErrorList.value(vSize).ErrorCode = c_err_obj.obtain_err_code(err);
   InsertPersonOut.ErrorList.value(vSize).ErrorDesc = c_err_obj.obtain_err_msg(err);   
   SetPersonAddDBLog(InsertPersonOut.ErrorList.value(vSize).ErrorDesc);
   // откат транзакции
   //AbortTrn();
   
   return InsertPersonOut;
end;


/*---------------------------------------*/
/* Открытие клиента                      */
/*---------------------------------------*/
macro adp_SetPerson(IncomeData, p_log_id, p_transparent_id, out_WillMakeCIFCode:@bool, 
                    out_MasterExternalId:@c_IntegrationSymbolicIdentifierXType, out_dlcontrid:@Tarray ) /* 20190103 - kva - протаскиваем id для логирования */
   var req_data = NULL;

   var resp_data_obj = NULL;
   
   var v_result, v_xml;
   var err_txt="", out_code = 0, aux_buff;   
   
   // BIQ-7426 Гераськина Т.В. класс ответа расширен и теперь содержит все данные по клиенту
   //var ErrorAction_arr = TArray;
   var InsertPersonOut;
   
   var ClientID = NULL;
   
   if(ValType(IncomeData) == V_UNDEF)
      RunError(ERR_TEXT_NO_IN_MSG, c_err_obj(ERR_TEXT_NO_IN_MSG,
                                             ERR_CODE_NO_IN_PRM));
   end;   
         
   //готовый объект, преобразования вовне
   req_data =  uTryToGetPropS(IncomeData, "SetPersonRequest");
   
   // единичная обработка
   // BIQ-7426 Гераськина Т.В. ClientID перенесен в класс ответа
   InsertPersonOut = InsertPerson_single(req_data, p_transparent_id, @out_WillMakeCIFCode, @out_MasterExternalId); /* 20190103 - kva - протаскиваем id для логирования */
   
   // итоговый класс 
   // BIQ-7426 Гераськина Т.В. ответ расширен и содержит дополнительный массив
   resp_data_obj = c_SetPerson_outObj;
   if ( (InsertPersonOut.ErrorList) and (InsertPersonOut.ErrorList.size > 0) )
      if (InsertPersonOut.ErrorList.value(0).ErrorCode != 0)
         resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ResultCode = 1;
      else
         resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ResultCode = 0;
      end;
   elif (g_err_arr.size != 0)
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ResultCode = 2;
   else
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ResultCode = 0;
   end;
   if (ValType(req_data.RequestId) != V_UNDEF )
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.RequestId = c_IntegrationSymbolicIdentifierXType;
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.RequestId.Objectid = req_data.RequestId.ObjectId;
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.RequestId.SystemId = req_data.RequestId.SystemId;
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.RequestId.SystemNodeId = req_data.RequestId.SystemNodeId;
   end;
   if (ValType(InsertPersonOut.ClientId) != V_UNDEF )
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ClientID = c_IntegrationSymbolicIdentifierXType;
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ClientID.Objectid = InsertPersonOut.ClientID;
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ClientID.SystemId = "SOFR";
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ClientID.SystemNodeId = "0000";
   end;

   if((g_err_arr.size != 0) and (resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ResultCode == 2))
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ErrorList = TArray;
      var i = 0;
      for (var err, g_err_arr)
         resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ErrorList.value(i) = c_Error;
         resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ErrorList.value(i).ErrorCode = err.get_err_code();
         resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ErrorList.value(i).ErrorDesc = err.get_err_msg();
         i = i + 1;
      end; 
   else 
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ErrorList = InsertPersonOut.ErrorList;
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.MarketCodeList = InsertPersonOut.MarketCodeList;
   end;

   
   //resp_data_obj.SetPersonResponseMsg.SetPersonResponse.MarketCodeList = null;   

   
   SetGlobalParameter("CodeContractEKK", "");
   return resp_data_obj;
   
onError(err)
   out_code = c_err_obj.obtain_err_code(err);
   err_txt = c_err_obj.obtain_err_msg(err);

   resp_data_obj = c_SetPerson_outObj;
   resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ResultCode = 1;
   
   // BIQ-7426 Гераськина Т.В. ответ расширен и содержит дополнительный массив
   if (ValType(req_data.RequestId) != V_UNDEF )
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.RequestId = c_IntegrationSymbolicIdentifierXType;
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.RequestId.Objectid = req_data.RequestId.ObjectId;
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.RequestId.SystemId = req_data.RequestId.SystemId;
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.RequestId.SystemNodeId = req_data.RequestId.SystemNodeId;
   end;
   if (ValType(ClientId) != V_UNDEF )
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ClientID = c_IntegrationSymbolicIdentifierXType;
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ClientID.Objectid = InsertPersonOut.ClientID;
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ClientID.SystemId = "SOFR";
      resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ClientID.SystemNodeId = "0000";
   end;
   resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ErrorList = TArray;
   resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ErrorList.value(0) = c_Error;
   resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ErrorList.value(0).ErrorCode = out_code;
   resp_data_obj.SetPersonResponseMsg.SetPersonResponse.ErrorList.value(0).ErrorDesc = err_txt;
   
   resp_data_obj.SetPersonResponseMsg.SetPersonResponse.MarketCodeList = NULL;
   SetGlobalParameter("CodeContractEKK", "");

   SetPersonAddDBLog(err_txt);

   return resp_data_obj;
end;

/*---------------------------------------*/
/* Адаптер для Сервиса открытия субъекта */
/*---------------------------------------*/
macro SetPersonRequestMsg(IncomeData, in_log_id, in_transparent_id, out_WillMakeCIFCode:@bool, out_MasterExternalId:@c_IntegrationSymbolicIdentifierXType, out_global_error:@string, out_dlcontrid:@TArray) 
   var out_obj;
   out_obj = adp_SetPerson(IncomeData, in_log_id, in_transparent_id, @out_WillMakeCIFCode, @out_MasterExternalId, @out_dlcontrid); 
   out_global_error = g_error_text;
   return out_obj;
end;

