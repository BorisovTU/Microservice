/*-----------------------------------------------------*/
/* Создание сделки из Кондор+                  */
/*                                                     */
/* Автор: Гераськина Т.                                */
/*
*/
/*----------------------------------------------*/
import "ws_msg_transform_sec.mac"; /* Инструментарий для преобразования сообщений */
import "secur_prc_msg_transform.mac";     /* Функционал преобразования сообщений */
import "ws_impdeals.mac";          /* Загрузка МБК/КО сделок в бэк-офис из шлюза */

private macro getValueFromProperty(_obj, _nameproperty, _nametag, _isrequired)
   var res: variant;
   var vnametag;
   var err_txt;

   res = uTryToGetPropS(_obj, _nameproperty);
   if (_isrequired)
      if(ValType(res) == V_UNDEF)
         vnametag = _nametag+"."+_nameproperty;
         err_txt = ERR_TEXT_NO_IN_MSG +": "+vnametag;
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM));
      end;
   end;
   
   return res;
end;

private class c_Result
   var Code : integer;  // Поле Код, обязательное: Да
   var Text : string;   // Поле Текст, обязательное: Нет
end;

private class c_MainResult
   var Code : integer;  // Поле Код, обязательное: Да
   var Text : string;   // Поле Текст, обязательное: Нет
   var DealList = TArray;    // Результат загрузки лимитов   
end;


// класс Результата по одной записи
private class c_DealParm     
   var ExternalID : string;  // ИД сделки во внешней системе
   var DealID     : string;  // Уникальный ИД сделки в К+
   var SOFRDealID : string;  // ИД сделки в СОФР
   var Result     : c_Result; // Результат обработки запроса
end;

// параметры ответа
private class c_ProcessDealsResponse ()
   var ReqID      : string;   // ИД исходного запроса
   var SenderId   : string;   // Код АС-получателя ответа
   var Result     : c_MainResult; // Результат обработки запроса
end;

// параметры ответа
private class c_outObj()
   var ProcessDeals_resp = c_ProcessDealsResponse; // имя строго по названию тега
end;

// идентификация сделки 
private class c_IdentityDeal(IncomeData)
   var ActionType       : Integer;  // Тип действия                              Да    "1= добавить 2 = изменить 3 = удалить"
   var ExternalID       : String;   // Идентификатор сделки в исходной системе   Да    Идентификатор
   var TSBrief          : String;   // Код торговой площадки/торговой системы    Да    Справочник
   var DealID           : String;   // Уникальный идентификатор сделки в К+      Да
   var DealKind         : String;   // Тип сделки                                Да    Справочник
   var DealDate         : date;     // Дата заключения сделки                    Да
   var DealTime         : datetime; // Время заключения сделки                   Да
   var DealCaptureTime  : datetime; // Дата, время создания сделки в К+          Да
   var DealCorrectTime  : datetime; // Дата, время последнего изменения сделки   Да
   var BuySell          : String;   // Направление                               Да    Справочник
   var Netting          : bool;     // признак неттинга                          Нет
   var FO               : String;   // Тип операции по сделке                    Нет   Справочник
   var ConversationID   : String;   // Номер переговоров                         Нет
   var ConversationText : String;   // Текст переговоров                         Нет
   var Comment          : String;   // Комментарий к сделке                      Нет
   var GenAgreement     : String;   // Ген.соглашение                            Нет
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)   
      private var err_txt;
      var nametag_up = "IdentityDeal";

      if(ValType(IncomeData) != V_UNDEF)
         ActionType        = getValueFromProperty(IncomeData, "ActionType"       , nametag_up, true);
         ExternalID        = getValueFromProperty(IncomeData, "ExternalID"       , nametag_up, true);
         TSBrief           = getValueFromProperty(IncomeData, "TSBrief"          , nametag_up, true);
         DealID            = getValueFromProperty(IncomeData, "DealID"           , nametag_up, true);
         DealKind          = getValueFromProperty(IncomeData, "DealKind"         , nametag_up, true);
         DealDate          = getValueFromProperty(IncomeData, "DealDate"         , nametag_up, true);
         DealTime          = getValueFromProperty(IncomeData, "DealTime"         , nametag_up, true);
         DealCaptureTime   = getValueFromProperty(IncomeData, "DealCaptureTime"  , nametag_up, true);
         DealCorrectTime   = getValueFromProperty(IncomeData, "DealCorrectTime"  , nametag_up, true);
         BuySell           = getValueFromProperty(IncomeData, "BuySell"          , nametag_up, true);
         Netting           = getValueFromProperty(IncomeData, "Netting"          , nametag_up);
         FO                = getValueFromProperty(IncomeData, "FO"               , nametag_up);
         ConversationID    = getValueFromProperty(IncomeData, "ConversationID"   , nametag_up);
         ConversationText  = getValueFromProperty(IncomeData, "ConversationText" , nametag_up);
         Comment           = getValueFromProperty(IncomeData, "Comment"          , nametag_up);
         GenAgreement      = getValueFromProperty(IncomeData, "GenAgreement"     , nametag_up);
         
         // проверка по списку значений
         if(ValType(ActionType) != V_UNDEF)
            if ( (ActionType == 1) or (ActionType == 2) or (ActionType == 3) )
            else
               err_txt = string("Недопустимое значение ", nametag_up ,".ActionType = ",ActionType);
               RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
            end;
         end;
      end;
   end;

   uInitPrime(IncomeData);   
end;

// Параметры расчетов
private class c_Calculate(IncomeData, _nametag_up)
   var Frequency     : String;   // Периодичность     Да    Справочник
   var FrequencyDay  : Integer;  // Количество дней   Нет
   var FrequencyFix  : String;   // Частота фиксации  Нет   Справочник
   var Type          : String;   // Порядок расчетов  Да    Справочник
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var err_txt;
      private var nametag_up = "Calculate";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
         
      if(ValType(IncomeData) != V_UNDEF)
         Frequency      = getValueFromProperty(IncomeData, "Frequency"     , nametag_up, true);
         FrequencyDay   = getValueFromProperty(IncomeData, "FrequencyDay"  , nametag_up);
         FrequencyFix   = getValueFromProperty(IncomeData, "FrequencyFix"  , nametag_up);
         Type           = getValueFromProperty(IncomeData, "Type"          , nametag_up, true);
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Обеспечение
private class c_Collateral(IncomeData, _nametag_up)
   var DateBegin     : date;     // Дата начала договора обеспечения    Да
   var DateEnd       : date;     // Дата окончания договора обеспечения Да
   var AgreeNumber   : String;   // Номер договора                      Да
   var Type          : String;   // Тип обеспечения                     Да    Справочник
   var Quantity      : Double;   // Количество единиц                   Нет
   var Rate          : Double;   // Курс                                Нет
   var CurrencyCode  : String;   // Код валюты обеспечения              Да    Справочник
   var Amount        : Double;   // Сумма обеспечения                   Да
   var Price         : Double;   // Цена по номиналу                    Да
   var PriceCoupon   : Double;   // Цена купона                         Нет
   var PriceFull     : Double;   // Итоговая цена                       Нет
   var AmountProvide : Double;   // Взвешенная сумма                    Нет
   var MetodClearing : String;   // Способ расчета                      Нет   Справочник
   var HairCut       : Double;   // Разница стоимости залога и полученного кредита     Нет
   var HairCutMetod  : String;   // Метод расчета разницы стоимости залога и кредита   Нет   Справочник
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var err_txt;
      private var nametag_up = "CollateralList.Collateral";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      if(ValType(IncomeData) != V_UNDEF)
         DateBegin      = getValueFromProperty(IncomeData, "DateBegin"     , nametag_up, true);
         DateEnd        = getValueFromProperty(IncomeData, "DateEnd"       , nametag_up, true);
         AgreeNumber    = getValueFromProperty(IncomeData, "AgreeNumber"   , nametag_up, true);
         Type           = getValueFromProperty(IncomeData, "Type"          , nametag_up, true);
         Quantity       = getValueFromProperty(IncomeData, "Quantity"      , nametag_up);
         Rate           = getValueFromProperty(IncomeData, "Rate"          , nametag_up);
         CurrencyCode   = getValueFromProperty(IncomeData, "CurrencyCode"  , nametag_up, true);
         Amount         = getValueFromProperty(IncomeData, "Amount"        , nametag_up, true);
         Price          = getValueFromProperty(IncomeData, "Price"         , nametag_up, true);
         PriceCoupon    = getValueFromProperty(IncomeData, "PriceCoupon"   , nametag_up);
         PriceFull      = getValueFromProperty(IncomeData, "PriceFull"     , nametag_up);
         AmountProvide  = getValueFromProperty(IncomeData, "AmountProvide" , nametag_up);
         MetodClearing  = getValueFromProperty(IncomeData, "MetodClearing" , nametag_up);
         HairCut        = getValueFromProperty(IncomeData, "HairCut"       , nametag_up);
         HairCutMetod   = getValueFromProperty(IncomeData, "HairCutMetod"  , nametag_up);
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Денежные потоки (график платежей)
private class c_CashPayment(IncomeData, _nametag_up)
   var NumberPayment : integer;  // Порядковый номер платежа
   var DateBegin     : date;     // Дата начала периода        Да
   var DateEnd       : date;     // Дата окончания периода     Да
   var DatePay       : date;     // Дата платежа за период     Да
   var Amount        : Double;   // Сумма платежа              Да
   var Type          : String;   // Тип платежа                Да    Справочник
   var Rate          : Double;   // Ставка                     Да
   var RateType      : String;   // Тип ставки                 Да    Справочник
   var FixDate       : date;     // Дата фиксинга
   var Comments      : String;   // Комментарий                Нет
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var err_txt;
      private var nametag_up = "CashFlow.Payment";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      if(ValType(IncomeData) != V_UNDEF)
         NumberPayment  = getValueFromProperty(IncomeData, "NumberPayment" , nametag_up);
         DateBegin      = getValueFromProperty(IncomeData, "DateBegin"     , nametag_up, true);
         DateEnd        = getValueFromProperty(IncomeData, "DateEnd"       , nametag_up, true);
         DatePay        = getValueFromProperty(IncomeData, "DatePay"       , nametag_up, true);
         Amount         = getValueFromProperty(IncomeData, "Amount"        , nametag_up, true);
         Type           = getValueFromProperty(IncomeData, "Type"          , nametag_up, true);
         Rate           = getValueFromProperty(IncomeData, "Rate"          , nametag_up, true);
         RateType       = getValueFromProperty(IncomeData, "RateType"      , nametag_up, true);
         FixDate        = getValueFromProperty(IncomeData, "FixDate"       , nametag_up);
         Comments       = getValueFromProperty(IncomeData, "Comments"      , nametag_up);
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Платежи
private class c_Payment(IncomeData, _nametag_up)
   var ValueDate1 : date;     // Дата расчетов 1   Да
   var ValueDate2 : date;     // Дата расчетов 2   Да
   var Amount1    : Double;   // Сумма сделки 1    Да    продажа - со знаком минус
   var Amount2    : Double;   // Сумма сделки 2    Да    продажа - со знаком минус
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var err_txt;
      private var nametag_up = "Payments";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      if(ValType(IncomeData) != V_UNDEF)
         ValueDate1  = getValueFromProperty(IncomeData, "ValueDate1" , nametag_up, true);
         ValueDate2  = getValueFromProperty(IncomeData, "ValueDate2" , nametag_up, true);
         Amount1     = getValueFromProperty(IncomeData, "Amount1"    , nametag_up, true);
         Amount2     = getValueFromProperty(IncomeData, "Amount2"    , nametag_up, true);
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Амортизация
private class c_Amortization(IncomeData, _nametag_up)
   var Type       : String;   // Тип                           Да    Справочник
   var AmountFix  : Double;   // Фиксированная сумма           Нет
   var Freq       : String;   // Периодичность амортизации     Нет   Справочник
   var DateFix    : date;     // Расчетная дата амортизации    Нет
   var DateEnd    : date;     // Окончательная дата расчетов   Нет
   var AmountRest : Double;   // Остаток суммы амортизации     Нет
   var Rate       : Double;   // Процентная ставка амортизации Нет
   var TermAmount : double;   // Сумма погашения при ликвидации сделки  Нет
   var TermClFee  : double;   // Сумма % при ликвидации        Нет
   var TermAccrued: double;   // Сумма начисленных %           Нет
   var TermNpv    : double;   // Чистая стоимость              Нет
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var err_txt;
      private var nametag_up = "Amortization";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      if(ValType(IncomeData) != V_UNDEF)
         Type        = getValueFromProperty(IncomeData, "Type"       , nametag_up, true);
         AmountFix   = getValueFromProperty(IncomeData, "AmountFix"  , nametag_up);
         Freq        = getValueFromProperty(IncomeData, "Freq"       , nametag_up);
         DateFix     = getValueFromProperty(IncomeData, "DateFix"    , nametag_up);
         DateEnd     = getValueFromProperty(IncomeData, "DateEnd"    , nametag_up);
         AmountRest  = getValueFromProperty(IncomeData, "AmountRest" , nametag_up);
         Rate        = getValueFromProperty(IncomeData, "Rate"       , nametag_up);
         TermAmount  = getValueFromProperty(IncomeData, "TermAmount" , nametag_up);
         TermClFee   = getValueFromProperty(IncomeData, "TermClFee"  , nametag_up);
         TermAccrued = getValueFromProperty(IncomeData, "TermAccrued", nametag_up);
         TermNpv     = getValueFromProperty(IncomeData, "TermNpv"    , nametag_up);
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Описание металла
private class adp_PrecMetal(IncomeData, _nametag_up)
   var DmType        : string;   // Единица измерения       Да    "g = граммы o = унции"
   var Amount        : double;   // Количество              Да
   var Price         : double;   // Цена за единицу         Да
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var err_txt;
      private var nametag_up = "PrecMetal";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      if(ValType(IncomeData) != V_UNDEF)
         DmType   = getValueFromProperty(IncomeData, "DmType"  , nametag_up, true);
         Amount   = getValueFromProperty(IncomeData, "Amount"  , nametag_up, true);
         Price    = getValueFromProperty(IncomeData, "Price"   , nametag_up, true);

         // проверка по списку значений
         if(ValType(DmType) != V_UNDEF)
            if ( (StrUpr(DmType) == StrUpr("g")) or (StrUpr(DmType) == StrUpr("o")) )
            else
               err_txt = string("Недопустимое значение ", nametag_up, ".DmType = ",DmType);
               RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
            end;
         end;
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

private class adp_LegsDeal(IncomeData, _nametag_up)
   var LegsNumber       : integer;     // Номер ноги                          Да       1 или 2
   var Rate             : double;      // Курс сделки                         Да
   var RateDirection    : string;      // Направление курса                   Нет      D - прямой I - обратный
   var RateQutationUnit	: integer;     // Масштаб курса (количество единиц)   Нет
   var Netting          : bool;        // признак неттинга                    Да
   var PrecMetal                 ;     // Описание металла     Контейнер      Нет
   var Payments                  ;     // Платежи                             Да
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var err_txt,aux_buff;
      private var nametag_up = "LegsDealsList.LegsDeal";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      if(ValType(IncomeData) != V_UNDEF)
         LegsNumber        = getValueFromProperty(IncomeData, "LegsNumber"       , nametag_up, true);
         Rate              = getValueFromProperty(IncomeData, "Rate"             , nametag_up, true);
         RateDirection     = getValueFromProperty(IncomeData, "RateDirection"    , nametag_up);
         RateQutationUnit  = getValueFromProperty(IncomeData, "RateQutationUnit" , nametag_up);
         Netting           = getValueFromProperty(IncomeData, "Netting"          , nametag_up, true);
         
         // проверка по списку значений
         if(ValType(LegsNumber) != V_UNDEF)
            if ( (LegsNumber == 1) or (LegsNumber == 2) )
            else 
               err_txt = string("Недопустимое значение ", nametag_up, ".LegsNumber = ",LegsNumber);
               RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
            end;
         end;
         if (ValType(RateDirection) != V_UNDEF)
            if ( (RateDirection == "D") or (RateDirection == "I") )
            else
               err_txt = string("Недопустимое значение ", nametag_up, ".RateDirection = ",RateDirection);
               RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
            end;
         end;
         
         // контейнеры
         aux_buff  = getValueFromProperty(IncomeData, "PrecMetal", nametag_up);
         if(ValType(aux_buff) != V_UNDEF)
            PrecMetal = adp_PrecMetal(aux_buff, nametag_up);
         end;

         aux_buff  = getValueFromProperty(IncomeData, "Payments", nametag_up, true);
         if(ValType(aux_buff) != V_UNDEF)
            Payments = c_Payment(aux_buff, nametag_up);
         end;
         
      else
         err_txt = ERR_TEXT_NO_IN_MSG +": "+nametag_up;
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM)); 
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

private class adp_Fixing(IncomeData, _nametag_up)
   var FixDate    : date;     // Дата фиксинга        Да
   var FixCurr    : String;   // Валюта фиксинга      Да
   var FixRate    : Double;   // Курс фиксинга        Да
   var FixAmount  : Double;   // Сумма фиксинга       ?
   var FixSource  : String;   // Источник фиксинга    Нет

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var err_txt;
      private var nametag_up = "Fixing";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      if(ValType(IncomeData) != V_UNDEF)
         FixDate     = getValueFromProperty(IncomeData, "FixDate"    , nametag_up, true);
         FixCurr     = getValueFromProperty(IncomeData, "FixCurr"    , nametag_up, true);
         FixRate     = getValueFromProperty(IncomeData, "FixRate"    , nametag_up, true);
         FixAmount   = getValueFromProperty(IncomeData, "FixAmount"  , nametag_up);
         FixSource   = getValueFromProperty(IncomeData, "FixSource"  , nametag_up);
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
   
end;

// Барьер цены
private class adp_BarrierPrice(IncomeData, _nametag_up)
   var Value      : double;   // Значение             Да
   var ValueUp    : double;   // Верхнее значение     Да
   var ValueDown  : double;   // Нижнее значение      Да

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var err_txt;
      private var nametag_up = "BarrierPrice";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      if(ValType(IncomeData) != V_UNDEF)
         Value       = getValueFromProperty(IncomeData, "Value"      , nametag_up, true);
         ValueUp     = getValueFromProperty(IncomeData, "ValueUp"    , nametag_up, true);
         ValueDown   = getValueFromProperty(IncomeData, "ValueDown"  , nametag_up, true);
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
   
end;

// Экспирация (исполнение) сделки
private class adp_Matutity(IncomeData, _nametag_up)
   var Date          : date;     // Дата исполнения (экспирации) сделки    Да
   var Time          : datetime; // Время исполнения сделки                Да
   var DealRelation  : string;   // Номер связанной сделки                 Да
   var Currunce      : string;   // Код валюты расчетов                    Да
   var Rate          : double;   // Курс исполнения                        Да
   var Amount1       : double;   // Сумма базовой валюты                   Да
   var PayDate       : date;     // Дата расчетов                          Да
   var Fee           : double;   // Комиссия                               Нет
   var Comment       : string;   // Комментарий                            Нет

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var nametag_up = "Matutity";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      if(ValType(IncomeData) != V_UNDEF)
         Date           = getValueFromProperty(IncomeData, "Date"          , nametag_up, true);
         Time           = getValueFromProperty(IncomeData, "Time"          , nametag_up, true);
         DealRelation   = getValueFromProperty(IncomeData, "DealRelation"  , nametag_up, true);
         Currunce       = getValueFromProperty(IncomeData, "Currunce"      , nametag_up, true);
         Rate           = getValueFromProperty(IncomeData, "Rate"          , nametag_up, true);
         Amount1        = getValueFromProperty(IncomeData, "Amount1"       , nametag_up, true);
         PayDate        = getValueFromProperty(IncomeData, "PayDate"       , nametag_up, true);
         Fee            = getValueFromProperty(IncomeData, "Date"          , nametag_up);
         Comment        = getValueFromProperty(IncomeData, "Date"          , nametag_up);
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Ценная бумага
private class adp_Securities(IncomeData, _nametag_up)
   var ISIN       : string;   // Идентификатор                       Да
   var ShortName  : string;   // Краткое наименование                Да
   var FullName   : string;   // Полное наиименование                Нет
   var Kind       : string;   // Тип                                 Нет
   var IsDrv      : bool;     // Признак производного инструмента    Нет
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      var nametag_up = "Securities";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      if(ValType(IncomeData) != V_UNDEF)
         ISIN        = getValueFromProperty(IncomeData, "ISIN"     , nametag_up, true);
         ShortName   = getValueFromProperty(IncomeData, "ShortName", nametag_up, true);
         FullName    = getValueFromProperty(IncomeData, "FullName" , nametag_up);
         Kind        = getValueFromProperty(IncomeData, "Kind"     , nametag_up);
         IsDrv       = getValueFromProperty(IncomeData, "IsDrv"    , nametag_up);
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Поставка по сделке
private class adp_Delivery (IncomeData, _nametag_up)
   var Type       : string;    
   var Date       : date;     // Дата              Нет
   var Shift      : string;   // Срок              Нет
   //var InstrNum   : string;   // Номер поручения   Нет

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var nametag_up = "Delivery";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      if(ValType(IncomeData) != V_UNDEF)
         Type     = getValueFromProperty(IncomeData, "Type",      nametag_up);
         Date     = getValueFromProperty(IncomeData, "Date",      nametag_up);
         Shift    = getValueFromProperty(IncomeData, "Shift",     nametag_up);
         //InstrNum = getValueFromProperty(IncomeData, "InstrNum",  nametag_up);
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Оплата сделки
private class adp_Payment_Equity (IncomeData, _nametag_up)
   var CurrencyCode  : string;   // Код валюты платежа               Да
   var Course        : double;   // Курс валюты платежа              Да
   var Type          : string;   // Тип отсчета срока                Нет
   var Date          : date;     // Дата                             Нет
   var Shift         : string;   // Срок                             Нет
   var Amount        : double;   // Сумма платежа в валюте сделки    Нет

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var nametag_up = "Payment";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      if(ValType(IncomeData) != V_UNDEF)
         CurrencyCode   = getValueFromProperty(IncomeData, "CurrencyCode", nametag_up, true);
         Course         = getValueFromProperty(IncomeData, "Course",       nametag_up, true);
         Type           = getValueFromProperty(IncomeData, "Type",         nametag_up);
         Date           = getValueFromProperty(IncomeData, "Date",         nametag_up);
         Shift          = getValueFromProperty(IncomeData, "Shift",        nametag_up);
         Amount         = getValueFromProperty(IncomeData, "Amount",       nametag_up);
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;


// Описание сделки с ЦБ
private class adp_Equity (IncomeData, _nametag_up)
   var DealID        : string;   // ИД сделки                                    Да
   var DealNum       : string;   // Номер сделки                                 Да
   var ExtDealNum    : string;   // Номер сделки в торговой системе              Да
   var CurrencyCode  : string;   // Код валюты сделки                            Нет
   var NKD           : double;   // Сумма НКД сделки                             Нет
   var CourseSec     : double;   // Цена ЦБ за единицу сделки                    Да
   var Qty           : double;   // Сумма сделки                                 Да
   var SettlSheme    : string;   // Тип расчетов по сделке                       Да
   var WhoIsReg      : string;   // Кто оплачивает расходы перерегистрации ЦБ    Нет
   var Delivery      ;           // Поставка по сделке                           Да
   var Payment       ;           // Оплата сделки                                Да
   var PrePyment     ;           // Предоплата сделки                            Нет

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var aux_buff;
      private var nametag_up = "Equity";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      if(ValType(IncomeData) != V_UNDEF)
         DealID         = getValueFromProperty(IncomeData, "DealID",       nametag_up, true);
         DealNum        = getValueFromProperty(IncomeData, "DealNum",      nametag_up, true);
         ExtDealNum     = getValueFromProperty(IncomeData, "ExtDealNum",   nametag_up, true);
         CurrencyCode   = getValueFromProperty(IncomeData, "CurrencyCode", nametag_up);
         NKD            = getValueFromProperty(IncomeData, "NKD",          nametag_up);
         CourseSec      = getValueFromProperty(IncomeData, "CourseSec",    nametag_up, true);
         Qty            = getValueFromProperty(IncomeData, "Qty",          nametag_up, true);
         SettlSheme     = getValueFromProperty(IncomeData, "SettlSheme",   nametag_up, true);
         WhoIsReg       = getValueFromProperty(IncomeData, "WhoIsReg",     nametag_up);
         
         // контейнеры
         aux_buff       = getValueFromProperty(IncomeData, "Delivery",     nametag_up, true);
         if (ValType(aux_buff) != V_UNDEF)
            Delivery = adp_Delivery(aux_buff, nametag_up);
         end;
         aux_buff       = getValueFromProperty(IncomeData, "Payment",      nametag_up, true);
         if (ValType(aux_buff) != V_UNDEF)
            Payment = adp_Payment_Equity(aux_buff, nametag_up);
         end;
         aux_buff       = getValueFromProperty(IncomeData, "PrePyment",    nametag_up);
         if (ValType(aux_buff) != V_UNDEF)
            PrePyment = adp_Payment_Equity(aux_buff, nametag_up);
         end;
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);

end;

// Части сделки
private class adp_PartDeal(IncomeData, _nametag_up)
   var PartNum : integer;  // Номер части             Да    "1 = прямая 2 = обратная"
   var Equity  ;           // Описание сделки с ЦБ    Да

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var err_txt;
      private var aux_buff;
      private var nametag_up = "PartDealsList.PartDeal";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      if(ValType(IncomeData) != V_UNDEF)
         PartNum        = getValueFromProperty(IncomeData, "PartNum", nametag_up, true);
         if (ValType(PartNum) != V_UNDEF)
            if ( (PartNum == 1) or (PartNum == 2) )
            else
               err_txt = string("Недопустимое значение ", nametag_up, ".PartNum = ",PartNum);
               RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
            end;
         end;
         
         aux_buff   = getValueFromProperty(IncomeData, "Equity", nametag_up, true);
         if (ValType(aux_buff) != V_UNDEF)
            Equity = adp_Equity(aux_buff, nametag_up);
         end;
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Части сделки
private class c_PartList_IRS(IncomeData, _nametag_up)
   var Number              : integer;  // Номер части сделки                     Да
   var Type                : integer;  // Тип                                    Да    "1 = в одной валюте 2 = в двух валютах 3 = в трех валютах"
   var CurrencyCode        : string;   // Код валюты сделки                      Да
   var CurrencyPrincipal   : string;   // Код основной валюты                    Нет
   var CurrencyCoupon      : string;   // Код валюты при оплате купонов          Нет
   var Amount              : double;   // Сумма сделки                           Да
   var DateBegin           : date;     // Дата начала сделки                     Да
   var DateEnd             : date;     // Дата окончания сделки                  Да
   var Basic               : string;   // Код базиса                             Нет
   var RateType            : string;   // Тип ставки                             Да
   var Rate                : double;   // Курс сделки                            Нет
   var RateDiv             : double;   // Отклонение % ставки                    Нет
   var RateFloatType       : string;   // Код вида плавающей ставки              Нет
   var RateFloatShortName  : string;   // Краткое наименование плавающей ставки  Нет
   var RateFloatFullName   : string;   // Полное наименование плавающей ставки   Нет
   var Calculate           ;           // Параметры расчетов                     Нет
   var Amortization        ;           // Амортизация                            Нет
   var CashFlow            ;           // Денежные потоки (график платежей)      Да

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var err_txt;
      private var aux_buff;
      private var nametag_up = "PartDealsList.PartDeal";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      if(ValType(IncomeData) != V_UNDEF)
         Number               = getValueFromProperty(IncomeData, "Number"              , nametag_up, true);
         Type                 = getValueFromProperty(IncomeData, "Type"                , nametag_up, true);
         CurrencyCode         = getValueFromProperty(IncomeData, "CurrencyCode"        , nametag_up, true);
         CurrencyPrincipal    = getValueFromProperty(IncomeData, "CurrencyPrincipal"   , nametag_up);
         CurrencyCoupon       = getValueFromProperty(IncomeData, "CurrencyCoupon"      , nametag_up);
         Amount               = getValueFromProperty(IncomeData, "Amount"              , nametag_up, true);
         DateBegin            = getValueFromProperty(IncomeData, "DateBegin"           , nametag_up, true);
         DateEnd              = getValueFromProperty(IncomeData, "DateEnd"             , nametag_up, true);
         Basic                = getValueFromProperty(IncomeData, "Basic"               , nametag_up);
         RateType             = getValueFromProperty(IncomeData, "RateType"             , nametag_up, true);
         Rate                 = getValueFromProperty(IncomeData, "Rate"                , nametag_up);
         RateDiv              = getValueFromProperty(IncomeData, "RateDiv"             , nametag_up);
         RateFloatType        = getValueFromProperty(IncomeData, "RateFloatType"       , nametag_up);
         RateFloatShortName   = getValueFromProperty(IncomeData, "RateFloatShortName"  , nametag_up);
         RateFloatFullName    = getValueFromProperty(IncomeData, "RateFloatFullName"   , nametag_up);

         Amortization         = getValueFromProperty(IncomeData, "Amortization"        , nametag_up);
         CashFlow             = getValueFromProperty(IncomeData, "CashFlow"            , nametag_up, true);
         
         // контейнеры
         aux_buff = getValueFromProperty(IncomeData, "Calculate", nametag_up);
         if (ValType(aux_buff) != V_UNDEF)
            Calculate = c_Calculate(aux_buff, nametag_up);
         end;
         
         aux_buff = getValueFromProperty(IncomeData, "Amortization", nametag_up);
         if (ValType(aux_buff) != V_UNDEF)
            Amortization = c_Amortization(aux_buff, nametag_up);
         end;         

         aux_buff = getValueFromProperty(IncomeData, "CashFlow", nametag_up, true);
         if(ValType(aux_buff) == V_GENOBJ)
            CashFlow = TArray;
            aux_buff = 0;
            while(IncomeData.CashFlow.size > aux_buff)
               CashFlow.value(CashFlow.size) = c_CashPayment(IncomeData.CashFlow.value(aux_buff), nametag_up);
               aux_buff = aux_buff + 1;
            end;
         else
            err_txt = string(InErrNotObj, nametag_up, ".CashFlow");
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
         end;
         
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// МБК/CSA
private class c_IAMLDDeal(IncomeData)
   private var err_txt;
   private var aux_buff;

   var TypeDeal            : integer;  // Тип сделки  1 - привлечение 2 - размещение
   var PairsName           : String;   // Код валютной пары                                  Нет   Справочник
   var CurrencyDeals       : String;   // Код валюты сделки                                  Да    Справочник
   var Rate                : Double;   // Курс сделки                                        Нет
   var CurrencyPrincipal   : String;   // Код валюты номинала                                Да    Справочник
   var CurrencyCoupon      : String;   // Код валюты процентов                               Да    Справочник
   var InterestRateType    : String;   // Тип процентной ставки                              Да    "Fix фиксированная  Float плавающая"  Справочник
   var RateFixValue        : Double;   // Значение фиксированной ставки                      Нет
   var RateFloatKind       : String;   // Тип плавающей % ставки                             Нет   Справочник
   var RateFloatShortName  : String;   // Краткое наименование плавающей ставки              Нет   Справочник
   var RateFloatFullName   : String;   // Полное наименование плавающей ставки               Нет   Справочник
   var RateFloatType       : String;   // Тип кривой                                         Нет   Справочник
   var RateFloatDev        : Double;   // Отклонение от % ставки (для плаваюшей ставки)      Нет
   var RateDiscount        : Double;   // Ставка дисконта                                    Нет
   var RateTotal           : Double;   // Итоговая ставка в %-х                              Нет
   var CallNotice          : String;   // Периодичность выплат %                             Нет   Справочник
   var MarginSpot          : Double;   // Маржа                                              Нет
   var Basis               : String;   // Базис начисления %                                 Нет   Справочник
   var InterestFirstDate   : date;     // Дата выплаты 1-го процента                         Да
   var ParentDealID        : String;   // Идентификатор родительской сделки                  Нет
   var RootDealID          : String;   // Идентификатор первичной сделки                     Нет
   var UpDealID            : String;   // Идентификатор сделки, которая была пролонгирована  Нет
   var IsNostro            : bool;     //                                                    Нет
   
   var Calculate;          // Параметры расчетов                  Нет
   var CollateralList;     // Обеспечение                         Нет
   var CashFlow;           // Денежные потоки (график платежей)   Да
   var Payments;           // Платежи                             Да
   var Amortization;       // Амортизация                         Нет

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var err_txt;
      private var aux_buff;
      private var nametag_up = "IAMLDDeal";

      TypeDeal             = getValueFromProperty(IncomeData, "TypeDeal",           nametag_up, true);
      PairsName            = getValueFromProperty(IncomeData, "PairsName",          nametag_up);
      CurrencyDeals        = getValueFromProperty(IncomeData, "CurrencyDeals",      nametag_up, true);
      Rate                 = getValueFromProperty(IncomeData, "Rate",               nametag_up);
      CurrencyPrincipal    = getValueFromProperty(IncomeData, "CurrencyPrincipal",  nametag_up, true);
      CurrencyCoupon       = getValueFromProperty(IncomeData, "CurrencyCoupon",     nametag_up, true);
      InterestRateType     = getValueFromProperty(IncomeData, "InterestRateType",   nametag_up, true);
      RateFixValue         = getValueFromProperty(IncomeData, "RateFixValue",       nametag_up);
      RateFloatKind        = getValueFromProperty(IncomeData, "RateFloatKind",      nametag_up);
      RateFloatShortName   = getValueFromProperty(IncomeData, "RateFloatShortName", nametag_up);
      RateFloatFullName    = getValueFromProperty(IncomeData, "RateFloatFullName",  nametag_up);
      RateFloatType        = getValueFromProperty(IncomeData, "RateFloatType",      nametag_up);
      RateFloatDev         = getValueFromProperty(IncomeData, "RateFloatDev",       nametag_up);
      RateDiscount         = getValueFromProperty(IncomeData, "RateDiscount",       nametag_up);
      RateTotal            = getValueFromProperty(IncomeData, "RateTotal",          nametag_up);
      CallNotice           = getValueFromProperty(IncomeData, "CallNotice",         nametag_up);
      MarginSpot           = getValueFromProperty(IncomeData, "MarginSpot",         nametag_up);
      Basis                = getValueFromProperty(IncomeData, "Basis",              nametag_up);
      InterestFirstDate    = getValueFromProperty(IncomeData, "InterestFirstDate",  nametag_up, true);
      ParentDealID         = getValueFromProperty(IncomeData, "ParentDealID",       nametag_up);
      RootDealID           = getValueFromProperty(IncomeData, "RootDealID",         nametag_up);
      UpDealID             = getValueFromProperty(IncomeData, "UpDealID",           nametag_up);
      IsNostro             = getValueFromProperty(IncomeData, "IsNostro",           nametag_up);
         
      // проверка по списку значений
      if (ValType(TypeDeal) != V_UNDEF)
         if ( (TypeDeal == 1) or (TypeDeal == 2) )
         else
            err_txt = string("Недопустимое значение ", nametag_up, ".TypeDeal = ",TypeDeal);
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
         end;
      end;
      if (ValType(InterestRateType) != V_UNDEF)
         if ( (StrUpr(InterestRateType) == StrUpr("Fix")) or (StrUpr(InterestRateType) == StrUpr("Float")) )
         else
            err_txt = string("Недопустимое значение ", nametag_up, ".InterestRateType = ",InterestRateType);
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
         end;
      end;
      
      // контейнеры
      aux_buff = getValueFromProperty(IncomeData, "Calculate", nametag_up);
      if (ValType(aux_buff) != V_UNDEF)
         Calculate = c_Calculate(aux_buff, nametag_up);
      end;
      
      aux_buff = getValueFromProperty(IncomeData, "CollateralList", nametag_up);
      if(ValType(aux_buff) != V_UNDEF)
         CollateralList = TArray;
         aux_buff = 0;
         while(IncomeData.CollateralList.size > aux_buff)
            CollateralList.value(CollateralList.size) = c_Collateral(IncomeData.CollateralList.value(aux_buff),nametag_up);
            aux_buff = aux_buff + 1;
         end;
      end;

      aux_buff = getValueFromProperty(IncomeData, "CashFlow", nametag_up, true);
      if(ValType(aux_buff) == V_GENOBJ)
         CashFlow = TArray;
         aux_buff = 0;
         while(IncomeData.CashFlow.size > aux_buff)
            CashFlow.value(CashFlow.size) = c_CashPayment(IncomeData.CashFlow.value(aux_buff), nametag_up);
            aux_buff = aux_buff + 1;
         end;
      else
         err_txt = string(InErrNotObj, nametag_up, ".CashFlow");
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
      end;
      
      aux_buff = getValueFromProperty(IncomeData, "Payments", nametag_up, true);
      if(ValType(aux_buff) != V_UNDEF)
         Payments = c_Payment(aux_buff, nametag_up);
      end;

      aux_buff = getValueFromProperty(IncomeData, "Amortization", nametag_up);
      if (ValType(aux_buff) != V_UNDEF)
         Amortization = c_Amortization(aux_buff, nametag_up);
      end;

   end; /* macro uInitPrime() */

   uInitPrime(IncomeData);
end;

// TOD/TOM/SPOD
private class c_CurrencyDeal(IncomeData)
   var PairsName           : String;   // Код валютной пары                      Нет   Справочник
   var CurrencyDeals       : String;   // Код валюты сделки                      Да    Справочник
   var Rate                : Double;   // Курс сделки                            Да
   var RateDirection       : String;   // Направление курса	                     Нет   "D - прямой I - обратный"
   var RateQutationUnit    : Integer;  // Масштаб курса (количество единиц)      Нет
   var MarginSpot          : Double;   // Маржа                                  Нет
   var PreCon              : String;   // Условия предоплаты                     Нет
   var IsNostro            : bool;     // Признак постановки на НОСТРО позицию   Да
   var IsDerivative        : bool;     // Признак Производного инструмента       Да
   var Bnote               : bool;     // Признак банкнотной сделки              Да
   var Points              : Double;   // Курсовая разница                       Нет
   var Details             : String;   // Детали                                 Нет
   
   var PrecMetal           ;           // Описание металла                       Нет
   var Payments            ;           // Платежи                                Да
   var Fixing              ;
      
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var err_txt;
      private var aux_buff;
      private var nametag_up = "CurrencyDeal";

      PairsName         = getValueFromProperty(IncomeData, "PairsName"        , nametag_up);
      CurrencyDeals     = getValueFromProperty(IncomeData, "CurrencyDeals"    , nametag_up, true);
      Rate              = getValueFromProperty(IncomeData, "Rate"             , nametag_up, true);
      RateDirection     = getValueFromProperty(IncomeData, "RateDirection"    , nametag_up);
      RateQutationUnit  = getValueFromProperty(IncomeData, "RateQutationUnit" , nametag_up);
      MarginSpot        = getValueFromProperty(IncomeData, "MarginSpot"       , nametag_up);
      PreCon            = getValueFromProperty(IncomeData, "PreCon"           , nametag_up);
      IsNostro          = getValueFromProperty(IncomeData, "IsNostro"         , nametag_up, true);
      IsDerivative      = getValueFromProperty(IncomeData, "IsDerivative"     , nametag_up, true);
      Bnote             = getValueFromProperty(IncomeData, "Bnote"            , nametag_up, true);
      Points            = getValueFromProperty(IncomeData, "Points"           , nametag_up);
      Details           = getValueFromProperty(IncomeData, "Details"          , nametag_up);

      // проверка по списку значений
      if (ValType(RateDirection) != V_UNDEF)
         if ( (StrUpr(RateDirection) == "D") or (StrUpr(RateDirection) == "I") )
         else
            err_txt = string("Недопустимое значение ", nametag_up, ".RateDirection = ",RateDirection);
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
         end;
      end;
      
      // контейнеры
      aux_buff = getValueFromProperty(IncomeData, "PrecMetal", nametag_up);
      if(ValType(aux_buff) != V_UNDEF)
         PrecMetal = adp_PrecMetal(aux_buff, nametag_up);
      end;
      
      aux_buff = getValueFromProperty(IncomeData, "Payments", nametag_up, true);
      if(ValType(aux_buff) != V_UNDEF)
         Payments = c_Payment(aux_buff, nametag_up);
      end;
      
      aux_buff  = getValueFromProperty(IncomeData, "Fixing", nametag_up);
      if(ValType(aux_buff) != V_UNDEF)
         Fixing = adp_Fixing(aux_buff, nametag_up);
      end;

   end; /* macro uInitPrime() */

   uInitPrime(IncomeData);
   
end;

// ФОРВАРД
private class c_CurrencyFWDDeal(IncomeData)
   var PairsName        : string;   // Код валютной пары                   Да
   var CurrencyDeals    : string;   // Код валюты сделки                   Нет
   var IsNostro         : bool;     //
   var PrecMetal        ;           // Описание металла                    Нет
   var Rate             : Double;   // Курс сделки                         Да
   var RateDirection    : String;   // Направление курса	                  Нет   "D - прямой I - обратный"
   var RateQutationUnit : Integer;  // Масштаб курса (количество единиц)   Нет
   var Netting          : bool;     //   
   var DateTerm         : Date;     // Дата термирования                   Нет
   var PayCurrency      : String;   // Валюта расчетов                     Да
   var PayRate          : Double;   // Курс расчетов                       Да
   var PayType          : String;   // Способ исполнения                   Да    "Расчетный Поставочный"
   var IsDerivative     : bool;     // Признак Производного инструмента    Да
   var Payments         ;           // Платежи                             Да
   var Fixing           ;           // Фиксинг                             Нет
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var err_txt;
      private var aux_buff;
      private var nametag_up = "CurrencyFWDDeal";
   
      PairsName         = getValueFromProperty(IncomeData, "PairsName"        , nametag_up, true);
      CurrencyDeals     = getValueFromProperty(IncomeData, "CurrencyDeals"    , nametag_up);
      IsNostro          = getValueFromProperty(IncomeData, "IsNostro"         , nametag_up);
      Rate              = getValueFromProperty(IncomeData, "Rate"             , nametag_up, true);
      RateDirection     = getValueFromProperty(IncomeData, "RateDirection"    , nametag_up);
      RateQutationUnit  = getValueFromProperty(IncomeData, "RateQutationUnit" , nametag_up);
      Netting           = getValueFromProperty(IncomeData, "Netting"          , nametag_up);
      DateTerm          = getValueFromProperty(IncomeData, "DateTerm"         , nametag_up);
      PayCurrency       = getValueFromProperty(IncomeData, "PayCurrency"      , nametag_up, true);
      PayRate           = getValueFromProperty(IncomeData, "PayRate"          , nametag_up, true);
      PayType           = getValueFromProperty(IncomeData, "PayType"          , nametag_up, true);
      IsDerivative      = getValueFromProperty(IncomeData, "IsDerivative"     , nametag_up, true);
      
      // проверка по списку значений
      if (ValType(RateDirection) != V_UNDEF)
         if ( (StrUpr(RateDirection) == "D") or (StrUpr(RateDirection) == "I") )
         else
            err_txt = string("Недопустимое значение ", nametag_up, ".RateDirection = ",RateDirection);
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
         end;
      end;
      if(ValType(PayType) != V_UNDEF)
         if ( (StrUpr(PayType) == StrUpr("Расчетный")) or (StrUpr(PayType) == StrUpr("Поставочный")) )
         else
            err_txt = string("Недопустимое значение ", nametag_up, ".PayType = ",PayType);
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
         end;
      end;
      
      // контейнеры
      aux_buff  = getValueFromProperty(IncomeData, "PrecMetal", nametag_up);
      if(ValType(aux_buff) != V_UNDEF)
         PrecMetal = adp_PrecMetal(aux_buff, nametag_up);
      end;
      
      aux_buff  = getValueFromProperty(IncomeData, "Payments", nametag_up, true);
      if(ValType(aux_buff) != V_UNDEF)
         Payments = c_Payment(aux_buff, nametag_up);
      end;
      
      aux_buff  = getValueFromProperty(IncomeData, "Fixing", nametag_up);
      if(ValType(aux_buff) != V_UNDEF)
         Fixing = adp_Fixing(aux_buff, nametag_up);
      end;

   end; /* macro uInitPrime() */

   uInitPrime(IncomeData);
   
end;

// SWAP
private class c_CurrencySWAPDeal(IncomeData)
   var PairsName        : string;      // Код валютной пары                   Да
   var CurrencyDeals    : string;      // Код валюты сделки                   Нет
   var IsNostro         : bool;        //                                     Да
   var IsDerivative     : bool;        // Признак Производного инструмента    Нет
   var LegsDealsList    ;              // Нога сделки                         Да

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var err_txt;
      private var aux_buff;
      private var nametag_up = "CurrencySWAPDeal";

      PairsName      = getValueFromProperty(IncomeData, "PairsName"     , nametag_up, true);
      CurrencyDeals  = getValueFromProperty(IncomeData, "CurrencyDeals" , nametag_up);
      IsNostro       = getValueFromProperty(IncomeData, "IsNostro"      , nametag_up, true);
      IsDerivative   = getValueFromProperty(IncomeData, "IsDerivative"  , nametag_up);
            
      aux_buff = getValueFromProperty(IncomeData, "LegsDealsList", nametag_up, true);
      if(ValType(aux_buff) == V_GENOBJ)
         LegsDealsList = TArray;
         aux_buff = 0;
         while(IncomeData.LegsDealsList.size > aux_buff)
            LegsDealsList.value(LegsDealsList.size) = adp_LegsDeal(IncomeData.LegsDealsList.value(aux_buff), nametag_up);
            aux_buff = aux_buff + 1;
         end;
      else
         err_txt = string(InErrNotObj, nametag_up, ".LegsDealsList");
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
      end;
   
   end; /* macro uInitPrime() */

   uInitPrime(IncomeData);
end;

// ОПЦИОН
private class c_CurrencyOptionDeal(IncomeData)
   var PairsName           : String;   // Код валютной пары                   Да
   var ExecMetod           : String;   // Способ исполнения                   Да
   var OptionType          : String;   // Тип опциона                         Да
   var ExerciseType        : String;   // Стиль опциона                       Да
   var OptionView          : String;   // Вид опциона                         Да
   var ValuationType       : String;   // Дополнительные условия контракта    Да
   var BaseCurr            : String;   // Код базовой валюты/ДМ               Да
   var BaseAmount          : double;   // Сумма в базовой валюте              Да
   var CounterCurr         : String;   // Код контрвалюты/ДМ                  Да
   var CounterAmount       : double;   // Сумма в контрвалюте                 Да
   var PrecMetal           ;           // Описание металла                    Нет
   var PayCurr             : String;   // Валюта расчетов (платежа)           Да
   var PayRate             : double;   // Курс расчета по валюте платежа      Нет
   var PayAmount           : double;   // Сумма платежа                       Да
   var SpotRate            : double;   // Спот курс (цена исполнения)         Нет
   var IsDerivative        : bool;     // Признак Производного инструмента    Нет
   var BonusCurr           : String;   // Валюта премии                       Да
   var BonusAmount         : double;   // Сумма премии                        Да
   var BonusDate           : date;     // Дата уплаты премии                  Да
   var DateBegin           : date;     // Период начала сделки                Да
   var MaturityPeriodDate  : String;   // Период уведомления                  Да
   var RateType            : integer;  // Вариант задания курса               Да
   var RateDate            : date;     // Значение курса на дату              Нет
   var RatePay             : integer;  // Количество дней от оплаты           Нет
   var RateDevKind         : integer;  // Тип отклонения курса                Нет   "1 = в процентах    2 = в сумме"
   var Fixing              ;           // Фиксинг                             Нет
   var BarrierPrice        ;           // Барьер цены                         Нет
   var TermPayDate         : date;     // Дата термирования                   Нет
   var TermPayOffset       : integer;  // Количество дней смещения            Нет
   var TaxDeal             : double;   // Сумма налога по сделке              Нет
   var AgreementNum        : String;   // Номер договора по сделке            Нет
   var AgreementDate       : date;     // Дата договора по сделке             Нет
   var IsMatutity          : bool;     // Признак экспирации                  Да
   var Matutity            ;           // Экспирация (исполнение) сделки      Нет


   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var err_txt;
      private var aux_buff;
      private var nametag_up = "CurrencyOptionDeal";

      PairsName            = getValueFromProperty(IncomeData, "PairsName"           , nametag_up, true);
      ExecMetod            = getValueFromProperty(IncomeData, "ExecMetod"           , nametag_up, true);
      OptionType           = getValueFromProperty(IncomeData, "OptionType"          , nametag_up, true);
      ExerciseType         = getValueFromProperty(IncomeData, "ExerciseType"        , nametag_up, true);
      OptionView           = getValueFromProperty(IncomeData, "OptionView"          , nametag_up, true);
      ValuationType        = getValueFromProperty(IncomeData, "ValuationType"       , nametag_up, true);
      BaseCurr             = getValueFromProperty(IncomeData, "BaseCurr"            , nametag_up, true);
      BaseAmount           = getValueFromProperty(IncomeData, "BaseAmount"          , nametag_up, true);
      CounterCurr          = getValueFromProperty(IncomeData, "CounterCurr"         , nametag_up, true);
      CounterAmount        = getValueFromProperty(IncomeData, "CounterAmount"       , nametag_up, true);
      PayCurr              = getValueFromProperty(IncomeData, "PayCurr"             , nametag_up, true);
      PayRate              = getValueFromProperty(IncomeData, "PayRate"             , nametag_up);
      PayAmount            = getValueFromProperty(IncomeData, "PayAmount"           , nametag_up, true);
      SpotRate             = getValueFromProperty(IncomeData, "SpotRate"            , nametag_up);
      IsDerivative         = getValueFromProperty(IncomeData, "IsDerivative"        , nametag_up);
      BonusCurr            = getValueFromProperty(IncomeData, "BonusCurr"           , nametag_up, true);
      BonusAmount          = getValueFromProperty(IncomeData, "BonusAmount"         , nametag_up, true);
      BonusDate            = getValueFromProperty(IncomeData, "BonusDate"           , nametag_up, true);
      DateBegin            = getValueFromProperty(IncomeData, "DateBegin"           , nametag_up, true);
      MaturityPeriodDate   = getValueFromProperty(IncomeData, "MaturityPeriodDate"  , nametag_up, true);
      RateType             = getValueFromProperty(IncomeData, "RateType"            , nametag_up, true);
      RateDate             = getValueFromProperty(IncomeData, "RateDate"            , nametag_up);
      RatePay              = getValueFromProperty(IncomeData, "RatePay"             , nametag_up);
      TermPayDate          = getValueFromProperty(IncomeData, "TermPayDate"         , nametag_up);
      TermPayOffset        = getValueFromProperty(IncomeData, "TermPayOffset"       , nametag_up);
      TaxDeal              = getValueFromProperty(IncomeData, "TaxDeal"             , nametag_up);
      AgreementNum         = getValueFromProperty(IncomeData, "AgreementNum"        , nametag_up);
      AgreementDate        = getValueFromProperty(IncomeData, "AgreementDate"       , nametag_up);
      IsMatutity           = getValueFromProperty(IncomeData, "IsMatutity"          , nametag_up, true);
     
      // проверка по списку значений
      if (ValType(RateDevKind) != V_UNDEF)
         if ( (RateDevKind == 1) or (RateDevKind == 2) )
         else
            err_txt = string("Недопустимое значение ", nametag_up, ".RateDevKind = ",RateDevKind);
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
         end;
      end;

      // контейнеры
      aux_buff  = getValueFromProperty(IncomeData, "PrecMetal", nametag_up);
      if(ValType(aux_buff) != V_UNDEF)
         PrecMetal = adp_PrecMetal(aux_buff, nametag_up);
      end;
      
      aux_buff  = getValueFromProperty(IncomeData, "Fixing", nametag_up);
      if(ValType(aux_buff) != V_UNDEF)
         Fixing = adp_Fixing(aux_buff, nametag_up);
      end;
      
      aux_buff  = getValueFromProperty(IncomeData, "BarrierPrice", nametag_up);
      if(ValType(aux_buff) != V_UNDEF)
         BarrierPrice = adp_BarrierPrice(aux_buff, nametag_up);
      end;
      
      aux_buff  = getValueFromProperty(IncomeData, "Matutity", nametag_up);
      if(ValType(aux_buff) != V_UNDEF)
         Matutity = adp_Matutity(aux_buff, nametag_up);
      end;
   
   end; /* macro uInitPrime() */

   uInitPrime(IncomeData);   
   
end;

// Процентный ФОРВАРД
private class c_FRADeal(IncomeData)
   var IsDerivative        : bool;     // Признак Производного инструмента       Да
   var IsNostro            : bool;     // 
   var ValueDate           : date;     // Дата валютирования                     Да
   var MaturityDate        : date;     // Дата расчетов                          Нет
   var FixDate             : date;     // Дата фиксинга                          Нет
   var CurrencyDeals       : string;   // Код валюты сделки                      Да
   var Amount              : double;   // Сумма сделки                           Да
   var ContractRate        : double;   // % ставка по сделке                     Нет
   var RateFloatKind       : string;   // Тип плавающей % ставки                 Нет
   var RateFloatShortName  : string;   // Краткое наименование плавающей ставки  Нет
   var RateFloatFullName   : string;   // Полное наименование плавающей ставки   Нет
   var IsMatutity          : bool;     // Признак экспирации                     Да
   var Matutity            ;
   var Fixing              ;
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var nametag_up = "FRADeal";
      private var aux_buff;

      IsDerivative         = getValueFromProperty(IncomeData, "IsDerivative"        , nametag_up, true);
      IsNostro             = getValueFromProperty(IncomeData, "IsNostro"            , nametag_up);
      ValueDate            = getValueFromProperty(IncomeData, "ValueDate"           , nametag_up, true);
      MaturityDate         = getValueFromProperty(IncomeData, "MaturityDate"        , nametag_up);
      FixDate              = getValueFromProperty(IncomeData, "FixDate"             , nametag_up);
      CurrencyDeals        = getValueFromProperty(IncomeData, "CurrencyDeals"       , nametag_up, true);
      Amount               = getValueFromProperty(IncomeData, "Amount"              , nametag_up, true);
      ContractRate         = getValueFromProperty(IncomeData, "ContractRate"        , nametag_up);
      RateFloatKind        = getValueFromProperty(IncomeData, "RateFloatKind"       , nametag_up);
      RateFloatShortName   = getValueFromProperty(IncomeData, "RateFloatShortName"  , nametag_up);
      RateFloatFullName    = getValueFromProperty(IncomeData, "RateFloatFullName"   , nametag_up);
      IsMatutity           = getValueFromProperty(IncomeData, "IsMatutity"          , nametag_up, true);
      
      aux_buff  = getValueFromProperty(IncomeData, "Matutity", nametag_up);
      if(ValType(aux_buff) != V_UNDEF)
         Matutity = adp_Matutity(aux_buff, nametag_up);
      end;
      
      aux_buff  = getValueFromProperty(IncomeData, "Fixing", nametag_up);
      if(ValType(aux_buff) != V_UNDEF)
         Fixing = adp_Fixing(aux_buff, nametag_up);
      end;
   end; /* macro uInitPrime() */

   uInitPrime(IncomeData);
   
end;

// IRS/CIRS
private class c_IRSSWAPDeal(IncomeData)
   var IsDerivative        : integer;  // Признак Производного инструмента                Да
   var DateBegin           : date;     // Дата начала сделки                              Да
   var DateMatunity        : date;     // Дата завершения сделки                          Нет
   var DateTerm            : date;     // Дата термирования                               Нет
   var TermType            : string;   // Тип термирования                                Нет      "L = досрочное закрытие сделки A = перевод на другого контрагента "
   var DealRelation        : string;   // Номер связанной сделки                          Нет
   var TermPrematureType   : string;   // Вид досрочного закрытия                         Нет      "P = частичное T = полное"
   var TermAmount          : double;   // Сумма досрочного погашения                      Нет
   var TermDatePay         : date;     // Дата расчетов по сделке (выполнения платежа)    Нет
   var TermDatePers        : date;     // Дата расчета процентов                          Нет
   var TermClFee           : double;   // Сумма выплачиваемых процентов                   Нет
   var TermAccrued         : integer;  // Начисленных процентов                           Нет
   var PartList            ;           // Части сделки                                    Да
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var nametag_up = "IRSSWAPDeal";
      private var aux_buff;
      private var err_txt;

      IsDerivative      = getValueFromProperty(IncomeData, "IsDerivative"        , nametag_up, true);
      DateBegin         = getValueFromProperty(IncomeData, "DateBegin"           , nametag_up, true);
      DateMatunity      = getValueFromProperty(IncomeData, "DateMatunity"        , nametag_up);
      DateTerm          = getValueFromProperty(IncomeData, "DateTerm"            , nametag_up);
      TermType          = getValueFromProperty(IncomeData, "TermType"            , nametag_up);
      DealRelation      = getValueFromProperty(IncomeData, "DealRelation"        , nametag_up);
      TermPrematureType = getValueFromProperty(IncomeData, "TermPrematureType"   , nametag_up);
      TermAmount        = getValueFromProperty(IncomeData, "TermAmount"          , nametag_up);
      TermDatePay       = getValueFromProperty(IncomeData, "TermDatePay"         , nametag_up);
      TermDatePers      = getValueFromProperty(IncomeData, "TermDatePers"        , nametag_up);
      TermClFee         = getValueFromProperty(IncomeData, "TermClFee"           , nametag_up);
      TermAccrued       = getValueFromProperty(IncomeData, "TermAccrued"         , nametag_up);
      
      // проверка по списку значений
      if(ValType(TermType) != V_UNDEF)
         if ( (StrUpr(TermType) == "L") or (StrUpr(TermType) == "A") )
         else
            err_txt = string("Недопустимое значение ", nametag_up ,".TermType = ",TermType);
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
         end;
      end;
      if(ValType(TermPrematureType) != V_UNDEF)
         if ( (StrUpr(TermPrematureType) == "P") or (StrUpr(TermPrematureType) == "T") )
         else
            err_txt = string("Недопустимое значение ", nametag_up ,".TermPrematureType = ",TermPrematureType);
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
         end;
      end;
      
      aux_buff = getValueFromProperty(IncomeData, "PartList", nametag_up, true); 
      if(ValType(aux_buff) == V_GENOBJ)
         PartList = TArray;
         aux_buff = 0;
         while(IncomeData.PartList.size > aux_buff)
            PartList.value(PartList.size) = c_PartList_IRS(IncomeData.PartList.value(aux_buff), nametag_up);
            aux_buff = aux_buff + 1;
         end;
      else
         err_txt = string(InErrNotObj, nametag_up, ".PartList");
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
      end;

   end; /* macro uInitPrime() */

   uInitPrime(IncomeData);
   
end;

// РЕПО (ЦБ)
private class c_REPODeal(IncomeData)
   var CouponTo      : string;   // Кому переходит купон                   Нет
   var CurrencyDeals : string;   // Код валюты сделки                      Нет
   var HairCutType   : string;   // Тип дисконта по РЕПО                   Да
   var HairCut       : double;   // Сумма дисконта по РЕПО                 Нет
   var HairCutPRC    : double;   // % дисконта РЕПО                        Нет
   var Number        : integer;  // Количество ЦБ                          Да
   var SettlType     : string;   // Способ расчетов по сделке              Да
   var Treshold      : double;   // % триггера по сделке                   Нет
   var RepoPeriod    : string;   // Период по сделке                       Да
   var RepoRate      : double;   // % по сделке                            Да
   var RepoYear      : string;   // Количество дней в году для расчета %   Да

   var Securities    ;           // Ценная бумага                          Нет
   var PartDealsList ;           // Части сделки                           Да

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var aux_buff;
      private var nametag_up = "REPODeal";
      
      if(ValType(IncomeData) != V_UNDEF)
         CouponTo       = getValueFromProperty(IncomeData, "CouponTo"      , nametag_up); 
         CurrencyDeals  = getValueFromProperty(IncomeData, "CurrencyDeals" , nametag_up);
         HairCutType    = getValueFromProperty(IncomeData, "YeldPrc"       , nametag_up, true);
         HairCut        = getValueFromProperty(IncomeData, "HairCut"       , nametag_up);
         HairCutPRC     = getValueFromProperty(IncomeData, "HairCutPRC"    , nametag_up);
         Number         = getValueFromProperty(IncomeData, "Number"        , nametag_up, true);
         SettlType      = getValueFromProperty(IncomeData, "SettlType"     , nametag_up, true);
         Treshold       = getValueFromProperty(IncomeData, "Treshold"      , nametag_up); 
         RepoPeriod     = getValueFromProperty(IncomeData, "RepoPeriod"    , nametag_up, true);
         RepoRate       = getValueFromProperty(IncomeData, "RepoRate"      , nametag_up, true);
         RepoYear       = getValueFromProperty(IncomeData, "RepoYear"      , nametag_up, true);

         aux_buff = getValueFromProperty(IncomeData, "Securities", nametag_up); 
         if(ValType(aux_buff) != V_UNDEF)
            Securities = adp_Securities(aux_buff, nametag_up);
         end;
         
         aux_buff = getValueFromProperty(IncomeData, "PartDealsList", nametag_up, true); 
         if(ValType(aux_buff) == V_GENOBJ)
            PartDealsList = TArray;
            aux_buff = 0;
            while(IncomeData.PartDealsList.size > aux_buff)
               PartDealsList.value(PartDealsList.size) = adp_PartDeal(IncomeData.PartDealsList.value(aux_buff), nametag_up);
               aux_buff = aux_buff + 1;
            end;
         end;
      end;
         
   end; /* macro uInitPrime() */

   uInitPrime(IncomeData);
   
end;

// Покупка/продажа ЦБ
private class c_EquityDeal(IncomeData)
   var CouponTo      : string;   // Кому переходит купон       Нет
   var CurrencyDeals : string;   // Код валюты сделки          Нет
   var Number        : integer;  // Количество ЦБ              Да
   var SettlType     : string;   // Способ расчетов по сделке  Да
   var Securities    ;           // Ценная бумага              Нет
   var Equity        ;           // Описание сделки с ЦБ       Да
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var aux_buff;
      private var nametag_up = "EquityDeal";
      
      if(ValType(IncomeData) != V_UNDEF)
         CouponTo       = getValueFromProperty(IncomeData, "CouponTo"      , nametag_up); 
         CurrencyDeals  = getValueFromProperty(IncomeData, "CurrencyDeals" , nametag_up);
         Number         = getValueFromProperty(IncomeData, "Number"        , nametag_up, true);
         SettlType      = getValueFromProperty(IncomeData, "SettlType"     , nametag_up, true);

         aux_buff = getValueFromProperty(IncomeData, "Securities", nametag_up); 
         if(ValType(aux_buff) != V_UNDEF)
            Securities = adp_Securities(aux_buff, nametag_up);
         end;
         
         aux_buff   = getValueFromProperty(IncomeData, "Equity", nametag_up, true);
         if (ValType(aux_buff) != V_UNDEF)
            Equity = adp_Equity(aux_buff, nametag_up);
         end;

      end;
         
   end; /* macro uInitPrime() */

   uInitPrime(IncomeData);
end;

// BOND
private class c_BondDeal(IncomeData)
   var CurrencyDeals    : string;   // Код валюты сделки                Нет
   var IsNostro         : bool;     
   var Number           : integer;  // Количество ЦБ                    Да
   var Amount           : double;   // Сумма сделки                     Да
   var Depositary       : string;   // Депозитарий                      Нет
   var NominalType      : string;   // Тип номинала                     Да       "текущий исходный"
   var PriceNominal     : double;   // Номинальная стоимость            Да
   var PricePrc         : double;   // Цена в % относительно номинала   Нет
   var YeldPrc          : double;   // Доходность в %                   Нет
   var CouponAmount     : double;   // Сумма по купону                  Нет
   var CouponPrc        : double;   // % по купону                      Нет
   var ValueDate        : date;     // Дата валютирования               Да
   var PayDate          : date;     // Дата платежа                     Да
   var DelivDate        : date;     // Дата поставки                    Да
   var MarginPrc        : double;   // Маржа в %                        Нет
   var Purposes         : string;   // Назначение                       Нет
   var Securities       ;           // Ценная бумага                    Нет

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var err_txt;
      private var aux_buff;
      var nametag_up = "BondDeal";
      
      if(ValType(IncomeData) != V_UNDEF)
         CurrencyDeals     = getValueFromProperty(IncomeData, "CurrencyDeals" , nametag_up);
         IsNostro          = getValueFromProperty(IncomeData, "IsNostro"      , nametag_up);
         Number            = getValueFromProperty(IncomeData, "Number"        , nametag_up, true);
         Amount            = getValueFromProperty(IncomeData, "Amount"        , nametag_up, true);
         Depositary        = getValueFromProperty(IncomeData, "Depositary"    , nametag_up);
         NominalType       = getValueFromProperty(IncomeData, "NominalType"   , nametag_up, true); 
         PriceNominal      = getValueFromProperty(IncomeData, "PriceNominal"  , nametag_up, true); 
         PricePrc          = getValueFromProperty(IncomeData, "PricePrc"      , nametag_up);
         YeldPrc           = getValueFromProperty(IncomeData, "YeldPrc"       , nametag_up);
         CouponAmount      = getValueFromProperty(IncomeData, "CouponAmount"  , nametag_up);
         CouponPrc         = getValueFromProperty(IncomeData, "CouponPrc"     , nametag_up);
         ValueDate         = getValueFromProperty(IncomeData, "ValueDate"     , nametag_up, true); 
         PayDate           = getValueFromProperty(IncomeData, "PayDate"       , nametag_up, true); 
         DelivDate         = getValueFromProperty(IncomeData, "DelivDate"     , nametag_up, true); 
         MarginPrc         = getValueFromProperty(IncomeData, "MarginPrc"     , nametag_up); 
         Purposes          = getValueFromProperty(IncomeData, "Purposes"      , nametag_up); 

         // проверка по списку значений
         if (ValType(NominalType) != V_UNDEF)
            if ( (StrUpr(NominalType) == StrUpr("текущий")) or (StrUpr(NominalType) == StrUpr("исходный")) )
            else
               err_txt = string("Недопустимое значение ", nametag_up, ".NominalType = ",NominalType);
               RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
            end;
         end;
         
         // контейнер
         aux_buff = getValueFromProperty(IncomeData, "Securities", nametag_up); 
         if(ValType(aux_buff) != V_UNDEF)
            Securities = adp_Securities(aux_buff, nametag_up);
         end;
      end;
      
   end; /* macro uInitPrime() */

   uInitPrime(IncomeData);
   
end;


// содержание сделки
private class c_DealData(IncomeData)
   private var err_txt;
   private var aux_buff;
   
   var CurrencyDeal = NULL;
   var CurrencyFWDDeal = NULL;
   var CurrencySWAPDeal = NULL;
   var CurrencyOptionDeal = NULL;
   var FRADeal = NULL;
   var IRSSWAPDeal = NULL;
   var IAMLDDeal = NULL;
   var REPODeal = NULL;
   var EquityDeal = NULL;
   var BondDeal = NULL;
   
   aux_buff = uTryToGetPropS(IncomeData, "CurrencyDeal");
   if (ValType(aux_buff) != V_UNDEF)
      CurrencyDeal = c_CurrencyDeal(aux_buff);
   end;

   aux_buff = uTryToGetPropS(IncomeData, "CurrencyFWDDeal");
   if (ValType(aux_buff) != V_UNDEF)
      CurrencyFWDDeal = c_CurrencyFWDDeal(aux_buff);
   end;

   aux_buff = uTryToGetPropS(IncomeData, "CurrencySWAPDeal");
   if (ValType(aux_buff) != V_UNDEF)
      CurrencySWAPDeal = c_CurrencySWAPDeal(aux_buff);
   end;  
   
   aux_buff = uTryToGetPropS(IncomeData, "CurrencyOptionDeal");
   if (ValType(aux_buff) != V_UNDEF)
      CurrencyOptionDeal = c_CurrencyOptionDeal(aux_buff);
   end;   
   
   aux_buff = uTryToGetPropS(IncomeData, "FRADeal");
   if (ValType(aux_buff) != V_UNDEF)
      FRADeal = c_FRADeal(aux_buff);
   end;  
   
   aux_buff = uTryToGetPropS(IncomeData, "IRSSWAPDeal");
   if (ValType(aux_buff) != V_UNDEF)
      IRSSWAPDeal = c_IRSSWAPDeal(aux_buff);
   end;   

   aux_buff = uTryToGetPropS(IncomeData, "IAMLDDeal");
   if (ValType(aux_buff) != V_UNDEF)
      IAMLDDeal = c_IAMLDDeal(aux_buff);
   end;

   aux_buff = uTryToGetPropS(IncomeData, "REPODeal");
   if (ValType(aux_buff) != V_UNDEF)
      REPODeal = c_REPODeal(aux_buff);
   end;
   
   aux_buff = uTryToGetPropS(IncomeData, "EquityDeal");
   if (ValType(aux_buff) != V_UNDEF)
      EquityDeal = c_EquityDeal(aux_buff);
   end;
   
   aux_buff = uTryToGetPropS(IncomeData, "BondDeal");
   if (ValType(aux_buff) != V_UNDEF)
      BondDeal = c_BondDeal(aux_buff);
   end;

end;

// комиссии
private class c_Comiss(IncomeData)
   var Type          : String;   // Тип комиссии                     Да    Справочник
   var PartNum       : Integer;  // К какой части сделки относится   Нет
   var Amount        : Double;   // Сумма комиссии общая             Да
   var Summa         : Double;   // Сумма комиссии без НДС           Нет
   var SummaNDS      : Double;   // Сумма НДС по комиссии            Нет
   var Currency      : String;   // Код валюты комиссии              Да    Справочник
   var PayerWhoIs    : String;   // Кто плательщик комиссии          Нет   Справочник
   var Payer         : String;   // Идентификатор Плательщика        Нет   Справочник
   var Recipient     : String;   // Идентификатор Получателя         Нет   Справочник
   var DateCalc      : date;     // Дата расчета                     Нет
   var IsPaid        : Integer;  // Признак оплаты комиссии          Нет
   var DatePayPlan   : date;     // Дата оплаты комиссии (план)      Нет
   var DatePayFact   : date;     // Дата оплаты комиссии (факт)      Нет
   var CommissionMethod : string;
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)   
      private var nametag_up = "ComissArray.Comiss";
      
      if(ValType(IncomeData) != V_UNDEF)
         Type        = getValueFromProperty(IncomeData, "Type"       , nametag_up, true);
         PartNum     = getValueFromProperty(IncomeData, "PartNum"    , nametag_up);
         Amount      = getValueFromProperty(IncomeData, "Amount"     , nametag_up, true);
         Summa       = getValueFromProperty(IncomeData, "Summa"      , nametag_up);
         SummaNDS    = getValueFromProperty(IncomeData, "SummaNDS"   , nametag_up);
         Currency    = getValueFromProperty(IncomeData, "Currency"   , nametag_up, true);
         PayerWhoIs  = getValueFromProperty(IncomeData, "PayerWhoIs" , nametag_up);
         Payer       = getValueFromProperty(IncomeData, "Payer"      , nametag_up);
         Recipient   = getValueFromProperty(IncomeData, "Recipient"  , nametag_up);
         DateCalc    = getValueFromProperty(IncomeData, "DateCalc"   , nametag_up);
         IsPaid      = getValueFromProperty(IncomeData, "IsPaid"     , nametag_up);
         DatePayPlan = getValueFromProperty(IncomeData, "DatePayPlan", nametag_up);
         DatePayFact = getValueFromProperty(IncomeData, "DatePayFact", nametag_up);
         CommissionMethod = getValueFromProperty(IncomeData, "CommissionMethod", nametag_up);
      end;
   end;

   uInitPrime(IncomeData);   
end;

private class c_PartyUId(Incomedata)
   var SystemId      : String;   // Код АС               Да    Справочник
   var SystemNodeId  : String;   // Код экземпляра АС    Да    Справочник
   var ObjectId      : String;   // Код субъекта в АС    Да    Идентификатор
end;

// Участники Сделки
private class c_PartyDeal(IncomeData)
   var PartyKind        : String;   // Тип участника                          Да    Справочник
   var PartyIDKind      : String;   // Тип кода (идентификатора)              Нет   Справочник
   var PartyUID         ;           // Идентификатор участника (код) в АБС    Нет   Идентификатор
   var PartyCode        : String;   // Дилинг коды                            Нет   Через запятую
   var PartyFullName    : String;   // Полное имя                             Да
   var PartyShortName   : String;   // Краткое имя                            Нет
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)   
      private var err_txt;
      private var aux_buff;
      private var nametag_up = "PartyDealList.PartyDeal";
      
      if(ValType(IncomeData) != V_UNDEF)
         PartyKind      = getValueFromProperty(IncomeData, "PartyKind"     , nametag_up, true);
         PartyIDKind    = getValueFromProperty(IncomeData, "PartyIDKind"   , nametag_up);
         PartyCode      = getValueFromProperty(IncomeData, "PartyCode"     , nametag_up);
         PartyFullName  = getValueFromProperty(IncomeData, "PartyFullName" , nametag_up, true);
         PartyShortName = getValueFromProperty(IncomeData, "PartyShortName", nametag_up);
        
         aux_buff = getValueFromProperty(IncomeData, "PartyUID", nametag_up);
         if(ValType(aux_buff) == V_GENOBJ)
            PartyUID = c_PartyUId;
            PartyUID.SystemId       = getValueFromProperty(aux_buff, "SystemId"      , nametag_up, true);
            PartyUID.SystemNodeId   = getValueFromProperty(aux_buff, "SystemNodeId"  , nametag_up, true);
            PartyUID.ObjectId       = getValueFromProperty(aux_buff, "ObjectId"      , nametag_up, true);
         else
            err_txt = string(InErrNotObj, "PartyDealList.PartyUID");
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
         end;
      end;
   end;

   uInitPrime(IncomeData);
end;

// Использование лимитов
private class c_Limits(IncomeData)
   var Type    : String;   // Тип лимита           Да    Справочник
   var Name    : String;   // Наименование лимита  Да    Справочник
   var Status  : String;   // Статус               Да    Справочник
   var Value   : Double;   // Величина лимита      Да
   var Rest    : Double;   // Остаток лимита       Да

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var nametag_up = "LimitsList.Limits";
      
      if(ValType(IncomeData) != V_UNDEF)
         Type     = getValueFromProperty(IncomeData, "Type"    , nametag_up, true);
         Name     = getValueFromProperty(IncomeData, "Name"    , nametag_up, true);
         Status   = getValueFromProperty(IncomeData, "Status"  , nametag_up, true);
         Value    = getValueFromProperty(IncomeData, "Value"   , nametag_up, true);
         Rest     = getValueFromProperty(IncomeData, "Rest"    , nametag_up, true);
      end;
   end;

   uInitPrime(IncomeData);
end;

// Платежные инструкции
private class c_PayInstr(IncomeData)
// в дальнейшем - не обрабатываются, так что все параметры не обязательные
   var LegsNumber    : integer;  // Номер ноги                 Нет
   var PayInstrKind  : String;   // Код вида инструкции        Да    Справочник
   var PayInstr      : String;   // Платежная инструкция       Да
   var PayComment    : String;   // Платежный комментарий      Да
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var err_txt;
      private var nametag_up = "PayInstrList.PayInstr";
      
      if(ValType(IncomeData) != V_UNDEF)
         LegsNumber     = getValueFromProperty(IncomeData, "LegsNumber"    , nametag_up);
         PayInstrKind   = getValueFromProperty(IncomeData, "PayInstrKind"  , nametag_up);
         PayInstr       = getValueFromProperty(IncomeData, "PayInstr"      , nametag_up);
         PayComment     = getValueFromProperty(IncomeData, "PayComment"    , nametag_up);
      end;
   end;

   uInitPrime(IncomeData);   
end;

// Связанная сделка (родительская)
private class c_PrevDeal(IncomeData)
   var ExternalID :string;    // Идентификатор сделки в исходной (внешней) системе     Да
   var TSBrief    :string;    // Код торговой площадки/торговой системы                Да
   var DealID     :string;    // Уникальный идентификатор сделки в АСУДР               Да

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var err_txt;
      private var nametag_up = "PrevDeal";
      
      if(ValType(IncomeData) != V_UNDEF)
         ExternalID  = getValueFromProperty(IncomeData, "ExternalID" , nametag_up, true);
         TSBrief     = getValueFromProperty(IncomeData, "TSBrief"    , nametag_up, true);
         DealID      = getValueFromProperty(IncomeData, "DealID"     , nametag_up, true);
      end;
   end;

   uInitPrime(IncomeData);   
end;

// класс входящих параметров 
private class c_ProcessDealsRequest(p_req_data_obj)
   var IdentityDeal  : c_IdentityDeal;    // Идентификация сделки    Контейнер               Да
   var DealData      : c_DealData;        // Содержание сделки       Строка (Контейнер)      Да
   var ComissArray   : TArray;            // Список комиссий         Контейнер               Нет
   var PartyDealList : TArray;            // Участники Сделки        Контейнер               Да
   var LimitsList    : TArray;            // Использование лимитов   Контейнер               Нет
   var PayInstrList  : TArray;            // Платежные инструкции    Контейнер               Нет
   var PrevDeal      ;
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(p_req_data_obj)
      private var err_txt;
      private var aux_buff;

      // проверка производится на этапе проверки XML, оставлено для контроля
      if(ValType(p_req_data_obj) != V_UNDEF)
         aux_buff = uTryToGetPropS(p_req_data_obj, "IdentityDeal");
         if (ValType(aux_buff) == V_UNDEF)
            err_txt = ERR_TEXT_NO_IN_MSG +": IdentityDeal";
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM)); 
         else
            IdentityDeal = c_IdentityDeal(aux_buff);
         end;
         
         aux_buff = uTryToGetPropS(p_req_data_obj, "DealData"); 
         if (ValType(aux_buff) == V_UNDEF)
            err_txt = ERR_TEXT_NO_IN_MSG +": DealData";
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM)); 
         else
            DealData = c_DealData(aux_buff);
         end;

         aux_buff = uTryToGetPropS(p_req_data_obj, "ComissArray"); 
         if(ValType(aux_buff) == V_GENOBJ)
            ComissArray = TArray;
            aux_buff = 0;
            while(p_req_data_obj.ComissArray.size > aux_buff)
               ComissArray.value(ComissArray.size) = c_Comiss(p_req_data_obj.ComissArray.value(aux_buff));
               aux_buff = aux_buff + 1;
            end;
         elif(ValType(aux_buff) == V_UNDEF)
         else
            err_txt = string(InErrNotObj, "ComissArray");
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
         end;

         aux_buff = uTryToGetPropS(p_req_data_obj, "PartyDealList"); 
         if(ValType(aux_buff) == V_GENOBJ)
            PartyDealList = TArray;
            aux_buff = 0;
            while(p_req_data_obj.PartyDealList.size > aux_buff)
               PartyDealList.value(PartyDealList.size) = c_PartyDeal(p_req_data_obj.PartyDealList.value(aux_buff));
               aux_buff = aux_buff + 1;
            end;
         elif(ValType(aux_buff) == V_UNDEF)
            err_txt = ERR_TEXT_NO_IN_MSG +": PartyDealList";
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM));
         else
            err_txt = string(InErrNotObj, "PartyDealList");
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
         end;
         
         aux_buff = uTryToGetPropS(p_req_data_obj, "LimitsList"); 
         if(ValType(aux_buff) == V_GENOBJ)
            LimitsList = TArray;
            aux_buff = 0;
            while(p_req_data_obj.LimitsList.size > aux_buff)
               LimitsList.value(LimitsList.size) = c_Limits(p_req_data_obj.LimitsList.value(aux_buff));
               aux_buff = aux_buff + 1;
            end;
         elif(ValType(aux_buff) == V_UNDEF)
         else
            err_txt = string(InErrNotObj, "LimitsList");
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
         end;
         
         aux_buff = uTryToGetPropS(p_req_data_obj, "PayInstrList"); 
         if(ValType(aux_buff) == V_GENOBJ)
            PayInstrList = TArray;
            aux_buff = 0;
            while(p_req_data_obj.PayInstrList.size > aux_buff)
               PayInstrList.value(PayInstrList.size) = c_PayInstr(p_req_data_obj.PayInstrList.value(aux_buff));
               aux_buff = aux_buff + 1;
            end;
         elif(ValType(aux_buff) == V_UNDEF)
         else
            err_txt = string(InErrNotObj, "PayInstrList");
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
         end;
         
         aux_buff = uTryToGetPropS(p_req_data_obj, "PrevDeal");
         if (ValType(aux_buff) != V_UNDEF)
            PrevDeal = c_PrevDeal(aux_buff);
         end;
         
      else
         err_txt = ERR_TEXT_NO_IN_MSG +": DealList.DealParm";
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM));
      end;
   end; /* macro uInitPrime() */

   uInitPrime(p_req_data_obj);   
end;


// непосредственная обработка единичной записи
// формирование класса ответа по единичной записи
macro RunProcessDeals(p_req_data_obj)
   var ResultAction = c_DealParm;
   var req_obj_serv = NULL;
   
   private var resp_resultCode, resp_resultText, SOFRDealID = NULL;
   private var retval;     // ответ по созданию/обновлению сделки
   
   req_obj_serv = c_ProcessDealsRequest(p_req_data_obj);

   /* Вызываем сервис */
   retval =_MoneyMarketDeal_CreateNew(req_obj_serv);
   if (retval.Code == 0)
      SOFRDealID = retval.SOFRDealID;
      resp_resultCode = 0;
      resp_resultText = "OK";
   else
      resp_resultCode = -3000;
      if (req_obj_serv.IdentityDeal.ActionType == 1)
         resp_resultText = "Ошибка создания сделки: " + retval.text;
      elif (req_obj_serv.IdentityDeal.ActionType == 2)
         resp_resultText = "Ошибка обновления сделки: " + retval.text;
      elif (req_obj_serv.IdentityDeal.ActionType == 3)
         resp_resultText = "Ошибка удаления сделки: " + retval.text;
      end;
   end;

   /* Получаем объектный вид ответа */
   ResultAction.ExternalID = req_obj_serv.IdentityDeal.ExternalID;
   ResultAction.DealID = req_obj_serv.IdentityDeal.DealID;
   ResultAction.SOFRDealID = SOFRDealID;
   ResultAction.Result.Code = resp_resultCode;
   ResultAction.Result.Text = resp_resultText;  

   return ResultAction;
      
onError(err)
   /* Получаем объектный вид ответа */
   ResultAction.Result.Code = c_err_obj.obtain_err_code(err);
   ResultAction.Result.Text = c_err_obj.obtain_err_msg(err);
   
   return ResultAction;
end;


/*----------------------------------------------*/
/*  Запрос вставки сделки                       */
/*----------------------------------------------*/
macro adp_ProcessDeals(IncomeData)
   var out_str = "";
  
   var req_msg_obj = NULL;
   var req_data_obj = NULL;
   var resp_data_obj = NULL;
   var resp_data_obj_arr = TArray;
   
   var ProcessDeals_result = NULL;
   var DealList = TArray();   
   var DealParm = NULL;
   
   var v_result, v_xml;
   var err_txt, out_code;
   
   var ReqID            : string;   // ИД запроса Да
   var SenderId         : string;   // Код АС-источника сведений Нет

   if(ValType(IncomeData) == V_UNDEF)
      RunError(ERR_TEXT_NO_IN_MSG, c_err_obj(ERR_TEXT_NO_IN_MSG,
                                             ERR_CODE_NO_IN_PRM));
   end;
         
   /* Преобразуем запрос в объектный вид - begin */
   req_msg_obj = c_secur_msg_converter();
   if(not req_msg_obj.m_decode_escaped_char(IncomeData))
      RunError(req_msg_obj.get_service_msg(), c_usr_err_obj(req_msg_obj.get_service_msg()));
   end;
   if(not req_msg_obj.m_make_pure_msg_from_ifx(req_msg_obj.get_pure_msg()))
      RunError(req_msg_obj.get_service_msg(), c_usr_err_obj(req_msg_obj.get_service_msg()));
   end;
   req_data_obj = req_msg_obj.m_secur_internal_req(req_msg_obj.get_pure_msg());
   /* Преобразуем запрос в объектный вид - end */

   if(ValType(req_data_obj) == V_UNDEF)
      err_txt = "Не удалось преобразовать XML в объект";
      RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
   end;
   
   // обработка
   ReqID = uTryToGetPropS(req_data_obj, "ReqID");
   if (ValType(ReqID) == V_UNDEF)
      err_txt = ERR_TEXT_NO_IN_MSG +": ReqID";
      RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM)); 
   end;
   SenderId = uTryToGetPropS(req_data_obj, "SenderId"); 

   DealList = uTryToGetPropS(req_data_obj, "DealList");
   
   resp_data_obj_arr.Size = 0;
   var resp_data_obj_arr_i = 0;

   for (DealParm, DealList)
      // единичная обработка
      ProcessDeals_result = RunProcessDeals(DealParm);

      // массив результатов обработки
      resp_data_obj_arr_i = resp_data_obj_arr.Size;
      resp_data_obj_arr(resp_data_obj_arr_i) = ProcessDeals_result;
      
      DealParm = NULL;
      ProcessDeals_result = NULL;
   end;     
   
   // итоговый класс 
   resp_data_obj = c_outObj;
   resp_data_obj.ProcessDeals_resp.ReqID = ReqID; 
   resp_data_obj.ProcessDeals_resp.SenderId = SenderId;
   resp_data_obj.ProcessDeals_resp.Result.Code = 0;
   resp_data_obj.ProcessDeals_resp.Result.Text = "OK";
   resp_data_obj.ProcessDeals_resp.Result.DealList = resp_data_obj_arr;

   /* Преобразуем объектный вид ответа в документ требуемого формата - begin */
   out_str = req_msg_obj.m_secur_internal_resp(resp_data_obj);
   /* Преобразуем объектный вид ответа в документ требуемого формата - end */
  
   req_msg_obj = NULL;

   return out_str;
   
onError(err)
   out_code = c_err_obj.obtain_err_code(err);
   err_txt = c_err_obj.obtain_err_msg(err);

   resp_data_obj = c_outObj;
   resp_data_obj.ProcessDeals_resp.ReqID = XmlRpcRequestId; 
   resp_data_obj.ProcessDeals_resp.SenderId = 0;
   resp_data_obj.ProcessDeals_resp.Result.Code = out_code;
   resp_data_obj.ProcessDeals_resp.Result.Text = err_txt;

   /* Преобразуем объектный вид ответа в документ требуемого формата - begin */
   out_str = req_msg_obj.m_secur_internal_resp(resp_data_obj);
   /* Преобразуем объектный вид ответа в документ требуемого формата - end */   
   
   req_msg_obj = NULL;
      
   return out_str;
end;

/*---------------------------------------*/
/*              Точка входа              */
/*---------------------------------------*/
macro ProcessDeals (IncomeData)
   var out_str = "";
  
   out_str = adp_ProcessDeals(IncomeData);
   return out_str;
end;
