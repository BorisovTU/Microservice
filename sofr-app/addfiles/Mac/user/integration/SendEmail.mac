import globals, oralib, likepy;
import "u_common_email_utils.mac";


private const CV_EMAIL_GRP_IncomingPayment = 4;
private var SS_RESPONSE_REPEAT_OK = 0; 
private var SS_RESPONSE_REPEAT_ERROR = 1; 
private var SS_RESPONSE_NEXT = 2; 
private var SS_RESPONSE_END = 3; 
private var SS_RESPONSE_FATAL = 4; 
private var SS_RESPONSE_PROXY = 5; 

private class c_ssRunResult(p_ProcessState, p_ErrorNumber, p_ErrorText)
   var ProcessState;
   var ErrorNumber;
   var ErrorText;

   private macro init_ssRunResult(p_ProcessState, p_ErrorNumber, p_ErrorText)
      if(ValType(p_ProcessState) != V_UNDEF)
         ProcessState = p_ProcessState;
      end;
      if(ValType(p_ErrorNumber) != V_UNDEF)
         ErrorNumber = p_ErrorNumber;
      end;
      if(ValType(p_ErrorText) != V_UNDEF)
         ErrorText = p_ErrorText;
      end;
   end;

   init_ssRunResult(p_ProcessState, p_ErrorNumber, p_ErrorText);
end;

macro Send_Payment_Email() :object

   var sql_str, rs, cmd,
   v_email_processor,
   TextMessage,
   PaymentCount :integer = 0,
   ResultSheduler :object;

      

   sql_str =           " select rownum,pm.t_ReceiverAccount, pm.t_PayerAccount, pm.t_amount  from dpmpaym_dbt pm    ";
   sql_str = sql_str + " where pm.t_dockind in(320,322) and pm.t_tobackoffice = chr(0) and (pm.t_paymstatus = 2995 or pm.t_paymstatus = 2990) ";
   sql_str = sql_str + " and exists( select * from upmbiscotto_dbt up where up.t_pmid = pm.t_paymentid)             ";
   sql_str = sql_str + " and t_valuedate = trunc(sysdate)                                                                       ";
   sql_str = sql_str + " order by rownum desc                                                                       ";


   cmd = RSDCommand(sql_str);
   rs = RSDRecordSet(cmd);

   v_email_processor = c_email_proc_env();
   v_email_processor.m_set_msg_head("СОФР - Входящие платежи");

   if(rs.movenext)
      PaymentCount = rs.value(0);
      v_email_processor.m_add_row_to_msg_text("В АРМ - Позиционера остались не отмаршрутизированные платежи - "+PaymentCount);
      v_email_processor.m_add_row_to_msg_text(" ");
      v_email_processor.m_add_row_to_msg_text("Счет плательщика            Счет получателя            Сумма ");
      v_email_processor.m_add_row_to_msg_text(rs.value("t_PayerAccount")+"     "+rs.value("t_PayerAccount")+"     "+rs.value("t_Amount"));
   end;

   while (rs.movenext())
      v_email_processor.m_add_row_to_msg_text(rs.value("t_PayerAccount")+"     "+rs.value("t_PayerAccount")+"     "+rs.value("t_Amount"));
   end;
  
   v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_IncomingPayment, true);

   if(PaymentCount != 0)
//      v_email_processor.m_save_to_submit_synch();
      v_email_processor.m_submit_email_synch();
   end;

   return c_ssRunResult(SS_RESPONSE_END);


onError(err)

  return c_ssRunResult(SS_RESPONSE_REPEAT_ERROR);

end;

