/* BIQ-13578
Шишкин Е.В. 
Моидифицированный MassUnloadQUIK_7839.mac

СОФР должен отобрать действующие договоры с признаком выгрузки клиента в QUIK, проставленным UID и типом авторизации "двухфакторная авторизация" и выгрузить обновление данных по таким договорам. 
*/
import dlcontrfunc;
import global_utils_intgr;

macro execMassUnload_13578()
   var sql_str, cmd;
   var codekind = 105; 
   var objecttype = 5025;
   var ErrCode;
   var num_rows=0;
      
   var marketid_mmvb = ПолучитьБиржуПоВидуКодаДБО(DLCCK_USC); 

   BegAction(2000,"Создание событий 5025 для планировщика");
   
   // по всем открытым площадкам по бирже ММВБ
   // двухфакторная аутентификация договора БО
   // была успешная выгрузка в QUIK
   // есть код QUIK
   // нет необработанного события 5025
   sql_str = "BEGIN "+
             "   INSERT INTO utableprocessevent_dbt "+
             "   ( T_TIMESTAMP,  T_OBJECTTYPE, T_OBJECTID, T_TYPE, T_STATUS, T_NOTE ) "+
             "   SELECT distinct sysdate, 5025, cntr.t_partyid, 9, 1, 'BIQ-7839. Массовая выгрузка bookbuilding' "+
             "     FROM dsfcontr_dbt cntr, "+
             "          ddlcontr_dbt dl, "+
             "          ddlcontrmp_dbt mp, "+
             "          dsfcontr_dbt cntr_mp "+
             "   WHERE dl.t_sfcontrid = cntr.t_id "+
             "     AND dl.t_dlcontrid = mp.t_dlcontrid "+
             "     AND cntr_mp.t_id = mp.t_sfcontrid "+
             "     AND cntr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') "+
             "     AND cntr_mp.t_servkind = 1 and cntr_mp.t_servkindsub = 8 "+
             "     AND mp.t_mpclosedate = to_date('01.01.0001','dd.mm.yyyy') and mp.t_marketid = :marketid "+
             "     AND exists (select 1 from dobjatcor_dbt o where o.t_objecttype = 207 and o.t_groupid = 170 "+
             "                    and o.t_attrid = 2 and (o.t_validtodate >= :dt1 or o.t_validtodate = to_date('01.01.0001','dd.mm.yyyy')) "+
             "                    and lpad(dl.t_dlcontrid,34,'0') = o.t_object ) "+
             "     AND exists (select 1 from dobjatcor_dbt o where o.t_objecttype = 207 and o.t_groupid = 101 "+
             "                    and o.t_attrid = 3 and (o.t_validtodate >= :dt2 or o.t_validtodate = to_date('01.01.0001','dd.mm.yyyy')) "+
             "                    and lpad(dl.t_dlcontrid,34,'0') = o.t_object ) "+
             "     AND exists (select 1 from dobjatcor_dbt o where o.t_objecttype = 3 and o.t_groupid = 171 "+
             "                    and o.t_attrid = 1 and (o.t_validtodate >= :dt3 or o.t_validtodate = to_date('01.01.0001','dd.mm.yyyy')) "+
             "                    and lpad(cntr.t_partyid,10,'0') = o.t_object) "+
             "     AND exists (select 1 from dobjcode_dbt where t_ObjectType = 3 "+
             "                    and t_codekind = :codekind and t_objectid = cntr.t_partyid "+
             "                    and t_BankCloseDate = TO_DATE('01010001', 'DDMMYYYY') ) "+
             "     AND not exists (select 1 from utableprocessevent_dbt u "+
             "                      where u.t_status = 1 "+
             "                        and u.t_objecttype = :objtype "+
             "                        and u.t_objectid = cntr.t_partyid ) ; "+    
             "   :p_cnt := SQL%ROWCOUNT; "+
             "END; ";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("marketid", RSDBP_IN, marketid_mmvb);
   cmd.AddParam("dt1", RSDBP_IN, date());
   cmd.AddParam("dt2", RSDBP_IN, date());
   cmd.AddParam("dt3", RSDBP_IN, date());
   cmd.AddParam("codekind", RSDBP_IN, codekind);
   cmd.AddParam("objtype", RSDBP_IN, objecttype);
   cmd.AddParam("p_cnt", RSDBP_OUT, V_INTEGER);
   cmd.execute();
   num_rows = cmd.value("p_cnt");

   EndAction();

   cmd.close; cmd = null;

   if (num_rows == 0)
     msgbox("Нет подходящих договоров");
     return false;
   end;

   msgbox("События 5025 (выгрузка в QUIK) для планировщика созданы: "+num_rows);
   return True;
onerror(e)
   RunError(e.message + getFullCmdErrorText(cmd));
end;

if (Gettrue(false, "Вы хотите запустить массовую выгрузку клиентов для обновления классов торговли в QUIK?"))
   execMassUnload_13578();
end;
