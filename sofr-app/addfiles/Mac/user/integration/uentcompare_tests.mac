/**
 @file 		uentcompare_tests.mac
 @brief 	Для авто-тестирования отчета-сверки 24
*/
IMPORT RSD;


/**
  @brief		Процедура подготовки группы авто-тестов. 
  @return 		0, процедура выполнена успешно, 1, процедура ошибка инициализации
*/
macro SetUp
  var sql, cmd, x_Res;
  sql =  "DECLARE "
       + "BEGIN "
       + "  :p_res := cft_utils.PrepareEntCompareTestTmp(); "
       + "EXCEPTION WHEN others THEN "
       + "  :p_res := 1; "
       + "END; "
  ;
  cmd = RSDCommand(sql);
  cmd.addParam("p_Res", RSDBP_OUT, V_INTEGER);
  cmd.execute();
  x_Res = cmd.value("p_Res");
  return x_Res;

ONERROR(err)
  return 1;
end; // SetUp()


/**
  @brief		Процедура завершения группы авто-тестов. 
  @return 		0, процедура выполнена успешно, 1, процедура ошибка инициализации
*/
macro TearDown

  var sql, cmd, x_Res;
  sql =  "DECLARE "
       + "BEGIN "
       + "  EXECUTE IMMEDIATE 'DELETE FROM UENTCOMPARETEST_TMP'; "
       + "  :p_res := 0; "
       + "EXCEPTION WHEN others THEN "
       + "  :p_res := 1; "
       + "END; "
  ;
  cmd = RSDCommand(sql);
  cmd.addParam("p_Res", RSDBP_OUT, V_INTEGER);
  cmd.execute();
  x_Res = cmd.value("p_Res");
  return x_Res;

ONERROR(err)
  return 1;
end; // TearDown()

/** 
  @brief 		Проверка: если нет проводки в ЦФТ, не должно быть идентификатора ЦФТ
  @return 		0, если тест прошел успешно, 1, если не успешно
*/
MACRO NoCftIDOnErr3

  var sql, cmd, x_Res;
  sql =  "DECLARE "
       + "  x_Res number := 1; "
       + "  x_Cnt number; "
       + "BEGIN "
       + "  SELECT count(*) INTO x_Cnt FROM UENTCOMPARETEST_TMP "
       + "    WHERE T_err = 3 and t_idbiscotto is not null; "
       + "  IF (x_Cnt = 0) THEN "
       + "    x_Res := 0; "
       + "  END IF; "
       + "  :p_res := x_Res; "
       + "EXCEPTION WHEN others THEN "
       + "  :p_res := 1; "
       + "END; "
  ;
  cmd = RSDCommand(sql);
  cmd.addParam("p_Res", RSDBP_OUT, V_INTEGER);
  cmd.execute();
  x_Res = cmd.value("p_Res");
  return x_Res;

ONERROR(err)
  return 1;
END;

/** 
  @brief 		Проверка: отсутствие проводок 306-306
  @return 		0, если тест прошел успешно, 1, если не успешно
*/
MACRO No306_306

  var sql, cmd, x_Res;
  sql =  "DECLARE "
       + "  x_Res number := 1; "
       + "  x_Cnt number; "
       + "BEGIN "
       + "  SELECT count(*) INTO x_Cnt FROM UENTCOMPARETEST_TMP "
       + "    WHERE regexp_like(t_acct_Db, '^306') and regexp_like(t_acct_cr, '^306'); "
       + "  IF (x_Cnt = 0) THEN "
       + "    x_Res := 0; "
       + "  END IF; "
       + "  :p_res := x_Res; "
       + "EXCEPTION WHEN others THEN "
       + "  :p_res := 1; "
       + "END; "
  ;
  cmd = RSDCommand(sql);
  cmd.addParam("p_Res", RSDBP_OUT, V_INTEGER);
  cmd.execute();
  x_Res = cmd.value("p_Res");
  return x_Res;

ONERROR(err)
  return 1;
END;

/** 
  @brief 		Проверка: отсутствие проводок по урегулированию парных счетов
  @return 		0, если тест прошел успешно, 1, если не успешно
*/
MACRO NoPairs

  var sql, cmd, x_Res;
  sql =  "DECLARE "
       + "  x_Res number := 1; "
       + "  x_Cnt number; "
       + "BEGIN "
       + "  SELECT count(*) INTO x_Cnt FROM UENTCOMPARETEST_TMP "
       + "    WHERE T_DETAILS = 'Приведение в соответствие остатков на парных лицевых счетах'; "
       + "  IF (x_Cnt = 0) THEN "
       + "    x_Res := 0; "
       + "  END IF; "
       + "  :p_res := x_Res; "
       + "EXCEPTION WHEN others THEN "
       + "  :p_res := 1; "
       + "END; "
  ;
  cmd = RSDCommand(sql);
  cmd.addParam("p_Res", RSDBP_OUT, V_INTEGER);
  cmd.execute();
  x_Res = cmd.value("p_Res");
  return x_Res;

ONERROR(err)
  return 1;
END;
