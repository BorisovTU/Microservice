/*-----------------------------------------------------------------------------------------
   UpdateBrokerContractDepoReq.mac
   Обновление информации о договоре БО/ИИС в Депозитарий
   Используется для передачи кодов на Спб
   BIQ-7041
   Гераськина Т.В.
-----------------------------------------------------------------------------------------*/
import rsd, func_lib;
import global_classes;
import dlcontrfunc; // BIQ-7041 для кода биржи Спб

macro FillBrokInfo_UpdateDepo(p_dlcontrid)
   var outobj = c_BrokInfoUpdate();
   var sql_str, rs, cmd;

   // Биржевые коды Спб
   var marketid = ПолучитьБиржуПоВидуКодаДБО(DLCCK_SPB_BIDCODE); 

   // договор БО
   sql_str = "SELECT dl.t_dlcontrid, dl.t_sfcontrid, sf.t_number, sf.t_partyid, mp.t_marketid, mp.t_mpcode "+
             "  FROM dsfcontr_dbt sf, "+
             "       ddlcontr_dbt dl, "+
             "       dparty_dbt p, "+
             "       ddlcontrmp_dbt mp, "+
             "       dsfcontr_dbt cntr "+
             " WHERE sf.t_id = dl.t_sfcontrid "+
             "   AND sf.t_partyid = p.t_partyid "+
             "   AND dl.t_dlcontrid = :p_dlcontrid "+
             "   AND cntr.t_id = mp.t_sfcontrid "+
             "   AND mp.t_dlcontrid = dl.t_dlcontrid "+
             "   AND mp.t_mpclosedate = to_date('01.01.0001','dd.mm.yyyy') "+
             "   AND cntr.t_servkind = 1 "+
             "   AND MP.T_MARKETID = :p_marketid";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("p_dlcontrid", RSDBP_IN, p_dlcontrid);
   cmd.AddParam("p_marketid", RSDBP_IN, marketid);
   rs = RSDRecordSet(cmd);
   if (rs.movenext) // одна площадка
      outobj.ContractParameters = c_ContractParams_UpdateDepo();
      outobj.ContractParameters.ContractNumber              = rs.value("t_number");
      outobj.ContractParameters.ClientCodeSPBEX             = rs.value("t_mpcode");
      outobj.ContractParameters.ClientRegistrationCodeSPBEX = GetObjCode_ByObjectid(p_dlcontrid, 207, CODEKIND_DLCONTR_SPB);; 
      outobj.ContractParameters.ClientId.ObjectId           = GetPartyCode_ByNumber(rs.value("t_partyid"), PARTY_CODEKIND_ABS);
      outobj.ContractParameters.ContractId.ObjectId         = p_dlcontrid;
   end;
   rs.close; rs = null;
   cmd.close; cmd = null;
   
   return outobj;
end;

private class c_UpdateBrokerContractDepoReq
   var UpdateBrokerContractDepoReq;
end;


macro UpdateBrokerContractDepoReq ( dlcontrid, p_error:@object )
   var res = c_UpdateBrokerContractDepoReq();

   if( valType (dlcontrid) == V_INTEGER )
      res.UpdateBrokerContractDepoReq = FillBrokInfo_UpdateDepo(dlcontrid);
   end;

   return res;
onError(err)
  res = NULL;
  p_error = c_Error;
  p_error.ErrorCode = c_err_obj.obtain_err_code(err);
  p_error.ErrorDesc = c_err_obj.obtain_err_msg(err);
  
  return res;  
end;

//UpdateBrokerContractDepoReq(15332);