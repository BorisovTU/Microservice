import "usr_table_int.mac", "secur_prc_msg_transform.mac", "RequestWS.mac", "uws_exchng_log.mac",
       "approveaccountingentries_req.mac";


//функция вставки задания в шедулер
macro InsertJobSheduler( AccTrnId :integer ) :integer
var res_obj :object,
    state :integer = 0,
    errortext :string = "",
    RequestText,
    v_transformator,
    v_answer,
    v_logger_obj,
    v_log_id;

 res_obj = ApproveAccountingEntries_Req ( AccTrnId ); 
 res_obj.ApproveAccountingEntriesRequestMsg.ApproveAccountingEntriesRequest.ApproveEntry.PersonnelNumber = "00001316";    //maa - dly testa
 res_obj.ApproveAccountingEntriesRequestMsg.ApproveAccountingEntriesRequest.ApproveEntry.EntryID.ObjectID = 154622431; //maa - dly testa

 if( isEqClass("CApproveEntry", res_obj.ApproveAccountingEntriesRequestMsg.ApproveAccountingEntriesRequest.ApproveEntry) ) //исключаем вероятность, что пока задание болталось в очереди, запись из acctrn_dbt удалили
  v_transformator = c_secur_msg_converter();
  RequestText = v_transformator.m_secur_external_req(res_obj);
  v_logger_obj = uws_exchng_logger(null, null, XmlRpcRequestId(), "ws_SOFR_addAccountingEntries", modulename(), RequestText);
  v_log_id = v_logger_obj.get_log_id();

  v_answer = SubmitRequestToWS( 2,          // ИД очереди.
                                "",         // ИД сообщения.
                                "",         // Идентификатор Бэк Офиса. (не обрабатывается).
                                false,/*true ,*/      // Признак синхронной обработки. Если не указан, = False /* 20181211 - kva - должно быть значение false */
                                "0000",/*1,*/          // Подразделение системы-назначения. /* 20181210 - kva - требуется значение 0000 */
                                8,          // ИД типа данных
                                RequestText // Бизнес данные в виде XML.
                                );
 // v_logger_obj.add_response(v_answer);

 else
  state = 1;
 end;

//по !!!! не успешному результату сообщить в почту 
//по !!!! не успешному результату сообщить в почту

 res_obj = Null;

 return state;

onError(err)
 res_obj = Null;
 state = 1;
 return state;

end;


if( InsertJobSheduler(  443 /*Id проводки*/ ) == 0 )
 MsgBox("OKOKOKOKOK");
else
 MsgBox("BEBEBEBEBEBE");
end;