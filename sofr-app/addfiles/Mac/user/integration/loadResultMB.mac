//А.Киселев 07.09.2018 Загрузка в СОФР RS Securities ответного файла результатов регистрации клиентов на МБ
import oralib, likepy, globals, rsexts;

var File_Name,
    Load_Path,
    File_Name_CtrlFile = "", // Имя управляющего файла для SQL*Loader
    Log_File_Name = "",
    Bad_File_Name = "",
    Dsc_File_Name = "";



// Определение имени файла из его ПОЛНОГО имени
private macro ExtractShortName(NameOperFile)
 var Flag = True;

 NameOperFile = Trim(NameOperFile);
 while (Flag)
   if(Index(NameOperFile,"\\") != 0)
     Flag = TRUE
   else
     Flag = FALSE
   end;
   if(Flag)
     NameOperFile = SubStr(NameOperFile,Index(NameOperFile,"\\")+1)
   end
 end;
 return NameOperFile
end;

//отключаем индексы для ускорения загрузки
private macro index_off()
  var str,cmd;
  str = "ALTER INDEX UCLIENTREGMB_LOGTMP_DBT_IDX0 UNUSABLE;";
  cmd = rsdcommand(str);
  cmd.execute;
end;

//включаем индексы
private macro index_on()
  var str,cmd;
  str = "ALTER INDEX UCLIENTREGMB_LOGTMP_DBT_IDX0 REBUILD;";
  cmd = rsdcommand(str);
  cmd.execute;
end;

/*удаление вспомогательных файлов*/
private macro DeleteFile
  //RemoveFile(File_Name);
  RemoveFile(Log_File_Name);
  RemoveFile(Bad_File_Name);
  RemoveFile(File_Name_CtrlFile);
end;



//Загрузка ответного файла результатов регистрации клиентов на МБ
macro loadResultMBClientReg( File_Name :string) :bool
var DSN :string = "",
    USER_ID :string = "",
    PASSWORD :string = "",
    CONNSTRING :string = GetIniString("CONNSTRING", "rsreq.ini"),
    String_sqlldr :string = "",
    state :integer = 0,
    CNum = UserNumber(),
    ldr_param :string = "bindsize=100000000 readsize=1000000 columnarrayrows=10000000 rows=100000 errors=100000 ",
    Query :string = "",
    Params :TArray = TArray();


  Query = " DELETE uclientRegMB_LogTmp_dbt WHERE T_SESSIONID = :p_Cnum";
  Params = makeArray( SQLParam("p_Cnum", Cnum) );
  execSQL( Query, Params );
  
  DSN = SubStr(CONNSTRING, 5, index(CONNSTRING,";") - 5);
  CONNSTRING = SubStr(CONNSTRING, index(CONNSTRING,";") + 1);
  USER_ID = SubStr(CONNSTRING, index(CONNSTRING,"user id=") + 8, index(CONNSTRING,";") - 9);
  CONNSTRING = SubStr(CONNSTRING, index(CONNSTRING,";") + 1);
  PASSWORD = SubStr(CONNSTRING, index(CONNSTRING,"password=") + 9);

  String_sqlldr = "userid=" + USER_ID + "/" + PASSWORD + "@" + DSN;
  GetRegistryValue("РСХБ\\CLIENTMBXMLIN", V_STRING, File_Name_CtrlFile);

  Log_File_Name = File_Name_CtrlFile + "\\MB_" + string(UserNumber) + ".log";
  Bad_File_Name = File_Name_CtrlFile + "\\MB_" + string(UserNumber) + ".bad";
  Dsc_File_Name = File_Name_CtrlFile + "\\MB_" + string(UserNumber) + ".dsc";
  File_Name_CtrlFile = File_Name_CtrlFile + "\\MB_" + string(UserNumber) + ".ctl";
  
  SetOutput(File_Name_CtrlFile); //Создаем CONTROL-file для загрузки файла результатов регистрации клиентов на МБ
  [LOAD DATA CHARACTERSET UTF8
   INFILE *
   INTO TABLE uclientRegMB_LogTmp_dbt
   APPEND
   (
    T_SESSIONID        CONSTANT ##########,
    T_FILENAME         CONSTANT #########################################################################################################################,
    T_OPER             CONSTANT #####,
    T_XML_MESS         LOBFILE(CONSTANT '####################################################################################################################') TERMINATED BY EOF
   )
   ](CNum, ExtractShortName(File_Name), {Oper}, File_Name);
  SetOutput(Null, True); 
  Close(File_Name_CtrlFile);



  BegAction(Null, "Отключаем индескы", false);
  index_off;
  EndAction(10);

  BegAction(Null, "Загружаем файл в RS-Bank...", False);
  
  state = Run("run_sqlldr.cmd", String_sqlldr + " control=" + File_Name_CtrlFile +
                                        " data="    + File_Name          +
                                        " log="     + Log_File_Name      +
                                        " bad="     + Bad_File_Name      +
                                        " discard=" + Dsc_File_Name      +
                                        " SKIP_UNUSABLE_INDEXES=true"    +
                                        " " + ldr_param);

  EndAction(10);
  
  if(state == 0)

   BegAction(Null, "Включаем индескы", false);
   index_on;
   EndAction(10);

   Params = makeArray( SQLParam("p_Cnum", Cnum) );
   state = execStoredFunc( "USR_PKG_IMPORT_SOFR.AddRecXMLToLOG", V_INTEGER, Params );
   if( state == 0 )
      Params = Null;
    //ХП обработка загруженного XML результат статус
      Params = makeArray( SQLParam("p_ObjectType", 3),//!!!!!!!!!!!!!прописать вид объекта в реестре
                          SQLParam("p_CodeKind", 8 ),//!!!!!!!!!!!!!прописать вид кода субъекта в реестре
                          SQLParam("p_GroupId", 121),//!!!!!!!!!!!!!прописать категорию в реестре
                          SQLParam("p_SessionId", CNum),
                          SQLParam("p_FileName", ExtractShortName(File_Name)),
                          SQLParam("p_Oper", {Oper}) );
      state = execStoredFunc( "USR_PKG_IMPORT_SOFR.ProcwssObjAttrib", V_INTEGER, Params );
      if( state != 0 )
       //!!!!!!!!!почитать протокол ошибок, если 0 проверить ErrCode могут быть не все записи обработаны
      end;

   //  DeleteFile();
    return true;
   else
    return false;
   end;
  else
   //достать протокол загрузки из файла !!!!!!!!!!!!!!!!!!! и вставить в таблицу со статусом 2
   return false;
  end;
  
End;

// по всей видимости - не используется в Прод. Загрузка файлов происходит через планировщик 10017 БО: Сверка SEM82
//loadResultMBClientReg("\\\\HELLENIC-NEW\\public_e\\home\\Chagin\\Stand\\RSHB\\RSHB_SEC_DEBUG\\TxtFile\\MB_IN\\eclients_mb.xml");

