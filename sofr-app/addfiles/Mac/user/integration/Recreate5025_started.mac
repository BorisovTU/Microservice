/*
$Name:        Recreate5025_started.mac
$Module:      Интеграция с внешними системами
$Description: Массовая повторная отправка клиентов в QUIK
*/

// DEF-25610
// SD8138586||543987||Интеграционый поток 5025 - выгрузка в Квик гоняет файлы по кругу
// 9)	подготовить процедуру массовой повторной отправки в КВИК данных о клиентах. Для всех субъектов, у которых категория <Выгружен в QUIK> имеет значение <Начата>,
// и при этом дата установки категории меньше текущего дня, вызвать процедуру выгрузки данных в КВИК (такую же, как предусмотрена по Ctrl+Z на клиенте).

// DEF-30418] i-support 543987 (DEF-25610). Массовая отправка клиентов. Обработаны несколько клиентов из всего списка
import rsd;
import globals;

var sql_str, cmd;

sql_str = 
"declare "+
"    vcnt number :=0; "+
"    v_oper number := :p_oper; "+
"    v_operday date:= :p_day; "+
"begin  "+
"   for datax in  ( "+
"    select  d.t_object, t_id, t_validtodate "+
"      from dobjatcor_dbt d "+
"     where d.t_objecttype = 3 and d.t_groupid = 171 and d.t_validtodate > sysdate "+
"    and t_sysdate < sysdate and t_attrid = 3 "+
"    and not exists (select 1 from utableprocessevent_dbt u where u.t_objecttype = 5025 "+
"                       and u.t_objectid = to_number(d.t_object) and t_status = 1) "+
"    )   loop "+
"        insert into utableprocessevent_dbt (t_recid, t_timestamp, t_objecttype, t_objectid, t_type, t_status, t_note, t_oper, t_resulttext) "+
"        values (0, sysdate, 5025, to_number(datax.t_object), 1, 1, 'Выгрузка клиентов с категорией <Выгружен в QUIK>=<Начата>', v_oper, 'Выгрузка клиентов с категорией <Выгружен в QUIK>=<Начата>'); "+
"        delete from dobjatcor_dbt where t_objecttype = 3 and t_groupid = 171 and t_object = datax.t_object and t_id <> datax.t_id; "+
"        update dobjatcor_dbt set t_attrid = 2, t_oper = v_oper,  t_validfromdate = v_operday, t_sysdate = trunc(sysdate), t_systime = to_date('01010001 '||to_char(sysdate,'hh24:mi:ss'),'dd.mm.yyyy hh24:mi:ss') where t_id = datax.t_id; "+
"        vcnt := vcnt+1; "+
"   end loop ; "+
"   :p_cnt := vcnt; "+
"end; ";

BegAction(2000, "Ожидайте...");
cmd = RSDCommand(sql_str);
cmd.AddParam("p_oper", RSDBP_IN, {oper});
cmd.AddParam("p_day", RSDBP_IN, {curdate});
cmd.AddParam("p_cnt", RSDBP_OUT, V_INTEGER);
cmd.execute;
EndAction();
if ((cmd.Value("p_cnt") != null) and (cmd.Value("p_cnt") != nullval))
   if (cmd.Value("p_cnt") > 0)
      msgbox("Создано событий 5025: "+cmd.Value("p_cnt"));
   else 
      msgbox("Нет выгрузок в статусе <Начата>");
   end;
else 
   msgbox("Нет выгрузок в статусе <Начата>");
end;

