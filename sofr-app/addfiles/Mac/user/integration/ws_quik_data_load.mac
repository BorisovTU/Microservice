// ws_quik_data_load.mac
import oralib, "cblogger2.mac";

class DepoLimitsJournalLoader(log)
    private var logger = log;
    var count:integer = 0;

    macro PrepareToLoad(guid:string)
        var params = MakeSqlParamsArray(guid);
        var query = "update sofr_depolimitsjournal"
                + "   set processing_id = :guid "
                + " where processing_id is null "
                + "   and processed_at is null";
        ExecSql(query, params);

        query = "select count(1) "
                + "  from sofr_depolimitsjournal "
                + " where processing_id = :guid "
                + "   and processed_at is null ";
        var sql = ExecSQLselect(query, params);
        if (sql.MoveNext())
            this.count = sql.value(0);
        end;

    OnError(err)
        logger.ErrorClob("DepoLimitsJournalLoader.PrepareToLoad", GetFullErrMsg(err));
    end;

    private macro InsertData(guid:string):bool
        var params = MakeSqlParamsArray(guid);
        var query = "insert into ddepolimitsjournal_dbt (id, "
                + "                                    t_firmid, "
                + "                                    t_clientcode, "
                + "                                    t_seccode, "
                + "                                    t_calcdatetime,  "
                + "                                    t_currentbal, "
                + "                                    t_currentlimit, " 
                + "                                    t_price, "
                + "                                    t_pricecurrcode, "
                + "                                    t_crossrate, "
                + "                                    t_longdiscount, "
                + "                                    t_shortdiscount) "
                + "select depolimitsjournal_seq.nextval, "
                + "       j.firmid, "
                + "       j.clientcode, "
                + "       j.seccode, "
                + "       j.calcdatetime, "
                + "       j.currentbal, "
                + "       j.currentlimit, "
                + "       j.price, "
                + "       j.pricecurrcode, "
                + "       j.crossrate, "
                + "       j.longdiscount, "
                + "       j.shortdiscount "
                + "  from sofr_depolimitsjournal j "
                + " where processing_id = :guid "
                + "   and processed_at is null";
        ExecSql(query, params);

        return true;
    OnError(err)
        logger.ErrorClob("DepoLimitsJournalLoader.InsertData", GetFullErrMsg(err));
        return false;
    end;

    private macro Finalize(guid:string, processTime:datetime):bool
        var params = MakeSqlParamsArray(processTime, guid);
        var query = "update sofr_depolimitsjournal"
                + "   set processed_at = :time "
                + " where processing_id = :guid "
                + "   and processed_at is null";
        ExecSql(query, params);
        return true;
    OnError(err)
        logger.ErrorClob("DepoLimitsJournalLoader.Finalize", GetFullErrMsg(err));
        return false;
    end;

    macro Load(guid:string, processTime:datetime):bool
        var isSuccess:bool = InsertData(guid);

        if (isSuccess)
            isSuccess = Finalize(guid, processTime);
        end;

        return isSuccess;
    end;

    macro ClearBuffer()
        var query = "delete sofr_depolimitsjournal "
                + "   where processing_id is not null "
                + "     and processed_at is not null "
                + "     and created_at < trunc(sysdate) - 7 ";
        ExecSql(query);
        return true;
    OnError(err)
        logger.ErrorClob("DepoLimitsJournalLoader.ClearBuffer", GetFullErrMsg(err));
        return false;
    end;
end;

class MoneyLimitsJournalLoader(log)
    private var logger = log;
    var count:integer = 0;

    macro PrepareToLoad(guid:string)
        var params = MakeSqlParamsArray(guid);
        var query = "update sofr_moneylimitsjournal"
                + "   set processing_id = :guid "
                + " where processing_id is null "
                + "   and processed_at is null";
        ExecSql(query, params);

        query = "select count(1) "
                + "  from sofr_moneylimitsjournal "
                + " where processing_id = :guid "
                + "   and processed_at is null ";
        var sql = ExecSQLselect(query, params);
        if (sql.MoveNext())
            this.count = sql.value(0);
        end;

    OnError(err)
        logger.ErrorClob("MoneyLimitsJournalLoader.PrepareToLoad", GetFullErrMsg(err));
    end;

    private macro InsertData(guid:string):bool
        var params = MakeSqlParamsArray(guid);
        var query = "insert into dmoneylimitsjournal_dbt (id, "
                + "                                    t_firmid, "
                + "                                    t_clientcode, "
                + "                                    t_currcode, "
                + "                                    t_calcdatetime,  "
                + "                                    t_currentbal, "
                + "                                    t_currentlimit, "
                + "                                    t_crossrate, "
                + "                                    t_longdiscount, "
                + "                                    t_shortdiscount) "
                + "select moneylimitsjournal_seq.nextval, "
                + "       j.firmid, "
                + "       j.clientcode, "
                + "       j.currcode, "
                + "       j.calcdatetime, "
                + "       j.currentbal, "
                + "       j.currentlimit, "
                + "       j.crossrate, "
                + "       j.longdiscount, "
                + "       j.shortdiscount "
                + "  from sofr_moneylimitsjournal j "
                + " where processing_id = :guid "
                + "   and processed_at is null";
        ExecSql(query, params);

        return true;
    OnError(err)
        logger.ErrorClob("MoneyLimitsJournalLoader.InsertData", GetFullErrMsg(err));
        return false;
    end;

    private macro Finalize(guid:string, processTime:datetime):bool
        var params = MakeSqlParamsArray(processTime, guid);
        var query = "update sofr_moneylimitsjournal"
                + "   set processed_at = :time "
                + " where processing_id = :guid "
                + "   and processed_at is null";
        ExecSql(query, params);
        return true;
    OnError(err)
        logger.ErrorClob("MoneyLimitsJournalLoader.Finalize", GetFullErrMsg(err));
        return false;
    end;

    macro Load(guid:string, processTime:datetime):bool
        var isSuccess:bool = InsertData(guid);

        if (isSuccess)
            isSuccess = Finalize(guid, processTime);
        end;

        return isSuccess;
    end;

    macro ClearBuffer()
        var query = "delete sofr_moneylimitsjournal "
                + "   where processing_id is not null "
                + "     and processed_at is not null "
                + "     and created_at < trunc(sysdate) - 7 ";
        ExecSql(query);
        return true;
    OnError(err)
        logger.ErrorClob("MoneyLimitsJournalLoader.ClearBuffer", GetFullErrMsg(err));
        return false;
    end;
end;

class FuturesHoldingJournalLoader(log)
    private var logger = log;
    var count:integer = 0;

    macro PrepareToLoad(guid:string)
        var params = MakeSqlParamsArray(guid);
        var query = "update sofr_futuresholdingjournal"
                + "   set processing_id = :guid "
                + " where processing_id is null "
                + "   and processed_at is null";
        ExecSql(query, params);

        query = "select count(1) "
                + "  from sofr_futuresholdingjournal "
                + " where processing_id = :guid "
                + "   and processed_at is null ";
        var sql = ExecSQLselect(query, params);
        if (sql.MoveNext())
            this.count = sql.value(0);
        end;

    OnError(err)
        logger.ErrorClob("FuturesHoldingJournalLoader.PrepareToLoad", GetFullErrMsg(err));
    end;

    private macro InsertData(guid:string):bool
        var params = MakeSqlParamsArray(guid);
        var query = "insert into dfutoptlimitsjournal_dbt (id, "
                + "                                    t_firmid, "
                + "                                    t_clientcode, "
                + "                                    t_seccode, "
                + "                                    t_calcdatetime,  "
                + "                                    t_currentbal, "
                + "                                    t_currentlimit, "   
                + "                                    t_settleprice, "
                + "                                    t_settlepricecurrcode, "
                + "                                    t_crossrate, "
                + "                                    t_longdiscount, "
                + "                                    t_shortdiscount) "
                + "select futoptlimitsjournal_seq.nextval, "
                + "       j.firmid, "
                + "       j.clientcode, "
                + "       j.seccode, "
                + "       j.calcdatetime, "
                + "       j.currentbal, "
                + "       j.currentlimit, "
                + "       j.settleprice, "
                + "       j.settlepricecurrcode, "
                + "       j.crossrate, "
                + "       j.longdiscount, "
                + "       j.shortdiscount "
                + "  from sofr_futuresholdingjournal j "
                + " where processing_id = :guid "
                + "   and processed_at is null";
        ExecSql(query, params);

        return true;
    OnError(err)
        logger.ErrorClob("FuturesHoldingJournalLoader.InsertData", GetFullErrMsg(err));
        return false;
    end;

    private macro Finalize(guid:string, processTime:datetime):bool
        var params = MakeSqlParamsArray(processTime, guid);
        var query = "update sofr_futuresholdingjournal"
                + "   set processed_at = :time "
                + " where processing_id = :guid "
                + "   and processed_at is null";
        ExecSql(query, params);
        return true;
    OnError(err)
        logger.ErrorClob("FuturesHoldingJournalLoader.Finalize", GetFullErrMsg(err));
        return false;
    end;

    macro Load(guid:string, processTime:datetime):bool
        var isSuccess:bool = InsertData(guid);

        if (isSuccess)
            isSuccess = Finalize(guid, processTime);
        end;

        return isSuccess;
    end;

    macro ClearBuffer()
        var query = "delete sofr_futuresholdingjournal "
                + "   where processing_id is not null "
                + "     and processed_at is not null "
                + "     and created_at < trunc(sysdate) - 7 ";
        ExecSql(query);
        return true;
    OnError(err)
        logger.ErrorClob("FuturesHoldingJournalLoader.ClearBuffer", GetFullErrMsg(err));
        return false;
    end;
end;

class CcpPriceRangeLoader(log)
    private var logger = log;
    var count:integer = 0;

    macro PrepareToLoad(guid:string)
        var params = MakeSqlParamsArray(guid);
        var query = "update sofr_ccppricerange"
                + "   set processing_id = :guid "
                + " where processing_id is null "
                + "   and processed_at is null";
        ExecSql(query, params);

        query = "select count(1) "
                + "  from sofr_ccppricerange "
                + " where processing_id = :guid "
                + "   and processed_at is null ";
        var sql = ExecSQLselect(query, params);
        if (sql.MoveNext())
            this.count = sql.value(0);
        end;

    OnError(err)
        logger.ErrorClob("CcpPriceRangeLoader.PrepareToLoad", GetFullErrMsg(err));
    end;

    private macro InsertData(guid:string):bool
        var params = MakeSqlParamsArray(guid);
        var query = "insert into dccppricerange_dbt (id, "
                + "                                  t_seccode, "
                + "                                  t_loaddate, "
                + "                                  t_Discount_CCP) "
                + "select ccppricerange_seq.nextval, "
                + "       p.seccode, "
                + "       p.loaddate, "
                + "       p.Discount_CCP "
                + "  from sofr_ccppricerange p "
                + " where processing_id = :guid "
                + "   and processed_at is null";
        ExecSql(query, params);

        return true;
    OnError(err)
        logger.ErrorClob("CcpPriceRangeLoader.InsertData", GetFullErrMsg(err));
        return false;
    end;

    private macro Finalize(guid:string, processTime:datetime):bool
        var params = MakeSqlParamsArray(processTime, guid);
        var query = "update sofr_ccppricerange"
                + "   set processed_at = :time "
                + " where processing_id = :guid "
                + "   and processed_at is null";
        ExecSql(query, params);
        return true;
    OnError(err)
        logger.ErrorClob("CcpPriceRangeLoader.Finalize", GetFullErrMsg(err));
        return false;
    end;

    macro Load(guid:string, processTime:datetime):bool
        var isSuccess:bool = InsertData(guid);

        if (isSuccess)
            isSuccess = Finalize(guid, processTime);
        end;

        return isSuccess;
    end;

    macro ClearBuffer()
        var query = "delete sofr_ccppricerange "
                + "   where processing_id is not null "
                + "     and processed_at is not null "
                + "     and created_at < trunc(sysdate) - 7 ";
        ExecSql(query);
        return true;
    OnError(err)
        logger.ErrorClob("CcpPriceRangeLoader.ClearBuffer", GetFullErrMsg(err));
        return false;
    end;
end;