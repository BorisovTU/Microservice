import RSD;
import "func_lib.mac";

Macro Getvalute(ContrId)
   var rez = "";
   var cmd = "SELECT fi.t_ccy "+
       " FROM dsfssi_dbt ssi "+
       " left join dfininstr_dbt fi on SSI.T_FIID = fi.t_fiid "+
       " WHERE ssi.t_objecttype = 659 AND ssi.t_objectid = lpad(:cntr_id,10,'0')";
   cmd = RSDCommand(cmd);
   cmd.AddParam("cntr_id", RSDBP_IN, ContrId);
   var rs =  RsdRecordset(cmd);
      rs.movenext;
      if (valtype(rs.value(0))!= 26)
         rez = rez + rs.value(0);
         while (rs.moveNext)
            rez = rez +", " +rs.value(0);
         end;
      end;
   return rez;
end;

macro TableInsert(ContractID:TArray)
   var param = "";
   var rezval = "";
   var n = 1;
   var cmdIns;
   var v_aux_buff;

   param = param + ContractID[0];

   while (n<= ContractID.Size-1)
      param = param + ", "+ contractId[n];
      n = n+1;
   end;

// 2020-10-21 Cherednichenko is 517351: добавляем distinct, т.к. дублируются письма о новых договорах
   var cmd = "SELECT distinct dl.t_dlcontrid,                                                                               "+
"       contr.t_number,                                                                                            "+
"       TO_CHAR (contr.t_datebegin, 'dd.mm.yyyy'),                                                                 "+
"       DECODE (subcontr.t_servkindsub,  8, 1,  9, 2) AS typetp,                                                   "+
"       DECODE (party.t_legalform,  1, 2,  2, 1) AS legalform,                                                     "+
"       DECODE (objcode.t_code,                                                                                    "+
"               CHR (1), '',                                                                                       "+
"               CHR (0), '',                                                                                       "+
// 2021-01-13 Cherednichenko is 521525: ЦФТ использует код без префикса, не отрезаем первые символы.
//"               SUBSTR (objcode.t_code, 6))                                                                        "+
"               objcode.t_code)                                                                                    "+
"          AS t_code,                                                                                              "+
"       dep.t_name,                                                                                                "+
"       (select t_code from ddlobjcode_dbt where t_codekind = 1 and t_objecttype = 207                             "+
"                        and  t_objectid = DL.T_DLCONTRID and t_BankCloseDate = TO_DATE('01010001', 'DDMMYYYY') ), "+
"       subcontr.t_id,                                                                                             "+
"       sel.accoun,                                                                                                "+
"       sel.acctype,                                                                                               "+
"       (SELECT t_open_date                                                                                        "+
"          FROM daccount_dbt                                                                                       "+
"         WHERE t_account = sel.accoun)AS accdateopen,                                                             "+
"       decode (Kvalinv.t_state,null, 0, 1,1,0,2 ) as KvalInv,                                                     "+
"        decode (kvalInv.t_regdate, to_date('01010001', 'ddmmyyyy'), null, kvalInv.t_regdate) as dateStKI,         "+
"        decode ( kvalInv.t_changedate, to_date('01010001', 'ddmmyyyy'), null,kvalInv.t_changedate ) as DateEndKI, "+
"       contr.t_name as ContractName                                                                               "+ // 2020-07-16 Cherednichenko is511913
"  FROM ddlcontr_dbt dl                                                                                            "+
"       LEFT JOIN ddlcontrmp_dbt ddlcontr ON dl.t_dlcontrid = DDLCONTR.T_DLCONTRID                                 "+
"       LEFT JOIN dsfcontr_dbt contr ON DL.T_SFCONTRID = contr.t_id                                                "+
"       LEFT JOIN dsfcontr_dbt subcontr ON DDLCONTR.T_SFCONTRID = subcontr.t_id AND subcontr.t_servkind = 1        "+
"       LEFT JOIN dparty_dbt party ON contr.t_partyid = party.t_partyid                                            "+
"       LEFT JOIN dobjcode_dbt objcode ON     objcode.T_objecttype = 3                                             "+
"                    AND objcode.t_codekind = :codekind                                                            "+
"                    AND OBJCODE.T_OBJECTID = contr.t_partyid                                                      "+
"                    and OBJCODE.t_state = 0                                                                       "+
"       LEFT JOIN ddp_dep_dbt dep ON contr.t_department = dep.t_code                                               "+
"       LEFT JOIN (SELECT ssi.t_objectid AS objid,                                                                 "+
"                         settacc.t_account AS accoun,                                                             "+
"                         1 AS acctype                                                                             "+
"                    FROM dsfssi_dbt ssi, dsettacc_dbt settacc                                                     "+
"                   WHERE ssi.t_objecttype = 659                                                                   "+
"                         AND ssi.t_setaccid = settacc.t_settaccid                                                 "+
"                  UNION ALL                                                                                       "+
"                  SELECT LPAD (sf.t_id, 10, '0') AS objid,                                                        "+
"                         a.t_account AS accoun,                                                                   "+
"                         2 AS acctype                                                                             "+
"                    FROM dmcaccdoc_dbt mc, dsfcontr_dbt sf, daccount_dbt a                                        "+
"                   WHERE     t_catnum = 5087                                                                      "+
"                         AND mc.t_iscommon = CHR (88)                                                             "+
"                         AND sf.t_id = mc.t_clientcontrid                                                         "+
"                         AND a.t_account = mc.t_account                                                           "+
"                         AND a.t_chapter = mc.t_chapter                                                           "+
"                         AND sf.t_dateclose =                                                                     "+
"                                TO_DATE ('01010001', 'ddmmyyyy')) sel                                             "+
"          ON sel.objid = LPAD (subcontr.t_id, 10, '0')                                                            "+
"        left join dscqinv_dbt KvalInv on party.t_partyid = KVALINV.T_PARTYID                                      "+
   "     where subcontr.t_servkindsub is not null and  dl.t_dlcontrid IN ( "+param + " ) ";                        
   cmd = RSDCommand(cmd);                                                                                          
   cmd.AddParam("codekind", RSDBP_IN, PARTY_CODEKIND_ABS);
   var rs =  RsdRecordset(cmd);
   var employerform;
      while (rs.moveNext)
         v_aux_buff = ValType(rs.value(5));
         rezval = Getvalute(rs.value(8));
         
// 2020-11-03 Cherednichenko is 518113 Вне СОФР ИП - Юрлицо!
         employerform = rs.value(4);
         if (employerform == 1)
           var cmdEmployer = " select "
                           + " decode (b.t_legalform, 1, 2, 2, (decode (a.t_isemployer, chr(0), 1, chr(88), 2))) as form "
                           + " from dpersn_dbt a, dparty_dbt b, dsfcontr_dbt c where 1=1 "
                           + " and b.t_partyid = c.t_partyid "
                           + " and a.t_personid = b.t_partyid "
                           + " and c.t_number = :contrnumber ";
           cmdEmployer = RSDCommand(cmdEmployer);
           cmdEmployer.AddParam("contrnumber", RSDBP_IN, rs.value(1));
           var rsemp = RsdRecordset(cmdEmployer);
           if (rsemp.moveNext)
             employerform = rsemp.value(0);
           end;
         end;
         
         cmdIns = "INSERT INTO SOFR_CONTRACTBOOUT (CONTRACTID, ";
         cmdIns = cmdIns + "                       CONTRACTNUMBER, ";
         cmdIns = cmdIns + "                       CONTRACTDATE, ";
         cmdIns = cmdIns + "                       TYPETP, ";
         cmdIns = cmdIns + "                       funds, ";
         cmdIns = cmdIns + "                       CLIENTTYPE, ";
         cmdIns = cmdIns + "                       CLIENTID, ";
         cmdIns = cmdIns + "                       BRANCHID, ";
         cmdIns = cmdIns + "                       codecli, accclibrok, ACCTYPE, accdateopen,  KVALINV, DATESTKI, DATEENDKI,T_TIMESTAMP, ";
         cmdIns = cmdIns + "                       CONTRACTNAME ) ";  // 2020-07-16 Cherednichenko is511913
         cmdIns = cmdIns + "               values (:0, ";
         cmdIns = cmdIns + "                       :1, ";
         cmdIns = cmdIns + "                       to_date(:2, 'dd.mm.yyyy'), ";
         cmdIns = cmdIns + "                       :3, ";
         cmdIns = cmdIns + "                       :Funds, ";
         cmdIns = cmdIns + "                       :4, ";
         if(v_aux_buff == 26)
            cmdIns = cmdIns + "                    CHR(0), ";
         else
            cmdIns = cmdIns + "                    :5, ";
         end;
         cmdIns = cmdIns + "                       :6, ";
         cmdIns = cmdIns + "                       :7, :8, :9,:10,:11,:12,:13, sysdate, ";
         cmdIns = cmdIns + "                       :14 ) "; // 2020-07-16 Cherednichenko is511913

         cmdIns = RSDCommand(cmdIns);
         cmdIns.AddParam("0", RSDBP_IN, rs.value(0));
         cmdIns.AddParam("1", RSDBP_IN, rs.value(1));
         cmdIns.AddParam("2", RSDBP_IN, rs.value(2));
         cmdIns.AddParam("3", RSDBP_IN, rs.value(3));
         cmdIns.AddParam("Funds", RSDBP_IN, rezval);
//         cmdIns.AddParam("4", RSDBP_IN, rs.value(4));
         cmdIns.AddParam("4", RSDBP_IN, employerform);

         if(v_aux_buff != 26)
            cmdIns.AddParam("5", RSDBP_IN, rs.value(5));
         end;

         cmdIns.AddParam("6", RSDBP_IN, rs.value(6));
         cmdIns.AddParam("7", RSDBP_IN, rs.value(7));
         cmdIns.AddParam("8", RSDBP_IN, rs.value(9));
         cmdIns.AddParam("9", RSDBP_IN, rs.value(10));
         cmdIns.AddParam("10", RSDBP_IN, rs.value(11));
         cmdIns.AddParam("11", RSDBP_IN, rs.value(12));
         cmdIns.AddParam("12", RSDBP_IN, rs.value(13));
         cmdIns.AddParam("13", RSDBP_IN, rs.value(14));
         cmdIns.AddParam("14", RSDBP_IN, rs.value(15)); // 2020-07-16 Cherednichenko is511913
         cmdIns.execute;
         rezval = null;
         cmdins = null;
   	end;
end;

/*
var ContractNumber;
getString(ContraCTNUMBER);
var cmdDel = "truncate table SOFR_CONTRACTBOOUT";
cmddel = rsdCommand(cmddel);
cmddel.execute;
var cmd = " SELECT dl.t_dlcontrid "+
"     FROM ddlcontr_dbt dl "+
"     left join dsfcontr_dbt contr on DL.T_SFCONTRID = contr.t_id "+
"     where CONTR.T_number = :Contractnumber ";
cmd  = RSDCommand(cmd);
cmd.AddParam("Contractnumber", RSDBP_IN, ContraCTNUMBER);
var myArray = tArray;
var n= 0;
var rs = RsdRecordset(cmd);
rs.movenext;
if (valtype(rs.value(0)) == 26)
msgbox("Не найден договор с номером " + Contractnumber);
else
myArray(n) = rs.value(0);
Tableinsert(myArray);
end; */

macro m_prep_cntrBO_to_transfer(p_id_list)
   var cmdDel = "truncate table SOFR_CONTRACTBOOUT";
   cmddel = rsdCommand(cmddel);
   cmddel.execute;

   Tableinsert(p_id_list);
end;
