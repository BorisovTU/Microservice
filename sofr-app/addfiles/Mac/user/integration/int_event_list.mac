/**
 @file int_event_list.mac
 @brief Интерфейс таблицы событий
 
  # tag
 - functional_block:Интеграция
 - code_type:GUI
 
  # changeLog
 |date       |author         |tasks            |note                                                        
 |-----------|---------------|-----------------|-------------------------------------------------------------
 |30.10.2023 |Гераськина Т.В.|DEF-54157        | Для синхронных запросов некорректно строятся цепочки
 |00.00.2019 |Карпов В.      |                 | Создание                   
 */

import rsd;
import RsbFormsInter;
import "int_usr_globals.mac";
//import rcw; // Для отладки


/*----------------------*/
/* Глобальные константы */
/*----------------------*/
private const CV_EVNT_STAT_1 = 1;
private const CV_EVNT_STAT_2 = 2;
private const CV_EVNT_STAT_4 = 4;
private const CV_EVNT_STAT_5 = 5;
private const CV_PRM_STAT_NAME = "p_stat_";

private const FT_STRING = 7;
private const FT_INT = 1;
private const FT_DATE = 9;
private const FT_TIME = 10;

private const CV_CLOSE_FORM_OK = 0;

private const CV_MSG_FILE_PREFIX = "msg_";
private const CV_MSG_FILE_POSTFIX = ".txt";
private const CV_MSG_FILE_PATH = "..\\TxtFile\\";


/*-----------------------*/
/* Глобальные переменные */
/*-----------------------*/
private var gv_evnt_sel_prm;               /* Параметры выборки событий */

private var gv_column_list_scr = TArray(); /* Список колонок скроллинга */
private var gv_num_columns_scr = 0;        /* Количество колонок скроллинга */
private var gv_scr_focus = 0;              /* Номер позиции скроллинга */



private macro m_send_evnt_obj_init(p_recid)
   var v_ret = true;
   var v_sql, v_cmd;

   v_sql =         "UPDATE utableprocessevent_dbt ";
   v_sql = v_sql + "   SET t_status = :p_status, ";
   v_sql = v_sql + "       t_lastupdate = SYSDATE ";
   v_sql = v_sql + " WHERE t_recid = :p_recid ";
   v_cmd = RSDCommand(v_sql);
   v_cmd.addParam("p_status", RSDBP_IN, CV_EVNT_STAT_1);
   v_cmd.addParam("p_recid", RSDBP_IN, p_recid);
   v_cmd.execute();

   v_cmd.close(); v_cmd = null; v_sql = null;

   return v_ret;

onError(err)
   v_ret = false;
   return v_ret;
end;


/**
@brief Параметры события
*/
private class c_evnt_prm(p_recid, p_objecttype, p_objectid)
   const CV_QNAME_IN = "ESB_TO_SOFR";
   const CV_QNAME_OUT = "SOFR_TO_ESB";

   var v_evnt_recid;         /* recid события */
   var v_evnt_objtype;       /* objecttype события */
   var v_evnt_objid;         /* objectid события */

   var v_is_old_log = false; /* Признак первой версии связки usr_exchng_log_dbt и dqueue_log_dbt */
   var v_evnt_queue_log_id;  /* Номер выбранного id журнала dqueue_log_dbt в списке найденных */
   var v_queue_log_id_list;  /* Список найденных записей журнала dqueue_log_dbt */

   var v_evnt_usr_log_id;    /* Номер выбранного id журнала usr_exchng_log_dbt в списке найденных */
   var v_usr_log_id_list;    /* Список найденных записей журнала usr_exchng_log_dbt */

   var v_log_reqid_req;      /* Связанный dxr_log_dbt.t_reqid */
   var v_log_req_date;       /* Дата запроса */
   var v_log_req_time;       /* Время запроса */

   var v_log_id_resp;        /* ID сообщения ответа в журнале */
   var v_log_reqid_resp;     /* Связанный dxr_log_dbt.t_reqid ответа */
   var v_log_resp_date;      /* Дата ответа */
   var v_log_resp_time;      /* Время запроса */
   var v_log_err_code_resp;  /* Код ошибки ответа */
   var v_log_err_msg_resp;   /* Текст ошибки ответа */
   var v_synch;

   /* Заполнение нулевых значений */
   macro m_set_null_log_data(p_mode)
      var v_mode;

      if(ValType(p_mode) == V_UNDEF)
         v_mode = 1;
      else
         v_mode = p_mode;
      end;

      if(v_mode == 1)
         v_log_reqid_req = "";
         v_log_req_date = date("00.00.0000");
         v_log_req_time = time("00:00:00");
      end;

      v_log_id_resp = 0;
      v_log_reqid_resp = "";
      v_log_resp_date = date("00.00.0000");
      v_log_resp_time = time("00:00:00");
      v_log_err_code_resp = "";
      v_log_err_msg_resp = "";
      v_synch = 0;
   end; /* macro m_set_null_log_data() */


   /* Получение данных из журналов */
   macro m_find_log_data()
      var v_aux_buf;
      var v_sql, v_cmd;

      v_sql =         "DECLARE ";
      v_sql = v_sql + "    v_ret NUMBER(10) := 0; ";
      v_sql = v_sql + "    v_queue_qname_in dqueue_log_dbt.t_qname%TYPE := :p_qname_in; ";
      v_sql = v_sql + "    v_queue_qname_out dqueue_log_dbt.t_qname%TYPE := :p_qname_out; ";
      v_sql = v_sql + "    v_usr_log_id usr_exchng_log_dbt.t_id%TYPE := :p_usr_log_id; ";
      if(v_is_old_log)
         v_sql = v_sql + " v_queue_log_id dqueue_log_dbt.t_id%TYPE := :p_queue_log_id; ";
      else
         v_sql = v_sql + " v_queue_log_id dqueue_log_dbt.t_id%TYPE; ";
      end;

      v_sql = v_sql + "    v_jms_cor_id_req dqueue_log_dbt.t_jmscorrelationid%TYPE; ";
      v_sql = v_sql + "    v_jms_mes_id_req dqueue_log_dbt.t_jmsmessageid%TYPE; ";
      v_sql = v_sql + "    v_jms_mes_guid_resp dqueue_log_dbt.t_jmsmessageguid%TYPE; ";
      v_sql = v_sql + "    v_jms_mes_id_resp dqueue_log_dbt.t_jmsmessageid%TYPE; ";

      v_sql = v_sql + "    v_usr_log_id_req usr_exchng_log_dbt.t_id%TYPE; ";
      v_sql = v_sql + "    v_usr_log_reqid_req usr_exchng_log_dbt.t_reqid_linked%TYPE; ";
      v_sql = v_sql + "    v_usr_log_req_dttm_req usr_exchng_log_dbt.t_req_dttm%TYPE; ";

      v_sql = v_sql + "    v_usr_log_id_resp usr_exchng_log_dbt.t_id%TYPE; ";
      v_sql = v_sql + "    v_usr_log_reqid_resp usr_exchng_log_dbt.t_reqid_linked%TYPE; ";
      v_sql = v_sql + "    v_usr_log_req_dttm_resp usr_exchng_log_dbt.t_req_dttm%TYPE; ";
      v_sql = v_sql + "    v_usr_log_err_code_resp usr_exchng_log_dbt.t_error_code%TYPE; ";
      v_sql = v_sql + "    v_usr_log_err_msg_resp usr_exchng_log_dbt.t_error_msg%TYPE; ";
      v_sql = v_sql + "    v_synch number(1); ";

      v_sql = v_sql + "BEGIN ";
      v_sql = v_sql + "    v_synch := 0; ";
      v_sql = v_sql + "    BEGIN ";
      v_sql = v_sql + "        SELECT t_id, t_transparent_id, t_reqid_linked, t_req_dttm ";
      v_sql = v_sql + "          INTO v_usr_log_id_req, v_jms_cor_id_req, v_usr_log_reqid_req, v_usr_log_req_dttm_req ";
      v_sql = v_sql + "          FROM usr_exchng_log_dbt ";
      v_sql = v_sql + "         WHERE t_id = v_usr_log_id; ";
      v_sql = v_sql + "    EXCEPTION ";
      /* Не удалось найти исходное сообщение */
      v_sql = v_sql + "        WHEN NO_DATA_FOUND ";
      v_sql = v_sql + "        THEN ";
      v_sql = v_sql + "            v_ret := 1; ";
      v_sql = v_sql + "        WHEN OTHERS ";
      v_sql = v_sql + "        THEN ";
      v_sql = v_sql + "            v_ret := 2; ";
      v_sql = v_sql + "    END; ";

      v_sql = v_sql + "    BEGIN ";
      v_sql = v_sql + "        IF v_ret = 0 ";
      v_sql = v_sql + "        THEN ";
      v_sql = v_sql + "            SELECT t_jmsmessageid, t_id ";
      v_sql = v_sql + "              INTO v_jms_mes_id_req, v_queue_log_id ";
      v_sql = v_sql + "              FROM dqueue_log_dbt ";
      if(v_is_old_log)
         v_sql = v_sql + "          WHERE t_id = v_queue_log_id ";
      else
         v_sql = v_sql + "          WHERE t_jmscorrelationid = (v_jms_cor_id_req || '-' || v_usr_log_id_req) ";
      end;
      v_sql = v_sql + "               AND t_qname = v_queue_qname_out; ";
      v_sql = v_sql + "        END IF; ";

      v_sql = v_sql + "    EXCEPTION ";
      /* Не удалось восстановить цепочку сообщений */
      v_sql = v_sql + "        WHEN NO_DATA_FOUND ";
      v_sql = v_sql + "        THEN ";
      v_sql = v_sql + "            v_ret := 3; ";
      v_sql = v_sql + "        WHEN OTHERS ";
      v_sql = v_sql + "        THEN ";
      v_sql = v_sql + "            v_ret := 4; ";
      v_sql = v_sql + "    END; ";

      /* для синхронных событий связка немного другая */
      v_sql = v_sql + "    BEGIN ";
      v_sql = v_sql + "        IF v_ret = 3 ";
      v_sql = v_sql + "        THEN ";
      v_sql = v_sql + "            SELECT t_jmsmessageid, t_id ";
      v_sql = v_sql + "              INTO v_jms_mes_id_req, v_queue_log_id ";
      v_sql = v_sql + "              FROM dqueue_log_dbt ";
      v_sql = v_sql + "             WHERE t_jmscorrelationid = to_char(v_usr_log_id_req) ";
      v_sql = v_sql + "               AND t_qname = v_queue_qname_out; ";
      v_sql = v_sql + "            v_ret := 0; ";
      v_sql = v_sql + "            v_synch := 1; ";
      v_sql = v_sql + "        END IF; ";

      v_sql = v_sql + "    EXCEPTION ";
      /* Не удалось восстановить цепочку сообщений */
      v_sql = v_sql + "        WHEN NO_DATA_FOUND ";
      v_sql = v_sql + "        THEN ";
      v_sql = v_sql + "            v_ret := 3; ";
      v_sql = v_sql + "        WHEN OTHERS ";
      v_sql = v_sql + "        THEN ";
      v_sql = v_sql + "            v_ret := 4; ";
      v_sql = v_sql + "    END; ";

      v_sql = v_sql + "    BEGIN ";
      v_sql = v_sql + "        IF v_ret = 0 ";
      v_sql = v_sql + "        THEN ";
      v_sql = v_sql + "            SELECT t_jmsmessageguid, t_jmsmessageid ";
      v_sql = v_sql + "              INTO v_jms_mes_guid_resp, v_jms_mes_id_resp ";
      v_sql = v_sql + "              FROM dqueue_log_dbt ";
      v_sql = v_sql + "             WHERE t_jmscorrelationid = v_jms_mes_id_req ";
      v_sql = v_sql + "               AND t_qname = v_queue_qname_in; ";
/*
      v_sql = v_sql + "            SELECT t_jmsmessageid ";
      v_sql = v_sql + "              INTO v_jms_mes_id_resp ";
      v_sql = v_sql + "              FROM dqueue_log_dbt ";
      v_sql = v_sql + "             WHERE t_jmsmessageguid = v_jms_mes_guid_resp ";
      v_sql = v_sql + "               AND t_xr_reqid IS NOT NULL; ";
*/
      v_sql = v_sql + "            IF v_synch = 1 THEN ";
      v_sql = v_sql + "             SELECT t_id, t_reqid_linked, nvl(t_resp_dttm,to_date('01010001','ddmmyyyy')) t_resp_dttm, t_error_code, ";
      v_sql = v_sql + "                    DECODE(t_error_msg, CHR(1), NULL, t_error_msg) t_error_msg ";
      v_sql = v_sql + "               INTO v_usr_log_id_resp, v_usr_log_reqid_resp, v_usr_log_req_dttm_resp, v_usr_log_err_code_resp, v_usr_log_err_msg_resp ";
      v_sql = v_sql + "               FROM usr_exchng_log_dbt ";
      v_sql = v_sql + "              WHERE t_id = v_usr_log_id; ";

      v_sql = v_sql + "            ELSE ";
      v_sql = v_sql + "             SELECT t_id, t_reqid_linked, t_req_dttm, t_error_code, ";
      v_sql = v_sql + "                    DECODE(t_error_msg, CHR(1), NULL, t_error_msg) t_error_msg ";
      v_sql = v_sql + "               INTO v_usr_log_id_resp, v_usr_log_reqid_resp, v_usr_log_req_dttm_resp, v_usr_log_err_code_resp, v_usr_log_err_msg_resp ";
      v_sql = v_sql + "               FROM usr_exchng_log_dbt ";
      v_sql = v_sql + "              WHERE t_transparent_id = v_jms_mes_id_resp; ";
      v_sql = v_sql + "            END IF; ";
      v_sql = v_sql + "        END IF; ";

      v_sql = v_sql + "    EXCEPTION ";
      /* Не удалось найти сообщение ответа */
      v_sql = v_sql + "        WHEN NO_DATA_FOUND ";
      v_sql = v_sql + "        THEN ";
      v_sql = v_sql + "            v_ret := 5; ";
      v_sql = v_sql + "        WHEN OTHERS ";
      v_sql = v_sql + "        THEN ";
      v_sql = v_sql + "            v_ret := 6; ";
      v_sql = v_sql + "    END; ";

      v_sql = v_sql + "    :p_queue_log_id := v_queue_log_id; ";
      v_sql = v_sql + "    :p_usr_log_reqid_req := v_usr_log_reqid_req; ";
      v_sql = v_sql + "    :p_usr_log_req_dttm_req := v_usr_log_req_dttm_req; ";
      v_sql = v_sql + "    :p_usr_log_id_resp := v_usr_log_id_resp; ";
      v_sql = v_sql + "    :p_usr_log_reqid_resp := v_usr_log_reqid_resp; ";
      v_sql = v_sql + "    :p_usr_log_req_dttm_resp := v_usr_log_req_dttm_resp; ";
      v_sql = v_sql + "    :p_usr_log_err_code_resp := v_usr_log_err_code_resp; ";
      v_sql = v_sql + "    :p_usr_log_err_msg_resp := v_usr_log_err_msg_resp; ";
      v_sql = v_sql + "    :p_synch := v_synch; ";
      v_sql = v_sql + "    :p_ret := v_ret; ";
      v_sql = v_sql + "END; ";

      v_cmd = RSDCommand(v_sql);
      v_cmd.addParam("p_qname_in", RSDBP_IN, CV_QNAME_IN);
      v_cmd.addParam("p_qname_out", RSDBP_IN, CV_QNAME_OUT);
      v_cmd.addParam("p_usr_log_id", RSDBP_IN, v_evnt_usr_log_id);
      if(v_is_old_log)
         v_cmd.addParam("p_queue_log_id", RSDBP_IN, v_evnt_queue_log_id);
      end;
      v_cmd.addParam("p_queue_log_id", RSDBP_OUT, V_INTEGER);
      v_cmd.addParam("p_usr_log_reqid_req", RSDBP_OUT, V_STRING);
      v_cmd.addParam("p_usr_log_req_dttm_req", RSDBP_OUT, V_DTTM);
      v_cmd.addParam("p_usr_log_id_resp", RSDBP_OUT, V_INTEGER);
      v_cmd.addParam("p_usr_log_reqid_resp", RSDBP_OUT, V_STRING);
      v_cmd.addParam("p_usr_log_req_dttm_resp", RSDBP_OUT, V_DTTM);
      v_cmd.addParam("p_usr_log_err_code_resp", RSDBP_OUT, V_STRING);
      v_cmd.addParam("p_usr_log_err_msg_resp", RSDBP_OUT, V_STRING, 2000);
      v_cmd.addParam("p_synch", RSDBP_OUT, V_INTEGER);
      v_cmd.addParam("p_ret", RSDBP_OUT, V_INTEGER);
      v_cmd.execute();

      if(v_cmd.value("p_ret") == 0)
         v_log_reqid_req = v_cmd.value("p_usr_log_reqid_req");
         dttmsplit(v_cmd.value("p_usr_log_req_dttm_req"), v_log_req_date, v_log_req_time);
         v_log_id_resp = v_cmd.value("p_usr_log_id_resp");
         v_log_reqid_resp = v_cmd.value("p_usr_log_reqid_resp");
         dttmsplit(v_cmd.value("p_usr_log_req_dttm_resp"), v_log_resp_date, v_log_resp_time);
         v_log_err_code_resp = v_cmd.value("p_usr_log_err_code_resp");

         v_aux_buf = ValType(v_cmd.value("p_usr_log_err_msg_resp"));
         if((v_aux_buf == V_UNDEF) or (v_aux_buf == 26))
            v_log_err_msg_resp = "";
         else
            v_log_err_msg_resp = v_cmd.value("p_usr_log_err_msg_resp");
         end;
         if(not v_is_old_log)
            v_evnt_queue_log_id = v_cmd.value("p_queue_log_id");
         end;
         v_synch = v_cmd.value("p_synch");

      elif((v_cmd.value("p_ret") == 1) or (v_cmd.value("p_ret") == 2))
         v_log_reqid_req = "";
         v_log_req_date = date("00.00.0000");
         v_log_req_time = time("00:00:00");
         v_log_id_resp = 0;
         v_log_reqid_resp = "";
         v_log_resp_date = date("00.00.0000");
         v_log_resp_time = time("00:00:00");
         v_log_err_code_resp = "";
         v_log_err_msg_resp = "";
         if(not v_is_old_log)
            v_evnt_queue_log_id = 0;
         end;
         v_synch = 0;

         msgbox("Не удалось найти исходное сообщение");

      elif((v_cmd.value("p_ret") == 3) or (v_cmd.value("p_ret") == 4))
         v_log_reqid_req = v_cmd.value("p_usr_log_reqid_req");
         dttmsplit(v_cmd.value("p_usr_log_req_dttm_req"), v_log_req_date, v_log_req_time);
         v_log_id_resp = 0;
         v_log_reqid_resp = "";
         v_log_resp_date = date("00.00.0000");
         v_log_resp_time = time("00:00:00");
         v_log_err_code_resp = "";
         v_log_err_msg_resp = "";
         if(not v_is_old_log)
            v_evnt_queue_log_id = 0;
         end;
         v_synch = 0;

         msgbox("Не удалось восстановить цепочку сообщений");

      elif((v_cmd.value("p_ret") == 5) or (v_cmd.value("p_ret") == 6))
         v_log_reqid_req = v_cmd.value("p_usr_log_reqid_req");
         dttmsplit(v_cmd.value("p_usr_log_req_dttm_req"), v_log_req_date, v_log_req_time);
         v_log_id_resp = 0;
         v_log_reqid_resp = "";
         v_log_resp_date = date("00.00.0000");
         v_log_resp_time = time("00:00:00");
         v_log_err_code_resp = "";
         v_log_err_msg_resp = "";
         if(not v_is_old_log)
            v_evnt_queue_log_id = v_cmd.value("p_queue_log_id");
         end;
         v_synch = 0;

         msgbox("Не удалось найти сообщение ответа");

      end;

      v_cmd.close(); v_cmd = NULL; v_sql = NULL;
   end; /* macro m_find_log_data() */


   /* Заполнение списка идентификаторов записей журнала */
   private macro m_fill_usr_log_id_list()
      var v_sql, v_cmd, v_rs;
      var v_aux_cntr;

      v_sql =         "  SELECT t_id, t_transparent_id ";
      v_sql = v_sql + "    FROM usr_exchng_log_dbt ";
      v_sql = v_sql + "   WHERE t_transparent_id = :p_transparent_id ";
      v_sql = v_sql + "ORDER BY t_id ASC ";

      v_cmd = RSDCommand(v_sql);
      v_cmd.addParam("p_transparent_id", RSDBP_IN, string(v_evnt_recid));

      v_rs = RSDRecordSet(v_cmd);
      v_usr_log_id_list.size = 0;

      /* Без этой записи ComboBox может работать непредсказуемо */
      v_usr_log_id_list.value(v_usr_log_id_list.size) = 0;
      v_evnt_usr_log_id = v_usr_log_id_list.value(0);

      while(v_rs.movenext())
         v_aux_cntr = v_usr_log_id_list.size;
         v_usr_log_id_list.value(v_aux_cntr) = int(v_rs.value("t_id"));

         v_evnt_usr_log_id = int(v_rs.value("t_id"));
      end;

      v_rs.close(); v_cmd.close(); v_rs = NULL; v_cmd = NULL; v_sql = NULL;

   end; /* macro m_fill_usr_log_id_list() */


   /* Заполнение при необходимости списка идентификаторов записей журнала */
   private macro m_fill_queue_log_id_list()
      var v_sql, v_cmd, v_rs;
      var v_aux_cntr;

/*
      v_sql =         "   SELECT t_id, 1 is_old_log ";
      v_sql = v_sql + "     FROM dqueue_log_dbt ";
      v_sql = v_sql + "    WHERE t_jmscorrelationid = :p_evnt_recid_1 ";
      v_sql = v_sql + "      AND t_qname = :p_qname_out_1 ";
      v_sql = v_sql + "UNION ALL ";
      v_sql = v_sql + "   SELECT q_log.t_id t_id, 0 is_old_log ";
      v_sql = v_sql + "     FROM usr_exchng_log_dbt usr_log ";
      v_sql = v_sql + "LEFT JOIN dqueue_log_dbt q_log ON q_log.t_jmscorrelationid = usr_log.t_transparent_id || '-' || usr_log.t_id ";
      v_sql = v_sql + "    WHERE usr_log.t_transparent_id = :p_evnt_recid_2 ";
      v_sql = v_sql + "      AND q_log.t_qname = :p_qname_out_2 ";
*/

// 2020-04-28 Cherednichenko - Оптимизируем запрос убирая избыточный джойн

      v_sql =         " SELECT t_id, 1 is_old_log ";
      v_sql = v_sql + "   FROM dqueue_log_dbt ";
      v_sql = v_sql + "  WHERE t_jmscorrelationid = :p_evnt_recid_1 AND t_qname = :p_qname_out_1 ";
      v_sql = v_sql + " UNION ALL ";
      v_sql = v_sql + " SELECT q_log.t_id t_id, 0 is_old_log ";
      v_sql = v_sql + "   FROM dqueue_log_dbt q_log ";
      v_sql = v_sql + "  WHERE 1 = 1 AND q_log.t_qname = :p_qname_out_2 ";
      v_sql = v_sql + "        AND q_log.t_jmscorrelationid IN ";
      v_sql = v_sql + "               (SELECT usr_log.t_transparent_id || '-' || usr_log.t_id ";
      v_sql = v_sql + "                  FROM usr_exchng_log_dbt usr_log ";
      v_sql = v_sql + "                 WHERE usr_log.t_transparent_id = :p_evnt_recid_2) ";

      v_cmd = RSDCommand(v_sql);
      v_cmd.addParam("p_evnt_recid_1", RSDBP_IN, string(v_evnt_recid));
      v_cmd.addParam("p_qname_out_1", RSDBP_IN, CV_QNAME_OUT);
      v_cmd.addParam("p_qname_out_2", RSDBP_IN, CV_QNAME_OUT);
      v_cmd.addParam("p_evnt_recid_2", RSDBP_IN, string(v_evnt_recid));

      v_rs = RSDRecordSet(v_cmd);
      v_queue_log_id_list.size = 0;

      /* Без этой записи ComboBox может работать непредсказуемо */
      v_queue_log_id_list.value(v_queue_log_id_list.size) = 0;
      v_evnt_queue_log_id = v_queue_log_id_list.value(0);

      while(v_rs.movenext())
         v_aux_cntr = v_queue_log_id_list.size;
         v_queue_log_id_list.value(v_aux_cntr) = int(v_rs.value("t_id"));

         v_evnt_queue_log_id = int(v_rs.value("t_id"));

         if(v_rs.value("is_old_log") == 1)
            v_is_old_log = true;
         end;
      end;

      v_rs.close(); v_cmd.close(); v_rs = NULL; v_cmd = NULL; v_sql = NULL;

   end; /* macro m_fill_queue_log_id_list() */


   private macro m_init_evnt_prm(i_recid, i_objecttype, i_objectid)
      v_evnt_recid = i_recid;
      v_evnt_objid = i_objectid;
      v_usr_log_id_list = TArray();
      v_queue_log_id_list = TArray();

      if(i_objecttype == 1)
         v_evnt_objtype = "Проводка";
      elif(i_objecttype == 4)
         v_evnt_objtype = "Счет";
      elif(i_objecttype == 9)
         v_evnt_objtype = "Договор БО";
      elif(i_objecttype == 501)
         v_evnt_objtype = "Платеж";
      else
         v_evnt_objtype = string(i_objecttype);
      end;

      m_fill_usr_log_id_list();
      /* Проверяем связку таблиц usr_exchng_log_dbt и dqueue_log_dbt */
      m_fill_queue_log_id_list();

      if(v_evnt_usr_log_id != 0)
         m_find_log_data();
      else
         m_set_null_log_data();
      end;
   end; /* macro m_init_evnt_prm() */


   m_init_evnt_prm(p_recid, p_objecttype, p_objectid);
end; /* class c_evnt_prm() */


/**
@brief Параметры выборки событий
*/
private class c_evnt_selection_prm()
   var v_com_date;
   var v_com_beg_date;
   var v_com_end_date;
   var v_com_date_switch;

   var v_com_status_1;
   var v_com_status_2;
   var v_com_status_4;
   var v_com_status_5;
   var v_com_status_inv;

   var v_acc_id;
   var v_acc_num;
   var v_acc_date_open;
   var v_acc_date_close;

   var v_acctrn_id;
   var v_acctrn_date;

   var v_paym_id;
   var v_paym_date;


   /* Получение признака необходимости добавления фильтра по счетам (параметры кроме id) */
   macro m_get_need_acc_filtr_aux()
      var v_ret = false;

      if((v_acc_num != "")
         or (v_acc_date_open != date("00.00.0000"))
         or (v_acc_date_close != date("00.00.0000")))

         v_ret = true;
      end;

      return v_ret;
   end; /* macro m_get_need_acc_filtr_aux() */


   /* Получение признака необходимости добавления фильтра по счетам */
   macro m_get_need_acc_filtr()
      var v_ret = false;

      if((v_acc_id != 0)
         or m_get_need_acc_filtr_aux())

         v_ret = true;
      end;

      return v_ret;
   end; /* macro m_get_need_acc_filtr() */


   /* Получение признака необходимости добавления фильтра по проводкам (параметры кроме id) */
   macro m_get_need_acctrn_filtr_aux()
      var v_ret = false;

      if(v_acctrn_date != date("00.00.0000"))
         v_ret = true;
      end;

      return v_ret;
   end; /* macro m_get_need_acctrn_filtr_aux() */


   /* Получение признака необходимости добавления фильтра по проводкам */
   macro m_get_need_acctrn_filtr()
      var v_ret = false;

      if((v_acctrn_id != 0)
         or m_get_need_acctrn_filtr_aux())

         v_ret = true;
      end;

      return v_ret;
   end; /* macro m_get_need_acctrn_filtr() */


   /* Получение признака необходимости добавления фильтра по платежам (параметры кроме id) */
   macro m_get_need_paym_filtr_aux()
      var v_ret = false;

      if(v_paym_date != date("00.00.0000"))
         v_ret = true;
      end;

      return v_ret;
   end; /* macro m_get_need_paym_filtr_aux() */


   /* Получение признака необходимости добавления фильтра по платежам */
   macro m_get_need_paym_filtr()
      var v_ret = false;

      if((v_paym_id != 0)
         or m_get_need_paym_filtr_aux())

         v_ret = true;
      end;

      return v_ret;
   end; /* macro m_get_need_paym_filtr() */


   /* Значения по умолчанию */
   private macro m_init_evnt_selection_prm()
      v_com_date = date();
      v_com_beg_date = date();
      v_com_end_date = date();
      v_com_date_switch = false;

      v_com_status_1 = false;
      v_com_status_2 = false;
      v_com_status_4 = false;
      v_com_status_5 = false;
      v_com_status_inv = false;

      v_acc_id = 0;
      v_acc_num = "";
      v_acc_date_open = date("00.00.0000");
      v_acc_date_close = date("00.00.0000");

      v_acctrn_id = 0;
      v_acctrn_date = date("00.00.0000");

      v_paym_id = 0;
      v_paym_date = date("00.00.0000");
   end;

   m_init_evnt_selection_prm();
end; /* class c_evnt_selection_prm() */


/**
@brief Класс формы параметров события
*/
class (TRsbPanel) c_evnt_prm_form(p_recid, p_objecttype, p_objectid)
   const CV_POS_X = 3;
   const CV_POS_Y = 1;
   private var v_msg_to_save;

   var v_evnt_prm;
   var v_evnt_recid_fld;
   var v_evnt_objtype_fld;
   var v_evnt_objid_fld;
   var v_evnt_usr_log_id_fld;
   var v_log_req_date_fld;
   var v_log_req_time_fld;
   var v_log_reqid_fld;
   var v_evnt_queue_log_id_fld;
   var v_log_resp_id_fld;
   var v_log_resp_date_fld;
   var v_log_resp_time_fld;
   var v_log_resp_reqid_fld;
   var v_usr_log_resp_err_code_fld;
   var v_usr_log_resp_err_msg_fld;


   /* Запрос для получения исходного сообщения запроса без контейнера */
   macro m_get_sql_src_req()
      var v_sql;

      v_sql =         "DECLARE ";
      v_sql = v_sql + "    v_msg_loc    CLOB; ";
      v_sql = v_sql + "    v_msg_id     INTEGER := :p_msg_id; ";
      v_sql = v_sql + "    v_msg_offset INTEGER := :p_msg_offset; ";
      v_sql = v_sql + "    v_msg_read   BINARY_INTEGER := 1000; ";
      v_sql = v_sql + "    v_msg_part   VARCHAR2 (2000 Char); ";
      v_sql = v_sql + "    v_ret_length BINARY_INTEGER; ";
      v_sql = v_sql + "BEGIN ";
      v_sql = v_sql + "    BEGIN ";
      v_sql = v_sql + "        SELECT t_req_message ";
      v_sql = v_sql + "          INTO v_msg_loc ";
      v_sql = v_sql + "          FROM usr_exchng_log_dbt ";
      v_sql = v_sql + "         WHERE t_id = v_msg_id; ";

      v_sql = v_sql + "        DBMS_LOB.read (v_msg_loc, ";
      v_sql = v_sql + "                       v_msg_read, ";
      v_sql = v_sql + "                       v_msg_offset, ";
      v_sql = v_sql + "                       v_msg_part); ";
      v_sql = v_sql + "        v_ret_length := v_msg_read; ";

      v_sql = v_sql + "    EXCEPTION ";
      v_sql = v_sql + "        WHEN NO_DATA_FOUND ";
      v_sql = v_sql + "        THEN ";
      v_sql = v_sql + "            v_ret_length := 0; ";
      v_sql = v_sql + "        WHEN OTHERS ";
      v_sql = v_sql + "        THEN ";
      v_sql = v_sql + "            v_ret_length := 0; ";
      v_sql = v_sql + "    END; ";

      v_sql = v_sql + "    :p_ret_length := v_ret_length; ";
      v_sql = v_sql + "    :p_ret_msg_part := v_msg_part; ";
      v_sql = v_sql + "END; ";

      return v_sql;
   end; /* macro m_get_sql_src_req() */


   /* Запрос для получения сообщения запроса с контейнером */
   macro m_get_sql_req()
      var v_sql;

      v_sql =         "DECLARE ";
      v_sql = v_sql + "    v_msg_loc    CLOB; ";
      v_sql = v_sql + "    v_msg_id     INTEGER := :p_msg_id; ";
      v_sql = v_sql + "    v_msg_offset INTEGER := :p_msg_offset; ";
      v_sql = v_sql + "    v_msg_read   BINARY_INTEGER := 1000; ";
      v_sql = v_sql + "    v_msg_part   VARCHAR2 (2000 Char); ";
      v_sql = v_sql + "    v_ret_length BINARY_INTEGER; ";
      v_sql = v_sql + "BEGIN ";
      v_sql = v_sql + "    BEGIN ";
      v_sql = v_sql + "        SELECT t_message ";
      v_sql = v_sql + "          INTO v_msg_loc ";
      v_sql = v_sql + "          FROM dqueue_log_dbt ";
      v_sql = v_sql + "         WHERE t_id = v_msg_id; ";

      v_sql = v_sql + "        DBMS_LOB.read (v_msg_loc, ";
      v_sql = v_sql + "                       v_msg_read, ";
      v_sql = v_sql + "                       v_msg_offset, ";
      v_sql = v_sql + "                       v_msg_part); ";
      v_sql = v_sql + "        v_ret_length := v_msg_read; ";

      v_sql = v_sql + "    EXCEPTION ";
      v_sql = v_sql + "        WHEN NO_DATA_FOUND ";
      v_sql = v_sql + "        THEN ";
      v_sql = v_sql + "            v_ret_length := 0; ";
      v_sql = v_sql + "        WHEN OTHERS ";
      v_sql = v_sql + "        THEN ";
      v_sql = v_sql + "            v_ret_length := 0; ";
      v_sql = v_sql + "    END; ";

      v_sql = v_sql + "    :p_ret_length := v_ret_length; ";
      v_sql = v_sql + "    :p_ret_msg_part := v_msg_part; ";
      v_sql = v_sql + "END; ";

      return v_sql;
   end; /* macro m_get_sql_req() */


   /* Запрос для получения исходного сообщения ответа с контейнером */
   macro m_get_sql_src_resp()
      var v_sql;

      v_sql =         "DECLARE ";
      v_sql = v_sql + "    v_jms_mes_id_req dqueue_log_dbt.t_jmsmessageid%TYPE; ";
      v_sql = v_sql + "    v_queue_qname_in dqueue_log_dbt.t_qname%TYPE := 'ESB_TO_SOFR'; ";
      v_sql = v_sql + "    v_msg_loc        CLOB; ";
      v_sql = v_sql + "    v_msg_id         INTEGER := :p_msg_id; ";
      v_sql = v_sql + "    v_msg_offset     INTEGER := :p_msg_offset; ";
      v_sql = v_sql + "    v_msg_read       BINARY_INTEGER := 1000; ";
      v_sql = v_sql + "    v_msg_part       VARCHAR2 (2000 Char); ";
      v_sql = v_sql + "    v_ret_length     BINARY_INTEGER; ";
      v_sql = v_sql + "BEGIN ";
      v_sql = v_sql + "    BEGIN ";
      v_sql = v_sql + "        SELECT t_jmsmessageid ";
      v_sql = v_sql + "          INTO v_jms_mes_id_req ";
      v_sql = v_sql + "          FROM dqueue_log_dbt ";
      v_sql = v_sql + "         WHERE t_id = v_msg_id; ";

      v_sql = v_sql + "        SELECT t_message ";
      v_sql = v_sql + "          INTO v_msg_loc ";
      v_sql = v_sql + "          FROM dqueue_log_dbt ";
      v_sql = v_sql + "         WHERE t_jmscorrelationid = v_jms_mes_id_req ";
      v_sql = v_sql + "           AND t_qname = v_queue_qname_in; ";

      v_sql = v_sql + "        DBMS_LOB.read (v_msg_loc, ";
      v_sql = v_sql + "                       v_msg_read, ";
      v_sql = v_sql + "                       v_msg_offset, ";
      v_sql = v_sql + "                       v_msg_part); ";
      v_sql = v_sql + "        v_ret_length := v_msg_read; ";

      v_sql = v_sql + "    EXCEPTION ";
      v_sql = v_sql + "        WHEN NO_DATA_FOUND ";
      v_sql = v_sql + "        THEN ";
      v_sql = v_sql + "            v_ret_length := 0; ";
      v_sql = v_sql + "        WHEN OTHERS ";
      v_sql = v_sql + "        THEN ";
      v_sql = v_sql + "            v_ret_length := 0; ";
      v_sql = v_sql + "    END; ";

      v_sql = v_sql + "    :p_ret_length := v_ret_length; ";
      v_sql = v_sql + "    :p_ret_msg_part := v_msg_part; ";
      v_sql = v_sql + "END; ";

      return v_sql;
   end; /* macro m_get_sql_src_resp() */


   /* Запрос для получения сообщения ответа без контейнера */
   macro m_get_sql_resp()
      var v_sql;

      v_sql = m_get_sql_src_req();

      return v_sql;
   end; /* macro m_get_sql_resp() */


   /* Запрос для получения исходного сообщения запроса без контейнера */
   macro m_get_sql_resp_synch()
      var v_sql;

      v_sql =         "DECLARE ";
      v_sql = v_sql + "    v_msg_loc    CLOB; ";
      v_sql = v_sql + "    v_msg_id     INTEGER := :p_msg_id; ";
      v_sql = v_sql + "    v_msg_offset INTEGER := :p_msg_offset; ";
      v_sql = v_sql + "    v_msg_read   BINARY_INTEGER := 1000; ";
      v_sql = v_sql + "    v_msg_part   VARCHAR2 (2000 Char); ";
      v_sql = v_sql + "    v_ret_length BINARY_INTEGER; ";
      v_sql = v_sql + "BEGIN ";
      v_sql = v_sql + "    BEGIN ";
      v_sql = v_sql + "        SELECT t_resp_message ";
      v_sql = v_sql + "          INTO v_msg_loc ";
      v_sql = v_sql + "          FROM usr_exchng_log_dbt ";
      v_sql = v_sql + "         WHERE t_id = v_msg_id; ";

      v_sql = v_sql + "        DBMS_LOB.read (v_msg_loc, ";
      v_sql = v_sql + "                       v_msg_read, ";
      v_sql = v_sql + "                       v_msg_offset, ";
      v_sql = v_sql + "                       v_msg_part); ";
      v_sql = v_sql + "        v_ret_length := v_msg_read; ";

      v_sql = v_sql + "    EXCEPTION ";
      v_sql = v_sql + "        WHEN NO_DATA_FOUND ";
      v_sql = v_sql + "        THEN ";
      v_sql = v_sql + "            v_ret_length := 0; ";
      v_sql = v_sql + "        WHEN OTHERS ";
      v_sql = v_sql + "        THEN ";
      v_sql = v_sql + "            v_ret_length := 0; ";
      v_sql = v_sql + "    END; ";

      v_sql = v_sql + "    :p_ret_length := v_ret_length; ";
      v_sql = v_sql + "    :p_ret_msg_part := v_msg_part; ";
      v_sql = v_sql + "END; ";

      return v_sql;
   end; /* macro m_get_sql_src_req() */


   /* Получение сообщения и сохранение в файл */
   macro m_get_msg_to_save()
      var v_ret = true;
      var v_choice;
      var v_msg_menu = TArray;
      var v_sql, v_cmd;
      var v_rd_stat = true;
      var v_msg_id;
      var v_msg_str = "";    /* Сообщение */
      var v_clob_offset = 1; /* Начальное смещение в clob'е - начинаем с первого символа */

      v_evnt_prm.v_evnt_usr_log_id = v_evnt_usr_log_id_fld.value;
      v_evnt_prm.v_evnt_queue_log_id = v_evnt_queue_log_id_fld.value;

      v_msg_menu.value(0) = "Исходный запрос без контейнера";
      v_msg_menu.value(1) = "Запрос с контейнером";
      v_msg_menu.value(2) = "Исходный ответ с контейнером";
      v_msg_menu.value(3) = "Ответ без контейнера";

      v_choice = menu(v_msg_menu, "Выберите сообщение", "Выберите сообщение");

      if(v_choice == 0)
         v_sql = m_get_sql_src_req();
         v_msg_id = v_evnt_prm.v_evnt_usr_log_id;
      elif(v_choice == 1)
         v_sql = m_get_sql_req();
         v_msg_id = v_evnt_prm.v_evnt_queue_log_id;
      elif(v_choice == 2)
         v_sql = m_get_sql_src_resp();
         v_msg_id = v_evnt_prm.v_evnt_queue_log_id;
      elif(v_choice == 3)
         if (v_evnt_prm.v_synch == 1)
            v_sql = m_get_sql_resp_synch();
         else 
            v_sql = m_get_sql_resp();
         end;
         v_msg_id = v_evnt_prm.v_log_id_resp;
      else
         msgbox("Выбор не подтвержден");
      end;


      if(v_choice >= 0)
         while(v_rd_stat)
            v_cmd = RSDCommand(v_sql);
            v_cmd.addParam("p_msg_id", RSDBP_IN, v_msg_id);
            v_cmd.addParam("p_msg_offset", RSDBP_IN, v_clob_offset);
            v_cmd.addParam("p_ret_length", RSDBP_OUT, V_INTEGER);
            v_cmd.addParam("p_ret_msg_part", RSDBP_OUT, V_STRING, 2000);
            v_cmd.execute();

            if(v_cmd.value("p_ret_length") > 0)
               v_msg_str = string(v_msg_str, v_cmd.value("p_ret_msg_part"));
               v_clob_offset = v_clob_offset + v_cmd.value("p_ret_length");

               v_rd_stat = true;
               v_cmd.close(); v_cmd = null;
            else
               v_rd_stat = false;
               v_cmd.close(); v_cmd = null;
            end;
         end;
      else
         v_ret = false;
      end;

      v_msg_to_save = v_msg_str;

      return v_ret;
   end; /* macro m_get_msg_to_save() */


   /* Обработчик событий нажатия кнопок */
   macro m_evnt_on_key_pressed(p_rsb_evnt)
      var v_aux_buf;

      if(p_rsb_evnt.KeyCode == K_F5)
         if(m_get_msg_to_save())
            if(strlen(v_msg_to_save) > 0)
               v_aux_buf = m_make_file_with_msg(v_msg_to_save);

               if(v_aux_buf != "")
                  msgbox(string("Создан файл: ", v_aux_buf));
               else
                  msgbox("Ошибка: файл не создан");
               end;
            else
               msgbox("Отсутствует сообщение");
            end;
         else
            msgbox("Файл не создан");
         end;
      end;

      return true;
   end; /* m_evnt_on_key_pressed() */


   /* Заполнение списка выбора ComboBox usr_log_id */
   private macro m_fill_usr_log_cb()
      var v_aux_cntr = 0;

      while(v_evnt_prm.v_usr_log_id_list.size > v_aux_cntr)
         v_evnt_usr_log_id_fld.addChoice(v_aux_cntr, v_evnt_prm.v_usr_log_id_list.value(v_aux_cntr));
         v_aux_cntr = v_aux_cntr + 1;
      end;
   end; /* macro m_fill_usr_log_cb() */


   /* Заполнение списка выбора ComboBox queue_log_id */
   private macro m_fill_queue_log_cb()
      var v_aux_cntr = 0;

      while(v_evnt_prm.v_queue_log_id_list.size > v_aux_cntr)
         v_evnt_queue_log_id_fld.addChoice(v_aux_cntr, v_evnt_prm.v_queue_log_id_list.value(v_aux_cntr));
         v_aux_cntr = v_aux_cntr + 1;
      end;
   end; /* macro m_fill_queue_log_cb() */


   /* Обновление значений интерфейса, связанных с usr_log_id */
   macro m_upd_usr_log_val()
      v_log_req_date_fld.value = v_evnt_prm.v_log_req_date;
      v_log_req_time_fld.value = v_evnt_prm.v_log_req_time;
      v_log_reqid_fld.value = v_evnt_prm.v_log_reqid_req;

      v_log_resp_id_fld.value = v_evnt_prm.v_log_id_resp;
      v_log_resp_date_fld.value = v_evnt_prm.v_log_resp_date;
      v_log_resp_time_fld.value = v_evnt_prm.v_log_resp_time;
      v_log_resp_reqid_fld.value = v_evnt_prm.v_log_reqid_resp;
      v_usr_log_resp_err_code_fld.value = v_evnt_prm.v_log_err_code_resp;
      v_usr_log_resp_err_msg_fld.value = v_evnt_prm.v_log_err_msg_resp;
   end; /* macro m_upd_usr_log_val() */


   /* Обновление значений интерфейса, связанных с queue_log_id */
   macro m_upd_queue_log_val()
      v_log_resp_id_fld.value = v_evnt_prm.v_log_id_resp;
      v_log_resp_date_fld.value = v_evnt_prm.v_log_resp_date;
      v_log_resp_time_fld.value = v_evnt_prm.v_log_resp_time;
      v_log_resp_reqid_fld.value = v_evnt_prm.v_log_reqid_resp;
      v_usr_log_resp_err_code_fld.value = v_evnt_prm.v_log_err_code_resp;
      v_usr_log_resp_err_msg_fld.value = v_evnt_prm.v_log_err_msg_resp;
   end; /* macro m_upd_queue_log_val() */


   /* Обработка выбора значения в ComboBox usr_log_id */
   macro m_evnt_usr_log_cb_select(p_rsb_evnt)
//      v_evnt_usr_log_id_fld.value = v_evnt_prm.v_evnt_usr_log_id;
      v_evnt_usr_log_id_fld.value = p_rsb_evnt.source.value;
      v_evnt_prm.v_evnt_usr_log_id = p_rsb_evnt.source.value;
      /* Каким-то образом изменение значения в одном ComboBox может влиять на привязанную переменную другого */
      v_evnt_prm.v_evnt_queue_log_id = v_evnt_queue_log_id_fld.value;

      if(v_evnt_prm.v_evnt_usr_log_id != 0)
         v_evnt_prm.m_find_log_data();
      else
         v_evnt_prm.m_set_null_log_data(1);
      end;

      m_upd_usr_log_val();
      /* Если используется TRsbEditField, то необходимо обновить его значение */
      if(not IsEqClass("TRsbComboBox", v_evnt_queue_log_id_fld))
         v_evnt_queue_log_id_fld.value = v_evnt_prm.v_evnt_queue_log_id;
      end;
      m_upd_queue_log_val();
   end; /* macro m_evnt_usr_log_cb_select(p_rsb_evnt) */


   /* Обработка выбора значения в ComboBox queue_log_id */
   macro m_evnt_queue_log_cb_select(p_rsb_evnt)
      v_evnt_queue_log_id_fld.value = p_rsb_evnt.source.value;
      v_evnt_prm.v_evnt_queue_log_id = p_rsb_evnt.source.value;
      /* Каким-то образом изменение значения в одном ComboBox может влиять на привязанную переменную другого */
      v_evnt_prm.v_evnt_usr_log_id = v_evnt_usr_log_id_fld.value;

      if(v_evnt_prm.v_evnt_queue_log_id != 0)
         v_evnt_prm.m_find_log_data();
      else
         v_evnt_prm.m_set_null_log_data(2);
      end;

      m_upd_queue_log_val();
   end; /* macro m_evnt_queue_log_cb_select() */


   private macro m_init_evnt_prm_form(i_this_obj, i_recid, i_objecttype, i_objectid)
      Caption = "Параметры события";
      Status = "[Esc] Выход  [F3] Список  [F5] Получить сообщение";
      v_evnt_prm = c_evnt_prm(i_recid, i_objecttype, i_objectid);

      /* ID события */
      AddLabel(TRsbLabel(CV_POS_X, CV_POS_Y, "ID события"));
      v_evnt_recid_fld = TRsbEditField(FT_INT);
      v_evnt_recid_fld.bindValue(v_evnt_prm, "v_evnt_recid", 25);
      v_evnt_recid_fld.setPosition(CV_POS_X, (CV_POS_Y + 1));
      v_evnt_recid_fld.setSize(11, 1);
      v_evnt_recid_fld.focusable = true;
      v_evnt_recid_fld.enabled = true;
      v_evnt_recid_fld.editable = false;
      AddControl(v_evnt_recid_fld);

      /* Наименование объекта события */
      AddLabel(TRsbLabel((CV_POS_X + 13), CV_POS_Y, "Объект события"));
      v_evnt_objtype_fld = TRsbEditField(FT_STRING);
      v_evnt_objtype_fld.bindValue(v_evnt_prm, "v_evnt_objtype", 25);
      v_evnt_objtype_fld.setPosition((CV_POS_X + 13), (CV_POS_Y + 1));
      v_evnt_objtype_fld.setSize(11, 1);
      v_evnt_objtype_fld.focusable = true;
      v_evnt_objtype_fld.enabled = true;
      v_evnt_objtype_fld.editable = false;
      AddControl(v_evnt_objtype_fld);

      /* ID объекта события */
      AddLabel(TRsbLabel((CV_POS_X + 26), CV_POS_Y, "ID объекта"));
      v_evnt_objtype_fld = TRsbEditField(FT_INT);
      v_evnt_objtype_fld.bindValue(v_evnt_prm, "v_evnt_objid", 25);
      v_evnt_objtype_fld.setPosition((CV_POS_X + 26), (CV_POS_Y + 1));
      v_evnt_objtype_fld.setSize(11, 1);
      v_evnt_objtype_fld.focusable = true;
      v_evnt_objtype_fld.enabled = true;
      v_evnt_objtype_fld.editable = false;
      AddControl(v_evnt_objtype_fld);

      /* ID лога */
      AddLabel(TRsbLabel(CV_POS_X, (CV_POS_Y + 3), "ID запроса"));
      v_evnt_usr_log_id_fld = TRsbComboBox();
//      v_evnt_usr_log_id_fld.dataType = FT_INT;
      m_fill_usr_log_cb();
      v_evnt_usr_log_id_fld.bindValue(v_evnt_prm, "v_evnt_usr_log_id");
      v_evnt_usr_log_id_fld.value = v_evnt_prm.v_evnt_usr_log_id;
      v_evnt_usr_log_id_fld.setPosition(CV_POS_X, (CV_POS_Y + 4));
      v_evnt_usr_log_id_fld.setSize(11, 1);

      v_evnt_usr_log_id_fld.OnItemSelected(R2M(i_this_obj, "m_evnt_usr_log_cb_select"));
      AddControl(v_evnt_usr_log_id_fld);

      /* Дата запроса */
      AddLabel(TRsbLabel((CV_POS_X +13), (CV_POS_Y + 3), "Дата запроса"));
      v_log_req_date_fld = TRsbEditField(FT_DATE);
      v_log_req_date_fld.bindValue(v_evnt_prm, "v_log_req_date", 25);
      v_log_req_date_fld.setPosition((CV_POS_X + 13), (CV_POS_Y + 4));
      v_log_req_date_fld.setSize(11, 1);
      v_log_req_date_fld.focusable = true;
      v_log_req_date_fld.enabled = true;
      v_log_req_date_fld.editable = false;
      AddControl(v_log_req_date_fld);

      /* Время запроса */
      AddLabel(TRsbLabel((CV_POS_X +26), (CV_POS_Y + 3), "Время запроса"));
      v_log_req_time_fld = TRsbEditField(FT_TIME);
      v_log_req_time_fld.bindValue(v_evnt_prm, "v_log_req_time", 25);
      v_log_req_time_fld.setPosition((CV_POS_X + 26), (CV_POS_Y + 4));
      v_log_req_time_fld.setSize(11, 1);
      v_log_req_time_fld.focusable = true;
      v_log_req_time_fld.enabled = true;
      v_log_req_time_fld.editable = false;
      AddControl(v_log_req_time_fld);

      /* Связанный dxr_log_dbt.t_reqid */
      AddLabel(TRsbLabel(CV_POS_X, (CV_POS_Y + 5), "REQID запроса"));
      v_log_reqid_fld = TRsbEditField(FT_STRING);
      v_log_reqid_fld.bindValue(v_evnt_prm, "v_log_reqid_req", 256);
      v_log_reqid_fld.setPosition(CV_POS_X, (CV_POS_Y + 6));
      v_log_reqid_fld.setSize(37, 1);
      v_log_reqid_fld.focusable = true;
      v_log_reqid_fld.enabled = true;
      v_log_reqid_fld.editable = false;
      AddControl(v_log_reqid_fld);

      /* ID dqueue_log_dbt */
      AddLabel(TRsbLabel(CV_POS_X, (CV_POS_Y + 8), "ID лога очереди"));
      if(v_evnt_prm.v_is_old_log)
         v_evnt_queue_log_id_fld = TRsbComboBox();
         m_fill_queue_log_cb();
         v_evnt_queue_log_id_fld.bindValue(v_evnt_prm, "v_evnt_queue_log_id");
         v_evnt_queue_log_id_fld.value = v_evnt_prm.v_evnt_queue_log_id;
         v_evnt_queue_log_id_fld.setPosition(CV_POS_X, (CV_POS_Y + 9));
         v_evnt_queue_log_id_fld.setSize(11, 1);

         v_evnt_queue_log_id_fld.OnItemSelected(R2M(i_this_obj, "m_evnt_queue_log_cb_select"));
         AddControl(v_evnt_queue_log_id_fld);
      else
         v_evnt_queue_log_id_fld = TRsbEditField(FT_INT);
         v_evnt_queue_log_id_fld.bindValue(v_evnt_prm, "v_evnt_queue_log_id", 25);
         v_evnt_queue_log_id_fld.setPosition(CV_POS_X, (CV_POS_Y + 9));
         v_evnt_queue_log_id_fld.setSize(11, 1);
         v_evnt_queue_log_id_fld.focusable = true;
         v_evnt_queue_log_id_fld.enabled = true;
         v_evnt_queue_log_id_fld.editable = false;
         AddControl(v_evnt_queue_log_id_fld);
      end;

      /* ID сообщения ответа */
      AddLabel(TRsbLabel(CV_POS_X, (CV_POS_Y + 11), "ID ответа"));
      v_log_resp_id_fld = TRsbEditField(FT_INT);
      v_log_resp_id_fld.bindValue(v_evnt_prm, "v_log_id_resp", 25);
      v_log_resp_id_fld.setPosition(CV_POS_X, (CV_POS_Y + 12));
      v_log_resp_id_fld.setSize(11, 1);
      v_log_resp_id_fld.focusable = true;
      v_log_resp_id_fld.enabled = true;
      v_log_resp_id_fld.editable = false;
      AddControl(v_log_resp_id_fld);

      /* Дата ответа */
      AddLabel(TRsbLabel((CV_POS_X +13), (CV_POS_Y + 11), "Дата ответа"));
      v_log_resp_date_fld = TRsbEditField(FT_DATE);
      v_log_resp_date_fld.bindValue(v_evnt_prm, "v_log_resp_date", 25);
      v_log_resp_date_fld.setPosition((CV_POS_X + 13), (CV_POS_Y + 12));
      v_log_resp_date_fld.setSize(11, 1);
      v_log_resp_date_fld.focusable = true;
      v_log_resp_date_fld.enabled = true;
      v_log_resp_date_fld.editable = false;
      AddControl(v_log_resp_date_fld);

      /* Время ответа */
      AddLabel(TRsbLabel((CV_POS_X +26), (CV_POS_Y + 11), "Время ответа"));
      v_log_resp_time_fld = TRsbEditField(FT_TIME);
      v_log_resp_time_fld.bindValue(v_evnt_prm, "v_log_resp_time", 25);
      v_log_resp_time_fld.setPosition((CV_POS_X + 26), (CV_POS_Y + 12));
      v_log_resp_time_fld.setSize(11, 1);
      v_log_resp_time_fld.focusable = true;
      v_log_resp_time_fld.enabled = true;
      v_log_resp_time_fld.editable = false;
      AddControl(v_log_resp_time_fld);

      /* Связанный dxr_log_dbt.t_reqid ответного сообщения */
      AddLabel(TRsbLabel(CV_POS_X, (CV_POS_Y + 13), "REQID ответа"));
      v_log_resp_reqid_fld = TRsbEditField(FT_STRING);
      v_log_resp_reqid_fld.bindValue(v_evnt_prm, "v_log_reqid_resp", 256);
      v_log_resp_reqid_fld.setPosition(CV_POS_X, (CV_POS_Y + 14));
      v_log_resp_reqid_fld.setSize(37, 1);
      v_log_resp_reqid_fld.focusable = true;
      v_log_resp_reqid_fld.enabled = true;
      v_log_resp_reqid_fld.editable = false;
      AddControl(v_log_resp_reqid_fld);

      /* Код ошибки */
      AddLabel(TRsbLabel(CV_POS_X, (CV_POS_Y + 15), "Код ошибки"));
      v_usr_log_resp_err_code_fld = TRsbEditField(FT_STRING);
      v_usr_log_resp_err_code_fld.bindValue(v_evnt_prm, "v_log_err_code_resp", 25);
      v_usr_log_resp_err_code_fld.setPosition(CV_POS_X, (CV_POS_Y + 16));
      v_usr_log_resp_err_code_fld.setSize(6, 1);
      v_usr_log_resp_err_code_fld.focusable = true;
      v_usr_log_resp_err_code_fld.enabled = true;
      v_usr_log_resp_err_code_fld.editable = false;
      AddControl(v_usr_log_resp_err_code_fld);

      /* Текст ошибки */
      AddLabel(TRsbLabel((CV_POS_X + 8), (CV_POS_Y + 15), "Текст ошибки"));
      v_usr_log_resp_err_msg_fld = TRsbEditField(FT_STRING);
      v_usr_log_resp_err_msg_fld.bindValue(v_evnt_prm, "v_log_err_msg_resp", 2000);
      v_usr_log_resp_err_msg_fld.setPosition((CV_POS_X + 8), (CV_POS_Y + 16));
      v_usr_log_resp_err_msg_fld.setSize(29, 3);
      v_usr_log_resp_err_msg_fld.focusable = true;
      v_usr_log_resp_err_msg_fld.enabled = true;
      v_usr_log_resp_err_msg_fld.editable = false;
      AddControl(v_usr_log_resp_err_msg_fld);

      AddEventHandler(RSB_EV_KEY_PRESSED, R2M(i_this_obj, "m_evnt_on_key_pressed"));

      setSize(42, 21);
      setPosition(20, 5);
   end; /* macro m_init_evnt_prm_form() */


   InitTRsbPanel();

   m_init_evnt_prm_form(this, p_recid, p_objecttype, p_objectid);
end; /* class (TRsbPanel) c_evnt_prm_form() */


/**
@brief Класс формы поиска платежей
*/
class (TRsbPanel) c_paym_search_form()
   const CV_POS_X = 5;
   const CV_POS_Y = 2;
   var v_paym_id_fld;

   var v_paym_date_fld;

   var v_paym_null_btn;


   macro m_evnt_on_key_pressed(p_rsb_evnt)
      if(p_rsb_evnt.KeyCode == K_F2)
         close(CV_CLOSE_FORM_OK);
      end;

      return true;
   end;


   macro m_evnt_null_paym_btn(p_rsb_evnt)
      if(p_rsb_evnt.id == RSB_EV_BUTTON_CLICKED)
         gv_evnt_sel_prm.v_paym_id = 0;
         v_paym_id_fld.value = 0;
         gv_evnt_sel_prm.v_paym_date = date("00.00.0000");
         v_paym_date_fld.value = date("00.00.0000");
      end;

      return true;
   end;


   private macro m_init_acc_search_form(i_this_obj)
      Caption = "Фильтр по платежам";
      Status = "[Esc] Выход  [F2] Применить";

      /* ID проводки */
      AddLabel(TRsbLabel(CV_POS_X, CV_POS_Y, "ID платежа"));
      v_paym_id_fld  = TRsbEditField(FT_INT);
      v_paym_id_fld.bindValue(gv_evnt_sel_prm, "v_paym_id", 25);
      v_paym_id_fld.setPosition(CV_POS_X, (CV_POS_Y + 1));
      v_paym_id_fld.setSize(10, 1);
      AddControl(v_paym_id_fld);

      /* Дата проводки */
      AddLabel(TRsbLabel(CV_POS_X, (CV_POS_Y + 3), "Дата создания платежа"));
      v_paym_date_fld = TRsbEditField(FT_DATE);
      v_paym_date_fld.bindValue(gv_evnt_sel_prm, "v_paym_date", 10);
      v_paym_date_fld.setPosition(CV_POS_X, (CV_POS_Y + 4));
      v_paym_date_fld.setSize(10, 1);
      AddControl(v_paym_date_fld);

      /* Кнопка сброса фильтра по проводкам */
      v_paym_null_btn = TRsbPushButton("Сброс");
      v_paym_null_btn.setPosition((CV_POS_X + 31), (CV_POS_Y + 10));
      v_paym_null_btn.setSize(6, 1);

      v_paym_null_btn.onClicked(R2M(i_this_obj, "m_evnt_null_paym_btn"));
      AddControl(v_paym_null_btn);

      AddEventHandler(RSB_EV_KEY_PRESSED, R2M(i_this_obj, "m_evnt_on_key_pressed"));

      setSize(45, 7);
      setPosition(20, 5);
   end;

   InitTRsbPanel();

   m_init_acc_search_form(this);
end; /* class (TRsbPanel) c_paym_search_form() */


/**
@brief Класс формы поиска проводок
*/
class (TRsbPanel) c_acctrn_search_form()
   const CV_POS_X = 5;
   const CV_POS_Y = 2;
   var v_acctrn_id_fld;

   var v_acctrn_date_fld;

   var v_acctrn_null_btn;


   macro m_evnt_on_key_pressed(p_rsb_evnt)
      if(p_rsb_evnt.KeyCode == K_F2)
         close(CV_CLOSE_FORM_OK);
      end;

      return true;
   end;


   macro m_evnt_null_acc_btn(p_rsb_evnt)
      if(p_rsb_evnt.id == RSB_EV_BUTTON_CLICKED)
         gv_evnt_sel_prm.v_acctrn_id = 0;
         v_acctrn_id_fld.value = 0;
         gv_evnt_sel_prm.v_acctrn_date = date("00.00.0000");
         v_acctrn_date_fld.value = date("00.00.0000");
      end;

      return true;
   end;


   private macro m_init_acc_search_form(i_this_obj)
      Caption = "Фильтр по проводкам";
      Status = "[Esc] Выход  [F2] Применить";

      /* ID проводки */
      AddLabel(TRsbLabel(CV_POS_X, CV_POS_Y, "ID проводки"));
      v_acctrn_id_fld  = TRsbEditField(FT_INT);
      v_acctrn_id_fld.bindValue(gv_evnt_sel_prm, "v_acctrn_id", 25);
      v_acctrn_id_fld.setPosition(CV_POS_X, (CV_POS_Y + 1));
      v_acctrn_id_fld.setSize(10, 1);
      AddControl(v_acctrn_id_fld);

      /* Дата проводки */
      AddLabel(TRsbLabel(CV_POS_X, (CV_POS_Y + 3), "Дата проводки"));
      v_acctrn_date_fld = TRsbEditField(FT_DATE);
      v_acctrn_date_fld.bindValue(gv_evnt_sel_prm, "v_acctrn_date", 10);
      v_acctrn_date_fld.setPosition(CV_POS_X, (CV_POS_Y + 4));
      v_acctrn_date_fld.setSize(10, 1);
      AddControl(v_acctrn_date_fld);

      /* Кнопка сброса фильтра по проводкам */
      v_acctrn_null_btn = TRsbPushButton("Сброс");
      v_acctrn_null_btn.setPosition((CV_POS_X + 31), (CV_POS_Y + 10));
      v_acctrn_null_btn.setSize(6, 1);

      v_acctrn_null_btn.onClicked(R2M(i_this_obj, "m_evnt_null_acc_btn"));
      AddControl(v_acctrn_null_btn);

      AddEventHandler(RSB_EV_KEY_PRESSED, R2M(i_this_obj, "m_evnt_on_key_pressed"));

      setSize(45, 7);
      setPosition(20, 5);
   end;

   InitTRsbPanel();

   m_init_acc_search_form(this);
end; /* class (TRsbPanel) c_acctrn_search_form() */


/**
@brief Класс формы поиска счетов
*/
class (TRsbPanel) c_acc_search_form()
   const CV_POS_X = 5;
   const CV_POS_Y = 2;
   var v_acc_id_fld;
   var v_acc_num_fld;

   var v_acc_date_open_fld;
   var v_acc_date_close_fld;

   var v_acc_null_btn;


   macro m_evnt_on_key_pressed(p_rsb_evnt)
      if(p_rsb_evnt.KeyCode == K_F2)
         close(CV_CLOSE_FORM_OK);
      end;

      return true;
   end;


   macro m_evnt_null_acc_btn(p_rsb_evnt)
      if(p_rsb_evnt.id == RSB_EV_BUTTON_CLICKED)
         gv_evnt_sel_prm.v_acc_id = 0;
         v_acc_id_fld.value = 0;
         gv_evnt_sel_prm.v_acc_num = "";
         v_acc_num_fld.value = "";

         gv_evnt_sel_prm.v_acc_date_open = date("00.00.0000");
         v_acc_date_open_fld.value = date("00.00.0000");
         gv_evnt_sel_prm.v_acc_date_close = date("00.00.0000");
         v_acc_date_close_fld.value = date("00.00.0000");
      end;

      return true;
   end;


   private macro m_init_acc_search_form(i_this_obj)
      Caption = "Фильтр по счетам";
      Status = "[Esc] Выход  [F2] Применить";

      /* ID счета */
      AddLabel(TRsbLabel(CV_POS_X, CV_POS_Y, "ID счета"));
      v_acc_id_fld  = TRsbEditField(FT_INT);
      v_acc_id_fld.bindValue(gv_evnt_sel_prm, "v_acc_id", 25);
      v_acc_id_fld.setPosition(CV_POS_X, (CV_POS_Y + 1));
      v_acc_id_fld.setSize(10, 1);
      AddControl(v_acc_id_fld);

      /* Номер счета */
      AddLabel(TRsbLabel((CV_POS_X + 12), CV_POS_Y, "Номер счета"));
      v_acc_num_fld = TRsbEditField(FT_STRING);
      v_acc_num_fld.bindValue(gv_evnt_sel_prm, "v_acc_num", 25);
      v_acc_num_fld.setPosition((CV_POS_X + 12), (CV_POS_Y + 1));
      v_acc_num_fld.setSize(25, 1);
      AddControl(v_acc_num_fld);

      /* Дата открытия */
      AddLabel(TRsbLabel(CV_POS_X, (CV_POS_Y + 3), "Дата открытия"));
      v_acc_date_open_fld = TRsbEditField(FT_DATE);
      v_acc_date_open_fld.bindValue(gv_evnt_sel_prm, "v_acc_date_open", 10);
      v_acc_date_open_fld.setPosition(CV_POS_X, (CV_POS_Y + 4));
      v_acc_date_open_fld.setSize(10, 1);
      AddControl(v_acc_date_open_fld);

      /* Дата закрытия */
      AddLabel(TRsbLabel((CV_POS_X + 12), (CV_POS_Y + 3), "Дата закрытия"));
      v_acc_date_close_fld = TRsbEditField(FT_DATE);
      v_acc_date_close_fld.bindValue(gv_evnt_sel_prm, "v_acc_date_close", 10);
      v_acc_date_close_fld.setPosition((CV_POS_X + 12), (CV_POS_Y + 4));
      v_acc_date_close_fld.setSize(10, 1);
      AddControl(v_acc_date_close_fld);

      /* Кнопка сброса фильтра по счетам */
      v_acc_null_btn = TRsbPushButton("Сброс");
      v_acc_null_btn.setPosition((CV_POS_X + 31), (CV_POS_Y + 10));
      v_acc_null_btn.setSize(6, 1);

      v_acc_null_btn.onClicked(R2M(i_this_obj, "m_evnt_null_acc_btn"));
      AddControl(v_acc_null_btn);

      AddEventHandler(RSB_EV_KEY_PRESSED, R2M(i_this_obj, "m_evnt_on_key_pressed"));

      setSize(45, 7);
      setPosition(20, 5);
   end;

   InitTRsbPanel();

   m_init_acc_search_form(this);
end; /* class (TRsbPanel) c_acc_search_form() */


/**
@brief Класс формы общих поисковых параметров
*/
class (TRsbPanel) c_com_search_form()
   const CV_POS_X = 5;
   const CV_POS_Y = 2;
   var v_com_date_fld;
   var v_com_beg_date_fld;
   var v_com_end_date_fld;
   var v_com_date_switch_fld;

   var v_com_status_1_fld;
   var v_com_status_2_fld;
   var v_com_status_4_fld;
   var v_com_status_5_fld;
   var v_com_status_inv_fld;
   var v_com_null_btn;


   macro m_evnt_on_key_pressed(p_rsb_evnt)
      if(p_rsb_evnt.KeyCode == K_F2)
         close(CV_CLOSE_FORM_OK);
      elif(p_rsb_evnt.KeyCode == K_ESCAPE)
         if(not gettrue(true, "Выйти из панели?\nБудет применен выбранный фильтр."))
            p_rsb_evnt.keyCode = K_F2;
         else
            close(CV_CLOSE_FORM_OK);
         end;
      end;

      return true;
   end;


   macro m_on_switch_date(p_rsb_evnt)
      if(p_rsb_evnt.id == RSB_EV_CONTROL_CHECKED)
         gv_evnt_sel_prm.v_com_date_switch = v_com_date_switch_fld.checked;
      end;

      if(gv_evnt_sel_prm.v_com_date_switch)
         v_com_date_fld.focusable = false;
         v_com_date_fld.enabled = false;
         v_com_date_fld.editable = false;

         v_com_beg_date_fld.focusable = true;
         v_com_beg_date_fld.enabled = true;
         v_com_beg_date_fld.editable = true;

         v_com_end_date_fld.focusable = true;
         v_com_end_date_fld.enabled = true;
         v_com_end_date_fld.editable = true;
      else
         v_com_date_fld.focusable = true;
         v_com_date_fld.enabled = true;
         v_com_date_fld.editable = true;

         v_com_beg_date_fld.focusable = false;
         v_com_beg_date_fld.enabled = false;
         v_com_beg_date_fld.editable = false;

         v_com_end_date_fld.focusable = false;
         v_com_end_date_fld.enabled = false;
         v_com_end_date_fld.editable = false;
      end;

      redraw();

      return true;
   end;


   macro m_on_checked_stat_1(p_rsb_evnt)
      if(p_rsb_evnt.id == RSB_EV_CONTROL_CHECKED)
         gv_evnt_sel_prm.v_com_status_1 = v_com_status_1_fld.checked;
      end;

      return true;
   end;


   macro m_on_checked_stat_2(p_rsb_evnt)
      if(p_rsb_evnt.id == RSB_EV_CONTROL_CHECKED)
         gv_evnt_sel_prm.v_com_status_2 = v_com_status_2_fld.checked;
      end;

      return true;
   end;


   macro m_on_checked_stat_4(p_rsb_evnt)
      if(p_rsb_evnt.id == RSB_EV_CONTROL_CHECKED)
         gv_evnt_sel_prm.v_com_status_4 = v_com_status_4_fld.checked;
      end;

      return true;
   end;


   macro m_on_checked_stat_5(p_rsb_evnt)
      if(p_rsb_evnt.id == RSB_EV_CONTROL_CHECKED)
         gv_evnt_sel_prm.v_com_status_5 = v_com_status_5_fld.checked;
      end;

      return true;
   end;


   macro m_on_checked_stat_inv(p_rsb_evnt)
      if(p_rsb_evnt.id == RSB_EV_CONTROL_CHECKED)
         gv_evnt_sel_prm.v_com_status_inv = v_com_status_inv_fld.checked;
      end;

      return true;
   end;


   macro m_evnt_null_com_btn(p_rsb_evnt)
      if(p_rsb_evnt.id == RSB_EV_BUTTON_CLICKED)
         gv_evnt_sel_prm.v_com_date = date("00.00.0000");
         v_com_date_fld.value = date("00.00.0000");

         gv_evnt_sel_prm.v_com_beg_date = date("00.00.0000");
         v_com_beg_date_fld.value = date("00.00.0000");

         gv_evnt_sel_prm.v_com_end_date = date("00.00.0000");
         v_com_end_date_fld.value = date("00.00.0000");

         v_com_date_fld.focusable = true;
         v_com_date_fld.enabled = true;
         v_com_date_fld.editable = true;

         v_com_beg_date_fld.focusable = false;
         v_com_beg_date_fld.enabled = false;
         v_com_beg_date_fld.editable = false;

         v_com_end_date_fld.focusable = false;
         v_com_end_date_fld.enabled = false;
         v_com_end_date_fld.editable = false;

         v_com_date_switch_fld.checked = false;
         gv_evnt_sel_prm.v_com_date_switch = false;

         v_com_status_1_fld.checked = false;
         gv_evnt_sel_prm.v_com_status_1 = false;
         v_com_status_2_fld.checked = false;
         gv_evnt_sel_prm.v_com_status_2 = false;
         v_com_status_4_fld.checked = false;
         gv_evnt_sel_prm.v_com_status_4 = false;
         v_com_status_5_fld.checked = false;
         gv_evnt_sel_prm.v_com_status_5 = false;
         v_com_status_inv_fld.checked = false;
         gv_evnt_sel_prm.v_com_status_inv = false;

         redraw();
      end;

      return true;
   end;


   private macro m_init_com_search_form(i_this_obj)
      Caption = "Общие фильтры";
      Status = "[Esc] Выход  [F2] Применить";

      /* Фильтр по дате */
      AddLabel(TRsbLabel(CV_POS_X, CV_POS_Y, "Дата выборки"));
      v_com_date_fld = TRsbEditField(FT_DATE);
      v_com_date_fld.bindValue(gv_evnt_sel_prm, "v_com_date", 10);
      v_com_date_fld.setPosition(CV_POS_X, (CV_POS_Y + 1));
      v_com_date_fld.setSize(10, 1);
      if(gv_evnt_sel_prm.v_com_date_switch)
         v_com_date_fld.focusable = false;
         v_com_date_fld.enabled = false;
         v_com_date_fld.editable = false;
      else
         v_com_date_fld.focusable = true;
         v_com_date_fld.enabled = true;
         v_com_date_fld.editable = true;
      end;
      AddControl(v_com_date_fld);
      AddLabel(TRsbLabel((CV_POS_X + 27), CV_POS_Y, "Диапазон дат"));
      v_com_beg_date_fld = TRsbEditField(FT_DATE);
      v_com_beg_date_fld.bindValue(gv_evnt_sel_prm, "v_com_beg_date", 10);
      v_com_beg_date_fld.setPosition((CV_POS_X + 27), (CV_POS_Y + 1));
      v_com_beg_date_fld.setSize(10, 1);
      if(gv_evnt_sel_prm.v_com_date_switch)
         v_com_beg_date_fld.focusable = true;
         v_com_beg_date_fld.enabled = true;
         v_com_beg_date_fld.editable = true;
      else
         v_com_beg_date_fld.focusable = false;
         v_com_beg_date_fld.enabled = false;
         v_com_beg_date_fld.editable = false;
      end;
      AddControl(v_com_beg_date_fld);
      v_com_end_date_fld = TRsbEditField(FT_DATE);
      v_com_end_date_fld.bindValue(gv_evnt_sel_prm, "v_com_end_date", 10);
      v_com_end_date_fld.setPosition((CV_POS_X + 27), (CV_POS_Y + 2));
      v_com_end_date_fld.setSize(10, 1);
      if(gv_evnt_sel_prm.v_com_date_switch)
         v_com_end_date_fld.focusable = true;
         v_com_end_date_fld.enabled = true;
         v_com_end_date_fld.editable = true;
      else
         v_com_end_date_fld.focusable = false;
         v_com_end_date_fld.enabled = false;
         v_com_end_date_fld.editable = false;
      end;
      AddControl(v_com_end_date_fld);

      AddLabel(TRsbLabel((CV_POS_X + 14), CV_POS_Y, "Исп. диапазон"));
      v_com_date_switch_fld = TRsbCheckBox();
      v_com_date_switch_fld.setPosition((CV_POS_X + 18), (CV_POS_Y + 1));
      v_com_date_switch_fld.onChecked(R2M(i_this_obj, "m_on_switch_date"));
      v_com_date_switch_fld.checked = gv_evnt_sel_prm.v_com_date_switch;
      AddControl(v_com_date_switch_fld);

      /* Фильтр по статусам */
      AddLabel(TRsbLabel(CV_POS_X, (CV_POS_Y + 3), "Статус"));
      v_com_status_1_fld = TRsbCheckBox();
//      v_com_status_1_fld.bindValue(gv_evnt_sel_prm, "v_com_status_1");
      v_com_status_1_fld.setPosition(CV_POS_X, (CV_POS_Y + 4));
      v_com_status_1_fld.onChecked(R2M(i_this_obj, "m_on_checked_stat_1"));
      v_com_status_1_fld.checked = gv_evnt_sel_prm.v_com_status_1;
      AddControl(v_com_status_1_fld);
      AddLabel(TRsbLabel((CV_POS_X + 3), (CV_POS_Y + 4), "Ожидание обработки"));
      v_com_status_2_fld = TRsbCheckBox();
//      v_com_status_2_fld.bindValue(gv_evnt_sel_prm, "v_com_status_2");
      v_com_status_2_fld.setPosition(CV_POS_X, (CV_POS_Y + 5));
      v_com_status_2_fld.onChecked(R2M(i_this_obj, "m_on_checked_stat_2"));
      v_com_status_2_fld.checked = gv_evnt_sel_prm.v_com_status_2;
      AddControl(v_com_status_2_fld);
      AddLabel(TRsbLabel((CV_POS_X + 3), (CV_POS_Y + 5), "Обработка"));
      v_com_status_4_fld = TRsbCheckBox();
//      v_com_status_4_fld.bindValue(gv_evnt_sel_prm, "v_com_status_4");
      v_com_status_4_fld.setPosition(CV_POS_X, (CV_POS_Y + 6));
      v_com_status_4_fld.onChecked(R2M(i_this_obj, "m_on_checked_stat_4"));
      v_com_status_4_fld.checked = gv_evnt_sel_prm.v_com_status_4;
      AddControl(v_com_status_4_fld);
      AddLabel(TRsbLabel((CV_POS_X + 3), (CV_POS_Y + 6), "Успех"));
      v_com_status_5_fld = TRsbCheckBox();
//      v_com_status_5_fld.bindValue(gv_evnt_sel_prm, "v_com_status_5");
      v_com_status_5_fld.setPosition(CV_POS_X, (CV_POS_Y + 7));
      v_com_status_5_fld.onChecked(R2M(i_this_obj, "m_on_checked_stat_5"));
      v_com_status_5_fld.checked = gv_evnt_sel_prm.v_com_status_5;
      AddControl(v_com_status_5_fld);
      AddLabel(TRsbLabel((CV_POS_X + 3), (CV_POS_Y + 7), "Ошибка обработки"));
      AddLabel(TRsbLabel(CV_POS_X, (CV_POS_Y + 8), "Инвертировать фильтр по статусам"));
      v_com_status_inv_fld = TRsbCheckBox();
//      v_com_status_inv_fld.bindValue(gv_evnt_sel_prm, "v_com_status_inv");
      v_com_status_inv_fld.setPosition((CV_POS_X + 24), (CV_POS_Y + 8));
      v_com_status_inv_fld.onChecked(R2M(i_this_obj, "m_on_checked_stat_inv"));
      v_com_status_inv_fld.checked = gv_evnt_sel_prm.v_com_status_inv;
      AddControl(v_com_status_inv_fld);

      /* Кнопка сброса */
      v_com_null_btn = TRsbPushButton("Сброс");
      v_com_null_btn.setPosition((CV_POS_X + 31), (CV_POS_Y + 10));
      v_com_null_btn.setSize(6, 1);

      v_com_null_btn.onClicked(R2M(i_this_obj, "m_evnt_null_com_btn"));
      AddControl(v_com_null_btn);

      AddEventHandler(RSB_EV_KEY_PRESSED, R2M(i_this_obj, "m_evnt_on_key_pressed"));

      setSize(45, 14);
      setPosition(20, 5);

   end;

   InitTRsbPanel();

   m_init_com_search_form(this);
end; /* class (TRsbPanel) c_com_search_form() */


class (TRsbTabbedWindow) c_main_search_form()
/*
   const CV_POS_X = 5;
   const CV_POS_Y = 2;
*/

   private macro m_init_main_search_form(i_this_obj)
//      Status = "[Esc] Выход";
   end;

   InitTRsbTabbedWindow();

   m_init_main_search_form(this);
end;


/**
@brief Метод обработки событий скроллинга
*/
macro m_evnt_proc_scr(p_rs, p_cmd, p_id, p_key)
   var CM_FLAG = CM_DEFAULT;
   var gv_evnt_prm_form;
   var gv_com_search_form;
   var gv_acc_search_form;
   var gv_acctrn_search_form;
   var gv_paym_search_form;
   var gv_main_search_form;

   if(p_cmd == DLG_INIT)
      while((gv_scr_focus != 0) and p_rs.movenext())
         if(p_rs.value("T_RECID") == gv_scr_focus)
            gv_scr_focus = 0;
            GoToScroll(p_rs);
         end;
      end;

   elif(p_cmd == DLG_KEY)
      if(p_key == K_ENTER)
         CM_FLAG = CM_IGNORE;

         gv_evnt_prm_form = c_evnt_prm_form(p_rs.value("t_recid"),
                                            p_rs.value("t_objecttype"),
                                            p_rs.value("t_objectid"));
         gv_evnt_prm_form.run;

      elif(p_key == K_CTRL_R)
         gv_scr_focus = p_rs.value("t_recid");
         CM_FLAG = CM_SELECT;

      elif(p_key == K_CTRL_F2)
         gv_scr_focus = p_rs.value("t_recid");

         if(GetTrue(true, string("Текущий статус события: \"", p_rs.value("t_status"), "\"\nВы уверены, что хотите инициировать процесс выгрузки?")))
            CM_FLAG = CM_SELECT;

            if(not m_send_evnt_obj_init(p_rs.value("t_recid")))
               msgbox("Не удалось инициировать процесс выгрузки объекта по событию");
            end;

         else
            CM_FLAG = CM_IGNORE;
         end;

      elif(p_key == K_F5)
         CM_FLAG = CM_SELECT;

         gv_com_search_form = c_com_search_form();
         gv_acc_search_form = c_acc_search_form();
         gv_acctrn_search_form = c_acctrn_search_form();
         gv_paym_search_form = c_paym_search_form();
         gv_main_search_form = c_main_search_form();
         gv_main_search_form.addForm(gv_com_search_form);
         gv_main_search_form.addForm(gv_acc_search_form);
         gv_main_search_form.addForm(gv_acctrn_search_form);
         gv_main_search_form.addForm(gv_paym_search_form);
         gv_main_search_form.run;
//         gv_acc_search_form.run;

      elif(p_key == K_ESCAPE)
         if(not gettrue(true, "Выйти из списка событий?"))
            CM_FLAG = CM_IGNORE;
         end;
      end;

   end;

   return CM_FLAG;
end; /* macro m_evnt_proc_scr() */


/**
@brief Метод, запускающий основной скроллинг
*/
private macro m_run_main_scroll()
   var sql_scr, cmd_scr, rs_scr;
   var sql_main = "";
   var sql_filtr = "";
   var sql_order = "";
   var v_aux_cntr;
   var v_need_acc_filtr = false;
   var v_need_acc_filtr_aux = false;
   var v_need_acctrn_filtr = false;
   var v_need_acctrn_filtr_aux = false;
   var v_need_paym_filtr = false;
   var v_need_paym_filtr_aux = false;

   gv_evnt_sel_prm = c_evnt_selection_prm();

   sql_main =            "  SELECT t_recid, t_objecttype, ";
   sql_main = sql_main + "         TO_CHAR(t_timestamp, 'DD.MM.YYYY HH24:MI:SS') t_timestamp, ";
   sql_main = sql_main + "         DECODE(t_objecttype, 1, 'Проводка', ";
   sql_main = sql_main + "                              4, 'Счет', ";
   sql_main = sql_main + "                              501, 'Платеж', ";
   sql_main = sql_main + "                              9, 'Договор БО', ";
   sql_main = sql_main + "                              5017, 'Курсы валют и ДМ', TO_CHAR(t_objecttype)) t_objecttype_s, ";
   sql_main = sql_main + "         t_objectid, ";
   sql_main = sql_main + "         DECODE(t_type, 1, 'Создание', ";
   sql_main = sql_main + "                        2, 'Изменение', ";
   sql_main = sql_main + "                        3, 'Удаление',";
   sql_main = sql_main + "                        11, 'Обновление', t_type) t_type, ";
   sql_main = sql_main + "         DECODE(t_status, 1, 'Ожидание обработки', ";
   sql_main = sql_main + "                          2, 'Обработка', ";
   sql_main = sql_main + "                          4, 'Успех', ";
   sql_main = sql_main + "                          5, 'Ошибка обработки', TO_CHAR(t_status)) t_status, ";
   sql_main = sql_main + "         t_note, t_messageid, t_resultcode, t_resulttext ";
   sql_main = sql_main + "    FROM utableprocessevent_dbt tbl_evnt ";
   sql_main = sql_main + "   WHERE 1 = 1 ";
   if(gv_evnt_sel_prm.v_com_date != date("00.00.0000"))
      sql_filtr =        "     AND TRUNC(t_timestamp) = :p_evnt_on_date ";
   end;
   sql_order =           "ORDER BY tbl_evnt.t_recid DESC ";

   sql_scr = sql_main + sql_filtr + sql_order;

   cmd_scr = RSDCommand(sql_scr);
   cmd_scr.NullConversion = true;
   if(gv_evnt_sel_prm.v_com_date != date("00.00.0000"))
      cmd_scr.addParam("p_evnt_on_date", RSDBP_IN, gv_evnt_sel_prm.v_com_date);
   end;

   rs_scr = RSDRecordSet(cmd_scr, RSDVAL_CLIENT, RSDVAl_STATIC);
   rs_scr.NullConversion = true;

   m_add_column(gv_column_list_scr, gv_num_columns_scr, "T_RECID",        "ID события",       5); gv_num_columns_scr = gv_num_columns_scr + 1;
   m_add_column(gv_column_list_scr, gv_num_columns_scr, "T_TIMESTAMP",    "Время создания",   10); gv_num_columns_scr = gv_num_columns_scr + 1;
   m_add_column(gv_column_list_scr, gv_num_columns_scr, "T_OBJECTTYPE_S", "Тип объекта",      10); gv_num_columns_scr = gv_num_columns_scr + 1;
   m_add_column(gv_column_list_scr, gv_num_columns_scr, "T_OBJECTID",     "ID объекта",       5); gv_num_columns_scr = gv_num_columns_scr + 1;
   m_add_column(gv_column_list_scr, gv_num_columns_scr, "T_TYPE",         "Тип события",      15); gv_num_columns_scr = gv_num_columns_scr + 1;
   m_add_column(gv_column_list_scr, gv_num_columns_scr, "T_STATUS",       "Статус",           15); gv_num_columns_scr = gv_num_columns_scr + 1;
   m_add_column(gv_column_list_scr, gv_num_columns_scr, "T_NOTE",         "Примечание",       15); gv_num_columns_scr = gv_num_columns_scr + 1;
   m_add_column(gv_column_list_scr, gv_num_columns_scr, "T_MESSAGEID",    "ID сообщения",     5); gv_num_columns_scr = gv_num_columns_scr + 1;
   m_add_column(gv_column_list_scr, gv_num_columns_scr, "T_RESULTCODE",   "Код результата",   5); gv_num_columns_scr = gv_num_columns_scr + 1;
   m_add_column(gv_column_list_scr, gv_num_columns_scr, "T_RESULTTEXT",   "Текст результата", 15); gv_num_columns_scr = gv_num_columns_scr + 1;

   while(RunScroll(rs_scr, gv_num_columns_scr, gv_column_list_scr, "event_list", "m_evnt_proc_scr", "Список событий", "ESC - выход  CTRL-F2 - выгрузить  F5 - фильтр  CTRL-R - обновить  ENTER - подробности", true, 5, NULL, NULL, 40))
      /* Обновляем скроллинг */
      cmd_scr.close(); cmd_scr = NULL;
      rs_scr.close(); rs_scr = NULL;

      /*----------------*/
      /* Фильтр по дате */
      /*----------------*/
      sql_filtr = "";
      if(gv_evnt_sel_prm.v_com_date_switch)
         if(gv_evnt_sel_prm.v_com_beg_date != date("00.00.0000"))
            sql_filtr = sql_filtr + " AND TRUNC(t_timestamp) >= :p_evnt_beg_date ";
         end;
         if(gv_evnt_sel_prm.v_com_end_date != date("00.00.0000"))
            sql_filtr = sql_filtr + " AND TRUNC(t_timestamp) <= :p_evnt_end_date ";
         end;
      else
         if(gv_evnt_sel_prm.v_com_date != date("00.00.0000"))
            sql_filtr = sql_filtr + " AND TRUNC(t_timestamp) = :p_evnt_on_date ";
         end;
      end;

      /*--------------------*/
      /* Фильтр по статусам */
      /*--------------------*/
      v_aux_cntr = 0;
      if(gv_evnt_sel_prm.v_com_status_inv)
         if(gv_evnt_sel_prm.v_com_status_1
            or gv_evnt_sel_prm.v_com_status_2
            or gv_evnt_sel_prm.v_com_status_4
            or gv_evnt_sel_prm.v_com_status_5)

            sql_filtr = sql_filtr + " AND t_status NOT IN (";
            if(gv_evnt_sel_prm.v_com_status_1)
               v_aux_cntr = v_aux_cntr + 1;
               if(v_aux_cntr > 1)
                  sql_filtr = sql_filtr + ",";
               end;
               sql_filtr = sql_filtr + string(":", CV_PRM_STAT_NAME, v_aux_cntr);
            end;
            if(gv_evnt_sel_prm.v_com_status_2)
               v_aux_cntr = v_aux_cntr + 1;
               if(v_aux_cntr > 1)
                  sql_filtr = sql_filtr + ",";
               end;
               sql_filtr = sql_filtr + string(":", CV_PRM_STAT_NAME, v_aux_cntr);
            end;
            if(gv_evnt_sel_prm.v_com_status_4)
               v_aux_cntr = v_aux_cntr + 1;
               if(v_aux_cntr > 1)
                  sql_filtr = sql_filtr + ",";
               end;
               sql_filtr = sql_filtr + string(":", CV_PRM_STAT_NAME, v_aux_cntr);
            end;
            if(gv_evnt_sel_prm.v_com_status_5)
               v_aux_cntr = v_aux_cntr + 1;
               if(v_aux_cntr > 1)
                  sql_filtr = sql_filtr + ",";
               end;
               sql_filtr = sql_filtr + string(":", CV_PRM_STAT_NAME, v_aux_cntr);
            end;
            sql_filtr = sql_filtr + ") ";
         end;
      else
         if(gv_evnt_sel_prm.v_com_status_1
            or gv_evnt_sel_prm.v_com_status_2
            or gv_evnt_sel_prm.v_com_status_4
            or gv_evnt_sel_prm.v_com_status_5)

            sql_filtr = sql_filtr + " AND t_status IN (";
            if(gv_evnt_sel_prm.v_com_status_1)
               v_aux_cntr = v_aux_cntr + 1;
               if(v_aux_cntr > 1)
                  sql_filtr = sql_filtr + ",";
               end;
               sql_filtr = sql_filtr + string(":", CV_PRM_STAT_NAME, v_aux_cntr);
            end;
            if(gv_evnt_sel_prm.v_com_status_2)
               v_aux_cntr = v_aux_cntr + 1;
               if(v_aux_cntr > 1)
                  sql_filtr = sql_filtr + ",";
               end;
               sql_filtr = sql_filtr + string(":", CV_PRM_STAT_NAME, v_aux_cntr);
            end;
            if(gv_evnt_sel_prm.v_com_status_4)
               v_aux_cntr = v_aux_cntr + 1;
               if(v_aux_cntr > 1)
                  sql_filtr = sql_filtr + ",";
               end;
               sql_filtr = sql_filtr + string(":", CV_PRM_STAT_NAME, v_aux_cntr);
            end;
            if(gv_evnt_sel_prm.v_com_status_5)
               v_aux_cntr = v_aux_cntr + 1;
               if(v_aux_cntr > 1)
                  sql_filtr = sql_filtr + ",";
               end;
               sql_filtr = sql_filtr + string(":", CV_PRM_STAT_NAME, v_aux_cntr);
            end;
            sql_filtr = sql_filtr + ") ";
         end;
      end;

      /*--------------------*/
      /* Фильтр по объектам */
      /*--------------------*/
      v_need_acc_filtr = gv_evnt_sel_prm.m_get_need_acc_filtr();
      v_need_acc_filtr_aux = gv_evnt_sel_prm.m_get_need_acc_filtr_aux();
      v_need_acctrn_filtr = gv_evnt_sel_prm.m_get_need_acctrn_filtr();
      v_need_acctrn_filtr_aux = gv_evnt_sel_prm.m_get_need_acctrn_filtr_aux();
      v_need_paym_filtr = gv_evnt_sel_prm.m_get_need_paym_filtr();
      v_need_paym_filtr_aux = gv_evnt_sel_prm.m_get_need_paym_filtr_aux();

      if(v_need_acc_filtr
         or v_need_acctrn_filtr
         or v_need_paym_filtr)

         sql_filtr = sql_filtr + " AND ( ";

         /*------------------*/
         /* Фильтр по счетам */
         /*------------------*/
         if(v_need_acc_filtr)
            sql_filtr = sql_filtr + " (t_objecttype = 4 AND t_objectid IN ( ";
            if(gv_evnt_sel_prm.v_acc_id != 0)
               sql_filtr = sql_filtr + "                                   :p_accountid ";
               if(v_need_acc_filtr_aux)
                  sql_filtr = sql_filtr + ", ";
               end;
            end;
            if(v_need_acc_filtr_aux)
               sql_filtr = sql_filtr + "                                   (SELECT t_accountid ";
               sql_filtr = sql_filtr + "                                      FROM daccount_dbt ";
               sql_filtr = sql_filtr + "                                     WHERE 1=1 ";
/*
               if(gv_evnt_sel_prm.v_acc_id != 0)
                  sql_filtr = sql_filtr + "                                    AND t_accountid = :p_accountid ";
               end;
*/
               if(gv_evnt_sel_prm.v_acc_num != "")
                  sql_filtr = sql_filtr + "                                    AND t_account = :p_account ";
               end;
               if(gv_evnt_sel_prm.v_acc_date_open != date("00.00.0000"))
                  sql_filtr = sql_filtr + "                                    AND t_open_date = :p_open_date ";
               end;
               if(gv_evnt_sel_prm.v_acc_date_close != date("00.00.0000"))
                  sql_filtr = sql_filtr + "                                    AND t_close_date = :p_close_date ";
               end;
               sql_filtr = sql_filtr + ") ";
            end;
            sql_filtr = sql_filtr + ")) ";
         end;

         /*---------------------*/
         /* Фильтр по проводкам */
         /*---------------------*/
         if(v_need_acctrn_filtr)
            if(v_need_acc_filtr)
               sql_filtr = sql_filtr + " OR ";
            end;

            sql_filtr = sql_filtr + " (t_objecttype = 1 AND t_objectid IN ( ";
            if(gv_evnt_sel_prm.v_acctrn_id != 0)
               sql_filtr = sql_filtr + "                                   :p_acctrnid ";
               if(v_need_acctrn_filtr_aux)
                  sql_filtr = sql_filtr + ", ";
               end;
            end;
            if(v_need_acctrn_filtr_aux)
               sql_filtr = sql_filtr + "                                   (SELECT t_acctrnid ";
               sql_filtr = sql_filtr + "                                      FROM dacctrn_dbt ";
               sql_filtr = sql_filtr + "                                     WHERE 1=1 ";
/*
               if(gv_evnt_sel_prm.v_acctrn_id != 0)
                  sql_filtr = sql_filtr + "                                    AND t_acctrnid = :p_acctrnid ";
               end;
*/
               if(gv_evnt_sel_prm.v_acctrn_date != date("00.00.0000"))
                  sql_filtr = sql_filtr + "                                    AND t_date_carry = :p_date_carry ";
               end;
               sql_filtr = sql_filtr + ") ";
            end;
            sql_filtr = sql_filtr + ")) ";
         end;

         /*--------------------*/
         /* Фильтр по платежам */
         /*--------------------*/
         if(v_need_paym_filtr)
            if(v_need_acc_filtr
               or v_need_acctrn_filtr)

               sql_filtr = sql_filtr + " OR ";
            end;

            sql_filtr = sql_filtr + " (t_objecttype = 501 AND t_objectid IN ( ";
            if(gv_evnt_sel_prm.v_paym_id != 0)
               sql_filtr = sql_filtr + "                                     :p_paymentid ";
               if(v_need_paym_filtr_aux)
                  sql_filtr = sql_filtr + ", ";
               end;
            end;
            if(v_need_paym_filtr_aux)
               sql_filtr = sql_filtr + "                                     (SELECT t_paymentid ";
               sql_filtr = sql_filtr + "                                        FROM dpmpaym_dbt ";
               sql_filtr = sql_filtr + "                                       WHERE 1=1 ";
/*
               if(gv_evnt_sel_prm.v_paym_id != 0)
                  sql_filtr = sql_filtr + "                                      AND t_paymentid = :p_paymentid ";
               end;
*/
               if(gv_evnt_sel_prm.v_paym_date != date("00.00.0000"))
                  sql_filtr = sql_filtr + "                                      AND t_creationdate = :p_creationdate ";
               end;
               sql_filtr = sql_filtr + ") ";
            end;
            sql_filtr = sql_filtr + ")) ";
         end;

         sql_filtr = sql_filtr + ") ";
      end;

      sql_scr = sql_main + sql_filtr + sql_order;

      /*-----------*/
      /* Параметры */
      /*-----------*/
      cmd_scr = RSDCommand(sql_scr);
      cmd_scr.NullConversion = true;
      if(gv_evnt_sel_prm.v_com_date_switch)
         if(gv_evnt_sel_prm.v_com_beg_date != date("00.00.0000"))
            cmd_scr.addParam("p_evnt_beg_date", RSDBP_IN, gv_evnt_sel_prm.v_com_beg_date)
         end;
         if(gv_evnt_sel_prm.v_com_end_date != date("00.00.0000"))
            cmd_scr.addParam("p_evnt_end_date", RSDBP_IN, gv_evnt_sel_prm.v_com_end_date);
         end;
      else
         if(gv_evnt_sel_prm.v_com_date != date("00.00.0000"))
            cmd_scr.addParam("p_evnt_on_date", RSDBP_IN, gv_evnt_sel_prm.v_com_date);
         end;
      end;

      v_aux_cntr = 0;
      if(gv_evnt_sel_prm.v_com_status_1)
         v_aux_cntr = v_aux_cntr + 1;
         cmd_scr.addParam(string(CV_PRM_STAT_NAME, v_aux_cntr), RSDBP_IN, CV_EVNT_STAT_1);
      end;
      if(gv_evnt_sel_prm.v_com_status_2)
         v_aux_cntr = v_aux_cntr + 1;
         cmd_scr.addParam(string(CV_PRM_STAT_NAME, v_aux_cntr), RSDBP_IN, CV_EVNT_STAT_2);
      end;
      if(gv_evnt_sel_prm.v_com_status_4)
         v_aux_cntr = v_aux_cntr + 1;
         cmd_scr.addParam(string(CV_PRM_STAT_NAME, v_aux_cntr), RSDBP_IN, CV_EVNT_STAT_4);
      end;
      if(gv_evnt_sel_prm.v_com_status_5)
         v_aux_cntr = v_aux_cntr + 1;
         cmd_scr.addParam(string(CV_PRM_STAT_NAME, v_aux_cntr), RSDBP_IN, CV_EVNT_STAT_5);
      end;

      if(gv_evnt_sel_prm.v_acc_id != 0)
         cmd_scr.addParam("p_accountid", RSDBP_IN, gv_evnt_sel_prm.v_acc_id);
      end;
      if(gv_evnt_sel_prm.v_acc_num != "")
         cmd_scr.addParam("p_account", RSDBP_IN, gv_evnt_sel_prm.v_acc_num);
      end;
      if(gv_evnt_sel_prm.v_acc_date_open != date("00.00.0000"))
         cmd_scr.addParam("p_open_date", RSDBP_IN, gv_evnt_sel_prm.v_acc_date_open);
      end;
      if(gv_evnt_sel_prm.v_acc_date_close != date("00.00.0000"))
         cmd_scr.addParam("p_close_date", RSDBP_IN, gv_evnt_sel_prm.v_acc_date_close);
      end;
      if(gv_evnt_sel_prm.v_acctrn_id != 0)
         cmd_scr.addParam("p_acctrnid", RSDBP_IN, gv_evnt_sel_prm.v_acctrn_id);
      end;
      if(gv_evnt_sel_prm.v_acctrn_date != date("00.00.0000"))
         cmd_scr.addParam("p_date_carry", RSDBP_IN, gv_evnt_sel_prm.v_acctrn_date);
      end;
      if(gv_evnt_sel_prm.v_paym_id != 0)
         cmd_scr.addParam("p_paymentid", RSDBP_IN, gv_evnt_sel_prm.v_paym_id);
      end;
      if(gv_evnt_sel_prm.v_paym_date != date("00.00.0000"))
         cmd_scr.addParam("p_creationdate", RSDBP_IN, gv_evnt_sel_prm.v_paym_date);
      end;

      rs_scr = RSDRecordSet(cmd_scr, RSDVAL_CLIENT, RSDVAl_STATIC);
   end;

   rs_scr.close();

end; /* macro m_run_main_scroll() */


/* Запуск основного скроллинга */
m_run_main_scroll();
Exit(1);