/*
$Name:        ws_ProcessDeals.mac
$Module:      Интеграция
$Description: Создание сделки из Кондор+
*/

/*-----------------------------------------------------*/
/*                                                     */
/* Автор: Гераськина Т.                                */
/*
*/
/*----------------------------------------------*/
import "ws_msg_transform_sec.mac";     /* Инструментарий для преобразования сообщений */
import "secur_prc_msg_transform.mac";  /* Функционал преобразования сообщений */
import "ws_impdeals.mac";              /* Загрузка МБК/КО сделок в бэк-офис из шлюза */
import "uws_exchng_log.mac";           /* Функционал логирования */

private macro getValueFromProperty(_obj, _nameproperty, _nametag, _isrequired)
   var res: variant;
   var vnametag;
   var err_txt;

   res = uTryToGetPropS(_obj, _nameproperty);
   if (_isrequired)
      if(ValType(res) == V_UNDEF)
         vnametag = _nametag+"."+_nameproperty;
         err_txt = ERR_TEXT_NO_IN_MSG +": "+vnametag;
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM));
      end;
   end;
   
   return res;
end;

private class c_Result
   var Code : integer;  // Поле Код, обязательное: Да
   var Text : string;   // Поле Текст, обязательное: Нет
end;

private class c_MainResult
   var Code : integer;  // Поле Код, обязательное: Да
   var Text : string;   // Поле Текст, обязательное: Нет
   var DealList = TArray;    // Результат загрузки лимитов   
end;


// класс Результата по одной записи
private class c_DealParm     
   var ExternalID : string;  // ИД сделки во внешней системе
   var DealID     : string;  // Уникальный ИД сделки в К+
   var SOFRDealID : string;  // ИД сделки в СОФР
   var Result     : c_Result; // Результат обработки запроса
end;

// параметры ответа
private class c_ProcessDealsResponse ()
   var ReqID      : string;   // ИД исходного запроса
   var SenderId   : string;   // Код АС-получателя ответа
   var Result     : c_MainResult; // Результат обработки запроса
end;

// параметры ответа
private class c_outObj()
   var ProcessDeals_resp = c_ProcessDealsResponse; // имя строго по названию тега
end;

// идентификация сделки 
private class c_IdentityDeal(IncomeData)
   var ActionType       : Integer;  // Тип действия                              Да    "1= добавить 2 = изменить 3 = удалить"
   var ExternalID       : String;   // Идентификатор сделки в исходной системе   Нет    Идентификатор
   var TSBrief          : String;   // Код торговой площадки/торговой системы    Нет    Справочник
   var DealID           : String;   // Уникальный идентификатор сделки в К+      Да
   var DealKind         : String;   // Тип сделки                                Да    Справочник
   var DealDate         : date;     // Дата заключения сделки                    Да
   var DealTime         : datetime; // Время заключения сделки                   Да
   var DealCaptureTime  : datetime; // Дата, время создания сделки в К+          Да
   var DealCorrectTime  : datetime; // Дата, время последнего изменения сделки   Да
   var BuySell          : String;   // Направление                               Да    Справочник
   var FO               : String;   // Тип операции по сделке                    Нет   Справочник
   var ConversationID   : String;   // Номер переговоров                         Нет
   var ConversationText : String;   // Текст переговоров                         Нет
   var Comment          : String;   // Комментарий к сделке                      Нет
   var GenAgreement     : String;   // Ген.соглашение                            Нет
   var GenData          : Date;     // Дата соглашения для CSA
   var SofrGenID        : Integer;  // ID сделки в таблице СОФР


   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)   
      private var err_txt;
      var nametag_up = "IdentityDeal";

      if(ValType(IncomeData) != V_UNDEF)
         ActionType        = getValueFromProperty(IncomeData, "ActionType"       , nametag_up, true);
         ExternalID        = getValueFromProperty(IncomeData, "ExternalID"       , nametag_up);
         TSBrief           = getValueFromProperty(IncomeData, "TSBrief"          , nametag_up);
         DealID            = getValueFromProperty(IncomeData, "DealID"           , nametag_up, true);
         DealKind          = trim(getValueFromProperty(IncomeData, "DealKind"    , nametag_up, true));
         DealDate          = getValueFromProperty(IncomeData, "DealDate"         , nametag_up, true);
         DealTime          = getValueFromProperty(IncomeData, "DealTime"         , nametag_up);
         DealCaptureTime   = getValueFromProperty(IncomeData, "DealCaptureTime"  , nametag_up, true);
         DealCorrectTime   = getValueFromProperty(IncomeData, "DealCorrectTime"  , nametag_up, true);
         BuySell           = getValueFromProperty(IncomeData, "BuySell"          , nametag_up, true);
         FO                = getValueFromProperty(IncomeData, "FO"               , nametag_up);
         ConversationID    = getValueFromProperty(IncomeData, "ConversationID"   , nametag_up);
         ConversationText  = getValueFromProperty(IncomeData, "ConversationText" , nametag_up);
         Comment           = getValueFromProperty(IncomeData, "Comment"          , nametag_up);
         GenAgreement      = getValueFromProperty(IncomeData, "GenAgreement"     , nametag_up);
         GenData           = getValueFromProperty(IncomeData, "GenData"          , nametag_up);
         SofrGenID         = getValueFromProperty(IncomeData, "SofrGenID"        , nametag_up);

         // проверка по списку значений
         if(ValType(ActionType) != V_UNDEF)
            if ( (ActionType == 1) or (ActionType == 2) or (ActionType == 3) )
            else
               err_txt = string("Недопустимое значение ", nametag_up ,".ActionType = ",ActionType);
               RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
            end;
         end;
      end;
   end;

   uInitPrime(IncomeData);   
end;

// Параметры расчетов
private class c_Calculate(IncomeData, _nametag_up)
   var CallNotice     : String;     // Периодичность выплат % M - месяц W - неделя D - ежедневно E - в конце срока            Да
   var CallNoticeDay  : Integer;    // Периодичность фиксации выплат % M - месяц W - неделя D - ежедневно E - в конце срока   Нет
   var CallNoticeFix  : String;     // Количество дней                                 Нет
   var MarginSpot       : double;   // Маржа                                           Нет
   var InterestFirstDate: date;     // Дата выплаты 1-го процента                      Нет
   var InterestFirstRate: double;   // Ставка выплаты 1-го процента                    Нет
   var InterestEndRate  : double;   // Ставка выплаты последнего процента              Нет
   var FixFrequency     : string;   // Период (частота) фиксации плавающей ставки      Нет
   var Type             : String;   // Порядок расчетов                                Нет
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var err_txt;
      private var nametag_up = "Calculate";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
         
      if(ValType(IncomeData) != V_UNDEF)
         CallNotice        = getValueFromProperty(IncomeData, "CallNotice"       , nametag_up);
         CallNoticeDay     = getValueFromProperty(IncomeData, "CallNoticeDay"    , nametag_up);
         CallNoticeFix     = getValueFromProperty(IncomeData, "CallNoticeFix"    , nametag_up);
         MarginSpot        = getValueFromProperty(IncomeData, "MarginSpot"       , nametag_up);
         InterestFirstDate = getValueFromProperty(IncomeData, "InterestFirstDate", nametag_up);
         InterestFirstRate = getValueFromProperty(IncomeData, "InterestFirstRate", nametag_up);
         InterestEndRate   = getValueFromProperty(IncomeData, "InterestEndRate"  , nametag_up);
         FixFrequency      = getValueFromProperty(IncomeData, "FixFrequency"     , nametag_up);
         Type              = getValueFromProperty(IncomeData, "Type"             , nametag_up);
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Обеспечение
private class c_Collateral(IncomeData, _nametag_up)
   var DateBegin     : date;     // Дата начала договора обеспечения    Да
   var DateEnd       : date;     // Дата окончания договора обеспечения Да
   var AgreeNumber   : String;   // Номер договора                      Да
   var Type          : String;   // Тип обеспечения                     Да    Справочник
   var Quantity      : Double;   // Количество единиц                   Нет
   var Rate          : Double;   // Курс                                Нет
   var CurrencyCode  : String;   // Код валюты обеспечения              Да    Справочник
   var Amount        : Double;   // Сумма обеспечения                   Да
   var Price         : Double;   // Цена по номиналу                    Да
   var PriceCoupon   : Double;   // Цена купона                         Нет
   var PriceFull     : Double;   // Итоговая цена                       Нет
   var AmountProvide : Double;   // Взвешенная сумма                    Нет
   var MetodClearing : String;   // Способ расчета                      Нет   Справочник
   var HairCut       : Double;   // Разница стоимости залога и полученного кредита     Нет
   var HairCutMetod  : String;   // Метод расчета разницы стоимости залога и кредита   Нет   Справочник
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var err_txt;
      private var nametag_up = "CollateralList.Collateral";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      if(ValType(IncomeData) != V_UNDEF)
         DateBegin      = getValueFromProperty(IncomeData, "DateBegin"     , nametag_up, true);
         DateEnd        = getValueFromProperty(IncomeData, "DateEnd"       , nametag_up, true);
         AgreeNumber    = getValueFromProperty(IncomeData, "AgreeNumber"   , nametag_up, true);
         Type           = getValueFromProperty(IncomeData, "Type"          , nametag_up, true);
         Quantity       = getValueFromProperty(IncomeData, "Quantity"      , nametag_up);
         Rate           = getValueFromProperty(IncomeData, "Rate"          , nametag_up);
         CurrencyCode   = getValueFromProperty(IncomeData, "CurrencyCode"  , nametag_up, true);
         Amount         = getValueFromProperty(IncomeData, "Amount"        , nametag_up, true);
         Price          = getValueFromProperty(IncomeData, "Price"         , nametag_up, true);
         PriceCoupon    = getValueFromProperty(IncomeData, "PriceCoupon"   , nametag_up);
         PriceFull      = getValueFromProperty(IncomeData, "PriceFull"     , nametag_up);
         AmountProvide  = getValueFromProperty(IncomeData, "AmountProvide" , nametag_up);
         MetodClearing  = getValueFromProperty(IncomeData, "MetodClearing" , nametag_up);
         HairCut        = getValueFromProperty(IncomeData, "HairCut"       , nametag_up);
         HairCutMetod   = getValueFromProperty(IncomeData, "HairCutMetod"  , nametag_up);
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Денежные потоки (график платежей)
private class c_CashPayment(IncomeData, _nametag_up)
   var NumberPayment : integer;  // Порядковый номер платежа
   var DateBegin     : date;     // Дата начала периода        Да
   var DateEnd       : date;     // Дата окончания периода     Да
   var DatePay       : date;     // Дата платежа за период     Да
   var Amount        : Double;   // Сумма платежа              Да
   var Type          : String;   // Тип платежа                Да    Справочник
   var Rate          : Double;   // Ставка                     Да
   var RateType      : String;   // Тип ставки                 Да    Справочник
   var FixDate       : date;     // Дата фиксинга
   var Comments      : String;   // Комментарий                Нет
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var err_txt;
      private var nametag_up = "CashFlow.Payment";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      if(ValType(IncomeData) != V_UNDEF)
// Cherednichenko 2021-09-09 DEF-13950 для платежей с типом principal датаы не обязательны, поэтому подниме на самый верх Type, и если он равен "P" - ищем даты без параметра true
         Type           = getValueFromProperty(IncomeData, "Type"          , nametag_up, true);
         NumberPayment  = getValueFromProperty(IncomeData, "NumberPayment" , nametag_up);
//         DateBegin      = getValueFromProperty(IncomeData, "DateBegin"     , nametag_up, true);
//         DateEnd        = getValueFromProperty(IncomeData, "DateEnd"       , nametag_up, true);
         DateBegin      = getValueFromProperty(IncomeData, "DateBegin"     , nametag_up, Type != "P");
         DateEnd        = getValueFromProperty(IncomeData, "DateEnd"       , nametag_up, Type != "P");
         DatePay        = getValueFromProperty(IncomeData, "DatePay"       , nametag_up, true);
         Amount         = getValueFromProperty(IncomeData, "Amount"        , nametag_up, true);
         Rate           = getValueFromProperty(IncomeData, "Rate"          , nametag_up, true);
         RateType       = getValueFromProperty(IncomeData, "RateType"      , nametag_up, true);
         FixDate        = getValueFromProperty(IncomeData, "FixDate"       , nametag_up);
         Comments       = getValueFromProperty(IncomeData, "Comments"      , nametag_up);
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Платежи
private class c_Payment(IncomeData, _nametag_up)
   var ValueDate1 : date;     // Дата расчетов 1   Да
   var ValueDate2 : date;     // Дата расчетов 2   Да
   var Amount1    : Double;   // Сумма сделки 1    Да    продажа - со знаком минус
   var Amount2    : Double;   // Сумма сделки 2    Да    продажа - со знаком минус
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var err_txt;
      private var nametag_up = "Payments";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      if(ValType(IncomeData) != V_UNDEF)
         ValueDate1  = getValueFromProperty(IncomeData, "ValueDate1" , nametag_up, true);
         ValueDate2  = getValueFromProperty(IncomeData, "ValueDate2" , nametag_up, true);
         Amount1     = getValueFromProperty(IncomeData, "Amount1"    , nametag_up, true);
         Amount2     = getValueFromProperty(IncomeData, "Amount2"    , nametag_up, true);
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Амортизация
private class c_Amortization(IncomeData, _nametag_up)
   var Type       : String;   // Тип                           Да    Справочник
   var AmountFix  : Double;   // Фиксированная сумма           Нет
   var Freq       : String;   // Периодичность амортизации     Нет   Справочник
   var DateFix    : date;     // Расчетная дата амортизации    Нет
   var DateEnd    : date;     // Окончательная дата расчетов   Нет
   var AmountRest : Double;   // Остаток суммы амортизации     Нет
   var Rate       : Double;   // Процентная ставка амортизации Нет
   var TermAmount : double;   // Сумма погашения при ликвидации сделки  Нет
   var TermClFee  : double;   // Сумма % при ликвидации        Нет
   var TermAccrued: double;   // Сумма начисленных %           Нет
   var TermNpv    : double;   // Чистая стоимость              Нет
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var err_txt;
      private var nametag_up = "Amortization";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      if(ValType(IncomeData) != V_UNDEF)
         Type        = getValueFromProperty(IncomeData, "Type"       , nametag_up, true);
         AmountFix   = getValueFromProperty(IncomeData, "AmountFix"  , nametag_up);
         Freq        = getValueFromProperty(IncomeData, "Freq"       , nametag_up);
         DateFix     = getValueFromProperty(IncomeData, "DateFix"    , nametag_up);
         DateEnd     = getValueFromProperty(IncomeData, "DateEnd"    , nametag_up);
         AmountRest  = getValueFromProperty(IncomeData, "AmountRest" , nametag_up);
         Rate        = getValueFromProperty(IncomeData, "Rate"       , nametag_up);
         TermAmount  = getValueFromProperty(IncomeData, "TermAmount" , nametag_up);
         TermClFee   = getValueFromProperty(IncomeData, "TermClFee"  , nametag_up);
         TermAccrued = getValueFromProperty(IncomeData, "TermAccrued", nametag_up);
         TermNpv     = getValueFromProperty(IncomeData, "TermNpv"    , nametag_up);
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Описание металла
private class adp_PrecMetal(IncomeData, _nametag_up)
   var DmType        : string;   // Единица измерения       Да    "g = граммы o = унции"
   var Amount        : double;   // Количество              Да
   var Price         : double;   // Цена за единицу         Да
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var err_txt;
      private var nametag_up = "PrecMetal";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      if(ValType(IncomeData) != V_UNDEF)
         DmType   = getValueFromProperty(IncomeData, "DmType"  , nametag_up, true);
         Amount   = getValueFromProperty(IncomeData, "Amount"  , nametag_up, true);
         Price    = getValueFromProperty(IncomeData, "Price"   , nametag_up, true);

         // проверка по списку значений
         if(ValType(DmType) != V_UNDEF)
            if ( (StrUpr(DmType) == StrUpr("g")) or (StrUpr(DmType) == StrUpr("o")) )
            else
               err_txt = string("Недопустимое значение ", nametag_up, ".DmType = ",DmType);
               RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
            end;
         end;
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

private class adp_LegsDeal(IncomeData, _nametag_up)
   var LegsNumber       : integer;     // Номер ноги                          Да       1 или 2
   var Rate             : double;      // Курс сделки                         Да
   var RateDirection    : string;      // Направление курса                   Нет      D - прямой I - обратный
   var RateQutationUnit	: integer;     // Масштаб курса (количество единиц)   Нет
   var Netting          : bool;        // признак неттинга                    Да
   var PrecMetal                 ;     // Описание металла     Контейнер      Нет
   var Payments                  ;     // Платежи                             Да
   var PIPayer             : String;   // Идентификатор платежной инструкции плательщика
   var PIReceiver          : String;   // Идентификатор платежной инструкции получателя
   
   var temp_netting;

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var err_txt,aux_buff;
      private var nametag_up = "LegsDealsList.LegsDeal";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      if(ValType(IncomeData) != V_UNDEF)
         LegsNumber        = getValueFromProperty(IncomeData, "LegsNumber"       , nametag_up, true);
         Rate              = getValueFromProperty(IncomeData, "Rate"             , nametag_up, true);
         RateDirection     = getValueFromProperty(IncomeData, "RateDirection"    , nametag_up);
         RateQutationUnit  = getValueFromProperty(IncomeData, "RateQutationUnit" , nametag_up);
         //Netting           = getValueFromProperty(IncomeData, "Netting"          , nametag_up, true);
         PIPayer           = getValueFromProperty(IncomeData, "PIPayer"          , nametag_up);
         PIReceiver        = getValueFromProperty(IncomeData, "PIReceiver"       , nametag_up);


         // gtv: как оказалось, значение может быть строковым
         temp_netting = getValueFromProperty(IncomeData, "Netting", nametag_up, true);
         if (Valtype(temp_netting) == V_STRING) 
            if (StrUpr(temp_netting) == "N") 
               Netting = false;
            elif (StrUpr(temp_netting) == "Y")
               Netting = true;
            elif (StrUpr(temp_netting) == "TRUE")
               Netting = true;
            elif (StrUpr(temp_netting) == "FALSE")
               Netting = false;
            else
               Netting = false;
            end;
         elif (Valtype(temp_netting) == V_BOOL)
            Netting = temp_netting;
         else
            Netting = false;
         end;
         
         // проверка по списку значений
         if(ValType(LegsNumber) != V_UNDEF)
            if ( (LegsNumber == 1) or (LegsNumber == 2) )
            else 
               err_txt = string("Недопустимое значение ", nametag_up, ".LegsNumber = ",LegsNumber);
               RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
            end;
         end;
         if (ValType(RateDirection) != V_UNDEF)
            if ( (RateDirection == "D") or (RateDirection == "I") )
            else
               err_txt = string("Недопустимое значение ", nametag_up, ".RateDirection = ",RateDirection);
               RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
            end;
         end;
         
         // контейнеры
         aux_buff  = getValueFromProperty(IncomeData, "PrecMetal", nametag_up);
         if(ValType(aux_buff) != V_UNDEF)
            PrecMetal = adp_PrecMetal(aux_buff, nametag_up);
         end;

         aux_buff  = getValueFromProperty(IncomeData, "Payments", nametag_up, true);
         if(ValType(aux_buff) != V_UNDEF)
            Payments = c_Payment(aux_buff, nametag_up);
         end;
         
      else
         err_txt = ERR_TEXT_NO_IN_MSG +": "+nametag_up;
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM)); 
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

private class adp_Fixing(IncomeData, _nametag_up)
   var FixDate    : date;     // Дата фиксинга        Да
   var FixCurr    : String;   // Валюта фиксинга      Да
   var FixRate    : Double;   // Курс фиксинга        Да
   var FixAmount  : Double;   // Сумма фиксинга       Нет
   var FixSource  : String;   // Источник фиксинга    Нет

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var err_txt;
      private var nametag_up = "Fixing";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      if(ValType(IncomeData) != V_UNDEF)
         FixDate     = getValueFromProperty(IncomeData, "FixDate"    , nametag_up, true);
         FixCurr     = getValueFromProperty(IncomeData, "FixCurr"    , nametag_up, true);
         FixRate     = getValueFromProperty(IncomeData, "FixRate"    , nametag_up, true);
         FixAmount   = getValueFromProperty(IncomeData, "FixAmount"  , nametag_up);
         FixSource   = getValueFromProperty(IncomeData, "FixSource"  , nametag_up);
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
   
end;


// Экспирация (исполнение) сделки
private class adp_Matutity(IncomeData, _nametag_up)
   var Date          : date;     // Дата исполнения (экспирации) сделки    Да
   var Time          : datetime; // Время исполнения сделки                Да
   var DealRelation  : string;   // Номер связанной сделки                 Да
   var Currunce      : string;   // Код валюты расчетов                    Да
   var Rate          : double;   // Курс исполнения                        Да
   var Amount1       : double;   // Сумма базовой валюты                   Да
   var PayDate       : date;     // Дата расчетов                          Да
   var Fee           : double;   // Комиссия                               Нет
   var Comment       : string;   // Комментарий                            Нет

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var nametag_up = "Matutity";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      
      if(ValType(IncomeData) != V_UNDEF)
         Date           = getValueFromProperty(IncomeData, "Date"          , nametag_up, true);
         Time           = getValueFromProperty(IncomeData, "Time"          , nametag_up, true);
         DealRelation   = getValueFromProperty(IncomeData, "DealRelation"  , nametag_up, true);
         Currunce       = getValueFromProperty(IncomeData, "Currunce"      , nametag_up, true);
         Rate           = getValueFromProperty(IncomeData, "Rate"          , nametag_up, true);
         Amount1        = getValueFromProperty(IncomeData, "Amount1"       , nametag_up, true);
         PayDate        = getValueFromProperty(IncomeData, "PayDate"       , nametag_up, true);
         Fee            = getValueFromProperty(IncomeData, "Date"          , nametag_up);
         Comment        = getValueFromProperty(IncomeData, "Date"          , nametag_up);
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// Ценная бумага
private class adp_Securities(IncomeData, _nametag_up)
   var ISIN       : string;   // Идентификатор                       Да
   var ShortName  : string;   // Краткое наименование                Да
   var FullName   : string;   // Полное наиименование                Нет
   var Kind       : string;   // Тип                                 Нет
   var IsDrv      : bool;     // Признак производного инструмента    Нет
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      var nametag_up = "Securities";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      if(ValType(IncomeData) != V_UNDEF)
         ISIN        = getValueFromProperty(IncomeData, "ISIN"     , nametag_up, true);
         ShortName   = getValueFromProperty(IncomeData, "ShortName", nametag_up, true);
         FullName    = getValueFromProperty(IncomeData, "FullName" , nametag_up);
         Kind        = getValueFromProperty(IncomeData, "Kind"     , nametag_up);
         IsDrv       = getValueFromProperty(IncomeData, "IsDrv"    , nametag_up);
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;


// Части сделки
private class c_LegsDeal_REPO(IncomeData, _nametag_up)
   var LegsNumber    : integer;  // Номер ноги  1 - 1-я нога 2 - 2-я нога
   var Rate          : double;   // Курс сделки (%)
   var Accrued       : double;   // Купон (%)
   var TotalRate     : double;   // Курс(%)
   var AmountAccrued : double;   // Сумма купона
   var AmountDeal    : double;   // Сумма сделки
   var AmountPay     : double;   // Сумма платежа
   var PaymentMethod : integer;  // Способ платежа 1 - DVP 2 - Early delivery 3 - Prepayment 4 - Free of payment 
   var ValueDate     : date;     // Дата платежа
   var SettlementDate: date;     // Дата поставки

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var err_txt;
      private var nametag_up = "LegsDealsList.LegsDeal";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      if(ValType(IncomeData) != V_UNDEF)
         LegsNumber     = getValueFromProperty(IncomeData, "LegsNumber"    , nametag_up, true);
         Rate           = getValueFromProperty(IncomeData, "Rate"          , nametag_up, true);
         Accrued        = getValueFromProperty(IncomeData, "Accrued"       , nametag_up);
         TotalRate      = getValueFromProperty(IncomeData, "TotalRate"     , nametag_up);
         AmountAccrued  = getValueFromProperty(IncomeData, "AmountAccrued" , nametag_up);
         AmountDeal     = getValueFromProperty(IncomeData, "AmountDeal"    , nametag_up);
         AmountPay      = getValueFromProperty(IncomeData, "AmountPay"     , nametag_up);
         PaymentMethod  = getValueFromProperty(IncomeData, "PaymentMethod" , nametag_up);
         ValueDate      = getValueFromProperty(IncomeData, "ValueDate"     , nametag_up);
         SettlementDate = getValueFromProperty(IncomeData, "SettlementDate", nametag_up);
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;


// Части сделки
private class c_PartList_IRS(IncomeData, _nametag_up)
   var Number              : integer;  // Номер части сделки                     Да
   var Instrument          : string;   // Тип инструмента                        Нет
   var TypeDeal            : integer;  // Тип сделки                             Нет   "1 - привлечение 2 - размещение"
   var Type                : integer;  // Тип                                    Да    "1 = в одной валюте 2 = в двух валютах 3 = в трех валютах"
   var CurrencyCode        : string;   // Код валюты сделки                      Да
   var CurrencyPrincipal   : string;   // Код основной валюты                    Нет
   var CurrencyCoupon      : string;   // Код валюты при оплате купонов          Нет
   var Amount              : double;   // Сумма сделки                           Да
   var PaymentType         : string;   // Тип оплаты                             Нет
   var DateBegin           : date;     // Дата начала сделки                     Да
   var DateEnd             : date;     // Дата окончания сделки                  Да
   var Basis               : string;   // Код базиса                             Нет
   var RateType            : string;   // Тип ставки                             Да
   var Rate                : double;   // Курс сделки                            Нет
   var RateFloatDev        : double;   // Отклонение от % ставки (для плаваюшей ставки)   Нет
   var RateFloatType       : string;   // Код вида плавающей ставки              Нет
   var RateFloatShortName  : string;   // Краткое наименование плавающей ставки  Нет
   var RateFloatFullName   : string;   // Полное наименование плавающей ставки   Нет
   var Calculate           ;           // Параметры расчетов                     Нет
   var Amortization        ;           // Амортизация                            Нет
   var CashFlow            ;           // Денежные потоки (график платежей)      Да

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var err_txt;
      private var aux_buff;
      private var nametag_up = "PartDealsList.PartDeal";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      if(ValType(IncomeData) != V_UNDEF)
         Number               = getValueFromProperty(IncomeData, "Number"              , nametag_up, true);
         Instrument           = getValueFromProperty(IncomeData, "Instrument"          , nametag_up);
         TypeDeal             = getValueFromProperty(IncomeData, "TypeDeal"            , nametag_up);
         Type                 = getValueFromProperty(IncomeData, "Type"                , nametag_up, true);
         CurrencyCode         = getValueFromProperty(IncomeData, "CurrencyCode"        , nametag_up, true);
         CurrencyPrincipal    = getValueFromProperty(IncomeData, "CurrencyPrincipal"   , nametag_up);
         CurrencyCoupon       = getValueFromProperty(IncomeData, "CurrencyCoupon"      , nametag_up);
         Amount               = getValueFromProperty(IncomeData, "Amount"              , nametag_up, true);
         PaymentType          = getValueFromProperty(IncomeData, "PaymentType"         , nametag_up);
         DateBegin            = getValueFromProperty(IncomeData, "DateBegin"           , nametag_up, true);
         DateEnd              = getValueFromProperty(IncomeData, "DateEnd"             , nametag_up, true);
         Basis                = getValueFromProperty(IncomeData, "Basis"               , nametag_up);
         RateType             = getValueFromProperty(IncomeData, "RateType"            , nametag_up, true);
         Rate                 = getValueFromProperty(IncomeData, "Rate"                , nametag_up);
         RateFloatDev         = getValueFromProperty(IncomeData, "RateFloatDev"        , nametag_up);
         RateFloatType        = getValueFromProperty(IncomeData, "RateFloatType"       , nametag_up);
         RateFloatShortName   = getValueFromProperty(IncomeData, "RateFloatShortName"  , nametag_up);
         RateFloatFullName    = getValueFromProperty(IncomeData, "RateFloatFullName"   , nametag_up);

         Amortization         = getValueFromProperty(IncomeData, "Amortization"        , nametag_up);
         CashFlow             = getValueFromProperty(IncomeData, "CashFlow"            , nametag_up, true);
         
         // контейнеры
         aux_buff = getValueFromProperty(IncomeData, "Calculate", nametag_up);
         if (ValType(aux_buff) != V_UNDEF)
            Calculate = c_Calculate(aux_buff, nametag_up);
         end;
         
         aux_buff = getValueFromProperty(IncomeData, "Amortization", nametag_up);
         if (ValType(aux_buff) != V_UNDEF)
            Amortization = c_Amortization(aux_buff, nametag_up);
         end;         

         aux_buff = getValueFromProperty(IncomeData, "CashFlow", nametag_up, true);
         if(ValType(aux_buff) != V_UNDEF)
            if(ValType(aux_buff) == V_GENOBJ)
               CashFlow = TArray;
               aux_buff = 0;
//shev
//               while(IncomeData.CashFlow.size > aux_buff)
//                  CashFlow.value(CashFlow.size) = c_CashPayment(IncomeData.CashFlow.value(aux_buff), nametag_up);
//                  aux_buff = aux_buff + 1;
//               end;

               for(aux_buff, IncomeData.CashFlow)
                    CashFlow.value(CashFlow.size) = c_CashPayment(aux_buff, nametag_up);
               end;

            else
               err_txt = string(InErrNotObj, nametag_up, ".CashFlow");
               RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
            end;
         end;
         
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

// для опционов
private class c_Equity_EqInt_Option(IncomeData, _nametag_up)
   var ISINEq           : string; // ISIN бумаги 
   var FinCenter        : string; // Код фин. Центра по бумаге 
   var FinCenterName    : string; // Код фин. Центра по бумаге
   var Issur            : string; // Код эмитента по бумаге 
   var IssurName        : string; // Наименование эмитента по бумаге 
   var EqComm           : double; // Объем комиссии по бумаге 
   var QuantityAmmount  : double; // Номинал по бумаге 
   var LegalStatus      : string; // Код правового статуса по бумаге
   var LegalStatusName  : string; // Наименование кода правового статуса по бумаге
   var RiskSector       : string; // Код сектора риска
   var RiskSectorName   : string; // Наименование кода сектора риска
   var Instrument       : string; // Код инструмента
   var InstrumentName   : string; // Наименование кода инструмента
   var ClMode           : string; // Код депозитария
   var ClModeName       : string; // Наименование кода депозитария
   var Market           : string; // Код торговой площадки
   var MarketName       : string; // Наименование кода торговой площадки
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      var nametag_up = "Equity";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      if(ValType(IncomeData) != V_UNDEF)
         ISINEq            = getValueFromProperty(IncomeData, "ISINEq"           , nametag_up);
         FinCenter         = getValueFromProperty(IncomeData, "FinCenter"        , nametag_up);
         FinCenterName     = getValueFromProperty(IncomeData, "FinCenterName"    , nametag_up);
         Issur             = getValueFromProperty(IncomeData, "Issur"            , nametag_up);
         IssurName         = getValueFromProperty(IncomeData, "IssurName"        , nametag_up);
         EqComm            = getValueFromProperty(IncomeData, "EqComm"           , nametag_up);
         QuantityAmmount   = getValueFromProperty(IncomeData, "QuantityAmmount"  , nametag_up);
         LegalStatus       = getValueFromProperty(IncomeData, "LegalStatus"      , nametag_up);
         LegalStatusName   = getValueFromProperty(IncomeData, "LegalStatusName"  , nametag_up);
         RiskSector        = getValueFromProperty(IncomeData, "RiskSector"       , nametag_up);
         RiskSectorName    = getValueFromProperty(IncomeData, "RiskSectorName"   , nametag_up);
         Instrument        = getValueFromProperty(IncomeData, "Instrument"       , nametag_up);
         InstrumentName    = getValueFromProperty(IncomeData, "InstrumentName"   , nametag_up);
         ClMode            = getValueFromProperty(IncomeData, "ClMode"           , nametag_up);
         ClModeName        = getValueFromProperty(IncomeData, "ClModeName"       , nametag_up);
         Market            = getValueFromProperty(IncomeData, "Market"           , nametag_up);
         MarketName        = getValueFromProperty(IncomeData, "MarketName"       , nametag_up);
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;


// для опционов
private class c_Index_EqInt_Option(IncomeData, _nametag_up)
   var Riunding   : integer;  // Кол-во знаков округления значения индекса
   var IndType    : integer;  // Тип индекса  1 - стандартный 2 - корзина 
   var DivType    : integer;  // Дивиденты    1 - дискретный    2 - уступочный 
   var CalculRule : integer;  // Правила расчета  1 - price weighted   2 - size weighted    3 - geometrical
   var BasisInd   : string;   // Значение базового индекса 
   var Сoeff      : double;   // Значение корректирующего коэффициента 
   var MСoeff     : double;   // Значение коэффициента  
   var Market     : string;   // Код торговой площадки
   var MarketName : string;   // Наименование кода торговой площадки

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      var nametag_up = "Index";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      if(ValType(IncomeData) != V_UNDEF)
         Riunding    = getValueFromProperty(IncomeData, "Riunding"   , nametag_up);
         IndType     = getValueFromProperty(IncomeData, "IndType"    , nametag_up);
         DivType     = getValueFromProperty(IncomeData, "DivType"    , nametag_up);
         CalculRule  = getValueFromProperty(IncomeData, "CalculRule" , nametag_up);
         BasisInd    = getValueFromProperty(IncomeData, "BasisInd"   , nametag_up);
         Сoeff       = getValueFromProperty(IncomeData, "Сoeff"      , nametag_up);
         MСoeff      = getValueFromProperty(IncomeData, "MСoeff"     , nametag_up);
         Market      = getValueFromProperty(IncomeData, "Market"     , nametag_up);
         MarketName  = getValueFromProperty(IncomeData, "MarketName" , nametag_up);
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;


// для опционов
private class c_EqInt_Option(IncomeData, _nametag_up)
   var EqIndName        : string;   // Наименование бумаги / индекса
   var EqIndFullName    : string;   // Полное наименование бумаги / индекса
   var CurrencyEqInd    : string;   // Валюта акции / индекса 
   var Equity;
   var Index;

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var err_txt;
      private var aux_buff;
      private var nametag_up = "EqInt";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      if(ValType(IncomeData) != V_UNDEF)
         EqIndName      = getValueFromProperty(IncomeData, "EqIndName"     , nametag_up, true);
         EqIndFullName  = getValueFromProperty(IncomeData, "EqIndFullName" , nametag_up, true);
         CurrencyEqInd  = getValueFromProperty(IncomeData, "CurrencyEqInd" , nametag_up, true);
         
         // контейнеры
         aux_buff = getValueFromProperty(IncomeData, "Equity", nametag_up);
         if (ValType(aux_buff) != V_UNDEF)
            Equity = c_Equity_EqInt_Option(aux_buff, nametag_up);
         end;
         
         aux_buff = getValueFromProperty(IncomeData, "Index", nametag_up);
         if (ValType(aux_buff) != V_UNDEF)
            Index = c_Index_EqInt_Option(aux_buff, nametag_up);
         end;
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;

private class c_Liquidation_Option(IncomeData, _nametag_up)
   var LiqDate       : date;     // Дата экспирации / ликвидации 
   var LiqCurr       : string;   // Валюта
   var LiqPrice      : double;   // Цена 
   var LiqCash       : double;   // Сумма 
   var LiqType       : string;   // Тип расчетов  Cash  Delivery
   var LiqQuantity   : double;   // Количество 
   var LiqFee        : double;   // Комиссия 
   var LiqCashSett   : double;   // Сумма наличного расчета 
   var LiqExPrice    : double;   // Сумма (экзотика) 
   var LiqAddFee     : double;   // дополнительная плата 
   var LiqKind       : string;   // Тип  L - ликвидация  A - передача
   var LiqCpty       : string;   // Контрагент на которого переводится 
   var LiqPayDate    : date;     // Дата платежа 
   var LiqDirtyFee   : double;   // Грязная комиссия 
   var LiqCleanFee   : double;   // Чистая комиссия 
   var LiqNPV        : double;   // Чистая стоимость 

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var err_txt;
      private var aux_buff;
      private var nametag_up = "Liquidation";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      if(ValType(IncomeData) != V_UNDEF)
         LiqDate     = getValueFromProperty(IncomeData, "LiqDate"       , nametag_up);
         LiqCurr     = getValueFromProperty(IncomeData, "LiqCurr"       , nametag_up);
         LiqPrice    = getValueFromProperty(IncomeData, "LiqPrice"      , nametag_up);
         LiqCash     = getValueFromProperty(IncomeData, "LiqCash"       , nametag_up);
         LiqType     = getValueFromProperty(IncomeData, "LiqType"       , nametag_up);
         LiqQuantity = getValueFromProperty(IncomeData, "LiqQuantity"   , nametag_up);
         LiqFee      = getValueFromProperty(IncomeData, "LiqFee"        , nametag_up);
         LiqCashSett = getValueFromProperty(IncomeData, "LiqCashSett"   , nametag_up);
         LiqExPrice  = getValueFromProperty(IncomeData, "LiqExPrice"    , nametag_up);
         LiqAddFee   = getValueFromProperty(IncomeData, "LiqAddFee"     , nametag_up);
         LiqKind     = getValueFromProperty(IncomeData, "LiqKind"       , nametag_up);
         LiqCpty     = getValueFromProperty(IncomeData, "LiqCpty"       , nametag_up);
         LiqPayDate  = getValueFromProperty(IncomeData, "LiqPayDate"    , nametag_up);
         LiqDirtyFee = getValueFromProperty(IncomeData, "LiqDirtyFee"   , nametag_up);
         LiqCleanFee = getValueFromProperty(IncomeData, "LiqCleanFee"   , nametag_up);
         LiqNPV      = getValueFromProperty(IncomeData, "LiqNPV"        , nametag_up);
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;


private class c_Exotic_Option(IncomeData, _nametag_up)
   var CashType      : integer;  // Тип единиц - количество или сумма 
   var BarrierUp     : double;   // Макс. барьер 
   var BarrierDown   : double;   // Минимальный барьер 
   var FixAmmount    : double;   // Курс фиксации 
   var DateVal       : date;     // Дата валютирования 
   var Period        : string;   // Переодичность 
   var TypePay       : string;   // Тип расчетов 
   var RebateUp      : double;   // Макс.уступка 
   var RebateDown    : double;   // Минимальная уступка 
   var SettlementLag : integer;  // Задержка при расчетах 
   var MaturityDate  : date;     // Дата окончания 

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var err_txt;
      private var aux_buff;
      private var nametag_up = "Liquidation";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      if(ValType(IncomeData) != V_UNDEF)
         CashType       = getValueFromProperty(IncomeData, "CashType"      , nametag_up);
         BarrierUp      = getValueFromProperty(IncomeData, "BarrierUp"     , nametag_up);
         BarrierDown    = getValueFromProperty(IncomeData, "BarrierDown"   , nametag_up);
         FixAmmount     = getValueFromProperty(IncomeData, "FixAmmount"    , nametag_up);
         DateVal        = getValueFromProperty(IncomeData, "DateVal"       , nametag_up);
         Period         = getValueFromProperty(IncomeData, "Period"        , nametag_up);
         TypePay        = getValueFromProperty(IncomeData, "TypePay"       , nametag_up);
         RebateUp       = getValueFromProperty(IncomeData, "RebateUp"      , nametag_up);
         RebateDown     = getValueFromProperty(IncomeData, "RebateDown"    , nametag_up);
         SettlementLag  = getValueFromProperty(IncomeData, "SettlementLag" , nametag_up);
         MaturityDate   = getValueFromProperty(IncomeData, "MaturityDate"  , nametag_up);
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;


private class c_Details_REPO(IncomeData, _nametag_up)
   var Prepayment       : string;   // Тип оплаты Y - есть задаток N - нет задатка
   var PrepaymentCurr   : string;   // Валюта оплаты
   var PrepaymentAmount : double;   // Сумма оплаты 
   var ClearingBank     : string;   // Депозитарий банка 
   var ClearingBankName : string;   // Депозитарий банка - полное наименование 
   var ClearingCpty     : string;   // Депозитарий контрагента 
   var ClearingCptyName : string;   // Депозитарий контрагента - полное наименование 
   var DeliveryActive   : string;   // Переход прав B - Банк C - Контрагент 
   var Agreement        : string;   // Договор готовит B - Банк C - Контрагент 
   var DeliveryPayer    : string;   // Расходы платит B - Банк C - Контрагент 
   var MarginCall       : integer;  // Порог маржи 1 - Не проверять 2 - Прог % 3 - Порог Суммы 4 - Пределы дисконта 5 - Нижний предел 6 - Верхний предел 7 - Глобальное соглашение 
   var Threshold        : double;   //  Порог 
   var KnockOut         : string;   // Прекращение 
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var err_txt;
      private var aux_buff;
      private var nametag_up = "Details";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      if(ValType(IncomeData) != V_UNDEF)
         Prepayment        = getValueFromProperty(IncomeData, "Prepayment"       , nametag_up);
         PrepaymentCurr    = getValueFromProperty(IncomeData, "PrepaymentCurr"   , nametag_up);
         PrepaymentAmount  = getValueFromProperty(IncomeData, "PrepaymentAmount" , nametag_up);
         ClearingBank      = getValueFromProperty(IncomeData, "ClearingBank"     , nametag_up);
         ClearingBankName  = getValueFromProperty(IncomeData, "ClearingBankName" , nametag_up);
         ClearingCpty      = getValueFromProperty(IncomeData, "ClearingCpty"     , nametag_up);
         ClearingCptyName  = getValueFromProperty(IncomeData, "ClearingCptyName" , nametag_up);
         DeliveryActive    = getValueFromProperty(IncomeData, "DeliveryActive"   , nametag_up);
         Agreement         = getValueFromProperty(IncomeData, "Agreement"        , nametag_up);
         DeliveryPayer     = getValueFromProperty(IncomeData, "DeliveryPayer"    , nametag_up);
         MarginCall        = getValueFromProperty(IncomeData, "MarginCall"       , nametag_up);
         Threshold         = getValueFromProperty(IncomeData, "Threshold"        , nametag_up);
         KnockOut          = getValueFromProperty(IncomeData, "KnockOut"         , nametag_up);
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;


private class c_Saller_Equity(IncomeData, _nametag_up)
   var SallerCode    : string;   // Код продавца 
   var Purpose       : string;   // Назначение 
   var MarginSaller  : double;   // Маржа продавца 
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      private var err_txt;
      private var nametag_up = "Saller";
      if (ValType(_nametag_up) != V_UNDEF)
         nametag_up = _nametag_up+"."+nametag_up;
      end;
      if(ValType(IncomeData) != V_UNDEF)
         SallerCode     = getValueFromProperty(IncomeData, "SallerCode"    , nametag_up);
         Purpose        = getValueFromProperty(IncomeData, "Purpose"       , nametag_up);
         MarginSaller   = getValueFromProperty(IncomeData, "MarginSaller"  , nametag_up);
      end;
   end;

   uInitPrime(IncomeData, _nametag_up);
end;


// МБК/CSA
private class c_IAMLDDeal(IncomeData, DealKind)
   private var err_txt;
   private var aux_buff;

   var TypeDeal            : integer;  // Тип сделки  1 - привлечение 2 - размещение
   var GenData             : date;     // Дата соглашения CSA
   var PairsName           : String;   // Код валютной пары                                  Нет   Справочник
   var CurrencyDeals       : String;   // Код валюты сделки                                  Да    Справочник
   var Rate                : Double;   // Курс сделки                                        Нет
   var CurrencyPrincipal   : String;   // Код валюты номинала                                Нет   Справочник
   var CurrencyCoupon      : String;   // Код валюты процентов                               Нет   Справочник
   var InterestRateType    : String;   // Тип процентной ставки                              Да    "Fix фиксированная  Float плавающая"  Справочник
   var RateFixValue        : Double;   // Значение фиксированной ставки                      Нет
   var RateFloatKind       : String;   // Тип плавающей % ставки                             Нет   Справочник
   var RateFloatShortName  : String;   // Краткое наименование плавающей ставки              Нет   Справочник
   var RateFloatFullName   : String;   // Полное наименование плавающей ставки               Нет   Справочник
   var RateFloatType       : String;   // Тип кривой                                         Нет   Справочник
   var RateFloatDev        : Double;   // Отклонение от % ставки (для плаваюшей ставки)      Нет
   var RateDiscount        : Double;   // Ставка дисконта                                    Нет
   var RateTotal           : Double;   // Итоговая ставка в %-х                              Нет
   var CallNotice          : String;   // Периодичность выплат %                             Нет   Справочник
   var MarginSpot          : Double;   // Маржа                                              Нет
   var Basis               : String;   // Базис начисления %                                 Нет   Справочник
   var InterestFirstDate   : date;     // Дата выплаты 1-го процента                         Да
   var Details             : String;   
   var ParentDealID        : String;   // Идентификатор родительской сделки                  Нет
   var RootDealID          : String;   // Идентификатор первичной сделки                     Нет
   var UpDealID            : String;   // Идентификатор сделки, которая была пролонгирована  Нет
   var IsNostro            : bool;   //                                                    Нет
   
   var Calculate;          // Параметры расчетов                  Нет
   var CollateralList;     // Обеспечение                         Нет
   var CashFlow;           // Денежные потоки (график платежей)   -
   var Payments;           // Платежи                             -
   var Amortization;       // Амортизация                         Нет

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData, DealKind)
      private var err_txt;
      private var aux_buff;
      private var nametag_up = " IAMLDDeal";

      TypeDeal             = getValueFromProperty(IncomeData, "TypeDeal",           nametag_up, true);
      GenData              = getValueFromProperty(IncomeData, "GenData",            nametag_up);
      PairsName            = getValueFromProperty(IncomeData, "PairsName",          nametag_up);
      CurrencyDeals        = getValueFromProperty(IncomeData, "CurrencyDeals",      nametag_up, true);
      Rate                 = getValueFromProperty(IncomeData, "Rate",               nametag_up);
      CurrencyPrincipal    = getValueFromProperty(IncomeData, "CurrencyPrincipal",  nametag_up);
      CurrencyCoupon       = getValueFromProperty(IncomeData, "CurrencyCoupon",     nametag_up);
      InterestRateType     = getValueFromProperty(IncomeData, "InterestRateType",   nametag_up, true);
      RateFixValue         = getValueFromProperty(IncomeData, "RateFixValue",       nametag_up);
      RateFloatKind        = getValueFromProperty(IncomeData, "RateFloatKind",      nametag_up);
      RateFloatShortName   = getValueFromProperty(IncomeData, "RateFloatShortName", nametag_up);
      RateFloatFullName    = getValueFromProperty(IncomeData, "RateFloatFullName",  nametag_up);
      RateFloatType        = getValueFromProperty(IncomeData, "RateFloatType",      nametag_up);
      RateFloatDev         = getValueFromProperty(IncomeData, "RateFloatDev",       nametag_up);
      RateDiscount         = getValueFromProperty(IncomeData, "RateDiscount",       nametag_up);
      RateTotal            = getValueFromProperty(IncomeData, "RateTotal",          nametag_up);
      CallNotice           = getValueFromProperty(IncomeData, "CallNotice",         nametag_up);
      MarginSpot           = getValueFromProperty(IncomeData, "MarginSpot",         nametag_up);
      Basis                = getValueFromProperty(IncomeData, "Basis",              nametag_up);
      InterestFirstDate    = getValueFromProperty(IncomeData, "InterestFirstDate",  nametag_up, true);
      Details              = getValueFromProperty(IncomeData, "Details",            nametag_up);
      ParentDealID         = getValueFromProperty(IncomeData, "ParentDealID",       nametag_up);
      RootDealID           = getValueFromProperty(IncomeData, "RootDealID",         nametag_up);
      UpDealID             = getValueFromProperty(IncomeData, "UpDealID",           nametag_up);
      IsNostro             = getValueFromProperty(IncomeData, "IsNostro",           nametag_up);
         
      // проверка по списку значений
      if (ValType(TypeDeal) != V_UNDEF)
         if ( (TypeDeal == 1) or (TypeDeal == 2) )
         else
            err_txt = string("Недопустимое значение ", nametag_up, ".TypeDeal = ",TypeDeal);
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
         end;
      end;
      if (ValType(InterestRateType) != V_UNDEF)
         if ( (StrUpr(InterestRateType) == StrUpr("Fix")) or (StrUpr(InterestRateType) == StrUpr("Float")) )
         else
            err_txt = string("Недопустимое значение ", nametag_up, ".InterestRateType = ",InterestRateType);
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
         end;
      end;
      
      // контейнеры
      aux_buff = getValueFromProperty(IncomeData, "Calculate", nametag_up);
      if (ValType(aux_buff) != V_UNDEF)
         Calculate = c_Calculate(aux_buff, nametag_up);
      end;
      
      aux_buff = getValueFromProperty(IncomeData, "CollateralList", nametag_up);
      if(ValType(aux_buff) != V_UNDEF)
         if(ValType(aux_buff) == V_GENOBJ)
            CollateralList = TArray;
            aux_buff = 0;
            while(IncomeData.CollateralList.size > aux_buff)
               CollateralList.value(CollateralList.size) = c_Collateral(IncomeData.CollateralList.value(aux_buff),nametag_up);
               aux_buff = aux_buff + 1;
            end;
         else
            err_txt = string(InErrNotObj, nametag_up, ".CollateralList");
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
         end;
      end;

      aux_buff = getValueFromProperty(IncomeData, "CashFlow", nametag_up);
      if(ValType(aux_buff) != V_UNDEF)
         if(ValType(aux_buff) == V_GENOBJ)
            CashFlow = TArray;
            aux_buff = 0;
            while(IncomeData.CashFlow.size > aux_buff)
               CashFlow.value(CashFlow.size) = c_CashPayment(IncomeData.CashFlow.value(aux_buff), nametag_up);
               aux_buff = aux_buff + 1;
            end;
         else
            err_txt = string(InErrNotObj, nametag_up, ".CashFlow");
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
         end;
      else
         if ( (ValType(DealKind) != V_UNDEF) and (DealKind == "CSA") )
            err_txt = string(ERR_TEXT_NO_IN_MSG, nametag_up, ".CashFlow по сделке CSA");  
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM));
         end;
      end;
      
      aux_buff = getValueFromProperty(IncomeData, "Payments", nametag_up);
      if(ValType(aux_buff) != V_UNDEF)
         Payments = c_Payment(aux_buff, nametag_up);
      else
         if ( (ValType(DealKind) != V_UNDEF) and (DealKind == "IAM") )
            err_txt = string(ERR_TEXT_NO_IN_MSG, nametag_up, ".Payments по сделке IAM");  
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM));
         end;
      end;

/* DEF-13950
      aux_buff = getValueFromProperty(IncomeData, "Amortization", nametag_up);
      if (ValType(aux_buff) != V_UNDEF)
         Amortization = c_Amortization(aux_buff, nametag_up);
      end;
*/

   end; /* macro uInitPrime() */

   uInitPrime(IncomeData, DealKind);
end;

// TOD/TOM/SPOD
private class c_CurrencyDeal(IncomeData)
   var PairsName           : String;   // Код валютной пары                      Нет   Справочник
   var CurrencyDeals       : String;   // Код валюты сделки                      Да    Справочник
   var Netting             : bool;     // признак неттинга                          Нет
   var Rate                : Double;   // Курс сделки                            Да
   var RateDirection       : String;   // Направление курса	                     Нет   "D - прямой I - обратный"
   var RateQutationUnit    : Integer;  // Масштаб курса (количество единиц)      Нет
   var MarginSpot          : Double;   // Маржа                                  Нет
   var PreCon              : String;   // Условия предоплаты                     Нет
   var IsNostro            : bool;     // Признак постановки на НОСТРО позицию   Да
   var IsDerivative        : bool;     // Признак Производного инструмента       Да
   var Bnote               : bool;     // Признак банкнотной сделки              Да
   var Points              : Double;   // Курсовая разница                       Нет
   var Details             : String;   // Детали                                 Нет
   
   var PrecMetal           ;           // Описание металла                       Нет
   var Payments            ;           // Платежи                                Да
   var Fixing              ;
   var PIPayer             : String;   // Идентификатор платежной инструкции плательщика
   var PIReceiver          : String;   // Идентификатор платежной инструкции получателя

   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var err_txt;
      private var aux_buff;
      private var nametag_up = "CurrencyDeal";

      PairsName         = getValueFromProperty(IncomeData, "PairsName"        , nametag_up);
      CurrencyDeals     = getValueFromProperty(IncomeData, "CurrencyDeals"    , nametag_up, true);
      Netting           = getValueFromProperty(IncomeData, "Netting"          , nametag_up);
      Rate              = getValueFromProperty(IncomeData, "Rate"             , nametag_up, true);
      RateDirection     = getValueFromProperty(IncomeData, "RateDirection"    , nametag_up);
      RateQutationUnit  = getValueFromProperty(IncomeData, "RateQutationUnit" , nametag_up);
      MarginSpot        = getValueFromProperty(IncomeData, "MarginSpot"       , nametag_up);
      PreCon            = getValueFromProperty(IncomeData, "PreCon"           , nametag_up);
      IsNostro          = getValueFromProperty(IncomeData, "IsNostro"         , nametag_up, true);
      IsDerivative      = getValueFromProperty(IncomeData, "IsDerivative"     , nametag_up, true);
      Bnote             = getValueFromProperty(IncomeData, "Bnote"            , nametag_up, true);
      Points            = getValueFromProperty(IncomeData, "Points"           , nametag_up);
      Details           = getValueFromProperty(IncomeData, "Details"          , nametag_up);
      PIPayer           = getValueFromProperty(IncomeData, "PIPayer"          , nametag_up);
      PIReceiver        = getValueFromProperty(IncomeData, "PIReceiver"       , nametag_up);

      // проверка по списку значений
      if (ValType(RateDirection) != V_UNDEF)
         if ( (StrUpr(RateDirection) == "D") or (StrUpr(RateDirection) == "I") )
         else
            err_txt = string("Недопустимое значение ", nametag_up, ".RateDirection = ",RateDirection);
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
         end;
      end;
      
      // контейнеры
      aux_buff = getValueFromProperty(IncomeData, "PrecMetal", nametag_up);
      if(ValType(aux_buff) != V_UNDEF)
         PrecMetal = adp_PrecMetal(aux_buff, nametag_up);
      end;
      
      aux_buff = getValueFromProperty(IncomeData, "Payments", nametag_up, true);
      if(ValType(aux_buff) != V_UNDEF)
         Payments = c_Payment(aux_buff, nametag_up);
      end;
      
      aux_buff  = getValueFromProperty(IncomeData, "Fixing", nametag_up);
      if(ValType(aux_buff) != V_UNDEF)
         Fixing = adp_Fixing(aux_buff, nametag_up);
      end;

   end; /* macro uInitPrime() */

   uInitPrime(IncomeData);
   
end;

// ФОРВАРД
private class c_CurrencyFWDDeal(IncomeData)
   var PairsName        : string;   // Код валютной пары                   Да
   var CurrencyDeals    : string;   // Код валюты сделки                   Нет
   var IsNostro         : bool;     //
   var PrecMetal        ;           // Описание металла                    Нет
   var Rate             : Double;   // Курс сделки                         Да
   var RateDirection    : String;   // Направление курса	                  Нет   "D - прямой I - обратный"
   var RateQutationUnit : Integer;  // Масштаб курса (количество единиц)   Нет
   var Netting          : bool;     //   
   var DateTerm         : Date;     // Дата термирования                   Нет
   var PayCurrency      : String;   // Валюта расчетов                     Нет
   var PayRate          : Double;   // Курс расчетов                       Нет
   var PayType          : String;   // Способ исполнения                   Нет    "Расчетный Поставочный"
   var IsDerivative     : bool;     // Признак Производного инструмента    Да
   var Payments         ;           // Платежи                             Да
   var Fixing           ;           // Фиксинг                             Нет
   var PIPayer             : String;   // Идентификатор платежной инструкции плательщика
   var PIReceiver          : String;   // Идентификатор платежной инструкции получателя
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var err_txt;
      private var aux_buff;
      private var nametag_up = "CurrencyFWDDeal";
   
      PairsName         = getValueFromProperty(IncomeData, "PairsName"        , nametag_up, true);
      CurrencyDeals     = getValueFromProperty(IncomeData, "CurrencyDeals"    , nametag_up);
      IsNostro          = getValueFromProperty(IncomeData, "IsNostro"         , nametag_up);
      Rate              = getValueFromProperty(IncomeData, "Rate"             , nametag_up, true);
      RateDirection     = getValueFromProperty(IncomeData, "RateDirection"    , nametag_up);
      RateQutationUnit  = getValueFromProperty(IncomeData, "RateQutationUnit" , nametag_up);
      Netting           = getValueFromProperty(IncomeData, "Netting"          , nametag_up);
      DateTerm          = getValueFromProperty(IncomeData, "DateTerm"         , nametag_up);
      PayCurrency       = getValueFromProperty(IncomeData, "PayCurrency"      , nametag_up);
      PayRate           = getValueFromProperty(IncomeData, "PayRate"          , nametag_up);
      PayType           = getValueFromProperty(IncomeData, "PayType"          , nametag_up);
      IsDerivative      = getValueFromProperty(IncomeData, "IsDerivative"     , nametag_up, true);
      PIPayer           = getValueFromProperty(IncomeData, "PIPayer"          , nametag_up);
      PIReceiver        = getValueFromProperty(IncomeData, "PIReceiver"       , nametag_up);
      
      // проверка по списку значений
      if (ValType(RateDirection) != V_UNDEF)
         if ( (StrUpr(RateDirection) == "D") or (StrUpr(RateDirection) == "I") )
         else
            err_txt = string("Недопустимое значение ", nametag_up, ".RateDirection = ",RateDirection);
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
         end;
      end;
      if(ValType(PayType) != V_UNDEF)
         if ( (StrUpr(PayType) == StrUpr("Расчетный")) or (StrUpr(PayType) == StrUpr("Поставочный")) )
         else
            err_txt = string("Недопустимое значение ", nametag_up, ".PayType = ",PayType);
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
         end;
      end;
      
      // контейнеры
      aux_buff  = getValueFromProperty(IncomeData, "PrecMetal", nametag_up);
      if(ValType(aux_buff) != V_UNDEF)
         PrecMetal = adp_PrecMetal(aux_buff, nametag_up);
      end;
      
      aux_buff  = getValueFromProperty(IncomeData, "Payments", nametag_up, true);
      if(ValType(aux_buff) != V_UNDEF)
         Payments = c_Payment(aux_buff, nametag_up);
      end;
      
      aux_buff  = getValueFromProperty(IncomeData, "Fixing", nametag_up);
      if(ValType(aux_buff) != V_UNDEF)
         Fixing = adp_Fixing(aux_buff, nametag_up);
      end;

   end; /* macro uInitPrime() */

   uInitPrime(IncomeData);
   
end;

// SWAP
private class c_CurrencySWAPDeal(IncomeData)
   var PairsName        : string;      // Код валютной пары                   Да
   var CurrencyDeals    : string;      // Код валюты сделки                   Нет
   var IsNostro         : bool;        //                                     Да
   var IsDerivative     : bool;        // Признак Производного инструмента    Нет
   var LegsDealsList    ;              // Нога сделки                         Да

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var err_txt;
      private var aux_buff;
      private var nametag_up = "CurrencySWAPDeal";

      PairsName      = getValueFromProperty(IncomeData, "PairsName"     , nametag_up, true);
      CurrencyDeals  = getValueFromProperty(IncomeData, "CurrencyDeals" , nametag_up);
      IsNostro       = getValueFromProperty(IncomeData, "IsNostro"      , nametag_up, true);
      IsDerivative   = getValueFromProperty(IncomeData, "IsDerivative"  , nametag_up);
            
      aux_buff = getValueFromProperty(IncomeData, "LegsDealsList", nametag_up, true);
      if(ValType(aux_buff) != V_UNDEF)
         if(ValType(aux_buff) == V_GENOBJ)
            LegsDealsList = TArray;
            aux_buff = 0;
            while(IncomeData.LegsDealsList.size > aux_buff)
               LegsDealsList.value(LegsDealsList.size) = adp_LegsDeal(IncomeData.LegsDealsList.value(aux_buff), nametag_up);
               aux_buff = aux_buff + 1;
            end;
         else
            err_txt = string(InErrNotObj, nametag_up, ".LegsDealsList");
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
         end;
      end;
   
   end; /* macro uInitPrime() */

   uInitPrime(IncomeData);
end;

// ОПЦИОН
private class c_CurrencyOptionDeal(IncomeData)
   var OptType             : String;   // тип сделки опциона FX OTC CAP       Да
   var PairsName           : String;   // Код валютной пары                   Нет
   var Underlying          : String;   // Базовый актив 1 - Акция 2 - Индекс 3 - Валюта                   Нет
   var Currency            : String;   // Валюта опцион                       Нет
   var ExecMethod          : String;   // Способ исполнения                   Нет
   var OptionType          : String;   // Тип опциона                         Да
   var ExerciseType        : String;   // Стиль опциона                       Нет
   var ValuationType       : String;   // Дополнительные условия контракта    Да
   var BaseCurr            : String;   // Код базовой валюты/ДМ               Нет
   var BaseAmount          : double;   // Сумма в базовой валюте              Нет
   var CounterCurr         : String;   // Код контрвалюты/ДМ                  Нет
   var CounterAmount       : double;   // Сумма в контрвалюте                 Нет
   var IsNostro            : bool;     //                                     Нет
   var BonusDate           : date;     // Дата уплаты премии                  Да
   var BonusType           : string;   // Тип оплаты премии с суммы или процентов      Нет
   var BonusCurr           : String;   // Валюта премии                       Нет
   var BonusAmount         : double;   // Сумма премии                        Нет
   var MaturityDate        : date;     // Дата исполнения сделки (дата экспирации сделки)
   var SettlementDate      : date;     // Дата поставки
   var FixDate             : date;     // Дата расчетов
   var Strike              : double;   // Дата расчетов                       Нет
   var SpotRate            : double;   // Спот курс (цена исполнения)         Нет
   var IsDerivative        : bool;     // Признак Производного инструмента    Нет
   var RateBonus           : double;   // Курс пересчета премии валюты на контр валюту   Нет
   var MarginClientCurr    : string;   // Валюта маржи клиента                           Нет
   var MarginClientAmount  : double;   // Сумма/количество едениц маржи клиента          Нет
   var CorpAmmountCurr     : string;   // Валюта маржи клиента                           Нет
   var CorpAmmount         : double;   // Сумма/количество едениц маржи клиента          Нет
   var UnderPriceCurr      : string;   // Валюта нижнего курса                           Нет
   var UnderPrice          : double;   // Нижний курс                                    Нет
   var BonusCount          : double;   // Количество едениц премии                       Нет
   var PremiumProc         : double;   // Процент премии
   var GrossAmount         : double;   // Сумма премии
   var RateFloatKind       : string;   // % ставки 
   var RateFloatShortName  : string;   // Краткое наименование плавающей ставки
   var RateFloatFullName   : string;   // Полное наименование плавающей ставки 
   var RateFloatDev        : string;   // Отклонение от % ставки (для плаваюшей ставки)
   var Frequency           : string;   // Периодичность    M - месяц W - неделя D - ежедневно E - в конце срока Y - годовой.... 
   var FrequencyFix        : string;   // Частота фиксации M - месяц W - неделя D - ежедневно E - в конце срока Y - годовой.... 
   var Basis               : string;   // Базис РЕПО 
   var FirstCouponDate     : date;     // Дата первого купона 
   var FirstCouponRate     : double;   // Дата первой % ставки купона 
   var LastCouponRate      : double;   // Дата последней % ставки купона 
   var PayMode             : string;   // Тип платежей Flat  Schedule
   var Quantity            : double;   // Количество бумаг
   var EqInd;
   var Liquidation;
   var Exotic;
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var err_txt;
      private var aux_buff;
      private var nametag_up = "CurrencyOptionDeal";

      OptType           = getValueFromProperty(IncomeData, "OptType"             , nametag_up, true);
      PairsName         = getValueFromProperty(IncomeData, "PairsName"           , nametag_up);
      Underlying        = getValueFromProperty(IncomeData, "Underlying"          , nametag_up);
      Currency          = getValueFromProperty(IncomeData, "Currency"            , nametag_up);
      ExecMethod        = getValueFromProperty(IncomeData, "ExecMethod"          , nametag_up);
      OptionType        = getValueFromProperty(IncomeData, "OptionType"          , nametag_up, true);
      ExerciseType      = getValueFromProperty(IncomeData, "ExerciseType"        , nametag_up);
      ValuationType     = getValueFromProperty(IncomeData, "ValuationType"       , nametag_up, true);
      BaseCurr          = getValueFromProperty(IncomeData, "BaseCurr"            , nametag_up);
      BaseAmount        = getValueFromProperty(IncomeData, "BaseAmount"          , nametag_up);
      CounterCurr       = getValueFromProperty(IncomeData, "CounterCurr"         , nametag_up);
      CounterAmount     = getValueFromProperty(IncomeData, "CounterAmount"       , nametag_up);
      IsNostro          = getValueFromProperty(IncomeData, "IsNostro"            , nametag_up);
      BonusDate         = getValueFromProperty(IncomeData, "BonusDate"           , nametag_up, true);
      BonusType         = getValueFromProperty(IncomeData, "BonusType"           , nametag_up);
      BonusCurr         = getValueFromProperty(IncomeData, "BonusCurr"           , nametag_up);
      BonusAmount       = getValueFromProperty(IncomeData, "BonusAmount"         , nametag_up);
      MaturityDate      = getValueFromProperty(IncomeData, "MaturityDate"        , nametag_up);
      SettlementDate    = getValueFromProperty(IncomeData, "SettlementDate"      , nametag_up);
      FixDate           = getValueFromProperty(IncomeData, "FixDate"             , nametag_up);
      Strike            = getValueFromProperty(IncomeData, "Strike"              , nametag_up);
      SpotRate          = getValueFromProperty(IncomeData, "SpotRate"            , nametag_up);
      IsDerivative      = getValueFromProperty(IncomeData, "IsDerivative"        , nametag_up);
      RateBonus         = getValueFromProperty(IncomeData, "RateBonus"           , nametag_up);
      MarginClientCurr  = getValueFromProperty(IncomeData, "MarginClientCurr"    , nametag_up);
      MarginClientAmount= getValueFromProperty(IncomeData, "MarginClientAmount"  , nametag_up);
      CorpAmmountCurr   = getValueFromProperty(IncomeData, "CorpAmmountCurr"     , nametag_up);
      CorpAmmount       = getValueFromProperty(IncomeData, "CorpAmmount"         , nametag_up);
      UnderPriceCurr    = getValueFromProperty(IncomeData, "UnderPriceCurr"      , nametag_up);
      UnderPrice        = getValueFromProperty(IncomeData, "UnderPrice"          , nametag_up);
      BonusCount        = getValueFromProperty(IncomeData, "BonusCount"          , nametag_up);
      PremiumProc       = getValueFromProperty(IncomeData, "PremiumProc"         , nametag_up);
      GrossAmount       = getValueFromProperty(IncomeData, "GrossAmount"         , nametag_up);
      RateFloatKind     = getValueFromProperty(IncomeData, "RateFloatKind"       , nametag_up);
      RateFloatShortName= getValueFromProperty(IncomeData, "RateFloatShortName"  , nametag_up);
      RateFloatFullName = getValueFromProperty(IncomeData, "RateFloatFullName"   , nametag_up);
      RateFloatDev      = getValueFromProperty(IncomeData, "RateFloatDev"        , nametag_up);
      Frequency         = getValueFromProperty(IncomeData, "Frequency"           , nametag_up);
      FrequencyFix      = getValueFromProperty(IncomeData, "FrequencyFix"        , nametag_up);
      Basis             = getValueFromProperty(IncomeData, "Basis"               , nametag_up);
      FirstCouponDate   = getValueFromProperty(IncomeData, "FirstCouponDate"     , nametag_up);
      FirstCouponRate   = getValueFromProperty(IncomeData, "FirstCouponRate"     , nametag_up);
      LastCouponRate    = getValueFromProperty(IncomeData, "LastCouponRate"      , nametag_up);
      PayMode           = getValueFromProperty(IncomeData, "PayMode"             , nametag_up);
      Quantity          = getValueFromProperty(IncomeData, "Quantity"            , nametag_up);
     
      // проверка по списку значений
      if (ValType(OptType) != V_UNDEF)
         if ( (OptType == "FX") or (OptType == "OTC") or (OptType == "CAP") )
         else
            err_txt = string("Недопустимое значение ", nametag_up, ".OptType = ",OptType);
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
         end;
      end;
      
      if (ValType(Underlying) != V_UNDEF)
         if ( (Underlying == 1) or (Underlying == 2) or (Underlying == 3) )
         else
            err_txt = string("Недопустимое значение ", nametag_up, ".Underlying = ",Underlying);
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
         end;
      end;
      
      if (ValType(PayMode) != V_UNDEF)
         if ( (PayMode =="Flat") or (PayMode == "Schedule") )
         else
            err_txt = string("Недопустимое значение ", nametag_up, ".PayMode = ",PayMode);
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
         end;
      end;

      // контейнеры
      aux_buff  = getValueFromProperty(IncomeData, "EqInd", nametag_up);
      if(ValType(aux_buff) != V_UNDEF)
         EqInd = c_EqInt_Option(aux_buff, nametag_up);
      end;
      
      aux_buff  = getValueFromProperty(IncomeData, "Liquidation", nametag_up);
      if(ValType(aux_buff) != V_UNDEF)
         Liquidation = c_Liquidation_Option(aux_buff, nametag_up);
      end;
      
      aux_buff  = getValueFromProperty(IncomeData, "Exotic", nametag_up);
      if(ValType(aux_buff) != V_UNDEF)
         Exotic = c_Exotic_Option(aux_buff, nametag_up);
      end;
      
   end; /* macro uInitPrime() */

   uInitPrime(IncomeData);
   
end;

// Процентный ФОРВАРД
private class c_FRADeal(IncomeData)
   var IsDerivative        : bool;     // Признак Производного инструмента       Да
   var IsNostro            : bool;     // 
   var ValueDate           : date;     // Дата валютирования                     Да
   var MaturityDate        : date;     // Дата расчетов                          Нет
   var FixDate             : date;     // Дата фиксинга                          Нет
   var CurrencyDeals       : string;   // Код валюты сделки                      Да
   var Amount              : double;   // Сумма сделки                           Да
   var ContractRate        : double;   // % ставка по сделке                     Нет
   var RateFloatKind       : string;   // Тип плавающей % ставки                 Нет
   var RateFloatShortName  : string;   // Краткое наименование плавающей ставки  Нет
   var RateFloatFullName   : string;   // Полное наименование плавающей ставки   Нет
   var RateFloatType       : string;   
   var IsMatutity          : bool;     // Признак экспирации                     Нет
   var Matutity            ;
   var Fixing              ;
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var nametag_up = "FraDeal";
      private var aux_buff;

      IsDerivative         = getValueFromProperty(IncomeData, "IsDerivative"        , nametag_up, true);
      IsNostro             = getValueFromProperty(IncomeData, "IsNostro"            , nametag_up);
      ValueDate            = getValueFromProperty(IncomeData, "ValueDate"           , nametag_up, true);
      MaturityDate         = getValueFromProperty(IncomeData, "MaturityDate"        , nametag_up);
      FixDate              = getValueFromProperty(IncomeData, "FixDate"             , nametag_up);
      CurrencyDeals        = getValueFromProperty(IncomeData, "CurrencyDeals"       , nametag_up, true);
      Amount               = getValueFromProperty(IncomeData, "Amount"              , nametag_up, true);
      ContractRate         = getValueFromProperty(IncomeData, "ContractRate"        , nametag_up);
      RateFloatKind        = getValueFromProperty(IncomeData, "RateFloatKind"       , nametag_up);
      RateFloatShortName   = getValueFromProperty(IncomeData, "RateFloatShortName"  , nametag_up);
      RateFloatFullName    = getValueFromProperty(IncomeData, "RateFloatFullName"   , nametag_up);
      RateFloatType        = getValueFromProperty(IncomeData, "RateFloatType"       , nametag_up);
      IsMatutity           = getValueFromProperty(IncomeData, "IsMatutity"          , nametag_up);
      
      aux_buff  = getValueFromProperty(IncomeData, "Matutity", nametag_up);
      if(ValType(aux_buff) != V_UNDEF)
         Matutity = adp_Matutity(aux_buff, nametag_up);
      end;
      
      aux_buff  = getValueFromProperty(IncomeData, "Fixing", nametag_up);
      if(ValType(aux_buff) != V_UNDEF)
         Fixing = adp_Fixing(aux_buff, nametag_up);
      end;
   end; /* macro uInitPrime() */

   uInitPrime(IncomeData);
   
end;

// IRS/CIRS
private class c_IRSSWAPDeal(IncomeData)
   var IsNostro            : bool;
   var IsDerivative        : bool;     // Признак Производного инструмента                Да
   var DateBegin           : date;     // Дата начала сделки                              Да
   var DateMatunity        : date;     // Дата завершения сделки                          Нет
   var DateTerm            : date;     // Дата термирования                               Нет
   var TermType            : string;   // Тип термирования                                Нет      "L = досрочное закрытие сделки A = перевод на другого контрагента "
   var DealRelation        : string;   // Номер связанной сделки                          Нет
   var TermPrematureType   : string;   // Вид досрочного закрытия                         Нет      "P = частичное T = полное"
   var TermAmount          : double;   // Сумма досрочного погашения                      Нет
   var TermDatePay         : date;     // Дата расчетов по сделке (выполнения платежа)    Нет
   var TermDatePers        : date;     // Дата расчета процентов                          Нет
   var TermClFee           : double;   // Сумма выплачиваемых процентов                   Нет
   var TermAccrued         : integer;  // Начисленных процентов                           Нет
   var TermNpv             : double;
   var PartList            ;           // Части сделки                                    Да
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var nametag_up = "IRSSWAPDeal";
      private var aux_buff;
      private var err_txt;

      IsNostro          = getValueFromProperty(IncomeData, "IsNostro"            , nametag_up, true);
      IsDerivative      = getValueFromProperty(IncomeData, "IsDerivative"        , nametag_up, true);
      DateBegin         = getValueFromProperty(IncomeData, "DateBegin"           , nametag_up, true);
      DateMatunity      = getValueFromProperty(IncomeData, "DateMatunity"        , nametag_up);
      DateTerm          = getValueFromProperty(IncomeData, "DateTerm"            , nametag_up);
      TermType          = getValueFromProperty(IncomeData, "TermType"            , nametag_up);
      DealRelation      = getValueFromProperty(IncomeData, "DealRelation"        , nametag_up);
      TermPrematureType = getValueFromProperty(IncomeData, "TermPrematureType"   , nametag_up);
      TermAmount        = getValueFromProperty(IncomeData, "TermAmount"          , nametag_up);
      TermDatePay       = getValueFromProperty(IncomeData, "TermDatePay"         , nametag_up);
      TermDatePers      = getValueFromProperty(IncomeData, "TermDatePers"        , nametag_up);
      TermClFee         = getValueFromProperty(IncomeData, "TermClFee"           , nametag_up);
      TermAccrued       = getValueFromProperty(IncomeData, "TermAccrued"         , nametag_up);
      TermNpv           = getValueFromProperty(IncomeData, "TermNpv"             , nametag_up);
      
      // проверка по списку значений
      if(ValType(TermType) != V_UNDEF)
         if ( (StrUpr(TermType) == "L") or (StrUpr(TermType) == "A") )
         else
            err_txt = string("Недопустимое значение ", nametag_up ,".TermType = ",TermType);
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
         end;
      end;
      if(ValType(TermPrematureType) != V_UNDEF)
         if ( (StrUpr(TermPrematureType) == "P") or (StrUpr(TermPrematureType) == "T") )
         else
            err_txt = string("Недопустимое значение ", nametag_up ,".TermPrematureType = ",TermPrematureType);
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
         end;
      end;
      
      aux_buff = getValueFromProperty(IncomeData, "PartList", nametag_up, true); 
      if(ValType(aux_buff) != V_UNDEF)
         if(ValType(aux_buff) == V_GENOBJ)
            PartList = TArray;
            aux_buff = 0;
            while(IncomeData.PartList.size > aux_buff)
               PartList.value(PartList.size) = c_PartList_IRS(IncomeData.PartList.value(aux_buff), nametag_up);
               aux_buff = aux_buff + 1;
            end;
         else
            err_txt = string(InErrNotObj, nametag_up, ".PartList");
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
         end;
      end;

   end; /* macro uInitPrime() */

   uInitPrime(IncomeData);
   
end;

// РЕПО (ЦБ)
private class c_REPODeal(IncomeData)
   var CouponTo      : string;   // Получатель купона  Seller   Buyer      Нет
   var CurrencyDeals : string;   // Код валюты сделки                      Нет
   var SettlType     : string;   // Способ расчетов по сделке              Да
   var TradingPlace  : string;   // Место сделки                           Нет
   var MethodPrice   : string;   // Метод расчетов                         Нет
   var IsNostro      : bool;     // признак постановки на ностро позицию   Нет
   var AmCount       : double;   // Номинальная стоимость бумаг /облигаций Нет
   var Quantity      : double;   // Количество бумаг / облигаций           Да
   var HairCutPRC    : double;   // Процент дисконт
   var Haircut       : double;   // Процент дисконта за 1 бумагу / облигацию
   var FixRate       : double;   // Фиксированная ставка по сделке 
   var Margin        : double;   // Маржа
   var Basis         : string;   // Базис РЕПО
   var TypeDeal      : integer;  // Направление    1 - прямое репо 2 - обратное репо  
   var TypeRepo      : integer;  // Направление    1 - Классическое  2 - B/S-Back  
   var Securities;
   var LegsDealsList; 
   var Details;
  
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var aux_buff;
      private var nametag_up = "REPODeal";
      
      if(ValType(IncomeData) != V_UNDEF)
         CouponTo       = getValueFromProperty(IncomeData, "CouponTo"      , nametag_up); 
         CurrencyDeals  = getValueFromProperty(IncomeData, "CurrencyDeals" , nametag_up);
         SettlType      = getValueFromProperty(IncomeData, "SettlType"     , nametag_up, true);
         TradingPlace   = getValueFromProperty(IncomeData, "TradingPlace"  , nametag_up);
         MethodPrice    = getValueFromProperty(IncomeData, "MethodPrice"   , nametag_up);
         IsNostro       = getValueFromProperty(IncomeData, "IsNostro"      , nametag_up);
         AmCount        = getValueFromProperty(IncomeData, "AmCount"       , nametag_up);
         Quantity       = getValueFromProperty(IncomeData, "Quantity"      , nametag_up, true);
         Haircut        = getValueFromProperty(IncomeData, "Haircut"       , nametag_up);
         HairCutPRC     = getValueFromProperty(IncomeData, "HairCutPRC"    , nametag_up);
         FixRate        = getValueFromProperty(IncomeData, "FixRate"       , nametag_up);
         Margin         = getValueFromProperty(IncomeData, "Margin"        , nametag_up);
         Basis          = getValueFromProperty(IncomeData, "Basis"         , nametag_up);
         TypeDeal       = getValueFromProperty(IncomeData, "TypeDeal"      , nametag_up, true); 
         TypeRepo       = getValueFromProperty(IncomeData, "TypeRepo"      , nametag_up);

         // проверка по списку значений
         if (ValType(TypeDeal) != V_UNDEF)
            if ( (TypeDeal == 1) or (TypeDeal == 2) )
            else
               err_txt = string("Недопустимое значение ", nametag_up, ".TypeDeal = ",TypeDeal);
               RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
            end;
         end;

         aux_buff = getValueFromProperty(IncomeData, "Securities", nametag_up); 
         if(ValType(aux_buff) != V_UNDEF)
            Securities = adp_Securities(aux_buff, nametag_up);
         end;

         aux_buff = getValueFromProperty(IncomeData, "Details", nametag_up); 
         if(ValType(aux_buff) != V_UNDEF)
            Details = c_Details_REPO(aux_buff, nametag_up);
         end;
         
         aux_buff = getValueFromProperty(IncomeData, "LegsDealsList", nametag_up, true); 
         if(ValType(aux_buff) != V_UNDEF)
            if(ValType(aux_buff) == V_GENOBJ)
               LegsDealsList = TArray;
               aux_buff = 0;
               while(IncomeData.LegsDealsList.size > aux_buff)
                  LegsDealsList.value(LegsDealsList.size) = c_LegsDeal_REPO(IncomeData.LegsDealsList.value(aux_buff), nametag_up);
                  aux_buff = aux_buff + 1;
               end;
            end;
         end;
         if (LegsDealsList.size < 2)
            err_txt = string("Недопустимое количество ног по сделке РЕПО: ", LegsDealsList.size);
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
         end;
         
      end;
         
   end; /* macro uInitPrime() */

   uInitPrime(IncomeData);
   
end;

// Покупка/продажа ЦБ
private class c_CurrencyEquityDeal(IncomeData)
   var Currency         : string;   // Код валюты сделки          Нет
   var Quantity         : integer;  // Количество ЦБ              Да
   var Price            : double;   // Цена                       Да
   var Amount           : double;   // Сумма сделки 
   var TradeDate        : date;     // Дата сделки 
   var SettlementDate   : date;     // Дата поставки 
   var PaymentDate      : date;     // Дата платежа
   var ClearingMode     : string; 
   var ClearingModeName : string;   // Код депозитария 
   var SettlSheme       : string; 
   
   var Securities    ;  // Ценная бумага              Нет
   var Saller        ;
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var aux_buff;
      private var nametag_up = "EquityDeal";
      
      if(ValType(IncomeData) != V_UNDEF)
         Currency          = getValueFromProperty(IncomeData, "Currency"         , nametag_up); 
         Quantity          = getValueFromProperty(IncomeData, "Quantity"         , nametag_up, true);
         Price             = getValueFromProperty(IncomeData, "Price"            , nametag_up, true);
         Amount            = getValueFromProperty(IncomeData, "Amount"           , nametag_up);
         TradeDate         = getValueFromProperty(IncomeData, "TradeDate"        , nametag_up);
         SettlementDate    = getValueFromProperty(IncomeData, "SettlementDate"   , nametag_up);
         PaymentDate       = getValueFromProperty(IncomeData, "PaymentDate"      , nametag_up);
         ClearingMode      = getValueFromProperty(IncomeData, "ClearingMode"     , nametag_up);
         ClearingModeName  = getValueFromProperty(IncomeData, "ClearingModeName" , nametag_up);
         SettlSheme        = getValueFromProperty(IncomeData, "SettlSheme"       , nametag_up);
         

         aux_buff = getValueFromProperty(IncomeData, "Securities", nametag_up); 
         if(ValType(aux_buff) != V_UNDEF)
            Securities = adp_Securities(aux_buff, nametag_up);
         end;
         
         aux_buff = getValueFromProperty(IncomeData, "Saller", nametag_up); 
         if(ValType(aux_buff) != V_UNDEF)
            Saller = c_Saller_Equity(aux_buff, nametag_up);
         end;

      end;
         
   end; /* macro uInitPrime() */

   uInitPrime(IncomeData);
end;

// BOND
private class c_BondDeal(IncomeData)
   var CurrencyDeals    : string;   // Код валюты сделки                Нет
   var IsNostro         : bool;     
   var Number           : integer;  // Количество ЦБ                    Да
   var Amount           : double;   // Сумма сделки                     Да
   var Depositary       : string;   // Депозитарий                      Нет
   var NominalType      : string;   // Тип номинала                     Да       "текущий исходный"
   var PriceNominal     : double;   // Номинальная стоимость            Да
   var PricePrc         : double;   // Цена в % относительно номинала   Нет
   var YeldPrc          : double;   // Доходность в %                   Нет
   var CouponAmount     : double;   // Сумма по купону                  Нет
   var CouponPrc        : double;   // % по купону                      Нет
   var ValueDate        : date;     // Дата валютирования               Да
   var PayDate          : date;     // Дата платежа                     Да
   var DelivDate        : date;     // Дата поставки                    Да
   var MarginPrc        : double;   // Маржа в %                        Нет
   var Purposes         : string;   // Назначение                       Нет
   var Securities       ;           // Ценная бумага                    Нет

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var err_txt;
      private var aux_buff;
      var nametag_up = "BondDeal";
      
      if(ValType(IncomeData) != V_UNDEF)
         CurrencyDeals     = getValueFromProperty(IncomeData, "CurrencyDeals" , nametag_up);
         IsNostro          = getValueFromProperty(IncomeData, "IsNostro"      , nametag_up);
         Number            = getValueFromProperty(IncomeData, "Number"        , nametag_up, true);
         Amount            = getValueFromProperty(IncomeData, "Amount"        , nametag_up, true);
         Depositary        = getValueFromProperty(IncomeData, "Depositary"    , nametag_up);
         NominalType       = getValueFromProperty(IncomeData, "NominalType"   , nametag_up, true); 
         PriceNominal      = getValueFromProperty(IncomeData, "PriceNominal"  , nametag_up, true); 
         PricePrc          = getValueFromProperty(IncomeData, "PricePrc"      , nametag_up);
         YeldPrc           = getValueFromProperty(IncomeData, "YeldPrc"       , nametag_up);
         CouponAmount      = getValueFromProperty(IncomeData, "CouponAmount"  , nametag_up);
         CouponPrc         = getValueFromProperty(IncomeData, "CouponPrc"     , nametag_up);
         ValueDate         = getValueFromProperty(IncomeData, "ValueDate"     , nametag_up, true); 
         PayDate           = getValueFromProperty(IncomeData, "PayDate"       , nametag_up, true); 
         DelivDate         = getValueFromProperty(IncomeData, "DelivDate"     , nametag_up, true); 
         MarginPrc         = getValueFromProperty(IncomeData, "MarginPrc"     , nametag_up); 
         Purposes          = getValueFromProperty(IncomeData, "Purposes"      , nametag_up); 

         // проверка по списку значений
         if (ValType(NominalType) != V_UNDEF)
            if ( (StrUpr(NominalType) == StrUpr("текущий")) or (StrUpr(NominalType) == StrUpr("исходный")) )
            else
               err_txt = string("Недопустимое значение ", nametag_up, ".NominalType = ",NominalType);
               RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
            end;
         end;
         
         // контейнер
         aux_buff = getValueFromProperty(IncomeData, "Securities", nametag_up); 
         if(ValType(aux_buff) != V_UNDEF)
            Securities = adp_Securities(aux_buff, nametag_up);
         end;
      end;
      
   end; /* macro uInitPrime() */

   uInitPrime(IncomeData);
   
end;

// платеж CSA 
private class c_MarginCall(IncomeData)
   var Currency         : string;   // Валюта сделки  Да
   var Amount           : double;   // Сумма сделки   Да
   var TradeDate        : date;     // Дата сделки    Да
   var SettlementDate   : date;     // Дата поставки  Нет
   var MCType           : string;   // Тип Margin Call: Простой Margin Call / Выплата процентов / Капитализация процентов / Не производится / Ставки отличаются" Нет 
   var Rate             : string;   // % ставка       Нет
   var Portfolio        : string;   // Портфель       Нет
   var Contract         : string;   // Договор        Нет 
   var Object_Id        : string;   // BIQ-5049       Нет Идентификатор объекта требований по марже

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var err_txt;
      private var aux_buff;
      var nametag_up = "MarginCallDeal";
      
      if(ValType(IncomeData) != V_UNDEF)
         Currency          = getValueFromProperty(IncomeData, "Currency"         , nametag_up, true);
         Amount            = getValueFromProperty(IncomeData, "Amount"           , nametag_up, true);
         TradeDate         = getValueFromProperty(IncomeData, "TradeDate"        , nametag_up, true);
         SettlementDate    = getValueFromProperty(IncomeData, "SettlementDate"   , nametag_up);
         MCType            = getValueFromProperty(IncomeData, "MCType"           , nametag_up);
         Rate              = getValueFromProperty(IncomeData, "Rate"             , nametag_up);
         Portfolio         = getValueFromProperty(IncomeData, "Portfolio"        , nametag_up);
         Contract          = getValueFromProperty(IncomeData, "Contract"         , nametag_up);
         Object_Id         = getValueFromProperty(IncomeData, "Object_Id"        , nametag_up);
      end;
      
   end; /* macro uInitPrime() */

   uInitPrime(IncomeData);
   
end;

// СВОПОПЦИОН
private class c_CurrencySWAPOptionDeal(IncomeData)
   var OptType             : String;   // тип сделки опциона FX OTC CAP       Да
   var Currency            : String;   // Валюта опцион                       Нет
   var OptionType          : String;   // Тип опциона                         Да
   var ValuationType       : String;   // Дополнительные условия контракта    Да
   var BaseAmount          : double;   // Сумма в базовой валюте              Нет
   var IsNostro            : bool;     //                                     Нет
   var BonusDate           : date;     // Дата уплаты премии                  Да
   var MaturityDate        : date;     // Дата исполнения сделки (дата экспирации сделки)
   var FixDate             : date;     // Дата расчетов
   var Strike              : double;   // Дата расчетов                       Нет
   var IsDerivative        : bool;     // Признак Производного инструмента    Нет
   var PremiumProc         : double;   // Процент премии
   var RateFloatKind       : string;   // % ставки 
   var RateFloatShortName  : string;   // Краткое наименование плавающей ставки
   var RateFloatFullName   : string;   // Полное наименование плавающей ставки 
   var RateFloatDev        : string;   // Отклонение от % ставки (для плаваюшей ставки)
   var Frequency           : string;   // Периодичность    M - месяц W - неделя D - ежедневно E - в конце срока Y - годовой.... 
   var FrequencyFix        : string;   // Частота фиксации M - месяц W - неделя D - ежедневно E - в конце срока Y - годовой.... 
   var Basis               : string;   // Базис РЕПО 
   var FirstCouponDate     : date;     // Дата первого купона 
   var FirstCouponRate     : double;   // Дата первой % ставки купона 
   var LastCouponRate      : double;   // Дата последней % ставки купона 
   var PayMode             : string;   // Тип платежей Flat  Schedule
   var Liquidation;
   var LegsDealsList    ;              // Нога сделки                         Да

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var err_txt;
      private var aux_buff;
      private var nametag_up = "CurrencySWAPOptionDeal";

      OptType           = getValueFromProperty(IncomeData, "OptType"             , nametag_up, true);
      Currency          = getValueFromProperty(IncomeData, "Currency"            , nametag_up);
      OptionType        = getValueFromProperty(IncomeData, "OptionType"          , nametag_up, true);
      ValuationType     = getValueFromProperty(IncomeData, "ValuationType"       , nametag_up, true);
      BaseAmount        = getValueFromProperty(IncomeData, "BaseAmount"          , nametag_up);
      IsNostro          = getValueFromProperty(IncomeData, "IsNostro"            , nametag_up);
      BonusDate         = getValueFromProperty(IncomeData, "BonusDate"           , nametag_up, true);
      MaturityDate      = getValueFromProperty(IncomeData, "MaturityDate"        , nametag_up);
      FixDate           = getValueFromProperty(IncomeData, "FixDate"             , nametag_up);
      Strike            = getValueFromProperty(IncomeData, "Strike"              , nametag_up);
      IsDerivative      = getValueFromProperty(IncomeData, "IsDerivative"        , nametag_up);
      PremiumProc       = getValueFromProperty(IncomeData, "PremiumProc"         , nametag_up);
      RateFloatKind     = getValueFromProperty(IncomeData, "RateFloatKind"       , nametag_up);
      RateFloatShortName= getValueFromProperty(IncomeData, "RateFloatShortName"  , nametag_up);
      RateFloatFullName = getValueFromProperty(IncomeData, "RateFloatFullName"   , nametag_up);
      RateFloatDev      = getValueFromProperty(IncomeData, "RateFloatDev"        , nametag_up);
      Frequency         = getValueFromProperty(IncomeData, "Frequency"           , nametag_up);
      FrequencyFix      = getValueFromProperty(IncomeData, "FrequencyFix"        , nametag_up);
      Basis             = getValueFromProperty(IncomeData, "Basis"               , nametag_up);
      FirstCouponDate   = getValueFromProperty(IncomeData, "FirstCouponDate"     , nametag_up);
      FirstCouponRate   = getValueFromProperty(IncomeData, "FirstCouponRate"     , nametag_up);
      LastCouponRate    = getValueFromProperty(IncomeData, "LastCouponRate"      , nametag_up);
      PayMode           = getValueFromProperty(IncomeData, "PayMode"             , nametag_up);
     
      // проверка по списку значений
      if (ValType(OptType) != V_UNDEF)
         if ( (OptType == "FX") or (OptType == "OTC") or (OptType == "CAP") )
         else
            err_txt = string("Недопустимое значение ", nametag_up, ".OptType = ",OptType);
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
         end;
      end;
      
      if (ValType(PayMode) != V_UNDEF)
         if ( (PayMode =="Flat") or (PayMode == "Schedule") )
         else
            err_txt = string("Недопустимое значение ", nametag_up, ".PayMode = ",PayMode);
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR)); 
         end;
      end;

      // контейнеры
      aux_buff  = getValueFromProperty(IncomeData, "Liquidation", nametag_up);
      if(ValType(aux_buff) != V_UNDEF)
         Liquidation = c_Liquidation_Option(aux_buff, nametag_up);
      end;
      
      aux_buff = getValueFromProperty(IncomeData, "LegsDealsList", nametag_up, true);
      if(ValType(aux_buff) != V_UNDEF)
         if(ValType(aux_buff) == V_GENOBJ)
            LegsDealsList = TArray;
            aux_buff = 0;
            while(IncomeData.LegsDealsList.size > aux_buff)
               LegsDealsList.value(LegsDealsList.size) = adp_LegsDeal(IncomeData.LegsDealsList.value(aux_buff), nametag_up);
               aux_buff = aux_buff + 1;
            end;
         else
            err_txt = string(InErrNotObj, nametag_up, ".LegsDealsList");
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
         end;
      end;
      
   end; /* macro uInitPrime() */

   uInitPrime(IncomeData);
   
end;

// содержание сделки
private class c_DealData(IncomeData, DealKind, DealID)
   private var err_txt;
   private var aux_buff;
   
   var CurrencyDeal = NULL;
   var CurrencyFWDDeal = NULL;
   var CurrencySWAPDeal = NULL;
   var CurrencyOptionDeal = NULL;
   var FRADeal = NULL;
   var IRSSWAPDeal = NULL;
   var IAMLDDeal = NULL;
   var REPODeal = NULL;
   var CurrencyEquityDeal = NULL;
   var BondDeal = NULL;
   var MarginCallDeal = NULL;
   var CurrencySWAPOptionDeal = NULL;
   
   aux_buff = uTryToGetPropS(IncomeData, "CurrencyDeal");
   if (ValType(aux_buff) != V_UNDEF)
      CurrencyDeal = c_CurrencyDeal(aux_buff);
   else
      if ( (DealKind == "BNKT") or (DealKind == "SPOT") or (DealKind == "TOD") or (DealKind == "TOM") 

          )
         err_txt = ERR_TEXT_NO_IN_MSG +": CurrencyDeal для DealKind="+DealKind;
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM));
      end;
   end;

   aux_buff = uTryToGetPropS(IncomeData, "CurrencyFWDDeal");
   if (ValType(aux_buff) != V_UNDEF)
      CurrencyFWDDeal = c_CurrencyFWDDeal(aux_buff);
   else
      if (DealKind == "FWD") 
         err_txt = ERR_TEXT_NO_IN_MSG +": CurrencyFWDDeal для DealKind="+DealKind;
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM));
      end;
   end;

   aux_buff = uTryToGetPropS(IncomeData, "CurrencySWAPDeal");
   if (ValType(aux_buff) != V_UNDEF)
      CurrencySWAPDeal = c_CurrencySWAPDeal(aux_buff);
   else
      if (DealKind == "SWAP")
         err_txt = ERR_TEXT_NO_IN_MSG +": CurrencySWAPDeal для DealKind="+DealKind;
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM));
      end;
   end;  
   
   aux_buff = uTryToGetPropS(IncomeData, "CurrencyOptionDeal");
   if (ValType(aux_buff) != V_UNDEF)
      CurrencyOptionDeal = c_CurrencyOptionDeal(aux_buff);
   end;   
   
   aux_buff = uTryToGetPropS(IncomeData, "FraDeal");
   if (ValType(aux_buff) != V_UNDEF)
      FRADeal = c_FRADeal(aux_buff);
   end;  
   
   aux_buff = uTryToGetPropS(IncomeData, "IRSSWAPDeal");
   if (ValType(aux_buff) != V_UNDEF)
      IRSSWAPDeal = c_IRSSWAPDeal(aux_buff);
   end;   

   aux_buff = uTryToGetPropS(IncomeData, "IAMLDDeal");
   if (ValType(aux_buff) != V_UNDEF)
      IAMLDDeal = c_IAMLDDeal(aux_buff, DealKind);
   else
      if ( (DealKind == "IAM") or (DealKind == "CSA") )
         err_txt = ERR_TEXT_NO_IN_MSG +": IAMLDDeal для DealKind="+DealKind;
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM));
      end;
   end;

   aux_buff = uTryToGetPropS(IncomeData, "RepoDeal");
   if (ValType(aux_buff) != V_UNDEF)
// DEF-36517 Просьба исключить загрузку в СОФР сделок, которые не обрабатываются в дальнейшем
      //REPODeal = c_REPODeal(aux_buff);
      err_txt = "Сделки Repo не обрабатываются: "+DealID;
      RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM));
   else 
      if ( (DealKind == "REPO") or (Index(StrUpr(DealID),"REPO") == 1) )
         err_txt = "Сделки Repo не обрабатываются: "+DealID;
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM));
      end;
   end;
   
   aux_buff = uTryToGetPropS(IncomeData, "CurrencyEquityDeal");
   if (ValType(aux_buff) != V_UNDEF)
      CurrencyEquityDeal = c_CurrencyEquityDeal(aux_buff);
   end;
   

   aux_buff = uTryToGetPropS(IncomeData, "BondDeal");
   if (ValType(aux_buff) != V_UNDEF)
      BondDeal = c_BondDeal(aux_buff);
   else
      if (DealKind == "BOND")
         err_txt = ERR_TEXT_NO_IN_MSG +": BondDeal для DealKind="+DealKind;
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM));
      end;
   end;

   aux_buff = uTryToGetPropS(IncomeData, "MarginCallDeal");
   if (ValType(aux_buff) != V_UNDEF)
      MarginCallDeal = c_MarginCall(aux_buff);
   end;

   aux_buff = uTryToGetPropS(IncomeData, "CurrencySWAPOptionDeal");
   if (ValType(aux_buff) != V_UNDEF)
      CurrencySWAPOptionDeal = c_CurrencySWAPOptionDeal(aux_buff);
   end;

end;

// комиссии
private class c_Comiss(IncomeData)
   var Type          : String;   // Тип комиссии                     Да    Справочник
   var PartNum       : Integer;  // К какой части сделки относится   Нет
   var Amount        : Double;   // Сумма комиссии общая             Да
   var Summa         : Double;   // Сумма комиссии без НДС           Нет
   var SummaNDS      : Double;   // Сумма НДС по комиссии            Нет
   var Currency      : String;   // Код валюты комиссии              Да    Справочник
   var PayerWhoIs    : String;   // Кто плательщик комиссии          Нет   Справочник
   var Payer         : String;   // Идентификатор Плательщика        Нет   Справочник
   var Recipient     : String;   // Идентификатор Получателя         Нет   Справочник
   var DateCalc      : date;     // Дата расчета                     Нет
   var IsPaid        : bool;     // Признак оплаты комиссии          Нет
   var DatePayPlan   : date;     // Дата оплаты комиссии (план)      Нет
   var DatePayFact   : date;     // Дата оплаты комиссии (факт)      Нет
   var СommissionМethod : string;
   var Tax           : double;
   var Discount      : double;
   var Gross         : double;
   var NetGross      : double;
   var NetSumma      : double;
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)   
      private var nametag_up = "ComissArray.Comiss";
      
      if(ValType(IncomeData) != V_UNDEF)
         Type        = getValueFromProperty(IncomeData, "Type"       , nametag_up);
         PartNum     = getValueFromProperty(IncomeData, "PartNum"    , nametag_up);
         Amount      = getValueFromProperty(IncomeData, "Amount"     , nametag_up);
         Summa       = getValueFromProperty(IncomeData, "Summa"      , nametag_up);
         SummaNDS    = getValueFromProperty(IncomeData, "SummaNDS"   , nametag_up);
         Currency    = getValueFromProperty(IncomeData, "Currency"   , nametag_up);
         PayerWhoIs  = getValueFromProperty(IncomeData, "PayerWhoIs" , nametag_up);
         Payer       = getValueFromProperty(IncomeData, "Payer"      , nametag_up);
         Recipient   = getValueFromProperty(IncomeData, "Recipient"  , nametag_up);
         DateCalc    = getValueFromProperty(IncomeData, "DateCalc"   , nametag_up);
         IsPaid      = getValueFromProperty(IncomeData, "IsPaid"     , nametag_up);
         DatePayPlan = getValueFromProperty(IncomeData, "DatePayPlan", nametag_up);
         DatePayFact = getValueFromProperty(IncomeData, "DatePayFact", nametag_up);
         СommissionМethod = getValueFromProperty(IncomeData, "СommissionМethod", nametag_up);
         Tax         = getValueFromProperty(IncomeData, "Tax"        , nametag_up);
         Discount    = getValueFromProperty(IncomeData, "Discount"   , nametag_up);
         Gross       = getValueFromProperty(IncomeData, "Gross"      , nametag_up);
         NetGross    = getValueFromProperty(IncomeData, "NetGross"   , nametag_up);
         NetSumma    = getValueFromProperty(IncomeData, "NetSumma"   , nametag_up);
      end;
   end;

   uInitPrime(IncomeData);   
end;

private class c_PartyUId(Incomedata)
   var SystemId      : String;   // Код АС               Да    Справочник
   var SystemNodeId  : String;   // Код экземпляра АС    Да    Справочник
   var ObjectId      : String;   // Код субъекта в АС    Да    Идентификатор

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var nametag_up = "PartyDealList.PartyDeal.PartyUID";
      
      if(ValType(IncomeData) != V_UNDEF)
         SystemId       = getValueFromProperty(IncomeData, "SystemId"      , nametag_up, true);
         SystemNodeId   = getValueFromProperty(IncomeData, "SystemNodeId"  , nametag_up, true);
         ObjectId       = getValueFromProperty(IncomeData, "ObjectId"      , nametag_up, true);
      end;
   end;

   uInitPrime(IncomeData);
end;

// Участники Сделки
private class c_PartyDeal(IncomeData)
   var PartyKind        : String;   // Тип участника                          Да    Справочник
   var PartyIDKind      : String;   // Тип кода (идентификатора)              Нет   Справочник
   var PartyUID         ;           // Идентификатор участника (код) в АБС    Нет    Идентификатор
   var PartyCode        : String;   // Дилинг коды                            Нет   Через запятую
   var PartyFullName    : String;   // Полное имя                             Да
   var PartyShortName   : String;   // Краткое имя                            Да
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)   
      private var err_txt;
      private var aux_buff, aux_buff2;
      private var nametag_up = "PartyDealList.PartyDeal";
      private var size_income, size_ar;
      
      if(ValType(IncomeData) != V_UNDEF)
         PartyKind      = getValueFromProperty(IncomeData, "PartyKind"     , nametag_up, true);
         PartyIDKind    = getValueFromProperty(IncomeData, "PartyIDKind"   , nametag_up);
         PartyCode      = getValueFromProperty(IncomeData, "PartyCode"     , nametag_up);
         PartyFullName  = getValueFromProperty(IncomeData, "PartyFullName" , nametag_up, true);
         PartyShortName = getValueFromProperty(IncomeData, "PartyShortName", nametag_up, true);
        
         aux_buff2 = getValueFromProperty(IncomeData, "PartyUID", nametag_up); 
         if(ValType(aux_buff2) != V_UNDEF)
            PartyUID = TArray;
            aux_buff = 0;
            size_income = IncomeData.PartyUID.size;
            while( size_income > aux_buff)
               PartyUID.value(aux_buff) = c_PartyUId(IncomeData.PartyUID.value(aux_buff));
               aux_buff = aux_buff + 1;
            end;

         end;

      end;
   end;

   uInitPrime(IncomeData);
end;

// Использование лимитов
private class c_Limits(IncomeData)
   var Type    : String;   // Тип лимита           Да    Справочник
   var Name    : String;   // Наименование лимита  Да    Справочник
   var Status  : String;   // Статус               Да    Справочник
   var Value   : Double;   // Величина лимита      Да
   var Rest    : Double;   // Остаток лимита       Да

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var nametag_up = "LimitsList.Limits";
      
      if(ValType(IncomeData) != V_UNDEF)
         Type     = getValueFromProperty(IncomeData, "Type"    , nametag_up, true);
         Name     = getValueFromProperty(IncomeData, "Name"    , nametag_up, true);
         Status   = getValueFromProperty(IncomeData, "Status"  , nametag_up, true);
         Value    = getValueFromProperty(IncomeData, "Value"   , nametag_up, true);
         Rest     = getValueFromProperty(IncomeData, "Rest"    , nametag_up, true);
      end;
   end;

   uInitPrime(IncomeData);
end;

// Платежные инструкции
private class c_PayInstr(IncomeData)
// в дальнейшем - не обрабатываются, так что все параметры не обязательные
   var LegsNumber    : integer;  // Номер ноги                 Нет
   var PayInstrKind  : String;   // Код вида инструкции        Да    Справочник
   var PayInstr      : String;   // Платежная инструкция       Да
   var PayComment    : String;   // Платежный комментарий      Да
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var err_txt;
      private var nametag_up = "PayInstrList.PayInstr";
      if(ValType(IncomeData) != V_UNDEF)
         LegsNumber     = getValueFromProperty(IncomeData, "LegsNumber"    , nametag_up);
         PayInstrKind   = getValueFromProperty(IncomeData, "PayInstrKind"  , nametag_up);
         PayInstr       = getValueFromProperty(IncomeData, "PayInstr"      , nametag_up);
         PayComment     = getValueFromProperty(IncomeData, "PayComment"    , nametag_up);
      end;
   end;

   uInitPrime(IncomeData);   
end;

// Связанная сделка (родительская)
private class c_PrevDeal(IncomeData)
   var ExternalID :string;    // Идентификатор сделки в исходной (внешней) системе     Нет
   var TSBrief    :string;    // Код торговой площадки/торговой системы                Нет
   var DealID     :string;    // Уникальный идентификатор сделки в АСУДР               Да

   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(IncomeData)
      private var err_txt;
      private var nametag_up = "PrevDeal";
      
      if(ValType(IncomeData) != V_UNDEF)
         ExternalID  = getValueFromProperty(IncomeData, "ExternalID" , nametag_up);
         TSBrief     = getValueFromProperty(IncomeData, "TSBrief"    , nametag_up);
         DealID      = getValueFromProperty(IncomeData, "DealID"     , nametag_up, true);
      end;
   end;

   uInitPrime(IncomeData);   
end;

// класс входящих параметров 
private class c_ProcessDealsRequest(p_req_data_obj)
   var IdentityDeal  : c_IdentityDeal;    // Идентификация сделки    Контейнер               Да
   var DealData      : c_DealData;        // Содержание сделки       Строка (Контейнер)      Да
   var ComissArray   ; //: TArray;            // Список комиссий         Контейнер               Нет
   var PartyDealList ; //: TArray;            // Участники Сделки        Контейнер               Да
   var LimitsList    ; //: TArray;            // Использование лимитов   Контейнер               Нет
   var PayInstrList  ; //: TArray;            // Платежные инструкции    Контейнер               Нет
   var PrevDeal;
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(p_req_data_obj)
      private var err_txt;
      private var aux_buff;
      private var DealKind = NULL;

      // проверка производится на этапе проверки XML, оставлено для контроля
      if(ValType(p_req_data_obj) != V_UNDEF)
         aux_buff = uTryToGetPropS(p_req_data_obj, "IdentityDeal");
         if (ValType(aux_buff) == V_UNDEF)
            err_txt = ERR_TEXT_NO_IN_MSG +": IdentityDeal";
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM)); 
         else
            IdentityDeal = c_IdentityDeal(aux_buff);
         end;
         
         aux_buff = uTryToGetPropS(p_req_data_obj, "DealData"); 
         if (ValType(aux_buff) == V_UNDEF)
            err_txt = ERR_TEXT_NO_IN_MSG +": DealData";
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM)); 
         else
            DealKind = trim(uTryToGetPropS(IdentityDeal,"DealKind"));
            DealData = c_DealData(aux_buff, DealKind, IdentityDeal.DealID);
         end;

         aux_buff = uTryToGetPropS(p_req_data_obj, "ComissArray"); 
         if (IdentityDeal.DealKind == "BNKT")
            ComissArray = NULL;  // gtv: для банкнотных сделок временно отключаем комиссию совсем
         else
            if(ValType(aux_buff) == V_GENOBJ)
               ComissArray = TArray;
               aux_buff = 0;
               while(p_req_data_obj.ComissArray.size > aux_buff)
                  ComissArray.value(ComissArray.size) = c_Comiss(p_req_data_obj.ComissArray.value(aux_buff));
                  aux_buff = aux_buff + 1;
               end;
            elif(ValType(aux_buff) == V_UNDEF)
            else
               err_txt = string(InErrNotObj, "ComissArray");
               RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
            end;
         end;

         aux_buff = uTryToGetPropS(p_req_data_obj, "PartyDealList"); 
         if(ValType(aux_buff) == V_GENOBJ)
            PartyDealList = TArray;
            aux_buff = 0;
            while(p_req_data_obj.PartyDealList.size > aux_buff)
               PartyDealList.value(PartyDealList.size) = c_PartyDeal(p_req_data_obj.PartyDealList.value(aux_buff));
               aux_buff = aux_buff + 1;
            end;
         elif(ValType(aux_buff) == V_UNDEF)
            err_txt = ERR_TEXT_NO_IN_MSG +": PartyDealList";
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM));
         else
            err_txt = string(InErrNotObj, "PartyDealList");
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
         end;
         
         aux_buff = uTryToGetPropS(p_req_data_obj, "LimitsList"); 
         if(ValType(aux_buff) == V_GENOBJ)
            LimitsList = TArray;
            aux_buff = 0;
            while(p_req_data_obj.LimitsList.size > aux_buff)
               LimitsList.value(LimitsList.size) = c_Limits(p_req_data_obj.LimitsList.value(aux_buff));
               aux_buff = aux_buff + 1;
            end;
         elif(ValType(aux_buff) == V_UNDEF)
         else
            err_txt = string(InErrNotObj, "LimitsList");
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
         end;
         
         aux_buff = uTryToGetPropS(p_req_data_obj, "PayInstrList"); 
         if(ValType(aux_buff) == V_GENOBJ)
            PayInstrList = TArray;
            aux_buff = 0;
            while(p_req_data_obj.PayInstrList.PayInstr.size > aux_buff)
               PayInstrList.value(PayInstrList.size) = c_PayInstr(p_req_data_obj.PayInstrList.PayInstr.value(aux_buff));
               aux_buff = aux_buff + 1;
            end;
         elif(ValType(aux_buff) == V_UNDEF)
         else
            err_txt = string(InErrNotObj, "PayInstrList");
            RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
         end;
         
         aux_buff = uTryToGetPropS(p_req_data_obj, "PrevDeal");
         if (ValType(aux_buff) != V_UNDEF)
            PrevDeal = c_PrevDeal(aux_buff);
         end;
         
      else
         err_txt = ERR_TEXT_NO_IN_MSG +": DealList.DealParm";
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM));
      end;
   end; /* macro uInitPrime() */

   uInitPrime(p_req_data_obj);   
end;

// Урезанный c_ProcessDealsRequest для обработки ошибок 
private class c_ProcessDealsRequest_IdentityOnly(p_req_data_obj)
   var IdentityDeal  : c_IdentityDeal;    // Идентификация сделки    Контейнер               Да
   var DealData;                          // Без заполнения
   
   /* Кратность параметров в соответствии со спецификацией */
   private macro uInitPrime(p_req_data_obj)
     private var aux_buff;
     
     if(ValType(p_req_data_obj) != V_UNDEF)
         aux_buff = uTryToGetPropS(p_req_data_obj, "IdentityDeal");
         if (ValType(aux_buff) != V_UNDEF)
            IdentityDeal = c_IdentityDeal(aux_buff);
         end;
     end;
   end; /* macro uInitPrime() */

   uInitPrime(p_req_data_obj);   
end;

// Возвращает экземпляр c_ProcessDealsRequest_IdentityOnly (урезанный c_ProcessDealsRequest)
private macro TryToRestoreRequestObject(p_req_data_obj)
   var partlyObject = c_ProcessDealsRequest_IdentityOnly(p_req_data_obj);
     
   if ((ValType(partlyObject) != V_UNDEF) and (ValType(partlyObject.IdentityDeal) != V_UNDEF))
     return partlyObject;
   end;
   
   return null;
   
OnError(err)
   return null;
end;

// непосредственная обработка единичной записи
// формирование класса ответа по единичной записи
macro RunProcessDeals(p_req_data_obj)
   var ResultAction = c_DealParm;
   var req_obj_serv = NULL;
   
   private var resp_resultCode, resp_resultText, SOFRDealID = NULL;
   private var retval;     // ответ по созданию/обновлению сделки
   
   req_obj_serv = c_ProcessDealsRequest(p_req_data_obj);

   /* Вызываем сервис */
   retval =_MoneyMarketDeal_CreateNew(req_obj_serv);
   if (retval.Code == 0)
      SOFRDealID = retval.SOFRDealID;
      resp_resultCode = 0;
      if (retval.text)
         resp_resultText = retval.text;
      else 
         resp_resultText = "OK";
      end;
   else
      resp_resultCode = -3000;
      if (req_obj_serv.IdentityDeal.ActionType == 1)
         resp_resultText = "Ошибка создания сделки: " + retval.text;
      elif (req_obj_serv.IdentityDeal.ActionType == 2)
         resp_resultText = "Ошибка обновления сделки: " + retval.text;
      elif (req_obj_serv.IdentityDeal.ActionType == 3)
         resp_resultText = "Ошибка удаления сделки: " + retval.text;
      end;
   end;

   /* Получаем объектный вид ответа */
   ResultAction.ExternalID = req_obj_serv.IdentityDeal.ExternalID;
   ResultAction.DealID = req_obj_serv.IdentityDeal.DealID;
   ResultAction.SOFRDealID = SOFRDealID;
   ResultAction.Result.Code = resp_resultCode;
   ResultAction.Result.Text = resp_resultText;
   
   UpdateDealProcessingStatus(req_obj_serv, retval.code, retval.text);

   return ResultAction;
      
onError(err)
   /* Получаем объектный вид ответа */
   ResultAction.Result.Code = c_err_obj.obtain_err_code(err);
   ResultAction.Result.Text = c_err_obj.obtain_err_msg(err);
   
   // Если исключение произошло в конструкторе, то попробуем частично взять основные данные по сделке, для обновления статуса в Kondor_Sofr_Buffer_dbt DEF-80361
   if (ValType(req_obj_serv) == V_UNDEF)
     req_obj_serv = TryToRestoreRequestObject(p_req_data_obj);
   end;
   
   UpdateDealProcessingStatus(req_obj_serv, ResultAction.Result.Code, ResultAction.Result.Text);
   
   return ResultAction;
end;


/*----------------------------------------------*/
/*  Запрос вставки сделки                       */
/*----------------------------------------------*/
macro adp_ProcessDeals(IncomeData)
   var out_str = "";
  
   var req_msg_obj = NULL;
   var req_data_obj = NULL;
   var resp_data_obj = NULL;
   var resp_data_obj_arr = TArray;
   
   var ProcessDeals_result = NULL;
   var DealList = TArray();   
   var DealParm = NULL;
   
   var v_result, v_xml;
   var err_txt, out_code;
   
   var ReqID            : string;   // ИД запроса Да
   var SenderId         : string;   // Код АС-источника сведений Нет
   
   private var v_logger_obj;    /* Объект для работы с журналом */
   private var v_log_id;        /* Идентификатор записи в журнале (если требуется что-то добавить) */
   private var dealid_resp, IdentityDeal_resp;

   if(ValType(IncomeData) == V_UNDEF)
      RunError(ERR_TEXT_NO_IN_MSG, c_err_obj(ERR_TEXT_NO_IN_MSG,
                                             ERR_CODE_NO_IN_PRM));
   end;
         
   /* Преобразуем запрос в объектный вид - begin */
   req_msg_obj = c_secur_msg_converter();
   if(not req_msg_obj.m_decode_escaped_char(IncomeData))
      RunError(req_msg_obj.get_service_msg(), c_usr_err_obj(req_msg_obj.get_service_msg()));
   end;
   if(not req_msg_obj.m_make_pure_msg_from_ifx(req_msg_obj.get_pure_msg()))
      RunError(req_msg_obj.get_service_msg(), c_usr_err_obj(req_msg_obj.get_service_msg()));
   end;
//   req_data_obj = req_msg_obj.m_secur_internal_req(req_msg_obj.get_pure_msg());
   req_data_obj = req_msg_obj.m_secur_wol_internal_req(req_msg_obj.get_pure_msg());

   /* Преобразуем запрос в объектный вид - end */

   v_logger_obj = uws_exchng_logger(null, null, XmlRpcRequestId(), "ProcessDeals", modulename(), NULL, req_msg_obj.get_pure_msg());
   v_log_id = v_logger_obj.get_log_id();

   if(ValType(req_data_obj) == V_UNDEF)
      err_txt = "Не удалось преобразовать XML в объект";
      RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
   end;
   
   // обработка
   ReqID = uTryToGetPropS(req_data_obj, "ReqID");
   if (ValType(ReqID) == V_UNDEF)
      err_txt = ERR_TEXT_NO_IN_MSG +": ReqID";
      RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM)); 
   end;
   SenderId = uTryToGetPropS(req_data_obj, "SenderId"); 

   DealList = uTryToGetPropS(req_data_obj, "DealList");
   
   resp_data_obj_arr.Size = 0;
   var resp_data_obj_arr_i = 0;
   for (DealParm, DealList)
      // единичная обработка
      ProcessDeals_result = RunProcessDeals(DealParm);

      // массив результатов обработки
      resp_data_obj_arr_i = resp_data_obj_arr.Size;
      resp_data_obj_arr(resp_data_obj_arr_i) = ProcessDeals_result;
      
      DealParm = NULL;
      ProcessDeals_result = NULL;
   end;     
   
   // итоговый класс 
   resp_data_obj = c_outObj;
   resp_data_obj.ProcessDeals_resp.ReqID = ReqID; 
   resp_data_obj.ProcessDeals_resp.SenderId = SenderId;
   resp_data_obj.ProcessDeals_resp.Result.Code = 0;
   resp_data_obj.ProcessDeals_resp.Result.Text = "OK";
   resp_data_obj.ProcessDeals_resp.Result.DealList = resp_data_obj_arr;

   /* Преобразуем объектный вид ответа в документ требуемого формата - begin */
   out_str = req_msg_obj.m_secur_internal_resp(resp_data_obj);
   /* Преобразуем объектный вид ответа в документ требуемого формата - end */

   if ( (resp_data_obj.ProcessDeals_resp.Result.DealList) and (resp_data_obj.ProcessDeals_resp.Result.DealList.size > 0) )
     dealid_resp = resp_data_obj.ProcessDeals_resp.Result.DealList.value(0).DealID;
   end;
   if (ValType(dealid_resp) == V_UNDEF)
     IdentityDeal_resp = uTryToGetPropS(DealList.value(0), "IdentityDeal");
     if (ValType(IdentityDeal_resp) != V_UNDEF)
        dealid_resp = uTryToGetPropS(IdentityDeal_resp, "DealID");
     end;
   end;

   v_logger_obj.add_response(out_str, null, null, null, modulename, dealid_resp);
   if ( (resp_data_obj.ProcessDeals_resp.Result.DealList) and (resp_data_obj.ProcessDeals_resp.Result.DealList.size > 0) )
      if (resp_data_obj.ProcessDeals_resp.Result.DealList.value(0).Result.Code != 0)
         out_code = resp_data_obj.ProcessDeals_resp.Result.DealList.value(0).Result.Code;
         err_txt = resp_data_obj.ProcessDeals_resp.Result.DealList.value(0).Result.Text;
         v_logger_obj.add_error_info(out_code, err_txt);
      end;
   end;   
  
   req_msg_obj = NULL;

   return out_str;
   
onError(err)
   out_code = c_err_obj.obtain_err_code(err);
   err_txt = c_err_obj.obtain_err_msg(err);

   resp_data_obj = c_outObj;
   resp_data_obj.ProcessDeals_resp.ReqID = XmlRpcRequestId; 
   resp_data_obj.ProcessDeals_resp.SenderId = 0;
   resp_data_obj.ProcessDeals_resp.Result.Code = out_code;
   resp_data_obj.ProcessDeals_resp.Result.Text = err_txt;

   /* Преобразуем объектный вид ответа в документ требуемого формата - begin */
   out_str = req_msg_obj.m_secur_internal_resp(resp_data_obj);
   /* Преобразуем объектный вид ответа в документ требуемого формата - end */   

   v_logger_obj.add_response(out_str, null, null, null, modulename);
   v_logger_obj.add_error_info(out_code, err_txt);

   req_msg_obj = NULL;
      
   return out_str;
end;

/*---------------------------------------*/
/*              Точка входа              */
/*---------------------------------------*/
macro ProcessDeals (IncomeData)
   var out_str = "";

   //setrstrace(true);    //17-06-2020 по теме 511711
   OutputIntrace("Deal_Kondor_begin");
  
   out_str = adp_ProcessDeals(IncomeData);

   OutputIntrace("Deal_Kondor_end");
  // setrstrace(false); //17-06-2020 по теме 511711

   return out_str;

end;
