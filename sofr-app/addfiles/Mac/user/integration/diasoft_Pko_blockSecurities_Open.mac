import "spDeal.mac";
import "cblogger.mac";
import "FuncObj.mac";

//Точка входа funcobj
/* пример вызова в pl/sql
          diasoft_pko_funcobj_creator(typeMacros => 3, funcobjParameter => r_WriteOff.Operationid
            ,p_id => r_WriteOff.Id, o_ErrorCode => o_ErrorCode, o_ErrorDesc => o_ErrorDesc);
*/
macro main(pObjecttype, pObjectid /*pko_writeoff.id*/, pParam /*pko_writeoff.operationid*/)

  var dealid = 0;
  var rescode = 0 ,restxt = "";
  
  //найти в Картотеке запись об созданной операции
  var sql = "select pko.* from pko_writeoff pko where id = :1";
  var cmd = RSDCommand(sql);
  cmd.AddParam(":1",RSDBP_IN,pObjectId);
  cmd.Execute;
  var rs = TrsbDataSet(cmd);
  if (not rs.movenext)
    AddItLog(string("pko_writeoff.id=",pObjectid,"Операция не найдена в Картотеке"));
    return FuncObjResult(FUNCOBJ_STATE_FATAL_ERROR, "Операция не найдена в Картотеке pko_writeoff", FUNCOBJ_RESULT_ERROR); //если не нашли в Картотеке операцию, то выполнить операцию нельзя
  else
    dealid = rs.dealid;
  end;

  diasoft_Pko_blockSecurities_open_func(dealid,@rescode,@restxt);
  if (rescode==0)
    return FuncObjResult(FUNCOBJ_STATE_OK, "", FUNCOBJ_RESULT_OK);   
  else
    AddItLog(string("pko_writeoff.id=",pObjectid,restxt));
    return FuncObjResult(FUNCOBJ_STATE_FATAL_ERROR, restxt, FUNCOBJ_RESULT_ERROR);
  end;
end;