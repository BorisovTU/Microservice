/*
$Name:        ws_impdeals.mac
$Module:      Импорт на базе макроса Шлюза
$Description: Загрузка КО сделок в бэк-офис из шлюза
*/
///////////////////////////////////////////////////////////////////////////////////
//*******************************************************************************//
//*  Программист      : LKL                                                     *//
//*                   : GYA адаптация для web-сервиса                           *//
//*******************************************************************************//
///////////////////////////////////////////////////////////////////////////////////
import PTInter, RSD, DealsInter, DVInter, Проценты, PaymInter, "gtconst.inc",
       rgtgtlog, "rgtgtrec.mac", "gtdlfun.mac", "rgobj.mac", "dldlngfun.mac", "dlref.mac", OprInter, SfInter, 
       FIInter, Календарь, funk, "global_utils_intgr.mac";
import "loadRUData.mac";
import "func_lib.mac";
import dv_lib, fx_globals,"dlcnst.inc";
import "u_common_email_utils.mac";
import "dl_calendcore.mac";
import "cb_err.mac", "cblogger2.mac";
import "KondorFunc.mac";

var ER, basi, ObjCat, ObjID, ErrMes;
var errorFilterRecs = GetErrorFilterRecs();

const BOKIND=4813;
const BOKINDSWAP=199;
const BOKINDFWD=199;
const BOKINDT3=4815;
//const DEALTYPE=ПИКО_ПокупкаПродажа; //2730;
const DEALTYPE=22730; //замена на пользовательскую операцию
const ID_NKC=1181;

private const UnknownParty = -1;
private const PT_ATTRID_NOTADD_GENAGR = 172; //А.Киселев 05.02.2020 проверить категорию 172 субъекта
private const Ounce = 0.035274;
private const LLCLASS_IDENTITY_PI = 1080; //Справочник 1080."Идентификаторы СПИ"
private const LLCLASS_EMAIL_GROUP = 5009; //Техн. справочник групп рассылки
private const err_Correct_PI      = 0;
private const err_Null_PI         = 1;
private const err_Undef_PI        = 2;
private const err_Non_Standard_PI = 3;
private const REGPATH_KONDORPROCESSING_SUPPORTEMAIL = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ИМПОРТ СДЕЛОК ИЗ АСУДР-КОНДОР\\EMAIL ДЛЯ ИНФОРМИРОВАНИЯ";
private const REGPATH_KONDORPROCESSING_EXECUTIONTIMELIMIT = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ИМПОРТ СДЕЛОК ИЗ АСУДР-КОНДОР\\МАКС.ВРЕМЯ ОБРАБ.СДЕЛКИ TOMCAT";
private const KONDORPROCESSING_EMAIL_ERROREXIST_SUBJECT = "Импорт сделок из АСУДР-КОНДОР";
private const KONDORPROCESSING_EMAIL_ERROREXIST_MESSAGE = "При загрузке сделок из Кондор/АСУДР получены ошибки.\nСм. Главная книга\\Процедуры\\Мониторинг импорта сделок из Кондор/АСУДР";

//dan>
private const Валютный_рынок = "Валютный рынок";
private const СПВБ_Валютный_рынок = "СПВБ_валютный";
private macro FillMarket(deal:@variant, MarketCode:string)
  var cmd, marketScheme;
  if ((ValType(MarketCode) == V_UNDEF) or (MarketCode == NULL))
    MarketCode = Валютный_рынок;
  end;
  if(((MarketCode == Валютный_рынок) and DL_ЕдиныйПулОбеспеченияСобств()) or (MarketCode == СПВБ_Валютный_рынок))
    cmd = Dl_RSDCommand("Select * from ddlmarket_dbt where t_code = ?");
    cmd.AddParam(MarketCode);
    marketScheme = cmd.Execute();
    if(marketScheme.MoveNext())
      deal.rec.MarketID       = marketScheme.Market;
      deal.rec.MarketSchemeID = marketScheme.ID;
    end;  
  end; 
end;
//<dan

var err_txt;

class c_ResultDeal
   var Code : integer;  // Поле Код, обязательное: Да
   var Text : string;   // Поле Текст, обязательное: Нет
   var SOFRDealID : string;  // ИД сделки в СОФР
end;

class c_GenAgr
   var AgrID : integer;
   var PartyID : integer;
   var Confirmmethod : integer;
   var Trans         : integer; // gtv: для ГС ФИССиКО транспорт имеет свои коды
end;

// параметры для заполнения платежей
class SP_ParmPaym
   var ClAccount       :string  = "",  //счет клиента
       ClBank          :integer = UnknownParty, //банк клиента
       ClCorAccount    :string  = "",  //корсчет банка клиента
       ClCorBank       :integer = UnknownParty, //банк-корреспондент банка клиента 
       DepoAccount     :string  = "",  //счет ДЕПО
       Custody         :integer = UnknownParty, //депозитарий
       CntrAccount     :string  = "",  //счет контрагента
       CntrBank        :integer = UnknownParty, //контрагент   
       CntrCorAccount  :string  = "",  //корсчет банка контрагента
       CntrCorBank     :integer = UnknownParty, //банк-корреспондент контрагента
       CntrDepoAccount :string  = "",  //счет ДЕПО контрагента
       CntrCustody     :integer = UnknownParty; //депозитарий контрагента
end;


//shev 20201006
private macro GetTypeDealIngots(Comment)
  private  var que, rs, sum:double;

  que = " select instr('"+Comment+"','Слитки') from dual ";
 
  rs = LnGetRecordSet(que);
     if(rs != null)
           if (rs.moveNext) 
               if (rs.value(0)>0 )
                 return 1;
               end;
           end;	
     end;
   return -1;
end;


//shev 20201006
private macro GetNdsOnComment(Comment)
  private  var que, rs, sum:double;

  que = " select instr('"+Comment+"','НДС') from dual ";
 
  rs = LnGetRecordSet(que);
     if(rs != null)
           if (rs.moveNext) 
           else
               return -1;
           end;	
     end;

  rs = null; que = null;

  que = " select replace(replace(substr('"+Comment+"',instr('"+Comment+"','НДС')+4,instr('"+Comment+"','руб.')-instr('"+Comment+"','НДС')-4),' ',''),',','.')  from dual ";

  rs = LnGetRecordSet(que);
     if(rs != null)
           if (rs.moveNext)
// Cherendichenko 2020-10-09 Обходим вариант с попыткой присвоения sum пустого значения
	     if ( ValType(rs.value(0)) != 26 ) // SPECVAL0
               sum = rs.value(0) ; 
              else
               return -1;
             end;
           else
               return -1;
           end;	
     end;

   return sum;

end;             

//shev 20201006
private macro GetBankVaultonComment(Comment,Direction,Id:@integer,Address:@string)
  private  var que, rs, addr:string;


  if(Direction == "Buy")
     que = "select  substr('"+Comment+"',instr('"+Comment+"','Получение')+10) from dual ";
  else
     que = "select  substr('"+Comment+"',instr('"+Comment+"','Поставка в ГО.')+15) from dual ";
  end;

  rs = LnGetRecordSet(que);
     if(rs != null)
           if (rs.moveNext)
	     if ( ValType(rs.value(0)) != 26 ) 
               addr = rs.value(0) ; 
              else
               return -1;
             end;
           else
               return -1;
           end;	
     end;

  rs = null; que = null;

  if(valtype(addr) != V_UNDEF)

    que = "select t_id, t_address  from ddvmetstorage_dbt where t_address ='"+addr+ "' ";

    rs = LnGetRecordSet(que);
       if(rs != null)
             if (rs.moveNext)
                 Id = rs.value("t_id") ; 
                 Address = rs.value("t_address") ; 
             else
                 return -1;
             end;	
       end;

   end;

  return 0 ;

end;
                  

private macro InsertIngorts(Dealid,Amount)
  private  var query, rs, cmd;
  private const Dockind = 4813;
  private const Purity = 99.99;
  private const state  = "Отличное";

  Query = " DECLARE " +

          "  p_Dockind               dbullions_dbt.t_Dockind%TYPE := :p_Dockind; " +
          "  p_Dealid                dbullions_dbt.t_DealId%TYPE  := :p_DealId; " +
          "  p_Purity                dbullions_dbt.T_PURITY%TYPE  := :p_Purity; " +
          "  p_Ligoz                 dbullions_dbt.T_LIGOZ%TYPE   := :p_Ligoz; " +
          "  p_Liggr                 dbullions_dbt.T_LIGGR%TYPE   := :p_Liggr; " +
          "  p_Pureoz                dbullions_dbt.T_LIGGR%TYPE   := :p_Pureoz; " +
          "  p_Puregr                dbullions_dbt.T_LIGGR%TYPE   := :p_Puregr; " +
          "  p_state                 dbullions_dbt.T_state%TYPE   := :p_state; " +
          
          " BEGIN " +
          
          "  INSERT INTO dbullions_dbt (T_DOCKIND,T_DEALID,T_CODE,T_KIND,T_PURITY,T_LIGOZ,T_LIGGR,T_PUREOZ,T_PUREGR,T_STATE)" +
          "  VALUES (p_Dockind,p_Dealid,2,0,p_Purity,p_Ligoz,p_Liggr,p_Pureoz,p_Puregr,p_state); " +
          
          " COMMIT; "+

          " END; ";


  cmd = RSDCommand(query);
  cmd.addParam("p_Dockind", RSDBP_IN, Dockind);
  cmd.addParam("p_Dealid",  RSDBP_IN, DealId);
  cmd.addParam("p_Purity",  RSDBP_IN, Purity);
  cmd.addParam("p_Ligoz",   RSDBP_IN, Amount*Ounce);
  cmd.addParam("p_Liggr",   RSDBP_IN, Amount);
  cmd.addParam("p_Pureoz",  RSDBP_IN, Amount*Ounce);
  cmd.addParam("p_Puregr",  RSDBP_IN, Amount);
  cmd.addParam("p_state",   RSDBP_IN, state);

  cmd.execute();


end;

//поиск элемента в справочнике по имени BIQ-6664
 private macro GetLLVALElement (list, name)
   var  td;
    td = TRSBDataset("select t_element from dllvalues_dbt where t_list = " + list + " and t_name = '" + name + "'");
    if(td.movenext())
      return td.element;
    end;
    return 0;
 end;

// Отправка уведомлений BIG-6664
 private macro SendSingleNotification(msg_text_arr)
     var v_email_processor,
         email_group; 
     var i = 0;
    
     email_group = GetLLVALElement(LLCLASS_EMAIL_GROUP, "NotRoutedPaym");

       v_email_processor = c_email_proc_env();
       v_email_processor.m_get_email_group(email_group);
       v_email_processor.m_set_msg_head("РСХБ-Дилинг 2.0. Нестандартная СПИ");
       while (i < msg_text_arr.size)
        v_email_processor.m_add_row_to_msg_text(msg_text_arr(i));
        i = i + 1;
       end;
       v_email_processor.m_save_to_submit_grp(email_group, true);
       v_email_processor.m_submit_email_synch();
                            
  onerror(err)
    return 0;
 end;

//установка значения платежной инструкции
 private macro SetPI(IdentityPI:@variant)
   if((valtype(IdentityPI) != v_undef) and (IdentityPI != null))
     if(GetLLVALElement(LLCLASS_IDENTITY_PI, IdentityPI))
       IdentityPI = IdentityPI;
       return err_Correct_PI;
     else
       IdentityPI = null; 
       if(StrUpr(IdentityPI) == "NON STANDARD")
         return err_Non_Standard_PI;
       else
         return err_Undef_PI;
       end;  
     end;
   else
     IdentityPI = null;
     return /*err_Null_PI*/ err_Undef_PI;
   end;
 end;

private macro AddErrMSGStr (DealID, ErrNum, PiType)
  if (ErrNum == err_Undef_PI)
    return String("Для сделки ",DealID,", заключённой через РСХБ-Дилинг 2.0, указан отсутствующий в справочнике идентификатор СПИ. Требуется ручная обработка " + PIType);
  elif (ErrNum == err_Null_PI)
    String("Для сделки ",DealID,", заключённой через РСХБ-Дилинг 2.0, не указан идентификатор СПИ. Требуется ручная обработка " + PIType)
  end;
end;

private macro GetFiidCodeByName(fiidname)
  private  var que, rs;

  que = "select t.t_fiid from dfininstr_dbt t where t.t_ccy='"+fiidname+"'";
  rs = LnGetRecordSet(que);
     if(rs != null)
           if (rs.moveNext) 
               return  rs.value(0) ; 
           else
               return 0;
           end;	
     end;
end;

private macro GetPoints( sum )
  var s=string(sum:0:10),s1,i=strlen(s);
  var res;
  while(i>0)
     if (substr(s,i,1)=="0")
        i=i-1;
        s1=substr(s,1,i);
     else
        i=0;
     end;
  end;
  res = strlen(s1)-index(s1,".");
  if (res < 2)  // минимальное значение 2
     res = 2;
  end;
  return res;
end;

private macro GetGenAgr(code)
   var sql, rs, ret:c_GenAgr;
   ret.AgrID = -1;      //gtv: если не найдено, то -1, а не 0
   ret.PartyID = 0; ret.Confirmmethod = 2;
    sql = "select t_genagrid, t_partyid, nvl(t_confirmmethod, 0) t_confirmmethod from ddl_genagr_dbt where (t_code = :1 or t_num_csa_contr = :2) and t_start <= :3"; 
    rs = ExecSqlSelect(sql, MakeArray(SqlParam("1",code),SqlParam("2",code),SqlParam("3",{curdate})), false);
    if (rs.MoveNext()) 
       ret.AgrId = rs.value(0);
       ret.PartyId = rs.value(1);
       ret.Confirmmethod = rs.value(2);
    end;
    return ret;
end;

private macro GetTransportForDvndeal(_conf)
   var res = 2; //SWIFT
   if (valType(_conf) != V_UNDEF)
      if (_conf == 0)
         res = 2; /*SWIFT*/
      elif (_conf == 1)
         res = 3; /*TELEX*/
      elif (_conf == 3)
         res = 6;     /*ПОЧТА*/  
      elif (_conf == 4)
         res = 51;
      end;
   end;
   return res;
end;

private macro PartyIsNotResident( PartyID )
   var PartyObj:RsbParty = RsbParty( PartyID );
   return PartyObj.IsNotResident;
end;

// ГС по условию
private macro FindGenAgrByCondition(_sql, _add_cond)
   var res: c_GenAgr;
   var sql_beg = "select t_genagrid, t_can_currency, t_can_buy_sale, t_can_netting, t_transferpay, t_confirmmethod, "+
                 "       t_can_banknote, t_can_metall, t_can_secur, t_can_svop ";
   var sql_end = " order by t_start";
   var sql, rs;

   res.AgrID = -1;

   sql = sql_beg+_sql+_add_cond+sql_end;
   rs = RSDRecordSet(sql);
   if (rs.movenext) // если будут несколько подходящих, то первое по дате начала
      res.AgrID         = rs.value("t_genagrid");
      res.Confirmmethod = rs.value("t_confirmmethod");
      res.Trans         = GetTransportForDvndeal(rs.value("t_confirmmethod"));
   end;
   return res;
end;

private macro GetFiKind(_fiid)
  var sql_str, cmd, rs;
  var res = -1;
  sql_str = "select t_fi_kind from dfininstr_dbt where t_fiid = :fiid";
  cmd = RSDCommand(sql_str);
  cmd.AddParam("fiid", RSDBP_IN, _fiid);
  rs = RSDRecordset(cmd);
  if (rs.movenext)
     res =  rs.value("t_fi_kind");
  end;
  return res;
end;


// gtv:
// Поиск ген.соглашения по контрагенту
// Изначально поиск по контрагенту был только для сделок ФИССиКО, теперь расширен на МБК
// Автор начального кода CHVA
macro FindGenAgreementByParty(_numgenagr, _netting, _party, _type, _opkind, _dvnfi, _dvnfi2, _leg1, _leg2)
   var num = 0;
   var GenAgr: c_GenAgr;
   var dockind = 0;
   var post = 0;
   
   var q, query, sql_str1, sql_str2, sql_str3, sql_str;
   var add_cond;
   var fikind1_1 = -1, fikind1_2 = -1;
   var fikind2_1 = -1, fikind2_2 = -1;

   if (_type == "PFI")
      dockind = 4812;      // ФИССиКО
   elif (_type == "BOND")
      dockind = 4812;      // БОЦБ
   elif (_type == "CSA")
      dockind = 4812;      // CSA
   elif (_type == "MBK")
      dockind = 4611;      // МБК
   end;
   
   // значения по умолчанию
   GenAgr.AgrID         = -1;
   GenAgr.PartyID       = _party;
   GenAgr.Confirmmethod = 0;
   GenAgr.Trans         = 2;  // по умолчанию SWIFT
   
   if ( ( Index (_numgenagr,"CSA") > 0 ) or (ValType(_numgenagr) == V_UNDEF) ) 
   
      sql_str1 = "select count (1) num ";
      sql_str2 = "  from ddl_genagr_dbt gen " +
                 " where gen.t_partyid = " + _party +
                 "   and gen.t_dockind = " + dockind +
                 "   and t_status = 10 ";
      // gtv: если в сделке указан неттинг, то ищем только ГС с неттингом, если неттинг не указан, то подходят все ГС
      if ( (_type == "PFI") and (_netting) ) 
         if (_dvnfi)
            if (not ((GetFiKind(_dvnfi.rec.fiid) == FIKIND_METAL) or (GetFiKind(_dvnfi.rec.pricefiid) == FIKIND_METAL)))
               if (_dvnfi2)
                  if (not ((GetFiKind(_dvnfi2.rec.fiid) == FIKIND_METAL) or (GetFiKind(_dvnfi2.rec.pricefiid) == FIKIND_METAL)))
                     sql_str2 = sql_str2 + " and t_can_netting = chr(88)";
                  end;
               else
                  sql_str2 = sql_str2 + " and t_can_netting = chr(88)";
               end;
            end;
         else
            sql_str2 = sql_str2 + " and t_can_netting = chr(88)";
         end;
      end;

      sql_str = sql_str1 + sql_str2;
      
      sql_str3 = "select t_genagrid, t_can_currency, t_can_buy_sale, t_can_netting, t_transferpay, t_confirmmethod, "+
                 "       t_can_banknote, t_can_metall, t_can_secur, t_can_svop ";
      
      q = TRsbDataSet(sql_str);
      if (q.MoveNext)
         num  = q.num;

         if ( num == 1) /*если найдено одно соглашение, то берем его и информацию  о транспорте подтверждения берем из него*/
            sql_str = sql_str3 + sql_str2;
            query = TRsbDataSet(sql_str);

            if (query.MoveNext)
               if (_type == "PFI")
                  // gtv: если ГС одно, то условия только для неттинга
                  //if ( (query.can_currency == "X" ) and ( query.can_buy_sale == "X") )
                     if (  ( query.can_netting == "X" ) or 
                           ( (not _netting) and ( query.can_netting == "" ) ) )
                        GenAgr.AgrID         = query.genagrid;
                        GenAgr.Confirmmethod = query.confirmmethod;
                        GenAgr.Trans = GetTransportForDvndeal(GenAgr.Confirmmethod);
                     end;
                  //end;
               else
                  // для МБК без доп.условий
                  GenAgr.AgrID         = query.genagrid;
                  GenAgr.Confirmmethod = query.confirmmethod;
                  GenAgr.Trans = GenAgr.Confirmmethod;
               end;
            end;
         elif ( num > 1 ) /*устарело: если больше одного, то если найдено два с одинаковыми  условиями, значит не берем ничего, иначе ищем подходящее под информацию из загружаемой сделки*/
            if ( (_type == "PFI") or (_type == "BOND") )
               //gtv:
               /* ищем подходящее ГС под тип сделки и актив, если больше одного, то берем первое по дате начала*/
               GenAgr.AgrID = -1;
               if (_opkind == 12735) //банкнотная сделка
                  add_cond = " and t_can_banknote = chr(88)";
                  GenAgr = FindGenAgrByCondition(sql_str2, add_cond);
               end;

               if (GenAgr.AgrID == -1) //продолжаем поиски
                  // сделки с металлом
                  if (_type == "PFI")
                     if (_dvnfi)
                        fikind1_1 = GetFiKind(_dvnfi.rec.fiid);       // вид базового актива по первой ноге
                        fikind1_2 = GetFiKind(_dvnfi.rec.pricefiid);  // вид контрактива по первой ноге
                     end;
                     if (_dvnfi2)
                        fikind2_1 = GetFiKind(_dvnfi2.rec.fiid);       // вид базового актива по второй ноге
                        fikind2_2 = GetFiKind(_dvnfi2.rec.pricefiid);  // вид контрактива по второй ноге
                     end;
                  elif (_type == "BOND")
                     if (_leg1)
                        fikind1_1 = GetFiKind(_leg1.rec.PFI);
                        fikind1_2 = GetFiKind(_leg1.rec.CFI);
                     end;
                     if (_leg2)
                        fikind2_1 = GetFiKind(_leg2.rec.PFI);     // вид базового актива по второй ноге
                        fikind2_2 = GetFiKind(_leg2.rec.CFI);     // вид контрактива по второй ноге
                     end;                     
                  end;
                  if ( (fikind1_1 == 6) or (fikind1_2 == 6) or (fikind2_1 == 6) or (fikind2_2 == 6)  // золото-платина-серебро-палладий
                      or (fikind1_1 == 7) or (fikind1_2 == 7) or (fikind2_1 == 7) or (fikind2_2 == 7) ) // "артикулы"
                    add_cond = " and t_can_metall = chr(88)";
                    GenAgr = FindGenAgrByCondition(sql_str2, add_cond);
                 end;
               end;

               if (GenAgr.AgrID == -1) //продолжаем поиски
                  //ценные бумаги
                  if ( (fikind1_1 == 2) or (fikind1_2 == 2) or (fikind2_1 == 2) or (fikind2_2 == 2) ) 
                     add_cond = " and t_can_secur = chr(88)";
                     if ( (_opkind == 12137) or (_opkind == 12132) ) // РЕПО
                        add_cond = add_cond + " and t_can_repo = chr(88)";
                     else
                        add_cond = add_cond + " and t_can_buy_sale = chr(88)";
                     end;
                     GenAgr = FindGenAgrByCondition(sql_str2, add_cond);
                  end;
                  if (_type == "BOND") // остановка только для ЦБ
                     if (GenAgr.AgrID == -1)
                        GenAgr.AgrID = -2; // остановка поисков
                     end;
                  end;
               end;

               if (GenAgr.AgrID == -1) //продолжаем поиски
                 //свопы
                 if ( (_opkind == 2710) or (_opkind == 12715) or (_opkind == 22710) )
                    add_cond = " and t_can_svop = chr(88)";
                    GenAgr = FindGenAgrByCondition(sql_str2, add_cond);
                 end;
               end;

               if (GenAgr.AgrID == -1) //продолжаем поиски
                 //валюта
                 if ( (fikind1_1 == 1) and (fikind1_2 == 1) and 
                      (  ( (fikind2_1 == -1) and (fikind2_2 == -1) ) or // вторая нога не задана
                          ( (fikind2_1 == 1) and (fikind2_2 == 1) ) )   // валюта
                     )
                    add_cond = " and t_can_currency = chr(88) and t_can_banknote = chr(0) ";
                    GenAgr = FindGenAgrByCondition(sql_str2, add_cond);
                 end;
               end;

               if (GenAgr.AgrID == -1) //продолжаем поиски
                 //валюта
                 if ( (fikind1_1 == 1) and (fikind1_2 == 1) and 
                      (  ( (fikind2_1 == -1) and (fikind2_2 == -1) ) or // вторая нога не задана
                          ( (fikind2_1 == 1) and (fikind2_2 == 1) ) )   // валюта
                     )
                    add_cond = " and t_can_currency = chr(88) ";
                    GenAgr = FindGenAgrByCondition(sql_str2, add_cond);
                 end;
               end;



               if (GenAgr.AgrID == -1) //так ничего и не нашли, берем первый
                 add_cond = " ";
                 GenAgr = FindGenAgrByCondition(sql_str2, add_cond);
               end;

               if (GenAgr.AgrID == -1) //невозможная ветка
                 GenAgr.AgrID         = -1;
                 GenAgr.Confirmmethod = 0;
                 GenAgr.Trans         = 2;
               end;

                  /*if ( ( query.can_buy_sale == "X") and ( query.can_currency == "X" ) ) /* настройка Покупка/продажа и Валюты*/
                     if (  ( query.can_netting == "X" ) or 
                           ( (not _netting) and ( query.can_netting == "" ) )
                          )/*настройка Неттинг*/
                        post = post+1;
                        if (post  > 1)
                           GenAgr.AgrID         = -1;
                           GenAgr.Confirmmethod = 0;
                           GenAgr.Trans         = 2;
                        else
                           GenAgr.AgrID         = query.genagrid;
                           GenAgr.Confirmmethod = query.confirmmethod;
                           GenAgr.Trans = GetTransportForDvndeal(GenAgr.Confirmmethod);
                        end;
                     end;
                  end;*/
            else
               // для МБК без доп.условий
               sql_str = sql_str3 + sql_str2;
               query = TRsbDataSet(sql_str);
               while (query.MoveNext) 
                  GenAgr.AgrID         = query.genagrid;
                  GenAgr.Confirmmethod = query.confirmmethod;
                  GenAgr.Trans         = GenAgr.Confirmmethod;
               end;
            end;
         end;
      end;
      
   elif (ValType(_numgenagr) != V_UNDEF)/*если информация о ген.соглашении присутствует, то ищем ген.соглашение в базе*/
      GenAgr = GetGenAgr( _numgenagr ); 
      if (_type == "PFI")
         GenAgr.Trans = GetTransportForDvndeal(GenAgr.Confirmmethod);
      else
         GenAgr.Trans = GenAgr.Confirmmethod;
      end;
      
      // gtv: кусок код оставлен, если правила изменятся
      /*CHVA*/
      /*if (GenAgr.AgrID == -1)
            err_txt = "Не найдено ген соглашение с кодом "+_numgenagr+" в СОФР";  
            RunError(err_txt, c_err_obj(err_txt,-3000));
         end;
         if (GenAgr.PartyID != locdeal.rec.CONTR)
            err_txt = "Контрагент "+GenAgr.PartyID+" по генсоглашению "+_numgenagr+" в СОФР отличается от контрагента "+locdeal.rec.CONTR+" по сделке";  
            RunError(err_txt, c_err_obj(err_txt,-3000));
         end;*/
   end;

   // значения могут быть не заданы
   if ( (ValType(GenAgr.Confirmmethod) == V_UNDEF) or (GenAgr.Confirmmethod == 0) )
      GenAgr.Confirmmethod = 2;
      GenAgr.Trans = 2;
   end;

   if (GenAgr.AgrID < 0)
      GenAgr.AgrID = -1;
   end;

   return GenAgr;
end;


//BIQ-5049 gtv: поиск CSA
macro FindCSAGenAgreement(_GenAgreement)
  var CSAId = 0, GenAgr: c_GenAgr;
  var ErrTxt = "";
  var sql_str, cmd, rs;
  
  // значения по умолчанию
  GenAgr.AgrID         = -1;
  GenAgr.PartyID       = -1;
  GenAgr.Confirmmethod = 0;
  GenAgr.Trans         = 2;  // по умолчанию SWIFT
  
  sql_str = "select csa.t_csaid, csa.t_genagrid, ga.t_confirmmethod "+
            "  from ddvcsa_dbt csa, ddl_genagr_dbt ga "+
            " where csa.t_genagrid = ga.t_genagrid "+
            "   and csa.t_code = :code";
  cmd = RSDCommand(sql_str);
  cmd.AddParam("code", RSDBP_IN, _GenAgreement);
  rs = RSDRecordSet(cmd);
  if (rs.movenext)
     CSAId = rs.value("t_csaid");
     GenAgr.AgrID = rs.value("t_genagrid");
     GenAgr.Confirmmethod = rs.value("t_confirmmethod");
     GenAgr.Trans = GetTransportForDvndeal(GenAgr.Confirmmethod);
  else 
     CSAId = 0;
     ErrTxt = "Не найдено CSA с кодом "+_GenAgreement;
  end;
  SetParm(1,ErrTxt);
  SetParm(2,GenAgr);

  return CSAId;
end;

private macro GetFiidByISOCode(code,codekind)
    var sql,rs;

    sql = "SELECT t_Fiid fiid FROM dfininstr_dbt WHERE t_ccy = :1 AND t_fi_kind = :2";

    rs = ExecSqlSelect(sql, MakeArray(SqlParam("1", code),SqlParam("2",codekind)), false);
    if (rs.MoveNext())
        return rs.value(0);
    end;

    rs = null; sql = null;

    //ZMV DEF-71126 Если не нашли, то попробуем поискать по коду в номере счета, взятому из ФИ другого вида
    sql = "SELECT f.t_Fiid fiid FROM dfininstr_dbt f, dfininstr_dbt ff " +
          " WHERE ff.t_ccy = :1 AND ff.t_fi_kind in (1,6) " + 
          "   AND f.t_codeinaccount = ff.t_codeinaccount AND f.t_fi_kind = :2";

    rs = ExecSqlSelect(sql, MakeArray(SqlParam("1", code),SqlParam("2",codekind)), false);
    if (rs.MoveNext())
        return rs.value(0);
    end;

    //ZMV DEF-74122 Добавляем ошибку обработки
    err_txt = "Код инструмента "+code+" не найден в СОФР";  
    RunError(err_txt, c_err_obj(err_txt,-3000));

    return null;
end;

private macro GetFiidIndex(code)
    var sql,rs;

    sql = "SELECT t_Fiid fiid FROM dfininstr_dbt WHERE t_definition = :1 AND t_fi_kind = 3 AND t_isclosed = chr(0)";

    rs = ExecSqlSelect(sql, MakeArray(SqlParam("1", code)), false);
    if (rs.MoveNext())
        return rs.value(0);
    end;
    return -1;
end;

private macro GetFiidIndexMBK(code)
    var sql,rs;

    sql = "SELECT t_Fiid fiid FROM dfininstr_dbt WHERE t_fi_code = :1 AND t_fi_kind = 3";

    rs = ExecSqlSelect(sql, MakeArray(SqlParam("1", code)), false);
    if (rs.MoveNext())
        return rs.value(0);
    end;
    return -1;
end;

private macro GetFinIndex(code)
    var sql,rs;

    sql = "SELECT t_Fiid fiid FROM davoiriss_dbt WHERE t_isin = :1";

    rs = ExecSqlSelect(sql, MakeArray(SqlParam("1", code)), false);
    if (rs.MoveNext())
        return rs.value(0);
    end;
    return -1;
end;

private macro Codeparty(par1,par2)
   var rs, sql;
   sql="SELECT t_objectid FROM dobjcode_dbt where t_objecttype=3 and t_code = :1 and t_codekind = :2 and t_bankdate <= :3 and (t_bankclosedate = to_date('01010001','ddmmyyyy') or t_bankclosedate > :4)";

   rs = ExecSqlSelect(sql, MakeArray(SqlParam("1", par1),SqlParam("2",par2),SqlParam("3",{curdate}),SqlParam("4",{curdate})), false);
   if (rs.MoveNext()) 
      return rs.value(0);
   end;
   return -1;
end;

/**
@brief Функция получения информации о сиквенсе таблицы, к которой принадлежит новая сделка (ddl_tick_dbt/ddvndeal_dbt)
@return "tick" или "ndeal"
*/
private macro GetSequenceType(inputObject): String
  var result: String = "tick";
  
  if ( ((uTryToGetPropS(inputObject.DealData, "CurrencyDeal") != V_UNDEF) and (ValType(inputObject.DealData.CurrencyDeal) == V_GENOBJ)) or
       ((uTryToGetPropS(inputObject.DealData, "CurrencySWAPDeal") != V_UNDEF) and (ValType(inputObject.DealData.CurrencySWAPDeal) == V_GENOBJ)) or
       ((uTryToGetPropS(inputObject.DealData, "CurrencyFWDDeal") != V_UNDEF) and (ValType(inputObject.DealData.CurrencyFWDDeal) == V_GENOBJ)) or
       ((uTryToGetPropS(inputObject.DealData, "FRADeal") != V_UNDEF) and (ValType(inputObject.DealData.FRADeal) == V_GENOBJ)) or
       ((uTryToGetPropS(inputObject.DealData, "CurrencyOptionDeal") != V_UNDEF) and (ValType(inputObject.DealData.CurrencyOptionDeal) == V_GENOBJ)) or
       ((uTryToGetPropS(inputObject.DealData, "IRSSWAPDeal") != V_UNDEF) and (ValType(inputObject.DealData.IRSSWAPDeal) == V_GENOBJ)) )
    result = "ndeal";
  end;
  
  return result;
end;

/**
@brief Функция проверки существования сделки с заданным ID в таблице Kondor_SOFR_Buffer_dbt
@return V_BOOL true - сделка в таблице существует
*/
private macro IsDealExistInBuffer(sequenceType: String, dealCode: String, dealID: Integer): Bool
  var cmd = RSDCommand("SELECT 1 " +
                         "FROM Kondor_SOFR_Buffer_dbt " +
                        "WHERE t_seqID = :secID " +
                          "AND t_seqType = :secType " +
                          "AND t_dealCode = :dealCode ");
  
  cmd.AddParam("secID", RSDBP_IN, dealID);
  cmd.AddParam("secType", RSDBP_IN, sequenceType);
  cmd.AddParam("dealCode", RSDBP_IN, dealCode);

  var rs = RSDRecordset(cmd);
  
  if (rs.MoveNext())
    return true;
  end;
  
  return false;
end;

private macro FindLikeCodeparty(par1,par2)
   var rs, sql;
   sql="SELECT t_objectid FROM dobjcode_dbt where t_objecttype=3 and t_code like :1 and t_codekind = :2 and t_bankdate <= :3 and (t_bankclosedate = to_date('01010001','ddmmyyyy') or t_bankclosedate > :4)";

   rs = ExecSqlSelect(sql, MakeArray(SqlParam("1", par1),SqlParam("2",par2),SqlParam("3",{curdate}),SqlParam("4",{curdate})), false);
   if (rs.MoveNext()) 
      return rs.value(0);
   end;
   return -1;
end;

macro FindPartyByCPTY(_PartyUID)
   var res = -1;
   var partyUID;
   var BIS1, BIS2, DIASOFT;
   var find_code = "";
   
   for (partyUID, _PartyUID)
      if (partyUID.SystemNodeID == "CPTY")
         if (partyUID.SystemID == "BIS_ID")
            BIS1 = partyUID.ObjectID;
         elif (partyUID.SystemID == "BIS_ID2")
            BIS2 = partyUID.ObjectID;
         elif (partyUID.SystemID == "DIASOFT")
            DIASOFT = partyUID.ObjectID;
         end;
      end;
   end;
   
   if (BIS1)
      BIS1 = Substr(BIS1, 3);          // формат B_111111
      find_code = "__#Б#"+Trim(BIS1);    //сначала банк
      res = FindLikeCodeparty(find_code,101);         
      if (res == -1)
         find_code = "__#Y#"+Trim(BIS1);    //юр.лицо
         res = FindLikeCodeparty(find_code,101);
      end;
   end;
   if (res == -1) // не нашли
      if (BIS2)
         BIS2 = Substr(BIS2, 3);          // формат B_111111
         find_code = "__#_#"+Trim(BIS2);  
         res = FindLikeCodeparty(find_code,101);
         if (res == -1)
            find_code = "__#Y#"+Trim(BIS2);    //юр.лицо
            res = FindLikeCodeparty(find_code,101);
         end;
      end;
   end;
   if (res == -1) // все равно не нашли
      if (DIASOFT)
         DIASOFT = Substr(DIASOFT, 6);          // формат D5NT_111111
         find_code = "__#_#"+Trim(DIASOFT);  
         res = FindLikeCodeparty(find_code,102);
      end;
   end;
   
   return res;
   
end;

macro SetRSBPartyCode(_partyid, _pcode)
   var rParty;
   
   rParty = RSBParty(_partyid);
   rParty.Code.SetCode( 103, _pcode );
   rParty.Update();
   
   rParty = null;
end;


private macro GetCode(par1,par2)
   var rs, sql;
   sql="SELECT t_code FROM dobjcode_dbt where t_objecttype=3 and t_objectid = :1 and t_codekind = :2 and t_bankdate <= :3 and (t_bankclosedate = to_date('01010001','ddmmyyyy') or t_bankclosedate > :4)";

   rs = ExecSqlSelect(sql, MakeArray(SqlParam("1", par1),SqlParam("2",par2),SqlParam("3",{curdate}),SqlParam("4",{curdate})), false);
   if (rs.MoveNext()) 
      return rs.value(0);
   end;
   return "";
end;

private macro GetAttr61(par1)
   var rs, sql;
   sql="SELECT t_attrid FROM dobjatcor_dbt where t_objecttype=12 and t_groupid=61 and t_general='X' and t_object = :1 and t_validfromdate <= :2 and (t_validtodate = to_date('01010001','ddmmyyyy') or t_validtodate > :3)";

   rs = ExecSqlSelect(sql, MakeArray(SqlParam("1",string(par1:o:10)),SqlParam("2",{curdate}),SqlParam("3",{curdate})), false);
   if (rs.MoveNext()) 
      return rs.value(0);
   end;
   return -1;
end;

private macro GetNumZalog(sdognum, partyid)
  private var que, rs, dognum, i, e, anum = TArray;
  anum.Size = 0;
  i = 0;
  e = index(sdognum,"=");
  while ( e > 0)

     dognum = substr(sdognum, 1, (e-1) );
     que = "select t.t_contractid from ddl_order_dbt t where t.t_contractor="+string(partyid)+" and t.t_ordernumber='"+dognum+"'";
     rs = LnGetRecordSet(que);
     if(rs != null)
        if (rs.moveNext) 
           anum(i) = rs.value(0); 
        else
           anum(i) = 0; 
        end;
     end;

     i = i+1;
     e = index(sdognum,"=");
     sdognum = substr(sdognum, e+1);
  end;
  return  anum;
end;

private macro InsNewPrice(dealid, price)
   private var rs, que;
   que ="insert into dstd_pls_dbt ("+
         "t_id,   "+
         "t_dizm, "+ 
         "t_stav,  "+
         "t_kor_pro) values ("+
         string(dealid) + ","+
         "to_date('"+date()+"','dd.mm.yyyy'), "+
         string(price*Pow(10,6))+","+
         string(price)+")";
   rs  = LnGetRecordset(que);
end;

private macro RetBasis(FBasis)
  if  (( FBasis == "360/30" ) or ( FBasis == "30/360" ) or ( FBasis == "C" ))
	return 1; 
  elif(( FBasis == "360/ACT") or ( FBasis == "ACT/360") or ( FBasis == "M" ))
	return 2; 
  elif(( FBasis == "365/ACT") or ( FBasis == "ACT/365") or ( FBasis == "5" ))
	return 8; 
  elif(( FBasis == "ACT/ACT") or ( FBasis == "A" ))
	return 4; 
  elif( FBasis == "6" )
	return 3; 
  end;
  return 1; 
end;


private macro RetBasisREPO(FBasis)
  if  (( FBasis == "360/30" ) or ( FBasis == "30/360" ) or ( FBasis == "C" ))
	return 1; 
  elif(( FBasis == "360/ACT") or ( FBasis == "ACT/360") or ( FBasis == "M" ))
	return 3; 
  elif(( FBasis == "365/ACT") or ( FBasis == "ACT/365") or ( FBasis == "5" ))
	return 0; 
  elif(( FBasis == "ACT/ACT") or ( FBasis == "A" ))
	return 2; 
  end;
  return 0; 
end;


//Обеспечение
private macro RetPOB(FPOB)
  if  ( FPOB == "ДА" )
	return 1; 
  elif( FPOB == "НЕТ")
	return 3; 
  end;
  return 1; 
end;

private macro AddField (ar, name, tp, sz, dec)

     ar [ar.size] = name;
     ar [ar.size] = tp;
     ar [ar.size] = sz;
     ar [ar.size] = dec;
     ar [ar.size] = 0;

end;


macro MakeArDeal()

      var ardeal = TArray;

      AddField (ardeal, "CONTR",    V_INTEGER,  4, 0);
      AddField (ardeal, "CONTRNAME",V_STRING,  50, 0);
      AddField (ardeal, "SOGL",     V_INTEGER,  4, 0);
      AddField (ardeal, "FILIAL",   V_INTEGER,  4, 0);
      AddField (ardeal, "CLIENT" ,  V_INTEGER,  4, 0);     
      AddField (ardeal, "DILER",    V_INTEGER,  4, 0);
      AddField (ardeal, "BROKER",   V_INTEGER,  4, 0);
      AddField (ardeal, "BROKER_CODE",   V_STRING,  50, 0);
      AddField (ardeal, "TRADER",   V_INTEGER,  4, 0);
      AddField (ardeal, "TRADERNAME",V_STRING,  50, 0);
      AddField (ardeal, "PSLONG",   V_INTEGER,  4, 0);
      AddField (ardeal, "DEAL_ID",  V_INTEGER,  4, 0);
      AddField (ardeal, "Dockind",  V_INTEGER,  4, 0);
      //Deal общие элементы
      //Идентификация сделки
      AddField (ardeal, "ActionType", V_STRING,  50, 0);
      AddField (ardeal, "ExternalID", V_STRING,  50, 0);
      AddField (ardeal, "TSBrief", V_STRING,  50, 0);
      AddField (ardeal, "DealID", V_STRING,  50, 0);
      AddField (ardeal, "DealKind", V_STRING,  50, 0);
      AddField (ardeal, "DealDate", V_STRING,  50, 0);
      AddField (ardeal, "DealTime", V_STRING,  50, 0);
      AddField (ardeal, "DealCaptureTime", V_STRING,  50, 0);
      AddField (ardeal, "DealCorrectTime", V_STRING,  50, 0);
      AddField (ardeal, "BuySell", V_STRING,  50, 0);
      AddField (ardeal, "FO", V_STRING,  50, 0);
      AddField (ardeal, "ConversationID", V_STRING,  50, 0);
      AddField (ardeal, "ConversationText", V_STRING,  50, 0);
      AddField (ardeal, "Comment", V_STRING,  100, 0);
      AddField (ardeal, "GenAgreement", V_STRING,  50, 0);
      //Участники Сделки
      AddField (ardeal, "PartyKind", V_STRING,  50, 0);
      AddField (ardeal, "PartyIDKind", V_STRING,  50, 0);
      AddField (ardeal, "PartyID", V_STRING,  50, 0);
      AddField (ardeal, "PartyCode", V_STRING,  50, 0);
      AddField (ardeal, "PartyFullName", V_STRING,  50, 0);
      AddField (ardeal, "PartyShortName", V_STRING,  50, 0);
      //Использование лимитов
      AddField (ardeal, "Type", V_STRING,  50, 0);
      AddField (ardeal, "Name", V_STRING,  50, 0);
      AddField (ardeal, "Status", V_STRING,  50, 0);
      AddField (ardeal, "Value", V_STRING,  50, 0);
      AddField (ardeal, "Rest", V_STRING,  50, 0);
      //Платежные инструкции 1
      AddField (ardeal, "PayInstrKind1", V_STRING,  50, 0);
      AddField (ardeal, "PayInstr1", V_STRING,  50, 0);
      AddField (ardeal, "PayComment1", V_STRING,  50, 0);
      AddField (ardeal, "IsBESP1", V_STRING,  50, 0);
      //Платежные инструкции 2
      AddField (ardeal, "PayInstrKind2", V_STRING,  50, 0);
      AddField (ardeal, "PayInstr2", V_STRING,  50, 0);
      AddField (ardeal, "PayComment2", V_STRING,  50, 0);
      AddField (ardeal, "IsBESP2", V_STRING,  50, 0);
      //Платежные инструкции 3
      AddField (ardeal, "PayInstrKind3", V_STRING,  50, 0);
      AddField (ardeal, "PayInstr3", V_STRING,  50, 0);
      AddField (ardeal, "PayComment3", V_STRING,  50, 0);
      AddField (ardeal, "IsBESP3", V_STRING,  50, 0);
      //Платежные инструкции2 1
      AddField (ardeal, "PayInstrKind21", V_STRING,  50, 0);
      AddField (ardeal, "PayInstr21", V_STRING,  50, 0);
      AddField (ardeal, "PayComment21", V_STRING,  50, 0);
      AddField (ardeal, "IsBESP21", V_STRING,  50, 0);
      //Платежные инструкции2 2
      AddField (ardeal, "PayInstrKind22", V_STRING,  50, 0);
      AddField (ardeal, "PayInstr22", V_STRING,  50, 0);
      AddField (ardeal, "PayComment22", V_STRING,  50, 0);
      AddField (ardeal, "IsBESP22", V_STRING,  50, 0);
      //Платежные инструкции2 3
      AddField (ardeal, "PayInstrKind23", V_STRING,  50, 0);
      AddField (ardeal, "PayInstr23", V_STRING,  50, 0);
      AddField (ardeal, "PayComment23", V_STRING,  50, 0);
      AddField (ardeal, "IsBESP23", V_STRING,  50, 0);
      //Описание сделки
      AddField (ardeal, "PairsName", V_STRING,  50, 0);
      AddField (ardeal, "CurrencyDeals", V_STRING,  50, 0);
      AddField (ardeal, "Rate", V_STRING,  50, 0);
      AddField (ardeal, "RateDirection", V_STRING,  50, 0);
      AddField (ardeal, "RateQutationUnit", V_STRING,  50, 0);
      AddField (ardeal, "MarginSpot", V_STRING,  50, 0);
      AddField (ardeal, "PreCon", V_STRING,  50, 0);
      AddField (ardeal, "IsNostro", V_STRING,  50, 0);
      AddField (ardeal, "IsDerivative", V_STRING,  50, 0);
      AddField (ardeal, "Bnote", V_STRING,  50, 0);
      AddField (ardeal, "Points", V_STRING,  50, 0);
      AddField (ardeal, "Details", V_STRING,  50, 0);
      //Платежи
      AddField (ardeal, "ValueDate1", V_STRING,  50, 0);
      AddField (ardeal, "ValueDate2", V_STRING,  50, 0);
      AddField (ardeal, "Amount1", V_STRING,  50, 0);
      AddField (ardeal, "Amount2", V_STRING,  50, 0);

      return ardeal;
end;

var locdeal = TRecHandler ("deal", MakeArDeal()),
    locdealdata;

//Получить параметр основной сделки при вставке пролонгирующей
private macro GetIdOperation(DealType, dealpfi)
  private var que, rs, dealid;

  que = "select t.t_dealid from ddl_tick_dbt t, ddl_leg_dbt l where t.t_dealtype ='"+DealType+"' and t.t_bofficekind=102  and t.t_dealstatus=0 and t.t_dealid=l.t_dealid and " +
        "t.t_pfi = "+dealpfi +" and t.t_partyid="+locdeal.rec.CONTR +" and t.t_dealdate=to_date('"+locdeal.rec.DEALDATE+"', 'DD.MM.YYYY') and l.t_principal="+locdeal.rec.PRINCIPAL +" and l.t_start=to_date('"+locdeal.rec.BEGDATE+"', 'DD.MM.YYYY') and l.t_maturity =to_date('"+locdeal.rec.ENDDATE+"', 'DD.MM.YYYY')";
  rs = LnGetRecordSet(que);

  if (rs != null)
    if (rs.moveNext) 
      dealid =  rs.value(0) ; 
    else
      return 0;
    end;	
  end;

  que = "select t.t_id_operation from  doproper_dbt t where t.t_dockind=102 and t.t_documentid = lpad("+dealid+",34,'0')";
  rs = LnGetRecordSet(que);
  if (rs != null)
    if (rs.moveNext) 
      return  rs.value(0) ; 
    else
      return 0;
    end;	
  end;
end;

//справочник каналов связи для МБК (для dl_tick)
private macro FindNameAlg(_name)
   var res = 0;
   var sql_str, cmd, rs;
   var vitypealg = 2118;

   sql_str = "select t_inumberalg from dnamealg_dbt where t_itypealg = :vitypealg and upper(t_sznamealg) = :vtemp";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("vitypealg", RSDBP_IN, vitypealg);
   cmd.AddParam("vtemp", RSDBP_IN, StrUpr(_name));
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      res = rs.value("t_inumberalg");
   end;
   return res;
end;

//справочник каналов связи для ФИССиКО (для dvndeal)
private macro FindAttrID(_name, _objecttype, _groupid)
   var res = 0;
   var sql_str, cmd, rs;

   sql_str = "select t_attrid from dobjattr_dbt where t_objecttype = :objecttype and t_groupid = :groupid and upper(t_name) = upper(:nameattr)";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("objecttype", RSDBP_IN, _objecttype);
   cmd.AddParam("groupid", RSDBP_IN, _groupid);
   cmd.AddParam("nameattr", RSDBP_IN, _name);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      res = rs.value(0);
   end;
   return res;

end;


// строковое определение канала связи
private macro DefineLinkChannel(locdealdata)
   var res = "-1";

   if (res == "-1")
     if ( (VALTYPE(locdealdata.IdentityDeal.Comment) != V_UNDEF) and (Index(StrUpr(locdealdata.IdentityDeal.Comment),"BLOOMBERG") > 0) )
        res = "Bloomberg";
     end;
   end;
   if (res == "-1")
     if ( (VALTYPE(locdealdata.IdentityDeal.ConversationText) != V_UNDEF) and (Index(StrUpr(locdealdata.IdentityDeal.ConversationText),"CAPTURE DEAL") > 0) )
        res = "Телефон";
     end;
   end;
   if (res == "-1")
     if ( (VALTYPE(locdealdata.IdentityDeal.TSBrief) != V_UNDEF) and (Index(StrUpr(locdealdata.IdentityDeal.TSBrief),"DEALING 3000") > 0) )
        res = "Reuter";
     end;
   end;
   if (res == "-1")
     if ( (VALTYPE(locdealdata.IdentityDeal.TSBrief) != V_UNDEF) and (Index(StrUpr(locdealdata.IdentityDeal.TSBrief),"ММВБ") > 0) 
          and ((locdeal.rec.CONTRNAME == "MICX") or (locdeal.rec.CONTRNAME == "MICR")) )
        res = "Московская биржа";
     end;
   end;
   return res;
end;

// канал связи по справочнику для МБК (для dl_tick)
private macro GetLinkChannel(locdealdata)
   var res = 0;
   var link_channel = "-1";

   link_channel = DefineLinkChannel(locdealdata);
   res = FindNameAlg(link_channel);
   if ( (link_channel == "Reuter") and (res == 0) )
      link_channel = "Reuters";
      res = FindNameAlg(link_channel);
   end;

   return res;
end;


///////////////////////////////////////////////////////////////////////////////////
// MBKDeal
///////////////////////////////////////////////////////////////////////////////////
private class DlngPaymentMBK()
  private const
      mode_ins = 0,
      mode_upd = 1,
      mode_del = 2;

  private var
      prm_workMode = NULL;

  private var
      prm_pmObj  = NULL;

  macro SetPurpose(_Purpose, _SubPurpose)
      prm_pmObj.Purpose    = _Purpose;
      prm_pmObj.SubPurpose = _SubPurpose;
      prm_pmObj.Number     = String(_SubPurpose);
  end;

  macro SetDocKind(_DocKind)
      prm_pmObj.DocKind = _DocKind;
  end;

  macro SetDocumentID(_DocumentID)
      prm_pmObj.DocumentID = _DocumentID;
  end;

  macro SetDepartment(_Department)
      prm_pmObj.Department = _Department;
  end;

  macro SetFIID(_FIID)
      prm_pmObj.OrderFIID          =
      prm_pmObj.BaseFIID           = 
      prm_pmObj.PayerFIID          =
      prm_pmObj.ReceiverFIID       =
      prm_pmObj.FuturePayerFIID    =
      prm_pmObj.FutureReceiverFIID = _FIID;
  end;

  macro SetLegID(_LegID)
      //dprm_LegID = _LegID;
  end;

  macro SetNetting(_Netting)
      prm_pmObj.Netting  = _Netting;
  end;

  macro SetDate(_VDate, _RDate)
      prm_pmObj.Date                 = _VDate;
      prm_pmObj.PayDate              = 
      prm_pmObj.OutTransferDate      =
      prm_pmObj.ValueDate            = _RDate;
      prm_pmObj.ClientDate           = {curdate};
  end;

  macro SetAmount(_Amount)
      prm_pmObj.OrderAmount          =
      prm_pmObj.PayerAmount          = 
      prm_pmObj.ReceiverAmount       = 
      prm_pmObj.BaseAmount           =
      prm_pmObj.FutureBaseAmount     = _Amount;
      prm_pmObj.ActuateFutureAmounts(TBA_AMOUNT);
  end;

  macro SetGround(_Ground)
      prm_pmObj.Ground = _Ground;
  end;

  private macro GetSettAcc(_PartyID, _FIKind, _FIID, _ServiceKind, _Kind_Operation, _Overnight, _settacc:@strucref)
      var query;
      var Select;
   
      if (not _Overnight)
         if (not FindSETTACC_PMAUTO(_PartyID, _FIKind, _FIID, _ServiceKind, _Kind_Operation, prm_pmObj.Purpose, 0, _settacc))
            ;
         elif (not FindSETTACC_PMAUTO(_PartyID, _FIKind, _FIID, _ServiceKind, _Kind_Operation, 0, 0, _settacc))
            ;
         elif (not FindSETTACC_PMAUTO(_PartyID, _FIKind, _FIID, _ServiceKind, 0, prm_pmObj.Purpose, 0, _settacc))
            ;
         elif (not FindSETTACC_PMAUTO(_PartyID, _FIKind, _FIID, _ServiceKind, 0, 0, 0, _settacc))
            ;
         end;
      else
         query =   " select sett.* "
               + " from dsettacc_dbt sett, dpmautoac_dbt pm"
               + " where sett.t_FIKind = " +  _FIKind
               + "   and sett.t_PartyID = " + _PartyID
               + "   and sett.t_FIID = " + _FIID
               + "   and sett.t_SettAccID = pm.t_SettAccID"
               + "   and pm.t_ServiceKind = " + _ServiceKind
               + "   and sett.t_SPI_Ident = 'Overnight'";


         Select = TRsbDataSet(query);
         if( Select.MoveNext() )
            _settacc.FIID = Select.FIID;
            _settacc.Code = Select.Code;
            _settacc.RecName = Select.RecName;
            _settacc.INN = Select.INN;
            _settacc.BankCorrID = Select.BankCorrID;
            _settacc.BankCorrName = Select.BankCorrName;
            _settacc.CorrAcc = Select.CorrAcc;
            _settacc.BankID  = Select.BankID;
            _settacc.BankName = Select.BankName;
            _settacc.BankCode = Select.BankCode;
            _settacc.Chapter = Select.Chapter;
            _settacc.Account = Select.Account;
            _settacc.CorrAcc = Select.CorrAcc;
            _settacc.SettAccID = Select.SettAccID;
         else

         end;

      end;
  end;

  macro SetPayer(_Payer, _PayerCodeKind, _PayerBankID, _PayerBankIDCodeKind, _Kind_Operation, _FIID, _Overnight)
      RECORD settacc(settacc);
      RECORD settaccour(settacc);

      if (_Payer == {OurBank})

          GetSettAcc(_PayerBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, _Overnight, @settaccour);


          prm_pmObj.SetPayerPI(PAYMENTS_GROUP_UNDEF,
                              _PayerBankID,
                              _PayerBankIDCodeKind,
                              settaccour.BankCode, 
                              settaccour.BankName,  
                              "",//settaccour.CorrAcc,    //коррсчет
                              _FIID,
                              settaccour.Chapter,
                              settaccour.Account, 
                              _Payer, 
                              "",
                              settaccour.INN,
                              _PayerCodeKind,       
                              settacc.Code                // клиент
                              );


          /*
          prm_pmObj.PayerBankName = settaccour.BankName; //prm_pmObj.PayerName;
          prm_pmObj.PayerBankCorrCodeKind = PTCK_ALL;
          prm_pmObj.PayerBankCorrCode     = "";
          prm_pmObj.ReceiverInOurBalance  = "";*/
          prm_pmObj.ReceiverOurCorrAcc    = settaccour.CorrAcc;
          //prm_pmObj.ReceiverOurCorrID     = -1;

      else
          GetSettAcc(_PayerBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, _Overnight, @settacc);


          prm_pmObj.SetPayerPI(PAYMENTS_GROUP_UNDEF,
                                _PayerBankID,
                                _PayerBankIDCodeKind,
                                 settacc.BankCode,
                                 settacc.BankName,  
                                 "", //settacc.CorrAcc,
                                 _FIID, /*          settacc.FIID,   */
                                 settacc.Chapter,
                                 settacc.Account, 
                                 _Payer,        /* settacc.PartyID,  */
                                 settacc.RecName,
                                 settacc.INN,
                                 _PayerCodeKind,  /*settacc.CodeKind, */
                                 settacc.Code  //clnt  
                                 );

          if (settacc.BankCorrID != {OurBank})
              prm_pmObj.PayerBankCorrAcc      = settacc.CorrAcc; 
              prm_pmObj.PayerBankCorrCodeKind = settacc.BankCorrCodeKind;
              prm_pmObj.PayerBankCorrCode     = settacc.BankCorrCode;
              prm_pmObj.PayerBankCorrName     = settacc.BankCorrName;
          end;

      end;
  end;

  macro SetReceiver(_Receiver, _ReceiverCodeKind, _ReceiverBankID, _ReceiverBankIDCodeKind, _Kind_Operation, _FIID, _Overnight);
      RECORD settaccour(settacc);
      RECORD settacc(settacc);

      if (_Receiver == {OurBank})
          GetSettAcc(_ReceiverBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, _Overnight, @settaccour);

          prm_pmObj.SetReceiverPI(PAYMENTS_GROUP_UNDEF,
                              _ReceiverBankID,
                              _ReceiverBankIDCodeKind,  
                              settaccour.BankCode,
                              settaccour.BankName,
                              "", //settaccour.CorrAcc,
                              _FIID,
                              settaccour.Chapter,
                              settaccour.Account, 
                              _Receiver,
                              "",
                              settaccour.INN,
                              _ReceiverCodeKind,   
                              settacc.Code  //clnt  
                              );

          /*
          prm_pmObj.ReceiverBankName = settaccour.BankName; //prm_pmObj.ReceiverName;
          prm_pmObj.ReceiverBankCorrCodeKind = PTCK_ALL;
          prm_pmObj.ReceiverBankCorrCode     = "";
          prm_pmObj.PayerInOurBalance  = "";*/
          prm_pmObj.PayerOurCorrAcc    = settaccour.CorrAcc;
          //prm_pmObj.PayerOurCorrID     = -1;

      else
          GetSettAcc(_ReceiverBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, _Overnight, @settacc);

          prm_pmObj.SetReceiverPI(PAYMENTS_GROUP_UNDEF,
                                 _ReceiverBankID,
                                 _ReceiverBankIDCodeKind,
                                 settacc.BankCode,
                                 settacc.BankName,   
                                 "",                // settacc.CorrAcc,
                                 _FIID,             // settacc.FIID, 
                                 settacc.Chapter,
                                 settacc.Account, 
                                 _ReceiverBankID,   // settacc.PartyID, 
                                 settacc.RecName,
                                 settacc.INN,
                                 _ReceiverCodeKind,  // settacc.CodeKind,
                                 settacc.Code        //clnt  
                                 );

          if (settacc.BankCorrID != {OurBank})
              prm_pmObj.ReceiverBankCorrAcc      = settacc.CorrAcc;
              prm_pmObj.ReceiverBankCorrCodeKind = settacc.BankCorrCodeKind;
              prm_pmObj.ReceiverBankCorrCode     = settacc.BankCorrCode;
              prm_pmObj.ReceiverBankCorrName     = settacc.BankCorrName;
          end;

     end;    

  end;

  macro CreateNew()
      private var cerr;
      prm_pmObj.Actuate();

      cerr = prm_pmObj.Update();
      if ( cerr )
          err_txt = "Ошибка при создании платежей."+string(cerr);  
          RunError(err_txt, c_err_obj(err_txt,-3000));
      end;
  end;

  private macro ClassConstructorNew()
      prm_workMode = mode_ins;

      prm_pmObj  = RsbPayment(0);
      prm_pmObj.Department       = {OperDprt};
      prm_pmObj.PaymStatus       = PM_PREPARING;
      prm_pmObj.IsPlanPaym       = "X";
      prm_pmObj.ValueDate        = {curdate};
      prm_pmObj.SubPurpose       = 0;
      prm_pmObj.Oper             = {oper};
      prm_pmObj.Origin           = PAYMENT_OR_AUTO;
  end;

  private macro ClassConstructor(CountParm)
      if (CountParm == 1)
          ClassConstructorNew();
      elif (CountParm == 2)
      //
      elif (CountParm == 5)
      //
      end;
  end;

  ClassConstructor(ParmCount());
end;


///////////////////////////////////////////////////////////////////////////////////
private class Ob_MBKDeal( obdeal )
  private var
      prm_SeanceID,
      prm_RecordID;

  private var
      prm_ObjID,
      prm_Comment;

  private var
      RG, cnt, cntpl;

  private var
      prm_tick,
      prm_legBase,
      prm_legRev;

  private var
      prm_deferOp,
      prm_deferDoc;

  private macro Basis_mbk(s1,s2)
      private var que,rs10,rez;
      rez=100;

      //в селекте некотораяя избыточность
      if ( s1 == 12305 ) //  размещение
          que="select t_number from dprccalc_dbt where t_chargescheduleid=2 and t_groupcalcid=2 and t_resourcekind=2 and t_calendar='"+s2+"'";

      elif ( s1 == 12300 ) // привлечение
          que="select t_number from dprccalc_dbt where t_chargescheduleid=2 and t_groupcalcid=3 and t_resourcekind=1 and t_calendar='"+s2+"'";
      end;
      rs10 = LnGetRecordset(que);
      if (rs10 != null)
          if (rs10.moveNext) 
              rez=rs10.value(0);
          end;
      end;
      return rez;
  end;

  private macro CreateMBKDeal(_BofficeKind)
      prm_tick.rec.DealID      = IIF(prm_ObjID > 0, prm_ObjID, 0);
      prm_tick.rec.BofficeKind = _BofficeKind;

      //Статические параметры   
      prm_tick.rec.TradeSystem = 0; //PTCK_REUTER;  //LKL???
      prm_tick.rec.DealStatus  = DL_PREPARING;
      prm_tick.rec.RegDate     = {curdate};
      prm_tick.rec.Oper        = {oper};   
      prm_tick.rec.ClientID    = ALLFININSTR;
      prm_tick.rec.DepositID   = ALLFININSTR;
      prm_tick.rec.MarketID    = ALLFININSTR;
      prm_tick.rec.PortfolioID = 0;
      prm_tick.rec.IndocID     = 0;
      prm_tick.rec.NumberPack  = 0;
      prm_tick.rec.Department  = 1; //locdeal.rec.FILIAL;
      prm_tick.rec.OriginID    = GT_REUTERS;  //LKL???
      prm_tick.rec.Netting     = 1;
      prm_tick.rec.LinkChannel = GetLinkChannel(locdealdata); //gtv: по умолчанию 0 "Прочие"
      prm_tick.rec.conftpid    = 2; //SWIFT код подтверждения
      prm_tick.rec.datatype    = 1; //maa

      //Генеральное соглашение
      var GenAgr;
      prm_tick.rec.GenagrID = -1;
      

//А.Киселев 05.02.2020 проверить категорию 172 субъекта
      if( (locdealdata.IdentityDeal.DealKind != "IAM") or
          (locdealdata.IdentityDeal.DealKind == "IAM") and
          ( not IsAttrIdExistsSimple( OBJTYPE_PARTY, PT_ATTRID_NOTADD_GENAGR, locdeal.rec.CONTR ) ) )
       // gtv: поиск ГС вынесен в отдельную функцию
       GenAgr = FindGenAgreementByParty(locdealdata.IdentityDeal.GenAgreement, 1, locdeal.rec.CONTR, "MBK"); 
       prm_tick.rec.GenagrID = GenAgr.AgrID;           // по умолчанию -1
       prm_tick.rec.conftpid = GenAgr.Confirmmethod;   // по умолчанию SWIFT
      end;
//А.Киселев 05.02.2020 проверить категорию 172 субъекта

      
      //генерим номер сделки - не генерим
      prm_tick.rec.DealCode = locdealdata.IdentityDeal.DealID;

      //Номер сделки в торговой системе
      if (VALTYPE(locdealdata.IdentityDeal.ExternalID) != V_UNDEF)
         prm_tick.rec.DealCodeTS = locdealdata.IdentityDeal.ExternalID; 
      else
         prm_tick.rec.DealCodeTS = ""; 
      end;

      //Дата заключения сделки   
      prm_tick.rec.DealDate =  locdealdata.IdentityDeal.DealDate; 

      //Время заключения сделки   
      prm_tick.rec.DealTime = Time(0,0,0);
      if (ValType(locdealdata.IdentityDeal.DealTime) != V_UNDEF)
         prm_tick.rec.DealTime = Time(locdealdata.IdentityDeal.DealTime);
      end;

      //Дилер   
      prm_tick.rec.TraderID = locdeal.rec.TRADER;
      if (prm_tick.rec.TraderID == -1)
         prm_tick.rec.TraderID = 0;
      end;

      //Идентификатор контрагента   
      prm_tick.rec.PartyID = locdeal.rec.CONTR;
      // 30092019 gtv: платежный агент = контрагент
      prm_tick.rec.Paymagent = locdeal.rec.CONTR;


      //Брокер   
      prm_tick.rec.BrokerID = locdeal.rec.BROKER;
      if (prm_tick.rec.BrokerID == -1)
         prm_tick.rec.BrokerID = 0;
      end;
      //Системный тип документа   
      if (locdealdata.IdentityDeal.BuySell == "Loan")
         prm_tick.rec.TypeDoc = "L";
      elif (locdealdata.IdentityDeal.BuySell == "Deposit")
         prm_tick.rec.TypeDoc = "D";
      end;

      //Комментарий
      if (VALTYPE(locdealdata.IdentityDeal.TSBrief) != V_UNDEF)
         prm_tick.rec.Comment = "Торг.площадка:"+locdealdata.IdentityDeal.TSBrief+", ";
      end;
      prm_tick.rec.Comment = prm_tick.rec.Comment + "Комментарий:"+locdealdata.IdentityDeal.Comment;

      //тип сделки
      if   ( locdealdata.DealData.IAMLDDeal.TypeDeal == 1 ) //привлечение
         prm_tick.rec.DealType = 12300;
      elif ( locdealdata.DealData.IAMLDDeal.TypeDeal == 2 ) //размещение
         prm_tick.rec.DealType = 12305; 
      end;

      //Группа сделки
      prm_tick.rec.DealGroup = GetOperationGroup (prm_tick.rec.DealType);

      if (locdealdata.IdentityDeal.DealKind == "IAM")
         prm_tick.rec.DealCodeTS = substr(prm_tick.rec.DealCode,5); 
      end;

    
      //leg1
      prm_legBase.rec.DepositID    = ALLFININSTR;
      prm_legBase.rec.Registrar    = ALLFININSTR;
      prm_legBase.rec.Pitch        = 1;
      prm_legBase.rec.Mode         = 1;
      prm_legBase.rec.PeriodNumber = 10000;
      prm_legBase.rec.PeriodType   = 3;
      prm_legBase.rec.Diff         = 0;
      prm_legBase.rec.PayDay       = 0;
      prm_legBase.rec.TablePercent = "";
      prm_legBase.rec.Caption      = 0;
      prm_legBase.rec.TypeDate     = 0;
      prm_legBase.rec.CountDay     = 0;
      prm_legBase.rec.Correct      = 0;
      prm_legBase.rec.LegID = 1;
      prm_legBase.rec.Scale = 100;
                                                      
           //валюта
      prm_legBase.rec.PFI = GetFiidCodeByName(locdealdata.DealData.IAMLDDeal.CurrencyDeals);
      prm_legBase.rec.CFI = prm_legBase.rec.PFI;

      if (locdealdata.IdentityDeal.DealKind == "IAM")
         if (ValType(locdealdata.DealData.IAMLDDeal.Payments) == V_UNDEF)
            err_txt = "Нет блока Payments.";  
            RunError(err_txt, c_err_obj(err_txt,-3000));
         end;
         // Даты валютирования
         prm_legBase.rec.Start = locdealdata.DealData.IAMLDDeal.Payments.ValueDate1; 
         prm_legBase.rec.Maturity = locdealdata.DealData.IAMLDDeal.Payments.ValueDate2; 
         //сумма
         prm_legBase.rec.Principal = abs(Money(locdealdata.DealData.IAMLDDeal.Payments.Amount1));
         //Сумма процентов
         prm_legBase.rec.Cost = round(Money(abs(locdealdata.DealData.IAMLDDeal.Payments.Amount2)-abs(locdealdata.DealData.IAMLDDeal.Payments.Amount1)),2);
      else // LD CSA
         if (ValType(locdealdata.DealData.IAMLDDeal.CashFlow) == V_UNDEF)
            err_txt = "Нет блока CashFlow.";  
            RunError(err_txt, c_err_obj(err_txt,-3000));
         end;
         cnt = cntpl = 0;
         prm_legBase.rec.Principal = prm_legBase.rec.Cost = $0;
         while (locdealdata.DealData.IAMLDDeal.CashFlow.Size > cnt)
            if (locdealdata.DealData.IAMLDDeal.CashFlow[cnt].Type == "N")
               if (locdealdata.DealData.IAMLDDeal.CashFlow[cnt].Amount > 0) //(cntpl == 0)
                  prm_legBase.rec.Principal = abs(locdealdata.DealData.IAMLDDeal.CashFlow[cnt].Amount);
                  prm_legBase.rec.Start = locdealdata.DealData.IAMLDDeal.CashFlow[cnt].DatePay;
                  cntpl = 1;
               elif (locdealdata.DealData.IAMLDDeal.CashFlow[cnt].Amount < 0) //(cntpl == 1)
                  prm_legBase.rec.Maturity = locdealdata.DealData.IAMLDDeal.CashFlow[cnt].DatePay;
               end;
/* DEF-13950 Для LD сделок берем платежи с типом I */
            elif (locdealdata.DealData.IAMLDDeal.CashFlow[cnt].Type == "I")
               if (locdealdata.DealData.IAMLDDeal.CashFlow[cnt].Amount > 0) //(cntpl == 0)
                  prm_legBase.rec.Principal = abs(locdealdata.DealData.IAMLDDeal.CashFlow[cnt].Amount);
                  prm_legBase.rec.Start = locdealdata.DealData.IAMLDDeal.CashFlow[cnt].DatePay;
                  cntpl = 1;
               elif (locdealdata.DealData.IAMLDDeal.CashFlow[cnt].Amount < 0) //(cntpl == 1)
                  prm_legBase.rec.Maturity = locdealdata.DealData.IAMLDDeal.CashFlow[cnt].DatePay;
               end;
/* DEF-13950 Для LD сделок берем платежи с типом P */
            elif (locdealdata.DealData.IAMLDDeal.CashFlow[cnt].Type == "P")
               if (locdealdata.DealData.IAMLDDeal.CashFlow[cnt].Amount > 0) //(cntpl == 0)
                  prm_legBase.rec.Principal = abs(locdealdata.DealData.IAMLDDeal.CashFlow[cnt].Amount);
                  prm_legBase.rec.Start = locdealdata.DealData.IAMLDDeal.CashFlow[cnt].DatePay;
                  cntpl = 1;
               elif (locdealdata.DealData.IAMLDDeal.CashFlow[cnt].Amount < 0) //(cntpl == 1)
                  prm_legBase.rec.Maturity = locdealdata.DealData.IAMLDDeal.CashFlow[cnt].DatePay;
               end;
/* /DEF-13950 */
            elif (locdealdata.DealData.IAMLDDeal.CashFlow[cnt].Type == "I")
               prm_legBase.rec.Cost = prm_legBase.rec.Cost + round(abs(locdealdata.DealData.IAMLDDeal.CashFlow[cnt].Amount),2);
            end;
            cnt = cnt + 1;
         end;
      end;

      //Количество дней в сделке для расчета процентов
      prm_legBase.rec.Duration = prm_legBase.rec.Maturity - prm_legBase.rec.Start;

      prm_tick.rec.FlagTypeDeal = 0;
      if (prm_legBase.rec.Duration == 1)
         prm_tick.rec.FlagTypeDeal = 1;
      end;
      if (not prm_tick.insert)
         err_txt = "Ошибка при создании новой сделки.";  
         RunError(err_txt, c_err_obj(err_txt,-3000));
      end;

      prm_legBase.rec.DealID = prm_tick.rec.DealID;

      prm_legBase.rec.LegNumber = prm_tick.rec.DealCode;

      prm_legBase.rec.Point = 2;

      //Действующая ставка 
      if (locdealdata.DealData.IAMLDDeal.InterestRateType == "Fix")
// 2020-03-23 Cherednichenko - целочисленные значения в типе Double криво заходят в базу, переводим в Integer
//         prm_legBase.rec.Price = Double(locdealdata.DealData.IAMLDDeal.RateTotal*100);    //проценты
         prm_legBase.rec.Price = round( Double(locdealdata.DealData.IAMLDDeal.RateTotal*100), 0);    //проценты
         InsNewPrice(prm_tick.rec.DealID, Double(locdealdata.DealData.IAMLDDeal.RateTotal*100));
      end;
      //Таблица процентов
      if (locdealdata.DealData.IAMLDDeal.InterestRateType == "Float")
          prm_legBase.rec.TablePercent = "X"; 
          prm_legBase.rec.TypePercent = 1; 
          prm_legBase.rec.Caption = GetFiidIndexMBK(locdealdata.DealData.IAMLDDeal.RateFloatShortName);
          if (prm_legBase.rec.Caption == -1)
             err_txt = "Ошибка. В СОФР не найдена плавающая ставка - " + locdealdata.DealData.IAMLDDeal.RateFloatShortName;  
             RunError(err_txt, c_err_obj(err_txt,-3000));
          end;
          prm_legBase.rec.Correct = Double(locdealdata.DealData.IAMLDDeal.RateDiscount); // add
      end;

      //Базис расчета процентов
      prm_legBase.rec.Basis = RetBasis(locdealdata.DealData.IAMLDDeal.Basis); 

      basi=Basis_mbk(prm_tick.rec.dealtype, prm_legBase.rec.Basis);

      if (not prm_legBase.insert)
         err_txt = "Ошибка при создании новой сделки.";  
         RunError(err_txt, c_err_obj(err_txt,-3000));
      end
  end;

  private macro CreatePaym(ftype, rdate, vdate, amount, fiid)
  //  private macro CreatePaym(ftype, rdate, vdate, amount, fiid, pbank, pacc)
    var
        paym       = DlngPaymentMBK(),
        Purpose,
        TypeBankCode = 3,
        type         = 0,
        BankID       = -1,
        Ground       = "",
        Overnight    = 0;

      paym.SetDocKind(prm_tick.rec.BofficeKind);
      paym.SetDocumentID(prm_tick.rec.DealID);
      paym.SetPurpose(Purpose, 0);
      paym.SetDepartment(prm_tick.rec.Department);
      paym.SetDate(vdate, rdate);
      paym.SetAmount(amount);
      paym.SetFIID(fiid);

      BankID = prm_tick.rec.PartyID;
      if (fiid==0)
         TypeBankCode = PTCK_BIC;
      else 
         //if (PartyIsNotResident(prm_tick.rec.PartyID)) //maa240419      //SVE 518552
         TypeBankCode = PTCK_SWIFT;            
         //else 
         //   TypeBankCode = PTCK_BIC;
         //end;
      end;
      /*
      if (prm_tick.rec.Netting == 3)
          paym.SetNetting("X");
      else
          paym.SetNetting("");
      end;
      */

      Overnight = Index(StrLwr(prm_tick.rec.Comment), "overnight");
      if (prm_tick.rec.PartyID != 343)
        Overnight = 0;
      end;

      if (ftype == 0)
          Purpose = PM_PURP_PRINC;
          paym.SetLegID(prm_legBase.rec.LegID);
          paym.SetPurpose(Purpose, 0);
          Ground = "Предоставление средств по сделке №"+locdealdata.IdentityDeal.DealID+" от "+locdealdata.IdentityDeal.DealDate;
          paym.SetGround(Ground);

          if (IsCOMMITMENT (prm_tick.rec.DealGroup, Purpose))
              paym.SetPayer({OurBank}, TypeBankCode, {OurBank}, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI, 0);
              paym.SetReceiver(prm_tick.rec.PartyID, TypeBankCode, BankID, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI, Overnight);
          else
              paym.SetReceiver({OurBank}, TypeBankCode, {OurBank}, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI, 0);
              paym.SetPayer(prm_tick.rec.PartyID, TypeBankCode, BankID, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI, Overnight);
          end;

       elif (ftype == 1)
          Purpose = PM_PURP_PRINC_RET;
          paym.SetLegID(prm_legBase.rec.LegID);
          paym.SetPurpose(Purpose, 0);
          Ground = "Погашение основного долга по сделке №"+locdealdata.IdentityDeal.DealID+" от "+locdealdata.IdentityDeal.DealDate;
          paym.SetGround(Ground);

          if (IsCOMMITMENT (prm_tick.rec.DealGroup, Purpose))
              paym.SetPayer({OurBank}, TypeBankCode, {OurBank}, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI, 0);
              paym.SetReceiver(prm_tick.rec.PartyID, TypeBankCode, BankID, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI, Overnight);
          else
              paym.SetReceiver({OurBank}, TypeBankCode, {OurBank}, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI, 0);
              paym.SetPayer(prm_tick.rec.PartyID, TypeBankCode, BankID, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI, Overnight);
          end;

      elif (ftype == 2)
          Purpose = PM_PURP_PERCENT;
          paym.SetLegID(prm_legBase.rec.LegID);
          paym.SetPurpose(Purpose, 1);
          Ground = "Проценты по сделке №"+locdealdata.IdentityDeal.DealID+" от "+locdealdata.IdentityDeal.DealDate;
          paym.SetGround(Ground);

          if (IsCOMMITMENT (prm_tick.rec.DealGroup, Purpose))
              paym.SetPayer({OurBank}, TypeBankCode, {OurBank}, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI, 0);
              paym.SetReceiver(prm_tick.rec.PartyID, TypeBankCode, BankID, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI, Overnight);
          else
              paym.SetReceiver({OurBank}, TypeBankCode, {OurBank}, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI, 0);
              paym.SetPayer(prm_tick.rec.PartyID, TypeBankCode, BankID, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI, Overnight);
          end;

      elif (ftype == 3)
          Purpose = PM_PURP_PERCENT;
          paym.SetLegID(prm_legBase.rec.LegID);
          paym.SetPurpose(Purpose, 1);
          Ground = "Проценты по сделке №"+locdealdata.IdentityDeal.DealID+" от "+locdealdata.IdentityDeal.DealDate;
          paym.SetGround(Ground);

          if (IsCOMMITMENT (prm_tick.rec.DealGroup, Purpose))
              paym.SetReceiver({OurBank}, TypeBankCode, {OurBank}, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI, 0);
              paym.SetPayer(prm_tick.rec.PartyID, TypeBankCode, BankID, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI, Overnight);
          else
              paym.SetPayer({OurBank}, TypeBankCode, {OurBank}, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI, 0);
              paym.SetReceiver(prm_tick.rec.PartyID, TypeBankCode, BankID, TypeBankCode, prm_tick.rec.DealType, prm_legBase.rec.PFI, Overnight);
          end;

      end;

      paym.CreateNew();

  end;


  private macro CreateDeferOperation()
      ClearRecord(prm_deferOp);

      prm_deferOp.rec.id_operation   = 0; 
      prm_deferOp.rec.kind_operation = prm_tick.rec.DealType;
      prm_deferOp.rec.init_oper      = {oper};
      prm_deferOp.rec.dockind        = prm_tick.rec.bofficekind;
      //      prm_deferOp.rec.start_date    = prm_legBase.rec.Start;
      prm_deferOp.rec.deferdate      = prm_legBase.rec.Start;
      prm_deferOp.rec.syst_date      = date();
      prm_deferOp.rec.syst_time      = time();
      prm_deferOp.rec.boactions      = 1;

      if (prm_tick.rec.bofficekind == DL_IBCDOC)
          prm_deferOp.rec.documentid = UniID(prm_tick, OBJTYPE_MMARKDEAL);
      end;

      if (not prm_deferOp.insert)
         err_txt = "Ошибка при создании новой сделки.";  
         RunError(err_txt, c_err_obj(err_txt,-3000));
      end;
      /*
      if ( locdeal.rec.PPROLONG == "ДА")
         ClearRecord(prm_deferDoc);
         prm_deferDoc.rec.dockind = prm_tick.rec.bofficekind;;
         prm_deferDoc.rec.origin  = 0;
         prm_deferDoc.rec.status  = 0;
         //lkl не работает         prm_deferDoc.rec.id_step = 0;
         prm_deferDoc.rec.id_operation = GetIdOperation(prm_tick.rec.DealType, prm_legBase.rec.PFI);  //Для пролонгирующей ссылка на основную id_operation;
         prm_deferDoc.rec.documentid   = prm_deferOp.rec.documentid; // UniID(prm_tick, OBJTYPE_MMARKDEAL);
         if (not prm_deferDoc.insert)
            err_txt = "Ошибка при создании новой сделки.";  
            RunError(err_txt, c_err_obj(err_txt,-3000));
         end;

      end;
      */

  end;


  //Обеспечение
  private macro CreateQLT()
    var
        qlt = Tbfile("mmdqlt.dbt", "W");

      if (VALTYPE(locdealdata.DealData.IAMLDDeal.CollateralList) == V_UNDEF)
         return;
      end;

      ClearRecord(qlt);

      qlt.rec.DealID  = prm_tick.rec.DealID;
      qlt.rec.Date    = prm_tick.rec.DealDate;
      if (locdealdata.DealData.IAMLDDeal.CollateralList.size > 0)
         qlt.rec.Quality = RetPOB("ДА");
      else
         qlt.rec.Quality = RetPOB("НЕТ");
      end;

      if (not qlt.insert)
          err_txt = "Ошибка при создании новой сделки.";  
          RunError(err_txt, c_err_obj(err_txt,-3000));
      end;	  
  end;


  //Договор залога
  private macro CreateGrnt()
      private var que, rs0, count, i, alist = tarray(); 
      private var grnt = Tbfile("dl_grnt.dbt", "W");

      //Договор из примечания
      que = "select t_contractid, t_cost from ddl_order_dbt t where t_contractor = "+locdeal.rec.CONTR+" and t_ordernumber='"+locdealdata.DealData.IAMLDDeal.CollateralList.value(0).AgreeNumber+"'"; //25 
      rs0 = LnGetRecordset(que);
      if (rs0 != null)
         if (rs0.moveNext) 
            ClearRecord(grnt);
            grnt.rec.DealID      = prm_tick.rec.DealID;
            grnt.rec.ContractId  = Int(rs0.value(0));
            grnt.rec.Amount = grnt.rec.TCC = Money(rs0.value(1));
            if (not grnt.insert)
               err_txt = "Ошибка при создании новой сделки.";  
               RunError(err_txt, c_err_obj(err_txt,-3000));
            end;	  
         end;
      end;


      //цикл по списку договоров
      /*
      alist = Tarray(GetNumZalog(locdeal.rec.ZNCONTRACT, prm_tick.rec.partyid));

      i = 0;
      count = alist.Size;
      while (i < count)
          alist.value(i);
          if (alist.value(i) > 0) 
            ClearRecord(grnt);
            grnt.rec.DealID      = prm_tick.rec.DealID;
            grnt.rec.ContractId  = alist.value(i);
            grnt.rec.Amount      = 0.0;

            if (not grnt.insert)
               err_txt = "Ошибка при создании новой сделки.";  
               RunError(err_txt, c_err_obj(err_txt,-3000));
            end;	  
          end;
          i =i + 1;
      end;
      */
  end;

  //Процентный договор
  private macro CreatePcAcc(_type)
      var 
          prm       = TPrcContractPrm,
          Contract  = 0,
          Sum       = Money(0);

      prm.BackOffice     = 2;
      prm.ObjectType     = 103;
      prm.ObjectID       = prm_tick.rec.DealCode;//String(prm_tick.rec.DealID) + " 1";     
      prm.CalcNumber     = basi;
      prm.IsUserCalc     = "";    
      prm.RateNumber     = 100;
      prm.IsUserRate     = "X";
      prm.ContractType   = _type;  
      prm.ContractNumber = 0;
      prm.Client         = prm_tick.rec.PartyID; //lkl {OurBank};        
      prm.ClientQuality  = 1;
      prm.BeginDate      = prm_legBase.rec.Start;     
      prm.EndDate        = prm_legBase.rec.Maturity;       
      prm.Oper           = {Oper};


      if (Prc_CreateContractByObject(prm, Contract))
          err_txt = "Ошибка при создании новой сделки.";  
          RunError(err_txt, c_err_obj(err_txt,-3000));
      elif (_type == 7)
          Prc_SetRateVal (Contract, prm_legBase.rec.Start, (prm_legBase.rec.Price / pow(10, prm_legBase.rec.Point)), false); 
          Prc_CalcPeriodOnDate (Contract, 3, prm_legBase.rec.Maturity, 1, Sum); 
      end;
  end;

  private macro CreateMMDeal()
      private var que, rs, rsp, ftype, pfiid, cbank, caccount, obank, oaccount,;

      if ((locdeal.rec.ActionType == "UPDATE") or (strupr(locdeal.rec.ActionType) == "DELETE"))
         que =  "DECLARE "
              + "   dealid NUMBER(10); "
              + "   objectid varchar2(30); "
              + "BEGIN "
              + "   dealid := ?; "
              + "   objectid := ?; "
              + "   delete from dnotetext_dbt where t_objecttype=103 and t_notekind=121 and to_number(t_documentid) = dealid; "
              + "   delete from ddl_leg_dbt where t_dealid = dealid; "
              + "   delete from ddl_tick_dbt where t_dealid = dealid; "
              + "   delete from ddl_grnt_dbt where t_dealid = dealid; "
              + "   delete from dmmdqlt_dbt where t_dealid = dealid; "
              + "   delete from dprccontract_dbt where t_objectid = objectid; "
              + "END; ";
         rs = RSDCommand(que);
         rs.addParam( "", RSDBP_IN, locdeal.rec.DEAL_ID );
//         rs.addParam( "", RSDBP_IN, locdealdata.IdentityDeal.ExternalID );
         rs.addParam( "", RSDBP_IN, locdealdata.IdentityDeal.DealID );    // gtv: процентные договора привязываются по DealCode - см. стр. 1565

         rs.execute();
      end;

      if (strupr(locdeal.rec.ActionType) == "DELETE")
         return true;
      end;

      CreateMBKDeal(DL_IBCDOC);

      CreateQLT();

      CreatePcAcc(7);
      CreatePcAcc(9);
      CreatePcAcc(10);

      //платежи
      pfiid = prm_legBase.rec.PFI;
      if (locdealdata.IdentityDeal.DealKind == "IAM")
         if (ValType(locdealdata.DealData.IAMLDDeal.Payments) == V_UNDEF)
            err_txt = "Нет блока Payments.";  
            RunError(err_txt, c_err_obj(err_txt,-3000));
         end;
         CreatePaym( 0, prm_legBase.rec.Start, prm_legBase.rec.Start, prm_legBase.rec.Principal, pfiid );
         CreatePaym( 1, prm_legBase.rec.Maturity, prm_legBase.rec.Maturity, prm_legBase.rec.Principal, pfiid );
         CreatePaym( 2, prm_legBase.rec.Maturity, prm_legBase.rec.Maturity, prm_legBase.rec.Cost, pfiid );
      else //LD CSA
         if (ValType(locdealdata.DealData.IAMLDDeal.CashFlow) == V_UNDEF)
            err_txt = "Нет блока CashFlow.";  
            RunError(err_txt, c_err_obj(err_txt,-3000));
         end;
         //CreatePaym( 0, prm_legBase.rec.Start, prm_legBase.rec.Start, prm_legBase.rec.Principal, pfiid );
         //CreatePaym( 1, prm_legBase.rec.Maturity, prm_legBase.rec.Maturity, prm_legBase.rec.Principal, pfiid );
         cnt = 0;
         while (locdealdata.DealData.IAMLDDeal.CashFlow.Size > cnt)
            if (locdealdata.DealData.IAMLDDeal.CashFlow[cnt].Type == "I")
               CreatePaym( 2, locdealdata.DealData.IAMLDDeal.CashFlow[cnt].DatePay, locdealdata.DealData.IAMLDDeal.CashFlow[cnt].DatePay, abs(locdealdata.DealData.IAMLDDeal.CashFlow[cnt].Amount), pfiid );
            end;
            if (locdealdata.DealData.IAMLDDeal.CashFlow[cnt].Type == "N")
               if (locdealdata.DealData.IAMLDDeal.CashFlow[cnt].Amount > 0)
                  CreatePaym( 0, locdealdata.DealData.IAMLDDeal.CashFlow[cnt].DatePay, locdealdata.DealData.IAMLDDeal.CashFlow[cnt].DatePay, abs(locdealdata.DealData.IAMLDDeal.CashFlow[cnt].Amount), pfiid );
               else
                  CreatePaym( 1, locdealdata.DealData.IAMLDDeal.CashFlow[cnt].DatePay, locdealdata.DealData.IAMLDDeal.CashFlow[cnt].DatePay, abs(locdealdata.DealData.IAMLDDeal.CashFlow[cnt].Amount), pfiid );
               end;
            end;
            cnt = cnt + 1;
         end;
      end;

      //CreateDeferOperation();
      /*
      if (locdeal.rec.ZCONTRACT>0)
         CreateGrnt(locdeal.rec.ZCONTRACT);
      end;
      */

      if (VALTYPE(locdealdata.IdentityDeal.ConversationText) != V_UNDEF)
        addNoteForObject( 103, string(prm_tick.rec.DealID:o:34), 300, locdealdata.IdentityDeal.ConversationText, {curdate});
      end;
      if (VALTYPE(locdealdata.IdentityDeal.TSBrief) != V_UNDEF)
         addNoteForObject( 103, string(prm_tick.rec.DealID:o:34), 301, locdealdata.IdentityDeal.TSBrief, {curdate});
      end;
      if (locdeal.rec.TRADERNAME != "")
        addNoteForObject( 103, string(prm_tick.rec.DealID:o:34), 150, locdeal.rec.TRADERNAME, {curdate});
      end;
      // gtv: посредник для формы 701
      if (VALTYPE(locdeal.rec.BROKER_CODE) != V_UNDEF)
//        addNoteForObject( 103, string(prm_tick.rec.DealID:o:34), 15, locdeal.rec.BROKER_CODE, {curdate});
      end;

      ObjID  = string(prm_tick.rec.DealID:o:34);
      ObjCat = RsbObjCategories( 103, ObjID);
      ObjCat.ConnectAttr(102, 1, NULL, NULL, {curdate} );
      ObjCat.Save(ObjID);

      return true;
  end;

  private macro CreateDealTrn()
    var
        retVal = true;

          retVal = CreateMMDeal();

      return retVal;

    OnError( RslErrObj )
      prm_Comment = RslErrObj.Message;

      AbortTrn();
      return false;
  end;

  macro CreateDeal()
    macro Local_CreateDealTrn()
        return CreateDealTrn();
    end;

      if (not ProcessTrn(0, "Local_CreateDealTrn"))
          return 1;
      end;

      prm_ObjID = prm_tick.rec.DealID;

      return 0;
  end;

  macro Get_ObjID()
      return prm_ObjID;
  end;

  macro Get_Comment()
      return prm_Comment;
  end;

  private macro ClassConstructor( obdeal)
      prm_SeanceID = 0; // _SeanceID;
      prm_RecordID = 0;// _RecordID;

      prm_ObjID   = -1;
      prm_Comment = "";

      if ((ValType(obdeal.IdentityDeal.SofrGenID) != V_UNDEF) and (obdeal.IdentityDeal.SofrGenID > 0))
        prm_ObjID = obdeal.IdentityDeal.SofrGenID;
      end;

      //msgbox(obdeal.rec.dealid);
      //copy(locdeal, obdeal);
      //msgbox(locdeal.rec.dealid);

      prm_tick    = Tbfile("dl_tick.dbt", "W");
      prm_legBase = Tbfile("dl_leg.dbt", "W");
      prm_legRev  = Tbfile("dl_leg.dbt", "W");

      prm_deferOp  = Tbfile("oproper.dbt", "W");
      prm_deferDoc = Tbfile("oprdocs.dbt", "W");

  end;

  ClassConstructor( obdeal);
end;

///////////////////////////////////////////////////////////////////////////////////
// BondDeal
///////////////////////////////////////////////////////////////////////////////////
private class Ob_BondDeal( obdeal )
   private var
      prm_ObjID,
      prm_Comment;

   var ppaym;
   var type:integer;
   var stat:integer;
   var cmd, qwery;

   var tick           = TRecHandler( "dl_tick.dbt"  );
   var ClntRep        = TRecHandler( "spground.dbt" );
   var outlay         = TRecHandler( "dlsum.dbt"    );

   var spgrdoc        = TRecHandler( "spgrdoc.dbt"  );
   var dl_leg1        = TRecHandler( "dl_leg.dbt"   );
   var dl_leg2        = TRecHandler( "dl_leg.dbt"   );
   var spgr1          = TRecHandler( "spground.dbt" );
   var spgr2          = TRecHandler( "spground.dbt" );

   var rq_avance1   = TRecHandler( "dlrq.dbt" );
   var rq_avance2   = TRecHandler( "dlrq.dbt" );
   var rq_acc_clnt  = TRecHandler( "dlrqacc.dbt" );
   var rq_acc_contr = TRecHandler( "dlrqacc.dbt" );
   var rq_acc_clnt_depo  = TRecHandler( "dlrqacc.dbt" );
   var rq_acc_contr_depo = TRecHandler( "dlrqacc.dbt" );

   var dlcomis_market = TRecHandler( "dlcomis.dbt"  );
   var dlmarket       = TRecHandler( "dlmarket.dbt");  

   VAR ArrComSums = TArray();/*список комиссиий (бирже)*/
   var ArrNotes   = TArray();/*список примечаний*/

   var spground = TBFile( "spground", "R", 4 );
   var ErrMes;
   
   record Party(party);
   record sfcontr(sfcontr);
   record fininstr(fininstr);
   record finin_pfi(fininstr);
   record finin_delivering(fininstr);
   private record  deal(dl_tick);

   var StrTempParm:string = "";
   var MainDealDate;
   var DealSumNoNKD, DealSumNoNKD_Back, NKD_PayFIID, NKDBack_PayFIID, NumSection = 0;
   var PayFIID:integer = 0;
   var NKDComment = "", NKDFromFile1 = $0, NKDFromFile2 = $0, NKDCalc1 = $0, NKDCalc2 = $0, NKD_Date1 = Date(0,0,0), NKD_Date2 = Date(0,0,0);
   var objnote_c;

   record issues(avoiriss);


   //заполнить счета в ТО
   PRIVATE MACRO SetAccountsRQ( tick:TRecHandler, ppaym:SP_ParmPaym )

      MACRO SetProp( rq:TRecHandler, BankID:INTEGER, Account:STRING, CorBank:INTEGER, CorAccount:STRING )
         VAR err = 0;
              
         if( BankID > 0 )
            rq.rec.BankID       = BankID;
            rq.rec.Account      = Account;
            if( CorBank ) 
               rq.rec.BankCorrID   = CorBank;
               rq.rec.CorrAcc      = CorAccount;
               rq.rec.BankCorrCode = ПолучитьКодСубъекта( CorBank, PTCK_BIC, err );
               if( (rq.rec.BankCorrCode != "") AND (err == 0) )
                  rq.rec.BankCorrCodeKind = PTCK_BIC;
               end;
            end;
         end;
      END;

      /*для клиента*/
      SetProp( rq_acc_clnt, ppaym.ClBank, ppaym.ClAccount, ppaym.ClCorBank, ppaym.ClCorAccount );
      /*для контрагента*/
      SetProp( rq_acc_contr, ppaym.CntrBank, ppaym.CntrAccount, ppaym.CntrCorBank, ppaym.CntrCorAccount );

      /*для клиента*/
      SetProp( rq_acc_clnt_depo, ppaym.Custody, ppaym.DepoAccount, 0, null );
      /*для контрагента*/
      SetProp( rq_acc_contr_depo, ppaym.CntrCustody, ppaym.CntrDepoAccount, 0, null );
   END;

   private macro CreateBondDeal(_BofficeKind)

      var Nominal=0;
      var err_rud;

      tick.rec.DealID      = 0;
      tick.rec.BofficeKind = _BofficeKind;

      //Статические параметры   
      tick.rec.TradeSystem = 0; // PTCK_REUTER;  //LKL???
      tick.rec.DealStatus  = DL_PREPARING;
      tick.rec.RegDate     = {curdate};
      tick.rec.Oper        = {oper};   
      tick.rec.ClientID    = ALLFININSTR;
      tick.rec.DepositID   = ALLFININSTR;
      tick.rec.MarketID    = ALLFININSTR;
      tick.rec.IndocID     = 0;
      tick.rec.NumberPack  = 0;
      tick.rec.Department  = 1; //locdeal.rec.FILIAL;
      tick.rec.OriginID    = 0; // GT_REUTERS;  //LKL???
      tick.rec.Netting     = 1;
      tick.rec.LinkChannel = GetLinkChannel(locdealdata); //gtv: по умолчанию 0 "Прочие"
      tick.rec.conftpid    = 2; //SWIFT код подтверждения
      tick.rec.FixSum      = 1;
      tick.rec.datatype    = 1; 

      //генерим номер сделки - не генерим
      tick.rec.DealCode = locdealdata.IdentityDeal.DealID;
      //Номер сделки в торговой системе
      if (VALTYPE(locdealdata.IdentityDeal.ExternalID) != V_UNDEF)
         tick.rec.DealCodeTS = locdealdata.IdentityDeal.ExternalID; 
      else
         tick.rec.DealCodeTS = ""; 
      end;
      //Дата заключения сделки   
      tick.rec.DealDate =  locdealdata.IdentityDeal.DealDate; 
      //Время заключения сделки   
      tick.rec.DealTime = Time(0,0,0);
      if (ValType(locdealdata.IdentityDeal.DealTime) != V_UNDEF)
         tick.rec.DealTime = Time(locdealdata.IdentityDeal.DealTime);
      end;
      //Дилер   
      tick.rec.TraderID = locdeal.rec.TRADER;
      //Идентификатор контрагента   
      tick.rec.PartyID = locdeal.rec.CONTR;
      //Брокер   
      tick.rec.BrokerID = locdeal.rec.BROKER;
      //Комментарий
      tick.rec.Comment = "";
      if (VALTYPE(locdealdata.IdentityDeal.TSBrief) != V_UNDEF)
         tick.rec.Comment = "Торг.площадка:"+locdealdata.IdentityDeal.TSBrief+", ";
      end;
      tick.rec.Comment = tick.rec.Comment + "Комментарий:"+locdealdata.IdentityDeal.Comment;
      //тип сделки
      if (locdealdata.IdentityDeal.BuySell == "Buy")
         tick.rec.DealType = 12183;
         dl_leg1.rec.SupplyTime = dttm(date(0,0,0),time(7,0,0));
      elif (locdealdata.IdentityDeal.BuySell == "Sell")
         tick.rec.DealType = 12193;
         dl_leg1.rec.SupplyTime = dttm(date(0,0,0),time(21,0,0));
      end;
      //Группа сделки
      tick.rec.DealGroup = 0;
      tick.rec.Country = "RUS";
// 2020-03-02 Cherednichenko для ЦБ используем календарь бухучета - 10003
// 2020-08-03 Kadin Срок определяем функцией DL_GetNumWorkDaysForPeriod, перелав ей календарь Бухучета
/*
      if (Workdays(locdealdata.IdentityDeal.DealDate,locdealdata.DealData.BondDeal.ValueDate, 10003)-1 > 2)
         tick.rec.IsPFI = "X";
      end;
*/

      // 15.01.2021 MAA: iS - 521755
      If(DL_GetNumWorkDaysForPeriod( locdealdata.IdentityDeal.DealDate, locdealdata.DealData.BondDeal.ValueDate, -1, GetFiidCodeByName(locdealdata.DealData.BondDeal.CurrencyDeals), tick.rec.PartyID, NULL, 10003 ) > 2) 
         tick.rec.IsPFI = "X";
      end;

/*KD*/

      dl_leg1.rec.DepositID    = Codeparty(locdealdata.DealData.BondDeal.Depositary,103);
      dl_leg1.rec.Registrar    = ALLFININSTR;
      dl_leg1.rec.Pitch        = 0;
      dl_leg1.rec.Mode         = 0;
      dl_leg1.rec.PeriodNumber = 0;
      dl_leg1.rec.PeriodType   = 0;
      dl_leg1.rec.Diff         = 0;
      dl_leg1.rec.PayDay       = 0;
      dl_leg1.rec.TablePercent = "";
      dl_leg1.rec.Caption      = 0;
      dl_leg1.rec.TypeDate     = 0;
      dl_leg1.rec.CountDay     = 0;
      dl_leg1.rec.Correct      = 0;
      dl_leg1.rec.LegID        = 0;
      dl_leg1.rec.Scale        = 1;
      dl_leg1.rec.LegNumber    = "";	  
      dl_leg1.rec.DealID = tick.rec.DealID;
      dl_leg1.rec.CFI = GetFiidCodeByName(locdealdata.DealData.BondDeal.CurrencyDeals);
      dl_leg1.rec.PFI = GetFinIndex(locdealdata.DealData.BondDeal.Securities.ISIN);
      if (dl_leg1.rec.PFI == -1)
         if( SOFR_LoadRuDataByID( StrUpr(locdealdata.DealData.BondDeal.Securities.ISIN), 1, @err_rud ) )
            dl_leg1.rec.PFI = GetFinIndex(locdealdata.DealData.BondDeal.Securities.ISIN);
         else
            err_txt = "Ценная бумага с кодом " + locdealdata.DealData.BondDeal.Securities.ISIN + " не загружена."+err_rud;  
            RunError(err_txt, c_err_obj(err_txt,-3000));
         end;
      end;

      SP_GetNominal(dl_leg1.rec.PFI, locdealdata.DealData.BondDeal.PayDate, Nominal);

      /*maa280219*/ dl_leg1.rec.COST = locdealdata.DealData.BondDeal.PricePrc * Nominal * locdealdata.DealData.BondDeal.Number / 100;
      /* dl_leg1.rec.Cost = locdealdata.DealData.BondDeal.PriceNominal;*/

      dl_leg1.rec.DeliveringFIID = dl_leg1.rec.PFI;
      dl_leg1.rec.PayFIID = dl_leg1.rec.NKDFIID = dl_leg1.rec.CFI;
      dl_leg1.rec.Principal = locdealdata.DealData.BondDeal.Number;
      dl_leg1.rec.Price = locdealdata.DealData.BondDeal.PricePrc;
      dl_leg1.rec.TotalCost = locdealdata.DealData.BondDeal.Amount;
      //dl_leg1.rec.NKD = abs(dl_leg1.rec.TotalCost - dl_leg1.rec.Cost);
        /*maa280219*/
	//if (Valtype(locdealdata.DealData.BondDeal.CouponAmount) != V_UNDEF)
	//    dl_leg1.rec.NKD = abs(locdealdata.DealData.BondDeal.CouponAmount);
        //else
        //       /*maa280219*/ dl_leg1.rec.NKD = abs(locdealdata.DealData.BondDeal.CouponPrc * Nominal * locdealdata.DealData.BondDeal.Number / 100 );
        //end;
      dl_leg1.rec.NKD = НКД(dl_leg1.rec.PFI, locdealdata.DealData.BondDeal.Number, locdealdata.DealData.BondDeal.DelivDate);

      dl_leg1.rec.Point = GetPoints(locdealdata.DealData.BondDeal.PricePrc);
      dl_leg1.rec.Start = date(0,0,0); 
      dl_leg1.rec.Maturity = locdealdata.DealData.BondDeal.PayDate; 
      dl_leg1.rec.Expiry = locdealdata.DealData.BondDeal.DelivDate; 
      dl_leg1.rec.Duration = 0;
      dl_leg1.rec.Basis = 0; 
      dl_leg1.rec.Formula = 50;
      dl_leg1.rec.RelativePrice = "X";


      //Генеральное соглашение
      tick.rec.GenagrID = -1;
      var GenAgr;
      
      // gtv: поиск ГС вынесон в отдельную функцию
      GenAgr = FindGenAgreementByParty(locdealdata.IdentityDeal.GenAgreement, 1, locdeal.rec.CONTR, "BOND", tick.rec.DealType, null, null, dl_leg1); 
      tick.rec.GenagrID = GenAgr.AgrID;           // по умолчанию -1
      tick.rec.conftpid = GenAgr.Confirmmethod;   // по умолчанию SWIFT

      var attr61 = GetAttr61(dl_leg1.rec.PFI);
      if (attr61 > 0)
         if (attr61 == 1) //АС_ЦБ
            tick.rec.PortfolioID = 5;
         elif (attr61 == 2) //ССПУ_ЦБ
            tick.rec.PortfolioID = 1;
         elif (attr61 == 3) //СССД_ЦБ
            tick.rec.PortfolioID = 2;
         end;
      else
         var getreg = GetRegistryValue ("SECUR\\МСФО\\ПОРТФЕЛЬ ПО УМОЛЧАНИЮ", V_INTEGER, tick.rec.PortfolioID);
         if (ValType(getreg) == V_UNDEF)
            tick.rec.PortfolioID = 2;
         else
            if (tick.rec.PortfolioID == 0)
               tick.rec.PortfolioID = 1;
            else
               tick.rec.PortfolioID = 2;
            end;
         end;
      end;
 

   end;

   private macro CreateMMDeal()
      private var que, rs, rsp, ftype, pfiid, cbank, caccount, obank, oaccount,;
      VAR PriceParm, NumLotsParm, BaseFIID, FaceValue = $0, Error = 0, rate = 0.0, PtKindName = "";
      NKDFromFile1 = NKDFromFile2 = NKDCalc1 = NKDCalc2 = $0;

   var isUpdate = false; // обновление биржевой сделки

      if (strupr(locdeal.rec.ActionType) == "DELETE")
         que =  "DECLARE "
              + "   dealid NUMBER(10); "
              + "   objectid varchar2(30); "
              + "BEGIN "
              + "   dealid := ?; "
              + "   objectid := ?; "
              + "   delete from dnotetext_dbt where t_objecttype=103 and t_notekind=121 and to_number(t_documentid) = dealid; "
              + "   delete from ddl_leg_dbt where t_dealid = dealid; "
              + "   delete from ddl_tick_dbt where t_dealid = dealid; "
              + "   delete from ddl_grnt_dbt where t_dealid = dealid; "
              + "   delete from dmmdqlt_dbt where t_dealid = dealid; "
              + "   delete from dprccontract_dbt where t_objectid = objectid; "
              + "END; ";
         rs = RSDCommand(que);
         rs.addParam( "", RSDBP_IN, locdeal.rec.DEAL_ID );
         rs.addParam( "", RSDBP_IN, locdealdata.IdentityDeal.ExternalID );
         rs.execute();
         return true;
      end;
   
      ppaym = SP_ParmPaym();

      if (locdealdata.IdentityDeal.BuySell == "Buy")
         tick.rec.DealType = 12183;
      elif (locdealdata.IdentityDeal.BuySell == "Sell")
         tick.rec.DealType = 12193;
      end;

      InitSPDeal(tick, DL_SECURITYDOC, tick.rec.DealType, true);   
      CreateBondDeal(DL_SECURITYDOC);

      ArrComSums.Size = 0;
      var ArrComSums_i = 0, ComSum = $0, ComType = 0, ComCur = -1;
      if ( ValType(locdealdata.ComissArray) != V_UNDEF )
         ArrComSums.Size = 0;
         var CommDate:date = tick.rec.DealDate;
         if( tick.rec.DealTime > Time(19,0,0) )
            CommDate = GetDateAfterWorkDays(CommDate, 1, 10003); // 2020-03-02 Cherednichenko для ЦБ используем календарь бухучета - 10003
         end;
         var GateCommDate = null;
         
         var dlcomis_market = TRecHandler( "dlcomis.dbt"  );
    
         var i = 0;
         while(locdealdata.ComissArray.size > i)
             ComSum = locdealdata.ComissArray[i].Amount;
             type = locdealdata.ComissArray[i].Type;
             if( ComSum > $0.0 )
                dlcomis_market.Clear();
                if( not RG_InitDlComis("МскБиржПИ", dlcomis_market, @ErrMes, null, ComSum) )
                   err_txt = ErrMes;  
                   RunError(err_txt, c_err_obj(err_txt,-3000));
                else
                   dlcomis_market.rec.Date = dlcomis_market.rec.PlanPayDate = CommDate;
                      
                   ArrComSums_i = ArrComSums.Size;
                   ArrComSums(ArrComSums_i) = TRecHandler("dlcomis");
                   copy(ArrComSums(ArrComSums_i), dlcomis_market);
                end;
             end;
             i = i + 1;
         end;
      end;

      SetAccountsRQ( tick, ppaym );

      var ReturnIncome:money = $0;
      var CmdKind = "Insert";

      /*если находим сделку в отложенных, то пытаемся обновить ее*/
      VAR cmd_tick = RSDCommand( "SELECT tick.t_DealID, tick.t_DealStatus, leg1.t_ID LegID1, leg1.t_Cost Cost1, leg1.t_Principal Principal1 "+
                                 "  FROM ddl_tick_dbt tick, ddl_leg_dbt leg1 " +
                                 " WHERE     tick.t_DealCode    = ? " +
                                 "       AND leg1.t_DealID      = tick.t_DealID " +
                                 "       AND leg1.t_LegID       = 0 "
                               );  
      
      cmd_tick.addParam( "", RSDBP_IN, tick.rec.DealCode );
    
      cmd_tick.NullConversion = true;
      cmd_tick.execute();

      var DataSet_tick = TRsbDataSet( cmd_tick );
      if( DataSet_tick.MoveNext() )
         if( DataSet_tick.DealStatus == DL_PREPARING )
            tick.rec.DealID = DataSet_tick.DealID;/*для того, чтобы существующая сделка была обновлена в ф-и SP_DealGateCreateNew*/
            dl_leg1.rec.DealID    = DataSet_tick.DealID;
            dl_leg1.rec.ID        = DataSet_tick.LegID1;
            dl_leg1.rec.LEGKIND   = LEG_KIND_DL_TICK;
            dl_leg1.rec.Cost      = DataSet_tick.Cost1;
            dl_leg1.rec.Principal = DataSet_tick.Principal1;

            CmdKind = "Update";
         else
            err_txt = "Ошибка при обновлении сделки в БОЦБ.\nВ БОЦБ уже существует сделка с внешним кодом \""+tick.rec.DealCode+"\".\nДля обновления она должна быть отложена.";  
            RunError(err_txt, c_err_obj(err_txt,-3000));
         end;
      end;

      var targetDealID: Integer = 0;
      if ((tick.rec.DealID == 0) and (prm_ObjID > 0))
        targetDealID = prm_ObjID;
      end;

      stat = SP_DealGateCreateNew( tick, dl_leg1, dl_leg2, spgr1, spgr2, rq_avance1, rq_avance2, rq_acc_clnt, rq_acc_contr, 
                                   rq_acc_clnt_depo, rq_acc_contr_depo, ClntRep, outlay, ArrComSums, spgrdoc, targetDealID );

      if(stat != 0)
         err_txt = "Ошибка "+stat+" при "+iif((CmdKind == "Update"),"обновлении","вставке")+" сделки в БОЦБ.\n" 
           + CB_ErrMsg(GetErrMsg(), tick.rec.clientid, dl_leg1.rec.cfi) // DEF-66627 заменяем неинформативное сообщение
         ;  
         RunError(err_txt, c_err_obj(err_txt,-3000));
      end;

      if (VALTYPE(locdealdata.IdentityDeal.ConversationText) != V_UNDEF)
         addNoteForObject( 101, string(tick.rec.DealID:o:34), 300, locdealdata.IdentityDeal.ConversationText, {curdate});
      end;
      if (locdeal.rec.TRADERNAME != "")
         addNoteForObject( 101, string(tick.rec.DealID:o:34), 150, locdeal.rec.TRADERNAME, {curdate});
      end;
      if (tick.rec.Comment != "")
         addNoteForObject( 101, string(tick.rec.DealID:o:34), 151, tick.rec.Comment, {curdate});
      end;
      if (Valtype(locdealdata.DealData.BondDeal.CouponAmount) != V_UNDEF)
         addNoteForObject( 101, string(tick.rec.DealID:o:34), 152, Money(locdealdata.DealData.BondDeal.CouponAmount), {curdate});
      end;
      if (Valtype(locdealdata.DealData.BondDeal.Amount) != V_UNDEF)
         addNoteForObject( 101, string(tick.rec.DealID:o:34), 154, locdealdata.DealData.BondDeal.Amount, {curdate});
      end;

      ObjID  = string(tick.rec.DealID:o:34);
      ObjCat = RsbObjCategories( 101, ObjID);
      ObjCat.ConnectAttr(102, 1, NULL, NULL, {curdate} );
      ObjCat.Save(ObjID);

      return true;
  end;

  macro CreateDeal()
      if (not CreateMMDeal())
          return 1;
      end;

      prm_ObjID = tick.rec.DealID;

      return 0;
  end;

  macro Get_ObjID()
      return prm_ObjID;
  end;

  macro Get_Comment()
      return prm_Comment;
  end;

  private macro ClassConstructor( obdeal )
      prm_ObjID   = -1;
      prm_Comment = "";
      
      if ((ValType(obdeal.IdentityDeal.SofrGenID) != V_UNDEF) and (obdeal.IdentityDeal.SofrGenID > 0))
        prm_ObjID = obdeal.IdentityDeal.SofrGenID;
      end;
  end;

  ClassConstructor( obdeal );
end;


///////////////////////////////////////////////////////////////////////////////////
// REPODeal
///////////////////////////////////////////////////////////////////////////////////
private class Ob_REPODeal( obdeal )
   private var
      prm_ObjID,
      prm_Comment;

   var ppaym;
   var type:integer;
   var stat:integer;

   var tick           = TRecHandler( "dl_tick.dbt"  );
   var ClntRep        = TRecHandler( "spground.dbt" );
   var outlay         = TRecHandler( "dlsum.dbt"    );

   var spgrdoc        = TRecHandler( "spgrdoc.dbt"  );
   var dl_leg1        = TRecHandler( "dl_leg.dbt"   );
   var dl_leg2        = TRecHandler( "dl_leg.dbt"   );
   var spgr1          = TRecHandler( "spground.dbt" );
   var spgr2          = TRecHandler( "spground.dbt" );

   var rq_avance1   = TRecHandler( "dlrq.dbt" );
   var rq_avance2   = TRecHandler( "dlrq.dbt" );
   var rq_acc_clnt  = TRecHandler( "dlrqacc.dbt" );
   var rq_acc_contr = TRecHandler( "dlrqacc.dbt" );
   var rq_acc_clnt_depo  = TRecHandler( "dlrqacc.dbt" );
   var rq_acc_contr_depo = TRecHandler( "dlrqacc.dbt" );

   var dlcomis_market = TRecHandler( "dlcomis.dbt"  );
   var dlmarket       = TRecHandler( "dlmarket.dbt");  

   VAR ArrComSums = TArray();/*список комиссиий (бирже)*/
   var ArrNotes   = TArray();/*список примечаний*/

   var spground = TBFile( "spground", "R", 4 );
   var ErrMes;
   var NKD_kondor = TArray, TotalCost_Kondor = TArray;   
   
   PRIVATE MACRO GetAvanceParm( rq:TrecHandler, dl_leg:TrecHandler, pPurpose:INTEGER )
                 
      VAR Purpose, SubPurpose, tmp;

      rq.Clear();
      rq.rec.Type     = DLRQ_TYPE_AVANCE; 
      rq.rec.DealPart = IIF( pPurpose == PM_PURP_AVANCE, 1, 2 );
      
      rq.rec.Amount = locdealdata.DealData.REPODeal.Details.PrepaymentAmount;
      rq.rec.PlanDate = locdealdata.IdentityDeal.DealDate;
      dl_leg.rec.Start = rq.rec.PlanDate;

      return 0;
   END;   

   //заполнить счета в ТО
   PRIVATE MACRO SetAccountsRQ( tick:TRecHandler, ppaym:SP_ParmPaym )

      MACRO SetProp( rq:TRecHandler, BankID:INTEGER, Account:STRING, CorBank:INTEGER, CorAccount:STRING )
         VAR err = 0;
              
         if( BankID > 0 )
            rq.rec.BankID       = BankID;
            rq.rec.Account      = Account;
            if( CorBank ) 
               rq.rec.BankCorrID   = CorBank;
               rq.rec.CorrAcc      = CorAccount;
               rq.rec.BankCorrCode = ПолучитьКодСубъекта( CorBank, PTCK_BIC, err );
               if( (rq.rec.BankCorrCode != "") AND (err == 0) )
                  rq.rec.BankCorrCodeKind = PTCK_BIC;
               end;
            end;
         end;
      END;

      /*для клиента*/
      SetProp( rq_acc_clnt, ppaym.ClBank, ppaym.ClAccount, ppaym.ClCorBank, ppaym.ClCorAccount );
      /*для контрагента*/
      SetProp( rq_acc_contr, ppaym.CntrBank, ppaym.CntrAccount, ppaym.CntrCorBank, ppaym.CntrCorAccount );

      /*для клиента*/
      SetProp( rq_acc_clnt_depo, ppaym.Custody, ppaym.DepoAccount, 0, null );
      /*для контрагента*/
      SetProp( rq_acc_contr_depo, ppaym.CntrCustody, ppaym.CntrDepoAccount, 0, null );
   END;
   
   private macro SetREPOLeg(dl_leg_repo: TRecHandler, rq_avance_repo: TRecHandler,_leg)
      var Nominal=0;
   
      SP_GetNominal(dl_leg_repo.rec.PFI, _leg.ValueDate, Nominal);
      dl_leg_repo.rec.COST = _leg.Rate * Nominal * locdealdata.DealData.REPODeal.Quantity / 100;

      dl_leg_repo.rec.DeliveringFIID = dl_leg_repo.rec.PFI;
      dl_leg_repo.rec.PayFIID = dl_leg_repo.rec.NKDFIID = dl_leg_repo.rec.CFI;
      dl_leg_repo.rec.Principal = locdealdata.DealData.REPODeal.Quantity; 
      dl_leg_repo.rec.Price = _leg.Rate;
      dl_leg_repo.rec.TotalCost = _leg.AmountDeal;
      TotalCost_Kondor[_leg.LegsNumber] = _leg.AmountDeal;
      if (Valtype(_leg.AmountAccrued) != V_UNDEF)
         //dl_leg_repo.rec.NKD = abs(_leg.AmountAccrued);
         NKD_kondor[_leg.LegsNumber] = abs(_leg.AmountAccrued);
      //else
      //   if (Valtype(_leg.Accrued) != V_UNDEF)
      //      dl_leg_repo.rec.NKD = abs(_leg.Accrued * Nominal * locdealdata.DealData.REPODeal.Quantity / 100 );
      //   end;
      end;
      dl_leg_repo.rec.NKD = НКД(dl_leg_repo.rec.PFI, dl_leg_repo.rec.Principal, _leg.SettlementDate);

      dl_leg_repo.rec.Point = GetPoints(_leg.Rate);
      dl_leg_repo.rec.Start = date(0,0,0); 
      dl_leg_repo.rec.Maturity = _leg.ValueDate; 
      dl_leg_repo.rec.Expiry = _leg.SettlementDate; 
      dl_leg_repo.rec.Duration = 0;
      dl_leg_repo.rec.Basis = RetBasisREPO(locdealdata.DealData.REPODeal.Basis);
      dl_leg_repo.rec.Formula = 50;
      dl_leg_repo.rec.RelativePrice = "X";

      if ( (ValType(_leg.AmountDeal) != V_UNDEF) and (ValType(_leg.AmountPay) != V_UNDEF) )
        if (_leg.AmountDeal != _leg.AmountPay)   //был аванс
           rq_avance_repo.Clear();
           rq_avance_repo.rec.Type     = DLRQ_TYPE_AVANCE; 
           rq_avance_repo.rec.DealPart = _leg.LegsNumber;
           
           rq_avance_repo.rec.Amount = _leg.AmountDeal - _leg.AmountPay;
           rq_avance_repo.rec.PlanDate =  _leg.ValueDate;
           dl_leg_repo.rec.Start = rq_avance_repo.rec.PlanDate;
         end;
      end;   
   end;
   

   private macro CreateREPODeal(_BofficeKind)
      var LegsDeal;
      var err_rud;

      tick.rec.DealID      = 0;
      tick.rec.BofficeKind = _BofficeKind;

      //Статические параметры   
      tick.rec.TradeSystem = 0; // PTCK_REUTER;  //LKL???
      tick.rec.DealStatus  = DL_PREPARING;
      tick.rec.RegDate     = {curdate};
      tick.rec.Oper        = {oper};   
      tick.rec.ClientID    = ALLFININSTR;
      tick.rec.DepositID   = ALLFININSTR;
      tick.rec.MarketID    = ALLFININSTR;
      tick.rec.IndocID     = 0;
      tick.rec.NumberPack  = 0;
      tick.rec.Department  = 1; //locdeal.rec.FILIAL;
      tick.rec.OriginID    = 0; // GT_REUTERS;  //LKL???
      tick.rec.Netting     = 1;
      tick.rec.LinkChannel = GetLinkChannel(locdealdata); //gtv: по умолчанию 0 "Прочие"
      tick.rec.conftpid    = 2; //SWIFT код подтверждения
      tick.rec.FixSum      = 1;
      tick.rec.datatype    = 1; 

     
      tick.rec.DealCode = locdealdata.IdentityDeal.DealID;
      //Номер сделки в торговой системе
      if (VALTYPE(locdealdata.IdentityDeal.ExternalID) != V_UNDEF)
         tick.rec.DealCodeTS = locdealdata.IdentityDeal.ExternalID; 
      else
         tick.rec.DealCodeTS = ""; 
      end;
      //Дата заключения сделки   
      tick.rec.DealDate =  locdealdata.IdentityDeal.DealDate; 
      //Время заключения сделки   
      tick.rec.DealTime = Time(0,0,0);
      if (ValType(locdealdata.IdentityDeal.DealTime) != V_UNDEF)
         tick.rec.DealTime = Time(locdealdata.IdentityDeal.DealTime);
      end;
      //Дилер   
      tick.rec.TraderID = locdeal.rec.TRADER;
      //Идентификатор контрагента   
      tick.rec.PartyID = locdeal.rec.CONTR;
      //Брокер   
      tick.rec.BrokerID = locdeal.rec.BROKER;
      //Комментарий
      tick.rec.Comment = "";
      if (VALTYPE(locdealdata.IdentityDeal.TSBrief) != V_UNDEF)
         tick.rec.Comment = "Торг.площадка:"+locdealdata.IdentityDeal.TSBrief+", ";
      end;
      tick.rec.Comment = tick.rec.Comment + "Комментарий:"+locdealdata.IdentityDeal.Comment;
      
      //тип сделки
      if (VALTYPE(locdealdata.DealData.REPODeal.TypeDeal) != V_UNDEF)
         if (locdealdata.DealData.REPODeal.TypeDeal == 1)  // прямое РЕПО
            tick.rec.DealType = 12137;
         elif (locdealdata.DealData.REPODeal.TypeDeal == 2) // обратное РЕПО
            tick.rec.DealType = 12132;
         end;
      else
         tick.rec.DealType = 12137;
      end;
      
      //Группа сделки
      tick.rec.DealGroup = 0;
      tick.rec.Country = "RUS";

      //дисконт
      if (VALTYPE(locdealdata.DealData.REPODeal.HairCutPRC) != V_UNDEF)
         if (locdealdata.DealData.REPODeal.HairCutPRC > 100)
            tick.rec.Discont = locdealdata.DealData.REPODeal.HairCutPRC-100;
         else
            tick.rec.Discont =  locdealdata.DealData.REPODeal.HairCutPRC;
         end;        
      end;
         
      // депозитарий
      if ( (VALTYPE(locdealdata.DealData.REPODeal.Details) != V_UNDEF) 
            and (VALTYPE(locdealdata.DealData.REPODeal.Details.ClearingBank) != V_UNDEF) ) 
         dl_leg1.rec.DepositID = Codeparty(locdealdata.DealData.REPODeal.Details.ClearingBank,103);
         dl_leg2.rec.DepositID =  dl_leg1.rec.DepositID;
      end;
      
      dl_leg1.rec.Registrar    = dl_leg2.rec.Registrar    = ALLFININSTR;
      dl_leg1.rec.Pitch        = dl_leg2.rec.Pitch        = 0;
      dl_leg1.rec.Mode         = dl_leg2.rec.Mode         = 0;
      dl_leg1.rec.PeriodNumber = dl_leg2.rec.PeriodNumber = 0;
      dl_leg1.rec.PeriodType   = dl_leg2.rec.PeriodType   = 0;
      dl_leg1.rec.Diff         = dl_leg2.rec.Diff         = 0;
      dl_leg1.rec.PayDay       = dl_leg2.rec.PayDay       = 0;
      dl_leg1.rec.TablePercent = dl_leg2.rec.TablePercent = "";
      dl_leg1.rec.Caption      = dl_leg2.rec.Caption      = 0;
      dl_leg1.rec.TypeDate     = dl_leg2.rec.TypeDate     = 0;
      dl_leg1.rec.CountDay     = dl_leg2.rec.CountDay     = 0;
      dl_leg1.rec.Correct      = dl_leg2.rec.Correct      = 0;
      dl_leg1.rec.LegID        = dl_leg2.rec.LegID        = 0;
      dl_leg1.rec.Scale        = dl_leg2.rec.Scale        = 1;
      dl_leg1.rec.LegNumber    = dl_leg2.rec.LegNumber    = "";
      dl_leg1.rec.DealID       = dl_leg2.rec.DealID       = tick.rec.DealID;
      dl_leg1.rec.IncomeRate   = dl_leg2.rec.IncomeRate   = locdealdata.DealData.REPODeal.FixRate;
      
      dl_leg1.rec.CFI = GetFiidCodeByName(locdealdata.DealData.REPODeal.CurrencyDeals);
      dl_leg1.rec.PFI = GetFinIndex(locdealdata.DealData.REPODeal.Securities.ISIN);
      if (dl_leg1.rec.PFI == -1)
         if( SOFR_LoadRuDataByID( StrUpr(locdealdata.DealData.REPODeal.Securities.ISIN), 1, @err_rud ) )
            dl_leg1.rec.PFI = GetFinIndex(locdealdata.DealData.REPODeal.Securities.ISIN);
         else
            err_txt = "Ценная бумага с кодом " + locdealdata.DealData.REPODeal.Securities.ISIN + " не загружена."+err_rud;  
            RunError(err_txt, c_err_obj(err_txt,-3000));
         end;
      end;
      
      dl_leg2.rec.CFI = dl_leg1.rec.CFI;
      dl_leg2.rec.PFI = dl_leg1.rec.PFI;
      
      NKD_kondor.size = 0; 
      TotalCost_Kondor.size = 0;
      
      for (LegsDeal, locdealdata.DealData.REPODeal.LegsDealsList) // ног заведомо не не меньше 2
         if (LegsDeal.LegsNumber == 1)
            SetREPOLeg(dl_leg1, rq_avance1, LegsDeal);
         elif (LegsDeal.LegsNumber == 2)
            SetREPOLeg(dl_leg2, rq_avance2, LegsDeal);
         end;
      end;

      // выравнивание точности
      if (dl_leg1.rec.Point > dl_leg2.rec.Point)
         dl_leg2.rec.Point = dl_leg1.rec.Point;
      elif (dl_leg2.rec.Point > dl_leg1.rec.Point)
         dl_leg1.rec.Point = dl_leg2.rec.Point;
      end;
      
      //Генеральное соглашение
      tick.rec.GenagrID = -1;
      var GenAgr;
      
      // gtv: поиск ГС вынесен в отдельную функцию
      GenAgr = FindGenAgreementByParty(locdealdata.IdentityDeal.GenAgreement, 1, locdeal.rec.CONTR, "BOND", tick.rec.DealType, null, null, dl_leg1, dl_leg2); // для РЕПО для для бондов
      tick.rec.GenagrID = GenAgr.AgrID;           // по умолчанию -1
      tick.rec.conftpid = GenAgr.Confirmmethod;   // по умолчанию SWIFT


/*      if ( (VALTYPE(locdealdata.DealData.REPODeal.Details) != V_UNDEF) and (VALTYPE(locdealdata.DealData.REPODeal.Details.Prepayment) != V_UNDEF) )
         if (locdealdata.DealData.REPODeal.Details.Prepayment == "Y")
            GetAvanceParm( rq_avance1, dl_leg1, PM_PURP_AVANCE );
            GetAvanceParm( rq_avance2, dl_leg2, PM_PURP_BACK_AVANCE );
         end;
      end; */

      var attr61 = GetAttr61(dl_leg1.rec.PFI);
      if (attr61 > 0)
         if (attr61 == 1) //АС_ЦБ
            tick.rec.PortfolioID = 5;
         elif (attr61 == 2) //ССПУ_ЦБ
            tick.rec.PortfolioID = 1;
         elif (attr61 == 3) //СССД_ЦБ
            tick.rec.PortfolioID = 2;
         end;
      else
         var getreg = GetRegistryValue ("SECUR\\МСФО\\ПОРТФЕЛЬ ПО УМОЛЧАНИЮ", V_INTEGER, tick.rec.PortfolioID);
         if (ValType(getreg) == V_UNDEF)
            tick.rec.PortfolioID = 2;
         else
            if (tick.rec.PortfolioID == 0)
               tick.rec.PortfolioID = 1;
            else
               tick.rec.PortfolioID = 2;
            end;
         end;
      end;
 

   end;

   private macro CreateMMDeal()
      private var que, rs, rsp, ftype, pfiid, cbank, caccount, obank, oaccount,;
      VAR PriceParm, NumLotsParm, BaseFIID, FaceValue = $0, Error = 0, rate = 0.0, PtKindName = "";

      var isUpdate = false; // обновление биржевой сделки

      if (strupr(locdeal.rec.ActionType) == "DELETE")
         que =  "DECLARE "
              + "   dealid NUMBER(10); "
              + "   objectid varchar2(30); "
              + "BEGIN "
              + "   dealid := ?; "
              + "   objectid := ?; "
              + "   delete from dnotetext_dbt where t_objecttype=103 and t_notekind=121 and to_number(t_documentid) = dealid; "
              + "   delete from ddl_leg_dbt where t_dealid = dealid; "
              + "   delete from ddl_tick_dbt where t_dealid = dealid; "
              + "   delete from ddl_grnt_dbt where t_dealid = dealid; "
              + "   delete from dmmdqlt_dbt where t_dealid = dealid; "
              + "   delete from dprccontract_dbt where t_objectid = objectid; "
              + "END; ";
         rs = RSDCommand(que);
         rs.addParam( "", RSDBP_IN, locdeal.rec.DEAL_ID );
         rs.addParam( "", RSDBP_IN, locdealdata.IdentityDeal.ExternalID );
         rs.execute();
         return true;
      end;

      ppaym = SP_ParmPaym();

      if (locdealdata.DealData.REPODeal.TypeDeal == 1)   // прямое репо
         tick.rec.DealType = 12137;
      elif (locdealdata.DealData.REPODeal.TypeDeal == 2) // обратное репо
         tick.rec.DealType = 12132;
      end;

      InitSPDeal(tick, DL_SECURITYDOC, tick.rec.DealType, true);   
      CreateREPODeal(DL_SECURITYDOC);

      ArrComSums.Size = 0;
      var ArrComSums_i = 0, ComSum = $0, ComType = 0, ComCur = -1;
      if ( ValType(locdealdata.ComissArray) != V_UNDEF )
         ArrComSums.Size = 0;
         var CommDate:date = tick.rec.DealDate;
         if( tick.rec.DealTime > Time(19,0,0) )
// 2020-03-02 Cherednichenko для ЦБ используем календарь бухучета - 10003
            CommDate = GetDateAfterWorkDays(CommDate, 1, 10003);
         end;
         var GateCommDate = null;
         
         var dlcomis_market = TRecHandler( "dlcomis.dbt"  );
    
         var i = 0;
         while(locdealdata.ComissArray.size > i)
             ComSum = locdealdata.ComissArray[i].Amount;
             type = locdealdata.ComissArray[i].Type;
             if( ComSum > $0.0 )
                dlcomis_market.Clear();
                if( not RG_InitDlComis("МскБиржПИ", dlcomis_market, @ErrMes, null, ComSum) )
                   err_txt = ErrMes;  
                   RunError(err_txt, c_err_obj(err_txt,-3000));
                else
                   dlcomis_market.rec.Date = dlcomis_market.rec.PlanPayDate = CommDate;
                      
                   ArrComSums_i = ArrComSums.Size;
                   ArrComSums(ArrComSums_i) = TRecHandler("dlcomis");
                   copy(ArrComSums(ArrComSums_i), dlcomis_market);
                end;
             end;
             i = i + 1;
         end;
      end;

      SetAccountsRQ( tick, ppaym );

      var ReturnIncome:money = $0;
      var CmdKind = "Insert";

      /*если находим сделку в отложенных, то пытаемся обновить ее*/
      VAR cmd_tick = RSDCommand( "SELECT tick.t_DealID, tick.t_DealStatus, leg1.t_ID LegID1, leg1.t_Cost Cost1, leg1.t_Principal Principal1 "+
                                 "  FROM ddl_tick_dbt tick, ddl_leg_dbt leg1 " +
                                 " WHERE     tick.t_DealCode    = ? " +
                                 "       AND leg1.t_DealID      = tick.t_DealID " +
                                 "       AND leg1.t_LegID       = 0 "
                               );  
      
      cmd_tick.addParam( "", RSDBP_IN, tick.rec.DealCode );
    
      cmd_tick.NullConversion = true;
      cmd_tick.execute();

      var DataSet_tick = TRsbDataSet( cmd_tick );
      if( DataSet_tick.MoveNext() )
         if( DataSet_tick.DealStatus == DL_PREPARING )
            tick.rec.DealID = DataSet_tick.DealID;/*для того, чтобы существующая сделка была обновлена в ф-и SP_DealGateCreateNew*/
            dl_leg1.rec.DealID    = DataSet_tick.DealID;
            dl_leg1.rec.ID        = DataSet_tick.LegID1;
            dl_leg1.rec.LEGKIND   = LEG_KIND_DL_TICK;
            dl_leg1.rec.Cost      = DataSet_tick.Cost1;
            dl_leg1.rec.Principal = DataSet_tick.Principal1;

            CmdKind = "Update";
         else
            err_txt = "Ошибка при обновлении сделки в БОЦБ.\nВ БОЦБ уже существует сделка с внешним кодом \""+tick.rec.DealCode+"\".\nДля обновления она должна быть отложена.";  
            RunError(err_txt, c_err_obj(err_txt,-3000));
         end;
      end;

      var targetDealID: Integer = 0;
      if ((tick.rec.DealID == 0) and (prm_ObjID > 0))
        targetDealID = prm_ObjID;
      end;

      stat = SP_DealGateCreateNew( tick, dl_leg1, dl_leg2, spgr1, spgr2, rq_avance1, rq_avance2, rq_acc_clnt, rq_acc_contr, 
                                   rq_acc_clnt_depo, rq_acc_contr_depo, ClntRep, outlay, ArrComSums, spgrdoc, targetDealID );

      if(stat != 0)
         err_txt = "Ошибка "+stat+" при "+iif((CmdKind == "Update"),"обновлении","вставке")+" сделки в БОЦБ.\n" 
           + CB_ErrMsg(GetErrMsg(), tick.rec.clientid, dl_leg1.rec.cfi) // DEF-66627 заменяем неинформативное сообщение
         ;  
         RunError(err_txt, c_err_obj(err_txt,-3000));
      end;

      if (VALTYPE(locdealdata.IdentityDeal.ConversationText) != V_UNDEF)
         addNoteForObject( 101, string(tick.rec.DealID:o:34), 300, locdealdata.IdentityDeal.ConversationText, {curdate});
      end;
      if (locdeal.rec.TRADERNAME != "")
         addNoteForObject( 101, string(tick.rec.DealID:o:34), 150, locdeal.rec.TRADERNAME, {curdate});
      end;
      if (tick.rec.Comment != "")
         addNoteForObject( 101, string(tick.rec.DealID:o:34), 151, tick.rec.Comment, {curdate});
      end;

      if ( (NKD_kondor.size > 0) and (Valtype(NKD_kondor[1]) != V_UNDEF) )
         addNoteForObject( 101, string(tick.rec.DealID:o:34), 152, Money(NKD_kondor[1]), {curdate});
      end;
      if ( (NKD_kondor.size > 1) and (Valtype(NKD_kondor[2]) != V_UNDEF) )
         addNoteForObject( 101, string(tick.rec.DealID:o:34), 153, Money(NKD_kondor[2]), {curdate});
      end;
      if ( (TotalCost_Kondor.size > 0) and (Valtype(TotalCost_Kondor[1]) != V_UNDEF) ) 
         addNoteForObject( 101, string(tick.rec.DealID:o:34), 154, TotalCost_Kondor[1], {curdate});
      end;
      if ( (TotalCost_Kondor.size > 1) and (Valtype(TotalCost_Kondor[2]) != V_UNDEF) ) 
         addNoteForObject( 101, string(tick.rec.DealID:o:34), 155, TotalCost_Kondor[2], {curdate});
      end;

      ObjID  = string(tick.rec.DealID:o:34);
      ObjCat = RsbObjCategories( 101, ObjID);
      ObjCat.ConnectAttr(102, 1, NULL, NULL, {curdate} );
      ObjCat.Save(ObjID);

      return true;
  end;

  macro CreateDeal()
      if (not CreateMMDeal())
          return 1;
      end;

      prm_ObjID = tick.rec.DealID;

      return 0;
  end;

  macro Get_ObjID()
      return prm_ObjID;
  end;

  macro Get_Comment()
      return prm_Comment;
  end;

  private macro ClassConstructor( obdeal )
      prm_ObjID   = -1;
      prm_Comment = "";
      
      if ((ValType(obdeal.IdentityDeal.SofrGenID) != V_UNDEF) and (obdeal.IdentityDeal.SofrGenID > 0))
        prm_ObjID = obdeal.IdentityDeal.SofrGenID;
      end;
  end;

  ClassConstructor( obdeal );
end;


///////////////////////////////////////////////////////////////////////////////////
// EquityDeal
///////////////////////////////////////////////////////////////////////////////////
private class Ob_EquityDeal( obdeal )
   private var
      prm_ObjID,
      prm_Comment;

   var ppaym;
   var type:integer;
   var stat:integer;

   var tick           = TRecHandler( "dl_tick.dbt"  );
   var ClntRep        = TRecHandler( "spground.dbt" );
   var outlay         = TRecHandler( "dlsum.dbt"    );

   var spgrdoc        = TRecHandler( "spgrdoc.dbt"  );
   var dl_leg1        = TRecHandler( "dl_leg.dbt"   );
   var dl_leg2        = TRecHandler( "dl_leg.dbt"   );
   var spgr1          = TRecHandler( "spground.dbt" );
   var spgr2          = TRecHandler( "spground.dbt" );

   var rq_avance1   = TRecHandler( "dlrq.dbt" );
   var rq_avance2   = TRecHandler( "dlrq.dbt" );
   var rq_acc_clnt  = TRecHandler( "dlrqacc.dbt" );
   var rq_acc_contr = TRecHandler( "dlrqacc.dbt" );
   var rq_acc_clnt_depo  = TRecHandler( "dlrqacc.dbt" );
   var rq_acc_contr_depo = TRecHandler( "dlrqacc.dbt" );

   var dlcomis_market = TRecHandler( "dlcomis.dbt"  );
   var dlmarket       = TRecHandler( "dlmarket.dbt");  

   VAR ArrComSums = TArray();/*список комиссиий (бирже)*/
   var ArrNotes   = TArray();/*список примечаний*/

   var spground = TBFile( "spground", "R", 4 );
   var ErrMes;
   

   //заполнить счета в ТО
   PRIVATE MACRO SetAccountsRQ( tick:TRecHandler, ppaym:SP_ParmPaym )

      MACRO SetProp( rq:TRecHandler, BankID:INTEGER, Account:STRING, CorBank:INTEGER, CorAccount:STRING )
         VAR err = 0;
              
         if( BankID > 0 )
            rq.rec.BankID       = BankID;
            rq.rec.Account      = Account;
            if( CorBank ) 
               rq.rec.BankCorrID   = CorBank;
               rq.rec.CorrAcc      = CorAccount;
               rq.rec.BankCorrCode = ПолучитьКодСубъекта( CorBank, PTCK_BIC, err );
               if( (rq.rec.BankCorrCode != "") AND (err == 0) )
                  rq.rec.BankCorrCodeKind = PTCK_BIC;
               end;
            end;
         end;
      END;

      /*для клиента*/
      SetProp( rq_acc_clnt, ppaym.ClBank, ppaym.ClAccount, ppaym.ClCorBank, ppaym.ClCorAccount );
      /*для контрагента*/
      SetProp( rq_acc_contr, ppaym.CntrBank, ppaym.CntrAccount, ppaym.CntrCorBank, ppaym.CntrCorAccount );

      /*для клиента*/
      SetProp( rq_acc_clnt_depo, ppaym.Custody, ppaym.DepoAccount, 0, null );
      /*для контрагента*/
      SetProp( rq_acc_contr_depo, ppaym.CntrCustody, ppaym.CntrDepoAccount, 0, null );
   END;
   

   private macro CreateEquityDeal(_BofficeKind)
      var err_rud;

      tick.rec.DealID      = 0;
      tick.rec.BofficeKind = _BofficeKind;

      //Статические параметры   
      tick.rec.TradeSystem = 0; // PTCK_REUTER;  //LKL???
      tick.rec.DealStatus  = DL_PREPARING;
      tick.rec.RegDate     = {curdate};
      tick.rec.Oper        = {oper};   
      tick.rec.ClientID    = ALLFININSTR;
      tick.rec.DepositID   = ALLFININSTR;
      tick.rec.MarketID    = ALLFININSTR;
      tick.rec.IndocID     = 0;
      tick.rec.NumberPack  = 0;
      tick.rec.Department  = 1; //locdeal.rec.FILIAL;
      tick.rec.OriginID    = 0; // GT_REUTERS;  //LKL???
      tick.rec.Netting     = 1;
      tick.rec.LinkChannel = GetLinkChannel(locdealdata); //gtv: по умолчанию 0 "Прочие"
      tick.rec.conftpid    = 2; //SWIFT код подтверждения
      tick.rec.FixSum      = 1;
      tick.rec.datatype    = 1; 

    
      tick.rec.DealCode = locdealdata.IdentityDeal.DealID;
      //Номер сделки в торговой системе
      if (VALTYPE(locdealdata.IdentityDeal.ExternalID) != V_UNDEF)
         tick.rec.DealCodeTS = locdealdata.IdentityDeal.ExternalID; 
      else
         tick.rec.DealCodeTS = ""; 
      end;
      //Дата заключения сделки   
      tick.rec.DealDate =  locdealdata.IdentityDeal.DealDate; 
      //Время заключения сделки   
      tick.rec.DealTime = Time(0,0,0);
      if (ValType(locdealdata.IdentityDeal.DealTime) != V_UNDEF)
         tick.rec.DealTime = Time(locdealdata.IdentityDeal.DealTime);
      end;
      //Дилер   
      tick.rec.TraderID = locdeal.rec.TRADER;
      //Идентификатор контрагента   
      tick.rec.PartyID = locdeal.rec.CONTR;
      //Брокер   
      tick.rec.BrokerID = locdeal.rec.BROKER;
      //Комментарий
      tick.rec.Comment = "";
      if (VALTYPE(locdealdata.IdentityDeal.TSBrief) != V_UNDEF)
         tick.rec.Comment = "Торг.площадка:"+locdealdata.IdentityDeal.TSBrief+", ";
      end;
      if (VALTYPE(locdealdata.IdentityDeal.Comment) != V_UNDEF)
         tick.rec.Comment = tick.rec.Comment + "Комментарий:"+locdealdata.IdentityDeal.Comment;
      end;
      //тип сделки
      if (locdealdata.IdentityDeal.BuySell == "Buy")
         tick.rec.DealType = 12183;
         dl_leg1.rec.SupplyTime = dttm(date(0,0,0),time(7,0,0));
      elif (locdealdata.IdentityDeal.BuySell == "Sell")
         tick.rec.DealType = 12193;
         dl_leg1.rec.SupplyTime = dttm(date(0,0,0),time(21,0,0));
      end;
      
      //Группа сделки
      tick.rec.DealGroup = 0;
      tick.rec.Country = "RUS";
// 2020-03-02 Cherednichenko для ЦБ используем календарь бухучета - 10003
// 2020-08-03 Kadin Срок определяем функцией DL_GetNumWorkDaysForPeriod, перелав ей календарь Бухучета

/*
      if (Workdays(locdealdata.IdentityDeal.DealDate,locdealdata.DealData.CurrencyEquityDeal.TradeDate, 10003)-1 > 2)
         tick.rec.IsPFI = "X";
      end;      
*/ 

      // 15.01.2021 MAA: iS - 521755
      If(DL_GetNumWorkDaysForPeriod( locdealdata.IdentityDeal.DealDate, locdealdata.DealData.CurrencyEquityDeal.TradeDate, -1, GetFiidCodeByName(locdealdata.DealData.CurrencyEquityDeal.Currency), tick.rec.PartyID, NULL, 10003 ) > 2)
         tick.rec.IsPFI = "X";
      end;

      
      dl_leg1.rec.Registrar    = ALLFININSTR;
      dl_leg1.rec.Pitch        = 0;
      dl_leg1.rec.Mode         = 0;
      dl_leg1.rec.PeriodNumber = 0;
      dl_leg1.rec.PeriodType   = 0;
      dl_leg1.rec.Diff         = 0;
      dl_leg1.rec.PayDay       = 0;
      dl_leg1.rec.TablePercent = "";
      dl_leg1.rec.Caption      = 0;
      dl_leg1.rec.TypeDate     = 0;
      dl_leg1.rec.CountDay     = 0;
      dl_leg1.rec.Correct      = 0;
      dl_leg1.rec.LegID        = 0;
      dl_leg1.rec.Scale        = 1;
      dl_leg1.rec.LegNumber    = "";
      dl_leg1.rec.DealID = tick.rec.DealID;
      dl_leg1.rec.CFI = GetFiidCodeByName(locdealdata.DealData.CurrencyEquityDeal.Currency);
      dl_leg1.rec.PFI = GetFinIndex(locdealdata.DealData.CurrencyEquityDeal.Securities.ISIN);
      if (dl_leg1.rec.PFI == -1)
         if( SOFR_LoadRuDataByID( StrUpr(locdealdata.DealData.CurrencyEquityDeal.Securities.ISIN), 1, @err_rud ) )
            dl_leg1.rec.PFI = GetFinIndex(locdealdata.DealData.CurrencyEquityDeal.Securities.ISIN);
         else
            err_txt = "Ценная бумага с кодом " + locdealdata.DealData.CurrencyEquityDeal.Securities.ISIN + " не загружена."+err_rud;  
            RunError(err_txt, c_err_obj(err_txt,-3000));
         end;
      end;      
      dl_leg1.rec.COST = locdealdata.DealData.CurrencyEquityDeal.Price * locdealdata.DealData.CurrencyEquityDeal.Quantity;
      dl_leg1.rec.DeliveringFIID = dl_leg1.rec.PFI;
      dl_leg1.rec.PayFIID = dl_leg1.rec.NKDFIID = dl_leg1.rec.CFI;
      dl_leg1.rec.Principal = locdealdata.DealData.CurrencyEquityDeal.Quantity;
      dl_leg1.rec.Price = locdealdata.DealData.CurrencyEquityDeal.Price;
      dl_leg1.rec.TotalCost = locdealdata.DealData.CurrencyEquityDeal.Amount;
      dl_leg1.rec.Point = GetPoints(locdealdata.DealData.CurrencyEquityDeal.Price);
      dl_leg1.rec.Start = date(0,0,0); 
      dl_leg1.rec.Maturity = locdealdata.DealData.CurrencyEquityDeal.PaymentDate; 
      dl_leg1.rec.Expiry = locdealdata.DealData.CurrencyEquityDeal.SettlementDate; 
      dl_leg1.rec.Duration = 0;
      dl_leg1.rec.Basis = 0; 
      dl_leg1.rec.Formula = 50;
      //dl_leg1.rec.RelativePrice = "X";

      // депозитарий
      if ( (VALTYPE(locdealdata.DealData.CurrencyEquityDeal.ClearingMode) != V_UNDEF) ) 
         dl_leg1.rec.DepositID = Codeparty(locdealdata.DealData.CurrencyEquityDeal.ClearingMode,103);
      end;

      //Генеральное соглашение
      tick.rec.GenagrID = -1;
      var GenAgr;
      
      // gtv: поиск ГС вынесен в отдельную функцию
      GenAgr = FindGenAgreementByParty(locdealdata.IdentityDeal.GenAgreement, 1, locdeal.rec.CONTR, "BOND", tick.rec.DealType, null, null, dl_leg1); // для Equity как для бондов
      tick.rec.GenagrID = GenAgr.AgrID;           // по умолчанию -1
      tick.rec.conftpid = GenAgr.Confirmmethod;   // по умолчанию SWIFT

      var attr61 = GetAttr61(dl_leg1.rec.PFI);
      if (attr61 > 0)
         if (attr61 == 1) //АС_ЦБ
            tick.rec.PortfolioID = 5;
         elif (attr61 == 2) //ССПУ_ЦБ
            tick.rec.PortfolioID = 1;
         elif (attr61 == 3) //СССД_ЦБ
            tick.rec.PortfolioID = 2;
         end;
      else
         var getreg = GetRegistryValue ("SECUR\\МСФО\\ПОРТФЕЛЬ ПО УМОЛЧАНИЮ", V_INTEGER, tick.rec.PortfolioID);
         if (ValType(getreg) == V_UNDEF)
            tick.rec.PortfolioID = 2;
         else
            if (tick.rec.PortfolioID == 0)
               tick.rec.PortfolioID = 1;
            else
               tick.rec.PortfolioID = 2;
            end;
         end;
      end;
 

   end;

   private macro CreateMMDeal()
      private var que, rs, rsp, ftype, pfiid, cbank, caccount, obank, oaccount,;
      VAR PriceParm, NumLotsParm, BaseFIID, FaceValue = $0, Error = 0, rate = 0.0, PtKindName = "";

      var isUpdate = false; // обновление биржевой сделки

      if (strupr(locdeal.rec.ActionType) == "DELETE")
         que =  "DECLARE "
              + "   dealid NUMBER(10); "
              + "   objectid varchar2(30); "
              + "BEGIN "
              + "   dealid := ?; "
              + "   objectid := ?; "
              + "   delete from dnotetext_dbt where t_objecttype=103 and t_notekind=121 and to_number(t_documentid) = dealid; "
              + "   delete from ddl_leg_dbt where t_dealid = dealid; "
              + "   delete from ddl_tick_dbt where t_dealid = dealid; "
              + "   delete from ddl_grnt_dbt where t_dealid = dealid; "
              + "   delete from dmmdqlt_dbt where t_dealid = dealid; "
              + "   delete from dprccontract_dbt where t_objectid = objectid; "
              + "END; ";
         rs = RSDCommand(que);
         rs.addParam( "", RSDBP_IN, locdeal.rec.DEAL_ID );
         rs.addParam( "", RSDBP_IN, locdealdata.IdentityDeal.ExternalID );
         rs.execute();
         return true;
      end;

      ppaym = SP_ParmPaym();

      //тип сделки
      if (locdealdata.IdentityDeal.BuySell == "Buy")
         tick.rec.DealType = 12183;
      elif (locdealdata.IdentityDeal.BuySell == "Sell")
         tick.rec.DealType = 12193;
      end;      

      InitSPDeal(tick, DL_SECURITYDOC, tick.rec.DealType, true);   
      CreateEquityDeal(DL_SECURITYDOC);

 /*     ArrComSums.Size = 0;
      var ArrComSums_i = 0, ComSum = $0, ComType = 0, ComCur = -1;
      if ( ValType(locdealdata.ComissArray) != V_UNDEF )
         ArrComSums.Size = 0;
         var CommDate:date = tick.rec.DealDate;
         if( tick.rec.DealTime > Time(19,0,0) )
// 2020-03-02 Cherednichenko для ЦБ используем календарь бухучета - 10003
            CommDate = GetDateAfterWorkDays(CommDate, 1, 10003);
         end;
         var GateCommDate = null;
         
         var dlcomis_market = TRecHandler( "dlcomis.dbt"  );
    
         var i = 0;
         while(locdealdata.ComissArray.size > i)
             ComSum = locdealdata.ComissArray[i].Amount;
             type = locdealdata.ComissArray[i].Type;
             if( ComSum > $0.0 )
                dlcomis_market.Clear();
                if( not RG_InitDlComis("МскБиржПИ", dlcomis_market, @ErrMes, null, ComSum) )
                   err_txt = ErrMes;  
                   RunError(err_txt, c_err_obj(err_txt,-3000));
                else
                   dlcomis_market.rec.Date = dlcomis_market.rec.PlanPayDate = CommDate;
                      
                   ArrComSums_i = ArrComSums.Size;
                   ArrComSums(ArrComSums_i) = TRecHandler("dlcomis");
                   copy(ArrComSums(ArrComSums_i), dlcomis_market);
                end;
             end;
             i = i + 1;
         end;
      end;        */

      SetAccountsRQ( tick, ppaym );

      var ReturnIncome:money = $0;
      var CmdKind = "Insert";

      /*если находим сделку в отложенных, то пытаемся обновить ее*/
      VAR cmd_tick = RSDCommand( "SELECT tick.t_DealID, tick.t_DealStatus, leg1.t_ID LegID1, leg1.t_Cost Cost1, leg1.t_Principal Principal1 "+
                                 "  FROM ddl_tick_dbt tick, ddl_leg_dbt leg1 " +
                                 " WHERE     tick.t_DealCode    = ? " +
                                 "       AND leg1.t_DealID      = tick.t_DealID " +
                                 "       AND leg1.t_LegID       = 0 "
                               );  
      
      cmd_tick.addParam( "", RSDBP_IN, tick.rec.DealCode );
    
      cmd_tick.NullConversion = true;
      cmd_tick.execute();

      var DataSet_tick = TRsbDataSet( cmd_tick );
      if( DataSet_tick.MoveNext() )
         if( DataSet_tick.DealStatus == DL_PREPARING )
            tick.rec.DealID = DataSet_tick.DealID;/*для того, чтобы существующая сделка была обновлена в ф-и SP_DealGateCreateNew*/
            dl_leg1.rec.DealID    = DataSet_tick.DealID;
            dl_leg1.rec.ID        = DataSet_tick.LegID1;
            dl_leg1.rec.LEGKIND   = LEG_KIND_DL_TICK;
            dl_leg1.rec.Cost      = DataSet_tick.Cost1;
            dl_leg1.rec.Principal = DataSet_tick.Principal1;

            CmdKind = "Update";
         else
            err_txt = "Ошибка при обновлении сделки в БОЦБ.\nВ БОЦБ уже существует сделка с внешним кодом \""+tick.rec.DealCode+"\".\nДля обновления она должна быть отложена.";  
            RunError(err_txt, c_err_obj(err_txt,-3000));
         end;
      end;

      var targetDealID: Integer = 0;
      if ((tick.rec.DealID == 0) and (prm_ObjID > 0))
        targetDealID = prm_ObjID;
      end;

      stat = SP_DealGateCreateNew( tick, dl_leg1, dl_leg2, spgr1, spgr2, rq_avance1, rq_avance2, rq_acc_clnt, rq_acc_contr, 
                                   rq_acc_clnt_depo, rq_acc_contr_depo, ClntRep, outlay, ArrComSums, spgrdoc, targetDealID );

      if(stat != 0)
         err_txt = "Ошибка "+stat+" при "+iif((CmdKind == "Update"),"обновлении","вставке")+" сделки в БОЦБ.\n" 
           + CB_ErrMsg(GetErrMsg(), tick.rec.clientid, dl_leg1.rec.cfi) // DEF-66627 заменяем неинформативное сообщение
         ;  
         RunError(err_txt, c_err_obj(err_txt,-3000));
      end;

      if (VALTYPE(locdealdata.IdentityDeal.ConversationText) != V_UNDEF)
         addNoteForObject( 101, string(tick.rec.DealID:o:34), 300, locdealdata.IdentityDeal.ConversationText, {curdate});
      end;
      if (locdeal.rec.TRADERNAME != "")
         addNoteForObject( 101, string(tick.rec.DealID:o:34), 150, locdeal.rec.TRADERNAME, {curdate});
      end;
      if (tick.rec.Comment != "")
         addNoteForObject( 101, string(tick.rec.DealID:o:34), 151, tick.rec.Comment, {curdate});
      end;

      ObjID  = string(tick.rec.DealID:o:34);
      ObjCat = RsbObjCategories( 101, ObjID);
      ObjCat.ConnectAttr(102, 1, NULL, NULL, {curdate} );
      ObjCat.Save(ObjID);

      return true;
  end;

  macro CreateDeal()
      if (not CreateMMDeal())
          return 1;
      end;

      prm_ObjID = tick.rec.DealID;

      return 0;
  end;

  macro Get_ObjID()
      return prm_ObjID;
  end;

  macro Get_Comment()
      return prm_Comment;
  end;

  private macro ClassConstructor( obdeal )
      prm_ObjID   = -1;
      prm_Comment = "";
      
      if ((ValType(obdeal.IdentityDeal.SofrGenID) != V_UNDEF) and (obdeal.IdentityDeal.SofrGenID > 0))
        prm_ObjID = obdeal.IdentityDeal.SofrGenID;
      end;
  end;

  ClassConstructor( obdeal );
end;

///////////////////////////////////////////////////////////////////////////////////
// CurDeal
///////////////////////////////////////////////////////////////////////////////////

private class Ob_CurDeal( obdeal )
  private var
      prm_SeanceID,
      prm_RecordID;

  private var
      prm_ObjID,
      prm_Comment;

  private var
      RG;

  private var
      prm_deferOp,
      prm_deferDoc;

  var dvndeal = TRecHandler( "dvndeal.dbt" );
  var dvnfi   = TRecHandler( "dvnfi.dbt" );
  var koper    = TBFile( "oprkoper", "R", 0 );
  var spground = TBFile( "spground", "R", 4 );
  var dvnfi2 = null;
  var spgrdoc = null;

  var ArrComSums = TArray();/*список комиссиий*/
  var ArrNotes   = TArray();/*список примечаний*/
  var ArrPmGr    = TArray();/*список строк графика*/
  var ClntRep = TRecHandler("spground.dbt");
  var ContractorContrID, ComisContrID;
  var type, stat = 0;

  private macro alltrim( str )
     private var sss="", i=1;
     while ( i <= strlen(str) )
        if ( substr(str,i,1) != " " )
           sss = sss + substr(str,i,1);
        end;
        i = i + 1;
     end;
     return sss;
  end;

  private macro GetAcc(str)
     private var i, j=2;
     if ((str==NULL) or (str==""))
        return "";
     end;
     if ((strlen(str) == 20) and (substr(str,1,1) != "/"))
        return str;
     end;
     if (substr(str,1,4) == "CASH") str=substr(str,6); j=1; end;
     i = index(str," ");
     if (i == 0)
        return substr(str,j);
     else
        return substr(str,j,i-j);
     end;
     return "";
  end;

  private macro GetBIK(str)
     private var i, sql, rs;
     if ((str==NULL) or (str==""))
        return "";
     end;
     if ((strlen(str) == 20) and (substr(str,1,1) != "/"))
        sql = "select t_fiid, t_corrid from dcorschem_dbt where t_account='"+str+"'";
        rs = LnGetRecordset(sql);
        if (rs.MoveNext())
           if (rs.value(0) > 0)
              return GetCode(rs.value(1),6);
           else
              return GetCode(rs.value(1),3);
           end;
        end;
        return "";
     end;
     if (substr(str,1,4) == "CASH") str=substr(str,6); end;
     i = index(str," ");
     if (i > 0)
        return trim(substr(str,i+1));
     end;
     return "";
  end;

  private macro GetClientContrID(pid)
    var sql,rs;
    sql = " SELECT t.t_id cid "
    + " FROM dsfcontr_dbt t "
    + " WHERE t.t_partyid = :1 "
    + " AND t.t_servkind = 15 "
    + " AND t.t_datebegin <= to_date('"+{curdate}+"', 'dd.mm.yyyy') "
    + " AND ( "
    + " t.t_dateclose = to_date('01.01.0001', 'dd.mm.yyyy') OR "
    + " t.t_dateclose > to_date('"+{curdate}+"', 'dd.mm.yyyy') "
    + "  ) ";
    msgbox(sql);
    rs = ExecSqlSelect(sql,MakeArray(SqlParam("1", pid)),false);

    if (rs.MoveNext())
      return rs.value("cid");
    else
      return -1;
    end;
  end;

  private macro FindPeriodIRSSwap(_CallNotice, _PERIOD, _PERIODKIND)
    var v_period=-1, v_periodkind="ERROR";
    if (StrUpr(_CallNotice) == "D")  // день
       v_period = 1;
       v_periodkind = 1;
    elif (StrUpr(_CallNotice) == "W")   // неделя
       v_period = 7;
       v_periodkind = 1;
    elif (StrUpr(_CallNotice) == "M")   // месяц
       v_period =  1;
       v_periodkind = 2;
    elif ( (StrUpr(_CallNotice) == "Y") or (StrUpr(_CallNotice) == "A") )  // год
       v_period = 1;
       v_periodkind = 3;
    elif (StrUpr(_CallNotice) == "Q")   // квартал
       v_period = 3;
       v_periodkind = 2;
    elif (StrUpr(_CallNotice) == "HY")  // полгода
       v_period = 6;
       v_periodkind = 2;
    elif (StrUpr(_CallNotice) == "BM")  // дважды в месяц
       v_period = 15;
       v_periodkind =  1;
   elif (StrUpr(_CallNotice) == "E")   // в конце срока
       v_period = 1;
       v_periodkind = 4;
   else // def-27237 другой срок в формате 'Реальный срок выплат' ('6W' / '3M') Допустимый тип срока D, W, M, Q, Y
       var sql_str = "select nvl(regexp_substr(:str1,'[[:digit:]]+'),-1) period, nvl(regexp_substr(:str2,'D|W|M|Q|Y'),'ERROR') periodkind from dual";
       var cmd = RSDCommand(sql_str);
       var period_str = StrUpr(_CallNotice);
       cmd.AddParam("str1", RSDBP_IN, period_str);
       cmd.AddParam("str2", RSDBP_IN, period_str);
       var rs = RSDRecordSet(cmd);
       if (rs.movenext)
          v_period = Int(rs.value("period"));
          v_periodkind = rs.value("periodkind");
       end;
       if (v_periodkind == "D")  // день
          v_periodkind = 1;
       elif (v_periodkind == "W")   // неделя
          v_period = 7*v_period;
          v_periodkind = 1;
       elif (v_periodkind == "M")   // месяц
          v_periodkind = 2;
       elif (v_periodkind == "Q")   // квартал
          v_period = 3*v_period;
          v_periodkind = 2;
       elif ( v_periodkind == "Y")  // год
          v_periodkind = 3;
       else
          RunError("Не удалось определить период платежей: CallNotice="+_CallNotice);
       end;
   end;

   if (v_period == -1)
      RunError("Не удалось определить период платежей: CallNotice="+_CallNotice);
   end;
   if (v_periodkind == "ERROR")
      RunError("Не удалось определить период платежей: CallNotice="+_CallNotice);
   end;

   SetParm(2,v_period);    // параметр 0 - сам класс
   SetParm(3,v_periodkind);

  end;

  private macro CreateCurrDeal(_Kind, dealday)
    var status,rs,sql,exectype,IdStorage,DeliverAddr;

    dvndeal.rec.ID = 0;
    if ((_kind == 22745) or (_kind == 12745))
       dvndeal.rec.DOCKIND = BOKINDT3;
    else
       dvndeal.rec.DOCKIND = BOKIND;
    end;
    dvndeal.rec.KIND = _Kind; //вид сделки
    //направление сделки
    if   ( locdealdata.IdentityDeal.BuySell == "Buy" )
       dvndeal.rec.TYPE = "1"; // Покупка
    elif ( locdealdata.IdentityDeal.BuySell == "Sell" )
       dvndeal.rec.TYPE = "2"; //Продажа
    end;
    dvndeal.rec.DATE = locdealdata.IdentityDeal.DealDate; //дата операции
    dvndeal.rec.TIME = Time(0,0,0);
    if (ValType(locdealdata.IdentityDeal.DealTime) != V_UNDEF)
       dvndeal.rec.TIME = Time(locdealdata.IdentityDeal.DealTime);
    elif (ValType(locdealdata.IdentityDeal.DealCaptureTime) != V_UNDEF)
       dvndeal.rec.TIME = Time(locdealdata.IdentityDeal.DealCaptureTime);
    end;
    dvndeal.rec.CODE = locdealdata.IdentityDeal.DealID;
    dvndeal.rec.EXTCODE = "";
    if (VALTYPE(locdealdata.IdentityDeal.ExternalID) != V_UNDEF)
       dvndeal.rec.EXTCODE = locdealdata.IdentityDeal.ExternalID;
    end;
    dvndeal.rec.CONTRACTOR = locdeal.rec.CONTR;
    if (VALTYPE(locdealdata.DealData.CurrencyDeal.Netting) != V_UNDEF)
       if (locdealdata.DealData.CurrencyDeal.Netting)
          dvndeal.rec.NETTING = "X";
       end;
    end;
    /*if (locdealdata.DealData.CurrencyDeal.IsDerivative)
       dvndeal.rec.ISPFI = "X";
    end;*/
    if ((_kind == 22730) or (_kind == 12730))
       dvndeal.rec.DVKIND = 7;
    elif (_kind == 2731)          //shev 20201005 для сделок со слитками
       dvndeal.rec.DVKIND = 9;
    elif (_kind == 12735)
       dvndeal.rec.DVKIND = 8;
    elif ((_kind == 22745) or (_kind == 12745))
       dvndeal.rec.DVKIND = 5;
       dvndeal.rec.ISPFI = "X";  /*PNV 532509*/
    end;
    dvndeal.rec.STATE = 0;
    dvndeal.rec.DEPARTMENT = 1; //locdeal.rec.FILIAL;
    dvndeal.rec.OPER = {oper};
    dvndeal.rec.AGENT = locdeal.rec.BROKER;
    if (locdeal.rec.CLIENT == 0)
       dvndeal.rec.CLIENT = -1;
    else
       dvndeal.rec.CLIENT = locdeal.rec.CLIENT;
       dvndeal.rec.CLIENTCONTR = GetClientContrID(locdeal.rec.CLIENT);
    end;
    dvndeal.rec.PARENTID = -1;
    dvndeal.rec.GENAGRID = -1;
    if (Index(StrUpr(locdealdata.IdentityDeal.TSBrief),"SPVB") > 0)
      dvndeal.rec.KINDDEALPARTYCLIENT = -1;
    else
      dvndeal.rec.KINDDEALPARTYCLIENT = 0;
    end;
    if (VALTYPE(locdealdata.IdentityDeal.TSBrief) != V_UNDEF)
       dvndeal.rec.COMMENT = "Торг.площадка:"+locdealdata.IdentityDeal.TSBrief+", ";
    end;
    dvndeal.rec.COMMENT = dvndeal.rec.COMMENT + "Комментарий:"+locdealdata.IdentityDeal.Comment;
    dvndeal.rec.COUNTRY = 165;
    dvndeal.rec.TRADERID = locdeal.rec.TRADER;
    if((Index(StrUpr(locdealdata.IdentityDeal.TSBrief),"MOEX") > 0) OR (Index(StrUpr(locdealdata.IdentityDeal.TSBrief),"SPVB") > 0))
      dvndeal.rec.SECTOR = "X";
      dvndeal.rec.MARKETKIND = 2;
      if (locdeal.rec.CLIENT == 0)
        FillMarket(@dvndeal, IIF(Index(StrUpr(locdealdata.IdentityDeal.TSBrief),"MOEX") > 0, Валютный_рынок, СПВБ_Валютный_рынок)); //dan заполним для собственной сделки схему расчетов с биржей
      end;
    end;
    /*dvndeal.rec.PERIODCLS = Workdays(locdealdata.IdentityDeal.DealDate,locdealdata.DealData.CurrencyDeal.Payments.ValueDate1)-1;
    if ((_kind==12735) and (locdealdata.DealData.CurrencyDeal.Payments.ValueDate2 < locdealdata.DealData.CurrencyDeal.Payments.ValueDate1))
       dvndeal.rec.PERIODCLS = Workdays(locdealdata.IdentityDeal.DealDate,locdealdata.DealData.CurrencyDeal.Payments.ValueDate2)-1;
    end;*/
    dvndeal.rec.PERIODCLS = dealday;
    if (dvndeal.rec.PERIODCLS > 2)
       dvndeal.rec.PERIODCLS = 3;
    end;

    dvnfi.rec.ID = 0;
    dvnfi.rec.DEALID = dvndeal.rec.ID;
    dvnfi.rec.TYPE = 0; //актив по сделке
    if (VALTYPE(locdealdata.DealData.CurrencyDeal.PrecMetal) != V_UNDEF)
       dvnfi.rec.FIID = GetFiidByISOCode(substr(locdealdata.DealData.CurrencyDeal.PairsName,1,3),6);
    else
       dvnfi.rec.FIID = GetFiidByISOCode(substr(locdealdata.DealData.CurrencyDeal.PairsName,1,3),1);
    end;
    dvnfi.rec.AMOUNT = abs(locdealdata.DealData.CurrencyDeal.Payments.Amount1);
    dvnfi.rec.EXECDATE = min(locdealdata.DealData.CurrencyDeal.Payments.ValueDate2, locdealdata.DealData.CurrencyDeal.Payments.ValueDate1); /*PNV 543709 дата исполнения - наименьшая из двух даты оплаты и поставки*/
    dvnfi.rec.EXECTYPE = 1; //Поставочный
    dvnfi.rec.PAYDATE = locdealdata.DealData.CurrencyDeal.Payments.ValueDate2;
    dvnfi.rec.SUPLDATE = locdealdata.DealData.CurrencyDeal.Payments.ValueDate1;
    dvnfi.rec.COST = abs(locdealdata.DealData.CurrencyDeal.Payments.Amount2);
    dvnfi.rec.PRICE = abs(locdealdata.DealData.CurrencyDeal.Rate);
    dvnfi.rec.PRICEFIID = GetFiidByISOCode(substr(locdealdata.DealData.CurrencyDeal.PairsName,5,3),1);
    dvnfi.rec.POINT = GetPoints(dvnfi.rec.PRICE); //количество символов после запятой для PRICE       
    if (VALTYPE(locdealdata.DealData.CurrencyDeal.RateQutationUnit) != V_UNDEF)
       if (locdealdata.DealData.CurrencyDeal.RateQutationUnit > dvnfi.rec.POINT)
          dvnfi.rec.POINT = locdealdata.DealData.CurrencyDeal.RateQutationUnit;
       end;
//       if (dvnfi.rec.POINT == 0) dvnfi.rec.POINT = GetPoints(dvnfi.rec.PRICE); end;
    end;
    dvnfi.rec.CONTRAMOUNT = 1;
    dvnfi.rec.STDFIID = -1;
    dvnfi.rec.ACCFIID = -1;
    dvnfi.rec.RATEID = -1;
    dvnfi.rec.CALKINDID = -1;
    dvnfi.rec.SCALE = 1;
    if ((VALTYPE(locdealdata.DealData.CurrencyDeal.RateDirection) != V_UNDEF) and
        (locdealdata.DealData.CurrencyDeal.RateDirection == "I"))
       dvnfi.rec.ISINVERSE = "X";
    end;
//shev 20201005
    if (_kind == 2731)
       dvnfi.rec.VATRATE = GetNdsOnComment(locdealdata.IdentityDeal.Comment)*100/(abs(locdealdata.DealData.CurrencyDeal.Payments.Amount2)-GetNdsOnComment(locdealdata.IdentityDeal.Comment));
       dvnfi.rec.VATSUM = GetNdsOnComment(locdealdata.IdentityDeal.Comment);
       dvnfi.rec.PUREWGR = abs(locdealdata.dealdata.currencydeal.precmetal.amount);
       dvnfi.rec.PUREWOZ = abs(locdealdata.dealdata.currencydeal.precmetal.amount)*Ounce;
       dvnfi.rec.LIGATWGR = abs(locdealdata.dealdata.currencydeal.precmetal.amount);
       dvnfi.rec.LIGATWOZ = abs(locdealdata.dealdata.currencydeal.precmetal.amount)*Ounce;
       dvnfi.rec.withvat = "X";
       dvnfi.rec.ACCFIID = GetFiidByISOCode(substr(locdealdata.DealData.CurrencyDeal.PairsName,5,3),1);
       if(GetBankVaultonComment(locdealdata.IdentityDeal.Comment,locdealdata.IdentityDeal.BuySell,@IdStorage,@DeliverAddr) != -1)
          dvnfi.rec.BANKSTORAGE = IdStorage;
          dvnfi.rec.DELIVADDR = DeliverAddr;
       end;
    end;

  end;

  private macro CreateFWDDeal(_Kind)
    var status,rs,sql,exectype;

    dvndeal.rec.ID = 0;
    dvndeal.rec.DOCKIND = BOKINDFWD;
    dvndeal.rec.KIND = _Kind; //вид сделки
    //направление сделки
    if   ( locdealdata.IdentityDeal.BuySell == "Buy" )
       dvndeal.rec.TYPE = "1"; // Покупка
    elif ( locdealdata.IdentityDeal.BuySell == "Sell" )
       dvndeal.rec.TYPE = "2"; //Продажа
    end;
    dvndeal.rec.DATE = locdealdata.IdentityDeal.DealDate; //дата операции
    dvndeal.rec.TIME = Time(0,0,0);
    if (ValType(locdealdata.IdentityDeal.DealTime) != V_UNDEF)
       dvndeal.rec.TIME = Time(locdealdata.IdentityDeal.DealTime);
    elif (ValType(locdealdata.IdentityDeal.DealCaptureTime) != V_UNDEF)
       dvndeal.rec.TIME = Time(locdealdata.IdentityDeal.DealCaptureTime);
    end;
    dvndeal.rec.CODE = locdealdata.IdentityDeal.DealID;
    dvndeal.rec.EXTCODE = "";
    if (VALTYPE(locdealdata.IdentityDeal.ExternalID) != V_UNDEF)
       dvndeal.rec.EXTCODE = locdealdata.IdentityDeal.ExternalID;
    end;
    dvndeal.rec.CONTRACTOR = locdeal.rec.CONTR;
    if (VALTYPE(locdealdata.DealData.CurrencyFWDDeal.Netting) != V_UNDEF)
       if (locdealdata.DealData.CurrencyFWDDeal.Netting)
          dvndeal.rec.NETTING = "X";
       end;
    end;
    if (locdealdata.DealData.CurrencyFWDDeal.IsDerivative)
       dvndeal.rec.ISPFI = "X";
    end;
    dvndeal.rec.DVKIND = 1;
    dvndeal.rec.STATE = 0;
    dvndeal.rec.DEPARTMENT = 1; //locdeal.rec.FILIAL;
    dvndeal.rec.OPER = {oper};
    dvndeal.rec.AGENT = locdeal.rec.BROKER;
    if (locdeal.rec.CLIENT == 0)
       dvndeal.rec.CLIENT = -1;
    else
       dvndeal.rec.CLIENT = locdeal.rec.CLIENT;
       dvndeal.rec.CLIENTCONTR = GetClientContrID(locdeal.rec.CLIENT);
    end;
    dvndeal.rec.PARENTID = -1;
    dvndeal.rec.GENAGRID = -1;
    dvndeal.rec.KINDDEALPARTYCLIENT = -1;
    if (VALTYPE(locdealdata.IdentityDeal.TSBrief) != V_UNDEF)
       dvndeal.rec.COMMENT = "Торг.площадка:"+locdealdata.IdentityDeal.TSBrief+", ";
    end;
    dvndeal.rec.COMMENT = dvndeal.rec.COMMENT + "Комментарий:"+locdealdata.IdentityDeal.Comment;
    dvndeal.rec.COUNTRY = 165;
    dvndeal.rec.TRADERID = locdeal.rec.TRADER;
    dvndeal.rec.PERIODCLS = 3;
    if ((locdeal.rec.CONTRNAME == "MICX") or (locdeal.rec.CONTRNAME == "MICR"))
       dvndeal.rec.SECTOR = "X";
       dvndeal.rec.MARKETKIND = 2;

      if (locdeal.rec.CLIENT == 0)
         FillMarket(@dvndeal); //dan заполним для собственной сделки схему расчетов с биржей
      end;

    end;

    dvnfi.rec.ID = 0;
    dvnfi.rec.DEALID = dvndeal.rec.ID;
    dvnfi.rec.TYPE = 0; //актив по сделке
    if (VALTYPE(locdealdata.DealData.CurrencyFWDDeal.PrecMetal) != V_UNDEF)
       dvnfi.rec.FIID = GetFiidByISOCode(substr(locdealdata.DealData.CurrencyFWDDeal.PairsName,1,3),6);
    else
       dvnfi.rec.FIID = GetFiidByISOCode(substr(locdealdata.DealData.CurrencyFWDDeal.PairsName,1,3),1);
    end;
    dvnfi.rec.AMOUNT = abs(locdealdata.DealData.CurrencyFWDDeal.Payments.Amount1);
    dvnfi.rec.EXECDATE = locdealdata.DealData.CurrencyFWDDeal.Payments.ValueDate2;
    if (locdealdata.DealData.CurrencyFWDDeal.PayType=="Поставочный")
       dvnfi.rec.EXECTYPE = 1;
    else
       dvnfi.rec.EXECTYPE = 0;
    end;
    dvnfi.rec.PAYDATE = locdealdata.DealData.CurrencyFWDDeal.Payments.ValueDate2;
    dvnfi.rec.SUPLDATE = locdealdata.DealData.CurrencyFWDDeal.Payments.ValueDate1;
    dvnfi.rec.COST = abs(locdealdata.DealData.CurrencyFWDDeal.Payments.Amount2);
    dvnfi.rec.PRICE = abs(locdealdata.DealData.CurrencyFWDDeal.Rate);
    dvnfi.rec.PRICEFIID = GetFiidByISOCode(substr(locdealdata.DealData.CurrencyFWDDeal.PairsName,5,3),1);
    dvnfi.rec.POINT = GetPoints(dvnfi.rec.PRICE); //количество символов после запятой для PRICE       
    if (VALTYPE(locdealdata.DealData.CurrencyFWDDeal.RateQutationUnit) != V_UNDEF)
       if (locdealdata.DealData.CurrencyFWDDeal.RateQutationUnit > dvnfi.rec.POINT)
           dvnfi.rec.POINT = locdealdata.DealData.CurrencyFWDDeal.RateQutationUnit;
       end;
//       if (dvnfi.rec.POINT == 0) dvnfi.rec.POINT = GetPoints(dvnfi.rec.PRICE); end;
    end;
    dvnfi.rec.CONTRAMOUNT = 1;
    dvnfi.rec.STDFIID = -1;
    dvnfi.rec.ACCFIID = -1;
    dvnfi.rec.RATEID = -1;
    dvnfi.rec.CALKINDID = -1;
    dvnfi.rec.SCALE = 1;
    if ((VALTYPE(locdealdata.DealData.CurrencyFWDDeal.RateDirection) != V_UNDEF) and
        (locdealdata.DealData.CurrencyFWDDeal.RateDirection == "I"))
       dvnfi.rec.ISINVERSE = "X";
    end;
  end;

  private macro CreateBONDeal(_Kind)   //gtv: эта ветка уже давно не используется, так как бонды в модуле ЦБ
    var status,rs,sql,exectype;
    var err_rud;

    dvndeal.rec.ID = 0;
    dvndeal.rec.DOCKIND = BOKINDFWD;
    dvndeal.rec.KIND = _Kind; //вид сделки
    //направление сделки
    if   ( locdealdata.IdentityDeal.BuySell == "Buy" )
       dvndeal.rec.TYPE = "1"; // Покупка
    elif ( locdealdata.IdentityDeal.BuySell == "Sell" )
       dvndeal.rec.TYPE = "2"; //Продажа
    end;
    dvndeal.rec.DATE = locdealdata.IdentityDeal.DealDate; //дата операции
    dvndeal.rec.TIME = Time(0,0,0);
    if (ValType(locdealdata.IdentityDeal.DealTime) != V_UNDEF)
       dvndeal.rec.TIME = Time(locdealdata.IdentityDeal.DealTime);
    end;
    dvndeal.rec.CODE = locdealdata.IdentityDeal.DealID;
    dvndeal.rec.EXTCODE = "";
    if (VALTYPE(locdealdata.IdentityDeal.ExternalID) != V_UNDEF)
       dvndeal.rec.EXTCODE = locdealdata.IdentityDeal.ExternalID;
    end;
    dvndeal.rec.CONTRACTOR = locdeal.rec.CONTR;
    /*if (VALTYPE(locdealdata.DealData.CurrencyFWDDeal.Netting) != V_UNDEF)
       if (locdealdata.DealData.CurrencyFWDDeal.Netting)
          dvndeal.rec.NETTING = "X";
       end;
    end;
    if (locdealdata.DealData.CurrencyFWDDeal.IsDerivative)
       dvndeal.rec.ISPFI = "X";
    end;*/
    dvndeal.rec.ISPFI = "X";
    dvndeal.rec.NETTING_PMGR = "X";
    dvndeal.rec.DVKIND = 1;
    dvndeal.rec.STATE = 0;
    dvndeal.rec.DEPARTMENT = 1; //locdeal.rec.FILIAL;
    dvndeal.rec.OPER = {oper};
    dvndeal.rec.AGENT = locdeal.rec.BROKER;
    if (locdeal.rec.CLIENT == 0)
       dvndeal.rec.CLIENT = -1;
    else
       dvndeal.rec.CLIENT = locdeal.rec.CLIENT;
       dvndeal.rec.CLIENTCONTR = GetClientContrID(locdeal.rec.CLIENT);
    end;
    dvndeal.rec.PARENTID = -1;
    dvndeal.rec.GENAGRID = -1;
    dvndeal.rec.KINDDEALPARTYCLIENT = -1;
    if (VALTYPE(locdealdata.IdentityDeal.TSBrief) != V_UNDEF)
       dvndeal.rec.COMMENT = "Торг.площадка:"+locdealdata.IdentityDeal.TSBrief+", ";
    end;
    dvndeal.rec.COMMENT = dvndeal.rec.COMMENT + "Комментарий:"+locdealdata.IdentityDeal.Comment;
    dvndeal.rec.COUNTRY = 165;
    dvndeal.rec.TRADERID = locdeal.rec.TRADER;
    dvndeal.rec.PERIODCLS = 3;
    if ((locdeal.rec.CONTRNAME == "MICX") or (locdeal.rec.CONTRNAME == "MICR"))
       dvndeal.rec.SECTOR = "X";
       dvndeal.rec.MARKETKIND = 2;

      if (locdeal.rec.CLIENT == 0)
         FillMarket(@dvndeal); //dan заполним для собственной сделки схему расчетов с биржей
      end;

    end;

    var Nominal=0;

    dvnfi.rec.ID = 0;
    dvnfi.rec.DEALID = dvndeal.rec.ID;
    dvnfi.rec.TYPE = 0; //актив по сделке
    dvnfi.rec.FIID = GetFinIndex(locdealdata.DealData.BondDeal.Securities.ISIN);
    if (dvnfi.rec.FIID == -1)
       if( SOFR_LoadRuDataByID( StrUpr(locdealdata.DealData.BondDeal.Securities.ISIN), 1, @err_rud ) )
         dvnfi.rec.FIID = GetFinIndex(locdealdata.DealData.BondDeal.Securities.ISIN);
       else
          err_txt = "Ценная бумага с кодом " + locdealdata.DealData.BondDeal.Securities.ISIN + " не загружена."+err_rud ;  
          RunError(err_txt, c_err_obj(err_txt,-3000));
       end;
    end;
    dvnfi.rec.AMOUNT = locdealdata.DealData.BondDeal.Number;
    dvnfi.rec.EXECDATE = locdealdata.DealData.BondDeal.ValueDate;
    /*if (locdealdata.DealData.CurrencyFWDDeal.PayType=="Поставочный")
       dvnfi.rec.EXECTYPE = 1;
    else
       dvnfi.rec.EXECTYPE = 0;
    end;*/
    dvnfi.rec.EXECTYPE = 1;
    dvnfi.rec.PAYDATE = locdealdata.DealData.BondDeal.PayDate;
    dvnfi.rec.SUPLDATE = locdealdata.DealData.BondDeal.DelivDate;

    /*maa280219*/ dvnfi.rec.COST = locdealdata.DealData.BondDeal.PricePrc * Nominal * locdealdata.DealData.BondDeal.Number / 100;
    /*dvnfi.rec.COST = locdealdata.DealData.BondDeal.Amount;*/

    SP_GetNominal(dvnfi.rec.FIID, dvnfi.rec.PAYDATE, Nominal);
    dvnfi.rec.PRICE = Nominal * locdealdata.DealData.BondDeal.PricePrc / 100;
	/*CHVA*/
	if (Valtype(locdealdata.DealData.BondDeal.CouponAmount) != V_UNDEF)
	    dvnfi.rec.NKD = abs(locdealdata.DealData.BondDeal.CouponAmount);
    else
               /*maa280219*/ dvnfi.rec.NKD = abs(locdealdata.DealData.BondDeal.CouponPrc * Nominal * locdealdata.DealData.BondDeal.Number / 100 );

	       /*CHVA - dvnfi.rec.NKD = abs(locdealdata.DealData.BondDeal.Couponprc*10*locdealdata.DealData.BondDeal.Number);*/
	       /*dvnfi.rec.NKD = abs(locdealdata.DealData.BondDeal.Amount - locdealdata.DealData.BondDeal.PriceNominal);*/
    end;
	/*CHVA*/
    dvnfi.rec.PRICEFIID = GetFiidCodeByName(locdealdata.DealData.BondDeal.CurrencyDeals);
    dvnfi.rec.POINT = GetPoints(dvnfi.rec.PRICE); //количество символов после запятой для PRICE       
    dvnfi.rec.CONTRAMOUNT = 1;
    dvnfi.rec.STDFIID = -1;
    dvnfi.rec.ACCFIID = dvnfi.rec.PRICEFIID;
    dvnfi.rec.RATEID = -1;
    dvnfi.rec.CALKINDID = -1;
    dvnfi.rec.SCALE = 1;
  end;

  private macro CreateFRADeal(_Kind)
    var status,rs,sql,exectype;

    dvndeal.rec.ID = 0;
    dvndeal.rec.DOCKIND = BOKINDFWD;
    dvndeal.rec.KIND = _Kind; //вид сделки
    //направление сделки
    if   ( locdealdata.IdentityDeal.BuySell == "Buy" )
       dvndeal.rec.TYPE = "7"; // Fix\Float
    elif ( locdealdata.IdentityDeal.BuySell == "Sell" )
       dvndeal.rec.TYPE = "8"; // Float\Fix
    end;
    dvndeal.rec.DATE = locdealdata.IdentityDeal.DealDate; //дата операции
    dvndeal.rec.TIME = Time(0,0,0);
    if (ValType(locdealdata.IdentityDeal.DealTime) != V_UNDEF)
       dvndeal.rec.TIME = Time(locdealdata.IdentityDeal.DealTime);
    elif (ValType(locdealdata.IdentityDeal.DealCaptureTime) != V_UNDEF)
       dvndeal.rec.TIME = Time(locdealdata.IdentityDeal.DealCaptureTime);
    end;
    dvndeal.rec.CODE = locdealdata.IdentityDeal.DealID;
    dvndeal.rec.EXTCODE = "";
    if (VALTYPE(locdealdata.IdentityDeal.ExternalID) != V_UNDEF)
       dvndeal.rec.EXTCODE = locdealdata.IdentityDeal.ExternalID;
    end;
    dvndeal.rec.CONTRACTOR = locdeal.rec.CONTR;
    dvnfi.rec.EXECTYPE = 0; //расчетный
    dvndeal.rec.NETTING_PMGR = "X";
    if (locdealdata.DealData.FRADeal.IsDerivative)
       dvndeal.rec.ISPFI = "X";
    end;
    dvndeal.rec.DVKIND = 4;
    dvndeal.rec.STATE = 0;
    dvndeal.rec.DEPARTMENT = 1; //locdeal.rec.FILIAL;
    dvndeal.rec.OPER = {oper};
    dvndeal.rec.AGENT = locdeal.rec.BROKER;
    if (locdeal.rec.CLIENT == 0)
       dvndeal.rec.CLIENT = -1;
    else
       dvndeal.rec.CLIENT = locdeal.rec.CLIENT;
       dvndeal.rec.CLIENTCONTR = GetClientContrID(locdeal.rec.CLIENT);
    end;
    dvndeal.rec.PARENTID = -1;
    dvndeal.rec.GENAGRID = -1;
    dvndeal.rec.KINDDEALPARTYCLIENT = 0;
    if (VALTYPE(locdealdata.IdentityDeal.TSBrief) != V_UNDEF)
       dvndeal.rec.COMMENT = "Торг.площадка:"+locdealdata.IdentityDeal.TSBrief+", ";
    end;
    dvndeal.rec.COMMENT = dvndeal.rec.COMMENT + "Комментарий:"+locdealdata.IdentityDeal.Comment;
    dvndeal.rec.COUNTRY = 165;
    dvndeal.rec.TRADERID = locdeal.rec.TRADER;
    dvndeal.rec.PERIODCLS = 3;
    if ((locdeal.rec.CONTRNAME == "MICX") or (locdeal.rec.CONTRNAME == "MICR"))
       dvndeal.rec.SECTOR = "X";
       dvndeal.rec.MARKETKIND = 2;

      if (locdeal.rec.CLIENT == 0)
         FillMarket(@dvndeal); //dan заполним для собственной сделки схему расчетов с биржей
      end;

    end;
//    dvndeal.rec.BEGINDATE = locdealdata.DealData.FRADeal.ValueDate;
    dvndeal.rec.BEGINDATE = locdealdata.IdentityDeal.DealDate;

    dvnfi.rec.ID = 0;
    dvnfi.rec.DEALID = dvndeal.rec.ID;
    dvnfi.rec.TYPE = 0; //актив по сделке
    dvnfi.rec.FIID = GetFiidByISOCode(locdealdata.DealData.FRADeal.CurrencyDeals,1);
    dvnfi.rec.AMOUNT = abs(locdealdata.DealData.FRADeal.Amount);
    dvnfi.rec.EXECDATE = locdealdata.DealData.FRADeal.MaturityDate;
    dvnfi.rec.EXECTYPE = 0;
    dvnfi.rec.CONTRAMOUNT = 1;
    dvnfi.rec.STDFIID = -1;
    dvnfi.rec.ACCFIID = 0;
    dvnfi.rec.COURSE = 0;
    dvnfi.rec.PERIOD = 3;
    dvnfi.rec.PERIODKIND = 1;
    if( dvndeal.rec.Type == ALG_DV_FIX_FLOAT )
       dvnfi.rec.RATE = locdealdata.DealData.FRADeal.ContractRate;
       dvnfi.rec.RATEID = -1;
       dvnfi.rec.FIXDAYS = 0;
       dvnfi.rec.BASIS = 4;
       dvnfi.rec.CALKINDID = -1;
    else
       dvnfi.rec.RATE = 0;
       dvnfi.rec.RATEID = GetFiidIndex(locdealdata.DealData.FRADeal.RateFloatShortName);
       dvnfi.rec.FIXDAYS = dvndeal.rec.BEGINDATE - locdealdata.DealData.FRADeal.FixDate;
       dvnfi.rec.BASIS = 4;
       dvnfi.rec.CALKINDID = 0;
    end;
    dvnfi.rec.RATEPOINT = 5; /* 20190213 - kva */
    dvnfi.rec.TYPECALC = 2;
    dvnfi.rec.SCALE = 1;

    dvnfi2 = TRecHandler("dvnfi.dbt");
    dvnfi2.rec.ID = 0;
    dvnfi2.rec.DEALID = dvndeal.rec.ID;
    dvnfi2.rec.TYPE = 2; //актив по сделке
    dvnfi2.rec.FIID = GetFiidByISOCode(locdealdata.DealData.FRADeal.CurrencyDeals,1);
    dvnfi2.rec.AMOUNT = abs(locdealdata.DealData.FRADeal.Amount);
    dvnfi2.rec.EXECDATE = locdealdata.DealData.FRADeal.MaturityDate;
    dvnfi2.rec.EXECTYPE = 0;
    dvnfi2.rec.CONTRAMOUNT = 1;
    dvnfi2.rec.STDFIID = -1;
    dvnfi2.rec.ACCFIID = 0;
    dvnfi2.rec.COURSE = 1;
    dvnfi2.rec.PERIOD = 3;
    dvnfi2.rec.PERIODKIND = 1;
    if( dvndeal.rec.Type == ALG_DV_FLOAT_FIX )
       dvnfi2.rec.RATE = locdealdata.DealData.FRADeal.ContractRate;
       dvnfi2.rec.RATEID = -1;
       dvnfi2.rec.FIXDAYS = 0;
       dvnfi2.rec.BASIS = 4;
       dvnfi2.rec.CALKINDID = -1;
    else
       dvnfi2.rec.RATE = 0;
       dvnfi2.rec.RATEID = GetFiidIndex(locdealdata.DealData.FRADeal.RateFloatShortName);
       dvnfi2.rec.FIXDAYS = dvndeal.rec.BEGINDATE - locdealdata.DealData.FRADeal.FixDate;
       dvnfi2.rec.BASIS = 4;
       dvnfi2.rec.CALKINDID = 0;
    end;
    dvnfi2.rec.RATEPOINT = 5; /* 20190213 - kva */
    dvnfi2.rec.TYPECALC = 2;
    dvnfi2.rec.SCALE = 1;

  end;
  
  private macro SetIRSLeg( dvnfi_irs:TRecHandler, NumLeg: integer )
      private var err_txt;
      
      dvnfi_irs.rec.ID = 0;
      dvnfi_irs.rec.DEALID = dvndeal.rec.ID;
      dvnfi_irs.rec.TYPE = 0; //актив по сделке
      dvnfi_irs.rec.FIID = GetFiidCodeByName(locdealdata.DealData.IRSSWAPDeal.PartList[NumLeg].CurrencyCode);
      dvnfi_irs.rec.AMOUNT = abs(locdealdata.DealData.IRSSWAPDeal.PartList[NumLeg].Amount);
      dvnfi_irs.rec.EXECDATE = locdealdata.DealData.IRSSWAPDeal.PartList[NumLeg].DateEnd;
      if (locdealdata.DealData.IRSSWAPDeal.PartList[NumLeg].Instrument == "IRS")
         dvnfi_irs.rec.EXECTYPE = 0; //расчетный
      else
         dvnfi_irs.rec.EXECTYPE = 1;
      end;
      dvnfi_irs.rec.CONTRAMOUNT = 1;
      dvnfi_irs.rec.STDFIID = -1;
      dvnfi_irs.rec.ACCFIID = -1;
      
      if (ValType(locdealdata.DealData.IRSSWAPDeal.PartList[NumLeg].Calculate) != V_UNDEF)
         if (ValType(locdealdata.DealData.IRSSWAPDeal.PartList[NumLeg].Calculate.CallNotice) != V_UNDEF)
            FindPeriodIRSSwap(locdealdata.DealData.IRSSWAPDeal.PartList[NumLeg].Calculate.CallNotice, dvnfi_irs.rec.PERIOD, dvnfi_irs.rec.PERIODKIND); 
         else
            dvnfi_irs.rec.PERIOD = 1;
            dvnfi_irs.rec.PERIODKIND = 4;
         end;
      else
         dvnfi_irs.rec.PERIOD = 1;
         dvnfi_irs.rec.PERIODKIND = 4;
      end;

      if ( locdealdata.DealData.IRSSWAPDeal.PartList[NumLeg].RateType == "Fix" )
         dvnfi_irs.rec.COURSE = 0;
         dvnfi_irs.rec.RATE = locdealdata.DealData.IRSSWAPDeal.PartList[NumLeg].Rate;
         dvnfi_irs.rec.RATEID = -1;
         dvnfi_irs.rec.FIXDAYS = 0;
         dvnfi_irs.rec.BASIS = 4;
         dvnfi_irs.rec.CALKINDID = -1;
         dvnfi_irs.rec.COURSEPOINT = 0;
         dvnfi_irs.rec.RATEPOINT = 4;
      else //Float
         dvnfi_irs.rec.COURSE = 1;
         dvnfi_irs.rec.RATE = 0;
         dvnfi_irs.rec.SPREAD = locdealdata.DealData.IRSSWAPDeal.PartList[NumLeg].RateFloatDev;
         dvnfi_irs.rec.RATEID = GetFiidIndex(locdealdata.DealData.IRSSWAPDeal.PartList[NumLeg].RateFloatType);

/*  Ястребов 07.11.2019

         if (dvnfi_irs.rec.RATEID == -1)
          err_txt = "Не найдена плавающая ставка " + locdealdata.DealData.IRSSWAPDeal.PartList[NumLeg].RateFloatType;  
          RunError(err_txt, c_err_obj(err_txt,-3000));
         end;
*/
         //       dvnfi_irs.rec.RATEINDEX  = 214; //???
         dvnfi_irs.rec.FIXDAYS = -1; 
         dvnfi_irs.rec.BASIS = 4;
         dvnfi_irs.rec.CALKINDID = 0;
         dvnfi_irs.rec.COURSEPOINT = 4;
         dvnfi_irs.rec.RATEPOINT = 0;
         dvnfi_irs.rec.FLOATPOINT = 14;
      end;
      dvnfi_irs.rec.POINT = 2;
      dvnfi_irs.rec.TYPECALC = 2;
      dvnfi_irs.rec.SCALE = 1;
      if ( ValType(locdealdata.DealData.IRSSWAPDeal.PartList[NumLeg].Basis) != V_UNDEF )
         dvnfi_irs.rec.BASIS = RetBasis(locdealdata.DealData.IRSSWAPDeal.PartList[NumLeg].Basis);
      end;
  end;

  private macro CreateIRSCIRSDeal(_Kind)
    var status,rs,sql,exectype;

    dvndeal.rec.ID = 0;
    dvndeal.rec.DOCKIND = BOKINDFWD;
    dvndeal.rec.KIND = _Kind; //вид сделки

    var leg_d, leg_l;
    if (locdealdata.DealData.IRSSWAPDeal.PartList[0].Amount > 0) // требование
      leg_d = 0;
      leg_l = 1;
    else         // обязательство
      leg_l = 0;
      leg_d = 1;
    end;

    //направление сделки
    if (   ( locdealdata.DealData.IRSSWAPDeal.PartList[leg_l].RateType == "Fix" )
       and ( locdealdata.DealData.IRSSWAPDeal.PartList[leg_d].RateType == "Float" ) )
       dvndeal.rec.TYPE = "7"; // Fix\Float
    elif ( ( locdealdata.DealData.IRSSWAPDeal.PartList[leg_l].RateType == "Float" )
       and ( locdealdata.DealData.IRSSWAPDeal.PartList[leg_d].RateType == "Fix" ) )
       dvndeal.rec.TYPE = "8"; // Float\Fix
    elif ( ( locdealdata.DealData.IRSSWAPDeal.PartList[leg_l].RateType == "Fix" )
       and ( locdealdata.DealData.IRSSWAPDeal.PartList[leg_d].RateType == "Fix" ) )
       dvndeal.rec.TYPE = "9"; // Fix\Fix
    elif ( ( locdealdata.DealData.IRSSWAPDeal.PartList[leg_l].RateType == "Float" )
       and ( locdealdata.DealData.IRSSWAPDeal.PartList[leg_d].RateType == "Float" ) )
       dvndeal.rec.TYPE = "10"; // Float\Float
    end;
    //dvndeal.rec.swaptype = 1;
    dvndeal.rec.DATE = locdealdata.IdentityDeal.DealDate; //дата операции
    dvndeal.rec.TIME = Time(0,0,0);
    if (ValType(locdealdata.IdentityDeal.DealTime) != V_UNDEF)
       dvndeal.rec.TIME = Time(locdealdata.IdentityDeal.DealTime);
    end;
    dvndeal.rec.CODE = locdealdata.IdentityDeal.DealID;
    dvndeal.rec.EXTCODE = "";
    if (VALTYPE(locdealdata.IdentityDeal.ExternalID) != V_UNDEF)
       dvndeal.rec.EXTCODE = locdealdata.IdentityDeal.ExternalID;
    end;
    dvndeal.rec.CONTRACTOR = locdeal.rec.CONTR;
    //dvndeal.rec.NETTING_PMGR = "X";
    if (locdealdata.DealData.IRSSWAPDeal.IsDerivative)
       dvndeal.rec.ISPFI = "X";
    end;
    dvndeal.rec.DVKIND = 4;
    dvndeal.rec.STATE = 0;
    dvndeal.rec.DEPARTMENT = 1; //locdeal.rec.FILIAL;
    dvndeal.rec.OPER = {oper};
    dvndeal.rec.AGENT = locdeal.rec.BROKER;
    if (locdeal.rec.CLIENT == 0)
       dvndeal.rec.CLIENT = -1;
    else
       dvndeal.rec.CLIENT = locdeal.rec.CLIENT;
       dvndeal.rec.CLIENTCONTR = GetClientContrID(locdeal.rec.CLIENT);
    end;
    dvndeal.rec.PARENTID = -1;
    dvndeal.rec.GENAGRID = -1;
    dvndeal.rec.KINDDEALPARTYCLIENT = 1;
    if (VALTYPE(locdealdata.IdentityDeal.TSBrief) != V_UNDEF)
       dvndeal.rec.COMMENT = "Торг.площадка:"+locdealdata.IdentityDeal.TSBrief+", ";
    end;
    if (VALTYPE(locdealdata.IdentityDeal.Comment) != V_UNDEF)
        dvndeal.rec.COMMENT = dvndeal.rec.COMMENT + "Комментарий:"+locdealdata.IdentityDeal.Comment;
    end;
    dvndeal.rec.COUNTRY = 165;
    dvndeal.rec.TRADERID = locdeal.rec.TRADER;
    dvndeal.rec.PERIODCLS = 3;
    if ((locdeal.rec.CONTRNAME == "MICX") or (locdeal.rec.CONTRNAME == "MICR"))
       dvndeal.rec.SECTOR = "X";
       dvndeal.rec.MARKETKIND = 2;
      if (locdeal.rec.CLIENT == 0)
         FillMarket(@dvndeal); //dan заполним для собственной сделки схему расчетов с биржей
      end;
    end;

    if (locdealdata.DealData.IRSSWAPDeal.PartList[leg_l].DateBegin !=
        locdealdata.DealData.IRSSWAPDeal.PartList[leg_d].DateBegin)
       err_txt = "Даты начала первой и второй частей сделки различаются. Обработка сделки в СОФР невозможна"; 
       RunError(err_txt, c_err_obj(err_txt,-3000));
    end;
    dvndeal.rec.BEGINDATE = locdealdata.DealData.IRSSWAPDeal.PartList[0].DateBegin;

    SetIRSLeg(dvnfi, leg_l);

    dvnfi2 = TRecHandler("dvnfi.dbt");
    SetIRSLeg(dvnfi2, leg_d);

    if (dvnfi.rec.FIID == dvnfi2.rec.FIID )
      dvndeal.rec.swaptype = 1;  // IRS
    else
      dvndeal.rec.swaptype = 3;  // CIRS
    end;

    if ( (dvnfi.rec.RATEID == 4079) or (dvnfi2.rec.RATEID == 4079) )  // ключевая ставка
      dvndeal.rec.swaptype = 2;  // овернайт
    end;

  end;


  private macro CreateSwapDeal(_Kind, calendID, addCalendId)
    var status,rs,sql,exectype;
    var curba, curka;
    var baseCurr;

    dvndeal.rec.ID = 0;
    dvndeal.rec.KIND = _Kind; //вид сделки
    dvndeal.rec.DOCKIND = BOKINDSWAP;
    if (_kind == 12715)
       dvndeal.rec.DVKIND = 6;
    else
       dvndeal.rec.DVKIND = 3;
    end;
    dvndeal.rec.PERIODCLS = 3;

    // 2020-04-17 Cherednichenko Для валютного свопа используем календари валюты
    curba = GetFiidByISOCode(substr(locdealdata.DealData.CurrencySWAPDeal.PairsName,1,3),1);
    curka = GetFiidByISOCode(substr(locdealdata.DealData.CurrencySWAPDeal.PairsName,5,3),1);

    /*PNV*/
    if (locdeal.rec.CONTR == ID_NKC) /*биржа*/
        dvndeal.rec.PERIODCLS = DL_GetNumWorkDaysForPeriod(locdealdata.IdentityDeal.DealDate,
                                                       locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].Payments.ValueDate1,
                                                       -1,-1, -1, true, calendID, addCalendId);
    else
         dvndeal.rec.PERIODCLS = DL_GetNumWorkDaysForPeriod(locdealdata.IdentityDeal.DealDate,
                                                       min(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].Payments.ValueDate1, locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].Payments.ValueDate2),
                                                       -1, -1, /*locdeal.rec.CONTR*/-1, true, calendID, addCalendId); 
    end;
    /*PNV*/

// 2020-07-29 Cherednichenko базовая валюта та, где равна асболютная величина ammount(1/2). при необходимости меняем тип ноги в СОФР is:513473
    baseCurr = 0;
    if ( abs(locdealdata.DealData.CurrencySWAPDeal.legsdealslist[0].payments.amount1) != 
         abs(locdealdata.DealData.CurrencySWAPDeal.legsdealslist[1].payments.amount1) ) // если базовая валюта не певая в PairsName
      baseCurr = 1;
    end;

    if (dvndeal.rec.PERIODCLS > 2)
       dvndeal.rec.PERIODCLS = 3;
    end;
    //направление сделки
// 2020-07-29 Cherednichenko направление зависит от базовой валюты
/*
    if   ( locdealdata.IdentityDeal.BuySell == "Buy" )
       dvndeal.rec.TYPE = "5"; // Покупка
    else
       dvndeal.rec.TYPE = "6"; // Покупка
    end;
*/
    if (baseCurr == 0)
      if   ( locdealdata.IdentityDeal.BuySell == "Buy" )
         dvndeal.rec.TYPE = "5"; // Покупка
      elif ( locdealdata.IdentityDeal.BuySell == "Sell" )
         dvndeal.rec.TYPE = "6"; //Продажа
      end;
    else
      if   ( locdealdata.IdentityDeal.BuySell == "Buy" )
         dvndeal.rec.TYPE = "6"; // Покупка
      elif ( locdealdata.IdentityDeal.BuySell == "Sell" )
         dvndeal.rec.TYPE = "5"; //Продажа
      end;
    end;


    dvndeal.rec.DATE = locdealdata.IdentityDeal.DealDate; //дата операции
    dvndeal.rec.BeginDATE = locdealdata.IdentityDeal.DealDate; //gtv: для неттинга

    dvndeal.rec.TIME = Time(0,0,0);
    if (ValType(locdealdata.IdentityDeal.DealTime) != V_UNDEF)
       dvndeal.rec.TIME = Time(locdealdata.IdentityDeal.DealTime);
    end;
    dvndeal.rec.CODE = locdealdata.IdentityDeal.DealID;
    dvndeal.rec.EXTCODE = "";
    if (VALTYPE(locdealdata.IdentityDeal.ExternalID) != V_UNDEF)
       dvndeal.rec.EXTCODE = locdealdata.IdentityDeal.ExternalID;
    end;
    dvndeal.rec.CONTRACTOR = locdeal.rec.CONTR;
    /*if (locdealdata.DealData.CurrencySWAPDeal.IsDerivative != false)
       dvndeal.rec.ISPFI = "X";
    end;*/
    dvndeal.rec.ISPFI = "X";
    dvndeal.rec.STATE = 0;
    dvndeal.rec.DEPARTMENT = 1; //locdeal.rec.FILIAL;
    dvndeal.rec.OPER = {oper};
    dvndeal.rec.AGENT = locdeal.rec.BROKER;
    if (locdeal.rec.CLIENT == 0)
       dvndeal.rec.CLIENT = -1;
    else
       dvndeal.rec.CLIENT = locdeal.rec.CLIENT;
       dvndeal.rec.CLIENTCONTR = GetClientContrID(locdeal.rec.CLIENT);
    end;
    dvndeal.rec.PARENTID = -1;
    dvndeal.rec.GENAGRID = -1;
    dvndeal.rec.KINDDEALPARTYCLIENT = 0;
    if (VALTYPE(locdealdata.IdentityDeal.TSBrief) != V_UNDEF)
       dvndeal.rec.COMMENT = "Торг.площадка:"+locdealdata.IdentityDeal.TSBrief+", ";
    end;
    dvndeal.rec.COMMENT = dvndeal.rec.COMMENT + "Комментарий:"+locdealdata.IdentityDeal.Comment;
    dvndeal.rec.COUNTRY = 165;
    dvndeal.rec.TRADERID = locdeal.rec.TRADER;
    if ((locdeal.rec.CONTRNAME == "MICX") or (locdeal.rec.CONTRNAME == "MICR"))
       dvndeal.rec.SECTOR = "X";
       dvndeal.rec.MARKETKIND = 2;
      if (locdeal.rec.CLIENT == 0)
         FillMarket(@dvndeal); //dan заполним для собственной сделки схему расчетов с биржей
      end;

    end;

    dvnfi.rec.ID = 0;
    dvnfi.rec.DEALID = dvndeal.rec.ID;
    if (baseCurr == 0) //актив по сделке
      dvnfi.rec.TYPE = 0;
    else
      dvnfi.rec.TYPE = 2;
    end;
    if (baseCurr == 0)
      if (VALTYPE(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].PrecMetal) != V_UNDEF)
        dvnfi.rec.FIID = GetFiidByISOCode(substr(locdealdata.DealData.CurrencySWAPDeal.PairsName,1,3),6);
      else
        dvnfi.rec.FIID = GetFiidByISOCode(substr(locdealdata.DealData.CurrencySWAPDeal.PairsName,1,3),1);
      end;
      dvnfi.rec.PRICEFIID = GetFiidByISOCode(substr(locdealdata.DealData.CurrencySWAPDeal.PairsName,5,3),1);
      dvnfi.rec.AMOUNT = abs(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].Payments.Amount1);
      dvnfi.rec.COST = abs(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].Payments.Amount2);
//shev это не верно, в теме 518712 были перепутаны курсы кондором, из-за этого все сделки своп сейчас грузятся не верно
      dvnfi.rec.PRICE = abs(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].Rate); // 2020-11-20 Cherednichenko is 518712
      if ((VALTYPE(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].RateDirection) != V_UNDEF) and
          (locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].RateDirection == "I"))
         dvnfi.rec.ISINVERSE = "X";
      end;

    else
      if (VALTYPE(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].PrecMetal) != V_UNDEF)
        dvnfi.rec.FIID = GetFiidByISOCode(substr(locdealdata.DealData.CurrencySWAPDeal.PairsName,5,3),6);
      else
        dvnfi.rec.FIID = GetFiidByISOCode(substr(locdealdata.DealData.CurrencySWAPDeal.PairsName,5,3),1);
      end;
      dvnfi.rec.PRICEFIID = GetFiidByISOCode(substr(locdealdata.DealData.CurrencySWAPDeal.PairsName,1,3),1);
      dvnfi.rec.AMOUNT = abs(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].Payments.Amount2);
      dvnfi.rec.COST = abs(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].Payments.Amount1);
//shev это не верно, в теме 518712 были перепутаны курсы кондором, из-за этого все сделки своп сейчас грузятся не верно
//      dvnfi.rec.PRICE = abs(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].Rate); // 2020-11-20 Cherednichenko is 518712
      dvnfi.rec.PRICE = abs(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].Rate); 
      if ((VALTYPE(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].RateDirection) == V_UNDEF) or
          (locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].RateDirection != "I"))
         dvnfi.rec.ISINVERSE = "X";
      end;
 
   end;
    dvnfi.rec.EXECDATE = locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].Payments.ValueDate2;
    dvnfi.rec.EXECTYPE = 1; //Поставочный
    dvnfi.rec.PAYDATE = locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].Payments.ValueDate2;
    dvnfi.rec.SUPLDATE = locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].Payments.ValueDate1;
    dvnfi.rec.POINT = GetPoints(dvnfi.rec.PRICE);
    if (ValType(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].RateQutationUnit) != V_UNDEF)
       if (locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].RateQutationUnit > dvnfi.rec.POINT)
          dvnfi.rec.POINT = locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].RateQutationUnit;//количество символов после запятой для PRICE       
       end;
    end;
    /*if (dvnfi.rec.POINT == 0)
       dvnfi.rec.POINT = GetPoints(dvnfi.rec.PRICE);
    end;*/
    dvnfi.rec.CONTRAMOUNT = 1;
    dvnfi.rec.STDFIID = -1;
    dvnfi.rec.ACCFIID = -1;
    dvnfi.rec.RATEID = -1;
    dvnfi.rec.CALKINDID = -1;
    dvnfi.rec.SCALE = 1;
/* 2021-02-03 Cherednichenko is522812 Переносим выше, в проверки перевернутости сделки
    if ((VALTYPE(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].RateDirection) != V_UNDEF) and
        (locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].RateDirection == "I"))
       dvnfi.rec.ISINVERSE = "X";
    end;
*/
    if (locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].Netting)
       dvndeal.rec.NETTING = "X";
    end;
 
    dvnfi2 = TRecHandler("dvnfi.dbt");
    dvnfi2.rec.ID = 0;
    dvnfi2.rec.DEALID = dvndeal.rec.ID;
    if (baseCurr == 0) //актив по сделке
      if (VALTYPE(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].PrecMetal) != V_UNDEF)
         dvnfi2.rec.FIID = GetFiidByISOCode(substr(locdealdata.DealData.CurrencySWAPDeal.PairsName,1,3),6);
      else
         dvnfi2.rec.FIID = GetFiidByISOCode(substr(locdealdata.DealData.CurrencySWAPDeal.PairsName,1,3),1);
      end;
      dvnfi2.rec.PRICEFIID = GetFiidByISOCode(substr(locdealdata.DealData.CurrencySWAPDeal.PairsName,5,3),1);
      dvnfi.rec.TYPE = 2; //актив по 2 части сделки
      dvnfi2.rec.AMOUNT = abs(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].Payments.Amount1);
      dvnfi2.rec.COST = abs(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].Payments.Amount2);
      dvnfi2.rec.PRICE = abs(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].Rate); // 2020-11-20 Cherednichenko is 518712
      if ((VALTYPE(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].RateDirection) != V_UNDEF) and
          (locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].RateDirection == "I"))
         dvnfi2.rec.ISINVERSE = "X";
      end;
    else
      if (VALTYPE(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].PrecMetal) != V_UNDEF)
         dvnfi2.rec.FIID = GetFiidByISOCode(substr(locdealdata.DealData.CurrencySWAPDeal.PairsName,5,3),6);
      else
         dvnfi2.rec.FIID = GetFiidByISOCode(substr(locdealdata.DealData.CurrencySWAPDeal.PairsName,5,3),1);
      end;
      dvnfi2.rec.PRICEFIID = GetFiidByISOCode(substr(locdealdata.DealData.CurrencySWAPDeal.PairsName,1,3),1);
      dvnfi.rec.TYPE = 0;
      dvnfi2.rec.AMOUNT = abs(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].Payments.Amount2);
      dvnfi2.rec.COST = abs(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].Payments.Amount1);
      dvnfi2.rec.PRICE = abs(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].Rate); 
      if ((VALTYPE(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].RateDirection) == V_UNDEF) or
          (locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].RateDirection != "I"))
         dvnfi2.rec.ISINVERSE = "X";
      end;
    end;
    dvnfi2.rec.EXECDATE = locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].Payments.ValueDate2;
    dvnfi2.rec.EXECTYPE = 1; //Поставочный
    dvnfi2.rec.PAYDATE = locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].Payments.ValueDate2;
    dvnfi2.rec.SUPLDATE = locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].Payments.ValueDate1;
    dvnfi2.rec.POINT = GetPoints(dvnfi2.rec.PRICE);
    if (ValType(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].RateQutationUnit) != V_UNDEF)
       if (locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].RateQutationUnit > dvnfi2.rec.POINT)
          dvnfi2.rec.POINT = locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].RateQutationUnit;//количество символов после запятой для PRICE       
       end;
    end;
/*    if (dvnfi2.rec.POINT == 0)
       dvnfi2.rec.POINT = GetPoints(dvnfi2.rec.PRICE);
    end;*/
    dvnfi2.rec.CONTRAMOUNT = 1;
    dvnfi2.rec.STDFIID = -1;
    dvnfi2.rec.ACCFIID = -1;
    dvnfi2.rec.RATEID = -1;
    dvnfi2.rec.CALKINDID = -1;
    dvnfi2.rec.SCALE = 1;
/* 2021-02-03 Cherednichenko is522812 Переносим выше, в проверки перевернутости сделки
    if ((VALTYPE(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].RateDirection) != V_UNDEF) and
        (locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].RateDirection == "I"))
       dvnfi2.rec.ISINVERSE = "X";
    end;
*/
    if (locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].Netting)
       dvndeal.rec.NETTING2 = "X";
    end;

    // выравниваем точность на обеих ногах
    if (dvnfi2.rec.POINT > dvnfi.rec.POINT)
        dvnfi.rec.POINT = dvnfi2.rec.POINT;
    end;
    if (dvnfi.rec.POINT > dvnfi2.rec.POINT)
        dvnfi2.rec.POINT = dvnfi.rec.POINT;
    end;


  end;

  private macro GetWorkDays( datbeg, datba, datka, curba, curka)
    var sql, rs, ofcal=0, d1, d2, strcal="", country, numday;
    //2
    if ((datbeg == datba) and (datbeg == datka))
       return 0; //T0
    end;
    //3.1
    sql = "select RSI_DLCALENDARS.GetOfficialCalendar() from dual"; 
    rs = ExecSqlSelect(sql, null, false);
    if (rs.MoveNext()) 
       ofcal = rs.value(0);
    end;
    strcal=string(ofcal:0:0);
    //3.2
    sql = "select t_nrcountry from dparty_dbt where t_partyid = "+locdeal.rec.CONTR; 
    rs = ExecSqlSelect(sql, null, false);
    if (rs.MoveNext()) 
       country = rs.value(0);
    end;
    sql = "select t_calendarid from dcalcor_dbt where t_objecttype=5 and t_object = :1"; 
    rs = ExecSqlSelect(sql, MakeArray(SqlParam("1",country)), false);
    if (rs.MoveNext()) 
       strcal = strcal + "," + string(rs.value(0));
    end;
    sql = "select t_calendarid from dcalcor_dbt where t_objecttype=2 and to_number(t_object) = :1"; 
    rs = ExecSqlSelect(sql, MakeArray(SqlParam("1",curba)), false);
    if (rs.MoveNext()) 
       strcal = strcal + "," + string(rs.value(0));
    end;
    sql = "select t_calendarid from dcalcor_dbt where t_objecttype=2 and to_number(t_object) = :1"; 
    rs = ExecSqlSelect(sql, MakeArray(SqlParam("1",curka)), false);
    if (rs.MoveNext()) 
       strcal = strcal + "," + string(rs.value(0));
    end;
    //3.3
    d1=datbeg;
    if (datba>datka)
       d2=datba;
    else
       d2=datka;
    end;
    sql = "select RSI_DLCALENDARS.GetNumWorkDaysForPeriod(:1, :2, :3) from dual"; 
    rs = ExecSqlSelect(sql, MakeArray(SqlParam("1",d1),SqlParam("2",d2),SqlParam("3",strcal)), false);
    if (rs.MoveNext()) 
       numday = int(rs.value(0)) - 1;
    end;
    //4
    return numday;
  end;


  private macro CreateOptionDeal(_Kind)
    var status,rs,sql,exectype;
    var bonuspoint;
    var err_rud;

    dvndeal.rec.ID = 0;
    dvndeal.rec.DOCKIND = BOKINDFWD;
    dvndeal.rec.KIND = _Kind; //вид сделки
    //направление сделки
    if   ( locdealdata.IdentityDeal.BuySell == "Buy" )
       dvndeal.rec.TYPE = "1"; // Покупка
    elif ( locdealdata.IdentityDeal.BuySell == "Sell" )
       dvndeal.rec.TYPE = "2"; //Продажа
    end;
    dvndeal.rec.DATE = locdealdata.IdentityDeal.DealDate; //дата операции
    dvndeal.rec.TIME = Time(0,0,0);
    if (ValType(locdealdata.IdentityDeal.DealTime) != V_UNDEF)
       dvndeal.rec.TIME = Time(locdealdata.IdentityDeal.DealTime);
    end;
    dvndeal.rec.CODE = locdealdata.IdentityDeal.DealID;
    dvndeal.rec.EXTCODE = "";
    if (VALTYPE(locdealdata.IdentityDeal.ExternalID) != V_UNDEF)
       dvndeal.rec.EXTCODE = locdealdata.IdentityDeal.ExternalID;
    end;
    dvndeal.rec.CONTRACTOR = locdeal.rec.CONTR;
    if (locdealdata.DealData.CurrencyOptionDeal.IsDerivative)
       dvndeal.rec.ISPFI = "X";
    end;
    dvndeal.rec.DVKIND = 2;
    dvndeal.rec.STATE = 0;
    dvndeal.rec.DEPARTMENT = 1; //locdeal.rec.FILIAL;
    dvndeal.rec.OPER = {oper};
    dvndeal.rec.AGENT = locdeal.rec.BROKER;
    if (locdeal.rec.CLIENT == 0)
       dvndeal.rec.CLIENT = -1;
    else
       dvndeal.rec.CLIENT = locdeal.rec.CLIENT;
       dvndeal.rec.CLIENTCONTR = GetClientContrID(locdeal.rec.CLIENT);
    end;
    dvndeal.rec.PARENTID = -1;
    //dvndeal.rec.GENAGRID = -1;
    dvndeal.rec.KINDDEALPARTYCLIENT = -1;
    if (VALTYPE(locdealdata.IdentityDeal.TSBrief) != V_UNDEF)
       dvndeal.rec.COMMENT = "Торг.площадка:"+locdealdata.IdentityDeal.TSBrief+", ";
    end;
    if (VALTYPE(locdealdata.IdentityDeal.Comment) != V_UNDEF)
        dvndeal.rec.COMMENT = dvndeal.rec.COMMENT + "Комментарий:"+locdealdata.IdentityDeal.Comment;
    end;
    dvndeal.rec.COUNTRY = 165;
    dvndeal.rec.TRADERID = locdeal.rec.TRADER;
    dvndeal.rec.PERIODCLS = 3;
    if ((locdeal.rec.CONTRNAME == "MICX") or (locdeal.rec.CONTRNAME == "MICR"))
       dvndeal.rec.SECTOR = "X";
       dvndeal.rec.MARKETKIND = 2;
      if (locdeal.rec.CLIENT == 0)
         FillMarket(@dvndeal); //dan заполним для собственной сделки схему расчетов с биржей
      end;

    end;
    if ( (locdealdata.DealData.CurrencyOptionDeal.OptType == "FX") or (locdealdata.DealData.CurrencyOptionDeal.OptType == "OTC") )    
      if (locdealdata.DealData.CurrencyOptionDeal.OptionType == "Put")
         dvndeal.rec.OptionType = 1;
      else 
         dvndeal.rec.OptionType = 2; //Call
      end;
      if (ValType(locdealdata.DealData.CurrencyOptionDeal.ExerciseType) != V_UNDEF)
        if (locdealdata.DealData.CurrencyOptionDeal.ExerciseType == "European")
           dvndeal.rec.OptionStyle = 2;
        else
           dvndeal.rec.OptionStyle = 1; //American
        end;
      end;
    else // CAP
        if (locdealdata.DealData.CurrencyOptionDeal.OptionType == "Floor")
           dvndeal.rec.OptionType = 1; //Put
        else  //Cap
           dvndeal.rec.OptionType = 2; //Call
        end;
    end;

    dvndeal.rec.BonusDate = locdealdata.DealData.CurrencyOptionDeal.BonusDate;
    dvndeal.rec.Instance = 0; //??
    dvndeal.rec.ChangeKind = 0;  //??
    dvndeal.rec.BEGINDATE = locdealdata.IdentityDeal.DealDate;

    dvnfi.rec.ID = 0;
    dvnfi.rec.DEALID = dvndeal.rec.ID;
    dvnfi.rec.TYPE = 0; //актив по сделке

    dvnfi.rec.EXECDATE = locdealdata.DealData.CurrencyOptionDeal.MaturityDate;
    if (VALTYPE(locdealdata.DealData.CurrencyOptionDeal.ExecMethod) != V_UNDEF)
       if (locdealdata.DealData.CurrencyOptionDeal.ExecMethod=="Delivery")
          dvnfi.rec.EXECTYPE = 1;
       else
          dvnfi.rec.EXECTYPE = 0;
       end;
    end;
    dvnfi.rec.PAYDATE = locdealdata.DealData.CurrencyOptionDeal.MaturityDate;
    //dvnfi.rec.EXPIRYDATE = locdealdata.dealdata.currencyoptiondeal.fixdate; //shev 24/09/20 isup  516221 locdealdata.DealData.CurrencyOptionDeal.MaturityDate;
    dvnfi.rec.EXPIRYDATE = locdealdata.DealData.CurrencyOptionDeal.MaturityDate; /*PNV DEF-15170 вернули обратно*/
    dvnfi.rec.SUPLDATE = locdealdata.DealData.CurrencyOptionDeal.MaturityDate;

    if (locdealdata.DealData.CurrencyOptionDeal.OptType == "FX")
       dvnfi.rec.FIID = GetFiidCodeByName((locdealdata.DealData.CurrencyOptionDeal.BaseCurr));
       if (ValType(locdealdata.DealData.CurrencyOptionDeal.BaseAmount) != V_UNDEF)
           dvnfi.rec.AMOUNT = abs(locdealdata.DealData.CurrencyOptionDeal.BaseAmount);
       end;
       if (ValType(locdealdata.DealData.CurrencyOptionDeal.CounterAmount) != V_UNDEF)
           dvnfi.rec.COST = abs(locdealdata.DealData.CurrencyOptionDeal.CounterAmount);
       end;
       if (ValType(locdealdata.DealData.CurrencyOptionDeal.Strike) != V_UNDEF)
           dvnfi.rec.PRICE = abs(locdealdata.DealData.CurrencyOptionDeal.Strike);
       end;
       if (ValType(locdealdata.DealData.CurrencyOptionDeal.PairsName) != V_UNDEF)
           dvnfi.rec.PRICEFIID = GetFiidCodeByName(substr(locdealdata.DealData.CurrencyOptionDeal.PairsName,5,3));
       end;
       if (ValType(locdealdata.DealData.CurrencyOptionDeal.BonusAmount) != V_UNDEF)
           dvndeal.rec.Bonus = locdealdata.DealData.CurrencyOptionDeal.BonusAmount;
       end;
       if (ValType(locdealdata.DealData.CurrencyOptionDeal.BonusCurr) != V_UNDEF)
           dvndeal.rec.BonusFiid = GetFiidCodeByName(locdealdata.DealData.CurrencyOptionDeal.BonusCurr);
       end;

       dvnfi.rec.POINT = GetPoints(dvnfi.rec.PRICE); //количество символов после запятой для PRICE       

       bonuspoint = dvnfi.rec.POINT;
       if (ValType(locdealdata.DealData.CurrencyOptionDeal.PremiumProc) != V_UNDEF)
           dvndeal.rec.BonusPrice = locdealdata.DealData.CurrencyOptionDeal.PremiumProc; 
           bonuspoint = GetPoints(dvndeal.rec.BonusPrice);
       end;
       if (bonuspoint > dvnfi.rec.POINT)
           dvnfi.rec.POINT = bonuspoint;
       end;

    elif (locdealdata.DealData.CurrencyOptionDeal.OptType == "OTC")
       if (Valtype(locdealdata.DealData.CurrencyOptionDeal.Underlying) != V_UNDEF)
          if (locdealdata.DealData.CurrencyOptionDeal.Underlying == 1) // акция
             dvnfi.rec.FIID = GetFinIndex(locdealdata.DealData.CurrencyOptionDeal.EqInd.Equity.ISINEq);
             if (dvnfi.rec.FIID == -1)
                if( SOFR_LoadRuDataByID( StrUpr(locdealdata.DealData.CurrencyOptionDeal.EqInd.Equity.ISINEq), 1, @err_rud )  )
                   dvnfi.rec.FIID = GetFinIndex(locdealdata.DealData.CurrencyOptionDeal.EqInd.Equity.ISINEq);
                else
                   err_txt = "Ценная бумага с кодом " + locdealdata.DealData.CurrencyOptionDeal.EqInd.Equity.ISINEq + " не загружена."+err_rud;  
                   RunError(err_txt, c_err_obj(err_txt,-3000));
                end;
             end;
          else  // индекс
             dvnfi.rec.FIID = GetFiidIndex(locdealdata.DealData.CurrencyOptionDeal.EqInd.EqIndName);
             if (dvnfi.rec.FIID == -1)
                err_txt = "Ошибка. В СОФР не найдена плавающая ставка - " + locdealdata.DealData.CurrencyOptionDeal.EqInd.EqIndName;  
                RunError(err_txt, c_err_obj(err_txt,-3000));
             end;
          end;
          if (ValType(locdealdata.DealData.CurrencyOptionDeal.Quantity) != V_UNDEF)
              dvnfi.rec.AMOUNT = abs(locdealdata.DealData.CurrencyOptionDeal.Quantity);
          end;
          if (ValType(locdealdata.DealData.CurrencyOptionDeal.UnderPrice) != V_UNDEF)
              dvnfi.rec.PRICE = abs(locdealdata.DealData.CurrencyOptionDeal.UnderPrice);
          end;
          if (ValType(locdealdata.DealData.CurrencyOptionDeal.EqInd.CurrencyEqInd) != V_UNDEF)
              dvnfi.rec.PRICEFIID = GetFiidCodeByName(locdealdata.DealData.CurrencyOptionDeal.EqInd.CurrencyEqInd);
          end;

          if (ValType(locdealdata.DealData.CurrencyOptionDeal.BonusAmount) != V_UNDEF)
              dvndeal.rec.Bonus = locdealdata.DealData.CurrencyOptionDeal.BonusAmount;
          end;
          if (ValType(locdealdata.DealData.CurrencyOptionDeal.BonusCurr) != V_UNDEF)
              dvndeal.rec.BonusFiid = GetFiidCodeByName(locdealdata.DealData.CurrencyOptionDeal.BonusCurr);
          end;

          dvnfi.rec.POINT = GetPoints(dvnfi.rec.PRICE); //количество символов после запятой для PRICE    
          if (ValType(locdealdata.DealData.CurrencyOptionDeal.SettlementDate) != V_UNDEF)
            dvnfi.rec.SUPLDATE = locdealdata.DealData.CurrencyOptionDeal.SettlementDate;
          end;
          bonuspoint = dvnfi.rec.POINT;
          if (ValType(locdealdata.DealData.CurrencyOptionDeal.PremiumProc) != V_UNDEF)
              dvndeal.rec.BonusPrice = locdealdata.DealData.CurrencyOptionDeal.PremiumProc; 
              bonuspoint = GetPoints(dvndeal.rec.BonusPrice);
          end;
          if (bonuspoint > dvnfi.rec.POINT)
              dvnfi.rec.POINT = bonuspoint;
          end;
       else
          err_txt = "Не задан Underlying для опциона OTC";  
          RunError(err_txt, c_err_obj(err_txt,-3000));
       end;
    elif (locdealdata.DealData.CurrencyOptionDeal.OptType == "CAP")
       if (Valtype(locdealdata.DealData.CurrencyOptionDeal.RateFloatShortName) != V_UNDEF)
          dvnfi.rec.FIID = GetFiidIndex(locdealdata.DealData.CurrencyOptionDeal.RateFloatShortName);
          if (dvnfi.rec.FIID == -1)
             err_txt = "Ошибка. В СОФР не найден индекс - " + locdealdata.DealData.CurrencyOptionDeal.RateFloatShortName;  
             RunError(err_txt, c_err_obj(err_txt,-3000));
          end;
          if (ValType(locdealdata.DealData.CurrencyOptionDeal.Strike) != V_UNDEF)
              dvnfi.rec.AMOUNT = abs(locdealdata.DealData.CurrencyOptionDeal.BaseAmount);
          end;
          if (ValType(locdealdata.DealData.CurrencyOptionDeal.Strike) != V_UNDEF)
              dvnfi.rec.PRICE = abs(locdealdata.DealData.CurrencyOptionDeal.Strike);
          end;
          if (ValType(locdealdata.DealData.CurrencyOptionDeal.Currency) != V_UNDEF)
              dvnfi.rec.PRICEFIID = GetFiidCodeByName(locdealdata.DealData.CurrencyOptionDeal.Currency);
          end;

          dvnfi.rec.POINT = GetPoints(dvnfi.rec.PRICE); //количество символов после запятой для PRICE       

       else
          err_txt = "Не задан RateFloatShortName для опциона CAP";  
          RunError(err_txt, c_err_obj(err_txt,-3000));
       end;

    end;
   /*PNV 522878*/
    if ((dvnfi.rec.PRICEFIID != 0) and (dvnfi.rec.FIID != 0))/*валюта-валюта*/
        dvnfi.rec.EXECTIME = "10:00:00";
    else
        dvnfi.rec.EXECTIME = "12:30:00";
    end;
/*PNV 522878*/
    dvnfi.rec.CONTRAMOUNT = 1;
    dvnfi.rec.STDFIID = -1;
    dvnfi.rec.ACCFIID = -1;
    dvnfi.rec.RATEID = 0;
    dvnfi.rec.CALKINDID = 0;
    dvnfi.rec.SCALE = 1;
  end;
  
  private macro CreateSWAPOptionDeal(_Kind)
    var status,rs,sql,exectype;
    var bonuspoint;
    var err_rud;

    dvndeal.rec.ID = 0;
    dvndeal.rec.DOCKIND = BOKINDFWD;
    dvndeal.rec.KIND = _Kind; //вид сделки
    //направление сделки
    if   ( locdealdata.IdentityDeal.BuySell == "Buy" )
       dvndeal.rec.TYPE = "1"; // Покупка
    elif ( locdealdata.IdentityDeal.BuySell == "Sell" )
       dvndeal.rec.TYPE = "2"; //Продажа
    end;
    dvndeal.rec.DATE = locdealdata.IdentityDeal.DealDate; //дата операции
    dvndeal.rec.TIME = Time(0,0,0);
    if (ValType(locdealdata.IdentityDeal.DealTime) != V_UNDEF)
       dvndeal.rec.TIME = Time(locdealdata.IdentityDeal.DealTime);
    end;
    dvndeal.rec.CODE = locdealdata.IdentityDeal.DealID;
    dvndeal.rec.EXTCODE = "";
    if (VALTYPE(locdealdata.IdentityDeal.ExternalID) != V_UNDEF)
       dvndeal.rec.EXTCODE = locdealdata.IdentityDeal.ExternalID;
    end;
    dvndeal.rec.CONTRACTOR = locdeal.rec.CONTR;
    if (locdealdata.DealData.CurrencySWAPOptionDeal.IsDerivative)
       dvndeal.rec.ISPFI = "X";
    end;
    dvndeal.rec.DVKIND = 2;
    dvndeal.rec.STATE = 0;
    dvndeal.rec.DEPARTMENT = 1; //locdeal.rec.FILIAL;
    dvndeal.rec.OPER = {oper};
    dvndeal.rec.AGENT = locdeal.rec.BROKER;
    if (locdeal.rec.CLIENT == 0)
       dvndeal.rec.CLIENT = -1;
    else
       dvndeal.rec.CLIENT = locdeal.rec.CLIENT;
       dvndeal.rec.CLIENTCONTR = GetClientContrID(locdeal.rec.CLIENT);
    end;
    dvndeal.rec.PARENTID = -1;
    //dvndeal.rec.GENAGRID = -1;
    dvndeal.rec.KINDDEALPARTYCLIENT = -1;
    if (VALTYPE(locdealdata.IdentityDeal.TSBrief) != V_UNDEF)
       dvndeal.rec.COMMENT = "Торг.площадка:"+locdealdata.IdentityDeal.TSBrief+", ";
    end;
    if (VALTYPE(locdealdata.IdentityDeal.Comment) != V_UNDEF)
        dvndeal.rec.COMMENT = dvndeal.rec.COMMENT + "Комментарий:"+locdealdata.IdentityDeal.Comment;
    end;
    dvndeal.rec.COUNTRY = 165;
    dvndeal.rec.TRADERID = locdeal.rec.TRADER;
    dvndeal.rec.PERIODCLS = 3;
    if ((locdeal.rec.CONTRNAME == "MICX") or (locdeal.rec.CONTRNAME == "MICR"))
       dvndeal.rec.SECTOR = "X";
       dvndeal.rec.MARKETKIND = 2;
      if (locdeal.rec.CLIENT == 0)
         FillMarket(@dvndeal); //dan заполним для собственной сделки схему расчетов с биржей
      end;

    end;
    if ( (locdealdata.DealData.CurrencySWAPOptionDeal.OptType == "FX") or (locdealdata.DealData.CurrencySWAPOptionDeal.OptType == "OTC") )    
      if (locdealdata.DealData.CurrencySWAPOptionDeal.OptionType == "Put")
         dvndeal.rec.OptionType = 1;
      else 
         dvndeal.rec.OptionType = 2; //Call
      end;
      if (ValType(locdealdata.DealData.CurrencySWAPOptionDeal.ExerciseType) != V_UNDEF)
        if (locdealdata.DealData.CurrencySWAPOptionDeal.ExerciseType == "European")
           dvndeal.rec.OptionStyle = 2;
        else
           dvndeal.rec.OptionStyle = 1; //American
        end;
      end;
    else // CAP
        if (locdealdata.DealData.CurrencySWAPOptionDeal.OptionType == "Floor")
           dvndeal.rec.OptionType = 1; //Put
        else  //Cap
           dvndeal.rec.OptionType = 2; //Call
        end;
    end;

    dvndeal.rec.BonusDate = locdealdata.DealData.CurrencySWAPOptionDeal.BonusDate;
    dvndeal.rec.Instance = 0; //??
    dvndeal.rec.ChangeKind = 0;  //??
    dvndeal.rec.BEGINDATE = locdealdata.IdentityDeal.DealDate;

    dvnfi.rec.ID = 0;
    dvnfi.rec.DEALID = dvndeal.rec.ID;
    dvnfi.rec.TYPE = 0; //актив по сделке

    dvnfi.rec.EXECDATE = locdealdata.DealData.CurrencySWAPOptionDeal.MaturityDate;
    dvnfi.rec.EXECTYPE = 1;
    dvnfi.rec.PAYDATE = locdealdata.DealData.CurrencySWAPOptionDeal.MaturityDate;
    dvnfi.rec.EXPIRYDATE = locdealdata.DealData.CurrencySWAPOptionDeal.MaturityDate;
    dvnfi.rec.SUPLDATE = locdealdata.DealData.CurrencySWAPOptionDeal.MaturityDate;

    dvnfi.rec.FIID = GetFiidCodeByName((locdealdata.DealData.CurrencySWAPOptionDeal.Currency));
    dvnfi.rec.PRICEFIID = dvnfi.rec.FIID;

    if (ValType(locdealdata.DealData.CurrencySWAPOptionDeal.BaseAmount) != V_UNDEF)
        dvnfi.rec.AMOUNT = abs(locdealdata.DealData.CurrencySWAPOptionDeal.BaseAmount);
    end;
    if (ValType(locdealdata.DealData.CurrencySWAPOptionDeal.Strike) != V_UNDEF)
        dvnfi.rec.PRICE = abs(locdealdata.DealData.CurrencySWAPOptionDeal.Strike);
    end;
    dvnfi.rec.POINT = GetPoints(dvnfi.rec.PRICE); //количество символов после запятой для PRICE       

    bonuspoint = dvnfi.rec.POINT;
    if (ValType(locdealdata.DealData.CurrencySWAPOptionDeal.PremiumProc) != V_UNDEF)
        dvndeal.rec.BonusPrice = locdealdata.DealData.CurrencySWAPOptionDeal.PremiumProc; 
        bonuspoint = GetPoints(dvndeal.rec.BonusPrice);
    end;
    if (bonuspoint > dvnfi.rec.POINT)
        dvnfi.rec.POINT = bonuspoint;
    end;

    dvnfi.rec.CONTRAMOUNT = 1;
    dvnfi.rec.STDFIID = -1;
    dvnfi.rec.ACCFIID = -1;
    dvnfi.rec.RATEID = 0;
    dvnfi.rec.CALKINDID = 0;
    dvnfi.rec.SCALE = 1;
  end;


  private macro CreateMMDeal()
      private var que, rs, rsp, ftype, pfiid, cbank, macc, account1, obank, 
                  account2, opkind=0, netting;/*CHVA*/
      
      if ((strupr(locdeal.rec.ActionType) == "DELETE") or (strupr(locdeal.rec.ActionType) == "UPDATE"))
         que =  "DECLARE "
              + "   dealid NUMBER(10); "
              + "   dockind NUMBER(5); "
              + "BEGIN "
              + "   dealid := ?; "
              + "   dockind := ?; "
              + "   delete from ddvndeal_dbt where t_id = dealid; "
              + "   delete from ddvnfi_dbt where t_dealid = dealid; "
              + "   delete from dpmprop_dbt where t_paymentid in (select t_paymentid from dpmpaym_dbt where t_documentid = dealid and t_dockind = dockind); "
              + "   delete from dpmrmprop_dbt where t_paymentid in  (select t_paymentid from dpmpaym_dbt where t_documentid = dealid and t_dockind = dockind); "
              + "   delete from dpmpaym_dbt where t_documentid = dealid and t_dockind = dockind; "
              + "END; ";
         rs = RSDCommand(que);
         rs.addParam( "", RSDBP_IN, locdeal.rec.Deal_ID );
         rs.addParam( "", RSDBP_IN, locdeal.rec.Dockind );
         rs.execute();
         if (strupr(locdeal.rec.ActionType) == "DELETE")
            return true;
         end;
      end;

      var dealdays, curba = -1, curka = -1;
      var calPrms, calendId = 0, calMarketId = -1;
      var MaxExecDate;
      var isMarket = false;
      var addCalendId = -1;
      var curParmIdx = -1;

      calPrms = TArray();

      if ((GenPropID(locdealdata,"DealData") >= 0) and (GenPropID(locdealdata.DealData,"CurrencyDeal") >= 0)
          and (GenPropID(locdealdata.DealData.CurrencyDeal,"PairsName") >= 0))
        if ((GenPropID(locdealdata.DealData.CurrencyDeal,"PrecMetal") >= 0) and (VALTYPE(locdealdata.DealData.CurrencyDeal.PrecMetal) != V_UNDEF))
           curba = GetFiidByISOCode(substr(locdealdata.DealData.CurrencyDeal.PairsName,1,3),6);
        else
           curba = GetFiidByISOCode(substr(locdealdata.DealData.CurrencyDeal.PairsName,1,3),1);
        end;
        curka = GetFiidByISOCode(substr(locdealdata.DealData.CurrencyDeal.PairsName,5,3),1);
      elif ((GenPropID(locdealdata,"DealData") >= 0) and (GenPropID(locdealdata.DealData,"CurrencySWAPDeal") >= 0)
          and (GenPropID(locdealdata.DealData.CurrencySWAPDeal,"PairsName") >= 0))
        curba = GetFiidByISOCode(substr(locdealdata.DealData.CurrencySWAPDeal.PairsName,1,3),1);
        curka = GetFiidByISOCode(substr(locdealdata.DealData.CurrencySWAPDeal.PairsName,5,3),1);
      end;

      if((Index(StrUpr(locdealdata.IdentityDeal.TSBrief),"MOEX") > 0) OR (Index(StrUpr(locdealdata.IdentityDeal.TSBrief),"SPVB") > 0))
        calMarketId = DL_GetMarketIDFromDVScheme(IIF(Index(StrUpr(locdealdata.IdentityDeal.TSBrief),"MOEX") > 0, Валютный_рынок, СПВБ_Валютный_рынок));
        if (calMarketId > 0)
          isMarket = true;
          calPrms[calPrms.size] = DL_KeyPair("Market",calMarketId);
          calPrms[calPrms.size] = DL_KeyPair("DayType",DL_CALLNK_MRKTDAY_SETTL);
          calPrms[calPrms.size] = DL_KeyPair("ObjectType",DL_CALLNK_MARKET);
        end;
      elif ((locdeal.rec.CONTRNAME == "MICX") or (locdeal.rec.CONTRNAME == "MICR"))
        calMarketId = DL_GetMarketIDFromDVScheme(Валютный_рынок);
        if (calMarketId > 0)
          isMarket = true;
          calPrms[calPrms.size] = DL_KeyPair("Market",calMarketId);
          calPrms[calPrms.size] = DL_KeyPair("DayType",DL_CALLNK_MRKTDAY_SETTL);
          calPrms[calPrms.size] = DL_KeyPair("ObjectType",DL_CALLNK_MARKET);
        end;
      else
         calPrms[calPrms.size] = DL_KeyPair("ObjectType",DL_CALLNK_OUTMARKET);
      end;
      calPrms[calPrms.size] = DL_KeyPair("MarketPlace", DL_CALLNK_MARKETPLACE_CUR);
      if (curba >= 0)
        calPrms[calPrms.size] = DL_KeyPair("Currency", curba);
      end;

      calendId = DL_GetCalendByDynParam(158,calPrms);

      if (isMarket)
        //для случая биржевых, в составленных параметрах calPrms ищем параметр валюты и подменяем его на валюту контрактива
        if ((curka >= 0) and (curka != NATCUR))
          curParmIdx = DL_FindKeyPairInArr(calPrms, "Currency");
          if (curParmIdx >= 0)
            calPrms[curParmIdx] = DL_KeyPair("Currency", curka);
            //получаем календарь по валюте контрактива, и берём его как дополнительный
            addCalendId = DL_GetCalendByDynParam(158,calPrms);
          end;
        end;
      else
        addCalendId = DL_CALENDAR_BOOK;
      end;

      if (locdealdata.IdentityDeal.DealKind == "OPTION")
      else
         locdeal.rec.BROKER = -1;
      end;
      if (locdealdata.IdentityDeal.DealKind == "FWD")
         opkind = 12690;
      elif (locdealdata.IdentityDeal.DealKind == "BOND")
         opkind = 2690;
      elif (locdealdata.IdentityDeal.DealKind == "FRA")
         opkind = 22720;
      elif (locdealdata.IdentityDeal.DealKind == "OPTION")
         opkind = 12695;
      elif (StrUpr(locdealdata.IdentityDeal.DealKind) == "SWAPOPTION")
         opkind = 12695;
      elif (locdealdata.IdentityDeal.DealKind == "IRS/CIRS")
         opkind = 22720;
      elif (locdealdata.IdentityDeal.DealKind == "SWAP")
// 2020-03-03 Cherednichenko для ЦБ используем календарь бухучета - 10003
         if (Workdays(locdealdata.IdentityDeal.DealDate,locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].Payments.ValueDate1, 10003)-1 < 3)
            if (locdeal.rec.CONTR == ID_NKC)
               opkind = 12715;
            else
               opkind = 12715;
            end;
         else
            if (locdeal.rec.CONTR == ID_NKC)
               opkind = 22710;
            else
               opkind = 22710;
            end;
         end;
         //locdeal.rec.BROKER = -1;
      else //CurDeal
         
         //gtv: переход на дистрибутив
         if (locdealdata.DealData.CurrencyDeal.Payments.ValueDate2>locdealdata.DealData.CurrencyDeal.Payments.ValueDate1)
            MaxExecDate=locdealdata.DealData.CurrencyDeal.Payments.ValueDate2;
         else
            MaxExecDate=locdealdata.DealData.CurrencyDeal.Payments.ValueDate1;
         end;

         if((Index(StrUpr(locdealdata.IdentityDeal.TSBrief),"MOEX") > 0) OR (Index(StrUpr(locdealdata.IdentityDeal.TSBrief),"SPVB") > 0))
             dealdays = DL_GetNumWorkDaysForPeriod(locdealdata.IdentityDeal.DealDate, MaxExecDate, IIF(isMarket,-1,curba), IIF(isMarket,-1,curka), IIF(isMarket,-1,locdeal.rec.CONTR), true, calendId, addCalendId);
         else 
             dealdays = DL_GetNumWorkDaysForPeriod(locdealdata.IdentityDeal.DealDate,
                                                   min(locdealdata.DealData.CurrencyDeal.Payments.ValueDate1, 
                                                       locdealdata.DealData.CurrencyDeal.Payments.ValueDate2),
                                                   IIF(isMarket,-1,curba), IIF(isMarket,-1,curka), -1, true, calendId, addCalendId);
         end; 
         /*dealdays = GetWorkDays( locdealdata.IdentityDeal.DealDate, 
                                 locdealdata.DealData.CurrencyDeal.Payments.ValueDate1, 
                                 locdealdata.DealData.CurrencyDeal.Payments.ValueDate2, 
                                 curba, 
                                 curka);*/
         //if (Workdays(locdealdata.IdentityDeal.DealDate,locdealdata.DealData.CurrencyDeal.Payments.ValueDate1)-1 < 3)


         if (dealdays < 3)
            if((Index(StrUpr(locdealdata.IdentityDeal.TSBrief),"MOEX") > 0) OR (Index(StrUpr(locdealdata.IdentityDeal.TSBrief),"SPVB") > 0))
               opkind = 22730;
            elif (GetTypeDealIngots(locdealdata.IdentityDeal.Comment)==1) //shev 20201005 для сделок со слитками
               opkind = 2731;
            else
               opkind = 12730;
            end;
         //elif (Workdays(locdealdata.IdentityDeal.DealDate,locdealdata.DealData.CurrencyDeal.Payments.ValueDate1)-1 > 2)
         elif (dealdays > 2)
            if (locdeal.rec.CONTR == ID_NKC)
               opkind = 22745;
            else
               opkind = 12745;
            end;
         end;

         if (locdealdata.IdentityDeal.DealKind == "BNKT")
            opkind = 12735;
         end;
      end;

      if ((opkind == 22730) or (opkind == 12735) or (opkind == 22745) or (opkind == 12730) or (opkind == 2731) or (opkind == 12745))
         CreateCurrDeal(opkind, dealdays);                                          
      elif (opkind == 2690)
         CreateBONDeal(opkind);
      elif (opkind == 12690)
         CreateFWDDeal(opkind);
      elif (opkind == 22720)
         if (locdealdata.IdentityDeal.DealKind == "FRA")
            CreateFRADeal(opkind);
         else //irs\cirs
            CreateIRSCIRSDeal(opkind);
         end;
      elif (opkind == 12695)
         if (StrUpr(locdealdata.IdentityDeal.DealKind) == "SWAPOPTION")
            CreateSWAPOptionDeal(opkind);
         else
            CreateOptionDeal(opkind);
         end;
      elif ((opkind == 2710) or (opkind == 12715) or (opkind == 22710))
         CreateSwapDeal(opkind, calendId, addCalendId);
      else
         err_txt = "Ошибка! Не верный тип сделки!";  
         RunError(err_txt, c_err_obj(err_txt,-3000));
      end;

      //Ген.соглашение
      var GenAgr;
      /*CHVA отбираем признак неттинга из структур разных видов сделок*/
      if ((opkind == 2710) or (opkind == 12715) or (opkind == 22710))
         netting = locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].Netting;
      elif (opkind == 12690)
         netting = locdealdata.dealdata.currencyFWDDeal.netting;
      elif((opkind == 22730) or (opkind == 12735) or (opkind == 22745) or (opkind == 12730) or (opkind == 12745) or (opkind == 2731)) //shev 20201005
         netting = locdealdata.dealdata.currencydeal.netting;
      else
         netting = "";
      end;
    
      // gtv: определение ГС вынесено в общую функцию
      if (  (opkind == 2710) or (opkind == 12715) or (opkind == 22710) or (opkind == 12690) 
         or (opkind == 22730) or (opkind == 12735) or (opkind == 22745) or (opkind == 12730) or (opkind == 12745) or (opkind == 2731)   //shev 20201005
         or (opkind == 22720) or (opkind == 12695) )
         // BIQ-5049 gtv: поиск CSA
         var CSAAgr;
         var GenAgrFormCSAAgr;
         if ( (ValType(locdealdata.IdentityDeal.GenAgreement) != V_UNDEF) and ( Index (locdealdata.IdentityDeal.GenAgreement,"CSA") > 0 ) )
            CSAAgr = FindCSAGenAgreement(locdealdata.IdentityDeal.GenAgreement, err_txt, GenAgrFormCSAAgr); 
            dvndeal.rec.csaid = CSAAgr;   // по умолчанию 0
            if (CSAAgr == 0)
               prm_Comment = err_txt;
               // если не найдено, то ген.соглашение найдем обычным способом
               GenAgr = FindGenAgreementByParty(NULL, netting, locdeal.rec.CONTR, "PFI", 
                                                opkind, dvnfi, dvnfi2); 
               dvndeal.rec.GENAGRID = GenAgr.AgrID;   // по умолчанию -1
               dvndeal.rec.conftpid = GenAgr.Trans;   // по умолчанию SWIFT
            else 
               dvndeal.rec.GENAGRID = GenAgrFormCSAAgr.AgrID;
               dvndeal.rec.conftpid = GenAgrFormCSAAgr.Trans; // по умолчанию SWIFT
            end;
         else 
            // BIQ-5049 gtv: GenAgreement может содержать и ген.соглашение и CSA. Но ген.соглашение игнорируем, так как номера все равно не совпадают
            GenAgr = FindGenAgreementByParty(NULL, netting, locdeal.rec.CONTR, "PFI", 
                                             opkind, dvnfi, dvnfi2); 
            dvndeal.rec.GENAGRID = GenAgr.AgrID;   // по умолчанию -1
            dvndeal.rec.conftpid = GenAgr.Trans;   // по умолчанию SWIFT
         end;
      end;


      /*
      koper.Clear();
      koper.rec.Kind_Operation = opkind;
      if( koper.GetEQ() )
         if( (koper.rec.DocKind != DL_DVNDEAL) and (koper.rec.DocKind != DL_DVDEALT3) )
            err_txt = "Операция " +  string(dvndeal.rec.Kind) + " не является сделкой ФИССиКО.";  
            RunError(err_txt, c_err_obj(err_txt,-3000));
         end;
         dvndeal.rec.DocKind = koper.rec.DocKind;
      else
         err_txt = "Не найден вид операции " + string(dvndeal.rec.Kind);  
         RunError(err_txt, c_err_obj(err_txt,-3000));
      end;
      */
      
     // gtv по заказу ОС: Биржевые сделки на валютном рынке в ФИССиКО без комиссии
      if ( // (dvndeal.rec.sector == "X") and (dvndeal.rec.marketkind == 2) and    //При загрузке сделок никакие комиссии не должны загружаться
            ( (dvndeal.rec.dockind == 4813) or (dvndeal.rec.dockind == 199) ) 
          )
      else
         if ( ValType(locdealdata.ComissArray) != V_UNDEF )
            ArrComSums.Size = 0;
            var CommDate:date = dvndeal.rec.Date;
            if( dvndeal.rec.Time > Time(19,0,0) )
               CommDate = GetDateAfterWorkDays(CommDate, 1, 10003); // 2020-03-02 Cherednichenko для ЦБ используем календарь бухучета - 10003
            end;
            var GateCommDate = null;
            
            var ArrComSums_i = 0, ComSum = $0;
            var dlcomis_market = TRecHandler( "dlcomis.dbt"  );
       
            ComisContrID = RGDLFUN_GetContrID(PTSK_DV, dvndeal.rec.Contractor, {OurBank}, dvndeal.rec.Date, NULL, NULL, @ErrMes);
            if( ComisContrID <= 0 )
               RunError(ErrMes, c_err_obj(err_txt,-3000));
            /*else
               if( (dvndeal.rec.Kind == ПокупкаПродажаT3) and (RG.GetSourceID() == GT_MMVB3) )
                  dvndeal.rec.Agent = dvndeal.rec.Contractor;
                  dvndeal.rec.AgentContr = ComisContrID;
               end;*/
            end;

            var i = 0;
            while(locdealdata.ComissArray.size > i)
                ComSum = locdealdata.ComissArray[i].Amount;
                type = locdealdata.ComissArray[i].Type;
                if( ComSum > $0.0 )
                   dlcomis_market.Clear();
                   if( not RG_InitDlComis("МскБиржПИ", dlcomis_market, @ErrMes, null, ComSum) )
                      RunError(ErrMes, c_err_obj(err_txt,-3000));
                   else
                      dlcomis_market.rec.Contract = ComisContrID;
                      dlcomis_market.rec.Date = dlcomis_market.rec.PlanPayDate = CommDate;
                         
                      ArrComSums_i = ArrComSums.Size;
                      ArrComSums(ArrComSums_i) = TRecHandler("dlcomis");
                      copy(ArrComSums(ArrComSums_i), dlcomis_market);
                   end;
                end;
                i = i + 1;
            end;
         end;
      end;
      
      if( dvndeal.rec.Client != UnknownParty )
         DL_СкорректироватьДатуЗаявки(dvndeal.rec.Date, dvndeal.rec.Time, @ClntRep.rec.RegistrDate, @ClntRep.rec.RegistrTime);
         ClntRep.rec.XLD = DL_СформироватьНомерЗаявки(-1, ClntRep.rec.RegistrDate, ClntRep.rec.RegistrTime);
         ClntRep.rec.SignedDate = ClntRep.rec.RegistrDate;
         ClntRep.rec.SignedTime = ClntRep.rec.RegistrTime;
      end;
      //DAN BIQ-6664 Идентификатор платежной инструкции

/*
      var IdentPI = null;
      if(valtype(locdealdata.IdentityDeal.IdentityPI) != v_undef)
        if(GetLLVALElement(LLCLASS_IDENTITY_PI, locdealdata.IdentityDeal.IdentityPI))
          IdentPI = locdealdata.IdentityDeal.IdentityPI;
        else  

          //Отправляем уведомление
            SendSingleNotification(String("Для сделки ",locdealdata.identitydeal.dealid,", заключённой через РСХБ-Дилинг 2.0, указан отсутствующий в справочнике идентификатор СПИ. Требуется ручная обработка"));

        end;
      else
            SendSingleNotification(String("Для сделки ",locdealdata.identitydeal.dealid,", заключённой через РСХБ-Дилинг 2.0, не указан идентификатор СПИ. Требуется ручная обработка")); 
      end;
*/
      var PayerIdentSPI      = null,
          ReceiverIdentSPI   = null,
          PayerIdentSPI_2    = null,
          ReceiverIdentSPI_2 = null;
      var ErrPI;
      var Deal_Legs   = TArray;
      var msg_str_arr  = TArray;
      var notes_303_val = TArray;
      var notes_304_val = TArray;

      if ((valtype(locdealdata.IdentityDeal.tsbrief) != v_undef) and (locdealdata.IdentityDeal.tsbrief == "RefinitivET"))
        if (valtype(locdealdata.IdentityDeal.dealkind != v_undef) and (locdealdata.IdentityDeal.dealkind == "FWD"))
          PayerIdentSPI    = locdealdata.dealdata.currencyfwddeal.pipayer;
          ErrPI = SetPI(@PayerIdentSPI);
          if(ErrPI == err_Undef_PI)
            msg_str_arr(msg_str_arr.size) = AddErrMSGStr(locdealdata.identitydeal.dealid, ErrPI, "(PIPayer)");
            notes_303_val(notes_303_val.size) = locdealdata.dealdata.currencyfwddeal.pipayer;
          end;

          ReceiverIdentSPI = locdealdata.dealdata.currencyfwddeal.pireceiver;
          ErrPI = SetPI(@ReceiverIdentSPI);
          if((ErrPI == err_Undef_PI) or (ErrPI == err_Null_PI))
            msg_str_arr(msg_str_arr.size) = AddErrMSGStr(locdealdata.identitydeal.dealid, ErrPI, "(PIReciever)");
            if(ErrPI == err_Undef_PI)
              notes_304_val(notes_304_val.size) = locdealdata.dealdata.currencyfwddeal.pireceiver;
            end;  
          end;

        elif ((valtype(locdealdata.IdentityDeal.dealkind) != v_undef) and (locdealdata.IdentityDeal.dealkind == "SPOT"))
          PayerIdentSPI    = locdealdata.dealdata.currencydeal.pipayer;
          ErrPI = SetPI(@PayerIdentSPI);
          if(ErrPI == err_Undef_PI)
            msg_str_arr(msg_str_arr.size) = AddErrMSGStr(locdealdata.identitydeal.dealid, ErrPI, "(PIPayer)");
            notes_303_val(notes_303_val.size) = locdealdata.dealdata.currencydeal.pipayer;
          end;

          ReceiverIdentSPI = locdealdata.dealdata.currencydeal.pireceiver;
          ErrPI = SetPI(@ReceiverIdentSPI);
          if((ErrPI == err_Undef_PI) or (ErrPI == err_Null_PI))
            msg_str_arr(msg_str_arr.size) = AddErrMSGStr(locdealdata.identitydeal.dealid, ErrPI, "(PIReciever)");
            if(ErrPI == err_Undef_PI)
              notes_304_val(notes_304_val.size) = locdealdata.dealdata.currencydeal.pireceiver;
            end;  
          end;

        elif ((valtype(locdealdata.IdentityDeal.dealkind) != v_undef) and (locdealdata.IdentityDeal.dealkind == "SWAP"))
          Deal_legs = locdealdata.dealdata.currencyswapdeal.legsdealslist;

          PayerIdentSPI    = Deal_legs(0).pipayer;
          ErrPI = SetPI(@PayerIdentSPI);
          if(ErrPI == err_Undef_PI)
            msg_str_arr(msg_str_arr.size) = AddErrMSGStr(locdealdata.identitydeal.dealid, ErrPI, "(PIPayer)");
            notes_303_val(notes_303_val.size) = Deal_legs(0).pipayer;
          end;

          ReceiverIdentSPI = Deal_legs(0).pireceiver;
          ErrPI = SetPI(@ReceiverIdentSPI);
          if((ErrPI == err_Undef_PI) or (ErrPI == err_Null_PI))
            msg_str_arr(msg_str_arr.size) = AddErrMSGStr(locdealdata.identitydeal.dealid, ErrPI, "(PIReciever)");
            if(ErrPI == err_Undef_PI)
              notes_304_val(notes_304_val.size) = Deal_legs(0).pireceiver;
            end;  
          end;

          PayerIdentSPI_2    = Deal_legs(1).pipayer;
          ErrPI = SetPI(@PayerIdentSPI_2);
          if(ErrPI == err_Undef_PI)
            msg_str_arr(msg_str_arr.size) = AddErrMSGStr(locdealdata.identitydeal.dealid, ErrPI, "(PIPayer)");
            notes_303_val(notes_303_val.size) = Deal_legs(1).pipayer;
          end;

          ReceiverIdentSPI_2 = Deal_legs(1).pireceiver;
          ErrPI = SetPI(@ReceiverIdentSPI_2);
          if((ErrPI == err_Undef_PI) or (ErrPI == err_Null_PI))
            msg_str_arr(msg_str_arr.size) = AddErrMSGStr(locdealdata.identitydeal.dealid, ErrPI, "(PIReciever)");
            if(ErrPI == err_Undef_PI)
              notes_304_val(notes_304_val.size) = Deal_legs(1).pireceiver;
            end;  
          end;

        end;

        if (msg_str_arr.size > 0)
          SendSingleNotification(msg_str_arr);
        end; 

      end;
      
      if (prm_ObjID > 0)
        dvndeal.rec.id = prm_ObjID;
      end;
      
      stat = DV_InsertNDeal(dvndeal, dvnfi, dvnfi2, null, spgrdoc, ArrComSums, ClntRep, ArrNotes, PayerIdentSPI, ReceiverIdentSPI, PayerIdentSPI_2, ReceiverIdentSPI_2);

//shev 20201006 вставляем слитки
      if(opkind == 2731)
         InsertIngorts(dvndeal.rec.id,dvnfi.rec.amount);
      end;

      if( stat != 0 )
         err_txt = "Ошибка при вставке отложенной сделки с ПИ.\n"+GetErrMsg();  
         RunError(err_txt, c_err_obj(err_txt,-3000));
      end;

//shev 04.03.2020 isup 501527
      var aux_buff = 0, j=0,TypeBankCode, CorrAccount = ""; /*PNV 536322*/
      var sql, paym:RsbPayment,NumberCorr;
// Cherednichenko 11.03.2020 - не у всех сделок есть PayInstrList, поставим проверку
      if (VALTYPE(locdealdata.PayInstrList) != V_UNDEF)

        var size = locdealdata.PayInstrList.size;
        var DealType, Metal,fiid ; 
  
        if (opkind == 12690) 
           if (VALTYPE(locdealdata.DealData.CurrencyFWDDeal.PrecMetal) != V_UNDEF)
                Metal = true;
                fiid = GetFiidCodeByName(locdealdata.dealdata.CurrencyFWDDeal.currencydeals);
           end;
        elif ((opkind == 2710) or (opkind == 12715) or (opkind == 22710))
             if (VALTYPE(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].PrecMetal) != V_UNDEF) 
                Metal = true;
                fiid = GetFiidCodeByName(locdealdata.dealdata.CurrencySWAPDeal.currencydeals);
           end;
        elif ((opkind == 22730) or (opkind == 12735) or (opkind == 22745) or (opkind == 12730) or (opkind == 12745) or (opkind == 12745)) //shev 20201005
             if(VALTYPE(locdealdata.DealData.CurrencyDeal.PrecMetal) != V_UNDEF)
                Metal = true;
                fiid = GetFiidCodeByName(locdealdata.dealdata.currencydeal.currencydeals);
           end;
        end;
  
        if(metal==true)
          while(size> aux_buff)
             if (substr(locdealdata.PayInstrList[aux_buff].PayInstrKind,1,9) == "Заплатить")
                sql = "select T_CORACCOUNT, t_number from dcorschem_dbt where t_account = '"+locdealdata.PayInstrList[aux_buff].PayInstr+"'";
                rs = RsdRecordset(sql);
                if(rs.movenext()) 
                   CorrAccount = rs.value("T_CORACCOUNT");
                   NumberCorr = rs.value("t_number");
                   j = aux_buff;
                end;
             end;
             aux_buff = aux_buff+1;
          end;
  
          rs = null;sql = null;
  
          sql = "select t_paymentid from dpmpaym_dbt where t_documentid = '"+dvndeal.rec.id+"' and substr(t_receiveraccount,1,3) = '301'";
          rs = RsdRecordset(sql);
          if(rs.movenext()) 
             paym = RsbPayment(rs.value("t_paymentid"));
          end;
  
   
          if (fiid==0)
             TypeBankCode = PTCK_BIC;
          else 
             if (PartyIsNotResident(locdeal.rec.contr)) 
                TypeBankCode = PTCK_SWIFT;            
             else 
                TypeBankCode = PTCK_BIC;
             end;
          end;
    
          if (locdealdata.IdentityDeal.BuySell == "Buy")
             DealType = 12183;
          elif (locdealdata.IdentityDeal.BuySell == "Sell")
             DealType = 12193;
          end;
    
          paym.SetReceiverPI(PAYMENTS_GROUP_UNDEF,
                             locdeal.rec.contr,
                             TypeBankCode,  
                             paym.receiverbankcode,
                             paym.receiverbankname,
                             corrAccount,
                             fiid,
                             paym.chapter,
                             locdealdata.PayInstrList[j].PayInstr, 
                             locdeal.rec.contr,
                             "",
                             "",
                             TypeBankCode,             
                             "",
                             NumberCorr,
                             pm_corrpos_type_user
                            );
  
        end;
      end;
  //shev 04.03.2020 isup 501527

      if (locdealdata.IdentityDeal.DealKind == "BNKT")
         // gtv: поиск кассового счета, кассовый должен быть строго один
         var s_find, c_find, r_find, cnt = 0, acc20202 = "";
         s_find = "select t_account from daccount_dbt where t_open_close=chr(0) and t_chapter=1 and t_balance='20202' "
                   + " and t_code_currency = :cur and t_usertypeaccount like '%Б%'";
         c_find = RSDCommand(s_find);
         c_find.AddParam("cur", RSDBP_IN, dvnfi.rec.FIID);
         r_find = RSDRecordSet(c_find);
         while (r_find.movenext)
            acc20202 = r_find.value("t_account");
            cnt = cnt+1;
         end;
         r_find.close();
         if (cnt == 1) 
            que = "update dpmpaym_dbt set ";
            if   ( locdealdata.IdentityDeal.BuySell == "Buy" )
               que = que + "t_payeraccount = ";
            else
               que = que + "t_receiveraccount = ";
            end;
            que = que + " :acc20202 where t_dockind=4813 and t_documentid = :docid and t_purpose=1 ";
            rs = RSDCommand(que);
            rs.addParam( "acc20202", RSDBP_IN, acc20202 );
            rs.addParam( "docid", RSDBP_IN, dvndeal.rec.ID );
            rs.execute();
            /*DEF-32017*/
            que = "update DDVNFI_DBT set T_ISCASHBA = chr(88), T_ACCOUNTBA = :acc20202 where t_dealid = :docid";
            rs = RSDCommand(que);
            rs.addParam( "acc20202", RSDBP_IN, acc20202 );
            rs.addParam( "docid", RSDBP_IN, dvndeal.rec.ID );
            rs.execute();
            /*DEF-32017*/
         end;
      end;

      var dvnpmg = TRecHandler( "dvnpmgr" ), irsleg = 0;
      cnt = 0;
      if (locdealdata.IdentityDeal.DealKind == "IRS/CIRS")
         que =  "DECLARE "
              + "   dealid NUMBER(10); "
              + "BEGIN "
              + "   dealid := ?; "
              + "   delete from ddvnpmgr_dbt where t_dealid = dealid; "
              + "END; ";
         rs = RSDCommand(que);
         rs.addParam( "", RSDBP_IN, dvndeal.rec.ID );
         rs.execute();
         while (irsleg <= 1)
            if (locdealdata.DealData.IRSSWAPDeal.PartList[irsleg].CashFlow != V_UNDEF)
               cnt = 0;
               while (locdealdata.DealData.IRSSWAPDeal.PartList[irsleg].CashFlow.Size > cnt)
                  dvnpmg.Clear();
                  dvnpmg.rec.DealID = dvndeal.rec.ID;                    
                  // gtv: определяем по знаку 
                  if (locdealdata.DealData.IRSSWAPDeal.PartList[irsleg].CashFlow[cnt].Amount > 0)
                     dvnpmg.rec.Side = 2;
                  else
                     dvnpmg.rec.Side = 1;
                  end;
                  //dvnpmg.rec.Side = irsleg + 1;
                  dvnpmg.rec.PaymentSum = abs(Money(locdealdata.DealData.IRSSWAPDeal.PartList[irsleg].CashFlow[cnt].Amount));
                  if( dvnpmg.rec.Side == 2 )
                     dvnpmg.rec.DemandSum  =  dvnpmg.rec.PaymentSum;
                     dvnpmg.rec.LiabilitySum = 0;
                  else
                     dvnpmg.rec.DemandSum  =  0;
                     dvnpmg.rec.LiabilitySum = dvnpmg.rec.PaymentSum;
                  end;
                  dvnpmg.rec.BegDate = locdealdata.DealData.IRSSWAPDeal.PartList[irsleg].CashFlow[cnt].DateBegin;
                  dvnpmg.rec.EndDate = locdealdata.DealData.IRSSWAPDeal.PartList[irsleg].CashFlow[cnt].DateEnd;
                  dvnpmg.rec.PayDate = locdealdata.DealData.IRSSWAPDeal.PartList[irsleg].CashFlow[cnt].DatePay;
                  if ( ValType(locdealdata.DealData.IRSSWAPDeal.PartList[irsleg].CashFlow[cnt].FixDate) != V_Undef)
                     dvnpmg.rec.FixDate = locdealdata.DealData.IRSSWAPDeal.PartList[irsleg].CashFlow[cnt].FixDate;
                  end;
                  dvnpmg.rec.TransferDate = dvnpmg.rec.PayDate;
                  if (locdealdata.DealData.IRSSWAPDeal.PartList[irsleg].RateType == "Float")
                  //if ( ValType(locdealdata.DealData.IRSSWAPDeal.PartList[irsleg].CashFlow[cnt].Rate) != V_Undef)
                     dvnpmg.rec.FloatRateValue = locdealdata.DealData.IRSSWAPDeal.PartList[irsleg].CashFlow[cnt].Rate;
                  end;
// 2020-12-08 Cherednichenko is 519873 убираем добавление платежей по изменениям ставки, т.е. платежи с 0 суммой.    // если
                  if (    ( ValType(locdealdata.DealData.IRSSWAPDeal.PartList[irsleg].RateFloatType) != 26 )         // признак ставки присутствует
                      and (locdealdata.DealData.IRSSWAPDeal.PartList[irsleg].RateFloatType == "RUBKEYRATE")          // и признак ставки = CBR_KeyRate
                      and (locdealdata.DealData.IRSSWAPDeal.PartList[irsleg].CashFlow.value(cnt).amount == 0) )      // и сумма равна 0 - ничего не делаем
                   else                                                                                              // иначе добавляем платеж
                    if( DV_InsertNPmGr(dvnpmg) != 0 )
                       RunError("Ошибка строки графика платежей.\n"+GetErrMsg());
                    end;
                  end;
                  cnt = cnt + 1;
               end;
            end;
            irsleg = irsleg +1;
         end;
      end;

      var typeObj;
      var linkchannel_groupid; // gtv: категория для каналов связи
      var agent701_notekind; // gtv: посредник для формы 701
      if ((dvndeal.rec.dockind == 199) or  ((dvndeal.rec.dockind == 4815) and (dvndeal.rec.kind == 12745))) //dan добавил споты T+3
         typeObj = 145;                                                                                                                               
         linkchannel_groupid = 3;
         agent701_notekind = 12;
      else //4813 4815
         typeObj = 148;
         linkchannel_groupid = 5;
         agent701_notekind = 2;
      end;
      //примечания

      // dan> BIQ-6664
      errPI = notes_303_val.createEnum;
      while(errPI.next)
        addNoteForObject( typeObj, string(dvndeal.rec.ID:o:34), 303, errPI.Item,dvndeal.rec.DATE);
      end;
      errPI = notes_304_val.createEnum;
      while(errPI.next)
        addNoteForObject( typeObj, string(dvndeal.rec.ID:o:34), 304, errPI.Item,dvndeal.rec.DATE);
      end;
      // <dan

      if ((opkind == 22730) or (opkind == 12735) or (opkind == 22745) or (opkind == 12730) or (opkind == 12745) or (opkind == 12745))  //shev 20201005
        if (VALTYPE(locdealdata.DealData.CurrencyDeal.PrecMetal) != V_UNDEF)
           if (locdealdata.DealData.CurrencyDeal.PrecMetal.DmType == "o")
              addNoteForObject( typeObj, string(dvndeal.rec.ID:o:34), 101, locdealdata.DealData.CurrencyDeal.PrecMetal.Amount,dvndeal.rec.DATE);
              addNoteForObject( typeObj, string(dvndeal.rec.ID:o:34), 102, locdealdata.DealData.CurrencyDeal.PrecMetal.Price, dvndeal.rec.DATE);
           end;
        end;
      elif (opkind == 12690)
        if (VALTYPE(locdealdata.DealData.CurrencyFWDDeal.PrecMetal) != V_UNDEF)
           if (locdealdata.DealData.CurrencyFWDDeal.PrecMetal.DmType == "o")
              addNoteForObject( typeObj, string(dvndeal.rec.ID:o:34), 101, locdealdata.DealData.CurrencyFWDDeal.PrecMetal.Amount,dvndeal.rec.DATE);
              addNoteForObject( typeObj, string(dvndeal.rec.ID:o:34), 102, locdealdata.DealData.CurrencyFWDDeal.PrecMetal.Price, dvndeal.rec.DATE);
           end;
        end;
        if (VALTYPE(locdealdata.DealData.CurrencyFWDDeal.Fixing) != V_UNDEF)
           addNoteForObject( typeObj, string(dvndeal.rec.ID:o:34), 103, locdealdata.DealData.CurrencyFWDDeal.Fixing.FixRate,  locdealdata.DealData.CurrencyFWDDeal.Fixing.FixDate);
           addNoteForObject( typeObj, string(dvndeal.rec.ID:o:34), 104, locdealdata.DealData.CurrencyFWDDeal.Fixing.FixAmount,locdealdata.DealData.CurrencyFWDDeal.Fixing.FixDate);
        end;
      elif ((opkind == 2710) or (opkind == 12715) or (opkind == 22710))
        if (VALTYPE(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].PrecMetal) != V_UNDEF)
           if (locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].PrecMetal.DmType == "o")
              addNoteForObject( typeObj, string(dvndeal.rec.ID:o:34), 101, locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].PrecMetal.Amount,dvndeal.rec.DATE);
              addNoteForObject( typeObj, string(dvndeal.rec.ID:o:34), 102, locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[0].PrecMetal.Price, dvndeal.rec.DATE);
           end;
        end;
        if (VALTYPE(locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].PrecMetal) != V_UNDEF)
           if (locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].PrecMetal.DmType == "o")
              addNoteForObject( typeObj, string(dvndeal.rec.ID:o:34), 105, locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].PrecMetal.Amount,dvndeal.rec.DATE);
              addNoteForObject( typeObj, string(dvndeal.rec.ID:o:34), 106, locdealdata.DealData.CurrencySWAPDeal.LegsDealsList[1].PrecMetal.Price, dvndeal.rec.DATE);
           end;
        end;
      elif (opkind == 22720)
        if (locdealdata.IdentityDeal.DealKind == "FRA")
           if (VALTYPE(locdealdata.DealData.Fradeal.Fixing) != V_UNDEF)
              addNoteForObject( typeObj, string(dvndeal.rec.ID:o:34), 103, locdealdata.DealData.Fradeal.Fixing.FixRate, locdealdata.DealData.Fradeal.Fixing.FixDate);
              addNoteForObject( typeObj, string(dvndeal.rec.ID:o:34), 107, locdealdata.DealData.Fradeal.Fixing.FixCurr, locdealdata.DealData.Fradeal.Fixing.FixDate);
           end;
        else /*maa160719 - сделал доп обертку, чтобы не падало. нужно доделать для ирсов, которые сюда же приходят*/
           //msgbox("доделать для ирсов");
        end;
      end;
      if (VALTYPE(locdealdata.IdentityDeal.ConversationText) != V_UNDEF)
         addNoteForObject( typeObj, string(dvndeal.rec.ID:o:34), 300, locdealdata.IdentityDeal.ConversationText,dvndeal.rec.DATE);
      end;
      if (VALTYPE(locdealdata.IdentityDeal.TSBrief) != V_UNDEF)
         addNoteForObject( typeObj, string(dvndeal.rec.ID:o:34), 301, locdealdata.IdentityDeal.TSBrief,dvndeal.rec.DATE);
      end;
      if (locdeal.rec.TRADERNAME != "")
         addNoteForObject( typeobj, string(dvndeal.rec.ID:o:34), 150, locdeal.rec.TRADERNAME, dvndeal.rec.DATE);
      end;
      // gtv: примечание 10 по заказу ОС
      if ( (dvndeal.rec.sector == "X") and (dvndeal.rec.ispfi == "X") and (dvndeal.rec.dockind == 199) )
         if (Valtype(dvndeal.rec.extcode) != V_UNDEF)
             addNoteForObject( typeobj, string(dvndeal.rec.ID:o:34), 10, dvndeal.rec.extcode, dvndeal.rec.DATE);
         end;
      end;
      // gtv: посредник для формы 701
      if (VALTYPE(locdeal.rec.BROKER_CODE) != V_UNDEF)
//        addNoteForObject( typeobj, string(dvndeal.rec.ID:o:34), agent701_notekind, locdeal.rec.BROKER_CODE, dvndeal.rec.DATE);
      end;

      //категории
      var pdat1,pdat2;
      ObjID  = string(dvndeal.rec.ID:o:34);
      ObjCat = RsbObjCategories( typeObj, ObjID);
      ObjCat.ConnectAttr(102, 1, NULL, NULL, {curdate} );
      if (opkind == 12690)
         if (VALTYPE(locdealdata.DealData.CurrencyFWDDeal.Fixing) != V_UNDEF)
            if (dvnfi.rec.EXECDATE <= locdealdata.DealData.CurrencyFWDDeal.Fixing.FixDate)
// 2020-03-03 Cherednichenko для ЦБ используем календарь бухучета - 10003
               pdat1 = Workdays(dvnfi.rec.EXECDATE,locdealdata.DealData.CurrencyFWDDeal.Fixing.FixDate, 10003)-1;
            else
// 2020-03-03 Cherednichenko для ЦБ используем календарь бухучета - 10003
               pdat1 = Workdays(locdealdata.DealData.CurrencyFWDDeal.Fixing.FixDate,dvnfi.rec.EXECDATE, 10003)-1;
            end;
            if (pdat1 == 2)
               pdat1 = 1;
            elif (pdat1 == 1)
               pdat1 = 2;
            else
               pdat2 = 3;
            end;
            ObjCat.ConnectAttr(101, pdat2, NULL, NULL, {curdate} );
         end;
      elif (opkind == 22720)
         if (VALTYPE(locdealdata.IdentityDeal.BuySell) != V_UNDEF)
            if (StrUpr(locdealdata.IdentityDeal.BuySell) == "BUY")
               ObjCat.ConnectAttr(103, 1, NULL, NULL, {curdate} );
            elif (StrUpr(locdealdata.IdentityDeal.BuySell) == "SELL")
               ObjCat.ConnectAttr(103, 2, NULL, NULL, {curdate} );
            end;
         end;
      elif (opkind == 12695)
         if (StrUpr(locdealdata.IdentityDeal.DealKind) == "SWAPOPTION")
         else
            if (VALTYPE(locdealdata.DealData.CurrencyOptionDeal.ValuationType) != V_UNDEF)
               ObjCat.ConnectAttr(104, locdealdata.DealData.CurrencyOptionDeal.ValuationType, NULL, NULL, {curdate} );  // соответствует attrid
            end;
         end;
      end;

      //канал связи
      var link_channel_str, link_channel_num;
      link_channel_str = DefineLinkChannel(locdealdata);
      link_channel_num = FindAttrID(link_channel_str, typeObj, linkchannel_groupid);
      if ( (link_channel_num == 0) and (link_channel_str == "Reuter") )
        link_channel_str = "Reuters";
        link_channel_num = FindAttrID(link_channel_str, typeObj, linkchannel_groupid);
      end;
      if (link_channel_num > 0)
        var st_cat = ObjCat.ConnectAttr(linkchannel_groupid, link_channel_num, NULL, NULL,  {curdate} );
      end;

      //РСХБ Дилинг 2.0
      if((valtype(locdealdata.identitydeal.tsbrief) != v_undef) and (locdealdata.identitydeal.tsbrief == "RefinitivET"))
        if(typeObj   == OBJTYPE_FXOPER_DV)  //148 Конверсионная операция
          ObjCat.ConnectAttr(5, 5, NULL, NULL, {curdate} );
//        elif(typeObj == OBJTYPE_OUTOPER_DV) //145 Внебиржевая операция с ПИ
//          ObjCat.ConnectAttr(3, 5, NULL, NULL, {curdate} );
        end;  
      end;

      ObjCat.Save(ObjID);


      // gtv: запуск сделок
// вынесено в отдельный планировщик
/*      if ( ( (locdeal.rec.CONTR == ID_NKC) and  (dvndeal.rec.sector == "X") and (dvndeal.rec.marketkind == 2) )
           or (link_channel_str == "Bloomberg")
          )
OutputIntrace("Exec_deal_begin "+dvndeal.rec.CODE+" curdate="+{curdate}); 
       var resexec;
        resexec = DV_ExecDeal(dvndeal.rec.ID,false);
OutputIntrace("Exec_deal_end "+dvndeal.rec.CODE+" result="+resexec);
      end;        */

      return true;
  end;

  macro CreateDeal()
      if (not CreateMMDeal())
          return 1;
      end;

      prm_ObjID = dvndeal.rec.ID;

      return 0;
  end;

  macro Get_ObjID()
      return string(prm_ObjID);
  end;

  macro Get_Comment()
      return prm_Comment;
  end;
  
  private macro ClassConstructor( obdeal )
      prm_SeanceID = 0;
      prm_RecordID = 0;

      prm_ObjID   = -1;
      prm_Comment = "";
      
      if ((ValType(obdeal.IdentityDeal.SofrGenID) != V_UNDEF) and (obdeal.IdentityDeal.SofrGenID > 0))
        prm_ObjID = obdeal.IdentityDeal.SofrGenID;
      end;
  end;

  ClassConstructor( obdeal);
end;

///////////////////////////////////////////////////////////////////////////////////
//проверка перед удалением сделки для последующего обновления Ястребов 07.11.2019

macro pre_del_check (req_obj_serv)
var anyleg_d, anyparamRATEID;

 if (substr(req_obj_serv.identitydeal.dealid, 1, 3) == "IRS")
    if (locdeal.rec.ActionType == "UPDATE") 
       if (locdealdata.DealData.IRSSWAPDeal.PartList[0].Amount > 0)   
         anyleg_d = 0;
       else
         anyleg_d = 1;
       end;

         anyparamRATEID = GetFiidIndex(locdealdata.DealData.IRSSWAPDeal.PartList[anyleg_d].RateFloatType);

       if (anyparamRATEID == -1)
            err_txt = "Не найдена плавающая ставка " + locdealdata.DealData.IRSSWAPDeal.PartList[anyleg_d].RateFloatType;  
            RunError(err_txt, c_err_obj(err_txt,-3000));
       else 
            return 1;
       end;

    else
       return 1;
    end;

 else
    return 1;
 end;
   

end; //pre_del_check



//////////////////////////////////////////////////////////////////////////////////
// CSA Agreement
///////////////////////////////////////////////////////////////////////////////////
private class Ob_CSAAgreement( obdeal )
   private var
      prm_ObjID,
      prm_Comment;

   var type:integer;
   var stat:integer;
   var cmd, qwery;

   var dvcsaindRecArr = TArray();
   var dvcsaindRec = TRecHandler("dvcsaind.dbt");

   var basefiid, GenAgr, AgreeDate, AgreeNumber;

   var ErrMes;
   
   record fininstr(fininstr);

   private macro FindGenAgreementByParty_vacant(_party)
      var sql_str2, add_cond;
      var res;
      sql_str2 = "  from ddl_genagr_dbt gen " +
                 " where gen.t_partyid = " + _party +
                 "   and gen.t_dockind = 4812 " +
                 "   and t_status = 10 ";
      add_cond = " and not exists (select 1 from ddvcsa_dbt dvcsa, doproper_dbt oproper where dvcsa.t_CSAID<>0 "+
                 "                          AND dvcsa.t_GenAgrID=gen.t_genagrid AND oproper.t_DocumentID=dvcsa.t_CSAID "+
                 "                          AND oproper.t_DocKind=4626 AND oproper.t_Kind_Operation=2795 AND oproper.t_Completed<>chr(88)"+
                 "                )";
      res = FindGenAgrByCondition(sql_str2, add_cond);
      return res;
   end;
      
   private macro CreateCSAAgreement(_BofficeKind)
      var pos = 0;

      basefiid = GetFiidCodeByName(locdealdata.DealData.IAMLDDeal.CurrencyDeals);
      GenAgr = FindGenAgreementByParty_vacant(locdeal.rec.CONTR); 
      if (GenAgr.AgrID == -1)
         ErrMes = "Не найдено ген соглашение для контрагента "+locdeal.rec.CONTRNAME+" в СОФР, не связанное с другими CSA";  
         RunError(ErrMes, c_err_obj(ErrMes,-3000));
      end;
      
      dvcsaindRec.rec.fiid = GetFiidIndex(locdealdata.DealData.IAMLDDeal.RateFloatShortName);; //Индекс. Значение из DFININSTR_DBT -> T_FIID 
      if (dvcsaindRec.rec.fiid == -1)
         ErrMes = "Не найден индекс "+locdealdata.DealData.IAMLDDeal.RateFloatShortName+" в СОФР";  
         RunError(ErrMes, c_err_obj(ErrMes,-3000));
      end;

      dvcsaindRec.rec.spread = 4; //Спред
      dvcsaindRec.rec.dyear = 2; //Базис. Значение из DNAMEALG_DBT -> T_INUMBERALG c T_ITYPEALG = 8233
      if (locdealdata.IdentityDeal.BuySell == "Loan")
         dvcsaindRec.rec.kind = 1;
      elif (locdealdata.IdentityDeal.BuySell == "Deposit")
         dvcsaindRec.rec.kind = 2;
      else
         dvcsaindRec.rec.kind = 0;
      end;
      dvcsaindRec.rec.days = 10; //Сдвиг
      dvcsaindRecArr[0] = dvcsaindRec;

      if (ValType(locdealdata.DealData.IAMLDDeal.Details) != V_UNDEF)
         AgreeNumber = locdealdata.DealData.IAMLDDeal.Details;
         pos = Index(StrUpr(AgreeNumber), "DATED"); // считаем, что в начале быть не может
         if (pos > 1)
            AgreeNumber = Substr(AgreeNumber,1,pos-1);
         end;
         AgreeNumber = substr(trim(AgreeNumber),1,30);
      else 
         AgreeNumber = "CSA";
      end;
      if (ValType(locdealdata.IdentityDeal.GenData) != V_UNDEF)
         AgreeDate = locdealdata.IdentityDeal.GenData;
      else
         AgreeDate = {curdate};
      end;

   end;

   private macro CreateMMDeal()
      CreateCSAAgreement(DL_SECURITYDOC);

      //Синтаксис
      //DV_CSAInsert(PartyId:INTEGER, GenAgrId:INTEGER, CSACode:STRING, BeginDate:DATE, BaseFIID:INTEGER, PrcStartDateKind:INTEGER, 
      //   PeriodMonth:INTEGER, PeriodDay:INTEGER, IsRepo:BOOL, TypeSecur:INTEGER, FormSecur:INTEGER, ReportingParty:INTEGER, IndRecArray:TARRAY):INTEGER
      //PartyId - Контрагент по CSA. Значение из DPARTY_DBT -> T_PARTYID
      //GenAgrId - Генеральное соглашение, связанное с контрагентом. Значение из DDL_GENAGR_DBT -> T_GENAGRID
      //CSACode - Номер соглашения.
      //BeginDate - Дата заключения CSA.
      //BaseFIID - Базовая валюта. Значение из DFININSTR_DBT -> T_FIID 
      //PrcStartDateKind - Способ расчёта процентов (на исх. ост., на вх. ост.). Значение из DNAMEALG_DBT -> T_INUMBERALG c T_ITYPEALG = 8235
      //PeriodMonth - Процентный период. Месяцев.
      //PeriodDay - Процентный период. Дней.
      //IsRepo - Признак "Репортинг для репозитария"
      //TypeSecur - Тип обеспечения. Значение из DLLVALUES_DBT -> T_ELEMENT c T_LIST = 4019
      //FormSecur - Форма обеспечения. Значение из DLLVALUES_DBT -> T_ELEMENT c T_LIST = 4020
      //ReportingParty - "Отправитель сообщения об уплате маржевых сумм". Значение из DNAMEALG_DBT -> T_INUMBERALG c T_ITYPEALG = 8236

      //Возвращаемое функцией значение - код ошибки, или 0, если выполнение успешно.

      stat = DV_CSAInsert(locdeal.rec.CONTR, GenAgr.AgrID, 
                          AgreeNumber, AgreeDate, 
                          basefiid, 1, 1, 0, true, 1, 1, 1, dvcsaindRecArr);

      if(stat != 0)
         err_txt = "Ошибка "+stat+" при вставке соглашения CSA.\n" + GetErrMsg();  
         RunError(err_txt, c_err_obj(err_txt,-3000));
      end;

      return true;
  end;

  macro CreateDeal()
      if (not CreateMMDeal())
          return 1;
      end;

      prm_ObjID = 0;

      return 0;
  end;

  macro Get_ObjID()
      return prm_ObjID;
  end;

  macro Get_Comment()
      return prm_Comment;
  end;

  private macro ClassConstructor( obdeal )

      prm_ObjID   = -1;
      prm_Comment = "";
  end;

  ClassConstructor( obdeal );
end;

///////////////////////////////////////////////////////////////////////////////////
//вызываем транзакцию импорта сделки МБК, возвращаем нужные параметры	
macro _MoneyMarketDeal_CreateNew( req_obj_serv )
   var 
      Obj, retVal = c_ResultDeal(), que, rs0, ActionType, err_txt="", aux_buff, pleg, pkind, pcode, cntpl=0;
   var ContrParty;

   if (req_obj_serv.IdentityDeal.ActionType == 1)
      ActionType = "NEW";
   elif (req_obj_serv.IdentityDeal.ActionType == 2)
      ActionType = "UPDATE";
   elif (req_obj_serv.IdentityDeal.ActionType == 3)
      ActionType = "DELETE";
   end;
   locdeal.rec.ActionType = ActionType;
   locdealdata = req_obj_serv;

   if ((ActionType == "NEW") and 
       (ValType(req_obj_serv.IdentityDeal.SofrGenID) != V_UNDEF) and 
       (req_obj_serv.IdentityDeal.SofrGenID > 0) and
       (not IsDealExistInBuffer(GetSequenceType(req_obj_serv), req_obj_serv.IdentityDeal.DealID, req_obj_serv.IdentityDeal.SofrGenID)))
     retVal.Code = 1;
     retval.Text = "Не найдена cделка '" + req_obj_serv.IdentityDeal.DealID + "' в буферной таблице";
     return retVal;
   end;

   //обработка PartyDealList
   locdeal.rec.CONTR = locdeal.rec.TRADER = locdeal.rec.BROKER = -1;
   locdeal.rec.TRADERNAME = "";
   locdeal.rec.BROKER_CODE = NULL;
   aux_buff = 0;
   while(locdealdata.PartyDealList.size > aux_buff)
      pkind = locdealdata.PartyDealList[aux_buff].PartyKind;
      pcode = locdealdata.PartyDealList[aux_buff].PartyShortName;
      if (pkind == 1) //Клиент (нашей стороны) 
         locdeal.rec.CLIENT = Codeparty(pcode,103);
      elif (pkind == 2) //Контрагент 
         locdeal.rec.CONTR = Codeparty(pcode,103);
         locdeal.rec.CONTRNAME = pcode;
         if (locdeal.rec.CONTR == -1)
            // gtv: только если список PartyUID передали
            if (VALTYPE(locdealdata.PartyDealList[aux_buff].PartyUID) != V_UNDEF)
               ContrParty = FindPartyByCPTY(locdealdata.PartyDealList[aux_buff].PartyUID);
            else
               ContrParty = -1;
            end;
            if (ContrParty > 0)
               locdeal.rec.CONTR = ContrParty;
               SetRSBPartyCode(ContrParty, pcode);
            else
               err_txt = "Сделка " + req_obj_serv.IdentityDeal.DealID + " не создана: в СОФР отсутствует контрагент с кодом 103 = "+pcode+" и кодами CPTY";
            end;
         end;
      elif (pkind == 3) //Трейдер 
         locdeal.rec.TRADER = Codeparty(pcode,103);
         locdeal.rec.TRADERNAME = pcode;
      elif (pkind == 4) //Брокер (нашей стороны) 
         locdeal.rec.BROKER_CODE = pcode;
         locdeal.rec.BROKER = Codeparty(pcode,103);
         if (locdeal.rec.BROKER == -1)
            // gtv: только если список PartyUID передали
            if (VALTYPE(locdealdata.PartyDealList[aux_buff].PartyUID) != V_UNDEF)
               ContrParty = FindPartyByCPTY(locdealdata.PartyDealList[aux_buff].PartyUID);
            else
               ContrParty = -1;
            end;
            if (ContrParty > 0)
               locdeal.rec.BROKER = ContrParty;
               SetRSBPartyCode(ContrParty, pcode);
            else
               // gtv: в примечание записываем код "как есть"
               //err_txt = "Сделка " + req_obj_serv.IdentityDeal.DealID + " не создана: в СОФР отсутствует брокер с кодом 103 = "+pcode+" и кодами CPTY";
            end;
         end;
        if (locdeal.rec.BROKER == ID_NKC)
           locdeal.rec.BROKER_CODE = "MMVB";
        end;

      /*elif (pkind == 5) //Лицо, заключившее сделку 
         locdeal.rec.CLIENT = Codeparty(pcode,103);
      elif (pkind == 6) //Посредник 
         locdeal.rec.CLIENT = Codeparty(pcode,103);
      elif (pkind == 7) //Контрагент при термировании 
         locdeal.rec. = Codeparty(pcode,101);
      elif (pkind == 8) //Залогодатель
         locdeal.rec. = Codeparty(pcode,101);
      elif (pkind == 9) //Трейдер по обеспечению
         locdeal.rec. = Codeparty(pcode,101);
      elif (pkind == 10) //Клиент стороны контрагента 
         locdeal.rec. = Codeparty(pcode,101);
      elif (pkind == 11) //Брокер стороны контрагента 
         locdeal.rec. = Codeparty(pcode,101);
      elif (pkind == 12) //Лицо, проводившее перерегистрацию по сделке 
         locdeal.rec. = Codeparty(pcode,101);
      elif (pkind == 13) //Лицо, проводившее перерегистрацию по обратной сделке
         locdeal.rec. = Codeparty(pcode,101);*/
      end;
      aux_buff = aux_buff + 1;
   end;

   // обработка PayInstrList - не обрабатываем
   /*
   aux_buff = 0;
   while(locdealdata.PayInstrList.size > aux_buff)
      pkind = locdealdata.PayInstrList[aux_buff].PayInstrKind;
      pcode = locdealdata.PayInstrList[aux_buff].PayInstr;
      pleg = 1;
      if (VALTYPE(locdealdata.PayInstrList[aux_buff].LegsNumber) != V_UNDEF)
         pleg = locdealdata.PayInstrList[aux_buff].LegsNumber;
      end;
      if (pleg==1)
         if (pkind == 1)
            locdeal.rec.PayInstr1 = pcode;
         elif  (pkind == 2)
            locdeal.rec.PayInstr2 = pcode;
         elif (pkind == 3)
            locdeal.rec.PayInstr3 = pcode;
         end;
      elif (pleg==2)
         if (pkind == 1)
            locdeal.rec.PayInstr21 = pcode;
         elif  (pkind == 2)
            locdeal.rec.PayInstr22 = pcode;
         elif (pkind == 3)
            locdeal.rec.PayInstr23 = pcode;
         end;
      end;
      aux_buff = aux_buff + 1;
   end;*/

   if (err_txt != "")
      retVal.Code = 1;
      retval.Text = err_txt;
      return retVal;
   end;

   //обработка по виду сделки
   var  basefiid;
   if ( (uTryToGetPropS(req_obj_serv.DealData, "IAMLDDeal") != V_UNDEF)
        and (ValType(req_obj_serv.DealData.IAMLDDeal) == V_GENOBJ)
        and (req_obj_serv.IdentityDeal.DealKind != "CSA")
      )
      //Проверка на дубль
      que = "select count(*) from ddl_tick_dbt where t_dealcode ='"+req_obj_serv.IdentityDeal.DealID+"'"; 
      rs0 = LnGetRecordset(que);
      if (rs0 != null)
         if (rs0.moveNext) 
            if ( rs0.value(0) > 0 )
               if (locdeal.rec.ActionType == "NEW")
                  err_txt="Сделка загружена ранее!";
               else
                  que = "select t_dealstatus, t_dealid from ddl_tick_dbt where t_dealcode = '"+req_obj_serv.IdentityDeal.DealID+"'"; 
                  rs0 = LnGetRecordset(que);
                  if (rs0 != null)
                     if (rs0.moveNext) 
                        if ( rs0.value(0) > 0 )
                           err_txt="По сделке "+req_obj_serv.IdentityDeal.DealID+" начата операция!";
                           if (strupr(locdeal.rec.ActionType) == "UPDATE")
                              err_txt=err_txt+" Обновление не возможно!";
                           elif (strupr(locdeal.rec.ActionType) == "DELETE")
                              err_txt=err_txt+" Удаление не возможно!";
                           end;
                        else
                           locdeal.rec.DEAL_ID = rs0.value(1);
                        end;
                     end;
                  end;
               end;
            else
               if (strupr(locdeal.rec.ActionType) == "DELETE")
                 err_txt="Не найдена Сделка "+req_obj_serv.IdentityDeal.DealID+" !";
               elif (locdeal.rec.ActionType == "UPDATE")
                 locdeal.rec.ActionType = "NEW"; //DEF-83081 Если приходит Update для отсутствующей сделки, то создадим ее
               end;
            end;
         end;
      end;

      if (err_txt == "")
      
         Obj = Ob_MBKDeal(req_obj_serv);
         retVal.Code = Obj.CreateDeal();
         retval.SOFRDealID = Obj.Get_ObjID();
         retval.Text = Obj.Get_Comment();
      
      else
         retVal.Code = 1;
         retval.Text = err_txt;
      end;

   elif ( (uTryToGetPropS(req_obj_serv.DealData, "IAMLDDeal") != V_UNDEF)
        and (ValType(req_obj_serv.DealData.IAMLDDeal) == V_GENOBJ)
        and (req_obj_serv.IdentityDeal.DealKind == "CSA")
      )
      //валюта соглашения и платежа
      basefiid = GetFiidCodeByName(locdealdata.DealData.IAMLDDeal.CurrencyDeals);

      if (locdeal.rec.ActionType != "NEW")
         err_txt="Сделка CSA! ";
         if (strupr(locdeal.rec.ActionType) == "UPDATE")
            err_txt=err_txt+" Обновление не возможно!";
         elif (strupr(locdeal.rec.ActionType) == "DELETE")
            err_txt=err_txt+" Удаление не возможно!";
         end;
         RunError(err_txt, c_err_obj(err_txt,-3000));
      end;

      //gtv: поиск по контрагенту, считаем, что CSA одно
      que = "select t_csaid from ddvcsa_dbt where t_partyid = '"+locdeal.rec.CONTR+"' and t_basecurrency = "+basefiid; 
      rs0 = LnGetRecordset(que);
      if ((rs0 != null) and rs0.moveNext() )
         err_txt = "Для контрагента "+locdeal.rec.CONTRNAME+" уже есть соглашение в валюте "+locdealdata.DealData.IAMLDDeal.CurrencyDeals;  
         RunError(err_txt, c_err_obj(err_txt,-3000));
      else
         Obj = Ob_CSAAgreement(req_obj_serv);
         retVal.Code = Obj.CreateDeal();
         retval.SOFRDealID = Obj.Get_ObjID();
         retval.Text = Obj.Get_Comment();
      end;

   elif ( (uTryToGetPropS(req_obj_serv.DealData, "MarginCallDeal") != V_UNDEF)
        and (ValType(req_obj_serv.DealData.MarginCallDeal) == V_GENOBJ)
        )
      //валюта соглашения и платежа
      basefiid = GetFiidCodeByName(locdealdata.DealData.MarginCallDeal.Currency);

      // BIQ-5049 если передан Object_Id, то данные пишем в примечания по переданной сделке
      if ( ValType(locdealdata.DealData.MarginCallDeal.Object_Id) != V_UNDEF)
         que = "select t_id, t_dockind from ddvndeal_dbt where t_code = '"+locdealdata.DealData.MarginCallDeal.Object_Id+"' "; 
         rs0 = LnGetRecordset(que);
         if ((rs0 != null) and rs0.moveNext() )
            //примечания
            var margin_typeObj, margin_notekind1, margin_notekind2;
            
            if (rs0.value("t_dockind") == 199)
               margin_typeObj = 145;
               margin_notekind1 = 401; // Чистое обеспечение
               margin_notekind2 = 402; // Код валюты чистого обеспечения
            else //4813 4815
               margin_typeObj = 148;
               margin_notekind1 = 0; // Чистое обеспечение
               margin_notekind2 = 0; // Код валюты чистого обеспечения
            end;

            if (margin_notekind1 > 0)
               var margin_objid = string(rs0.value("t_id"):o:34);
               var notedate = locdealdata.DealData.MarginCallDeal.SettlementDate;
               if (ValType(notedate) == V_UNDEF)
                  notedate = locdealdata.DealData.MarginCallDeal.TradeDate; // TradeDate - обязательный параметр
               end;
               var exist_amount = 0, exist_date; 

               var ins_sql = "DECLARE "+
                             "   v_Err VARCHAR2(2000); "+
                             "   v_cnt number(10); "+
                             "   v_rec USR_DVNDEAL_NOTE%ROWTYPE; "
                             "   v_dealcode     VARCHAR2(30 CHAR) := :dealcode; "+
                             "   v_marginid     VARCHAR2(30 CHAR) := :marginid; "+
                             "   v_typeaction   number(10)        := :typeaction; "+
                             "   v_margindate   date              := :margindate; "+
                             "   v_margintime   date              := :margintime; "+
                             "   v_notedate     date              := :notedate; "+
                             "   v_amount       number(32,2)      := :amount; "+
                             "   v_currency     varchar2(3)       := :currency; "+
                             "   v_flag         boolean; "
                             "BEGIN "+
                             "   v_flag := true; "+
                             "   BEGIN "+
                             "      SELECT * INTO v_rec FROM USR_DVNDEAL_NOTE "+
                             "       WHERE marginid = v_marginid  and typeaction = 1; "+
                             "      v_cnt := 1; "+
                             "   EXCEPTION "+
                             "      WHEN NO_DATA_FOUND THEN v_cnt := 0; "+
                             "      WHEN OTHERS THEN v_Err := 'Ошибка логирования '||SQLERRM; "+
                             "                  v_typeaction := -1; "+
                             "                  v_flag := false; "+
                             "   END; "
                             "   if v_typeaction = 1 and v_cnt > 0 then "+
                             "      v_Err := 'Объект '||v_marginid||' с типом = 1 уже был загружен'; "+
                             "      v_flag := false; "+
                             "   elsif v_typeaction = 2 and v_cnt = 0 then "+
                             "      v_Err := 'Объект '||v_marginid||' не найден'; "+
                             "      v_flag := false; "+
                             "   end if; "+
                             "   if v_flag then "+
                             "      if v_typeaction = 2 then "+
                             "         v_rec := null;  "+
                             "         select * INTO v_rec from USR_DVNDEAL_NOTE n1 "+
                             "          where marginid = v_marginid and id = (select max(id) from USR_DVNDEAL_NOTE n2 "+
                             "                                                 where n2.dealcode = n1.dealcode and n2.marginid = n1.marginid); "+
                             "      end if; "+
                             "      BEGIN "+
                             "         insert into USR_DVNDEAL_NOTE (dealcode, marginid, typeaction, margindate, margintime, notedate, amount, currency) "+
                             "         values (v_dealcode, v_marginid, v_typeaction, v_margindate, v_margintime, v_notedate, v_amount, v_currency); "+
                             "      EXCEPTION "+
                             "         WHEN OTHERS THEN v_Err := 'Ошибка логирования '||SQLERRM; "+
                             "      END; "+
                             "   end if; "+
                             "   :p_Err := v_Err; "+
                             "   :p_notedate := v_rec.notedate; "+
                             "   :p_amount := v_rec.amount; "+
                             "END;";
               var ins_cmd = RSDCommand(ins_sql);
               ins_cmd.AddParam("dealcode", RSDBP_IN, locdealdata.DealData.MarginCallDeal.Object_Id);
               ins_cmd.AddParam("marginid", RSDBP_IN, locdealdata.IdentityDeal.DealID);
               ins_cmd.AddParam("typeaction", RSDBP_IN, locdealdata.IdentityDeal.ActionType);
               ins_cmd.AddParam("margindate", RSDBP_IN, locdealdata.IdentityDeal.DealDate);
               ins_cmd.AddParam("margintime", RSDBP_IN, locdealdata.IdentityDeal.DealTime);
               ins_cmd.AddParam("notedate", RSDBP_IN, notedate);
               ins_cmd.AddParam("amount", RSDBP_IN, locdealdata.DealData.MarginCallDeal.Amount);
               ins_cmd.AddParam("currency", RSDBP_IN, locdealdata.DealData.MarginCallDeal.Currency);
               ins_cmd.AddParam("p_Err", RSDBP_OUT, v_string, 2000);
               ins_cmd.AddParam("p_notedate", RSDBP_OUT, v_date);
               ins_cmd.AddParam("p_amount", RSDBP_OUT, v_money);
               ins_cmd.execute;
               if ((ins_cmd.Value("p_Err") != null) and (ins_cmd.Value("p_Err") != nullval))
                  err_txt = ins_cmd.Value("p_Err");
                  RunError(err_txt, c_err_obj(err_txt,-3000));
               else 
                  exist_date = ins_cmd.Value("p_notedate");
                  exist_amount = ins_cmd.Value("p_amount");
               end;

               if (locdealdata.IdentityDeal.ActionType == 2) // обновление
                  if (exist_date != notedate)
                     err_txt="Запрещено при обновлении менять дату, существующая: "+exist_date+", передано: "+notedate;
                     RunError(err_txt, c_err_obj(err_txt,-3000));
                  end;
               end;

               //addNoteForObject( margin_typeObj, margin_objid, margin_notekind1, Money(abs(locdealdata.DealData.MarginCallDeal.Amount)));
               addNoteForObject( margin_typeObj, margin_objid, margin_notekind2, locdealdata.DealData.MarginCallDeal.Currency, notedate);

               // не остатки, а обороты
               var sql_f = "select n.notedate, n.amount from USR_DVNDEAL_NOTE n, "+
                           "  (  select max(id) id, dealcode, marginid "+
                           "       from USR_DVNDEAL_NOTE "+
                           "      where dealcode = :dealcode "+
                           "   group by dealcode, marginid) max_n "+
                           " where max_n.id  = n.id "+
                           " order by n.id ";
               var cmd_f = RSDCommand(sql_f);
               cmd_f.AddParam("dealcode", RSDBP_IN, locdealdata.DealData.MarginCallDeal.Object_Id);
               var rs_f = RSDRecordSet(cmd_f);
               var cho_exist = 0;
               while (rs_f.movenext)
                  cho_exist = cho_exist + Money(rs_f.value("amount"));
                  notedate = rs_f.value("notedate");
                  addNoteForObject( margin_typeObj, margin_objid, margin_notekind1, cho_exist, notedate);
               end;
            end;
            retval.SOFRDealID = rs0.value("t_id");
         else 
            err_txt="Не найдена сделка ФИССиКО с номером "+locdealdata.DealData.MarginCallDeal.Object_Id;
            RunError(err_txt, c_err_obj(err_txt,-3000));
         end;
      else
         //gtv: поиск по контрагенту, считаем, что CSA одно
         //que = "select t_csaid from ddvcsa_dbt where t_partyid = '"+locdeal.rec.CONTR+"' and t_basecurrency = "+basefiid; 
         // BIQ-5049 номер договора передается в теге Contract
         que = "select t_csaid from ddvcsa_dbt where t_code = '"+locdealdata.DealData.MarginCallDeal.Contract+"' ";  
         rs0 = LnGetRecordset(que);
         if ((rs0 != null) and rs0.moveNext() )
            if (locdeal.rec.ActionType == "NEW")
               locdeal.rec.DEAL_ID = rs0.value(0);
               var date_mp = locdealdata.DealData.MarginCallDeal.TradeDate;
               var date_next = locdealdata.DealData.MarginCallDeal.SettlementDate;
               // проверка на дубль
               que = "select count(*) from ddvcsapm_dbt where t_csaid = "+locdeal.rec.DEAL_ID+" and t_kind = 1 and t_date = to_date('"+date_mp+"','dd.mm.yyyy')";
               rs0 = LnGetRecordset(que);
               if ((rs0 != null) and rs0.moveNext())
                  if ( rs0.value(0) > 0 )
                     err_txt = "За дату "+date_mp+" уже есть платеж";  
                     RunError(err_txt, c_err_obj(err_txt,-3000));
                  end;
               end;

               cntpl = 0;
               if (StrUpr(locdealdata.IdentityDeal.BuySell) == "SELL") // Обязательства 
                  cntpl = 1;
               end;
               if ( not DV_InsertCSAMarginPayment(locdeal.rec.DEAL_ID,     // ID соглашения
                                                  date_mp,                 // дата оплаты
                                                  Money(abs(locdealdata.DealData.MarginCallDeal.Amount)), // сумма
                                                  basefiid,               // валюта
                                                  cntpl,                  // направление: требование / обязательство
                                                  null,                   // глушить сообение об ошибке
                                                  date_mp,                    //дата расчета
                                                  date_next,                  // дата следующего расчета
                                                  req_obj_serv.IdentityDeal.DealID) ) // комментарий
                  err_txt = "Error insert margin payment for deal: "+req_obj_serv.IdentityDeal.DealID;
                  RunError(err_txt, c_err_obj(err_txt,-3000));
               else
                  /*que = "update ddvcsapm_dbt set t_nextdate = to_date('"+date_next+"','dd.mm.yyyy') where t_csaid = "+locdeal.rec.DEAL_ID+" and t_kind = 1 and t_date = to_date('"+date_mp+"','dd.mm.yyyy')";
                  var ccccmd = RSDCommand(que);
                  ccccmd.execute;
                  ccccmd.close;*/
               end;
              
            else
               err_txt="Сделка CSA! ";
               if (strupr(locdeal.rec.ActionType) == "UPDATE")
                  err_txt=err_txt+" Обновление не возможно!";
               elif (strupr(locdeal.rec.ActionType) == "DELETE")
                  err_txt=err_txt+" Удаление не возможно!";
               end;
               RunError(err_txt, c_err_obj(err_txt,-3000));
            end;
         else
            //err_txt="Не найдено соглашение с контрагентом "+locdeal.rec.CONTR+" "+locdeal.rec.CONTRNAME+" !";
            err_txt="Не найдено соглашение с кодом "+ locdealdata.DealData.MarginCallDeal.Contract +"!";
            RunError(err_txt, c_err_obj(err_txt,-3000));
         end;
      end;

      if (err_txt == "")
         retVal.Code = 0;
         retval.Text = err_txt;
      else
         retVal.Code = 1;
         retval.Text = err_txt;
      end;

   elif ( ( (uTryToGetPropS(req_obj_serv.DealData, "BondDeal") != V_UNDEF)
             and (ValType(req_obj_serv.DealData.BondDeal) == V_GENOBJ) 
             //and (Workdays(locdealdata.IdentityDeal.DealDate,locdealdata.DealData.BondDeal.ValueDate)-1 < 3) 
           ) or 
          ( (uTryToGetPropS(req_obj_serv.DealData, "REPODeal") != V_UNDEF)
             and (ValType(req_obj_serv.DealData.REPODeal) == V_GENOBJ) 
           ) or 
          ( (uTryToGetPropS(req_obj_serv.DealData, "CurrencyEquityDeal") != V_UNDEF)
             and (ValType(req_obj_serv.DealData.CurrencyEquityDeal) == V_GENOBJ) 
           )
        )
        
      //Проверка на дубль
//      que = "select count(*) from ddl_tick_dbt where t_dealcode ='"+req_obj_serv.IdentityDeal.DealID+"'";
/* 20190228 - по актуальной информации код сделок Bond сохраняется в t_dealcodets (но сохраняем возможность поиска по t_dealcode) */
      que = "select count(*) from ddl_tick_dbt where '"+req_obj_serv.IdentityDeal.DealID+"' in (t_dealcode, t_dealcodets)";
      rs0 = LnGetRecordset(que);
      if (rs0 != null)
         if (rs0.moveNext) 
            if ( rs0.value(0) > 0 )
               if (locdeal.rec.ActionType == "NEW")
                  err_txt="Сделка загружена ранее!";
               else
//                  que = "select t_dealstatus, t_dealid from ddl_tick_dbt where t_dealcode = '"+req_obj_serv.IdentityDeal.DealID+"'"; 
/* 20190228 - по актуальной информации код сделок Bond сохраняется в t_dealcodets (но сохраняем возможность поиска по t_dealcode) */
                  que = "select t_dealstatus, t_dealid from ddl_tick_dbt where '"+req_obj_serv.IdentityDeal.DealID+"' in (t_dealcode, t_dealcodets)";
                  rs0 = LnGetRecordset(que);
                  if (rs0 != null)
                     if (rs0.moveNext) 
                        if ( rs0.value(0) > 0 )
                           err_txt="По сделке "+req_obj_serv.IdentityDeal.DealID+" начата операция!";
                           if (strupr(locdeal.rec.ActionType) == "UPDATE")
                              err_txt=err_txt+" Обновление не возможно!";
                           elif (strupr(locdeal.rec.ActionType) == "DELETE")
                              err_txt=err_txt+" Удаление не возможно!";
                           end;
                        else
                           locdeal.rec.DEAL_ID = rs0.value(1);
                        end;
                     end;
                  end;
               end;
            else
               if (strupr(locdeal.rec.ActionType) == "DELETE")
                 err_txt="Не найдена Сделка "+req_obj_serv.IdentityDeal.DealID+" !";
               elif (locdeal.rec.ActionType == "UPDATE")
                 locdeal.rec.ActionType = "NEW"; //DEF-83081 Если приходит Update для отсутствующей сделки, то создадим ее
               end;
            end;
         end;
      end;

      if (err_txt == "")
         if (locdealdata.IdentityDeal.DealKind == "BOND")
            Obj = Ob_BondDeal(req_obj_serv);
            retVal.Code = Obj.CreateDeal();
            retval.SOFRDealID = Obj.Get_ObjID();
            retval.Text = Obj.Get_Comment();
         elif (locdealdata.IdentityDeal.DealKind == "REPO")
            Obj = Ob_REPODeal(req_obj_serv);
            retVal.Code = Obj.CreateDeal();
            retval.SOFRDealID = Obj.Get_ObjID();
            retval.Text = Obj.Get_Comment();
         elif (locdealdata.IdentityDeal.DealKind == "EQUITY")
            Obj = Ob_EquityDeal(req_obj_serv);
            retVal.Code = Obj.CreateDeal();
            retval.SOFRDealID = Obj.Get_ObjID();
            retval.Text = Obj.Get_Comment();
         end;
      else
         retVal.Code = 1;
         retval.Text = err_txt;
      end;
   
   elif ( ( (uTryToGetPropS(req_obj_serv.DealData, "CurrencyDeal") != V_UNDEF)
            and (ValType(req_obj_serv.DealData.CurrencyDeal) == V_GENOBJ)
          ) or
          ( (uTryToGetPropS(req_obj_serv.DealData, "CurrencySWAPDeal") != V_UNDEF)
            and (ValType(req_obj_serv.DealData.CurrencySWAPDeal) == V_GENOBJ)
          ) or
          ( (uTryToGetPropS(req_obj_serv.DealData, "CurrencyFWDDeal") != V_UNDEF)
            and (ValType(req_obj_serv.DealData.CurrencyFWDDeal) == V_GENOBJ)
          ) or
/*          ( (uTryToGetPropS(req_obj_serv.DealData, "BondDeal") != V_UNDEF)
            and (ValType(req_obj_serv.DealData.BondDeal) == V_GENOBJ)
            and (Workdays(locdealdata.IdentityDeal.DealDate,locdealdata.DealData.BondDeal.ValueDate)-1 > 2)
          ) or*/
          ( (uTryToGetPropS(req_obj_serv.DealData, "FRADeal") != V_UNDEF)
            and (ValType(req_obj_serv.DealData.FRADeal) == V_GENOBJ)
          ) or
          ( (uTryToGetPropS(req_obj_serv.DealData, "CurrencyOptionDeal") != V_UNDEF)
            and (ValType(req_obj_serv.DealData.CurrencyOptionDeal) == V_GENOBJ)
          ) or
          ( (uTryToGetPropS(req_obj_serv.DealData, "IRSSWAPDeal") != V_UNDEF)
            and (ValType(req_obj_serv.DealData.IRSSWAPDeal) == V_GENOBJ)
          ) /*or
          ( (uTryToGetPropS(req_obj_serv.DealData, "CurrencySWAPOptionDeal") != V_UNDEF)
            and (ValType(req_obj_serv.DealData.CurrencySWAPOptionDeal) == V_GENOBJ)
          )*/
        )
      //Проверка на дубль
      que = "select count(*) from ddvndeal_dbt t where t_code='"+req_obj_serv.IdentityDeal.DealID+"'"; 
      rs0 = LnGetRecordset(que);
      if (rs0 != null)
         if (rs0.moveNext) 
            if ( rs0.value(0) > 0 )
               if (strupr(locdeal.rec.ActionType) == "NEW")
                  err_txt="Сделка загружена ранее!";
               else
                  que = "select t_state, t_id, t_dockind, t_csaid, t_genagrid from ddvndeal_dbt where t_code='"+req_obj_serv.IdentityDeal.DealID+"'"; 
                  rs0 = LnGetRecordset(que);
                  if (rs0 != null)
                     if (rs0.moveNext) 
                        //BIQ-5049 если сделка существует, то CSA все равно можем сменить
                        var CSAAgr;
                        var GenAgrFormCSAAgr;
                        if ( (ValType(req_obj_serv.IdentityDeal.GenAgreement) != V_UNDEF) and ( Index (req_obj_serv.IdentityDeal.GenAgreement,"CSA") > 0 ) )
                          CSAAgr = FindCSAGenAgreement(req_obj_serv.IdentityDeal.GenAgreement, err_txt, GenAgrFormCSAAgr); 
                        else 
                          CSAAgr = 0;
                        end;
                        if (CSAAgr != rs0.value("t_csaid")) // параметр отличается
                           var cmd_udp = RSDCommand("update ddvndeal_dbt set t_csaid = :c, t_genagrid = :g where t_id = :d ");
                           cmd_udp.AddParam("c", RSDBP_IN, CSAAgr);
                           if (CSAAgr == 0)
                              cmd_udp.AddParam("g", RSDBP_IN, rs0.value("t_genagrid"));
                           else 
                              cmd_udp.AddParam("g", RSDBP_IN, GenAgrFormCSAAgr.AgrID);
                           end;
                           cmd_udp.AddParam("d", RSDBP_IN, rs0.value("t_id"));
                           cmd_udp.execute;
                           cmd_udp.close;
                           err_txt = "По сделка начата операция, обновлено только соглашение CSA";
                        else
                          if ( rs0.value(0) > 0 )
                             err_txt="По сделке "+req_obj_serv.IdentityDeal.DealID+" начата операция!";
                             if (strupr(locdeal.rec.ActionType) == "UPDATE")
                                err_txt=err_txt+" Обновление не возможно!";
                             elif (strupr(locdeal.rec.ActionType) == "DELETE")
                                err_txt=err_txt+" Удаление не возможно!";
                             end;
                          else
                             locdeal.rec.DEAL_ID = rs0.value(1);
                             locdeal.rec.Dockind = rs0.value(2);
                          end;
                        end;
                     end;
                  end;
               end;
            else
               if (strupr(locdeal.rec.ActionType) == "DELETE")
                 err_txt="Не найдена Сделка "+req_obj_serv.IdentityDeal.DealID+" !";
               elif (locdeal.rec.ActionType == "UPDATE")
                 locdeal.rec.ActionType = "NEW"; //DEF-83081 Если приходит Update для отсутствующей сделки, то создадим ее
               end;
            end;
         end;
      end;

      if (err_txt == "")
       if (pre_del_check (req_obj_serv) == 1)
         Obj = Ob_CurDeal(req_obj_serv);
         retVal.Code = Obj.CreateDeal();
         retval.SOFRDealID = Obj.Get_ObjID();
         retval.Text = Obj.Get_Comment();
       end;
      else
         retVal.Code = 1;
         retval.Text = err_txt;
      end;
   else
      retVal.Code = 1;
      retval.Text = "Не верный тип сделки!";
   end;

   return retVal;
end;

/**
@brief Функция определения необходимости фильтрации отправляемого по email сообщения
@return V_BOOL true - сообщение не отправляется
*/
private macro IsSuppressedError(statusCode: Integer, statusMessage: String)
  var i = 0;
  
  while (i < errorFilterRecs.size)
    if ((errorFilterRecs(i).errorCode == statusCode) and
        (Index(statusMessage, errorFilterRecs(i).errorMessagePart) > 0))
      return true;
    end;
  
    i = i + 1;
  end;
  
  return false;
end;

/**
@brief Процедура отправки сообщения саппорту об ошибке обработки сделок
*/
private macro NotifySupportProcessingError(statusCode: Integer, statusMessage: String, isForcedSend: Bool)
  if ((not isForcedSend) and IsSuppressedError(statusCode, statusMessage))
    return;
  end;
  
  var email = Bnk_GetRegistryValue(REGPATH_KONDORPROCESSING_SUPPORTEMAIL, V_STRING, "");
  
  if (StrLen(email) == 0)
    return;
  end;
  
  SendEmailSynch(KONDORPROCESSING_EMAIL_ERROREXIST_SUBJECT,
                 KONDORPROCESSING_EMAIL_ERROREXIST_MESSAGE + 
                   "\n\nКод ошибки: " + statusCode +
                   "\nТекст ошибки: " + statusMessage,
                 email);
end;

/**
@brief Процедура обновления статуса создания сделки в таблице Kondor_SOFR_Buffer_dbt
*/
macro UpdateDealProcessingStatus(inputObject, statusCode: Integer, statusMessage: String)
  if (ValType(inputObject) == V_UNDEF)
    return;
  end;
  
  var sequenceType;
  var requestType = IIF(inputObject.IdentityDeal.ActionType == 1, "N",
                    IIF(inputObject.IdentityDeal.ActionType == 2, "U",
                    IIF(inputObject.IdentityDeal.ActionType == 3, "D", "не опред.")));
  var isSofrGenIDExists: Bool = false;
  var isForcedSend: Bool = false;
  
  var whereCondition = "WHERE (t_dateComplete = to_date('01.01.0001', 'DD.MM.YYYY') or t_dateComplete IS NULL) " +
                         "AND t_reqType = :reqType ";
  if ((inputObject.IdentityDeal.ActionType == 1) and
      (ValType(inputObject.IdentityDeal.SofrGenID) == V_INTEGER) and
      (inputObject.IdentityDeal.SofrGenID > 0))
    whereCondition = whereCondition +
                         "AND t_seqType = :seqType " +
                         "AND t_seqID = :seqID ";
    isSofrGenIDExists = true;
    sequenceType = GetSequenceType(inputObject);
  else
    whereCondition = whereCondition +
                         "AND t_dealCode = :dealCode1 " +
                         "AND t_recID = (SELECT MAX(t_recID) FROM Kondor_SOFR_Buffer_dbt " +
                                        "WHERE (t_dateComplete = to_date('01.01.0001', 'DD.MM.YYYY') or t_dateComplete IS NULL) AND t_dealCode = :dealCode2) ";
  end;
  
  var cmd = RSDCommand("DECLARE " +
                         "v_executionTime NUMBER(10) := 0; " +
                         "v_updatedCount NUMBER(10) := 0; " +
                       "BEGIN " +
                         "UPDATE Kondor_SOFR_Buffer_dbt " +
                            "SET t_errorStatus = :errorStatus, " +
                                "t_errorMessage = :errorMessage, " +
                                "t_dateComplete = SYSDATE " +
                          whereCondition +
                         "RETURNING MAX((t_datecomplete - t_datecreate)*86400), COUNT(1) " +
                              "INTO v_executionTime, v_updatedCount; " +
                         ":executionTime := v_executionTime; " +
                         ":updatedCount := v_updatedCount; " +
                       "END;");
  cmd.AddParam("errorStatus", RSDBP_IN, statusCode);
  cmd.AddParam("errorMessage", RSDBP_IN, statusMessage);
  cmd.AddParam("reqType", RSDBP_IN, requestType);
  
  if (isSofrGenIDExists)
    cmd.AddParam("seqType", RSDBP_IN, sequenceType);
    cmd.AddParam("seqID", RSDBP_IN, inputObject.IdentityDeal.SofrGenID);
  else
    cmd.AddParam("dealCode1", RSDBP_IN, inputObject.IdentityDeal.DealID);
    cmd.AddParam("dealCode2", RSDBP_IN, inputObject.IdentityDeal.DealID);
  end;
  
  cmd.AddParam("executionTime", RSDBP_OUT, V_INTEGER);
  cmd.AddParam("updatedCount", RSDBP_OUT, V_INTEGER);
  cmd.Execute();
  
  var executionTimeLimit = Bnk_GetRegistryValue(REGPATH_KONDORPROCESSING_EXECUTIONTIMELIMIT, V_INTEGER, -1);
  var updatedCount = SQL_ConvTypeInteger(cmd.Value("updatedCount"));
  var executionTime = SQL_ConvTypeInteger(cmd.Value("executionTime"));
  cmd.Close();
  
  if (updatedCount == 0)
    cmd = RSDCommand("INSERT INTO Kondor_SOFR_Buffer_dbt " +
                           "(t_requestID, " +
                            "t_reqType, " +
                            "t_dealCode, " +
                            "t_seqID, " +
                            "t_seqType, " +
                            "t_ErrorStatus, " +
                            "t_ErrorMessage, " +
                            "t_DateCreate, " +
                            "t_DateComplete) " +
                    "VALUES (null, " +
                            ":reqType, " +
                            ":dealCode, " +
                            "null, " +
                            ":seqType, " +
                            ":errorStatus, " +
                            ":errorMessage, " +
                            "SYSDATE, " +
                            "SYSDATE)");
    cmd.AddParam("reqType", RSDBP_IN, IIF(StrLen(requestType) == 1, requestType, null));
    cmd.AddParam("dealCode", RSDBP_IN, inputObject.IdentityDeal.DealID);
    cmd.AddParam("seqType", RSDBP_IN, sequenceType);
    cmd.AddParam("errorStatus", RSDBP_IN, statusCode);
    cmd.AddParam("errorMessage", RSDBP_IN, statusMessage);
    cmd.Execute();
    cmd.Close();
  elif (updatedCount > 1)
    if (statusCode == 0)
      statusCode = 1;
    end;
    
    statusMessage = statusMessage + "\nПри обновлении статуса загрузки сделки " + inputObject.IdentityDeal.DealID +
                                    " в таблице Kondor_SOFR_Buffer_dbt обновлено " + updatedCount + " записей";
    isForcedSend = true;
  end;
  
  if ((executionTimeLimit > 0) and (executionTime > executionTimeLimit))
    if (statusCode == 0)
      statusCode = 1;
    end;
    
    statusMessage = statusMessage + "\nПри обработке запроса '" + requestType + "' по сделке " + inputObject.IdentityDeal.DealID +
                                    "\nпревышено пороговое время обработки. Запрос обработан за " + executionTime + " секунд";
    isForcedSend = true;
  end;
  
  if (statusCode != 0)
    NotifySupportProcessingError(statusCode, statusMessage, isForcedSend);
  end;

OnError(err)
  NewLogger(c_logger.IT_LOG_TYPE, "Kondor.ws_impdeals").Error("Ошибка процедуры UpdateDealProcessingStatus: " + GetFullErrMsg(err));
end;