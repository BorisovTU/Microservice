/**
 @file uentcompare_class.mac
 @brief Интеграция с внешними системами. Класс отчет-сверки проводок, выгруженных в ЦФТ из СОФР

 # tag
 - functional_block: Отчетность_внутренняя
 - code_type: Report

 # changelog
 |date       |autor          |tasks                                           |note
 |-----------|---------------|------------------------------------------------|-------------------------------------------------------------
 |21.11.2024 |Велигжанин А.В.|BOSS-4204_BOSS-6720                             |Добавление в отчет сумм ЦФТ
 |25.09.2024 |Велигжанин А.В.|DEF-71583                                       |Использование GetExportPath(), см. ucompare_func.mac
 |27.10.2023 |Гераськина Т.В.|DEF-51036 ОТКАТ                                 |Откат изменений по 51036
 |24.10.2023 |Велигжанин А.В.|DEF-52575                                       |Реализован класс отчета-сверки с локальной работой c Excel
 |           |               |                                                | см. class c_EntCompare()
 |12.10.2023 |Гераськина Т.В.|DEF-51036                                       |SD9872809||Некорректная работа отчета в части сравнения проводок
 |           |               |                                                | Исключены проводки 306Т-306
 |           |               |                                                | Для проводок зачисления (408-306) добавлен поиск по upmbiscotto 
 |           |               |                                                | Изменены условия для клиентских платежей (306-303)
 |17.05.2019 |Киселев А.Л.   |                                                |
*/

import globals, ActiveX, oralib, likepy, rsexts;
import "global_utils_intgr.mac", "u_common_email_utils.mac";
IMPORT "uentcompare_param.mac";
IMPORT "uentcompare_const.mac";
IMPORT "cblogger.mac";
import "dlutils.mac";
import "ucompare_func.mac";    // DEF-66506, DEF-71583
import "scsrvrepfun.mac";
 
private const EXPORT_XML_FILENAME_TXT = "for_entcompare",
              CV_EMAIL_GRP_ETCOMPARE = 3; //группа сверки проводок загруженных в ЦФТ из СОФР

private const Excel_RUS = 1049, //значение локализации для русского Excel
              HEADER_FILENAME_TXT = "header_entcompare",
              BODY_FILENAME_TXT = "body_entcompare",
              FOOTER_FILENAME_TXT = "footer_entcompare"; 

private const xlPasteFormats = -4122,
              xlContinuous = 1,
              xlMedium = -4138,
              xlThin = 2,
              xlNone = -4142,
              xlEdgeLeft = 7,
              xlEdgeTop = 8,
              xlEdgeBottom = 9,
              xlEdgeRight = 10,
              xlDiagonalDown = 5,
              xlDiagonalUp = 6,
              xlInsertDeleteCells = 1,
              xlDelimited = 1,
              xlTextQualifierNone = -4142,
              xlRight  = -4152,
              xlLeft   = -4131,
              xlCenter = -4108,
              xlThemeColorLight1 = 2,
              xlThemeColorDark1 = 1,
              xlThemeColorDark2 = 3,
              xlLandscape = 2,

              SymbSeparator = "|";


private var LocalPathExcel = "",
            XLSExport_Path :string = "",
            CellNumX :integer,
            CellNumY :integer,
            CellNumDeltaY :integer = 0,
            CntAccountRow :integer = 0,
            CellYSectionBodySeparate :TArray = TArray(),
            SizeOfHeader :integer = 9, //3,
            SizeOfDeltaHeader :integer = 7,
            SizeOfFooter :integer = 5, //7,
            Max_X :integer = 13, //количество колонок
            PartyCnt :integer = 0,
            RowCnt :integer = 0,
            CNum = string(UserNumber),
            ExcelLanguage = 0,
            ExcelDecimalSeparator = "",
            FlOpenTxtFile :bool = false;

/**
 @brief класс отчета-сверки (с локальной работой c Excel)
*/
class c_EntCompare ()
  VAR
    LocalStartAX          : Object = null,   /* объект для запуска ActiveX-приложений */
    LocalExcelApplication : Object = null,   /* Приложение MS-Excel     */
    LocalActiveSheet      : Object = null    /* Активная страница Excel */
  ;

  //из массива объектов формируем SQL-строку
  private macro GetSQLStrFromArray( ParamProcess :object );
  const BEGIN_SQL_STR = " SELECT ",
        END_SQL_STR = " FROM DUAL ",
        SEPARATOR = ", ";

  var Query :string = "",
      i :integer = 0,
      fl_first_str :bool = false;
  var load_all:bool = false;

   if (ValType( uTryToGetPropS( ParamProcess, "AccEntries" ) ) == V_UNDEF) 
     load_all = true;
   else 
     if (ValType( ParamProcess.AccEntries ) == V_UNDEF)
       load_all = true;
     else 
       if ( ParamProcess.AccEntries.Size == 0 ) 
         load_all = true;
       end;
     end;
   end;

   if( load_all )
    Query = " SELECT -1 AS ID, '' AS PERSN, '' AS ACC_D, '' AS ACC_C FROM DUAL ";
   else

    while( i < ParamProcess.AccEntries.Size )
     if( ( ParamProcess.AccEntries[i].PersN != "-1" ) and ( ParamProcess.AccEntries[i].PayerAccount != "-1" ) and ( ParamProcess.AccEntries[i].ReceiverAccount != "-1" ) ) //признак неудаленного элемента массива

      if( fl_first_str )
       Query = Query + " UNION ALL ";
      else
       fl_first_str = true;
      end;

      Query = Query + BEGIN_SQL_STR + string(i) + " AS ID" + SEPARATOR + GetSQLString( ParamProcess.AccEntries[i].PersN ) + " AS PERSN" + SEPARATOR + GetSQLString( ParamProcess.AccEntries[i].PayerAccount ) + " AS ACC_D" + SEPARATOR + GetSQLString( ParamProcess.AccEntries[i].ReceiverAccount ) + " AS ACC_C" + END_SQL_STR;
     end;
     i = i + 1;
    end;

   end;

   if( Query == "" )
    Query = " SELECT -1 AS ID, '' AS PERSN, '' AS ACC_D, '' AS ACC_C FROM DUAL "; //все элементы были удалены
   end;

   Query = Query + " ORDER BY 1";

   return Query;

  end;



   /*
      Новая Excel-книга  без шаблона
      Входные параметры (необязательные):
         Visible       - признак отображения приложения на экране;
   */
   private macro NewExcelWorkbook_ ( Visible, ExcelFileName :string )

    if(LocalExcelApplication == null)
       if (isStandAlone())
          LocalExcelApplication = ActiveX("Excel.Application", null, true);
       else
          if (LocalStartAX == null)
             LocalStartAX = CreateObject("rsax", "TRsAxServer", "LoansAxServer", isStandalone());
          end;
          LocalExcelApplication = LocalStartAX.CreateComObject("Excel.Application");
       end;
    end;

    if( (Valtype(ExcelFileName) == V_UNDEF) or (Valtype(ExcelFileName) == 26) )
     LocalExcelApplication.Workbooks.Add(1);
    else
     LocalExcelApplication.Workbooks.Add( ExcelFileName );
    end;

    if (not LocalExcelApplication.Ready())
      //т.к. мы имеем дело с excel, да ещё и иногда запускаемом под tomcat, то сюрпризы не исключены
      //короткое гугление показывает, что отказ в исполнении команд для excel - частый случай
      //причины при этом могут быть всякими, от появившегося диалога с вопросом что excel не является приложением по умолчанию,
      //до слетевшей лицензии
      //на всякий случай тут после открытия книги, если excel ещё не готов, сделаем разовую паузу в 3 секунды
      RslWait(3000);
    end;

    LocalExcelApplication.DisplayAlerts = false;

    if (ValType (Visible) == V_BOOL)
      LocalExcelApplication.Visible = Visible;
    end;
    LocalActiveSheet = LocalExcelApplication.ActiveSheet;
    return true;
   end; // NewExcelWorkbook_

   private macro TranslateExcelFormula(Formula :string, LocalCode :integer) :string // получаем название формулы на языке локализации RUS / US International
   const Excel_RUS = 1049;                                                          // по любому из двух извесных названий
   var RUS_Formula :TArray,
       US_Formula :TArray,
       Index_;

    RUS_Formula = MakeArray("ЕСЛИ","СУММ","ОКРУГЛ");
    US_Formula = MakeArray("IF", "SUM","ROUND");

    Index_ = find( RUS_Formula, Formula );
    if( Index_ < 0 )
     Index_ = find( US_Formula, Formula );
     if( Index_ < 0 )
      return Formula;
     end
    end;
    if ( LocalCode == Excel_RUS)
     return RUS_Formula[Index_];
    else
     return US_Formula[Index_];
    end
   end;


   private macro GetFormatedField(FieldValue :variant, FirstSeparator :string, LastSeparator :string) :string //форматировать значение поля и цеплять разделители
   var SepPos :integer = 0,
       SymSep :string = ",.";

    if( (ValType(FieldValue) ==  V_UNDEF) or (ValType(FieldValue) ==  V_STRING) and (FieldValue == "") or (ValType(FieldValue) ==  26) or
     (ValType(FieldValue) ==  V_DATE) and ( (string(FieldValue) == " 1.01.0001") or (FieldValue == date("00.00.0000")) ) )
     return FirstSeparator + "" + LastSeparator;
    else
     if( (ValType(FieldValue) ==  V_DATE) or (ValType(FieldValue) ==  V_DTTM) )
      FieldValue = StrSubst( string(date(FieldValue):10), " ", "0" );
     elif( ((ValType(FieldValue) ==  V_MONEY) or (ValType(FieldValue) ==  V_DOUBLE)) and (Index(FieldValue, ExcelDecimalSeparator) == 0) )
      FieldValue = string(FieldValue);
      if( ExcelDecimalSeparator == ",")
       SepPos = Index(FieldValue,".");
      else
       SepPos = Index(FieldValue,",");
      end;
      if( SepPos > 0)
       FieldValue = SubStr( FieldValue, 1, SepPos - 1 ) + ExcelDecimalSeparator + SubStr( FieldValue, SepPos+1 );
      end;
     end;
      return FirstSeparator + string(FieldValue) + LastSeparator;
    end;
   end;

  private macro AddEntCompareParam( p_Id, p_PersN, p_AccD, p_AccC )
    var sql :string = ""
        , cmd
    ;
    sql =  "BEGIN "
         + "  cft_utils.CFT_AddEntCompareParam(:p_Id, :p_PersN, :p_AccD, :p_AccC); "
         + "END; "
    ;
    cmd = RSDCommand(sql);
    cmd.AddParam("p_Id", RSDBP_IN, p_Id);
    cmd.addParam("p_PersN", RSDBP_IN, p_PersN);
    cmd.addParam("p_AccD", RSDBP_IN, p_AccD);
    cmd.addParam("p_AccC", RSDBP_IN, p_AccC);
    cmd.execute();
  end;

  //получим курсор (для "отчета-сверки 24")
  private macro GetDataSet_24( DataSet :@RsdRecordset, QueryType :integer, ReqId :string, ParamProcess :object ) :integer
    var sql :string = ""
        , Params :TArray
        , FlAcc :integer = 0
        , SQLStrFromArray :string = ""
        , cmd
        , i : integer = 0
        , error
    ;

    // Формирование данных uEntCompareParam_tmp
    // Таблица используется для фильтрации сравниваемых данных
    // При получении ID = -1 или 0, будет производиться предварительное обнуление предыдущих данных
    if( (ValType( uTryToGetPropS( ParamProcess, "AccEntries" ) ) == V_UNDEF) or (ValType( ParamProcess.AccEntries ) == V_UNDEF) or ( ParamProcess.AccEntries.Size == 0 ) )
      AddEntCompareParam(-1, "", "", "");
    else
      while( i < ParamProcess.AccEntries.Size )
        AddEntCompareParam(i, ParamProcess.AccEntries[i].PersN, ParamProcess.AccEntries[i].PayerAccount, ParamProcess.AccEntries[i].ReceiverAccount);
        i = i + 1;
      end;
    end;

    // Вызов процедуры формирования расхождений
    sql =  "DECLARE "
         + "  x_rows number; "
         + "BEGIN "
         + "  x_rows := cft_utils.CFT_CreateCompare(:x_ReqID, :InDate); "
         + "END; "
    ;
    cmd = RSDCommand(sql);
    cmd.AddParam("ReqID", RSDBP_IN, ReqID);
    cmd.addParam("InDate", RSDBP_IN, ParamProcess.DateIn);
    cmd.execute();

    // Запрос расхождений
    sql = "SELECT r.t_idbiscotto, r.t_acctrnid, r.t_docnum, r.t_acct_db, r.t_acct_cr "
       + ", r.t_currency, r.t_amtcur, r.t_amtrub, r.t_opdate "
       + ", cft_utils.GetStrEventErr( r.t_err, 1, 1 ) AS T_ERR_TEXT "
       + ", r.t_details, 0 AS T_OPER, '' AS T_MODULE "
       + ", r.t_cftcur, r.t_cftrub "
       + " FROM uentcomparetest_tmp r WHERE r.t_err > 0 "
    ;
    DataSet = execSQLselect( sql, null );
    return 0;
  onError(err)
    return 1;
  end;

  //получим курсор (для тестовой выборки)
  private macro GetDataSet_test( DataSet :@RsdRecordset, QueryType :integer, ReqId :string, ParamProcess :object ) :integer
  var Query :string = "",
      Params :TArray,
      FlAcc :integer = 0,
      SQLStrFromArray :string = "",
      error;

    Query =   
             "  SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB, " +
  "\n"+      "         T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 1 AS T_ERR_CODE, " +
  "\n"+      "         USR_PKG_IMPORT_SOFR.GetStrEventErr( 0, 1, T_ACCTRNID ) AS T_ERR_TEXT, " +
  "\n"+      "         0 AS T_OPER, '' AS T_MODULE, 0 AS t_cftcur, 0 AS t_cftrub " +
  "\n"+      "    FROM uloadentforcompare_dbt C " +
  "\n"+      "   WHERE rownum < 4";
    DataSet = execSQLselect( Query, null );
   return 0;
  onError(err)
   return 1;
  end;

  //получим курсор
  private macro GetDataSet( DataSet :@RsdRecordset, QueryType :integer, ReqId :string, ParamProcess :object ) :integer
  var Query :string = "",
      Params :TArray,
      FlAcc :integer = 0,
      SQLStrFromArray :string = "",
      error;

   if( QueryType == 0 )



    //курсор в tmp
    DataSet = Null;
    SQLStrFromArray = GetSQLStrFromArray( ParamProcess );


    Query =   
              // --из СОФР в ЦФТ проводки ЦФТ отсутствуют в СОФР кроме полу-проводок
             "  SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB, " +
  "\n"+      "         T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 1 AS T_ERR_CODE, " +
  "\n"+      "         USR_PKG_IMPORT_SOFR.GetStrEventErr( 0, 1, T_ACCTRNID ) AS T_ERR_TEXT, " +
  "\n"+      "         0 AS T_OPER, '' AS T_MODULE, 0 AS t_cftcur, 0 AS t_cftrub " +
  "\n"+      "    FROM uloadentforcompare_dbt C " +
  "\n"+      "   WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
  "\n"+      "                      WHERE V.T_BISCOTTOID = C.T_IDBISCOTTO ) " +
  "\n"+      "     AND  C.T_AUTOKEY NOT IN  " +
  "\n"+      "        ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dacctrn_dbt B " +
  "\n"+      "                                 , ( " + SQLStrFromArray + " ) Z " +
  "\n"+      "           WHERE A.T_REQID = '"+Reqid+"' " +
  "\n"+      "             AND ( Z.ID < 0 " +
  "\n"+      "                   OR ( Z.ACC_D = CHR(1) " +
  "\n"+      "                        OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_ACCOUNT_PAYER ) > 0 ) " +
  "\n"+      "                  AND ( Z.ACC_C = CHR(1) " +
  "\n"+      "                        OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_ACCOUNT_RECEIVER ) > 0 ) " +
  "\n"+      "                  AND ( Z.PERSN = CHR(1) " +
  "\n"+      "                        OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE " +
  "\n"+      "                                                                                 WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                                 WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
  "\n"+      "                                                                                 WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
  "\n"+      "                                                                                 ELSE Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                               END ) AS T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                       FROM ( SELECT NVL(( SELECT U.T_NAME FROM dllvalues_dbt U " +
  "\n"+      "                                                                                            WHERE U.T_LIST = 5005 " +
  "\n"+      "                                                                                              AND U.T_ELEMENT = B.T_NUMBER_PACK ), '9090909') AS CNTRPERSNUMBER, " +
  "\n"+      "                                                                                     NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
  "\n"+      "                                                                                             WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
  "\n"+      "                                                                                                               WHERE V.T_OBJECTTYPE = 92 " +
  "\n"+      "                                                                                                                 AND V.T_NOTEKIND = 200 " +
  "\n"+      "                                                                                                                 AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
  "\n"+      "                                                                                                                 AND V.T_DATE <= B.T_DATE_CARRY ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
  "\n"+      "                                                                                     ( CASE " +
  "\n"+      "                                                                                          WHEN B.T_DEPARTMENT = 1 THEN '0000' " +
  "\n"+      "                                                                                          ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
  "\n"+      "                                                                                                  WHERE W.T_CODE = B.T_DEPARTMENT ) " +
  "\n"+      "                                                                                       END ) AS T_BRANCH " +
  "\n"+      "                                                                                FROM DUAL ) Y ) ) > 0 ) " +
  "\n"+      "                  ) " +
  "\n"+      "             AND EXISTS( SELECT 1 FROM  utableprocessevent_dbt D " +
  "\n"+      "                          WHERE D.T_OBJECTID = A.T_ACCTRNID " +
  "\n"+      "                            AND D.T_OBJECTTYPE IN (1, 501) " +
  "\n"+      "                            AND D.T_TYPE = 1 " +
  "\n"+      "                            AND (   (D.T_STATUS IN(4, 5) " +
  "\n"+      "                                       AND D.T_MESSAGEID IS NOT NULL " +
  "\n"+      "                                       AND D.T_MESSAGEID > 0) " +
  "\n"+      "                                 or (D.T_STATUS IN(-45) and (t_note is NULL))) " +
  "\n"+      "                            AND NOT EXISTS( SELECT 1 FROM utableprocessevent_dbt I " +
  "\n"+      "                                             WHERE I.T_OBJECTID = D.T_OBJECTID " +
  "\n"+      "                                               AND I.T_OBJECTTYPE = D.T_OBJECTTYPE " +
  "\n"+      "                                               AND I.T_TYPE = 3 " +
  "\n"+      "                                               AND I.T_RECID >  D.T_RECID ) ) " +
  "\n"+      "             AND A.T_OPDATE BETWEEN to_date('"+ParamProcess.DateIn+"','dd.mm.yyyy') AND to_date('"+ParamProcess.DateOut+"','dd.mm.yyyy') " +
  "\n"+      "             AND A.T_OPDATE = B.T_DATE_CARRY " +
  "\n"+      "             AND B.T_DATE_CARRY = A.T_OPDATE " +
  "\n"+      "             AND B.T_ACCTRNID = A.T_ACCTRNID ) " +
  "\n"+      "     AND C.T_REQID = '"+Reqid+"' " +
  "\n"+      "     AND C.T_ACCTRNID > 0 " +
  "\n"+      "     AND C.T_ACCT_DB IS NOT NULL " +
  "\n"+      "     AND C.T_ACCT_CR IS NOT NULL " +
  //shev biq-8113
  "\n"+      "     AND nvl(C.not_loaded,chr(0)) <> chr(88) " +
             
  "\n"+      "  UNION ALL " +

              // --из СОФР в ЦФТ проводки ЦФТ отсутствуют в СОФР только полу-проводоки
  "\n"+      "  SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB, " +
  "\n"+      "         T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 1 AS T_ERR_CODE, " +
  "\n"+      "         USR_PKG_IMPORT_SOFR.GetStrEventErr( 0, 1, T_ACCTRNID ) AS T_ERR_TEXT, " +
  "\n"+      "         0 AS T_OPER, '' AS T_MODULE, 0 AS t_cftcur, 0 AS t_cftrub " +
  "\n"+      "    FROM uloadentforcompare_dbt C " +
  "\n"+      "   WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
  "\n"+      "                      WHERE V.T_BISCOTTOID = C.T_IDBISCOTTO ) " +
  "\n"+      "     AND C.T_AUTOKEY NOT IN " +
  "\n"+      "         ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dacctrn_dbt B " +
  "\n"+      "                                    , ( " + SQLStrFromArray + " ) Z " +
  "\n"+      "            WHERE A.T_REQID = '"+Reqid+"' " +
  "\n"+      "              AND ( Z.ID < 0 " +
  "\n"+      "                    OR ( Z.ACC_D = CHR(1) " +
  "\n"+      "                         OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_ACCOUNT_PAYER ) > 0 ) " +
  "\n"+      "                   AND ( Z.ACC_C = CHR(1) " +
  "\n"+      "                         OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_ACCOUNT_RECEIVER ) > 0 ) " +
  "\n"+      "                   AND ( Z.PERSN = CHR(1) " +
  "\n"+      "                         OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE " +
  "\n"+      "                                                                                  WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                                  WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
  "\n"+      "                                                                                  WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
  "\n"+      "                                                                                  ELSE Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                               END ) AS T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                        FROM ( SELECT NVL( ( SELECT U.T_NAME FROM dllvalues_dbt U " +
  "\n"+      "                                                                                              WHERE U.T_LIST = 5005 " +
  "\n"+      "                                                                                                AND U.T_ELEMENT = B.T_NUMBER_PACK ), '9090909') AS CNTRPERSNUMBER, " +
  "\n"+      "                                                                                      NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
  "\n"+      "                                                                                              WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
  "\n"+      "                                                                                                                WHERE V.T_OBJECTTYPE = 92 " +
  "\n"+      "                                                                                                                  AND V.T_NOTEKIND = 200 " +
  "\n"+      "                                                                                                                  AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
  "\n"+      "                                                                                                                  AND V.T_DATE <= B.T_DATE_CARRY ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
  "\n"+      "                                                                                       ( CASE " +
  "\n"+      "                                                                                            WHEN B.T_DEPARTMENT = 1 THEN '0000' " +
  "\n"+      "                                                                                            ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
  "\n"+      "                                                                                                    WHERE W.T_CODE = B.T_DEPARTMENT ) " +
  "\n"+      "                                                                                         END ) AS T_BRANCH " +
  "\n"+      "                                                                                 FROM DUAL ) Y ) ) > 0 ) " +
  "\n"+      "                   ) " +
  "\n"+      "              AND EXISTS( SELECT 1 FROM  utableprocessevent_dbt D " +
  "\n"+      "                           WHERE D.T_OBJECTID = A.T_ACCTRNID " +
  "\n"+      "                             AND D.T_OBJECTTYPE IN (1, 501) " +
  "\n"+      "                             AND D.T_TYPE = 1 " +
  "\n"+      "                             AND D.T_STATUS IN(4, 5) " +
  "\n"+      "                             AND D.T_MESSAGEID IS NOT NULL " +
  "\n"+      "                             AND D.T_MESSAGEID > 0 " +
  "\n"+      "                             AND NOT EXISTS( SELECT 1 FROM utableprocessevent_dbt I " +
  "\n"+      "                                              WHERE I.T_OBJECTID = D.T_OBJECTID " +
  "\n"+      "                                                AND I.T_OBJECTTYPE = D.T_OBJECTTYPE " +
  "\n"+      "                                                AND I.T_TYPE = 3 " +
  "\n"+      "                                                AND I.T_RECID >  D.T_RECID ) ) " +
  "\n"+      "              AND A.T_OPDATE BETWEEN to_date('"+ParamProcess.DateIn+"','dd.mm.yyyy') AND to_date('"+ParamProcess.DateOut+"','dd.mm.yyyy') " +
  "\n"+      "              AND B.T_DATE_CARRY = A.T_OPDATE " +
  "\n"+      "              AND B.T_ACCTRNID = A.T_ACCTRNID ) " +
  "\n"+      "     AND C.T_REQID = '"+Reqid+"' " +
  "\n"+      "     AND C.T_ACCTRNID > 0 " +
  "\n"+      "     AND  ( C.T_ACCT_DB IS NULL AND C.T_ACCT_CR IS NOT NULL " +
  "\n"+      "            OR C.T_ACCT_DB IS NOT NULL AND C.T_ACCT_CR IS NULL ) " +
  //shev biq-8113
  "\n"+      "     AND nvl(C.not_loaded,chr(0)) <> chr(88) " +

  "\n"+      "  UNION ALL " +

              // --из СОФР в ЦФТ проводки ЦФТ присутствуют в СОФР, не соответствуют реквизиты кроме полу-проводок
  "\n"+      "  SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB, " +
  "\n"+      "         T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 2 AS T_ERR_CODE, 'Из СОФР в ЦФТ. Присутствует в СОФР, не соответствуют реквизиты: ' || " +
  "\n"+      "         USR_PKG_IMPORT_SOFR.GetDifferenceStrErr( 0, C.T_ACCT_DB, C.T_ACCT_CR, C.T_AMTCUR, C.T_AMTRUB, C.T_CURRENCY, C.T_DETAILS, C.T_DOCNUM, " +
  "\n"+      "         C.T_ACCTRNID, C.T_IDBISCOTTO, C.T_REQID ) AS T_ERR_TEXT, " +
  "\n"+      "         ( SELECT R.T_OPER FROM dacctrn_dbt R WHERE R.T_ACCTRNID = C.T_ACCTRNID ) AS T_OPER, " +
  "\n"+      "         ( SELECT W.T_BOFFICE FROM rshb_fd_groups W " +
  "\n"+      "            WHERE W.T_GROUPID IN ( SELECT O.T_GROUPID FROM dacsgroupoper_dbt O " +
  "\n"+      "                                   WHERE O.T_OPER = ( SELECT R.T_OPER FROM dacctrn_dbt R " +
  "\n"+      "                                                        WHERE R.T_ACCTRNID = C.T_ACCTRNID ) ) " +
  "\n"+      "              AND ROWNUM = 1 ) AS T_MODULE, 0 AS t_cftcur, 0 AS t_cftrub " +
  "\n"+      "    FROM uloadentforcompare_dbt C " +
  "\n"+      "   WHERE C.T_REQID = '"+Reqid+"' " +
  "\n"+      "     AND NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
  "\n"+      "                      WHERE V.T_BISCOTTOID = C.T_IDBISCOTTO ) " +
  "\n"+      "     AND C.T_AUTOKEY IN " +
  "\n"+      "         ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dacctrn_dbt B " +
  "\n"+      "                                   , ( " + SQLStrFromArray + " ) Z " +
  "\n"+      "            WHERE A.T_REQID = '"+Reqid+"' " + 
  "\n"+      "              AND (Z.ID < 0 " +
  "\n"+      "                   OR ( Z.ACC_D = CHR(1) " +
  "\n"+      "                        OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_ACCOUNT_PAYER ) > 0 ) " +
  "\n"+      "                  AND ( Z.ACC_C = CHR(1) " +
  "\n"+      "                        OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_ACCOUNT_RECEIVER ) > 0) " + 
  "\n"+      "                  AND ( Z.PERSN = CHR(1) " +
  "\n"+      "                        OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE " +
  "\n"+      "                                                                                 WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                                 WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
  "\n"+      "                                                                                 WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
  "\n"+      "                                                                                 ELSE Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                              END ) AS T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                       FROM ( SELECT NVL( ( SELECT U.T_NAME FROM dllvalues_dbt U " +
  "\n"+      "                                                                                             WHERE U.T_LIST = 5005 " +
  "\n"+      "                                                                                               AND U.T_ELEMENT = B.T_NUMBER_PACK ), '9090909') AS CNTRPERSNUMBER, " +
  "\n"+      "                                                                                     NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
  "\n"+      "                                                                                             WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
  "\n"+      "                                                                                                               WHERE V.T_OBJECTTYPE = 92 " +
  "\n"+      "                                                                                                                 AND V.T_NOTEKIND = 200 " +
  "\n"+      "                                                                                                                 AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
  "\n"+      "                                                                                                                 AND V.T_DATE <= B.T_DATE_CARRY ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
  "\n"+      "                                                                                     ( CASE " +
  "\n"+      "                                                                                          WHEN B.T_DEPARTMENT = 1 THEN '0000' " +
  "\n"+      "                                                                                          ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
  "\n"+      "                                                                                                  WHERE W.T_CODE = B.T_DEPARTMENT ) " +
  "\n"+      "                                                                                       END ) AS T_BRANCH " +
  "\n"+      "                                                                                FROM DUAL ) Y ) ) > 0 ) " +
  "\n"+      "                   ) " +
  "\n"+      "              AND A.T_OPDATE BETWEEN to_date('"+ParamProcess.DateIn+"','dd.mm.yyyy') AND to_date('"+ParamProcess.DateOut+"','dd.mm.yyyy') " +
  "\n"+      "              AND ( B.T_ACCOUNT_PAYER = A.T_ACCT_DB " +
  "\n"+      "                    OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
  "\n"+      "                                WHERE D.T_ACCOUNT =  A.T_ACCT_DB ) ) " +
  "\n"+      "              AND ( B.T_ACCOUNT_RECEIVER = A.T_ACCT_CR " +
  "\n"+      "                    OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
  "\n"+      "                                WHERE D.T_ACCOUNT =  A.T_ACCT_CR ) ) " +
  "\n"+      "              AND B.T_DATE_CARRY = A.T_OPDATE " +
  "\n"+      "              AND B.T_ACCTRNID = A.T_ACCTRNID ) " +
  "\n"+      "     AND C.T_ACCTRNID > 0 " +
  "\n"+      "     AND C.T_ACCT_DB IS NOT NULL " +
  "\n"+      "     AND C.T_ACCT_CR IS NOT NULL " +
  //shev biq-8113
  "\n"+      "     AND NVL(C.not_loaded,' ') <> chr(88) " +

  "\n"+      "     AND EXISTS( SELECT 1 FROM dacctrn_dbt D " +
  "\n"+      "                  WHERE D.T_ACCTRNID = C.T_ACCTRNID " +
  "\n"+      "                    AND ( D.T_ACCOUNT_PAYER <> C.T_ACCT_DB " +
  "\n"+      "                          AND NOT EXISTS( SELECT 1 FROM dbrokacc_dbt E " +
  "\n"+      "                                           WHERE E.T_ACCOUNT =  C.T_ACCT_DB ) " +
  "\n"+      "                           OR D.T_ACCOUNT_RECEIVER <> C.T_ACCT_CR " +
  "\n"+      "                          AND NOT EXISTS( SELECT 1 FROM dbrokacc_dbt E " +
  "\n"+      "                                           WHERE E.T_ACCOUNT =  C.T_ACCT_CR ) " +
  "\n"+      "                           OR ( CASE " +
  "\n"+      "                                   WHEN D.T_FIID_PAYER = 0 AND D.T_FIID_RECEIVER = 0 OR C.T_AMTCUR = 0 /*переоценка*/ THEN 0 " +
  "\n"+      "                                   ELSE /*конверсия*/ ( CASE WHEN D.T_FIID_PAYER <> 0 THEN D.T_SUM_PAYER " +
  "\n"+      "                                                             WHEN D.T_FIID_RECEIVER <> 0 THEN D.T_SUM_RECEIVER "+
  "\n"+      "                                                        END ) " +
  "\n"+      "                                END ) <> C.T_AMTCUR " +
  "\n"+      "                           OR D.T_SUM_NATCUR <> C.T_AMTRUB " +
  "\n"+      "                         ) " +
  "\n"+      "                ) " +
  "\n"+      "     AND EXISTS( SELECT 1 FROM  utableprocessevent_dbt D " +
  "\n"+      "                  WHERE D.T_OBJECTID = C.T_ACCTRNID " +
  "\n"+      "                    AND D.T_OBJECTTYPE IN (1, 501) " +
  "\n"+      "                    AND D.T_TYPE = 1 " +
  "\n"+      "                    AND D.T_STATUS = 4 " +
  "\n"+      "                    AND D.T_MESSAGEID IS NOT NULL " +
  "\n"+      "                    AND D.T_MESSAGEID > 0 " +
  "\n"+      "                    AND NOT EXISTS( SELECT 1 FROM utableprocessevent_dbt I " +
  "\n"+      "                                     WHERE I.T_OBJECTID = D.T_OBJECTID " +
  "\n"+      "                                       AND I.T_OBJECTTYPE = D.T_OBJECTTYPE " +
  "\n"+      "                                       AND I.T_TYPE = 3 " +
  "\n"+      "                                       AND I.T_RECID >  D.T_RECID ) ) " +
             
  "\n"+      "  UNION ALL " +

              // --из СОФР в ЦФТ проводки ЦФТ присутствуют в СОФР, не соответствуют реквизиты  только полу-проводки
  "\n"+      "  SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB, " +
  "\n"+      "         T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 2 AS T_ERR_CODE, 'Из СОФР в ЦФТ. Присутствует в СОФР, не соответствуют реквизиты: ' || " +
  "\n"+      "         USR_PKG_IMPORT_SOFR.GetDifferenceStrErr( 1, C.T_ACCT_DB, C.T_ACCT_CR, C.T_AMTCUR, C.T_AMTRUB, C.T_CURRENCY, C.T_DETAILS, C.T_DOCNUM, " +
  "\n"+      "         C.T_ACCTRNID, C.T_IDBISCOTTO, C.T_REQID ) AS T_ERR_TEXT, " +
  "\n"+      "         ( SELECT R.T_OPER FROM dacctrn_dbt R WHERE R.T_ACCTRNID = C.T_ACCTRNID ) AS T_OPER, " +
  "\n"+      "         ( SELECT W.T_BOFFICE FROM rshb_fd_groups W " +
  "\n"+      "            WHERE W.T_GROUPID IN( SELECT O.T_GROUPID FROM dacsgroupoper_dbt O " +
  "\n"+      "                                   WHERE O.T_OPER = ( SELECT R.T_OPER FROM dacctrn_dbt R " +
  "\n"+      "                                                       WHERE R.T_ACCTRNID = C.T_ACCTRNID )) " +
  "\n"+      "              AND ROWNUM = 1 ) AS T_MODULE, 0 AS t_cftcur, 0 AS t_cftrub " +
  "\n"+      "    FROM uloadentforcompare_dbt C " +
  "\n"+      "   WHERE C.T_REQID = '"+Reqid+"' " +
  "\n"+      "     AND NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
  "\n"+      "                      WHERE V.T_BISCOTTOID = C.T_IDBISCOTTO ) " +
  "\n"+      "     AND C.T_AUTOKEY IN " +
  "\n"+      "         ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dacctrn_dbt B " +
  "\n"+      "                                   , ( " + SQLStrFromArray + " ) Z " +
  "\n"+      "            WHERE A.T_REQID = '"+Reqid+"' " + 
  "\n"+      "              AND (Z.ID < 0 " +
  "\n"+      "                   OR ( Z.ACC_D = CHR(1) " +
  "\n"+      "                        OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_ACCOUNT_PAYER ) > 0 ) " +
  "\n"+      "                  AND ( Z.ACC_C = CHR(1) " +
  "\n"+      "                        OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_ACCOUNT_RECEIVER ) > 0) " +
  "\n"+      "                  AND ( Z.PERSN = CHR(1) " +
  "\n"+      "                        OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE " +
  "\n"+      "                                                                                 WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                                 WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
  "\n"+      "                                                                                 WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
  "\n"+      "                                                                                 ELSE Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                              END ) AS T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                       FROM ( SELECT NVL( ( SELECT U.T_NAME FROM dllvalues_dbt U " +
  "\n"+      "                                                                                             WHERE U.T_LIST = 5005 " +
  "\n"+      "                                                                                               AND U.T_ELEMENT = B.T_NUMBER_PACK ), '9090909') AS CNTRPERSNUMBER, " +
  "\n"+      "                                                                                     NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
  "\n"+      "                                                                                             WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
  "\n"+      "                                                                                                               WHERE V.T_OBJECTTYPE = 92 " +
  "\n"+      "                                                                                                                 AND V.T_NOTEKIND = 200 " +
  "\n"+      "                                                                                                                 AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
  "\n"+      "                                                                                                                 AND V.T_DATE <= B.T_DATE_CARRY ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
  "\n"+      "                                                                                     ( CASE " +
  "\n"+      "                                                                                          WHEN B.T_DEPARTMENT = 1 THEN '0000' " +
  "\n"+      "                                                                                          ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
  "\n"+      "                                                                                                  WHERE W.T_CODE = B.T_DEPARTMENT ) " +
  "\n"+      "                                                                                       END ) AS T_BRANCH " +
  "\n"+      "                                                                                FROM DUAL ) Y ) ) > 0 ) " +
  "\n"+      "                   ) " +
  "\n"+      "              AND A.T_OPDATE BETWEEN to_date('"+ParamProcess.DateIn+"','dd.mm.yyyy') AND to_date('"+ParamProcess.DateOut+"','dd.mm.yyyy') " +
  "\n"+      "              AND A.T_OPDATE = B.T_DATE_CARRY " +
  "\n"+      "              AND  B.T_ACCOUNT_PAYER = " +
  "\n"+      "                  NVL( A.T_ACCT_DB, ( SELECT G.T_ACCT_DB FROM uloadentforcompare_dbt G " +
  "\n"+      "                                       WHERE G.T_IDBISCOTTO = C.T_IDBISCOTTO " +
  "\n"+      "                                         AND G.T_REQID = A.T_REQID " +
  "\n"+      "                                         AND G.T_ACCT_CR IS NULL AND G.T_ACCT_DB IS NOT NULL ) ) " +
  "\n"+      "              AND B.T_ACCOUNT_RECEIVER = " +
  "\n"+      "                  NVL ( A.T_ACCT_CR, ( SELECT G.T_ACCT_CR FROM uloadentforcompare_dbt G " +
  "\n"+      "                                        WHERE G.T_IDBISCOTTO = C.T_IDBISCOTTO " +
  "\n"+      "                                          AND G.T_REQID = A.T_REQID " +
  "\n"+      "                                          AND G.T_ACCT_DB IS NULL AND G.T_ACCT_CR IS NOT NULL ) ) " +
  "\n"+      "              AND B.T_DATE_CARRY = A.T_OPDATE " +
  "\n"+      "              AND B.T_ACCTRNID = A.T_ACCTRNID )  " +
  "\n"+      "     AND C.T_ACCTRNID > 0 " +
  "\n"+      "     AND ( C.T_ACCT_DB IS NULL AND C.T_ACCT_CR IS NOT NULL " +
  "\n"+      "           OR C.T_ACCT_DB IS NOT NULL AND C.T_ACCT_CR IS NULL ) " +
  //shev biq-8113
  "\n"+      "     AND nvl(C.not_loaded,chr(0)) <> chr(88) " +

  "\n"+      "     AND EXISTS( SELECT 1 FROM dacctrn_dbt D " +
  "\n"+      "                  WHERE D.T_ACCTRNID = C.T_ACCTRNID " +
  "\n"+      "                    AND ( D.T_ACCOUNT_PAYER <> /*C.T_ACCT_DB*/ " +
  "\n"+      "                            NVL( C.T_ACCT_DB, ( SELECT G.T_ACCT_DB FROM uloadentforcompare_dbt G " +
  "\n"+      "                                                 WHERE G.T_IDBISCOTTO = C.T_IDBISCOTTO " +
  "\n"+      "                                                   AND G.T_REQID = C.T_REQID " +
  "\n"+      "                                                   AND G.T_ACCT_CR IS NULL AND G.T_ACCT_DB IS NOT NULL ) ) " +
  "\n"+      "                          OR D.T_ACCOUNT_RECEIVER <> /*C.T_ACCT_CR*/ " +
  "\n"+      "                            NVL ( C.T_ACCT_CR, ( SELECT G.T_ACCT_CR FROM uloadentforcompare_dbt G " +
  "\n"+      "                                                  WHERE G.T_IDBISCOTTO = C.T_IDBISCOTTO " +
  "\n"+      "                                                    AND G.T_REQID = C.T_REQID " +
  "\n"+      "                                                    AND G.T_ACCT_DB IS NULL AND G.T_ACCT_CR IS NOT NULL ) ) " +
  "\n"+      "                          OR D.T_SUM_PAYER <> ( CASE " +
  "\n"+      "                                                   WHEN C.T_ACCT_DB IS NULL THEN ( SELECT G.T_AMTCUR FROM uloadentforcompare_dbt G " +
  "\n"+      "                                                                                    WHERE G.T_IDBISCOTTO = C.T_IDBISCOTTO " +
  "\n"+      "                                                                                      AND G.T_REQID = C.T_REQID " +
  "\n"+      "                                                                                      AND G.T_ACCTRNID = C.T_ACCTRNID " +
  "\n"+      "                                                                                      AND G.T_ACCT_CR IS NULL AND G.T_ACCT_DB IS NOT NULL ) " +
  "\n"+      "                                                   ELSE C.T_AMTCUR " +
  "\n"+      "                                                END ) " +
  "\n"+      "                          OR D.T_SUM_RECEIVER <> ( CASE " +
  "\n"+      "                                                      WHEN C.T_ACCT_CR IS NULL THEN ( SELECT G.T_AMTCUR FROM uloadentforcompare_dbt G " +
  "\n"+      "                                                                                       WHERE G.T_IDBISCOTTO = C.T_IDBISCOTTO " +
  "\n"+      "                                                                                         AND G.T_REQID = C.T_REQID " +
  "\n"+      "                                                                                         AND G.T_ACCTRNID = C.T_ACCTRNID " +
  "\n"+      "                                                                                         AND G.T_ACCT_DB IS NULL AND G.T_ACCT_CR IS NOT NULL ) " +
  "\n"+      "                                                      ELSE C.T_AMTCUR " +
  "\n"+      "                                                   END ) " +
  "\n"+      "                          OR D.T_SUM_NATCUR <> C.T_AMTRUB " +
  "\n"+      "                         ) " +
  "\n"+      "                ) " +
  "\n"+      "     AND EXISTS( SELECT 1 FROM  utableprocessevent_dbt D " +
  "\n"+      "                  WHERE D.T_OBJECTID = C.T_ACCTRNID " +
  "\n"+      "                    AND D.T_OBJECTTYPE IN (1, 501) " +
  "\n"+      "                    AND D.T_TYPE = 1 " +
  "\n"+      "                    AND D.T_STATUS = 4 " +
  "\n"+      "                    AND D.T_MESSAGEID IS NOT NULL " +
  "\n"+      "                    AND D.T_MESSAGEID > 0 " +
  "\n"+      "                    AND NOT EXISTS( SELECT 1 FROM utableprocessevent_dbt I " +
  "\n"+      "                                     WHERE I.T_OBJECTID = D.T_OBJECTID " +
  "\n"+      "                                       AND I.T_OBJECTTYPE = D.T_OBJECTTYPE " +
  "\n"+      "                                       AND I.T_TYPE = 3 " +
  "\n"+      "                                       AND I.T_RECID >  D.T_RECID ) ) " +

  "\n"+      "  UNION ALL " +

              // --из СОФР в ЦФТ проводки ЦФТ присутствуют в СОФР, задвоенные в ЦФТ кроме полу-проводок
  "\n"+      "  SELECT D.T_AUTOKEY, D.T_COUNTER, D.T_USERID, D.T_OPDATE, D.T_DOCDATE, D.T_ACCT_DB, D.T_ACCT_CR, D.T_CURRENCY, D.T_AMTCUR, D.T_AMTRUB, " +
  "\n"+      "         D.T_DETAILS, D.T_DOCNUM, D.T_ACCTRNID, D.T_IDBISCOTTO, D.T_REQID, 3 AS T_ERR_CODE, 'Из СОФР в ЦФТ. Присутствует в СОФР, задвоенные в ЦФТ' AS T_ERR_TEXT, " +
  "\n"+      "         0 AS T_OPER, '' AS T_MODULE, 0 AS t_cftcur, 0 AS t_cftrub " +
  "\n"+      "    FROM uloadentforcompare_dbt D, " +
  "\n"+      "         ( SELECT T_ACCTRNID, MAX( T_AUTOKEY ) AS T_AUTOKEY_DOUBLE, MIN( T_AUTOKEY ) AS T_AUTOKEY_PRIOR " + 
  "\n"+      "              FROM uloadentforcompare_dbt C " +
  "\n"+      "             WHERE C.T_REQID = '"+Reqid+"' " +
  "\n"+      "               AND C.T_AUTOKEY IN " +
  "\n"+      "                 ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dacctrn_dbt B " +
  "\n"+      "                                            , ( " + SQLStrFromArray + " ) Z " +
  "\n"+      "                    WHERE A.T_REQID = '"+Reqid+"' " +
  "\n"+      "                      AND (Z.ID < 0 " +
  "\n"+      "                           OR ( Z.ACC_D = CHR(1) " +
  "\n"+      "                                OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_ACCOUNT_PAYER ) > 0 ) " +
  "\n"+      "                          AND ( Z.ACC_C = CHR(1) " +
  "\n"+      "                                OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_ACCOUNT_RECEIVER ) > 0) " +
  "\n"+      "                          AND ( Z.PERSN = CHR(1) " +
  "\n"+      "                                OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE " +
  "\n"+      "                                                                                        WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                                        WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
  "\n"+      "                                                                                        WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
  "\n"+      "                                                                                        ELSE Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                                      END ) AS T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                               FROM ( SELECT " +
  "\n"+      "                                                                                          NVL( ( SELECT U.T_NAME FROM dllvalues_dbt U " +
  "\n"+      "                                                                                                 WHERE U.T_LIST = 5005 " +
  "\n"+      "                                                                                                   AND U.T_ELEMENT = B.T_NUMBER_PACK ), '9090909') AS CNTRPERSNUMBER, " +
  "\n"+      "                                                                                          NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
  "\n"+      "                                                                                                  WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
  "\n"+      "                                                                                                                    WHERE V.T_OBJECTTYPE = 92 " +
  "\n"+      "                                                                                                                      AND V.T_NOTEKIND = 200 " +
  "\n"+      "                                                                                                                      AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
  "\n"+      "                                                                                                                      AND V.T_DATE <= B.T_DATE_CARRY ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
  "\n"+      "                                                                                          ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' " +
  "\n"+      "                                                                                                 ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
  "\n"+      "                                                                                                         WHERE W.T_CODE = B.T_DEPARTMENT ) " +
  "\n"+      "                                                                                            END ) AS T_BRANCH " +
  "\n"+      "                                                                                        FROM DUAL ) Y ) ) > 0 ) " +
  "\n"+      "                           ) " +
  "\n"+      "                      AND A.T_OPDATE BETWEEN to_date('"+ParamProcess.DateIn+"','dd.mm.yyyy') AND to_date('"+ParamProcess.DateOut+"','dd.mm.yyyy') " +
  "\n"+      "                      AND A.T_OPDATE = B.T_DATE_CARRY " +
  "\n"+      "                      AND ( B.T_ACCOUNT_PAYER = A.T_ACCT_DB " +
  "\n"+      "                            OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
  "\n"+      "                                        WHERE D.T_ACCOUNT =  A.T_ACCT_DB ) ) " +
  "\n"+      "                      AND ( B.T_ACCOUNT_RECEIVER = A.T_ACCT_CR " +
  "\n"+      "                            OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
  "\n"+      "                                        WHERE D.T_ACCOUNT =  A.T_ACCT_CR ) ) " +
  "\n"+      "                      AND B.T_DATE_CARRY = A.T_OPDATE " +
  "\n"+      "                      AND B.T_ACCTRNID = A.T_ACCTRNID " +
  "\n"+      "                  ) " +
  "\n"+      "               AND C.T_ACCTRNID > 0 " +
  "\n"+      "               AND C.T_ACCT_DB IS NOT NULL " +
  "\n"+      "               AND C.T_ACCT_CR IS NOT NULL " +
  "\n"+      "               AND EXISTS( SELECT 1 FROM  utableprocessevent_dbt D " +
  "\n"+      "                            WHERE D.T_OBJECTID = C.T_ACCTRNID " +
  "\n"+      "                              AND D.T_OBJECTTYPE IN (1, 501) " +
  "\n"+      "                              AND D.T_TYPE = 1 " +
  "\n"+      "                              AND D.T_STATUS = 4 " +
  "\n"+      "                              AND D.T_MESSAGEID IS NOT NULL " +
  "\n"+      "                              AND D.T_MESSAGEID > 0 " +
  "\n"+      "                              AND NOT EXISTS( SELECT 1 FROM utableprocessevent_dbt I " +
  "\n"+      "                                               WHERE I.T_OBJECTID = D.T_OBJECTID " +
  "\n"+      "                                                 AND I.T_OBJECTTYPE = D.T_OBJECTTYPE " +
  "\n"+      "                                                 AND I.T_TYPE = 3 " +
  "\n"+      "                                                 AND I.T_RECID >  D.T_RECID ) ) " +
  "\n"+      "           GROUP BY T_ACCTRNID " +
  "\n"+      "           HAVING COUNT(T_ACCTRNID) > 1 " +
  "\n"+      "          ) A " +
  "\n"+      "  WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
  "\n"+      "                     WHERE V.T_BISCOTTOID = D.T_IDBISCOTTO ) " +
  //"\n"+      "   AND D.T_AUTOKEY = A.T_AUTOKEY_DOUBLE " +
   //shev 170621
  //"\n"+      "    and D.T_REQID = '"+Reqid+"'                                                             " +
  //"\n"+      "    AND D.T_OPDATE BETWEEN to_date('"+ParamProcess.DateIn+"','dd.mm.yyyy') AND to_date('"+ParamProcess.DateOut+"','dd.mm.yyyy')     " +
  "\n"+      "    AND D.T_ACCTRNID = a.T_ACCTRNID " +
  "\n"+      "    AND D.T_ACCTRNID > 0 " +
  "\n"+      "    AND D.T_AUTOKEY <> A.T_AUTOKEY_PRIOR " +
  //shev biq-8113
  "\n"+      "    AND nvl(d.not_loaded,chr(0)) <> chr(88) " +

  "\n"+      "  UNION ALL " +

              // --проводки ЦФТ присутствуют в СОФР, задвоенные в ЦФТ только полу-проводки
  "\n"+      "  SELECT D.T_AUTOKEY, D.T_COUNTER, D.T_USERID, D.T_OPDATE, D.T_DOCDATE, D.T_ACCT_DB, D.T_ACCT_CR, D.T_CURRENCY, D.T_AMTCUR, D.T_AMTRUB, " +
  "\n"+      "         D.T_DETAILS, D.T_DOCNUM, D.T_ACCTRNID, D.T_IDBISCOTTO, D.T_REQID, 3 AS T_ERR_CODE, 'Из СОФР в ЦФТ. Присутствует в СОФР, задвоенные в ЦФТ' AS T_ERR_TEXT, " +
  "\n"+      "         0 AS T_OPER, '' AS T_MODULE, 0 AS t_cftcur, 0 AS t_cftrub " +
  "\n"+      "    FROM uloadentforcompare_dbt D, " +
  "\n"+      "         ( SELECT T_ACCTRNID, MAX( T_AUTOKEY ) AS T_AUTOKEY_DOUBLE, MIN( T_AUTOKEY ) AS T_AUTOKEY_PRIOR  " +
  "\n"+      "             FROM uloadentforcompare_dbt C " +
  "\n"+      "            WHERE C.T_REQID = '"+Reqid+"' " +
  "\n"+      "              AND C.T_AUTOKEY IN " +
  "\n"+      "               ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dacctrn_dbt B " +
  "\n"+      "                                          , ( " + SQLStrFromArray + " ) Z " +
  "\n"+      "                  WHERE A.T_REQID = '"+Reqid+"' " +
  "\n"+      "                    AND (Z.ID < 0 " +
  "\n"+      "                         OR ( Z.ACC_D = CHR(1) " +
  "\n"+      "                              OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_ACCOUNT_PAYER ) > 0 ) " +
  "\n"+      "                        AND ( Z.ACC_C = CHR(1) " +
  "\n"+      "                              OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_ACCOUNT_RECEIVER ) > 0) " +
  "\n"+      "                        AND ( Z.PERSN = CHR(1) " +
  "\n"+      "                              OR RSB_MASK.CompareStringWithMask( Z.PERSN, ( SELECT ( CASE " +
  "\n"+      "                                                                                        WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                                        WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
  "\n"+      "                                                                                        WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
  "\n"+      "                                                                                        ELSE Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                                     END ) AS T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                              FROM ( SELECT NVL( ( SELECT U.T_NAME FROM dllvalues_dbt U " +
  "\n"+      "                                                                                                    WHERE U.T_LIST = 5005 " +
  "\n"+      "                                                                                                      AND U.T_ELEMENT = B.T_NUMBER_PACK ), '9090909') AS CNTRPERSNUMBER, " +
  "\n"+      "                                                                                            NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
  "\n"+      "                                                                                                    WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
  "\n"+      "                                                                                                                      WHERE V.T_OBJECTTYPE = 92 " +
  "\n"+      "                                                                                                                        AND V.T_NOTEKIND = 200 " +
  "\n"+      "                                                                                                                        AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
  "\n"+      "                                                                                                                        AND V.T_DATE <= B.T_DATE_CARRY ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
  "\n"+      "                                                                                             ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' " +
  "\n"+      "                                                                                                    ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
  "\n"+      "                                                                                                            WHERE W.T_CODE = B.T_DEPARTMENT ) " +
  "\n"+      "                                                                                                END ) AS T_BRANCH " +
  "\n"+      "                                                                                       FROM DUAL ) Y ) ) > 0 ) " +
  "\n"+      "                         ) " +
  "\n"+      "                    AND A.T_OPDATE BETWEEN to_date('"+ParamProcess.DateIn+"','dd.mm.yyyy') AND to_date('"+ParamProcess.DateOut+"','dd.mm.yyyy') " +
  "\n"+      "                    AND A.T_OPDATE = B.T_DATE_CARRY " +
  "\n"+      "                    AND B.T_ACCOUNT_PAYER = /*A.T_ACCT_DB*/ " +
  "\n"+      "                        NVL( A.T_ACCT_DB, ( SELECT G.T_ACCT_DB " +
  "\n"+      "                                              FROM uloadentforcompare_dbt G " +
  "\n"+      "                                             WHERE G.T_IDBISCOTTO = A.T_IDBISCOTTO " +
  "\n"+      "                                               AND G.T_REQID = A.T_REQID " +
  "\n"+      "                                               AND G.T_ACCT_CR IS NULL AND G.T_ACCT_DB IS NOT NULL ) ) " +
  "\n"+      "                    AND B.T_ACCOUNT_RECEIVER = /*A.T_ACCT_CR*/ " +
  "\n"+      "                        NVL ( A.T_ACCT_CR, ( SELECT G.T_ACCT_CR " +
  "\n"+      "                                               FROM uloadentforcompare_dbt G " +
  "\n"+      "                                              WHERE G.T_IDBISCOTTO = A.T_IDBISCOTTO " +
  "\n"+      "                                                AND G.T_REQID = A.T_REQID " +
  "\n"+      "                                                AND G.T_ACCT_DB IS NULL AND G.T_ACCT_CR IS NOT NULL ) ) " +
  "\n"+      "                    AND B.T_DATE_CARRY = A.T_OPDATE " +
  "\n"+      "                    AND B.T_ACCTRNID = A.T_ACCTRNID ) " +
  "\n"+      "              AND C.T_ACCTRNID > 0 " +
  "\n"+      "              AND ( C.T_ACCT_DB IS NULL AND C.T_ACCT_CR IS NOT NULL " +
  "\n"+      "                    OR C.T_ACCT_DB IS NOT NULL AND C.T_ACCT_CR IS NULL ) " +
  "\n"+      "              AND EXISTS( SELECT 1 FROM utableprocessevent_dbt D " +
  "\n"+      "                           WHERE D.T_OBJECTID = C.T_ACCTRNID " +
  "\n"+      "                             AND D.T_OBJECTTYPE IN (1, 501) " +
  "\n"+      "                             AND D.T_TYPE = 1 " +
  "\n"+      "                             AND D.T_STATUS = 4 " +
  "\n"+      "                             AND D.T_MESSAGEID IS NOT NULL " +
  "\n"+      "                             AND D.T_MESSAGEID > 0 " +
  "\n"+      "                             AND NOT EXISTS( SELECT 1 FROM utableprocessevent_dbt I " +
  "\n"+      "                                              WHERE I.T_OBJECTID = D.T_OBJECTID " +
  "\n"+      "                                                AND I.T_OBJECTTYPE = D.T_OBJECTTYPE " +
  "\n"+      "                                                AND I.T_TYPE = 3 " +
  "\n"+      "                                                AND I.T_RECID > D.T_RECID ) ) " +
  "\n"+      "           GROUP BY T_ACCTRNID " +
  "\n"+      "           HAVING COUNT(T_ACCTRNID) > 2 " +
  "\n"+      "          ) A " +
  "\n"+      "   WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
  "\n"+      "                      WHERE V.T_BISCOTTOID = D.T_IDBISCOTTO ) " +
  "\n"+      "     AND D.T_AUTOKEY = A.T_AUTOKEY_DOUBLE " +
  //shev biq-8113
  "\n"+      "     AND nvl(d.not_loaded,chr(0)) <> chr(88) " +

  "\n"+      "  UNION ALL " +

              // --из СОФР в ЦФТ проводки СОФР отсутствуют в ЦФТ в том числе полу-проводки
  "\n"+      "  SELECT -1 AS T_AUTOKEY, CHR(0) AS T_COUNTER, CHR(0) AS T_USERID, C.T_DATE_CARRY AS T_OPDATE, C.T_DATE_CARRY AS T_DOCDATE, C.T_ACCOUNT_PAYER AS T_ACCT_DB, " +
  "\n"+      "         C.T_ACCOUNT_RECEIVER AS T_ACCT_CR, " +
  "\n"+      "         ( SELECT F.T_CODEINACCOUNT FROM dfininstr_dbt F " +
  "\n"+      "            WHERE F.T_FIID = C.T_FIID_PAYER ) AS T_CURRENCY, " +
  "\n"+      "         C.T_SUM_PAYER AS T_AMTCUR, C.T_SUM_NATCUR AS T_AMTRUB, " +
  "\n"+      "         C.T_GROUND AS T_DETAILS, C.T_NUMB_DOCUMENT AS T_DOCNUM, C.T_ACCTRNID, CHR(0) AS T_IDBISCOTTO, CHR(0) AS T_REQID, 4 AS T_ERR_CODE, " +
  "\n"+      "         USR_PKG_IMPORT_SOFR.GetStrEventErr( 1, 1, T_ACCTRNID ) AS T_ERR_TEXT, " +
  "\n"+      "         0 AS T_OPER, '' AS T_MODULE, 0 AS t_cftcur, 0 AS t_cftrub " +
  "\n"+      "    FROM dacctrn_dbt C " +
  "\n"+      "         , ( " + SQLStrFromArray + " ) X " +
  "\n"+      "   WHERE C.T_DATE_CARRY BETWEEN to_date('"+ParamProcess.DateIn+"','dd.mm.yyyy') AND to_date('"+ParamProcess.DateOut+"','dd.mm.yyyy') " +
  //shev biq-8113
  "\n"+      "     AND C.T_RESULT_CARRY <> 18" +
  "\n"+      "     AND ( X.ID < 0 " +
  "\n"+      "           OR ( X.ACC_D = CHR(1) " +
  "\n"+      "                OR RSB_MASK.CompareStringWithMask( X.ACC_D, C.T_ACCOUNT_PAYER ) > 0 ) " +
  "\n"+      "          AND ( X.ACC_C = CHR(1) " +
  "\n"+      "                OR RSB_MASK.CompareStringWithMask( X.ACC_C, C.T_ACCOUNT_RECEIVER ) > 0 ) " +
  "\n"+      "          AND ( X.PERSN = CHR(1) " +
  "\n"+      "                OR RSB_MASK.CompareStringWithMask( X.PERSN, ( SELECT ( CASE " +
  "\n"+      "                                                                          WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                          WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
  "\n"+      "                                                                          WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
  "\n"+      "                                                                          ELSE Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                       END ) AS T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                FROM ( SELECT NVL( ( SELECT U.T_NAME FROM dllvalues_dbt U " +
  "\n"+      "                                                                                     WHERE U.T_LIST = 5005 " +
  "\n"+      "                                                                                       AND U.T_ELEMENT = C.T_NUMBER_PACK ), '9090909') AS CNTRPERSNUMBER, " +
  "\n"+      "                                                                              NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
  "\n"+      "                                                                                      WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
  "\n"+      "                                                                                                        WHERE V.T_OBJECTTYPE = 92 " +
  "\n"+      "                                                                                                          AND V.T_NOTEKIND = 200 " +
  "\n"+      "                                                                                                          AND V.T_DOCUMENTID = LPAD( TO_CHAR( C.T_OPER ), 10, '0') " +
  "\n"+      "                                                                                                          AND V.T_DATE <= C.T_DATE_CARRY ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
  "\n"+      "                                                                              ( CASE WHEN C.T_DEPARTMENT = 1 THEN '0000' " +
  "\n"+      "                                                                                     ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
  "\n"+      "                                                                                             WHERE W.T_CODE = C.T_DEPARTMENT ) " +
  "\n"+      "                                                                                 END ) AS T_BRANCH " +
  "\n"+      "                                                                         FROM DUAL ) Y ) ) > 0 ) " +
  "\n"+      "          ) " +
  "\n"+      "     AND C.T_ACCTRNID NOT IN " +
  "\n"+      "         ( SELECT B.T_ACCTRNID FROM dacctrn_dbt B, uloadentforcompare_dbt A " +
  "\n"+      "                                    , ( " + SQLStrFromArray + " ) Z " +
  "\n"+      "            WHERE " +
  //shev 170621
  //"\n"+      "                        NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
  //"\n"+      "                                                WHERE V.T_BISCOTTOID = A.T_IDBISCOTTO ) " +
  "\n"+      "               A.T_REQID = '"+Reqid+"' " +
  "\n"+      "              AND ( Z.ID < 0 " +
  "\n"+      "                   OR ( Z.ACC_D = CHR(1) " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_ACCOUNT_PAYER ) > 0 ) " +
  "\n"+      "                  AND ( Z.ACC_C = CHR(1) " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_ACCOUNT_RECEIVER ) > 0) " +
  "\n"+      "                  AND ( Z.PERSN = CHR(1) " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE " +
  "\n"+      "                                                                                WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                                WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
  "\n"+      "                                                                                WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
  "\n"+      "                                                                                ELSE Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                             END ) AS T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                      FROM ( SELECT NVL( ( SELECT U.T_NAME FROM dllvalues_dbt U " +
  "\n"+      "                                                                                            WHERE U.T_LIST = 5005 " +
  "\n"+      "                                                                                              AND U.T_ELEMENT = B.T_NUMBER_PACK ), '9090909') AS CNTRPERSNUMBER, " +
  "\n"+      "                                                                                    NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
  "\n"+      "                                                                                            WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
  "\n"+      "                                                                                                              WHERE V.T_OBJECTTYPE = 92 " +
  "\n"+      "                                                                                                                AND V.T_NOTEKIND = 200 " +
  "\n"+      "                                                                                                                AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
  "\n"+      "                                                                                                                AND V.T_DATE <= B.T_DATE_CARRY ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
  "\n"+      "                                                                                    ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' " +
  "\n"+      "                                                                                           ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
  "\n"+      "                                                                                                   WHERE W.T_CODE = B.T_DEPARTMENT ) END ) AS T_BRANCH " +
  "\n"+      "                                                                               FROM DUAL ) Y ) ) > 0 ) " +
  "\n"+      "                   ) " +
  //shev 170621
  //"\n"+      "               AND A.T_ACCTRNID > 0 " +
  "\n"+      "              AND A.T_OPDATE BETWEEN to_date('"+ParamProcess.DateIn+"','dd.mm.yyyy') AND to_date('"+ParamProcess.DateOut+"','dd.mm.yyyy') " +
  "\n"+      "              AND B.T_DATE_CARRY = A.T_OPDATE " +
  "\n"+      "              AND A.T_OPDATE = B.T_DATE_CARRY " +
  //"\n"+      "               AND A.T_ACCTRNID = B.T_ACCTRNID ) ) " + 
  "\n"+      "              AND ( ( A.T_ACCTRNID = B.T_ACCTRNID AND A.T_ACCTRNID > 0 " +
  "\n"+      "                      AND NOT EXISTS ( SELECT 1 FROM upmbiscotto_dbt V  WHERE V.T_BISCOTTOID = A.T_IDBISCOTTO ) ) " +
  "\n"+      "                   OR ( b.t_account_payer = a.t_acct_db AND b.t_account_receiver = a.t_acct_cr " +
  "\n"+      "                        AND b.t_sum_natcur = a.t_amtrub ) "+
  //BIQ-10484
  "\n"+      "                   OR  (A.T_ACCTRNID < 0  "+
  "\n"+      "                         and exists "+
  "\n"+      "                          ( SELECT 1 FROM doproper_dbt opr, ddl_acc_dbt dlacc, doprdocs_dbt docs "+                                                             
  "\n"+      "                             WHERE opr.T_KIND_OPERATION = 2030 "+
  "\n"+      "                               AND opr.T_DOCKIND = dlacc.T_DOCKIND "+
  "\n"+      "                               AND TO_NUMBER(opr.T_DOCUMENTID) = dlacc.T_ID "+
  "\n"+      "                               AND dlacc.t_opertype = 48 "+
  "\n"+      "                               AND opr.T_ID_OPERATION = docs.T_ID_OPERATION "+
  "\n"+      "                               AND B.T_ACCTRNID = docs.t_acctrnid "+
  "\n"+      "                               AND dlacc.t_id = -1*A.T_ACCTRNID "+
  "\n"+      "                            ) "+
  "\n"+      "                        ) "+
  "\n"+      "                  ) " +
  "\n"+      "          ) " +
  "\n"+      "     AND EXISTS( SELECT 1 FROM  utableprocessevent_dbt D " +
  "\n"+      "                  WHERE D.T_OBJECTID = C.T_ACCTRNID " +
  "\n"+      "                    AND D.T_OBJECTTYPE IN (1, 501) " +
  "\n"+      "                    AND D.T_TYPE = 1 " +
  //shev biq-8113
  //"\n"+      "                   AND D.T_STATUS IN( 4, 5 ) " + //!!!исключаем коллизии - ошибка выгрузки в ЦФТ
  //"\n"+      "                   AND D.T_MESSAGEID IS NOT NULL " +
  //"\n"+      "                   AND D.T_MESSAGEID > 0 " +
  "\n"+      "                    AND NOT EXISTS( SELECT 1 FROM utableprocessevent_dbt I " +
  "\n"+      "                                     WHERE I.T_OBJECTID = D.T_OBJECTID " +
  "\n"+      "                                       AND I.T_OBJECTTYPE = D.T_OBJECTTYPE " +
  "\n"+      "                                       AND I.T_TYPE = 3 " +
  "\n"+      "                                       AND I.T_RECID >  D.T_RECID ) ) " +
  "\n"+      "  UNION ALL " +

              // --из СОФР в ЦФТ платежи ЦФТ отсутствуют в СОФР
  "\n"+      "  SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB, " +
  "\n"+      "         T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 1 AS T_ERR_CODE, " +
  "\n"+      "         USR_PKG_IMPORT_SOFR.GetStrEventErr( 0, 501, T_ACCTRNID * -1 ) AS T_ERR_TEXT, " +
  "\n"+      "         0 AS T_OPER, '' AS T_MODULE, 0 AS t_cftcur, 0 AS t_cftrub " +
  "\n"+      "    FROM uloadentforcompare_dbt C " +
  "\n"+      "   WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
  "\n"+      "                      WHERE V.T_BISCOTTOID = C.T_IDBISCOTTO ) " +
  "\n"+      "     AND C.T_AUTOKEY NOT IN " +
  "\n"+      "        ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dpmpaym_dbt B " +
  "\n"+      "                                 , ( " + SQLStrFromArray + " ) Z " +
  "\n"+      "           WHERE A.T_REQID = '"+Reqid+"' " +
  "\n"+      "             AND ( Z.ID < 0 " +
  "\n"+      "                   OR ( Z.ACC_D = CHR(1) " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_FUTUREPAYERACCOUNT ) > 0 " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_PAYERACCOUNT ) > 0 ) " +
  "\n"+      "                  AND ( Z.ACC_C = CHR(1) " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_FUTURERECEIVERACCOUNT ) > 0 " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_RECEIVERACCOUNT ) > 0 ) " + 
  "\n"+      "                  AND ( Z.PERSN = CHR(1) " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE " +
  "\n"+      "                                                                                 WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                                 WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
  "\n"+      "                                                                                 WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
  "\n"+      "                                                                                 ELSE Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                             END ) AS T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                       FROM ( SELECT NVL( ( SELECT U.T_NAME FROM dllvalues_dbt U " +
  "\n"+      "                                                                                             WHERE U.T_LIST = 5005 " +
  "\n"+      "                                                                                               AND U.T_ELEMENT = B.T_NUMBERPACK ), '9090909') AS CNTRPERSNUMBER, " +
  "\n"+      "                                                                                     NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
  "\n"+      "                                                                                             WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
  "\n"+      "                                                                                                               WHERE V.T_OBJECTTYPE = 92 " +
  "\n"+      "                                                                                                                 AND V.T_NOTEKIND = 200 " +
  "\n"+      "                                                                                                                 AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
  "\n"+      "                                                                                                                 AND V.T_DATE <= B.T_VALUEDATE ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
  "\n"+      "                                                                                     ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' " +
  "\n"+      "                                                                                            ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
  "\n"+      "                                                                                                    WHERE W.T_CODE = B.T_DEPARTMENT ) " +
  "\n"+      "                                                                                        END ) AS T_BRANCH " +
  "\n"+      "                                                                                FROM DUAL ) Y ) ) > 0 ) " +
  "\n"+      "                  ) " +
  "\n"+      "             AND EXISTS( SELECT 1 FROM  utableprocessevent_dbt D " +
  "\n"+      "                          WHERE D.T_OBJECTID = A.T_ACCTRNID * -1 " +
  "\n"+      "                            AND D.T_OBJECTTYPE = 501 " +
  "\n"+      "                            AND D.T_TYPE IN( 1, 2 ) " +
  "\n"+      "                            AND D.T_STATUS in (4, 5 ) " + //14.10.2020 по просьбе банка отключен показ ошибок выгрузки в сверке где T_IDBISCOTTO и T_ACCTRNID корректные
  "\n"+      "                            AND D.T_MESSAGEID IS NOT NULL " +
  "\n"+      "                            AND D.T_MESSAGEID > 0 " +
  "\n"+      "                            AND NOT EXISTS( SELECT 1 FROM utableprocessevent_dbt I " +
  "\n"+      "                                             WHERE I.T_OBJECTID = D.T_OBJECTID " +
  "\n"+      "                                               AND I.T_OBJECTTYPE = D.T_OBJECTTYPE " +
  "\n"+      "                                               AND I.T_TYPE = 3 " +
  "\n"+      "                                               AND I.T_RECID >  D.T_RECID ) ) " +
  "\n"+      "             AND A.T_OPDATE BETWEEN to_date('"+ParamProcess.DateIn+"','dd.mm.yyyy') AND to_date('"+ParamProcess.DateOut+"','dd.mm.yyyy') " +
  "\n"+      "             AND A.T_OPDATE = B.T_VALUEDATE " +
  "\n"+      "             AND B.T_VALUEDATE = A.T_OPDATE " +
  "\n"+      "             AND B.T_PAYMENTID = A.T_ACCTRNID * -1 ) " +
  "\n"+      "     AND C.T_REQID = '"+Reqid+"' " +
  "\n"+      "     AND C.T_ACCTRNID < 0 " +
  "\n"+      "     AND C.T_ACCT_DB IS NOT NULL " +
  "\n"+      "     AND C.T_ACCT_CR IS NOT NULL " +
  "\n"+      "  UNION ALL " +

              // --из СОФР в ЦФТ платежи ЦФТ присутствуют в СОФР, не соответствуют реквизиты
  "\n"+      "  SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB, " +
  "\n"+      "         T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 2 AS T_ERR_CODE, 'Из СОФР в ЦФТ. Присутствует в СОФР, не соответствуют реквизиты: ' || " +
  "\n"+      "         USR_PKG_IMPORT_SOFR.GetDifferenceStrErr( 2, C.T_ACCT_DB, C.T_ACCT_CR, C.T_AMTCUR, C.T_AMTRUB, C.T_CURRENCY, C.T_DETAILS, C.T_DOCNUM, " +
  "\n"+      "         C.T_ACCTRNID, C.T_IDBISCOTTO, C.T_REQID ) AS T_ERR_TEXT, " +
  "\n"+      "         ( SELECT R.T_OPER FROM dpmpaym_dbt R WHERE R.T_PAYMENTID = C.T_ACCTRNID * -1 ) AS T_OPER, " +
  "\n"+      "         ( SELECT W.T_BOFFICE FROM rshb_fd_groups W " +
  "\n"+      "            WHERE W.T_GROUPID IN ( SELECT O.T_GROUPID FROM dacsgroupoper_dbt O " +
  "\n"+      "                                    WHERE O.T_OPER = ( SELECT R.T_OPER FROM dpmpaym_dbt R " +
  "\n"+      "                                                        WHERE R.T_PAYMENTID = C.T_ACCTRNID * -1 )) " +
  "\n"+      "              AND ROWNUM = 1 ) AS T_MODULE, 0 AS t_cftcur, 0 AS t_cftrub " +
  "\n"+      "    FROM uloadentforcompare_dbt C " +
  "\n"+      "   WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
  "\n"+      "                      WHERE V.T_BISCOTTOID = C.T_IDBISCOTTO ) " +
  "\n"+      "     AND C.T_AUTOKEY IN " +
  "\n"+      "         ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dpmpaym_dbt B " +
  "\n"+      "                                   , ( " + SQLStrFromArray + " ) Z " +
  "\n"+      "            WHERE A.T_REQID = '"+Reqid+"' " + 
  "\n"+      "              AND (Z.ID < 0 " +
  "\n"+      "                   OR ( Z.ACC_D = CHR(1) " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_FUTUREPAYERACCOUNT ) > 0 " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_PAYERACCOUNT ) > 0 ) " +
  "\n"+      "                  AND ( Z.ACC_C = CHR(1) " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_FUTURERECEIVERACCOUNT ) > 0 " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_RECEIVERACCOUNT ) > 0 ) " +
  "\n"+      "                  AND ( Z.PERSN = CHR(1) " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE " +
  "\n"+      "                                                                                WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                                WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
  "\n"+      "                                                                                WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
  "\n"+      "                                                                                ELSE Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                             END ) AS T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                      FROM ( SELECT NVL( ( SELECT U.T_NAME FROM dllvalues_dbt U " +
  "\n"+      "                                                                                            WHERE U.T_LIST = 5005 " +
  "\n"+      "                                                                                              AND U.T_ELEMENT = B.T_NUMBERPACK ), '9090909') AS CNTRPERSNUMBER, " +
  "\n"+      "                                                                                    NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
  "\n"+      "                                                                                            WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
  "\n"+      "                                                                                                              WHERE V.T_OBJECTTYPE = 92 " +
  "\n"+      "                                                                                                                AND V.T_NOTEKIND = 200 " +
  "\n"+      "                                                                                                                AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
  "\n"+      "                                                                                                                AND V.T_DATE <= B.T_VALUEDATE ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
  "\n"+      "                                                                                    ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
  "\n"+      "                                                                                                                                       WHERE W.T_CODE = B.T_DEPARTMENT ) END ) AS T_BRANCH " +
  "\n"+      "                                                                               FROM DUAL ) Y ) ) > 0 ) " +
  "\n"+      "                   ) " +
  "\n"+      "              AND A.T_OPDATE BETWEEN to_date('"+ParamProcess.DateIn+"','dd.mm.yyyy') AND to_date('"+ParamProcess.DateOut+"','dd.mm.yyyy') " +
  "\n"+      "              AND A.T_OPDATE = B.T_VALUEDATE " +
  "\n"+      "              AND B.T_VALUEDATE = A.T_OPDATE " +
  "\n"+      "              AND B.T_PAYMENTID = A.T_ACCTRNID * -1 ) " +
  "\n"+      "     AND C.T_ACCTRNID < 0 " +
  "\n"+      "     AND C.T_ACCT_DB IS NOT NULL " +
  "\n"+      "     AND C.T_ACCT_CR IS NOT NULL " +
  "\n"+      "     AND EXISTS( SELECT 1 FROM dpmpaym_dbt D " +
  "\n"+      "                  WHERE D.T_PAYMENTID = C.T_ACCTRNID * -1 " +
  "\n"+      "                    AND ( D.T_PAYERACCOUNT <> C.T_ACCT_DB " +
  "\n"+      "                          AND D.T_FUTUREPAYERACCOUNT <> C.T_ACCT_DB " +
  "\n"+      "                          AND NOT EXISTS( SELECT 1 FROM dbrokacc_dbt E " +
  "\n"+      "                                           WHERE E.T_ACCOUNT =  C.T_ACCT_DB ) " +
  "\n"+      "                           OR D.T_RECEIVERACCOUNT <> C.T_ACCT_CR " +
  "\n"+      "                          AND D.T_FUTURERECEIVERACCOUNT <> C.T_ACCT_CR " +
  "\n"+      "                          AND NOT EXISTS( SELECT 1 FROM dbrokacc_dbt E " +
  "\n"+      "                                           WHERE E.T_ACCOUNT =  C.T_ACCT_CR ) " +
  "\n"+      "                           OR ( CASE WHEN D.T_FIID = 0 AND D.T_PAYFIID = 0 OR C.T_AMTCUR = 0 /*переоценка*/ THEN 0 ELSE D.T_AMOUNT END ) <> C.T_AMTCUR " +
  "\n"+      "                         )" +
  "\n"+      "                ) " +
  "\n"+      "     AND EXISTS( SELECT 1 FROM  utableprocessevent_dbt D " +
  "\n"+      "                  WHERE D.T_OBJECTID = C.T_ACCTRNID * -1 " +
  "\n"+      "                    AND D.T_OBJECTTYPE = 501 " +
  "\n"+      "                    AND D.T_TYPE IN( 1, 2 ) " +
  "\n"+      "                    AND D.T_STATUS = 4 " +
  "\n"+      "                    AND D.T_MESSAGEID IS NOT NULL " +
  "\n"+      "                    AND D.T_MESSAGEID > 0 " +
  "\n"+      "                    AND NOT EXISTS( SELECT 1 FROM utableprocessevent_dbt I " +
  "\n"+      "                                     WHERE I.T_OBJECTID = D.T_OBJECTID " +
  "\n"+      "                                       AND I.T_OBJECTTYPE = D.T_OBJECTTYPE " +
  "\n"+      "                                       AND I.T_TYPE = 3 " +
  "\n"+      "                                       AND I.T_RECID >  D.T_RECID ) ) " +
  "\n"+      "  UNION ALL " +

              // --из СОФР в ЦФТ платежи ЦФТ присутствуют в СОФР, задвоенные в ЦФТ
  "\n"+      "  SELECT D.T_AUTOKEY, D.T_COUNTER, D.T_USERID, D.T_OPDATE, D.T_DOCDATE, D.T_ACCT_DB, D.T_ACCT_CR, D.T_CURRENCY, D.T_AMTCUR, D.T_AMTRUB, " +
  "\n"+      "         D.T_DETAILS, D.T_DOCNUM, D.T_ACCTRNID, D.T_IDBISCOTTO, D.T_REQID, 3 AS T_ERR_CODE, 'Из СОФР в ЦФТ. Присутствует в СОФР, задвоенные в ЦФТ' AS T_ERR_TEXT, " +
  "\n"+      "         0 AS T_OPER, '' AS T_MODULE, 0 AS t_cftcur, 0 AS t_cftrub " +
  "\n"+      "    FROM uloadentforcompare_dbt D, " +
  "\n"+      "         ( SELECT T_ACCTRNID, MAX( T_AUTOKEY ) AS T_AUTOKEY_DOUBLE, MIN( T_AUTOKEY ) AS T_AUTOKEY_PRIOR  " +
  "\n"+      "             FROM uloadentforcompare_dbt C " +
  "\n"+      "            WHERE C.T_REQID = '"+Reqid+"' " +
  "\n"+      "              AND C.T_AUTOKEY IN " +
  "\n"+      "                  ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dpmpaym_dbt B " +
  "\n"+      "                                             , ( " + SQLStrFromArray + " ) Z " +
  "\n"+      "                     WHERE A.T_REQID = '"+Reqid+"' " +
  "\n"+      "                       AND (Z.ID < 0 " +
  "\n"+      "                            OR ( Z.ACC_D = CHR(1) " +
  "\n"+      "                                OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_FUTUREPAYERACCOUNT ) > 0 " +
  "\n"+      "                                OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_PAYERACCOUNT ) > 0 ) " +
  "\n"+      "                           AND ( Z.ACC_C = CHR(1) " +
  "\n"+      "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_FUTURERECEIVERACCOUNT ) > 0 " +
  "\n"+      "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_RECEIVERACCOUNT ) > 0) " +
  "\n"+      "                           AND ( Z.PERSN = CHR(1) " +
  "\n"+      "                                 OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE " +
  "\n"+      "                                                                                          WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                                          WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
  "\n"+      "                                                                                          WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
  "\n"+      "                                                                                          ELSE Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                                       END ) AS T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                                FROM ( SELECT NVL( ( SELECT U.T_NAME FROM dllvalues_dbt U " +
  "\n"+      "                                                                                                      WHERE U.T_LIST = 5005 " +
  "\n"+      "                                                                                                        AND U.T_ELEMENT = B.T_NUMBERPACK ), '9090909') AS CNTRPERSNUMBER, " +
  "\n"+      "                                                                                              NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
  "\n"+      "                                                                                                      WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
  "\n"+      "                                                                                                                        WHERE V.T_OBJECTTYPE = 92 " +
  "\n"+      "                                                                                                                          AND V.T_NOTEKIND = 200 " +
  "\n"+      "                                                                                                                          AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
  "\n"+      "                                                                                                                          AND V.T_DATE <= B.T_VALUEDATE ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
  "\n"+      "                                                                                              ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' " +
  "\n"+      "                                                                                                     ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
  "\n"+      "                                                                                                             WHERE W.T_CODE = B.T_DEPARTMENT ) " +
  "\n"+      "                                                                                                 END ) AS T_BRANCH " +
  "\n"+      "                                                                                         FROM DUAL ) Y ) ) > 0 ) " +
  "\n"+      "                            ) " +
  "\n"+      "                       AND A.T_OPDATE BETWEEN to_date('"+ParamProcess.DateIn+"','dd.mm.yyyy') AND to_date('"+ParamProcess.DateOut+"','dd.mm.yyyy') " +
  "\n"+      "                       AND A.T_OPDATE = B.T_VALUEDATE " +
  "\n"+      "                       AND ( B.T_FUTUREPAYERACCOUNT = A.T_ACCT_DB " +
  "\n"+      "                            OR B.T_PAYERACCOUNT = A.T_ACCT_DB " +
  "\n"+      "                            OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
  "\n"+      "                                        WHERE D.T_ACCOUNT =  A.T_ACCT_DB ) ) " +
  "\n"+      "                       AND ( B.T_FUTURERECEIVERACCOUNT = A.T_ACCT_CR " +
  "\n"+      "                            OR B.T_RECEIVERACCOUNT = A.T_ACCT_CR " +
  "\n"+      "                            OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
  "\n"+      "                                        WHERE D.T_ACCOUNT =  A.T_ACCT_CR ) ) " +
  "\n"+      "                       AND B.T_VALUEDATE = A.T_OPDATE " +
  "\n"+      "                       AND B.T_PAYMENTID = A.T_ACCTRNID * -1 ) " +
  "\n"+      "              AND C.T_ACCTRNID < 0 " +
  "\n"+      "              AND C.T_ACCT_DB IS NOT NULL " +
  "\n"+      "              AND C.T_ACCT_CR IS NOT NULL " +
  "\n"+      "              AND EXISTS( SELECT 1 FROM  utableprocessevent_dbt D " +
  "\n"+      "                           WHERE D.T_OBJECTID = C.T_ACCTRNID * -1 " +
  "\n"+      "                             AND D.T_OBJECTTYPE = 501 " +
  "\n"+      "                             AND D.T_TYPE = 1 " +
  "\n"+      "                             AND D.T_STATUS = 4 " +
  "\n"+      "                             AND D.T_MESSAGEID IS NOT NULL " +
  "\n"+      "                             AND D.T_MESSAGEID > 0 " +
  "\n"+      "                             AND NOT EXISTS( SELECT 1 FROM utableprocessevent_dbt I " +
  "\n"+      "                                              WHERE I.T_OBJECTID = D.T_OBJECTID " +
  "\n"+      "                                                AND I.T_OBJECTTYPE = D.T_OBJECTTYPE " +
  "\n"+      "                                                AND I.T_TYPE = 3 " +
  "\n"+      "                                                AND I.T_RECID >  D.T_RECID ) ) " +
  "\n"+      "           GROUP BY T_ACCTRNID " +
  "\n"+      "           HAVING COUNT(T_ACCTRNID) > 1 " +
  "\n"+      "          ) A " +
  "\n"+      "   WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
  "\n"+      "                      WHERE V.T_BISCOTTOID = D.T_IDBISCOTTO ) " +
  "\n"+      "     AND D.T_AUTOKEY = A.T_AUTOKEY_DOUBLE " +
  "\n"+      "  UNION ALL " +

              // --из СОФР в ЦФТ платежи СОФР отсутствуют в ЦФТ
  "\n"+      "  SELECT -1 AS T_AUTOKEY, CHR(0) AS T_COUNTER, CHR(0) AS T_USERID, C.T_VALUEDATE AS T_OPDATE, C.T_VALUEDATE AS T_DOCDATE, C.T_PAYERACCOUNT AS T_ACCT_DB, " +
  "\n"+      "         C.T_RECEIVERACCOUNT AS T_ACCT_CR, " +
  "\n"+      "         ( SELECT F.T_CODEINACCOUNT FROM dfininstr_dbt F " +
  "\n"+      "            WHERE F.T_FIID = C.T_FIID ) AS T_CURRENCY, " +
  "\n"+      "         C.T_AMOUNT AS T_AMTCUR, C.T_BASEAMOUNT AS T_AMTRUB, " +
  "\n"+      "         H.T_GROUND AS T_DETAILS, TO_CHAR( C.T_PAYMENTID ) AS T_DOCNUM, C.T_PAYMENTID, CHR(0) AS T_IDBISCOTTO, CHR(0) AS T_REQID, 4 AS T_ERR_CODE, " +
  "\n"+      "         USR_PKG_IMPORT_SOFR.GetStrEventErr( 1, 501, C.T_PAYMENTID ) AS T_ERR_TEXT, " +
  "\n"+      "         0 AS T_OPER, '' AS T_MODULE, 0 AS t_cftcur, 0 AS t_cftrub " +
  "\n"+      "    FROM dpmpaym_dbt C, dpmrmprop_dbt H " +
  "\n"+      "         , ( " + SQLStrFromArray + " ) X " +
  "\n"+      "   WHERE C.T_VALUEDATE BETWEEN to_date('"+ParamProcess.DateIn+"','dd.mm.yyyy') AND to_date('"+ParamProcess.DateOut+"','dd.mm.yyyy') " +
  "\n"+      "     AND H.T_PAYMENTID = C.T_PAYMENTID " +
  "\n"+      "     AND ( X.ID < 0 " +
  "\n"+      "          OR ( X.ACC_D = CHR(1) " +
  "\n"+      "              OR RSB_MASK.CompareStringWithMask( X.ACC_D, C.T_PAYERACCOUNT ) > 0 ) " +
  "\n"+      "         AND ( X.ACC_C = CHR(1) " +
  "\n"+      "              OR RSB_MASK.CompareStringWithMask( X.ACC_C, C.T_RECEIVERACCOUNT ) > 0) ) " +
  "\n"+      "     AND C.T_PAYMENTID NOT IN " +
  "\n"+      "         ( SELECT B.T_PAYMENTID FROM dpmpaym_dbt B, uloadentforcompare_dbt A " +
  "\n"+      "                                     , ( " + SQLStrFromArray + " ) Z " +
  "\n"+      "            WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
  "\n"+      "                               WHERE V.T_BISCOTTOID = A.T_IDBISCOTTO ) " +
  "\n"+      "              AND A.T_REQID = '"+Reqid+"' " +
  "\n"+      "              AND ( Z.ID < 0 " +
  "\n"+      "                   OR ( Z.ACC_D = CHR(1) " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_FUTUREPAYERACCOUNT ) > 0 " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_PAYERACCOUNT ) > 0 ) " +
  "\n"+      "                  AND ( Z.ACC_C = CHR(1) " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_FUTURERECEIVERACCOUNT ) > 0 " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_RECEIVERACCOUNT ) > 0) " +
  "\n"+      "                  AND ( Z.PERSN = CHR(1) " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE " +
  "\n"+      "                                                                                WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                                WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
  "\n"+      "                                                                                WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
  "\n"+      "                                                                                ELSE Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                             END ) AS T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                      FROM ( SELECT NVL( ( SELECT U.T_NAME FROM dllvalues_dbt U " +
  "\n"+      "                                                                                            WHERE U.T_LIST = 5005 " +
  "\n"+      "                                                                                              AND U.T_ELEMENT = B.T_NUMBERPACK ), '9090909') AS CNTRPERSNUMBER, " +
  "\n"+      "                                                                                    NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
  "\n"+      "                                                                                            WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
  "\n"+      "                                                                                                              WHERE V.T_OBJECTTYPE = 92 " +
  "\n"+      "                                                                                                                AND V.T_NOTEKIND = 200 " +
  "\n"+      "                                                                                                                AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
  "\n"+      "                                                                                                                AND V.T_DATE <= B.T_VALUEDATE ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
  "\n"+      "                                                                                    ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' " +
  "\n"+      "                                                                                           ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
  "\n"+      "                                                                                                   WHERE W.T_CODE = B.T_DEPARTMENT ) " +
  "\n"+      "                                                                                       END ) AS T_BRANCH " +
  "\n"+      "                                                                               FROM DUAL ) Y ) ) > 0 ) " +
  "\n"+      "                   ) " +
  "\n"+      "              AND A.T_ACCTRNID < 0 " +
  "\n"+      "              AND A.T_OPDATE BETWEEN to_date('"+ParamProcess.DateIn+"','dd.mm.yyyy') AND to_date('"+ParamProcess.DateOut+"','dd.mm.yyyy') " +
  "\n"+      "              AND A.T_OPDATE = B.T_VALUEDATE " +
  "\n"+      "              AND A.T_ACCTRNID = B.T_PAYMENTID  * -1 ) " + 
  "\n"+      "     AND EXISTS( SELECT 1 FROM utableprocessevent_dbt D " +
  "\n"+      "                  WHERE D.T_OBJECTID = C.T_PAYMENTID " +
  "\n"+      "                    AND D.T_OBJECTTYPE = 501 " +
  "\n"+      "                    AND D.T_TYPE = 1 " +
  //shev biq-8113
  //"\n"+      "                AND D.T_STATUS IN( 4, 5 ) " + //!!!исключаем коллизии - ошибка выгрузки в ЦФТ
  //"\n"+      "                AND D.T_MESSAGEID IS NOT NULL " +
  //"\n"+      "                AND D.T_MESSAGEID > 0 " +
  "\n"+      "                    AND NOT EXISTS( SELECT 1 FROM utableprocessevent_dbt I " +
  "\n"+      "                                     WHERE I.T_OBJECTID = D.T_OBJECTID " +
  "\n"+      "                                       AND I.T_OBJECTTYPE = D.T_OBJECTTYPE " +
  "\n"+      "                                       AND I.T_TYPE = 3 " +
  "\n"+      "                                       AND I.T_RECID >  D.T_RECID ) ) " +
  "\n"+      "  UNION ALL " +

              // --из ЦФТ в СОФР платежи ЦФТ отсутствуют в СОФР
  "\n"+      "  SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB, " +
  "\n"+      "         T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 1 AS T_ERR_CODE, " +
  "\n"+      "         USR_PKG_IMPORT_SOFR.GetStrEventErr( 2, -1, TO_NUMBER( T_IDBISCOTTO ) ) AS T_ERR_TEXT, " +
  "\n"+      "         0 AS T_OPER, '' AS T_MODULE, 0 AS t_cftcur, 0 AS t_cftrub " +
  "\n"+      "    FROM uloadentforcompare_dbt C " +
  "\n"+      "   WHERE EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
  "\n"+      "                  WHERE V.T_BISCOTTOID = C.T_IDBISCOTTO " +
  "\n"+      "                    AND V.T_DOCKIND IN(322, 320) ) " +
  "\n"+      "     AND C.T_AUTOKEY NOT IN " +
  "\n"+      "         ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dpmpaym_dbt B " +
  "\n"+      "                                    , ( " + SQLStrFromArray + " ) Z " +
  "\n"+      "            WHERE A.T_REQID = '"+Reqid+"' " +
  "\n"+      "              AND ( Z.ID < 0 " +
  "\n"+      "                   OR ( Z.ACC_D = CHR(1) " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_FUTUREPAYERACCOUNT ) > 0 " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_PAYERACCOUNT ) > 0 ) " +
  "\n"+      "                  AND ( Z.ACC_C = CHR(1) " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_FUTURERECEIVERACCOUNT ) > 0 " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_RECEIVERACCOUNT ) > 0 ) " + 
  "\n"+      "                  AND ( Z.PERSN = CHR(1) " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE " +
  "\n"+      "                                                                                 WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                                 WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
  "\n"+      "                                                                                 WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
  "\n"+      "                                                                                 ELSE Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                              END ) AS T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                      FROM ( SELECT NVL( ( SELECT U.T_NAME FROM dllvalues_dbt U " +
  "\n"+      "                                                                                            WHERE U.T_LIST = 5005 " +
  "\n"+      "                                                                                              AND U.T_ELEMENT = B.T_NUMBERPACK ), '9090909') AS CNTRPERSNUMBER, " +
  "\n"+      "                                                                                    NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
  "\n"+      "                                                                                            WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
  "\n"+      "                                                                                                              WHERE V.T_OBJECTTYPE = 92 " +
  "\n"+      "                                                                                                                AND V.T_NOTEKIND = 200 " +
  "\n"+      "                                                                                                                AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
  "\n"+      "                                                                                                                AND V.T_DATE <= B.T_VALUEDATE ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
  "\n"+      "                                                                                    ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' " +
  "\n"+      "                                                                                           ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
  "\n"+      "                                                                                                   WHERE W.T_CODE = B.T_DEPARTMENT ) " +
  "\n"+      "                                                                                       END ) AS T_BRANCH " +
  "\n"+      "                                                                               FROM DUAL ) Y ) ) > 0 ) " +
  "\n"+      "                   ) " +
  "\n"+      "               AND A.T_OPDATE BETWEEN to_date('"+ParamProcess.DateIn+"','dd.mm.yyyy') AND to_date('"+ParamProcess.DateOut+"','dd.mm.yyyy') " +
  "\n"+      "               AND A.T_OPDATE = B.T_VALUEDATE " +
  "\n"+      "               AND B.T_PAYMENTID = A.T_ACCTRNID * -1 ) " +
  "\n"+      "     AND C.T_REQID = '"+Reqid+"' " +
  "\n"+      "     AND C.T_ACCTRNID < 0 " +
  "\n"+      "     AND C.T_ACCT_DB IS NOT NULL " +
  "\n"+      "     AND C.T_ACCT_CR IS NOT NULL " +
  "\n"+      "  UNION ALL " +

              // --из ЦФТ в СОФР платежи ЦФТ присутствуют в СОФР, не соответствуют реквизиты
  "\n"+      "  SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB, " +
  "\n"+      "         T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 2 AS T_ERR_CODE, 'Из ЦФТ в СОФР. Присутствует в СОФР, не соответствуют реквизиты: ' || " +
  "\n"+      "         USR_PKG_IMPORT_SOFR.GetDifferenceStrErr( 2, C.T_ACCT_DB, C.T_ACCT_CR, C.T_AMTCUR, C.T_AMTRUB, C.T_CURRENCY, C.T_DETAILS, C.T_DOCNUM, " +
  "\n"+      "         C.T_ACCTRNID, C.T_IDBISCOTTO, C.T_REQID ) AS T_ERR_TEXT, " +
  "\n"+      "         ( SELECT R.T_OPER FROM dpmpaym_dbt R WHERE R.T_PAYMENTID = C.T_ACCTRNID * -1 ) AS T_OPER, " +
  "\n"+      "         ( SELECT W.T_BOFFICE FROM rshb_fd_groups W " +
  "\n"+      "            WHERE W.T_GROUPID IN(" +
  "\n"+      "               ( SELECT O.T_GROUPID FROM dacsgroupoper_dbt O " +
  "\n"+      "                  WHERE O.T_OPER = ( SELECT R.T_OPER FROM dpmpaym_dbt R " +
  "\n"+      "                                      WHERE R.T_PAYMENTID = C.T_ACCTRNID * -1 ))) " +
  "\n"+      "              AND ROWNUM = 1 ) AS T_MODULE, 0 AS t_cftcur, 0 AS t_cftrub " +
  "\n"+      "    FROM uloadentforcompare_dbt C " +
  "\n"+      "   WHERE C.T_REQID = '"+Reqid+"' " +
  "\n"+      "     AND EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
  "\n"+      "                  WHERE V.T_BISCOTTOID = C.T_IDBISCOTTO " +
  "\n"+      "                    AND V.T_DOCKIND IN( 322, 320) ) " +
  "\n"+      "     AND C.T_AUTOKEY IN  " +
  "\n"+      "         ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dpmpaym_dbt B " +
  "\n"+      "                                    , ( " + SQLStrFromArray + " ) Z " +
  "\n"+      "            WHERE A.T_REQID = '"+Reqid+"' " + 
  "\n"+      "              AND ( Z.ID < 0 " +
  "\n"+      "                   OR ( Z.ACC_D = CHR(1) " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_FUTUREPAYERACCOUNT ) > 0 " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_PAYERACCOUNT ) > 0 ) " +
  "\n"+      "                  AND ( Z.ACC_C = CHR(1) " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_FUTURERECEIVERACCOUNT ) > 0 " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_RECEIVERACCOUNT ) > 0 ) " +
  "\n"+      "                  AND ( Z.PERSN = CHR(1) " +
  "\n"+      "                       OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE " +
  "\n"+      "                                                                                 WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                                 WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
  "\n"+      "                                                                                 WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
  "\n"+      "                                                                                 ELSE Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                             END ) AS T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                      FROM ( SELECT NVL( ( SELECT U.T_NAME FROM dllvalues_dbt U " +
  "\n"+      "                                                                                            WHERE U.T_LIST = 5005 " +
  "\n"+      "                                                                                              AND U.T_ELEMENT = B.T_NUMBERPACK ), '9090909') AS CNTRPERSNUMBER, " +
  "\n"+      "                                                                                    NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
  "\n"+      "                                                                                            WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
  "\n"+      "                                                                                                              WHERE V.T_OBJECTTYPE = 92 " +
  "\n"+      "                                                                                                                AND V.T_NOTEKIND = 200 " +
  "\n"+      "                                                                                                                AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
  "\n"+      "                                                                                                                AND V.T_DATE <= B.T_VALUEDATE ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
  "\n"+      "                                                                                    ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' " +
  "\n"+      "                                                                                           ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
  "\n"+      "                                                                                                   WHERE W.T_CODE = B.T_DEPARTMENT ) " +
  "\n"+      "                                                                                       END ) AS T_BRANCH " +
  "\n"+      "                                                                               FROM DUAL ) Y ) ) > 0 ) " +
  "\n"+      "                   ) " +
  "\n"+      "              AND A.T_OPDATE BETWEEN to_date('"+ParamProcess.DateIn+"','dd.mm.yyyy') AND to_date('"+ParamProcess.DateOut+"','dd.mm.yyyy') " +
  "\n"+      "              AND A.T_OPDATE = B.T_VALUEDATE " +
  "\n"+      "              AND ( B.T_FUTUREPAYERACCOUNT = A.T_ACCT_DB " +
  "\n"+      "                    OR B.T_PAYERACCOUNT = A.T_ACCT_DB " +
  "\n"+      "                    OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
  "\n"+      "                                WHERE D.T_ACCOUNT =  A.T_ACCT_DB ) ) " +
  "\n"+      "              AND ( B.T_FUTURERECEIVERACCOUNT = A.T_ACCT_CR " +
  "\n"+      "                    OR B.T_RECEIVERACCOUNT = A.T_ACCT_CR " +
  "\n"+      "                    OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
  "\n"+      "                                WHERE D.T_ACCOUNT =  A.T_ACCT_CR ) ) " +
  "\n"+      "              AND B.T_VALUEDATE = A.T_OPDATE " +
  "\n"+      "              AND B.T_PAYMENTID = A.T_ACCTRNID * -1 " +
  "\n"+      "          )  " +
  "\n"+      "     AND C.T_ACCTRNID < 0 " +
  "\n"+      "     AND C.T_ACCT_DB IS NOT NULL " +
  "\n"+      "     AND C.T_ACCT_CR IS NOT NULL " +
  "\n"+      "     AND EXISTS( SELECT 1 FROM dpmpaym_dbt D " +
  "\n"+      "                  WHERE D.T_PAYMENTID = C.T_ACCTRNID * -1 " +
  "\n"+      "                    AND ( D.T_PAYERACCOUNT <> C.T_ACCT_DB " +
  "\n"+      "                          AND D.T_FUTUREPAYERACCOUNT <> C.T_ACCT_DB " +
  "\n"+      "                          AND NOT EXISTS( SELECT 1 FROM dbrokacc_dbt E " +
  "\n"+      "                                           WHERE E.T_ACCOUNT =  C.T_ACCT_DB ) " +
  "\n"+      "                           OR D.T_RECEIVERACCOUNT <> C.T_ACCT_CR " +
  "\n"+      "                          AND D.T_FUTURERECEIVERACCOUNT <> C.T_ACCT_CR " +
  "\n"+      "                          AND NOT EXISTS( SELECT 1 FROM dbrokacc_dbt E " +
  "\n"+      "                                           WHERE E.T_ACCOUNT =  C.T_ACCT_CR ) " +
  "\n"+      "                           OR ( CASE WHEN D.T_FIID = 0 AND D.T_PAYFIID = 0 OR C.T_AMTCUR = 0 /*переоценка*/ THEN 0 ELSE D.T_AMOUNT END ) <> C.T_AMTCUR " +
  "\n"+      "                         )" +
  "\n"+      "                ) " +
  "\n"+      "  UNION ALL " +

              // --из ЦФТ в СОФР платежи ЦФТ присутствуют в СОФР, задвоенные в ЦФТ
  "\n"+      "  SELECT D.T_AUTOKEY, D.T_COUNTER, D.T_USERID, D.T_OPDATE, D.T_DOCDATE, D.T_ACCT_DB, D.T_ACCT_CR, D.T_CURRENCY, D.T_AMTCUR, D.T_AMTRUB, " +
  "\n"+      "         D.T_DETAILS, D.T_DOCNUM, D.T_ACCTRNID, D.T_IDBISCOTTO, D.T_REQID, 3 AS T_ERR_CODE, 'Из ЦФТ в СОФР. Присутствует в СОФР, задвоенные в ЦФТ' AS T_ERR_TEXT, " +
  "\n"+      "         0 AS T_OPER, '' AS T_MODULE, 0 AS t_cftcur, 0 AS t_cftrub " +
  "\n"+      "    FROM uloadentforcompare_dbt D, " +
  "\n"+      "         ( SELECT T_ACCTRNID, MAX( T_AUTOKEY ) AS T_AUTOKEY_DOUBLE, MIN( T_AUTOKEY ) AS T_AUTOKEY_PRIOR " +
  "\n"+      "             FROM uloadentforcompare_dbt C " +
  "\n"+      "            WHERE C.T_REQID = '"+Reqid+"' " +
  "\n"+      "              AND C.T_AUTOKEY IN " +
  "\n"+      "                  ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dpmpaym_dbt B " +
  "\n"+      "                                             , ( " + SQLStrFromArray + " ) Z " +
  "\n"+      "                     WHERE A.T_REQID = '"+Reqid+"' " +
  "\n"+      "                       AND ( Z.ID < 0 " +
  "\n"+      "                            OR ( Z.ACC_D = CHR(1) " +
  "\n"+      "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_FUTUREPAYERACCOUNT ) > 0 " +
  "\n"+      "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_PAYERACCOUNT ) > 0 ) " +
  "\n"+      "                            AND ( Z.ACC_C = CHR(1) " +
  "\n"+      "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_FUTURERECEIVERACCOUNT ) > 0 " +
  "\n"+      "                                 OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_RECEIVERACCOUNT ) > 0) " +
  "\n"+      "                            AND ( Z.PERSN = CHR(1) " +
  "\n"+      "                                  OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE " +
  "\n"+      "                                                                                           WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                                           WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
  "\n"+      "                                                                                           WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
  "\n"+      "                                                                                           ELSE Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                                        END ) AS T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                                 FROM ( SELECT NVL( ( SELECT U.T_NAME FROM dllvalues_dbt U " +
  "\n"+      "                                                                                                       WHERE U.T_LIST = 5005 " +
  "\n"+      "                                                                                                         AND U.T_ELEMENT = B.T_NUMBERPACK ), '9090909') AS CNTRPERSNUMBER, " +
  "\n"+      "                                                                                               NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
  "\n"+      "                                                                                                       WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
  "\n"+      "                                                                                                                         WHERE V.T_OBJECTTYPE = 92 " +
  "\n"+      "                                                                                                                           AND V.T_NOTEKIND = 200 " +
  "\n"+      "                                                                                                                           AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
  "\n"+      "                                                                                                                           AND V.T_DATE <= B.T_VALUEDATE ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
  "\n"+      "                                                                                               ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' " +
  "\n"+      "                                                                                                      ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
  "\n"+      "                                                                                                              WHERE W.T_CODE = B.T_DEPARTMENT ) " +
  "\n"+      "                                                                                                  END ) AS T_BRANCH " +
  "\n"+      "                                                                                          FROM DUAL ) Y ) ) > 0 ) " +
  "\n"+      "                            ) " +
  "\n"+      "                       AND A.T_OPDATE BETWEEN to_date('"+ParamProcess.DateIn+"','dd.mm.yyyy') AND to_date('"+ParamProcess.DateOut+"','dd.mm.yyyy') " +
  "\n"+      "                       AND A.T_OPDATE = B.T_VALUEDATE " +
  "\n"+      "                       AND ( B.T_FUTUREPAYERACCOUNT = A.T_ACCT_DB " +
  "\n"+      "                            OR B.T_PAYERACCOUNT = A.T_ACCT_DB " +
  "\n"+      "                            OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
  "\n"+      "                                        WHERE D.T_ACCOUNT =  A.T_ACCT_DB ) ) " +
  "\n"+      "                       AND ( B.T_FUTURERECEIVERACCOUNT = A.T_ACCT_CR " +
  "\n"+      "                            OR B.T_RECEIVERACCOUNT = A.T_ACCT_CR " +
  "\n"+      "                            OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
  "\n"+      "                                        WHERE D.T_ACCOUNT =  A.T_ACCT_CR ) ) " +
  "\n"+      "                       AND B.T_VALUEDATE = A.T_OPDATE " +
  "\n"+      "                       AND B.T_PAYMENTID = A.T_ACCTRNID * -1 " +
  "\n"+      "                   ) " +
  "\n"+      "              AND C.T_ACCTRNID < 0 " +
  "\n"+      "              AND C.T_ACCT_DB IS NOT NULL " +
  "\n"+      "              AND C.T_ACCT_CR IS NOT NULL " +
  "\n"+      "           GROUP BY T_ACCTRNID " +
  "\n"+      "           HAVING COUNT(T_ACCTRNID) > 1 " +
  "\n"+      "          ) A " +
  "\n"+      "   WHERE EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
  "\n"+      "                  WHERE V.T_BISCOTTOID = D.T_IDBISCOTTO " +
  "\n"+      "                    AND V.T_DOCKIND IN(322, 320)  ) " +
  "\n"+      "     AND D.T_AUTOKEY = A.T_AUTOKEY_DOUBLE " +
  "\n"+      "  UNION ALL " +

              // --из ЦФТ в СОФР операции ЦФТ отсутствуют в СОФР
  "\n"+      "  SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB, " +
  "\n"+      "         T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 1 AS T_ERR_CODE, 'Из ЦФТ в СОФР. Отсутствует в СОФР' AS T_ERR_TEXT, " +
  "\n"+      "         0 AS T_OPER, '' AS T_MODULE, 0 AS t_cftcur, 0 AS t_cftrub " +
  "\n"+      "    FROM uloadentforcompare_dbt C " +
  "\n"+      "   WHERE EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
  "\n"+      "                  WHERE V.T_BISCOTTOID = C.T_IDBISCOTTO " +
  "\n"+      "                    AND V.T_DOCKIND NOT IN(322, 320, 48) ) " +
  "\n"+      "     AND C.T_AUTOKEY NOT IN " +
  "\n"+      "         ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dnptxop_dbt B " +
  "\n"+      "                                    , ( " + SQLStrFromArray + " ) Z " +
  "\n"+      "            WHERE A.T_REQID = '"+Reqid+"' " +
  "\n"+      "              AND ( Z.ID < 0 " +
  "\n"+      "                    OR ( Z.ACC_D = CHR(1) " +
  "\n"+      "                        OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_ACCOUNT ) > 0 ) " +
  "\n"+      "                   AND ( Z.PERSN = CHR(1) " +
  "\n"+      "                        OR RSB_MASK.CompareStringWithMask( Z.PERSN, ( SELECT ( CASE " +
  "\n"+      "                                                                                  WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                                  WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
  "\n"+      "                                                                                  WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
  "\n"+      "                                                                                  ELSE Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                               END ) AS T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                        FROM ( SELECT '9090909' AS CNTRPERSNUMBER, " +
  "\n"+      "                                                                                      NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
  "\n"+      "                                                                                              WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
  "\n"+      "                                                                                                                WHERE V.T_OBJECTTYPE = 92 " +
  "\n"+      "                                                                                                                  AND V.T_NOTEKIND = 200 " +
  "\n"+      "                                                                                                                  AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
  "\n"+      "                                                                                                                  AND V.T_DATE <= B.T_OPERDATE ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
  "\n"+      "                                                                                      ( CASE WHEN B.T_DEPARTMENT = 1 THEN '0000' ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
  "\n"+      "                                                                                                                                         WHERE W.T_CODE = B.T_DEPARTMENT ) END ) AS T_BRANCH " +
  "\n"+      "                                                                                 FROM DUAL ) Y ) ) > 0 ) " +
  "\n"+      "                   ) " +
  "\n"+      "              AND A.T_OPDATE BETWEEN to_date('"+ParamProcess.DateIn+"','dd.mm.yyyy') AND to_date('"+ParamProcess.DateOut+"','dd.mm.yyyy') " +
  "\n"+      "              AND A.T_OPDATE = B.T_OPERDATE " +
  "\n"+      "              AND B.T_OPERDATE = A.T_OPDATE " +
  "\n"+      "              AND B.T_ID = A.T_ACCTRNID * -1 )  " +
  "\n"+      "     AND C.T_REQID = '"+Reqid+"' " +
  "\n"+      "     AND C.T_ACCTRNID < 0 " +
  "\n"+      "     AND C.T_ACCT_DB IS NOT NULL " +
  "\n"+      "     AND C.T_ACCT_CR IS NOT NULL " +
  "\n"+      "     AND nvl(C.not_loaded,chr(0)) <> chr(88) " +

  //shev isup 531441
  // +костыль по дефекту со счетами 40817810099999999999 и 40817810500009999999
  "\n"+      "     AND NOT EXISTS ( SELECT * FROM dacctrn_dbt d " +
  "\n"+      "                       WHERE (   (D.T_ACCOUNT_PAYER = C.T_ACCT_DB) " +
  "\n"+      "                              OR ( substr(D.T_ACCOUNT_PAYER,1,5)||substr(D.T_ACCOUNT_PAYER,10) in ('4081700009999999','4081799999999999') " +
  "\n"+      "                                   AND substr(C.T_ACCT_DB,1,5)||substr(C.T_ACCT_DB,10) in ('4081700009999999','40817899999999999') )" +
  "\n"+      "                              ) " +
  "\n"+      "                         AND D.T_ACCOUNT_RECEIVER = C.T_ACCT_CR AND D.T_DATE_CARRY = C.T_OPDATE AND D.T_SUM_NATCUR = C.T_AMTRUB ) " +

  // BIQ-10484 сверка по комиссиям
              // --из ЦФТ в СОФР операции ЦФТ отсутствуют в СОФР
  "\n"+      "  UNION ALL  " +
  "\n"+      "  SELECT C.T_AUTOKEY, C.T_COUNTER, C.T_USERID, C.T_OPDATE, C.T_DOCDATE, C.T_ACCT_DB, C.T_ACCT_CR, C.T_CURRENCY, C.T_AMTCUR, C.T_AMTRUB, " +
  "\n"+      "         C.T_DETAILS, C.T_DOCNUM, C.T_ACCTRNID, C.T_IDBISCOTTO, C.T_REQID, 1 AS T_ERR_CODE, "+
  "\n"+      "         case nvl(u.t_docstate,-1) "+
  "\n"+      "            when 0 then  'Из ЦФТ в СОФР. Операция в статусе <Отложена>' "+
  "\n"+      "            when 1 then  'Из ЦФТ в СОФР. Операция в статусе <Открыта>'  "+
  "\n"+      "            else 'Из ЦФТ в СОФР. Отсутствует в СОФР' "+
  "\n"+      "         end AS T_ERR_TEXT, "+
  "\n"+      "         0 AS T_OPER, '' AS T_MODULE, 0 AS t_cftcur, 0 AS t_cftrub " +
  "\n"+      "    FROM uloadentforcompare_dbt C, " +
  "\n"+      "     ( SELECT uc.T_AUTOKEY, op.t_docstate FROM uloadentforcompare_dbt uc, ddl_acc_dbt op "+
  "\n"+      "                                    , ( " + SQLStrFromArray + " ) Z " +
  "\n"+      "            WHERE uc.T_REQID = '"+Reqid+"' " +
  "\n"+      "              AND ( Z.ID < 0 " +
  "\n"+      "                    OR ( Z.PERSN = CHR(1) " +
  "\n"+      "                        OR RSB_MASK.CompareStringWithMask( Z.PERSN, ( SELECT ( CASE " +
  "\n"+      "                                                                                  WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                                  WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
  "\n"+      "                                                                                  WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
  "\n"+      "                                                                                  ELSE Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                               END ) AS T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                        FROM ( SELECT '9090909' AS CNTRPERSNUMBER, " +
  "\n"+      "                                                                                      NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
  "\n"+      "                                                                                              WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
  "\n"+      "                                                                                                                WHERE V.T_OBJECTTYPE = 92 " +
  "\n"+      "                                                                                                                  AND V.T_NOTEKIND = 200 " +
  "\n"+      "                                                                                                                  AND V.T_DOCUMENTID = LPAD( TO_CHAR( op.T_OPER ), 10, '0') " +
  "\n"+      "                                                                                                                  AND V.T_DATE <= op.T_DATE ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
  "\n"+      "                                                                                      ( CASE WHEN op.T_DEPARTMENT = 1 THEN '0000' ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
  "\n"+      "                                                                                                                                         WHERE W.T_CODE = op.T_DEPARTMENT ) END ) AS T_BRANCH " +
  "\n"+      "                                                                                 FROM DUAL ) Y ) ) > 0 ) " +
  "\n"+      "                   ) " +
  "\n"+      "              AND uc.T_OPDATE = op.T_DATE " +
  "\n"+      "              AND op.T_ID = uc.T_ACCTRNID * -1 " +
  "\n"+      "        ) u "+
  // если операция не загрузилась из-за ошибки, тогда следов в upmbiscotto_dbt не остается, поэтому поиск выглядит сомнительным и не будем его использовать
  "\n"+      "   WHERE /*EXISTS( SELECT 1 FROM upmbiscotto_dbt V " + 
  "\n"+      "                  WHERE V.T_BISCOTTOID = C.T_IDBISCOTTO " +
  "\n"+      "                    AND V.T_DOCKIND = 48 ) " +
  "\n"+      "     AND*/ C.T_AUTOKEY = u.t_autokey(+) "+
  "\n"+      "     AND C.T_REQID = '"+Reqid+"' " +
  "\n"+      "     AND C.T_ACCTRNID < 0 " +
  "\n"+      "     AND C.T_ACCT_DB like '306%'  " +
  "\n"+      "     AND C.T_ACCT_CR IS NOT NULL " +
  "\n"+      "     AND nvl(C.not_loaded,chr(0)) <> chr(88) " +
  "\n"+      "     AND nvl(u.t_docstate,-1) != 2 " +
  "\n"+      "  UNION ALL  " +
  "\n"+      " SELECT c.T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB, " +
  "\n"+      "       T_DETAILS, T_DOCNUM, c.T_ACCTRNID, T_IDBISCOTTO, T_REQID, 2 AS T_ERR_CODE, 'Из СОФР в ЦФТ. Присутствует в СОФР, не соответствуют реквизиты: ' || " +
  "\n"+      "       case " +
  "\n"+      "        when acctrn.T_ACCOUNT_PAYER <> C.T_ACCT_DB " +
  "\n"+      "             AND NOT EXISTS( SELECT 1 FROM dbrokacc_dbt E " +
  "\n"+      "                              WHERE E.T_ACCOUNT =  C.T_ACCT_DB ) then 'Счет Дебет;' " +
  "\n"+      "        else '' " +
  "\n"+      "       end|| " +
  "\n"+      "       case " +
  "\n"+      "        when ( CASE " +
  "\n"+      "                 WHEN acctrn.T_FIID_PAYER = 0 AND acctrn.T_FIID_RECEIVER = 0 OR C.T_AMTCUR = 0 THEN 0 " +
  "\n"+      "                 ELSE ( CASE WHEN acctrn.T_FIID_PAYER <> 0 THEN acctrn.T_SUM_PAYER " +
  "\n"+      "                             WHEN acctrn.T_FIID_RECEIVER <> 0 THEN acctrn.T_SUM_RECEIVER " +
  "\n"+      "                        END ) " +
  "\n"+      "               END ) <> C.T_AMTCUR then 'Сумма в валюте счета;' " +
  "\n"+      "        else '' " +
  "\n"+      "       end|| " +
  "\n"+      "       case  " +
  "\n"+      "        when acctrn.T_SUM_NATCUR <> C.T_AMTRUB then 'Сумма в нац. валюте;' " +
  "\n"+      "        else '' " +
  "\n"+      "       end  AS T_ERR_TEXT,  " +
  "\n"+      "       ( SELECT R.T_OPER FROM dacctrn_dbt R WHERE R.T_ACCTRNID = C.T_ACCTRNID ) AS T_OPER, " +
  "\n"+      "       ( SELECT W.T_BOFFICE FROM rshb_fd_groups W  " +
  "\n"+      "          WHERE W.T_GROUPID IN ( SELECT O.T_GROUPID FROM dacsgroupoper_dbt O  " +
  "\n"+      "                                 WHERE O.T_OPER = ( SELECT R.T_OPER FROM dacctrn_dbt R  " +
  "\n"+      "                                                       WHERE R.T_ACCTRNID = C.T_ACCTRNID ) ) " +
  "\n"+      "             AND ROWNUM = 1 ) AS T_MODULE, 0 AS t_cftcur, 0 AS t_cftrub " +
  "\n"+      "   FROM uloadentforcompare_dbt C,  doproper_dbt A, ddl_acc_dbt dlacc,  doprdocs_dbt docs, dacctrn_dbt acctrn " +
  "\n"+      "  WHERE C.T_REQID = '"+Reqid+"' " +
  "\n"+      "     AND C.T_AUTOKEY IN " +
  "\n"+      "         ( SELECT A.T_AUTOKEY FROM uloadentforcompare_dbt A, dacctrn_dbt B " +
  "\n"+      "                                   , ( " + SQLStrFromArray + " ) Z " +
  "\n"+      "            WHERE A.T_REQID = '"+Reqid+"' " + 
  "\n"+      "              AND (Z.ID < 0 " +
  "\n"+      "                   OR ( Z.ACC_D = CHR(1) " +
  "\n"+      "                        OR RSB_MASK.CompareStringWithMask( Z.ACC_D, B.T_ACCOUNT_PAYER ) > 0 ) " +
  "\n"+      "                  AND ( Z.ACC_C = CHR(1) " +
  "\n"+      "                        OR RSB_MASK.CompareStringWithMask( Z.ACC_C, B.T_ACCOUNT_RECEIVER ) > 0) " + 
  "\n"+      "                  AND ( Z.PERSN = CHR(1) " +
  "\n"+      "                        OR RSB_MASK.CompareStringWithMask(Z.PERSN, ( SELECT ( CASE " +
  "\n"+      "                                                                                 WHEN Y.T_PERS_NUMBER_BISQUIT <> '9090909' THEN Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                                 WHEN Y.T_PERS_NUMBER_BISQUIT = '9090909' AND Y.CNTRPERSNUMBER <> '9090909' THEN Y.CNTRPERSNUMBER " +
  "\n"+      "                                                                                 WHEN Y.T_BRANCH = '6300' THEN '00100900' " +
  "\n"+      "                                                                                 ELSE Y.T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                              END ) AS T_PERS_NUMBER_BISQUIT " +
  "\n"+      "                                                                       FROM ( SELECT NVL( ( SELECT U.T_NAME FROM dllvalues_dbt U " +
  "\n"+      "                                                                                             WHERE U.T_LIST = 5005 " +
  "\n"+      "                                                                                               AND U.T_ELEMENT = B.T_NUMBER_PACK ), '9090909') AS CNTRPERSNUMBER, " +
  "\n"+      "                                                                                     NVL( ( SELECT RSB_STRUCT.getString(U.T_TEXT) FROM dnotetext_dbt U " +
  "\n"+      "                                                                                             WHERE U.T_ID = ( SELECT MAX(V.T_ID) FROM dnotetext_dbt V " +
  "\n"+      "                                                                                                               WHERE V.T_OBJECTTYPE = 92 " +
  "\n"+      "                                                                                                                 AND V.T_NOTEKIND = 200 " +
  "\n"+      "                                                                                                                 AND V.T_DOCUMENTID = LPAD( TO_CHAR( B.T_OPER ), 10, '0') " +
  "\n"+      "                                                                                                                 AND V.T_DATE <= B.T_DATE_CARRY ) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
  "\n"+      "                                                                                     ( CASE " +
  "\n"+      "                                                                                          WHEN B.T_DEPARTMENT = 1 THEN '0000' " +
  "\n"+      "                                                                                          ELSE ( SELECT W.T_NAME FROM ddp_dep_dbt W " +
  "\n"+      "                                                                                                  WHERE W.T_CODE = B.T_DEPARTMENT ) " +
  "\n"+      "                                                                                       END ) AS T_BRANCH " +
  "\n"+      "                                                                                FROM DUAL ) Y ) ) > 0 ) " +
  "\n"+      "                   ) " +
  "\n"+      "              AND A.T_OPDATE BETWEEN to_date('"+ParamProcess.DateIn+"','dd.mm.yyyy') AND to_date('"+ParamProcess.DateOut+"','dd.mm.yyyy') " +
  "\n"+      "              AND ( B.T_ACCOUNT_PAYER = A.T_ACCT_DB " +
  "\n"+      "                    OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
  "\n"+      "                                WHERE D.T_ACCOUNT =  A.T_ACCT_DB ) ) " +
  "\n"+      "              AND ( B.T_ACCOUNT_RECEIVER = A.T_ACCT_CR " +
  "\n"+      "                    OR EXISTS( SELECT 1 FROM dbrokacc_dbt D " +
  "\n"+      "                                WHERE D.T_ACCOUNT =  A.T_ACCT_CR ) ) " +
  "\n"+      "              AND B.T_DATE_CARRY = A.T_OPDATE " +
  "\n"+      "              AND B.T_ACCTRNID = A.T_ACCTRNID ) " +   
  "\n"+      "   AND C.T_ACCTRNID < 0  " +
  "\n"+      "   AND C.T_ACCT_DB IS NOT NULL " +
  "\n"+      "   AND C.T_ACCT_CR IS NOT NULL " +
  "\n"+      "   AND nvl(C.not_loaded,' ') <> chr(88) " +
  "\n"+      "   AND A.T_KIND_OPERATION = 2030 " +
  "\n"+      "   AND A.T_DOCKIND = dlacc.T_DOCKIND  " +
  "\n"+      "   AND TO_NUMBER(A.T_DOCUMENTID) = dlacc.T_ID " +
  "\n"+      "   AND dlacc.t_opertype = 48 " +  
  "\n"+      "   AND a.T_ID_OPERATION = docs.T_ID_OPERATION " +
  "\n"+      "   and acctrn.t_acctrnid = docs.t_acctrnid " +
  "\n"+      "   and acctrn.t_chapter = 1 " +
  "\n"+      "   AND ( acctrn.T_ACCOUNT_PAYER <> C.T_ACCT_DB " +
  "\n"+      "          AND NOT EXISTS( SELECT 1 FROM dbrokacc_dbt E " +
  "\n"+      "                           WHERE E.T_ACCOUNT =  C.T_ACCT_DB ) " +
  "\n"+      "        OR ( CASE  " +
  "\n"+      "              WHEN acctrn.T_FIID_PAYER = 0 AND acctrn.T_FIID_RECEIVER = 0 OR C.T_AMTCUR = 0 THEN 0  " +
  "\n"+      "              ELSE ( CASE WHEN acctrn.T_FIID_PAYER <> 0 THEN acctrn.T_SUM_PAYER " +
  "\n"+      "                          WHEN acctrn.T_FIID_RECEIVER <> 0 THEN acctrn.T_SUM_RECEIVER " +
  "\n"+      "                     END )  " +
  "\n"+      "              END ) <> C.T_AMTCUR " +
  "\n"+      "        OR acctrn.T_SUM_NATCUR <> C.T_AMTRUB " +
  "\n"+      "        )  " +

  //shev biq-8113
  // Проводки без SOFRID
  "\n"+      "  UNION ALL  " +
  "\n"+      "    SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB,  " +
  "\n"+      "           T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 1 AS T_ERR_CODE, 'Отсутствуют в СОФР, проводки без SOFR ID' AS T_ERR_TEXT,  " +
  "\n"+      "           0 AS T_OPER, '' AS T_MODULE, 0 AS t_cftcur, 0 AS t_cftrub  " +
  "\n"+      "      FROM  uloadentforcompare_dbt u  " +
  "\n"+      "     WHERE u.T_REQID = '"+Reqid+"' " +
  "\n"+      "       AND u.t_acctrnid is null  " +
  "\n"+      "       AND nvl(u.not_loaded,chr(0)) <> chr(88) " +
  "\n"+      "       AND u.t_autokey not in ( " +
  "\n"+      "         SELECT c.t_autokey FROM dacctrn_dbt d , uloadentforcompare_dbt C " +
  "\n"+      "          WHERE d.t_account_payer = c.t_acct_db " +
  "\n"+      "            AND d.t_account_receiver = c.t_acct_cr " +
  "\n"+      "            AND d.t_date_carry = c.t_docdate " +
  "\n"+      "            AND d.t_sum_payer = c.t_amtrub " +
  "\n"+      "            AND c.t_acctrnid is null " +
  "\n"+      "            AND c.T_REQID = '"+Reqid+"' ) " ;

  //shev с ходу ничего лучше не придумал, как убрать peeking bind иначе время выполнения запроса стремится в вечность
  /*
    Params = makeArray( 
  /*01*/SQLParam( "", ReqId ),
  /*02*/SQLParam( "", ParamProcess.DateIn ),
  /*03*/SQLParam( "", ParamProcess.DateOut ),
  /*04*/SQLParam( "", ReqId ),
  /*05*/SQLParam( "", ReqId ),
  /*06*/SQLParam( "", ParamProcess.DateIn ),
  /*07*/SQLParam( "", ParamProcess.DateOut ),
  /*08*/SQLParam( "", ReqId ),
  /*09*/SQLParam( "", ReqId ),
  /*10*/SQLParam( "", ReqId ),
  /*11*/SQLParam( "", ParamProcess.DateIn ),
  /*12*/SQLParam( "", ParamProcess.DateOut ),
  /*13*/SQLParam( "", ReqId ),
  /*14*/SQLParam( "", ReqId ),
  /*15*/SQLParam( "", ParamProcess.DateIn ),
  /*16*/SQLParam( "", ParamProcess.DateOut ),
  /*17*/SQLParam( "", ReqId ),
  /*18*/SQLParam( "", ReqId ),
  /*19*/SQLParam( "", ParamProcess.DateIn ),
  /*20*/SQLParam( "", ParamProcess.DateOut ),
  /*21*/SQLParam( "", ReqId ),
  /*22*/SQLParam( "", ReqId ),
  /*23*/SQLParam( "", ParamProcess.DateIn ),
  /*24*/SQLParam( "", ParamProcess.DateOut ),
  /*25*/SQLParam( "", ParamProcess.DateIn ),
  /*26*/SQLParam( "", ParamProcess.DateOut ),
  /*27*/SQLParam( "", ReqId ),
  /*28*/SQLParam( "", ParamProcess.DateIn ),
  /*29*/SQLParam( "", ParamProcess.DateOut ),
  /*30*/SQLParam( "", ReqId ),
  /*31*/SQLParam( "", ParamProcess.DateIn ),
  /*32*/SQLParam( "", ParamProcess.DateOut ),
  /*33*/SQLParam( "", ReqId ),
  /*34*/SQLParam( "", ReqId ),
  /*35*/SQLParam( "", ParamProcess.DateIn ),
  /*36*/SQLParam( "", ParamProcess.DateOut ),
  /*37*/SQLParam( "", ReqId ),
  /*38*/SQLParam( "", ReqId ),
  /*39*/SQLParam( "", ParamProcess.DateIn ),
  /*40*/SQLParam( "", ParamProcess.DateOut ),
  /*41*/SQLParam( "", ParamProcess.DateIn ),
  /*42*/SQLParam( "", ParamProcess.DateOut ),
  /*43*/SQLParam( "", ReqId ),
  /*44*/SQLParam( "", ParamProcess.DateIn ),
  /*45*/SQLParam( "", ParamProcess.DateOut ),
  /*46*/SQLParam( "", ReqId ),
  /*47*/SQLParam( "", ParamProcess.DateIn ),
  /*48*/SQLParam( "", ParamProcess.DateOut ),
  /*49*/SQLParam( "", ReqId ),
  /*50*/SQLParam( "", ReqId ),
  /*51*/SQLParam( "", ReqId ),
  /*52*/SQLParam( "", ParamProcess.DateIn ),
  /*53*/SQLParam( "", ParamProcess.DateOut ),
  /*54*/SQLParam( "", ReqId ),
  /*55*/SQLParam( "", ReqId ),
  /*56*/SQLParam( "", ParamProcess.DateIn ),
  /*57*/SQLParam( "", ParamProcess.DateOut ),
  /*58*/SQLParam( "", ReqId ),
  /*59*/SQLParam( "", ParamProcess.DateIn ),
  /*60*/SQLParam( "", ParamProcess.DateOut )
  /*61*/SQLParam( "", ReqId ),
  // Cherednichenko 2020-11-19 is: 518209, добавляем параметры для проверки
  /*62*/SQLParam( "", ReqId )
    ); 
   */
    if (false) //печатаем или нет параметры запроса
      var prevSetOutput = SetOutput("..\\txtfile\\outparams.txt");

      println("'"+ReqId+"''");
      println(GetSQLDate(ParamProcess.DateIn));
      println(GetSQLDate(ParamProcess.DateOut));
      println("'"+ReqId+"''");
      println("'"+ReqId+"''");
      println(GetSQLDate(ParamProcess.DateIn));
      println(GetSQLDate(ParamProcess.DateOut));
      println("'"+ReqId+"''");
      println("'"+ReqId+"''");
      println("'"+ReqId+"''");
      println(GetSQLDate(ParamProcess.DateIn));
      println(GetSQLDate(ParamProcess.DateOut));
      println("'"+ReqId+"''");
      println("'"+ReqId+"''");
      println(GetSQLDate(ParamProcess.DateIn));
      println(GetSQLDate(ParamProcess.DateOut));
      println("'"+ReqId+"''");
      println("'"+ReqId+"''");
      println(GetSQLDate(ParamProcess.DateIn));
      println(GetSQLDate(ParamProcess.DateOut));
      println("'"+ReqId+"''");
      println("'"+ReqId+"''");
      println(GetSQLDate(ParamProcess.DateIn));
      println(GetSQLDate(ParamProcess.DateOut));
      println(GetSQLDate(ParamProcess.DateIn));
      println(GetSQLDate(ParamProcess.DateOut));
      println("'"+ReqId+"''");
      println(GetSQLDate(ParamProcess.DateIn));
      println(GetSQLDate(ParamProcess.DateOut));
      println("'"+ReqId+"''");
      println(GetSQLDate(ParamProcess.DateIn));
      println(GetSQLDate(ParamProcess.DateOut));
      println("'"+ReqId+"''");
      println("'"+ReqId+"''");
      println(GetSQLDate(ParamProcess.DateIn));
      println(GetSQLDate(ParamProcess.DateOut));
      println("'"+ReqId+"''");
      println("'"+ReqId+"''");
      println(GetSQLDate(ParamProcess.DateIn));
      println(GetSQLDate(ParamProcess.DateOut));
      println(GetSQLDate(ParamProcess.DateIn));
      println(GetSQLDate(ParamProcess.DateOut));
      println("'"+ReqId+"''");
      println(GetSQLDate(ParamProcess.DateIn));
      println(GetSQLDate(ParamProcess.DateOut));
      println("'"+ReqId+"''");
      println(GetSQLDate(ParamProcess.DateIn));
      println(GetSQLDate(ParamProcess.DateOut));
      println("'"+ReqId+"''");
      println("'"+ReqId+"''");
      println("'"+ReqId+"''");
      println(GetSQLDate(ParamProcess.DateIn));
      println(GetSQLDate(ParamProcess.DateOut));
      println("'"+ReqId+"''");
      println("'"+ReqId+"''");
      println(GetSQLDate(ParamProcess.DateIn));
      println(GetSQLDate(ParamProcess.DateOut));
      println("'"+ReqId+"''");
      println(GetSQLDate(ParamProcess.DateIn));
      println(GetSQLDate(ParamProcess.DateOut));
      println("'"+ReqId+"''");

      SetOutput(prevSetOutput);
    end;


    DataSet = execSQLselect( Query, Params );

   elif(QueryType == 1) // для отладки, простой запрос

    Query =   
             "  SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB, " +
  "\n"+      "         T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 1 AS T_ERR_CODE, " +
  "\n"+      "         USR_PKG_IMPORT_SOFR.GetStrEventErr( 0, 1, T_ACCTRNID ) AS T_ERR_TEXT, " +
  "\n"+      "         0 AS T_OPER, '' AS T_MODULE, 0 AS t_cftcur, 0 AS t_cftrub " +
  "\n"+      "    FROM uloadentforcompare_dbt C " +
  "\n"+      "   WHERE rownum < 4";
    DataSet = execSQLselect( Query, null );

   end;

   return 0;


  onError(err)

   return 1;
   
  end; // GetDataSet
  //получим курсор

  PRIVATE MACRO  GetRelay ( p_RelayName: STRING )
    var ErrCode, FlagValue:bool;

    GetRegistryValue( p_RelayName, V_BOOL, FlagValue, ErrCode );
    if ( ErrCode != 0 )
       FlagValue = false;
    end;

    return FlagValue;
  onError(erru)  
    return false;
  END;

  //Отчет-сверка проводок выгруженных в ЦФТ из СОФР !!!!!!!!!В параметрах будет вместо фильтра ReqId соответственно нужно будет поменять SQL-запрос и его параметры
  macro EntCompareRep( ReqId :string, ParamProcess: object, Fl_SetDialog :integer, errortext :@String, p_RepMode :integer ) :bool

  var DataSet :RsdRecordset,
      i :integer = 0,
      outl = "",
      Fulloutputl = "",
      FileNameOut = "",
      StrBuf :string = "",
      ColumnType,
      state :integer = 0,
      ErrCode,
      Params :TArray,
      Dt,
      Mn,
      Year,
      Query :string,
      RefValue :string = "",
      RepMode: integer = p_RepMode, 
      FlOpenTxtFile = false,
      ExportPath = "",
      v_email_processor;

   if( ( ValType(Fl_SetDialog) == V_UNDEF ) or ( ValType(Fl_SetDialog) == 26 ) )
    Fl_SetDialog = 0;
   end;

   if( Fl_SetDialog == 1 )
    InitProgress(-1, "Обработка данных.", "Обработка данных.");
   end;

   if( RepMode == RM_BASIC )
     state = GetDataSet( @DataSet, 0, ReqId, ParamProcess ); //получим курсор расхождений проводок
   elif ( RepMode == RM_24 )
     state = GetDataSet_24( @DataSet, 0, ReqId, ParamProcess ); // данные расхождений для "отчета-сверки 24"
   else
     state = GetDataSet_test( @DataSet, 0, ReqId, ParamProcess ); // тестовый вызов
   end;

   if( Fl_SetDialog == 1 )
    RemProgress;
    InitProgress(-1, "Формирование отчета.", "Формирование отчета");
   end;

   //шаблон в режиме POI
   var relay4204 = GetRelay( "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\РУБИЛЬНИК.BOSS-4204" );
   var tmplName:string = "Report_UEntCompare.xlsx";
   if( relay4204 == true )
     tmplName = "Report_UEntCompare4204.xlsx";
   end;
   var repTmpl = CTemplateSXLSX(tmplName);
   var fileSavePathExcel = PathCombine(GetAbsoluteTxtPath(),EXPORT_XML_FILENAME_TXT+CNum+".xlsx");

   repTmpl.SetValue_NameCell("req_text", "В ответ на запрос СОФР: " + ReqId);
   repTmpl.SetValue_NameCell("period_text", 
                             "Период: с " + StrSubst( string(date(ParamProcess.DateIn):10), " ", "0" ) + " по " +
                                           StrSubst( string(date(ParamProcess.DateOut):10), " ", "0" )
                            );
   StrBuf = "Табельный номер сотрудника: Все; Счет: Все";
   if( (ValType(uTryToGetPropS( ParamProcess, "AccEntries" )) != V_UNDEF) and (ValType(ParamProcess.AccEntries) != V_UNDEF)  and (ValType(ParamProcess.AccEntries) != 26) and
       (ParamProcess.AccEntries.Size > 0) )
     i = -1;
     StrBuf = "";
     while( (i=i+1) < ParamProcess.AccEntries.Size )
       StrBuf = StrBuf + "Табельный номер сотрудника: " + ParamProcess.AccEntries[i].PersN + " Счет: Д" + ParamProcess.AccEntries[i].PayerAccount + " К" +  ParamProcess.AccEntries[i].ReceiverAccount + ";\n";
     end;
   end;
   repTmpl.SetValue_NameCell("empl_text", StrBuf);
   var tableObj = repTmpl.RegisterTable("bodyline");

   var tableRowCount = 0;

   while(DataSet.MoveNext())
     tableObj.SetValueCell("bodyline_f1",SQL_ConvTypeStr     (DataSet.value("T_IDBISCOTTO")));
     tableObj.SetValueCell("bodyline_f2",SQL_ConvTypeInteger (DataSet.value("T_ACCTRNID")));
     tableObj.SetValueCell("bodyline_f3",SQL_ConvTypeStr     (DataSet.value("T_DOCNUM")));
     tableObj.SetValueCell("bodyline_f4",SQL_ConvTypeStr     (DataSet.value("T_ACCT_DB")));
     tableObj.SetValueCell("bodyline_f5",SQL_ConvTypeStr     (DataSet.value("T_ACCT_CR")));
     tableObj.SetValueCell("bodyline_f6",SQL_ConvTypeStr     (DataSet.value("T_CURRENCY")));
     tableObj.SetValueCell("bodyline_f7",SQL_ConvTypeSum     (DataSet.value("T_AMTCUR")));
     tableObj.SetValueCell("bodyline_f8",SQL_ConvTypeSum     (DataSet.value("T_AMTRUB")));
     tableObj.SetValueCell("bodyline_f9",SQL_ConvTypeDate    (DataSet.value("T_OPDATE")));
     tableObj.SetValueCell("bodyline_f10",SQL_ConvTypeStr     (DataSet.value("T_ERR_TEXT")));
     tableObj.SetValueCell("bodyline_f11",SQL_ConvTypeStr     (DataSet.value("T_DETAILS")));
     tableObj.SetValueCell("bodyline_f12",SQL_ConvTypeInteger (DataSet.value("T_OPER")));
     tableObj.SetValueCell("bodyline_f13",SQL_ConvTypeStr     (DataSet.value("T_MODULE")));
     if( relay4204 == true )
       tableObj.SetValueCell("bodyline_f7cft",SQL_ConvTypeSum     (DataSet.value("T_CFTCUR")));
       tableObj.SetValueCell("bodyline_f8cft",SQL_ConvTypeSum     (DataSet.value("T_CFTRUB")));
     end;
     tableObj.AddStr();
     FlOpenTxtFile = true;
     tableRowCount = tableRowCount + 1;
     if( Fl_SetDialog == 1 )
       UseProgress(tableRowCount);
     end;
   end;
   tableObj.EndTable();
   repTmpl.SetValue_NameCell("count_text", string(tableRowCount));

   if (not repTmpl.GetWorkbook().saveAs(fileSavePathExcel))
     RunError("Не удалось создать xlsx файл");
   end;

   if( Fl_SetDialog == 1 )
    RemProgress();
   end;

   //флаг выгрузки взведен
   if( FlOpenTxtFile )

     // DEF-71583 Возвращает имя файла в виде: Каталог(по параметру) дата + count(utableprocessevent_dbt) для ObjType 
     ExportPath = GetExportPath( "РСХБ\\ИНТЕГРАЦИЯ\\ДИРЕКТОРИИ\\EXPORT\\ENTRYCOMPAREDIR", ParamProcess.DateOut, 5009 );

     //копирование в ресурс из реестра
     RemoveFile(ExportPath);

     if( not CopyFile( fileSavePathExcel, ExportPath ) )
       RunError("Ошибка копирования файла  " + ExportPath);
     end;

     //отправляем в почту
     v_email_processor = Null;
     v_email_processor = c_email_proc_env();
     v_email_processor.m_set_msg_head("СОФР - Отчет результат сверки проводок загруженных в ЦФТ из СОФР.");
     v_email_processor.m_add_row_to_msg_text("Результат сверки проводок загруженных в ЦФТ из СОФР в файле " + ExportPath + ". Приложен.");
     v_email_processor.m_add_attach_to_list( ExportPath );
     v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_ETCOMPARE, true);
     v_email_processor.m_submit_email_synch();
     v_email_processor = Null;
     //отправляем в почту
   end;
   // флаг выгрузки взведен

   // открываем пользователю локальную книгу
   if( ( Fl_SetDialog == 1 ) and (LocalExcelApplication == null) )
     var termFilePath = PathCombine2(GetCurDir(true),"txtfile",EXPORT_XML_FILENAME_TXT+CNum+"ent"+".xlsx");
     var FileName, FilePath, FileExt;
     FilePath = SplitFile(termFilePath, FileName, FileExt);
     if( not CopyFile( fileSavePathExcel, "$" + termFilePath) )
       RunError("Ошибка копирования файла  " + fileSavePathExcel);
     end;
     SC_ShowFile("$"+FilePath,FileName+FileExt);
   end;

   return true;

  onError(err)
    errortext = GetFullErrorMessage(err, 1000);
    if (Fl_SetDialog == 1)
      MsgBox(errortext);
    end;
    AddDBLogWithErrorObj("EntCompareRep",err);
    return false;
  end; // EntCompareRep
end; // c_EntCompare



//Отчет-сверка проводок выгруженных в ЦФТ из СОФР
