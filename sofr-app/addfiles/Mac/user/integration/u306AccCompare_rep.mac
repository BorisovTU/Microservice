//Шишкин Е.В, 10.10.2020 "Отчет-сверка зачислений выгруженных из Бисквит в СОФР".

import globals, ActiveX, oralib, likepy, rsexts;
import "global_utils_intgr.mac", "u_common_email_utils.mac";
import "ucompare_func.mac";    // DEF-66506, DEF-71583
import "dlutils.mac";


private const EXPORT_XML_FILENAME_TXT = "for_Acc306compare",
              CV_EMAIL_GRP_ETCOMPARE = 30; //группа сверки зачислений загруженных из БИСКВИТ в СОФР 
//shev добавить группу



private const Excel_RUS = 1049, //значение локализации для русского Excel
              HEADER_FILENAME_TXT = "header_entcompare",
              BODY_FILENAME_TXT = "body_entcompare",
              FOOTER_FILENAME_TXT = "footer_entcompare"; 

private const xlPasteFormats = -4122,
              xlContinuous = 1,
              xlMedium = -4138,
              xlThin = 2,
              xlNone = -4142,
              xlEdgeLeft = 7,
              xlEdgeTop = 8,
              xlEdgeBottom = 9,
              xlEdgeRight = 10,
              xlDiagonalDown = 5,
              xlDiagonalUp = 6,
              xlInsertDeleteCells = 1,
              xlDelimited = 1,
              xlTextQualifierNone = -4142,
              xlRight  = -4152,
              xlLeft   = -4131,
              xlCenter = -4108,
              xlThemeColorLight1 = 2,
              xlThemeColorDark1 = 1,
              xlThemeColorDark2 = 3,
              xlLandscape = 2,

              SymbSeparator = "|";


private var LocalPathExcel = "",
            XLSExport_Path :string = "",
            CellNumX :integer,
            CellNumY :integer,
            CellNumDeltaY :integer = 0,
            CntAccountRow :integer = 0,
            CellYSectionBodySeparate :TArray = TArray(),
            SizeOfHeader :integer = 9, //3,
            SizeOfDeltaHeader :integer = 7,
            SizeOfFooter :integer = 5, //7,
            Max_X :integer = 13, //количество колонок
            PartyCnt :integer = 0,
            RowCnt :integer = 0,
            CNum = string(UserNumber),
            ExcelLanguage = 0,
            ExcelDecimalSeparator = "",
            FlOpenTxtFile :bool = false,
            System = "";




//преобразование bool в integer
private macro Bool_Int( Btype :bool) :integer

 if( (Valtype(Btype) != V_UNDEF) and (Btype) )
  return 1;
 else
  return 0;
 end;

end;
//преобразование bool в integer

 private macro GetSystemDate()

   var rs = RSDRecordset("select sysdate from dual"); 
   if (rs.movenext)
     return rs.value(0);
   end;

 end;

 private macro NewExcelWorkbook_ ( Visible, ExcelFileName :string )

  if(ExcelApplication == null)
     if (isStandAlone())
        ExcelApplication = ActiveX("Excel.Application", null, true);
     else
        if (startAX == null)
           startAX = CreateObject("rsax", "TRsAxServer", "LoansAxServer", isStandalone());
        end;
        ExcelApplication = startAX.CreateComObject("Excel.Application");
     end;
  end;

  if( (Valtype(ExcelFileName) == V_UNDEF) or (Valtype(ExcelFileName) == 26) )
   ExcelApplication.Workbooks.Add(1);
  else
   ExcelApplication.Workbooks.Add( ExcelFileName );
  end;

  if (ValType (Visible) == V_BOOL)
    ExcelApplication.Visible = Visible;
  end;
  ActiveSheet = ExcelApplication.ActiveSheet;
  return true;

 onError (err)
    ExcelError(err, false);
    return true;
//    Exit(1);
 end;


 private macro TranslateExcelFormula(Formula :string, LocalCode :integer) :string // получаем название формулы на языке локализации RUS / US International
 const Excel_RUS = 1049;                                                          // по любому из двух извесных названий
 var RUS_Formula :TArray,
     US_Formula :TArray,
     Index_;

  RUS_Formula = MakeArray("ЕСЛИ","СУММ","ОКРУГЛ");
  US_Formula = MakeArray("IF", "SUM","ROUND");

  Index_ = find( RUS_Formula, Formula );
  if( Index_ < 0 )
   Index_ = find( US_Formula, Formula );
   if( Index_ < 0 )
    return Formula;
   end
  end;
  if ( LocalCode == Excel_RUS)
   return RUS_Formula[Index_];
  else
   return US_Formula[Index_];
  end
 end;


 private macro GetFormatedField(FieldValue :variant, FirstSeparator :string, LastSeparator :string) :string //форматировать значение поля и цеплять разделители
 var SepPos :integer = 0,
     SymSep :string = ",.";

  if( (ValType(FieldValue) ==  V_UNDEF) or (ValType(FieldValue) ==  V_STRING) and (FieldValue == "") or (ValType(FieldValue) ==  26) or
   (ValType(FieldValue) ==  V_DATE) and ( (string(FieldValue) == " 1.01.0001") or (FieldValue == date("00.00.0000")) ) )
   return FirstSeparator + "" + LastSeparator;
  else
   if( (ValType(FieldValue) ==  V_DATE) or (ValType(FieldValue) ==  V_DTTM) )
    FieldValue = StrSubst( string(date(FieldValue):10), " ", "0" );
   elif( ((ValType(FieldValue) ==  V_MONEY) or (ValType(FieldValue) ==  V_DOUBLE)) and (Index(FieldValue, ExcelDecimalSeparator) == 0) )
    FieldValue = string(FieldValue);
    if( ExcelDecimalSeparator == ",")
     SepPos = Index(FieldValue,".");
    else
     SepPos = Index(FieldValue,",");
    end;
    if( SepPos > 0)
     FieldValue = SubStr( FieldValue, 1, SepPos - 1 ) + ExcelDecimalSeparator + SubStr( FieldValue, SepPos+1 );
    end;
   end;
    return FirstSeparator + string(FieldValue) + LastSeparator;
  end;
 end;



//получим курсор
private macro GetDataSet( DataSet :@RsdRecordset, QueryType :integer, ReqId :string, ParamProcess :object ) :integer
var Query :string = "",
    Params :TArray,
    FlAcc :integer = 0,
    SQLStrFromArray :string = "",
    error;

 if(GetSystemDate() < date("07.01.2021"))
    system = "Бисквит";
 else
    system = "ЦФТ";
 end;

 if( QueryType == 0 )

  DataSet = Null;


  Query =   
"\n"+      "  SELECT C.T_AUTOKEY,                                                                                                                                                              " +
"\n"+      "         C.T_COUNTER,                                                                                                                                                              " +
"\n"+      "         C.T_USERID,                                                                                                                                                               " +
"\n"+      "         SVOD.T_DATE AS SofrDate,                                                                                                                                                  " +     
"\n"+      "         TRUNC(SVOD.T_TIME)  AS SofrTime,                                                                                                                                          " +      
"\n"+      "         C.T_OPDATE as BisDate,                                                                                                                                                    " +
"\n"+      "         C.T_DOCDATE,                                                                                                                                                              " +
"\n"+      "         (select t_name from dparty_dbt where t_partyid = (SELECT T_CLIENT FROM dnptxop_dbt WHERE T_ID= SVOD.T_ENROLLID)) as client,                                               " +                     
"\n"+      "         (select t_number from dsfcontr_dbt sfcontr where t_id = (SELECT t_contract FROM dnptxop_dbt WHERE T_ID= SVOD.T_ENROLLID)) as contract ,                                   " +                     
"\n"+      "         svod.t_debetaccount AS T_ACCT_DB,                                                                                                                                         " +
"\n"+      "         SVOD.T_CREDITACCOUNT  AS T_ACCT_CR,                                                                                                                                       " +
"\n"+      "         C.T_CURRENCY,                                                                                                                                                             " +
"\n"+      "         SVOD.T_SUM AS SofrSum,                                                                                                                                                    " +
"\n"+      "         (CASE WHEN C.T_CURRENCY !=810 THEN C.T_AMTCUR ELSE C.T_AMTRUB END) AS BisSum,                                                                                             " +                                   
"\n"+      "         C.T_DOCNUM,                                                                                                                                                               " +
"\n"+      "         C.T_ACCTRNID,                                                                                                                                                             " +
"\n"+      "         C.T_IDBISCOTTO,                                                                                                                                                           " +
"\n"+      "         C.T_REQID,                                                                                                                                                                " +
"\n"+      "         2 AS T_ERR_CODE,                                                                                                                                                          " +
"\n"+      "         'Расходятся параметры зачисления c SOFRID = '||SVOD.T_ENROLLID||': дата '||:System1||' = '||to_char(C.T_OPDATE,'dd.mm.yyyy')||',                                          " +
"\n"+      "                     дата СОФР = '||to_char(SVOD.T_DATE,'dd.mm.yyyy')||', сумма ' ||:System2||' = '||(CASE WHEN C.T_CURRENCY !=810 THEN C.T_AMTCUR ELSE C.T_AMTRUB END)||',        " +
"\n"+      "                     сумма СОФР = '||SVOD.T_SUM     AS T_ERR_TEXT                                                                                                                  " +
"\n"+      "    FROM uload306Accforcompare_dbt C                                                                                                                                               " +
"\n"+      "        left join upmbiscotto_dbt bis on  C.T_IDBISCOTTO = bis.t_biscottoid                                                                                                        " +
"\n"+      "       left join usr_acc306enroll_dbt svod on bis.t_pmid = svod.t_enrollid                                                                                                         " +       
"\n"+      "   WHERE C.T_REQID = :Reqid1                                                                                                                                                       " +
"\n"+      "               AND C.T_OPDATE BETWEEN :Dat1 AND :Dat2                                                                                                                              " +
"\n"+      "               AND (svod.T_date != C.T_OPDATE  OR svod.T_SUM != CASE WHEN C.T_CURRENCY = 810 THEN C.T_AMTRUB ELSE C.T_AMTCUR END)                                                  " +
"\n"+      "               AND SVOD.T_ENROLLID = C.T_ACCTRNID                                                                                                                                  " +
"\n"+      "               AND C.T_ACCTRNID > 0                                                                                                                                                " +
"\n"+      "                                                                                                                                                                                   " +
"\n"+      "  UNION ALL                                                                                                                                                                        " +
"\n"+      "                                                                                                                                                                                   " +
"\n"+      "  -- ЗАЧИСЛЕНИЯ, КОТОРЫЕ ЕСТЬ В СОФР, НО ОТСУТСТВУЮТ В БИС                                                                                                                         " +
"\n"+      "                                                                                                                                                                                   " +
"\n"+      "  SELECT -1 AS T_AUTOKEY,                                                                                                                                                          " +
"\n"+      "         CHR (0) AS T_COUNTER,                                                                                                                                                     " +
"\n"+      "         CHR (0) AS T_USERID,                                                                                                                                                      " +
"\n"+      "         SVOD.T_DATE AS SofrDate,                                                                                                                                                  " +
"\n"+      "         SVOD.T_time AS SofrTime,                                                                                                                                                  " +
"\n"+      "         to_date('01.01.0001','dd.mm.yyyy') AS BisDate,                                                                                                                            " +
"\n"+      "         SVOD.T_DATE AS T_DOCDATE,                                                                                                                                                 " +
"\n"+      "         (select t_name from dparty_dbt where t_partyid = (SELECT T_CLIENT FROM dnptxop_dbt WHERE T_ID= SVOD.T_ENROLLID)) as client,                                               " +         
"\n"+      "         (select t_number from dsfcontr_dbt sfcontr where t_id = (SELECT t_contract FROM dnptxop_dbt WHERE T_ID= SVOD.T_ENROLLID)) as contract ,                                   " +         
"\n"+      "         svod.t_debetaccount AS T_ACCT_DB,                                                                                                                                         " +
"\n"+      "         SVOD.T_CREDITACCOUNT  AS T_ACCT_CR,                                                                                                                                       " +
"\n"+      "         SVOD.T_CURRCODE AS T_CURRENCY,                                                                                                                                            " +
"\n"+      "         SVOD.T_SUM AS SofrSum,                                                                                                                                                    " +
"\n"+      "         null AS BisSum,                                                                                                                                                           " +
"\n"+      "         (select t_code from dnptxop_dbt d1 where d1.t_id = SVOD.T_ENROLLID) AS T_DOCNUM,                                                                                          " +                         
"\n"+      "         SVOD.T_ENROLLID AS T_ACCTRNID,                                                                                                                                            " +
"\n"+      "         C.T_IDBISCOTTO,                                                                                                                                                           " +
"\n"+      "         C.T_REQID,                                                                                                                                                                " +
"\n"+      "         2 AS T_ERR_CODE,                                                                                                                                                          " +
"\n"+      "         'Зачисление <'||(select t_code from dnptxop_dbt d1 where d1.t_id = SVOD.t_enrollid)||'>, <'||to_char(SVOD.T_DATE,'dd.mm.yyyy')||'>, <'||SVOD.T_SUM||                      " +
"\n"+      "         '> присутствует в СОФР, но'|| case when (select count(*) from upmbiscotto_dbt where t_pmid = svod.t_enrollid and t_dockind = 4607)<1 then ' отсутствует в '               " +
"\n"+      "         || :System3 else  ' аннулировано в '|| :System4 end                                                                                                                       " +
"\n"+      "            AS T_ERR_TEXT                                                                                                                                                          " +
"\n"+      "    FROM    uload306Accforcompare_dbt C                                                                                                                                            " +
"\n"+      "        left join upmbiscotto_dbt bis on  C.T_IDBISCOTTO = bis.t_biscottoid                                                                                                        " +
"\n"+      "        left join usr_acc306enroll_dbt svod on bis.t_pmid = svod.t_enrollid                                                                                                        " +
"\n"+      "   WHERE SVOD.T_DATE BETWEEN :Dat3 AND :Dat4                                                                                                                                       " +
"\n"+      "         AND c.t_acctrnid IS NULL                                                                                                                                                  " +
"\n"+      "         AND C.T_REQID = :Reqid2                                                                                                                                                   " +
"\n"+      "                                                                                                                                                                                   " +
"\n"+      "  UNION ALL                                                                                                                                                                        " +
"\n"+      "                                                                                                                                                                                   " +
"\n"+      "  --ЗАЧИСЛЕНИЯ, КОТОРЫЕ ЕСТЬ В БИС, НО ОТСУТСТВУЮТ В СОФР                                                                                                                          " +
"\n"+      "                                                                                                                                                                                   " +
"\n"+      "  SELECT C.T_AUTOKEY,                                                                                                                                                              " +
"\n"+      "         C.T_COUNTER,                                                                                                                                                              " +
"\n"+      "         C.T_USERID,                                                                                                                                                               " +
"\n"+      "         to_date('01.01.0001','dd.mm.yyyy') as SofrDate,                                                                                                                           " +
"\n"+      "         null as SofrTime,                                                                                                                                                         " +
"\n"+      "         C.T_OPDATE as BisDate,                                                                                                                                                    " +
"\n"+      "         C.T_DOCDATE,                                                                                                                                                              " +
"\n"+      "         '' as client,                                                                                                                                                             " +
"\n"+      "         '' as contract ,                                                                                                                                                          " +
"\n"+      "         '' as T_ACCT_DB,                                                                                                                                                          " +
"\n"+      "         '' as T_ACCT_CR,                                                                                                                                                          " +
"\n"+      "         C.T_CURRENCY,                                                                                                                                                             " +
"\n"+      "         0 as SofrSum,                                                                                                                                                             " +
"\n"+      "         (CASE WHEN C.T_CURRENCY !=810 THEN C.T_AMTCUR ELSE C.T_AMTRUB END) AS BisSum,                                                                                             " +
"\n"+      "         C.T_DOCNUM,                                                                                                                                                               " +
"\n"+      "         C.T_ACCTRNID,                                                                                                                                                             " +
"\n"+      "         C.T_IDBISCOTTO,                                                                                                                                                           " +
"\n"+      "         C.T_REQID,                                                                                                                                                                " +
"\n"+      "         2 AS T_ERR_CODE,                                                                                                                                                          " +
"\n"+      "       'Зачисление <'||to_char(C.T_OPDATE,'dd.mm.yyyy')||'>, <'||(CASE WHEN C.T_CURRENCY !=810 THEN C.T_AMTCUR ELSE C.T_AMTRUB END)||'> не передавалось из '||:System5||' в СОФР ' " +           
"\n"+      "            AS T_ERR_TEXT                                                                                                                                                          " +
"\n"+      "    FROM uload306Accforcompare_dbt c                                                                                                                                               " +
"\n"+      "   WHERE C.T_OPDATE BETWEEN :Dat5 AND :Dat6                                                                                                                                        " +
"\n"+      "         AND C.T_REQID = :Reqid3                                                                                                                                                   " +
"\n"+      "         AND C.T_ACCTRNID = 0                                                                                                                                                      " ;
                                                                                                      

  Params = makeArray( 
SQLParam( "System1", System ),
SQLParam( "Sytem2", System ),
SQLParam( "Reqid1", ReqId ),
SQLParam( "Dat1", ParamProcess.DateIn ),
SQLParam( "Dat2", ParamProcess.DateOut ),
SQLParam( "System3", System ),
SQLParam( "System4", System ),
SQLParam( "Dat3", ParamProcess.DateIn ),
SQLParam( "Dat4", ParamProcess.DateOut ),
SQLParam( "Reqid2", ReqId ),
SQLParam( "System5", System ),
SQLParam( "Dat5", ParamProcess.DateIn ),
SQLParam( "Dat6", ParamProcess.DateOut ),
SQLParam( "Reqid3", ReqId )
  ); 


  DataSet = execSQLselect( Query, Params );

 end;

 return 0;


onError(err)

 return 1;
 
end;
//получим курсор

private macro TryToExcelQuit()
  ExcelApplication.Workbooks.Close();
  ExcelApplication.Quit();
  ExcelApplication = null;
OnError(er)
end;

//Отчет-сверка зачислений выгруженных из Бисквит в СОФР 
macro Acc306CompareRep( ReqId :string, ParamProcess: object, Fl_SetDialog :integer ) :bool

var DataSet :RsdRecordset,
    i :integer = 0,
    outl = "",
    Fulloutputl = "",
    FileNameOut = "",
    StrBuf :string = "",
    ColumnType,
    state :integer = 0,
    ErrCode,
    Params :TArray,
    Dt,
    Mn,
    Year,
    Query :string,
    RefValue :string = "",
    v_email_processor;


 if( ( ValType(Fl_SetDialog) == V_UNDEF ) or ( ValType(Fl_SetDialog) == 26 ) )
  Fl_SetDialog = 0;
 end;

 if( Fl_SetDialog == 1 )
  InitProgress(-1, "Обработка данных.", "Обработка данных.");
 end;

//распарсить параметры в объект для SQL-запроса и шапки

 state = GetDataSet( @DataSet, 0, ReqId, ParamProcess ); //получим курсор расхождений зачислений

 if( Fl_SetDialog == 1 )
  RemProgress;                                                    
  InitProgress(-1, "Формирование отчета.", "Формирование отчета");
 end;

 //шаблон в режиме POI
 var repTmpl = CTemplateSXLSX("Report_UAcc306Compare.xlsx");
 var fileSavePathExcel = PathCombine(GetAbsoluteTxtPath(),EXPORT_XML_FILENAME_TXT+CNum+".xlsx");

 repTmpl.SetValue_NameCell("header_text","Отчет о расхождениях в зачислениях выгруженных из "+System+" в СОФР");
 repTmpl.SetValue_NameCell("req_text", "В ответ на запрос СОФР: " + ReqId);
 repTmpl.SetValue_NameCell("period_text", 
                           "Период: с " + StrSubst( string(date(ParamProcess.DateIn):10), " ", "0" ) + " по " + StrSubst( string(date(ParamProcess.DateOut):10), " ", "0" )
                          );
  var tableObj = repTmpl.RegisterTable("bodyline");

 var tableRowCount = 0;

 while(DataSet.MoveNext())
   tableObj.SetValueCell("bodyline_f1",SQL_ConvTypeStr(DataSet.value("T_IDBISCOTTO")));
   tableObj.SetValueCell("bodyline_f2",SQL_ConvTypeInteger(DataSet.value("T_ACCTRNID")));
   tableObj.SetValueCell("bodyline_f3",SQL_ConvTypeStr(DataSet.value("T_DOCNUM")));
   tableObj.SetValueCell("bodyline_f4",SQL_ConvTypeStr(DataSet.value("Contract")));
   tableObj.SetValueCell("bodyline_f5",SQL_ConvTypeStr(DataSet.value("T_ACCT_DB")));
   tableObj.SetValueCell("bodyline_f6",SQL_ConvTypeStr(DataSet.value("T_ACCT_CR")));
   tableObj.SetValueCell("bodyline_f7",SQL_ConvTypeStr(DataSet.value("Client")));
   tableObj.SetValueCell("bodyline_f8",SQL_ConvTypeStr(DataSet.value("T_CURRENCY")));
   tableObj.SetValueCell("bodyline_f9",SQL_ConvTypeSum(DataSet.value("SofrSum")));
   tableObj.SetValueCell("bodyline_f10",SQL_ConvTypeSum(DataSet.value("BisSum")));
   tableObj.SetValueCell("bodyline_f11",SQL_ConvTypeDate(DataSet.value("SofrDate")));
   tableObj.SetValueCell("bodyline_f12",SQL_ConvTypeTime(DataSet.value("SofrTime")));
   tableObj.SetValueCell("bodyline_f13",SQL_ConvTypeStr(DataSet.value("T_ERR_TEXT")));
   tableObj.AddStr();
   FlOpenTxtFile = true;
   tableRowCount = tableRowCount + 1;
   if( Fl_SetDialog == 1 )
     UseProgress(tableRowCount);
   end;
 end;
 tableObj.EndTable();
 repTmpl.SetValue_NameCell("count_text", string(tableRowCount));

 if (not repTmpl.GetWorkbook().saveAs(fileSavePathExcel))
   RunError("Не удалось создать xlsx файл");
 end;

 if( Fl_SetDialog == 1 )
  RemProgress;
 end;

 //флаг выгрузки взведен
 if( FlOpenTxtFile )

   // DEF-71583 Возвращает имя файла в виде: Каталог(по параметру) дата + count(utableprocessevent_dbt) для ObjType 
   var ExportPath = GetExportPath( "РСХБ\\ИНТЕГРАЦИЯ\\ДИРЕКТОРИИ\\EXPORT\\306ACCCOMPAREDIR", ParamProcess.DateOut, 5030 );
   
   //копирование в ресурс из реестра
   RemoveFile(ExportPath);

   if( not CopyFile( fileSavePathExcel, ExportPath ) )
    RunError("Ошибка копирования файла  " + ExportPath);
   end;

   //отправляем в почту
   v_email_processor = Null;
   v_email_processor = c_email_proc_env();
   v_email_processor.m_set_msg_head("СОФР - Отчет результат сверки зачислений загруженных из "+System+" в СОФР.");
   v_email_processor.m_add_row_to_msg_text("Результат сверки зачислений загруженных из "+System+" в СОФР в файле " + ExportPath + ". Приложен.");
   v_email_processor.m_add_attach_to_list( ExportPath );
   v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_ETCOMPARE, true);
   v_email_processor.m_submit_email_synch();
   v_email_processor = Null;
   //отправляем в почту

 end;
 // флаг выгрузки взведен

 // открываем пользователю локальную книгу
 if( ( Fl_SetDialog == 1 ) and (ExcelApplication == null) )
   var termFilePath = PathCombine2(GetCurDir(true),"txtfile",EXPORT_XML_FILENAME_TXT+CNum+"306"+".xlsx");
   if( not CopyFile( fileSavePathExcel, "$" + termFilePath) )
     RunError("Ошибка копирования файла  " + fileSavePathExcel);
   end;
   if(not NewExcelWorkbook_(/*VisibleRunReport*/ false, termFilePath ))
      return false;
   else
      ActiveSheet.Activate();
      ExcelApplication.Visible = true;
      ExcelApplication.DisplayAlerts = true;
      ExcelApplication = null;
   end; 
 end;
 // открываем пользователю локальную книгу

 return true;

onError(err)
 var errortext = GetFullErrorMessage(err, 1000);
 if (Fl_SetDialog == 1)
   MsgBox(errortext);
 end;
 AddDBLogWithErrorObj("Acc306CompareRep",err);
 TryToExcelQuit();
 return false;

end;



