/* BIQ-7597

1)	в выгрузку рсхб-брокер добавить анализ переменной реестра SECUR\БИРЖЕВЫЕ ОПЕРАЦИИ\КЛИРИНГ.ОБЕСП.ДЛЯ КЛИЕНТ.СДЕЛОК. Если настройка существует и включена, то в поле TradeAccount валютной секции (Cets) процедуры usp_ImportTradeAccountMap передавать ТКС со значением "";
2)	на основании имеющейся процедуры выгрузки в рсхб-брокер сделать массовую выгрузку новых значений TradeAccount в процедуре usp_ImportTradeAccountMap для клиентов, у которых есть признак выгрузки в РСХБ-Брокер (= "Успешно") и у которых стоит двухфакторная аутентификация в СОФР.

*/
import usp_import;

   private var DSN, USER, PASSWORD;
   private var CV_ODBS_CONSTRING;

   const REG_TRADEACCOUNT_CUR_DEFAULT_EPO = "РСХБ\\ИНТЕГРАЦИЯ\\РСХБ-БРОКЕР\\MMVB_ЕПО";
   const REG_EPO = "SECUR\\БИРЖЕВЫЕ ОПЕРАЦИИ\\КЛИРИНГ.ОБЕСП.ДЛЯ СОБСТВ.СДЕЛОК";
   var epo;

   GetRegistryValue("РСХБ\\ИНТЕГРАЦИЯ\\INTEGR_SERV_PRM\\RSHBBROKER\\DSN", V_STRING, DSN);
   GetRegistryValue("РСХБ\\ИНТЕГРАЦИЯ\\INTEGR_SERV_PRM\\RSHBBROKER\\USER", V_STRING, USER);
   GetRegistryValue("РСХБ\\ИНТЕГРАЦИЯ\\INTEGR_SERV_PRM\\RSHBBROKER\\PASSWORD", V_STRING, PASSWORD);

   CV_ODBS_CONSTRING = "dsn="+DSN+";user id="+USER+";password="+PASSWORD;

   env = RsdEnvironment("RDDrvO","RDDrvO.dll");
   con = RsdConnection(env,CV_ODBS_CONSTRING);
   


macro RunUsp(_cMap)

   private var v_logger_obj;    /* Объект для работы с журналом */
   private var v_log_id;        /* Идентификатор записи в журнале (если требуется что-то добавить) */
   var sql_str_env, cmd_env;

      sql_str_env = String(" EXEC [dbo].[usp_ImportTradeAccountMap]                  \n"+
                           "   @Account       = "+m_GetSQLString(_cMap.Account)     +", \n"+
                           "   @TradeFloor    = "+m_GetSQLString(_cMap.TradeFloor)  +", \n"+
                           "   @TradeAccount  = "+m_GetSQLString(_cMap.TradeAccount));                              

      v_logger_obj = uws_exchng_logger(null, null, NULL, "usp_ImportTradeAccountMap", modulename(), NULL, sql_str_env);
      v_log_id = v_logger_obj.get_log_id();

      sql_str_env = ToAnsi(sql_str_env,true);
      cmd_env = RsdCommand(con,sql_str_env);
      cmd_env.execute;
      cmd_env.close;

      v_logger_obj.add_response(null, null, null, v_log_id);
      v_logger_obj.add_error_info(0, "OK");

      v_logger_obj = NULL;
      v_log_id = NULL;
onError(er)
   var env_error = "", i = 0;

   while( i < env.ErrorCount)
      env_error = env_error + env.Error(i).Descr + " ";
      i = i+1;
   end;
   env.ClearErrors();
   env_error = ToOEM (env_error, true);
   if (not env_error)
      env_error = er.message;
   end;

   if (ValType(v_logger_obj) == V_UNDEF)
      v_logger_obj = uws_exchng_logger(null, null, NULL, "usp_ImportTradeAccountMap", modulename(), NULL, " ");
      v_log_id = v_logger_obj.get_log_id();
   end;

   v_logger_obj.add_response(env_error, null, null, v_log_id);
   v_logger_obj.add_error_info(-1001, env_error);

   v_logger_obj = NULL;
   v_log_id = NULL;


end;

macro RunCtpt(_cCtpt)
   private var v_logger_obj;    /* Объект для работы с журналом */
   private var v_log_id;        /* Идентификатор записи в журнале (если требуется что-то добавить) */
   var sql_str_env, cmd_env;

         sql_str_env = String(" EXEC [dbo].[usp_ImportCtptFromExcel]                  \n"+
                              "   @Client     = "+m_GetSQLString(_cCtpt.Client)      +", \n"+
                              "   @ClientName = "+m_GetSQLString(_cCtpt.ClientName)  +", \n"+
                              "   @Account    = "+m_GetSQLString(_cCtpt.Account)     +", \n"+
                              "   @IsStrategy = "+_cCtpt.IsStrategy                +", \n"+
                              "   @ClientData = "+m_GetSQLString(_cCtpt.ClientData)  +", \n"+
                              "   @Action     = "+_cCtpt.Action);

         v_logger_obj = uws_exchng_logger(null, null, NULL, "usp_ImportCtptFromExcel", modulename(), NULL, sql_str_env);
         v_log_id = v_logger_obj.get_log_id();

         sql_str_env = ToAnsi(sql_str_env,true);
         cmd_env = RsdCommand(con,sql_str_env);
         cmd_env.execute;
         cmd_env.close;

         v_logger_obj.add_response(null, null, null, v_log_id);
         v_logger_obj.add_error_info(0, "OK");

         v_logger_obj = NULL;
         v_log_id = NULL;
onError(er)
   var env_error = "", i = 0;

   while( i < env.ErrorCount)
      env_error = env_error + env.Error(i).Descr + " ";
      i = i+1;
   end;
   env.ClearErrors();
   env_error = ToOEM (env_error, true);
   if (not env_error)
      env_error = er.message;
   end;

   if (ValType(v_logger_obj) == V_UNDEF)
      v_logger_obj = uws_exchng_logger(null, null, NULL, "usp_ImportCtptFromExcel", modulename(), NULL, " ");
      v_log_id = v_logger_obj.get_log_id();

   end;

   v_logger_obj.add_response(env_error, null, null, v_log_id);
   v_logger_obj.add_error_info(-1001, env_error);

   v_logger_obj = NULL;
   v_log_id = NULL;

end;

class c_usp_ImportCtptFromExcel_mass
   var Client        : string;      // Идентификатор договора во внешней системе  Да
   var ClientName    : string;      // Наименование договора  Да
   var Account       : string;      // Счет, как правило используется код клиента на бирже  Да
   var AccountName   : string;      // Наименование счета. Не заполняем  Нет
   var Branch        : string;      // Филиал, в котором открыт счет. Не заполняем  Нет
   var BranchName    : string;      // Название филиала для отображения в отчетах. Не заполняем  Нет
   var IsStrategy    : integer;     // Да	Признак того является ли данный счет стратегией. 0 - Клиентский счет 1 - Стратегия. Константа = 0  Да ?
   var ClientData    : string;      // Дополнительные параметры клиента, которые могу использоваться в программе  Да
   var Action        : integer;     // Действие со счетом. 0 - удаляем счет, 1 - добавляем счет, 2 - делаем счет неактивным для торгов. Константа = 1  Да
end;

   var Cur_Default_epo;

   var cMap;
  
   var sql_str, rs, cmd;
   var acc;
   var notes;
   var ErrCode;
   var num_rows=0, cnt=0;

   var old, doCtpt, cCtpt;
   var IIS, phone,email;
   
   GetRegistryValue(REG_EPO, V_INTEGER, epo, ErrCode);
   if( ( ErrCode > 0 ) or (not epo) )
      msgbox("Настройка "+REG_EPO+" не найдена или отключена, выгрузка не производится");
      return;
   else 
      // задано
      GetRegistryValue(REG_TRADEACCOUNT_CUR_DEFAULT_EPO, V_STRING, Cur_Default_epo, ErrCode);
      if( ( ErrCode > 0 ) or (not Cur_Default_epo) )
         RunError("Не задано значение по умолчанию "+REG_TRADEACCOUNT_CUR_DEFAULT_EPO);
      end;
   end;

   doCtpt = false;
   GetTrue(doCtpt,"Выгружать дополнительно usp_ImportCtptFromExcel (создание валютной площадки)?");
   
   // по всем открытым площадкам по валютной бирже
   // двухфакторная аутентификация договора БО
   // была успешная выгрузка в РСХБ-Брокер
   sql_str = "SELECT dl.t_dlcontrid dl_id, cntr.t_number, cntr.t_name, dl.t_iis, cntr.t_partyid , "+
             "       cntr_mp.t_id cntr_id,  cntr_mp.t_servkind, cntr_mp.t_servkindsub, mp.t_id mp_id, mp.t_mpcode "+
             "  FROM dsfcontr_dbt cntr, "+
             "       ddlcontr_dbt dl, "+
             "       ddlcontrmp_dbt mp, "+
             "       dsfcontr_dbt cntr_mp "+
             "WHERE dl.t_sfcontrid = cntr.t_id "+
             "  AND dl.t_dlcontrid = mp.t_dlcontrid "+
             "  AND cntr_mp.t_id = mp.t_sfcontrid "+
             "  AND cntr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') "+
             "  AND cntr_mp.t_servkind = 21 "+
             "  AND mp.t_mpclosedate = to_date('01.01.0001','dd.mm.yyyy') "+
             "  AND exists (select 1 from dobjatcor_dbt o where o.t_objecttype = 207 and o.t_groupid = 170 "+
             "                 and o.t_attrid = 2 and (o.t_validtodate >= :dt or o.t_validtodate = to_date('01.01.0001','dd.mm.yyyy')) "+
             "                 and lpad(dl.t_dlcontrid,34,'0') = o.t_object ) "+
             "   and exists (select 1 from dobjatcor_dbt o where o.t_objecttype = 3 and o.t_groupid = 170 "+
             "                  and o.t_attrid = 1 and (o.t_validtodate >= :dt or o.t_validtodate = to_date('01.01.0001','dd.mm.yyyy')) "+
             "                  and lpad(cntr.t_partyid,10,'0') = o.t_object) ";
   var sql_str2 = "select count(*) from ("+sql_str+")";
   cmd = RSDCommand(sql_str2);
   cmd.AddParam("dt1", RSDBP_IN, date());
   cmd.AddParam("dt2", RSDBP_IN, date());
   rs = RSDRecordSet(cmd );
   if (rs.movenext )
      num_rows = Int(rs.value(0));
   end;
   rs.close; cmd.close; rs = null; cmd = null;

   cmd = RSDCommand(sql_str);
   cmd.AddParam("dt1", RSDBP_IN, date());
   cmd.AddParam("dt2", RSDBP_IN, date());
   rs = RSDRecordSet(cmd );

   InitProgress(num_rows);


   while (rs.movenext)
      if (doCtpt)
         cCtpt = c_usp_ImportCtptFromExcel_mass;

         if (rs.value("t_iis") == "X")
            IIS = 1;
         else
            IIS = 0;
         end;

         cCtpt.Client        = rs.value("t_number");
         cCtpt.ClientName    = rs.value("t_number");
         cCtpt.Account       = rs.value("t_mpcode");
         cCtpt.AccountName   = NULL;
         cCtpt.Branch        = NULL;
         cCtpt.BranchName    = NULL;
         cCtpt.IsStrategy    = 0;

         phone = getContact(rs.value("t_partyid"), CV_CONTACT_KIND_PHONE, CV_CONTACT_TYPE_MOBILE);
         email = getContact(rs.value("t_partyid"), CV_CONTACT_KIND_EMAIL, CV_CONTACT_TYPE_REPORT);

         cCtpt.ClientData    = "<Fields AgreementNo=\""+rs.value("t_number")+"\" Phone=\""+Phone+"\" Email=\""+Email
                                   +"\" MasterId=\""+rs.value("t_partyid")+"\" IIS=\""+IIS+"\" />";
         cCtpt.Action        = 1;
old = SetDialogFlag(0);
         RunCtpt(cCtpt);
SetDialogFlag(old);
      end;

      acc = c_usp_ImportTradeAccountMap_mp;
      acc.account = rs.value("t_mpcode");
      acc.TradeAccount = "";
      acc.ClientCode = rs.value("t_mpcode");
      acc.TradeFloor = "Cets";
      acc.AccType = "cur";
      notes = readNoteForObject( 659, String(rs.value("cntr_id"):o:10), 6);
      if (notes)
         acc.TradeAccount = notes;
      else
         acc.TradeAccount = Cur_Default_epo;
      end;
      acc.Firm =  "MB0134700000";

      cMap = c_usp_ImportTradeAccountMap(acc);
old = SetDialogFlag(0);
      RunUsp(cMap);
SetDialogFlag(old);

      cMap = NULL;
      cnt = cnt+1;
      UseProgress(cnt);
   end;
   RemProgress();


end;