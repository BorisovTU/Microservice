//А.Киселев 14.09.2018 Процедура обновления платежа RSBPayment. Операция по платежу никогда не начнется и ни когда не закончится, только для хранения.
//UpdateStatusPayDoc
//!!!!!!!!!!!!Все восклицательные знаки должны быть обработанны в соответствии с текстом комментария и удалены

import PaymInter;

private const UNIVERSAL_ERROR_CODE:integer  = -3001;



//параметры запроса из RS-Securities СОФР
private class TUpdateStatusPayDocReq( UpdateStatusPayDocReq :object)
 var ReqID :string = "", // обязательное: Нет
     SenderId :string = "",
     ReferenceId :string = "", // обязательное: Нет //эквивалент T_PAYMENTID
     EntryID :string = "", // обязательное: Нет
     EntryNumber :string = "",
     StatusCode :string = "";

 private macro ThrowException( Message :string, ErrorCode :integer)

  if(ErrorCode == null)
   RunError( Message, UNIVERSAL_ERROR_CODE );
  end;

  RunError( Message, ErrorCode );
 end;


 //заполнение входящего параметра-объекта
 private macro InitPropertyReq( UpdateStatusPayDocReq :object )
 private var ErrMsg :string = "";


   ErrMsg = "";

   if( (ValType(UpdateStatusPayDocReq.ReqID) != V_UNDEF) and (ValType(UpdateStatusPayDocReq.ReqID) != 26) and (UpdateStatusPayDocReq.ReqID != "") )
    ReqID = UpdateStatusPayDocReq.ReqID;
   end;

   if( (ValType(UpdateStatusPayDocReq.SenderId) == V_UNDEF) or (ValType(UpdateStatusPayDocReq.SenderId) == 26) or (UpdateStatusPayDocReq.SenderId == "") )
    ThrowException( ErrMsg + "не получен обязательный параметр \"SenderId\"" );
   else
    SenderId = UpdateStatusPayDocReq.SenderId;
   end;

   if( (ValType(UpdateStatusPayDocReq.ReferenceId) == V_UNDEF) or (ValType(UpdateStatusPayDocReq.ReferenceId) == 26) or (UpdateStatusPayDocReq.ReferenceId == "") )
    ThrowException( ErrMsg + "не получен обязательный параметр \"ReferenceId\"" );
   else
    ReferenceId = UpdateStatusPayDocReq.ReferenceId;
   end;

   if( (ValType(UpdateStatusPayDocReq.EntryID) != V_UNDEF) and (ValType(UpdateStatusPayDocReq.EntryID) != 26) and (UpdateStatusPayDocReq.EntryID != "") )
    EntryID = UpdateStatusPayDocReq.EntryID;
   end;

   if( (ValType(UpdateStatusPayDocReq.EntryNumber) == V_UNDEF) or (ValType(UpdateStatusPayDocReq.EntryNumber) == 26) or (UpdateStatusPayDocReq.EntryNumber == "") )
    ThrowException( ErrMsg + "не получен обязательный параметр \"EntryNumber\"" );
   else
    EntryNumber = UpdateStatusPayDocReq.EntryNumber;
   end;

   if( (ValType(UpdateStatusPayDocReq.StatusCode) == V_UNDEF) or (ValType(UpdateStatusPayDocReq.StatusCode) == 26) or (UpdateStatusPayDocReq.StatusCode == "") )
    ThrowException( ErrMsg + "не получен обязательный параметр \"StatusCode\"" );
   else
    StatusCode = UpdateStatusPayDocReq.StatusCode;
   end;

 end;

 if(UpdateStatusPayDocReq != Null)
  InitPropertyReq( UpdateStatusPayDocReq ) //конструктор
 end;

end;




private class TErrorData
 var ErrorCode :string, // обязательное: Нет
     ErrorDesc :string; // обязательное: Нет
end;

private class TPaymentParams
 var ReferenceId :string, // обязательное: Нет
     EntryID :string,
     EntryNumber :string = "",
     StatusCode :string = "";
end;



//параметры ответа из RS-Securities СОФР
private class TUpdateStatusPayDocResp( )
 var ErrorData :TErrorData,
     PaymentParams :TPaymentParams;
end;



//Процедура обновления платежа RSBPayment
macro UpdateStatusPayDoc( RequestObj_ :object ) :object //входные данные объект класса TUpdateStatusPayDocReq
var RequestObj :TUpdateStatusPayDocReq = TUpdateStatusPayDocReq( RequestObj_ ),
    ResponseObj :TUpdateStatusPayDocResp = TUpdateStatusPayDocResp( ),
    Payment :RsbPayment = RsbPayment( int(RequestObj.ReferenceId) );  ;
  

  if( Payment.PaymStatus != int(RequestObj.StatusCode) )

   Payment.PaymStatus = int(RequestObj.StatusCode); //меняем статус

   if(Payment.Update == 0)
    // результат набиваем объект Response
    ResponseObj.PaymentParams.ReferenceId = string(Payment.PaymentId);
    ResponseObj.PaymentParams.EntryID = RequestObj.EntryID;
    ResponseObj.PaymentParams.EntryNumber = RequestObj.EntryNumber;
    ResponseObj.PaymentParams.StatusCode = string(Payment.PaymStatus);
   else
    // результат набиваем объект Response
    ResponseObj.PaymentParams.ReferenceId = string(Payment.PaymentId);
    ResponseObj.PaymentParams.EntryID = RequestObj.EntryID;
    ResponseObj.PaymentParams.EntryNumber = RequestObj.EntryNumber;
    ResponseObj.PaymentParams.StatusCode = string(Payment.PaymStatus);
    ResponseObj.ErrorData.ErrorCode = ""; //!!!!!!!!!!!что если транзакция не выполнена
    ResponseObj.ErrorData.ErrorDesc = ""; //!!!!!!!!!!!что если транзакция не выполнена
   end;
  end;
 RequestObj = Null;
 Payment = Null;
 return ResponseObj;

onError(err)

/*!!!!!!!!!!!!!!!обработка ошибок тоже не ясно
   out_code = c_err_obj.obtain_err_code(err);
   err_txt = c_err_obj.obtain_err_msg(err);

   resp_data_obj = c_outObj;
   resp_data_obj.ActiveContract_resp.ReqID = XmlRpcRequestId; 
   resp_data_obj.ActiveContract_resp.SenderId = req_data_obj.SenderID;
   resp_data_obj.ActiveContract_resp.Result.code = out_code;
   resp_data_obj.ActiveContract_resp.Result.text = err_txt;

   out_str = req_msg_obj.sec_internal_resp(resp_data_obj);
   return out_str;
*/

 ResponseObj.PaymentParams.ReferenceId = RequestObj.ReferenceId;
 ResponseObj.PaymentParams.EntryID = RequestObj.EntryID;
 ResponseObj.PaymentParams.EntryNumber = RequestObj.EntryNumber;
 ResponseObj.PaymentParams.StatusCode = RequestObj.StatusCode;
 ResponseObj.ErrorData.ErrorCode = ""; //!!!!!!!!!!!что если транзакция не выполнена
 ResponseObj.ErrorData.ErrorDesc = ""; //!!!!!!!!!!!что если транзакция не выполнена

 RequestObj = Null;
 Payment = Null;
 return ResponseObj;

end;
//Процедура обновления платежа RSBPayment


//!!!!!!!!!!!!!!!!это только для тестирования
var RequestObj :TUpdateStatusPayDocReq;

RequestObj.ReqID = "KJGKOGLK764784";
RequestObj.ReferenceId = "2495";
RequestObj.EntryNumber = "79865969";
RequestObj.StatusCode = "458";

UpdateStatusPayDoc( RequestObj );
//!!!!!!!!!!!!!!!!это только для тестирования

