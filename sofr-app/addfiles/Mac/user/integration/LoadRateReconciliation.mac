/*------------------------------------------*/
/* Сервис Реконсиляция данных по котировкам */
/* 2020-01-11                               */
/* Автор: Синицын А.                        */
/*					    */
/*------------------------------------------*/
import "global_utils_intgr.mac"; 
import "com_fin_instr_rates.mac";
import "secur_prc_msg_transform.mac"; /* Функционал преобразования сообщений */
import "u_common_email_utils.mac";

private const CV_Rate_DEFAULT_CODE = 0;
private const CV_Rate_ERROR_CODE = -1;
private const CV_EMAIL_HEAD = "Ошибка. Реконсиляция данных по котировкам";
private const CV_EMAIL_ROW_HEAD = "LoadRateReconciliation: ";
private const CV_EMAIL_RECEIVER = "";



/*-------------------*/
/* Описание объектов */
/*-------------------*/

/* Данные запроса сервиса Загрузки данных по котировкам */
private class c_LoadRateReconciliation_req
   var ReqID          : string  /* (  1) ИД запроса */
      ,SenderId       : string  /* (0-1) Код АС-источника сведений */
      ,RepDate	      : date    /* Глубина архивных дат котировок, начиная от текущей sysdate*/
end;

/*
    <xsd:complexType name="dt_LoadRateReconciliation_resp">
        <xsd:all>
            <xsd:element name="ReqID" type="cnbe_string"/>
            <xsd:element name="SenderId" type="xsd:string" minOccurs="0"/>
            <xsd:element name="Result" type="dt_Result_LoadRateReconciliation_resp"/>
            <xsd:element name="RateList" type="dt_RateList_LoadRateReconciliation_resp" minOccurs="0"/>
        </xsd:all>
    </xsd:complexType>

    <xsd:complexType name="dt_Result_LoadRateReconciliation_resp">
        <xsd:all>
            <xsd:element name="Code" type="xsd:integer"/>
            <xsd:element name="Text" type="xsd:string" minOccurs="0"/>
        </xsd:all>
    </xsd:complexType>

    <xsd:complexType name="dt_RateList_LoadRateReconciliation_resp">
        <xsd:sequence>
            <xsd:element name="RateParm" maxOccurs="unbounded">
                <xsd:complexType>
                    <xsd:all>
                        <xsd:element name="PFI_TYPE" type="xsd:string" minOccurs="0"/>
                        <xsd:element name="T_FI_CODE" type="xsd:string" minOccurs="0"/>
                        <xsd:element name="FACEFITYPE" type="xsd:string" minOccurs="0"/>
                        <xsd:element name="FACEFINAME" type="xsd:string" minOccurs="0"/>
                        <xsd:element name="FACEFICODE" type="xsd:string" minOccurs="0"/>
                        <xsd:element name="SHORTNAME" type="xsd:string" minOccurs="0"/>
                        <xsd:element name="MATURDATE" type="xsd:string" minOccurs="0"/>
                        <xsd:element name="RATE_DATE_MIN" type="mbe_date" />
                        <xsd:element name="RATE_FIID_MIN" type="xsd:string" minOccurs="0"/>
                        <xsd:element name="RATE_MIN" type="xsd:string" minOccurs="0"/>
                        <xsd:element name="RATE_DATE_MAX" type="mbe_date" />
                        <xsd:element name="RATE_FIID_MAX" type="xsd:string" minOccurs="0"/>
                        <xsd:element name="RATE_MAX" type="xsd:string" minOccurs="0"/>
                        <xsd:element name="RATE_DATE_CALC" type="mbe_date" />
                        <xsd:element name="RATE_FIID_CALC" type="xsd:string" minOccurs="0"/>
                        <xsd:element name="RATE_CALC" type="xsd:string" minOccurs="0"/>
                        <xsd:element name="RATE_DATE_CB" type="mbe_date" />
                        <xsd:element name="RATE_FIID_CB" type="xsd:string" minOccurs="0"/>
                        <xsd:element name="RATE_CB" type="xsd:string" minOccurs="0"/>
                    </xsd:all>
                </xsd:complexType>
            </xsd:element>
        </xsd:sequence>
    </xsd:complexType>
*/

private class c_Result_Rate
   var Code : integer /* (  1) Код */
      ,Text : string; /* (0-1) Описание */
end;

private class c_RateParm_resp
   var PFI_TYPE      : string; /* (  1) Наименование ставки */         
   var T_FI_CODE     : string; /* (0-1) Короткое наименование ставки */
   var FACEFITYPE    : string; /* (0-1) Дата ставки */                 
   var FACEFINAME    : string; /* (  1) Курс ставки */                 
   var FACEFICODE    : string; /* (0-1) Срок ставки */                 
   var SHORTNAME     : string;
   var MATURDATE     : string;
   var RATE_DATE_MIN : Date;
   var RATE_FIID_MIN : string;
   var RATE_MIN      : string;
   var RATE_DATE_MAX : Date;
   var RATE_FIID_MAX : string;
   var RATE_MAX	     : string;
   var RATE_DATE_CALC: Date;
   var RATE_FIID_CALC: string;
   var RATE_CALC     : string;
   var RATE_DATE_CB  : Date;
   var RATE_FIID_CB  : string;
   var RATE_CB       : string;
end;

/* Данные ответа сервиса Загрузки данных по купонам */
private class c_LoadRateReconciliation_resp
   var ReqID    : string  /* (  1) ИД исходного запроса */
      ,SenderId : string  /* (0-1) Код АС-получателя ответа */
      ,Result   : object  /* (  1) Результат обработки запроса c_Result_Rate */
      ,RateList : object; /* (0-n) Результат выполнения запроса в СОФР по котировкам TArray c_RateParm_resp */
end;

/* Ответ сервиса */
private class c_out_obj
   var LoadRateReconciliation_resp = c_LoadRateReconciliation_resp;
end;

/*---------------------------------------------------*/
/* Класс с реализацией основного функционала сервиса */
/*---------------------------------------------------*/
private class (c_LoadRateReconciliation_req) c_LoadRateReconciliation_req_proc(p_income_data)
   /* Признак наличия ошибок */
   private var vg_is_error;
   /* Статусы для структуры верхнего уровня */
   private var vg_hl_error;
   /* Список зарегистрированных статусов для структур нижнего уровня */
   private var vg_ll_error_list;

   /* Метод получения признака наличия ошибок */
   macro m_get_error_status()
      return vg_is_error;
   end;

   /* Метод получения статуса для структуры верхнего уровня */
   macro m_get_hl_error()
      return vg_hl_error;
   end;

   /* Метод получения кода статуса для структур нижнего уровня */
   macro m_get_ll_error_code(p_index)
      return vg_ll_error_list.value(p_index).Code;
   end;

   /* Метод получения текста статуса для структур нижнего уровня */
   macro m_get_ll_error_text(p_index)
      return vg_ll_error_list.value(p_index).Text;
   end;

   private macro m_add_text_to_err(p_src_text, p_add_text)
      private var v_ret = "";

      if(strlen(p_src_text) != 0)
         v_ret = string(p_src_text, "|", p_add_text);
      else
         v_ret = p_add_text;
      end;

      return v_ret;
   end; /* macro m_add_text_to_err() */

   /* Конструктор */
   private macro m_init_prime(p_income_data)
      private var v_aux_buff;
      private var v_aux_cntr;

      vg_is_error = false;
      vg_hl_error = c_Result_Rate;
      vg_hl_error.Code = 0; /* Значение по умолчанию - ошибок нет */
      vg_hl_error.Text = "OK";
      vg_ll_error_list = TArray;

      if(p_income_data != V_UNDEF)
         ReqID = uTryToGetPropS(p_income_data, "ReqID");
         if(ValType(ReqID) == V_UNDEF)
            vg_is_error = true;
            vg_hl_error.Code = CV_Rate_ERROR_CODE;
            vg_hl_error.Text = m_add_text_to_err(vg_hl_error.Text, string(InErrComPart, "ReqID"));
            ReqID = XmlRpcRequestId();
         end;

         SenderId = uTryToGetPropS(p_income_data, "SenderId");
         if(ValType(SenderId) == V_UNDEF)
            vg_is_error = true;
            vg_hl_error.Code = CV_Rate_ERROR_CODE;
            vg_hl_error.Text = m_add_text_to_err(vg_hl_error.Text, string(InErrComPart, "SenderId"));
//            SenderId = XmlRpcRequestId();
         end;

         RepDate = uTryToGetPropS(p_income_data, "RepDate");
         if(ValType(RepDate) == V_UNDEF)
            vg_is_error = true;
            vg_hl_error.Code = CV_Rate_ERROR_CODE;
            vg_hl_error.Text = m_add_text_to_err(vg_hl_error.Text, string(InErrComPart, "RepDate"));
         end;
      end;
   onError(err)
      /* Записываем в ошибку структуры верхнего уровня структуры */
      vg_is_error = true;
      vg_hl_error.Code = CV_Rate_ERROR_CODE;
      vg_hl_error.Text = m_add_text_to_err(vg_hl_error.Text,
                                           string("При обработке входных параметров возникла ошибка: ",
                                                  c_usr_err_obj.obtain_err_msg(err)));
   end;

   Initc_LoadRateReconciliation_req();

   m_init_prime(p_income_data);
end; /* class c_LoadRateReconciliation_req_proc() */

/*---------------------*/
/* ТОЧКА ВХОДА СЕРВИСА */
/*---------------------*/
macro LoadRateReconciliation(p_income_data)
   private var v_aux_cntr, v_cmd, v_rs, v_SQL;
   private var v_income_data = NULL;
   var v_email_processor = NULL;
   var v_transformator = NULL;
   var v_service_processor = NULL;
   var v_save_processor = NULL;
   var v_resp_obj = NULL;
   var v_resp_doc;

   private var v_logger_obj;    /* Объект для работы с журналом */
   private var v_log_id;        /* Идентификатор записи в журнале (если требуется что-то добавить) */

   v_resp_obj = c_out_obj;

   /*
   /* Инициализация письма */
   v_email_processor = c_email_proc_env;
   v_email_processor.m_set_msg_head(CV_EMAIL_HEAD);
   /* !!! - Необходимо где-то брать список адресов для отправки уведомлений - !!! */
   v_email_processor.m_add_email_to_list(CV_EMAIL_RECEIVER);
   */

   if(ValType(p_income_data) != V_UNDEF)
      /* Преобразуем запрос в объектный вид - begin */
      v_transformator = c_secur_msg_converter();
      if(not v_transformator.m_decode_escaped_char(p_income_data))
         RunError(v_transformator.get_service_msg(), c_usr_err_obj(v_transformator.get_service_msg()));
      end;
      if(not v_transformator.m_make_pure_msg_from_ifx(v_transformator.get_pure_msg()))
         RunError(v_transformator.get_service_msg(), c_usr_err_obj(v_transformator.get_service_msg()));
      end;

      v_logger_obj = uws_exchng_logger(null, null, XmlRpcRequestId(), "LoadRateReconciliation", modulename(), NULL, v_transformator.get_pure_msg());
      v_log_id = v_logger_obj.get_log_id();

      v_income_data = v_transformator.m_secur_internal_req(v_transformator.get_pure_msg());
      /* Преобразуем запрос в объектный вид - end */

      v_service_processor = c_LoadRateReconciliation_req_proc(v_income_data);

      /* Общие параметры структуры верхнего уровня */
      v_resp_obj.LoadRateReconciliation_resp.ReqID    = v_service_processor.ReqID;
      v_resp_obj.LoadRateReconciliation_resp.SenderId = v_service_processor.SenderId;
      v_resp_obj.LoadRateReconciliation_resp.Result   = v_service_processor.m_get_hl_error();

      if(not v_service_processor.m_get_error_status())
         /* Формируем данные  */
	v_resp_obj.LoadRateReconciliation_resp.RateList = TArray;

   	v_cmd = NULL;
   	v_rs  = NULL;
   	/*
        v_SQL = "with dat as ( " +
                  "select fi.t_name    RateName," +
                  "       fi.t_fi_code RateShortName," +
                  "       CHR(0) CurrencyRate," +
                  "       CHR(0) RefIndex," +
                  "       trunc(sysdate) DateRate," +
                  "       rd.t_rate/power(10,rd.t_point)/rd.t_scale Rate," +
                  "       CHR(0) MaturityClass" +
                  "       from dfininstr_dbt fi, dratedef_dbt rd" +
                  "       where fi.t_fi_kind = 3" +
                  "         and fi.t_isclosed = chr(0)" +
                  "         and rd.t_otherfi (+)= fi.t_fiid " +
                  "         and rd.t_type = 1 " +
                  " union all" +
                  "       select fi.t_name    RateName," +
                  "              fi.t_fi_code RateShortName," +
                  "              CHR(0) CurrencyRate," +
                  "              CHR(0) RefIndex," +
                  "              rh.t_sincedate DateRate," +
                  "              rh.t_rate/power(10,rh.t_point)/rh.t_scale Rate," +
                  "              CHR(0) MaturityClass" +
                  "               from dratehist_dbt rh, dfininstr_dbt fi, dratedef_dbt rd" +
                  "              where rh.t_rateid(+) = rd.t_rateid" +
                  "                and fi.t_fi_kind = 3" +
                  "                and fi.t_isclosed = chr(0)" +
                  "                and rd.t_otherfi(+) = fi.t_fiid" +
                  "                and rd.t_type = 1" +
                  "                and rh.t_sincedate >= trunc(sysdate) - :p1) " +
                  " select * from dat d where  d.DateRate is not NULL " +
                  "       order by d.RateShortName, d.DateRate  ";
*/
        v_SQL = "with RDate as  " +
                  "     (select :p1 RepDate from dual), " +
                  "td_PFI as ( " +
                  "    select fi.t_fiid, " +
                  "           (select ak.t_name from davrkinds_dbt ak where ak.t_avoirkind = fi.t_avoirkind and ak.t_fi_kind = fi.t_fi_kind) PFI_Type, " +
                  "           fi.t_fi_code, " +
                  "           (select fk1.t_name from dfininstr_dbt fi1, dfikinds_dbt fk1 where fi1.t_fiid = fi.t_facevaluefi and fk1.t_fi_kind = fi1.t_fi_kind) FaceFIType, " +
                  "           (select case " +
                  "                      when fi1.t_fi_kind = 2 and fi1.t_avoirkind != 48 then " +
                  "                        (select NVL(c.t_isin,'ISIN') from davoiriss_dbt c where c.t_fiid = fi1.t_fiid) " +
                  "                   else " +
                  "                       NVL((select ak.t_name from davrkinds_dbt ak where ak.t_fi_kind = fi1.t_fi_kind and ak.t_avoirkind = fi1.t_avoirkind), fi1.t_name) " +
                  "                   end " +
                  "                   from dfininstr_dbt fi1 " +
                  "                  where fi1.t_fiid = fi.t_facevaluefi) FaceFIName, " +
                  "            (select fi1.t_fi_code from dfininstr_dbt fi1 where fi1.t_fiid = fi.t_facevaluefi) FaceFICode, " +
                  "             fi.t_name      ShortName, " +
                  "             to_char(d.t_lastcirculationdate, 'MON-YY','NLS_DATE_LANGUAGE=AMERICAN') MaturDate, " +
                  "        (select * from " +
                  "         (select /*+ INDEX (rd DRATEDEF_DBT_IDX3) */ rd.t_sincedate " +
                  "          from dratedef_dbt rd " +
                  "          where rd.t_type = 2 " +
                  "            and rd.t_otherfi(+)= fi.t_fiid " +
                  "            and rd.t_sincedate <= r.RepDate " +
                  "            ) where rownum = 1) rate_date_min, " +
                  "        (select * from " +
                  "         (select /*+ INDEX (rd DRATEDEF_DBT_IDX3) */  fi2.t_fi_code rate_fiid " +
                  "           from dfininstr_dbt fi2, dratedef_dbt rd " +
                  "          where rd.t_type = 2 " +
                  "            and rd.t_otherfi(+)= fi.t_fiid " +
                  "            and fi2.t_fiid = rd.t_fiid " +
                  "            and rd.t_sincedate <= r.RepDate " +
                  "            ) where rownum = 1) rate_fiid_min, " +
                  "        (select * from " +
                  "         (select /*+ INDEX (rd DRATEDEF_DBT_IDX3) */ rd.t_rate/power(10,rd.t_point)/rd.t_scale rate " +
                  "           from dratedef_dbt rd " +
                  "          where rd.t_type = 2 " +
                  "            and rd.t_otherfi(+)= fi.t_fiid " +
                  "            and rd.t_sincedate <= r.RepDate " +
                  "            ) where rownum = 1) rate_min, " +
                  "       (select * from  " +
                  "         (select /*+ INDEX (rd DRATEDEF_DBT_IDX3) */ rd.t_sincedate  " +
                  "          from dratedef_dbt rd " +
                  "          where rd.t_type = 3 " +
                  "            and rd.t_otherfi(+)= fi.t_fiid " +
                  "            and rd.t_sincedate <= r.RepDate " +
                  "            ) where rownum = 1) rate_date_max, " +
                  "        (select * from " +
                  "         (select /*+ INDEX (rd DRATEDEF_DBT_IDX3) */  fi2.t_fi_code rate_fiid " +
                  "           from dfininstr_dbt fi2, dratedef_dbt rd " +
                  "          where rd.t_type = 3 " +
                  "            and rd.t_otherfi(+)= fi.t_fiid " +
                  "            and fi2.t_fiid = rd.t_fiid " +
                  "            and rd.t_sincedate <= r.RepDate " +
                  "            ) where rownum = 1)  rate_fiid_max, " +
                  "        (select * from " +
                  "         (select /*+ INDEX (rd DRATEDEF_DBT_IDX3) */ rd.t_rate/power(10,rd.t_point)/rd.t_scale rate " +
                  "           from dratedef_dbt rd " +
                  "          where rd.t_type = 3 " +
                  "            and rd.t_otherfi(+)= fi.t_fiid " +
                  "            and rd.t_sincedate <= r.RepDate " +
                  "            ) where rownum = 1) rate_max, " +
                  "        (select * from  " +
                  "         (select /*+ INDEX (rd DRATEDEF_DBT_IDX3) */ rd.t_sincedate " +
                  "          from dratedef_dbt rd " +
                  "          where rd.t_type = 6 " +
                  "            and rd.t_otherfi(+)= fi.t_fiid " +
                  "            and rd.t_sincedate <= r.RepDate " +
                  "            ) where rownum = 1) rate_date_calc, " +
                  "        (select * from " +
                  "         (select /*+ INDEX (rd DRATEDEF_DBT_IDX3) */  fi2.t_fi_code rate_fiid " +
                  "           from dfininstr_dbt fi2, dratedef_dbt rd " +
                  "          where rd.t_type = 6 " +
                  "            and rd.t_otherfi(+)= fi.t_fiid " +
                  "            and fi2.t_fiid = rd.t_fiid " +
                  "            and rd.t_sincedate <= r.RepDate " +
                  "            ) where rownum = 1) rate_fiid_calc, " +
                  "        (select * from " +
                  "         (select /*+ INDEX (rd DRATEDEF_DBT_IDX3) */ rd.t_rate/power(10,rd.t_point)/rd.t_scale rate " +
                  "           from dratedef_dbt rd " +
                  "          where rd.t_type = 6 " +
                  "            and rd.t_otherfi(+)= fi.t_fiid " +
                  "            and rd.t_sincedate <= r.RepDate " +
                  "            ) where rownum = 1) rate_calc, " +
                  "         null rate_date_cb, " +
                  "         null rate_fiid_cb, " +
                  "         null rate_cb " +
                  "        from dfininstr_dbt fi, dfideriv_dbt d, RDate r " +
                  "       where exists (select /*+ INDEX (rd DRATEDEF_DBT_IDX3) */ 1 from dratedef_dbt rd " +
                  "                             where rd.t_rate is not null " +
                  "                               and rd.t_otherfi (+)= fi.t_fiid " +
                  "                               and rd.t_type in (2,3,6) " +
                  "                               ) " +
                  "        and d.t_fiid (+) = fi.t_fiid " +
                  "        and fi.t_fi_kind = 4  " +
                  "        and d.t_lastcirculationdate >= r.RepDate " +
                  "order by fi.t_avoirkind, fi.t_fiid), " +
                  "td_Curr as ( " +
                  " select fi.t_fiid, " +
                  "        null    PFI_Type, " +
                  "        fi.t_fi_code, " +
                  "        (select fk1.t_name from dfininstr_dbt fi1, dfikinds_dbt fk1 where fi1.t_fiid = fi.t_facevaluefi and fk1.t_fi_kind = fi1.t_fi_kind) FaceFIType, " +
                  "        fi.t_name FaceFIName,                                                                         " +
                  "        (select fi1.t_fi_code from dfininstr_dbt fi1 where fi1.t_fiid = fi.t_facevaluefi) FaceFICode, " +
                  "        fi.t_ccy  ShortName,                                                                          " +
                  "        to_char(fi.t_issued, 'MON-YY','NLS_DATE_LANGUAGE=AMERICAN') MaturDate, " +
                  "        null   RATE_DATE_MIN, " +
                  "        null   RATE_FIID_MIN, " +
                  "        null   RATE_MIN, " +
                  "        null   RATE_DATE_MAX, " +
                  "        null   RATE_FIID_MAX, " +
                  "        null   RATE_MAX, " +
                  "        null   RATE_DATE_CALC, " +
                  "        null   RATE_FIID_CALC, " +
                  "        null   RATE_CALC, " +
                  "       (select * from  " +
                  "         (select /*+ INDEX (rd DRATEDEF_DBT_IDX3) */ rd.t_sincedate " +
                  "          from dratedef_dbt rd " +
                  "          where rd.t_type = 7      " +
                  "            and rd.t_otherfi(+)= fi.t_fiid " +
                  "            and rd.t_sincedate <= r.RepDate " +
                  "            ) where rownum = 1) rate_date_cb, " +
                  "        (select * from " +
                  "         (select /*+ INDEX (rd DRATEDEF_DBT_IDX3) */ fi2.t_fi_code rate_fiid " +
                  "           from dfininstr_dbt fi2, dratedef_dbt rd " +
                  "          where rd.t_type = 7 " +
                  "            and rd.t_otherfi(+)= fi.t_fiid " +
                  "            and fi2.t_fiid = rd.t_fiid " +
                  "            and rd.t_sincedate <= r.RepDate " +
                  "            ) where rownum = 1) rate_fiid_cb, " +
                  "        (select * from " +
                  "         (select /*+ INDEX (rd DRATEDEF_DBT_IDX3) */ rd.t_rate/power(10,rd.t_point)/rd.t_scale rate_cb " +
                  "           from dratedef_dbt rd  " +
                  "          where rd.t_type = 7 " +
                  "            and rd.t_otherfi(+)= fi.t_fiid " +
                  "            and rd.t_sincedate <= r.RepDate " +
                  "            ) where rownum = 1) rate_cb " +
                  "   from dfininstr_dbt fi, RDate r   " +
                  "        where fi.t_fi_kind in (1,6) " +
                  "          and fi.t_isclosed = chr(0) " +
                  "          and fi.t_facevaluefi > -1 " +
                  "          and exists (select /*+ INDEX (rd DRATEDEF_DBT_IDX3) */ 1 from dratedef_dbt rd " +
                  "                       where rd.t_otherfi(+)= fi.t_fiid " +
                  "                         and rd.t_type = 7) " +
                  "), " +
                  "td_dat as ( " +
                  "select * from td_PFI " +
                  "       where RATE_MIN is not null " +
                  "         or RATE_MAX is not null " +
                  "         or RATE_CALC is not null " +
                  "         or RATE_CB is not null " +
                  "  union all " +
                  "select * from td_Curr " +
                  "       where RATE_MIN is not null " +
                  "         or RATE_MAX is not null " +
                  "         or RATE_CALC is not null " +
                  "         or RATE_CB is not null) , " +
                  "PFI as ( " +
                  "    select fi.t_fiid, " +
                  "           (select ak.t_name from davrkinds_dbt ak where ak.t_avoirkind = fi.t_avoirkind and ak.t_fi_kind = fi.t_fi_kind) PFI_Type, " +
                  "           fi.t_fi_code, " +
                  "           (select fk1.t_name from dfininstr_dbt fi1, dfikinds_dbt fk1 where fi1.t_fiid = fi.t_facevaluefi and fk1.t_fi_kind = fi1.t_fi_kind) FaceFIType, " +
                  "           (select case " +
                  "                      when fi1.t_fi_kind = 2 and fi1.t_avoirkind != 48 then " +
                  "                        (select NVL(c.t_isin,'ISIN') from davoiriss_dbt c where c.t_fiid = fi1.t_fiid) " +
                  "                   else " +
                  "                       NVL((select ak.t_name from davrkinds_dbt ak where ak.t_fi_kind = fi1.t_fi_kind and ak.t_avoirkind = fi1.t_avoirkind), fi1.t_name) " +
                  "                   end " +
                  "                   from dfininstr_dbt fi1 " +
                  "                  where fi1.t_fiid = fi.t_facevaluefi) FaceFIName, " +
                  "            (select fi1.t_fi_code from dfininstr_dbt fi1 where fi1.t_fiid = fi.t_facevaluefi) FaceFICode, " +
                  "             fi.t_name      ShortName, " +
                  "             to_char(d.t_lastcirculationdate, 'MON-YY','NLS_DATE_LANGUAGE=AMERICAN') MaturDate, " +
                  "        (select * from " +
                  "         (select /*+ INDEX (rd DRATEDEF_DBT_IDX3) INDEX (rh DRATEHIST_DBT_IDX1) */ rh.t_sincedate " +
                  "          from dratedef_dbt rd, dratehist_dbt rh " +
                  "          where rd.t_type = 2 " +
                  "            and rd.t_otherfi(+)= fi.t_fiid " +
                  "            and rh.t_rateid(+) = rd.t_rateid " +
                  "            and rh.t_sincedate <= r.RepDate " +
                  "            ) where rownum = 1) rate_date_min, " +
                  "        (select * from " +
                  "         (select /*+ INDEX (rd DRATEDEF_DBT_IDX3) */ fi2.t_fi_code rate_fiid " +
                  "           from dfininstr_dbt fi2, dratedef_dbt rd " +
                  "          where rd.t_type = 2 " +
                  "            and rd.t_otherfi(+)= fi.t_fiid " +
                  "           and fi2.t_fiid = rd.t_fiid " +
                  "          ORDER BY rd.T_RATEID, rd.T_SINCEDATE DESC " +
                  "            ) where rownum = 1) rate_fiid_min, " +
                  "        (select * from  " +
                  "         (select /*+ INDEX (rd DRATEDEF_DBT_IDX3) INDEX (rh DRATEHIST_DBT_IDX1) */ rh.t_rate/power(10,rh.t_point)/rh.t_scale rate_min " +
                  "           from dratedef_dbt rd, dratehist_dbt rh " +
                  "          where rd.t_type = 2 " +
                  "            and rd.t_otherfi(+)= fi.t_fiid " +
                  "            and rh.t_rateid(+) = rd.t_rateid " +
                  "            and rh.t_sincedate <= r.RepDate " +
                  "            ) where rownum = 1) rate_min, " +
                  "        (select * from " +
                  "         (select /*+ INDEX (rd DRATEDEF_DBT_IDX3) INDEX (rh DRATEHIST_DBT_IDX1) */ rh.t_sincedate " +
                  "          from dratedef_dbt rd, dratehist_dbt rh " +
                  "          where rd.t_type = 3 " +
                  "            and rd.t_otherfi(+)= fi.t_fiid " +
                  "            and rh.t_rateid(+) = rd.t_rateid " +
                  "            and rh.t_sincedate <= r.RepDate " +
                  "            ) where rownum = 1) rate_date_max, " +
                  "        (select * from " +
                  "         (select /*+ INDEX (rd DRATEDEF_DBT_IDX3) */ fi2.t_fi_code rate_fiid " +
                  "           from dfininstr_dbt fi2, dratedef_dbt rd " +
                  "          where rd.t_type = 3 " +
                  "            and rd.t_otherfi(+)= fi.t_fiid " +
                  "           and fi2.t_fiid = rd.t_fiid " +
                  "            ) where rownum = 1) rate_fiid_max, " +
                  "        (select * from " +
                  "         (select /*+ INDEX (rd DRATEDEF_DBT_IDX3) INDEX (rh DRATEHIST_DBT_IDX1) */ rh.t_rate/power(10,rh.t_point)/rh.t_scale rate_max " +
                  "           from dratedef_dbt rd, dratehist_dbt rh " +
                  "          where rd.t_type = 3 " +
                  "            and rd.t_otherfi(+)= fi.t_fiid " +
                  "            and rh.t_rateid(+) = rd.t_rateid " +
                  "            and rh.t_sincedate <= r.RepDate " +
                  "            ) where rownum = 1) rate_max, " +
                  "        (select * from " +
                  "         (select /*+ INDEX (rd DRATEDEF_DBT_IDX3) INDEX (rh DRATEHIST_DBT_IDX1) */ rh.t_sincedate " +
                  "          from dratedef_dbt rd, dratehist_dbt rh " +
                  "          where rd.t_type = 6 " +
                  "            and rd.t_otherfi(+)= fi.t_fiid " +
                  "            and rh.t_rateid(+) = rd.t_rateid " +
                  "            and rh.t_sincedate <= r.RepDate " +
                  "            ) where rownum = 1)  rate_date_calc, " +
                  "        (select * from " +
                  "         (select /*+ INDEX (rd DRATEDEF_DBT_IDX3) */ fi2.t_fi_code rate_fiid " +
                  "           from dfininstr_dbt fi2, dratedef_dbt rd " +
                  "          where rd.t_type = 6 " +
                  "            and rd.t_otherfi(+)= fi.t_fiid " +
                  "           and fi2.t_fiid = rd.t_fiid " +
                  "           ORDER BY rd.T_RATEID, rd.T_SINCEDATE DESC " +
                  "            ) where rownum = 1) rate_fiid_calc, " +
                  "        (select * from " +
                  "         (select /*+ INDEX (rd DRATEDEF_DBT_IDX3) INDEX (rh DRATEHIST_DBT_IDX1) */ rh.t_rate/power(10,rh.t_point)/rh.t_scale rate_calc " +
                  "           from dratedef_dbt rd, dratehist_dbt rh " +
                  "          where rd.t_type = 6 " +
                  "            and rd.t_otherfi(+)= fi.t_fiid " +
                  "            and rh.t_rateid(+) = rd.t_rateid " +
                  "            and rh.t_sincedate <= r.RepDate " +
                  "            ) where rownum = 1) rate_calc, " +
                  "         null rate_date_cb, " +
                  "         null rate_fiid_cb, " +
                  "         null rate_cb " +
                  "     from dfininstr_dbt fi, dfideriv_dbt d, RDate r " +
                  "       where exists (select 1 from dratedef_dbt rd " +
                  "                             where rd.t_rate is not null " +
                  "                               and rd.t_otherfi (+)= fi.t_fiid " +
                  "                               and rd.t_sincedate <= r.RepDate " +
                  "                               ) " +
                  "        and d.t_fiid (+) = fi.t_fiid " +
                  "        and fi.t_fi_kind = 4  " +
                  "        and d.t_lastcirculationdate >= r.RepDate " +
                  "        and not exists (select 1 from td_dat where t_fiid(+) = fi.t_fiid)), " +
                  "Curr as ( " +
                  "     select fi.t_fiid, " +
                  "        null    PFI_Type, " +
                  "        fi.t_fi_code, " +
                  "        (select fk1.t_name from dfininstr_dbt fi1, dfikinds_dbt fk1 where fi1.t_fiid = fi.t_facevaluefi and fk1.t_fi_kind = fi1.t_fi_kind) FaceFIType, " +
                  "        fi.t_name FaceFIName,                                                                         " +
                  "        (select fi1.t_fi_code from dfininstr_dbt fi1 where fi1.t_fiid = fi.t_facevaluefi) FaceFICode, " +
                  "        fi.t_ccy  ShortName,                                                                          " +
                  "        to_char(fi.t_issued, 'MON-YY','NLS_DATE_LANGUAGE=AMERICAN') MaturDate, " +
                  "        null   RATE_DATE_MIN, " +
                  "        null   RATE_FIID_MIN, " +
                  "        null   RATE_MIN, " +
                  "        null   RATE_DATE_MAX, " +
                  "        null   RATE_FIID_MAX, " +
                  "        null   RATE_MAX, " +
                  "        null   RATE_DATE_CALC, " +
                  "        null   RATE_FIID_CALC, " +
                  "        null   RATE_CALC, " +
                  "        (select * from " +
                  "         (select /*+ INDEX (rd DRATEDEF_DBT_IDX3) INDEX (rh DRATEHIST_DBT_IDX1) */ rh.t_sincedate " +
                  "          from dratedef_dbt rd, dratehist_dbt rh " +
                  "          where rd.t_type = 7 " +
                  "            and rd.t_otherfi(+)= fi.t_fiid " +
                  "            and rh.t_rateid(+) = rd.t_rateid " +
                  "            and rh.t_sincedate <= r.RepDate " +
                  "            ) where rownum = 1)  rate_date_cb, " +
                  "        (select rate_fiid from " +
                  "         (select /*+ INDEX (rd DRATEDEF_DBT_IDX3) */ fi2.t_fi_code rate_fiid " +
                  "           from dfininstr_dbt fi2, dratedef_dbt rd " +
                  "          where rd.t_type = 7 " +
                  "            and rd.t_otherfi(+)= fi.t_fiid " +
                  "           and fi2.t_fiid = rd.t_fiid " +
                  "           ORDER BY rd.T_RATEID, rd.T_SINCEDATE DESC " +
                  "            ), RDate r where rownum = 1)  rate_fiid_cb, " +
                  "        (select * from " +
                  "         (select /*+ INDEX (rd DRATEDEF_DBT_IDX3) INDEX (rh DRATEHIST_DBT_IDX1) */ rh.t_rate/power(10,rh.t_point)/rh.t_scale rate_cb " +
                  "           from dfininstr_dbt fi2, dratedef_dbt rd, dratehist_dbt rh " +
                  "          where rd.t_type = 7 " +
                  "            and rd.t_otherfi(+)= fi.t_fiid " +
                  "            and rh.t_rateid(+) = rd.t_rateid " +
                  "            and fi2.t_fiid = rd.t_fiid " +
                  "            and rh.t_sincedate <= r.RepDate " +
                  "            ) where rownum = 1) rate_cb " +
                  "   from dfininstr_dbt fi, RDate r " +
                  "        where fi.t_fi_kind in (1,6) " +
                  "          and fi.t_isclosed = chr(0) " +
                  "          and fi.t_facevaluefi > -1 " +
                  "          and exists (select 1 from dratedef_dbt rd " +
                  "                       where rd.t_otherfi (+)= fi.t_fiid " +
                  "                                 and rd.t_type = 7) " +
                  "         and not exists (select 1 from td_dat where t_fiid(+) = fi.t_fiid)), " +
                  "dat as ( " +
                  "  select * from PFI " +
                  "      where RATE_MIN is not null " +
                  "         or RATE_MAX is not null " +
                  "         or RATE_CALC is not null " +
                  "         or RATE_CB is not null " +
                  "    union all " +
                  "  select * from Curr " +
                  "      where RATE_MIN is not null " +
                  "         or RATE_MAX is not null " +
                  "         or RATE_CALC is not null " +
                  "         or RATE_CB is not null), " +
                  "rep as(          " +
                  "select * from dat " +
                  "    union all " +
                  "select * from td_dat) " +
                  "  select /*+PARALLEL_AUTO*/  " +
                  "         T_FIID, " +
                  "         PFI_TYPE, " +
                  "         T_FI_CODE, " +
                  "         FACEFITYPE, " +
                  "         FACEFINAME, " +
                  "         FACEFICODE, " +
                  "         SHORTNAME, " +
                  "         MATURDATE, " +
                  "         RATE_DATE_MIN, " +
                  "         RATE_FIID_MIN, " +
                  "         RATE_MIN, " +
                  "         RATE_DATE_MAX, " +
                  "         RATE_FIID_MAX, " +
                  "         RATE_MAX, " +
                  "         RATE_DATE_CALC, " +
                  "         RATE_FIID_CALC, " +
                  "         RATE_CALC, " +
                  "         RATE_DATE_CB, " +
                  "         RATE_FIID_CB, " +
                  "         RATE_CB " +
                  "    from rep " +
                  " order by pfi_type DESC, facefitype, t_fiid";

	  v_cmd = RsdCommand(v_SQL);
	  v_cmd.addParam("p1", RSDBP_IN, v_service_processor.RepDate);
	  v_cmd.execute();

          v_rs = RsdRecordset(v_cmd);

          while (v_rs.moveNext())
		v_aux_cntr = v_resp_obj.LoadRateReconciliation_resp.RateList.Size;
	        v_resp_obj.LoadRateReconciliation_resp.RateList.value(v_aux_cntr) = c_RateParm_resp;  
		v_resp_obj.LoadRateReconciliation_resp.RateList.value(v_aux_cntr).PFI_TYPE      = SQL_ConvTypeStr(v_rs.value("PFI_TYPE"));
		v_resp_obj.LoadRateReconciliation_resp.RateList.value(v_aux_cntr).T_FI_CODE     = SQL_ConvTypeStr(v_rs.value("T_FI_CODE"));
		v_resp_obj.LoadRateReconciliation_resp.RateList.value(v_aux_cntr).FACEFITYPE    = SQL_ConvTypeStr(v_rs.value("FACEFITYPE")); 
		v_resp_obj.LoadRateReconciliation_resp.RateList.value(v_aux_cntr).FACEFINAME    = SQL_ConvTypeStr(v_rs.value("FACEFINAME")); 
		v_resp_obj.LoadRateReconciliation_resp.RateList.value(v_aux_cntr).FACEFICODE    = SQL_ConvTypeStr(v_rs.value("FACEFICODE"));
		v_resp_obj.LoadRateReconciliation_resp.RateList.value(v_aux_cntr).SHORTNAME     = SQL_ConvTypeStr(v_rs.value("SHORTNAME"));
  		v_resp_obj.LoadRateReconciliation_resp.RateList.value(v_aux_cntr).MATURDATE     = SQL_ConvTypeStr(v_rs.value("MATURDATE"));
		v_resp_obj.LoadRateReconciliation_resp.RateList.value(v_aux_cntr).RATE_DATE_MIN = SQL_ConvTypeDate(v_rs.value("RATE_DATE_MIN"));
		v_resp_obj.LoadRateReconciliation_resp.RateList.value(v_aux_cntr).RATE_FIID_MIN = SQL_ConvTypeStr(v_rs.value("RATE_FIID_MIN"));
		v_resp_obj.LoadRateReconciliation_resp.RateList.value(v_aux_cntr).RATE_MIN      = SQL_ConvTypeStr(v_rs.value("RATE_MIN")); 
		v_resp_obj.LoadRateReconciliation_resp.RateList.value(v_aux_cntr).RATE_DATE_MAX = SQL_ConvTypeDate(v_rs.value("RATE_DATE_MAX")); 
		v_resp_obj.LoadRateReconciliation_resp.RateList.value(v_aux_cntr).RATE_FIID_MAX = SQL_ConvTypeStr(v_rs.value("RATE_FIID_MAX"));
		v_resp_obj.LoadRateReconciliation_resp.RateList.value(v_aux_cntr).RATE_MAX      = SQL_ConvTypeStr(v_rs.value("RATE_MAX"));
  		v_resp_obj.LoadRateReconciliation_resp.RateList.value(v_aux_cntr).RATE_DATE_CALC= SQL_ConvTypeDate(v_rs.value("RATE_DATE_CALC"));
		v_resp_obj.LoadRateReconciliation_resp.RateList.value(v_aux_cntr).RATE_FIID_CALC= SQL_ConvTypeStr(v_rs.value("RATE_FIID_CALC"));
		v_resp_obj.LoadRateReconciliation_resp.RateList.value(v_aux_cntr).RATE_CALC     = SQL_ConvTypeStr(v_rs.value("RATE_CALC"));
		v_resp_obj.LoadRateReconciliation_resp.RateList.value(v_aux_cntr).RATE_DATE_CB  = SQL_ConvTypeDate(v_rs.value("RATE_DATE_CB")); 
		v_resp_obj.LoadRateReconciliation_resp.RateList.value(v_aux_cntr).RATE_FIID_CB  = SQL_ConvTypeStr(v_rs.value("RATE_FIID_CB")); 
		v_resp_obj.LoadRateReconciliation_resp.RateList.value(v_aux_cntr).RATE_CB       = SQL_ConvTypeStr(v_rs.value("RATE_CB"));
          end;
      else
         /* Зафиксированы ошибки на верхнем уровне структуры */
         v_resp_obj.LoadRateReconciliation_resp.RateList = TArray;
      end;

   else
      /* Ошибка в структуру верхнего уровня - не переданы входные данные */
      v_resp_obj.LoadRateReconciliation_resp.ReqID       = XmlRpcRequestId(); /* Поскольку не можем взять информацию из входящего объекта */
      v_resp_obj.LoadRateReconciliation_resp.Result      = c_Result_Rate;
      v_resp_obj.LoadRateReconciliation_resp.Result.Code = CV_Rate_ERROR_CODE;
      v_resp_obj.LoadRateReconciliation_resp.Result.Text = "Не переданы входящие параметры для реконсиляции котировок";
      v_resp_obj.LoadRateReconciliation_resp.RateList    = TArray;
/*
      v_email_processor.m_add_row_to_msg_text(string(CV_EMAIL_ROW_HEAD,
                                              v_resp_obj.LoadRateReconciliation_resp.ReqID, " - ",
                                              v_resp_obj.LoadRateReconciliation_resp.Result.Text));
*/
   end;
/*
   /* Сохраняем текст письма для отправки плановой процедурой */
   v_email_processor.m_save_to_submit();
   /* Отправляем все не отправленные письма */
   v_email_processor.m_submit_email();
*/
   /* Преобразуем объектный вид ответа в документ требуемого формата - begin */
   v_resp_doc = v_transformator.m_secur_internal_resp(v_resp_obj);
   /* Преобразуем объектный вид ответа в документ требуемого формата - end */

   v_logger_obj.add_response(v_resp_doc, null, null, null, modulename, null);
   v_logger_obj.add_error_info(v_resp_obj.LoadRateReconciliation_resp.Result.Code, v_resp_obj.LoadRateReconciliation_resp.Result.Text);

   return v_resp_doc;

onError(err)
   if(ValType(v_resp_obj.LoadRateReconciliation_resp.ReqID) == V_UNDEF)
      v_resp_obj.LoadRateReconciliation_resp.ReqID = XmlRpcRequestId();
   end;
   v_resp_obj.LoadRateReconciliation_resp.Result      = NULL;
   v_resp_obj.LoadRateReconciliation_resp.Result      = c_Result_Rate;
   v_resp_obj.LoadRateReconciliation_resp.Result.Code = CV_Rate_ERROR_CODE;
   v_resp_obj.LoadRateReconciliation_resp.Result.Text = c_usr_err_obj.obtain_err_msg(err);

   /* Преобразуем объектный вид ответа в документ требуемого формата - begin */
   v_resp_doc = v_transformator.m_secur_internal_resp(v_resp_obj);
   /* Преобразуем объектный вид ответа в документ требуемого формата - end */

   v_logger_obj.add_response(v_resp_doc, null, null, null, modulename);
   v_logger_obj.add_error_info(v_resp_obj.LoadRateReconciliation_resp.Result.Code, v_resp_obj.LoadRateReconciliation_resp.Result.Text);

   return v_resp_doc;
end; /* macro LoadRateReconciliation() */
