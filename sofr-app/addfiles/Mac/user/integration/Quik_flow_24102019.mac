import oralib, likepy, globals, CTInter;

Const  CategNumber = 171;
Const QuikCode = 105;
Const REG_EXPORT_PATH = "РСХБ\\интеграция\\директории\\Export\\Quik_folder";

//Проверка корректности загрузки клиента в Quik
macro Check_Correct_Response(ClientId)
var XML, name, StrPath, ErrCode, sql, dt;

   sql = ExecSqlSelect("select trunc(sysdate) from dual");
   sql.movenext();
   dt = StrSubst(string(date(sql.value(0))), " ", "0");
   dt = StrSubst(dt, ".", "");

   GetRegistryValue(REG_EXPORT_PATH, V_STRING, StrPath, ErrCode);
   if( ErrCode > 0 )
      StrPath = "d:\\rshb_sofr\\export\\";
   end;

   xml = ActiveX("Microsoft.XMLDOM");

   XML.load( StrPath + "Out\\in_"+ClientId+"_" + dt + ".xml");
   if (xml.url !="")
       name = XML.getElementsByTagName("Result").item(0).getAttributeNode("UID").text;
   else
      name  = -1;
   end;
   return(name);
end;

//Проверка некорректности загрузки клиента в Quik
macro Check_Error_Response(ClientId)
var XML, name, StrPath, ErrCode, sql, dt;

   sql = ExecSqlSelect("select trunc(sysdate) from dual");
   sql.movenext();
   dt = StrSubst(string(date(sql.value(0))), " ", "0");
   dt = StrSubst(dt, ".", "");
   GetRegistryValue(REG_EXPORT_PATH, V_STRING, StrPath, ErrCode);
   if( ErrCode > 0 )
      StrPath = "d:\\rshb_sofr\\export\\";
   end;

   xml = ActiveX("Microsoft.XMLDOM");

   XML.load( StrPath + "Error\\in_"+ClientId+"_" + dt + ".xml");
   if (xml.url !="")
       name = 1;
   else
      name  = 0;
   end;
   return(name);
end;

macro MakeOneElement (ParentElement, ElementName, ElementValue, xml)
   var Element;
   Element = xml.createElement(ElementName);
   Element.Text = ElementValue;
   ParentElement.appendChild(Element);
End;

//Загрузка клиента в Quik
macro Quik_User_Create (ClientId, OperKind)
   var sql, xml, tempXML, contact;
   var UserData, Command, UserInfo,Organization, ContactInfo, Permission, PermissionsOnMarket,Permission2,  GlobalRights, Module, Options, UserKey, Certificate, TFAuth, AssignToManagers,  RSAKey, Classes, FileName ;
   var Security,AuthByLogin, Login, Passwor, sqldate, StrPath, ErrCode, dt;
   var Name1, Name2, Name3, tmp, symnom, validdate,validto, SMSPhone, EMail, sqlpass, sqlUID, sqlcodes, codes;


   GetRegistryValue(REG_EXPORT_PATH, V_STRING, StrPath, ErrCode);
   if( ErrCode > 0 )
      StrPath = "d:\\rshb_sofr\\export\\";
   end;

   sqldate = ExecSqlSelect("select trunc(sysdate) from dual");
   sqldate.movenext();
   dt = StrSubst(string(date(sqldate.value(0))), " ", "0");
   dt = StrSubst(dt, ".", "");
   TempXML = StrPath + "in\\in_"+ClientId+"_" + dt + ".xml";
   
   xml = ActiveX("Microsoft.XMLDOM");
   xml.appendChild( xml.createProcessingInstruction("xml"," version='1.0' encoding='Windows-1251'") );
   UserData  = xml.createElement("UserData");

   command = xml.createElement("Command");
   
   if (OperKind == 1)
      command.setAttribute("Type", "AddUser");
   else 
      command.setAttribute("Type", "UpdateUser");
   end;
   
   if (OperKind == 2)
      sqlUID = ExecSqlSelect("select t_code from dobjcode_dbt where t_codekind = :codekind and t_objectid = :objid",
                    makeArray(SqlParam("codekind", QuikCode ), SqlParam("objid", ClientId )));
      sqlUID.movenext();
      MakeOneElement (UserData, "UID", sqlUID.value(0), xml);
   end;

   sql = ExecSqlSelect("select t_name, t_legalform  from dparty_dbt where t_partyid = :partyid", makeArray(SqlParam("partyid", ClientId )));
   sql.movenext();
   //Здесь сделать в зависимости от легалформ либо для физиков, либо для юриков.

   if (sql.value(1) == 1)
      Name1 = subStr(sql.value(0), 1, 150);
      Name2 = subStr(sql.value(0), 151, 300);
      Name2 = subStr(sql.value(0), 301, 450);
   else
      symnom = strbrk(sql.value(0), " ");
      Name1 = substr(sql.value(0), 1, symnom-1);
      tmp = substr(sql.value(0), symnom + 1);
      symnom = strbrk(tmp, " ");
      Name2 = substr(tmp,1, symnom-1);
      Name3 = substr(tmp, symnom + 1);      
   end;


   UserInfo = xml.createElement("UserInfo");
   MakeOneElement (UserInfo, "FirstName", Name2, xml);
   MakeOneElement (UserInfo, "MiddleName", Name3, xml);
   MakeOneElement (UserInfo, "LastName", Name1, xml);
   MakeOneElement (UserInfo, "Comment", null, xml);
   command.appendchild(Userinfo);

   Permission = xml.createElement("Permission");
   sqldate = ExecSqlSelect("select trunc(sysdate) from dual");
   sqldate.movenext();
   dt = StrSubst(string(date(sqldate.value(0))), " ", "0");
   dt = StrSubst(dt, ".", "");
   validdate = substr(dt, 5) + "-" + substr(dt, 3, 2) + "-" + substr(dt, 1,2);
   dt = StrSubst(string(date(sqldate.value(0))+36524), " ", "0");
   dt = StrSubst(dt, ".", "");
   validto = substr(dt, 5) + "-" + substr(dt, 3, 2) + "-" + substr(dt, 1,2);
   MakeOneElement (Permission, "ValidFrom", validdate, xml);
   MakeOneElement (Permission, "ValidTo", validto, xml);
   command.appendchild(Permission);

   contactinfo = xml.createElement("ContactInfo");
   contact = ExecSqlSelect("SELECT  t_value  FROM dcontact_dbt  WHERE t_partyid = :partyid  AND t_addresstype in ( 0,1)  AND t_ismain = 'X' AND t_contactkind = 1 AND t_contacttype = 3", makeArray(SqlParam("partyid", ClientId )));
   if (contact.movenext());
      MakeOneElement (contactinfo, "Phone", contact.value(0), xml);
   else
      MakeOneElement (contactinfo, "Phone", "-", xml);
   end;

   contact = ExecSqlSelect("SELECT  t_value  FROM dcontact_dbt  WHERE t_partyid = :partyid  AND t_addresstype in ( 0,1)  AND t_ismain = 'X' AND t_contactkind = 1 AND t_contacttype = 1", makeArray(SqlParam("partyid", ClientId )));
   if (contact.movenext());
      SMSPhone = contact.value(0);
   else 
      SMSPhone = "-";
   end;
   MakeOneElement (contactinfo, "SMS", SMSPhone, xml);

   contact = ExecSqlSelect("SELECT  t_value  FROM dcontact_dbt  WHERE t_partyid = :partyid  AND t_addresstype in ( 0,1)  AND t_ismain = 'X' AND t_contactkind = 5 AND t_contacttype = 8", makeArray(SqlParam("partyid", ClientId )));
   if (contact.movenext());
      EMail  = contact.value(0);
   else
      EMail  = "-";
   end;
   MakeOneElement (contactinfo, "EMail", EMail, xml);
   command.appendchild(contactinfo);

   Security = xml.createElement("Security");
   MakeOneElement (Security, "CryptoType", "Unknown", xml);
   command.appendchild(Security);

   GlobalRights = xml.createElement("GlobalRights");
   MakeOneElement (GlobalRights, "Rights", "Phr", xml);
   MakeOneElement (GlobalRights, "Blocked", 0, xml);
   MakeOneElement (GlobalRights, "Archives", 1, xml);
   MakeOneElement (GlobalRights, "API", 1, xml);
   MakeOneElement (GlobalRights, "SeeNews", 0, xml);
   MakeOneElement (GlobalRights, "SendMessages", 0, xml);
   MakeOneElement (GlobalRights, "ReceiveMessages", 1, xml);
   MakeOneElement (GlobalRights, "NeedSign", 0, xml);
   command.appendchild(GlobalRights);

   MakeOneElement (command, "IPAddress", null, xml);
   MakeOneElement (command, "MsgGroup","CLNT", xml);
   MakeOneElement (command, "News", null, xml);
   MakeOneElement (command, "MessagesTo", null, xml);

   Organization = xml.createElement("Organization");   
   MakeOneElement (Organization, "OrgCode", 2, xml);
   MakeOneElement (Organization, "OrgName", "Клиенты ОАО &quot;Российский сельскохозяйственный банк&quot;", xml);      
   MakeOneElement (Organization, "Address", null, xml);
   MakeOneElement (Organization, "EMail", null, xml);
   command.appendchild(Organization);

   Classes = xml.createElement("Classes");
   sqlcodes = ExecSqlSelect("select mp.t_mpcode from dsfcontr_dbt sf join ddlcontrmp_dbt mp on sf.t_id = mp.t_sfcontrid "+
                                          "where  sf.t_partyid = :partyid and t_servkind = 1 and t_servkindsub = 8 ", makeArray(SqlParam("partyid", ClientId )));
   sqlcodes.movenext();
   codes = string(sqlcodes.value(0));
   while (sqlcodes.movenext())
      codes = codes + ", " + sqlcodes.value(0);
   end;
   Classes.setAttribute("ClientCodes", codes);
   Classes.setAttribute("FirmID", "MC0134700000");
   Classes.setAttribute("Rights", "BCGTbcoptvx");
   Classes.text = "A, EQDB, EQEO, EQGO, EQOB, EQQI, EQTD, EQYO, INDX, TQBD, TQBR, TQDD, TQDE, TQIF, TQOB, TQOD, TQQD, TQQI, TQTD, TQTF";
   command.appendchild(Classes);
   sqlcodes = null; codes = null;

   Classes = xml.createElement("Classes");
   sqlcodes = ExecSqlSelect("select mp.t_mpcode from dsfcontr_dbt sf join ddlcontrmp_dbt mp on sf.t_id = mp.t_sfcontrid "+
                                          "where  sf.t_partyid = :partyid and t_servkind = 15 and t_servkindsub = 8 ", makeArray(SqlParam("partyid", ClientId )));
   sqlcodes.movenext();
   codes = string(sqlcodes.value(0));
   while (sqlcodes.movenext())
      codes = codes + ", " + sqlcodes.value(0);
   end;   
   Classes.setAttribute("ClientCodes", codes);
   Classes.setAttribute("FirmID", "SPBFUTF502");
   Classes.setAttribute("Rights", "BCGTbcoptvx");
   Classes.text = "SPBFUT";
   command.appendchild(Classes);

   AuthByLogin = xml.createElement("AuthByLogin");
   MakeOneElement (AuthByLogin, "WebQuik", 1, xml);
   MakeOneElement (AuthByLogin, "Desktop", 1, xml);
      login = xml.createElement("Login");
      login.Text = ClientId;//соответствует коду клиента в СОФР
      AuthByLogin.appendchild(login);
      
   if (OperKind == 1)
      sqlpass = ExecSqlSelect("SELECT t_code_word FROM usr_clnt_cdwrd_buf_dbt  "+
                                            " WHERE t_cw_type = 1  AND t_cw_client = :p_cw_client", makeArray(SqlParam("p_cw_client", ClientId )));
      sqlpass.movenext();
      Passwor = xml.createElement("Password");
      Passwor.Text = sqlpass.value(0);
      Passwor.setAttribute("Type", "plain");
      Passwor.setAttribute("NeedChange", 1);
      Passwor.setAttribute("ValidityTerm", 365);
      AuthByLogin.appendchild(Passwor);  
      command.appendchild(AuthByLogin); 
   end;

   MakeOneElement (command, "TFAuthUse", 1, xml);

   TFAuth  = xml.createElement("TFAuth");
   TFAuth.setAttribute("Platform", -1);
   MakeOneElement (TFAuth, "AuthType", -1, xml);
   MakeOneElement (TFAuth, "Scenario", -1, xml);
   command.appendchild(TFAuth);

   TFAuth  = xml.createElement("TFAuth");
   TFAuth.setAttribute("Platform", 1);
   MakeOneElement (TFAuth, "AuthType", 2, xml);
   MakeOneElement (TFAuth, "Scenario", 1, xml);
   MakeOneElement (TFAuth, "ExpireDays", 0, xml);
   MakeOneElement (TFAuth, "SMSPhone", SMSPhone, xml);
   MakeOneElement (TFAuth, "CodeWord", null  , xml);
   MakeOneElement (TFAuth, "EMail", null, xml);
   command.appendchild(TFAuth);

   Userdata.appendChild(command);
   xml.appendChild(UserData);

   println(string(xml.xml));
   xml.Save(TempXML);
   Return (0);
   
   OnError(er)
      return 3;

End;

//Старт потока квик
macro Start_Quik_flow(ClientId)
var AttrCode, Rezult, Err, load, sqlcode;
   GetMainObjAttr(err, 3, string(ClientId:10:o), CategNumber, AttrCode);
   
   sqlcode = ExecSqlSelect("select * from dobjcode_dbt  where t_objecttype = 3 and T_CODEKIND = :codekind and "+
                                         "T_OBJECTID = :partyid and (T_BANKCLOSEDATE > sysdate or T_BANKCLOSEDATE = to_date('01010001', 'ddmmyyyy'))", 
                                         makeArray(SqlParam("codekind", QuikCode ),SqlParam("partyid", ClientId )));
   if (sqlcode.movenext())

      if (AttrCode == 1)
         load = Quik_User_Create(ClientId, 2);
         DisconnectObjAttr(3, string(ClientId:10:o), CategNumber, 0);
         return (load);
      end;
      if (AttrCode == 2)
         DisconnectObjAttr(3, string(ClientId:10:o), CategNumber, 0);
         Start_Quik_flow(ClientId);
      end;
   if (AttrCode == 3)
      Rezult = Check_Correct_Response(ClientId);
         If (Rezult  !=  -1)
           DisconnectObjAttr(3, string(ClientId:10:o), CategNumber, 0);
           ConnectObjAttr(err, 3, string(ClientId:10:o), CategNumber, 1);
           return 1;

         else
            Err = Check_Error_Response(ClientId);
            if (Err == 0 )
               return 0;
               DisconnectObjAttr(3, string(ClientId:10:o), CategNumber, 0);
               ConnectObjAttr(err, 3, string(ClientId:10:o), CategNumber, 2);
            else
               return 2;
            end;
         end;
   end;
   else
      if (AttrCode == 3)
         Rezult = Check_Correct_Response(ClientId);
            If (Rezult  !=  -1)
              var cmd = "INSERT INTO dobjcode_dbt (T_OBJECTTYPE,   T_CODEKIND, T_OBJECTID, T_CODE, T_STATE, "+
                                                            "            T_BANKDATE, T_SYSDATE, T_SYSTIME, T_USERID, T_BRANCH, "+
                                                            "            T_NUMSESSION, T_UNIQUE, T_BANKCLOSEDATE ) "+
                                                            "  values (3, :codekind, :objid, :code, 0, to_date('01/01/2018', 'dd/mm/yyyy'), "+
                                                            "                     to_date('01/01/0001', 'dd/mm/yyyy'), to_date('01/01/0001', 'dd/mm/yyyy'), "+
                                                            "                     0, 0, 0, null, to_date('01/01/0001', 'dd/mm/yyyy') ) ;  ";
              cmd = RSDCommand(cmd);
              cmd.AddParam("codekind", RSDBP_IN, QuikCode);
              cmd.AddParam("objid", RSDBP_IN, ClientId);
              cmd.AddParam("code", RSDBP_IN, Rezult);
              cmd.execute;
              DisconnectObjAttr(3, string(ClientId:10:o), CategNumber, 0);
              ConnectObjAttr(err, 3, string(ClientId:10:o), CategNumber, 1);
   
              var cmdDel = " DELETE FROM usr_clnt_cdwrd_buf_dbt  "+
                           "  WHERE t_cw_type = 1                "+
                           "  AND t_cw_client = :p_cw_client     ";
              cmdDel = RSDCommand(cmdDel);
              cmdDel.AddParam("p_cw_client", RSDBP_IN, ClientId);
              cmdDel.execute;
              DisconnectObjAttr(3, string(ClientId:10:o), CategNumber, 0);
              ConnectObjAttr(err, 3, string(ClientId:10:o), CategNumber, 1);
   
              return 1;
   
            else
               Err = Check_Error_Response(ClientId);
               if (Err == 0 )
                  return 0;
               else
                  DisconnectObjAttr(3, string(ClientId:10:o), CategNumber, 0);
                  ConnectObjAttr(err, 3, string(ClientId:10:o), CategNumber, 2);
                  return 2;
               end;
            end;
      elif (AttrCode == 2)
         DisconnectObjAttr(3, string(ClientId:10:o), CategNumber, 0);
         Start_Quik_flow(ClientId);
      else
         load = Quik_User_Create(ClientId, 1);
         DisconnectObjAttr(3, string(ClientId:10:o), CategNumber, 0);
         ConnectObjAttr(err, 3, string(ClientId:10:o), CategNumber, 3);
         return (load);
       end;
   end;
   end;
end;