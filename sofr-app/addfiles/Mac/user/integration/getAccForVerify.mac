//А.Киселев 03.09.2018 Сервис получения данных по счетам для сверки 7.2.14.
//GetAccountForVerify
//!!!!!!!!!!!!Все восклицательные знаки должны быть обработанны в соответствии с текстом комментария и удалены

import likepy, oralib;

private const UNIVERSAL_ERROR_CODE:integer  = -3001;

private class TDateRange
 var DateIn   :date,
     DateOut  :date,
     BrancID  :string = "", // обязательное: Нет
     PersonalNumber :string = ""; // обязательное: Нет
end;

private class TAccount
 var Account :string = "",
     Value   :string = "";
end;


//параметры запроса из RS-Securities СОФР
private class TGetAccountForVerifyReq( DataSet :RsdRecordset )
 var ReqID :string = "", // обязательное: Нет
     DateRange :TDateRange = TDateRange(),
     AccountList :TArray = TArray();

 private macro ThrowException( Message :string, ErrorCode :integer)

  if(ErrorCode == null)
   RunError( Message, UNIVERSAL_ERROR_CODE );
  end;

  RunError( Message, ErrorCode );
 end;


 //заполнение входящего параметра-объекта
 private macro InitPropertyReq( DataSet :RsdRecordset )
 private var ErrMsg :string = "",
             i :integer = 0,
             AccObj :TAccount = TAccount();;


   ErrMsg = "В сервисе \"GetAccountForVerifyReq\" ";

   if( ( DataSet == null ) or ( not DataSet.MoveNext ) )
    ThrowException( ErrMsg + "не получен объект TGetAccountForVerifyReq" );
   else
    if( (ValType(DataSet.Value(0, Null, V_STRING)) != V_UNDEF) and (ValType(DataSet.Value(0, Null, V_STRING)) != 26) and (DataSet.Value(0, Null, V_STRING) != null) )
     ReqID = DataSet.Value(0, Null, V_STRING);
    end;
   end;

   if( (ValType(DataSet.Value(1, Null, V_DATE)) == V_UNDEF) or (ValType(DataSet.Value(1, Null, V_DATE)) == 26) or (DataSet.Value(1, Null, V_DATE) == null)
     or (DataSet.Value(1, Null, V_DATE) == date("00.00.00")) )
    ThrowException( ErrMsg + "не получен обязательный параметр \"DateIn\"" );
   elif( (ValType(DataSet.Value(2, Null, V_DATE)) == V_UNDEF) or (ValType(DataSet.Value(2, Null, V_DATE)) == 26) or (DataSet.Value(2, Null, V_DATE) == null) 
     or (DataSet.Value(2, Null, V_DATE) == date("00.00.00")) )
    ThrowException( ErrMsg + "не получен обязательный параметр \"DateIn\"" );
   else
    DateRange.DateIn = DataSet.Value(1, Null, V_DATE);
    DateRange.DateOut = DataSet.Value(2, Null, V_DATE);

    if( (ValType(DataSet.Value(3, Null, V_STRING)) != V_UNDEF) and (ValType(DataSet.Value(3, Null, V_STRING)) != 26) and (DataSet.Value(3, Null, V_STRING) != null) )
     DateRange.BrancID = DataSet.Value(3, Null, V_STRING);
    end;

    if( (ValType(DataSet.Value(4, Null, V_STRING)) != V_UNDEF) and (ValType(DataSet.Value(4, Null, V_STRING)) != 26) and (DataSet.Value(4, Null, V_STRING) != null) )
     DateRange.PersonalNumber = DataSet.Value(4, Null, V_STRING);
    end;

   end;


   i = 0;
   while( (i == 0) or (DataSet.MoveNext) )

    if( (ValType(DataSet.Value(5, Null, V_STRING)) != V_UNDEF) and (ValType(DataSet.Value(5, Null, V_STRING)) != 26) and (DataSet.Value(5, Null, V_STRING) != null) )
     AccObj.Account = DataSet.Value(5, Null, V_STRING);
    end;

    if( (ValType(DataSet.Value(6, Null, V_STRING)) == V_UNDEF) or (ValType(DataSet.Value(6, Null, V_STRING)) == 26) or (DataSet.Value(6, Null, V_STRING) == null) )
     ThrowException( ErrMsg + "не получен обязательный параметр \"Value\"" );
     AccObj = Null;
     Break;
    else
     AccObj.Value = DataSet.Value(6, Null, V_STRING);
    end;
    AccountList[i] = AccObj;
    AccObj = Null;

    i = i + 1;
   end;


 end;

 InitPropertyReq(DataSet) //конструктор

end;

//получим курсор из таблиц RS-Securities СОФР
private macro GetDataSetForAccVerify :RsdRecordset;

var Query :string = "",
    DataSet :RsdRecordset,
    Params :TArray;

 //запрос к буферным таблицам!!!!!!!!!!!!!!!!!!!!!!!! запрос тестовый
 Query = " SELECT 'LKHLH9869KLHK8768' AS T_REQID, TO_DATE('05092018', 'ddmmyyyy') AS T_DATEIN, TO_DATE('03092018', 'ddmmyyyy') AS T_DATEOUT, " +
         "  '' AS T_BRANCID, '' AS T_PERSONALNUMBER, T_ACCOUNT, 'BEBE0926' AS T_VALUE " +
         " FROM daccount_dbt " +
         " WHERE T_CHAPTER = :Ch " +
         "  AND T_CODE_CURRENCY = :Fiid " +
         "  AND T_ACCOUNT LIKE :AccMask";
 DataSet = Null;
 Params = Null;

 Params = makeArray( SQLParam("Ch", 1),
                     SQLParam("Fiid", 0),
                     SQLParam("AccMask", "40702%") );
 DataSet = execSQLselect( Query, Params );

 Params = Null;

 return DataSet;
end;
//получим курсор из таблиц RS-Securities СОФР


//процедура запроса данных по счетам для сверки вызов из RS-Secirities
macro GetAccountForVerifyReq( /*RequestObj :object*/ ) //входные данные заполненные буферные таблицы
var ResponseObj :object = TGetAccountForVerifyReq( GetDataSetForAccVerify );
  
// а здесь мы должны что-то куда-то положить или дернуть процедуру получения данных по счетам для сверки а параметры объект ResponseObj!!!!!!!!!!!!

 ResponseObj = Null;
 return true;

onError(err)

/*!!!!!!!!!!!!!!!обработка ошибок тоже не ясно
   out_code = c_err_obj.obtain_err_code(err);
   err_txt = c_err_obj.obtain_err_msg(err);

   resp_data_obj = c_outObj;
   resp_data_obj.ActiveContract_resp.ReqID = XmlRpcRequestId; 
   resp_data_obj.ActiveContract_resp.SenderId = req_data_obj.SenderID;
   resp_data_obj.ActiveContract_resp.Result.code = out_code;
   resp_data_obj.ActiveContract_resp.Result.text = err_txt;

   out_str = req_msg_obj.sec_internal_resp(resp_data_obj);
   return out_str;
*/

 return false;

end;
//процедура запроса данных по счетам для сверки вызов из RS-Secirities




GetAccountForVerifyReq( /*RequestObj :object*/ ); //!!!!!!!!!!!!!!!!это только для тестирования


/*
скрипты получения данных из LoadAccountForVerify таблиц RS-Securities СОФР


*/
