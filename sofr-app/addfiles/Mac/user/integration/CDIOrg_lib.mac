/** 
 @file CDIOrg_lib.mac
 @brief Общие классы и функции для обмена с CDI
  
 # tag 
 - functional_block:Клиенты_Регистрация_на_бирже
 - code_type:API
 - CDI

   
 # changeLog 
 |date       |author         |tasks            |note                                                         
 |-----------|---------------|-----------------|-------------------------------------------------------------------------------------------------------------
 |05.09.2023 |Гераськина Т.В.|BIQ-10268        | Создание
 |07.11.2023 |Гераськина Т.В.|DEF-55022        | Принимающая система не считает нужным полностью заполнять справочники (тип IntegrationDictionaryRecordXType)
 |           |               |DEF-55175        | Изменено название системы с SOFR на SOFR_UL
 |17.11.2023 |Гераськина Т.В.|DEF-56111        | Исправлено заполнение даты кода ОГРН, поиск по ОКОПФ, признак нерезидента, валюта уставного капитала
 |17.11.2023 |Гераськина Т.В.|DEF-55758        | Добавлена начальная инициализация параметрам Address
 |29.11.2023 |Гераськина Т.В.|DEF-55758        | Изменено формирование контактов, исправлен признак основного адреса, полное наименование ОКВЭД
 |           |               |DEF-56111        |  
 |04.12.2023 |Гераськина Т.В.|DEF-57210        | Отправка уведомлений в ОД по смене резидентности
 |11.12.2023 |Гераськина Т.В.|DEF-56111        | Установка одного из значений ОКВЭД как главного
 |11.12.2023 |Гераськина Т.В.|DEF-55758        | Наименование системы маленькими буквами
 |26.12.2023 |Гераськина Т.В.|DEF-59120        | Приведены в соответствие CdiCreate и CdiUpdate
 |17.01.2024 |Гераськина Т.В.|DEF-59855        | Создание события для CdiUpdate только в том случае, когда действительно что-то поменялось
 |02.02.2024 |Гераськина Т.В.|DEF-59849        | Обновление контактов

*/ 
import FiInter;
import func_lib;
import global_classes;

var NAME_SYSTEM = "sofr_ul"; //DEF-55758 теперь нижний регистр
var ADD_CNTT_WORKING = 1001; //DEF-59120 рабочая почта = 1001, а не 2 (CNTT_WORKING)

var PARTY_CATEGORY_OKFS = 27;
var PARTY_CATEGORY_OKOGU = 48;
var PARTY_CATEGORY_OKTMO = 55;
var PARTY_CATEGORY_OKATO = 12;
var PARTY_CATEGORY_OKOPF = 53;
var PARTY_CATEGORY_OKVED = 64;
var PARTY_CATEGORY_RESPONSIBILITY_ZONE = 116;
var PARTY_CATEGORY_BLOCK_UNLOAD_CDI = 175;

var PARTY_CATEGORY_BLOCK_UNLOAD_CDI_YES = 1;
var PARTY_CATEGORY_BLOCK_UNLOAD_CDI_NO = 2;

var ERROR_CODE_BLOCK_UNLOAD = 2000;
var ERROR_DESC_BLOCK_UNLOAD = "Субъект заблокирован для обмена с CDI";


/**
 @brief Класс описывающий ошибку от CDI
 
 Класс необходим для хранения ошибки CDI
*/
class c_ErrorDataCDI
  var ErrorCode:  string;
  var ErrorDesc:  string;
end;

class (c_ErrorDataCDI) c_ErrorDataCDI_ID
  var cdiID  = 0;
  Initc_ErrorDataCDI;
end;

private class c_ProcessParty()
   var IncomeData;
   var PartyId;
end;

class c_UpdateParty_needupdate
   var ErrorCode;
   var ErrorDesc;
   var NeedUpdate;
end;

var ProcessParty = c_ProcessParty;
var g_trn = false;
var g_res = c_UpdateParty_needupdate;
var g_need_update = false;


/** 
 @brief Проверка, установлена ли категория "Блокировать выгрузку в CDI" в значение "да"
 @param[in] _partyid ИД субъекта
 @return true - не подлежит выгрузке / false - подлежит выгрузке
 
 Считается, что если категория не установлена, то выгрузка должна производиться
*/
macro CheckBlockUnloadCDI(_partyid)
   var ObjID = String(_partyid:o:10); 
   var ObjCat = RsbObjCategories( OBJTYPE_PARTY, ObjID);
   
   var IsAttr = ObjCat.IsAttrPresense(PARTY_CATEGORY_BLOCK_UNLOAD_CDI, PARTY_CATEGORY_BLOCK_UNLOAD_CDI_YES, null, null, true, date());
   return IsAttr;
end;


/**
 @brief Поиск значения категории без пробелов. Хранится с пробелами, от CDI приходит без пробелов
 @param[in] _value Значение категории с пробелами
 @param[in] _num_group Номер категории
 @return Найденное соответствующее значение NumInList, если не найдено возвращает ""
*/
private macro NormalizeOKOPF(_value, _num_group)
  var sql_str, cmd, rs;
  var res = "";
  sql_str = "select t_numinlist "+
            "  from dobjattr_dbt "+
            " where t_objecttype = :objtype "+
            "   and t_groupid = :groupid "+
            "   and replace(t_numinlist, ' ','') = :val";
  cmd = RSDCommand(sql_str);
  cmd.AddParam("objtype", RSDBP_IN, OBJTYPE_PARTY);
  cmd.AddParam("groupid", RSDBP_IN, _num_group);
  cmd.AddParam("val", RSDBP_IN, _value);
  rs = RSDRecordSet(cmd);
  if (rs.movenext)
     res = rs.value(0);
  end;
  return res;
end;

/**
 @brief Поиск attrid для значения категории по его numlist
 @param[in] _objtype Тип объекта
 @param[in] _objgroup Номер категории
 @param[in] _objnumlist Значение (NumInList)
 @return Найденный attrid, если не найдено возвращает 0
*/
private macro FindAttrByValue(_objtype, _objgroup, _objnumlist)
  var sql_str, cmd, rs;
  var res = 0;
  sql_str = "select t_attrid "+
            "  from dobjattr_dbt "+
            " where t_objecttype = :objtype "+
            "   and t_groupid = :groupid "+
            "   and t_numinlist = :val";
  cmd = RSDCommand(sql_str);
  cmd.AddParam("objtype", RSDBP_IN, _objtype);
  cmd.AddParam("groupid", RSDBP_IN, _objgroup);
  cmd.AddParam("val", RSDBP_IN, _objnumlist);
  rs = RSDRecordSet(cmd);
  if (rs.movenext)
     res = rs.value(0);
  end;
  return res;

end;

private macro UpdateCodeDate(_partyid, _CodeKind, _FromDate)
  var sql_str, cmd;
  sql_str = "update dobjcode_dbt "+
            "  set t_bankdate = :bankdate "+
            " where t_objecttype = :objtype "+
            "   and t_objectid = :objectid "+
            "   and t_codekind = :codekind ";
  cmd = RSDCommand(sql_str);
  cmd.AddParam("bankdate", RSDBP_IN, _FromDate);
  cmd.AddParam("objtype", RSDBP_IN, OBJTYPE_PARTY);
  cmd.AddParam("objectid", RSDBP_IN, _partyid);
  cmd.AddParam("codekind", RSDBP_IN, _CodeKind);
  cmd.execute; // если будет ошибка уникального индекса, так тому и быть
end;

/**
 @brief Разбор класса типа "Справочник" (IntegrationDictionaryRecordXType)
 @param[in] _obj Объект XMLRPC
 @param[in] _nameproperty Наименование свойства
 @param[in] _nametag Наименование вышестоящего тега (для формирования тега ошибки)
 @param[in] _isrequired Признак обяхательного поля
 
 Аналог метода из func_lib. Но CDI считает, что RecordCode можно ничем не заполнять
*/
macro getDictionaryFromProperty_cdi (_obj, _nameproperty, _nametag, _isrequired)
   var res: c_IntegrationDictionaryRecordXType;
   var vnametag = _nametag+"."+_nameproperty;
   var err_txt;
   var aux_buff;

   aux_buff = uTryToGetPropS(_obj, _nameproperty);
   if(ValType(aux_buff) == V_UNDEF)
      if (_isrequired)
         err_txt = ERR_TEXT_NO_IN_MSG +": "+vnametag;
         RunError(err_txt, c_err_obj(err_txt,ERR_CODE_NO_REQUIRED_PRM));
      end;
   else
      res = c_IntegrationDictionaryRecordXType;
      res.RecordCode     = getValueFromProperty(aux_buff, "RecordCode"      , vnametag);
      if (Valtype(res.RecordCode) == V_UNDEF)
         res.RecordCode = "";
      end;
      res.RecordTitle    = getValueFromProperty(aux_buff, "RecordTitle"     , vnametag);
      res.Note           = getValueFromProperty(aux_buff, "Note"            , vnametag);
      res.SystemId       = getValueFromProperty(aux_buff, "SystemId"        , vnametag);
      res.SystemNodeId   = getValueFromProperty(aux_buff, "SystemNodeId"    , vnametag);
      res.Desc           = getValueFromProperty(aux_buff, "Desc"            , vnametag);
      res.DictionaryCode = getValueFromProperty(aux_buff, "DictionaryCode"  , vnametag);
   end;
      
   return res;
end;


/* Коды субъекта */
class c_PartyCode
  var CodeKind : integer; /* Вид кода субъекта экономики */
  var Code : string; /* Код */
  var FromDate : date; /* Дата начала действия. */
end;


/* Контакты субъекта */
class c_PartyContact
  var ContactKind : integer; // Вид способа связи
  var ContactType : string; // Тип способа связи
  var AddressType : integer; // Тип адреса
  var Value : string;   // Значение способа связи
  var IsMain : bool;
  var RecId : integer;
  var Cdi_id;
end;

/* Категории */
class c_PartyCategory
   var GroupID;
   var AttrID;
   var Value;
end;

/* Уставной капитал */
class c_AuthorizedCapital_FOR_CDI(IncomeData)
   var Value      ;              // Значение уставного капитала   Да
   var Currency   ;              // Валюта уставного капитала     Нет   Справочник
end;


/* Информация ПОД/ФТ */
class c_PODFTInformation(IncomeData)
   var PODFTFormCreateDate : date;     // Дата формирования анкеты по ПОД/ФТ  Нет
   var PODFTFormUpdateDate : date;     // Дата обновления анкеты по ПОД/ФТ    Нет
   var FATCAStatusDate     : date;     // Дата статуса FATCA                  Нет
   var CRSStatusDate       : date;     // Дата статуса CRS                    Нет
   var FATCAStatus      ;              // Статус FATCA                        Нет      Справочник
   var CRSStatus        ;              // Статус CRS                          Нет      Справочник
end;

private class c_SourceSystemPartyInformation()
   var SourceSystemCode     ;              // Система источник                                Да   Справочник
   var SourceSystemPartyId  ;              // Идентификатор субъекта в системе источнике      Да   Идентификатор
end;

private class c_SourceSystemInformation()
   var SourceSystemCode     ;              // Система источник                                Да   Справочник
   var SourceSystemId       ;              // Идентификатор субъекта в системе источнике      Да   Идентификатор
end;

macro FillSourceSystemInformation(IncomeData, nametag_up)
   var aux_buff2, ai;
   var res = TArray;
   res.size = 0;
   var temp_value;
   var err_txt;
   
   // список 
   aux_buff2 = uTryToGetPropS(IncomeData, "SourceSystemInformationList");
   if(ValType(aux_buff2) == V_GENOBJ)
      ai = 0;
SetDialogFlag(0);
      while(aux_buff2.size > ai)
         temp_value = c_SourceSystemInformation();
         temp_value.SourceSystemCode  = getDictionaryFromProperty (aux_buff2(ai), "SourceSystemCode" , nametag_up+".SourceSystemInformationList", true);
         temp_value.SourceSystemId  = getSymbolFromProperty(aux_buff2(ai), "SourceSystemId", nametag_up+".SourceSystemInformationList");
         
         res.value(ai) = temp_value;
         ai = ai + 1;
         temp_value = NULL;
      end;
      aux_buff2 = NULL;
SetDialogFlag(1);
   elif(ValType(aux_buff2) == V_UNDEF)
      err_txt = string(InErrComPart, nametag_up+".SourceSystemInformationList");
      RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
   else
      err_txt = string(InErrNotObj, nametag_up+".SourceSystemInformationList");
      RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
   end;
   
   return res;
end;


/* Субъект */
class c_Party_FOR_CDI(IncomeData)
   var IsActive                     : bool;     // Признак активности записи                       Да 
   var LastUpdateDate               : datetime; // Дата и время последнего изменения записи        Да 
   var IsVip                        : bool;     // Признак вип-клиента                             Нет 
   var ShortNameOrg                 : string;   // Краткое наименование                            Нет 
   var FullNameOrg                  : string;   // Полное наименование                             Нет 
   var ShortNameOrgLat              : string;   // Краткое латинское наименование                  Нет 
   var FullNameOrgLat               : string;   // Полное латинское наименование                   Нет 
   var IsResidentCurrency           : bool;     // Признак резидента по валютному законодательству Нет 
   var IsResidentTax                : bool;     // Признак налогового резидента                    Нет 
   var IsProblemFactor              : bool;     // Есть ФП (фактор проблемности)                   Нет 
   var IsEssentialProblemFactor     : bool;     // Есть СФП (существенный фактор проблемности)     Нет 
   var IsDealProblemFactor          : bool;     // Есть ФПЗ (фактор проблемной задолженности)      Нет 
   var IsProblem                    : bool;     // Признак проблемного                             Нет 
   var EmployeesCount               : string;   // Численность работников                          Нет 
   var INN                          : string;   // ИНН                                             Нет 
   var KPPRegistrationPlace         : string;   // КПП по месту регистрации                        Нет 
   var KPPMajorTaxpayer             : string;   // КПП крупнейшего налогоплательщика               Нет 
   var OGRN                         : string;   // ОГРН/ОГРНИП                                     Нет 
   var KIO                          : string;   // КИО                                             Нет 
   var OKPO                         : string;   // ОКПО                                            Нет 
   var RegistrationDate             : date;     // Дата регистрации (до ОГРН/ОГРНИП)               Нет 
   var CmoLiquidationDate           : date;     // Дата ликвидации                                 Нет 
   var RegistrationNumber           : string;   // Регистрационный номер (до ОГРН/ОГРНИП)          Нет 
   var OGRNRegistrationDate         : date;     // Дата регистрации ОГРН                           Нет 
   var FLChPRegistrationNumber      : string;   // Регистрационный номер ФЛЧП                      Нет 
   var FLChPRegistrationDate        : date;     // Дата регистрации ФЛЧП                           Нет 
   var FLChPRegistrationStructure   : string;   // Регистрирующий орган ФЛЧП                       Нет 
   var NonResidentRegistrationNumber: string;   // Регистрационный номер нерезидента               Нет 
   var NonResidentRegistrationDate  : date;     // Дата регистрации нерезидента                    Нет 
   var IsStrategicOrg               : bool;     // Признак стратегического общества                Нет 
   var IsGozOrg                     : bool;     // Признак клиент ГОЗ                              Нет 
   var IsSelfRegulating             : bool;     // Признак СРО (саморегулируемой организации)      Нет 
   var IsApkExporter                : bool;     // Признак экспортер АПК (агропромышленного комплекса)      Нет 
   var IsVedMember                  : bool;     // Признак участник ВЭД (внешнеэкономической деятельности)  Нет 
   var IsExporter                   : bool;     // Признак экспортера                              Нет 
   var IsImporter                   : bool;     // Признак импортера                               Нет 
   var IsMfh                        : bool;     // Признак МФХ (малой формы хозяйствования)        Нет 
   var CreditHistory                : string;   // Код субъекта кредитной истории                  Нет 
   var IsSavingAccount              : bool;     // Признак наличия категории накопительный счет    Нет 
   var SourceSystemPartyInformationList;        // Список информации по субъекту по системам источникам Да
   var PartyId                   ;              // Идентификатор субъекта в CDI                    Да   Идентификатор
   var PartyType                 ;              // Тип субъекта                                    Нет  Справочник
   var PartyStatus               ;              // Статус субъекта                                 Нет  Справочник
   var OrgType                   ;              // Вид предприятия                                 Нет  Справочник
   var FinalSegment              ;              // Итоговый сегмент                                Нет  Справочник
   var GksSegment                ;              // Сегмент по ГКС                                  Нет  Справочник
   var IndividualSegment         ;              // Индивидуальный сегмент                          Нет  Справочник
   var ResponsibilityZone        ;              // Зона ответственности бизнес-ССП ГО              Нет  Справочник
   var SeparatedSubjects         ;              // Отдельные субъекты хозяйствования               Нет  Справочник
   var AffiliationToProjectsOrg  ;              // Принадлежность к проектным компаниям            Нет  Справочник
   var SmallMiddleOrg            ;              // Реестр субъектов малого и среднего предпринимательства    Нет Справочник
   var ResponsibleService        ;              // Ответственная служба                            Нет  Справочник
   var OKFS                      ;              // ОКФС                                            Нет  Справочник
   var OKOGU                     ;              // ОКОГУ                                           Нет  Справочник
   var OKTMO                     ;              // ОКТМО                                           Нет  Справочник
   var OKATO                     ;              // ОКАТО                                           Нет  Справочник
   var OKOPF                     ;              // ОКОПФ                                           Нет  Справочник
   var DiasoftCategory           ;              // Категория Диасофт                               Нет  Справочник
   var ResidenceCountry          ;              // Юрисдикция                                      Нет  Справочник
   var AuthorizedCapital         ;              // Уставной капитал                                Нет 
   var PODFTInformation          ;              // Информация ПОД/ФТ                               Нет 
   var MainSolveOption           ;              // Основной вариант урегулирования                 Нет  Справочник
end;

private class c_General_Link()
   var IsActive            :bool;      // Признак активности записи                    Да
   var LastUpdateDate      :datetime;  // Дата и время последнего изменения записи     Да
   var SourceSystemInformationList;
   var PartyId             ;           // Идентификатор субъекта в CDI                 Да    Идентификатор
end;


/* Связь субъект-подразделение */
private class (c_General_Link) c_RelBranchToParty
   Initc_General_Link;
   var RelBranchToPartyId  ;           // Идентификатор в CDI                          Да    Идентификатор
   var BranchCode          ;           // Код подразделения                            Да    Справочник
end;


/* Связь субъект-группа */
private class (c_General_Link) c_RelGroup()
   Initc_General_Link;
   var ValidFrom     : datetime;    // Дата и время начала действия связи        Нет
   var ValidTo       : datetime;    // Дата и время окончания действия связи     Нет
   var RelGroupId       ;           // Идентификатор в CDI                       Да    Идентификатор
   var GroupCode        ;           // Группа                                    Да    Справочник
end;


/* Связь субъект-ОКВЭД */
class (c_General_Link) c_RelOkved_FOR_CDI()
   Initc_General_Link;
   var IsMainOkved   : bool;        // Признак основного ОКВЭД          Нет
   var ValidFrom     : datetime;    // Дата и время начала действия     Нет
   var ValidTo       : datetime;    // Дата и время окончания действия  Нет
   var RelOkvedId    ;              // Идентификатор в CDI                       Да    Идентификатор
   var OKVEDCode     ;              // ОКВЭД                                     Да    Справочник
end;


/* Связь субъект-лицензия */
private class (c_General_Link) c_RelLicense()
   Initc_General_Link;
   var LicenseNumber       : string;   // Номер лицензии             Нет
   var LicenseDescription  : string;   // Описание лицензии          Нет
   var LicensesIssuedBy    : string;   // Орган, выдавший лицензию   Нет
   var LicenseStartDate    : date;     // Дата выдачи лицензии       Нет
   var LicenseEndDate      : date;     // Дата отзыва лицензии       Нет
   var RelLicenseId     ;              // Идентификатор в CDI                       Да    Идентификатор
   var LicenseCode      ;              // Вид лицензии                              Да    Справочник
end;


/* Характер отношений с Банком */
private class (c_General_Link) c_BankRel()
   Initc_General_Link;
   var BankRelId        ;           // Идентификатор в CDI                       Да    Идентификатор
   var BankRelCode      ;           // Вид отношений субъекта с Банком           Да    Справочник
end;


/* Контакт */
private class (c_General_Link) c_Contact()
   Initc_General_Link;
   var ContactValue  : string;   // Значение контакта                         Да
   var Description   : string;   // Комментарий                               Нет
   var IsMainContact : bool;     // Признак основного контакта                Нет
   var IsActiveContact: bool;    // Признак действующего                      Нет
   var Status        : string;   // Статус                                    Нет
   var ContactId	      ;        // Идентификатор в CDI                       Да    Идентификатор
   var ContactType      ;        // Тип контакта                              Нет   Справочник
   var ContactDetailType;        // Тип контакта (детально)                   Нет   Справочник
end;


/* Адрес */
private class (c_General_Link) c_Address()
   Initc_General_Link;
   var AddressLine   :string;    // Строка адреса              Нет
   var PostalCode    :string;    // Почтовый индекс            Нет
   var RegionName    :string;    // Регион                     Нет
   var AreaName      :string;    // Район                      Нет
   var CityName      :string;    // Город                      Нет
   var PlaceName     :string;    // Населенный пункт           Нет
   var StructureName :string;    // Наименование структуры     Нет
   var StreetName    :string;    // Улица                      Нет
   var House         :string;    // Номер дома                 Нет
   var Hcase         :string;    // Корпус дома                Нет
   var Block         :string;    // Строение дома              Нет
   var Liter         :string;    // Литер дома                 Нет
   var Flat          :string;    // Квартира/офис              Нет
   var IsMainAddress :bool;      // Признак основного адреса   Нет
   var OKTMO         :string;    // ОКТМО                      Нет
   var FiasGuid      :string;    // Гуид ФИАС                  Нет
   var KladrId       :string;    // Код КЛАДР                  Нет
   var Description   :string;    // Комментарий                Нет
   var AddressId        ;        // Идентификатор в CDI        Да    Идентификатор
   var AddressType      ;        // Тип адреса                 Нет   Справочник
   var Country          ;        // Страна                     Нет   Справочник
   var RegionType       ;        // Тип региона                Нет   Справочник
   var AreaType         ;        // Тип района                 Нет   Справочник
   var CityType         ;        // Тип города                 Нет   Справочник
   var PlaceType        ;        // Тип населенного пункта     Нет   Справочник
   var StructureType    ;        // Тип структуры              Нет   Справочник
   var StreetType       ;        // Тип улицы                  Нет   Справочник
end;

/* Адрес */
private class c_Address_UpdateOrg()
   var AddressLine   : string    = "";    // Строка адреса              Нет
   var PostalCode    : string    = "";    // Почтовый индекс            Нет
   var RegionName    : string    = "";    // Регион                     Нет
   var AreaName      : string    = "";    // Район                      Нет
   var CityName      : string    = "";    // Город                      Нет
   var PlaceName     : string    = "";    // Населенный пункт           Нет
   var StructureName : string    = "";    // Наименование структуры     Нет
   var StreetName    : string    = "";    // Улица                      Нет
   var House         : string    = "";    // Номер дома                 Нет
   var Hcase         : string    = "";    // Корпус дома                Нет
   var Block         : string    = "";    // Строение дома              Нет
   var Liter         : string    = "NULL";    // Литер дома                 Нет
   var Flat          : string    = "";    // Квартира/офис              Нет
   var MainAddress   : string    = "NULL";    // Признак основного адреса   Нет
   var OKTMO         : string    = "";    // ОКТМО                      Нет
   var FiasGuid      : string    = "";    // Гуид ФИАС                  Нет
   var KladrId       : string    = "";    // Код КЛАДР                  Нет
   var Description   : string    = "";    // Комментарий                Нет
   var Active        : string    = "YES";
   var LastUpdateDate :datetime = dttm(date(),time());
   var SourceSystemCode;
   var SourceSystemId;
   var PartyId          ;
   var AddressType      = c_IntegrDictRec;        // Тип адреса                 Нет   Справочник
   AddressType.RecordCode = "";
   var Country          = c_IntegrDictRec;        // Страна                     Нет   Справочник
   Country.RecordCode = "";
   var RegionType       = c_IntegrDictRec;        // Тип региона                Нет   Справочник
   RegionType.RecordCode = "";
   var AreaType         = c_IntegrDictRec;        // Тип района                 Нет   Справочник
   AreaType.RecordCode = "";
   var CityType         = c_IntegrDictRec;        // Тип города                 Нет   Справочник
   CityType.RecordCode = "";
   var PlaceType        = c_IntegrDictRec;        // Тип населенного пункта     Нет   Справочник
   PlaceType.RecordCode = "";
   var StructureType    = c_IntegrDictRec;        // Тип структуры              Нет   Справочник
   StructureType.RecordCode = "";
   var StreetType       = c_IntegrDictRec;        // Тип улицы                  Нет   Справочник
   StreetType.RecordCode = "";
   var AddressId        = c_IntegrSymId;        // Идентификатор в CDI        Да    Идентификатор
   AddressId.ObjectId = "NULL";
   var SourceSystemPartyId;
end;

/**
 @brief Класс соответствующий типу данных Адрес
 @note Заполнен специальными значениями
*/
class c_Address_CDI()
   var AddressLine                  : string   = "";   // Строка адреса
   var PostalCode                   : string   = "";   // Почтовый индекс
   var RegionName                   : string   = "";   // Регион
   var AreaName                     : string   = "";   // Район
   var CityName                     : string   = "";   // Город
   var PlaceName                    : string   = "";   // Населенный пункт
   var StructureName                : string   = "";   // Наименование структуры
   var StreetName                   : string   = "";   // Улица
   var House                        : string   = "";   // Номер дома
   var Hcase                        : string   = "";   // Корпус дома
   var Block                        : string   = "";   // Строение дома
   var Liter                        : string   = "NULL";   // Литер дома
   var Flat                         : string   = "";   // Квартира/офис
   var MainAddress                  : string   = "NULL";   // Признак основного адреса
   var OKTMO                        : string   = "";   // ОКТМО
   var FiasGuid                     : string   = "";   // Гуид ФИАС
   var KladrId                      : string   = "";   // Код КЛАДР
   var Description                  : string   = "";   // Комментарий
   var Active                       : string   = "";   // Признак активности записи
   var LastUpdateDate               : datetime = dttm(date(),time()); // Дата и время последнего изменения запис
   var SourceSystemCode             : c_IntegrDictRec;   //Система источник
   var SourceSystemPartyId          : c_IntegrSymId; //Идентификатор субъекта в системе источнике
   var AddressType      = c_IntegrDictRec;        // Тип адреса                 Нет   Справочник
   AddressType.RecordCode = "";
   var Country          = c_IntegrDictRec;        // Страна                     Нет   Справочник
   Country.RecordCode = "";
   var RegionType       = c_IntegrDictRec;        // Тип региона                Нет   Справочник
   RegionType.RecordCode = "";
   var AreaType         = c_IntegrDictRec;        // Тип района                 Нет   Справочник
   AreaType.RecordCode = "";
   var CityType         = c_IntegrDictRec;        // Тип города                 Нет   Справочник
   CityType.RecordCode = "";
   var PlaceType        = c_IntegrDictRec;        // Тип населенного пункта     Нет   Справочник
   PlaceType.RecordCode = "";
   var StructureType    = c_IntegrDictRec;        // Тип структуры              Нет   Справочник
   StructureType.RecordCode = "";
   var StreetType       = c_IntegrDictRec;        // Тип улицы                  Нет   Справочник
   StreetType.RecordCode = "";
   var SourceSystemId               : c_IntegrSymId; //Идентификатор в системе источнике
end;


/* Проверки */
private class (c_General_Link) c_Verification()
   Initc_General_Link;
   var CheckDate     : date;     // Дата проверки                             Нет
   var CheckVal      : string;   // Результат проверки                        Нет
   var VerificationId   ;        // Идентификатор в CDI                       Да    Идентификатор
   var CheckCode        ;        // Вид проверки                              Да   Справочник
end;


/* Состояния и стадии */
private class (c_General_Link) c_State()
   Initc_General_Link;
   var ReorganizationDate  : date;     // Дата реорганизации                        Нет
   var StartDate           : date;     // Дата начала действия стадии               Нет
   var EndDate             : date;     // Дата окончания действия стадии            Нет
   var StateId          ;              // Идентификатор в CDI                       Да    Идентификатор
   var StateCode        ;              // Вид стадии или ограничения                Да    Справочник
end;


/* Состояния и стадии */
private class c_State_Publish()
   var ReorganizationDate  : datetime; // Дата реорганизации                        Нет
   var StartDate           : date;     // Дата начала действия стадии               Нет
   var EndDate             : date;     // Дата окончания действия стадии            Нет
   var IsActive            :date;      // Признак активности записи                 Да
   var LastUpdateDate      :datetime;  // Дата и время последнего изменения записи  Да
   var SourceSystemInformationList;
   var StateId          ;              // Идентификатор в CDI                       Да    Идентификатор
   var PartyId          ;              // Идентификатор субъекта в CDI              Да    Идентификатор
   var StateCode        ;              // Вид стадии или ограничения                Да    Справочник
end;


/* Кросс-ссылка */
class c_ExtId_FOR_CDI()
   var IsActive            : bool;     // Признак активности записи                 Да
   var LastUpdateDate      : datetime; // Дата и время последнего изменения записи  Да
   var IsExtIdActive       : bool;     // Признак активной                          Нет
   var StartDate           : datetime; // Дата начала действия кросс-ссылки         Нет
   var EndDate             : datetime; // Дата окончания действия кросс-ссылки      Нет
   var ExtIdSourceSystemName  :string; // Наименование системы источника            Нет
   var ExtIdId             ;           // Идентификатор в CDI                       Да    Идентификатор
   var ExtIdPartyId        ;           // Идентификатор субъекта в CDI              Да    Идентификатор
   var ExtIdPartySourceId  ;           // Идентификатор субъекта в источнике        Да    Идентификатор
   var ExtIdSourceSystem   ;           // Код системы источника                     Да    Справочник
   var SourceSystemInformationList;
end;


/* Связанные лица */
private class c_RelPartyToParty()
   var ValidFrom              : datetime; // Дата и время начала действия связи     Нет
   var ValidTo                : datetime; // Дата и время окончания действия связи  Нет
   var BaseDocumentNumber     : string;   // Номер документа основания              Нет
   var AuthorizedCapitalShare : string;   // Доля в уставном капитале               Нет
   var PartyId          ;                 // Идентификатор субъекта в CDI           Да    Идентификатор
   var RelatedPartyId   ;                 // Идентификатор связанного лица в CDI    Да    Идентификатор
   var RelatedPartyCFTId;                 // Идентификатор связанного лица в ЦФТ    Нет   Идентификатор
   var PartyRelationType;                 // Вид связи                              Да    Справочник
   var BaseDocumentType ;                 // Вид документа основания                Нет   Справочник
   var SourceSystemInformationList;       // Информация по системам источникам      Да
   var RelPartyToPartyId;                 // Идентификатор в CDI                    Да    Идентификатор
end;


/* Блок ответа сервиса получения карточки организации по идентификатору */
class adp_CdiGetOrg(IncomeData, _nametag_up)
   var Party;                 // Субъект                                   Контейнер   Нет
   var RelBranchToPartyList;  // Список связей субъект-подразделение       Контейнер   Нет
   var RelGroupList;          // Список связи субъектов и группы компаний  Контейнер   Нет
   var RelOkvedList;          // Список связи субъектов и ОКВЭД            Контейнер   Нет
   var RelLicenseList;        // Список связи субъектов и лицензий         Контейнер   Нет
   var BankRelList;           // Список характеры отношений с Банком       Контейнер   Нет
   var ContactList;           // Список контактов                          Контейнер   Нет
   var AddressList;           // Список адресов                            Контейнер   Нет
   var VerificationList;      // Список проверок                           Контейнер   Нет
   var StateList;             // Список состояний и стадий                 Контейнер   Нет
   var ExtIdList;             // Список кросс-ссылок                       Контейнер   Нет
   var RelPartyToPartyList;   // Список связанных лиц                      Контейнер   Нет
   
   
   /* Кратность параметров в соответствии со схемой/спецификацией */
   private macro uInitPrime(IncomeData, _nametag_up)
      var err_txt;
      var aux_buff, aux_buff2, ai;
      var temp_value, temp_variant;
            
      var nametag_up = _nametag_up;
      var nametag_up2;
      
      var UseAnotherState;
      if (Index (StrUpr(_nametag_up), StrUpr("CdiPublishOrg")) > 0 )
         UseAnotherState = true;
      else 
         UseAnotherState = false;
      end;
      
      if(ValType(IncomeData) != V_UNDEF)
         aux_buff = uTryToGetPropS(IncomeData, "Party");
         if(ValType(aux_buff) == V_GENOBJ)
            nametag_up2 = nametag_up + ".Party";
            Party = c_Party_FOR_CDI();
            Party.IsActive                      = getValueFromProperty(aux_buff, "IsActive"                    , nametag_up2, true);
            Party.LastUpdateDate                = getValueFromProperty(aux_buff, "LastUpdateDate"              , nametag_up2, true);
            Party.IsVip                         = getValueFromProperty(aux_buff, "IsVip"                       , nametag_up2);
            Party.ShortNameOrg                  = getValueFromProperty(aux_buff, "ShortNameOrg"                , nametag_up2);
            Party.FullNameOrg                   = getValueFromProperty(aux_buff, "FullNameOrg"                 , nametag_up2);
            Party.ShortNameOrgLat               = getValueFromProperty(aux_buff, "ShortNameOrgLat"             , nametag_up2);
            Party.FullNameOrgLat                = getValueFromProperty(aux_buff, "FullNameOrgLat"              , nametag_up2);
            Party.IsResidentCurrency            = getValueFromProperty(aux_buff, "IsResidentCurrency"          , nametag_up2);
            Party.IsResidentTax                 = getValueFromProperty(aux_buff, "IsResidentTax"               , nametag_up2);
            Party.IsProblemFactor               = getValueFromProperty(aux_buff, "IsProblemFactor"             , nametag_up2);
            Party.IsEssentialProblemFactor      = getValueFromProperty(aux_buff, "IsEssentialProblemFactor"    , nametag_up2);
            Party.IsDealProblemFactor           = getValueFromProperty(aux_buff, "IsDealProblemFactor"         , nametag_up2);
            Party.IsProblem                     = getValueFromProperty(aux_buff, "IsProblem"                   , nametag_up2);
            Party.EmployeesCount                = getValueFromProperty(aux_buff, "EmployeesCount"              , nametag_up2);
            Party.INN                           = getValueFromProperty(aux_buff, "INN"                         , nametag_up2);
            Party.KPPRegistrationPlace          = getValueFromProperty(aux_buff, "KPPRegistrationPlace"        , nametag_up2);
            Party.KPPMajorTaxpayer              = getValueFromProperty(aux_buff, "KPPMajorTaxpayer"            , nametag_up2);
            Party.OGRN                          = getValueFromProperty(aux_buff, "OGRN"                        , nametag_up2);
            //Party.KIO                           = getValueFromProperty(aux_buff, "KIO"                         , nametag_up2);
            Party.OKPO                          = getValueFromProperty(aux_buff, "OKPO"                        , nametag_up2);
            Party.RegistrationDate              = getValueFromProperty(aux_buff, "RegistrationDate"            , nametag_up2);
            Party.CmoLiquidationDate            = getValueFromProperty(aux_buff, "CmoLiquidationDate"          , nametag_up2);
            Party.RegistrationNumber            = getValueFromProperty(aux_buff, "RegistrationNumber"          , nametag_up2);
            //Party.OGRNRegistrationDate          = getValueFromProperty(aux_buff, "OGRNRegistrationDate"        , nametag_up2);
            Party.FLChPRegistrationNumber       = getValueFromProperty(aux_buff, "FLChPRegistrationNumber"     , nametag_up2);
            Party.FLChPRegistrationDate         = getValueFromProperty(aux_buff, "FLChPRegistrationDate"       , nametag_up2);
            Party.FLChPRegistrationStructure    = getValueFromProperty(aux_buff, "FLChPRegistrationStructure"  , nametag_up2);
            Party.NonResidentRegistrationNumber = getValueFromProperty(aux_buff, "NonResidentRegistrationNumber", nametag_up2);
            //Party.NonResidentRegistrationDate   = getValueFromProperty(aux_buff, "NonResidentRegistrationDate" , nametag_up2);
            Party.IsStrategicOrg                = getValueFromProperty(aux_buff, "IsStrategicOrg"              , nametag_up2);
            Party.IsGozOrg                      = getValueFromProperty(aux_buff, "IsGozOrg"                    , nametag_up2);
            Party.IsSelfRegulating              = getValueFromProperty(aux_buff, "IsSelfRegulating"            , nametag_up2);
            Party.IsApkExporter                 = getValueFromProperty(aux_buff, "IsApkExporter"               , nametag_up2);
            Party.IsVedMember                   = getValueFromProperty(aux_buff, "IsVedMember"                 , nametag_up2);
            Party.IsExporter                    = getValueFromProperty(aux_buff, "IsExporter"                  , nametag_up2);
            Party.IsImporter                    = getValueFromProperty(aux_buff, "IsImporter"                  , nametag_up2);
            Party.IsMfh                         = getValueFromProperty(aux_buff, "IsMfh"                       , nametag_up2);
            Party.CreditHistory                 = getValueFromProperty(aux_buff, "CreditHistory"               , nametag_up2);
            Party.IsSavingAccount               = getValueFromProperty(aux_buff, "IsSavingAccount"             , nametag_up2);
            
            // идентификаторы
            Party.PartyId              = getSymbolFromProperty(aux_buff, "PartyId"              , nametag_up2, true);
            
            // справочники
            Party.PartyType                  = getDictionaryFromProperty_cdi (aux_buff, "PartyType"                , nametag_up2);
            Party.PartyStatus                = getDictionaryFromProperty_cdi (aux_buff, "PartyStatus"              , nametag_up2);
            Party.OrgType                    = getDictionaryFromProperty_cdi (aux_buff, "OrgType"                  , nametag_up2);
            Party.FinalSegment               = getDictionaryFromProperty_cdi (aux_buff, "FinalSegment"             , nametag_up2);
            Party.GksSegment                 = getDictionaryFromProperty_cdi (aux_buff, "GksSegment"               , nametag_up2);
            Party.IndividualSegment          = getDictionaryFromProperty_cdi (aux_buff, "IndividualSegment"        , nametag_up2);
            Party.ResponsibilityZone         = getDictionaryFromProperty_cdi (aux_buff, "ResponsibilityZone"       , nametag_up2);
            Party.SeparatedSubjects          = getDictionaryFromProperty_cdi (aux_buff, "SeparatedSubjects"        , nametag_up2);
            Party.AffiliationToProjectsOrg   = getDictionaryFromProperty_cdi (aux_buff, "AffiliationToProjectsOrg" , nametag_up2);
            Party.SmallMiddleOrg             = getDictionaryFromProperty_cdi (aux_buff, "SmallMiddleOrg"           , nametag_up2);
            Party.ResponsibleService         = getDictionaryFromProperty_cdi (aux_buff, "ResponsibleService"       , nametag_up2);
            Party.OKFS                       = getDictionaryFromProperty_cdi (aux_buff, "OKFS"                     , nametag_up2);
            Party.OKOGU                      = getDictionaryFromProperty_cdi (aux_buff, "OKOGU"                    , nametag_up2);
            Party.OKTMO                      = getDictionaryFromProperty_cdi (aux_buff, "OKTMO"                    , nametag_up2);
            Party.OKATO                      = getDictionaryFromProperty_cdi (aux_buff, "OKATO"                    , nametag_up2);
            Party.OKOPF                      = getDictionaryFromProperty_cdi (aux_buff, "OKOPF"                    , nametag_up2);
            Party.DiasoftCategory            = getDictionaryFromProperty_cdi (aux_buff, "DiasoftCategory"          , nametag_up2);
            Party.ResidenceCountry           = getDictionaryFromProperty_cdi (aux_buff, "ResidenceCountry"         , nametag_up2);
            Party.MainSolveOption            = getDictionaryFromProperty_cdi (aux_buff, "MainSolveOption"          , nametag_up2);
            
            // контейнеры
            aux_buff2 = uTryToGetPropS(aux_buff, "AuthorizedCapital");
            if(ValType(aux_buff2) == V_GENOBJ)
               Party.AuthorizedCapital = c_AuthorizedCapital_FOR_CDI();
               Party.AuthorizedCapital.Value    = getValueFromProperty     (aux_buff2, "Value"     , nametag_up2+".AuthorizedCapital", true);
               Party.AuthorizedCapital.Currency = getDictionaryFromProperty_cdi(aux_buff2, "Currency"  , nametag_up2+".AuthorizedCapital");
               aux_buff2 = null;
            end;
            
            aux_buff2 = uTryToGetPropS(aux_buff, "PODFTInformation");
            if(ValType(aux_buff2) == V_GENOBJ)
               Party.PODFTInformation = c_PODFTInformation();
               Party.PODFTInformation.PODFTFormCreateDate= getValueFromProperty(aux_buff2, "PODFTFormCreateDate"  , nametag_up2+".PODFTInformation");
               Party.PODFTInformation.PODFTFormUpdateDate= getValueFromProperty(aux_buff2, "PODFTFormUpdateDate"  , nametag_up2+".PODFTInformation");
               Party.PODFTInformation.FATCAStatusDate    = getValueFromProperty(aux_buff2, "FATCAStatusDate"      , nametag_up2+".PODFTInformation");
               Party.PODFTInformation.CRSStatusDate      = getValueFromProperty(aux_buff2, "CRSStatusDate"        , nametag_up2+".PODFTInformation");
               Party.PODFTInformation.FATCAStatus  = getDictionaryFromProperty_cdi(aux_buff2, "FATCAStatus"  , nametag_up2+".PODFTInformation");
               Party.PODFTInformation.CRSStatus    = getDictionaryFromProperty_cdi(aux_buff2, "CRSStatus"    , nametag_up2+".PODFTInformation");
               aux_buff2 = null;
            end;
            
            // список 
            aux_buff2 = uTryToGetPropS(aux_buff, "SourceSystemPartyInformationList");
            if(ValType(aux_buff2) == V_GENOBJ)
               Party.SourceSystemPartyInformationList = TArray;
               ai = 0;
               while(aux_buff2.size > ai)
                  temp_value = c_SourceSystemPartyInformation();
                  temp_value.SourceSystemCode  = getDictionaryFromProperty_cdi (aux_buff2(ai), "SourceSystemCode" , nametag_up2, true);
                  temp_value.SourceSystemPartyId = getSymbolFromProperty(aux_buff2(ai), "SourceSystemPartyId" , nametag_up2);
                  
                  Party.SourceSystemPartyInformationList.value(ai) = temp_value;
                  ai = ai + 1;
                  temp_value = NULL;
               end;
               aux_buff2 = NULL;
            elif(ValType(aux_buff2) == V_UNDEF)
               err_txt = string(InErrComPart, nametag_up2+".SourceSystemInformationList");
               RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
            else
               err_txt = string(InErrNotObj, nametag_up2+".SourceSystemInformationList");
               RunError(err_txt, c_err_obj(err_txt,ERR_CODE_TECH_ERROR));
            end;
            aux_buff = null;
         end;
         
         aux_buff = uTryToGetPropS(IncomeData, "RelBranchToPartyList");
         if(ValType(aux_buff) == V_GENOBJ)
            RelBranchToPartyList = TArray;
            ai = 0;
            nametag_up2 = nametag_up+".RelBranchToPartyList";
            while(aux_buff.size > ai)
               temp_value = c_RelBranchToParty();
               temp_value.IsActive            = getValueFromProperty(aux_buff(ai), "IsActive"         , nametag_up2);
               temp_value.LastUpdateDate      = getValueFromProperty(aux_buff(ai), "LastUpdateDate"   , nametag_up2);
               
               temp_value.RelBranchToPartyId  = getSymbolFromProperty(aux_buff(ai), "RelBranchToPartyId" , nametag_up2);
               temp_value.PartyId             = getSymbolFromProperty(aux_buff(ai), "PartyId"            , nametag_up2);
               
               temp_value.BranchCode          = getDictionaryFromProperty_cdi(aux_buff(ai), "BranchCode"     , nametag_up2);
               
               temp_value.SourceSystemInformationList = FillSourceSystemInformation(aux_buff(ai), nametag_up2);

               RelBranchToPartyList.value(ai) = temp_value;
               ai = ai + 1;
               temp_value = NULL;
            end;
            aux_buff = null;
         end;
         
         aux_buff = uTryToGetPropS(IncomeData, "RelGroupList");
         if(ValType(aux_buff) == V_GENOBJ)
            RelGroupList = TArray;
            ai = 0;
            nametag_up2 = nametag_up+".RelGroupList";
            while(aux_buff.size > ai)
               temp_value = c_RelGroup();
               temp_value.ValidFrom       = getValueFromProperty(aux_buff(ai), "ValidFrom"      , nametag_up2);
               temp_value.ValidTo         = getValueFromProperty(aux_buff(ai), "ValidTo"        , nametag_up2);
               temp_value.IsActive        = getValueFromProperty(aux_buff(ai), "IsActive"       , nametag_up2);
               temp_value.LastUpdateDate  = getValueFromProperty(aux_buff(ai), "LastUpdateDate" , nametag_up2);
               
               temp_value.RelGroupId      = getSymbolFromProperty(aux_buff(ai), "RelGroupId"    , nametag_up2);
               temp_value.PartyId         = getSymbolFromProperty(aux_buff(ai), "PartyId"       , nametag_up2);
               
               temp_value.GroupCode       = getDictionaryFromProperty_cdi(aux_buff(ai), "GroupCode" , nametag_up2);
               
               temp_value.SourceSystemInformationList = FillSourceSystemInformation(aux_buff(ai), nametag_up2);

               RelGroupList.value(ai) = temp_value;
               ai = ai + 1;
               temp_value = NULL;
            end;
            aux_buff = null;
         end;
         
         aux_buff = uTryToGetPropS(IncomeData, "RelOkvedList");
         if(ValType(aux_buff) == V_GENOBJ)
            RelOkvedList = TArray;
            ai = 0;
            nametag_up2 = nametag_up+".RelOkvedList";
            while(aux_buff.size > ai)
               temp_value = c_RelOkved_FOR_CDI();
               temp_value.IsMainOkved     = getValueFromProperty(aux_buff(ai), "IsMainOkved"    , nametag_up2);
               temp_value.ValidFrom       = getValueFromProperty(aux_buff(ai), "ValidFrom"      , nametag_up2);
               temp_value.ValidTo         = getValueFromProperty(aux_buff(ai), "ValidTo"        , nametag_up2);
               temp_value.IsActive        = getValueFromProperty(aux_buff(ai), "IsActive"       , nametag_up2, true);
               temp_value.LastUpdateDate  = getValueFromProperty(aux_buff(ai), "LastUpdateDate" , nametag_up2, true);
               
               temp_value.RelOkvedId      = getSymbolFromProperty(aux_buff(ai), "RelOkvedId"    , nametag_up2, true);
               temp_value.PartyId         = getSymbolFromProperty(aux_buff(ai), "PartyId"       , nametag_up2, true);
               
               temp_value.OKVEDCode       = getDictionaryFromProperty_cdi(aux_buff(ai), "OKVEDCode"       , nametag_up2, true);
               
               temp_value.SourceSystemInformationList = FillSourceSystemInformation(aux_buff(ai), nametag_up2);

               RelOkvedList.value(ai) = temp_value;
               ai = ai + 1;
               temp_value = NULL;
            end;
            aux_buff = null;
         end;
         
         aux_buff = uTryToGetPropS(IncomeData, "RelLicenseList");
         if(ValType(aux_buff) == V_GENOBJ)
            RelLicenseList = TArray;
            ai = 0;
            nametag_up2 = nametag_up+".RelLicenseList";
            while(aux_buff.size > ai)
               temp_value = c_RelLicense();
               temp_value.LicenseNumber      = getValueFromProperty(aux_buff(ai), "LicenseNumber"     , nametag_up2);
               temp_value.LicenseDescription = getValueFromProperty(aux_buff(ai), "LicenseDescription", nametag_up2);
               temp_value.LicensesIssuedBy   = getValueFromProperty(aux_buff(ai), "LicensesIssuedBy"  , nametag_up2);
               temp_value.LicenseStartDate   = getValueFromProperty(aux_buff(ai), "LicenseStartDate"  , nametag_up2);
               temp_value.LicenseEndDate     = getValueFromProperty(aux_buff(ai), "LicenseEndDate"    , nametag_up2);
               temp_value.IsActive           = getValueFromProperty(aux_buff(ai), "IsActive"          , nametag_up2);
               temp_value.LastUpdateDate     = getValueFromProperty(aux_buff(ai), "LastUpdateDate"    , nametag_up2);
               
               temp_value.RelLicenseId    = getSymbolFromProperty(aux_buff(ai), "RelLicenseId"  , nametag_up2);
               temp_value.PartyId         = getSymbolFromProperty(aux_buff(ai), "PartyId"       , nametag_up2);
               
               temp_value.LicenseCode     = getDictionaryFromProperty_cdi(aux_buff(ai), "LicenseCode"     , nametag_up2);

               temp_value.SourceSystemInformationList = FillSourceSystemInformation(aux_buff(ai), nametag_up2);

               RelLicenseList.value(ai) = temp_value;
               ai = ai + 1;
               temp_value = NULL;
            end;
            aux_buff = null;
         end;

         aux_buff = uTryToGetPropS(IncomeData, "BankRelList");
         if(ValType(aux_buff) == V_GENOBJ)
            BankRelList = TArray;
            ai = 0;
            nametag_up2 = nametag_up+".BankRelList";
            while(aux_buff.size > ai)
               temp_value = c_BankRel();
               temp_value.IsActive           = getValueFromProperty(aux_buff(ai), "IsActive"          , nametag_up2);
               temp_value.LastUpdateDate     = getValueFromProperty(aux_buff(ai), "LastUpdateDate"    , nametag_up2);
               
               temp_value.BankRelId       = getSymbolFromProperty(aux_buff(ai), "BankRelId"     , nametag_up2);
               temp_value.PartyId         = getSymbolFromProperty(aux_buff(ai), "PartyId"       , nametag_up2);
               
               temp_value.BankRelCode     = getDictionaryFromProperty_cdi(aux_buff(ai), "BankRelCode"     , nametag_up2);

               temp_value.SourceSystemInformationList = FillSourceSystemInformation(aux_buff(ai), nametag_up2);

               BankRelList.value(ai) = temp_value;
               ai = ai + 1;
               temp_value = NULL;
            end;
            aux_buff = null;
         end;
         
         aux_buff = uTryToGetPropS(IncomeData, "ContactList");
         if(ValType(aux_buff) == V_GENOBJ)
            ContactList = TArray;
            ai = 0;
            nametag_up2 = nametag_up+".ContactList";
            while(aux_buff.size > ai)
               temp_value = c_Contact();
               temp_value.ContactValue    = getValueFromProperty(aux_buff(ai), "ContactValue"   , nametag_up2, true);
               temp_value.Description     = getValueFromProperty(aux_buff(ai), "Description"    , nametag_up2);
               temp_value.IsMainContact   = getValueFromProperty(aux_buff(ai), "IsMainContact"  , nametag_up2);

               // DEF-59855 для CdiGetOrg и CdiPublish разные типы
               temp_variant = getValueFromProperty(aux_buff(ai), "IsActiveContact", nametag_up2);
               if (UseAnotherState)
                  if (ValType(temp_variant) != V_UNDEF)
                     // если не задано, ничего не присваиваем
                     if (temp_variant == "YES")
                        temp_value.IsActiveContact = true;
                     else 
                        temp_value.IsActiveContact = false;
                     end;
                  end;
               else 
                  temp_value.IsActiveContact              = temp_variant;
               end;
               temp_variant = null;

               temp_value.Status          = getValueFromProperty(aux_buff(ai), "Status"         , nametag_up2);
               temp_value.IsActive        = getValueFromProperty(aux_buff(ai), "IsActive"       , nametag_up2, true);
               temp_value.LastUpdateDate  = getValueFromProperty(aux_buff(ai), "LastUpdateDate" , nametag_up2, true);
               
               temp_value.ContactId       = getSymbolFromProperty(aux_buff(ai), "ContactId"     , nametag_up2, true);
               temp_value.PartyId         = getSymbolFromProperty(aux_buff(ai), "PartyId"       , nametag_up2, true);
               
               temp_value.ContactType     = getDictionaryFromProperty_cdi(aux_buff(ai), "ContactType"     , nametag_up2);
               temp_value.ContactDetailType     = getDictionaryFromProperty_cdi(aux_buff(ai), "ContactDetailType"     , nametag_up2);

               temp_value.SourceSystemInformationList = FillSourceSystemInformation(aux_buff(ai), nametag_up2);

               ContactList.value(ai) = temp_value;
               ai = ai + 1;
               temp_value = NULL;
            end;
            aux_buff = null;
         end;
         
         aux_buff = uTryToGetPropS(IncomeData, "AddressList");
         if(ValType(aux_buff) == V_GENOBJ)
            AddressList = TArray;
            ai = 0;
            nametag_up2 = nametag_up+".AddressList";
            while(aux_buff.size > ai)
               temp_value = c_Address();
               temp_value.AddressLine  = getValueFromProperty(aux_buff(ai), "AddressLine"    , nametag_up2);
               temp_value.PostalCode   = getValueFromProperty(aux_buff(ai), "PostalCode"     , nametag_up2);
               temp_value.RegionName   = getValueFromProperty(aux_buff(ai), "RegionName"     , nametag_up2);
               temp_value.AreaName     = getValueFromProperty(aux_buff(ai), "AreaName"       , nametag_up2);
               temp_value.CityName     = getValueFromProperty(aux_buff(ai), "CityName"       , nametag_up2);
               temp_value.PlaceName    = getValueFromProperty(aux_buff(ai), "PlaceName"      , nametag_up2);
               temp_value.StructureName= getValueFromProperty(aux_buff(ai), "StructureName"  , nametag_up2);
               temp_value.StreetName   = getValueFromProperty(aux_buff(ai), "StreetName"     , nametag_up2);
               temp_value.House        = getValueFromProperty(aux_buff(ai), "House"          , nametag_up2);
               temp_value.Hcase        = getValueFromProperty(aux_buff(ai), "Hcase"          , nametag_up2);
               temp_value.Block        = getValueFromProperty(aux_buff(ai), "Block"          , nametag_up2);
               temp_value.Liter        = getValueFromProperty(aux_buff(ai), "Liter"          , nametag_up2);
               temp_value.Flat         = getValueFromProperty(aux_buff(ai), "Flat"           , nametag_up2);
               temp_value.IsMainAddress= getValueFromProperty(aux_buff(ai), "IsMainAddress"  , nametag_up2);
               temp_value.OKTMO        = getValueFromProperty(aux_buff(ai), "OKTMO"          , nametag_up2);
               temp_value.FiasGuid     = getValueFromProperty(aux_buff(ai), "FiasGuid"       , nametag_up2);
               temp_value.KladrId      = getValueFromProperty(aux_buff(ai), "KladrId"        , nametag_up2);
               temp_value.Description  = getValueFromProperty(aux_buff(ai), "Description"    , nametag_up2);
               
               temp_value.IsActive        = getValueFromProperty(aux_buff(ai), "IsActive"       , nametag_up2, true);
               temp_value.LastUpdateDate  = getValueFromProperty(aux_buff(ai), "LastUpdateDate" , nametag_up2, true);
               
               temp_value.AddressId       = getSymbolFromProperty(aux_buff(ai), "AddressId"     , nametag_up2, true);
               temp_value.PartyId         = getSymbolFromProperty(aux_buff(ai), "PartyId"       , nametag_up2, true);
               
               temp_value.AddressType     = getDictionaryFromProperty_cdi(aux_buff(ai), "AddressType"     , nametag_up2);
               temp_value.Country         = getDictionaryFromProperty_cdi(aux_buff(ai), "Country"         , nametag_up2);
               temp_value.RegionType      = getDictionaryFromProperty_cdi(aux_buff(ai), "RegionType"      , nametag_up2);
               temp_value.AreaType        = getDictionaryFromProperty_cdi(aux_buff(ai), "AreaType"        , nametag_up2);
               temp_value.CityType        = getDictionaryFromProperty_cdi(aux_buff(ai), "CityType"        , nametag_up2);
               temp_value.PlaceType       = getDictionaryFromProperty_cdi(aux_buff(ai), "PlaceType"       , nametag_up2);
               temp_value.StructureType   = getDictionaryFromProperty_cdi(aux_buff(ai), "StructureType"   , nametag_up2);
               temp_value.StreetType      = getDictionaryFromProperty_cdi(aux_buff(ai), "StreetType"      , nametag_up2);
               
               temp_value.SourceSystemInformationList = FillSourceSystemInformation(aux_buff(ai), nametag_up2);

               AddressList.value(ai) = temp_value;
               ai = ai + 1;
               temp_value = NULL;
            end;
            aux_buff = null;
         end;
         
         aux_buff = uTryToGetPropS(IncomeData, "VerificationList");
         if(ValType(aux_buff) == V_GENOBJ)
            VerificationList = TArray;
            ai = 0;
            nametag_up2 = nametag_up+".VerificationList";
            while(aux_buff.size > ai)
               temp_value = c_Verification();
               temp_value.CheckDate       = getValueFromProperty(aux_buff(ai), "CheckDate"      , nametag_up2);
               temp_value.CheckVal        = getValueFromProperty(aux_buff(ai), "CheckVal"       , nametag_up2);
               temp_value.IsActive        = getValueFromProperty(aux_buff(ai), "IsActive"       , nametag_up2);
               temp_value.LastUpdateDate  = getValueFromProperty(aux_buff(ai), "LastUpdateDate" , nametag_up2);
               
               temp_value.VerificationId  = getSymbolFromProperty(aux_buff(ai), "VerificationId", nametag_up2);
               temp_value.PartyId         = getSymbolFromProperty(aux_buff(ai), "PartyId"       , nametag_up2);
               
               temp_value.CheckCode       = getDictionaryFromProperty_cdi(aux_buff(ai), "CheckCode", nametag_up2);

               temp_value.SourceSystemInformationList = FillSourceSystemInformation(aux_buff(ai), nametag_up2);

               VerificationList.value(ai) = temp_value;
               ai = ai + 1;
               temp_value = NULL;
            end;
            aux_buff = null;
         end;
         
         aux_buff = uTryToGetPropS(IncomeData, "StateList");
         if(ValType(aux_buff) == V_GENOBJ)
            StateList = TArray;
            ai = 0;
            nametag_up2 = nametag_up+".StateList";
            while(aux_buff.size > ai)
               if (UseAnotherState)
                  temp_value = c_State_Publish();
               else 
                  temp_value = c_State();
               end;
               temp_value.ReorganizationDate = getValueFromProperty(aux_buff(ai), "ReorganizationDate", nametag_up2);
               temp_value.StartDate          = getValueFromProperty(aux_buff(ai), "StartDate"         , nametag_up2);
               temp_value.EndDate            = getValueFromProperty(aux_buff(ai), "EndDate"           , nametag_up2);
               temp_value.IsActive           = getValueFromProperty(aux_buff(ai), "IsActive"          , nametag_up2);
               temp_value.LastUpdateDate     = getValueFromProperty(aux_buff(ai), "LastUpdateDate"    , nametag_up2);
               
               temp_value.StateId         = getSymbolFromProperty(aux_buff(ai), "StateId"       , nametag_up2);
               temp_value.PartyId         = getSymbolFromProperty(aux_buff(ai), "PartyId"       , nametag_up2);
               
               temp_value.StateCode       = getDictionaryFromProperty_cdi(aux_buff(ai), "StateCode"       , nametag_up2);

               temp_value.SourceSystemInformationList = FillSourceSystemInformation(aux_buff(ai), nametag_up2);

               StateList.value(ai) = temp_value;
               ai = ai + 1;
               temp_value = NULL;
            end;
            aux_buff = null;
         end;
         
         aux_buff = uTryToGetPropS(IncomeData, "ExtIdList");
         if(ValType(aux_buff) == V_GENOBJ)
            ExtIdList = TArray;
            ai = 0;
            nametag_up2 = nametag_up+".ExtIdList";
            while(aux_buff.size > ai)
               temp_value = c_ExtId_FOR_CDI();
               temp_value.IsActive              = getValueFromProperty(aux_buff(ai), "IsActive"             , nametag_up2, true);
               temp_value.LastUpdateDate        = getValueFromProperty(aux_buff(ai), "LastUpdateDate"       , nametag_up2, true);
               temp_value.IsExtIdActive         = getValueFromProperty(aux_buff(ai), "IsExtIdActive"        , nametag_up2);
               temp_value.StartDate             = getValueFromProperty(aux_buff(ai), "StartDate"            , nametag_up2);
               temp_value.EndDate               = getValueFromProperty(aux_buff(ai), "EndDate"              , nametag_up2);
               temp_value.ExtIdSourceSystemName = getValueFromProperty(aux_buff(ai), "ExtIdSourceSystemName", nametag_up2);
               
               temp_value.ExtIdId            = getSymbolFromProperty(aux_buff(ai), "ExtIdId"             , nametag_up2);
               temp_value.ExtIdPartyId       = getSymbolFromProperty(aux_buff(ai), "ExtIdPartyId"        , nametag_up2, true);
               temp_value.ExtIdPartySourceId = getSymbolFromProperty(aux_buff(ai), "ExtIdPartySourceId"  , nametag_up2, true);
               
               temp_value.ExtIdSourceSystem  = getDictionaryFromProperty_cdi(aux_buff(ai), "ExtIdSourceSystem", nametag_up2, true);
               
               temp_value.SourceSystemInformationList = FillSourceSystemInformation(aux_buff(ai), nametag_up2);

               ExtIdList.value(ai) = temp_value;
               ai = ai + 1;
               temp_value = NULL;
            end;
            aux_buff = null;
         end;
         
         aux_buff = uTryToGetPropS(IncomeData, "RelPartyToPartyList");
         if(ValType(aux_buff) == V_GENOBJ)
            RelPartyToPartyList = TArray;
            ai = 0;
            nametag_up2 = nametag_up+".RelPartyToPartyList";
            while(aux_buff.size > ai)
               temp_value = c_RelPartyToParty();
               temp_value.ValidFrom              = getValueFromProperty(aux_buff(ai), "ValidFrom"             , nametag_up2);
               temp_value.ValidTo                = getValueFromProperty(aux_buff(ai), "ValidTo"               , nametag_up2);
               temp_value.BaseDocumentNumber     = getValueFromProperty(aux_buff(ai), "BaseDocumentNumber"    , nametag_up2);
               temp_value.AuthorizedCapitalShare = getValueFromProperty(aux_buff(ai), "AuthorizedCapitalShare", nametag_up2);
               
               temp_value.PartyId           = getSymbolFromProperty(aux_buff(ai), "PartyId"            , nametag_up2);
               temp_value.RelatedPartyId    = getSymbolFromProperty(aux_buff(ai), "RelatedPartyId"     , nametag_up2);
               temp_value.RelatedPartyCFTId = getSymbolFromProperty(aux_buff(ai), "RelatedPartyCFTId"  , nametag_up2);
               temp_value.RelPartyToPartyId = getSymbolFromProperty(aux_buff(ai), "RelPartyToPartyId"  , nametag_up2);
               
               temp_value.PartyRelationType = getDictionaryFromProperty_cdi(aux_buff(ai), "PartyRelationType", nametag_up2);
               temp_value.BaseDocumentType  = getDictionaryFromProperty_cdi(aux_buff(ai), "BaseDocumentType", nametag_up2);

               temp_value.SourceSystemInformationList = FillSourceSystemInformation(aux_buff(ai), nametag_up2);

               RelPartyToPartyList.value(ai) = temp_value;
               ai = ai + 1;
               temp_value = NULL;
            end;
            aux_buff = null;
         end;

      end;
   end;
   
   uInitPrime(IncomeData, _nametag_up);
end; 

/**
@brief Сравнивалка
@param[in] p_value_xml Параметр входящего XML-запроса
@param[in] p_value_exist Существующий параметр в СОФР
@param[in] p_need_update Признак необходимости обновления, найденный ранее
@return true/false : true - обновление требуется, false - обновление не требуется

Пустое значение считается совпадающим
*/
macro NeedUpdateValue(p_value_xml, p_value_exist, p_need_update)
   if (p_need_update) // перестаем проверять
      return true;
   end;
   if (ValType(p_value_xml) == V_UNDEF)
      return false;
   end;
   if ( ValType(p_value_xml) == ValType(p_value_exist) ) 
     if (ValType(p_value_xml) == V_STRING)
        if (StrUpr(p_value_xml) == StrUpr(p_value_exist))
            return false;
        end;
     elif (p_value_xml == p_value_exist)
        return false;
     end;
   end;
   return true;
end;

/**
@brief Получить наименование субъекта
@param[in] p_PartyID Partyid клиента
@param[in] p_NameKind Вид наименования
@return Наименование указанного вида, если не найдено, то "-1"

RSBPartyName номинально существует, но его невозможно использовать
*/
macro GetPartyName(p_PartyID, p_NameKind)
   var res = "-1";
   var sql_str, cmd, rs;
   
   sql_str =  "SELECT t_Name "+
              "  FROM dpartyname_dbt "+
              " WHERE t_NameTypeID = :p_NameKind "+
              "   AND t_PartyID = :p_PartyID ";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("p_NameKind", RSDBP_IN, p_NameKind);
   cmd.AddParam("p_PartyID", RSDBP_IN, p_PartyID);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      res = rs.value(0);
   end;
   
   return res;
end;

/**
@brief Получить буквенный код страны
@param[in] p_CodeNum  числовой код страны
@return Буквенный код страны
*/
macro GetCodeLatCountry(p_CodeNum)
   var res = "RUS";
   var sql_str, cmd, rs;

   sql_str =  "SELECT t_CodeLat3 "+
              "  FROM dcountry_dbt "+
              " WHERE t_codenum3 = :p_codenum ";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("p_codenum", RSDBP_IN, p_CodeNum);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      res = rs.value(0);
   end;
   
   return res;
end;

/**
@brief Отправить уведомление о смене резидентности
@param[in] p_flag_change_res  признак смены: 100 - стал резидентом, -100 - стал нерезидентом
@param[in] p_Name имя субъекта
@param[in] p_Code код АБС субъекта
*/
macro SendNotifyChangeRes(p_flag_change_res, p_Name, p_Code)
   var v_email_processor = c_email_proc_env();
   var v_emailtext = "", v_emailhead = "";
   var C_GROUPEMAIL_CDICHANGERESIDENSY = 47;
   var res_str;

   if (p_flag_change_res == 100)
      res_str = "резидентом";
   else 
      res_str = "нерезидентом";
   end;

   v_emailtext = p_Name+" ("+p_Code+") теперь является "+res_str+". Возможно, необходимо изменить открытые счета ";
   v_emailhead = "СОФР. Изменена резидентность субъекта";

   v_email_processor.m_set_msg_head(v_emailhead);
   v_email_processor.m_get_email_group(C_GROUPEMAIL_CDICHANGERESIDENSY);
   v_email_processor.m_add_row_to_msg_text(v_emailtext);
   v_email_processor.m_save_to_submit_grp(C_GROUPEMAIL_CDICHANGERESIDENSY, true);
   v_email_processor.m_submit_email_synch();
end;


/**
@brief Обновить субъекта входящими данными

Используются глобальные параметры. 
Вызов может быть через ProcessTrn или внутри транзации, созданной выше (справедливо для Publish)
*/
macro UpdateParty_ByCDI_trn()
   var Party : RsbParty;
   var Categories, Codes, Addresses, Contacts;
   var Code_temp = NULL, Category_temp = NULL, Contact_temp = NULL, temp_sourcesystem, IsContactFound = false;
   var temp_value, v_issingle;
   var inn;
   var num_group = 0;
   var address_type = 1;
   var stat;
   var err_txt;
   var temp_value_res, temp_value_nrcountry, flag_change_res;
   var CodeABS = "";
   record fininstr(fininstr);

   private file attr("objattr.dbt") key 0;
   private file attrcor("objatcor.dbt") key 0;

   g_res.ErrorCode = 0;
   g_res.ErrorDesc = "OK";
   g_need_update = false;
   
   if ( (ProcessParty.IncomeData == NULL) or (ValType(ProcessParty.IncomeData) == V_UNDEF) )
      return null;
   end;
   
   Party = RsbParty(ProcessParty.PartyID);
   
   if (ValType(ProcessParty.IncomeData.Party.FullNameOrg) == V_UNDEF)
      ProcessParty.IncomeData.Party.FullNameOrg = "";
   end;
   g_need_update = NeedUpdateValue(ProcessParty.IncomeData.Party.FullNameOrg, Party.FullName, g_need_update);
   Party.FullName = ProcessParty.IncomeData.Party.FullNameOrg;

   if (ValType(ProcessParty.IncomeData.Party.ShortNameOrg) == V_UNDEF)
      ProcessParty.IncomeData.Party.ShortNameOrg = "";
   end;
   g_need_update = NeedUpdateValue(ProcessParty.IncomeData.Party.ShortNameOrg, Party.ShortName, g_need_update);
   Party.ShortName = ProcessParty.IncomeData.Party.ShortNameOrg;

   flag_change_res = 0;
   temp_value_nrcountry = "RUS";
   temp_value_res = true;
   if ( (ValType(ProcessParty.IncomeData.Party.IsResidentTax) != V_UNDEF) 
        or (ValType(ProcessParty.IncomeData.Party.ResidenceCountry) != V_UNDEF) )
      if (ValType(ProcessParty.IncomeData.Party.ResidenceCountry) != V_UNDEF)
         // страна передается в виде числового кода
         temp_value_nrcountry = GetCodeLatCountry(ProcessParty.IncomeData.Party.ResidenceCountry.RecordCode);
         if (Party.NRCountry == temp_value_nrcountry) // ничего не меняется
         else 
            g_need_update = true;
            if ( (temp_value_nrcountry != "RUS") and (not(Party.IsNotResident)) ) // стал нерезидентом
               flag_change_res = -100;
            else // стал резидентом
               flag_change_res = 100;
            end;
            Party.IsResidenceUnknown = false;
            Party.NRCountry = temp_value_nrcountry;
         end;
      end;

      if (ValType(ProcessParty.IncomeData.Party.IsResidentTax) != V_UNDEF)
         temp_value_res = not(ProcessParty.IncomeData.Party.IsResidentTax);
         if (temp_value_res == Party.IsNotResident) // ничего не меняется
         else 
            g_need_update = true;
            if ( Party.IsNotResident and (ProcessParty.IncomeData.Party.IsResidentTax or (temp_value_nrcountry == "RUS")) ) // стал резидентом
               flag_change_res = 100;
            else // стал нерезидентом
               flag_change_res = -100;
            end;
            if ((not temp_value_res) and Party.IsResidenceUnknown) //если стал резидентом и стоит галочка "не известна страна"
               Party.IsResidenceUnknown = false;
            end;
            Party.IsNotResident = temp_value_res;
         end;
      end;
   end;

   if (ValType(ProcessParty.IncomeData.Party.OKPO) == V_UNDEF)
      ProcessParty.IncomeData.Party.OKPO = "";
   end;
   g_need_update = NeedUpdateValue(ProcessParty.IncomeData.Party.OKPO, Party.OKPO, g_need_update);
   Party.OKPO = ProcessParty.IncomeData.Party.OKPO;
   
   if (ValType(ProcessParty.IncomeData.Party.AuthorizedCapital) != V_UNDEF)
      g_need_update = NeedUpdateValue(ProcessParty.IncomeData.Party.AuthorizedCapital.Value, Party.RealCapital, g_need_update);
      Party.RealCapital = ProcessParty.IncomeData.Party.AuthorizedCapital.Value;
      if (ValType(ProcessParty.IncomeData.Party.AuthorizedCapital.Currency) != V_UNDEF)
         if (StrLen(ProcessParty.IncomeData.Party.AuthorizedCapital.Currency.RecordCode) > 1)
            if (ПолучитьФинИнПоISO (Int(ProcessParty.IncomeData.Party.AuthorizedCapital.Currency.RecordCode), fininstr))
               g_need_update = NeedUpdateValue(fininstr.FIID, Party.CapitalFI, g_need_update);
               Party.CapitalFI = fininstr.FIID;
            else
               g_need_update = NeedUpdateValue(0, Party.CapitalFI, g_need_update);
               Party.CapitalFI = 0;
            end;
         else 
            g_need_update = NeedUpdateValue(0, Party.CapitalFI, g_need_update);
            Party.CapitalFI = 0;
         end;
      end;
   end;

   // контакты
   Contacts = TArray;
   if (ValType(ProcessParty.IncomeData.ContactList) != V_UNDEF)
      for (temp_value, ProcessParty.IncomeData.ContactList)
         if (temp_value.IsActive)
            IsContactFound = false;
            Contact_temp = c_PartyContact;
            if (ValType(temp_value.IsMainContact) == V_BOOL)
               Contact_temp.IsMain = temp_value.IsMainContact;
            else 
               Contact_temp.IsMain = false;
            end;

            if ( (ValType(temp_value.ContactType) != V_UNDEF) 
                 and (ValType(temp_value.ContactDetailType) != V_UNDEF) 
                 and (ValType(temp_value.ContactValue) != V_UNDEF) )
               if (temp_value.ContactType.RecordCode == "PHONE")
                  Contact_temp.ContactKind = CNTK_PHONE;
                  Contact_temp.AddressType = 1; // всегда юридический
                  Contact_temp.Value = temp_value.ContactValue;
                  if (temp_value.ContactDetailType.RecordCode == "WORK") 
                     Contact_temp.ContactType = CNTT_WORKING;
                  else 
                     Contact_temp.ContactType = CNTT_HOME;
                  end;
               elif (temp_value.ContactType.RecordCode == "MAIL")
                  Contact_temp.ContactKind = CNTK_EMAIL;
                  Contact_temp.ContactType = ADD_CNTT_WORKING;    //DEF-59120 рабочая почта - это 1001
                  Contact_temp.AddressType = 1; // всегда юридический
               else 
                  Contact_temp.ContactKind = 0;
               end;
               Contact_temp.Value = temp_value.ContactValue;
               Contact_temp.Cdi_id = String(temp_value.ContactId.ObjectId);
            end;
            Contact_temp.RecId = 0;

            for (temp_sourcesystem, temp_value.SourceSystemInformationList)
               if (temp_sourcesystem.SourceSystemCode.RecordCode == NAME_SYSTEM)  // если заданы есть наши идентификаторы
                  IsContactFound = true;
                  Contact_temp.RecId = temp_sourcesystem.SourceSystemId.ObjectId;    // идентификаторов может быть несколько, хотя остальные параметры те же
                  Contacts.value(Contacts.size) = Contact_temp;
               end;
            end;

            if (not IsContactFound) // нет наших идентификаторов, нужно будет добавить контакт
               Contacts.value(Contacts.size) = Contact_temp;
            end;
            Contact_temp = NULL;
         end;
      end;
   end;
   

   // коды
   Codes = TArray;
   
   if (ValType(ProcessParty.IncomeData.Party.INN) == V_UNDEF)
      ProcessParty.IncomeData.Party.INN = "";
   end;
   Code_temp = c_PartyCode;
   Code_temp.CodeKind = PTCK_INN;
   Code_temp.Code = ProcessParty.IncomeData.Party.INN;
   if (ValType(ProcessParty.IncomeData.Party.KPPRegistrationPlace) != V_UNDEF)
      Code_temp.Code = Code_temp.Code + "/" + ProcessParty.IncomeData.Party.KPPRegistrationPlace;
   end;
   Codes.value(Codes.size) = Code_temp;

/*   if (ValType(ProcessParty.IncomeData.Party.KIO) == V_UNDEF) 
      ProcessParty.IncomeData.Party.KIO = "";
   end;
   Code_temp = c_PartyCode;
   Code_temp.CodeKind = PTCK_FOREIGN_INN;
   Code_temp.Code = ProcessParty.IncomeData.Party.KIO;
   Codes.value(Codes.size) = Code_temp;  */

   if (ValType(ProcessParty.IncomeData.Party.OGRN) == V_UNDEF)
      ProcessParty.IncomeData.Party.OGRN = "";
   end;
   Code_temp = c_PartyCode;
   Code_temp.CodeKind = 27;
   Code_temp.Code = ProcessParty.IncomeData.Party.OGRN;
   /*if (ValType(ProcessParty.IncomeData.Party.OGRNRegistrationDate) != V_UNDEF)
      Code_temp.FromDate = ProcessParty.IncomeData.Party.OGRNRegistrationDate;
   end;*/
   Codes.value(Codes.size) = Code_temp;

   if (ValType(ProcessParty.IncomeData.Party.NonResidentRegistrationNumber) == V_UNDEF)
      ProcessParty.IncomeData.Party.NonResidentRegistrationNumber = "";
   end;
   Code_temp = c_PartyCode;
   Code_temp.CodeKind = 33;
   Code_temp.Code = ProcessParty.IncomeData.Party.NonResidentRegistrationNumber;
   Codes.value(Codes.size) = Code_temp;

   if (ValType(ProcessParty.IncomeData.Party.PartyId) == V_UNDEF)   // самоудаление кода CDI?
      ProcessParty.IncomeData.Party.PartyId = "";
   end;
   Code_temp = c_PartyCode;
   Code_temp.CodeKind = PARTY_CODEKIND_CDI;
   Code_temp.Code = ProcessParty.IncomeData.Party.PartyId.ObjectId;
   Codes.value(Codes.size) = Code_temp;
   
   if (ValType(ProcessParty.IncomeData.ExtIdList) != V_UNDEF)
      for (temp_value, ProcessParty.IncomeData.ExtIdList)
         if ( Valtype(temp_value.ExtIdSourceSystem) != V_UNDEF )
            if ( (Valtype(temp_value.ExtIdSourceSystem.RecordCode) != V_UNDEF) and (temp_value.ExtIdSourceSystem.RecordCode == "CFT") )
               if (temp_value.IsActive)
                  Code_temp = c_PartyCode;
                  Code_temp.CodeKind = PARTY_CODEKIND_ABS;
                  Code_temp.Code = temp_value.ExtIdPartySourceId.ObjectId;
                  Codes.value(Codes.size) = Code_temp;
                  CodeABS = temp_value.ExtIdPartySourceId.ObjectId; 
               end;
            end;
         end;
      end;
   end; 

   //DEF-63543 Если смена резидентности происходит одновременно с установкой кода, то код появится только после сохранения субъекта
   if (flag_change_res != 0)
      if (Valtype(CodeABS) == V_STRING) // возможно только если клиента в ЦФТ нет в принципе, но тогда и кода в СОФР не будет. Лишний код, но пусть будет
         if (StrLen(CodeABS) <= 1)
            CodeABS = Party.Code(PARTY_CODEKIND_ABS);
         end;
      else 
         CodeABS = Party.Code(PARTY_CODEKIND_ABS);
      end;
      // если код все равно пустой, то что ж. Все равно письмо нужно отправить
      SendNotifyChangeRes(flag_change_res, Party.FullName, CodeABS);
   end;

   // категории
   Categories = TArray;
   var check_category_str = " and objcor.t_groupid in (0";
   
   num_group = CONTRACT_CATEGORY_CDI_PARTYTYPE;
   if (ValType(ProcessParty.IncomeData.Party.PartyType) != V_UNDEF)
      Category_temp = adp_Categories;
      Category_temp.GroupID = num_group;
      Category_temp.Value = ProcessParty.IncomeData.Party.PartyType.RecordCode;
      Category_temp.IsSingle = GetSingleSign(OBJTYPE_PARTY, num_group);
      Categories.value(Categories.size) = Category_temp;
   end;
   check_category_str = check_category_str+","+String(num_group);

   num_group = PARTY_CATEGORY_OKFS;
   if (ValType(ProcessParty.IncomeData.Party.OKFS) != V_UNDEF)
      Category_temp = adp_Categories;
      Category_temp.GroupID = num_group;
      Category_temp.Value = ProcessParty.IncomeData.Party.OKFS.RecordCode;
      Category_temp.IsSingle = GetSingleSign(OBJTYPE_PARTY, num_group);
      Categories.value(Categories.size) = Category_temp;
   end;
   check_category_str = check_category_str+","+String(num_group);

   num_group = PARTY_CATEGORY_OKOGU;
   if (ValType(ProcessParty.IncomeData.Party.OKOGU) != V_UNDEF)
      Category_temp = adp_Categories;
      Category_temp.GroupID = num_group;
      Category_temp.Value = ProcessParty.IncomeData.Party.OKOGU.RecordCode;
      Category_temp.IsSingle = GetSingleSign(OBJTYPE_PARTY, num_group);
      Categories.value(Categories.size) = Category_temp;
   end;
   check_category_str = check_category_str+","+String(num_group);
      
   num_group = PARTY_CATEGORY_OKTMO;
   if (ValType(ProcessParty.IncomeData.Party.OKTMO) != V_UNDEF)
      Category_temp = adp_Categories;
      Category_temp.GroupID = num_group;
      Category_temp.Value = ProcessParty.IncomeData.Party.OKTMO.RecordCode;
      Category_temp.IsSingle = GetSingleSign(OBJTYPE_PARTY, num_group);
      Categories.value(Categories.size) = Category_temp;
   end;
   check_category_str = check_category_str+","+String(num_group);
      
   num_group = PARTY_CATEGORY_OKATO;
   record attrOKATO( "objattr" );
   if (ValType(ProcessParty.IncomeData.Party.OKATO) != V_UNDEF)
      Category_temp = adp_Categories;
      Category_temp.GroupID = num_group;
      Category_temp.Value = ProcessParty.IncomeData.Party.OKATO.RecordCode;
      
      if (StrLen(Category_temp.Value) == 11) // DEF-82296
         Category_temp.Value = SubStr(Category_temp.Value, 1, 8) + "000"; //записываем полученный код ОКАТО от CDI
         var objectID = String(ProcessParty.PartyID:o:10);
         var ObjCatOKATO = RsbObjCategories(OBJTYPE_PARTY, objectID);

         var query = "select t_numinlist from dobjattr_dbt where t_groupid = 12 AND t_numinlist = :1 "; 
         var cmd = RSDCommand(query);
         cmd.AddParam(":1",RSDBP_IN, Category_temp.Value);
         var result = RSDRecordSet(cmd);

         if(result.moveNext() != true) 

         //отправка письма на группу сопровождения
            var params:TArray = TArray();
            var messHead = "СОФР.Ошибка сохранения кода ОКАТО из CDI";
            var messBody = "Не удалось сохранить код OKATO по субъекту " + objectID + " по причине, что код не найден в справочнике. Обновите справочник ОКАТО в СОФР или обратитесь к команде CDI, для изменения.";
            params[0] = SQLParam( "p_EmailGroup", 50);
            params[1] = SQLParam( "p_Head", messHead);
            params[2] = SQLParam( "p_Text", messBody);
            execStoredFunc("rsb_payments_api.InsertEmailNotify", V_UNDEF, params);      

            if(ObjCatOKATO.GetFirst(Category_temp.GroupID, {curdate}, attrOKATO) == 0) 
               Category_temp.Value = attrOKATO.NameObject;
            else
               Category_temp.Value = "";   
            end;
         end;
      end;
      
      Category_temp.IsSingle = GetSingleSign(OBJTYPE_PARTY, num_group);
      Categories.value(Categories.size) = Category_temp;
   end;


   num_group = PARTY_CATEGORY_OKOPF;
   if (ValType(ProcessParty.IncomeData.Party.OKOPF) != V_UNDEF)
      Category_temp = adp_Categories;
      Category_temp.GroupID = num_group;
      Category_temp.Value = NormalizeOKOPF(ProcessParty.IncomeData.Party.OKOPF.RecordCode, num_group);
      Category_temp.IsSingle = GetSingleSign(OBJTYPE_PARTY, num_group);
      Categories.value(Categories.size) = Category_temp;
   end;
   check_category_str = check_category_str+","+String(num_group);
   
   num_group = PARTY_CATEGORY_RESPONSIBILITY_ZONE;
   if (ValType(ProcessParty.IncomeData.Party.ResponsibilityZone) != V_UNDEF)
      Category_temp = adp_Categories;
      Category_temp.GroupID = num_group;
      Category_temp.Value = ProcessParty.IncomeData.Party.ResponsibilityZone.RecordCode;
      Category_temp.IsSingle = GetSingleSign(OBJTYPE_PARTY, num_group);
      Categories.value(Categories.size) = Category_temp;
   end;
   check_category_str = check_category_str+","+String(num_group);

   //ОКВЭД
   num_group = PARTY_CATEGORY_OKVED;
   var main_okved_value = "";
   var main_okved_groupid = 0;
   if (ValType(ProcessParty.IncomeData.RelOkvedList) != V_UNDEF)
      v_issingle = GetSingleSign(OBJTYPE_PARTY, num_group);
      for (temp_value, ProcessParty.IncomeData.RelOkvedList)
         Category_temp = adp_Categories;
         Category_temp.GroupID = num_group;
         Category_temp.Value = temp_value.OKVEDCode.RecordCode;
         Category_temp.IsSingle = v_issingle;
         Categories.value(Categories.size) = Category_temp;
         if (temp_value.IsMainOkved) // признак главного
            main_okved_groupid = num_group;
            main_okved_value = Category_temp.Value;
         end;
         Category_temp = NULL;
      end;
   end;
   check_category_str = check_category_str+","+String(num_group);
   
   check_category_str = check_category_str + ")";
   
   // адреса
   if (ValType(ProcessParty.IncomeData.AddressList) != V_UNDEF)
      Addresses = TArray;
      var ai = 0, address_temp = NULL;
      for (temp_value, ProcessParty.IncomeData.AddressList)
         if (temp_value.IsActive)
         
            if (ValType(temp_value.AddressType) != V_UNDEF)
               if ( StrUpr(temp_value.AddressType.RecordCode) == StrUpr("CORP") )
                  address_type = 1; // юридический
               elif ( StrUpr(temp_value.AddressType.RecordCode) == StrUpr("FACT") )
                  address_type = 2; // фактический
               elif ( StrUpr(temp_value.AddressType.RecordCode) == StrUpr("POST") )
                  address_type = 3; // почтовый
               elif ( StrUpr(temp_value.AddressType.RecordCode) == StrUpr("CORP_CHARTER") )
                  address_type = 5; // Место нахождения (по учр.документам)
               end;
            else 
               address_type = 1;
            end;
            address_temp = Party.Address(address_type);

            g_need_update = NeedUpdateValue(temp_value.AddressLine, address_temp.Address, g_need_update); // сравним только полную строку адреса

            if (ValType(temp_value.Country) != V_UNDEF)
               address_temp.Country = temp_value.Country.RecordCode;
            else
               address_temp.Country = "RUS";
            end;
            
            if (ValType(temp_value.PostalCode) != V_UNDEF)
               address_temp.PostIndex = temp_value.PostalCode;
            else 
               address_temp.PostIndex = "";
            end;
            if (ValType(temp_value.RegionName) != V_UNDEF)
               address_temp.Region = temp_value.RegionName;    // область
            else 
               address_temp.Region = "";
            end;
            if (ValType(temp_value.RegionType) != V_UNDEF)
               address_temp.coderegion = temp_value.RegionType.RecordCode;
            else 
               address_temp.coderegion = "";
            end;
            if (ValType(temp_value.AreaName) != V_UNDEF)
               address_temp.Province = temp_value.AreaName;       // район
            else 
               address_temp.Province = "";
            end;
            if (ValType(temp_value.AreaType) != V_UNDEF)
               address_temp.CodeProvince = temp_value.AreaType.RecordCode;
            else 
               address_temp.CodeProvince = "";
            end;
            if (ValType(temp_value.PlaceName) != V_UNDEF)
               address_temp.Place = temp_value.PlaceName;      // населенный пункт
            else 
               address_temp.Place = "";
            end;
            if (ValType(temp_value.PlaceType) != V_UNDEF)
               address_temp.CodePlace = temp_value.PlaceType.RecordCode;
            else 
               address_temp.CodePlace = "";
            end;
            if (ValType(temp_value.CityName) != V_UNDEF)
               address_temp.District = temp_value.CityName;       // город
            else 
               address_temp.District = "";
            end;
            if (ValType(temp_value.CityType) != V_UNDEF)
               address_temp.CodeDistrict = temp_value.CityType.RecordCode;
            else 
               address_temp.CodeDistrict = "";
            end;
            if (ValType(temp_value.StreetName) != V_UNDEF)
               address_temp.Street = temp_value.StreetName;       // улица
            else 
               address_temp.Street = "";
            end;
            if (ValType(temp_value.StreetType) != V_UNDEF)
               address_temp.CodeStreet = temp_value.StreetType.RecordCode;
            else 
               address_temp.CodeStreet = "";
            end;
            if (ValType(temp_value.House) != V_UNDEF)
               address_temp.House = temp_value.House;
            else 
               address_temp.House = "";
            end;
            if (ValType(temp_value.Hcase) != V_UNDEF)
               address_temp.NumCorps = temp_value.Hcase;
            else 
               address_temp.NumCorps = "";
            end;
            if (ValType(temp_value.StructureName) != V_UNDEF)
               address_temp.plan = temp_value.StructureName;
            else 
               address_temp.plan = "";
            end;
            if (ValType(temp_value.StructureType) != V_UNDEF)
               address_temp.codeplan = temp_value.StructureType.RecordCode;
            else 
               address_temp.codeplan = "";
            end;
            if (ValType(temp_value.Block) != V_UNDEF)
               address_temp.building = temp_value.Block;
            else 
               address_temp.building = "";
            end;
            if (ValType(temp_value.OKTMO) != V_UNDEF)
               address_temp.OKTMO = temp_value.OKTMO;
            else 
               address_temp.OKTMO = "";
            end;
            if (ValType(temp_value.Flat) != V_UNDEF)
               address_temp.Flat = temp_value.Flat;
            else 
               address_temp.Flat = "";
            end;
            if (ValType(temp_value.KladrId) != V_UNDEF)
               address_temp.Kladr = temp_value.KladrId;
            else 
               address_temp.Kladr = "";
            end;
            
            address_temp.Address = temp_value.AddressLine;
            if (ValType(address_temp.Address) == V_UNDEF)
                address_temp.Address = usr_GenResultAddressUser(address_temp);
            end;
            
            if (ValType(temp_value.FiasGuid) != V_UNDEF)
               address_temp.FiasGuid = temp_value.FiasGuid;
            else 
               address_temp.FiasGuid = "";
            end;
            
            Addresses.value(ai) = address_temp;
            ai = ai + 1;
            address_temp = null;
         end;
      end;
   
   end;
   
   // установка кодов
   var current_code_date = NULL;
   var current_code = NULL;
   var new_codes_arr = TArray;
   var new_code;

   for (Code_temp, Codes)
      if(strlen(Code_temp.Code) > 0)
         current_code_date = date(0,0,0);
         current_code = party.Code(Code_temp.CodeKind);
         g_need_update = NeedUpdateValue(Code_temp.Code, current_code, g_need_update);
         if (ValType(Code_temp.FromDate) != V_DATE)
            Code_temp.FromDate = {curdate};
         end;
         // стандартный SetCode не меняет дату начала действия, если новая дата меньше, чем текущая
         if (current_code == Code_temp.Code) 
            GetPartyCode_ByNumber(Party.PartyID, Code_temp.CodeKind, current_code_date); //нужна дата кода
            if (current_code_date != Code_temp.FromDate)
               //stat = Party.Code.DeleteCode(Code_temp.CodeKind); //не позволит установить такой же код с другой датой
               new_code = Code_temp;
               new_codes_arr.value(new_codes_arr.size) = new_code;
               new_code = NULL;
            end;
         else 
            stat = Party.Code.SetCode(Code_temp.CodeKind, Code_temp.Code, Code_temp.FromDate);
            if(not stat)
               err_txt = "Ошибка установки кода вида " + string(Code_temp.CodeKind);
               RunError(err_txt);
            end;
         end;
      else 
         stat = Party.Code.DeleteCode(Code_temp.CodeKind);
         if(not stat)
            err_txt = "Ошибка удаления кода вида " + string(Code_temp.CodeKind);
            RunError(err_txt);
         end;
      end;
   end;

   //контакты
   //отказались нормально работать через PartyContact, обновим ниже

   // постановка на обслуживание
   if (ValType(ProcessParty.IncomeData.Party.PartyStatus) == V_GENOBJ)
      if (StrUpr(ProcessParty.IncomeData.Party.PartyStatus.RecordCode) == StrUpr("Client"))
         stat = PT_BindClientWithBranch(Party.partyid, PTSK_STOCKDL, 1, NULL, {curdate});
         if(not stat)
            err_txt = "Ошибка установки вида обслуживания ";
            RunError(err_txt);
         end;
      end;
   end;

   stat = Party.Update();

   if(not stat)
      RunError("Ошибка сохранения субъекта");
   end;

   //коды с не той датой, из-за конкурентного изменения нельзя апдейтить за спиной RSBParty
   for (new_code, new_codes_arr)
      UpdateCodeDate(Party.PartyId, new_code.CodeKind, new_code.FromDate);
   end;

   // контакты, воспользуемся обычным селектом
   var PartyContact_arr = TArray, ac = 0;
   var sql_contact  = "select * from dcontact_dbt where t_partyid = :partyid";
   var cmd_contact = RSDCommand(sql_contact);
   cmd_contact.Addparam("partyid", RSDBP_IN, Party.PartyID);
   var rs_contact = RSDRecordSet(cmd_contact);
   Contact_temp = NULL;
   
   while (rs_contact.movenext)
      Contact_temp = c_PartyContact;
      Contact_temp.ContactKind = rs_contact.value("t_ContactKind");
      Contact_temp.ContactType = rs_contact.value("t_ContactType");
      Contact_temp.AddressType = rs_contact.value("t_AddressType");
      Contact_temp.Value = rs_contact.value("t_value");
      if (rs_contact.value("t_ismain") == "X")
         Contact_temp.IsMain = true;
      else 
         Contact_temp.IsMain = false;
      end;
      Contact_temp.RecId = rs_contact.value("t_recid");
      Contact_temp.Cdi_id = rs_contact.value("t_note");
      PartyContact_arr.value(ac) = Contact_temp;
      ac = ac + 1;
      Contact_temp = NULL;
   end;

   rs_contact.close;
   cmd_contact.close; 

   var IsFoundByID;
   var arrIDByID;
   var IsFoundByCDIID;
   var arrIDByCDIID;
   var IsFoundByValue;
   var arrIDByValue;
   var Contact_exist;
   
   for (Contact_temp, Contacts)
      if (Contact_temp.ContactKind > 0)
         if(strlen(Contact_temp.Value) > 0)
            // найдем такой же
            IsFoundByID = IsFoundByCDIID = IsFoundByValue = false;
            ac = 0;
            while (ac < PartyContact_arr.size())
               Contact_exist = PartyContact_arr.value(ac);
             
               if (Contact_exist.RecId == Contact_temp.RecId)
                  IsFoundByID = true;
                  arrIDByID = ac;
                  break; // если ID совпадают, то можно выйти, иначе необходимо выполнить проверку далее
               elif ((StrUpr(Contact_exist.Value) == StrUpr(Contact_temp.Value)) and (not IsFoundByValue)) //DEF-59849, не всегда приходит RecId для нашего же контакта
                  IsFoundByValue = true;
                  arrIDByValue = ac;
               elif ((StrUpr(Contact_exist.Cdi_id) == StrUpr(Contact_temp.Cdi_id)) and (not IsFoundByCDIID)) //CDI ID не уникален
                  IsFoundByCDIID = true;
                  arrIDByCDIID = ac;
               end;
               
               ac = ac + 1;
            end;
            
            if (IsFoundByID or IsFoundByValue or IsFoundByCDIID)
               var arrID;

               if (IsFoundByID)
                  arrID = arrIDByID;
               elif (IsFoundByCDIID)
                  arrID = arrIDByCDIID;
               else
                  arrID = arrIDByValue;
               end;
               
               Contact_exist = PartyContact_arr.value(arrID);
               
               if ( (Contact_exist.Value != Contact_temp.Value) or (Contact_exist.IsMain != Contact_temp.IsMain) )
                  g_need_update = true;
               end;
               
               if (g_need_update or (Contact_exist.Cdi_id != Contact_temp.Cdi_id))
                  sql_contact = "update dcontact_dbt set t_value = :v, t_ismain = chr(:pmain), t_note = :pcdi_id where t_recid = :r";
                  cmd_contact = RSDCommand(sql_contact);
                  cmd_contact.AddParam("v", RSDBP_IN, Contact_temp.Value);
                  if (Contact_temp.IsMain)
                     cmd_contact.AddParam("pmain", RSDBP_IN, 88);
                  else
                     cmd_contact.AddParam("pmain", RSDBP_IN, 0);
                  end;
                  cmd_contact.AddParam("pcdi_id", RSDBP_IN, Contact_temp.Cdi_id);
                  cmd_contact.AddParam("r", RSDBP_IN, Contact_exist.RecID);
                  cmd_contact.Execute();
                  cmd_contact.Close();
                  PartyContact_arr.value(arrID).Value = Contact_temp.Value;
                  PartyContact_arr.value(arrID).IsMain = Contact_temp.IsMain;
                  PartyContact_arr.value(arrID).Cdi_id = Contact_temp.Cdi_id;
               end;
            else 
               g_need_update = true;
               // PartyContact.Add + Party.Update вызовет конкурентное изменение, так как транзакция еще не завершена
               sql_contact = "Insert into DCONTACT_DBT (T_RECID, T_PARTYID, T_ADDRESSTYPE, T_CONTACTKIND, T_CONTACTTYPE, T_PROVIDER, T_VALUE, T_NOTE, T_ISMAIN) "+
                             " Values (0, :ppartyid, :padrestype, :pcontactkind, :pcontacttype, chr(1), :pvalue, :pcdi_id, chr(:pmain))";
               cmd_contact = RSDCommand(sql_contact);
               cmd_contact.AddParam("ppartyid", RSDBP_IN, Party.PartyID);
               cmd_contact.AddParam("padrestype", RSDBP_IN, Contact_temp.AddressType);
               cmd_contact.AddParam("pcontactkind", RSDBP_IN, Contact_temp.ContactKind);
               cmd_contact.AddParam("pcontacttype", RSDBP_IN, Contact_temp.ContactType);
               cmd_contact.AddParam("pvalue", RSDBP_IN, Contact_temp.Value);
               cmd_contact.AddParam("pcdi_id", RSDBP_IN, Contact_temp.Cdi_id);
               if (Contact_temp.IsMain)
                 cmd_contact.AddParam("pmain", RSDBP_IN, 88);
               else
                 cmd_contact.AddParam("pmain", RSDBP_IN, 0);
               end;
               cmd_contact.Execute();
               cmd_contact.Close();
            end;

         end;
      end;
   end;

   // удаление контактов, по которым не пришла синхронизация
   var IsFound = false;
   for (Contact_exist, PartyContact_arr)
      IsFound = false;
      
      for (Contact_temp, Contacts)
         if (Contact_exist.Cdi_id == Contact_temp.Cdi_id) 
            IsFound = true;
            break;
         end;
      end;
      
      if (not IsFound)
         sql_contact = "delete from dcontact_dbt where t_recid = :r";
         cmd_contact = RSDCommand(sql_contact);
         cmd_contact.AddParam("r", RSDBP_IN, Contact_exist.RecId);
         cmd_contact.Execute();
         cmd_contact.Close();
      end;
   end;

   // наименования
   var temp_name = "";
   if (ValType(ProcessParty.IncomeData.Party.ShortNameOrgLat) == V_UNDEF)
      ProcessParty.IncomeData.Party.ShortNameOrgLat = strfor(1);
   end;
   temp_name = GetPartyName(ProcessParty.PartyID, PTKN_LATSHORTNAME);
   if (ProcessParty.IncomeData.Party.ShortNameOrgLat != temp_name)
      SetPartyNames(ProcessParty.PartyID, PTKN_LATSHORTNAME, ProcessParty.IncomeData.Party.ShortNameOrgLat);
      g_need_update = true;
   end;
   if (ValType(ProcessParty.IncomeData.Party.FullNameOrgLat) == V_UNDEF)
      ProcessParty.IncomeData.Party.FullNameOrgLat = strFor(1);
   end;
   temp_name = GetPartyName(ProcessParty.PartyID, PTKN_LATFULLNAME);
   if (ProcessParty.IncomeData.Party.FullNameOrgLat != temp_name)
      SetPartyNames(ProcessParty.PartyID, PTKN_LATFULLNAME, ProcessParty.IncomeData.Party.FullNameOrgLat);
      g_need_update = true;
   end;

   // установка категорий
   var new_cat = false;
   
   var ObjCat;
   var IsAttr;
   var category_parm;
   var ObjID = String(ProcessParty.PartyID:o:10);

   ObjCat = RsbObjCategories( OBJTYPE_PARTY, ObjID);
   
   for (category_parm, Categories)
      IsAttr = ObjCat.IsAttrPresense(category_parm.GroupID, NULL, "", category_parm.Value, true, {curdate});
      if (IsAttr)  //DEF-78003 ОКОПФ в CDI уникальный
         if (category_parm.GroupID == PARTY_CATEGORY_OKOPF)
            stat = ObjCat.GetMainAttr(category_parm.GroupID, {curdate}, attr, attrcor);
            if (attr.numinlist != category_parm.Value)
               stat = ObjCat.DisconnectAttr(category_parm.GroupID, 0, true);
               if (stat > 0)
                  err_txt = String("Ошибка "+stat+" смены значения категории ",category_parm.GroupID,", значение ",category_parm.Value);
                  RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
               end;
               stat = ObjCat.ConnectAttr(category_parm.GroupID, NULL, "",  category_parm.Value, {curdate} );
               if (stat > 0)
                  err_txt = String("Ошибка "+stat+" установки категории ",category_parm.GroupID,", значение ",category_parm.Value);
                  RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
               end;      
            end;
         end;
      else
         if (category_parm.Value == "")
            stat = ObjCat.DisconnectAttr(category_parm.GroupID, 0);
         else 
            if (category_parm.GroupID == PARTY_CATEGORY_OKOPF)  //DEF-78003 ОКОПФ в CDI уникальный
               stat = ObjCat.DisconnectAttr(category_parm.GroupID, 0);
               if (stat > 0)
                  err_txt = String("Ошибка "+stat+" смены значения категории ",category_parm.GroupID,", значение ",category_parm.Value);
                  RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
               end;
            end;
            stat = ObjCat.ConnectAttr(category_parm.GroupID, NULL, "",  category_parm.Value, {curdate} );
            if (stat > 0)
               err_txt = String("Ошибка "+stat+" установки категории ",category_parm.GroupID,", значение ",category_parm.Value);
               RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
            end;      
         end;
         g_need_update = true;
      end;
   end;
   
   if(stat == 0)
      stat = ObjCat.Save(ObjID);
   end;

   if (main_okved_groupid > 0)
      var main_okved_attrid = FindAttrByValue(OBJTYPE_PARTY, main_okved_groupid, main_okved_value);
      if (main_okved_attrid > 0)
         stat = ObjCat.SetMainAttr(main_okved_groupid, main_okved_attrid);
         if (stat == 0)
            ObjCat.Save(ObjID);
         end;
      end;
   end;
   
   // очистка лишних категорий
   var PartyCategory_arr = TArray;
   ac = 0;
   var sql_category  = " select objcor.t_groupid, attr.t_attrid, attr.t_numinlist "+
                       "   from dobjatcor_dbt objcor, dobjattr_dbt attr "+
                       "  where objcor.t_objecttype = 3 and objcor.t_object = lpad(:partyid,10,'0') and objcor.t_validtodate = to_date('31.12.9999','dd.mm.yyyy') "+
                       "    and attr.t_attrid = objcor.t_attrid and attr.t_groupid = objcor.t_groupid and attr.t_objecttype = objcor.t_objecttype "+
                       check_category_str;
   var cmd_category = RSDCommand(sql_category);
   cmd_category.Addparam("partyid", RSDBP_IN, Party.PartyID);
   var rs_category = RSDRecordSet(cmd_category);
   Category_temp = NULL;
   while (rs_category.movenext)
      Category_temp = c_PartyCategory;
      Category_temp.GroupID = rs_category.value("t_groupid");
      Category_temp.AttrID = rs_category.value("t_attrid");
      Category_temp.Value = rs_category.value("t_numinlist");
      PartyCategory_arr.value(ac) = Category_temp;
      ac = ac + 1;
      Category_temp = NULL;
   end;
   rs_category.close;
   cmd_category.close; 
   
   
   IsFound = false;
   var Category_exist;
   for (Category_exist, PartyCategory_arr)
      IsFound = false;
      for (Category_temp, Categories)
         if ( (Category_exist.GroupID == Category_temp.GroupID) and (Category_exist.Value == Category_temp.Value) )
            IsFound = true;
            break;
         end;
      end;
      if (not IsFound)
         stat = ObjCat.DisconnectAttr(Category_exist.GroupID, Category_exist.AttrID);
      end;
   end;
   
   if(stat == 0)
      stat = ObjCat.Save(ObjID);
   end;
   
   g_res.NeedUpdate = g_need_update;

onError(err)
   g_res.ErrorCode = err.code;
   g_res.ErrorDesc = err.message;
   g_res.NeedUpdate = g_need_update;
   if (g_trn)
      AbortTrn;
   end;
end;


/**
@brief Обновить субъекта входящими данными
@param[in] IncomeData объект adp_CdiGetOrg
@param[in] p_PartyID ID субъекта
@param[in] UseTransaction  Признак необходимости внутренней транзакции, если false - транзакция уже начата снаружи 
@return объект c_UpdateParty_needupdate
*/
macro UpdateParty_ByCDI(IncomeData, p_PartyID, UseTransaction)
   var error;
   
   if (ValType(UseTransaction) == V_UNDEF)
      UseTransaction = false;
   end;

   g_trn = UseTransaction;
   
   ProcessParty.IncomeData = IncomeData;
   ProcessParty.PartyID = p_PartyID;
   
   if (UseTransaction)
      ProcessTrn(0, "UpdateParty_ByCDI_trn");
   else 
      UpdateParty_ByCDI_trn();
   end;
      
   return g_res;
end;


/**
@brief Сформировать класс адреса
@param[in] p_Party объект RSBParty
@param[in] p_address_type Тип адреса
@return Сформированный объект класса c_Address или NULL, если адреса нет

Считаем, что p_Party и p_address_type корректные и существуют
*/
//DEF-59120 единое заполнение для CdiCreate и CdiUpdate
macro FormAddressObj(p_Party, p_address_type, pCode_Cdi, ptypefunc)
   var res_Adress;
   if (ptypefunc == "UPDATE")
      res_Adress = c_Address_UpdateOrg;
   else 
      res_Adress = c_Address_CDI;
   end;
   var address_temp;
   
   address_temp = p_Party.Address(p_address_type);

   if (address_temp.AddressType == 0) // такого типа адреса нет
      return null;
   end;
   if (p_address_type == 1)
      res_Adress.AddressType = c_IntegrDictRec;
      res_Adress.AddressType.RecordCode = "CORP"; // юридический
   elif (p_address_type == 2)
      res_Adress.AddressType = c_IntegrDictRec;
      res_Adress.AddressType.RecordCode = "FACT"; // фактический
   elif (p_address_type == 3)
      res_Adress.AddressType = c_IntegrDictRec;
      res_Adress.AddressType.RecordCode = "POST"; // почтовый
   elif (p_address_type == 5)
      res_Adress.AddressType = c_IntegrDictRec;
      res_Adress.AddressType.RecordCode = "CORP_CHARTER"; // Место нахождения (по учр.документам)
   else 
      return null;
   end;

   if (not address_temp)
      return null;
   end;

   if (address_temp.Address != "")
      res_Adress.AddressLine  = address_temp.Address;
   end;
   if (address_temp.PostIndex != "")
      res_Adress.PostalCode   = address_temp.PostIndex;
   end;
   if (address_temp.Region != "")
      res_Adress.RegionName   = address_temp.Region;
   end;
   if (address_temp.Province != "")
      res_Adress.AreaName     = address_temp.Province;
   end;
   if (address_temp.Place != "")
      res_Adress.PlaceName    = address_temp.Place;
   end;
   if (address_temp.District != "")
      res_Adress.CityName     = address_temp.District;
    end;
   if (address_temp.Street != "")
     res_Adress.StreetName   = address_temp.Street;
   end;
   if (address_temp.House != "")
      res_Adress.House        = address_temp.House;
   end;
   if (address_temp.NumCorps != "")
      res_Adress.Hcase        = address_temp.NumCorps;
   end;
   if (address_temp.plan != "")
      res_Adress.StructureName= address_temp.plan;
   end;
   if (address_temp.building != "")
      res_Adress.Block        = address_temp.building;
   end;
   if (address_temp.OKTMO != "")
      res_Adress.OKTMO        = address_temp.OKTMO;
   end;
   if (address_temp.Flat != "")
      res_Adress.Flat         = address_temp.Flat;
   end;
   if (address_temp.Kladr != "")
      res_Adress.KladrId      = address_temp.Kladr;
   end;
   if (address_temp.FiasGuid != "")
      res_Adress.FiasGuid     = address_temp.FiasGuid;
   end;
   
   if (address_temp.Country != "")
      res_Adress.Country                  = c_IntegrDictRec;
      res_Adress.Country.RecordCode       = address_temp.Country;
   end;
   if (address_temp.coderegion != "")
      res_Adress.RegionType               = c_IntegrDictRec;
      res_Adress.RegionType.RecordCode    = address_temp.coderegion;
   end;
   if (address_temp.CodeProvince != "")
      res_Adress.AreaType                 = c_IntegrDictRec;
      res_Adress.AreaType.RecordCode      = address_temp.CodeProvince;
   end;
   if (address_temp.CodePlace != "")
      res_Adress.PlaceType                = c_IntegrDictRec;
      res_Adress.PlaceType.RecordCode     = address_temp.CodePlace;
   end;
   if (address_temp.CodeDistrict != "")
      res_Adress.CityType                 = c_IntegrDictRec;
      res_Adress.CityType.RecordCode      = address_temp.CodeDistrict;
   end;
      if (address_temp.CodeStreet != "")
      res_Adress.StreetType               = c_IntegrDictRec;
      res_Adress.StreetType.RecordCode    = address_temp.CodeStreet;
   end;
   if (address_temp.codeplan != "")
      res_Adress.StructureType            = c_IntegrDictRec;
      res_Adress.StructureType.RecordCode = address_temp.codeplan;
   end;
   
   // обязательные поля
   res_Adress.Active = "YES";
   res_Adress.LastUpdateDate = dttm(date(),time());
   res_Adress.SourceSystemCode = c_IntegrDictRec;
   res_Adress.SourceSystemCode.RecordCode = NAME_SYSTEM;
   res_Adress.SourceSystemId = c_IntegrSymId;
   res_Adress.SourceSystemId.Objectid = String(p_Party.PartyID,p_address_type); // в dadress_dbt нет id, уникальный индекс по partyid + type
   res_Adress.SourceSystemPartyId = c_IntegrSymId;
   res_Adress.SourceSystemPartyId.Objectid = p_Party.PartyID;
   if (ptypefunc == "UPDATE")
      res_Adress.PartyId = c_IntegrSymId;
      res_Adress.PartyId.ObjectId = pCode_Cdi;
   end;
   
   return res_Adress;

end;


/**
@brief Контакт для обновления
*/
class c_Contact_UpdateOrg()
   var ContactValue  : string = "";   // Значение контакта                         Да
   var Description   : string = "NULL";   // Комментарий                               Нет
   var MainContact   : string = "YES";     // Признак основного контакта                
   var ActiveContact : string = "YES";    // Признак действующего                      Нет
   var Status        : string = "NULL";   // Статус                                    Нет
   var Active        : string = "YES";    // Признак действующего                      Нет
   var LastUpdateDate: datetime = dttm(date(),time()); // Дата и время последнего изменения записи  Да
   var SourceSystemCode;
   var SourceSystemId;
   var PartyId;
   var ContactType      ;        // Тип контакта                              Нет   Справочник
   var ContactDetailType;        // Тип контакта (детально)                   Нет   Справочник
   var ContactId	      ;        // Идентификатор в CDI                       Да    Идентификатор
   var SourceSystemPartyId;
end;

/**
@brief Контакт для создания
*/

class c_Contact_CDI()
   var ContactValue                 : string   = "";       // Значение контакта
   var Description                  : string   = "NULL";   // Комментарий
   var MainContact                  : string   = "YES";   // Признак основного контакта
   var ActiveContact                : string   = "YES";   // Признак действующего
   var Status                       : string   = "NULL";   // Статус
   var Active                       : string   = "YES";   // Признак активности записи
   var LastUpdateDate               : datetime = dttm(date(),time()); // Дата и время последнего изменения записи
   var SourceSystemCode             : c_IntegrDictRec;   //Система источник
   var SourceSystemPartyId          : c_IntegrSymId; //Идентификатор субъекта в системе источнике
   var ContactType                  : c_IntegrDictRec;   //Тип контакта
   var ContactDetailType            : c_IntegrDictRec;   //Тип контакта (детально)
   var SourceSystemId               : c_IntegrSymId; //Идентификатор в системе источнике
end;


/**
@brief Заполнение структуры контакта
@param[in] pPartyContact  объект RSBPartyContact
@return объект c_Contact_UpdateOrg
*/
//DEF-59120 единое заполнение для CdiCreate и CdiUpdate
macro CDI_FillContact(pPartyContact, pCode_Cdi, pPartyID, ptypefunc)
   var res;
   
   if (ptypefunc == "UPDATE")
      res = c_Contact_UpdateOrg;
   else 
      res = c_Contact_CDI;
   end;
   res.ContactValue  = pPartyContact.Value;
   res.Description   = "NULL";
   if (pPartyContact.IsMain)
      res.MainContact = "YES";
   else
      res.MainContact = "NO";
   end;
//   res.MainContact = "NULL"; // единственный контакт каждого типа обязательно будет "основным", что может не совпасть с CDI
   res.ActiveContact = "YES";
   res.Status        = "NULL";
   res.Active        = "YES";
   res.LastUpdateDate = dttm(date(),time());
   res.SourceSystemCode = c_IntegrDictRec;
   res.SourceSystemCode.RecordCode = NAME_SYSTEM;
   res.SourceSystemId = c_IntegrSymId;
   res.SourceSystemId.Objectid = pPartyContact.RecID;
   res.SourceSystemPartyId = c_IntegrSymId;
   res.SourceSystemPartyId.Objectid = pPartyID;

   res.ContactType =  c_IntegrDictRec;
   res.ContactDetailType =  c_IntegrDictRec;
   if (pPartyContact.ContactKind == CNTK_PHONE)
      res.ContactType.RecordCode =  "PHONE";
      if ( pPartyContact.ContactType == CNTT_WORKING ) 
         res.ContactDetailType.RecordCode =  "WORK";
      else
         res.ContactDetailType.RecordCode =  "HOME";
      end;
   elif ( pPartyContact.ContactKind == CNTK_EMAIL )
      res.ContactType.RecordCode =  "MAIL";
      if ( (pPartyContact.ContactType == CNTT_WORKING) or (pPartyContact.ContactType == ADD_CNTT_WORKING) ) //DEF-59120
         res.ContactDetailType.RecordCode =  "WORK";
      else 
         res.ContactDetailType.RecordCode =  "HOME";
      end;
   end;
   
   if (ptypefunc == "UPDATE")
      res.ContactId     = c_IntegrSymId;
      res.ContactId.ObjectID = "NULL";
      res.PartyId = c_IntegrSymId;
      res.PartyId.ObjectId = pCode_Cdi;
   end;
   
   return res;
end;

