/**
 @file 		uentcompare_pan.mac
 @brief 	Интеграция с внешними системами. Далоговое окно для отчета-сверки счетов и проводок, выгруженных в ЦФТ из СОФР

 # tag
 - functional_block: Отчетность_внутренняя
 - code_type: Report

*/

import RsbFormsInter, globals, Календарь, oralib, likepy, cb_sql;
import "uentcompare_rep.mac", "uacctcompare_rep.mac", "load_entcompare.mac", "load_acctcompare.mac", "usr_table_int.mac", "u_common_email_utils.mac";
import "uentcompare_param.mac";

private const CV_EMAIL_GRP_ETCOMPARE = 3; //группа сверки проводок загруженных в ЦФТ из СОФР

private const FT_STRING = 7,
              FT_INTEGER = 1,
              FT_DOUBLE = 4,
              FT_DATE = 9,
              FT_MONEY = 25;

var ExitCode :integer,
    DateRep :date = {CurDate};
private var minDate: date = date(0,0,0);



private class (c_usr_tbl_base) c_usr_tbl_uTableProcessEvent()
   private class gen_uTableProcessEvent()
      var T_RECID :integer,
          T_TIMESTAMP :date,
          T_OBJECTTYPE :integer,
          T_OBJECTID :integer,
          T_TYPE :integer,
          T_STATUS :integer,
          T_NOTE :string,
          T_MESSAGEID :integer,
          T_RESULTCODE :string,
          T_RESULTTEXT :string;
   end;

   private macro init_table_obj()
      new_val_obj = gen_uTableProcessEvent();
      where_val_obj = gen_uTableProcessEvent();
   end;

   Initc_usr_tbl_base("uTableProcessEvent_dbt");

   init_table_obj();
end;


private class TAcctVerify( StrParam :string )
var Account :string = "";
end;

//класс вызываемых параметров ProcessEvent
class TParamProcessAcctVerify( StrParam :string )
var    Acct :TArray,
       RecId :integer = 0,
       ObjectType :integer = 0,
       ProcessType :integer = 0,
       RestDate :date = date("00.00.00"),
       ProcessStatus :integer = 0;

   private var StrSeparator :string = ";";


   private macro GetDateStr( StrBuf :string, DateSeparator :string) :string

    StrBuf = Substr( StrBuf, 1, 2 ) + DateSeparator + Substr( StrBuf, 3, 2 ) + DateSeparator + Substr( StrBuf, 5, 4 );
    return StrBuf;

   end;


   private macro InitParam( StrParam :string )
      var StrDigit :string = "0123456789",
          StrParamBuf :string = "",
          i :integer = 0,
          StrPos :integer = 0,
          StrParamAcc :string = "",
          StrAcc :string = "Acc",
          SymbOpen :string = "[",
          SymbClose :string = "]",
          AcctVerify :TAcctVerify;

//1689731;5008;[Acc47421810400002000002;Acc47407840399000000002]1;14.05.2019;;2
      if( (Valtype(StrParam) != V_UNDEF) and (Valtype(StrParam) != 26) and (StrParam != "") )

         i = 1;
         StrPos = 0;
         while( i <= StrLen(StrParam) ) //Вырезать часть со спец. разделителями

          if( (StrPos > 0) and ( Substr(StrParam, i, 1) != SymbClose ) )
           StrParamAcc = StrParamAcc + Substr(StrParam, i, 1);
          end;

          if( Substr(StrParam, i, 1) == SymbOpen )
           StrPos = i;
          end;

          if( Substr(StrParam, i, 1) == SymbClose )
           StrPos = -1;
          end;

          if( ((StrPos == 0 ) or (StrPos == -1)) and (Substr(StrParam, i, 1) != SymbOpen) and (Substr(StrParam, i, 1) != SymbClose) )
            StrParamBuf = StrParamBuf + Substr(StrParam, i, 1);
          end;
          i = i + 1;

         end;

         StrParam = StrParamBuf;
         StrParamBuf = "";


         i = 1;
         while( i <= StrLen(StrParam) ) //нормализация оставить, что только цифры или разделитель

            if( Index( (StrDigit + StrSeparator), Substr(StrParam, i, 1) ) >= 1 )
               StrParamBuf = StrParamBuf + Substr(StrParam, i, 1);
            end;
            i = i + 1;

         end;

         i = 1;
         while( (StrLen(StrParamBuf) > 0) and (GenNumProps(this) > i + 1) ) //заполняем свойства со второго
            StrPos = Index( StrParamBuf, StrSeparator );
            if( StrPos > 1 )
               if( ValType(this[i]) == V_DATE )
                this[i] =  date( GetDateStr( Substr(StrParamBuf, 1, StrPos - 1), "." ) );
               else
                this[i] =  int(Substr(StrParamBuf, 1, StrPos - 1));
               end;

               StrParamBuf = Substr(StrParamBuf, StrPos + 1);
            elif( (StrPos == 0) and (StrLen(StrParamBuf) > 0) )
               if( ValType(this[i]) == V_DATE )
                this[i] = date( GetDateStr( StrParamBuf, "." ) );
               else
                this[i] = int(StrParamBuf);
               end;
               StrParamBuf = "";
            end;
            i = i + 1;

         end;


         i = 0;
         Acct = Null;
         while( (StrLen(StrParamAcc) > 0) ) //заполняем спец. свойства
            StrPos = Index( StrParamAcc, StrSeparator );
            if( StrPos > 1 )
              StrParamBuf = Substr(StrParamAcc, 1, StrPos - 1);
              if( Index( StrParamBuf, StrAcc ) )
               AcctVerify = Null;
               AcctVerify = TAcctVerify();
               AcctVerify.Account = StrSubst( StrParamBuf, StrAcc, "" );
               if( Acct == Null )
                Acct = TArray();
               end;
               Acct[Acct.Size] =  AcctVerify;
              end;

              StrParamAcc = Substr(StrParamAcc, StrPos + 1);
            elif( (StrPos == 0) and (StrLen(StrParamAcc) > 0) )
              StrParamBuf = StrParamAcc;
              if( Index( StrParamBuf, StrAcc ) )
               AcctVerify = Null;
               AcctVerify = TAcctVerify();
               AcctVerify.Account = StrSubst( StrParamBuf, StrAcc, "" );
               if( Acct == Null )
                Acct = TArray();
               end;
               Acct[Acct.Size] =  AcctVerify;
              end;
              StrParamBuf = "";
              StrParamAcc = "";
            end;
            i = i + 1;

         end;

      end;

   onError(err)

      RecId = 0;
      ObjectType = 0;
      ProcessStatus = 0;


   end;

   InitParam( StrParam );

end;





//панель параметров фильтра
class (TRsbPanel) UserAcctFilterPanel( Acct_ :object )
var Acct :TAcctVerify = TAcctVerify;

  if( ValType(Acct_) != V_UNDEF )
   Acct = Acct_;
  end;

  InitTRsbPanel();
  SetCaption("Параметры проводки");
  SetStatus("~F9~ Сохранить ~Esc~ Отмена");
  SetSize(38,4);
  SetPosition(40,1);



 var AccLabel :TRsbLabel = TRsbLabel(3, 2, "Счет");
     addLabel(AccLabel);

 var AccEdFld :TRsbEditField = TRsbEditField(FT_STRING);
     AccEdFld.setPosition(12,2);
     AccEdFld.setSize(25,1);
     AccEdFld.TextLength = 25;
     AccEdFld.Name = "AccEdFld";
     if( ValType(Acct_) != V_UNDEF )
      AccEdFld.value = Acct.Account;
     else
      AccEdFld.value = "";
     end;
     addControl(AccEdFld);


  AddEventHandler(RSB_EV_KEY_PRESSED, R2M(this, "onKeyPressed"));

  macro onKeyPressed(RsbEvent:Object)

   if( RsbEvent.KeyCode == 323 )  //F9
//Добавить элемент вернуть код 323!!!!!!!
    if( ValType(AccEdFld.value) == V_UNDEF )
     Acct.Account = "-1";
    else
     Acct.Account = AccEdFld.value;
    end;

    this.Close(RsbEvent.KeyCode);
   elif( RsbEvent.KeyCode == 27 )  //Esc
    this.Close(RsbEvent.KeyCode);
   end;

  end;

end;
//панель параметров фильтра



//панель параметров фильтра
class (TRsbPanel) UserEntFilterPanel( Entry_ :object )
var Entry :TAccEntriesVerify = TAccEntriesVerify;

  if( ValType(Entry_) != V_UNDEF )
   Entry = Entry_;
  end;

  InitTRsbPanel();
  SetCaption("Параметры проводки");
  SetStatus("~F9~ Сохранить ~Esc~ Отмена");
  SetSize(38,8);
  SetPosition(40,1);



 var AccDLabel :TRsbLabel = TRsbLabel(3, 2, "Счет дебет");
     addLabel(AccDLabel);

 var AccDEdFld :TRsbEditField = TRsbEditField(FT_STRING);
     AccDEdFld.setPosition(12,2);
     AccDEdFld.setSize(25,1);
     AccDEdFld.TextLength = 25;
     AccDEdFld.Name = "AccDEdFld";
     if( ValType(Entry_) != V_UNDEF )
      AccDEdFld.value = Entry.PayerAccount;
     else
      AccDEdFld.value = "";
     end;
     addControl(AccDEdFld);


 var AccCLabel :TRsbLabel = TRsbLabel(3, 4, "Счет кредит");
     addLabel(AccCLabel);

 var AccCEdFld :TRsbEditField = TRsbEditField(FT_STRING);
     AccCEdFld.setPosition(12,4);
     AccCEdFld.setSize(25,1);
     AccCEdFld.TextLength = 25;
     AccCEdFld.Name = "AccCEdFld";
     if( ValType(Entry_) != V_UNDEF )
      AccCEdFld.value = Entry.ReceiverAccount;
     else
      AccCEdFld.value = "";
     end;
     addControl(AccCEdFld);

 var PersNLabel :TRsbLabel = TRsbLabel(3, 6, "Табельный номер сотрудника");
     addLabel(PersNLabel);

 var PersNEdFld :TRsbEditField = TRsbEditField(FT_STRING);
     PersNEdFld.setPosition(22,6);
     PersNEdFld.setSize(15,1);
     PersNEdFld.TextLength = 15;
     PersNEdFld.Name = "PersNEdFld";
     if( ValType(Entry_) != V_UNDEF )
      PersNEdFld.value = Entry.PersN;
     else
      PersNEdFld.value = "";
     end;
     addControl(PersNEdFld);


  AddEventHandler(RSB_EV_KEY_PRESSED, R2M(this, "onKeyPressed"));

  macro onKeyPressed(RsbEvent:Object)

   if( RsbEvent.KeyCode == 323 )  //F9
//Добавить элемент вернуть код 323!!!!!!!
    if( (ValType(PersNEdFld.value) == V_UNDEF) and ( ValType(AccDEdFld.value) == V_UNDEF ) and ( ValType(AccCEdFld.value) == V_UNDEF ) )
     Entry.PayerAccount = "-1";
     Entry.ReceiverAccount = "-1";
     Entry.PersN = "-1";
    else
     Entry.PayerAccount = AccDEdFld.value;
     Entry.ReceiverAccount = AccCEdFld.value;
     Entry.PersN = PersNEdFld.value;
    end;

    this.Close(RsbEvent.KeyCode);
   elif( RsbEvent.KeyCode == 27 )  //Esc
    this.Close(RsbEvent.KeyCode);
   end;

  end;

end;
//панель параметров фильтра



private macro BoolToInt( Vl_Bool :bool ) :integer

 if( Vl_Bool )
  return 1;
 else
  return 0;
 end;

end;

private macro AddColumn( ar:@TArray, ind, fld, head, width, fldType, DecPoint )
 ar.value( ind * 6 + 0 ) = fld; //FieldName
 ar.value( ind * 6 + 1 ) = head; //Header
 ar.value( ind * 6 + 2 ) = width; //Null //Width
 ar.value( ind * 6 + 3 ) = fldType; //fldType //2 = FBT
 ar.value( ind * 6 + 4 ) = DecPoint; //Null //DecPoint
 ar.value( ind * 6 + 5 ) = 0; //reserve
end;


private macro InsUserEvent( ObjectType :integer, ObjectId :integer, PocessType :integer, Status :integer, EventParam :string  ) :integer
var Query :string = "",
    cmd,
    ReqId :integer = 0;

 Query = " DECLARE " +
         "  v_ObjectType      utableprocessevent_dbt.T_OBJECTTYPE%TYPE := :p_ObjectType; " +
         "  v_ObjectId        utableprocessevent_dbt.T_OBJECTID%TYPE := :p_ObjectId; " +
         "  v_PocessType      utableprocessevent_dbt.T_TYPE%TYPE := :p_PocessType; " +
         "  v_Status          utableprocessevent_dbt.T_STATUS%TYPE := :p_Status; " +
         "  v_EventParam      utableprocessevent_dbt.T_PARAM%TYPE := :p_EventParam; " +
         "  v_RecId           utableprocessevent_dbt.T_PARAM%TYPE := :p_RecId; " +
         " BEGIN " +
         "  BEGIN " +
         
         "   INSERT INTO utableprocessevent_dbt( T_TIMESTAMP, T_OBJECTTYPE, T_OBJECTID, T_TYPE, T_STATUS, T_PARAM) " +
         "   VALUES( SYSDATE, v_ObjectType, v_ObjectId, v_PocessType, v_Status, v_EventParam) RETURNING T_RECID INTO v_RecId; " +

         "   :p_RecId := v_RecId; " +
/*
 Values(1689731, SYSDATE, 5009, 1, 1, 11 )
*/
           
         "  EXCEPTION " +
         "   WHEN OTHERS THEN " +
         "   BEGIN " +

         "    :p_RecId := -1; " +

         "   END; " +
         "  END; " +

         " END; ";

 cmd = RSDCommand( Query );
 cmd.AddParam( "p_ObjectType", RSDBP_IN, ObjectType );
 cmd.AddParam( "p_ObjectId", RSDBP_IN, ObjectId );
 cmd.AddParam( "p_PocessType", RSDBP_IN, PocessType );
 cmd.AddParam( "p_Status", RSDBP_IN, Status );
 cmd.AddParam( "p_EventParam", RSDBP_IN, EventParam );
 cmd.AddParam( "p_RecId", RSDBP_OUT, V_INTEGER );
 cmd.execute();

 if( ( ValType(cmd.value("p_RecId")) ==  V_UNDEF ) or ( ValType(cmd.value("p_RecId")) ==  26 ) or ( cmd.value("p_RecId") ==  -1 ))
  ReqId = 0;
 else
  ReqId = cmd.value("p_RecId");
 end;
 cmd.Close;


 return ReqId;


onError(err)

 return -1;

end;

//Заполняем доп. параметры Request из массива фильтра
private macro GetStrAddParamAcct( AcctList  :TArray ) :string
const ACCT_STR = "Acc",
      BEGIN_STR = "[",
      END_STR = "]",
      SEPARATOR = ";";
//Str_Param = "1689731;5008;[Acc47421810400002000002;Acc47407840399000000002]1;14.05.2019;2";
var Str_Param :string = "",
    i :integer = 0,
    fl_first_str :bool = false;

 if( (ValType( AcctList ) == V_UNDEF) or ( AcctList.Size == 0 ) )
  Str_Param = "";
 else

  while( i < AcctList.Size )
   if( AcctList[i].Account != "-1" ) //признак неудаленного элемента массива

    if( fl_first_str )
     Str_Param = Str_Param + SEPARATOR;
    else
     fl_first_str = true;
     Str_Param = BEGIN_STR;
    end;

    Str_Param = Str_Param + ACCT_STR + AcctList[i].Account;

   end;
   i = i + 1;
  end;

  if( Str_Param != "" )
   Str_Param = Str_Param + END_STR;
  end;


 end;

 return Str_Param;

end;


//Заполняем доп. параметры Request из массива фильтра
private macro GetStrAddParamEntry( EntryList  :TArray ) :string
const ACCD_STR = "AccD",
      ACCC_STR = "AccC",
      PERSN_STR = "PersN",
      BEGIN_STR = "[",
      END_STR = "]",
      SEPARATOR = ";";
//Str_Param = "1689731;5009;[AccD47421810400002000002;AccC;AccD;AccC47407840399000000002]1;14.05.2019;00.00.00;2";
var Str_Param :string = "",
    i :integer = 0,
    fl_first_str :bool = false;

 if( (ValType( EntryList ) == V_UNDEF) or ( EntryList.Size == 0 ) )
  Str_Param = "";
 else

  while( i < EntryList.Size )
   if( ( EntryList[i].PersN != "-1" ) and ( EntryList[i].PayerAccount != "-1" ) and ( EntryList[i].ReceiverAccount != "-1" ) ) //признак неудаленного элемента массива

    if( fl_first_str )
     Str_Param = Str_Param + SEPARATOR;
    else
     fl_first_str = true;
     Str_Param = BEGIN_STR;
    end;

    Str_Param = Str_Param + PERSN_STR + EntryList[i].PersN + SEPARATOR + ACCD_STR + EntryList[i].PayerAccount + SEPARATOR + ACCC_STR + EntryList[i].ReceiverAccount;

   end;
   i = i + 1;
  end;

  if( Str_Param != "" )
   Str_Param = Str_Param + END_STR;
  end;


 end;

 return Str_Param;

end;



//получим параметры актуального Request загруженных проводок по параметрам Rrequest счета
private macro GetEntryParamByReqAcc( ParamProcess :object, ParamProcessEntrActualyReq :@object ) :bool
var Query :string = "",
    DataSet :RsdRecordset,
    Params :TArray;



  Query = " SELECT A.T_RECID, A.T_PARAM FROM utableprocessevent_dbt A " +
          " WHERE A.T_RECID = " +
          "  ( SELECT MAX(T_RECID) FROM  utableprocessevent_dbt B " +
          "    WHERE B.T_OBJECTTYPE = :p_ObjType " +
          "     AND B. T_OBJECTID = :p_ObjId " +
          "     AND B.T_STATUS = :p_Status " +
          "     AND B.T_PARAM = :p_Param ) ";
  Params = makeArray( SQLParam( "p_ObjType", 5009 ),
                      SQLParam( "p_ObjId", 1 ),
                      SQLParam( "p_Status", 4 ),
                      SQLParam( "p_Param", "1;" + StrSubst( string(ParamProcess.RestDate):10, " ", "0" ) + ";" + StrSubst( string(ParamProcess.RestDate):10, " ", "0" ) ) ); 
  DataSet = execSQLselect( Query, Params );


  if( DataSet.MoveNext )
   ParamProcessEntrActualyReq = TParamProcessEntriesVerify( string( DataSet.value(0) )  + ";" +  "5009" + ";" + DataSet.value(1) + ";4"); //установить статус 4
   return true;
  end;

  return false;

onError(err)

  return false;

end;



//из массива объектов формируем SQL-строку
private macro GetSQLStrFromArray( ParamProcess :object );
const BEGIN_SQL_STR = " SELECT ",
      END_SQL_STR = " FROM DUAL ",
      SEPARATOR = ", ";

var Query :string = "",
    i :integer = 0,
    fl_first_str :bool = false;

              
 if( (ValType( uTryToGetPropS( ParamProcess, "Acct" ) ) == V_UNDEF) or (ValType( ParamProcess.Acct ) == V_UNDEF) or ( ParamProcess.Acct.Size == 0 ) )
  Query = " SELECT -1 AS ID, '' AS ACC FROM DUAL ";
 else

  while( i < ParamProcess.Acct.Size )
   if( ParamProcess.Acct[i].Account != "-1" ) //признак неудаленного элемента массива

    if( fl_first_str )
     Query = Query + " UNION ALL ";
    else
     fl_first_str = true;
    end;

    Query = Query + BEGIN_SQL_STR + string(i) + " AS ID" + SEPARATOR + GetSQLString( ParamProcess.Acct[i].Account ) + " AS ACC" + END_SQL_STR;
   end;
   i = i + 1;
  end;

 end;

 if( Query == "" )
  Query = " SELECT -1 AS ID, '' AS ACC FROM DUAL "; //все элементы были удалены
 end;

 Query = Query + " ORDER BY 1";

 return Query;

end;


private macro GetSQLStrFromArrayAcct( AcctList :TArray );
const BEGIN_SQL_STR = " SELECT ",
      END_SQL_STR = " FROM DUAL ",
      SEPARATOR = ", ";

var Query :string = "",
    i :integer = 0,
    fl_first_str :bool = false;


 if( (ValType( AcctList ) == V_UNDEF) or ( AcctList.Size == 0 ) )
  Query = " SELECT -1, '', '' FROM DUAL ";
 else

  while( i < AcctList.Size )
   if( AcctList[i].Account != "-1" ) //признак неудаленного элемента массива

    if( fl_first_str )
     Query = Query + " UNION ALL ";
    else
     fl_first_str = true;
    end;

    Query = Query + BEGIN_SQL_STR + string(i) + " AS ID" + SEPARATOR + GetSQLString( AcctList[i].Account ) + " AS ACC" + END_SQL_STR;
   end;
   i = i + 1;
  end;

 end;

 if( Query == "" )
  Query = " SELECT -1, '', '' FROM DUAL "; //все элементы были удалены
 end;

 Query = Query + " ORDER BY 1";

 return Query;

end;


private macro GetSQLStrFromArrayEnt( EntryList :TArray );
const BEGIN_SQL_STR = " SELECT ",
      END_SQL_STR = " FROM DUAL ",
      SEPARATOR = ", ";

var Query :string = "",
    i :integer = 0,
    fl_first_str :bool = false;


 if( (ValType( EntryList ) == V_UNDEF) or ( EntryList.Size == 0 ) )
  Query = " SELECT -1, '', '' FROM DUAL ";
 else

  while( i < EntryList.Size )
   if( ( EntryList[i].PersN != "-1" ) and ( EntryList[i].PayerAccount != "-1" ) and ( EntryList[i].ReceiverAccount != "-1" ) ) //признак неудаленного элемента массива

    if( fl_first_str )
     Query = Query + " UNION ALL ";
    else
     fl_first_str = true;
    end;

    Query = Query + BEGIN_SQL_STR + string(i) + " AS ID" + SEPARATOR + GetSQLString( EntryList[i].PersN ) + " AS PERSN" + SEPARATOR + GetSQLString( EntryList[i].PayerAccount ) + " AS ACC_D" + SEPARATOR + GetSQLString( EntryList[i].ReceiverAccount ) + " AS ACC_C" + END_SQL_STR;
   end;
   i = i + 1;
  end;

 end;

 if( Query == "" )
  Query = " SELECT -1, '', '' FROM DUAL "; //все элементы были удалены
 end;

 Query = Query + " ORDER BY 1";

 return Query;

end;

//в цикле дергаем загрузку SQL Loader
private macro LoopLoad /*LoadEntryForCompare*/( Mode :integer, CntLoop :integer, File_Path :string, ReqId :string, Fl_SetDialog :integer ) :bool
var Query :string = "",
    Params :TArray,
    DataSet :RsdRecordset,
    v_email_processor,
    i :integer
    , x_Flag :integer = 1 // DEF-76687 загрузка файла по формату 1 (с доп.полями), если будет неудачно, то загрузка по формату 0
  ;

  if( ( ValType( CntLoop ) == V_UNDEF ) or ( ValType( CntLoop ) == 26 ) )
   CntLoop = 0;
  end;

  for( i, 0, CntLoop, 1)

   if( ( Mode == 0 ) and ( LoadAcctForCompare(File_Path, ReqId, Fl_SetDialog ) ) or
    ( Mode == 1 ) and ( LoadEntryForCompare(File_Path, ReqId, Fl_SetDialog, x_Flag ) ) )

    if( Mode == 0 )
     Query = " SELECT COUNT(1) FROM uloadaccforcompare_dbt WHERE T_REQID = :p_ReqId";
    else
     Query = " SELECT COUNT(1) FROM uloadentforcompare_dbt WHERE T_REQID = :p_ReqId";
    end;

    Params = makeArray( SQLParam("p_ReqId", ReqId) );
    DataSet = execSQLselect( Query, Params );

    if( ( DataSet.MoveNext ) and ( DataSet.value(0, Null, V_INTEGER) > 0 ) )
     return true;
    elif( i == CntLoop)

     if( Fl_SetDialog == 1 )
      MsgBox("Ошибка загрузки файла " + File_Path + " .");
     end;

     //отправляем в почту
     v_email_processor = Null;
     v_email_processor = c_email_proc_env();
     v_email_processor.m_set_msg_head("СОФР - Отчет результат сверки счетов и проводок загруженных в ЦФТ из СОФР.");
     v_email_processor.m_add_row_to_msg_text("Ошибка загрузки файла " + File_Path + " ." );
     v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_ETCOMPARE, true);
     v_email_processor.m_submit_email_synch();
     v_email_processor = Null;
     //отправляем в почту

     return false;
    end;

   elif(( Mode == 1 ) and (x_Flag == 1))
     // DEF-76687, ошибка загрузки по формату 1, пробуем загружать по формату 0
     x_Flag = 0;

   else
     if( Fl_SetDialog == 1 )
      MsgBox("Ошибка загрузки файла " + File_Path + " .");
     end;

     //отправляем в почту
     v_email_processor = Null;
     v_email_processor = c_email_proc_env();
     v_email_processor.m_set_msg_head("СОФР - Отчет результат сверки счетов и проводок загруженных в ЦФТ из СОФР.");
     v_email_processor.m_add_row_to_msg_text("Ошибка загрузки файла " + File_Path + " ." );
     v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_ETCOMPARE, true);
     v_email_processor.m_submit_email_synch();
     v_email_processor = Null;
     //отправляем в почту

    return false;
   end;


  end; // loop

  return true;

end;


//листалка фильтра
private macro AcctListFilter( AcctList :@object ) :integer
var Query :string = "",
    DataSet :RsdRecordset,
    cmd,
    Column = TArray(),
    UserAcctFilterProcPanel :UserAcctFilterPanel;

  macro EventHandler( rsd, cmd, id, key)

   if( (cmd == DLG_KEY) and (key == 27 ) ) //Esc
    ExitCode = 27;
    return CM_SELECT;
   elif( (cmd == DLG_KEY) and (key == 323 ) ) //F9
    //Вызов панели
    UserAcctFilterProcPanel = UserAcctFilterPanel();
    ExitCode = UserAcctFilterProcPanel.Run;
    if( ExitCode == 323 )
     if( ( ValType( AcctList ) == V_UNDEF ) or ( AcctList[0][0] == "-1" )  )
      AcctList = Null;
      AcctList = TArray();
     end;
     AcctList[AcctList.Size] = UserAcctFilterProcPanel.Acct;
     UserAcctFilterProcPanel.Acct = Null;
    end;
    //Вызов панели
    return CM_SELECT;

   elif( (cmd == DLG_KEY) and (key == 322 ) ) //F8
    //Помечаем элементы массив -1
    if( ( ValType( AcctList ) != V_UNDEF ) and  ( AcctList.Size != 0 ) and ( rsd.value(0) >= 0 ) )
     if( MsgBoxEx( "Удалить строку параметров?", MB_YES+MB_NO, IND_YES, "Предупреждение", "") == IND_YES )
      AcctList[rsd.value(0)].Account = "-1";
      ExitCode == 322;
     end;
    end;

    return CM_SELECT;

   elif( (cmd == DLG_KEY) and (key == 13 ) ) //Enter
    
    if( ( ValType( AcctList ) != V_UNDEF ) and  ( AcctList.Size != 0 ) and ( rsd.value(0) >= 0 ) )
     //Вызов панели
     UserAcctFilterProcPanel = UserAcctFilterPanel( AcctList[rsd.value(0)] );
     ExitCode = UserAcctFilterProcPanel.Run;
     if( ExitCode == 323 )
      AcctList[rsd.value(0)] = UserAcctFilterProcPanel.Entry;
      UserAcctFilterProcPanel.Acct = Null;
     end;
     //Вызов панели
    end;

     //Помечаем элементы массив -1
      //если true то добавляем в массив и взводим флаг обновления
    return CM_SELECT;

   end;

  end;

  //Формируем запрос из массива фильтра
  Query = GetSQLStrFromArrayAcct( AcctList );
  //Формируем запрос из массива фильтра

  AddColumn(@Column, 0, "ACC", "Счет", 35, V_STRING );

  cmd = RsdCommand(Query);

  DataSet = RSDRecordSet( cmd, RSDVAL_CLIENT, RSDVAL_STATIC );
  RunScroll( DataSet, 1, Column, "AcctListFilter", @EventHandler, "Фильтр", "~Esc~ Выход    ~F9~ Добавить    ~Enter~ Изменить    ~F8~ Удалить", true, 2, 8 );
  return ExitCode;
end;
//листалка фильтра


//листалка фильтра
private macro EntryListFilter( EntryList :@object ) :integer
var Query :string = "",
    DataSet :RsdRecordset,
    cmd,
    Column = TArray(),
    UserEntFilterProcPanel :UserEntFilterPanel;

  macro EventHandler( rsd, cmd, id, key)

   if( (cmd == DLG_KEY) and (key == 27 ) ) //Esc
    ExitCode = 27;
    return CM_SELECT;
   elif( (cmd == DLG_KEY) and (key == 323 ) ) //F9
    //Вызов панели
    UserEntFilterProcPanel = UserEntFilterPanel();
    ExitCode = UserEntFilterProcPanel.Run;
    if( ExitCode == 323 )
     if( ( ValType( EntryList ) == V_UNDEF ) or ( EntryList[0][0] == "-1" ) and ( EntryList[0][1] == "-1"  and ( EntryList[0][2] == "-1" ) ) )
      EntryList = Null;
      EntryList = TArray();
     end;
     EntryList[EntryList.Size] = UserEntFilterProcPanel.Entry;
     UserEntFilterProcPanel.Entry = Null;
    end;
    //Вызов панели
    return CM_SELECT;

   elif( (cmd == DLG_KEY) and (key == 322 ) ) //F8
    //Помечаем элементы массив -1
    if( ( ValType( EntryList ) != V_UNDEF ) and  ( EntryList.Size != 0 ) and ( rsd.value(0) >= 0 ) )
     if( MsgBoxEx( "Удалить строку параметров?", MB_YES+MB_NO, IND_YES, "Предупреждение", "") == IND_YES )
      EntryList[rsd.value(0)].PayerAccount = "-1";
      EntryList[rsd.value(0)].ReceiverAccount = "-1";
      EntryList[rsd.value(0)].PersN = "-1";
      ExitCode == 322;
     end;
    end;

    return CM_SELECT;

   elif( (cmd == DLG_KEY) and (key == 13 ) ) //Enter
    
    if( ( ValType( EntryList ) != V_UNDEF ) and  ( EntryList.Size != 0 ) and ( rsd.value(0) >= 0 ) )
     //Вызов панели
     UserEntFilterProcPanel = UserEntFilterPanel( EntryList[rsd.value(0)] );
     ExitCode = UserEntFilterProcPanel.Run;
     if( ExitCode == 323 )
      EntryList[rsd.value(0)] = UserEntFilterProcPanel.Entry;
      UserEntFilterProcPanel.Entry = Null;
     end;
     //Вызов панели
    end;

     //Помечаем элементы массив -1
      //если true то добавляем в массив и взводим флаг обновления
    return CM_SELECT;

   end;

  end;

  //Формируем запрос из массива фильтра
  Query = GetSQLStrFromArrayEnt( EntryList );
  //Формируем запрос из массива фильтра

  AddColumn(@Column, 0, "ACC_D", "Счет дебет", 25, V_STRING );
  AddColumn(@Column, 1, "ACC_C", "Счет кредит", 25, V_STRING );
  AddColumn(@Column, 2, "PERSN", "Табельный номер сотрудника", 35, V_STRING );

  cmd = RsdCommand(Query);

  DataSet = RSDRecordSet( cmd, RSDVAL_CLIENT, RSDVAL_STATIC );
  RunScroll( DataSet, 3, Column, "EntryListFilter", @EventHandler, "Фильтр", "~Esc~ Выход    ~F9~ Добавить    ~Enter~ Изменить    ~F8~ Удалить", true, 2, 8 );
  return ExitCode;
end;
//листалка фильтра


//Скроллинг проводок по счетам с расхождениями
private macro ScrollProcEntryDifference( Acct :string, ParamProcess :object ) :integer
var Query :string = "",
    DataSet :RsdRecordset,
    ParamProcessEntrActualyReq :TParamProcessEntriesVerify,
    cmd,
    Column = TArray(),
    res,
    state :integer = 0;

  macro EventHandler( rsd, cmd, id, key)

   if( (cmd == DLG_KEY) and (key == 27 ) ) //Esc
    ExitCode = 27;
    return CM_SELECT;
   end;

  end;

  if( not GetEntryParamByReqAcc( ParamProcess, @ParamProcessEntrActualyReq ) ) //проверить наличие запроса
   return 27;
  end;



  Query = 
    " with brokAccAccIds as ( "
+"\n"+"     /*Список ID счетов СОФР по свободному БИС*/ "
+"\n"+"     SELECT b.T_ACCOUNTID from dbrokacc_dbt A, DBROKACC_ACC_DBT b WHERE A.T_ACCOUNT = ? /*01*/ AND A.T_AUTOKEY = b.T_BROKACC_KEY "
+"\n"+"   ), "
+"\n"+"   /*Данные сравнения по запросу*/ "
+"\n"+"   reqQuery as ( "
+"\n"+"     SELECT * "
+"\n"+"       FROM uloadentforcompare_dbt C "
+"\n"+"      WHERE C.T_REQID = ? /*02*/ "
+"\n"+"   ), "
+"\n"+"   /*Доп фильтр. Только искомые счета*/ "
+"\n"+"   generalQuery as (  "
+"\n"+"     SELECT * "
+"\n"+"       FROM reqQuery C "
+"\n"+"      WHERE (   C.T_ACCT_DB = ? /*03*/ "
+"\n"+"                 OR C.T_ACCT_CR = ? /*04*/) "
+"\n"+"   ), "
+"\n"+"   mainQuery as (  "
+"\n"+"     SELECT * "
+"\n"+"       FROM generalQuery C "
+"\n"+"      WHERE     NOT EXISTS "
+"\n"+"                    (SELECT 1 "
+"\n"+"                       FROM upmbiscotto_dbt V "
+"\n"+"                      WHERE V.T_BISCOTTOID = C.T_IDBISCOTTO) "
+"\n"+"            AND C.T_ACCTRNID > 0 "
+"\n"+"   ), "
+"\n"+"   mainQueryNeg as (  "
+"\n"+"     SELECT * "
+"\n"+"       FROM generalQuery C "
+"\n"+"      WHERE     NOT EXISTS "
+"\n"+"                    (SELECT 1 "
+"\n"+"                       FROM upmbiscotto_dbt V "
+"\n"+"                      WHERE V.T_BISCOTTOID = C.T_IDBISCOTTO) "
+"\n"+"            AND C.T_ACCTRNID < 0 "
+"\n"+"   ), "
+"\n"+"   mainQueryNegExistNotNull as (  "
+"\n"+"     SELECT * "
+"\n"+"       FROM generalQuery C "
+"\n"+"      WHERE EXISTS( SELECT 1 FROM upmbiscotto_dbt V   "
+"\n"+"                 WHERE V.T_BISCOTTOID = C.T_IDBISCOTTO  "
+"\n"+"                  AND V.T_DOCKIND IN(322, 320) )  "
+"\n"+"            AND C.T_ACCTRNID < 0 "
+"\n"+"            AND C.T_ACCT_DB IS NOT NULL  "
+"\n"+"            AND C.T_ACCT_CR IS NOT NULL  "
+"\n"+"   ), "
+"\n"+"   mainQueryNegExistNotNullNotDock as (  "
+"\n"+"     SELECT * "
+"\n"+"       FROM generalQuery C "
+"\n"+"      WHERE EXISTS( SELECT 1 FROM upmbiscotto_dbt V   "
+"\n"+"                 WHERE V.T_BISCOTTOID = C.T_IDBISCOTTO  "
+"\n"+"                  AND V.T_DOCKIND NOT IN(322, 320) )  "
+"\n"+"            AND C.T_ACCTRNID < 0 "
+"\n"+"            AND C.T_ACCT_DB IS NOT NULL  "
+"\n"+"            AND C.T_ACCT_CR IS NOT NULL  "
+"\n"+"   ), "
+"\n"+"   mainQueryDtCrNotNullNeg as (  "
+"\n"+"     SELECT * "
+"\n"+"       FROM mainQueryNeg C "
+"\n"+"      WHERE C.T_ACCT_DB IS NOT NULL  "
+"\n"+"        AND C.T_ACCT_CR IS NOT NULL  "
+"\n"+"   ), "
+"\n"+"   mainQueryDtCrNotNull as (  "
+"\n"+"     SELECT * "
+"\n"+"       FROM mainQuery C "
+"\n"+"      WHERE C.T_ACCT_DB IS NOT NULL  "
+"\n"+"        AND C.T_ACCT_CR IS NOT NULL  "
+"\n"+"   ), "
+"\n"+"   tableProcessEventReq as ( "
+"\n"+"      SELECT * "
+"\n"+"        FROM utableprocessevent_dbt D "
+"\n"+"       WHERE     D.T_OBJECTTYPE IN (1, 501) "
+"\n"+"             AND D.T_TYPE = 1 "
+"\n"+"             AND D.T_MESSAGEID IS NOT NULL "
+"\n"+"             AND D.T_MESSAGEID > 0 "
+"\n"+"             AND NOT EXISTS "
+"\n"+"                     (SELECT 1 "
+"\n"+"                        FROM utableprocessevent_dbt I "
+"\n"+"                       WHERE     I.T_OBJECTID = D.T_OBJECTID "
+"\n"+"                             AND I.T_OBJECTTYPE = D.T_OBJECTTYPE "
+"\n"+"                             AND I.T_TYPE = 3 "
+"\n"+"                             AND I.T_RECID > D.T_RECID) "
+"\n"+"   ), "
+"\n"+"   accTrnReq as ( "
+"\n"+"     SELECT A.T_IDBISCOTTO, A.T_REQID, A.T_AUTOKEY, A.T_ACCTRNID, A.T_ACCT_DB, A.T_ACCT_CR, B.T_ACCOUNT_PAYER, B.T_ACCOUNT_RECEIVER  "
+"\n"+"       FROM generalQuery A, dacctrn_dbt B "
+"\n"+"      WHERE     A.T_OPDATE BETWEEN ? /*05*/ "
+"\n"+"                               AND ? /*06*/ "
+"\n"+"            AND A.T_OPDATE = B.T_DATE_CARRY "
+"\n"+"            AND B.T_DATE_CARRY = A.T_OPDATE "
+"\n"+"            AND B.T_ACCTRNID = A.T_ACCTRNID "
+"\n"+"   ), "

+"\n"+"   accTrnReqWithCheckProcessEvent as ( "
+"\n"+"     SELECT * "
+"\n"+"       FROM accTrnReq A "
+"\n"+"      WHERE     EXISTS (SELECT 1 FROM tableProcessEventReq D where D.T_OBJECTID = A.T_ACCTRNID and D.T_STATUS IN (4, 5) ) "
+"\n"+"   ), "

+"\n"+"   mainQueryWithAccTrnProcEvent as ( "
+"\n"+"     SELECT * "
+"\n"+"       FROM mainQuery C "
+"\n"+"      WHERE C.T_AUTOKEY NOT IN (SELECT A.T_AUTOKEY "
+"\n"+"                                  FROM accTrnReqWithCheckProcessEvent A) "
+"\n"+"   ), "

+"\n"+"   accTrnReqPaym as ( "
+"\n"+"     SELECT A.T_AUTOKEY, B.T_PAYMENTID, B.T_FUTUREPAYERACCOUNT, B.T_PAYERACCOUNT, B.T_RECEIVERACCOUNT, B.T_FUTURERECEIVERACCOUNT, A.T_ACCT_DB, A.T_ACCT_CR "
+"\n"+"       FROM reqQuery A, dpmpaym_dbt B "
+"\n"+"      WHERE     (   ? /*07*/ IN "
+"\n"+"                        (B.T_PAYERACCOUNT, B.T_FUTUREPAYERACCOUNT) "
+"\n"+"                 OR ? /*08*/ IN "
+"\n"+"                        (B.T_RECEIVERACCOUNT, B.T_FUTURERECEIVERACCOUNT)) "
+"\n"+"            AND A.T_OPDATE BETWEEN ? /*09*/ "
+"\n"+"                               AND ? /*10*/ "
+"\n"+"            AND A.T_OPDATE = B.T_VALUEDATE "
+"\n"+"            AND B.T_VALUEDATE = A.T_OPDATE "
+"\n"+"            AND B.T_PAYMENTID = A.T_ACCTRNID * -1 "
+"\n"+"   ) "

+"\n"+"              /*из СОФР в ЦФТ проводки ЦФТ отсутствуют в СОФР кроме полу-проводок*/ "
+"\n"+"   SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB,  "
+"\n"+"    T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 1 AS T_ERR_CODE,  "
+"\n"+"    case when (SELECT NVL(T_DATE_CARRY,C.T_OPDATE) from dacctrn_dbt where T_ACCTRNID = C.T_ACCTRNID ) != C.T_OPDATE THEN 'Расхождение даты проводок СОФР с ЦФТ' ELSE "
+"\n"+"    USR_PKG_IMPORT_SOFR.GetStrEventErr( 0, 1, T_ACCTRNID ) END AS T_ERR_TEXT,  "
+"\n"+"    0 AS T_OPER, '' AS T_MODULE  "
+"\n"+"   FROM mainQueryWithAccTrnProcEvent C "
+"\n"+"    WHERE C.T_ACCT_DB IS NOT NULL  "
+"\n"+"    AND C.T_ACCT_CR IS NOT NULL  "

+"\n"+"   UNION ALL  "

+"\n"+"              /*из СОФР в ЦФТ проводки ЦФТ отсутствуют в СОФР только полу-проводоки*/ "
+"\n"+"   SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB,  "
+"\n"+"    T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 1 AS T_ERR_CODE,  "
+"\n"+"    case when (SELECT NVL(T_DATE_CARRY,C.T_OPDATE) from dacctrn_dbt where T_ACCTRNID = C.T_ACCTRNID ) != C.T_OPDATE THEN 'Расхождение даты проводок СОФР с ЦФТ' ELSE "
+"\n"+"    USR_PKG_IMPORT_SOFR.GetStrEventErr( 0, 1, T_ACCTRNID ) END AS T_ERR_TEXT,  "
+"\n"+"    0 AS T_OPER, '' AS T_MODULE  "
+"\n"+"   FROM mainQueryWithAccTrnProcEvent C  "
+"\n"+"   WHERE  ( C.T_ACCT_DB IS NULL AND C.T_ACCT_CR IS NOT NULL  "
+"\n"+"     OR C.T_ACCT_DB IS NOT NULL AND C.T_ACCT_CR IS NULL )  "

+"\n"+"   UNION ALL  "

+"\n"+"              /*из СОФР в ЦФТ проводки ЦФТ присутствуют в СОФР, не соответствуют реквизиты кроме полу-проводок*/ "

+"\n"+"   SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB,  "
+"\n"+"    T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 2 AS T_ERR_CODE, 'Из СОФР в ЦФТ. Присутствует в СОФР, не соответствуют реквизиты: ' ||  "
+"\n"+"    USR_PKG_IMPORT_SOFR.GetDifferenceStrErr( 0, C.T_ACCT_DB, C.T_ACCT_CR, C.T_AMTCUR, C.T_AMTRUB, C.T_CURRENCY, C.T_DETAILS, C.T_DOCNUM,  "
+"\n"+"     C.T_ACCTRNID, C.T_IDBISCOTTO, C.T_REQID ) AS T_ERR_TEXT,  "
+"\n"+"     ( SELECT R.T_OPER FROM dacctrn_dbt R WHERE R.T_ACCTRNID = C.T_ACCTRNID ) AS T_OPER,  "
+"\n"+"     ( SELECT W.T_BOFFICE FROM rshb_fd_groups W  "
+"\n"+"       WHERE W.T_GROUPID IN(( SELECT O.T_GROUPID FROM dacsgroupoper_dbt O  "
+"\n"+"                              WHERE O.T_OPER = ( SELECT R.T_OPER FROM dacctrn_dbt R  "
+"\n"+"                                                 WHERE R.T_ACCTRNID = C.T_ACCTRNID )))  "
+"\n"+"        AND ROWNUM = 1 ) AS T_MODULE  "

+"\n"+"   FROM mainQueryDtCrNotNull C  "

+"\n"+"   WHERE C.T_AUTOKEY IN( SELECT A.T_AUTOKEY FROM accTrnReq A "
+"\n"+"                                WHERE ( A.T_ACCOUNT_PAYER = A.T_ACCT_DB  "
+"\n"+"                                 OR EXISTS( SELECT 1 FROM dbrokacc_dbt D  "
+"\n"+"                                            WHERE D.T_ACCOUNT =  A.T_ACCT_DB ) )  "

+"\n"+"                                AND ( A.T_ACCOUNT_RECEIVER = A.T_ACCT_CR  "
+"\n"+"                                 OR EXISTS( SELECT 1 FROM dbrokacc_dbt D  "
+"\n"+"                                            WHERE D.T_ACCOUNT =  A.T_ACCT_CR ) ))  "
+"\n"+"    AND EXISTS( SELECT 1 FROM dacctrn_dbt D  "
+"\n"+"                WHERE D.T_ACCTRNID = C.T_ACCTRNID  "
+"\n"+"                 AND ( D.T_ACCOUNT_PAYER <> C.T_ACCT_DB  "
+"\n"+"                        AND NOT EXISTS( SELECT 1 FROM dbrokacc_dbt E  "
+"\n"+"                                        WHERE E.T_ACCOUNT =  C.T_ACCT_DB )  "
+"\n"+"                       OR D.T_ACCOUNT_RECEIVER <> C.T_ACCT_CR  "
+"\n"+"                        AND NOT EXISTS( SELECT 1 FROM dbrokacc_dbt E  "
+"\n"+"                                        WHERE E.T_ACCOUNT =  C.T_ACCT_CR )  "

+"\n"+"                       OR ( CASE WHEN D.T_FIID_PAYER = 0 AND D.T_FIID_RECEIVER = 0 OR C.T_AMTCUR = 0  THEN 0  "
+"\n"+"                                 ELSE  ( CASE WHEN D.T_FIID_PAYER <> 0 THEN D.T_SUM_PAYER  "
+"\n"+"                                                           WHEN D.T_FIID_RECEIVER <> 0 THEN D.T_SUM_RECEIVER END ) END ) <> C.T_AMTCUR  "

+"\n"+"                       OR D.T_SUM_NATCUR <> C.T_AMTRUB  "

+"\n"+"                     ))  "
+"\n"+"    AND EXISTS( SELECT 1 FROM  utableprocessevent_dbt D "
+"\n"+"       WHERE     D.T_OBJECTTYPE IN (1, 501) "
+"\n"+"             AND D.T_TYPE = 1 "
+"\n"+"             AND D.T_OBJECTID = C.T_ACCTRNID AND D.T_STATUS = 4 "
+"\n"+"             AND D.T_MESSAGEID IS NOT NULL "
+"\n"+"             AND D.T_MESSAGEID > 0 "
+"\n"+"             AND NOT EXISTS "
+"\n"+"                     (SELECT 1 "
+"\n"+"                        FROM utableprocessevent_dbt I "
+"\n"+"                       WHERE     I.T_OBJECTID = D.T_OBJECTID "
+"\n"+"                             AND I.T_OBJECTTYPE = D.T_OBJECTTYPE "
+"\n"+"                             AND I.T_TYPE = 3 "
+"\n"+"                             AND I.T_RECID > D.T_RECID)  )  "

+"\n"+"   UNION ALL  "

+"\n"+"              /*из СОФР в ЦФТ проводки ЦФТ присутствуют в СОФР, не соответствуют реквизиты  только полу-проводки*/ "

+"\n"+"   SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB,  "
+"\n"+"    T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 2 AS T_ERR_CODE, 'Из СОФР в ЦФТ. Присутствует в СОФР, не соответствуют реквизиты: ' ||  "
+"\n"+"    USR_PKG_IMPORT_SOFR.GetDifferenceStrErr( 1, C.T_ACCT_DB, C.T_ACCT_CR, C.T_AMTCUR, C.T_AMTRUB, C.T_CURRENCY, C.T_DETAILS, C.T_DOCNUM,  "
+"\n"+"     C.T_ACCTRNID, C.T_IDBISCOTTO, C.T_REQID ) AS T_ERR_TEXT,  "
+"\n"+"     ( SELECT R.T_OPER FROM dacctrn_dbt R WHERE R.T_ACCTRNID = C.T_ACCTRNID ) AS T_OPER,  "
+"\n"+"     ( SELECT W.T_BOFFICE FROM rshb_fd_groups W  "
+"\n"+"       WHERE W.T_GROUPID IN(( SELECT O.T_GROUPID FROM dacsgroupoper_dbt O  "
+"\n"+"                              WHERE O.T_OPER = ( SELECT R.T_OPER FROM dacctrn_dbt R  "
+"\n"+"                                                 WHERE R.T_ACCTRNID = C.T_ACCTRNID )))  "
+"\n"+"        AND ROWNUM = 1 ) AS T_MODULE  "

+"\n"+"   FROM mainQuery C  "
+"\n"+"   WHERE C.T_AUTOKEY IN(  SELECT A.T_AUTOKEY FROM accTrnReq A "
+"\n"+"                          WHERE  A.T_ACCOUNT_PAYER =   "
+"\n"+"                                 NVL( A.T_ACCT_DB, ( SELECT G.T_ACCT_DB FROM uloadentforcompare_dbt G  "
+"\n"+"                                                     WHERE  G.T_IDBISCOTTO = C.T_IDBISCOTTO  "
+"\n"+"                                                      AND G.T_REQID = A.T_REQID  "
+"\n"+"                                                      AND   G.T_ACCT_CR IS NULL AND G.T_ACCT_DB IS NOT NULL )  )  "

+"\n"+"                                AND A.T_ACCOUNT_RECEIVER =   "
+"\n"+"                                 NVL ( A.T_ACCT_CR, ( SELECT G.T_ACCT_CR FROM uloadentforcompare_dbt G  "
+"\n"+"                                                      WHERE  G.T_IDBISCOTTO = C.T_IDBISCOTTO  "
+"\n"+"                                                        AND G.T_REQID = A.T_REQID  "
+"\n"+"                                                        AND   G.T_ACCT_DB IS NULL AND G.T_ACCT_CR IS NOT NULL )  ) )  "
+"\n"+"    AND  ( C.T_ACCT_DB IS NULL AND C.T_ACCT_CR IS NOT NULL  "
+"\n"+"     OR C.T_ACCT_DB IS NOT NULL AND C.T_ACCT_CR IS NULL )  "

+"\n"+"    AND EXISTS( SELECT 1 FROM dacctrn_dbt D  "
+"\n"+"                WHERE D.T_ACCTRNID = C.T_ACCTRNID  "
+"\n"+"                 AND ( D.T_ACCOUNT_PAYER <>   "
+"\n"+"                  NVL( C.T_ACCT_DB, ( SELECT G.T_ACCT_DB FROM uloadentforcompare_dbt G  "
+"\n"+"                                      WHERE  G.T_IDBISCOTTO = C.T_IDBISCOTTO  "
+"\n"+"                                       AND G.T_REQID = C.T_REQID  "
+"\n"+"                                       AND   G.T_ACCT_CR IS NULL AND G.T_ACCT_DB IS NOT NULL )  )  "

+"\n"+"                       OR D.T_ACCOUNT_RECEIVER <>   "
+"\n"+"                         NVL ( C.T_ACCT_CR, ( SELECT G.T_ACCT_CR FROM uloadentforcompare_dbt G  "
+"\n"+"                                              WHERE  G.T_IDBISCOTTO = C.T_IDBISCOTTO  "
+"\n"+"                                                AND G.T_REQID = C.T_REQID  "
+"\n"+"                                                AND   G.T_ACCT_DB IS NULL AND G.T_ACCT_CR IS NOT NULL )  )  "

+"\n"+"                       OR D.T_SUM_PAYER <> ( CASE WHEN C.T_ACCT_DB IS NULL THEN ( SELECT G.T_AMTCUR FROM uloadentforcompare_dbt G  "
+"\n"+"                                                                                  WHERE  G.T_IDBISCOTTO = C.T_IDBISCOTTO  "
+"\n"+"                                                                                   AND G.T_REQID = C.T_REQID  "
+"\n"+"                                                                                   AND G.T_ACCTRNID = C.T_ACCTRNID  "
+"\n"+"                                                                                   AND  G.T_ACCT_CR IS NULL AND G.T_ACCT_DB IS NOT NULL )  "
+"\n"+"                                             ELSE C.T_AMTCUR END )  "
+"\n"+"                        OR D.T_SUM_RECEIVER <> ( CASE WHEN C.T_ACCT_CR IS NULL THEN (  SELECT G.T_AMTCUR FROM uloadentforcompare_dbt G  "
+"\n"+"                                                                                       WHERE G.T_IDBISCOTTO = C.T_IDBISCOTTO  "
+"\n"+"                                                                                         AND G.T_REQID = C.T_REQID  "
+"\n"+"                                                                                         AND G.T_ACCTRNID = C.T_ACCTRNID  "
+"\n"+"                                                                                         AND G.T_ACCT_DB IS NULL AND G.T_ACCT_CR IS NOT NULL )  "
+"\n"+"                                                  ELSE C.T_AMTCUR END )  "


+"\n"+"                       OR D.T_SUM_NATCUR <> C.T_AMTRUB  "

+"\n"+"                     ))  "
+"\n"+"    AND EXISTS(  SELECT 1 FROM  utableprocessevent_dbt D "
+"\n"+"       WHERE     D.T_OBJECTTYPE IN (1, 501) "
+"\n"+"             AND D.T_TYPE = 1 "
+"\n"+"             AND D.T_OBJECTID = C.T_ACCTRNID AND D.T_STATUS = 4 "
+"\n"+"             AND D.T_MESSAGEID IS NOT NULL "
+"\n"+"             AND D.T_MESSAGEID > 0 "
+"\n"+"             AND NOT EXISTS "
+"\n"+"                     (SELECT 1 "
+"\n"+"                        FROM utableprocessevent_dbt I "
+"\n"+"                       WHERE     I.T_OBJECTID = D.T_OBJECTID "
+"\n"+"                             AND I.T_OBJECTTYPE = D.T_OBJECTTYPE "
+"\n"+"                             AND I.T_TYPE = 3 "
+"\n"+"                             AND I.T_RECID > D.T_RECID)   )  "

+"\n"+"   UNION ALL  "


+"\n"+"              /*из СОФР в ЦФТ проводки ЦФТ присутствуют в СОФР, задвоенные в ЦФТ кроме полу-проводок*/ "

+"\n"+"   SELECT D.T_AUTOKEY, D.T_COUNTER, D.T_USERID, D.T_OPDATE, D.T_DOCDATE, D.T_ACCT_DB, D.T_ACCT_CR, D.T_CURRENCY, D.T_AMTCUR, D.T_AMTRUB,  "
+"\n"+"    D.T_DETAILS, D.T_DOCNUM, D.T_ACCTRNID, D.T_IDBISCOTTO, D.T_REQID, 3 AS T_ERR_CODE, 'Из СОФР в ЦФТ. Присутствует в СОФР, задвоенные в ЦФТ' AS T_ERR_TEXT,  "
+"\n"+"    0 AS T_OPER, '' AS T_MODULE  "
+"\n"+"   FROM uloadentforcompare_dbt D,  "
+"\n"+"   (  "
+"\n"+"   SELECT T_ACCTRNID, MAX( T_AUTOKEY ) AS T_AUTOKEY_DOUBLE, MIN( T_AUTOKEY ) AS T_AUTOKEY_PRIOR  FROM uloadentforcompare_dbt C  "
+"\n"+"   WHERE C.T_AUTOKEY IN(  SELECT A.T_AUTOKEY FROM accTrnReq A "
+"\n"+"                          WHERE ( A.T_ACCOUNT_PAYER = A.T_ACCT_DB  "
+"\n"+"                                 OR EXISTS( SELECT 1 FROM dbrokacc_dbt D  "
+"\n"+"                                            WHERE D.T_ACCOUNT =  A.T_ACCT_DB ) )  "

+"\n"+"                                AND ( A.T_ACCOUNT_RECEIVER = A.T_ACCT_CR  "
+"\n"+"                                 OR EXISTS( SELECT 1 FROM dbrokacc_dbt D  "
+"\n"+"                                            WHERE D.T_ACCOUNT =  A.T_ACCT_CR ) ) )  "
+"\n"+"    AND C.T_ACCTRNID > 0  "
+"\n"+"    AND C.T_ACCT_DB IS NOT NULL  "
+"\n"+"    AND C.T_ACCT_CR IS NOT NULL  "
+"\n"+"    AND EXISTS(  SELECT 1 FROM  utableprocessevent_dbt D "
+"\n"+"       WHERE     D.T_OBJECTTYPE IN (1, 501) "
+"\n"+"             AND D.T_TYPE = 1 "
+"\n"+"             AND D.T_OBJECTID = C.T_ACCTRNID AND D.T_STATUS = 4 "
+"\n"+"             AND D.T_MESSAGEID IS NOT NULL "
+"\n"+"             AND D.T_MESSAGEID > 0 "
+"\n"+"             AND NOT EXISTS "
+"\n"+"                     (SELECT 1 "
+"\n"+"                        FROM utableprocessevent_dbt I "
+"\n"+"                       WHERE     I.T_OBJECTID = D.T_OBJECTID "
+"\n"+"                             AND I.T_OBJECTTYPE = D.T_OBJECTTYPE "
+"\n"+"                             AND I.T_TYPE = 3 "
+"\n"+"                             AND I.T_RECID > D.T_RECID)  )  "

+"\n"+"   GROUP BY T_ACCTRNID  "
+"\n"+"   HAVING COUNT(T_ACCTRNID) > 1  "
+"\n"+"   ) A  "
+"\n"+"   WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V   "
+"\n"+"                     WHERE V.T_BISCOTTOID = D.T_IDBISCOTTO )  "
+"\n"+"    AND D.T_AUTOKEY = A.T_AUTOKEY_DOUBLE  "

+"\n"+"   UNION ALL  "


+"\n"+"              /*проводки ЦФТ присутствуют в СОФР, задвоенные в ЦФТ только полу-проводки*/ "

+"\n"+"   SELECT D.T_AUTOKEY, D.T_COUNTER, D.T_USERID, D.T_OPDATE, D.T_DOCDATE, D.T_ACCT_DB, D.T_ACCT_CR, D.T_CURRENCY, D.T_AMTCUR, D.T_AMTRUB,  "
+"\n"+"    D.T_DETAILS, D.T_DOCNUM, D.T_ACCTRNID, D.T_IDBISCOTTO, D.T_REQID, 3 AS T_ERR_CODE, 'Из СОФР в ЦФТ. Присутствует в СОФР, задвоенные в ЦФТ' AS T_ERR_TEXT,  "
+"\n"+"    0 AS T_OPER, '' AS T_MODULE  "
+"\n"+"   FROM uloadentforcompare_dbt D,  "
+"\n"+"   (  "
+"\n"+"   SELECT T_ACCTRNID, MAX( T_AUTOKEY ) AS T_AUTOKEY_DOUBLE, MIN( T_AUTOKEY ) AS T_AUTOKEY_PRIOR  FROM uloadentforcompare_dbt C  "
+"\n"+"   WHERE C.T_AUTOKEY IN( SELECT A.T_AUTOKEY FROM accTrnReq A "
+"\n"+"                          WHERE  A.T_ACCOUNT_PAYER =   "
+"\n"+"                                  NVL( A.T_ACCT_DB, ( SELECT G.T_ACCT_DB FROM uloadentforcompare_dbt G  "
+"\n"+"                                                      WHERE  G.T_IDBISCOTTO = A.T_IDBISCOTTO  "
+"\n"+"                                                       AND G.T_REQID = A.T_REQID  "
+"\n"+"                                                       AND   G.T_ACCT_CR IS NULL AND G.T_ACCT_DB IS NOT NULL )  )  "

+"\n"+"                                AND A.T_ACCOUNT_RECEIVER =   "
+"\n"+"                                  NVL ( A.T_ACCT_CR, ( SELECT G.T_ACCT_CR FROM uloadentforcompare_dbt G  "
+"\n"+"                                                       WHERE  G.T_IDBISCOTTO = A.T_IDBISCOTTO  "
+"\n"+"                                                         AND G.T_REQID = A.T_REQID  "
+"\n"+"                                                         AND   G.T_ACCT_DB IS NULL AND G.T_ACCT_CR IS NOT NULL )  )  )  "
+"\n"+"    AND C.T_ACCTRNID > 0  "
+"\n"+"    AND  ( C.T_ACCT_DB IS NULL AND C.T_ACCT_CR IS NOT NULL  "
+"\n"+"     OR C.T_ACCT_DB IS NOT NULL AND C.T_ACCT_CR IS NULL )  "
+"\n"+"    AND EXISTS(  SELECT 1 FROM  utableprocessevent_dbt D "
+"\n"+"       WHERE     D.T_OBJECTTYPE IN (1, 501) "
+"\n"+"             AND D.T_TYPE = 1 "
+"\n"+"             AND D.T_OBJECTID = C.T_ACCTRNID AND D.T_STATUS = 4 "
+"\n"+"             AND D.T_MESSAGEID IS NOT NULL "
+"\n"+"             AND D.T_MESSAGEID > 0 "
+"\n"+"             AND NOT EXISTS "
+"\n"+"                     (SELECT 1 "
+"\n"+"                        FROM utableprocessevent_dbt I "
+"\n"+"                       WHERE     I.T_OBJECTID = D.T_OBJECTID "
+"\n"+"                             AND I.T_OBJECTTYPE = D.T_OBJECTTYPE "
+"\n"+"                             AND I.T_TYPE = 3 "
+"\n"+"                             AND I.T_RECID > D.T_RECID)   )  "

+"\n"+"   GROUP BY T_ACCTRNID  "
+"\n"+"   HAVING COUNT(T_ACCTRNID) > 2  "
+"\n"+"   ) A  "
+"\n"+"   WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V   "
+"\n"+"                     WHERE V.T_BISCOTTOID = D.T_IDBISCOTTO )  "
+"\n"+"    AND D.T_AUTOKEY = A.T_AUTOKEY_DOUBLE  "

+"\n"+"   UNION ALL  "

+"\n"+"              /*из СОФР в ЦФТ проводки СОФР отсутствуют в ЦФТ в том числе полу-проводки*/ "

+"\n"+"   SELECT -1 AS T_AUTOKEY, CHR(0) AS T_COUNTER, CHR(0) AS T_USERID, C.T_DATE_CARRY AS T_OPDATE, C.T_DATE_CARRY AS T_DOCDATE, C.T_ACCOUNT_PAYER AS T_ACCT_DB,  "
+"\n"+"    C.T_ACCOUNT_RECEIVER AS T_ACCT_CR,  "
+"\n"+"    ( SELECT F.T_CODEINACCOUNT FROM dfininstr_dbt F  "
+"\n"+"      WHERE F.T_FIID = C.T_FIID_PAYER ) AS T_CURRENCY,  "
+"\n"+"    C.T_SUM_PAYER AS T_AMTCUR, C.T_SUM_NATCUR AS T_AMTRUB,  "
+"\n"+"    C.T_GROUND AS T_DETAILS, C.T_NUMB_DOCUMENT AS T_DOCNUM, C.T_ACCTRNID, CHR(0) AS T_IDBISCOTTO, CHR(0) AS T_REQID, 4 AS T_ERR_CODE, 'Из СОФР в ЦФТ. Присутствует в СОФР, Отсутствует в ЦФТ' AS T_ERR_TEXT,  "
+"\n"+"    0 AS T_OPER, '' AS T_MODULE  "
+"\n"+"   FROM (SELECT * FROM dacctrn_dbt  "
+"\n"+"          WHERE T_DATE_CARRY BETWEEN ? /*11*/ AND ? /*12*/ AND (T_ACCOUNTID_PAYER IN (select T_ACCOUNTID from brokAccAccIds)) "
+"\n"+"         UNION ALL "
+"\n"+"         SELECT * FROM dacctrn_dbt  "
+"\n"+"          WHERE T_DATE_CARRY BETWEEN ? /*13*/ AND ? /*14*/ AND (T_ACCOUNTID_RECEIVER IN (select T_ACCOUNTID from brokAccAccIds)) "
+"\n"+"         UNION ALL "
+"\n"+"         SELECT * FROM dacctrn_dbt  "
+"\n"+"          WHERE T_DATE_CARRY BETWEEN ? /*15*/ AND ? /*16*/ AND T_ACCOUNT_PAYER = ? /*17*/ "
+"\n"+"         UNION ALL "
+"\n"+"         SELECT * FROM dacctrn_dbt  "
+"\n"+"          WHERE T_DATE_CARRY BETWEEN ? /*18*/ AND ? /*19*/ AND T_ACCOUNT_RECEIVER = ? /*20*/) C "



+"\n"+"    WHERE C.T_ACCTRNID NOT IN( ( SELECT B.T_ACCTRNID FROM dacctrn_dbt B, uloadentforcompare_dbt A  "


+"\n"+"                               WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V   "
+"\n"+"                                                 WHERE V.T_BISCOTTOID = A.T_IDBISCOTTO )  "
+"\n"+"                                AND A.T_REQID = ? /*21*/   "
+"\n"+"                                AND ( ? /*22*/  =  A.T_ACCT_DB  "
+"\n"+"                                 OR ? /*23*/  = A.T_ACCT_CR )  "


+"\n"+"                                AND A.T_ACCTRNID > 0  "
+"\n"+"                                AND A.T_OPDATE BETWEEN ? /*24*/  AND ? /*25*/   "
+"\n"+"                                AND B.T_DATE_CARRY = A.T_OPDATE  "

+"\n"+"                                AND A.T_ACCTRNID = B.T_ACCTRNID ) )  "
+"\n"+"    AND EXISTS(  SELECT 1 FROM  utableprocessevent_dbt D "
+"\n"+"       WHERE     D.T_OBJECTTYPE IN (1, 501) "
+"\n"+"             AND D.T_TYPE = 1 "
+"\n"+"             AND D.T_OBJECTID = C.T_ACCTRNID AND D.T_STATUS in (4,5) "
+"\n"+"             AND D.T_MESSAGEID IS NOT NULL "
+"\n"+"             AND D.T_MESSAGEID > 0 "
+"\n"+"             AND NOT EXISTS "
+"\n"+"                     (SELECT 1 "
+"\n"+"                        FROM utableprocessevent_dbt I "
+"\n"+"                       WHERE     I.T_OBJECTID = D.T_OBJECTID "
+"\n"+"                             AND I.T_OBJECTTYPE = D.T_OBJECTTYPE "
+"\n"+"                             AND I.T_TYPE = 3 "
+"\n"+"                             AND I.T_RECID > D.T_RECID)   )  "

+"\n"+"   UNION ALL  "

+"\n"+"              /*из СОФР в ЦФТ платежи ЦФТ отсутствуют в СОФР*/ "
+"\n"+"   SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB,  "
+"\n"+"    T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 1 AS T_ERR_CODE, 'Из СОФР в ЦФТ. Отсутствует в СОФР' AS T_ERR_TEXT,  "
+"\n"+"    0 AS T_OPER, '' AS T_MODULE  "
+"\n"+"   FROM mainQueryDtCrNotNullNeg C  "
+"\n"+"    WHERE C.T_AUTOKEY NOT IN( ( SELECT A.T_AUTOKEY FROM generalQuery A, dpmpaym_dbt B  "
+"\n"+"                               WHERE EXISTS( SELECT 1 FROM  utableprocessevent_dbt D  "
+"\n"+"                                            WHERE D.T_OBJECTID = A.T_ACCTRNID * -1  "
+"\n"+"                                             AND D.T_OBJECTTYPE = 501  "
+"\n"+"                                             AND D.T_TYPE IN( 1, 2 )  "
+"\n"+"                                             AND D.T_STATUS in (4, 5)  "  //14.10.2020 по просьбе банка отключен показ ошибок выгрузки в сверке где T_IDBISCOTTO и T_ACCTRNID корректные
+"\n"+"                                             AND D.T_MESSAGEID IS NOT NULL  "
+"\n"+"                                             AND D.T_MESSAGEID > 0  "

+"\n"+"                                             AND NOT EXISTS( SELECT 1 FROM utableprocessevent_dbt I  "
+"\n"+"                                                             WHERE I.T_OBJECTID = D.T_OBJECTID  "
+"\n"+"                                                              AND I.T_OBJECTTYPE = D.T_OBJECTTYPE  "
+"\n"+"                                                              AND I.T_TYPE = 3  "
+"\n"+"                                                              AND I.T_RECID >  D.T_RECID ) )  "

+"\n"+"                                AND A.T_OPDATE BETWEEN ? /*26*/  AND ? /*27*/   "
+"\n"+"                                AND A.T_OPDATE = B.T_VALUEDATE  "

+"\n"+"                                AND B.T_VALUEDATE = A.T_OPDATE  "
+"\n"+"                                AND B.T_PAYMENTID = A.T_ACCTRNID * -1 ) )  "
+"\n"+"   UNION ALL  "

+"\n"+"              /*из СОФР в ЦФТ платежи ЦФТ присутствуют в СОФР, не соответствуют реквизиты*/ "
+"\n"+"   SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB,  "
+"\n"+"    T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 2 AS T_ERR_CODE, 'Из СОФР в ЦФТ. Присутствует в СОФР, не соответствуют реквизиты: ' ||  "
+"\n"+"    USR_PKG_IMPORT_SOFR.GetDifferenceStrErr( 2, C.T_ACCT_DB, C.T_ACCT_CR, C.T_AMTCUR, C.T_AMTRUB, C.T_CURRENCY, C.T_DETAILS, C.T_DOCNUM,  "
+"\n"+"     C.T_ACCTRNID, C.T_IDBISCOTTO, C.T_REQID ) AS T_ERR_TEXT,  "
+"\n"+"     ( SELECT R.T_OPER FROM dpmpaym_dbt R WHERE R.T_PAYMENTID = C.T_ACCTRNID * -1 ) AS T_OPER,  "
+"\n"+"     ( SELECT W.T_BOFFICE FROM rshb_fd_groups W  "
+"\n"+"       WHERE W.T_GROUPID IN(( SELECT O.T_GROUPID FROM dacsgroupoper_dbt O  "
+"\n"+"                              WHERE O.T_OPER = ( SELECT R.T_OPER FROM dpmpaym_dbt R  "
+"\n"+"                                                 WHERE R.T_PAYMENTID = C.T_ACCTRNID * -1 )))  "
+"\n"+"        AND ROWNUM = 1 ) AS T_MODULE  "

+"\n"+"   FROM reqQuery C  "
+"\n"+"   WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V   "
+"\n"+"                     WHERE V.T_BISCOTTOID = C.T_IDBISCOTTO )  "

+"\n"+"     AND     C.T_AUTOKEY IN(  SELECT A.T_AUTOKEY FROM accTrnReqPaym A )  "
+"\n"+"    AND C.T_ACCTRNID < 0  "
+"\n"+"    AND C.T_ACCT_DB IS NOT NULL  "
+"\n"+"    AND C.T_ACCT_CR IS NOT NULL  "
+"\n"+"    AND EXISTS( SELECT 1 FROM dpmpaym_dbt D  "
+"\n"+"                WHERE D.T_PAYMENTID = C.T_ACCTRNID * -1  "
+"\n"+"                 AND ( D.T_PAYERACCOUNT <> C.T_ACCT_DB  "
+"\n"+"                 AND D.T_FUTUREPAYERACCOUNT <> C.T_ACCT_DB  "
+"\n"+"                        AND NOT EXISTS( SELECT 1 FROM dbrokacc_dbt E  "
+"\n"+"                                        WHERE E.T_ACCOUNT =  C.T_ACCT_DB )  "
+"\n"+"                       OR D.T_RECEIVERACCOUNT <> C.T_ACCT_CR  "
+"\n"+"                        AND D.T_FUTURERECEIVERACCOUNT <> C.T_ACCT_CR  "
+"\n"+"                        AND NOT EXISTS( SELECT 1 FROM dbrokacc_dbt E  "
+"\n"+"                                        WHERE E.T_ACCOUNT =  C.T_ACCT_CR )  "
+"\n"+"                       OR ( CASE WHEN D.T_FIID = 0 AND D.T_PAYFIID = 0 OR C.T_AMTCUR = 0  THEN 0 ELSE D.T_AMOUNT END ) <> C.T_AMTCUR  "

+"\n"+"                     ))  "
+"\n"+"    AND EXISTS( SELECT 1 FROM  utableprocessevent_dbt D "
+"\n"+"                WHERE D.T_OBJECTID = C.T_ACCTRNID * -1  "
+"\n"+"                 AND D.T_OBJECTTYPE = 501  "
+"\n"+"                 AND D.T_TYPE IN( 1, 2 )  "
+"\n"+"                 AND D.T_STATUS = 4  "
+"\n"+"                 AND D.T_MESSAGEID IS NOT NULL  "
+"\n"+"                 AND D.T_MESSAGEID > 0  "

+"\n"+"                 AND NOT EXISTS( SELECT 1 FROM utableprocessevent_dbt I  "
+"\n"+"                                 WHERE I.T_OBJECTID = D.T_OBJECTID  "
+"\n"+"                                  AND I.T_OBJECTTYPE = D.T_OBJECTTYPE  "
+"\n"+"                                  AND I.T_TYPE = 3  "
+"\n"+"                                  AND I.T_RECID >  D.T_RECID ) )  "

+"\n"+"   UNION ALL  "

+"\n"+"              /*из СОФР в ЦФТ платежи ЦФТ присутствуют в СОФР, задвоенные в ЦФТ*/ "

+"\n"+"   SELECT D.T_AUTOKEY, D.T_COUNTER, D.T_USERID, D.T_OPDATE, D.T_DOCDATE, D.T_ACCT_DB, D.T_ACCT_CR, D.T_CURRENCY, D.T_AMTCUR, D.T_AMTRUB,  "
+"\n"+"    D.T_DETAILS, D.T_DOCNUM, D.T_ACCTRNID, D.T_IDBISCOTTO, D.T_REQID, 3 AS T_ERR_CODE, 'Из СОФР в ЦФТ. Присутствует в СОФР, задвоенные в ЦФТ' AS T_ERR_TEXT,  "
+"\n"+"    0 AS T_OPER, '' AS T_MODULE  "
+"\n"+"   FROM uloadentforcompare_dbt D,  "
+"\n"+"   (  "
+"\n"+"   SELECT T_ACCTRNID, MAX( T_AUTOKEY ) AS T_AUTOKEY_DOUBLE, MIN( T_AUTOKEY ) AS T_AUTOKEY_PRIOR  FROM uloadentforcompare_dbt C  "
+"\n"+"   WHERE C.T_AUTOKEY IN( ( SELECT A.T_AUTOKEY FROM generalQuery A, dpmpaym_dbt B  "

+"\n"+"                               WHERE A.T_OPDATE BETWEEN ? /*28*/  AND ? /*29*/   "
+"\n"+"                                AND A.T_OPDATE = B.T_VALUEDATE  "

+"\n"+"                                AND ( B.T_FUTUREPAYERACCOUNT = A.T_ACCT_DB  "
+"\n"+"                                 OR B.T_PAYERACCOUNT = A.T_ACCT_DB  "
+"\n"+"                                 OR EXISTS( SELECT 1 FROM dbrokacc_dbt D  "
+"\n"+"                                            WHERE D.T_ACCOUNT =  A.T_ACCT_DB ) )  "

+"\n"+"                                AND ( B.T_FUTURERECEIVERACCOUNT = A.T_ACCT_CR  "
+"\n"+"                                 OR B.T_RECEIVERACCOUNT = A.T_ACCT_CR  "
+"\n"+"                                 OR EXISTS( SELECT 1 FROM dbrokacc_dbt D  "
+"\n"+"                                            WHERE D.T_ACCOUNT =  A.T_ACCT_CR ) )  "

+"\n"+"                                AND B.T_VALUEDATE = A.T_OPDATE  "
+"\n"+"                                AND B.T_PAYMENTID = A.T_ACCTRNID * -1 ) )  "
+"\n"+"    AND C.T_ACCTRNID < 0  "
+"\n"+"    AND C.T_ACCT_DB IS NOT NULL  "
+"\n"+"    AND C.T_ACCT_CR IS NOT NULL  "
+"\n"+"    AND EXISTS(  SELECT 1 FROM  utableprocessevent_dbt D "
+"\n"+"       WHERE     D.T_OBJECTTYPE IN (1, 501) "
+"\n"+"             AND D.T_TYPE = 1 "
+"\n"+"             AND D.T_OBJECTID = C.T_ACCTRNID * -1 AND D.T_STATUS = 4 "
+"\n"+"             AND D.T_MESSAGEID IS NOT NULL "
+"\n"+"             AND D.T_MESSAGEID > 0 "
+"\n"+"             AND NOT EXISTS "
+"\n"+"                     (SELECT 1 "
+"\n"+"                        FROM utableprocessevent_dbt I "
+"\n"+"                       WHERE     I.T_OBJECTID = D.T_OBJECTID "
+"\n"+"                             AND I.T_OBJECTTYPE = D.T_OBJECTTYPE "
+"\n"+"                             AND I.T_TYPE = 3 "
+"\n"+"                             AND I.T_RECID > D.T_RECID)   )  "

+"\n"+"   GROUP BY T_ACCTRNID  "
+"\n"+"   HAVING COUNT(T_ACCTRNID) > 1  "
+"\n"+"   ) A  "
+"\n"+"   WHERE NOT EXISTS( SELECT 1 FROM upmbiscotto_dbt V   "
+"\n"+"                     WHERE V.T_BISCOTTOID = D.T_IDBISCOTTO )  "
+"\n"+"    AND D.T_AUTOKEY = A.T_AUTOKEY_DOUBLE  "

+"\n"+"   UNION ALL  "

+"\n"+"              /*из СОФР в ЦФТ платежи СОФР отсутствуют в ЦФТ*/ "

+"\n"+"   SELECT -1 AS T_AUTOKEY, CHR(0) AS T_COUNTER, CHR(0) AS T_USERID, C.T_VALUEDATE AS T_OPDATE, C.T_VALUEDATE AS T_DOCDATE, C.T_PAYERACCOUNT AS T_ACCT_DB,  "
+"\n"+"    C.T_RECEIVERACCOUNT AS T_ACCT_CR,  "
+"\n"+"    ( SELECT F.T_CODEINACCOUNT FROM dfininstr_dbt F  "
+"\n"+"      WHERE F.T_FIID = C.T_FIID ) AS T_CURRENCY,  "
+"\n"+"    C.T_AMOUNT AS T_AMTCUR, C.T_BASEAMOUNT AS T_AMTRUB,  "
+"\n"+"    H.T_GROUND AS T_DETAILS, TO_CHAR( C.T_PAYMENTID ) AS T_DOCNUM, C.T_PAYMENTID, CHR(0) AS T_IDBISCOTTO, CHR(0) AS T_REQID, 4 AS T_ERR_CODE, 'Из СОФР в ЦФТ. Присутствует в СОФР, Отсутствует в ЦФТ' AS T_ERR_TEXT,  "
+"\n"+"    0 AS T_OPER, '' AS T_MODULE  "
+"\n"+"   FROM dpmpaym_dbt C, dpmrmprop_dbt H  "

+"\n"+"   WHERE C.T_VALUEDATE BETWEEN ? /*30*/  AND ? /*31*/   "
+"\n"+"    AND H.T_PAYMENTID = C.T_PAYMENTID  "
+"\n"+"    AND ( ? /*32*/  = C.T_PAYERACCOUNT  "
+"\n"+"     OR ? /*33*/  = C.T_RECEIVERACCOUNT )  "

+"\n"+"    AND C.T_PAYMENTID NOT IN( SELECT A.T_PAYMENTID FROM accTrnReqPaym A )   "
+"\n"+"    AND EXISTS(  SELECT 1 FROM  utableprocessevent_dbt D "
+"\n"+"       WHERE     D.T_OBJECTTYPE = 501  "
+"\n"+"             AND D.T_TYPE = 1 "
+"\n"+"             AND D.T_OBJECTID = C.T_PAYMENTID AND D.T_STATUS = 4 "
+"\n"+"             AND D.T_MESSAGEID IS NOT NULL "
+"\n"+"             AND D.T_MESSAGEID > 0 "
+"\n"+"             AND NOT EXISTS "
+"\n"+"                     (SELECT 1 "
+"\n"+"                        FROM utableprocessevent_dbt I "
+"\n"+"                       WHERE     I.T_OBJECTID = D.T_OBJECTID "
+"\n"+"                             AND I.T_OBJECTTYPE = D.T_OBJECTTYPE "
+"\n"+"                             AND I.T_TYPE = 3 "
+"\n"+"                             AND I.T_RECID > D.T_RECID)   )  "

+"\n"+"   UNION ALL  "

+"\n"+"           /*   из ЦФТ в СОФР платежи ЦФТ отсутствуют в СОФР*/ "
+"\n"+"   SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB,  "
+"\n"+"    T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 1 AS T_ERR_CODE, 'Из ЦФТ в СОФР. Отсутствует в СОФР' AS T_ERR_TEXT,  "
+"\n"+"    0 AS T_OPER, '' AS T_MODULE  "
+"\n"+"   FROM mainQueryNegExistNotNull C  "
+"\n"+"   WHERE C.T_AUTOKEY NOT IN(  SELECT A.T_AUTOKEY FROM accTrnReqPaym A )  "

+"\n"+"   UNION ALL  "

+"\n"+"             /* из ЦФТ в СОФР платежи ЦФТ присутствуют в СОФР, не соответствуют реквизиты*/ "
+"\n"+"   SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB,  "
+"\n"+"    T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 2 AS T_ERR_CODE, 'Из ЦФТ в СОФР. Присутствует в СОФР, не соответствуют реквизиты: ' ||  "
+"\n"+"    USR_PKG_IMPORT_SOFR.GetDifferenceStrErr( 2, C.T_ACCT_DB, C.T_ACCT_CR, C.T_AMTCUR, C.T_AMTRUB, C.T_CURRENCY, C.T_DETAILS, C.T_DOCNUM,  "
+"\n"+"     C.T_ACCTRNID, C.T_IDBISCOTTO, C.T_REQID ) AS T_ERR_TEXT,  "
+"\n"+"     ( SELECT R.T_OPER FROM dpmpaym_dbt R WHERE R.T_PAYMENTID = C.T_ACCTRNID * -1 ) AS T_OPER,  "
+"\n"+"     ( SELECT W.T_BOFFICE FROM rshb_fd_groups W  "
+"\n"+"       WHERE W.T_GROUPID IN(( SELECT O.T_GROUPID FROM dacsgroupoper_dbt O  "
+"\n"+"                              WHERE O.T_OPER = ( SELECT R.T_OPER FROM dpmpaym_dbt R  "
+"\n"+"                                                 WHERE R.T_PAYMENTID = C.T_ACCTRNID * -1 )))  "
+"\n"+"        AND ROWNUM = 1 ) AS T_MODULE  "
+"\n"+"   FROM mainQueryNegExistNotNull C  "
+"\n"+"   WHERE C.T_AUTOKEY IN(  SELECT A.T_AUTOKEY FROM accTrnReqPaym A "
+"\n"+"                               WHERE ( A.T_FUTUREPAYERACCOUNT = A.T_ACCT_DB  "
+"\n"+"                                 OR A.T_PAYERACCOUNT = A.T_ACCT_DB  "
+"\n"+"                                 OR EXISTS( SELECT 1 FROM dbrokacc_dbt D  "
+"\n"+"                                            WHERE D.T_ACCOUNT =  A.T_ACCT_DB ) )  "

+"\n"+"                                AND ( A.T_FUTURERECEIVERACCOUNT = A.T_ACCT_CR  "
+"\n"+"                                 OR A.T_RECEIVERACCOUNT = A.T_ACCT_CR  "
+"\n"+"                                 OR EXISTS( SELECT 1 FROM dbrokacc_dbt D  "
+"\n"+"                                            WHERE D.T_ACCOUNT =  A.T_ACCT_CR ) )  )  "
+"\n"+"    AND EXISTS( SELECT 1 FROM dpmpaym_dbt D  "
+"\n"+"                WHERE D.T_PAYMENTID = C.T_ACCTRNID * -1  "
+"\n"+"                 AND ( D.T_PAYERACCOUNT <> C.T_ACCT_DB  "
+"\n"+"                 AND D.T_FUTUREPAYERACCOUNT <> C.T_ACCT_DB  "
+"\n"+"                        AND NOT EXISTS( SELECT 1 FROM dbrokacc_dbt E  "
+"\n"+"                                        WHERE E.T_ACCOUNT =  C.T_ACCT_DB )  "
+"\n"+"                       OR D.T_RECEIVERACCOUNT <> C.T_ACCT_CR  "
+"\n"+"                        AND D.T_FUTURERECEIVERACCOUNT <> C.T_ACCT_CR  "
+"\n"+"                        AND NOT EXISTS( SELECT 1 FROM dbrokacc_dbt E  "
+"\n"+"                                        WHERE E.T_ACCOUNT =  C.T_ACCT_CR )  "
+"\n"+"                       OR ( CASE WHEN D.T_FIID = 0 AND D.T_PAYFIID = 0 OR C.T_AMTCUR = 0  THEN 0 ELSE D.T_AMOUNT END ) <> C.T_AMTCUR  "

+"\n"+"                     ))  "

+"\n"+"   UNION ALL  "

+"\n"+"              /*из ЦФТ в СОФР платежи ЦФТ присутствуют в СОФР, задвоенные в ЦФТ*/ "

+"\n"+"   SELECT D.T_AUTOKEY, D.T_COUNTER, D.T_USERID, D.T_OPDATE, D.T_DOCDATE, D.T_ACCT_DB, D.T_ACCT_CR, D.T_CURRENCY, D.T_AMTCUR, D.T_AMTRUB,  "
+"\n"+"    D.T_DETAILS, D.T_DOCNUM, D.T_ACCTRNID, D.T_IDBISCOTTO, D.T_REQID, 3 AS T_ERR_CODE, 'Из ЦФТ в СОФР. Присутствует в СОФР, задвоенные в ЦФТ' AS T_ERR_TEXT,  "
+"\n"+"    0 AS T_OPER, '' AS T_MODULE  "
+"\n"+"   FROM uloadentforcompare_dbt D,  "
+"\n"+"   (  "
+"\n"+"   SELECT T_ACCTRNID, MAX( T_AUTOKEY ) AS T_AUTOKEY_DOUBLE, MIN( T_AUTOKEY ) AS T_AUTOKEY_PRIOR  FROM uloadentforcompare_dbt C  "
+"\n"+"   WHERE C.T_AUTOKEY IN( ( SELECT A.T_AUTOKEY FROM generalQuery A, dpmpaym_dbt B  "

+"\n"+"                               WHERE A.T_OPDATE BETWEEN ? /*34*/  AND ? /*35*/   "
+"\n"+"                                AND A.T_OPDATE = B.T_VALUEDATE  "

+"\n"+"                                AND ( B.T_FUTUREPAYERACCOUNT = A.T_ACCT_DB  "
+"\n"+"                                 OR B.T_PAYERACCOUNT = A.T_ACCT_DB  "
+"\n"+"                                 OR EXISTS( SELECT 1 FROM dbrokacc_dbt D  "
+"\n"+"                                            WHERE D.T_ACCOUNT =  A.T_ACCT_DB ) )  "

+"\n"+"                                AND ( B.T_FUTURERECEIVERACCOUNT = A.T_ACCT_CR  "
+"\n"+"                                 OR B.T_RECEIVERACCOUNT = A.T_ACCT_CR  "
+"\n"+"                                 OR EXISTS( SELECT 1 FROM dbrokacc_dbt D  "
+"\n"+"                                            WHERE D.T_ACCOUNT =  A.T_ACCT_CR ) )  "

+"\n"+"                                AND B.T_VALUEDATE = A.T_OPDATE  "
+"\n"+"                                AND B.T_PAYMENTID = A.T_ACCTRNID * -1 ) )  "
+"\n"+"    AND C.T_ACCTRNID < 0  "
+"\n"+"    AND C.T_ACCT_DB IS NOT NULL  "
+"\n"+"    AND C.T_ACCT_CR IS NOT NULL  "

+"\n"+"   GROUP BY T_ACCTRNID  "
+"\n"+"   HAVING COUNT(T_ACCTRNID) > 1  "
+"\n"+"   ) A  "
+"\n"+"   WHERE EXISTS( SELECT 1 FROM upmbiscotto_dbt V   "
+"\n"+"                 WHERE V.T_BISCOTTOID = D.T_IDBISCOTTO  "
+"\n"+"                  AND V.T_DOCKIND IN(322, 320)  )  "
+"\n"+"    AND D.T_AUTOKEY = A.T_AUTOKEY_DOUBLE  "

+"\n"+"   UNION ALL  "

+"\n"+"              /*из ЦФТ в СОФР операции ЦФТ отсутствуют в СОФР*/ "
+"\n"+"   SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB,  "
+"\n"+"    T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 1 AS T_ERR_CODE, 'Из ЦФТ в СОФР. Отсутствует в СОФР' AS T_ERR_TEXT,  "
+"\n"+"    0 AS T_OPER, '' AS T_MODULE  "
+"\n"+"   FROM mainQueryNegExistNotNullNotDock C  "
+"\n"+"   WHERE C.T_AUTOKEY NOT IN( SELECT A.T_AUTOKEY FROM generalQuery A, dnptxop_dbt B  "

+"\n"+"                               WHERE A.T_OPDATE BETWEEN ? /*36*/  AND ? /*37*/   "
+"\n"+"                                AND A.T_OPDATE = B.T_OPERDATE  "

+"\n"+"                                AND B.T_OPERDATE = A.T_OPDATE  "
+"\n"+"                                AND B.T_ID = A.T_ACCTRNID * -1 )  " 


// Cherednichenko 2020-11-19 is: 518209, добавляем проверку на проводки по 306-м счетам, которые не выгружались в СОФР
           //  --из ЦФТ в СОФР платежи ЦФТ отсутствуют в СОФР
//shev Добавил привязку к счету, иначе этот список отображается для всех счетов.
+"\n"+      "  UNION ALL  "
+"\n"+      "    SELECT T_AUTOKEY, T_COUNTER, T_USERID, T_OPDATE, T_DOCDATE, T_ACCT_DB, T_ACCT_CR, T_CURRENCY, T_AMTCUR, T_AMTRUB,  "
+"\n"+      "    T_DETAILS, T_DOCNUM, T_ACCTRNID, T_IDBISCOTTO, T_REQID, 1 AS T_ERR_CODE, 'Из ЦФТ не выгружались в СОФР. Отсутствует в СОФР' AS T_ERR_TEXT,  "
+"\n"+      "     0 AS T_OPER, '' AS T_MODULE  "
+"\n"+      "    FROM uloadentforcompare_dbt C "
+"\n"+      "       WHERE  "
//+"\n"+      "       (substr(t_acct_db,1,3) = '306' or substr(t_acct_cr,1,3) = '306') "
+"\n"+      "       (c.t_acct_cr = ? or C.T_ACCT_DB = ?"
+"\n"+      "       and t_acctrnid is null "
+"\n"+      "       and t_opdate between ? and ? "
+"\n"+      "       and t_reqid = ? "
//shev проверяем не загружались ли эти проводки
+"\n"+      "       and not exists (select * from upmbiscotto_dbt where  T_BISCOTTOID in (c.T_IDBISCOTTO)) ";

  AddColumn(@Column, 0, "T_IDBISCOTTO", "ID ЦФТ", 15, V_STRING );
  AddColumn(@Column, 1, "T_ACCTRNID", "ID СОФР", 15, V_STRING );
  AddColumn(@Column, 2, "T_DOCNUM", "Номер документа", 15, V_STRING );
  AddColumn(@Column, 3, "T_ACCT_DB", "Счет дебет", 25, V_STRING );
  AddColumn(@Column, 4, "T_ACCT_CR", "Счет кредит", 25, V_STRING );
  AddColumn(@Column, 5, "T_CURRENCY", "Валюта", 15, V_STRING );
  AddColumn(@Column, 6, "T_AMTCUR", "Сумма в валюте счета", 20, V_MONEY, 2 );
  AddColumn(@Column, 7, "T_AMTRUB", "Сумма в нац. валюте", 20, V_MONEY, 2 );
  AddColumn(@Column, 8, "T_OPDATE", "Дата проводки", 15, V_DATE );
  AddColumn(@Column, 9, "T_ERR_TEXT", "Ошибка", 100, V_STRING );
  AddColumn(@Column, 10, "T_DETAILS", "Назначение", 200, V_STRING );
  AddColumn(@Column, 11, "T_OPER", "Опер.", 13, V_INTEGER );
  AddColumn(@Column, 12, "T_MODULE", "Модуль", 11, V_STRING );

  cmd = RsdCommand(Query);

/*01*/cmd.AddParam( "", RSDBP_IN, Acct );
/*02*/cmd.AddParam( "", RSDBP_IN, string(ParamProcessEntrActualyReq.RecId) );
/*03*/cmd.AddParam( "", RSDBP_IN, Acct );
/*04*/cmd.AddParam( "", RSDBP_IN, Acct );
/*05*/cmd.AddParam( "", RSDBP_IN, minDate );
/*06*/cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
/*07*/cmd.AddParam( "", RSDBP_IN, Acct );
/*08*/cmd.AddParam( "", RSDBP_IN, Acct );
/*09*/cmd.AddParam( "", RSDBP_IN, minDate );
/*10*/cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
/*11*/cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
/*12*/cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
/*13*/cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
/*14*/cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
/*15*/cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
/*16*/cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
/*17*/cmd.AddParam( "", RSDBP_IN, Acct );
/*18*/cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
/*19*/cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
/*20*/cmd.AddParam( "", RSDBP_IN, Acct );
/*21*/cmd.AddParam( "", RSDBP_IN, string(ParamProcessEntrActualyReq.RecId) );
/*22*/cmd.AddParam( "", RSDBP_IN, Acct );
/*23*/cmd.AddParam( "", RSDBP_IN, Acct );
/*24*/cmd.AddParam( "", RSDBP_IN, minDate );
/*25*/cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
/*26*/cmd.AddParam( "", RSDBP_IN, minDate );
/*27*/cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
/*28*/cmd.AddParam( "", RSDBP_IN, minDate );
/*29*/cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
/*30*/cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
/*31*/cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
/*32*/cmd.AddParam( "", RSDBP_IN, Acct );
/*33*/cmd.AddParam( "", RSDBP_IN, Acct );
/*34*/cmd.AddParam( "", RSDBP_IN, minDate );
/*35*/cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
/*36*/cmd.AddParam( "", RSDBP_IN, minDate );
/*37*/cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
// Cherednichenko 2020-11-19 is: 518209, добавляем параметры для проверки
/*38*/cmd.AddParam( "", RSDBP_IN, Acct );
/*39*/cmd.AddParam( "", RSDBP_IN, Acct );
/*40*/cmd.AddParam( "", RSDBP_IN, minDate );
/*41*/cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
/*42*/cmd.AddParam( "", RSDBP_IN, string(ParamProcessEntrActualyReq.RecId)  );


  if (false) //печатаем или нет параметры запроса

    var prevSetOutput = SetOutput("..\\txtfile\\outreq.txt");
    println(Query);
    SetOutput("..\\txtfile\\outparams.txt");

/*01*/println("'"+Acct+"'");
/*02*/println("'"+string(ParamProcessEntrActualyReq.RecId)+"'");
/*03*/println("'"+Acct+"'");
/*04*/println("'"+Acct+"'");
/*05*/println(GetSQLDate(minDate));
/*06*/println(GetSQLDate(ParamProcess.RestDate));
/*07*/println("'"+Acct+"'");
/*08*/println("'"+Acct+"'");
/*09*/println(GetSQLDate(minDate));
/*10*/println(GetSQLDate(ParamProcess.RestDate));
/*11*/println(GetSQLDate(ParamProcess.RestDate));
/*12*/println(GetSQLDate(ParamProcess.RestDate));
/*13*/println(GetSQLDate(ParamProcess.RestDate));
/*14*/println(GetSQLDate(ParamProcess.RestDate));
/*15*/println(GetSQLDate(ParamProcess.RestDate));
/*16*/println(GetSQLDate(ParamProcess.RestDate));
/*17*/println("'"+Acct+"'");
/*18*/println(GetSQLDate(ParamProcess.RestDate));
/*19*/println(GetSQLDate(ParamProcess.RestDate));
/*20*/println("'"+Acct+"'");
/*21*/println("'"+string(ParamProcessEntrActualyReq.RecId)+"'");
/*22*/println("'"+Acct+"'");
/*23*/println("'"+Acct+"'");
/*24*/println(GetSQLDate(minDate));
/*25*/println(GetSQLDate(ParamProcess.RestDate));
/*26*/println(GetSQLDate(minDate));
/*27*/println(GetSQLDate(ParamProcess.RestDate));
/*28*/println(GetSQLDate(minDate));
/*29*/println(GetSQLDate(ParamProcess.RestDate));
/*30*/println(GetSQLDate(ParamProcess.RestDate));
/*31*/println(GetSQLDate(ParamProcess.RestDate));
/*32*/println("'"+Acct+"'");
/*33*/println("'"+Acct+"'");
/*34*/println(GetSQLDate(minDate));
/*35*/println(GetSQLDate(ParamProcess.RestDate));
/*36*/println(GetSQLDate(minDate));
/*37*/println(GetSQLDate(ParamProcess.RestDate));

    SetOutput(prevSetOutput);
  end;


  DataSet = RSDRecordSet( cmd, RSDVAL_CLIENT, RSDVAL_STATIC );
  RunScroll( DataSet, 13, Column, "ScrollProcEntryDifference", @EventHandler, "Проводки с расхождениями по счету СОФР и ЦФТ", "~Esc~ Выход", true, 2, 8 );
  return ExitCode;
end;
//Скроллинг проводок по счетам с расхождениями




//Скроллинг счетов с расхождениями
private macro ScrollProcAcctDifference( ReqId :string, ParamProcess :object ) :integer
var Query :string = "",
    SelectQuery: string = "",
    WithExpr: string = "",
    DataSet :RsdRecordset,
    SQLStrFromArray :string = "",
    cmd, loadCmd, checkDs,
    seqLastVal :integer,
    lastMaxVal :integer,
    curSeqLastVal :integer,
    curMaxVal :integer,
    Column = TArray(),
    res,
    curPage = 1,
    pageSize = 10,
    state :integer = 0;

  macro EventHandler( rsd, cmd, id, key)

   if( (cmd == DLG_KEY) and (key == 27 ) ) //Esc
    ExitCode = 27;
    return CM_SELECT;
   elif( (cmd == DLG_KEY) and (key == 317 ) ) //F3
    //Скроллинг проводок по счету с расхождениями
    ExitCode = Null;
    while( ExitCode != 27 )
     ExitCode = ScrollProcEntryDifference( rsd.value(2), ParamProcess );
    end;

    ExitCode == 317;

    return CM_IGNORE;

   end;

  end;


  checkDs = SQL_ExecuteSimple("DCOMPARE_SETTINGS_DBT", "T_VALUE", "T_KEY = 'MCDOCACC_SEQ_LASTVAL'" );
  checkDs.moveNext();
  seqLastVal = int(checkDs.value(0));

  checkDs = SQL_ExecuteSimple("DCOMPARE_SETTINGS_DBT", "T_VALUE", "T_KEY = 'MCDOCACC_LAST_MAXVAL'" );
  checkDs.moveNext();
  lastMaxVal = int(checkDs.value(0));

  checkDs = SQL_ExecuteSimple("user_sequences", "last_number", "sequence_name = 'DMCACCDOC_DBT_SEQ'" );
  checkDs.moveNext();
  curSeqLastVal = int(checkDs.value(0));

  checkDs = SQL_ExecuteSimple("DMCACCDOC_DBT", "max(t_id)" );
  checkDs.moveNext();
  curMaxVal = int(checkDs.value(0));

  if (curSeqLastVal < seqLastVal)
    lastMaxVal = 0;
  end;

/*
  loadCmd = RsdCommand( 
       " insert into DBROKACC_ACC_DBT (T_BROKACC_KEY,T_ACCOUNTID ) "
 +"\n"+" ( "
 +"\n"+" SELECT  q1.T_AUTOKEY, J.T_ACCOUNTID "
 +"\n"+"   FROM (  SELECT D.T_ID, H.T_CURRENCY, H.T_ACCOUNT, H.T_AUTOKEY "
 +"\n"+"             FROM dbrokacc_dbt          H, "
 +"\n"+"                  dsfcontr_dbt          D, "
 +"\n"+"                  dparty_dbt            E "
// 2021-11-17 Cherednichenko DEF-16965
// +"\n"+"            WHERE     D.T_SERVKIND = H.T_SERVKIND "
// +"\n"+"                  AND D.T_SERVKINDSUB = H.T_SERVKINDSUB "
 +"\n"+"            WHERE     D.T_SERVKIND = case when H.T_SERVKIND = 0 then 1 end  "
 +"\n"+"                  AND D.T_SERVKINDSUB = case when H.T_SERVKINDSUB = 0 then 8 end "
 +"\n"+"                  AND E.T_PARTYID = D.T_PARTYID "
 +"\n"+"                  AND E.T_LEGALFORM = 2 "
 +"\n"+"         GROUP BY D.T_ID, H.T_CURRENCY, H.T_ACCOUNT, H.T_AUTOKEY) q1, "
 +"\n"+"        dmcaccdoc_dbt  I, DACCOUNT_DBT J "
 +"\n"+"  WHERE     q1.T_ID = I.T_CLIENTCONTRID "
 +"\n"+"        AND q1.T_CURRENCY = I.T_CURRENCY "
 +"\n"+"        AND I.T_ID > "+lastMaxVal+" and I.T_ID <= "+curMaxVal
 +"\n"+"        AND I.T_ACCOUNT LIKE SUBSTR (q1.T_ACCOUNT, 1, 5) || '%' "
 +"\n"+"        AND I.T_CATID in (select t_id from DMCCATEG_DBT where t_number = 201) "
 +"\n"+"        AND I.T_ISCOMMON = CHR(88) "
 +"\n"+"        AND J.T_ACCOUNT = I.T_ACCOUNT  "
 +"\n"+"        AND J.T_CHAPTER = I.T_CHAPTER  "
 +"\n"+"        AND J.T_CODE_CURRENCY = I.T_CURRENCY  "
 +"\n"+"        group by q1.T_AUTOKEY, J.T_ACCOUNTID) "
   );
  loadCmd.execute( );
*/

  BegAction(3000,"Дозагружается сопоставление аналитики с синтетикой",false);

//дополняем брокерские счета при необходимости
  InsertBrokacc_acc(lastMaxVal,curMaxVal);

  EndAction();

  BegAction(3000,"Загружаются остатки сопоставления",false);

// Загружаем остатки 
  InsertBrokacc_accrest(ParamProcess.RestDate);

  EndAction();


  SQLStrFromArray = GetSQLStrFromArray( ParamProcess );

/*
  WithExpr = 
    " with "
+"\n"+"  accMainCompare as (select * from uloadaccforcompare_dbt where T_REQID = ? ), "
+"\n"+"  accOnlySvod as (select * from accMainCompare where T_ACCT LIKE '306%' ) ";*/

  SelectQuery
        = "  SELECT A.T_AUTOKEY, A.T_COUNTER, A.T_ACCT, A.T_CURRENCY, "+
          "  A.T_RESTINCUR, " +
          "  A.T_RESTINRUB, " +
          "  A.T_DEBITCUR, " +
          "  A.T_DEBITRUB, " +
          "  A.T_CREDITCUR, " +
          "  A.T_CREDITRUB, " +
          "  A.T_RESTOUTCUR, " +
          "  A.T_RESTOUTRUB, " +
          " CAST(( CASE WHEN B.T_CODE_CURRENCY > 0 THEN RSB_ACCOUNT.RESTAC ( A.T_ACCT, B.T_CODE_CURRENCY, ? -1, B.T_CHAPTER, NULL) ELSE 0 END ) AS NUMBER(32,12)) AS T_RESTINCUR_, "+
          " CAST(RSB_ACCOUNT.RESTAC ( A.T_ACCT, B.T_CODE_CURRENCY, ? -1, B.T_CHAPTER, NULL, 0 ) AS NUMBER(32,12)) AS T_RESTINRUB_, "+
          " CAST(( CASE WHEN B.T_CODE_CURRENCY > 0 THEN RSB_ACCOUNT.DEBETAC ( A.T_ACCT, B.T_CHAPTER, B.T_CODE_CURRENCY, ?, ? ) ELSE 0 END ) AS NUMBER(32,12)) AS T_DEBITCUR_, "+
          " CAST(RSB_ACCOUNT.DEBETAC ( A.T_ACCT, B.T_CHAPTER, B.T_CODE_CURRENCY, ?, ?, 0 ) AS NUMBER(32,12)) AS T_DEBITRUB_, "+
          " CAST(( CASE WHEN B.T_CODE_CURRENCY > 0 THEN RSB_ACCOUNT.KREDITAC ( A.T_ACCT, B.T_CHAPTER, B.T_CODE_CURRENCY, ?, ? ) ELSE 0 END ) AS NUMBER(32,12)) AS T_CREDITCUR_,  "+
          " CAST(RSB_ACCOUNT.KREDITAC ( A.T_ACCT, B.T_CHAPTER, B.T_CODE_CURRENCY, ?, ?, 0 ) AS NUMBER(32,12)) AS T_CREDITRUB_,  "+
          " CAST(( CASE WHEN B.T_CODE_CURRENCY > 0 THEN RSB_ACCOUNT.RESTAC ( A.T_ACCT, B.T_CODE_CURRENCY, ?, B.T_CHAPTER, NULL ) ELSE 0 END ) AS NUMBER(32,12)) AS T_RESTOUTCUR_, "+
          " CAST(RSB_ACCOUNT.RESTAC ( A.T_ACCT, B.T_CODE_CURRENCY, ?, B.T_CHAPTER, NULL, 0 ) AS NUMBER(32,12)) AS T_RESTOUTRUB_, "+
          "  A.T_REQID, A.T_DETAILS " +
          " FROM uloadaccforcompare_dbt A, daccount_dbt B " +
          " , ( " + SQLStrFromArray + " ) Z " +
          " WHERE A.T_REQID = ? "+
          " AND B.T_ACCOUNT = A.T_ACCT "+
          " AND EXISTS (select 1 from DBALACC_TOCOMPARE_DBT k where A.T_ACCT like k.T_ACC) "+
          " AND B.T_CODE_CURRENCY = ( SELECT F.T_FIID FROM dfininstr_dbt F WHERE F.T_CODEINACCOUNT = A.T_CURRENCY AND F.T_FI_KIND = 1 AND F.T_AVOIRKIND = 0 AND ROWNUM = 1 ) "+
          " AND B.T_CHAPTER > 0 "+
          "  AND ( Z.ID < 0 " +
          "   OR ( Z.ACC = CHR(1) " +
          "    OR RSB_MASK.CompareStringWithMask( Z.ACC, A.T_ACCT ) > 0 ) ) "+
//shev
          "    and not exists (select 1 from dbrokacc_dbt where t_account = a.t_acct) "+


          " UNION ALL "+

          " SELECT S.T_AUTOKEY, S.T_COUNTER, S.T_ACCT, S.T_CURRENCY, "+
          " S.T_RESTINCUR, " +
          " S.T_RESTINRUB, " +
          " S.T_DEBITCUR, " +
          " S.T_DEBITRUB, " +
          " S.T_CREDITCUR, " +
          " S.T_CREDITRUB, " +
          " S.T_RESTOUTCUR, " +
          " S.T_RESTOUTRUB, " +
          " CAST(R.T_RESTINCUR as NUMBER(32,12)) as T_RESTINCUR_, " +
          " CAST(R.T_RESTINRUB as NUMBER(32,12)) as T_RESTINRUB_, " +
          " CAST(R.T_DEBITCUR as NUMBER(32,12)) as T_DEBITCUR_, " +
          " CAST(R.T_DEBITRUB as NUMBER(32,12)) as T_DEBITRUB_, " +
          " CAST(R.T_CREDITCUR as NUMBER(32,12)) as T_CREDITCUR_, " +
          " CAST(R.T_CREDITRUB as NUMBER(32,12)) as T_CREDITRUB_, " +
          " CAST(R.T_RESTOUTCUR as NUMBER(32,12)) as T_RESTOUTCUR_, " +
          " CAST(R.T_RESTOUTRUB as NUMBER(32,12)) as T_RESTOUTRUB_, " +

/*
          " SUM ( CASE WHEN c.T_CODE_CURRENCY > 0 THEN RSB_ACCOUNT.RESTAC ( c.T_ACCOUNT, c.T_CODE_CURRENCY, ? -1, c.T_CHAPTER, NULL) ELSE 0 END ) as T_RESTINCUR_, "+
          " SUM ( RSB_ACCOUNT.RESTAC ( C.T_ACCOUNT, C.T_CODE_CURRENCY, ? -1, C.T_CHAPTER, NULL, 0 ) ) as T_RESTINRUB_, "+
          " SUM ( CASE WHEN C.T_CODE_CURRENCY > 0 THEN RSB_ACCOUNT.DEBETAC ( C.T_ACCOUNT, C.T_CHAPTER, C.T_CODE_CURRENCY, ?, ? ) ELSE 0 END ) as T_DEBITCUR_, "+
          " SUM ( RSB_ACCOUNT.DEBETAC ( C.T_ACCOUNT, C.T_CHAPTER, C.T_CODE_CURRENCY, ?, ?, 0 ) ) as T_DEBITRUB_,  "+
          " SUM ( CASE WHEN C.T_CODE_CURRENCY > 0 THEN RSB_ACCOUNT.KREDITAC ( C.T_ACCOUNT, C.T_CHAPTER, C.T_CODE_CURRENCY, ?, ? ) ELSE 0 END ) as T_CREDITCUR_, "+
          " SUM ( RSB_ACCOUNT.KREDITAC ( C.T_ACCOUNT, C.T_CHAPTER, C.T_CODE_CURRENCY, ?, ?, 0 ) ) as T_CREDITRUB_, "+
          " SUM ( CASE WHEN C.T_CODE_CURRENCY > 0 THEN RSB_ACCOUNT.RESTAC ( C.T_ACCOUNT, C.T_CODE_CURRENCY, ?, C.T_CHAPTER, NULL ) ELSE 0 END ) as T_RESTOUTCUR_, "+
          " SUM ( RSB_ACCOUNT.RESTAC ( C.T_ACCOUNT, C.T_CODE_CURRENCY, ?, C.T_CHAPTER, NULL, 0 ) ) as T_RESTOUTRUB_, "+
*/
          " S.T_REQID, S.T_DETAILS "+

          " FROM uloadaccforcompare_dbt S, "+
          //" dbrokacc_dbt A, DBROKACC_ACC_TMP b, daccount_dbt c "+
          " dbrokacc_dbt A, DBROKACC_ACCREST_TMP r "+
          " , ( " + SQLStrFromArray + " ) Z " +
          " WHERE T_REQID = ? and T_ACCT LIKE '306%' and S.T_ACCT = A.T_ACCOUNT and a.t_autokey = r.T_BROKACC_KEY and r.T_RESTDATE = ?"+//AND b.t_accountid = c.t_accountid "+
          " AND EXISTS (select 1 from DBALACC_TOCOMPARE_DBT k where s.T_ACCT like k.T_ACC) "+
//shev          " AND NOT EXISTS( SELECT 1 FROM daccount_dbt G WHERE G.T_ACCOUNT = S.T_ACCT ) "+
          "  AND ( Z.ID < 0 " +
          "   OR ( Z.ACC = CHR(1) " +
          "    OR RSB_MASK.CompareStringWithMask( Z.ACC, S.T_ACCT ) > 0 ) ) ";

         // " GROUP BY S.t_autokey, S.T_COUNTER, S.T_ACCT, S.T_CURRENCY, S.T_REQID, S.T_DETAILS, S.T_RESTINCUR, S.T_RESTINRUB, S.T_DEBITCUR, S.T_DEBITRUB, S.T_CREDITCUR, S.T_CREDITRUB, S.T_RESTOUTCUR, S.T_RESTOUTRUB ";
          

  Query = "select * from ("+SelectQuery+")"+
          "  WHERE ( ROUND(T_RESTINCUR,1)  <> ROUND(T_RESTINCUR_,1) " +
          "       OR ROUND(T_RESTINRUB,1)  <> ROUND(T_RESTINRUB_,1)   " +
          "       OR ROUND(T_DEBITCUR,1)   <> ROUND(T_DEBITCUR_,1)     " +
          "       OR ROUND(T_DEBITRUB,1)   <> ROUND(T_DEBITRUB_,1)     " +
          "       OR ROUND(T_CREDITCUR,1)  <> ROUND(T_CREDITCUR_,1)   " +
          "       OR ROUND(T_CREDITRUB,1)  <> ROUND(T_CREDITRUB_,1)   " +
          "       OR ROUND(T_RESTOUTCUR,1) <> ROUND(T_RESTOUTCUR_,1) " +
          "       OR ROUND(T_RESTOUTRUB,1) <> ROUND(T_RESTOUTRUB_,1) )";

  AddColumn(@Column, 0, "T_ACCT", "Счет", 25, V_STRING );
  AddColumn(@Column, 1, "T_RESTINCUR", "Вх.остаток ЦФТ", 20, V_MONEY, 2 );
  AddColumn(@Column, 2, "T_RESTINCUR_", "Вх.остаток СОФР", 20, V_MONEY, 2 );
  AddColumn(@Column, 3, "T_RESTINRUB", "Вх.остаток экв. ЦФТ", 20, V_MONEY, 2 );
  AddColumn(@Column, 4, "T_RESTINRUB_", "Вх.остаток экв. СОФР", 20, V_MONEY, 2 );
  AddColumn(@Column, 5, "T_DEBITCUR", "Обороты дебет ЦФТ", 20, V_MONEY, 2 );
  AddColumn(@Column, 6, "T_DEBITCUR_", "Обороты дебет СОФР", 20, V_MONEY, 2 );
  AddColumn(@Column, 7, "T_DEBITRUB", "Обороты дебет экв. ЦФТ", 20, V_MONEY, 2 );
  AddColumn(@Column, 8, "T_DEBITRUB_", "Обороты дебет экв. СОФР", 20, V_MONEY, 2 );
  AddColumn(@Column, 9, "T_CREDITCUR", "Обороты кредит ЦФТ", 20, V_MONEY, 2 );
  AddColumn(@Column, 10, "T_CREDITCUR_", "Обороты кредит СОФР", 20, V_MONEY, 2 );
  AddColumn(@Column, 11, "T_CREDITRUB", "Обороты кредит экв. ЦФТ", 20, V_MONEY, 2 );
  AddColumn(@Column, 12, "T_CREDITRUB_", "Обороты кредит экв. СОФР", 20, V_MONEY, 2 );
  AddColumn(@Column, 13, "T_RESTOUTCUR", "Исх.остаток ЦФТ", 20, V_MONEY, 2 );
  AddColumn(@Column, 14, "T_RESTOUTCUR_", "Исх.остаток СОФР", 20, V_MONEY, 2 );
  AddColumn(@Column, 15, "T_RESTOUTRUB", "Исх.остаток экв. ЦФТ", 20, V_MONEY, 2 );
  AddColumn(@Column, 16, "T_RESTOUTRUB_", "Исх.остаток экв. СОФР", 20, V_MONEY, 2 );
  cmd = RsdCommand(Query);

  cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
  cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
  cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
  cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
  cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
  cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
  cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
  cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
  cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
  cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
  cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
  cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );

  cmd.AddParam( "", RSDBP_IN, ReqId );


  /*cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
  cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
  cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
  cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
  cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
  cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
  cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
  cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
  cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
  cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
  cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );
  cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );*/

  cmd.AddParam( "", RSDBP_IN, ReqId );
  cmd.AddParam( "", RSDBP_IN, ParamProcess.RestDate );

  DataSet = RSDRecordSet( cmd, RSDVAL_CLIENT, RSDVAL_STATIC );
  RunScroll( DataSet, 17, Column, "ScrollProcAcctDifference", @EventHandler, "Счета с расхождениями СОФР и ЦФТ", "~Esc~ Выход    ~F3~ Проводки", true, 2, 8 );
  return ExitCode;
end;
//Скроллинг счетов с расхождениями



//Скроллинг запросов и сверок
private macro ScrollProcAcctCompare( AcctList :@object ) :integer
var Query :string = "",
    DataSet :RsdRecordset,
    cmd,
    Column = TArray(),
    File_Path :string = "", 
    FileName :string = "",
    ParamProcess :TParamProcessAcctVerify,
    ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
    res,
    state :integer = 0;

  macro EventHandler( rsd, cmd, id, key)

   if( (cmd == DLG_KEY) and (key == 27 ) ) //Esc
    ExitCode = 27;
    return CM_SELECT;

   elif( (cmd == DLG_KEY) and (key == 18 ) ) //Ctrl+R
    ExitCode = 18;
    return CM_SELECT;

   elif( (cmd == DLG_KEY) and (key == 317 ) and ( (rsd.value(2) == 4) or (rsd.value(2) == 5) ) ) //F3
    //Скроллинг счетов с расхождениями
    ExitCode = Null;
    ParamProcess = Null;
    ParamProcess = TParamProcessAcctVerify( string( rsd.value(0) )  + ";" +  "5008" + ";" + rsd.value(3) + ";4"); //установить статус 4
    while( ExitCode != 27 )
     ExitCode = ScrollProcAcctDifference( rsd.value(0), ParamProcess );;
    end;
    ParamProcess = Null;
    ExitCode = 317;

    return CM_IGNORE;

   elif( (cmd == DLG_KEY) and (key == 316 ) ) //F2
    //Загрузка и сверка

     GetRegistryValue("РСХБ\\ИНТЕГРАЦИЯ\\ДИРЕКТОРИИ\\IMPORT\\ACCTCOMPAREDIR", V_STRING, File_Path);
     FileName = "";

     if( ( (rsd.value(2) == 2) or (rsd.value(2) == 5) ) and ( GetString(FileName, "Имя файла:") ) and ( FileName != "" ) )
      if( (rsd.value(0) > 0) and ( LoopLoad /*LoadAcctForCompare*/( 0, 3, File_Path + "\\" + FileName, string(rsd.value(0) ), 1 ) ) )
//Str_Param = "1689731;5009;[AccD47421810400002000002;AccC;AccD;AccC47421810400002000002]1;14.05.2019;00.00.00";
        ParamProcess = Null;
/*
        ParamProcess = TParamProcessEntriesVerify( string( rsd.value(0) )  + ";" +  "5009" + ";" + "1"+ ";" +
          StrSubst( string(ParamProcess.DateIn /*Begin*/):10," ","0") + ";"  + StrSubst( string(ParamProcess.DateOut /*End*/):10," ","0") + ";4"); //установить статус 4
*/
        ParamProcess = TParamProcessAcctVerify( string( rsd.value(0) )  + ";" +  "5008" + ";" + rsd.value(3) + ";4"); //установить статус 4
        MsgBox("Загрузка файла " + FileName + " завершена." + "Результаты загрузки в лог " + File_Path + "\\" + "CTL_" + string(UserNumber) + ".log" + ".");
        BegAction(2000,"Выполнение сверки");
        res = AcctCompareRep( rsd.value(0), ParamProcess, 1 );
        EndAction;
        if( ( res ) or ( ValType(res) == V_UNDEF ) )
         MsgBox( "Сверка счетов по запросу " + string( ParamProcess.RecId ) + " завершена успешно.");
         //установка статуса в uTableProcessEvent_dbt
         ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
         ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
         ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
         ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
         if( not ProcessEventTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
          state = 1;
         end;
         ParamProcess = Null;
         ProcessEventTbl = Null;
         //установка статуса в uTableProcessEvent_dbt
        else
         MsgBox( "Сверка счетов по запросу " + string( ParamProcess.RecId ) + " завершена с ошибкой.");
         ParamProcess = Null;
         ProcessEventTbl = Null;
        end;

      end;
     end;

//Update событие со статусом 4
    ExitCode = 316;

    return CM_SELECT;

   end;

  end;

  Query = " SELECT A.T_RECID, A.T_TIMESTAMP, A.T_STATUS, A.T_PARAM, " +
          "  ( CASE WHEN A.T_STATUS = 1 THEN 'направляется в ЦФТ' " +
          "         WHEN A.T_STATUS = 2 THEN 'обрабатывается в ЦФТ' " +
          "         WHEN A.T_STATUS = 3 THEN 'передача результата обработки ETL' " +
          "         WHEN A.T_STATUS = 4 THEN 'завершена загрузка в СОФР' " +
          "         WHEN A.T_STATUS = 5 THEN 'ошибка обработки в СОФР' " +
          "    END ) AS T_STATUSNAME, " +
          "  ( SELECT DISTINCT B.T_RESULTTEXT FROM utableprocessin_dbt B " +
          "    WHERE TRIM(B.T_RESULTTEXT) = 'GetAcctForVerify_' || TO_CHAR( A.T_RECID ) || '.csv' " +
          "     AND B.T_OBJECTTYPE = 7 " +
          "     AND B.T_STATUS = 4 ) AS T_FILENAME, " +
          "  A.T_OPER " +
          " FROM utableprocessevent_dbt A " +
          " WHERE A.T_OBJECTTYPE = ? " +
          " ORDER BY 1 DESC ";


  AddColumn(@Column, 0, "T_RECID", "ИД запроса", 10, V_INTEGER );
  AddColumn(@Column, 1, "T_TIMESTAMP", "Дата запроса", 20, V_DATE );
//  AddColumn(@Column, 2, "T_STATUS", "Статус", 6, V_INTEGER );
  AddColumn(@Column, 2, "T_STATUSNAME", "Статус", 26, V_STRING );
  AddColumn(@Column, 3, "T_FILENAME", "Файл", 26, V_STRING );
  AddColumn(@Column, 4, "T_PARAM", "Параметры запроса", 250, V_STRING );
  AddColumn(@Column, 5, "T_OPER", "Опер.", 6, V_INTEGER );

  cmd = RsdCommand(Query);
  cmd.AddParam( "p_ObjectType", RSDBP_IN, 5008 );

  DataSet = RSDRecordSet( cmd, RSDVAL_CLIENT, RSDVAL_STATIC );
  RunScroll( DataSet, 6, Column, "ScrollProcAcctCompare", @EventHandler, "Запросы в ЦФТ", "~Esc~ Выход    ~F2~ Загрузка и Сверка    ~F3~ Счета", true, 2, 8 );
  return ExitCode;
end;
//Скроллинг запросов и сверок



//Скроллинг запросов и сверок
private macro ScrollProcEntCompare( p_RepMode: integer, EntryList :@object ) :integer
var Query :string = "",
    DataSet :RsdRecordset,
    cmd,
    Column = TArray(),
    File_Path :string = "", 
    FileName :string = "",
    ParamProcess :TParamProcessEntriesVerify,
    ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
    res,
    errortext :string = "Неизвестная ошибка",    
    RepMode: integer = p_RepMode,
    state :integer = 0;

  macro EventHandler( rsd, cmd, id, key)

   if( (cmd == DLG_KEY) and (key == 27 ) ) //Esc
    ExitCode = 27;
    return CM_SELECT;

   elif( (cmd == DLG_KEY) and (key == 18 ) ) //Ctrl+R
    ExitCode = 18;
    return CM_SELECT;

   elif( (cmd == DLG_KEY) and (key == 316 ) ) //F2
    //Загрузка и сверка

     GetRegistryValue("РСХБ\\ИНТЕГРАЦИЯ\\ДИРЕКТОРИИ\\IMPORT\\ENTRYCOMPAREDIR", V_STRING, File_Path);
     FileName = "";

     if( ( (rsd.value(2) == 2) or (rsd.value(2) == 5) ) and ( GetString(FileName, "Имя файла:") ) and ( FileName != "" ) )
      if( (rsd.value(0) > 0) and ( LoopLoad /*LoadEntryForCompare*/( 1, 3, File_Path + "\\" + FileName, string(rsd.value(0) ), 1 ) ) )
//Str_Param = "1689731;5009;[AccD47421810400002000002;AccC;AccD;AccC47421810400002000002]1;14.05.2019;00.00.00";
        ParamProcess = Null;
/*
        ParamProcess = TParamProcessEntriesVerify( string( rsd.value(0) )  + ";" +  "5009" + ";" + "1"+ ";" +
          StrSubst( string(ParamProcess.DateIn /*Begin*/):10," ","0") + ";"  + StrSubst( string(ParamProcess.DateOut /*End*/):10," ","0") + ";4"); //установить статус 4
*/
        ParamProcess = TParamProcessEntriesVerify( string( rsd.value(0) )  + ";" +  "5009" + ";" + rsd.value(3) + ";4"); //установить статус 4
        MsgBox("Загрузка файла " + FileName + " завершена." + "Результаты загрузки в лог " + File_Path + "\\" + "CTL_" + string(UserNumber) + ".log" + ".");

        res = EntCompareRep( rsd.value(0), ParamProcess, 1, @errortext, RepMode );
        if( ( res ) or ( ValType(res) == V_UNDEF ) )
         MsgBox( "Сверка проводок по запросу " + string( ParamProcess.RecId ) + " завершена успешно.");
         //установка статуса в uTableProcessEvent_dbt
         ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
         ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
         ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
         ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
         if( not ProcessEventTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
          state = 1;
         end;
         ParamProcess = Null;
         ProcessEventTbl = Null;
         //установка статуса в uTableProcessEvent_dbt
        else
         MsgBox( "Сверка проводок по запросу " + string( ParamProcess.RecId ) + " завершена с ошибкой.");
         ParamProcess = Null;
         ProcessEventTbl = Null;
        end;

      end;
     end;

//Update событие со статусом 4
    ExitCode == 316;

    return CM_SELECT;

   end;

  end;

  Query = " SELECT A.T_RECID, A.T_TIMESTAMP, A.T_STATUS, A.T_PARAM, " +
          "  ( CASE WHEN A.T_STATUS = 1 THEN 'направляется в ЦФТ' " +
          "         WHEN A.T_STATUS = 2 THEN 'обрабатывается в ЦФТ' " +
          "         WHEN A.T_STATUS = 3 THEN 'передача результата обработки ETL' " +
          "         WHEN A.T_STATUS = 4 THEN 'завершена загрузка в СОФР' " +
          "    END ) AS T_STATUSNAME, " +
          "  ( SELECT DISTINCT B.T_RESULTTEXT FROM utableprocessin_dbt B " +
          "    WHERE TRIM(B.T_RESULTTEXT) = 'GetEntriesForVerify_' || TO_CHAR( A.T_RECID ) || '.csv' " +
          "     AND B.T_OBJECTTYPE = 8 " +
          "     AND B.T_STATUS = 4 ) AS T_FILENAME, " +
          "  A.T_OPER " +
          " FROM utableprocessevent_dbt A " +
          " WHERE A.T_OBJECTTYPE = ? " +
          " ORDER BY 1 DESC ";


  AddColumn(@Column, 0, "T_RECID", "ИД запроса", 10, V_INTEGER );
  AddColumn(@Column, 1, "T_TIMESTAMP", "Дата запроса", 20, V_DATE );
//  AddColumn(@Column, 2, "T_STATUS", "Статус", 6, V_INTEGER );
  AddColumn(@Column, 2, "T_STATUSNAME", "Статус", 26, V_STRING );
  AddColumn(@Column, 3, "T_FILENAME", "Файл", 26, V_STRING );
  AddColumn(@Column, 4, "T_PARAM", "Параметры запроса", 250, V_STRING );
  AddColumn(@Column, 5, "T_OPER", "Опер.", 6, V_INTEGER );


  cmd = RsdCommand(Query);
  cmd.AddParam( "p_ObjectType", RSDBP_IN, 5009 );

  DataSet = RSDRecordSet( cmd, RSDVAL_CLIENT, RSDVAL_STATIC );
  RunScroll( DataSet, 6, Column, "ScrollProcEntCompare", @EventHandler, "Запросы в ЦФТ", "~Esc~ Выход    ~F2~ Загрузка и Сверка", true, 2, 8 );
  return ExitCode;
end;
//Скроллинг запросов и сверок




//панель параметров сверки
class (TRsbPanel) UserEntComparePanel( DateReport_ :date, p_RepMode: integer )
var DateBegin :date = DateReport_
   , DateEnd :date = DateReport_
   , StrFilterParam :string = ""
   , Fl_Acc :bool = false
   , Fl_Entry :bool = true
   , EntryList :TArray
   , AcctList :TArray
   , FlFilterAcc :string = ""
   , FlFilterEnt :string = ""
   , RepMode: integer = p_RepMode
   ;

  SQL_Execute("TRUNCATE TABLE DBROKACC_ACCREST_TMP");

  var dsDate = SQL_ExecuteSimple("ULOADENTFORCOMPARE_DBT", "min(t_docdate)");
  dsDate.moveNext();

  minDate = date(dsDate.value(0));

  InitTRsbPanel();
  SetCaption("Панель запроса сверки");
  SetStatus("~F2~ Отправить    ~F3~ Выбор    ~F4~ Результат    ~F5~ Фильтр    ~Esc~ Выход");
  SetSize(38,8);
  SetPosition(2,1);



 var DateBeginLabel :TRsbLabel = TRsbLabel(3, 2, "Дата c ");
     addLabel(DateBeginLabel);

 var DateBeginEdFld :TRsbEditField = TRsbEditField(FT_DATE);
     DateBeginEdFld.setPosition(8,2);
     DateBeginEdFld.setSize(9,1);
     DateBeginEdFld.Name = "DateBeginEdFld";
     DateBeginEdFld.value = DateBegin;
     addControl(DateBeginEdFld);

 var DateEndLabel :TRsbLabel = TRsbLabel(17, 2, " по ");
     addLabel(DateEndLabel);

 var DateEndEdFld :TRsbEditField = TRsbEditField(FT_DATE);
     DateEndEdFld.setPosition(20,2);
     DateEndEdFld.setSize(9,1);
     DateEndEdFld.Name = "DateEndEdFld";
     DateEndEdFld.value = DateEnd;
     addControl(DateEndEdFld);

 var FlFilterAccEdFld :TRsbEditField = TRsbEditField(FT_STRING);
     FlFilterAccEdFld.setPosition(30,2);
     FlFilterAccEdFld.setSize(3,1);
     FlFilterAccEdFld.TextLength = 3;
     FlFilterAccEdFld.Editable = False;
     FlFilterAccEdFld.Focusable = False;
     FlFilterAccEdFld.Name = "FlFilterAccEdFld";
     FlFilterAccEdFld.value = FlFilterAcc;
     addControl(FlFilterAccEdFld);

 var FlFilterEntEdFld :TRsbEditField = TRsbEditField(FT_STRING);
     FlFilterEntEdFld.setPosition(34,2);
     FlFilterEntEdFld.setSize(3,1);
     FlFilterEntEdFld.TextLength = 3;
     FlFilterEntEdFld.Editable = False;
     FlFilterEntEdFld.Focusable = False;
     FlFilterEntEdFld.Name = "FlFilterEntEdFld";
     FlFilterEntEdFld.value = FlFilterEnt;
     addControl(FlFilterEntEdFld);


  var AccLabel :TRsbLabel = TRsbLabel(5, 4, "Счет");
      AddLabel(AccLabel);


  var //AccCheckBox :TRsbCheckBox = TRsbCheckBox;
      AccRadioButton :TRsbRadioButton = TRsbRadioButton;
      AccRadioButton.SetPosition(3,4);
      AccRadioButton.GroupId = 11;
      AccRadioButton.Checked = Fl_Acc;
      AccRadioButton.Name = "AccRadioButton";
      AddControl(AccRadioButton);


  var EntryLabel :TRsbLabel = TRsbLabel(5, 6, "Проводка");
      AddLabel(EntryLabel);


  var //EntryCheckBox :TRsbCheckBox = TRsbCheckBox;
      EntryRadioButton :TRsbRadioButton = TRsbRadioButton;
      EntryRadioButton.SetPosition(3,6);
      EntryRadioButton.Checked = Fl_Entry;
      EntryRadioButton.GroupId = 11;
      EntryRadioButton.Name = "EntryRadioButton";
      AddControl(EntryRadioButton);


  AddEventHandler(RSB_EV_KEY_PRESSED, R2M(this, "onKeyPressed"));

  macro onKeyPressed(RsbEvent:Object)
  var focusedControl,
      ReqId :integer = 0;

   if( RsbEvent.KeyCode == 319 )  //F5
    ExitCode = Null;
    while( ExitCode != 27 )

     if(Fl_Acc)
      ExitCode = AcctListFilter( @AcctList ); //Возвращает флаг если true перезалить массив фильтра счетов
      if( ( AcctList == Null ) or ( AcctList.Size == 0 ) or ( AcctList[0][0] == "-1" ) )
       FlFilterAcc = "";
      else
       FlFilterAcc = "ФC";
      end;
      FlFilterAccEdFld.value = FlFilterAcc;
     end;

     if(Fl_Entry)
      ExitCode = EntryListFilter( @EntryList ); //Возвращает флаг если true перезалить массив фильтра проводок
      if( ( EntryList == Null ) or ( EntryList.Size == 0 ) or ( EntryList[0][0] == "-1" ) and ( EntryList[0][1] == "-1" ) and ( EntryList[0][2] == "-1" ) )
       FlFilterEnt = "";
      else
       FlFilterEnt = "ФП";
      end;
      FlFilterEntEdFld.value = FlFilterEnt;
     end;
    end;

   elif( RsbEvent.KeyCode == 317 )  //F3
    focusedControl = this.focusedControl();

    if( focusedControl.Name == "DateBeginEdFld" )
     DateBegin = GetDateByCalendar(DateBegin);
     if( DateBegin != DateBeginEdFld.value  )
      DateBeginEdFld.value = DateBegin;
     end;
    end;

    if( focusedControl.Name == "DateEndEdFld" )
     DateEnd = GetDateByCalendar(DateEnd);
     if( DateEnd != DateEndEdFld.value  )
      DateEndEdFld.value = DateEnd;
     end;
    end;

   elif( RsbEvent.KeyCode == 32 )  //Space
    focusedControl = this.focusedControl();

    if( focusedControl.Name == "AccRadioButton" )
     DateEndEdFld.value = DateBeginEdFld.value;
     Fl_Acc = AccRadioButton.Checked;
     Fl_Entry = EntryRadioButton.Checked;
    end;

    if( focusedControl.Name == "EntryRadioButton" )
     Fl_Acc = AccRadioButton.Checked;
     Fl_Entry = EntryRadioButton.Checked;
    end;

   elif( RsbEvent.KeyCode == 27 )  //Esc
    this.Close(RsbEvent.KeyCode);

   elif( RsbEvent.KeyCode == 316 )  //F2
    //вызываем функционал Request
    Fl_Acc = AccRadioButton.Checked;
    Fl_Entry = EntryRadioButton.Checked;
    DateBegin = DateBeginEdFld.Value;
    DateEnd = DateEndEdFld.Value;

    if(Fl_Acc)
     DateEndEdFld.value = DateBeginEdFld.value;
     DateEnd = DateBegin;
     //Insert событие Request со статусом 11
//Str_Param = "1689731;5008;[Acc306*;Acc407*]1;10.07.2019;2";
     ReqId = InsUserEvent( 5008, 1, 1, 1, GetStrAddParamAcct( AcctList ) + "1" + ";" + StrSubst( string(DateBegin):10," ","0") );
     MsgBox( "Создан запрос в ЦФТ, Id события " +  string(ReqId) );

    end;

    if(Fl_Entry)
//shev def-25660
     if(DateEnd < DateBegin)
       msgbox("Дата начала периода больше даты конца периода");
     else
       //Insert событие Request со статусом 11
       if( ( DateShift(DateBegin, 30) > DateEnd ) or ( MsgBoxEx( "Большой период запроса проводок. Подтверждаете?", MB_YES+MB_NO, IND_NO, "Предупреждениее","" ) ==  IND_YES ) )
       //Str_Param = "1689731;5009;[AccD47421810400002000002;AccC;AccD;AccC47407840399000000002]1;14.05.2019;00.00.00;2";
       ReqId = InsUserEvent( 5009, 1, 1, 1, GetStrAddParamEntry( EntryList ) + "1" + ";" + StrSubst( string(DateBegin):10," ","0") + ";"  + StrSubst( string(DateEnd):10," ","0") );
       MsgBox( "Создан запрос в ЦФТ, Id события " +  string(ReqId) );
       end;
     end;
    end;
    //вызываем функционал Request

   elif( RsbEvent.KeyCode == 318 )  //F4
    Fl_Acc = AccRadioButton.Checked;
    Fl_Entry = EntryRadioButton.Checked;
//    DateBegin = DateBeginEdFld.Value;
//    DateEnd = DateEndEdFld.Value;

    if(Fl_Acc)

     //Скроллинг запросов и сверок
     ExitCode = Null;
     while( ExitCode != 27 )
      ExitCode = ScrollProcAcctCompare;
     end;
     //Скроллинг запросов и сверок


    end;

    if(Fl_Entry)

     //Скроллинг запросов и сверок
     ExitCode = Null;
     while( ExitCode != 27 )
      ExitCode = ScrollProcEntCompare(RepMode);
     end;
     //Скроллинг запросов и сверок

    end;

   end;

  end;

end;
//панель параметров сверки
