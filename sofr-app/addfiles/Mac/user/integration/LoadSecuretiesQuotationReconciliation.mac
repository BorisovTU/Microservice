/*------------------------------------------*/
/* Сервис НОВАЯ Реконсиляция по котировкам  */
/* 2020-01-17                               */
/* Автор: Синицын А.                        */
/* теперь расширенная и по иному алгоритму  */
/*------------------------------------------*/
import "global_utils_intgr.mac"; 
import "com_fin_instr_rates.mac";
import "secur_prc_msg_transform.mac"; /* Функционал преобразования сообщений */
import "u_common_email_utils.mac";

private const CV_Rate_DEFAULT_CODE = 0;
private const CV_Rate_ERROR_CODE = -1;
private const CV_EMAIL_HEAD = "Ошибка. NEW Реконсиляция по котировкам";
private const CV_EMAIL_ROW_HEAD = "LoadSecuretiesQuotationReconciliation: ";
private const CV_EMAIL_RECEIVER = "";



/*-------------------*/
/* Описание объектов */
/*-------------------*/

/* Данные запроса сервиса Загрузки данных по котировкам */
private class c_LoadSecuretiesQuotationReconciliation_req
   var ReqID          : string  /* (  1) ИД запроса */
      ,SenderId       : string  /* (0-1) Код АС-источника сведений */
      ,QuotationDate  : date    /* дата котировок */
end;
/*
*/

private class c_Result_LoadSecuretiesQuotationReconciliation_resp
   var Code : integer /* (  1) Код */
      ,Text : string; /* (0-1) Описание */
end;

private class c_QuotationList_LoadSecuretiesQuotationReconciliation_resp
   var FI_Code      : string; /* (  1) Код бумажки или иного фин инструмента */         
   var Type 	    : string;  /* Тип финансового инструмента */
   var ShortName    : string; /* (0-1) Короткое наименование инструмента */
   var DateRate     : Date;   /* (0-1) Дата котировки */
//   var Currency     : integer; /* ( 1) Цифровой код валюты по отношению к которой посчитана котировка */                 
   var Rate  	    : string;  /* ( 1) Курс котировки */
end;

/* Данные ответа сервиса Загрузки данных по купонам */
private class c_LoadSecuretiesQuotationReconciliation_resp
   var ReqID    : string  /* (  1) ИД исходного запроса */
      ,SenderId : string  /* (0-1) Код АС-получателя ответа */
      ,Result   : object  /* (  1) Результат обработки запроса dt_Result_LoadSecuretiesQuotationReconciliation_resp */
      ,QuotationList : object; /* (0-n) Результат выполнения запроса в СОФР по котировкам TArray dt_QuotationList_LoadSecuretiesQuotationReconciliation_resp */
end;

/* Ответ сервиса */
private class c_out_obj
   var LoadSecuretiesQuotationReconciliation_resp = c_LoadSecuretiesQuotationReconciliation_resp;
end;

/*---------------------------------------------------*/
/* Класс с реализацией основного функционала сервиса */
/*---------------------------------------------------*/
private class (c_LoadSecuretiesQuotationReconciliation_req) c_LoadSecuretiesQuotationReconciliation_req_proc(p_income_data)
   /* Признак наличия ошибок */
   private var vg_is_error;
   /* Статусы для структуры верхнего уровня */
   private var vg_hl_error;
   /* Список зарегистрированных статусов для структур нижнего уровня */
   private var vg_ll_error_list;

   /* Метод получения признака наличия ошибок */
   macro m_get_error_status()
      return vg_is_error;
   end;

   /* Метод получения статуса для структуры верхнего уровня */
   macro m_get_hl_error()
      return vg_hl_error;
   end;

   /* Метод получения кода статуса для структур нижнего уровня */
   macro m_get_ll_error_code(p_index)
      return vg_ll_error_list.value(p_index).Code;
   end;

   /* Метод получения текста статуса для структур нижнего уровня */
   macro m_get_ll_error_text(p_index)
      return vg_ll_error_list.value(p_index).Text;
   end;

   private macro m_add_text_to_err(p_src_text, p_add_text)
      private var v_ret = "";

      if(strlen(p_src_text) != 0)
         v_ret = string(p_src_text, "|", p_add_text);
      else
         v_ret = p_add_text;
      end;

      return v_ret;
   end; /* macro m_add_text_to_err() */

   /* Конструктор */
   private macro m_init_prime(p_income_data)
      private var v_aux_buff;
      private var v_aux_cntr;
      private var v_aux_cntr1;

      vg_is_error = false;
      vg_hl_error = c_Result_LoadSecuretiesQuotationReconciliation_resp;
      vg_hl_error.Code = 0; /* Значение по умолчанию - ошибок нет */
      vg_hl_error.Text = "OK";
      vg_ll_error_list = TArray;

      if(p_income_data != V_UNDEF)
         ReqID = uTryToGetPropS(p_income_data, "ReqID");
         if(ValType(ReqID) == V_UNDEF)
            vg_is_error = true;
            vg_hl_error.Code = CV_Rate_ERROR_CODE;
            vg_hl_error.Text = m_add_text_to_err(vg_hl_error.Text, string(InErrComPart, "ReqID"));
            ReqID = XmlRpcRequestId();
         end;

         SenderId = uTryToGetPropS(p_income_data, "SenderId");
         if(ValType(SenderId) == V_UNDEF)
            vg_is_error = true;
            vg_hl_error.Code = CV_Rate_ERROR_CODE;
            vg_hl_error.Text = m_add_text_to_err(vg_hl_error.Text, string(InErrComPart, "SenderId"));
//            SenderId = XmlRpcRequestId();
         end;

         QuotationDate = uTryToGetPropS(p_income_data, "QuotationDate");
         if(ValType(QuotationDate) == V_UNDEF)
            vg_is_error = true;
            vg_hl_error.Code = CV_Rate_ERROR_CODE;
            vg_hl_error.Text = m_add_text_to_err(vg_hl_error.Text, string(InErrComPart, "QuotationDate"));
         end;
      end;
   onError(err)
      /* Записываем в ошибку структуры верхнего уровня структуры */
      vg_is_error = true;
      vg_hl_error.Code = CV_Rate_ERROR_CODE;
      vg_hl_error.Text = m_add_text_to_err(vg_hl_error.Text,
                                           string("При обработке входных параметров возникла ошибка: ",
                                                  c_usr_err_obj.obtain_err_msg(err)));
   end;

   Initc_LoadSecuretiesQuotationReconciliation_req();

   m_init_prime(p_income_data);
end; /* class c_LoadSecuretiesQuotationReconciliation_req_proc() */

/*---------------------*/
/* ТОЧКА ВХОДА СЕРВИСА */
/*---------------------*/
macro LoadSecuretiesQuotationReconciliation(p_income_data)
   private var v_aux_cntr, v_aux_cntr1, v_cmd, v_rs, v_SQL;
   private var v_income_data = NULL;
   var v_email_processor = NULL;
   var v_transformator = NULL;
   var v_service_processor = NULL;
   var v_save_processor = NULL;
   var v_resp_obj = NULL;
   var v_resp_doc;

   private var v_logger_obj;    /* Объект для работы с журналом */
   private var v_log_id;        /* Идентификатор записи в журнале (если требуется что-то добавить) */

   v_resp_obj = c_out_obj;

   /*
   /* Инициализация письма */
   v_email_processor = c_email_proc_env;
   v_email_processor.m_set_msg_head(CV_EMAIL_HEAD);
   /* !!! - Необходимо где-то брать список адресов для отправки уведомлений - !!! */
   v_email_processor.m_add_email_to_list(CV_EMAIL_RECEIVER);
   */
   if(ValType(p_income_data) != V_UNDEF)
      /* Преобразуем запрос в объектный вид - begin */
      v_transformator = c_secur_msg_converter();
      if(not v_transformator.m_decode_escaped_char(p_income_data))
         RunError(v_transformator.get_service_msg(), c_usr_err_obj(v_transformator.get_service_msg()));
      end;
      if(not v_transformator.m_make_pure_msg_from_ifx(v_transformator.get_pure_msg()))
         RunError(v_transformator.get_service_msg(), c_usr_err_obj(v_transformator.get_service_msg()));
      end;

      v_logger_obj = uws_exchng_logger(null, null, XmlRpcRequestId(), "LoadSecuretiesQuotationReconciliation", modulename(), NULL, v_transformator.get_pure_msg());
      v_log_id = v_logger_obj.get_log_id();

      v_income_data = v_transformator.m_secur_internal_req(v_transformator.get_pure_msg());
      /* Преобразуем запрос в объектный вид - end */

      v_service_processor = c_LoadSecuretiesQuotationReconciliation_req_proc(v_income_data);

      /* Общие параметры структуры верхнего уровня */
      v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.ReqID    = v_service_processor.ReqID;
      v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.SenderId = v_service_processor.SenderId;
      v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.Result   = v_service_processor.m_get_hl_error();

      if(not v_service_processor.m_get_error_status())
         /* Формируем данные по облигациям */

   	v_cmd = NULL;
   	v_rs  = NULL;
/*
          v_SQL = "with dat as ( " +
                  "select fi.t_fiid, " +
		  "	  fi.t_Facevaluefi,  " +
                  "       c.t_isin       FI_Code, " +
/*	          "       'Bond'         \"Type\", " +*/
		  "             case  " +
                  "               when (ck.t_avoirkind = 20 or ck.t_parent = 20) " +
                  "                 then 'Equity' " +
                  "               else               " +
                  "                 'Bond' " +
                  "             end  \"Type\", " +
                  "       fi.t_name      ShortName " +
                  "       from dfininstr_dbt fi, davoiriss_dbt c, davrkinds_dbt ck " +
                  "       where c.t_fiid (+)= fi.t_fiid " +
                  "         and fi.t_isclosed = chr(0) " +
                  "         and ck.t_fi_kind (+)= fi.t_fi_kind " +
                  "         and ck.t_avoirkind (+)= fi.t_avoirkind " +
/*                  "         and fi.t_Facevaluefi > 0 " +*/
		  "	    and c.t_isin is not null " +
                  "  and (fi.t_Facevaluefi > 0 or fi.t_avoirkind in (select ck1.t_avoirkind from davrkinds_dbt ck1 where ck1.t_fi_kind = 2 and INSTR(UPPER(ck1.t_name),'ЕВРО') > 0))  " +
                  "order by fi.t_fiid), " +
                  "bl1 as ( " +
                  "select rd.t_fiid, " +
                  "       rd.t_otherfi, " +
		  "       rd.t_sincedate, " +
                  "       rd.t_rate/power(10,rd.t_point)/rd.t_scale Rate " +
                  "      from dratedef_dbt rd, dat d " +
                  "    where rd.t_otherfi = d.t_fiid " +
                  "      and rd.t_sincedate = :p1 " +
		  "	 and rd.t_fiid = d.t_Facevaluefi  " +
                  "      and rd.t_type = 23), " +
                  "ssv1 as ( " +
                  "select rd.t_fiid, " +
                  "       rd.t_otherfi, " +
		  "       rd.t_sincedate, " +
                  "       rd.t_rate/power(10,rd.t_point)/rd.t_scale Rate " +
                  "      from dratedef_dbt rd, dat d " +
                  "    where rd.t_otherfi = d.t_fiid " +
                  "      and rd.t_sincedate = :p2 " +
	          "      and rd.t_fiid = d.t_Facevaluefi " +
                  "      and rd.t_type = 4 " +
                  "      and not exists (select 1 from bl1 b where b.t_otherfi = d.t_fiid) " +
                  "      ), " +
                  "bl2 as " +
                  " (select rd.t_fiid," +
                  "         rd.t_otherfi," +
                  "         rh.t_sincedate," +
                  "         rh.t_rate/power(10,rh.t_point)/rh.t_scale Rate" +
                  "    from dratehist_dbt rh, dratedef_dbt rd, dat d" +
                  "   where rd.t_otherfi = d.t_fiid" +
                  "     and rh.t_rateid(+) = rd.t_rateid" +
                  "     and rh.t_sincedate = :p3" +
		  "     and rd.t_fiid = d.t_Facevaluefi " +
		  "     and not exists (select 1 from bl1 b where b.t_otherfi = rd.t_otherfi and b.t_sincedate = rh.t_sincedate) "+
                  "     and rd.t_type = 23), " +
                  "ssv2 as " +
                  " (select rd.t_fiid," +
                  "         rd.t_otherfi," +
                  "         rh.t_sincedate," +
                  "         rh.t_rate/power(10,rh.t_point)/rh.t_scale Rate" +
                  "    from dratehist_dbt rh, dratedef_dbt rd, dat d" +
                  "   where rd.t_otherfi = d.t_fiid" +
                  "     and rd.t_type = 4" +
                  "     and rh.t_rateid(+) = rd.t_rateid" +
		  "     and rh.t_sincedate = :p4" +
		  "	and rd.t_fiid = d.t_Facevaluefi " +
		  "     and not exists (select 1 from ssv1 s where s.t_otherfi = rd.t_otherfi and s.t_sincedate = rh.t_sincedate) " +
                  "     and not exists (select 1 from bl2 b where b.t_otherfi = d.t_fiid)), " +
                  "ur2 as " +
                  " (select * from bl2 union all select * from ssv2), " +
                  "ur1 as ( " +
                  "select * from bl1 union all select * from ssv1 " +
                  "), " +
		  " ur as (select * from ur1 union all select * from ur2)  " +
                  "select d.FI_Code, " +
		  "	  d.\"Type\", " +
                  "       d.ShortName, " +
                  "       u.t_sincedate DateRate," +
/*                  "       (select cur.t_iso_number from dfininstr_dbt cur where cur.t_fiid =  u.t_fiid) Currency, " +*/
                  "       to_char(u.Rate) Rate " +
                  "  from dat d, ur u " +
                  "where u.t_otherfi = d.t_fiid ";

	  v_cmd = RsdCommand(v_SQL);
	  v_cmd.addParam("p1", RSDBP_IN, v_service_processor.QuotationDate);
	  v_cmd.addParam("p2", RSDBP_IN, v_service_processor.QuotationDate);
	  v_cmd.addParam("p3", RSDBP_IN, v_service_processor.QuotationDate);
	  v_cmd.addParam("p4", RSDBP_IN, v_service_processor.QuotationDate);
	  v_cmd.execute();
*/


          v_SQL = "with idate as (select :p1 InpDate from dual), " +
		  "SecB0 as ( " +
                  "     select " +
                  "        ck.t_avoirkind, " +
                  "             c.t_isin       FI_Code, " +
                  "             case  " +
                  "               when (ck.t_avoirkind = 20 or ck.t_parent = 20) " +
		  "                 then 'Equity' " +
                  "               else               " +
                  "                 'Bond' " +
                  "             end  \"Type\", " +
                  "             fi.t_name      ShortName,  " +
		  "             rd.t_sincedate DateRate,  " +
                  "             rd.t_rate/power(10,rd.t_point)/rd.t_scale Rate " +
                  "        from dratedef_dbt rd, dfininstr_dbt fi, davoiriss_dbt c, davrkinds_dbt ck, idate r " +
                  "        where rd.t_rate is not null " +
                  "        and rd.t_sincedate = r.InpDate " +
		  "        and rd.t_type = 23 " +
                  "        and rd.t_fiid = fi.t_Facevaluefi " +
                  "        and fi.t_fiid(+)= rd.t_otherfi " +
                  "        and c.t_fiid (+)= fi.t_fiid " +
                  "        and ck.t_fi_kind (+)= fi.t_fi_kind  " +
	          "        and ck.t_avoirkind (+)= fi.t_avoirkind          " +
                  "        and c.t_isin is not null), " +
                  "SecB1 as (                " +
                  "     select  " +
                  "        ck.t_avoirkind, " +
                  "             c.t_isin       FI_Code, " +
                  "             case  " +
                  "               when (ck.t_avoirkind = 20 or ck.t_parent = 20) " +
                  "                 then 'Equity'                                    " +
                  "               else               " +
                  "                 'Bond' " +
                  "             end \"Type\", " +
                  "             fi.t_name      ShortName,  " +
		  "             rh.t_sincedate DateRate,  " +
		  "             rh.t_rate/power(10,rh.t_point)/rh.t_scale Rate " +
                  "        from dratehist_dbt rh, dratedef_dbt rd, dfininstr_dbt fi, davoiriss_dbt c, davrkinds_dbt ck, idate r " +
                  "        where  rh.t_rate is not null " +
                  "        and rh.t_sincedate = r.InpDate " +
                  "        and rd.t_rateid(+) = rh.t_rateid " +
                  "        and rd.t_type = 23 " +
                  "        and rd.t_fiid = fi.t_Facevaluefi " +
                  "        and fi.t_isclosed = chr(0) " +
                  "        and fi.t_fiid(+)= rd.t_otherfi " +
                  "        and c.t_fiid (+)= fi.t_fiid " +
                  "        and ck.t_fi_kind (+)= fi.t_fi_kind  " +
		  "        and ck.t_avoirkind (+)= fi.t_avoirkind          " +
		  "        and not exists (select 1 from SecB0 where FI_Code = c.t_isin) " +
		  "        and c.t_isin is not null), " +
                  "SecB2 as (select * from SecB0 union all select * from SecB1), " +
                  "SecB3 as ( " +
                  "     select " +
                  "        ck.t_avoirkind, " +
                  "             c.t_isin       FI_Code, " +
                  "             case  " +
		  "               when (ck.t_avoirkind = 20 or ck.t_parent = 20) " +
                  "                 then 'Equity' " +
		  "               else               " +
                  "                 'Bond' " +
                  "             end \"Type\", " +
		  "             fi.t_name      ShortName,  " +
                  "             rd.t_sincedate DateRate,  " +
                  "             rd.t_rate/power(10,rd.t_point)/rd.t_scale Rate " +
                  "        from dratedef_dbt rd, dfininstr_dbt fi, davoiriss_dbt c, davrkinds_dbt ck, idate r " +
                  "        where rd.t_rate is not null " +
                  "        and rd.t_sincedate = r.InpDate " +
		  "        and rd.t_type = 23 " +
                  "        and rd.t_fiid != fi.t_Facevaluefi " +
                  "        and fi.t_fiid(+)= rd.t_otherfi " +
                  "        and c.t_fiid (+)= fi.t_fiid " +
                  "        and ck.t_fi_kind (+)= fi.t_fi_kind  " +
		  "        and ck.t_avoirkind (+)= fi.t_avoirkind          " +
                  "        and c.t_isin is not null " +
                  "        and not exists (select 1 from SecB2 where FI_Code = c.t_isin)), " +
                  "SecB4 as (                " +
                  "     select  " +
		  "        ck.t_avoirkind, " +
                  "             c.t_isin       FI_Code, " +
                  "             case  " +
                  "               when (ck.t_avoirkind = 20 or ck.t_parent = 20) " +
                  "                 then 'Equity' " +
	          "               else               " +
                  "                 'Bond' " +
                  "             end  \"Type\", " +
                  "             fi.t_name      ShortName,  " +
                  "             rh.t_sincedate DateRate,  " +
                  "             rh.t_rate/power(10,rh.t_point)/rh.t_scale Rate " +
                  "        from dratehist_dbt rh, dratedef_dbt rd, dfininstr_dbt fi, davoiriss_dbt c, davrkinds_dbt ck, idate r " +
                  "        where  rh.t_rate is not null " +
                  "        and rh.t_sincedate = r.InpDate " +
                  "        and rd.t_rateid(+) = rh.t_rateid " +
                  "        and rd.t_type = 23 " +
                  "        and rd.t_fiid != fi.t_Facevaluefi " +
                  "        and fi.t_isclosed = chr(0) " +
		  "        and fi.t_fiid(+)= rd.t_otherfi " +
		  "        and c.t_fiid (+)= fi.t_fiid " +
                  "        and ck.t_fi_kind (+)= fi.t_fi_kind  " +
                  "        and ck.t_avoirkind (+)= fi.t_avoirkind          " +
                  "        and not exists (select 1 from SecB3 where FI_Code = c.t_isin) " +
                  "        and not exists (select 1 from SecB2 where FI_Code = c.t_isin) " +
                  "        and c.t_isin is not null), " +
                  "SecB5 as (select * from SecB3 union all select * from SecB4),         " +
                  "SecB as (select * from SecB2 union all select * from SecB5), " +
                  "SecT0 as ( " +
                  "     select  " +
		  "        ck.t_avoirkind, " +
		  "             c.t_isin       FI_Code, " +
		  "             case  " +
                  "               when (ck.t_avoirkind = 20 or ck.t_parent = 20) " +
                  "                 then 'Equity' " +
                  "               else               " +
                  "                 'Bond' " +
                  "             end  \"Type\", " +
                  "             fi.t_name      ShortName,  " +
		  "             rd.t_sincedate DateRate,  " +
                  "             rd.t_rate/power(10,rd.t_point)/rd.t_scale Rate " +
		  "        from dratedef_dbt rd, dfininstr_dbt fi, davoiriss_dbt c, davrkinds_dbt ck, idate r " +
                  "        where rd.t_rate is not null " +
                  "        and rd.t_sincedate = r.InpDate " +
		  "        and rd.t_type = 4 " +
                  "        and fi.t_fiid(+)= rd.t_otherfi " +
                  "        and c.t_fiid (+)= fi.t_fiid " +
                  "        and ck.t_fi_kind (+)= fi.t_fi_kind  " +
                  "        and ck.t_avoirkind (+)= fi.t_avoirkind          " +
                  "        and rd.t_fiid = fi.t_Facevaluefi " +
		  "        and not exists (select 1 from SecB where FI_Code = c.t_isin) " +
                  "        and c.t_isin is not null), " +
                  "SecT1 as (                " +
                  "     select  " +
                  "        ck.t_avoirkind,                  " +
		  "             c.t_isin       FI_Code, " + 
                  "             case  " +
                  "               when (ck.t_avoirkind = 20 or ck.t_parent = 20) " +
                  "                 then 'Equity'                                " +
                  "               else               " +
		  "                 'Bond' " +
                  "             end  \"Type\", " +
                  "             fi.t_name      ShortName,  " +
                  "             rh.t_sincedate DateRate,  " +
                  "             rh.t_rate/power(10,rh.t_point)/rh.t_scale Rate " +
	          "        from dratehist_dbt rh, dratedef_dbt rd, dfininstr_dbt fi, davoiriss_dbt c, davrkinds_dbt ck, idate r " +
                  "        where  rh.t_rate is not null " +
                  "        and rh.t_sincedate = r.InpDate " +
                  "        and rd.t_rateid(+) = rh.t_rateid " +
                  "        and rd.t_type = 4 " +
                  "        and fi.t_isclosed = chr(0) " +
                  "        and fi.t_fiid(+)= rd.t_otherfi " +
                  "        and c.t_fiid (+)= fi.t_fiid " +
                  "        and ck.t_fi_kind (+)= fi.t_fi_kind  " +
                  "        and ck.t_avoirkind (+)= fi.t_avoirkind  " +
                  "        and rd.t_fiid = fi.t_Facevaluefi         " +
                  "        and not exists (select 1 from SecB where FI_Code = c.t_isin) " +
                  "        and not exists (select 1 from SecT0 where FI_Code = c.t_isin) " +
		  "        and c.t_isin is not null), " +
		  " SecT2 as (select * from SecT0 union all select * from SecT1), " +
                  "SecT3 as ( " +
                  "     select  " +
                  "        ck.t_avoirkind, " +
                  "             c.t_isin       FI_Code, " +
                  "             case  " +
                  "               when (ck.t_avoirkind = 20 or ck.t_parent = 20) " +
                  "                 then 'Equity' " +
                  "               else                " +
                  "                 'Bond'                " +
                  "             end  \"Type\", " +
		  "             fi.t_name      ShortName,  " +
		  "             rd.t_sincedate DateRate,  " +
		  "             rd.t_rate/power(10,rd.t_point)/rd.t_scale Rate " +
                  "        from dratedef_dbt rd, dfininstr_dbt fi, davoiriss_dbt c, davrkinds_dbt ck, idate r " +
                  "        where rd.t_rate is not null " +
                  "        and rd.t_sincedate = r.InpDate " +
                  "        and rd.t_type = 4 " +
                  "        and fi.t_fiid(+)= rd.t_otherfi " +
                  "        and c.t_fiid (+)= fi.t_fiid " +
		  "        and ck.t_fi_kind (+)= fi.t_fi_kind  " +
                  "        and ck.t_avoirkind (+)= fi.t_avoirkind          " +
		  "        and rd.t_fiid != fi.t_Facevaluefi " +
                  "        and not exists (select 1 from SecB where FI_Code = c.t_isin) " +
                  "        and not exists (select 1 from SecT2 where FI_Code = c.t_isin) " +
                  "        and c.t_isin is not null), " +
                  "SecT4 as (                " +
                  "     select  " +
                  "        ck.t_avoirkind, " +
                  "             c.t_isin       FI_Code, " +
                  "             case  " +
                  "               when (ck.t_avoirkind = 20 or ck.t_parent = 20) " +
                  "                 then 'Equity' " +
                  "               else               " +
                  "                 'Bond' " +
                  "             end  \"Type\", " +
		  "             fi.t_name      ShortName,  " +
		  "             rh.t_sincedate DateRate,  " +
                  "             rh.t_rate/power(10,rh.t_point)/rh.t_scale Rate " +
                  "        from dratehist_dbt rh, dratedef_dbt rd, dfininstr_dbt fi, davoiriss_dbt c, davrkinds_dbt ck, idate r " +
                  "        where  rh.t_rate is not null " +
                  "        and rh.t_sincedate = r.InpDate " +
                  "        and rd.t_rateid(+) = rh.t_rateid " +
                  "        and rd.t_type = 4 " +
                  "        and fi.t_isclosed = chr(0) " +
                  "        and fi.t_fiid(+)= rd.t_otherfi " +
                  "        and c.t_fiid (+)= fi.t_fiid " +
                  "        and ck.t_fi_kind (+)= fi.t_fi_kind  " +
		  "        and ck.t_avoirkind (+)= fi.t_avoirkind  " +
		  "        and rd.t_fiid != fi.t_Facevaluefi         " +
		  "        and not exists (select 1 from SecB where FI_Code = c.t_isin) " +
                  "        and not exists (select 1 from SecT2 where FI_Code = c.t_isin) " +
                  "        and not exists (select 1 from SecT3 where FI_Code = c.t_isin) " +
                  "        and c.t_isin is not null), " +
                  " SecT5 as (select * from SecT3 union all select * from SecT4),  " +
                  " SecT as (select * from SecT2 union all select * from SecT5),  " +
                  " dat as (select * from SecB union all select * from SecT) " +
/*		  "      select * from dat          " +*/
		 "  select FI_Code, " +
                 " \"Type\",  " +
                 " ShortName, " +
                 " DateRate, " +
                 " case when Rate < 1 " +
                 "   then to_char(Rate, '0.999999999999999999')  " +
                 "     when Rate >= 1 " +
                 "   then     " +
                 "     to_char(Rate, '999999999999999999.999999999999999999') " +
                 " end  Rate " +
                 " from dat " +
                 "      order by t_avoirkind, FI_Code DESC ";
                 
	  v_cmd = RsdCommand(v_SQL);
	  v_cmd.addParam("p1", RSDBP_IN, v_service_processor.QuotationDate);
	  v_cmd.execute();

          v_rs = RsdRecordset(v_cmd);

          v_aux_cntr = 0;
  	  v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.QuotationList = TArray;

          while (v_rs.moveNext())
		v_aux_cntr = v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.QuotationList.Size;
	        v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.QuotationList.value(v_aux_cntr) = c_QuotationList_LoadSecuretiesQuotationReconciliation_resp;  
		v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.QuotationList.value(v_aux_cntr).FI_Code   = trim(v_rs.value("FI_Code"));
		v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.QuotationList.value(v_aux_cntr).Type      = trim(v_rs.value("Type")); 
		v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.QuotationList.value(v_aux_cntr).ShortName = trim(v_rs.value("ShortName"));
		v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.QuotationList.value(v_aux_cntr).DateRate  = v_rs.value("DateRate"); 
		v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.QuotationList.value(v_aux_cntr).Rate      = trim(v_rs.value("Rate")); 
          end;
/*
//	Соберем обычные ценные бумаги

   	v_cmd = NULL;
   	v_rs  = NULL;

          v_SQL = " with dat as (  " +
		  "select fi.t_fiid  " +
                  "    from dfininstr_dbt fi, davoiriss_dbt c, davrkinds_dbt ck  " +
                  "   where c.t_fiid(+) = fi.t_fiid " +
		  "     and fi.t_isclosed = chr(0) " +
                  "     and ck.t_fi_kind(+) = fi.t_fi_kind " +
                  "     and ck.t_avoirkind(+) = fi.t_avoirkind " +
                  "     and (fi.t_Facevaluefi > 0 or fi.t_avoirkind in (select ck1.t_avoirkind from davrkinds_dbt ck1 where ck1.t_fi_kind = 2 and INSTR(UPPER(ck1.t_name),'ЕВРО') > 0)) " +
                  "     and c.t_isin is not null " +
                  " ), " +
		  " d1 as ( " +
                  "      select ck.t_avoirkind, " +
                  "             c.t_isin       FI_Code, " +
		  "             case  " +
                  "               when (ck.t_avoirkind = 20 or ck.t_parent = 20) " +
                  "                 then 'Equity' " +
                  "               else               " +
                  "                 'Bond' " +
                  "             end  \"Type\", " +
                  "             fi.t_name      ShortName,  " +
                  "             rd.t_sincedate DateRate,  " +
/*                  "             (select cur.t_iso_number from dfininstr_dbt cur where cur.t_fiid =  rd.t_fiid) Currency,  " +*/
		  "             to_char(rd.t_rate/power(10,rd.t_point)/rd.t_scale) Rate  " +
                  "             from dfininstr_dbt fi, davoiriss_dbt c, dratedef_dbt rd, davrkinds_dbt ck  " +
                  "             where c.t_fiid (+)= fi.t_fiid  " +
                  "               and fi.t_isclosed = chr(0)  " +
                  "               and ck.t_fi_kind (+)= fi.t_fi_kind  " +
                  "               and ck.t_avoirkind (+)= fi.t_avoirkind  " +
/*                  "               and fi.t_avoirkind in (select ck1.t_avoirkind from davrkinds_dbt ck1 where ck1.t_fi_kind = 2 and INSTR(UPPER(ck1.t_name),'ЕВРО') = 0)  " +*/
                  "               and rd.t_otherfi = fi.t_fiid  " +
		  "		and not exists (select 1 from dat d where d.t_fiid = fi.t_fiid) " +
	          "      and rd.t_fiid = fi.t_Facevaluefi " +
                  "               and rd.t_sincedate = :p1 " +
                  "               and rd.t_type = 4 and c.t_isin is not null), " +
                  " d2 as (                " +
                  "      select ck.t_avoirkind, " +
                  "             c.t_isin       FI_Code, " +
                  "             case  " +
                  "               when (ck.t_avoirkind = 20 or ck.t_parent = 20) " +
                  "                 then 'Equity' " +
                  "               else               " +
                  "                 'Bond' " +
                  "             end  \"Type\", " +
                  "             fi.t_name      ShortName,  " +
                  "             rh.t_sincedate DateRate,  " +
/*                  "             (select cur.t_iso_number from dfininstr_dbt cur where cur.t_fiid =  rd.t_fiid) Currency,  " +*/
                  "             to_char(rh.t_rate/power(10,rh.t_point)/rh.t_scale) Rate  " +
                  "             from dfininstr_dbt fi, davoiriss_dbt c, dratedef_dbt rd, dratehist_dbt rh, davrkinds_dbt ck  " +
                  "             where c.t_fiid (+)= fi.t_fiid  " +
                  "               and fi.t_isclosed = chr(0)  " +
		  "	          and c.t_isin is not null " +
                  "               and ck.t_fi_kind (+)= fi.t_fi_kind  " +
		  "               and ck.t_avoirkind (+)= fi.t_avoirkind  " +
/*                  "               and fi.t_avoirkind in (select ck1.t_avoirkind from davrkinds_dbt ck1 where ck1.t_fi_kind = 2 and INSTR(UPPER(ck1.t_name),'ЕВРО') = 0)  " + */
                  "               and rd.t_otherfi = fi.t_fiid  " +
                  "               and rh.t_rateid(+) = rd.t_rateid  " +
                  "               and rh.t_sincedate = :p2 " +
	          "      and rd.t_fiid = fi.t_Facevaluefi " +
		  " 	          and not exists (select 1 from d1  where FI_Code = c.t_isin and DateRate = rh.t_sincedate) " +
		  "               and not exists (select 1 from dat d where d.t_fiid = fi.t_fiid) " +
                  "               and rd.t_type = 4 and c.t_isin is not null), " +
                  "dat1 as (select * from d1 union all select * from d2)   " +
		  "      select * from dat1          " +
                  "  order by t_avoirkind, FI_Code DESC ";

	  v_cmd = RsdCommand(v_SQL);
	  v_cmd.addParam("p1", RSDBP_IN, v_service_processor.QuotationDate);
	  v_cmd.addParam("p2", RSDBP_IN, v_service_processor.QuotationDate);
	  v_cmd.execute();

          v_rs = RsdRecordset(v_cmd);

          while (v_rs.moveNext())
		v_aux_cntr = v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.QuotationList.Size;
	        v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.QuotationList.value(v_aux_cntr) = c_QuotationList_LoadSecuretiesQuotationReconciliation_resp;  
		v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.QuotationList.value(v_aux_cntr).FI_Code   = v_rs.value("FI_Code");
		v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.QuotationList.value(v_aux_cntr).Type      = v_rs.value("Type"); 
		v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.QuotationList.value(v_aux_cntr).ShortName = v_rs.value("ShortName");
		v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.QuotationList.value(v_aux_cntr).DateRate  = v_rs.value("DateRate"); 
/*		v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.QuotationList.value(v_aux_cntr).Currency  = v_rs.value("Currency"); */
		v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.QuotationList.value(v_aux_cntr).Rate      = v_rs.value("Rate"); 
          end;

   	v_cmd = NULL;
   	v_rs  = NULL;

          v_SQL = "select " +
                  "       c.t_isin       FI_Code, " +
                  "       fi.t_name      ShortName, " +
                  "       trunc(sysdate) DateRate, " +
                  "       (select cur.t_iso_number from dfininstr_dbt cur where cur.t_fiid =  rd.t_fiid) Currency, " +
                  "       rd.t_rate/power(10,rd.t_point)/rd.t_scale Rate " +
                  "       from dfininstr_dbt fi, davoiriss_dbt c, dratedef_dbt rd, davrkinds_dbt ck " +
                  "       where c.t_fiid (+)= fi.t_fiid " +
                  "         and fi.t_isclosed = chr(0) " +
                  "         and ck.t_fi_kind (+)= fi.t_fi_kind " +
                  "         and ck.t_avoirkind (+)= fi.t_avoirkind " +
                  "         and fi.t_avoirkind in (select ck1.t_avoirkind from davrkinds_dbt ck1 where ck1.t_fi_kind = 2 and INSTR(UPPER(ck1.t_name),'ЕВРО') = 0) " +
                  "         and rd.t_otherfi = fi.t_fiid " +
                  "         and rd.t_type = 4 " +
                  "order by fi.t_fiid ";

	  v_cmd = RsdCommand(v_SQL);
//	  v_cmd.addParam("p1", RSDBP_IN, v_service_processor.QuotationDate);
	  v_cmd.execute();

          v_rs = RsdRecordset(v_cmd);

          while (v_rs.moveNext())
		v_aux_cntr1 = v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.SecuretiesList.value(v_aux_cntr).QuotationList.Size;
	        v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.SecuretiesList.value(v_aux_cntr).QuotationList.value(v_aux_cntr1) = c_QuotationList_LoadSecuretiesQuotationReconciliation_resp;  
		v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.SecuretiesList.value(v_aux_cntr).QuotationList.value(v_aux_cntr1).FI_Code   = v_rs.value("FI_Code");
		v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.SecuretiesList.value(v_aux_cntr).QuotationList.value(v_aux_cntr1).ShortName = v_rs.value("ShortName");
		v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.SecuretiesList.value(v_aux_cntr).QuotationList.value(v_aux_cntr1).DateRate  = v_rs.value("DateRate"); 
		v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.SecuretiesList.value(v_aux_cntr).QuotationList.value(v_aux_cntr1).Currency  = v_rs.value("Currency"); 
		v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.SecuretiesList.value(v_aux_cntr).QuotationList.value(v_aux_cntr1).Rate      = v_rs.value("Rate"); 
          end;
*/
   	v_cmd = NULL;
   	v_rs  = NULL;

      else
         /* Зафиксированы ошибки на верхнем уровне структуры */
         v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.QuotationList = TArray;
      end;

   else
      /* Ошибка в структуру верхнего уровня - не переданы входные данные */
      v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.ReqID       = XmlRpcRequestId(); /* Поскольку не можем взять информацию из входящего объекта */
      v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.Result      = c_Result_LoadSecuretiesQuotationReconciliation_resp;
      v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.Result.Code = CV_Rate_ERROR_CODE;
      v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.Result.Text = "Не переданы входящие параметры для новой реконсиляции котировок по ценным ё бумагам";
      v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.QuotationList = TArray;
/*
      v_email_processor.m_add_row_to_msg_text(string(CV_EMAIL_ROW_HEAD,
                                              v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.ReqID, " - ",
                                              v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.Result.Text));
*/
   end;
/*
   /* Сохраняем текст письма для отправки плановой процедурой */
   v_email_processor.m_save_to_submit();
   /* Отправляем все не отправленные письма */
   v_email_processor.m_submit_email();
*/
   /* Преобразуем объектный вид ответа в документ требуемого формата - begin */
   v_resp_doc = v_transformator.m_secur_internal_resp(v_resp_obj);
   /* Преобразуем объектный вид ответа в документ требуемого формата - end */

   v_logger_obj.add_response(v_resp_doc, null, null, null, modulename, null);
   v_logger_obj.add_error_info(v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.Result.Code, v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.Result.Text);

   return v_resp_doc;

onError(err)
   if(ValType(v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.ReqID) == V_UNDEF)
      v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.ReqID = XmlRpcRequestId();
   end;
   v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.Result      = NULL;
   v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.Result      = c_Result_LoadSecuretiesQuotationReconciliation_resp;
   v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.Result.Code = CV_Rate_ERROR_CODE;
   v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.Result.Text = c_usr_err_obj.obtain_err_msg(err);

   /* Преобразуем объектный вид ответа в документ требуемого формата - begin */
   v_resp_doc = v_transformator.m_secur_internal_resp(v_resp_obj);
   /* Преобразуем объектный вид ответа в документ требуемого формата - end */

   v_logger_obj.add_response(v_resp_doc, null, null, null, modulename);
   v_logger_obj.add_error_info(v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.Result.Code, v_resp_obj.LoadSecuretiesQuotationReconciliation_resp.Result.Text);

   return v_resp_doc;
end; /* macro LoadSecuretiesQuotationReconciliation() */
