/*---------------------------------------------------------------------------------------------*/
/*  ManualUnloadLog.mac  - Интерфейс для журанала выгрузки объектов (записи u_unload_bisquit)
                                                                                               */
/*                                                                                             */
/* Автор: Гераськина Т.                                                                        */
/*---------------------------------------------------------------------------------------------*/
import RsbFormsInter, CTInter;
import "usr_key_const.mac";
import globals, rsd;
import "global_utils_intgr.mac";
import "int_usr_globals.mac";

private var gv_evnt_sel_prm;               /* Параметры выборки событий */
private var gv_com_unload_form;
private var gv_scr_focus = 0;              /* Номер позиции скроллинга */

// заполнить значения по старым результатам, которых не стали дожидаться
macro GetOldResults(_dt)
   var sql_str, cmd;

   sql_str = "begin  "+
             "  for c in (select distinct t_objecttype, session_guid "+
             "              from u_unload_bisquit "+
             "             where resultcode = '-1' and processtime >= trunc(sysdate)-7) loop "+
             "     u_manual_drive.check_results(c.session_guid,c.t_objecttype); "+ 
             "  end loop; "+
             "end; ";
   cmd = RSDCommand(sql_str);
   cmd.execute();
end;


macro ShowSelection(_objecttype)
   private var gv_column_list_scr = TArray(); /* Список колонок скроллинга */
   private var gv_num_columns_scr = 0;        /* Количество колонок скроллинга */

   var sql_scr, cmd_scr, rs_scr, cnt;
   var sql_include_error = "";
   var sql_sort_error = "";
   var sql_oper_fltr = "";
   var sql_pack_fltr = "";
   var sql_date_fltr = "";

   var vbegdate, venddate;
   if (_objecttype)
         sql_scr = "select u.t_objecttype, u.t_objectid, u.t_type, u.t_date, u.t_numb_document, "+ 
                   "       u.resultcode, u.err, u.session_guid, to_char(u.processtime,'dd.mm.yyyy hh24:mi:ss') processtime, u.t_recid, u.t_number_pack, u.t_oper "+
                   "  from u_unload_bisquit u "+
                   " where 1=1 and session_guid = :sessg";

         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_objecttype",    "Вид об.",         3); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_objectid",      "ID объекта",      5); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_type",          "Тип соб",         3); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_date",          "Дата события",    8); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_numb_document", "Номер",           8); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "resultcode",      "",                3); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "err",             "Результат",      30); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "session_guid",    "GUID",           25); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "processtime",     "Дата обработки", 20); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_recid",         "Recid соб",       5); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_number_pack",   "Пачка",           3); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_oper",          "Опер",            5); gv_num_columns_scr = gv_num_columns_scr + 1;

         cmd_scr = RSDCommand(sql_scr);
         cmd_scr.AddParam("sessg", RSDBP_IN, _objecttype);
         cmd_scr.NullConversion = true;
         rs_scr = RSDRecordSet(cmd_scr, RSDVAL_CLIENT, RSDVAl_STATIC);
         rs_scr.NullConversion = true;
         rs_scr.pagesize = 100;

         while(RunScroll(rs_scr, gv_num_columns_scr, gv_column_list_scr, "LogRecords", "", "Выгруженные объекты", "[ESC] Выход  [Ctrl+Shift+F11] в Excel [Ctrl+Shift+F7] в Текст", true, 5, NULL, NULL, 40))
            rs_scr = RSDRecordSet(cmd_scr, RSDVAL_CLIENT, RSDVAl_STATIC);
         end;
         rs_scr.close; cmd_scr.close; rs_scr = null; cmd_scr = null;

   else
      if (gv_evnt_sel_prm.v_com_allrecords)  // просто журнал
         sql_scr = "select u.t_objecttype, u.t_objectid, u.t_type, u.t_date, u.t_numb_document, "+ 
                   "       u.resultcode, u.err, u.session_guid, to_char(u.processtime,'dd.mm.yyyy hh24:mi:ss') processtime, u.t_recid, u.t_number_pack, u.t_oper "+
                   "  from u_unload_bisquit u "+
                   " where 1=1 ";

         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_objecttype",    "Вид об.",         3); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_objectid",      "ID объекта",      5); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_type",          "Тип соб",         3); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_date",          "Дата события",    8); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_numb_document", "Номер",           8); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "resultcode",      "",                3); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "err",             "Результат",      30); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "session_guid",    "GUID",           25); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "processtime",     "Дата обработки", 20); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_recid",         "Recid соб",       5); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_number_pack",   "Пачка",           3); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_oper",          "Опер",            5); gv_num_columns_scr = gv_num_columns_scr + 1;

      elif (gv_evnt_sel_prm.v_com_accounts)  // только счета
         sql_scr = "select "+
                   "    acc.t_accountid, acc.t_open_date, acc.t_open_close, "+
                   "    decode(acc.t_close_date,to_date('01.01.0001','dd.mm.yyyy'),'',to_char(acc.t_close_date,'dd.mm.yyyy')) close_date, "+
                   "    (select t_fi_code from dfininstr_dbt f where f.t_fiid = acc.t_code_currency) fi, "+
                   "    acc.t_chapter, acc.t_balance, acc.t_account, acc.t_nameaccount, acc.t_userfield4, "+
                   "    u.t_number_pack, u.t_oper, u.resultcode, u.err, to_char(u.processtime,'dd.mm.yyyy hh24:mi:ss') processtime, u.session_guid, u.t_recid "+
                   "from u_unload_bisquit u, "+
                   "       daccount_dbt acc  "+
                   "where  u.t_objecttype = 4 "+
                   "   and u.t_objectid = acc.t_accountid ";

         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_accountid",   "ID",              5); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_open_date",   "Дата откр",       8); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_open_close",  "З",               2); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "close_date",    "Дата закр",       8); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "fi",            "Вал",             3); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_chapter",     "Гл",              3); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_balance",     "Бал",             5); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_account",     "Номер счета",    17); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_nameaccount", "Наименование",   35); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_userfield4",  "ID BISQUIT",     15); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "resultcode",    "",                3); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "err",           "Результат",      30); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "session_guid",  "GUID",           20); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "processtime",   "Дата обработки", 15); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_recid",       "Recid соб",       6); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_number_pack", "Пачка",           3); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_oper",        "Опер",            5); gv_num_columns_scr = gv_num_columns_scr + 1;

      elif (gv_evnt_sel_prm.v_com_trans)    // только проводки
         sql_scr = "select "+
                   "     acctrn.t_acctrnid, acctrn.t_state, acctrn.t_chapter, acctrn.t_date_carry, "+
                   "     (select t_fi_code from dfininstr_dbt f where f.t_fiid = acctrn.t_fiid_payer) fipay, "+
                   "     (select t_fi_code from dfininstr_dbt f where f.t_fiid = acctrn.t_fiid_receiver) firec, "+  
                   "     acctrn.t_account_payer, acctrn.t_account_receiver, "+
                   "     acctrn.t_sum_payer, acctrn.t_sum_receiver, acctrn.t_oper, acctrn.t_ground, acctrn.t_userfield4, "+
                   "     u.t_number_pack, u.t_oper, u.resultcode, u.err, to_char(u.processtime,'dd.mm.yyyy hh24:mi:ss') processtime, u.session_guid, u.t_recid "+
                   " from u_unload_bisquit u, "+
                   "      dacctrn_dbt acctrn "+
                   " where u.t_objecttype = 1 "+
                   "   and u.t_objectid = acctrn.t_acctrnid ";

         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_acctrnid",         "ID",              6); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_state",            "Ст",              2); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_chapter",          "Гл",              3); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_date_carry",       "Дата пров",       8); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "fipay",              "Вал деб",         3); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_account_payer",    "Счет дебета",    17); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "firec",              "Вал кр",          3); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_account_receiver", "Счет кредита",   17); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_sum_payer",        "Сумма дебета",   15); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_sum_receiver",     "Сумма кредита",  15); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_oper",             "Опер пр",         5); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_ground",           "Основание",      35); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_userfield4",       "ID BISQUIT",      8); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "resultcode",         "",                3); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "err",                "Результат",      30); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "session_guid",       "GUID",           13); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "processtime",        "Дата обработки", 15); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_recid",            "Recid соб",       5); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_number_pack",      "Пачка",           3); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_oper",             "Опер",            5); gv_num_columns_scr = gv_num_columns_scr + 1;

      elif (gv_evnt_sel_prm.v_com_payments) // только платежи
         sql_scr = "select "+
                   "    paym.t_paymentid, "+ 
                   "    (select t_fi_code from dfininstr_dbt f where f.t_fiid = paym.t_fiid) fipay, "+
                   "    paym.t_amount, paym.t_payeraccount, paym.t_futurepayeraccount, "+
                   "    (select t_fi_code from dfininstr_dbt f where f.t_fiid = paym.t_payfiid) fireceiver, "+
                   "    paym.t_payamount, paym.t_receiveraccount, paym.t_futurereceiveraccount, paym.t_userfield4, "+
                   "    pmrm.t_number, pmrm.t_ground, "+
                   "    u.t_number_pack, u.t_oper, u.resultcode, u.err, to_char(u.processtime,'dd.mm.yyyy hh24:mi:ss') processtime, u.session_guid, u.t_recid "+
                   "from u_unload_bisquit u, "+
                   "     dpmpaym_dbt paym, "+
                   "     dpmrmprop_dbt pmrm "+
                   "where u.t_objecttype = 501 "+
                   "  and u.t_objectid = paym.t_paymentid "+
                   "  and pmrm.t_paymentid = paym.t_paymentid";   

         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_paymentid",             "ID",               5); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "fipay",                   "Вал деб",          3); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_payeraccount",          "Счет плательщика",17); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_futurepayeraccount",    "Счет дебета пр",  17); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_amount",                "Сумма деб",       12); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "fireceiver",              "Вал кр",           3); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_receiveraccount",       "Счет кредита",    17); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_futurereceiveraccount", "Счет кредита пр", 17); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_payamount",             "Сумма кредита",   12); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_number",                "Номер",           10); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_ground",                "Основание",       35); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_userfield4",            "ID BISQUIT",      10); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "resultcode",              "",                 3); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "err",                     "Результат",       30); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "session_guid",            "GUID",            15); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "processtime",             "Дата обработки",  15); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_recid",                 "Recid соб",        8); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_number_pack",           "Пачка",            3); gv_num_columns_scr = gv_num_columns_scr + 1;
         m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_oper",                  "Опер",             5); gv_num_columns_scr = gv_num_columns_scr + 1;

       end;

       if (sql_scr)
         sql_date_fltr = " and u.processtime between to_date(:pd1||'00:00:00', 'dd.mm.yyyy hh24:mi:ss') "+
                         "                       and to_date(:pd2||'23:59:59', 'dd.mm.yyyy hh24:mi:ss') ";
         if (gv_evnt_sel_prm.v_com_date_switch)
            vbegdate = String(gv_evnt_sel_prm.v_com_beg_date);
            venddate = String(gv_evnt_sel_prm.v_com_end_date);
         else
            vbegdate = String(gv_evnt_sel_prm.v_com_date);
            venddate = String(gv_evnt_sel_prm.v_com_date);
         end;

         if (gv_evnt_sel_prm.v_com_number_pack >= 0) // фильтр по пачке
            sql_pack_fltr = " and u.t_number_pack = "+gv_evnt_sel_prm.v_com_number_pack;
         end;

         if (gv_evnt_sel_prm.v_com_oper > 0) // фильтр по оперу
            sql_oper_fltr = " and u.t_oper = "+gv_evnt_sel_prm.v_com_oper;
         end;

         if (gv_evnt_sel_prm.v_com_onlyerror)
            sql_include_error = " and u.resultcode != '0'";
         else
            sql_include_error = "";
            if (gv_evnt_sel_prm.v_com_errorfirst_switch)
               sql_sort_error = " order by decode(resultcode,'0',1,-1)";
            end;
         end;

         sql_scr = sql_scr + sql_date_fltr + sql_pack_fltr + sql_oper_fltr + sql_include_error + sql_sort_error;

         cmd_scr = RSDCommand(sql_scr);
         cmd_scr.AddParam("pd1", RSDBP_IN, vbegdate);
         cmd_scr.AddParam("pd2", RSDBP_IN, venddate);
         cmd_scr.NullConversion = true;
         rs_scr = RSDRecordSet(cmd_scr, RSDVAL_CLIENT, RSDVAl_STATIC);
         rs_scr.NullConversion = true;
         rs_scr.pagesize = 100;

         while(RunScroll(rs_scr, gv_num_columns_scr, gv_column_list_scr, "LogRecords", "", "Выгруженные объекты", "[ESC] Выход  [Ctrl+Shift+F11] в Excel [Ctrl+Shift+F7] в Текст", true, 5, NULL, NULL, 40))
            rs_scr = RSDRecordSet(cmd_scr, RSDVAL_CLIENT, RSDVAl_STATIC);
         end;
         rs_scr.close; cmd_scr.close; rs_scr = null; cmd_scr = null;

      end;
   end;

onError(e)
   RunError(e.message + getFullCmdErrorText(cmd_scr));
end;


/*------------------------------------*/
/* Метод обработки событий скроллинга */
/*------------------------------------*/
macro m_sess(p_rs, p_cmd, p_id, p_key)
   var CM_FLAG = CM_DEFAULT;

   var gv_com_search_form;
   var v_msg_menu = TArray;
   var v_choice;
   var v_msg_str = "";
   var v_file_path = "";


   if(p_cmd == DLG_INIT)
      while((gv_scr_focus != 0) and p_rs.movenext())
         if(p_rs.value("session_guid") == gv_scr_focus)
            gv_scr_focus = 0;
            GoToScroll(p_rs);
         end;
      end;

   elif(p_cmd == DLG_KEY)
      if(p_key == K_ENTER)
         ShowSelection(p_rs.value("session_guid"));
         CM_FLAG = CM_IGNORE;
      end;

   end;

   return CM_FLAG;
end; /* macro m_sess() */


macro ShowSession
   private var gv_column_list_scr = TArray(); /* Список колонок скроллинга */
   private var gv_num_columns_scr = 0;        /* Количество колонок скроллинга */

   var sql_scr, cmd_scr, rs_scr, cnt;
   var sql_include_error = "";
   var sql_sort_error = "";
   var sql_oper_fltr = "";
   var sql_pack_fltr = "";
   var sql_date_fltr = "";

   var vbegdate, venddate;

   sql_scr = "select distinct to_char(processtime,'dd.mm.yyyy hh24:mi:ss') processtime, session_guid, t_number_pack, t_oper "+
             "  from u_unload_bisquit u where 1=1";

   m_add_column(gv_column_list_scr, gv_num_columns_scr, "session_guid",    "GUID",           25); gv_num_columns_scr = gv_num_columns_scr + 1;
   m_add_column(gv_column_list_scr, gv_num_columns_scr, "processtime",     "Дата обработки", 20); gv_num_columns_scr = gv_num_columns_scr + 1;
   m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_number_pack",   "Пачка",           3); gv_num_columns_scr = gv_num_columns_scr + 1;
   m_add_column(gv_column_list_scr, gv_num_columns_scr, "t_oper",          "Опер",            5); gv_num_columns_scr = gv_num_columns_scr + 1;

   if (sql_scr)
      sql_date_fltr = " and u.processtime between to_date(:pd1||'00:00:00', 'dd.mm.yyyy hh24:mi:ss') "+
                      "                       and to_date(:pd2||'23:59:59', 'dd.mm.yyyy hh24:mi:ss') ";
      if (gv_evnt_sel_prm.v_com_date_switch)
         vbegdate = String(gv_evnt_sel_prm.v_com_beg_date);
         venddate = String(gv_evnt_sel_prm.v_com_end_date);
      else
         vbegdate = String(gv_evnt_sel_prm.v_com_date);
         venddate = String(gv_evnt_sel_prm.v_com_date);
      end;

      if (gv_evnt_sel_prm.v_com_number_pack >= 0) // фильтр по пачке
         sql_pack_fltr = " and u.t_number_pack = "+gv_evnt_sel_prm.v_com_number_pack;
      end;

      if (gv_evnt_sel_prm.v_com_oper > 0) // фильтр по оперу
         sql_oper_fltr = " and u.t_oper = "+gv_evnt_sel_prm.v_com_oper;
      end;
      sql_sort_error = " order by processtime";

      sql_scr = sql_scr + sql_date_fltr + sql_pack_fltr + sql_oper_fltr + sql_include_error + sql_sort_error;

      cmd_scr = RSDCommand(sql_scr);
      cmd_scr.AddParam("pd1", RSDBP_IN, vbegdate);
      cmd_scr.AddParam("pd2", RSDBP_IN, venddate);
      cmd_scr.NullConversion = true;
      rs_scr = RSDRecordSet(cmd_scr, RSDVAL_CLIENT, RSDVAl_STATIC);
      rs_scr.NullConversion = true;
      rs_scr.pagesize = 100;

      while(RunScroll(rs_scr, gv_num_columns_scr, gv_column_list_scr, "LogRecords_sess", "m_sess", "Сессии", "[ESC] Выход  [Ctrl+Shift+F11] в Excel [Ctrl+Shift+F7] в Текст", true, 5, NULL, NULL, 40))
         rs_scr = RSDRecordSet(cmd_scr, RSDVAL_CLIENT, RSDVAl_STATIC);
      end;
      rs_scr.close; cmd_scr.close; rs_scr = null; cmd_scr = null;

   end;

onError(e)
   RunError(e.message + getFullCmdErrorText(cmd_scr));
end;

/*---------------------------*/
/* Параметры отбора объектов */
/*---------------------------*/
private class c_evnt_selection_prm()
   var v_com_date;
   var v_com_beg_date;
   var v_com_end_date;
   var v_com_date_switch;

   var v_com_accounts;
   var v_com_trans;
   var v_com_payments;
   var v_com_allrecords;

   var v_com_number_pack;
   var v_com_oper;

   var v_com_errorfirst_switch;

   var v_com_onlyerror;
   var v_com_all;

   var v_period_txt;

   /* Значения по умолчанию */
   private macro m_init_evnt_selection_prm()
      v_com_date = date();
      v_com_beg_date = date();
      v_com_end_date = date();
      v_com_date_switch = false;

      v_com_accounts = false;
      v_com_trans = false;
      v_com_payments = false;
      v_com_allrecords = true;

      v_com_number_pack = -1;
      v_com_oper = 0;

      v_com_errorfirst_switch = false;

      v_com_onlyerror = false;
      v_com_all = false;

      v_period_txt = "";
   end;

   m_init_evnt_selection_prm();
end; /* class c_evnt_selection_prm() */


/*----------------------------------------*/
/* Класс основной формы                   */
/*----------------------------------------*/
class (TRsbPanel) c_com_unload_form()
   const CV_POS_X = 3;
   const CV_POS_Y = 2;
   var v_com_date_fld;
   var v_com_beg_date_fld;
   var v_com_end_date_fld;
   var v_com_date_switch_fld;
   var v_com_number_pack_fld;
   var v_com_oper_fld;
   var v_com_errorfirst_switch_fld;

   var v_com_null_btn;
   var v_com_result_btn;

   var v_com_r_accounts;
   var v_com_r_trans;
   var v_com_r_payments;
   var v_com_r_allrecords;

   var v_com_r_onlyerror;
   var v_com_r_all;

   var v_com_date;
   var v_com_beg_date;
   var v_com_end_date;
   var v_com_number_pack;
   var v_com_oper;

   macro m_evnt_on_key_pressed(p_rsb_evnt)
      if(p_rsb_evnt.KeyCode == K_F2)
         //close(CV_CLOSE_FORM_OK);
         return CM_IGNORE;
      end;

      return true;
   end;


   macro m_on_switch_date(p_rsb_evnt)
      if(p_rsb_evnt.id == RSB_EV_CONTROL_CHECKED)
         gv_evnt_sel_prm.v_com_date_switch = v_com_date_switch_fld.checked;
      end;

      if(gv_evnt_sel_prm.v_com_date_switch)
         v_com_date_fld.focusable = false;
         v_com_date_fld.enabled = false;
         v_com_date_fld.editable = false;

         v_com_beg_date_fld.focusable = true;
         v_com_beg_date_fld.enabled = true;
         v_com_beg_date_fld.editable = true;

         v_com_end_date_fld.focusable = true;
         v_com_end_date_fld.enabled = true;
         v_com_end_date_fld.editable = true;
      else
         v_com_date_fld.focusable = true;
         v_com_date_fld.enabled = true;
         v_com_date_fld.editable = true;

         v_com_beg_date_fld.focusable = false;
         v_com_beg_date_fld.enabled = false;
         v_com_beg_date_fld.editable = false;

         v_com_end_date_fld.focusable = false;
         v_com_end_date_fld.enabled = false;
         v_com_end_date_fld.editable = false;
      end;

      redraw();

      return true;
   end;


   macro m_on_switch_errorfirst(p_rsb_evnt)
      if(p_rsb_evnt.id == RSB_EV_CONTROL_CHECKED)
         gv_evnt_sel_prm.v_com_errorfirst_switch = v_com_errorfirst_switch_fld.checked;
      end;

      redraw();

      return true;
   end;


   macro m_on_checked_r(p_rsb_evnt)
      if(p_rsb_evnt.id == RSB_EV_CONTROL_CHECKED)
         if (v_com_r_accounts.checked)
            gv_evnt_sel_prm.v_com_accounts = true;
            gv_evnt_sel_prm.v_com_trans = false;
            gv_evnt_sel_prm.v_com_payments = false;
            gv_evnt_sel_prm.v_com_allrecords = false;
         elif (v_com_r_trans.checked)
            gv_evnt_sel_prm.v_com_accounts = false;
            gv_evnt_sel_prm.v_com_trans = true;
            gv_evnt_sel_prm.v_com_payments = false;
            gv_evnt_sel_prm.v_com_allrecords = false;
         elif (v_com_r_payments.checked)
            gv_evnt_sel_prm.v_com_accounts = false;
            gv_evnt_sel_prm.v_com_trans = false;
            gv_evnt_sel_prm.v_com_payments = true;
            gv_evnt_sel_prm.v_com_allrecords = false;
         elif (v_com_r_allrecords.checked)
            gv_evnt_sel_prm.v_com_accounts = false;
            gv_evnt_sel_prm.v_com_trans = false;
            gv_evnt_sel_prm.v_com_payments = false;
            gv_evnt_sel_prm.v_com_allrecords = true;
         end;
      end;

      return true;
   end;


   macro m_on_checked_error_r(p_rsb_evnt)
      if(p_rsb_evnt.id == RSB_EV_CONTROL_CHECKED)
         if (v_com_r_onlyerror.checked)
            gv_evnt_sel_prm.v_com_onlyerror = true;
            gv_evnt_sel_prm.v_com_all = false;
         elif (v_com_r_all.checked)
            gv_evnt_sel_prm.v_com_onlyerror = false;
            gv_evnt_sel_prm.v_com_all = true;
         end;
      end;

      return true;
   end;


   macro MakeNull()
     v_com_date_fld.focusable = true;
     v_com_date_fld.enabled = true;
     v_com_date_fld.editable = true;

     v_com_beg_date_fld.focusable = false;
     v_com_beg_date_fld.enabled = false;
     v_com_beg_date_fld.editable = false;

     v_com_end_date_fld.focusable = false;
     v_com_end_date_fld.enabled = false;
     v_com_end_date_fld.editable = false;

     v_com_r_accounts.checked = false;
     gv_evnt_sel_prm.v_com_accounts = false;
     v_com_r_trans.checked = false;
     gv_evnt_sel_prm.v_com_trans = false;
     v_com_r_payments.checked = false;
     gv_evnt_sel_prm.v_com_payments = false;
     v_com_r_allrecords.checked = true;
     gv_evnt_sel_prm.v_com_allrecords = true;

     v_com_r_onlyerror.checked = false;
     gv_evnt_sel_prm.v_com_onlyerror = false;
     v_com_r_all.checked = true;
     gv_evnt_sel_prm.v_com_all = true;

     gv_evnt_sel_prm.v_com_errorfirst_switch = false;
     v_com_errorfirst_switch_fld.checked = gv_evnt_sel_prm.v_com_errorfirst_switch;

     v_com_number_pack = -1;
     gv_evnt_sel_prm.v_com_number_pack = -1;
     v_com_number_pack_fld.value = v_com_number_pack;
     v_com_oper = -1;
     gv_evnt_sel_prm.v_com_oper = -1;
     v_com_oper_fld.value = v_com_oper;

     gv_evnt_sel_prm.v_period_txt = "";

     redraw();
   end;


   macro m_evnt_null_btn(p_rsb_evnt)
      if(p_rsb_evnt.id == RSB_EV_BUTTON_CLICKED)
         MakeNull();

         gv_evnt_sel_prm.v_com_date = date();
         v_com_date_fld.value = gv_evnt_sel_prm.v_com_date;

         gv_evnt_sel_prm.v_com_beg_date = date("00.00.0000");
         v_com_beg_date_fld.value = date("00.00.0000");

         gv_evnt_sel_prm.v_com_end_date = date("00.00.0000");
         v_com_end_date_fld.value = date("00.00.0000");

         v_com_date_switch_fld.checked = false;
         gv_evnt_sel_prm.v_com_date_switch = false;

         redraw();
      end;

      return true;
   end;


   macro check_params()
      if ( (not v_com_date_switch_fld.checked) and (gv_evnt_sel_prm.v_com_date == date(0,0,0)) )
         msgbox("Не указана дата");
         return false;
      end;

      if ( (v_com_date_switch_fld.checked) and ( (gv_evnt_sel_prm.v_com_beg_date == date(0,0,0)) or 
                                                 (gv_evnt_sel_prm.v_com_end_date == date(0,0,0))  ) )
         msgbox("Не указана дата из диапазона");
         return false;
      end;

      return true;

   end;

   macro m_evnt_getresult_btn(p_rsb_evnt)

      if(p_rsb_evnt.id == RSB_EV_BUTTON_CLICKED)
         if (check_params)
            if (not v_com_date_switch_fld.checked)
               gv_evnt_sel_prm.v_period_txt = " за дату "+gv_evnt_sel_prm.v_com_date;
            elif (v_com_date_switch_fld.checked)
               gv_evnt_sel_prm.v_period_txt = " за период с "+gv_evnt_sel_prm.v_com_beg_date+" по "+ gv_evnt_sel_prm.v_com_end_date;
            end;
            GetOldResults(date);
            ShowSelection();            

         end;
      end;

      return true;
   end;

   macro m_evnt_getsess_btn(p_rsb_evnt)

      if(p_rsb_evnt.id == RSB_EV_BUTTON_CLICKED)
         if (check_params)
            if (not v_com_date_switch_fld.checked)
               gv_evnt_sel_prm.v_period_txt = " за дату "+gv_evnt_sel_prm.v_com_date;
            elif (v_com_date_switch_fld.checked)
               gv_evnt_sel_prm.v_period_txt = " за период с "+gv_evnt_sel_prm.v_com_beg_date+" по "+ gv_evnt_sel_prm.v_com_end_date;
            end;
            GetOldResults(date);
            ShowSession();
         end;
      end;

      return true;
   end;   

   private macro m_init_com_unload_form(i_this_obj)
      Caption = "Журнал выгрузок в Бисквит";
      Status = "[Esc] Выход ";

      /* Фильтр по дате */
      AddLabel(TRsbLabel(CV_POS_X, CV_POS_Y, "Дата выборки"));
      v_com_date_fld = TRsbEditField(FT_DATE);
      v_com_date_fld.bindValue(gv_evnt_sel_prm, "v_com_date", 10);
      v_com_date_fld.setPosition(CV_POS_X, CV_POS_Y+1);
      v_com_date_fld.setSize(10, 1);
      if(gv_evnt_sel_prm.v_com_date_switch)
         v_com_date_fld.focusable = false;
         v_com_date_fld.enabled = false;
         v_com_date_fld.editable = false;
      else
         v_com_date_fld.focusable = true;
         v_com_date_fld.enabled = true;
         v_com_date_fld.editable = true;
      end;
      AddControl(v_com_date_fld);

      AddLabel(TRsbLabel(CV_POS_X+14, CV_POS_Y+1, "Диапазон"));
      v_com_date_switch_fld = TRsbCheckBox();
      v_com_date_switch_fld.setPosition(CV_POS_X+12, CV_POS_Y+1);
      v_com_date_switch_fld.onChecked(R2M(i_this_obj, "m_on_switch_date"));
      v_com_date_switch_fld.checked = gv_evnt_sel_prm.v_com_date_switch;
      AddControl(v_com_date_switch_fld);

      AddLabel(TRsbLabel(CV_POS_X+22, CV_POS_Y, "Диапазон дат"));
      v_com_beg_date_fld = TRsbEditField(FT_DATE);
      v_com_beg_date_fld.bindValue(gv_evnt_sel_prm, "v_com_beg_date", 10);
      v_com_beg_date_fld.setPosition(CV_POS_X+22, CV_POS_Y+1);
      v_com_beg_date_fld.setSize(10, 1);
      if(gv_evnt_sel_prm.v_com_date_switch)
         v_com_beg_date_fld.focusable = true;
         v_com_beg_date_fld.enabled = true;
         v_com_beg_date_fld.editable = true;
      else
         v_com_beg_date_fld.focusable = false;
         v_com_beg_date_fld.enabled = false;
         v_com_beg_date_fld.editable = false;
      end;
      AddControl(v_com_beg_date_fld);
      v_com_end_date_fld = TRsbEditField(FT_DATE);
      v_com_end_date_fld.bindValue(gv_evnt_sel_prm, "v_com_end_date", 10);
      v_com_end_date_fld.setPosition(CV_POS_X+22, CV_POS_Y+2);
      v_com_end_date_fld.setSize(10, 1);
      if(gv_evnt_sel_prm.v_com_date_switch)
         v_com_end_date_fld.focusable = true;
         v_com_end_date_fld.enabled = true;
         v_com_end_date_fld.editable = true;
      else
         v_com_end_date_fld.focusable = false;
         v_com_end_date_fld.enabled = false;
         v_com_end_date_fld.editable = false;
      end;
      AddControl(v_com_end_date_fld);


      /* Фильтр по объектам */
      AddLabel(TRsbLabel(CV_POS_X+4, CV_POS_Y+4, "Счета"));
      v_com_r_accounts = TRsbRadioButton(1);
      v_com_r_accounts.setPosition(CV_POS_X+1, CV_POS_Y+4);
      v_com_r_accounts.onChecked(R2M(i_this_obj, "m_on_checked_r"));
      AddControl(v_com_r_accounts);

      /* Фильтр по пачке */
      AddLabel(TRsbLabel(CV_POS_X+19, CV_POS_Y+4, "Номер пачки проводок"));
      v_com_number_pack_fld = TRsbEditField(FT_INT);
      v_com_number_pack_fld.bindValue(gv_evnt_sel_prm, "v_com_number_pack", 5);
      v_com_number_pack_fld.setPosition(CV_POS_X+29, CV_POS_Y+4);
      v_com_number_pack_fld.setSize(5, 1);
      AddControl(v_com_number_pack_fld);

      AddLabel(TRsbLabel(CV_POS_X+4, CV_POS_Y+5, "Проводки"));
      v_com_r_trans = TRsbRadioButton(1);
      v_com_r_trans.setPosition(CV_POS_X+1, CV_POS_Y+5);
      v_com_r_trans.onChecked(R2M(i_this_obj, "m_on_checked_r"));
      AddControl(v_com_r_trans);

      /* Фильтр по операционисту */
      AddLabel(TRsbLabel(CV_POS_X+19, CV_POS_Y+5, "Операционист"));
      v_com_oper_fld = TRsbEditField(FT_INT);
      v_com_oper_fld.bindValue(gv_evnt_sel_prm, "v_com_oper", 5);
      v_com_oper_fld.setPosition(CV_POS_X+29, CV_POS_Y+5);
      v_com_oper_fld.setSize(5, 1);
      AddControl(v_com_oper_fld);

      AddLabel(TRsbLabel(CV_POS_X+4, CV_POS_Y+6, "Платежи"));
      v_com_r_payments = TRsbRadioButton(1);
      v_com_r_payments.setPosition(CV_POS_X+1, CV_POS_Y+6);
      v_com_r_payments.onChecked(R2M(i_this_obj, "m_on_checked_r"));
      AddControl(v_com_r_payments);
      AddLabel(TRsbLabel(CV_POS_X+4, CV_POS_Y+7, "Все объекты"));
      v_com_r_allrecords = TRsbRadioButton(1);
      v_com_r_allrecords.setPosition(CV_POS_X+1, CV_POS_Y+7);
      v_com_r_allrecords.onChecked(R2M(i_this_obj, "m_on_checked_r"));
      v_com_r_allrecords.checked = true;
      AddControl(v_com_r_allrecords);

      /* Фильтр по наличию ошибок */
      AddLabel(TRsbLabel(CV_POS_X+4, CV_POS_Y+9, "только ошибки"));
      v_com_r_onlyerror = TRsbRadioButton(2);
      v_com_r_onlyerror.setPosition(CV_POS_X+1, CV_POS_Y+9);
      v_com_r_onlyerror.onChecked(R2M(i_this_obj, "m_on_checked_error_r"));
      AddControl(v_com_r_onlyerror);

      AddLabel(TRsbLabel(CV_POS_X+4, CV_POS_Y+10, "все результаты"));
      v_com_r_all = TRsbRadioButton(2);
      v_com_r_all.setPosition(CV_POS_X+1, CV_POS_Y+10);
      v_com_r_all.onChecked(R2M(i_this_obj, "m_on_checked_error_r"));
      v_com_r_all.checked = true;
      AddControl(v_com_r_all);

      AddLabel(TRsbLabel(CV_POS_X+4, CV_POS_Y+11, "ошибки в начале списка"));
      v_com_errorfirst_switch_fld = TRsbCheckBox();
      v_com_errorfirst_switch_fld.setPosition(CV_POS_X+1, CV_POS_Y+11);
      v_com_errorfirst_switch_fld.onChecked(R2M(i_this_obj, "m_on_switch_errorfirst"));
      v_com_errorfirst_switch_fld.checked = gv_evnt_sel_prm.v_com_errorfirst_switch;
      AddControl(v_com_errorfirst_switch_fld);  

      /* Кнопка сброса */
      v_com_null_btn = TRsbPushButton("Сброс");
      v_com_null_btn.setPosition(CV_POS_X + 26, CV_POS_Y+9);
      v_com_null_btn.setSize(6, 1);
      v_com_null_btn.onClicked(R2M(i_this_obj, "m_evnt_null_btn"));
      AddControl(v_com_null_btn);

      v_com_result_btn = TRsbPushButton("Журнал");
      v_com_result_btn.setPosition(CV_POS_X+3, CV_POS_Y+13);
      v_com_result_btn.setSize(12, 1);
      v_com_result_btn.onClicked(R2M(i_this_obj, "m_evnt_getresult_btn"));
      AddControl(v_com_result_btn);

      v_com_result_btn = TRsbPushButton("Сессии");
      v_com_result_btn.setPosition(CV_POS_X+18, CV_POS_Y+13);
      v_com_result_btn.setSize(10, 1);
      v_com_result_btn.onClicked(R2M(i_this_obj, "m_evnt_getsess_btn"));
      AddControl(v_com_result_btn);

      AddEventHandler(RSB_EV_KEY_PRESSED, R2M(i_this_obj, "m_evnt_on_key_pressed"));

      setSize(42, 17);
      setPosition(20, 5);

   end;

   InitTRsbPanel();

   m_init_com_unload_form(this);
end; /* class (TRsbPanel) c_com_unload_form() */


gv_evnt_sel_prm = c_evnt_selection_prm();

         gv_com_unload_form = c_com_unload_form();
         gv_com_unload_form.run;

exit(1);
