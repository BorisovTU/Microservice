/**
 @file 		ws_synch_SOFR.mac
 @brief 	Интеграция с внешними системами. Основной макрос обработки заданий funcobj

 # changelog
 |date       |autor          |tasks                                           |note
 |-----------|---------------|------------------------------------------------|-------------------------------------------------------------
 |27.03.2025 |Зыков М.В.     |BOSS-8449                                       |BOSS-8192 Доработка обновления справочника ценных бумаг для формирования ф724
 |27.03.2025 |Зыков М.В.     |BOSS-8097                                       |BOSS-7968  Доработка обновления справочников эмитентов  RUDATA
 |20.11.2024 |Велигжанин А.В.|DEF-76687                                       |ws_SOFR_GetFileEntriesForVerify(), загрузка с учетом формата файла
 |05.11.2024 |Велигжанин А.В.|DEF-75364                                       |Load306AccForCompare(), загрузка с учетом формата файла
 |08.11.2018 |А.Киселев      |                                                |Синхронизация данных СОФР 7.1.3, 7.2.9

*/

import "usr_table_int.mac",
       "secur_prc_msg_transform.mac",
       "RequestWS.mac",
       "uws_exchng_log.mac",
       "openaccount_req.mac",
       "addAccountingEntries_Req.mac",
       "approveaccountingentries_req.mac",
       "approveaccountingentries_reqSimple.mac",  //BIQ-10484 CCBO-6443 проводка ЦФТ РОВУ
       "GetCurrencyRate.mac",
       "loadRUData.mac",
       "UpdateDossierDepositoryInfoReq.mac",
       "GetEntriesForVerify_Req.mac",
       "GetAcctForVerify_Req.mac",
       "SOFR_RSHBbag.mac",
       "load_entcompare.mac",
       "load_acctcompare.mac",
       "load_306AccCompare.mac",
       "UpdateBrokContractRequestMsg.mac",
       "dbo_message_mass.mac",
       "UploadDocASOA.mac",
       "SendBrokerContractDepo_Req.mac",
       "PrepareNOBFromSOFRToDepo.mac",
       "LoadNOBFromDepoToSOFR.mac",
       "UndoNOBFromDepoToSOFR.mac",
       "Quik_UnloadINIFiles.mac",
       "dbo_qi_func.mac",
       "dbo_qi_Exclusion",
       "SendNotify_CloseContract.mac",
       "CdiFindOrg.mac",
       "CdiGetOrgReq.mac",
       "CdiCreateOrg.mac",
       "CdiUpdateOrgReq.mac";
import "u_common_email_utils.mac";
import "submit_trade_term_temp_pwd.mac"; /* 20190905 - kva */
import "usp_Import.mac"; /* 20190905 - kva */
import "Quik_flow.mac"; /* 20191024 - maa */
import DealsInter; /*shev*/
import "FuncObj.mac"; //shev для логирования
IMPORT "uentcompare_const.mac";
IMPORT cblogger;
IMPORT "it_utils.mac";



//А.Киселев 19.01.2021 Получим FIID из платежа
private macro GetFIIDfromPm( AcctrnId :integer, DC :string ) :integer
var Query :string = "",
    Params :TArray,
    DataSet :RsdRecordset,
    Fiid :integer = -1;

  Params = Null;
  DataSet = Null;
  Query = " SELECT  ( CASE :p_DC WHEN 'D' THEN T_FIID ELSE T_PAYFIID END ) AS T_FIID " +
          " FROM dpmpaym_dbt " +
          " WHERE T_PAYMENTID = :p_AccTrnId ";

  Params = makeArray( SQLParam( "p_DC", DC ),
                      SQLParam( "p_AccTrnId", AcctrnId ) );
  DataSet = execSQLselect( Query, Params );

  if( DataSet.MoveNext  )

   Fiid = DataSet.value(0, Null, V_INTEGER);
   Params = Null;
   DataSet = Null;


   return Fiid;

  end;

  Params = Null;
  DataSet = Null;


  return -1;

onError(err)
 
  Params = Null;
  DataSet = Null;

  return -1;

end;


//А.Киселев 19.01.2021 Получим FIID из проводки
private macro GetFIIDfromTrn( AcctrnId :integer, DC :string ) :integer
var Query :string = "",
    Params :TArray,
    DataSet :RsdRecordset,
    Fiid :integer = -1;

  Params = Null;
  DataSet = Null;
  Query = " SELECT  ( CASE :p_DC WHEN 'D' THEN T_FIID_PAYER ELSE T_FIID_RECEIVER END ) AS T_FIID " +
          " FROM dacctrn_dbt " +
          " WHERE T_ACCTRNID = :p_AccTrnId ";

  Params = makeArray( SQLParam( "p_DC", DC ),
                      SQLParam( "p_AccTrnId", AcctrnId ) );
  DataSet = execSQLselect( Query, Params );

  if( DataSet.MoveNext  )

   Fiid = DataSet.value(0, Null, V_INTEGER);
   Params = Null;
   DataSet = Null;


   return Fiid;

  end;

  Params = Null;
  DataSet = Null;


  return -1;

onError(err)
 
  Params = Null;
  DataSet = Null;

  return -1;

end;

//А.Киселев 27.11.2020 проверяем успешное событие открытие счета
private macro CheckEventOpenAcc( Acc :object, Fiid ) :bool
var Query :string = "",
    Params :TArray,
    DataSet :RsdRecordset;

  Params = Null;
  DataSet = Null;

  if( (Valtype(Fiid) == V_UNDEF) or (Valtype(Fiid) == 26) )

    Query = " SELECT COUNT(1) FROM daccount_dbt B " +
            " WHERE  B.T_ACCOUNT = :p_Acc " +
            "  AND B.T_CODE_CURRENCY = ( SELECT D.T_FIID FROM dfininstr_dbt D " +
            "                            WHERE D.T_FI_CODE = :p_Fi_Code ) " +
            "  AND T_CHAPTER IN( (SELECT C.T_CHAPTER FROM daccblnc_dbt C " +
            "                     WHERE C.T_ACCOUNTID = B.T_ACCOUNTID) ) " +

            "  AND ( EXISTS( SELECT 1 FROM utableprocessevent_dbt A " +
            "               WHERE A.T_OBJECTTYPE = :p_ObjType " +
            "                AND A.T_STATUS IN( :p_Status, 555 ) " +
            "                AND A.T_OBJECTID = B.T_ACCOUNTID ) " +

            "  AND  B.T_OPEN_DATE = RSBSESSIONDATA.CURDATE " +
            "   OR B.T_OPEN_DATE < RSBSESSIONDATA.CURDATE ) ";

    Params = makeArray( SQLParam( "p_Acc", Acc.AccountNumber ),
                        SQLParam( "p_Fi_Code", Acc.CurrencyCode ),
                        SQLParam( "p_ObjType", 4 ),
                        SQLParam( "p_Status", 4 )
                         );

  else

    Query = " SELECT COUNT(1) FROM daccount_dbt B " +
            " WHERE  B.T_ACCOUNT = :p_Acc " +
            "  AND B.T_CODE_CURRENCY = :p_FIID " +
            "  AND T_CHAPTER IN( (SELECT C.T_CHAPTER FROM daccblnc_dbt C " +
            "                     WHERE C.T_ACCOUNTID = B.T_ACCOUNTID) ) " +

            "  AND ( EXISTS( SELECT 1 FROM utableprocessevent_dbt A " +
            "                WHERE A.T_OBJECTTYPE = :p_ObjType " +
            "                 AND A.T_STATUS IN( :p_Status, 555 ) " +
            "                 AND A.T_OBJECTID = B.T_ACCOUNTID ) " +

            "  AND  B.T_OPEN_DATE = RSBSESSIONDATA.CURDATE " +
            "   OR B.T_OPEN_DATE < RSBSESSIONDATA.CURDATE ) ";

    Params = makeArray( SQLParam( "p_Acc", Acc.AccountNumber ),
                        SQLParam( "p_FIID", Fiid ),
                        SQLParam( "p_ObjType", 4 ),
                        SQLParam( "p_Status", 4 )
                         );

  end;

  DataSet = execSQLselect( Query, Params );


  if( (DataSet.MoveNext) and ( DataSet.value(0, Null, V_INTEGER) == 0 )  )

   Params = Null;
   DataSet = Null;


   return false;

  end;

  Params = Null;
  DataSet = Null;


  return true;

onError(err)
 
  Params = Null;
  DataSet = Null;

  return false;

end;


//А.Киселев 11.01.2021 проверяем физ. лицо юр. лицо по счету платежа
private macro IsLegalFormByPm( AcctrnId :integer, DC :string, LegalForm :integer, isIP :integer ) :bool

var Query :string = "",
    Params :TArray,
    DataSet :RsdRecordset;

  Params = Null;
  DataSet = Null;
  Query = " SELECT C.T_LEGALFORM, " +
          "  NVL( (SELECT ( CASE WHEN D.T_ISEMPLOYER = CHR(88) THEN 1 ELSE 0 END ) FROM dpersn_dbt D " +
          "        WHERE D.T_PERSONID = C.T_PARTYID ) , 0) AS isIP " +
          " FROM dpmpaym_dbt A, daccount_dbt B, dparty_dbt C " +
          " WHERE A.T_PAYMENTID = :p_AcctrnId " +

          "  AND B.T_ACCOUNT = ( CASE WHEN :p_DC_1 = 'D' THEN A.T_PAYERACCOUNT " +
          "                      ELSE A.T_RECEIVERACCOUNT END ) " +
          "  AND B.T_CHAPTER = A.T_CHAPTER " +
          "  AND B.T_CODE_CURRENCY = ( CASE WHEN :p_DC_2 = 'D' THEN A.T_FIID " +
          "                            ELSE A.T_PAYFIID END ) " +
          "  AND C.T_PARTYID = B.T_CLIENT ";

  Params = makeArray( SQLParam( "p_AcctrnId", AcctrnId ),
                      SQLParam( "p_DC_1", DC ),
                      SQLParam( "p_DC_2", DC ) );
  DataSet = execSQLselect( Query, Params );


  if( (DataSet.MoveNext) and ( DataSet.value(0, Null, V_INTEGER) == LegalForm ) and ( DataSet.value(1, Null, V_INTEGER) == isIP )  )

   Params = Null;
   DataSet = Null;


   return true;

  end;

  Params = Null;
  DataSet = Null;

  return false;

onError(err)
 
  Params = Null;
  DataSet = Null;

  return false;


end;


//А.Киселев 11.01.2021 проверяем физ. лицо юр. лицо по счету проводки
private macro IsLegalFormByTrn( AcctrnId :integer, DC :string, LegalForm :integer, isIP :integer ) :bool

var Query :string = "",
    Params :TArray,
    DataSet :RsdRecordset;

  Params = Null;
  DataSet = Null;
  Query = " SELECT C.T_LEGALFORM, " +
          "  NVL( (SELECT ( CASE WHEN D.T_ISEMPLOYER = CHR(88) THEN 1 ELSE 0 END ) FROM dpersn_dbt D " +
          "        WHERE D.T_PERSONID = C.T_PARTYID ) , 0) AS isIP " +
          " FROM dacctrn_dbt A, daccount_dbt B, dparty_dbt C " +
          " WHERE A.T_ACCTRNID = :p_AcctrnId " +
          "  AND B.T_ACCOUNTID = ( CASE WHEN :p_DC = 'D' THEN A.T_ACCOUNTID_PAYER " +
          "                        ELSE A.T_ACCOUNTID_RECEIVER  END ) " +
          "  AND C.T_PARTYID = B.T_CLIENT ";

  Params = makeArray( SQLParam( "p_AcctrnId", AcctrnId ),
                      SQLParam( "p_DC", DC ) );
  DataSet = execSQLselect( Query, Params );


  if( (DataSet.MoveNext) and ( DataSet.value(0, Null, V_INTEGER) == LegalForm ) and ( DataSet.value(1, Null, V_INTEGER) == isIP )  )

   Params = Null;
   DataSet = Null;


   return true;

  end;

  Params = Null;
  DataSet = Null;

  return false;

onError(err)
 
  Params = Null;
  DataSet = Null;

  return false;


end;

 //А.Киселев 27.11.2020 проверяем открытие внутреннего счета в счетах проводки
private macro CheckEventAccDCEntries( TrnLst :object ) :bool
return true; //Отключение статуса 12
 if( ( ValType( uTryToGetPropS( TrnLst[0].LegalEntityPayerDetails, "BIC" ) ) == V_UNDEF ) and 
     ( ValType( uTryToGetPropS( TrnLst[0].PersonPayerDetails, "BIC" ) ) == V_UNDEF ) )

//   проверить дебет внутреннего счета успешное открытие
    if( Index(TrnLst[0].ReferenceId.ObjectId, "paym") != 1) //для проводок
        if( ( ( IsLegalFormByTrn( int(StrSubst(TrnLst[0].ReferenceId.ObjectId, "trnpm","" )), "D", 2, 0) ) and (Index( TrnLst[0].DebitAccount.AccountNumber, "47423") != 1) and (Index( TrnLst[0].DebitAccount.AccountNumber, "306") != 1) or ( IsLegalFormByTrn( int(StrSubst(TrnLst[0].ReferenceId.ObjectId, "trnpm", "")), "D", 2, 1) ) or ( IsLegalFormByTrn( int(StrSubst(TrnLst[0].ReferenceId.ObjectId, "trnpm", "")), "D", 1, 0) ) ) and
            ( not CheckEventOpenAcc( TrnLst[0].DebitAccount, GetFIIDfromTrn(int(StrSubst(TrnLst[0].ReferenceId.ObjectId, "trnpm","" )), "D") ) ) )

         return false;

        end;

    else //для платежей

        if( ( ( IsLegalFormByPm( int(StrSubst(TrnLst[0].ReferenceId.ObjectId, "paym","" )), "D", 2, 0) ) and (Index( TrnLst[0].DebitAccount.AccountNumber, "47423") != 1) and (Index( TrnLst[0].DebitAccount.AccountNumber, "306") != 1) or ( IsLegalFormByPm( int(StrSubst(TrnLst[0].ReferenceId.ObjectId, "paym", "")), "D", 2, 1) ) or ( IsLegalFormByPm( int(StrSubst(TrnLst[0].ReferenceId.ObjectId, "paym", "")), "D", 1, 0) ) ) and
            ( not CheckEventOpenAcc( TrnLst[0].DebitAccount, GetFIIDfromPm(int(StrSubst(TrnLst[0].ReferenceId.ObjectId, "paym","" )), "D") ) ) )

         return false;

        end;

    end;
 end;

 if( ( ValType( uTryToGetPropS( TrnLst[0].LegalEntityPayeeDetails, "BIC" ) ) == V_UNDEF ) and 
     ( ValType( uTryToGetPropS( TrnLst[0].PersonPayeeDetails, "BIC" ) ) == V_UNDEF ) )

//   проверить кредит внутреннего счета успешное открытие
   if( Index(TrnLst[0].ReferenceId.ObjectId, "paym") != 1) //для проводок
       if( ( ( IsLegalFormByTrn( int(StrSubst(TrnLst[0].ReferenceId.ObjectId, "trnpm", "")), "C", 2, 0) ) and (Index( TrnLst[0].CreditAccount.AccountNumber, "47423") != 1) and (Index( TrnLst[0].CreditAccount.AccountNumber, "306") != 1) or ( IsLegalFormByTrn( int(StrSubst(TrnLst[0].ReferenceId.ObjectId, "trnpm","")), "C", 2, 1) ) or ( IsLegalFormByTrn( int(StrSubst(TrnLst[0].ReferenceId.ObjectId, "trnpm", "")), "C", 1, 0) ) ) and 
           ( not CheckEventOpenAcc(TrnLst[0].CreditAccount, GetFIIDfromTrn(int(StrSubst(TrnLst[0].ReferenceId.ObjectId, "trnpm","" )), "C") ) ) )

        return false;

       end;
   else //для платежей

       if( ( ( IsLegalFormByPm( int(StrSubst(TrnLst[0].ReferenceId.ObjectId, "paym", "")), "C", 2, 0) ) and (Index( TrnLst[0].CreditAccount.AccountNumber, "47423") != 1) and (Index( TrnLst[0].CreditAccount.AccountNumber, "306") != 1) or ( IsLegalFormByPm( int(StrSubst(TrnLst[0].ReferenceId.ObjectId, "paym","")), "C", 2, 1) ) or ( IsLegalFormByPm( int(StrSubst(TrnLst[0].ReferenceId.ObjectId, "paym", "")), "C", 1, 0) ) ) and 
           ( not CheckEventOpenAcc(TrnLst[0].CreditAccount, GetFIIDfromPm(int(StrSubst(TrnLst[0].ReferenceId.ObjectId, "paym","" )), "C") ) ) )

        return false;

       end;

   end;

 end;

 return true;

onError(err)
 return false;
end;


private class (с_init_obj_param) c_prm_proc_contrBO_result(p_str_param)
   var RecId       : integer = 0
      ,ObjectType  : integer = 0
      ,ProcessType : integer; /* (1) Тип курсов валют/учетных цен на ДМ */

   Initс_init_obj_param(p_str_param);
end;

private class (c_usr_tbl_base) c_usr_tbl_uTableProcessEvent()
   private class gen_uTableProcessEvent()
      var T_RECID :integer,
          T_TIMESTAMP :datetime,
          T_OBJECTTYPE :integer,
          T_OBJECTID :integer,
          T_TYPE :integer,
          T_STATUS :integer,
          T_NOTE :string,
          T_MESSAGEID :integer,
          T_RESULTCODE :string,
          T_RESULTTEXT :string,
          T_LASTUPDATE :datetime,
          T_ATTEMPTS: integer;
   end;

   private macro init_table_obj()
      new_val_obj = gen_uTableProcessEvent();
      where_val_obj = gen_uTableProcessEvent();
   end;

   Initc_usr_tbl_base("uTableProcessEvent_dbt");

   init_table_obj();
end;

private class (c_usr_tbl_base) c_usr_tbl_uTableProcessOut()
   private class gen_uTableProcessout()
      var T_RECID :integer,
          T_TIMESTAMP :datetime,
          T_OBJECTTYPE :integer,
          T_STATUS :integer,
          T_RESULTCODE :string,
          T_RESULTTEXT :string,
          T_FULLFILENAME:string;
   end;

   private macro init_table_obj()
      new_val_obj = gen_uTableProcessOut();
      where_val_obj = gen_uTableProcessOut();
   end;

   Initc_usr_tbl_base("uTableProcessOut_dbt");

   init_table_obj();
end;

private class (c_usr_tbl_base) c_usr_tbl_uTableProcessIn()
   private class gen_uTableProcessIn()
      var T_RECID :integer,
          T_TIMESTAMP :datetime,
          T_OBJECTTYPE :integer,
          T_STATUS :integer,
          T_RESULTCODE :string,
          T_RESULTTEXT :string,
          T_FULLFILENAME:string;
   end;

   private macro init_table_obj()
      new_val_obj = gen_uTableProcessIn();
      where_val_obj = gen_uTableProcessIn();
   end;

   Initc_usr_tbl_base("uTableProcessIn_dbt");

   init_table_obj();
end;


//класс вызываемых параметров ProcessEvent
private class TParamProcessAcc( StrParam :string )
   var RecId :integer = 0,
       ObjectType :integer = 0,
       AccountId :integer = 0,
       ProcessType :integer = 0,
       ProcessStatus :integer = 0;

   private var StrSeparator :string = ";";

   private macro InitParam( StrParam :string )
      var StrDigit :string = "0123456789",
          StrParamBuf :string = "",
          i :integer = 0,
          StrPos :integer = 0;

      if( (Valtype(StrParam) != V_UNDEF) and (Valtype(StrParam) != 26) and (StrParam != "") )
         i = 1;
         while( i <= StrLen(StrParam) ) //нормализация оставить, что только цифры или разделитель

            if( Index( (StrDigit + StrSeparator), Substr(StrParam, i, 1) ) >= 1 )
               StrParamBuf = StrParamBuf + Substr(StrParam, i, 1);

            end;
            i = i + 1;

         end;

         i = 0;
         while( (StrLen(StrParamBuf) > 0) and (GenNumProps(this) > i) ) //заполняем свойства
            StrPos = Index( StrParamBuf, StrSeparator );
            if( StrPos > 1 )
               this[i] =  int(Substr(StrParamBuf, 1, StrPos - 1));
               StrParamBuf = Substr(StrParamBuf, StrPos + 1);
            elif( (StrPos == 0) and (StrLen(StrParamBuf) > 0) )
               this[i] = int(StrParamBuf);
               StrParamBuf = "";
            end;
            i = i + 1;

         end;

      end;

   onError(err)

      RecId = 0;
      ObjectType = 0;
      ProcessStatus = 0;


   end;

   InitParam( StrParam );

end;



//класс вызываемых параметров ProcessEvent
private class TParamProcessEntry( StrParam :string )
   var RecId :integer = 0,
       ObjectType :integer = 0,
       AcctrnId :integer = 0,
       ProcessType :integer = 0,
       ProcessStatus :integer = 0;

   private var StrSeparator :string = ";";

   private macro InitParam( StrParam :string )
      var StrDigit :string = "0123456789",
          StrParamBuf :string = "",
          i :integer = 0,
          StrPos :integer = 0;

      if( (Valtype(StrParam) != V_UNDEF) and (Valtype(StrParam) != 26) and (StrParam != "") )
         i = 1;
         while( i <= StrLen(StrParam) ) //нормализация оставить, что только цифры или разделитель

            if( Index( (StrDigit + StrSeparator), Substr(StrParam, i, 1) ) >= 1 )
               StrParamBuf = StrParamBuf + Substr(StrParam, i, 1);

            end;
            i = i + 1;

         end;

         i = 0;
         while( (StrLen(StrParamBuf) > 0) and (GenNumProps(this) > i) ) //заполняем свойства
            StrPos = Index( StrParamBuf, StrSeparator );
            if( StrPos > 1 )
               this[i] =  int(Substr(StrParamBuf, 1, StrPos - 1));
               StrParamBuf = Substr(StrParamBuf, StrPos + 1);
            elif( (StrPos == 0) and (StrLen(StrParamBuf) > 0) )
               this[i] = int(StrParamBuf);
               StrParamBuf = "";
            end;
            i = i + 1;

         end;

      end;

   onError(err)

      RecId = 0;
      ObjectType = 0;
      ProcessStatus = 0;


   end;

   InitParam( StrParam );

end;


/*
private class TAccEntriesVerify( StrParam :string )
var PayerAccount :string = "",
    ReceiverAccount :string = "";

end;

//класс вызываемых параметров ProcessEvent
class TParamProcessEntriesVerify( StrParam :string )
   var AccEntries :TArray,
       RecId :integer = 0,
       ObjectType :integer = 0,
       ProcessType :integer = 0,
       DateIn :date = date("00.00.00"),
       DateOut :date = date("00.00.00"),
       ProcessStatus :integer = 0;

   private var StrSeparator :string = ";";


   private macro GetDateStr( StrBuf :string, DateSeparator :string) :string

    StrBuf = Substr( StrBuf, 1, 2 ) + DateSeparator + Substr( StrBuf, 3, 2 ) + DateSeparator + Substr( StrBuf, 5, 4 );
    return StrBuf;

   end;


   private macro InitParam( StrParam :string )
      var StrDigit :string = "0123456789",
          StrParamBuf :string = "",
          i :integer = 0,
          StrPos :integer = 0,
          StrParamAcc :string = "",
          StrAccD :string = "AccD",
          StrAccC :string = "AccC",
          SymbOpen :string = "[",
          SymbClose :string = "]",
          AccEntriesVerify :TAccEntriesVerify;

//1689731;5009;[AccD47421810400002000002;AccC;AccD;AccC47407840399000000002]1;14.05.2019;;2
      if( (Valtype(StrParam) != V_UNDEF) and (Valtype(StrParam) != 26) and (StrParam != "") )

         i = 1;
         StrPos = 0;
         while( i <= StrLen(StrParam) ) //Вырезать часть со спец. разделителями

          if( (StrPos > 0) and ( Substr(StrParam, i, 1) != SymbClose ) )
           StrParamAcc = StrParamAcc + Substr(StrParam, i, 1);
          end;

          if( Substr(StrParam, i, 1) == SymbOpen )
           StrPos = i;
          end;

          if( Substr(StrParam, i, 1) == SymbClose )
           StrPos = -1;
          end;

          if( ((StrPos == 0 ) or (StrPos == -1)) and (Substr(StrParam, i, 1) != SymbOpen) and (Substr(StrParam, i, 1) != SymbClose) )
            StrParamBuf = StrParamBuf + Substr(StrParam, i, 1);
          end;
          i = i + 1;

         end;

         StrParam = StrParamBuf;
         StrParamBuf = "";


         i = 1;
         while( i <= StrLen(StrParam) ) //нормализация оставить, что только цифры или разделитель

            if( Index( (StrDigit + StrSeparator), Substr(StrParam, i, 1) ) >= 1 )
               StrParamBuf = StrParamBuf + Substr(StrParam, i, 1);
            end;
            i = i + 1;

         end;

         i = 1;
         while( (StrLen(StrParamBuf) > 0) and (GenNumProps(this) > i + 1) ) //заполняем свойства со второго
            StrPos = Index( StrParamBuf, StrSeparator );
            if( StrPos > 1 )
               if( ValType(this[i]) == V_DATE )
                this[i] =  date( GetDateStr( Substr(StrParamBuf, 1, StrPos - 1), "." ) );
               else
                this[i] =  int(Substr(StrParamBuf, 1, StrPos - 1));
               end;

               StrParamBuf = Substr(StrParamBuf, StrPos + 1);
            elif( (StrPos == 0) and (StrLen(StrParamBuf) > 0) )
               if( ValType(this[i]) == V_DATE )
                this[i] = date( GetDateStr( StrParamBuf, "." ) );
               else
                this[i] = int(StrParamBuf);
               end;
               StrParamBuf = "";
            end;
            i = i + 1;

         end;


         i = 0;
         AccEntries = Null;
         while( (StrLen(StrParamAcc) > 0) ) //заполняем спец. свойства
            StrPos = Index( StrParamAcc, StrSeparator );
            if( StrPos > 1 )
              StrParamBuf = Substr(StrParamAcc, 1, StrPos - 1);
              if( Index( StrParamBuf, StrAccD ) )
               AccEntriesVerify = Null;
               AccEntriesVerify = TAccEntriesVerify();
               AccEntriesVerify.PayerAccount = StrSubst( StrParamBuf, StrAccD, "" );
              elif( Index( StrParamBuf, StrAccC ) )
               AccEntriesVerify.ReceiverAccount = StrSubst( StrParamBuf, StrAccC, "" );
               if( AccEntries == Null )
                AccEntries = TArray();
               end;
               AccEntries[AccEntries.Size] =  AccEntriesVerify;
              end;

              StrParamAcc = Substr(StrParamAcc, StrPos + 1);
            elif( (StrPos == 0) and (StrLen(StrParamAcc) > 0) )
              StrParamBuf = StrParamAcc;
              if( Index( StrParamBuf, StrAccD ) )
               AccEntriesVerify = Null;
               AccEntriesVerify = TAccEntriesVerify();
               AccEntriesVerify.PayerAccount = StrSubst( StrParamBuf, StrAccD, "" );
              elif( Index( StrParamBuf, StrAccC ) )
               AccEntriesVerify.ReceiverAccount = StrSubst( StrParamBuf, StrAccC, "" );
               if( AccEntries == Null )
                AccEntries = TArray();
               end;
               AccEntries[AccEntries.Size] =  AccEntriesVerify;
              end;
              StrParamBuf = "";
              StrParamAcc = "";
            end;
            i = i + 1;

         end;

      end;

   onError(err)

      RecId = 0;
      ObjectType = 0;
      ProcessStatus = 0;


   end;

   InitParam( StrParam );

end;
*/

private class TAccEntriesVerify( StrParam :string )
var PayerAccount :string = "",
    ReceiverAccount :string = "",
    PersN :string = "";
end;


//класс вызываемых параметров ProcessEvent
private class TParamProcessEntriesVerify( StrParam :string )
   var AccEntries :TArray,
       RecId :integer = 0,
       ObjectType :integer = 0,
       ProcessType :integer = 0,
       DateIn :date = date("00.00.00"),
       DateOut :date = date("00.00.00"),
       ProcessStatus :integer = 0;

   private var StrSeparator :string = ";";


   private macro GetDateStr( StrBuf :string, DateSeparator :string) :string

    StrBuf = Substr( StrBuf, 1, 2 ) + DateSeparator + Substr( StrBuf, 3, 2 ) + DateSeparator + Substr( StrBuf, 5, 4 );
    return StrBuf;

   end;


   private macro InitParam( StrParam :string )
      var StrDigit :string = "0123456789",
          StrParamBuf :string = "",
          i :integer = 0,
          StrPos :integer = 0,
          StrParamAcc :string = "",
          StrAccD :string = "AccD",
          StrAccC :string = "AccC",
          StrPersN :string = "PersN",
          SymbOpen :string = "[",
          SymbClose :string = "]",
          AccEntriesVerify :TAccEntriesVerify;

//1689731;5009;[AccD47421810400002000002;AccC;AccD;AccC47407840399000000002]1;14.05.2019;;2
      if( (Valtype(StrParam) != V_UNDEF) and (Valtype(StrParam) != 26) and (StrParam != "") )

         i = 1;
         StrPos = 0;
         while( i <= StrLen(StrParam) ) //Вырезать часть со спец. разделителями

          if( (StrPos > 0) and ( Substr(StrParam, i, 1) != SymbClose ) )
           StrParamAcc = StrParamAcc + Substr(StrParam, i, 1);
          end;

          if( Substr(StrParam, i, 1) == SymbOpen )
           StrPos = i;
          end;

          if( Substr(StrParam, i, 1) == SymbClose )
           StrPos = -1;
          end;

          if( ((StrPos == 0 ) or (StrPos == -1)) and (Substr(StrParam, i, 1) != SymbOpen) and (Substr(StrParam, i, 1) != SymbClose) )
            StrParamBuf = StrParamBuf + Substr(StrParam, i, 1);
          end;
          i = i + 1;

         end;

         StrParam = StrParamBuf;
         StrParamBuf = "";


         i = 1;
         while( i <= StrLen(StrParam) ) //нормализация оставить, что только цифры или разделитель

            if( Index( (StrDigit + StrSeparator), Substr(StrParam, i, 1) ) >= 1 )
               StrParamBuf = StrParamBuf + Substr(StrParam, i, 1);
            end;
            i = i + 1;

         end;

         i = 1;
         while( (StrLen(StrParamBuf) > 0) and (GenNumProps(this) > i + 1) ) //заполняем свойства со второго
            StrPos = Index( StrParamBuf, StrSeparator );
            if( StrPos > 1 )
               if( ValType(this[i]) == V_DATE )
                this[i] =  date( GetDateStr( Substr(StrParamBuf, 1, StrPos - 1), "." ) );
               else
                this[i] =  int(Substr(StrParamBuf, 1, StrPos - 1));
               end;

               StrParamBuf = Substr(StrParamBuf, StrPos + 1);
            elif( (StrPos == 0) and (StrLen(StrParamBuf) > 0) )
               if( ValType(this[i]) == V_DATE )
                this[i] = date( GetDateStr( StrParamBuf, "." ) );
               else
                this[i] = int(StrParamBuf);
               end;
               StrParamBuf = "";
            end;
            i = i + 1;

         end;


         i = 0;
         AccEntries = Null;
         while( (StrLen(StrParamAcc) > 0) ) //заполняем спец. свойства
            StrPos = Index( StrParamAcc, StrSeparator );
            if( StrPos > 1 )
              StrParamBuf = Substr(StrParamAcc, 1, StrPos - 1);
              if( Index( StrParamBuf, StrPersN ) )
               AccEntriesVerify = Null;
               AccEntriesVerify = TAccEntriesVerify();
               AccEntriesVerify.PersN = StrSubst( StrParamBuf, StrPersN, "" );
              elif( Index( StrParamBuf, StrAccD ) )
               AccEntriesVerify.PayerAccount = StrSubst( StrParamBuf, StrAccD, "" );
              elif( Index( StrParamBuf, StrAccC ) )
               AccEntriesVerify.ReceiverAccount = StrSubst( StrParamBuf, StrAccC, "" );
               if( AccEntries == Null )
                AccEntries = TArray();
               end;
               AccEntries[AccEntries.Size] =  AccEntriesVerify;
              end;

              StrParamAcc = Substr(StrParamAcc, StrPos + 1);
            elif( (StrPos == 0) and (StrLen(StrParamAcc) > 0) )
              StrParamBuf = StrParamAcc;
              if( Index( StrParamBuf, StrPersN ) )
               AccEntriesVerify = Null;
               AccEntriesVerify = TAccEntriesVerify();
               AccEntriesVerify.PersN = StrSubst( StrParamBuf, StrPersN, "" );
              elif( Index( StrParamBuf, StrAccD ) )
               AccEntriesVerify.PayerAccount = StrSubst( StrParamBuf, StrAccD, "" );
              elif( Index( StrParamBuf, StrAccC ) )
               AccEntriesVerify.ReceiverAccount = StrSubst( StrParamBuf, StrAccC, "" );
               if( AccEntries == Null )
                AccEntries = TArray();
               end;
               AccEntries[AccEntries.Size] =  AccEntriesVerify;
              end;
              StrParamBuf = "";
              StrParamAcc = "";
            end;
            i = i + 1;

         end;

      end;

   onError(err)

      RecId = 0;
      ObjectType = 0;
      ProcessStatus = 0;


   end;

   InitParam( StrParam );

end;




private class TAcctVerify( StrParam :string )
var Account :string = "";

end;



//класс вызываемых параметров ProcessEvent
class TParamProcessAcctVerify( StrParam :string )
var    Acct :TArray,
       RecId :integer = 0,
       ObjectType :integer = 0,
       ProcessType :integer = 0,
       RestDate :date = date("00.00.00"),
       ProcessStatus :integer = 0;

   private var StrSeparator :string = ";";


   private macro GetDateStr( StrBuf :string, DateSeparator :string) :string

    StrBuf = Substr( StrBuf, 1, 2 ) + DateSeparator + Substr( StrBuf, 3, 2 ) + DateSeparator + Substr( StrBuf, 5, 4 );
    return StrBuf;

   end;


   private macro InitParam( StrParam :string )
      var StrDigit :string = "0123456789",
          StrParamBuf :string = "",
          i :integer = 0,
          StrPos :integer = 0,
          StrParamAcc :string = "",
          StrAcc :string = "Acc",
          SymbOpen :string = "[",
          SymbClose :string = "]",
          AcctVerify :TAcctVerify;

//1689731;5008;[Acc47421810400002000002;Acc47407840399000000002]1;14.05.2019;;2
      if( (Valtype(StrParam) != V_UNDEF) and (Valtype(StrParam) != 26) and (StrParam != "") )

         i = 1;
         StrPos = 0;
         while( i <= StrLen(StrParam) ) //Вырезать часть со спец. разделителями

          if( (StrPos > 0) and ( Substr(StrParam, i, 1) != SymbClose ) )
           StrParamAcc = StrParamAcc + Substr(StrParam, i, 1);
          end;

          if( Substr(StrParam, i, 1) == SymbOpen )
           StrPos = i;
          end;

          if( Substr(StrParam, i, 1) == SymbClose )
           StrPos = -1;
          end;

          if( ((StrPos == 0 ) or (StrPos == -1)) and (Substr(StrParam, i, 1) != SymbOpen) and (Substr(StrParam, i, 1) != SymbClose) )
            StrParamBuf = StrParamBuf + Substr(StrParam, i, 1);
          end;
          i = i + 1;

         end;

         StrParam = StrParamBuf;
         StrParamBuf = "";


         i = 1;
         while( i <= StrLen(StrParam) ) //нормализация оставить, что только цифры или разделитель

            if( Index( (StrDigit + StrSeparator), Substr(StrParam, i, 1) ) >= 1 )
               StrParamBuf = StrParamBuf + Substr(StrParam, i, 1);
            end;
            i = i + 1;

         end;

         i = 1;
         while( (StrLen(StrParamBuf) > 0) and (GenNumProps(this) > i + 1) ) //заполняем свойства со второго
            StrPos = Index( StrParamBuf, StrSeparator );
            if( StrPos > 1 )
               if( ValType(this[i]) == V_DATE )
                this[i] =  date( GetDateStr( Substr(StrParamBuf, 1, StrPos - 1), "." ) );
               else
                this[i] =  int(Substr(StrParamBuf, 1, StrPos - 1));
               end;

               StrParamBuf = Substr(StrParamBuf, StrPos + 1);
            elif( (StrPos == 0) and (StrLen(StrParamBuf) > 0) )
               if( ValType(this[i]) == V_DATE )
                this[i] = date( GetDateStr( StrParamBuf, "." ) );
               else
                this[i] = int(StrParamBuf);
               end;
               StrParamBuf = "";
            end;
            i = i + 1;

         end;


         i = 0;
         Acct = Null;
         while( (StrLen(StrParamAcc) > 0) ) //заполняем спец. свойства
            StrPos = Index( StrParamAcc, StrSeparator );
            if( StrPos > 1 )
              StrParamBuf = Substr(StrParamAcc, 1, StrPos - 1);
              if( Index( StrParamBuf, StrAcc ) )
               AcctVerify = Null;
               AcctVerify = TAcctVerify();
               AcctVerify.Account = StrSubst( StrParamBuf, StrAcc, "" );
               if( Acct == Null )
                Acct = TArray();
               end;
               Acct[Acct.Size] =  AcctVerify;
              end;

              StrParamAcc = Substr(StrParamAcc, StrPos + 1);
            elif( (StrPos == 0) and (StrLen(StrParamAcc) > 0) )
              StrParamBuf = StrParamAcc;
              if( Index( StrParamBuf, StrAcc ) )
               AcctVerify = Null;
               AcctVerify = TAcctVerify();
               AcctVerify.Account = StrSubst( StrParamBuf, StrAcc, "" );
               if( Acct == Null )
                Acct = TArray();
               end;
               Acct[Acct.Size] =  AcctVerify;
              end;
              StrParamBuf = "";
              StrParamAcc = "";
            end;
            i = i + 1;

         end;

      end;

   onError(err)

      RecId = 0;
      ObjectType = 0;
      ProcessStatus = 0;


   end;

   InitParam( StrParam );

end;




//класс вызываемых параметров ProcessEvent
private class TParamProcessSlowEvent( StrParam :string )
   var RecId :integer = 0,
       ObjectType :integer = 0,
       ProcessType :integer = 0,
       ProcessStatus :integer = 0;

   private var StrSeparator :string = ";";

   private macro InitParam( StrParam :string )
      var StrDigit :string = "0123456789",
          StrParamBuf :string = "",
          i :integer = 0,
          StrPos :integer = 0;

      if( (Valtype(StrParam) != V_UNDEF) and (Valtype(StrParam) != 26) and (StrParam != "") )
         i = 1;
         while( i <= StrLen(StrParam) ) //нормализация оставить, что только цифры или разделитель

            if( Index( (StrDigit + StrSeparator), Substr(StrParam, i, 1) ) >= 1 )
               StrParamBuf = StrParamBuf + Substr(StrParam, i, 1);

            end;
            i = i + 1;

         end;

         i = 0;
         while( (StrLen(StrParamBuf) > 0) and (GenNumProps(this) > i) ) //заполняем свойства
            StrPos = Index( StrParamBuf, StrSeparator );
            if( StrPos > 1 )
               this[i] =  int(Substr(StrParamBuf, 1, StrPos - 1));
               StrParamBuf = Substr(StrParamBuf, StrPos + 1);
            elif( (StrPos == 0) and (StrLen(StrParamBuf) > 0) )
               this[i] = int(StrParamBuf);
               StrParamBuf = "";
            end;
            i = i + 1;

         end;

      end;

   onError(err)

      RecId = 0;
      ObjectType = 0;
      ProcessStatus = 0;


   end;

   InitParam( StrParam );

end;


private class TParamUpdateDossier( StrParam :string )
   var RecId :integer = 0,
       ObjectType :integer = 0,
       ObjectID :integer = 0,
       ProcessType :integer = 0,
       ProcessStatus :integer = 0;

   private var StrSeparator :string = ";";

   private macro InitParam( StrParam :string )
      var StrDigit :string = "0123456789",
          StrParamBuf :string = "",
          i :integer = 0,
          StrPos :integer = 0;

      if( (Valtype(StrParam) != V_UNDEF) and (Valtype(StrParam) != 26) and (StrParam != "") )
         i = 1;
         while( i <= StrLen(StrParam) ) //нормализация оставить, что только цифры или разделитель
            if( Index( (StrDigit + StrSeparator), Substr(StrParam, i, 1) ) >= 1 )
               StrParamBuf = StrParamBuf + Substr(StrParam, i, 1);
            end;
            i = i + 1;
         end;

         i = 0;
         while( (StrLen(StrParamBuf) > 0) and (GenNumProps(this) > i) ) //заполняем свойства
            StrPos = Index( StrParamBuf, StrSeparator );
            if( StrPos > 1 )
               this[i] =  int(Substr(StrParamBuf, 1, StrPos - 1));
               StrParamBuf = Substr(StrParamBuf, StrPos + 1);
            elif( (StrPos == 0) and (StrLen(StrParamBuf) > 0) )
               this[i] = int(StrParamBuf);
               StrParamBuf = "";
            end;
            i = i + 1;
         end;
      end;
   onError(err)
      RecId = 0;
      ObjectType = 0;
      ProcessStatus = 0;
   end;

   InitParam( StrParam );
end;

private class TParamWithString( StrParam :string )
   var ObjectID :integer = 0,
       ObjectType :integer = 0,
       Params :string = "";

   private var StrSeparator :string = ";";

   private macro InitParam( StrParam :string )
      var StrDigit :string = "0123456789",
          StrParamBuf :string = "",
          i :integer = 0,
          StrPos :integer = 0;

      if( (Valtype(StrParam) != V_UNDEF) and (Valtype(StrParam) != 26) and (StrParam != "") )
         StrParamBuf = StrParam;
         i = 0;
         while( (StrLen(StrParamBuf) > 0) and (GenNumProps(this) > i) ) //заполняем свойства
            StrPos = Index( StrParamBuf, StrSeparator );
            if( StrPos > 1 )
               this[i] =  Substr(StrParamBuf, 1, StrPos - 1);
               StrParamBuf = Substr(StrParamBuf, StrPos + 1);
            elif( (StrPos == 0) and (StrLen(StrParamBuf) > 0) )
               this[i] = StrParamBuf;
               StrParamBuf = "";
            end;
            i = i + 1;
         end;
      end;
   onError(err)
      ObjectID = 0;
      ObjectType = 0;
      Params = "";
   end;

   InitParam( StrParam );
end;


/*----------------------------------------------------*/
/*       Стандартный набор входящих параметров        */
/*----------------------------------------------------*/
/* Актуально для следующих процедур:                  */
/* - Процедура генерации и отправки временного пароля */
/* - Процедура выгрузки данных Клиента в РСХБ-Брокер  */
/* - Процедура выгрузки данных Клиента в QUIK         */
/*----------------------------------------------------*/
private class (с_init_obj_param) c_prm_proc_std(p_income_data)
   var v_rec_id       : INTEGER = 0
      ,v_object_type  : INTEGER = 0
      ,v_client_id    : INTEGER = 0 /* Идентификатор Клиента */
      ,v_process_type : INTEGER = 0
      ,v_stat_in_proc : INTEGER = 0
      ,v_stat_ok      : INTEGER = 0
      ,v_stat_err     : INTEGER = 0;

   Initс_init_obj_param(p_income_data);
end; /* class c_prm_proc_std() */


/*------------------------------------*/
/* Функция обновления статуса события */
/*------------------------------------*/
private macro m_update_evnt_status(p_recid, p_status)
   var v_ret = true;
   var v_sql, v_cmd;

   v_sql =         "UPDATE utableprocessevent_dbt ";
   v_sql = v_sql + "   SET t_status = :p_status ";
   v_sql = v_sql + " WHERE t_recid = :p_recid ";
   v_cmd = RSDCommand(v_sql);
   v_cmd.addParam("p_status", RSDBP_IN, p_status);
   v_cmd.addParam("p_recid", RSDBP_IN, p_recid);
   v_cmd.execute();

   v_cmd.close(); v_cmd = NULL; v_sql = NULL;

   return v_ret;

onError(err)
   v_ret = false;
   return v_ret;
end; /* macro m_update_evnt_status() */


macro GetStrParamFromEvent( ReqId :integer ) :string

var Query :string = "",
    Params :TArray,
    DataSet :RsdRecordset,
    StrParam :string = "";

  if( ( Valtype( ReqId ) != V_UNDEF ) and ( Valtype( ReqId ) != 26 ) )
    Params = Null;
    DataSet = Null;

    Query = " SELECT T_PARAM FROM utableprocessevent_dbt " +
            " WHERE T_RECID = :p_ReqId ";

    Params = makeArray( SQLParam( "p_ReqId", ReqId ) );
    DataSet = execSQLselect( Query, Params );

    StrParam = "";

    if( ( DataSet.MoveNext) and
      ( Valtype( DataSet.value(0, Null, V_STRING) ) != V_UNDEF ) and ( Valtype( DataSet.value(0, Null, V_STRING) ) != 26 )  and ( DataSet.value(0, Null, V_STRING) != "" ) )
     StrParam = DataSet.value(0, Null, V_STRING);
    end;

    Params = Null;
    DataSet = Null;
  else
   return StrParam;
  end;
  
  return StrParam;

onError(err)

  Params = Null;
  DataSet = Null;
  return "";

end;



macro GetFileNameFromProcessIn( ReqId :integer, EventReqId :@integer ) :string

var Query :string = "",
    Params :TArray,
    DataSet :RsdRecordset,
    StrParam :string = "";

  if( ( Valtype( ReqId ) != V_UNDEF ) and ( Valtype( ReqId ) != 26 ) )
    Params = Null;
    DataSet = Null;
    Query = " SELECT T_RESULTTEXT " +
            " FROM uTableProcessIn_dbt " +
            " WHERE T_RECID = :p_ReqId ";

    Params = makeArray( SQLParam( "p_ReqId", ReqId ) );
    DataSet = execSQLselect( Query, Params );

    EventReqId = -1;
    StrParam = "";

    if( ( DataSet.MoveNext) and
      ( Valtype( DataSet.value(0, Null, V_STRING) ) != V_UNDEF ) and ( Valtype( DataSet.value(0, Null, V_STRING) ) != 26 )  and ( DataSet.value(0, Null, V_STRING) != "" ) )
     EventReqId = Int(Substr( DataSet.value(0, Null, V_STRING), Index( DataSet.value(0, Null, V_STRING), "_" ) + 1 ) );
     StrParam = DataSet.value(0, Null, V_STRING);
    end;

    Params = Null;
    DataSet = Null;
  else
   return StrParam;
  end;
  
  return StrParam;

onError(err)

  Params = Null;
  DataSet = Null;
  EventReqId = -1;
  return "";

end;




//Передача из СОФР данных по счетам бух. учета
macro ws_SOFR_OpenAccount( Str_Param )
   var res :object,
       ParamProcess :TParamProcessAcc,
       ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
       state :integer = 0,
       errortext :string = "",
       RequestText,
       v_transformator,
       v_answer,
       v_logger_obj,
       v_log_id,
       v_FuncObjResult:FuncObjResult;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;
   ParamProcess = TParamProcessAcc( Str_Param + ";2"); //установить статусы 2

   res = SOFR_OpenAccount_Req( ParamProcess.accountId, ParamProcess.ProcessType );

   //if( Valtype(res.OpenAccountsRequestMsg.OpenAccountsRequest.AccountParams.AccountId.ObjectId) != V_UNDEF) //исключаем вероятность, что пока задание болталось в очереди, счет из account_dbt удалили
   if( Valtype(res.OpenAccountsRequestMsg.OpenAccountsRequest.AccountParamsList.value(0).AccountId.ObjectId) != V_UNDEF)
      v_transformator = c_secur_msg_converter();
      RequestText = v_transformator.m_secur_external_req(res);
      v_logger_obj = uws_exchng_logger(null,
                                       null,
                                       XmlRpcRequestId(),
                                       "ws_SOFR_OpenAccount",
                                       modulename(),
                                       ParamProcess.RecId,
                                       RequestText);
      v_log_id = v_logger_obj.get_log_id();

      v_answer = SubmitRequestToWS( 2,                 // ИД очереди.
                                    "",                // ИД сообщения.
                                    "",                // Идентификатор Бэк Офиса. (не обрабатывается).
                                    false,/*true,*/    // Признак синхронной обработки. Если не указан, = False
                                    "0000",            /*1,*/ // Подразделение системы-назначения.
                                    4,                 // ИД типа данных
                                    RequestText,       // Бизнес данные в виде XML.
                                    string(ParamProcess.RecId, "-", v_log_id) // 20181229 - kva - Передаем id из utableprocessevent_dbt
                                    );
 // v_logger_obj.add_response(v_answer);
   end;

//по !!!! не успешному результату сообщить в почту 
//по !!!! не успешному результату сообщить в почту

   //установка статуса в uTableProcessEvent_dbt
   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
   ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
   if( not ProcessEventTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
      state = 1;
   end;
   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;
   //установка статуса в uTableProcessEvent_dbt
   return state;

onError(err)
   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;
//   state = 1;
//return state;
//shev записываем ошибки в funcobj

   v_FuncObjResult.errorText = GetFullErrorMessage(err,950);
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;

end;
//Передача из СОФР данных по счетам бух. учета




//Передача из СОФР данных по проводкам
macro ws_SOFR_addAccountingEntries( Str_Param )
   var res_obj :object,
       trn :object,
       ParamProcess :TParamProcessEntry,
       ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
       state :integer = 0,
       errortext :string = "",
       RequestText,
       v_transformator,
       v_answer,
       v_logger_obj,
       v_log_id,
       ObjTypeId :integer = 0, // ИД типа данных справочник объектов SOFR
       FlPaym :bool = false,
       FlSyncAsync :bool = true;
       var v_FuncObjResult:FuncObjResult;

   var Query :string = "",
       Params :TArray,
       DataSet :RsdRecordset,
       sql,
       err_txt;

   var v_module_name = "ws_SOFR_addAccountingEntries"; /* 20190113 - kva - значение по умолчанию */
   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

//   InitCBLog(1, "ws_sofr_addAcc");


   ParamProcess = Null;
   ProcessEventTbl = Null;
   res_obj = Null;

   ParamProcess = TParamProcessEntry( Str_Param + ";2"); //подготовить установку статуса 2

// 2021-06-10 Cherednichenko Исключаем задвоение проводок 1 Проверка статуса
   Params = Null;
   DataSet = Null;
   Query = " SELECT t_status " +
           " FROM uTableProcessEvent_dbt "+
           " WHERE T_RECID = :p_RecId ";
   
   Params = makeArray( SQLParam( "p_RecId", ParamProcess.RecId) );
   DataSet = execSQLselect( Query, Params );

   if( DataSet.MoveNext)
     if (DataSet.value("t_status") != 1)
//         err_txt = "Событие уже переведено из статуса 1";
//         RunError(err_txt, c_usr_err_obj(err_txt)); 
         RunError("Дублированная выгрузка проводки"); 

     end;
   end;
// /Исключаем задвоение проводок 1 Проверка статуса

   if( ParamProcess.ObjectType == 501) //платеж
      FlPaym = true;
   else
      FlPaym = false;
   end;


   if( ParamProcess.ProcessType == 3 ) //удаление проводки
      res_obj = ApproveAccountingEntries_Req ( ParamProcess.AcctrnId );
      ObjTypeId = 8;
      FlSyncAsync = false;
      v_module_name = "ws_SOFR_approveAccountingEntries";
   else
//   setrstrace(true);
//   OutputIntrace("provodki_begin_06.12");


// 2021-06-10 Cherednichenko Исключаем задвоение проводок 2 Используем транзакцию
     RslDefCon.BeginTrans();

// 2021-06-10 Cherednichenko Исключаем задвоение проводок 3 Блокируем запись "For update"

      sql = execSQL(" SELECT * " +
                    " FROM dacctrn_dbt "+
                    " WHERE T_ACCTRNID = :p_AccTrnId " +
                    " for UPDATE nowait ",
                    makeArray (sqlParam ("p_AccTrnId", ParamProcess.AcctrnId)));

      res_obj = addAccountingEntriesReq( ParamProcess.AcctrnId, FlPaym );//создание проводки/изменение проводки
      ObjTypeId = 5;
/*  FlSyncAsync = true;*/
      FlSyncAsync = false;

//   setrstrace(false);
//   OutputIntrace("provodki_end_06.12");


   end;



   //А.Киселев 27.11.2020 проверяем события успешного открытия внутреннего счета
   if( (ParamProcess.ProcessType != 3) and (isEqClass("TArray", res_obj.AddAccountingEntriesRequestMsg.AddAccountingEntriesRequest.TransactionList[0].EntryList)) and
        ( res_obj.AddAccountingEntriesRequestMsg.AddAccountingEntriesRequest.TransactionList[0].EntryList.Size > 0 ) and
        ( CheckEventAccDCEntries( res_obj.AddAccountingEntriesRequestMsg.AddAccountingEntriesRequest.TransactionList[0].EntryList ) ) or (ParamProcess.ProcessType == 3) )

     //исключаем вероятность, что пока задание болталось в очереди, счет из acctrn_dbt удалили
       if( (ParamProcess.ProcessType != 3) /* and (isEqClass("TArray", res_obj.AddAccountingEntriesRequestMsg.AddAccountingEntriesRequest.TransactionList[0].EntryList)) and
          ( res_obj.AddAccountingEntriesRequestMsg.AddAccountingEntriesRequest.TransactionList[0].EntryList.Size > 0 ) */  or
          (ParamProcess.ProcessType == 3) and (isEqClass("CApproveEntry", res_obj.ApproveAccountingEntriesRequestMsg.ApproveAccountingEntriesRequest.ApproveEntry)) ) 
        v_transformator = c_secur_msg_converter();
        RequestText = v_transformator.m_secur_external_req(res_obj);
        v_logger_obj = uws_exchng_logger(null,
                                         null,
                                         XmlRpcRequestId(),
                                         v_module_name,
                                         modulename(),
                                         ParamProcess.RecId,
                                         RequestText);
        v_log_id = v_logger_obj.get_log_id();
        v_answer = SubmitRequestToWS( 2,                 // ИД очереди.
                                      "",                // ИД сообщения.
                                      "",                // Идентификатор Бэк Офиса. (не обрабатывается).
                                      FlSyncAsync,       // Признак синхронной обработки. Если не указан, = False
                                      "0000",            /*1,*/ // Подразделение системы-назначения.
                                      ObjTypeId,         // ИД типа данных
                                      RequestText,       // Бизнес данные в виде XML.
                                      string(ParamProcess.RecId, "-", v_log_id) // 20181229 - kva - Передаем id из utableprocessevent_dbt
                                      );
   // v_logger_obj.add_response(v_answer);
     end;

   elif(ParamProcess.ProcessType != 3) //А.Киселев 27.11.2020 Ожидаем событие - успешное открытие внутреннего счета
    ParamProcess.ProcessStatus = 12;
   end;

//по !!!! не успешному результату сообщить в почту 
//по !!!! не успешному результату сообщить в почту

   //установка статуса в uTableProcessEvent_dbt
   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
   ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
   if( not ProcessEventTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
    state = 1;
   end;
   ParamProcess = Null;
   ProcessEventTbl = Null;
   res_obj = Null;
   //установка статуса в uTableProcessEvent_dbt

// Закрываем транзакцию через commit, если была открыта
   if ( rslDefCon.isInTrans() )
     rslDefCon.commitTrans();
   end;

   return state;

onError(err)
// Закрываем транзакцию через rollback, если была открыта
   if ( rslDefCon.isInTrans() )
     rslDefCon.rollbackTrans();
   end;

   ParamProcess = Null;
   ProcessEventTbl = Null;
   res_obj = Null;
//   state = 1;
//   return state;

//shev записываем ошибки в funcobj
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;


end;


//Передача из СОФР данных по удаляемым проводкам ЦФТ, при удалении РОВУ. ID проводки в примечании к РОВУ
//BIQ-10484 CCBO-6443(клон 5829)
macro ws_SOFR_addAccountingEntriesROVU( Str_Param ) 
   var res_obj :object,
       trn :object,
       ParamProcess :TParamProcessEntry,
       ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
       state :integer = 0,
       errortext :string = "",
       RequestText,
       v_transformator,
       v_answer,
       v_logger_obj,
       AcctrnId,
       v_log_id,
       ObjTypeId :integer = 0, // ИД типа данных справочник объектов SOFR
       FlPaym :bool = false,
       FlSyncAsync :bool = true;
       var v_FuncObjResult:FuncObjResult;

   var Query :string = "",
       Params :TArray,
       DataSet :RsdRecordset,
       sql,
       err_txt;

   var v_module_name = "ws_SOFR_addAccountingEntries"; 

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   ParamProcess = Null;
   ProcessEventTbl = Null;
   res_obj = Null;

   ParamProcess = TParamProcessEntry( Str_Param + ";2"); //подготовить установку статуса 2

   Params = Null;
   DataSet = Null;
   Query = " SELECT t_status " +
           " FROM uTableProcessEvent_dbt "+
           " WHERE T_RECID = :p_RecId ";
   
   Params = makeArray( SQLParam( "p_RecId", ParamProcess.RecId) );
   DataSet = execSQLselect( Query, Params );

   if( DataSet.MoveNext)
     if (DataSet.value("t_status") != 1)
         RunError("Дублированная выгрузка проводки"); 
     end;
   end;
// /Исключаем задвоение проводок 1 Проверка статуса

//shev  id проводки из примечание не влезает в t_objectid, теперь в t_note
   Params = Null;
   DataSet = Null;
   Query = " SELECT t_note " +
           " FROM uTableProcessEvent_dbt "+
           " WHERE T_RECID = :p_RecId ";
   
   Params = makeArray( SQLParam( "p_RecId", ParamProcess.RecId) );
   DataSet = execSQLselect( Query, Params );

   if( DataSet.MoveNext)
       AcctrnId = DataSet.value("t_note") 
   end;


   if( ParamProcess.ProcessType == 3 ) //удаление проводки
      res_obj = ApproveAccountingEntries_ReqSimple ( AcctrnId );  
      ObjTypeId = 8;
      FlSyncAsync = false;
      v_module_name = "ws_SOFR_approveAccountingEntries";
   else
     RunError("Для данного сервиса ProcessType только 3"); 
   end;



   if( (ParamProcess.ProcessType == 3) and (isEqClass("CApproveEntry", res_obj.ApproveAccountingEntriesRequestMsg.ApproveAccountingEntriesRequest.ApproveEntry))) 
        v_transformator = c_secur_msg_converter();
        RequestText = v_transformator.m_secur_external_req(res_obj);
        v_logger_obj = uws_exchng_logger(null,
                                         null,
                                         XmlRpcRequestId(),
                                         v_module_name,
                                         modulename(),
                                         ParamProcess.RecId,
                                         RequestText);
        v_log_id = v_logger_obj.get_log_id();
        v_answer = SubmitRequestToWS( 2,                 // ИД очереди.
                                      "",                // ИД сообщения.
                                      "",                // Идентификатор Бэк Офиса. (не обрабатывается).
                                      FlSyncAsync,       // Признак синхронной обработки. Если не указан, = False
                                      "0000",            /*1,*/ // Подразделение системы-назначения.
                                      ObjTypeId,         // ИД типа данных
                                      RequestText,       // Бизнес данные в виде XML.
                                      string(ParamProcess.RecId, "-", v_log_id) 
                                      );
     end;

   //установка статуса в uTableProcessEvent_dbt
   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
   ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
   if( not ProcessEventTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
    state = 1;
   end;
   ParamProcess = Null;
   ProcessEventTbl = Null;
   res_obj = Null;


   return state;

onError(err)

   ParamProcess = Null;
   ProcessEventTbl = Null;

   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;

end;


// shev DEF-79638 пока оставил, но планировщик отключен
//Загрузка Данных из Ru-Data
macro ws_SOFR_LoadRuData( Str_Param )
   var ProcessInTbl :c_usr_tbl_uTableProcessIn,
       ParamProcess :TParamProcessSlowEvent,
       state :integer = 0;
   var error = "";
   var v_sql,v_rs, v_cmd,dt,t;
   var v_email_processor;
   var CV_EMAIL_GRP_CHD = 1;
   var  v_FuncObjResult:FuncObjResult;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

//shev 020620 isup 510242

   v_sql =         "SELECT  t_status, sysdate,t_timestamp ";
   v_sql = v_sql + "  FROM utableprocessin_dbt ";
   v_sql = v_sql + " WHERE t_objecttype = 1 ";
   v_sql = v_sql + " order by 1 desc ";

   v_cmd = RSDCommand(v_sql);
   v_rs = RSDRecordSet(v_cmd);
   if(v_rs.movenext())

      DtTmSplit(v_rs.value("sysdate"), dt,t);
      if(time(03:00:00) < t)
        if(v_rs.value("t_status") != 4)

           v_email_processor = c_email_proc_env();
           v_email_processor.m_set_msg_head("СОФР - Загрузка данных из Рудаты");
           v_email_processor.m_add_row_to_msg_text("Выгрузка невозможна.Одна из предыдущих задач не завершена. ");
           v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_CHD, true);
           v_email_processor.m_submit_email();

         end;

      elif((time(03:00:00) < t) and (time(02:30:00) > t))
        if(v_rs.value("t_status") != 2)

           v_email_processor = c_email_proc_env();
           v_email_processor.m_set_msg_head("СОФР - Загрузка данных из Рудаты");
           v_email_processor.m_add_row_to_msg_text("Выгрузка невозможна. ETL не заполнил буферные таблицы");
           v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_CHD, true);
           v_email_processor.m_submit_email();

         end;
      end;
   end;

//shev 020620 isup 510242

   ParamProcess = Null;
   ProcessInTbl = Null;
   ParamProcess = TParamProcessSlowEvent( Str_Param + ";3"); //установить статусы 3
   //установка статуса в uTableProcessIn_dbt
   ProcessInTbl = c_usr_tbl_uTableProcessIn();
   ProcessInTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
   ProcessInTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   ProcessInTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
   if( not ProcessInTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
      state = 1;
   end;
   ParamProcess = Null;
   ProcessInTbl = Null;
   //установка статуса в uTableProcessIn_dbt


   if( SOFR_LoadRuData(@error) ) //выполнение функций загрузки RuData
      ParamProcess = Null;
      ProcessInTbl = Null;
      ParamProcess = TParamProcessSlowEvent( Str_Param + ";4"); //установить статусы 4
      //установка статуса в uTableProcessIn_dbt
      ProcessInTbl = c_usr_tbl_uTableProcessIn();
      ProcessInTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
      ProcessInTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
      ProcessInTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
      if( not ProcessInTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
         state = 1;
      end;
      ParamProcess = Null;
      ProcessInTbl = Null;
      //установка статуса в uTableProcessIn_dbt

   end;
   return state;

onError(err)
   ParamProcess = Null;
   ProcessInTbl = Null;
//   state = 1;
//   return state;

//shev записываем текст ошибки в funcobj
   v_FuncObjResult.errorText = error;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = 42;
   return v_FuncObjResult;

end;


/*-------------------------------------------------------------------*/
/* Передача из СОФР запроса на получение курсов валют и драгметаллов */
/*-------------------------------------------------------------------*/
macro ws_SOFR_GetCurrencyRate( Str_Param )
   var v_req_obj : object,
       v_resp_obj,
       ParamProcess,
       ProcessEventTbl : c_usr_tbl_uTableProcessEvent,
       state : integer = 0,
       errortext : string = "",
       RequestText,
       ResponseText,
       v_transformator,
       v_answer,
       v_logger_obj,
       v_log_id,
       v_save_processor,
       xml_str,
       v_answer_data;
   var err_txt;
   var  v_FuncObjResult:FuncObjResult;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   ParamProcess = Null;
   ProcessEventTbl = Null;
   v_req_obj = Null;
//   ParamProcess = c_prm_proc_cur_rate(Str_Param + ";" + "3" + ";" + strsubst( string(date), " ", "0" ) + ";2"); //установить статусы 2
   /* 20190404 - Загружаем курсы за следующую дату */
   ParamProcess = c_prm_proc_cur_rate(Str_Param + ";" + "3" + ";" + strsubst( string(date() + 1), " ", "0" ) + ";2"); //установить статусы 2
   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
   ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
   if( not ProcessEventTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
    state = 1;
   end;
   ProcessEventTbl = Null;

   v_req_obj = c_GetCurrencyRate_req(ParamProcess);

   v_transformator = c_secur_msg_converter();
   RequestText = v_transformator.m_secur_external_req(v_req_obj);
   v_logger_obj = uws_exchng_logger(null,
                                    null,
                                    XmlRpcRequestId(),
                                    "ws_SOFR_GetCurrencyRate",
                                    modulename(),
                                    ParamProcess.RecId,
                                    RequestText);
   v_log_id = v_logger_obj.get_log_id();

   v_answer = SubmitRequestToWS( 2,                 // ИД очереди.
                                 "",                // ИД сообщения.
                                 "",                // Идентификатор Бэк Офиса. (не обрабатывается).
                                 true,              // Признак синхронной обработки. Если не указан, = False
                                 "0000",            /*1,*/ // Подразделение системы-назначения.
                                 7,                 // ИД типа данных
                                 RequestText,       // Бизнес данные в виде XML.
                                 string(ParamProcess.RecId, "-", v_log_id) // 20181229 - kva - Передаем id из utableprocessevent_dbt
                                 );
   if (v_answer.ResultCode == 0)
      xml_str = v_answer.responsetext;
      v_logger_obj.add_response(xml_str); 
   else 
      v_logger_obj.add_error_info(v_answer.ResultCode, v_answer.ResultText);
   end;

   v_transformator = NULL;
   if (xml_str)
      /* Преобразуем ответ в объектный вид - begin */
      v_transformator = c_secur_msg_converter();
      if(not v_transformator.m_decode_escaped_char(xml_str))
         RunError(v_transformator.get_service_msg(), c_usr_err_obj(v_transformator.get_service_msg()));
      end;
      v_answer_data = v_transformator.m_secur_wol_internal_req(v_transformator.get_pure_msg());
      /* Преобразуем ответ в объектный вид - end */

      if(ValType(v_answer_data) == V_UNDEF)
         err_txt = "Не удалось преобразовать XML в объект";
         RunError(err_txt, c_usr_err_obj(err_txt)); 
      end;
      
      v_resp_obj = c_adp_GetCurrencyRateResponse(v_answer_data);
      /* Сохранение полученных курсов в БД - begin */
//      if(v_resp_obj.IsResult)
         v_save_processor = c_save_rate_currency(v_req_obj, v_resp_obj);
//      end;
      /* Сохранение полученных курсов в БД - end */
   end;


//по !!!! не успешному результату сообщить в почту 
//по !!!! не успешному результату сообщить в почту

   //установка статуса в uTableProcessEvent_dbt
   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   if(v_resp_obj.IsResult)
      ProcessEventTbl.New_Val_Obj.T_STATUS = 4;
   else
      ProcessEventTbl.New_Val_Obj.T_STATUS = 5;
   end;
   ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
   if( not ProcessEventTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
    state = 1;
   end;

   ParamProcess = Null;
   ProcessEventTbl = Null;
   v_req_obj = Null;


   return state;

onError(err)
   ParamProcess = Null;
   ProcessEventTbl = Null;
   v_req_obj = Null;
//   state = 1;
//   return state;

//shev записываем текст ошибки в funcobj
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;

end; /* macro ws_SOFR_GetCurrencyRate() */


/*
/*----------------------------------------------*/
/* Обновление статуса записи в заданной таблице */
/*----------------------------------------------*/
/* Актуально для следующих таблиц:              */
/*    - utableprocessevent_dbt                  */
/*    - utableprocessout_dbt                    */
/*    - utableprocessin_dbt                     */
/*----------------------------------------------*/
macro m_upd_status_table(p_recid, p_table_name, p_status)
   var v_ret = true;
   var v_sql, v_cmd;

   v_sql = string("UPDATE ", p_table_name, " ");
   v_sql = v_sql + "  SET t_status = :p_status ";
   v_sql = v_sql + "WHERE t_recid = :p_recid ";

   v_cmd = RSDCommand(v_sql);
   v_cmd.addParam("p_status", RSDBP_IN, p_status);
   v_cmd.addParam("p_recid", RSDBP_IN, p_recid);
   v_cmd.execute();

   v_cmd.close(); v_cmd = NULL; v_sql = NULL;

   return v_ret;

onError(err)
   v_ret = false;
   return v_ret;
end;
*/


/*-----------------------------------------------------*/
/* Обновление статуса записей в utableprocessevent_dbt */
/*-----------------------------------------------------*/
macro m_upd_event_table_status(p_objectid, p_objecttype, p_status_old, p_status_new)
   var v_ret = 0;
   var v_sql, v_cmd;

   v_sql =         "DECLARE ";
   v_sql = v_sql + "    v_obj_id   NUMBER(10) := :p_objectid; ";
   v_sql = v_sql + "    v_obj_type NUMBER(10) := :p_objecttype; ";
   v_sql = v_sql + "    v_stat_old NUMBER(10) := :p_status_old; ";
   v_sql = v_sql + "    v_ret NUMBER(5) := 0; ";
   v_sql = v_sql + "BEGIN ";
   v_sql = v_sql + "    BEGIN ";
   v_sql = v_sql + "        SELECT t_objectid, t_objecttype ";
   v_sql = v_sql + "          INTO v_obj_id, v_obj_type ";
   v_sql = v_sql + "          FROM utableprocessevent_dbt ";
   v_sql = v_sql + "         WHERE t_objecttype = v_obj_type ";
   v_sql = v_sql + "           AND t_objectid = v_obj_id ";
   v_sql = v_sql + "           AND t_status = v_stat_old ";
   v_sql = v_sql + "           AND ROWNUM = 1; ";

   v_sql = v_sql + "        UPDATE utableprocessevent_dbt ";
   v_sql = v_sql + "           SET t_status = :p_stat_new ";
   v_sql = v_sql + "         WHERE t_objecttype = v_obj_type ";
   v_sql = v_sql + "           AND t_objectid = v_obj_id ";
   v_sql = v_sql + "           AND t_status = v_stat_old; ";
   v_sql = v_sql + "        COMMIT; ";

   v_sql = v_sql + "    EXCEPTION ";
   v_sql = v_sql + "        WHEN NO_DATA_FOUND ";
   v_sql = v_sql + "        THEN ";
   v_sql = v_sql + "            v_ret := 1; "; /* Не найдено записи с заданным t_recid */
   v_sql = v_sql + "        WHEN OTHERS ";
   v_sql = v_sql + "        THEN ";
   v_sql = v_sql + "            v_ret := 2; "; /* Не удалось обновить запись */
   v_sql = v_sql + "            ROLLBACK; ";
   v_sql = v_sql + "    END; ";

   v_sql = v_sql + "    :p_result := v_ret; ";
   v_sql = v_sql + "END; ";

   v_cmd = RSDCommand(v_sql);
   v_cmd.addParam("p_objectid", RSDBP_IN, p_objectid);
   v_cmd.addParam("p_objecttype", RSDBP_IN, p_objecttype);
   v_cmd.addParam("p_status_old", RSDBP_IN, p_status_old);
   v_cmd.addParam("p_stat_new", RSDBP_IN, p_status_new);
   v_cmd.addParam("p_result", RSDBP_OUT, V_INTEGER);
   v_cmd.execute();

   v_cmd.close(); v_cmd = NULL; v_sql = NULL;

   return v_ret;

onError(err)
   v_ret = 3; /* Непредвиденная ошибка */
   return v_ret;
end; /* macro m_upd_event_table_status() */


macro ws_SOFR_ContractBOTransfer_in(p_recid)
   const C_SOFR_CONTRBO = 9;
   const C_STATUS_PROC = 3;
   const C_STATUS_NEW = 1;
   const C_STATUS_NEW_OK = 4;
   const C_STATUS_NEW_ERR = 5;
   const C_STATUS_EVNT_PRC = 2;
   const C_TRANSFER_MODULE = "RSHB_TableDepoProc";
   const C_TRANSFER_FUNC = "m_dias_depo_data_load";

   var  v_FuncObjResult:FuncObjResult;
   var v_ret = 0;
   var v_sql, v_cmd, v_rs;
   var v_stat;
   var attempts, attempts_sql, attempts_def, stat, attempts_upd;
   var AttrDepo, err, tmp;
   /* Поиск результатов обработки переданных договоров брокерского обслуживания. */
   /* Проверка наличия записи в utableprocessin_dbt (ObjectType = 9, status = 2) */
   v_sql =         "SELECT contractid, contractnumber, resulttext, ";
   v_sql = v_sql + "       DECODE(resultcode, chr(0), '0', chr(1), '0', '', '0', resultcode) AS res_code ";
   v_sql = v_sql + "  FROM sofr_contractboresult tbl_res ";
   v_sql = v_sql + " WHERE EXISTS(SELECT t_recid ";
   v_sql = v_sql + "                FROM utableprocessin_dbt ";
   v_sql = v_sql + "               WHERE t_recid = :p_recid ";
   v_sql = v_sql + "                 AND t_objecttype = :p_objecttype ";
   v_sql = v_sql + "                 AND t_status = :p_status_p) ";

   v_cmd = RSDCommand(v_sql);
   v_cmd.addParam("p_recid", RSDBP_IN, p_recid);
   v_cmd.addParam("p_objecttype", RSDBP_IN, C_SOFR_CONTRBO);
   v_cmd.addParam("p_status_p", RSDBP_IN, C_STATUS_PROC);

   v_rs = RSDRecordSet(v_cmd);
   while(v_rs.movenext())
      if(v_rs.value("res_code") == "0")
         v_stat = m_upd_event_table_status(v_rs.value("contractid"), C_SOFR_CONTRBO, C_STATUS_EVNT_PRC, C_STATUS_NEW_OK);

         /*ZY по требованию Федотова отправка уведомления в депозитарий производится только после удачной выгрузки*/
         var rs_c1 ="  SELECT sf.t_number, sf.t_datebegin, part.t_shortname                       " +
                    "   FROM ddlcontr_dbt  dl                                                     " +
                    "        JOIN dsfcontr_dbt sf ON dl.T_SFCONTRID = sf.T_ID                     " +
                    "        JOIN dparty_dbt part ON sf.T_PARTYID = part.T_PARTYID                " +
                    "  WHERE     dl.T_DLCONTRID = :contrid                                        " +
                    "        AND EXISTS                                                           " +
                    "                (SELECT 1                                                    " +
                    "                   FROM ddlcontrmp_dbt  dl1                                  " +
                    "                        JOIN dsfcontr_dbt sf1 ON dl1.T_SFCONTRID = sf1.T_ID  " +
                    "                  WHERE dl1.T_DLCONTRID = :contrid1 AND sf1.T_SERVKIND = 1)  " ;
         rs_c1 = RSDCommand(rs_c1);
         rs_c1.addParam("contrid", RSDBP_IN, v_rs.value("contractid"));
         rs_c1.addParam("contrid1", RSDBP_IN, v_rs.value("contractid"));
         rs_c1 = RSDRecordSet (rs_c1);

         if (rs_c1.movenext() )    // фондовый рынок
            tmp = int(v_rs.value("contractid"));
            GetMainObjAttr(err, 207, string(tmp:34:o), 180, AttrDepo);
            if (AttrDepo != 1)
               if (AttrDepo == 2)
                  DisconnectObjAttr(207, string(tmp:34:o), 180, 0);
                  ConnectObjAttr(err, 207, string(tmp:34:o), 180, 1);


               else
                  var v_email = c_email_proc_env();
                 
                  var emailText = "Информируем о заключении брокерского соглашения ("+
                                                rs_c1.value(0)+" от "+              
                                                string(date(rs_c1.value(1)))+")_"+                  
                                                rs_c1.value(2);
                  v_email.m_set_msg_head(emailText);
                  v_email.m_add_row_to_msg_text(emailText);
                  v_email.m_save_to_submit_grp(CONTRACT_EMAIL_GRP, true);
                  v_email.m_submit_email_synch();
                  ConnectObjAttr(err, 207, string(tmp:34:o), 180, 1);

                  // BIQ-7031
                  var ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
                  ProcessEventTbl.New_Val_Obj.T_STATUS = 2;
                  ProcessEventTbl.New_Val_Obj.T_OBJECTTYPE = 99;
                  ProcessEventTbl.New_Val_Obj.T_OBJECTID = tmp;
                  ProcessEventTbl.New_Val_Obj.T_TYPE = -1;
                  ProcessEventTbl.New_Val_Obj.T_TIMESTAMP = dttm(date(), time());
                  ProcessEventTbl.New_Val_Obj.T_NOTE = "Признак нового договора, для уведомления для Депозитария";
                  ProcessEventTbl.Insert() 
                  // BIQ-7031

               end;
            end;
         end;
      elif (v_rs.value("res_code") == "1")
         /*ZY: Добавлен счетчик перезапуска ивента*/
         attempts_sql =" SELECT nvl(t_attempts, 0)              "+
                       "  FROM utableprocessevent_dbt           "+
                       " WHERE     t_objecttype = :objecttype   "+
                       "       AND t_objectid = :objectid       "+
                       "       AND t_status = :status           "+
                       "       AND ROWNUM = 1                   ";
         attempts_sql = RSDCommand(attempts_sql);
         attempts_sql.addParam("objecttype", RSDBP_IN, C_SOFR_CONTRBO);
         attempts_sql.addParam("objectid", RSDBP_IN, v_rs.value("contractid"));
         attempts_sql.addParam("status", RSDBP_IN, C_STATUS_EVNT_PRC);
         attempts_sql = RSDRecordSet(attempts_sql);
         if (attempts_sql.movenext());
            attempts = attempts_sql.value(0);
                                                                                                               
            GetRegistryValue("РСХБ\ИНТЕГРАЦИЯ\CONTR_REPEAT", V_INTEGER, attempts_def, stat);
            if (stat>0)
               attempts_def = 5;
            end;
           
            if (attempts <= attempts_def)
               v_stat = m_upd_event_table_status(v_rs.value("contractid"), C_SOFR_CONTRBO, C_STATUS_EVNT_PRC, C_STATUS_NEW);
               attempts = attempts + 1;
               attempts_upd ="  UPDATE utableprocessevent_dbt       "+
                         "    SET t_attempts = :attempts         "+
                            "  WHERE     t_objecttype = :objecttype "+
                            "        AND t_objectid = :objectid     "+
                            "        AND t_status = :status         "+
                            "        AND ROWNUM = 1                 ";
               attempts_upd = RSDCommand(attempts_upd);
               attempts_upd.addParam("attempts", RSDBP_IN, attempts);
               attempts_upd.addParam("objecttype", RSDBP_IN, C_SOFR_CONTRBO);
               attempts_upd.addParam("objectid", RSDBP_IN, v_rs.value("contractid"));
               attempts_upd.addParam("status", RSDBP_IN, C_STATUS_NEW);
               attempts_upd.execute();
            else
               v_stat = m_upd_event_table_status(v_rs.value("contractid"), C_SOFR_CONTRBO, C_STATUS_EVNT_PRC, C_STATUS_NEW_ERR);
            end;
          end;
      else
         v_stat = m_upd_event_table_status(v_rs.value("contractid"), C_SOFR_CONTRBO, C_STATUS_EVNT_PRC, C_STATUS_NEW_ERR);
         /* !!! - TODO: отправка писем с ошибками из Диасофта */
      end;
      rs_c1 = NULL;  attempts_upd = null; attempts_sql = null; tmp = AttrDepo = null; 
      /* !!! - TODO: отправка писем с ошибками */
      if(v_stat == 1)
         /* Запись не найдена среди выгруженных */
      elif(v_stat == 2)
         /* Не удалось обновить запись */
      elif(v_stat == 3)
         /* Непредвиденная ошибка */
      end;
   end;

   v_rs.close(); v_cmd.close(); v_rs = NULL; v_cmd = NULL; v_sql = NULL;

   if(not m_upd_table_proc_in_status(p_recid, C_STATUS_NEW_OK))
      v_stat = 1;
   end;

   return v_ret;

onError(err)
   m_upd_table_proc_in_status(p_recid, C_STATUS_NEW_ERR);
//   v_stat = 1;
//   return v_stat;
  
//shev записываем текст ошибки в funcobj
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;
   
end; /* macro ws_SOFR_ContractBOTransfer_in() */


/*--------------------------------------------------------------------------*/
/* Формирование информации о договорах брокерского обслуживания для Диасофт */
/*--------------------------------------------------------------------------*/
macro ws_SOFR_ContractBOTransfer(Str_Param)
   const C_SOFR_CONTRBO = 9;
   const C_EVENT_STAT_NEW = 1;
   const C_EVENT_STAT_PRC = 2;
   const C_PROC_OUT_ARCH = 4;
   const C_PROC_OUT_ERR = 5;
   const C_TRANSFER_MODULE = "RSHB_TableIns_CntrBO";
   const C_TRANSFER_FUNC = "m_prep_cntrBO_to_transfer";

   var v_state = 0;
   var v_aux_cntr;
   var v_sql, v_cmd, v_rs;
   var v_objid_list = TArray;
   var v_recid_list = TArray;
   var v_recid_prms;
   var v_proc_param;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   v_proc_param = c_prm_proc_contrBO_result(Str_Param);

   if(v_proc_param.ProcessType > 0)
      /* Выборка id договоров */
      v_sql =         "SELECT tbl_evnt.t_recid, tbl_evnt.t_timestamp, tbl_evnt.t_objecttype, ";
      v_sql = v_sql + "       tbl_evnt.t_objectid, tbl_evnt.t_status ";
      v_sql = v_sql + "  FROM utableprocessevent_dbt tbl_evnt ";
      /* На всякий случай проверяем еще раз есть ли не завершенные потоки выгрузки */
      v_sql = v_sql + " WHERE NOT EXISTS (SELECT tbl_out.t_recid ";
      v_sql = v_sql + "                     FROM utableprocessout_dbt tbl_out ";
      v_sql = v_sql + "                    WHERE tbl_out.t_objecttype = :p_objecttype_o ";
      v_sql = v_sql + "                      AND tbl_out.t_status NOT IN (:p_status_o1, :p_status_o2)) ";
      v_sql = v_sql + "   AND tbl_evnt.t_objecttype = :p_objecttype_e ";
      v_sql = v_sql + "   AND tbl_evnt.t_status = :p_status_e ";
      v_sql = v_sql + " ORDER BY tbl_evnt.t_recid ASC "; /* Для выборки максимального и минимального значения */

      v_cmd = RSDCommand(v_sql);
      v_cmd.addParam("p_objecttype_o", RSDBP_IN, C_SOFR_CONTRBO);
      v_cmd.addParam("p_status_o1", RSDBP_IN, C_PROC_OUT_ARCH);
      v_cmd.addParam("p_status_o2", RSDBP_IN, C_PROC_OUT_ERR);
      v_cmd.addParam("p_objecttype_e", RSDBP_IN, C_SOFR_CONTRBO);
      v_cmd.addParam("p_status_e", RSDBP_IN, C_EVENT_STAT_NEW);

      v_rs = RSDRecordSet(v_cmd);
      while(v_rs.movenext())
         v_recid_list.value(v_recid_list.size) = v_rs.value("t_recid");

         v_objid_list.value(v_objid_list.size) = v_rs.value("t_objectid");
      end;

      v_rs.close(); v_cmd.close(); v_rs = NULL; v_cmd = NULL; v_sql = NULL;

      /* Формирование информации для выгрузки в Диасофт */
      if(v_objid_list.size > 0)
         /* Чтобы не перегружать макрос импортами */
         ExecMacroFile(C_TRANSFER_MODULE, C_TRANSFER_FUNC, v_objid_list);

         v_aux_cntr = 0;
         v_recid_prms = string(v_recid_list.value(v_aux_cntr));
         v_aux_cntr = v_aux_cntr + 1;

         while(v_aux_cntr < v_recid_list.size)
            v_recid_prms = string(v_recid_prms, ",", v_recid_list.value(v_aux_cntr));
            v_aux_cntr = v_aux_cntr + 1;
         end;

         /* Изменение статусов и создание исходящего потока выгрузки */
         v_sql =         "BEGIN ";
         /* Вставляем запись в utableprocessout_dbt сразу с t_status = 2 */
         v_sql = v_sql + "    INSERT INTO utableprocessout_dbt ";
         v_sql = v_sql + "                (t_objecttype, t_timestamp, t_status) ";
         v_sql = v_sql + "         VALUES (:p_objecttype_o, sysdate, :p_status_o); ";
         /* Обновляем статусы событий */
         v_sql = v_sql + "    UPDATE utableprocessevent_dbt ";
         v_sql = v_sql + "       SET t_status = :p_status_e ";
         v_sql = v_sql + "     WHERE t_recid IN (" + v_recid_prms + "); ";
         v_sql = v_sql + "EXCEPTION ";
         v_sql = v_sql + "    WHEN OTHERS ";
         v_sql = v_sql + "    THEN ";
         v_sql = v_sql + "        ROLLBACK; ";
         v_sql = v_sql + "END; ";

         v_cmd = RSDCommand(v_sql);
         v_cmd.addParam("p_objecttype_o", RSDBP_IN, C_SOFR_CONTRBO);
         v_cmd.addParam("p_status_o", RSDBP_IN, C_EVENT_STAT_PRC);
         v_cmd.addParam("p_status_e", RSDBP_IN, C_EVENT_STAT_PRC);
         v_cmd.execute();
      end;
   else
      v_state = ws_SOFR_ContractBOTransfer_in(v_proc_param.RecId);
   end;

   return v_state;

onError(err)
   v_state = 1;
   return v_state;
end; /* macro ws_SOFR_ContractBOTransfer() */


/*--------------------------------------------*/
/* Загрузка данных по договорам и счетам ДЕПО */
/*--------------------------------------------*/
macro ws_SOFR_DEPOAccLoad(Str_Param)
   const C_SOFR_DEPOACC = 10;
   const C_PROC_STAT_NEW = 1;
   const C_PROC_STAT_READY = 2;
   const C_PROC_STAT_PROC = 3;
   const C_PROC_STAT_ARCH = 4;
   const C_PROC_STAT_ERR = 5;
   const C_TRANSFER_MODULE = "RSHB_TableDepoProc";
   const C_TRANSFER_FUNC = "m_dias_depo_data_load";

   var v_state = 0;
   var v_sql, v_cmd, v_rs;
   var v_sql_upd, v_cmd_upd;
   var v_proc_param;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   /* Объект используется один и тот же */
   v_proc_param = c_prm_proc_contrBO_result(Str_Param);

   v_sql =         "SELECT t_recid, t_objecttype, t_status ";
   v_sql = v_sql + "  FROM utableprocessin_dbt ";
   v_sql = v_sql + " WHERE t_objecttype = :p_objecttype ";
   v_sql = v_sql + "   AND t_status = :p_status ";

   v_cmd = RSDCommand(v_sql);
   v_cmd.addParam("p_objecttype", RSDBP_IN, C_SOFR_DEPOACC);
   v_cmd.addParam("p_status", RSDBP_IN, C_PROC_STAT_PROC);

   v_rs = RSDRecordSet(v_cmd);
   if(v_rs.movenext())
      /* Чтобы не перегружать макрос импортами */
      ExecMacroFile(C_TRANSFER_MODULE, C_TRANSFER_FUNC);

      v_sql_upd =             "DECLARE ";
      v_sql_upd = v_sql_upd + "    v_obj_type        NUMBER(10) := :p_obj_type; ";
      v_sql_upd = v_sql_upd + "    v_recid_in        NUMBER(10) := :p_recid_in; ";
      v_sql_upd = v_sql_upd + "    v_recid_out       NUMBER(10); ";
      v_sql_upd = v_sql_upd + "    v_recid_res       NUMBER(10); ";
      v_sql_upd = v_sql_upd + "    v_proc_stat_ready NUMBER(10) := :p_proc_stat_ready; ";
      v_sql_upd = v_sql_upd + "    v_proc_stat_new   NUMBER(10); ";
      v_sql_upd = v_sql_upd + "    v_proc_stat_arch  NUMBER(10) := :p_proc_stat_arch; ";
      v_sql_upd = v_sql_upd + "    v_proc_stat_err   NUMBER(10) := :p_proc_stat_err; ";
      v_sql_upd = v_sql_upd + "    v_proc_stat_open  NUMBER(10) := :p_proc_stat_open; ";
      v_sql_upd = v_sql_upd + "    v_ret             NUMBER(5) := 0; ";
      v_sql_upd = v_sql_upd + "BEGIN ";
      v_sql_upd = v_sql_upd + "    BEGIN ";
      v_sql_upd = v_sql_upd + "        SELECT recid ";
      v_sql_upd = v_sql_upd + "          INTO v_recid_res ";
      v_sql_upd = v_sql_upd + "          FROM sofr_contaccdeporesult ";
      v_sql_upd = v_sql_upd + "         WHERE ((resultcode IS NOT NULL AND resultcode <> '0') ";
      v_sql_upd = v_sql_upd + "                OR resulttext IS NOT NULL) ";
      v_sql_upd = v_sql_upd + "           AND ROWNUM = 1; ";

      v_sql_upd = v_sql_upd + "    EXCEPTION ";
      v_sql_upd = v_sql_upd + "        WHEN OTHERS ";
      v_sql_upd = v_sql_upd + "        THEN ";
      v_sql_upd = v_sql_upd + "            v_recid_res := 0; ";
      v_sql_upd = v_sql_upd + "    END; ";

      v_sql_upd = v_sql_upd + "    IF v_recid_res = 0 ";
      v_sql_upd = v_sql_upd + "    THEN ";
      v_sql_upd = v_sql_upd + "        v_proc_stat_new := v_proc_stat_arch; ";
      v_sql_upd = v_sql_upd + "    ELSE ";
      v_sql_upd = v_sql_upd + "        v_proc_stat_new := v_proc_stat_err; ";
      v_sql_upd = v_sql_upd + "    END IF; ";

      v_sql_upd = v_sql_upd + "    BEGIN ";
      v_sql_upd = v_sql_upd + "        UPDATE utableprocessin_dbt ";
      v_sql_upd = v_sql_upd + "           SET t_status = v_proc_stat_new ";
      v_sql_upd = v_sql_upd + "         WHERE t_recid = v_recid_in; ";

      v_sql_upd = v_sql_upd + "        UPDATE utableprocessout_dbt ";
      v_sql_upd = v_sql_upd + "           SET t_status = v_proc_stat_ready ";
      v_sql_upd = v_sql_upd + "         WHERE t_recid IN (SELECT t_recid ";
      v_sql_upd = v_sql_upd + "                             FROM utableprocessout_dbt ";
      v_sql_upd = v_sql_upd + "                            WHERE t_objecttype = v_obj_type ";
      v_sql_upd = v_sql_upd + "                              AND t_status = v_proc_stat_open); ";
      v_sql_upd = v_sql_upd + "        COMMIT; ";

      v_sql_upd = v_sql_upd + "    EXCEPTION ";
      v_sql_upd = v_sql_upd + "        WHEN OTHERS ";
      v_sql_upd = v_sql_upd + "        THEN ";
      v_sql_upd = v_sql_upd + "            ROLLBACK; ";
      v_sql_upd = v_sql_upd + "            v_ret := 1; ";
      v_sql_upd = v_sql_upd + "    END; ";

      v_sql_upd = v_sql_upd + "    :p_result := v_ret; ";
      v_sql_upd = v_sql_upd + "END; ";

      v_cmd_upd = RSDCommand(v_sql_upd);
      v_cmd_upd.addParam("p_obj_type", RSDBP_IN, C_SOFR_DEPOACC);
      v_cmd_upd.addParam("p_recid_in", RSDBP_IN, v_proc_param.RecId);
      v_cmd_upd.addParam("p_proc_stat_ready", RSDBP_IN, C_PROC_STAT_READY);
      v_cmd_upd.addParam("p_proc_stat_arch", RSDBP_IN, C_PROC_STAT_ARCH);
      v_cmd_upd.addParam("p_proc_stat_err", RSDBP_IN, C_PROC_STAT_ERR);
      v_cmd_upd.addParam("p_proc_stat_open", RSDBP_IN, C_PROC_STAT_NEW);
      v_cmd_upd.addParam("p_result", RSDBP_OUT, V_INTEGER);
      v_cmd_upd.execute();

      if(v_cmd_upd.value("p_result") != 0)
         v_state = 1;
      end;

      v_cmd_upd.close(); v_cmd_upd = NULL; v_sql_upd = NULL;
   else
      v_state = 1;
   end;

   v_rs.close(); v_cmd.close(); v_rs = NULL; v_cmd = NULL; v_sql = NULL;

   return v_state;

onError(err)
   v_state = 1;
   return v_state;
end; /* macro ws_SOFR_DEPOAccLoad() */


/*----------------------------------------------------------------*/
/*            Сверка остатков депо                                */
/*----------------------------------------------------------------*/   
macro ws_SOFR_DEPOAccRevise(Str_Param)
   const C_SOFR_DEPORevise = 11;
   const C_STATUS_PROC = 3;
   const C_STATUS_ARCH = 4;
   const C_STATUS_ERR = 5;

   var v_state = 0;
   var v_result;
   var v_proc_param;
   var v_sql, v_cmd, v_rs;
   var v_sql_upd, v_cmd_upd, v_rs_upd;
   var  v_FuncObjResult:FuncObjResult;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   /* Объект используется один и тот же */
   v_proc_param = c_prm_proc_contrBO_result(Str_Param);

   v_sql =         "SELECT t_recid, t_objecttype, t_status ";
   v_sql = v_sql + "  FROM utableprocessin_dbt ";
   v_sql = v_sql + " WHERE t_recid = :p_recid ";
   v_sql = v_sql + "   AND t_objecttype = :p_objecttype ";
   v_sql = v_sql + "   AND t_status = :p_status ";

   v_cmd = RSDCommand(v_sql);
   v_cmd.addParam("p_recid", RSDBP_IN, v_proc_param.RecId);
   v_cmd.addParam("p_objecttype", RSDBP_IN, C_SOFR_DEPORevise);
   v_cmd.addParam("p_status", RSDBP_IN, C_STATUS_PROC);

   v_rs = RSDRecordSet(v_cmd);
   if(v_rs.movenext())
       
      ExecMacroFile("depo_verification_DIAS.mac", "chekdata");
      /*v_result = */

      v_sql_upd =             "UPDATE utableprocessin_dbt ";
      v_sql_upd = v_sql_upd + "   SET t_status = :p_status_new ";
      v_sql_upd = v_sql_upd + " WHERE t_recid = :p_recid ";

      v_cmd_upd = RSDCommand(v_sql_upd);
      /*if(v_result ==)*/
      v_cmd_upd.addParam("p_status_new", RSDBP_IN, C_STATUS_ARCH);
      /* В ФТ используется только статус 4 */
      /*
      else
      v_cmd_upd.addParam("p_status_new", RSDBP_IN, C_STATUS_ERR);
      end;
      */
      v_cmd_upd.addParam("p_recid", RSDBP_IN, v_proc_param.RecId);

      v_cmd_upd.execute();

      v_cmd_upd.close(); v_cmd_upd = NULL; v_sql_upd = NULL;
   end;

   v_rs.close(); v_cmd.close(); v_rs = NULL; v_cmd = NULL; v_sql = NULL;

   return v_state;

onError(err)
//   v_state = 1;
//   return v_state;

//shev записываем текст ошибки в funcobj
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;
end; /* macro ws_SOFR_DEPOAccRevise() */

macro ws_Event_PKL( Str_Param )
   // статусы таблицы событий, у таблиц ProcessOut/ProcessIn немного другие статусы
   const C_STATUS_NEW = 1;
   const C_STATUS_READY = 2;
   const C_STATUS_RUNNING = 3;
   const C_STATUS_OK = 4;
   const C_STATUS_ERROR = 5;

   var ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
       ProcessOutTbl : c_usr_tbl_uTableProcessOut,
       ParamProcess :TParamProcessSlowEvent,
       state :integer = 0;
       var  v_FuncObjResult:FuncObjResult;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   ParamProcess = Null;
   ProcessEventTbl = Null;

   ParamProcess = TParamProcessSlowEvent( Str_Param ); 

   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.New_Val_Obj.T_STATUS = C_STATUS_READY;
   ProcessEventTbl.New_Val_Obj.T_LASTUPDATE = dttm(date(), time());;
   ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   if( not ProcessEventTbl.Update() )
      state = 1;
   end;
   ProcessEventTbl = null;

// Поскольку данные в общей таблице не транкейтятся перед заполнением, проверку на наличие записей 
//  в uTableProcessoOut_dbt со статусом 2 не производим
   if (state == 0)
      ExecMacroFile("SOFR_PKL_Start.mac", "SOFR_PKL_Start");
      //установка статуса в uTableProcessoOut_dbt
      ProcessOutTbl = c_usr_tbl_uTableProcessOut();
      ProcessOutTbl.New_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
      ProcessOutTbl.New_Val_Obj.T_STATUS = 2;
      var ddt = dttm(date, time);
      ProcessOutTbl.New_Val_Obj.T_TIMESTAMP = ddt;
      if( not ProcessOutTbl.Insert() )
         state = 1;
      end;
   end;

   if (state == 0)
      //установка статуса в uTableProcessEvent_dbt
      ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
      ProcessEventTbl.New_Val_Obj.T_STATUS = C_STATUS_OK;
      ProcessEventTbl.New_Val_Obj.T_TIMESTAMP = dttm(date(), time());;
      ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
      if( not ProcessEventTbl.Update() )
         state = 1;
      end;
   end;

   ParamProcess = Null;
   ProcessEventTbl = Null;
   ProcessOutTbl = Null;
   return state;

onError(err)
   ParamProcess = Null;
   ProcessEventTbl = Null;
//   state = 1;
//   return state;

//shev записываем текст ошибки в funcobj
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;

end;

//выгрузка МБК ЦХД сделочная модель
macro ws_Event_CHD( Str_Param )
   var ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
       ProcessOutTbl : c_usr_tbl_uTableProcessOut,
       ParamProcess :TParamProcessSlowEvent,
       state :integer = 0;
   var v_sql, v_cmd, v_rs;
   var v_email_processor;
   var CV_EMAIL_GRP_CHD = 1;
   var in_id, in_id_pre, sql1;
   var  v_FuncObjResult:FuncObjResult;
   private var sql_err; 
   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;


   ParamProcess = Null;
   ProcessEventTbl = Null;
   ParamProcess = TParamProcessSlowEvent( Str_Param + ";4"); //установить статусы 4
   v_sql =         "DECLARE ";
   v_sql = v_sql + "    PRAGMA autonomous_transaction; "; /* Для записи лога внутри транзакции */
   v_sql = v_sql + "    v_recid   NUMBER(10) := :p_recid; ";
   v_sql = v_sql + "BEGIN ";
   v_sql = v_sql + "UPDATE utableprocessevent_dbt ";
   v_sql = v_sql + "   SET t_status = 2 ";
   v_sql = v_sql + " WHERE t_recid = v_recid; ";
   v_sql = v_sql + " commit; ";
   v_sql = v_sql + "    END; ";
   v_cmd = RSDCommand(v_sql);
   v_cmd.addParam("p_recid", RSDBP_IN, ParamProcess.RecId);
   v_cmd.execute();
   v_cmd.close(); v_cmd = NULL; v_sql = NULL;




   //проверяем наличие записей в utableprocessout_dbt с типом 15 и статусом отличным от 4
   //если такие записи есть, то пишем письма мелким почерком. В противном случае делаем выгрузку.
   v_sql =         "SELECT t_recid, t_objecttype, t_status ";
   v_sql = v_sql + "  FROM utableprocessout_dbt ";
   v_sql = v_sql + " WHERE t_objecttype = 15 ";
   v_sql = v_sql + "   AND t_status < 4 ";

   v_cmd = RSDCommand(v_sql);

   v_rs = RSDRecordSet(v_cmd);

   if(v_rs.movenext())

      v_email_processor = c_email_proc_env();
      v_email_processor.m_set_msg_head("СОФР - Выгрузка в ЦХД");
      v_email_processor.m_add_row_to_msg_text("Выгрузка невозможна.Одна из предыдущих задач не завершена. (ws_synch_SOFR.mac 1931), recid = " + string(v_rs.value("t_recid")));
      v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_CHD, true);
//      v_email_processor.m_save_to_submit();
      v_email_processor.m_submit_email();

      ParamProcess = TParamProcessSlowEvent( Str_Param + ";4"); //установить статусы 4
      //установка статуса в uTableProcessEvent_dbt
      ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
      ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
      ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
      ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
      if( not ProcessEventTbl.Update() )
         state = 1;
      end;

      return state;
   end;


   //Создание записи в uTableProcessOut_dbt
   ProcessOutTbl = c_usr_tbl_uTableProcessOut();
   ProcessOutTbl.New_Val_Obj.T_OBJECTTYPE = 15;
   ProcessOutTbl.New_Val_Obj.T_STATUS = 1;
   var ddt = dttm(date, time);
   ProcessOutTbl.New_Val_Obj.T_TIMESTAMP = ddt;
   if( not ProcessOutTbl.Insert() )
      state = 1;
   end;

   //находим ид текущей выгрузки
   sql1 = ExecSqlSelect("select t_recid from utableprocessout_dbt where t_objecttype =15 and t_status = 1");
   sql1.movenext();
   in_id = sql1.value(0);
   sql1 = null;

   //Находим ид предыдущей выгрузки
   sql1 = ExecSqlSelect("select t_recid from utableprocessout_dbt where t_objecttype = 15 and t_status =4 and  t_timestamp = (select max(t_timestamp) from utableprocessout_dbt where t_objecttype = 15 and t_status =4)");
   sql1.movenext();
   in_id_pre = sql1.value(0);
   sql1 = null;

   execSQL ("begin qb_dwh_export.export_all(trunc(sysdate), to_char(:in_id), to_char(:in_id_pre)); end;", makeArray(SqlParam("in_id", in_id ),SqlParam("in_id_pre", in_id_pre )));

   ParamProcess = TParamProcessSlowEvent( Str_Param + ";4"); //установить статусы 4
 
   //установка статуса в uTableProcessEvent_dbt
   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
   ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
   if( not ProcessEventTbl.Update() )
      state = 1;
   end;
   //Проверка ошибок выгрузки, если есть ошибки - считаем выгрузку некорректной
   sql_err = ExecSqlSelect( " select err.t_errcode,err.t_errmsg, err.t_is_critical,ev.t_timestamp,trunc(ev.t_timestamp)  "+
                            "  from dqb_bp_event_dbt ev                                                                  "+
                            "  inner join DQB_BP_EVENT_ERROR_DBT err on err.T_IDEVENT = EV.T_ID                          "+
                            "  where ev.t_value = :in_id                                                                 ",
                            makeArray(SqlParam("in_id", in_id )));
   if (sql_err.movenext())
      ProcessOutTbl.New_Val_Obj.T_OBJECTTYPE = 15;
      ProcessOutTbl.New_Val_Obj.T_STATUS = 5;
      ddt = dttm(date, time);
      ProcessOutTbl.New_Val_Obj.T_TIMESTAMP = ddt;
      ProcessOutTbl.Where_Val_Obj.t_objecttype = 15;
      ProcessOutTbl.Where_Val_Obj.T_status = 1;
      if( not ProcessOutTbl.Update() )
         state = 1;
      end;
   
      v_email_processor = c_email_proc_env();
      v_email_processor.m_set_msg_head("СОФР - Ошибка выгрузки в ЦХД");
      v_email_processor.m_add_row_to_msg_text("Во время выгрузки возникли ошибки. Требуется проверить логи по выгрузке id = " + in_id );
      v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_CHD, true);
//      v_email_processor.m_save_to_submit();
      v_email_processor.m_submit_email();
   else
      //Апдейт записи в uTableProcessOut_dbt
      ProcessOutTbl.New_Val_Obj.T_OBJECTTYPE = 15;
      ProcessOutTbl.New_Val_Obj.T_STATUS = 2;
      ddt = dttm(date, time);
      ProcessOutTbl.New_Val_Obj.T_TIMESTAMP = ddt;
      ProcessOutTbl.Where_Val_Obj.t_objecttype = 15;
      ProcessOutTbl.Where_Val_Obj.T_status = 1;
      if( not ProcessOutTbl.Update() )
         state = 1;
      end;
   end;

   ParamProcess = Null;
   ProcessEventTbl = Null;
   ProcessOutTbl = Null;
                  

   return state;

onError(err)
      v_email_processor = c_email_proc_env();
      v_email_processor.m_set_msg_head("СОФР - Ошибка выгрузки в ЦХД");
      v_email_processor.m_add_row_to_msg_text("Ошибка выгрузки. Проверьте процедуру выгрузки ORACLE.");
      v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_CHD, true);
//      v_email_processor.m_save_to_submit();
      v_email_processor.m_submit_email();


      //установка статуса в uTableProcessEvent_dbt
      ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
      ProcessEventTbl.New_Val_Obj.T_STATUS = 5;
      ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
      ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
      ProcessEventTbl.Update();

   ParamProcess = Null;
   ProcessEventTbl = Null;
//   state = 1;
//   return state;

//shev записываем текст ошибки в funcobj
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;

end;

//выгрузка МБК ЦХД ценные бумаги
macro ws_Event_CHD_SEC( Str_Param )
   var ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
       ProcessOutTbl : c_usr_tbl_uTableProcessOut,
       ParamProcess :TParamProcessSlowEvent,
       state :integer = 0;
   var v_sql, v_cmd, v_rs;
   var v_email_processor;
   var CV_EMAIL_GRP_CHD = 1;
   var in_id, sql1;
   var ddt;
   private var sql_err; 
   var  v_FuncObjResult:FuncObjResult;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   ParamProcess = ProcessEventTbl = Null;
   ParamProcess = TParamProcessSlowEvent( Str_Param + ";2"); 
   v_sql =         "DECLARE ";
   v_sql = v_sql + "    PRAGMA autonomous_transaction; "; /* Для записи лога внутри транзакции */
   v_sql = v_sql + "    v_recid   NUMBER(10) := :p_recid; ";
   v_sql = v_sql + "BEGIN ";
   v_sql = v_sql + "UPDATE utableprocessevent_dbt ";
   v_sql = v_sql + "   SET t_status = 2, t_note = 'Установка статуса=2 на время выгрузки в '||to_char(sysdate, 'dd.mm.yyyy HH24:MI:SS') ";  
   v_sql = v_sql + " WHERE t_recid = v_recid; ";
   v_sql = v_sql + " commit; ";
   v_sql = v_sql + "    END; ";
   v_cmd = RSDCommand(v_sql);
   v_cmd.addParam("p_recid", RSDBP_IN, ParamProcess.RecId);
   v_cmd.execute();
   v_cmd.close(); v_cmd = NULL; v_sql = NULL;

   //проверяем наличие записей в utableprocessout_dbt с типом 16 и статусом отличным от 4
   //если такие записи есть, то пишем письма мелким почерком. В противном случае делаем выгрузку.
   v_sql =         "SELECT t_recid, t_objecttype, t_status ";
   v_sql = v_sql + "  FROM utableprocessout_dbt ";
   v_sql = v_sql + " WHERE t_objecttype = 16 ";
   v_sql = v_sql + "   AND t_status < 4 ";

   v_cmd = RSDCommand(v_sql);
   v_rs = RSDRecordSet(v_cmd);

   if(v_rs.movenext())

      v_email_processor = c_email_proc_env();
      v_email_processor.m_set_msg_head("СОФР - Выгрузка в ЦХД ценные бумаги");
      v_email_processor.m_add_row_to_msg_text("Выгрузка невозможна. Одна из предыдущих задач не завершена. (ws_synch_SOFR.mac 2083  sec)");
      v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_CHD, true);
//      v_email_processor.m_save_to_submit();
      v_email_processor.m_submit_email();

      ParamProcess = TParamProcessSlowEvent( Str_Param + ";5"); 
      //установка статуса в uTableProcessEvent_dbt
      ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
      ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
      ProcessEventTbl.New_Val_Obj.T_RESULTTEXT = "Выгрузка невозможна.Одна из предыдущих задач не завершена";
      ProcessEventTbl.New_Val_Obj.T_LASTUPDATE = dttm(date, time);
      ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
      ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
      if( not ProcessEventTbl.Update() )
         state = 1;
      end;
      return state;
   end;


   //Создание записи в uTableProcessOut_dbt
   ProcessOutTbl = c_usr_tbl_uTableProcessOut();
   ProcessOutTbl.New_Val_Obj.T_OBJECTTYPE = 16;
   ProcessOutTbl.New_Val_Obj.T_STATUS = 1;
   ProcessOutTbl.New_Val_Obj.T_RESULTTEXT = "Начало выгрузки. ProcessEventTbl.T_RECID = " + ParamProcess.RecId;
   ProcessOutTbl.New_Val_Obj.T_TIMESTAMP = dttm(date, time);
   if( not ProcessOutTbl.Insert() )
      return 1;
   end;

   //находим ид текущей выгрузки
   sql1 = ExecSqlSelect("select t_recid from utableprocessout_dbt where t_objecttype =16 and t_status = 1");
   sql1.movenext();
   in_id = sql1.value(0);
   sql1 = null;

   execSQL ("begin qb_dwh_export_secur.runexport(trunc(sysdate),:in_id); end;", makeArray(SqlParam("in_id", in_id )));

   //Проверка ошибок выгрузки, если есть ошибки - считаем выгрузку некорректной
   sql_err = ExecSqlSelect( " select err.t_errcode, err.t_errmsg, err.t_is_critical, ev.t_timestamp, trunc(ev.t_timestamp)  "+
                            "  from dqb_bp_event_dbt ev                                                                     "+
                            "  inner join dqb_bp_event_error_dbt err on err.t_idevent = ev.t_id                             "+
                            "  where ev.t_value = :in_id and err.t_is_critical < 2                                          ",
                            makeArray(SqlParam("in_id", in_id )));
   if (sql_err.movenext())
      ParamProcess = TParamProcessSlowEvent( Str_Param + ";5"); //установить статусы 4
      //установка статуса в uTableProcessEvent_dbt
      ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
      ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
      ProcessEventTbl.New_Val_Obj.T_NOTE = string("Во время выгрузки возникли ошибки. ProcessEventTbl.T_RECID = " + ParamProcess.RecId + " в ", dttm(date, time));
      ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
      ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
      if( not ProcessEventTbl.Update() )
        v_FuncObjResult.errorText = string("Во время выгрузки возникли ошибки. ProcessEventTbl.T_RECID = " + ParamProcess.RecId + " в ", dttm(date, time));
        v_FuncObjResult.state = 2;  
        v_FuncObjResult.errorCode = 15;
        return v_FuncObjResult;
      end;

      ProcessOutTbl.New_Val_Obj.T_OBJECTTYPE = 16;
      ProcessOutTbl.New_Val_Obj.T_STATUS = 5;
      ProcessOutTbl.New_Val_Obj.T_TIMESTAMP = dttm(date, time);
      ProcessOutTbl.New_Val_Obj.T_RESULTTEXT = string("Во время выгрузки возникли ошибки. ProcessEventTbl.T_RECID = " + ParamProcess.RecId + " в ", dttm(date, time));
      ProcessOutTbl.Where_Val_Obj.t_objecttype = 16;
      ProcessOutTbl.Where_Val_Obj.T_status = 1;
      ProcessOutTbl.Where_Val_Obj.t_recid = in_id;
      if( not ProcessOutTbl.Update() )
        v_FuncObjResult.errorText = string("Во время выгрузки возникли ошибки. ProcessEventTbl.T_RECID = " + ParamProcess.RecId + " в ", dttm(date, time));
        v_FuncObjResult.state = 2;  
        v_FuncObjResult.errorCode = 15;
        return v_FuncObjResult;
      end;
   
      v_email_processor = c_email_proc_env();
      v_email_processor.m_set_msg_head("СОФР - Ошибка выгрузки в ЦХД");
      v_email_processor.m_add_row_to_msg_text("Во время выгрузки возникли ошибки. Требуется проверить логи по выгрузке id = " + in_id );
      v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_CHD, true);
//      v_email_processor.m_save_to_submit();
      v_email_processor.m_submit_email();

//shev записываем текст ошибки в funcobj
      v_FuncObjResult.errorText = "Во время выгрузки возникли ошибки. Требуется проверить логи по выгрузке id = " + in_id ;
      v_FuncObjResult.state = 2;  
      v_FuncObjResult.errorCode = 15;
      return v_FuncObjResult;

   else
      ParamProcess = TParamProcessSlowEvent( Str_Param + ";4"); //установить статусы 4
      //установка статуса в uTableProcessEvent_dbt
      ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
      ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
      ProcessEventTbl.New_Val_Obj.T_RESULTTEXT = string("Успешное завершение ProcessEventTbl.T_RECID = " + ParamProcess.RecId + " в ", dttm(date, time));
      ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
      ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
      if( not ProcessEventTbl.Update() )
        v_FuncObjResult.errorText = string("Во время выгрузки возникли ошибки. ProcessEventTbl.T_RECID = " + ParamProcess.RecId + " в ", dttm(date, time));
        v_FuncObjResult.state = 2;  
        v_FuncObjResult.errorCode = 15;
        return v_FuncObjResult;
      end;

      //Апдейт записи в uTableProcessOut_dbt
      ProcessOutTbl.New_Val_Obj.T_OBJECTTYPE = 16;
      ProcessOutTbl.New_Val_Obj.T_STATUS = 2;
      ProcessOutTbl.New_Val_Obj.T_TIMESTAMP = dttm(date, time);
      ProcessOutTbl.New_Val_Obj.T_RESULTTEXT = "Успешное завершение ProcessEventTbl.T_RECID = " + ParamProcess.RecId;
      ProcessOutTbl.Where_Val_Obj.t_objecttype = 16;
      ProcessOutTbl.Where_Val_Obj.T_status = 1;
      ProcessOutTbl.Where_Val_Obj.t_recid = in_id;
      if( not ProcessOutTbl.Update() )
        v_FuncObjResult.errorText = string("Во время выгрузки возникли ошибки. ProcessEventTbl.T_RECID = " + ParamProcess.RecId + " в ", dttm(date, time));
        v_FuncObjResult.state = 2;  
        v_FuncObjResult.errorCode = 15;
        return v_FuncObjResult;
      end;
   end;

   ParamProcess = ProcessEventTbl = ProcessOutTbl = Null;

   return state;

onError(err)
      v_email_processor = c_email_proc_env();
      v_email_processor.m_set_msg_head("СОФР - Ошибка выгрузки в ЦХД ценные бумаги");
      v_email_processor.m_add_row_to_msg_text("Ошибка выгрузки. Проверьте процедуру выгрузки ORACLE.");
      v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_CHD, true);
      v_email_processor.m_submit_email();

      //установка статуса в uTableProcessEvent_dbt
      ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
      ProcessEventTbl.New_Val_Obj.T_STATUS = 1;  //повтор через 15 минут
      ProcessEventTbl.New_Val_Obj.T_RESULTTEXT = "Ошибка выгрузки onError. " + err.message + " " + err.module + " строка " + err.line;
      ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
      ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
      ProcessEventTbl.Update();

      if ( (Valtype(in_id) != V_UNDEF) and (Valtype(in_id) != 26) )
        //Апдейт записи в uTableProcessOut_dbt
        ProcessOutTbl.New_Val_Obj.T_OBJECTTYPE = 16;
        ProcessOutTbl.New_Val_Obj.T_STATUS = 5;
        ddt = dttm(date, time);
        ProcessOutTbl.New_Val_Obj.T_TIMESTAMP = ddt;
        ProcessOutTbl.New_Val_Obj.T_RESULTTEXT = "Ошибка выгрузки onError. " + err.message + " " + err.module + " строка " + err.line;
        ProcessOutTbl.Where_Val_Obj.t_objecttype = 16;
        ProcessOutTbl.Where_Val_Obj.T_status = 1;
        ProcessOutTbl.Where_Val_Obj.t_recid = in_id;
        ProcessOutTbl.Update();
      end; 

   ParamProcess = ProcessEventTbl = Null;

//shev записываем текст ошибки в funcobj
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 2;  
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;

end;

//выгрузка в ЦХД сделок по ПФИ
macro ws_Event_CHD_PFI( Str_Param )
   var ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
       ProcessOutTbl : c_usr_tbl_uTableProcessOut,
       ParamProcess :TParamProcessSlowEvent,
       state :integer = 0;
   var v_sql, v_cmd, v_rs;
   var v_email_processor;
   var CV_EMAIL_GRP_CHD = 1;
   var in_id, in_id_pre, sql1;
   var ddt;
   private var sql_err; 
   var  v_FuncObjResult:FuncObjResult;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   ParamProcess = ProcessEventTbl = Null;
   ParamProcess = TParamProcessSlowEvent( Str_Param + ";2"); // статус 2
   v_sql =         "DECLARE ";
   v_sql = v_sql + "    PRAGMA autonomous_transaction; "; /* Для записи лога внутри транзакции */
   v_sql = v_sql + "    v_recid   NUMBER(10) := :p_recid; ";
   v_sql = v_sql + "BEGIN ";
   v_sql = v_sql + "UPDATE utableprocessevent_dbt ";
   v_sql = v_sql + "   SET t_status = 2, t_resulttext = '', t_note = 'Временная установка статуса = 2 в '||to_char(sysdate, 'dd.mm.yyyy HH:MI:SS'), t_lastupdate = sysdate ";
   v_sql = v_sql + " WHERE t_recid = v_recid; ";
   v_sql = v_sql + " commit; ";
   v_sql = v_sql + "    END; ";
   v_cmd = RSDCommand(v_sql);
   v_cmd.addParam("p_recid", RSDBP_IN, ParamProcess.RecId);
   v_cmd.execute();
   v_cmd.close(); v_cmd = NULL; v_sql = NULL;

   //проверяем наличие записей в utableprocessout_dbt с типом 28 и статусом отличным от 4
   //если такие записи есть, то пишем письма мелким почерком. В противном случае делаем выгрузку.
   v_sql =         "SELECT t_recid, t_objecttype, t_status ";
   v_sql = v_sql + "  FROM utableprocessout_dbt ";
   v_sql = v_sql + " WHERE t_objecttype = 28 ";
   v_sql = v_sql + "   AND t_status < 4 ";

   v_cmd = RSDCommand(v_sql);
   v_rs = RSDRecordSet(v_cmd);
   if(v_rs.movenext())
      v_email_processor = c_email_proc_env();
      v_email_processor.m_set_msg_head("СОФР - Выгрузка в ЦХД ценные бумаги");
      v_email_processor.m_add_row_to_msg_text("Выгрузка невозможна.Одна из предыдущих задач не завершена. (ws_synch_SOFR.mac 2326  pfi)");
      v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_CHD, true);
      v_email_processor.m_submit_email();

      ParamProcess = TParamProcessSlowEvent( Str_Param + ";5"); //установить статусы 4
      //установка статуса в uTableProcessEvent_dbt
      ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
      ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
      ProcessEventTbl.New_Val_Obj.T_RESULTTEXT = "Ошибка - в таблице utableprocessout_dbt имеются незавершенные задачи";
      ProcessEventTbl.New_Val_Obj.T_LASTUPDATE = dttm(date, time);
      ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
      ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
      if( not ProcessEventTbl.Update() )
        v_FuncObjResult.errorText = string("Во время выгрузки возникли ошибки. ProcessEventTbl.T_RECID = " + ParamProcess.RecId + " в ", dttm(date, time));
        v_FuncObjResult.state = 2;  //отказ от повтора в funcobj
        v_FuncObjResult.errorCode = 15;
        return v_FuncObjResult;
      end;
      v_FuncObjResult.errorText = string("Ошибка - в таблице utableprocessout_dbt имеются незавершенные задачи. ProcessEventTbl.T_RECID = " + ParamProcess.RecId + " в ", dttm(date, time));
      v_FuncObjResult.state = 2;  //отказ от повтора в funcobj
      v_FuncObjResult.errorCode = 15;
      return v_FuncObjResult;
   end;

   //Создание записи в uTableProcessOut_dbt
   ProcessOutTbl = c_usr_tbl_uTableProcessOut();
   ProcessOutTbl.New_Val_Obj.T_OBJECTTYPE = 28;
   ProcessOutTbl.New_Val_Obj.T_STATUS = 1;
   ProcessOutTbl.New_Val_Obj.T_RESULTTEXT = "Начало выгрузки. ProcessEventTbl.T_RECID = " + ParamProcess.RecId;
   ddt = dttm(date, time);
   ProcessOutTbl.New_Val_Obj.T_TIMESTAMP = ddt;
   if( not ProcessOutTbl.Insert() )
     v_FuncObjResult.errorText = string("Во время выгрузки возникли ошибки. ProcessEventTbl.T_RECID = " + ParamProcess.RecId + " в ", dttm(date, time));
     v_FuncObjResult.state = 2;  //отказ от повтора в funcobj
     v_FuncObjResult.errorCode = 15;
     return v_FuncObjResult;
   end;

   //находим ид текущей выгрузки
   sql1 = ExecSqlSelect("select t_recid from utableprocessout_dbt where t_objecttype =28 and t_status = 1");
   sql1.movenext();
   in_id = sql1.value(0);
   sql1 = null;

/*Для выгрузи по ценным бумагам не актуально пока, оставляю на всякий случай, если сильно мешает - можно удалить
   //Находим ид предыдущей выгрузки
   sql1 = ExecSqlSelect("select t_recid from utableprocessout_dbt where t_objecttype = 28 and t_status =4 and  t_timestamp = (select max(t_timestamp) from utableprocessout_dbt where t_objecttype = 15 and t_status =4)");
   sql1.movenext();
   in_id_pre = sql1.value(0);
   sql1 = null;
*/

   execSQL ("begin qb_dwh_export_pfi.runexport(trunc(sysdate),:in_id); end;", makeArray(SqlParam("in_id", in_id )));

   //Проверка ошибок выгрузки, если есть ошибки - считаем выгрузку некорректной

   sql_err = ExecSqlSelect( " select err.t_errcode, err.t_errmsg, err.t_is_critical, ev.t_timestamp, trunc(ev.t_timestamp)  "+
                            "  from dqb_bp_event_dbt ev                                                                     "+
                            "  inner join dqb_bp_event_error_dbt err on err.t_idevent = ev.t_id                             "+
                            "  where ev.t_value = :in_id and err.t_is_critical < 2                                          ",
                            makeArray(SqlParam("in_id", in_id )));
   if (sql_err.movenext())
      ProcessOutTbl.New_Val_Obj.T_OBJECTTYPE = 28;
      ProcessOutTbl.New_Val_Obj.T_STATUS = 5;
      ProcessOutTbl.New_Val_Obj.T_TIMESTAMP = dttm(date, time);
      ProcessOutTbl.New_Val_Obj.T_RESULTTEXT = "Во время выгрузки возникли ошибки. ProcessEventTbl.T_RECID = " + ParamProcess.RecId;
      ProcessOutTbl.Where_Val_Obj.t_objecttype = 28;
      ProcessOutTbl.Where_Val_Obj.T_status = 1;
      ProcessOutTbl.Where_Val_Obj.t_recid = in_id;
      if( not ProcessOutTbl.Update() )
        v_FuncObjResult.errorText = string("Во время выгрузки возникли ошибки. ProcessEventTbl.T_RECID = " + ParamProcess.RecId + " в ", dttm(date, time));
        v_FuncObjResult.state = 2;  //отказ от повтора в funcobj
        v_FuncObjResult.errorCode = 15;
        return v_FuncObjResult;
      end;
   
      v_email_processor = c_email_proc_env();
      v_email_processor.m_set_msg_head("СОФР - Ошибка выгрузки в ЦХД");
      v_email_processor.m_add_row_to_msg_text("Во время выгрузки возникли ошибки. Требуется проверить логи по выгрузке id = " + in_id );
      v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_CHD, true);
//      v_email_processor.m_save_to_submit();
      v_email_processor.m_submit_email();

      //установка статуса в uTableProcessEvent_dbt
      ParamProcess = TParamProcessSlowEvent( Str_Param + ";5"); //установить статусы 5
      ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
      ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
      ProcessEventTbl.New_Val_Obj.T_RESULTTEXT = string("Во время выгрузки возникли ошибки. ProcessEventTbl.T_RECID = " + ParamProcess.RecId + " в " + dttm(date, time));
      ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
      ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
      if( not ProcessEventTbl.Update() )
        v_FuncObjResult.errorText = string("Во время выгрузки возникли ошибки. ProcessEventTbl.T_RECID = " + ParamProcess.RecId + " в ", dttm(date, time));
        v_FuncObjResult.state = 2;  //отказ от повтора в funcobj
        v_FuncObjResult.errorCode = 15;
        return v_FuncObjResult;
      end;

      v_FuncObjResult.errorText = "Во время выгрузки возникли ошибки. Требуется проверить логи по выгрузке id = " + in_id ;
      v_FuncObjResult.state = 2;
      v_FuncObjResult.errorCode = 15;

      ParamProcess = ProcessEventTbl = ProcessOutTbl = Null;

      return v_FuncObjResult;

   else
// success 
      //Апдейт записи в uTableProcessOut_dbt
      ProcessOutTbl.New_Val_Obj.T_OBJECTTYPE = 28;
      ProcessOutTbl.New_Val_Obj.T_STATUS = 2;
      ProcessOutTbl.New_Val_Obj.T_TIMESTAMP = dttm(date, time);
      ProcessOutTbl.New_Val_Obj.T_RESULTTEXT = "Успешное завершение ProcessEventTbl.T_RECID = " + ParamProcess.RecId;
      ProcessOutTbl.Where_Val_Obj.t_objecttype = 28;
      ProcessOutTbl.Where_Val_Obj.T_status = 1;
      ProcessOutTbl.Where_Val_Obj.t_recid = in_id;
      if( not ProcessOutTbl.Update() )
         state = 1;
      end;

      ParamProcess = TParamProcessSlowEvent( Str_Param + ";4"); //установить статусы 4
      //установка статуса в uTableProcessEvent_dbt
      ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
      ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
      ProcessEventTbl.New_Val_Obj.T_RESULTTEXT = string("Успешное завершение выгрузки. ProcessEventTbl.T_RECID = " + ParamProcess.RecId + " в " + dttm(date, time));
      ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
      ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
      if( not ProcessEventTbl.Update() )
        state = 1;
     end;

   end;

   ParamProcess = ProcessEventTbl = ProcessOutTbl = Null;
   return state;

onError(err)
      v_email_processor = c_email_proc_env();
      v_email_processor.m_set_msg_head("СОФР - Ошибка выгрузки в ЦХД сделок по ПФИ");
      v_email_processor.m_add_row_to_msg_text("Ошибка выгрузки. Проверьте процедуру выгрузки ORACLE.");
      v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_CHD, true);
      v_email_processor.m_submit_email();


      //установка статуса в uTableProcessEvent_dbt
      ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
      ProcessEventTbl.New_Val_Obj.T_STATUS = 1;  // повтор попытки через 15 минут. Прерывание этого цикла произойдет через сутки
      ProcessEventTbl.New_Val_Obj.T_RESULTTEXT = "Ошибка выгрузки onError. " + err.message + " " + err.module + " строка " + err.line;
      ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
      ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
      ProcessEventTbl.Update();

      if ( (Valtype(in_id) != V_UNDEF) and (Valtype(in_id) != 26) )
        //Апдейт записи в uTableProcessOut_dbt
        ProcessOutTbl.New_Val_Obj.T_OBJECTTYPE = 28;
        ProcessOutTbl.New_Val_Obj.T_STATUS = 5;
        ddt = dttm(date, time);
        ProcessOutTbl.New_Val_Obj.T_TIMESTAMP = ddt;
        ProcessOutTbl.New_Val_Obj.T_RESULTTEXT = "Ошибка выгрузки onError. " + err.message + " " + err.module + " строка " + err.line;
        ProcessOutTbl.Where_Val_Obj.t_objecttype = 28;
        ProcessOutTbl.Where_Val_Obj.T_status = 1;
        ProcessOutTbl.Where_Val_Obj.t_recid = in_id;
        ProcessOutTbl.Update();
      end; 

   ParamProcess = ProcessEventTbl = ProcessOutTbl = Null;

//shev записываем текст ошибки в funcobj
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 2;  //отказ от залпа из 6 повторов funcobj DCV 02.02.2023. 
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;

end;

//Обновление досье по договору на брокерское обслуживание данными из ИС СОФР
macro ws_SOFR_UpdateDossier( Str_Param )
   var res :object,
       ParamProcess :TParamUpdateDossier,
       ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
       state :integer = 0,
       errortext :string = "",
       RequestText,
       v_transformator,
       v_answer,
       v_logger_obj,
       v_log_id;
   var v_error;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;
   ParamProcess = TParamUpdateDossier( Str_Param + ";2"); //установить статусы 2

   res = UpdateDossierDepositoryInfoReq( ParamProcess.ObjectId, @v_error );

   if( Valtype(res) != V_UNDEF)
      v_transformator = c_secur_msg_converter();
      RequestText = v_transformator.m_secur_external_req(res);
      v_logger_obj = uws_exchng_logger(null,
                                       null,
                                       XmlRpcRequestId(),
                                       "UpdateDossierDepositoryInfoReq",
                                       modulename(),
                                       ParamProcess.RecId,
                                       RequestText);
      v_log_id = v_logger_obj.get_log_id();

      v_answer = SubmitRequestToWS( 2,                 // ИД очереди.
                                    "",                // ИД сообщения.
                                    "",                // Идентификатор Бэк Офиса. (не обрабатывается).
                                    false,/*true,*/    // Признак синхронной обработки. Если не указан, = False
                                    "0000",            /*1,*/ // Подразделение системы-назначения.
                                    15,                // ИД типа данных
                                    RequestText,       // Бизнес данные в виде XML.
                                    string(ParamProcess.RecId, "-", v_log_id) 
                                    );
      ParamProcess.ProcessStatus = 4;
   else
      v_logger_obj = uws_exchng_logger(null,
                                       null,
                                       XmlRpcRequestId(),
                                       "UpdateDossierDepositoryInfoReq",
                                       modulename(),
                                       ParamProcess.RecId,
                                       "Пустой текст");
      v_log_id = v_logger_obj.get_log_id();

      v_logger_obj.add_error_info(v_error.ErrorCode, 
                                  v_error.ErrorDesc);
      ParamProcess.ProcessStatus = 5;
   end;

   //установка статуса в uTableProcessEvent_dbt
   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
   ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
   if( not ProcessEventTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
      state = 1;
   end;
   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;
   //установка статуса в uTableProcessEvent_dbt

   return state;

onError(err)
   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;
   state = 1;
   return state;
end;
//Обновление досье по договору на брокерское обслуживание данными из ИС СОФР


//Отправка уведомления клиенту после установки категории = "Обработка завершена"
macro ws_SOFR_SendMessageBO( Str_Param )
   var res :object,
       ParamProcess :TParamUpdateDossier,
       ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
       state :integer = 0,
       errortext :string = "",
       RequestText,
       v_transformator,
       v_answer,
       v_logger_obj,
       v_log_id;
   var v_error;
   var AttrDepo, partyid, SKP_exist = false, term_pwd = true, new_depo = false, sql_str, cmd, rs;
   var  v_FuncObjResult:FuncObjResult, date_time;

   const CV_OBJ_TYPE_TEMP_PWD = 5024;
   const CV_OBJ_TYPE_QUIK = 5025;
   const CV_OBJ_TYPE_BROKER = 5026;

   const CONTRACT_CATEGORY_ISQUIK = 170;
   const DLCONTR_TYPE = 207;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;
   ParamProcess = TParamUpdateDossier( Str_Param + ";2"); //установить статусы 2

   new_depo = CheckContractForNovelty(ParamProcess.ObjectId);

   // BIQ-7033 проверка статуса регистрации на бирже
   var send_mes = true;
   var contr_str = "";
   sql_str = "select m.t_sendmesstate, s.t_number, s.t_datebegin, s.t_name, lower(EXTRACTVALUE(XMLType(m.t_respdata), '/MICEX_ERROR','xmlns=""http://www.moex.com/application/output""')) t_respdata, s.t_partyid "+
             "  from ddlcontrmsg_dbt m, ddlcontr_dbt d, dsfcontr_dbt s "+                                                     
             " where m.t_dlcontrid = d.t_dlcontrid and s.t_id = d.t_sfcontrid "+
             "   and  m.t_dlcontrid = :p_id and t_kind in (1,2) and t_isonlinesendmes = chr(88) and t_respdate > to_date('01.01.0001','dd.mm.yyyy') "+
             " order by t_senddate desc ";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("p_id", RSDBP_IN, ParamProcess.ObjectId);
   rs = RSDRecordSet(cmd);
   if (rs.movenext) 
      AddDBLogDebug("ws_SOFR_SendMessageBO",rs.value("t_sendmesstate"));//  добавим в itt def-83942
      partyid = rs.value("t_partyid");
      if (rs.value("t_sendmesstate") != 210) // последняя не успешная заявка
         // def-27825 SD8265368||545519||301398||Ошибка ММВБ. duplicate key value.. already exist (86 договоров)
         if ( ( (rs.value("t_sendmesstate") == 102) or (rs.value("t_sendmesstate") == 103) ) and  
              (Index( rs.value("t_respdata"), "duplicate") > 0) )
            send_mes = true;
         else 
            send_mes = false;
            contr_str = rs.value("t_number")+" от "+date(rs.value("t_datebegin"))+" "+rs.value("t_name");
         end;
      end;
   end;
   rs.close; cmd.close; rs = null; cmd = null; 

   if(send_mes == true)
     AddDBLogDebug("ws_SOFR_SendMessageBO", "send_mes_true");//  добавим в itt def-83942
   else
     AddDBLogDebug("ws_SOFR_SendMessageBO", "send_mes_False");
   end;

//BIQ-7833 проверим какой тип авторизации у клиента, для генерации временного пароля
   sql_str = "select t_attrid from dobjatcor_dbt where t_objecttype = :objecttype and t_object = lpad (:objectid, 34, '0') and t_groupid = :groupid and t_validtodate = to_date('31.12.9999','dd.mm.yyyy')";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("objecttype", RSDBP_IN, DLCONTR_TYPE);
   cmd.AddParam("objectid", RSDBP_IN, ParamProcess.ObjectId);
   cmd.AddParam("groupid", RSDBP_IN, CONTRACT_CATEGORY_ISQUIK);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
     if (rs.value("t_attrid") == 1)
         SKP_exist = true;
     end;
   end;
   rs.close; cmd.close; rs = null; cmd = null; 

   if(SKP_exist == true)
      AddDBLogDebug("ws_SOFR_SendMessageBO", "SKP_exist_true");//  добавим в itt def-83942
   else
      AddDBLogDebug("ws_SOFR_SendMessageBO", "SKP_exist_false");//  добавим в itt def-83942
   end;

//DEF-61434 проверка был ли выгружен клиент в торговые терминалы
   sql_str = "select 1 from utableprocessevent_dbt where t_objectid = :partyid and t_objecttype in (:quik,:broker) and t_type = 1 and t_status = 4 ";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("Partyid", RSDBP_IN, partyid);
   cmd.AddParam("quik", RSDBP_IN, CV_OBJ_TYPE_QUIK);
   cmd.AddParam("broker", RSDBP_IN, CV_OBJ_TYPE_BROKER);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
       term_pwd = false;
   end;
   rs.close; cmd.close; rs = null; cmd = null; 

   if(term_pwd == true)
      AddDBLogDebug("ws_SOFR_SendMessageBO", "term_pwd_true");//  добавим в itt def-83942
   else
      AddDBLogDebug("ws_SOFR_SendMessageBO", "term_pwd_false");//  добавим в itt def-83942
   end;

   if (send_mes) // или успешно отправлено, или не онлайн
      var pf = dboMessage(ParamProcess.ObjectId).CreateMessage(true,true,true, null,null,null, new_depo);
      if (pf.StatSend != 1)   // ошибка
   /* shev
         var v_email_processor = c_email_proc_env();
         var v_email_head =  "Ошибка автоматической отправки уведомления по договору "+
                          pf.NumberDBO+" "+pf.Prt_Fnam;           
         var v_email_body = v_email_head + ". " + pf.statMes + ". Необходимо отправить уведомление вручную";
         v_email_processor.m_set_msg_head(v_email_head);
         v_email_processor.m_add_row_to_msg_text(v_email_body);
         v_email_processor.m_save_to_submit_grp(CONTRACT_EMAIL_GRP, true);
         v_email_processor.m_submit_email_synch();      
   */
         ParamProcess.ProcessStatus = 5;
         v_error = pf.NumberDBO+" "+pf.Prt_Fnam + pf.statMes;
      else
         ParamProcess.ProcessStatus = 4;
         v_error = "OK";

         //BIQ-7833 генерируем временный пароль сразу после отправки уведомления
         if(term_pwd)
            if(not SKP_exist)
               m_make_event_to_process(CV_OBJ_TYPE_TEMP_PWD, Partyid);
            end;
         end;

         if (new_depo)
            FixEvent99(ParamProcess.ObjectId);
         end;
      end;
   else
      ParamProcess.ProcessStatus = 5;
      v_error = "Регистрация на биржевой площадке не в статусе 210";
   end;

   //установка статуса в uTableProcessEvent_dbt
   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
   ProcessEventTbl.New_Val_Obj.T_NOTE = v_error;
   ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   if( not ProcessEventTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
      state = 1;
   end;
   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;
   //установка статуса в uTableProcessEvent_dbt

//для случаев когда ошибка, но в onerror не попали
   if ((send_mes) and (v_error != "OK"))
      v_FuncObjResult.errorText = v_error;
      v_FuncObjResult.state = 1;
      return v_FuncObjResult;
   else
      return state;
   end;

onError(err)
   //установка статуса в uTableProcessEvent_dbt
   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.New_Val_Obj.T_STATUS = 5;
   ProcessEventTbl.New_Val_Obj.T_NOTE = err.code+" "+err.message +" Модуль: "+err.Module+" строка: "+err.Line;
   ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
   ProcessEventTbl.Update(); 

   AddDBLogDebug("ws_SOFR_SendMessageBO", ProcessEventTbl.New_Val_Obj.T_NOTE);//  добавим в itt def-83942

   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;
//   state = 1;
//   return state;

//shev записываем текст ошибки в funcobj
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;

end;
//Отправка уведомления клиенту после установки категории = "Обработка завершена"


//Отправка уведомления в АСОА после установки категории = "Обработка завершена"
macro ws_SOFR_UploadDocBO( Str_Param )
   var res :object,
       ParamProcess :TParamUpdateDossier,
       ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
       state :integer = 0,
       errortext :string = "";
   var v_FuncObjResult:FuncObjResult;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;
   ParamProcess = TParamUpdateDossier( Str_Param + ";2"); //установить статусы 2

   var sql_str = 
String(
 "DECLARE \n"
,"   v_Ret number(10); \n"
,"   v_status number(10); \n"
,"   v_dlid number(10) := :p_dlId;  \n"
,"BEGIN  \n"
,"   /* сформировано ли уведомление на договоре? */  \n"
,"   SELECT COUNT(1)  \n"
,"     INTO v_Ret \n"
,"     FROM Ddlcontrmsg_Dbt Msg, Dimgdata_Dbt Dim, Dimage_Dbt Dig \n"
,"    WHERE Dim.t_Objectid = Lpad(Msg.t_Id, 34, '0') \n"
,"      AND Dig.t_Imageid = Dim.t_Imageid \n"
,"      AND Msg.t_Kind = 500 \n"
,"      AND Msg.t_Dlcontrid = v_dlid; \n"
,"   /* не софрмировано, но может быть, есть необработанное событие 5207? */  \n"
,"   if v_Ret = 0 then  \n"
,"      begin \n"
,"         SELECT t_status INTO v_status \n"
,"           FROM utableprocessevent_dbt \n"
,"          WHERE t_objecttype = 5207 and t_objectid = v_dlid; \n"
,"         if v_status in (4,5) then /* событие было обработано, но раз сообщения нет, то оно и не появится */  \n"
,"            v_Ret := 0; \n"
,"         else  \n"
,"            v_Ret := -1; /* можно подождать */ \n"
,"         end if; \n"
,"      exception \n"
,"         when no_data_found then v_Ret := 0; \n"
,"      end; \n"
,"   end if; \n"
,"   :p_Ret := v_Ret; \n"
,"END;  \n"
);
   var cmd  = rsdcommand(sql_str);
   cmd.AddParam("p_dlId", RSDBP_IN, ParamProcess.ObjectId);
   cmd.AddParam("p_Ret", RSDBP_OUT, v_integer);
   cmd.execute;
   state = int(cmd.Value("p_Ret"));
   cmd = null;

   if (state < 0) // ничего не делаем, нужно подождать обработки 5207
      ParamProcess.ProcessStatus = 1;
      errortext = "Ожидание формирования уведомления на договоре";
   elif (state == 0) // сообщения нет
      ParamProcess.ProcessStatus = 5;
      errortext = "Нет сформированного уведомления на договоре";
   else 
      var ccf = PushUploadDoc( true, ParamProcess.ObjectId );
      if (ccf.ResultData.ResultCode != 0)  // ошибка
         ParamProcess.ProcessStatus = 5;
         errortext = ccf.ResultData.ErrorData.ErrorDesc;
      else
         ParamProcess.ProcessStatus = 4;
      end;
   end;
   state = 0;

   //установка статуса в uTableProcessEvent_dbt
   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
   ProcessEventTbl.New_Val_Obj.T_NOTE = errortext;
   ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
   if( not ProcessEventTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
      state = 1;
   end;
   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;
   //установка статуса в uTableProcessEvent_dbt

   return state;

onError(err)
   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;
//   state = 1;
//   return state;

//shev записываем текст ошибки в funcobj
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;
end;
//Отправка уведомления в АСОА после установки категории = "Обработка завершена"

//Передача из СОФР запроса на выгрузку проводок в файл
macro ws_SOFR_GetEntriesForVerify( Str_Param )
var res_obj :object,
    ParamProcess :TParamProcessEntriesVerify,
    ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
    state :integer = 0,
    errortext :string = "",
    RequestText,
    v_transformator,
    v_answer,
    v_logger_obj,
    v_log_id,
    ObjTypeId :integer = 0, // ИД типа данных справочник объектов SOFR
    FlPaym :bool = false,
    FlSyncAsync :bool = true,
    i :integer = 0;
    var  v_FuncObjResult:FuncObjResult;
var v_module_name = "GetEntriesForVerify";

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   ParamProcess = Null;
   ProcessEventTbl = Null;
   res_obj = Null;
   ParamProcess = TParamProcessEntriesVerify( Str_Param + ";2"); //установить статусы 2
   res_obj = GetEntriesForVerifyReq( ParamProcess.RecId );//создание запроса на выгрузку проводок в файл
   res_obj.GetEntriesForVerifyReqMsg.GetEntriesForVerifyReq.AddConditins( ParamProcess.DateIn, ParamProcess.DateOut );
   i = 0;
   while( ( ValType( uTryToGetPropS( ParamProcess, "AccEntries" ) ) != V_UNDEF ) and ( i < ParamProcess.AccEntries.Size ) )
    res_obj.GetEntriesForVerifyReqMsg.GetEntriesForVerifyReq.AddEntry( ParamProcess.AccEntries[i].PayerAccount, ParamProcess.AccEntries[i].ReceiverAccount );
    i = i + 1;
   end;

   ObjTypeId = 17;
/*  FlSyncAsync = true;*/
   FlSyncAsync = false;

   v_transformator = c_secur_msg_converter();
   RequestText = v_transformator.m_secur_external_req(res_obj);
   v_logger_obj = uws_exchng_logger(null,
                                    null,
                                    XmlRpcRequestId(),
                                    v_module_name,
                                    modulename(),
                                    ParamProcess.RecId,
                                    RequestText);
   v_log_id = v_logger_obj.get_log_id();
   v_answer = SubmitRequestToWS( 2,                 // ИД очереди.
                                 "",                // ИД сообщения.
                                 "",                // Идентификатор Бэк Офиса. (не обрабатывается).
                                 FlSyncAsync,       // Признак синхронной обработки. Если не указан, = False
                                 "0000",            /*1,*/ // Подразделение системы-назначения.
                                 ObjTypeId,         // ИД типа данных
                                 RequestText,       // Бизнес данные в виде XML.
                                 string(ParamProcess.RecId, "-", v_log_id) // 20181229 - kva - Передаем id из utableprocessevent_dbt
                                 );
 // v_logger_obj.add_response(v_answer);

//по !!!! не успешному результату сообщить в почту 
//по !!!! не успешному результату сообщить в почту

   //установка статуса в uTableProcessEvent_dbt
   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
   ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
   if( not ProcessEventTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
    state = 1;
   end;
   ParamProcess = Null;
   ProcessEventTbl = Null;
   res_obj = Null;
   //установка статуса в uTableProcessEvent_dbt

   return state;

onError(err)
   ParamProcess = Null;
   ProcessEventTbl = Null;
   res_obj = Null;
//   state = 1;
//   return state;

//shev записываем текст ошибки в funcobj
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;

end;


//Передача из СОФР запроса на выгрузку счетов в файл
macro ws_SOFR_GetAcctForVerify( Str_Param )
var res_obj :object,
    ParamProcess :TParamProcessAcctVerify,
    ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
    state :integer = 0,
    errortext :string = "",
    RequestText,
    v_transformator,
    v_answer,
    v_logger_obj,
    v_log_id,
    ObjTypeId :integer = 0, // ИД типа данных справочник объектов SOFR
    FlPaym :bool = false,
    FlSyncAsync :bool = true,
    i :integer = 0;

var v_module_name = "GetAcctForVerify";

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   ParamProcess = Null;
   ProcessEventTbl = Null;
   res_obj = Null;
   ParamProcess = TParamProcessAcctVerify( Str_Param + ";2"); //установить статусы 2
   res_obj = GetAcctForVerifyReq( ParamProcess.RecId );//создание запроса на выгрузку проводок в файл
   res_obj.GetAcctForVerifyReqMsg.GetAcctForVerifyReq.AddConditins( ParamProcess.RestDate );
   i = 0;
   while( ( ValType( uTryToGetPropS( ParamProcess, "Acct" ) ) != V_UNDEF ) and ( i < ParamProcess.Acct.Size ) )
    res_obj.GetAcctForVerifyReqMsg.GetAcctForVerifyReq.AddAcct( ParamProcess.Acct[i].Account );
    i = i + 1;
   end;

   ObjTypeId = 18;
/*  FlSyncAsync = true;*/
   FlSyncAsync = false;

   v_transformator = c_secur_msg_converter();
   RequestText = v_transformator.m_secur_external_req(res_obj);
   v_logger_obj = uws_exchng_logger(null,
                                    null,
                                    XmlRpcRequestId(),
                                    v_module_name,
                                    modulename(),
                                    ParamProcess.RecId,
                                    RequestText);
   v_log_id = v_logger_obj.get_log_id();
   v_answer = SubmitRequestToWS( 2,                 // ИД очереди.
                                 "",                // ИД сообщения.
                                 "",                // Идентификатор Бэк Офиса. (не обрабатывается).
                                 FlSyncAsync,       // Признак синхронной обработки. Если не указан, = False
                                 "0000",            /*1,*/ // Подразделение системы-назначения.
                                 ObjTypeId,         // ИД типа данных
                                 RequestText,       // Бизнес данные в виде XML.
                                 string(ParamProcess.RecId, "-", v_log_id) // 20181229 - kva - Передаем id из utableprocessevent_dbt
                                 );
 // v_logger_obj.add_response(v_answer);

//по !!!! не успешному результату сообщить в почту 
//по !!!! не успешному результату сообщить в почту

   //установка статуса в uTableProcessEvent_dbt
   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
   ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
   if( not ProcessEventTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
    state = 1;
   end;
   ParamProcess = Null;
   ProcessEventTbl = Null;
   res_obj = Null;
   //установка статуса в uTableProcessEvent_dbt

   return state;

onError(err)
   ParamProcess = Null;
   ProcessEventTbl = Null;
   res_obj = Null;
   state = 1;
   return state;

end;


//Передача из СОФР запроса на выгрузку счетов в файл
macro ws_SOFR_GetFileAcctForVerify( Str_Param )
var FileName :string = "",
    File_Path :string = "",
    Query :string = "",
    cmd,
    ParamProcess :object,
    ParamProcess_acc :object /*TParamProcessAcctVerify*/,
    ProcessInTbl :c_usr_tbl_uTableProcessIn,
    ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
    state :integer = 0,
    result_status = 5,
    errortext :string = "Неизвестная ошибка",
    EventReqId :integer = -1,
    res;
   const C_PROC_STAT_ARCH = 4;
   const C_PROC_STAT_ERR = 5;
var  v_FuncObjResult:FuncObjResult;
var state_load;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   ParamProcess = Null;
   ParamProcess_acc = Null;
   ProcessInTbl = Null;
   
   ParamProcess = TParamProcessSlowEvent( Str_Param + ";3"); //установить статусы 3

   AddItLog("ws_SOFR_GetFileAcctForVerify. Start, recID: " + string(ParamProcess.RecId) );

   //установка статуса в uTableProcessIn_dbt
   Query = " DECLARE " +
           "     v_state             NUMBER(5) := 0; " +
           "     v_ProcessStatus     utableprocessin_dbt.T_STATUS%TYPE := :p_ProcessStatus; " +
           "     v_RecId             utableprocessin_dbt.T_RECID%TYPE := :p_RecId; " +
           "     v_ObjectType        utableprocessin_dbt.T_OBJECTTYPE%TYPE := :p_ObjectType; " +
           " BEGIN " +
           "     BEGIN " +

           "         UPDATE utableprocessin_dbt " +
           "         SET T_STATUS = v_ProcessStatus " +
           "         WHERE T_RECID = v_RecId " +
           "          AND T_OBJECTTYPE = v_ObjectType; " +

           "         COMMIT; " +

           "     EXCEPTION " +
           "         WHEN OTHERS " +
           "         THEN " +
           "             v_state := 1; " +
           "             ROLLBACK; " +
           "     END; " +

           "     :p_state := v_state; " +
           " END; ";

   cmd = RSDCommand(Query);
   cmd.addParam("p_ProcessStatus", RSDBP_IN, ParamProcess.ProcessStatus);
   cmd.addParam("p_RecId", RSDBP_IN, ParamProcess.RecId);
   cmd.addParam("p_ObjectType", RSDBP_IN, ParamProcess.ObjectType);
   cmd.addParam("p_state", RSDBP_OUT, V_INTEGER);
   cmd.execute();

   state = cmd.value("p_state");

   cmd.close();
   cmd = NULL;
   Query = "";
   
   if (state == 0)
   else 
      errortext = "Ошибка установки статуса "+ParamProcess.ProcessStatus+" в utableprocessin_dbt";
      AddItLog("ws_SOFR_GetFileAcctForVerify. Error, recID: " + string(ParamProcess.RecId) ) + " " + errortext;
      v_FuncObjResult.errorText = errortext;
      v_FuncObjResult.state = 1;
      v_FuncObjResult.errorCode = -1001;
      return v_FuncObjResult;
   end;

   FileName = GetFileNameFromProcessIn( ParamProcess.RecId, @EventReqId );

   GetRegistryValue("РСХБ\\ИНТЕГРАЦИЯ\\ДИРЕКТОРИИ\\IMPORT\\ACCTCOMPAREDIR", V_STRING, File_Path);

   state_load = LoadAcctForCompare( File_Path + "\\" + FileName, string(EventReqId) );
   if (state_load)
      AddItLog("ws_SOFR_GetFileAcctForVerify. Файл CSV загружен, recID: " + string(ParamProcess.RecId) ) + " " + errortext;
   else
      errortext = String("Не выполнена загрузка файла: ", File_Path, "\\" + FileName);
      AddItLog("ws_SOFR_GetFileAcctForVerify. Error, recID: " + string(ParamProcess.RecId) ) + " " + errortext;
      v_FuncObjResult.errorText = errortext;
      v_FuncObjResult.state = 1;
      v_FuncObjResult.errorCode = -1001;
      return v_FuncObjResult;
   end;
      
   ParamProcess_acc = Null;
   ParamProcess_acc = TParamProcessAcctVerify( string( EventReqId )  + ";" +  "5008" + ";" + GetStrParamFromEvent( EventReqId )); 

   res = ExecMacroFile("uacctcompare_rep.mac", "AcctCompareRep", string(EventReqId), ParamProcess_acc, Null, @errortext );
   if( ( res ) or ( ValType(res) == V_UNDEF ) )
      result_status = C_PROC_STAT_ARCH;
      errortext = "";
   else 
      result_status = C_PROC_STAT_ERR;
   end;

   AddItLog("ws_SOFR_GetFileAcctForVerify. Finish, recID: " + string(ParamProcess.RecId) + ", state = " + string(result_status) + ", error = " + errortext);

   //установка статуса в uTableProcessEvent_dbt
   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.New_Val_Obj.T_STATUS = result_status;
   ProcessEventTbl.New_Val_Obj.T_NOTE = errortext;
   ProcessEventTbl.Where_Val_Obj.T_RECID = EventReqId;
   if( not ProcessEventTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
      state = 1;
   end;
   ParamProcess_acc = Null;
   ProcessEventTbl = Null;
   //установка статуса в uTableProcessEvent_dbt

   //установка статуса в uTableProcessIn_dbt
   ProcessInTbl = c_usr_tbl_uTableProcessIn();
   ProcessInTbl.New_Val_Obj.T_STATUS = result_status;
   ProcessInTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   if( not ProcessInTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
      state = 1;
   end;
   ParamProcess = Null;
   ProcessInTbl = Null;
   //установка статуса в uTableProcessIn_dbt

//по !!!! не успешному результату сообщить в почту 
//по !!!! не успешному результату сообщить в почту

   return state;

onError(err)
   ParamProcess = Null;
   ParamProcess_acc = Null;
   ProcessEventTbl = Null;
   ProcessInTbl = Null;
   
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;   
end;


//Передача из СОФР запроса на выгрузку проводок в файл
macro ws_SOFR_GetFileEntriesForVerify( Str_Param )
var FileName :string = "",
    File_Path :string = "",
    Query :string = "",
    cmd,
    ParamProcess :object,
    ParamProcess_acc :object /*TParamProcessAcctVerify*/,
    ProcessInTbl :c_usr_tbl_uTableProcessIn,
    ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
    state :integer = 0,
    result_status = 5,
    errortext :string = "Неизвестная ошибка",    
    RepMode :integer = RM_BASIC,
    EventReqId :integer = -1,
    res
    , i :integer, CntLoop = 2, x_Flag :integer = 1 // DEF-76687 загрузка файла по формату 1 (с доп.полями), если будет неудачно, то загрузка по формату 0
    ;

   const C_PROC_STAT_ARCH = 4;
   const C_PROC_STAT_ERR = 5;
var  v_FuncObjResult:FuncObjResult;
var state_load;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   ParamProcess = Null;
   ParamProcess_acc = Null;
   ProcessInTbl = Null;
   ParamProcess = TParamProcessSlowEvent( Str_Param + ";3"); //установить статусы 3

   //установка статуса в uTableProcessIn_dbt
   Query = " DECLARE " +
           "     v_state             NUMBER(5) := 0; " +
           "     v_ProcessStatus     utableprocessin_dbt.T_STATUS%TYPE := :p_ProcessStatus; " +
           "     v_RecId             utableprocessin_dbt.T_RECID%TYPE := :p_RecId; " +
           "     v_ObjectType        utableprocessin_dbt.T_OBJECTTYPE%TYPE := :p_ObjectType; " +
           " BEGIN " +
           "     BEGIN " +

           "         UPDATE utableprocessin_dbt " +
           "         SET T_STATUS = v_ProcessStatus " +
           "         WHERE T_RECID = v_RecId " +
           "          AND T_OBJECTTYPE = v_ObjectType; " +

           "         COMMIT; " +

           "     EXCEPTION " +
           "         WHEN OTHERS " +
           "         THEN " +
           "             v_state := 1; " +
           "             ROLLBACK; " +
           "     END; " +

           "     :p_state := v_state; " +
           " END; ";
   cmd = RSDCommand(Query);
   cmd.addParam("p_ProcessStatus", RSDBP_IN, ParamProcess.ProcessStatus);
   cmd.addParam("p_RecId", RSDBP_IN, ParamProcess.RecId);
   cmd.addParam("p_ObjectType", RSDBP_IN, ParamProcess.ObjectType);
   cmd.addParam("p_state", RSDBP_OUT, V_INTEGER);
   cmd.execute();

   state = cmd.value("p_state");

   cmd.close();
   cmd = NULL;
   Query = "";

   if (state == 0)
   else 
      errortext = "Ошибка установки статуса "+ParamProcess.ProcessStatus+" в utableprocessin_dbt";
      AddItLog("ws_SOFR_GetFileEntriesForVerify. Error, recID: " + string(ParamProcess.RecId) ) + " " + errortext;
      v_FuncObjResult.errorText = errortext;
      v_FuncObjResult.state = 1;
      v_FuncObjResult.errorCode = -1001;
      return v_FuncObjResult;
   end;

   FileName = GetFileNameFromProcessIn( ParamProcess.RecId, @EventReqId );
   ProcessInTbl = Null;
   //установка статуса в uTableProcessIn_dbt

   GetRegistryValue("РСХБ\\ИНТЕГРАЦИЯ\\ДИРЕКТОРИИ\\IMPORT\\ENTRYCOMPAREDIR", V_STRING, File_Path);

   for( i, 0, CntLoop, 1)

      state_load = LoadEntryForCompare( File_Path + "\\" + FileName, string(EventReqId), null, x_Flag );
      if (state_load)
         AddItLog("ws_SOFR_GetFileEntriesForVerify. Файл CSV загружен, recID: " + string(ParamProcess.RecId) ) + " " + errortext;
         ParamProcess_acc = Null;
         ParamProcess_acc = TParamProcessEntriesVerify( string( EventReqId )  + ";" +  "5009" + ";" + GetStrParamFromEvent( EventReqId ) + ";4"); //установить статус 4

         res = ExecMacroFile("uentcompare_rep.mac","EntCompareRep",string(EventReqId), ParamProcess_acc, Null, @errortext, RepMode );
         if( ( res ) or ( ValType(res) == V_UNDEF ) )
            result_status = C_PROC_STAT_ARCH;
            errortext = "";
         else 
            result_status = C_PROC_STAT_ERR;
         end;
      elif(x_Flag == 1)
         // ошибка загрузки по формату 1, пробуем загружать по формату 0
         x_Flag = 0;
      else
         errortext = String("Не выполнена загрузка файла: ", File_Path, "\\" + FileName);
         AddItLog("ws_SOFR_GetFileEntriesForVerify. Error, recID: " + string(ParamProcess.RecId) ) + " " + errortext;
         v_FuncObjResult.errorText = errortext;
         v_FuncObjResult.state = 1;
         v_FuncObjResult.errorCode = -1001;
         return v_FuncObjResult;
      end;

   end; // for

   AddItLog("ws_SOFR_GetFileEntriesForVerify. Finish, recID: " + string(ParamProcess.RecId) + ", state = " + string(result_status) + ", error = " + errortext);
  
   //установка статуса в uTableProcessEvent_dbt
   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.New_Val_Obj.T_STATUS = result_status;
   ProcessEventTbl.New_Val_Obj.T_NOTE = errortext;
   ProcessEventTbl.Where_Val_Obj.T_RECID = EventReqId;
   if( not ProcessEventTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
      state = 1;
   end;
   ParamProcess_acc = Null;
   ProcessEventTbl = Null;
   //установка статуса в uTableProcessEvent_dbt

   //установка статуса в uTableProcessIn_dbt
   ProcessInTbl = c_usr_tbl_uTableProcessIn();
   ProcessInTbl.New_Val_Obj.T_STATUS = result_status;
   ProcessInTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   if( not ProcessInTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
      state = 1;
   end;
   ParamProcess = Null;
   ProcessInTbl = Null;
   //установка статуса в uTableProcessIn_dbt
      
   return state;

onError(err)
   ParamProcess = Null;
   ParamProcess_acc = Null;
   ProcessEventTbl = Null;
   ProcessInTbl = Null;

//shev записываем текст ошибки в funcobj
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;
end;


//Передача из СОФР данных отчета RSHB_bag
macro ws_SOFR_RSHBbag( Str_Param )
   var res :object,
       ParamProcess :TParamUpdateDossier,  // нет специфических параметров, используем тот же класс
       ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
       state :integer = 0,
       errortext :string = "",
       RequestText,
       v_transformator,
       v_answer,
       v_logger_obj,
       v_log_id;
       
   // параметры запуска
   var Branch        = 1,
       RepDate       = Date();
       
   var CV_EMAIL_GRP_SOFR_BAG = 15; 
   var v_email_processor;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;
   ParamProcess = TParamUpdateDossier( Str_Param + ";2"); //установить статусы 2
   
   var vguid = CreateGUID();
   var vguid_single;
   var maskexclude = "", maskexclude_str = "";
   
   var sql_str, cmd, rs;

   var cnt_prepare = 0;
   var txt;
   
   var resp_obj;
   var FlagAuto = 88;
   var  v_FuncObjResult:FuncObjResult;

   if (ParamProcess.ProcessType == 1) // автозапуск
      // gtv: дата для автозапуска Т-1
      RepDate = date();
      RepDate = GetDateAfterWorkDays(RepDate, -1, 0);

      maskexclude = GetExcludeFilter(FlagAuto, maskexclude_str);
      SetIncludeFilter(maskexclude, maskexclude_str, RepDate, Branch, vguid, FlagAuto); // вставка сразу в таблицу
      
      sql_str = "select count(*) cnt from SOFRBag_launch_log where RequestID = :vguid";
      cmd = RSDCommand(sql_str);
      cmd.AddParam("vguid", RSDBP_IN, vguid);
      rs = RSDRecordSet(cmd);
      cnt_prepare = 0;
      if (rs.movenext)
         cnt_prepare = rs.value("cnt");
      end;
      rs.close; rs = null; cmd.close; cmd = null;

   else
      sql_str = "select count(*) cnt from SOFRBag_launch_log where recid = :recid";
      cmd = RSDCommand(sql_str);
      cmd.AddParam("recid", RSDBP_IN, ParamProcess.RecId);
      rs = RSDRecordSet(cmd);
      cnt_prepare = 0;
      if (rs.movenext)
         cnt_prepare = rs.value("cnt");
      end;
      rs.close; rs = null; cmd.close; cmd = null;
   end;

   if (cnt_prepare == 0)
//      msgbox("Нет данных");
   else
      //установка статуса в uTableProcessEvent_dbt
      ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
      ProcessEventTbl.New_Val_Obj.T_STATUS = 7;                           // идет обработка, уникальный статус
      ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
      ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
      if( not ProcessEventTbl.Update() ) 
         state = 1;
      end;
      ProcessEventTbl = Null;

      if (ParamProcess.ProcessType == 1) // автозапуск
         sql_str = "select l.*, rowid from SOFRBag_launch_log l where RequestID = :vguid";
         cmd = RSDCommand(sql_str);
         cmd.AddParam("vguid", RSDBP_IN, vguid);
         rs = RSDRecordSet(cmd);
      else
         sql_str = "select l.*, rowid from SOFRBag_launch_log l where recid = :recid";
         cmd = RSDCommand(sql_str);
         cmd.AddParam("recid", RSDBP_IN, ParamProcess.RecId);
         rs = RSDRecordSet(cmd);
      end;

      while (rs.movenext)
         if (ParamProcess.ProcessType == 2) // ручной запуск
            RepDate = rs.value("repdate");
         end;
         vguid_single = CreateGUID();
         resp_obj = run_SOFRBag(RepDate, Branch, vguid_single, SQL_ConvTypeStr(rs.value("mask_include_pure")), SQL_ConvTypeStr(rs.value("mask_include")), SQL_ConvTypeStr(rs.value("mask_exclude_pure")));
         if (ValType(resp_obj) == V_GENOBJ)
            UpdateStatusLog(resp_obj, vguid_single, rs.value("rowid"));
        end;
      end;
      rs.close; rs = null; cmd.close; cmd = null;
   end;

   if (ParamProcess.ProcessType == 1) // автозапуск
      /* Отправляем письмо */
      v_email_processor = c_email_proc_env();
      v_email_processor.m_set_msg_head("СОФР - Выгрузка SOFRBag");
      v_email_processor.m_add_row_to_msg_text("Количество масок    Результат");

      sql_str = "select count(*) cnt, send_err from SOFRBag_launch_log l where RequestID = :vguid and count_real_records > 0 group by send_err";
      cmd = RSDCommand(sql_str);
      cmd.AddParam("vguid", RSDBP_IN, vguid);
      rs = RSDRecordSet(cmd);
      while (rs.movenext)
         v_email_processor.m_add_row_to_msg_text(String(Int(rs.value("cnt")):o:20) + rs.value("send_err"));
      end;
      v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_SOFR_BAG, true);
      v_email_processor.m_submit_email_synch();      

      rs.close; rs = null; cmd.close; cmd = null;

   end;
   
   //установка статуса в uTableProcessEvent_dbt
   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
   ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
   if( not ProcessEventTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
      state = 1;
   end;
   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;
   //установка статуса в uTableProcessEvent_dbt

   return state;

onError(err)
   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;
//   state = 1;
//   return state;

//shev записываем текст ошибки в funcobj
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;

end;
//Передача из СОФР данных отчета RSHB_bag

/*----------------------------------------------------------------*/
/* Генерация и отправка временного пароля для входа в торг. терм. */
/*----------------------------------------------------------------*/
macro ws_SOFR_tmp_pwd_submit(Str_Param)
   const CV_STAT_OK = 0;
   const CV_STAT_REPEAT = 1;
   const CV_STAT_ERROR = 2;

   const CV_OBJ_TYPE_QUIK_TRANSF = 5025;
   const CV_OBJ_TYPE_RSHB_BROK_TRANSF = 5026;

   var v_state : INTEGER = CV_STAT_OK;
   var v_evnt_prm;
   var v_proc_state = true;
   var  v_FuncObjResult:FuncObjResult;


   if( not GetParm(2, Str_Param) )
      Str_Param = "0;0;0;0";
   else
      Str_Param = string(Str_Param, ";2;4;5");
   end;

   v_evnt_prm = c_prm_proc_std(Str_Param);

   if((ValType(v_evnt_prm.v_rec_id) != V_UNDEF) and (v_evnt_prm.v_rec_id != 0))
      v_state = submit_trade_term_temp_pwd(v_evnt_prm.v_rec_id, v_evnt_prm.v_client_id);

      /* !!! - В случае успеха. Формирование задания на выгрузку информации - !!! */
      if(v_state == CV_STAT_OK)
         /* Формируем задание на заведение Клиента в QUIK */
         v_proc_state = m_make_event_to_process(CV_OBJ_TYPE_QUIK_TRANSF, v_evnt_prm.v_client_id);
         /* Формируем задание на передачу Клиентских данных в РСХБ-брокер */
         v_proc_state = m_make_event_to_process(CV_OBJ_TYPE_RSHB_BROK_TRANSF, v_evnt_prm.v_client_id);
      end;

   else
      v_state = CV_STAT_REPEAT;
   end;

   if(v_state == CV_STAT_OK)
      m_update_evnt_status(v_evnt_prm.v_rec_id, v_evnt_prm.v_stat_ok);
   elif(v_state == CV_STAT_REPEAT)
      m_update_evnt_status(v_evnt_prm.v_rec_id, v_evnt_prm.v_stat_in_proc);
   elif(v_state == CV_STAT_ERROR)
      m_update_evnt_status(v_evnt_prm.v_rec_id, v_evnt_prm.v_stat_err);
   else
      /* Считаем, что в этом случае произошла ошибка обработки */
      m_update_evnt_status(v_evnt_prm.v_rec_id, v_evnt_prm.v_stat_err);
   end;

   return v_state;

onError(err)
   v_state = CV_STAT_REPEAT;
//   return v_state;

//shev записываем текст ошибки в funcobj
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = v_state;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;

end; /* macro ws_SOFR_tmp_pwd_submit() */


/*-----------------------------------*/
/* Регистрация клиента в РСХБ-Брокер */
/*-----------------------------------*/
macro ws_SOFR_RSHB_brk_info_submit(Str_Param)
   const CV_STAT_OK = 0;
   const CV_STAT_REPEAT = 1;
   const CV_STAT_ERROR = 2;
   private const CV_OBJ_TYPE_RSHB_BROK_TRANSF = 5026;

   var v_state = CV_STAT_OK;
   var v_evnt_prm;
   var v_proc_state = true;
   var v_FuncObjResult:FuncObjResult;
   var v_manualQuery,Params,Query,DataSet;
   var v_manual;

   if( not GetParm(2, Str_Param) )
      Str_Param = "0;0;0;0";
   else
      Str_Param = string(Str_Param, ";2;4;5");
   end;

   v_evnt_prm = c_prm_proc_std(Str_Param);

//если есть задание, раньше выполняемого, со статусом 1 в 20 секундный период, то отправляем на repeat                                                                                 
//попытка убрать дубли в брокере
   Query = " select count(*) from utableprocessevent_dbt u where                  " +
           " u.t_objecttype = "+CV_OBJ_TYPE_RSHB_BROK_TRANSF+" and u.t_status = 1 " +
           " and trunc(u.t_timestamp) = trunc(sysdate)                            " +
           " and u.t_objectid = :objectid                                         " +
           " and u.t_timestamp >=                                                 " +  
           " (                                                                   " +
           " select u2.t_timestamp from utableprocessevent_dbt u2 where           " +     
           " u2.t_objectid = u.t_objectid                                         " +
           " and u2.t_objecttype = u.t_objecttype                                 " +
           " and u2.t_recid = :recid                                              " +
           " and u2.t_recid > u.t_recid                                           " + 
           " and trunc(t_timestamp) = trunc(sysdate)                             " +
           " and rownum = 1                                                       " +   // если таких заданий несколько
           " )- NUMTODSINTERVAL(20, 'SECOND')                                    " ;
           
   
   Params = makeArray( SQLParam( "objectid", v_evnt_prm.v_client_id ), 
                       SQLParam( "recid", v_evnt_prm.v_rec_id ) );


   DataSet = execSQLselect( Query, Params );

   if( DataSet.MoveNext)
     if (DataSet.value(0) != 0)
        return CV_STAT_REPEAT;
     end;
   end;

   if((ValType(v_evnt_prm.v_rec_id) != V_UNDEF) and (v_evnt_prm.v_rec_id != 0))
      v_manual = false;
      if ( (ValType(v_evnt_prm.v_process_type) != V_UNDEF) and (v_evnt_prm.v_process_type == 9) )  // тип для массовых выгрузок
          v_manual = true;
      end;
      // DEF-30604 выгрузка закрытия площадки
      var dlid_close = 0;
      if (v_evnt_prm.v_process_type == 3)
         var cmd = RSDCommand("select nvl(t_param, '0') t_param from utableprocessevent_dbt where t_recid = :p_recid");
         cmd.AddParam("p_recid", RSDBP_IN, v_evnt_prm.v_rec_id);
         cmd = RSDRecordSet(cmd);
         if (cmd.movenext)
           dlid_close = Int(cmd.value("t_param"));
         end;
      end;
      v_proc_state = usr_sendrequest(v_evnt_prm.v_client_id, v_manual, v_evnt_prm.v_process_type, dlid_close); /* usp_Import.mac */

      if(v_proc_state)
         v_state = CV_STAT_OK;
         m_update_evnt_status(v_evnt_prm.v_rec_id, v_evnt_prm.v_stat_ok);
      else
         v_state = CV_STAT_REPEAT;
         m_update_evnt_status(v_evnt_prm.v_rec_id, v_evnt_prm.v_stat_in_proc);
      end;

   else
      v_state = CV_STAT_REPEAT;
   end;

   return v_state;

onError(err)
   v_state = CV_STAT_REPEAT;
//   return v_state;

//shev записываем текст ошибки в funcobj
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = v_state;
   return v_FuncObjResult;

end; /* macro ws_SOFR_RSHB_brk_info_submit() */

//Передача данных для ДБО
macro ws_Event_DBO( Str_Param )
   var ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
       ProcessOutTbl : c_usr_tbl_uTableProcessOut,
       ParamProcess :TParamProcessSlowEvent,
       state :integer = 0;
   var v_sql, v_cmd, v_rs;
   var v_email_processor;
   var CV_EMAIL_GRP_CHD = 1;
   var dbo_xml, forts, curmarket;
   var cp = TDirList;
   const StrPathB = "d:\\rshb_sofr\\export\\DBO";
   var DestPath, ErrCode;
   var  flag = true;
   var sqltime;
   var  v_FuncObjResult:FuncObjResult;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;


   ParamProcess = Null;
   ProcessEventTbl = Null;
   ParamProcess = TParamProcessSlowEvent( Str_Param + ";4"); //установить статусы 4
   v_sql =         "DECLARE ";
   v_sql = v_sql + "    PRAGMA autonomous_transaction; "; /* Для записи лога внутри транзакции */
   v_sql = v_sql + "    v_recid   NUMBER(10) := :p_recid; ";
   v_sql = v_sql + "BEGIN ";
   v_sql = v_sql + "UPDATE utableprocessevent_dbt ";
   v_sql = v_sql + "   SET t_status = 2 ";
   v_sql = v_sql + " WHERE t_recid = v_recid; ";
   v_sql = v_sql + " commit; ";
   v_sql = v_sql + "    END; ";
   v_cmd = RSDCommand(v_sql);
   v_cmd.addParam("p_recid", RSDBP_IN, ParamProcess.RecId);
   v_cmd.execute();
   v_cmd.close(); v_cmd = NULL; v_sql = NULL;

   //Создание записи в uTableProcessOut_dbt
   ProcessOutTbl = c_usr_tbl_uTableProcessOut();
   ProcessOutTbl.New_Val_Obj.T_OBJECTTYPE = 5;
   ProcessOutTbl.New_Val_Obj.T_STATUS = 1;
   var ddt = dttm(date, time);
   ProcessOutTbl.New_Val_Obj.T_TIMESTAMP = ddt;
   if( not ProcessOutTbl.Insert() )
      state = 1;
   end;

   cp.remove(StrPathB + "\\*.*");
   GetRegistryValue("РСХБ\\ИНТЕГРАЦИЯ\\ДИРЕКТОРИИ\\EXPORT\\ДБО", V_STRING, DestPath, ErrCode);
   if( ErrCode > 0 )
      DestPath = "d:\\rshb_sofr\\export\\DBO";
   end;

    dbo_xml = ExecMacroFile("Dbo_xml.mac", "MakeXml");
    forts = ExecMacroFile("Dbo_FORTS.mac", "MakeXml");
    curmarket = ExecMacroFile("DBO_CurrMarket.mac", "MakeXml");


 
   if ((dbo_xml == 1) or (forts == 1) or (curmarket == 1))
      v_email_processor = c_email_proc_env();
      v_email_processor.m_set_msg_head("СОФР - Ошибка выгрузки файла ДБО");
      v_email_processor.m_add_row_to_msg_text("Ошибка выгрузки.Один из файлов не удалось сохранить. Проверьте доступность папки назначения (d:\\rshb_sofr\\export\\DBO) и перезапустите выгрузку вручную.");
      v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_CHD, true);
//      v_email_processor.m_save_to_submit();
      v_email_processor.m_submit_email();

      //установка статуса в uTableProcessEvent_dbt
      ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
      ProcessEventTbl.New_Val_Obj.T_STATUS = 5;
      ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
      ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
      if( not ProcessEventTbl.Update() )
         state = 1;
      end;

      ProcessOutTbl.New_Val_Obj.T_OBJECTTYPE = 5;
      ProcessOutTbl.New_Val_Obj.T_STATUS = 5;
      ddt = dttm(date, time);
      ProcessOutTbl.New_Val_Obj.T_TIMESTAMP = ddt;
      ProcessOutTbl.Where_Val_Obj.t_objecttype = 5;
      ProcessOutTbl.Where_Val_Obj.T_status = 1;
      if( not ProcessOutTbl.Update() )
         state = 1;
      end;

   else
      while (flag)
         if (cp.copy(StrPathB + "\\*.*", "f", DestPath + "\\*.*"))
            //установка статуса в uTableProcessEvent_dbt
            ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
            ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
            ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
            ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
            if( not ProcessEventTbl.Update() )
               state = 1;
            end;
            //Апдейт записи в uTableProcessOut_dbt
            ProcessOutTbl.New_Val_Obj.T_OBJECTTYPE = 5;
            ProcessOutTbl.New_Val_Obj.T_STATUS = 2;
            ddt = dttm(date, time);
            ProcessOutTbl.New_Val_Obj.T_TIMESTAMP = ddt;
            ProcessOutTbl.Where_Val_Obj.t_objecttype = 5;
            ProcessOutTbl.Where_Val_Obj.T_status = 1;
            if( not ProcessOutTbl.Update() )
               state = 1;
            end;
            flag = false;
         else
            sqltime =ExecSqlSelect("select 1 from dual where to_date(TO_CHAR(SYSDATE, 'hh24.Mi.ss'),'hh24.Mi.ss') > to_date('10.00.00','hh24.Mi.ss')");
            if (sqltime.movenext())
                  v_email_processor = c_email_proc_env();
                  v_email_processor.m_set_msg_head("СОФР - Ошибка выгрузки файла ДБО");
                  v_email_processor.m_add_row_to_msg_text("Ошибка выгрузки. Не удается скопировать файлы. Проверьте доступность сетевой папки.");
                  v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_CHD, true);
//                  v_email_processor.m_save_to_submit();
                  v_email_processor.m_submit_email();
                  flag = false;

                  //установка статуса в uTableProcessEvent_dbt
                  ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
                  ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
                  ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
                  ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
                  if( not ProcessEventTbl.Update() )
                     state = 1;
                  end;
         
            end;
         end;
      end;
      
      ParamProcess = Null;
      ProcessEventTbl = Null;
      ProcessOutTbl = Null;
   end;               

   return state;

onError(err)
      v_email_processor = c_email_proc_env();
      v_email_processor.m_set_msg_head("СОФР - Ошибка выгрузки файла ДБО");
      v_email_processor.m_add_row_to_msg_text("Ошибка выгрузки. Непредвиденная ошибка формирования фыйла.");
      v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_CHD, true);
//      v_email_processor.m_save_to_submit();
      v_email_processor.m_submit_email();


      //установка статуса в uTableProcessEvent_dbt
      ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
      ProcessEventTbl.New_Val_Obj.T_STATUS = 5;
      ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
      ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
      ProcessEventTbl.Update();

   ParamProcess = Null;
   ProcessEventTbl = Null;
//   state = 2;
//   return state;

//shev записываем текст ошибки в funcobj
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;
end;

/*-----------------------------------*/
/* Регистрация клиента в Quik*/
/*-----------------------------------*/
macro ws_SOFR_QUIK_info_submit(Str_Param)
   const CV_STAT_OK = 0;
   const CV_STAT_REPEAT = 1;
   const CV_STAT_ERROR = 2;
   private Const REG_EXPORT_PATH = "РСХБ\\интеграция\\директории\\Export\\Quik_folder";
   
   // def-26510 бесконечные выгрузки, когда нет ответа
   private CONST REG_QUIK_ATTEMPTS = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\QUIK\\КВИК_КЛИЕНТ_КОЛ-ВО_ПОПЫТОК";
   private CONST REG_QUIK_PERIOD = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\QUIK\\КВИК_КЛИЕНТ_ИНТЕРВАЛ_ПОПЫТОК";
   private CONST CV_PARTY = 3;
   private CONST CV_CATEG_NUMBER = 171;
   private CONST CV_LOAD_STARTED = 3;
   private CONST CV_EMAIL_GRP_CHD = 20;
   
   var v_attempts: integer, v_attempts_def: integer;
   var v_periods: integer, v_periods_def: integer;
   var stat, err, AttrCode = 0;
   var v_categ_time_expire;
   var v_expired = false;
   var add_note = "";

   var v_state = CV_STAT_OK;
   var v_evnt_prm;
   var v_proc_state = true;
   var v_sql, v_cmd, v_rs;
   var v_email_processor;
   var StrPath, sql, dt,contact, EMail, ErrCode;
   var v_manual;   
   var v_FuncObjResult:FuncObjResult;
   
   if( not GetParm(2, Str_Param) )
      Str_Param = "0;0;0;0";
   else
      Str_Param = string(Str_Param, ";2;4;5");
   end;

   v_evnt_prm = c_prm_proc_std(Str_Param);

   if((ValType(v_evnt_prm.v_rec_id) != V_UNDEF) and (v_evnt_prm.v_rec_id != 0))
      v_manual = false;
      if ( (ValType(v_evnt_prm.v_process_type) != V_UNDEF) and (v_evnt_prm.v_process_type == 9) )  // тип для массовых выгрузок
          v_manual = true;
      end;
      
      //DEF-48303: BIQ-15889. СОФР не успевает обработать ответные сообщения из QUIK
      if (v_manual)  // массовые выгрузки на особых условиях
         v_attempts = 0; // количество попыток игнорируем
         v_attempts_def = 5;
         v_periods_def = 86400; // сутки 24*60*60 секунд
      else 
         // def-26510 бесконечные выгрузки, когда нет ответа
         v_sql =  " SELECT nvl(t_attempts, 0)      "+
                  "  FROM utableprocessevent_dbt   "+
                  " WHERE t_recid = :p_recid       ";
         v_sql = RSDCommand(v_sql);
         v_sql.addParam("p_recid", RSDBP_IN, v_evnt_prm.v_rec_id);
         v_sql = RSDRecordSet(v_sql);
         if (v_sql.movenext());
            v_attempts = v_sql.value(0);
         end;
         v_sql.close; v_sql = null;
         
         // def-26510 бесконечные выгрузки, когда нет ответа
         GetRegistryValue(REG_QUIK_ATTEMPTS, V_INTEGER, v_attempts_def, stat);
         if (stat>0)
            v_attempts_def = 5;
         end;
         GetRegistryValue(REG_QUIK_PERIOD, V_INTEGER, v_periods_def, stat);
         if (stat>0)
            v_periods_def = 300;
         end;
      end;
      
      v_sql =           "select datetime_categ, datetime_categ+NUMTODSINTERVAL(:period, 'SECOND') datetime_categ_expire, t_attrid ";
      v_sql = v_sql +   "  from ( ";
      v_sql = v_sql +   "    select to_date(to_char(d.t_sysdate,'dd.mm.yyyy')|| to_char(d.t_systime,'hh24:mi:ss'),'dd.mm.yyyyhh24:mi:ss') datetime_categ, ";
      v_sql = v_sql +   "           d.t_attrid ";
      v_sql = v_sql +   "      from dobjatcor_dbt d ";
      v_sql = v_sql +   "     where d.t_objecttype = :objecttype and d.t_groupid = :groupid ";
      v_sql = v_sql +   "       and d.t_object = lpad(:objectid,10,'0') and d.t_validtodate > sysdate ";
      v_sql = v_sql +   "        ) n ";
      v_cmd = RSDCommand(v_sql);
      v_cmd.addParam("period",      RSDBP_IN, v_periods_def);
      v_cmd.addParam("objecttype",  RSDBP_IN, CV_PARTY);
      v_cmd.addParam("groupid",     RSDBP_IN, CV_CATEG_NUMBER);
      v_cmd.addParam("objectid",    RSDBP_IN, v_evnt_prm.v_client_id);
      v_rs = RSDRecordSet(v_cmd);
      if (v_rs.movenext());
         AttrCode = v_rs.value("t_attrid");
         v_categ_time_expire = v_rs.value("datetime_categ_expire");
      end;
      v_rs.close; v_rs = null; v_cmd.close; v_cmd = null; v_sql = null;

      if(ValType(AttrCode) == V_UNDEF)
      else 
         if (AttrCode == CV_LOAD_STARTED) // категория = Начата
            if (v_categ_time_expire < dttm(date, time))
               v_expired = true;
            end;
            if (not v_expired)
               if (v_attempts >= v_attempts_def)
                  v_expired = true;
               end;
            end;
         end;
      end;
      
      if (v_expired)
         v_sql =         "UPDATE utableprocessevent_dbt ";
         v_sql = v_sql + "   SET t_status = :p_status, ";
         v_sql = v_sql + "       t_note = :p_note  ";
         v_sql = v_sql + " WHERE t_recid = :p_recid ";
         v_cmd = RSDCommand(v_sql);
         v_cmd.addParam("p_status", RSDBP_IN, 5);
         v_cmd.addParam("p_note", RSDBP_IN, "Ответ не получен");
         v_cmd.addParam("p_recid", RSDBP_IN, v_evnt_prm.v_rec_id);
         v_cmd.execute();
         v_cmd.close(); v_cmd = NULL; v_sql = NULL;
         
         v_email_processor = c_email_proc_env();
         v_email_processor.m_set_msg_head("Ошибка при регистрации или обновлении в Quik");
         v_email_processor.m_add_row_to_msg_text("По клиенту "+v_evnt_prm.v_client_id+" не выполнена передача данных в КВИК из-за превышения интервала времени или количества попыток. Выполните повторную выгрузку в КВИК вручную");
         v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_CHD, true);
         v_email_processor.m_submit_email_synch();
         v_email_processor = NULL;
         
         DisconnectObjAttr(CV_PARTY, string(v_evnt_prm.v_client_id:10:o), CV_CATEG_NUMBER, 0);
         ConnectObjAttr(err, CV_PARTY, string(v_evnt_prm.v_client_id:10:o), CV_CATEG_NUMBER, 4);
        
         v_sql =           "declare                   ";
         v_sql = v_sql +   "   sql_st varchar2(2000); ";
         v_sql = v_sql +   "   a1 varchar2(200);      ";
         v_sql = v_sql +   "   a2 varchar2(200);      ";
         v_sql = v_sql +   "   a3 varchar2(200);      ";
         v_sql = v_sql +   "   a4 varchar2(200);      ";
         v_sql = v_sql +   "   a5 varchar2(200);      ";
         v_sql = v_sql +   "   a6 varchar2(200);      ";
         v_sql = v_sql +   "   o_errtxt varchar2(2000); ";
         v_sql = v_sql +   "   o_MsgID  itt_q_message_log.msgid%type; ";
         v_sql = v_sql +   "   v_client number := :p_client;   ";
         v_sql = v_sql +   "   v_clientname varchar2(200);     ";
         v_sql = v_sql +   "   v_clientcode varchar2(100);     ";
         v_sql = v_sql +   "begin                              ";
         v_sql = v_sql +   "   /* если не найдено, так тому и быть */  ";
         v_sql = v_sql +   "   select p.t_name, obj.t_code into v_clientname, v_clientcode   ";
         v_sql = v_sql +   "     from dobjcode_dbt obj, dparty_dbt p                         ";
         v_sql = v_sql +   "    where obj.t_objecttype = 3 and obj.t_codekind = 101 and obj.t_state = 0 ";
         v_sql = v_sql +   "      and obj.t_bankclosedate = to_date('01010001','ddmmyyyy')   ";
         v_sql = v_sql +   "      and obj.t_objectid = p.t_partyid                           ";
         v_sql = v_sql +   "      and p.t_partyid = v_client;                                ";
         v_sql = v_sql +   "   sql_st :=  'begin IT_EVENT.RegisterEvent(  :a1, :a2, :a3, :a4, :a5, :a6, :a7, :a8); end;';   ";
         v_sql = v_sql +   "   a1 := null;                                                   ";
         v_sql = v_sql +   "   a2 := 'SOFR';                                                 ";
         v_sql = v_sql +   "   a3 := 'ws_SOFR_QUIK_info_submit';                             ";
         v_sql = v_sql +   "   a4 := 'Ошибка : по клиенту '||v_clientname||' не выполнена передача данных в КВИК из-за превышения интервала времени или количества попыток'; ";
         v_sql = v_sql +   "   a5 := '<XML ErrorCode=""01"" ClientCode = ""'||v_clientcode||'""/>' ;   ";
         v_sql = v_sql +   "   a6 := '-';                                                    ";
         v_sql = v_sql +   "   execute immediate sql_st using a1, a2, a3, a4, a5, a6, o_errtxt, o_MsgID; ";
         v_sql = v_sql +   "exception                                                        ";
         v_sql = v_sql +   "    when others then dbms_output.put_line(sqlcode);              ";
         v_sql = v_sql +   "    /* если код -6550, то процедуры не существует*/              ";
         v_sql = v_sql +   "end;                                                             ";

         v_cmd = RSDCommand(v_sql);
         v_cmd.addParam("p_client", RSDBP_IN, v_evnt_prm.v_client_id);
         v_cmd.execute();
         v_cmd.close(); v_cmd = NULL; v_sql = NULL;
         
         v_state = CV_STAT_OK;
         return v_state;
      end;

      v_proc_state = Start_Quik_flow(v_evnt_prm.v_client_id,v_evnt_prm.v_rec_id,v_manual, @add_note); /* Quik_flow.mac */

      if(v_proc_state == 0)
         v_state = CV_STAT_OK;
         v_sql =         "UPDATE utableprocessevent_dbt ";
         v_sql = v_sql + "   SET t_attempts = nvl(t_attempts,0)+1 ";
         v_sql = v_sql + " WHERE t_recid = :p_recid ";
         v_cmd = RSDCommand(v_sql);
         v_cmd.addParam("p_recid", RSDBP_IN, v_evnt_prm.v_rec_id);
         v_cmd.execute();
         v_cmd.close(); v_cmd = NULL; v_sql = NULL;
      elif (v_proc_state == 1)
         v_state = CV_STAT_OK;
         m_update_evnt_status(v_evnt_prm.v_rec_id, v_evnt_prm.v_stat_ok);
      elif (v_proc_state == 2)
         v_state = CV_STAT_OK;
         v_sql =         "UPDATE utableprocessevent_dbt ";
         v_sql = v_sql + "   SET t_status = :p_status, ";
         v_sql = v_sql + "   t_note = :p_note,  ";
         v_sql = v_sql + "   t_attempts = nvl(t_attempts,0)+1  ";
         v_sql = v_sql + " WHERE t_recid = :p_recid ";
         v_cmd = RSDCommand(v_sql);
         v_cmd.addParam("p_status", RSDBP_IN, 4);
         v_cmd.addParam("t_note", RSDBP_IN, "Ошибка на стороне Quik");
         v_cmd.addParam("p_recid", RSDBP_IN, v_evnt_prm.v_rec_id);
         v_cmd.execute();
         v_cmd.close(); v_cmd = NULL; v_sql = NULL;
        
         v_email_processor = c_email_proc_env();
         v_email_processor.m_set_msg_head("Ошибка при регистрации или обновлении в Quik");
         v_email_processor.m_add_row_to_msg_text("При регистрации/обновлении аккаунта возникла ошибка, обратитесь в службу поддержки.");
         GetRegistryValue(REG_EXPORT_PATH, V_STRING, StrPath, ErrCode);

         sql = ExecSqlSelect("select trunc(sysdate) from dual");
         sql.movenext();
         dt = StrSubst(string(date(sql.value(0))), " ", "0");
         dt = StrSubst(dt, ".", "");
         contact = ExecSqlSelect("SELECT  t_value  FROM dcontact_dbt  WHERE t_partyid = :partyid  AND t_addresstype in ( 0,1)  AND t_ismain = 'X' AND t_contactkind = 5 AND t_contacttype = 8", makeArray(SqlParam("partyid", v_evnt_prm.v_client_id )));
         if (contact.movenext());
            EMail  = contact.value(0);
         else
            EMail  = "-";
         end;

         v_email_processor.m_add_attach_to_list( StrPath + "Error\\in_"+v_evnt_prm.v_client_id+"_" + dt + ".xml" );
         v_email_processor.m_add_email_to_list(EMail);
         v_email_processor.m_submit_email_synch();
     
      elif (v_proc_state == 3)
         v_state = CV_STAT_OK;
         v_sql =         "UPDATE utableprocessevent_dbt ";
         v_sql = v_sql + "   SET t_status = :p_status, ";
         v_sql = v_sql + "   t_note = :p_note,  ";
         v_sql = v_sql + "   t_attempts = nvl(t_attempts,0)+1  ";
         v_sql = v_sql + " WHERE t_recid = :p_recid ";
         v_cmd = RSDCommand(v_sql);
         v_cmd.addParam("p_status", RSDBP_IN, 5);
         v_cmd.addParam("t_note", RSDBP_IN, "Ошибка сохранения "+add_note);
         v_cmd.addParam("p_recid", RSDBP_IN, v_evnt_prm.v_rec_id);
         v_cmd.execute();
         v_cmd.close(); v_cmd = NULL; v_sql = NULL;
      end;

   else
      v_state = CV_STAT_REPEAT;
   end;

   return v_state;

onError(err)
   v_state = CV_STAT_REPEAT;
//   return v_state;
//shev записываем текст ошибки в funcobj
   v_FuncObjResult.errorText = substr(GetFullErrorMessage(err),1,1000);
   v_FuncObjResult.state = v_state;
   v_FuncObjResult.errorCode = err.code;
   it_log("Ошибка Str_Param="+Str_Param+":"+v_FuncObjResult.errorText,"ws_synch_SOFR.mac",v_sql);
   return v_FuncObjResult;

end; /* macro ws_SOFR_QUIK_info_submit() */

/*----------------------------------------*/
/* Передача из СОФР закрытия договоров БО */
/* BIQ-7089 Гераськина Т.В. Теперь не только закрытие, а и обновление тоже */
/*----------------------------------------*/
macro ws_CloseContractBO( Str_Param )
   var res,
       ParamProcess :TParamUpdateDossier,
       ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
       state :integer = 0,
       errortext :string = "",
       RequestText,
       v_transformator,
       v_answer,
       v_logger_obj,
       v_log_id;
   var v_error;
   var v_status,v_txt;
   var CV_EMAIL_GRP_SOFR_CLOSE_CONTRACT = 17; 
   var v_email_processor;
   var  v_FuncObjResult:FuncObjResult;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;
   v_status = 4;
   ParamProcess = TParamUpdateDossier( Str_Param + ";4"); 

   //установка статуса в uTableProcessEvent_dbt  - фиксируем факт запуска, так как ответ получаем сразу
   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.New_Val_Obj.T_STATUS = 2;
   ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
   if( not ProcessEventTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
      state = 1;
   end;
   ProcessEventTbl = Null;
   res = Null;
   //установка статуса в uTableProcessEvent_dbt


   // запуск остался в основном макросе, да будет так
   res = UpdateBrokContractRequestMsg (ParamProcess.ObjectId, "OFFLINE", @v_error, ParamProcess.ProcessType); 
   if (v_error.ErrorCode != 0)
      /* Отправляем письмо */
      v_email_processor = c_email_proc_env();
      v_email_processor.m_set_msg_head("СОФР - Выгрузка закрытия договоров БО");
      v_email_processor.m_add_row_to_msg_text("Договор ID="+v_error.ContractID+", номер="+v_error.ContractNumber);
      v_email_processor.m_add_row_to_msg_text("Не удалось выгрузить закрытие в Бисквит. "+v_error.ErrorDesc);
      v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_SOFR_CLOSE_CONTRACT, true);
      v_email_processor.m_submit_email_synch();      

      v_status = 5;
      v_txt = v_error.ErrorDesc;

      v_FuncObjResult.errorText = v_txt;
      v_FuncObjResult.state = 1;
      v_FuncObjResult.errorCode = 42;

   else
      v_status = 4;
      v_txt = "OK";
      v_FuncObjResult.state = 0;
   end;

   //установка статуса в uTableProcessEvent_dbt
   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.New_Val_Obj.T_STATUS = v_status;
   ProcessEventTbl.New_Val_Obj.T_NOTE = v_txt;
   ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
   if( not ProcessEventTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
      state = 1;
   end;
   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;
   //установка статуса в uTableProcessEvent_dbt

   return v_FuncObjResult;

onError(err)
   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;

   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;
end; /* macro ws_CloseContractBO() */
/* Передача из СОФР закрытия договоров БО */



//Передача из СОФР в ЕБПЗ информации по предметам залога (векселям)
macro ws_SOFR_to_EBPZ_bills ()
   var v_sql, v_sql_result;
   var state:integer = 0;
   var ProcessOutTbl : c_usr_tbl_uTableProcessOut;
   var v_FuncObjResult:FuncObjResult;

   v_sql_result = execSQL("delete from BILL_RESPONSE_SOFR_EBPZ", null, false);

   if (Valtype(v_sql_result) == V_UNDEF)
      state = 1;
   end;


   v_sql = "insert into bill_response_sofr_ebpz\n" +	
				"  select ebpz.asset_id,\n" + 
				"         bnr.t_bcid,\n" + 
				"         ebpz.bill_series,\n" + 
				"         ebpz.bill_number,\n" + 
				"         ebpz.draver_inn,\n" + 
				"         ebpz.draver_kpp,\n" + 
/* 2020-10-21 AS				"         decode(bnr.t_issuekind, 0, 'Простой', 'Переводной') t_issuekind,\n" + */
				"         case \n" + 
				"             when bnr.t_bcid is null then \n" + 
				"                 NULL \n" + 
				"             else \n" + 
				"                 decode(bnr.t_issuekind, 0, 'Простой', 'Переводной') \n" + 
				"         end t_issuekind, \n" + 
				"         leg.t_principal,\n" + 
				"         (select decode(t_fi_code, '810', '643', t_fi_code)\n" + 
				"            from dfininstr_dbt\n" + 
				"           where t_fi_kind = 1\n" + 
				"             and t_fiid = leg.t_pfi) t_fi_code,\n" + 
				"         lv.t_name t_state,\n" + 
/* 2021-03-06 AS
				"         bnr.t_issuedate,\n" + 
				"         case\n" + 
				"           when bnr.t_bctermformula = 20 then\n" + 
				"            leg.t_expiry\n" + 
				"         end t_bill_expiry,\n" + 
				"         case\n" + 
				"           when bnr.t_bctermformula = 20 then\n" + 
				"            leg.t_maturity\n" + 
				"         end t_bill_maturity,\n" + 
				"         case\n" + 
				"           when bnr.t_bctermformula in (10, 15) then\n" + 
				"            leg.t_maturity\n" + 
				"         end t_bill_repay,\n" + 
*/

				"         case when bnr.t_issuedate = to_date('01.01.0001','dd.mm.yyyy') then\n" + 
				"            NULL\n" + 
				"         else  \n" + 
				"            bnr.t_issuedate\n" + 
				"         end t_issuedate,\n" + 
				"         case\n" + 
				"           when bnr.t_bctermformula = 20 then\n" + 
				"            case when leg.t_expiry = to_date('01.01.0001','dd.mm.yyyy') then\n" + 
				"              NULL\n" + 
				"            else \n" + 
				"                 leg.t_expiry\n" + 
				"            end     \n" + 
				"         end t_bill_expiry,\n" + 
				"         case\n" + 
				"           when bnr.t_bctermformula = 20 then\n" + 
				"            case when leg.t_maturity = to_date('01.01.0001','dd.mm.yyyy') then \n" + 
				"              NULL\n" + 
				"            else\n" + 
				"              leg.t_maturity\n" + 
				"            end  \n" + 
				"         end t_bill_maturity,\n" + 
				"         case\n" + 
				"           when bnr.t_bctermformula in (10, 15) then\n" + 
				"            case when leg.t_maturity = to_date('01.01.0001','dd.mm.yyyy') then \n" + 
				"              NULL\n" + 
				"            else\n" + 
				"              leg.t_maturity\n" + 
				"            end  \n" + 
				"         end t_bill_repay,\n" + 

/* 2020-10-21 AS				"         decode(leg.t_formula, 0, 'Дисконт', 'Проценты') t_type,\n" + */
				"         case\n" + 
				"            when bnr.t_bcid is null then\n" + 
				"                NULL\n" + 
				"            else\n" + 
				"                decode(leg.t_formula, 0, 'Дисконт', 'Проценты') \n" + 
				"         end t_type,\n" + 
				"         leg.t_price / power(10, leg.t_point) t_rate,\n" + 
/*				"         pt.t_name || ' ' || to_char(systimestamp, 'dd.mm.yyyy hh24:mi:ss:ff') t_holder,\n" + */
				"         case\n" + 
				"            when bnr.t_bcid is null then\n" + 
				"                NULL\n" + 
				"            else\n" + 
				"                 pt.t_name\n" + 
				"         end t_holder,\n" + 
/* 2021-03-06 AS		"         oc.t_code t_holder_inn,\n" + */
				"         regexp_replace(oc.t_code, '/.*') t_holder_inn,\n" + 
				"         case\n" + 
				"           when bnr.t_bcid is null then\n" + 
				"            'Not found'\n" + 
				"           when leg.t_principal is null or lv.t_name is null or\n" + 
				"                bnr.t_issuedate is null or pt.t_name is null or\n" + 
				"                oc.t_code is null then\n" + 
				"            'Found partially'\n" + 
				"           else\n" + 
				"            'Found'\n" + 
				"         end t_search_result\n" + 
				"    from bill_request_ebpz_sofr ebpz\n" + 
				"    left join dvsbanner_dbt bnr\n" + 
				"      on (trim(bnr.t_bcseries) = trim(ebpz.bill_series) and\n" + 
				"         trim(bnr.t_bcnumber) = trim(ebpz.bill_number) and\n" + 
				"         bnr.t_issuer in (select t_partyid\n" + 
/* 2020-11-16 AS согласно ТЗ должны отбираться векселя с любым статусом, а не только bnr.t_bcstatus = 25 (в залоге) */
/* 				"                             from ddp_dep_dbt) and bnr.t_bcstatus = 25)\n" + */
				"                             from ddp_dep_dbt) )\n" + 
				"    left join ddl_leg_dbt leg\n" + 
				"      on bnr.t_bcid = leg.t_dealid\n" + 
				"     and leg.t_legkind = 1\n" + 
				"     and leg.t_legid = 0\n" + 
				"    left join dllvalues_dbt lv\n" + 
				"      on (lv.t_list = 1132 and lv.t_element = bnr.t_bctermformula)\n" + 
				"    left join dparty_dbt pt\n" + 
				"      on (bnr.t_holder = pt.t_partyid)\n" + 
				"    left join dobjcode_dbt oc\n" + 
				"      on (oc.t_objecttype = 3 and oc.t_codekind = 16 and oc.t_state = 0 and\n" + 
				"         bnr.t_holder = oc.t_objectid)";
 

   //v_sql = "insert into BILL_RESPONSE_SOFR_EBPZ values (15555, 'TEST', 'TTEST', ' ', ' ', ' ', 333, 643, 'fdsf', sysdate, 'ewr', 'rwerwer', 3.5, 'weewwe')";

   v_sql_result = ExecSql(v_sql, null, true/*false*/);

   if (Valtype(v_sql_result) == v_undef)
      state = 1;
   end;

   ProcessOutTbl = c_usr_tbl_uTableProcessOut();
   //ProcessOutTbl.New_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
   ProcessOutTbl.New_Val_Obj.T_OBJECTTYPE = 51;
   ProcessOutTbl.New_Val_Obj.T_STATUS = 2;
   var ddt = dttm(date, time);
   ProcessOutTbl.New_Val_Obj.T_TIMESTAMP = ddt;
   if( not ProcessOutTbl.Insert() )
      state = 1;
   end;

   return state;


onError(err)

   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;

End;

//shev 20201010
//Передача из СОФР запроса на выгрузку зачилений в файл
macro ws_SOFR_Get306AccForVerify( Str_Param )
var res_obj :object,
    ParamProcess :TParamProcessEntriesVerify,
    ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
    state :integer = 0,
    errortext :string = "",
    RequestText,
    v_transformator,
    v_answer,
    v_logger_obj,
    v_log_id,
    ObjTypeId :integer = 0, // ИД типа данных справочник объектов SOFR
    FlPaym :bool = false,
    FlSyncAsync :bool = true,
    i :integer = 0;

var v_module_name = "Get306AccForVerify";


   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   ParamProcess = Null;
   ProcessEventTbl = Null;
   res_obj = Null;
   ParamProcess = TParamProcessEntriesVerify( Str_Param + ";2"); //установить статусы 2
   res_obj = GetEntriesForVerifyReq( ParamProcess.RecId );//создание запроса на выгрузку зачислений в файл
   res_obj.GetEntriesForVerifyReqMsg.GetEntriesForVerifyReq.AddConditins( ParamProcess.DateIn, ParamProcess.DateOut );
   i = 0;

   res_obj.GetEntriesForVerifyReqMsg.GetEntriesForVerifyReq.AddEntry( null );
   res_obj.getentriesforverifyreqmsg.getentriesforverifyreq.entrieslist[0].personalnumber = 9999;

   ObjTypeId = 17;
   FlSyncAsync = false;

   v_transformator = c_secur_msg_converter();
   RequestText = v_transformator.m_secur_external_req(res_obj);
   v_logger_obj = uws_exchng_logger(null,
                                    null,
                                    XmlRpcRequestId(),
                                    v_module_name,
                                    modulename(),
                                    ParamProcess.RecId,
                                    RequestText);
   v_log_id = v_logger_obj.get_log_id();
   v_answer = SubmitRequestToWS( 2,                 // ИД очереди.
                                 "",                // ИД сообщения.
                                 "",                // Идентификатор Бэк Офиса. (не обрабатывается).
                                 FlSyncAsync,       // Признак синхронной обработки. Если не указан, = False
                                 "0000",            /*1,*/ // Подразделение системы-назначения.
                                 ObjTypeId,         // ИД типа данных
                                 RequestText,       // Бизнес данные в виде XML.
                                 string(ParamProcess.RecId, "-", v_log_id) // 20181229 - kva - Передаем id из utableprocessevent_dbt
                                 );
   //установка статуса в uTableProcessEvent_dbt
   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
   ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
   if( not ProcessEventTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
    state = 1;
   end;
   ParamProcess = Null;
   ProcessEventTbl = Null;
   res_obj = Null;
   //установка статуса в uTableProcessEvent_dbt

   return state;

onError(err)
   ParamProcess = Null;
   ProcessEventTbl = Null;
   res_obj = Null;
   state = 1;
   return state;

end;

//shev 20201014 
//Загрузка файла с пополнениями полученного от БИСКВИТ
macro ws_SOFR_GetFile306AccForVerify( Str_Param )
var FileName :string = "",
    File_Path :string = "",
    Query :string = "",
    cmd,
    ParamProcess :object /*TParamProcessEntriesVerify*/,
    ProcessInTbl :c_usr_tbl_uTableProcessIn,
    ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
    state :integer = 0,
    errortext :string = "",
    EventReqId :integer = -1
    , i :integer, CntLoop = 2
    , x_Flag :integer = 1 // DEF-75364 загрузка файла по формату 1 (с доп.полями), если будет неудачно, то загрузка по формату 0
    , res
    ;
var  v_FuncObjResult:FuncObjResult;

  if( not GetParm(2, Str_Param) )
     Str_Param = "";
  end;

  ParamProcess = Null;
  ProcessInTbl = Null;
  ParamProcess = TParamProcessSlowEvent( Str_Param + ";3"); //установить статусы 3

  //установка статуса в uTableProcessIn_dbt
  Query = " DECLARE " +
          "     v_state             NUMBER(5) := 0; " +
          "     v_ProcessStatus     utableprocessin_dbt.T_STATUS%TYPE := :p_ProcessStatus; " +
          "     v_RecId             utableprocessin_dbt.T_RECID%TYPE := :p_RecId; " +
          "     v_ObjectType        utableprocessin_dbt.T_OBJECTTYPE%TYPE := :p_ObjectType; " +
          " BEGIN " +
          "     BEGIN " +

          "         UPDATE utableprocessin_dbt " +
          "         SET T_STATUS = v_ProcessStatus " +
          "         WHERE T_RECID = v_RecId " +
          "          AND T_OBJECTTYPE = v_ObjectType; " +

          "         COMMIT; " +

          "     EXCEPTION " +
          "         WHEN OTHERS " +
          "         THEN " +
          "             v_state := 1; " +
          "             ROLLBACK; " +
          "     END; " +

          "     :p_state := v_state; " +
          " END; ";

  cmd = RSDCommand(Query);
  cmd.addParam("p_ProcessStatus", RSDBP_IN, ParamProcess.ProcessStatus);
  cmd.addParam("p_RecId", RSDBP_IN, ParamProcess.RecId);
  cmd.addParam("p_ObjectType", RSDBP_IN, ParamProcess.ObjectType);
  cmd.addParam("p_state", RSDBP_OUT, V_INTEGER);
  cmd.execute();

  state = cmd.value("p_state");

  cmd.close();
  cmd = NULL;
  Query = "";

  FileName = GetFileNameFromProcessIn( ParamProcess.RecId, @EventReqId );
  ParamProcess = Null;
  ProcessInTbl = Null;
  //установка статуса в uTableProcessIn_dbt


  GetRegistryValue("РСХБ\\ИНТЕГРАЦИЯ\\ДИРЕКТОРИИ\\IMPORT\\306ACCCOMPAREDIR", V_STRING, File_Path);
//!!!!не заполнена ветка код ошибки

  for( i, 0, CntLoop, 1)

    if( ( state == 0 ) and ( Load306AccForCompare( File_Path + "\\" + FileName, string(EventReqId), null, x_Flag ) ) )


      ParamProcess = Null;
      ParamProcess = TParamProcessEntriesVerify( string( EventReqId )  + ";" +  "5031" + ";" + GetStrParamFromEvent( EventReqId ) + ";4"); //установить статус 4

      res = ExecMacroFile( "u306AccCompare_rep.mac", "Acc306CompareRep", string(EventReqId), ParamProcess, Null );
      if( ( res ) or ( ValType(res) == V_UNDEF ) )
        //установка статуса в uTableProcessEvent_dbt
        ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
        ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
        ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
        ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
        if( not ProcessEventTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
         state = 1;
        end;
        ParamProcess = Null;
        ProcessEventTbl = Null;
        //установка статуса в uTableProcessEvent_dbt

      end;

      ParamProcess = Null;
      ProcessInTbl = Null;
      ParamProcess = TParamProcessSlowEvent( Str_Param + ";4"); //установить статусы 4
      //установка статуса в uTableProcessIn_dbt
      ProcessInTbl = c_usr_tbl_uTableProcessIn();
      ProcessInTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
      ProcessInTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
      ProcessInTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
      if( not ProcessInTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
         state = 1;
      end;
      ParamProcess = Null;
      ProcessInTbl = Null;
      //установка статуса в uTableProcessIn_dbt

    elif(x_Flag == 1)
      // ошибка загрузки по формату 1, пробуем загружать по формату 0
      x_Flag = 0;

    else
      state = 1;
    end;

  end; // for


   return state;

onError(err)
   ParamProcess = Null;
   ProcessEventTbl = Null;
   ProcessInTbl = Null;
//   state = 1;
//   return state;

//shev записываем текст ошибки в funcobj
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;

end;

//shev 17.12.2020
macro ws_SOFR_to_NPR2 (Str_Param)
   var v_sql, v_sql_result,cmd,v_rs;
   var state:integer = 0;
   var ParamProcess :TParamProcessSlowEvent;
   var errorcode :string = "0",errortext :string = "";
   var v_email_processor ;
   var  v_FuncObjResult:FuncObjResult;

  if( not GetParm(2, Str_Param) )
     Str_Param = "";
  end;
 
   v_sql = "select count(*)  from SOFR_RCV2Violations";
   cmd = RSDCommand(v_sql);
   v_rs = RSDRecordSet(cmd);
   if(v_rs.movenext())
      if(v_rs.value(0) == 0)
         errorcode = "1";
         errortext = "ETL не перенес данные, буферная таблица пустая";
         state = 1;
      end;
   end;

   v_sql = null; v_rs = null; v_rs = null;

   if(errorcode == "0")

      v_sql =         " DECLARE                                      ";
      v_sql = v_sql + "    v_state             NUMBER(5) := 0;       ";
      v_sql = v_sql + "    v_errm              VARCHAR(1000);        ";
      v_sql = v_sql + "    v_date              DATE  := SYSDATE;     ";
      v_sql = v_sql + "    v_curr_timestamp    DATE;                 ";
      v_sql = v_sql + "    v_curr_hour         NUMBER := EXTRACT(HOUR FROM CAST(v_date AS TIMESTAMP)); ";
      v_sql = v_sql + " BEGIN                                        ";
      v_sql = v_sql + "    BEGIN                                     ";
      v_sql = v_sql + "       IF v_curr_hour > 8 AND v_curr_hour < 13 THEN                 ";
      v_sql = v_sql + "           v_curr_timestamp := TRUNC(v_date) + INTERVAL '10' HOUR;  ";
      v_sql = v_sql + "       ELSIF v_curr_hour > 15 AND v_curr_hour < 20 THEN             ";
      v_sql = v_sql + "           v_curr_timestamp := TRUNC(v_date) + INTERVAL '17' HOUR;  ";
      v_sql = v_sql + "       ELSIF v_curr_hour > 22 OR v_curr_hour < 3 THEN               ";
      v_sql = v_sql + "           v_curr_timestamp := TRUNC(v_date) + case                 ";
      v_sql = v_sql + "                                                when v_curr_hour = 23  ";
      v_sql = v_sql + "                                                  then  0              ";
      v_sql = v_sql + "                                                  else -1              ";
      v_sql = v_sql + "                                                end  + INTERVAL '23' HOUR + INTERVAL '55' MINUTE; ";
      v_sql = v_sql + "       ELSE        ";
      v_sql = v_sql + "           RETURN; ";
      v_sql = v_sql + "       END IF;     ";
      v_sql = v_sql + "     INSERT INTO DRCV_DBT DRC (t_loaddate,    ";
      v_sql = v_sql + "                       t_FirmID,              ";
      v_sql = v_sql + "                       T_EKK,                 ";
      v_sql = v_sql + "                       T_TIMESTAMP,           ";
      v_sql = v_sql + "                       t_EVENTYPE,            ";
      v_sql = v_sql + "                       t_ENTITYNUMBER,        ";  
      v_sql = v_sql + "                       t_PORTFOLIOVALUE,      ";    
      v_sql = v_sql + "                       t_INITMARGIN,          ";
      v_sql = v_sql + "                       t_MINMARGIN,           ";
      v_sql = v_sql + "                       t_RCV1,                ";
      v_sql = v_sql + "                       t_RCV2,                ";
      v_sql = v_sql + "                       t_risklevel,           ";
      v_sql = v_sql + "                       t_futposition_type,    ";
      v_sql = v_sql + "                       t_futtotalasset)       ";
      v_sql = v_sql + "      SELECT trunc(SYSDATE),                  ";
      v_sql = v_sql + "             RCV.FirmID,                      ";
      v_sql = v_sql + "             RCV.CLIENTCODE,                  ";
      v_sql = v_sql + "             RCV.DATETIME,                    ";
      v_sql = v_sql + "             RCV.EVENTYPE,                    ";
      v_sql = v_sql + "             RCV.ENTITYNUMBER,                ";
      v_sql = v_sql + "             RCV.PORTFOLIOVALUE,              ";
      v_sql = v_sql + "             RCV.INITMARGIN,                  ";
      v_sql = v_sql + "             RCV.MINMARGIN,                   ";
      v_sql = v_sql + "             RCV.RCV1,                        ";
      v_sql = v_sql + "             RCV.RCV2,                        ";
      v_sql = v_sql + "             RCV.risklevel,                   ";
      v_sql = v_sql + "             RCV.fut_position_type,           ";
      v_sql = v_sql + "             RCV.fut_total_asset              ";
      v_sql = v_sql + "        FROM SOFR_RCV2Violations RCV          ";
      v_sql = v_sql + "       WHERE RCV.RCV2 < 0                     ";
      v_sql = v_sql + "         AND RCV.DATETIME = v_curr_timestamp ";
      v_sql = v_sql + "         AND NOT EXISTS (SELECT NULL          ";
      v_sql = v_sql + "                           FROM DRCV_DBT d    ";
      v_sql = v_sql + "                          WHERE D.t_loaddate > TRUNC(SYSDATE) - 2  ";
      v_sql = v_sql + "                            AND D.t_ekk = RCV.clientcode           ";
      v_sql = v_sql + "                            AND D.T_TIMESTAMP = RCV.datetime       ";
      v_sql = v_sql + "                            AND D.t_rcv2 = RCV.rcv2);              ";

      v_sql = v_sql + "     EXCEPTION                                ";
      v_sql = v_sql + "         WHEN OTHERS                          ";
      v_sql = v_sql + "         THEN                                 ";
      v_sql = v_sql + "             v_state := 1;                    ";
      v_sql = v_sql + "             v_errm := sqlerrm;               ";
      v_sql = v_sql + "     END;                                     ";
                                                                     
      v_sql = v_sql + "     :p_state := v_state;                     ";
      v_sql = v_sql + "     :p_errm := v_errm;                       ";
      v_sql = v_sql + " END;                                         ";

      cmd = RSDCommand(v_sql);
      cmd.addParam("p_state", RSDBP_OUT, V_INTEGER);
      cmd.addParam("p_errm", RSDBP_OUT, V_STRING,1000);
      cmd.execute();

      v_sql_result = cmd.value("p_state");
      var sql_errortext =  cmd.value("p_errm");

      cmd.close(); cmd = NULL; 
   
      if (v_sql_result == 1)
          errorcode = "2";
          errortext = "Данные не перенесены из буферной таблице "+sql_errortext;
          state = 1;
      end;
   
      v_sql_result = null; v_sql = null;
   
      v_sql_result = execSQL("delete from SOFR_RCV2Violations where datetime < sysdate - 2", null, false);
   
      if (Valtype(v_sql_result) == V_UNDEF)
         errorcode = "1";
         errortext = "Не удалось очистить буферную таблицу";
         state = 1;
      end;

   end;

   ParamProcess = Null;
   if(errorcode == "0")
      ParamProcess = TParamProcessSlowEvent( Str_Param + ";4"); 
   else
      ParamProcess = TParamProcessSlowEvent( Str_Param + ";5"); 
   end;

  v_sql = " DECLARE " +
          "     v_state             NUMBER(5) := 0; " +
          "     v_ProcessStatus     utableprocessin_dbt.T_STATUS%TYPE := :p_ProcessStatus; " +
          "     v_RecId             utableprocessin_dbt.T_RECID%TYPE := :p_RecId; " +
          "     v_ObjectType        utableprocessin_dbt.T_OBJECTTYPE%TYPE := :p_ObjectType; " +
          "     v_ResultCode        utableprocessin_dbt.T_RESULTCODE%TYPE := :p_ResultCode; " +
          "     v_ResultText        utableprocessin_dbt.T_RESULTTEXT%TYPE := :p_ResultText; " +

          " BEGIN " +
          "     BEGIN " +

          "         UPDATE utableprocessin_dbt " +
          "         SET T_STATUS = v_ProcessStatus, " +
          "             T_ResultCode = v_ResultCode, " +
          "             T_ResultText = v_ResultText " +
          "         WHERE T_RECID = v_RecId " +
          "          AND T_OBJECTTYPE = v_ObjectType; " +

          "         COMMIT; " +

          "     EXCEPTION " +
          "         WHEN OTHERS " +
          "         THEN " +
          "             v_state := 1; " +
          "             ROLLBACK; " +
          "     END; " +

          "     :p_state := v_state; " +
          " END; ";

  cmd = RSDCommand(v_sql);
  cmd.addParam("p_ProcessStatus", RSDBP_IN, ParamProcess.ProcessStatus);
  cmd.addParam("p_RecId", RSDBP_IN, ParamProcess.RecId);
  cmd.addParam("p_ObjectType", RSDBP_IN, 13);
  cmd.addParam("p_ResultCode", RSDBP_IN, errorcode);
  cmd.addParam("p_ResultText", RSDBP_IN, errortext);
  cmd.addParam("p_state", RSDBP_OUT, V_INTEGER);
  cmd.execute();

  state = cmd.value("p_state");

  cmd.close();cmd = NULL; 

  if(errorcode != "0")
     v_email_processor = c_email_proc_env();
     v_email_processor.m_set_msg_head("СОФР - Загрузка данных для журнала НПР2");
     v_email_processor.m_add_row_to_msg_text("Загрузка данных закончилась ошибкой: "+errortext);
     v_email_processor.m_save_to_submit_grp(3, true);
     v_email_processor.m_submit_email();

     v_FuncObjResult.errorText = errorcode;
     v_FuncObjResult.state = 1;
     v_FuncObjResult.errorCode = 42;

     else

     v_FuncObjResult.state = 1;

  end;


   ParamProcess = Null;  v_sql_result = null;

   return state;

   onError(err)
      ParamProcess = Null;
//      state = 1;
//      return state;

//shev записываем текст ошибки в funcobj
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;

End;




/*-----------------------------------------------------------------------------------------
   Передача информации о брокерском обслуживании для Депозитария
   BIQ-7382
   Гераськина Т.В.
-----------------------------------------------------------------------------------------*/
macro ws_SendBrokerContractDepo( Str_Param )
   var res :object,
       ParamProcess :TParamUpdateDossier,  // специфических параметров нет
       ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
       state :integer = 0,
       errortext :string = "",
       RequestText,
       v_transformator,
       v_answer,
       v_logger_obj,
       v_log_id;
   var v_error;
   var v_email_processor ;
   var dbo_number, datebegin, shortname;
   var  v_FuncObjResult:FuncObjResult;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;
   ParamProcess = TParamUpdateDossier( Str_Param + ";2"); //установить статусы 2

   res = SendBrokerContractDepo_Req( ParamProcess.ObjectId, @v_error );

   if( Valtype(res) != V_UNDEF)
      v_transformator = c_secur_msg_converter();
      RequestText = v_transformator.m_secur_external_req(res);

      // BIQ-7382 перенесено из обработки ответа
      SendShortNotification(ParamProcess.ObjectId, 207, String(ParamProcess.ObjectId:o:34),
                             res.SendBrokerContractDepoReq.ContractParameters.ContractNumber,
                             res.SendBrokerContractDepoReq.ContractParameters.ContractOpenDate,
                             res.SendBrokerContractDepoReq.ContractParameters.ContractName);

      v_logger_obj = uws_exchng_logger(null,
                                       null,
                                       XmlRpcRequestId(),
                                       "SendBrokerContractDepo_Req",
                                       modulename(),
                                       ParamProcess.RecId,
                                       RequestText);
      v_log_id = v_logger_obj.get_log_id();

      v_answer = SubmitRequestToWS( 2,                 // ИД очереди.
                                    "",                // ИД сообщения.
                                    "",                // Идентификатор Бэк Офиса. (не обрабатывается).
                                    false,/*true,*/    // Признак синхронной обработки. Если не указан, = False
                                    "0000",            /*1,*/ // Подразделение системы-назначения.
                                    23,                // ИД типа данных    //???
                                    RequestText,       // Бизнес данные в виде XML.
                                    string(ParamProcess.RecId, "-", v_log_id) 
                                    );
      ParamProcess.ProcessStatus = 2;
   else
      v_logger_obj = uws_exchng_logger(null,
                                       null,
                                       XmlRpcRequestId(),
                                       "SendBrokerContractDepo_Req",
                                       modulename(),
                                       ParamProcess.RecId,
                                       "Пустой текст");
      v_log_id = v_logger_obj.get_log_id();

      v_logger_obj.add_error_info(v_error.ErrorCode, 
                                  v_error.ErrorDesc);
      ParamProcess.ProcessStatus = 5;
      
      v_email_processor = c_email_proc_env();
      v_email_processor.m_set_msg_head("Передача информации о брокерском обслуживании для Депозитария");
      v_email_processor.m_add_row_to_msg_text("Ошибка: "+v_error.ErrorDesc);
      v_email_processor.m_save_to_submit_grp(3, true);  //???
      v_email_processor.m_submit_email();
   end;

   //установка статуса в uTableProcessEvent_dbt
   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
   ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
   if( not ProcessEventTbl.Update() ) //инструмент простых действий с таблицами из RSL В.Карпов
      state = 1;
   end;
   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;
   //установка статуса в uTableProcessEvent_dbt

   return state;

onError(err)
   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;
//   state = 1;
//   return state;

//shev записываем текст ошибки в funcobj
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;

end;
//Передача информации о брокерском обслуживании для Депозитария

//выгрузка в ЦХД данных по ц/б в ДУ
macro ws_Event_CHD_DU( Str_Param )
   var ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
       ProcessOutTbl : c_usr_tbl_uTableProcessOut,
       ParamProcess :TParamProcessSlowEvent,
       state :integer = 0;
   var v_sql, v_cmd, v_rs;
   var v_email_processor;
   var CV_EMAIL_GRP_CHD = 1;
   var in_id, in_id_pre, sql1;
   private var sql_err; 

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   ParamProcess = Null;
   ProcessEventTbl = Null;
   ParamProcess = TParamProcessSlowEvent( Str_Param + ";4"); //установить статусы 4
   v_sql =         "DECLARE ";
   v_sql = v_sql + "    PRAGMA autonomous_transaction; "; /* Для записи лога внутри транзакции */
   v_sql = v_sql + "    v_recid   NUMBER(10) := :p_recid; ";
   v_sql = v_sql + "BEGIN ";
   v_sql = v_sql + "UPDATE utableprocessevent_dbt ";
   v_sql = v_sql + "   SET t_status = 2 ";
   v_sql = v_sql + " WHERE t_recid = v_recid; ";
   v_sql = v_sql + " commit; ";
   v_sql = v_sql + "    END; ";
   v_cmd = RSDCommand(v_sql);
   v_cmd.addParam("p_recid", RSDBP_IN, ParamProcess.RecId);
   v_cmd.execute();
   v_cmd.close(); v_cmd = NULL; v_sql = NULL;

   //проверяем наличие записей в utableprocessout_dbt с типом 29 и статусом отличным от 4
   //если такие записи есть, то пишем письма мелким почерком. В противном случае делаем выгрузку.
   v_sql =         "SELECT t_recid, t_objecttype, t_status ";
   v_sql = v_sql + "  FROM utableprocessout_dbt ";
   v_sql = v_sql + " WHERE t_objecttype = 29 ";
   v_sql = v_sql + "   AND t_status < 4 ";

   v_cmd = RSDCommand(v_sql);

   v_rs = RSDRecordSet(v_cmd);

   if(v_rs.movenext())

      v_email_processor = c_email_proc_env();
      v_email_processor.m_set_msg_head("СОФР - Выгрузка в ЦХД ценные бумаги в ДУ");
      v_email_processor.m_add_row_to_msg_text("Выгрузка невозможна.Одна из предыдущих задач не завершена. (ws_synch_SOFR.mac 4630  DU)");
      v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_CHD, true);
//      v_email_processor.m_save_to_submit();
      v_email_processor.m_submit_email();

      ParamProcess = TParamProcessSlowEvent( Str_Param + ";4"); //установить статусы 4
      //установка статуса в uTableProcessEvent_dbt
      ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
      ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
      ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
      ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
      if( not ProcessEventTbl.Update() )
         state = 1;
      end;

      return state;
   end;


   //Создание записи в uTableProcessOut_dbt
   ProcessOutTbl = c_usr_tbl_uTableProcessOut();
   ProcessOutTbl.New_Val_Obj.T_OBJECTTYPE = 29;
   ProcessOutTbl.New_Val_Obj.T_STATUS = 1;
   var ddt = dttm(date, time);
   ProcessOutTbl.New_Val_Obj.T_TIMESTAMP = ddt;
   if( not ProcessOutTbl.Insert() )
      state = 1;
   end;

   //находим ид текущей выгрузки
   sql1 = ExecSqlSelect("select t_recid from utableprocessout_dbt where t_objecttype =29 and t_status = 1");
   sql1.movenext();
   in_id = sql1.value(0);
   sql1 = null;

   /*Для выгрузи по ценным бумагам не актуально пока, оставляю на всякий случай, если сильно мешает - можно удалить
   //Находим ид предыдущей выгрузки
   sql1 = ExecSqlSelect("select t_recid from utableprocessout_dbt where t_objecttype = 29 and t_status =4 and  t_timestamp = (select max(t_timestamp) from utableprocessout_dbt where t_objecttype = 29 and t_status =4)");
   sql1.movenext();
   in_id_pre = sql1.value(0);
   sql1 = null;*/

   execSQL ("begin qb_dwh_export_du.runexport(trunc(sysdate),:in_id); end;", makeArray(SqlParam("in_id", in_id )));

   ParamProcess = TParamProcessSlowEvent( Str_Param + ";4"); //установить статусы 4
 
   //установка статуса в uTableProcessEvent_dbt
   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.New_Val_Obj.T_STATUS = ParamProcess.ProcessStatus;
   ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
   if( not ProcessEventTbl.Update() )
      state = 1;
   end;
   //Проверка ошибок выгрузки, если есть ошибки - считаем выгрузку некорректной

   sql_err = ExecSqlSelect( " select err.t_errcode, err.t_errmsg, err.t_is_critical, ev.t_timestamp, trunc(ev.t_timestamp)  "+
                            "  from dqb_bp_event_dbt ev                                                                     "+
                            "  inner join dqb_bp_event_error_dbt err on err.t_idevent = ev.t_id                             "+
                            "  where ev.t_value = :in_id and err.t_is_critical < 2                                          ",
                            makeArray(SqlParam("in_id", in_id )));
   if (sql_err.movenext())
      ProcessOutTbl.New_Val_Obj.T_OBJECTTYPE = 29;
      ProcessOutTbl.New_Val_Obj.T_STATUS = 5;
      ddt = dttm(date, time);
      ProcessOutTbl.New_Val_Obj.T_TIMESTAMP = ddt;
      ProcessOutTbl.Where_Val_Obj.t_objecttype = 29;
      ProcessOutTbl.Where_Val_Obj.T_status = 1;
      if( not ProcessOutTbl.Update() )
         state = 1;
      end;
   
      v_email_processor = c_email_proc_env();
      v_email_processor.m_set_msg_head("СОФР - Ошибка выгрузки в ЦХД данных по ц/б в ДУ");
      v_email_processor.m_add_row_to_msg_text("Во время выгрузки возникли ошибки. Требуется проверить логи по выгрузке id = " + in_id );
      v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_CHD, true);
//      v_email_processor.m_save_to_submit();
      v_email_processor.m_submit_email();
   else
      //Апдейт записи в uTableProcessOut_dbt
      ProcessOutTbl.New_Val_Obj.T_OBJECTTYPE = 29;
      ProcessOutTbl.New_Val_Obj.T_STATUS = 2;
      ddt = dttm(date, time);
      ProcessOutTbl.New_Val_Obj.T_TIMESTAMP = ddt;
      ProcessOutTbl.Where_Val_Obj.t_objecttype = 29;
      ProcessOutTbl.Where_Val_Obj.T_status = 1;
      if( not ProcessOutTbl.Update() )
         state = 1;
      end;
   end;

   ParamProcess = Null;
   ProcessEventTbl = Null;
   ProcessOutTbl = Null;
                  

   return state;

onError(err)
      v_email_processor = c_email_proc_env();
      v_email_processor.m_set_msg_head("СОФР - Ошибка выгрузки в ЦХД данных по ц/б в ДУ");
      v_email_processor.m_add_row_to_msg_text("Ошибка выгрузки. Проверьте процедуру выгрузки ORACLE.");
      v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_CHD, true);
//      v_email_processor.m_save_to_submit();
      v_email_processor.m_submit_email();


      //установка статуса в uTableProcessEvent_dbt
      ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
      ProcessEventTbl.New_Val_Obj.T_STATUS = 5;
      ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
      ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
      ProcessEventTbl.Update();

   ParamProcess = Null;
   ProcessEventTbl = Null;
   state = 1;
   return state;

end;

/*-------------------------------------------------*/
/* Запуск выгрузки файла НОБ из СОФР в Депозитарий */
/* Гераськина Т.В.
   BIQ-7335                                        */
/*-------------------------------------------------*/
macro ws_Depo_NOB_Out(Str_Param)
   var ParamProcess :TParamProcessSlowEvent,
       ProcessOutTbl: c_usr_tbl_uTableProcessOut,
       ProcessInTbl: c_usr_tbl_uTableProcessIn,
       res,
       state = 0,
       v_sql_upd, v_cmd_upd;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   ParamProcess = Null;
   ProcessOutTbl = Null;
   ProcessInTbl = Null;
   res = Null;
   
   ParamProcess = TParamProcessSlowEvent( Str_Param + ";4"); //установить статус 4

   if (ParamProcess.ProcessType == 1) // исходящий поток
      res = PrepareNOBFromSOFRToDepo(); // возвращает объект c_Error
      
      // utableprocessout_dbt 
      ProcessOutTbl = c_usr_tbl_utableprocessout;
      ProcessOutTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;   // recid из utableprocessout_dbt
      
      if( Valtype(res) == V_GENOBJ)
         if (res.ErrorCode == 0) // файл успешно передан
            ProcessOutTbl.New_Val_Obj.T_STATUS = 2;   // готово к обработке
         else // ошибка
            ProcessOutTbl.New_Val_Obj.T_STATUS = 5;   // ошибка
            ProcessOutTbl.New_Val_Obj.T_RESULTTEXT = res.ErrorDesc;
         end;
      else
         ProcessOutTbl.New_Val_Obj.T_STATUS = 5;   // ошибка
         ProcessOutTbl.New_Val_Obj.T_RESULTTEXT = res.ErrorDesc;
      end;

      if( not ProcessOutTbl.Update() ) 
         state = 1;
      end;
   else // входящий поток - ответ на загрузку
      // utableprocessin_dbt - начало обработки
      ProcessInTbl = c_usr_tbl_uTableProcessIn;
      ProcessInTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;   // recid из utableprocessin_dbt
      ProcessInTbl.New_Val_Obj.T_STATUS = 3;   // обработка
      if( not ProcessInTbl.Update() ) 
         state = 1;
      end;
      
      if (state == 0) 
         v_sql_upd =             "DECLARE ";
         v_sql_upd = v_sql_upd + "    v_recid_in        NUMBER(10) := :p_recid_in; ";
         v_sql_upd = v_sql_upd + "       v_cnt_err         NUMBER(10); ";
         v_sql_upd = v_sql_upd + "       v_proc_stat_new   NUMBER(10); ";
         v_sql_upd = v_sql_upd + "       v_proc_stat_arch  NUMBER(10) := :p_proc_stat_arch; ";
         v_sql_upd = v_sql_upd + "       v_proc_stat_err   NUMBER(10) := :p_proc_stat_err; ";
         v_sql_upd = v_sql_upd + "       v_ret             NUMBER(5) := 0; ";
         v_sql_upd = v_sql_upd + "BEGIN ";
         v_sql_upd = v_sql_upd + "       BEGIN ";
         v_sql_upd = v_sql_upd + "           SELECT count(*) INTO v_cnt_err ";
         v_sql_upd = v_sql_upd + "             FROM SOFR_TAXSOFRRESULT_DBT ";
         v_sql_upd = v_sql_upd + "            WHERE resultcode IS NOT NULL AND resultcode <> '0'; ";
         v_sql_upd = v_sql_upd + "       EXCEPTION ";
         v_sql_upd = v_sql_upd + "           WHEN OTHERS THEN v_cnt_err := 0; ";
         v_sql_upd = v_sql_upd + "       END; ";
         v_sql_upd = v_sql_upd + "       IF v_cnt_err = 0 THEN ";
         v_sql_upd = v_sql_upd + "           begin ";
/*         v_sql_upd = v_sql_upd + "              for c in (select nobid from SOFR_TAXSOFRRESULT_DBT) ";
         v_sql_upd = v_sql_upd + "               loop "; 
         v_sql_upd = v_sql_upd + "                  update DDLCONTROBS_DBT set result = 'DONE' ";
         v_sql_upd = v_sql_upd + "                   where nobid = c.nobid; ";
         v_sql_upd = v_sql_upd + "               end loop; ";*/
         v_sql_upd = v_sql_upd + "              v_proc_stat_new := v_proc_stat_arch; ";
         v_sql_upd = v_sql_upd + "           EXCEPTION ";
         v_sql_upd = v_sql_upd + "              WHEN OTHERS THEN ";
         v_sql_upd = v_sql_upd + "                  ROLLBACK; ";
         v_sql_upd = v_sql_upd + "                  v_ret := 1; ";
         v_sql_upd = v_sql_upd + "                  v_proc_stat_new := v_proc_stat_err; ";
         v_sql_upd = v_sql_upd + "           end; ";
         v_sql_upd = v_sql_upd + "       ELSE ";
         v_sql_upd = v_sql_upd + "           v_proc_stat_new := v_proc_stat_err; ";
         v_sql_upd = v_sql_upd + "       END IF; ";
         v_sql_upd = v_sql_upd + "       BEGIN ";
         v_sql_upd = v_sql_upd + "           UPDATE utableprocessin_dbt ";
         v_sql_upd = v_sql_upd + "              SET t_status = v_proc_stat_new ";
         v_sql_upd = v_sql_upd + "            WHERE t_recid = v_recid_in; ";
         v_sql_upd = v_sql_upd + "           COMMIT; ";
         v_sql_upd = v_sql_upd + "       EXCEPTION ";
         v_sql_upd = v_sql_upd + "           WHEN OTHERS THEN ";
         v_sql_upd = v_sql_upd + "               ROLLBACK; ";
         v_sql_upd = v_sql_upd + "               v_ret := 1; ";
         v_sql_upd = v_sql_upd + "       END; ";
         v_sql_upd = v_sql_upd + "    :p_result := v_ret; ";
         v_sql_upd = v_sql_upd + "END; ";

         v_cmd_upd = RSDCommand(v_sql_upd);
         v_cmd_upd.addParam("p_recid_in", RSDBP_IN, ParamProcess.RecId);
         v_cmd_upd.addParam("p_proc_stat_arch", RSDBP_IN, 4);
         v_cmd_upd.addParam("p_proc_stat_err", RSDBP_IN, 5);
         v_cmd_upd.addParam("p_result", RSDBP_OUT, V_INTEGER);
         v_cmd_upd.execute();

         if(v_cmd_upd.value("p_result") != 0)
            state = 1;
         end;

         v_cmd_upd.close(); v_cmd_upd = NULL; v_sql_upd = NULL;      
   
      end;
      
   end;
   
   ParamProcess = Null;
   ProcessOutTbl = Null;
   res = Null;
   //установка статуса в uTableProcessEvent_dbt

   return state;

onError(err)
   ParamProcess = Null;
   ProcessOutTbl = Null;
   res = Null;
   state = 1;
   return state;

end; /* macro ws_Depo_NOB_Out() */

/*-------------------------------------------------*/
/* Запуск загрузки файла НОБ в СОФР из Депозитария */
/* Гераськина Т.В.
   BIQ-7335                                        */
/*-------------------------------------------------*/
macro ws_Depo_NOB_In(Str_Param)
   const C_SOFR_NOB_IN = 20;
   const C_PROC_STAT_NEW = 1;
   const C_PROC_STAT_READY = 2;
   const C_PROC_STAT_PROC = 3;
   const C_PROC_STAT_ARCH = 4;
   const C_PROC_STAT_ERR = 5;

   var v_state = 0;
   var v_proc_param;
   var res_load:c_Error;
   var v_reqid_out;
   var ProcessInTbl,ProcessOutTbl; 

   var v_sql, v_cmd, v_rs; // IS 536935 

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   /* Объект используется один и тот же */
   v_proc_param = c_prm_proc_contrBO_result(Str_Param);

   // IS 536935
   //проверяем наличие записей в utableprocessout_dbt с типом 20 и статусом меньше 4
   //если такие записи есть, то запускать загрузку нельзя - затрется таблица результатов
   v_sql =         "SELECT t_recid, t_objecttype, t_status ";
   v_sql = v_sql + "  FROM utableprocessout_dbt ";
   v_sql = v_sql + " WHERE t_objecttype = :t ";
   v_sql = v_sql + "   AND t_status < 4 ";

   v_cmd = RSDCommand(v_sql);
   v_cmd.AddParam("t", RSDBP_IN, C_SOFR_NOB_IN);
   v_rs = RSDRecordSet(v_cmd);

   if(v_rs.movenext())
      // utableprocessin_dbt - пометим как лог 
      ProcessInTbl = c_usr_tbl_uTableProcessIn;
      ProcessInTbl.Where_Val_Obj.T_RECID = v_proc_param.RecId;   // recid из utableprocessin_dbt
      ProcessInTbl.New_Val_Obj.T_TIMESTAMP = dttm(date(), time());
      ProcessInTbl.New_Val_Obj.T_RESULTTEXT = "Найдено незавершенное событие "+v_rs.value("t_recid")+" в utableprocessout_dbt. Загрузка очистит текущие результаты";
      ProcessInTbl.Update();
      //статус в таблице не меняем, терпеливо ждем 
      ProcessInTbl = Null;
      v_state = 1;
   end;
   v_rs.close; v_cmd.close; v_rs = null; v_cmd = null;

   if (v_state == 0)
      // utableprocessin_dbt - начало обработки
      ProcessInTbl = c_usr_tbl_uTableProcessIn;
      ProcessInTbl.Where_Val_Obj.T_RECID = v_proc_param.RecId;   // recid из utableprocessin_dbt
      ProcessInTbl.New_Val_Obj.T_STATUS = 3;   // обработка
      if( not ProcessInTbl.Update() ) 
         v_state = 1;
      end;
      ProcessInTbl = null;
   end;

   if (v_state == 0)
      // utableprocessout_dbt 
      ProcessOutTbl = c_usr_tbl_utableprocessout;
      ProcessOutTbl.New_Val_Obj.T_OBJECTTYPE = C_SOFR_NOB_IN;
      ProcessOutTbl.New_Val_Obj.T_STATUS = C_PROC_STAT_NEW;
      ProcessOutTbl.New_Val_Obj.T_TIMESTAMP = dttm(date(), time());
      ProcessOutTbl.add_returning_prm("T_RECID");
      if( not ProcessOutTbl.Insert() ) 
         ProcessOutTbl = Null;
         v_state = 1;
      else
         v_reqid_out = ProcessOutTbl.New_Val_Obj.T_RECID;
      end;
   end;
   ProcessOutTbl = null;
   
   if (v_state == 0)
      res_load = LoadNOBFromDepoToSOFR();   // обработка файла и создание НОБ

      ProcessInTbl = c_usr_tbl_uTableProcessIn;
      ProcessInTbl.Where_Val_Obj.T_RECID = v_proc_param.RecId;
      ProcessInTbl.New_Val_Obj.T_TIMESTAMP = dttm(date(), time());
      if (res_load.ErrorCode == 0)   // ошибок не было
         ProcessInTbl.New_Val_Obj.T_STATUS = C_PROC_STAT_ARCH;    // успех
         ProcessInTbl.New_Val_Obj.T_RESULTTEXT = "OK";
      else
         ProcessInTbl.New_Val_Obj.T_STATUS = C_PROC_STAT_ERR;     // ошибка
         ProcessInTbl.New_Val_Obj.T_RESULTTEXT = res_load.ErrorDesc;
      end;
      
      if( not ProcessInTbl.Update() ) 
         v_state = 1;
      end;
   end;
      
   if (v_state == 0)
      ProcessOutTbl = c_usr_tbl_utableprocessout;
      ProcessOutTbl.Where_Val_Obj.T_RECID = v_reqid_out;
      ProcessOutTbl.New_Val_Obj.T_STATUS = C_PROC_STAT_READY;   // готово к обработке
      if( not ProcessOutTbl.Update() ) 
         v_state = 1;
      end;
   end;

   v_proc_param = Null;
   ProcessOutTbl = Null;
   ProcessInTbl = Null;
   res_load = Null;

   return v_state;

onError(err)
   v_state = 1;
   return v_state;
   
end; /* macro ws_Depo_NOB_In() */

/*-------------------------------------------------*/
/* Запуск загрузки файла откатов НОБ из СОФР в Депозитарий */
/* Гераськина Т.В.
   BIQ-7335                                        */
/*-------------------------------------------------*/
macro ws_DEPO_NOB_Undo_In(Str_Param)
   const C_SOFR_NOB_IN_UNDO = 22;
   const C_PROC_STAT_NEW = 1;
   const C_PROC_STAT_READY = 2;
   const C_PROC_STAT_PROC = 3;
   const C_PROC_STAT_ARCH = 4;
   const C_PROC_STAT_ERR = 5;

   var v_state = 0;
   var v_proc_param;
   var res_load:c_Error;
   var v_reqid_out;
   var ProcessInTbl,ProcessOutTbl; 
   var del_array = TArray, del_res;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   /* Объект используется один и тот же */
   v_proc_param = c_prm_proc_contrBO_result(Str_Param);

   // utableprocessin_dbt - начало обработки
   ProcessInTbl = c_usr_tbl_uTableProcessIn;
   ProcessInTbl.Where_Val_Obj.T_RECID = v_proc_param.RecId;   // recid из utableprocessin_dbt
   ProcessInTbl.New_Val_Obj.T_STATUS = 3;   // обработка
   if( not ProcessInTbl.Update() ) 
      v_state = 1;
   end;
   ProcessInTbl = null;

   if (v_state == 0)
      // utableprocessout_dbt 
      ProcessOutTbl = c_usr_tbl_utableprocessout;
      ProcessOutTbl.New_Val_Obj.T_OBJECTTYPE = C_SOFR_NOB_IN_UNDO;
      ProcessOutTbl.New_Val_Obj.T_STATUS = C_PROC_STAT_NEW;
      ProcessOutTbl.New_Val_Obj.T_TIMESTAMP = dttm(date(), time());
      ProcessOutTbl.add_returning_prm("T_RECID");
      if( not ProcessOutTbl.Insert() ) 
         ProcessOutTbl = Null;
         v_state = 1;
      else
         v_reqid_out = ProcessOutTbl.New_Val_Obj.T_RECID;
      end;
   end;
   ProcessOutTbl = null;
   
   if (v_state == 0)
      res_load = UndoNOBFromDepoToSOFR(del_array);   // обработка файла и удаление НОБ

      ProcessInTbl = c_usr_tbl_uTableProcessIn;
      ProcessInTbl.Where_Val_Obj.T_RECID = v_proc_param.RecId;
      ProcessInTbl.New_Val_Obj.T_TIMESTAMP = dttm(date(), time());
      if (res_load.ErrorCode == 0)   // ошибок не было
         ProcessInTbl.New_Val_Obj.T_STATUS = C_PROC_STAT_ARCH;    // успех
      else
         ProcessInTbl.New_Val_Obj.T_STATUS = C_PROC_STAT_ERR;     // ошибка
         ProcessInTbl.New_Val_Obj.T_RESULTTEXT = res_load.ErrorDesc;

         // сообщение об ошибках
         var v_email = c_email_proc_env();
         var v_email_head = "Ошибки загрузки файла НОБ";
         var v_emailText;
         v_email.m_set_msg_head(v_email_head);
         for (del_res, del_array)
            v_emailText = del_res;
            v_email.m_add_row_to_msg_text(v_emailText);
         end;
         v_email.m_save_to_submit_grp(CONTRACT_EMAIL_GRP, true);
         v_email.m_submit_email_synch();
      end;
      
      if( not ProcessInTbl.Update() ) 
         v_state = 1;
      end;
      
   end;
      
   if (v_state == 0)
      ProcessOutTbl = c_usr_tbl_utableprocessout;
      ProcessOutTbl.Where_Val_Obj.T_RECID = v_reqid_out;
      ProcessOutTbl.New_Val_Obj.T_STATUS = C_PROC_STAT_READY;   // готово к обработке
      if( not ProcessOutTbl.Update() ) 
         v_state = 1;
      end;
   end;

   v_proc_param = Null;
   ProcessOutTbl = Null;
   ProcessInTbl = Null;
   res_load = Null;

   return v_state;

onError(err)
   v_state = 1;
   return v_state;
   
end; /* macro ws_DEPO_NOB_Undo_In() */


/*------------------------------------------------------*/
/* Добавления сообщения в очередь для отправки на биржу */
/* Шишкин Е.В,                                          */
/* BIQ-7033/8632                                        */
/*------------------------------------------------------*/
macro ws_SOFR_AddDlContrMsgToAMQP( Str_Param, Str_Param1, Str_Param2 )
   var res :object,
       ParamProcess :TParamProcessSlowEvent,
       v_state;
   var  v_FuncObjResult:FuncObjResult;

   ParamProcess = Null;
   ParamProcess = TParamProcessSlowEvent( Str_Param); 

   // у процедуры 3 параметра. 1 = 7033 (objecttype), 2 = id договора (objectid), 3 = строка через запятую (t_param)
   v_state = DL_AddDlContrMsgToAMQP(Str_Param1,0);


   ParamProcess = Null;

   return v_state;

onError(err)
//   v_state = 1;
//   return v_state;

//shev записываем текст ошибки в funcobj
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;

end;

macro ws_ReFillCodes_QUIK(Str_Param)
   var res :object,
       ParamProcess :c_prm_proc_contrBO_result,
       ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
       state :integer = 0,
       errortext :string = "",
       RequestText,
       v_logger_obj,
       v_log_id;
   var v_error, v_status;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;
   ParamProcess = c_prm_proc_contrBO_result( Str_Param ); 

   res = QUIK_ReFillCodes();

   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;

   if( Valtype(res) != V_UNDEF)
      if (res.ErrorCode == 0)
         v_status = 4;
      else
         v_status = 5;
      end;
      ProcessEventTbl.New_Val_Obj.T_RESULTCODE = res.ErrorCode;
      ProcessEventTbl.New_Val_Obj.T_RESULTTEXT = res.ErrorDesc;
   else 
      v_status = 5;
   end;

   ProcessEventTbl.New_Val_Obj.T_STATUS = v_status;

   if( not ProcessEventTbl.Update() ) 
      state = 1;
   end;
   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;
   //установка статуса в uTableProcessEvent_dbt

   return state;

onError(err)
   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;
   state = 1;
   return state;
end;



macro ws_CLIENT_BOOKING(Str_Param)
   var res :object,
       ParamProcess :c_prm_proc_contrBO_result,
       ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
       state :integer = 0,
       errortext :string = "",
       RequestText,
       v_logger_obj,
       v_log_id;
   var v_error, v_state, v_status;
   var ProcessOutTbl;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;

   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;
   ParamProcess = c_prm_proc_contrBO_result( Str_Param ); 

   var OutFiles_spb;
   ExecMacroFile("dlcontrmsg_spb.mac", "СформироватьУведомленияДБО_СПБ", OutFiles_spb);

   var i = 0, j = 0, exists = false;
   while( i < OutFiles_spb.size )
      // utableprocessout_dbt 
      ProcessOutTbl = c_usr_tbl_utableprocessout;
      ProcessOutTbl.New_Val_Obj.T_OBJECTTYPE = OutFiles_spb(i).MessType;
      ProcessOutTbl.New_Val_Obj.T_FULLFILENAME = OutFiles_spb(i).FullFileName;
      ProcessOutTbl.New_Val_Obj.T_STATUS = 2;
      ProcessOutTbl.New_Val_Obj.T_TIMESTAMP = dttm(date(), time());
      if( not ProcessOutTbl.Insert() ) 
         ProcessOutTbl = Null;
         v_state = 1;
      end;

      i = i + 1;
   end;

   if (v_state == 1)
      v_status = 5;
   else 
      v_status = 4;
   end;

   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
   ProcessEventTbl.New_Val_Obj.T_STATUS = v_status;

   if( not ProcessEventTbl.Update() ) 
      state = 1;
   end;
   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;
   //установка статуса в uTableProcessEvent_dbt

   return state;

onError(err)
   ParamProcess = Null;
   ProcessEventTbl = Null;
   res = Null;
   state = 1;
   return state;
end;


macro ws_ANSWER_CLIENT_BOOKING(objectType, objectId, param, guid, taskId)
   var res :object,
       ParamProcess :TParamProcessSlowEvent,
       ProcessInTbl,
       state :integer = 0,
       errortext :string = "",
       RequestText,
       v_logger_obj,
       v_log_id;
   var v_error, v_status;

   if( not GetParm(2, param) )
      param = "";
   end;

   ParamProcess = Null;
   ParamProcess = TParamProcessSlowEvent( param); 

   res = Null;


   res = ExecMacroFile("LoadSPBFiles.mac", "LoadSPBFiles", objectType, objectId);

   // обработка самих событий внутри LoadSPBFiles
/*   ProcessInTbl = c_usr_tbl_uTableProcessIn;
   ProcessInTbl.Where_Val_Obj.T_RECID = objectId;  
   ProcessInTbl.New_Val_Obj.T_RESULTCODE = res.ErrorCode;
   ProcessInTbl.New_Val_Obj.T_RESULTTEXT = res.ErrorDesc;

   if (res.ErrorCode == 0)
      ProcessInTbl.New_Val_Obj.T_STATUS = 4;
   else 
      ProcessInTbl.New_Val_Obj.T_STATUS = 5;
   end;

   if( not ProcessInTbl.Update() ) 
      state = 1;
   end;
   ProcessInTbl = null;   */

   ParamProcess = Null;
   res = Null;

   return state;

onError(err)
   ParamProcess = Null;
   ProcessInTbl = Null;
   res = Null;
   state = 1;
   return state;
end;


/*------------------------------------------------------*/
/* Отправка уведомления о включении в реестр квал.инвесторов */
/* BIQ-9185                                             */
/*------------------------------------------------------*/
macro ws_QI_Inclusion( Str_Param, Str_Param1, Str_Param2 )
   var res :object,
       ParamProcess :TParamProcessSlowEvent;
   var  v_FuncObjResult:FuncObjResult;
   var g_repdate = date();

   var mess, dlid, partyid;
   var v_state = 5;
   var ProcessEventTbl;
   var state_funcobj = 0;

   ParamProcess = Null;
   ParamProcess = TParamProcessSlowEvent( Str_Param2); 

   // у процедуры 3 параметра. 1 = 5070 (objecttype), 2 = partyid (objectid), 3 = строка через запятую (t_param)
   partyid = Str_Param1;

   dlid = FindFirstContract(partyid, g_repdate);
   mess = dboMessage_qi(dlid, INCLUSION_QI);
   if (mess.statsend == 0) // сформировано без ошибок
      mess.CreateMessage(false, true);
      mess.FixUQIAccreditation();
      if (mess.statsend == 1) // сообщение отправлено
         println(partyid+" "+mess.statMes);
         v_state = 4;
      elif (mess.statsend == 2) // сообщение сформировано, но не отправлено
         println(partyid+" "+mess.statMes);
      elif (mess.statsend == 3) // ошибка при создании записи в Ddlcontrmsg_Dbt
         println(partyid+" "+mess.statMes);
      else // глобальная ошибка
         println(partyid+" "+mess.statMes);
      end;
   else
      println(partyid+" "+mess.statMes);
   end;

   //установка статуса в uTableProcessEvent_dbt
   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.New_Val_Obj.T_STATUS = v_state;
   ProcessEventTbl.New_Val_Obj.T_RESULTTEXT = mess.statMes;
   ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.ProcessType;
   if( not ProcessEventTbl.Update() )
       v_FuncObjResult.errorText = "Ошибка обновления статуса в таблице событий"+ProcessEventTbl.get_service_msg;
       v_FuncObjResult.state = 1;
       v_FuncObjResult.errorCode = -1;
       return v_FuncObjResult;
   end;
   ProcessEventTbl = Null;

   ParamProcess = Null;

   return state_funcobj;

onError(err)
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;

end;

macro ws_QI_Exclusion(Str_Param, Str_Param1, Str_Param2)
   var res :object,
       ParamProcess :TParamProcessSlowEvent;
   var  v_FuncObjResult:FuncObjResult;
   var ProcessEventTbl;
   var v_recid, v_state;
   var state_funcobj = 0; 

   ParamProcess = Null;
   ParamProcess = TParamProcessSlowEvent( Str_Param2); 

   // у процедуры 3 параметра. 1 = 5071 (objecttype), 2 = recid из utableprocessevent (objectid), 3 = строка через запятую (t_param)
   v_recid = Str_Param1;
   res = RunExclusionQI(date());

   if (res.ErrorCode == 0)
      v_state = 4;
   else 
      v_state = 5;
   end;

   //установка статуса в uTableProcessEvent_dbt
   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.New_Val_Obj.T_STATUS = v_state;
   ProcessEventTbl.New_Val_Obj.T_RESULTTEXT = res.ErrorDesc;
   ProcessEventTbl.Where_Val_Obj.T_RECID = v_recid;
   if( not ProcessEventTbl.Update() )
       v_FuncObjResult.errorText = "Ошибка обновления статуса в таблице событий"+ProcessEventTbl.get_service_msg;
       v_FuncObjResult.state = 1;
       v_FuncObjResult.errorCode = -1;
       return v_FuncObjResult;
   end;
   ProcessEventTbl = Null;

   ParamProcess = Null;

   return state_funcobj;

onError(err)
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;
end;

// BIQ-7817 
// Ответ на запрос на получение активов клиента
// ИП-оффлайн
macro ws_assets_Out(pObjecttype, pObjectid, pParam)
   const C_SOFR_ASSET_IN = 33;
   const C_SOFR_ASSET_OUT = 35;
   const C_STATUS_NEW = 1;
   const C_STATUS_READY = 2;
   const C_STATUS_RUNNING = 3;
   const C_STATUS_OK = 4;
   const C_STATUS_ERROR = 5;
   
   var res,
       ParamProcess :TParamProcessSlowEvent;
   var v_FuncObjResult:FuncObjResult;
   var v_recid, v_state;
   var state_funcobj = 0; 
   var v_sql, v_cmd;
//   var vguid = CreateGUID();
   var vguid; // def-29886 получетелю не нравится наш гуид со скобками и тире, будет использовать оракловый в нижнем регистре
   var v_status_in, v_status_out, v_comment_in = "OK", v_comment_out= "";

   ParamProcess = Null;
   ParamProcess = TParamProcessSlowEvent( pParam); 
   
   v_sql = " declare "+
           "    vguid varchar2(200 char); "+
           "    vtype_out number := :p_type_out; "+
           "    vstatus number := :p_status; "+
           " begin "+
           "    vguid := lower(sys_guid()); "+
           "    insert into ISMR_DATA (batch_id, object_flow, status, date_begin) "+
           "    values (vguid, vtype_out, vstatus, sysdate ); "+
           "    :p_batch_id := vguid; "+
           " end; ";
   v_cmd = RSDCommand(v_sql);
   v_cmd.AddParam("p_type_out", RSDBP_IN, C_SOFR_ASSET_OUT);
   v_cmd.AddParam("p_status", RSDBP_IN, C_STATUS_NEW);
   v_cmd.AddParam("p_batch_id", RSDBP_OUT, V_STRING);
   v_cmd.execute;
   vguid = v_cmd.value("p_batch_id");
   v_cmd.close;
   
   res = ExecMacroFile("SendAssets.mac", "SendAssets");
   if (res == "OK")
      v_status_in = C_STATUS_OK;
      v_status_out = C_STATUS_READY;
   else
      v_status_in = v_status_out = C_STATUS_ERROR;
      v_comment_in = v_comment_out = res;
   end;

   v_sql = " update ISMR_DATA set status = :p_status, date_end = sysdate, coment = :p_comment "+
           "  where object_flow = :p_type_out and batch_id = :p_batch_id";
   v_cmd = RSDCommand(v_sql);
   v_cmd.AddParam("p_status", RSDBP_IN, v_status_out);
   v_cmd.AddParam("p_comment", RSDBP_IN, v_comment_out);
   v_cmd.AddParam("p_type_out", RSDBP_IN, C_SOFR_ASSET_OUT);
   v_cmd.AddParam("p_batch_id", RSDBP_IN, vguid);
   v_cmd.execute;
   v_cmd.close;

   // входящее событие со статусом 3 только одно
   v_sql = " update ISMR_DATA set status = :p_status_new, date_end = sysdate, coment = :p_comment "+
           "  where object_flow = :p_type_in and status = :p_status";
   v_cmd = RSDCommand(v_sql);
   v_cmd.AddParam("p_status_new", RSDBP_IN, v_status_in);
   v_cmd.AddParam("p_comment", RSDBP_IN, v_comment_in);
   v_cmd.AddParam("p_type_in", RSDBP_IN, C_SOFR_ASSET_IN);
   v_cmd.AddParam("p_status", RSDBP_IN, C_STATUS_RUNNING);
   v_cmd.execute;
   v_cmd.close;

   ParamProcess = Null;

   return state_funcobj;

onError(err)
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;
end;


macro ws_QI_TestingNQI(pObjecttype, pObjectid, pParam)
   var res,
       ParamProcess :TParamWithString;
   var v_FuncObjResult = FuncObjResult(FUNCOBJ_RESULT_OK, "", 0);
   var sql_str, cmd, rs;
   var temp_Accreditation, mess;
   var sql_str_log, cmd_log;
   var flag_send_error;
   var error_param1, error_param2;

class c_Accreditation()
   var Date_acc   : datetime;    // Дата и время прохождения тестирования  Да
   var IsSuccess  : bool;        // Признак успешности прохождения анкеты  Да
   var Code       : string;      // Код пройденной анкеты                  Да
   var groupname  : string;
end;

   ParamProcess = TParamWithString(pParam);

   sql_str = "select u.t_id, u.t_accred_date, u.t_accred_code, u.t_accred_result, g.t_groupid, g.t_comment "+
             "  from uqiaccreditation_dbt u, dobjgroup_dbt g "+
             " where g.t_objecttype = 3 and t_groupid = 200+u.t_accred_code "+
             "   and u.t_dlcontrid = :dlid and u.t_jmsmessageid = :messid and u.t_send_status <= 0 ";
   cmd = RSDCommand(sql_str);
   cmd.AddParam("dlid", RSDBP_IN, ParamProcess.ObjectId);
   cmd.AddParam("messid", RSDBP_IN, ParamProcess.Params);
   rs = RSDRecordSet(cmd);

   mess = dboMessage_qi(ParamProcess.ObjectId, TEST_QI);
   flag_send_error = false;
   while (rs.movenext)
      temp_Accreditation = c_Accreditation;
      temp_Accreditation.Date_acc = rs.value("t_accred_date");
      temp_Accreditation.Code = rs.value("t_accred_code");
      temp_Accreditation.groupname = rs.value("t_comment");
      if (StrUpr(rs.value("t_accred_result")) == StrUpr("Успешно") )
         temp_Accreditation.IsSuccess = true;
      end;
      mess.statMes = "";
      mess.statsend = 0;
      mess.statfix = 0;
      mess.fixmes = "";
      mess.uqiaccredid = rs.value("t_id");

      mess.CreateMessage(true, true, temp_Accreditation.IsSuccess, temp_Accreditation);
      mess.UpdateUQIAccreditation(rs.value("t_id"));
      if (mess.statsend == 1) 
      else  // не отправлено
         AddDBLogDebug("ws_QI_TestingNQI",mess.statMes+" "+mess.fixMes+" "+mess.statsend);// в funcobj не всегда влезает, добавим в itt
         // DEF-37221 при возникновении ошибки попробуем повторить
         v_FuncObjResult.errorText = mess.statMes+" "+mess.fixMes;
         v_FuncObjResult.state = FUNCOBJ_RESULT_REPEAT;
         v_FuncObjResult.errorCode = mess.statsend;

         //DEF-57331 посчитаем количество попыток
         var attempts = 0;
         var cmd_att = RSDRecordSet("SELECT COUNT(*) FROM UQIACCREDITATION_STEP_DBT WHERE t_accredid = "+rs.value("t_id"));
         if (cmd_att.movenext)
            attempts = cmd_att.value(0);
         end;
         cmd_att.close; cmd_att = null;

         if (attempts > 50) // уже больше 50 попыток повторений, нужно прекратить
            flag_send_error = true;
            error_param1 = "'Ошибка: по клиенту "+mess.Prt_Fnam+" не выполнено формирование сообщения о прохождении тестирования НКИ "+
                      temp_Accreditation.Code+" - "+mess.statMes+"'";
            error_param2 = "'<XML ErrorCode=\"01\" ClientCode = \""+mess.partyid+"\"/>'";
         end;
      end;  
      temp_Accreditation = null;
   end;

   if (flag_send_error)
      sql_str = " declare "+
                "   o_errtxt varchar2(2000); "+
                "   o_MsgID  itt_q_message_log.msgid%type; "+
                " begin "+
                "   IT_EVENT.RegisterEvent(NULL, 'SOFR', 'ws_QI_TestingNQI',"+error_param1+","+error_param2+" ,"+
                "   o_errtxt, o_MsgID); "+
                " end;";
      execSQL (sql_str, null, false);
      v_FuncObjResult.state = FUNCOBJ_RESULT_OK; // нужно исключить повторение совсем
   end;

   return v_FuncObjResult;
onError(err)
   v_FuncObjResult.errorText = err.message + " " + err.Module + " " + err.Line;
   v_FuncObjResult.state = FUNCOBJ_RESULT_ERROR;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;
end;


/**
@brief Обработчик задания 5160 dfuncobj_dbt
@param[in] pObjecttype Соответствует dfuncobj_dbt.t_objecttype
@param[in] pObjectid Соответствует dfuncobj_dbt.t_objectid
@param[in] pParam Соответствует dfuncobj_dbt.t_param
@param[in] pguid Системный guid
@param[in] ptaskId Соответствует dfuncobj_dbt.t_id

@return Заполненый объект вида FuncObjResult

BIQ-11556 
Формирование остатков по внебирже в служебной таблице
*/
macro ws_FillContrTable_overstock(pObjecttype, pObjectid, pParam, pguid, ptaskId)
   const C_STATUS_OK = 4;
   const C_STATUS_ERROR = 5;
   const C_STATUS_RUN = 2;
  
   var res,
       ParamProcess :TParamProcessSlowEvent;
   var v_FuncObjResult = FuncObjResult(FUNCOBJ_RESULT_OK, "", 0);
   var v_sql, v_cmd, v_reqid = 0;
   var v_status, v_comment = "OK";

   /*ParamProcess = Null;
   ParamProcess = TParamProcessSlowEvent( pParam);*/ // все равно не используем, но вдруг потом пригодится 

   //DEF-69241 Разметка начала обработки
   v_sql = String(" declare                          \n",
                  "   v_cnt number;                  \n",
                  "   v_recid number;                \n",
                  " begin                            \n",
                  "  begin                           \n",
                  "   select t_recid                 \n",
                  "     into v_recid                 \n",
                  "     from uTableProcessEvent_dbt  \n",
                  "    where t_status = :pstatus     \n",
                  "      and t_recid = :precid       \n",
                  "      and nvl(t_messageid,0) = 0  \n",
                  "     for update skip locked;      \n",
                  "   update uTableProcessEvent_dbt  \n",
                  "      set t_messageid = :ptaskid, \n",
                  "          t_lastupdate = sysdate  \n",
                  "    where t_recid = v_recid;      \n",
                  "  exception                       \n",
                  "    when no_data_found then       \n",
                  "      v_recid := 0;               \n",
                  "  end;                            \n",
                  "  :p_recid := v_recid;            \n",
                  " end;                              ");
   v_cmd = RSDCommand(v_sql);
   v_cmd.AddParam("pstatus", RSDBP_IN, C_STATUS_RUN);
   v_cmd.AddParam("precid", RSDBP_IN, pObjectid);
   v_cmd.AddParam("ptaskid", RSDBP_IN, ptaskid);
   v_cmd.AddParam("p_recid", RSDBP_OUT, V_INTEGER);
   v_cmd.execute;
   v_reqid = v_cmd.value("p_recid");
   v_cmd.close;

   if (v_reqid > 0)   //только если нашли соответствующую запись и ее разметили
      res = ExecMacroFile("Overstock.mac", "FillContrTable_overstock", pObjectid);
      if (res == "OK")
         v_status = C_STATUS_OK;
      else
         v_status = C_STATUS_ERROR;
         v_comment = res;
      end;

      // если процедура выполнилась до конца, то статусы зафиксированы внутри нее
      // если случилась оракловая ошибка запуска, то зафиксируем ошибку здесь
      if (v_status == C_STATUS_ERROR)
         v_sql = " update uTableProcessEvent_dbt set t_status = :p_status, t_lastupdate = sysdate, t_resulttext = :p_comment "+
                 "  where t_recid = :p_recid";
         v_cmd = RSDCommand(v_sql);
         v_cmd.AddParam("p_status", RSDBP_IN, v_status);
         v_cmd.AddParam("p_comment", RSDBP_IN, v_comment);
         v_cmd.AddParam("p_recid", RSDBP_IN, pObjectid);
         v_cmd.execute;
         v_cmd.close;
      end;
   end;

   ParamProcess = Null;

   return v_FuncObjResult;

onError(err)
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;
end;

macro ws_Close_Another_Contract(pObjecttype, pObjectid, pParam)
   var res :object,
       ParamProcess :TParamProcessSlowEvent;

   var  v_FuncObjResult:FuncObjResult;
   var ProcessEventTbl;
   var v_email_processor = c_email_proc_env();
   var v_recid, v_state,EMAILTEXT;
   var state_funcobj = 0; 
   var sql,cmd,rs;
   var bcc, notification;

   ParamProcess = Null;
   ParamProcess = TParamProcessSlowEvent( pParam); 

   v_recid = pObjectid;
   res = CloseAnotherContract(ParamProcess.processtype);

   if (res.errorcode == 0)
      v_state = 4;
   else 
      v_state = 5;
   end;

   //установка статуса в uTableProcessEvent_dbt
   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.New_Val_Obj.T_STATUS = v_state;
   ProcessEventTbl.New_Val_Obj.T_RESULTTEXT = res.ErrorDesc;
   ProcessEventTbl.Where_Val_Obj.T_RECID = v_recid;
   if( not ProcessEventTbl.Update() )
       v_FuncObjResult.errorText = "Ошибка обновления статуса в таблице событий"+ProcessEventTbl.get_service_msg;
       v_FuncObjResult.state = 1;
       v_FuncObjResult.errorCode = -1;
       return v_FuncObjResult;
   end;

   if(v_state == 5)

      v_FuncObjResult.errorText = res.errordesc;
      v_FuncObjResult.state = FUNCOBJ_RESULT_REPEAT;
      v_FuncObjResult.errorCode = res.errorcode;

      var p_text = "Ошибка: договор "+ParamProcess.processtype+": "+res.errordesc;

      cmd = RSDCommand("begin it_log.log_handle('Close_Another_Contract',:p_text,it_log.C_MSG_TYPE__DEBUG); end;");
      cmd.AddParam("p_text", RSDBP_IN, p_text);
      cmd.execute;
      cmd.close; cmd = null;

      if(res.errorcode == 2704) //не нулевой остаток на счете

         GetRegistryValue("РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\УВЕДОМЛЕНИЯ КЛИЕНТУ\\ДОБ.ОД В СК.КОПИЮ ПРИ ЗАКР.ДБО", V_INTEGER, notification);
         GetRegistryValue("РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\УВЕДОМЛЕНИЯ КЛИЕНТУ\\АДРЕС ОТП.В СК ОД О ЗАК.ДБО", V_STRING, bcc);

         sql = "select (select t_name from dparty_dbt where t_partyid = sf.t_partyid) as fio, sf.t_number, sf.t_datebegin, sf.t_dateclose from ddlcontr_dbt dd, dsfcontr_dbt sf where dd.t_sfcontrid = sf.t_id and dd.t_dlcontrid = :dlid";
      
         cmd = RSDCommand(sql);
         cmd.AddParam("dlid", RSDBP_IN, ParamProcess.processtype);
         rs = RSDRecordSet(cmd);
         if(rs.movenext)
            EMAILTEXT = string(" Номер договора ИИС: "+rs.value("t_number")+"",
                               "\n ФИО клиента: "+rs.value("fio")+"",
                               "\n  Дата заключения договора ИИС: "+date(rs.value("t_datebegin"))+"", 
                               "\n  Дата расторжения договора ИИС: "+{curdate}+"");
      
            v_email_processor.m_set_msg_head("О невозможности расторжения договора ИИС номер "+rs.value("t_number")+" в связи с наличием остатков по Договору клиента ФИО " +rs.value("fio"));
            v_email_processor.m_add_broker_email_to_list();
            if(notification == 1)
               v_email_processor.m_add_email_to_bcc_list(bcc);
            end;
            v_email_processor.m_add_row_to_msg_text(EMAILTEXT);
            v_email_processor.m_save_to_submit_synch();
            v_email_processor.m_submit_email_synch();
         end;
      end;
    end;


   ProcessEventTbl = Null;

   ParamProcess = Null;

   return state_funcobj;

onError(err)
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;
end;

/**
@brief Проверка на количество попыток и период выполнения
@param[in] p_recid Соответствует utableprocessevent_dbt.t_recid
@param[in] p_partyid Соответствует dparty_dbt.t_partyid
@return 1 - количество попыток/период истекли, 0 - не истекли, -1 - ошибка
*/
macro CheckTimeAndAttemptsCDI(p_recid, p_partyid)
   private CONST REG_ATTEMPTS = "РСХБ\\ИНТЕГРАЦИЯ\\ВЗАИМОДЕЙСТВИЕ С AC CDI\\КОЛИЧЕСТВО ПОПЫТОК";
   private CONST REG_PERIOD = "РСХБ\\ИНТЕГРАЦИЯ\\ВЗАИМОДЕЙСТВИЕ С AC CDI\\ИНТЕРВАЛ ПОПЫТОК";
   private CONST CV_EMAIL_GRP = 45;

   var v_attempts = 0, v_attempts_def = 0;
   var v_periods = 0, v_periods_def = 0;
   var v_time_expire;
   var v_expired = false;
   var v_servicetype = "", v_servicename = "";
   var v_resultcode = "", v_resulttext = "";
   var v_email_processor;

   var v_sql, v_cmd, v_rs;
   var stat;
   
   GetRegistryValue(REG_ATTEMPTS, V_INTEGER, v_attempts_def, stat);
   if (stat>0)
      v_attempts_def = 3;
   end;
   GetRegistryValue(REG_PERIOD, V_INTEGER, v_periods_def, stat);
   if (stat>0)
      v_periods_def = 300;
   end;

   v_sql =  " SELECT nvl(t_attempts, 0) t_attempts, t_timestamp, t_timestamp+NUMTODSINTERVAL(:period, 'SECOND') datetime_expire, "+
            "        u.t_objecttype, nvl(f.t_name,' ') t_name, "+
            "        u.t_resultcode, u.t_resulttext "+
            "   FROM utableprocessevent_dbt u, dfunc_dbt f   "+
            "  WHERE u.t_recid = :p_recid and f.t_funcid (+)= u.t_objecttype ";
   v_sql = RSDCommand(v_sql);
   v_sql.addParam("period", RSDBP_IN, v_periods_def);
   v_sql.addParam("p_recid", RSDBP_IN, p_recid);
   v_sql = RSDRecordSet(v_sql);
   if (v_sql.movenext());
      v_attempts = v_sql.value("t_attempts");
      v_time_expire = v_sql.value("datetime_expire");
      v_servicetype = v_sql.value("t_objecttype");
      v_servicename = v_sql.value("t_name");
      v_resultcode = v_sql.value("t_resultcode");
      v_resulttext = v_sql.value("t_resulttext");
   end;
   v_sql.close; v_sql = null;

   if (v_attempts == 0)
      v_expired = false; //DEF-55464 запрос должен выполниться хотя бы 1 раз до истечения срока
   else
      if (v_time_expire < dttm(date, time))
         v_expired = true;
      end;
      if (not v_expired)
         if (v_attempts >= v_attempts_def)
            v_expired = true;
         end;
      end;
   end;
   
   if (v_expired)
      if (v_resultcode == 0)
          return 1; //DEF-80581 событие было выгружено одновременно с пометкой о просрочке
      end;
      v_sql =         "UPDATE utableprocessevent_dbt ";
      v_sql = v_sql + "   SET t_status = :p_status, ";
      v_sql = v_sql + "       t_note = :p_note  ";
      v_sql = v_sql + " WHERE t_recid = :p_recid ";
      v_cmd = RSDCommand(v_sql);
      v_cmd.addParam("p_status", RSDBP_IN, 6);
      v_cmd.addParam("p_note", RSDBP_IN, "Исчерпано количество попыток");
      v_cmd.addParam("p_recid", RSDBP_IN, p_recid);
      v_cmd.execute();
      v_cmd.close(); v_cmd = NULL; v_sql = NULL;
      
      //CCBO-11192 для заблокированных субъектов события не должны повторно обрабатываться
      //тем не менее гарантировано запретим отправлять письма
      if (v_resultcode != ERROR_CODE_BLOCK_UNLOAD)
         v_email_processor = c_email_proc_env();
         v_email_processor.m_set_msg_head("СОФР. Ошибка обработки данных в AC CDI");
         v_email_processor.m_add_row_to_msg_text("Для группы СУИТ \"АС CDI DataStewards_ЮЛ_Спрвжд\".\n "+
                                                 "По сервису "+v_servicetype+" "+v_servicename+" произошла ошибка обработки данных "+v_resultcode+" "+v_resulttext+"\n"+
                                                 "Количество повторов и попыток исчерпано ");
         v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP, true);
         v_email_processor.m_submit_email_synch();
         v_email_processor = NULL;
      
         v_sql = " declare "+
                 "   o_errtxt varchar2(2000); "+
                 "   o_MsgID  itt_q_message_log.msgid%type; "+
                 " begin "+
                 "   IT_EVENT.RegisterEvent(NULL, 'SOFR', '"+v_servicename+"',"+ 
                 "     'Ошибка : по клиенту "+p_partyid+" не получен ответ от системы AC CDI из-за превышения интервала времени или количества попыток', "+
                 "     '<XML ErrorCode=\"01\" ClientCode = \""+p_partyid+"\"/>',"+
                 "   o_errtxt, o_MsgID); "+
                 " end;";
         // ошибка при логировании не должна нам мешать обработать остальные записи
         execSQL (v_sql, null, true);
      end;
      
      return 1;
   end;

   return 0;
onError
   return -1;
end;

/**
@brief Обработчик сервиса CdiFindOrg
@param[in] pObjecttype Соответствует dfuncobj_dbt.t_objecttype
@param[in] pObjectid Соответствует dfuncobj_dbt.t_objectid
@param[in] pParam Соответствует dfuncobj_dbt.t_param
@return Заполненый объект вида FuncObjResult

Обработчик проверяет необходимость обработки субъекта в CDI.
В случаи необходимости вызывает обработку запроса в CdiFindOrg.mac
Если обработка прошла успешно создает событие CdiGetOrg
*/
macro ws_CdiFindOrg(pObjecttype, pObjectid, pParam)
   var ParamProcess :c_prm_proc_contrBO_result,
       ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
       ProcessEventTblNew : c_usr_tbl_uTableProcessEvent;
   var v_FuncObjResult = FuncObjResult(FUNCOBJ_RESULT_OK, "", 0);
   var v_status;
   var v_resultcode, v_resulttext;
   var FindOrg;

   ParamProcess = Null;
   ProcessEventTbl = Null;

   ParamProcess = c_prm_proc_contrBO_result( pParam );

   var cmd, DataSet;
   var PartyObjId = -1;
   var PartyIdCDI = NULL;
   var Attempts = 0;

   cmd = RSDCommand( " SELECT event.T_OBJECTID, nvl(event.T_ATTEMPTS,0) T_ATTEMPTS  " +
                     "   FROM UTABLEPROCESSEVENT_DBT event " +
                     "  WHERE event.t_recid = :p_recid " );

   cmd.AddParam("p_recid", RSDBP_IN, ParamProcess.RecId);

   DataSet = RSDRecordSet(cmd);
   
   if (DataSet.moveNext() )
     PartyObjId = DataSet.value("T_OBJECTID");
     Attempts = DataSet.value("T_ATTEMPTS");
   end;

   if (CheckTimeAndAttemptsCDI(pObjectid, PartyObjId) != 0) // при превышении попыток событие завершается
      return v_FuncObjResult;
   end;

   cmd = RSDCommand(    " SELECT 1 " +
                        "   FROM dparty_dbt party " +
                        "  WHERE party.t_partyid = :p_partyid " +
                        "      AND (party.t_legalform = 1 " +
                        "        OR ( (SELECT a.t_nameobject " +
                        "              FROM dobjatcor_dbt  c " +
                        "                   INNER JOIN DOBJATTR_DBT a " +
                        "                       ON     a.t_groupid = c.t_groupid " +
                        "                          AND a.t_attrid = c.t_attrid " +
                        "                          AND a.t_objecttype = c.t_objecttype " +
                        "             WHERE     a.t_objecttype = 3 " +
                        "                   AND a.t_groupid = 150 " +
                        "                   AND c.t_object = LPAD (party.t_partyid, 10, '0') " +
                        "                   AND c.t_validfromdate <= :p_date " +
                        "                   AND c.t_validtodate > :p_date) IN " +
                        "               ('IE','PP') OR (select prs.t_isemployer from dpersn_dbt prs where prs.t_personid  = party.t_partyid) = chr(88) ) ) "
                       );

   cmd.AddParam("p_partyid", RSDBP_IN, PartyObjId);
   cmd.AddParam("p_date", RSDBP_IN, {curdate});

   DataSet = RSDRecordSet(cmd);
   
   if (DataSet.moveNext() )
     FindOrg = ExecMacroFile("CdiFindOrg.mac", "CdiFindOrgReq", PartyObjId, ParamProcess.RecId);
     PartyIdCDI = FindOrg.PartyIdCDI;
     v_resultcode = FindOrg.ErrorCode;
     v_resulttext = FindOrg.ErrorDesc;
     if ((PartyIdCDI != NULL) and (ValType(PartyIdCDI) != V_UNDEF))
       ProcessEventTblNew = c_usr_tbl_uTableProcessEvent;
       ProcessEventTblNew.New_Val_Obj.T_OBJECTTYPE = 5054;/*CdiGetOrg*/
       ProcessEventTblNew.New_Val_Obj.T_STATUS     = 1;
       ProcessEventTblNew.New_Val_Obj.T_OBJECTID   = PartyObjId;
       ProcessEventTblNew.New_Val_Obj.T_TYPE       = 1;
       ProcessEventTblNew.New_Val_Obj.T_TIMESTAMP  = dttm(date(), time());
       ProcessEventTblNew.New_Val_Obj.T_NOTE       = PartyIdCDI;

       if( not ProcessEventTblNew.Insert() ) 
         ProcessEventTblNew = Null;
         v_status = 5;
         v_FuncObjResult.errorText = "Ошибка вставки события 'CdiGetOrg'";
         v_FuncObjResult.state = 1;
       else 
         ProcessEventTblNew = Null;
         v_status = 4;
       end;
     else // ID CDI точно нет
       if (v_resultcode == 0)
         v_status = 4;
       else 
         if (v_resultcode == 1005)
           v_status = 1005;
         elif (v_resultcode == ERROR_CODE_BLOCK_UNLOAD)
           v_status = v_resultcode;
         else
           v_status = 5;
         end;
       end;

       if (v_status == 4)
         ProcessEventTblNew = c_usr_tbl_uTableProcessEvent;
         ProcessEventTblNew.New_Val_Obj.T_OBJECTTYPE = 5056;/*CdiCreateOrg */
         ProcessEventTblNew.New_Val_Obj.T_STATUS     = 1;
         ProcessEventTblNew.New_Val_Obj.T_OBJECTID   = PartyObjId;
         ProcessEventTblNew.New_Val_Obj.T_TYPE       = 1;
         ProcessEventTblNew.New_Val_Obj.T_TIMESTAMP  = dttm(date(), time());
         ProcessEventTblNew.New_Val_Obj.T_NOTE       = "-1";

         if( not ProcessEventTblNew.Insert() ) 
           ProcessEventTblNew = Null;
           v_FuncObjResult.errorText = "Ошибка вставки события 'CdiCreateOrg'";
           v_FuncObjResult.state = 1;
         else 
           ProcessEventTblNew = Null;
         end;
       end;
       
     end;

   else
     v_status = 4;//Если не подходят по условиям отмечаем как обработанные 
     v_resulttext = "Субъект не подходит под условия отправки в CDI";
   end;
   
   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   ProcessEventTbl.Where_Val_Obj.T_OBJECTTYPE = ParamProcess.ObjectType;
   ProcessEventTbl.New_Val_Obj.T_STATUS = v_status;
   ProcessEventTbl.New_Val_Obj.T_RESULTCODE = v_resultcode;
   ProcessEventTbl.New_Val_Obj.T_RESULTTEXT = v_resulttext;
   ProcessEventTbl.New_Val_Obj.T_ATTEMPTS = Attempts+1;
   ProcessEventTbl.New_Val_Obj.T_LASTUPDATE = dttm(date(),time());

   if( not ProcessEventTbl.Update() ) 
      v_FuncObjResult.errorText = "Ошибка обновления статуса события 'CdiFindOrg'";
      v_FuncObjResult.state = 1;
   end;

   ParamProcess = Null;
   ProcessEventTbl = Null;

   return v_FuncObjResult;

onError(err)
   ParamProcess = Null;
   ProcessEventTbl = Null;
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;
end;


/**
@brief Обработчик события 5054 - CdiGetOrg Запрос сервиса получения карточки организации по идентификатору в CDI
@param[in] pObjecttype Соответствует dfuncobj_dbt.t_objecttype
@param[in] pObjectid Соответствует dfuncobj_dbt.t_objectid
@param[in] pParam Соответствует dfuncobj_dbt.t_param
@return Заполненый объект вида FuncObjResult

Запрашивает полную информацию по субъекту в CDI, при необходимости обновляет данные в СОФР и иниициирует CdiUpdateOrg
*/
macro ws_CdiGetOrg(pObjecttype, pObjectid, pParam)
   var ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
       ProcessEventTblNew : c_usr_tbl_uTableProcessEvent;
   var v_FuncObjResult = FuncObjResult(FUNCOBJ_RESULT_OK, "", 0);
   var v_status, v_resultcode=-1, v_resulttext;
   var sql_str, cmd, rs;
   var Req, GetOrg; 
   var Attempts = 0;

   ProcessEventTbl = Null;

   var Partyid = -1;
   var PartyIdCDI = "";

   sql_str = " SELECT t_objectid, t_type, nvl(t_note, '-') t_note, nvl(t_attempts,0) t_attempts  " +
             "   FROM UTABLEPROCESSEVENT_DBT " +
             "  WHERE t_recid = :p_recid ";
   cmd = RSDCommand( sql_str );
   cmd.AddParam("p_recid", RSDBP_IN, pObjectid);
   rs = RSDRecordSet(cmd);
   
   if (rs.moveNext() )
     Partyid = rs.value("t_objectid");
     PartyIdCDI = rs.value("t_note");
     Attempts = rs.value("t_attempts");
   end;
   rs.close; rs = null;
   cmd.close; cmd = null;

   if (CheckTimeAndAttemptsCDI(pObjectid, Partyid) != 0) // при превышении попыток событие завершается
      return v_FuncObjResult;
   end;

   v_status = 5; // пессимистично
   if (Partyid > 0)
      if (PartyIdCDI != "-")
         Req = c_CdiGetOrgReqProcessor(NULL, PartyIdCDI); // первым параметром может быть код 101 (код АБС), но в ТЗ такой запрос не заявлен, поэтому считаем, что PartyidCDI должен быть заполнен
         GetOrg = CdiGetOrgReq(Req, Partyid, pObjectid);
         if (GetOrg.ErrorCode == 0)
            v_status = 4;
         else 
            if (GetOrg.ErrorCode == 1005)
               v_status = 1005;
            elif (GetOrg.ErrorCode == ERROR_CODE_BLOCK_UNLOAD)
               v_status = GetOrg.ErrorCode;
            else
               v_status = 5;
            end;
         end;
         v_resultcode = GetOrg.ErrorCode;
         v_resulttext = GetOrg.ErrorDesc;
      else 
         v_status = 5;
         v_resulttext = "Не заполнено поле t_note события t_recid="+pObjectid;
      end;
   else 
      v_status = 5;  
      v_resulttext = "Не найдены параметры записи t_recid="+pObjectid;
   end;

   if (v_status == 4) // только если все хорошо
      if (GetOrg.NeedUpdate) // только если что-то обновили
         ProcessEventTblNew = c_usr_tbl_uTableProcessEvent;
         ProcessEventTblNew.New_Val_Obj.T_OBJECTTYPE = 5055;/*CdiUpdateOrg*/
         ProcessEventTblNew.New_Val_Obj.T_STATUS     = 1;
         ProcessEventTblNew.New_Val_Obj.T_OBJECTID   = Partyid;
         ProcessEventTblNew.New_Val_Obj.T_TIMESTAMP  = dttm(date(), time());
         ProcessEventTblNew.New_Val_Obj.T_NOTE       = PartyIdCDI;
         
         if (GetOrg.IsPublishResponse)
            ProcessEventTblNew.New_Val_Obj.T_TYPE = 2; // обновление после запроса CdiPublishOrg
         else 
            ProcessEventTblNew.New_Val_Obj.T_TYPE = 1; // обновление после запроса CdiGetOrg
         end;

         if( not ProcessEventTblNew.Insert() ) 
            ProcessEventTblNew = NULL;
            v_status = 5;
            v_FuncObjResult.errorText = "Ошибка вставки события 'CdiUpdateOrg'";
            v_FuncObjResult.state = 1;
         else 
            ProcessEventTblNew = NULL;
         end;
      else 
         v_resulttext = v_resulttext+" Все параметры совпали";
      end;
   end;
   
   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.Where_Val_Obj.T_RECID = pObjectid;
   ProcessEventTbl.New_Val_Obj.T_STATUS = v_status;
   ProcessEventTbl.New_Val_Obj.T_RESULTCODE = v_resultcode;
   ProcessEventTbl.New_Val_Obj.T_RESULTTEXT = v_resulttext;
   ProcessEventTbl.New_Val_Obj.T_ATTEMPTS = Attempts+1;
   ProcessEventTbl.New_Val_Obj.T_LASTUPDATE = dttm(date(),time());   

   if( not ProcessEventTbl.Update() ) 
      v_FuncObjResult.errorText = "Ошибка обновления статуса события 'CdiGetOrg'";
      v_FuncObjResult.state = 1;
   end;

   ProcessEventTbl = NULL;

   return v_FuncObjResult;

onError(err)
   ProcessEventTbl = NULL;
   ProcessEventTblNew = NULL;
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;
end;

/**
@brief Обработчик сервиса CdiCreateOrg
@param[in] pObjecttype Соответствует dfuncobj_dbt.t_objecttype
@param[in] pObjectid Соответствует dfuncobj_dbt.t_objectid
@param[in] pParam Соответствует dfuncobj_dbt.t_param
@return Заполненный объект вида FuncObjResult

Обработчик запускает сервис CdiCreateOrg для создания субъекта в CDI.
Если обработка прошла успешно сохраняет CDI ID в соответствующею категорию
*/
macro ws_CdiCreateOrg(pObjecttype, pObjectid, pParam)
   var ParamProcess :c_prm_proc_contrBO_result,
       ProcessEventTbl :c_usr_tbl_uTableProcessEvent,
       ProcessEventTblNew : c_usr_tbl_uTableProcessEvent;
   var v_FuncObjResult = FuncObjResult(FUNCOBJ_RESULT_OK, "", 0);
   var v_status;
   var Attempts = 0;
   var v_resultcode, v_resulttext;

   ParamProcess = Null;
   ProcessEventTbl = Null;

   ParamProcess = c_prm_proc_contrBO_result( pParam );

   var cmd, DataSet;
   var PartyObjId = -1;
   var PartyIdCDI = NULL;

   cmd =  RSDCommand( " SELECT event.T_OBJECTID, nvl(event.T_ATTEMPTS,0) T_ATTEMPTS " +
                      "   FROM UTABLEPROCESSEVENT_DBT event " +
                      "  WHERE event.t_recid = :p_recid " );

   cmd.AddParam("p_recid", RSDBP_IN, ParamProcess.RecId);

   DataSet = RSDRecordSet(cmd);

   if (DataSet.moveNext() )
     PartyObjId = DataSet.value("T_OBJECTID");
     Attempts = DataSet.value("T_ATTEMPTS");
   else
     v_status = 5;
   end;

   if (CheckTimeAndAttemptsCDI(ParamProcess.RecId, PartyObjId) != 0) // при превышении попыток событие завершается
      return v_FuncObjResult;
   end;
   
   if (PartyObjId != -1)
     PartyIdCDI = ExecMacroFile("CdiCreateOrg.mac", "CdiCreateOrg", PartyObjId, ParamProcess.RecId);
     if (PartyIdCDI.cdiID > 0)
       var Party = RSBParty(PartyObjId);
       Party.Code.SetCode(PARTY_CODEKIND_CDI, PartyIdCDI.cdiID);
       if (Party.Update())
         v_status = 4;
         v_resultcode = "0";
         v_resulttext = "";
       else 
         v_FuncObjResult.errorText = v_resulttext = "Ошибка установки кода CDI";
         v_FuncObjResult.state = v_resultcode = 1;
         v_status = 5;
       end;
     else
       v_status = 5;
       v_resultcode = PartyIdCDI.ErrorCode;
       v_resulttext = PartyIdCDI.ErrorDesc;
       if (v_resultcode == ERROR_CODE_BLOCK_UNLOAD)
         v_status = v_resultcode;
       end;
     end;
   end;

   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.Where_Val_Obj.T_RECID = ParamProcess.RecId;
   ProcessEventTbl.New_Val_Obj.T_STATUS = v_status;
   ProcessEventTbl.New_Val_Obj.T_RESULTCODE = v_resultcode;
   ProcessEventTbl.New_Val_Obj.T_RESULTTEXT = v_resulttext;
   ProcessEventTbl.New_Val_Obj.T_ATTEMPTS = Attempts+1;
   ProcessEventTbl.New_Val_Obj.T_LASTUPDATE = dttm(date(),time());

   if( not ProcessEventTbl.Update() ) 
      v_FuncObjResult.errorText = "Ошибка обновления статуса события 'CdiFindOrg'";
      v_FuncObjResult.state = 1;
   end;

   ParamProcess = Null;
   ProcessEventTbl = Null;

   return v_FuncObjResult;

onError(err)
   ParamProcess = Null;
   ProcessEventTbl = Null;
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;
end;

/**
@brief Обработчик события 5055 - CdiUpdateOrg Запрос сервиса обновления карточки организации в CDI
@param[in] pObjecttype Соответствует dfuncobj_dbt.t_objecttype
@param[in] pObjectid Соответствует dfuncobj_dbt.t_objectid
@param[in] pParam Соответствует dfuncobj_dbt.t_param
@return Заполненый объект вида FuncObjResult

Обновление карточки организации в CDI, выгружается все заполненная информация в соответствии со структурой запроса
*/
macro ws_CdiUpdateOrg(pObjecttype, pObjectid, pParam)
   var ProcessEventTbl :c_usr_tbl_uTableProcessEvent;
   var v_FuncObjResult = FuncObjResult(FUNCOBJ_RESULT_OK, "", 0);
   var v_status, v_resultcode, v_resulttext;
   var sql_str, cmd, rs;
   var Req, UpdateOrg; 
   var Attempts = 0;

   ProcessEventTbl = Null;

   var Partyid = -1;
   var type = 1;
   var IsPublishResponse = false;
   var v_email_processor = c_email_proc_env();
   var v_emailtext = "", v_emailhead = "";
   var C_GROUPEMAIL_CDIDUBLICATERECORDS = 46;

   var cur_status = 0;

   sql_str = " SELECT t_objectid, t_type, nvl(t_attempts,0) t_attempts, t_status " +
             "   FROM UTABLEPROCESSEVENT_DBT " +
             "  WHERE t_recid = :p_recid ";
   cmd = RSDCommand( sql_str );
   cmd.AddParam("p_recid", RSDBP_IN, pObjectid);
   rs = RSDRecordSet(cmd);
   
   if (rs.moveNext() )
      Partyid = rs.value("t_objectid");
      type = rs.value("t_type");
      Attempts = rs.value("t_attempts");
      cur_status = rs.value("t_status");
   end;
   rs.close; rs = null;
   cmd.close; cmd = null;

   if ( (cur_status == 4) or (cur_status == 5) )
      return v_FuncObjResult;
   end;

   if (CheckTimeAndAttemptsCDI(pObjectid, Partyid) != 0) // при превышении попыток событие завершается
      return v_FuncObjResult;
   end;
   
   v_status = 5; // пессимистично
   if (Partyid > 0)
      if (type == 2) // событие было создано из CdiPublishOrg
         IsPublishResponse = true;
      else 
         IsPublishResponse = false;
      end;

      Req = c_CdiUpdateOrgReqProcessor(Partyid, IsPublishResponse); 
      //DEF-54193 если код CDI не задан, задача остается навечно в funcobj
      if (req.CdiUpdateOrgReq.Party.PartyId.ObjectId == "--1") // спец.код для ошибки
         v_status = 5;
         v_resultcode = req.CdiUpdateOrgReq.Party.PartyId.SystemId;
         v_resulttext = req.CdiUpdateOrgReq.Party.PartyId.SystemNodeId;
         if (v_resultcode == ERROR_CODE_BLOCK_UNLOAD)
            v_status = v_resultcode;
         end;
      else 
         UpdateOrg = CdiUpdateOrgReq(Req, pObjectid);
         if (UpdateOrg.ErrorCode == 0)
            v_status = 4;
         else 
            if (UpdateOrg.ErrorCode == 1005)
               v_status = 1005;
            else
               v_status = 5;
               if (UpdateOrg.ErrorCode == 4) // "Противоречивый локальный ID"
                  v_emailtext = "По субъекту "+req.CdiUpdateOrgReq.Party.ShortNameOrg+" обнаружен дубль карточки. "+
                                "\n CDI ID мастер-карточки "+req.CdiUpdateOrgReq.Party.PartyId.ObjectId+","+
                                "\n IdSOFR "+Partyid+". Необходимо провести процедуру ручного объединения карточек в СОФР";
                  v_emailhead = "СОФР. Обнаружен дубль карточки субъекта";
           
                  v_email_processor.m_set_msg_head(v_emailhead);
                  v_email_processor.m_get_email_group(C_GROUPEMAIL_CDIDUBLICATERECORDS);
                  v_email_processor.m_add_row_to_msg_text(v_emailtext);
                  v_email_processor.m_save_to_submit_grp(C_GROUPEMAIL_CDIDUBLICATERECORDS, true);
                  v_email_processor.m_submit_email_synch();
               end;
            end;
         end;
         v_resultcode = UpdateOrg.ErrorCode;
         v_resulttext = UpdateOrg.ErrorDesc;
      end;
   else 
      v_status = 5;  
      v_resultcode = -1;
      v_resulttext = "Не найдены параметры записи t_recid="+pObjectid;
   end;

   ProcessEventTbl = c_usr_tbl_uTableProcessEvent();
   ProcessEventTbl.Where_Val_Obj.T_RECID = pObjectid;
   ProcessEventTbl.New_Val_Obj.T_STATUS = v_status;
   ProcessEventTbl.New_Val_Obj.T_RESULTCODE = v_resultcode;
   ProcessEventTbl.New_Val_Obj.T_RESULTTEXT = v_resulttext;
   ProcessEventTbl.New_Val_Obj.T_ATTEMPTS = Attempts+1;
   ProcessEventTbl.New_Val_Obj.T_LASTUPDATE = dttm(date(),time());   

   if( not ProcessEventTbl.Update() ) 
      v_FuncObjResult.errorText = "Ошибка обновления статуса события 'CdiUpdateOrg'";
      v_FuncObjResult.state = 1;
   end;

   ProcessEventTbl = NULL;

   return v_FuncObjResult;

onError(err)
   ProcessEventTbl = NULL;
   v_FuncObjResult.errorText = err.message;
   v_FuncObjResult.state = 1;
   v_FuncObjResult.errorCode = err.code;
   return v_FuncObjResult;
end;

/**
@brief Проверка, нет ли других незавершенных процессов в uTableProcessIn_dbt
@param[in] pObjectid Соответствует uTableProcessIn_dbt.t_recid
@param[in] pStatus1 Фильтр на статус
@param[in] pStatus2 Фильтр на статус
@return true/false
*/
macro CheckAnotherProcessIn(pObjectid, pStatus1, pStatus2);
   var v_sql, v_cmd, v_rs;
   var v_email_processor;
   var dt, t;
   var res = true;
   
   var CV_EMAIL_GRP_CHD = 1;
   
   v_sql =         "SELECT  t_status, sysdate, t_timestamp ";
   v_sql = v_sql + "  FROM utableprocessin_dbt ";
   v_sql = v_sql + " WHERE t_objecttype = 1 ";
   v_sql = v_sql + "   AND t_recid <> :precid ";
   v_sql = v_sql + " order by 1 desc ";

   v_cmd = RSDCommand(v_sql);
   v_cmd.AddParam("precid", RSDBP_IN, pObjectid);
   v_rs = RSDRecordSet(v_cmd);
   
   if(v_rs.movenext())
      DtTmSplit(v_rs.value("sysdate"), dt, t);
      if(time(03:00:00) < t)
         if ( (v_rs.value("t_status") != pStatus1) and (v_rs.value("t_status") != pStatus2) )
            v_email_processor = c_email_proc_env();
            v_email_processor.m_set_msg_head("СОФР - Загрузка данных из Рудаты");
            v_email_processor.m_add_row_to_msg_text("Выгрузка невозможна. Одна из предыдущих задач не завершена. ");
            v_email_processor.m_save_to_submit_grp(CV_EMAIL_GRP_CHD, true);
            v_email_processor.m_submit_email();
            res = false;
         end;
      end;
   end;
   
   return res;
end;

/**
@brief Обновление задачи в uTableProcessIn со статуса 1 на статус 2
@param[in] pObjectid Соответствует uTableProcessIn_dbt.t_recid
@param[in] pStatus1 Фильтр на статус
@param[in] pStatus2 Фильтр на статус
@return true/false
*/
macro UpdateProcessIn(pObjectid, pStatus_old, pStatus_new);
   var ProcessInTbl = Null;
   var res = true;
   
   ProcessInTbl = c_usr_tbl_uTableProcessIn();
   ProcessInTbl.New_Val_Obj.T_STATUS = pStatus_new;
   ProcessInTbl.Where_Val_Obj.T_RECID = pObjectid;
   ProcessInTbl.Where_Val_Obj.T_STATUS = pStatus_old;
   if( not ProcessInTbl.Update() )
      res = false;
   end;
   ProcessInTbl = Null;
   
   return res;
end;

/**
@brief Очистка таблицы от прежних значений
@param[in] pname_task Наименование процедуры
*/
macro ClearParallelTask(precid, pname_task);
   var v_sql = null, v_cmd = null, v_rs = null;
   
   v_sql = "delete from Rudata_parallel_tmp where t_timestamp < trunc(sysdate)-15";
   v_cmd = RSDCommand(v_sql);
   v_cmd.execute();
   v_cmd.close();
   
   v_sql = null; v_cmd = null; v_rs = null;
   v_sql = "delete from Rudata_parallel_tmp where t_recid = :precid and t_name = :pname_task ";
   v_cmd = RSDCommand(v_sql);
   v_cmd.AddParam("precid", RSDBP_IN, precid);
   v_cmd.AddParam("pname_task", RSDBP_IN, pname_task);
   v_cmd.execute();
   v_cmd.close();
end;

/**
@brief Проверка всех задач за текущую дату
@param[in] pStatus1 Фильтр на статус
@param[in] pStatus2 Фильтр на статус
@param[in] precid utableprocessin_dbt.t_id
@param[in] ptotal сколько всего должно быть задач
@return статус

Если хотя бы одно задание с ошибкой, устанавливаем в utableprocessin 5.
Если количество успешных совпало с необходимым количеством, то устанавливаем в utableprocessin 4

*/
macro CheckAnotherParallelTask(pstatus_ok, pstatus_err, precid, ptotal);
   var v_sql = null, v_cmd = null, v_rs = null;
   var state = 0;
   var cnt_success = 0;
   var cnt_error = 0;
   var err_txt = "";
   
   // посчитаем количество успешных и провальных
   v_sql = "select t_name, t_status from Rudata_parallel_tmp "+
           " where t_recid = :precid ";
   v_cmd = RSDCommand(v_sql);
   v_cmd.AddParam("precid", RSDBP_IN, precid);
   v_rs = RSDRecordSet(v_cmd);
   
   while(v_rs.movenext())
      if (v_rs.value("t_status") == pstatus_ok)
         cnt_success = cnt_success + 1;
      elif (v_rs.value("t_status") == pstatus_err)
         cnt_error = cnt_error + 1;
      end;
   end;

   if (cnt_error > 0)
     state = pstatus_err;
   elif (cnt_success == ptotal)
     state = pstatus_ok;
   else 
     state = 0;
   end;

   if ( (state == pstatus_ok) or (state == pstatus_err) )
      var ProcessInTbl = Null;
      ProcessInTbl = c_usr_tbl_uTableProcessIn();
      ProcessInTbl.New_Val_Obj.T_STATUS = state;
      ProcessInTbl.Where_Val_Obj.T_RECID = precid;
      if( not ProcessInTbl.Update() ) 
         err_txt = "Не удалось обновить запись uTableProcessIn_dbt t_recid = "+precid;
         RunError(err_txt, c_usr_err_obj(err_txt)); 
      end;
      ProcessInTbl = Null;
   end;

end;

/**
@brief Вставка записи о параллельной задаче
@param[in] pname_task Наименование задачи
@param[in] pstate Статус завершения
@param[in] precid utableprocessin.t_id
*/
macro InsertParallelTask(pname_task, pstate, precid);
   var v_sql = "", v_cmd = null; 

   v_sql =         " INSERT INTO Rudata_parallel_tmp  ";
   v_sql = v_sql + "             (t_name, t_timestamp, t_status, t_recid) ";
   v_sql = v_sql + " VALUES (:name_task, sysdate, :status, :recid); ";
   v_cmd = RSDCommand(v_sql);
   v_cmd.AddParam("name_task", RSDBP_IN, pname_task);
   v_cmd.AddParam("status", RSDBP_IN, pstate);
   v_cmd.AddParam("recid", RSDBP_IN, precid);
   v_cmd.execute();
   v_cmd.close();
   v_cmd = null;
end;


// shev DEF-79638 распараллеливание загрузок из рудаты
/**
@brief загрузка общей информации о ценных бумагах из rudata
*/
macro ws_SOFR_LoadBondAndSec( pObjecttype, pObjectid, pParam, pguid, ptaskId )
   var ProcessInTbl :c_usr_tbl_uTableProcessIn,
       ParamProcess :TParamProcessSlowEvent,
       state :integer = 5,// DEF-84612  по умолчанию считаем, что задание не выполнено, если выполниться, то обновится на значение 4
       Str_Param = "";
   var v_sql, v_rs, v_cmd;
   var v_FuncObjResult = FuncObjResult(FUNCOBJ_RESULT_OK, "", 0);

   const C_PROC_STAT_READY = 2;
   const C_PROC_STAT_PROC = 3;
   const C_PROC_STAT_ARCH = 4;
   const C_PROC_STAT_ERR = 5;
   const C_TOTAL_PARALLEL_TASK = 5;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;
   ParamProcess = TParamProcessSlowEvent( Str_Param ); 
   AddLog_it("RUDATA. ws_SOFR_LoadBondAndSec Загрузка общей информации о ценных бумагах. Старт"); // BOSS-8449 

   if (not CheckAnotherProcessIn(pObjectid, C_PROC_STAT_ARCH, C_PROC_STAT_ERR))
      AddLog_it("RUDATA. ws_SOFR_LoadBondAndSec not CheckAnotherProcessIn(pObjectid, C_PROC_STAT_ARCH, C_PROC_STAT_ERR). EXIT"); // BOSS-8449 
      return v_FuncObjResult; // сразу выход без ошибок и повторов
   end;
   
   if( not UpdateProcessIn(pObjectid, C_PROC_STAT_READY, C_PROC_STAT_PROC) )
      v_FuncObjResult.errorText = "Не удалось обновить запись uTableProcessIn_dbt t_recid = "+pObjectid;
      v_FuncObjResult.state = FUNCOBJ_STATE_REPEAT_ERROR;
      v_FuncObjResult.errorCode = 42;
      AddLog_it("RUDATA. ws_SOFR_LoadBondAndSec not UpdateProcessIn(pObjectid, C_PROC_STAT_READY, C_PROC_STAT_PROC). EXIT"); // BOSS-8449 
      return v_FuncObjResult;
   end;

   if(SOFR_LoadBondAndSec)
      state = C_PROC_STAT_ARCH;
   else 
      state = C_PROC_STAT_ERR;
   end;

   AddLog_it("RUDATA. обновления справочника ценных бумаг.Старт"); // BOSS-8449
   var cmd = RSDCommand("begin rudata_read.update_fininstr; end; ");
   cmd.execute;
   cmd.close; 
   AddLog_it("RUDATA. обновления справочника ценных бумаг.Финиш");

   ClearParallelTask(pObjectid, "SOFR_LoadBondAndSec");

   InsertParallelTask("SOFR_LoadBondAndSec", state, pObjectid);
   
   CheckAnotherParallelTask(C_PROC_STAT_ARCH, C_PROC_STAT_ERR, pObjectid, C_TOTAL_PARALLEL_TASK);

   return v_FuncObjResult;

onError(err)
   ParamProcess = Null;
   ProcessInTbl = Null;
   v_FuncObjResult.errorText = GetFullErrorMessage(err,950);
   v_FuncObjResult.state = FUNCOBJ_STATE_FATAL_ERROR;
   v_FuncObjResult.errorCode = 42;
   return v_FuncObjResult;
end;

// shev DEF-79638 распараллеливание загрузок из рудаты
/**
@brief загрузка рейтингов по всем субъектам-контрагентам по сделкам
*/
macro ws_SOFR_Load_ratings( pObjecttype, pObjectid, pParam, pguid, ptaskId )
   var ProcessInTbl :c_usr_tbl_uTableProcessIn,
       ParamProcess :TParamProcessSlowEvent,
       state :integer = 5, // DEF-84612  по умолчанию считаем, что задание не выполнено, если выполниться, то обновится на значение 4
       Str_Param = "";
   var v_sql, v_rs, v_cmd;
   var v_FuncObjResult = FuncObjResult(FUNCOBJ_RESULT_OK, "", 0);
   
   const C_PROC_STAT_READY = 2;
   const C_PROC_STAT_PROC = 3;
   const C_PROC_STAT_ARCH = 4;
   const C_PROC_STAT_ERR = 5;
   const C_TOTAL_PARALLEL_TASK = 5;

   AddLog_it("RUDATA. ws_SOFR_Load_ratings Загрузка рейтингов по всем субъектам-контрагентам по сделкам.Старт"); // BOSS-8097 

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;
   ParamProcess = TParamProcessSlowEvent( Str_Param ); 

   if (not CheckAnotherProcessIn(pObjectid, C_PROC_STAT_ARCH, C_PROC_STAT_ERR))
      AddLog_it("RUDATA. ws_SOFR_Load_ratings not CheckAnotherProcessIn(pObjectid, C_PROC_STAT_ARCH, C_PROC_STAT_ERR). EXIT"); // BOSS-8097 
      return v_FuncObjResult; // сразу выход без ошибок и повторов
   end;
   
   if( not UpdateProcessIn(pObjectid, C_PROC_STAT_READY, C_PROC_STAT_PROC) )
      v_FuncObjResult.errorText = "Не удалось обновить запись uTableProcessIn_dbt t_recid = "+pObjectid;
      v_FuncObjResult.state = FUNCOBJ_STATE_REPEAT_ERROR;
      v_FuncObjResult.errorCode = 42;
      AddLog_it("RUDATA. ws_SOFR_Load_ratings not UpdateProcessIn(pObjectid, C_PROC_STAT_READY, C_PROC_STAT_PROC). EXIT"); // BOSS-8097 
      return v_FuncObjResult;
   end;
   
   if(SOFR_LoadRating)
      state = C_PROC_STAT_ARCH;
   else 
      state = C_PROC_STAT_ERR;
   end;
    
   AddLog_it("RUDATA. Oбновления справочников эмитентов.Старт"); // BOSS-8097 
   var cmd = RSDCommand("begin rudata_read.update_emitents; end; ");
   cmd.execute;
   cmd.close; 
   AddLog_it("RUDATA. Oбновления справочников эмитентов.Финиш");
  
   ClearParallelTask(pObjectid, "SOFR_LoadRating");
   
   InsertParallelTask("SOFR_LoadRating", state, pObjectid);

   CheckAnotherParallelTask(C_PROC_STAT_ARCH, C_PROC_STAT_ERR, pObjectid, C_TOTAL_PARALLEL_TASK);



   return v_FuncObjResult;

onError(err)
   ParamProcess = Null;
   ProcessInTbl = Null;
   v_FuncObjResult.errorText = GetFullErrorMessage(err,950);
   v_FuncObjResult.state = FUNCOBJ_STATE_FATAL_ERROR;
   v_FuncObjResult.errorCode = 42;
   return v_FuncObjResult;
end;

// shev DEF-79638 распараллеливание загрузок из рудаты
/**
@brief Удаление рейтингов эмитентов
*/
macro ws_SOFR_DeleteBadEmitentsRatings( pObjecttype, pObjectid, pParam, pguid, ptaskId )
   var ProcessInTbl :c_usr_tbl_uTableProcessIn,
       ParamProcess :TParamProcessSlowEvent,
       state :integer = 5, // DEF-84612  по умолчанию считаем, что задание не выполнено, если выполниться, то обновится на значение 4
       Str_Param = "";
   var v_sql, v_rs, v_cmd;
   var v_FuncObjResult = FuncObjResult(FUNCOBJ_RESULT_OK, "", 0);
   
   const C_PROC_STAT_READY = 2;
   const C_PROC_STAT_PROC = 3;
   const C_PROC_STAT_ARCH = 4;
   const C_PROC_STAT_ERR = 5;
   const C_TOTAL_PARALLEL_TASK = 5;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;
   ParamProcess = TParamProcessSlowEvent( Str_Param ); 

   if (not CheckAnotherProcessIn(pObjectid, C_PROC_STAT_ARCH, C_PROC_STAT_ERR))
      return v_FuncObjResult; // сразу выход без ошибок и повторов
   end;
   
   if( not UpdateProcessIn(pObjectid, C_PROC_STAT_READY, C_PROC_STAT_PROC) )
      v_FuncObjResult.errorText = "Не удалось обновить запись uTableProcessIn_dbt t_recid = "+pObjectid;
      v_FuncObjResult.state = FUNCOBJ_STATE_REPEAT_ERROR;
      v_FuncObjResult.errorCode = 42;
      return v_FuncObjResult;
   end;
   
   if(SOFR_DeleteBadEmitentsRatings)
      state = C_PROC_STAT_ARCH;
   else 
      state = C_PROC_STAT_ERR;
   end;
   
   ClearParallelTask(pObjectid, "SOFR_DeleteBadEmitentsRatings");
   
   InsertParallelTask("SOFR_DeleteBadEmitentsRatings", state, pObjectid);
   
   CheckAnotherParallelTask(C_PROC_STAT_ARCH, C_PROC_STAT_ERR, pObjectid, C_TOTAL_PARALLEL_TASK);

   return v_FuncObjResult;

onError(err)
   ParamProcess = Null;
   ProcessInTbl = Null;
   v_FuncObjResult.errorText = GetFullErrorMessage(err,950);
   v_FuncObjResult.state = FUNCOBJ_STATE_FATAL_ERROR;
   v_FuncObjResult.errorCode = 42;
   return v_FuncObjResult;
end;

// shev DEF-79638 распараллеливание загрузок из рудаты
/**
@brief загрузка рейтингов контрагентов из rudata
*/
macro ws_SOFR_LoadRatingRepNatAll( pObjecttype, pObjectid, pParam, pguid, ptaskId )
   var ProcessInTbl :c_usr_tbl_uTableProcessIn,
       ParamProcess :TParamProcessSlowEvent,
       state :integer = 5, // DEF-84612  по умолчанию считаем, что задание не выполнено, если выполниться, то обновится на значение 4
       Str_Param = "";
   var v_sql, v_rs, v_cmd;
   var v_FuncObjResult = FuncObjResult(FUNCOBJ_RESULT_OK, "", 0);
   
   const C_PROC_STAT_READY = 2;
   const C_PROC_STAT_PROC = 3;
   const C_PROC_STAT_ARCH = 4;
   const C_PROC_STAT_ERR = 5;
   const C_TOTAL_PARALLEL_TASK = 5;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;
   ParamProcess = TParamProcessSlowEvent( Str_Param ); 

   if (not CheckAnotherProcessIn(pObjectid, C_PROC_STAT_ARCH, C_PROC_STAT_ERR))
      return v_FuncObjResult; // сразу выход без ошибок и повторов
   end;
   
   if( not UpdateProcessIn(pObjectid, C_PROC_STAT_READY, C_PROC_STAT_PROC) )
      v_FuncObjResult.errorText = "Не удалось обновить запись uTableProcessIn_dbt t_recid = "+pObjectid;
      v_FuncObjResult.state = FUNCOBJ_STATE_REPEAT_ERROR;
      v_FuncObjResult.errorCode = 42;
      return v_FuncObjResult;
   end;
   
   if(SOFR_LoadRatingRepNatAll)
      state = C_PROC_STAT_ARCH;
   else 
      state = C_PROC_STAT_ERR;
   end;
   
   ClearParallelTask(pObjectid, "SOFR_LoadRatingRepNatAll");
   
   InsertParallelTask("SOFR_LoadRatingRepNatAll", state, pObjectid);
   
   CheckAnotherParallelTask(C_PROC_STAT_ARCH, C_PROC_STAT_ERR, pObjectid, C_TOTAL_PARALLEL_TASK);

   return v_FuncObjResult;

onError(err)
   ParamProcess = Null;
   ProcessInTbl = Null;
   v_FuncObjResult.errorText = GetFullErrorMessage(err,950);
   v_FuncObjResult.state = FUNCOBJ_STATE_FATAL_ERROR;
   v_FuncObjResult.errorCode = 42;
   return v_FuncObjResult;
end;

// shev DEF-79638 распараллеливание загрузок из рудаты
/**
@brief загрузка рейтингов стран из rudata
*/
macro ws_SOFR_LoadRatingAllCountrys(  pObjecttype, pObjectid, pParam, pguid, ptaskId )
   var ProcessInTbl :c_usr_tbl_uTableProcessIn,
       ParamProcess :TParamProcessSlowEvent,
       state :integer = 5, // DEF-84612  по умолчанию считаем, что задание не выполнено, если выполниться, то обновится на значение 4
       Str_Param = "";
   var v_sql, v_rs, v_cmd;
   var v_FuncObjResult = FuncObjResult(FUNCOBJ_RESULT_OK, "", 0);
   
   const C_PROC_STAT_READY = 2;
   const C_PROC_STAT_PROC = 3;
   const C_PROC_STAT_ARCH = 4;
   const C_PROC_STAT_ERR = 5;
   const C_TOTAL_PARALLEL_TASK = 5;

   if( not GetParm(2, Str_Param) )
      Str_Param = "";
   end;
   ParamProcess = TParamProcessSlowEvent( Str_Param ); 

   if (not CheckAnotherProcessIn(pObjectid, C_PROC_STAT_ARCH, C_PROC_STAT_ERR))
      return v_FuncObjResult; // сразу выход без ошибок и повторов
   end;
   
   if( not UpdateProcessIn(pObjectid, C_PROC_STAT_READY, C_PROC_STAT_PROC) )
      v_FuncObjResult.errorText = "Не удалось обновить запись uTableProcessIn_dbt t_recid = "+pObjectid;
      v_FuncObjResult.state = FUNCOBJ_STATE_REPEAT_ERROR;
      v_FuncObjResult.errorCode = 42;
      return v_FuncObjResult;
   end;
   
   if(SOFR_LoadRatingAllCountrys)
      state = C_PROC_STAT_ARCH;
   else 
      state = C_PROC_STAT_ERR;
   end;
   
   ClearParallelTask(pObjectid, "SOFR_LoadRatingAllCountrys");
   
   InsertParallelTask("SOFR_LoadRatingAllCountrys", state, pObjectid);
   
   CheckAnotherParallelTask(C_PROC_STAT_ARCH, C_PROC_STAT_ERR, pObjectid, C_TOTAL_PARALLEL_TASK);

   return v_FuncObjResult;

onError(err)
   ParamProcess = Null;
   ProcessInTbl = Null;
   v_FuncObjResult.errorText = GetFullErrorMessage(err,950);
   v_FuncObjResult.state = FUNCOBJ_STATE_FATAL_ERROR;
   v_FuncObjResult.errorCode = 42;
   return v_FuncObjResult;
end;


private class TParamProcessPackSec( StrParam :string )
   var number_pack :integer = 0,
       funcid :integer = 0,
       sys_guid :string = "",
       FlAll :integer = 0,
       Mode :integer = 0,
       StrLSIN_ISIN :string = "-",
       Force : string = "False",
       LoadBase : string = "False",
       needcdi :string = "False",
       cdi_isactive :string = "False";

   private var StrSeparator :string = ";";

   private macro InitParam( StrParam :string )
      var StrDigit :string = "0123456789",
          StrParamBuf :string = "",
          i :integer = 0,
          StrPos :integer = 0;

      if( (Valtype(StrParam) != V_UNDEF) and (Valtype(StrParam) != 26) and (StrParam != "") )
         StrParamBuf = StrParam;
         i = 0;
         while( (StrLen(StrParamBuf) > 0) and (GenNumProps(this) > i) ) //заполняем свойства
            StrPos = Index( StrParamBuf, StrSeparator );
            if( StrPos > 1 )
               this[i] =  Substr(StrParamBuf, 1, StrPos - 1);
               StrParamBuf = Substr(StrParamBuf, StrPos + 1);
            elif( (StrPos == 0) and (StrLen(StrParamBuf) > 0) )
               this[i] = StrParamBuf;
               StrParamBuf = "";
            end;
            i = i + 1;

         end;

      end;

   onError(err)
      funcid = 0;
   end;

   InitParam( StrParam );

end;

//DEF-79638
macro ws_SOFR_LoadPackSec(pObjecttype, pObjectid, pParam, pguid, ptaskId)
   const C_STATUS_OK = 4;
   const C_STATUS_ERROR = 5;
   const C_STATUS_RUN = 2;
  
   var res,
       ParamProcess :TParamProcessPackSec;
   var v_FuncObjResult = FuncObjResult(FUNCOBJ_RESULT_OK, "", 0);

   var v_sql, v_cmd, pack_DataSet, emit_DataSet;
   var err;
   var i = 0;

   ParamProcess = Null;
   ParamProcess = TParamProcessPackSec( pParam);

   //строка параметров именно строка
   var Force = iif(StrLwr(ParamProcess.Force)=="true",true,false);
   var LoadBase = iif(StrLwr(ParamProcess.LoadBase)=="true",true,false);
   var needcdi = iif(StrLwr(ParamProcess.needcdi)=="true",true,false);
   var cdi_isactive = iif(StrLwr(ParamProcess.cdi_isactive)=="true",true,false);


   AddLog_it("RUDATA. Начало загрузки. Пачка="+string(ParamProcess.number_pack)+" guid="+ParamProcess.sys_guid); // DEF-56847, логируем загрузку по каждой бумаге

   v_sql = "select "+RUDATA_SECURITIES_ALL_FIELDS+" from rudata_securities r where session_guid = :p_guid "+
           " and number_pack = :p_number_pack and nvl(status,'E') != 'X' ";
   v_cmd = RSDCommand(v_sql);
   v_cmd.AddParam("p_guid", RSDBP_IN, ParamProcess.sys_guid);
   v_cmd.AddParam("p_number_pack", RSDBP_IN, ParamProcess.number_pack);
   pack_DataSet = RSDRecordSet(v_cmd);
   while (pack_DataSet.movenext)
      i = i+1;
      AddLog_it("RUDATA. i="+string(i)+", isin="+pack_DataSet.value("ISINCODE", Null, V_STRING)+" Пачка="+string(ParamProcess.number_pack)+" guid="+ParamProcess.sys_guid); // DEF-56847, логируем загрузку по каждой бумаге
      LoadOne(ParamProcess.FlAll, ParamProcess.Mode, ParamProcess.StrLSIN_ISIN, 
              pack_DataSet, Force, @err, LoadBase, needcdi, cdi_isactive);
   end;

   AddLog_it("RUDATA. Рейтинги эмитентов. Пачка="+string(ParamProcess.number_pack)+" guid="+ParamProcess.sys_guid);

   // общий список загруженных эмитентов
   LoadRating( null, null, true ); //рейтинг эмитента

   AddLog_it("RUDATA. Рейтинги эмитентов для отчетности - начало. Пачка="+string(ParamProcess.number_pack)+" guid="+ParamProcess.sys_guid);

   v_sql = "  SELECT Partyid, ISSUERUID from USR_RUDATA_LIST_EMITENT ";
   emit_DataSet = RsdRecordSet( v_sql);
   while ( emit_DataSet.MoveNext )
      LoadRatingRepNat( emit_DataSet.value(0), emit_DataSet.value(1), 122, 5037, false ); //рейтинг эмитента в нац валюте для отчетов
      LoadRatingRepNat( emit_DataSet.value(0), emit_DataSet.value(1), 123, 5038, false ); //рейтинг эмитента в ин валюте для отчетов

      LoadRatingRepMoodys( emit_DataSet.value(0), emit_DataSet.value(1), 122, false );
      LoadRatingRepMoodys( emit_DataSet.value(0), emit_DataSet.value(1), 123, false );

      LoadRatingRepNat( emit_DataSet.value(0), emit_DataSet.value(1), 122, 5041, true ); //рейтинг эмитента в нац валюте для отчетов по 3485
      LoadRatingRepNat( emit_DataSet.value(0), emit_DataSet.value(1), 123, 5042, true ); //рейтинг эмитента в ин валюте для отчетов по 3485

      LoadRatingRepMoodys( emit_DataSet.value(0), emit_DataSet.value(1), 122, true );
      LoadRatingRepMoodys( emit_DataSet.value(0), emit_DataSet.value(1), 123, true );
      
      LoadRating2014( emit_DataSet.value(0) ); //рейтинг эмитента архив
   end;

   AddLog_it("RUDATA. Рейтинги эмитентов для отчетности - окончание. Пачка="+string(ParamProcess.number_pack)+" guid="+ParamProcess.sys_guid);

   ParamProcess = Null;

   return v_FuncObjResult;

onError(err)

   v_sql = "update rudata_securities set status = 'E' "+
           " where session_guid = :p_guid and number_pack = :p_number_pack and status is null";
   v_cmd = RSDCommand(v_sql);
   v_cmd.AddParam("p_guid", RSDBP_IN, ParamProcess.sys_guid);
   v_cmd.AddParam("p_number_pack", RSDBP_IN, ParamProcess.number_pack);
   v_cmd.execute();
   v_cmd.close();

   v_FuncObjResult.errorText = GetFullErrorMessage(err,950);
   v_FuncObjResult.state = FUNCOBJ_STATE_REPEAT_ERROR;
   v_FuncObjResult.errorCode = err.code;

   AddLog_it("RUDATA. Ошибка выполнения. Пачка="+string(ParamProcess.number_pack)+" guid="+ParamProcess.sys_guid+" "+
             v_FuncObjResult.errorText);

   return v_FuncObjResult;

end;