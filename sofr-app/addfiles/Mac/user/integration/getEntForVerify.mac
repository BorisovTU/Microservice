//А.Киселев 03.09.2018 Сервис получения данных по проводкам для сверки 7.2.15.
//GetEntriesForVerify
//!!!!!!!!!!!!Все восклицательные знаки должны быть обработанны в соответствии с текстом комментария и удалены

import likepy, oralib;

private const UNIVERSAL_ERROR_CODE:integer  = -3001;

private class TConditions
 var DateIn   :date,
     DateOut  :date,
     BrancID  :string = "", // обязательное: Нет
     PersonalNumber :string = ""; // обязательное: Нет
end;

private class TEntry
 var EntryId :string = "", // обязательное: Нет
     ReferenceId :string = "", // обязательное: Нет
     DebitAccount :string = "", // обязательное: Нет
     CreditAccount :string = ""; // обязательное: Нет
end;


//параметры запроса из RS-Securities СОФР
private class TGetEntriesForVerifyReq( DataSet :RsdRecordset )
 var ReqID :string = "",
     Conditions :TConditions = TConditions(),
     EntriesList :TArray = TArray();

 private macro ThrowException( Message :string, ErrorCode :integer)

  if(ErrorCode == null)
   RunError( Message, UNIVERSAL_ERROR_CODE );
  end;

  RunError( Message, ErrorCode );
 end;


 //заполнение входящего параметра-объекта
 private macro InitPropertyReq( DataSet :RsdRecordset )
 private var ErrMsg :string = "",
             i :integer = 0,
             EntObj :TEntry = TEntry();;


   ErrMsg = "В сервисе \"GetEntriesForVerifyReq\" ";

   if( ( DataSet == null ) or ( not DataSet.MoveNext ) )
    ThrowException( ErrMsg + "не получен объект TGetEntriesForVerifyReq" );
   end;

   if( (ValType(DataSet.Value(0, Null, V_STRING)) == V_UNDEF) or (ValType(DataSet.Value(0, Null, V_STRING)) == 26) and (DataSet.Value(0, Null, V_STRING) == null) )
    ThrowException( ErrMsg + "не получен обязательный параметр \"ReqID\"" );
   elif( (ValType(DataSet.Value(1, Null, V_DATE)) == V_UNDEF) or (ValType(DataSet.Value(1, Null, V_DATE)) == 26) or (DataSet.Value(1, Null, V_DATE) == null)
     or (DataSet.Value(1, Null, V_DATE) == date("00.00.00")) )
    ThrowException( ErrMsg + "не получен обязательный параметр \"DateIn\"" );
   elif( (ValType(DataSet.Value(2, Null, V_DATE)) == V_UNDEF) or (ValType(DataSet.Value(2, Null, V_DATE)) == 26) or (DataSet.Value(2, Null, V_DATE) == null) 
     or (DataSet.Value(2, Null, V_DATE) == date("00.00.00")) )
    ThrowException( ErrMsg + "не получен обязательный параметр \"DateIn\"" );
   else
    ReqID = DataSet.Value(0, Null, V_STRING);
    Conditions.DateIn = DataSet.Value(1, Null, V_DATE);
    Conditions.DateOut = DataSet.Value(2, Null, V_DATE);

    if( (ValType(DataSet.Value(3, Null, V_STRING)) != V_UNDEF) and (ValType(DataSet.Value(3, Null, V_STRING)) != 26) and (DataSet.Value(3, Null, V_STRING) != null) )
     Conditions.BrancID = DataSet.Value(3, Null, V_STRING);
    end;

    if( (ValType(DataSet.Value(4, Null, V_STRING)) != V_UNDEF) and (ValType(DataSet.Value(4, Null, V_STRING)) != 26) and (DataSet.Value(4, Null, V_STRING) != null) )
     Conditions.PersonalNumber = DataSet.Value(4, Null, V_STRING);
    end;

   end;


   i = 0;
   while( (i == 0) or (DataSet.MoveNext) )

    if( (ValType(DataSet.Value(5, Null, V_STRING)) != V_UNDEF) and (ValType(DataSet.Value(5, Null, V_STRING)) != 26) and (DataSet.Value(5, Null, V_STRING) != null) )
     EntObj.EntryId = DataSet.Value(5, Null, V_STRING);
    end;

    if( (ValType(DataSet.Value(6, Null, V_STRING)) != V_UNDEF) and (ValType(DataSet.Value(6, Null, V_STRING)) != 26) and (DataSet.Value(6, Null, V_STRING) != null) )
     EntObj.ReferenceId = DataSet.Value(6, Null, V_STRING);
    end;

    if( (ValType(DataSet.Value(7, Null, V_STRING)) != V_UNDEF) and (ValType(DataSet.Value(7, Null, V_STRING)) != 26) and (DataSet.Value(7, Null, V_STRING) != null) )
     EntObj.DebitAccount = DataSet.Value(7, Null, V_STRING);
    end;

    if( (ValType(DataSet.Value(8, Null, V_STRING)) != V_UNDEF) and (ValType(DataSet.Value(8, Null, V_STRING)) != 26) and (DataSet.Value(8, Null, V_STRING) != null) )
     EntObj.CreditAccount = DataSet.Value(8, Null, V_STRING);
    end;


    EntriesList[i] = EntObj;
    EntObj = Null;

    i = i + 1;
   end;


 end;

 InitPropertyReq(DataSet) //конструктор

end;

//получим курсор из таблиц RS-Securities СОФР
private macro GetDataSetForEntVerify :RsdRecordset;

var Query :string = "",
    DataSet :RsdRecordset,
    Params :TArray;

 //запрос к буферным таблицам!!!!!!!!!!!!!!!!!!!!!!!! запрос тестовый
 Query = " SELECT 'LKHLH9869KLHK8768' AS T_REQID, TO_DATE('05092018', 'ddmmyyyy') AS T_DATEIN, TO_DATE('03092018', 'ddmmyyyy') AS T_DATEOUT, " +
         "  '' AS T_BRANCID, '' AS T_PERSONALNUMBER, '' AS T_ENTRYID, TO_CHAR(T_ACCTRNID) AS T_REFERENCEID, " +
         "  T_ACCOUNT_PAYER AS DEBITACCOUNT, T_ACCOUNT_RECEIVER AS CREDITACCOUNT " +
         " FROM dacctrn_dbt " +
         " WHERE T_CHAPTER = :Ch " +
         "  AND T_FIID_PAYER = :Fiid_1 " +
         "  AND T_FIID_RECEIVER = :Fiid_2 " +
         "  AND ( T_ACCOUNT_PAYER LIKE :AccMask_1 OR T_ACCOUNT_RECEIVER LIKE :AccMask_2 )";
 DataSet = Null;
 Params = Null;

 Params = makeArray( SQLParam("Ch", 1),
                     SQLParam("Fiid_1", 0),
                     SQLParam("Fiid_2", 0),
                     SQLParam("AccMask_1", "40702%"),
                     SQLParam("AccMask_2", "40702%"));
 DataSet = execSQLselect( Query, Params );

 Params = Null;

 return DataSet;
end;
//получим курсор из таблиц RS-Securities СОФР


//процедура запроса данных по проводкам для сверки вызов из RS-Secirities
macro GetEntriesForVerifyReq( /*RequestObj :object*/ ) //входные данные заполненные буферные таблицы
var ResponseObj :object = TGetEntriesForVerifyReq( GetDataSetForEntVerify );
  
// а здесь мы должны что-то куда-то положить или дернуть процедуру получения данных по проводкам для сверки а параметры объект ResponseObj!!!!!!!!!!!!

 ResponseObj = Null;
 return true;

onError(err)

/*!!!!!!!!!!!!!!!обработка ошибок тоже не ясно
   out_code = c_err_obj.obtain_err_code(err);
   err_txt = c_err_obj.obtain_err_msg(err);

   resp_data_obj = c_outObj;
   resp_data_obj.ActiveContract_resp.ReqID = XmlRpcRequestId; 
   resp_data_obj.ActiveContract_resp.SenderId = req_data_obj.SenderID;
   resp_data_obj.ActiveContract_resp.Result.code = out_code;
   resp_data_obj.ActiveContract_resp.Result.text = err_txt;

   out_str = req_msg_obj.sec_internal_resp(resp_data_obj);
   return out_str;
*/

 return false;

end;
//процедура запроса данных по проводкам для сверки вызов из RS-Secirities




GetEntriesForVerifyReq( /*RequestObj :object*/ ); //!!!!!!!!!!!!!!!!это только для тестирования


/*
скрипты получения данных из LoadEnriesForVerify таблиц RS-Securities СОФР


*/
