//А.Киселев 08.11.2018
import globals, oralib, likepy;

//функция вставки задания в очередь для пользовательских объектов
macro InsertSequenceJobUsrObj( ReqId :integer, ObjectType :integer, ProcessType :integer, ObjectTypeCode :string, UserObjId :integer, 
   Priority :variant ) :integer

var Query :string = "",
    Params :TArray,
    DataSet :RsdCommand;



  if( ( Valtype(UserObjId) == V_UNDEF ) or ( Valtype(UserObjId) == 26 )  )
   UserObjId = 0;
  end;

  if( ( Valtype(Priority) == V_UNDEF ) or ( Valtype(Priority) == 26 )  )
   Priority = 0;
  end;


  Params = Null;
  DataSet = Null;
//переделан objects на пользовательский справочник llvalues
/*
  Query = " INSERT INTO dfuncobj_dbt( T_OBJECTTYPE, T_OBJECTID, T_FUNCID, T_PARAM, T_PRIORITY ) " +
          "  ( SELECT B.T_OBJECTTYPE, :p_ObjectId, A.T_FUNCID, TO_CHAR(:p_ObjectId_1) || ';' || TO_CHAR(:p_ObjectType) || ';' || TO_CHAR(:p_ProcessType), " +
          "     :p_Priority AS T_PRIORITY " +
          "    FROM dfunc_dbt A, dobjects_dbt B " +
          "    WHERE A.T_FUNCID = B.T_USERNUMBER " +
          "     AND B.T_CODE = :p_ObjectTypeCode " +  //T_CODE не должен повторяться иначе переделать запрос
          "     AND B.T_OBJECTTYPE >= 5001 )";
*/
  Query = " INSERT INTO dfuncobj_dbt( T_OBJECTTYPE, T_OBJECTID, T_FUNCID, T_PARAM, T_PRIORITY ) " +
          "  ( SELECT B.T_ELEMENT, :p_ObjectId,( CASE WHEN :p_UserObjId > 0 THEN :p_UserObjId_1 ELSE A.T_FUNCID END ), TO_CHAR(:p_ObjectId_1) || ';' || TO_CHAR(:p_ObjectType) || ';' || TO_CHAR(:p_ProcessType), " +
          "     :p_Priority AS T_PRIORITY " +
          "    FROM dfunc_dbt A, dllvalues_dbt B " +
          "    WHERE A.T_FUNCID = B.T_FLAG " +
          "     AND B.T_LIST = USR_PKG_IMPORT_SOFR.GetOBJECT_SYNCH " +
          "     AND B.T_CODE = :p_ObjectTypeCode " +  //T_CODE не должен повторяться иначе переделать запрос
          "     AND B.T_ELEMENT >= 5001 )";

  Params = makeArray( SQLParam( "p_ObjectId", ReqId ),
                      SQLParam( "p_UserObjId", UserObjId ),
                      SQLParam( "p_UserObjId_1", UserObjId ),
                      SQLParam( "p_ObjectId_1", ReqId ),
                      SQLParam( "p_ObjectType", ObjectType ),
                      SQLParam( "p_ProcessType", ProcessType ),
                      SQLParam( "p_Priority", Priority ),
                      SQLParam( "p_ObjectTypeCode", ObjectTypeCode ) );
  DataSet = execSQL( Query, Params );


  Params = Null;
  DataSet = Null;
  
  return 0;

onError(err)

  DataSet = Null;

  return 1

end;


//функция вставки задания в очередь для дистрибутивных объектов
macro InsertSequenceJobDstrObj( ReqId :integer, ObjectType :integer, ObjectId :integer, ProcessType :integer,
  Priority :variant ) :integer
   private const CV_STATUS_EVNT_CRE = 1;

var Query :string = "",
    Params :TArray,
    DataSet :RsdCommand;


  if( ( Valtype(Priority) == V_UNDEF ) or ( Valtype(Priority) == 26 )  )
   Priority = 0;
  end;

  Params = Null;
  DataSet = Null;
//переделан objects на пользовательский справочник llvalues
/*
  Query = " INSERT INTO dfuncobj_dbt( T_OBJECTTYPE, T_OBJECTID, T_FUNCID, T_PARAM, T_PRIORITY ) " +
          "  ( SELECT B.T_OBJECTTYPE, :p_ObjectId,  A.T_FUNCID, TO_CHAR (:p_ObjectId_1) || ';' || TO_CHAR ( B.T_OBJECTTYPE ) || ';' || TO_CHAR (:p_ObjectId_2) " +
          "     || ';' || TO_CHAR (:p_ProcessType), " +
          "     :p_Priority AS T_PRIORITY " +
          "    FROM dfunc_dbt A, dobjects_dbt B " +
          "    WHERE A.T_FUNCID = B.T_USERNUMBER " +
          "     AND B.T_OBJECTTYPE = :p_ObjectType " +
          "     AND NOT EXISTS( SELECT 1 FROM dfuncobj_dbt C " +
          "                   WHERE C.T_OBJECTID = :p_ObjectId_3 " +
          "                    AND C.T_OBJECTTYPE = B.T_OBJECTTYPE " +
          "                    AND C.T_FUNCID = B.T_USERNUMBER " +
          "                    AND C.T_STATE IN(0, 20, 1) ) )";
*/

  Query = " INSERT INTO dfuncobj_dbt( T_OBJECTTYPE, T_OBJECTID, T_FUNCID, T_PARAM, T_PRIORITY ) " +

//А.Киселев 22.05.2019 для объекта 5009
//          "  ( SELECT B.T_ELEMENT, :p_ObjectId, A.T_FUNCID, TO_CHAR (:p_ObjectId_1) || ';' || TO_CHAR ( B.T_ELEMENT ) || ';' || TO_CHAR (:p_ObjectId_2) " +
//          "     || ';' || TO_CHAR (:p_ProcessType) " +

            "  ( SELECT B.T_ELEMENT, :p_ObjectId, A.T_FUNCID, " +
            "     (CASE WHEN ( B.T_ELEMENT = 5009 OR B.T_ELEMENT = 5008 OR B.T_ELEMENT = 5030) THEN " +  //shev добавил 5030
            "       TO_CHAR (:p_ObjectId_1_1) || ';' || TO_CHAR ( B.T_ELEMENT ) || ';' ||( SELECT D.T_PARAM FROM utableprocessevent_dbt D " +
            "                                                                              WHERE D.T_RECID = :p_recid_1) " +
            "      ELSE TO_CHAR (:p_ObjectId_1) || ';' || TO_CHAR ( B.T_ELEMENT ) || ';' || TO_CHAR (:p_ObjectId_2) " +
            "       || ';' || TO_CHAR (:p_ProcessType) " +
                  
            "      END " +
            "     ) AS T_PARAM, " +
//А.Киселев 22.05.2019 для объекта 5009
          "     :p_Priority AS T_PRIORITY " +
          "    FROM dfunc_dbt A, dllvalues_dbt B " +
          "    WHERE A.T_FUNCID = B.T_FLAG " +
          "     AND B.T_LIST = USR_PKG_IMPORT_SOFR.GetOBJECT_SYNCH " +
          "     AND B.T_ELEMENT = :p_ObjectType " +
          "     AND NOT EXISTS( SELECT 1 FROM dfuncobj_dbt C " +
          "                   WHERE C.T_OBJECTID = :p_ObjectId_3 " +
          "                    AND C.T_OBJECTTYPE = B.T_ELEMENT " +
          "                    AND C.T_FUNCID = B.T_FLAG " +
          "                    AND C.T_STATE IN(0, 20, 1) ) " +
          "     AND EXISTS (SELECT 1 FROM utableprocessevent_dbt src_evnt " +
          "                  WHERE src_evnt.t_recid = :p_recid " +
          "                    AND src_evnt.t_status = :p_status) ) ";

  Params = makeArray( SQLParam( "p_ObjectId", ReqId ),
                      SQLParam( "p_ObjectId_1_1", ReqId ),
                      SQLParam( "p_recid_1", ReqId ),
                      SQLParam( "p_ObjectId_1", ReqId ),
                      SQLParam( "p_ObjectId_2", ObjectId ),
                      SQLParam( "p_ProcessType", ProcessType ),
                      SQLParam( "p_Priority", Priority ),
                      SQLParam( "p_ObjectType", ObjectType ),
                      SQLParam( "p_ObjectId_3", ReqId ),
                      SQLParam( "p_recid", ReqId ),
                      SQLParam( "p_status", CV_STATUS_EVNT_CRE) );
  DataSet = execSQL( Query, Params );

  Params = Null;
  DataSet = Null;
  
  return 0;

onError(err)

  DataSet = Null;

  return 1

end;



