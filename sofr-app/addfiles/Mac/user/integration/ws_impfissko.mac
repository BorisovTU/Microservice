///////////////////////////////////////////////////////////////////////////////////
//*******************************************************************************//
//*  Модуль           : Импорт на базе макроса Шлюза                            *//
//*  Имя файла        : dl_impfissko.mac                                        *//	
//*  Описание         : Загрузка КО сделок в бэк-офис из шлюза                  *//
//*  Программист      : LKL                                                     *//
//*                   : GYA адаптация для web-сервиса                           *//
//*******************************************************************************//
///////////////////////////////////////////////////////////////////////////////////
IMPORT DealsInter, Проценты, PTInter, PaymInter, "gtconst.inc","rgtgtrec.mac", "gtdlfun.mac", "dlref.mac", OprInter, SfInter, 
       FIInter, Календарь, funk, dl_lib, dl_note_lib;

VAR ER,basi;
const BOKIND=4813;
const BOKINDT3=4815;
const DEALTYPE=ПИКО_ПокупкаПродажа; //2730;


private macro GetFiidByISOCode(code,codekind)
    var sql,rs;

    //if (code=="RUB") code="RUR"; end;
    sql = " SELECT f.t_Fiid fiid "
    + " FROM dfininstr_dbt f "
    + " WHERE f.t_ccy = '"+code+"' AND f.t_fi_kind = " + codekind;

    rs = ExecSqlSelect(sql, MakeArray(SqlParam("1", code),SqlParam("2",codekind)), false);
    if (rs.MoveNext())
        return rs.value("fiid");
    else
        return null;
    end;
end;

private macro AddField (ar, name, tp, sz, dec)

     ar [ar.size] = name;
     ar [ar.size] = tp;
     ar [ar.size] = sz;
     ar [ar.size] = dec;
     ar [ar.size] = 0;

end;


macro MakeArDeal()

      var ardeal = TArray;

      AddField (ardeal, "DEALID",   V_STRING,  10, 0);
      AddField (ardeal, "DEALTYPE", V_INTEGER,  4, 0);
      AddField (ardeal, "SOGL",     V_INTEGER,  4, 0);
      AddField (ardeal, "NUMBER",   V_STRING,  10, 0);
      AddField (ardeal, "VNUMBER",  V_STRING,  10, 0);
      AddField (ardeal, "DEALDATE", V_STRING,  11, 0);
      AddField (ardeal, "CONTR",    V_INTEGER,  4, 0);
      AddField (ardeal, "FILIAL",   V_INTEGER,  4, 0);
      AddField (ardeal, "BDATE1",   V_STRING,  11, 0);
      AddField (ardeal, "PFI1",     V_STRING,  11, 0);
      AddField (ardeal, "PRINCIPAL1",V_STRING, 10, 0);
      AddField (ardeal, "KDATE1",   V_STRING,  11, 0);
      AddField (ardeal, "CFI1",     V_STRING,  10, 0);
      AddField (ardeal, "COST1",    V_STRING,  10, 0);
      AddField (ardeal, "RATE1",    V_STRING,  10, 0);    
      AddField (ardeal, "BDATE2",   V_STRING,  11, 0);
      AddField (ardeal, "PRINCIPAL2",V_STRING, 10, 0);
      AddField (ardeal, "KDATE2",   V_STRING,  11, 0);
      AddField (ardeal, "COST2",    V_STRING,  10, 0);
      AddField (ardeal, "RATE2",    V_STRING,  10, 0);    
      AddField (ardeal, "CLIENT" ,  V_INTEGER,  4, 0);     
      AddField (ardeal, "CONTRACT", V_STRING,  50, 0);    
      AddField (ardeal, "DILER",    V_INTEGER,  4, 0);
      AddField (ardeal, "BROKER",   V_INTEGER,  4, 0);
      AddField (ardeal, "MT",       V_INTEGER,  4, 0);
      AddField (ardeal, "PFI",   V_STRING,  10, 0);
      AddField (ardeal, "COMMENT",  V_STRING, 100, 0);
      AddField (ardeal, "BROKERCONTRID",  V_INTEGER, 4, 0);
      AddField (ardeal, "CLIENTREQID",    V_INTEGER, 4, 0);
      AddField (ardeal, "DEAL_ID",   V_INTEGER,  4, 0);
      AddField (ardeal, "Dockind",   V_INTEGER,  4, 0);
      //Deal общие элементы
      AddField (ardeal, "TypeOfDeal", V_STRING,  50, 0);
      AddField (ardeal, "Action", V_STRING,  50, 0);
      AddField (ardeal, "TradeNo", V_STRING,  50, 0);
      AddField (ardeal, "MicexType", V_STRING,  50, 0);
      AddField (ardeal, "TradingPlace", V_STRING,  50, 0);
      AddField (ardeal, "CptyBisId", V_STRING,  50, 0);
      AddField (ardeal, "BIS_ID_UN", V_STRING,  50, 0);
      AddField (ardeal, "CptyDealingCode", V_STRING,  50, 0);
      AddField (ardeal, "CptyName", V_STRING,  50, 0);
      AddField (ardeal, "KondorDealId", V_STRING,  50, 0);
      AddField (ardeal, "TradeDate", V_STRING,  50, 0);
      AddField (ardeal, "TradeTime", V_STRING,  50, 0);
      AddField (ardeal, "LastModifDate", V_STRING,  50, 0);
      AddField (ardeal, "TraderName", V_STRING,  50, 0);
      AddField (ardeal, "Comments", V_STRING,  100, 0);
      AddField (ardeal, "PairsName", V_STRING,  50, 0);
      AddField (ardeal, "Pfi", V_STRING,  50, 0);
      AddField (ardeal, "Buy_Sell", V_STRING,  50, 0);
      AddField (ardeal, "ValueDate1", V_STRING,  50, 0);
      AddField (ardeal, "ValueDate2", V_STRING,  50, 0);
      AddField (ardeal, "Amount1", V_STRING,  50, 0);
      AddField (ardeal, "Amount2", V_STRING,  50, 0);
      AddField (ardeal, "Rate", V_STRING,  50, 0);
      AddField (ardeal, "RateDirection", V_STRING,  50, 0);
      AddField (ardeal, "RateQuotationUnit", V_STRING,  50, 0);
      AddField (ardeal, "Netting", V_STRING,  50, 0);
      AddField (ardeal, "Pay_Inst_1", V_STRING,  50, 0);
      AddField (ardeal, "Pay_Inst_2", V_STRING,  50, 0);
      AddField (ardeal, "Pay_Inst_Con", V_STRING,  50, 0);
      AddField (ardeal, "PayComment", V_STRING,  50, 0);
//    AddField (ardeal, "Broker", V_STRING,  50, 0);
      AddField (ardeal, "BrokerCurr", V_STRING,  50, 0);
      AddField (ardeal, "BrokerageAm", V_STRING,  50, 0);
      AddField (ardeal, "BrokerId", V_STRING,  50, 0);
      AddField (ardeal, "Conversation_ID", V_STRING,  50, 0);
      AddField (ardeal, "Conversation_Text", V_STRING,  50, 0);
      AddField (ardeal, "Spot_Margin", V_STRING,  50, 0);
      AddField (ardeal, "Pre_Con", V_STRING,  50, 0);
      AddField (ardeal, "Broker_Name", V_STRING,  50, 0);
      AddField (ardeal, "Brokerage", V_STRING,  50, 0);
      AddField (ardeal, "Brkq_Currency", V_STRING,  50, 0);
      AddField (ardeal, "Conv_Text", V_STRING,  50, 0);
      AddField (ardeal, "Nostro", V_STRING,  50, 0);
      AddField (ardeal, "Limit_Status", V_STRING,  50, 0);
      AddField (ardeal, "BESP", V_STRING,  50, 0);
      AddField (ardeal, "Bnote", V_STRING,  50, 0);
      AddField (ardeal, "Num_Tr", V_STRING,  50, 0);
      AddField (ardeal, "Hedge_Method", V_STRING,  50, 0);
      AddField (ardeal, "Int_Rate_1", V_STRING,  50, 0);
      AddField (ardeal, "Int_Rate_2", V_STRING,  50, 0);
      AddField (ardeal, "Points", V_STRING,  50, 0);
      AddField (ardeal, "Details", V_STRING,  50, 0);
      //Deal1 Первая нога
      AddField (ardeal, "Deal1Pfi", V_STRING,  50, 0);
      AddField (ardeal, "Deal1ValueDate1", V_STRING,  50, 0);
      AddField (ardeal, "Deal1ValueDate2", V_STRING,  50, 0);
      AddField (ardeal, "Deal1Amount1", V_STRING,  50, 0);
      AddField (ardeal, "Deal1Amount2", V_STRING,  50, 0);
      AddField (ardeal, "Deal1Rate", V_STRING,  50, 0);
      AddField (ardeal, "Deal1RateDirection", V_STRING,  50, 0);
      AddField (ardeal, "Deal1RateQuotationUnit", V_STRING,  50, 0);
      AddField (ardeal, "Deal1Netting", V_STRING,  50, 0);
      AddField (ardeal, "Deal1RealCptyPaymDate", V_STRING,  50, 0);
      AddField (ardeal, "Deal1ReciveCurr1To", V_STRING,  50, 0);
      AddField (ardeal, "Deal1PayCurr2From", V_STRING,  50, 0);
      AddField (ardeal, "Deal1PayCurr2To", V_STRING,  50, 0);
      AddField (ardeal, "Deal1PayComment", V_STRING,  50, 0);
      //Deal2 Вторая нога
      AddField (ardeal, "Deal2Pfi", V_STRING,  50, 0);
      AddField (ardeal, "Deal2ValueDate1", V_STRING,  50, 0);
      AddField (ardeal, "Deal2ValueDate2", V_STRING,  50, 0);
      AddField (ardeal, "Deal2Amount1", V_STRING,  50, 0);
      AddField (ardeal, "Deal2Amount2", V_STRING,  50, 0);
      AddField (ardeal, "Deal2Rate", V_STRING,  50, 0);
      AddField (ardeal, "Deal2RateDirection", V_STRING,  50, 0);
      AddField (ardeal, "Deal2RateQuotationUnit", V_STRING,  50, 0);
      AddField (ardeal, "Deal2Netting", V_STRING,  50, 0);
      AddField (ardeal, "Deal2RealCptyPaymDate", V_STRING,  50, 0);
      AddField (ardeal, "Deal2ReciveCurr1From", V_STRING,  50, 0);
      AddField (ardeal, "Deal2PayCurr2To", V_STRING,  50, 0);
      AddField (ardeal, "Deal2PayCurr1To", V_STRING,  50, 0);
      AddField (ardeal, "Deal2PayComment", V_STRING,  50, 0);

      return ardeal;
end;

var locdeal = TRecHandler ("deal", MakeArDeal());


private class DlngPayment()
  private const
      mode_ins = 0,
      mode_upd = 1,
      mode_del = 2;

  private var
      prm_workMode = NULL;

  private var
      prm_pmObj  = NULL;

  macro SetPurpose(_Purpose, _SubPurpose)
      prm_pmObj.Purpose    = _Purpose;
      prm_pmObj.SubPurpose = _SubPurpose;
      prm_pmObj.Number     = String(_SubPurpose);
  end;

  macro SetDocKind(_DocKind)
      prm_pmObj.DocKind = _DocKind;
  end;

  macro SetDocumentID(_DocumentID)
      prm_pmObj.DocumentID = _DocumentID;
  end;

  macro SetDepartment(_Department)
      prm_pmObj.Department = _Department;
  end;

  macro SetFIID(_FIID)
      prm_pmObj.OrderFIID          =
      prm_pmObj.BaseFIID           = 
      prm_pmObj.PayerFIID          =
      prm_pmObj.ReceiverFIID       =
      prm_pmObj.FuturePayerFIID    =
      prm_pmObj.FutureReceiverFIID = _FIID;
  end;

  macro SetLegID(_LegID)
//      dprm_LegID = _LegID;
  end;

  macro SetNetting(_Netting)
      prm_pmObj.Netting  = _Netting;
  end;

  macro SetDate(_VDate, _RDate)
      prm_pmObj.Date                 = _VDate;
      prm_pmObj.PayDate              = 
      prm_pmObj.OutTransferDate      =
      prm_pmObj.ValueDate            = _RDate;
      prm_pmObj.ClientDate           = {curdate};
  end;


  macro SetAmount(_Amount)
      prm_pmObj.OrderAmount          =
      prm_pmObj.PayerAmount          = 
      prm_pmObj.ReceiverAmount       = 
      prm_pmObj.BaseAmount           =
      prm_pmObj.FutureBaseAmount     = _Amount;
      prm_pmObj.ActuateFutureAmounts(TBA_AMOUNT);
  end;

  macro SetGround(_Ground)
      prm_pmObj.Ground = _Ground;
  end;

  macro SetPayer(_Payer, _PayerCodeKind, _PayerBankID, _PayerBankIDCodeKind, _Kind_Operation, _FIID, _bank, _acc)
      private var codd, clnt, err;
      RECORD settacc(settacc);
      RECORD settaccour(settacc);

      if (_FIID ==0 ) 
          codd = ПолучитьКодСубъекта ( _PayerBankID, _PayerBankIDCodeKind, err );
      else
          codd = _bank;
      end;
      clnt = ПолучитьКодСубъекта ( _Payer, _PayerCodeKind, err );

      if (_Payer == {OurBank})

          if (not FindSETTACC_PMAUTO(_PayerBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, prm_pmObj.Purpose, 0, settaccour))
              ;
/*          elif (not FindSETTACC_PMAUTO(_PayerBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, 0, 0, settaccour))
              ;
          elif (not FindSETTACC_PMAUTO(_PayerBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, 0, prm_pmObj.Purpose, 0, settaccour))
              ;
          elif (not FindSETTACC_PMAUTO(_PayerBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, 0, 0, 0, settaccour))
              ;*/
          end;


          prm_pmObj.SetPayerPI(PAYMENTS_GROUP_UNDEF,
                              _PayerBankID,
                              _PayerBankIDCodeKind,
                              codd, //settaccour.BankCode, 
                              settaccour.BankName,  
                              "",//settaccour.CorrAcc,    //коррсчет
                              _FIID,
                              settaccour.Chapter,
                              _acc, //settaccour.Account, 
                              _Payer, 
                              "",
                              settaccour.INN,
                              _PayerCodeKind,       
                              clnt //settacc.Code                // клиент
                              );



          //prm_pmObj.PayerBankName = settaccour.BankName; //prm_pmObj.PayerName;
          //prm_pmObj.PayerBankCorrCodeKind = PTCK_ALL;
          //prm_pmObj.PayerBankCorrCode     = "";
          //prm_pmObj.ReceiverInOurBalance  = "";
          prm_pmObj.ReceiverOurCorrAcc    = settaccour.CorrAcc;
          //prm_pmObj.ReceiverOurCorrID     = -1;

      else
          if (not FindSETTACC_PMAUTO(_PayerBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, prm_pmObj.Purpose, 0, settacc))
              ;
/*          elif (not FindSETTACC_PMAUTO(_PayerBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, 0, 0, settacc))
              ;
          elif (not FindSETTACC_PMAUTO(_PayerBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, 0, prm_pmObj.Purpose, 0, settacc))
              ;
          elif (not FindSETTACC_PMAUTO(_PayerBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, 0, 0, 0, settacc))
              ;*/
          end;

          prm_pmObj.SetPayerPI(PAYMENTS_GROUP_UNDEF,
                                _PayerBankID,
                                _PayerBankIDCodeKind,
                                 codd, //settacc.BankCode,
                                 settacc.BankName,  
                                 "", //settacc.CorrAcc,
                                 _FIID, /*          settacc.FIID,   */
                                 settacc.Chapter,
                                 _acc, //settacc.Account, 
                                 _Payer,        /* settacc.PartyID,  */
                                 settacc.RecName,
                                 settacc.INN,
                                 _PayerCodeKind,  /*settacc.CodeKind, */
                                 clnt //settacc.Code  
                                 );
          /*
          if (settacc.BankCorrID != {OurBank})
              prm_pmObj.PayerBankCorrAcc      = settacc.CorrAcc; 
              prm_pmObj.PayerBankCorrCodeKind = settacc.BankCorrCodeKind;
              prm_pmObj.PayerBankCorrCode     = settacc.BankCorrCode;
              prm_pmObj.PayerBankCorrName     = settacc.BankCorrName;
          end;*/

      end;
  end;

  macro SetReceiver(_Receiver, _ReceiverCodeKind, _ReceiverBankID, _ReceiverBankIDCodeKind, _Kind_Operation, _FIID, _bank,_acc);
      private var codd, clnt, err;
      RECORD settaccour(settacc);
      RECORD settacc(settacc);

      if (_FIID == 0 ) 
          codd = ПолучитьКодСубъекта ( _ReceiverBankID, PTCK_BIC );
      else
          codd = _bank;
      end;
      clnt = ПолучитьКодСубъекта ( _Receiver, _ReceiverCodeKind );

      if (_Receiver == {OurBank})

          if (not FindSETTACC_PMAUTO(_ReceiverBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, prm_pmObj.Purpose, 0, settaccour))
              ;
/*          elif (not FindSETTACC_PMAUTO(_ReceiverBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, 0, 0, settaccour))
              ;
          elif (not FindSETTACC_PMAUTO(_ReceiverBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, 0, prm_pmObj.Purpose, 0, settaccour))
              ;
          elif (not FindSETTACC_PMAUTO(_ReceiverBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, 0, 0, 0, settaccour))
              ;*/
          end;


          prm_pmObj.SetReceiverPI(PAYMENTS_GROUP_UNDEF,
                              _ReceiverBankID,
                              _ReceiverBankIDCodeKind,  
                              codd, //settaccour.BankCode,
                              settaccour.BankName,
                              "", //settaccour.CorrAcc,
                              _FIID,
                              settaccour.Chapter,
                              _acc, //settaccour.Account, 
                              _Receiver,
                              "",
                              settaccour.INN,
                              _ReceiverCodeKind,   
                              clnt //settacc.Code  
                              );

          //prm_pmObj.ReceiverBankName = settaccour.BankName; //prm_pmObj.ReceiverName;
          //prm_pmObj.ReceiverBankCorrCodeKind = PTCK_ALL;
          //prm_pmObj.ReceiverBankCorrCode     = "";
          //prm_pmObj.PayerInOurBalance  = "";
          prm_pmObj.PayerOurCorrAcc    = settaccour.CorrAcc;
          //prm_pmObj.PayerOurCorrID     = -1;

      else
          if (not FindSETTACC_PMAUTO(_ReceiverBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, prm_pmObj.Purpose, 0, settacc))
              ;
/*          elif (not FindSETTACC_PMAUTO(_ReceiverBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, _Kind_Operation, 0, 0, settacc))
              ;
          elif (not FindSETTACC_PMAUTO(_ReceiverBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, 0, prm_pmObj.Purpose, 0, settacc))
              ;
          elif (not FindSETTACC_PMAUTO(_ReceiverBankID, FIKIND_CURRENCY, _FIID, PTSK_CURRDL, 0, 0, 0, settacc))
              ;*/
          end;

          prm_pmObj.SetReceiverPI(PAYMENTS_GROUP_UNDEF,
                                 _ReceiverBankID,
                                 _ReceiverBankIDCodeKind,
                                 codd, //settacc.BankCode,
                                 settacc.BankName,   
                                 "",                // settacc.CorrAcc,
                                 _FIID,             // settacc.FIID, 
                                 settacc.Chapter,
                                 _acc, //settacc.Account, 
                                 _ReceiverBankID,   // settacc.PartyID, 
                                 settacc.RecName,
                                 settacc.INN,
                                 _ReceiverCodeKind,  // settacc.CodeKind,
                                 clnt //settacc.Code       
                                 );
          /*
          if (settacc.BankCorrID != {OurBank})
              prm_pmObj.ReceiverBankCorrAcc      = settacc.CorrAcc;
              prm_pmObj.ReceiverBankCorrCodeKind = settacc.BankCorrCodeKind;
              prm_pmObj.ReceiverBankCorrCode     = settacc.BankCorrCode;
              prm_pmObj.ReceiverBankCorrName     = settacc.BankCorrName;
          end;*/

     end;    

  end;

  macro CreateNew()
      prm_pmObj.Actuate();

      if (prm_pmObj.Update())
          RunError("Ошибка при создании платежей.");
      end;
  end;

  private macro ClassConstructorNew()
      prm_workMode = mode_ins;

      prm_pmObj  = RsbPayment(0);
      prm_pmObj.Department       = {OperDprt};
      prm_pmObj.PaymStatus       = PM_PREPARING;
      prm_pmObj.IsPlanPaym       = "X";
      prm_pmObj.ValueDate        = {curdate};
      prm_pmObj.SubPurpose       = 0;
      prm_pmObj.Oper             = {oper};
      prm_pmObj.Origin           = PAYMENT_OR_AUTO;
  end;

  private macro ClassConstructor(CountParm)
      if (CountParm == 1)
          ClassConstructorNew();
      elif (CountParm == 2)
      //
      elif (CountParm == 5)
      //
      end;
  end;

  ClassConstructor(ParmCount());
end;

///////////////////////////////////////////////////////////////////////////////////
private class Ob_DealFileImport( obdeal )
  private var
      prm_SeanceID,
      prm_RecordID;

  private var
      prm_ObjID,
      prm_Comment;

  private var
      RG;

  private var
      prm_tick,
      prm_legBase,
      prm_legRev;
  private var
      dvndeal,
      dvnfi,
      dvnfi2;

  private var
      prm_deferOp,
      prm_deferDoc;



  PRIVATE MACRO ДАТ0(s);
      private var ss,d1;
      ss=trim(substr(string(s),1,10));
      if (substr(ss,3,1) != "." )
       ss="0"+ss;
      end; 
      d1=date(ss);
      return(d1);
  END;

  private macro GetAcc(str)
     private var i, j=2;
     if ((str==NULL) or (str==""))
        return "";
     end;
     if (substr(str,1,4) == "CASH") str=substr(str,6); j=1; end;
     i = index(str," ");
     if (i == 0)
        return substr(str,j);
     else
        return substr(str,j,i-j);
     end;
     return "";
  end;

  private macro GetBIK(str)
     private var i;
     if ((str==NULL) or (str==""))
        return "";
     end;
     if (substr(str,1,4) == "CASH") str=substr(str,6); end;
     i = index(str," ");
     if (i > 0)
        return substr(str,i+1);
     end;
     return "";
  end;

  private macro GetClientContrID(pid)
    var sql,rs;
    sql = " SELECT t.t_id cid "
    + " FROM dsfcontr_dbt t "
    + " WHERE t.t_partyid = :1 "
    + " AND t.t_servkind = 15 "
    + " AND t.t_datebegin <= to_date('"+{curdate}+"', 'dd.mm.yyyy') "
    + " AND ( "
    + " t.t_dateclose = to_date('01.01.0001', 'dd.mm.yyyy') OR "
    + " t.t_dateclose > to_date('"+{curdate}+"', 'dd.mm.yyyy') "
    + "  ) ";
    msgbox(sql);
    rs = ExecSqlSelect(sql,MakeArray(SqlParam("1", pid)),false);

    if (rs.MoveNext())
      return rs.value("cid");
    else
      return -1;
    end;
  end;

  private macro CreateFissDeal(_Kind)
    var status,rs,sql,exectype;

    dvndeal.clear();
    dvndeal.rec.ID = 0;
    if (_kind == 2745)
       dvndeal.rec.DOCKIND = BOKINDT3;
    else
       dvndeal.rec.DOCKIND = BOKIND;
    end;
    dvndeal.rec.KIND = _Kind; //вид сделки
    //направление сделки
    if   ( locdeal.rec.Buy_Sell == "Buy" )
      dvndeal.rec.TYPE = "1"; // Покупка
    elif ( locdeal.rec.Buy_Sell == "Sell" )
      dvndeal.rec.TYPE = "2"; //Продажа
    end;
    dvndeal.rec.DATE = ДАТ0(locdeal.rec.TradeDate); //дата операции
    dvndeal.rec.TIME = Time(0,0,0);
    dvndeal.rec.CODE = locdeal.rec.KondorDealId;
    dvndeal.rec.EXTCODE = locdeal.rec.TradeNo;
    dvndeal.rec.CONTRACTOR = locdeal.rec.CONTR;
    if (locdeal.rec.PFI == "Y")
      dvndeal.rec.ISPFI = "X";
    end;
    if (_kind == 2730)
       dvndeal.rec.DVKIND = 7;
    elif (_kind == 2735)
       dvndeal.rec.DVKIND = 8;
    elif (_kind == 2745)
       dvndeal.rec.DVKIND = 5;
    end;
    dvndeal.rec.STATE = 0;
    dvndeal.rec.DEPARTMENT = locdeal.rec.FILIAL;
    dvndeal.rec.OPER = {oper};
    dvndeal.rec.AGENT = -1;
    if (locdeal.rec.CLIENT == 0)
      dvndeal.rec.CLIENT = -1;
    else
      dvndeal.rec.CLIENT = locdeal.rec.CLIENT;
      dvndeal.rec.CLIENTCONTR = GetClientContrID(locdeal.rec.CLIENT);
    end;
    dvndeal.rec.PARENTID = -1;
    dvndeal.rec.GENAGRID = -1;
    dvndeal.rec.KINDDEALPARTYCLIENT = 0;
    dvndeal.rec.COMMENT = locdeal.rec.Comments;
    dvndeal.rec.COUNTRY = 165;

    status = dvndeal.insert;

    if (status)
      dvnfi.clear();
      dvnfi.rec.ID = 0;
      dvnfi.rec.DEALID = dvndeal.rec.ID;
      dvnfi.rec.TYPE = 0; //актив по сделке
      dvnfi.rec.FIID = GetFiidByISOCode(substr(locdeal.rec.PairsName,1,3),1);
      dvnfi.rec.AMOUNT = locdeal.rec.Amount1;
      dvnfi.rec.EXECDATE = ДАТ0(locdeal.rec.ValueDate2);
      dvnfi.rec.EXECTYPE = 0;
      dvnfi.rec.PAYDATE = ДАТ0(locdeal.rec.ValueDate2);
      dvnfi.rec.SUPLDATE = ДАТ0(locdeal.rec.ValueDate1);
      dvnfi.rec.COST = locdeal.rec.Amount2;
      dvnfi.rec.POINT = 4;//количество символов после запятой для PRICE       
      dvnfi.rec.PRICE = locdeal.rec.Rate;
      dvnfi.rec.PRICEFIID = GetFiidByISOCode(substr(locdeal.rec.PairsName,5,3),1);
      dvnfi.rec.CONTRAMOUNT = 1;
      dvnfi.rec.STDFIID = -1;
      dvnfi.rec.ACCFIID = -1;
      dvnfi.rec.RATEID = -1;
      dvnfi.rec.CALKINDID = -1;
      dvnfi.rec.SCALE = 1;

      status = dvnfi.insert;

      if (not status)
        RunError("Ошибка! Не могу создать запись в dvnfi!");
      end;

    else
       RunError("Ошибка! Не могу создать запись в dvndeal!");
    end;
    
  end;

  private macro CreateSwopDeal(_Kind)
    var status,rs,sql,exectype;

    dvndeal.clear();
    dvndeal.rec.ID = 0;
    dvndeal.rec.DOCKIND = BOKIND;
    dvndeal.rec.KIND = _Kind; //вид сделки
    //направление сделки
    if   ( locdeal.rec.TypeOfDeal == "Buy/Sell" )
      dvndeal.rec.TYPE = "5"; // Покупка-продажа
    elif ( locdeal.rec.TypeOfDeal == "Sell/Buy" )
      dvndeal.rec.TYPE = "6"; //Продажа-покупка
    end;
    dvndeal.rec.DATE = ДАТ0(locdeal.rec.TradeDate); //дата операции
    dvndeal.rec.TIME = Time(0,0,0);
    dvndeal.rec.CODE = locdeal.rec.KondorDealId;
    dvndeal.rec.EXTCODE = locdeal.rec.TradeNo;
    dvndeal.rec.CONTRACTOR = locdeal.rec.CONTR;
    if (locdeal.rec.PFI == "Y")
      dvndeal.rec.ISPFI = "X";
    end;
    dvndeal.rec.DVKIND = 6;
    dvndeal.rec.STATE = 0;
    dvndeal.rec.DEPARTMENT = locdeal.rec.FILIAL;
    dvndeal.rec.OPER = {oper};
    dvndeal.rec.AGENT = -1;
    if (locdeal.rec.CLIENT == 0)
      dvndeal.rec.CLIENT = -1;
    else
      dvndeal.rec.CLIENT = locdeal.rec.CLIENT;
      dvndeal.rec.CLIENTCONTR = GetClientContrID(locdeal.rec.CLIENT);
    end;
    dvndeal.rec.PARENTID = -1;
    dvndeal.rec.GENAGRID = -1;
    dvndeal.rec.KINDDEALPARTYCLIENT = 0;
    dvndeal.rec.COMMENT = locdeal.rec.Comments;
    dvndeal.rec.COUNTRY = 165;

    status = dvndeal.insert;

    if (status)
      dvnfi.clear();
      dvnfi.rec.ID = 0;
      dvnfi.rec.DEALID = dvndeal.rec.ID;
      dvnfi.rec.TYPE = 0; //актив по сделке
      dvnfi.rec.FIID = GetFiidByISOCode(substr(locdeal.rec.PairsName,1,3),1);
      dvnfi.rec.AMOUNT = locdeal.rec.Deal1Amount1;
      dvnfi.rec.EXECDATE = ДАТ0(locdeal.rec.Deal1ValueDate2);
      dvnfi.rec.EXECTYPE = 0;
      dvnfi.rec.PAYDATE = ДАТ0(locdeal.rec.Deal1ValueDate2);
      dvnfi.rec.SUPLDATE = ДАТ0(locdeal.rec.Deal1ValueDate1);
      dvnfi.rec.COST = locdeal.rec.Deal1Amount2;
      dvnfi.rec.POINT = 4;//количество символов после запятой для PRICE       
      dvnfi.rec.PRICE = locdeal.rec.Deal1Rate;
      dvnfi.rec.PRICEFIID = GetFiidByISOCode(substr(locdeal.rec.PairsName,5,3),1);
      dvnfi.rec.CONTRAMOUNT = 1;
      dvnfi.rec.STDFIID = -1;
      dvnfi.rec.ACCFIID = -1;
      dvnfi.rec.RATEID = -1;
      dvnfi.rec.CALKINDID = -1;
      dvnfi.rec.SCALE = 1;

      status = dvnfi.insert;

      if (status)
        dvnfi2.clear();
        dvnfi2.rec.ID = 0;
        dvnfi2.rec.DEALID = dvndeal.rec.ID;
        dvnfi2.rec.TYPE = 2; //актив по 2 части сделки
        dvnfi2.rec.FIID = GetFiidByISOCode(substr(locdeal.rec.PairsName,1,3),1);
        dvnfi2.rec.AMOUNT = locdeal.rec.Deal2Amount1;
        dvnfi2.rec.EXECDATE = ДАТ0(locdeal.rec.Deal2ValueDate2);
        dvnfi2.rec.EXECTYPE = 0;
        dvnfi2.rec.PAYDATE = ДАТ0(locdeal.rec.Deal2ValueDate2);
        dvnfi2.rec.SUPLDATE = ДАТ0(locdeal.rec.Deal2ValueDate1);
        dvnfi2.rec.COST = locdeal.rec.Deal2Amount2;
        dvnfi2.rec.POINT = 4;//количество символов после запятой для PRICE       
        dvnfi2.rec.PRICE = locdeal.rec.Deal2Rate;
        dvnfi2.rec.PRICEFIID = GetFiidByISOCode(substr(locdeal.rec.PairsName,5,3),1);
        dvnfi2.rec.CONTRAMOUNT = 1;
        dvnfi2.rec.STDFIID = -1;
        dvnfi2.rec.ACCFIID = -1;
        dvnfi2.rec.RATEID = -1;
        dvnfi2.rec.CALKINDID = -1;
        dvnfi2.rec.SCALE = 1;

        status = dvnfi2.insert;

        if (not status)
          RunError("Ошибка! Не могу создать запись в dvnfi2!");
        end;
      else
        RunError("Ошибка! Не могу создать запись в dvnfi!");
      end;

    else
       RunError("Ошибка! Не могу создать запись в dvndeal!");
    end;
    
  end;

  /*
  private macro CreatePaym_(ftype, rdate, vdate, amount, fiid, pbank, pacc, rbank, racc)
  var
        paym       = DlngPayment(),
        Purpose,
        TypeBankCode = 3,
        type         = 0,
        BankID       = -1,
        Ground       = "";

      paym.SetDocKind(prm_tick.rec.BofficeKind);
      paym.SetDocumentID(prm_tick.rec.DealID);
      paym.SetPurpose(Purpose, 0);
      paym.SetDepartment(prm_tick.rec.Department);
      paym.SetDate(vdate, rdate);
      paym.SetAmount(amount);
      paym.SetFIID(fiid);

      //BankID = prm_tick.rec.PartyID;

      if (fiid==0)
         TypeBankCode = PTCK_BIC;
      else
         TypeBankCode = PTCK_SWIFT;
      end;
      /*
      if (prm_tick.rec.Netting == 3)
          paym.SetNetting("X");
      else
          paym.SetNetting("");
      end;
      */

      if (ftype == 1)
          Purpose = ContrPurposeID;
          paym.SetLegID(prm_legBase.rec.LegID);
          paym.SetPurpose(Purpose, 0);
          Ground = "Платеж по контрактиву по сделке № "+locdeal.rec.NUMBER+" от "+locdeal.rec.DEALDATE;
          paym.SetGround(Ground);

          paym.SetPayer({OurBank}, TypeBankCode, {OurBank}, TypeBankCode, prm_tick.rec.DealType, fiid, pbank, pacc);
          paym.SetReceiver(prm_tick.rec.PartyID, TypeBankCode, prm_tick.rec.PartyID, TypeBankCode, prm_tick.rec.DealType, fiid, rbank, racc);

       elif (ftype == 0)
          Purpose = BasePurposeID;
          paym.SetLegID(prm_legBase.rec.LegID);
          paym.SetPurpose(Purpose, 0);
          Ground = "Платеж по базовому активу по сделке № "+locdeal.rec.NUMBER+" от "+locdeal.rec.DEALDATE;
          paym.SetGround(Ground);

          paym.SetPayer(prm_tick.rec.PartyID, TypeBankCode, prm_tick.rec.PartyID, TypeBankCode, prm_tick.rec.DealType, fiid, rbank, racc);
          paym.SetReceiver({OurBank}, TypeBankCode, {OurBank}, TypeBankCode, prm_tick.rec.DealType, fiid, pbank,  pacc);

      end;

      paym.CreateNew();

  end;*/

  private macro CreatePaym(ftype, rdate, vdate, amount, fiid, pbank, pacc, rbank, racc)
  var
        paym       = DlngPayment(),
        Purpose,
        deal_member,
        deal_member_kind,
        TypeBankCode = 3,
        type         = 0,
        BankID       = -1,
        Ground       = "";

      //fiid = GetFiidByISOCode(fiid,1);
      if (dvndeal.rec.kind == 2745)
         paym.SetDocKind(BOKINDT3);
      else
         paym.SetDocKind(BOKIND);
      end;
      paym.SetDocumentID(dvndeal.rec.ID);
      paym.SetPurpose(Purpose, 0);
      paym.SetDepartment(dvndeal.rec.Department);
      paym.SetDate(vdate, rdate);
      paym.SetAmount(amount);
      paym.SetFIID(fiid);

      //      BankID = prm_dvndeal.rec.PartyID;

      if (fiid==0)
         TypeBankCode = PTCK_BIC;
      else
         TypeBankCode = PTCK_SWIFT;
      end;
      /*
      if (prm_dvndeal.rec.Netting == 3)
          paym.SetNetting("X");
      else
          paym.SetNetting("");
      end;
      */
      if (dvndeal.rec.CLIENT != -1)
        deal_member = dvndeal.rec.CLIENT;
        deal_member_kind = 1;
      else
        deal_member = {OurBank};
        deal_member_kind = TypeBankCode;
      end;

      if (ftype == 0)
          Purpose = 1;
          paym.SetPurpose(Purpose, 0);
          Ground = "Платеж по базовому по сделке № "+locdeal.rec.KondorDealId+" от "+locdeal.rec.TradeDate;
          paym.SetGround(Ground);

          if ((dvndeal.rec.type == 1) or (dvndeal.rec.type == 5))
              paym.SetPayer(dvndeal.rec.CONTRACTOR, TypeBankCode, dvndeal.rec.CONTRACTOR, TypeBankCode, dvndeal.rec.kind, fiid, pbank, pacc);
              paym.SetReceiver(deal_member, deal_member_kind, {OurBank}, TypeBankCode, dvndeal.rec.kind, fiid, "",  "");
          elif ((dvndeal.rec.type == 2) or (dvndeal.rec.type == 6))
              paym.SetPayer(deal_member, deal_member_kind, {OurBank}, TypeBankCode, dvndeal.rec.kind, fiid, rbank, racc);
              paym.SetReceiver(dvndeal.rec.CONTRACTOR, TypeBankCode, dvndeal.rec.CONTRACTOR, TypeBankCode, dvndeal.rec.kind, fiid, pbank,  pacc);

          end;

      elif (ftype == 1)
          Purpose = 2;
          paym.SetPurpose(Purpose, 0);
          Ground = "Платеж по контрактиву активу по сделке № "+locdeal.rec.KondorDealId+" от "+locdeal.rec.TradeDate;
          paym.SetGround(Ground);

          if ((dvndeal.rec.type == 1) or (dvndeal.rec.type == 5))
              paym.SetPayer(deal_member, deal_member_kind, {OurBank}, TypeBankCode, dvndeal.rec.kind, fiid, pbank, pacc);
              paym.SetReceiver(dvndeal.rec.CONTRACTOR, TypeBankCode, dvndeal.rec.CONTRACTOR, TypeBankCode, dvndeal.rec.kind, fiid, rbank, racc);
          elif ((dvndeal.rec.type == 2) or (dvndeal.rec.type == 6))
              paym.SetPayer(dvndeal.rec.CONTRACTOR, TypeBankCode, dvndeal.rec.CONTRACTOR, TypeBankCode, dvndeal.rec.kind, fiid, "", "");
              paym.SetReceiver(deal_member, deal_member_kind, {OurBank}, TypeBankCode, dvndeal.rec.kind, fiid, pbank, pacc);
          end;

       elif (ftype == 2)
          Purpose = 3;
          paym.SetPurpose(Purpose, 0);
          Ground = "Платеж по базовому активу в обратной сделке по сделке № "+locdeal.rec.KondorDealId+" от "+locdeal.rec.TradeDate;
          paym.SetGround(Ground);

          if (dvndeal.rec.type == 5)
              paym.SetPayer(deal_member, deal_member_kind, {OurBank}, TypeBankCode, dvndeal.rec.kind, fiid, pbank, pacc);
              paym.SetReceiver(dvndeal.rec.CONTRACTOR, TypeBankCode, dvndeal.rec.CONTRACTOR, TypeBankCode, dvndeal.rec.kind, fiid, rbank, racc);
          elif (dvndeal.rec.type == 6)
              paym.SetPayer(dvndeal.rec.CONTRACTOR, TypeBankCode, dvndeal.rec.CONTRACTOR, TypeBankCode, dvndeal.rec.kind, fiid, rbank, racc);
              paym.SetReceiver(deal_member, deal_member_kind, {OurBank}, TypeBankCode, dvndeal.rec.kind, fiid, pbank, pacc);
          end;

       elif (ftype == 3)
          Purpose = 4;
          paym.SetPurpose(Purpose, 0);
          Ground = "Платеж по контрактиву в обратной сделке по сделке № "+locdeal.rec.KondorDealId+" от "+locdeal.rec.TradeDate;
          paym.SetGround(Ground);

          if (dvndeal.rec.type == 5)
              paym.SetPayer(dvndeal.rec.CONTRACTOR, TypeBankCode, dvndeal.rec.CONTRACTOR, TypeBankCode, dvndeal.rec.kind, fiid, pbank, pacc);
              paym.SetReceiver(deal_member, deal_member_kind, {OurBank}, TypeBankCode, dvndeal.rec.kind, fiid, rbank,  racc);
          elif (dvndeal.rec.type == 6)
              paym.SetPayer(deal_member, deal_member_kind, {OurBank}, TypeBankCode, dvndeal.rec.kind, fiid, rbank, racc);
              paym.SetReceiver(dvndeal.rec.CONTRACTOR, TypeBankCode, dvndeal.rec.CONTRACTOR, TypeBankCode, dvndeal.rec.kind, fiid, pbank,  pacc);

          end;

      end;

      paym.CreateNew();

  end;


  private macro CreateMMDeal()
      private var que, rs, rsp, ftype, pfiid, cbank, macc, account1, obank, account2, opkind=0;

      if (locdeal.rec.Action == "UPDATE")
         que =  "DECLARE "
              + "   dealid NUMBER(10); "
              + "   dockind NUMBER(5); "
              + "BEGIN "
              + "   dealid := ?; "
              + "   dockind := ?; "
              + "   delete from ddvndeal_dbt where t_id = dealid; "
              + "   delete from ddvnfi_dbt where t_dealid = dealid; "
              + "   delete from dpmprop_dbt where t_paymentid in (select t_paymentid from dpmpaym_dbt where t_documentid = dealid and t_dockind = dockind); "
              + "   delete from dpmrmprop_dbt where t_paymentid in  (select t_paymentid from dpmpaym_dbt where t_documentid = dealid and t_dockind = dockind); "
              + "   delete from dpmpaym_dbt where t_documentid = dealid and t_dockind = dockind; "
              + "END; ";
         rs = RSDCommand(que);
         rs.addParam( "", RSDBP_IN, locdeal.rec.Deal_ID );
         rs.addParam( "", RSDBP_IN, locdeal.rec.Dockind );
         rs.execute();
      end;

      if ((locdeal.rec.TypeOfDeal == "Buy") or (locdeal.rec.TypeOfDeal == "Sell"))
         if   ((locdeal.rec.Bnote == "N") and 
               (Workdays(ДАТ0(locdeal.rec.TradeDate),ДАТ0(locdeal.rec.ValueDate1))<3))
            opkind = 2730;
         elif ((locdeal.rec.Bnote == "N") and 
               (Workdays(ДАТ0(locdeal.rec.TradeDate),ДАТ0(locdeal.rec.ValueDate1))>2))
            opkind = 2745;
         elif (locdeal.rec.Bnote == "Y")
            opkind = 2735;
         end;
      elif ((locdeal.rec.TypeOfDeal == "Buy/Sell") or (locdeal.rec.TypeOfDeal == "Sell/Buy"))
         opkind = 2740;
      end;

      //Привяжем платежи к сделке
      if ((locdeal.rec.TypeOfDeal == "Buy") or (locdeal.rec.TypeOfDeal == "Sell"))
         CreateFissDeal(opkind);
         if (opkind == 2735)
         CreatePaym( 0, 
                     locdeal.rec.ValueDate1,  
                     locdeal.rec.ValueDate1,
                     locdeal.rec.Amount1,
                     GetFiidByISOCode(substr(locdeal.rec.PairsName,1,3),1),
                     GetBIK(locdeal.rec.Pay_Inst_1),
                     GetAcc(locdeal.rec.Pay_Inst_1),
                     "",
                     "" 
                   );
         CreatePaym( 1, 
                     locdeal.rec.ValueDate2, 
                     locdeal.rec.ValueDate2,
                     locdeal.rec.Amount2,
                     GetFiidByISOCode(substr(locdeal.rec.PairsName,5,3),1),
                     GetBIK(locdeal.rec.Pay_Inst_2),
                     GetAcc(locdeal.rec.Pay_Inst_2),
                     GetBIK(locdeal.rec.Pay_Inst_Con),
                     GetAcc(locdeal.rec.Pay_Inst_Con)
                   );
         else
         CreatePaym( 0, 
                     locdeal.rec.ValueDate1,  
                     locdeal.rec.ValueDate1,
                     locdeal.rec.Amount1,
                     GetFiidByISOCode(substr(locdeal.rec.PairsName,1,3),1),
                     GetBIK(locdeal.rec.Pay_Inst_1),
                     GetAcc(locdeal.rec.Pay_Inst_1),
                     GetBIK(locdeal.rec.Pay_Inst_Con),
                     GetAcc(locdeal.rec.Pay_Inst_Con) 
                   );
         CreatePaym( 1, 
                     locdeal.rec.ValueDate2, 
                     locdeal.rec.ValueDate2,
                     locdeal.rec.Amount2,
                     GetFiidByISOCode(substr(locdeal.rec.PairsName,5,3),1),
                     GetBIK(locdeal.rec.Pay_Inst_2),
                     GetAcc(locdeal.rec.Pay_Inst_2),
                     GetBIK(locdeal.rec.Pay_Inst_Con),
                     GetAcc(locdeal.rec.Pay_Inst_Con)
                   );
         end;
      elif ((locdeal.rec.TypeOfDeal == "Buy/Sell") or (locdeal.rec.TypeOfDeal == "Sell/Buy"))
         CreateSwopDeal(opkind);
         CreatePaym( 0, 
                     locdeal.rec.Deal1ValueDate1,
                     locdeal.rec.Deal1ValueDate1,
                     locdeal.rec.Deal1Amount1,
                     GetFiidByISOCode(substr(locdeal.rec.PairsName,1,3),1),
                     GetBIK(locdeal.rec.Deal1ReciveCurr1To),
                     GetAcc(locdeal.rec.Deal1ReciveCurr1To),
                     "",
                     ""  );
         CreatePaym( 1, 
                     locdeal.rec.Deal1ValueDate2, 
                     locdeal.rec.Deal1ValueDate2,
                     locdeal.rec.Deal1Amount2,
                     GetFiidByISOCode(substr(locdeal.rec.PairsName,5,3),1),
                     GetBIK(locdeal.rec.Deal1PayCurr2From),
                     GetAcc(locdeal.rec.Deal1PayCurr2From),
                     GetBIK(locdeal.rec.Deal1PayCurr2To),
                     GetAcc(locdeal.rec.Deal1PayCurr2To)  );
         CreatePaym( 2, 
                     locdeal.rec.Deal2ValueDate1,
                     locdeal.rec.Deal2ValueDate1,
                     locdeal.rec.Deal2Amount1,
                     GetFiidByISOCode(substr(locdeal.rec.PairsName,1,3),1),
                     GetBIK(locdeal.rec.Deal2ReciveCurr1From),
                     GetAcc(locdeal.rec.Deal2ReciveCurr1From),
                     "",
                     ""  );
         CreatePaym( 3, 
                     locdeal.rec.Deal2ValueDate2, 
                     locdeal.rec.Deal2ValueDate2,
                     locdeal.rec.Deal2Amount2,
                     GetFiidByISOCode(substr(locdeal.rec.PairsName,5,3),1),
                     GetBIK(locdeal.rec.Deal2PayCurr2To),
                     GetAcc(locdeal.rec.Deal2PayCurr2To),
                     GetBIK(locdeal.rec.Deal2PayCurr1To),
                     GetAcc(locdeal.rec.Deal2PayCurr1To)  );
      end;

      return true;
  end;

  private macro CreateDealTrn()
    var
        retVal = true;

          retVal = CreateMMDeal();

      return retVal;

    OnError( RslErrObj )
      prm_Comment = RslErrObj.Message;

      AbortTrn();
      return false;
  end;

  macro CreateDeal()
    macro Local_CreateDealTrn()
        return CreateDealTrn();
    end;

      if (not ProcessTrn(0, "Local_CreateDealTrn"))
          return 1;
      end;

      prm_ObjID = prm_tick.rec.DealID;
      //prm_ObjID = prm_dvndeal.rec.DealID;

      return 0;
  end;

  macro Get_ObjID()
      return prm_ObjID;
  end;

  macro Get_Comment()
      return prm_Comment;
  end;

  private macro ClassConstructor( obdeal)
      prm_SeanceID = 0; // _SeanceID;
      prm_RecordID = 0;// _RecordID;

      prm_ObjID   = -1;
      prm_Comment = "";


      //msgbox(obdeal.rec.dealid);
      copy(locdeal, obdeal);
      //msgbox(locdeal.rec.dealid);

      prm_tick    = Tbfile("dl_tick.dbt", "W");
      prm_legBase = Tbfile("dl_leg.dbt", "W");
      prm_legRev  = Tbfile("dl_leg.dbt", "W");

      dvndeal = Tbfile( "dvndeal.dbt", "W" );
      dvnfi = Tbfile( "dvnfi.dbt", "W" );
      dvnfi2 = Tbfile( "dvnfi.dbt", "W" );


//      prm_deferOp  = Tbfile("oproper.dbt", "W");
//      prm_deferDoc = Tbfile("oprdocs.dbt", "W");

  end;

  ClassConstructor( obdeal);
end;

///////////////////////////////////////////////////////////////////////////////////
//вызываем транзакцию импорта сделки МБК, возвращаем нужные параметры	
macro _MoneyMarketDeal_CreateNew( obdeal ):INTEGER
  var 
      Obj = Ob_DealFileImport(obdeal),
      retVal = 0;

    retVal = Obj.CreateDeal(obdeal);

//    _NewID    = Obj.Get_ObjID();
//    _Comment = Obj.Get_Comment(); 

    return retVal;
end;
