import cb_sql, RSD, "or_tpl_h.mac";
import "dlutils.mac";
import "scsrvrepfun.mac";


macro ChekData(DateIn : date)
   var repTmpl, fileSavePathExcel, FILEN;
   
   repTmpl = CTemplateSXLSX("Report_VerifBis306.xlsx");
   FILEN = "Rep_vefifBis306_"+UserNumber()+".xlsx";
   fileSavePathExcel = PathCombine(GetAbsoluteTxtPath(),FILEN);
   
   repTmpl.SetValue_NameCell("NameReport", "Сверка пополнений 306* за " + string(DateIn));
   
   var cmdcount = "select count(*) from upminsofrlog_dbt where t_valuedate = :indate and t_dockind = 4607";
   cmdcount = RSDCommand(cmdcount);
   cmdcount.AddParam("indate", RSDBP_IN, DateIn);
   var rscount = RsdRecordset(cmdcount);
   rscount.movenext();
   /*тут должно быть вычисление количества записей, если приходим к изначальной форма вывода*/
   repTmpl.SetValue_NameCell("CountRec", "Всего записей: " + SQL_ConvTypeInteger(rscount.value(0)) );
 
   var tableObj = repTmpl.RegisterTable("bodyline");
   var tableRowCount = 1;

   //А.Киселев 27.02.2019 добавляем условия ( не включаем дублирование и выводим последнее актуальное по платежу )

   var cmd =" SELECT "+
   "           UP.T_CONTRNUMBER, " +
   "           UP.T_PAYERACCOUNT, " +
   "           UP.T_RECEIVERACCOUNT, " +
   "           (SELECT fi.t_ccy FROM dfininstr_dbt fi WHERE fi.t_fiid = UP.t_fiid), " +
   "           T_AMOUNT, " +
   "           RSB_FIInstr.ConvSum (UP.T_AMOUNT,UP.t_fiid,0,:Indate), " +
   "           DECODE (UP.T_STATUS, " +
   "              0, 'Поручение успешно зарегистрировано в СОФР ', " +
   "              'Ошибка: ' || UP.T_ERRTEXT), " +
   "           UP.T_GROUND, "+
   "           decode(UP.T_CREATIONTIME, null,' ',UP.T_CREATIONTIME), "+ //SHEV
   "           UP.T_BISCOTTOID,"+/*CHVA добавляем в value(8) информацию о id записи из БИС */
   "           UP.T_PMID "+ /*CHVA добавляем записи о платеже в value(9)*/
   "           FROM upminsofrlog_dbt UP, " +
   "            ( SELECT /*A.T_PMID,*/ MAX(A.T_RECID) AS T_RECID FROM upminsofrlog_dbt A " +/*CHVA*/
   "              WHERE A.T_VALUEDATE = :indate " +
   "               AND A.T_DOCKIND = 4607 " +
   "               AND A.T_STATUS <> 90378 " +
   "             AND ( (A.T_PAYERACCOUNT like '306%') or (A.T_RECEIVERACCOUNT like '306%') ) "+/*CHVA */
   "              GROUP BY T_BISCOTTOID/*, T_PMID*/ ) B " +/*CHVA*/
   "          WHERE UP.T_RECID = B.T_RECID "+
   "          ORDER BY UP.T_RECID ";

   cmd = RSDCommand(cmd);
   cmd.AddParam("indate", RSDBP_IN, DateIn);
   var rs = RsdRecordset(cmd);

   /*Вывод результатов сверки/проверки*/
    
   while (rs.movenext)
      if (rs.value(10) ==0)      /*CHVA данный участок нужен, чтобы  в случае, когда после корректно прошедшей записи передавалась ещё одна , эти данные не попадали в таблицу */
         var cmd2 = "  SELECT  " 
                    "   A.T_VALUEDATE, " +
                    "   A.T_PAYERACCOUNT, " +
                    "   A.T_RECEIVERACCOUNT, " +
                    "   (SELECT fi.t_ccy FROM dfininstr_dbt fi WHERE fi.t_fiid = A.t_fiid), " +
                    "   T_AMOUNT, " +
                    "   RSB_FIInstr.ConvSum (A.T_AMOUNT,A.t_fiid,0,:indate1), " +
                    "   DECODE (A.T_STATUS, 0, 'Поручение успешно зарегистрировано в СОФР ', 'Ошибка: ' || A.T_ERRTEXT), " +
                    "   A.T_GROUND   ,   "+
                    "   decode(a.T_CREATIONTIME,null,' ',a.T_CREATIONTIME) "+ //SHEV
                    "  FROM upminsofrlog_dbt A " +/*CHVA*/
                    " WHERE A.T_VALUEDATE = :indate2 " +
                    "   AND A.T_DOCKIND = 4607 " +
                    "   AND A.T_STATUS <> 90378 " +
                    "   AND ( (A.T_PAYERACCOUNT like '306%') or (A.T_RECEIVERACCOUNT like '306%')) "+
                    "   AND A.T_BISCOTTOID = :bisid" 
                    "   AND A.T_PMID > 0";
                    
         cmd2 = RSDCommand(cmd2);
         cmd2.AddParam("indate1", RSDBP_IN, DateIn);
         cmd2.AddParam("indate2", RSDBP_IN, DateIn);
         cmd2.AddParam("bisid", RSDBP_IN, rs.value(9));
                    
         var rs2 = RsdRecordset(cmd2);
         if (rs2.movenext)
            tableObj.SetValueCell("bodyline_f1",tableRowCount);
            tableObj.SetValueCell("bodyline_f2",SQL_ConvTypeStr (rs2.value(0)) );
            tableObj.SetValueCell("bodyline_f3",SQL_ConvTypeStr (rs2.value(1)) );
            tableObj.SetValueCell("bodyline_f4",SQL_ConvTypeStr (rs2.value(2)) );
            tableObj.SetValueCell("bodyline_f5",SQL_ConvTypeStr (rs2.value(3)) );
            tableObj.SetValueCell("bodyline_f6",SQL_ConvTypeSum (rs2.value(4)) );
            tableObj.SetValueCell("bodyline_f7",SQL_ConvTypeSum (rs2.value(5)) );
            tableObj.SetValueCell("bodyline_f8",SQL_ConvTypeStr (rs2.value(6)) );
            tableObj.SetValueCell("bodyline_f9",SQL_ConvTypeStr (rs2.value(7)) );
            if (rs2.value(6) == "Поручение успешно зарегистрировано в СОФР ")
               tableObj.SetValueCell("bodyline_f10",SQL_ConvTypeDate (rs2.value(8)) );
            else
               tableObj.SetValueCell("bodyline_f10"," ");
            end;
            tableObj.AddStr();
            tableRowCount = tableRowCount + 1;
         else
            //maa
            /*if (substr(rs.value(6),1,7) == "Ошибка:" )
                   comment_format = signal_format;
            else
                   comment_format = normal_format;
            end;*/
            tableObj.SetValueCell("bodyline_f1",tableRowCount);
            tableObj.SetValueCell("bodyline_f2",SQL_ConvTypeStr (rs.value(0)) );
            tableObj.SetValueCell("bodyline_f3",SQL_ConvTypeStr (rs.value(1)) );
            tableObj.SetValueCell("bodyline_f4",SQL_ConvTypeStr (rs.value(2)) );
            tableObj.SetValueCell("bodyline_f5",SQL_ConvTypeStr (rs.value(3)) );
            tableObj.SetValueCell("bodyline_f6",SQL_ConvTypeSum (rs.value(4)) );
            tableObj.SetValueCell("bodyline_f7",SQL_ConvTypeSum (rs.value(5)) );
            tableObj.SetValueCell("bodyline_f8",SQL_ConvTypeStr (rs.value(6)) );
            tableObj.SetValueCell("bodyline_f9",SQL_ConvTypeStr (rs.value(7)) );
            if (rs.value(6) == "Поручение успешно зарегистрировано в СОФР ")
               tableObj.SetValueCell("bodyline_f10",SQL_ConvTypeDate (rs.value(8)) );
            else
               tableObj.SetValueCell("bodyline_f10"," ");
            end;
            tableObj.AddStr();
            tableRowCount = tableRowCount + 1;
         end;
      else
         //maa
         /*if (substr(rs.value(6),1,7) == "Ошибка:" )
                comment_format = signal_format;
         else
                comment_format = normal_format;
         end;*/
         tableObj.SetValueCell("bodyline_f1",tableRowCount);
         tableObj.SetValueCell("bodyline_f2",SQL_ConvTypeStr (rs.value(0)) );
         tableObj.SetValueCell("bodyline_f3",SQL_ConvTypeStr (rs.value(1)) );
         tableObj.SetValueCell("bodyline_f4",SQL_ConvTypeStr (rs.value(2)) );
         tableObj.SetValueCell("bodyline_f5",SQL_ConvTypeStr (rs.value(3)) );
         tableObj.SetValueCell("bodyline_f6",SQL_ConvTypeSum (rs.value(4)) );
         tableObj.SetValueCell("bodyline_f7",SQL_ConvTypeSum (rs.value(5)) );
         tableObj.SetValueCell("bodyline_f8",SQL_ConvTypeStr (rs.value(6)) );
         tableObj.SetValueCell("bodyline_f9",SQL_ConvTypeStr (rs.value(7)) );
         if (rs.value(6) == "Поручение успешно зарегистрировано в СОФР ")
            tableObj.SetValueCell("bodyline_f10",SQL_ConvTypeDate (rs.value(8)) );
         else
            tableObj.SetValueCell("bodyline_f10"," ");
         end;
         tableObj.AddStr();
         tableRowCount = tableRowCount + 1;
      end;
   end;
    
   tableObj.EndTable();
   
   var cmdcountsus = "select count(*) from upminsofrlog_dbt where t_valuedate = :indate and t_dockind = 4607 and t_status = 0 AND ( (T_PAYERACCOUNT like '306%') or (T_RECEIVERACCOUNT like '306%') ) ";/*CHVA*/
   cmdcountsus = RSDCommand(cmdcountsus);
   cmdcountsus.AddParam("indate", RSDBP_IN, DateIn);
   var rscountsus = RsdRecordset(cmdcountsus);
   rscountsus.movenext();
   repTmpl.SetValue_NameCell("SuccessRec", int(rscountsus.value(0)));

   if (not repTmpl.GetWorkbook().saveAs(fileSavePathExcel))
     RunError("Не удалось создать xlsx файл");
   end;
   var termFilePath = PathCombine2(GetCurDir(true),"txtfile",FILEN);
   var FileName, FilePath, FileExt;
   FilePath = SplitFile(termFilePath, FileName, FileExt);
   if( not CopyFile( fileSavePathExcel, "$" + termFilePath) )
      RunError("Ошибка копирования файла  " + fileSavePathExcel);
   end;
   SC_ShowFile("$"+FilePath,FileName+FileExt);
end; 

var dateout = {curdate};
var stat = GetDate(dateout, "Введите дату отчета");
if (stat);
chekdata(dateout);
else 
exit(1);
end;
exit(1);