/*
carry_by_payment.mac
*/
import globals, or_rep_h, oralib, likepy;

macro Carry_by_payment ()
  var EXCEL_MONEY = "\"# ##0,00\"";
  var repdt = {curdate};
  var rn    = 0;
  var sheet = 1;
  var count = 0;
  var col0_len = 10;
  var col1_len = 10;
  var col2_len = 6;
  var col3_len = 5;
  var col4_len = 12;
  var col5_len = 20;
  var col6_len = 7;
  var col7_len = 14;
  var col8_len = 20;
  var col9_len = 7;
  var col10_len = 14;
  var col11_len = 12;
  var col12_len = 30;
  var col13_len = 15;
  var col14_len = 10;
  var normal_format = "c:ex_FS():ex_B(tblr)";
  var signal_format = "c:ex_FS():ex_B(tblr):ex_BC(255)";
  var Rep, sql, curr_format;

  if (not GetDate(repdt)) 
    return 1;
  end;

  Rep = CMakeReport("┌┬┬┬┬┬┬┬┬┬┬┬┐");
  Rep.SetDefaultFontName("Times New Roman");
  Rep.SetDefaultFontSize(10);
  Rep.SetFlagShowGrid(true);

  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(6).NumberFormat = "+EXCEL_MONEY+";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(9).NumberFormat = "+EXCEL_MONEY+";");

  rn = rn + 1;
  Rep.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
  Rep.AddPrintCell("Список проводок СОФР, сформированных от входящих платежей " + repdt, col1_len, null, "l:ex_FS(b):ex_B(tblr)");
  Rep.AddStr();

  rn = rn + 1;
  Rep.AddPrintCell("Статус",            col0_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("ИД проводки в БИС", col1_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("ID",                col2_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Глава",             col3_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Номер",             col4_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Счет дебета",       col5_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Валюта дебета",     col6_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Сумма дебета",      col7_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Счет кредита",      col8_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Валюта кредита",    col9_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Сумма кредита",     col10_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Дата проводки",     col11_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Назначение",        col12_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Операционист",      col13_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Пачка",             col14_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddStr();

  sql = "select t.t_acctrnid acctrnid,  \n"
      + "       t.t_chapter chapter, \n"
      + "       t.t_numb_document numb, \n"
      + "       t.t_account_payer debetacc, \n"
      + "       t.t_sum_payer debetsum, \n"
      + "       (select t_ccy from dfininstr_dbt where t_fiid = t.t_fiid_payer) debetcur, \n"
      + "       t.t_account_receiver kreditacc, \n"
      + "       t.t_sum_receiver kreditsum, \n"
      + "       (select t_ccy from dfininstr_dbt where t_fiid = t.t_fiid_receiver) kreditcur, \n"
      + "       t.t_date_carry date_carry, \n"
      + "       (select t_name from dperson_dbt where t_oper = t.t_oper) oper, \n"
      + "       t.t_ground, \n"
      + "       t.t_number_pack pack, \n"
      + "       t.t_userfield4 usf4 \n"
      + "from (select * \n"
      + "      from dacctrn_dbt trn \n"
      + "      where  exists (select t_acctrnid \n"
      + "                     from doprdocs_dbt docs, doproper_dbt oper, dnptxop_dbt nptxop \n"
      + "                     where     t_acctrnid = trn.t_acctrnid \n"
      + "                           and oper.t_id_operation = docs.t_id_operation \n"
      + "                           and oper.t_kind_operation = 2037 \n"
      + "                           and to_number(oper.t_documentid) = nptxop.t_id \n"
//      + "                           and nptxop.t_subkind_operation = 10 \n"
      + "                     ) \n"
      + "      union \n"
      + "      select * \n"
      + "      from dacctrn_dbt trn \n"
      + "      where  exists (select t_acctrnid \n"
      + "                     from doprdocs_dbt doc, doproper_dbt oper, dpmpaym_dbt paym, dpmlink_dbt lnk \n"
      + "                     where     doc.t_dockind = 1 \n"
      + "                           and doc.t_acctrnid = trn.t_acctrnid \n"
      + "                           and doc.t_id_operation = oper.t_id_operation \n"
      + "                           and oper.t_dockind = paym.t_dockind \n"
      + "                           and to_number(oper.t_documentid) = paym.t_documentid \n"
      + "                           and lnk.t_initialpayment = paym.t_paymentid \n"
      + "                           and lnk.t_linkkind = 2 --? \n"
      + "                           and lnk.t_initialpayment <> lnk.t_purposepayment \n"
      + "                   )) t \n"
      + "where t.t_date_carry = :dt \n"
      + "      and t.t_chapter in (1)";
  sql = ExecSqlSelect(sql, MakeArray(SqlParam("dt", repdt)), false);

  while (sql.MoveNext() )
    rn = rn + 1;
    Rep.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = true;");

    if (sql.value("usf4") > 0) 
      curr_format = signal_format;
      Rep.AddPrintCell( "ВЫГРУЖЕНА!!", col0_len, null, curr_format); // 0.
    else
      curr_format = normal_format;
      Rep.AddPrintCell(" ", col0_len, null, curr_format); // 0.
    end;

    Rep.AddPrintCell(sql.value("usf4"),      col1_len, null, curr_format); // 1. ИД проводки в БИС
    Rep.AddPrintCell(sql.value("acctrnid"),  col2_len, null, curr_format); // 2. ID
    Rep.AddPrintCell(sql.value("chapter"),   col3_len, null, curr_format); // 3. Глава
    Rep.AddPrintCell(sql.value("numb"),      col4_len, null, curr_format); // 4. Номер
    Rep.AddPrintCell(sql.value("debetacc"),  col5_len, null, curr_format); // 5. Счет дебета
    Rep.AddPrintCell(sql.value("debetcur"),  col6_len, null, curr_format); // 6. Валюта дебета
    Rep.AddPrintCell(sql.value("debetsum"),  col7_len, null, curr_format); // 7. Сумма дебета
    Rep.AddPrintCell(sql.value("kreditacc"), col8_len, null, curr_format); // 8. Счет кредита
    Rep.AddPrintCell(sql.value("kreditcur"), col9_len, null, curr_format); // 9. Валюта кредита
    Rep.AddPrintCell(sql.value("kreditsum"), col10_len, null, curr_format); // 10. Сумма кредита
    Rep.AddPrintCell(sql.value("date_carry", null, V_DATE), col11_len, null, curr_format); // 11. Дата проводки
    Rep.AddPrintCell(sql.value("t_ground"),  col12_len, null, curr_format); // 12. Назначение
    Rep.AddPrintCell(sql.value("oper"),      col13_len, null, curr_format); // 13. Операционист
    Rep.AddPrintCell(sql.value("pack"),      col14_len, null, curr_format); // 14. Пачка
    Rep.AddStr();

    count = count + 1;
  end;

  rn = rn + 1;
  Rep.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
  Rep.AddPrintCell("Количество проводок: " + count, col1_len, null, "l:ex_FS(b):ex_B()");
  Rep.AddStr();

  Rep.PrintWinRep("Проводки");
  Rep.SetZoomType(ZOOM_TYPE_A4L);
  Rep.SetWinRepOutput();
  Rep.ShowWinRep();
End;

Carry_by_payment();
exit(1);