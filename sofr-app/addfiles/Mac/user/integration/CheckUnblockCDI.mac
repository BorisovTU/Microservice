/** 
 @file CheckUnblockCDI.mac
 @brief Обработчик категории "Блокировать обмен с CDI"
  
 # tag 
 - functional_block:Клиенты_Регистрация_на_бирже
 - code_type:API
 - CDI
   
 # changeLog 
 |date       |author         |tasks            |note                                                         
 |-----------|---------------|-----------------|-------------------------------------------------------------------------------------------------------------
 |27.11.2024 |Гераськина Т.В.|CCBO-10810       | Создание

*/ 
import "CDIOrg_lib.mac";

private file attr("objattr.dbt") key 0;
var AcceptedActionCategory;
var ProcessingPartyid;

/*вызывается при ручной установке по F2 из списка категорий объекта или из списка установленных атрибутов категории объекта*/
macro CheckAttributeManual(ObjectType : integer, GroupID : integer, CodeList : string, NumInList : string) : bool
  // return false; //в случае ошибки
  return true; //в случае успешной проверки
end;

/*вызывается при установке признака выбором по F9 из списка категорий объекта или из списка установленных атрибутов категории объекта*/
macro CheckAttribute(ObjectType : integer, GroupID : integer, AttrID : integer, dttr2, fff4,fff6,fff7)
  private var SERV_CDI_FIND_ORG = 5053; 
  private var cdi_isactive = uGetRegistryParam(REG_CDI_ACTIVE, V_BOOL);

  AcceptedActionCategory = GetGlobalParameter ("AcceptedActionCategory", true);
  ProcessingPartyid = GetGlobalParameter ("ProcessingPartyid", true);
  
  var needCDI = NeedSendCDI(ProcessingPartyid, date());

  if (AcceptedActionCategory and cdi_isactive and needCDI)
     PutInProcess(SERV_CDI_FIND_ORG, ProcessingPartyid, 1, "4,5,6", "-1"); // создать событие FindOrg
  end;

  return true; 
end;     

/*удаление признака категории для объекта*/
macro CheckCategoryDelete(param1,GroupID,ObjectType,ObjectID,param2,AttrID_new, param3)
  msgbox("Удаление значения категории невозможно");
  setparm(0, 1); // запретим удаление категории установкой параметра 0 
end;

macro CheckCategorySet(param1,GroupID,ObjectType,ObjectID,param2,AttrID_new, param3, f1,f2,f3,f4)
   var ObjCat;
   var AttrID_old = 0;
   var IsAttr, stat;
  
   record attr("objattr.dbt") key 0;

   AcceptedActionCategory = false;

   ObjCat = RsbObjCategories(ObjectType, ObjectID);   // текущее значение
   IsAttr = ObjCat.IsAttrPresense(GroupID, PARTY_CATEGORY_BLOCK_UNLOAD_CDI_YES, null, null, null, date()); // установлено ли "да" GetFirst, GetMainAttr не подходят

   if ( (IsAttr) and (AttrID_new == PARTY_CATEGORY_BLOCK_UNLOAD_CDI_NO))
      AcceptedActionCategory = true;
   end;

   SetGlobalParameter ("AcceptedActionCategory", AcceptedActionCategory);
   SetGlobalParameter ("ProcessingPartyid", Int(ObjectID));
  
   return true;
end;