/*
carry_no_sent.mac
*/
import globals, or_rep_h, oralib, likepy;
import or_rep_h;
import or_tpl_h;
import or_const;

macro Carry_no_sent_rep ()
  var EXCEL_MONEY = "\"# ##0,00\"";
  var repdt = {curdate};
  var rn    = 0;
  var sheet = 1;
  var count = 0;
  var col1_len = 6;
  var col2_len = 5;
  var col3_len = 12;
  var col4_len = 20;
  var col5_len = 7;
  var col6_len = 14;
  var col7_len = 20;
  var col8_len = 7;
  var col9_len = 14;
  var col10_len = 12;
  var col11_len = 30;
  var col12_len = 15;
  var col13_len = 10;
  var col14_len = 10;
  var col15_len = 10;
  var Rep, sql,csvFile,csvTable,fName;

  if (not GetDate(repdt)) 
    return 1;
  end;

  Rep = CTemplateXLS(NULL, NULL, NULL, NULL, NULL, NULL, true, false);
  csvFile = C_CSVFile();
  fName = csvFile.CreateFullFileName("carry_no_sent_csv.txt");

  if(Rep.UsePoi())
	  Rep.SetXLSXFormat();
  end;
  
  Rep.CreateTotalBook();

  Rep.openTemplate("Carry_no_sent_template.xlsx",true);
  Rep.SheetChange(1);

  csvTable = Rep.RegisterTable("templateTable", "templateHeader", true);
  csvFile.FileOpen(fName, true);

  Rep.SetValue_NameCell("Date", "Список проводок СОФР, не выгруженных в Бисквит на дату "+repdt);
  Rep.CopyAllSheetInTotalBook(null, false, "templateHeader", 0, "Проводки");


sql = " select t_acctrnid acctrnid, "
    + "       t_chapter chapter, "
    + "       t_numb_document numb, "
    + "       t_account_payer debetacc, "
    + "       t_sum_payer debetsum, "
    + "       (select t_ccy from dfininstr_dbt where t_fiid = a.t_fiid_payer) debetcur, "
    + "       t_account_receiver kreditacc, "
    + "       t_sum_receiver kreditsum, "
    + "       (select t_ccy from dfininstr_dbt where t_fiid = a.t_fiid_receiver) kreditcur, "
    + "       t_date_carry date_carry, "
    + "       (select t_name from dperson_dbt where t_oper = a.t_oper) oper, "
    + "       t_ground, "
    + "       a.t_number_pack pack, "
    + "       a.t_userfield4 usf4, "
    + "       b.t_resulttext restext "
    + "from (select * from dacctrn_dbt acctrn "
    + "where     acctrn.t_chapter in (1, 3, 4) "
    + "      and t_date_carry = :dt "
    + "      and t_state = 1 "
    + "      and t_userfield2 <> '1' "
    + "      and t_userfield4 = chr(1) "
    + "      AND ((SUBSTR(T_ACCOUNT_RECEIVER, 1, 3) <> '301' "
    + "            OR (SUBSTR(T_ACCOUNT_RECEIVER, 1, 5) IN ('30109', "
    + "                                                      '30111', "
    + "                                                      '30112', "
    + "                                                      '30113', "
    + "                                                      '30116', "
    + "                                                      '30117', "
    + "                                                      '30122', "
    + "                                                      '30123') "
    + "                AND T_NUMBER_PACK = 160) "
    + "            OR (SUBSTR(T_ACCOUNT_RECEIVER, 1, 5) =  ('30102') "
    + "                AND T_NUMBER_PACK = 170) "
    + "           ) "
    + "           AND (SUBSTR(T_ACCOUNT_PAYER, 1, 3) <> '301' "
    + "                OR (SUBSTR(T_ACCOUNT_PAYER, 1, 5) IN ('30111', "
    + "                                                           '30109') "
    + "                    AND T_NUMBER_PACK = 160)) "
    + "           AND (SUBSTR(T_ACCOUNT_RECEIVER, 1, 3) <> '303' "
    + "                OR (SUBSTR(T_ACCOUNT_RECEIVER, 1, 5) IN ('30301', "
    + "                                                              '30303') "
    + "                    AND T_NUMBER_PACK = 160)) "
    + "           AND SUBSTR(T_ACCOUNT_PAYER, 1, 3) <> '303' "
    + "           AND SUBSTR(T_ACCOUNT_PAYER, 1, 3) <> '202' "
    + "           AND SUBSTR(T_ACCOUNT_RECEIVER, 1, 3) <> '202' "
    + "           AND INSTR('134',TO_CHAR(T_CHAPTER)) > 0 "
    + "           AND T_DATE_CARRY >= TO_DATE('01012019','ddmmyyyy') "
    + "           AND T_RESULT_CARRY <> 18 "
    + "           AND T_RESULT_CARRY <> 82 "
    + "           AND T_RESULT_CARRY <> 46 "
    + "           ) ) a left join utableprocessevent_dbt b "
    + "           on b.t_objectid = a.t_acctrnid "
    + "           and b.t_objecttype = 1 "
    + "order by a.t_chapter, a.t_oper, a.t_acctrnid ";
  sql = ExecSqlSelect(sql, MakeArray(SqlParam("dt", repdt)), false);

  while (sql.MoveNext() )
    csvFile.AddCell(sql.value("acctrnid")); // 1. ID
    csvFile.AddCell(sql.value("chapter")); // 2. Глава
    csvFile.AddCell(sql.value("numb")); // 3. Номер
    csvFile.AddCell(sql.value("debetacc")); // 4. Счет дебета
    csvFile.AddCell(sql.value("debetcur")); // 5. Валюта дебета
    csvFile.AddCell(sql.value("debetsum")); // 6. Сумма дебета
    csvFile.AddCell(sql.value("kreditacc")); // 7. Счет кредита
    csvFile.AddCell(sql.value("kreditcur")); // 8. Валюта кредита
    csvFile.AddCell(sql.value("kreditsum")); // 9. Сумма кредита
    csvFile.AddCell(date(sql.value("date_carry"))); // 10. Дата проводки
    csvFile.AddCell(sql.value("t_ground")); // 11. Назначение
    csvFile.AddCell(sql.value("oper")); // 12. Операционист
    csvFile.AddCell(sql.value("pack")); // 13. Пачка
    csvFile.AddCell(sql.value("usf4")); // 14. ИД проводки в БИС
    if (ValType(sql.value("restext")) != 26 )
      csvFile.AddCell(sql.value("restext")); // 15. Причина
    else
      csvFile.AddCell(""); // 15. Причина
    end;
    csvFile.AddRow();
    count = count + 1;
  end;

  csvFile.FileClose ();
  csvTable.FillTabelFromCSV (csvFile.GetlsFileName ());
  csvTable.EndTable ();

  Rep.SetValue_NameCell("CountUnLoad", "Количество невыгруженных проводок: " + count);
  Rep.CopyAllSheetInTotalBook(null, false, csvTable.GetTableRange(), 0, "Проводки");
  Rep.CopyAllSheetInTotalBook(null, false, "templateFooter", 0, "Проводки");
  


  /*************************ПЛАТЕЖИ*********************/
  Rep.SheetChange(2);
  count = 0;

  csvFile = C_CSVFile();

  csvTable = Rep.RegisterTable("templateTable2", "templateHeader2", true);

  csvFile.FileOpen(fName, true);
  Rep.CopyAllSheetInTotalBook(null, false, "templateHeader2", 0, "Платежи");

  sql = " select a.*, b.t_resulttext restext from "
      + "       (select pmpaym.t_paymentid paymentid, \n"
      + "       pmrmprop.t_payername payer, \n"
      + "       pmrmprop.t_payerbankname payerbank, \n"
      + "       t_payeraccount payeracc, \n"
      + "       pmrmprop.t_receivername receiver, \n"
      + "       pmrmprop.t_receiverbankname receiverbank, \n"
      + "       t_receiveraccount receiveracc, \n"
      + "       t_baseamount summ, \n"
      + "       (select t_ccy from dfininstr_dbt where t_fiid = pmpaym.t_basefiid) fiid, \n"
      + "       pmrmprop.t_ground ground, \n"
      + "       (select t_name from dperson_dbt where t_oper = pmpaym.t_oper) oper, \n"
      + "       oprdoc.t_name fdname, \n"
      + "       pmpaym.t_chapter chapter, \n"
      + "       pmpaym.t_valuedate dt \n"
      + "from dpmrmprop_dbt pmrmprop, dpmpaym_dbt pmpaym \n"
      + "left join doprkdoc_dbt oprdoc on oprdoc.t_dockind = pmpaym.t_dockind \n"
      + "where     pmpaym.t_payerbankid = 1 \n"
      + "      and pmpaym.t_receiverbankid <> 1 \n"
      + "      and pmpaym.t_valuedate = :dt \n"
      + "      and pmpaym.t_netting = chr(0) \n"
      + "      and pmpaym.t_isfactpaym = chr(88) \n"
      + "      and pmpaym.t_chapter in (1, 3, 4) \n"
      + "      and pmpaym.t_paymentid = pmrmprop.t_paymentid \n"
      + "      and not (pmpaym.t_dockind = 102 and pmpaym.t_purpose = 9 and exists(select 1 from ddl_tick_dbt tick where tick.t_bofficekind = pmpaym.t_dockind and tick.t_dealid = pmpaym.t_documentid and tick.t_flag1 = 'X')) \n"
      + "      and not exists (select 1 from utableprocessevent_dbt where t_objecttype = 501 and t_objectid = pmpaym.t_paymentid and t_status = 4) ) a \n"
      + "      left join utableprocessevent_dbt b \n"
      + "      on b.t_objecttype = 501 \n"
      + "      and b.t_objectid = a.paymentid \n";
  sql = ExecSqlSelect(sql, MakeArray(SqlParam("dt", repdt)), false);

  while (sql.MoveNext() )
    rn = rn + 1;

    csvFile.AddCell(sql.value("paymentid")); // 1. ID
    csvFile.AddCell(sql.value("chapter")); // 2. Глава
    csvFile.AddCell(sql.value("payer")); // 3. Плательщик
    csvFile.AddCell(sql.value("payeracc")); // 4. Счет плательщика
    csvFile.AddCell(sql.value("summ")); // 5. Сумма
    csvFile.AddCell(sql.value("receiver")); // 6. Получатель
    csvFile.AddCell(sql.value("receiverbank")); // 7. Банк получателя
    csvFile.AddCell(sql.value("receiveracc")); // 8. Счет получателя
    csvFile.AddCell(date(sql.value("dt"))); // 9. Дата платежа
    csvFile.AddCell(sql.value("ground")); // 10. Назначение
    csvFile.AddCell(sql.value("oper")); // 11. Операционист
    csvFile.AddCell(sql.value("fdname")); // 12. Первичный документ
    if (ValType(sql.value("restext")) != 26)
      csvFile.AddCell(sql.value("restext")); // 13. Причина
    else
      csvFile.AddCell(""); // 13. Причина
    end;
    csvFile.AddRow();

    count = count + 1;
  end;

  csvFile.FileClose ();
  csvTable.FillTabelFromCSV (csvFile.GetlsFileName ());
  csvTable.EndTable ();

 
  Rep.CopyAllSheetInTotalBook(null, false, csvTable.GetTableRange(), 0, "Платежи");
  Rep.SetValue_NameCell("CountUnLoad2", "Количество невыгруженных платежей: " + count);
  Rep.CopyAllSheetInTotalBook(null, false, "templateFooter2", 0, "Платежи");
  Rep.Close();

  Rep.SaveTotalBook();

End;

Carry_no_sent_rep();
exit(1);