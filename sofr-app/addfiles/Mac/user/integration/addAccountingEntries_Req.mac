/**
 @file 		mac\user\integration\addAccountingEntries_Req.mac
 @brief 	Передача из СОФР данных по проводкам

 # changelog
 |date       |autor          |tasks                                           |note
 |-----------|---------------|------------------------------------------------|-------------------------------------------------------------
 |03.07.2025 |Велигжанин А.В.|BOSS-7143                                       |IsSynAcc(), доработка платежа для целей списания
 |14.01.2025 |В.Горленко     |                                                |Передача из СОФР данных по проводкам

*/
//-----------------------------------------------------------------------------------------
// Передача из СОФР данных по проводкам
// В.Горленко
//-----------------------------------------------------------------------------------------
import globals, bankinter, oralib, likepy, fiinter, ptinter;
import func_lib, "WLTOOLS.MAC", "CFTDocumentTypeCodes.mac";

private const extCodeKind = 1; // Код субъекта в Бисквит

//!!!!!!А.Киселев 14.03.2019 удалить когда будут согласованы новые свойства для SWIFT сообщений
private var PayerNameENG :string = "",
            ReceiverNameENG :string = "";
//!!!!!!А.Киселев 14.03.2019 удалить когда будут согласованы новые свойства для SWIFT сообщений



private macro GetSWIFTFieldFromMess( paymentid :integer, FieldType :string, DefValue :string ) :string
var DataSet :RsdRecordset;

  DataSet = execSqlSelect( " SELECT X.T_TPFIELDID, X.T_VALUE, Z.T_NAME, " +
                                    "  (CASE WHEN INSTR(Z.T_NAME, '56') = 1 THEN '56' " +
                                    "        WHEN INSTR(Z.T_NAME, '58') = 1 THEN '58' " +
                                    "        WHEN INSTR(Z.T_NAME, '86') = 1 THEN '86' " +
                                    "        WHEN INSTR(Z.T_NAME, '57') = 1 THEN '57' " +
                                    "   END) AS NAME_FLD " +
                                    " FROM dwlmesval_dbt X, dwltpfld_dbt Z " +
                                    " WHERE T_MESID = (SELECT T_MESID FROM dwlmeslnk_dbt " +
                                    "                  WHERE T_OBJKIND = 501 AND T_OBJID = (SELECT T_WLPMID " +
                                    "                                                       FROM dwlpm_dbt WHERE T_PAYMENTID = :1)) " +
                                    "  AND Z.T_TPFIELDID = X.T_TPFIELDID " +
                                    "  AND Z.T_TPFIELDID IN ( (SELECT Y.T_TPFIELDID FROM dwltpfld_dbt Y " +
                                    "                          WHERE  Y.T_NAME LIKE :2 || '%' ) ) ",
                                    makeArray ( sqlParam ( "1", paymentId ),
                                                sqlParam ( "2", FieldType ) ) );


  if( DataSet.moveNext() )

     if( ( ValType(DataSet.value(1, Null, V_STRING)) != V_UNDEF ) and
        ( ValType(DataSet.value(1, Null, V_STRING)) != 26 ) )

        return StrSubst(DataSet.value(1, Null, V_STRING),"\n","");

     end;

  end;

  if( Valtype(DefValue) == V_UNDEF )

   return DefValue;

  else

   return "";

  end;

onError(err)

  if( Valtype(DefValue) == V_UNDEF )

   return DefValue;

  else

   return "";

  end;

end;




private macro AddLogControllerPersonalNumber( ControllerPersonalNumber :string, ObjectType :integer, ObjectId :integer ) 
var Params :TArray,
    DataSet :RsdRecordset,
    Query :string = "";

  Query = " DECLARE " +
          "  p_Oper200               uOper200na_log.T_OPER200%TYPE := :p_Oper200; " +
          "  p_ObjectType            uOper200na_log.T_OBJECTTYPE%TYPE := :p_ObjectType; " +
          "  p_ObjectId              uOper200na_log.T_OBJECTID%TYPE := :p_ObjectId; " +
          
          " BEGIN " +
          
          "  INSERT INTO uOper200na_log " +
          "   (SELECT p_Oper200, p_ObjectType, p_ObjectId,  TRUNC(SYSDATE), TO_DATE('01.01.0001:' || TO_CHAR(SYSDATE, 'HH24:MI:SS'), 'DD.MM.YYYY:HH24:MI:SS') " +
          "   FROM DUAL ); " +
          
          " END; ";
 
  Params = Null;
  Params = makeArray( SQLParam("p_Oper200", ControllerPersonalNumber),
                      SQLParam("p_ObjectType", ObjectType),
                      SQLParam("p_ObjectId", ObjectId) );

  execSQL( Query, Params );
  Params = Null;


onError(err)

 Params = Null;

end;




private class TIntegrationSymbolicIdentifierX
var ObjectId :string,
    SystemId :string,
    SystemNodeId :string;

end;

private class TIntegrationRecordX
var RecordCode :string,
    RecordTitle :string,
    Note :string,
    SystemId :string,
    SystemNodeId :string;

end;


private class(TIntegrationRecordX) TIntegrationDictionaryRecordX
var Desc :string,
    DictionaryCode :string;

end;


private class TCoupledPerson
var StartDate :date,
    EndDate :date,
    RoleCode :TIntegrationDictionaryRecordX,
    CoupledPersonId :TIntegrationSymbolicIdentifierX;

end;


private class TSet1
var Month :integer,
    Year :integer,
    UnifiedAccountNumber :string;

end;


private class TSet2
var AccountNumber :string,
    Month :integer,
    Year :integer;

end;


private class TSet3
var ServiceID :string,
    Month :integer,
    Year :integer;

end;


private class TSet4
var Month :integer,
    Year :integer,
    PaymentDocumentNumber :string,
    Apartment :string, 
    Placement :string, 
    NonLivingApartment :string,
    FIASHouseGuid :string;

end;


private class TZKHSigns
var PaymentDocumentID :string,
    Set1 :TSet1,
    Set2 :TSet2,
    Set3 :TSet3,
    Set4 :TSet4;

end;


private class TGMPSigns
var BillId :string, //УИН - Уникальный идентификатор начислений
    PaymentID :string,
    PayeeID :string;

end;


private class TTaxsSigns
/* 20181205 - kva - изменение схемы */
var KBK :string,
    TaxPeriod :string,
    TaxDocNumber :string,
    TaxDocDate :string,
/*  shev 20191017 должен быть тип справочник 
    StatusCode :string,
    PaymentTypeCode :string, /* 20181205 - kva - изменено с PaymentType */
    PurposeCode :string; /* 20181205 - kva - изменено с Purpose */
*/
    StatusCode :TIntegrationDictionaryRecordX,
    PaymentTypeCode :TIntegrationDictionaryRecordX, 
    PurposeCode :TIntegrationDictionaryRecordX; 
end;


private class TCardSigns
var CardTransactionId :string,
    HoldOperationId :TIntegrationSymbolicIdentifierX;

end;


private class TCashSigns
var CashSymbol :string,
    SessionNumber :string;

end;


private class TAccountNumberWithCurrency
var AccountNumber :string,
    CurrencyCode  :string;

end;


private class TSWIFTSigns( PaymentId )
var MessageTypes :string, /* 20181205 - kva - изменено с MT */
    SWIFTMessage :string, /* 20181205 - kva - изменено с SWIFT */
    IntermediaryBank,
    TheBeneficiarysBank,
    BankBeneficiary,
    SWIFTCurrency :object; /* :TIntegrationDictionaryRecordX;*/ /* 20181205 - kva - изменено с Currency */ /* 20181214 - kva - явная типизация не желательна */


   macro InitSWIFTSigns( PaymentId )
      var sql, sql1, sql2 ;

//!!!!!!А.Киселев 14.03.2019 удалить когда будут согласованы новые свойства для SWIFT сообщений
      PayerNameENG = Null;
      ReceiverNameENG = Null;
//!!!!!!А.Киселев 14.03.2019 удалить когда будут согласованы новые свойства для SWIFT сообщений
      sql2 = Null;
      sql1 = Null;
      sql  = Null;
      sql1 = execSqlSelect( "select t_name from dwlmesfrm_dbt where t_formid = (select t_formid from dwlmesrls_dbt where t_rlsformid = (select t_rlsformid from dpmprop_dbt where t_debetcredit = 1 and t_paymentid = :1 and t_tpid = 2))",
                            makeArray ( sqlParam( "1", paymentId ) ) );

      //maa040419 - временно через dwlmes_dbt пока дистр не починит ошибки (по просьбе Рощ)
      sql2 = execSqlSelect( "SELECT t_name FROM dwlmesfrm_dbt WHERE t_formid = (SELECT t_formid FROM dwlmesrls_dbt WHERE t_rlsformid = (SELECT wlmes.t_rlsformid FROM dwlpm_dbt wlpm, dwlmeslnk_dbt wllnk, dwlmes_dbt wlmes "+ 
                            " WHERE wllnk.t_mesid = wlmes.t_mesid and  wllnk.t_objid = wlpm.t_wlpmid and wllnk.t_objkind = 501 and wlpm.t_paymentid = :2 ))",
                            makeArray ( sqlParam( "2", paymentId ) ) );

      if( sql1.moveNext() )


         sql = execSqlSelect( "select listagg ((select ':' || t_name from dwltpfld_dbt where t_tpfieldid = (select t_tpfieldid from dwlmesfld_dbt where t_fieldid = x.t_fieldid))||':'||t_value, chr (10)) within group (order by t_index) from dwlmesval_dbt x where t_mesid = (select t_mesid from dwlmeslnk_dbt where t_objkind = 501 and t_objid = (select t_wlpmid from dwlpm_dbt where t_paymentid = :1))",
                              makeArray ( sqlParam ( "1", paymentId ) ) );

         if( sql.moveNext() )
            if( Valtype(sql.value(0)) != 26 )
               SWIFTMessage = sql.value(0);

              if( sql2.moveNext() and valtype(sql2.value(0)) !=v_undef )
               MessageTypes = sql2.value(0); //через dwlmes_dbt
              else
               MessageTypes = sql1.value(0); //через dpmprop_dbt
              end;
               sql2 = Null;
               sql1 = Null;
               sql = Null;

               sql = execSqlSelect ( "select decode (t_payfiid, 0, 0, 1) from dpmprop_dbt where t_debetcredit=1 and t_paymentid=:1",
                                     makeArray ( sqlParam ( "1", paymentId ) ) );

               if( sql.moveNext() )
                  SWIFTCurrency = TIntegrationDictionaryRecordX; /* 20181214 - kva - теперь инициализируем объект */
                  SWIFTCurrency.RecordCode = int( sql.value (0) );
               end;


               sql = execSqlSelect( " SELECT X.T_TPFIELDID, X.T_VALUE, Z.T_NAME, " +
                                    "  (CASE WHEN INSTR(Z.T_NAME, '56') = 1 THEN '56' " +
                                    "        WHEN INSTR(Z.T_NAME, '58') = 1 THEN '58' " +
                                    "        WHEN INSTR(Z.T_NAME, '86') = 1 THEN '86' " +
//                                    "        WHEN INSTR(Z.T_NAME, '52') = 1 THEN '52' " +
                                    "        WHEN INSTR(Z.T_NAME, '57') = 1 THEN '57' " +
                                    "   END) AS NAME_FLD " +
                                    " FROM dwlmesval_dbt X, dwltpfld_dbt Z " +
                                    " WHERE T_MESID = (SELECT T_MESID FROM dwlmeslnk_dbt " +
                                    "                  WHERE T_OBJKIND = 501 AND T_OBJID = (SELECT T_WLPMID " +
                                    "                                                       FROM dwlpm_dbt WHERE T_PAYMENTID = :1)) " +
                                    "  AND Z.T_TPFIELDID = X.T_TPFIELDID " +
                                    "  AND Z.T_TPFIELDID IN ( (SELECT Y.T_TPFIELDID FROM dwltpfld_dbt Y " +
                                    "                          WHERE  Y.T_NAME LIKE '56%' " +
                                    "                           OR Y.T_NAME LIKE '58%' " +
//                                    "                           OR Y.T_NAME LIKE '52%' " +
                                    "                           OR Y.T_NAME LIKE '57%' " +
                                    "                           OR Y.T_NAME LIKE '86%' ) ) ",
                                    makeArray ( sqlParam ( "1", paymentId ) ) );


               while( sql.moveNext() )

                 if( sql.value(3, Null, V_STRING) == 56 )

                  if( ( ValType(sql.value(1, Null, V_STRING)) != V_UNDEF ) and
                     ( ValType(sql.value(1, Null, V_STRING)) != 26 ) )

                   IntermediaryBank = sql.value(1, Null, V_STRING);

                  end;

                 elif( sql.value(3, Null, V_STRING) == 57 )

                  if( ( ValType(sql.value(1, Null, V_STRING)) != V_UNDEF ) and
                     ( ValType(sql.value(1, Null, V_STRING)) != 26 ) )

                   TheBeneficiarysBank = sql.value(1, Null, V_STRING);

                  end;
 
                 elif( sql.value(3, Null, V_STRING) == 58 )

                  if( ( ValType(sql.value(1, Null, V_STRING)) != V_UNDEF ) and
                    ( ValType(sql.value(1, Null, V_STRING)) != 26 ) )

                   BankBeneficiary = sql.value(1, Null, V_STRING);

                  end;

//!!!!!!А.Киселев 14.03.2019 заменить когда будут согласованы новые свойства для SWIFT сообщений
/*
                 elif( sql.value(3, Null, V_STRING) == 52 )

                  if( ( ValType(sql.value(1, Null, V_STRING)) != V_UNDEF ) and
                     ( ValType(sql.value(1, Null, V_STRING)) != 26 ) )

                   PayerNameENG = sql.value(1, Null, V_STRING);

                  end;

                 elif( sql.value(3, Null, V_STRING) == 57 )

                  if( ( ValType(sql.value(1, Null, V_STRING)) != V_UNDEF ) and
                     ( ValType(sql.value(1, Null, V_STRING)) != 26 ) )

                   ReceiverNameENG = sql.value(1, Null, V_STRING);

                  end;
*/
//!!!!!!А.Киселев 14.03.2019 заменить когда будут согласованы новые свойства для SWIFT сообщений

                 end;

               end;


            end;
         end;

      end;
      sql1 = Null;
      sql = Null;

   end;

   InitSWIFTSigns( PaymentId ); //конструктор

end;

// BIQ-6900 Хеджирование Гераськина Т.В.
private class THedgeDetails( dockind, documentid, userfield1 )
var SubPortfolio: string,
    RelationsId,
    ObjectId,
    InstrumentId,
    DealId,
    /*BIQ-10394 */
    SofrInstrumentId,         // ID инструмента хеджирования в СОФР     Да    Идентификатор
    CustomTransactionField    // Выгрузка значения пользовательского поля проводки     Строка   Нет
;

   macro InitHedgeDetails( dockind, documentid, userfield1 )
      var sql_str, cmd, rs;
      var h_objid = 0;
      // патч 78, изменение способа хранения
/*      sql_str = "select instr.t_ext_subportf SubPortfolio, instr.t_ext_hedgeid RelationsId, "+
                "       h.t_ext_code ObjectId, instr.t_ext_dealid InstrumentId, h.t_ext_dealid DealId, h.t_objid "+
                "  from ddlhedgeinstr_dbt instr, "+
                "       ddlhedge_dbt h "+
                " where instr.t_dealid = :dealid and instr.t_dockind = :dockind "+
                "   and h.t_instrid = instr.t_dealid";   */
      sql_str = "select t_ext_subportf SubPortfolio, t_ext_hedgeid RelationsId, "+
                "       t_ext_objid ObjectId, t_ext_instrid InstrumentId, t_ext_dealid DealId, t_objid, "+
                "       t_instrid Instrument_sofr "+
                "  from DDLHDGRELATION_DBT "+
                " where t_instrid = :dealid and t_instrdockind = :dockind ";
      cmd = RSDCommand(sql_str);
      cmd.AddParam("dealid", RSDBP_IN, documentid );
      cmd.AddParam("dockind", RSDBP_IN, dockind );
      rs = RSDRecordSet(cmd);
      if (rs.movenext)
         SubPortfolio = rs.value("SubPortfolio");
         RelationsId = TIntegrationSymbolicIdentifierX();
         RelationsId.ObjectId = rs.value("RelationsId");
         ObjectId = TIntegrationSymbolicIdentifierX();
         ObjectId.ObjectId = rs.value("ObjectId");
         InstrumentId = TIntegrationSymbolicIdentifierX();
         InstrumentId.ObjectId = rs.value("InstrumentId");
         DealId = TIntegrationSymbolicIdentifierX();
         DealId.ObjectId = rs.value("DealId");
         SofrInstrumentId = TIntegrationSymbolicIdentifierX();
         SofrInstrumentId.ObjectId = rs.value("Instrument_sofr");
         CustomTransactionField = userfield1;
         h_objid =  rs.value("t_objid");
      end;

      rs.close; cmd.close; rs = null; cmd = null;
      sql_str = Null;

      if ( h_objid > 0 )  
         if ( ObjectId.ObjectId == StrFor(1) )
            sql_str = "select obj.t_code ObjectId "+
                      "  from dv_dlhedgeobj_dbt obj "+
                      " where obj.t_objid = :h ";
            cmd = RSDCommand(sql_str);
            cmd.AddParam("h", RSDBP_IN, h_objid );
            rs = RSDRecordSet(cmd);
            if (rs.movenext)
               ObjectId.ObjectId = rs.value("ObjectId");
            end;
            rs.close; cmd.close; rs = null; cmd = null;
            sql_str = Null;
         end;
      end;

   end;

   InitHedgeDetails( dockind, documentid, userfield1 ); //конструктор

end;

                  


// gtv: вынесено в func_lib.mac
/*
Private macro getUserCode ( oper )
    Var sql = execSqlSelect ("select t_code from dpartcode_dbt where t_codekind=:1 and t_partyid=(select t_partyid from dperson_dbt where t_oper=:2)",
                             makeArray (sqlParam ("1", extCodeKind), sqlParam ("2", oper)));
    if ( sql.moveNext () )
        return string (sql.value (0));
    end;
    return "";
End;
*/
//-----------------------------------------------------------------------------------------

Private macro getFilialId ( id )
   /* var sql = execSqlSelect("select t_code from dpartcode_dbt where t_codekind=:1 and t_partyid=(select t_partyid from ddp_dep_dbt where t_code=:2)",
              makeArray(sqlParam("1", extCodeKind), sqlParam("2", id)));
   if( sql.moveNext() )
     return string(sql.value(0));
   end; */
   // gtv: код из наименования dp_dep, кроме ГО
   if (id == 1)
     return "0000";
   else
     var sql = execSqlSelect("select t_name from ddp_dep_dbt where t_code=:1",
                makeArray(sqlParam("1", id)));
     if( sql.moveNext() )
       return string(sql.value(0));
     end;
   end;

   return "";
End;
//-----------------------------------------------------------------------------------------

Private macro getExtClientId ( id )
    Var sql = execSqlSelect ("select t_code from dpartcode_dbt where t_codekind=:1 and t_partyid=:2",
                             makeArray (sqlParam ("1", extCodeKind), sqlParam ("2", id)));
    if ( sql.moveNext () )
        return string (sql.value (0));
    end;
    return "";
End;
//-----------------------------------------------------------------------------------------


private class TThirdPersonInfo( PaymentId )
var LastName :string,
    FirstName :string,
    MiddleName :string,
    ResidenceAddress :string,
    INN :string;
    

 macro InitThirdPersonInfo( PaymentId )
 var sql;
/* 
  sql = execSqlSelect("select (select t_code from dpartcode_dbt where t_codekind="+PTCK_INN+" and t_partyid=dpersn_dbt.t_personid) t_inn, "+
                      "(select t_adress from dadress_dbt where t_type=1 and t_partyid=dpersn_dbt.t_personid) t_adress, "+
                      "dpersn_dbt.* from dpersn_dbt where t_personid=:1",
           makeArray( sqlParam( "1", partyId ) ) );
  if( sql.moveNext() )

   LastName = sql.value("t_name1");
   FirstName = sql.value("t_name2");
   MiddleName = sql.value("t_name3");

   if( valType( sql.value("t_inn") ) != 26 )
    INN = sql.value("t_inn");
   end;

   if( valType( sql.value("t_adress") ) != 26 )
    ResidenceAddress = sql.value ("t_adress");
   end;

  end;

  sql = execSqlSelect( "select (select t_codedocum from dpaprkind_dbt where t_paperkind = x.t_paperkind) t_kind, x.* from dpersnidc_dbt x where t_isnotvalid = chr (0) and t_personid = :1 order by decode (t_ismain, 'X', 0, 1)",
           makeArray( sqlParam( "1", partyid ) ) );

  if( sql.moveNext() )
   DocumentType.Desc = sql.value("t_kind");
   DocumentNumber = trim( sql.value("t_paperseries") + " " + sql.value("t_papernumber") );
   DocumentIssue = date( sql.value("t_paperissueddate") );
   DocumentIssuer = sql.value("t_paperissuer");
  end;

  PersonId.ObjectId = getExtClientId(partyId);
  sql = execSqlSelect ("select t_payeraccount from dpmpaym_dbt where t_paymentid = :1",
           makeArray (sqlParam ("1", paymentId)));

  if( sql.moveNext () )
   acct_send = sql.value(0);
  end;

  sql = execSqlSelect( "select t_codekind, t_bankcode, t_transferdate, t_corschem, t_payfiid from dpmprop_dbt where t_debetcredit=1 and t_paymentid = :1",
           makeArray( sqlParam("1", paymentId) ) );

  if( sql.moveNext() )
   if( int( sql.value("t_codekind") ) == 6 )
    BankCountryRec.RecordCode = substr( sql.value("t_bankcode"), 5, 2);
   else
    BankCountryRec.RecordCode = "RU";
   end;

   Treasury1 = date( sql.value("t_transferdate") );
   sql = execSqlSelect("select t_code from dpartcode_dbt where t_codekind in (3, 6) and t_partyid = (select t_corrid from dcorschem_dbt where t_fiid=:1 and t_number=:2 and t_isnostro='X') order by decode (t_codekind, 6, 1, 2)",
            makeArray( sqlParam( "1", int( sql.value("t_payfiid") ) ),
                       sqlParam("2", int( sql.value("t_corschem") ) ) ) );
   if( sql.moveNext() )
    Treasury3 = sql.value(0);
   else
    Treasury1 = NULL;
   end;            

  end;

  CountryRec.RecordCode = ""; //???
  sql = execSqlSelect( "select t_payername from dpmrmprop_dbt where t_paymentid = :1", 
           makeArray( sqlParam( "1", paymentId ) ) );

  if( sql.moveNext() )
   NameSend = sql.value(0);
  end;
*/
 end;

 InitThirdPersonInfo( PaymentId );  //конструктор

end;


private class TLegalInfoPayer( partyid, paymentId )
var LEPayerName :string, /* 20181205 - kva - изменено с LegalEntityName */
    LEPayerAddress :string, /* 20181205 - kva - новый параметр */
    INN :string,
    KPP :string,
    LEPayerAccount :string, /* 20181205 - kva - изменено с AcctSend */
    NostroBank :string, /* 20181205 - kva - изменено с Treasury3 */
    NostroValueDate :string, /* 20181205 - kva - изменено с Treasury1 */
    NameSend :string,
    LegalEntityId :TIntegrationSymbolicIdentifierX,
    LEPayerCountryCode :TIntegrationDictionaryRecordX, /* 20181205 - kva - изменено с CountryRec */
    LEPayerBankCountryCode :TIntegrationDictionaryRecordX; /* 20181205 - kva - изменено с BankCountryRec */


   macro InitLegalInfoPayer( partyId, paymentId )
      var sql,
          CountryCode :string = "";

      sql = execSqlSelect ( "select (select t_code from dpartcode_dbt where t_codekind="+PTCK_INN+" and t_partyid=dparty_dbt.t_partyid) t_inn, "+
                            "(select t_adress from dadress_dbt where t_type=1 and t_partyid=dparty_dbt.t_partyid) t_adress, "+
                            "dparty_dbt.* from dparty_dbt where t_partyid=:1",
                            makeArray ( sqlParam ( "1", partyId ) ) );

      if ( sql.moveNext() )

         if ( valType( sql.value("t_inn") ) != 26 )
            splitFullInn( sql.value("t_inn"), INN, KPP);
            if (Trim(KPP) == "") //DEF-54305
              KPP = "0";
            end;
         else
          INN = "0";
          KPP = "0"; //DEF-54305
         end;

         LEPayerName = sql.value("t_name"); /* 20181205 - kva - изменение */

      end;

      LegalEntityId.ObjectId = getExtClientId(partyId);

      sql = execSqlSelect ( " select A.t_payeraccount, " +
                            "  NVL( ( SELECT B.T_NRCOUNTRY FROM dparty_dbt B " +
                            "         WHERE B.T_PARTYID = A.T_PAYERBANKID ), 'RUS' ) AS COUNTRYCODE, A.t_dockind " +
                            " from dpmpaym_dbt A where A.t_paymentid = :1 ",
                            makeArray ( sqlParam ( "1", paymentId ) ) );

      if ( sql.moveNext() )
         LEPayerAccount = sql.value(0);
         CountryCode = sql.value(1, Null, V_STRING);
         
         if ((sql.value(2) == 102) and (KPP == "0")) //DEF-62459, для платежей МБК не заполняем
           KPP = "";
         end;
      end;

      sql = execSqlSelect ( "select t_codekind, t_bankcode, t_transferdate, t_corschem, t_payfiid from dpmprop_dbt where t_debetcredit=1 and t_paymentid = :1",
                            makeArray ( sqlParam ( "1", paymentId ) ) );

      if( sql.moveNext() )
/* А.Киселев 01.02.2019 теперь 3 символа-буквы код страны 
         if( int( sql.value ("t_codekind") ) == 6 )
            LEPayerBankCountryCode.RecordCode = substr( sql.value("t_bankcode"), 5, 2 );
         else
            LEPayerBankCountryCode.RecordCode = "RU";
         end;
*/
         LEPayerBankCountryCode.RecordCode = CountryCode;

         NostroValueDate = date (sql.value ("t_transferdate"));
         sql = execSqlSelect ( "select t_code from dpartcode_dbt where t_codekind in (3, 6) and t_partyid = (select t_corrid from dcorschem_dbt where t_fiid=:1 and t_number=:2 and t_isnostro='X') order by decode (t_codekind, 6, 1, 2)",
                               makeArray (sqlParam ("1", int (sql.value ("t_payfiid"))), sqlParam ("2", int (sql.value ("t_corschem")))));
         if ( sql.moveNext () )
            NostroBank = sql.value(0);
         else
            NostroValueDate = NULL;
         end;            

      else
       LEPayerBankCountryCode.RecordCode = "RUS";
      end;

      LEPayerCountryCode.RecordCode = Null /*""*/; //???
      sql = execSqlSelect ( "select t_payername from dpmrmprop_dbt where t_paymentid = :1",
                            makeArray ( sqlParam ( "1", paymentId ) ) );

      if ( sql.moveNext() )
         NameSend = sql.value(0);
      end;

   end;

   InitLegalInfoPayer( partyId, paymentId ) //конструктор

end;


private class TLegalInfoReceiver( rmprop, paymentid, _statPM )
var INN :string,
    KPP :string,
    OKATO :string,
    OKTMO :string,
    BankAccount :string,
    BIC :string,
    CorrAccount :string,
    BankName :string,
    NostroBank :string, /* 20181205 - kva - изменено с Treasury3 */
    NostroValueDate :string, /* 20181205 - kva - изменено с Treasury1 */
    LEPayeeName :string, /* 20181205 - kva - изменено с CorpPayeeName */
    LEPayeeCountryCode :TIntegrationDictionaryRecordX, /* 20181205 - kva - изменено с CountryRec :string */
    LEPayeeBankCountryCode :TIntegrationDictionaryRecordX; /* 20181205 - kva - изменено с BankCountryRec */


   macro InitLegalInfoReceiver( rmprop, paymentid, _statPM )
      var sql,
          CountryCode :string = "",
          FlInternalPm :bool = false;

      if( rmprop.value("t_receiverINN") )
         splitFullInn( rmprop.value("t_receiverINN"), INN, KPP);
         if (Trim(KPP) == "") //DEF-54305
           KPP = "0";
         end;
      else
       INN = "0";
       KPP = "0";
      end;

      OKATO = rmprop.value("t_okatocode"); //???
      OKTMO = ""; //???


      BankName = rmprop.value("t_receiverbankname");


      sql = execSqlSelect ( " select /*REPLACE(A.t_receiveraccount, LPAD('0',20,'0'), ' ')*/ A.t_receiveraccount, A.T_FUTURERECEIVERACCOUNT, A.T_RECEIVERBANKID, A.T_RECEIVER, " +
                            "  NVL( ( SELECT B.T_NRCOUNTRY FROM dparty_dbt B " +
                            "         WHERE B.T_PARTYID = A.T_RECEIVERBANKID ), 'RUS' ) AS COUNTRYCODE, A.t_dockind " +
                            " from dpmpaym_dbt A where A.t_paymentid = :1",
                            makeArray ( sqlParam ( "1", paymentId ) ) );


      if( sql.MoveNext )
        /*maa261218 - не понимаю зачем здесь такое условие. В итоге, при переводе в другой банк мы подтягиваем внутренний счет, а не счет ДрБанка
        if( sql.value(0) != sql.value(1) )
         BankAccount = sql.value(1);
        else
         BankAccount = sql.value(0);
        end;
        */
        
        if ((sql.value("T_DOCKIND") == 102) and (KPP == "0")) //DEF-62459, для платежей МБК не заполняем
           KPP = "";
        end;

      //maa030419 - временно сюда передаем код бисквит Плательщика по просьбе Банка
       OKTMO = GetPartyCode_ByNumber(sql.value("T_RECEIVER"), PARTY_CODEKIND_ABS);


         if( (ValType(sql.value(0)) != 26) and (ValType(sql.value(0)) != V_UNDEF) and
          (sql.value(0) != "") )
          BankAccount = sql.value(0);
         else
//shev 120121
          BankAccount = mkStr("0", 20);
//          BankAccount = " ";
         end;
         CountryCode = sql.value("COUNTRYCODE", Null, V_STRING);

        if(
           ( sql.value("T_RECEIVERBANKID", Null, V_INTEGER) == -1 ) or
           ( sql.value("T_RECEIVERBANKID", Null, V_INTEGER) == 1 ) or
           (
            (int(sql.value(5)) == 140)  //maa170121-цфт_для проводок неттинга получателем всегда является НашБанк
             //and (substr(sql.value(1),1,3) != "301") and (substr(sql.value(1),1,3) != "303") //maa170121 (пока комментарю) - отбрасываем платежи неттинга,чтобы выгружать их как и раньше
            and ( (valtype(_statPM) == v_undef) or (_statPM == false) ) //maa170121 - для проводки по неттингу FlInternalPm всегда true должен быть
           )
          )
         BankName = {Name_Bank};
         BIC = {MFO_Bank};
         FlInternalPm = true;
        else
         FlInternalPm = false;
        end;
      end;

      //maa120419 LEPayeeName = rmprop.value("t_receivername");
//shev 26.09.2019  isup 493272 jira 493272
//      LEPayeeName = GetPartyShortName_integr (sql.value("T_RECEIVER"));
      var PartyName = PartyName, LengthName;

      GetPartyName_integr (sql.value("T_RECEIVER"),PartyName, LengthName);

      if(lengthname > 150)
          LEPayeeName = substr(PartyName,1,145)+"<cut>";
      else
          LEPayeeName = PartyName;
      end;

      sql = execSqlSelect ( "select t_codekind, t_bankcode, t_transferdate, t_corschem, t_payfiid, T_CORRACC from dpmprop_dbt where t_debetcredit=1 and t_paymentid = :1", 
                            makeArray ( sqlParam ( "1", paymentId ) ) );

      if( sql.moveNext() )

         if( not FlInternalPm )
          BIC = sql.value ("t_bankcode");
         end;


         if( ( ValType( sql.value("T_CORRACC") ) != V_UNDEF ) and ( ValType( sql.value("T_CORRACC") ) != 26 ) and
           ( sql.value("T_CORRACC")  != "" ) )

          CorrAccount = sql.value("T_CORRACC");

         elif ((substr(BankAccount,1,2) == "03") and ( ValType( rmprop.value("T_RECEIVERCORRACCNOSTRO") ) != V_UNDEF ) and (rmprop.value("T_RECEIVERCORRACCNOSTRO") != ""))
          CorrAccount = rmprop.value("T_RECEIVERCORRACCNOSTRO"); //DAN BIQ-7624

         else

          CorrAccount = ""; //mkStr("0", 20) /*rmprop.value("T_RECEIVERCORRACCNOSTRO")*/;

         end;

         /* 20181205 - kva - изменение схемы */
/* А.Киселев 01.02.2019 теперь 3 символа-буквы код страны 
         if( int( sql.value("t_codekind") ) == 6 )
            LEPayeeBankCountryCode.RecordCode = substr( sql.value("t_bankcode"), 5, 2);
         else
            LEPayeeBankCountryCode.RecordCode = "RU";
         end;
*/
         LEPayeeBankCountryCode.RecordCode = CountryCode;

         /* 20181205 - kva - изменение схемы */
         NostroValueDate = date(sql.value ("t_transferdate"));

         sql = execSqlSelect ( "select t_code from dpartcode_dbt where t_codekind in (3, 6) and t_partyid = (select t_corrid from dcorschem_dbt where t_fiid=:1 and t_number=:2 and t_isnostro='X') order by decode (t_codekind, 6, 1, 2)",
                               makeArray ( sqlParam ( "1", int ( sql.value ("t_payfiid") ) ), sqlParam( "2", int( sql.value("t_corschem") ) ) ) );
         if( sql.moveNext() )
            NostroBank = sql.value (0);
         else
            NostroValueDate = NULL;
         end;            
      else
       CorrAccount = ""; //mkStr("0", 20) /*rmprop.value("t_receivercorraccnostro")*/;
       LEPayeeBankCountryCode.RecordCode = "RUS";
      end;


      /* 20181205 - kva - изменение схемы */
      LEPayeeCountryCode = TIntegrationDictionaryRecordX();
      LEPayeeCountryCode.RecordCode = Null /*""*/; //???
      //maa120419 LEPayeeName = rmprop.value("t_receivername");

      _statPM = null;
   end;

   InitLegalInfoReceiver( rmprop, paymentid, _statPM ); //конструктор

end;


private class TPersInfoPayer( partyid, paymentId )
var LastName :string,
    FirstName :string,
    MiddleName :string,
    ResidenceAddress :string,
    DocumentNumber :string,
    DocumentIssue :date,
    DocumentIssuer :string,
    INN :string,
    AcctSend :string,
    NostroBank :string, /* 20181205 - kva - изменено с Treasury3 */
    NostroValueDate :string, /* 20181205 - kva - изменено с Treasury1 */
    NameSend :string,
    KindDocumentCode :TIntegrationDictionaryRecordX, /* 20181205 - kva - изменено с DocumentType */
    PersonId :TIntegrationSymbolicIdentifierX,
    PersonPayerCountryCode :TIntegrationDictionaryRecordX, /* 20181205 - kva - изменено с CountryRec */
    PersonPayerBankCountryCode :TIntegrationDictionaryRecordX, /* 20181205 - kva - изменено с BankCountryRec */
    CoupledPerson; //:TCoupledPerson; // gtv: контейнер должен быть = NULL, так как все равно не заполняется


    

   macro InitPersInfoPayer( partyId, paymentId )
      var sql,
          CountryCode :string = "";

      sql = execSqlSelect ( "select (select t_code from dpartcode_dbt where t_codekind="+PTCK_INN+" and t_partyid=dpersn_dbt.t_personid) t_inn, "+
                            "(select t_adress from dadress_dbt where t_type=1 and t_partyid=dpersn_dbt.t_personid) t_adress, "+
                            "dpersn_dbt.* from dpersn_dbt where t_personid=:1",
                            makeArray ( sqlParam ( "1", partyId ) ) );
      if( sql.moveNext() )

         LastName = sql.value("t_name1");
         FirstName = sql.value("t_name2");
         MiddleName = sql.value("t_name3");

         if( valType( sql.value("t_inn") ) != 26 )
            INN = sql.value("t_inn");
         end;

         if( valType( sql.value("t_adress") ) != 26 )
            ResidenceAddress = sql.value ("t_adress");
         end;

      end;

      sql = execSqlSelect ( "select (select t_codedocum from dpaprkind_dbt where t_paperkind = x.t_paperkind) t_kind, x.* from dpersnidc_dbt x where t_isnotvalid = chr (0) and t_personid = :1 order by decode (t_ismain, 'X', 0, 1)",
                            makeArray ( sqlParam ( "1", partyid ) ) );

      if( sql.moveNext() )
         //KindDocumentCode.RecordCode = sql.value("t_kind");
         KindDocumentCode.RecordCode = "Паспорт"; //???
         DocumentNumber = trim( sql.value("t_paperseries") + " " + sql.value("t_papernumber") );
         DocumentIssue = date( sql.value("t_paperissueddate") );
         DocumentIssuer = sql.value("t_paperissuer");
      end;

      PersonId.ObjectId = getExtClientId(partyId);
/*
  sql = execSqlSelect ("select t_payeraccount from dpmpaym_dbt where t_paymentid = :1",
           makeArray (sqlParam ("1", paymentId)));

  if( sql.moveNext () )
   acct_send = sql.value(0);
  end;
*/

      sql = execSqlSelect ( " select C.t_codekind, C.t_bankcode, C.t_transferdate, C.t_corschem, C.t_payfiid, " +
                            "  NVL( ( SELECT B.T_NRCOUNTRY FROM dparty_dbt B " +
                            "         WHERE B.T_PARTYID = A.T_PAYERBANKID ), 'RUS' ) AS COUNTRYCODE " +
                            " from dpmprop_dbt C, dpmpaym_dbt A " +
                            " where C.t_debetcredit=1 " +
                            "  and C.t_paymentid = :1 " +
                            "  AND A.T_PAYMENTID = C.t_paymentid ",
                            makeArray ( sqlParam ("1", paymentId) ) );

      if( sql.moveNext() )

         CountryCode = sql.value("COUNTRYCODE", Null, V_STRING);
/* А.Киселев 01.02.2019 теперь 3 символа-буквы код страны 
         if( int( sql.value("t_codekind") ) == 6 )
            PersonPayerBankCountryCode.RecordCode = substr( sql.value("t_bankcode"), 5, 2);
         else
            PersonPayerBankCountryCode.RecordCode = "RU";
         end;
*/
         PersonPayerBankCountryCode.RecordCode = CountryCode;

         /* 20181205 - kva - изменение схемы */
         NostroValueDate = date( sql.value("t_transferdate") );
         sql = execSqlSelect ( "select t_code from dpartcode_dbt where t_codekind in (3, 6) and t_partyid = (select t_corrid from dcorschem_dbt where t_fiid=:1 and t_number=:2 and t_isnostro='X') order by decode (t_codekind, 6, 1, 2)",
                               makeArray ( sqlParam ( "1", int( sql.value("t_payfiid") ) ),
                                           sqlParam ( "2", int( sql.value("t_corschem") ) ) ) );
         if( sql.moveNext() )
            NostroBank = sql.value(0);
         else
            NostroValueDate = NULL;
         end;            
      else
       PersonPayerBankCountryCode.RecordCode = "RUS";
      end;

      PersonPayerCountryCode.RecordCode = Null /*""*/; //???
      sql = execSqlSelect ( "select t_payername from dpmrmprop_dbt where t_paymentid = :1", 
                            makeArray ( sqlParam ( "1", paymentId ) ) );

      if( sql.moveNext() )
         NameSend = sql.value(0);
      end;

   end;

   InitPersInfoPayer( partyId, paymentId ); //конструктор

end;


private class TPersInfoReceiver( rmprop, paymentid, statPM )
var INN :string,
    KPP :string,
    BankAccount :string,
    BIC :string,
    CorrAccount :string,
    BankName :string,
    NostroBank :string, /* 20181205 - kva - изменено с Treasury3 */
    NostroValueDate :string, /* 20181205 - kva - изменено с Treasury1 */
    PersonPayeeFIO :string, /* 20181205 - kva - изменено с PersPayeeFio */
    PersonPayeeCountryCode :TIntegrationDictionaryRecordX, /* 20181205 - kva - изменено с CountryRec */
    PersonPayeeBankCountryCode :TIntegrationDictionaryRecordX; /* 20181205 - kva - изменено с BankCountryRec */


   macro InitPersInfoReceiver( rmprop, paymentid, _statPM )
      var sql,
          CountryCode :string = "",
          FlInternalPm :bool = false;
      var sqlFIO;
      if( rmprop.value("t_receiverINN") )
         splitFullInn( rmprop.value("t_receiverINN"), INN, KPP);
      end;


      sql = execSqlSelect ( " SELECT A.T_BANKCODE, B.T_FUTURERECEIVERACCOUNT, B.T_RECEIVERBANKID, /*REPLACE(B.t_receiveraccount, LPAD('0',20,'0'), ' ')*/ B.t_receiveraccount, " +
                            "  NVL( ( SELECT C.T_NRCOUNTRY FROM dparty_dbt C " +
                            "         WHERE C.T_PARTYID = B.T_RECEIVERBANKID ), 'RUS' ) AS COUNTRYCODE " +
                            " FROM dpmprop_dbt A, dpmpaym_dbt B " +
                            " WHERE B.T_PAYMENTID = A.T_PAYMENTID " +
                            "  AND A.T_DEBETCREDIT = 1 " +
                            "  AND A.T_PAYMENTID = :1 ",
                makeArray ( sqlParam ("1", paymentId) ) );

      if( sql.MoveNext )
       if( (ValType(sql.value(1, Null, V_STRING)) != 26) and (ValType(sql.value(1, Null, V_STRING)) != V_UNDEF) and
        (sql.value(1, Null, V_STRING) != "")  )
        BankAccount = sql.value(3, Null, V_STRING);     // gtv: заменено на  t_receiveraccount по аналогии с ЮЛ
       else
//shev 120121
        BankAccount = mkStr("0", 20);
//          BankAccount = " ";
       end;
       CountryCode = sql.value("COUNTRYCODE", Null, V_STRING);
      end;
   //maa120419   sql = Null;

      BankName = rmprop.value("t_receiverbankname");

      if( sql.value("T_RECEIVERBANKID", Null, V_INTEGER) == -1 )
       BankName = {Name_Bank};
       BIC = {MFO_Bank};
       FlInternalPm = true;
      else
       FlInternalPm = false;
      end;

   //maa120419   
   sql = Null;

// 2020-07-27 Cherednichenko is513508 Указываем ФИО полностью
//      PersonPayeeFIO = rmprop.value("t_payername");
// DEF-68473 BOSS-1587
      sqlFIO = execSqlSelect ( "select t_receivername from dpmrmprop_dbt p1 where p1.t_paymentid = :1", 
                            makeArray ( sqlParam ( "1", paymentId ) ) );
      if( sqlFIO.moveNext() )
        PersonPayeeFIO = sqlFIO.value("t_receivername");
      end;
      sqlFIO = null;

      sql = execSqlSelect ( "select t_codekind, t_bankcode, t_transferdate, t_corschem, t_payfiid, T_CORRACC from dpmprop_dbt where t_debetcredit=1 and t_paymentid = :1", 
                            makeArray ( sqlParam ( "1", paymentId ) ) );

      if( sql.moveNext() )

         if( not FlInternalPm )
          BIC = sql.value ("t_bankcode");
         end;

         //maa120419 CorrAccount = rmprop.value("T_CORRACC");
         CorrAccount = sql.value("T_CORRACC");

         /* 20181205 - kva - изменение схемы */
/* А.Киселев 01.02.2019 теперь 3 символа-буквы код страны 
         if( int( sql.value ("t_codekind") ) == 6 )
            PersonPayeeBankCountryCode.RecordCode = substr( sql.value("t_bankcode"), 5, 2);
         else
            PersonPayeeBankCountryCode.RecordCode = "RU";
         end;
*/
         //maa120419 PersonPayeeBankCountryCode.RecordCode.RecordCode = CountryCode;
         PersonPayeeBankCountryCode.RecordCode = CountryCode;

         /* 20181205 - kva - изменение схемы */
         NostroValueDate = date( sql.value("t_transferdate") );
         sql = execSqlSelect( "select t_code from dpartcode_dbt where t_codekind in (3, 6) and t_partyid = (select t_corrid from dcorschem_dbt where t_fiid=:1 and t_number=:2 and t_isnostro='X') order by decode (t_codekind, 6, 1, 2)",
                              makeArray ( sqlParam ( "1", int( sql.value("t_payfiid") ) ),
                                          sqlParam ( "2", int( sql.value("t_corschem") ) ) ) );
         if( sql.moveNext() )
            NostroBank = sql.value(0);
         else
            NostroValueDate = NULL;
         end;            

      else
       CorrAccount = ""; //mkStr("0", 20) /*rmprop.value("t_receivercorraccnostro")*/;
       PersonPayeeBankCountryCode.RecordCode.RecordCode = "RUS";
      end;

      /* 20181205 - kva - изменение схемы */
      PersonPayeeCountryCode.RecordCode = Null /*""*/; //???
// 2020-08-03 Cherednichenko PersonPayeeFIO = rmprop.value("t_receivername");

   end;

   InitPersInfoReceiver( rmprop, paymentid, statPM );

end;



private class TLegalInfoPayerTrn( PartyId, EntryId )
var LEPayerName :string, /* 20181205 - kva - изменено с LegalEntityName */
    LEPayerAddress :string, /* 20181205 - kva - новый параметр */
    INN :string,
    KPP :string,
    LEPayerAccount :string, /* 20181205 - kva - изменено с AcctSend */
    NostroBank :string, /* 20181205 - kva - изменено с Treasury3 */
    NostroValueDate :string, /* 20181205 - kva - изменено с Treasury1 */
    NameSend :string,
    LegalEntityId :TIntegrationSymbolicIdentifierX,
    LEPayerCountryCode :TIntegrationDictionaryRecordX, /* 20181205 - kva - изменено с CountryRec */
    LEPayerBankCountryCode :TIntegrationDictionaryRecordX; /* 20181205 - kva - изменено с BankCountryRec */


   macro InitLegalInfoPayer( PartyId, EntryId )
      var sql;

      sql = execSqlSelect ( "select (select t_code from dpartcode_dbt where t_codekind="+PTCK_INN+" and t_partyid=dparty_dbt.t_partyid) t_inn, "+
                            "(select t_adress from dadress_dbt where t_type=1 and t_partyid=dparty_dbt.t_partyid) t_adress, "+
                            "dparty_dbt.* from dparty_dbt where t_partyid=:1",
                            makeArray ( sqlParam ( "1", partyId ) ) );

      if ( sql.moveNext() )

         if ( valType( sql.value("t_inn") ) != 26 )
            splitFullInn( sql.value("t_inn"), INN, KPP);
            if (Trim(KPP) == "") //DEF-54305
              KPP = "0";
            end;
         else
          INN = "0";
          KPP = "0";
         end;

         LEPayerName = sql.value("t_name"); /* 20181205 - kva - изменение */
         NameSend = sql.value("T_NAME");

      end;

      LegalEntityId.ObjectId = getExtClientId(partyId);

      sql = execSqlSelect ( "SELECT T_ACCOUNT_PAYER, T_DATE_CARRY FROM dacctrn_dbt WHERE T_ACCTRNID = :1",
                            makeArray ( sqlParam ( "1", EntryId ) ) );

      if ( sql.moveNext() )
        LEPayerAccount = sql.value(0);
        NostroValueDate = date (sql.value ("T_DATE_CARRY"));
        NostroBank = {MFO_Bank};
      end;

// А.Киселев 01.02.2019 теперь 3 символа-буквы код страны 
//      LEPayerBankCountryCode.RecordCode = substr( {MFO_Bank}, 5, 2 );
      LEPayerBankCountryCode.RecordCode = "RUS";
      LEPayerCountryCode.RecordCode = Null /*""*/; //???

   end;

   InitLegalInfoPayer( PartyId, EntryId ) //конструктор

end;


private class TLegalInfoReceiverTrn( DataSet, EntryId )
var INN :string,
    KPP :string,
    OKATO :string,
    OKTMO :string,
    BankAccount :string,
    BIC :string,
    CorrAccount :string,
    BankName :string,
    NostroBank :string, /* 20181205 - kva - изменено с Treasury3 */
    NostroValueDate :string, /* 20181205 - kva - изменено с Treasury1 */
    LEPayeeName :string, /* 20181205 - kva - изменено с CorpPayeeName */
    LEPayeeCountryCode :TIntegrationDictionaryRecordX, /* 20181205 - kva - изменено с CountryRec :string */
    LEPayeeBankCountryCode :TIntegrationDictionaryRecordX; /* 20181205 - kva - изменено с BankCountryRec */


   macro InitLegalInfoReceiver( DataSet, EntryId )
      var sql;

      if( DataSet.value("T_RECEIVERINN") )
         splitFullInn( DataSet.value("T_RECEIVERINN"), INN, KPP);
         if (Trim(KPP) == "") //DEF-54305
           KPP = "0";
         end;
      else
       INN = "0";
       KPP = "0";
      end;


      if( (ValType(DataSet.value("T_OKATOCODE")) != V_UNDEF ) and (ValType(DataSet.value("T_OKATOCODE")) != 26 ))
       OKATO = DataSet.value("T_OKATOCODE"); //???
      end;

      OKTMO = ""; //???

      if( (ValType(DataSet.value("T_ACCOUNT_RECEIVER")) != 26) and (ValType(DataSet.value("T_ACCOUNT_RECEIVER")) != V_UNDEF) and
       (DataSet.value("T_ACCOUNT_RECEIVER") != "")  )
       BankAccount = DataSet.value("T_ACCOUNT_RECEIVER");
      else
//shev 120121
       BankAccount = mkStr("0", 20);
//          BankAccount = " ";
      end;

      CorrAccount = ""; //mkStr("0", 20) /*DataSet.value("T_RECEIVERCORRACCNOSTRO")*/;
//!!!!!!!!!!!!!!!!!!!
      BankName = {Name_Bank};
      LEPayeeName = DataSet.value("T_RECEIVERNAME");

      BIC = {MFO_Bank};

      /* 20181205 - kva - изменение схемы */
// А.Киселев 01.02.2019 теперь 3 символа-буквы код страны 
//      LEPayeeBankCountryCode.RecordCode = substr( {MFO_Bank}, 5, 2);
      LEPayeeBankCountryCode.RecordCode = "RUS";
      /* 20181205 - kva - изменение схемы */
      NostroValueDate = date(DataSet.value ("T_DATE_CARRY"));

      NostroBank = {MFO_Bank};

      /* 20181205 - kva - изменение схемы */
      LEPayeeCountryCode = TIntegrationDictionaryRecordX();
      LEPayeeCountryCode.RecordCode = Null /*""*/; //???

   end;

   InitLegalInfoReceiver( DataSet, EntryId ); //конструктор

end;


private class TPersInfoPayerTrn( PartyId, EntryId )
var LastName :string,
    FirstName :string,
    MiddleName :string,
    ResidenceAddress :string,
    DocumentNumber :string,
    DocumentIssue :date,
    DocumentIssuer :string,
    INN :string,
    AcctSend :string,
    NostroBank :string, /* 20181205 - kva - изменено с Treasury3 */
    NostroValueDate :string, /* 20181205 - kva - изменено с Treasury1 */
    NameSend :string,
    KindDocumentCode :TIntegrationDictionaryRecordX, /* 20181205 - kva - изменено с DocumentType */
    PersonId :TIntegrationSymbolicIdentifierX,
    PersonPayerCountryCode :TIntegrationDictionaryRecordX, /* 20181205 - kva - изменено с CountryRec */
    PersonPayerBankCountryCode :TIntegrationDictionaryRecordX, /* 20181205 - kva - изменено с BankCountryRec */
    CoupledPerson ; //:TCoupledPerson; // gtv: контейнер должен быть = NULL, так как все равно не заполняется

    

   macro InitPersInfoPayer( PartyId, EntryId )
      var sql;

      sql = execSqlSelect ( "select (select t_code from dpartcode_dbt where t_codekind="+PTCK_INN+" and t_partyid=dpersn_dbt.t_personid) t_inn, "+
                            "(select t_adress from dadress_dbt where t_type=1 and t_partyid=dpersn_dbt.t_personid) t_adress, "+
                            "dpersn_dbt.* from dpersn_dbt where t_personid=:1",
                            makeArray ( sqlParam ( "1", partyId ) ) );
      if( sql.moveNext() )

         LastName = sql.value("t_name1");
         FirstName = sql.value("t_name2");
         MiddleName = sql.value("t_name3");

         if( valType( sql.value("t_inn") ) != 26 )
            INN = sql.value("t_inn");
         end;

         if( valType( sql.value("t_adress") ) != 26 )
            ResidenceAddress = sql.value ("t_adress");
         end;

      end;

      sql = execSqlSelect ( "select (select t_codedocum from dpaprkind_dbt where t_paperkind = x.t_paperkind) t_kind, x.* from dpersnidc_dbt x where t_isnotvalid = chr (0) and t_personid = :1 order by decode (t_ismain, 'X', 0, 1)",
                            makeArray ( sqlParam ( "1", partyid ) ) );

      if( sql.moveNext() )
         KindDocumentCode.RecordCode = sql.value("t_kind");
         DocumentNumber = trim( sql.value("t_paperseries") + " " + sql.value("t_papernumber") );
         DocumentIssue = date( sql.value("t_paperissueddate") );
         DocumentIssuer = sql.value("t_paperissuer");
      end;

      PersonId.ObjectId = getExtClientId(partyId);
      sql = execSqlSelect ( " SELECT T_ACCOUNT_PAYER, T_DATE_CARRY, " +
                            "   ( SELECT T_NAME FROM dparty_dbt " +
                            "     WHERE T_PARTYID = A.T_ACCOUNTID_PAYER ) AS T_PAYERNAME, " +
                            " FROM dacctrn_dbt WHERE T_ACCTRNID = :1",
                            makeArray ( sqlParam ("1", EntryId) ) );



      if( sql.moveNext() )
         PersonPayerBankCountryCode.RecordCode = substr( {MFO_Bank}, 5, 2);

         /* 20181205 - kva - изменение схемы */
         NostroValueDate = date( sql.value("T_DATE_CARRY") );
         NostroBank = {MFO_Bank};
         NameSend = sql.value(2);
      end;

      // А.Киселев 01.02.2019 теперь 3 символа-буквы код страны 
      PersonPayerBankCountryCode.RecordCode = "RUS";
      PersonPayerCountryCode.RecordCode = Null /*""*/; //???

   end;

   InitPersInfoPayer( PartyId, EntryId ); //конструктор

end;


private class TPersInfoReceiverTrn( DataSet, EntryId )
var INN :string,
    BankAccount :string,
    BIC :string,
    CorrAccount :string,
    BankName :string,
    NostroBank :string, /* 20181205 - kva - изменено с Treasury3 */
    NostroValueDate :string, /* 20181205 - kva - изменено с Treasury1 */
    PersonPayeeFIO :string, /* 20181205 - kva - изменено с PersPayeeFio */
    PersonPayeeCountryCode :TIntegrationDictionaryRecordX, /* 20181205 - kva - изменено с CountryRec */
    PersonPayeeBankCountryCode :TIntegrationDictionaryRecordX; /* 20181205 - kva - изменено с BankCountryRec */


   macro InitPersInfoReceiver( DataSet, EntryId )
      var sql,
          KPP;

      if( DataSet.value("T_RECEIVERINN") )
         splitFullInn( DataSet.value("T_RECEIVERINN"), INN, KPP);
         if (Trim(KPP) == "") //DEF-54305
           KPP = "0";
         end;
      else
       INN = "0";
       KPP = "0";
      end;

      if( (ValType(DataSet.value("T_ACCOUNT_RECEIVER")) != 26) and (ValType(DataSet.value("T_ACCOUNT_RECEIVER")) != V_UNDEF) and
       (DataSet.value("T_ACCOUNT_RECEIVER") != "")  )
       BankAccount = DataSet.value("T_ACCOUNT_RECEIVER");
      else
//shev 120121
       BankAccount = mkStr("0", 20);
//          BankAccount = " ";
      end;


      CorrAccount = ""; //mkStr("0", 20) /*DataSet.value("T_RECEIVERCORRACCNOSTRO")*/;
//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
      BankName = {Name_Bank};
      PersonPayeeFIO = DataSet.value("T_RECEIVERNAME");

      BIC = {MFO_Bank};

      /* 20181205 - kva - изменение схемы */
// А.Киселев 01.02.2019 теперь 3 символа-буквы код страны 
//      PersonPayeeBankCountryCode.RecordCode = substr( {MFO_Bank}, 5, 2);
      PersonPayeeBankCountryCode.RecordCode = "RUS";
      /* 20181205 - kva - изменение схемы */
      NostroValueDate = date(DataSet.value ("T_DATE_CARRY"));

      NostroBank = {MFO_Bank};

      /* 20181205 - kva - изменение схемы */
      PersonPayeeCountryCode = TIntegrationDictionaryRecordX();
      PersonPayeeCountryCode.RecordCode = Null /*""*/; //???

   end;

   InitPersInfoReceiver( DataSet, EntryId );

end;



private class TEntry( EntryId_, PaymentId, _operationId ) //класс проводки
var OperationalDay :date,
    PersonnelNumber :string,
    PayTool :string,
    DebitAmount :decimal, /* 20181205 - kva - изменение со string */
    CreditAmount :decimal, /* 20181205 - kva - изменение со string */
    RUBAmount :decimal,
    EntryDetails :string,
    EntryNumber :string,
    ControllerPersonalNumber :string, /* 20181205 - kva - изменение с ControllerPersonnelNumber */
    IsED107 :bool, /* 20181205 - kva - изменение с integer */
    Priority :integer,
    IsUrgent :bool, /* 20181205 - kva - изменение с integer */
    AfterReportingEventsDocuments :string, /* 20181205 - kva - изменение с SPOD */
    MSFOLoanAccount :string,
    ReferenceId :TIntegrationSymbolicIdentifierX,
    BranchId :TIntegrationSymbolicIdentifierX,
    //DebitCurrencyCode :TIntegrationDictionaryRecordX, /* 20181205 - kva - изменение */
    //CreditCurrencyCode :TIntegrationDictionaryRecordX, /* 20181205 - kva - изменение */
    DocumentTypeCode :TIntegrationDictionaryRecordX, /* 20181205 - kva - изменение с EntryType :string */
    EntryId :TIntegrationSymbolicIdentifierX,
    DebitAccount :object/* :string*/, /* 20181205 - kva - изменение */
    CreditAccount :object/* :string*/, /* 20181205 - kva - изменение */
    SuspiciousTransactionTypeCode :TIntegrationDictionaryRecordX, /* 20181205 - kva - изменение с SuspectType :string */
    EntryStatusCode :TIntegrationDictionaryRecordX, /* 20181205 - kva - изменение с EntryStatus :string */
    DFIPayCode :TIntegrationDictionaryRecordX, /* 20181205 - kva - изменение со string */
    LegalEntityPayeeDetails :object, /* 20181205 - kva - изменение с CorpPayeeInfo */
    PersonPayeeDetails :object /*TPersInfoReceiver*/, /* 20181205 - kva - изменение с PersPayeeInfo */
    PersonPayerDetails :object /*TPersInfoPayer*/, /* 20181205 - kva - изменение с PersPayerInfo */
    LegalEntityPayerDetails :object /*TLegalInfoPayer*/, /* 20181205 - kva - изменение с LegalEntityPayerInfo */
    CashSigns :object/*TCashSigns*/,
    ZKHSigns :object /*TZKHSigns*/,
    GMPSigns :object /*TGMPSigns*/,
    TaxSigns :object /*TTaxsSigns*/, /* 20181205 - kva - изменение с TaxsSigns */
    CardSigns :object /*TCardSigns*/,
    ThirdPersonInfo :object /*TThirdPersonInfo*/,
    SWIFTSigns :object /*TSWIFTSigns*/,
    HedgeDetails :object /*THedgeDetails*/;  // BIQ-6900 Хеджирование Гераськина Т.В.

  this.fill( EntryId_, PaymentId, _operationId );


// gtv: вынесено в func_lib и заменено на GetSynthAccByMC_Bisquit
//   private macro GetSynthAccByMC( Account :string ) :string //фунция поиска сводного счета
//   end;

   macro getSuspectType( id )
      var sql;

      if( id )
         sql = execSqlSelect ( "select t_nameobject from dobjattr_dbt where t_objecttype = 700 and t_groupid = 1 and t_attrid = (select t_attrid from dobjatcor_dbt where t_object = lpad (:1, 10, '0') and t_objecttype = 501 and t_groupid = 11 and t_general = 'X' and t_validtodate = to_date ('31129999','ddmmyyyy'))",
         makeArray (sqlParam ("1", id)));

         if( sql.MoveNext() )
            return string(sql.value (0));
         end;

      end;

   end;


   macro defineEDType( paymentId )

      private var sql;

      if( paymentId )

          /*maa0804119 - переписал определение ED107
               /* 20181205 - kva - тип изменился на bool */
               return ifThenElse ( execSqlSelect ( "select 1 from dwlmesrls_dbt where t_rlsformid = (select t_rlsformid from dpmprop_dbt where t_paymentid = :1 and t_debetcredit = 1 and t_tpid = 9) and t_name like '%ED107%'",
                                                   makeArray ( sqlParam ( "1", paymentId ) ) ).MoveNext(), true, false);/*1, 0) );*/ //А.Киселев 14.11.2018
          */

          sql = execSqlSelect ( "select t_nameobject from dobjattr_dbt where t_objecttype = 501 and t_groupid = 101 and t_attrid = (select t_attrid from dobjatcor_dbt where t_object = lpad (:1, 10, '0') and t_objecttype = 501 and t_groupid = 101 and t_general = 'X' and t_validtodate = to_date ('31129999','ddmmyyyy'))",
          makeArray (sqlParam ("1", paymentId)));

          if( sql.MoveNext() )
             if (string(sql.value (0)) == "107" )
                return true;
             end;
          end;

          return false;

      else
         return Null; //А.Киселев 14.11.2018
      end;

   end;
    

   macro defineIsUngent( paymentId )

      if( paymentId )
         /* 20181205 - kva - тип данных изменился на bool */
         //А.Киселев 17.01.2019 теперь так
         return ifThenElse(execSqlSelect( "select 1 from dpmrmprop_dbt where t_paymentid=:1 and T_PAYMENTKIND = 'С' /*t_instancy != 0*/", makeArray( sqlParam("1", paymentId ) ) ).moveNext(), true, false);/*1, 0);*/
      end;

   end;


   macro definePayerInfo( paymentId )
      var sql,sql_d, partyId,count_d;

      if( paymentId )
         sql = execSqlSelect( "select t_payer from dpmpaym_dbt where t_paymentid=:1", makeArray( sqlParam( "1", paymentId ) ) );

         if( sql.moveNext() and ( int( sql.value(0) ) > 0 ) )
            partyId = int( sql.value(0) );
         end;

      end;
//shev 120121 пока по всем списаниям заполняем  LegalEntityPayerDetails
      sql_d = execSqlSelect( "select count(*) from dpmpaym_dbt pm left join dnptxop_dbt d on (pm.t_DocumentID = d.t_ID and pm.t_DocKind = d.t_DocKind) where d.t_subkind_operation = 20 and t_paymentid = :1", makeArray( sqlParam( "1", paymentId ) ) );

      if( sql_d.moveNext() and ( int( sql_d.value(0) ) > 0 ) )
         count_d = int( sql.value(0) );
      end;

      if( partyId )
         sql = execSqlSelect( "select t_legalform from dparty_dbt where t_partyid = :1", makeArray( sqlParam( "1", partyId ) ) );

         if( (sql.moveNext()) and (count_d == 0) )
            if( int( sql.value(0) ) == 1 )
               LegalEntityPayerDetails = TLegalInfoPayer( partyId, paymentId );
            else
               PersonPayerDetails = TPersInfoPayer( partyId, paymentId );
            end;
         else
            LegalEntityPayerDetails = TLegalInfoPayer( partyId, paymentId );
         end;
      end;
   end;


   macro definePayeeInfo( PaymentId )
      var sql;

      if( PaymentId )
         sql = execSqlSelect( "select (select t_receiveraccount from dpmpaym_dbt where t_paymentid=x.t_paymentid) t_recacc, x.* from dpmrmprop_dbt x where t_paymentid=:1", makeArray( sqlParam( "1", paymentId ) ) );

         if( sql.moveNext() )
            if( ( strlen( sql.value("t_receiverinn") ) == 12 ) and (substr( sql.value("t_recacc"), 1, 3 ) != "306") or inList( substr( sql.value("t_recacc"), 1, 3 ), "408" ) )
               PersonPayeeDetails = TPersInfoReceiver(sql, PaymentId);
            else
               LegalEntityPayeeDetails = TLegalInfoReceiver(sql, PaymentId);
            end;
         end;

      end;
   end;


   macro definePayerInfoTrn( EntryId )
      var sql, partyId;

      if( EntryId )
         sql = execSqlSelect( " SELECT T_ACCOUNTID_PAYER, ( SELECT T_LEGALFORM FROM dparty_dbt " +
                              "                             WHERE T_PARTYID = T_ACCOUNTID_PAYER ) AS T_LEGALFORM " +
                              " FROM dacctrn_dbt A " +
                              " WHERE A.T_ACCTRNID = :AcctrnId ", makeArray( sqlParam( "AcctrnId", EntryId ) ) );


         if( sql.moveNext() and ( int( sql.value(0) ) > 0 ) )
            partyId = int( sql.value(0) );

            if( int( sql.value(1, Null, V_INTEGER ) ) == 1 )
               LegalEntityPayerDetails = TLegalInfoPayerTrn( sql.value(0, Null, V_INTEGER), EntryId );
            else
               PersonPayerDetails = TPersInfoPayerTrn( sql.value(0, Null, V_INTEGER), EntryId );
            end;

         end;

      end;

   end;


   macro definePayeeInfoTrn( EntryId )
      var sql;

      if( EntryId )
         sql = execSqlSelect( " SELECT /*REPLACE(T_ACCOUNT_RECEIVER, LPAD('0',20,'0'), ' ')*/ T_ACCOUNT_RECEIVER AS T_ACCOUNT_RECEIVER, T_ACCOUNTID_RECEIVER, " +
                              "  ( SELECT T_LEGALFORM FROM dparty_dbt " +
                              "    WHERE T_PARTYID = A.T_ACCOUNTID_PAYER ) AS T_LEGALFORM, " +
                              "  ( SELECT T_NAME FROM dparty_dbt " +
                              "    WHERE T_PARTYID = A.T_ACCOUNTID_PAYER ) AS T_RECEIVERNAME, " +
                              "  ( SELECT T_CODE FROM dobjcode_dbt " +
                              "    WHERE T_OBJECTTYPE = 3 " +
                              "     AND T_CODEKIND = 16 " +
                              "     AND T_OBJECTID = A.T_ACCOUNTID_RECEIVER " +
                              "     AND T_STATE = 0)  AS T_RECEIVERINN, " +
                              "  ( SELECT T_CODE FROM dobjcode_dbt " +
                              "    WHERE T_OBJECTTYPE = 3 " +
                              "     AND T_CODEKIND = 73 " +
                              "     AND T_OBJECTID = T_ACCOUNTID_RECEIVER " +
                              "     AND T_STATE = 0)  AS T_OKATOCODE, " +
                              "  ( SELECT /*+ index(acc DACCOUNT_DBT_IDX2) result_cache  */ T_ACCOUNT FROM daccount_dbt acc " +
                              "    WHERE T_CLIENT = :BankPartyId " +
                              "     AND T_CODE_CURRENCY = 0 " +
                              "     AND T_CHAPTER = 1 " +
                              "     AND T_BALANCE = '30102' ) AS T_RECEIVERCORRACCNOSTRO, " +
                              "  A.T_DATE_CARRY " +
                              " FROM dacctrn_dbt A " +
                              " WHERE A.T_ACCTRNID = :AcctrnId ", makeArray( sqlParam( "BankPartyId", {OurBank} ),
                                                                             sqlParam( "AcctrnId", EntryId ) ) );

         if( sql.moveNext() )
          if( int( sql.value(2, Null, V_INTEGER ) ) == 1 )
             LegalEntityPayeeDetails = TLegalInfoReceiverTrn(sql, EntryId);
          else
             PersonPayeeDetails = TPersInfoReceiverTrn(sql, EntryId);
          end;
         end;

      end;
   end;

   macro fill( EntryId, PaymentId, _operationId )
      var sql, sql_net,
          isIP = Null;
      var dockind, documentid;
      var WithPayment = false;
      var docTypeCodes = CFTDocumentTypeCodes();
      
      if( ( ValType( PaymentId ) != V_UNDEF ) and ( ValType( PaymentId ) != 26 ) )
         WithPayment = true;
      end;
      
      // 2 селекта объединены в один, так как они не так сильно отличаются
      var sql_str = 
          " select ROUND( A.T_SUM_PAYER, 2 ) AS T_SUM_PAYER, ROUND( A.T_SUM_RECEIVER, 2) AS T_SUM_RECEIVER, " +
          "  A.T_DATE_CARRY, A.T_OPER, A.T_BRANCH, A.T_DEPARTMENT, A.T_ACCOUNT_PAYER, " +
          "  A.T_ACCOUNT_RECEIVER, A.T_NUMB_DOCUMENT, A.T_PRIORITY, A.T_TYPEDOCUMENT, " +
          " ( select  acc.T_USERTYPEACCOUNT from daccount_dbt acc  where  acc.t_accountid = A.T_ACCOUNTID_PAYER ) AS USERTYPEACCOUNT_PAYER,   " +
          " ( select  acc.T_USERTYPEACCOUNT from daccount_dbt acc  where  acc.t_accountid = A.T_ACCOUNTID_RECEIVER ) AS USERTYPEACCOUNT_RECEIVER,  " +
          " (select t_statename from dacctrn_state_dbt where t_state=A.t_state) t_statename, " +
          "  ROUND( A.T_SUM_NATCUR, 2) AS T_SUM_NATCUR, A.T_FIID_PAYER, A.T_FIID_RECEIVER, " +
          "  replace(A.T_GROUND, chr(1), ' ' ) T_GROUND, " +
          "  ( select  p.T_LEGALFORM from daccount_dbt acc, dparty_dbt p where " + 
          "    acc.t_client = p.t_partyid                                       " + 
          "    and  acc.t_accountid = A.T_ACCOUNTID_PAYER ) AS LEGALFORM_PAYER, " + 
          "  ( select  p.T_LEGALFORM from daccount_dbt acc, dparty_dbt p where " + 
          "    acc.t_client = p.t_partyid                                       " + 
          "    and  acc.t_accountid = A.T_ACCOUNTID_RECEIVER ) AS LEGALFORM_RECEIVER, " + 
          "    NVL(( SELECT B.T_NAME FROM dllvalues_dbt B " + 
          "          WHERE B.T_LIST = 5005 " +
          "           AND B.T_ELEMENT = A.T_NUMBER_PACK), '9090909') AS CNTRPERSNUMBER, ";
      if (WithPayment)
         sql_str = sql_str + 
          "    ( SELECT B.T_BISCOTTOID FROM upmbiscotto_dbt B, dpmpaym_dbt C " +
          "      WHERE B.T_PMID = :PaymentId " +
          "       AND C.T_PAYMENTID = B.T_PMID " +
          "       AND  B.T_DOCKIND = C.T_DOCKIND ) AS T_GROUNDCODE, ";
      else 
         sql_str = sql_str + 
          "    ( CASE WHEN INSTR( A.T_USERFIELD1, 'ENCASH' ) = 1 THEN " +
          "        SUBSTR( A.T_USERFIELD1, INSTR( A.T_USERFIELD1, 'ENCASH:' ) + LENGTH('ENCASH:') ) " +
          "      ELSE NULL END  ) AS T_GROUNDCODE, ";
      end;
      
      sql_str = sql_str +
          "    A.T_NUMBER_PACK, " +
          "    NVL( ( SELECT RSB_STRUCT.getString(C.T_TEXT) FROM dnotetext_dbt C " +
          "           WHERE C.T_ID =  " +
          "            ( SELECT MAX(B.T_ID) FROM dnotetext_dbt B " +
          "              WHERE B.T_OBJECTTYPE = 92 " +
          "               AND B.T_NOTEKIND = 200 " +
          "               AND B.T_DOCUMENTID = LPAD( TO_CHAR(A.T_OPER), 10, '0') " +
          "               AND B.T_DATE <= to_date('01.01.9999','dd.mm.yyyy')) ), '9090909') AS T_PERS_NUMBER_BISQUIT " +
//BIQ-7785 Гераськина Т.В. Нужна глава для поиска типа счета
          "  , a.t_chapter " +
//BIQ-10394  CustomTransactionField в userfield1 для хеджирования
          "  , a.t_userfield1 " +
          " from dacctrn_dbt A where t_acctrnid=:acctrnid";

      if( WithPayment )
         sql = execSqlSelect (sql_str, makeArray( sqlParam ("PaymentId", PaymentId),
                                                  sqlParam ("acctrnid", entryId) ) );
      else //для проводок без операции
         sql = execSqlSelect (sql_str, makeArray( sqlParam ("acctrnid", entryId) ) );
      end;

      if( not sql.MoveNext() )
         return;
      end;

      if( not WithPayment)
         ReferenceId.ObjectId = EntryId;
      else
         ReferenceId.ObjectId = "trnpm" + string(EntryId)/*PaymentId*/;
      end;

//shev 310820
var sql_k =" select * from dacctrn_dbt where  :Acctrnid in    "+
"(                                                                               "+
"5252888,5252889,5277050,5277051,5384122,5384123,5412112,5412113,5474692,5474693,"+
"5500786,5500787,5522452,5522453,5689958,5689959,5820140,5820141,5847985,5847986,"+
"5889402,5889403,5889411,5889412,5924345,5924346,5935282,5935283,5936070,5936071,"+
"5937423,5937424,5937617,5937618,5937653,5937654,5951655,5951656,5951830,5951831,"+
"5957109,5957110,6124633,6124634,6136090,6136091,6138964,6138965,6140709,6140710,"+
"6140714,6140715,6194459,6194460,6196189,6196190,6218454,6218455,6225326,6225327,"+
"6226280,6226281,6227662,6227663,6255546,6255547,6257252,6257253,6283117,6283118,"+
"6283122,6283123,6305439,6305440,6306276,6306277,6306287,6306288,6337792,6337793,"+
"6357587,6357588,6371791,6371792,6372419,6372420,6372426,6372427,6399137,6399138,"+
"6426604,6426605,6486143,6486144,6442745,6442746,6445528,6445529,6464998,6464999,"+
"6469041,6469042,6470997,6470998,6471004,6471005,6490315,6490316,6508881,6508882,"+
"6530582,6530583,6550825,6550826,6572634,6572635,6572639,6572640,6589990,6589991,"+
"6590349,6590350,6590794,6590795,6609302,6609303,6613212,6613213,6675054,6675055,"+
"6675063,6675064,6675068,6675069,6709587,6709588,6730520,6730521,6751949,6751950,"+
"6804957,6804958,6805263,6805264,6878924,6878925,6881881,6881882,6963448,6963449,"+
"6963453,6963454,7028277,7028278,7057925,7057926,7098823,7098824,7115008,7115009,"+
"7292885,7292886,7346174,7346175,7373846,7373847,7680529,7680530,7841153,7841154,"+
"7865007,7865008,8025286,8025287,8081411,8081412,8141178,8141179,8170168,8170169,"+
"8420936,8420937,8521552,8521553,8611374,8611375,8611379,8611380,8648831,8648832,"+
"8649652,8649653,8721743,8721744,8748642,8748643,8756503,8756504,9050538,9050539,"+
"9103614,9103615,9129651,9129652,9146162,9146163,9155943,9155944,9194586,9194587,"+
"9221045,9221046,9221058,9221059,9222390,9222391,9241827,9241828,9241851,9241852,"+
"9277657,9277658,9303350,9303351                                                  "+
")                                                                               ";


      var cmd_k = RSDCommand(sql_k);
      cmd_k.AddParam("Acctrnid", RSDBP_IN, Entryid);
      var rs_k = RSDRecordSet(cmd_k);

      if (rs_k.movenext())  
         OperationalDay = date("31.08.2020") ;
      else
         OperationalDay = date( sql.value("t_date_carry") );
      end;
//shev 310820

      //maa PersonnelNumber = getUserCode( int( sql.value("t_oper") ) );
      // gtv: PersonnelNumber = 0, ControllerPersonalNumber - табельный номер автора 
      PersonnelNumber = "0";

      //ControllerPersonalNumber = getUserCode( int( sql.value("t_oper") ) ); А.Киселев 17.01.2019 теперь будет так
      //ControllerPersonalNumber = sql.value("CNTRPERSNUMBER"); А.Киселев 06.05.2019 теперь будет так
      ControllerPersonalNumber = sql.value("T_PERS_NUMBER_BISQUIT");
      if( ControllerPersonalNumber == "9090909" )
         AddLogControllerPersonalNumber( ControllerPersonalNumber, 1, entryId );
         ControllerPersonalNumber = sql.value("CNTRPERSNUMBER");
      end;

/*
      if ( (ValType(ControllerPersonalNumber) == V_UNDEF) )
         ControllerPersonalNumber = "00001363";
      end;
*/
      //maa - BranchId.ObjectId = getFilialId( int( sql.value("t_branch") ) );
      //BranchId.ObjectId = "0000";
      BranchId.ObjectId = getFilialId( int( sql.value("t_department") ) ); //gtv: возвращаемся к схеме с филиалом
      // временно для МФ
//  А.Киселев 06.05.2019 теперь будет так
      if( (BranchId.ObjectId =="6300" ) and (ControllerPersonalNumber == "9090909") )
         ControllerPersonalNumber = "00100900";
      end;


      if ( (ValType(ControllerPersonalNumber) == V_UNDEF) )
         ControllerPersonalNumber = "9090909";
      end;


//shev 23.08.2019
      DocumentTypeCode = TIntegrationDictionaryRecordX();

      var TRN_categ = RsbObjCategories(OBJTYPE_DOCUMENT, string(entryId:o:34)); //Simanov. сделал lpad(xx, 34, 0)
      var trn_groupid = 102;
      record trn_attr("objattr.dbt");
      if(TRN_categ.GetMainAttr(trn_groupid, {curdate}, trn_attr) == 0 )
         DocumentTypeCode.RecordCode = trn_attr.name;
      else
         /* 20181205 - kva - изменение типа данных */
         DocumentTypeCode = TIntegrationDictionaryRecordX();
         if( sql.value("T_NUMBER_PACK", Null, V_INTEGER) == 170 ) //А.Киселев 22.03.2019 костыль для БИС для проводок по инкассовым поручениям
            DocumentTypeCode.RecordCode = "0106";
         elif( ( Index(sql.value("T_ACCOUNT_PAYER", Null, V_STRING), "202" ) == 1 ) and ( Index(sql.value("T_ACCOUNT_RECEIVER", Null, V_STRING), "202" ) != 1 ) ) //А.Киселев 09.04.2019 костыль для БИС приходный ордер
            DocumentTypeCode.RecordCode = "03pv";
         elif( ( Index(sql.value("T_ACCOUNT_PAYER", Null, V_STRING), "202" ) != 1 ) and ( Index(sql.value("T_ACCOUNT_RECEIVER", Null, V_STRING), "202" ) == 1 ) ) //А.Киселев 09.04.2019 костыль для БИС расходный ордер
            DocumentTypeCode.RecordCode = "03rv";
         elif( (( Index(sql.value("T_ACCOUNT_RECEIVER", Null, V_STRING), "30109" ) == 1 ) and ( Index(sql.value("T_ACCOUNT_RECEIVER", Null, V_STRING), "30111" ) == 1 )) or //А.Киселев 09.04.2019 костыль для БИС ЛОРО счета
               (( Index(sql.value("T_ACCOUNT_PAYER", Null, V_STRING), "30601" ) == 1 ) and ( Index(sql.value("T_ACCOUNT_RECEIVER", Null, V_STRING), "40817" ) == 1 ))) 
            DocumentTypeCode.RecordCode = docTypeCodes.BANK_ORDER; /*"06о"*/ //для ЦФТ
         else
            DocumentTypeCode.RecordCode = docTypeCodes.MEMORANDUM_ORDER;//"";//??? /* 20181206 - kva - временно поменял значение */
         end;
      end;

      PayTool = "_"; //???

      /* 20181205 - kva - теперь это объект */
      DebitAccount = TAccountNumberWithCurrency();
      isIP = Null;
      if( ( ( Substr( string( sql.value("t_account_payer")), 1, 3 ) == "306" ) or
            ( Substr( string( sql.value("t_account_payer")), 1, 5 ) == "47423" ) or 
            ((( Substr( string( sql.value("t_account_payer")), 1, 5 ) == "45815" ) or ( Substr( string( sql.value("t_account_payer")), 1, 5 ) == "45817" )) and (index(sql.value("USERTYPEACCOUNT_PAYER"), "!") == 0) ) ) and
          (sql.value("LEGALFORM_PAYER") == 2) ) //проверим на необходимость подстановки сводного счета для физ.лиц
// cherednichenko 2020-08-13 Для ИП сводный счет не подставляем is514440
            isIP = execSqlSelect (" select t_isemployer from dpersn_dbt where t_personid  = " +
                                 " (select t_client from daccount_dbt where 1=1            " +
                                 " and t_account = :1 ) ", makeArray( sqlParam ("1", sql.value("t_account_payer")) ) );
         if ( (isIP.MoveNext()) and (isIP.value(0) != strfor(88)) )
            // BIQ-7785 определяем пользовательский тип счета
            DebitAccount.AccountNumber = GetSynthAccByMC_Bisquit( string( sql.value("t_account_payer")),  // gtv: заменено с GetSynthAccByMC
                                                                  sql.value("t_fiid_payer"), sql.value("t_chapter") ); 
         else
            DebitAccount.AccountNumber = string( sql.value("t_account_payer") );
         end;
      else
         DebitAccount.AccountNumber = string( sql.value("t_account_payer") );
      end;
      /* 20181205 - kva - изменение с DebitCurrencyCode.RecordCode */
      DebitAccount.CurrencyCode = ПолучитьКодФинИн( int( sql.value("t_fiid_payer") ), NULL, 1);

      // gtv: временно   - maa - добавил пока еще серебро, убирать нельзя, бис принимает только такой код
      if (DebitAccount.CurrencyCode == "959")
         DebitAccount.CurrencyCode = "A98";
      elif (DebitAccount.CurrencyCode == "961")
         DebitAccount.CurrencyCode = "A99";
      elif (DebitAccount.CurrencyCode == "962")
         DebitAccount.CurrencyCode = "A76";
      elif (DebitAccount.CurrencyCode == "964")
         DebitAccount.CurrencyCode = "A33";
      end;


      DebitAmount = string ( money( sql.value("t_sum_payer") ) );

      /* 20181205 - kva - теперь это объект */
      CreditAccount = TAccountNumberWithCurrency();
      isIP = Null;
      if( ( ( Substr( string( sql.value("t_account_receiver")), 1, 3 ) == "306" ) or
            ( Substr( string( sql.value("t_account_receiver")), 1, 5 ) == "47423" ) or 
            ((( Substr( string( sql.value("t_account_receiver")), 1, 5 ) == "45815" ) or ( Substr( string( sql.value("t_account_receiver")), 1, 5 ) == "45817" )) and (index(sql.value("USERTYPEACCOUNT_RECEIVER"), "!") == 0)) ) and
          ( sql.value("LEGALFORM_RECEIVER") == 2) ) //проверим на необходимость подстановки сводного счета для физ.лиц

       //А.Киселев 11.01.2021 по аналогии cherednichenko 2020-08-13 Для ИП сводный счет не подставляем is514440
            isIP = execSqlSelect (" select t_isemployer from dpersn_dbt where t_personid  = " +
                                 " (select t_client from daccount_dbt where 1=1            " +
                                 " and t_account = :1 ) ", makeArray( sqlParam ("1", sql.value("t_account_receiver")) ) );
         if ( (isIP.MoveNext()) and (isIP.value(0) != strfor(88)) )
          // BIQ-7785 определяем пользовательский тип счета
            CreditAccount.AccountNumber = GetSynthAccByMC_Bisquit( string( sql.value("t_account_receiver")),  // gtv: заменено с GetSynthAccByMC
                                                                   sql.value("t_fiid_receiver"), sql.value("t_chapter") ); 

         else
            CreditAccount.AccountNumber = string( sql.value("t_account_receiver") );
         end;
       
      else
         CreditAccount.AccountNumber = string( sql.value("t_account_receiver") );
      end;
      /* 20181205 - kva - изменение с CreditCurrencyCode.RecordCode */


      CreditAccount.CurrencyCode = ПолучитьКодФинИн( int( sql.value("t_fiid_receiver") ), NULL, 1);

      // gtv: временно - maa - добавил пока еще серебро, убирать нельзя, бис принимает только такой код
      if (CreditAccount.CurrencyCode == "959")
         CreditAccount.CurrencyCode = "A98";
      elif (CreditAccount.CurrencyCode == "961")
         CreditAccount.CurrencyCode = "A99";
      elif (CreditAccount.CurrencyCode == "962")
         CreditAccount.CurrencyCode = "A76";
      elif (CreditAccount.CurrencyCode == "964")
         CreditAccount.CurrencyCode = "A33";
      end;

      CreditAmount = string( money( sql.value("t_sum_receiver") ) );

      //maa if( ( sql.value("T_FIID_PAYER") != 0 ) or ( sql.value("T_FIID_RECEIVER") != 0 ) )
      RUBAmount = string( money( sql.value("T_SUM_NATCUR") ) );
      //end;

      EntryDetails = string( sql.value("t_ground") );
      if( (not WithPayment) and
        (( Valtype( sql.value("T_GROUNDCODE") ) == V_UNDEF ) or ( Valtype( sql.value("T_GROUNDCODE") ) == 26 )) )
         EntryNumber = string( sql.value("t_numb_document") );
      elif( ( Valtype( sql.value("T_GROUNDCODE") ) != V_UNDEF ) and ( Valtype( sql.value("T_GROUNDCODE") ) != 26 ) and
        ( sql.value("T_GROUNDCODE")  != "" )  )
         EntryNumber = sql.value("T_GROUNDCODE");
      else
         EntryNumber = string( sql.value("t_numb_document") );
      end;

      /* 20181205 - kva - изменение типа данных */
      SuspiciousTransactionTypeCode = TIntegrationDictionaryRecordX();
      SuspiciousTransactionTypeCode.RecordCode = getSuspectType( PaymentId );

      /* 20181205 - kva - изменение типа данных */
      EntryStatusCode = TIntegrationDictionaryRecordX();
      /* 20181220 - kva - Изменения в логике заполнения параметра */

/* 2021-04-06 Cherednichenko Возвращаем ПРОВЕД после перехода на ЦФТ. Для всех проводок
      if((substr(DebitAccount.AccountNumber, 1, 1) == "2") or (substr(CreditAccount.AccountNumber, 1, 1) == "2"))
         EntryStatusCode.RecordCode = "ОТПРАВЛЕН"; // 20181227 - маа - банк попросил отправлять статус ОТПРАВЛЕН
//         EntryStatusCode.RecordCode = "ПРОВЕД";
//shev 20052020 isup 510091 для проводок возврата овердрафта нужно возвращать провед
      elif((substr(DebitAccount.AccountNumber, 1, 5) == "30601") or (substr(CreditAccount.AccountNumber, 1, 5) == "47423"))
         EntryStatusCode.RecordCode = "ПРОВЕД";
      else
         EntryStatusCode.RecordCode = "ОТПРАВЛЕН"; // 20181227 - маа - банк попросил отправлять статус ОТПРАВЛЕН
//         EntryStatusCode.RecordCode = "ПРОВЕД";
      end;
*/
      EntryStatusCode.RecordCode = "ПРОВЕД";

      isEd107 = defineEDType( PaymentId );
      Priority = int( sql.value("t_priority") );
      IsUrgent = /*int (*/ defineIsUngent( paymentId )/*)*/; //А.Киселев 14.11.2018

      // СПОД
      if ( Index(sql.value("t_typedocument"),"З") > 0 )
         AfterReportingEventsDocuments = "Y";
      else
         AfterReportingEventsDocuments = NULL;
      end;

      this.EntryId.ObjectId = Null /*""*/;

      if( Valtype( PaymentId ) != V_UNDEF )
         definePayerInfo( PaymentId );
         definePayeeInfo( PaymentId );
      else
//       definePayerInfoTrn( EntryId );
//       definePayeeInfoTrn( EntryId );
      end;

      if( paymentId )
         ThirdPersonInfo = TThirdPersonInfo( PaymentId );
      end;

      if( paymentId )

         sql_net = null;
         sql_net = execSqlSelect( "select t_dockind from dpmpaym_dbt where t_paymentid=:1",
                 makeArray( sqlParam( "1", paymentId ) ) );
         if( sql_net.moveNext() )
            if( int(sql_net.value(0)) != 140 );  //maa170121- цфт_добавил поиск dockind и данную обертку, чтобы не формировать SWIFTSigns для проводок неттинга

               SWIFTSigns = TSWIFTSigns( PaymentId );

               //Проверки для DocumentCode A.Киселев 17.01.2019 теперь так
               if( ( ValType(SWIFTSigns) != V_UNDEF ) and ( ValType(SWIFTSigns.SWIFTMessage) != V_UNDEF) )
               
                 if( ((Substr( CreditAccount, 1, 5 ) == "30110") or (Substr( CreditAccount, 1, 5 ) == "30114")) and
                   ( sql.value("T_FIID_RECEIVER") == 0 ) )
                  DocumentTypeCode.RecordCode = docTypeCodes.PAYMENT_ORDER;
                 elif( sql.value("T_FIID_RECEIVER") != 0 )
                  DocumentTypeCode.RecordCode = docTypeCodes.MEMORANDUM_ORDER;
                 end;
               end;
            end;
         end;

         // А.Киселев 28.12.2020 для Кредит 30109/30111 SWIFT на хвост не цепляем
         if( ( ValType(SWIFTSigns) != V_UNDEF ) and
             ( ( Index(sql.value("T_ACCOUNT_RECEIVER", Null, V_STRING), "30109" ) == 1 ) or
               ( Index(sql.value("T_ACCOUNT_RECEIVER", Null, V_STRING), "30111" ) == 1 ) ) )

           SWIFTSigns = Null;

         end;

      end;

      if ( ((DocumentTypeCode.RecordCode == docTypeCodes.BANK_ORDER) or (DocumentTypeCode.RecordCode == docTypeCodes.PAYMENT_ORDER)) and (sql.value("T_NUMBER_PACK", Null, V_INTEGER) != 170) )
         EntryNumber = CutNum(EntryNumber, 6);
      end;

      // BIQ-6900 Хеджирование Гераськина Т.В.
      if (ValType( _operationId ) != V_UNDEF) 
         var sql_o = execSqlSelect ("select t_dockind, t_documentid from doproper_dbt where t_id_operation = :1", 
                                        makeArray( sqlParam ("1", _operationId) ) );
         if (sql_o.movenext)
            dockind = int( sql_o.value("t_dockind") );
            documentid = int( sql_o.value("t_documentid") );

            HedgeDetails = THedgeDetails(dockind, documentid, sql.value("t_userfield1"));
            if (ValType(HedgeDetails.SubPortfolio) == V_UNDEF)
               HedgeDetails = null;
            end;
         end;
      end;

   end;


end;



private class TEntryPm( PaymentId , statPM ) //класс для платежа
var OperationalDay :date,
    PersonnelNumber :string,
    PayTool :string,
    DebitAmount :decimal, /* 20181205 - kva - изменение со string */
    CreditAmount :decimal, /* 20181205 - kva - изменение со string */
    RUBAmount :decimal,
    EntryDetails :string,
    EntryNumber :string,
    ControllerPersonalNumber :string, /* 20181205 - kva - изменение с ControllerPersonnelNumber */
    IsED107 :bool, /* 20181205 - kva - изменение с integer */
    Priority :integer,
    IsUrgent :bool, /* 20181205 - kva - изменение с integer */
    AfterReportingEventsDocuments :string, /* 20181205 - kva - изменение с SPOD */
    MSFOLoanAccount :string,
    ReferenceId :TIntegrationSymbolicIdentifierX,
    BranchId :TIntegrationSymbolicIdentifierX,
    //DebitCurrencyCode :TIntegrationDictionaryRecordX, /* 20181205 - kva - изменение */
    //CreditCurrencyCode :TIntegrationDictionaryRecordX, /* 20181205 - kva - изменение */
    DocumentTypeCode :TIntegrationDictionaryRecordX, /* 20181205 - kva - изменение с EntryType :string */
    EntryId :TIntegrationSymbolicIdentifierX,
    DebitAccount :object/* :string*/, /* 20181205 - kva - изменение */
    CreditAccount :object/* :string*/, /* 20181205 - kva - изменение */
    SuspiciousTransactionTypeCode :TIntegrationDictionaryRecordX, /* 20181205 - kva - изменение с SuspectType :string */
    EntryStatusCode :TIntegrationDictionaryRecordX, /* 20181205 - kva - изменение с EntryStatus :string */
    DFIPayCode :TIntegrationDictionaryRecordX, /* 20181205 - kva - изменение со string */
    LegalEntityPayeeDetails :object, /* 20181205 - kva - изменение с CorpPayeeInfo */
    PersonPayeeDetails :object /*TPersInfoReceiver*/, /* 20181205 - kva - изменение с PersPayeeInfo */
    PersonPayerDetails :object /*TPersInfoPayer*/, /* 20181205 - kva - изменение с PersPayerInfo */
    LegalEntityPayerDetails :object /*TLegalInfoPayer*/, /* 20181205 - kva - изменение с LegalEntityPayerInfo */
    CashSigns :object/*TCashSigns*/,
    ZKHSigns :object /*TZKHSigns*/,
    GMPSigns :TGMPSigns /*TGMPSigns*/ , /*20191113 - Simanov - изменение с object*/
// shev 20191016    TaxSigns :object /*TTaxsSigns*/, /* 20181205 - kva - изменение с TaxsSigns */
    TaxSigns :TTaxsSigns, 
    CardSigns :object /*TCardSigns*/,
    ThirdPersonInfo :object /*TThirdPersonInfo*/,
    SWIFTSigns :object /*TSWIFTSigns*/;


  this.fill( PaymentId, statPM );




   macro getSuspectType( id )
      var sql;

      if( id )
         sql = execSqlSelect ( "select t_nameobject from dobjattr_dbt where t_objecttype = 700 and t_groupid = 1 and t_attrid = (select t_attrid from dobjatcor_dbt where t_object = lpad (:1, 10, '0') and t_objecttype = 501 and t_groupid = 11 and t_general = 'X' and t_validtodate = to_date ('31129999','ddmmyyyy'))",
                               makeArray ( sqlParam ( "1", id ) ) );

         if( sql.MoveNext() )
            return string(sql.value (0));
         end;

      end;

   end;


   macro defineEDType( paymentId )

      private var sql;

      if( paymentId )
          /*maa0804119 - переписал определение ED107
               /* 20181205 - kva - тип изменился на bool */
               return ifThenElse ( execSqlSelect ( "select 1 from dwlmesrls_dbt where t_rlsformid = (select t_rlsformid from dpmprop_dbt where t_paymentid = :1 and t_debetcredit = 1 and t_tpid = 9) and t_name like '%ED107%'",
                                                   makeArray ( sqlParam ( "1", paymentId ) ) ).MoveNext(), true, false);/*1, 0) );*/ //А.Киселев 14.11.2018
          */
          sql = execSqlSelect ( "select t_nameobject from dobjattr_dbt where t_objecttype = 501 and t_groupid = 101 and t_attrid = (select t_attrid from dobjatcor_dbt where t_object = lpad (:1, 10, '0') and t_objecttype = 501 and t_groupid = 101 and t_general = 'X' and t_validtodate = to_date ('31129999','ddmmyyyy'))",
          makeArray (sqlParam ("1", paymentId)));

          if( sql.MoveNext() )
             if (string(sql.value (0)) == "107" )
                return true;
             end;
          end;

          return false;

      else
         return Null; //А.Киселев 14.11.2018
      end;

   end;
    

   macro defineIsUngent( paymentId )

      if( paymentId )
         /* 20181205 - kva - тип данных изменился на bool */
         //А.Киселев 17.01.2019 теперь так
         return ifThenElse(execSqlSelect( "select 1 from dpmrmprop_dbt where t_paymentid=:1 and T_PAYMENTKIND = 'С' /*t_instancy != 0*/", makeArray( sqlParam("1", paymentId ) ) ).moveNext(), true, false);/*1, 0);*/
      end;

   end;




   macro definePayerInfo( paymentId )
      var sql,sql_d, partyId, count_d;

      if( paymentId )
         sql = execSqlSelect( "select t_payer from dpmpaym_dbt where t_paymentid=:1", makeArray( sqlParam( "1", paymentId ) ) );

         if( sql.moveNext() and ( int( sql.value(0) ) > 0 ) )
            partyId = int( sql.value(0) );
         end;

      end;
//shev 120121 пока по всем списаниям заполняем  LegalEntityPayerDetails
      sql_d = execSqlSelect( "select count(*) from dpmpaym_dbt pm left join dnptxop_dbt d on (pm.t_DocumentID = d.t_ID and pm.t_DocKind = d.t_DocKind) where d.t_subkind_operation = 20 and t_paymentid = :1", makeArray( sqlParam( "1", paymentId ) ) );

      if( sql_d.moveNext() and ( int( sql_d.value(0) ) > 0 ) )
         count_d = int( sql.value(0) );
      end;

      if( partyId )
         sql = execSqlSelect( "select t_legalform from dparty_dbt where t_partyid = :1", makeArray( sqlParam( "1", partyId ) ) );

         if( (sql.moveNext()) and (count_d == 0) )
            if( int( sql.value(0) ) == 1 )
               LegalEntityPayerDetails = TLegalInfoPayer( partyId, paymentId );
            else
               PersonPayerDetails = TPersInfoPayer( partyId, paymentId );
            end;
         else
            LegalEntityPayerDetails = TLegalInfoPayer( partyId, paymentId );
         end;
      end;
   end;


   macro definePayeeInfo( PaymentId, _statPM )
      var sql;

      if( PaymentId )
         sql = execSqlSelect( "select (select t_receiveraccount from dpmpaym_dbt where t_paymentid=x.t_paymentid) t_recacc, x.* from dpmrmprop_dbt x where t_paymentid=:1", makeArray( sqlParam( "1", paymentId ) ) );

         if( sql.moveNext() )
            if( ( strlen( sql.value("t_receiverinn") ) == 12 ) or inList( substr( sql.value("t_recacc"), 1, 3 ), "408" ) )
               PersonPayeeDetails = TPersInfoReceiver(sql, PaymentId, _statPM);
            else
               LegalEntityPayeeDetails = TLegalInfoReceiver(sql, PaymentId, _statPM);
            end;
         end;

      end;
   end;

   // BOSS-6391_BOSS-6767 Возвращает true, если платеж является платежом по выводу ДС на лечение по ИИС-3
   private macro IsPayMedical (paymentid)
     var cmd, rs;
     cmd = RsdCommand(
             "select 1 AS n, n.t_id from dnptxop_dbt n, dpmpaym_dbt pm "
             + " where n.t_dockind = pm.t_dockind and n.t_id = pm.t_documentid "
             + " and pm.t_paymentid = " + string(paymentid) + " and n.t_paymedical = 'X' " 
     );
     cmd.Execute();
     rs = TRsbDataSet(cmd);
     return rs.MoveNext();
   onerror()
     return false;
   End; // IsPayMedical

   // BOSS-7147 Возвращает цель списания для платежа
   private macro GetPayGoal (paymentid)
     var cmd, rs, x_PayGoal = 0;
     cmd = RsdCommand(
             "select n.t_paypurpose from dnptxop_dbt n, dpmpaym_dbt pm "
             + " where n.t_dockind = pm.t_dockind and n.t_id = pm.t_documentid "
             + " and pm.t_paymentid = " + string(paymentid)
     );
     cmd.Execute();
     rs = TRsbDataSet(cmd);
     if (rs.movenext)
         x_PayGoal = rs.value("t_paypurpose");
     end;
     return x_PayGoal;
   End; // GetPayGoal

   // BOSS-7143 Возвращает true, если для платежа нужно использовать синтетический счет
   private macro IsSynAcc (paymentid)
     var x_PayGoal;
     if(IsPayMedical (paymentid) == true)
       return true;
     else
       x_PayGoal = GetPayGoal(paymentid);
       if(x_PayGoal == 3) // вывод наследнику
         return true;
       end;
     end;
     return false;
   End; // IsSynAcc

   macro fill( PaymentId, statPM )
      var sql, sql2;
      var sql_pack;
      var ourbank_flag = false;
      var acctrn = null;
      var docTypeCodes = CFTDocumentTypeCodes();
      record pm_attr("objattr.dbt");


      sql = execSqlSelect(" SELECT A.T_VALUEDATE, A.T_OPER, A.T_STARTDEPARTMENT, A.T_PAYERACCOUNT, ROUND( A.T_AMOUNT, 2) AS T_AMOUNT, A.T_FIID, A.T_RECEIVERACCOUNT, " +
                          "  A.T_FUTURERECEIVERACCOUNT, A.T_FUTUREPAYERACCOUNT, ROUND( A.T_PAYAMOUNT, 2 ) AS T_PAYAMOUNT, A.T_PAYFIID, replace(B.T_GROUND, chr(1), ' ' ) T_GROUND, B.T_NUMBER, B.T_PRIORITY, " +
                          "  NVL( ( SELECT ROUND( C.T_SUM_NATCUR, 2 ) FROM dacctrn_dbt C, dpmdocs_dbt D " +
                          "         WHERE C.T_ACCTRNID = D.T_ACCTRNID " +
                          "          AND D.T_PAYMENTID = A.T_PAYMENTID " +
                          "          AND ROWNUM = 1 ), 0.00 ) AS T_SUM_NATCUR, " +

                          "  NVL( ( SELECT B.T_NAME FROM dacctrn_dbt C, dpmdocs_dbt D, dllvalues_dbt B " +
                          "         WHERE C.T_ACCTRNID = D.T_ACCTRNID " +
                          "          AND D.T_PAYMENTID = A.T_PAYMENTID " +
                          "          AND B.T_LIST = 5005 " +  //!!!!!Id справочника из реестра
                          "          AND B.T_ELEMENT = C.T_NUMBER_PACK " +
                          "          AND ROWNUM = 1 ), '9090909' ) AS CNTRPERSNUMBER, " +
                          "  A.T_PAYFIID AS T_FIID_RECEIVER, " +
                          "  NVL( ( SELECT RSB_STRUCT.getString(C.T_TEXT) FROM dnotetext_dbt C " +
                          "         WHERE C.T_ID =  " +
                          "          ( SELECT MAX(B.T_ID) FROM dnotetext_dbt B " +
                          "            WHERE B.T_OBJECTTYPE = 92 " +
                          "             AND B.T_NOTEKIND = 200 " +
                          "             AND B.T_DOCUMENTID = LPAD( TO_CHAR(A.T_OPER), 10, '0') " +
//shev 230519                          "             AND B.T_DATE <= RSBSESSIONDATA.CURDATE ) ), '9090909') AS T_PERS_NUMBER_BISQUIT " +
                          "               AND B.T_DATE <= to_date('01.01.9999','dd.mm.yyyy')) ), '9090909') AS T_PERS_NUMBER_BISQUIT, " +
                          "   B.t_BttTiCode, B.t_taxPmPeriod, B.t_TaxPmNumber, B.t_TaxPmDate, B.T_TAXAUTHORSTATE, B.t_taxPmGround, a.t_purpose" + //shev 20191016
// BIQ-7785 Гераськина Т.В. определяем тип счета
                          " , a.t_chapter " +
//DEF-22944 Гераськина Т.В. для dockind = 5002 и purpose = 100 по дебету уже сводный
                          " , a.t_dockind " +
                          " FROM dpmpaym_dbt A, dpmrmprop_dbt B " +
                          " WHERE A.T_PAYMENTID = :PaymentId " +
                          "  AND  B.T_PAYMENTID = A.T_PAYMENTID ", 
                          makeArray (sqlParam ("1", PaymentId)));

      if( not sql.MoveNext() )
         return;
      end;                   

      ReferenceId.ObjectId = "paym" + string(PaymentId);
      OperationalDay = date( sql.value("T_VALUEDATE") );
      //maa PersonnelNumber = getUserCode( int( sql.value("T_OPER") ) );
      // gtv: PersonnelNumber = 0, ControllerPersonalNumber - табельный номер автора 
      PersonnelNumber = "0";

      //ControllerPersonalNumber = getUserCode( int( sql.value("t_oper") ) ); А.Киселев 17.01.2019 теперь будет так
      //ControllerPersonalNumber = sql.value("CNTRPERSNUMBER"); А.Киселев 06.05.2019 теперь будет так
      ControllerPersonalNumber = sql.value("T_PERS_NUMBER_BISQUIT");
      if( ControllerPersonalNumber == "9090909" )
         AddLogControllerPersonalNumber( ControllerPersonalNumber, -1, PaymentId );
         ControllerPersonalNumber = sql.value("CNTRPERSNUMBER");
      end;

/*
      if ( (ValType(ControllerPersonalNumber) == V_UNDEF) )
         ControllerPersonalNumber = "00001363";
      end;
*/

      // gtv: если по проводке не нашли пачку, проверим в самом платеже
      if (ControllerPersonalNumber == "9090909")
         sql_pack = execSqlSelect (" SELECT ll.T_NAME FROM dllvalues_dbt  ll " + //!!!!!Id справочника из реестра
                                   " , dpmpaym_dbt p " +
                                   "  WHERE ll.T_LIST = 5005 " +
                                   "    AND ll.T_ELEMENT = p.T_NUMBERPACK " +
                                   "    AND p.t_paymentid =:1", makeArray (sqlParam ("1", PaymentId)));
         if (sql_pack.movenext)
            ControllerPersonalNumber = sql_pack.value("T_NAME");  // если найден, заполняем
         end;
      end;

      //maa BranchId.ObjectId = getFilialId( int( sql.value("T_STARTDEPARTMENT") ) );
      BranchId.ObjectId = "0000";
      BranchId.ObjectId = getFilialId( int( sql.value("T_STARTDEPARTMENT") ) ); //gtv: возвращаемся к схеме с филиалом
      // временно для МФ
//А.Киселев 06.05.2019 теперь будет так
      if( (BranchId.ObjectId =="6300")  and (ControllerPersonalNumber == "9090909") )
         ControllerPersonalNumber = "00100900";
      end;

      PayTool = "_"; //???

      /* 20181205 - kva - теперь это объект */
      DebitAccount = TAccountNumberWithCurrency();
     
      DebitAccount.AccountNumber = string( sql.value("T_PAYERACCOUNT") );

      /* 20181205 - kva - изменение с DebitCurrencyCode.RecordCode */
      DebitAccount.CurrencyCode = ПолучитьКодФинИн( int( sql.value("T_FIID") ), NULL, 1);

      /* 20181205 - kva - теперь это объект */
      CreditAccount = TAccountNumberWithCurrency();
      if(      (sql.value("T_RECEIVERACCOUNT") != sql.value("T_FUTURERECEIVERACCOUNT")) 
	       and (sql.value("T_FUTURERECEIVERACCOUNT") != null) 
	       and (sql.value("T_FUTURERECEIVERACCOUNT") != strfor(0) ) 
		)
         CreditAccount.AccountNumber = sql.value("T_FUTURERECEIVERACCOUNT");
      else
         CreditAccount.AccountNumber = sql.value("T_RECEIVERACCOUNT");
      end;
      
      // 20190919 gtv: для 306/47423 заменяем на сводные
      if ( ( Substr( CreditAccount.AccountNumber, 1, 3 ) == "306" ) or
            ( Substr( CreditAccount.AccountNumber, 1, 5 ) == "47423" ) ) 
         CreditAccount.AccountNumber = GetSynthAccByMC_Bisquit( CreditAccount.AccountNumber, sql.value("T_PAYFIID"), sql.value("t_chapter")); 
      else
         CreditAccount.AccountNumber = CreditAccount.AccountNumber;
      end;



      /* 20181205 - kva - изменение с CreditCurrencyCode.RecordCode */
      CreditAccount.CurrencyCode = ПолучитьКодФинИн( int( sql.value("T_PAYFIID") ), NULL, 1);

      if ((sql.value("t_dockind") == 102) and (sql.value("t_purpose") == 11))
         // Врубель В. DEF-35592 - в платежах по процентам МБК не учитывать налог
         acctrn = execSqlSelect (" select nvl(sum(a.t_sum_payer), :1) as t_sum_payer, nvl(sum(a.t_sum_receiver), :2) as t_sum_receiver from dacctrn_dbt a " +
                        " where a.t_account_payer = :3 and a.t_date_carry = :4 and a.t_account_receiver = :5", 
                                 makeArray( 
                                    sqlParam ("1", sql.value("t_amount")),
                                    sqlParam ("2", sql.value("t_payamount")),
                                    sqlParam ("3", sql.value("t_futurepayeraccount")),
                                    sqlParam ("4", sql.value("t_valuedate")),
                                    sqlParam ("5", sql.value("t_futurereceiveraccount")) ) );
         if (acctrn.MoveNext())
            DebitAmount  = string( money( acctrn.value("t_sum_payer") ) );
            CreditAmount = string( money( acctrn.value("t_sum_receiver") ) );
         else
            DebitAmount = string(money( sql.value("T_AMOUNT") ));
            CreditAmount = string(money( sql.value("T_PAYAMOUNT") ));
         end;
      else
         DebitAmount = string(money( sql.value("T_AMOUNT") ));
         CreditAmount = string(money( sql.value("T_PAYAMOUNT") ));
      end;

      //maa if( (sql.value("T_FIID") != 0) or (sql.value("T_PAYFIID") != 0) )
      RUBAmount = string( money( sql.value("T_SUM_NATCUR") ) );
      //end;

      EntryDetails = string( sql.value("T_GROUND") );
      EntryNumber = string( sql.value("T_NUMBER") );

      /* 20181205 - kva - изменение типа данных */
      SuspiciousTransactionTypeCode = TIntegrationDictionaryRecordX();
      SuspiciousTransactionTypeCode.RecordCode = getSuspectType( PaymentId );

      /* 20181205 - kva - изменение типа данных */
      EntryStatusCode = TIntegrationDictionaryRecordX();
      /* 20181220 - kva - Изменения в логике заполнения параметра */
      if((substr(DebitAccount.AccountNumber, 1, 1) == "2") or (substr(CreditAccount.AccountNumber, 1, 1) == "2"))
         EntryStatusCode.RecordCode = "ОТПРАВЛЕН";
      else
//         EntryStatusCode.RecordCode = "ПРОВЕД"; /* 20181227 - kva - для платежей используем всегда "ОТПРАВЛЕН" */
         EntryStatusCode.RecordCode = "ОТПРАВЛЕН";
      end;

      isEd107 = defineEDType( PaymentId );
      Priority = int( sql.value("T_PRIORITY") );
      IsUrgent = /*int (*/ defineIsUngent( PaymentId )/*)*/; //А.Киселев 14.11.2018
      this.EntryId.ObjectId = Null /*""*/;

      definePayerInfo(PaymentId);

      if ( Substr( DebitAccount.AccountNumber, 1, 5 ) == "47423" )  
         DebitAccount.AccountNumber = GetSynthAccByMC_Bisquit( DebitAccount.AccountNumber, sql.value("T_FIID"), sql.value("t_chapter") ); 
      else
         DebitAccount.AccountNumber = DebitAccount.AccountNumber;
      end;

      var legalformYur = false;
      sql2 = execSqlSelect( "select t_legalform from dparty_dbt where t_partyid in (select t_receiver from dpmpaym_dbt where t_paymentid = :1 )", makeArray( sqlParam( "1", paymentId ) ) );
      if( sql2.moveNext() and ( int( sql2.value(0) ) == 1 ) )
        legalformYur = true;
      end;

      if(( Substr( DebitAccount.AccountNumber, 1, 3 ) == "306" ) and (LegalformYur == false))
//DEF-22944 Гераськина Т.В. для dockind = 5002 и purpose = 100 по дебету уже сводный 
//DEF-23952 Cherednichenko 2022-04-28   ...и для dockind = 4607
         if ((sql.value("t_purpose") == 100) and ((sql.value("t_dockind") == 5002) or (sql.value("t_dockind") == 4607)))
         else 
            DebitAccount.AccountNumber = GetSynthAccByMC_Bisquit( DebitAccount.AccountNumber, sql.value("T_FIID"), sql.value("t_chapter")); 
         end;
      elif((Substr( DebitAccount.AccountNumber, 1, 3 ) == "306" ) and (IsSynAcc (paymentid) == true))
         // DEF-74997, BOSS-6391_BOSS-6767 Вывод на лечение для ИИС-3
         DebitAccount.AccountNumber = GetSynthAccByMC_Bisquit( DebitAccount.AccountNumber, sql.value("T_FIID"), sql.value("t_chapter")); 
      else
         DebitAccount.AccountNumber = DebitAccount.AccountNumber;
      end;

      definePayeeInfo(PaymentId, statPM);

      if( paymentId )
         ThirdPersonInfo = TThirdPersonInfo( PaymentId );
      end;

//shev 20191016 для налоговых платежей

      if( paymentId and (sql.value("t_purpose") == 38 ) )
         //TaxSigns.PurposeCode = TIntegrationDictionaryRecordX();
         //TaxSigns.StatusCode = TIntegrationDictionaryRecordX();
 
         TaxSigns.KBK          = sql.value("t_BttTiCode");
         TaxSigns.TaxPeriod    = sql.value("t_taxPmPeriod");
         TaxSigns.TaxDocNumber = sql.value("t_TaxPmNumber");
         TaxSigns.TaxDocDate   = sql.value("t_TaxPmDate");
         TaxSigns.StatusCode.RecordCode  = sql.value("T_TaxAuthorState");
         TaxSigns.PurposeCode.RecordCode = sql.value("t_taxPmGround");
 
         //Simanov. выгрузка УИН
         GMPSigns.BillId = "0";
      end;

      if( paymentId )
         SWIFTSigns = TSWIFTSigns( PaymentId );

         if( ValType(SWIFTSigns) != V_UNDEF )
         
            if(SWIFTSigns.MessageTypes == "103")

               if( ( ValType( PersonPayerDetails ) != V_UNDEF ) and ( ValType( PersonPayerDetails ) == V_GENOBJ ) )

                  PersonPayerDetails.LastName = StrSubst(PersonPayerDetails.LastName,"ь","");
                  PersonPayerDetails.LastName = StrSubst(PersonPayerDetails.LastName,"Ь","");
                  StrChangeRusXSet( PersonPayerDetails.LastName, PersonPayerDetails.LastName );

                  PersonPayerDetails.FirstName = StrSubst(PersonPayerDetails.FirstName,"ь","");
                  PersonPayerDetails.FirstName = StrSubst(PersonPayerDetails.FirstName,"Ь","");
                  StrChangeRusXSet( PersonPayerDetails.FirstName, PersonPayerDetails.FirstName );

                  PersonPayerDetails.MiddleName = StrSubst(PersonPayerDetails.MiddleName,"ь","");
                  PersonPayerDetails.MiddleName = StrSubst(PersonPayerDetails.MiddleName,"Ь","");
                  StrChangeRusXSet( PersonPayerDetails.MiddleName, PersonPayerDetails.MiddleName );

               end;

               if( ( ValType( LegalEntityPayerDetails ) != V_UNDEF ) and ( ValType( LegalEntityPayerDetails ) == V_GENOBJ ) )
                                                                                                         
                  if( LegalEntityPayerDetails.LEPayerName == "АО \"РОССЕЛЬХОЗБАНК\"" )
//               LegalEntityPayerDetails.LEPayerName = "RUSSIAN AGRICULTURAL BANK";
                     LegalEntityPayerDetails.LEPayerName = "JSC ROSSELKHOZBANK";
                  else
                     LegalEntityPayerDetails.LEPayerName = StrSubst(LegalEntityPayerDetails.LEPayerName,"ь","");
                     LegalEntityPayerDetails.LEPayerName = StrSubst(LegalEntityPayerDetails.LEPayerName,"Ь","");
                     StrChangeRusXSet( LegalEntityPayerDetails.LEPayerName, LegalEntityPayerDetails.LEPayerName );
                  end;

               end;

               if( ( ValType( LegalEntityPayeeDetails ) != V_UNDEF ) and ( ValType( LegalEntityPayeeDetails ) == V_GENOBJ ) )

                  if( LegalEntityPayeeDetails.LEPayeeName == "АО \"РОССЕЛЬХОЗБАНК\"" )
//               LegalEntityPayeeDetails.LEPayeeName = "RUSSIAN AGRICULTURAL BANK";
                     LegalEntityPayeeDetails.LEPayeeName = "JSC ROSSELKHOZBANK";
                  else
                     LegalEntityPayeeDetails.LEPayeeName = StrSubst(LegalEntityPayeeDetails.LEPayeeName,"ь","");
                     LegalEntityPayeeDetails.LEPayeeName = StrSubst(LegalEntityPayeeDetails.LEPayeeName,"Ь","");
                     StrChangeRusXSet( LegalEntityPayeeDetails.LEPayeeName, LegalEntityPayeeDetails.LEPayeeName );
                  end;

               end;

               if( ( ValType( PersonPayeeDetails ) != V_UNDEF ) and ( ValType( PersonPayeeDetails ) == V_GENOBJ ) )

                  PersonPayeeDetails.PersonPayeeFIO = StrSubst(PersonPayeeDetails.PersonPayeeFIO,"ь","");
                  PersonPayeeDetails.PersonPayeeFIO = StrSubst(PersonPayeeDetails.PersonPayeeFIO,"Ь","");
                  StrChangeRusXSet( PersonPayeeDetails.PersonPayeeFIO, PersonPayeeDetails.PersonPayeeFIO );
               end;

               if( ValType( EntryDetails ) != V_UNDEF )

                  EntryDetails = StrSubst(EntryDetails,"ь","");
                  EntryDetails = StrSubst(EntryDetails,"Ь","");
                  StrChangeRusXSet( EntryDetails, EntryDetails );
               end;



            end;


            //А Киселев 15.12.12.2020 гвоздик для ЦФТ поле 72 BNF
            if( SWIFTSigns.MessageTypes == "103" )
//               StrMultyToFormat( "/BNF/" + EntryDetails, EntryDetails, 35, 100 );

              EntryDetails = GetSWIFTFieldFromMess( paymentId, "70", EntryDetails );
            elif( SWIFTSigns.MessageTypes == "202" )
              EntryDetails = GetSWIFTFieldFromMess( paymentId, "72", EntryDetails );
            end;


         end;

         /* 20181205 - kva - изменение типа данных */
         DocumentTypeCode = TIntegrationDictionaryRecordX();
 
         //20191125 - Simanov - проверяем, задана ли категория на платеже для проставления кода документа в БИС
         var PM_categ = RsbObjCategories(OBJTYPE_PAYMENT, string(PaymentId:o:10));
         var pm_groupid = 102;

         if(PM_categ.GetMainAttr(pm_groupid, {curdate}, pm_attr) == 0 )
            DocumentTypeCode.RecordCode = pm_attr.name;

         elif( ( ValType(SWIFTSigns) != V_UNDEF ) and ( ValType(SWIFTSigns.SWIFTMessage) != V_UNDEF) ) //shev 24.12.2019 иначе мы никогда не попадем в значение "01"

            //Проверки для DocumentCode A.Киселев 17.01.2019 теперь так
            if( ((Substr( CreditAccount, 1, 5 ) == "30110") or (Substr( CreditAccount, 1, 5 ) == "30114")) and
              ( sql.value("T_FIID_RECEIVER") == 0 ) )
               DocumentTypeCode.RecordCode = docTypeCodes.PAYMENT_ORDER;
            elif( ( Index(sql.value("T_PAYERACCOUNT", Null, V_STRING), "202" ) == 1 ) and ( Index(sql.value("T_RECEIVERACCOUNT", Null, V_STRING), "202" ) != 1 ) ) //shev jira-1484
               DocumentTypeCode.RecordCode = "03pv";
            elif( ( Index(sql.value("T_PAYERACCOUNT", Null, V_STRING), "202" ) != 1 ) and ( Index(sql.value("T_RECEIVERACCOUNT", Null, V_STRING), "202" ) == 1 ) ) //shev jira-1484
               DocumentTypeCode.RecordCode = "03rv";
             elif( sql.value("T_FIID_RECEIVER") != 0 )
               DocumentTypeCode.RecordCode = docTypeCodes.MEMORANDUM_ORDER;
            end;

         else
            if( ( Substr( CreditAccount.AccountNumber, 1, 5 ) == "30109" ) or ( Substr( CreditAccount.AccountNumber, 1, 5 ) == "30111" ) )
              DocumentTypeCode.RecordCode = docTypeCodes.MEMORANDUM_ORDER;
            else
              DocumentTypeCode.RecordCode = docTypeCodes.PAYMENT_ORDER;
            end;

         end;

         if ( (DocumentTypeCode.RecordCode == docTypeCodes.BANK_ORDER) or (DocumentTypeCode.RecordCode == docTypeCodes.PAYMENT_ORDER) )
           EntryNumber = CutNum(EntryNumber, 6);
         end;

         // А.Киселев 28.12.2020 для Кредит 30109/30111 SWIFT на хвост не цепляем
         if( ( ValType(SWIFTSigns) != V_UNDEF ) and
             ( ( Substr( CreditAccount.AccountNumber, 1, 5 ) == "30109" ) or ( Substr( CreditAccount.AccountNumber, 1, 5 ) == "30111" ) ) )

           SWIFTSigns = Null;

         end;


      end; //if( paymentId )
   end;

end;




private class TTransaction( EntryId, Fl_OneEntry :bool )
var OperationCode :TIntegrationDictionaryRecordX, /* 20181205 - kva - теперь объект */
    ProductCode   :TIntegrationDictionaryRecordX, /* 20181205 - kva - теперь объект */
    TransactionId :TIntegrationSymbolicIdentifierX,
    EntryList :TArray;


 private macro InitTransaction( EntryId, Fl_OneEntry )
 var operationId, stepId, paymentId, sql;

  //А.Киселев 08.11.2018
  if( (Valtype( Fl_OneEntry ) == V_UNDEF) or (Valtype( Fl_OneEntry ) == 26) )
   Fl_OneEntry = false;
  end;
  EntryList = TArray();
  //А.Киселев 08.11.2018
      
  sql = execSqlSelect( "select t_paymentid from dpmdocs_dbt where t_acctrnid=:1", 
         makeArray( sqlParam( "1", entryId ) ) );

  if( sql.moveNext() )
   paymentId = int( sql.value(0) );
  end;

  operationId = 0;
  sql = execSqlSelect( "select t_id_operation, t_id_step, t_dockind, t_documentid  from doprdocs_dbt where t_dockind=1 and t_acctrnid=:1",
          makeArray( sqlParam( "1", entryId ) ) );
  if( sql.moveNext() )
   operationId = int( sql.value("t_id_operation") );
   stepId = int( sql.value("t_id_step") );

   //А.Киселев 08.11.2018  шаблон строки TransactionId "entryId operationId stepId paymentId"
   if(Fl_OneEntry)
//            transactionId = string (operationId:10:o, stepId:5:o);
    TransactionId.ObjectId = string(entryId:10:o, operationId:10:o, stepId:5:o, mkStr("0", 10)); 
   else
    TransactionId.ObjectId = string(mkStr("0", 10), operationId:10:o, stepId:5:o, mkStr("0", 10));
   end;
   //А.Киселев 08.11.2018

   /* 20181205 - kva - Заполняем только обязательный параметр */
   OperationCode = TIntegrationDictionaryRecordX();
   OperationCode.RecordCode = this.getOperCode (operationId);

   /* 20181205 - kva - Заполняем только обязательный параметр */
   ProductCode = TIntegrationDictionaryRecordX();
   ProductCode.RecordCode = this.getProductCode (operationId);

   if( paymentId == NULL )
    sql = execSqlSelect( "select t_documentid from doproper_dbt where t_id_operation=:1 and t_dockind in (15, 16, 27, 70, 201, 202, 286, 400, 410, 420, 430, 440)",
            makeArray( sqlParam( "1", operationId ) ) );
    if( sql.moveNext() )
     	paymentId = int( sql.value(0) );
    end;


   else
      //maa170121 - ищем результирующий платеж неттинга, вместо платежа сделки, чтобы корректно собрать данные для хмл по внутреннему платежу
      sql = null;
      sql = execSqlSelect( "select t_documentid, t_dockind from doproper_dbt where t_id_operation=:1 and t_dockind = 140",
              makeArray( sqlParam( "1", operationId ) ) );
      if( sql.moveNext() )
         sql = null;
         sql = execSqlSelect( "SELECT l.T_PURPOSEPAYMENT FROM dpmlink_dbt l, dpmpaym_dbt p WHERE l.t_initialpayment = p.t_paymentid AND p.t_paymentid = :1 and p.T_PAYFIID = (select p2.T_PAYFIID from dpmpaym_dbt p2 where p2.t_paymentid = l.T_PURPOSEPAYMENT)",
          makeArray( sqlParam( "1", paymentId ) ) );
         if( sql.moveNext() )
            paymentId = int( sql.value(0) ); 
         end;
      end;
   end;


   sql = execSqlSelect( "select t_acctrnid from doprdocs_dbt where t_dockind=1 and t_id_operation=:1 and t_id_step=:2",
           makeArray( sqlParam( "1", operationId ),
                      sqlParam ("2", stepId) ) );

   while( sql.moveNext() )
    //А.Киселев 08.11.2018   
    if( not Fl_OneEntry )
     EntryList[EntryList.size] = TEntry( int(sql.value (0)), paymentId, operationId);
    elif( sql.value(0) == EntryId )
     EntryList[EntryList.size] = TEntry( int(sql.value (0)), paymentId, operationId);
     Break;
    end;
    //А.Киселев 08.11.2018
   end;

  else
   //А.Киселев 08.11.2018
   TransactionId.ObjectId = string(entryId:10:o, mkStr("0", 10), mkStr ("9", 5), mkStr("0", 10));

   /* 20181205 - kva - Заполняем только обязательный параметр */
   OperationCode = TIntegrationDictionaryRecordX();
   OperationCode.RecordCode = 0;

   /* 20181205 - kva - Заполняем только обязательный параметр */
   ProductCode = TIntegrationDictionaryRecordX();
   ProductCode.RecordCode = Null;

   EntryList[EntryList.size] = TEntry( EntryId);

   //А.Киселев 08.11.2018
  end;

 end;


 macro getOperCode( operationId )
 var sql;

  sql = execSqlSelect( "select t_kind_operation from doproper_dbt where t_id_operation=:1", 
           makeArray( sqlParam( "1", operationId ) ) );
  if( sql.moveNext() )
   return string( int( sql.value (0) ) );
  end;
 end;

 macro getProductCode( operationId ) //???
  return NULL;
 end;


 InitTransaction( EntryId, Fl_OneEntry );

end;   


private class TTransactionPm( EntryId, Fl_OneEntry :bool )
var OperationCode :TIntegrationDictionaryRecordX, /* 20181205 - kva - теперь объект */
    ProductCode   :TIntegrationDictionaryRecordX, /* 20181205 - kva - теперь объект */
    TransactionId :TIntegrationSymbolicIdentifierX,
    EntryList :TArray;


 private macro InitTransaction( EntryId, Fl_OneEntry )
 var operationId, stepId, paymentId, sql;

  //А.Киселев 08.11.2018
  if( (Valtype( Fl_OneEntry ) == V_UNDEF) or (Valtype( Fl_OneEntry ) == 26) )
   Fl_OneEntry = false;
  end;
  EntryList = TArray();
  //А.Киселев 08.11.2018
      
  sql = execSqlSelect( " SELECT A.T_ID_OPERATION, A.T_KIND_OPERATION FROM doproper_dbt A " +
                       " WHERE A.T_DOCUMENTID = LPAD(TO_CHAR(:p_PaymentId_1), 34, '0') " +
                       "  AND A.T_DOCKIND = ( SELECT NVL( ( SELECT C.T_FLAG FROM dllvalues_dbt C " +
                       "                                    WHERE C.T_LIST = USR_PKG_IMPORT_SOFR.GetPAYM_OPROPER " +
                       "                                     AND C.T_ELEMENT = B.T_DOCKIND ) , B.T_DOCKIND ) " +
                       "                      FROM dpmpaym_dbt B " +
                       "                      WHERE B.T_PAYMENTID = :p_PaymentId_2 ) ", 
          makeArray( sqlParam( "p_PaymentId_1", entryId ),
                     sqlParam( "p_PaymentId_2", entryId ) ) );
  if( sql.moveNext() )
   operationId = int( sql.value("t_id_operation") );

   // шаблон строки TransactionId "entryId operationId stepId paymentId"
   TransactionId.ObjectId = "paym" + string(mkStr("0", 10), operationId:10:o, mkStr("0", 5), EntryId:10:o );

   /* 20181205 - kva - Заполняем только обязательный параметр */
   OperationCode = TIntegrationDictionaryRecordX();
   OperationCode.RecordCode = sql.value("T_KIND_OPERATION");

   /* 20181205 - kva - Заполняем только обязательный параметр */
   ProductCode = TIntegrationDictionaryRecordX();
   ProductCode.RecordCode = this.getProductCode (operationId);

   EntryList[EntryList.size] = TEntryPm( EntryId, Fl_OneEntry); //maa170121 - цфт_в данном случае, переменная Fl_OneEntry рассматривается как признак платежа (true)

  else
   TransactionId.ObjectId = "paym" + string(mkStr("0", 10), mkStr("0", 10), mkStr("0", 5), EntryId:10:o );

  end;

 end;



 macro getProductCode( operationId ) //???
  return NULL;
 end;


 InitTransaction( EntryId, Fl_OneEntry );

end;   



/* 20181205 - kva - в схеме появился промежуточный объект */
private class TAddAccountingEntriesRequest(p_EntryId, p_FlPaym)
   var TransactionList;

   private macro InitTransaction(i_EntryId, i_FlPaym)
      var trn :TTransaction,
          trnPm :TTransactionPm;

      //А.Киселев 08.11.2018
      trn = Null;
      trnPm = Null;
      if(not i_FlPaym ) //проводки платежа
         if( (ValType(i_EntryId) == V_GENOBJ) and (isEqClass("Tarray", i_EntryId)) ) //массовые проводки
            trn = TTransaction(i_EntryId);//!!!!!цикл i_EntryId список транзакций
            TransactionList = TArray();
            trn = Null;
         else //единичные проводки
            trn = TTransaction(i_EntryId, true);
            TransactionList = TArray();
            TransactionList[TransactionList.Size] = trn;
            trn = Null;
         end;
      else //платеж без проводок
         trnPm = TTransactionPm(i_EntryId, true);
         TransactionList = TArray();
         TransactionList[TransactionList.Size] = trnPm;
         trnPm = Null;
      end;
      //А.Киселев 08.11.2018
   end;

   InitTransaction(p_EntryId, p_FlPaym);
end;

      
private class TAddAccountingEntriesRequestMsg( EntryId :variant, FlPaym :bool )
   var AddAccountingEntriesRequest;
   /* 20181205 - kva - конструктор перенесен в класс TAddAccountingEntriesRequest */
   AddAccountingEntriesRequest = TAddAccountingEntriesRequest(EntryId, FlPaym);

end;   
 

private class TAddAccountingEntriesReq( EntryId, FlPaym :bool )
var AddAccountingEntriesRequestMsg :TAddAccountingEntriesRequestMsg;

 AddAccountingEntriesRequestMsg = TAddAccountingEntriesRequestMsg( EntryId, FlPaym );
 
end;


macro addAccountingEntriesReq( EntryId, FlPaym :bool )
var res_obj :TAddAccountingEntriesReq;

  if( Valtype(FlPaym) == V_UNDEF )
   FlPaym = false;
  end;

  res_obj = TAddAccountingEntriesReq( EntryId, FlPaym );

  return res_obj;
end;


