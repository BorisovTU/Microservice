import oralib,likepy, FIInter, globals, PTInter, CTInter, cb_sql;






macro LoadRating2014( PartyId :integer )
var Params :TArray,
    DataSet :RsdRecordset,
    Query :string = "",
    PartyCateg,
    FlAll :integer = 0;


  if( ( ValType( PartyId ) == V_UNDEF ) or ( ValType( PartyId ) == 26 ) )
   FlAll = 0;
   PartyId = -1;
  else
   FlAll = 1;
  end;


  Query = " SELECT A.RAT AS LAST, A.DATRAT AS DT, " +
          "  TO_CHAR( D.T_ELEMENT) AS RATING_ID, " +
          "  SUBSTR(C.T_CODE, 1, CASE WHEN INSTR(C.T_CODE, '/') > 0 THEN INSTR(C.T_CODE, '/') - 1 " +
          "                           ELSE LENGTH(C.T_CODE) END ) AS INN, " +
          "  B.T_PARTYID, " +
          "  (SELECT E.T_ATTRID FROM dobjattr_dbt E " +
          "   WHERE E.T_OBJECTTYPE = C.T_OBJECTTYPE " +
          "    AND E.T_GROUPID  = :GroupId_1 " +
          "    AND E.T_PARENTID = D.T_FLAG " +
          "    AND E.T_NAME = A.RAT) AS T_ATTRID, " +
          "  D.T_FLAG AS T_PARENTID " +

          " FROM sofr_rating_ratingshist2014 A, dpartyown_dbt B, dobjcode_dbt C, dllvalues_dbt D " +
          " WHERE A.OBJECTTYPE = :ObjTypeRating_1 " +
          "  AND D.T_NAME = A.AGENCY " +
          "  AND A.INSTID = ( SELECT E.T_CODE FROM dobjcode_dbt E " +
          "                   WHERE E.T_OBJECTTYPE = C.T_OBJECTTYPE " +
          "                    AND E.T_OBJECTID = C.T_OBJECTID " +
          "                    AND E.T_CODEKIND =  :CodeKind102 " +
          "                    AND E.T_STATE = 0 ) " +
          "  AND A.DATRAT = ( CASE WHEN A.OBJECTTYPE = 'Компания' THEN :NotBankPartyDate ELSE :BankPartyDate END ) " +
          "  AND B.T_PARTYKIND = :PartyOwn_1 " +
          "  AND C.T_OBJECTID = B.T_PARTYID " +
          "  AND C.T_OBJECTTYPE = :ObjType_1 " +
          "  AND C.T_CODEKIND = :CodeKind_1 " +
          "  AND C.T_STATE = 0 " +
          "  AND D.T_LIST = :ListId_1 " ;

  Params = Null;
  DataSet = Null;

  Params = makeArray( SQLParam( "GroupId_1", 19 ),
                      SQLParam( "ObjTypeRating_1", "Љ®¬Ї ­Ёп" ),
                      SQLParam( "CodeKind102", 102 ),
                      SQLParam( "NotBankPartyDate", date("01.12.2014") ), //субъекты-не КО
                      SQLParam( "BankPartyDate", date("01.03.2014") ), //субъекты КО
                      SQLParam( "PartyOwn_1", 5 ),
                      SQLParam( "ObjType_1", 3),
                      SQLParam( "CodeKind_1", 16),
                      SQLParam( "ListId_1", 5004),  //!!!!!!!!!!!!!  реестр
                      SQLParam( "FlAll_1_1", FlAll ),
                      SQLParam( "FlAll_2_1", FlAll ) ); 

  DataSet = execSQLselect( Query, Params );
  while( DataSet.MoveNext )


   if( ( ValType( DataSet.value(5, Null, V_INTEGER) ) != V_UNDEF ) and
      ( ValType( DataSet.value(5, Null, V_INTEGER) ) != 26 )) 


    PartyCateg = Null;
    PartyCateg = RsbObjCategories( 3, mkStr("0", 6-StrLen(DataSet.value(4))) + DataSet.value(4));

    var sql = " select  rownum,d.t_id from dobjatcor_dbt d left join dobjattr_dbt attr on d.t_attrid = ATTR.T_ATTRID "+
              " where attr.t_parentid = :parentid and d.t_groupid = 19 and d.t_objecttype = 3 and d.t_object = :objecid and rownum = 1 order by t_validfromdate desc  ";

    var  cmd = RSDCommand(sql);
    cmd.AddParam("parentid", RSDBP_IN,DataSet.value(6) );
    cmd.AddParam("objectid", RSDBP_IN,  mkStr("0", 6-StrLen(DataSet.value(4))) + DataSet.value(4));
    var rs = RSDRecordSet(cmd);

    if (rs.movenext)   

       var  sql_str = "delete from dobjatcor_dbt where t_objecttype = :objecttype and t_object = :objectid and t_groupid = :groupid and t_id = :id";
       var  cmd_str = RSDCommand(sql_str);
       cmd_str.AddParam("objecttype", RSDBP_IN, 3);
       cmd_str.AddParam("objectid", RSDBP_IN, mkStr("0", 6-StrLen(DataSet.value(4))) + DataSet.value(4));
       cmd_str.AddParam("groupid", RSDBP_IN, 19);
       cmd_str.AddParam("id", RSDBP_IN, rs.value("t_id"));
       cmd_str.execute;
       cmd_str.close; cmd_str = null;
    end;

    PartyCateg.ConnectAttr( 19, DataSet.value(5, Null, V_INTEGER), null, null, DataSet.value(1, Null, V_DATE));

    PartyCateg.Save(mkStr("0", 6-StrLen(DataSet.value(4))) + DataSet.value(4));
    PartyCateg = Null;


   end;

  end;


onError(err)

 Params = Null;
 DataSet = Null;

end;



LoadRating2014();