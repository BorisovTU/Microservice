import oralib, likepy, globals, rsexts, commonutil/*Simanov. избаляемся от библиотеки, commoninter*/;
import "DlRepForm_h.mac", "dlmisc.mac","globals", Календарь, RSD, RsbDataSet, "or_tpl_h.mac",prnfrm,or_tpl_h, PTInter,rcw;
import RsbFormsInter, "scincfun.mac";

class (CmakeReport) CmakereportSec(_HeaderStr:string, _SepStr:string, _CountStrOnPage:integer, _CurStr:integer)
private var __NumObject:integer = 0;  // Номер экземпляра данного объекта (т.е. сколько экземпляров CMakeReport создано)
  /* Private members */  // При добавлении объектов ОБЯЗАТЕЛЬНО добавь удаление их в диструкторе!!!
   CurStr           = DefaultTxtBegStr;   // Номер текущей строки
   CurSheet         = 0;                  // Номер текущей обрабатываемой закладки
   ExlusiveFileName  = "";                 // Уникальное имя файла, используемое для автосохранения
   FormatRep        = tarray;             // Формат файла, в котором выводится отчет
   WinRepOutput     = DefaultWinRepOutput;// Приложение, в которое выводится отчет
   WorkDir          = "";                 // Рабочий каталог

   ReportPath           = "";              // Путь до готовых отчетов
   ReportFileName_xls  = "";              // Имя сформированного отчета в формате xls
   ReportFileName_doc   = "";              //                                      doc 
   ReportFileName_html  = "";              //                                      html
   
   ArrGroupColIndex         = tarray(10,10);     // Массив номеров колонок для группировки
   ArrSortField             = tarray(10,10);     // Массив объектов содержащих поля сортировки и направление сортировки
   ArrTemplate         = ClsTemplate();     // Объект с данными шаблонов
   AutoInc             = 0;                 // Переменная для автоматической нумерации строк
   BegSepStr           = "";                // Исходная строка, которая была передана в качестве строки элементов обрамления заголовока таблицы
   CountStrOnPage          = DefaultTxtPageSize;// Количество строк на печатный лист
   DirName_TMP             = "";                // Имя папки, в которой будем сохранять временные файлы
   DirName_Template      = "";                // Имя папки, в которой размещаются шаблоны
   ExecuteStrExcel       = tarray;            // Строка для выполнения спецформатирования методом ObjExcel.ExecStr
   ExecuteStrWord         = tarray;            // Строка для выполнения спецформатирования методом ObjWord .ExecStr
   lsSheet                = ClsSheet ;         // Список закладок отчета. Основной объект!
   lsTemplateDocument     = NULL ;             // Реестр шаблонов для формирования документов слияния
   FlagAddStr              = TRUE ;             // Флаг говорящий о необходимости добавления новой строки данных
   FlagAutoIncUsed        = FALSE;             // Флаг необходимости проведения автоинкрементирования переменной AutoInc при добавлении строки таблицы
   FlagAutoScanMode       = FALSE;             // Флаг режима работы автосканирования текста (добавление в объект при False, изменение переданной строки при True)
   FlagShowMidSeparator     = TRUE ;             // Флаг печати межстрочных разделителей таблицы
   FlagModeBigReport       = FALSE;             // Флаг печати в режиме больших отчет! В этом режиме отчет выводится позакладочно (для оптимизации работы с памятью)
   FlagModePrint           = STD_MODEPRINT_WITH_DUALSTR;
   FlagShowIndicator         = TRUE ;             // Флаг 
   m_FlagShowReport          = TRUE ;             // Флаг 
   m_TIFDPI                = TIFDPI_200;        // Перем
   FileNameDocumentWin     = "";                // Имя в
   FileNameDocumentTxt   = "";                // Имя в
   iMacroFileName         = "";                // Имя m
   iMacroFileNameWord     = "";                // Имя m
   iProc                   = "";                // Имя ф
   iPrm                   = "";                // Строк
   NeedCountStrHeader     = 0;                 // Колич
   NeedTypeSep            = REP_NO_SEP;        // Требу
   ObjSeparator         = CSeparator();      // Объек
   Obj_HTML_Rep        = NULL;           // Объек
   DocProperty           = NULL;           // Свойс
   KoefScreenH                 = 0;              // коэфф
   KoefScreenW               = 0;                      
   ObjExcel                  = NULL;                   
   ConvertToPDF                = FALSE;                  
   FileNamePDF               = "";                     
   ShowFilePDF                 = TRUE;                   

Macro saveDoc(path:string)

     if(Not WinRepOutput)  return 0;
     end;
     var i                   :integer = 0 ;
     var j                   :integer = 0 ;
     var k                   :integer = 0 ;
     var LastNameFileTmp     :string  = SetOutPut(this.WorkDir + "\\" + TMP_FILES, TRUE);
     var LastNameFile        :string  = "";
     var LastNameFileExt     :string  = "";
     var TempNamePath        :string  = "";
     var FlagDebug                    = ___FlagDebug___    ;
     var DirNameWork         :string  = "";
     var SizeSheet           :integer = 0 ;
     var ZoomType            :integer   ;
     FILE TxtRpRead () txt;                   /* Временный файл */
     FILE TxtRpWrite() txt write;             /* Окончательный файла получаемый из временного */
    
     ///////////////////////////////////////////////////////
     var FileNameWithPathTmp:string  = "";    /* Имя временного файла с путем */
     var StrTmp             :string  = "TMP"; /* Строка, добавляемая к наименованию временного файла. По умолчанию "TMP" */
     var FileNameWithPathAll:string  = "";    /* Имя файла с путем */
     var ReportFileExt      :string  = "";
     
     var stat               :bool    = TRUE;
     var CheckBook          :bool    = FALSE; /* Флаг существования книги в Excel */
     var m_FlagVisible      :bool;
     var LastTmpFileName    :string="";
     /////////////////////////////////////////////////////////////////                                           
     var FileName          :string  = this.ExlusiveFileName ;  // Уникальное имя файла                    
     var Flag_Delete       :bool    = TRUE;        // Флаг удаления старых отчетов             
     
     var ObjWord  = CDAOMSWord (NULL, GetRegim_LoadNewApplication); /* Объект класса CDAOMSWord , для работы с Word  */
     var ObjIE    = CDAO_IE    (NULL, GetRegim_LoadNewApplication); /* Объект класса CDAO_IE    , для работы с IE    */
  
     /* Обрежем путь и получим только имя */
     SplitFile(LastNameFileTmp, LastNameFile, LastNameFileExt);
     var systemdate;
      var sys = "select sysdate from dual";
      sys = RSDCommand(sys);
      var rssys = RsdRecordset(sys);
      rssys.movenext;
      systemdate = string(rssys.value(0));
      systemdate = strsubst(systemdate,".","");
      systemdate = strsubst(systemdate," ","");
      systemdate = strsubst(systemdate,":","");
     // Если пользователь сам задал имя файла, то его и возьмем, но номер коннекта все равно допишем в хвост
     if( FileNameDocumentWin )
         LastNameFile = FileNameDocumentWin;
     end;

     if( LastNameFile AND LastNameFileExt  )
         LastNameFile = LastNameFile + "_" + SubStr(LastNameFileExt, 2);
     end;

     /* Восстанавливаем поток вывода и удаляем получившийся файл */
     SetOutPut(LastNameFileTmp, TRUE);
     DelFile( this.WorkDir + "\\" + TMP_FILES );
     // Построим диаграммы по листам
     var Chart    :object = NULL;
     var lsCommand:tarray = NULL;
     while( j < lsSheet.Size)
         Chart = lsSheet.Get(j).GetChart();
         if( valType(Chart) )
             lsCommand = Chart.Create();
             k = 0;
             while( k < lsCommand.Size )
                this.SetExecute( lsCommand[k] );
                k = k + 1;
             end;
         end;
         j = j + 1;
     end;
    
     /* Если работаем в трехзвенке - то запускаем отчет на терминале */
     if( Not IsStandAlone() )

         // Если в строке пути есть знак ":" или "\\", то это абсолютный путь
         if( Index(toAnsi(NameDirTerm), ":") OR Index(toAnsi(NameDirTerm), "\\\\") )
             TempNamePath = SubStr(toAnsi(NameDirTerm), 2);
         else
             TempNamePath = GetCurDir(TRUE)+"\\"+SubStr(toAnsi(NameDirTerm), 2);
         end;
     else
         TempNamePath = this.WorkDir + "\\";  
     end;
///////////////////////////////////////////////////////////////////////////////////
     DirNameWork       = toOEM(TempNamePath)               ;
     SizeSheet         = lsSheet.Size()                    ;
     LastNameFile      = toANSI(DirNameWork + LastNameFile);
     ZoomType          = lsSheet.Get(0).ZoomType           ;

     if( NOT ObjExcel.Open(toAnsi(DirNameWork + FileName)) )
         return FALSE;
     end;
     CheckBook    = TRUE;

     if( SizeSheet > 1 )
      /* Только для Excel */
         ObjExcel.ExecuteMacro(iMacroFileName, iProc, iPrm);
         ObjExcel.ExecStr(ExecuteStrExcel);
         
         if (CheckOutFormatRep(WINREP_FORMAT_XLSX))
            ObjExcel.SaveAs(LastNameFile + ".xlsx", WINREP_FORMAT_XLSX);
         else
            ObjExcel.SaveAs(LastNameFile + ".xls", WINREP_FORMAT_XLS);
         end;

         ReportPath         = ObjExcel.Book.Path;
         ReportFileName_xls = ObjExcel.Book.Name;

         // Вывести в MODI
         if( CheckOutApplication(WinRepOutput, WINREP_OUTPUT_MODI) )
             PrintMODI(ObjExcel);
         end;
         
         // Вывести в PDF
         if( ConvertToPDF )
             ObjExcel.ExportAsFixedFormat( FileNamePDF, ShowFilePDF );
         end; 

         // В зависимости от флага или открываем отчет или закрываем книгу и приложение
         if( m_FlagShowReport )               
             ObjExcel.Show();
         else
          // если в приложении одна книга (наша), то закроем приложение
             if( ObjExcel.Application.Workbooks.Count == 1)
                ObjExcel.Destructor();
             else                  // иначе только нашу книгу
                ObjExcel.Book.Close(FALSE);
             end;
         end;
         /* Удалим временный файл  c терминала*/
     else
         m_FlagVisible = ObjExcel.Application.Visible;
         ObjExcel.ExecuteMacro(iMacroFileName, iProc, iPrm);
         ObjExcel.ExecStr(ExecuteStrExcel);
         ObjExcel.Application.Visible = m_FlagVisible;
          
         var SaveOrientation:integer  = ObjExcel.Book.Sheets(1).PageSetup.Orientation; // только с первой т.к в ворд выводятся только однозакладочные

         /* Делаем такой финт ушами, только если нужен IE формат */
         if( CheckOutApplication(WinRepOutput, WINREP_OUTPUT_IE  ) OR
             CheckOutApplication(WinRepOutput, WINREP_OUTPUT_WORD) )


             LastTmpFileName = SubStr(FileName, 1, StrLen(FileName) - 4) 
                              + StrTmp + SubStr(FileName, StrLen(FileName) - 3); 
             /* Простой отчет мы сохраним в таком формате, чтобы его мог прочитать и Word и Excel */
             if( DirNameWork )
                 FileNameWithPathTmp = DirNameWork + LastTmpFileName;
             else
                 FileNameWithPathTmp = LastTmpFileName;
             end;

             if(int(ObjExcel.Application.version) < MS_2007)
             ObjExcel.SaveAs(toANSI(FileNameWithPathTmp));
             else
                 ObjExcel.Publish(toANSI(FileNameWithPathTmp));
             end;
             ReportPath = ObjExcel.Book.Path;

             ObjExcel.Book.Close(FALSE);
             CheckBook = FALSE;
             /* Удалим временный файл */
             if( (NOT FlagDebug) AND OR_ExistFile(ToAnsi(DirNameWork + FileName)) )
                 OR_DeleteFile( toAnsi(DirNameWork + FileName) );
             end;

             FileNameWithPathAll = LastNameFile
                                 + SubStr(FileNameWithPathTmp, StrLen(FileNameWithPathTmp) - 3);
             
             if( ExistFile(ToAnsi(FileNameWithPathAll)) )
                 if( FLAG_ASK_DELETEFILE )
                     Flag_Delete = GetTRUE(TRUE, "Файл <"+ FileNameWithPathAll+ ">\n уже существует в данном месте! Заменить?")
                 end;
                 if( Flag_Delete )
                     if( NOT DelFile(FileNameWithPathAll) )
                         // Не смогли удалить прибавляем к имени файла уникальный префикс
                         FileNameWithPathAll = GetUniqAdd( FileNameWithPathAll );
                     end;
                 else
                     /* Удалим временный файл */
                     if( (NOT FlagDebug) AND OR_ExistFile(ToAnsi(FileNameWithPathTmp)) )
                         OR_DeleteFile(FileNameWithPathTmp);
                     end;
                     return FALSE;
                 end;
             end;
            
             if( NOT IsStandAlone() )
                 CopyOnServer( DirNameWork, LastTmpFileName, @FileNameWithPathAll );
             else
                  if( WR_Open(TxtRpRead,  FileNameWithPathTmp) )
                      if( WR_Open(TxtRpWrite, FileNameWithPathAll) )  
                          MakeFileForWE(TxtRpRead,TxtRpWrite); 
                          Close(TxtRpRead );
                          Close(TxtRpWrite);

                          if( ExistFile(toANSI(FileNameWithPathTmp)) )
                              DelFile(toANSI(FileNameWithPathTmp)); 
                          end; 
                            
                      else
                          MsgBox("Не найден файл:\n",FileNameWithPathAll);
                      end;
                  else
                       MsgBox("Не найден файл:\n",FileNameWithPathTmp);
                  end; 
             end; 
              
                
         end;
         /* Показать в Word */
         if( CheckOutApplication(WinRepOutput, WINREP_OUTPUT_WORD) )

             ObjWord.Open(toAnsi(FileNameWithPathAll), WINREP_FORMAT_HTML);

             var LastNameFileEx = "";
             if (CheckOutFormatRep(WINREP_FORMAT_DOCX))
                LastNameFileEx = LastNameFile + ".docx";
             else
                LastNameFileEx = LastNameFile + ".doc";
             end;

             ObjWord.Document.PageSetup.Orientation =  SaveOrientation - 1;   // в ворде другие константы
             ObjWord.ExecuteMacro(iMacroFileNameWord, iProc, iPrm);
             ObjWord.ExecStr(ExecuteStrWord); // Постобработка
             ObjWord.SetOrientation( ZoomType );  // Установка ориентации листа отчета

             if (CheckOutFormatRep(WINREP_FORMAT_DOCX))
                stat = ObjWord.SaveAs (LastNameFileEx, WINREP_FORMAT_DOCX);
             else
                stat = ObjWord.SaveAs (LastNameFileEx, WINREP_FORMAT_DOC);
             end;
             
             ReportFileName_doc = ObjWord.Document.Name;
             if( stat )
                 // В зависимости от флага или открываем отчет или закрываем книгу и приложение
                 if( m_FlagShowReport )
                     ObjWord.Show();
                     /*файл захватывается офисом, закроем, удалим, откроем*/
                     if((int(ObjExcel.Application.version) >= MS_2007) AND (NOT CheckOutApplication(WinRepOutput, WINREP_OUTPUT_IE)))
                         ObjWord.Document.Close();
                         OR_DeleteFile( toAnsi(FileNameWithPathAll) );
                         if (CheckOutFormatRep(WINREP_FORMAT_DOCX))
                            ObjWord.Open(toAnsi(LastNameFile + ".docx"), WINREP_FORMAT_DOCX);
                         else 
                            ObjWord.Open(toAnsi(LastNameFile + ".doc"), WINREP_FORMAT_DOC);
                         end;
                     end;  
                 else
                     // если в приложении одна книга (наша), то закроем приложение
                     if( ObjWord.Application.Documents.Count == 1)
                         ObjWord.Destructor();
                     else                  // иначе только нашу книгу
                         ObjWord.Document.Close(FALSE);
                     end;
                 end;
             end;
         end;

         /* Показать в IE */
         if( CheckOutApplication(WinRepOutput, WINREP_OUTPUT_IE) )
             // В зависимости от флага или открываем отчет или нет
             SplitFile(FileNameWithPathAll, ReportFileName_html, ReportFileExt);
             if(ReportFileExt != "")
                ReportFileName_html = ReportFileName_html + ReportFileExt;
             end;
             if( m_FlagShowReport )
                 SplitFile(FileNameWithPathAll, ReportFileName_html, NULL);
                 ObjIE.Open( toAnsi(FileNameWithPathAll) );
                 ObjIE.SetOrientation( ZoomType ); // Установка ориентации листа отчета
                 ObjIE.Show();
             end;
         end;

         /* Показать в Excel */
         if( CheckOutApplication(WinRepOutput, WINREP_OUTPUT_EXCEL) ) 
             if( NOT CheckBook )
                 ObjExcel.Open(toAnsi(FileNameWithPathAll));
             end;
//             ObjExcel.Sheet(1).PageSetup.Orientation = Saveorientation;
             path = path+ "verification" +systemdate;
             var filenam = "verification" +systemdate;
             if (CheckOutFormatRep(WINREP_FORMAT_XLSX))
                path = path + ".xlsx";
                filenam = filenam + ".xlsx";
                stat = ObjExcel.SaveAs( path, WINREP_FORMAT_XLSX );
             else
                path = path + ".xls";
                filenam = filenam + ".xls";
                stat = ObjExcel.SaveAs( path, WINREP_FORMAT_XLS );
             end;

             ReportPath         = ObjExcel.Book.Path;
             ReportFileName_xls = ObjExcel.Book.Name;
		ObjExcel.Destructor();
             return filenam;
  /*
             // Вывести в MODI
             if( CheckOutApplication(WinRepOutput, WINREP_OUTPUT_MODI) )
                 PrintMODI(ObjExcel);
             end;

             // Вывести в PDF
             if( ConvertToPDF )
                 ObjExcel.ExportAsFixedFormat( FileNamePDF, ShowFilePDF );
             end;

             if( stat )
                 // В зависимости от флага или открываем отчет или закрываем книгу и приложение
                 if( m_FlagShowReport )
                     ObjExcel.Show();
                 else
                     // если в приложении одна книга (наша), то закроем приложение
                     if( ObjExcel.Application.Workbooks.Count == 1)
                         ObjExcel.Destructor();
                     else                  // иначе только нашу книгу
                         ObjExcel.Book.Close(FALSE);
                     end;
                 end;
             end;*/
         end;  


         if( ( NOT CheckOutApplication ( WinRepOutput , WINREP_OUTPUT_IE ) )  AND
             ( NOT FlagDebug )                                                AND 
               OR_ExistFile( toAnsi(FileNameWithPathAll) )            )
             OR_DeleteFile( toAnsi(FileNameWithPathAll) );
         end;
     end;  

     if( Not IsStandAlone() )
         i = 0;
         while( i < Obj_HTML_Rep.ArrFileHTML.Size )
             RemoveFile( toANSI("$"+ DirNameWork + Obj_HTML_Rep.ArrFileHTML[i]) );
             i = i + 1;
         end;
         RemoveDir( toANSI("$"+ SubStr(DirNameWork + FileName, 1,
                                StrLen(DirNameWork + FileName)-4) + ".files") );

         if( (NOT FlagDebug) AND OR_ExistFile(toANSI(DirNameWork + FileName)) )
             OR_DeleteFile( DirNameWork + FileName );
         end;
     end; 

     OnError( Err )
         ErrorMessage(err,"Ошибка постобработки!" );
///////////////////////////////////////////////////////////////////// 
         if( NOT ___FlagDebug___ )
             this.DelTmpFilesFolders( this.WorkDir, this.ExlusiveFileName );
         end;  

  End; /* saveDoc */

  __NumObject = __NumObject + 1; // Добавляем номер экземпляра данного объекта (т.е. сколько экземпляров CMakeReport создано)
  this.Init(_HeaderStr, _SepStr, _CountStrOnPage, _CurStr);
end;
//Сверка данных по срочному рынку

macro ChekData
  var Rep;
  var sheet = 1;
  var errorcount = 0;

  var reportdate;
  /*Выясняем дату сверки, по идее во всей таблице должна быть одна дата*/
  var cmdrep = "select reportdate from sofr_sverkarestdepoin";
  cmdrep = RSDCommand(cmdrep);
  var rsrep = RsdRecordset(cmdrep);
  rsrep.movenext;
  reportdate = rsrep.value(0);

 // Находим отсутствующие договора брокерского обслуживания
  Rep = CMakeReportsec("┌┬┬┬┬┬┬┬┬┬┬┬┬┐");

  Rep.SetDefaultFontName("Times New Roman");
  Rep.SetDefaultFontSize(14);
  Rep.SetFlagShowGrid(true);
  Rep.AddPrintCell("" , 16.14,1, "c:ex_FS(b):ex_B()");
  Rep.AddPrintCell("Протокол сверки за " , 20, null, "c:ex_FS(b):ex_B()");
  Rep.AddPrintCell(string(reportdate), 16.14, null, "c:ex_FS(b):ex_B()");
  Rep.AddStr();

var cmd,rs;
	cmd = "select Contractnumber "+
" from sofr_sverkarestdepoin rest "+
" left join sofr_sverkaaccdepoin dacc on REST.ACCDEPOID = DACC.RECID "+
" where not exists "+
" (select 1 "+
" from ddlcontr_dbt dl "+
" left join dsfcontr_dbt DBO on dl.t_sfcontrid = dbo.t_id  "+
" where  dbo.t_number = dacc.contractnumber)                 ";
	cmd = RSDCommand(cmd);
	rs = RsdRecordset(cmd);
    rs.movenext;
    if (valtype(rs.value(0)) != 26)
       Rep.AddEmptyStr();
       Rep.AddPrintCell("Не найдены договоры БО в СОФР: " , 30,  null, "c:ex_FS(b):ex_B()");
       Rep.AddStr();
         Rep.AddPrintCell("Номер договора", 16.14, null, "r");
         Rep.AddStr();

       Rep.AddPrintCell(rs.value(0), 16.14, null, "c:ex_FS():ex_B(tblr)");
       Rep.AddStr();    
       errorcount = errorcount + 1;
	   while (rs.movenext)
         Rep.AddPrintCell(rs.value(0), 16.14, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddStr();
        errorcount = errorcount + 1;
	   end;
    end;
	rs = null;
    cmd = null;
	//находим виды остатков, которых у нас нет

    cmd = "SELECT contractnumber,                                                                                                                   "+
"	                  t_name,                                                                                                                   "+
"	                  accdeponumber,                                                                                                            "+
"	                  sectioncode,                                                                                                              "+
"	                  isin,                                                                                                                     "+
"                         VALUE,                                                                                                                    "+
"	                  case when exists (select 1 from dnotetext_dbt note                                                                        "+
"                         where note.t_documentid = lpad( (select t_dlcontrid from ddlcontr_dbt where t_sfcontrid =(select t_id from dsfcontr_dbt   "+
"                                                                                                   where t_number= contractnumber )   ), 34, 0)    "+
"	                  and note.t_objecttype = 207 and note.t_notekind in (101, 104, 107) and                                                         "+
"                                             REPLACE(UTL_RAW.cast_to_varchar2(t_text), CHR(0)) = accdeponumber )                                   "+
"	                  then ' '                                                                                                                  "+
"	                  else 'Не найден счет депо на договоре'                                                                                     "+
"	                  end  as errortext                                                                                                         "+
"	     FROM (SELECT /*+ USE_MERGE(PARTY,SREST,AVO) */ contractnumber,                                                                         "+
"	                  party.t_name,                                                                                                             "+
"	                  accdeponumber,                                                                                                            "+
"	                  sectioncode,                                                                                                              "+
"	                  isin,                                                                                                                     "+
"	                  VALUE,                                                                                                                    "+
"	                  srest.t_accrest                                                                                                           "+
"	             FROM sofr_sverkarestdepoin rest                                                                                                "+
"	                  LEFT JOIN sofr_sverkaaccdepoin dacc                                                                                       "+
"	                    ON REST.ACCDEPOID = DACC.RECID                                                                                          "+
"	                  LEFT JOIN dsfcontr_dbt dbo                                                                                                "+
"	                    ON DACC.CONTRACTNUMBER = DBO.T_NUMBER                                                                                   "+
"	                  LEFT JOIN ddlcontr_dbt dl                                                                                                 "+
"	                    ON dbo.t_id = DL.t_sfcontrid                                                                                            "+
"	                  LEFT JOIN dsfcontr_dbt sub                                                                                                "+
"	                    ON sub.t_id in (select t_sfcontrid from ddlcontrmp_dbt where t_dlcontrid = dl.t_dlcontrid)                              "+
"	                       AND (dacc.ACCDEPONUMBER = ANY (SELECT REPLACE(UTL_RAW.cast_to_varchar2(t_text), CHR(0))                              "+
"	                                                        FROM dnotetext_dbt NOTE1                                                            "+
"	                                                       WHERE NOTE1.t_documentid = LPAD(dl.t_dlcontrid, 34, 0)                               "+
"	                                                         AND NOTE1.t_objecttype = 207                                                       "+
"	                       AND NOTE1.t_notekind in (101, 107))                                                                                  "+
"	                       AND SUB.T_SERVKIND = 1                                                                                               "+
"	                       AND SUB.T_SERVKINDSUB = 9                                                                                            "+
"	                        OR dacc.ACCDEPONUMBER = (SELECT REPLACE(UTL_RAW.cast_to_varchar2(t_text), CHR(0))                                   "+
"	                                                   FROM dnotetext_dbt NOTE2                                                                 "+
"	                                                  WHERE NOTE2.t_documentid = LPAD(dl.t_dlcontrid, 34, 0)                                    "+
"	                                                    AND NOTE2.t_objecttype = 207                                                            "+
"	                       AND NOTE2.t_notekind = 104)                                                                                          "+
"	                       AND SUB.T_SERVKIND = 1                                                                                               "+
"	                       AND SUB.T_SERVKINDSUB = 8)                                                                                           "+
"	                  LEFT JOIN davoiriss_dbt avo                                                                                               "+
"	                    ON avo.t_isin = rest.isin and  avo.t_spisclosed <> 'X'                                                                  "+
"	                  LEFT JOIN (SELECT a.t_open_close,                                                                                         "+
"	                                    a.t_close_date,                                                                                         "+
"	                                    t_currency,                                                                                             "+
"	                                    (SELECT DECODE(t_ccy, CHR(1), t_definition, t_ccy) t_ccy                                                "+
"	                                       FROM dfininstr_dbt                                                                                   "+
"	                                      WHERE t_fiid = a.t_code_currency) t_ccy,                                                              "+
"	                                    a.t_code_currency,                                                                                      "+
"                                            sf.t_id,                                                                                               "+
"                                            sf.t_number,                                                                                           "+
"                                            SF.T_ACCCODE,                                                                                          "+
"                                            sf.t_dateclose,                                                                                        "+
"                                            sf.t_name,                                                                                             "+
"                                            mc.t_account,                                                                                          "+
"                                            ABS(RSI_RSB_ACCOUNT.RestAC(mc.T_ACCOUNT, a.T_CODE_CURRENCY, :datain, mc.T_CHAPTER, 0)) t_ACCRest,      "+
"                                            A.T_BALANCE,                                                                                           "+
"                                            mc.t_chapter,                                                                                          "+
"                                            DECODE(a.t_chapter, 1, 'ас', 21, 'бс дя', 22, 'бс жа') kind                                            "+
"                                       FROM dmcaccdoc_dbt mc,                                                                                      "+
"                                            dsfcontr_dbt sf,                                                                                       "+
"                                            daccount_dbt a                                                                                         "+
"                                      WHERE mc.t_chapter IN (22)                                                                                   "+
"                                        AND a.t_balance = 51                                                                                       "+
"                               AND mc.t_iscommon = CHR (88)                                                                                        "+
"                               AND sf.t_id = mc.t_clientcontrid                                                                                    "+
"                               AND a.t_account = mc.t_account                                                                                      "+
"                               AND a.t_chapter = mc.t_chapter) srest                                                                               "+
"                            ON srest.t_id = sub.t_id                                                                                               "+
"                               AND srest.t_currency = avo.t_fiid                                                                                   "+
"                          LEFT JOIN dparty_dbt party                                                                                               "+
"                            ON dbo.t_partyid = party.t_partyid)                                                                                    "+
"                          where t_accrest is null and                                                                                              "+
"                          not exists (select count(*) as smt, t_isin from davoiriss_dbt where t_spisclosed <> 'X' and t_isin = isin                "+
"                                      group by t_isin having count(*)>1)                                                                           ";
	cmd = RSDCommand(cmd);
        cmd.addparam("datain", rsdbp_in,reportdate );                                                                                                         
	rs = RsdRecordset(cmd);                                                                                                                
        rs.movenext;                                                                                                                           
	if (valtype(rs.value(0)) != 26)
         Rep.AddEmptyStr();
         Rep.AddPrintCell("Не найден счет ВУ по ценной бумаге в СОФР " , 40, null, "c:ex_FS(b):ex_B()");
         Rep.AddStr();
         Rep.AddPrintCell("Номер договора", 16.14, null, "r");
         Rep.AddPrintCell("Ф.И.О. клиента", 16.14, null, "r");
         Rep.AddPrintCell("Счет ДЕПО", 16.14, null, "r");
         Rep.AddPrintCell("Раздел счета", 16.14, null, "r");
         Rep.AddPrintCell("Код ц/б", 16.14, null, "r");
         Rep.AddPrintCell("Остаток  Диасофт", 16.14, null, "r");
         Rep.AddPrintCell("Примечание", 25, null, "r");
         Rep.AddStr();
         Rep.AddPrintCell(rs.value(0), 16.14, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddPrintCell(rs.value(1), 16.14, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddPrintCell(rs.value(2), 16.14, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddPrintCell(rs.value(3), 16.14, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddPrintCell(rs.value(4), 16.14, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddPrintCell(rs.value(5), 16.14, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddPrintCell(rs.value(6), 25, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddStr();
         
       errorcount = errorcount + 1;
       while (rs.movenext)
         Rep.AddPrintCell(rs.value(0), 16.14, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddPrintCell(rs.value(1), 16.14, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddPrintCell(rs.value(2), 16.14, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddPrintCell(rs.value(3), 16.14, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddPrintCell(rs.value(4), 16.14, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddPrintCell(rs.value(5), 16.14, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddPrintCell(rs.value(6), 25, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddStr();

        errorcount = errorcount + 1;
       end;
    end;
    rs = null;
    cmd = null;
    
               
	//находим расхождения по остаткам
   var cmdtrnk = "truncate table Utable_sverka_tmp";
   cmdtrnk = RSDCommand(cmdtrnk);                                                                            
   cmdtrnk.execute;

	cmd = "insert into Utable_sverka_tmp                                                              "+
"	       SELECT *                                                                                   "+
"	         FROM (SELECT                               /*+ USE_MERGE(PARTY,SREST,AVO) */             "+
"	                     contractnumber,                                                              "+
"	                      party.t_name,                                                               "+
"	                      accdeponumber,                                                              "+
"	                      isin,                                                                       "+
"	                      VALUE,                                                                      "+
"	                      srest.t_accrest                                                             "+
"	                 FROM (  SELECT dacc.contractnumber,                                              "+
"	                                dacc.accdeponumber,                                               "+
"	                                rest.isin,                                                        "+
"	                                SUM (rest.VALUE) AS VALUE                                         "+
"	                           FROM sofr_sverkaaccdepoin dacc, sofr_sverkarestdepoin rest             "+
"	                          WHERE rest.accdepoid = DACC.RECID                                       "+
"	                       GROUP BY dacc.contractnumber, dacc.accdeponumber, rest.isin) dacc          "+
"	                      LEFT JOIN dsfcontr_dbt dbo                                                  "+
"	                         ON DACC.CONTRACTNUMBER = DBO.T_NUMBER                                    "+
"	                      LEFT JOIN ddlcontr_dbt dl                                                   "+
"	                         ON dbo.t_id = DL.t_sfcontrid                                             "+
"	                      LEFT JOIN dsfcontr_dbt sub                                                  "+
"	                         ON sub.t_id IN (SELECT t_sfcontrid                                       "+
"	                                           FROM ddlcontrmp_dbt                                    "+
"	                                          WHERE t_dlcontrid = dl.t_dlcontrid)                     "+
"	                            AND (dacc.ACCDEPONUMBER =                                             "+
"	                                    ANY (SELECT REPLACE (                                         "+
"	                                                   UTL_RAW.cast_to_varchar2 (t_text),             "+
"	                                                   CHR (0))                                       "+
"	                                           FROM dnotetext_dbt NOTE1                               "+
"	                                          WHERE NOTE1.t_documentid =                              "+
"	                                                   LPAD (dl.t_dlcontrid, 34, 0)                   "+
"	                                                AND NOTE1.t_objecttype = 207                      "+
"	                                                AND NOTE1.t_notekind IN (101, 107))               "+
"	                                 AND SUB.T_SERVKIND = 1                                           "+
"	                                 AND SUB.T_SERVKINDSUB = 9                                        "+
"	                                 OR dacc.ACCDEPONUMBER =                                          "+
"	                                       (SELECT REPLACE (                                          "+
"	                                                  UTL_RAW.cast_to_varchar2 (t_text),              "+
"	                                                  CHR (0))                                        "+
"	                                          FROM dnotetext_dbt NOTE2                                "+
"	                                         WHERE NOTE2.t_documentid =                               "+
"	                                                  LPAD (dl.t_dlcontrid, 34, 0)                    "+
"	                                               AND NOTE2.t_objecttype = 207                       "+
"	                                               AND NOTE2.t_notekind = 104)                        "+
"	                                    AND SUB.T_SERVKIND = 1                                        "+
"	                                    AND SUB.T_SERVKINDSUB = 8)                                    "+
"	                      LEFT JOIN (SELECT a.t_open_close,                                           "+
"	                                        a.t_close_date,                                           "+
"	                                        t_currency,                                               "+
"	                                        a.t_code_currency,                                        "+
"	                                        sf.t_id,                                                  "+
"	                                        sf.t_number,                                              "+
"	                                        SF.T_ACCCODE,                                             "+
"	                                        sf.t_dateclose,                                           "+
"	                                        sf.t_name,                                                "+
"	                                        mc.t_account,                                             "+
"	                                        ABS (RSI_RSB_ACCOUNT.                                     "+
"	                                              RestAC (mc.T_ACCOUNT,                               "+
"	                                                      a.T_CODE_CURRENCY,                          "+
"	                                                      :datain,                                    "+
"	                                                      mc.T_CHAPTER,                               "+
"	                                                      0))                                         "+
"	                                           t_ACCRest,                                             "+
"	                                        A.T_BALANCE                                               "+
"	                                   FROM dmcaccdoc_dbt mc,                                         "+
"	                                        dsfcontr_dbt sf,                                          "+
"	                                        daccount_dbt a                                            "+
"	                                  WHERE     mc.t_chapter IN (22)                                  "+
"	                                        AND a.t_balance = 51                                      "+
"	                                        AND mc.t_iscommon = CHR (88)                              "+
"	                                        AND sf.t_id = mc.t_clientcontrid                          "+
"	                                        AND a.t_account = mc.t_account                            "+
"	                                        AND a.t_chapter = mc.t_chapter) srest                     "+
"	                         ON srest.t_id = sub.t_id                                                 "+
"	                            AND srest.t_currency IN                                               "+
"	                                   (SELECT avo.t_fiid                                             "+
"	                                      FROM davoiriss_dbt avo                                      "+
"	                                     WHERE avo.t_isin = dacc.isin                                 "+
"	                                           AND avo.t_spisclosed <> 'X')                           "+
"	                      LEFT JOIN dparty_dbt party                                                  "+
"	                         ON dbo.t_partyid = party.t_partyid) ";
                                                                                                          
	cmd = RSDCommand(cmd);                                                                            
        cmd.addparam("datain", rsdbp_in,reportdate );                                                                                                         
	cmd.execute;
	var cmdnew = "select * from Utable_sverka_tmp where VALUE <>T_ACCREST and T_ACCREST is not null";
        rs = RsdRecordset(cmdnew);
	rs.movenext;
    if (valtype(rs.value(0)) != 26)
         Rep.AddEmptyStr();
         Rep.AddPrintCell("Обнаружены расхождения по остатку:" , 35, null, "c:ex_FS(b):ex_B()");
         Rep.AddStr();
         Rep.AddPrintCell("Номер договора ", 16.14, null, "r");
         Rep.AddPrintCell("Ф.И.О. клиента", 16.14, null, "r");
         Rep.AddPrintCell("Счет ДЕПО ", 16.14, null, "r");
         Rep.AddPrintCell("Код ц/б ", 16.14, null, "r");
         Rep.AddPrintCell("Остаток Диасофт", 16.14, null, "r");
         Rep.AddPrintCell("Остаток СОФР", 16.14, null, "r");
         Rep.AddStr();
         Rep.AddPrintCell(rs.value(0), 16.14, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddPrintCell(rs.value(1), 16.14, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddPrintCell(rs.value(2), 16.14, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddPrintCell(rs.value(3), 16.14, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddPrintCell(rs.value(4), 16.14, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddPrintCell(rs.value(5), 16.14, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddStr();
       errorcount = errorcount + 1;
       while (rs.movenext)
        errorcount = errorcount + 1;
	 Rep.AddPrintCell(rs.value(0), 16.14, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddPrintCell(rs.value(1), 16.14, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddPrintCell(rs.value(2), 16.14, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddPrintCell(rs.value(3), 16.14, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddPrintCell(rs.value(4), 16.14, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddPrintCell(rs.value(5), 16.14, null, "c:ex_FS():ex_B(tblr)");
         Rep.AddStr();
       end;
    end;
    rs = null;
    cmd = null;
                    
	cmd = "select count(*) from sofr_sverkaaccdepoin";
        cmd = RSDCommand(cmd);
        rs = RsdRecordset(cmd);
        rs.movenext;
        Rep.AddEmptyStr();
        Rep.AddPrintCell("Обработано строк по договорам ДЕПО: ", 30, null, "c:ex_FS():ex_B()");
        Rep.AddPrintCell(string(int(rs.value(0))), 16.14, null, "c:ex_FS():ex_B()");
        
        Rep.AddStr();
        
	cmd = "select count(*) from sofr_sverkarestdepoin";
        cmd = RSDCommand(cmd);
        rs = RsdRecordset(cmd);
        rs.movenext;
        Rep.AddEmptyStr();
	Rep.AddPrintCell("Обработано строк по счетам ДЕПО: ", 30, null, "c:ex_FS():ex_B()");
        Rep.AddPrintCell(string(int(rs.value(0))), 16.14, null, "c:ex_FS():ex_B()");
        
        Rep.AddStr();
        
    if (errorcount == 0)
	Rep.AddPrintCell("Расхождений не обнаружено", 25, null, "c:ex_FS():ex_B()");
        Rep.AddStr();
        
    else
	Rep.AddPrintCell("Обнаружено ", 10, null, "c:ex_FS():ex_B()");
	Rep.AddPrintCell(string(errorcount), 10, null, "c:ex_FS():ex_B()");
	Rep.AddPrintCell(" расхождений", 10, null, "c:ex_FS():ex_B()");
        Rep.AddStr();
    end;
  Rep.PrintWinRep("Отчет");
  Rep.SetZoomType(ZOOM_TYPE_A4L);
  Rep.SetWinRepOutput();
  var filename = Rep.SaveDoc("D:\\RSHB_SOFR\\TxtFile\\");
if (copyFile("..\\TxtFile\\"+ filename, "\\\\sgo-fc01-r03.go.rshbank.ru\\sofr_for_etl\\inbox\\sverka\\"+ filename));
removefile("..\\TxtFile\\"+ filename);
//  Rep.ShowWinRep(); //В итоге надо определиться как отчет будет работать, либо выводить отчет на экран, либо сохранять безитерфейсно
end;
end;

//chekdata;