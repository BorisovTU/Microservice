/*
carry_not_need_sent.mac
*/
import globals, or_rep_h, oralib, likepy;

macro carry_not_need_sent_rep ()
  var EXCEL_MONEY = "\"# ##0,00\"";
  var repdt = {curdate};
  var rn    = 0;
  var sheet = 1;
  var count = 0;
  var col1_len = 6;
  var col2_len = 5;
  var col3_len = 12;
  var col4_len = 20;
  var col5_len = 7;
  var col6_len = 14;
  var col7_len = 20;
  var col8_len = 7;
  var col9_len = 14;
  var col10_len = 12;
  var col11_len = 30;
  var col12_len = 15;
  var col13_len = 10;
  var col14_len = 10;
  var Rep, sql;

  if (not GetDate(repdt)) 
    return 1;
  end;

  Rep = CMakeReport("┌┬┬┬┬┬┬┬┬┬┬┬┐");
  Rep.SetDefaultFontName("Times New Roman");
  Rep.SetDefaultFontSize(10);
  Rep.SetFlagShowGrid(true);

  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(6).NumberFormat = "+EXCEL_MONEY+";");
  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(9).NumberFormat = "+EXCEL_MONEY+";");

  rn = rn + 1;
  Rep.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
  Rep.AddPrintCell("Список проводок СОФР, которые не нужно выгружать в БИСквит " + repdt, col1_len, null, "l:ex_FS(b):ex_B(tblr)");
  Rep.AddStr();
  
  rn = rn + 1;
  Rep.AddPrintCell("ID",                col1_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Глава",             col2_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Номер",             col3_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Счет дебета",       col4_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Валюта дебета",     col5_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Сумма дебета",      col6_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Счет кредита",      col7_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Валюта кредита",    col8_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Сумма кредита",     col9_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Дата проводки",     col10_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Назначение",        col11_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Операционист",      col12_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Пачка",             col13_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("ИД проводки в БИС", col14_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddStr();

  sql = " select t_acctrnid acctrnid, \n"
      + "       t_chapter chapter, \n"
      + "       t_numb_document numb, \n"
      + "       t_account_payer debetacc, \n"
      + "       t_sum_payer debetsum, \n"
      + "       (select t_ccy from dfininstr_dbt where t_fiid = acctrn.t_fiid_payer) debetcur, \n"
      + "       t_account_receiver kreditacc, \n"
      + "       t_sum_receiver kreditsum, \n"
      + "       (select t_ccy from dfininstr_dbt where t_fiid = acctrn.t_fiid_receiver) kreditcur, \n"
      + "       t_date_carry date_carry, \n"
      + "       (select t_name from dperson_dbt where t_oper = acctrn.t_oper) oper, \n"
      + "       t_ground, \n"
      + "       acctrn.t_number_pack pack, \n"
      + "       acctrn.t_userfield4 usf4 \n"
      + "from dacctrn_dbt acctrn \n"
      + "where    t_date_carry = :dt \n"
      + "      and t_state = 1 \n"
      + "      and acctrn.t_chapter in (1, 3, 4) \n"
      + "      and (   t_result_carry = 18 \n"
      + "           or t_result_carry = 82 \n"
      + "           or t_result_carry = 46 \n"
      + "           or t_account_receiver like '301%' \n"
      + "           or t_account_payer like '301%' \n"
      + "           or t_userfield2 = '1' \n"
      + "          ) \n"
      + "order by acctrn.t_chapter, acctrn.t_oper, acctrn.t_acctrnid \n";
  sql = ExecSqlSelect(sql, MakeArray(SqlParam("dt", repdt)), false);

  while (sql.MoveNext() )
    rn = rn + 1;
    Rep.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = true;");

    Rep.AddPrintCell(sql.value("acctrnid"),  col1_len, null, "c:ex_FS():ex_B(tblr)"); // 1. ID
    Rep.AddPrintCell(sql.value("chapter"),   col2_len, null, "c:ex_FS():ex_B(tblr)"); // 2. Глава
    Rep.AddPrintCell(sql.value("numb"),      col3_len, null, "c:ex_FS():ex_B(tblr)"); // 3. Номер
    Rep.AddPrintCell(sql.value("debetacc"),  col4_len, null, "c:ex_FS():ex_B(tblr)"); // 4. Счет дебета
    Rep.AddPrintCell(sql.value("debetcur"),  col5_len, null, "c:ex_FS():ex_B(tblr)"); // 5. Валюта дебета
    Rep.AddPrintCell(sql.value("debetsum"),  col6_len, null, "c:ex_FS():ex_B(tblr)"); // 6. Сумма дебета
    Rep.AddPrintCell(sql.value("kreditacc"), col7_len, null, "c:ex_FS():ex_B(tblr)"); // 7. Счет кредита
    Rep.AddPrintCell(sql.value("kreditcur"), col8_len, null, "c:ex_FS():ex_B(tblr)"); // 8. Валюта кредита
    Rep.AddPrintCell(sql.value("kreditsum"), col9_len, null, "c:ex_FS():ex_B(tblr)"); // 9. Сумма кредита
    Rep.AddPrintCell(sql.value("date_carry", null, V_DATE), col10_len, null, "c:ex_FS():ex_B(tblr)"); // 10. Дата проводки
    Rep.AddPrintCell(sql.value("t_ground"),  col11_len, null, "c:ex_FS():ex_B(tblr)"); // 11. Назначение
    Rep.AddPrintCell(sql.value("oper"),      col12_len, null, "c:ex_FS():ex_B(tblr)"); // 12. Операционист
    Rep.AddPrintCell(sql.value("pack"),      col13_len, null, "c:ex_FS():ex_B(tblr)"); // 13. Пачка
    Rep.AddPrintCell(sql.value("usf4"),      col14_len, null, "c:ex_FS():ex_B(tblr)"); // 14. ИД проводки в БИС
    Rep.AddStr();

    count = count + 1;
  end;

  rn = rn + 1;
  Rep.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
  Rep.AddPrintCell("Количество проводок: " + count, col1_len, null, "l:ex_FS(b):ex_B()");
  Rep.AddStr();

  /*************************Выгруженные*********************/
  count = 0;
  sheet = 2;
  rn = 0;

  Rep.AddNewSheetBreak("Проводки_2", "┌┬┬┬┬┬┬┬┬┬┬┬┐");
  Rep.SetDefaultFontName("Times New Roman");
  Rep.SetDefaultFontSize(10);
  Rep.SetFlagShowGrid(true);

  col1_len = 6;
  col2_len = 5;
  col3_len = 12;
  col4_len = 20;
  col5_len = 7;
  col6_len = 14;
  col7_len = 20;
  col8_len = 7;
  col9_len = 14;
  col10_len = 12;
  col11_len = 30;
  col12_len = 15;
  col13_len = 10;
  col14_len = 10;

  Rep.SetExecute("iBook.Sheets("+sheet+").Columns(5).NumberFormat = "+EXCEL_MONEY+";");

  rn = rn + 1;
  Rep.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
  Rep.AddPrintCell("Список проводок СОФР, которые выгружать не нужно, но они выгружены " + repdt, col1_len, null, "l:ex_FS(b):ex_B(tblr)");
  Rep.AddStr();

  rn = rn + 1;
  Rep.AddPrintCell("ID",             col1_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Глава",          col2_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Номер",          col3_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Счет дебета",    col4_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Валюта дебета",  col5_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Сумма дебета",   col6_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Счет кредита",   col7_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Валюта кредита", col8_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Сумма кредита",  col9_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Дата проводки",  col10_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Назначение",     col11_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddPrintCell("Операционист",   col12_len, null, "c:ex_FS(b):ex_B(tblr)");
  Rep.AddStr();

  sql = " select t_acctrnid acctrnid, \n"
      + "       t_chapter chapter, \n"
      + "       t_numb_document numb, \n"
      + "       t_account_payer debetacc, \n"
      + "       t_sum_payer debetsum, \n"
      + "       (select t_ccy from dfininstr_dbt where t_fiid = acctrn.t_fiid_payer) debetcur, \n"
      + "       t_account_receiver kreditacc, \n"
      + "       t_sum_receiver kreditsum, \n"
      + "       (select t_ccy from dfininstr_dbt where t_fiid = acctrn.t_fiid_receiver) kreditcur, \n"
      + "       t_date_carry date_carry, \n"
      + "       (select t_name from dperson_dbt where t_oper = acctrn.t_oper) oper, \n"
      + "       t_ground, \n"
      + "       acctrn.t_number_pack pack, \n"
      + "       acctrn.t_userfield4 usf4 \n"
      + "from dacctrn_dbt acctrn \n"
      + "where    t_date_carry = :dt \n"
      + "      and t_state = 1 \n"
      + "      and acctrn.t_chapter in (1, 3, 4) \n"
      + "      and (   t_result_carry = 18 \n"
      + "           or t_result_carry = 46 \n"
      + "           or t_result_carry = 82 \n"
      + "           or t_account_receiver like '301%' \n"
      + "           or t_account_payer like '301%' \n"
      + "           or t_userfield2 = '1' \n"
      + "          ) \n"
      + "      and (   exists (select 1 from utableprocessevent_dbt where t_objecttype = 1 and t_objectid = acctrn.t_acctrnid and t_status = 4) \n"
      + "           /*or acctrn.t_userfield4 <> chr(1)*/ ) \n"
      + "order by acctrn.t_chapter, acctrn.t_oper, acctrn.t_acctrnid \n";
  sql = ExecSqlSelect(sql, MakeArray(SqlParam("dt", repdt)), false);

  while (sql.MoveNext() )
    rn = rn + 1;
    Rep.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = true;");

    Rep.AddPrintCell(sql.value("acctrnid"),  col1_len, null, "c:ex_FS():ex_B(tblr)"); // 1. ID
    Rep.AddPrintCell(sql.value("chapter"),   col2_len, null, "c:ex_FS():ex_B(tblr)"); // 2. Глава
    Rep.AddPrintCell(sql.value("numb"),      col3_len, null, "c:ex_FS():ex_B(tblr)"); // 3. Номер
    Rep.AddPrintCell(sql.value("debetacc"),  col4_len, null, "c:ex_FS():ex_B(tblr)"); // 4. Счет дебета
    Rep.AddPrintCell(sql.value("debetcur"),  col5_len, null, "c:ex_FS():ex_B(tblr)"); // 5. Валюта дебета
    Rep.AddPrintCell(sql.value("debetsum"),  col6_len, null, "c:ex_FS():ex_B(tblr)"); // 6. Сумма дебета
    Rep.AddPrintCell(sql.value("kreditacc"), col7_len, null, "c:ex_FS():ex_B(tblr)"); // 7. Счет кредита
    Rep.AddPrintCell(sql.value("kreditcur"), col8_len, null, "c:ex_FS():ex_B(tblr)"); // 8. Валюта кредита
    Rep.AddPrintCell(sql.value("kreditsum"), col9_len, null, "c:ex_FS():ex_B(tblr)"); // 9. Сумма кредита
    Rep.AddPrintCell(sql.value("date_carry", null, V_DATE), col10_len, null, "c:ex_FS():ex_B(tblr)"); // 10. Дата проводки
    Rep.AddPrintCell(sql.value("t_ground"),  col11_len, null, "c:ex_FS():ex_B(tblr)"); // 11. Назначение
    Rep.AddPrintCell(sql.value("oper"),      col12_len, null, "c:ex_FS():ex_B(tblr)"); // 12. Операционист
    Rep.AddPrintCell(sql.value("pack"),      col13_len, null, "c:ex_FS():ex_B(tblr)"); // 13. Пачка
    Rep.AddPrintCell(sql.value("usf4"),      col14_len, null, "c:ex_FS():ex_B(tblr)"); // 14. ИД проводки в БИС
    Rep.AddStr();

    count = count + 1;
  end;

  rn = rn + 1;
  Rep.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
  Rep.AddPrintCell("Количество выгруженных проводок: " + count, col1_len, null, "l:ex_FS(b):ex_B()");
  Rep.AddStr();

  Rep.PrintWinRep("Проводки");
  Rep.SetZoomType(ZOOM_TYPE_A4L);
  Rep.SetWinRepOutput();
  Rep.ShowWinRep();

End;

carry_not_need_sent_rep();
exit(1);