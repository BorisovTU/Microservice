//-----------------------------------------------------------------------------------------
// Передача из СОФР данных по удаленным проводкам
// В.Горленко
//-----------------------------------------------------------------------------------------
import bankinter, oralib, likepy, fiinter, commonutil;



Private const extCodeKind = 1; // Код субъекта в Бисквит
Private const RegistryPath = "РСХБ\\ИНТЕГРАЦИЯ\\NUMOPERAPPROV";


Private macro getUserCode ( oper )
   Var sql = execSqlSelect ("select t_code from dpartcode_dbt where t_codekind=:1 and t_partyid=(select t_partyid from dperson_dbt where t_oper=:2)",
                             makeArray (sqlParam ("1", extCodeKind), sqlParam ("2", oper)));
   if ( sql.moveNext () )
      return string (sql.value (0));
   end;
   return "";
End;
//-----------------------------------------------------------------------------------------

private class c_entry_id(i_trn_info)
   var ObjectId     : string
      ,SystemId     : string
      ,SystemNodeId : string;

   macro m_init_prime(p_trn_info)
      var v_ind;

      if(ValType(p_trn_info) == V_INTEGER)
         ObjectId = p_trn_info;
      else
//         ObjectId = string (int (p_trn_info.value ("t_absId"))); /* 20190205 - kva: передаем другое значение */
         v_ind = index(p_trn_info.value("t_userfield4"), "#");
         if(v_ind != 0)
            ObjectId = substr(p_trn_info.value("t_userfield4"), 1, (v_ind - 1));
//         else
            /* Что делать в этой ситуации? Пока заполним id RS-Bank'а */
            /* 20190322 - Пока не будем заполнять: идентификаторы, похоже, пересекаются, а в качестве оповещения будет ошибка валидации */
//            ObjectId = string (int (p_trn_info.value("t_absId")));
         end;
      end;
   end;

   m_init_prime(i_trn_info);
end;
//-----------------------------------------------------------------------------------------

Private class CApproveEntry ( trnInfo )
   var EntryStatus     : STRING,
       PersonnelNumber : STRING,
       EntryID         : OBJECT;

   this.init (trnInfo);

   Macro init ( trnInfo )
//shev 22.07.2019
   var str :integer,
       strTab = "",
       count,
       stat = 0;

//        EntryID = string (int (trnInfo.value ("t_absId"))); /* 20181122 - kva: EntryID является объектом */
      EntryID = c_entry_id(trnInfo);
      //maa PersonnelNumber = getUserCode (int (trnInfo.value ("t_userId")));
      //PersonnelNumber = "00000000"; /* 20181210 - kva - Временно: Нужно больше нулей!!! */
//shev 22.07.2019 перенес в реестр
//      PersonnelNumber = "00050584"; /* 20190113 - kva - Новые указания ; maa160119-указал новый табельный */

      GetRegistryValue(RegistryPath, V_INTEGER, str, stat);

      PersonnelNumber = ReadNoteForObject(92,string(str:o:10),200);

      EntryStatus = "АННУЛ";
   End;
End;
//-----------------------------------------------------------------------------------------

Private class CApproveEntryList ( acctrnId, entryId )
//    Var transactionId : STRING; /* 20181122 - kva: нет такого в схеме */
   var ApproveEntry : OBJECT;

   this.init (acctrnId, entryId);
/*А.Киселев 28.11.2018
   Macro init ( acctrnId, entryId )
      CaptureOutput ();
      [select (select lpad (EXTRACTVALUE (t_fmtblobdata_xxxx, 'xml/t#@n="doprstep_dbt"#/f#@n="t_id_operation"#/o'), 10, '0')||lpad (EXTRACTVALUE (t_fmtblobdata_xxxx, 'xml/t#@n="doprstep_dbt"#/f#@n="t_id_step"#/o'), 5, '0')
                 from dxml2_dfisclog_dbt where t_recid = (select max (t_recid) from dxml2_dfisclog_dbt where t_tablename = 'oprstep.dbt' and t_recid < x.t_recid and t_userid = x.t_userid and t_date = x.t_date and
                                                                                                             t_time between x.t_time - interval '2' SECOND and x.t_time + interval '2' SECOND)) t_trnid
                ,t_recid, t_userid, t_date, t_time, :1 t_absId
         from dxml2_dfisclog_dbt x
         where t_date between trunc (sysdate)-1 and trunc (sysdate) and t_tablename = 'acctrn.dbt' and t_opcode=1006 and existsNode (t_fmtblobdata_xxxx, 'xml/t#@n="dacctrn_dbt"#/f#@n="t_acctrnid" and contains(o,":1")#') = 1]
      ("[", "]", "[", "]", "[", "]", "[", "]", "[", "]", "[", "]", "[", "]", "[", "]");
      Var sql = execSqlSelect (strSubst (StopCaptureOutput (), ":1", string (acctrnId)), makeArray (sqlParam ("1", entryId)));
      if ( sql.movenext () )
         if ( valType (sql.value ("t_trnid")) != 26 )
//                transactionId = sql.value ("t_trnId"); /* 20181122 - kva: нет такого в схеме */
            ApproveEntry = CApproveEntry (sql);
         end;
      end;
   End;
*/

   Macro init ( acctrnId, entryId )
      var Query :string = "",
          Params :TArray,
          DataSet :RsdRecordset;


      Query = " SELECT T_ACCTRNID AS T_TRNID, -1 AS T_RECID, T_OPER AS T_USERID, " +
              "  T_DATE_CARRY AS T_DATE, T_DATE_CARRY AS T_TIME, T_ACCTRNID AS T_ABSID, T_USERFIELD4 " +
              " FROM dacctrn_dbt " +
              " WHERE T_ACCTRNID = :p_AccTrn ";

      Params = makeArray( SQLParam( "p_AccTrn", acctrnId ));  //формируется
      DataSet = execSQLselect( Query, Params );

      if( DataSet.MoveNext ) //создание записи в очереди

//         if ( valType (DataSet.value ("t_trnid")) != 26 ) /* 20190205 - kva: странное условие в этом месте */
//                transactionId = DataSet.value ("t_trnId"); /* 20181122 - kva: нет такого в схеме */
         ApproveEntry = CApproveEntry (DataSet);
//         end;

      else /* 20190113 - kva - заполняем объект теми данными, которые есть */
         DataSet = Null;

         Query = " SELECT T_ACCTRNID AS T_TRNID, -1 AS T_RECID, T_OPER AS T_USERID, " +
                 "  T_DATE_CARRY AS T_DATE, T_DATE_CARRY AS T_TIME, T_ACCTRNID AS T_ABSID, T_USERFIELD4 " +
                 " FROM upickupdel_dbt " +
                 " WHERE T_ACCTRNID = :p_AccTrn ";
         DataSet = execSQLselect( Query, Params );

         if(DataSet.movenext)
            ApproveEntry = CApproveEntry (DataSet);

//         else /* Ничего не нашли - заполнять пока не будем - пусть лучше будет ошибка */
//            ApproveEntry = CApproveEntry(acctrnId);
         end;
      end;

      Params = Null;
      DataSet = Null;

   End;


End;
//-----------------------------------------------------------------------------------------

Private class CApproveAccountingEntries_Req ( acctrnId, entryId )
   Var ApproveAccountingEntriesRequest : OBJECT;

   this.init (acctrnid, entryId);

   Macro init ( acctrnId, entryId )
      ApproveAccountingEntriesRequest = CApproveEntryList (acctrnid, entryId);
   End;
End;
//-----------------------------------------------------------------------------------------

private class c_req_obj(i_acc_trn_id)
   var ApproveAccountingEntriesRequestMsg;

   macro m_init_prime(p_acc_trn_id)
      ApproveAccountingEntriesRequestMsg = CApproveAccountingEntries_Req(p_acc_trn_id);
   end;

   m_init_prime(i_acc_trn_id);
end;
//-----------------------------------------------------------------------------------------

Macro ApproveAccountingEntries_Req ( acctrnId )
//    return CApproveAccountingEntries_Req (acctrnId);
   return c_req_obj(acctrnId);
End;
//-----------------------------------------------------------------------------------------


//var v_req = ApproveAccountingEntries_Req ( 30577 );

//msgbox("Done!");