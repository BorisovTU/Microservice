/*------------------------------------------*/
/* Интеграция. Общий функционал для работы  */
/* с курсами финансовых инструментов        */
/*                                          */
/* Автор: Карпов В.                         */
/*------------------------------------------*/
/* Требуется наличие ХП :                   */
/* USR_PKG_IMPORT_SOFR.ImportOneCourse_g()  */
/*------------------------------------------*/

import rsd;
import "global_utils_intgr.mac";


/*----------------------------------------------*/
/* Функционал сохранения курсов (базовый класс) */
/*----------------------------------------------*/
class c_save_rate()
   private var vg_service_msg;
   private var vg_base_fiid;
   private var vg_other_fiid;
   private var vg_rate_kind;
   private var vg_since_date;
   private var vg_market_place;
   private var vg_market_section;
   private var vg_rate;
   private var vg_scale;
   private var vg_point;
   private var vg_is_relative;
   private var vg_is_dominant;
   private var vg_is_inverse;
   private var vg_oper;
   private var vg_err;
   
   var vg_error_array = TArray;

   /* Получение сервисного сообщения */
   macro m_get_service_msg()
      return vg_service_msg;
   end;

   /* Очищение данных */
   private macro m_clear_buf()
      vg_base_fiid      = NULL;
      vg_other_fiid     = NULL;
      vg_rate_kind      = NULL;
      vg_since_date     = NULL;
      vg_market_place   = NULL;
      vg_market_section = NULL;
      vg_rate           = NULL;
      vg_scale          = NULL;
      vg_point          = NULL;
      vg_is_relative    = NULL;
      vg_is_dominant    = NULL;
      vg_is_inverse     = NULL;
      vg_oper           = NULL;
      vg_err            = NULL;
      vg_error_array.size = 0;       
   end; /* macro m_clear_buf() */

   /* Сохранение данных в БД */
   private macro m_save_rate()
      private var v_status = 0;
      private var v_sql, v_cmd;

      v_sql =         "BEGIN ";
      v_sql = v_sql + "    :p_ret_val := USR_PKG_IMPORT_SOFR.ImportOneCourse_g(:p_base_fiid, ";
      v_sql = v_sql + "                                                        :p_other_fiid, ";
      v_sql = v_sql + "                                                        :p_rate_kind, ";
      v_sql = v_sql + "                                                        :p_since_date, ";
      v_sql = v_sql + "                                                        :p_market_place, ";
      v_sql = v_sql + "                                                        :p_market_section, ";
      v_sql = v_sql + "                                                        :p_rate, ";
      v_sql = v_sql + "                                                        :p_scale, ";
      v_sql = v_sql + "                                                        :p_point, ";
      /* Не нашел способа передачи значения chr(0), поэтому пока так... */
      if(vg_is_relative == strfor(0))
         v_sql = v_sql + "                                            chr(0), ";
      /* В принципе, chr(88) передается нормально, поэтому закомментировано *//*
      elif(vg_is_relative == strfor(88))
         v_sql = v_sql + "                                            chr(88), ";*/
      else
         v_sql = v_sql + "                                            :p_is_relative, ";
      end;
      if(vg_is_dominant == strfor(0))
         v_sql = v_sql + "                                            chr(0), ";
      /*elif(vg_is_dominant == strfor(88))
         v_sql = v_sql + "                                            chr(88), ";*/
      else
         v_sql = v_sql + "                                            :p_is_dominant, ";
      end;
      if(vg_is_inverse == strfor(0))
         v_sql = v_sql + "                                            chr(0), ";
      /*elif(vg_is_inverse == strfor(88))
         v_sql = v_sql + "                                            chr(88), ";*/
      else
         v_sql = v_sql + "                                            :p_is_inverse, ";
      end;
      v_sql = v_sql + "                                               :p_oper, ";
      v_sql = v_sql + "                                               :p_err); ";
      v_sql = v_sql + "END; ";

      v_cmd = RSDCommand(v_sql);
      v_cmd.addParam("p_ret_val",        RSDBP_OUT, V_INTEGER);
      v_cmd.addParam("p_base_fiid",      RSDBP_IN, vg_base_fiid);
      v_cmd.addParam("p_other_fiid",     RSDBP_IN, vg_other_fiid);
      v_cmd.addParam("p_rate_kind",      RSDBP_IN, vg_rate_kind);
      v_cmd.addParam("p_since_date",     RSDBP_IN, vg_since_date);
      v_cmd.addParam("p_market_place",   RSDBP_IN, vg_market_place);
      v_cmd.addParam("p_market_section", RSDBP_IN, vg_market_section);
      v_cmd.addParam("p_rate",           RSDBP_IN, vg_rate);
      v_cmd.addParam("p_scale",          RSDBP_IN, vg_scale);
      v_cmd.addParam("p_point",          RSDBP_IN, vg_point);
      if(vg_is_relative != strfor(0)/* and (vg_is_relative != strfor(88))*/)
         v_cmd.addParam("p_is_relative", RSDBP_IN, vg_is_relative);
      end;
      if(vg_is_dominant != strfor(0)/* and (vg_is_dominant != strfor(88))*/)
         v_cmd.addParam("p_is_dominant", RSDBP_IN, vg_is_dominant);
      end;
      if(vg_is_inverse != strfor(0)/* and (vg_is_inverse != strfor(88))*/)
         v_cmd.addParam("p_is_inverse",  RSDBP_IN, vg_is_inverse);
      end;
      v_cmd.addParam("p_oper",           RSDBP_IN, vg_oper);
      v_cmd.addParam("p_err",            RSDBP_OUT, V_STRING);
      v_cmd.execute();

      v_status = v_cmd.value("p_ret_val");
      vg_err   = v_cmd.value("p_err");

      if(v_status != 0)
         vg_service_msg = string("Проблема сохранения курса: ", vg_err);
         //RunError(vg_service_msg, c_usr_err_obj(vg_service_msg));
         vg_error_array.value(vg_error_array.size) = vg_service_msg;
      end;

      v_cmd.close(); v_cmd = NULL; v_sql = NULL;

   onError(err)
      if(v_status != 0)
         vg_service_msg = c_usr_err_obj.obtain_err_msg(err);
      else
         vg_service_msg = "Возникла проблема при сохранении курса";
      end;
      //RunError(vg_service_msg, c_usr_err_obj(vg_service_msg));
      vg_error_array.value(vg_error_array.size) = vg_service_msg;
   end; /* macro m_save_rate() */

end; /* class c_save_rate() */