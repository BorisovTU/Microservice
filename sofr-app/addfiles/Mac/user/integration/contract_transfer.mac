/*
$Name:        contract_transfer.mac
$Module:      Интеграция с внешними системами
$Description: Перенос договоров с одного клиента на другого
*/
// DEF-33210 SD8643394||--- Отсутствует ---||Из ЦФТ в СОФР не правильно грузятся клиенты	
// В результате отката релиза октября 2022, по 6 договорам остались старые ссылки в CDI, из-за чего договоры зарегистрировались на другого субъекта
// DEF-44441 Поглощение клиента клиентом
import rsd, PTInter;
import globals;


macro DoIt(pold_code, pnew_code, pcontractnumber)
   var sql_str, cmd;

sql_str = String(
"declare \n", 
"   vold_code varchar2(30) := :pold_code; \n",
"   vnew_code varchar2(30) := :pnew_code; \n",
"   vcontrnumber varchar2(30) := :pcontractnumber; \n",

"   vnew_partyid number(10); \n",
"   vold_partyid number(10); \n",
"begin \n",
"   select t_objectid into vold_partyid \n",
"     from dobjcode_dbt \n",
"    where t_objecttype = 3  and t_codekind = 101 and  t_code= vold_code and t_state = 0; \n",

"   select t_objectid into vnew_partyid \n",
"     from dobjcode_dbt \n",
"    where t_objecttype = 3  and t_codekind = 101 and  t_code= vnew_code and t_state = 0; \n",

"   for datax in ( \n",
"      select sf.t_id, sf.t_partyid, sf.t_number \n",
"        from dsfcontr_dbt sf, ddlcontr_dbt dl \n",
"       where sf.t_id = dl.t_sfcontrid \n",
"         and sf.t_number = vcontrnumber \n",
"      union all \n",
"      select sf_mp.t_id, sf_mp.t_partyid, sf_mp.t_number \n",
"        from dsfcontr_dbt sf, ddlcontr_dbt dl, ddlcontrmp_dbt mp, dsfcontr_dbt sf_mp \n",
"       where sf.t_id = dl.t_sfcontrid \n",
"         and mp.t_dlcontrid = dl.t_dlcontrid \n",
"         and mp.t_sfcontrid = sf_mp.t_id \n",
"         and sf.t_number = vcontrnumber ) loop \n",

"      /* клиент в договоре/субдоговоре*/ \n",
"      update dsfcontr_dbt set t_partyid = vnew_partyid \n",
"       where t_id = datax.t_id; \n",
"      for ssix in ( \n",
"         SELECT settacc.t_settaccid, settacc.t_fiid, settacc.t_account, settacc.t_chapter \n",
"           FROM dsfssi_dbt ssi, dsettacc_dbt settacc \n",
"          WHERE ssi.t_objecttype = 659 \n",
"            AND ssi.t_setaccid = settacc.t_settaccid \n",
"            AND ssi.t_objectid = lpad(datax.t_id,10,'0') ) loop \n",

"         /* клиент в СПИ*/ \n",
"         update dsettacc_dbt set t_partyid = vnew_partyid \n",
"          where t_settaccid = ssix.t_settaccid \n",
"            and t_partyid = vold_partyid; \n",

"         for accx in ( \n",
"            select t_accountid from daccount_dbt acc \n",
"             where ssix.t_account = acc.t_account AND ssix.t_chapter = acc.t_chapter AND ssix.t_fiid = acc.t_code_currency \n",
"         ) LOOP \n",

"            /* клиент в счете 306* */ \n",
"            update daccount_dbt set t_client = vnew_partyid \n",
"             where t_accountid = accx.t_accountid \n",
"               and t_client = vold_partyid; \n", 

"         end loop; \n",
         
"         for pmx in ( \n",
"            select t_settaccid, t_partyid, t_order \n",
"             from dpmautoac_dbt \n",
"            where t_partyid = vold_partyid \n",
"              and t_settaccid = ssix.t_settaccid) LOOP \n",

"            update dpmautoac_dbt set t_partyid = vnew_partyid \n",
"             where t_settaccid = pmx.t_settaccid and t_partyid = pmx.t_partyid and t_order = pmx.t_order \n",
"               and t_partyid = vold_partyid; \n",

"         end loop; \n",

"      end loop; \n",

"      for mcaccx in ( \n",
"         select t_id, t_Chapter, t_account, t_currency \n",
"           from dmcaccdoc_dbt accd \n",
"          where accd.t_ClientContrID = datax.t_id \n",
"            and accd.t_owner = datax.t_partyid \n",
"         ) loop \n",

"         /* клиент в счетах ВУ */ \n",
"         update dmcaccdoc_dbt set t_owner = vnew_partyid \n",
"          where t_id = mcaccx.t_id \n",
"            and t_owner = vold_partyid; \n",

"         for accx in ( \n",
"            select t_accountid from daccount_dbt acc \n",
"             where mcaccx.t_account = acc.t_account AND mcaccx.t_chapter = acc.t_chapter AND mcaccx.t_currency = acc.t_code_currency \n",
"         ) LOOP \n",

"            update daccount_dbt set t_client = vnew_partyid \n",
"            where t_accountid = accx.t_accountid \n",
"              and t_client =  vold_partyid; \n",

"         end loop; \n",

"      end loop; \n",

"   end loop; \n",

"   commit; \n",

"end; ");

   cmd = RSDCommand(sql_str);
   cmd.AddParam("pold_code", RSDBP_IN, pold_code);
   cmd.AddParam("pnew_code", RSDBP_IN, pnew_code);
   cmd.AddParam("pcontractnumber", RSDBP_IN, pcontractnumber);
   cmd.execute;
   cmd.close;
end;

macro CreateClient(pold_code, pnew_code, pcontractnumber, pname);
   var sql_str, cmd, rs;
   var new_client;
   var stat;
   var partyid = 0;
   
   sql_str = "select t_objectid from dobjcode_dbt where t_objecttype = 3 and t_codekind = 101 and t_state = 0 and t_code = :pnew_code;";
   cmd = RSdCommand(sql_str);
   cmd.AddParam("pnew_code", RSDBP_IN, pnew_code);
   rs = RSDRecordSet(cmd);
   if (rs.movenext)
      partyid = rs.value("t_objectid");
   else 
      new_client = RSBParty();
      new_client.LegalForm = 2;
      new_client.LastName = pname;
      new_client.FirstName = "А";
      new_client.Patronymic = "А";
      new_client.ShortName = new_client.LastName + " " + substr(new_client.FirstName, 1, 1) + ". " + substr(new_client.Patronymic, 1, 1) + ".";
      new_client.FullName  = new_client.LastName + " " +        new_client.FirstName        + " "  +        new_client.Patronymic             ;

      new_client.Code.SetCode(1, pnew_code);
      new_client.Code.SetCode(101, pnew_code);
      
      stat = new_client.Update();
      if(not stat)
         RunError("Ошибка сохранения субъекта");
      end;
      partyid = new_client.partyid;
   end;
  
   DoIt(pold_code, pnew_code, pcontractnumber);

end;

macro PutServKind(pcontractnumber)
   var sql_str, cmd, rs, stat;

   sql_str =" select distinct mp_sf.t_servkind, sf.t_datebegin, sf.t_partyid "+
            "   from dsfcontr_dbt sf, ddlcontr_dbt dl, ddlcontrmp_dbt mp, dsfcontr_dbt mp_sf "+
            "  where sf.t_number = :pcontractnumber "+
            "    and dl.t_sfcontrid = sf.t_id "+
            "    and dl.t_dlcontrid = mp.t_dlcontrid "+
            "    and mp.t_sfcontrid = mp_sf.t_id ";
   cmd = RSdCommand(sql_str);
   cmd.AddParam("pcontractnumber", RSDBP_IN, pcontractnumber);
   rs = RSDRecordSet(cmd);
   while (rs.movenext)
      stat = PT_BindClientWithBranch(rs.value("t_partyid"), rs.value("t_servkind"), 1, NULL, date(rs.value("t_datebegin")));
      if(not stat)
         RunError("Ошибка установки вида обслуживания "+rs.value("t_servkind")+" при открытии ЕД БО "+pcontractnumber);
      end;
   end;
end;


/*CreateClient("404340889932", "609868814864", "62/67-19439669", "Сафина");
CreateClient("165288435966", "565652658237", "63-18985486", "Корчагин");
CreateClient("208195580667", "544853282707", "63-18744869", "Киреев");
CreateClient("526234118228", "526256620921", "75/06-19439128", "Репп");
CreateClient("609640553859", "527194719272", "35/62-19438835", "Худорбаева");
CreateClient("601195530889", "541403391552", "01-18712156", "Филисов"); 

PutServKind("62/67-19439669");
PutServKind("63-18985486");
PutServKind("63-18744869");
PutServKind("75/06-19439128");
PutServKind("35/62-19438835");
PutServKind("01-18712156");  */

CreateClient("430885755055", "602274509639", "63/63-19381021", "Крапивина");
CreateClient("454648355734", "609661874952", "63/57-19438930", "Черносвитова");

PutServKind("63/63-19381021");
PutServKind("63/57-19438930");


end;
