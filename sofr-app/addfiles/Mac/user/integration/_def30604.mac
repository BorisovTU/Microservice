//DEF-30604
// Выгрузка закрытых договоров и площадок

import rsd;

var sql_str, rs, cmd;

sql_str = 
" begin "+
"  insert into utableprocessevent_dbt "+
"     (t_timestamp, t_objecttype, t_objectid, t_type, t_status, t_note, t_oper ) "+
"  select sysdate, 5026, s.t_partyid, 1, 1, 'Событие закрытия для старого договора DEF-30604', 1 "+
"    from dsfcontr_dbt s "+
"   where t_dateclose != to_date('01010001','ddmmyyyy') "+
"    and not exists (select 1 from dobjatcor_dbt o "+
"                     where o.t_objecttype = 3 and o.t_object = lpad(s.t_partyid, 10,'0') and o.t_groupid = 170 "+
"                      and o.t_attrid = 1 and o.t_validfromdate >= s.t_dateclose) "+
"    and exists (select 1 from dobjatcor_dbt o "+
"                 where o.t_objecttype = 3 and o.t_object = lpad(s.t_partyid, 10,'0') and o.t_groupid = 170 "+
"                   and o.t_attrid = 1 and o.t_validfromdate < s.t_dateclose) "+
"    and not exists (select 1 from utableprocessevent_dbt u "+
"                     where u.t_objecttype = 5026 and u.t_objectid = s.t_partyid and t_timestamp >= s.t_dateclose) "+
"    and s.t_servkind = 0; "+
"  insert into utableprocessevent_dbt "+
"     (t_timestamp, t_objecttype, t_objectid, t_type, t_status, t_note, t_oper, t_param ) "+
"  select sysdate, 5026, s.t_partyid, 3, 1, 'Событие закрытия для старого договора DEF-30604', 1, mp.t_dlcontrid "+
"    from dsfcontr_dbt s, ddlcontrmp_dbt mp, ddlcontr_dbt dl, dsfcontr_dbt sf1 "+
"   where s.t_dateclose != to_date('01010001','ddmmyyyy') and  s.t_dateclose < sf1.t_dateclose "+
"     and mp.t_sfcontrid = s.t_id and mp.t_dlcontrid = dl.t_dlcontrid and sf1.t_id = dl.t_sfcontrid "+
"     and not exists (select 1 from dobjatcor_dbt o "+
"                      where o.t_objecttype = 3 and o.t_object = lpad(s.t_partyid, 10,'0') and o.t_groupid = 170 "+
"                        and o.t_attrid = 1 and o.t_validfromdate >= s.t_dateclose) "+
"     and exists (select 1 from dobjatcor_dbt o "+
"                  where o.t_objecttype = 3 and o.t_object = lpad(s.t_partyid, 10,'0') and o.t_groupid = 170 "+
"                    and o.t_attrid = 1 and o.t_validfromdate < s.t_dateclose) "+
"     and not exists (select 1 from utableprocessevent_dbt u "
"                      where u.t_objecttype = 5026 and u.t_objectid = s.t_partyid and t_timestamp >= s.t_dateclose); "+
" end; ";

cmd = RSDCommand(sql_str);
cmd.execute;