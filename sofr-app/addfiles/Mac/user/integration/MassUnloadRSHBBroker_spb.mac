/* BIQ-7041
MassUnloadRSHBBroker_spb

СОФР должен отобрать действующие договоры с признаком выгрузки клиента в QUIK и РСХБ-Брокер, проставленным UID и типом авторизации "двухфакторная авторизация" и попадающие под открытие торговой площадки на СПБ и выгрузить обновление данных по таким договорам. 


*/
import usp_import;
import dlcontrfunc;

   private var DSN, USER, PASSWORD;
   private var CV_ODBS_CONSTRING;

   var flag_spb = false;
   var SpbDate = "";
   var reg_value;
   
   const REG_SPB = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ДАТА ВКЛЮЧЕНИЯ СПБ";
   const REG_TRADEACCOUNT_MMVB_DEFAULT = "РСХБ\\ИНТЕГРАЦИЯ\\РСХБ-БРОКЕР\\ММВБ";
   const REG_TRADEACCOUNT_SPB_DEFAULT = "РСХБ\\ИНТЕГРАЦИЯ\\РСХБ-БРОКЕР\\СПБ";

   GetRegistryValue("РСХБ\\ИНТЕГРАЦИЯ\\INTEGR_SERV_PRM\\RSHBBROKER\\DSN", V_STRING, DSN);
   GetRegistryValue("РСХБ\\ИНТЕГРАЦИЯ\\INTEGR_SERV_PRM\\RSHBBROKER\\USER", V_STRING, USER);
   GetRegistryValue("РСХБ\\ИНТЕГРАЦИЯ\\INTEGR_SERV_PRM\\RSHBBROKER\\PASSWORD", V_STRING, PASSWORD);

   CV_ODBS_CONSTRING = "dsn="+DSN+";user id="+USER+";password="+PASSWORD;

   env = RsdEnvironment("RDDrvO","RDDrvO.dll");
   con = RsdConnection(env,CV_ODBS_CONSTRING);
   

macro RunUsp(_cMap)

   private var v_logger_obj;    /* Объект для работы с журналом */
   private var v_log_id;        /* Идентификатор записи в журнале (если требуется что-то добавить) */
   var sql_str_env, cmd_env;

      sql_str_env = String(" EXEC [dbo].[usp_ImportTradeAccountMap]                  \n"+
                           "   @Account       = "+m_GetSQLString(_cMap.Account)     +", \n"+
                           "   @TradeFloor    = "+m_GetSQLString(_cMap.TradeFloor)  +", \n"+
                           "   @TradeAccount  = "+m_GetSQLString(_cMap.TradeAccount));                              

      v_logger_obj = uws_exchng_logger(null, null, NULL, "usp_ImportTradeAccountMap", modulename(), NULL, sql_str_env);
      v_log_id = v_logger_obj.get_log_id();

      sql_str_env = ToAnsi(sql_str_env,true);
      cmd_env = RsdCommand(con,sql_str_env);
      cmd_env.execute;
      cmd_env.close;

      v_logger_obj.add_response(null, null, null, v_log_id);
      v_logger_obj.add_error_info(0, "OK");

      v_logger_obj = NULL;
      v_log_id = NULL;
onError(er)
   var env_error = "", i = 0;

   while( i < env.ErrorCount)
      env_error = env_error + env.Error(i).Descr + " ";
      i = i+1;
   end;
   env.ClearErrors();
   env_error = ToOEM (env_error, true);
   if (not env_error)
      env_error = er.message;
   end;

   if (ValType(v_logger_obj) == V_UNDEF)
      v_logger_obj = uws_exchng_logger(null, null, NULL, "usp_ImportTradeAccountMap", modulename(), NULL, " ");
      v_log_id = v_logger_obj.get_log_id();
   end;

   v_logger_obj.add_response(env_error, null, null, v_log_id);
   v_logger_obj.add_error_info(-1001, env_error);

   v_logger_obj = NULL;
   v_log_id = NULL;


end;

macro RunCtpt(_cCtpt)
   private var v_logger_obj;    /* Объект для работы с журналом */
   private var v_log_id;        /* Идентификатор записи в журнале (если требуется что-то добавить) */
   var sql_str_env, cmd_env;

         sql_str_env = String(" EXEC [dbo].[usp_ImportCtptFromExcel]                  \n"+
                              "   @Client     = "+m_GetSQLString(_cCtpt.Client)      +", \n"+
                              "   @ClientName = "+m_GetSQLString(_cCtpt.ClientName)  +", \n"+
                              "   @Account    = "+m_GetSQLString(_cCtpt.Account)     +", \n"+
                              "   @IsStrategy = "+_cCtpt.IsStrategy                +", \n"+
                              "   @ClientData = "+m_GetSQLString(_cCtpt.ClientData)  +", \n"+
                              "   @Action     = "+_cCtpt.Action);

         v_logger_obj = uws_exchng_logger(null, null, NULL, "usp_ImportCtptFromExcel", modulename(), NULL, sql_str_env);
         v_log_id = v_logger_obj.get_log_id();

         sql_str_env = ToAnsi(sql_str_env,true);
         cmd_env = RsdCommand(con,sql_str_env);
         cmd_env.execute;
         cmd_env.close;

         v_logger_obj.add_response(null, null, null, v_log_id);
         v_logger_obj.add_error_info(0, "OK");

         v_logger_obj = NULL;
         v_log_id = NULL;
onError(er)
   var env_error = "", i = 0;

   while( i < env.ErrorCount)
      env_error = env_error + env.Error(i).Descr + " ";
      i = i+1;
   end;
   env.ClearErrors();
   env_error = ToOEM (env_error, true);
   if (not env_error)
      env_error = er.message;
   end;

   if (ValType(v_logger_obj) == V_UNDEF)
      v_logger_obj = uws_exchng_logger(null, null, NULL, "usp_ImportCtptFromExcel", modulename(), NULL, " ");
      v_log_id = v_logger_obj.get_log_id();

   end;

   v_logger_obj.add_response(env_error, null, null, v_log_id);
   v_logger_obj.add_error_info(-1001, env_error);

   v_logger_obj = NULL;
   v_log_id = NULL;

end;

macro usp_ImportUsersClasses_mass(plogin_user, pspb)
   private var v_logger_obj;    /* Объект для работы с журналом */
   private var v_log_id;        /* Идентификатор записи в журнале (если требуется что-то добавить) */

   var sql_str_env, cmd_env;


   if (pspb)
      sql_str_env = String(" EXEC [dbo].[usp_ImportUsersClasses]              \n"+
                           "   @Login     = "+m_GetSQLString(plogin_user) +", \n"+
                           "   Classes    = 'SPBXM, SPBDE, SPBFUT, SPBOTC'   ");

      v_logger_obj = uws_exchng_logger(null, null, NULL, "usp_ImportUsersClasses", modulename(), NULL, sql_str_env);
      v_log_id = v_logger_obj.get_log_id();

      cmd_env = RsdCommand(con,sql_str_env);
      cmd_env.execute;
      cmd_env.close;

      v_logger_obj.add_response(null, null, null, v_log_id);
      v_logger_obj.add_error_info(0, "OK");

      v_logger_obj = NULL;
      v_log_id = NULL;
   end;
   
onError(er)
   var env_error = "", i = 0;

   while( i < env.ErrorCount)
      env_error = env_error + env.Error(i).Descr + " ";
      i = i+1;
   end;
   env.ClearErrors();
   env_error = ToOEM (env_error, true);
   if (not env_error)
      env_error = er.message;
   end;

   if (ValType(v_logger_obj) == V_UNDEF)
      v_logger_obj = uws_exchng_logger(null, null, NULL, "usp_ImportUsersClasses", modulename(), NULL, " ");
      v_log_id = v_logger_obj.get_log_id();

   end;

   v_logger_obj.add_response(env_error, null, null, v_log_id);
   v_logger_obj.add_error_info(-1001, env_error);

   v_logger_obj = NULL;
   v_log_id = NULL;
end;


macro usp_UpdateUserIsRegisteredOnSpb_mass(plogin_user, pspb)
   private var v_logger_obj;    /* Объект для работы с журналом */
   private var v_log_id;        /* Идентификатор записи в журнале (если требуется что-то добавить) */

   var sql_str_env, cmd_env;


   if (pspb)
      sql_str_env = String(" EXEC [rshb].[usp_UpdateUserIsRegisteredOnSpb]              \n"+
                           "   @Login     = "+m_GetSQLString(plogin_user) +", \n"+
                           "   @IsRegisteredOnSpb = '1'   ");
      v_logger_obj = uws_exchng_logger(null, null, NULL, "usp_UpdateUserIsRegisteredOnSpb", modulename(), NULL, sql_str_env);
      v_log_id = v_logger_obj.get_log_id();

      cmd_env = RsdCommand(con,sql_str_env);
      cmd_env.execute;
      cmd_env.close;

      v_logger_obj.add_response(null, null, null, v_log_id);
      v_logger_obj.add_error_info(0, "OK");

      v_logger_obj = NULL;
      v_log_id = NULL;
   end;
   
onError(er)
   var env_error = "", i = 0;

   while( i < env.ErrorCount)
      env_error = env_error + env.Error(i).Descr + " ";
      i = i+1;
   end;
   env.ClearErrors();
   env_error = ToOEM (env_error, true);
   if (not env_error)
      env_error = er.message;
   end;

   if (ValType(v_logger_obj) == V_UNDEF)
      v_logger_obj = uws_exchng_logger(null, null, NULL, "usp_UpdateUserIsRegisteredOnSpb", modulename(), NULL, " ");
      v_log_id = v_logger_obj.get_log_id();

   end;

   v_logger_obj.add_response(env_error, null, null, v_log_id);
   v_logger_obj.add_error_info(-1001, env_error);

   v_logger_obj = NULL;
   v_log_id = NULL;
end;


class c_usp_ImportCtptFromExcel_mass
   var Client        : string;      // Идентификатор договора во внешней системе  Да
   var ClientName    : string;      // Наименование договора  Да
   var Account       : string;      // Счет, как правило используется код клиента на бирже  Да
   var AccountName   : string;      // Наименование счета. Не заполняем  Нет
   var Branch        : string;      // Филиал, в котором открыт счет. Не заполняем  Нет
   var BranchName    : string;      // Название филиала для отображения в отчетах. Не заполняем  Нет
   var IsStrategy    : integer;     // Да	Признак того является ли данный счет стратегией. 0 - Клиентский счет 1 - Стратегия. Константа = 0  Да ?
   var ClientData    : string;      // Дополнительные параметры клиента, которые могу использоваться в программе  Да
   var Action        : integer;     // Действие со счетом. 0 - удаляем счет, 1 - добавляем счет, 2 - делаем счет неактивным для торгов. Константа = 1  Да
end;

macro execMassUnloadRSHBBroker_spb()
   var cMap;
  
   var sql_str, rs, cmd;
   var acc_main, acc;
   var notes;
   var ErrCode;
   var num_rows=0, cnt=0;

   var old, cCtpt;
   var IIS, phone,email;
   var partyid, spb;
   
   var marketid_spb = ПолучитьБиржуПоВидуКодаДБО(DLCCK_SPB_BIDCODE); 
   var marketid_mmvb = ПолучитьБиржуПоВидуКодаДБО(DLCCK_USC); 
   var Mmvb_Default, spb_default;
   
   reg_value = GetRegistryValue (REG_SPB, V_STRING, SpbDate);
   if (ValType(reg_value) != V_UNDEF)
      if ((SpbDate != "00.00.0000") and ({curdate} >= date(SpbDate)))
         flag_spb = true;
      end;
   end;

   if( not flag_spb )
      msgbox("Настройка "+REG_SPB+" не найдена или не соответствует текущей дате, выгрузка не производится");
      return;
   end;
   
   GetRegistryValue(REG_TRADEACCOUNT_MMVB_DEFAULT, V_STRING, Mmvb_Default, ErrCode);
   if( ( ErrCode > 0 ) or (not Mmvb_Default) )
      RunError("Не задано значение по умолчанию "+REG_TRADEACCOUNT_MMVB_DEFAULT);
   end;
   
   GetRegistryValue(REG_TRADEACCOUNT_SPB_DEFAULT, V_STRING, spb_default, ErrCode);
   if( ( ErrCode > 0 ) or (not spb_default) )
      RunError("Не задано значение по умолчанию "+REG_TRADEACCOUNT_SPB_DEFAULT);
   end;
   
   var p_edp = true;

   // по всем открытым площадкам по бирже Спб
   // двухфакторная аутентификация договора БО
   // была успешная выгрузка в РСХБ-Брокер
   sql_str = "SELECT dl.t_dlcontrid dl_id, cntr.t_number, cntr.t_name, dl.t_iis, cntr.t_partyid , "+
             "       cntr_mp.t_id cntr_id,  cntr_mp.t_servkind, cntr_mp.t_servkindsub, mp.t_id mp_id, mp.t_mpcode, "+
             "       nvl((select mp2.t_mpcode from ddlcontrmp_dbt mp2, dsfcontr_dbt cntr_mp2  where dl.t_dlcontrid = mp2.t_dlcontrid "+
             "             AND cntr_mp2.t_id = mp2.t_sfcontrid AND mp2.t_mpclosedate = to_date('01.01.0001','dd.mm.yyyy') "+
             "             AND cntr_mp2.t_servkind = 1 and cntr_mp2.t_servkindsub = 8 and mp2.t_marketid = :marketid2 ),mp.t_mpcode) mmvb "
             "  FROM dsfcontr_dbt cntr, "+
             "       ddlcontr_dbt dl, "+
             "       ddlcontrmp_dbt mp, "+
             "       dsfcontr_dbt cntr_mp "+
             "WHERE dl.t_sfcontrid = cntr.t_id "+
             "  AND dl.t_dlcontrid = mp.t_dlcontrid "+
             "  AND cntr_mp.t_id = mp.t_sfcontrid "+
             "  AND cntr.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') "+
             "  AND cntr_mp.t_servkind = 1 and cntr_mp.t_servkindsub = 8 "+
             "  AND mp.t_mpclosedate = to_date('01.01.0001','dd.mm.yyyy') and mp.t_marketid = :marketid"+
             "  AND exists (select 1 from dobjatcor_dbt o where o.t_objecttype = 207 and o.t_groupid = 170 "+
             "                 and o.t_attrid = 2 and (o.t_validtodate >= :dt or o.t_validtodate = to_date('01.01.0001','dd.mm.yyyy')) "+
             "                 and lpad(dl.t_dlcontrid,34,'0') = o.t_object ) "+
             "   and exists (select 1 from dobjatcor_dbt o where o.t_objecttype = 3 and o.t_groupid = 170 "+
             "                  and o.t_attrid = 1 and (o.t_validtodate >= :dt or o.t_validtodate = to_date('01.01.0001','dd.mm.yyyy')) "+
             "                  and lpad(cntr.t_partyid,10,'0') = o.t_object) ";
   var sql_str2 = "select count(*) from ("+sql_str+")";
   cmd = RSDCommand(sql_str2);
   
   cmd.AddParam("marketid2", RSDBP_IN, marketid_mmvb);
   cmd.AddParam("marketid", RSDBP_IN, marketid_spb);
   cmd.AddParam("dt1", RSDBP_IN, date());
   cmd.AddParam("dt2", RSDBP_IN, date());
   rs = RSDRecordSet(cmd );
   if (rs.movenext )
      num_rows = Int(rs.value(0));
   end;
   rs.close; cmd.close; rs = null; cmd = null;

   cmd = RSDCommand(sql_str);
   cmd.AddParam("marketid2", RSDBP_IN, marketid_mmvb);
   cmd.AddParam("marketid", RSDBP_IN, marketid_spb);
   cmd.AddParam("dt1", RSDBP_IN, date());
   cmd.AddParam("dt2", RSDBP_IN, date());
   rs = RSDRecordSet(cmd );

   InitProgress(num_rows);

   while (rs.movenext)
      cCtpt = c_usp_ImportCtptFromExcel_mass;

      if (rs.value("t_iis") == "X")
         IIS = 1;
      else
         IIS = 0;
      end;

      cCtpt.Client        = rs.value("t_number");
      cCtpt.ClientName    = rs.value("t_number");
      cCtpt.Account       = rs.value("mmvb");
      cCtpt.AccountName   = NULL;
      cCtpt.Branch        = NULL;
      cCtpt.BranchName    = NULL;
      cCtpt.IsStrategy    = 0;

 /*     if (p_edp)
         cCtpt.Account = "edp"+cCtpt.Account;
      end;*/

      phone = getContact(rs.value("t_partyid"), CV_CONTACT_KIND_PHONE, CV_CONTACT_TYPE_MOBILE);
      email = getContact(rs.value("t_partyid"), CV_CONTACT_KIND_EMAIL, CV_CONTACT_TYPE_REPORT);

      cCtpt.ClientData    = "<Fields AgreementNo=\""+rs.value("t_number")+"\" Phone=\""+Phone+"\" Email=\""+Email
                                +"\" MasterId=\""+rs.value("t_partyid")+"\" IIS=\""+IIS+"\" />";
      cCtpt.Action        = 1;
      
      
old = SetDialogFlag(0);
         RunCtpt(cCtpt);
SetDialogFlag(old);

      acc_main = c_usp_ImportTradeAccountMap_mp;
      acc_main.account = rs.value("mmvb");
      acc_main.ClientCode = rs.value("mmvb");
      acc_main.TradeFloor = "КЦБ ММВБ";
      acc_main.AccType = "other";
      acc_main.TradeAccount = Mmvb_Default;
      acc_main.Firm =  "MC0134700000";

      acc = c_usp_ImportTradeAccountMap_mp;
      acc.account = rs.value("t_mpcode");
      acc.ClientCode = rs.value("t_mpcode");
      acc.TradeFloor = "СПБ(USD)";
      acc.AccType = "spb";
      acc.TradeAccount = SPB_Default;
      acc.Firm =  "MC0134700000";

      cMap = c_usp_ImportTradeAccountMap(acc_main, p_edp, acc);
old = SetDialogFlag(0);
      RunUsp(cMap);
//      usp_ImportUsersClasses_mass(rs.value("t_partyid"), true);
      usp_UpdateUserIsRegisteredOnSpb_mass(rs.value("t_partyid"), true);
SetDialogFlag(old);

      cMap = NULL;
      acc_main = NULL; acc = NULL;
      cnt = cnt+1;
      UseProgress(cnt);
   end;
   RemProgress();

   return true;

end;