/** 
 @file BIQ10268_unloadClients.mac
 @brief Начальное решение по BIQ-10268. Выгрузка клиентов
  
 # tag 
 - functional_block:Клиенты_Регистрация_на_бирже
 - code_type:GUI
 - CDI

   
 # changeLog 
 |date       |author         |tasks            |note                            
 |-----------|---------------|-----------------|--------------------------------
 |27.11.2023 |Гераськина Т.В.|BIQ-10268        | Создание
 |23.01.2024 |Гераськина Т.В.|DEF-59144        | Изменен формат данных
 |13.02.2024 |Гераськина Т.В.|DEF-59144        | Добавлен файл ext_id_org

*/ 

import rsd;
import cb_sql;
import func_lib;
import CdiUpdateOrgReq;
import CDIOrg_lib;

/* Здесь полный список файлов, но заполняются только 4 вида: сами клиенты, коды ОКВЭД, адреса и контакты */
   var filename_party_org                       = "..\\TxtFile\\party_org.csv";
//   var filename_rel_branch_org2party_org        = "..\\TxtFile\\rel_branch_org2party_org.csv";
   var filename_address_org                     = "..\\TxtFile\\address_org.csv";
   var filename_contact_org                     = "..\\TxtFile\\contact_org.csv";
//   var filename_rel_bank_rel_org2party_org      = "..\\TxtFile\\rel_bank_rel_org2party_org.csv";
//   var filename_rel_verification_org2party_org  = "..\\TxtFile\\rel_verification_org2party_org.csv";
//   var filename_rel_group_org2party_org         = "..\\TxtFile\\rel_group_org2party_org.csv";
   var filename_rel_okved_org2party_org         = "..\\TxtFile\\rel_okved_org2party_org.csv";
//   var filename_rel_state_org2party_org         = "..\\TxtFile\\rel_state_org2party_org.csv";
//   var filename_rel_license_org2party_org       = "..\\TxtFile\\rel_license_org2party_org.csv";
   var filename_ext_id_org                      = "..\\TxtFile\\ext_id_org.csv";

/**
@brief Преобразование даты в формат YYYY-MM-DD
@param[in] value Дата
@return Строка YYYY-MM-DD
*/
private macro ConvertDate(value): String
   var year, mon, day;
   var res = "1911-11-11";
   var tm;
   
   if (ValType(value) == V_UNDEF)
      res = "1911-11-11";
   else 
      if (ValType(value) == V_DTTM)
         DtTmSplit (value, value, tm);
      end;

      if (ValType(value) == V_DATE)
         DateSplit(value, day, mon, year);
         if ( (year == 1) and (mon == 1) and (day == 1) )
            res = "1911-11-11";
         else 
            res = String(year) +"-"+ String(mon:o:2) +"-"+ String(day:o:2);
         end;
      end;
   end;
      
   return res;
end;

/**
@brief Создать или открыть файл
@param[in] filename Полное имя файла
@param[in] fileheader Заголовок файла
@return объект TStreamDoc
*/
macro MakeOrOpenFile(filename, fileheader)
   var make_new_file = true;
   var DL, FS;
   
   DL = TDirList(filename, "F");
   if (DL.Count == 0)               // файлов нет
      make_new_file = true;
   else 
      if (Gettrue(false, "Найден файл "+filename+". Очистить содержимое?"))
         make_new_file = true;
      else 
         make_new_file = false;
      end;
   end;

   if (make_new_file)
      FS = TStreamDoc(filename, "C", "rsansi"); 
      FS.WriteLine( fileheader );
   else 
      FS = TStreamDoc(filename, "A", "rsansi"); 
   end;

   return FS;
end;

/**
@brief Основная процедура выгрузки

Создает файлы *.csv в директории TxtFiles
*/
macro RunReport()
   var sql_str, rs, cmd;
   var sql_str2, cmd2, rs2;
   var data_str;
   var CountContr = 0, batch_id = 0;
   var req;
   var stat = true;
   var temp_value;
   var FS_party;  
   var FS_okved;  
   var FS_adres;  
   var FS_contact;
   var FS_extid;
   var ContactKind, ContactType;

println(time() + " Начало");
   
   sql_str = "select count(*) from biq10268_unload";
   rs = RSDRecordSet(sql_str);
   if (rs.movenext)
      CountContr = rs.value(0);
      if ( CountContr> 0 )
         if (Gettrue(false, "Во временной таблице уже есть записи, очистить таблицу?"))
            sql_str2 = "begin execute immediate 'truncate table biq10268_unload'; end;";
            cmd2 = RSDCommand(sql_str2);
            cmd2.execute;
            cmd2.close;
         end;
      end;
   end;
   
   sql_str = "select biq10268_unload_seq.nextval from dual";
   rs = RSDRecordSet(sql_str);
   if (rs.movenext)
      batch_id = rs.value(0);
   end;
   
   sql_str = String(
" DECLARE                                                                          \n"+
"  vbatch number := :pbatch;                                                       \n"+
"  vobjt   number := :pobjecttype;                                                 \n"+
"  vgroup  number := :pgr;                                                         \n"+
"  vdate  date := :pdate;                                                          \n"+
"  vcatblockunload  number := :pcatblockunload;                                    \n"+
"  vcatblockunload_yes number := :pcatblockunload_yes;                             \n"+
"  vrec biq10268_unload%ROWTYPE;                                                   \n"+
"  vname varchar2(320);                                                            \n"+
"  vPartyType varchar2(20);                                                        \n"+
"  vlegalform number(5);                                                           \n"+
"   PROCEDURE split_inn_kpp (p_inn_kpp IN VARCHAR2,                                \n"+
"                            p_inn OUT VARCHAR2,                                   \n"+
"                            p_kpp OUT VARCHAR2)                                   \n"+
"   IS                                                                             \n"+
"      v_PosSeparator   INTEGER DEFAULT 0;                                         \n"+
"   BEGIN                                                                          \n"+
"      v_PosSeparator := INSTR (p_inn_kpp, '/');                                   \n"+
"                                                                                  \n"+
"      IF v_PosSeparator > 0                                                       \n"+
"      THEN                                                                        \n"+
"         p_INN := NVL (SUBSTR (p_inn_kpp, 0, v_PosSeparator - 1), CHR (1));       \n"+
"         p_KPP := NVL (SUBSTR (p_inn_kpp, v_PosSeparator + 1), CHR (1));          \n"+
"      ELSE                                                                        \n"+
"         p_INN := p_inn_kpp;                                                      \n"+
"         p_KPP := '~';                                                            \n"+
"      END IF;                                                                     \n"+
"   END;                                                                           \n"+
"BEGIN                                                                             \n"+
"  insert into biq10268_unload (t_partyid, t_timestamp, t_status, t_batchid, ShortNameOrg, FullNameOrg, ResidentTax, ResidenceCountry, OKPO, PartyStatus) \n"+
"  SELECT party.t_partyid, sysdate, 0, vbatch,                                                                                                            \n"+
"         party.t_shortname, party.t_name, decode(party.t_notresident,'X', 'NO','YES') notres,                                                            \n"+
"         decode(party.t_nrcountry, chr(1),'643','RUS','643',nvl((select t_codenum3 from dcountry_dbt where t_CodeLat3 = party.t_nrcountry),'~')) country, \n"+
"         t_OKPO,                                                                                                                                          \n"+
"         decode( (select count(1) from dpartyown_dbt po where po.t_partykind = 1 and po.t_partyid = party.t_partyid), 0, 'Lead', 'Client') partystatus    \n"+
"    FROM dparty_dbt party                                                                                               \n"+
"   WHERE ((party.t_legalform = 1 and party.t_locked = chr(0))                                                           \n"+
"      OR (party.t_legalform = 2 and                                                                                     \n"+
"           EXISTS (select 1 from dpersn_dbt pers where pers.t_personid = party.t_partyid and pers.t_isemployer = 'X' )) \n"+
"      OR (party.t_legalform = 2 and party.t_locked = chr(0) and                                                         \n"+
"           EXISTS (SELECT 1                                                                                             \n"+
"                     FROM dobjatcor_dbt  o,                                                   \n"+
"                          dobjattr_dbt a                                                      \n"+
"                    WHERE o.t_objecttype = vobjt                                              \n"+
"                      AND o.t_groupid = vgroup                                                \n"+
"                      AND o.t_object = LPAD (party.t_partyid, 10, '0')                        \n"+
"                      AND o.t_objecttype = a.t_objecttype                                     \n"+
"                      AND o.t_groupid = a.t_groupid                                           \n"+
"                      AND o.t_validfromdate <= vdate                                          \n"+
"                      AND o.t_validtodate > vdate                                             \n"+
"                      AND a.t_numinlist in ('IE','PP')) ) )                                   \n"+
//DEF-63879 исключены банки
"  AND not exists (select 1 from dpartyown_dbt b where b.t_partyid = party.t_partyid and b.t_partykind = "+PTK_BANK+")  \n"+
"  AND not exists (select 1 from biq10268_unload b where b.t_partyid = party.t_partyid)                                 \n"+
// CCBO-10810 исключение субъектов с категорией "Блокировать выгрузку в CDI"                                            \n"+
"  AND not exists (select 1 from dobjatcor_dbt bu                                                                       \n"+
"                   where bu.t_objecttype = vobjt                                                                       \n"+
"                     and bu.t_groupid = vcatblockunload and bu.t_attrid = vcatblockunload_yes                          \n"+
"                     and bu.t_validfromdate <= vdate and bu.t_validtodate > vdate                                      \n"+
"                     and bu.t_object = LPAD (party.t_partyid, 10, '0') );                                              \n"+
//удалить записи, если они случайно есть в таблице
"  delete from biq10268_unload b                                                                                        \n"+
"   where exists ( select 1 from dobjatcor_dbt bu                                                                       \n"+
"                   where bu.t_objecttype = vobjt                                                                       \n"+
"                     and bu.t_groupid = vcatblockunload and bu.t_attrid = vcatblockunload_yes                          \n"+
"                     and bu.t_validfromdate <= vdate and bu.t_validtodate > vdate                                      \n"+
"                     and bu.t_object = LPAD (b.t_partyid, 10, '0') );                                                  \n"+
"  vrec := null;                                                                               \n"+
"  for datax in (select b.*, rowid from biq10268_unload b where t_status = 0) loop             \n"+
"    /*наименования*/                                                                          \n"+
"    vrec.ShortNameOrgLat := '~';                                                              \n"+
"    vrec.FullNameOrgLat := '~';                                                               \n"+
"    vname := ' ';                                                                             \n"+
"    for pname in (SELECT t_Name, t_NameTypeID                                                 \n"+
"                    FROM dpartyname_dbt                                                       \n"+
"                   WHERE t_PartyID = datax.t_partyid                                          \n"+
"                      AND t_NameTypeID in (RSI_RSBPARTY.PTKN_LATSHORTNAME, RSI_RSBPARTY.PTKN_LATFULLNAME, RSI_RSBPARTY.PTKN_FOREIGNNAME)) loop \n"+
"      IF pname.t_NameTypeID = RSI_RSBPARTY.PTKN_LATSHORTNAME and length(pname.t_Name) > 1                                                      \n"+
"      THEN                                                                                                                                     \n"+
"        vrec.ShortNameOrgLat := pname.t_Name;                                                 \n"+
"      ELSIF pname.t_NameTypeID = RSI_RSBPARTY.PTKN_LATFULLNAME and length(pname.t_Name) > 1   \n"+
"      THEN                                                                                    \n"+
"        vrec.FullNameOrgLat := pname.t_Name;                                                  \n"+
"      ELSIF pname.t_NameTypeID = RSI_RSBPARTY.PTKN_FOREIGNNAME and length(pname.t_Name) > 1   \n"+
"      THEN                                                                                    \n"+
"        vname := pname.t_Name;                                                                \n"+
"      END IF;                                                                                 \n"+
"    end loop;                                                                                 \n"+
"    IF length(vrec.FullNameOrgLat)<= 1 and length(vname) > 1                                  \n"+
"    THEN                                                                                      \n"+
"      vrec.FullNameOrgLat := vname;                                                           \n"+
"    END IF;                                                                                         \n"+
"    /*капитал*/                                                                                     \n"+
"    BEGIN                                                                                           \n"+
"      select t_realcapital, (select t_iso_number from dfininstr_dbt where t_fiid = t_capitalfi) cur \n"+
"        into vrec.AuthorizedCapital, vrec.AuthorizedCapitalCurrency                                 \n"+
"        from dinstitut_dbt where t_partyid = datax.t_partyid;                                       \n"+
"    EXCEPTION                                                                                       \n"+
"      when no_data_found then                                                                       \n"+
"        vrec.AuthorizedCapital := '~';                                                              \n"+
"        vrec.AuthorizedCapitalCurrency := '~';                                                      \n"+
"    END;                                                                                            \n"+
"    /*коды*/                                                                                        \n"+
"    vrec.INN := '~';                                                                                \n"+
"    vrec.KPPRegistrationPlace := '~';                                                               \n"+
"    vrec.KIO := '~';                                                                                \n"+
"    vrec.OGRN := '~';                                                                               \n"+
"    vrec.OGRNRegistrationDate := '';                                                                \n"+
"    vrec.NonResidentRegistrationNumber := '~';                                                      \n"+
"    vrec.NonResidentRegistrationDate := '';                                                         \n"+
"    for codes in (select t_codekind, t_code, t_name, t_begindate from dRepPartyCodes_vw where t_partyid = datax.t_partyid) loop \n"+
"      if codes.t_codekind = 16 then                                                                                             \n"+
"        split_inn_kpp (codes.t_code, vrec.INN, vrec.KPPRegistrationPlace);                                                      \n"+
"      elsif codes.t_codekind = 62 then                                                              \n"+
"        vrec.KIO := codes.t_code;                                                                   \n"+
"      elsif codes.t_codekind = 27 then                                                              \n"+
"        vrec.OGRN := codes.t_code;                                                                  \n"+
"        vrec.OGRNRegistrationDate := codes.t_begindate;                                             \n"+
"      elsif codes.t_codekind = 33 then                                                              \n"+
"        vrec.NonResidentRegistrationNumber := codes.t_code;                                         \n"+
"        vrec.NonResidentRegistrationDate := codes.t_begindate;                                      \n"+
"      end if;                                                                                       \n"+
"    end loop;                                                                                       \n"+
"    /*категории*/                                                                                   \n"+
"    vrec.PartyType := null;                                                                         \n"+
"    vrec.OKFS := '~';                                                                               \n"+
"    vrec.OKOGU := '~';                                                                              \n"+
"    vrec.OKTMO := '~';                                                                              \n"+
"    vrec.OKATO := '~';                                                                              \n"+
"    vrec.OKOPF := '~';                                                                              \n"+
"    for cat in (select c.t_groupid, c.t_attrid, c.t_general, a.t_numinlist, a.t_nameobject, a.t_name, a.t_fullname, c.t_validfromdate, c.t_id \n"+
"                  from dobjatcor_dbt c                                                                                                        \n"+
"                  inner join DOBJATTR_DBT a                                                                                                   \n"+
"                     on a.t_groupid = c.t_groupid and  a.t_attrid = c.t_attrid  and  a.t_objecttype = c.t_objecttype \n"+
"                  where lpad(datax.t_partyid, 10, '0')=c.t_object and a.t_objecttype = vobjt                         \n"+
"                    and c.t_validtodate = to_date('31129999','ddmmyyyy') ) loop                                      \n"+
"      if cat.t_groupid = vgroup then                                                               \n"+
"        vrec.PartyType := cat.t_numinlist;                                                         \n"+
"      elsif cat.t_groupid = 27 then                                                                \n"+
"        vrec.OKFS := cat.t_numinlist;                                                              \n"+
"      elsif cat.t_groupid = 48 then                                                                \n"+
"        vrec.OKOGU := cat.t_numinlist;                                                             \n"+
"      elsif cat.t_groupid = 55 then                                                                \n"+
"        vrec.OKTMO := cat.t_numinlist;                                                             \n"+
"      elsif cat.t_groupid = 12 then                                                                \n"+
"        vrec.OKATO := cat.t_numinlist;                                                             \n"+
"      elsif cat.t_groupid = 53 then                                                                \n"+
"        vrec.OKOPF := replace(cat.t_nameobject,' ','');                                            \n"+
"        if Substr(cat.t_nameobject,1,4) = '5 01' then                                              \n"+
"           vPartyType := 'IE';                                                                     \n"+
"        elsif Substr(cat.t_nameobject,1,4) = '5 02' then                                           \n"+
"           vPartyType := 'PP';                                                                     \n"+
"        else                                                                                       \n"+
"           vPartyType := 'P';                                                                      \n"+
"        end if;                                                                                    \n"+
"      end if;                                                                                      \n"+
"    end loop;                                                                                      \n"+
"    if vrec.PartyType is null then                                                                 \n"+
"      /* не существует субъектов без формы*/                                                       \n"+
"      select t_legalform into vlegalform                                                           \n"+
"        from dparty_dbt p where p.t_partyid = datax.t_partyid;                                     \n"+
"      if vlegalform = 1 then                                                                       \n"+
"        vrec.PartyType := 'C';                                                                     \n"+
"      else                                                                                         \n"+
"        vrec.PartyType := vPartyType;                                                              \n"+
"      end if;                                                                                      \n"+
"    end if;                                                                                        \n"+
"    update biq10268_unload                                                                         \n"+
"       set ShortNameOrgLat = vrec.ShortNameOrgLat,                                                 \n"+
"            FullNameOrgLat = vrec.FullNameOrgLat,                                                  \n"+
"            AuthorizedCapital = vrec.AuthorizedCapital,                                            \n"+
"            AuthorizedCapitalCurrency = vrec.AuthorizedCapitalCurrency,                            \n"+
"            INN = vrec.INN,                                                                        \n"+
"            KPPRegistrationPlace = vrec.KPPRegistrationPlace,                                      \n"+
"            KIO = vrec.KIO,                                                                        \n"+
"            OGRN = vrec.OGRN,                                                                      \n"+
"            OGRNRegistrationDate = vrec.OGRNRegistrationDate,                                      \n"+
"            NonResidentRegistrationNumber = vrec.NonResidentRegistrationNumber,                    \n"+
"            NonResidentRegistrationDate = vrec.NonResidentRegistrationDate,                        \n"+
"            PartyType = vrec.PartyType,                                                            \n"+
"            OKFS = vrec.OKFS,                                                                      \n"+
"            OKOGU = vrec.OKOGU,                                                                    \n"+
"            OKTMO = vrec.OKTMO,                                                                    \n"+
"            OKATO = vrec.OKATO,                                                                    \n"+
"            OKOPF = vrec.OKOPF                                                                     \n"+
"    where rowid = datax.rowid;                                                                     \n"+
"  end loop;                                                                                        \n"+
"end;");

   BegAction(2000,"Заполнение таблицы...");
   cmd = RSDCommand(sql_str);
   cmd.AddParam("batch", RSDBP_IN, batch_id);
   cmd.AddParam("objt", RSDBP_IN, OBJTYPE_PARTY);
   cmd.AddParam("gr", RSDBP_IN, CONTRACT_CATEGORY_CDI_PARTYTYPE);
   cmd.AddParam("p_date1", RSDBP_IN, date());
   cmd.AddParam("pcatblockunload", RSDBP_IN, PARTY_CATEGORY_BLOCK_UNLOAD_CDI);
   cmd.AddParam("pcatblockunload_yes", RSDBP_IN, PARTY_CATEGORY_BLOCK_UNLOAD_CDI_YES);
   cmd.execute;
   EndAction();

   CountContr = 0;
   sql_str = " SELECT b.*, to_char(t_timestamp, 'yyyy-mm-dd hh24:mi:ss') sd, t_status, t_batchid, rowid "+
             "   FROM biq10268_unload b"+
             "  WHERE t_status = 0"
;

   rs = RSDRecordSet(sql_str);
   
println(time() + " Выгрузка в файл "+filename_party_org);
   InitProgress(-1);
   
   // party_org
   data_str =   "source_id|party_type|party_status|full_org_name|short_org_name|full_org_name_lat|short_org_name_lat|org_type|vip_flag|resident_cur_flag|resident_tax_flag|residence_country|problem_factor_flag|essential_problem_factor_flag|deal_problem_factor_flag|problem_flag|authorized_capital|authorized_capital_cur|employees_cnt|final_segment|gks_segments|individual_segment|responsibility_zone|separated_subjects|affiliation_to_projects_org|responsible_service|inn|kpp_reg_place|kpp_major_taxpayer|ogrn|kio|okpo|okfs|okogu|oktmo|okato|okopf|registration_date|liquidation_date|registration_number|ogrn_registration_date|flchp_registration_number|flchp_registration_date|flchp_registration_structure|nonresident_reg_num|nonresident_reg_date|strategic_org_flag|goz_client_flag|diasoft_category|self_regulating_company_flag|apk_exporter|ved_member|exporter_flag|importer_flag|mfh_flag|credit_history_subject_code|savings_acc|f302|batch_id|source_system|small_middle_org|gks_segment|main_var_reguation|change_type|change_date|main_solve_option|cdi_id|account_tag|org_type_name|okopf_ps|podft_form_create_date|podft_form_update_date|fatca_status_date|crs_status_date|fatca_status|crs_status";

   FS_party = MakeOrOpenFile(filename_party_org, data_str);
   
   // rel_okved_org2party_org
   data_str = "source_id|party_source_id|okved_source_id|main_flag|start_date|end_date|batch_id|source_system|change_type|change_date|okved_code|okved_name|okved_title";
   FS_okved = MakeOrOpenFile(filename_rel_okved_org2party_org, data_str);

   // address_org
   data_str = "source_id|party_source_id|address_type|address_line|country|postal_code|region_name|region_type|area_name|area_type|city_name|city_type|place_name|place_type|structure_name|structure_type|street_name|street_type|house|hcase|block|liter|flat|main_address_flag|oktmo|fias_guid|kladr_id|description|batch_id|source_system|change_type|change_date";
   FS_adres = MakeOrOpenFile(filename_address_org, data_str);
   
   // contact_org
   data_str = "source_id|party_source_id|contact_value|contact_type_det|main_contact_flag|active_flag|status|comment|contact_type|batch_id|source_system|change_type|change_date";
   FS_contact = MakeOrOpenFile(filename_contact_org, data_str);

   // ext_id_org
   data_str = "source_id|party_source_id|ext_source_system_name|ext_party_source_id|cio_ext_party_source_id|exp_ext_party_source_id|ext_source_system|start_date|end_date|active_flag|batch_id|source_system|change_type|change_date";
   FS_extid = MakeOrOpenFile(filename_ext_id_org, data_str);

   if ( stat )
      while (rs.movenext())
         data_str = "";
         data_str = rs.value("t_partyid")+"|";                                      //source_id
         data_str = data_str+rs.value("PartyType")+"|";                             //party_type
         data_str = data_str+rs.value("PartyStatus")+"|";                           //party_status
         data_str = data_str+rs.value("FullNameOrg")+"|";                           //full_org_name
         data_str = data_str+rs.value("ShortNameOrg")+"|";                          //short_org_name
         data_str = data_str+rs.value("FullNameOrgLat")+"|";                        //full_org_name_lat
         data_str = data_str+rs.value("ShortNameOrgLat")+"|";                       //short_org_name_lat
         data_str = data_str+"NULL|";                                               //org_type
         data_str = data_str+"NULL|";                                               //vip_flag
         data_str = data_str+"NULL|";                                               //resident_cur_flag
         data_str = data_str+rs.value("ResidentTax")+"|";                           //resident_tax_flag
         data_str = data_str+rs.value("ResidenceCountry")+"|";                      //residence_country
         data_str = data_str+"NULL|";                                               //problem_factor_flag
         data_str = data_str+"NULL|";                                               //essential_problem_factor_flag
         data_str = data_str+"NULL|";                                               //deal_problem_factor_flag
         data_str = data_str+"NULL|";                                               //problem_flag
         data_str = data_str+rs.value("AuthorizedCapital")+"|";                     //authorized_capital
         data_str = data_str+rs.value("AuthorizedCapitalCurrency")+"|";             //authorized_capital_cur
         data_str = data_str+"NULL|";                                               //employees_cnt
         data_str = data_str+"NULL|";                                               //final_segment
         data_str = data_str+"NULL|";                                               //gks_segments
         data_str = data_str+"NULL|";                                               //individual_segment
         data_str = data_str+"NULL|";                                               //responsibility_zone
         data_str = data_str+"NULL|";                                               //separated_subjects
         data_str = data_str+"NULL|";                                               //affiliation_to_projects_org
         data_str = data_str+"NULL|";                                               //responsible_service
         data_str = data_str+rs.value("INN")+"|";                                   //inn
         data_str = data_str+rs.value("KPPRegistrationPlace")+"|";                  //kpp_reg_place
         data_str = data_str+"NULL|";                                               //kpp_major_taxpayer
         data_str = data_str+rs.value("OGRN")+"|";                                  //ogrn
         data_str = data_str+rs.value("KIO")+"|";                                   //kio
         data_str = data_str+SQL_ConvTypeStr(rs.value("OKPO"))+"|";                 //okpo
         data_str = data_str+rs.value("OKFS")+"|";                                  //okfs
         data_str = data_str+rs.value("OKOGU")+"|";                                 //okogu
         data_str = data_str+rs.value("OKTMO")+"|";                                 //oktmo
         data_str = data_str+rs.value("OKATO")+"|";                                 //okato
         data_str = data_str+rs.value("OKOPF")+"|";                                 //okopf
         data_str = data_str+ConvertDate(NULL) +"|";                                //registration_date
         data_str = data_str+ConvertDate(NULL) +"|";                                //liquidation_date
         data_str = data_str+"NULL|";                                               //registration_number
         data_str = data_str+ConvertDate(rs.value("OGRNRegistrationDate")) +"|";    //ogrn_registration_date
         data_str = data_str+"NULL|";                                               //flchp_registration_number
         data_str = data_str+ConvertDate(NULL) +"|";                                //flchp_registration_date
         data_str = data_str+"NULL|";                                               //flchp_registration_structure
         data_str = data_str+rs.value("NonResidentRegistrationNumber")+"|";         //nonresident_reg_num
         data_str = data_str+ConvertDate(rs.value("NonResidentRegistrationDate")) +"|";   //nonresident_reg_date
         data_str = data_str+"NULL|";                                               //strategic_org_flag
         data_str = data_str+"NULL|";                                               //goz_client_flag
         data_str = data_str+"NULL|";                                               //diasoft_category
         data_str = data_str+"NULL|";                                               //self_regulating_company_flag
         data_str = data_str+"NULL|";                                               //apk_exporter
         data_str = data_str+"NULL|";                                               //ved_member
         data_str = data_str+"NULL|";                                               //exporter_flag
         data_str = data_str+"NULL|";                                               //importer_flag
         data_str = data_str+"NULL|";                                               //mfh_flag
         data_str = data_str+"NULL|";                                               //credit_history_subject_code
         data_str = data_str+"NULL|";                                               //savings_acc
         data_str = data_str+"NULL|";                                               //f302
         data_str = data_str+rs.value("t_batchid")+"|";                             //batch_id
         data_str = data_str+NAME_SYSTEM+"|";                                       //source_system
         data_str = data_str+"NULL|";                                               //small_middle_org
         data_str = data_str+"NULL|";                                               //gks_segment
         data_str = data_str+"NULL|";                                               //main_var_reguation
         data_str = data_str+"I|";                                                  //change_type
         data_str = data_str+rs.value("sd") +"|";                                   //change_date
         data_str = data_str+"NULL|";                                               //main_solve_option
         data_str = data_str+"NULL|";                                               //cdi_id
         data_str = data_str+"NULL|";                                               //account_tag
         data_str = data_str+"NULL|";                                               //org_type_name
         data_str = data_str+"NULL|";                                               //okopf_ps
         data_str = data_str+ConvertDate(NULL) +"|";                                //podft_form_create_date
         data_str = data_str+ConvertDate(NULL) +"|";                                //podft_form_update_date
         data_str = data_str+ConvertDate(NULL) +"|";                                //fatca_status_date
         data_str = data_str+ConvertDate(NULL) +"|";                                //crs_status_date
         data_str = data_str+"NULL|";                                               //fatca_status
         data_str = data_str+"NULL";                                                //crs_status
         
         data_str = StrSubst(data_str,"~","");
         
         FS_party.WriteLine( data_str );
         
         // ОКВЭД
         sql_str2 = "select c.t_groupid, c.t_attrid, c.t_general, a.t_numinlist, a.t_nameobject, a.t_name, a.t_fullname, c.t_validfromdate, c.t_id "+
                    "  from dobjatcor_dbt c "+
                    " inner join DOBJATTR_DBT a "+
                    "    on a.t_groupid = c.t_groupid and  a.t_attrid = c.t_attrid  and  a.t_objecttype = c.t_objecttype and c.t_groupid = 64 "+
                    " where lpad(:partyid, 10, '0')=c.t_object and a.t_objecttype = 3 "+
                    "   and c.t_validtodate = to_date('31129999','ddmmyyyy')";
         cmd2 = RSDCommand(sql_str2);
         cmd2.AddParam("partyid", RSDBP_IN, rs.value("t_partyid"));
         rs2 = RSDRecordSet(cmd2);
         while (rs2.movenext)
            data_str = "";
            data_str = data_str+rs2.value("t_id")+"|";      //source_id
            data_str = data_str+rs.value("t_partyid")+"|";  //party_source_id
            data_str = data_str+rs2.value("t_id")+ "|";     //okved_source_id
            if (rs2.value("t_general") == "X")              //main_flag
               data_str = data_str+"YES|";
            else 
               data_str = data_str+"NO|";
            end;
            data_str = data_str+ConvertDate(dttm(rs2.value("t_validfromdate")))+ "|";     //start_date
            data_str = data_str+"1911-11-11|";                                            //end_date
            data_str = data_str+rs.value("t_batchid")+"|";                                //batch_id
            data_str = data_str+NAME_SYSTEM+"|";                                          //source_system
            data_str = data_str+"I|";                                                     //change_type
            data_str = data_str+rs.value("sd") +"|";                                      //change_date
            data_str = data_str+rs2.value("t_numinlist")+"|";                             //okved_code
            data_str = data_str+rs2.value("t_name")+"|";                                  //okved_name
            data_str = data_str+rs2.value("t_fullname");                                  //okved_title
            
            FS_okved.WriteLine( data_str );
         end;
         
         //адреса 
         sql_str2 = "select adr.*, "+
                    "  decode(adr.t_country, chr(1),'643','RUS','643',nvl((select t_codenum3 from dcountry_dbt where t_CodeLat3 = adr.t_country),'~')) country "+
                    "  from dadress_dbt adr "+
                    " where t_partyid = :partyid";
         cmd2 = RSDCommand(sql_str2);
         cmd2.AddParam("partyid", RSDBP_IN, rs.value("t_partyid"));
         rs2 = RSDRecordSet(cmd2);
         while (rs2.movenext)
            data_str = "";
            data_str = data_str+String(rs2.value("t_partyid"),rs2.value("t_type"))+ "|";  //source_id
            data_str = data_str+rs.value("t_partyid")+"|";                                //party_source_id
            if (rs2.value("t_type") == 1)                                                 //address_type
               data_str = data_str+"CORP|";
            elif (rs2.value("t_type") == 2)
               data_str = data_str+"FACT|";
            elif (rs2.value("t_type") == 3)
               data_str = data_str+"POST|";
            elif (rs2.value("t_type") == 5)
               data_str = data_str+"CORP_CHARTER|";
            else 
               continue;
            end;
            data_str = data_str+SQL_ConvTypeStr(rs2.value("t_Adress"))+ "|";           //address_line
            data_str = data_str+SQL_ConvTypeStr(rs2.value("country"))+ "|";            //country
            data_str = data_str+SQL_ConvTypeStr(rs2.value("t_PostIndex"))+ "|";        //postal_code
            data_str = data_str+SQL_ConvTypeStr(rs2.value("t_Region"))+ "|";           //region_name
            data_str = data_str+SQL_ConvTypeStr(rs2.value("t_coderegion"))+ "|";       //region_type
            data_str = data_str+SQL_ConvTypeStr(rs2.value("t_Province"))+ "|";         //area_name
            data_str = data_str+SQL_ConvTypeStr(rs2.value("t_CodeProvince"))+ "|";     //area_type
            data_str = data_str+SQL_ConvTypeStr(rs2.value("t_District"))+ "|";         //city_name
            data_str = data_str+SQL_ConvTypeStr(rs2.value("t_CodeDistrict"))+ "|";     //city_type
            data_str = data_str+SQL_ConvTypeStr(rs2.value("t_Place"))+ "|";            //place_name
            data_str = data_str+SQL_ConvTypeStr(rs2.value("t_CodePlace"))+ "|";        //place_type
            data_str = data_str+SQL_ConvTypeStr(rs2.value("t_plan"))+ "|";             //structure_name
            data_str = data_str+SQL_ConvTypeStr(rs2.value("t_codeplan"))+ "|";         //structure_type
            data_str = data_str+SQL_ConvTypeStr(rs2.value("t_Street"))+ "|";           //street_name
            data_str = data_str+SQL_ConvTypeStr(rs2.value("t_CodeStreet"))+ "|";       //street_type
            
            data_str = data_str+SQL_ConvTypeStr(rs2.value("t_House"))+ "|";            //house
            data_str = data_str+SQL_ConvTypeStr(rs2.value("t_NumCorps"))+ "|";         //hcase
            data_str = data_str+SQL_ConvTypeStr(rs2.value("t_building"))+ "|";         //block
            data_str = data_str+ "NULL|";                                              //liter
            data_str = data_str+SQL_ConvTypeStr(rs2.value("t_Flat"))+ "|";             //flat
            data_str = data_str+"NULL|";                                               //main_address_flag
            data_str = data_str+SQL_ConvTypeStr(rs2.value("t_OKTMO"))+ "|";            //oktmo
            data_str = data_str+SQL_ConvTypeStr(rs2.value("t_fiasguid"))+ "|";         //fias_guid
            data_str = data_str+SQL_ConvTypeStr(rs2.value("t_kladr"))+ "|";            //kladr_id
            data_str = data_str+"NULL|";                                               //description
            data_str = data_str+rs.value("t_batchid")+"|";                             //batch_id
            data_str = data_str+NAME_SYSTEM+"|";                                       //source_system
            data_str = data_str+"I|";                                                  //change_type
            data_str = data_str+rs.value("sd");                                        //change_date

            data_str = StrSubst(data_str,"~","");

            FS_adres.WriteLine( data_str );
         end;
         
         //контакты
         sql_str2 = "select * from dcontact_dbt "+
                    " where t_partyid = :partyid";
         cmd2 = RSDCommand(sql_str2);
         cmd2.AddParam("partyid", RSDBP_IN, rs.value("t_partyid"));
         rs2 = RSDRecordSet(cmd2);
         while (rs2.movenext)
            data_str = "";
            data_str = data_str+rs2.value("t_RecId")+ "|";                    //source_id
            data_str = data_str+rs.value("t_partyid")+"|";                    //party_source_id

            data_str = data_str+SQL_ConvTypeStr(rs2.value("t_value"))+ "|";   //contact_value
            if (rs2.value("t_ContactKind") == CNTK_PHONE)                     
               ContactType =  "PHONE";
               if ( rs2.value("t_ContactType") == CNTT_WORKING )
                  ContactKind =  "WORK";
               else
                  ContactKind =  "HOME";
               end;
            elif ( rs2.value("t_ContactKind") == CNTK_EMAIL )
               ContactType =  "MAIL";
               if ( ( rs2.value("t_ContactType") == CNTT_WORKING) or ( rs2.value("t_ContactType") == 1001) ) //для почты другой рабочий тип
                  ContactKind =  "WORK";
               else 
                  ContactKind =  "HOME";
               end;
            else 
               ContactType = "";
               ContactKind = "";
            end;
            data_str = data_str+ContactKind+ "|";                          //contact_type_det
            if (rs2.value("t_isMain") == "X")
               data_str = data_str+ "YES|";                                  //main_contact_flag
            else
               data_str = data_str+ "NO|";
            end;
            data_str = data_str+ "YES|";                                   //active_flag
            data_str = data_str+ "NULL|";                                  //status
            data_str = data_str+ "NULL|";                                  //comment
            data_str = data_str+ContactType+ "|";                          //contact_type
            data_str = data_str+rs.value("t_batchid")+"|";                 //batch_id
            data_str = data_str+NAME_SYSTEM+"|";                           //source_system
            data_str = data_str+"I|";                                      //change_type
            data_str = data_str+rs.value("sd");                            //change_date

            FS_contact.WriteLine( data_str );
         end;

         //ссылки
         sql_str2 = "select * from dobjcode_dbt "+
                    " where t_objecttype = 3 and t_state = 0 and t_objectid = :partyid and t_codekind = :pcodekind";
         cmd2 = RSDCommand(sql_str2);
         cmd2.AddParam("partyid", RSDBP_IN, rs.value("t_partyid"));
         cmd2.AddParam("pcodekind", RSDBP_IN, PARTY_CODEKIND_ABS);
         rs2 = RSDRecordSet(cmd2);

         while (rs2.movenext)
            data_str = "";
            data_str = data_str+rs2.value("t_autokey")+ "|";     //source_id
            data_str = data_str+rs.value("t_partyid")+"|";     //party_source_id
            data_str = data_str+"cft_ul"+ "|";                 //ext_source_system_name
            data_str = data_str+rs2.value("t_code")+"|";       //ext_party_source_id
            data_str = data_str+ "NULL|";                      //cio_ext_party_source_id
            data_str = data_str+ "NULL|";                      //exp_ext_party_source_id
            data_str = data_str+ "cft_ul|";                    //ext_source_system
            data_str = data_str+ConvertDate(rs2.value("t_bankdate"))+ "|";  //start_date
            data_str = data_str+"||";                          //end_date
            data_str = data_str+"1|";                          //active_flag
            data_str = data_str+rs.value("t_batchid")+"|";     //batch_id
            data_str = data_str+NAME_SYSTEM+"|";               //source_system
            data_str = data_str+"I|";                          //change_type
            data_str = data_str+rs.value("sd");                //change_date

            FS_extid.WriteLine( data_str );
         end;

         
         sql_str2 = "update biq10268_unload set t_status = 100, t_timestamp = sysdate where rowid ='"+rs.value("rowid")+"'";
         cmd2 = RSDCommand(sql_str2);
         cmd2.execute;
         cmd2.close;
         CountContr = CountContr+1;
         UseProgress(CountContr);
     end;
     
      FS_party = NULL;
      FS_okved = NULL;
      FS_adres = NULL;
      FS_contact = NULL;
      FS_extid = NULL;
      
   else
      RemProgress();
      msgbox("Ошибка создания файла выгрузки!");
   end;
   rs.close; rs = null;
   cmd.close; cmd = null;

   RemProgress();

println("Выгружено записей: "+CountContr);

println(time() + " Конец");
end;

/* Точка входа */
  if (Gettrue(true, "Запустить?"))
     RunReport();
  end;

end;