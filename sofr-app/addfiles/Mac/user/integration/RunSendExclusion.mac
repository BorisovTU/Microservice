/*-----------------------------------------------------------------------------------------
   RunSendExclusion.mac
   Запуск рассылки уведомлений клиентам ФЛ о возможности подать заявление на исключение из реестра 
    квалифицированных инвесторов
   BIQ-9185
   Гераськина Т.В.
-----------------------------------------------------------------------------------------*/

import dbo_qi_Exclusion;

var sql_str, cmd, rs, res;
var repdate = date();

if (msgboxex("Запустить рассылку уведомлений клиентам о возможности подать заявление на исключение из реестра квалифицированных инвесторов?",
             MB_YES+MB_NO, IND_NO) == IND_YES)
    res = RunExclusionQI(repdate, true);

    BegAction ("Формирование протокола",2000);
    sql_str = "SELECT u.t_id, u.t_timestamp, u.t_partyid, u.t_kind, u.t_ekk, "+                                
              "       u.t_send_date, u.t_send_status, u.t_send_result, "+
              "       u.t_dlcontrid, u.t_msgid, "+
              "       p.t_shortname, "+
              "       s.t_number, "+
              "       s.t_datebegin, "+ 
              "       m.t_sendtime "+ 
              "  FROM uqiaccreditation_dbt u,"+
              "           dparty_dbt p, "+
              "           ddlcontr_dbt d, "+
              "           dsfcontr_dbt s, "+ 
              "           ddlcontrmsg_dbt m "+ 
              " WHERE u.t_timestamp between :p_datebegin and :p_dateend+1 "+
              "   AND u.t_kind = :kind "+
              "   AND u.t_partyid = p.t_partyid "+
              "   AND d.t_dlcontrid = u.t_dlcontrid "+
              "   AND D.T_SFCONTRID = s.t_id "+
              "   AND m.t_id(+) = u.t_msgid"+
              " ORDER BY u.t_id desc";
    cmd = RSDCommand(sql_str);
    cmd.AddParam("p_datebegin", RSDBP_IN, repdate);
    cmd.AddParam("p_dateend", RSDBP_IN, repdate);
    cmd.AddParam("kind", RSDBP_IN, EXCLUSIONRIGHT_QI);
    rs = RSDRecordSet(cmd);                              
    println("ФИО клиента                   │ ЕКК         │ Номер договора                │ Дата дог.   │ Дата отпр.  │ Время отпр. │Статус отправки сообщения ");
    println("──────────────────────────────┼─────────────┼───────────────────────────────┼─────────────┼─────────────┼─────────────┼──────────────────────────");
    while (rs.movenext)                    
            [##############################│ ############│ ##############################│ ############│ ############│ ############│# ](rs.value("t_shortname"), rs.value("t_ekk"), rs.value("t_number"), SQL_ConvTypeDate(rs.value("t_datebegin")), SQL_ConvTypeDate(rs.value("t_send_date")), SQL_ConvTypeTime(rs.value("t_sendtime")), rs.value("t_send_result") );
    end;
    println("──────────────────────────────┴─────────────┴───────────────────────────────┴─────────────┴─────────────┴─────────────┴──────────────────────────");
    EndAction ();
end;