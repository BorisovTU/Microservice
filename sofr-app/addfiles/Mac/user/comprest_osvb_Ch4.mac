import RSD;

const K_ENTER   = 13;
const K_ESC     = 27;
const K_F5      = 319;
const K_F6      = 320;

PRIVATE MACRO AddCol (ar,ind, fld, head, width, rdonly,  dp)
   ar.value (ind * 6)     = fld;
   ar.value (ind * 6 + 1) = head;
   ar.value (ind * 6 + 2) = width;
   ar.value (ind * 6 + 3 ) = rdonly;   // fldType
   ar.value (ind * 6 + 4 ) = dp;//   decPoint
   ar.value (ind * 6 + 5 ) = 0;   // reserv
END;

var shift = 0, kind = 0, {curdate}, cdate = {curdate}, dsum = $0.00;

macro Scroll
   var sql, cmd, rs, col1, need = true,Column = TArray(),i, ColumnValue, ColumnName, NumColumns = 0;

   macro EvProc(rs, cmd, id, key)
     var  CM_DEFAULT = null;
     if (cmd == DLG_INIT)
        EndAction;
     elif (cmd == DLG_KEY)
        if (key == K_F5)
          if (getDate(cdate, "Укажите дату:"))
             need = true;
             return CM_SELECT;
          end;
        elif (key == K_ESC)
          return 2;
        end;
     end;
     return CM_DEFAULT;
  end;

   col1 = TArray;   

   AddCol (col1, 0, "acc",           "Счет",    20,  true);
   AddCol (col1, 1, "cin_cur_rest",  "Валютный вх остаток БИС", 20, true, 2);
   AddCol (col1, 2, "cin_rub_rest",  "Рублевый вх остаток БИС", 20, true, 2);
   AddCol (col1, 3, "cdeb_cur",  "Дт оборот валюта БИС", 20, true, 2);
   AddCol (col1, 4, "cdeb_rub",  "Дт оборот рубли БИС", 20, true, 2);
   AddCol (col1, 5, "ccrd_cur",  "Кт оборот валюта БИС", 20, true, 2);
   AddCol (col1, 6, "ccrd_rub",  "Кт оборот рубли БИС", 20, true, 2);
   AddCol (col1, 7, "cout_cur_rest",  "Валютный исх остаток БИС", 20, true, 2);
   AddCol (col1, 8, "cout_rub_rest",  "Рублевый исх остаток БИС", 20, true, 2);
   AddCol (col1, 9, "name",           "Наименование счета",    50,  true);

   while (need)
      need = false;
      BegAction(0, "Ждите, формируется список ...", false);
      sql =

"select c.acc acc\n" +
"      , c.in_cur_rest cin_cur_rest\n" + 
"      , c.in_rub_rest cin_rub_rest\n" + 
"      , c.deb_cur cdeb_cur\n" + 
"      , c.deb_rub cdeb_rub\n" + 
"      , c.crd_cur ccrd_cur\n" + 
"      , c.crd_rub ccrd_rub\n" + 
"      , c.out_cur_rest cout_cur_rest\n" + 
"      , c.out_rub_rest cout_rub_rest\n" + 
"      , c.name\n" + 
"  from (\n" + 
"select stbl.*\n" + 
"  from ( select ra.t_account acc,\n" + 
"          fi.t_fi_code cur,\n" + 
"          nvl(rc.t_rest, 0) in_cur_rest,\n" + 
"          nvl(rr.t_rest, 0) in_rub_rest,\n" + 
"          nvl(rcd.t_debet, 0) + nvl(rcd.t_debetspod, 0) deb_cur,\n" + 
"          nvl(rrd.t_debet, 0) + nvl(rrd.t_debetspod, 0) deb_rub,\n" + 
"          nvl(rcd.t_credit, 0) + nvl(rcd.t_creditspod, 0) crd_cur,\n" + 
"          nvl(rrd.t_credit, 0) + nvl(rrd.t_creditspod, 0) crd_rub,\n" + 
"          coalesce(rcd.t_rest,rcu.t_rest, 0) out_cur_rest,\n" + 
"          coalesce(rrd.t_rest,rru.t_rest, 0) out_rub_rest\n" + 
"  from daccount_dbt ra\n" + 
"  inner join dfininstr_dbt fi\n" + 
"     on (ra.t_code_currency = fi.t_fiid)\n" + 
"  left join drestdate_dbt rc\n" + 
"    on (rc.t_accountid = ra.t_accountid  and rc.t_restcurrency =  decode(ra.t_code_currency, 0, -100, ra.t_code_currency) and rc.t_restdate = (select max(t_restdate) from drestdate_dbt where t_accountid = ra.t_accountid and t_restcurrency = decode(ra.t_code_currency, 0, -100, ra.t_code_currency) and t_restdate < to_date(:cdate, 'dd.mm.yyyy')))\n" + 
"  left join drestdate_dbt rr\n" + 
"    on (rr.t_accountid = ra.t_accountid  and rr.t_restcurrency =  0 and rr.t_restdate = (select max(t_restdate) from drestdate_dbt where t_accountid = ra.t_accountid and t_restcurrency = 0 and t_restdate < to_date(:cdate, 'dd.mm.yyyy')))\n" + 
"  left join drestdate_dbt rcu\n" + 
"    on (rcu.t_accountid = ra.t_accountid  and rcu.t_restcurrency =  decode(ra.t_code_currency, 0, -100, ra.t_code_currency) and rcu.t_restdate = (select max(t_restdate) from drestdate_dbt where t_accountid = ra.t_accountid and t_restcurrency = decode(ra.t_code_currency, 0, -100, ra.t_code_currency) and t_restdate <= to_date(:cdate, 'dd.mm.yyyy')))\n" + 
"  left join drestdate_dbt rru\n" + 
"    on (rru.t_accountid = ra.t_accountid  and rru.t_restcurrency =  0 and rru.t_restdate = (select max(t_restdate) from drestdate_dbt where t_accountid = ra.t_accountid and t_restcurrency = 0 and t_restdate <= to_date(:cdate, 'dd.mm.yyyy')))\n" + 
"  left join drestdate_dbt rcd\n" + 
"    on (rcd.t_accountid = ra.t_accountid  and rcd.t_restcurrency =  decode(ra.t_code_currency, 0, -100, ra.t_code_currency) and rcd.t_restdate = to_date(:cdate, 'dd.mm.yyyy'))\n" + 
"  left join drestdate_dbt rrd\n" + 
"    on (rrd.t_accountid = ra.t_accountid  and rrd.t_restcurrency =  0 and rrd.t_restdate = to_date(:cdate, 'dd.mm.yyyy'))\n" + 
"--  left join (select distinct main_v_id, date_close from account) ba\n" + 
"--    on (substr(ba.main_v_id, 1, 20) = ra.t_account and ba.main_v_id is not null)\n" + 
"  WHERE ((SubStr(ra.t_balance, 1, 2) = '93') or (SubStr(ra.t_balance, 1, 2) = '94') or (SubStr(ra.t_balance, 1, 2) = '95') or (SubStr(ra.t_balance, 1, 2) = '96') or (SubStr(ra.t_balance, 1, 2) = '97'))\n" + 
"    and (ra.t_open_close = chr(0) or  (ra.t_close_date >= to_date(:cdate, 'dd.mm.yyyy')))\n" + 
"--    and ((ba.date_close is null) or ((ba.date_close is not null) and (coalesce(rrd.t_rest,rru.t_rest, 0)>0 )))\n" + 
"\n" + 
"\n" + 
") stbl) s\n" + 
"  full join\n" + 
" (select ctbl.*\n" + 
" from (select replace(acc, '-') acc, nvl(cur, '810') cur, name,\n" + 
"    to_number(case when trim(in_cur_rest) = '-' then\n" + 
"                               '0'\n" + 
"                            when instr(inc_dc, 'Дб') > 0 then\n" + 
"                              replace( '-' || replace(in_cur_rest, ' '), ',')\n" + 
"                            else\n" + 
"                              replace(replace(in_cur_rest, ' '), ',', '')\n" + 
"                     end, '999999999999999999999999.999999999999999') in_cur_rest,\n" + 
"    to_number(case when trim(in_rub_rest) = '-' then\n" + 
"                               '0'\n" + 
"                            when instr(inr_dc, 'Дб') > 0 then\n" + 
"                              replace( '-' || replace(in_rub_rest, ' '), ',')\n" + 
"                            else\n" + 
"                              replace(replace(in_rub_rest, ' '), ',', '')\n" + 
"                     end, '999999999999999999999999.999999999999999') in_rub_rest,\n" + 
"    to_number(case when trim(deb_cur) = '-' then\n" + 
"                               '0'\n" + 
"                            else\n" + 
"                              replace(replace(deb_cur, ' '), ',' )\n" + 
"                     end, '999999999999999999999999.999999999999999') deb_cur,\n" + 
"    to_number(case when trim(deb_rub) = '-' then\n" + 
"                               '0'\n" + 
"                            else\n" + 
"                              replace(replace(deb_rub, ' '), ',' )\n" + 
"                     end, '999999999999999999999999.999999999999999') deb_rub,\n" + 
"    to_number(case when trim(crd_cur) = '-' then\n" + 
"                               '0'\n" + 
"                            else\n" + 
"                              replace(replace(crd_cur, ' '), ',' )\n" + 
"                     end, '999999999999999999999999.999999999999999') crd_cur,\n" + 
"    to_number(case when trim(crd_rub) = '-' then\n" + 
"                               '0'\n" + 
"                            else\n" + 
"                              replace(replace(crd_rub, ' '), ',' )\n" + 
"                     end, '999999999999999999999999.999999999999999') crd_rub,\n" + 
"    to_number(case when trim(out_cur_rest) = '-' then\n" + 
"                               '0'\n" + 
"                            when instr(outc_dc, 'Дб') > 0 then\n" + 
"                              replace( '-' || replace(out_cur_rest, ' '), ',')\n" + 
"                            else\n" + 
"                              replace(replace(out_cur_rest, ' '), ',', '')\n" + 
"                     end, '999999999999999999999999.999999999999999') out_cur_rest,\n" + 
"    to_number(case when trim(out_rub_rest) = '-' then\n" + 
"                               '0'\n" + 
"                            when instr(outr_dc, 'Дб') > 0 then\n" + 
"                              replace( '-' || replace(out_rub_rest, ' '), ',')\n" + 
"                            else\n" + 
"                              replace(replace(out_rub_rest, ' '), ',', '')\n" + 
"                     end, '999999999999999999999999.999999999999999') out_rub_rest\n" + 
"    from bis_balance\n" + 
"  where bdate = to_date(:cdate,'dd.mm.yyyy') and regexp_like (replace(acc, '-'), '\\d{20}') \n" + 
") ctbl ) c\n" + 
"  on (s.acc = c.acc)\n" + 
"where (s.acc is null and c.acc is not null)\n" + 
"  order by c.acc";

      cmd = RSDCommand(sql);
      cmd.AddParam("cdate1", RSDBP_IN, strsubst(string(cdate), " ", "0"));
      cmd.AddParam("cdate2", RSDBP_IN, strsubst(string(cdate), " ", "0"));
      cmd.AddParam("cdate3", RSDBP_IN, strsubst(string(cdate), " ", "0"));
      cmd.AddParam("cdate4", RSDBP_IN, strsubst(string(cdate), " ", "0"));
      cmd.AddParam("cdate5", RSDBP_IN, strsubst(string(cdate), " ", "0"));
      cmd.AddParam("cdate6", RSDBP_IN, strsubst(string(cdate), " ", "0"));
      cmd.AddParam("cdate7", RSDBP_IN, strsubst(string(cdate), " ", "0"));
      cmd.AddParam("cdate8", RSDBP_IN, strsubst(string(cdate), " ", "0"));

      rs = RSDRecordset(cmd , null, RSDVAL_STATIC );

   //   EndAction;
      if (RunScroll (rs, 10, col1, "test", "EvProc", "Счета ОСВ Бисквит, отсутствующие в СОФР за " + strsubst(string(cdate), " ", "0") ,"F5 - Изменить дату  ESC - Выход", true, 1, 1))
       //   return rs1;
      end;
   end;

return null;

end;
if (getDate(cdate, "Укажите дату:"))
  Scroll;
end;
exit(1);