import rsd;


Private Macro NotNull ( val )
    if ( val == NULL ) return false; end;
    if ( ValType (val) == 26 ) return false; end;
    return true;
End;


Private macro Sql_String ( str )
    if ( NotNull (str) and (str != StrFor (0)) and (str != StrFor (1)) )
        return str;
    end;
    return "";
End;


Private Macro GetFileName()
   var cc, nn, yy, mm, dd, hh, mi, ss, ms, rv;
   cc = "BIQ_4919";
   nn = "_30000_";
   datesplit(date(), dd, mm, yy);
   timesplit(time(), hh, mi, ss, ms);
   rv = cc + nn + string(yy) + 
        MkStr("0", 2 - StrLen(string(mm))) +string(mm) + 
        MkStr("0", 2 - StrLen(string(dd))) +string(dd) + 
        MkStr("0", 2 - StrLen(string(hh))) +string(hh) + 
        MkStr("0", 2 - StrLen(string(mi))) +string(mi) + 
        MkStr("0", 2 - StrLen(string(ss))) +string(ss) + 
        MkStr("0", 2 - StrLen(string(ms))) +string(ms) +
        ".csv" ; 
  return rv     
end;


Private  Macro PrepareContracts(cdate:Date)
   var cmd, sql;
   sql = "declare\n" +
			"  d1 date := :d1;\n" + 
			"  cid exp_contr.contrid%type;\n" + 
			"begin\n" + 
			"  for rec in (select distinct *\n" + 
			"                from (select 2 contrkind,\n" + 
			"                             ga.t_genagrid internalid,\n" + 
			"                             ec2.contrid,\n" + 
			"                             '30000' inform_system,\n" + 
			"                             '1' contract_type,\n" + 
			"                             ga.t_code contract_number,\n" + 
			"                             ga.t_name contract_header,\n" + 
			"                             pt.t_name client_name,\n" + 
			"                             decode(ga.t_start,\n" + 
			"                                    to_date('01010001', 'ddmmyyyy'),\n" + 
			"                                    null,\n" + 
			"                                    to_char(ga.t_start, 'dd.mm.yyyy')) contract_begin_date,\n" + 
			"                             decode(ga.t_date_end,\n" + 
			"                                    to_date('01010001', 'ddmmyyyy'),\n" + 
			"                                    null,\n" + 
			"                                    to_char(ga.t_date_end, 'dd.mm.yyyy')) contract_end_date,\n" + 
			"                             'ДРРК' contract_owner,\n" + 
			"                             case\n" + 
			"                               when ga.t_status = 20 then\n" + 
			"                                '0'\n" + 
			"                               else\n" + 
			"                                '1'  -- тут будут отложенные генсоглашения (ga.t_status = 0)\n" + 
			"                             end contract_status,\n" + 
			"                             regexp_replace(c16.t_code, '/.*') client_inn,\n" + 
			"                             c27.t_code client_ogrn\n" + 
			"                        from ddl_genagr_dbt ga\n" + 
			"                        left join dparty_dbt pt -- есть генсоглашения у которых t_parytid = 9999999 - такого суб нет в dparty_dbt\n" + 
			"                          on (ga.t_partyid = pt.t_partyid)\n" + 
			"                        left join dpartcode_dbt c16\n" + 
			"                          on (pt.t_partyid = c16.t_partyid and c16.t_codekind = 16 and\n" + 
			"                             c16.t_state = 0)\n" + 
			"                        left join dpartcode_dbt c27\n" + 
			"                          on (pt.t_partyid = c27.t_partyid and c27.t_codekind = 27 and\n" + 
			"                             c27.t_state = 0)\n" + 
			"                        left join exp_contr ec2\n" + 
			"                          on (ec2.contrkind = 2 and ga.t_genagrid = ec2.internalid)\n" + 
			"                       where ga.t_dockind in (4611, 4812)\n" + 
			"                         and ga.t_start < d1\n" + 
			"                         and not exists (select 1\n" + 
			"                                from dpersn_dbt p\n" + 
			"                               where p.t_personid = ga.t_partyid)\n" + 
			"                      union all\n" + 
			"                      -- Договоры по СВ\n" + 
			"                      select 1 contrkind,\n" + 
			"                             sf.t_id internalid,\n" + 
			"                             ec1.contrid,\n" + 
			"                             '30000' inform_system,\n" + 
			"                             '1' contract_type,\n" + 
			"                             sf.t_number contract_number,\n" + 
			"                             sf.t_name contract_header,\n" + 
			"                             pt.t_name client_name,\n" + 
			"                             decode(sf.t_datebegin,\n" + 
			"                                    to_date('01010001', 'ddmmyyyy'),\n" + 
			"                                    null,\n" + 
			"                                    to_char(sf.t_datebegin, 'dd.mm.yyyy')) contract_begin_date,\n" + 
			"                             decode(sf.t_dateclose,\n" + 
			"                                    to_date('01010001', 'ddmmyyyy'),\n" + 
			"                                    null,\n" + 
			"                                    to_char(sf.t_dateclose, 'dd.mm.yyyy')) contract_end_date,\n" + 
			"                             'ДРРК' contract_owner,\n" + 
			"                             case\n" + 
			"                               when sf.t_dateclose  = to_date('01010001','ddmmyyyy') or sf.t_dateclose > d1 then\n" + 
			"                                '1'\n" + 
			"                                else\n" + 
			"                                '0'\n" + 
			"                             end contract_status,\n" + 
			"                             regexp_replace(c16.t_code, '/.*$') client_inn,\n" + 
			"                             c27.t_code client_ogrn\n" + 
			"                        from dsfcontr_dbt sf\n" + 
			"                        left join dparty_dbt pt\n" + 
			"                          on (sf.t_partyid = pt.t_partyid)\n" + 
			"                        left join dpartcode_dbt c16\n" + 
			"                          on (pt.t_partyid = c16.t_partyid and c16.t_codekind = 16 and\n" + 
			"                             c16.t_state = 0)\n" + 
			"                        left join dpartcode_dbt c27\n" + 
			"                          on (pt.t_partyid = c27.t_partyid and c27.t_codekind = 27 and\n" + 
			"                             c27.t_state = 0)\n" + 
			"                        left join exp_contr ec1\n" + 
			"                          on (ec1.contrkind = 1 and sf.t_id = ec1.internalid)\n" + 
			"                       where sf.t_servkind = 8 and sf.t_objecttype = 4\n" + 
			"                         and sf.t_datebegin < d1\n" + 
			"                         and not exists (select 1\n" + 
			"                                from dpersn_dbt p\n" + 
			"                               where p.t_personid = sf.t_partyid)\n" + 
			"                      union all\n" + 
			"                      -- Договоры по УВ\n" + 
			"                      select 3 contrkind,\n" + 
			"                             ti.t_dealid internalid,\n" + 
			"                             ec3.contrid,\n" + 
			"                             '30000' inform_system,\n" + 
			"                             '1' contract_type,\n" + 
			"                             ti.t_dealcode contract_number,\n" + 
			"                             null contract_header,\n" + 
			"                             pt.t_name client_name,\n" + 
			"                             decode(ti.t_dealdate,\n" + 
			"                                    to_date('01010001', 'ddmmyyyy'),\n" + 
			"                                    null,\n" + 
			"                                    to_char(ti.t_dealdate, 'dd.mm.yyyy')) contract_begin_date,\n" + 
			"                             decode(ti.t_closedate,\n" + 
			"                                    to_date('01010001', 'ddmmyyyy'),\n" + 
			"                                    null,\n" + 
			"                                    to_char(ti.t_closedate, 'dd.mm.yyyy')) contract_end_date,\n" + 
			"                             'ДРРК' contract_owner,\n" + 
			"                             case\n" + 
			"                               when ti.t_dealstatus = 20 then\n" + 
			"                                '0'\n" + 
			"                                else\n" + 
			"                                '1'\n" + 
			"                             end contract_status,\n" + 
			"                             regexp_replace(c16.t_code, '/.*$') client_inn,\n" + 
			"                             c27.t_code client_ogrn\n" + 
			"                        from ddl_tick_dbt ti\n" + 
			"                        left join dparty_dbt pt\n" + 
			"                          on (ti.t_partyid = pt.t_partyid)\n" + 
			"                        left join dpartcode_dbt c16\n" + 
			"                          on (pt.t_partyid = c16.t_partyid and c16.t_codekind = 16 and\n" + 
			"                             c16.t_state = 0)\n" + 
			"                        left join dpartcode_dbt c27\n" + 
			"                          on (pt.t_partyid = c27.t_partyid and c27.t_codekind = 27 and\n" + 
			"                             c27.t_state = 0)\n" + 
			"                        left join exp_contr ec3\n" + 
			"                          on (ec3.contrkind = 3 and  ti.t_dealid = ec3.internalid)\n" + 
			"                       where ti.t_bofficekind in ( 141, 142)\n" + 
			"                         and ti.t_dealdate < d1\n" + 
			"                         and not exists (select 1\n" + 
			"                                from dpersn_dbt p\n" + 
			"                               where p.t_personid = ti.t_partyid)\n" + 
			"                      union all\n" + 
			"                      -- Субдоговоры БО\n" + 
			"                      select 4 contrkind,\n" + 
			"                             sfc_sub.t_id internalid,\n" + 
			"                             ec4.contrid,\n" + 
			"                             '30000' inform_system,\n" + 
			"                             '1' contract_type,\n" + 
			"                             sfc_sub.t_number contract_number,\n" + 
			"                             sfc_sub.t_name contract_header,\n" + 
			"                             pt.t_name client_name,\n" + 
			"                             decode(sfc_sub.t_datebegin,\n" + 
			"                                    to_date('01010001', 'ddmmyyyy'),\n" + 
			"                                    null,\n" + 
			"                                    to_char(sfc_sub.t_datebegin, 'dd.mm.yyyy')) contract_begin_date,\n" + 
			"                             decode(sfc_sub.t_dateclose,\n" + 
			"                                    to_date('01010001', 'ddmmyyyy'),\n" + 
			"                                    null,\n" + 
			"                                    to_char(sfc_sub.t_dateclose, 'dd.mm.yyyy')) contract_end_date,\n" + 
			"                             'ДРРК' contract_owner,\n" + 
			"                             case\n" + 
			"                               when sfc_sub.t_dateclose  = to_date('01010001','ddmmyyyy') or sfc_sub.t_dateclose > d1 then\n" + 
			"                                '1'\n" + 
			"                                else\n" + 
			"                                '0'\n" + 
			"                             end contract_status,\n" + 
			"                             regexp_replace(c16.t_code, '/.*$') client_inn,\n" + 
			"                             c27.t_code client_ogrn\n" + 
			"                        from ddlcontr_dbt dlc\n" + 
			"                       inner join dsfcontr_dbt sfc\n" + 
			"                         on (dlc.t_sfcontrid = sfc.t_id)\n" + 
			"                       inner join ddlcontrmp_dbt lnk\n" + 
			"                          on (dlc.t_dlcontrid = lnk.t_dlcontrid)\n" + 
			"                       inner join dsfcontr_dbt sfc_sub\n" + 
			"                          on (lnk.t_sfcontrid = sfc_sub.t_id)\n" + 
			"                        left join dparty_dbt pt\n" + 
			"                          on (sfc_sub.t_partyid = pt.t_partyid)\n" + 
			"                        left join dpartcode_dbt c16\n" + 
			"                          on (pt.t_partyid = c16.t_partyid and c16.t_codekind = 16 and\n" + 
			"                             c16.t_state = 0)\n" + 
			"                        left join dpartcode_dbt c27\n" + 
			"                          on (pt.t_partyid = c27.t_partyid and c27.t_codekind = 27 and\n" + 
			"                             c27.t_state = 0)\n" + 
			"                        left join exp_contr ec4\n" + 
			"                          on (ec4.contrkind = 4 and sfc_sub.t_id = ec4.internalid)\n" + 
			"                         where sfc_sub.t_datebegin < d1\n" + 
			"                          and not exists (select 1\n" + 
			"                                            from dpersn_dbt p\n" + 
			"                                           where p.t_personid = sfc_sub.t_partyid)\n" + 
			"\n" + 
			"                        )\n" + 
			"                     )\n" + 
			"  loop\n" + 
			"    if (rec.contrid is null) then\n" + 
			"      select exp_contr_seq.nextval\n" + 
			"        into cid\n" + 
			"        from dual;\n" + 
			"      insert into exp_contr(contrkind, internalid, contrid)\n" + 
			"        values(rec.contrkind, rec.internalid, cid);\n" + 
			"    end if;\n" + 
			"  end loop;\n" + 
			"  commit;\n" + 
			"end;";

     cmd = RsdCommand(sql);
     cmd.AddParam("d1", RSDBP_IN, cdate);
	 cmd.Execute();

End;

Macro ExpContracts(cdate:Date, dir)
 file fexp () txt;
 var DirExp = "..\\Export", fname,
     sql, cmd, rs;
 // Заполнение внешнего ID 	 
 PrepareContracts(cdate);
 
 if (NotNull(dir))
  DirExp = dir;
 end;
 fname = String(DirExp, "\\", GetFileName());
 setoutput(fname, false);

  sql = "select distinct *\n" +
"              from (select 2 contrkind,\n" + 
"                           ga.t_genagrid internalid,\n" + 
"                           to_char(ec2.contrid) contrid,\n" + 
"                           '30000' inform_system,\n" + 
"                           '1' contract_type,\n" + 
"                           ga.t_code contract_number,\n" + 
"                           ga.t_name contract_header,\n" + 
"                           pt.t_name client_name,\n" + 
"                           decode(ga.t_start,\n" + 
"                                  to_date('01010001', 'ddmmyyyy'),\n" + 
"                                  null,\n" + 
"                                  to_char(ga.t_start, 'dd.mm.yyyy')) contract_begin_date,\n" + 
"                           decode(ga.t_date_end,\n" + 
"                                  to_date('01010001', 'ddmmyyyy'),\n" + 
"                                  null,\n" + 
"                                  to_char(ga.t_date_end, 'dd.mm.yyyy')) contract_end_date,\n" + 
"                           'ДРРК' contract_owner,\n" + 
"                           case\n" + 
"                             when ga.t_status = 20 then\n" + 
"                              '0'\n" + 
"                             else\n" + 
"                              '1'  -- тут будут отложенные генсоглашения (ga.t_status = 0)\n" + 
"                           end contract_status,\n" + 
"                           regexp_replace(c16.t_code, '/.*') client_inn,\n" + 
"                           c27.t_code client_ogrn\n" + 
"                      from ddl_genagr_dbt ga\n" + 
"                      left join dparty_dbt pt -- есть генсоглашения у которых t_parytid = 9999999 - такого суб нет в dparty_dbt\n" + 
"                        on (ga.t_partyid = pt.t_partyid)\n" + 
"                      left join dpartcode_dbt c16\n" + 
"                        on (pt.t_partyid = c16.t_partyid and c16.t_codekind = 16 and\n" + 
"                           c16.t_state = 0)\n" + 
"                      left join dpartcode_dbt c27\n" + 
"                        on (pt.t_partyid = c27.t_partyid and c27.t_codekind = 27 and\n" + 
"                           c27.t_state = 0)\n" + 
"                      left join exp_contr ec2\n" + 
"                        on (ec2.contrkind = 2 and ga.t_genagrid = ec2.internalid)\n" + 
"                     where ga.t_dockind in (4611, 4812)\n" + 
"                       and ga.t_start < :d1\n" + 
"                       and not exists (select 1\n" + 
"                              from dpersn_dbt p\n" + 
"                             where p.t_personid = ga.t_partyid)\n" + 
"                    union all\n" + 
"                    -- Договоры по СВ\n" + 
"                    select 1 contrkind,\n" + 
"                           sf.t_id internalid,\n" + 
"                           to_char(ec1.contrid),\n" + 
"                           '30000' inform_system,\n" + 
"                           '1' contract_type,\n" + 
"                           sf.t_number contract_number,\n" + 
"                           sf.t_name contract_header,\n" + 
"                           pt.t_name client_name,\n" + 
"                           decode(sf.t_datebegin,\n" + 
"                                  to_date('01010001', 'ddmmyyyy'),\n" + 
"                                  null,\n" + 
"                                  to_char(sf.t_datebegin, 'dd.mm.yyyy')) contract_begin_date,\n" + 
"                           decode(sf.t_dateclose,\n" + 
"                                  to_date('01010001', 'ddmmyyyy'),\n" + 
"                                  null,\n" + 
"                                  to_char(sf.t_dateclose, 'dd.mm.yyyy')) contract_end_date,\n" + 
"                           'ДРРК' contract_owner,\n" + 
"                           case\n" + 
"                             when sf.t_dateclose  = to_date('01010001','ddmmyyyy') or sf.t_dateclose > :d2 then\n" + 
"                              '1'\n" + 
"                              else\n" + 
"                              '0'\n" + 
"                           end contract_status,\n" + 
"                           regexp_replace(c16.t_code, '/.*$') client_inn,\n" + 
"                           c27.t_code client_ogrn\n" + 
"                      from dsfcontr_dbt sf\n" + 
"                      left join dparty_dbt pt\n" + 
"                        on (sf.t_partyid = pt.t_partyid)\n" + 
"                      left join dpartcode_dbt c16\n" + 
"                        on (pt.t_partyid = c16.t_partyid and c16.t_codekind = 16 and\n" + 
"                           c16.t_state = 0)\n" + 
"                      left join dpartcode_dbt c27\n" + 
"                        on (pt.t_partyid = c27.t_partyid and c27.t_codekind = 27 and\n" + 
"                           c27.t_state = 0)\n" + 
"                      left join exp_contr ec1\n" + 
"                        on (ec1.contrkind = 1 and sf.t_id = ec1.internalid)\n" + 
"                     where sf.t_servkind = 8 and sf.t_objecttype = 4\n" + 
"                       and sf.t_datebegin < :d3\n" + 
"                       and not exists (select 1\n" + 
"                              from dpersn_dbt p\n" + 
"                             where p.t_personid = sf.t_partyid)\n" + 
"                    union all\n" + 
"                    -- Договоры по УВ\n" + 
"                    select 3 contrkind,\n" + 
"                           ti.t_dealid internalid,\n" + 
"                          to_char(ec3.contrid),\n" + 
"                           '30000' inform_system,\n" + 
"                           '1' contract_type,\n" + 
"                           ti.t_dealcode contract_number,\n" + 
"                           null contract_header,\n" + 
"                           pt.t_name client_name,\n" + 
"                           decode(ti.t_dealdate,\n" + 
"                                  to_date('01010001', 'ddmmyyyy'),\n" + 
"                                  null,\n" + 
"                                  to_char(ti.t_dealdate, 'dd.mm.yyyy')) contract_begin_date,\n" + 
"                           decode(ti.t_closedate,\n" + 
"                                  to_date('01010001', 'ddmmyyyy'),\n" + 
"                                  null,\n" + 
"                                  to_char(ti.t_closedate, 'dd.mm.yyyy')) contract_end_date,\n" + 
"                           'ДРРК' contract_owner,\n" + 
"                           case\n" + 
"                             when ti.t_dealstatus = 20 then\n" + 
"                              '0'\n" + 
"                              else\n" + 
"                              '1'\n" + 
"                           end contract_status,\n" + 
"                           regexp_replace(c16.t_code, '/.*$') client_inn,\n" + 
"                           c27.t_code client_ogrn\n" + 
"                      from ddl_tick_dbt ti\n" + 
"                      left join dparty_dbt pt\n" + 
"                        on (ti.t_partyid = pt.t_partyid)\n" + 
"                      left join dpartcode_dbt c16\n" + 
"                        on (pt.t_partyid = c16.t_partyid and c16.t_codekind = 16 and\n" + 
"                           c16.t_state = 0)\n" + 
"                      left join dpartcode_dbt c27\n" + 
"                        on (pt.t_partyid = c27.t_partyid and c27.t_codekind = 27 and\n" + 
"                           c27.t_state = 0)\n" + 
"                      left join exp_contr ec3\n" + 
"                        on (ec3.contrkind = 3 and  ti.t_dealid = ec3.internalid)\n" + 
"                     where ti.t_bofficekind in ( 141, 142)\n" + 
"                       and ti.t_dealdate < :d4\n" + 
"                       and not exists (select 1\n" + 
"                              from dpersn_dbt p\n" + 
"                             where p.t_personid = ti.t_partyid)\n" + 
"                    union all\n" + 
"                    -- Субдоговоры БО\n" + 
"                    select 4 contrkind,\n" + 
"                           sfc_sub.t_id internalid,\n" + 
"                           to_char(ec4.contrid),\n" + 
"                           '30000' inform_system,\n" + 
"                           '1' contract_type,\n" + 
"                           sfc_sub.t_number contract_number,\n" + 
"                           sfc_sub.t_name contract_header,\n" + 
"                           pt.t_name client_name,\n" + 
"                           decode(sfc_sub.t_datebegin,\n" + 
"                                  to_date('01010001', 'ddmmyyyy'),\n" + 
"                                  null,\n" + 
"                                  to_char(sfc_sub.t_datebegin, 'dd.mm.yyyy')) contract_begin_date,\n" + 
"                           decode(sfc_sub.t_dateclose,\n" + 
"                                  to_date('01010001', 'ddmmyyyy'),\n" + 
"                                  null,\n" + 
"                                  to_char(sfc_sub.t_dateclose, 'dd.mm.yyyy')) contract_end_date,\n" + 
"                           'ДРРК' contract_owner,\n" + 
"                           case\n" + 
"                             when sfc_sub.t_dateclose  = to_date('01010001','ddmmyyyy') or sfc_sub.t_dateclose > :d5 then\n" + 
"                              '1'\n" + 
"                              else\n" + 
"                              '0'\n" + 
"                           end contract_status,\n" + 
"                           regexp_replace(c16.t_code, '/.*$') client_inn,\n" + 
"                           c27.t_code client_ogrn\n" + 
"                      from ddlcontr_dbt dlc\n" + 
"                     inner join dsfcontr_dbt sfc\n" + 
"                       on (dlc.t_sfcontrid = sfc.t_id)\n" + 
"                     inner join ddlcontrmp_dbt lnk\n" + 
"                        on (dlc.t_dlcontrid = lnk.t_dlcontrid)\n" + 
"                     inner join dsfcontr_dbt sfc_sub\n" + 
"                        on (lnk.t_sfcontrid = sfc_sub.t_id)\n" + 
"                      left join dparty_dbt pt\n" + 
"                        on (sfc_sub.t_partyid = pt.t_partyid)\n" + 
"                      left join dpartcode_dbt c16\n" + 
"                        on (pt.t_partyid = c16.t_partyid and c16.t_codekind = 16 and\n" + 
"                           c16.t_state = 0)\n" + 
"                      left join dpartcode_dbt c27\n" + 
"                        on (pt.t_partyid = c27.t_partyid and c27.t_codekind = 27 and\n" + 
"                           c27.t_state = 0)\n" + 
"                      left join exp_contr ec4\n" + 
"                        on (ec4.contrkind = 4 and sfc_sub.t_id = ec4.internalid)\n" + 
"                       where sfc_sub.t_datebegin < :d6\n" + 
"                        and not exists (select 1\n" + 
"                                          from dpersn_dbt p\n" + 
"                                         where p.t_personid = sfc_sub.t_partyid)\n" + 
"\n" + 
"                      ) order by to_number(contrid)\n" ;

 cmd = RsdCommand(sql);
  cmd.AddParam("d1", RSDBP_IN, cdate);
  cmd.AddParam("d2", RSDBP_IN, cdate);
  cmd.AddParam("d3", RSDBP_IN, cdate);
  cmd.AddParam("d4", RSDBP_IN, cdate);
  cmd.AddParam("d5", RSDBP_IN, cdate);
  cmd.AddParam("d6", RSDBP_IN, cdate);
  rs = RSDRecordSet(cmd);
  println("id;inform_system;contract_type;contract_number;contract_header;Client_name;Contract_begin_date;Contract_end_date;Contract_owner;Contract_status;Client_INN;Client_OGRN", true);
  
  while(rs.MoveNext())
    println(ToANSI(String(SQL_STRING(rs.Value(2)),";",
                          SQL_STRING(rs.Value(3)),";",
       		     SQL_STRING(rs.Value(4)),";",
	       	     SQL_STRING(rs.Value(5)),";",
		            SQL_STRING(rs.Value(6)),";",
       		     SQL_STRING(rs.Value(7)),";",
	       	     SQL_STRING(rs.Value(8)),";",
		            SQL_STRING(rs.Value(9)),";",
       		     SQL_STRING(rs.Value(10)),";",
	       	     SQL_STRING(rs.Value(11)),";",
	       	     SQL_STRING(rs.Value(12)),";",
		            SQL_STRING(rs.Value(13)),";"), true)
    );
  end;

  setoutput(null, false);
  if (not ExistFile(fname))
    Msgbox("Не удалось сформировать файл: " + fname);
    return;
  end;
  // Удалить открытие файла при выносе в бой
  //open(fexp, fname);
  //viewfile(fexp);
  //close(fexp);

  fname = String(DirExp, "\\Ready.txt");
  setoutput(fname, false);
  print(date());
  setoutput(null, false);  
Onerror(err)
  Msgbox(err.Message);
End;


