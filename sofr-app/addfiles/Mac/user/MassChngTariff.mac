import sfinter, RsbDataSet, rsd, sp_car;
//var {curdate};
var cmd, sql, stat, BegDate = {curdate}, NewTarifId;

Private const NewTarif = /*"Базовый_Кад"*/"ИНВЕСТОР";

Private Macro ChngTariff(cmd, BegDate, NewTarifId)
var stat, cmd1;
     
     stat = SfContrChangeSfPlan(cmd.id, NewTarifId, BegDate, false);
     If(stat !=0 )
        Println("Ошибка установки нового ТП для ДБО "+cmd.number);
        return 1;
     else
	  cmd1 = TrsbDataSet(" select sf.t_number, mp.* from ddlcontrmp_dbt mp, dsfcontr_dbt sf where mp.t_dlcontrid = " + cmd.dlcontrid+  " and mp.t_mpclosedate = to_date('01010001','ddmmyyyy') and sf.t_id = mp.t_sfcontrid ");
         While (cmd1.movenext())
     		stat = SfContrChangeSfPlan(cmd1.sfcontrid, NewTarifId, BegDate, false);
     		If(stat !=0 )
        	   Println("Ошибка установки нового ТП для субдоговора "+cmd1.number);
                 return 1;
              end;
         end;
         If(stat == 0)
             return 0;
         end;
     end;

End;

cmd = TrsbDataSet(" select * from dsfplan_dbt where UPPER(t_name) = UPPER('" + NewTarif + "') ");
If (cmd.movenext())
   NewTarifId = cmd.sfplanid;
else
   MsgBox("Не удалось определить ID тарифа но наименованию " + NewTarif);
   exit(1);
end;

sql = DL_RSDCommand(" select dl.t_dlcontrid, sf.* from dsfcontr_dbt sf, ddlcontr_dbt dl, dparty_dbt party where "+ 
					  " dl.t_sfcontrid = sf.t_id and sf.t_servkind = 0 and sf.t_dateclose = to_date('01010001','ddmmyyyy') "+
					  " and party.t_partyid = SF.T_PARTYID "+ 
					  " and party.t_legalform = 2 "+
					  " /*and dl.t_dlcontrid <30*/ /*and sf.t_number ='71-269190'*/ ");
If(not GetDate(BegDate, "Введите дату начала действия нового тарифа"))
   MsgBox("Отмена смены тарифов, не указана дата");
   exit(1);
end;
Println("Время старта: " + Time()) ;
    var cnt = sql.GetCount();
    var i = 0;    
    InitProgress(cnt, "Перебор ДБО для смены Тарифного плана", "Перебор ДБО для смены Тарифного плана");

    cmd = sql.Execute();

//    SetRSTrace(true); 
//    ToRsTrace("Начало цикла ДБО для смены ТП ");

While (cmd.movenext())
   If(rslDefCon.isInTrans())
     RslDefCon.RollbackTrans();
   end;
   rslDefCon.beginTrans();
   stat = ChngTariff(cmd, BegDate, NewTarifId);
   If(stat != 0)
      rslDefCon.rollbackTrans();
   else
      Println("Успешно установлен тариф для ДБО "+ cmd.number );
      RslDefCon.CommitTrans();
   end;
   UseProgress(i = i + 1);
end;
//    ToRsTrace("Окончание цикла ДБО для смены ТП ");
//    SetRSTrace(false); 

 RemProgress();
Println("Время Окончания: " + Time()) ;