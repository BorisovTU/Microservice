/*
$Name:             DOC_CashIn.mac
$Module:           RS-Retail
$Description:      à¨å®¤­ë© ª áá®¢ë© ®à¤¥à
*/

import "Or_Rep_h.mac", PTInter;
import order_const, rsd, ErrHandler;

private var {curdate},
            {CNum};

private file address( "adress.dbt" ) key 0;
private file curr( "currency.dbt" ) key 0;
private var opr  = TBFile( "person.dbt",   "r", 0 );
private var tpac = TBFile( "typeac.dbt",   "r", 0 );

private var ErrCodeWR, ErrTextWR;

private macro SplitString(str, delim)
  var arr = TArray;
  
  var idx;
  while (str != "")
    idx = Index(str, delim);
    if (idx == 0)
      arr[arr.size] = str;
      return arr;
    end;

    arr[arr.size] = substr(str, 1, idx - 1);
    str = substr(str, idx + 1);
  end;

  return arr;
end;


 /*************************************************************************\
 |                     ®«ãç¥­¨¥ ¤®«¦­®áâ¨ ®¯¥à æ¨®­¨áâ .                  |
 \*************************************************************************/
private macro GetNameTypePerson()
  var sWork = "";
  tpac.ReWind();
  tpac.Clear();
  tpac.rec.iNumType = 14;  /* “à®¢­¨ ¤®áâã¯®¢. */
  tpac.rec.Type_Account = opr.rec.cTypePerson;
  if ( tpac.GetEQ() )
    sWork = tpac.rec.Name_Type;
  else
    sWork = "?????";
    println( " *** è¨¡ª  ¯à¨ çâ¥­¨¨ ¤®«¦­®áâ¨ ®¯¥à æ¨®­¨áâ  á ª®¤®¬ = ", opr.rec.cTypePerson );
    ErrCodeWR = Status( ErrTextWR );
    println( "  è¨¡ª  " + String( ErrCodeWR ) + ": " + ErrTextWR );
  end;
  return sWork;
end;


private macro makeOperName(oper_code)
  var name = "";

  opr.rec.Oper = oper_code;
  if (not opr.GetEQ)
    return name;
  end;

  var fio = SplitString(opr.rec.Name, " ");

  if (fio.size > 0)
    name = fio[0];
  end;

  if (fio.size > 1)
    name = name + " " + substr(fio[1], 1, 1) + ".";
  end;

  if (fio.size > 2)
    name = name + " " + substr(fio[2], 1, 1) + ".";
  end;

  return name;
end;


private macro DateToStr( pDate )
  var d, m, y, Day, Month, Year;

  DateSplit( pDate, d, m, y );
  Day = String( d );

  if   (m ==  1) Month = " ï­¢ àï ";
  elif (m ==  2) Month = " ä¥¢à «ï ";
  elif (m ==  3) Month = " ¬ àâ  ";
  elif (m ==  4) Month = "  ¯à¥«ï ";
  elif (m ==  5) Month = " ¬ ï ";
  elif (m ==  6) Month = " ¨î­ï ";
  elif (m ==  7) Month = " ¨î«ï ";
  elif (m ==  8) Month = "  ¢£ãáâ  ";
  elif (m ==  9) Month = " á¥­âï¡àï ";
  elif (m == 10) Month = " ®ªâï¡àï ";
  elif (m == 11) Month = " ­®ï¡àï ";
  elif (m == 12) Month = " ¤¥ª ¡àï ";
  else           Month = "  ";
  end;

  Year = String(y);

  return Day + Month + Year + " £.";
end;


private macro MoneyToStr(sum)
  var str = string(sum:f );
  var isDigit = true;
  var stat = 0;
  
  GetRegistryValue("COMMON\\…—€’œ\\„…\\„€Ÿ_—€‘’œ_–ˆ”€Œˆ", V_BOOL, isDigit, stat);
  if (stat != 0)
    isDigit = true;
  end;                                    

  if (not isDigit and (SubStr(str, strlen(str) - 2) == "-00"))
    str = SubStr(str, 1, strlen(str) - 3) + "=";
  end;

  return str;
end;


private macro getExtCurr(codeCurr)
  rewind( curr );
  clearRecord( curr );
  curr.Code_Currency = codeCurr;
  getEQ( curr );
  return curr.ExternalCode;
end;


private macro getSymbCodeCurr( codeCurr, flag )
  var ret = " ";
  if ( flag )
    rewind( curr );
    clearRecord( curr );
    curr.Code_Currency = codeCurr;
    if ( getEQ( curr ) )
      ret = curr.Short_Name;
    end;
  end;
  return ret;
end;


private macro GetParty(party_id:integer)
  var cmd = RsdCommand(
      "select * " +
      "from dparty_dbt " +
      "where t_PartyId = ? ");

  cmd.addParam("PartyId", RSDBP_IN, party_id);
  cmd.execute();
  var rs = RsdRecordset(cmd);
  rs.NullConversion = true;
  return rs;
end;


private macro GetTempParty(party_id:integer)
  var cmd = RsdCommand(
      "select * " +
      "from dtemporaryparty_dbt " +
      "where t_TempPartyId = ? ");

  cmd.addParam("PartyId", RSDBP_IN, party_id);
  cmd.execute();
  var rs = RsdRecordset(cmd);
  rs.NullConversion = true;
  return rs;
end;


private class RepParams
  private var Params = "";

  macro add(str:string, format:string)
    if (Params != "")
      Params = Params + ", ";
    end;

    str = StrSubst(str, "\\", "\\\\"); // íªà ­¨à®¢ âì \
    str = StrSubst(str, "\"", "\\" + "\""); // íªà ­¨à®¢ âì "
    Params = Params + "\"" + str + "\"";

    if (format == null)
      format = ":l";
    end;
    Params = Params + ",\"" + format + "\"";
  end;

  macro getList()
    return Params;
  end;
end;


private class DocAccount(acc:string, iacc:string, sum:money, cashSym:string, curr_code:integer, corr_sum:money)
  var Account = acc;
  var Internal = "";
  var Amount = sum;
  var CorrespondingAmount = 0;
  var CashSymbol = cashSym;
  var CurrCode = 0;
  if ( ValType( iacc ) == V_STRING )
    Internal = iacc;
  end;
  if ( ValType( curr_code ) == V_INTEGER )
    CurrCode = curr_code;
  end;
  if ( ( ValType( corr_sum ) == V_MONEY ) or ( ValType( corr_sum ) == V_MONEYL ) )
    CorrespondingAmount = corr_sum;
  end;
end;


private class IKO(doc_id:integer)

  private var documentId = doc_id;
  private var documentNumber = "";
  private var docDate;
  private var payerName = "";
  private var debitAccount = "";
  private var debitAmount = $0;
  private var creditAccount = "";
  private var creditAmount = $0;
  private var debitCurr = 0;
  private var creditCurr = -1;
  private var flagSymCurr = TRUE;
  private var receiverName = "";
  private var receiverINN = "";
  private var receiverKPP = "";
  private var receiverOKATO = "";
  private var receiverAccount = "";
  private var receiver = TArray;
  private var receiverGroup = TArray;
  private var debitCurrCode = 0;
  private var receiverBankName = "";
  private var receiverBankBIK = "";
  private var payerBankName = "";
  private var payerBankBIK = "";
  private var sumStr = "";
  private var ground = "";
  private var operName = "";
  private var operWork = "";
  private var cashierName = "";
  private var cashierWork = "";
  private var opCipher = "";

  private var rep = CMakeReport( "", SEP_DEFAULT, 99999 );


  private macro getPartyName(rs:RsdRecordset, party_fld_name:string, temp_party_fld_name:string)
    var name = "";
    var is_null;
    var party_rs;

    var id = rs.value(party_fld_name, is_null);
    if (not is_null)
      party_rs = GetParty(id);
    else
      id = rs.value(temp_party_fld_name, is_null);
      if (not is_null)
        party_rs = GetTempParty(id);
      end;
    end;

    if (party_rs and party_rs.moveNext())
      name = party_rs.value("t_Name");
    end;


    return name;
  end;


  private macro getReceiverInfo(rs:RsdRecordset)
    var is_null;

    var id = rs.value("t_ReceiverPartyID", is_null);
    if (not is_null)
      var inn = getPartyINN(id, 1);
      SplitFullINN(inn, receiverINN, receiverKPP);

      ClearRecord(address);
      address.PartyID = id;
      address.Type = 1;  // îà¨¤¨ç¥áª¨©  ¤à¥á
      if ( GetEQ( address ) )
        receiverOKATO = address.OKATO;
      end;
    else
      id = rs.value("t_ReceiverTempPartyID", is_null);
      if (not is_null)
        var party_rs = GetTempParty(id);
        if (party_rs.moveNext())
          receiverINN = party_rs.value("t_INN");
          receiverKPP = party_rs.value("t_KPP");
          receiverOKATO = party_rs.value("t_OKATO");
          receiverAccount = party_rs.value("t_Account");
        end;
      end;
    end;
  end;


  private macro addReceiverAccount(acc:DocAccount)
    receiver[receiver.size] = acc;
    
    var i = 0;
    while (i < receiverGroup.size())
      if ((receiverGroup[i].CashSymbol == acc.CashSymbol) and (receiverGroup[i].CurrCode == acc.CurrCode))
        receiverGroup[i].Amount = receiverGroup[i].Amount + acc.Amount;
        return;
      end;
      
      i = i + 1;
    end;

    receiverGroup[receiverGroup.size] = DocAccount(acc.Account, acc.Internal, acc.Amount, acc.CashSymbol, acc.CurrCode, acc.CorrespondingAmount);
  end;
  

  private macro loadDocAccounts()
    var curCode = 0;
    var curElement = 0;
    var cmd = RsdCommand(
        "select * " +
        "from drtdocaccount_dbt " +
        "where t_DocumentId  = ? " +
        "order by t_DocumentId, t_LineNumber ");
                                                      
    cmd.addParam("DocumentId", RSDBP_IN, documentId);
    cmd.execute();
    var rs = RsdRecordset(cmd);
    rs.NullConversion = true;
    while (rs.moveNext())

      if ( ( ValType( rs.value("t_CurrCode") ) == V_INTEGER ) or ( ValType( rs.value("t_CurrCode") ) == V_DOUBLE ) or ( ValType( rs.value("t_CurrCode") ) == V_DOUBLEL ) )
        curCode = Int( rs.value("t_CurrCode") );
      else
        curCode = 0;
      end;

      if ( curElement == 0 )
        creditAmount = rs.value("t_Amount");
      end;

      addReceiverAccount( DocAccount( rs.value("t_Account"), rs.value("t_InternalAccount"), rs.value("t_Amount"), rs.value("t_CashSymbol"), curCode, rs.value("t_CorrespondingAmount") ) );

      curElement = curElement + 1;
    end;
  end;


  private macro init()

    var cmd = RsdCommand(
        "select * " +
        "from drtdocument_dbt d " +
        "where d.t_DocumentId = ? ");

    cmd.addParam("DocumentId", RSDBP_IN, documentId);
    cmd.execute();
    var rs = RsdRecordset(cmd);
    rs.NullConversion = true;
    if (not rs.moveNext())
      DoError("Š áá®¢ë© ®à¤¥à ­¥ ­ ©¤¥­");
    end;
  
    documentNumber = rs.value("t_DocumentNumber");
    DtTmSplit(rs.value("t_Date"), docDate);

    payerName = rs.value("t_PayerName");

    if ( ( ValType( rs.value("t_DebitAccount") ) == V_STRING )  AND  ( StrLen( rs.value("t_DebitAccount") ) > 1 ) )
      debitAccount = rs.value("t_DebitAccount");
    elif ( ( ValType( rs.value("t_PayerAccount") ) == V_STRING )  AND  ( StrLen( rs.value("t_PayerAccount") ) > 1 ) )
      debitAccount = rs.value("t_PayerAccount");
    end;

    if ( ( ValType( rs.value("t_ReceiverAccount") ) == V_STRING )  AND  ( StrLen( rs.value("t_ReceiverAccount") ) > 1 ) )
      creditAccount = rs.value("t_ReceiverAccount");
    elif ( ( ValType( rs.value("t_CreditAccount") ) == V_STRING )  AND  ( StrLen( rs.value("t_CreditAccount") ) > 1 ) )
      creditAccount = rs.value("t_CreditAccount");
    end;

    debitAmount = rs.value("t_DebitAmount");
    creditAmount = rs.value("t_CreditAmount");
    if ( ValType( rs.value("t_DebitCurrCode") ) == V_INTEGER )
      debitCurr = rs.value("t_DebitCurrCode");
    else
      debitCurr = 0;
    end;
    if ( ValType( rs.value("t_CreditCurrCode") ) == V_INTEGER )
      creditCurr = rs.value("t_CreditCurrCode");
    end;
    opCipher = rs.value("t_OperationCipher");
    receiverName = rs.value("t_ReceiverName");
    getReceiverInfo(rs);

    loadDocAccounts();
    if (receiver.size == 0)
      addReceiverAccount(DocAccount(rs.value("t_CreditAccount"), rs.value("t_ReceiverAccount"), rs.value("t_DebitAmount"), rs.value("t_DebitCashSymbol"), rs.value("t_CreditCurrCode"), rs.value("t_DebitAmount")));
    end;

    debitCurrCode = rs.value("t_DebitCurrCode");

    var BankID = 0;
    if ( ValType( rs.value("t_ReceiverBankPartyID") ) == V_INTEGER )
      BankID = rs.value("t_ReceiverBankPartyID");
    elif ( ValType( rs.value("t_ReceiverBankTempPartyID") ) == V_INTEGER )
      BankID = rs.value("t_ReceiverBankTempPartyID");
    end;
    if ( BankID > 0 )
      var partyrec = RsbParty(BankID);
      receiverBankName = partyrec.FullName;
      receiverBankBIK = partyrec.Code(I_PTCK_BIC);
    end;
    
    BankID = 0;
    if ( ValType( rs.value("t_PayerBankPartyID") ) == V_INTEGER )
      BankID = rs.value("t_PayerBankPartyID");
    elif ( ValType( rs.value("t_PayerBankTempPartyID") ) == V_INTEGER )
      BankID = rs.value("t_PayerBankTempPartyID");
    end;
    if ( BankID > 0 )
      var partypay = RsbParty(BankID);
      payerBankName = partypay.FullName;
      payerBankBIK = partypay.Code(I_PTCK_BIC);
    end;
    
    sumStr = CurToStrAlt(debitAmount, null, null, int(getExtCurr(debitCurrCode)));
    ground = rs.value("t_Ground");
    operName = makeOperName(rs.value("t_Oper"));
    operWork = GetNameTypePerson();
    cashierName = makeOperName(rs.value("t_Cashier"));
    cashierWork = GetNameTypePerson();
  end;


  private macro printAccountGroup(params:RepParams, index:integer)
    if (receiverGroup.size > index)
      params.add(receiverGroup[index].CashSymbol);
      params.add(MoneyToStr(receiverGroup[index].CorrespondingAmount), ":r");
    else
      params.add("");
      params.add("");
    end;
  end;

  private macro _DateToStr( _date )
    var s = DateToStr( _date );
    var str;
    if ( SubStr( s, 2, 1 ) == " " )
      str = "0" + s;
    else
      str = s;
    end;
    return str;
  end;

  private macro _Rec_Acc( _recAcc, _Acc )
    var retAcc;
    if ( StrLen( _recAcc ) > 1 )
      retAcc = _recAcc;
    else
      retAcc = _Acc;
    end;
    return retAcc;
  end;


  private macro makeOrder(first_index:integer)
    var template = "";
    var params = RepParams;
    var vAccCredit;
    var flagCredCurr = TRUE;
    var flagAdd = FALSE;
    var payerNameArray;

    if ( StrLen( payerName ) > 0 )
      payerNameArray = StrSplit2(payerName, 28, 20, 3);
    else
      payerNameArray = StrSplit2("   ", 1, 1, 3);
    end;

    if ( ( debitCurr == 0 )  AND  ( creditCurr == 0 )  AND  ( receiver[first_index].CurrCode == 0 ) )
      flagSymCurr = FALSE;
    end;

    flagCredCurr = flagSymCurr;

    if ( ( first_index == 0 )  AND  ( debitCurr == creditCurr ) )
      flagCredCurr = FALSE;
    end;

    template = template +
        "                                 ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿   Ú Ä Ä Ä Ä Ä Ä Ä Ä Ä Ä Ä ¿" + "\n" +
        "                                 ³     Š®¤ ä®à¬ë     ³        âàë¢­®© â «®­ ª    " + "\n" +
        "                                 ³ ¤®ªã¬¥­â  ¯® Š“„ ³   ³  ¯à¨å®¤­®¬ã ª áá®¢®¬ã ³" + "\n" +
        "                                 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´       ®à¤¥àã N #########   " + "\n" +
        "                                 ³      0402008      ³   À Ä Ä Ä Ä Ä Ä Ä Ä Ä Ä Ä Ù" + "\n" +
        "                                 ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ                            " + "\n" +
        "                          ÚÄÄÄÄÄÄÄÄÄ¿                    ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿" + "\n" +
        "à¨å®¤­ë© ª áá®¢ë© ®à¤¥à N³#########³ ################## ³   Œ¥áâ® ¤«ï ­ ª«¥©ª¨  ³" + "\n" +
        "                          ÀÄÄÄÄÄÄÄÄÄÙ       „ â          ³    ®âàë¢­®£® â «®­    ³" + "\n" +
        "                                                         ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´" + "\n" +
        "                                       „……’             ³     ‘ã¬¬  æ¨äà ¬¨     ³" + "\n" +
        "â ª®£® #####################ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄ´" + "\n" +
        "#############################³‘ç¥â N ####################³### ############³      ³" + "\n" +
        "#############################³                           ³                ³      ³" + "\n" +
        "ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´                ³      ³" + "\n";
    params.add(documentNumber, ":l");
    params.add(documentNumber, ":c");
    params.add(_DateToStr(docDate));
    params.add(payerNameArray[0]);
    params.add(payerNameArray[1]);
    params.add(debitAccount);
    params.add(getSymbCodeCurr(debitCurr,flagSymCurr));
    params.add(MoneyToStr(debitAmount), ":r");
    params.add(payerNameArray[2]);

    var receiver_count = receiver.size - first_index;
    if (receiver_count > MaxNumAccount)
      receiver_count = MaxNumAccount;
    end;
    
    var receiverNameArray;
    var count = 0;

    if ( StrLen( receiverName ) > 0 )
      receiverNameArray = StrSplit2(receiverName, 28, 17, 1 + receiver_count * 2);
    else
      receiverNameArray = StrSplit2( "        ", 1, 1, 1 + receiver_count * 2);
    end;

    if ( StrLen( creditAccount ) > 1 )
      flagAdd = FALSE;
    else
      flagAdd = TRUE;
      if ( StrLen( receiver[first_index].Internal ) > 1 )
        creditAccount = receiver[first_index].Internal;
      else
        creditAccount = receiver[first_index].Account;
      end;
    end;

    template = template +
        "                                        Š…„ˆ’           ³                ³      ³" + "\n" +
        "ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´                ³      ³" + "\n" +
        "®«ãç â¥«ì ##################³‘ç¥â N ####################³### ############³      ³" + "\n" +
        "#############################ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´                ³      ³" + "\n";
    params.add(receiverNameArray[0]);
    params.add(creditAccount);

    if ( ( ( receiver.size != 1 )  AND  flagAdd )  OR  ( debitCurrCode != receiver[0].CurrCode ) )
      if ( creditCurr > -1 )
        params.add(getSymbCodeCurr(creditCurr,flagSymCurr));
      else
        params.add(getSymbCodeCurr(receiver[0].CurrCode,flagCredCurr));
      end;
      params.add(MoneyToStr(creditAmount), ":r");
    else
      params.add(" ");
      params.add("", ":r");
    end;
    
    params.add(receiverNameArray[1]);
    count = count + 1;

    if ( flagAdd )
      while (count < receiver_count)
        template = template +
            "#############################³‘ç¥â N ####################³### ############³      ³" + "\n" +
            "#############################ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´                ³      ³" + "\n";
        params.add(receiverNameArray[count * 2]);
        if ( StrLen( receiver[first_index + count].Internal ) > 1 )
          creditAccount = receiver[first_index + count].Internal;
        else
          creditAccount = receiver[first_index + count].Account;
        end;
        params.add(creditAccount);
        params.add(getSymbCodeCurr(receiver[first_index + count].CurrCode,flagCredCurr));
        params.add(MoneyToStr(receiver[first_index + count].Amount), ":r");
        params.add(receiverNameArray[count * 2 + 1]);
        count = count + 1;
      end;
    end;

    template = template +
        "#############################³                           ³                ³      ³" + "\n" +
        "ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄ´" + "\n";
    params.add(receiverNameArray[count * 2]);


    var receiverBankNameArray = StrSplit2(receiverBankName, 56, 25, 3);
    var payerBankNameArray = StrSplit2(payerBankName, 56, 26, 4);
    var sumStrArray = StrSplit2(sumStr, 76, 56, 3);
    var groundArray = StrSplit2(ground, 76, 54, 3);

    var aOperWork       = StrSplit2( operWork,        9,  9, 2 );
    var aOperName       = StrSplit2( operName,       15, 15, 2 );
    var aCashierWork    = StrSplit2( cashierWork,     9,  9, 2 );
    var aCashierName    = StrSplit2( cashierName,    15, 15, 2 );

    template = template +
        " ˆ #################  ‘ç¥â N ######################### ³      ¢ â®¬ ç¨á«¥      ³" + "\n" +
        "                                                         ³      ¯® á¨¬¢®« ¬:     ³" + "\n" +
        "  ¨¬¥­®¢ ­¨¥ ¡ ­ª -¢­®á¨â¥«ï ###########################ÃÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´" + "\n" +
        "#########################################################³ á¨¬¢®« ³     áã¬¬     ³" + "\n" +
        "#########################################################ÃÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´" + "\n" +
        "######################## ˆŠ ##########################  ³  ###   ³##############³" + "\n" +
        "ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´" + "\n" +
        "  ¨¬¥­®¢ ­¨¥ ¡ ­ª -¯®«ãç â¥«ï ##########################³  ###   ³##############³" + "\n" +
        "#########################################################ÃÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´" + "\n" +
        "######################## ˆŠ ##########################  ³  ###   ³##############³" + "\n" +
        "ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´" + "\n" +
        " ‘ã¬¬  ¯à®¯¨áìî                                          ³  ###   ³##############³" + "\n" +
        "#########################################################ÃÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÂÄÄÄ´" + "\n" +
        "#########################################################³  ˜¨äà ¤®ªã¬¥­â    ³###³" + "\n" +
        "#########################################################ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÙ" + "\n" +
        "ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ                         " + "\n" +
        " ˆáâ®ç­¨ª ¯®áâã¯«¥­¨ï ########################################################### " + "\n" +
        "################################################################################# " + "\n" +
        "################################################################################# " + "\n" +
        "                                                                                  " + "\n" +
        "                      #########           /###############   #########           /############### " + "\n" +
        " ‚­®á¨â¥«ì            #########            ###############   #########            ############### " + "\n" +
        "           ---------- --------- ---------- ---------------   --------- ---------- --------------- " + "\n" +
        "            («¨ç­ ï   (­ ¨¬¥­®-  («¨ç­ ï      (ä ¬¨«¨ï,      (­ ¨¬¥­®-  («¨ç­ ï      (ä ¬¨«¨ï,    " + "\n" +
        "             ¯®¤¯¨áì) ¢ ­¨¥ ¤®«-  ¯®¤¯¨áì)     ¨­¨æ¨ «ë)     ¢ ­¨¥ ¤®«-  ¯®¤¯¨áì)     ¨­¨æ¨ «ë)   " + "\n" +
        "                      ¦­®áâ¨)                                ¦­®áâ¨) " + "\n" +
        "                                                                     " + "\n";

    params.add(receiverINN);
    params.add( _Rec_Acc( receiverAccount, receiver[first_index].Account ) );
    params.add(payerBankNameArray[0]);
    params.add(payerBankNameArray[1]);
    params.add(payerBankNameArray[2]);
    params.add(payerBankNameArray[3]);
    params.add(payerBankBIK);
    printAccountGroup(params, 0);
    params.add(receiverBankNameArray[0]);
    printAccountGroup(params, 1);
    params.add(receiverBankNameArray[1]);
    params.add(receiverBankNameArray[2]);
    params.add(receiverBankBIK);
    printAccountGroup(params, 2);
    printAccountGroup(params, 3);
    params.add(sumStrArray[0]);
    params.add(sumStrArray[1]);
    params.add(opCipher);
    params.add(sumStrArray[2]);
    params.add(groundArray[0]);
    params.add(groundArray[1]);
    params.add(groundArray[2]);
    params.add(aOperWork[0]);
    params.add(aOperName[0]);
    params.add(aCashierWork[0]);
    params.add(aCashierName[0]);
    params.add(aOperWork[1]);
    params.add(aOperName[1]);
    params.add(aCashierWork[1]);
    params.add(aCashierName[1]);

    template = "\n" + template;
    var str = "rep.AutoScan(\"[\" + template + \"]()\"," +  params.getList() + ")";
    ExecExp(str);
  end;


  macro printOrder( FileNameTxt:string, Copies:integer )
    var TempRep = "", FileNameOffic = "";

    init();
    
    // Œ¥­ï¥¬ èà¨äâ ¯®-ã¬®«ç ­¨î, çâ®¡ë ®âç¥â ¢ Word-¥ ¢«¥§ ¢ «¨áâ ä®à¬ â  €4
    rep.SetDefaultFontSize(8);

    makeOrder(0);
    
    FileNameOffic = "IKO" + StrSubst( string({curdate}), ".", "" );
                                        
    if (FileNameTxt == null)
      FileNameTxt = FileNameOffic + "." + string({CNum});
    end;

    rep.SetFileNameWin( FileNameOffic );

//    SetOutPut( GetRegVal( "BANK_INI\\™ˆ… €€Œ…’›\\„ˆ…Š’ˆˆ\\TEXTDIR" ) + "\\" + FileNameTxt );

    if ( ( ORDER_PRINT_FORMAT == OPF_TXT      ) or ( ORDER_PRINT_FORMAT == OPF_MSOFFICE_TXT ) )
      RT_PrintRep( rep, Copies );
    end;
    if ( ( ORDER_PRINT_FORMAT == OPF_MSOFFICE ) or ( ORDER_PRINT_FORMAT == OPF_MSOFFICE_TXT ) )
      rep.SetWinRepOutPut( 0, 0 );
      rep.AddWinRepOutput( WINREP_OUTPUT_WORD, WINREP_FORMAT_DOC );
      rep.SetExecuteWord( "WordDocument.PageSetup.LeftMargin = 20;" );
      rep.SetExecuteWord( "WordDocument.PageSetup.TopMargin  = 20;" );
      rep.PrintWinRep();
      RT_PrintOut_Doc( rep, Copies );
      rep.ShowWinRep();
    end;
  end;

end;


macro PrintRTDocumentCI( RTDocID:integer, FileNameTxt:string, Copies:integer ):integer
  var order = IKO(RTDocID);
  order.printOrder( FileNameTxt, Copies );
end;

