/**************************************************************************\
*  ---------------                                                         *
*  R-Style Softlab                                                         *
*  ---------------                                                         *
*  RS-Retail                                                               *
*                                                                          *
*  АРМ Бухгалтера                                                          *
*                                                                          *
*  Сверка баланса (оборотов) аналитических и синтетических счетов          *
*                                                                          *
*  Для работы надо настроить массивы счетов для вкладных операций          *
*  (ADepAccs) и кассовых ресурсов (ACashResAccs)                           *
*                                                                          *
*  Лебедев С.В.                                                            *
*  22.11.2002                                                              *
\**************************************************************************/

import rsd, DeprIntr, "cur_rate.mac";

/* Файлы RS-Retail */
file currency ( currency ) key 0;
file revisbln ( "revisbln.tmp" ) key 0 write;

/* Файлы RS-Bank */
var account   : TBFile;
var accountc  : TBFile;
var obacnt    : TBFile;
var obacntc   : TBFile;
var arhdoc    : TBFile;
var arhdocc   : TBFile;
var obdocar   : TBFile;
var obdocarc  : TBFile;
var restdate  : TBFile;
var restdatc  : TBFile;
var obrestd   : TBFile;
var obrestdc  : TBFile;
var fininstr  : TBFile;
var fbankdate : TBFile;
var postdoc   : TBFile;
var postdocc  : TBFile;
var obdocps   : TBFile;
var obdocpsc  : TBFile;

var {curdate};
var Bank_Ver = BankVer( );
var Branch   = -1;
var CodeCurr = -1;
var bankdate = Date( 0, 0, 0 );

const UndefAcc = 0;
const DeposAcc = 1;
const CashAcc  = 2;
const OtherAcc = 3;

var SummaryForFirstOrder = true; /* Итоги по балансовым счетам первого или второго порядка */

var need_print_bot_cr = false;
var need_print_bot_ba = false;
var first_page        = true;

/* Итоговые суммы */
var SBASummaDbRt     = 0L,  SSummaDbRt     = 0L;
var SBASummaCrRt     = 0L,  SSummaCrRt     = 0L;
var SBAInputRestRt   = 0L,  SInputRestRt   = 0L;
var SBAOutputRestRt  = 0L,  SOutputRestRt  = 0L;
var SBASummaDbBn     = 0L,  SSummaDbBn     = 0L;
var SBASummaCrBn     = 0L,  SSummaCrBn     = 0L;
var SBAInputRestBn   = 0L,  SInputRestBn   = 0L;
var SBAOutputRestBn  = 0L,  SOutputRestBn  = 0L;
var SBADeltaRtBn     = 0L,  SDeltaRtBn     = 0L;
var SBADeltaCrRtBn   = 0L,  SDeltaCrRtBn   = 0L;
 
/* Панель ввода данных для отчета */
record P_REVISBLN  ( "REVISBLN" ) dialog;
const ne_DateReport        = 0;
const ne_NameBranch        = 1;
const ne_ShName            = 2;
const ne_NameCurrency      = 3;
const ne_ExcludeAccCashRes = 4;
const ne_ExcludeAccOther   = 5;

array ABranches;

/* Счета вкладных операций */
array ADepAccs;
 ADepAccs( 0 ) = "423";
 ADepAccs( 1 ) = "426";
 ADepAccs( 2 ) = "40813";
 ADepAccs( 3 ) = "474";
/* Счета кассовых ресурсов */
array ACashResAccs;
 ACashResAccs( 0 ) = "202";


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro HeadReport

  var NameCur    = "";
  var RateCur    = 0;
  var Name_Bank  = "";
  var BranchFind = Branch;
  var dep_name;

  currency.Code_Currency = revisbln.CodCur;
  if ( GetEQ( currency ) )
    NameCur = currency.Name_Currency + " (" + currency.ExternalCode + ")";
  end;

  if ( currency.Code_Currency == 0 )
    RateCur = 1.0;
  elif ( GetAllCurrRate( P_REVISBLN.DateReport, revisbln.CodCur, RateCur ) )
    ;
  else
    RateCur = 0;
  end;

  if ( RateCur == 0 )
    RateCur = "Не найден";
  else
    RateCur = String( RateCur:0:4 );
  end;

  Name_Bank = GetBankName( );
  if ( Branch == -1 )
    BranchFind = 0;
  end;
  if ( findDepartment(BranchFind, dep_name) )
    if ( dep_name != "" )
      Name_Bank = Name_Bank + " (" + dep_name + ")";
    end;
  end;

  if ( first_page )
    first_page = false;
  else
    println( StrFor( 12 ) );
  end;

  [ ];
  [ #]
  ( Name_Bank );
  [                                                   СВЕРКА СИНТЕТИЧЕСКИХ И АНАЛИТИЧЕСКИХ ДАННЫХ];
  [                                                           по состоянию за ##########]
  ( P_REVISBLN.DateReport:f );
  [                                                                                                                                                Валюта   #]
  ( NameCur );
  [                                                                                                                                                Курс ЦБ  #]
  ( RateCur );
  [ ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------];
  [ |     |                      |                    |              По данным RS-Retail              |               По данным RS-Bank               | Расхождение остатков  |            |];
  [ |№ б/с|   № лицевого счета   | Наименование счета |-----------------------------------------------------------------------------------------------|-----------------------| Примечание |];
  [ |     |                      |                    |Вх.остаток |   Дебет   |  Кредит   |Исх.остаток|Вх.остаток |   Дебет   |   Кредит  |Исх.остаток|   Дебет   |  Кредит   |            |];
  [ ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------];

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro BottomForBA ( NumberBalAcc )

  [ ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------];
  [ |                             Итого по б/c #      |           |###########|###########|           |###########|###########|###########|###########|###########|###########|            |]
  ( NumberBalAcc, SBASummaDbRt:11:2, SBASummaCrRt:11:2, SBAInputRestBn:11:2, SBASummaDbBn:11:2, SBASummaCrBn:11:2, SBAOutputRestBn:11:2, SBADeltaRtBn:11:2, SBADeltaCrRtBn:11:2 );
  [ ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------];

  SBASummaDbRt     = 0L;
  SBASummaCrRt     = 0L;
  SBAInputRestRt   = 0L;
  SBAOutputRestRt  = 0L;
  SBASummaDbBn     = 0L;
  SBASummaCrBn     = 0L;
  SBAInputRestBn   = 0L;
  SBAOutputRestBn  = 0L;
  SBADeltaRtBn     = 0L;
  SBADeltaCrRtBn   = 0L;

  need_print_bot_ba = false;
  
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro BottomReport

  [ |                                           ВСЕГО |           |###########|###########|           |###########|###########|###########|###########|###########|###########|            |]
  ( SSummaDbRt:11:2, SSummaCrRt:11:2, SInputRestBn:11:2, SSummaDbBn:11:2, SSummaCrBn:11:2, SOutputRestBn:11:2, SDeltaRtBn:11:2, SDeltaCrRtBn:11:2 );
  [ ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------];

  SSummaDbRt     = 0L;
  SSummaCrRt     = 0L;
  SInputRestRt   = 0L;
  SOutputRestRt  = 0L;
  SSummaDbBn     = 0L;
  SSummaCrBn     = 0L;
  SInputRestBn   = 0L;
  SOutputRestBn  = 0L;
  SDeltaRtBn     = 0L;
  SDeltaCrRtBn   = 0L;

  need_print_bot_cr = false;
  
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro PrintLine

  var name_account = GetAccountName( revisbln.Chapter, revisbln.Account, revisbln.CodCur );
  var notes        = "";
  var delta_sum    = $0L;
  var delta_sum_cr = $0L;

  delta_sum = revisbln.SummaDbRt - revisbln.SummaDbBn;
  if ( delta_sum < 0 )
    delta_sum = -delta_sum;
  end;

  delta_sum_cr = revisbln.SummaCrRt - revisbln.SummaCrBn;
  if ( delta_sum_cr < 0 )
    delta_sum_cr = -delta_sum_cr;
  end;

  if ( revisbln.CodeError == 1 )
    notes = "Лицевой счет в ОДБ не найден";
  elif ( revisbln.CodeError == 50 )
    notes = "Невозможно определить код валюты для ОДБ";
  elif ( revisbln.CodeError == 20 )
    notes = "Возможно имеются отложенные документы ОДБ";
  else
    if ( ( revisbln.SummaDbRt < ( revisbln.SummaDbPartRt + revisbln.SummaDbLoadRt ) ) or
         ( revisbln.SummaCrRt < ( revisbln.SummaCrPartRt + revisbln.SummaCrLoadRt ) )   )
      notes = "Возможно имеются невыгруженные документы RS-Retail";
    elif ( ( revisbln.SummaDbPartRt != 0 ) or
           ( revisbln.SummaCrPartRt != 0 )   )
      notes = "Возможно имеются частично выгруженные документы RS-Retail";
    end;
  end;

  [ |#####|######################|####################|           |###########|###########|           |###########|###########|###########|###########|###########|###########|############|]
  ( revisbln.BalAcc, Acc_Form(revisbln.Account), name_account:w, 
    revisbln.SummaDbRt:11:2, revisbln.SummaCrRt:11:2,
    revisbln.InputRestBn:11:2, revisbln.SummaDbBn:11:2, revisbln.SummaCrBn:11:2, revisbln.OutputRestBn:11:2,
    delta_sum:11:2, delta_sum_cr:11:2, notes:w );

  SBASummaDbRt    = SBASummaDbRt    + revisbln.SummaDbRt;
  SBASummaCrRt    = SBASummaCrRt    + revisbln.SummaCrRt;
  SBAInputRestRt  = SBAInputRestRt  + revisbln.InputRestRt;
  SBAOutputRestRt = SBAOutputRestRt + revisbln.OutputRestRt;
  SBASummaDbBn    = SBASummaDbBn    + revisbln.SummaDbBn;
  SBASummaCrBn    = SBASummaCrBn    + revisbln.SummaCrBn;
  SBAInputRestBn  = SBAInputRestBn  + revisbln.InputRestBn;
  SBAOutputRestBn = SBAOutputRestBn + revisbln.OutputRestBn;
  SBADeltaRtBn    = SBADeltaRtBn    + delta_sum;
  SBADeltaCrRtBn  = SBADeltaCrRtBn  + delta_sum_cr;

  SSummaDbRt    = SSummaDbRt    + revisbln.SummaDbRt;
  SSummaCrRt    = SSummaCrRt    + revisbln.SummaCrRt;
  SInputRestRt  = SInputRestRt  + revisbln.InputRestRt;
  SOutputRestRt = SOutputRestRt + revisbln.OutputRestRt;
  SSummaDbBn    = SSummaDbBn    + revisbln.SummaDbBn;
  SSummaCrBn    = SSummaCrBn    + revisbln.SummaCrBn;
  SInputRestBn  = SInputRestBn  + revisbln.InputRestBn;
  SOutputRestBn = SOutputRestBn + revisbln.OutputRestBn;
  SDeltaRtBn    = SDeltaRtBn    + delta_sum;
  SDeltaCrRtBn  = SDeltaCrRtBn  + delta_sum_cr;

  need_print_bot_cr = true;
  need_print_bot_ba = true;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro DefBalAccFromAccount

  var count_digit = 5;
  var ret_str;

  if ( SummaryForFirstOrder )
    count_digit = 3;
  end;

  if ( StrLen( revisbln.Account ) >= count_digit )
    ret_str = SubStr( revisbln.Account, 1, count_digit );
  else
    ret_str = revisbln.Account;
  end;

  return ret_str;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro PrintReport

  var stat;
  var prev_codcur = -1;
  var prev_ba     = "";

  if ( NRecords( revisbln ) == 0 )
    [ ];
    println( " За дату " + String( P_REVISBLN.DateReport:f ) + " нет данных для выпуска отчета" );
    return;
  end;

  KeyNum( revisbln, 2 );
  ReWind( revisbln );
  ClearRecord( revisbln );

  stat = GetGE( revisbln );

  if ( stat )
    prev_ba = DefBalAccFromAccount( );
  end;

  while ( stat )
    if ( prev_ba != DefBalAccFromAccount( ) )
      BottomForBA( prev_ba );
      prev_ba = DefBalAccFromAccount( );
    end;
    if ( prev_codcur != revisbln.CodCur )
      if ( need_print_bot_cr )
        BottomReport( );
      end;
      prev_codcur = revisbln.CodCur;
      HeadReport( );
    end;

    PrintLine( );

    stat = Next( revisbln );

  end;

  if ( need_print_bot_ba )
    BottomForBA( prev_ba );
  end;

  if ( need_print_bot_cr )
    BottomReport( );
  end;
  
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro CheckCurrency ( CheckCodCur )

  var ret_val = true;

  if ( ( CodeCurr < 0 ) or ( CheckCodCur == CodeCurr ) )
    ret_val = true;
  else
    ret_val = false;
  end;

  return ret_val;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro DefComplexOperInSummaryDocs

  var flag_compl = false;

  return flag_compl;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro CheckComplexOper

  var ret_val    = false;
     
  return ret_val;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro ClearTmpFile

   var cmd;
   cmd = RsdCommand( NULL, string("truncate table drevisbln_tmp") );
   cmd.execute();

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro RecFiltrForSummaryDoc ( num_branch_doc, code_curr_doc, state_doc )

  var stat = true;

  /* Фильтр по номеру подразделения */
  if ( stat )
    if ( ( Branch == -1 ) or ( Branch == num_branch_doc ) )
      ;
    else
      stat = false;
    end;
  end;

  /* Фильтр по коду валюты */
  if ( stat )
    if ( ( CodeCurr == -1 ) or ( CodeCurr == code_curr_doc ) )
      ;
    else
      stat = false;
    end;
  end;

  /* Фильтр на вошедшие в объединенные или раскрытые в сложную проводку */
  if ( stat )
    if ( state_doc >= 100 )
      stat = false;
    end;
  end;

  return stat;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro NeedWorkWithAccount ( num_account, type_acc )

  var stat = true;
  var i    = 0;
  var len_el;

  type_acc = UndefAcc;

  i = 0;
  while ( i < ASize( ADepAccs ) )
    len_el = StrLen( ADepAccs( i ) );
    if ( StrLen( num_account ) >= len_el )
      if ( SubStr( num_account, 1, len_el ) == ADepAccs( i ) )
        type_acc = DeposAcc;
        i = ASize( ADepAccs );
      end;
    end;
    i = i + 1;
  end;

  if ( type_acc == UndefAcc )
    i = 0;
    while ( i < ASize( ACashResAccs ) )
      len_el = StrLen( ACashResAccs( i ) );
      if ( StrLen( num_account ) >= len_el )
        if ( SubStr( num_account, 1, len_el ) == ACashResAccs( i ) )
          type_acc = CashAcc;
          i = ASize( ACashResAccs );
        end;
      end;
      i = i + 1;
    end;
  end;

  if ( ( type_acc == UndefAcc ) and ( StrLen( num_account ) > 0 ) )
    type_acc = OtherAcc;
  end;

  if ( type_acc == UndefAcc )
    stat = false;
  else
    if ( P_REVISBLN.ExcludeAccCashRes != "" )
      if ( type_acc == CashAcc )
        stat = false;
      end;
    end;
    if ( P_REVISBLN.ExcludeAccOther != "" )
      if ( type_acc == OtherAcc )
        stat = false;
      end;
    end;
  end;

  SetParm( 1, type_acc );

  return stat;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro FillRevisblnForBalSummary ( for_payer, type_acc )

  var stat       = false;

  return stat;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro FillRevisblnForNBalSummary ( for_payer, type_acc )

  var stat       = false;

  return stat;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro FormDataInTmpFile

  var ret_stat = false;

  return ret_stat;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro DefCodCurrForODB

  var ret_cod_curr = -1;

  if ( Bank_Ver == 500 )
    if ( revisbln.CodCur == 0 )
      ret_cod_curr = 0;
    else
      currency.Code_Currency = revisbln.CodCur;
      if ( GetEQ( currency ) )
        ret_cod_curr = Int( Trim( currency.ExternalCode ) );
      end;
    end;
  else
    currency.Code_Currency = revisbln.CodCur;
    if ( GetEQ( currency ) )
      fininstr.KeyNum = 1;
      fininstr.Clear;
      fininstr.rec.FI_Code = currency.ExternalCode;
      if ( fininstr.GetEQ )
        ret_cod_curr = fininstr.rec.FIID;
      end;
    end;
  end;

  return ret_cod_curr;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro FormDataInTmpFileInODB

  var stat;
  var stat_doc;
  var find_acc;
  var find_curr;
  var odb_cod_curr;
  var ret_stat = true;

  ReWind( revisbln );
  ClearRecord( revisbln );

  stat = GetGE( revisbln );

  while ( stat )

    find_curr = false;
    find_acc  = false;

    /* Определим код валюты для счета ОДБ ============================= */
    odb_cod_curr = DefCodCurrForODB( );
    if ( odb_cod_curr < 0 )
      find_curr = false;
      revisbln.CodeError = 50;
      ret_stat = Update( revisbln );
    else
      find_curr = true;
    end;

    /* Найдем счет в ОДБ ============================================== */
    if ( find_curr and ret_stat )
      if ( ( Bank_Ver == 500 ) and ( revisbln.Chapter > 1 ) )
        /* ---------------------------------------------------------- */
        if ( revisbln.CodCur == 0 )
          obacnt.rec.Chapter = revisbln.Chapter;
          obacnt.rec.Account = revisbln.Account;
          find_acc = obacnt.GetEQ;
          if ( find_acc and ( bankdate == P_REVISBLN.DateReport ) )
            revisbln.SummaDbBn = obacnt.rec.D0;
            revisbln.SummaCrBn = obacnt.rec.K0;
          end;
          if ( find_acc )
            obdocps.KeyNum = 2;
            obdocps.Clear;
            obdocps.rec.Chapter       = revisbln.Chapter;
            obdocps.rec.Account_Payer = revisbln.Account;
            obdocps.rec.Date_Document = P_REVISBLN.DateReport;
            if ( ( obdocps.GetGE                                      ) and
                 ( obdocps.rec.Chapter       == revisbln.Chapter      ) and
                 ( obdocps.rec.Account_Payer == revisbln.Account      ) and
                 ( obdocps.rec.Date_Document == P_REVISBLN.DateReport )    )
              revisbln.CodeError = 20;
            end;
            obdocps.KeyNum = 3;
            obdocps.Clear;
            obdocps.rec.Chapter          = revisbln.Chapter;
            obdocps.rec.Account_Receiver = revisbln.Account;
            obdocps.rec.Date_Document    = P_REVISBLN.DateReport;
            if ( ( obdocps.GetGE                                         ) and
                 ( obdocps.rec.Chapter          == revisbln.Chapter      ) and
                 ( obdocps.rec.Account_Receiver == revisbln.Account      ) and
                 ( obdocps.rec.Date_Document    == P_REVISBLN.DateReport )    )
              revisbln.CodeError = 20;
            end;
          end;
        /* ---------------------------------------------------------- */
        else
          obacntc.rec.Chapter       = revisbln.Chapter;
          obacntc.rec.Account       = revisbln.Account;
          obacntc.rec.Code_Currency = odb_cod_curr;
          find_acc = obacntc.GetEQ;
          if ( find_acc and ( bankdate == P_REVISBLN.DateReport ) )
            revisbln.SummaDbBn = obacntc.rec.D0;
            revisbln.SummaCrBn = obacntc.rec.K0;
          end;
          if ( find_acc )
            obdocpsc.KeyNum = 2;
            obdocpsc.Clear;
            obdocpsc.rec.Chapter       = revisbln.Chapter;
            obdocpsc.rec.Account_Payer = revisbln.Account;
            obdocpsc.rec.Code_Currency = odb_cod_curr;
            obdocpsc.rec.Date_Document = P_REVISBLN.DateReport;
            if ( ( obdocpsc.GetGE                                      ) and
                 ( obdocpsc.rec.Chapter       == revisbln.Chapter      ) and
                 ( obdocpsc.rec.Account_Payer == revisbln.Account      ) and
                 ( obdocpsc.rec.Code_Currency == odb_cod_curr          ) and
                 ( obdocpsc.rec.Date_Document == P_REVISBLN.DateReport )    )
              revisbln.CodeError = 20;
            end;
            obdocpsc.KeyNum = 3;
            obdocpsc.Clear;
            obdocpsc.rec.Chapter          = revisbln.Chapter;
            obdocpsc.rec.Account_Receiver = revisbln.Account;
            obdocpsc.rec.Code_Currency    = odb_cod_curr;
            obdocpsc.rec.Date_Document    = P_REVISBLN.DateReport;
            if ( ( obdocpsc.GetGE                                         ) and
                 ( obdocpsc.rec.Chapter          == revisbln.Chapter      ) and
                 ( obdocpsc.rec.Account_Receiver == revisbln.Account      ) and
                 ( obdocpsc.rec.Code_Currency    == odb_cod_curr          ) and
                 ( obdocpsc.rec.Date_Document    == P_REVISBLN.DateReport )    )
              revisbln.CodeError = 20;
            end;
          end;
        end;
      /* ------------------------------------------------------------ */
      elif ( revisbln.CodCur == 0 )
        account.rec.Account = revisbln.Account;
        if ( Bank_Ver != 500 )
          account.rec.Chapter = revisbln.Chapter;
        end;
        find_acc = account.GetEQ;
        if ( find_acc and ( bankdate == P_REVISBLN.DateReport ) )
          revisbln.SummaDbBn = account.rec.D0;
          revisbln.SummaCrBn = account.rec.K0;
        end;
        if ( find_acc and ( Bank_Ver == 500 ) )
          postdoc.KeyNum = 2;
          postdoc.Clear;
          postdoc.rec.Real_Payer    = revisbln.Account;
          postdoc.rec.Date_Document = P_REVISBLN.DateReport;
          if ( ( postdoc.GetGE                                      ) and
               ( postdoc.rec.Real_Payer    == revisbln.Account      ) and
               ( postdoc.rec.Date_Document == P_REVISBLN.DateReport )    )
            revisbln.CodeError = 20;
          end;
          postdoc.KeyNum = 3;
          postdoc.Clear;
          postdoc.rec.Real_Receiver = revisbln.Account;
          postdoc.rec.Date_Document = P_REVISBLN.DateReport;
          if ( ( postdoc.GetGE                                      ) and
               ( postdoc.rec.Real_Receiver == revisbln.Account      ) and
               ( postdoc.rec.Date_Document == P_REVISBLN.DateReport )    )
            revisbln.CodeError = 20;
          end;
        end;
      /* ------------------------------------------------------------ */
      else
        accountc.rec.Account       = revisbln.Account;
        accountc.rec.Code_Currency = odb_cod_curr;
        if ( Bank_Ver != 500 )
          accountc.rec.Chapter = revisbln.Chapter;
        end;
        find_acc = accountc.GetEQ;
        if ( find_acc and ( bankdate == P_REVISBLN.DateReport ) )
          revisbln.SummaDbBn = accountc.rec.D0;
          revisbln.SummaCrBn = accountc.rec.K0;
        end;
        if ( find_acc and ( Bank_Ver == 500 ) )
          postdocc.KeyNum = 2;
          postdocc.Clear;
          postdocc.rec.Real_Payer    = revisbln.Account;
          postdocc.rec.Code_Currency = odb_cod_curr;
          postdocc.rec.Date_Document = P_REVISBLN.DateReport;
          if ( ( postdocc.GetGE                                      ) and
               ( postdocc.rec.Real_Payer    == revisbln.Account      ) and
               ( postdocc.rec.Code_Currency == odb_cod_curr          ) and
               ( postdocc.rec.Date_Document == P_REVISBLN.DateReport )    )
            revisbln.CodeError = 20;
          end;
          postdocc.KeyNum = 3;
          postdocc.Clear;
          postdocc.rec.Real_Receiver = revisbln.Account;
          postdocc.rec.Code_Currency = odb_cod_curr;
          postdocc.rec.Date_Document = P_REVISBLN.DateReport;
          if ( ( postdocc.GetGE                                      ) and
               ( postdocc.rec.Real_Receiver == revisbln.Account      ) and
               ( postdocc.rec.Code_Currency == odb_cod_curr          ) and
               ( postdocc.rec.Date_Document == P_REVISBLN.DateReport )    )
            revisbln.CodeError = 20;
          end;
        end;
      end;

      if ( not find_acc )
        revisbln.CodeError = 1;
        ret_stat = Update( revisbln );
      end;
    end;

    /* Определим входящий и исходящие остатки по счету ОДБ ============ */
    if ( find_curr and find_acc and ret_stat )
      if ( ( Bank_Ver == 500 ) and ( revisbln.Chapter > 1 ) )
        if ( revisbln.CodCur == 0 )
          obrestd.rec.Chapter    = revisbln.Chapter;
          obrestd.rec.Account    = revisbln.Account;
          obrestd.rec.Date_Value = P_REVISBLN.DateReport - 1;
          if ( ( obrestd.GetLE                                 ) and 
               ( obrestd.rec.Chapter       == revisbln.Chapter ) and 
               ( obrestd.rec.Account       == revisbln.Account )    )
            revisbln.InputRestBn = obrestd.rec.Rest;
          end;
          obrestd.rec.Chapter    = revisbln.Chapter;
          obrestd.rec.Account    = revisbln.Account;
          obrestd.rec.Date_Value = P_REVISBLN.DateReport;
          if ( ( obrestd.GetLE                                 ) and 
               ( obrestd.rec.Chapter       == revisbln.Chapter ) and 
               ( obrestd.rec.Account       == revisbln.Account )    )
            revisbln.OutputRestBn = obrestd.rec.Rest;
          end;

        else
          obrestdc.rec.Chapter       = revisbln.Chapter;
          obrestdc.rec.Account       = revisbln.Account;
          obrestdc.rec.Code_Currency = odb_cod_curr;
          obrestdc.rec.Date_Value    = P_REVISBLN.DateReport - 1;
          if ( ( obrestdc.GetLE                                 ) and 
               ( obrestdc.rec.Chapter       == revisbln.Chapter ) and 
               ( obrestdc.rec.Account       == revisbln.Account ) and 
               ( obrestdc.rec.Code_Currency == odb_cod_curr     )    )
            revisbln.InputRestBn = obrestdc.rec.Rest;
          end;
          obrestdc.rec.Chapter       = revisbln.Chapter;
          obrestdc.rec.Account       = revisbln.Account;
          obrestdc.rec.Code_Currency = odb_cod_curr;
          obrestdc.rec.Date_Value    = P_REVISBLN.DateReport;
          if ( ( obrestdc.GetLE                                 ) and 
               ( obrestdc.rec.Chapter       == revisbln.Chapter ) and 
               ( obrestdc.rec.Account       == revisbln.Account ) and 
               ( obrestdc.rec.Code_Currency == odb_cod_curr     )    )
            revisbln.OutputRestBn = obrestdc.rec.Rest;
          end;
        end;
      elif ( revisbln.CodCur == 0 )
        restdate.rec.Account       = revisbln.Account;
        restdate.rec.Code_Currency = odb_cod_curr;
        if ( Bank_Ver == 500 )
          restdate.rec.Date_Carry = P_REVISBLN.DateReport - 1;
          if ( ( restdate.GetLE                                 ) and 
               ( restdate.rec.Account       == revisbln.Account ) and 
               ( restdate.rec.Code_Currency == odb_cod_curr     )    )
            revisbln.InputRestBn = restdate.rec.Rest;
          end;
        else
          restdate.rec.Chapter    = revisbln.Chapter;
          restdate.rec.Date_Value = P_REVISBLN.DateReport - 1;
          if ( ( restdate.GetLE                                 ) and 
               ( restdate.rec.Account       == revisbln.Account ) and 
               ( restdate.rec.Chapter       == revisbln.Chapter ) and 
               ( restdate.rec.Code_Currency == odb_cod_curr     )    )
            revisbln.InputRestBn = restdate.rec.Rest;
          end;
        end;
        restdate.rec.Account       = revisbln.Account;
        restdate.rec.Code_Currency = odb_cod_curr;
        if ( Bank_Ver == 500 )
          restdate.rec.Date_Carry = P_REVISBLN.DateReport;
          if ( ( restdate.GetLE                                 ) and 
               ( restdate.rec.Account       == revisbln.Account ) and 
               ( restdate.rec.Code_Currency == odb_cod_curr     )    )
            revisbln.OutputRestBn = restdate.rec.Rest;
          end;
        else
          restdate.rec.Chapter    = revisbln.Chapter;
          restdate.rec.Date_Value = P_REVISBLN.DateReport;
          if ( ( restdate.GetLE                                 ) and 
               ( restdate.rec.Account       == revisbln.Account ) and 
               ( restdate.rec.Chapter       == revisbln.Chapter ) and 
               ( restdate.rec.Code_Currency == odb_cod_curr     )    )
            revisbln.OutputRestBn = restdate.rec.Rest;
          end;
        end;
      else
        restdatc.rec.Account       = revisbln.Account;
        restdatc.rec.Code_Currency = odb_cod_curr;
        if ( Bank_Ver == 500 )
          restdatc.rec.Date_Carry = P_REVISBLN.DateReport - 1;
          if ( ( restdatc.GetLE                                 ) and 
               ( restdatc.rec.Account       == revisbln.Account ) and 
               ( restdatc.rec.Code_Currency == odb_cod_curr     )    )
            revisbln.InputRestBn = restdatc.rec.Rest;
          end;
        else
          restdatc.rec.Chapter    = revisbln.Chapter;
          restdatc.rec.Date_Value = P_REVISBLN.DateReport - 1;
          if ( ( restdatc.GetLE                                 ) and 
               ( restdatc.rec.Account       == revisbln.Account ) and 
               ( restdatc.rec.Chapter       == revisbln.Chapter ) and 
               ( restdatc.rec.Code_Currency == odb_cod_curr     )    )
            revisbln.InputRestBn = restdatc.rec.Rest;
          end;
        end;
        restdatc.rec.Account       = revisbln.Account;
        restdatc.rec.Code_Currency = odb_cod_curr;
        if ( Bank_Ver == 500 )
          restdatc.rec.Date_Carry = P_REVISBLN.DateReport;
          if ( ( restdatc.GetLE                                 ) and 
               ( restdatc.rec.Account       == revisbln.Account ) and 
               ( restdatc.rec.Code_Currency == odb_cod_curr     )    )
            revisbln.OutputRestBn = restdatc.rec.Rest;
          end;
        else
          restdatc.rec.Chapter    = revisbln.Chapter;
          restdatc.rec.Date_Value = P_REVISBLN.DateReport;
          if ( ( restdatc.GetLE                                 ) and 
               ( restdatc.rec.Account       == revisbln.Account ) and 
               ( restdatc.rec.Chapter       == revisbln.Chapter ) and 
               ( restdatc.rec.Code_Currency == odb_cod_curr     )    )
            revisbln.OutputRestBn = restdatc.rec.Rest;
          end;
        end;
      end;
    end;

    /* Определим дневные обороты по счету ОДБ ========================= */
    if ( find_curr and find_acc and ret_stat and ( bankdate != P_REVISBLN.DateReport ) )
      if ( ( Bank_Ver == 500 ) and ( revisbln.Chapter > 1 ) )
        if ( revisbln.CodCur == 0 )

          obdocar.KeyNum = 2;
          obdocar.Clear;
          obdocar.rec.Chapter       = revisbln.Chapter;
          obdocar.rec.Account_Payer = revisbln.Account;
          obdocar.rec.Date_Carry    = P_REVISBLN.DateReport;
          stat_doc = obdocar.GetGE;
          while ( stat_doc )
            if ( ( obdocar.rec.Chapter       == revisbln.Chapter      ) and
                 ( obdocar.rec.Account_Payer == revisbln.Account      ) and
                 ( obdocar.rec.Date_Carry    == P_REVISBLN.DateReport )    )
              revisbln.SummaDbBn = revisbln.SummaDbBn + obdocar.rec.Sum;
              stat_doc = obdocar.Next;
            else
              stat_doc = false;
            end;
          end;

          obdocar.KeyNum = 3;
          obdocar.Clear;
          obdocar.rec.Chapter          = revisbln.Chapter;
          obdocar.rec.Account_Receiver = revisbln.Account;
          obdocar.rec.Date_Carry       = P_REVISBLN.DateReport;
          while ( stat_doc )
            if ( ( obdocar.rec.Chapter          == revisbln.Chapter      ) and
                 ( obdocar.rec.Account_Receiver == revisbln.Account      ) and
                 ( obdocar.rec.Date_Carry       == P_REVISBLN.DateReport )    )
              revisbln.SummaCrBn = revisbln.SummaCrBn + obdocar.rec.Sum;
              stat_doc = obdocar.Next;
            else
              stat_doc = false;
            end;
          end;

        else

          obdocarc.KeyNum = 2;
          obdocarc.Clear;
          obdocarc.rec.Chapter       = revisbln.Chapter;
          obdocarc.rec.Account_Payer = revisbln.Account;
          obdocarc.rec.Code_Currency = odb_cod_curr;
          obdocarc.rec.Date_Carry    = P_REVISBLN.DateReport;
          stat_doc = obdocarc.GetGE;
          while ( stat_doc )
            if ( ( obdocarc.rec.Chapter       == revisbln.Chapter      ) and
                 ( obdocarc.rec.Account_Payer == revisbln.Account      ) and
                 ( obdocarc.rec.Code_Currency == odb_cod_curr          ) and
                 ( obdocarc.rec.Date_Carry    == P_REVISBLN.DateReport )    )
              revisbln.SummaDbBn = revisbln.SummaDbBn + obdocarc.rec.Sum;
              stat_doc = obdocarc.Next;
            else
              stat_doc = false;
            end;
          end;

          obdocarc.KeyNum = 3;
          obdocarc.Clear;
          obdocarc.rec.Chapter          = revisbln.Chapter;
          obdocarc.rec.Account_Receiver = revisbln.Account;
          obdocarc.rec.Code_Currency    = odb_cod_curr;
          obdocarc.rec.Date_Carry       = P_REVISBLN.DateReport;
          stat_doc = obdocarc.GetGE;
          while ( stat_doc )
            if ( ( obdocarc.rec.Chapter          == revisbln.Chapter      ) and
                 ( obdocarc.rec.Account_Receiver == revisbln.Account      ) and
                 ( obdocarc.rec.Code_Currency    == odb_cod_curr          ) and
                 ( obdocarc.rec.Date_Carry       == P_REVISBLN.DateReport )    )
              revisbln.SummaCrBn = revisbln.SummaCrBn + obdocarc.rec.Sum;
              stat_doc = obdocarc.Next;
            else
              stat_doc = false;
            end;
          end;

        end;
      elif ( revisbln.CodCur == 0 )
        if ( Bank_Ver == 500 )

          arhdoc.KeyNum = 1;
          arhdoc.Clear;
          arhdoc.rec.Real_Payer = revisbln.Account;
          arhdoc.rec.Date_Carry = P_REVISBLN.DateReport;
          stat_doc = arhdoc.GetGE;
          while ( stat_doc )
            if ( ( arhdoc.rec.Real_Payer == revisbln.Account      ) and
                 ( arhdoc.rec.Date_Carry == P_REVISBLN.DateReport )    )
              revisbln.SummaDbBn = revisbln.SummaDbBn + arhdoc.rec.Sum;
              stat = arhdoc.Next;
            else
              stat = false;
            end;
          end;
  
          arhdoc.KeyNum = 2;
          arhdoc.Clear;
          arhdoc.rec.Real_Receiver = revisbln.Account;
          arhdoc.rec.Date_Carry    = P_REVISBLN.DateReport;
          stat_doc = arhdoc.GetGE;
          while ( stat_doc )
            if ( ( arhdoc.rec.Real_Receiver == revisbln.Account      ) and
                 ( arhdoc.rec.Date_Carry    == P_REVISBLN.DateReport )    )
              revisbln.SummaCrBn = revisbln.SummaCrBn + arhdoc.rec.Sum;
              stat = arhdoc.Next;
            else
              stat = false;
            end;
          end;

        else

          arhdoc.KeyNum = 2;
          arhdoc.Clear;
          arhdoc.rec.Chapter       = revisbln.Chapter;
          arhdoc.rec.Account_Payer = revisbln.Account;
          arhdoc.rec.Date_Carry    = P_REVISBLN.DateReport;
          stat_doc = arhdoc.GetGE;
          while ( stat_doc )
            if ( ( arhdoc.rec.Chapter       == revisbln.Chapter      ) and
                 ( arhdoc.rec.Account_Payer == revisbln.Account      ) and
                 ( arhdoc.rec.Date_Carry    == P_REVISBLN.DateReport )    )
              revisbln.SummaDbBn = revisbln.SummaDbBn + arhdoc.rec.Sum;
              stat = arhdoc.Next;
            else
              stat = false;
            end;
          end;
  
          arhdoc.KeyNum = 3;
          arhdoc.Clear;
          arhdoc.rec.Chapter          = revisbln.Chapter;
          arhdoc.rec.Account_Receiver = revisbln.Account;
          arhdoc.rec.Date_Carry       = P_REVISBLN.DateReport;
          stat_doc = arhdoc.GetGE;
          while ( stat_doc )
            if ( ( arhdoc.rec.Chapter          == revisbln.Chapter      ) and
                 ( arhdoc.rec.Account_Receiver == revisbln.Account      ) and
                 ( arhdoc.rec.Date_Carry       == P_REVISBLN.DateReport )    )
              revisbln.SummaCrBn = revisbln.SummaCrBn + arhdoc.rec.Sum;
              stat = arhdoc.Next;
            else
              stat = false;
            end;
          end;

        end;
      else
        if ( Bank_Ver == 500 )

          arhdocc.KeyNum = 1;
          arhdocc.Clear;
          arhdocc.rec.Real_Payer    = revisbln.Account;
          arhdocc.rec.Code_Currency = odb_cod_curr;
          arhdocc.rec.Date_Carry    = P_REVISBLN.DateReport;
          stat_doc = arhdocc.GetGE;
          while ( stat_doc )
            if ( ( arhdocc.rec.Real_Payer    == revisbln.Account      ) and
                 ( arhdocc.rec.Code_Currency == odb_cod_curr          ) and
                 ( arhdocc.rec.Date_Carry    == P_REVISBLN.DateReport )    )
              revisbln.SummaDbBn = revisbln.SummaDbBn + arhdocc.rec.Sum;
              stat = arhdocc.Next;
            else
              stat = false;
            end;
          end;
  
          arhdocc.KeyNum = 2;
          arhdocc.Clear;
          arhdocc.rec.Real_Receiver = revisbln.Account;
          arhdocc.rec.Code_Currency = odb_cod_curr;
          arhdocc.rec.Date_Carry    = P_REVISBLN.DateReport;
          stat_doc = arhdocc.GetGE;
          while ( stat_doc )
            if ( ( arhdocc.rec.Real_Receiver == revisbln.Account      ) and
                 ( arhdocc.rec.Code_Currency == odb_cod_curr          ) and
                 ( arhdocc.rec.Date_Carry    == P_REVISBLN.DateReport )    )
              revisbln.SummaCrBn = revisbln.SummaCrBn + arhdocc.rec.Sum;
              stat = arhdocc.Next;
            else
              stat = false;
            end;
          end;

        else

          arhdocc.KeyNum = 2;
          arhdocc.Clear;
          arhdocc.rec.Chapter       = revisbln.Chapter;
          arhdocc.rec.Account_Payer = revisbln.Account;
          arhdocc.rec.Code_Currency = odb_cod_curr;
          arhdocc.rec.Date_Carry    = P_REVISBLN.DateReport;
          stat_doc = arhdocc.GetGE;
          while ( stat_doc )
            if ( ( arhdocc.rec.Chapter       == revisbln.Chapter      ) and
                 ( arhdocc.rec.Account_Payer == revisbln.Account      ) and
                 ( arhdocc.rec.Code_Currency == odb_cod_curr          ) and
                 ( arhdocc.rec.Date_Carry    == P_REVISBLN.DateReport )    )
              revisbln.SummaDbBn = revisbln.SummaDbBn + arhdocc.rec.Sum;
              stat = arhdocc.Next;
            else
              stat = false;
            end;
          end;
  
          arhdocc.KeyNum = 3;
          arhdocc.Clear;
          arhdocc.rec.Chapter          = revisbln.Chapter;
          arhdocc.rec.Account_Receiver = revisbln.Account;
          arhdocc.rec.Code_Currency    = odb_cod_curr;
          arhdocc.rec.Date_Carry       = P_REVISBLN.DateReport;
          stat_doc = arhdocc.GetGE;
          while ( stat_doc )
            if ( ( arhdocc.rec.Chapter          == revisbln.Chapter      ) and
                 ( arhdocc.rec.Account_Receiver == revisbln.Account      ) and
                 ( arhdocc.rec.Code_Currency    == odb_cod_curr          ) and
                 ( arhdocc.rec.Date_Carry       == P_REVISBLN.DateReport )    )
              revisbln.SummaCrBn = revisbln.SummaCrBn + arhdocc.rec.Sum;
              stat = arhdocc.Next;
            else
              stat = false;
            end;
          end;

        end;
      end;
    end;

    if ( find_acc and ret_stat )
      ret_stat = Update( revisbln );
    end;
  
    if ( ret_stat )
      stat = Next( revisbln );
    else
      stat = false;
    end;
  end;

  if ( not ret_stat )
    MsgBox( "Ошибка при обновлении данных во временном файле" );
  end;

  return ret_stat;
  
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro CheckExistFile ( name_file )

  /* В Oracle нет физических файлов
  var stat = ExistFile( name_file );

  if ( not stat )
    MsgBox( "Нет файла|" + name_file );
  end;

  return stat;
  */

  return true;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro OpenOneBankFile ( id_file, path_file, name_file, num_key, dic_name )

  var stat;

  id_file = Tbfile( name_file, "r", num_key );
  if ( id_file )
    ;
  else
    stat = false;
    MsgBox( "Ошибка при открытии файла|" + name_file );
  end;

  if ( stat )
    SetParm( 0, id_file );
  end;

  return stat;

end;


/**************************************************************************\
|                          Открытие файлов RS-Bank                         |
\**************************************************************************/
macro OpenBankFiles

  var Path     = "";
  var PathDic  = "";
  var PathFile = "";
  var stat     = true;
  var Len      = 0;

  Len = StrLen(Path);
  if (Len > 0)
    if (SubStr(Path,Len,1) != "\\")
      Path = Path + "\\";
    end;
  end;

  if ( stat )
    PathDic = Trim( Path + "BANK.DEF" );
    stat = CheckExistFile( PathDic );
  end;

  if ( stat )
    stat = OpenOneBankFile( account, Path, "account.dbt", 0, PathDic );
  end;

  if ( stat )
    stat = OpenOneBankFile( accountc, Path, "account$.dbt", 0, PathDic );
  end;

  if ( stat and ( Bank_Ver == 500 ) )
    stat = OpenOneBankFile( obacnt, Path, "obacnt.dbt", 0, PathDic );
  end;

  if ( stat and ( Bank_Ver == 500 ) )
    stat = OpenOneBankFile( obacntc, Path, "obacnt$.dbt", 0, PathDic );
  end;

  if ( stat )
    stat = OpenOneBankFile( arhdoc, Path, "arhdoc.dbt", 0, PathDic );
  end;

  if ( stat )
    stat = OpenOneBankFile( arhdocc, Path, "arhdoc$.dbt", 0, PathDic );
  end;

  if ( stat and ( Bank_Ver == 500 ) )
    stat = OpenOneBankFile( obdocar, Path, "obdocar.dbt", 0, PathDic );
  end;

  if ( stat and ( Bank_Ver == 500 ) )
    stat = OpenOneBankFile( obdocarc, Path, "obdocar$.dbt", 0, PathDic );
  end;

  if ( stat )
    stat = OpenOneBankFile( restdate, Path, "restdate.dbt", 0, PathDic );
  end;

  if ( stat )
    stat = OpenOneBankFile( restdatc, Path, "restdat$.dbt", 0, PathDic );
  end;

  if ( stat and ( Bank_Ver == 500 ) )
    stat = OpenOneBankFile( obrestd, Path, "obrestd.dbt", 0, PathDic );
  end;

  if ( stat and ( Bank_Ver == 500 ) )
    stat = OpenOneBankFile( obrestdc, Path, "obrestd$.dbt", 0, PathDic );
  end;

  if ( stat and ( Bank_Ver != 500 ) )
    stat = OpenOneBankFile( fininstr, Path, "fininstr.dbt", 0, PathDic );
  end;

  if ( stat and ( Bank_Ver == 500 ) )
    stat = OpenOneBankFile( postdoc, Path, "postdoc.dbt", 0, PathDic );
  end;

  if ( stat and ( Bank_Ver == 500 ) )
    stat = OpenOneBankFile( postdocc, Path, "postdoc$.dbt", 0, PathDic );
  end;

  if ( stat and ( Bank_Ver == 500 ) )
    stat = OpenOneBankFile( obdocps, Path, "obdocps.dbt", 0, PathDic );
  end;

  if ( stat and ( Bank_Ver == 500 ) )
    stat = OpenOneBankFile( obdocpsc, Path, "obdocps$.dbt", 0, PathDic );
  end;

  if ( stat )
    stat = OpenOneBankFile( fbankdate, Path, "curdate.dbt", 0, PathDic );
    if ( stat )
      fbankdate.Clear;
      stat = fbankdate.GetGE;
      if ( stat )
        bankdate = fbankdate.rec.curdate;
      else
        MsgBox( "Ошибка при определении даты ОДБ" );
      end;
    end;
  end;

  return stat;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro DefABranches

  var i;
  var dpDepList = TdpDepList;

  if ( Branch >= 0 )
    ABranches( 0 ) = Branch;
  else
    dpDepList.SetFilter(dpDepList.getFilialID(NumFNCash()));
    while ( dpDepList.next() );
      i = ASize( ABranches );
      ABranches( i ) = dpDepList.rec.Code;
    end;
  end;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro MakeReport

  var stat = true;

  if ( stat )
    DefABranches( );
  end;

  if ( stat )
    Message( " Открытие файлов ОДБ ...");
    stat = OpenBankFiles( );
    if ( not stat )
      Exit( 1 );
    end;
  end;

  if ( stat )
    Message( " Дораскрытие сложных проводок ...");
    stat = CheckComplexOper( );
    if ( not stat )
      Exit( 1 );
    end;
  end;

  if ( stat )
    Message( " Создание временного файла ...");
    stat = ClearTmpFile( ); 
    if ( not stat )
      Exit( 1 );
    end;
  end;

  if ( stat )
    Message( " Подсчет сумм по балансовым счетам ...");
    stat = FormDataInTmpFile( );
    if ( not stat )
      Exit( 1 );
    end;
  end;

  if ( stat )
    Message( " Подсчет сумм по балансовым счетам в ОДБ ...");
    stat = FormDataInTmpFileInODB( );
    if ( not stat )
      Exit( 1 );
    end;
  end;

  if ( stat ) 
    Message( " Вывод отчета ...");
    PrintReport( );
  end;
                                                            
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro List_Listfdep

  array ANumBranch, ANameBranch, ANameMenu;

  var i;
  var dpDepList = TdpDepList;

  dpDepList.SetFilter(dpDepList.getFilialID(NumFNCash()));
  while ( dpDepList.next() );
    i = ASize( ANameMenu );
    ANumBranch ( i ) = dpDepList.rec.Code;
    ANameBranch( i ) = dpDepList.rec.Name;
    ANameMenu  ( i ) = " " + dpDepList.rec.Name + MkStr( " ", 7 );
  end;

  if ( ASize( ANameMenu ) > 0 )
    i = Menu( ANameMenu," ~ESC~ Отказ  ~ENTER~ Выбор","Подразделения");
    if ( i >= 0 )
      Branch = ANumBranch( i );
      P_REVISBLN.NameBranch = ANameBranch( i );
    end;
  end;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro List_Currency

  array ACodeCurr, AShName, ANameCurrency, ANameMenu;

  var i;
  var stat;
                     
  ClearRecord( currency );
  ReWind( currency );
  stat = GetGE( currency );
  while ( stat )
    i = ASize( ANameMenu );
    ACodeCurr    ( i ) = currency.Code_Currency;
    AShName      ( i ) = currency.Short_Name;
    ANameCurrency( i ) = currency.Name_Currency;
    ANameMenu    ( i ) = " " + SubStr( currency.Short_Name + MkStr( " ", 3 ), 1, 3 ) + " " + currency.Name_Currency + " ";
    stat = Next( currency );
  end;

  if ( ASize( ANameMenu ) > 0 )
    i = Menu( ANameMenu," ~ESC~ Отказ  ~ENTER~ Выбор","Валюты");
    if ( i >= 0 )
      CodeCurr                = ACodeCurr    ( i );
      P_REVISBLN.ShName       = AShName      ( i );
      P_REVISBLN.NameCurrency = ANameCurrency( i );
    end;
  end;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro WorkDialogREVISBLN ( IP, cmd, id, codekey )

  var stat = CM_DEFAULT;

  if ( cmd == DLG_KEY )
    /* ENTER ======================================================== */
    if ( codekey == 13 )
      if ( id == ne_ExcludeAccOther )
        SetFocus( IP, ne_DateReport );
        stat = CM_IGNORE;
      end;
    /* ESC ========================================================== */
    elif ( codekey == 27 )
      stat = CM_CANCEL;
    /* Пробел ======================================================= */
    elif ( codekey == 32 )
      if ( id == ne_NameBranch )
        Branch = -1;
        P_REVISBLN.NameBranch = "Все";
      elif ( id == ne_ShName )
        CodeCurr = -1;
        P_REVISBLN.ShName       = "Все";
        P_REVISBLN.NameCurrency = "";
        UpdateFields( IP );
      elif ( id == ne_ExcludeAccCashRes )
        if ( P_REVISBLN.ExcludeAccCashRes == "" )
          P_REVISBLN.ExcludeAccCashRes = "X";
        else
          P_REVISBLN.ExcludeAccCashRes = "";
        end;
      elif ( id == ne_ExcludeAccOther )
        if ( P_REVISBLN.ExcludeAccOther == "" )
          P_REVISBLN.ExcludeAccOther = "X";
        else
          P_REVISBLN.ExcludeAccOther = "";
        end;
      end;
    /* F3 =========================================================== */
    elif ( codekey == 317 )
      if ( id == ne_NameBranch )
        List_Listfdep( );
      elif ( id == ne_ShName )
        List_Currency( );
        UpdateFields( IP );
      end;
    /* CtrlF3 ======================================================= */
    elif ( codekey == 352 )
      if ( id == ne_DateReport )
        P_REVISBLN.DateReport = {curdate};
      end;
    /* F7 =========================================================== */
    elif ( codekey == 321 )
      stat = CM_SAVE;
    end;
  end;

  return stat;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/

  ClearRecord( P_REVISBLN );
  P_REVISBLN.DateReport = {curdate};
  P_REVISBLN.NameBranch = "Все";
  P_REVISBLN.ShName     = "Все";

  if ( RunDialog( P_REVISBLN, "WorkDialogREVISBLN" ) )
    MakeReport( );
  else
    Exit( 1 );
  end;

end;
