/*
  RS-Retail 5.1  
  Выбор подозрительных операций для контроля их
  модулем "Финансовый мониторинг"
------------------------------------------------------------
  Общий модуль- глобальные переменные и константы
------------------------------------------------------------
  Ромодин Александр Васильевич
  19.03.2002
*/

Import RSD,CommonInter,  PTInter ,Globals ,FMInter;

/* ---------------------------------------------------------
   Настройки пользователей
*/
// Минимальная рублевая сумма для контроля
//scr#74076 const FM_P_MinSumRUR = $600000.00;
const FM_P_MinSumRUR = FM_GetMinSum(); //scr#100969
// Минимальная рублевая сумма для вставки документа на проверку однотипных документов
const FM_B_NeedCheckGroup = true;
const FM_P_MinSumRUR_ForCheckGroup = $10.00;
// Тип операции "Не вставлена" (фиктивный, только для передачи в отчет) 
const FM_NoNeedInsert = -999;
//Тип операции, чтобы вставить в fm_sh_op.tmp, когда операция уже есть в opcontr.dbt 
const FM_NeedInsertTmp = -777;//scr#100969 
// Файл клиентов
var  FCL = TClientList(true);
var  FCLProt = TClientList(true);
file PAPRKIND ("paprkind.dbt","bank.def")  key 0;
//
var GlobPaperName = "";
//
var cmdCountry = RsdCommand( "SELECT t_codenum3 FROM dcountry_dbt WHERE t_codelat3 = ?" );
    cmdCountry.addParam( "t_codelat3", RSDBP_IN );
/* ---------------------------------------------------------
   Версия RS-Bank, с которой взаимодействует Retail
*/
macro IsVer51
  var st = false;
  if (BankVer() == 510)
    st = true;
  else
    st = false;
  end;
  return st;
end;
const Ver51 = IsVer51();
/* ---------------------------------------------------------
   Временный файл
*/                         
var {CNum};
var WrkDir  = GetRegVal( "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR", true);
var NameLogFile  = WrkDir + "fm_log." +String({CNum});
/* ---------------------------------------------------------
   Глобальные структуры для связи с Управляющей программой
*/
record FMG_RET_OP   ("ret_op.dbt"); /* Запись по операции */
record FMG_FM_PARAM ("FM_PARAM."); /* Входные параметры  */
record FMG_FM_SH_OP ("fm_sh_op.tmp"); /* Подлежащая контролю операция */
record FMG_FM_SH_CL ("fm_sh_cl.tmp"); /* Клиент по операции */
var REC_FM_SH_CL; /* TRecHandler("fm_sh_cl.tmp") */
array ARR_FM_SH_CL; /* Клиенты по операции */
/* ------------------------------------------------------ */
file FM_CURRENCY ("currency.dbt")key 0; /* Справочник валют */
/* ---------------------------------------------------------
  Файлы модуля "Финансовый мониторинг " 
*/
var OPCONTR  : TBFile;
var OPCNTRPT : TBFile;
/* ---------------------------------------------------------
   Тип необходимого контроля операции
*/
const FM_NoCheck_Operation       = 0; /* Операция не подлежит контролю     */
const FM_TakeControl_Operation   = 1; /* Обязательный контроль             */
const FM_Shady_Operation         = 2; /* Подозрительная операция           */
const FM_TemporaryFile_Operation = 3; /* Помещена во временный файл для     
                                         проверки с однотипными операциями */
const FM_NeedCheck               = 10;//Подлежит контролю         
/* ---------------------------------------------------------
   Коды возврата
*/
const FM_OK  =     0; /* Нормальное завершение */
const FM_ERR = 18200; /* Общая ошибка          */
/* ---------------------------------------------------------
   Типы документов
*/
/* Документы вкладчика- sbdepdoc */
const SB_DEPOSIT   =    1;
const SB_DEPSC     =  110;
const SB_TRN       =  400;
const SB_LOGREC    = 3001; // Нефинансовая операция. Здесь - открытие вкладного договора
/* Коммунальные платежи- pay_doc, GroupOpert = 1 */
const SB_COMPAY    =   20;
/* Ценные бумаги- ci_doc */
const SB_CAPISSUE  =  300;
/* Прочие операции- pay_doc, GroupOpert = 11,21,31,41 */ 
const SB_CASHOPERT =  200;
/* Валютообменная (Обменный пункт)- exoperat (exchange.dbr) */                   
const SB_EXCHNDOC  =  260;
/* ---------------------------------------------------------
   Кто проводил операцию
*/
const ACCOUNT_OWNER       =  0; /* Владелец счета      */
const ACCOUNT_PROXY       =  1; /* Доверенное лицо     */
const ACCOUNT_HEIR        =  2; /* Наследник - выдачи  */
const ANONIMUS_CLIENT     =  3; /* Анонимный клиент    */
const ACCOUNT_IMPORTER    =  4; /* Вноситель           */
const ACCOUNT_TUTOR       =  5; /* Опекун              */
const ACCOUNT_OBLIGATOR   =  6; /* Под обязательство   */
const ACCOUNT_HEIR_PAY    =  7; /* Наследник - выплаты */
const ACCOUNT_UNDER_TRIAL =  8; /* По суду             */
const ACCOUNT_PARENT      =  9; /* Родитель            */
const ACCOUNT_RETRAST     = 10; /* Передоверие         */
const ACCOUNT_PARENT_WILL = 11; /* Родитель наследника */
const ACCOUNT_TUTOR_WILL  = 12; /* Опекун наследника   */
/* ---------------------------------------------------------
   Глобальные переменные
*/
//var {oper};
//var {curdate};

//#####################
//класс поиска информации об операциях
class fmFindForProtocol()
  //входные
//  var m_ApplicationKey:string;
  var m_iApplicationKind:integer;

//  var m_Op;
//  var m_SubOp;

//  m_ApplicationKey = "";
//  m_iApplicationKind = 0;
  
  //результирующие
  var out_op:string; //операция
  var out_subop:string; //подоперация
  var out_account:string; //счёт вкладчика
  var out_ordernumb:string; //номер документа                                                  
  out_op=""; //операция
  out_subop=""; //подоперация
  out_account=""; //счёт вкладчика
  out_ordernumb=""; //номер документа 
  

  macro GetIsCur()
    if( FMG_FM_SH_OP.Code_Currency >0)
      return 1;
    else
      return 0;
    end;  
  end;                      
                                                   
  
  //Функции поиска по 
  //==================
  //поиск для SB_DEPOSIT
  macro findSB_DEPOSIT():bool
 
   //var cmd_doc;
   //var rs_doc;

    var cmd_op;
    var rs_op;
    var type_Account;

    var cmd_subop;
    var rs_subop;
 
    if( (FMG_FM_SH_OP.Operation >= 300) or (FMG_FM_SH_OP.Operation <= 350) )
      type_Account = "Шаблонный";
    else
      type_Account = FMG_FM_SH_OP.Type_Account;
    end;

    //поиск операции в sb_typop
    cmd_op = RsdCommand(
      " SELECT t_czNameAlg FROM dsb_typop_dbt "+
      " WHERE t_Kind = '"+
      type_Account+   //string( rs_doc.Value("t_Type_Account") )+ //ДО ВОСТРЕБ.
      "' AND t_isCur = "+
      GetIsCur() +//string( rs_doc.Value("t_IsCur") )+//0
      " AND t_NumOpert = "+
      FMG_FM_SH_OP.Operation//string( m_Op ) //string( rs_doc.Value("t_TypeOper") )//1
    );
    cmd_op.execute();
    rs_op = RsdRecordset(cmd_op);
    if(rs_op.moveNext())
      out_op = rs_op.Value("t_czNameAlg");
    else
      out_op = "";
    end;
    
    //поиск подоперации в suboper.dbt
    cmd_subop = RsdCommand(
       "SELECT * FROM dsuboper_dbt "+
       "WHERE t_Kind = '"+
       type_Account+ //string( rs_doc.Value("t_Type_Account") )+//ДО ВОСТРЕБ.
       "' AND t_isCur = "+
       GetIsCur()+ //string( rs_doc.Value("t_IsCur") )+//0
       " AND t_OperType = "+
       FMG_FM_SH_OP.Operation +//string( m_Op ) + //string( rs_doc.Value("t_TypeOper") )  // 1        
       " AND t_Type = "+
       FMG_FM_SH_OP.SubOper //string( m_SubOp ) //string(rs_doc.Value("t_ApplType")) //subop       
    );          
    cmd_subop.execute();
    rs_subop = RsdRecordset(cmd_subop);
    if(rs_subop.moveNext())
      out_subop = rs_subop.Value("t_Name");
    else
      out_subop = "";
    end;
    
    return true;
   
  end;
  //==================
  
  //==================
  macro findSB_DEPSC():bool
    findSB_DEPOSIT();
  end;
  //==================
  
  //==================
  //поиск для SB_TRN
  macro findSB_TRN():bool
     findSB_DEPOSIT();
  end;
  //==================
  
  //==================
  //поиск для SB_CAPISSUE
  macro findSB_CAPISSUE():bool
 
 
   var cmd_op;
   var rs_op;

   var cmd_subop;
   var rs_subop;
      
    //поиск операции в ci_oper
    cmd_op = RsdCommand(
      " SELECT * FROM DCI_OPER_DBT "+
      " WHERE t_Type = "+//Тип ЦБ
      FMG_FM_SH_OP.AddOperType +  //string( rs_doc.Value("t_Type") )+ //1
      " AND t_Number = "+
      FMG_FM_SH_OP.Operation //string(m_Op) //string( rs_doc.Value("t_Operation") ) //3
    );
    cmd_op.execute();
    rs_op = RsdRecordset(cmd_op);
    if(rs_op.moveNext())
      out_op = rs_op.Value("t_Name");
    else
      out_op = "";
    end;
    
    //поиск подоперации в suboper.dbt
    cmd_subop = RsdCommand(
      " SELECT * FROM DCI_SUBOP_DBT "+
      " WHERE t_Type = "+
      string(FMG_FM_SH_OP.AddOperType) +//string( rs_doc.Value("t_Type") )+ //1   //тип ЦБ
      " AND t_Operation = "+
      FMG_FM_SH_OP.Operation + //string( m_Op )+  //string( rs_doc.Value("t_Operation") )+//3
      " AND t_SubOpNum = "+
      FMG_FM_SH_OP.SubOper //string( m_SubOp ) // string( rs_doc.Value("t_SubOp") )//0
    );          
    cmd_subop.execute();
    rs_subop = RsdRecordset(cmd_subop);
    if(rs_subop.moveNext())
      out_subop = rs_subop.Value("t_Name");
    else
      out_subop = "";
    end;
    
    return true;
 
  end;
  //==================
  
  //==================
  //поиск для SB_EXCHNDOC
  macro findSB_EXCHNDOC():bool
 
  
   var cmd_op;
   var rs_op;

   var cmd_subop;
   var rs_subop;
   
    //поиск операции в ci_oper
    cmd_op = RsdCommand(
      " SELECT * FROM DEXOPSET_DBT "+
      " WHERE t_Kind_Oper = "+
      FMG_FM_SH_OP.Operation + //string( m_Op )+ //string(rs_doc.Value("t_Kind_Oper"))+//18
      " AND t_SubOper = "+
      FMG_FM_SH_OP.SubOper 
      + //string( m_SubOp ) + //string(rs_doc.Value("t_SubOper"))+//  0
      "AND t_Branch = "+
      string(0) //FMG_FM_SH_OP.Branch //string(rs_doc.Value("t_Branch"))//1
    );
    cmd_op.execute();
    rs_op = RsdRecordset(cmd_op);
    if(rs_op.moveNext())
      out_op = rs_op.Value("t_Name");
      out_subop = "";//rs_op.Value("t_Name");
    else
      out_op = "";
      out_subop = "";
    end;
      
    return true;
 
  end;
  //==================
  
  

    //==================
  //поиск для SB_CASHOPERT
  macro findSB_CASHOPERT():bool
 
   var cmd_op;
   var rs_op;

   var cmd_subop;
   var rs_subop;
   
    //поиск операции в pay_kind
    cmd_op = RsdCommand(
       " SELECT * FROM DPAY_KIND_DBT "+
       " WHERE t_IsCur = "+
       GetIsCur() + //string( rs_doc.Value("t_IsCur") )+//1
       " AND t_GroupOpert = "+
       FMG_FM_SH_OP.AddOperType +//string( rs_doc.Value("t_GroupOpert") )+//31
       " AND t_NumOperat = "+
       FMG_FM_SH_OP.Operation //string(m_Op)//string( rs_doc.Value("t_NumOpert") )//6
    );
    cmd_op.execute();
    rs_op = RsdRecordset(cmd_op);
    if(rs_op.moveNext())
      out_op = rs_op.Value("t_szNameAlg");
    else
      out_op = "";
    end;
    
    //поиск подоперации 
    cmd_subop = RsdCommand(
       " SELECT * FROM DPAY_CSOP_DBT "+
       " WHERE  t_IsCur = "+
       GetIsCur() + //string( rs_doc.Value("t_IsCur") )+//1
       " AND t_GroupType = "+
       FMG_FM_SH_OP.AddOperType + //string( rs_doc.Value("t_GroupOpert") )+// 31
       " AND t_NumOperat = "+
       FMG_FM_SH_OP.Operation + //string(m_Op)+//string( rs_doc.Value("t_NumOpert") )+// 6
       " AND t_ApplType = "+
       FMG_FM_SH_OP.SubOper //string(m_SubOp)//string( rs_doc.Value("t_ApplType") )//1
    );          
    cmd_subop.execute();
    rs_subop = RsdRecordset(cmd_subop);
    if(rs_subop.moveNext())
      out_subop = rs_subop.Value("t_NameCompType");
    else
      out_subop = "";
    end;
    
    return true;
 
  end;
  //==================
 
  
  //==================
  //Поиск описания операции
  macro FindOpDescription ( //in_ApplicationKey:string,
                           in_iApplicationKind:integer
                           //in_Op:integer,
                           //in_SubOp:integer
                         )
    
    //задание параметров поиска 
    //m_ApplicationKey = in_ApplicationKey;
    m_iApplicationKind = in_iApplicationKind;
    //m_Op = in_Op;
    //m_SubOp = in_SubOp;*/
                             
    //поиск
    if ( (m_iApplicationKind == SB_DEPOSIT) 
     OR  (m_iApplicationKind == SB_LOGREC ) )
       return findSB_DEPOSIT();              
       
    elif (m_iApplicationKind == SB_DEPSC)
      return findSB_DEPSC();
      
    elif (m_iApplicationKind == SB_TRN)
      return findSB_TRN();
      
    elif (m_iApplicationKind == SB_CAPISSUE) 
      return findSB_CAPISSUE();
      
    elif (m_iApplicationKind == SB_EXCHNDOC) 
      return findSB_EXCHNDOC();
      
    elif (m_iApplicationKind == SB_CASHOPERT)
      return findSB_CASHOPERT();
 
    end;
    
    return false;
  end;//macro FindOpDescription

  /**************************************************************************/
  macro GetOp():string //операция
    
    if(
        ( ValType(out_op) != V_UNDEF )     
        and //&&
        ( StrLen(out_op) > 0 )      
      )
       return out_op;
    end;    
    return ""; 
  end; 

  /**************************************************************************/
  macro GetSubOp():string  //подоперация
    
    if(
        ( ValType(out_subop) != V_UNDEF )
        and //&&
        ( (StrLen(out_subop)) > 0 )
        and
        ( Trim(out_subop) != "Не задан" )
      )
         return string( " ("+out_subop+")" );
    end;      
    return ""; 
  end;
  
  /**************************************************************************/
  macro GetAccount():string  
    out_account = FMG_FM_SH_OP.Account;
    if(     
        ( ValType(out_account) != V_UNDEF )
        and 
        ( (StrLen(out_account)) > 3 )
//        ( (CodeFor(out_account)) > 100 )
      )
      
      return FMG_FM_SH_OP.Account;//out_account;
    end;
    return ""; //счёт вкладчика
  end;
    
  macro GetOrderNum():string
    if( StrLen(out_ordernumb) >1 )
      return out_ordernumb;
    end;
    return ""; //номер документа                                                  
  end;  
  
  /**************************************************************************/
  macro GetCurrencyISO ( CurrCode )
    /*var cmdFI, rsFI;*/
    var cmd, rs;
    var isoNumber = "";
    var codeInAccount = "";
    var codeISO = "";
    /*
    cmdFI = RsdCommand( "select * from DFININSTR_DBT where T_FIID = " + String( fiidCode ) );
    cmdFI.execute( );
    rsFI = RsdRecordSet( cmdFI );

    if ( rsFI.moveNext( ) )
      isoNumber = String( rsFI.value( "T_ISO_NUMBER" ) );
      codeInAccount = rsFI.value( "T_CODEINACCOUNT" );

      cmd = RsdCommand( "select * from DCURRENCY_DBT where T_EXTERNALCODE in ( '" + isoNumber + "', '" + codeInAccount + "' )" );
      cmd.execute( );
      rs = RsdRecordset( cmd );

      if ( rs.moveNext( ) )
        codeISO = rs.Value( "T_EXTERNALCODE" ) + " (" + rs.Value( "T_SHORT_NAME" ) + ")";  
      end;
      
    end;
    */
    cmd = RsdCommand( "select * from DCURRENCY_DBT where T_CODE_CURRENCY=?" );
    cmd.addParam ("CODE_CURRENCY", RSDBP_IN );
    cmd.value ("CODE_CURRENCY") = CurrCode;
    cmd.execute( );
    rs = RsdRecordset( cmd );

    if ( rs.moveNext( ) )
      codeISO = rs.Value( "T_EXTERNALCODE" ) + " (" + rs.Value( "T_SHORT_NAME" ) + ")";  
    end;
    
    return codeISO;
       
  end;

  /**************************************************************************/
  macro GetName():string
    if( StrLen(FMG_FM_SH_OP.Name)>1 )  
      return FMG_FM_SH_OP.Name;
    else
      //Подкачка имени клиента для отчёта
      if (NOT FCLProt.GetRecord (FMG_FM_SH_OP.Client,null,null,1))
            //MsgBox ("Не найден клиент с кодом "+string(FMG_FM_SH_OP.Client));
            //st = false;
      else
         FMG_FM_SH_OP.Name = FCLProt.CurRec.ConvertFIOFull ();
         return FMG_FM_SH_OP.Name;
      end;    
    end;     
    
    return "-";   
  end;
  
//  macro GetCodClient20( in_PartyId:integer ) : string
  macro GetCodClient20( ) : string
    
    if ( FMG_FM_SH_OP.Client == -1 )
      return "";
    end;

    var obParty = RsbParty( FMG_FM_SH_OP.Client );  
    var PartyCodeCl = "";
  
    PartyCodeCl = obParty.Code( PTCK_CLIENT );
   
    return PartyCodeCl;
  
  end;//GetCodClient20
  
end;//class fmFindForProtocol
//###################

/* ---------------------------------------------------------
   Класс файла- протокола
*/
class fmProtocol (NeedClear:bool)

/* Вывод сообщения */
  macro Write (MsgText)
    print   (MsgText);
    println ("");
  end;
/* Разделитель */
  macro WrLine
    this.Write ("------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------");
  end;
/* Заголовок */
  macro Header 
    this.Write ("      Контроль доходов, полученных преступным путем");
    this.Write ("              Выбор подозрительных операций");
    this.Write ("      ---------------------------------------------");
    this.Write ("");
    this.WrLine();
//    this.Write ("| ВСП | Вид опер-и | Номер опер-и | Операционист | Дата опер-и | Сумма опер-и (руб.)  |  Тип   | Код  |");
    //scr#97061 
    this.Write ("| Дата операции | Код по ФМ | No операции | Наименование операции | ФИО клиента                  | Код клиента | No счета                 | Сумма (руб.) | Сумма в номинале | Код валюты | Номер документа |");

    this.WrLine();
  end;
/* Строка отчета по операции */
  macro OperationReport
    var strType = "";
    var strVid  = String(FMG_FM_SH_OP.iApplicationKind);
    var NumCode = 1;
    var FieldName,
        FieldIndex;
    var CodeOper;
        
    var FindForProtocol;//scr#97061 
    var codcl = 0;
    
    if   (FMG_FM_SH_OP.Type == FM_TakeControl_Operation)
      strType = "  ОК";
    elif (FMG_FM_SH_OP.Type == FM_Shady_Operation)
      strType = "  НО";
    elif (FMG_FM_SH_OP.Type == FM_NoNeedInsert)
      strType = "В базе";
    elif (FMG_FM_SH_OP.Type == FM_NeedInsertTmp)
      strType = "В базе";
    end; 

    if (FMG_FM_SH_OP.iApplicationKind == SB_DEPOSIT) 
      strVid = "Вкладная";
    elif (FMG_FM_SH_OP.iApplicationKind == SB_DEPSC)
      strVid = "Пл.карта";
    elif (FMG_FM_SH_OP.iApplicationKind == SB_TRN)
      strVid = "Бн платеж";
    elif (FMG_FM_SH_OP.iApplicationKind == SB_CAPISSUE) 
      strVid = "Ц.бумаги";
    elif (FMG_FM_SH_OP.iApplicationKind == SB_EXCHNDOC) 
      strVid = "Вал.обмен";
    elif (FMG_FM_SH_OP.iApplicationKind == SB_CASHOPERT)
      strVid = "Кассовая";
    end;
    

    
    //Поиск данных об операции , scr#97061         
//    FindForProtocol = fmFindForProtocol;    
    FindForProtocol = fmFindForProtocol;    
    //FindForProtocol.FindOpDescription ( FMG_RET_OP.Oper, FMG_RET_OP.SubOp );
//    [1:########################## 2:########################### 3:############################ 4:########################]
//    (string(FMG_FM_SH_OP.ApplicationKey) , string(FMG_FM_SH_OP.iApplicationKind) ,  string(FMG_RET_OP.Operation) , string(FMG_RET_OP.SubOp));
//    FindForProtocol.FindOpDescription ( FMG_FM_SH_OP.ApplicationKey, FMG_FM_SH_OP.iApplicationKind ,  FMG_RET_OP.Operation, FMG_RET_OP.SubOp);    
  
    FindForProtocol.FindOpDescription ( FMG_FM_SH_OP.iApplicationKind );    
    
    if( FMG_FM_SH_OP.Client >=0)
      codcl = string(FMG_FM_SH_OP.Client);
    else
      codcl = "";  
    end;
                           
   //"| Дата операции | Код по ФМ | No операции | Наименование операции | ФИО клиента                  | Код клиента | No счёта                 | Сумма (руб.) | Сумма в номинале | Код валюты | Номер документа |");
     [| ############# | ######### | ########### | ##################### | ############################ | ########### | ######################## | ############ | ################ | ########## | ############### |]
     (
        FMG_FM_SH_OP.Date_Carry,                                         //Дата операции 
        FMG_FM_SH_OP.Code1,                                              //Код по ФМ
        FMG_FM_SH_OP.Operation,                                          //Номер операции 
        (FindForProtocol.GetOp() + FindForProtocol.GetSubOp() ):w, //Наименование операции
        FindForProtocol.GetName():w, //FMG_FM_SH_OP.Name:w,                                             //ФИО клиента
        FindForProtocol.GetCodClient20( ), //codcl, //FMG_FM_SH_OP.Client,     //Код клиента
        FindForProtocol.GetAccount():w,                                  //Номер счёта
        FMG_FM_SH_OP.SumRub,                                             //Сумма в рублях
        FMG_FM_SH_OP.SumCur,                                             //Сумма в номинале
        FindForProtocol.GetCurrencyISO (FMG_FM_SH_OP.Code_Currency),     //Код валюты
        FMG_FM_SH_OP.OrderNum                                            //Номер документа
     );
      
//    if (FMG_FM_SH_OP.Type == FM_NoNeedInsert)
//      this.Write (" (Операция была вставлена в файлы Финансового мониторинга раньше)");
//    end;
//  Коды операции
    NumCode = 1; // Поля от 2 до 10 (первое поле уже в отчете)
    while (NumCode < 10)
      NumCode = NumCode + 1;
      FieldName = "Code"+Trim(String(NumCode));
      FieldIndex = FldIndex(FMG_FM_SH_OP,FieldName);
      if (FieldIndex != -1)
        CodeOper = FMG_FM_SH_OP (FieldIndex);
        if (CodeOper != "")
//          [|     |            |              |              |             |                      |        | #### |]
[|               | ######### |             |                       |                              |             |                          |              |                  |            |                 |]   //scr#97061  
          (CodeOper);
        else
          NumCode = 100;
        end;
      else
        NumCode = 100;
      end;
    end;
    this.WrLine();
  end;             

  
/* Итоговый отчет */
  macro Total
    var d,mon,y,
        h,m,s;
    DateSplit (Date(),d,mon,y);
    TimeSplit(Time(),h,m,s);
    this.Write ("");
    this.WrLine();
    this.Write ("");
    this.Write ("");
    this.Write (" "+String(d)+" "+MonName(mon)+" "+String(y)+"    "+String(h)+":"+String(m));
    this.Write ("");
    [ Отобрано операций, подлежащих контролю с ########## по ##########](FMG_FM_PARAM.BeginDate,FMG_FM_PARAM.EndDate);
    this.Write ("");
    [ Обработано первичных документов             ###############](FMG_FM_PARAM.NumberOperation_Rev);
    this.Write ("");
    [ Всего операций                              ###############](FMG_FM_PARAM.NumberOperation_Rev);
    this.Write ("");
    [ В т.ч.];
    this.Write ("");
    [ Операции, подлежащие обязательному контролю ###############](FMG_FM_PARAM.NumberOperation_TakeC);
    this.Write ("");
    [ Необычные операции                          ###############](FMG_FM_PARAM.NumberOperation_Shady);
    this.Write ("");
    this.Write ("");
    this.WrLine();
  end;                   

/* Показать файл протокола */
  macro View
    file LogFile() txt 250;         /* Для просмотра протокола */
    SetOutput ();
    if (ExistFile(NameLogFile))
      if (Open(LogFile, NameLogFile))
        Close (LogFile);
        ViewFile (LogFile);
      end;       
    end;
  end;
  
/* Инициализация протокола */
  SetOutput (NameLogFile, (NOT NeedClear));
end;



var Protocol : fmProtocol;
/* ---------------------------------------------------------
   Открытие файлов Финансового мониторинга
*/
Macro Open_FM_Files 
  var st = true,
      NameOpenFile;
/* 1. Операции */
  if (st)
    NameOpenFile = "opcontr.dbt";
    OPCONTR = Tbfile ("opcontr.dbt", "w", 0, NameOpenFile);
    if (OPCONTR)
      ;
    else
      st = false;
      MsgBox ("Не открыт файл "+NameOpenFile);
    end;
  end;
/* 2. Участники (клиенты) */
  if (st)
    NameOpenFile = "opcntrpt.dbt";
    OPCNTRPT = Tbfile ("opcntrpt.dbt", "w", 0, NameOpenFile);
    if (OPCNTRPT)
      ;
    else
      st = false;
      MsgBox ("Не открыт файл "+NameOpenFile);
    end;
  end;
  return st;
end;
/* ---------------------------------------------------------
   Получение кода валюты ISO по коду базы Retail 
*/
Macro GetCurrencyISO (Code_Currency)
  var CodISO = Code_Currency;
  FM_CURRENCY.Code_Currency = Code_Currency;
  if (GetEQ(FM_CURRENCY))
    CodISO = FM_CURRENCY.ExternalCode;
  end;
  return CodISO;
end;                
/* ****************************************************** */

macro GetCodeDocum (PaperKind,IsRezident)
  var CodeDocum;
  if (PaperKind == 0)
    CodeDocum = "01";
  elif (NOT IsRezident)
    CodeDocum = "03";
  else
    CodeDocum = "02";
  end;
  PAPRKIND.PaperKind = PaperKind;
  if (GetEQ(PAPRKIND))
//    CodeDocum = PAPRKIND.CodeDocum;
    GlobPaperName = PAPRKIND.Name;
  else
//    CodeDocum = 0;
    GlobPaperName = "";
  end;
  return CodeDocum;
end;
// *********************************************************

macro getCountryCodeNum (codeLat)
  var rs;
  var ret = "";

  cmdCountry.value   ( "t_codelat3" ) = codeLat;
  cmdCountry.execute();
  rs = RsdRecordset( cmdCountry );
  if ( rs.moveNext )
    ret = rs.value( "t_codenum3" );
  end;
  return ret;
end;

/* ----- Конец файла ----- */
