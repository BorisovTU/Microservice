/*
$Name:               DOC_Memorial_print.mac
$Module:             €Œ ãå£ «â¥à 
$Description:        Œ¥¬®à¨ «ì­ë© ®à¤¥à
*/
/*
*/

import order_const, rsd, ErrHandler;

private var {curdate},
            {CNum};

private file curr( "currency.dbt" ) key 0;


//--------------------------------------------------------------------------
private macro DateToStr( pDate )
  var d, m, y, Day, Month, Year;

  DateSplit( pDate, d, m, y );
  Day = String( d );

  if   (m ==  1) Month = " ï­¢ àï ";
  elif (m ==  2) Month = " ä¥¢à «ï ";
  elif (m ==  3) Month = " ¬ àâ  ";
  elif (m ==  4) Month = "  ¯à¥«ï ";
  elif (m ==  5) Month = " ¬ ï ";
  elif (m ==  6) Month = " ¨î­ï ";
  elif (m ==  7) Month = " ¨î«ï ";
  elif (m ==  8) Month = "  ¢£ãáâ  ";
  elif (m ==  9) Month = " á¥­âï¡àï ";
  elif (m == 10) Month = " ®ªâï¡àï ";
  elif (m == 11) Month = " ­®ï¡àï ";
  elif (m == 12) Month = " ¤¥ª ¡àï ";
  else           Month = "  ";
  end;

  Year = String(y);

  return Day + Month + Year + " £.";
end;


//--------------------------------------------------------------------------
private macro MoneyToStr(sum)
  var str = string(sum:f );
  var isDigit = true;
  var stat = 0;
  
  GetRegistryValue("COMMON\\…—€’œ\\Ž„…\\„Ž€Ÿ_—€‘’œ_–ˆ”€Œˆ", V_BOOL, isDigit, stat);
  if (stat != 0)
    isDigit = true;
  end;                                    

  if (not isDigit and (SubStr(str, strlen(str) - 2) == "-00"))
    str = SubStr(str, 1, strlen(str) - 3) + "=";
  end;

  return str;
end;


//--------------------------------------------------------------------------
private macro getExtCurr(codeCurr)
  rewind( curr );
  clearRecord( curr );
  curr.Code_Currency = codeCurr;
  getEQ( curr );
  return curr.ExternalCode;
end;


//--------------------------------------------------------------------------
private macro getCurrShortName(codeCurr)
  rewind( curr );
  clearRecord( curr );
  curr.Code_Currency = codeCurr;
  getEQ( curr );
  return curr.Short_Name;
end;


//--------------------------------------------------------------------------
private macro isNationalCurr(codeCurr)
  if ((codeCurr == 0) or (codeCurr == NationalCurr))
    return true;
  end;
  return false;
end;


//--------------------------------------------------------------------------
private macro getFIIDbyCurr( inCurCode )
  var cmd = RsdCommand( "select fininstr.t_FIID as fiid "
                    "from dfininstr_dbt fininstr, dcurrency_dbt currency "
                    "where currency.t_code_currency = :curCode "
                      "and ( upper( fininstr.t_fi_code ) = upper( currency.t_externalCode ) or "
                            "upper( fininstr.t_codeInAccount ) = upper( currency.t_externalCode ) )" );

  cmd.addParam( "curCode", RSDBP_IN, inCurCode );
  var rs = RsdRecordset( cmd );
  cmd.execute( );

  if ( rs.moveNext( ) )
    if ( ValType( rs.value( "fiid" ) ) != V_UNDEF )
      return Int( rs.value( "fiid" ) );
    end;
  end;

  return -1;
end;


//--------------------------------------------------------------------------
private class RepParams
  private var Params = "";

  //--------------------------------------------------------------------------
  macro add(str:string, format:string)
    if (Params != "")
      Params = Params + ", ";
    end;

    str = StrSubst(str, "\\", "\\\\"); // íªà ­¨à®¢ âì \
    str = StrSubst(str, "\"", "\\" + "\""); // íªà ­¨à®¢ âì "
    Params = Params + "\"" + str + "\"";

    if (format == null)
      format = ":l";
    end;
    Params = Params + ",\"" + format + "\"";
  end;

  //--------------------------------------------------------------------------
  macro getList()
    return Params;
  end;
end;


//--------------------------------------------------------------------------
private class DocAccount(acc:string, sum:money, nat_sum:money, curr_code:integer)
  var Account = acc;
  var Amount = sum;
  var NatCurrEquivalent = nat_sum;
  var CurrCode = curr_code;
end;


//--------------------------------------------------------------------------
private class MO(doc_id:integer)

  private var documentId = doc_id;
  private var compiler = "";
  private var orderKind = "";
  private var documentNumber = "";
  private var docDate;
  private var documentType = "";
  private var debit = TArray;
  private var credit = TArray;
  private var sumStr = "";
  private var operationCipher = "";
  private var ground = "";
  private var chapter;

  private var rep;// = CMakeReport( "", SEP_DEFAULT, 99999 );
  private var template;
  private var params;
  private var pageNum = 1;
  private var totalPages = 1;

  private var printCurrCode = false;

  //--------------------------------------------------------------------------
  private macro loadDocAccounts()
    var accounts = TArray;
    
    var cmd = RsdCommand(
        "select * " +
        "from drtdocaccount_dbt " +
        "where t_DocumentId  = ? " +
        "order by t_DocumentId, t_LineNumber ");

    cmd.addParam("DocumentId", RSDBP_IN, documentId);
    cmd.execute();
    var rs = RsdRecordset(cmd);
    rs.NullConversion = true;
    while (rs.moveNext())
      accounts[accounts.size] = DocAccount(rs.value("t_Account"), rs.value("t_Amount"), rs.value("t_NatCurrEquivalent"), 
          rs.value("t_CurrCode"));
    end;

    return accounts;
  end;
  

  //--------------------------------------------------------------------------
  private macro getAccountName(doc)
    var cmd = RsdCommand(
        "select t_NameAccount from daccount_dbt " +
        "where t_Chapter = ? " +
        "  and t_Account = ? " +
        "  and t_Code_Currency = ?");

    cmd.addParam("Chapter", RSDBP_IN, chapter);
    cmd.addParam("Account", RSDBP_IN, doc.Account);
    cmd.addParam("Code_Currency", RSDBP_IN, getFIIDbyCurr(doc.CurrCode));
    cmd.execute();
    var rs = RsdRecordset(cmd);
    rs.NullConversion = true;
    if (rs.moveNext())
      return rs.value("t_NameAccount");
    end;

    return "";
  end;


  //--------------------------------------------------------------------------
  private macro init()
    
    var cmd = RsdCommand(
        "select * " +
        "from drtdocument_dbt d, drtmemorialorder_dbt mo " +
        "where d.t_DocumentId = mo.t_DocumentId " +
        "  and d.t_DocumentId = ? ");

    cmd.addParam("DocumentId", RSDBP_IN, documentId);
    cmd.execute();
    var rs = RsdRecordset(cmd);
    rs.NullConversion = true;
    if (not rs.moveNext())
      DoError("Œ¥¬®à¨ «ì­ë© ®à¤¥à ­¥ ­ ©¤¥­");
    end;
  
    var party;
    if (findDepartment(rs.value("t_Department"), null, null, party))
      compiler = party.rec.name;
    end;

    if (rs.value("t_IsCorrectionOrder"))
      orderKind = "ˆ‘€‚ˆ’…‹œ›‰ Ž„…";
    else
      orderKind = "Ž„…";
    end;
    
    documentNumber = rs.value("t_DocumentNumber");
    DtTmSplit(rs.value("t_Date"), docDate);
    documentType = rs.value("t_DocumentType");
    chapter = rs.value("t_Chapter");

    var foldSide = rs.value("t_FoldSide");

    if (foldSide == 1)
      debit = loadDocAccounts();
    end;
    if (debit.size == 0)
      debit[0] = DocAccount(rs.value("t_DebitAccount"), rs.value("t_DebitAmount"), rs.value("t_NatCurrEquivalent"),
          rs.value("t_DebitCurrCode"));
    end;

    if (foldSide == 2)
      credit = loadDocAccounts();
    end;
    if (credit.size == 0)
      credit[0] = DocAccount(rs.value("t_CreditAccount"), rs.value("t_CreditAmount"), rs.value("t_NatCurrEquivalent"),
          rs.value("t_CreditCurrCode"));
    end;

    var stat = 0;
    GetRegistryValue("COMMON\\…—€’œ\\Ž„…\\Š®¤_‚ «îâë", V_BOOL, printCurrCode, stat);
    if (stat != 0)
      printCurrCode = false;
    end;                                    

    var sum;
    if ((debit.size == 1) and isNationalCurr(debit[0].CurrCode))
      sum = debit[0].Amount;
    elif ((credit.size == 1) and isNationalCurr(credit[0].CurrCode))
      sum = credit[0].Amount;
    else
      sum = rs.value("t_NatCurrEquivalent");
    end;
    sumStr = CurToStrAlt(sum, null, null, int(getExtCurr(0)));

    operationCipher = rs.value("t_OperationCipher");
    ground = rs.value("t_Ground");
  end;


  //--------------------------------------------------------------------------
  private macro makeHeader()
    pageNum = 1;
    totalPages = 1;
    if (debit.size > 1)
      totalPages = (debit.size + MaxNumAccount - 1) / MaxNumAccount;
    elif (credit.size > 1)
      totalPages = (credit.size + MaxNumAccount - 1) / MaxNumAccount;
    end;
	
    var compilerNameArray = StrSplit2(compiler, 80, false);
	
    template = template +
        "                                                           ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿  " + "\n" +
        "                                                           ³    Š®¤ ä®à¬ë    ³  " + "\n" +
        "                                                           ³¤®ªã¬¥­â  ¯® ŽŠ“„³  " + "\n" +
        "                                                           ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´  " + "\n" +
        "                                                           ³     0401108     ³  " + "\n" +
        "                                                           ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ  " + "\n";
   
    for (var i, 0, compilerNameArray.size - 1, 1 )
        template = template + 
        "################################################################################" + "\n";
        params.add(compilerNameArray[i]);
    end;


    template = template +
        "ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ" + "\n" +
        "       ‘®áâ ¢¨â¥«ì                                                              " + "\n" +
        "                                                                                " + "\n" +
        "Œ…ŒŽˆ€‹œ›‰ ####################    N ########   ###################           " + "\n" +
        "                                                        „ â                     " + "\n" +
        "                                                                                " + "\n" +
        "################################################################################" + "\n" +
        "ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ" + "\n" +
        "   ¨¬¥­®¢ ­¨¥ áç¥â              ³   „¥¡¥â áç¥â       ³   ‘ã¬¬  æ¨äà ¬¨         " + "\n";
 
    params.add(orderKind);
    params.add(documentNumber, ":c");
    params.add(DateToStr(docDate));
    params.add(documentType);
  end;


  //--------------------------------------------------------------------------
  private macro makeFooter()
    var sumStrArray = StrSplit2(sumStr, 56, 56, 2);
    var groundArray = StrSplit2(ground, 80, 80, 5);
    template = template +
        "ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÂÄÄÄÄÄÄÁÄÄÄÄÂÄÄÄÄÄÄÄÄÄ" + "\n" +
        "  ‘ã¬¬  ¯à®¯¨áìî                                          ³ ˜¨äà      ³         " + "\n" +
        "########################################################  ³¤®ªã¬¥­â   ³ ###     " + "\n" +
        "########################################################  ÃÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄ" + "\n" +
        "                                                          ³           ³         " + "\n" +
        "                                                          ÃÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄ" + "\n" +
        "                                                          ³           ³         " + "\n" +
        "ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄ" + "\n" +
        "  ‘®¤¥à¦ ­¨¥ ®¯¥à æ¨¨, ­ ¨¬¥­®¢ ­¨¥, ­®¬¥à ¨ ¤ â                                " + "\n" +
        " ¤®ªã¬¥­â , ­  ®á­®¢ ­¨¨ ª®â®à®£® á®áâ ¢«¥­ ¬¥¬®à¨ «ì­ë© ®à¤¥à                  " + "\n" +
        "################################################################################" + "\n" +
        "################################################################################" + "\n" +
        "################################################################################" + "\n" +
        "################################################################################" + "\n" +
        "################################################################################" + "\n" +
        "                                                                                " + "\n" +
        "ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ" + "\n" +
        " ®¤¯¨á¨                                                                        " + "\n" +
        "                                                                                " + "\n" +
        "ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ" + "\n" +
        " à¨«®¦¥­¨¥: ___ ¤®ªã¬¥­â®¢ ­  ___ «¨áâ å.                                      " + "\n";
    params.add(sumStrArray[0]);
    params.add(operationCipher);
    params.add(sumStrArray[1]);
    params.add(groundArray[0]);
    params.add(groundArray[1]);
    params.add(groundArray[2]);
    params.add(groundArray[3]);
    params.add(groundArray[4]);
  end;


  //--------------------------------------------------------------------------
  private macro makePageBreak()
    if (totalPages > 1)
      template = template +
          "                                                                              " + "\n" +
          "                                                                              " + "\n";

      if (pageNum > 1)
        template = template +
            "Œ¥¬®à¨ «ì­ë© #################### N ########                                  " + "\n" +
            "                                                                              " + "\n";
        params.add(StrLwr(orderKind));
        params.add(documentNumber, ":c");
      end;

      template = template +
          "################################################################################" + "\n";
      params.add("‘âà. " + pageNum + "  ‚á¥£® áâà. " + totalPages);
    end;

    template = "\n" + template;
    var str = "rep.AutoScan(\"[\" + template + \"]()\"," +  params.getList() + ")";
    ExecExp(str);

    if (pageNum < totalPages)
      //rep.AddStrBreak();
      rep.AutoScan("[" + StrFor(12) + "]()");
    end;

    template = "";
    params = RepParams;

    pageNum = pageNum + 1;
  end;
  

  //--------------------------------------------------------------------------
  private macro makeDebit(from:integer)
    var to = debit.size;
    if (to > (from + MaxNumAccount))
      to = from + MaxNumAccount;
    end;

    var index = from;
    while (index < to)
      var debitName = getAccountName(debit[index]);
      var debitNameArray = StrSplit2(debitName, 33, 33, 2);

      if (index == 0)
        template = template +
            "                                 ³                    ÃÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄ" + "\n"+
            "#################################³####################³##########³########## ###" + "\n"; 
      else
        template = template +
            "                                 ³                    ³          ³              " + "\n" +
            "#################################³####################³##########³########## ###" + "\n";
      end;
      params.add(debitNameArray[0]);
      params.add(debit[index].Account);

      var nat_curr = isNationalCurr(debit[index].CurrCode);
      
      if (nat_curr)
        params.add(MoneyToStr(debit[index].Amount), ":r");
        params.add("");
      else
        params.add(MoneyToStr(debit[index].NatCurrEquivalent), ":r");
        params.add(MoneyToStr(debit[index].Amount), ":r");
      end;

      if ((not nat_curr) or printCurrCode)
        params.add(getCurrShortName(debit[index].CurrCode));
      else
        params.add("");
      end;
      if ( debitNameArray.size > 1 )
         for ( var i, 1, debitNameArray.size - 1, 1)
              template = template +
                "#################################³                    ³          ³              " + "\n";
              params.add(debitNameArray[i]);
         end; 
      end;
      index = index + 1;
    end;

    return to;
  end;
  

  //--------------------------------------------------------------------------
  private macro makeCredit(from:integer)
    var to = credit.size;
    if (to > (from + MaxNumAccount))
      to = from + MaxNumAccount;
    end;

    var index = from;
    while (index < to)
      var creditName = getAccountName(credit[index]);
      var creditNameArray = StrSplit2(creditName, 33, 33, 2);

      if (index == 0)
        template = template +
            "ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´          ³              " + "\n" +
            "   ¨¬¥­®¢ ­¨¥ áç¥â              ³   Šà¥¤¨â áç¥â      ³          ³              " + "\n" +
            "#################################³####################³##########³########## ###" + "\n";
      else
        template = template +
            "                                 ³                    ³          ³              " + "\n" +
            "#################################³####################³##########³########## ###" + "\n";
      end;
      params.add(creditNameArray[0]);
      params.add(credit[index].Account);

      var nat_curr = isNationalCurr(credit[index].CurrCode);
      
      if ((credit.size > 1) or (debit.size > 1) or (credit[0].CurrCode != debit[0].CurrCode))
        if (nat_curr)
          params.add(MoneyToStr(credit[index].Amount), ":r");
          params.add("");
          params.add("");
        else
          params.add(MoneyToStr(credit[index].NatCurrEquivalent), ":r");
          params.add(MoneyToStr(credit[index].Amount), ":r");
          params.add(getCurrShortName(credit[index].CurrCode));
        end;
      else
        params.add("");
        params.add("");
        params.add("");
      end;
      if ( creditNameArray.size > 1 )
        for (var i, 1, creditNameArray.size - 1, 1)
           template = template +
             "#################################³                    ³          ³              " + "\n";
           params.add(creditNameArray[i]);
        end;
      end;
      index = index + 1;
    end;

    return to;
  end;
  

  //--------------------------------------------------------------------------
  private macro makeOrder()
    template = "";
    params = RepParams;

    makeHeader();

    var count = 0;
    while (count < debit.size)
      count = makeDebit(count);

      if (count < debit.size)
        makePageBreak();
      end;
    end;

    count = 0;
    while (count < credit.size)
      count = makeCredit(count);

      if (count < credit.size)
        makePageBreak();
      end;
    end;

    makeFooter();

    makePageBreak();    
  end;


  //--------------------------------------------------------------------------
  private macro writeCsvFile(file_name:string, is_debit:bool): C_CSVFile
    var csv = C_CSVFile();

    if (not csv.FileOpen(csv.CreateFullFileName(file_name), true))
      DoError("¥¢®§¬®¦­® ®âªàëâì ä ©« " + csv.CreateFullFileName(file_name));
    end;

    var accounts;
    if (is_debit)
      accounts = debit;
    else
      accounts = credit;
    end;
    
    InitProgress(accounts.size, "...”®à¬¨à®¢ ­¨¥ ä ©«  á ¤ ­­ë¬¨", "”®à¬¨à®¢ ­¨¥ ä ©«  á ¤ ­­ë¬¨" );
    var i = 0;
    while (i < accounts.size)
      csv.AddCell(getAccountName(accounts[i]));
      csv.AddCell("");
      
      csv.AddCell(accounts[i].Account);
      csv.AddCell("");
      csv.AddCell("");
      csv.AddCell("");

      var nat_curr = isNationalCurr(accounts[i].CurrCode);
      if (nat_curr)
        csv.AddCell(MoneyToStr(accounts[i].Amount));
        
        csv.AddCell("");
        csv.AddCell("");
      else
        csv.AddCell(MoneyToStr(accounts[i].NatCurrEquivalent));
        
        csv.AddCell(MoneyToStr(accounts[i].Amount));
        csv.AddCell("");
      end;

      if ((not nat_curr) or (printCurrCode and is_debit))
        csv.AddCell(getCurrShortName(accounts[i].CurrCode));
      else
        csv.AddCell("");
      end;

      csv.AddRow();

      csv.AddCell("");
      csv.AddCell("");
      csv.AddCell("");
      csv.AddCell("");
      csv.AddCell("");
      csv.AddCell("");
      csv.AddCell("");
      csv.AddCell("");
      csv.AddCell("");
      csv.AddCell("");
      csv.AddRow();

      UseProgress(i);
      i = i + 1;
    end;
    RemProgress();

    csv.FileClose();

    return csv;
  end;
  

  //--------------------------------------------------------------------------
  private macro printMultilineOrder( Copies:integer )
    var ObjTempl = beginXlsReport();
    var ExecuteStrExcel : tarray = tarray;

    ObjTempl.SetCopyByRows(true);

    if(not ObjTempl.OpenTemplate("Œ¥¬®à¨ «ì­ë©.xls"/*, true*/))
      DoError("¥¢®§¬®¦­® ®âªàëâì è ¡«®­ Œ¥¬®à¨ «ì­ë©.xls");
    end;

    ObjTempl.SetValue_NameCell("‘®áâ ¢¨â¥«ì", compiler);
    ObjTempl.SetValue_NameCell("Œ¥¬Žà¤¥à", "Œ…ŒŽˆ€‹œ›‰ " + orderKind);
    ObjTempl.SetValue_NameCell("®¬¥àŽà¤¥à ", documentNumber);
    ObjTempl.SetValue_NameCell("„ â Žà¤¥à ", DateToStr(docDate));
    ObjTempl.SetValue_NameCell("„®¯", documentType);

    ObjTempl.SetValue_NameCell("‘ã¬¬ à®¯¨áìî", sumStr);
    ObjTempl.SetValue_NameCell("Žá­®¢ ­¨¥", ground);
    ObjTempl.SetValue_NameCell("˜¨äà", operationCipher);

    var Table1 = ObjTempl.RegisterTable("Table1"/*, "Header"*/);
    var Table2 = ObjTempl.RegisterTable("Table2"/*, "Header"*/);

    var csv = writeCsvFile("data1.txt", true);
    Table1.FillTabelFromCSV(csv.GetlsFileName()/*, 1 */);
    Table1.EndTable();
    var n1 = debit.size; // 1

    csv = writeCsvFile("data2.txt", false);
    Table2.FillTabelFromCSV(csv.GetlsFileName()/*, 1 */);
    Table2.EndTable();
    var n2 = credit.size; // 1

    ObjTempl.SheetName("Œ¥¬®à¨ «ì­ë© ®à¤¥à ü " + documentNumber);
    var str1 = string(12);
    var str2 = string(12+2*n1);
    var str3 = string(12+2*(n1+n2)+1);

    ObjTempl.SetBorder("g"+str1+":"+"j"+str1, 1);
    ObjTempl.SetBorder("a"+str2+":"+"f"+str2, 1);
    ObjTempl.SetBorder("a"+str3+":"+"j"+str3, 1);

    endXlsReport(ObjTempl);

    if ( AutoPrint  AND  ( Copies > 0 ) )
      ExecuteStrExcel[ExecuteStrExcel.Size] = "ibook.PrintOut( OptVal, OptVal," + String(Copies) + " );";
      ObjTempl.ExecStr(ExecuteStrExcel);
    end;
  end;


  //--------------------------------------------------------------------------
  macro printOrder( Copies:integer )
    var TempRep = "", FileNameOffic = "";

    init();

    if ((debit.size >= ORDER_PRINT_NMULTI) or (credit.size >= ORDER_PRINT_NMULTI) or isGroupProcReport())
      printMultilineOrder( Copies );
      return;
    end;

    rep = CMakeReport( "", SEP_DEFAULT, 99999 );
    // Œ¥­ï¥¬ èà¨äâ ¯®-ã¬®«ç ­¨î, çâ®¡ë ®âç¥â ¢ Word-¥ ¢«¥§ ¢ «¨áâ ä®à¬ â  €4
    rep.SetDefaultFontSize(8);

    makeOrder();
    
    FileNameOffic = "MO" + StrSubst( string({curdate}), ".", "" );
                                        
    rep.SetFileNameWin( FileNameOffic );

    if ( ( ORDER_PRINT_FORMAT == OPF_TXT      ) or ( ORDER_PRINT_FORMAT == OPF_MSOFFICE_TXT ) )
      RT_PrintRep( rep, Copies );
    end;
    if ( ( ORDER_PRINT_FORMAT == OPF_MSOFFICE ) or ( ORDER_PRINT_FORMAT == OPF_MSOFFICE_TXT ) )
      rep.SetWinRepOutPut( 0, 0 );
      rep.AddWinRepOutput( WINREP_OUTPUT_WORD, WINREP_FORMAT_DOC );
      rep.SetExecuteWord( "WordDocument.PageSetup.LeftMargin = 20;" );
      rep.SetExecuteWord( "WordDocument.PageSetup.TopMargin  = 20;" );
      rep.PrintWinRep();
      RT_PrintOut_Doc( rep, Copies );
      rep.ShowWinRep();
    end;
  end;

end;


//--------------------------------------------------------------------------
macro PrintRTDocument( RTDocID:integer, Copies:integer ):integer
  var order = MO(RTDocID);
  order.printOrder( Copies );

OnError(err)
  ShowError(err);
end;


//PrintRTDocument(155);

