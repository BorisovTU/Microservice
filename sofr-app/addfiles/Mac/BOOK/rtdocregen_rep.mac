/*
$Name:           rtdocregen_rep.mac
$Module:         €Œ ãå£ «â¥à 
$Description:    ’—…’  ……‘‡„€ˆˆ „„  …€–ˆŸŒ
*/

import rsd;

private const SB_GROUPOPERT = 30000;

private var count = 0;
private var sErrors = TArray;
private var gErrors = TArray;


private class DocRef
  var ApplicationKind;
  var ApplicationKey;
  var ErrCode;
end;


private macro errMessage(err_code)
  var err_msg = "(" + string(err_code) + ") ";
  
  var cmd = RsdCommand(
      "select t_Contents from dsbbank_msg "
      "where t_Number = ? "
  );
  cmd.addParam("Number", RSDBP_IN, err_code);
  cmd.execute();

  var rs = RsdRecordset(cmd);
  if (rs.moveNext())
    err_msg = err_msg + rs.value(0);
  end;

  return err_msg;
end;


private macro printErrors(caption:string, list:TArray)
    [ ];
    [                                                       #                                                          ]
    (caption:c);
    [ ];
    [ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿];
    [³ ‚¨¤  ®¯¥à æ¨¨ ³          ID ®¯¥à æ¨¨          ³                      ¯¨á ­¨¥ ®è¨¡ª¨                          ³];
    [³ ApplicationKind ³        ApplicationKey         ³                                                               ³];
    [ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];

  var doc;
  for (doc, list)
    [³ ############### ³ ############################# ³ ############################################################# ³]
    (doc.ApplicationKind:r, doc.ApplicationKey:r, errMessage(doc.ErrCode):w);
    [³                 ³                               ³                                                               ³]
  end;

    [ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
end;


private macro report
  var cmd = RsdCommand("SELECT t_ApplicationKind, t_ApplicationKey, t_ErrCode FROM drsbedref_tmp ORDER BY t_ApplicationKind, t_ApplicationKey");
  cmd.execute();
  var rs = RsdRecordset(cmd);
  rs.NullConversion = true;
  while (rs.moveNext())
    count = count + 1;

    var errCode = rs.value("t_ErrCode");
    if (errCode != 0)
      var doc = DocRef;
      doc.ApplicationKind = rs.value("t_ApplicationKind");
      doc.ApplicationKey = rs.value("t_ApplicationKey");
      doc.ErrCode = errCode;

      if (doc.ApplicationKind == SB_GROUPOPERT)
        gErrors[gErrors.size] = doc;
      else
        sErrors[sErrors.size] = doc;
      end;
    end;
  end;

  cmd=RsdCommand(
  "SELECT t_OldCnt, t_NewCnt FROM "+
   "(SELECT COUNT(DISTINCT doc.t_DocumentID) t_NewCnt "+
     "FROM    dRTRegenPMD_tmp op INNER JOIN dRTDocument_dbt doc "+
          "USING (t_OpApplicationKind, t_OpApplicationKey)) dNew, "+
   "(SELECT COUNT(t_DocumentID) t_OldCnt "+
     "FROM dRTDocRef_tmp doc) dOld");
  cmd.execute();
  rs=RsdRecordset(cmd);
  rs.moveNext();

  [                                      ’—…’  ……‘‡„€ˆˆ „„  …€–ˆŸŒ];
  [ ];
  [¡à ¡®â ­® ®¯¥à æ¨©:];
  println("‚‘…ƒ: ",count);
  println("Š®«-¢® „„, á®§¤ ­­ëå ¤® ¯¥à¥£¥­¥à æ¨¨: ",rs.value("t_OldCnt",doc,V_INTEGER));
  println("Š®«-¢® „„, á®§¤ ­­ëå ¯®á«¥ ¯¥à¥£¥­¥à æ¨¨: ",rs.value("t_NewCnt",doc,V_INTEGER));
  [ˆ§ ­¨å á ®è¨¡ª ¬¨: #](sErrors.size + gErrors.size);

  if (sErrors.size != 0)
    printErrors("…„ˆˆ—›… …€–ˆˆ,  Š’›Œ … ……‘‡„€› „„", sErrors);
  end;

  if (gErrors.size != 0)
    printErrors("ƒ“‚›… –…„“›,  Š’›Œ … ……‘‡„€› „„", gErrors);
  end;
end;


report();
