/*
$Name:             DOC_CashExch_print.mac
$Module:           RS-Retail
$Description:      ‚ «îâ­ë© ª áá®¢ë© ®à¤¥à
*/

import "Or_Rep_h.mac";
import DeprIntr, order_const, rsd, ErrHandler, cur_rate;

private var {curdate},
            {CNum};

private file address ( "adress.dbt" )   key 0;
private file curr    ( "currency.dbt" ) key 0;

private var opr  = TBFile( "person.dbt", "r", 0 );
private var tpac = TBFile( "typeac.dbt", "r", 0 );

private var ErrCodeWR, ErrTextWR;

// ------------------------------------------------------------
private macro SplitString( str, delim )
  var arr = TArray;
  var idx;
  while (str != "")
    idx = Index(str, delim);
    if (idx == 0)
      arr[arr.size] = str;
      return arr;
    end;
    arr[arr.size] = substr(str, 1, idx - 1);
    str = substr(str, idx + 1);
  end;
  return arr;
end;

// ------------------------------------------------------------
private macro DateToStr( pDate )
  var d, m, y, Day, Month, Year;
  DateSplit( pDate, d, m, y );
  Day = String( d );
  if   (m ==  1) Month = " ï­¢ àï ";
  elif (m ==  2) Month = " ä¥¢à «ï ";
  elif (m ==  3) Month = " ¬ àâ  ";
  elif (m ==  4) Month = "  ¯à¥«ï ";
  elif (m ==  5) Month = " ¬ ï ";
  elif (m ==  6) Month = " ¨î­ï ";
  elif (m ==  7) Month = " ¨î«ï ";
  elif (m ==  8) Month = "  ¢£ãáâ  ";
  elif (m ==  9) Month = " á¥­âï¡àï ";
  elif (m == 10) Month = " ®ªâï¡àï ";
  elif (m == 11) Month = " ­®ï¡àï ";
  elif (m == 12) Month = " ¤¥ª ¡àï ";
  else           Month = "  ";
  end;
  Year = String(y);
  return Day + Month + Year + " £.";
end;

// ------------------------------------------------------------
private macro _DateToStr( _date )
  var s = DateToStr( _date );
  var str;
  if ( SubStr( s, 2, 1 ) == " " )
    str = "0" + s;
  else
    str = s;
  end;
  return str;
end;

// ------------------------------------------------------------
private macro GetTempParty(party_id:integer)
  var cmd = RsdCommand(
      "select * " +
      "from dtemporaryparty_dbt " +
      "where t_TempPartyId = ? ");

  cmd.addParam("PartyId", RSDBP_IN, party_id);
  cmd.execute();
  var rs = RsdRecordset(cmd);
  rs.NullConversion = true;
  return rs;
end;

// ------------------------------------------------------------
private macro getExtCurr(codeCurr)
  rewind( curr );
  clearRecord( curr );
  curr.Code_Currency = codeCurr;
  getEQ( curr );
  return curr.ExternalCode;
end;

// ------------------------------------------------------------
private macro getSymbCodeCurr(codeCurr)
  rewind( curr );
  clearRecord( curr );
  curr.Code_Currency = codeCurr;
  getEQ( curr );
  return curr.Short_Name;
end;

// ------------------------------------------------------------
//    ®«ãç¥­¨¥ àã¡«¥¢®£® íª¢¨¢ «¥­â  áã¬¬ë.
macro GetSumRub( sumCur, currCode, date, kind )
    var cbRate = 0, buyRate = 0, sellRate = 0;
    var timeOp = Time(0,0,0);
    var sumRub = $0;
    if ( (sumCur > 0) and (currCode > 0) )
      if ( GetAllCurrRate( date, currCode, cbRate, buyRate, sellRate, timeOp ) )
        if   ( kind == 0 )
          sumRub = sumCur * cbRate;
        elif ( kind == 1 )
          sumRub = sumCur * buyRate;
        else
          sumRub = sumCur * sellRate;
        end;
      end;
    end;
    return sumRub;
end;

// ------------------------------------------------------------
private macro makeOperName(oper_code)
  var name = "";
  opr.rec.cTypePerson = "";
  opr.rec.Oper = oper_code;
  if (not opr.GetEQ)
    return name;
  end;
  var fio = SplitString(opr.rec.Name, " ");
  if (fio.size > 0)
    name = fio[0];
  end;
  if (fio.size > 1)
    name = name + " " + substr(fio[1], 1, 1) + ".";
  end;
  if (fio.size > 2)
    name = name + " " + substr(fio[2], 1, 1) + ".";
  end;
  return name;
end;

// ------------------------------------------------------------
private macro GetNameTypePerson()
  var sWork = "";
  tpac.ReWind();
  tpac.Clear();
  tpac.rec.iNumType = 14;  /* “à®¢­¨ ¤®áâã¯®¢. */
  tpac.rec.Type_Account = opr.rec.cTypePerson;
  if ( tpac.GetEQ() )
    sWork = tpac.rec.Name_Type;
  end;
  return sWork;
end;

// ------------------------------------------------------------
private class RepParams
  private var Params = "";

  macro add(str:string, format:string)
    if (Params != "")
      Params = Params + ", ";
    end;

    str = StrSubst(str, "\\", "\\\\"); // íªà ­¨à®¢ âì \
    str = StrSubst(str, "\"", "\\" + "\""); // íªà ­¨à®¢ âì "
    Params = Params + "\"" + str + "\"";

    if (format == null)
      format = ":l";
    end;
    Params = Params + ",\"" + format + "\"";
  end;

  macro getList()
    return Params;
  end;
end;

// ------------------------------------------------------------
private class DocAccount(acc:string, sum:money, cashSym:string, curr_code:integer)
  var Account = acc;
  var Amount = sum;
  var CashSymbol = cashSym;
  var CurrCode = curr_code;
end;

// ------------------------------------------------------------
private class EXCHO(doc_id:integer)

  private var documentId = doc_id;
  private var documentNumber = "";
  private var docDate;
  private var payerName = "";
  private var debitAccount = "";
  private var debitAmount = $0;
  private var creditAccount = "";
  private var creditAmount = $0;
  private var receiverName = "";
  private var receiverINN = "";
  private var receiverKPP = "";
  private var receiverOKATO = "";
  private var receiverAccount = "";
  private var receiver = TArray;
  private var receiverGroup = TArray;
  private var debitCurrCode = 0;
  private var creditCurrCode = 0;
  private var debitCashSymbol = "";
  private var creditCashSymbol = "";
  private var receiverBankName = "";
  private var receiverBankBIK = "";
  private var sumDebStr = "";
  private var sumCreStr = "";
  private var ground = "";
  private var operName = "";
  private var operWork = "";
  private var controllerName = "";
  private var controllerWork = "";
  private var cashierName = "";
  private var cashierWork = "";
  private var opCipher = "";
  private var bankName = "";
  private var ExchangeOperationCode = "";
  private var RateDiffDebitAccount  = "";
  private var RateDiffCreditAccount = "";
  private var RateDiffSum = $0;
  private var RateDiffKind = 0;

  private var rep = CMakeReport( "", SEP_DEFAULT, 99999 );

  private macro getReceiverInfo(rs:RsdRecordset)
    var is_null;

    var id = rs.value("t_ReceiverPartyID", is_null);
    if (not is_null)
      var inn = getPartyINN(id, 1);
      SplitFullINN(inn, receiverINN, receiverKPP);

      ClearRecord(address);
      address.PartyID = id;
      address.Type = 1;  // îà¨¤¨ç¥áª¨©  ¤à¥á
      if ( GetEQ( address ) )
        receiverOKATO = address.OKATO;
      end;
    else
      id = rs.value("t_ReceiverTempPartyID", is_null);
      if (not is_null)
        var party_rs = GetTempParty(id);
        if (party_rs.moveNext())
          receiverINN = party_rs.value("t_INN");
          receiverKPP = party_rs.value("t_KPP");
          receiverOKATO = party_rs.value("t_OKATO");
          receiverAccount = party_rs.value("t_Account");
        end;
      end;
    end;
  end;

// --------------------------------------------------------------------------
  private macro addReceiverAccount(acc:DocAccount)
    receiver[receiver.size] = acc;
    
    var i = 0;
    while (i < receiverGroup.size())
      if ((receiverGroup[i].CashSymbol == acc.CashSymbol) and (receiverGroup[i].CurrCode == acc.CurrCode))
        receiverGroup[i].Amount = receiverGroup[i].Amount + acc.Amount;
        return;
      end;
      
      i = i + 1;
    end;

    receiverGroup[receiverGroup.size] = DocAccount(acc.Account, acc.Amount, acc.CashSymbol, acc.CurrCode);
  end;

// --------------------------------------------------------------------------
  private macro loadDocAccounts()
    var curCode = 0;
    var cmd = RsdCommand(
        "select * " +
        "from drtdocaccount_dbt " +
        "where t_DocumentId  = ? " +
        "order by t_DocumentId, t_LineNumber ");


    cmd.addParam("DocumentId", RSDBP_IN, documentId);
    cmd.execute();
    var rs = RsdRecordset(cmd);
    rs.NullConversion = true;
    while (rs.moveNext())

      if ( ( ValType( rs.value("t_CurrCode") ) == V_INTEGER ) or ( ValType( rs.value("t_CurrCode") ) == V_DOUBLE ) or ( ValType( rs.value("t_CurrCode") ) == V_DOUBLEL ) )
        curCode = Int( rs.value("t_CurrCode") );
      else
        curCode = 0;
      end;

      addReceiverAccount( DocAccount( rs.value("t_Account"), rs.value("t_Amount"), rs.value("t_CashSymbol"), curCode ) );
    end;
  end;

// --------------------------------------------------------------------------
  private macro init()

    var _Department, _Branch;
    
    var cmd = RsdCommand(
        "select * " +
        "from drtdocument_dbt d " +
        "where d.t_DocumentId = ? ");

    cmd.addParam("DocumentId", RSDBP_IN, documentId);
    cmd.execute();
    var rs = RsdRecordset(cmd);
    rs.NullConversion = true;
    if (not rs.moveNext())
      DoError("Š áá®¢ë© ®à¤¥à ­¥ ­ ©¤¥­");
    end;
  
    documentNumber = rs.value("t_DocumentNumber");
    DtTmSplit(rs.value("t_Date"), docDate);

    payerName = rs.value("t_PayerName");
    debitAccount = rs.value("t_DebitAccount");
    debitAmount = rs.value("t_DebitAmount");
    creditAccount = rs.value("t_CreditAccount");
    creditAmount = rs.value("t_CreditAmount");
    opCipher = rs.value("t_OperationCipher");
    receiverName = rs.value("t_ReceiverName");
    getReceiverInfo(rs);

    loadDocAccounts();
    if (receiver.size == 0)
      addReceiverAccount(DocAccount(rs.value("t_CreditAccount"), rs.value("t_CreditAmount"), rs.value("t_DebitCashSymbol"),
          rs.value("t_CreditCurrCode")));
    end;

    debitCurrCode = rs.value("t_DebitCurrCode");
    creditCurrCode = rs.value("t_CreditCurrCode");

    debitCashSymbol  = rs.value("t_DebitCashSymbol" );
    creditCashSymbol = rs.value("t_CreditCashSymbol" );

    _Department = rs.value( "t_Department" );
    _Branch     = rs.value( "t_Branch" );

    var ddep, party;
    if ( findDepartment( _Department, null, ddep, party ) )
      bankName = party.rec.Name;
      receiverBankName = party.rec.name;
      receiverBankBIK = findPartyCode(party.rec.partyId, I_PTCK_BIC); // ddep.rec.name;
    end;

    if ( ( _Branch != _Department )  AND ( findDepartment( _Branch, null, ddep, party ) ) )  // ‚‘
      bankName = bankName + ", " + party.rec.Name + " ü " + ddep.rec.Name;
    end;

    ExchangeOperationCode = rs.value( "t_ExchangeOperationCode" );
    
    sumDebStr = CurToStrAlt(debitAmount,  null, null, int(getExtCurr(debitCurrCode)));
    sumCreStr = CurToStrAlt(creditAmount, null, null, int(getExtCurr(creditCurrCode)));
    ground = rs.value("t_Ground");
    operName = makeOperName(rs.value("t_Oper"));
    operWork = GetNameTypePerson();
    controllerName = makeOperName(rs.value("t_Controller"));
    controllerWork = GetNameTypePerson();
    cashierName = makeOperName(rs.value("t_Cashier"));
    cashierWork = GetNameTypePerson();

    RateDiffDebitAccount  = rs.value("t_RateDiffDebitAccount");
    RateDiffCreditAccount = rs.value("t_RateDiffCreditAccount");
    RateDiffSum  = rs.value("t_RateDiffSum");
    RateDiffKind = rs.value("t_RateDiffKind");

  end;

// --------------------------------------------------------------------------
  private macro makeOrder(first_index:integer)
    var template = "";
    var params = RepParams;
    var vAccCredit;
    var bankNameArray;
    var payerNameArray;
    var sumDebArray = StrSplit2( sumDebStr, 36, 27, 4 );
    var sumCreArray = StrSplit2( sumCreStr, 36, 27, 4 );
    var sumRubDeb = "";
    var sumRubCre = "";
    var kindRate = 0;
    var RDinAccDeb = "";
    var RDinAccCre = "";
    var RDinSum = "";
    var RDoutAccDeb = "";
    var RDoutAccCre = "";
    var RDoutSum = "";

    if ( StrLen( bankName ) > 0 )
      bankNameArray = StrSplit2( bankName, 75, 40, 2 );
    else
      bankNameArray = StrSplit2( "   ", 1, 1, 2 );
    end;

    if ( StrLen( payerName ) > 0 )
      payerNameArray = StrSplit2(payerName, 28, 20, 3);
    else
      payerNameArray = StrSplit2("   ", 1, 1, 3);
    end;

    if ( debitCurrCode == 0 )
      sumRubDeb = debitAmount;
    else
      if ( creditCurrCode == 0 )
        kindRate = 1;  // Buy.
      else
        kindRate = 0;  // Rate CB.
      end;
      sumRubDeb = String( GetSumRub( debitAmount, debitCurrCode, docDate, kindRate ) );
    end;

    if ( creditCurrCode == 0 )
      sumRubCre = creditAmount;
    else
      if ( debitCurrCode == 0 )
        kindRate = 2;  // Sell.
      else
        kindRate = 0;  // Rate CB.
      end;
      sumRubCre = String( GetSumRub( creditAmount, creditCurrCode, docDate, kindRate ) );
    end;

    if   ( RateDiffKind == 0 )  // ã«¥¢ ï ªãàá®¢ ï à §­¨æ 
      RDinAccDeb  = "";
      RDinAccCre  = "";
      RDinSum     = "";
      RDoutAccDeb = "";
      RDoutAccCre = "";
      RDoutSum    = "";
    elif ( RateDiffKind == 1 )  // „•„
      RDinAccDeb  = RateDiffDebitAccount;
      RDinAccCre  = RateDiffCreditAccount;
      RDinSum     = String( RateDiffSum );
      RDoutAccDeb = "";
      RDoutAccCre = "";
      RDoutSum    = "";
    elif ( RateDiffKind == 2 )  // €‘•„
      RDinAccDeb  = "";
      RDinAccCre  = "";
      RDinSum     = "";
      RDoutAccDeb = RateDiffDebitAccount;
      RDoutAccCre = RateDiffCreditAccount;
      RDoutSum    = String( RateDiffSum );
    end;

    template = template +
        "                                                       ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿   " + "\n" +
        "     ‚ «îâ­ë© ª áá®¢ë© ®à¤¥à                           ³    Š®¤ ä®à¬ë     ³   " + "\n" +
        "                                                       ³   ¤®ªã¬¥­â  ¯®   ³   " + "\n" +
        "                                                       ³  Š“„  0401106   ³   " + "\n" +
        "                                                       ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ   " + "\n" +
        "                   ÚÄÄÄÄÄÄÄÄÄÄ¿                                               " + "\n" +
        " Š€‘‘‚›‰ „… N  ³ ######## ³                                               " + "\n" +
        "                   ÀÄÄÄÄÄÄÄÄÄÄÙ    ####################                       " + "\n" +
        "                                        „ â                                   " + "\n" +
        "  ¨¬¥­®¢ ­¨¥ ã¯®«­®¬®ç¥­­®£® ¡ ­ª  ######################################### " + "\n" +
        " ############################################################################ " + "\n" +
        "                   ÚÄÄÄÄÄ¿                                                    " + "\n" +
        " Š®¤ ¢¨¤  ®¯¥à æ¨¨ ³ ### ³                                                    " + "\n" +
        "                   ÀÄÄÄÄÄÙ                                  ˆ•„      ‘¨¬¢®«" + "\n" +
        "                                    ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄ¿" + "\n" +
        " à¨­ïâ® ###########################³ áç¥â N             ³  ‘ã¬¬  æ¨äà ¬¨ ³  ³" + "\n" +
        "####################################³####################³### ############³##³" + "\n" +
        "####################################³                    ³                ³  ³" + "\n" +
        "####################################³                    ³                ³  ³" + "\n" +
        "ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄ´" + "\n" +
        "                                    ³                    ³  €‘•„        ³  ³" + "\n" +
        "ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄ´" + "\n" +
        " ‚ë¤ ­®  ###########################³ áç¥â N             ³  ‘ã¬¬  æ¨äà ¬¨ ³  ³" + "\n" +
        "####################################³####################³### ############³##³" + "\n" +
        "####################################³                    ³                ³  ³" + "\n" +
        "####################################³                    ³                ³  ³" + "\n" +
        "                                    ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÙ" + "\n" +
        "                                                                              " + "\n" +
        " #############################__________________ #############################" + "\n" +
        "   (­ ¨¬¥­®¢ ­¨¥ ¤®«¦­®áâ¨)     («¨ç­ ï ¯®¤¯¨áì)       (ä ¬¨«¨ï, ¨­¨æ¨ «ë)    " + "\n" +
        "                                                                              " + "\n" +
        " #############################__________________ #############################" + "\n" +
        "   (­ ¨¬¥­®¢ ­¨¥ ¤®«¦­®áâ¨)     («¨ç­ ï ¯®¤¯¨áì)       (ä ¬¨«¨ï, ¨­¨æ¨ «ë)    " + "\n" +
        "                                                                              " + "\n" +
        " #############################__________________ #############################" + "\n" +
        "   (­ ¨¬¥­®¢ ­¨¥ ¤®«¦­®áâ¨)     («¨ç­ ï ¯®¤¯¨áì)       (ä ¬¨«¨ï, ¨­¨æ¨ «ë)    " + "\n" +
        "                                                                              " + "\n" +
        "                                                                              " + "\n";
    params.add( documentNumber, ":c" );
    params.add( _DateToStr( docDate ) );
    params.add( bankNameArray[0] );
    params.add( bankNameArray[1] );
    params.add( ExchangeOperationCode );
    params.add( sumDebArray[0] );
    params.add( sumDebArray[1] );
    params.add( debitAccount );
    params.add( getSymbCodeCurr( debitCurrCode ) );
    params.add( debitAmount, ":r" );
    params.add( debitCashSymbol );
    params.add( sumDebArray[2] );
    params.add( sumDebArray[3] );
    params.add( sumCreArray[0] );
    params.add( sumCreArray[1] );
    params.add( creditAccount );
    params.add( getSymbCodeCurr( creditCurrCode ) );
    params.add( creditAmount, ":r" );
    params.add( creditCashSymbol );
    params.add( sumCreArray[2] );
    params.add( sumCreArray[3] );
    params.add( operWork, ":c" );
    params.add( operName, ":c" );
    params.add( controllerWork, ":c" );
    params.add( controllerName, ":c" );
    params.add( cashierWork, ":c" );
    params.add( cashierName, ":c" );

    template = template +
        "                                                       ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿   " + "\n" +
        "     ‚ «îâ­ë© ª áá®¢ë© ®à¤¥à                           ³    Š®¤ ä®à¬ë     ³   " + "\n" +
        "                                                       ³   ¤®ªã¬¥­â  ¯®   ³   " + "\n" +
        "                                                       ³  Š“„  0401106   ³   " + "\n" +
        "                                                       ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ   " + "\n" +
        "                   ÚÄÄÄÄÄÄÄÄÄÄ¿                                               " + "\n" +
        " Š€‘‘‚›‰ „… N  ³ ######## ³                                               " + "\n" +
        "                   ÀÄÄÄÄÄÄÄÄÄÄÙ    ####################                       " + "\n" +
        "                                        „ â                                   " + "\n" +
        "  ¨¬¥­®¢ ­¨¥ ã¯®«­®¬®ç¥­­®£® ¡ ­ª  ######################################### " + "\n" +
        " ############################################################################ " + "\n" +
        "                   ÚÄÄÄÄÄ¿                                                    " + "\n" +
        " Š®¤ ¢¨¤  ®¯¥à æ¨¨ ³ ### ³                                                    " + "\n" +
        "                   ÀÄÄÄÄÄÙ                  „……’                   ‘ã¬¬  æ¨äà ¬¨       " + "\n" +
        "                                    ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿" + "\n" +
        " à¨­ïâ® ###########################³ áç¥â N             ³            ³                ³" + "\n" +
        "####################################³####################³############³### ############³" + "\n" +
        "####################################³                    ³            ³                ³" + "\n" +
        "####################################³                    ³            ³                ³" + "\n" +
        "ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´" + "\n" +
        "                                    ³       Š…„ˆ’                                     ³" + "\n" +
        "ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´" + "\n" +
        " ‚ë¤ ­®  ###########################³ áç¥â N             ³            ³                ³" + "\n" +
        "####################################³####################³############³### ############³" + "\n" +
        "####################################³                    ³            ³                ³" + "\n" +
        "####################################³                    ³            ³                ³" + "\n" +
        "                                    ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ" + "\n" +
        "                                                                              " + "\n" +
        " #############################__________________ #############################" + "\n" +
        "   (­ ¨¬¥­®¢ ­¨¥ ¤®«¦­®áâ¨)     («¨ç­ ï ¯®¤¯¨áì)       (ä ¬¨«¨ï, ¨­¨æ¨ «ë)    " + "\n" +
        "                                                                              " + "\n";
    params.add( documentNumber, ":c" );
    params.add( _DateToStr( docDate ) );
    params.add( bankNameArray[0] );
    params.add( bankNameArray[1] );
    params.add( ExchangeOperationCode );
    params.add( sumDebArray[0] );
    params.add( sumDebArray[1] );
    params.add( debitAccount );
    params.add( sumRubDeb, ":r" );
    params.add( getSymbCodeCurr( debitCurrCode ) );
    params.add( debitAmount, ":r" );
    params.add( sumDebArray[2] );
    params.add( sumDebArray[3] );
    params.add( sumCreArray[0] );
    params.add( sumCreArray[1] );
    params.add( creditAccount );
    params.add( sumRubCre, ":r" );
    params.add( getSymbCodeCurr( creditCurrCode ) );
    params.add( creditAmount, ":r" );
    params.add( sumCreArray[2] );
    params.add( sumCreArray[3] );
    params.add( operWork, ":c" );
    params.add( operName, ":c" );

    template = template +
        "                                                                                           " + "\n" +
        "                                      Šãàá®¢ ï à §­¨æ                                      " + "\n" +
        "ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿" + "\n" +
        "³   „•„                                    ³   €‘•„                                   ³" + "\n" +
        "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´" + "\n" +
        "³         „……’                 ‘ã¬¬  æ¨äà ¬¨³         „……’                 ‘ã¬¬  æ¨äà ¬¨³" + "\n" +
        "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´" + "\n" +
        "³ áç¥â N #################### ³ ############ ³ áç¥â N #################### ³ ############ ³" + "\n" +
        "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´              ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´              ³" + "\n" +
        "³         Š…„ˆ’              ³              ³         Š…„ˆ’              ³              ³" + "\n" +
        "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´              ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´              ³" + "\n" +
        "³ áç¥â N #################### ³              ³ áç¥â N #################### ³              ³" + "\n" +
        "ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ" + "\n";
    params.add( RDinAccDeb, ":l" );
    params.add( RDinSum, ":l" );
    params.add( RDoutAccDeb, ":l" );
    params.add( RDoutSum, ":l" );
    params.add( RDinAccCre, ":l" );
    params.add( RDoutAccCre, ":l" );

    template = template +
        "                                                                              " + "\n" +
        " #############################__________________ #############################" + "\n" +
        "   (­ ¨¬¥­®¢ ­¨¥ ¤®«¦­®áâ¨)     («¨ç­ ï ¯®¤¯¨áì)       (ä ¬¨«¨ï, ¨­¨æ¨ «ë)    " + "\n" +
        "                                                                              " + "\n" +
        " #############################__________________ #############################" + "\n" +
        "   (­ ¨¬¥­®¢ ­¨¥ ¤®«¦­®áâ¨)     («¨ç­ ï ¯®¤¯¨áì)       (ä ¬¨«¨ï, ¨­¨æ¨ «ë)    " + "\n" +
        "                                                                              " + "\n" +
        "                                                                              " + "\n";
    params.add( controllerWork, ":c" );
    params.add( controllerName, ":c" );
    params.add( cashierWork, ":c" );
    params.add( cashierName, ":c" );

    template = "\n" + template;
    var str = "rep.AutoScan(\"[\" + template + \"]()\"," +  params.getList() + ")";
    ExecExp(str);
  end;

// --------------------------------------------------------------------------
  macro printOrder( FileNameTxt:string, Copies:integer )
    var TempRep = "", FileNameOffic = "";

    init();
    
    // Œ¥­ï¥¬ èà¨äâ ¯®-ã¬®«ç ­¨î, çâ®¡ë ®âç¥â ¢ Word-¥ ¢«¥§ ¢ «¨áâ ä®à¬ â  €4
    rep.SetDefaultFontSize(8);

    makeOrder(0);
    
    FileNameOffic = "EXCHO" + StrSubst( string({curdate}), ".", "" );
                                        
    if (FileNameTxt == null)
      FileNameTxt = FileNameOffic + "." + string({CNum});
    end;

    rep.SetFileNameWin( FileNameOffic );

//    SetOutPut( GetRegVal( "BANK_INI\\™ˆ… €€Œ…’›\\„ˆ…Š’ˆˆ\\TEXTDIR" ) + "\\" + FileNameTxt );

    if ( ( ORDER_PRINT_FORMAT == OPF_TXT      ) or ( ORDER_PRINT_FORMAT == OPF_MSOFFICE_TXT ) )
      RT_PrintRep( rep, Copies );
    end;
    if ( ( ORDER_PRINT_FORMAT == OPF_MSOFFICE ) or ( ORDER_PRINT_FORMAT == OPF_MSOFFICE_TXT ) )
      rep.SetWinRepOutPut( 0, 0 );
      rep.AddWinRepOutput( WINREP_OUTPUT_WORD, WINREP_FORMAT_DOC );
      rep.SetExecuteWord( "WordDocument.PageSetup.LeftMargin = 20;" );
      rep.SetExecuteWord( "WordDocument.PageSetup.TopMargin  = 20;" );
      rep.PrintWinRep();
      RT_PrintOut_Doc( rep, Copies );
      rep.ShowWinRep();
    end;
  end;

end;

// --------------------------------------------------------------------------
private macro PrintRTDocumentExch( RTDocID:integer, FileNameTxt:string, Copies:integer ):integer
  var order = EXCHO( RTDocID );
  order.printOrder( FileNameTxt, Copies );
end;

// --------------------------------------------------------------------------
macro PrintRTDocument( RTDocID:integer, Copies:integer ):integer
  var FileNameTxt = "EXCH" + StrSubst( string({curdate}), ".", "" ) + "." + string({CNum});

  PrintRTDocumentExch( RTDocID, FileNameTxt, Copies );

OnError(err)
  ShowError(err);
end;
