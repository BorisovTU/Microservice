/*
$Name:        PFRFillReport.mac
$Module:      RS-Retail
$Description: ПФР: Сбор данных для ежегодной отчетности
*/
import oralib, likepy;

private var ReportId, ReportType;

private macro SetPFRClientActionTRN
  if( ReportType == 1 ) // SOST
    execStoredFunc( "RSU_RTLPFR.SetPFRRLineClientId", V_UNDEF, makeArray( SQLParam("", ReportId)) );
  else
    execStoredFunc( "RSU_RTLPFR.FillPFRReport", V_UNDEF, makeArray( SQLParam("", ReportId)) );
  end;

  execStoredFunc( "RSU_RTLPFR.SetPFRClientAction", V_UNDEF, makeArray( SQLParam("", ReportId)) );
  execStoredFunc( "RSU_RTLPFR.SplitPFRReport", V_UNDEF, makeArray( SQLParam("", ReportId)) );
end;

macro SetPFRClientAction
  var cmd = RsdCommand("SELECT DISTINCT t_noticeid, t_noticetype FROM drtpfrregistry_dbt " + 
                       " WHERE t_status = 0 AND t_kind = 'Y'");
  cmd.execute;
  var rs = RsdRecordset(cmd);
  while( rs.movenext )
    ReportId = rs.value("t_noticeid");
    ReportType = rs.value("t_noticetype");
    ProcessTrn(null, "SetPFRClientActionTRN");    
  end;
end;

SetPFRClientAction;
