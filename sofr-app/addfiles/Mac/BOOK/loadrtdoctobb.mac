/*
$Name:             loadrtdoctobb.mac
$Module:           €Œ ãå£ «â¥à 
$Description:      Œ ªà®á ¢ë£àã§ª¨ „„ ¢ ãå£ «â¥à¨î ¡ ­ª 
*/
/**************************************************************************\
*  ---------------                                                         *
*  R-Style Softlab                                                         *
*  ---------------                                                         *
*  RS-Retail                                                               *
*                                                                          *
*  €Œ ãå£ «â¥à                                                           *
*                                                                          *
*  ®¤£®â®¢ª  ¤®ªã¬¥­â  ª ¢ë£àã§ª¥ ¢ ãå£ «â¥à¨î ¡ ­ª                      *
*                                                                          *
*  ‹¥¡¥¤¥¢ ‘.‚.                                                            *
*  28.09.2004                                                              *
\**************************************************************************/

import PaymInter, BankInter, DeprIntr, RSD, sqlconv;
import IncomingPaymentUnLoad;

private const OK_RES   =  0, // ¢á¥ ­®à¬ «ì­®
              SKIP_RES =  1, // ¯à®¯ãáâ¨âì ¢ë¯®«­¥­¨¥ è £ 
              END_RES  =  2, // § ¢¥àè¨âì ®¯¥à æ¨î
              ERR_RES  = -1; // § ¢¥àè¨âì ®¯¥à æ¨î á ®è¨¡ª®©

private const UNLOAD_OK        = 0, // ãá¯¥è­ ï ¢ë£àã§ª 
              UNLOAD_ERROR     = 1, // ®è¨¡ª  ¢ë£àã§ª¨
              CHECK_ERROR      = 2, // ¯à®¢¥àª  ¢ë£àã¦ ¥¬®áâ¨ ­¥ ¯à®©¤¥­ 
              CONVERT_OK       = 3, // ãá¯¥è­®¥ ª®­¢¥àâ¨à®¢ ­¨¥
              CONVERT_ERROR    = 4, // ®è¨¡ª  ª®­¢¥àâ¨à®¢ ­¨ï
              CONVERT_CANCELED = 5, // ª®­¢¥àâ¨à®¢ ­¨¥ ®âª«®­¥­®
              ROLLBACK_OK      = 6, // ãá¯¥è­ë© ®âª â ¢ë£àã§ª¨
              ROLLBACK_ERROR   = 7; // ®è¨¡ª  ®âª â  ¢ë£àã§ª¨

private var {oper};
private var {OurBank};

private var CashOrder : BOCashOrderParm;
private var MemorialOrder : BOMemorialOrderParm;
private var MultyDoc : BOMultyDocParm;
private var BankOrder : BOBankOrderParm;
private var BankPayment : BOBankPaymentParm;
private var BankClaim : BOBankClaimParm;
private var CurrencyPayment : BOCurrencyPaymentParm;
private var TransferOrder : BOTransferOrderParm;

private const BO_RS_RETAIL = 2;

private const RDD_CASH_IN = 1;        // à¨å®¤­ë© ª áá®¢ë© ®à¤¥à
private const RDD_CASH_OUT = 2;       //  áå®¤­ë© ª áá®¢ë© ®à¤¥à
private const RDD_MEMORDER = 3;       // Œ¥¬®à¨ «ì­ë© ®à¤¥à
private const RDD_BANKORDER = 4;      //  ­ª®¢áª¨© ®à¤¥à
private const RDD_PAYMENT_ORDER = 5;  // « â¥¦­®¥ ¯®àãç¥­¨¥
private const RDD_INCASS_ORDER = 6;   // ˆ­ª áá®¢®¥ ¯®àãç¥­¨¥
private const RDD_CUR_TRANSFER = 7;   // ‚ «îâ­ë© ¯¥à¥¢®¤
private const RDD_VALUE_ORDER = 8;    // Žà¤¥à ¯® ¯¥à¥¤ ç¥ æ¥­­®áâ¥©
private const RDD_EXCHANGE_ORDER = 9; // à¨å®¤­®-à áå®¤­ë© ®à¤¥à ¤«ï ‚ŽŽ

private const FOLDSIDE_NONE = 0;   // ­¥ § ¤ ­®
private const FOLDSIDE_CREDIT = 1; // áç¥â ªà¥¤¨â 
private const FOLDSIDE_DEBIT = 2;  // áç¥â ¤¥¡¥â 

private const TS_DEBET = 1;  // ¯à¨å®¤
private const TS_KREDIT = 2; // à áå®¤
private const TS_NOTB = 3; //§ ¡ «.

private const CASH_FDOC_RETAIL = 4;
private const CB_DOC_ORIGIN_RETAIL = 3;
private const MULTYDOC_ORIGIN_RETAIL = 3;
private const MEMORDER_FDOC_RETAIL = 8;
private const CP_OR_RETAIL = 10;
private const PD_OR_RETAIL = 5;

private const CB_MULTYDOC = 15;
private const DLDOC_BANKPAYMENT = 16;
private const DLDOC_BANKCLAIM = 17;
private const BBANK_CPORDER = 27;
private const DLDOC_MEMORIALORDER = 70;
private const PS_CPORDER = 202;
private const DLDOC_BANKORDER = 286;
private const DLDOC_VALTRORDER = 288;
private const CASH_BOF_ADDORDER = 400;
private const CASH_BOF_INCORDER = 430;
private const CASH_BOF_OUTORDER = 440;
              
private var saveInCurCode = -2;
private var saveOutCurCode = 0;
                       
private var retDocsBatch = null;
private var retDocsResult = null;

private var statInsert = 0;
private var postActionTypeInsert = 0;
private var statDelete = 0;

private var rtdocument = TBFile( "rtdocument.dbt", "r", 0 );
private var sbdepdoc_pa = TBFile( "sbdepdoc.dbt", "r", 3 );
private var pay_doc_pa = TBFile( "pay_doc.dbt", "r", 2 );
private var oproper = TBFile( "oproper.dbt", "r", 0 );
private var pmpaym = TBFile( "pmpaym.dbt", "r", 1 );

private var fm_online_check = false; // à®¢¥àª  ”Œ ¢ ®¯¥à â¨¢­®¬ à¥¦¨¬¥
private var massRegim = 0;
private var isAutoExec = false;
private var isLoadCurrTransferToBB = false;
private var signKindExternPay = false;
private var signKindCashDoc = false;
private var signKindMemOrder = false;
private var signKindMultiDoc = false;
private var batchDocCount = 20;
private var ContextRetailESign = "RS-Retail|’Š|‚ë£àã§ª _¯« â¥¦¥©_¢_";
private var firstCallExportFunction = true;

GetRegistryValue( "RS-RETAIL\\‘…‚ˆ‘›…\\”ˆ€‘Ž‚›‰_ŒŽˆ’Žˆƒ\\Ž…€’ˆ‚€Ÿ_Ž‚…Š€", V_BOOL, fm_online_check );
GetRegistryValue( "RS-RETAIL\\‘…‚ˆ‘›…\\“•ƒ€‹’…ˆŸ\\‚›ƒ“‡Š€\\Ž‚Ž„Š€_‚_“•ƒ€‹’…ˆž_€Š€\\Œ€‘‘Ž‚›‰_…†ˆŒ", V_INTEGER, massRegim );
GetRegistryValue( "RS-RETAIL\\‘…‚ˆ‘›…\\“•ƒ€‹’…ˆŸ\\‚›ƒ“‡Š€\\‚›Ž‹…ˆ…_Ž…€–ˆˆ_”Ž’_Ž”ˆ‘€", V_BOOL, isAutoExec );
GetRegistryValue( "RS-RETAIL\\‘…‚ˆ‘›…\\“•ƒ€‹’…ˆŸ\\‚›ƒ“‡Š€\\‚›ƒ“†€’œ_‚€‹ž’›‰_‹€’…†_‚_", V_BOOL, isLoadCurrTransferToBB );
GetRegistryValue( "RS-RETAIL\\‘…‚ˆ‘›…\\–\\‚›ƒ“‡Š€_‚_€Š\\‚…˜ˆ‰_‹€’…†", V_BOOL, signKindExternPay );
GetRegistryValue( "RS-RETAIL\\‘…‚ˆ‘›…\\–\\‚›ƒ“‡Š€_‚_€Š\\Š€‘‘Ž‚›‰_„ŽŠ“Œ…’", V_BOOL, signKindCashDoc );
GetRegistryValue( "RS-RETAIL\\‘…‚ˆ‘›…\\–\\‚›ƒ“‡Š€_‚_€Š\\Œ…ŒŽˆ€‹œ›‰_Ž„…", V_BOOL, signKindMemOrder );
GetRegistryValue( "RS-RETAIL\\‘…‚ˆ‘›…\\–\\‚›ƒ“‡Š€_‚_€Š\\Œ“‹œ’ˆ‚€‹ž’›‰_„ŽŠ“Œ…’", V_BOOL, signKindMultiDoc );
GetRegistryValue( "RS-RETAIL\\‘…‚ˆ‘›…\\“•ƒ€‹’…ˆŸ\\‚›ƒ“‡Š€\\Ž‚Ž„Š€_‚_“•ƒ€‹’…ˆž_€Š€\\Œ€‘‘Ž‚›‰_…†ˆŒ\\€‡Œ…_€Š…’€", V_INTEGER, batchDocCount );
                      
class UnloadAccDocResult
  var AccDocID : string;     // áâà®ª®¢ë© ¨¤¥­â¨ä¨ª â®à „„
  var ResultCode : integer;  // ª®¤ ¢®§¢à â  „„
  var errorCode : integer;   // ª®¤ ®è¨¡ª¨ ¢ë£àã§ª¨ „„
  var errorMessage : string; // á®®¡é¥­¨¥ ®¡ ®è¨¡ª¥ ¢ë£àãª§¨ „„
  var paymentID : string;    // ¨¤¥­â¨ä¨ª â®à ¤®ªã¬¥­â  ¢ 
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro DefRDDBaseDocType( inDocType )

  var cmd;
  var rs;
  var outDocType = inDocType;

  cmd = RsdCommand( "select pmdtype.t_systemAnalogId as systemAnalogId from dpmdtype_dbt pmdtype where pmdtype.t_DocTypeId = :docType" );

  cmd.addParam( "docType", RSDBP_IN, inDocType );

  rs = RsdRecordset( cmd );

  cmd.execute( );

  if ( rs.moveNext( ) )
    if ( ValType( rs.value( "systemAnalogId" ) ) != V_UNDEF )
      if ( rs.value( "systemAnalogId" ) > 0 )
        outDocType = Int( rs.value( "systemAnalogId" ) );
      end;
    end;
  end;
    
  return outDocType;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro isOneCurrRtDoc

  var flagOneCurr = true;
  var cmd;
  var rs;

  if ( rtdocument.rec.FoldSide == FOLDSIDE_NONE )
    if ( rtdocument.rec.DebitCurrCode != rtdocument.rec.CreditCurrCode )
      flagOneCurr = false;
    end;
  else
    cmd = RsdCommand( "select 1 from drtdocaccount_dbt rtdocaccount where rtdocaccount.t_DocumentID = :docId and rtdocaccount.t_CurrCode != :currCode" );

    cmd.addParam( "docId", RSDBP_IN, rtdocument.rec.DocumentID );

    if ( rtdocument.rec.FoldSide != FOLDSIDE_DEBIT )
      cmd.addParam( "currCode", RSDBP_IN, rtdocument.rec.CreditCurrCode );
    else
      cmd.addParam( "currCode", RSDBP_IN, rtdocument.rec.DebitCurrCode );
    end;

    rs = RsdRecordset( cmd );

    cmd.execute( );

    if ( rs.moveNext( ) )
      flagOneCurr = false;
    end;
  end;

  return flagOneCurr;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro DefBankId

  var bankId = 0;
  var numDepartment = rtdocument.rec.Department;
  var cmd;
  var rs;

  if ( ( numDepartment == 0 ) and ( rtdocument.rec.Branch != 0 ) )

    cmd = RsdCommand(" {? = call rsu_rtlcommon.GetDepFNCash( ? )} ");
    cmd.addParam( "p_retVal", RsdBp_Out, V_INTEGER );
    cmd.addParam( "p_branch", RsdBp_In, rtdocument.rec.Branch );
    cmd.execute;

    numDepartment = cmd.value("p_retVal");

    if ( ValType( numDepartment ) != V_INTEGER )
      numDepartment = 0;
    end;
  end;

  if ( numDepartment > 0 )
    cmd = RsdCommand( "select t_PartyID as partyId from ddp_dep_dbt where t_code = ?" );

    cmd.addParam( "p_Code", RSDBP_IN, numDepartment );

    cmd.execute;

    rs = RsdRecordset( cmd );

    if ( rs.moveNext )
      bankId = rs.value( "partyId" );
    end;
  end;

  if ( bankId == 0 )
    bankId = {OurBank};
  end;

  return bankId;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro DefCodeCurr( inCurCode )

  var cmd;
  var rs;
  var outCurCode = inCurCode;

  if ( saveInCurCode == inCurCode )
    return saveOutCurCode;
  end;

  cmd = RsdCommand( "select fininstr.t_FIID as fiid "
                    "from dfininstr_dbt fininstr, dcurrency_dbt currency "
                    "where currency.t_code_currency = :curCode "
                      "and fininstr.t_fi_kind in ( 1, 6 ) "
                      "and ( upper( fininstr.t_fi_code ) = upper( currency.t_externalCode ) or "
                            "upper( fininstr.t_codeInAccount ) = upper( currency.t_externalCode ) )" );

  cmd.addParam( "curCode", RSDBP_IN, inCurCode );

  rs = RsdRecordset( cmd );

  cmd.execute( );

  if ( rs.moveNext( ) )
    if ( ValType( rs.value( "fiid" ) ) != V_UNDEF )
      outCurCode = Int( rs.value( "fiid" ) );
    end;
  end;

  saveInCurCode = inCurCode;
  saveOutCurCode = outCurCode;

  return outCurCode;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro DefCodeForValue( docId, partyId, tempPartyId, valueRef, valueNumPieces, valueCost )

  var cmd;
  var rs;
  var stat = 0;

  partyId = 0;
  tempPartyId = 0;
  valueRef = 0;
  valueNumPieces = 0;
  valueCost = $0L;

  if ( docId <= 0 )
    SetParm( 1, partyId );

    SetParm( 2, tempPartyId );

    SetParm( 3, valueRef );

    SetParm( 4, valueNumPieces );

    SetParm( 5, valueCost );

    return stat;
  end;

  cmd = RsdCommand( "select rtcashorder.* " + 
                    "from drtcashorder_dbt rtcashorder " +
                    "where rtcashorder.t_DocumentId = :docId");

  cmd.addParam( "docId", RSDBP_IN, docId );

  rs = RsdRecordset( cmd );

  cmd.execute( );

  if ( rs.moveNext( ) )

    if ( ( ValType( rs.value( "t_valueOwnerPartyID" ) ) == V_INTEGER ) or ( ValType( rs.value( "t_valueOwnerPartyID" ) ) == V_DOUBLE ) )
      partyId = Int( rs.value( "t_valueOwnerPartyID" ) );
    end;

    if ( ( ValType( rs.value( "t_valueOwnerTempPartyID" ) ) == V_INTEGER ) or ( ValType( rs.value( "t_valueOwnerTempPartyID" ) ) == V_DOUBLE ) )
      tempPartyId = Int( rs.value( "t_valueOwnerTempPartyID" ) );
    end;

    if ( ( ValType( rs.value( "t_valueRef" ) ) == V_INTEGER ) or ( ValType( rs.value( "t_valueRef" ) ) == V_DOUBLE ) )
      valueRef = Int( rs.value( "t_valueRef" ) );
    end;

    if ( ( ValType( rs.value( "t_valueNumPieces" ) ) == V_INTEGER ) or ( ValType( rs.value( "t_valueNumPieces" ) ) == V_DOUBLE ) )
      valueNumPieces = Int( rs.value( "t_valueNumPieces" ) );
    end;

    if ( ( ValType( rs.value( "t_valueCost" ) ) == V_MONEY ) or ( ValType( rs.value( "t_valueCost" ) ) == V_MONEYL ) )
      valueCost = Int( rs.value( "t_valueCost" ) );
    end;
  end;

  SetParm( 1, partyId );

  SetParm( 2, tempPartyId );

  SetParm( 3, valueRef );

  SetParm( 4, valueNumPieces );

  SetParm( 5, valueCost );

  return stat;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro DefCheckTerror( )

  var checkTerror = 2;

  if ( rtdocument.rec.isConsolidated == "" )
    if ( fm_online_check )
      checkTerror = 1;
    else
      checkTerror = 0;
    end;
  end;

  return checkTerror;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro StringToDate ( inString )

  var retValue = Date( 0, 0, 0 );
  var d, m, y;

  if ( StrLen( inString ) == 10 )
    d = Int( SubStr( inString, 1, 2 ) );
    m = Int( SubStr( inString, 4, 2 ) );
    y = Int( SubStr( inString, 7 ) );

    if ( ( d > 0 ) and ( d <= 31 ) and ( m > 0 ) and ( m <= 12 ) and ( y > 0 ) )
      retValue = Date( d, m, y );
    end;
  end;


  return retValue;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro FillFromTemporaryParty( id, innkpp, bankCodeKind, bankCode, bankName, corrAccount, withoutKPP )

  var cmd;
  var rs;
  var stat = 0;
  var inn = "";
  var kpp = "";

  innkpp = "";
  bankCodeKind = 0;
  bankCode = "";
  bankName = "";
  corrAccount = "";

  if ( ValType( withoutKPP ) != V_BOOL )
    withoutKPP = false;
  end;

  if ( id <= 0 )
    SetParm( 1, innkpp );

    SetParm( 2, bankCodeKind );

    SetParm( 3, bankCode );

    SetParm( 4, bankName );

    SetParm( 5, corrAccount );

    return stat;
  end;

  cmd = RsdCommand( "select temporaryparty.* " + 
                    "from dtemporaryparty_dbt temporaryparty " + 
                    "where temporaryparty.t_temppartyid = :id" );

  cmd.addParam( "id", RSDBP_IN, id );

  rs = RsdRecordset( cmd );

  cmd.execute( );

  if ( rs.moveNext( ) )
    if ( ValType( rs.value( "t_INN" ) ) != V_UNDEF )
      inn = Trim( rs.value( "t_INN" ) );
    end;

    if ( ValType( rs.value( "t_KPP" ) ) != V_UNDEF )
      kpp = Trim( rs.value( "t_KPP" ) );
    end;

    if ( inn == StrFor( 1 ) )
      inn = "";
    end;

    if ( kpp == StrFor( 1 ) )
      kpp = "";
    end;

    innkpp = inn;

    if ( withoutKPP )
      ;
    elif ( kpp != "" )
      innkpp = innkpp + "/" + kpp;
    end;

    if ( ValType( rs.value( "t_BankCodeKind" ) ) != V_UNDEF )
      bankCodeKind = Int( rs.value( "t_BankCodeKind" ) );
    end;

    if ( ValType( rs.value( "t_BankCode" ) ) != V_UNDEF )
      bankCode = Trim( rs.value( "t_BankCode" ) );

      if ( bankCode == StrFor( 1 ) )
        bankCode = "";
      end;
    end;

    if ( ValType( rs.value( "t_Name" ) ) != V_UNDEF )
      bankName = Trim( rs.value( "t_Name" ) );

      if ( bankName == StrFor( 1 ) )
        bankName = "";
      end;
    end;

    if ( ValType( rs.value( "t_BankCorrAccount" ) ) != V_UNDEF )
      corrAccount = Trim( rs.value( "t_BankCorrAccount" ) );

      if ( corrAccount == StrFor( 1 ) )
        corrAccount = "";
      end;
    end;
  end;

  SetParm( 1, innkpp );

  SetParm( 2, bankCodeKind );

  SetParm( 3, bankCode );

  SetParm( 4, bankName );

  SetParm( 5, corrAccount );

  return stat;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro FillFromParty( id, name )

  var cmd;
  var rs;
  var stat = 0;

  name = "";

  if ( id <= 0 )
    SetParm( 1, name );

    return stat;
  end;

  cmd = RsdCommand( "select party.t_name from dparty_dbt party where party.t_partyid = :id" );

  cmd.addParam( "id", RSDBP_IN, id );

  rs = RsdRecordset( cmd );

  cmd.execute( );

  if ( rs.moveNext( ) )
    if ( ValType( rs.value( "t_name" ) ) != V_UNDEF )
      name = Trim( rs.value( "t_name" ) );

      if ( name == StrFor( 1 ) )
        name = "";
      end;
    end;
  end;

  SetParm( 1, name );

  return stat;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro FillFromCashVal( id, name )

  var cmd;
  var rs;
  var stat = 0;

  name = "";

  if ( id <= 0 )
    SetParm( 1, name );

    return stat;
  end;

  cmd = RsdCommand( "select sb_casvl.* from dsb_casvl_dbt sb_casvl where sb_casvl.t_refValue = :id" );

  cmd.addParam( "id", RSDBP_IN, id );

  rs = RsdRecordset( cmd );

  cmd.execute( );

  if ( rs.moveNext( ) )
    if ( ValType( rs.value( "t_nameValue" ) ) != V_UNDEF )
      name = Trim( rs.value( "t_nameValue" ) );

      if ( name == StrFor( 1 ) )
        name = "";
      end;
    end;
  end;

  SetParm( 1, name );

  return stat;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro NeedElectronicReestr( )

  var stat = false;
  var cmd;
  var rs;
  var opApplKind = 0;
  var opApplKey = "";
  var docApplKind = 0;
  var docApplKey = "";

  if ( rtdocument.rec.isConsolidated == "" )
    opApplKind = rtdocument.rec.opApplicationKind;
    opApplKey = rtdocument.rec.opApplicationKey;
  else
    cmd = RsdCommand( "select rtdocument.t_opApplicationKind, rtdocument.t_opApplicationKey from drtdocument_dbt rtdocument " +
                      "where rtdocument.t_ConsDocumentID = :docId");

    cmd.addParam( "docId", RSDBP_IN, rtdocument.rec.DocumentID );

    rs = RsdRecordset( cmd );

    rs.NullConversion = true;

    cmd.execute( );

    if ( rs.moveNext( ) )

      if ( ( ValType( rs.value( "t_opApplicationKind" ) ) == V_INTEGER ) or ( ValType( rs.value( "t_opApplicationKind" ) ) == V_DOUBLE ) )
        opApplKind = Int( rs.value( "t_opApplicationKind" ) );
      end;

      if ( ValType( rs.value( "t_opApplicationKey" ) ) == V_STRING )
        opApplKey = rs.value( "t_opApplicationKey" );

        if ( opApplKey == StrFor( 1 ) )
          opApplKey = "";
        end;
      end;
    end;
  end;

  if ( opApplKey != "" )
    cmd = RsdCommand( "select sb_casln.t_applicationKind2, sb_casln.t_applicationKey2 from dsb_casln_dbt sb_casln " +
                      "where sb_casln.t_applicationKind1 = :applKind "
                      "  and sb_casln.t_applicationKey1 = :applKey "
                      "  and sb_casln.t_refValue2 = 0 "
                      "  and sb_casln.t_applicationKind2 in ( 1, 20 )" );

    cmd.addParam( "applKind", RSDBP_IN, opApplKind );
    cmd.addParam( "applKey", RSDBP_IN, opApplKey );

    rs = RsdRecordset( cmd );

    rs.NullConversion = true;

    cmd.execute( );

    if ( rs.moveNext( ) )
      if ( ( ValType( rs.value( "t_applicationKind2" ) ) == V_INTEGER ) or ( ValType( rs.value( "t_applicationKind2" ) ) == V_DOUBLE ) )
        docApplKind = Int( rs.value( "t_applicationKind2" ) );
      end;

      if ( ValType( rs.value( "t_applicationKey2" ) ) == V_STRING )
        docApplKey = rs.value( "t_applicationKey2" );

        if ( docApplKey == StrFor( 1 ) )
          docApplKey = "";
        end;
      end;
    end;
  end;

  if ( docApplKey != "" )
    cmd = RsdCommand( "select pay_recv.t_IsElectronicReestr " +
                      "from drtcp_recipient_dbt pay_recv, drtcp_link_dbt cplink, dpay_doc_cp_dbt pay_doc " +
                      "where pay_recv.t_Id = cplink.t_RecipientId " +
                      "  and cplink.t_Id = pay_doc.t_CPLinkId " +
                      "  and pay_doc.t_ApplKind = :applKind " +
                      "  and pay_doc.t_ApplKey = :applKey" );

    cmd.addParam( "applKind", RSDBP_IN, docApplKind );
    cmd.addParam( "applKey",  RSDBP_IN, docApplKey );

    cmd.execute( );
        
    rs = RsdRecordset( cmd );

    rs.NullConversion = true;

    if ( rs.moveNext( ) )
      if ( rs.value( "t_IsElectronicReestr" ) != "" )
        stat = true;
      end;
    end;
  end;

  return stat;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro DefErrorText ( errCode, isRetailError )

  var errText = "";
  var cmd;
  var rs;

  if ( ValType( isRetailError ) == V_UNDEF )
    isRetailError = true;
  end;

  if ( not isRetailError )
    errText = GetErrMsg( );

    if ( ( ValType( errText ) == V_STRING ) and ( errText != "" ) )
      return errText;
    else
      errText = "";
    end;
  end;

  if ( isRetailError )
    cmd = RsdCommand( "select t_contents errText from dsbbank_msg where t_number = :errCode" );
  else
    cmd = RsdCommand( "select t_contents errText from dbank_msg where t_number = :errCode" );
  end;

  cmd.addParam( "errCode", RSDBP_IN, errCode );

  cmd.execute;

  rs = RsdRecordSet( cmd );

  if ( rs.moveNext )
    errText = rs.value( "errText" );

    if ( errText == StrFor( 1 ) )
      errText = "";
    end;
  end;

  return errText;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro DefValueDate ( valueDate )

  var stat = 0;
  var department = rtdocument.rec.Department;
  var onlyOneDoc = false;
  var saveDialogFlag;
  var errText = "";
  var cmd;
  var rs;

  valueDate = rtdocument.rec.ValueDate;

  if ( massRegim == 0 ) 
    cmd = RsdCommand( "select count( * ) nn from drtdocref_tmp" );

    cmd.execute;

    rs = RsdRecordset( cmd );

    if ( rs.moveNext ) 
      if ( rs.value( "nn" ) == 1 )
        cmd = RsdCommand( "select 1 from drtdocref_tmp where t_documentid = :docId" );

        cmd.addParam( "docId", RSDBP_IN, rtdocument.rec.DocumentID );

        cmd.execute;

        rs = RsdRecordset( cmd );

        if ( rs.moveNext ) 
          onlyOneDoc = true;
        end;
      end;
    end;
  end;

  stat = CheckDateLoadForRDD( department, onlyOneDoc, valueDate );

  if ( stat == 0 )
    SetParm( 0, valueDate );
/*
  elif ( stat > 0 )
    saveDialogFlag = SetDialogFlag( 0 );

    cmd = RsdCommand( "select t_contents errText from dsbbank_msg where t_number = :errCode" );

    cmd.addParam( "errCode", RSDBP_IN, stat );

    cmd.execute;

    rs = RsdRecordSet( cmd );

    if ( rs.moveNext )
      errText = rs.value( "errText" );

      if ( errText == StrFor( 1 ) )
        errText = "";
      end;
    end;

    if ( errText == "" )
      errText = String( stat );
    end;

    MemoryError( null, errText );

    SetDialogFlag( saveDialogFlag );                                                    
*/
  end;

  return stat;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro DefAddForMemorialOrder ( isCorrectionOrder, obSymbol, documentType )

  var cmd, rs;

  isCorrectionOrder = false;
  obSymbol = "";
  documentType = "";
  
  cmd = RsdCommand( "select rtmemorialorder.*, rtdocument.t_obSymbol " +
                    "from drtdocument_dbt rtdocument, drtmemorialorder_dbt rtmemorialorder " +
                    "where rtdocument.t_DocumentId = rtmemorialorder.t_DocumentId " +
                     "and rtdocument.t_DocumentId = :docId" );

  cmd.addParam( "docId", RSDBP_IN, rtdocument.rec.DocumentID );

  cmd.execute( );

  rs = RsdRecordset( cmd );
  rs.NullConversion = true;

  if ( rs.moveNext( ) )
    if ( ValType( rs.value( "t_isCorrectionOrder" ) ) != V_UNDEF )
      if ( rs.value( "t_isCorrectionOrder" ) != "" )
        isCorrectionOrder = true;
      end;
    end;

    if ( ValType( rs.value( "t_obSymbol" ) ) != V_UNDEF )
      obSymbol = rs.value( "t_obSymbol" );
      if ( obSymbol == StrFor( 1 ) )
        obSymbol = "";
      end;
    end;

    if ( ValType( rs.value( "t_documentType" ) ) != V_UNDEF )
      documentType = rs.value( "t_documentType" );
      if ( documentType == StrFor( 1 ) )
        documentType = "";
      end;
    end;
  end;

  SetParm( 0, isCorrectionOrder );
  SetParm( 1, obSymbol );
  SetParm( 2, documentType );
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro PmAddForFoldSide( aPmAddPI )

  var cmd;
  var rs;
  var pmaddpi;
  
  if ( rtdocument.rec.FoldSide == FOLDSIDE_NONE )
    return;
  end;

  cmd = RsdCommand( "select rtdocaccount.* from drtdocaccount_dbt rtdocaccount where rtdocaccount.t_DocumentID = :docId order by rtdocaccount.t_DocumentID, rtdocaccount.t_LineNumber" );

  cmd.addParam( "docId", RSDBP_IN, rtdocument.rec.DocumentID );

  rs = RsdRecordset( cmd );

  cmd.execute( );

  while ( rs.moveNext( ) )

    if ( ( ValType( rs.value( "t_Amount" ) ) != V_UNDEF ) and 
         ( rs.value( "t_Amount" ) > 0 ) and 
         ( ValType( rs.value( "t_CorrespondingAmount" ) ) != V_UNDEF ) and
         ( rs.value( "t_CorrespondingAmount" ) > 0 ) )

      pmaddpi = TRecHandler("pmaddpi.dbt", "bank.def" );

      pmaddpi.Clear( );

      if ( rtdocument.rec.FoldSide == FOLDSIDE_CREDIT )
        pmaddpi.rec.DebetCredit = 0; // BANK_DEBET
        pmaddpi.rec.PmFIID = DefCodeCurr( rtdocument.rec.CreditCurrCode );
      else
        pmaddpi.rec.DebetCredit = 1; // BANK_CREDIT;
        pmaddpi.rec.PmFIID = DefCodeCurr( rtdocument.rec.DebitCurrCode );
      end;

      if ( ValType( rs.value( "t_CorrespondingAmount" ) ) != V_UNDEF )
        pmaddpi.rec.PmAmount = rs.value( "t_CorrespondingAmount" );
      end;

      if ( DefRDDBaseDocType( rtdocument.rec.DocTypeID ) != RDD_CASH_IN )
        pmaddpi.rec.FIID = DefCodeCurr( rs.value( "t_CurrCode" ) );
      else
        if ( ValType( rs.value( "t_CurrCode" ) ) != V_UNDEF )
          pmaddpi.rec.FIID = DefCodeCurr( rs.value( "t_CurrCode" ) );
        else
          pmaddpi.rec.FIID = rtdocument.rec.CreditCurrCode;
        end;
      end;

      pmaddpi.rec.Chapter = rtdocument.rec.Chapter;
      if ( ValType( rs.value( "t_Account" ) ) != V_UNDEF )
        pmaddpi.rec.Account = rs.value( "t_Account" );
      end;
      pmaddpi.rec.Amount = rs.value( "t_Amount" );
      pmaddpi.rec.CashSymbol = rs.value( "t_CashSymbol" );
      pmaddpi.rec.Oper = rtdocument.rec.Oper;
      pmaddpi.rec.Department = rtdocument.rec.Department;

      if ( StrLen( pmaddpi.rec.CashSymbol ) == 2 )
        pmaddpi.rec.CashSymbol = " " + pmaddpi.rec.CashSymbol;
      end;

      aPmAddPI( aPmAddPI.Size( ) ) = pmaddpi;     
    end;
  end;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro SymbcashForFoldSide( aSymbcash )

  var cmd;
  var rs;
  var symbcash ;
  
  if ( rtdocument.rec.FoldSide == FOLDSIDE_NONE )
    return;
  end;

  cmd = RsdCommand( "select rtdocaccount.* from drtdocaccount_dbt rtdocaccount where rtdocaccount.t_DocumentID = :docId order by rtdocaccount.t_DocumentID, rtdocaccount.t_LineNumber" );

  cmd.addParam( "docId", RSDBP_IN, rtdocument.rec.DocumentID );

  rs = RsdRecordset( cmd );

  cmd.execute( );

  while ( rs.moveNext( ) )

    if ( ( ValType( rs.value( "t_CorrespondingAmount" ) ) != V_UNDEF ) and ( rs.value( "t_CorrespondingAmount" ) > 0 ) )

      symbcash = TRecHandler("symbcash.dbt", "bank.def" );

      symbcash.Clear( );
     
      // ‡ ¯®«­¨¬ SymbCash
      if ( rs.value( "t_CashSymbol" ) != StrFor( 1 ) )
        if ( rtdocument.rec.FoldSide == FOLDSIDE_CREDIT )
          Symbcash.rec.Kind = TS_KREDIT; // BANK_DEBET
        else
          Symbcash.rec.Kind = TS_DEBET; // BANK_CREDIT 
        end;

        symbcash.rec.Symbol = rs.value( "t_CashSymbol" ); 
        symbcash.rec.Sum = rs.value( "t_CorrespondingAmount" ); 

        if ( StrLen( symbcash.rec.Symbol ) == 2 )
          symbcash.rec.Symbol = " " + symbcash.rec.Symbol;
        end;

        aSymbcash( aSymbcash.Size( ) ) = symbcash;
      end;
    end;
  end;

end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro InitCashOrderToBB( postActionType )

  var aPmAddPI = TArray;
  var foldSide = rtdocument.rec.FoldSide;
  var symbcash;
  var aSymbcash = TArray;
  var valueDate;
  var stat;

  stat = DefValueDate( valueDate );
  if ( stat > 0 )
    return stat;
  end;

  if ( foldSide != FOLDSIDE_NONE )
    if ( ( DefRDDBaseDocType( rtdocument.rec.DocTypeID ) == RDD_CASH_IN )  AND  ( StrLen( rtdocument.rec.CreditAccount ) < 2 ) )
      PmAddForFoldSide( aPmAddPI );    //  §­®áª  ¯® áç¥â ¬.
    end;
    SymbcashForFoldSide( aSymbcash );  //  §­®áª  ¯® á¨¬¢®« ¬.

    if ( ( aPmAddPI.Size( ) == 0 )  AND  ( aSymbcash.Size( ) == 0 ) )
      foldSide = FOLDSIDE_NONE;
    end;
  end;

  CashOrder.BOCode = BO_RS_RETAIL;
  CashOrder.BOAction = true;
  // CashOrder.BOStartDate =

  if ( isOneCurrRtDoc( foldSide ) )
    if ( ( foldSide == FOLDSIDE_NONE ) or ( foldSide == FOLDSIDE_CREDIT ) )
      CashOrder.BaseFIID = DefCodeCurr( rtdocument.rec.CreditCurrCode );
      CashOrder.BaseAmount = rtdocument.rec.CreditAmount;
      CashOrder.PayerFIID = DefCodeCurr( rtdocument.rec.DebitCurrCode );
      CashOrder.PayerAmount = rtdocument.rec.DebitAmount;
    else
      CashOrder.BaseFIID = DefCodeCurr( rtdocument.rec.DebitCurrCode );
      CashOrder.BaseAmount = rtdocument.rec.DebitAmount;
      if ( StrLen( rtdocument.rec.CreditAccount ) > 1 )
        CashOrder.ReceiverFIID = DefCodeCurr( rtdocument.rec.CreditCurrCode );
        CashOrder.ReceiverAmount = rtdocument.rec.CreditAmount;
      end;
    end;
  else
    CashOrder.PayerFIID = DefCodeCurr( rtdocument.rec.DebitCurrCode );
    CashOrder.PayerAmount = rtdocument.rec.DebitAmount;
    CashOrder.ReceiverFIID = DefCodeCurr( rtdocument.rec.CreditCurrCode );
    CashOrder.ReceiverAmount = rtdocument.rec.CreditAmount;
  end;

  // CashOrder.FIID_FuturePayAcc =
  // CashOrder.FIID_FutureRecAcc =
  // CashOrder.RateType =
  // CashOrder.RateScale =
  // CashOrder.RatePoint =
  // CashOrder.RateValue =
  // CashOrder.RateIsInverse =
  CashOrder.Date = rtdocument.rec.Date;
  CashOrder.ValueDate = valueDate;

  if ( DefRDDBaseDocType( rtdocument.rec.DocTypeID ) == RDD_CASH_OUT )
    CashOrder.DocKind = 440; // CASH_BOF_OUTORDER
  else
    CashOrder.DocKind = 430; // CASH_BOF_INCORDER
  end;

  if ( rtdocument.rec.PayerBankPartyID > 0 )
    CashOrder.PayerBankID = rtdocument.rec.PayerBankPartyID;
  end;

  if ( rtdocument.rec.PayerBankTempPartyID > 0 )
    FillFromTemporaryParty( rtdocument.rec.PayerBankTempPartyID, NULL, CashOrder.PayerBankCodeKind, CashOrder.PayerBankCode, CashOrder.PayerBankName );
  end;

  if ( ( rtdocument.rec.PayerBankPartyID <= 0 ) and ( rtdocument.rec.PayerBankTempPartyID <= 0 ) )
    CashOrder.PayerBankID = DefBankId( );
  end;

  if ( rtdocument.rec.PayerAccount != "" )
    CashOrder.PayerAccount = rtdocument.rec.PayerAccount;
  else
    CashOrder.PayerAccount = rtdocument.rec.DebitAccount;
  end;
  CashOrder.FuturePayerAccount = rtdocument.rec.DebitAccount;

  // CashOrder.PayerCorrAccNostro =

  if ( rtdocument.rec.PayerPartyID > 0 )
    CashOrder.Payer = rtdocument.rec.PayerPartyID;
  end;

  if ( rtdocument.rec.PayerTempPartyID > 0 )
    CashOrder.PayerName = rtdocument.rec.PayerName;

    FillFromTemporaryParty( rtdocument.rec.PayerTempPartyID, CashOrder.PayerINN );
  end;

  if ( rtdocument.rec.ReceiverBankPartyID > 0 )
    CashOrder.ReceiverBankID = rtdocument.rec.ReceiverBankPartyID;
  end;

  if ( rtdocument.rec.ReceiverBankTempPartyID > 0 )
    FillFromTemporaryParty( rtdocument.rec.ReceiverBankTempPartyID, NULL, CashOrder.ReceiverBankCodeKind, CashOrder.ReceiverBankCode, CashOrder.ReceiverBankName );
  end;

  if ( ( rtdocument.rec.ReceiverBankPartyID <= 0 ) and ( rtdocument.rec.ReceiverBankTempPartyID <= 0 ) )
    CashOrder.ReceiverBankID = DefBankId( );
  end;
  
  if ( ( foldSide != FOLDSIDE_DEBIT )  OR  ( StrLen( rtdocument.rec.CreditAccount ) > 1 ) )
    if ( rtdocument.rec.ReceiverAccount != "" )
      CashOrder.ReceiverAccount = rtdocument.rec.ReceiverAccount;
    else
      CashOrder.ReceiverAccount = rtdocument.rec.CreditAccount;
    end;
    CashOrder.FutureReceiverAccount = rtdocument.rec.CreditAccount;
  end;
  
  // CashOrder.ReceiverCorrAccNostro =

  if ( rtdocument.rec.ReceiverPartyID > 0 )
    CashOrder.Receiver = rtdocument.rec.ReceiverPartyID;
  end;

  if ( rtdocument.rec.ReceiverTempPartyID > 0 )
    CashOrder.ReceiverName = rtdocument.rec.ReceiverName;

    FillFromTemporaryParty( rtdocument.rec.ReceiverTempPartyID, CashOrder.ReceiverINN );
  end;

  CashOrder.NotForBackOffice = "X";
  CashOrder.Number = rtdocument.rec.documentNumber;
  CashOrder.Ground = rtdocument.rec.Ground;
  CashOrder.NumberPack = rtdocument.rec.PackNumber;
  if ( StrLen( Trim( rtdocument.rec.OperationCipher ) ) > 0 )
    CashOrder.ShifrOper = rtdocument.rec.OperationCipher;
  end;
  CashOrder.Origin = CASH_FDOC_RETAIL;
  // CashOrder.Kind_Operation =
  CashOrder.Oper = {oper};
  CashOrder.OperNode = rtdocument.rec.Branch;

  if ( CashOrder.DocKind == 440 )
    CashOrder.FIOClient = rtdocument.rec.SignerName;
    // CashOrder.PaperKind =
    // CashOrder.PaperSeries =
    // CashOrder.PaperNumber =
    // CashOrder.PaperIssuedDate =
    // CashOrder.PaperIssuer =
  end;

  // CashOrder.IsVO =
  // CashOrder.VO_Accept =
  // CashOrder.VO_Oper =
  // CashOrder.VO_FIID =
  // CashOrder.VO_Direct =
  // CashOrder.VO_PayerBankID =
  // CashOrder.VO_PayerBankCodeKind =
  // CashOrder.VO_PayerBankCode =
  // CashOrder.VO_PayerBankCountry =
  // CashOrder.VO_ReceiverBankID =
  // CashOrder.VO_ReceiverBankCodeKind =
  // CashOrder.VO_ReceiverBankCode =
  // CashOrder.VO_ReceiverBankCountry =
  CashOrder.CheckTerror = DefCheckTerror( );

  if ( ( rtdocument.rec.CreditCashSymbol != "" ) and ( rtdocument.rec.CreditAmount > 0 ) )
    symbcash = TRecHandler( "symbcash.dbt", "bank.def" );

    symbcash.Clear( );
    symbcash.rec.Kind = TS_KREDIT;
    symbcash.rec.Symbol = rtdocument.rec.CreditCashSymbol;
    symbcash.rec.Sum = rtdocument.rec.CreditAmount;

    if ( StrLen( symbcash.rec.Symbol ) == 2 )
      symbcash.rec.Symbol = " " + symbcash.rec.Symbol;
    end;

    aSymbcash( aSymbcash.Size( ) ) = symbcash;
  end;

  if ( ( rtdocument.rec.DebitCashSymbol != "" ) and ( rtdocument.rec.DebitAmount > 0 ) )
    symbcash = TRecHandler( "symbcash.dbt", "bank.def" );

    symbcash.Clear( );
    symbcash.rec.Kind = TS_DEBET;
    symbcash.rec.Symbol = rtdocument.rec.DebitCashSymbol;
    symbcash.rec.Sum = rtdocument.rec.DebitAmount;

    if ( StrLen( symbcash.rec.Symbol ) == 2 )
      symbcash.rec.Symbol = " " + symbcash.rec.Symbol;
    end;

    aSymbcash( aSymbcash.Size( ) ) = symbcash;
  end;

  if ( rtdocument.rec.obSymbol != "" ) 
    symbcash = TRecHandler( "symbcash.dbt", "bank.def" );

    symbcash.Clear( );
    symbcash.rec.Kind = TS_NOTB;
    symbcash.rec.Symbol = rtdocument.rec.obSymbol;
    if ( rtdocument.rec.DebitAmount > 0)
      symbcash.rec.Sum = rtdocument.rec.DebitAmount;
    else
      symbcash.rec.Sum = rtdocument.rec.CreditAmount;
    end;

    if ( StrLen( symbcash.rec.Symbol ) == 2 )
      symbcash.rec.Symbol = " " + symbcash.rec.Symbol;
    end;

    aSymbcash( aSymbcash.Size( ) ) = symbcash;
  end;

  if ( aSymbcash.Size( ) > 0 )
    CashOrder.SetCashSymbols( aSymbcash );
  end;

  // CashOrder.SetNotes
  // CashOrder.SetPaymNotes  
  // CashOrder.SetCategories
  // CashOrder.SetPaymCategories    
  // CashOrder.SetCOProperties

  if ( aPmAddPI.Size( ) > 0 )
    CashOrder.SetPmAddPI( aPmAddPI );
  end;

  // CashOrder.SetParties

  return OK_RES;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro InitMemorialOrderToBB( postActionType )

  var aPmAddPI = TArray;
  var foldSide = rtdocument.rec.FoldSide;
  var valueDate;
  var isCorrectionOrder = false;
  var obSymbol = "";
  var documentType = "";
  var stat;

  stat = DefValueDate( valueDate );
  if ( stat > 0 )
    return stat;
  end;
             
  if ( foldSide != FOLDSIDE_NONE )
    PmAddForFoldSide( aPmAddPI );

    if ( aPmAddPI.Size( ) == 0 )
      foldSide = FOLDSIDE_NONE;
    end;
  end;

  DefAddForMemorialOrder( isCorrectionOrder, obSymbol, documentType );

  MemorialOrder.BOCode = BO_RS_RETAIL;
  MemorialOrder.BOAction = true;
  // MemorialOrder.BOStartDate =

  if ( ( foldSide == FOLDSIDE_NONE ) or ( foldSide == FOLDSIDE_CREDIT ) )
   MemorialOrder.BaseFIID = DefCodeCurr( rtdocument.rec.CreditCurrCode );
   MemorialOrder.BaseAmount = rtdocument.rec.CreditAmount;
  else
   MemorialOrder.BaseFIID = DefCodeCurr( rtdocument.rec.DebitCurrCode );
   MemorialOrder.BaseAmount = rtdocument.rec.DebitAmount;
  end;

  MemorialOrder.Date = rtdocument.rec.Date;
  MemorialOrder.ValueDate = valueDate;

  if ( rtdocument.rec.PayerBankPartyID > 0 )
    MemorialOrder.PayerBankID = rtdocument.rec.PayerBankPartyID;
  else
    MemorialOrder.PayerBankID = DefBankId( );
  end;

  // MemorialOrder.PayerBankCodeKind =
  // MemorialOrder.PayerBankCode =
  // MemorialOrder.PayerBankName =

  if ( rtdocument.rec.PayerAccount != "" )
    MemorialOrder.PayerAccount = rtdocument.rec.PayerAccount;
  else
    MemorialOrder.PayerAccount = rtdocument.rec.DebitAccount;
  end;
  MemorialOrder.FuturePayerAccount = rtdocument.rec.DebitAccount;

  // MemorialOrder.PayerCorrAccNostro =
  // MemorialOrder.Payer =
  // MemorialOrder.PayerName =
  // MemorialOrder.PayerINN =

  if ( rtdocument.rec.ReceiverBankPartyID > 0 )
    MemorialOrder.ReceiverBankID = rtdocument.rec.ReceiverBankPartyID;
  else
    MemorialOrder.ReceiverBankID = DefBankId( );
  end;


  // MemorialOrder.ReceiverBankCodeKind =
  // MemorialOrder.ReceiverBankCode =
  // MemorialOrder.ReceiverBankName =

  if ( rtdocument.rec.ReceiverAccount != "" )
    MemorialOrder.ReceiverAccount = rtdocument.rec.ReceiverAccount;
  else
    MemorialOrder.ReceiverAccount = rtdocument.rec.CreditAccount;
  end;
  MemorialOrder.FutureReceiverAccount = rtdocument.rec.CreditAccount;

  // MemorialOrder.ReceiverCorrAccNostro =
  // MemorialOrder.Receiver =
  // MemorialOrder.ReceiverName =
  // MemorialOrder.ReceiverINN =
  MemorialOrder.NotForBackOffice = "X";
  MemorialOrder.Number = rtdocument.rec.documentNumber;
  MemorialOrder.Ground = rtdocument.rec.Ground;
  MemorialOrder.NumberPack = rtdocument.rec.PackNumber;
  if ( StrLen( Trim( rtdocument.rec.OperationCipher ) ) > 0 )
    MemorialOrder.ShifrOper = rtdocument.rec.OperationCipher;
  end;

  MemorialOrder.CashSymbolDebet = rtdocument.rec.DebitCashSymbol;
  if ( StrLen( MemorialOrder.CashSymbolDebet ) == 2 )
    MemorialOrder.CashSymbolDebet = " " + MemorialOrder.CashSymbolDebet;
  end;

  MemorialOrder.CashSymbolCredit = rtdocument.rec.CreditCashSymbol;
  if ( StrLen( MemorialOrder.CashSymbolCredit ) == 2 )
    MemorialOrder.CashSymbolCredit = " " + MemorialOrder.CashSymbolCredit;
  end;

  if ( obSymbol != "" )
    MemorialOrder.SymbNotBalDebet = obSymbol;
    if ( StrLen( MemorialOrder.SymbNotBalDebet ) == 2 )
      MemorialOrder.SymbNotBalDebet = " " + MemorialOrder.SymbNotBalDebet;
    end;
  end;

  // MemorialOrder.SymbNotBalCredit =
  MemorialOrder.Origin = CB_DOC_ORIGIN_RETAIL;
  MemorialOrder.Chapter = rtdocument.rec.Chapter;
  // MemorialOrder.Kind_Operation =
  MemorialOrder.Oper = {oper};
  MemorialOrder.OperNode = rtdocument.rec.Branch;

  MemorialOrder.TypeDocument = documentType;
  if ( isCorrectionOrder )
    if ( Index( MemorialOrder.TypeDocument, "N" ) == 0 )
      MemorialOrder.TypeDocument = MemorialOrder.TypeDocument + "N"; // ®¢ë© ª®àà¥ªâ¨à®¢®ç­ë©
    end;
  end;

  // MemorialOrder.UserTypeDocument =
  // MemorialOrder.Result_Carry =
  // MemorialOrder.DbCurEqID =
  // MemorialOrder.DbSumEq =
  // MemorialOrder.DbRecalcMethod =
  // MemorialOrder.CrCurEqID =
  // MemorialOrder.CrSumEq =
  // MemorialOrder.CrRecalcMethod =
  // MemorialOrder.Kind_Oper =
  // MemorialOrder.UserField1 =
  // MemorialOrder.UserField2 =
  // MemorialOrder.UserField3 =
  // MemorialOrder.UserField4 =
  // MemorialOrder.IsVO =
  // MemorialOrder.VO_Accept =
  // MemorialOrder.VO_Oper =
  // MemorialOrder.VO_FIID =
  // MemorialOrder.VO_Direct =
  // MemorialOrder.VO_PayerBankID =
  // MemorialOrder.VO_PayerBankCodeKind =
  // MemorialOrder.VO_PayerBankCode =
  // MemorialOrder.VO_PayerBankCountry =
  // MemorialOrder.VO_ReceiverBankID =
  // MemorialOrder.VO_ReceiverBankCodeKind =
  // MemorialOrder.VO_ReceiverBankCode =
  // MemorialOrder.VO_ReceiverBankCountry =
  MemorialOrder.CheckTerror = 2; // à®¢¥àª  ­¥ âà¥¡ã¥âáï

  // MemorialOrder.SetNotes
  // MemorialOrder.SetPaymNotes
  // MemorialOrder.SetCategories
  // MemorialOrder.SetPaymCategories
  // MemorialOrder.SetCOProperties

  if ( aPmAddPI.Size( ) > 0 )
    MemorialOrder.SetPmAddPI( aPmAddPI );
  end;

  return OK_RES;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro InitMultiCurMemOrderToBB( postActionType )

  var aPmAddPI = TArray;
  var foldSide = rtdocument.rec.FoldSide;
  var valueDate;
  var isCorrectionOrder = false;
  var obSymbol = "";
  var documentType = "";
  var stat;

  stat = DefValueDate( valueDate );
  if ( stat > 0 )
    return stat;
  end;

  if ( foldSide != FOLDSIDE_NONE )
    PmAddForFoldSide( aPmAddPI );

    if ( aPmAddPI.Size( ) == 0 )
      foldSide = FOLDSIDE_NONE;
    end;
  end;

  DefAddForMemorialOrder( isCorrectionOrder, obSymbol, documentType );

  MultyDoc.BOCode = BO_RS_RETAIL;
  MultyDoc.BOAction = true;
  // MultyDoc.BOStartDate =

  if ( foldSide != FOLDSIDE_CREDIT )
    MultyDoc.PayerFIID = DefCodeCurr( rtdocument.rec.DebitCurrCode );
    MultyDoc.PayerAmount = rtdocument.rec.DebitAmount;
    MultyDoc.FIID_FuturePayAcc = MultyDoc.PayerFIID;
  end;

  if ( foldSide != FOLDSIDE_DEBIT )
    MultyDoc.ReceiverFIID = DefCodeCurr( rtdocument.rec.CreditCurrCode );
    MultyDoc.ReceiverAmount = rtdocument.rec.CreditAmount;
    MultyDoc.FIID_FutureRecAcc = MultyDoc.ReceiverFIID;
  end;

  // MultyDoc.RateType =
  // MultyDoc.RateScale =
  // MultyDoc.RatePoint =
  // MultyDoc.RateValue =
  // MultyDoc.RateIsInverse =
  MultyDoc.Date = rtdocument.rec.Date;
  MultyDoc.ValueDate = valueDate;
  // MultyDoc.BankDate =
  // MultyDoc.PayDate = 

  if ( rtdocument.rec.PayerBankPartyID > 0 )
    MultyDoc.PayerBankID = rtdocument.rec.PayerBankPartyID;
  else
    MultyDoc.PayerBankID = DefBankId( );
  end;

  // MultyDoc.PayerBankCodeKind =
  // MultyDoc.PayerBankCode =
  // MultyDoc.PayerBankName =

  if ( foldSide != FOLDSIDE_CREDIT )
    if ( rtdocument.rec.PayerAccount != "" )
      MultyDoc.PayerAccount = rtdocument.rec.PayerAccount;
    else
      MultyDoc.PayerAccount = rtdocument.rec.DebitAccount;
    end;
    MultyDoc.FuturePayerAccount = rtdocument.rec.DebitAccount;
  end;

  // MultyDoc.PayerCorrAccNostro =
  // MultyDoc.Payer =
  // MultyDoc.PayerName =
  // MultyDoc.PayerINN =

  if ( rtdocument.rec.ReceiverBankPartyID > 0 )
    MultyDoc.ReceiverBankID = rtdocument.rec.ReceiverBankPartyID;
  else
    MultyDoc.ReceiverBankID = DefBankId( );
  end;

  // MultyDoc.ReceiverBankCodeKind =
  // MultyDoc.ReceiverBankCode =
  // MultyDoc.ReceiverBankName =

  if ( foldSide != FOLDSIDE_DEBIT )
    if ( rtdocument.rec.ReceiverAccount != "" )
      MultyDoc.ReceiverAccount = rtdocument.rec.ReceiverAccount;
    else
      MultyDoc.ReceiverAccount = rtdocument.rec.CreditAccount;
    end;
    MultyDoc.FutureReceiverAccount = rtdocument.rec.CreditAccount;
  end;

  // MultyDoc.ReceiverCorrAccNostro =
  // MultyDoc.Receiver =
  // MultyDoc.ReceiverName =
  // MultyDoc.ReceiverINN =
  MultyDoc.NotForBackOffice = "X";
  MultyDoc.Ground = rtdocument.rec.Ground;
  MultyDoc.NumberPack = rtdocument.rec.PackNumber;
  MultyDoc.Number = rtdocument.rec.documentNumber;
  if ( StrLen( Trim( rtdocument.rec.OperationCipher ) ) > 0 )
    MultyDoc.ShifrOper = rtdocument.rec.OperationCipher;
  end;

  MultyDoc.CashSymbolDebet = rtdocument.rec.DebitCashSymbol;
  if ( StrLen( MultyDoc.CashSymbolDebet ) == 2 )
    MultyDoc.CashSymbolDebet = " " + MultyDoc.CashSymbolDebet;
  end;

  MultyDoc.CashSymbolCredit = rtdocument.rec.CreditCashSymbol;
  if ( StrLen( MultyDoc.CashSymbolCredit ) == 2 )
    MultyDoc.CashSymbolCredit = " " + MultyDoc.CashSymbolCredit;
  end;

  // MultyDoc.SymbNotBalDebet =
  // MultyDoc.SymbNotBalCredit =
  MultyDoc.Origin = MULTYDOC_ORIGIN_RETAIL;
  MultyDoc.Chapter = rtdocument.rec.Chapter;
  // MultyDoc.Kind_Operation =
  MultyDoc.Oper = {oper};
  MultyDoc.OperNode = rtdocument.rec.Branch;
  // MultyDoc.DbCurEqID =
  // MultyDoc.DbSumEq =
  // MultyDoc.DbRecalcMethod =
  // MultyDoc.CrCurEqID =
  // MultyDoc.CrSumEq =
  // MultyDoc.CrRecalcMethod =
  // MultyDoc.UserField1 =
  // MultyDoc.UserField2 =
  // MultyDoc.UserField3 =
  // MultyDoc.UserField4 =

  MultyDoc.TypeDocument = documentType;
  if ( isCorrectionOrder )
    if ( Index( MultyDoc.TypeDocument, "N" ) == 0 )
      MultyDoc.TypeDocument = MultyDoc.TypeDocument + "N"; // ®¢ë© ª®àà¥ªâ¨à®¢®ç­ë©
    end;
  end;

  // MultyDoc.IsVO =
  // MultyDoc.VO_Accept =
  // MultyDoc.VO_Oper =
  // MultyDoc.VO_FIID =
  // MultyDoc.VO_Direct =
  // MultyDoc.VO_PayerBankID =
  // MultyDoc.VO_PayerBankCodeKind =
  // MultyDoc.VO_PayerBankCode =
  // MultyDoc.VO_PayerBankCountry =
  // MultyDoc.VO_ReceiverBankID =
  // MultyDoc.VO_ReceiverBankCodeKind =
  // MultyDoc.VO_ReceiverBankCode =
  // MultyDoc.VO_ReceiverBankCountry =
  MultyDoc.CheckTerror = 2; // à®¢¥àª  ­¥ âà¥¡ã¥âáï

  if ( rtdocument.rec.MultiCurrencyMethod > 0 )
    MultyDoc.MCMethodID = rtdocument.rec.MultiCurrencyMethod;
  end;

  // MultyDoc.MinimizationTurn =

  if ( foldSide == FOLDSIDE_DEBIT )
    MultyDoc.IsFixAmount = "X";
  end;

  // MultyDoc.SetNotes
  // MultyDoc.SetPaymNotes
  // MultyDoc.SetCategories
  // MultyDoc.SetPaymCategories
  // MultyDoc.SetCOProperties

  if ( aPmAddPI.Size( ) > 0 )
    MultyDoc.SetPmAddPI( aPmAddPI );
  end;

  return OK_RES;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro InitBankOrderToBB( postActionType )

  var aPmAddPI = TArray;
  var foldSide = rtdocument.rec.FoldSide;
  var valueDate;
  var stat;

  stat = DefValueDate( valueDate );
  if ( stat > 0 )
    return stat;
  end;

  if ( foldSide != FOLDSIDE_NONE )
    PmAddForFoldSide( aPmAddPI );

    if ( aPmAddPI.Size( ) == 0 )
      foldSide = FOLDSIDE_NONE;
    end;
  end;

  BankOrder.BOCode = BO_RS_RETAIL;
  BankOrder.BOAction = true;

  if ( ( foldSide == FOLDSIDE_NONE ) and ( rtdocument.rec.DebitCurrCode == rtdocument.rec.CreditCurrCode ) )
    BankOrder.BaseFIID = DefCodeCurr( rtdocument.rec.DebitCurrCode );
    BankOrder.BaseAmount = rtdocument.rec.DebitAmount;
    BankOrder.PayerFIID = BankOrder.BaseFIID;
    BankOrder.FIID_FuturePayAcc = BankOrder.BaseFIID;
    BankOrder.ReceiverFIID = BankOrder.BaseFIID;
    BankOrder.FIID_FutureRecAcc = BankOrder.BaseFIID;
  elif ( ( foldSide == FOLDSIDE_NONE ) and ( rtdocument.rec.DebitCurrCode != rtdocument.rec.CreditCurrCode ) )
    BankOrder.IsFixAmount = "X";
    BankOrder.PayerFIID = DefCodeCurr( rtdocument.rec.DebitCurrCode );
    BankOrder.PayerAmount = rtdocument.rec.DebitAmount;
    BankOrder.FIID_FuturePayAcc = BankOrder.PayerFIID;
    BankOrder.ReceiverFIID = DefCodeCurr( rtdocument.rec.CreditCurrCode );
    BankOrder.ReceiverAmount = rtdocument.rec.CreditAmount;
    BankOrder.FIID_FutureRecAcc = BankOrder.ReceiverFIID;
    BankOrder.BaseFIID = BankOrder.PayerFIID;
    BankOrder.BaseAmount = BankOrder.PayerAmount;
  elif ( foldSide == FOLDSIDE_CREDIT )
    BankOrder.ReceiverFIID = DefCodeCurr( rtdocument.rec.CreditCurrCode );
    BankOrder.ReceiverAmount = rtdocument.rec.CreditAmount;
    BankOrder.FIID_FutureRecAcc = BankOrder.ReceiverFIID;
    BankOrder.BaseFIID = BankOrder.ReceiverFIID;
    BankOrder.BaseAmount = BankOrder.ReceiverAmount;
  elif ( foldSide == FOLDSIDE_DEBIT )
    BankOrder.IsFixAmount = "X";
    BankOrder.PayerFIID = DefCodeCurr( rtdocument.rec.DebitCurrCode );
    BankOrder.PayerAmount = rtdocument.rec.DebitAmount;
    BankOrder.FIID_FuturePayAcc = BankOrder.PayerFIID;
    BankOrder.BaseFIID = BankOrder.PayerFIID;
    BankOrder.BaseAmount = BankOrder.PayerAmount;
  else
    return ERR_RES;
  end;

  BankOrder.Date = rtdocument.rec.Date;
  BankOrder.ValueDate = valueDate;

  if ( rtdocument.rec.PayerBankPartyID > 0 )
    BankOrder.PayerBankID = rtdocument.rec.PayerBankPartyID;
  else
    BankOrder.PayerBankID = DefBankId( );
  end;

  // BankOrder.PayerBankCodeKind
  // BankOrder.PayerBankCode
  // BankOrder.PayerBankName

  if ( foldSide != FOLDSIDE_CREDIT )
    if ( rtdocument.rec.PayerAccount != "" )
      BankOrder.PayerAccount = rtdocument.rec.PayerAccount;
    else
      BankOrder.PayerAccount = rtdocument.rec.DebitAccount;
    end;
    BankOrder.FuturePayerAccount = rtdocument.rec.DebitAccount;
  end;

  // BankOrder.PayerCorrAccNostro =

  if ( rtdocument.rec.PayerPartyID > 0 )
    BankOrder.Payer = rtdocument.rec.PayerPartyID;
  end;

  BankOrder.PayerName = rtdocument.rec.PayerName;
  // BankOrder.PayerINN =

  if ( rtdocument.rec.ReceiverBankPartyID > 0 )
    BankOrder.ReceiverBankID = rtdocument.rec.ReceiverBankPartyID;
  else
    BankOrder.ReceiverBankID = DefBankId( );
  end;

  // BankOrder.ReceiverBankCodeKind =
  // BankOrder.ReceiverBankCode =
  // BankOrder.ReceiverBankName =

  if ( foldSide != FOLDSIDE_DEBIT )
    if ( rtdocument.rec.ReceiverAccount != "" )
      BankOrder.ReceiverAccount = rtdocument.rec.ReceiverAccount;
    else
      BankOrder.ReceiverAccount = rtdocument.rec.CreditAccount;
    end;
    BankOrder.FutureReceiverAccount = rtdocument.rec.CreditAccount;
  end;

  // BankOrder.ReceiverCorrAccNostro =

  if ( rtdocument.rec.ReceiverPartyID > 0 )
    BankOrder.Receiver = rtdocument.rec.ReceiverPartyID;
  end;

  BankOrder.ReceiverName = rtdocument.rec.ReceiverName;
  // BankOrder.ReceiverINN =
  BankOrder.NotForBackOffice = "X";
  BankOrder.Number = rtdocument.rec.documentNumber;
  BankOrder.Ground = rtdocument.rec.Ground;
  BankOrder.NumberPack = rtdocument.rec.PackNumber;

  if ( StrLen( Trim( rtdocument.rec.OperationCipher ) ) > 0 )
    BankOrder.ShifrOper = rtdocument.rec.OperationCipher;
  end;

  if ( rtdocument.rec.Priority > 0 )
    BankOrder.PaymentPriority = rtdocument.rec.Priority;
  end;

  BankOrder.Origin = PD_OR_RETAIL;

  if ( rtdocument.rec.Chapter > 0 )
    BankOrder.Chapter = rtdocument.rec.Chapter;
  else
    BankOrder.Chapter = 1; // ƒ« ¢  €
  end;

  // BankOrder.Kind_Operation =
  BankOrder.Oper = {oper};
  // BankOrder.Oper =
  // BankOrder.TypeDocument =
  // BankOrder.UserTypeDocument =
  // BankOrder.IsVO =
  // BankOrder.VO_Accept =
  // BankOrder.VO_Oper =
  // BankOrder.VO_FIID =
  // BankOrder.VO_Direct =
  // BankOrder.VO_PayerBankID =
  // BankOrder.VO_PayerBankCodeKind =
  // BankOrder.VO_PayerBankCode =
  // BankOrder.VO_PayerBankCountry =
  // BankOrder.VO_ReceiverBankID =
  // BankOrder.VO_ReceiverBankCodeKind =
  // BankOrder.VO_ReceiverBankCode =
  // BankOrder.VO_ReceiverBankCountry =
  // BankOrder.RateType =
  // BankOrder.RateScale =
  // BankOrder.RatePoint =
  // BankOrder.RateValue =
  // BankOrder.RateIsInverse =
  // BankOrder.RateDate =
  // BankOrder.BaseRateType =
  // BankOrder.BaseRateScale =
  // BankOrder.BaseRatePoint =
  // BankOrder.BaseRateValue =
  // BankOrder.BaseRateIsInverse =
  // BankOrder.BaseRateDate =
  // BankOrder.IsFixAmount =
  BankOrder.OperNode = rtdocument.rec.Branch;
  // BankOrder.PayerChargeOffDate =
  // BankOrder.I2PlaceDate =

  if ( rtdocument.rec.MultiCurrencyMethod > 0 )
    BankOrder.MCMethodID = rtdocument.rec.MultiCurrencyMethod;
  end;

  // BankOrder.MinimizationTurn =
  BankOrder.CheckTerror = DefCheckTerror( );

  // BankOrder.SetCashSymbols
  // BankOrder.SetNotes
  // BankOrder.SetPaymNotes
  // BankOrder.SetCategories
  // BankOrder.SetPaymCategories
  // BankOrder.SetCOProperties

  if ( aPmAddPI.Size( ) > 0 )
    BankOrder.SetPmAddPI( aPmAddPI );
  end;

  return OK_RES;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro InitPaymentOrderToBB( postActionType )

  var cmd;
  var rs;
  var aPmAddPI = TArray;
  var foldSide = rtdocument.rec.FoldSide;
  var valueDate;
  var paymentMode = 0;
  var symbcash;
  var aSymbcash = TArray;
  var stat;

  stat = DefValueDate( valueDate );
  if ( stat > 0 )
    return stat;
  end;

  if ( foldSide != FOLDSIDE_NONE )
    PmAddForFoldSide( aPmAddPI );

    if ( aPmAddPI.Size( ) == 0 )
      foldSide = FOLDSIDE_NONE;
    end;
  end;

  BankPayment.BOCode = BO_RS_RETAIL;
  BankPayment.BOAction = true;
  // BankPayment.BOStartDate =

  if ( ( foldSide == FOLDSIDE_NONE ) or ( foldSide == FOLDSIDE_CREDIT ) )
    BankPayment.BaseAmount = rtdocument.rec.CreditAmount;
  else
    BankPayment.BaseAmount = rtdocument.rec.DebitAmount;
  end;

  BankPayment.Date = rtdocument.rec.Date;
  BankPayment.ValueDate = valueDate;
  // BankPayment.BankDate =
  // BankPayment.PayDate =

  if ( rtdocument.rec.PayerBankPartyID > 0 )
    BankPayment.PayerBankID = rtdocument.rec.PayerBankPartyID;
    FillFromParty( rtdocument.rec.PayerBankPartyID, BankPayment.PayerBankName );
    BankPayment.PayerBankCodeKind = 3; // ˆŠ – ”
  end;

  if ( rtdocument.rec.PayerBankTempPartyID > 0 )
    FillFromTemporaryParty( rtdocument.rec.PayerBankTempPartyID, NULL, BankPayment.PayerBankCodeKind, BankPayment.PayerBankCode, BankPayment.PayerBankName, BankPayment.PayerCorrAccNostro );
  end;

  if ( foldSide != FOLDSIDE_CREDIT )
    if ( rtdocument.rec.PayerAccount != "" )
      BankPayment.PayerAccount = rtdocument.rec.PayerAccount;
    else
      BankPayment.PayerAccount = rtdocument.rec.DebitAccount;
    end;
    BankPayment.FuturePayerAccount = rtdocument.rec.DebitAccount;
  end;

  if ( rtdocument.rec.PayerPartyID > 0 )
    BankPayment.Payer = rtdocument.rec.PayerPartyID;
  end;

  BankPayment.PayerName = rtdocument.rec.PayerName;

  if ( rtdocument.rec.PayerTempPartyID > 0 )
    FillFromTemporaryParty( rtdocument.rec.PayerTempPartyID, BankPayment.PayerINN );
  end;

  if ( rtdocument.rec.ReceiverBankPartyID > 0 )
    BankPayment.ReceiverBankID = rtdocument.rec.ReceiverBankPartyID;
    FillFromParty( rtdocument.rec.ReceiverBankPartyID, BankPayment.ReceiverBankName );
    BankPayment.ReceiverBankCodeKind = 3; // ˆŠ – ”
  end;

  if ( rtdocument.rec.ReceiverBankTempPartyID > 0 )
    FillFromTemporaryParty( rtdocument.rec.ReceiverBankTempPartyID, NULL, BankPayment.ReceiverBankCodeKind, BankPayment.ReceiverBankCode, BankPayment.ReceiverBankName, BankPayment.ReceiverCorrAccNostro );
  end;

  if ( foldSide != FOLDSIDE_DEBIT )
    if ( rtdocument.rec.ReceiverAccount != "" )
      BankPayment.ReceiverAccount = rtdocument.rec.ReceiverAccount;
    else
      BankPayment.ReceiverAccount = rtdocument.rec.CreditAccount;
    end;
    BankPayment.FutureReceiverAccount = rtdocument.rec.CreditAccount;
  end;


  if ( rtdocument.rec.ReceiverPartyID > 0 )
    BankPayment.Receiver = rtdocument.rec.ReceiverPartyID;
  end;
  BankPayment.ReceiverName = rtdocument.rec.ReceiverName;

  if ( rtdocument.rec.ReceiverTempPartyID > 0 )
    FillFromTemporaryParty( rtdocument.rec.ReceiverTempPartyID, BankPayment.ReceiverINN );
  end;

  BankPayment.NotForBackOffice = "X";
  BankPayment.Number = rtdocument.rec.documentNumber;
  BankPayment.Ground = rtdocument.rec.Ground;
  BankPayment.NumberPack = rtdocument.rec.PackNumber;
  if ( StrLen( Trim( rtdocument.rec.OperationCipher ) ) > 0 )
    BankPayment.ShifrOper = rtdocument.rec.OperationCipher;
  end;
  BankPayment.PaymentPriority = rtdocument.rec.Priority;

  if ( rtdocument.rec.obSymbol != "" ) 
    symbcash = TRecHandler( "symbcash.dbt", "bank.def" );

    symbcash.Clear( );
    symbcash.rec.Kind = TS_NOTB;
    symbcash.rec.Symbol = rtdocument.rec.obSymbol;
    if ( rtdocument.rec.DebitAmount > 0)
      symbcash.rec.Sum = rtdocument.rec.DebitAmount;
    else
      symbcash.rec.Sum = rtdocument.rec.CreditAmount;
    end;

    if ( StrLen( symbcash.rec.Symbol ) == 2 )
      symbcash.rec.Symbol = " " + symbcash.rec.Symbol;
    end;

    aSymbcash( aSymbcash.Size( ) ) = symbcash;
  end;
    
  if ( aSymbcash.Size( ) > 0 )  
    BankPayment.SetCashSymbols( aSymbcash );
  end;

  // ®«ãç¨âì ¤ ­­ë¥ ¨§ ¯« â¥¦­®£® ®à¤¥à 
  cmd = RsdCommand( "select rtpaymentorder.* from drtpaymentorder_dbt rtpaymentorder " +
                    "where rtpaymentorder.t_DocumentId = :docId" );

  cmd.addParam( "docId", RSDBP_IN, rtdocument.rec.DocumentID );

  rs = RsdRecordset( cmd );

  rs.NullConversion = true;

  cmd.execute( );

  if ( rs.moveNext( ) )
    if ( ValType( rs.value( "t_authorStatus" ) ) == V_STRING )
      BankPayment.TaxAuthorState = rs.value( "t_authorStatus" );
      if ( BankPayment.TaxAuthorState == StrFor( 1 ) )
        BankPayment.TaxAuthorState = "";
      end;
    end;

    if ( ValType( rs.value( "t_budgetaryCode" ) ) == V_STRING )
      BankPayment.BttTICode = rs.value( "t_budgetaryCode" );
      if ( BankPayment.BttTICode == StrFor( 1 ) )
        BankPayment.BttTICode = "";
      end;
    end;

    if ( ValType( rs.value( "t_chargeBasisCode" ) ) == V_STRING )
      BankPayment.TaxPaymentGround = rs.value( "t_chargeBasisCode" );
      if ( BankPayment.TaxPaymentGround == StrFor( 1 ) )
        BankPayment.TaxPaymentGround = "";
      end;
    end;

    if ( ValType( rs.value( "t_taxPeriodIndicator" ) ) == V_STRING )
      BankPayment.TaxPeriod = rs.value( "t_taxPeriodIndicator" );
      if ( BankPayment.TaxPeriod == StrFor( 1 ) )
        BankPayment.TaxPeriod = "";
      end;
    end;

    if ( ValType( rs.value( "t_documentNumberIndicator" ) ) == V_STRING )
      BankPayment.TaxDocNumber = rs.value( "t_documentNumberIndicator" );
      if ( BankPayment.TaxDocNumber == StrFor( 1 ) )
        BankPayment.TaxDocNumber = "";
      end;
    end;

    if ( ValType( rs.value( "t_documentDateIndicator" ) ) == V_STRING )
      BankPayment.TaxDocDate = rs.value( "t_documentDateIndicator" );
      if ( BankPayment.TaxDocDate == StrFor( 1 ) )
        BankPayment.TaxDocDate = "";
      end;
    end;

    if ( ValType( rs.value( "t_paymentType" ) ) == V_STRING )
      BankPayment.TaxPaymentType = rs.value( "t_paymentType" );
      if ( BankPayment.TaxPaymentType == StrFor( 1 ) )
        BankPayment.TaxPaymentType = "";
      end;
    end;

    if ( ValType( rs.value( "t_OKATO" ) ) == V_STRING )
      BankPayment.OKATOCode = rs.value( "t_OKATO" );
      if ( BankPayment.OKATOCode == StrFor( 1 ) )
        BankPayment.OKATOCode = "";
      end;
    end;

    if ( ( ValType( rs.value( "t_paymentMode" ) ) == V_INTEGER ) or ( ValType( rs.value( "t_paymentMode" ) ) == V_DOUBLE ) )
      paymentMode = Int( rs.value( "t_paymentMode" ) );

      if ( paymentMode == 0 )
        BankPayment.PaymentKind = ""; // ¥ § ¤ ­
      elif ( paymentMode == 1 )
        BankPayment.PaymentKind = ""; // ®çâ®©
      elif ( paymentMode == 2 )
        BankPayment.PaymentKind = "’"; // ’¥«¥£à ä®¬
      elif ( paymentMode == 3 )
        BankPayment.PaymentKind = ""; // «¥ªâà®­­®
      elif ( paymentMode == 4 )
        BankPayment.PaymentKind = "‘"; // ‘à®ç­®
      end;
    end;

    if ( rtdocument.rec.isConsolidated == "" )
      if ( ValType( rs.value( "t_paymentCode" ) ) == V_STRING )
        BankPayment.UIN = rs.value( "t_paymentCode" );
        if ( BankPayment.UIN == StrFor( 1 ) )
          BankPayment.UIN = "";
        end;
      end;
    end;
  end;

  BankPayment.Origin = MEMORDER_FDOC_RETAIL;
  // BankPayment.Kind_Operation =
  BankPayment.Oper = {oper};
  BankPayment.OperNode = rtdocument.rec.Branch;
  // BankPayment.Instancy =
  // if ( rtdocument.rec.Instancy > 0 )
  //   BankPayment.NeedNotify = "X";
  // end;
  // BankPayment.IsVO =
  // BankPayment.VO_Accept =
  // BankPayment.VO_Oper =
  // BankPayment.VO_FIID =
  // BankPayment.VO_Direct =
  // BankPayment.VO_PayerBankID =
  // BankPayment.VO_PayerBankCodeKind =
  // BankPayment.VO_PayerBankCode =
  // BankPayment.VO_PayerBankCountry =
  // BankPayment.VO_ReceiverBankID =
  // BankPayment.VO_ReceiverBankCodeKind =
  // BankPayment.VO_ReceiverBankCode =
  // BankPayment.VO_ReceiverBankCountry =
  BankPayment.CheckTerror = DefCheckTerror( );
  // BankPayment.OperInitiatorCtg =

  // BankPayment.SetNotes
  // BankPayment.SetPaymNotes
  // BankPayment.SetCategories
  // BankPayment.SetPaymCategories
  // BankPayment.SetCOProperties

  if ( aPmAddPI.Size( ) > 0 )
     BankPayment.SetPmAddPI( aPmAddPI );
  end;

  // ã¦¥­ «¨ í«¥ªâà®­­ë© à¥¥áâà
  if ( ( BankPayment.BttTICode != "" ) and ( rtdocument.rec.isConsolidated != "" ) )
    if ( NeedElectronicReestr( ) )
      postActionType = 1;
      SetParm( 0, postActionType );
    end;
  end;

  return OK_RES;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro InitBankClaimToBB( postActionType )

  var aPmAddPI = TArray;
  var foldSide = rtdocument.rec.FoldSide;
  var valueDate;
  var stat;

  stat = DefValueDate( valueDate );
  if ( stat > 0 )
    return stat;
  end;

  if ( foldSide != FOLDSIDE_NONE )
    PmAddForFoldSide( aPmAddPI );

    if ( aPmAddPI.Size( ) == 0 )
      foldSide = FOLDSIDE_NONE;
    end;
  end;

  BankClaim.BOCode = BO_RS_RETAIL;
  BankClaim.BOAction = true;
  // BankClaim.BOStartDate =

  if ( ( foldSide == FOLDSIDE_NONE ) or ( foldSide == FOLDSIDE_CREDIT ) )
    BankClaim.BaseFIID = DefCodeCurr( rtdocument.rec.CreditCurrCode );
    BankClaim.BaseAmount = rtdocument.rec.CreditAmount;
  else
    BankClaim.BaseFIID = DefCodeCurr( rtdocument.rec.DebitCurrCode );
    BankClaim.BaseAmount = rtdocument.rec.DebitAmount;
  end;

  BankClaim.Date = rtdocument.rec.Date;
  BankClaim.ValueDate = valueDate;
  // BankClaim.BankDate =
  // BankClaim.PayDate =

  if ( rtdocument.rec.PayerBankPartyID > 0 )
    BankClaim.PayerBankID = rtdocument.rec.PayerBankPartyID;

    FillFromParty( rtdocument.rec.PayerBankPartyID, BankClaim.PayerBankName );

    if ( rtdocument.rec.DebitCurrCode == 0 )
      BankClaim.PayerBankCodeKind = 3; // ˆŠ – ”
    else
      BankClaim.PayerBankCodeKind = 6; // SWIFT
    end;
  end;

  if ( rtdocument.rec.PayerBankTempPartyID > 0 )
    FillFromTemporaryParty( rtdocument.rec.PayerBankTempPartyID, NULL, BankClaim.PayerBankCodeKind, BankClaim.PayerBankCode, BankClaim.PayerBankName, BankClaim.PayerCorrAccNostro );
  end;

  if ( foldSide != FOLDSIDE_CREDIT )
    if ( rtdocument.rec.PayerAccount != "" )
      BankClaim.PayerAccount = rtdocument.rec.PayerAccount;
    else
      BankClaim.PayerAccount = rtdocument.rec.DebitAccount;
    end;
    BankClaim.FuturePayerAccount = rtdocument.rec.DebitAccount;
  end;

  if ( rtdocument.rec.PayerPartyID > 0 )
    BankClaim.Payer = rtdocument.rec.PayerPartyID;
  end;

  if ( rtdocument.rec.PayerTempPartyID > 0 )
    BankClaim.PayerName = rtdocument.rec.PayerName;

    FillFromTemporaryParty( rtdocument.rec.PayerTempPartyID, BankClaim.PayerINN );
  end;

  if ( rtdocument.rec.ReceiverBankPartyID > 0 )
    BankClaim.ReceiverBankID = rtdocument.rec.ReceiverBankPartyID;

    FillFromParty( rtdocument.rec.ReceiverBankPartyID, BankClaim.ReceiverBankName );

    if ( rtdocument.rec.CreditCurrCode == 0 )
      BankClaim.ReceiverBankCodeKind = 3; // ˆŠ – ”
    else
      BankClaim.ReceiverBankCodeKind = 6; // SWIFT
    end;
  end;

  if ( rtdocument.rec.ReceiverBankTempPartyID > 0 )
    FillFromTemporaryParty( rtdocument.rec.ReceiverBankTempPartyID, NULL, BankClaim.ReceiverBankCodeKind, BankClaim.ReceiverBankCode, BankClaim.ReceiverBankName, BankClaim.ReceiverCorrAccNostro );
  end;

  if ( foldSide != FOLDSIDE_DEBIT )
    if ( rtdocument.rec.ReceiverAccount != "" )
      BankClaim.ReceiverAccount = rtdocument.rec.ReceiverAccount;
    else
      BankClaim.ReceiverAccount = rtdocument.rec.CreditAccount;
    end;
    BankClaim.FutureReceiverAccount = rtdocument.rec.CreditAccount;
  end;

  // BankClaim.Receiver =
  // BankClaim.ReceiverName =
  // BankClaim.ReceiverINN =
  BankClaim.Number = rtdocument.rec.documentNumber;
  BankClaim.Ground = rtdocument.rec.Ground;
  BankClaim.NumberPack = rtdocument.rec.PackNumber;
  BankClaim.PaymentPriority = rtdocument.rec.Priority;
  BankClaim.Origin = MEMORDER_FDOC_RETAIL;
  // BankClaim.Kind_Operation =
  BankClaim.Oper = {oper};
  BankClaim.OperNode = rtdocument.rec.Branch;
  // BankClaim.AcceptDate =
  // BankClaim.AcceptTerm =
  // BankClaim.Accept =
  // BankClaim.PaymentKind =
  // BankClaim.Instancy =
  // if ( rtdocument.rec.Instancy > 0 )
  //   BankClaim.NeedNotify = "X";
  // end;
  BankClaim.NotForBackOffice = "X";
  if ( StrLen( Trim( rtdocument.rec.OperationCipher ) ) > 0 )
    BankClaim.ShifrOper = rtdocument.rec.OperationCipher;
  end;
  // BankClaim.SymbNotBalDebet =
  // BankClaim.DocDispatchDate =
  // BankClaim.IsVO =
  // BankClaim.VO_Accept =
  // BankClaim.VO_Oper =
  // BankClaim.VO_FIID =
  // BankClaim.VO_Direct =
  // BankClaim.VO_PayerBankID =
  // BankClaim.VO_PayerBankCodeKind =
  // BankClaim.VO_PayerBankCode =
  // BankClaim.VO_PayerBankCountry =
  // BankClaim.VO_ReceiverBankID =
  // BankClaim.VO_ReceiverBankCodeKind =
  // BankClaim.VO_ReceiverBankCode =
  // BankClaim.VO_ReceiverBankCountry =
  BankClaim.CheckTerror = DefCheckTerror( );
  // BankClaim.MCMethodID =
  // BankClaim.MinimizationTurn =
  // BankClaim.OperInitiatorCtg =

  // BankClaim.SetNotes
  // BankClaim.SetPaymNotes
  // BankClaim.SetCategories
  // BankClaim.SetPaymCategories
  // BankClaim.SetCOProperties

  if ( aPmAddPI.Size( ) > 0 )
    BankClaim.SetPmAddPI( aPmAddPI );
  end;

  return OK_RES;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro InitCurrTransferToBB( postActionType )

  var aPmAddPI = TArray;
  var foldSide = rtdocument.rec.FoldSide;
  var valueDate;
  var stat;

  stat = DefValueDate( valueDate );
  if ( stat > 0 )
    return stat;
  end;

  if ( foldSide != FOLDSIDE_NONE )
    PmAddForFoldSide( aPmAddPI );

    if ( aPmAddPI.Size( ) == 0 )
      foldSide = FOLDSIDE_NONE;
    end;
  end;

  CurrencyPayment.BOCode = BO_RS_RETAIL;
  CurrencyPayment.BOAction = true;
  // CurrencyPayment.BOStartDate =
  CurrencyPayment.DocKind = PS_CPORDER;

  if ( isLoadCurrTransferToBB )
    CurrencyPayment.DocKind = BBANK_CPORDER;
  end;

  CurrencyPayment.BaseFIID = DefCodeCurr( rtdocument.rec.CreditCurrCode );
  CurrencyPayment.BaseAmount = rtdocument.rec.CreditAmount;

  CurrencyPayment.PayerFIID = DefCodeCurr(rtdocument.rec.DebitCurrCode);
  CurrencyPayment.PayerAmount = rtdocument.rec.DebitAmount;
  CurrencyPayment.ReceiverFIID = DefCodeCurr(rtdocument.rec.CreditCurrCode);
  CurrencyPayment.ReceiverAmount = rtdocument.rec.CreditAmount;
  CurrencyPayment.FIID_FuturePayAcc = DefCodeCurr(rtdocument.rec.DebitCurrCode);
  CurrencyPayment.FIID_FutureRecAcc = DefCodeCurr(rtdocument.rec.CreditCurrCode);
  // CurrencyPayment.RateType =
  // CurrencyPayment.RateScale =
  // CurrencyPayment.RatePoint =
  // CurrencyPayment.RateValue =
  // CurrencyPayment.RateIsInverse =
  CurrencyPayment.Date = rtdocument.rec.Date;
  CurrencyPayment.ValueDate = valueDate;
  // CurrencyPayment.BankDate =
  // CurrencyPayment.PayDate =

  if ( rtdocument.rec.PayerBankPartyID > 0 )
    CurrencyPayment.PayerBankID = rtdocument.rec.PayerBankPartyID;

    FillFromParty( rtdocument.rec.PayerBankPartyID, CurrencyPayment.PayerBankName );

    CurrencyPayment.PayerBankCodeKind = 6; // SWIFT
  end;

  if ( rtdocument.rec.PayerBankTempPartyID > 0 )
    FillFromTemporaryParty( rtdocument.rec.PayerBankTempPartyID, NULL, CurrencyPayment.PayerBankCodeKind, CurrencyPayment.PayerBankCode, CurrencyPayment.PayerBankName, CurrencyPayment.PayerCorrAccNostro );
  end;

  if ( foldSide != FOLDSIDE_CREDIT )
    if ( rtdocument.rec.PayerAccount != "" )
      CurrencyPayment.PayerAccount = rtdocument.rec.PayerAccount;
    else
      CurrencyPayment.PayerAccount = rtdocument.rec.DebitAccount;
    end;
    CurrencyPayment.FuturePayerAccount = rtdocument.rec.DebitAccount;
  end;

  if ( rtdocument.rec.PayerPartyID > 0 )
    CurrencyPayment.Payer = rtdocument.rec.PayerPartyID;
  end;

  if ( rtdocument.rec.PayerTempPartyID > 0 )
    CurrencyPayment.PayerName = rtdocument.rec.PayerName;

    FillFromTemporaryParty( rtdocument.rec.PayerTempPartyID, CurrencyPayment.PayerINN );
  end;

  if ( rtdocument.rec.ReceiverBankPartyID > 0 )
    CurrencyPayment.ReceiverBankID = rtdocument.rec.ReceiverBankPartyID;

    FillFromParty( rtdocument.rec.ReceiverBankPartyID, CurrencyPayment.ReceiverBankName );

    CurrencyPayment.ReceiverBankCodeKind = 6; // SWIFT
  end;

  if ( rtdocument.rec.ReceiverBankTempPartyID > 0 )
    FillFromTemporaryParty( rtdocument.rec.ReceiverBankTempPartyID, NULL, CurrencyPayment.ReceiverBankCodeKind, CurrencyPayment.ReceiverBankCode, CurrencyPayment.ReceiverBankName, CurrencyPayment.ReceiverCorrAccNostro );
  end;

  if ( foldSide != FOLDSIDE_DEBIT )
    if ( rtdocument.rec.ReceiverAccount != "" )
      CurrencyPayment.ReceiverAccount = rtdocument.rec.ReceiverAccount;
    else
      CurrencyPayment.ReceiverAccount = rtdocument.rec.CreditAccount;
    end;
    CurrencyPayment.FutureReceiverAccount = rtdocument.rec.CreditAccount;
  end;

  // CurrencyPayment.Receiver =

  if ( rtdocument.rec.ReceiverTempPartyID > 0 )
    CashOrder.ReceiverName = rtdocument.rec.ReceiverName;
    CurrencyPayment.ReceiverName = rtdocument.rec.ReceiverName;

    FillFromTemporaryParty( rtdocument.rec.ReceiverTempPartyID, CurrencyPayment.ReceiverINN );
  end;

  // CurrencyPayment.ReceiverCodeKind =
  // CurrencyPayment.ReceiverCode =
  // CurrencyPayment.ReceiverCorrBankID =
  // CurrencyPayment.ReceiverCorrBankCodeKind =
  // CurrencyPayment.ReceiverCorrBankCode =
  // CurrencyPayment.ReceiverCorrBankName =
  // CurrencyPayment.ReceiverCorrBankAccount =
  // CurrencyPayment.ReceiverCorrBankCodeKindName =
  // CurrencyPayment.ReceiverTransferDate =
  CurrencyPayment.NotForBackOffice = "X";
  CurrencyPayment.Number = rtdocument.rec.documentNumber;
  CurrencyPayment.PaymentPriority = rtdocument.rec.Priority;
  CurrencyPayment.Ground = rtdocument.rec.Ground;
  CurrencyPayment.NumberPack = rtdocument.rec.PackNumber;
  if ( StrLen( Trim( rtdocument.rec.OperationCipher ) ) > 0 )
    CurrencyPayment.ShifrOper = rtdocument.rec.OperationCipher;
  end;
  CurrencyPayment.Origin = CP_OR_RETAIL;
  // CurrencyPayment.Kind_Operation =
  CurrencyPayment.Oper = {oper};
  CurrencyPayment.OperNode = rtdocument.rec.Branch;
  // CurrencyPayment.PaymentKind =
  // CurrencyPayment.ComissCharges =
  // CurrencyPayment.Instancy =
  // if ( rtdocument.rec.Instancy > 0 )
  //   CurrencyPayment.NeedNotify = "X";
  // end;
  CurrencyPayment.SymbNotBalDebet = rtdocument.rec.obSymbol;
  // CurrencyPayment.PartyInfo =
  // CurrencyPayment.UserField1 =
  // CurrencyPayment.UserField2 =
  // CurrencyPayment.UserField3 =
  // CurrencyPayment.UserField4 =
  // CurrencyPayment.ComissFIID =
  // CurrencyPayment.ComissAccount =
  // CurrencyPayment.IsVO =
  // CurrencyPayment.VO_Accept =
  // CurrencyPayment.VO_Oper =
  // CurrencyPayment.VO_FIID =
  // CurrencyPayment.VO_Direct =
  // CurrencyPayment.VO_PayerBankID =
  // CurrencyPayment.VO_PayerBankCodeKind =
  // CurrencyPayment.VO_PayerBankCode =
  // CurrencyPayment.VO_PayerBankCountry =
  // CurrencyPayment.VO_ReceiverBankID =
  // CurrencyPayment.VO_ReceiverBankCodeKind =
  // CurrencyPayment.VO_ReceiverBankCode =
  // CurrencyPayment.VO_ReceiverBankCountry =
  CurrencyPayment.CheckTerror = DefCheckTerror( );
  if ( rtdocument.rec.MultiCurrencyMethod > 0 )
    CurrencyPayment.MCMethodID = rtdocument.rec.MultiCurrencyMethod;
  end;
  // CurrencyPayment.MinimizationTurn =
  // CurrencyPayment.OperInitiatorCtg =

  // CurrencyPayment.SetNotes
  // CurrencyPayment.SetPaymNotes
  // CurrencyPayment.SetCategories
  // CurrencyPayment.SetPaymCategories
  // CurrencyPayment.SetCOProperties

  if ( aPmAddPI.Size( ) > 0 )
    CurrencyPayment.SetPmAddPI( aPmAddPI );
  end;

  // CurrencyPayment.SetParties

  return OK_RES;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro InitTransferOrderToBB( postActionType )

  var aPmStVals = TArray;
  var pmstval;
  var valueDate;
  var valuePartyId = 0;
  var valueTempPartyId = 0;
  var valueRef = 0;
  var valueNumPieces = 0;
  var valueCost = $0L;
  var stat;

  stat = DefValueDate( valueDate );
  if ( stat > 0 )
    return stat;
  end;

  DefCodeForValue( rtdocument.rec.DocumentID, valuePartyId, valueTempPartyId, valueRef, valueNumPieces, valueCost );

  TransferOrder.BaseFIID = DefCodeCurr( rtdocument.rec.CreditCurrCode );
  TransferOrder.BaseAmount = rtdocument.rec.CreditAmount;

  TransferOrder.Date = rtdocument.rec.Date;
  TransferOrder.ValueDate = valueDate;
  TransferOrder.PayerBankID = DefBankId( );
  // TransferOrder.PayerBankCodeKind =
  // TransferOrder.PayerBankCode =
  // TransferOrder.PayerBankName =

  if ( rtdocument.rec.PayerAccount != "" )
    TransferOrder.PayerAccount = rtdocument.rec.PayerAccount;
  else
    TransferOrder.PayerAccount = rtdocument.rec.DebitAccount;
  end;
  TransferOrder.FuturePayerAccount = rtdocument.rec.DebitAccount;

  // TransferOrder.PayerCorrAccNostro =
  // TransferOrder.Payer =
  // TransferOrder.PayerName =
  // TransferOrder.PayerINN =
  TransferOrder.ReceiverBankID = DefBankId( );
  // TransferOrder.ReceiverBankCodeKind =
  // TransferOrder.ReceiverBankCode =
  // TransferOrder.ReceiverBankName =

  if ( rtdocument.rec.ReceiverAccount != "" )
    TransferOrder.ReceiverAccount = rtdocument.rec.ReceiverAccount;
  else
    TransferOrder.ReceiverAccount = rtdocument.rec.CreditAccount;
  end;
  TransferOrder.FutureReceiverAccount = rtdocument.rec.CreditAccount;

  // TransferOrder.ReceiverCorrAccNostro =
  // TransferOrder.Receiver =
  // TransferOrder.ReceiverName =
  // TransferOrder.ReceiverINN =
  TransferOrder.NotForBackOffice = "X";
  TransferOrder.Number = rtdocument.rec.documentNumber;
  TransferOrder.Ground = rtdocument.rec.Ground;
  TransferOrder.NumberPack = rtdocument.rec.PackNumber;
  if ( StrLen( Trim( rtdocument.rec.OperationCipher ) ) > 0 )
    TransferOrder.ShifrOper = rtdocument.rec.OperationCipher;
  end;
  // TransferOrder.PaymentPriority =
  TransferOrder.Origin = CB_DOC_ORIGIN_RETAIL;
  TransferOrder.Chapter = rtdocument.rec.Chapter;
  // TransferOrder.Kind_Operation =
  TransferOrder.Oper = {oper};
  // TransferOrder.TypeDocument =
  // TransferOrder.UserTypeDocument =

  if ( valuePartyId > 0 )
    FillFromParty( valuePartyId, TransferOrder.OwnerValues );
  elif ( valueTempPartyId > 0 )
    FillFromTemporaryParty( valueTempPartyId, null, null, null, TransferOrder.OwnerValues );
  end;

  TransferOrder.ReceiverNameValues = rtdocument.rec.SignerName;
  // TransferOrder.PaperKind =
  // TransferOrder.PaperSeries =
  // TransferOrder.PaperNumber =
  // TransferOrder.PaperIssuedDate =
  // TransferOrder.PaperIssuer =
  TransferOrder.CheckTerror = DefCheckTerror( );
  TransferOrder.OperNode = rtdocument.rec.Branch;
  // TransferOrder.PayerChargeOffDate =

  if ( ( rtdocument.rec.FoldSide == FOLDSIDE_NONE ) and ( valueRef > 0 ) )
    pmstval = TRecHandler( "pmstval.dbt", "bank.def" );

    pmstval.Clear( );

    FillFromCashVal( valueRef, pmstval.rec.nameValue );
    if ( pmstval.rec.nameValue == "" )
      pmstval.rec.nameValue = String( valueRef );
    end;
    pmstval.rec.countValue = valueNumPieces;
    pmstval.rec.amountValue = valueCost;

    aPmStVals( aPmStVals.Size( ) ) = pmstval;
        
    if ( aPmStVals.Size( ) > 0 )
      TransferOrder.SetPmStVals( aPmStVals );
    end;
  end;

  return OK_RES;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro PerfomPostActionsForDocInTrn( actionType )

  var TransferParam;
  var stat = 0;
  var cmd, rs;
  var cmd2, rs2;
  var cmd3, rs3;
  var cmd4, rs4;
  var cmd5, rs5;
  var opApplKind = 0;
  var opApplKey = "";
  var docId = 0;
  var typeDoc = 0;
  var inn = "";
  var address = "";
  var bankpaymentid = 0;

  if ( actionType == 0 )
    return stat;
  end;


  cmd5 = RsdCommand("select ltrim(op.t_documentid, '0')  t_docid from doproper_dbt op " + 
                    "where OP.T_ID_OPERATION = :operId");

  cmd5.addParam( "operId", RSDBP_IN, Int( rtdocument.rec.PaymentID ) );

  rs5 = RsdRecordset( cmd5 );

  rs5.NullConversion = true;

  cmd5.execute( );

  if ( rs5.moveNext( ) )
      if (  ValType( rs5.value( "t_docid" ) ) ==  V_STRING  )
        bankpaymentid = Int( rs5.value( "t_docid" ) );
      end;
  end;
  

  // –¨ª«
  cmd = RsdCommand( "select rtdocument.t_opApplicationKind, rtdocument.t_opApplicationKey, rtdocument.t_DocumentID, " + 
                           "rtdocument.t_date, " +
                           "rtdocument.t_DebitAmount, " +
                           "rtdocument.t_PayerName, " +
                           "rtdocument.t_ReceiverName, " +
                           "rtdocument.t_ReceiverBankPartyID, " +
                           "rtdocument.t_ReceiverBankTempPartyID, " +
                           "rtdocument.t_ReceiverAccount, " +
                           "rtdocument.t_Department, " +
                           "rtdocument.t_Branch, " +
                           "rtdocument.t_Ground, " +
                           "rtdocument.t_DocumentNumber, " +
                           "rtdocument.t_PayerAccount, " +
                           "rtdocument.t_PackNumber " +
                      "from drtdocument_dbt rtdocument " +
                    "where rtdocument.t_ConsDocumentID = :docId");

  cmd.addParam( "docId", RSDBP_IN, rtdocument.rec.DocumentID );

  rs = RsdRecordset( cmd );

  rs.NullConversion = true;

  cmd.execute( );

  while ( rs.moveNext( ) )

    opApplKind = 0;
    opApplKey = "";
    docId = 0;
    typeDoc = 0;

    if ( ( ValType( rs.value( "t_opApplicationKind" ) ) == V_INTEGER ) or ( ValType( rs.value( "t_opApplicationKind" ) ) == V_DOUBLE ) )
      opApplKind = Int( rs.value( "t_opApplicationKind" ) );
    end;

    if ( ValType( rs.value( "t_opApplicationKey" ) ) == V_STRING )
      opApplKey = rs.value( "t_opApplicationKey" );

      if ( opApplKey == StrFor( 1 ) )
        opApplKey = "";
      end;
    end;

    if ( ( ValType( rs.value( "t_DocumentID" ) ) == V_INTEGER ) or ( ValType( rs.value( "t_DocumentID" ) ) == V_DOUBLE ) )
      docId = Int( rs.value( "t_DocumentID" ) );
    end;

    if ( opApplKey == "" )
      continue;
    end;
            
    cmd2 = RsdCommand( "select pcp.* from dsb_casln_dbt cl, dpay_doc_cp_dbt pcp " +
                       "where cl.T_APPLICATIONKIND1 = :applKind " +
                         "and cl.T_APPLICATIONKEY1 = :applKey " +
                         "and cl.T_APPLICATIONKIND2 in ( 1, 20 ) " +
                         "and cl.T_REFVALUE2 = 0 " +
                         "and pcp.T_APPLKIND = cl.T_APPLICATIONKIND2 " +
                         "and pcp.T_APPLKEY = cl.T_APPLICATIONKEY2" );

    cmd2.addParam( "applKind", RSDBP_IN, opApplKind );
    cmd2.addParam( "applKey", RSDBP_IN, opApplKey );
    
    rs2 = RsdRecordset( cmd2 );

    rs2.NullConversion = true;

    cmd2.execute( );

    if ( rs2.moveNext( ) )
      if ( ( ValType( rs2.value( "t_applKind" ) ) == V_INTEGER ) or ( ValType( rs2.value( "t_applKind" ) ) == V_DOUBLE ) )
        typeDoc = Int( rs2.value( "t_applKind" ) );
      end;

      if ( typeDoc == 1 )
        sbdepdoc_pa.Clear( );
        sbdepdoc_pa.rec.iApplicationKind = rs2.value( "t_applKind" );
        sbdepdoc_pa.rec.ApplicationKey   = rs2.value( "t_applKey" );

        if ( sbdepdoc_pa.GetEQ )
          ;
        else
          sbdepdoc_pa.Clear( );
        end;
      elif ( typeDoc == 20 )
        pay_doc_pa.Clear( );
        pay_doc_pa.rec.iApplicationKind = rs2.value( "t_applKind" );
        pay_doc_pa.rec.ApplicationKey   = rs2.value( "t_applKey" );

        if ( pay_doc_pa.GetEQ( ) )
          ;
        else
          pay_doc_pa.Clear( );
        end;
      else
        typeDoc == 0;
      end;
    end;

    TransferParam = BOTransferParm;

    // TransferParam.BdTransfID      
    TransferParam.State = 10; // WLD_STATUS_BT_CREATEPM
    TransferParam.Date = rs.value("t_date"); // rtdocument.rec.Date;
    TransferParam.Amount = rs.value("t_DebitAmount"); // rtdocument.rec.DebitAmount;
    TransferParam.PayerName = rs.value("t_PayerName"); // rtdocument.rec.PayerName;

    if ( typeDoc == 1 )

      cmd4 = RsdCommand( "select rsi_rsbparty.GetPartyCode( ?, 16 ) from dual" );

      cmd4.addParam( "", RSDBP_IN, sbdepdoc_pa.rec.CodClient );

      cmd4.execute( );

      rs4 = RsdRecordset( cmd4 );

      if ( rs4.moveNext )

        inn = rs4.value( 0 );

        if ( ValType( inn ) == V_STRING )
          TransferParam.PayerINN = inn;

          if ( TransferParam.PayerINN == StrFor( 1 ) )
            TransferParam.PayerINN = "";
          end;
        end;
      end;
    elif ( typeDoc == 20 )
      TransferParam.PayerINN = pay_doc_pa.rec.INN_Payer;
    end;

    if ( typeDoc == 1 )

      cmd4 = RsdCommand( "select rsi_rsbparty.PT_GetAdress( ? ) from dual" );

      cmd4.addParam( "", RSDBP_IN, sbdepdoc_pa.rec.CodClient );

      cmd4.execute( );

      rs4 = RsdRecordset( cmd4 );

      if ( rs4.moveNext )

        address = rs4.value( 0 );

        if ( ValType( inn ) == V_STRING )
          TransferParam.PayerAdress = address;

          if ( TransferParam.PayerAdress == StrFor( 1 ) )
            TransferParam.PayerAdress = "";
          end;
        end;
      end;
    elif ( typeDoc == 20 )
      TransferParam.PayerAdress = pay_doc_pa.rec.ClientAddress;
    end;

    TransferParam.ReceiverName = rs.value("t_ReceiverName"); // rtdocument.rec.ReceiverName;
            
    if ( rs.value("t_ReceiverBankPartyID") > 0 )
      TransferParam.ReceiverINN = findPartyCode( rs.value("t_ReceiverBankPartyID"), 16 ); //rtdocument.rec.ReceiverBankPartyID
      TransferParam.ReceiverBankCode = findPartyCode( rs.value("t_ReceiverBankPartyID"), 3 );
    elif ( rs.value("t_ReceiverBankTempPartyID") > 0 )
      FillFromTemporaryParty( rs.value("t_ReceiverBankTempPartyID"), TransferParam.ReceiverINN, NULL, TransferParam.ReceiverBankCode, NULL, NULL, true ); //rtdocument.rec.ReceiverBankTempPartyID
    end;

    TransferParam.ReceiverAccount = rs.value("t_ReceiverAccount"); // rtdocument.rec.ReceiverAccount;

    TransferParam.Department = rs.value("t_Department"); // rtdocument.rec.Department;
    TransferParam.Branch = rs.value("t_Branch"); // rtdocument.rec.Branch;

    cmd3 = RsdCommand( "select rtpaymentorder.* from drtpaymentorder_dbt rtpaymentorder " +
                    "where rtpaymentorder.t_DocumentId = :docId" );

    cmd3.addParam( "docId", RSDBP_IN, docId );

    rs3 = RsdRecordset( cmd3 );

    rs3.NullConversion = true;

    cmd3.execute( );

    if ( rs3.moveNext( ) )

      if ( ValType( rs3.value( "t_budgetaryCode" ) ) == V_STRING )
        TransferParam.BttTiCode = rs3.value( "t_budgetaryCode" );
        if ( TransferParam.BttTiCode == StrFor( 1 ) )
          TransferParam.BttTiCode = "";
        end;
      end;

      if ( ValType( rs3.value( "t_OKATO" ) ) == V_STRING )
        TransferParam.OKATOCode = rs3.value( "t_OKATO" );
        if ( TransferParam.OKATOCode == StrFor( 1 ) )
          TransferParam.OKATOCode = "";
        end;
      end;

      if ( ValType( rs3.value( "t_authorStatus" ) ) == V_STRING )
        TransferParam.TaxAuthorState = rs3.value( "t_authorStatus" );
        if ( TransferParam.TaxAuthorState == StrFor( 1 ) )
          TransferParam.TaxAuthorState = "";
        end;
      end;

      if ( ValType( rs3.value( "t_chargeBasisCode" ) ) == V_STRING )
        TransferParam.TaxPmGround = rs3.value( "t_chargeBasisCode" );
        if ( TransferParam.TaxPmGround == StrFor( 1 ) )
          TransferParam.TaxPmGround = "";
        end;
      end;

      if ( ValType( rs3.value( "t_taxPeriodIndicator" ) ) == V_STRING )
        TransferParam.TaxPmPeriod = rs3.value( "t_taxPeriodIndicator" );
        if ( TransferParam.TaxPmPeriod == StrFor( 1 ) )
          TransferParam.TaxPmPeriod = "";
        end;
      end;

      if ( ValType( rs3.value( "t_paymentType" ) ) == V_STRING )
        TransferParam.TaxPmType = rs3.value( "t_paymentType" );
        if ( TransferParam.TaxPmType == StrFor( 1 ) )
          TransferParam.TaxPmType = "";
        end;
      end;

      if ( ValType( rs3.value( "t_documentNumberIndicator" ) ) == V_STRING )
        TransferParam.TaxPmNumber = rs3.value( "t_documentNumberIndicator" );
        if ( TransferParam.TaxPmNumber == StrFor( 1 ) )
          TransferParam.TaxPmNumber = "";
        end;
      end;

      if ( ValType( rs3.value( "t_documentDateIndicator" ) ) == V_STRING )
        if ( ValType( TransferParam.TaxPmDate ) == V_DATE )
          TransferParam.TaxPmDate = StringToDate( rs3.value( "t_documentDateIndicator" ) );
        else
          TransferParam.TaxPmDate = rs3.value( "t_documentDateIndicator" );
          if ( TransferParam.TaxPmDate == StrFor( 1 ) )
            TransferParam.TaxPmDate = "";
          end;
        end;
      end;
    end;

    TransferParam.Ground = rs.value("t_Ground"); // rtdocument.rec.Ground;
    TransferParam.TaxOperation = rs.value("t_DocumentNumber"); // rtdocument.rec.documentNumber;


    if ( ( typeDoc > 0 ) and ( ValType( rs2.value( "t_PersonID" ) ) == V_STRING ) )
      TransferParam.TaxPersonRef = rs2.value( "t_PersonID" );
      if ( TransferParam.TaxPersonRef == StrFor( 1 ) )
        TransferParam.TaxPersonRef = "";
      end;
    end;

    if ( ( typeDoc > 0 ) and ( ValType( rs2.value( "t_DocIndex" ) ) == V_STRING ) )
      TransferParam.TaxPmIndex = rs2.value( "t_DocIndex" );
      if ( TransferParam.TaxPmIndex == StrFor( 1 ) )
        TransferParam.TaxPmIndex = "";
      end;
    end;

    // TransferParam.OFKAccount      
    // TransferParam.FinAccount      
    TransferParam.TransitAccount = rs.value("t_PayerAccount"); // rtdocument.rec.PayerAccount;
    TransferParam.CoverPaymentID  = bankpaymentid;
    // TransferParam.InfoID          
    // TransferParam.UIS             
    // TransferParam.GUID            
    // TransferParam.Trn             
    //TransferParam.InitialPaymentID = Int(rtdocument.rec.PaymentID);
    // TransferParam.PayerAccount    

    if ( ( typeDoc > 0 ) and ( ValType( rs2.value( "t_ChargeID" ) ) == V_STRING ) )
      TransferParam.UIN = rs2.value( "t_ChargeID" );
      if ( TransferParam.UIN == StrFor( 1 ) )
        TransferParam.UIN = "";
      end;
    end;

    TransferParam.NumberPack = rs.value("t_PackNumber"); // rtdocument.rec.PackNumber;

    stat = InsertBOTransfer( TransferParam );

  end;
  
  return stat;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro T_InsertBOCashOrder

  var contextID = null;
  var cmd = RsdCommand( "update drtdocument_dbt set t_ExportState = 2, t_PaymentID = ? where t_DocumentID = ?" );
  var cmdGetDirect = RsdCommand( "select * from drtdocument_dbt where t_DocumentID = ? for update" );
  var rsGetDirect;

  statInsert = 0;

  if ( statInsert == 0 )
    cmdGetDirect.addParam( "p_DocumentID", RSDBP_IN, rtdocument.rec.DocumentID );
    cmdGetDirect.execute( );
    rsGetDirect = RsdRecordset( cmdGetDirect );
    if ( rsGetDirect.MoveNext( ) )
       if ( Int( rsGetDirect.value( "t_ExportState" ) ) == 2 )
         statInsert = -21071;
       end;
    end;
  end;

  if ( statInsert == 0 )
    if ( signKindCashDoc )
      contextID = ContextRetailESign;
    end;

    statInsert = InsertBOCashOrder( CashOrder, 0, 0, false, contextID, null );
  end;

  if ( statInsert == 0 )
    cmd.addParam( "p_PaymentID", RSDBP_IN, String( CashOrder.ID_Operation ) );
    cmd.addParam( "p_DocumentID", RSDBP_IN, rtdocument.rec.DocumentID );

    cmd.execute( );
  end;

  if ( ( statInsert == 0 ) and ( postActionTypeInsert > 0 ) )
    statInsert = perfomPostActionsForDocInTrn( postActionTypeInsert );
  end;
  
  if ( statInsert != 0 )
    AbortTrn( );
  else
    rtdocument.rec.ExportState = 2;
    rtdocument.rec.PaymentID = String( CashOrder.ID_Operation );
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro T_InsertBOMemorialOrder

  var contextID = null;
  var cmd = RsdCommand( "update drtdocument_dbt set t_ExportState = 2, t_PaymentID = ? where t_DocumentID = ?" );
  var cmdGetDirect = RsdCommand( "select * from drtdocument_dbt where t_DocumentID = ? for update" );
  var rsGetDirect;

  statInsert = 0;

  if ( statInsert == 0 )
    cmdGetDirect.addParam( "p_DocumentID", RSDBP_IN, rtdocument.rec.DocumentID );
    cmdGetDirect.execute( );
    rsGetDirect = RsdRecordset( cmdGetDirect );
    if ( rsGetDirect.MoveNext( ) )
       if ( Int( rsGetDirect.value( "t_ExportState" ) ) == 2 )
         statInsert = -21071;
       end;
    end;
  end;
  
  if ( statInsert == 0 )
    if ( signKindMemOrder )
      contextID = ContextRetailESign;
    end;

    statInsert = InsertBOMemorialOrder( MemorialOrder, 0, 0, false, contextID, null );
  end;

  if ( statInsert == 0 )
    cmd.addParam( "p_PaymentID", RSDBP_IN, String( MemorialOrder.ID_Operation ) );
    cmd.addParam( "p_DocumentID", RSDBP_IN, rtdocument.rec.DocumentID );

    cmd.execute( );
  end;

  if ( ( statInsert == 0 ) and ( postActionTypeInsert > 0 ) )
    statInsert = perfomPostActionsForDocInTrn( postActionTypeInsert );
  end;
  
  if ( statInsert != 0 )
    AbortTrn( );
  else
    rtdocument.rec.ExportState = 2;
    rtdocument.rec.PaymentID = String( MemorialOrder.ID_Operation );
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro T_InsertBOMultyDoc

  var contextID = null;
  var cmd = RsdCommand( "update drtdocument_dbt set t_ExportState = 2, t_PaymentID = ? where t_DocumentID = ?" );
  var cmdGetDirect = RsdCommand( "select * from drtdocument_dbt where t_DocumentID = ? for update" );
  var rsGetDirect;

  statInsert = 0;

  if ( statInsert == 0 )
    cmdGetDirect.addParam( "p_DocumentID", RSDBP_IN, rtdocument.rec.DocumentID );
    cmdGetDirect.execute( );
    rsGetDirect = RsdRecordset( cmdGetDirect );
    if ( rsGetDirect.MoveNext( ) )
       if ( Int( rsGetDirect.value( "t_ExportState" ) ) == 2 )
         statInsert = -21071;
       end;
    end;
  end;

  if ( statInsert == 0 )
    if ( signKindMultiDoc )
      contextID = ContextRetailESign;
    end;

    statInsert = InsertBOMultyDoc( MultyDoc, 0, 0, false, contextID, null );
  end;

  if ( statInsert == 0 )
    cmd.addParam( "p_PaymentID", RSDBP_IN, String( MultyDoc.ID_Operation ) );
    cmd.addParam( "p_DocumentID", RSDBP_IN, rtdocument.rec.DocumentID );

    cmd.execute( );
  end;

  if ( ( statInsert == 0 ) and ( postActionTypeInsert > 0 ) )
    statInsert = perfomPostActionsForDocInTrn( postActionTypeInsert );
  end;
  
  if ( statInsert != 0 )
    AbortTrn( );
  else
    rtdocument.rec.ExportState = 2;
    rtdocument.rec.PaymentID = String( MultyDoc.ID_Operation );
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro T_InsertBOBankOrder

  var contextID = null;
  var cmd = RsdCommand( "update drtdocument_dbt set t_ExportState = 2, t_PaymentID = ? where t_DocumentID = ?" );
  var cmdGetDirect = RsdCommand( "select * from drtdocument_dbt where t_DocumentID = ? for update" );
  var rsGetDirect;

  statInsert = 0;

  if ( statInsert == 0 )
    cmdGetDirect.addParam( "p_DocumentID", RSDBP_IN, rtdocument.rec.DocumentID );
    cmdGetDirect.execute( );
    rsGetDirect = RsdRecordset( cmdGetDirect );
    if ( rsGetDirect.MoveNext( ) )
       if ( Int( rsGetDirect.value( "t_ExportState" ) ) == 2 )
         statInsert = -21071;
       end;
    end;
  end;

  if ( statInsert == 0 )
    if ( signKindMemOrder )
      contextID = ContextRetailESign;
    end;

    statInsert = InsertBOBankOrder( BankOrder, 0, 0, false, contextID, null );
  end;

  if ( statInsert == 0 )
    cmd.addParam( "p_PaymentID", RSDBP_IN, String( BankOrder.ID_Operation ) );
    cmd.addParam( "p_DocumentID", RSDBP_IN, rtdocument.rec.DocumentID );

    cmd.execute( );
  end;

  if ( ( statInsert == 0 ) and ( postActionTypeInsert > 0 ) )
    statInsert = perfomPostActionsForDocInTrn( postActionTypeInsert );
  end;
  
  if ( statInsert != 0 )
    AbortTrn( );
  else
    rtdocument.rec.ExportState = 2;
    rtdocument.rec.PaymentID = String( BankOrder.ID_Operation );
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro T_InsertBOBankPayment

  var contextID = null;
  var cmd = RsdCommand( "update drtdocument_dbt set t_ExportState = 2, t_PaymentID = ? where t_DocumentID = ?" );
  var cmdGetDirect = RsdCommand( "select * from drtdocument_dbt where t_DocumentID = ? for update" );
  var rsGetDirect;

  statInsert = 0;

  if ( statInsert == 0 )
    cmdGetDirect.addParam( "p_DocumentID", RSDBP_IN, rtdocument.rec.DocumentID );
    cmdGetDirect.execute( );
    rsGetDirect = RsdRecordset( cmdGetDirect );
    if ( rsGetDirect.MoveNext( ) )
       if ( Int( rsGetDirect.value( "t_ExportState" ) ) == 2 )
         statInsert = -21071;
       end;
    end;
  end;

  if ( statInsert == 0 )
    if ( signKindExternPay )
      contextID = ContextRetailESign;
    end;

    statInsert = InsertBOBankPayment( BankPayment, 0, 0, false, contextID, null );
  end;

  if ( statInsert == 0 )
    cmd.addParam( "p_PaymentID", RSDBP_IN, String( BankPayment.ID_Operation ) );
    cmd.addParam( "p_DocumentID", RSDBP_IN, rtdocument.rec.DocumentID );

    cmd.execute( );
  end;

  if ( ( statInsert == 0 ) and ( postActionTypeInsert > 0 ) )
    rtdocument.rec.PaymentID = String( BankPayment.ID_Operation );
    statInsert = perfomPostActionsForDocInTrn( postActionTypeInsert );
  end;
  
  if ( statInsert != 0 )
    AbortTrn( );
  else
    rtdocument.rec.ExportState = 2;
    rtdocument.rec.PaymentID = String( BankPayment.ID_Operation );
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro T_InsertBOCurrencyPayment

  var contextID = null;
  var cmd = RsdCommand( "update drtdocument_dbt set t_ExportState = 2, t_PaymentID = ? where t_DocumentID = ?" );
  var cmdGetDirect = RsdCommand( "select * from drtdocument_dbt where t_DocumentID = ? for update" );
  var rsGetDirect;

  statInsert = 0;

  if ( statInsert == 0 )
    cmdGetDirect.addParam( "p_DocumentID", RSDBP_IN, rtdocument.rec.DocumentID );
    cmdGetDirect.execute( );
    rsGetDirect = RsdRecordset( cmdGetDirect );
    if ( rsGetDirect.MoveNext( ) )
       if ( Int( rsGetDirect.value( "t_ExportState" ) ) == 2 )
         statInsert = -21071;
       end;
    end;
  end;

  if ( statInsert == 0 )
    if ( signKindExternPay )
      contextID = ContextRetailESign;
    end;

    statInsert = InsertBOCurrencyPayment( CurrencyPayment, 0, 0, false, contextID, null );
  end;

  if ( statInsert == 0 )
    cmd.addParam( "p_PaymentID", RSDBP_IN, String( CurrencyPayment.ID_Operation ) );
    cmd.addParam( "p_DocumentID", RSDBP_IN, rtdocument.rec.DocumentID );

    cmd.execute( );
  end;

  if ( ( statInsert == 0 ) and ( postActionTypeInsert > 0 ) )
    statInsert = perfomPostActionsForDocInTrn( postActionTypeInsert );
  end;
  
  if ( statInsert != 0 )
    AbortTrn( );
  else
    rtdocument.rec.ExportState = 2;
    rtdocument.rec.PaymentID = String( CurrencyPayment.ID_Operation );
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro T_InsertBOTransferOrder

  var contextID = null;
  var cmd = RsdCommand( "update drtdocument_dbt set t_ExportState = 2, t_PaymentID = ? where t_DocumentID = ?" );
  var cmdGetDirect = RsdCommand( "select * from drtdocument_dbt where t_DocumentID = ? for update" );
  var rsGetDirect;

  statInsert = 0;

  if ( statInsert == 0 )
    cmdGetDirect.addParam( "p_DocumentID", RSDBP_IN, rtdocument.rec.DocumentID );
    cmdGetDirect.execute( );
    rsGetDirect = RsdRecordset( cmdGetDirect );
    if ( rsGetDirect.MoveNext( ) )
       if ( Int( rsGetDirect.value( "t_ExportState" ) ) == 2 )
         statInsert = -21071;
       end;
    end;
  end;

  if ( statInsert == 0 )
    if ( signKindMemOrder )
      contextID = ContextRetailESign;
    end;

    statInsert = InsertBOTransferOrder( TransferOrder, 0, 0, false, contextID, null );
  end;

  if ( statInsert == 0 )
    cmd.addParam( "p_PaymentID", RSDBP_IN, String( TransferOrder.ID_Operation ) );
    cmd.addParam( "p_DocumentID", RSDBP_IN, rtdocument.rec.DocumentID );

    cmd.execute( );
  end;

  if ( ( statInsert == 0 ) and ( postActionTypeInsert > 0 ) )
    statInsert = perfomPostActionsForDocInTrn( postActionTypeInsert );
  end;
  
  if ( statInsert != 0 )
    AbortTrn( );
  else
    rtdocument.rec.ExportState = 2;
    rtdocument.rec.PaymentID = String( TransferOrder.ID_Operation );
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro T_InsertBOMassRegim

  var cmd;
  var cmdGetDirect;
  var rsGetDirect;
  var stat = 0;
  var i = 0;

  // ---------------------------------------------------------------------
  if ( stat == 0 )

    i = 0;
    while ( i < retDocsResult.Size )
      cmdGetDirect = RsdCommand( "select * from drtdocument_dbt where t_DocumentID = ? for update" );

      cmdGetDirect.addParam( "p_DocumentID", RSDBP_IN, retDocsResult[i].AccDocID );
      cmdGetDirect.execute( );
      rsGetDirect = RsdRecordset( cmdGetDirect );
      if ( rsGetDirect.MoveNext( ) )
         if ( Int( rsGetDirect.value( "t_ExportState" ) ) == 2 )
           stat = -21071;
           break;
         end;
      end;

      i = i + 1;
    end;
  end;

  // ---------------------------------------------------------------------
  if ( stat == 0 )
    stat = retDocsBatch.TransferToBase( true );
  end;

  // ---------------------------------------------------------------------
  if ( stat == 0 )

    i = 0;
    while ( i < retDocsResult.Size )

      if ( ( retDocsResult[i].ResultCode == UNLOAD_ERROR ) or ( retDocsResult[i].ResultCode == CHECK_ERROR ) )
        ;
      else
        cmd = RsdCommand( "update drtdocument_dbt set t_ExportState = 2, t_PaymentID = ? where t_DocumentID = ?" );

        cmd.addParam( "p_PaymentID", RSDBP_IN, String( retDocsResult[i].paymentID ) );
        cmd.addParam( "p_DocumentID", RSDBP_IN, Int( retDocsResult[i].AccDocID ) );

        cmd.execute( );
      end;

      i = i + 1;
    end;
  else

    i = 0;
    while ( i < retDocsResult.Size )
      if ( ( retDocsResult[i].ResultCode == UNLOAD_ERROR ) or ( retDocsResult[i].ResultCode == CHECK_ERROR ) )
        ;
      else
        retDocsResult[i].ResultCode = UNLOAD_ERROR;
        retDocsResult[i].errorCode = 9999;
        retDocsResult[i].errorMessage = "Žè¨¡ª  ¯à¨ ¯¥à¥­®á¥ ¤ ­­ëå ¨§ Œ‡";
      end;

      i = i + 1;
    end;
  end;

  if ( stat == 0 )
    i = 0;
    while ( i < retDocsResult.Size )
      if ( ( retDocsResult[i].ResultCode == UNLOAD_ERROR ) or ( retDocsResult[i].ResultCode == CHECK_ERROR ) )
        ;
      else
        retDocsResult[i].ResultCode = UNLOAD_OK;
        retDocsResult[i].errorCode = 0;
        retDocsResult[i].errorMessage = "";
      end;

      i = i + 1;
    end;
  end;

  if ( stat != 0 )
    AbortTrn( );
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro IsDocForInsertBO

  var isDoc = false;
  var i = 0;

  while ( i < retDocsResult.Size )
    if ( ( retDocsResult[i].ResultCode == UNLOAD_ERROR ) or ( retDocsResult[i].ResultCode == CHECK_ERROR ) )
      ;
    else
      isDoc = true;
      break;
    end;

    i = i + 1;
  end;

  return isDoc;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro ExportAccDocs( aRefDocs, identProg, autoLoad, needBatchMode )

  var aRefDocsWithError = TArray;
  var retDocResult;
  var contextID = NULL;
  var i = 0;
  var baseDocType = 0;
  var postActionType = 0;
  var stat = 0;

  retDocsResult = TArray;

  if ( ValType( aRefDocs ) != V_GENOBJ )
    return retDocsResult;
  end;

  if ( ValType( batchDocCount ) != V_INTEGER )
    batchDocCount = 20;
  end;
  if ( batchDocCount == 0 )
    batchDocCount = 20;
  end;

  if ( firstCallExportFunction )
    firstCallExportFunction = false;

    if ( aRefDocs.Size == 1 )
      massRegim = 0;
    end;
  end;
  if ( not needBatchMode )
    massRegim = 0;
  end;

  if ( ( massRegim > 0 ) and ( aRefDocs.Size > 0 ) )
    retDocsBatch = null;
    retDocsBatch = BatchMode( batchDocCount );
  end;

  while ( i < aRefDocs.Size )

    InitError( );

    if ( ( massRegim > 0 ) and ( aRefDocsWithError.Size > i ) )
      if ( ( aRefDocsWithError[i].ResultCode == UNLOAD_ERROR ) or ( aRefDocsWithError[i].ResultCode == CHECK_ERROR ) )
        retDocResult = UnloadAccDocResult;
        retDocResult.AccDocID = aRefDocs( i );
        retDocResult.ResultCode = aRefDocsWithError[i].ResultCode;
        retDocResult.errorCode = aRefDocsWithError[i].errorCode;
        retDocResult.errorMessage = aRefDocsWithError[i].errorMessage;

        retDocsResult[ retDocsResult.Size ] = retDocResult;
        i = i + 1;
        continue;
      end;
    end;

    retDocResult = UnloadAccDocResult;
    retDocResult.AccDocID = aRefDocs( i );
    retDocResult.ResultCode = -1;
    retDocResult.errorCode = 0;
    retDocResult.errorMessage = "";
    retDocResult.paymentID = "";

    postActionType = 0;
    stat = 0;

    rtdocument.Clear( );
    rtdocument.KeyNum = 0;

    rtdocument.rec.DocumentID = Int( aRefDocs( i ) );

    if ( rtdocument.GetEQ( ) )
      //#219795
      if (rtdocument.rec.DebitAccount == rtdocument.rec.CreditAccount)
        retDocResult.ResultCode=CHECK_ERROR;
        retDocResult.errorCode=stat=6020;  //‘ç¥â  ¤¥¡¥â  ¨ ªà¥¤¨â  á®¢¯ ¤ îâ
        retDocResult.errorMessage=DefErrorText(stat,false);
      else
        if ( rtdocument.rec.Direction == 1 )
          stat = UnLoadIncomingDocToBB( rtdocument );
          if ( stat != 0 )
            retDocResult.ResultCode = UNLOAD_ERROR;
            retDocResult.errorCode = stat;
            retDocResult.errorMessage = DefErrorText( stat, false );
          else
            retDocResult.ResultCode = UNLOAD_OK;
            //retDocResult.paymentID = String( CashOrder.ID_Operation ); // ??
          end;

        else

          baseDocType = DefRDDBaseDocType( rtdocument.rec.DocTypeID );

          // -------------------------------------------------------------------
          if ( ( baseDocType == RDD_CASH_IN  ) or  // à¨å®¤­ë© ª áá®¢ë© ®à¤¥à
               ( baseDocType == RDD_CASH_OUT )   ) //  áå®¤­ë© ª áá®¢ë© ®à¤¥à

            CashOrder = BOCashOrderParm;

            stat = InitCashOrderToBB( postActionType );

            if ( stat == OK_RES )
              postActionTypeInsert = postActionType;

              if ( massRegim > 0 )
                if ( signKindCashDoc )
                  contextID = ContextRetailESign;
                else
                  contextID = null;
                end;

                statInsert = InsertBOCashOrder( CashOrder, 0, 0, false, contextID, null );

                if ( statInsert != 0  )
                  retDocResult.ResultCode = UNLOAD_ERROR;
                  retDocResult.errorCode = statInsert;
                  retDocResult.errorMessage = DefErrorText( statInsert, false );
                else
                  retDocResult.paymentID = String( CashOrder.ID_Operation );
                end;
              else
                if ( not ProcessTrn( 0, "T_InsertBOCashOrder" ) )
                  retDocResult.ResultCode = UNLOAD_ERROR;
                  if ( statInsert == -21071 )
                    retDocResult.errorCode = -statInsert;
                    retDocResult.errorMessage = DefErrorText( -statInsert, true );
                  else
                    retDocResult.errorCode = statInsert;
                    retDocResult.errorMessage = DefErrorText( statInsert, false );
                  end;
                else
                  retDocResult.ResultCode = UNLOAD_OK;
                end;
              end;
            else
              retDocResult.ResultCode = CHECK_ERROR;
              retDocResult.errorCode = stat;
              retDocResult.errorMessage = DefErrorText( stat, true );
            end;

            CashOrder = null;
          // -------------------------------------------------------------------
          elif ( ( baseDocType == RDD_MEMORDER       ) or  // Œ¥¬®à¨ «ì­ë© ®à¤¥à
                 ( baseDocType == RDD_EXCHANGE_ORDER )   ) // à¨å®¤­®-à áå®¤­ë© ®à¤¥à ¤«ï ‚ŽŽ

            if ( isOneCurrRtDoc( rtdocument.rec.FoldSide ) )
              MemorialOrder = BOMemorialOrderParm;

              stat = InitMemorialOrderToBB( postActionType );

              if ( stat == OK_RES )
                postActionTypeInsert = postActionType;

                if ( massRegim > 0 )
                  if ( signKindMemOrder )
                    contextID = ContextRetailESign;
                  else
                    contextID = null;
                  end;

                  statInsert = InsertBOMemorialOrder( MemorialOrder, 0, 0, false, contextID, null );
                                    
                  if ( statInsert != 0  )
                    retDocResult.ResultCode = UNLOAD_ERROR;
                    retDocResult.errorCode = statInsert;
                    retDocResult.errorMessage = DefErrorText( statInsert, false );
                  else
                    retDocResult.paymentID = String( MemorialOrder.ID_Operation );
                  end;
                else
                  if ( not ProcessTrn( 0, "T_InsertBOMemorialOrder" ) )
                    retDocResult.ResultCode = UNLOAD_ERROR;
                    if ( statInsert == -21071 )
                      retDocResult.errorCode = -statInsert;
                      retDocResult.errorMessage = DefErrorText( -statInsert, true );
                    else
                      retDocResult.errorCode = statInsert;
                      retDocResult.errorMessage = DefErrorText( statInsert, false );
                    end;
                  else
                    retDocResult.ResultCode = UNLOAD_OK;
                  end;
                end;
              else
                retDocResult.ResultCode = CHECK_ERROR;
                retDocResult.errorCode = stat;
                retDocResult.errorMessage = DefErrorText( stat, true );
              end;

              MemorialOrder = null;
            else
              MultyDoc = BOMultyDocParm;

              stat = InitMultiCurMemOrderToBB( postActionType );

              if ( stat == OK_RES )
                postActionTypeInsert = postActionType;

                if ( massRegim > 0 )
                  if ( signKindMultiDoc )
                    contextID = ContextRetailESign;
                  else
                    contextID = null;
                  end;

                  statInsert = InsertBOMultyDoc( MultyDoc, 0, 0, false, contextID, null );

                  if ( statInsert != 0  )
                    retDocResult.ResultCode = UNLOAD_ERROR;
                    retDocResult.errorCode = statInsert;
                    retDocResult.errorMessage = DefErrorText( statInsert, false );
                  else
                    retDocResult.paymentID = String( MultyDoc.ID_Operation );
                  end;
                else
                  if ( not ProcessTrn( 0, "T_InsertBOMultyDoc" ) )
                    retDocResult.ResultCode = UNLOAD_ERROR;
                    if ( statInsert == -21071 )
                      retDocResult.errorCode = -statInsert;
                      retDocResult.errorMessage = DefErrorText( -statInsert, true );
                    else
                      retDocResult.errorCode = statInsert;
                      retDocResult.errorMessage = DefErrorText( statInsert, false );
                    end;
                  else
                    retDocResult.ResultCode = UNLOAD_OK;
                  end;
                end;
              else
                retDocResult.ResultCode = CHECK_ERROR;
                retDocResult.errorCode = stat;
                retDocResult.errorMessage = DefErrorText( stat, true );
              end;

              MultyDoc = null;
            end;
          // -------------------------------------------------------------------
          elif ( baseDocType == RDD_BANKORDER ) //  ­ª®¢áª¨© ®à¤¥à

            BankOrder = BOBankOrderParm;

            stat = InitBankOrderToBB( postActionType );

            if ( stat == OK_RES )
              postActionTypeInsert = postActionType;

              if ( massRegim > 0 )
                if ( signKindMemOrder )
                  contextID = ContextRetailESign;
                else
                  contextID = null;
                end;

                statInsert = InsertBOBankOrder( BankOrder, 0, 0, false, contextID, null );

                if ( statInsert != 0  )
                  retDocResult.ResultCode = UNLOAD_ERROR;
                  retDocResult.errorCode = statInsert;
                  retDocResult.errorMessage = DefErrorText( statInsert, false );
                else
                  retDocResult.paymentID = String( BankOrder.ID_Operation );
                end;
              else
                if ( not ProcessTrn( 0, "T_InsertBOBankOrder" ) )
                  retDocResult.ResultCode = UNLOAD_ERROR;
                  if ( statInsert == -21071 )
                    retDocResult.errorCode = -statInsert;
                    retDocResult.errorMessage = DefErrorText( -statInsert, true );
                  else
                    retDocResult.errorCode = statInsert;
                    retDocResult.errorMessage = DefErrorText( statInsert, false );
                  end;
                else
                  retDocResult.ResultCode = UNLOAD_OK;
                end;
              end;
            else
              retDocResult.ResultCode = CHECK_ERROR;
              retDocResult.errorCode = stat;
              retDocResult.errorMessage = DefErrorText( stat, true );
            end;

            BankOrder = null;
          // -------------------------------------------------------------------
          elif ( baseDocType == RDD_PAYMENT_ORDER ) // « â¥¦­®¥ ¯®àãç¥­¨¥
            if ( ( rtdocument.rec.DebitCurrCode > 0 ) or ( not isOneCurrRtDoc( rtdocument.rec.FoldSide ) ) )
              retDocResult.ResultCode = CHECK_ERROR;
              retDocResult.errorCode = 5787; // « â¥¦­®¥ ¯®àãç¥­¨¥ ¤®«¦­® ¡ëâì ¢ ­ æ¨®­ «ì­®© ¢ «îâ¥
              retDocResult.errorMessage = DefErrorText( 5787, true );
            else

              BankPayment = BOBankPaymentParm;

              stat = InitPaymentOrderToBB( postActionType );

              if ( stat == OK_RES )
                postActionTypeInsert = postActionType;

                if ( massRegim > 0 )
                  if ( signKindExternPay )
                    contextID = ContextRetailESign;
                  else
                    contextID = null;
                  end;

                  statInsert = InsertBOBankPayment( BankPayment, 0, 0, false, contextID, null );

                  if ( statInsert != 0  )
                    retDocResult.ResultCode = UNLOAD_ERROR;
                    retDocResult.errorCode = statInsert;
                    retDocResult.errorMessage = DefErrorText( statInsert, false );
                  else
                    retDocResult.paymentID = String( BankPayment.ID_Operation );
                  end;
                else
                  if ( not ProcessTrn( 0, "T_InsertBOBankPayment" ) )
                    retDocResult.ResultCode = UNLOAD_ERROR;
                    if ( statInsert == -21071 )
                      retDocResult.errorCode = -statInsert;
                      retDocResult.errorMessage = DefErrorText( -statInsert, true );
                    else
                      retDocResult.errorCode = statInsert;
                      retDocResult.errorMessage = DefErrorText( statInsert, false );
                    end;
                  else
                    retDocResult.ResultCode = UNLOAD_OK;
                  end;
                end;
              else
                retDocResult.ResultCode = CHECK_ERROR;
                retDocResult.errorCode = stat;
                retDocResult.errorMessage = DefErrorText( stat, true );
              end;

              BankPayment = null;
            end;
          // -------------------------------------------------------------------
          elif ( baseDocType == RDD_INCASS_ORDER ) // ˆ­ª áá®¢®¥ ¯®àãç¥­¨¥
            retDocResult.ResultCode = CHECK_ERROR;
            retDocResult.errorCode = 5782;
            retDocResult.errorMessage = DefErrorText( 5782, true );
          // -------------------------------------------------------------------
          elif ( baseDocType == RDD_CUR_TRANSFER ) // ‚ «îâ­ë© ¯¥à¥¢®¤
            CurrencyPayment = BOCurrencyPaymentParm;
     
            stat = InitCurrTransferToBB( postActionType );
     
            if ( stat == OK_RES )
              postActionTypeInsert = postActionType;
     
              if ( massRegim > 0 )
                if ( signKindExternPay )
                  contextID = ContextRetailESign;
                else
                  contextID = null;
                end;
     
                statInsert = InsertBOCurrencyPayment( CurrencyPayment, 0, 0, false, contextID, null );
     
                if ( statInsert != 0  )
                  retDocResult.ResultCode = UNLOAD_ERROR;
                  retDocResult.errorCode = statInsert;
                  retDocResult.errorMessage = DefErrorText( statInsert, false );
                else
                  retDocResult.paymentID = String( CurrencyPayment.ID_Operation );
                end;
              else
                if ( not ProcessTrn( 0, "T_InsertBOCurrencyPayment" ) )
                  retDocResult.ResultCode = UNLOAD_ERROR;
                  if ( statInsert == -21071 )
                    retDocResult.errorCode = -statInsert;
                    retDocResult.errorMessage = DefErrorText( -statInsert, true );
                  else
                    retDocResult.errorCode = statInsert;
                    retDocResult.errorMessage = DefErrorText( statInsert, false );
                  end;
                else
                  retDocResult.ResultCode = UNLOAD_OK;
                end;
              end;
            else
              retDocResult.ResultCode = CHECK_ERROR;
              retDocResult.errorCode = stat;
              retDocResult.errorMessage = DefErrorText( stat, true );
            end;
     
            CurrencyPayment = null;
          // -------------------------------------------------------------------
          elif ( baseDocType == RDD_VALUE_ORDER ) // Žà¤¥à ¯® ¯¥à¥¤ ç¥ æ¥­­®áâ¥©
            if ( rtdocument.rec.FoldSide != FOLDSIDE_NONE )
              retDocResult.ResultCode = CHECK_ERROR;
              retDocResult.errorCode = 5789; // ‚ë£àã§ª  ¬­®£®áâà®ç­®£® ®à¤¥à  ¯® ¯¥à¥¤ ç¥ æ¥­­®áâ¥© ­¥ ¯®¤¤¥à¦¨¢ ¥âáï
              retDocResult.errorMessage = DefErrorText( 5789, true );
            else

              TransferOrder = BOTransferOrderParm;

              stat = InitTransferOrderToBB( postActionType );

              if ( stat == OK_RES )
                postActionTypeInsert = postActionType;

                if ( massRegim > 0 )
                  if ( signKindMemOrder )
                    contextID = ContextRetailESign;
                  else
                    contextID = null;
                  end;

                  statInsert = InsertBOTransferOrder( TransferOrder, 0, 0, false, contextID, null );

                  if ( statInsert != 0  )
                    retDocResult.ResultCode = UNLOAD_ERROR;
                    retDocResult.errorCode = statInsert;
                    retDocResult.errorMessage = DefErrorText( statInsert, false );
                  else
                    retDocResult.paymentID = String( TransferOrder.ID_Operation );
                  end;
                else
                  if ( not ProcessTrn( 0, "T_InsertBOTransferOrder" ) )
                    retDocResult.ResultCode = UNLOAD_ERROR;
                    if ( statInsert == -21071 )
                      retDocResult.errorCode = -statInsert;
                      retDocResult.errorMessage = DefErrorText( -statInsert, true );
                    else
                      retDocResult.errorCode = statInsert;
                      retDocResult.errorMessage = DefErrorText( statInsert, false );
                    end;
                  else
                    retDocResult.ResultCode = UNLOAD_OK;
                  end;
                end;
              else
                retDocResult.ResultCode = CHECK_ERROR;
                retDocResult.errorCode = stat;
                retDocResult.errorMessage = DefErrorText( stat, true );
              end;

              TransferOrder = null;
            end;
          else
            ;
          end;
        end;
      end;

      // €¢â®¬ â¨ç¥áª®¥ ¢ë¯®«­¥­¨¥ ®¯¥à æ¨©
      if ( massRegim > 0 )
        ;
      elif ( ( retDocResult.ResultCode == UNLOAD_OK ) and isAutoExec )        
        InitError( );

        oproper.Clear( );
        oproper.KeyNum = 0;

        oproper.rec.ID_Operation = Int( rtdocument.rec.PaymentID );

        if ( oproper.GetEQ )

          if ( ( oproper.rec.DocKind == DLDOC_BANKPAYMENT   ) or
               ( oproper.rec.DocKind == DLDOC_BANKCLAIM     ) or
               ( oproper.rec.DocKind == DLDOC_MEMORIALORDER ) or
               ( oproper.rec.DocKind == PS_CPORDER          ) or
               ( oproper.rec.DocKind == BBANK_CPORDER       ) or
               ( oproper.rec.DocKind == DLDOC_BANKORDER     ) or
               ( oproper.rec.DocKind == DLDOC_VALTRORDER    ) or
               ( oproper.rec.DocKind == CASH_BOF_ADDORDER   ) or
               ( oproper.rec.DocKind == CASH_BOF_INCORDER   ) or
               ( oproper.rec.DocKind == CASH_BOF_OUTORDER   ) or
               ( oproper.rec.DocKind == CB_MULTYDOC         )   )

            if ( not PM_ExecuteOperation( Int( oproper.rec.DocumentID ), oproper.rec.DocKind ) )
              ;
            end;
          end;
        end;
      end;      
    else
      retDocResult.ResultCode = CHECK_ERROR;
      retDocResult.errorCode = 0;
      retDocResult.errorMessage = "¥ ­ ©¤¥­ „„ ¯® ¥£® ¨¤¥­â¨ä¨ª â®àã";
    end;

    retDocsResult[ retDocsResult.Size ] = retDocResult;

    if ( ( massRegim > 0 ) and ( retDocResult.ResultCode == UNLOAD_ERROR ) )
      aRefDocsWithError = retDocsResult;
      retDocsResult = TArray;
      retDocsBatch = null;
      retDocsBatch = BatchMode( batchDocCount );
      i = 0;
    else
      i = i + 1;
    end;

    InitError( );
  end;

  if ( ( massRegim > 0 ) and IsDocForInsertBO( ) )
    if ( not ProcessTrn( 0, "T_InsertBOMassRegim" ) )
      ;
    else
      if ( isAutoExec )

        if ( massRegim == 2 )
          stat = retDocsBatch.Run( );
        else
          retDocsBatch = null;

          i = 0;
          while ( i < retDocsResult.Size )
          
            oproper.Clear( );
            oproper.KeyNum = 0;

            oproper.rec.ID_Operation = Int( retDocsResult[i].paymentID );

            if ( oproper.GetEQ )

              if ( ( oproper.rec.DocKind == DLDOC_BANKPAYMENT   ) or
                   ( oproper.rec.DocKind == DLDOC_BANKCLAIM     ) or
                   ( oproper.rec.DocKind == DLDOC_MEMORIALORDER ) or
                   ( oproper.rec.DocKind == PS_CPORDER          ) or
                   ( oproper.rec.DocKind == BBANK_CPORDER       ) or
                   ( oproper.rec.DocKind == DLDOC_BANKORDER     ) or
                   ( oproper.rec.DocKind == DLDOC_VALTRORDER    ) or
                   ( oproper.rec.DocKind == CASH_BOF_ADDORDER   ) or
                   ( oproper.rec.DocKind == CASH_BOF_INCORDER   ) or
                   ( oproper.rec.DocKind == CASH_BOF_OUTORDER   ) or
                   ( oproper.rec.DocKind == CB_MULTYDOC         )   )

                if ( not PM_ExecuteOperation( Int( oproper.rec.DocumentID ), oproper.rec.DocKind ) )
                  ;
                end;
              end;
            end;

            i = i + 1;
          end;
        end;
      end;
    end;
  end;

  InitError( );

  retDocsBatch = null;

  return retDocsResult;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro T_DeleteBOMemorialOrder

  var cmd = RsdCommand( "update drtdocument_dbt set t_ExportState = 0, t_PaymentID = chr( 1 ) where t_DocumentID = ? " );

  statDelete = DeleteBOMemorialOrder( Int( oproper.rec.DocumentID ) );

  if ( statDelete == 0 )
    cmd.addParam( "p_DocumentID", RSDBP_IN, rtdocument.rec.DocumentID );

    cmd.execute( );
  end;

  if ( statDelete != 0 )
    AbortTrn( );
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro T_DeleteBOBankPayment

  var cmd = RsdCommand( "update drtdocument_dbt set t_ExportState = 0, t_PaymentID = chr( 1 ) where t_DocumentID = ? " );

  statDelete = DeleteBOBankPayment( Int( oproper.rec.DocumentID ) );

  if ( statDelete == 0 )
    cmd.addParam( "p_DocumentID", RSDBP_IN, rtdocument.rec.DocumentID );

    cmd.execute( );
  end;

  if ( statDelete != 0 )
    AbortTrn( );
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro T_DeleteBOBankClaim

  var cmd = RsdCommand( "update drtdocument_dbt set t_ExportState = 0, t_PaymentID = chr( 1 ) where t_DocumentID = ? " );

  statDelete = DeleteBOBankClaim( Int( oproper.rec.DocumentID ) );

  if ( statDelete == 0 )
    cmd.addParam( "p_DocumentID", RSDBP_IN, rtdocument.rec.DocumentID );

    cmd.execute( );
  end;

  if ( statDelete != 0 )
    AbortTrn( );
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro T_DeleteBOBankOrder

  var cmd = RsdCommand( "update drtdocument_dbt set t_ExportState = 0, t_PaymentID = chr( 1 ) where t_DocumentID = ? " );

  statDelete = DeleteBOBankOrder( Int( oproper.rec.DocumentID ) );

  if ( statDelete == 0 )
    cmd.addParam( "p_DocumentID", RSDBP_IN, rtdocument.rec.DocumentID );

    cmd.execute( );
  end;

  if ( statDelete != 0 )
    AbortTrn( );
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro T_DeleteBOTransferOrder

  var cmd = RsdCommand( "update drtdocument_dbt set t_ExportState = 0, t_PaymentID = chr( 1 ) where t_DocumentID = ? " );

  statDelete = DeleteBOTransferOrder( Int( oproper.rec.DocumentID ) );

  if ( statDelete == 0 )
    cmd.addParam( "p_DocumentID", RSDBP_IN, rtdocument.rec.DocumentID );

    cmd.execute( );
  end;

  if ( statDelete != 0 )
    AbortTrn( );
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro T_DeleteBOCashOrder

  var cmd = RsdCommand( "update drtdocument_dbt set t_ExportState = 0, t_PaymentID = chr( 1 ) where t_DocumentID = ? " );

  statDelete = DeleteBOCashOrder( Int( oproper.rec.DocumentID ), oproper.rec.DocKind );

  if ( statDelete == 0 )
    cmd.addParam( "p_DocumentID", RSDBP_IN, rtdocument.rec.DocumentID );

    cmd.execute( );
  end;

  if ( statDelete != 0 )
    AbortTrn( );
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro T_DeleteBOMultyDoc

  var cmd = RsdCommand( "update drtdocument_dbt set t_ExportState = 0, t_PaymentID = chr( 1 ) where t_DocumentID = ? " );

  statDelete = DeleteBOMultyDoc( Int( oproper.rec.DocumentID ) );

  if ( statDelete == 0 )
    cmd.addParam( "p_DocumentID", RSDBP_IN, rtdocument.rec.DocumentID );

    cmd.execute( );
  end;

  if ( statDelete != 0 )
    AbortTrn( );
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro T_DeleteBOCurrencyPayment

  var cmd = RsdCommand( "update drtdocument_dbt set t_ExportState = 0, t_PaymentID = chr( 1 ) where t_DocumentID = ?" );

  statDelete = DeleteBOCurrencyPayment( Int( oproper.rec.DocumentID ), oproper.rec.DocKind );

  if ( statDelete == 0 )
    cmd.addParam( "p_DocumentID", RSDBP_IN, rtdocument.rec.DocumentID );

    cmd.execute( );
  end;

  if ( statDelete != 0 )
    AbortTrn( );
  end;
end;
    


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro T_DeleteBOBackoutOperation

  var cmd = RsdCommand( "update drtdocument_dbt set t_ExportState = 0, t_PaymentID = case t_direction when 0 then chr( 1 ) else t_PaymentID end where t_DocumentID = ? " );

  statDelete = BO_PMBackoutOperation( Int( rtdocument.rec.PaymentID ) );

  if ( statDelete == 0 )
    cmd.addParam( "p_DocumentID", RSDBP_IN, rtdocument.rec.DocumentID );

    cmd.execute( );
  end;

  if ( statDelete != 0 )
    AbortTrn( );
  end;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
private macro UpdateRDDUnload ( docID )

  var cmd = RsdCommand( "update drtdocument_dbt set t_ExportState = 0 where t_DocumentID = ?" );

  cmd.addParam( "p_DocumentID", RSDBP_IN, Int( docID ) );

  cmd.execute( );
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro RollBackAccDoc( accDocID, identProg )

  var baseDocType = 0;
  var retDocResult;
  var stat;
  var errMsg;

  retDocResult = UnloadAccDocResult;
  retDocResult.AccDocID = accDocID;
  retDocResult.ResultCode = ROLLBACK_ERROR;
  retDocResult.errorCode = 0;
  retDocResult.errorMessage = "";

  rtdocument.Clear( );
  rtdocument.KeyNum = 0;

  rtdocument.rec.DocumentID = Int( accDocID );

  if ( rtdocument.GetEQ( ) )

    baseDocType = DefRDDBaseDocType( rtdocument.rec.DocTypeID );

    if ( rtdocument.rec.PaymentID == "" )
      UpdateRDDUnload ( rtdocument.rec.DocumentID );

      retDocResult.ResultCode = ROLLBACK_OK;
    elif ( rtdocument.rec.Direction == 0 )

      InitError( );

      oproper.Clear( );
      oproper.KeyNum = 0;

      oproper.rec.ID_Operation = Int( rtdocument.rec.PaymentID );
                              
      if ( oproper.GetEQ )
        // ---------------------------------------------------------------
        if ( oproper.rec.DocKind == DLDOC_MEMORIALORDER )
          if ( not ProcessTrn( 0, "T_DeleteBOMemorialOrder" ) )
            retDocResult.errorCode = statDelete;

            retDocResult.errorMessage = DefErrorText( statDelete, false );
          else
            retDocResult.ResultCode = ROLLBACK_OK;
          end;
        // ---------------------------------------------------------------
        elif ( oproper.rec.DocKind == DLDOC_BANKPAYMENT )
          if ( not ProcessTrn( 0, "T_DeleteBOBankPayment" ) )
            retDocResult.errorCode = statDelete;

            retDocResult.errorMessage = DefErrorText( statDelete, false );
          else
            retDocResult.ResultCode = ROLLBACK_OK;
          end;
        // ---------------------------------------------------------------
        elif ( oproper.rec.DocKind == DLDOC_BANKCLAIM )
          if ( not ProcessTrn( 0, "T_DeleteBOBankClaim" ) )
            retDocResult.errorCode = statDelete;

            retDocResult.errorMessage = DefErrorText( statDelete, false );
          else
            retDocResult.ResultCode = ROLLBACK_OK;
          end;
        // ---------------------------------------------------------------
        elif ( oproper.rec.DocKind == DLDOC_BANKORDER )
          if ( not ProcessTrn( 0, "T_DeleteBOBankOrder" ) )
            retDocResult.errorCode = statDelete;

            retDocResult.errorMessage = DefErrorText( statDelete, false );
          else
            retDocResult.ResultCode = ROLLBACK_OK;
          end;
        // ---------------------------------------------------------------
        elif ( oproper.rec.DocKind == DLDOC_VALTRORDER )
          if ( not ProcessTrn( 0, "T_DeleteBOTransferOrder" ) )
            retDocResult.errorCode = statDelete;

            retDocResult.errorMessage = DefErrorText( statDelete, false );
          else
            retDocResult.ResultCode = ROLLBACK_OK;
          end;
        // ---------------------------------------------------------------
        elif ( ( oproper.rec.DocKind == CASH_BOF_INCORDER ) or
               ( oproper.rec.DocKind == CASH_BOF_OUTORDER ) or
               ( oproper.rec.DocKind == CASH_BOF_ADDORDER )   )
          if ( not ProcessTrn( 0, "T_DeleteBOCashOrder" ) )
            retDocResult.errorCode = statDelete;

            retDocResult.errorMessage = DefErrorText( statDelete, false );
          else
            retDocResult.ResultCode = ROLLBACK_OK;
          end;
        // ---------------------------------------------------------------
        elif ( oproper.rec.DocKind == CB_MULTYDOC )
          if ( not ProcessTrn( 0, "T_DeleteBOMultyDoc" ) )
            retDocResult.errorCode = statDelete;

            retDocResult.errorMessage = DefErrorText( statDelete, false );
          else
            retDocResult.ResultCode = ROLLBACK_OK;
          end;
        // ---------------------------------------------------------------
        elif ( ( oproper.rec.DocKind == BBANK_CPORDER ) or
               ( oproper.rec.DocKind == PS_CPORDER    )   )
          if ( not ProcessTrn( 0, "T_DeleteBOCurrencyPayment" ) )
            retDocResult.errorCode = statDelete;

            retDocResult.errorMessage = DefErrorText( statDelete, false );
          else
            retDocResult.ResultCode = ROLLBACK_OK;
          end;
        end;
      end;

      InitError( );
    else
      InitError( );

      if ( not ProcessTrn( 0, "T_DeleteBOBackoutOperation" ) )
        retDocResult.errorCode = statDelete;

        retDocResult.errorMessage = DefErrorText( statDelete, false );
      else
        retDocResult.ResultCode = ROLLBACK_OK;
      end;

      InitError( );
    end;
  else
    retDocResult.errorCode = 9999;
    retDocResult.errorMessage = "„®ªã¬¥­â ¢ ãå£ «â¥à¨¨ ¡ ­ª  ­¥ ­ ©¤¥­";
  end;

  return retDocResult;
end;