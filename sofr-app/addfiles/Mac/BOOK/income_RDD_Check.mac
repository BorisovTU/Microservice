/*
$Name:             income_RDD_Check.mac
$Module:           АРМ Бухгалтера
$Description:      Макрос проверки перед различными действиями с внешним РДД
*/

/*
Если потребуется использовать в макросе TClientList, то определять его только внутри конкретной функции
вот так: private var depclnt = TClientList;
И занулить в конце вот так: depclnt = null;
*/
import DeprIntr, rsd;


private var depositr = TBFile( "depositr.dbt", "r", 7 );


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro DepAcc_Check_onF2 ( docId )
  var stat = 0;
  var cmd, rs, cmdAccount;

  cmd = RsdCommand(
     "select depos.t_open_close, " +
            "depos.t_svodaccount, " +
            "doc.t_receivername receivername, " +
            "doc.t_receiveraccount receiveraccount, " +
            "doc.t_ground ground, " +
            "pers.t_name1 || ' ' || pers.t_name2 || ' ' || pers.t_name3 clientname, " +
            "nvl (instr (doc.t_ground, pers.t_name1 || ' ' || pers.t_name2 || ' ' || pers.t_name3), 0) findinground, " +
            "nvl (instr (doc.t_receivername, pers.t_name1 || ' ' || pers.t_name2 || ' ' || pers.t_name3), 0) findinreceivername " +
       "from drtdocument_dbt doc, ddepositr_dbt depos, dpersn_dbt pers " +
      "where doc.t_documentid = ? " +
        "and depos.t_fncash = doc.t_branch " +
        "and depos.t_account = doc.t_receiveraccount " +
        "and pers.t_personid(+) = depos.t_codclient");
  cmd.addParam( "docId", RSDBP_IN, docId );
  cmd.execute();

  rs = RsdRecordset(cmd);
  rs.NullConversion = true;

  if ( rs.moveNext() )
    if ((rs.value("findinground") == 0) and (rs.value("findinreceivername") == 0))
      if ( not GetTrue( false, "Указанный в документе получатель не совпадает с владельцем счета.|Наименование получателя: " + rs.value("receivername") + ".|Основание документа: " + rs.value("ground") + ".| Владелец счета: " + rs.value("clientname") + ".|Вы хотите выполнить процедуру с этой ошибкой?" ) )
        MsgBox( "Указанный в документе получатель не совпадает с владельцем счета" );
        stat = -36;
      end;
    end;
    if ( stat == 0 )
      if ( rs.value("t_open_close") != "" )

        cmdAccount = RsdCommand( "select 1 from ddepositr_dbt where t_SvodAccount = ? and t_Open_Close = chr( 0 )" );
        cmdAccount.addParam( "svodAccount", RSDBP_IN, depositr.rec.SvodAccount );
        cmdAccount.execute( );

        var rsAccount = RsdRecordset( cmdAccount );
        rsAccount.NullConversion = true;

        if ( rsAccount.moveNext( ) )
          ;
        else
          MsgBox( "Указанный в документе счет получателя закрыт" );
          stat = -38;
        end;
      end;
    end;
  else
    MsgBox( "Указанный в документе счет получателя не найден" );
    stat = -37;
  end;
  return stat;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro DepAcc_Check_onAltF2 ( docId )

  ;

  return 0;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro MoneyOrder_Check_onF2 ( docId )

  ;

  return 0;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro MoneyOrder_Check_onAltF2 ( docId )

  ;

  return 0;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro DepTRN_Check_onF2 ( docId )

  ;

  return 0;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro DepTRN_Check_onAltF2 ( docId )

  ;

  return 0;
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro DepTRN_Check_onF5 ( docId )

  ;

  return 0;
end;
