import DeprIntr, rsd;

var saveCurrency=-1;
var deltaSum1ByCur=$0l;
var deltaSum2ByCur=$0l;
var deltaSum3ByCur=$0l;
var deltaSum4ByCur=$0l;
var deltaSum1R=$0l;
var deltaSum2R=$0l;
var deltaSum3R=$0l;
var deltaSum4R=$0l;
var deltaSum1ByCurR=$0l;
var deltaSum2ByCurR=$0l;
var deltaSum3ByCurR=$0l;
var deltaSum4ByCurR=$0l;

var dateReport:date;

macro IsExistsBalAccount(CodeCur:integer, Account:string )
   var rs;

   if ( CodeCur==0 )
      rs = RsdRecordset(String("select 1 from dual where exists(select 1 from daccount_dbt where t_chapter=1 and t_account='",Account,"')"));
   else
      rs = RsdRecordset(String("select 1 from dual where exists(select 1 from daccount$_dbt where t_chapter=1 ",
                              " and t_code_currency=(select fininstr.t_FIID from dcurrency_dbt currency, dfininstr_dbt fininstr where currency.t_Code_Currency=",CodeCur,
                                                    " AND fininstr.t_FI_Code IN (Decode(currency.t_IsMetal, 'X', 'A'||currency.t_ExternalCode, currency.t_ExternalCode), ",
                                                                               " Decode(currency.t_IsMetal, 'X', 'А'||currency.t_ExternalCode, currency.t_ExternalCode))) ",
                              " and t_account='",Account,"')"));
   end;
   if ( not rs.moveNext() )
      return false;
   else
      return true;
   end;
end;

macro GetNameCurrency(CodeCur:integer)
   var rs = RsdRecordset("select t_name_currency from dcurrency_dbt where t_code_currency="+CodeCur);
   if ( not rs.moveNext() )
      return "???";
   else
      return rs.value(0);
   end;
end;

macro ConvertSumInRub(CodeCur:integer, sum:moneyl)
   var rs;
   var dd, mm, yyyy;

   datesplit( dateReport, dd, mm, yyyy );

   rs = RsdRecordset(String("select RSU_RTLEXCH.ConvertSumToRub(sb_actyp.t_CodCur, sb_actyp.t_fncash, ",
                                "TO_DATE('",dd:2," ",mm:2," ",yyyy:4,"','DD MM YYYY'), TO_DATE('01 01 0001 00:00:00','DD MM YYYY HH24:MI:SS'), 1, ",sum,
                                ", 1) from dsb_actyp_dbt sb_actyp where sb_actyp.t_CodAccount=0 AND sb_actyp.t_CodCur=",CodeCur," AND rownum=1 order by sb_actyp.t_fncash") );
   rs.moveNext();
   return moneyl(rs.value(0));
end;

macro InSkoba(Sum:moneyl)
   return string("(",Sum,")");
end;

macro PrintHeader(dtReport:date)
  UpdateStatistics( true );
  dateReport = dtReport;
  [ ];
  [         Протокол сверки оборотов по балансовым счетам вкладов с лицевыми счетами вкладчиков от #](dateReport);
  [  +-------------------------+--------------------+--------------------+---------------------+----------------------+];
  [  |  Номер счета в балансе  |  Входящий остаток  |        Дебет       |        Кредит       |  Исходящий остаток   |];
  [  +-------------------------+--------------------+--------------------+---------------------+----------------------+];
end;

macro PrintLine(CodeCur:integer, Account:string, InRest:moneyl,  InRestRub:moneyl,  BalInRest:moneyl,  BalInRestRub:moneyl,
                                                DebRest:moneyl,  DebRestRub:moneyl,  BalDebRest:moneyl,  BalDebRestRub:moneyl,
                                                CredRest:moneyl, CredRestRub:moneyl, BalCredRest:moneyl, BalCredRestRub:moneyl,
                                                OutRest:moneyl, OutRestRub:moneyl, BalOutRest:moneyl, BalOutRestRub:moneyl)
  var AccIsExists = IsExistsBalAccount(CodeCur, Account);
  if ( (saveCurrency==-1) or (saveCurrency!=CodeCur) )
     if ( saveCurrency!=-1 ) 

        [  |  Расхождение по валюте  |################### |################### |#################### | ###################  |](deltaSum1ByCur:l,deltaSum2ByCur:l,deltaSum3ByCur:l,deltaSum4ByCur:l);
        if (saveCurrency!=0)
          [  |  (в рублях)             |####################|####################|#####################|##################### |](InSkoba(deltaSum1ByCurR):l,InSkoba(deltaSum2ByCurR):l,InSkoba(deltaSum3ByCurR):l,InSkoba(deltaSum4ByCurR):l);
        end;
        [  +-------------------------+--------------------+--------------------+---------------------+----------------------+];
     end;
     [  |                                                                                                                |];
     [  |  ##########################################################################################################    |](GetNameCurrency(CodeCur):c);
     [  | +-----------------------+--------------------+--------------------+---------------------+--------------------+ |];
     saveCurrency = CodeCur;
     deltaSum1ByCur = $0l;
     deltaSum2ByCur = $0l;
     deltaSum3ByCur = $0l;
     deltaSum4ByCur = $0l;
     deltaSum1ByCurR = $0l;
     deltaSum2ByCurR = $0l;
     deltaSum3ByCurR = $0l;
     deltaSum4ByCurR = $0l;
  end;
  [  | | ######################|                    |                    |                     |                    | |](Acc_Form(Account):l);
  if ( AccIsExists )
     [  | | В балансе             |################### |################### |#################### |################### | |](BalInRest:l,BalDebRest:l,BalCredRest:l,BalOutRest:l);
     if (saveCurrency!=0)
       [  | | (в рублях)            |####################|####################|#####################|####################| |](InSkoba(BalInRestRub):l,InSkoba(BalDebRestRub):l,InSkoba(BalCredRestRub):l,InSkoba(BalOutRestRub):l);
     end;
  else
     [  | | В балансе             |счет не найден      |счет не найден      |счет не найден       |счет не найден      | |];
  end;
  [  | | В аналитике           |################### |################### |#################### |################### | |](InRest:l,DebRest:l,CredRest:l,OutRest:l);
  if (saveCurrency!=0)
    [  | | (в рублях)            |####################|####################|#####################|####################| |](InSkoba(InRestRub):l,InSkoba(DebRestRub):l,InSkoba(CredRestRub):l,InSkoba(OutRestRub):l);
  end;
  if ( AccIsExists )
     [  | | Расхождение           |################### |################### |#################### |################### | |](abs(InRest-BalInRest):l,abs(DebRest-BalDebRest):l,abs(CredRest-BalCredRest):l,abs(OutRest-BalOutRest):l);
     if (saveCurrency!=0)
       [  | | (в рублях)            |####################|####################|#####################|####################| |](InSkoba(abs(InRestRub-BalInRestRub)):l,InSkoba(abs(DebRestRub-BalDebRestRub)):l,InSkoba(abs(CredRestRub-BalCredRestRub)):l,InSkoba(abs(OutRestRub-BalOutRestRub)):l);
     end;
  else
     [  | | Расхождение           |        ---         |        ---         |        ---          |        ---         | |];
  end;
  [  | +-----------------------+--------------------+--------------------+---------------------+--------------------+ |];
  if ( AccIsExists )
     deltaSum1ByCur = deltaSum1ByCur + abs(InRest-BalInRest);
     deltaSum2ByCur = deltaSum2ByCur + abs(DebRest-BalDebRest);
     deltaSum3ByCur = deltaSum3ByCur + abs(CredRest-BalCredRest);
     deltaSum4ByCur = deltaSum4ByCur + abs(OutRest-BalOutRest);
     deltaSum1ByCurR = deltaSum1ByCurR + abs(InRestRub-BalInRestRub);
     deltaSum2ByCurR = deltaSum2ByCurR + abs(DebRestRub-BalDebRestRub);
     deltaSum3ByCurR = deltaSum3ByCurR + abs(CredRestRub-BalCredRestRub);
     deltaSum4ByCurR = deltaSum4ByCurR + abs(OutRestRub-BalOutRestRub);

     deltaSum1R = deltaSum1R + abs(InRestRub-BalInRestRub);
     deltaSum2R = deltaSum2R + abs(DebRestRub-BalDebRestRub);
     deltaSum3R = deltaSum3R + abs(CredRestRub-BalCredRestRub);
     deltaSum4R = deltaSum4R + abs(OutRestRub-BalOutRestRub);
  end;
end;

macro PrintFloor()
  [  | Расхождение по валюте   |################### |################### |#################### | ###################  |](deltaSum1ByCur:l,deltaSum2ByCur:l,deltaSum3ByCur:l,deltaSum4ByCur:l);
  if (saveCurrency!=0)
    [  | (в рублях)              |####################|####################|#####################|##################### |](InSkoba(deltaSum1ByCurR):l,InSkoba(deltaSum2ByCurR):l,InSkoba(deltaSum3ByCurR):l,InSkoba(deltaSum4ByCurR):l);
  end;
  [  +-------------------------+--------------------+--------------------+---------------------+----------------------+];
  [  | Итого расходение (руб.) |################### |################### |#################### | ###################  |](deltaSum1R:l,deltaSum2R:l,deltaSum3R:l,deltaSum4R:l);
  [  +-------------------------+--------------------+--------------------+---------------------+----------------------+];
end;