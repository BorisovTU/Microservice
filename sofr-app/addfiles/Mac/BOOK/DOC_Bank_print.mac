//----------------------------------------------------------------------------
//                       Å†≠™Æ¢·™®© Æ‡§•‡ ‰.0401067
//----------------------------------------------------------------------------

import order_const, rsd, ErrHandler;

// å†™·®¨†´Ï≠Æ• ™Æ´®Á•·‚¢Æ ·‚‡Æ™ ≠† ´®·‚•
private const MaxNumString = 60;


private const HeaderLength = 16;
private const FooterLength = 11;
private const AccountLength = 2;

private var {curdate},
            {CNum};

private file curr( "currency.dbt" ) key 0;


//--------------------------------------------------------------------------
private macro DateToStr( pDate )
  var d, m, y, Day, Month, Year;

  DateSplit( pDate, d, m, y );
  Day = String( d );

  if   (m ==  1) Month = " Ô≠¢†‡Ô ";
  elif (m ==  2) Month = " ‰•¢‡†´Ô ";
  elif (m ==  3) Month = " ¨†‡‚† ";
  elif (m ==  4) Month = " †Ø‡•´Ô ";
  elif (m ==  5) Month = " ¨†Ô ";
  elif (m ==  6) Month = " ®Ó≠Ô ";
  elif (m ==  7) Month = " ®Ó´Ô ";
  elif (m ==  8) Month = " †¢£„·‚† ";
  elif (m ==  9) Month = " ·•≠‚Ô°‡Ô ";
  elif (m == 10) Month = " Æ™‚Ô°‡Ô ";
  elif (m == 11) Month = " ≠ÆÔ°‡Ô ";
  elif (m == 12) Month = " §•™†°‡Ô ";
  else           Month = "  ";
  end;

  Year = String(y);

  return Day + Month + Year + " £.";
end;


//--------------------------------------------------------------------------
private macro MoneyToStr(sum)
  var str = string(sum:f );
  var isDigit = true;
  var stat = 0;
  
  GetRegistryValue("COMMON\\èÖóÄíú\\éêÑÖê\\ÑêéÅçÄü_óÄëíú_ñàîêÄåà", V_BOOL, isDigit, stat);
  if (stat != 0)
    isDigit = true;
  end;                                    

  if (not isDigit and (SubStr(str, strlen(str) - 2) == "-00"))
    str = SubStr(str, 1, strlen(str) - 3) + "=";
  end;

  return str;
end;


//--------------------------------------------------------------------------
private macro getExtCurr(codeCurr)
  rewind( curr );
  clearRecord( curr );
  curr.Code_Currency = codeCurr;
  getEQ( curr );
  return curr.ExternalCode;
end;


//--------------------------------------------------------------------------
private macro getCurrShortName(codeCurr)
  rewind( curr );
  clearRecord( curr );
  curr.Code_Currency = codeCurr;
  getEQ( curr );
  return curr.Short_Name;
end;


//--------------------------------------------------------------------------
private macro isNationalCurr(codeCurr)
  if ((codeCurr == 0) or (codeCurr == NationalCurr))
    return true;
  end;
  return false;
end;


//--------------------------------------------------------------------------
private macro GetParty(party_id:integer)
  var cmd = RsdCommand(
      "select * " +
      "from dparty_dbt " +
      "where t_PartyId = ? ");

  cmd.addParam("PartyId", RSDBP_IN, party_id);
  cmd.execute();
  var rs = RsdRecordset(cmd);
  rs.NullConversion = true;
  return rs;
end;


//--------------------------------------------------------------------------
private macro GetTempParty(party_id:integer)
  var cmd = RsdCommand(
      "select * " +
      "from dtemporaryparty_dbt " +
      "where t_TempPartyId = ? ");

  cmd.addParam("PartyId", RSDBP_IN, party_id);
  cmd.execute();
  var rs = RsdRecordset(cmd);
  rs.NullConversion = true;
  return rs;
end;


//--------------------------------------------------------------------------
private class RepParams
  private var Params = "";

  //--------------------------------------------------------------------------
  macro add(str:string, format:string)
    if (Params != "")
      Params = Params + ", ";
    end;

    str = StrSubst(str, "\\", "\\\\"); // Ì™‡†≠®‡Æ¢†‚Ï \
    str = StrSubst(str, "\"", "\\" + "\""); // Ì™‡†≠®‡Æ¢†‚Ï "
    Params = Params + "\"" + str + "\"";

    if (format == null)
      format = ":l";
    end;
    Params = Params + ",\"" + format + "\"";
  end;

  //--------------------------------------------------------------------------
  macro getList()
    return Params;
  end;
end;


//--------------------------------------------------------------------------
private class DocAccount(acc1:string, acc2:string, sum:money, nat_sum:money, curr_code:integer)
  var Account;
  var Amount = sum;
  var NatCurrEquivalent = nat_sum;
  var CurrCode = curr_code;
  var PageNum;

  if (acc1 != "")
    Account = acc1;
  else
    Account = acc2;
  end;
end;


//--------------------------------------------------------------------------
private class BO(doc_id:integer)

  private var documentId = doc_id;
  private var documentNumber = "";
  private var docDate;
  private var documentType = "";
  private var payer = TArray;
  private var receiver = TArray;
  private var multiCurrency;
  private var sumStr = "";
  private var payerName = "";
  private var payerNameArray;
  private var receiverName = "";
  private var receiverNameArray;
  private var operationCipher = "";
  private var priority = 0;
  private var ground = "";
  private var groundArray;
  private var auxAttribute1 = "";
  private var auxAttribute2 = "";
  private var auxAttribute3 = "";
  private var auxAttribute5 = "";
  private var footerPageNum;

  private var rep;// = CMakeReport( "", SEP_DEFAULT, 99999 );
  private var template;
  private var params;
  private var pageNum = 1;
  private var totalPages = 1;


  //--------------------------------------------------------------------------
  private macro getPartyName(rs:RsdRecordset, party_fld_name:string, temp_party_fld_name:string)
    var name = "";
    var is_null;
    var party_rs;

    var id = rs.value(party_fld_name, is_null);
    if (not is_null)
      party_rs = GetParty(id);
    else
      id = rs.value(temp_party_fld_name, is_null);
      if (not is_null)
        party_rs = GetTempParty(id);
      end;
    end;

    if (party_rs and party_rs.moveNext())
      name = party_rs.value("t_Name");
    end;

    return name;
  end;


  //--------------------------------------------------------------------------
  private macro loadDocAccounts()
    var accounts = TArray;
    
    var cmd = RsdCommand(
        "select * " +
        "from drtdocaccount_dbt " +
        "where t_DocumentId  = ? " +
        "order by t_DocumentId, t_LineNumber ");

    cmd.addParam("DocumentId", RSDBP_IN, documentId);
    cmd.execute();
    var rs = RsdRecordset(cmd);
    rs.NullConversion = true;
    while (rs.moveNext())
      accounts[accounts.size] = DocAccount(rs.value("t_InternalAccount"), rs.value("t_Account"), rs.value("t_Amount"), 
          rs.value("t_NatCurrEquivalent"), rs.value("t_CurrCode"));
    end;

    return accounts;
  end;


  //--------------------------------------------------------------------------
  private macro isMultiCurrency()
    var curr_code = payer[0].CurrCode;

    var i = 1;
    while (i < payer.size)
      if (payer[i].CurrCode != curr_code)
        return true;
      end;
      i = i + 1;
    end;

    i = 0;
    while (i < receiver.size)
      if (receiver[i].CurrCode != curr_code)
        return true;
      end;
      i = i + 1;
    end;

    return false;
  end;


  //--------------------------------------------------------------------------
  private macro init()
    
    var cmd = RsdCommand(
        "select * " +
        "from drtdocument_dbt d, drtmemorialorder_dbt mo " +
        "where d.t_DocumentId = mo.t_DocumentId " +
        "  and d.t_DocumentId = ? ");

    cmd.addParam("DocumentId", RSDBP_IN, documentId);
    cmd.execute();
    var rs = RsdRecordset(cmd);
    rs.NullConversion = true;
    if (not rs.moveNext())
      DoError("Å†≠™Æ¢·™®© Æ‡§•‡ ≠• ≠†©§•≠");
    end;
  
    documentNumber = rs.value("t_DocumentNumber");
    DtTmSplit(rs.value("t_Date"), docDate);
    documentType = rs.value("t_DocumentType");

    var foldSide = rs.value("t_FoldSide");

    if (foldSide == 1)
      payer = loadDocAccounts();
    end;
    if (payer.size == 0)
      payer[0] = DocAccount(rs.value("t_PayerAccount"), rs.value("t_DebitAccount"), rs.value("t_DebitAmount"),
          rs.value("t_NatCurrEquivalent"), rs.value("t_DebitCurrCode"));
    end;

    if (foldSide == 2)
      receiver = loadDocAccounts();
    end;
    if (receiver.size == 0)
      receiver[0] = DocAccount(rs.value("t_ReceiverAccount"), rs.value("t_CreditAccount"), rs.value("t_CreditAmount"),
          rs.value("t_NatCurrEquivalent"), rs.value("t_CreditCurrCode"));
    end;

    multiCurrency = isMultiCurrency();

    if (payer.size == 1)
      sumStr = CurToStrAlt(payer[0].Amount, null, null, int(getExtCurr(payer[0].CurrCode)));
    else
      sumStr = CurToStrAlt(receiver[0].Amount, null, null, int(getExtCurr(receiver[0].CurrCode)));
    end;

    payerName = rs.value("t_PayerName");
    receiverName = rs.value("t_ReceiverName");

    operationCipher = rs.value("t_OperationCipher");
    priority = rs.value("t_Priority");
    ground = rs.value("t_Ground");

    auxAttribute1 = rs.value("t_auxAttribute1");
    auxAttribute2 = rs.value("t_auxAttribute2");
    auxAttribute3 = rs.value("t_auxAttribute3");
    auxAttribute5 = rs.value("t_auxAttribute5");
  end;


  //--------------------------------------------------------------------------
  private macro calcPages()
    var i;
    
    pageNum = 1;
    totalPages = 1;

    // payer
    payerNameArray = StrSplit2(payerName, 32, 32);

    var strCount = HeaderLength;
    for (i, 0, payer.size() - 1)
      if (MaxNumString - strCount < AccountLength)
        totalPages = totalPages + 1;
        strCount = 0;
      end;

      payer[i].PageNum = totalPages;
      strCount = strCount + AccountLength;
    end;

    if ((totalPages == 1) and (strCount < HeaderLength + payerNameArray.size()))
      strCount = HeaderLength + payerNameArray.size();
    end;

    // receiver
    receiverNameArray = StrSplit2(receiverName, 32, 32);
    
    if ((MaxNumString - strCount < AccountLength) or (MaxNumString - strCount < receiverNameArray.size()))
      totalPages = totalPages + 1;
      strCount = 0;
    end;

    var firstPage = totalPages;
    var firstStr = strCount;
    for (i, 0, receiver.size() - 1)
      if (MaxNumString - strCount < AccountLength)
        totalPages = totalPages + 1;
        strCount = 0;
      end;

      receiver[i].PageNum = totalPages;
      strCount = strCount + AccountLength;
    end;
    
    if ((totalPages == firstPage) and (strCount < firstStr + receiverNameArray.size()))
      strCount = firstStr + receiverNameArray.size();
    end;

    // ground
    groundArray = StrSplit2(ground, 58, 58, 3);
    
    if (MaxNumString - strCount < FooterLength + groundArray.size())
      totalPages = totalPages + 1;
      strCount = 0;
    end;

    footerPageNum = totalPages;
    
  end;
  

  //--------------------------------------------------------------------------
  private macro makeHeader()
    var sumStrArray = StrSplit2(sumStr, 49, 49, 3);
    template = template +
        "                                                                ⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø " + "\n" +
        "                                                                ≥       0401067   ≥ " + "\n" +
        "                                                                ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ " + "\n" +
        "                                                                                    " + "\n" +
        "                                                                                    " + "\n" +
        "  ÅÄçäéÇëäàâ éêÑÖê ¸ ########                       ###################             " + "\n" +
        "                                                           Ñ†‚†                     " + "\n" +
        "                                                                                    " + "\n" +
        "                                                                                    " + "\n" +
        "###########                                         ################                " + "\n" +
        "ƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ" + "\n" +
        " ë„¨¨†     ≥ ################################################# ≥ Ç®§ ÆØ.        ≥ ###   " + "\n" +
        " Ø‡ÆØ®·ÏÓ  ≥ ################################################# √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ" + "\n" +
        "           ≥ ################################################# ≥ éÁ•‡. Ø´†‚.    ≥ ###   " + "\n" +
        "ƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ" + "\n" +
        "         è´†‚•´ÏÈ®™             ≥     ëÁ. ¸               ≥         ë„¨¨†              " + "\n" +
        " ______________________________ ≥ _______________________ √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ" + "\n";
    params.add(documentNumber);
    params.add(DateToStr(docDate));
    params.add(documentType);
    params.add(auxAttribute3);
    params.add(sumStrArray[0]);
    params.add(operationCipher);
    params.add(sumStrArray[1]);
    params.add(sumStrArray[2]);
    params.add(priority);
  end;


  //--------------------------------------------------------------------------
  private macro makeFooter()
    var auxAttribute2Array = StrSplit2(auxAttribute2, 25, 25, groundArray.size());

    var tot = "";
    if (totalPages > 1)
      tot = "Ç·•£Æ ·‚‡. " + totalPages;
    end;

    if (StrLen(auxAttribute5) <= 25)
      template = template +
          "ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ" + "\n" +
          "         ç†ß≠†Á•≠®• Ø´†‚•¶†                               ≥#########################" + "\n";
      params.add(auxAttribute5);
    else
      var auxAttribute5Array = StrSplit2(auxAttribute5, 25);
      template = template +
          "ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ" + "\n" +
          "                                                          ≥#########################" + "\n" +
          "         ç†ß≠†Á•≠®• Ø´†‚•¶†                               ≥#########################" + "\n";
      params.add(auxAttribute5Array[0]);
      params.add(auxAttribute5Array[1]);
    end;
        
    template = template +
        "ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ" + "\n" +
        "##########################################################≥         é‚¨•‚™® °†≠™†        " + "\n";
    params.add(groundArray[0]);

    var i;
    for (i, 1, groundArray.size() - 1)
      template = template +
          "##########################################################≥#########################" + "\n";
      params.add(groundArray[i]);
      params.add(auxAttribute2Array[i - 1]);
    end;
    
    template = template +
        "ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥#########################" + "\n" +
        "####################                ##################### ≥         ØÆ§Ø®·®          " + "\n" +
        "                                                          ≥                         " + "\n";
    params.add(auxAttribute2Array[i]);
    params.add(auxAttribute1);
    params.add(tot);
  end;


  //--------------------------------------------------------------------------
  private macro makePageBreak()
    if (totalPages > 1)
      template = template +
          "                                                                                     " + "\n" +
          "                                                                                     " + "\n";

      if (pageNum > 1)
        template = template +
            "Å†≠™Æ¢·™®© Æ‡§•‡ ¸ ########                                                          " + "\n" +
            "                                                                                     " + "\n";
        params.add(documentNumber, ":c");
      end;

      template = template +
          "  ############                                                                       " + "\n";
      params.add("ë‚‡. " + pageNum);
    end;

    template = "\n" + template;
    var str = "rep.AutoScan(\"[\" + template + \"]()\"," +  params.getList() + ")";
    ExecExp(str);

    if (pageNum < totalPages)
      //rep.AddStrBreak();
      rep.AutoScan("[" + StrFor(12) + "]()");
    end;

    template = "";
    params = RepParams;

    pageNum = pageNum + 1;
  end;
  

  //--------------------------------------------------------------------------
  private macro makePayer(from:integer)
    var index = from;
    while (index < payer.size)
      if (payer[index].PageNum != pageNum)
        return index;
      end;

      var name0 = "";
      if (index * 2 < payerNameArray.size())
        name0 = payerNameArray[index * 2];
      end;
      var name1 = "";
      if (index * 2 + 1 < payerNameArray.size())
        name1 = payerNameArray[index * 2 + 1];
      end;
      
      template = template +
          "################################≥#########################≥##################≥################## ###" + "\n" +
          "################################≥                         ≥                  ≥                      " + "\n";
      params.add(name0);
      params.add(payer[index].Account);

      var nat_curr = isNationalCurr(payer[index].CurrCode);
      
      if (nat_curr)
        params.add("");
        params.add(MoneyToStr(payer[index].Amount), ":r");
        params.add("");
      else
        params.add(MoneyToStr(payer[index].NatCurrEquivalent), ":r");
        params.add(MoneyToStr(payer[index].Amount), ":r");

        //if ((receiver.size > 1) or (payer.size > 1) or (receiver[0].CurrCode != payer[0].CurrCode))
          params.add(getCurrShortName(payer[index].CurrCode));
        /*else
          params.add("");
        end;*/
      end;

      params.add(name1);

      index = index + 1;
    end;

    index = index * 2;
    while (index < payerNameArray.size())
      template = template +
          "################################≥                         ≥                  ≥                      " + "\n";
      params.add(payerNameArray[index]);
      index = index + 1;
    end;

    return payer.size;
  end;
  

  //--------------------------------------------------------------------------
  private macro makeReceiver(from:integer)
    var index = from;
    while (index < receiver.size)
      if (receiver[index].PageNum != pageNum)
        return index;
      end;

      var name0 = "";
      if (index * 2 < receiverNameArray.size())
        name0 = receiverNameArray[index * 2];
      end;
      var name1 = "";
      if (index * 2 + 1 < receiverNameArray.size())
        name1 = receiverNameArray[index * 2 + 1];
      end;
      
      if (index == 0)
        template = template +
            "ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥                  ≥                      " + "\n" +
            "         èÆ´„Á†‚•´Ï             ≥     ëÁ. ¸               ≥                  ≥                      " + "\n" +
            " ______________________________ ≥ _______________________ ≥                  ≥                      " + "\n";
      end;

      template = template +
          "################################≥#########################≥##################≥################## ###" + "\n" +
          "################################≥                         ≥                  ≥                      " + "\n";
      params.add(name0);
      params.add(receiver[index].Account);

      if ((receiver.size == 1) and (payer.size == 1) and (receiver[0].CurrCode == payer[0].CurrCode))
        params.add("");
        params.add("");
        params.add("");
      else
        var nat_curr = isNationalCurr(receiver[index].CurrCode);
        if (nat_curr)
          params.add("");
        else
          params.add(MoneyToStr(receiver[index].NatCurrEquivalent), ":r");
        end;

        params.add(MoneyToStr(receiver[index].Amount), ":r");

        if (multiCurrency)
          params.add(getCurrShortName(receiver[index].CurrCode));
        else
          params.add("");
        end;
      end;

      params.add(name1);

      index = index + 1;
    end;

    index = index * 2;
    while (index < receiverNameArray.size())
      template = template +
          "################################≥                         ≥                  ≥                      " + "\n";
      params.add(receiverNameArray[index]);
      index = index + 1;
    end;

    return receiver.size;
  end;
  

  //--------------------------------------------------------------------------
  private macro makeOrder()
    template = "";
    params = RepParams;

    calcPages();
    makeHeader();

    var count = 0;
    while (count < payer.size)
      count = makePayer(count);

      if (count < payer.size)
        makePageBreak();
      end;
    end;

    count = 0;
    while (count < receiver.size)
      count = makeReceiver(count);

      if (count < receiver.size)
        makePageBreak();
      end;
    end;

    if (footerPageNum != pageNum)
      makePageBreak();
    end;
    makeFooter();

    makePageBreak();    
  end;


  //--------------------------------------------------------------------------
  private macro writeCsvFile(file_name:string, is_payer:bool): C_CSVFile
    var csv = C_CSVFile();

    if (not csv.FileOpen(csv.CreateFullFileName(file_name), true))
      DoError("ç•¢Æß¨Æ¶≠Æ Æ‚™‡Î‚Ï ‰†©´ " + csv.CreateFullFileName(file_name));
    end;

    var client_name, accounts;
    if (is_payer)
      client_name = payerName;
      accounts = payer;
    else
      client_name = receiverName;
      accounts = receiver;
    end;
    
    InitProgress(accounts.size, "...îÆ‡¨®‡Æ¢†≠®• ‰†©´† · §†≠≠Î¨®", "îÆ‡¨®‡Æ¢†≠®• ‰†©´† · §†≠≠Î¨®" );
    var i = 0;
    while (i < accounts.size)
      if (i == 0)
        csv.AddCell(client_name);
      else
        csv.AddCell("");
      end;
      csv.AddCell("");
      
      csv.AddCell(accounts[i].Account);
      csv.AddCell("");
      csv.AddCell("");
      csv.AddCell("");

      var nat_curr = isNationalCurr(accounts[i].CurrCode);
      if (is_payer)
        if (nat_curr)
          csv.AddCell("");
          
          csv.AddCell(MoneyToStr(accounts[i].Amount));
          csv.AddCell("");

          csv.AddCell("");
        else
          csv.AddCell(MoneyToStr(accounts[i].NatCurrEquivalent));
          
          csv.AddCell(MoneyToStr(accounts[i].Amount));
          csv.AddCell("");
          
          csv.AddCell(getCurrShortName(accounts[i].CurrCode));
        end;
      else
        if ((receiver.size == 1) and (payer.size == 1) and (receiver[0].CurrCode == payer[0].CurrCode))
          csv.AddCell("");

          csv.AddCell("");
          csv.AddCell("");

          csv.AddCell("");
        else
          if (nat_curr)
            csv.AddCell("");
          else
            csv.AddCell(MoneyToStr(accounts[i].NatCurrEquivalent));
          end;

          csv.AddCell(MoneyToStr(accounts[i].Amount));
          csv.AddCell("");
            
          if (multiCurrency)
            csv.AddCell(getCurrShortName(accounts[i].CurrCode));
          else
            csv.AddCell("");
          end;
        end;
      end;
      csv.AddRow();

      csv.AddCell("");
      csv.AddCell("");
      csv.AddCell("");
      csv.AddCell("");
      csv.AddCell("");
      csv.AddCell("");
      csv.AddCell("");
      csv.AddCell("");
      csv.AddCell("");
      csv.AddCell("");
      csv.AddRow();

      UseProgress(i);
      i = i + 1;
    end;
    RemProgress();

    csv.FileClose();

    return csv;
  end;
  

  //--------------------------------------------------------------------------
  private macro printMultilineOrder( Copies:integer )
    var ObjTempl = beginXlsReport();
    var ExecuteStrExcel : tarray = tarray;

    ObjTempl.SetCopyByRows(true);

    if(not ObjTempl.OpenTemplate("Å†≠™Æ¢·™®©.xls"/*, true*/))
      DoError("ç•¢Æß¨Æ¶≠Æ Æ‚™‡Î‚Ï Ë†°´Æ≠ Å†≠™Æ¢·™®©.xls");
    end;

    ObjTempl.SetValue_NameCell("çÆ¨•‡é‡§•‡†", documentNumber);
    ObjTempl.SetValue_NameCell("Ñ†‚†é‡§•‡†", DateToStr(docDate));
    ObjTempl.SetValue_NameCell("ëèéÑ", documentType);
    ObjTempl.SetValue_NameCell("ÑÆØèÆ´•3", auxAttribute3);
    ObjTempl.SetValue_NameCell("ë„¨¨†è‡ÆØ®·ÏÓ", sumStr);
    ObjTempl.SetValue_NameCell("Ç®§éØ´†‚Î", operationCipher);
    ObjTempl.SetValue_NameCell("éÁ•‡•§≠Æ·‚Ï", priority);

    ObjTempl.SetValue_NameCell("ç†ß≠†Á•≠®•", ground);
    ObjTempl.SetValue_NameCell("ÑÆØèÆ´•1", auxAttribute1);
    ObjTempl.SetValue_NameCell("ÑÆØèÆ´•2", auxAttribute2);

    var Table1 = ObjTempl.RegisterTable("Table1"/*, "Header"*/);
    var Table2 = ObjTempl.RegisterTable("Table2"/*, "Header"*/);

    var csv = writeCsvFile("data1.txt", true);
    Table1.FillTabelFromCSV(csv.GetlsFileName()/*, 1 */);
    Table1.EndTable();
    var n1 = payer.size; // 1

    csv = writeCsvFile("data2.txt", false);
    Table2.FillTabelFromCSV(csv.GetlsFileName()/*, 1 */);
    Table2.EndTable();
    var n2 = receiver.size; // 1

    ObjTempl.SheetName("Å†≠™Æ¢·™®© Æ‡§•‡ ¸ " + documentNumber);
    var str1 = string(11);
    var str2 = string(11+2*n1);
    var str3 = string(11+2*(n1+n2)+1);

    ObjTempl.SetBorder("a"+str1+":"+"j"+str1, 1);
    ObjTempl.SetBorder("a"+str2+":"+"f"+str2, 1);
    ObjTempl.SetBorder("a"+str2+":"+"f"+str2, 2);
    ObjTempl.SetBorder("a"+str3+":"+"j"+str3, 1);

    endXlsReport(ObjTempl);

    if ( AutoPrint  AND  ( Copies > 0 ) )
      ExecuteStrExcel[ExecuteStrExcel.Size] = "ibook.PrintOut( OptVal, OptVal," + String(Copies) + " );";
      ObjTempl.ExecStr(ExecuteStrExcel);
    end;
  end;


  //--------------------------------------------------------------------------
  macro printOrder( Copies )
    var TempRep = "", FileNameOffic = "";

    init();

    if ((payer.size >= ORDER_PRINT_NMULTI) or (receiver.size >= ORDER_PRINT_NMULTI) or isGroupProcReport())
      printMultilineOrder( Copies );
      return;
    end;
    
    rep = CMakeReport( "", SEP_DEFAULT, 99999 );
    // å•≠Ô•¨ Ë‡®‰‚ ØÆ-„¨Æ´Á†≠®Ó, Á‚Æ°Î Æ‚Á•‚ ¢ Word-• ¢´•ß ¢ ´®·‚ ‰Æ‡¨†‚† Ä4
    rep.SetDefaultFontSize(8);

    makeOrder();
    
    FileNameOffic = "BO" + StrSubst( string({curdate}), ".", "" );
                                        
    rep.SetFileNameWin( FileNameOffic );

    if ( ( ORDER_PRINT_FORMAT == OPF_TXT      ) or ( ORDER_PRINT_FORMAT == OPF_MSOFFICE_TXT ) )
      RT_PrintRep( rep, Copies );
    end;
    if ( ( ORDER_PRINT_FORMAT == OPF_MSOFFICE ) or ( ORDER_PRINT_FORMAT == OPF_MSOFFICE_TXT ) )
      rep.SetWinRepOutPut( 0, 0 );
      rep.AddWinRepOutput( WINREP_OUTPUT_WORD, WINREP_FORMAT_DOC );
      rep.SetExecuteWord( "WordDocument.PageSetup.LeftMargin = 20;" );
      rep.SetExecuteWord( "WordDocument.PageSetup.TopMargin  = 20;" );
      rep.PrintWinRep();
      RT_PrintOut_Doc( rep, Copies );
      rep.ShowWinRep();
    end;
  end;

end;


//--------------------------------------------------------------------------
macro PrintRTDocument( RTDocID:integer, Copies:integer ):integer
  var order = BO(RTDocID);
  order.printOrder( Copies );

OnError(err)
  ShowError(err);
end;


//PrintRTDocument(1);

