
import "sp_car.mac", "scservop.mac";

var FIIDDebet, FIIDCredit, Sum, FiRoleCred, FiRoleDeb, Ground, CatDeb, CatCred, DebAccNumber = "", CredAccNumber = "", FD,
    Group, Bpp = false, GroupBank;
var debug = false; //true;

Import cb_sql;

var sql, cmd, TemplNum, AccountNumber, Result;

  var AccEPRub = TRecHandler("account");
  var AccEPUSD = TRecHandler("account");
  var AccEPEUR = TRecHandler("account");
  var AccEPOB = TRecHandler("account");
  var fi_arr = TArray;
  fi_arr[0] = 11;
  fi_arr[1] = 20;
  fi_arr[2] = 8;
  fi_arr[3] = 7;
  fi_arr[4] = 0;
  fi_arr[5] = 19;

  var FIID = 0;
  var i = 0;
  record attrs(mcaccdoc);
  var j =  fi_arr.size;
  while (i <= j )



      var  epdate = {curdate};

      var   categ = "+Биржа";
      var  _categ = "-Биржа";

        TemplNum = 3;
        attrs.marketplaceid = 4;
        attrs.marketplaceofficeid = 19; 
        FIID = fi_arr[i];

        ClearRecord(AccEPRub);
        AccountNumber = MC_FindAndOpenCommonAcc( categ, epdate, MC_OPENACC_CREATE, TemplNum, attrs, null, FIID, null, null, AccEPRub, Result, null, MC_PAIRACCMODE_AUTO);
        AccountNumber = MC_FindAndOpenCommonAcc( _categ, epdate, MC_OPENACC_CREATE, TemplNum, attrs, null, FIID, null, null, AccEPRub, Result, null, MC_PAIRACCMODE_AUTO);
    i = i+1;
  end;

 TemplNum = 3;
        attrs.marketplaceid = 4;
        attrs.marketplaceofficeid = 21; 
        FIID = 0;

        ClearRecord(AccEPRub);
        AccountNumber = MC_FindAndOpenCommonAcc( categ, epdate, MC_OPENACC_CREATE, TemplNum, attrs, null, FIID, null, null, AccEPRub, Result, null, MC_PAIRACCMODE_AUTO);
        AccountNumber = MC_FindAndOpenCommonAcc( _categ, epdate, MC_OPENACC_CREATE, TemplNum, attrs, null, FIID, null, null, AccEPRub, Result, null, MC_PAIRACCMODE_AUTO);

 TemplNum = 2;
        attrs.marketplaceid = 4;
        attrs.marketplaceofficeid = 17; 
        FIID = 0;

        categ = "Клиринговый счет";
        AccountNumber = MC_FindAndOpenCommonAcc( categ, epdate, MC_OPENACC_CREATE, TemplNum, attrs, null, FIID, null, null, AccEPRub, Result, null, MC_PAIRACCMODE_AUTO);
var sqlins, cmdins, rsins, sqlupd, cmdupd, rsupd;
var _sql = "select * from dmcaccdoc_dbt where  t_iscommon = chr(88) and t_marketplaceid = 4 and T_MARKETPLACEOFFICEID = ? and t_templnum = 2 and t_catnum = 219";
    sqlupd = "update dmcaccdoc_dbt set t_account = ? where  t_iscommon = chr(88) and t_marketplaceid = 4 and T_MARKETPLACEOFFICEID = ? and t_templnum = 2 and t_catnum = 219";
var _cmd = RSDCommand(_sql);
    _cmd.AddParam("mid", rsdbp_in, 19);
var _rs = RSDRecordset (_cmd, rsdval_client, rsdval_static);
if (not _rs.movenext)
    sqlins ="   INSERT INTO DMCACCDOC_DBT "+
               "SELECT "+
                " 0, T_ISCOMMON, T_DOCKIND, "+
                "   T_DOCID, T_CATID, T_CATNUM, "
                "   T_CHAPTER, T_ACCOUNT, T_CURRENCY, "+
                "   T_TEMPLNUM, T_GROUPNUM, T_PERIODID, "+
                "   T_ACTIVATEDATE, T_DISABLINGDATE, T_ISUSABLE, "+
                "   T_FIID, T_OWNER, T_PLACE, "+
                "   T_ISSUER, T_KIND_ACCOUNT, T_CENTR, "+
                "   T_CENTROFFICE, T_ACTIONDATE, T_FIID2, "+
                "   T_CLIENTCONTRID, T_BANKCONTRID, 4 as T_MARKETPLACEID, "+
                "   ? as T_MARKETPLACEOFFICEID, T_FIROLE, T_INDEXDATE, "+
                "   T_DEPARTMENTID, T_CONTRACTOR, T_BRANCH, "+
                "   T_CORRDEPARTMENTID, T_CURRENCYEQ, T_CURRENCYEQ_RATETYPE, "+
                "   T_CURRENCYEQ_RATEDATE, T_CURRENCYEQ_RATEEXTRA, T_MCBRANCH "+
                " FROM DMCACCDOC_DBT "+
                " where t_account = ? and t_iscommon = chr(88) and t_marketplaceid = 4 and T_MARKETPLACEOFFICEID = 17 ";
       cmdins = RSDCommand(sqlins);
       cmdins.addparam("mid", rsdbp_in, 19);
       cmdins.addparam("acc", rsdbp_in, AccountNumber); 
       cmdins.execute();
else 
    cmdupd = RSDCommand(sqlupd);
    cmdupd.AddParam("Acc", rsdbp_in, AccountNumber);
    cmdupd.AddParam("mid", rsdbp_in, 19); 
    cmdupd.execute;
end;

    _cmd = RSDCommand(_sql);
    _cmd.AddParam("mid", rsdbp_in, 21);
    _rs = RSDRecordset (_cmd, rsdval_client, rsdval_static);
if (not _rs.movenext)
      sqlins ="   INSERT INTO DMCACCDOC_DBT "+
               "SELECT "+
                " 0, T_ISCOMMON, T_DOCKIND, "+
                "   T_DOCID, T_CATID, T_CATNUM, "
                "   T_CHAPTER, T_ACCOUNT, T_CURRENCY, "+
                "   T_TEMPLNUM, T_GROUPNUM, T_PERIODID, "+
                "   T_ACTIVATEDATE, T_DISABLINGDATE, T_ISUSABLE, "+
                "   T_FIID, T_OWNER, T_PLACE, "+
                "   T_ISSUER, T_KIND_ACCOUNT, T_CENTR, "+
                "   T_CENTROFFICE, T_ACTIONDATE, T_FIID2, "+
                "   T_CLIENTCONTRID, T_BANKCONTRID, 4 as T_MARKETPLACEID, "+
                "   ? as T_MARKETPLACEOFFICEID, T_FIROLE, T_INDEXDATE, "+
                "   T_DEPARTMENTID, T_CONTRACTOR, T_BRANCH, "+
                "   T_CORRDEPARTMENTID, T_CURRENCYEQ, T_CURRENCYEQ_RATETYPE, "+
                "   T_CURRENCYEQ_RATEDATE, T_CURRENCYEQ_RATEEXTRA, T_MCBRANCH "+
                " FROM DMCACCDOC_DBT "+
                " where t_account = ? and t_iscommon = chr(88) and t_marketplaceid = 4 and T_MARKETPLACEOFFICEID = 17 ";
       cmdins = RSDCommand(sqlins);
       cmdins.addparam("mid", rsdbp_in, 21);
       cmdins.addparam("acc", rsdbp_in, AccountNumber); 
       cmdins.execute();
else
    cmdupd = RSDCommand(sqlupd);
    cmdupd.AddParam("Acc", rsdbp_in, AccountNumber);
     cmdupd.AddParam("mid", rsdbp_in, 21);  
    cmdupd.execute;
end;
  categ = "+Биржа";
  record attrs_ob(mcaccdoc);
   i = 0;
   j =  fi_arr.size;
  var   AccountNumberOB, tr;
  while (i <= j )

        TemplNum = 3;
        attrs.marketplaceid = 4;
        attrs.marketplaceofficeid = 20; 
        FIID = fi_arr[i];

        attrs_ob.marketplaceid = 4;
        attrs_ob.marketplaceofficeid = 17; 

        ClearRecord(AccEPRub);
        if(fiid == 0)
//30424810999003202609
            GetAccount( 1, 0, "30424810999003202609", AccEPRub, false );
//          AccountNumber = MC_FindAndOpenCommonAcc( "Клиринговый счет", epdate, MC_OPENACC_CREATE, TemplNum, attrs, null, FIID, null, null, AccEPRub, Result, null, MC_PAIRACCMODE_AUTO);   
        else
          AccountNumber = MC_FindAndOpenCommonAcc( categ, epdate, MC_OPENACC_CREATE, TemplNum, attrs, null, FIID, null, null, AccEPRub, Result, null, MC_PAIRACCMODE_AUTO);   
        end;
        if (FIID != 0)
          if(abs(DL_GetRestAccount(AccEPRub.rec, null)) > 0) 
            TemplNum = 4;   
            ClearRecord(AccEPOB);
            AccountNumberOB = MC_FindAndOpenCommonAcc("+Обеспечение", epdate, MC_OPENACC_CREATE, TemplNum, attrs_ob, null, fiid, null, null, AccEPOB, Result, null, MC_PAIRACCMODE_AUTO);
            sum = abs(DL_GetRestAccount(AccEPRub.rec, null));
            Getdouble(sum, "Валютный рынок. Введите сумму остатка в валюте счета по счету " + AccountNumber  + " из файла ССХ99 (" + abs(DL_GetRestAccount(AccEPRub.rec, null)) + ")");

              Ground = "ВР.Перенос остатка на новый счет обеспечения в связи с переходом на единый пул";
                   tr = RsbAccTransaction();
                   tr.Shifr_Oper = "09"; // стираем, потом заполним правильно
                   tr.Chapter         = 1;
                   tr.Date_Carry      = epdate;
                   tr.Numb_Document   = "1";
                   tr.ResultCarry     = 1;
                   tr.Kind_Oper       = " 1";
                   tr.Ground          = Ground;
                   tr.Department      = {OperDprt};
                   tr.Oper            = {oper};
                   tr.FIIDPayer       = FIID;
                   tr.FIIDReceiver    = FIID;
                   tr.AccountPayer    =  AccEPOB.rec.account;
                   tr.AccountReceiver =  AccEPRub.rec.account ;
                   tr.SumPayer        = ABS(Sum);
                   tr.SumReceiver     = ABS(Sum); 

                   tr.Userfield2    = "1";
                if(sum > 0 )     
                   if( not tr.Carry() )
                       return Msgbox("Ошибка при выполнении проводки");
                   end;
                   println(AccEPOB.rec.account, "|", AccEPRub.rec.account, "|", Sum); 
                end;

                   sum = 0;

          end;
        else

        TemplNum = 2;
        attrs_ob.marketplaceid = 4;
        attrs_ob.marketplaceofficeid = 17; // Единый пул для клиентов
        //по рублям
            ClearRecord(AccEPOB);
        AccountNumberOB = MC_FindAndOpenCommonAcc("Клиринговый счет", epdate, MC_OPENACC_CREATE, TemplNum, attrs_ob, null, fiid, null, null, AccEPOB, Result, null, MC_PAIRACCMODE_AUTO);
          if(abs(DL_GetRestAccount(AccEPRub.rec, null)) > 0) 
            sum = abs(DL_GetRestAccount(AccEPRub.rec, null));
            Getdouble(sum, "Валютный рынок. Введите сумму остатка в валюте счета по счету " + AccEPOB.rec.account  + " из файла ССХ99 (" + abs(DL_GetRestAccount(AccEPRub.rec, null)) + ")");

            Ground = "ВР.Перенос остатка на новый клиринговый счет  в связи с переходом на единый пул";
                 tr = RsbAccTransaction();
                 tr.Shifr_Oper = "09"; // стираем, потом заполним правильно
                 tr.Chapter         = 1;
                 tr.Date_Carry      = epdate;
                 tr.Numb_Document   = "1";
                 tr.ResultCarry     = 1;
                 tr.Kind_Oper       = " 1";
                 tr.Ground          = Ground;
                 tr.Department      = {OperDprt};
                 tr.Oper            = {oper};
                 tr.FIIDPayer       = FIID;
                 tr.FIIDReceiver    = FIID;
                 tr.AccountPayer    = AccEPOB.rec.account;
                 tr.AccountReceiver = AccEPRub.rec.account;
                 tr.SumPayer        = ABS(Sum);
                 tr.SumReceiver     = ABS(Sum); 

                 tr.Userfield2    = "1";
                if(sum > 0 )     
                   if( not tr.Carry() )
                       return Msgbox("Ошибка при выполнении проводки");
                   end;
                   println(AccEPOB.rec.account, "|",AccEPRub.rec.account, "|", Sum); 
                end;
                 sum = 0;
             end;


        end;
    i = i+1;
  end;
//30424810200000000001
        if( MsgBoxEx( "Выполнить перенос остатков по срочному рынку?", MB_YES+MB_NO, IND_NO, "Предупреждение", "") != IND_YES )
           return 1;
        end;

        ClearRecord(AccEPRub);
        GetAccount( 1, 0, "30424810200000000001", AccEPRub, false );

        TemplNum = 2;
        attrs_ob.marketplaceid = 4;
        attrs_ob.marketplaceofficeid = 17; // Единый пул для клиентов
        //по рублям
            ClearRecord(AccEPOB);
        AccountNumberOB = MC_FindAndOpenCommonAcc("Клиринговый счет", epdate, MC_OPENACC_CREATE, TemplNum, attrs_ob, null, fiid, null, null, AccEPOB, Result, null, MC_PAIRACCMODE_AUTO);
          if(abs(DL_GetRestAccount(AccEPRub.rec, null)) > 0) 
            sum = abs(DL_GetRestAccount(AccEPRub.rec, null));
            Getdouble(sum, "Срочный рынок. Введите сумму остатка в валюте счета по счету " + AccEPOB.rec.account  + " из файла ССХ99 (" + abs(DL_GetRestAccount(AccEPRub.rec, null)) + ")");
            Ground = "СР.Перенос остатка на новый клиринговый счет  в связи с переходом на единый пул";
                 tr = RsbAccTransaction();
                 tr.Shifr_Oper = "09"; // стираем, потом заполним правильно
                 tr.Chapter         = 1;
                 tr.Date_Carry      = epdate;
                 tr.Numb_Document   = "1";
                 tr.ResultCarry     = 1;
                 tr.Kind_Oper       = " 1";
                 tr.Ground          = Ground;
                 tr.Department      = {OperDprt};
                 tr.Oper            = {oper};
                 tr.FIIDPayer       = 0;
                 tr.FIIDReceiver    = 0;
                 tr.AccountPayer    = AccEPOB.rec.account;
                 tr.AccountReceiver = AccEPRub.rec.account;
                 tr.SumPayer        = ABS(Sum);
                 tr.SumReceiver     = ABS(Sum); 
   
                 tr.Userfield2    = "1";
                 if(sum > 0 )     
                   if( not tr.Carry() )
                       return Msgbox("Ошибка при выполнении проводки");
                   end;
                   println(AccEPOB.rec.account, "|",AccEPRub.rec.account, "|", Sum); 
                 end;
                 sum = 0;
        end;
//92789020.32



msgbox("Выполнено!");
