/*
$Name:          asView.mac
$Module:        Внутренняя отчетность
$Description:   Выписка. Классы представления отчета
*/

/**
 * @since   22.09.2020
 * @author  MFB
 * @version 6.00.020.31.066
 */

/**
 *  Общебанковские интеры и модули
 */
import or_rep_h;
/**
 *  Интеры и модели подсистемы
 */
import rcbPrintableView;
import rcbTemplateTable;
import CompositeTableField;
import Ofstream;
import rcbimport;

import ExcelReportView;

private const ACCOUNT_STATEMENT_TYPE_ACCDOCCUR            = 10;
private const ACCOUNT_STATEMENT_TYPE_ACCDOCCURR           = 20;
private const ACCOUNT_STATEMENT_TYPE_ACCDOCCURRS          = 30;
private const ACCOUNT_STATEMENT_TYPE_ACCDOCCUR_NOGROUND   = 40;
private const ACCOUNT_STATEMENT_TYPE_ACCDOCCURR_NOGROUND  = 50;
private const ACCOUNT_STATEMENT_TYPE_ACCDOCCURRS_NOGROUND = 60;
private const ACCOUNT_STATEMENT_TYPE_ACCDOCINCURK         = 70;
private const ACCOUNT_STATEMENT_TYPE_ACCDOCINCURKS        = 80;
private const ACCOUNT_STATEMENT_TYPE_ACCDOCINCURR         = 90;
private const ACCOUNT_STATEMENT_TYPE_ACCDOCINCURRS        = 100;
private const ACCOUNT_STATEMENT_TYPE_ACCDOCINRUR          = 110;
private const ACCOUNT_STATEMENT_TYPE_ACCDOCINRURS         = 120;
private const ACCOUNT_STATEMENT_TYPE_ACCDOCRUR            = 130;
private const ACCOUNT_STATEMENT_TYPE_ACCDOCRURS           = 140;
private const ACCOUNT_STATEMENT_TYPE_ACCDOCRUR_NOGROUND   = 150;
private const ACCOUNT_STATEMENT_TYPE_ACCDOCRURS_NOGROUND  = 160;

class (TPrintableView_4212) TAccountStatementPrintableView(formName, formOkudCode, formPeriodicity, periodFormat)
    initTPrintableView_4212(formName, formOkudCode, formPeriodicity, periodFormat);

    macro getExtendedPrefix()
        return "";
    end;

    macro defineFileName(filename)
        var prefix = filename;
        m_printFileName = getTxtName(prefix, "txt");
    end;

    private macro constructorTPrintableReport(formName, formOkudCode, formPeriodicity, periodFormat)
        defineFileName("ordacc");
    end;

end;

class (RcbPartExcelView) TAccountStatementPartExcelView(partId, reportView, type, isFirstPrint, isPrintTotalsByDays)
    private var m_type;
    private var m_isPrintTotalsByDays;

    macro makeRowCSV(dataset, rowType)
        if  (m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCCUR    )
            if(dataset)
                addCellToCurRow(cell(dataset[2])); //document.date_carry;
                addCellToCurRow(cell(dataset[3])); //document.shifr_oper;
                addCellToCurRow(cell(dataset[4])); //document.numb_document;
                addCellToCurRow(cell(dataset[5])); //document.bic;
                addCellToCurRow(cell(dataset[8])); //document.account;
                addCellToCurRow(cell(dataset[9])); //document.sumDebit;
                addCellToCurRow(cell(dataset[10])); //document.sumCredit;
                addCellToCurRow(cell(dataset[6])); //document.ground;
            else
                addCellToCurRow(cell("Данные отсутствуют").setHorMerged(6));
            end;
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCCURR   )
            if(dataset)
                addCellToCurRow(cell(dataset[2])); //document.date_carry;
                addCellToCurRow(cell(dataset[3])); //document.shifr_oper;
                addCellToCurRow(cell(dataset[4])); //document.numb_document;
                addCellToCurRow(cell(dataset[5])); //document.bic;
                addCellToCurRow(cell(dataset[8])); //document.account;
                addCellToCurRow(cell(dataset[9])); //document.sumDebit;
                addCellToCurRow(cell(dataset[10])); //document.sumCredit;
                addCellToCurRow(cell(dataset[11])); //document.sumDebitEq;
                addCellToCurRow(cell(dataset[12])); //document.sumCreditEq;
                addCellToCurRow(cell(dataset[6])); //document.ground;
            else
                addCellToCurRow(cell("Данные отсутствуют").setHorMerged(10));
            end;
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCCURRS  )
            if(dataset)
                addCellToCurRow(cell(dataset[0])); //document.note;
                addCellToCurRow(cell(dataset[2])); //document.date_carry;
                addCellToCurRow(cell(dataset[3])); //document.shifr_oper;
                addCellToCurRow(cell(dataset[4])); //document.numb_document;
                addCellToCurRow(cell(dataset[5])); //document.bic;
                addCellToCurRow(cell(dataset[8])); //document.account;
                addCellToCurRow(cell(dataset[9])); //document.sumDebit;
                addCellToCurRow(cell(dataset[10])); //document.sumCredit;
                addCellToCurRow(cell(dataset[11])); //document.sumDebitEq;
                addCellToCurRow(cell(dataset[12])); //document.sumCreditEq;
                addCellToCurRow(cell(dataset[6])); //document.ground;
            else
                addCellToCurRow(cell("Данные отсутствуют").setHorMerged(10));
            end;
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCCUR_NOGROUND)
            if(dataset)
                addCellToCurRow(cell(dataset[2])); //document.date_carry;
                addCellToCurRow(cell(dataset[3])); //document.shifr_oper;
                addCellToCurRow(cell(dataset[4])); //document.numb_document;
                addCellToCurRow(cell(dataset[5])); //document.bic;
                addCellToCurRow(cell(dataset[8])); //document.account;
                addCellToCurRow(cell(dataset[9])); //document.sumDebit;
                addCellToCurRow(cell(dataset[10])); //document.sumCredit;
            else
                addCellToCurRow(cell("Данные отсутствуют").setHorMerged(7));
            end;
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCCURR_NOGROUND)
            if(dataset)
                addCellToCurRow(cell(dataset[2])); //document.date_carry;
                addCellToCurRow(cell(dataset[3])); //document.shifr_oper;
                addCellToCurRow(cell(dataset[4])); //document.numb_document;
                addCellToCurRow(cell(dataset[5])); //document.bic;
                addCellToCurRow(cell(dataset[8])); //document.account;
                addCellToCurRow(cell(dataset[9])); //document.sumDebit;
                addCellToCurRow(cell(dataset[10])); //document.sumCredit;
                addCellToCurRow(cell(dataset[11])); //document.sumDebitEq;
                addCellToCurRow(cell(dataset[12])); //document.sumCreditEq;
            else
                addCellToCurRow(cell("Данные отсутствуют").setHorMerged(9));
            end;
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCCURRS_NOGROUND)
            if(dataset)
                addCellToCurRow(cell(dataset[0])); //document.note;
                addCellToCurRow(cell(dataset[2])); //document.date_carry;
                addCellToCurRow(cell(dataset[3])); //document.shifr_oper;
                addCellToCurRow(cell(dataset[4])); //document.numb_document;
                addCellToCurRow(cell(dataset[5])); //document.bic;
                addCellToCurRow(cell(dataset[8])); //document.account;
                addCellToCurRow(cell(dataset[9])); //document.sumDebit;
                addCellToCurRow(cell(dataset[10])); //document.sumCredit;
                addCellToCurRow(cell(dataset[11])); //document.sumDebitEq;
                addCellToCurRow(cell(dataset[12])); //document.sumCreditEq;
            else
                addCellToCurRow(cell("Данные отсутствуют").setHorMerged(9));
            end;
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCINCURK )
            if(dataset)
                addCellToCurRow(cell(dataset[1])); //document.statementLineNumber;
                addCellToCurRow(cell(dataset[2])); //document.date_carry;
                addCellToCurRow(cell(dataset[3])); //document.shifr_oper;
                addCellToCurRow(cell(dataset[4])); //document.numb_document;
                addCellToCurRow(cell(dataset[6])); //document.ground;
                addCellToCurRow(cell(dataset[8])); //document.account;
                addCellToCurRow(cell(dataset[9])); //document.sumDebit;
                addCellToCurRow(cell(dataset[10])); //document.sumCredit;
            else
                addCellToCurRow(cell("Данные отсутствуют").setHorMerged(8));
            end;
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCINCURKS)
            if(dataset)
                addCellToCurRow(cell(dataset[0])); //document.note;
                addCellToCurRow(cell(dataset[1])); //document.statementLineNumber;
                addCellToCurRow(cell(dataset[2])); //document.date_carry;
                addCellToCurRow(cell(dataset[3])); //document.shifr_oper;
                addCellToCurRow(cell(dataset[4])); //document.numb_document;
                addCellToCurRow(cell(dataset[6])); //document.ground;
                addCellToCurRow(cell(dataset[8])); //document.account;
                addCellToCurRow(cell(dataset[9])); //document.sumDebit;
                addCellToCurRow(cell(dataset[10])); //document.sumCredit;
            else
                addCellToCurRow(cell("Данные отсутствуют").setHorMerged(8));
            end;
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCINCURR )
            if(dataset)
                addCellToCurRow(cell(dataset[1])); //document.statementLineNumber;
                addCellToCurRow(cell(dataset[2])); //document.date_carry;
                addCellToCurRow(cell(dataset[3])); //document.shifr_oper;
                addCellToCurRow(cell(dataset[4])); //document.numb_document;
                addCellToCurRow(cell(dataset[6])); //document.ground;
                addCellToCurRow(cell(dataset[8])); //document.account;
                addCellToCurRow(cell(dataset[9])); //document.sumDebit;
                addCellToCurRow(cell(dataset[11])); //document.sumDebitEq;
                addCellToCurRow(cell(dataset[10])); //document.sumCredit;
                addCellToCurRow(cell(dataset[12])); //document.sumCreditEq;
            else
                addCellToCurRow(cell("Данные отсутствуют").setHorMerged(10));
            end;
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCINCURRS)
            if(dataset)
                addCellToCurRow(cell(dataset[0])); //document.note;
                addCellToCurRow(cell(dataset[1])); //document.statementLineNumber;
                addCellToCurRow(cell(dataset[2])); //document.date_carry;
                addCellToCurRow(cell(dataset[3])); //document.shifr_oper;
                addCellToCurRow(cell(dataset[4])); //document.numb_document;
                addCellToCurRow(cell(dataset[6])); //document.ground;
                addCellToCurRow(cell(dataset[8])); //document.account;
                addCellToCurRow(cell(dataset[9])); //document.sumDebit;
                addCellToCurRow(cell(dataset[11])); //document.sumDebitEq;
                addCellToCurRow(cell(dataset[10])); //document.sumCredit;
                addCellToCurRow(cell(dataset[12])); //document.sumCreditEq;
            else
                addCellToCurRow(cell("Данные отсутствуют").setHorMerged(10));
            end;
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCINRUR  )
            if(dataset)
                addCellToCurRow(cell(dataset[1])); //document.statementLineNumber;
                addCellToCurRow(cell(dataset[2])); //document.date_carry;
                addCellToCurRow(cell(dataset[3])); //document.shifr_oper;
                addCellToCurRow(cell(dataset[4])); //document.numb_document;
                addCellToCurRow(cell(dataset[6])); //document.ground;
                addCellToCurRow(cell(dataset[8])); //document.account;
                addCellToCurRow(cell(dataset[9])); //document.sumDebit;
                addCellToCurRow(cell(dataset[10])); //document.sumCredit;
            else
                addCellToCurRow(cell("Данные отсутствуют").setHorMerged(8));
            end;
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCINRURS )
            if(dataset)
                addCellToCurRow(cell(dataset[0])); //document.note;
                addCellToCurRow(cell(dataset[1])); //document.statementLineNumber;
                addCellToCurRow(cell(dataset[2])); //document.date_carry;
                addCellToCurRow(cell(dataset[3])); //document.shifr_oper;
                addCellToCurRow(cell(dataset[4])); //document.numb_document;
                addCellToCurRow(cell(dataset[6])); //document.ground;
                addCellToCurRow(cell(dataset[8])); //document.account;
                addCellToCurRow(cell(dataset[9])); //document.sumDebit;
                addCellToCurRow(cell(dataset[10])); //document.sumCredit;
            else
                addCellToCurRow(cell("Данные отсутствуют").setHorMerged(8));
            end;
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCRUR    )
            if(dataset)
                addCellToCurRow(cell(dataset[2])); //document.date_carry;
                addCellToCurRow(cell(dataset[3])); //document.shifr_oper;
                addCellToCurRow(cell(dataset[4])); //document.numb_document;
                addCellToCurRow(cell(dataset[7])); //document.corrBankAcc;
                addCellToCurRow(cell(dataset[5])); //document.bic;
                addCellToCurRow(cell(dataset[8])); //document.account;
                addCellToCurRow(cell(dataset[9])); //document.sumDebit;
                addCellToCurRow(cell(dataset[10])); //document.sumCredit;
                addCellToCurRow(cell(dataset[6])); //document.ground;
            else
                addCellToCurRow(cell("Данные отсутствуют").setHorMerged(9));
            end;
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCRURS   )
            if(dataset)
                addCellToCurRow(cell(dataset[0])); //document.note;
                addCellToCurRow(cell(dataset[2])); //document.date_carry;
                addCellToCurRow(cell(dataset[3])); //document.shifr_oper;
                addCellToCurRow(cell(dataset[4])); //document.numb_document;
                addCellToCurRow(cell(dataset[7])); //document.corrBankAcc;
                addCellToCurRow(cell(dataset[5])); //document.bic;
                addCellToCurRow(cell(dataset[8])); //document.account;
                addCellToCurRow(cell(dataset[9])); //document.sumDebit;
                addCellToCurRow(cell(dataset[10])); //document.sumCredit;
                addCellToCurRow(cell(dataset[6])); //document.ground;
            else
                addCellToCurRow(cell("Данные отсутствуют").setHorMerged(9));
            end;
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCRUR_NOGROUND)
            if(dataset)
                addCellToCurRow(cell(dataset[2])); //document.date_carry;
                addCellToCurRow(cell(dataset[3])); //document.shifr_oper;
                addCellToCurRow(cell(dataset[4])); //document.numb_document;
                addCellToCurRow(cell(dataset[7])); //document.corrBankAcc;
                addCellToCurRow(cell(dataset[5])); //document.bic;
                addCellToCurRow(cell(dataset[8])); //document.account;
                addCellToCurRow(cell(dataset[9])); //document.sumDebit;
                addCellToCurRow(cell(dataset[10])); //document.sumCredit;
            else
                addCellToCurRow(cell("Данные отсутствуют").setHorMerged(8));
            end;
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCRURS_NOGROUND)
            if(dataset)
                addCellToCurRow(cell(dataset[0])); //document.note;
                addCellToCurRow(cell(dataset[2])); //document.date_carry;
                addCellToCurRow(cell(dataset[3])); //document.shifr_oper;
                addCellToCurRow(cell(dataset[4])); //document.numb_document;
                addCellToCurRow(cell(dataset[7])); //document.corrBankAcc;
                addCellToCurRow(cell(dataset[5])); //document.bic;
                addCellToCurRow(cell(dataset[8])); //document.account;
                addCellToCurRow(cell(dataset[9])); //document.sumDebit;
                addCellToCurRow(cell(dataset[10])); //document.sumCredit;
            else
                addCellToCurRow(cell("Данные отсутствуют").setHorMerged(8));
            end;
        end;
    end;

    macro printHeadPart(accInfo, bankName)
        if(not m_headIsPrinted)
            initTemplate();
            initCsvTable();
            m_printEngine.SetValue_NameCell("bankName",          bankName);
            m_printEngine.SetValue_NameCell("inDate",            accInfo.dateIn);
            m_printEngine.SetValue_NameCell("outDate",           accInfo.dateOut);
            m_printEngine.SetValue_NameCell("account",           accInfo.Account.acc);
            m_printEngine.SetValue_NameCell("accountName",       accInfo.Account.accName);
            m_printEngine.SetValue_NameCell("client",            accInfo.Account.nameClnt);
            m_printEngine.SetValue_NameCell("inn",               accInfo.Account.inn);
            m_printEngine.SetValue_NameCell("operator",          accInfo.Account.oper);
            m_printEngine.SetValue_NameCell("lastOperationDate", accInfo.Account.dpd);
            m_printEngine.SetValue_NameCell("currency",          accInfo.Account.currencyname);
            m_printEngine.SetValue_NameCell("inRestType",        АП(accInfo.account.restIn, accInfo.account.kind_account));
            m_printEngine.SetValue_NameCell("inRest",            abs(accInfo.Account.restIn));
			
            m_headIsPrinted = true;
            // Копирование в рабочую книгу заголовка шаблона (отдельно т.к. иначе копируется весь шаблон и 
            // подвал не смещается (#317640))
			m_printEngine.CopyAllSheetInTotalBook(null,             //Имя закладки,по умолчанию имя закладки из шаблона
                                                  false,            // true - на новый лист, false - на существующий(если имя листа отличается, всегда на новый лист)
                                                  "templateHeader", //Что копировать м.б. диапозон вида "A1:T60" или имя именованного диапозона
                                                  0,
                                                  m_sheetName) ;    // Имя закладки, в которую копировать
        end;
    end;

    macro printFooter(accInfo, document)
		saveCsvTable();
        m_printEngine.SetValue_NameCell("totalDocs",       document.overallDocs);
        m_printEngine.SetValue_NameCell("debetTotal",      document.allSumDebit);
        m_printEngine.SetValue_NameCell("creditTotal",     document.allSumCredit);
        m_printEngine.SetValue_NameCell("debetTotalSpod",  document.allSumDebitSPOD);
        m_printEngine.SetValue_NameCell("creditTotalSpod", document.allSumCreditSPOD);
        m_printEngine.SetValue_NameCell("outRestType",     АП(accInfo.account.restOut, accInfo.account.kind_account));
        m_printEngine.SetValue_NameCell("outRest",         abs(accInfo.Account.restOut));
        saveTemplate();

        // Необходимо для переоткрытия шаблона и установки правильной позиции для копирования новой таблицы
        if (m_isPrintTotalsByDays)
            m_templateIsOpened = false;
            m_csvTableIsOpened = false;
            m_isFirstOnSheet   = false;	
        end;
    end;

    macro saveTemplate()
        if(m_templateIsOpened)
        	// Формально уже не нужно, но оставлено на всякий случай
            var templateZoneTarget, templateHeight, lastRow, lastColumn, sourceZone;
            sourceZone         = CAddressDiapazon("$A$1:$A$1"); //Инициализация диапазона заполненного шаблона для копирования в книгу
            // В случае, если требуется печатать промежуточные итоги по дням, необходимо, начиная со второй таблицы
            // смещаться на то количество строк, которое приходится на заголовок (до шапки таблицы)
            if (m_isPrintTotalsByDays and (not m_isFirstOnSheet))
                var headerZoneAddrStr, countRowsBeforeTable;

                templateZoneTarget   = "$A$" + (m_reportView.getLastRow(m_sheetName) + 1);
                headerZoneAddrStr    = m_csvTable.GetCurAddress(m_templateTableHeader);
                // - 1 для того, что бы заголовок новой таблицы остался
                countRowsBeforeTable = Int(SubStr(headerZoneAddrStr, 2, Index(headerZoneAddrStr, ":") - 1)) - 1;
                // из высоты шаблона вычитаем высоту НЕнужной части заголовка и вычитаем
                // строку, которая является шаблоном таблицы (пустная строка с которой начинается печать данных)
                templateHeight       = getColCount(m_templateAddress) - countRowsBeforeTable - 1;
                lastRow              = m_csvTable.AddressDiapazon.getNumbRow() + templateHeight;                                          //Получаем количество строк заполненного шаблона
                lastColumn           = m_csvTable.AddressDiapazon.getNumbColumn();

                sourceZone.OffSet_Top(countRowsBeforeTable);
                sourceZone.OffSet_Bottom(countRowsBeforeTable + lastRow);
                sourceZone.OffSet_Right(lastColumn);
            else
                templateZoneTarget = ternary(m_isFirstOnSheet, m_templateZoneTarget, "$A$" + (m_reportView.getLastRow(m_sheetName) + 1)); //Если шаблон первый на листе, начинаем с A1, иначе с последней строки
                // - 1 для исключения из высоты шаблона строки, которая является шаблоном
                // таблицы (пустная строка с которой начинается печать данных)
                templateHeight     = getColCount(m_templateAddress) - 1;
                lastRow            = m_csvTable.AddressDiapazon.getNumbRow() + templateHeight;                                            //Получаем количество строк заполненного шаблона
                lastColumn         = m_csvTable.AddressDiapazon.getNumbColumn();                                                          //Получаем количество строк пустого шаблона

                sourceZone.OffSet_Bottom(lastRow);
                sourceZone.OffSet_Right(lastColumn);
            end;

            m_reportView.setLastRow(ternary(m_isFirstOnSheet, lastRow, m_reportView.getLastRow(m_sheetName) + lastRow), m_sheetName);     //Сохраняем количество занятых строк на листе
			// Копирование данных таблицы
			m_printEngine.CopyAllSheetInTotalBook(null,                       //Имя закладки,по умолчанию имя закладки из шаблона
                                                  false,                      // true - на новый лист, false - на существующий(если имя листа отличается, всегда на новый лист)
                                                  m_csvTable.GetTableRange(), //Что копировать м.б. диапозон вида "A1:T60" или имя именованного диапозона
                                                  0,
                                                  m_sheetName);               // Имя закладки, в которую копировать
            // Копирование подвала таблицы
			m_printEngine.CopyAllSheetInTotalBook(null,                       //Имя закладки,по умолчанию имя закладки из шаблона
                                                  false,                      // true - на новый лист, false - на существующий(если имя листа отличается, всегда на новый лист)
                                                  "templateFooter",           //Что копировать м.б. диапозон вида "A1:T60" или имя именованного диапозона
                                                  0,
                                                  m_sheetName);               // Имя закладки, в которую копировать
			m_printEngine.Close();

            

            m_cellFormatSheet = 1;
            m_cellformats = RcbArray();
            // Необходимо для того, что бы объекты, ссылки на которых содержатся в данных переменных
            // были выгружены из памяти (помогает вывести до 5тыс. таблиц в Excel)
            m_csvTable = NULL;
            m_csvFile  = NULL;
        end;
    end;

    private macro constructorTAccountStatementPartExcelView(partId, reportView, type, isFirstPrint, isPrintTotalsByDays)
        m_type                = type;
        m_isPrintTotalsByDays = isPrintTotalsByDays;
        var templateFile = "ACCDOCRUR.xlsx";
        if  (m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCCUR    )
            templateFile = "ACCDOCCUR.xlsx";
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCCURR   )
            templateFile = "ACCDOCCURR.xlsx";
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCCURRS  )
            templateFile = "ACCDOCCURRS.xlsx";
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCCUR_NOGROUND)
            templateFile = "ACCDOCCUR_NG.xlsx";
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCCURR_NOGROUND)
            templateFile = "ACCDOCCURR_NG.xlsx";
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCCURRS_NOGROUND)
            templateFile = "ACCDOCCURRS_NG.xlsx";
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCINCURK )
            templateFile = "ACCDOCINCURK.xlsx";
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCINCURKS)
            templateFile = "ACCDOCINCURKS.xlsx";
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCINCURR )
            templateFile = "ACCDOCINCURR.xlsx";
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCINCURRS)
            templateFile = "ACCDOCINCURRS.xlsx";
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCINRUR  )
            templateFile = "ACCDOCINRUR.xlsx";
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCINRURS )
            templateFile = "ACCDOCINRURS.xlsx";
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCRUR    )
            templateFile = "ACCDOCRUR.xlsx";
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCRURS   )
            templateFile = "ACCDOCRURS.xlsx";
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCRUR_NOGROUND)
            templateFile = "ACCDOCRUR_NG.xlsx";
        elif(m_type == ACCOUNT_STATEMENT_TYPE_ACCDOCRURS_NOGROUND)
            templateFile = "ACCDOCRURS_NG.xlsx";
        end;
        initRcbPartExcelView(partId, "", partId, templateFile, reportView, isFirstPrint);
    end;

    constructorTAccountStatementPartExcelView(partId, reportView, type, isFirstPrint, isPrintTotalsByDays);
end;

class (RcbReportExcelView) TAccountStatementReportExcelView(protocolView, isPrintTotalsByDays)
    var m_partIsOpened;
    var m_isPrintTotalsByDays;

    private const NATCUR             = 0;
    private const ACC_FORMATS_CLIENT = 1; // клиентский
    private const ACC_FORMATS_BANK   = 2; // внутрибанковский

    macro printHeader(accInfo, bankName, isFirstPrint)
        if(m_partIsOpened == false)
            m_partIsOpened = true;
            var type;
            if   (accInfo.Account.Currency == NATCUR) //Рублевая
                if(accInfo.format == ACC_FORMATS_BANK)    //Внутрибанковская
                    if(accInfo.SPODTurnsTotal == false)       //Без СПОД
                        type = ACCOUNT_STATEMENT_TYPE_ACCDOCINRUR;
                    else                                      //Со СПОД
                        type = ACCOUNT_STATEMENT_TYPE_ACCDOCINRURS;
                    end;
                else                                      //Клиентская
                    if(accInfo.SPODTurnsTotal == false)       //Без СПОД
                        type = ternary(accInfo.PrGround, ACCOUNT_STATEMENT_TYPE_ACCDOCRUR, ACCOUNT_STATEMENT_TYPE_ACCDOCRUR_NOGROUND);
                    else                                      //Со СПОД
                        type = ternary(accInfo.PrGround, ACCOUNT_STATEMENT_TYPE_ACCDOCRURS, ACCOUNT_STATEMENT_TYPE_ACCDOCRURS_NOGROUND);
                    end;
                end;
            else                                      //Валютная
                if(accInfo.format == ACC_FORMATS_BANK)    //Внутрибанковская
                    if(accInfo.natCurEquivalent == false)     //Без рублевого эквивалента
                        if(accInfo.SPODTurnsTotal == false)       //Без СПОД
                            type = ACCOUNT_STATEMENT_TYPE_ACCDOCINCURK;
                        else                                      //Со СПОД
                            type = ACCOUNT_STATEMENT_TYPE_ACCDOCINCURKS;
                        end;
                    else                                      //С рублевым эквивалентом
                        if(accInfo.SPODTurnsTotal == false)       //Без СПОД
                            type = ACCOUNT_STATEMENT_TYPE_ACCDOCINCURR;
                        else                                      //Со СПОД
                            type = ACCOUNT_STATEMENT_TYPE_ACCDOCINCURRS;
                        end;
                    end;
                else                                      //Клиентская
                    if(accInfo.natCurEquivalent == false)     //Без рублевого эквивалента
                        type = ternary(accInfo.PrGround, ACCOUNT_STATEMENT_TYPE_ACCDOCCUR, ACCOUNT_STATEMENT_TYPE_ACCDOCCUR_NOGROUND);
                    else                                      //С рублевым эквивалентом
                        if(accInfo.SPODTurnsTotal == false)       //Без СПОД
                            type = ternary(accInfo.PrGround, ACCOUNT_STATEMENT_TYPE_ACCDOCCURR, ACCOUNT_STATEMENT_TYPE_ACCDOCCURR_NOGROUND);
                        else                                      //Со СПОД
                            type = ternary(accInfo.PrGround, ACCOUNT_STATEMENT_TYPE_ACCDOCCURRS, ACCOUNT_STATEMENT_TYPE_ACCDOCCURRS_NOGROUND);
                        end;
                    end;
                end;
            end;
            m_partViewPool[m_partViewPool.size] = objectFactoryInstance.createPartExcelView(accInfo.Account.acc, this, type, isFirstPrint, m_isPrintTotalsByDays);
            m_partViewPool[m_partViewPool.size - 1].printHeadPart(accInfo, bankName);
        end;
    end;

    macro printRow(document)
        if(document)
            var rowArray = RcbArray();
            rowArray[rowArray.size] = document.note;
            rowArray[rowArray.size] = document.statementLineNumber;
            rowArray[rowArray.size] = document.date_carry;
            rowArray[rowArray.size] = document.shifr_oper;
            rowArray[rowArray.size] = document.numb_document;
            rowArray[rowArray.size] = document.bic;
            rowArray[rowArray.size] = document.ground;
            rowArray[rowArray.size] = document.corrBankAcc;
            rowArray[rowArray.size] = document.account;
            rowArray[rowArray.size] = document.sumDebit;
            rowArray[rowArray.size] = document.sumCredit;
            rowArray[rowArray.size] = document.sumDebitEq;
            rowArray[rowArray.size] = document.sumCreditEq;

            m_partViewPool[m_partViewPool.size - 1].printRow(rowArray);
        else
            m_partViewPool[m_partViewPool.size - 1].printRow();
        end;
    end;

    macro printFooter(AccInfo, document)
        if((m_partIsOpened == true) or (m_isPrintTotalsByDays == true))
            m_partViewPool[m_partViewPool.size - 1].printFooter(AccInfo, document);
			m_partIsOpened = false;
        end;
    end;

    macro initializeLendingAgencyCodeZoneExcelView()
    end;

    macro initializeBaseNamesZoneExcelView()
    end;

    macro initializeBaseSignatureZoneExcelView()
    end;

    macro initializePartViews()
        m_partViewPool = RcbArray();
    end;

    macro defineFileName(parameters)
        var name;
        var dd;
        var mm;
        var yyyy;
        var dateIn;
        var dateOut;

        if (parameters.excelReportKind == REP_EXCEL_REPORT_KIND_ONE_FILE_BY_ACCOUNT)
            dateIn = parameters.initialDateIn;
            dateOut = parameters.initialDateOut;
        else
            dateIn = parameters.dateIn;
            dateOut = parameters.dateOut;
        end;

        dateSplit(dateIn, dd, mm, yyyy);
        dateIn = String(yyyy) + String(mm : 2 : 0 : o) + String(dd : 2 : 0 : o);

        dateSplit(dateOut, dd, mm, yyyy);
        dateOut = String(yyyy) + String(mm : 2 : 0 : o) + String(dd : 2 : 0 : o);


        if (dateIn == dateOut)
            name =       ternary(parameters.currency == NATCUR, "ordacc", "ordacc$")
                 + "_" + dateIn;
        else
            name =       ternary(parameters.currency == NATCUR, "ordacc", "ordacc$")
                 + "_" + dateIn
                 + "_" + dateOut;
        end;
        //name = name + "_new_";
        m_view.defineFileName(name);
    end;

    private macro constructorTAccountStatementReportExcelView(protocolView, isPrintTotalsByDays)
        initRcbReportExcelView("", "", arrCreate(RCB_PK_HALFYEAR, RCB_PK_QUARTER, RCB_PK_MONTH), DATE_IN_PERIOD_FORMAT, protocolView, true, false);

        m_partIsOpened        = false;
        m_isPrintTotalsByDays = isPrintTotalsByDays;
    end;

    constructorTAccountStatementReportExcelView(protocolView, isPrintTotalsByDays);
end;

