/*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
  Š­¨£  à¥£¨áâà æ¨¨ ®âªàëâëå áç¥â®¢
  ‚¥¤®¬®áâì ®âªàëâëå ¨ § ªàëâëå áç¥â®¢

  ®«ãç¥­¨¥ ¤ ­­ëå Loans

  File Name     : bk_opacc_Loans.mac
  Call functions: CalculateLoans
  Call from     : bk_opacc.mac
ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*/
import RsbObjFactory;
import cb_sql;
import SbCrdInter;
import rep_lib;

private var params;         /* ¯ à ¬¥âàë ®âçñâ  */


/****************************************************************************/
/*                                ’®çª  ¢å®¤                                */
/****************************************************************************/
MACRO CalculateLoans(parm, tempTableName )
    Message( "®«ãç¥­¨¥ ¤ ­­ëå RS-Loans" );

    params = parm;

    /* Ž¯â¨¬¨§ æ¨ï: ¢ Loans â®«ìª® ¢­ãâà¨¡ ­ª®¢áª¨¥ áç¥â  */
    if( ( params.AccountType != ‘ç¥â  ­ª  ) and ( params.AccountType != ‚á¥‘ç¥â  ) )
        return true;
    end;

    var accFilter;

    var fltrOpened = "    account.t_openDate  >= " + getSqlDate(params.beginDate)
            + "\n" + "AND account.t_openDate  <= " + getSqlDate(params.endDate);

    var fltrClosed = "    account.t_closeDate >= " + getSqlDate(params.beginDate)
            + "\n" + "AND account.t_closeDate <= " + getSqlDate(params.endDate);

    if (params.ReportKind == RegBook)

        if( params.NeedAccOpen and params.NeedAccClose )
            /* Žâªàëâë¥ å®âï ¡ë 1 ¤¥­ì ¢ â¥ç¥­¨¥ ¯¥à¨®¤  */
            accFilter = "    account.t_openDate <= " + getSqlDate(params.endDate)
               + "\n" + "AND (   account.t_closeDate >= " + getSqlDate(params.beginDate)
               + "\n" + "     OR account.t_closeDate < account.t_openDate"
               + "\n" + "    )";
        else    /* â®«ìª® ®âªàëâë¥ ¢ ¯¥à¨®¤. ‘¨âã æ¨î, ª®£¤  ­¨ ®¤­®£® ä« £ , ¯à®¢¥à¨«¨ ¢ äã­ªæ¨¨ Calculate.*/
            accFilter = fltrOpened;
        end;

    elif (params.ReportKind == OpenCloseList)

        if(   params.NeedAccOpen )
            if( params.NeedAccClose )
                accFilter = "(" + fltrOpened
                   + "\n" + " OR " + fltrClosed
                   + "\n" + ")";
            else
                accFilter = fltrOpened;
            end;
        elif( params.NeedAccClose )
            accFilter = fltrClosed;
        end;

    elif (params.ReportKind == RegBookOnDate)

        accFilter = "    account.t_openDate <= " + getSqlDate(params.endDate)
           + "\n" + "AND (   account.t_closeDate >= " + getSqlDate(params.endDate)
           + "\n" + "     OR account.t_closeDate < account.t_openDate"
           + "\n" + "    )";

    else

        RunError( "Žè¨¡ª  ¯à®£à ¬¬¨à®¢ ­¨ï: ­¥ª®àà¥ªâ­ë© ¢¨¤ ®âçñâ " );

    end;

    if (params.accountMask != "")
        accFilter = accFilter
          + "\n" + "AND (" + convertMaskToSqlFormat(params.accountMask, "account.t_account") + ")";
    end;

    // ¤«ï ¢ë¯ãáª  ¯® ¤ ­­ë¬ Šà¥¤¨â®¢ ­¨ï ¢á¥£¤  ¡¥à¥¬ ¯« ­ áç¥â®¢ 0
    accFilter = accFilter
          + "\n" + " AND " + getChapterFilterSqlClause(0, parm.chapter, "account.t_chapter");

    if (params.CurrencyId == ALLCURRENCY)

        accFilter = accFilter
          + "\n" + "AND account.t_fiId != " + NATCUR;

    elif (params.CurrencyId != ALLFININSTR)

        accFilter = accFilter
          + "\n" + "AND account.t_fiId  = " + params.CurrencyId;

    end;

    sql_execute("BEGIN"
       + "\n" + "   rsvoxprm.clearPrmMap;"
       + "\n" + "   rsvoxprm.setPrmVal('BeginDate', UTL_RAW.CAST_TO_RAW(TO_CHAR(" + getSqlDate(params.beginDate) + ", 'DD.MM.YYYY')));"
       + "\n" + "   rsvoxprm.setPrmVal('EndDate', UTL_RAW.CAST_TO_RAW(TO_CHAR(" + getSqlDate(params.endDate) + ", 'DD.MM.YYYY')));"
       + "\n" + "END;"
               );

    sql_execute("INSERT INTO " + tempTableName + " (t_account, t_accountCb, t_balance, t_open_Date, t_close_Date, t_client, t_nameAccount,"
       + "\n" + "                                   t_openGround, t_closeGround, t_contractNumber, t_contractDate, t_chapter, t_code_Currency,"
       + "\n" + "                                   t_backOffice, t_accountType, t_name_Account)"
       + "\n" + "    SELECT t_accountNumber, t_odbAccount, t_balance, t_openDate, t_closeDate,"
       + "\n" + "           " + {OurBank} + " AS t_client,"
       + "\n" + "           t_nameAccount, t_groundOpenAcc, t_groundCloseAcc, t_contractNumber, t_contractBegDate,"
       + "\n" + "           " + ChapterAll + " AS t_chapter,"
       + "\n" + "           " + ALLFININSTR + " AS t_code_Currency,"
       + "\n" + "           " + REP_SUBSYSTEMS_LOANS + " AS t_backOffice,"
       + "\n" + "           " + ‘ç¥â  ­ª  + " AS t_accountType,"
       + "\n" + "           NVL((SELECT b.t_name_part"
       + "\n" + "                  FROM dbalance_dbt b"
       + "\n" + "                 WHERE b.t_balance = account.t_balance"
       + "\n" + "                   AND b.t_chapter = account.t_chapter"
       + "\n" + "                   AND b.t_iNumPlan = " + params.getPlanNum() + ")"
       + "\n" + "              ,'') AS t_balanceName"
       + "\n" + "      FROM (SELECT account.t_account        AS t_accountNumber,"
       + "\n" + "                   account.t_cbAccount      AS t_odbAccount,"
       + "\n" + "                   CASE WHEN NOT account.t_cbAccount is NULL AND  account.t_cbAccount != CHR(1) THEN  SUBSTR(account.t_cbAccount, 1, 5 )"
       + "\n" + "                        WHEN NOT account.t_account is NULL   AND  account.t_account != CHR(1)   THEN  SUBSTR(account.t_account, 1, 5 )"
       + "\n" + "                        ELSE '00000'"
       + "\n" + "                   END AS t_balance,"
       + "\n" + "                   DECODE(MAX(account.t_id) OVER (PARTITION BY account.t_account), account.t_id, 1, 0) AS distinctCondition,"
       + "\n" + "                   account.t_openDate       AS t_openDate,"
       + "\n" + "                   account.t_closeDate      AS t_closeDate,"
       + "\n" + "                   account.t_name           AS t_nameAccount,"
       + "\n" + "                   NVL(account.t_openGround, CHR(1))     AS t_groundOpenAcc,"
       + "\n" + "                   NVL(account.t_closeGround, CHR(1))    AS t_groundCloseAcc,"
       + "\n" + "                   account.t_chapter        AS t_chapter,"
       + "\n" + "                   contract.t_number        AS t_contractNumber,"
       + "\n" + "                   contract.t_openDate      AS t_contractBegDate"
       + "\n" + "              FROM repLnsAccount_vw account,"
       + "\n" + "                   repLnsContract_vw contract"
       + "\n" + "             WHERE account.t_contractId = contract.t_id"
       + "\n" + "               AND account.t_isTechnical != 'X'"
       + "\n" + "               AND NOT (" + convertMaskToSqlFormat(Œ áª ‘ç¥â®¢Š«¨¥­â®¢, "account.t_account") + ")"
       + "\n" + "               AND contract.t_openDate <= " + getSqlDate(params.endDate)
       + "\n" + "               AND (contract.t_closeDate >= " + getSqlDate(params.beginDate)
       + "\n" + "                    OR contract.t_closeDate < contract.t_openDate"
       + "\n" + "                   )"
       + "\n" + "               AND contract.t_type IN (" + LO_CREDIT + "," + LO_KARTA + "," + LO_GUARANTEE + "," + LO_OVERDRAFT + ")"
       + "\n" + "               AND " + params.BranchAndDepartmentFieldFilter.getAsSqlString("contract.t_departmentId", "contract.t_branchId")
       + "\n" + "               AND " + accFilter + ") account"
       + "\n" + "     WHERE account.distinctCondition = 1"
       + "\n" + "       AND NOT EXISTS (SELECT 1 FROM " + tempTableName + " tmp WHERE tmp.t_account = account.t_accountNumber)"
               );

    return true;
END;
