/*
$Name:         bk_opacc_Deposits.mac
$Module:       ‚­ãâà¥­­ïï ®âç¥â­®áâì
$Description:  Š­¨£  à¥£¨áâà æ¨¨ ®âªàëâëå áç¥â®¢
*/
/*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
  Š­¨£  à¥£¨áâà æ¨¨ ®âªàëâëå áç¥â®¢
  ‚¥¤®¬®áâì ®âªàëâëå ¨ § ªàëâëå áç¥â®¢

  ®«ãç¥­¨¥ ¤ ­­ëå „¥¯®§¨â®¢ îà. «¨æ

  File Name     : bk_opacc_Deposits.mac
  Call functions: calculateDeposits
  Call from     : bk_opacc.mac
ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*/
import cb_sql;
import SbCrdInter;
import rep_lib;

private var params;         /* ¯ à ¬¥âàë ®âçñâ  */

const REQOPENA  = 230;
const REQCLOSEA = 231;
const nullDate= GetSqlDate(Date(0,0,0));

/****************************************************************************/
/*                                ’®çª  ¢å®¤                                */
/****************************************************************************/
MACRO calculateDeposits(parm, tempTableName)
    Message( "®«ãç¥­¨¥ ¤ ­­ëå „¥¯®§¨â®¢ îà. «¨æ" );

    params = parm;

    var accFilter;

    var fltrOpened = "    account.t_openDate  >= " + getSqlDate(params.beginDate)
            + "\n" + "AND account.t_openDate  <= " + getSqlDate(params.endDate);

    var fltrClosed = "    account.t_closeDate >= " + getSqlDate(params.beginDate)
            + "\n" + "AND account.t_closeDate <= " + getSqlDate(params.endDate);

    if (params.ReportKind == RegBook)

        if( params.NeedAccOpen and params.NeedAccClose )
            /* Žâªàëâë¥ å®âï ¡ë 1 ¤¥­ì ¢ â¥ç¥­¨¥ ¯¥à¨®¤  */
            accFilter = "    account.t_openDate <= " + getSqlDate(params.endDate)
               + "\n" + "AND (   account.t_closeDate >= " + getSqlDate(params.beginDate)
               + "\n" + "     OR account.t_closeDate < account.t_openDate"
               + "\n" + "    )";
        else    /* â®«ìª® ®âªàëâë¥ ¢ ¯¥à¨®¤. ‘¨âã æ¨î, ª®£¤  ­¨ ®¤­®£® ä« £ , ¯à®¢¥à¨«¨ ¢ äã­ªæ¨¨ Calculate.*/
            accFilter = fltrOpened;
        end;

    elif (params.ReportKind == OpenCloseList)

        if(   params.NeedAccOpen )
            if( params.NeedAccClose )
                accFilter = "(" + fltrOpened
                   + "\n" + " OR " + fltrClosed
                   + "\n" + ")";
            else
                accFilter = fltrOpened;
            end;
        elif( params.NeedAccClose )
            accFilter = fltrClosed;
        end;

    elif (params.ReportKind == RegBookOnDate)

        accFilter = "    account.t_openDate <= " + getSqlDate(params.endDate)
           + "\n" + "AND (   account.t_closeDate >= " + getSqlDate(params.endDate)
           + "\n" + "     OR account.t_closeDate < account.t_openDate"
           + "\n" + "    )";

    else

        RunError( "Žè¨¡ª  ¯à®£à ¬¬¨à®¢ ­¨ï: ­¥ª®àà¥ªâ­ë© ¢¨¤ ®âçñâ " );

    end;

    if (params.accountMask != "")
        accFilter = accFilter
          + "\n" + "AND (" + convertMaskToSqlFormat(params.accountMask, "account.t_account") + ")";
    end;

    // ¤«ï ¢ë¯ãáª  ¯® ¤ ­­ë¬ „¥¯®§¨â®¢ ¢á¥£¤  ¡¥à¥¬ ¯« ­ áç¥â®¢ 0
    accFilter = accFilter
          + "\n" + " AND " + getChapterFilterSqlClause(0, parm.chapter, "account.t_chapter");

    if (params.CurrencyId == ALLCURRENCY)

        accFilter = accFilter
          + "\n" + "AND account.t_fiId != " + NATCUR;

    elif (params.CurrencyId != ALLFININSTR)

        accFilter = accFilter
          + "\n" + "AND account.t_fiId  = " + params.CurrencyId;

    end;

    if (params.AccountType == ‘ç¥â  ­ª )
        accFilter = accFilter
          + "\n" + "AND account.t_type != '„'";
    elif (params.AccountType == ‘ç¥â Š«¨¥­â®¢)
        accFilter = accFilter
          + "\n" + "AND account.t_type = '„'";
    end;

    sql_execute("BEGIN"
       + "\n" + "   rsvoxprm.clearPrmMap;"
       + "\n" + "   rsvoxprm.setPrmVal('BeginDate', UTL_RAW.CAST_TO_RAW(TO_CHAR(" + getSqlDate(params.beginDate) + ", 'DD.MM.YYYY')));"
       + "\n" + "   rsvoxprm.setPrmVal('EndDate', UTL_RAW.CAST_TO_RAW(TO_CHAR(" + getSqlDate(params.endDate) + ", 'DD.MM.YYYY')));"
       + "\n" + "END;"
               );

    var TaxMsgFunc;
    if( „ â ‘®®¡é¥­¨ïŒ­á )
        TaxMsgFunc = "ps.PSREQ_GetMesFormDate";
    else
        TaxMsgFunc = "ps.PSREQ_GetMesSendDate";
    end;

    sql_execute("INSERT INTO " + tempTableName
       + "\n" + "("
       + "\n" + " t_account,"
       + "\n" + " t_accountCb,"
       + "\n" + " t_balance,"
       + "\n" + " t_open_date,"
       + "\n" + " t_close_date,"
       + "\n" + " t_client,"
       + "\n" + " t_nameAccount,"
       + "\n" + " t_openGround,"
       + "\n" + " t_closeGround,"
       + "\n" + " t_contractNumber,"
       + "\n" + " t_contractDate,"
       + "\n" + " t_chapter,"
       + "\n" + " t_code_currency,"
       + "\n" + " t_backOffice,"
       + "\n" + " t_accountType,"
       + "\n" + " t_TaxMsgOpenDate,"
       + "\n" + " t_TaxMsgCloseDate,"
       + "\n" + " t_name_account,"
       + "\n" + " t_extractPeriod"
       + "\n" + ")"
       + "\n" + "SELECT t_accountNumber,"
       + "\n" + "       t_odbAccount,"
       + "\n" + "       t_balance,"
       + "\n" + "       t_openDate,"
       + "\n" + "       t_closeDate,"
       + "\n" + "       t_client,"
       + "\n" + "       t_nameAccount,"
       + "\n" + "       t_groundOpenAcc,"
       + "\n" + "       t_groundCloseAcc,"
       + "\n" + "       t_contractNumber,"
       + "\n" + "       t_contractBegDate,"
       + "\n" + "       " + ChapterAll + " AS t_chapter,"
       + "\n" + "       " + ALLFININSTR + " AS t_code_currency,"
       + "\n" + "       " + REP_SUBSYSTEMS_DEPOSITS + " AS t_backOffice,"
       + "\n" + "       t_accountType,"
        + "\n" + "      CASE "
        + "\n" + "          WHEN (account.t_accountType = " + ‘ç¥â Š«¨¥­â®¢ + ")"
        + "\n" + "              THEN "
        + "\n" + "                  DECODE (" + TaxMsgFunc + "(" + REQOPENA + ", account.t_accountNumber, account.t_Chapter, account.t_Code_Currency, 0), " + nullDate + ", account.t_openDate,"
        + "\n" + "                          " + TaxMsgFunc + "(" + REQOPENA + ", account.t_accountNumber, account.t_Chapter, account.t_Code_Currency, 0))"
        + "\n" + "              ELSE " + nullDate
        + "\n" + "      END  t_TaxMsgOpenDate,"
        + "\n" + "       CASE "
        + "\n" + "           WHEN (account.t_accountType = " + ‘ç¥â Š«¨¥­â®¢ + ")"
        + "\n" + "               THEN "
        + "\n" + "                   CASE"
        + "\n" + "                       WHEN ((account.t_closeDate >= " + GetSQLDate(params.BeginDate) + ") AND (account.t_closeDate <= " + GetSQLDate(params.EndDate) + "))"
        + "\n" + "                           THEN  DECODE (" + TaxMsgFunc + "(" + REQCLOSEA + ", account.t_accountNumber, account.t_Chapter, account.t_Code_Currency, 0), " + nullDate + ", account.t_closeDate,"
        + "\n" + "                                         " + TaxMsgFunc + "(" + REQCLOSEA + ", account.t_accountNumber, account.t_Chapter, account.t_Code_Currency, 0))"
        + "\n" + "                           ELSE account.t_closeDate"
        + "\n" + "                   END "
        + "\n" + "               ELSE " + nullDate
        + "\n" + "       END  t_TaxMsgCloseDate,"
       + "\n" + "       NVL((SELECT b.t_name_part"
       + "\n" + "              FROM dbalance_dbt b"
       + "\n" + "             WHERE b.t_balance = account.t_balance"
       + "\n" + "               AND b.t_chapter = account.t_chapter"
       + "\n" + "           ), (SELECT b.t_name_part"
       + "\n" + "                 FROM dbalance_dbt b"
       + "\n" + "                WHERE b.t_balance = account.t_balance"
       + "\n" + "                  AND rowNum < 2)"
       + "\n" + "          ) AS t_balanceName,"
       + "\n" + "       CHR(1)"
       + "\n" + "  FROM (SELECT account.t_account        AS t_accountNumber,"
       + "\n" + "               account.t_cbAccount      AS t_odbAccount,"
       + "\n" + "               CASE"
       + "\n" + "                   WHEN account.t_cbAccount IS NOT NULL"
       + "\n" + "                     AND account.t_cbAccount != CHR(1)"
       + "\n" + "                    THEN SUBSTR(account.t_cbAccount, 1, 5)"
       + "\n" + "                    WHEN account.t_account IS NOT NULL"
       + "\n" + "                     AND account.t_account != CHR(1)"
       + "\n" + "                    THEN  SUBSTR(account.t_account, 1, 5)"
       + "\n" + "                    ELSE '00000'"
       + "\n" + "               END                      AS t_balance,"
       + "\n" + "               DECODE(MAX(account.t_id) OVER (PARTITION BY account.t_account), account.t_id, 1, 0) AS t_distinctCondition,"
       + "\n" + "               account.t_openDate       AS t_openDate,"
       + "\n" + "               account.t_closeDate      AS t_closeDate,"
       + "\n" + "               account.t_name           AS t_nameAccount,"
       + "\n" + "               NVL(account.t_openGround, CHR(1))     AS t_groundOpenAcc,"
       + "\n" + "               NVL(account.t_closeGround, CHR(1))    AS t_groundCloseAcc,"
       + "\n" + "               account.t_chapter        AS t_chapter,"
       + "\n" + "               account.t_fiid        AS t_Code_Currency,"
       + "\n" + "               CASE"
       + "\n" + "                   WHEN account.t_type = '„'"
       + "\n" + "                   THEN contract.t_contragentId"
       + "\n" + "                   ELSE (SELECT ts.t_partyId"
       + "\n" + "                           FROM drepdpdep_vw ts"
       + "\n" + "                          WHERE ts.t_nodeId = account.t_departmentId"
       + "\n" + "                        )"
       + "\n" + "               END AS t_client,"
       + "\n" + "               CASE"
       + "\n" + "                   WHEN account.t_type = '„'"
       + "\n" + "                   THEN " + ‘ç¥â Š«¨¥­â®¢
       + "\n" + "                   ELSE " + ‘ç¥â  ­ª 
       + "\n" + "               END AS t_accountType,"
       + "\n" + "               contract.t_number        AS t_contractNumber,"
       + "\n" + "               contract.t_openDate      AS t_contractBegDate"
       + "\n" + "          FROM repLnsAccount_vw account,"
       + "\n" + "               repLnsContract_vw contract"
       + "\n" + "         WHERE account.t_contractId = contract.t_id"
       + "\n" + "           AND account.t_isTechnical != 'X'"
       + "\n" + "           AND contract.t_openDate <= " + getSqlDate(params.endDate)
       + "\n" + "           AND (contract.t_closeDate >= " + getSqlDate(params.beginDate)
       + "\n" + "                OR contract.t_closeDate < contract.t_openDate"
       + "\n" + "               )"
       + "\n" + "           AND contract.t_type = " + LO_DEPOSIT
       + "\n" + "           AND " + params.BranchAndDepartmentFieldFilter.getAsSqlString("contract.t_departmentId", "contract.t_branchId")
       + "\n" + "           AND " + accFilter
       + "\n" + "       ) account"
       + "\n" + " WHERE account.t_distinctCondition = 1"
       + "\n" + "   AND NOT EXISTS (SELECT 1 FROM " + tempTableName + " tmp WHERE tmp.t_account = account.t_accountNumber)"
               );

    return true;
END;
