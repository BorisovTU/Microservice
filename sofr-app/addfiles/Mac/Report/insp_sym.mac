import  rslscr, globals, ctrl_sym;

private var dat_beg = {curdate},
            dat_end = {curdate},
            dl,
            iRealPlanNum = 0;

private const  F1 = 315, F2 = 316,
               BS = CodeFor(" ");

private var organizationStructure : Integer;
private var issueMode : Integer;

Rep_GetDefaultParmTS(organizationStructure, issueMode);

private var departmentList = RepDepartmentList(organizationStructure, issueMode, {operDprt});

/*-------------------------------------------------------------------*/
macro EvMacro( dl, cmd, id, key )
        var opd = NULL;

        if ( (cmd == DLG_REMFOCUS) or (cmd==DLG_SAVE) )
                    /* Проверка введенного значения*/
           if (dl.rec.dt_beg > dl.rec.dt_end)
                msgbox("Дата конца расчета должна быть больше даты начала");
                return CM_CANCEL;

           elif((dl.rec.dt_beg == Date( 0, 0, 0 ))or(dl.rec.dt_end == Date( 0, 0, 0 )))
                msgbox("Некорректная дата");
                return CM_CANCEL;


           elif((dl.rec.dt_end > {curdate})and(id == 1))
                msgbox("Дата конца расчета не может быть больше даты текущего опердня");
                return CM_CANCEL;
           else
                UpdateFields(dl);
           end;
        elif (cmd == DLG_KEY)
           if  ( (key == F1) or (key == F9) )
             return CM_IGNORE;
           elif (key == F2)
             dat_beg = dl.rec.dt_beg;
             dat_end = dl.rec.dt_end;

             opd = RepOperdaysOpened(departmentList, dat_beg, dat_end);
             if (opd.ShouldContinue() == true)
                 Report(iRealPlanNum, dat_beg, dat_end);
                 return CM_SAVE;
             else
                 return CM_IGNORE;
             end;
           elif ((key == ENTER) and (id == 1))/*!!! Изменяя колличество полей для ввода, не забывать изменять id */
             SetFocus(dl, 0);                 /*Для исправления странной ошибки в RunDialog: Если нажат в последнем поле Enter - выдаtncz пустое окно. */
             return CM_IGNORE;
           end;
        end;
        return CM_DEFAULT;
end;


/*-------------------------------------------------------------------*/
MACRO InitDialog
  Var LBRName="", err, ret_type, id;

  ret_type = GetRegistryValue( "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ФАЙЛЫ\\LBRNAME",
                               V_STRING,
                               LBRName,
                               err
                             );

  if ( (LBRName == "") OR (ret_type != V_STRING))
    msgbox( "Ошибки в настройках банка: BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ФАЙЛЫ\\LBRNAME\
             |Используем библиотеку по умолчанию :  UserMac.lbr");
    LBRName = "usermac.lbr";
  end;

  if ( not ExistFile(LBRName) )
    MsgBox( "Не найдена библиотека ресурсов " + LBRName);
    exit(1);
  end;

  dl = TRecHandler("PR_INSPS", LBRName, TRUE);
  
  dl.rec.dt_beg = dat_beg;
  dl.rec.dt_end = dat_end;

  if ( not RunDialog( dl,"EvMacro") )
    Exit(1);
  end;

END;

/*╔══════════════════════════╗
  ║ Точка входа в программу  ║
  ╚══════════════════════════╝*/

InitDialog;

/*eof*/

