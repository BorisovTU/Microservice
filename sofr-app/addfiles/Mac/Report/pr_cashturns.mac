/*
$Name:        pr_cashturns.mac
$Module:      Внутренняя отчетность
$Description: Ведомость кассовых оборотов
*/

/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.0                                           R-Style Software Lab

  File Name   : pr_cashturns.mac                             August 12, 2005
  Programmer  : Alexander A. Zaitsev (BugZ).
  Description :
  Comment     : CCashTurnsTableReport - отчет.
  Modify      :
                19.01.2006 ABP SCR 81618 Оптимизация + исправление ошибок
                19.07.2006 Ivkina  Указание 1660-У
└───────────────────────────────────────────────────────────────────────────*/

import FIInter;
import TReport;         /* Класс отчета */
import param;           /* Руководитель, Главный бухгалтер */
import RsbDataSet;      /* TRsbDataSet */
import cb_sql;          /* GetSQLString */
import reporting;       /* RepDocumentFilter */

import repconst;
import BankInter;

record accountBuffer( account );

private const DEBET_TYPE_SYMBOL  = 1;
private const CREDIT_TYPE_SYMBOL = 2;
private const OFFBAL_TYPE_SYMBOL = 3;

private var departmentNumber;
//private var ЛогическийПланСчетов = 0;
var protocolFileName =  GetTxtFileName( "cashturns_p" );
var reportFileName   =  GetTxtFileName( "cashturns_r" );

private var bufferFileName1  =  GetTxtFileName( "cashturns_b1" );
private var bufferFileName2  =  GetTxtFileName( "cashturns_b2" );
private var bufferFileName3  =  GetTxtFileName( "cashturns_b3" );

private var cashTurnsTableReport;

private var ДАТА1_1660У = date(1, 4, 2006); /* Значение по умолчанию */
private var ДАТА_1881У  = date(1, 1, 2008); /* Значение по умолчанию */
private var ДАТА_2500У  = date(24, 10, 2010); /* Значение по умолчанию */

var OneFilePrint;/*флаг вывода в один файл протокола и отчета*/

/* 27.03.2006 ABP Скопировано из ReptReg\chk_regd.mac */
private macro GetRegDateDefault(Dat, Path, msg)
 local macro LastDayInMonth( cDate )
     var cDay, cMonth,  cYear;

     DateSplit( cDate, cDay, cMonth, cYear);
     cMonth = cMonth + 1;
     if ( cMonth == 13 )
       cMonth = 1;
       cYear = cYear + 1;
     end;

     cDate = date( 1, cMonth, cYear);
     DateSplit( cDate-1, cDay, cMonth, cYear);

     return cDay;
 end;

 var  type_val, Val, err = 0, k, delimstr = "-/.:",
      tmpVal, day, mon, year;

   if ( valtype(Dat) == V_UNDEF  ) Dat = date(0,0,0);
   end;
   if ( StrBrk (Path, "\\/") == 0 )
          Path = "REPTREG\\REP_GROUPS\\COMMON\\" + Path;
   end;
   if ( valtype(msg) == V_UNDEF  ) msg = TRUE;
   end;

   type_val = GetRegistryValue( Path, V_STRING, Val, err );
   if ( ( err != 0 ) or (type_val != V_STRING) )
        err = 1;
        if ( msg  )
          MsgBox( "Ошибка чтения ключа |", Path ,",|используется значение по умолчанию ", dat );
        end;
   end;

   if ( ( err == 0 ) and (Val != "") )
      tmpVal = trim( Val );
      k = StrBrk (tmpVal, delimstr);
      if ( k == 0 )
        err = 1;
        if ( msg  )
          MsgBox( "Неверный формат даты в настройке|", Path," :|", Val,",|используется значение по умолчанию ", dat );
        end;
      end;
   end;

   if ( ( err == 0 ) and (Val != "") )
     day = int(SubStr( tmpVal, 1, k-1));
     tmpVal = SubStr( tmpVal, k+1);
     k = StrBrk (tmpVal, delimstr);
     if ( k == 0 )
        err = 1;
        if ( msg  )
          MsgBox( "Неверный формат даты в настройке|", Path," :|", Val,",|используется значение по умолчанию ", dat );
        end;
     end;
   end;

   if ( ( err == 0 ) and (Val != "") )
     mon = int(SubStr( tmpVal, 1, k-1));
     tmpVal = SubStr( tmpVal, k+1);
     year = int(tmpVal);
     if  ( ( year == 0) and (mon == 0) and (day == 0) ) ;  /* Нулевая дата OK*/
     elif( ( year > 0 ) and
           ( mon > 0 )  and ( mon < 13 ) and
           ( day > 0 )  and ( day <= LastDayInMonth(date(day,mon, year) ) )
         )
        Dat = date(day,mon, year);
     else
        err = 1;
        if ( msg  )
          MsgBox( "Неверная дата в настройке|", Path," :|", Val,",|используется значение по умолчанию ", dat );
        end;
     end;
   end;

   SetParm(0, Dat );
   return  err;
end;

macro MakeLenStr( str, len )
 var   l = strlen(str);
   if   ( l < len ) return  str + mkstr( " ", len - l );
   elif ( l > len ) return  substr( str, len );
   else return str;
   end;
end;

var RestBTime, RestETime, AllBTime, AllETime; /* Debug information */

macro PrintColumns( reportFileName, nameFile1, nameFile2, nameFile3, wide )

  file file1() txt;
  file file2() txt;
  file file3() txt;


  SetOutPut( reportFileName, TRUE );

  if ( not open( file1, nameFile1 ) )
    exit( 0, "Не открыт временный файл " + NameFile1 );
  end;

  if ( not open( file2, NameFile2 ) )
    exit( 0, "Не открыт временный файл " + NameFile2 );
  end;

    if ( not open( file3, NameFile3 ) )
    exit( 0, "Не открыт временный файл " + NameFile3 );
  end;

  while( next(file1) )  /* пока есть строки в 1-м */
     print( MakeLenStr( file1.str, Wide ) );
     if ( next(file2) )
       print( "   "+ file2.str );
       if ( next(file3) )
         print( "   "+ file3.str );
       end;
     end;
     println( "" );
  end;

  while( next(file2) )  /* пока есть строки в 2-м */
      print( mkstr(" ", Wide) + "   " + file2.str );
      if ( next(file3) )
         print( "   "+ file3.str );
      end;
      println( "" );
  end;

  while( next(file3) )  /* пока есть строки в 3-м */
      println( mkstr(" ", Wide*2)+ "   " + "   " + file3.str );
  end;

  close( file1 );
  close( file2 );
  close( file3 );

end;


macro View( name_log, need_mes )
  FILE  f_out () txt;

  SetOutput( NULL );

  if ( ExistFile(name_log,0) and  open( f_out, name_log ) )
      viewFile( f_out );
      close( f_out );
      return TRUE;
  elif ( (need_mes == NULL) or (need_mes) )  /* сообщение по умолчанию */
    msgbox( "Не найден файл протокола: |", name_log );
  end;
  return FALSE;
end;

/*  Фильтр на рублевые лицевые счета для получения оборотов и остатков на балансовых счетах ( расчет через интеры ) */
macro RoubleBalanceAccountsFilter()
    var rc = ( index( accountBuffer.Type_Account, "А" ) != 0 ) and ( index( accountBuffer.Type_Account, "П" ) == 0 ) and  cashTurnsTableReport.AccountFilter.IsSuitable(accountBuffer);

    return rc;
end;


class DKR2
  var InRest, Debet, Kredit, OutRest;

  macro SetValues( In, D, K, Out)
    InRest = In; Debet = D; Kredit = K; OutRest = Out;
  end;

  macro Printable
    return string( "In = ", InRest, ", D = ", Debet, ", K = ", Kredit, ", Out = ", OutRest);
  end;

end;

class Balances(Bal, Source)
  private var BalanceArr,
              ArrSize,
              Counter;

  var Balance;

  macro Next()
    Counter = Counter+1;
    if (Counter < ArrSize)
      Balance = BalanceArr[Counter];
      return true;
    end;
    Counter = -1; /* автоматически переходим в начало списка */
    return false;
  end;

  macro Printable()
    var i = 0, str = "";

    while(i < ArrSize)
      str = str+string(BalanceArr[i]:14);
      i = i+1;
    end;

    return str;
  end;

  /* Constructor */
  Balance    = "";
  BalanceArr = TArray();
  ArrSize    = 0;
  Counter    = -1;

  if (Source.MoveFirst())
    if (substr(Source.Balance, 1, strlen(Bal)) == Bal)
      BalanceArr[ArrSize] = Source.Balance;
      ArrSize = ArrSize+1;
    end;
    while(Source.MoveNext())
      if (substr(Source.Balance, 1, strlen(Bal)) == Bal)
        BalanceArr[ArrSize] = Source.Balance;
        ArrSize = ArrSize+1;
      end;
    end;
  end;
end;

macro RestB_RubOnly( NumPlan, Balance, Date1, Date2, Chapter);
var
   Sum = $0;

  if ( (ValType( Chapter) == V_INTEGER) and (Chapter != 1) ) /* Внебалансовые данные */
    while(Balance.Next)
      Sum = Sum+RestB( NumPlan, Balance.Balance, Date1, date2, Chapter, "ФильтрРублевыхВнеБалансовыхЛС", "НбaccountBuffer");
    end;
  else
    while(Balance.Next)
      Sum = Sum+RestB( NumPlan, Balance.Balance, Date1, date2, Chapter, "RoubleBalanceAccountsFilter", "accountBuffer");
    end;
  end;

  return Sum;
end;

macro DebetB_RubOnly( NumPlan, Balance, Date1, Date2, Chapter);
var
   Sum = $0;

  if ( (ValType( Chapter) == V_INTEGER) and (Chapter != 1) ) /* Внебалансовые данные */
    while(Balance.Next)
      Sum = Sum+DebetB( NumPlan, Balance.Balance, Date1, date2, Chapter, "ФильтрРублевыхВнеБалансовыхЛС", "НбaccountBuffer");
    end;
  else
    while(Balance.Next)
      Sum = Sum+DebetB( NumPlan, Balance.Balance, Date1, date2, Chapter, "RoubleBalanceAccountsFilter", "accountBuffer");
    end;
  end;

  return Sum;
end;

macro KreditB_RubOnly( NumPlan, Balance, Date1, Date2, Chapter);
  var Sum = $0;

  if ( (ValType( Chapter) == V_INTEGER) and (Chapter != 1) ) /* Внебалансовые данные */
    while(Balance.Next)
      Sum = Sum+KreditB( NumPlan, Balance.Balance, Date1, date2, Chapter, "ФильтрРублевыхВнеБалансовыхЛС", "НбaccountBuffer");
    end;
  else
    while(Balance.Next)
      Sum = Sum+KreditB( NumPlan, Balance.Balance, Date1, date2, Chapter, "RoubleBalanceAccountsFilter", "accountBuffer");
    end;
  end;

  return Sum;
end;


private macro GetSpecialSymbols( symbol35, symbol70, turnDebet, turnCredit, periodBegin, periodEnd )
        var sum20202 = DKR2;
        var sum20206 = DKR2;
        var sum20207 = DKR2;
        var sum20208 = DKR2;

        var Символ_35;
        var Символ_70;
        var Оборот_дебет;
        var Оборот_кредит;

        /* Обработка "нестандартных" символов (в данном случае символов типа остаток) */
        /* Активные остатки - отрицательные */
        /* Надо брать остатки за предыдущий день, так как остаток указывается
           на конец опердня ( = остаток на утро следующего дня ) */

//        var iRealPlanNum = ПолучитьРеальныйНомерПлана( ЛогическийПланСчетов, "А");
        var iRealPlanNum = 0;

        var blnc = TRsbDataSet(
                               "SELECT t_Balance FROM dbalance_dbt "                       +
                               "WHERE t_iNumPlan = "+iRealPlanNum                          +
                               "AND (t_Balance LIKE '20202%' OR t_Balance LIKE '20206%' "  +
                               "  OR t_Balance LIKE '20207%' OR t_Balance LIKE '20208%') " +
                               "AND t_Chapter = 1 ORDER BY t_Balance",
                               RSDVAL_CLIENT, RSDVAL_STATIC
                              );

        var Bl20202 = Balances("20202", blnc);
        var Bl20206 = Balances("20206", blnc);
        var Bl20207 = Balances("20207", blnc);
        var Bl20208 = Balances("20208", blnc);

        sum20202.InRest = -RestB_RubOnly( iRealPlanNum, Bl20202, periodBegin - 1);
        //sum20206.InRest = -RestB_RubOnly( iRealPlanNum, Bl20206, periodBegin - 1);
        sum20207.InRest = -RestB_RubOnly( iRealPlanNum, Bl20207, periodBegin - 1);

        sum20202.OutRest = -RestB_RubOnly( iRealPlanNum, Bl20202, periodEnd);
        //sum20206.OutRest = -RestB_RubOnly( iRealPlanNum, Bl20206, periodEnd);
        sum20207.OutRest = -RestB_RubOnly( iRealPlanNum, Bl20207, periodEnd);

        sum20202.Debet = DebetB_RubOnly( iRealPlanNum, Bl20202, periodBegin, periodEnd);
        //sum20206.Debet = DebetB_RubOnly( iRealPlanNum, Bl20206, periodBegin, periodEnd);
        sum20207.Debet = DebetB_RubOnly( iRealPlanNum, Bl20207, periodBegin, periodEnd);

        sum20202.Kredit = KreditB_RubOnly( iRealPlanNum, Bl20202, periodBegin, periodEnd);
        //sum20206.Kredit = KreditB_RubOnly( iRealPlanNum, Bl20206, periodBegin, periodEnd);
        sum20207.Kredit = KreditB_RubOnly( iRealPlanNum, Bl20207, periodBegin, periodEnd);

        /*
        println("20202: ", sum20202.Printable, ", Balances: ", Bl20202.Printable); /* Debug information */
        println("20206: ", sum20206.Printable, ", Balances: ", Bl20206.Printable); /* Debug information */
        println("20207: ", sum20207.Printable, ", Balances: ", Bl20207.Printable); /* Debug information */
        println("20208: ", sum20208.Printable, ", Balances: ", Bl20208.Printable); /* Debug information */
        */

        Символ_35     = sum20202.InRest  + sum20207.InRest;
        Символ_70     = sum20202.OutRest + sum20207.OutRest;
        Оборот_дебет  = sum20202.Debet   + sum20207.Debet;
        Оборот_кредит = sum20202.Kredit  + sum20207.Kredit;  

        if (periodEnd < ДАТА_1881У)
            sum20208.InRest  = -RestB_RubOnly( iRealPlanNum, Bl20208, periodBegin - 1);
            sum20208.OutRest = -RestB_RubOnly( iRealPlanNum, Bl20208, periodEnd);
            sum20208.Debet   = DebetB_RubOnly( iRealPlanNum, Bl20208, periodBegin, periodEnd);
            sum20208.Kredit  = KreditB_RubOnly( iRealPlanNum, Bl20208, periodBegin, periodEnd);

            Символ_35     =  Символ_35     + sum20208.InRest;
            Символ_70     =  Символ_70     + sum20208.OutRest;
            Оборот_дебет  =  Оборот_дебет  + sum20208.Debet ;
            Оборот_кредит =  Оборот_кредит + sum20208.Kredit;
        end;

        if (periodEnd < ДАТА_2500У)
            sum20206.InRest  = -RestB_RubOnly( iRealPlanNum, Bl20206, periodBegin - 1);
            sum20206.OutRest = -RestB_RubOnly( iRealPlanNum, Bl20206, periodEnd);
            sum20206.Debet   = DebetB_RubOnly( iRealPlanNum, Bl20206, periodBegin, periodEnd);
            sum20206.Kredit  = KreditB_RubOnly( iRealPlanNum, Bl20206, periodBegin, periodEnd);

            Символ_35     =  Символ_35     + sum20206.InRest;
            Символ_70     =  Символ_70     + sum20206.OutRest;
            Оборот_дебет  =  Оборот_дебет  + sum20206.Debet ;
            Оборот_кредит =  Оборот_кредит + sum20206.Kredit;
        end;

        SetParm( 0, Символ_35     );
        SetParm( 1, Символ_70     );
        SetParm( 2, Оборот_дебет  );
        SetParm( 3, Оборот_кредит );
end;

/**
 * Фильтр счета по номеру балансового счета и типу счета.
 *
 * @param     isIncludeFilter фильтр является включающим/исключающим
 * @param     balanceMask     маска балансовых счетов
 * @param     ...             списки типов счетов (исключающий список содержит символ "!" в начале)
 */
class TSpecialAccountFilter(isIncludeFilter, balanceMask)
    private var m_isIncludeFilter = isIncludeFilter;
    private var m_balanceMask     = balanceMask;
    private var m_includedTypes = TArray();
    private var m_excludedTypes = TArray();

    macro getIncludeFilter(balanceAlias, accountTypeAlias, currencyAlias) : string
        var result = "(" + convertMaskToSqlFormat(m_balanceMask, balanceAlias);

        var i = 0;
        while (i < m_includedTypes.size)
            result = result
                + "\n AND INSTR(" + accountTypeAlias + ", '" + m_includedTypes[i] + "') != 0";
            i = i + 1;
        end;

        i = 0;
        while (i < m_excludedTypes.size)
            result = result
                + "\n AND INSTR(" + accountTypeAlias + ", '" + m_excludedTypes[i] + "') = 0";
            i = i + 1;
        end;

        result = result + "\n AND " + currencyAlias + " = " + NATCUR;

        return result + ")";
    end;

    macro getExcludeFilter(balanceAlias, accountTypeAlias, currencyAlias) : string
        return "(not " + getIncludeFilter(balanceAlias, accountTypeAlias, currencyAlias) + ")";
    end;

    macro getFilter(balanceAlias, accountTypeAlias, currencyAlias) : string
        if (m_isIncludeFilter)
            return getIncludeFilter(balanceAlias, accountTypeAlias, currencyAlias);
        else
            return getExcludeFilter(balanceAlias, accountTypeAlias, currencyAlias);
        end;
    end;

    // инициализация
    private var i = 0;
    private var types;

    private macro fill(to:TArray, from:string)
        var i = 0;
        var count = strlen(from);
        while (i < count)
            i = i + 1;
            to[to.size] = substr(from, i, 1);
        end;
    end;

    while(getParm(3 + i, types))
        if (strlen(types) > 0)
            if (substr(types, 1, 1) == "!")
                fill(m_excludedTypes, substr(types, 2))
            else
                fill(m_includedTypes, types)
            end;
        end;
        i = i + 1;
    end;

end;

/**
 * Рассчитать значение символа по оборотам.
 *
 * @param     symbol             символ для расчета
 * @param     isIncome           символ прихода
 * @param     debetBalanceMask   маска балансовых счетов по дебету
 * @param     creditBalanceMask  маска балансовых счетов по кредиту
 */
private macro GetSpecialSymbols1881(symbol, isIncome, debetAccFilter : object, creditAccFilter : object, periodBegin, periodEnd, accountFilter)

        var queryText;
        var dataSet;
        var symbolSumma    = $0;
        var iRealPlanNum   = 0;

        queryText =      "SELECT "
                + "\n" + "       NVL(SUM(accTrn.t_sum_natCur), 0) AS t_value"
                + "\n" + "  FROM daccTrn_dbt accTrn,"
                + "\n" + "       daccbalance_dbt accBalance_debet,"
                + "\n" + "       daccbalance_dbt accBalance_credit,"
                + "\n" + "       daccount_dbt account_debet,"
                + "\n" + "       daccount_dbt account_credit"
                + "\n" + " WHERE accTrn.t_chapter = 1"
                + "\n" + "   AND accTrn.t_date_carry BETWEEN " + getSqlDate(periodBegin) + " AND " + getSqlDate(periodEnd)
                + "\n" + "   AND accTrn.t_state = 1"
                + "\n" + "   AND accBalance_debet.t_accountId = accTrn.t_accountId_payer"
                + "\n" + "   AND accBalance_debet.t_numPlan = 0"
                + "\n" + "   AND account_debet.t_accountId = accTrn.t_accountId_payer"
                + "\n" + "   AND accBalance_credit.t_accountId = accTrn.t_accountId_receiver"
                + "\n" + "   AND accBalance_credit.t_numPlan = 0"
                + "\n" + "   AND account_credit.t_accountId = accTrn.t_accountId_receiver"
                + "\n" + "   AND " +  debetAccFilter.getFilter("accBalance_debet.t_balance", "account_debet.t_type_account", "account_debet.t_code_currency")
                + "\n" + "   AND " + creditAccFilter.getFilter("accBalance_credit.t_balance", "account_credit.t_type_account", "account_credit.t_code_currency")
                + "\n" + "   AND " + accountFilter.getAsSqlString(ternary(isIncome, "account_debet", "account_credit"));

        dataSet = TRsbDataSet(queryText);
        dataSet.SetFieldType("t_value", V_MONEY);

        while (dataSet.moveNext())
            symbolSumma = dataSet.value;
        end;

        SetParm( 0, symbolSumma );
end;


class (CTableReport) CDifferenceReport()

    InitCTableReport( 0, FALSE, FALSE );

    private var m_isEmpty = true;

    macro IsEmpty()
        return m_isEmpty;
    end;


    AddColumn( "Внимание!", 40, AL_CENTER );
    AddColumn( "Сумма расхождения", 40  );

    Macro PrintError( error, difference );
        if ( m_isEmpty )
            m_isEmpty = false;
            PrintHead( "СПИСОК РАСХОЖДЕНИЙ" );
        end;

        PrintStringTransferByWord( error, moneyl(difference) );
    End;

    Macro PrintBottom()
        if ( not m_isEmpty )
            PrintBottom();
        end;
    end;

end;



class (CTableReport) CTurnsReport()

    InitCTableReport( 0, FALSE, FALSE );

    private var m_isEmpty = true;

    macro IsEmpty()
        return m_isEmpty;
    end;


    AddColumn( "Дата проводки", 20  );
    AddColumn( "Номер проводки", 20  );
    AddColumn( "Сумма", 20  );
    AddColumn( "Кассовый символ", 20  );
    AddColumn( "Счет по дебету", 20  );
    AddColumn( "Счет по кредиту", 20  );

    Macro PrintError( carryDate, carryNumber, sum, cashSymbol, accountPayer, accountReceiver );
        if ( m_isEmpty )
            m_isEmpty = false;
            PrintHead( "СПИСОК ПРОВОДОК БЕЗ СИМВОЛОВ И С НЕКОРРЕКТНЫМИ СИМВОЛАМИ" );
        end;

        PrintStringTransferByWord( carryDate, carryNumber, moneyl(sum), cashSymbol, accountPayer, accountReceiver );
    End;

    Macro PrintBottom()
        if ( not m_isEmpty )
            PrintBottom();
        end;
    end;

end;

class (CTableReport) CColumnReport(columnName)
    /* Конструктор */
    InitCTableReport( 0, FALSE, FALSE );


    AddColumn( columnName, 20 );
    AddColumn( "Сумма", 20 );

end;



class (CTableReport) CCashTurnsTableReport( departmentNumber, organizationStructure, issueMode, periodBegin, periodEnd, twoColumnsPrint )
    /* Конструктор */
    InitCTableReport( 0, FALSE, FALSE );

    private var m_departmentNumber = departmentNumber;
    private var m_periodBegin      = periodBegin;
    private var m_periodEnd        = periodEnd;
    private var m_twoColumnsPrint  = twoColumnsPrint;
    private var m_bankName         = {Name_Bank};
    private var m_bossPosition     = {Name_Boss};
    private var m_bookPosition     = {Name_Book};
    private var m_bossName         = {FIO_Boss};
    private var m_bookName         = {FIO_Book};

    private var m_Column1;
    private var m_Column2;
    private var m_Column3;

    private var m_DepartmentList = RepDepartmentList( organizationStructure, issueMode, departmentNumber );
    private var m_DocumentFilter = RepDocumentFilter( m_DepartmentList );
    private var m_AccountFilter  = RepAccountFilter ( m_DepartmentList, PRIV_GET_ACCOUNT_DATA_FOR_REPORTS );

    private var m_isEmpty = true;

    if ( m_twoColumnsPrint )
        m_Column1 = CTableReport( 0, FALSE, FALSE );
        m_Column2 = CTableReport( 0, FALSE, FALSE );
        m_Column3 = CTableReport( 0, FALSE, FALSE );
    end;

    macro ShouldContinue()
      return RepOperdaysOpened(m_DepartmentList, m_periodBegin, m_periodEnd).ShouldContinue();
    end;

    macro AccountFilter()
       return m_AccountFilter;
    end;


    private macro GetExecutiveName()

        macro GetExecutiveQuery()
            return string("SELECT t_name FROM dperson_dbt WHERE t_oper = ", {oper} );
        end;

        var executiveQuery = GetExecutiveQuery();
        var executive      = TRsbDataSet( executiveQuery );

        if ( executive.MoveNext() )
            return executive.Name;
        else
            return "";
        end;
    end;

    private var m_executiveName    = GetExecutiveName();

    if ( m_bankName == "" )
        MsgBox("Предупреждение: кредитная организация не определена!");
    elif ( m_bossPosition == "" )
        MsgBox("Предупреждение: руководитель не определен!");
    elif ( m_bookPosition == "" )
        MsgBox("Предупреждение: главный бухгалтер не определен!");
    elif ( m_executiveName == "" )
        MsgBox("Предупреждение: исполнитель не определен!");
    end;

    /* Методы */
    private macro PrintSpecificHeader()
        var month;
        var year;

        macro LastDayInMonth( cDate )
           var cDay, cMonth,  cYear;

           DateSplit( cDate, cDay, cMonth, cYear);
           cMonth = cMonth + 1;
           if ( cMonth == 13 )
             cMonth = 1;
             cYear = cYear + 1;
           end;

           cDate = date( 1, cMonth, cYear);
           DateSplit( cDate-1, cDay, cMonth, cYear);

           return cDay;
        end;

        macro PeriodType (pBegin, pEnd): integer /*Определяем тип периода по датам его начала и конца*/
          var type, Bday, Bmonth, Byear, Eday, Emonth, Eyear;

          DateSplit(pBegin, Bday, Bmonth, Byear);
          DateSplit(pEnd, Eday, Emonth, Eyear);
            type = 0;
            if(pBegin == pEnd)
              /*день*/
              type = 1;
            elif ((Bmonth == Emonth) and (Byear == Eyear) and (Bday == 1) and (Eday == LastDayInMonth(pBegin)))
              /*месяц*/
              type = 2;
            else
              /*период*/
              type = 4;
            end;

          return type;
        end;

        macro ComposePeriodString()
          var Type;

          Type = PeriodType (m_periodBegin, m_periodEnd);
          if (Type == 1)   /*за день*/
            return string( "за ", m_periodBegin:m:l );
          elif (Type == 2) /*за месяц*/
            DateSplit( m_periodBegin, NULL, month, year );
            return string( "за ", StrLwr( MonName( month ) ), " ", year, " г." );
          elif (Type ==4) /*за период*/
            return string( "за период с ", m_periodBegin:l, " г. по ", m_periodEnd:l, " г." );
          end

        end;


        [ ################################################################################################] ( m_bankName:w );
        [ ________________________________________________________________________________________________];
        [ (наименование кредитной организации)];
        [ ];
        [#################################################################################################] ("ВЕДОМОСТЬ КАССОВЫХ ОБОРОТОВ":c);
        [#################################################################################################] ( ComposePeriodString():c );
    end;

    private macro PrintEmptyBody()
        [ ];
        [#################################################################################################] ( "Данные отсутствуют":c );
    end;

    private macro PrintSpecificBottom()
        [ ];
        [ ];
        [ ];
        [ # ] ( string( m_bossPosition, "       __________ ", m_bossName," ______________________ /                 / " ):l );
        [ ];
        [ # ] ( string( m_bookPosition, "       __________ ", m_bookName," ______________________ /                 / " ):l );
        [ ];
        [ Исполнитель # ] ( string( "    __________ ", m_executiveName, "  _____________/                  /" ):l );
        [ ];
        [ ];
        [ ];
    end;


    private macro PrintBody( differenceReport, turnsReport )

        macro GetDocumentsQuery()

            var query = "";
            var balanceList;

            if   (m_PeriodEnd < ДАТА_1881У)
                  balanceList = "'20202', '20206', '20207', '20208'";
            elif (m_PeriodEnd < ДАТА_2500У)
                  balanceList = "'20202', '20206', '20207'";
            else
                  balanceList = "'20202', '20207'";
            end;

            var accDep =
                       " (CASE lss.t_type_symbol                                         " +
                       "    WHEN 1 THEN doc.t_accountId_payer                              " +
                       "    WHEN 2 THEN doc.t_accountId_receiver                           " +
                       "    WHEN 3 THEN CASE                                             " +
                       "                  WHEN lss.t_symb_cash IN (' 89', ' 97', ' 99', '100') THEN doc.t_accountId_payer    " +
                       "                  WHEN lss.t_symb_cash IN (' 96', ' 98') THEN doc.t_accountId_receiver " +
                       "                 ELSE 0                                          " +
                       "                END                                              " +
                       "    END)                                                         " ;


            query = query +
                       " SELECT nvl(doc.t_account_payer, chr(1))    t_account_payer,     " +
                       "        nvl(doc.t_account_receiver, chr(1)) t_account_receiver,  " +
                       "        doc.t_Numb_Document                 t_numb_document,     " +
                       "        doc.t_Date_Carry                    t_date_carry,        " +
                       "        nvl((SELECT doc.t_sum_natCur                             " +
                       "               FROM   dual                                       " +
                       "              WHERE (    SUBSTR(ablp.t_balance, 1, 5) IN ("+balanceList+"))" +
                       "                 OR (    SUBSTR(ablr.t_balance, 1, 5) IN ("+balanceList+"))" +
                       "        ),0)                                docSum,              " +
                       "        lss.T_SYMB_CASH                     t_symbol,            " +
                       "        sym.t_symbol                        cash_s,              " +
                       "        nvl((SELECT sym.t_sum                                    " +
                       "         FROM   dual                                             " +
                           "         WHERE SUBSTR(ablp.t_balance, 1, 5) IN ("+balanceList+")" +
                           "         OR    SUBSTR(ablr.t_balance, 1, 5) IN ("+balanceList+")" +
                                     ternary(m_PeriodEnd < ДАТА_2500У, "",
                       "             AND (SUBSTR(ablp.t_balance, 1, 5) != '20206'       " +
                       "             AND SUBSTR(ablr.t_balance, 1, 5)  != '20206')      ")+
                       "        ),0)                                symsum,              " +
                       "        lss.t_dockind                       t_dockind,           " +
                       "        lss.t_type_symbol                   t_type_symbol,       " +
                       "        ablp.t_balance                      payerBalance,        " +
                       "        ablr.t_balance                      receiverBalance,     " +
                       "        lss.t_name                          t_name               ";
            query = query +
                       " FROM   daccTrn_dbt                         doc,                 " +
                       "        daccBalance_dbt                     ablp,                " +
                       "        daccBalance_dbt                     ablr,                " +
                       "        dsymbcash_dbt                       sym,                 " +
                       "        dlistsymb_dbt                       lss                  ";

            query = query +
                       " WHERE  lss.t_dockind = 1                                        " +
                       " AND    lss.t_symb_cash = sym.t_symbol(+)                        " +
                       " AND    sym.t_dockind(+) = 1                                     " +
                       " AND    sym.t_date(+) BETWEEN " + GetSQLDate(m_PeriodBegin)        +
                       "                          AND " + GetSQLDate(m_periodEnd)          +
                       " AND    sym.t_accTrnId = doc.t_accTrnId (+)                      " +
                       " AND    doc.t_date_carry(+) BETWEEN " + GetSQLDate(m_PeriodBegin)  +
                       "                                AND " + GetSQLDate(m_periodEnd)    +
                       " AND    doc.T_KIND_OPER(+) = ' 3'                                " +
                       " AND    (        doc.t_accountid_payer    = ablp.t_accountid(+)  " +
                       "          AND    ablp.t_numPlan(+) = 0                           " +
                       "          AND    ablr.t_numPlan(+) = 0                           " +
                       "          AND    doc.t_accountid_receiver = ablr.t_accountid(+) )" +
                       " AND    (" + m_DocumentFilter.GetAsSqlString( "doc" )              +
                       "             OR doc.t_date_carry IS NULL )                       " +
                       " AND (   doc.t_date_carry is null "                                +
                       "      OR EXISTS(SELECT 1"                                         +
                       "                  FROM daccount_dbt ac"                             +
                       "                 WHERE ( ac.t_AccountId = doc.t_AccountId_Payer "  +
                       "                      or ac.t_AccountId = doc.t_AccountId_Receiver)"+
                       "                   AND " + m_AccountFilter.GetAsSqlString("ac")  +
                       "                   AND " + accDep  + " = ac.t_accountId            " +/**/
                       "                   AND instr(ac.t_type_account,'А')<>0            " +/**/
                       "           )"                                                      +
                       "      )"                                                           ;



                if (m_PeriodBegin >= ДАТА1_1660У)
                    query = query +
                           " AND lss.t_Symb_Cash <> ' 36' AND lss.t_Symb_Cash <> ' 71' ";
                else
                    query = query +
                           " AND lss.t_Symb_Cash <> ' 89' AND lss.t_Symb_Cash <> ' 96' ";
                end;

                if (m_PeriodEnd < ДАТА_1881У)
                    query = query +
                           " AND (lss.t_symb_cash <> ' 98' AND lss.t_symb_cash <> ' 97'      " +
                           " AND  lss.t_symb_cash <> ' 99' AND lss.t_symb_cash <> '100'      " +
                           " AND  lss.t_symb_cash <> ' 75' AND lss.t_symb_cash <> ' 61'      " +
                           " AND  lss.t_symb_cash <> ' 62' AND lss.t_symb_cash <> ' 47'      " +
                           " AND  lss.t_symb_cash <> ' 33' AND lss.t_symb_cash <> ' 23'      " +
                           " AND  lss.t_symb_cash <> ' 22' AND lss.t_symb_cash <> ' 21'      " +
                           " AND  lss.t_symb_cash <> ' 03'                             )     " ;
                end;

            return query;

        end;


        macro GetQueryProtocol(documentTableName)

               var query = "";
               var balanceList;

               if   (m_PeriodEnd < ДАТА_1881У)
                     balanceList = "'20202', '20206', '20207', '20208'";
               elif (m_PeriodEnd < ДАТА_2500У)
                     balanceList = "'20202', '20206', '20207'";
               else
                     balanceList = "'20202', '20207'";
               end;


                   query = query +
                        "SELECT   doc.t_account_payer    account_payer,                                             " + "\n" +
                        "         doc.t_account_receiver account_receiver,                                          " + "\n" +
                        "         doc.t_date_carry       date_carry,                                                " + "\n" +
                        "         doc.t_sum_natCur       sum,                                                       " + "\n" +
                        "         doc.t_numb_document    numb_document,                                             " + "\n" +
                        "         sym.t_symbol           symbol,                                                    " + "\n" +
                        "         sym.t_kind             type_symbol,                                               " + "\n" +
                        "         CASE"                                                                               + "\n" +
                        "            WHEN (SUBSTR(ablp.t_balance, 1, 5) IN (" + balanceList + ")                    " + "\n" +
                        "                  AND EXISTS(SELECT 1                                                      " + "\n" +
                        "                              FROM daccount_dbt acc                                        " + "\n" +
                        "                             WHERE acc.t_chapter = 1                                       " + "\n" +
                        "                               AND    acc.t_accountId = doc.t_accountId_payer              " + "\n" +
                        "                               AND " + m_accountFilter.GetAsSqlString("acc")                 + "\n" +
                        "                               AND INSTR(acc.t_type_account, 'А') <> 0                     " + "\n" +
                                                        ternary(m_PeriodEnd < ДАТА_1881У, "",
                        "                               AND INSTR(acc.t_type_account, 'П') = 0                      " + "\n")+
                        "                  )          )                                                             " + "\n" +
                        "                 THEN 1                                                                    " + "\n" +
                        "             ELSE     0                                                                    " + "\n" +
                        "         END isDebetCash,                                                                  " + "\n" +
                        "         CASE                                                                              " + "\n" +
                        "             WHEN (SUBSTR(ablr.t_balance, 1, 5) IN (" + balanceList + ")                   " + "\n" +
                        "                   AND EXISTS(SELECT 1                                                     " + "\n" +
                        "                               FROM daccount_dbt acc                                       " + "\n" +
                        "                              WHERE acc.t_chapter = 1                                      " + "\n" +
                        "                                AND acc.t_accountId = doc.t_accountId_receiver             " + "\n" +
                        "                                AND " + m_accountFilter.GetAsSqlString("acc")                + "\n" +
                        "                                AND INSTR(acc.t_type_account, 'А') <> 0                    " + "\n" +
                                                         ternary(m_PeriodEnd < ДАТА_1881У, "",
                        "                                AND INSTR(acc.t_type_account, 'П') = 0                     " + "\n")+
                        "                  )           )                                                            " + "\n" +
                        "                 THEN 1                                                                    " + "\n" +
                        "             ELSE     0                                                                    " + "\n" +
                        "         END isCreditCash                                                                  " + "\n" +
                        "    FROM "  + documentTableName + " doc,                                                   " + "\n" +
                        "         dsymbcash_dbt  sym,                                                               " + "\n" +
                        "         daccBalance_dbt   ablp,                                                           " + "\n" +
                        "         daccBalance_dbt   ablr                                                            " + "\n" +
                        "   WHERE doc.t_date_carry BETWEEN " +  GetSQLDate(m_PeriodBegin)                             + "\n" +
                        "                              AND " +  GetSQLDate(m_periodEnd)                               + "\n" +
                        "     AND doc.t_kind_oper = ' 3'                                                            " + "\n" +
                        "     AND doc.t_state = 1                                                                   " + "\n" +
                        "     AND sym.t_accTrnId(+) = doc.t_accTrnId                                                " + "\n" +
                        "     AND sym.t_date(+) BETWEEN " +  GetSQLDate(m_PeriodBegin)                                + "\n" +
                        "                           AND " +  GetSQLDate(m_periodEnd)                                  + "\n" +
                        "     AND sym.t_dockind(+) = 1                                                              " + "\n" +
                        "     AND (   sym.t_symbol IS NULL                                                          " + "\n" +
                        "          OR NOT EXISTS (                                                                  " + "\n" +
                        "                SELECT lss.t_symb_cash                                                     " + "\n" +
                        "                  FROM dlistsymb_dbt lss                                                   " + "\n" +
                        "                 WHERE lss.t_dockind = 1                                                   " + "\n" +
                        "                   AND sym.t_symbol = lss.t_symb_cash                                      " + "\n" +
                        "                   AND ( ((    doc.t_date_carry >= " + GetSqlDate(ДАТА1_1660У)               + "\n" +
                        "                           AND (lss.t_symb_cash <> ' 36' AND lss.t_symb_cash <> ' 71')     " + "\n" +
                        "                          )                                                                " + "\n" +
                        "                        OR(    doc.t_date_carry < " + GetSqlDate(ДАТА1_1660У)                + "\n" +
                        "                           AND (lss.t_symb_cash <> ' 89' AND lss.t_symb_cash <> ' 96')     " + "\n" +
                        "                          ) )                                                              " + "\n" +
                        "                        AND(    doc.t_date_carry < " + GetSqlDate(ДАТА_1881У)                + "\n" +
                        "                           AND (lss.t_symb_cash <> ' 98' AND lss.t_symb_cash <> ' 97'      " + "\n" +
                        "                           AND  lss.t_symb_cash <> ' 99' AND lss.t_symb_cash <> '100'      " + "\n" +
                        "                           AND  lss.t_symb_cash <> ' 75' AND lss.t_symb_cash <> ' 61'      " + "\n" +
                        "                           AND  lss.t_symb_cash <> ' 62' AND lss.t_symb_cash <> ' 47'      " + "\n" +
                        "                           AND  lss.t_symb_cash <> ' 33' AND lss.t_symb_cash <> ' 23'      " + "\n" +
                        "                           AND  lss.t_symb_cash <> ' 22' AND lss.t_symb_cash <> ' 21'      " + "\n" +
                        "                           AND  lss.t_symb_cash <> ' 03'                             )     " + "\n" +
                        "                           OR  (doc.t_date_carry >= " + GetSqlDate(ДАТА_1881У) + ")        " + "\n" +
                        "                          ) )                                                              " + "\n" +
                        "                        )                                                                  " + "\n" +
                        "          )                                                                                " + "\n" +
                        "     AND (doc.t_accountId_payer = ablp.t_accountId(+)                                      " + "\n" +
                        "     AND  ablp.t_numPlan(+) = 0                                                            " + "\n" +
                        "     AND  ablr.t_numPlan(+) = 0                                                            " + "\n" +
                        "     AND (SUBSTR(ablp.t_balance, 1, 5) IN (" + balanceList +")                             " + "\n" +
                        "     OR SUBSTR(ablr.t_balance, 1, 5) IN (" + balanceList +"))                              " + "\n" +
                        "     AND doc.t_accountId_receiver = ablr.t_accountId(+))                                   " + "\n" +
                        "     AND (   doc.t_date_carry is null                                                      " + "\n" +
                        "          OR ( EXISTS( select 1                                                            " + "\n" +
                        "                     from daccount_dbt ac                                                  " + "\n" +
                        "                     where ( (ac.t_AccountId = doc.t_AccountId_Payer                       " + "\n" +
                        "                                and doc.t_fiid_payer = " + NATCUR +")                      " + "\n" +
                        "                          or (ac.t_AccountId = doc.t_AccountId_Receiver                    " + "\n" + 
                        "                                and doc.t_fiid_receiver = " + NATCUR + "))                 " + "\n" +
                        "                       and " + m_AccountFilter.GetAsSqlString("ac")                          + "\n" +
                        "                         and INSTR(ac.t_type_account,'А') <> 0 "                             + "\n" +
                        "                     )                                                                     " + "\n" +
                        "                AND  " + m_DocumentFilter.GetAsSqlString( "doc" )                            + "\n" +
                        "          )   )                                                                            " + "\n";

                 return query;
        end;

        var documentsQuery = GetDocumentsQuery();

        macro GetSymbolSumQuery()
            var query =
                    " SELECT    dc.t_name             t_name,            " + "\n" +
                    "           dc.t_symbol           t_symbol,          " + "\n" +
                    "           dc.t_type_symbol      t_type_symbol,     " + "\n" +
                    "           nvl(sum(dc.symSum),0) symSum             " + "\n" +
                    " FROM ( " + documentsQuery + " ) dc                 " + "\n" +
                    " GROUP BY  dc.t_symbol, dc.t_name, dc.t_type_symbol " + "\n" +
                    " ORDER BY  dc.t_symbol, dc.t_type_symbol, dc.t_name ";
            return query;
        end;

        var symbolsSumQuery   = GetSymbolSumQuery();
        var symbolsSumDataSet = TRsbDataSet( symbolsSumQuery );

        var total02_39 = $0;
        var total40_77 = $0;

        var total02_39_no35 = $0;
        var total40_77_no70 = $0;

        var output1 = false;
        var output2 = false;
        var output3 = false;

        var symbol35      = $0;
        var symbol70      = $0;
        var symbol80      = $0;
        var symbol81      = $0;
        var Оборот_Дебет  = $0;
        var Оборот_Кредит = $0;

        var shouldPrint02_39Total = true;
        var shouldPrint40_77Total = true;

        RestBTime = Time(); /* Debug information */
        GetSpecialSymbols( symbol35, symbol70, Оборот_Дебет, Оборот_Кредит, m_periodBegin, m_periodEnd );

        if (m_PeriodEnd >= ДАТА_1881У)
            GetSpecialSymbols1881(symbol80, true,  TSpecialAccountFilter(true,  "20208*", "!П","!А"),
                                                   TSpecialAccountFilter(false, "202*",   "!П"),
                                                   m_periodBegin, m_periodEnd, m_AccountFilter);
            GetSpecialSymbols1881(symbol81, false, TSpecialAccountFilter(false, "202*",   "!П"),
                                                   TSpecialAccountFilter(true,  "20208*", "!П","!А"),
                                                   m_periodBegin, m_periodEnd, m_AccountFilter);
        end;

        RestETime = Time(); /* Debug information */

        if ((symbol35 != 0) or (symbol70 != 0) or (Оборот_Дебет != 0) or (Оборот_Кредит != 0) or (symbol80 != 0) or (symbol81 != 0))
          m_isEmpty = false;
        end;

        if ( not m_twoColumnsPrint )
            while( symbolsSumDataSet.MoveNext())
                if ( symbolsSumDataSet.type_symbol == DEBET_TYPE_SYMBOL )
                    total02_39_no35 = total02_39_no35 + symbolsSumDataSet.symSum;
                elif ( symbolsSumDataSet.type_symbol == CREDIT_TYPE_SYMBOL )
                    if ( shouldPrint02_39Total )
                        total02_39 = total02_39_no35 + symbol35;
                        PrintStringTransferByWord( "Остаток кассы (входящий)",  "35", moneyl(symbol35) );
                        PrintStringTransferByWord( "", "Итого 02-39", moneyl(total02_39) );
                        shouldPrint02_39Total = false;
                    end;
                    total40_77_no70 = total40_77_no70 + symbolsSumDataSet.symSum;
                elif (symbolsSumDataSet.type_symbol == OFFBAL_TYPE_SYMBOL)
                    if ( shouldPrint40_77Total )
                        total40_77 = total40_77_no70 + symbol70;
                        PrintStringTransferByWord( "Остаток кассы (исходящий)", "70", moneyl(symbol70) );
                        PrintStringTransferByWord( "", "Итого 40-77", moneyl(total40_77) );
                        shouldPrint40_77Total = false;
                        if (m_PeriodEnd >= ДАТА_1881У)
                            PrintStringTransferByWord( "Поступления наличных денег через банкоматы", "80", moneyl(symbol80) );
                            PrintStringTransferByWord( "Выдачи наличных денег через банкоматы",      "81", moneyl(symbol81) );
                        end;
                    end;
                end;

                if (symbolsSumDataSet.symSum != 0)
                  m_isEmpty = false;
                end;

                PrintStringTransferByWord( symbolsSumDataSet.name, symbolsSumDataSet.symbol, moneyl(symbolsSumDataSet.symSum) );
            end;

            if ( shouldPrint40_77Total )
                PrintStringTransferByWord( "Остаток кассы (исходящий)", "70", moneyl(symbol70) );
                PrintStringTransferByWord( "", "Итого 40-77", moneyl(total40_77) );
                shouldPrint40_77Total = false;
            end;

            PrintBottom();
        else

            while( symbolsSumDataSet.MoveNext() )
                if ( symbolsSumDataSet.type_symbol == DEBET_TYPE_SYMBOL )
                    total02_39_no35 = total02_39_no35 + symbolsSumDataSet.symSum;
                elif ( symbolsSumDataSet.type_symbol == CREDIT_TYPE_SYMBOL )
                    total40_77_no70 = total40_77_no70 + symbolsSumDataSet.symSum;
                end;

                if (symbolsSumDataSet.symSum != 0)
                  m_isEmpty = false;
                end;
            end;

            total02_39 = total02_39_no35 + symbol35;
            total40_77 = total40_77_no70 + symbol70;

            SetOutPut( bufferFileName1, true );
            m_column1.PrintStringTransferByWord( "Итого по символам 02-39", moneyl(total02_39) );
            m_column1.PrintStringTransferByWord( "Символ 35", moneyl(symbol35) );
            m_column1.PrintStringTransferByWord( "Итого по приходным символам, в том числе:", moneyl(total02_39_no35)  );

            SetOutPut( bufferFileName2, true );
            m_column2.PrintStringTransferByWord( "Итого по символам 40-77", moneyl(total40_77) );
            m_column2.PrintStringTransferByWord( "Символ 70", moneyl(symbol70) );
            m_column2.PrintStringTransferByWord( "Итого по расходным символам, в том числе:", moneyl(total40_77_no70) );

            if (m_PeriodEnd >= ДАТА_1881У)
                SetOutPut( bufferFileName3, true );
                m_column3.PrintStringTransferByWord( " 80", moneyl(symbol80) );
                m_column3.PrintStringTransferByWord( " 81", moneyl(symbol81) );
            end;

            symbolsSumDataSet = NULL;
            symbolsSumDataSet = TRsbDataSet( symbolsSumQuery );

            while( symbolsSumDataSet.MoveNext() )
                if ( symbolsSumDataSet.type_symbol == DEBET_TYPE_SYMBOL )
                    if ( not output1 )
                        SetOutPut( bufferFileName1, true );
                        output1 = true;
                        output2 = false;
                        output3 = false;
                    end;
                    m_column1.PrintStringTransferByWord( symbolsSumDataSet.symbol, moneyl(symbolsSumDataSet.symSum) );
                elif ( symbolsSumDataSet.type_symbol == CREDIT_TYPE_SYMBOL )
                    if ( not output2 )
                        SetOutPut( bufferFileName2, true );
                        output1 = false;
                        output2 = true;
                        output3 = false;
                    end;
                    m_column2.PrintStringTransferByWord( symbolsSumDataSet.symbol, moneyl(symbolsSumDataSet.symSum) );
                elif ( symbolsSumDataSet.type_symbol == OFFBAL_TYPE_SYMBOL )
                    if ( not output3 )
                        SetOutPut( bufferFileName3, true );
                        output1 = false;
                        output2 = false;
                        output3 = true;
                    end;
                    m_column3.PrintStringTransferByWord( symbolsSumDataSet.symbol, moneyl(symbolsSumDataSet.symSum) );
                end;
            end;

                SetOutPut( bufferFileName1, TRUE );
                m_Column1.PrintBottom();
                SetOutPut( bufferFileName2, TRUE );
                m_Column2.PrintBottom();
                if (m_PeriodEnd >= ДАТА1_1660У)
                SetOutPut( bufferFileName3, TRUE );
                m_Column3.PrintBottom();
                end;
            PrintColumns( reportFileName, bufferFileName1, bufferFileName2, bufferFileName3, 50 );

        end;

        PrintSpecificBottom();

        /* Добавление записей в протокол расхождений */

        if (not OneFilePrint) SetOutput( protocolFileName );
        else SetOutput( reportFileName );
        end;

        if ( total02_39_no35 != Оборот_Дебет )
            differenceReport.PrintError( "Сумма по приходным символам отличается от суммы дебетовых оборотов по счету кассы", Abs(total02_39_no35 - Оборот_Дебет) );
        end;
        if ( total40_77_no70 != Оборот_Кредит )
            differenceReport.PrintError( "Сумма по расходным символам отличается от суммы кредетовых оборотов по счету кассы", Abs(total40_77_no70 - Оборот_Кредит) );
        end;
        if ( total02_39 != total40_77 )
            differenceReport.PrintError( "Сумма по приходным символам не равна сумме по расходным символам", Abs(total02_39 - total40_77) );
        end;

        differenceReport.PrintBottom();

        SetOutput( reportFileName, TRUE );

        /* Добавление записей в протокол проводок */
        documentsQuery = GetQueryProtocol( "daccTrn_dbt" ) + "ORDER BY date_carry, numb_document" + "\n";

        var documentsDataSet = TRsbDataSet( documentsQuery );

        if (not OneFilePrint) SetOutput( protocolFileName, TRUE );
        else SetOutput( reportFileName, TRUE);
        end;

        while( documentsDataSet.MoveNext() )
            if ( documentsDataSet.account_Payer != "" )
                if ( (documentsDataSet.symbol == NULL) )
                    turnsReport.PrintError( string( date(documentsDataSet.date_Carry) ),
                                            documentsDataSet.numb_Document,
                                            abs(documentsDataSet.Sum),
                                            /*"Документ не содержит кассовый символ",*/
                                            "нет",
                                            documentsDataSet.account_Payer,
                                            documentsDataSet.account_Receiver
                                          );
                    m_isEmpty = false;
                elif (    ( ( documentsDataSet.type_symbol == DEBET_TYPE_SYMBOL  ) and (documentsDataSet.isDebetCash  != 0) )
                      or  ( ( documentsDataSet.type_symbol == CREDIT_TYPE_SYMBOL ) and (documentsDataSet.isCreditCash != 0) )
                     )
                    turnsReport.PrintError( string( date(documentsDataSet.date_Carry) ),
                                            documentsDataSet.numb_Document,
                                            abs(documentsDataSet.Sum),
                                            documentsDataSet.symbol,
                                            documentsDataSet.account_Payer,
                                            documentsDataSet.account_Receiver
                                          );
                    m_isEmpty = false;
                end;
            end;
        end;

        turnsReport.PrintBottom();
        SetOutput( reportFileName, TRUE );



    end;

    macro Publish( differenceReport, turnsReport )
        if ( not m_twoColumnsPrint )
            AddColumn("Наименование кассового символа", 44);
            AddColumn("Номер кассового символа",        10, AL_RIGHT);
            AddColumn("Сумма",                          24);
        else
            m_Column1 = CColumnReport("Номер кассового символа");
            m_Column2 = CColumnReport("Номер кассового символа");
            m_Column3 = CColumnReport("Номер забалансового символа");
        end;

        PrintSpecificHeader();

        if ( not m_twoColumnsPrint )
            PrintHead();
        else
            SetOutPut( bufferFileName1 );
            m_Column1.PrintHead();
            SetOutPut( bufferFileName2 );
            m_Column2.PrintHead();
            SetOutPut( bufferFileName3 );
            if (m_PeriodEnd >= ДАТА1_1660У)
            m_Column3.PrintHead();
            SetOutPut( reportFileName, TRUE );
        end;
        end;

        PrintBody( differenceReport, turnsReport );

        if ( m_isEmpty )
            SetOutPut( bufferFileName1, TRUE );
            SetOutPut( reportFileName, FALSE ); /* убиваем содержимое файла */
            PrintSpecificHeader(); /* еще раз печатаем заголовок */
            PrintEmptyBody();
        end;

    end;

end;



macro PrintReport( panelDepartmentNumber, panelOrganizationStructure, panelIssueMode, panelPeriodBegin, panelPeriodEnd, panelOneFilePrint, panelTwoColumnsPrint )
   SetOutput( reportFileName );
   OneFilePrint = panelOneFilePrint;

   departmentNumber = panelDepartmentNumber;

   AllBTime = Time();/* Debug information */

   cashTurnsTableReport = CCashTurnsTableReport( panelDepartmentNumber, panelOrganizationStructure, panelIssueMode, panelPeriodBegin, panelPeriodEnd, panelTwoColumnsPrint );

   if (cashTurnsTableReport.ShouldContinue() == false)
       return false;
   end;

   var differenceReport = CDifferenceReport();
   var turnsReport = CTurnsReport();

   cashTurnsTableReport.Publish( differenceReport, turnsReport );

   /*AllETime = Time();  Debug information */
   /*
   println();                                            /* Debug information */
   println("Общее время: ", AllETime-AllBTime);          /* Debug information */
   println("Получение остатков: ", RestETime-RestBTime); /* Debug information */
   */

   if ( not differenceReport.IsEmpty() and not OneFilePrint)
        View( protocolFileName );
   end;

   View( reportFileName );

   return true;
end;

/* Debug mode */
exit( 1 );
