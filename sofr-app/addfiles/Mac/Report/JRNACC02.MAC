/*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
  ‚¥¤®¬®áâì ®âªàëâëå ¨ § ªàëâëå áç¥â®¢ - ¯¥ç âì

  File Name     : jrnacc02.mac
  Call functions: PrintAccOpenCloseList
  Call from     : bk_opacc.mac
ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*/
import  BankInter, CTInter, RsbDataSet, cb_sql, rep_lib, ocp, lib_lang;

import lib_str;
import lib_arr;
/*------------------ ƒ«®¡ «ë -----------------------------------------*/
private const TempTableName = "dbk_opacc_tmp";  /* ¨¬ï ¢à¥¬. â ¡«¨æë */

const  Žâªàëâë¥    = 1,
       ‡ ªàëâë¥    = 2;

const  NumStrOnPage              = 84;  /* Š®«-¢® áâà®ª ­  áâà ­¨æ¥ */
const  BankAccReportHeaderHeight = 5;   /* ‚ëá®â  § £®«®¢ª  ®âç¥â  ¯® áç¥â ¬ ¡ ­ª  */
const  ClAccReportHeaderHeight   = 4;   /* ‚ëá®â  § £®«®¢ª  ®âç¥â  ¯® áç¥â ¬ ª«¨¥­â®¢ */
const  BankAccTableHeaderHeight  = 4;   /* ‚ëá®â  § £®«®¢ª  â ¡«¨æë ¯® áç¥â ¬ ¡ ­ª  */
const  ClAccTableHeaderHeight    = 5;   /* ‚ëá®â  § £®«®¢ª  â ¡«¨æë ¯® áç¥â ¬ ª«¨¥­â®¢ */

file pt (party);        /* ‘¯à ¢®ç­¨ª ª«¨¥­â®¢     */

var Params;             /*  à ¬¥âàë ®âçñâ , ¢ë¡¨à ¥¬ë¥ ¢ ¯ ­¥«¨. */
var Count;              /* ‘çñâç¨ª ¢ progress bar'¥ */
var ps;                 /* ®¡ê¥ªâ-à §¤¥«¨â¥«ì áâà ­¨æ */
var ‡ £®«®¢®ªŽâç¥â  ¯¥ç â ­  = FALSE;
var ‡ £®«®¢®ª’ ¡«¨æë ¯¥ç â ­ = FALSE;
/*---------- ”ã­ªæ¨¨ ¯¥ç â¨ ------------------------------------------*/

/**
 *  ¢áâ ¢ª  à §àë¢  áâà ­¨æë
 **/
private class PageSplit(pageHeigh : Integer)
    private var m_pageHeigh = pageHeigh;
    private var m_strCount  = 0;

    macro getFreeStrings()
        return m_pageHeigh - m_strCount;
    end;

    macro addPage()
        println("\f");
        m_strCount = 0;
    end;

    macro addStrings(strQuantity : Integer)
        if ((m_strCount + strQuantity) > m_pageHeigh)
            println("\f");
            m_strCount = strQuantity;
        else
            m_strCount = m_strCount + strQuantity;
        end;
        return m_strCount;
    end;
end;

/**
 *  ¬ ªà®á ¢®§¢à é ¥â ­ ¨¡®«ìèãî ¨§ ¢ëá®â ¢ë¢®¤¨¬ëå áâà®ª (á ãç¥â®¬ ¯¥à¥­®á®¢)
 **/
private macro getStringHeight(strArray, widthArray : TArray) : Integer
    var m_max = 0;
    var i;
    var current;

    for (i, 0, strArray.Size, 1)
        current = StrTransferByWord(strArray(i), widthArray(i), STR_ALIGN_LEFT, " ").Size;
        if (m_max < current)
            m_max = current;
        end;
    end;

    return m_max;
end;

macro printEmptyData()
    println();
    println("\t„ ­­ë¥ ®âáãâáâ¢ãîâ");
    println();
end;

/*  ¯¥ç â âì § £®«®¢®ª */
MACRO  PrintReportHeader( date1, date2, openClose, accType )
    var strMain, strDat;

    if( openClose == Žâªàëâë¥ )
        strMain = "‚¥¤®¬®áâì ®âªàëâëå áç¥â®¢";
    else
        strMain = "‚¥¤®¬®áâì § ªàëâëå áç¥â®¢";
    end;

    if( date1 == date2 )
        strDat = "­  " + String(Date(date1)+1);
    else
        strDat = "§  ¯¥à¨®¤ á " + date1 + " ¯® " + date2;
    end;

    if(  ( accType == ‘ç¥â  ­ª  ) and (”®à¬ Žâç¥â  == false) )
        println();
        println(mkstr(" ", 85 - strlen(strMain) / 2) + strMain);
        println(mkstr(" ", 85 - strlen("¯® ¢­ãâà¨¡ ­ª®¢áª¨¬ ®¯¥à æ¨ï¬") / 2) + "¯® ¢­ãâà¨¡ ­ª®¢áª¨¬ ®¯¥à æ¨ï¬");
        println(mkstr(" ", 85 - strlen(strDat) / 2) + strDat);
        println();
    elif( (accType == ‘ç¥â Š«¨¥­â®¢ ) or (”®à¬ Žâç¥â  == true) )
        strMain = strMain + " ª«¨¥­â®¢";
        println();
        println(mkstr(" ", 85 - strlen(strMain) / 2) + strMain);
        println(mkstr(" ", 85 - strlen(strDat) / 2) + strDat);
        println();
    end;
END;

/*  ¯¥ç â âì § £®«®¢®ª */
MACRO  PrintTableHeader(openClose, accType)

    if(  ( accType == ‘ç¥â  ­ª  ) and (”®à¬ Žâç¥â  == false) )
[ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿];
[³   „ â    ³                         ³                    ³                                        ³   „ â    ³                                         ³               ³];
[³ ®âªàëâ¨ï ³   ®¬¥à «¨æ¥¢®£® áç¥â   ³  ¨¬¥­®¢ ­¨¥ áç¥â  ³        Žá­®¢ ­¨¥ ®âªàëâ¨ï áç¥â         ³ § ªàëâ¨ï ³         Žá­®¢ ­¨¥ § ªàëâ¨ï áç¥â         ³   à¨¬¥ç ­¨¥  ³];
[³   áç¥â   ³                         ³                    ³                                        ³   áç¥â   ³                                         ³               ³];

    elif( (accType == ‘ç¥â Š«¨¥­â®¢ ) or (”®à¬ Žâç¥â  == true) )
        if( Params.NeedPrintFunds )
[ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿];
[³   „ â    ³ „®£®¢®à ®¡ ®âªàëâ¨¨ áç¥â           ³                         ³                         ³                         ³   ®àï¤®ª ¨  ³„ â  á®®¡é¥­¨ï³ ¥­á¨®­­ë© ³”®­¤ ®¡ï§ - ³ ƒ®áª®¬áâ â ³   „ â    ³ „ â  á®®¡é¥­¨ï³   à¨¬¥ç ­¨¥  ³];
[³ ®âªàëâ¨ï ÃÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´   ®¬¥à «¨æ¥¢®£® áç¥â   ³    ¨¬¥­®¢ ­¨¥ ª«¨¥­â   ³        ¨¬¥­®¢ ­¨¥      ³ ¯¥à¨®¤¨ç­®áâì³  ­ «®£®¢ë¬   ³ ä®­¤       ³â¥«ì­®£®    ³            ³ § ªàëâ¨ï ³ ­ «®£®¢ë¬     ³               ³];
[³   áç¥â   ³   „ â    ³  ü ¤®£®¢®à              ³                         ³                         ³       (æ¥«ì) áç¥â       ³¢ë¤ ç¨ ¢ë¯¨á®ª³  ®à£ ­ ¬ ®¡  ³            ³¬¥¤¨æ¨­áª®£®³            ³  áç¥â    ³ ®à£ ­ ¬ ®     ³               ³];
[³          ³          ³                         ³                         ³                         ³                         ³   ¯® áç¥âã   ³®âªàëâ¨¨ áç¥â ³            ³áâà å®¢ ­¨ï ³            ³          ³ § ªàëâ¨¨ áç¥â ³               ³];
        else
[ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿];
[³   „ â    ³ „®£®¢®à ®¡ ®âªàëâ¨¨ áç¥â           ³                         ³                         ³                         ³   ®àï¤®ª ¨  ³„ â  á®®¡é¥­¨ï³   „ â    ³ „ â  á®®¡é¥­¨ï³   à¨¬¥ç ­¨¥  ³];
[³ ®âªàëâ¨ï ÃÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´   ®¬¥à «¨æ¥¢®£® áç¥â   ³    ¨¬¥­®¢ ­¨¥ ª«¨¥­â   ³        ¨¬¥­®¢ ­¨¥      ³ ¯¥à¨®¤¨ç­®áâì³  ­ «®£®¢ë¬   ³ § ªàëâ¨ï ³ ­ «®£®¢ë¬     ³               ³];
[³   áç¥â   ³   „ â    ³  ü ¤®£®¢®à              ³                         ³                         ³       (æ¥«ì) áç¥â       ³¢ë¤ ç¨ ¢ë¯¨á®ª³  ®à£ ­ ¬ ®¡  ³  áç¥â    ³ ®à£ ­ ¬ ®     ³               ³];
[³          ³          ³                         ³                         ³                         ³                         ³   ¯® áç¥âã   ³®âªàëâ¨¨ áç¥â ³          ³ § ªàëâ¨¨ áç¥â ³               ³];
        end;
    end;
END;

/*-----------------------------------------------------------------------*/
MACRO PrintReportFooter()
    ps.addStrings(3);
    printLn();
    printLn({Name_Book}," ___________________ ", {FIO_Book});
    printLn();
    ps.addPage();
END;

MACRO PrintTableFooter( accType )
    if  ( (accType == ‘ç¥â  ­ª ) and (”®à¬ Žâç¥â  == false) )
[ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
    /*//01 Aug 07 Wed 10:24:00 Malakhova Irina 110772*/
    /*„®¡ ¢¨«  ª®«®­ªã á ¤ â®© á®®¡é¥­¨ï ­ «®£®¢ë¬ ®à£ ­ ¬ ® § ªàëâ¨¨ áç¥â */
    elif( (accType == ‘ç¥â Š«¨¥­â®¢) or (”®à¬ Žâç¥â  == true) )
        if( Params.NeedPrintFunds )
[ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
        else
[ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
        end;
    end;
END;

MACRO ConvParm( )
    var i = 0, val;
    while( GetParm( i, val ) )
        if( val == NULL )
            val = "";
        else
            val = SQL_ConvType( val );
        end;
        SetParm( i, val );
        i = i + 1;
    end;
END;

MACRO PrintAccBank( Open_Date, NameAccount, Account, Close_Date, p_groundO, p_groundC,
                    openClose, accType,
                    BeginDate, EndDate )
    var n;

    ConvParm( Open_Date, NameAccount, Account, Close_Date, p_groundO, p_groundC );

    if (‡ £®«®¢®ª’ ¡«¨æë ¯¥ç â ­ == false)
        n = BankAccTableHeaderHeight;
        if (‡ £®«®¢®ªŽâç¥â  ¯¥ç â ­ == false)
            n = n + BankAccReportHeaderHeight;
            ps.addStrings(getStringHeight(ArrCreate(NameAccount, p_groundO, p_groundC), ArrCreate(20, 40, 41)) + 1 + n);
            PrintReportHeader(BeginDate, EndDate, openClose, accType);
            ‡ £®«®¢®ªŽâç¥â  ¯¥ç â ­ = true;
        else
            ps.addStrings(getStringHeight(ArrCreate(NameAccount, p_groundO, p_groundC), ArrCreate(20, 40, 41)) + 1 + n);
        end;
        PrintTableHeader(openClose, accType);
        ‡ £®«®¢®ª’ ¡«¨æë ¯¥ç â ­ = true;
    else
        n = getStringHeight(ArrCreate(NameAccount, p_groundO, p_groundC), ArrCreate(20, 40, 41));
        if (n + 2 > ps.getFreeStrings())
            PrintTableFooter(AccType);
            ps.addPage();
            PrintTableHeader(openClose, accType);
            ps.addStrings(BankAccTableHeaderHeight);
        end;
        ps.addStrings(n + 1);
    end;
    [ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
    [³##########³#########################³####################³########################################³##########³#########################################³               ³]
    ( Open_Date:f:c, Account:f, NameAccount:w, p_groundO:w, Close_Date:f:c, p_groundC:w );
END;

MACRO PrintAccClient( Open_Date, Contr_Date, Contr_Number, NameCl, NameAccount, Account, ExtractPeriod, Reg_Date, Close_Date, RegDate1,
                      openClose, accType,
                      BeginDate, EndDate )
    /*//01 Aug 07 Wed 10:24:07 Malakhova Irina 110772*/
    /*„®¡ ¢¨«  ª®«®­ªã á ¤ â®© á®®¡é¥­¨ï ­ «®£®¢ë¬ ®à£ ­ ¬ ® § ªàëâ¨¨ áç¥â */
    var n;

    const NO_NEED = "";
    ConvParm( Open_Date, Contr_Date, Contr_Number, NameCl, NameAccount, Account, ExtractPeriod, Reg_Date, Close_Date, RegDate1);

    if (‡ £®«®¢®ª’ ¡«¨æë ¯¥ç â ­ == false)
        n = ClAccTableHeaderHeight;
        if (‡ £®«®¢®ªŽâç¥â  ¯¥ç â ­ == false)
            n = n + ClAccReportHeaderHeight;
            ps.addStrings(getStringHeight(ArrCreate(NameCl, NameAccount), ArrCreate(25, 25)) + 1 + n);
            PrintReportHeader(BeginDate, EndDate, openClose, accType);
            ‡ £®«®¢®ªŽâç¥â  ¯¥ç â ­ = true;
        else
            ps.addStrings(getStringHeight(ArrCreate(NameCl, NameAccount), ArrCreate(25, 25)) + 1 + n);
        end;
        PrintTableHeader(openClose, accType);
        ‡ £®«®¢®ª’ ¡«¨æë ¯¥ç â ­ = true;
    else
        n = getStringHeight(ArrCreate(NameCl, NameAccount), ArrCreate(25, 25));
        if (n + 2 > ps.getFreeStrings())
            PrintTableFooter(AccType);
            ps.addPage();
            PrintTableHeader(openClose, accType);
            ps.addStrings(ClAccTableHeaderHeight);
        end;
        ps.addStrings(n + 1);
    end;

    if( Params.NeedPrintFunds )
        [ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
        [³##########³##########³#########################³#########################³#########################³#########################³##############³##############³############³############³############³##########³###############³               ³]
( Open_Date:f:c, Contr_Date:f:c, Contr_Number:w, Account:f, NameCl:w, NameAccount:w, ExtractPeriod:w, Reg_Date:c, NO_NEED, NO_NEED, NO_NEED, Close_Date:f:c, RegDate1:c);
    else
        [ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
        [³##########³##########³#########################³#########################³#########################³#########################³##############³##############³##########³###############³               ³]
( Open_Date:f:c, Contr_Date:f:c, Contr_Number:w, Account:f, NameCl:w, NameAccount:w, ExtractPeriod:w, Reg_Date:c, Close_Date:f:c, RegDate1:c);
    end;
END;

/* Ÿ¢«ï¥âáï «¨ § ªàëâë¬ */
MACRO IsClose( a )
    return ( a.Close_Date == NULL )
        or ( ( a.Close_Date >= Params.BeginDate ) and ( a.Close_Date <= Params.EndDate ) );
END;

MACRO GetClient( a )
    pt.PartyID = a.Client;
    if( getEQ( pt ) )
        return pt;
    else
        msgbox( "¥ ­ ©¤¥­ ª«¨¥­â " + string( a.Client ) + " ¤«ï ‹‘ " + string( a.Account ) );
        exit( 1 );
    end;
END;

MACRO PutAccClient(a, openClose, accType, BeginDate, EndDate)
    var client = GetClient( a );
    var closeDate = a.Close_Date;

    var accountForPrint; /* 16.10.2007 Malakhova 114925*/

    if (a.backOffice == REP_SUBSYSTEMS_RETAIL)
        accountForPrint = substr(a.Account, 1, 20);
    else
        accountForPrint = a.Account;
    end;

    if( not IsClose( a ) )
        closeDate = Date(0,0,0);
    end;

    PrintAccClient( a.Open_Date, a.ContractDate, a.ContractNumber, client.Name,
        a.NameAccount, accountForPrint, a.ExtractPeriod, GetTaxMsgDate(a, client, OPEN_DATE), CloseDate, GetTaxMsgDate(a, client, CLOSE_DATE),
        openClose, accType,
        BeginDate, EndDate);
END;

MACRO PutAccBank(a, openClose, accType, BeginDate, EndDate)
    var client = GetClient( a );
    var closeDate = a.Close_Date;

    var accountForPrint; /* 16.10.2007 Malakhova 114925*/

    if (a.backOffice == REP_SUBSYSTEMS_RETAIL)
        accountForPrint = substr(a.Account, 1, 20);
    else
        accountForPrint = a.Account;
    end;

    if (”®à¬ Žâç¥â  == true)
        if( not IsClose( a ) )
            closeDate = Date(0,0,0);
        end;

        PrintAccClient( a.Open_Date, a.ContractDate, a.ContractNumber, client.Name,
            a.NameAccount, accountForPrint, a.ExtractPeriod, Date(0,0,0), CloseDate,Date(0,0,0),
            openClose, accType,
            BeginDate, EndDate );
    elif( IsClose( a ) )
        PrintAccBank(a.Open_Date, a.NameAccount, accountForPrint, a.Close_Date, a.OpenGround, a.CloseGround, openClose, accType, BeginDate, EndDate);
    else
        PrintAccBank(a.Open_Date, a.NameAccount, accountForPrint, Date(0,0,0),  a.OpenGround, a.CloseGround, openClose, accType, BeginDate, EndDate);
    end;
END;

/* dat - ¤ â  ®âçñâ  (¥á«¨ §  ª ¦¤ë© ¤¥­ì)
   OpenClose    - Žâªàëâë¥ ¨«¨ ‡ ªàëâë¥
   AccType      - ‘ç¥â  ­ª  ¨«¨ ‘ç¥â Š«¨¥­â®¢
   PutAccFunc   - ”ã­ªæ¨ï ¢ë¢®¤  áçñâ  (@PutAccBank ¨«¨ @PutAccClient)
*/
MACRO PutOneTable( dat, openClose, accType, putAccFunc )
    var dataExist = FALSE;
    var filter, dateField;
    var currentBalance = "";

    /* Žâªàëâë¥/§ ªàëâë¥ ¨ ¤ â  */
    if(   openClose == Žâªàëâë¥ )
        dateField = "t_Open_Date";
    elif( openClose == ‡ ªàëâë¥ )
        dateField = "t_Close_Date";
    end;
    if( dat != NULL )
        filter = dateField + " = " + GetSQLDate( dat );
    else
        filter = dateField + " BETWEEN " + GetSQLDate( Params.BeginDate ) + " AND " + GetSQLDate( Params.EndDate );
    end;

    /* ® ¯à¨­ ¤«¥¦­®áâ¨ áçñâ  */
    if(  (accType == ‘ç¥â  ­ª ) or (accType == ‘ç¥â Š«¨¥­â®¢))
        filter = filter + " AND (t_AccountType = " + accType + ")";
    end;

    var data = TRsbDataSet( "SELECT * " +
                            "  FROM " + TempTableName +
                            " WHERE " + filter +
                            " ORDER BY " + dateField + ", t_Account" );
    ‡ £®«®¢®ªŽâç¥â  ¯¥ç â ­  = FALSE;
    while( data.MoveNext( ) )
        dataExist = true;
        if (currentBalance != data.balance)
            ‡ £®«®¢®ª’ ¡«¨æë ¯¥ç â ­ = FALSE;
            if (currentBalance != "")
                PrintTableFooter( AccType );
                ps.addStrings(1);
            end;
        end;
        currentBalance = data.balance;

        if( dat != NULL )
            ExecMacro( PutAccFunc, data, openClose, accType, dat,              dat);
        else
            ExecMacro( PutAccFunc, data, openClose, accType, Params.BeginDate, Params.EndDate);
        end;

        UseProgress( count = count + 1 );
    end;

    if (dataExist)
        PrintTableFooter(AccType);
        PrintReportFooter();
    end;

end;

/* dat - §  ª ªãî ¤ âã ®âçñâ. NULL, ¥á«¨ ¯® ¢á¥¬ã ¯¥à¨®¤ã. */
MACRO _Report( dat )
    if( ( Params.AccountType == ‚á¥‘ç¥â  ) or ( Params.AccountType == ‘ç¥â  ­ª  ) )
        if( Params.NeedAccOpen )
            PutOneTable( dat, Žâªàëâë¥, ‘ç¥â  ­ª , @PutAccBank );
        end;
        if ( Params.NeedAccClose )
            PutOneTable( dat, ‡ ªàëâë¥, ‘ç¥â  ­ª , @PutAccBank );
        end;
    end;
    if( ( Params.AccountType == ‚á¥‘ç¥â  ) or ( Params.AccountType == ‘ç¥â Š«¨¥­â®¢ ) )
        if( Params.NeedAccOpen )
            PutOneTable( dat, Žâªàëâë¥, ‘ç¥â Š«¨¥­â®¢, @PutAccClient );
        end;
        if ( Params.NeedAccClose )
            PutOneTable( dat, ‡ ªàëâë¥, ‘ç¥â Š«¨¥­â®¢, @PutAccClient );
        end;
    end;
END;

/****************************************************************************/
/*                                ’®çª  ¢å®¤                                */
/****************************************************************************/
MACRO PrintAccOpenCloseList( parameters, hasData )
    Params = parameters;

    ps = PageSplit(NumStrOnPage);

    if (hasData)
        // ‚ ­¥§ ¢¨á¨¬®áâ¨ ®â ­ áâà®¥ª, ª ¦¤ë© áçñâ ¨§ ¢à. â ¡«. ¢ë¢¥¤¥âáï à®¢­® ®¤¨­ à §.
        /*23 Mar 07 Malakhova Irina 103782*/
        InitProgress(-1, "~†¤¨â¥...~", "¥ç âì ®âç¥â " );
        Count = 0;

        var dat;
        if( not Params.NeedEveryDay )
            _Report( ); /* ¡¥§ ¯ à ¬¥âà  - §  ¢á¥ ¤­¨ */
        else
            dat = Params.BeginDate;
            while( dat <= Params.EndDate )
                message( dat );
                _Report( dat );

                dat = dat + 1;
            end;
        end;

        RemProgress();
    else
        PrintReportHeader(Params.BeginDate, Params.EndDate, ternary(Params.NeedAccOpen, Žâªàëâë¥, ‡ ªàëâë¥), Params.AccountType);
        printEmptyData();
        PrintReportFooter();
    end;

    return TRUE;
END;

/* EoF */
