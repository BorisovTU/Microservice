/*
$Name:          ibr_pr_accstatement.mac
$Module:        Отчеты банка
$Description:   Сервисы контороля и расчета отчета "Выписка по лицевым счетам"
*/
import IbrImport;
import rcbWebCommon;
import IbrCommon;
import pr_accstatement;


private const TAB_REPORT = "Параметры отчета";
private const TAB_ACCOUNTS = "Параметры счетов";
private const TAB_EXTENDED = "Дополнительные параметры";

private const GRP_REPORT = TIbrConstant().decoration.group.NOT_GROUP;
private const GRP_ACCOUNTS = TIbrConstant().decoration.group.NOT_GROUP;
private const GRP_EXTENDED = "Дополнительные параметры";
private const GRP_DEDUCE= "Выводить";
private const GRP_EXCLUSIONS = "Исключить счета";
private const GRP_FORMAT = "Выводить в формате";

private const gRep = TAB_REPORT + "@" + GRP_REPORT + "@";
private const gAcc = TAB_ACCOUNTS + "@" + GRP_ACCOUNTS + "@";
private const gExt = TAB_EXTENDED + "@" + GRP_EXTENDED + "@";
private const gExc = TAB_EXTENDED + "@" + GRP_EXCLUSIONS + "@";
private const gDdc = TAB_EXTENDED + "@" + GRP_DEDUCE + "@";    
private const gFmt = TAB_EXTENDED + "@" + GRP_FORMAT + "@";

private macro getValue(report: Object, fieldName : String) : TIbrValueWeb
    return TIbrCommon.getValue(report, fieldName);
end;

/**
 * Создание отчета
 *
 * @result TRcbResult Результат выполнения
 */
macro ibrReportCreate(): Object
    var facade    = TIbrConstructorFacade();
    var report    = facade.createReport("ibr_pr_accstatement", "Выписка из лицевого счета", "ibr_pr_accstatement.mac", "ibrReportExecute", "ibrReportVerification");  

    var tabReport = facade.createTab(TAB_REPORT, 1);
    var groupReport = facade.createNotGroup();
    var tabAccounts = facade.createTab(TAB_ACCOUNTS, 2);
    var groupAccounts = facade.createNotGroup();
    var tabExtended = facade.createTab(TAB_EXTENDED, 3);
    var groupExtended = facade.createGroup(GRP_EXTENDED, 1);
    var groupExclusions = facade.createGroup(GRP_EXCLUSIONS, 2);
    var groupExtdeduce = facade.createGroup(GRP_DEDUCE, 3);
    var groupFormat = facade.createGroup(GRP_FORMAT, 4);

    facade.resetFieldsOrder();
    groupReport.add(facade.createFieldDepartment("Подразделения", "Подразделения"));
    groupReport.add(facade.createFieldStructure("Структура", "Структура"));
    groupReport.add(facade.createFieldIssueMode("Режим", "Режим"));
    groupReport.add(facade.createFieldChartOfAccounts("ПланСчетов", "План счетов", "Основной план счетов"));
    groupReport.add(facade.createFieldAccountChapters("ГлаваСчетов", "Глава счетов", "Балансовые счета"));
    groupReport.add(facade.createFieldCheckBox("ИсклГлавы", "С искл. главами", false));
    groupReport.add(facade.createFieldCurrency("Валюта", "Валюта", NATCUR));
    groupReport.add(facade.createFieldCheckBox("ТолькоИнВалюта", "Только ин.валюта", false));
    groupReport.add(facade.createFieldLlValues("Подсистема", "Подсистема", 1, 1630));
    groupReport.add(facade.createFieldDate("НачалоПериода", "Начало периода"));
    groupReport.add(facade.createFieldDate("КонецПериода", "Конец периода"));
    groupReport.add(facade.createFieldCheckBox("РавноНеравно", "Включить/Исключить клиента", true));
    groupReport.add(facade.createFieldClient("Клиент", "Клиент")); 
    groupReport.add(facade.createFieldUser("Операционист", "Операционист"));
    groupReport.add(facade.createFieldNameAlg("ФормаВыписки", "Форма выписки", 1, 3954));
    groupReport.add(facade.createFieldNameAlg("Приложения", "С приложениями",3, 3951));//
    groupReport.add(facade.createFieldSort("Сортировка", "Сортировка", "1239", 1751));

    facade.resetFieldsOrder();
    groupAccounts.add(facade.createFieldBalance("Балансовый", "Балансовый"));
    groupAccounts.add(facade.createFieldAccount("ЛицевойСчет", "Лицевой счета"));
    groupAccounts.add(facade.createFieldTypeAc("ТипСчета", "Тип счета", 3));
    groupAccounts.add(facade.createFieldCheckBox("Вкл/Искл_1", "Включить/Исключить", true));
    // заблокирон до разбора со справочником
    groupAccounts.add(facade.createFieldTypeAc("ПользТип", "Польз.тип", 1, null, null, null, null, TIbrEnable(false), null, null, null, null, false));
    groupAccounts.add(facade.createFieldCheckBox("Вкл/Искл_2", "Включить/Исключить", true, null, null, null, TIbrEnable(false)));

    facade.resetFieldsOrder();
    groupExtended.add(facade.createFieldCheckBox("ПечатьОснования", "Печать основания", false));
    groupExtended.add(facade.createFieldCheckBox("ДанныеИзПроводки", "Данные из проводки", false));
    groupExtended.add(facade.createFieldCheckBox("ИтоговыеОборотыСПОД", "Итоговые обороты СПОД", false));
    groupExtended.add(facade.createFieldCheckBox("ЗаКаждыйДень", "Печать за каждый день", false));
    groupExtended.add(facade.createFieldCheckBox("ДвойнаяПечать", "Двойная печать", false));
    groupExtended.add(facade.createFieldCheckBox("ЭквНацВал", "Эквивалент в нац. валюте", false));
    groupExtended.add(facade.createFieldCheckBox("Апострофы", "С апострофами", false));

    facade.resetFieldsOrder();
    groupExclusions.add(facade.createFieldCheckBox("Корсчета", "корсчета", true));
    groupExclusions.add(facade.createFieldCheckBox("сПереоценкой", "с переоценкой", false));
    groupExclusions.add(facade.createFieldCheckBox("Интернет", "доступные ч/з Интернет", true));
    
    facade.resetFieldsOrder();
    groupExtdeduce.add(facade.createFieldCheckBox("НулевыеОбороты", "нулевые обороты", false));
    groupExtdeduce.add(facade.createFieldCheckBox("ОтметкуСторно", "отметку \"Cторно\"", false));

    facade.resetFieldsOrder();
    groupFormat.add(facade.createFieldCheckBox("PlainText", "Plain text", true));
    groupFormat.add(facade.createFieldCheckBox("Excel", "Excel", false));
    groupFormat.add(facade.createFieldLlValues("СпособВывода", "Способ вывода:", "Один файл, в разрезе счетов", 0, 2915));
    groupFormat.add(facade.createFieldCheckBox("Word", "Word", false));

    tabReport.add(groupReport);
    tabAccounts.add(groupAccounts);
    tabExtended.add(groupExtended);
    tabExtended.add(groupExclusions);
    tabExtended.add(groupFormat);
    tabExtended.add(groupExtdeduce);

    report.add(tabReport);
    report.add(tabAccounts);
    report.add(tabExtended);

    return report.get();
end;

/**
 * Выполнение отчета
 *
 * @param report TIbrReport Отчет и составляющие отчета
 *
 * @result TRcbResult Результат выполнения
 */
 
macro ibrReportExecute(report: Object): Object   
    var result: Object  = TRcbResult();
    var isShowOcp       = false;
    var isExcel         = getValue(report, gFmt+"Excel").valueBoolean;
    var isEveryDayOfPrd = getValue(report, gExt+"ЗаКаждыйДень").valueBoolean;
    var numPlan         = TIbrCommon().getIdentifierChartOfAccounts(getValue(report, gRep+"ПланСчетов").valueString);

    getRegistryValue("REPORT\\SHOW_OCP", V_BOOL, isShowOcp, NULL );

    result.valueBoolean = printAccountStatement(
                                          getValue(report, gRep+"Подразделения").valueInteger,
                                          getValue(report, gRep+"Структура").valueInteger,
                                          getValue(report, gRep+"Режим").valueInteger,
                                          numPlan,
                                          TIbrCommon().getArrayAccountChapter(getValue(report, gRep+"ГлаваСчетов").valueString, 
                                                                              numPlan,
                                                                              getValue(report, gRep+"ИсклГлавы").valueBoolean),
                                          getFiId(getValue(report, gRep+"Валюта").valueString, getValue(report, gRep+"ТолькоИнВалюта").valueBoolean),
                                          getValue(report, gRep+"НачалоПериода").valueDate,
                                          getValue(report, gRep+"КонецПериода").valueDate, 
                                          ternary(getValue(report, gRep+"РавноНеравно").valueBoolean, 1, 2),
                                          getValue(report, gRep+"Клиент").valueInteger,
                                          getValue(report, gRep+"Операционист").valueInteger,
                                          getValue(report, gAcc+"Балансовый").valueString,
                                          getValue(report, gAcc+"ЛицевойСчет").valueString,
                                          strTransferByWord(getValue(report, gRep+"Сортировка").valueString, 1),
                                          getValue(report, gRep+"Приложения").valueInteger,
                                          getValue(report, gRep+"ФормаВыписки").valueInteger,
                                          getValue(report, gRep+"Подсистема").valueInteger,
                                          getValue(report, gExt+"ПечатьОснования").valueBoolean,
                                          getValue(report, gExt+"ДвойнаяПечать").valueBoolean,
                                          getValue(report, gExt+"ДанныеИзПроводки").valueBoolean,
                                          getValue(report, gExt+"ЭквНацВал").valueBoolean,
                                          getValue(report, gExt+"ИтоговыеОборотыСПОД").valueBoolean,
                                          getValue(report, gExt+"Апострофы").valueBoolean,
                                          getValue(report, gDdc+"НулевыеОбороты").valueBoolean,
                                          getValue(report, gExc+"Корсчета").valueBoolean,
                                          isEveryDayOfPrd,
                                          getValue(report, gExc+"сПереоценкой").valueBoolean,
                                          not isShowOcp,
                                          getValue(report, gAcc+"ТипСчета").valueString,
                                          getValue(report, gAcc+"Вкл/Искл_1").valueBoolean,
                                          getValue(report, gAcc+"ПользТип").valueString,
                                          getValue(report, gAcc+"Вкл/Искл_2").valueBoolean,
                                          getValue(report, gFmt+"PlainText").valueBoolean,
                                          isExcel,
                                          getValue(report, gFmt+"Word").valueBoolean,
                                          getValue(report, gDdc+"ОтметкуСторно").valueBoolean,
                                          getValue(report, gAcc+"ПользТип").valueInteger,
                                          getValue(report, gExc+"Интернет").valueBoolean,
                                          getValue(report, gAcc+"ТипСчета").valueInteger,
                                          ternary((isExcel and isEveryDayOfPrd), getValue(report, gFmt+"СпособВывода").valueInteger, 0),
                                          3 // всегда 3 для word
                                         );
// При удачном выполнении
    if (result.valueBoolean == TRUE)
        //выводим протокол контроля Loans
        repTxtFilesQueue().add(invalidLoansAccountProtocol.getFileName());

        //выводим отчет в текстовом варианте
        if (getValue(report, gFmt+"PlainText").valueBoolean)
            repTxtFilesQueue().add(reportBodyFileName);
        end;      
    // При неудачном выполнении
    else
        repErrorsQueue().add(0, "Выпуск отчета невозможен");
    end;

    result.refreshProtocolAndMessage();
    return result;

    OnError(errorObject)
        rcbRunError(errorObject);
end;

/**
 * Проверка (валидация) отчета
 *
 * @param report TIbrReportWeb Отчет и составляющие
 *
 * @result TRcbResult Результат выполнения
 */
macro ibrReportVerification(report: Object): Object
    /**
     * Результат
     */
    var result: Object  = TRcbResult();

    //полагаем, что все в порядке
    result.valueBoolean = TRUE;

    //проверка входных параметров
    if (getValue(report, gRep+"Подразделения").valueInteger == 0)
        repErrorsQueue().add(0, "Не задано подразделение");
        result.valueBoolean = FALSE;
    end;

    if (TIbrCommon().getIdentifierAccountChapter(getValue(report, gRep+"ГлаваСчетов").valueString) == -1)
        repErrorsQueue().add(0, "Недопустимая глава счетов");
        result.valueBoolean = FALSE;
    end;

    if ((Index(getValue(report, gRep+"Сортировка").valueString, "5") != 0) and 
        (Index(getValue(report, gRep+"Сортировка").valueString, "A") != 0))
        repErrorsQueue().add(0, "Ошибка сортировки. Значение \"А\" конфликтует с установленным значением \"5\"");
        result.valueBoolean = FALSE;
    end;

    if (TIbrCommon().getIdentifierAccountChapter(getValue(report, gRep+"ГлаваСчетов").valueString) == -1)
        repErrorsQueue().add(0, "Недопустимая глава счетов");
        result.valueBoolean = FALSE;
    end;

    if (getValue(report, gRep+"НачалоПериода").valueDate > getValue(report, gRep+"КонецПериода").valueDate)
        repErrorsQueue().add(0, "Дата начала периода не может превышать дату его окончания");
        result.valueBoolean = FALSE;
    end;

    if (    (getValue(report, gFmt+"PlainText").valueBoolean == false)
        and (getValue(report, gFmt+"Excel").valueBoolean     == false))
        repErrorsQueue().add(0, "Не задан формат печати");
        result.valueBoolean = FALSE;
    end;
    
    result.refreshProtocolAndMessage();
    return result;

    OnError(errorObject)
        rcbRunError(errorObject);
end;
