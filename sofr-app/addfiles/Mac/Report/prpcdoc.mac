/*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
  RS-Bank 6.0                                           R-Style Software Lab

  File Name   : prpccalc.mac                      21.06.2011
  Programmer  : gww
  Description : „ ­­ë¥ ® ¯à®¢®¤ª å ¯® ¯à®æ¥­â­®¬ã ¤®£®¢®àã
  Comment     :
  Modify
ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*/
import FIInter;
import Reporting;
import rep_lib;
import ofstream;


import testLib;

private CONST ALLFININSTR = -1,
              ALLCURRENCY = -2;


private class TPercCalcPrint(parameters)
    var m_tempOfstream = TOfstream("percCalc");
    var m_tablePrinter : CTableReport;
    var m_parameters;

    macro setHead()
        m_tablePrinter.AddColumn("ü ¤®ª",    15, AL_CENTER);
        m_tablePrinter.AddColumn("„ â ",     10, AL_CENTER);
        m_tablePrinter.AddColumn("‘ç¥â „â",  25, AL_CENTER);
        m_tablePrinter.AddColumn("‚ «îâ " ,  3,  AL_CENTER);
        m_tablePrinter.AddColumn("‘ã¬¬  „â", 16, AL_RIGHT);
        m_tablePrinter.AddColumn("‘ç¥â Šâ",  25, AL_CENTER);
        m_tablePrinter.AddColumn("‚ «îâ ",   3,  AL_CENTER);
        m_tablePrinter.AddColumn("‘ã¬¬  Šâ", 16, AL_RIGHT);

    end;

    macro getReportWidth()
        return m_tablePrinter.GetSumLen();
    end;

    macro printNoData()
        printLn();
        println("¥â ¤ ­­ëå ¤«ï ®âç¥â ");
    end;

    macro printReportHead()
        var dateIn  = m_parameters.getDateIn();
        var dateOut = m_parameters.getDateOut();

        printBankHeader(m_parameters.getDepartmentCode(), m_parameters.getOrgStructure(), getReportWidth());

        println();
        println(strAlign("„ ­­ë¥ ® ¯à®¢®¤ª å ¯® ¯à®æ¥­â­®¬ã ¤®£®¢®àã", getReportWidth(), STR_ALIGN_CENTER));
        printLn();

        if (dateIn == dateOut)
            printLn(strAlign("§  " + dateIn, getReportWidth(), STR_ALIGN_CENTER));
        else
            printLn(strAlign("c " + dateIn + " ¯® " + dateOut, getReportWidth(), STR_ALIGN_CENTER));
        end;

     end;

    macro printContractHead(data)
        var clientName;
        var backOfficeName;
        var currency;
        var dataSet;

        dataSet = TRsbDataSet("SELECT party.t_shortName client FROM drepParty_vw party WHERE party.t_id = " + data.clientId);
        dataSet.next();
        clientName = dataSet.client;

        dataSet = TRsbDataSet("SELECT val.t_code backOffice FROM dllvalues_dbt val WHERE val.t_list = 1118 AND val.t_element = " + data.backOffice);
        dataSet.next();
        backOfficeName = dataSet.backOffice;

        dataSet = TRsbDataSet("SELECT t_code code, t_name  name FROM drepFinInstrument_vw WHERE t_id = " + data.currency);
        dataSet.next();
        currency = dataSet.code + " " + dataSet.name;

        printLn();
        printLn("íª-®ä¨á: " + backOfficeName);
        printLn();
        printLn("Š«¨¥­â: " + clientName);
        printLn("à®æ¥­â­ë© ¤®£®¢®à: " + data.contractNumber);
        printLn("‹¨æ¥¢®© áç¥â: " + data.acc);
        printLn("‚ «îâ : " + currency);

    end;

    macro printOperationHead(dataSet)
        var data;
        data = TRsbDataSet("SELECT oper.t_name operationName FROM doprkDoc_dbt oper WHERE oper.t_docKind = " + dataSet.operationKind);
        data.next();

        printLn();
        printLn("’¨¯ ®¯¥à æ¨¨: " + data.operationName);

        m_tablePrinter.printHead();
    end;

    macro execute(dataSet)
        var isEmpty : bool = true;
        var curOperation = null;
        var curContract = null;
        var isPrintBottom : bool;
    var m_groundPrinter : CTableReport;
    m_groundPrinter = CTableReport();
    m_groundPrinter.AddColumn("", 15, AL_CENTER);
    m_groundPrinter.AddColumn("", 10, AL_CENTER);
    m_groundPrinter.AddColumn("", 109, AL_LEFT);


        printReportHead();

        while (dataSet.next())
            isEmpty = false;
            isPrintBottom = true;

            if (curContract != dataSet.contractId)
                if (curContract != null)
                    m_groundPrinter.printBottom();
                end;

                curContract = dataSet.contractId;
                printContractHead(dataSet);
                curOperation = null;
                isPrintBottom = false;
            end;

            if (curOperation != dataSet.operationKind)
                if (isPrintBottom)
                    m_groundPrinter.printBottom();
                end;

                isPrintBottom = false;
                curOperation = dataSet.operationKind;

                printOperationHead(dataSet);
            end;

            if (isPrintBottom)
                m_tablePrinter.printFreeString("ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´");
            end;

            m_tablePrinter.printString(dataSet.numberDoc, dataSet.dateCarry, dataSet.debetAcc, dataSet.debetFiCode, dataSet.debetSum,
                                                                             dataSet.creditAcc, dataSet.creditFiCode, dataSet.creditSum);

            m_tablePrinter.printFreeString("³                 ³            ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´");
            m_groundPrinter.printStringTransferByWord("","",dataSet.ground);
        end;

        if (isEmpty)
            printNoData();
        else
            m_groundPrinter.printBottom();
        end;

        printLn();
        printLn("¯¥à æ¨®­¨áâ " + {name_oper});

        m_tempOfstream.show();
    end;

    private macro constructorTPercCalcPrint(parameters)
        m_parameters = parameters;
        m_tempOfstream.setOutputFile();
        m_tablePrinter = CTableReport();
        setHead();
    end;

    constructorTPercCalcPrint(parameters);
end;




class TPercCalcData(param)

    macro getQueryText(param)
        var fromText;
        var whereText;
        var sortText;
        var selectText;

        selectText = " SELECT percContract.t_id contractId, percContract.t_number contractNumber, percOperDoc.t_type operationKind,      "
            + "\n" + "        repDoc.t_date dateCarry, repDoc.t_debetAccount debetAcc, repDoc.t_creditAccount creditAcc,                 "
            + "\n" + "        (SELECT t_code FROM drepFinInstrument_vw finInstr WHERE finInstr.t_id = repDoc.t_debetFiId) debetFiCode,   "
            + "\n" + "        (SELECT t_code FROM drepFinInstrument_vw finInstr WHERE finInstr.t_id = repDoc.t_creditFiId) creditFiCode, "
            + "\n" + "        repDoc.t_debetSum debetSum, repDoc.t_creditSum creditSum, repDoc.t_number numberDoc,                       "
            + "\n" + "        repDoc.t_ground ground, percContract.t_fiId currency, percContract.t_clientId clientId,                      "
            + "\n" + "        account.t_account acc, percContract.t_backOfficeCode backOffice                                            ";

         fromText = "    FROM repPercentContract_vw percContract,         "
           + "\n" + "         drepAccount_vw account,                     "
           + "\n" + "         repPercentOperationDocument_vw percOperDoc, "
           + "\n" + "         drepDocument_vw repDoc                      ";

        whereText = "   WHERE percContract.t_id       = percOperDoc.t_contractId "
           + "\n" + "     AND percContract.t_account  = account.t_account        "
           + "\n" + "     AND percContract.t_chapter  = account.t_chapter        "
           + "\n" + "     AND percContract.t_fiId     = account.t_fiId           "
           + "\n" + "     AND percOperDoc.t_documentId = repDoc.t_id             "
           + "\n" + "     AND repDoc.t_isInCardIndex = 0                         "
           + "\n" + "     AND percOperDoc.t_date BETWEEN " + getSqlDate(param.getDateIn())
           + "\n" + "                                AND " + getSqlDate(param.getDateOut())
           + "\n" + "     AND " + RepBranchAndDepartmentFieldFilter(param.getDepartmentList()).GetAsSqlString("account.t_departmentId",
                                                                                                              "account.t_branchId");

        sortText = " ORDER BY percContract.t_backOfficeCode asc";

        if ((param.getCodeCurrency() != ALLCURRENCY) AND (param.getCodeCurrency() != ALLFININSTR))
            whereText = whereText + " AND percContract.t_fiId = " + param.getCodeCurrency();
        elif (param.onlyForeignCur())
            whereText = whereText + " AND percContract.t_fiId <> " + NATCUR;
        end;

        if (param.getOper() != 0)
            if (param.getOperOrGroup() > 0)
                fromText  = fromText  + ", repUserGroup_vw operGroup ";
                whereText = whereText + " AND operGroup.t_userId = percContract.t_operId ";
                whereText = whereText + " AND operGroup.t_id = " + param.getOper();
            else
                whereText = whereText + " AND percContract.t_operId = " + param.getOper();
            end;
        end;

        if (param.getSubSystem() > 0)
            whereText = whereText + " AND percContract.t_backOfficecode = " + param.getSubSystem();
        end;

        if (param.getClient() > 0)
            whereText  = whereText  + " AND percContract.t_clientId = " + param.getClient();
        end;

        if (param.getContractOperation() > 0)
            whereText = whereText + " AND percOperDoc.t_type = " + param.getContractOperation()();
        end;

        if (param.getPercContractNumber() != 0)

            whereText = whereText + " AND percContract.t_number = " + param.getPercContractNumber();

        else

           if (param.getAccount() != "")
               whereText = whereText + " AND (" + convertMaskToSQLFormat(param.getAccount(), "percContract.t_account") + ")";
           end;

           if (param.getChapter() != 0)
               whereText = whereText + " AND percContract.t_chapter = " + param.getChapter();
           end;

           if (param.getBalance() != "")
               whereText = whereText + " AND (" + convertMaskToSQLFormat( param.getBalance(), "account.t_basicPlanBalance") + ")";
           end;

           if (param.getPercContractUserType() != "")
               whereText = whereText + " AND " + getPatternFilterClause("percContract.t_userType", param.getPercContractUserType(), param.getPercContractUserTypeMethod());
               // whereText = whereText + " AND regexp_like(percContract.t_userType,'[" + param.getPercContractUserType()+"]')";
           end;

        end;

        var sortingArraySize = param.getSort.Size();
        var sortingByTransactionArraySize = param.getSortByTransaction.Size();
        var i;

        if (sortingArraySize != 0)
            i = 0;

            while (i < sortingArraySize)
                if (param.getSort()[i] == REP_PATTERNSORT_CURRENCY)
                  fromText = fromText + ", drepFinInstrument_vw finInstr ";
                  whereText = whereText + " AND finInstr.t_id = percContract.t_fiId ";
                  sortText = sortText + ", finInstr.t_code asc, finInstr.t_id asc";
                elif (param.getSort()[i] == REP_PATTERNSORT_CLIENT)
                  selectText = selectText + ", perccontract.t_clientId clientId, (SELECT party.t_shortName FROM drepParty_vw party WHERE party.t_id = perccontract.t_clientId) clientName ";
                  sortText = sortText + ", clientName asc, percContract.t_clientId asc";
                end;

                i = i +1;
            end;
        end;
        sortText = sortText + ", percContract.t_number asc, percContract.t_id, percOperDoc.t_type ";

        if (sortingByTransactionArraySize != 0)
            i = 0;

            while (i < sortingByTransactionArraySize)
                if (param.getSortByTransaction()[i] == REP_PATTERNSORT_NUMBER_DOCUMENT)
                    sortText = sortText + ", repDoc.t_number ";

                elif (param.getSortByTransaction()[i] == REP_PATTERNSORT_DATE_DOCUMENT)
                    sortText = sortText + ", percOperDoc.t_date ";

                elif (param.getSortByTransaction()[i] == REP_PATTERNSORT_ACCOUNT_DEBIT)
                    sortText = sortText + ", repDoc.t_debetAccount ";

                elif (param.getSortByTransaction()[i] == REP_PATTERNSORT_ACCOUNT_CREDIT)
                    sortText = sortText + ", repDoc.t_creditAccount ";

                end;
                i = i + 1;
            end;
        else
            sortText = sortText + ", percOperDoc.t_date, repDoc.t_number ";
        end;

        return selectText + fromText + whereText + sortText;
    end;

    macro getDataSet(param)
        var dataSet;
        dataSet = TRsbDataSet(getQueryText(param));

        dataSet.setFieldType("dateCarry", V_DATE);
        dataSet.setFieldType("debetSum",  V_MONEY);
        dataSet.setFieldType("creditSum", V_MONEY);

        return dataSet;
    end;

    macro constructor(param)
        SQL_Execute("{ CALL  rep_data.setBalancePlanNumber(0) }");
        SQL_Execute("{ CALL  rep_data.setBeginDate(" + GetSQLDate(param.getDateIn()) + ") }");
        SQL_Execute("{ CALL  rep_data.setEndDate(" +  GetSQLDate(param.getDateOut()) + ") }");
    end;

    constructor(param);
end;

class TParamPercentCalculate(numDprt, orgStructure, issueMode, codeCurrency, foreignCur, dateIn, dateOut, operOrGroup, oper, subSystem, percContractNumber,
                             client, contractUserType, contractUserTypeMethod, contractOperation, chapter, balance, account, sort, sortByTransaction)

    private var m_numDprt;
    private var m_orgStructure;
    private var m_issueMode;
    private var m_codeCurrency;
    private var m_foreignCur;
    private var m_dateIn;
    private var m_dateOut;
    private var m_oper;
    private var m_operOrGroup;
    private var m_subSystem;
    private var m_percContractNumber;
    private var m_client;
    private var m_percContractUserType;
    private var m_percContractUserTypeMethod;
    private var m_contractOperation;
    private var m_sort;
    private var m_sortByTransaction;
    private var m_chapter;
    private var m_balance;
    private var m_account;
    private var m_departmentList;


    macro getDateIn()
        return m_dateIn;
    end;

    macro getDateOut()
        return m_dateOut;
    end;

    macro getDepartmentList()
        return m_departmentList;
    end;

    macro getOrgStructure()
        return m_orgStructure;
    end;

    macro getDepartmentCode()
        return m_numDprt;
    end;

    macro getCodeCurrency()
        return m_codeCurrency;
    end;

    macro onlyForeignCur()
        return m_foreignCur;
    end;

    macro getPercContractNumber()
        return m_percContractNumber;
    end;

    macro getAccount()
        return m_account;
    end;

    macro getOper()
        return m_oper;
    end;

    macro getOperOrGroup()
        return m_operOrGroup;
    end;

    macro getSubSystem()
        return m_subSystem;
    end;

    macro getChapter()
        return m_chapter;
    end;

    macro getBalance()
        return m_balance;
    end;

    macro getClient()
        return m_client;
    end;

    macro getPercContractUserType()
        return m_percContractUserType;
    end;

    macro getPercContractUserTypeMethod()
        return m_percContractUserTypeMethod;
    end;

    macro getSort()
        return m_sort;
    end;

    macro getSortByTransaction()
        return m_sortByTransaction;
    end;

    macro getContractOperation()
        return m_contractOperation;
    end;

    macro constructor(numDprt, orgStructure, issueMode, codeCurrency, foreignCur, dateIn, dateOut, operOrGroup, oper, subSystem, percContractNumber,
                      client, contractUserType, contractUserTypeMethod, contractOperation, chapter, balance, account, sort, sortByTransaction)

        m_numDprt                      = numDprt;
        m_orgStructure                 = orgStructure;
        m_issueMode                    = issueMode;
        m_codeCurrency                 = codeCurrency;
        m_foreignCur                   = foreignCur;
        m_dateIn                       = dateIn;
        m_dateOut                      = dateOut;
        m_oper                         = oper;
        m_subSystem                    = subSystem;
        m_percContractNumber           = percContractNumber;
        m_client                       = client;
        m_percContractUserType         = contractUserType;
        m_percContractUserTypeMethod   = contractUserTypeMethod;
        m_chapter                      = chapter;
        m_balance                      = balance;
        m_account                      = account;
        m_operOrGroup                  = operOrGroup;
        m_sort                         = sort;
        m_sortByTransaction            = sortByTransaction;
        m_contractOperation            = contractOperation;

        m_departmentList = RepDepartmentList(m_orgStructure, m_issueMode, m_numDprt);
    end;


    constructor(numDprt, orgStructure, issueMode, codeCurrency, foreignCur, dateIn, dateOut, operOrGroup, oper, subSystem, percContractNumber,
                client, contractUserType, contractUserTypeMethod, contractOperation, chapter, balance, account, sort, sortByTransaction);
end;


/*
   á­®¢­ ï äã­ªæ¨ï
*/
macro printPercentReport(numDprt, orgStructure, issueMode, codeCurrency, foreignCur, dateIn, dateOut, operOrGroup, oper, subSystem, percContractNumber,
                         client, contractUserType, contractUserTypeMethod, contractOperation, chapter, balance, account, sort, sortByTransaction)


    var profiler = TSQLProfiler(getTxtFileName("!PercDocSheetProfile"));
    profiler.clear();
    profiler.on();

    var parameters = TParamPercentCalculate (numDprt, orgStructure, issueMode, codeCurrency, foreignCur, dateIn, dateOut, operOrGroup, oper, subSystem, percContractNumber,
                                             client, contractUserType, contractUserTypeMethod, contractOperation, chapter, balance, account, sort, sortByTransaction);

    /* Š®­âà®«ì ®âªàëâëå ®¯¥à¤­¥© */
     if (not RepOperdaysOpened(parameters.getDepartmentList(), parameters.getDateIn(), parameters.getDateOut()).shouldContinue())
        exit(1);
    end;

    var percCalcPrint = TPercCalcPrint(parameters).execute(TPercCalcData(parameters).getDataSet(parameters));

    return true;

end;
