/**
 *  RS-Bank 6.0                                           R-Style Software Lab
 *  Module  : r_cmagz_parameters.mac
 *  Purpose : Парметры отчета "Кассовый журнал".
 *  Comment : Парметры отчета "Кассовый журнал".
 *  @since    20.09.2010
 *  @author   Shestakov Dmitry
 *  @version  6.00.020.29
 */
import repException;
import Reporting;
import rep_lib;

/**
 * Глобальная ссылка для хранения.
 */    

private var m_parameters = null;

const WELL_DONE          = 0;
const ERROR              = 1;
const NO_ACCOUNTS        = 2;
const NO_DOCUMENTS       = 3;
const OPERDAY_NOT_PASSED = 4;

/**
 * Параметры отчета.
 */
private class TCashJournalParameters(parmArray : TArray)

    // Варианты разбовок и группировок, задаваемые через панель параметров
    private const GROUPING_BY_DATE           = 1; //  По дням без группировки
    private const GROUPING_BY_DATE_PACK      = 2; //  По дням и группировать по пачкам
    private const GROUPING_BY_DATE_OPER      = 3; //  По дням и группировать по операционистам
    private const GROUPING_BY_DATE_OPER_PACK = 4; //  По дням и группировать по операционистам и пачкам
    private const GROUPING_BY_NONE           = 5; //  Без разбивки по дням
    private const GROUPING_BY_OPER_PACK      = 6; //  Без разбивки по дням с группирвкой по операционистам и пачкам

    /**
     * Код подразделения.
     */
    private var m_departmentCode : Integer;
    
    /**
     * Оргструктура.
     */
    private var m_orgStructure : Integer;
    
    /**
     * Режим выпуска.
     */
    private var m_issueMode : Integer;
    
    /**
     * Валюта.
     */
    private var m_fiId : Integer;
    
    /**
     * Дата начала отчетного периода.
     */
    private var m_dateIn : Date;
    
    /**
     * Дата конца отчетного периода.
     */
    private var m_dateOut : Date;
    
    /**
     * Группа операционистов
     */
    private var m_isGroup : Bool;
    
    /**
     * Операционист.
     */
    private var m_oper : Integer;

    /**
     * Пачка.
     */
    private var m_packNumber : Integer;

    /**
     * Проверяющий.
     */
    private var m_inspectorNumber : Integer;

    /**
     * Вид журнала.
     */
    private var m_journalKind : Integer;
    
    /**
     * Номер лицевого счета.
     */
    private var m_accountNumber : String;

    /**
     * Форма кассового журнала.
     */
    private var m_groupingKind : Integer;

    /**
     * Шаблон сортировки отчетов
     */
    private var m_sortReportPattern : TArray;
    
    /**
     * Шаблон сортировки записей
     */
    private var m_sortRecortPattern : TArray;
    
    /**
     * Суммы прописью.
     */
    private var m_isPrintSpellSum : Bool;

    private var m_departmentList : RepDepartmentList;
    
    private var m_ocpAccountServer : RepOcpAccountServer;

    private var m_accountFilter : RepAccountFilter;

    private var m_pageSize : Integer;

    private var m_needNonbalanceSymbols : Bool;

    private var m_inspectorSignatureRow : String;

    macro getDepartmentCode() : Integer
        return m_departmentCode;
    end;
    
    macro getOrgStructure() : Integer
        return m_orgStructure;
    end;
    
    macro getIssueMode() : Integer
        return m_issueMode;
    end;
    
    macro getFiId() : Integer
        return m_fiId;
    end;
    
    macro getDateIn() : Date
        return m_dateIn;
    end;
    
    macro getDateOut() : Date
        return m_dateOut;
    end;

    macro isGroup() : Bool
        return ternary(m_isGroup == 0, false, true);
    end;
    
    macro getOper() : Integer
        return m_oper;
    end;
    
    macro getPackNumber() : Integer
        return m_packNumber;
    end;
    
    macro getInspectorNumber() : Integer
        return m_inspectorNumber;
    end;

    macro getInspectorSignatureRow()
        return m_inspectorSignatureRow;
    end;
    
    macro getJournalKind() : Integer
        return m_journalKind;
    end;
    
    macro getAccountNumber() : String
        return m_accountNumber;
    end;
    
    macro getGroupingKind() : Integer
        return m_groupingKind;
    end;
    
    macro getSortReportPattern() : TArray
        return m_sortReportPattern;
    end;

    macro getSortRecordPattern() : TArray
        return m_sortRecortPattern;
    end;

    macro isPrintSpellSum() : Bool
        return m_isPrintSpellSum;
    end;
    
    macro getDepartmentList() : RepDepartmentList
        return m_departmentList;
    end;
    
    macro getOcpAccountServer() : RepOcpAccountServer
        return m_ocpAccountServer;
    end;

    macro getAccountFilter() : RepAccountFilter
        return m_accountFilter;
    end;

    macro getPageSize() : Integer
        return m_pageSize;
    end;

    macro isNeedNonbalanceSymbols() : Bool
        return m_needNonbalanceSymbols;
    end;

    macro isNeedDaysSplit() : Bool
        return in(m_groupingKind, GROUPING_BY_DATE, GROUPING_BY_DATE_PACK, GROUPING_BY_DATE_OPER, GROUPING_BY_DATE_OPER_PACK);
    end;

    macro isNeedPackGroup() : Bool
        return in(m_groupingKind, GROUPING_BY_DATE_PACK, GROUPING_BY_DATE_OPER_PACK, GROUPING_BY_OPER_PACK);
    end;

    macro isNeedOperGroup() : Bool
        return in(m_groupingKind, GROUPING_BY_DATE_OPER, GROUPING_BY_DATE_OPER_PACK, GROUPING_BY_OPER_PACK);
    end;

    /**
     * @param     newM_dateIn
     */
    macro setDateIn(newM_dateIn : Date)
        m_dateIn = newM_dateIn;
    end;
    
    /**
     * @param     newM_dateOut
     */
    macro setDateOut(newM_dateOut : Date)
        m_dateOut = newM_dateOut;
    end;

    /**
     * @param     m_departmentCode   
     * @param     m_orgStructure     
     * @param     m_issueMode        
     * @param     m_fiId             
     * @param     m_dateIn           
     * @param     m_dateOut          
     * @param     m_isGroup
     * @param     m_oper             
     * @param     m_packNumber       
     * @param     m_inspectorNumber       
     * @param     m_journalKind       
     * @param     m_accountNumber       
     * @param     m_groupingKind       
     * @param     m_sortReportPattern       
     * @param     m_sortRecortPattern       
     * @param     m_isPrintSpellSum
     */
    private macro constructor(parmArray : TArray)
        var i = -1;

        m_departmentCode     = parmArray[i=i+1];
        m_orgStructure       = parmArray[i=i+1];
        m_issueMode          = parmArray[i=i+1];
        m_fiId               = parmArray[i=i+1];
        m_dateIn             = parmArray[i=i+1];
        m_dateOut            = parmArray[i=i+1];
        m_isGroup            = parmArray[i=i+1];
        m_oper               = parmArray[i=i+1];
        m_packNumber         = parmArray[i=i+1];
        m_inspectorNumber    = parmArray[i=i+1];
        m_journalKind        = parmArray[i=i+1];
        m_accountNumber      = parmArray[i=i+1];
        m_groupingKind       = parmArray[i=i+1];
        m_sortReportPattern  = parmArray[i=i+1];
        m_sortRecortPattern  = parmArray[i=i+1];
        m_isPrintSpellSum    = parmArray[i=i+1];

        m_departmentList     = RepDepartmentList(m_orgStructure, m_issueMode, m_departmentCode);
        m_ocpAccountServer   = RepOcpAccountServer(1/*m_chapterNumber*/, m_fiId, m_departmentList);
        m_accountFilter      = RepAccountFilter(m_departmentList, PRIV_GET_ACCOUNT_DATA_FOR_REPORTS);

        var stat, valType, keyPath;

        keyPath ="REPORT/КОЛИЧЕСТВО СТРОК НА A4(КНИЖ)";
        valType = getRegistryValue(keyPath, V_INTEGER, m_pageSize, stat);
        if ((stat != 0) or (valType != V_INTEGER))
            MsgBox("Не определен параметр печати", keyPath, " в настройка банка.\n",
                   "Будет выполнена печать с КОЛИЧЕСТВО СТРОК НА A4(КНИЖ) = 62.");
            m_pageSize = 62;
        end;

        keyPath ="REPORT/КАССОВЫЙ ЖУРНАЛ/ПЕЧАТЬ ЗАБАЛАНСОВЫХ СИМВОЛОВ";
        valType = getRegistryValue(keyPath, V_BOOL, m_needNonbalanceSymbols, stat);
        if ((stat != 0) or (valType != V_BOOL))
            MsgBox("Не определен параметр печати", keyPath, " в настройка банка.\n",
                   "Будет выполнена печать с забалансовыми символами.");
            m_needNonbalanceSymbols = true;
        end;

        m_inspectorSignatureRow = "";
        if (getInspectorNumber() != 0)
            var inspectorDataSet = TRsbDataSet(
                           "SELECT officer.t_post position, person.t_name name"
                  + "\n" + "  FROM dperson_dbt person"
                  + "\n" + "      INNER JOIN dofficer_dbt officer"
                  + "\n" + "          ON (officer. t_personid = person.t_partyid)"
                  + "\n" + " WHERE person.t_Oper = " + getInspectorNumber());
            if (inspectorDataSet.next())
                m_inspectorSignatureRow = inspectorDataSet.position + " ___________________ " + inspectorDataSet.name;
            end;
        end;

    end;
    
    constructor(parmArray);
end;

/**
 * Точка доступа.
 */ 
macro cjParameters() : TCashJournalParameters
    var i = 0;
    var parmArray = TArray();
    if (m_parameters == null)
        if (parmCount() == 0) 
            throw(TWrongParametersCountException(cjParameters));
        end;

        while (i < parmCount())
            getParm(i, parmArray[i]);
            i = i + 1;
        end;

        m_parameters = TCashJournalParameters(parmArray);
    end;
    
    return m_parameters;
end;