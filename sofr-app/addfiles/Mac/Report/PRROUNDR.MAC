/*───────────────────────────────────────────────────────────────────────────┐
  RS-Bank 4.3,5.0,5.1                                    R-Style Software Lab

  Макрос содержит функции для вывода отчёта об округлении баланса.
  Функции вызываются при рассчёте баланса из исполняемого модуля подсистем
  "Отчёты банка" или "Отчёты ЦБ".

FILENAME: PRROUBDR.MAC
CREATED: 16.04.99 Мол.
MODIFICATIONS:
  01.11.99 Мол. Функция "ВывестиНазваниеГлавы" вызывается теперь из кода
    проаграммы, а не из макроса.
NOTES:

└───────────────────────────────────────────────────────────────────────────*/

VAR
   DbgMsg = False;

MACRO PrDbgMsg( msg)
  if ( DbgMsg )
    print( "!!!!! ", msg);
  end;
END;

MACRO ЗаголовокОтчетаОкругления( строка, номер_строки)
  println( строка);
END;

MACRO НазваниеГлавы( Глава)

FILE ГлавыБаланса( obchaptr) KEY 0;

  ГлавыБаланса.Chapter = Глава;

  if ( GetEQ( ГлавыБаланса) )
    return ГлавыБаланса.Name;
  end;

  return "";
END;

MACRO p()
VAR
   s = "", x, i = 0;

  while ( GetParm( i, x) )
    s = s + x;
    i = i + 1;
  end;
  println( s);
END;

ARRAY AS1;
ARRAY AS2;

MACRO ПервичнаяШапка( Глава, h1, h2)
var
   s1 = "┬─────",
   s2 = "│     ",
   s4 = "┴─────";

 if ( Глава == 5 )
   s1 = "─";
   s2 = " ";
   s4 = "─";
 end;

PrDbgMsg( "Первичная шапка");

  strsplit( h1, AS1, 28, 28, 3);
  strsplit( h2, AS2, 28, 28, 3);

p("┌─────────────────────",s1,"┬────────────────────────────┬────────────────────────────┐");
p("│ Номер счёта         ",s2,"│",string( AS1(0):28:c),    "│",string( AS2(0):28:c),    "│");
p("│                     ",s2,"│",string( AS1(1):28:c),    "│",string( AS2(1):28:c),    "│");
p("│                     ",s2,"│",string( AS1(2):28:c),    "│",string( AS2(2):28:c),    "│");
p("├─────────────────────",s4,"┴────────────────────────────┴────────────────────────────┤");

END;

MACRO ВторичнаяШапка( Глава, h)
var
   s1 = "      ",
   s2 = "┬─────";

PrDbgMsg( "Вторичная шапка");

 if ( Глава == 5 )
   s1 = " ";
   s2 = "─";
 end;

p("│                     ",s1," ", string( h:33:c),             "                        │");
p("├─────────────────────",s2,"┬────────────────────────────┬────────────────────────────┤");
END;

MACRO ПромежуточнаяШапка( Глава, h)
VAR
   s1 = "      ";

 if ( Глава == 5 )
   s1 = " ";
 end;

PrDbgMsg( "Промежуточная шапка");

p("│                     ",s1," ",string( h:30:c),          "                           │");
END;

MACRO ВывестиЗначения( Глава, Счет, rR, rV, r, tR, tV, t)
var
   srR = string( rR:28:0), stR = string( tR:28:0),
   srV = string( rV:28:0), stV = string( tV:28:0),
   s_r = string(  r:28:0), s_t = string(  t:28:0),
   s1 = "Счёт 2-го порядка No ",
   s2 = string( SubStr( Счет, 1, 20):20, " "),
   s3 = "                     ",
   s4 = "─────────────────────";

PrDbgMsg( "Вывести значение");

  if ( Глава == 5 )
    srR = s_r; stR = s_t;
    srV = stV = MkStr( " ", 28);
    s1 = s1 + " ";
    s2 = s2 + " ";
    s4 = s4 + "─";
  else
    s1 = s1 + "│руб. ";
    s2 = s2 + "│вал. ";
    s3 = s3 + "│итого";
    s4 = s4 + "┼─────";
  end;

p("│",s1,"│", srR,                    "│", stR,                    "│");
p("│",s2,"│", srV,                    "│", stV,                    "│");
  if ( not (Глава == 5) )
p("│",s3,"│", s_r,                    "│", s_t,                    "│");
  end; /*if*/
p("├",s4,"┼────────────────────────────┼────────────────────────────┤");

END;

MACRO Итого_по( Глава, Name, edge, rR, rV, r, tR, tV, t)
var
   srR = string( rR:28:0), stR = string( tR:28:0),
   srV = string( rV:28:0), stV = string( tV:28:0),
   s_r = string(  r:28:0), s_t = string(  t:28:0),
   s1 = string( "Итого по ", Name:10, " "),
   s2 = "                    ",
   s3 = "",
   s4 = "────────────────────",
   edge2 = "┴",
   edge3 = "┘";

  if ( edge == "├" )
    edge2 = "┼";
    edge3 = "┤";
  end;

PrDbgMsg( "Итого по ...");

  s4 = s4 + edge2;
  s3 = s2;

  if ( Глава == 5 )
    srR = s_r; stR = s_t;
    s1 = s1 + " ";
    s2 = s2 + " ";
    s4 = "─" + s4;
  else
    s1 = s1 + "│руб. ";
    s2 = s2 + "│вал. ";
    s3 = s3 + "│итого";
    s4 = s4 + "─────"+edge2;
  end;

p("│ ",s1,"│", srR,                    "│", stR,                    "│");
  if ( not (Глава == 5) )
p("│ ",s2,"│", srV,                    "│", stV,                    "│");
p("│ ",s3,"│", s_r,                    "│", s_t,                    "│");
  end; /*if*/
p(edge,
   "─",s4,"────────────────────────────",
                                  edge2,"────────────────────────────",edge3);
END;

MACRO ШапкаРасхожденияСтроки( Глава)
[ В результате округления образовались расхождения по строкам    ];
  if ( not (Глава == 5) )
[┌──────────────────────┬───────────────────────────────────────┐];
[│ Номер счёта          │   Расхождения по строке (*)           │];
[│                      ├────────────┬────────────┬─────────────┤];
[│                      │ В руб.     │В ин.вал    │  Итого      │];
[│                      │            │в руб.экв-те│             │];
[├──────────────────────┼────────────┼────────────┼─────────────┤];
  else
[┌──────────────────────┬──────────────────────────┐];
[│ Номер счёта          │Расхождения по строке (*) │];
[├──────────────────────┼──────────────────────────┤];
  end;
END;

MACRO РасхождениеСтр( Глава, Счет, tR, tV, t)
  if ( not (Глава == 5) )
[│ Счёт 2-го порядка No │############│############│############ │]( tR:0:0, tV:0:0, t:0:0);
[│ #################### │            │            │             │](Счет);
[├──────────────────────┼────────────┼────────────┼─────────────┤];
  else
[│ Счёт 2-го порядка No │        ###########       │]( t:0:0);
[│ #################### │                          │](Счет);
[├──────────────────────┼──────────────────────────┤];
  end;
END;

MACRO ЗаключениеРасхожденияСтроки()
[ (*) расхождение по строке равно ];
[для активного счёта : (нормированный входящий остаток + нормированные ];
[ обороты по дебету - нормированные обороты по кредиту) - нормированный];
[  исходящий остаток                                                   ];
[для пассивного счёта : (нормированный входящий остаток - нормированные];
[ обороты по дебету + нормированные обороты по кредиту) - нормированный];
[  исходящий остаток                                                   ];
[   ];
END;

MACRO ВывестиНазваниеГлавы( Глава)
var
  НГ = НазваниеГлавы( Глава);

  if ( not (НГ == "") )
    println( "Глава ", Глава, " \"", НГ, "\"");
  else
    println( "Глава ", Глава);
  end;
  println;
END;

MACRO копейками( Глава)
  if ( not (Глава == 5) )
    return " копейками";
  end;

  return "";
END;

ARRAY ШапкаВидаОкругления;

MACRO ШапкаВидОкр1( Глава, Признак) /* В тысячах */
  if   ( Признак == "А" )
/*    ВывестиНазваниеГлавы( Глава);
    println; */
    p(" Были произведены корректировки округлённых значений исходящих остатков ");
    ПервичнаяШапка( Глава, "Остаток реальный","Округлённое значение, полученное после корректировки");
    ВторичнаяШапка( Глава, "Актив");
  elif ( Признак == "П" )
    ВторичнаяШапка( Глава, "Пассив");
  elif ( Признак == "Д" ) /* Загловок "дебет" */
    println;
    p(" Были произведены корректировки округлённых значений оборотов");
    ПервичнаяШапка( Глава, "Оборот реальный","Округлённое значение, полученное после корректировки");
    ВторичнаяШапка( Глава, "Дебетовые обороты");
  elif ( Признак == "К" ) /* Загловок "кредит" */
    ВторичнаяШапка( Глава, "Кредитовые обороты");
  elif ( Признак == "ВА" ) /* Загловок "входящий актив" */
    println;
    p(" Расхождения полученных значений входящих остатков с округлёнными", копейками( Глава));
    ПервичнаяШапка( Глава, "Остаток реальный","Полученное после пересчёта значение");
    ВторичнаяШапка( Глава, "Актив");
  elif ( Признак == "ВП" ) /* Загловок "входящий пассив" */
    ВторичнаяШапка( Глава, "Пассив");
  else
    msgbox( "Ошибочный вызов функции \"ШапкаВидОкр1\"");
  end;
END;

MACRO ШапкаВидОкр2( Глава, Признак) /* В тысячах 2 */
  if   ( Признак == "А" )
    ПромежуточнаяШапка( Глава, "Округление исходящих остатков");
    ВторичнаяШапка( Глава, "Актив");
  elif ( Признак == "П" )
    ПромежуточнаяШапка( Глава, "Округление исходящих остатков");
    ВторичнаяШапка( Глава, "Пассив");
  elif ( Признак == "Д" ) /* Загловок "дебет" */
    println;
    p(" Расхождения полученных значений оборотов с округлёнными", копейками( Глава));
    ПервичнаяШапка( Глава, "Оборот реальный","Округлённое значение, полученное после корректировки");
    ВторичнаяШапка( Глава, "Дебетовые обороты");
  elif ( Признак == "К" ) /* Загловок "кредит" */
    ВторичнаяШапка( Глава, "Кредитовые обороты");
  elif ( Признак == "ВА" ) /* Загловок "входящий актив" */
    println;
/*    ВывестиНазваниеГлавы( Глава);
    println;
*/
    p(" Были произведены корректировки округлённых значений");
    ПервичнаяШапка( Глава, "Остаток реальный","Округлённое значение, полученное после корректировки");
    ПромежуточнаяШапка( Глава, "Округление входящих остатков");
    ВторичнаяШапка( Глава, "Актив");
  elif ( Признак == "ВП" ) /* Загловок "входящий пассив" */
    ПромежуточнаяШапка( Глава, "Округление входящих остатков");
    ВторичнаяШапка( Глава, "Пассив");
  else
    msgbox( "Ошибочный вызов функции \"ШапкаВидОкр2\"");
  end;
END;

MACRO ШапкаВидОкр3( Глава, Признак) /* В тысячах 3 */
  if   ( Признак == "А" )
    ПромежуточнаяШапка( Глава, "Округление исходящих остатков");
    ВторичнаяШапка( Глава, "Актив");
  elif ( Признак == "П" )
    ПромежуточнаяШапка( Глава, "Округление исходящих остатков");
    ВторичнаяШапка( Глава, "Пассив");
  elif ( Признак == "Д" ) /* Загловок "дебет" */
    println;
    p(" Были произведены корректировки округлённых значений оборотов");
    ПервичнаяШапка( Глава, "Оборот реальный","Округлённое значение, полученное после корректировки");
    ВторичнаяШапка( Глава, "Дебетовые обороты");
  elif ( Признак == "К" ) /* Загловок "кредит" */
    ВторичнаяШапка( Глава, "Кредитовые обороты");
  elif ( Признак == "ВА" ) /* Загловок "входящий актив" */
    println;
/*    ВывестиНазваниеГлавы( Глава);
    println;
*/
    p(" Были произведены корректировки округлённых значений входящих и исходящих остатков");
    ПервичнаяШапка( Глава, "Остаток реальный","Округлённое значение, полученное после корректировки");
    ПромежуточнаяШапка( Глава, "Округление входящих остатков");
    ВторичнаяШапка( Глава, "Актив");
  elif ( Признак == "ВП" ) /* Загловок "входящий пассив" */
    ПромежуточнаяШапка( Глава, "Округление входящих остатков");
    ВторичнаяШапка( Глава, "Пассив");
  else
    msgbox( "Ошибочный вызов функции \"ШапкаВидОкр3\"");
  end;
END;

MACRO ШапкаВидОкр4( Глава, Признак) /* В тысячах 4 */
  if   ( Признак == "А" )
    ПромежуточнаяШапка( Глава, "Округление исходящих остатков");
    ВторичнаяШапка( Глава, "Актив");
  elif ( Признак == "П" ) /* Загловок "пассив" */
    ПромежуточнаяШапка( Глава, "Округление исходящих остатков");
    ВторичнаяШапка( Глава, "Пассив");
  elif ( Признак == "Д" ) /* Загловок "дебет" */
    println;
    p(" Были произведены корректировки округлённых значений оборотов");
    ПервичнаяШапка( Глава, "Оборот реальный","Округлённое значение, полученное после корректировки");
    ВторичнаяШапка( Глава, "Дебетовые обороты");
  elif ( Признак == "К" ) /* Загловок "кредит" */
    ВторичнаяШапка( Глава, "Кредитовые обороты");
  elif ( Признак == "ВА" ) /* Загловок "входящий актив" */
    println;
/*    ВывестиНазваниеГлавы( Глава);
    println;*/
    p(" Были произведены корректировки округлённых значений входящих и исходящих остатков");
    ПервичнаяШапка( Глава, "Остаток реальный","Округлённое значение, полученное после корректировки");
    ПромежуточнаяШапка( Глава, "Округление входящих остатков");
    ВторичнаяШапка( Глава, "Актив");
  elif ( Признак == "ВП" ) /* Загловок "входящий пассив" */
    ПромежуточнаяШапка( Глава, "Округление входящих остатков");
    ВторичнаяШапка( Глава, "Пассив");
  else
    msgbox( "Ошибочный вызов функции \"ШапкаВидОкр4\"");
  end;
END;

ШапкаВидаОкругления(2) = @ШапкаВидОкр1; /* В тысячах 1 */
ШапкаВидаОкругления(3) = @ШапкаВидОкр2; /* В тысячах 2 */
ШапкаВидаОкругления(4) = @ШапкаВидОкр3; /* В тысячах 3 */
ШапкаВидаОкругления(5) = @ШапкаВидОкр4; /* В тысячах 4 */
ШапкаВидаОкругления(6) = @ШапкаВидОкр4; /* В тысячах 5 */

/*
  Глава задаётся её номером
  Признак задаётся строкой
   "А"  - для актива,
   "П"  - для пассива,
   "Д"  - дебетовые обороты
   "К"  - кредитовые обороты
   "ВА" - входящие активные остатки
   "ВП" - входящие пассивные остатки
  пусой строкой для вывода данных.
*/
MACRO СтрокаОтчета( ВидОкр, Глава, Признак, Счет, rR, rV, r, tT, tV, t)
VAR
   НГ;

  /* проверить обрабатываемый вид округления */

  if ( not ((ВидОкр >= 3) and (ВидОкр <= 6)) )
    if ( ВидОкр == 2 )
      msgbox( string( "Вид округления \"В тысячах\" более не поддерживается"));
    end;
    msgbox( string( "Неверно задан вид округления (", ВидОкр, ")"));
    Exit( 1);
  end;

  /* Вывести шапку, если задано */

  if (    (Признак == "А")  or (Признак == "П" )
       or (Признак == "Д" ) or (Признак == "К" )
       or (Признак == "ВА") or (Признак == "ВП")
     )
    ExecMacro( ШапкаВидаОкругления(ВидОкр), Глава, Признак);

  elif ( Признак == "ИВА")
    Итого_по( Глава, "активу", "├", rR, rV, r, tT, tV, t);

  elif ( Признак == "ИВП" ) /* Загловок "входящий пассив - итог" */
    Итого_по( Глава, "пассиву", "└", rR, rV, r, tT, tV, t);

  elif ( Признак == "ИД" ) /* Загловок "дебет - итог" */
    Итого_по( Глава, "дебету", "├", rR, rV, r, tT, tV, t);

  elif ( Признак == "ИК" ) /* Загловок "кредит - итог" */
    Итого_по( Глава, "кредиту", "└", rR, rV, r, tT, tV, t);

  else /* Вывести суммы */
    ВывестиЗначения( Глава, Счет, rR, rV, r, tT, tV, t);
  end;
END;

MACRO Сообщение_НетДанных( НомерСообщения ) /* Номер прописан в "C" U_FLOORR.C */
var s = "";

  if   ( НомерСообщения ==  1 )
    s = "Корректировки округлённых значений исходящих остатков произведены не были";
  elif ( НомерСообщения ==  2 )
    s = "Корректировки округлённых значений оборотов произведены не были";
  elif ( НомерСообщения ==  3 )
    s = "Расхождений полученных значений входящих остатков с округлёнными копейками нет";
  elif ( НомерСообщения ==  4 )
    s = "Расхождений полученных значений входящих остатков с округлёнными значениями нет";
  elif ( НомерСообщения ==  5 )
    s = "Корректировки округлённых значений произведены не были";
  elif ( НомерСообщения ==  6 )
    s = "Расхождений полученных значений обротов с округлёнными копейками нет";
  elif ( НомерСообщения ==  7 )
    s = "Расхождений полученных значений обротов с округлёнными значениями нет";
  elif ( НомерСообщения ==  8 )
    s = "Корректировки округлённых значений входящих и исходящих остатков произведены не были";
  elif ( НомерСообщения ==  9 )
    s = "Расхождений по строкам нет";
/*
  elif ( НомерСообщения == 10 )
    s = "";
  elif ( НомерСообщения == 11 )
    s = "";
  elif ( НомерСообщения == 12 )
    s = "";
  elif ( НомерСообщения == 13 )
    s = "";
  elif ( НомерСообщения == 14 )
    s = "";
  elif ( НомерСообщения == 15 )
    s = "";
  elif ( НомерСообщения == 16 )
    s = "";
  elif ( НомерСообщения == 17 )
    s = "";
*/
  else
    s = "Неопределённый номер сообщения";
  end;

  println;
  println( s);
  println;
END;

/*════════╗
║  Тесты  ║
╚════════*/

/*
MACRO ПечатьВТысячах( Глава)
  СтрокаОтчета( 2, Глава, "А",      "", $0, $0, $0, 0.0, 0.0, 0.0);
  СтрокаОтчета( 2, Глава, "",  "12345", $0, $0, $0, 0.0, 0.0, 0.0);

  СтрокаОтчета( 2, Глава, "П",      "", $0, $0, $0, 0.0, 0.0, 0.0);
  СтрокаОтчета( 2, Глава, "",  "23456", $1, $2, $3, 1.1, 2.2, 3.3);

  СтрокаОтчета( 2, Глава, "Д",      "", $0, $0, $0, 0.0, 0.0, 0.0);
  СтрокаОтчета( 2, Глава, "",  "56788", $1, $2, $3, 1.1, 2.2, 3.3);
  СтрокаОтчета( 2, Глава, "",  "87654", $1, $2, $3, 1.1, 2.2, 3.3);

  СтрокаОтчета( 2, Глава, "К",      "", $0, $0, $0, 0.0, 0.0, 0.0);
  СтрокаОтчета( 2, Глава, "",  "56788", $1, $2, $3, 1.1, 2.2, 3.3);

  СтрокаОтчета( 2, Глава, "ВА",     "", $0, $0, $0, 0.0, 0.0, 0.0);
  СтрокаОтчета( 2, Глава, "",  "56788", $1, $2, $3, 1.1, 2.2, 3.3);
  СтрокаОтчета( 2, Глава, "ИВА", "",    $1, $2, $3, 1.1, 2.2, 3.3);

  СтрокаОтчета( 2, Глава, "ВП",     "", $0, $0, $0, 0.0, 0.0, 0.0);
  СтрокаОтчета( 2, Глава, "",  "87658", $1, $0, $1, 0.1, 0.2, 3.3);
  СтрокаОтчета( 2, Глава, "",  "87658", $2, $0, $2, 0.1, 0.0, 0.1);
  СтрокаОтчета( 2, Глава, "ИВП", "",    $3, $0, $3, 1.2, 0.2, 3.4);
END;

MACRO ПечатьВТысячах2( Глава)
  СтрокаОтчета( 3, Глава, "ВА",     "", $0, $0, $0, 0.0, 0.0, 0.0);
  СтрокаОтчета( 3, Глава, "",  "56788", $1, $2, $3, 1.1, 2.2, 3.3);
  СтрокаОтчета( 3, Глава, "ВП",     "", $0, $0, $0, 0.0, 0.0, 0.0);
  СтрокаОтчета( 3, Глава, "",  "56788", $1, $2, $3, 1.1, 2.2, 3.3);

  СтрокаОтчета( 3, Глава, "А",      "", $0, $0, $0, 0.0, 0.0, 0.0);
  СтрокаОтчета( 3, Глава, "",  "12345", $0, $0, $0, 0.0, 0.0, 0.0);
  СтрокаОтчета( 3, Глава, "П",      "", $0, $0, $0, 0.0, 0.0, 0.0);
  СтрокаОтчета( 3, Глава, "",  "23456", $1, $2, $3, 1.1, 2.2, 3.3);

  СтрокаОтчета( 3, Глава, "Д", "",      $0, $0, $0, 0.0, 0.0, 0.0);
  СтрокаОтчета( 3, Глава, "",  "56788", $1, $2, $3, 1.1, 2.2, 3.3);
  СтрокаОтчета( 3, Глава, "",  "87654", $1, $2, $3, 1.1, 2.2, 3.3);
  СтрокаОтчета( 3, Глава, "ИД","",      $2, $4, $6, 2.2, 4.4, 6.6);

  СтрокаОтчета( 3, Глава, "К", "",      $0, $0, $0, 0.0, 0.0, 0.0);
  СтрокаОтчета( 3, Глава, "",  "56788", $1, $2, $3, 1.1, 2.2, 3.3);
  СтрокаОтчета( 3, Глава, "ИК","",      $1, $2, $3, 1.1, 2.2, 3.3);
END;

MACRO ПечатьВТысячах3( Глава)
  СтрокаОтчета( 4, Глава, "ВА",     "", $0, $0, $0, 0.0, 0.0, 0.0);
  СтрокаОтчета( 4, Глава, "",  "56788", $1, $2, $3, 1.1, 2.2, 3.3);
  СтрокаОтчета( 4, Глава, "ВП",     "", $0, $0, $0, 0.0, 0.0, 0.0);
  СтрокаОтчета( 4, Глава, "",  "56788", $1, $2, $3, 1.1, 2.2, 3.3);
  СтрокаОтчета( 4, Глава, "А",      "", $0, $0, $0, 0.0, 0.0, 0.0);
  СтрокаОтчета( 4, Глава, "",  "12345", $0, $0, $0, 0.0, 0.0, 0.0);
  СтрокаОтчета( 4, Глава, "П",      "", $0, $0, $0, 0.0, 0.0, 0.0);
  СтрокаОтчета( 4, Глава, "",  "23456", $1, $2, $3, 1.1, 2.2, 3.3);
  СтрокаОтчета( 4, Глава, "Д",      "", $0, $0, $0, 0.0, 0.0, 0.0);
  СтрокаОтчета( 4, Глава, "",  "56788", $1, $2, $3, 1.1, 2.2, 3.3);
  СтрокаОтчета( 4, Глава, "",  "87654", $1, $2, $3, 1.1, 2.2, 3.3);
  СтрокаОтчета( 4, Глава, "К",      "", $0, $0, $0, 0.0, 0.0, 0.0);
  СтрокаОтчета( 4, Глава, "",  "56788", $1, $2, $3, 1.1, 2.2, 3.3);

  ШапкаРасхожденияСтроки( Глава);
  РасхождениеСтр( Глава, "12345", 3, 2, 5);
  РасхождениеСтр( Глава, "89754", 1, 2, 3);
  ЗаключениеРасхожденияСтроки();
END;

ЗаголовокОтчетаОкругления( "Сальдовая ведомость");

ПечатьВТысячах( 2);
ПечатьВТысячах( 5);
*/

/*eof*/