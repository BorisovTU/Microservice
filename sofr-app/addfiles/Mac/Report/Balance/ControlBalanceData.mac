/**
 *  RS-Bank 6.0                                           R-Style Software Lab
 *
 *  File Name   : ControlBalanceData.mac                     February 14, 2008
 *  Programmer  : ABP
 *  Description : Источники данных для контроля валютного баланса
 *  Comment     :
 *  Modify      :
 */

import cb_sql;

import FIInter;

/**
 * Класс фабрики источников данных для процедуры контроля баланса
 *
 * @since   v.6.00.020.28
 * @author  ABP
 */
class TControlBalanceData()
    /**
     * Получение источника данных для контроля "красного сальдо"
     */
    macro getOverdraftAccountsDataSource() : Object

        var queryText;

        queryText =          "SELECT overdraft.t_chapter      t_chapterNumber,"
                    + "\n" + "       fininstr.t_iso_number    t_isoNumber,"
                    + "\n" + "       overdraft.t_account      t_accountNumber,"
                    + "\n" + "       overdraft.t_kind_account t_accountKind,"
                    + "\n" + "       overdraft.t_inRest       t_inRest,"
                    + "\n" + "       overdraft.t_outRest      t_outRest,"
                    + "\n" + "       overdraft.t_inRest_R     t_inRest_R,"
                    + "\n" + "       overdraft.t_outRest_R    t_outRest_R"
                    + "\n" + " FROM dblovrd_tmp overdraft,"
                    + "\n" + "      dfininstr_dbt fininstr"
                    + "\n" + "WHERE fininstr.t_fiId = overdraft.t_code_currency"
                    + "\n" + "  AND fininstr.t_fi_kind IN (" + FIKIND_CURRENCY + ", " + FIKIND_METAL + ")"
                    + "\n" + "ORDER BY t_chapterNumber, t_isoNumber, t_accountNumber";

        return TRsbDataset(queryText);

    end;

    /**
     * Получение источника данных для контоля сходимости
     */
    macro getConvergenceDataSource() : Object

        var queryText;

        var inRestDifferenceNote = "Расхождение во входящих остатках";

        var outRestDifferenceNote = "Расхождение в исходящих остатках";

        var turnDifferenceNote = "Расхождение в оборотах";

        queryText =          "WITH"
                    + "\n" + "balanceTotals AS"
                    + "\n" + "("
                    + "\n" + "    SELECT SUM(t_dmInActive)   AS t_totalInActive,"
                    + "\n" + "           SUM(t_dmInPassive)  AS t_totalInPassive,"
                    + "\n" + "           SUM(t_dmDebet)      AS t_totalDebet,"
                    + "\n" + "           SUM(t_dmCredit)     AS t_totalCredit,"
                    + "\n" + "           SUM(t_dmOutActive)  AS t_totalOutActive,"
                    + "\n" + "           SUM(t_dmOutPassive) AS t_totalOutPassive,"
                    + "\n" + "           t_iChapter          AS t_chapterNumber,"
                    + "\n" + "           t_iCurrency         AS t_fiId"
                    + "\n" + "      FROM dblrept_tmp"
                    + "\n" + "     GROUP BY t_iChapter, t_iCurrency"
                    + "\n" + "),"
                    + "\n" + "balanceDifferences AS"
                    + "\n" + "("
                    + "\n" + "    SELECT t_totalInActive                         AS t_firstValue,"
                    + "\n" + "           t_totalInPassive                        AS t_secondValue,"
                    + "\n" + "           ABS(t_totalInActive - t_totalInPassive) AS t_difference,"
                    + "\n" + "           t_chapterNumber                         AS t_chapterNumber,"
                    + "\n" + "           t_fiId                                  AS t_fiId,"
                    + "\n" + "       " + getSqlString(inRestDifferenceNote) + "  AS t_note"
                    + "\n" + "      FROM balanceTotals"
                    + "\n" + "     WHERE t_totalInActive != t_totalInPassive"
                    + "\n" + "     UNION ALL"
                    + "\n" + "    SELECT t_totalOutActive                           AS t_firstValue,"
                    + "\n" + "           t_totalOutPassive                          AS t_secondValue,"
                    + "\n" + "           ABS(t_totalOutActive - t_totalOutPassive)  AS t_difference,"
                    + "\n" + "           t_chapterNumber                            AS t_chapterNumber,"
                    + "\n" + "           t_fiId                                     AS t_fiId,"
                    + "\n" + "       " + getSqlString(outRestDifferenceNote) + "    AS t_note"
                    + "\n" + "      FROM balanceTotals"
                    + "\n" + "     WHERE t_totalDebet != t_totalCredit"
                    + "\n" + "     UNION ALL"
                    + "\n" + "    SELECT t_totalDebet                         AS t_firstValue,"
                    + "\n" + "           t_totalCredit                        AS t_secondValue,"
                    + "\n" + "           ABS(t_totalDebet - t_totalCredit)    AS t_difference,"
                    + "\n" + "           t_chapterNumber                      AS t_chapterNumber,"
                    + "\n" + "           t_fiId                               AS t_fiId,"
                    + "\n" + "       " + getSqlString(turnDifferenceNote) + " AS t_note"
                    + "\n" + "      FROM balanceTotals"
                    + "\n" + "     WHERE t_totalOutActive != t_totalOutPassive"
                    + "\n" + ")"
                    + "\n" + "SELECT balanceDifferences.t_chapterNumber  AS t_chapterNumber,"
                    + "\n" + "       fininstr.t_iso_number               AS t_isoNumber,"
                    + "\n" + "       balanceDifferences.t_firstValue     AS t_firstValue,"
                    + "\n" + "       balanceDifferences.t_secondValue    AS t_secondValue,"
                    + "\n" + "       balanceDifferences.t_difference     AS t_difference,"
                    + "\n" + "       balanceDifferences.t_note           AS t_note"
                    + "\n" + " FROM balanceDifferences balanceDifferences,"
                    + "\n" + "      dfininstr_dbt fininstr"
                    + "\n" + "WHERE fininstr.t_fiId = balanceDifferences.t_fiId"
                    + "\n" + "  AND fininstr.t_fi_kind IN (" + FIKIND_CURRENCY + ", " + FIKIND_METAL + ")"
                    + "\n" + "ORDER BY t_chapterNumber, t_isoNumber";

        return TRsbDataset(queryText);

    end;

    /**
     * Получение источника данных для контоля сходимости ОСВ
     */
    macro getTbsConvergenceDataSource(isCurrency : Integer) : Object

        var queryText;

        var inRestDifferenceNote = "Расхождение во входящих остатках";

        var outRestDifferenceNote = "Расхождение в исходящих остатках";

        var turnDifferenceNote = "Расхождение в оборотах";

        var eqMarker;
        var fiField;

        if (isCurrency == 0)
            eqMarker = "_r";
            fiField = "0";
        else
            eqMarker = "";
            fiField = "t_code_currency";
        end;

        queryText =          "WITH"
                    + "\n" + "balanceTotals AS"
                    + "\n" + "("
                    + "\n" + "    SELECT SUM(t_ias)         AS t_totalInActive,"
                    + "\n" + "           SUM(t_ips)         AS t_totalInPassive,"
                    + "\n" + "           SUM(t__ds)         AS t_totalDebet,"
                    + "\n" + "           SUM(t__ks)         AS t_totalCredit,"
                    + "\n" + "           SUM(t_oas)         AS t_totalOutActive,"
                    + "\n" + "           SUM(t_ops)         AS t_totalOutPassive,"
                    + "\n" + "           t_chapterNumber    AS t_chapterNumber,"
                    + "\n" + "           t_fiId             AS t_fiId"
                    + "\n" + "      FROM ("
                    + "\n" + "            SELECT t_ias" + eqMarker + "  AS t_ias,"
                    + "\n" + "                   t_ips" + eqMarker + "  AS t_ips,"
                    + "\n" + "                   t__ds" + eqMarker + "  AS t__ds,"
                    + "\n" + "                   t__ks" + eqMarker + "  AS t__ks,"
                    + "\n" + "                   t_oas" + eqMarker + "  AS t_oas,"
                    + "\n" + "                   t_ops" + eqMarker + "  AS t_ops,"
                    + "\n" + "                   t_chapter              AS t_chapterNumber,"
                    + "\n" + "               " + fiField + "            AS t_fiId"
                    + "\n" + "              FROM dblaccr_tmp"
                    + "\n" + "           ) accounts"
                    + "\n" + "     GROUP BY t_chapterNumber, t_fiId"
                    + "\n" + "),"
                    + "\n" + "balanceDifferences AS"
                    + "\n" + "("
                    + "\n" + "    SELECT t_totalInActive                         AS t_firstValue,"
                    + "\n" + "           t_totalInPassive                        AS t_secondValue,"
                    + "\n" + "           ABS(t_totalInActive - t_totalInPassive) AS t_difference,"
                    + "\n" + "           t_chapterNumber                         AS t_chapterNumber,"
                    + "\n" + "           t_fiId                                  AS t_fiId,"
                    + "\n" + "       " + getSqlString(inRestDifferenceNote) + "  AS t_note"
                    + "\n" + "      FROM balanceTotals"
                    + "\n" + "     WHERE t_totalInActive != t_totalInPassive"
                    + "\n" + "     UNION ALL"
                    + "\n" + "    SELECT t_totalOutActive                           AS t_firstValue,"
                    + "\n" + "           t_totalOutPassive                          AS t_secondValue,"
                    + "\n" + "           ABS(t_totalOutActive - t_totalOutPassive)  AS t_difference,"
                    + "\n" + "           t_chapterNumber                            AS t_chapterNumber,"
                    + "\n" + "           t_fiId                                     AS t_fiId,"
                    + "\n" + "       " + getSqlString(outRestDifferenceNote) + "    AS t_note"
                    + "\n" + "      FROM balanceTotals"
                    + "\n" + "     WHERE t_totalDebet != t_totalCredit"
                    + "\n" + "     UNION ALL"
                    + "\n" + "    SELECT t_totalDebet                         AS t_firstValue,"
                    + "\n" + "           t_totalCredit                        AS t_secondValue,"
                    + "\n" + "           ABS(t_totalDebet - t_totalCredit)    AS t_difference,"
                    + "\n" + "           t_chapterNumber                      AS t_chapterNumber,"
                    + "\n" + "           t_fiId                               AS t_fiId,"
                    + "\n" + "       " + getSqlString(turnDifferenceNote) + " AS t_note"
                    + "\n" + "      FROM balanceTotals"
                    + "\n" + "     WHERE t_totalOutActive != t_totalOutPassive"
                    + "\n" + ")"
                    + "\n" + "SELECT balanceDifferences.t_chapterNumber  AS t_chapterNumber,"
                    + "\n" + "       fininstr.t_iso_number               AS t_isoNumber,"
                    + "\n" + "       balanceDifferences.t_firstValue     AS t_firstValue,"
                    + "\n" + "       balanceDifferences.t_secondValue    AS t_secondValue,"
                    + "\n" + "       balanceDifferences.t_difference     AS t_difference,"
                    + "\n" + "       balanceDifferences.t_note           AS t_note"
                    + "\n" + " FROM balanceDifferences balanceDifferences,"
                    + "\n" + "      dfininstr_dbt fininstr"
                    + "\n" + "WHERE fininstr.t_fiId = balanceDifferences.t_fiId"
                    + "\n" + "  AND fininstr.t_fi_kind IN (" + FIKIND_CURRENCY + ", " + FIKIND_METAL + ")"
                    + "\n" + "ORDER BY t_chapterNumber, t_isoNumber";

        return TRsbDataset(queryText);

    end;

    /**
     * Конструктор
     */
    macro constructor()
        // do nothing
    end;

    constructor();
end;
