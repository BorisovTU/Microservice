/*
$Name:         BalanceData.mac
$Module:       Внутренняя отчетность
$Description:  Данныe по балансу
*/
/**
 * Module:  TBalanceData.mac
 * Author:  Ivkina
 * Modified: 11 февраля 2008 г. 10:18:46
 * Purpose: Declaration of the class TBalanceData
 * Comment: Данныe по балансу.
 */
import RsbDataSet;
import rep_lib;
import cb_sql;

/**
 * Данныe по балансу.
 */
class TBalanceData()
    /**
     * Получить агрегированные данные отчета.
     */
    macro getReportDataSet(filter) : Object
        var qweryText         = "";
        var titleCurrencyText = "";
        var titleChapterText  = "";
        var selectText        = "";
        var fromText          = "";
        var whereText         = "";
        var groupText         = "";
        var orderText         = "";
        var p                 = "";

        var th = ""; 

        if (balanceParameters.getMoneyDimension == REP_BALANCE_DIMENSION_THOUSAND)
            p  = "l";
            th = "th";
        else
            p  = "d";
        end;                       

        titleCurrencyText =                                                                          
                            "CASE                                                                   " 
              + "\n" +      "   WHEN ("+ternary((balanceParameters.getIsPrintIssueItog() == true),"GROUPING (blblnc.t_part) = 1 AND ", "")  
              + "\n" +      "          GROUPING (t_icurrency) = 0                                        "
              + "\n" +      "        )                                                                   " 
              + "\n" +      "      THEN (NVL((SELECT                                                     "
              + "\n" +      "                       t_fi_code                                            " 
              + "\n" +      "                        || ' '                                              " 
              + "\n" +      "                        || t_name                                           " 
              + "\n" +      "                        || ' курс от '                                      " 
              + "\n" +      "                        || ' '                                              " 
              + "\n" +      "                        || t_inputdate                                      " 
              + "\n" +      "                        || ' '                                              " 
              + "\n" +      "                        || to_char(t_rate/10000, '999999D9999')             " 
              + "\n" +      "                 FROM rate                                                  " 
              + "\n" +      "                 WHERE t_fiid = blrept.t_icurrency),                        " 
              + "\n" +      "                 (SELECT t_fi_code || ' ' || t_name || ' Курс не определен' " 
              + "\n" +      "                 FROM dfinInstr_dbt WHERE t_fiId = blrept.t_icurrency)) )   " 
              + "\n" +      "   ELSE ' '                                                                 " 
              + "\n" +      "END                                                                         ";


        titleChapterText =  "(SELECT   'Глава '                            "
              + "\n" +      "        || chapt.t_symbol                     "
              + "\n" +      "        || '. '                               "
              + "\n" +      "        || chapt.t_name                       "
              + "\n" +      "        || '\nПлан счетов '                   "
              + "\n" +      "        || plan.t_iNumPlan                    "
              + "\n" +      "        || '. '                               "
              + "\n" +      "        || plan.t_namePlan                    "
              + "\n" +      "   FROM dobchaptr_dbt chapt,                  "
              + "\n" +      "        dnameplan_chaptr_dbt planchap,        "
              + "\n" +      "        dnameplan_dbt plan                    "
              + "\n" +      "  WHERE plan.t_iNumPlan = blrept.t_iNumPlan   "
              + "\n" +      "    AND chapt.t_chapter = blrept.t_iChapter   "
              + "\n" +      "    AND planchap.t_iNumPlan = plan.t_iNumPlan "
              + "\n" +      "    AND planchap.t_chapter = chapt.t_chapter  "
              + "\n" +      "    AND chapt.t_excludeFromFormalacnt != 'X'      "
              + "\n" +      ")                                             ";
    
        selectText =        "WITH rateHist AS (SELECT MAX (t_sinceDate) OVER (PARTITION BY t_rateId) t_maxDate,  "
              + "\n" +      "                         t_rateId, t_rate, t_sinceDate                              "
              + "\n" +      "                    FROM (SELECT t_rateId, t_rate,                                  "
              + "\n" +      "                                 to_date(to_char(t_sinceDate,'DD.MM.YYYY') || ' ' || to_char(t_inputTime,'HH24:MI:SS'),'DD.MM.YYYY HH24:MI:SS') t_sinceDate  "
              + "\n" +      "                               FROM dratehist_dbt rateHist                          "
              + "\n" +      "                            UNION ALL (                                             " 
              + "\n" +      "                          SELECT t_rateId, t_rate, to_date(to_char(t_sinceDate,'DD.MM.YYYY') || ' 23:59:59','DD.MM.YYYY HH24:MI:SS') t_sinceDate             "
              + "\n" +      "                               FROM drateDef_dbt))                                  "  
              + "\n" +      "                     WHERE t_sinceDate <= to_date(to_char(" + getSqlDate(balanceParameters.getDateOut()) + ",'DD.MM.YYYY') || '23:59:59','DD.MM.YYYY HH24:MI:SS')),"
              + "\n" +      "     ratesId  AS (SELECT t_rate,                                                    "
              + "\n" +      "                         t_maxDate AS t_inputDate,                                  "
              + "\n" +      "                         (SELECT t_otherFi                                          "
              + "\n" +      "                            FROM drateDef_dbt                                       "
              + "\n" +      "                           WHERE t_rateId = rateHist.t_rateId                       "
              + "\n" +      "                             AND t_isDominant = 'X'                                 "
              + "\n" +      "                             AND t_fiid = " + NATCUR + ")t_fiId                     "
              + "\n" +      "                    FROM rateHist                                                   "
              + "\n" +      "                   WHERE t_sinceDate = t_maxDate),                                  "
              + "\n" +      "     rate     AS (SELECT finInstr.t_fi_code, finInstr.t_name, finInstr.t_fiId,      "
              + "\n" +      "                         ratesId.t_rate, to_char(ratesId.t_inputDate,'DD.MM.YYYY') t_inputDate "
              + "\n" +      "                    FROM dfinInstr_dbt finInstr,                                    "
              + "\n" +      "                         ratesId                                                    "
              + "\n" +      "                    WHERE ratesId.t_fiId = finInstr.t_fiId)                         "
              + "\n" +      "SELECT                                                         "
                            "       GROUPING (blrept.t_ichapter)       isBalance,           "
              + "\n" +      "       GROUPING (t_icurrency)             isChapterItog,       "
              + "\n" +      titleChapterText +" titlechapter,"

              + "\n" +      ternary(balanceParameters.getIsPrintIssueItog() == true,
                            "       GROUPING (blblnc.t_part)            isCurrencyItog,     "
              + "\n" +      "       GROUPING (blrept.t_balance)         isPartItog,         "
              + "\n" +      "       blblnc.t_part                       part,               "
              + "\n" +      "       initcap(partblnc.t_name_part)       partName,           ",
                            "       GROUPING (blrept.t_balance)         isCurrencyItog,     "
              + "\n" +      "       0                                   isPartItog,         ")
                                                                        
              + "\n" +      "       --                                                      "
              + "\n" +      "       blrept.t_icurrency                  currency,           "
              + "\n" +      "       blrept.t_balance                    balance,            "
              + "\n" +      "       NVL(bal.t_name_part,chr(0))         balanceName,        "
              + "\n" +              titleCurrencyText + "               titleCurrency,      "
              + "\n" +      "       --                                                      "
              + "\n" +      "       SUM (blrept.t_"+p+"minactive"+th+")     inActiveRest,   "
              + "\n" +      "       SUM (blrept.t_"+p+"minactive"+th+"r)    inActiveRestR,  "
              + "\n" +      "       SUM (blrept.t_"+p+"minpassive"+th+")    inPassiveRest,  "
              + "\n" +      "       SUM (blrept.t_"+p+"minpassive"+th+"r)   inPassiveRestR, "
              + "\n" +      "       --                                                "
              + "\n" +      "       SUM (blrept.t_"+p+"mdebet"+th+")        debet,          "
              + "\n" +      "       SUM (blrept.t_"+p+"mdebet"+th+"r)       debetR,         "
              + "\n" +      "       SUM (blrept.t_"+p+"mcredit"+th+")       credit,         "
              + "\n" +      "       SUM (blrept.t_"+p+"mcredit"+th+"r)      creditR,        "
              + "\n" +      "       --                                                "
              + "\n" +      "       SUM (blrept.t_"+p+"moutactive"+th+")    outActiveRest,  "
              + "\n" +      "       SUM (blrept.t_"+p+"moutactive"+th+"r)   outActiveRestR, "
              + "\n" +      "       SUM (blrept.t_"+p+"moutpassive"+th+")   outPassiveRest, "
              + "\n" +      "       SUM (blrept.t_"+p+"moutpassive"+th+"r)  outPassiveRestR,"
              + "\n" +      "       --                                                "
              + "\n" +      "       SUM (blrept.t_"+p+"mfinaldebet"+th+")   debetSpod,      "
              + "\n" +      "       SUM (blrept.t_"+p+"mfinaldebet"+th+"r)  debetSpodR,     "
              + "\n" +      "       SUM (blrept.t_"+p+"mfinalcredit"+th+")  creditSpod,     "
              + "\n" +      "       SUM (blrept.t_"+p+"mfinalcredit"+th+"r) creditSpodR     ";
                                                                        
        fromText =                                                                         
                            "FROM dblrept_tmp blrept,                                       " 
              + "\n" +      "     dblblnc_tmp blblnc,                                       " 
                     +      ternary(balanceParameters.getIsPrintIssueItog() == true,
                            "     dpartblnc_dbt partblnc,                                   ","") 
              + "\n" +      "     dbalance_dbt bal                                          ";

        whereText =                                                                          
                            "WHERE blblnc.t_balance = blrept.t_balance                      " 
              + "\n" +      "  AND blblnc.t_chapter = blrept.t_ichapter                     " 
                     +      ternary(balanceParameters.getIsPrintIssueItog() == true,
                            "  AND partblnc.t_chapter = blrept.t_ichapter                   " 
              + "\n" +      "  AND partblnc.t_inumplan = blrept.t_inumplan                  "
              + "\n" +      "  AND partblnc.t_part = blblnc.t_part                          ", "") 

              + "\n" +      "  AND bal.t_chapter = blrept.t_ichapter                        " 
              + "\n" +      "  AND bal.t_balance = blrept.t_balance                         "
              + "\n" +      "  AND bal.t_inumplan = blrept.t_inumplan                       "
              + "\n" +      NVL(filter, ""); 

        groupText =
                            "GROUP BY ROLLUP (                                              "
                                     " (blrept.t_ichapter,blrept.t_inumplan),"

              + "\n" +      "t_icurrency,                                                   "
                     +       ternary(balanceParameters.getIsPrintIssueItog() == true,
                                    "(blblnc.t_part,partblnc.t_name_part),", "") 

              + "\n" +      "(blrept.t_balance,bal.t_name_part))     ";

        orderText =                                                                         
                            "ORDER BY isbalance DESC,                                       "
                            "         blrept.t_ichapter,                                    "
              + "\n" +      "         ischapteritog DESC,                                   "
              

                   
              + "\n" +      "         t_icurrency,                                          "
              + "\n" +      "         isCurrencyItog DESC,                                  "

                     +      ternary(balanceParameters.getIsPrintIssueItog() == true,
                            "         blblnc.t_part,                                        "
              + "\n" +      "         isPartItog DESC,                                      ", "")

              + "\n" +      "         blrept.t_balance                                      ";

        qweryText = selectText + fromText + whereText + groupText + orderText;

        var dataSet = TRsbDataSet(qweryText);
        dataSet.SetFieldType("inActiveRest",   V_MONEY);
        dataSet.SetFieldType("inActiveRestR",  V_MONEY);
        dataSet.SetFieldType("inPassiveRest",  V_MONEY);
        dataSet.SetFieldType("inPassiveRestR", V_MONEY);
        dataSet.SetFieldType("debet",          V_MONEY);
        dataSet.SetFieldType("debetR",         V_MONEY);
        dataSet.SetFieldType("credit",         V_MONEY);
        dataSet.SetFieldType("creditR",        V_MONEY);
        dataSet.SetFieldType("outActiveRest",  V_MONEY);
        dataSet.SetFieldType("outActiveRestR", V_MONEY);
        dataSet.SetFieldType("outPassiveRest", V_MONEY);
        dataSet.SetFieldType("outPassiveRestR",V_MONEY);
        dataSet.SetFieldType("debetSpod",      V_MONEY);
        dataSet.SetFieldType("debetSpodR",     V_MONEY);
        dataSet.SetFieldType("creditSpod",     V_MONEY);
        dataSet.SetFieldType("creditSpodR",    V_MONEY);

        return dataSet;
    end;
    
    /**
     * Конструктор.
     */
    private macro constructor()
    end;

    constructor();
end;
