/*
$Name:          NatBalanceData.mac
$Module:        Внутренняя отчетность
$Description:   Источник данных отчета
*/

/**
 * RS-Bank 6.0                                            R-Style Software Lab
 *
 * File Name   : NatBalanceData.mac
 * Description : Источник данных отчета
 * Comment     :
 * @since      : 28.05.2010
 * @author     : Shestakov Dmitry
 * @version    : 6.00.020.30
 */

import RsbDataSet;
import rep_lib;
import cb_sql;
import rcbconst;
import NatBalanceParameters;

/**
 * Данныe по балансу.
 */
class TNatBalanceData()
    /**
     * Получить данные о главах, вошедших в расчет.
     */
    macro getChaptersSet()
        var qweryText =
                     "SELECT DISTINCT t_ichapter ch"
            + "\n" + "  FROM dblrept_tmp blrept"
            + "\n" + " ORDER BY t_ichapter";

        var dataSet = TRsbDataSet(qweryText);
        return dataSet;
    end;
    /**
     * Получить агрегированные данные отчета.
     */
    macro getReportDataSet(filter) : Object
        var qweryText         = "";
//      var titleCurrencyText = "";
        var titleChapterText  = "";
        var selectText        = "";
        var fromText          = "";
        var whereText         = "";
        var groupText         = "";
        var orderText         = "";

        var p                 = "";
        var th                = "";

        if (natBalanceParameters().getMoneyDimension() == RCB_CALCULATE_BALANCE_BU_THOUSEND_SM)
            p  = "l";
            th = "th";
        else
            p  = "d";
        end;

//      titleCurrencyText =
//                          "CASE                                                                   "
//            + "\n" +      "   WHEN ("+ternary((natBalanceParameters().getIsPrintIssueItog() == true),"GROUPING (blblnc.t_part) = 1 AND ", "")
//            + "\n" +      "          GROUPING (t_icurrency) = 0                                        "
//            + "\n" +      "        )                                                                   "
//            + "\n" +      "      THEN (NVL((SELECT                                                     "
//            + "\n" +      "                       t_fi_code                                            "
//            + "\n" +      "                        || ' '                                              "
//            + "\n" +      "                        || t_name                                           "
//            + "\n" +      "                        || ' курс от '                                      "
//            + "\n" +      "                        || ' '                                              "
//            + "\n" +      "                        || t_inputdate                                      "
//            + "\n" +      "                        || ' '                                              "
//            + "\n" +      "                        || to_char(t_rate/10000, '999999D9999')             "
//            + "\n" +      "                 FROM rate                                                  "
//            + "\n" +      "                 WHERE t_fiid = blrept.t_icurrency),                        "
//            + "\n" +      "                 (SELECT t_fi_code || ' ' || t_name || ' Курс не определен' "
//            + "\n" +      "                 FROM dfinInstr_dbt WHERE t_fiId = blrept.t_icurrency)) )   "
//            + "\n" +      "   ELSE ' '                                                                 "
//            + "\n" +      "END                                                                         ";

        titleChapterText =
                     "       CASE WHEN (GROUPING (" + ternary(natBalanceParameters().getIsPrintIssueItog() == true,
                                                  "blblnc.t_part",
                                                  "blrept.t_balance") + ") = 1)    "
            + "\n" + "           THEN (SELECT   'План счетов '                     "
            + "\n" + "                       || plan.t_iNumPlan                    "
            + "\n" + "                       || '. '                               "
            + "\n" + "                       || plan.t_namePlan                    "
            + "\n" + "                       || '\nГлава '                         "
            + "\n" + "                       || chapt.t_symbol                     "
            + "\n" + "                       || '. '                               "
            + "\n" + "                       || chapt.t_name                       "
            + "\n" + "                  FROM dobchaptr_dbt chapt,                  "
            + "\n" + "                       dnameplan_chaptr_dbt planchap,        "
            + "\n" + "                       dnameplan_dbt plan                    "
            + "\n" + "                 WHERE plan.t_iNumPlan = blrept.t_iNumPlan   "
            + "\n" + "                   AND chapt.t_chapter = blrept.t_iChapter   "
            + "\n" + "                   AND planchap.t_iNumPlan = plan.t_iNumPlan "
            + "\n" + "                   AND planchap.t_chapter = chapt.t_chapter  "
            + "\n" + "                   AND chapt.t_excludeFromFormalacnt != 'X'  "
            + "\n" + "                )                                            "
            + "\n" + "           ELSE ' '                                          "
            + "\n" + "       END                                                   ";

//      withText =   "WITH typedBalances AS (                                        "
//               +   ternary(natBalanceParameters().getAccountTypeDefinitionMethod() == DAT_TYPE,
//            "\n" + "         SELECT blrept.*, blblnc.t_part,                       "
//          + "\n" + "                CASE WHEN blblnc.t_kind_account = 'П'          "
//          + "\n" + "                     THEN 0                                    "
//          + "\n" + "                     ELSE 1                                    "
//          + "\n" + "                END isDefinedAsActive                          "
//          + "\n" + "           FROM dblrept_tmp blrept,                            "
//          + "\n" + "                dblblnc_tmp blblnc                             ",
//
//            "\n" + "         SELECT blrept.*, blblnc.t_part,                       "
//          + "\n" + "                CASE WHEN blblnc.t_kind_account = 'П'          "
//          + "\n" + "                     THEN 0                                    "
//          + "\n" + "                     ELSE 1                                    "
//          + "\n" + "                END isDefinedAsActive                          "
//          + "\n" + "           FROM dblrept_tmp blrept,                            "
//          + "\n" + "                dblblnc_tmp blblnc                             ")
//          + "\n" + "     )                                                         ";

//            + "\n" + "       "

        selectText = "SELECT GROUPING (blrept.t_ichapter)        isTotalItog,        "
            + "\n" +         titleChapterText +" titlechapter,"

                 +   ternary(natBalanceParameters().getIsPrintIssueItog() == true,
              "\n" + "       GROUPING (blblnc.t_part)            isChapterItog,      ",
              "\n" + "       GROUPING (blrept.t_balance)         isChapterItog,      ")

            + "\n" + "       GROUPING (blrept.t_balance)         isPartItog,         "
//            + "\n" + "       GROUPING (blrept.t_balance)         isBalance,          "

                   + ternary(natBalanceParameters().getIsPrintIssueItog() == true,
              "\n" + "       DECODE(NVL(blblnc.t_part, 0),                           "
            + "\n" + "           0, 999999,                                          "
            + "\n" + "           blblnc.t_part)                  part,               "
            + "\n" + "       DECODE(NVL(blblnc.t_part, 0),                           "
            + "\n" + "           0, '',                                              "
            + "\n" + "           INITCAP(partblnc.t_name_part))  partName,           ",

              "\n" + "       ''                                  part,               "
            + "\n" + "       ''                                  partName,           ")

            + "\n" + "       --                                                      "
            + "\n" + "       blrept.t_ichapter                   chapter,            "
            + "\n" + "       blrept.t_balance                    balance,            "
            + "\n" + "       NVL(bal.t_name_part,chr(0))         balanceName,        "
            + "\n" + "       --                                                      "
            + "\n" + "       SUM (DECODE(blrept.t_ichapter, 5, blrept.t_dminactiver, blrept.t_"+p+"minactive"+th+"r))    inActiveRest,   "
            + "\n" + "       SUM (DECODE(blrept.t_ichapter, 5, blrept.t_dminpassiver, blrept.t_"+p+"minpassive"+th+"r))   inPassiveRest,  "
            + "\n" + "       --                                                "
            + "\n" + "       SUM (DECODE(blrept.t_ichapter, 5, blrept.t_dmdebetr, blrept.t_"+p+"mdebet"+th+"r))       debet,          "
            + "\n" + "       SUM (DECODE(blrept.t_ichapter, 5, blrept.t_dmcreditr, blrept.t_"+p+"mcredit"+th+"r))      credit,         "
            + "\n" + "       --                                                      "
            + "\n" + "       SUM (DECODE(blrept.t_ichapter, 5, blrept.t_dmoutactiver, blrept.t_"+p+"moutactive"+th+"r))   outActiveRest,  "
            + "\n" + "       SUM (DECODE(blrept.t_ichapter, 5, blrept.t_dmoutpassiver, blrept.t_"+p+"moutpassive"+th+"r))  outPassiveRest, "
            + "\n" + "       --                                                "
            + "\n" + "       SUM (DECODE(blrept.t_ichapter, 5, blrept.t_dmfinaldebet, blrept.t_"+p+"mfinaldebet"+th+"r))  debetSpod,      "
            + "\n" + "       SUM (DECODE(blrept.t_ichapter, 5, blrept.t_dmfinalcredit, blrept.t_"+p+"mfinalcredit"+th+"r)) creditSpod      ";

        fromText =
              "\n" + "  FROM dblrept_tmp blrept                                      "
            + "\n" + "       INNER JOIN dblblnc_tmp blblnc ON (                      "
            + "\n" + "               blblnc.t_balance = blrept.t_balance             "
            + "\n" + "           AND blblnc.t_chapter = blrept.t_ichapter            "
            + "\n" + "                                       )                       "
            + "\n" + "       INNER JOIN dbalance_dbt bal ON (                        "
            + "\n" + "               bal.t_chapter  = blrept.t_ichapter              "
            + "\n" + "           AND bal.t_balance  = blrept.t_balance               "
            + "\n" + "           AND bal.t_inumplan = blrept.t_inumplan              "
            + "\n" + "                                      )                        "
                   + ternary(natBalanceParameters().getIsPrintIssueItog() == true,
              "\n" + "       LEFT OUTER JOIN dpartblnc_dbt partblnc ON (             "
            + "\n" + "               partblnc.t_chapter  = blrept.t_ichapter         "
            + "\n" + "           AND partblnc.t_inumplan = blrept.t_inumplan         "
            + "\n" + "           AND partblnc.t_part     = blblnc.t_part             "
            + "\n" + "                                                 )             ", "");

        whereText =  ternary(valType(filter) == V_STRING, "\n" + " WHERE " + filter, "");

        groupText =
              "\n" + " GROUP BY ROLLUP ( (blrept.t_ichapter, blrept.t_inumplan),     "

                   + ternary(natBalanceParameters().getIsPrintIssueItog() == true,
              "\n" + "                   (blblnc.t_part, partblnc.t_name_part),      ", "")

            + "\n" + "                   (blrept.t_balance, bal.t_name_part))        ";

        orderText =
              "\n" + " ORDER BY isTotalItog DESC,                                    "
            + "\n" + "          blrept.t_ichapter,                                   "
            + "\n" + "          isChapterItog DESC,                                  "

                   + ternary(natBalanceParameters().getIsPrintIssueItog() == true,
              "\n" + "          part,                                                "
            + "\n" + "          isPartItog DESC,                                     ", "")

            + "\n" + "          blrept.t_balance                                     ";

        qweryText = selectText + fromText + whereText + groupText + orderText;

        var dataSet = TRsbDataSet(qweryText);
        dataSet.SetFieldType("inActiveRest",   V_MONEY);
        dataSet.SetFieldType("inPassiveRest",  V_MONEY);
        dataSet.SetFieldType("debet",          V_MONEY);
        dataSet.SetFieldType("credit",         V_MONEY);
        dataSet.SetFieldType("outActiveRest",  V_MONEY);
        dataSet.SetFieldType("outPassiveRest", V_MONEY);
        dataSet.SetFieldType("debetSpod",      V_MONEY);
        dataSet.SetFieldType("creditSpod",     V_MONEY);
        if (natBalanceParameters().getIsPrintIssueItog() == true)
            dataSet.SetFieldType("part",   V_INTEGER);
        end;

        return dataSet;
    end;

    /**
     * Конструктор.
     */
    private macro constructor()
    end;

    constructor();
end;
