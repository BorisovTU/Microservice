/*
$Name:              ControlBalanceController.mac
$Module:            Внутренняя отчетность
$Description:       Контроль баланса банка
*/

/**
 *  RS-Bank 6.0                                           R-Style Software Lab
 *
 *  File Name   : ControlBalanceController.mac               February 18, 2008
 *  Programmer  : ABP
 *  Description : Контроль баланса банка
 *  Comment     :
 *  Modify      :
 */

import globals;
import BalanceParameters;
import Ofstream;
import ControlBalanceData;
import ControlConvergence;
import ControlOverdraftAccounts;

/**
 * Контроллер контроля баланса
 */
class TControlBalanceController(ofstream : TOfstream)

    private var m_ofstream : TOfstream;

    /**
     * Фабрика источников данных
     */
    private var m_controlBalanceData : TControlBalanceData;

    /**
     * Конструктор
     */
    private macro constructor(ofstream : TOfstream)

        m_controlBalanceData = TControlBalanceData();

        m_ofstream = ofstream;

    end;

    /**
     * Печать "шапки" протокола
     */
    private macro printHeader()

        println("БАЛАНС КРЕДИТНОЙ ОРГАНИЗАЦИИ");
        println("ПРОТОКОЛ КОНТРОЛЯ");
        println();
        println("   Период отчета с ", balanceParameters().getDateIn(), " по ", balanceParameters().getDateOut());
        println("   Дата и время выпуска отчета ", Date(), "  ", Time());
        println("   Исполнитель ", {oper}, " ", {Name_Oper});

    end;

    /**
     * Выполнение контроля
     */
    macro control()
        var DISABLE_OVERDRAFT = false;
        if ((GetRegistryValue("REPORT\\DISABLE OVERDRAFT 2", V_BOOL, DISABLE_OVERDRAFT) != null) and DISABLE_OVERDRAFT)
            return;
        end;

        m_ofstream.setOutputFile();

        printHeader();

        // Контроль на "красное сальдо"
        TControlOverdraftAccounts(m_controlBalanceData.getOverdraftAccountsDataSource()).execute();

        m_ofstream.resetOutputFile();

    end;

    constructor(ofstream);

end;
