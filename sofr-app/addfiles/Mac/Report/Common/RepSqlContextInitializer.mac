/*
$Name:         RepSqlContextInitializer.mac
$Module:       Отчетность
$Description:  Инициализация sql-контекста отчета
*/

import Reporting;
import cb_sql;
import rep_lib;
import RepParametersNames;

macro initializeSqlContext(parameters : Object) : Bool
    var organizationStructure : Integer = parameters.getValue(ORGANIZATION_STRUCTURE);
    var issueMode : Integer = parameters.getValue(ISSUE_MODE);
    var departmentId : Integer = getDepartmentId(parameters.getValue(DEPARTMENT_CODE), organizationStructure);
    var beginDate : Date = parameters.getValue(BEGIN_DATE);
    var endDate : Date = parameters.getValue(END_DATE);
    var balancePlanNumber : Integer = parameters.getValue(BALANCE_PLAN_NUMBER);

    var departmentList = RepDepartmentList(organizationStructure, issueMode, departmentId);

    sql_truncate("drepdepartment_tmp");

    sql_execute("CALL rep_data.setBalancePlanNumber(" + balancePlanNumber + ")");

    sql_execute("CALL rep_data.setBeginDate(" + getSqlDate(beginDate) + ")");
    sql_execute("CALL rep_data.setEndDate("   + getSqlDate(endDate)   + ")");

    sql_execute("CALL rep_data.setDepartmentCode(" + getSqlString(departmentList.getAsSqlSetFilial()) + ", "
                                                   + getSqlString(departmentList.getAsSqlSetVsp()) + ")");

    sql_execute("CALL rsvoxprm.setPrmVal('BeginDate', UTL_RAW.CAST_TO_RAW(TO_CHAR("+getSqlDate(beginDate)+", 'DD.MM.YYYY')))");
    sql_execute("CALL rsvoxprm.setPrmVal('EndDate',   UTL_RAW.CAST_TO_RAW(TO_CHAR("+getSqlDate(endDate)+", 'DD.MM.YYYY')))");

    return true;
end;
