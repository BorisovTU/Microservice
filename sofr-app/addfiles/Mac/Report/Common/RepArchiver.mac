/*
$Name:         RepArchiver.mac
$Module:       Отчетность
$Description:  Сжатие файлов
*/

import lib_str;
import Reporting;

private class TArchiverZip()
    private var m_executableName : String;
    private var m_options : String;

    private var m_archiveFullName : String;
    private var m_fileList : String;

    macro setArchiveName(name : String)
//        m_archiveFullName = "\"" + strsubst(toAnsi(name, true), "\"", "") + "\"";
        m_archiveFullName = "\"" + strsubst(name, "\"", "") + "\"";
    end;

    macro addFile(name : Variant)
        if (name == null)
            return;
        end;

        var list : Object;

        if (valType(name) == V_STRING)
            list = strCut(name, ";");
        else
            list = name;
        end;

        for (var i, list)
//            m_fileList = m_fileList + " " + "\"" + strsubst(toAnsi(i, true), "\"", "") + "\"";
            m_fileList = m_fileList + " " + "\"" + strsubst(i, "\"", "") + "\"";
        end;

        m_fileList = trim(m_fileList);
    end;

    macro archive()
        run(m_executableName, m_options + " " + m_archiveFullName + " " + m_fileList);
    end;

    private macro constructorTArchiverZip()
        m_executableName = "zip";
        m_options = "-q -o -j -FS";
        m_archiveFullName = "";
        m_fileList = "";
    end;

    constructorTArchiverZip();
end;

macro TArchiver(method : Integer) : Object
    if (method == REP_ARCHIVER_ZIP)
        return TArchiverZip();
    else
        return TArchiverZip();
    end;

    return null;
end;

macro archive(archiverId : Integer, archiveFullName : String, fileFullNameList : Variant) : bool
    var engine = TArchiver(archiverId);

    engine.setArchiveName(archiveFullName);
    engine.addFile(fileFullNameList);
    engine.archive();

    return true;
end;
