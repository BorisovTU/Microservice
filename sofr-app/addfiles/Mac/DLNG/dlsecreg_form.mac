/*
$Name:        dlsecreg_form.mac
$Module:      Ядро Securities
$Description: Отчет " Регистр внутреннего учета ценных бумаг" - форма ввода данных
*/
import "DlRepForm_h.mac", "dlmisc.mac";
  
// Номера полей в форме отчета
CONST
      PNFLD_INACCSECUR_REG_DEPARTMENT          = 0,    // A1 филиал
      PNFLD_INACCSECUR_REG_DEPARTMENT_NAME     = 1,    // A2 
      PNFLD_INACCSECUR_REG_BEGINDATE           = 2,    // D1 дата начала
      PNFLD_INACCSECUR_REG_FINISHDATE          = 3,    // D2 
      PNFLD_INACCSECUR_REG_SEPARATELY_DATE     = 4,   // L8 за каждую дату отдельно
      PNFLD_INACCSECUR_REG_MODULE_BO           = 5,    // L1 
      PNFLD_INACCSECUR_REG_MODULE_VA           = 6,    // L2
      PNFLD_INACCSECUR_REG_SECUR_ACCOUNTS_REP  = 7,    // L3 Счета учета ценных бумаг
      PNFLD_INACCSECUR_REG_SUBJECT             = 8,    // A3 Субьект
      PNFLD_INACCSECUR_REG_ISFORM_1            = 9,  
      PNFLD_INACCSECUR_REG_FORMSUB_1           = 10,  
      PNFLD_INACCSECUR_REG_ISVID_1             = 11,  
      PNFLD_INACCSECUR_REG_VIDSUB_1            = 12,  
      PNFLD_INACCSECUR_REG_NORESIDENT_1        = 13,  

      PNFLD_INACCSECUR_REG_ACCOUNTING_PLACE    = 14,    // A4 Место учета ценных бумаг
      PNFLD_INACCSECUR_REG_ISSUER_1            = 15,    // A5 Эмитент
      PNFLD_INACCSECUR_REG_SECUR_KIND_1        = 16,   // A6 Вид ц/б
      PNFLD_INACCSECUR_REG_SECUR_ISSUE         = 17,   // A7 Выпуск ц/б

      PNFLD_INACCSECUR_REG_CL_S_ACOOUNTS_REP   = 18,   // L5 Счета расчета с клиентами
      PNFLD_INACCSECUR_REG_CLIENT              = 19,   // A8 клиент

      PNFLD_INACCSECUR_REG_ISFORM_2            = 20,  
      PNFLD_INACCSECUR_REG_FORMSUB_2           = 21,  
      PNFLD_INACCSECUR_REG_ISVID_2             = 22,  
      PNFLD_INACCSECUR_REG_VIDSUB_2            = 23,  
      PNFLD_INACCSECUR_REG_NORESIDENT_2        = 24,  

      PNFLD_INACCSECUR_REG_CONTRACT            = 25,   // A9 договор
      PNFLD_INACCSECUR_REG_ISSUER_2            = 26,   // A10 Эмитент
      PNFLD_INACCSECUR_REG_SECUR_KIND_2        = 27,   // A11 Вид ц/б
      PNFLD_INACCSECUR_REG_SECUR_CODE          = 28,   // A12 Код ц/б
      
      PNFLD_INACCSECUR_REG_WITH_APOSTROFS      = 29,   // L6 с апострофами
      PNFLD_INACCSECUR_REG_TO_EXEL             = 30;   // L7 выгрузить в EXEL
      
///////////////////////////////////////////////////////////////////////////////////////////
// Класс данных отражающий поля формы
      
      
CLASS DlSecurRegFormData()
  VAR 
  DepartmentID,
  BeginDate,
  EndDate,
  IsSeparatelyDate,
  IsUseBO,
  IsUseVA,
  IsSAccounts_Report,
  SubjectID,
  IsForm1,
  FormSub1,
  IsVid1,
  VidSub1,
  Noresident1,
  AccountingPlace,
  Issuer_1,
  SecurKind_1,
  SecurIssue,
  IsCL_SAccounts_Report,
  ClientID,
  IsForm2,
  FormSub2,
  IsVid2,
  VidSub2,
  Noresident2,
  ContractID,
  Issuer_2,
  SecurKind_2,
  SecurCode,
  
  IsUseOpostrofs,
  IsExportToExel,
  lastParam;
  
            
  // Значение по умолчанию

  DepartmentID = -1;
  BeginDate = {curdate};
  EndDate = {curdate};
  IsSeparatelyDate = " ";
  IsSAccounts_Report = "X";
  SubjectID = -1;
  IsForm1                =   0;
  FormSub1               =   0;
  IsVid1                 =   0;
  VidSub1                =   0;
  Noresident1            =  "";
  AccountingPlace = -1;
  Issuer_1 = -1;
  SecurKind_1 = -1;
  SecurIssue = -1;
  IsCL_SAccounts_Report = "X";
  ClientID = -1;
  IsForm2                =   0;
  FormSub2               =   0;
  IsVid2                 =   0;
  VidSub2                =   0;
  Noresident2            =  "";
  ContractID = "";
  Issuer_2 = -1;
  SecurKind_2 = -1;
  SecurCode = -1;

  IsUseOpostrofs = "X";
  IsExportToExel = "X";
  
  IsUseBO = "X";
  IsUseVA = "X";
  if(VA_NeedInnerAcc() == false)
    IsUseVA = "";
  end;
  
END;
      
      
VAR DlSAccRepFormData = DlSecurRegFormData();     


PRIVATE CONST /* Обработчики для нестандарных контролов */
      
      H_IS_SUBJECT            = 102, // Субьект(листалка)
      H_ACCOUNTING_PLACE      = 103, // МестоУчета(листалка)
      H_ISSUER_1              = 104, // Эмитент(листалка)
      H_SECUR_KIND_1          = 105, // Вид Ц/Б(листалка)
      H_SECUR_ISSUE           = 106, // Выпск Ц/Б(листалка)
      H_ISSUER_2              = 107, // Эмитент(листалка)
      H_SECUR_KIND_2          = 108, // Вид Ц/Б(листалка)
      H_SECUR_CODE            = 109, // Код Ц/Б(листалка)
      H_PNFLD_BEGINDATE       = 110,
      H_PNFLD_ENDDATE         = 111,
      H_ISFORM                = 112,
      H_FORMSUB               = 113,
      H_ISVID                 = 114,
      H_VIDSUB                = 115; 

PRIVATE CONST SelCodeKind = 1; // Общий параметр для листалок Бирж,Субьектов,Брокеров,Клиентов

///////////////////////////////////////////////////////////////////////////////////////////
// Ползовательские контролы
//////////////////////////////////////////////////////////////////////////////////////////////////////////

PRIVATE MACRO DL_FldProc_FormSub( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if((Cmd == DLG_KEY) AND (Key == KEY_F3))
     DL_ListNA( 3400, @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY(), NULL );
  end;
  return CM_DEFAULT;        
END;

PRIVATE MACRO DL_FldProc_VidSub( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT )
  if((Cmd == DLG_KEY) AND (Key == KEY_F3))

    return DL_ComboBox( "select t_Name2, t_PartyKind from dptkind_dbt ",
                        "t_Name2", "t_PartyKind", 
                        @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY()
                      );


  end; 
END;

PRIVATE MACRO DL_FldProc_IsFormVid( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT, pos:INTEGER):INTEGER
  if((Cmd == DLG_KEY) AND (Key == KEY_SPACE))
    if ( FldRealValue == 0)
        FldShowValue = "=";
        FldRealValue = "1";
        EnableFields( pThis.Data(), pos );

    elif(FldRealValue == 1)
        FldShowValue = "!";
        FldRealValue = "2";
    else
        FldShowValue = "";
        FldRealValue = "0";
        DisableFields( pThis.Data(), pos );
    end;
  end;
  return CM_DEFAULT;        
END;

PRIVATE MACRO DL_FldProc_IsFormVid1( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if((Cmd == DLG_KEY) AND (Key == KEY_SPACE))
     DL_FldProc_IsFormVid( pThis, Cmd, Key, @FldShowValue, @FldRealValue, PNFLD_INACCSECUR_REG_FORMSUB_1);
  end;
END;

PRIVATE MACRO DL_FldProc_IsFormVid2( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if((Cmd == DLG_KEY) AND (Key == KEY_SPACE))
     DL_FldProc_IsFormVid( pThis, Cmd, Key, @FldShowValue, @FldRealValue, PNFLD_INACCSECUR_REG_VIDSUB_1);
  end;
END;

PRIVATE MACRO DL_FldProc_IsFormVid3( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if((Cmd == DLG_KEY) AND (Key == KEY_SPACE))
     DL_FldProc_IsFormVid( pThis, Cmd, Key, @FldShowValue, @FldRealValue, PNFLD_INACCSECUR_REG_FORMSUB_2);
  end;
END;

PRIVATE MACRO DL_FldProc_IsFormVid4( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if((Cmd == DLG_KEY) AND (Key == KEY_SPACE))
     DL_FldProc_IsFormVid( pThis, Cmd, Key, @FldShowValue, @FldRealValue, PNFLD_INACCSECUR_REG_VIDSUB_2);
  end;
END;

MACRO DLUSR_FldProc_Subject( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  var Party     = TRecHandler("party.dbt");
  var ClientName = "";
  var ServKind = TArray(), IsBO = pThis.GetLinkedValue(DL_PNFLD_EMISS_AVR), IsVA = pThis.GetLinkedValue(DL_PNFLD_NOT_EMISS_AVR);
  var IsSubject = pThis.GetLinkedValue(H_IS_SUBJECT);
  var DepCode = pThis.GetLinkedValue( DL_PNFLD_DEPARTCODE );
 
  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = -1;
     end;
     if( FldRealValue <= 0 )
        FldShowValue = STR_ALLVALUE;
     else
        if( not ПолучитьСубъекта( FldRealValue, Party ) )
            FldShowValue = ПолучитьКодСубъекта(FldRealValue, PTCK_CONTR);
        end;
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) and IsSubject )
     FldRealValue = -1;
     FldShowValue = STR_ALLVALUE;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) and IsSubject )

     if( (IsBO != null) and (IsBO == SET_CHAR) )
        ServKind[ServKind.Size] = PTSK_STOCKDL;
     end;

     if( (IsVA != null) and (IsVA == SET_CHAR) )
        ServKind[ServKind.Size] = PTSK_VEKSACC;
     end;

     if(DL_ListClientByServKind( @ClientName, @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY(), ServKind, true, DepCode ))/*в т.ч. может быть "Наш  банк"*/
     end;
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO FldProc_BeginDate( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT ) /*Установка значения в поле*/
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = {curdate};
     end;
     FldShowValue = FldRealValue;

  elif (Cmd == DLG_CHANGEVALUE)
     FldRealValue = FldShowValue;
     if( (FldRealValue != null) AND (pThis.GetLinkedValue(H_PNFLD_ENDDATE) != null) )
        if( FldRealValue > pThis.GetLinkedValue(H_PNFLD_ENDDATE) )
           MsgBox( "Дата окончания не может быть меньше даты начала периода.");
           return CM_IGNORE;
        end;
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
     FldRealValue = GetDateByCalendar( FldRealValue );
     FldShowValue = FldRealValue;
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO FldProc_EndDate( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT ) /*Установка значения в поле*/
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = {curdate};
     end;
     FldShowValue = FldRealValue;

  elif (Cmd == DLG_CHANGEVALUE)
     FldRealValue = FldShowValue;
     if( (FldRealValue != NULL) AND (pThis.GetLinkedValue(H_PNFLD_BEGINDATE) != null) )
        if( FldRealValue < pThis.GetLinkedValue(H_PNFLD_BEGINDATE) )
           MsgBox( "Дата окончания не может быть меньше даты начала периода.");
           return CM_IGNORE;
        end;
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
     FldRealValue = GetDateByCalendar( FldRealValue );
     FldShowValue = FldRealValue;
  end;
  return CM_DEFAULT;
END;

//////////////////////////////////////////////////////////////////////////////////////////////////////////

PRIVATE MACRO DLUSR_FldProc_ACCOUNTING_PLACE( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  var Party     = TRecHandler("party.dbt");
  var partcode = TBFile( "partcode.dbt",  "R", 0 );
  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = -1;
     end;
     if( FldRealValue <= 0 )
        FldShowValue = STR_ALLVALUE;
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     FldRealValue = -1;
     FldShowValue = STR_ALLVALUE;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) ) // Вызов листалки и заполнение FldShowValue и FldRealValue
     Party = TRecHandler("party.dbt");
     if( ListPT( Party, SelCodeKind, "", PTLIST_DEPOSITORY, PTCK_ALL) == true )
        FldRealValue = Party.rec.PartyID;
        partcode.Clear();
        partcode.rec.PartyID  = Party.rec.PartyID;
        partcode.rec.CodeKind = SelCodeKind;
        if (partcode.GetEQ())
          FldShowValue = partcode.rec.Code;
        end;
     end;
  end;
  return CM_DEFAULT;
END;


//////////////////////////////////////////////////////////////////////////////////////////////////////////
PRIVATE MACRO DLUSR_FldProc_Issuer( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  var Party     = TRecHandler("party.dbt");
  var partcode = TBFile( "partcode.dbt",  "R", 0 );
  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = -1;
     end;
     if( FldRealValue <= 0 )
        FldShowValue = STR_ALLVALUE;
     else
      // Установка значений по умолчанию не реализована (геморой)
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     FldRealValue = -1;
     FldShowValue = STR_ALLVALUE;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) ) // Вызов листалки и заполнение FldShowValue и FldRealValue
     Party = TRecHandler("party.dbt");
     if( ListPT( Party, SelCodeKind, "", PTLIST_ISSUER, PTCK_CONTR) == true ) 
        FldRealValue = Party.rec.PartyID;
        partcode.Clear();
        partcode.rec.PartyID  = Party.rec.PartyID;
        partcode.rec.CodeKind = SelCodeKind;
        if (partcode.GetEQ())
          FldShowValue = partcode.rec.Code;
        end;
     end;
  end;
  return CM_DEFAULT;
END;


//////////////////////////////////////////////////////////////////////////////////////////////////////////
PRIVATE MACRO DL_ListAvoiriss( AvrKind:INTEGER, WhereCondition:STRING, AdditionalFromTable:STRING, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):BOOL
  VAR Fininstr = TRecHandler( "fininstr.dbt" );

  if( ListAvoiriss( AvrKind, Fininstr, null, null, WhereCondition, AdditionalFromTable ) )
     FldRealValue = Fininstr.rec.FIID;
     FldShowValue = Fininstr.rec.FI_Code;
     return true;
  end;
  return false;
END;

//////////////////////////////////////////////////////////////////////////////////////////////////////////

PRIVATE MACRO DLUSR_FldProc_AvrKind1( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  var MenuValues   = TArray,
      ReturnValues = TArray,
      isOK, Choice, Query,AvrKindsDataSet;
      
  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = -1;
     end;
     if( FldRealValue <= 0 )
        FldShowValue = STR_ALLVALUE;
     else
      // По умолчанию выставлять геморой!
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     FldRealValue = -1;
     FldShowValue = STR_ALLVALUE;

  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) ) /*Вызов листалки и заполнение FldShowValue и FldRealValue*/
     DL_ListAvrKinds( FIKIND_AVOIRISS, @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY() );
  end;

  return CM_DEFAULT;
END;


//////////////////////////////////////////////////////////////////////////////////////////////////////////

/*Код Ц/Б*/
MACRO DLUSR_FldProc_AvrCode1( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  VAR Fininstr, Avoiriss, AvrKind, AddTable = "", WhereCond = "1=1", IssuerID;
  var period_end_date = pThis.GetFieldValue( PNFLD_INACCSECUR_REG_FINISHDATE ); 

  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = -1;
     end;

     if( FldRealValue <= 0 )
        FldShowValue = STR_ALLVALUE;
     else
        FldShowValue = ПолучитьКодФинИн(FldRealValue);
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) ) /*Вызов листалки и заполнение FldShowValue и FldRealValue*/

     AvrKind = pThis.GetFieldValue( PNFLD_INACCSECUR_REG_SECUR_KIND_1 );
          
     if (AvrKind==-1)
        AvrKind=0;
     end;
     
     IssuerID = pThis.GetFieldValue( PNFLD_INACCSECUR_REG_ISSUER_1 );
     if( (IssuerID != NULL) AND (IssuerID > 0) )
        WhereCond = WhereCond +" AND RSI_RSB_FIInstr.FI_GetIssuerOnDate( t.T_FIID, " + GetSQLDate(period_end_date) + "  ) = " + IssuerID;
     end;

     DL_ListAvoiriss( AvrKind, WhereCond, AddTable, @FldShowValue, @FldRealValue );
  end;

  return CM_DEFAULT;
END;
//////////////////////////////////////////////////////////////////////////////////////////////////////////

/*Код Ц/Б*/
MACRO DLUSR_FldProc_AvrCode2( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  VAR Fininstr, Avoiriss, AvrKind, AddTable = "", WhereCond = "1=1", IssuerID;
  var period_end_date = pThis.GetFieldValue( PNFLD_INACCSECUR_REG_FINISHDATE ); 
      
  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = -1;
     end;
     if( FldRealValue <= 0 )
        FldShowValue = STR_ALLVALUE;
     else
        FldShowValue = ПолучитьКодФинИн(FldRealValue);
     end;
  elif( Cmd == DLG_CHANGEVALUE ) /*значение поля было изменено*/
     Fininstr = TRecHandler( "fininstr.dbt" );
     Avoiriss = TRecHandler( "avoiriss.dbt" );

     if( (FldShowValue == STR_ALLVALUE) OR (FldShowValue == "") )
        FldShowValue = STR_ALLVALUE;
     FldRealValue = -1;
     else
        if( ПолучитьФинИн(FldShowValue, Fininstr, Avoiriss) )
           MsgBox( "Неверное значение поля." );
           return CM_IGNORE; /*отменить изменения и остаться в текущем поле*/
        end;
        FldRealValue = Fininstr.rec.FIID;

        pThis.SetLinkedValue( PNFLD_INACCSECUR_REG_SECUR_KIND_2, Fininstr.rec.AvoirKind );
     end;

  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) ) /*Вызов листалки и заполнение FldShowValue и FldRealValue*/
     AvrKind = pThis.GetFieldValue( PNFLD_INACCSECUR_REG_SECUR_KIND_2 );     
          
     if (AvrKind==-1)
        AvrKind=0;
    end;
          
     IssuerID = pThis.GetFieldValue( PNFLD_INACCSECUR_REG_ISSUER_2 );
     if( (IssuerID != NULL) AND (IssuerID > 0) )
        WhereCond = WhereCond +" AND RSI_RSB_FIInstr.FI_GetIssuerOnDate( t.T_FIID, " + GetSQLDate(period_end_date) + "  ) = " + IssuerID;
    end;
         
     DL_ListAvoiriss( AvrKind, WhereCond, AddTable, @FldShowValue, @FldRealValue );
  end;

  return CM_DEFAULT;
END;

//////////////////////////////////////////////////////////////////////////////////////////////////////////

PRIVATE MACRO DLUSR_FldProc_AvrKind2( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  var MenuValues   = TArray,
      ReturnValues = TArray,
      isOK, Choice, Query,AvrKindsDataSet;

  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = -1;
     end;

     if( FldRealValue <= 0 )
        FldShowValue = STR_ALLVALUE;
  
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     FldRealValue = -1;
     FldShowValue = STR_ALLVALUE;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) ) /*Вызов листалки и заполнение FldShowValue и FldRealValue*/
     DL_ListAvrKinds( FIKIND_AVOIRISS, @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY() );
    end;

  return CM_DEFAULT;
END;

//////////////////////////////////////////////////////////////////////////////////////////////////////////

PRIVATE MACRO Default( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
        FldShowValue = FldRealValue;
/* elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     FldRealValue = 0;
     FldShowValue = STR_ALLVALUE;
*/       
  end; 
  FldShowValue = FldRealValue;
  return CM_DEFAULT;
END;



///////////////////////////////////////////////////////////////////////////////////////////
// Инициализация


CLASS (DL_CPanel) DL_AccountsReg_Panel()

  PRIVATE MACRO Init()
     AddFieldProc( 0, PNFLD_INACCSECUR_REG_DEPARTMENT,           DL_PNFLD_DEPARTCODE,          @DL_FldProc_Department_Cl_BO);
     AddFieldProc( 0, PNFLD_INACCSECUR_REG_DEPARTMENT_NAME,      DL_PNFLD_DEPARTMENT,          @Default, STR_ALLVALUE);  
     AddFieldProc( 0, PNFLD_INACCSECUR_REG_BEGINDATE,            H_PNFLD_BEGINDATE,            @FldProc_BeginDate,     DlSAccRepFormData.BeginDate);
     AddFieldProc( 0, PNFLD_INACCSECUR_REG_FINISHDATE,           H_PNFLD_ENDDATE,              @FldProc_EndDate,       DlSAccRepFormData.EndDate );                 
     AddFieldProc( 0, PNFLD_INACCSECUR_REG_SEPARATELY_DATE,      DL_PNFLD_CHECKBOX,            @DL_FldProc_CheckBox,   DlSAccRepFormData.IsSeparatelyDate );
     AddFieldProc( 0, PNFLD_INACCSECUR_REG_MODULE_BO,            DL_PNFLD_EMISS_AVR,           @DL_FldProc_CheckBox,   DlSAccRepFormData.IsUseBO );
     AddFieldProc( 0, PNFLD_INACCSECUR_REG_MODULE_VA,            DL_PNFLD_NOT_EMISS_AVR,       @DL_FldProc_CheckBox,   DlSAccRepFormData.IsUseVA );
     
     AddFieldProc( 0, PNFLD_INACCSECUR_REG_SECUR_ACCOUNTS_REP,   H_IS_SUBJECT,                 @DL_FldProc_CheckBox,   DlSAccRepFormData.IsSAccounts_Report );
     AddFieldProc( 0, PNFLD_INACCSECUR_REG_SUBJECT,              DL_PNFLD_CLIENT_STOCKDL_CODE2,@DLUSR_FldProc_Subject);         

     AddFieldProc( 0, PNFLD_INACCSECUR_REG_ISFORM_1,             H_ISFORM,                     @DL_FldProc_IsFormVid1,       DlSAccRepFormData.IsForm1);
     AddFieldProc( 0, PNFLD_INACCSECUR_REG_FORMSUB_1,            H_FORMSUB,                    @DL_FldProc_FormSub,          DlSAccRepFormData.FormSub1, 44, 15);
     AddFieldProc( 0, PNFLD_INACCSECUR_REG_ISVID_1,              H_ISVID,                      @DL_FldProc_IsFormVid2,       DlSAccRepFormData.IsVid1);
     AddFieldProc( 0, PNFLD_INACCSECUR_REG_VIDSUB_1,             H_VIDSUB,                     @DL_FldProc_VidSub,           DlSAccRepFormData.VidSub1 , 44, 16);
     AddFieldProc( 0, PNFLD_INACCSECUR_REG_NORESIDENT_1,         DL_PNFLD_CHECKBOX,            @DL_FldProc_CheckBox,         DlSAccRepFormData.Noresident1);

     AddFieldProc( 0, PNFLD_INACCSECUR_REG_ACCOUNTING_PLACE,     H_ACCOUNTING_PLACE,           @DLUSR_FldProc_ACCOUNTING_PLACE);         
     AddFieldProc( 0, PNFLD_INACCSECUR_REG_ISSUER_1,             H_ISSUER_1,                   @DLUSR_FldProc_Issuer);         
     AddFieldProc( 0, PNFLD_INACCSECUR_REG_SECUR_KIND_1,         H_SECUR_KIND_1,               @DLUSR_FldProc_AvrKind1);
     AddFieldProc( 0, PNFLD_INACCSECUR_REG_SECUR_ISSUE,          H_SECUR_ISSUE,                @DLUSR_FldProc_AvrCode1);         
     
     AddFieldProc( 0, PNFLD_INACCSECUR_REG_CL_S_ACOOUNTS_REP,    DL_PNFLD_IS_CLIENT,           @DL_FldProc_CheckBox,   DlSAccRepFormData.IsCL_SAccounts_Report );
     AddFieldProc( 0, PNFLD_INACCSECUR_REG_CLIENT,               DL_PNFLD_CLIENT_STOCKDL_CODE, @DL_FldProc_Client_BO_Dep);         

     AddFieldProc( 0, PNFLD_INACCSECUR_REG_ISFORM_2,             H_ISFORM,                     @DL_FldProc_IsFormVid3,       DlSAccRepFormData.IsForm2);
     AddFieldProc( 0, PNFLD_INACCSECUR_REG_FORMSUB_2,            H_FORMSUB,                    @DL_FldProc_FormSub,          DlSAccRepFormData.FormSub2, 44, 24);
     AddFieldProc( 0, PNFLD_INACCSECUR_REG_ISVID_2,              H_ISVID,                      @DL_FldProc_IsFormVid4,       DlSAccRepFormData.IsVid2);
     AddFieldProc( 0, PNFLD_INACCSECUR_REG_VIDSUB_2,             H_VIDSUB,                     @DL_FldProc_VidSub,           DlSAccRepFormData.VidSub2, 44, 25 );
     AddFieldProc( 0, PNFLD_INACCSECUR_REG_NORESIDENT_2,         DL_PNFLD_CHECKBOX,            @DL_FldProc_CheckBox,         DlSAccRepFormData.Noresident2);

     AddFieldProc( 0, PNFLD_INACCSECUR_REG_CONTRACT,             DL_PNFLD_CONTRACT_OFBU,       @DL_FldProc_Contract_BO_Dep);         
     AddFieldProc( 0, PNFLD_INACCSECUR_REG_ISSUER_2,             H_ISSUER_2,                   @DLUSR_FldProc_Issuer);
     AddFieldProc( 0, PNFLD_INACCSECUR_REG_SECUR_KIND_2,         H_SECUR_KIND_2,               @DLUSR_FldProc_AvrKind2);         
     AddFieldProc( 0, PNFLD_INACCSECUR_REG_SECUR_CODE,           H_SECUR_CODE,                 @DLUSR_FldProc_AvrCode2);         

     AddFieldProc( 0, PNFLD_INACCSECUR_REG_WITH_APOSTROFS,       DL_PNFLD_CHECKBOX,            @DL_FldProc_CheckBox,   DlSAccRepFormData.IsUseOpostrofs );
     AddFieldProc( 0, PNFLD_INACCSECUR_REG_TO_EXEL,              DL_PNFLD_CHECKBOX,            @DL_FldProc_CheckBox,   DlSAccRepFormData.IsExportToExel );

     if(VA_NeedInnerAcc() == false)
       DisableFields( This.Data(), PNFLD_INACCSECUR_REG_MODULE_VA ); 
     end;

     DisableFields( This.Data(), PNFLD_INACCSECUR_REG_FORMSUB_1 ); 
     DisableFields( This.Data(), PNFLD_INACCSECUR_REG_VIDSUB_1 ); 
     DisableFields( This.Data(), PNFLD_INACCSECUR_REG_FORMSUB_2 ); 
     DisableFields( This.Data(), PNFLD_INACCSECUR_REG_VIDSUB_2 ); 

  END;

///////////////////////////////////////////////////////////////////////////////////////////

  PRIVATE MACRO Check():BOOL
     return true;
  END;
  
///////////////////////////////////////////////////////////////////////////////////////////

  initDL_CPanel( "dlrep.lbr", "SecurRep" ); 
END;
