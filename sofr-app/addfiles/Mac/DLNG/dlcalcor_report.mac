/*
$Name:        dlcalcor_report.mac
$Module:      Ядро Securities
$Description: Отчет "Расчет ОР и корректировок"
*/
import "dlcalcor_form.mac", "sp_class.mac", "vaacc.mac", "mmcateg.mac", "cblogger.mac";
import "u_common_email_utils.mac", "file_archive.mac", oralib, likepy; //Simanov

private const SHEET_MAIN = "Итоги обработки операции";

private const OBJECTTYPE_SECURITIES = "SECURITIES";
private const OBJECTTYPE_REPO = "REPO";
private const OBJECTTYPE_BANKWECHSEL = "BANKWECHSEL";
private const OBJECTTYPE_MMARK = "INTERBANK";

private const V_SPECVAL = 26;

const CALCOR_RECEIVER_GROUP_ID = 19;

Private macro get_subject_rating (partyid, dt, ratingid, ratingname, agencyid, agencyname, entrynumber)
  var params = MakeArray(SqlParam("0", partyid,   RSDBP_IN),
                         SqlParam("1", dt,        RSDBP_IN),
                         SqlParam("2", V_INTEGER, RSDBP_OUT),
                         SqlParam("3", V_STRING,  RSDBP_OUT, 255),
                         SqlParam("4", V_INTEGER, RSDBP_OUT),
                         SqlParam("5", V_STRING,  RSDBP_OUT, 255),
                         SqlParam("6", V_INTEGER, RSDBP_OUT));
  var retval = execStoredFunc("rshb_reserve_or.getSubjectRating", V_INTEGER, params);

  if (retval == 1) 
    SetParm(2, params(2).value);
    SetParm(3, params(3).value);
    SetParm(4, params(4).value);
    SetParm(5, params(5).value);
    SetParm(6, params(6).value);
  else
/*очистим*/
    SetParm(2, 0);
    SetParm(3, "");
    SetParm(4, 0);
    SetParm(5, "");
    SetParm(6, 0);
  end;
End;

private CONST PARTY_NOTE_KIND_SUBORD_PERC_RESERV = 78, /*процент резерва субъекта*/
        FICERT_NOTE_KIND_PERC_RESERV = 16; /*процент резерва цб*/

class CDLCalcORParm()
   var EndDate:date;
   var BySecur:bool;
   var ByBill:bool;
   var ByMBK:bool;
   var ByEmail:bool;
   var IsShowReport:bool;

   macro Init()
      EndDate = ZeroDate;
      BySecur = false;
      ByBill  = false;
      ByMBK   = false;
      ByEmail = false;
      IsShowReport = false; // true при выпуске отчета через интерфейс
   end;

   this.Init();
end;

private macro get_subject_type (partyid):string
  var issuertype;
  issuertype = execStoredFunc("rshb_reserve_or.getIssuerType", V_STRING, makeArray(sqlParam("", partyid)));

  if (valtype(issuertype) == V_SPECVAL)
    return "";
  else
    return issuertype;
  end;
End;


PRIVATE MACRO GetTxtPath()
  var RegistryPath = "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR";
  var Path = "";
  var stat = 0;

  GetRegistryValue(RegistryPath, V_STRING, Path, stat);
  if(stat) 
     msgbox("Не задана настройка в реестре банка:|", RegistryPath);      
  end;

  return Path;
END;


PRIVATE MACRO GetRepFullPath()
  var Path = "";

    var txtPath = GetTxtPath();
 /*
    if( substr( txtPath, 1, 2 ) == ".." ) /* ссылка на вышестоящий каталог */
      txtPath = substr(txtPath, 3 );
    end;

    if( substr( txtPath, 1, 1 ) == "\\" ) /* ссылка на вышестоящий каталог */
      txtPath = substr(txtPath, 2 );
    end;
   */
    Path = GetCurDir(false) + "\\" + txtPath + "\\"; 

  // получить полный путь
  return Path;
END;


//Simanov. Значение категории на дату. Возвращается наименование значения
macro getAttrValueName (objecttype:integer, objectid:string, groupid:integer, valuedate:date)
   var attrname = "";
   var query = "select attr.t_name as t_name "
             + "from dobjatcor_dbt atcor "
             + "join dobjattr_dbt attr ON attr.t_objecttype = atcor.t_objecttype and "
             + "                          attr.t_groupid = atcor.t_groupid and "
             + "                          attr.t_attrid = atcor.t_attrid "
             + "where atcor.t_objecttype = :objtype and "
             + "      atcor.t_groupid = :groupid and "
             + "      :valuedate between atcor.t_validfromdate and atcor.t_validtodate and "
             + "      atcor.t_object = :object ";
   var sql = execSqlSelect(query, makeArray(sqlParam("objtype",   objecttype),
                                            sqlParam("groupid",   groupid   ),
                                            sqlParam("valuedate", valuedate ),
                                            sqlParam("object",    objectid  )));
   if (sql.moveNext() )
      attrname = sql.value("t_name");
   end;
   return attrname;
End;

macro get_mmark_source (dealID:integer, dt:Date):string
   var source:string = "";
   var query = "select t_comment from dmmhstimp_dbt mm "
             + "where t_date = (select max(t_date) from dmmhstimp_dbt "
             + "                where t_dealid = mm.t_Dealid and "
             + "                      t_date <= :dt) "
             + "      and t_Dealid = :dealid";
   var sql = execSqlSelect(query, makeArray(sqlParam("dt", dt), sqlParam("dealid", dealID)));
   if (sql.moveNext )
      source = sql.value(0);
   end;
   return source;
End;

private class CRecData()
   var A01, A02, A03, A04, A05, A06, A07, A08, A09, A10,
       A11, A12, A13, A14, A15, A16, A17, A18, A19, A20,
       A21, A22, A23, A24, A25, A26, A27, A28, A29, A30,
       A31, A32, A33, A34, A35, A36, A37, A38, A39, A40,
       A41, A42, A43, A44, A45, A46, A47, A48, A49, A50,
       A51, A52, A53, A54, A55, A56, A57, A58, A59, A60,
       A61, A62, A63, A64, A65, Acc;

   macro Clear()
      A01 = A02 = A03 = A04 = A05 = A06 = A07 = A08 = A09 = A10 =
      A11 = A12 = A13 = A14 = A15 = A16 = A17 = A18 = A19 = A20 = 
      A21 = A22 = A23 = A24 = A25 = A26 = A27 = A28 = A29 = A30 = 
      A31 = A32 = A33 = A34 = A35 = A36 = A37 = A38 = A39 = A40 = 
      A41 = A42 = A43 = A44 = A45 = A46 = A47 = A48 = A49 = A50 = 
      A51 = A52 = A53 = A54 = A55 = A56 = A57 = A58 = A59 = A60 =
      A61 = A62 = A63 = A64 = A65 = Acc = "";
   end;
end;

private class (DL_CReportTemplate) CDLCalcORReport( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER )
   private var 
   m_RepParm:CDLCalcORParm,
   m_RS, m_RecNo = 0, m_IsDataExist = false,
   m_RecData:CRecData = CRecData(),
   m_FD,
   m_PortfolioSum = $0, m_prevFIID = -1, m_prevPortf = -1;

   //Simanov
   private var
   ATTR_AVOIRISS_RECOVERY,
   ATTR_AVOIRISS_STAGE,
   ATTR_AVOIRISS_STAGE_SOFR,
   ATTR_AVOIRISS_SOURCE,

   ATTR_SECDEAL_RECOVERY,
   ATTR_SECDEAL_STAGE,
   ATTR_SECDEAL_STAGE_SOFR,
   ATTR_SECDEAL_SOURCE,

   ATTR_FICERT_RECOVERY,
   ATTR_FICERT_STAGE,
   ATTR_FICERT_STAGE_SOFR,
   ATTR_FICERT_SOURCE,

   ATTR_MBK_RECOVERY,
   ATTR_MBK_STAGE,
   ATTR_MBK_STAGE_SOFR;

   //Simanov
   macro Init_vars ()
      ATTR_AVOIRISS_RECOVERY   = execStoredFunc( "rshb_reserve_or.get_avr_attr_recovery", V_INTEGER);
      ATTR_AVOIRISS_STAGE      = execStoredFunc( "rshb_reserve_or.get_avr_attr_stage", V_INTEGER);
      ATTR_AVOIRISS_STAGE_SOFR = execStoredFunc( "rshb_reserve_or.get_avr_attr_stage_sofr", V_INTEGER);
      ATTR_AVOIRISS_SOURCE     = execStoredFunc( "rshb_reserve_or.get_avr_attr_method", V_INTEGER);

      ATTR_SECDEAL_RECOVERY    = execStoredFunc( "rshb_reserve_or.get_deal_attr_recovery", V_INTEGER);
      ATTR_SECDEAL_STAGE       = execStoredFunc( "rshb_reserve_or.get_deal_attr_stage", V_INTEGER);
      ATTR_SECDEAL_STAGE_SOFR  = execStoredFunc( "rshb_reserve_or.get_deal_attr_stage_sofr", V_INTEGER);
      ATTR_SECDEAL_SOURCE      = execStoredFunc( "rshb_reserve_or.get_deal_attr_method", V_INTEGER);

      ATTR_FICERT_RECOVERY     = execStoredFunc( "rshb_reserve_or.get_va_attr_recovery", V_INTEGER);
      ATTR_FICERT_STAGE        = execStoredFunc( "rshb_reserve_or.get_va_attr_stage", V_INTEGER);
      ATTR_FICERT_STAGE_SOFR   = execStoredFunc( "rshb_reserve_or.get_va_attr_stage_sofr", V_INTEGER);
      ATTR_FICERT_SOURCE       = execStoredFunc( "rshb_reserve_or.get_va_attr_method", V_INTEGER);

      ATTR_MBK_RECOVERY        = execStoredFunc( "rshb_reserve_or.get_mbk_attr_recovery", V_INTEGER);
      ATTR_MBK_STAGE           = execStoredFunc( "rshb_reserve_or.get_mbk_attr_stage", V_INTEGER);
      ATTR_MBK_STAGE_SOFR      = execStoredFunc( "rshb_reserve_or.get_mbk_attr_stage_sofr", V_INTEGER);
   End;

   macro SetRepParm(RepParm:CDLCalcORParm)
      m_RepParm = RepParm;
      SetIsShowAppl(m_RepParm.IsShowReport);
   end;

   macro DataExist()
      return (m_IsDataExist or ReportHasError());
   end;

   macro PrintMode():INTEGER
      return DL_OUTREPORT_EXCEL;
   end;

   private macro logTime(p_text, p_time)
      var hh, min, sec;

      timeSplit(p_time, hh, min, sec);
      AddItLog(p_text + ". elapsed time: " +string(hh:o:2)+":"+string(min:o:2)+":"+string(sec:o:2));
   end;

   private macro PrintHeader()
      PrintFormatString( "",
                         "N1_D01", string(m_RepParm.EndDate:f)
                       );
   end;

   private macro BReport()
      SetActiveSheet( SHEET_MAIN );
      PrintHeader();

      RegisterTable( "N1_MainTable", "",
                     "N1_A01",       "N1_A02",       "N1_A06",       "N1_A53",       "N1_A54",       "N1_A55",
                     "N1_A07",       "N1_A56",       "N1_A17",       "N1_A32",       "N1_A04",       "N1_A03",
                     "N1_A05",       "N1_A57",       "N1_A58",       "N1_A08",       "N1_A09",       "N1_A10",
                     "N1_A16",       "N1_A12",       "N1_A13",       "N1_A14",       "N1_A15",       "N1_A11",
                     "N1_A59",       "N1_A60",       "N1_A25",       "N1_A26",       "N1_A61",       "N1_A62",
                     "N1_A18",       "N1_A19",       "N1_A20",       "N1_A24",       "N1_A22",       "N1_A23",
                     "N1_A21",       "N1_A33",       "N1_A30",       "N1_A31",       "N1_A27",       "N1_A28",
                     "N1_A29",       "N1_A34",       "N1_A35",       "N1_A36",       "N1_A41",       "N1_A38",
                     "N1_A39",       "N1_A63",       "N1_A40",       "N1_A37",       "N1_A42",       "N1_A43",
                     "N1_A44",       "N1_A49",       "N1_A46",       "N1_A47",       "N1_A64",       "N1_A48",
                     "N1_A45",       "N1_A50",       "N1_A51",       "N1_A52",       "N1_A65",       "N1_Acc"
                   );
   end;

   private macro EReport()
      EndTable();
      AddStandardFooter( "N1_", null, true );
   end;

   private macro PrintData()
      PrintTableLine( "N1_A01",   m_RecData.A01,      null,
                      "N1_A02",   m_RecData.A02,      null,
                      "N1_A06",   m_RecData.A06,      null,
                      "N1_A53",   m_RecData.A53,      null,
                      "N1_A54",   m_RecData.A54,      null,
                      "N1_A55",   m_RecData.A55,      null,
                      "N1_A07",   m_RecData.A07,      null,
                      "N1_A56",   m_RecData.A56,      null,
                      "N1_A17",   m_RecData.A17,      null,
                      "N1_A32",   m_RecData.A32,      null,
                      "N1_A04",   m_RecData.A04,      null,
                      "N1_A03",   m_RecData.A03,      null,
                      "N1_A05",   m_RecData.A05,      null,
                      "N1_A57",   m_RecData.A57,      null,
                      "N1_A58",   m_RecData.A58,      null,
                      "N1_A08",   m_RecData.A08,      null,
                      "N1_A09",   m_RecData.A09,      null,
                      "N1_A10",   m_RecData.A10,      null,
                      "N1_A16",   m_RecData.A16,      null,
                      "N1_A12",   m_RecData.A12,      null,
                      "N1_A13",   m_RecData.A13,      null,
                      "N1_A14",   m_RecData.A14,      null,
                      "N1_A15",   m_RecData.A15,      null,
                      "N1_A11",   m_RecData.A11,      null,
                      "N1_A59",   m_RecData.A59,      null,
                      "N1_A60",   m_RecData.A60,      null,
                      "N1_A25",   m_RecData.A25,      null,
                      "N1_A26",   m_RecData.A26,      null,
                      "N1_A61",   m_RecData.A61,      null,
                      "N1_A62",   m_RecData.A62,      null,
                      "N1_A18",   m_RecData.A18,      null,
                      "N1_A19",   m_RecData.A19,      null,
                      "N1_A20",   m_RecData.A20,      null,
                      "N1_A24",   m_RecData.A24,      null,
                      "N1_A22",   m_RecData.A22,      null,
                      "N1_A23",   m_RecData.A23,      null,
                      "N1_A21",   m_RecData.A21,      null,
                      "N1_A33",   m_RecData.A33,      null,
                      "N1_A30",   m_RecData.A30,      null,
                      "N1_A31",   m_RecData.A31,      null,
                      "N1_A27",   m_RecData.A27,      null,
                      "N1_A28",   m_RecData.A28,      null,
                      "N1_A29",   m_RecData.A29,      null,
                      "N1_A34",   m_RecData.A34,      null,
                      "N1_A35",   m_RecData.A35,      null,
                      "N1_A36",   m_RecData.A36,      null,
                      "N1_A41",   m_RecData.A41,      null,
                      "N1_A38",   m_RecData.A38,      null,
                      "N1_A39",   m_RecData.A39,      null,
                      "N1_A63",   m_RecData.A63,      null,
                      "N1_A40",   m_RecData.A40,      null,
                      "N1_A37",   m_RecData.A37,      null,
                      "N1_A42",   m_RecData.A42,      null,
                      "N1_A43",   m_RecData.A43,      null,
                      "N1_A44",   m_RecData.A44,      null,
                      "N1_A49",   m_RecData.A49,      null,
                      "N1_A46",   m_RecData.A46,      null,
                      "N1_A47",   m_RecData.A47,      null,
                      "N1_A64",   m_RecData.A64,      null,
                      "N1_A48",   m_RecData.A48,      null,
                      "N1_A45",   m_RecData.A45,      null,
                      "N1_A50",   m_RecData.A50,      null,
                      "N1_A51",   m_RecData.A51,      null,
                      "N1_A52",   m_RecData.A52,      null,
                      "N1_A65",   m_RecData.A65,      null,
                      "N1_Acc",   m_RecData.Acc,      null
                    );
   end;

   private macro GetAddCond(LClass, LValue)
      return " AND DECODE( "+LClass+", " +
                         " cat.t_Class1, tpl.t_Value1, " +
                         " cat.t_Class2, tpl.t_Value2, " +
                         " cat.t_Class3, tpl.t_Value3, " +
                         " cat.t_Class4, tpl.t_Value4, " +
                         " cat.t_Class5, tpl.t_Value5, " +
                         " cat.t_Class6, tpl.t_Value6, " +
                         " cat.t_Class7, tpl.t_Value7, " +
                         " cat.t_Class8, tpl.t_Value8, " +
                         " -1 " +
                       " ) = "+LValue;
   end;

   private macro GetAccountByFI(FIID, Cat, AndCond, Acc  )
      var ds, cmd, sql, find=false;

      Acc.Clear();
      if(AndCond == null)
         AndCond = "";
      end;

      sql = " SELECT acc.* " +
              " FROM daccount_dbt acc, " +
                    "( SELECT DISTINCT acd.t_Account, acd.t_Currency, acd.t_Chapter " +
                       " FROM dmcaccdoc_dbt acd, DMCCATEG_DBT cat, dmctempl_dbt tpl, daccount_dbt acc " +
                      " WHERE acd.t_FIID = ? " +
                        " AND acd.t_Chapter = 1 " +
                        " AND acd.t_CatID = cat.t_ID " +
                        " AND cat.T_CODE = ? " +
                        " AND CAT.T_LEVELTYPE = 1 " +
                        " AND tpl.t_CatID = cat.t_ID " +
                        " AND tpl.t_Number = acd.t_TemplNum " +
                          AndCond +
//                    " GROUP BY acd.t_Account, acd.t_Currency, acd.t_Chapter " +
                        " AND ROWNUM < 2 " +
                   " ) q " +
             " WHERE acc.t_Account = q.t_Account " +
               " AND acc.t_Code_Currency = q.t_Currency " +
               " AND acc.t_Chapter = q.t_Chapter "
               " AND ROWNUM < 2 ";

      cmd = RSDCommand(sql);
      cmd.addParam( "", RSDBP_IN, FIID );
      cmd.addParam( "", RSDBP_IN, Cat );
      cmd.execute();

      ds = TRsbDataSet(cmd);
      if(ds.MoveNext())
         ds.GetRecord().CopyTo( Acc.rec );
         find = true;
      end;

      return find;
   end;

   private macro GetRest(FD, Cat, EndDate, pAcc:@String)
      var acc = TRecHandler("account.dbt"),
          sum = 0.0;
      //if( FD.IsExistAccount(Cat, null, true, GetFIRoleByPortfolio(FD.KindPortf()), acc, null, EndDate) ) // почему-то не всегда определяет счет
      if( GetAccountByFI(FD.fininstr().rec.FIID, Cat, GetAddCond(LLCLASS_KINDPORT, FD.KindPortf()), acc) )
         pAcc = acc.rec.Account;
         sum = /*abs*/(GetRestAccount(acc.rec, EndDate));
      end;
      return sum;
   end;

   private macro PrintPortfolio()
      m_RecData.A01 = "Итого по портфелю: ";
      m_RecData.A06 = DL_GetValueName(OBJTYPE_KINDPORT, m_FD.KindPortf());

      m_RecData.A50 = m_PortfolioSum;
      m_RecData.A51 = GetRest(m_FD, "+Кор_Резерв, ЦБ", m_RepParm.EndDate, @m_RecData.Acc);
      if(m_RecData.A51 == 0)
         m_RecData.A51 = m_RecData.A51 + GetRest(m_FD, "-Кор_Резерв, ЦБ", m_RepParm.EndDate, @m_RecData.Acc);
      end;

      m_RecData.A52 = m_RecData.A51 - m_RecData.A50;

      Merge( "N1_A01", "N1_A02", 12.75);
      Merge( "N1_A06", "N1_A45", 12.75);

      m_RecData.A65 = DL_GetValueName(OBJTYPE_KINDPORT, m_FD.KindPortf());

      PrintTableLine( "N1_A01",   m_RecData.A01,      null,
                      "N1_A06",   m_RecData.A06,      null,
                      "N1_A50",   m_RecData.A50,      null,
                      "N1_A51",   m_RecData.A51,      null,
                      "N1_A52",   m_RecData.A52,      null,
                      "N1_A65",   m_RecData.A65,      null,
                      "N1_Acc",   m_RecData.Acc,      null
                    );

      m_PortfolioSum = $0;
   end;

   private macro GetINN(PartyID, PTCK_Kind)
      var inn, slashInd, innNotKPP;

      inn = ПолучитьКодСубъекта(PartyID, PTCK_Kind);
      slashInd = Index(inn, "/");
      innNotKPP = IIF(slashInd > 0, SubStr(inn, 1, slashInd - 1), inn);

      return innNotKPP;
   end;

   private macro GetDLSumOnDate(docKind, docID, kind, onDate)
      var sum = 0, ds, cmd, sql;
      sql = " select t_Sum " +
              " from ddlsum_dbt " +
             " where t_DocKind = ? " +
               " and t_DocID = ? " +
               " and t_Kind = ? " +
               " and t_Date <= ? " +
             " order by t_Date desc ";

      cmd = RSDCommand(sql);
      cmd.addParam( "", RSDBP_IN, docKind );
      cmd.addParam( "", RSDBP_IN, docID );
      cmd.addParam( "", RSDBP_IN, kind );
      cmd.addParam( "", RSDBP_IN, onDate );
      cmd.execute();

      ds = TRsbDataSet(cmd);
      if (ds.MoveNext())
         sum = ds.t_Sum;
      end;

      return sum;
   end;

   private macro GetPartyOwn(party)
      var partyOwn = "", ds, cmd, sql;
      sql = " WITH Kinds " +
              " AS (SELECT t_PartyKind from dpartyown_dbt where t_PartyID = ? and t_PartyKind IN ("+PTK_BANK+","+PTK_STATE_BODY+","+PTK_STATE_BODY_SUBJECT+","+PTK_LOCAL_BODY+")) " +
          " SELECT (case when Exists(select 1 from Kinds where t_PartyKind = "+PTK_BANK+") " +
                       " then 'FINANCIAL' " +
                       " when Exists(select 1 from Kinds where t_PartyKind = "+PTK_STATE_BODY+") " +
                       " then 'SOVEREIGN' " +
                       " when Exists(select 1 from Kinds where t_PartyKind IN ("+PTK_STATE_BODY_SUBJECT+","+PTK_LOCAL_BODY+")) " +
                       " then 'SUBSOVEREIGN' " +
                       " else  chr(1) end " +
                 " ) PartyOwn " +
            " FROM Kinds WHERE rownum < 2 ";

      cmd = RSDCommand(sql);
      cmd.addParam( "", RSDBP_IN, party.rec.PartyID );
      cmd.addParam( "", RSDBP_IN, party.rec.PartyID );
      cmd.execute();

      ds = TRsbDataSet(cmd);
      if(ds.MoveNext())
         partyOwn = SQL_ConvTypeStr(ds.PartyOwn);
      elif(party.rec.LegalForm == legal_form_jur)
         partyOwn = "CORPORATE";
      end;
      return partyOwn;
   end;

   private macro GetWorkDayCount(BegDate, EndDate)
      var cnt=0, ds, cmd;

      cmd = RSDCommand(" select nvl(RSI_RSBCALENDAR.GETWORKDAYCOUNT(?, ?), 0) cnt from dual ");
      cmd.addParam( "", RSDBP_IN, BegDate );
      cmd.addParam( "", RSDBP_IN, EndDate );
      cmd.execute();

      ds = TRsbDataSet(cmd);
      if (ds.MoveNext())
         cnt = Int(ds.cnt);
      end;
      return cnt;
   end;

   private macro GetIncomeRate(FIID, EndDate, IsFloatingRate)
      var sql, ds, cmd, IncomeRate = 0., IncomeVolume = $0;

      sql = " SELECT w.t_ID, w.t_IncomeVolume, w.t_IncomeRate, w.t_RelativeIncome " +
              " FROM dfiwarnts_dbt w " +
             " WHERE w.t_FIID = ? " +
               " AND w.t_ID = (select max(t_ID) " +
                               " from dfiwarnts_dbt " +
                              " where t_FIID = w.t_FIID " +
                                " and t_IsPartial = chr(0) " +
                                " and t_FirstDate <= ?) "; // действующий на дату отчета

      cmd = RSDCommand(sql);
      cmd.addParam( "", RSDBP_IN, FIID );
      cmd.addParam( "", RSDBP_IN, EndDate );
      cmd.execute();

      ds = TRsbDataSet(cmd);
      if(ds.MoveNext())
         IncomeRate = double(ds.IncomeRate);
         IncomeVolume = SQL_ConvTypeSum(ds.IncomeVolume);

         //if(not IsFloatingRate)
            if((IncomeRate == 0) and (IncomeVolume != 0))
               FI_CouponPumpIncomeRateVolume( Int(ds.ID), IncomeVolume, IncomeRate );
            end;/*
         else
            var sql2, ds2, cmd2;
            sql2 = " SELECT h.t_IncomeRate " +
                     " FROM dflrhist_dbt h " +
                    " WHERE h.t_ID = (select max(t_ID) " +
                                      " from dflrhist_dbt " +
                                     " where t_FIWarntID = ? " +
                                       " and t_BegDate <= ?) "; // действующая на дату отчета
            cmd2 = RSDCommand(sql2);
            cmd2.addParam( "", RSDBP_IN, Int(ds.ID) );
            cmd2.addParam( "", RSDBP_IN, EndDate );
            cmd2.execute();

            ds2 = TRsbDataSet(cmd2);
            if(ds2.MoveNext())
               IncomeRate = double(ds2.IncomeRate);
            end;
         end;*/
      end;
      return IncomeRate;
   end;

   private macro CollectDataSecur()
      m_RecData.Clear();

      var innNotKPP, delayDays, Numb,
          party = TRecHandler("party.dbt");

      m_FD = SPFirstDoc(LEG_KIND_DL_TICK, Int(m_Rs.DealID));

      m_RecData.A01 = m_RecNo+1;
      m_RecData.A02 = {OperDprt};

      if(ПолучитьСубъекта(Int(m_Rs.party_issuer), party) == 0)
         m_RecData.A03 = GetINN(party.rec.PartyID, IIF(party.rec.NotResident == UNSET_CHAR, PTCK_INN, PTCK_FOREIGN_INN));
         if(m_RecData.A03 == "")
            m_RecData.A03 = ПолучитьКодСубъекта(party.rec.PartyID, PTCK_LEI);
         end;
         m_RecData.A04 = ПолучитьКодСубъекта(party.rec.PartyID, PTCK_CONTR);
         m_RecData.A05 = SQL_ConvTypeStr(party.rec.ShortName);

         get_subject_rating(party.rec.PartyID, m_RepParm.EndDate, null, m_RecData.A57, null, m_RecData.A58, Numb);

         m_RecData.A54 = get_subject_type(party.rec.partyid);
      end;

      m_RecData.A06 = SQL_ConvTypeStr(m_Rs.ID_ISIN);
      m_RecData.A07 = SQL_ConvTypeDate(m_Rs.Date);
      m_RecData.A08 = SQL_ConvTypeSum(m_Rs.amount_debt_OD);
      m_RecData.A11 = SQL_ConvTypeSum(m_Rs.OUTLAY);
      m_RecData.A15 = SQL_ConvTypeSum(m_Rs.CORRINTTOEIR);
      m_RecData.A17 = SQL_ConvTypeStr(m_Rs.CCY);

      if(Int(m_Rs.IsREPO) == 0)
         m_RecData.A09 = SQL_ConvTypeSum(m_Rs.amount_debt_perc);
         m_RecData.A10 = SQL_ConvTypeSum(m_Rs.NKDAmount);
         m_RecData.A12 = SQL_ConvTypeSum(m_Rs.Bonus_debt);
         m_RecData.A13 = SQL_ConvTypeSum(m_Rs.DISCOUNTINCOME);
         m_RecData.A14 = SQL_ConvTypeSum(m_Rs.OVERAMOUNT);

         if((Int(m_Rs.Portfolio) != KINDPORT_CONTR) and (m_FD.fininstr().rec.FaceValueFI != NATCUR))
            SmartConvertSum(m_RecData.A11, m_RecData.A11, m_RepParm.EndDate, m_FD.fininstr().rec.FaceValueFI, NATCUR, true);
         end;

         if(m_FD.fininstr().rec.FaceValueFI != NATCUR)
            SmartConvertSum(m_RecData.A08, m_RecData.A08, m_RepParm.EndDate, m_FD.fininstr().rec.FaceValueFI, NATCUR, true);
            SmartConvertSum(m_RecData.A09, m_RecData.A09, m_RepParm.EndDate, m_FD.fininstr().rec.FaceValueFI, NATCUR, true);
            SmartConvertSum(m_RecData.A10, m_RecData.A10, m_RepParm.EndDate, m_FD.fininstr().rec.FaceValueFI, NATCUR, true);
            SmartConvertSum(m_RecData.A12, m_RecData.A12, m_RepParm.EndDate, m_FD.fininstr().rec.FaceValueFI, NATCUR, true);
            SmartConvertSum(m_RecData.A13, m_RecData.A13, m_RepParm.EndDate, m_FD.fininstr().rec.FaceValueFI, NATCUR, true);
         end;

         DL_GetObjAttrName(OBJTYPE_AVOIRISS, 13, DL_GetMainObjAttr(m_FD.fininstr(), 13, OBJTYPE_AVOIRISS), null, null, @m_RecData.A25);
         m_RecData.A26 = readNoteForObject(OBJTYPE_AVOIRISS, uniID(m_FD.fininstr(), OBJTYPE_AVOIRISS), 3, m_RepParm.EndDate);


	 m_RecData.A27 = readNoteForObject(OBJTYPE_SECDEAL, uniID(m_FD.tick(), OBJTYPE_SECDEAL), 36, m_RepParm.EndDate);
         if( m_RecData.A27 == 0. )
           var Finin = TRecHandler( "fininstr.dbt" );	
           ПолучитьФинИн(m_Rs.FIID, finin);
           //m_RecData.A27 = readNoteForObject(OBJTYPE_AVOIRISS, uniID(m_FD.fininstr(), OBJTYPE_AVOIRISS), 24, m_RepParm.EndDate);
             m_RecData.A27 = readNoteForObject(OBJTYPE_AVOIRISS, uniID(finin, OBJTYPE_AVOIRISS), 24, m_RepParm.EndDate);
         end;

         delayDays = GetWorkDayCount(SQL_ConvTypeDate(m_Rs.NearDrawingDate), m_RepParm.EndDate);
         m_RecData.A32 = IIF(delayDays > 0, delayDays, 0);
         m_RecData.A53 = OBJECTTYPE_SECURITIES;
         m_RecData.A55 = GetIncomeRate(m_FD.fininstr().rec.FIID, m_RepParm.EndDate, (m_Rs.FloatingRate==SET_CHAR));
         m_RecData.A56 = SQL_ConvTypeDate(m_Rs.DrawingDate);
         m_RecData.A65 = DL_GetValueName(OBJTYPE_KINDPORT, m_FD.KindPortf());

         //Simanov
         m_RecData.A33 = getAttrValueName(OBJTYPE_AVOIRISS, uniID(m_FD.fininstr(), OBJTYPE_AVOIRISS), ATTR_AVOIRISS_RECOVERY,   m_RepParm.EndDate); //признак выздоровления
         m_RecData.A30 = getAttrValueName(OBJTYPE_AVOIRISS, uniID(m_FD.fininstr(), OBJTYPE_AVOIRISS), ATTR_AVOIRISS_STAGE,      m_RepParm.EndDate); //этап резервирования
         m_RecData.A29 = getAttrValueName(OBJTYPE_AVOIRISS, uniID(m_FD.fininstr(), OBJTYPE_AVOIRISS), ATTR_AVOIRISS_SOURCE,     m_RepParm.EndDate); //источник
         m_RecData.A31 = getAttrValueName(OBJTYPE_AVOIRISS, uniID(m_FD.fininstr(), OBJTYPE_AVOIRISS), ATTR_AVOIRISS_STAGE_SOFR, m_RepParm.EndDate); //этап резервирования (СОФР)
         
      else
         m_RecData.A09 = Money(GetDLSumOnDate(m_FD.tick.rec.BOfficeKind, m_FD.tick.rec.DealID, DLSUM_KIND_SUM_TO_PERCENT_CFI, m_RepParm.EndDate));

         if(m_FD.dl_leg.rec.CFI != NATCUR)
            SmartConvertSum(m_RecData.A08, m_RecData.A08, m_RepParm.EndDate, m_FD.dl_leg.rec.CFI, NATCUR, true);            
            SmartConvertSum(m_RecData.A09, m_RecData.A09, m_RepParm.EndDate, m_FD.dl_leg.rec.CFI, NATCUR, true);            
         end;

         DL_GetObjAttrName(OBJTYPE_SECDEAL, 15, DL_GetMainObjAttr( m_FD.tick, 15, OBJTYPE_SECDEAL ), null, null, @m_RecData.A25);
         if( (ValType(m_RecData.A25) == V_UNDEF) or (m_RecData.A25 == "") )
            DL_GetObjAttrName(OBJTYPE_PARTY, 13, DL_GetMainObjAttr( party, 13, OBJTYPE_PARTY ), null, null, @m_RecData.A25);
         end;
         m_RecData.A26 = readNoteForObject( OBJTYPE_SECDEAL, uniID(m_FD.tick, OBJTYPE_SECDEAL), 8, m_RepParm.EndDate);
         if( (ValType(m_RecData.A26) == V_UNDEF) or (m_RecData.A26 == "") or (m_RecData.A26 <= 0.) )
            m_RecData.A26 = readNoteForObject( OBJTYPE_PARTY, uniID(party, OBJTYPE_PARTY), 3, m_RepParm.EndDate);
         end;
         m_RecData.A27 = readNoteForObject( OBJTYPE_SECDEAL, uniID(m_FD.tick, OBJTYPE_SECDEAL), 36, m_RepParm.EndDate);
         if( (ValType(m_RecData.A27) == V_UNDEF) or (m_RecData.A27 <= 0.) )
            m_RecData.A27 = readNoteForObject( OBJTYPE_PARTY, uniID(party, OBJTYPE_PARTY), 78, m_RepParm.EndDate);
         end;

         delayDays = GetWorkDayCount(SQL_ConvTypeDate(m_Rs.DeliveryDate2), m_RepParm.EndDate);
         m_RecData.A32 = IIF(delayDays > 0, delayDays, 0);
         m_RecData.A53 = OBJECTTYPE_REPO;
         m_RecData.A55 = m_FD.dl_leg.rec.IncomeRate;
         m_RecData.A56 = SQL_ConvTypeDate(m_Rs.DeliveryDate2);
	 
         //Simanov
         m_RecData.A33 = getAttrValueName(OBJTYPE_SECDEAL, uniID(m_FD.tick, OBJTYPE_SECDEAL), ATTR_SECDEAL_RECOVERY, m_RepParm.EndDate); //признак выздоровления
         m_RecData.A30 = getAttrValueName(OBJTYPE_SECDEAL, uniID(m_FD.tick, OBJTYPE_SECDEAL), ATTR_SECDEAL_STAGE, m_RepParm.EndDate); //этап резервирования
         m_RecData.A29 = getAttrValueName(OBJTYPE_SECDEAL, uniID(m_FD.tick, OBJTYPE_SECDEAL), ATTR_SECDEAL_SOURCE, m_RepParm.EndDate); //источник
         m_RecData.A31 = getAttrValueName(OBJTYPE_SECDEAL, uniID(m_FD.tick, OBJTYPE_SECDEAL), ATTR_SECDEAL_STAGE_SOFR, m_RepParm.EndDate); //этап резервирования (СОФР)
      end;

      var A26 = 0.0;
      if( (ValType(m_RecData.A26) != V_UNDEF) and (m_RecData.A26 != "") and (m_RecData.A26 > 0.) )
         A26 = Double(m_RecData.A26) / 100.;
      end;
      m_RecData.A18 = m_RecData.A08 * A26;
      m_RecData.A19 = m_RecData.A09 * A26;
      m_RecData.A21 = m_RecData.A11 * A26;
      if(Int(m_Rs.IsRepo) == 0)
         m_RecData.A20 = m_RecData.A10 * A26;
         m_RecData.A22 = m_RecData.A12 * A26;
         m_RecData.A23 = m_RecData.A13 * A26;
      end;
      /*KD*/
        m_RecData.A61 = m_RecData.A18+m_RecData.A19+m_RecData.A20+m_RecData.A21+m_RecData.A22+m_RecData.A23+m_RecData.A24;

      var A27 = 0.0;
      if( (ValType(m_RecData.A27) != V_UNDEF) and (m_RecData.A27 > 0.) )
         A27 = m_RecData.A27 / 100.;
      end;
      m_RecData.A34 = m_RecData.A08 * A27;
      m_RecData.A35 = m_RecData.A09 * A27;
      m_RecData.A37 = m_RecData.A11 * A27;
      if(Int(m_Rs.IsRepo) == 0)
         m_RecData.A36 = m_RecData.A10 * A27;
         m_RecData.A38 = m_RecData.A12 * A27;
         m_RecData.A39 = m_RecData.A13 * A27;
         m_RecData.A63 = m_RecData.A14 * A27;
      end;
      m_RecData.A40 = m_RecData.A15 * A27;
      m_RecData.A48 = m_RecData.A40;

      m_RecData.A42 = m_RecData.A34 - m_RecData.A18;
      m_RecData.A43 = m_RecData.A35 - m_RecData.A19;
      m_RecData.A45 = m_RecData.A37 - m_RecData.A21;
      if(Int(m_Rs.IsRepo) == 0)
         m_RecData.A44 = m_RecData.A36 - m_RecData.A20;
         m_RecData.A46 = m_RecData.A38 - m_RecData.A22;
         m_RecData.A47 = m_RecData.A39 - m_RecData.A23;
         m_RecData.A64 = m_RecData.A63;

         m_RecData.A50 = m_RecData.A42 + m_RecData.A43 + m_RecData.A44 + m_RecData.A45 + m_RecData.A46 + m_RecData.A47 + m_RecData.A48 + m_RecData.A64;
         m_PortfolioSum = m_PortfolioSum + m_RecData.A50;
      else
         m_RecData.A50 = m_RecData.A42 + m_RecData.A43 + m_RecData.A45 + m_RecData.A48;
      end;
   end;

   private macro GetSQLREPO()
      return " SELECT 1 IsRepo, " +
                    " v.t_DealID, " +
                    " -1 t_FIID, " +
                    " v.t_Portfolio, " +
                    " (case when RSB_SECUR.IsExchange(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1 and tick.t_PartyID <= 0 " +
                          " then tick.t_MarketID " +
                          " else tick.t_PartyID " +
                     " end) party_issuer, " +
                    " tick.t_DealCode ID_ISIN, " +
                    " v.t_Date, " +
                    " v.t_Sum amount_debt_OD, " +
                    " 0 amount_debt_perc, " +
                    " 0 t_NKDAMOUNT, " +
                    " v.T_OUTLAY, " +
                    " 0 Bonus_debt, " +
                    " 0 t_DISCOUNTINCOME, " +
                    " 0 t_OVERAMOUNT, " +
                    " v.T_CORRINTTOEIR, " +
                    " (select t_CCY from dfininstr_dbt where t_FIID = " +
                     " ( " +
                      " select t_FIID from ddlrq_dbt where t_DocKind = tick.t_BOfficeKind and t_DocID = tick.t_DealID and t_DealPart = 1 and t_Type = 2 and rownum < 2 " +
                    " )) CCY, " +
                    " (select Greatest(t_PlanDate, t_FactDate) " +
                       " from ddlrq_dbt " +
                      " where t_DocKind = tick.t_BOfficeKind and t_DocID = tick.t_DealID and t_DealPart = 2 and t_Type = 8 and rownum < 2 " +
                    " ) DeliveryDate2 " +
               " FROM V_SCWRTHISTEX v, ddl_tick_dbt tick, dfininstr_dbt fi " +
              " WHERE v.t_ChangeDate <= ? " +
                " AND v.T_PORTFOLIO = " + KINDPORT_CURR_AC_PVO +
                " AND v.t_Kind = " + PM_WRTSUM_KIND_RCURR +
                " AND tick.t_ClientID = -1 " +
                " AND RSB_SECUR.IsREPO(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes (tick.t_DealType, tick.t_BofficeKind))) = 1 " +
                " AND decode(v.t_instance, (SELECT MAX(v2.t_Instance) " +
                                            " FROM V_SCWRTHISTEX v2 " +
                                           " WHERE v2.t_SumID = v.t_SumID " +
                                             " AND v2.t_ChangeDate <= ?), 1, 0) = 1 " +
                " AND tick.t_DealID = v.t_DealID " +
                " AND fi.t_FIID = tick.t_PFI " +
                " AND fi.t_Issuer != " + {OurBank} +
                " AND tick.t_DealStatus = " + DL_READIED +
              " ORDER BY Party_Issuer ";
   end;

   private macro PrintREPO()
      var header = "", Current = 0, cmd;
      var startTime = Time();

      cmd = DL_RSDCommand(GetSQLREPO());
      cmd.addParam(m_RepParm.EndDate);
      cmd.addParam(m_RepParm.EndDate);

      header = "Обработка и печать данных отчета (обратные РЕПО)";
      m_ProgressIndicator.Start(-1, header, header);

      m_RS = cmd.execute();
      while( m_RS.MoveNext() )
         CollectDataSecur();
         PrintData();
         m_RecNo = m_RecNo + 1;
         Current = Current + 1;
         m_ProgressIndicator.Update(Current,Current);
      end;

      m_ProgressIndicator.Stop();
      m_IsDataExist = Current > 0;

      logTime("dlcalcor_report. PrintREPO finished. rows: " + Current, Time()-startTime);
   end;

   private macro GetComissRestMMARK(ObjID, ObjN, _CatCode, _Date, _FIID, _Chapter)
    var FirstDoc = MMFirstDoc(ObjID, ObjN, true);
    
    var Sum = $0, query, RsbData;
    query = "select * from ddlcomis_dbt " +
                          "where t_dockind = " + FirstDoc.GetTick().BOfficeKind + 
                          " and t_docid = " + FirstDoc.GetTick().DealID;
    RsbData = TRsbDataSet(query);
    while (RsbData.MoveNext)
        Sum = Sum + FirstDoc.GetRestAccount(_CatCode, _Date, _FIID, _Chapter, 10000 + RsbData.ID, false);
    end;
    return Sum;
   end;


   Private MACRO MM_acc(_CatCode, _DealID, _Date)
     private var que, cmd, rs, rez="";

     que = "select t_account account from dmcaccdoc_dbt " +
	       "where t_dockind = 102 and t_catid = (select t_id from dmccateg_dbt where t_code = ?) " +
		   " and T_ACTIVATEDATE <= ? AND (T_DISABLINGDATE > ? OR T_DISABLINGDATE = to_date('01.01.0001', 'dd.mm.yyyy')) and t_docid = ?";
     cmd = DL_RSDCommand(que);
	 cmd.addParam(_CatCode);
	 cmd.addParam(_Date);
	 cmd.addParam(_Date);
	 cmd.addParam(_DealID);
	 rs = cmd.execute();
     if (rs.moveNext) 
        rez = rs.account;
     end;
     return rez;
   END;

   private macro GetRestMMARK_USR(FirstDoc, _CatCode, _Date, IsNATCUR, _Chapter, Convert, IsComis)
    Var StrAccount = "";
    if (ValType(IsComis) == V_UNDEF)
        IsComis = false;
    end;
    if (ValType(Convert) == V_UNDEF)
        Convert = false;
    end;
    var Sum = $0, TempSum = $0, doc_pd, FIID = -1, query, RsbData;
    if (FirstDoc.GetTick().BOfficeKind == DL_CREDITLN) 
      query = "select tick.t_bofficekind, tick.t_dealid, leg.t_pfi from ddl_tick_dbt tick" +
                         " inner join ddl_leg_dbt leg on leg.t_dealid = tick.t_dealid "
                         " where tick.t_parentid = " + FirstDoc.GetTick().DealID +
                           " and tick.t_dealstatus = " + DL_READIED +
                           " and leg.t_legkind = 0 and leg.t_legid = 1";
      RsbData = TRsbDataSet(query);
      while (RsbData.MoveNext)
         doc_pd = MMFirstDoc(DL_IBCDOC, RsbData.DealID, true);
         if (IsNATCUR)
           FIID = NATCUR;
         else
           FIID = RsbData.PFI;
         end;
         if (not IsComis)
           TempSum = doc_pd.GetRestAccount(_CatCode, _Date, FIID, _Chapter, NULL, false);       
         else
           TempSum = GetComissRestMMARK(RsbData.BOfficeKind, RsbData.DealID, _CatCode, _Date, FIID, _Chapter);
         end;
         if ((FIID != NATCUR) AND Convert)
            SmartConvertSum(TempSum, TempSum, _Date, FIID, NATCUR, true);
         end;
         Sum = Sum + TempSum;
      end;
    else
        if (not IsNATCUR)
          FIID = NATCUR;
        else
          FIID = FirstDoc.GetLeg().PFI;
        end;
        if (not IsComis)
          StrAccount = MM_acc(_CatCode, FirstDoc.GetTick().DealID, _Date);
            Sum = abs(RestAC(StrAccount, FIID, _Date, NULL, 1 ));
//          Sum = FirstDoc.GetRestAccount(_CatCode, _Date, FIID, _Chapter, NULL, false);
        else
          Sum = GetComissRestMMARK(FirstDoc.GetTick().BOfficeKind, FirstDoc.GetTick().DealID, _CatCode, _Date, FIID, _Chapter);
        end;
        if ((FIID != NATCUR) AND Convert)
            SmartConvertSum(Sum, Sum, _Date, FIID, NATCUR, true);
        end;
    end;
    return Sum; 
   end;


   private macro GetRestMMARK(FirstDoc, _CatCode, _Date, IsNATCUR, _Chapter, Convert, IsComis)
    if (ValType(IsComis) == V_UNDEF)
        IsComis = false;
    end;
    if (ValType(Convert) == V_UNDEF)
        Convert = false;
    end;
    var Sum = $0, TempSum = $0, doc_pd, FIID = -1, query, RsbData;
    if (FirstDoc.GetTick().BOfficeKind == DL_CREDITLN) 
      query = "select tick.t_bofficekind, tick.t_dealid, leg.t_pfi from ddl_tick_dbt tick" +
                         " inner join ddl_leg_dbt leg on leg.t_dealid = tick.t_dealid "
                         " where tick.t_parentid = " + FirstDoc.GetTick().DealID +
                           " and tick.t_dealstatus = " + DL_READIED +
                           " and leg.t_legkind = 0 and leg.t_legid = 1";
      RsbData = TRsbDataSet(query);
      while (RsbData.MoveNext)
         doc_pd = MMFirstDoc(DL_IBCDOC, RsbData.DealID, true);
         if (IsNATCUR)
           FIID = NATCUR;
         else
           FIID = RsbData.PFI;
         end;
         if (not IsComis)
           TempSum = doc_pd.GetRestAccount(_CatCode, _Date, FIID, _Chapter, NULL, false);       
         else
           TempSum = GetComissRestMMARK(RsbData.BOfficeKind, RsbData.DealID, _CatCode, _Date, FIID, _Chapter);
         end;
         if ((FIID != NATCUR) AND Convert)
            SmartConvertSum(TempSum, TempSum, _Date, FIID, NATCUR, true);
         end;
         Sum = Sum + TempSum;
      end;
    else
        if (not IsNATCUR)
          FIID = NATCUR;
        else
          FIID = FirstDoc.GetLeg().PFI;
        end;
        if (not IsComis)
          Sum = FirstDoc.GetRestAccount(_CatCode, _Date, FIID, _Chapter, NULL, false);
        else
          Sum = GetComissRestMMARK(FirstDoc.GetTick().BOfficeKind, FirstDoc.GetTick().DealID, _CatCode, _Date, FIID, _Chapter);
        end;
        if ((FIID != NATCUR) AND Convert)
            SmartConvertSum(Sum, Sum, _Date, FIID, NATCUR, true);
        end;
    end;
    return Sum; 
   end;

   private macro CollectDataMMARK()
      m_RecData.Clear();

      var innNotKPP, delayDays, Numb,
          party = TRecHandler("party.dbt");

      //m_FD = SPFirstDoc(LEG_KIND_DL_TICK, Int(m_Rs.DealID));
      m_FD = MMFirstDoc(Int(m_Rs.BOfficeKind), Int(m_Rs.DealID), true);

      m_RecData.A01 = m_RecNo+1;
      m_RecData.A02 = {OperDprt};

      if(ПолучитьСубъекта(Int(m_Rs.party_issuer), party) == 0)
         m_RecData.A03 = GetINN(party.rec.PartyID, IIF(party.rec.NotResident == UNSET_CHAR, PTCK_INN, PTCK_FOREIGN_INN));
         if(m_RecData.A03 == "")
            m_RecData.A03 = ПолучитьКодСубъекта(party.rec.PartyID, PTCK_LEI);
         end;
         m_RecData.A04 = ПолучитьКодСубъекта(party.rec.PartyID, PTCK_CONTR);
         m_RecData.A05 = SQL_ConvTypeStr(party.rec.ShortName);

//         DL_GetObjAttrName(OBJTYPE_PARTY, 19, DL_GetMainObjAttr( party, 19, OBJTYPE_PARTY ), null, @m_RecData.A57, null, @m_RecData.A58);
         get_subject_rating(party.rec.PartyID, m_RepParm.EndDate, null, m_RecData.A57, null, m_RecData.A58, Numb);
//         m_RecData.A54 = GetPartyOwn(party);
	 m_RecData.A54 = get_subject_type(party.rec.partyid);
      end;

      m_RecData.A06 = SQL_ConvTypeStr(m_Rs.ID_ISIN);
      m_RecData.A07 = SQL_ConvTypeDate(m_Rs.DealDate);

      var MainRest = $0;
      MainRest = GetRestMMARK_USR(m_FD, tdr_mainrest, m_RepParm.EndDate, m_FD.GetLeg().PFI, 1, true) +
                 GetRestMMARK_USR(m_FD, tdr_odmainrest, m_RepParm.EndDate, m_FD.GetLeg().PFI, 1, true) +
                 GetRestMMARK_USR(m_FD, tdr_exprestR, m_RepParm.EndDate , m_FD.GetLeg().PFI, 1, true) +
                 GetRestMMARK(m_FD, tdr_rights, m_RepParm.EndDate , m_FD.GetLeg().PFI, 1, true);
      m_RecData.A08 = SQL_ConvTypeSum(MainRest);

      var PersRest = $0;
      PersRest = GetRestMMARK_USR(m_FD, tdr_claimR, m_RepParm.EndDate , m_FD.GetLeg().PFI, 1, true) +
                 GetRestMMARK_USR(m_FD, tdr_exppercR, m_RepParm.EndDate, m_FD.GetLeg().PFI, 1, true);
      m_RecData.A09 = SQL_ConvTypeSum(PersRest);

      var Outlay = $0;
      Outlay = (GetRestMMARK(m_FD, tdr_inccalcs, m_RepParm.EndDate, m_FD.GetLeg().PFI, 1, true, true) +
               GetRestMMARK(m_FD, tdr_inccalcs_cm, m_RepParm.EndDate, NATCUR, 1, true, true) +
               GetRestMMARK(m_FD, tdr_pccomreq, m_RepParm.EndDate, m_FD.GetLeg().PFI, 1, true, true)) - 
               (GetRestMMARK(m_FD, tdr_othinc, m_RepParm.EndDate, m_FD.GetLeg().PFI, 1, true, true) +
               GetRestMMARK(m_FD, tdr_othinc_cm, m_RepParm.EndDate, NATCUR, 1, true, false));
      m_RecData.A11 = SQL_ConvTypeSum(Outlay);

      var Corrinttoeir = $0;
      Corrinttoeir = GetRestMMARK(m_FD, tdr_adjplR, m_RepParm.EndDate, NATCUR, 1) +
                     GetRestMMARK(m_FD, tdr_adjplP, m_RepParm.EndDate, NATCUR, 1) +
                     GetRestMMARK(m_FD, tdr_adjcmR, m_RepParm.EndDate, NATCUR, 1) +
                     GetRestMMARK(m_FD, tdr_adjcmP, m_RepParm.EndDate, NATCUR, 1);
      m_RecData.A15 = SQL_ConvTypeSum(Corrinttoeir);

      if (m_FD.GetTick().BOfficeKind == DL_CREDITLN)
         m_RecData.A16 = m_FD.GetRestAccount(tdr_oblP, m_RepParm.EndDate, m_FD.GetTick().LimitCur, 3);
      else
         m_RecData.A16 = $0;
      end;
      m_RecData.A17 = SQL_ConvTypeStr(m_Rs.CCY);

      var RsrvMainrest = $0;
      RsrvMainrest = GetRestMMARK(m_FD, tdr_rez_mainrest, m_RepParm.EndDate, NATCUR, 1) +
                   GetRestMMARK(m_FD, tdr_rmainrest_cm, m_RepParm.EndDate, NATCUR, 1) +
                   GetRestMMARK(m_FD, tdr_rez_exprest,  m_RepParm.EndDate, NATCUR, 1);
      m_RecData.A18 = RsrvMainrest;

      var RsrvPercent = $0;
      RsrvPercent = GetRestMMARK(m_FD, tdr_rez_perc, m_RepParm.EndDate, NATCUR, 1) +
                    GetRestMMARK(m_FD, tdr_rez_expperc, m_RepParm.EndDate, NATCUR, 1);
      m_RecData.A19 = RsrvPercent;

      var RsrvComis = $0;
      RsrvComis = GetRestMMARK(m_FD, tdr_rezcom,      m_RepParm.EndDate, NATCUR, 1, true, true) +
                  GetRestMMARK(m_FD, tdr_rezexppccom, m_RepParm.EndDate, NATCUR, 1, true, true);
      m_RecData.A21 = RsrvComis;

      if (m_FD.GetTick().BOfficeKind == DL_CREDITLN)
         m_RecData.A24 = m_FD.GetRestAccount(tdr_rezerve9, m_RepParm.EndDate, NATCUR, 1);
      else
         m_RecData.A24 = $0;
      end;

      m_RecData.A25 = GetQualityCategory(m_FD.GetTick().DealID, m_RepParm.EndDate);
      m_RecData.A26 = GetRsrvPercent(m_FD.GetTick().DealID, m_RepParm.EndDate);

      if (m_FD.GetTick().BOfficeKind == DL_CREDITLN)
         var DataSet = TRsbDataSet("select t_dealid from ddl_tick_dbt where t_parentid = " + m_FD.GetTick().DealID +
                                   " and t_dealstatus = " + DL_READIED);
         if(DataSet.MoveNext) 
            m_RecData.A27 = GetPercLoss(DataSet.DealID, m_RepParm.EndDate);
         end;
         m_RecData.A28 = GetPercLoss(m_FD.GetTick().DealID, m_RepParm.EndDate);
      else
         m_RecData.A27 = GetPercLoss(m_FD.GetTick().DealID, m_RepParm.EndDate);
      end;

      /*KD*/
        m_RecData.A61 = m_RecData.A18+m_RecData.A19+m_RecData.A21+m_RecData.A24;

      var ExpRest = $0;
      ExpRest = GetRestMMARK(m_FD, tdr_exprestR, m_RepParm.EndDate, m_FD.GetLeg().PFI, 1) +
                GetRestMMARK(m_FD, tdr_exppercR, m_RepParm.EndDate, m_FD.GetLeg().PFI, 1);
      if (ExpRest == 0)
         m_RecData.A32 = 0;
      else
         DataSet = TRsbDataSet("select min(t_restdate) as t_rdate from drestdate_dbt rest" + 
                                   " inner join daccount_dbt acc on rest.t_accountid = acc.t_accountid " +
                                   " inner join dmcaccdoc_dbt adoc on acc.t_account = adoc.t_account " +
                                   " inner join dmccateg_dbt cat on adoc.t_catid = cat.t_id " +
                                   "where cat.t_code in ('Треб. с н.с.','+% с н.с.') " +
                                     " and adoc.t_dockind = " + m_FD.GetTick().BOfficeKind + " and t_docid = " + m_FD.GetTick().DealID);
         if(DataSet.MoveNext) 
            m_RecData.A32 = 0;
            var allDays = m_RepParm.EndDate - Date(DataSet.RDate);
            while (allDays)
               if (IsWorkday(Date(DataSet.RDate) + allDays))
                  m_RecData.A32 = m_RecData.A32 + 1;
               end;
               allDays = allDays - 1;
            end;
         end;

      end;
      m_RecData.A53 = OBJECTTYPE_MMARK;

      if( (ValType(m_RecData.A27) != V_UNDEF) and (m_RecData.A27 > 0.) )
         var A27 = m_RecData.A27 / 100.;

         m_RecData.A34 = m_RecData.A08 * A27;
         m_RecData.A35 = m_RecData.A09 * A27;
         m_RecData.A37 = m_RecData.A11 * A27;
         m_RecData.A40 = m_RecData.A15 * A27;
         m_RecData.A41 = m_RecData.A16 * A27;
         m_RecData.A48 = m_RecData.A40;
      end;

      if( /*(ValType(m_RecData.A26) != V_UNDEF) and (m_RecData.A26 != "") and (m_RecData.A26 > 0.) and*/
          (ValType(m_RecData.A27) != V_UNDEF) and (m_RecData.A27 > 0.) )
         m_RecData.A42 = m_RecData.A34 - m_RecData.A18;
         m_RecData.A43 = m_RecData.A35 - m_RecData.A19;
         m_RecData.A45 = m_RecData.A37 - m_RecData.A21;
         m_RecData.A49 = m_RecData.A41 - m_RecData.A24;
         
         m_RecData.A50 = m_RecData.A42 + m_RecData.A43 + m_RecData.A45 + m_RecData.A48 + m_RecData.A49;
      else
         m_RecData.A50 = $0;
      end;

      var AdjAmount = $0;
      AdjAmount = GetRestMMARK(m_FD, tdr_rezadjodR, m_RepParm.EndDate, NATCUR, 1) +
                  GetRestMMARK(m_FD, tdr_rezadjexpodR, m_RepParm.EndDate, NATCUR, 1) +
                  GetRestMMARK(m_FD, tdr_rezadjexpprcR, m_RepParm.EndDate, NATCUR, 1) + 
                  GetRestMMARK(m_FD, tdr_rezadjprcR, m_RepParm.EndDate, NATCUR, 1) +   
                  GetRestMMARK(m_FD, tdr_rezadjadjR, m_RepParm.EndDate, NATCUR, 1) +   
                  GetRestMMARK(m_FD, tdr_rezadjexpR, m_RepParm.EndDate, NATCUR, 1) +      
                  GetRestMMARK(m_FD, tdr_rezadjcomR, m_RepParm.EndDate, NATCUR, 1, true, true) +    
                  GetRestMMARK(m_FD, tdr_rezadjpccomR, m_RepParm.EndDate, NATCUR, 1, true, true) + 
                  //GetRestMMARK(m_FD, tdr_rezadjod_cmR, m_RepParm.EndDate, NATCUR, 1) +             /*SVE данная КУ не используетсяв и не подвязывается сделках МБК однако имеет тот же остаток что и КУ КОР, резерв ОД, что приводит к задвоениею*/
                  GetRestMMARK(m_FD, tdr_rezadjic_cmR, m_RepParm.EndDate, NATCUR, 1) +    
                  GetRestMMARK(m_FD, tdr_rezadjadj_cmR, m_RepParm.EndDate, NATCUR, 1) +     
                  GetRestMMARK(m_FD, tdr_rezadjexp_cmR, m_RepParm.EndDate, NATCUR, 1) +  
                  m_FD.GetRestAccount(tdr_rezadjlimR, m_RepParm.EndDate, NATCUR, 1);
      m_RecData.A51 = AdjAmount;
      m_RecData.A52 = m_RecData.A51 - m_RecData.A50;

      if (m_FD.GetTick().BOfficeKind == DL_CREDITLN)
         m_RecData.A55 = m_FD.GetLeg().Price;
      else
         m_RecData.A55 = m_FD.GetLeg().Price/pow(10, m_FD.GetLeg().Point);
      end;
      
      m_RecData.A56 = m_FD.GetLeg().Maturity;

      //Simanov
      m_RecData.A33 = getAttrValueName(103, string(m_FD.GetTick().DealID:o:34), ATTR_MBK_RECOVERY,   m_RepParm.EndDate); //признак выздоровления
      m_RecData.A30 = getAttrValueName(103, string(m_FD.GetTick().DealID:o:34), ATTR_MBK_STAGE,      m_RepParm.EndDate); //этап резервирования
      m_RecData.A29 = get_mmark_source(m_FD.GetTick().DealID, m_RepParm.EndDate); //источник
      m_RecData.A31 = getAttrValueName(103, string(m_FD.GetTick().DealID:o:34), ATTR_MBK_STAGE_SOFR, m_RepParm.EndDate); //этап резервирования (СОФР)
   end;

   private macro GetSQLMMARK()
   
      return " SELECT tick.t_DealID, " +
                    " tick.t_BOfficeKind, " +
                    " tick.t_DealDate, " +
                    " tick.t_PartyID Party_Issuer, " +
                    " tick.t_DealCode ID_ISIN, " +
                    " (SELECT t_CCY FROM dfininstr_dbt WHERE t_FIID = " +
                     " ( " +
                      " CASE WHEN tick.t_BOfficeKind = 102 THEN (SELECT t_PFI from ddl_leg_dbt WHERE t_dealid = tick.t_dealid AND t_legkind = 0 AND t_legid = 1) ELSE tick.t_LimitCur END " +
                    " )) CCY " +
               " FROM dmcaccdoc_dbt accdoc, ddl_tick_dbt tick, ddl_leg_dbt leg, dfininstr_dbt fi " +
              " WHERE MMARK_UTL.IsBUY (tick.t_DealGroup) = 0 " +
                " AND leg.t_DealID = tick.t_DealID and leg.t_LegID = 1 and leg.t_LegKind = 0 " +
                " AND fi.t_FIID = tick.t_PFI " +
                " AND tick.t_parentid <= 0 " +
/*                " AND (NVL ((SELECT MAX(step.t_Fact_Date) " +
                  " FROM doproper_dbt opr, doprstep_dbt step " +
                     "WHERE opr.t_DocKind IN (102, 208) " +
                       "AND opr.t_DocumentID = tick.t_DealID " +
                       "AND step.t_ID_Operation = opr.t_ID_Operation " +
                       "AND step.t_Symbol = 'О'), " +
                     "to_date('01.01.9999','DD.MM.YYYY'))) > ? " +
*/
                " and (tick.t_closedate = to_date('01.01.0001','DD.MM.YYYY') or tick.t_closedate> ?) " +
                " and accdoc.t_dockind = 102 and accdoc.t_docid = tick.t_dealid and accdoc.t_catnum = CASE WHEN EXISTS (SELECT 1 FROM DMCACCDOC_DBT WHERE T_dockind = 102 and t_docid = tick.t_dealid and t_catnum = 601 ) THEN 601 ELSE 700 END " +
                " and RSB_ACCOUNT.Restac(accdoc.t_account, accdoc.t_currency, ?, 1, 0)<>0 " +
                " AND tick.t_DealDate <= ? " +
                " AND ((tick.t_BOfficeKind = 102 and ( (select count(*) from doprdocs_dbt a, doproper_dbt b where a.t_id_operation=b.t_id_operation and a.t_dockind=102 and b.t_dockind=102 and b.t_DocumentID=lpad(tick.t_DealID,34,'0')) > 0  and  leg.t_MATURITY >= ? )  " +
                "       OR (select count(*) from doprdocs_dbt a, doproper_dbt b where a.t_id_operation=b.t_id_operation and a.t_dockind=102 and b.t_dockind=102 and b.t_DocumentID=lpad(tick.t_DealID,34,'0')) = 0 ) " +
                " OR (tick.t_BOfficeKind = 208 AND Exists " +
                " (SELECT 1 FROM ddl_tick_dbt WHERE t_parentid = tick.t_DealID AND t_dealstatus = 10)))" +
              " ORDER BY Party_Issuer ";
   end;

   private macro PrintMMARK()
   
      var header = "", NRecs = 0, Current = 0, cmd;

      cmd = DL_RSDCommand(GetSQLMMARK());
      cmd.addParam(m_RepParm.EndDate);
      cmd.addParam(m_RepParm.EndDate);
      cmd.addParam(m_RepParm.EndDate);
      cmd.addParam(m_RepParm.EndDate);

      NRecs = cmd.GetCount();
   
      if( NRecs > 0 )
         m_IsDataExist = true;
         header = "Обработка и печать данных отчета (МБК)";
         m_ProgressIndicator.Start(NRecs, header, header);

         m_RS = cmd.execute();
         while( m_RS.MoveNext() )
            CollectDataMMARK();
            PrintData();
            m_RecNo = m_RecNo + 1;
            Current = Current + 1;
            m_ProgressIndicator.Update(Current,NRecs);
         end;
         m_ProgressIndicator.Stop();
      end;
   end;

   private macro GetSQLBond()
      return " with fin_instr as ( \n " +
         "       select /*+ materialize \n " +
         "                  full(fi) \n " +
         "                  full(av) \n " +
         "              */ \n " +
         "              fi.t_issuer, \n " +
         "               nvl((select min(t_DrawingDate) \n " +
         "                 from dfiwarnts_dbt \n " +
         "                where t_FIID = fi.t_FIID \n " +
         "                  and "+IIF(CheckTaxDepositoryMode() == false, "t_SPIsClosed", "t_IsClosed")+" <> CHR(88) \n " +
         "              ),RSI_RSB_FIInstr.FI_GetNominalDrawingDate(fi.t_FIID, av.t_Termless) " +
         "              ) NearDrawingDate, \n " +
         "              RSI_RSB_FIInstr.FI_GetNominalDrawingDate(fi.t_FIID, av.t_Termless) DrawingDate, \n " +
         "              av.t_FloatingRate, \n " +
         "              fi.t_fiid, \n " +
         "              av.t_isin \n " +
         "         from dfininstr_dbt fi \n " +
         "         join davoiriss_dbt av on av.t_fiid = fi.t_fiid \n " +
         "        where fi.t_issuer != " + {OurBank} + "\n" +
         "          and rsi_rsb_fiinstr.fi_avrkindsgetrootbyfiid(fi.t_fiid) = 17 \n " +
         "       ) \n " +
         "       ,lots as ( \n " +
         "       select /*+ materialize */ \n " +
         "              s.t_sumid, \n " +
         "              s.t_instance, \n " +
         "              s.t_dealid, \n " +
         "              s.t_fiid, \n " +
         "              s.t_portfolio, \n " +
         "              fi.t_issuer, \n " +
         "              fi.t_isin, \n " +
         "              s.t_date, \n " +
         "              s.t_cost, \n " +
         "              s.t_begbonus, \n " +
         "              s.t_bonus, \n " +
         "              s.t_costpfi, \n " +
         "              s.t_interestincome, \n " +
         "              s.t_nkdamount, \n " +
         "              s.t_outlay, \n " +
         "              s.t_discountincome, \n " +
         "              s.t_overamount, \n " +
         "              s.t_corrinttoeir, \n " +
         "              s.t_currency, \n " +
         "              fi.NearDrawingDate, \n " +
         "              fi.DrawingDate, \n " +
         "              fi.t_floatingrate, \n " +
         "              s.t_changedate \n " +
         "         from fin_instr fi \n " +
         "         join dpmwrtsum_dbt s on s.t_fiid = fi.t_fiid \n " +
         "        where s.t_party = -1 \n " +
         "          and s.t_department = " + {OperDprt} + "\n" +
         "          and s.t_contract = 0 \n " +
         "          and s.t_amount > 0 \n " +
         "          and s.t_buy_sale = " + PM_WRITEOFF_SUM_BUY + "\n" +
         "          and s.t_portfolio in ("+KINDPORT_RETIRE+","+KINDPORT_PROMISSORY+","+KINDPORT_SALE+","+KINDPORT_CONTR+")" + "\n" +
         "          and s.t_state in ("+PM_WRTSUM_FORM+","+PM_WRTSUM_SALE_BPP+")" + "\n" +
         "          ) \n " +
         "       ,bc as ( \n " +
         "       select /*+ idx(bc RSHB_DPMWRTBC_DBT_IDX0 \n " +
         "                  materialize \n " +
         "              */ \n " +
         "              bc.t_sumid, \n " +
         "              bc.t_instance, \n " +
         "              l.t_dealid, \n " +
         "              bc.t_fiid, \n " +
         "              bc.t_portfolio, \n " +
         "              l.t_issuer, \n " +
         "              l.t_isin, \n " +
         "              bc.t_date, \n " +
         "              bc.t_cost, \n " +
         "              bc.t_begbonus, \n " +
         "              bc.t_bonus, \n " +
         "              bc.t_costpfi, \n " +
         "              bc.t_interestincome, \n " +
         "              bc.t_nkdamount, \n " +
         "              bc.t_outlay, \n " +
         "              bc.t_discountincome, \n " +
         "              bc.t_overamount, \n " +
         "              bc.t_corrinttoeir, \n " +
         "              bc.t_currency, \n " +
         "              l.NearDrawingDate, \n " +
         "              l.DrawingDate, \n " +
         "              l.t_floatingrate, \n " +
         "              bc.t_amount, \n " +
         "              bc.t_state \n " +
         "         from lots l \n " +
         "         join dpmwrtbc_dbt bc on bc.t_sumid = l.t_sumid \n " +
         "        where bc.t_changedate <= ? \n " +
         "          and bc.t_instance = (select max(v2.t_Instance) \n " +
         "                                from dpmwrtbc_dbt v2 \n " +
         "                               where v2.t_SumID = bc.t_SumID \n " +
         "                                 and v2.t_ChangeDate <= ?) \n " +
         "          and l.t_changedate > ? \n " +
         "         ) \n " +
         "        ,filtered_bc as ( \n " +
         "       select bc.t_sumid, \n " +
         "              bc.t_instance, \n " +
         "              bc.t_dealid, \n " +
         "              bc.t_fiid, \n " +
         "              bc.t_portfolio, \n " +
         "              bc.t_issuer, \n " +
         "              bc.t_isin, \n " +
         "              bc.t_date, \n " +
         "              bc.t_cost, \n " +
         "              bc.t_begbonus, \n " +
         "              bc.t_bonus, \n " +
         "              bc.t_costpfi, \n " +
         "              bc.t_interestincome, \n " +
         "              bc.t_nkdamount, \n " +
         "              bc.t_outlay, \n " +
         "              bc.t_discountincome, \n " +
         "              bc.t_overamount, \n " +
         "              bc.t_corrinttoeir, \n " +
         "              bc.t_currency, \n " +
         "              bc.NearDrawingDate, \n " +
         "              bc.DrawingDate, \n " +
         "              bc.t_floatingrate \n " +
         "         from bc \n " +
         "        where bc.t_portfolio in ("+KINDPORT_RETIRE+","+KINDPORT_PROMISSORY+","+KINDPORT_SALE+","+KINDPORT_CONTR+")" + "\n" +
         "          and bc.t_amount > 0 \n " +
         "          and bc.t_state in ("+PM_WRTSUM_FORM+","+PM_WRTSUM_SALE_BPP+")" + "\n" +
         "         ) \n " +
         "        ,filtered_lots as ( \n " +
         "       select l.t_sumid, \n " +
         "              l.t_instance, \n " +
         "              l.t_dealid, \n " +
         "              l.t_fiid, \n " +
         "              l.t_portfolio, \n " +
         "              l.t_issuer, \n " +
         "              l.t_isin, \n " +
         "              l.t_date, \n " +
         "              l.t_cost, \n " +
         "              l.t_begbonus, \n " +
         "              l.t_bonus, \n " +
         "              l.t_costpfi, \n " +
         "              l.t_interestincome, \n " +
         "              l.t_nkdamount, \n " +
         "              l.t_outlay, \n " +
         "              l.t_discountincome, \n " +
         "              l.t_overamount, \n " +
         "              l.t_corrinttoeir, \n " +
         "              l.t_currency, \n " +
         "              l.NearDrawingDate, \n " +
         "              l.DrawingDate, \n " +
         "              l.t_floatingrate \n " +
         "         from lots l \n " +
         "        where t_changedate <= ? \n " +
         "          ) \n " +
         "        ,all_lots as ( \n " +
         "       select --+ materialize \n " +
         "              * \n " +
         "         from (select * from filtered_lots \n " +
         "               union all \n " +
         "               select * from filtered_bc) \n " +
         "        ) \n " +
         "       ,all_actual_lots as ( \n " +
         "        select * \n " +
         "          from all_lots l \n " +
         "         where l.t_instance = (select max(l2.t_Instance) \n " +
         "                                 from all_lots l2 \n " +
         "                                where l2.t_SumID = l.t_SumID) \n " +
         "        ) \n " +
         "     select 0 isRepo, \n " +
         "            l.t_dealid, \n " +
         "            l.t_fiid, \n " +
         "            l.t_portfolio, \n " +
         "            l.t_issuer as party_issuer, \n " +
         "            l.t_isin as id_isin, \n " +
         "            l.t_date, \n " +
         "            l.t_cost - (l.t_begbonus - l.t_bonus) + l.t_costpfi as amount_debt_OD, \n " +
         "            l.t_interestincome as amount_debt_perc, \n " +
         "            l.t_nkdamount, \n " +
         "            l.t_outlay, \n " +
         "            l.t_begbonus - l.t_bonus as Bonus_debt, \n " +
         "            l.t_discountincome, \n " +
         "            l.t_overamount, \n " +
         "            l.t_corrinttoeir, \n " +
         "            (select t_ccy from dfininstr_dbt where t_fiid = l.t_currency) as ccy, \n " +
         "            l.NearDrawingDate, \n " +
         "            l.DrawingDate, \n " +
         "            l.t_floatingrate \n " +
         "       from all_actual_lots l \n " +
         "      order by l.t_fiid, l.t_portfolio, l.t_issuer \n ";
   end;

   private macro PrintBond()
      var header = "", Current = 0, cmd;
      var startTime = Time();

      cmd = DL_RSDCommand(GetSQLBond());
      cmd.addParam(m_RepParm.EndDate);
      cmd.addParam(m_RepParm.EndDate);
      cmd.addParam(m_RepParm.EndDate);
      cmd.addParam(m_RepParm.EndDate);

      header = "Обработка и печать данных отчета (покупки облигаций)";
      m_ProgressIndicator.Start(-1, header, header);

      m_RS = cmd.execute();
      while( m_RS.MoveNext() )
         if(((m_prevFIID != -1) and (m_prevFIID != Int(m_Rs.FIID))) or
            ((m_prevPortf != -1) and (m_prevPortf != Int(m_Rs.Portfolio))))
            PrintPortfolio();
         end;
         CollectDataSecur();
         PrintData();
         m_prevFIID = Int(m_Rs.FIID);
         m_prevPortf =Int(m_Rs.Portfolio);
         m_RecNo = m_RecNo + 1;
         Current = Current + 1;
         m_ProgressIndicator.Update(Current,Current);
      end;
      PrintPortfolio();
      m_ProgressIndicator.Stop();

      m_IsDataExist = Current > 0;
      
      logTime("dlcalcor_report. PrintBond finished. rows: " + Current, Time()-startTime);
   end;

   private macro GetVAAccRest(CategName,Curency,Role,RestDate,sumRest:@numeric)
      var old_flag = SetDialogFlag(0);
      var account, sumBuf = $0;

      if(VA_GetAccountManual(CategName, m_FD, account, MC_OPENACC_CHECKEXIST, Curency, Role, null, RestDate))
         if (not VA_GetAccountRest(sumBuf, account, Curency, RestDate))
            sumBuf = $0;
         end;
         sumRest = sumBuf + sumRest;
      end;
      SetDialogFlag(old_flag);
   end;

   private macro CollectDataVA()
      m_RecData.Clear();

      var bonus = $0,
          costNATCUR,
          delayDays = 0,
          cbpercent = $0,
          pddpercent = $0,
          sumRest = $0,
          party = TRecHandler("party.dbt"),
          partyF  = TBfile("party.dbt", "R", 0),
          ficert = TRecHandler("ficert.dbt");
      var Numb;

      m_RecData.A01 = m_RecNo+1;
      m_RecData.A02 = {OperDprt};

      m_FD = VSBannerFD (DL_VSBANNER, m_Rs.BCID, DL_VARESERVE, VARES_SUBKIND_OR);

      if(ПолучитьСубъекта(Int(m_Rs.issuer), party) == 0)
         m_RecData.A03 = GetINN(party.rec.PartyID, IIF(party.rec.NotResident == UNSET_CHAR, PTCK_INN, PTCK_FOREIGN_INN));
         if(m_RecData.A03 == "")
            m_RecData.A03 = ПолучитьКодСубъекта(party.rec.PartyID, PTCK_LEI);
         end;
         m_RecData.A04 = ПолучитьКодСубъекта(party.rec.PartyID, PTCK_CONTR);
         m_RecData.A05 = SQL_ConvTypeStr(party.rec.ShortName);

 //        DL_GetObjAttrName(OBJTYPE_PARTY, 19, DL_GetMainObjAttr( party, 19, OBJTYPE_PARTY ), null, @m_RecData.A57, null, @m_RecData.A58);
	 get_subject_rating(party.rec.PartyID, m_RepParm.EndDate, null, m_RecData.A57, null, m_RecData.A58, Numb);
//         m_RecData.A54 = GetPartyOwn(party);
	 m_RecData.A54 = get_subject_type(party.rec.partyid);
      end;

      m_RecData.A06 = "сер. " + m_Rs.BCSeries + " № " + trim(m_Rs.BCNUmber);
      m_RecData.A07 = SQL_ConvTypeDate(m_Rs.FirstDate);
      m_RecData.A13 = SQL_ConvTypeSum(m_Rs.Disc);
      m_RecData.A08 = БалансоваяСтоимостьВекселяВН(m_Rs.BCID, m_RepParm.EndDate) + m_RecData.A13;
      m_RecData.A09 = SQL_ConvTypeSum(m_Rs.PERC);

      delayDays = GetWorkDayCount(SQL_ConvTypeDate(m_Rs.PlanRepayDate), m_RepParm.EndDate);
      m_RecData.A32 = IIF(delayDays > 0, delayDays, 0);

      SmartConvertSum(costNATCUR, m_Rs.BCCOST, m_RepParm.EndDate, m_Rs.BCCFI, NATCUR, true);
      SmartConvertSum(m_RecData.A08, m_RecData.A08, m_RepParm.EndDate, m_Rs.PFI, NATCUR, true);
      SmartConvertSum(m_RecData.A09, m_RecData.A09, m_RepParm.EndDate, m_Rs.PFI, NATCUR, true);

      if (costNATCUR > m_RecData.A08)
        bonus = costNATCUR - m_RecData.A08;
      end;

      m_RecData.A12 = SQL_ConvTypeSum(bonus);
      m_RecData.A15 = SQL_ConvTypeSum(m_Rs.EIR);
      SmartConvertSum(m_RecData.A13, m_RecData.A13, m_RepParm.EndDate, m_Rs.PFI, NATCUR, true);
      SmartConvertSum(m_RecData.A15, m_RecData.A15, m_RepParm.EndDate, m_Rs.PFI, NATCUR, true);
      m_RecData.A17 = SQL_ConvTypeStr(m_Rs.CCY);

      cbpercent = SQL_ConvTypeSum(m_Rs.CBRESERVEPERCENT) / 100;
      pddpercent = SQL_ConvTypeSum(m_Rs.PDDRESERVEPERCENT) / 100;

      m_RecData.A18 = m_RecData.A08 * cbpercent;
      m_RecData.A19 = m_RecData.A09 * pddpercent;
      m_RecData.A22 = m_RecData.A12 * cbpercent;
      m_RecData.A23 = m_RecData.A13 * pddpercent;
      m_RecData.A25 = SQL_ConvTypeSum(m_Rs.CBQUALITYCATEGORY);
      m_RecData.A26 = SQL_ConvTypeSum(m_Rs.CBRESERVEPERCENT);

      /*KD*/
        m_RecData.A61 = m_RecData.A18+m_RecData.A19+m_RecData.A22+m_RecData.A23;

      var DataSet = TRsbDataSet(" SELECT ficert.* FROM dficert_dbt ficert, dvsbanner_dbt bnr, dfininstr_dbt fin "+
                                 " WHERE  bnr.t_BCID = " + String(m_Rs.BCID) +
                                 "   and fin.t_FIID = bnr.t_FIID" +
                                 "   and ficert.t_CertID = bnr.t_BCID" +
                                 "   and ficert.t_AvoirKind = fin.t_AvoirKind");
      if (DataSet.moveNext())
         DataSet.GetRecord().CopyTO(ficert.rec);
      end;

      m_RecData.A27 = readNoteForObject( OBJTYPE_FICERT,  UniID( ficert, OBJTYPE_FICERT), FICERT_NOTE_KIND_PERC_RESERV, m_RepParm.EndDate );
      if ((m_RecData.A27 == NULL) OR (m_RecData.A27 <= $0))
         partyF.rec.PartyID = m_Rs.issuer;
         if (partyF.GetEQ())
            m_RecData.A27 = readNoteForObject( OBJTYPE_PARTY,  UniID( party, OBJTYPE_PARTY), PARTY_NOTE_KIND_SUBORD_PERC_RESERV, m_RepParm.EndDate );
         end;
      end;

      //Simanov
      m_RecData.A33 = getAttrValueName(OBJTYPE_FICERT, UniID( ficert, OBJTYPE_FICERT), ATTR_SECDEAL_RECOVERY,  m_RepParm.EndDate); //признак выздоровления
      m_RecData.A30 = getAttrValueName(OBJTYPE_FICERT, UniID( ficert, OBJTYPE_FICERT), ATTR_FICERT_STAGE,      m_RepParm.EndDate); //этап резервирования
      m_RecData.A29 = getAttrValueName(OBJTYPE_FICERT, UniID( ficert, OBJTYPE_FICERT), ATTR_FICERT_SOURCE,     m_RepParm.EndDate); //источник
      m_RecData.A31 = getAttrValueName(OBJTYPE_FICERT, UniID( ficert, OBJTYPE_FICERT), ATTR_FICERT_STAGE_SOFR, m_RepParm.EndDate); //этап резервирования (СОФР)

      m_RecData.A34 = m_RecData.A08 * (m_RecData.A27 / 100);
      m_RecData.A35 = m_RecData.A09 * (m_RecData.A27 / 100);
      m_RecData.A38 = m_RecData.A12 * (m_RecData.A27 / 100);
      m_RecData.A39 = m_RecData.A13 * (m_RecData.A27 / 100);
      m_RecData.A40 = m_RecData.A15 * (m_RecData.A27 / 100);

      m_RecData.A42 = m_RecData.A34 - m_RecData.A18;
      m_RecData.A43 = m_RecData.A35 - m_RecData.A19;
      m_RecData.A46 = m_RecData.A38 - m_RecData.A22;
      m_RecData.A47 = m_RecData.A39 - m_RecData.A23;

/*KD*/
      m_RecData.A48 = m_RecData.A40;
      m_RecData.A50 = numeric(m_RecData.A42) + numeric(m_RecData.A43) + numeric(m_RecData.A44) + numeric(m_RecData.A45) + numeric(m_RecData.A46) + numeric(m_RecData.A47) + numeric(m_RecData.A48);

      GetVAAccRest("-Кор_Резерв, вексель", NATCUR,FIROLE_FIDOC, m_RepParm.EndDate, @sumRest);
      GetVAAccRest("+Кор_Резерв, вексель", NATCUR,FIROLE_FIDOC, m_RepParm.EndDate, @sumRest);
      GetVAAccRest("+Кор_РезервПроср, вексель", NATCUR,FIROLE_FIDOC, m_RepParm.EndDate, @sumRest);
      GetVAAccRest("-Кор_РезервПроср, вексель", NATCUR,FIROLE_FIDOC, m_RepParm.EndDate, @sumRest);
      m_RecData.A51 = sumRest;

      m_RecData.A52 = m_RecData.A51 - m_RecData.A50;

      m_RecData.A53 = OBJECTTYPE_BANKWECHSEL;

      m_RecData.A55 = m_Rs.PrcVal;

      m_RecData.A56 = DL_GetBnrPlanRepayDate(m_FD.GetBnr(), m_FD.GetLeg());

   end;

   private macro GetSQLVA()
      return
         "   SELECT MainQuery.*,"
        +"          rsb_bill.GetBNRFirstDate (MainQuery.t_bcid, MainQuery.t_dealid)"
        +"             AS t_FirstDate,"
        +"          lnk.t_BCCost,"
        +"          lnk.t_BCCFI,"
        +"          rsb_bill.GetBnrNOPlanRepayDate (MainQuery.t_LegId) as t_PlanRepayDate,"
        +"          (SELECT NVL (SUM (t_Perc), 0)"
        +"             FROM dvsincome_dbt"
        +"            WHERE     t_BCID = MainQuery.t_bcid"
        +"                  AND t_IncomeType = 5"
        +"                  AND t_Enrolment_ID = MainQuery.t_EnrolID"
        +"                  AND t_EndDate <= ?)"
        +"             AS t_EIR,"
        +"          (SELECT NVL (SUM (t_Perc), 0)"
        +"             FROM dvsincome_dbt"
        +"            WHERE     t_BCID = MainQuery.t_bcid"
        +"                  AND t_IncomeType IN (0, 1)"
        +"                  AND t_Enrolment_ID = MainQuery.t_EnrolID"
        +"                  AND t_EndDate <= ?)"
        +"             AS t_Perc,"
        +"          (SELECT NVL (SUM (t_Disc), 0)"
        +"             FROM dvsincome_dbt"
        +"            WHERE     t_BCID = MainQuery.t_bcid"
        +"                  AND t_IncomeType IN (0, 1)"
        +"                  AND t_Enrolment_ID = MainQuery.t_EnrolID"
        +"                  AND t_EndDate <= ?)"
        +"             AS t_Disc,"
        +"          (SELECT t_CCY"
        +"             FROM dfininstr_dbt"
        +"            WHERE t_FIID = MainQuery.t_PFI)"
        +"             AS t_CCY,"
        +"          (SELECT T_PARTYID"
        +"             FROM DDL_TICK_DBT"
        +"            WHERE T_DEALID = MainQuery.T_dealId)"
        +"             AS t_Contr"
        +"     FROM (SELECT bnr.T_BCID,"
        +"                  bnr.T_ISSUER,"
        +"                  bnr.T_BCSeries,"
        +"                  bnr.t_BCNUmber,"
        +"                  RSB_BILL.GetVANODealId (bnr.T_BCID,"
        +"                                          ?)"
        +"                     AS T_dealId,"
        +"                  RSB_BILL.GetVABnrLastAccountedEnrolID ("
        +"                     bnr.T_BCID,"
        +"                     ?)"
        +"                     AS t_EnrolID,"
        +"                  RSB_BILL.GetVABnrStatusOnDate(bnr.T_BCID, ?) as t_Status,"
        +"                  legbnr.T_ID as t_LegId,"
        +"                  legbnr.t_PFI,"
        +"                  legbnr.T_PRINCIPAL,"
        +"                  legbnr.T_Price/power(10, legbnr.T_Point) as t_PrcVal, "
        +"                  lnkcb.T_QUALITYCATEGORY AS T_CBQUALITYCATEGORY,"
        +"                  NVL (lnkcb.T_RESERVEPERCENT, 0) AS T_CBRESERVEPERCENT,"
        +"                  lnkpdd.T_QUALITYCATEGORY AS T_PDDQUALITYCATEGORY,"
        +"                  NVL (lnkpdd.T_RESERVEPERCENT, 0) AS T_PDDRESERVEPERCENT"
        +"             FROM DVSBANNER_DBT bnr"
        +"                  INNER JOIN ddl_leg_dbt legbnr"
        +"                     ON legbnr.t_DealId = Bnr.t_bcid AND legbnr.t_LegKind = 1"
        +"                  LEFT JOIN ddp_dep_dbt dep ON dep.t_PartyID = bnr.T_ISSUER"
        +"                  LEFT JOIN"
        +"                  (  SELECT t_parentid,"
        +"                            t_QualityCategory,"
        +"                            t_ReservePercent,"
        +"                            RANK ()"
        +"                            OVER (PARTITION BY t_parentid"
        +"                                  ORDER BY t_lnkdate DESC, t_id DESC)"
        +"                               rnk"
        +"                       FROM ddlreslnk_dbt"
        +"                      WHERE     t_Type = 2"
        +"                            AND T_RESERVESUBKIND = 0"
        +"                            AND t_LnkDate <= ?"
        +"                   ORDER BY t_parentid) lnkcb"
        +"                     ON lnkcb.t_ParentID = bnr.t_BCID AND lnkcb.rnk = 1"
        +"                  LEFT JOIN"
        +"                  (  SELECT t_parentid,"
        +"                            t_QualityCategory,"
        +"                            t_ReservePercent,"
        +"                            RANK ()"
        +"                            OVER (PARTITION BY t_parentid"
        +"                                  ORDER BY t_lnkdate DESC, t_id DESC)"
        +"                               rnk"
        +"                       FROM ddlreslnk_dbt"
        +"                      WHERE     t_Type = 2"
        +"                            AND T_RESERVESUBKIND = 1"
        +"                            AND t_LnkDate <= ?"
        +"                   ORDER BY t_parentid) lnkpdd"
        +"                     ON lnkpdd.t_ParentID = bnr.t_BCID AND lnkpdd.rnk = 1"
        +"            WHERE dep.t_PartyID IS NULL) MainQuery,"
        +"          dvsordlnk_dbt lnk"
        +"    WHERE     LNK.T_CONTRACTID = MainQuery.t_dealid"
        +"          AND LNK.T_BCID = MainQuery.t_bcid"
        +"          AND MainQuery.t_dealid > 0"
        +"          AND MainQuery.t_Status = 100"
        +" ORDER BY MainQuery.T_ISSUER";
   end;

   private macro PrintVA()
      var header = "", NRecs = 0, Current = 0, cmd;

      cmd = DL_RSDCommand(GetSQLVA());
      cmd.addParam(m_RepParm.EndDate);
      cmd.addParam(m_RepParm.EndDate);
      cmd.addParam(m_RepParm.EndDate);
      cmd.addParam(m_RepParm.EndDate);
      cmd.addParam(m_RepParm.EndDate);
      cmd.addParam(m_RepParm.EndDate);
      cmd.addParam(m_RepParm.EndDate);
      cmd.addParam(m_RepParm.EndDate);
   
      NRecs = cmd.GetCount();
   
      if( NRecs > 0 )
         m_IsDataExist = true;
         header = "Обработка и печать данных отчета (Учтенные векселя)";
         m_ProgressIndicator.Start(NRecs, header, header);

         m_RS = cmd.execute();
         while( m_RS.MoveNext() )
            CollectDataVA();
            PrintData();
            m_RecNo = m_RecNo + 1;
            Current = Current + 1;
            m_ProgressIndicator.Update(Current,NRecs);
         end;
         m_ProgressIndicator.Stop();
      end;
   end;

   private macro PrintReport()
      Init_vars(); //Simanov
      if(m_RepParm.BySecur)
         PrintREPO();
         PrintBond();
      end;
      if (m_RepParm.ByBill)
         PrintVA();
      end;
      if (m_RepParm.ByMBK)
         PrintMMARK();
      end;
   end;

   private macro Create()
      BReport();
      PrintReport();
      EReport();
   end;

   /* Simanov
    * Отправить письмо с вложением
    * attach - путь к прикрепляемому файлу
    * вложение архивируется
    */
   macro Send(tittle:string, message:string, receiverGroupID:integer, attach:string)
      var email = c_email_proc_env();
      var arh_name = attach;
      var FileName, ExtName, DirName;
      VAR SpPath = "", SpFileName = "";
      //Отделяем путь файла от имени
      splitfile(attach, FileName, ExtName);
      FileName = FileName + ExtName;
      DirName = substr(attach, 1, index(attach, FileName) - 1);

      arh_name = StrSubst(arh_name,"$","");
      arh_name = StrSubst(arh_name, ExtName, ".7z");

      email.m_set_msg_head(tittle);
      email.m_add_row_to_msg_text(message);
      

      var arh = c_inarch_kit( arh_name, StrSubst(DirName,"$","") );
      arh.add_file_name(FileName);

      if (not (arh.Add_to_Archive("zip7")))
         msgbox("Ошибка архивирования файла " + FileName + " \n" + arh.get_state_message() + " \n" +
                     "Путь 7zip на терминале: " + arh.get_zip7_util_path_term() + "\n" +
                     "Путь 7zip на СП: " + arh.get_zip7_util_path_sp() + "\n" +
                     "Путь архивации: " + DirName + "\n" +
                     "Файл архива: " + arh_name);
         return;
      end;
//MsgBox(arh_name);
      SpPath = GetRepFullPath();
      SpFileName = SpPath + StrSubst(FileName, ExtName, ".7z");
      If ( not copyfile("$" + arh_name, SpFileName))
          SpFileName = arh_name;
      end;

      email.m_add_attach_to_list(SpFileName);
      email.m_save_to_submit_grp(receiverGroupID);
      email.m_submit_email_synch();
   End;


   initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode );
end;

// Функция формирования отчета "Расчет ОР и корректировок"
macro DL_CalcOR_Report(RepParm:CDLCalcORParm, DataFound:@bool)
   var report = CDLCalcORReport(null, "Report_dlcalcor.xls", true, false);
   var reportname = ""; //Simanov
   report.SetRepParm(RepParm);
   report.Run();

   DataFound = report.DataExist();

   Dl_CallInsertStat(report.PrintMode());
   if(report.GetFullReportFileNames().size > 0)
      reportname = report.GetFullReportFileNames()[0];
   end;

   report = null;

   //Simanov. Отправить отчёт по почте
   if (RepParm.ByEmail and (reportname != ""))
      CDLCalcORReport.Send("Отчёт о начисленых резервах СОФР на " + RepParm.EndDate, //tittle
                           "Данное сообщение отправлено автоматически.", //message
                           CALCOR_RECEIVER_GROUP_ID, //receiverGroupID
                           reportname //attach
                           );
   end;

   return reportname;
end;

private macro GetDLCalcORParm(formReport) : CDLCalcORParm
   var prm = CDLCalcORParm();

   prm.EndDate = formReport.GetFieldValue(PNFLD_DLCALCOR_ENDDATE);
   prm.BySecur = formReport.GetFieldValue(PNFLD_DLCALCOR_BYSECUR);
   prm.ByBill  = formReport.GetFieldValue(PNFLD_DLCALCOR_BYBILL);
   prm.ByMBK   = formReport.GetFieldValue(PNFLD_DLCALCOR_BYMBK);
   prm.ByEmail = formReport.GetFieldValue(PNFLD_DLCALCOR_BYEMAIL);
   //prm.IsShowReport = true;
   prm.IsShowReport = IIF(prm.ByEmail, false, true);

   return prm;
end;

MACRO ReportRunEx(
  IsWebService    : Bool
 ,FormData      //: CTxReportForm
 ,ReportHashCode  : Integer
 ,menuItem      //: WsMenuItem
)
   var stat = true;
   var formReport = CDLCalcOR_Panel();

   while( stat )
      stat = formReport.Run();
      if( stat )
         DL_CalcOR_Report(GetDLCalcORParm(formReport));
      end;
   end;
END;

