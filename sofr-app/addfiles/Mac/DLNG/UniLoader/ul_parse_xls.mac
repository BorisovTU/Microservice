/*
$Name: ul_parse_xls.mac
$Module: Универсальный загрузчик
$Description: Разбор xls-форматов и формирование массива промежуточных объектов
*/

IMPORT "UL_InputDataObj.mac", "or_exl_h.mac";

PRIVATE MACRO GetColumnSymb(_column)
  var
      iAlpha = 0,
      ConvertCol = "";

    while (_column > 0)
        iAlpha = Mod(_column, 26);
        if (iAlpha == 0)
            iAlpha = 26;
        end;
        ConvertCol = StrFor(64 + iAlpha) + ConvertCol;
        _column = Int((_column - iAlpha) / 26);
    end;

    return ConvertCol; 
END;

MACRO UL_Parse_XLS(_input_data, _loader)
  var
      retVal = TArray(),
      obj = NULL,
      TF = CDAOMSExcel(String(_input_data), true),
      adr = "", idxRow = 0, idxColumn = 0,
      RowCount = 0, ColumnCount = 0,
      CurrentRow = 0, CurrentColumn = 0;

    TF.SheetChange(_loader.formatConfig.List());
    adr = TF.Sheet.Range(_loader.formatConfig.CellAdr()).CurrentRegion.Address;

    RowCount = TF.Sheet.Range(adr).Cells(TF.Sheet.Range(adr).Cells.Count).Row -
               TF.Sheet.Range(_loader.formatConfig.CellAdr()).Row + 1;
    ColumnCount = TF.Sheet.Range(adr).Cells(TF.Sheet.Range(adr).Cells.Count).Column -
                  TF.Sheet.Range(_loader.formatConfig.CellAdr()).Column + 1;

    if ((RowCount > 0)and(ColumnCount > 0))
        while (idxRow < RowCount)
            obj = UL_InputDataObj_Base();
            CurrentRow = TF.Sheet.Range(_loader.formatConfig.CellAdr()).Row + CurrentRow;
            CurrentColumn = TF.Sheet.Range(_loader.formatConfig.CellAdr()).Column;
            idxColumn = 0;
            while (idxColumn < ColumnCount)
                obj.Add(GetColumnSymb(CurrentColumn), TF.Sheet.Cells(CurrentRow, CurrentColumn).text);

                CurrentColumn = CurrentColumn + 1;
                idxColumn = idxColumn + 1;
            end;

            retVal[retVal.size] = obj;

            CurrentRow = CurrentRow + 1;
            idxRow = idxRow + 1;
        end;
    end;

    TF.Close();

    return retVal;
END;
