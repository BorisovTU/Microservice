/*
$Name: ul_conv_bloomberg.mac
$Module: Универсальный загрузчик
$Description: Конвертер сделок Bloomberg
*/

IMPORT "ul_const.mac", "ul_conv_common.mac";

MACRO BLB_ConvertDate(retVal_, _input_value, _inputDataObj, _DataObj, _Log)
    if (ValType(_input_value) == V_UNDEF)
        retVal_ = NULL;
    else
        retVal_ = date(int(substr(_input_value, 7, 2)),
                       int(substr(_input_value, 5, 2)),
                       int(substr(_input_value, 1, 4)));
    end;

    SetParm(0, retVal_);
    return 0;
END;

MACRO BLB_ConvertTime(retVal_, _input_value, _inputDataObj, _DataObj, _Log)
    retVal_ = _input_value;
    if (strlen(_input_value) == 5)
        retVal_ = "0" + retVal_;
    end;
    retVal_ = time(int(substr(retVal_, 1, 2)),
                   int(substr(retVal_, 3, 2)),
                   int(substr(retVal_, 5, 2)));

    SetParm(0, retVal_);
    return 0;
END;

MACRO BLB_ConvertCurrency(retVal_, _input_value, _inputDataObj, _DataObj, _Log)
     IF ((_input_value==NULL) OR (_input_value==StrFor(1)) OR (_input_value==StrFor(0)) OR (TRIM(_input_value)==""))
         return 2;
     END;
    retVal_ = UL_GetRealIDObject(UL_CURRENCY, substr(_input_value, 1, 3), 3, _Log);
    SetParm(0, retVal_);
    return 0;
END;

MACRO BLB_ConvertDealTypeForex(retVal_, _input_value, _inputDataObj, _DataObj, _Log)
    if ((_inputDataObj.GetValue("Trade.Side")=="B") or (_inputDataObj.GetValue("Trade.Side")=="S"))
         if ((int(_input_value) == 2) or (int(_input_value) == 4) or (int(_input_value) == 128))
            SetParm(0, UL_FRX_OP);
            return 0;
         elif (int(_input_value) == 8)
            SetParm(0, UL_FRX_SWAP_OP);
    return 0;
         else
            return 2;
         end;
    else 
       return 2; 
    END;

END;

MACRO BLB_ConvertDealTypeIBC(retVal_, _input_value, _inputDataObj, _DataObj, _Log)
    if (int(_input_value) == 16)
         if (_inputDataObj.GetValue("Trade.Side")=="O")  
            SetParm(0, UL__IBCO_OP);
            return 0;
         elif (_inputDataObj.GetValue("Trade.Side")=="L")
            SetParm(0, UL__IBCL_OP);
    return 0;
         else
            return 2;
         end;
    else 
       return 2; 
    END;
END;

MACRO BLB_ConvertOriginID(retVal_, _input_value, _inputDataObj, _DataObj, _Log)
    SetParm(0, 0);
    return 0;
END;

MACRO BLB_ConvertPartyID(retVal_, _input_value, _inputDataObj, _DataObj, _Log)
   // retVal_  = UL_GetRealIDObject(UL_PARTY, _input_value, 1, _Log);
    SetParm(0, -1);//Временная заглушка
    return 0;
END;

MACRO BLB_ConvertTradeSystem(retVal_, _input_value, _inputDataObj, _DataObj, _Log)
    SetParm(0, 0);
    return 0;
END;

MACRO BLB_ConvertTraderID(retVal_, _input_value, _inputDataObj, _DataObj, _Log)
    SetParm(0, -1);
    return 0;
END;

MACRO BLB_ConvertTypeDocForex(retVal_, _input_value, _inputDataObj, _DataObj, _Log)
    if (_input_value == "B")
        retVal_ = _input_value;
    elif (_input_value == "S")
        retVal_ = _input_value;
    else
        return 2;
    end;

    SetParm(0, retVal_);
    return 0;
END;

MACRO BLB_ConvertTypeDocIBC(retVal_, _input_value, _inputDataObj, _DataObj, _Log)
    if (_input_value == "O")
        retVal_ = "D";
    elif (_input_value == "L")
        retVal_ = "L";
    else
        return 2;
    end;

    SetParm(0, retVal_);
    return 0;
END;

MACRO BLB_ConvertBasePI(retVal_, _input_value, _inputDataObj, _DataObj, _Log)
    SetParm(0, "");
    return 0;
END;

MACRO BLB_ConvertContrPI(retVal_, _input_value, _inputDataObj, _DataObj, _Log)
    SetParm(0, "");
    return 0;
END;

MACRO BLB_ConvertRevPartCost(retVal_, _input_value, _inputDataObj, _DataObj, _Log)
    retVal_ = Money(Money(_input_value) * Double(_inputDataObj.GetValue("Trade.ExchangeRatePeriod2")));
    SetParm(0, retVal_);
    return 0;
END;

MACRO BLB_ConvertCalcID(retVal_, _input_value, _inputDataObj, _DataObj, _Log)
    SetParm(0, 0);
    return 0;
END;

MACRO BLB_ConvertDuartion(retVal_, _input_value, _inputDataObj, _DataObj, _Log)

  var
      StartDate = NULL, EndDate = NULL;

     StartDate = _inputDataObj.GetValue("Trade.ValueDatePeriod1Currency1");

    BLB_ConvertDate(StartDate, _input_value, _inputDataObj, _DataObj, _Log);
    BLB_ConvertDate(EndDate, _input_value, _inputDataObj, _DataObj, _Log);

    retVal_ = EndDate - StartDate;
    SetParm(0, retVal_);
    return 0;
END;




