/*
$Name: mmpc_j.mac
$Module: МБК
$Description: Пролонгация сделки
*/


/*--------------------------------------------------------------------------┐
  RS-Bank 5.1                                          R-Style Software Lab

  File Name   : mmpc_j.mac
  Programmer  : Калашников М.В.
  Description : Пролонгация сделки
  Comment     : 
L---------------------------------------------------------------------------*/
import InsCarryDoc, CurrInter, Проценты, MmarkInter, mmlibr, mmcarry, mmcnst_j, mmplib,dl_lib,dl_prol ;

PRIVATE FILE leg (dl_leg);
PRIVATE FILE pm ("pmpaym") key 1 write;
PRIVATE RECORD tick (dl_tick);

var НомерСделки;
var НомерТранша = 1;

PRIVATE VAR 
      new_paymentid,
      deal_pd,      
      IP_id = TArray,
      IPtype = TArray,
      PP_id = TArray,
      PPtype = TArray;

PRIVATE MACRO FindPaymByPurpose (DealID, purp, status)
var stat;
    pm.DocKind = DL_IBCDOC;
    pm.DocumentID = DealID;
    pm.Purpose = purp;
    pm.SubPurpose = 0;

    stat = GetGE(pm);
    while (stat)
        if((pm.DocKind == DL_IBCDOC) and
           (pm.DocumentID == DealID) and
           (pm.Purpose == purp) and
           (pm.PaymStatus == status))
            return true;
        end;
        stat = next(pm);
    end;
    return false;
end;


PRIVATE MACRO Prolongate_OD (OD_New, new_paymentid, ExecDate)
    /*Если есть вынесенный на пролонгацию платеж по ОД надо перенести средства со старого ОД на новый*/    
    if (FindPaymByPurpose(tick.dealid, PM_PURP_PRINC_RET, PM_CARRYED_OUT_TO_PROLONG))
       if ( pm.ValueDate > {curdate} )
          mm_error("Преждевременное выполнение шага запрещено.");
          return false;
       end;
        
       if (not MM_PRLNG_InsertDocsPrinc (deal_pd, ExecDate, pm, OD_New))
          return false;
       end;

       IPtype.size = PPtype.size = IP_id.size = PP_id.size = 0;

       IP_id[0] = pm.PaymentID;
       IPtype[0] = OPR_ID_REAL;
       PP_id[0] = new_paymentid;
       PPtype[0] = OPR_ID_REAL;

       if ( not PaymentsKvit( IP_id, IPtype, PP_id, PPtype, null, PMLINK_KIND_PROLONG) )
          mm_error( "Ошибка связывания платежей" );
          return false;
       end;
    end;

    return true;
END;

PRIVATE MACRO Capitalize_Perc (OD_New, new_paymentid, ExecDate)
    VAR stat, СчетПроцентов, СуммаПлатежа_всего = 0, sz;

    СчетПроцентов = MM_GetAutoPerc(leg.DealID, leg.LegID, PC_IBC_CON);
        IPtype.size = PPtype.size = IP_id.size = PP_id.size = 0;

    /*Если есть вынесенный на пролонгацию платеж по %% надо выполнить капитализацию на новый ОД*/
    /*на самом деле их может быть несколько */
    stat = FindPaymByPurpose(tick.dealid, PM_PURP_PERCENT, PM_CARRYED_OUT_TO_PROLONG);
    while (stat and limiter (tick, pm) and
           (pm.Purpose == PM_PURP_PERCENT) and
           (pm.PaymStatus == PM_CARRYED_OUT_TO_PROLONG))

        if (pm.FuturePayerAmount)
           if (not InsertPcPay( СчетПроцентов, pm.ValueDate, ExecDate, pm.FuturePayerAmount))
              mm_error ("Ошибка при оплате процентов");
              return false;
          end;

          СуммаПлатежа_всего = СуммаПлатежа_всего + pm.FuturePayerAmount;

          sz = IP_id.size;
          IP_id[sz] = pm.PaymentID;
          IPtype[sz] = OPR_ID_REAL;
          PP_id[sz] = new_paymentid;
          PPtype[sz] = OPR_ID_REAL;
       end;

      stat = next(pm);
   end;

   if (СуммаПлатежа_всего)
      if (not MM_PRLNG_InsertDocsPerc ( deal_pd, ExecDate, СуммаПлатежа_всего, OD_New, leg ))
         return false;
      end;

      if ( not PaymentsKvit( IP_id, IPtype, PP_id, PPtype, null, PMLINK_KIND_CAPITAL) )
         mm_error( "Ошибка связывания платежей" );
         return false;
      end;    
   end;

   return true;
END;

MACRO InsAcc(dockind, dealid, acc, catid, catnum, duration,dda )
   var que, rs0, pid;

   que="select count(*) from dmcaccdoc_dbt t where t_docid="+dealid+" and t_catid = "+catid+" and t_dockind=102 ";
   rs0 = LnGetRecordSet(que);
   if (rs0 != null)
      if (rs0.moveNext) 
         if (rs0.value(0) > 0 )
            return 0; 
         end;
      end;
   end;

   if (duration == 0)
      pid = 0;
   elif (duration == 1)
      pid = 1;
   elif ((duration>1) and (duration <= 7))
      pid = 2;
   elif ((duration>7) and (duration <= 31))
      pid = 3;
   elif ((duration>32) and (duration <= 91))
      pid = 4;
   elif ((duration>92) and (duration <= 181))
      pid = 5;
   elif ((duration>181) and (duration <= 367))
      pid = 6;
   elif ((duration>367) and (duration <= 1097))
      pid = 7;
   else
      pid = 8;
   end;
 
   que = "insert into dmcaccdoc_dbt "+ 
            "(t_dockind,      "+
            " t_catid,        "+
            " t_catnum,       "+
            " t_docid,        "+
            " t_account,      "+
            " t_actiondate,   "+
            " t_activatedate, "+
            " t_isusable,     "+
            " t_kind_account, "+
            " t_currency,     "+
            " t_fiid,         "+
            " t_templnum,     "+
            " t_groupnum,     "+
            " t_periodid,     "+
            " t_chapter,      "+
            " t_disablingdate,"+
            " t_iscommon,     "+ 
            " t_owner,        "+ 
            " t_place,        "+ 
            " t_issuer,       "+ 
            " t_departmentid, "+ 
            " t_branch,       "+ 
            " t_mcbranch,      "+ 
            " t_firole,       "+ 
            " t_centr,        "+ 
            " t_centroffice,  "+ 
            " t_clientcontrid,"+ 
            " t_bankcontrid,  "+ 
            " t_marketplaceid,"+ 
            " t_marketplaceofficeid,"+ 
            " t_indexdate,    "+ 
            " t_contractor,   "+ 
            " t_currencyeq,   "+
            " t_currencyeq_ratetype,"+
            " t_currencyeq_ratedate,"+
            " t_currencyeq_rateextra,"+
            " t_corrdepartmentid,"+ 
            " t_fiid2 )"+
            " values ("+
             String(dockind)+", " +
             String(catid) + ", " +
             String(catnum)+ ", " +    
             String(dealid)+","+
            "'"+ acc+"', "+
            " to_date('"+dda+"', 'DD.MM.YYYY'),"+
            " to_date('"+dda+"', 'DD.MM.YYYY'),"+
            " 'X', "+
            " (select t_kind_account from dbalance_dbt  where t_balance ='"+ substr(acc,1,5)+"'), "+
            " (select nvl((select t_fiid from dfininstr_dbt t where t_fi_kind=1 and t.t_fi_code='"+substr(acc,6,3)+"'), 0) from dual), "+
            " (select nvl((select t_fiid from dfininstr_dbt t where t_fi_kind=1 and t.t_fi_code='"+substr(acc,6,3)+"'), 0) from dual), "+
            "1, "+
            "0, "+
            pid+", "+
            "1, "+
            " to_date('01010001', 'DDMMYYYY'),"+
            "chr(0), "+
            "-1,"+
            "-1,"+
            "-1,"+
            "1,"+
            "1,"+
            "1,"+
            "5,"+  //FiDoc
            "-1,"+
            "-1,"+
            "-1,"+
            "-1,"+
            "-1,"+
            "-1,"+
            "-1,"+
            "-1,"+
            "-1,"+
            "0,"+
            "0,"+
            "0.0,"+
            "0,"+
            "0 )";
   rs0 = LnGetRecordset(que);
end;



/*----------------------------------------------------------------------------
    Выполнение шага
----------------------------------------------------------------------------*/
MACRO ExecuteStep(Buffer, Document)
    var НовыйОД = "", СтарыйОД = "", new_deal_pd, new_paymentid,acc0,acc9,da,acc2, AsCategory = 0, PrlngSum = 0;
    var  at = MM_Carry;

    SetBuff (tick,Document);
    DL_PrepareCarryBuffer (Buffer);

    leg.LegKind = LEG_KIND_DL_TICK;
    leg.DealID = tick.DealID;
    leg.LegID = 1;

    if (not GetEq(leg))
        mm_error ("Не найден транш сделки");
        return 1;
    end;

    НомерСделки=SDEL_PROL(tick.DealID);
    if (НомерСделки == 194243 )
      НомерСделки=97121;
    end;
    if (НомерСделки == 388487 )
      НомерСделки=97122;
    end;

    deal_pd = MMFirstDoc(DL_IBCDOC, tick.DealID, true);
    da=SDAT(tick.dealdate);

   new_deal_pd = MMFirstDoc(DL_IBCDOC, НомерСделки, true);
   
   
   if (isSale(GetOperationGroup(tick.DealType)))
       if (not СчетСделки("+% к погашению", deal_pd, acc9)) 
          msgbox("no");
          return false; 
      end; 
	  if (new_deal_pd.GetLeg().PFI == deal_pd.GetLeg().PFI)
         InsAcc(102, НомерСделки, acc9, 117, 621, 0,da);    //КУ +% к погашению
	  end;
   else
      if (not СчетСделки("-% к погашению", deal_pd, acc9)) 
         msgbox("no");
         return false; 
      end;
	  if (new_deal_pd.GetLeg().PFI == deal_pd.GetLeg().PFI)
         InsAcc(102, НомерСделки, acc9, 118, 622, 0,da);    //КУ -% к погашению
	  end;
   end;

   if (not СчетСделки("ОД", deal_pd, acc0)) 
      return false; 
   end; 
                                                                 
   if (not (deal_pd and new_deal_pd))
      InsAcc(102, НомерСделки, acc0, 111, 601, leg.Duration, da); //КУ ОД
      return 0;
   end;

   if (not new_deal_pd.ActualCheckPeriod(tdr_mainrest, НовыйОД, NULL, new_deal_pd.GetFIRoleByCategory(tdr_mainrest, new_deal_pd.GetLeg().PFI), NULL, new_deal_pd.GetTick().DealDate, new_deal_pd.GetLeg().PFI))
      return 1;
   end; 
   if (acc0 == НовыйОД)
     msgbox("привязка старого");
   end;
      
   //if ( (substr(НовыйОД,1,5) !=  substr(acc0,1,5)) or (new_deal_pd.GetLeg().PFI != deal_pd.GetLeg().PFI))

   if ( НовыйОД != acc0)
      // при пролонгации с изменением валюты сделки базовая сумма сделок одинаковая
      if (new_deal_pd.GetLeg().PFI == deal_pd.GetLeg().PFI)
         PrlngSum = MIN(DEAL_PD.LEG.rec.Principal, NEW_DEAL_PD.LEG.rec.Principal);
      else
         PrlngSum = DEAL_PD.LEG.rec.Principal;
      end;
      if ( isSale(GetOperationGroup(tick.DealType)) )
         at.AccountPayer    = НовыйОД;	  
         at.AccountReceiver    = acc0;
         at.FIIDPayer      = NEW_DEAL_PD.LEG.rec.pfi;             /*SVE 543795 17.06.2022 Может быть ситуация когда пролонгация происходит с изменением валюты поэтому валюту в проводке указываем в зависимости от валюты сделки*/
         at.FIIDReceiver   = DEAL_PD.LEG.rec.pfi;  
         at.SumReceiver    = PrlngSum;			
      else
         at.AccountPayer    = acc0;	  
         at.AccountReceiver    = НовыйОД;
         at.FIIDPayer      = DEAL_PD.LEG.rec.pfi;                /*SVE 543795 17.06.2022*/
         at.FIIDReceiver   = NEW_DEAL_PD.LEG.rec.pfi;     
         at.SumPayer       = PrlngSum;				
      end;
      //at.FIIDPayer      = leg.pfi;                             /*SVE 543795 17.06.2022*/
      //at.FIIDReceiver   = leg.pfi;
      // at.SumReceiver    = leg.principal;
      //at.SumReceiver    = CH_PROL0(tick.DealID);        //SVE 518262 12.11.2020 просто берем сумму пролонгирующей сделки

      at.Chapter        = 1;
      at.Ground         = MM_ground(tick.dealid,55);
      //"Перенос по сроку  по пролонгации сделки "+tick.dealcode+" от "+tick.dealdate;
      if (not at.carry())
         msgbox("Error !");
         return false;
      end;
   end;
   //else
   //   НовыйОД=acc0;
   //   InsAcc(102, НомерСделки, acc0, 111, 601, leg.Duration,da); //КУ ОД
   //   msgbox("привязка старого");
   //end;

/*
    if (not FindPaymByPurpose(НомерСделки, PM_PURP_PRINC_RET, PM_PREPARING))
        mm_error ("Не найден платеж по привлечению средств сделки с id=", НомерСделки);
        return 1;
    end;

    pm.Amount               =
    pm.BaseAmount           =
    pm.PayAmount            =
    pm.FuturePayerAmount    =
    pm.FutureReceiverAmount = 0;
    if (not Update(pm))
        msgbox ("Ошибка обновления платежа");
    end;

    new_paymentid = pm.paymentid;

    if ((not Prolongate_OD(НовыйОД, new_paymentid, new_deal_pd.tick.rec.DealDate)) or 
        (not Capitalize_Perc(НовыйОД, new_paymentid, new_deal_pd.tick.rec.DealDate))) 
        return 1;
    end;
*/
   var v_updsum;
   //v_updsum =  leg.Principal - execmacrofile("dl_note_lib.mac", "GetNoteDifValue", tick.DealId, 102);
   //v_updsum =  leg.Principal - new_deal_pd.GetLeg().principal;                 /*SVE 537390 28.01.2022 при полной прологации примечание 102 на сделке не заполняется*/
   //execmacrofile("dl_lib.mac", "PaymMainSummUpd", tick.DealId, v_updsum ); //LKL

    MM_ChangeNoteText(OBJTYPE_MMARKDEAL, UniID(tick, OBJTYPE_MMARKDEAL), 7/*MN_AMORTIZED*/, {curdate}, $0);
    GetMainObjAttr(NULL, OBJTYPE_MMARKDEAL, UniID(tick, OBJTYPE_MMARKDEAL), 5, AsCategory, NULL, NULL, {curdate});
    IF ((AsCategory == 1) or (AsCategory == 2))
        MM_ChangeNoteText(OBJTYPE_MMARKDEAL, UniID(tick, OBJTYPE_MMARKDEAL), 10, {curdate}, $0);
    END;
    MM_ChangeNoteText(OBJTYPE_MMARKDEAL, UniID(tick, OBJTYPE_MMARKDEAL), 8/*MN_GROSS*/,     {curdate}, $0);

   return 0;
END;


MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

    private var pplid,nsum,sta,nsum0,rs9,que;
    record tick( dl_tick );
    SetBuff( tick, FirstDoc );
   /*
    pplid=plat_dil(tick.dealid,"102","10","paymentid");
    nsum0=plat_dil(tick.dealid,"102","9","baseamount");
    nsum=plat_dil(tick.dealid,"102","10","baseamount");

    if (CommitOrRollback == 1) 
       if ( nsum < nsum0 )
        que="SELECT RSB_Struct.GetMoney(t_text)  FROM dnotetext_dbt where t_objecttype=103 and  t_notekind=102  and t_documentid=lpad("+tick.dealid+",10,'0') "; 
        rs9 = LnGetRecordSet(que);
        if(rs9 != null)
           if (rs9.moveNext) 
              nsum=rs9.value(0);
           end;
        end;
         //PaymMainSummUpd( tick.DealId, nsum );
         que="UPDATE dpmpaym_dbt SET T_PAYMSTATUS=1000  WHERE T_PAYMENTID="+pplid;
         rs9 = LnGetRecordSet(que);
       end;

    end;

    if (CommitOrRollback==2) 
       if ( nsum < nsum0 )
         nsum=nsum0-nsum;
         //PaymMainSummUpd( tick.DealId, nsum );
         que="UPDATE dpmpaym_dbt SET T_PAYMSTATUS=55  WHERE T_PAYMENTID="+pplid;
         rs9 = LnGetRecordSet(que);
       end;

    end;*/

    return 1;
end;
