/*
$Name: mmplib.mac       
$Module: МБК
$Description: Доп. функции пролонгации/модификации сделки
*/

import CTInter, mmcarry, mmpccar, mmlibr, mmlb_j, mmcnst_j;

PRIVATE CONST paygrh = TBfile ("pcpaygrh");

/* Отражение в бухучете пролонгации ОД*/
macro MM_PRLNG_InsertDocsPrinc( deal_pd, ExecDate, pm, СчетОснДолг)

var debet_acc, kredit_acc, PFI, СчетОснДолгДП,Summ=0;

    PFI = deal_pd.GetParametr(MC_TYPE_PARAMETR_CURRENCY);

    if( not deal_pd.IsExistAccount(tdr_rest(deal_pd.GetTick().FlagTypeDeal), СчетОснДолгДП, NULL, deal_pd.GetFIRoleByCategory(tdr_rest(deal_pd.GetTick().FlagTypeDeal), PFI), NULL, ExecDate, PFI))
        СчетОснДолгДП = СчетОснДолг;   //76762 KMB 15.08.07
        MsgBox("Не могу получить счет категории ОД");
        //  return false;    //76762 KMB 15.08.07
        return false;
    end;

    if( СчетОснДолгДП == СчетОснДолг )
        return true;
    end;

    if( deal_pd.GetParametrTemplate(OBJTYPE_DIRECTION, LLCLASS_DIRECTION_MM) == 2 ) 
        /* Сделка размещения */
        debet_acc  = СчетОснДолг;
        kredit_acc = СчетОснДолгДП;
    else
        /* Сделка привлечения */
        debet_acc  = СчетОснДолгДП;
        kredit_acc = СчетОснДолг;
    end;

    ПолучитьОстатокСчета(NULL,NULL, СчетОснДолгДП, 1, Summ, ExecDate, PFI);
	if( DocCarry( 0,
                  1,                    /*Глава*/
                  PFI,                  /*Валюта*/
                  debet_acc,            /*Дебет*/
                  kredit_acc,           /*Кредит*/
                  abs(Summ),            /*Amount*/
	              ExecDate,             /*За какое число*/
                  0,                    /*CarryResult*/
                  "Пролонгация основного долга",
                  pm.PaymentID ) )
        return false;
    end;

    return true;
end;

/* Отражение в бухучете модификации ОД*/
macro MM_MODIF_InsertDocsPrinc( deal_pd, ExecDate, pm, СчетОснДолг)

var debet_acc, kredit_acc, PFI, СчетОснДолгДП,Summ=0;

    PFI = deal_pd.GetParametr(MC_TYPE_PARAMETR_CURRENCY);

    if( not deal_pd.IsExistAccount(tdr_rest(deal_pd.GetTick().FlagTypeDeal), СчетОснДолгДП, NULL, deal_pd.GetFIRoleByCategory(tdr_rest(deal_pd.GetTick().FlagTypeDeal), PFI), NULL, ExecDate, PFI))
        СчетОснДолгДП = СчетОснДолг;   //76762 KMB 15.08.07
        MsgBox("Не могу получить счет категории ОД");
        //  return false;    //76762 KMB 15.08.07
        return false;
    end;

    if( СчетОснДолгДП == СчетОснДолг )
        return true;
    end;

    if( deal_pd.GetParametrTemplate(OBJTYPE_DIRECTION, LLCLASS_DIRECTION_MM) == 2 ) 
        /* Сделка размещения */
        debet_acc  = СчетОснДолг;
        kredit_acc = СчетОснДолгДП;
    else
        /* Сделка привлечения */
        debet_acc  = СчетОснДолгДП;
        kredit_acc = СчетОснДолг;
    end;

    ПолучитьОстатокСчета(NULL,NULL, СчетОснДолгДП, 1, Summ, ExecDate, PFI);
	if( DocCarry( 0,
                  1,                    /*Глава*/
                  PFI,                  /*Валюта*/
                  debet_acc,            /*Дебет*/
                  kredit_acc,           /*Кредит*/
                  abs(Summ),            /*Amount*/
	              ExecDate,             /*За какое число*/
                  0,                    /*CarryResult*/
                  "Перенос основного долга на соответствующий счет учета",
                  pm.PaymentID ) )
        return false;
    end;

    return true;
end;

///*Получить планируемую дату конца периода оплаты процентов*/
//PRIVATE MACRO GetPlanPercPayDate (СчетПроцентов, ExecDate, PlanDate:@variant)
//    paygrh.KeyNum = 2;
//    paygrh.rec.AutoPerc = СчетПроцентов;
//    paygrh.rec.EndDate = ExecDate;
//
//
//    if (paygrh.GetGE and (paygrh.rec.AutoPerc == СчетПроцентов))
//        PlanDate = paygrh.rec.EndDate;
//        return true;
//    end;
//
//    mm_error ("Дата " + ExecDate + " не входит ни в один период оплаты процентов");
//
//    return false;
//END;
//
macro СуммаНачисленных(deal_pd, ExecDate)
  var Начисленные = 0, Сумма = 0;
//  var PcPayRec = TRsbDataSet("select Sum(T_SUMFACT) as sum from dprccntsched_dbt where " +
//                             "t_ContractID = " + ПД + " and T_SCHEDULEKIND = 2 " +
//                             "and T_SPECIALTYPE = 0");
//
//  if (not PcPayRec.MoveNext()) 
//  	Начисленные = -1;
//  	return Начисленные;
//  end;
//  if (PcPayRec.rec.sum)
//	  Начисленные = PcPayRec.rec.sum;
//  end;
//  if (Начисленные <0) Начисленные = 0;end;

  ПолучитьОстатокСчета(deal_pd, tdr_claimP,       "", 1, Сумма, ExecDate, deal_pd.leg.rec.PFI);
  Начисленные = Начисленные + Сумма;
  ПолучитьОстатокСчета(deal_pd, tdr_claimR,       "", 1, Сумма, ExecDate, deal_pd.leg.rec.PFI);
  Начисленные = Начисленные + Сумма;
  ПолучитьОстатокСчета(deal_pd, tdr_corespacc_vb, "", 1, Сумма, ExecDate, deal_pd.leg.rec.PFI);
  Начисленные = Начисленные + Сумма;

  return Начисленные;
end;

/* Отражение в бухучете капитализации процентов*/
MACRO MM_PRLNG_InsertDocsPerc ( deal_pd, ExecDate, CapitalizationSum, СчетОснДолг, leg )
var 
   Начисленные, НеНачисленные, PFI, at = MM_Carry/*DL_AccTrans*/, bt = MM_Carry/*DL_AccTrans*/; 

    Начисленные = СуммаНачисленных(deal_pd, ExecDate);

    if(CapitalizationSum > Начисленные)
        НеНачисленные = CapitalizationSum - Начисленные;
    else
        НеНачисленные = $0;
    end;

    PFI = deal_pd.GetParametr(MC_TYPE_PARAMETR_CURRENCY);

    if (deal_pd.GetParametrTemplate(OBJTYPE_DIRECTION, LLCLASS_DIRECTION_MM) == 2)
        /*Размещение*/ 
    if (Начисленные > 0)
	    at.date_carry = ExecDate;
   		at.PrimaryDoc = deal_pd;
	    at.AccountPayer = СчетОснДолг;
	    at.CatReceiver = "+% к погашению";	
//	    at.FiRolePayer = FIROLE_CORACC_ACTIVE;
	    at.FIIDPayer = PFI;
	    at.FIIDReceiver = PFI;
		at.SumPayer = 
	    at.SumReceiver = Начисленные;
	    at.Ground = "Капитализация начисленных процентов при пролонгации платежа по основному долгу";
	    at.Chapter = 1;
//	    at.PaymentID = ИДплатежа;
    	if (not at.carry()) return false; end;;
	end;

    if (НеНачисленные > 0)
	    bt.date_carry = ExecDate;
   		bt.PrimaryDoc = deal_pd;
	    bt.AccountPayer = СчетОснДолг;
	    bt.CatReceiver = "+%, Кр";	
//	    bt.FiRolePayer = FIROLE_CORACC_ACTIVE;
	    bt.FIIDPayer = PFI;
	    bt.FIIDReceiver = NATCUR;
		bt.SumPayer = 
	    /*bt.SumReceiver =*/ НеНачисленные;
	    bt.Ground = "Капитализация неначисленных процентов при пролонгации платежа по основному долгу";
	    bt.Chapter = 1;
//	    bt.PaymentID = ИДплатежа;

    	if (not bt.carry()) return false; end;
	end;

        return true;// MM_ReceivePrlngPerc (deal_pd, ExecDate, Начисленные, НеНачисленные, PFI, СчетОснДолг, "Капитализация процентов");
    end;

    /*Привлечение*/
    if (Начисленные > 0)
	    at.date_carry = ExecDate;
   		at.PrimaryDoc = deal_pd;
	    at.CatPayer = "-% к погашению";
	    at.AccountReceiver = СчетОснДолг;	
//	    at.FiRolePayer = FIROLE_CORACC_ACTIVE;
	    at.FIIDPayer = PFI;
	    at.FIIDReceiver = PFI;
		at.SumPayer = 
	    at.SumReceiver = Начисленные;
	    at.Ground = "Капитализация начисленных процентов при пролонгации основного долга";
	    at.Chapter = 1;
//	    at.PaymentID = ИДплатежа;
    	if (not at.carry()) return false; end;;
	end;

    if (НеНачисленные > 0)
	    bt.date_carry = ExecDate;
   		bt.PrimaryDoc = deal_pd;
	    bt.CatPayer = "-%, Кр";
	    bt.AccountReceiver = СчетОснДолг;	
//	    bt.FiRolePayer = FIROLE_CORACC_ACTIVE;
	    bt.FIIDPayer = NATCUR;
	    bt.FIIDReceiver = PFI;
		/*bt.SumPayer = */
	    bt.SumReceiver = НеНачисленные;
	    bt.Ground = "Капитализация неначисленных процентов при пролонгации основного долга";
	    bt.Chapter = 1;
//	    bt.PaymentID = ИДплатежа;

    	if (not bt.carry()) return false; end;;
	end;
	
    return true;//MM_PayPrlngPerc (deal_pd, ExecDate, Начисленные, НеНачисленные, PFI, СчетОснДолг, "Капитализация процентов");end;
 end;

/* Отражение в бухучете переноса процентов*/
MACRO MM_MODIF_InsertDocsPerc ( deal_pd, ExecDate, CapitalizationSum, leg )
var 
   Начисленные, НеНачисленные, PFI, at = MM_Carry/*DL_AccTrans*/, bt = MM_Carry/*DL_AccTrans*/; 
   
    Начисленные = СуммаНачисленных(deal_pd, ExecDate);

    if(CapitalizationSum > Начисленные)
        НеНачисленные = CapitalizationSum - Начисленные;
    else
        НеНачисленные = $0;
    end;

    PFI = deal_pd.GetParametr(MC_TYPE_PARAMETR_CURRENCY);

    if (deal_pd.GetParametrTemplate(OBJTYPE_DIRECTION, LLCLASS_DIRECTION_MM) == 2)
        /*Размещение*/ 

    if (НеНачисленные > 0)
	    bt.date_carry = ExecDate;
   		bt.PrimaryDoc = deal_pd;
	    bt.CatPayer = "+% к погашению";
	    bt.CatReceiver = "+%, Кр";	
	    bt.FIIDPayer = PFI;
	    bt.FIIDReceiver = NATCUR;
		bt.SumPayer = НеНачисленные;
	    bt.Ground = "Доначисление процентов при модификации сделки";
	    bt.Chapter = 1;

    	if (not bt.carry()) return false; end;
	end;
		
        return true;
    end;

    /*Привлечение*/
    if (НеНачисленные > 0)
	    bt.date_carry = ExecDate;
   		bt.PrimaryDoc = deal_pd;
	    bt.CatPayer = "-%, Кр";
	    bt.CatReceiver = "-% к погашению";	
	    bt.FIIDPayer = NATCUR;
	    bt.FIIDReceiver = PFI;
	    bt.SumReceiver = НеНачисленные;
	    bt.Ground = "Доначисление процентов при модификации сделки";
	    bt.Chapter = 1;

    	if (not bt.carry()) return false; end;
	end;
	
    return true;
 end;
