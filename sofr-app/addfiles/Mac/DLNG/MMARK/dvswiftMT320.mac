/*
$Name:        dvswiftMT320.mac       
$Module:      МБ Кредиты
$Description: Генерация сообщения по SWIFT MT320  
*/

/****************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 5.1                      */
/****************************************************************************/
/*                  Подсистема "Межбанковские кредиты"                      */
/*  Генерация сообщения по SWIFT MT320                                      */
/*                                                                          */
/*  Имя файла: dvswiftMT320.mac                                             */
/*  Создан:  13.04.20                                        Карлов В.В.    */
/****************************************************************************/

import "wlgenmes.mac",funk, "swtools.mac", "wltools.mac", OprInter,fx_globals,dl_prol,dl_lib;
IMPORT BankInter,rsexts, Календарь,FIInter,"osfile.d32", PTinter,"cb_sql.mac",funk;
import "dlquery.mac";  //SVE
import "mtedit.mac";

Var pmprop   = TBFile ( "pmprop.dbt", "w" );

private var СделкаПривлечения = TRUE; /* Тип сделки: размещение/привлечение */
private var que, DealCode, ss, su, rs1, rs, rs0, DealType = 0;
private var i, jjj, error, idsd, u10, u11, u22, u33, u44, u21, u31, u01, u02, corr_acc;

FILE ПодтвержденияМБК( wldlmm ) key 1;

/* Виды базисов RS-Bank */
const RS_BASIS_30360  = 1,    /* 360 дней в году, 30 в месяце */
      RS_BASIS_ACTACT = 4,    /* в году и в месяце по календарю */
      RS_BASIS_ACT360 = 2,    /* 360 дней в году, в месяце по календ. */
      RS_BASIS_ACT365 = 8,    /* в году и в месяце по календарю без учета високосности */
      RS_BASIS_31360  = 1001; /* 360 дней в году, 31 в месяце */
	  
class PMInfo
  var
    PaymentID = 0,
    CodeKind = 0, 
    Code = "", 
    Name = "", 
    BankCodeKind = 0, 
    BankCode = "", 
    BankName = "", 
    Account = "", 
    CorrCodeKind = 0, 
    CorrCode = "", 
    CorrName = "", 
    CorrAccount = "",
    CorrCodeSwift = "";
end;

Var pmprop2   = TBFile ( "pmprop.dbt", "w" );

private macro getTransportFromDeal(DealID:integer,transport:@string):string
  var query, DataSet, cmd;
  query = "SELECT tick.t_dealid, tick.T_CONFTPID, TRANSP.T_NAME, "+
          "(select transp.T_NAME from ddl_genagr_dbt ga, dwltransp_dbt transp where  transp.t_tpid = ga.t_confirmmethod "+
                                                                             "  and  ga.t_genagrid = tick.t_genagrid) t_name_ga "+
          "FROM ddl_tick_dbt tick, dwltransp_dbt transp "+
          "WHERE tick.t_conftpid = TRANSP.T_TPID AND tick.t_dealid = ?";
  cmd = DL_RSDCommand(query);
  cmd.AddParam(DealID);
  DataSet = cmd.Execute();

  if( DataSet.moveNext() )
    transport = DataSet.Name;
    if (transport == "")
      transport = DataSet.Name_ga;
    end;
  end;        
//    transport = "СПФС";

end;

private macro DeleteFakeSymbols( Str ):string
  var resstr = "", symb, i=0;

  for( i, 1, StrLen(str) )
     symb = SubStr(str, i, 1);
     if( (symb != ",") and (symb != ".") )
        resstr = resstr + symb;
     end;
  end;

  return resstr;
end;

private macro MakeCommonRef( BIC_A, BIC_B, Rate:string )
  var CommonRef, Bank1, Place1, RefCode, Bank2, Place2, LastNonZero, i, symb;

  if( StrLen(BIC_A) < 8 )
     RunError("|SWIFT-код банка нашего банка меньше 8 символов");
  end;

  if( StrLen(BIC_B) < 8 )
     RunError("|SWIFT-код банка-контрагента по сделке меньше 8 символов");
  end;

  if( BIC_A > BIC_B )
     Bank1  = SubStr(BIC_B, 1, 4);
     Place1 = SubStr(BIC_B, 7, 2);
     Bank2  = SubStr(BIC_A, 1, 4);
     Place2 = SubStr(BIC_A, 7, 2);
  else
     Bank1  = SubStr(BIC_A, 1, 4);
     Place1 = SubStr(BIC_A, 7, 2);
     Bank2  = SubStr(BIC_B, 1, 4);
     Place2 = SubStr(BIC_B, 7, 2);
  end;

  Rate = DeleteFakeSymbols(Rate);

  LastNonZero = 0;
  for( i, 1, StrLen(Rate) )
     symb = SubStr(Rate, i, 1);
     if( (symb != "0") and (symb != ",") and (symb != ".") )
        LastNonZero = i;
     end;
  end;

  if( LastNonZero >=4 )
     RefCode = SubStr(Rate, LastNonZero-3, 4);
  else
     RefCode = SubStr(Rate, 1, LastNonZero);
     while( StrLen(RefCode) < 4 )
        RefCode = "0" + RefCode;
     end;
  end;

  CommonRef = Bank1 + Place1 + RefCode + Bank2 + Place2;

  return CommonRef;
END;

macro ОпределитьГенСоглашение(DealID)
  var rs:object;
  var select:string;
  var params:TArray;
  select = "SELECT ga.t_code,                        "+
           "       to_char(ga.t_start, 'dd.mm.yyyy') "+
           "  FROM ddl_genagr_dbt ga,                "+
           "       ddl_tick_dbt tick                 "+
           " WHERE ga.t_genagrid = tick.t_genagrid   "+
           "   AND tick.t_dealid = :DEALID";
  params = makeArray(SQLParam("DealID", DealID));
  rs = execSQLselect(select, params, FALSE);

  if( rs.moveNext() )
    if (rs.value(0) == "б/н")
       return rs.value(0);
    else
       return rs.value(0) + " " + rs.value(1);
    end;
  else
    return NULL;
  end;
end;

macro GetPercDate(DealID)
    var rs = TRsbDataSet("select t_ValueDate from dpmpaym_dbt where " +
                     "t_DocKind = 102 and t_DocumentID = " + DealID +
                     " and t_Purpose = 11 and t_PaymStatus in (0, 1000) order by t_SubPurpose");

    if (rs.MoveNext())
        return date(rs.ValueDate);
    else
        return date(0,0,0);
    end;
end;

macro GetPaymBaseamount(dealcode, purpose)  //SVE получение суммы платежа для корректного расчета поля 32H
   var sql, data;
   sql = DL_RSDCommand("select t_baseamount from dpmpaym_dbt where t_documentid in (select t_dealid from ddl_tick_dbt where t_dealcode = ?) and t_dockind = 102 and t_purpose = ?");
   sql.AddParam(dealcode);
   sql.AddParam(purpose);
   data = sql.Execute;
   if ( data.MoveNext() )
      return data.baseamount;
   end;
   return 0;
end;

macro IsNostro(corrid, fiid)
  var sql = DL_RSDCommand("select t_isnostro from dcorschem_dbt where t_corrid = ? and t_fiid = ?");
  sql.AddParam(corrid);
  sql.AddParam(fiid);
  var data = sql.Execute;
  if ( data.MoveNext() )
     if (data.isnostro == "X")
        return true;
     end;
  end;
  return false;
end;

macro IsResident(partyid)
  var query = DL_RSDCommand("select t_notresident from dparty_dbt where t_partyid = ?");
  query.AddParam(partyid);
  var data = query.Execute();
  if (data.MoveNext() )
     if (data.notresident == "X")
        return false;
     end;
  end;
  return true;
end;

/* Определение типа операции */
macro ОпределитьТипОперации( DealID, Type, Sending, DocKind )
  var Found = FALSE, Direct;
  record LastDlMM( wldlmm );


   var query = " begin\n ? := RSP_SECURITY.getcountmsg(?, ?, ?);\n end; ";
   var cmd = RSDCommand(query);
   cmd.AddParam("n_Count", RSDBP_OUT, V_INTEGER);
   cmd.AddParam("p_KindMes", RSDBP_IN, "MT320");
   cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
   cmd.AddParam("p_DraftKind", RSDBP_IN, DocKind);
   cmd.Execute();
   var mCount = SQL_ConvTypeInteger(cmd.value("n_Count"));

   if (mCount > 0)
     setparm( 1, TRUE );
     setparm( 3,"/" + mCount );

     return TYPE_OPERATION_AMND;
   end;
     return TYPE_OPERATION_NEWT;

  /* Определяем, были ли уже отосланы подтверждения c данным типом, ищем последнее из них */
  ПодтвержденияМБК.DealID = DealID;
  ПодтвержденияМБК.Direct = Direct; /* Ищем исходящие */
  if( not GetEQ(ПодтвержденияМБК) ) /* Вообще ничего не отсылалось */
    return TYPE_OPERATION_NEWT;     /* Тип - новое подтверждение */
  end;

  /* Что-то уже отсылали, проверяем тип */
  if( ПодтвержденияМБК.Type == Type )
    Found = TRUE;
    Copy( LastDlMM, ПодтвержденияМБК );
  end;
  /* Перебираем остальные */
  while( (Next(ПодтвержденияМБК) == TRUE)
    	  and (ПодтвержденияМБК.DealID == DealID)
          and (ПодтвержденияМБК.Direct == Direct)
          and (ПодтвержденияМБК.Type   == Type) )
    Found = TRUE;
  end;

  setparm( 1, TRUE ); /* Были любые отсылки - нужно заполнять поле 21 */

  if( not Found ) /* С данным типом еще ничего не отсылали */
    return TYPE_OPERATION_NEWT; /* Тип - новое подтверждение */
  end;

  var que = "SELECT t.t_dealcodeps,         "+
            "       t.t_partyid,            "+
            "       t.t_dealdate,           "+
            "       t.t_PFI,                "+
            "       l.t_CFI,                "+
            "       l.t_Start,              "+
            "       l.t_Maturity,           "+
            "       l.t_Expiry,             "+
            "       l.t_Principal,          "+
            "       l.t_Price,              "+
            "       l.t_Basis,              "+
            "       l.t_Duration,           "+
            "       l.t_Pitch,              "+
            "       l.t_Cost                "+
            "  FROM DDL_TICK_DBT t,         "+
            "       ddl_leg_dbt l           "+
            " WHERE t.t_dealid = l.t_dealid "+
            "   AND t.t_dealid = " + DealID;
  var rs = LnGetRecordSet(que);
  if( rs != null )
     if( rs.moveNext )
     /* Если изменились существенные параметры сделки, считаем что это поправки */
        if( (LastDlMM.DealCodePS != rs.value(0))       OR
            (LastDlMM.PartyID    != int(rs.value(1)))  OR
            (LastDlMM.DealDate   != rs.value(2))       OR
            (LastDlMM.PFI        != int(rs.value(3)))  OR
            (LastDlMM.CFI        != int(rs.value(4)))  OR
            (LastDlMM.Start      != rs.value(5))       OR
            (LastDlMM.Maturity   != rs.value(6))       OR
            (LastDlMM.Expiry     != rs.value(7))       OR
            (LastDlMM.Principal  != rs.value(8))       OR
            (LastDlMM.Price      != rs.value(9))       OR
            (LastDlMM.Basis      != int(rs.value(10))) OR
            (LastDlMM.Duration   != rs.value(11))      OR
            (LastDlMM.Pitch      != int(rs.value(12))) OR
            (LastDlMM.Cost       != rs.value(13)) )
          return TYPE_OPERATION_AMND;
        end;
     end;
  end;
  return TYPE_OPERATION_DUPL; /* Иначе считаем, что дубликат */
end;

/* Записать поле */
macro ЗаписатьБанкЛог( BlockName, PartyID, CodeKind, CodeValue, BankName, CorrAccount )
  var field_value = "", Tag, tempv, ID, BankCode, error;

  /* Только по наименованию пока банк не заполняем */
  if( (PartyID != 0) OR ((CodeKind != 0) AND (CodeValue != "")) )
     if( (CodeKind != 0) AND (CodeValue != "") )
        ID = ПолучитьКодСубъекта( CodeValue, CodeKind, error );
        if( error )
          ID = ПолучитьКодСубъекта( CodeValue, PTCK_BIC, error );
        end;
        if( error )
           RunError( "|Не найден банк c кодом: " + CodeValue + " и видом кода: " + CodeKind );
        end;
     else
        ID = PartyID;
     end;

     /* Ищем для субъекта SWIFT-код. Если не нашли - отваливаем,   */
     /* так как настоятельно рекомендуется использовать именно его */
     BankCode = ПолучитьКодСубъекта( ID, PTCK_SWIFT, error );
     if( error )
        RunError( "|Не найден SWIFT-код для банка с кодом: "+ CodeValue + " и видом кода: " + CodeKind );
     end;
     CodeKind = PTCK_SWIFT;
/*
     if( not УстановитьКонтекстБлока( BlockName ) )
        RunError("|Ошибка при установке контекста блока " + BlockName);
     end;
*/
     if( BankCode == "NBRKKZKX" )
        // CorrAccount="316904768 CODE 103";
     end;
     if( (BankCode != "") AND (CodeKind == PTCK_SWIFT) )
        Tag = SWIFT_Tag_A;
     else
        Tag = SWIFT_Tag_D;
     end;
     if(BlockName == "57d")
        println(BankCode);
     else
         if( Tag == SWIFT_Tag_A )
            if( strlen(CorrAccount) > 1 )
               println(":57" + Tag + ":" + "/" + CorrAccount);
               println(BankCode);
            else
               println(":57" + Tag + ":" + BankCode);
            end;
         else
            if( strlen(CorrAccount) > 1 )
               println(":57" + Tag + ":" + "/" + CorrAccount);
               if( BankName != "" )
                  StrChangeRusXSet( BankName, tempv );
                  StrMultyToFormat( tempv, tempv, 35, 4 );
                  println(tempv);
               end;
            else
               if( BankName != "" )
                  StrChangeRusXSet( BankName, tempv );
                  StrMultyToFormat( tempv, tempv, 35, 4 );
                  println(":57" + Tag + ":" + tempv);
               end;
            end;
         end;
    end;
  end;

end;


macro KSxem(par1, par2, par3)
  private var que, rs01;
  u01 = 0;
  u02 = "0";
  que = "select b.t_corrid, t_coraccount, t_account       "+
        "  from dpmprop_dbt a ,                "+
        "       dcorschem_dbt b                "+
        " where a.t_paymentid = " + par1 + "   "+
        "   and a.t_debetcredit = " + par2 + " "+
        "   and b.t_number = a.t_corschem      "/*+
        "   and b.t_corrid = " + par3 */ ;
  rs01 = LnGetRecordSet(que);
  if(rs01 != null)
    if(rs01.moveNext)
      u01 = rs01.value(0);
      u02 = rs01.value(1);
      corr_acc = SubStr(rs01.value(2), 1, 5);    //SVE 518322 05.11.2020 корр.счет в нашем банке, необходим для определения у кого происходят расчеты, в нашем банке или в банке контрагента
    end;
  end;
  return;
end;

/* Получить курс в формате SWIFT */
private macro FormatRate( Rate )
  var SWIFTRate = String(Rate);

  if( index( SWIFTRate, "." ) )
    SWIFTRate = GetSWIFTAmount( Rate );
  end;
  
  /* Обрезаем все нули справа */
  while( SubStr( SWIFTRate, StrLen(SWIFTRate), 1 ) == "0" )    
    SWIFTRate = substr( SWIFTRate, 1, StrLen(SWIFTRate)-1 );
  end;
  
  return SWIFTRate;
END;

private macro ЗаписатьНалог(DealID)
  var genagr, taxRate = 0.0, taxAmount = $0, deal_pd;
  
  deal_pd = MMFirstDoc(DL_IBCDOC, DealID, true);
  if (СделкаПривлечения)
    taxRate = GetTaxContr(deal_pd.GetTick());
  else
    taxRate = GetTaxBank(deal_pd.GetTick());
  end;
  
  if (taxRate > 0)
    taxAmount = round(deal_pd.GetLeg().Cost * (taxRate/100), 2);

    println(":15G:");
    println(":37L:" + FormatRate(taxRate));
    println(":33B:" + ПолучитьКодВалютыЛог(deal_pd.GetLeg().PFI) + GetSWIFTAmount(deal_pd.GetLeg().Cost - taxAmount));
    println(":33E:" + ПолучитьКодВалютыЛог(deal_pd.GetLeg().PFI) + GetSWIFTAmount(taxAmount));
  end;
END;

PRIVATE MACRO FillPI(Purpose, PMInfoObj, DealID)
    var pmrmprop = TBFile("pmrmprop");
    var pmprop   = TBFile("pmprop");
    var partcode = TBFile("partcode");
    var corschem = TBFile("corschem", "R", 1);
    var rs = TRsbDataSet("select * from dpmpaym_dbt where " +
                     "t_DocKind = 102 and t_DocumentID = " + DealID +
                     " and t_Purpose = " + Purpose);

    if (not rs.MoveNext())
      mm_error( "Не найден платеж с назначением ", Purpose );
      return 1;
    end;
	PMInfoObj.PaymentID = rs.PaymentID;
    PMInfoObj.CodeKind = rs.ReceiverCodeKind;
    PMInfoObj.Code = rs.ReceiverCode;
    PMInfoObj.Account = rs.ReceiverAccount;

    pmrmprop.rec.PaymentID = rs.PaymentID;
    if (pmrmprop.GetEQ())
      PMInfoObj.Name = pmrmprop.rec.ReceiverName;
      PMInfoObj.BankName = pmrmprop.rec.ReceiverBankName;
      PMInfoObj.CorrName = pmrmprop.rec.ReceiverCorrBankName;

      pmprop.rec.PaymentID = rs.PaymentID;
      pmprop.rec.DebetCredit = 1;
      if (pmprop.GetEQ())
        if (pmprop.rec.Group == PAYMENTS_GROUP_EXTERNAL)
          PMInfoObj.BankCodeKind = pmprop.rec.CodeKind;
          PMInfoObj.BankCode     = pmprop.rec.BankCode;
          PMInfoObj.CorrCodeKind = pmprop.rec.CorrCodeKind;
          PMInfoObj.CorrCode     = pmprop.rec.CorrCode;
          PMInfoObj.CorrAccount  = pmprop.rec.CorrAcc;
        else
          PMInfoObj.BankCodeKind = PTCK_BIC;
          partcode.rec.PartyID = {ourbank};
          partcode.rec.CodeKind = PMInfoObj.BankCodeKind;
          if (partcode.GetEQ())
            PMInfoObj.BankCode = partcode.rec.Code;

            pmprop.rec.DebetCredit = 0;
            if (not pmprop.GetEQ())
              return false;
            end;
            corschem.rec.FI_Kind = 1;
            corschem.rec.FIID = pmprop.rec.PayFIID;
            corschem.rec.Number = pmprop.rec.Corschem;
            if (not corschem.GetEQ())
              SetParm(1, PMInfoObj);
              return false;
            end;
            PMInfoObj.CorrCodeKind = PTCK_BIC;
            partcode.rec.PartyID = corschem.rec.CorrID;
            partcode.rec.CodeKind = PMInfoObj.CorrCodeKind;
            if (partcode.getEQ())
                PMInfoObj.CorrCode = partcode.rec.Code;
                PMInfoObj.CorrAccount = corschem.rec.CorAccount;
            end;
            partcode.rec.PartyID = corschem.rec.CorrID;
            partcode.rec.CodeKind = PTCK_SWIFT;
            if (partcode.getEQ())
                PMInfoObj.CorrCodeSwift = partcode.rec.Code;
                PMInfoObj.CorrAccount = corschem.rec.CorAccount;
            end;

          else 
            return false;
          end;
        end;
      else
        return false;
      end;
    else
      return false;
    end;

    SetParm(1, PMInfoObj);
    return true;
END;

/* Непосредственно генерация МТ320 */
macro PrintCommonMT320( DealID, Type, TypeOper, CodeSWIFT_Contr )
private var field_value, error, gr, Sending = FALSE, nvalu, ij, ij0, ii0, pplid,
            PROL, RS3, ID, FactPart, BankCode, subjid, notrez, psu = 0,
            que, rs01, rs02, nnum, sGenType = "", PrincRetPMInfo = PMinfo, PrincPMInfo = PMInfo, PercentPMInfo = PMInfo;

array mmm;
/*
  SetBuff( wlmes,  addrMes );
  SetBuff( wldlmm, addrWlDlMm );
*/

  FillPI(PM_PURP_PRINC_RET, PrincRetPMInfo, DealID);
  FillPI(PM_PURP_PRINC,     PrincPMInfo, DealID);
  FillPI(PM_PURP_PERCENT,   PercentPMInfo, DealID);

  PrintLog(2,"Генерация сообщения по МТ320 ");
  jjj = 1;
  idsd = DealID;
  que = "select a.t_dealcode,             "+
        "       a.t_dealtype,             "+
        "       a.t_userfield1,           "+
        "       b.t_notresident,          "+
        "       a.t_partyid,              "+
        "       l.t_price,                "+
        "       a.t_dealdate,             "+
        "       l.t_start,                "+
        "       l.t_maturity,             "+
        "       l.t_pfi,                  "+
        "       l.t_principal,            "+
        "       l.t_cost,                 "+
        "       l.t_point,                "+
        "       l.t_basis,                "+
        "       a.t_bofficekind           "+
        "  from ddl_tick_dbt a,           "+
        "       dparty_dbt b,             "+
        "       ddl_leg_dbt l             "+
        " where a.t_bofficekind = 102     "+
        "   and a.t_dealid = " + idsd + " "+
        "   and b.t_partyid = a.t_partyid "+
        "   and l.t_dealid = a.t_dealid";
  rs = LnGetRecordset(que);
  if( rs != null )
     if( rs.moveNext )
        DealCode = rs.value(0);
        DealType = int(rs.value(1));
        NotRez = rs.value(3);
        var PartyID = int(rs.value(4));
        var Price = rs.value(5);
        var DealDate = date(rs.value(6));
        var StartDate = date(rs.value(7));
        var Maturity = date(rs.value(8));
        var PFI = rs.value(9);
        var Principal = rs.value(10);
        var Cost = rs.value(11);
        var Point = rs.value(12);
        var Basis = rs.value(13);
        var DocKind = rs.value(14);
        nvalu = execmacrofile("dl_mt.mac", "mm_par", idsd, 9, "fiid");
        if( DealType == 12300 )
           u11 = execmacrofile("dl_mt.mac", "mm_par", idsd, 9, "receiverbankid");
           u22 = execmacrofile("dl_mt.mac", "mm_par", idsd, 9, "receiveraccount");
           u33 = execmacrofile("dl_mt.mac", "mm_par", idsd, 10, "receiverbankid");
           u44 = execmacrofile("dl_mt.mac", "mm_par", idsd, 10, "receiveraccount");
           if( nvalu > 0 )
              u22 = rs.value(2);
           end;
        end;
        if( DealType == 12305 )
           u11 = execmacrofile("dl_mt.mac", "mm_par", idsd, 9, "receiverbankid");
           u22 = execmacrofile("dl_mt.mac", "mm_par", idsd, 9, "receiveraccount");
           u33 = execmacrofile("dl_mt.mac", "mm_par", idsd, 9, "payerbankid");
           u44 = execmacrofile("dl_mt.mac", "mm_par", idsd, 10, "receiveraccount");
           if( nvalu > 0 )
              u44 = rs.value(2);
           end;
        end;
        if( u10 == 14 )
	   MSGBOX(" ВЫХОД БЕЗ ПОДТВЕРЖДЕНИЯ ! ");
  	   return FALSE;
  	else
  	   u21 = ПолучитьКодСубъекта(u11, 6);
  	   u31 = ПолучитьКодСубъекта(u33, 6);
	end;
     end;
  end;
  if( isSale(getOperationGroup(DealType)) )
    СделкаПривлечения = FALSE;  /* Это сделка размещения */
  else
    СделкаПривлечения = TRUE;
  end;

  /* 15A New Sequence */
  println(":15A:");
  /* 20 Sender's Reference */
  if( Type == DLMM_TYPE_MATU ) /* Ликвидация (завершение) */
     que = "select count(*)                          "+
           "  from dwldlmm_dbt a,                    "+
           "       ddl_tick_dbt b                    "+
           " where b.t_dealcode = '" + DealCode + "' "+
           "   and a.t_dealid = b.t_dealid";
     rs02 = LnGetRecordSet(que);
     if( rs02 != null )
        if( rs02.moveNext )
           nnum = int(rs02.value(0));
        end;
     end;
     if( nnum > 0 )
        nnum = "/" + string(nnum);
     else
        nnum = "";
     end;

     if (index(DealCode, ":")>0)
       print(":20:" + substr(DealCode, 5) + nnum);
     else
       print(":20:" + DealCode + nnum); 
     end; 
//dan     println(":20:" + substr(DealCode, 5) + nnum);

  else

     if (index(DealCode, ":")>0)
       print(":20:" + substr(DealCode, 5));
     else
       print(":20:" + DealCode); 
     end; 
  
//dan     println(":20:" + substr(DealCode,5));

  end;

  /* Определяем тип операции */
  var mCount = "";
  field_value = ОпределитьТипОперации( DealID, Type, Sending, mCount, DocKind );
     println(mCount);

  /* 21 Related Reference */
  if( Type == DLMM_TYPE_MATU ) /* Ликвидация (завершение) */
     println(":21:" + DealCode);
  else
     prol = ПРОЛОНГАЦИЯ(idsd);
     ss = string(PROL);
     que = "select t_dealcode              "+
           "  from ddl_tick_dbt            "+
           " where t_dealid = '" + ss + "' ";
     rs3 = LnGetRecordset(que);
     if( rs3 != null )
        if( rs3.moveNext )
           psu = plat_dil(prol, "102", "10", "baseamount");
           prol = string(rs3.value(0));
           var baseamount_was = GetPaymBaseamount(prol, "9"); //SVE 489925 необходимо считать поле 32H как разница между тем какая была сумма и на какую пролонгировали
           println(":21:" + substr(prol,5));
        end;
     end;
  end;

  /* 22A - Type of Operation */
  if( TypeOper == "" );
     println(":22A:" + field_value);
  else
     println(":22A:" + TypeOper);
  end;
  /* 22B - Type of Event - этап сделки*/
  if( Type == DLMM_TYPE_CONF )   /* Ввод */
     println(":22B:" + TYPE_EVENT_CONF);
  elif( Type == DLMM_TYPE_MATU ) /* Ликвидация (завершение) */
     if( (plat_dil(idsd, "102", "9", "USERTYPEDOCUMENT")) == "1" )
        println(":22B:CANC");
     else
        println(":22B:AMND");
     end;
  else                                  /* Пролонгация */
    println(":22B:" + TYPE_EVENT_ROLL);
  end;

  /* 22C Common Reference */
//  field_value = ПолучитьКодСубъекта(PartyID, PTCK_SWIFT, error);
//  if( error )
//     RunError( "|Не найден SWIFT-код банка-контрагента по сделке" );
//  end;
//  u1 = SubStr(field_value, 1, 4) + SubStr(field_value, 7, 2);
//  field_value = Price;
// u2 = (string(field_value/100));
//  u2 = int(u2);
//  u2 = string(u2);
//  i2 = strlen(u2);
//  if( substr(u2, i2, 1) == "0" )
//     u2 = substr(u2, 1, i2 - 1);
//     i2 = i2 - 1;
//     if( substr(u2, i2, 1) == "0")
//        u2 = substr(u2, 1, i2 - 1);
//        i2 = i2 - 1;
//     end;
//  end;
//  u2 = "0000" + u2;
//  i2 = i2 + 4;
//  u2 = substr(u2, i2 - 3, 4);
//  u1 = "RUAGMM" + u2 + u1;
//  println(":22C:" + u1);
  println(":22C:" + MakeCommonRef(ПолучитьКодСубъекта( _SelfID, PTCK_SWIFT, error ), ПолучитьКодСубъекта(PartyID, PTCK_SWIFT, error), Price));

  /* 21N Contract Number Party A */
  // ЗаписатьПолеЛог( "21N", wldlmm.DealCode );
  //   ЗаписатьПолеЛог( "21N", "" );

  /* 82a Party A */
  BankCode = ПолучитьКодСубъекта( _SelfID, PTCK_SWIFT, error );
  if( error )
     RunError( "|Не найден SWIFT-код банка нашего банка" );
  end;
  println(":82A:" + BankCode);

  /* 87a Party B */
  BankCode = ПолучитьКодСубъекта(PartyID, PTCK_SWIFT, error);
  if( error )
     RunError( "|Не найден SWIFT-код банка-контрагента по сделке" );
  end;
  println(":87A:" + BankCode);
  SetParm(3, BankCode); 

  /* 77D Party A */
  field_value = ОпределитьГенСоглашение(DealID);
  if( ValType(field_value)  == V_STRING )
     StrChangeRusXSet(field_value, sGenType); /* Транслитерация */
     println(":77D:" + field_value);
  end;

  /* 15B New Sequence */
  println(":15B:");

  /* 17R Party's A Role */
  if( СделкаПривлечения )
    field_value = PARTYS_ROLE_BORROWER;
  else
    field_value = PARTYS_ROLE_LENDER;
  end;
  println(":17R:" + field_value);

  /* 30T Trade Date */
  println(":30T:" + GetSWIFTDateFull(DealDate));

  /* 30V Value Date */
  println(":30V:" + GetSWIFTDateFull(StartDate));

  /* 30P Maturity Date */
  println(":30P:" + GetSWIFTDateFull(Maturity));

  /* 32B Currency and Principal Amount */
  println(":32B:" + ПолучитьКодВалютыЛог(PFI) + GetSWIFTAmount(Principal));

  if( Type == DLMM_TYPE_CONF )   /* Ввод */
  elif( Type == DLMM_TYPE_MATU ) /* Ликвидация (завершение) */
  else
     var baseamount_is = GetPaymBaseamount(DealCode, "9");
     println(":32H:" + ПолучитьКодВалютыЛог(PFI) + GetSWIFTAmount(baseamount_was - baseamount_is));
  end;

  println(":30X:" + GetSWIFTDateFull(Maturity));

  /* 34E Currency and Interest Amount */
  field_value = ПолучитьКодВалютыЛог(PFI) + GetSWIFTAmount(Cost);
  if( СделкаПривлечения )
  else
     if( Cost )
     field_value = "N" + field_value;
     else
        field_value = field_value;
     end;
  end;
  println(":34E:" + field_value);

  FactPart = trim(string(Price/pow(10, Point)));
  ij = index(FactPart, ".");
  if( ij > 0 )
     FactPart = substr(FactPart, 1, ij - 1) + "," + substr(FactPart, ij + 1);
  end;

  ii0 = 0;
  while( ii0 < 4 )
        ij0 = strlen(FactPart);
        ij = substr(FactPart, ij0);
        if( ij == "0" )
           FactPart = substr(FactPart, 1, ij0 - 1);
        end;
        ii0 = ii0 + 1;
  end;
  println(":37G:" + FactPart);

  /* 14D Day Count Fraction */
  if( Basis == RS_BASIS_30360 )   /* 360 дней в году, 30 в месяце */
    field_value = SWIFT_BASIS_360_360;
  elif( Basis == RS_BASIS_ACTACT )  /* в году и в месяце по календарю */
    field_value = SWIFT_BASIS_ACT_365;
  elif( Basis == RS_BASIS_ACT360 )  /* 360 дней в году, в месяце по календ. */
    field_value = SWIFT_BASIS_ACT_360;
  elif( Basis == RS_BASIS_ACT360 )  /* в году и в месяце по календарю без учета високосности */
    field_value = SWIFT_BASIS_ACT_360;
  else                                   /* 360 дней в году, 31 в месяце */
    field_value = SWIFT_BASIS_360_360;
  end;
  if( Basis == 8 )  /* в году и в месяце по календарю */
     field_value = SWIFT_BASIS_ACT_365;
  end;
  println(":14D:" + field_value);

  /* 15C New Sequence */
  println(":15C:");
  if( СделкаПривлечения )
     KSxem(PrincPMInfo.PaymentID, 0);

        УстановитьКонтекстБлока("57a");

        println(":57D:ACC YOUR INSTRUCTION");
        if (PFI == 0)
            subjid = ПолучитьКодСубъекта(PrincRetPMInfo.BankCode, PrincRetPMInfo.BankCodeKind);
            if (subjid == "")
                subjid = ПолучитьКодСубъекта(PrincRetPMInfo.BankCode, 3);
            end;
            println("BIC " + swkod(subjid, 3));   
            if( notrez != "X" )
                println("CA " + PrincRetPMInfo.CorrAccount); 
                println("INN " + swkod(PartyID, 16));
            else
                println("CA " + PrincRetPMInfo.Account); 
            end;
        else
            ЗаписатьБанкЛог( "57d", _SelfID, 6, IIF(PrincRetPMInfo.CorrCodeSwift != "",PrincRetPMInfo.CorrCodeSwift, PrincRetPMInfo.BankCode), "", PrincRetPMInfo.CorrAccount );
        end;
  else 
      
         println(":57D:ACC YOUR INSTRUCTION");
         if (PFI == 0)
            subjid = ПолучитьКодСубъекта(PrincPMInfo.BankCode, PrincPMInfo.BankCodeKind);
            if (subjid == "")
                subjid = ПолучитьКодСубъекта(PrincPMInfo.BankCode, 3);
            end;
            println("BIC " + swkod(subjid, 3));
            KSxem(PrincPMInfo.PaymentID, 0);
            if( notrez != "X" )
                println("CA " + PrincPMInfo.CorrAccount); 
               println("INN " + swkod(PartyID, 16));
            else
                println("CA " + PrincPMInfo.Account); 
            end;
         else
            if( PrincPMInfo.BankCode != "" )  
                u21 = PrincPMInfo.BankCode;
            end;
            ЗаписатьБанкЛог( "57d", PartyID, 6, IIF(PrincPMInfo.CorrCodeSwift != "",PrincPMInfo.CorrCodeSwift, PrincPMInfo.BankCode), "", PrincPMInfo.CorrAccount );
         end;
  end;

  /* 15D New Sequence */
  println(":15D:");
  if( СделкаПривлечения )
      if( PFI == 0 )
         println(":57D:/" + u22);
         println("BIC " + swkod(_SelfID, 3));
         println("CA " + swks(_SelfID));
         println("INN " + swkod(_SelfID, 16));
      else
         /* 57a - Receiving Agent - куда мы хотим получить деньги */
         pplid = plat_dil(idsd, "102", "9", "paymentid");
         KSxem(pplid , 0);

         if( u21 == "RUAGRUMMXXX" )
            u22 = MM_acc(idsd, 111);
         end;
         if( PrincPMInfo.CorrCodeKind != "" )
            if( PrincPMInfo.CorrCode != "" )
               u01 = PrincPMInfo.CorrCode;
            end;
            if( isNostro(PartyID, PFI) )
               u22 = u02;
            end;
         end;
         ЗаписатьБанкЛог(   "57a", 
                            _SelfID, 
                            6, 
                            IIF(PrincPMInfo.CorrCodeSwift != "",PrincPMInfo.CorrCodeSwift, PrincPMInfo.BankCode), 
                            "", 
                            IIF(PrincPMInfo.CorrAccount != "", PrincPMInfo.CorrAccount,u22) );
      end;
  else
     if( PFI == 0 )
        println(":57D:/" + u44);
        println("BIC " + swkod(_SelfID, 3)); //MAA: 517378 - В теме 514492 были путаница с полями 15C и 15D
        //println("BIC " + swkod(PartyId, 3));    //SVE 514492 16.09.2020 необходимо указывать данные контрагента, а не "нашего банка"
        println("CA " + swks(_SelfID));
        println("INN " + swkod(_SelfID, 16));     
        //println("INN " + swkod(PartyID, 16));   //SVE 514492
     end;
     if( PFI != 0 )
      /* 57a - Receiving Agent - куда мы хотим получить деньги */
      pplid = plat_dil(idsd, "102", "9", "paymentid");
      KSxem(pplid, 1);
      ЗаписатьБанкЛог(  "57a", 
                        _SelfID, 
                        6, 
                        IIF(PrincRetPMInfo.CorrCodeSwift != "",PrincRetPMInfo.CorrCodeSwift, PrincRetPMInfo.BankCode), 
                        "", 
                        IIF(PrincRetPMInfo.CorrAccount != "", PrincRetPMInfo.CorrAccount,u22) );
     end;
  end;


  /* Платежные инструкции по оплате процентов */
  /* Заполняем только если не совпадают с инструкцией по оплате ОД сделки */
  if( СделкаПривлечения )
     /* Блок Sequence E - платежные инструкции по оплате процентов стороной A */
     /* 15E New Sequence */
     println(":15E:");
  else
     /* Блок Sequence F - инструкции по оплате процентов стороной B */
     /* 15F New Sequence */
     println(":15F:");
  end;


    if (PFI == 0)
        ID = ПолучитьКодСубъекта(PercentPMInfo.BankCode, PercentPMInfo.CodeKind);    
        if (ID == "")
            ID = ПолучитьКодСубъекта(PercentPMInfo.BankCode, 3);   
        end;
    else
       ID = ПолучитьКодСубъекта(PercentPMInfo.BankCode, 6);
    end;
  
   if( СделкаПривлечения )
      println(":57D:ACC YOUR INSTRUCTION");
   elif( PFI == 0 )
      println(":57D:/" + PercentPMInfo.Account);
   end;
   if(СделкаПривлечения OR ( PFI == 0 ))
     if(PFI == 0)
         println("BIC " + swkod(ID, 3));
         if( notrez != "X" )
            println("CA " + PercentPMInfo.CorrAccount); 
         else
            println("CA " + PercentPMInfo.Account); 
         end;
         if( (notrez == "X") and (ID == PartyID) )
         else
            var INN = 0;
            if( СделкаПривлечения )
                INN = swkod(PartyID, 16); 
            else
                INN = swkod(ID, 16);
            end;
            if (INN != 0)
                println("INN " + INN);
            end;
         end;
     else
        ЗаписатьБанкЛог( "57d", _SelfID, 6, IIF(PercentPMInfo.CorrCodeSwift != "",PercentPMInfo.CorrCodeSwift, PercentPMInfo.BankCode), "",u44 );
     end;
   end;
   /* 57a - Receiving Agent - куда банк хочет получить свои проценты */
   if(( PFI != 0 ) AND (not СделкаПривлечения))
      ЗаписатьБанкЛог(  "57a", 
                        _SelfID, 
                        6, 
                        IIF(PercentPMInfo.CorrCodeSwift != "",PercentPMInfo.CorrCodeSwift, PercentPMInfo.BankCode), 
                        "",
                        IIF(PercentPMInfo.CorrAccount != "", PercentPMInfo.CorrAccount,execmacrofile("dl_mt.mac", "mm_par", idsd, 11, "receiveraccount")) );
   end;

  ЗаписатьНалог(DealID);

  return TRUE; /* Успешное завершение */

OnError(er) /* обработка ошибок */
  ExeptionMessage(er);
  return FALSE;
end;

macro DV_MsgSWIFT_MT320( DealID:integer, Type:integer, TypeOper:string, Transp ):integer
  var RetVal:integer = 0;
  var ReportFileName, errcode, errtext, CodeSWIFT_Contr;
  FILE ReportOutFile() txt write; /*файл вывода*/
  FILE ReportInFile() txt;

  var que = "select a.t_dealcode,    "+
            "       a.t_bofficekind "+
            "  from ddl_tick_dbt a "+
            " where a.t_dealid = " + DealID;
  var rs = LnGetRecordset(que);
  if( rs != null )
     if( rs.moveNext )
        var DealCode = rs.value(0);
        var DocKind = rs.value(1)
     end;
  end;
  ReportFileName = GetTxtFileName(StrSubst(DealCode, ":", "") + "_MT320");
  if( Open(ReportOutFile, ReportFileName) == false )
     errcode = status(errtext);
     MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
     return 1;
  end;
  SetOutput(ReportFileName);

  message("Печать...");

  PrintCommonMT320(DealID, Type, TypeOper, CodeSWIFT_Contr);

  SetOutput(NULL, true);
  close(ReportOutFile);

  array MenuItems;
  var MenuResult = -2;

  if(GetDialogFlag())
    MenuItems[0] = "Отправить в " + Transp;
    MenuItems[1] = "Печатать сообщение";
    MenuItems[2] = "Отменить";
    MenuResult = Menu(MenuItems, "Выбрать действие");
  else
    MenuResult = 1;
  end;



  if( MenuResult == 1 )
     ViewFile(ReportOutFile);
  elif( MenuResult == 0 )
     var Text;
     var Msg = "";
     Open(ReportInFile, ReportFileName);

     while(next(ReportInFile))
        Msg = Msg + ReportInFile.str+"\n";
     end;
     Msg = Trim(Msg);
     close(ReportInFile);
     if (strlen(@CodeSWIFT_Contr) > 11 )
        msgbox("Код BIC ISO (SWIFT)   (" +  @CodeSWIFT_Contr +  ") имеет некорректную длину (" 
                                          + strlen(@CodeSWIFT_Contr) + ") при максимальной длине 11 символов. Сообщение не сформировано." );
        return 1;
     else

     var exec_send = true;
     runmtedit(@msg, @exec_send);
    
     if(exec_send)
       set_mtsend_flag(1);
       var query = " begin\n ? := RSP_SECURITY.CREATEPAYMFROMSEC(?,?,?,?,?,?,?);\n end; ";
       var cmd = RSDCommand(query);
       cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
       cmd.AddParam("p_KindMes", RSDBP_IN, "MT320");
       cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
       cmd.AddParam("p_Msg", RSDBP_IN, Msg);
       cmd.AddParam("p_BIC", RSDBP_IN, @CodeSWIFT_Contr);
       cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, Text);
       cmd.AddParam("p_Transp", RSDBP_IN, Transp);
       cmd.AddParam("p_DocKind", RSDBP_IN, DocKind);
       cmd.Execute();
       var stat = SQL_ConvTypeInteger(cmd.value("p_Stat"));
       Text = SQL_ConvTypeInteger(cmd.value("p_Text"));
       MsgBox(Text);
     else
       MsgBox("отмена отправки.");
       set_mtsend_flag(0);
     end;
  end;
  end;

  return RetVal;
onError(er)
 msgbox("Невозможно сформировать сообщение. Проверьте корректность параметров сделки и сторон по ней.");

end;

macro DV_MsgSWIFT_MT320FromMenu( DealID:integer, TypeOper:string ):integer
  var Transp;
  array MenuItems;
  MenuItems[0] = "Подтверждение сделки";
  MenuItems[1] = "Погашение";
  MenuItems[2] = "Пролонгация";

  var MenuResult = Menu(MenuItems, "Выбрать действие");
  var Type;

  if( MenuResult == 0 )
     Type = 1;
  elif( MenuResult == 1 )
     Type = 2;
  elif( MenuResult == 2 )
     Type = 3;
  end;
  getTransportFromDeal(DealID, @transp);
  DV_MsgSWIFT_MT320( DealID, Type, TypeOper, Transp);

end;

macro DV_DealsGenMesMT320Paym( DealID );
  var Type, Transp; 
  if( ПРОЛОНГАЦИЯ(DealID) > 0 )
     Type = 3;
  else
     Type = 1;
  end;
  getTransportFromDeal(DealID, @transp);
  DV_MsgSWIFT_MT320( DealID:integer, Type:integer, "", Transp );
end;
