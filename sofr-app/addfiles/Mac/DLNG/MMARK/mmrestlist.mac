///*-------------------------------------------------------------------------
//  Имя файла        : mmrestlist.mac
//
//  Описание         : макрос "Список остатков по датам для счета процентов"
//
//  Программист      : Куперин М.В.
//
//  Создан           : 03.07.2008
//-------------------------------------------------------------------------*/
//IMPORT RSD, MmarkInter, mmcnst_j, mmcateg, mmcarry, mmlb_j;
//
//PRIVATE CONST 
//       PC_ACCOUNT_RUB  = 1001,   // Рублевые счета
//       PC_ACCOUNT_CUR  = 1002,   // Валютные счета
//       PC_OBACC_RUB    = 1011,   // Рублевые внебалансовые счета
//       PC_OBACC_CUR    = 1012;   // Валютные внебалансовые счета
//       
//PRIVATE VAR
//	Massive = TArray,
//	FDoc;
//
//CLASS RestList(DateInit, RestInit)
//  VAR
//      RestDate = Date(0, 0, 0),
//      Rest = MoneyL(0);
//
//  RestDate = DateInit;
//  Rest = MoneyL(RestInit);
//END;
//
//PRIVATE MACRO MKrest_Perc(pBD, pED, acc)
//  VAR 
//      ObjType, DataSet, 
//      numAcc = 0, Massive1, 
//      MassiveSave = TArray, sizemassive,
//      data1, data2, 
//      i = 0, imass = 0;
//
//  DataSet = TRsbDataSet("select InAD.t_account as acc from dmcaccdoc_dbt InAD, dmccateg_dbt InCat where "
//                         "(InAD.t_DocKind = "+ DL_IBCDOC +") and "
//                         "(InAD.t_DocID = "+ FDoc.tick.rec.DealID +") and "
//                         "(InAD.t_CatID = InCat.t_ID)and(InCat.t_Code = '"+ tdr_mainrest +"')"
//                         " order by InAD.t_ID");
//
//  if (acc.FIID ==NATCUR)
//      ObjType = PC_ACCOUNT_RUB;
//  else
//      ObjType = PC_ACCOUNT_CUR;
//  end;
//  
//  while (DataSet.MoveNext)
//      Massive1 = MM_PcMakeUpRestListForAccount(pBD, pED, acc.autokey, ObjType, DataSet.Acc);
//
//      if (ValType(Massive1) == V_UNDEF)
//          Massive1 = TArray;
//      end;
//
//      MassiveSave = TArray;
//      sizemassive = max(Massive1.size, Massive.size);
//
//	  i = 0;
//	  imass = 0;
//      while (i < sizemassive)
//          data1 = data2 = date(0,0,0);
//          if (Massive1[i])
//              data1 = Massive1[i].RestDate;
//          end;
//          if (Massive[i])
//              data2 = Massive[i].RestDate;
//          end;
//          if ((data1 != date(0,0,0))or(data2 != date(0,0,0)))
//              if ((data1 != date(0,0,0))and(data2 == date(0,0,0)))
//                  MassiveSave[imass] = Massive1[i];
//                  imass = imass + 1;
//              elif ((data1 == date(0,0,0))and(data2 != date(0,0,0)))
//                  MassiveSave[imass] = Massive[i];
//                  imass = imass + 1;
//              elif (data1 == data2)
//                  MassiveSave[imass] = RestList(data1, Massive1[i].Rest + Massive[i].Rest);
//                  imass = imass + 1;
//              elif (data1 > data2)
//                  MassiveSave[imass] = Massive1[i];
//                  MassiveSave[imass+1] = Massive[i];		  
//                  imass = imass + 2;
//              elif (data1 < data2)
//                  MassiveSave[imass] = Massive[i];
//                  MassiveSave[imass+1] = Massive1[i];
//                  imass = imass + 2;
//              end;
//          end;
//          i = i + 1;
//      end;
//
//      Massive = MassiveSave;
//
//      Massive1.size = 0;
//      numAcc = numAcc + 1;
//  end;
//
//  if (numAcc == 0)
//      Massive1[0] = RestList(pED, 0);
//  end;
//
//  return true;
//END;
//
//PRIVATE MACRO MKrest_Exp(pBD, pED, acc)
//  VAR 
//      isR = MM_IsDSF(FDoc.tick.rec.DealType),
//      Account, CatCode, ObjType;
//
//  if(isR)
//      CatCode = tdr_exprestR;
//  else
//      CatCode = tdr_exprestP;
//  end;
//
//  if (not СчетСделки(CatCode, FDoc, Account))
//      return false;
//  end;
//
//  if (acc.FIID ==NATCUR)
//      ObjType = PC_ACCOUNT_RUB;
//  else
//      ObjType = PC_ACCOUNT_CUR;
//  end;
//
//  Massive = MM_PcMakeUpRestListForAccount(pBD, pED, acc.autokey, ObjType, Account);
//
//  return true;
//END;
//
//PRIVATE MACRO MKrest_Exppc(pBD, pED, acc)
//  VAR 
//      isR = MM_IsDSF(FDoc.tick.rec.DealType),
//      Account, CatCode, CatCodeVB, ObjType,
//      Massive1, Massive2,
//      i = 0, sizemassive = 0,
//      data1, data2, imass = 0;
//
//  if(isR)
//      CatCode = tdr_exppercR;
//      CatCodeVB = tdr_expperc_vb;
//  else
//      CatCode = tdr_exppercP;
//  end;
//
//  if (not СчетСделки(CatCode, FDoc, Account))
//      return false;
//  end;
//
//  if (acc.FIID==NATCUR)
//      ObjType = PC_ACCOUNT_RUB;
//  else
//      ObjType = PC_ACCOUNT_CUR;
//  end;
//
//  Massive1 = MM_PcMakeUpRestListForAccount(pBD, pED, acc.autokey, ObjType, Account);
//
//  if (ValType(Massive1) == V_UNDEF)
//      Massive1 = TArray;
//  end;
//
//  if (CatCodeVB)
//      if (not СчетСделки(CatCodeVB, FDoc, Account))
//          return false;
//      end;
//    
//      if (acc.FIID==NATCUR)
//          ObjType = PC_OBACC_RUB;
//      else
//          ObjType = PC_OBACC_CUR;
//      end;
//    
//      Massive2 = MM_PcMakeUpRestListForAccount(pBD, pED, acc.autokey, ObjType, Account);
//  end;
//
//  if (ValType(Massive2) == V_UNDEF)
//      Massive2 = TArray;
//  end;
//
//  sizemassive = max(Massive1.size, Massive2.size);
//
//  while (i < sizemassive)
//      data1 = data2 = date(0,0,0);
//      if (Massive1[i])
//          data1 = Massive1[i].RestDate;
//      end;
//      if (Massive2[i])
//          data2 = Massive2[i].RestDate;
//      end;
//      if ((data1 != date(0,0,0))or(data2 != date(0,0,0)))
//          if ((data1 != date(0,0,0))and(data2 == date(0,0,0)))
//              Massive[imass] = Massive1[i];
//              imass = imass + 1;
//          elif ((data1 == date(0,0,0))and(data2 != date(0,0,0)))
//              Massive[imass] = Massive2[i];
//              imass = imass + 1;
//          elif (data1 == data2)
//              Massive[imass] = RestList(data1, Massive1[i].Rest + Massive1[i].Rest);
//              imass = imass + 1;
//          elif (data1 > data2)
//              Massive[imass] = Massive1[i];
//              Massive[imass+1] = Massive2[i];		  
//              imass = imass + 2;
//          elif (data1 < data2)
//              Massive[imass] = Massive2[i];
//              Massive[imass+1] = Massive1[i];
//              imass = imass + 2;
//          end;
//      end;
//      i = i + 1;
//  end;
//  
//  return true;
//END;
//
//MACRO MKrest_PmTmp(pED)
//  VAR i = 0, Amount = 0, data,
//       pmp = TRecHandler( "pmpaym.dbt"),
//       DataSet = TRsbDataSet("select t_tmppaymentid as pID from dpmpaym_tmp where (t_dockind = " + DL_IBCDOC + ")and"
//                           "((t_purpose = " + PM_PURP_PRINC + ")or(t_purpose = " + PM_PURP_PRINC_RET + ")) order by t_purpose");
//  while (DataSet.MoveNext)
//      if (FindPayment (DataSet.pID, NULL, NULL, NULL, NULL, false, pmp))
//          return false;
//      end;
//
//      if ((pmp.rec.ValueDate > pED)or(not pmp.rec.IsPlanPaym))
//          continue;
//      end;
//
//	  if (pmp.rec.Purpose == PM_PURP_PRINC)
//	      data = pmp.rec.ValueDate+1;
//          if (data > pED)
//              Amount = 0;
//	          data = pED;
//          else
//              Amount = Amount + pmp.rec.Amount;
//          end;
//      elif ((pmp.rec.Purpose == PM_PURP_PRINC_RET) and 
//            (pmp.rec.PaymStatus!=PM_PROLONGATED) and 
//            (pmp.rec.PaymStatus!=PM_CLOSEDBYPROLONGATION))
//
//            data = pmp.rec.ValueDate+1;
//            if (data > pED)
//                continue;
//            else
//                Amount = Amount - pmp.rec.Amount;
//            end;
//      end;
//
//       if (Amount < 0)
//           Amount = 0;
//	   end;
//
//       Massive[Massive.size] = RestList(data, Amount);
//	  
//      i = i + 1;
//  end;
//
//  if (i == 0)
//      return false;
//  end;
//
//  return true;
//END;
//
//MACRO MakeRestList(pBD, pED, accID, DealID, isTmp)
//  VAR 
//      cmd, DataSet;
//
//  Massive.size = 0;
//
//  if (accID > 0)
//      cmd = "select * FROM dpcacc_dbt pcacc " +
//             " WHERE pcacc.t_autoKey = " + accID;
//     
//      DataSet = TRsbDataSet(cmd);
//      if(not DataSet.MoveNext)
//          return false;
//      end;
//     
//      FDoc = MMFirstDoc(DL_IBCDOC, DealID);
//
//      if (DataSet.objectType == PC_IBC_CON)
//          if (isTmp)
//              if (not MKrest_PmTmp(pED)) return false; end;
//          else
//              if (not MKrest_Perc(pBD, pED, DataSet)) return false; end;
//          end;
//
//      elif (DataSet.objectType == PC_IBC_CON_EXP)
//          if (not MKrest_Exp(pBD, pED, DataSet)) return false; end;
//      elif (DataSet.objectType == PC_IBC_CON_EXPPC)	  
//          if (not MKrest_Exppc(pBD, pED, DataSet)) return false; end;
//      else return false
//      end;
//  else
//      if (not MKrest_PmTmp(pED)) return false; end;
//  end;
//  
//  return Massive;
//END;
