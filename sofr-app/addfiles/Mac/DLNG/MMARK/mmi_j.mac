/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 5.1                                          R-Style Software Lab

  Programmer  : Сабитов Р.Р.
  Description : Инициализация операции сделки МБК
  Comment     :
  LKL  04/05/2018 SubordDeposit 
└───────────────────────────────────────────────────────────────────────────*/
/*----------------------------------------------------------------------------
    Шаг настроек
----------------------------------------------------------------------------*/
 import globals, mmlibr,funk,dl_plib,"cb_sql.mac";
 import oralib, likepy, "dl_lib.mac", dealinfo, fiinter;
 record tick( dl_tick );

macro ЕстьОбеспечение(dealID)
   var query, data;
   query = DL_RSDCommand("select * from ddl_grnt_dbt where t_dealid = ?");
   query.AddParam(dealID);
   data = query.Execute();
   if (data.Movenext)
     return true;
   else
     return false;
   end;
end;

//Simanov. Найти базис ГС по сделке
private macro GetBasisGS (genagr, fiid)
  var basis = 0;
  var sql = "select t_basis from ddl_gabasis_dbt where t_genagrid = :genagr and t_pfi = :fiid";
  sql = ExecSqlSelect(sql, MakeArray(SqlParam("genagr", genagr), SqlParam("fiid", fiid)));
  if (sql.Movenext() )
    basis = sql.value(0);
  end;
  return basis;
onerror()
  return 0;
End;

private macro GetBasisName (basis)
  var BasisName = "Базис не обнаружен";
  var sql = ExecSqlSelect("select t_sznamealg from dnamealg_dbt where t_itypealg = 2303 and t_inumberalg = " + basis);
  if (sql.Movenext() )
    BasisName = sql.value(0);
  end;
  return BasisName;
onerror()
  return "Базис не обнаружен";
End;

//Simanov. Ставка по сделке
private macro mm_Get_rate(dealid);
  var rate = 0;
  var sql = ExecSqlSelect("select t_price * power(10, -t_point) / t_scale * 100 t_rate from ddl_leg_dbt where t_legid = 1 and t_legkind = 0 and t_dealid = " +dealid);
  if (sql.Movenext() )
    rate = sql.value(0);
  end;
  return rate;
onerror()
  return 0;
  
end;

private macro SetPaymAgent(PaymAgent, dealid)
   var ExecSql = "Update ddl_tick_dbt set t_paymagent = " + PaymAgent + " where t_dealid = " + dealid;
   if ( Opr_ExecSQLQuery( ExecSql, "") )
     msgbox( "Ошибка при обновлении поля ""Платежный агент""." );
     return 1;
   end;
end;

MACRO ExecuteParamStep(OperationKind, DocKind, Document)

    SetBuff( tick, Document );


//LKL
    private var d_curdate={curdate};
    FILE leg (dl_leg);
    leg.LegKind = LEG_KIND_DL_TICK;
    leg.DealID = tick.DealID;
    leg.LegID = 1;
    private var GroupID, AttrID, ErrCode, query, data; //SVE
    if (not GetEq(leg))
        mm_error ("Не найден транш сделки");
        return 1;
    end;

    if ( (Index(tick.usertypedoc, MM_USER_TYPE_SUBORDDEPOSIT)>0 ) and ((leg.Duration - 365*5) <= 0) )  //LKL MM_USER_TYPE_SUBORDDEPOSIT - Заведен пользовательский тип сделки и определен в mmlibr.mac
        msgbox("Срок сделки менее пяти лет не допустим!");
        return 1;
    end ;

//~LKL

//SVE
    GroupID = 103;
    if ( (tick.dealtype == 32300) or (tick.dealtype == 32305) )
       AttrID = 1;
       ConnectObjAttr(ErrCode, OBJTYPE_MMARKDEAL, uniID(tick, OBJTYPE_MMARKDEAL), GroupID, AttrID, NULL, "", {curdate});
       return 0;
    end;

    GroupID = 104;
    if ( ((tick.dealtype == 12305) or (tick.dealtype == 32305)) and (tick.typedoc == "D") )
       AttrID = 12;
       ConnectObjAttr(ErrCode, OBJTYPE_MMARKDEAL, uniID(tick, OBJTYPE_MMARKDEAL), GroupID, AttrID, NULL, "", {curdate});
    elif ( ((tick.dealtype == 12305) or (tick.dealtype == 32305)) and (tick.typedoc != "D") )
       AttrID = 13;
       ConnectObjAttr(ErrCode, OBJTYPE_MMARKDEAL, uniID(tick, OBJTYPE_MMARKDEAL), GroupID, AttrID, NULL, "", {curdate});
    elif (tick.dealtype == 12335)
       AttrID = 14;
       ConnectObjAttr(ErrCode, OBJTYPE_MMARKDEAL, uniID(tick, OBJTYPE_MMARKDEAL), GroupID, AttrID, NULL, "", {curdate});
    end;

    GroupID = 105;
    if ( ((tick.dealtype == 12300) or (tick.dealtype == 32300)) and (tick.typedoc == "D") )
       AttrID = 4;
       ConnectObjAttr(ErrCode, OBJTYPE_MMARKDEAL, uniID(tick, OBJTYPE_MMARKDEAL), GroupID, AttrID, NULL, "", {curdate});
    elif ( ((tick.dealtype == 12300) or (tick.dealtype == 32300)) and (tick.typedoc != "D") )
       AttrID = 5;
       ConnectObjAttr(ErrCode, OBJTYPE_MMARKDEAL, uniID(tick, OBJTYPE_MMARKDEAL), GroupID, AttrID, NULL, "", {curdate});
    end;

    GroupID = 106;
    if ( ((tick.dealtype == 12300) or (tick.dealtype == 32300)) and (SubStr(tick.dealcode, 1, 4) == "IAM:") )
       AttrID = 6;
       ConnectObjAttr(ErrCode, OBJTYPE_MMARKDEAL, uniID(tick, OBJTYPE_MMARKDEAL), GroupID, AttrID, NULL, "", {curdate});
    elif ( ((tick.dealtype == 12300) or (tick.dealtype == 32300)) and (SubStr(tick.dealcode, 1, 4) != "IAM:") )
       AttrID = 8;
       ConnectObjAttr(ErrCode, OBJTYPE_MMARKDEAL, uniID(tick, OBJTYPE_MMARKDEAL), GroupID, AttrID, NULL, "", {curdate});
    elif ( ((tick.dealtype == 12300) or (tick.dealtype == 32300)) and (tick.partyid == _BANK_RF) )
       AttrID = 3;
       if (ЕстьОбеспечение(tick.dealid))
          AttrID = 1;
          ConnectObjAttr(ErrCode, OBJTYPE_MMARKDEAL, uniID(tick, OBJTYPE_MMARKDEAL), GroupID, AttrID, NULL, "", {curdate});
       else
          ConnectObjAttr(ErrCode, OBJTYPE_MMARKDEAL, uniID(tick, OBJTYPE_MMARKDEAL), GroupID, AttrID, NULL, "", {curdate});
       end;
    elif ( ((tick.dealtype == 12300) or (tick.dealtype == 32300)) and (tick.partyid == 857) and (ЕстьОбеспечение(tick.dealid)) ) //МСП БАНК
       AttrID = 2;
       ConnectObjAttr(ErrCode, OBJTYPE_MMARKDEAL, uniID(tick, OBJTYPE_MMARKDEAL), GroupID, AttrID, NULL, "", {curdate});
    elif ( ((tick.dealtype == 12305) or (tick.dealtype == 32305)) and (SubStr(tick.dealcode, 1, 4) == "IAM:") )
       AttrID = 5;
       ConnectObjAttr(ErrCode, OBJTYPE_MMARKDEAL, uniID(tick, OBJTYPE_MMARKDEAL), GroupID, AttrID, NULL, "", {curdate});
    elif ( ((tick.dealtype == 12305) or (tick.dealtype == 32305)) and (SubStr(tick.dealcode, 1, 4) != "IAM:") )
       AttrID = 7;
       ConnectObjAttr(ErrCode, OBJTYPE_MMARKDEAL, uniID(tick, OBJTYPE_MMARKDEAL), GroupID, AttrID, NULL, "", {curdate});
    elif ( (tick.dealtype == 12310) or (tick.dealtype == 12335) )
       AttrID = 4;
       ConnectObjAttr(ErrCode, OBJTYPE_MMARKDEAL, uniID(tick, OBJTYPE_MMARKDEAL), GroupID, AttrID, NULL, "", {curdate});
    end;

    GroupID = 107;
    AttrID = 11;
    ConnectObjAttr(ErrCode, OBJTYPE_MMARKDEAL, uniID(tick, OBJTYPE_MMARKDEAL), GroupID, AttrID, NULL, "", {curdate});
//--SVE
    /*SVE обновление наименование платежей для сделок ТФ*/
    if ((tick.dealtype == 12335) or (tick.dealtype == 12310))
      query = "select t_paymentid, t_purpose from dpmpaym_dbt where t_documentid = " + tick.dealid;
      data = LnGetRecordSet(query);
      while (data.MoveNext())
        if (data.value(1) == 9) //Обновление назвначение платежа по Привлечению средств
          opmpr(data.value(0), tick.dealid, 9);
        elif (data.value(1) == 10) //Обновление назвначение платежа по  ОД
          opmpr(data.value(0), tick.dealid, 10);
        elif (data.value(1) == 11) //Обновление назвначение платежа по  Процентам
          opmpr(data.value(0), tick.dealid, 11);
        end;
      end;
    end;

    /*SVE DEF-26282 для того чтобы дистрибутивные функции по определению КУ не ломались для сделок ТФ добавим новое значение t_FlagTypeDeal чтобы определять такие сделки*/
    if ((tick.DealType == 12310) or (tick.DealType == 12335))
       query = "update ddl_tick_dbt set t_isTradeFinance = chr(88), t_FlagTypeDeal = 6 where t_dealid = " + tick.DealID;
       data = LnGetRecordSet(query);
    end;

    //Проверка процентов по сделке, кроме овердрафта
	/*
    if ( (tick.dealtype != 12301) and (tick.GenAgrID > 0) )
      var basis = GetBasisGS(tick.GenAgrID, leg.PFI);
      var price = mm_Get_rate(tick.DealID);
      var str = "";
      var CalcPercent = $0;
      
      if (basis != 0)
        CalcPercent = round(РасчётПроцентнойСтавки( leg.principal, leg.Start, leg.Maturity, price, basis), 2);

        if (CalcPercent != leg.Cost) 
           str = "Не совпадает расчет и данные по сделке по процентам. \n"
               + "Базис по ГС: " + GetBasisName(basis) + ". Базис по сделке: " + GetBasisName(leg.basis) + "\n"
               + "Расчет %% = " + CalcPercent + ". По сделке % = " + leg.Cost;
        end;
      else 
        str = "По данному ГС не заполнен базис в валюте "+ПолучитьИмяФинИн(leg.pfi)+"!\n Пожалуйста, заполните базис, чтобы можно было сверить проценты по сделке!";
      end;
     
      if (str != "")
        if (MsgBoxEx(str+"\nПродолжить обработку сделки?", MB_NO+MB_YES, IND_NO) == IND_YES)
          return 0;
        else
          return 1;
        end;
      end;
    end;*/

    if (tick.PaymAgent == -1)                 //SVE 500977
      SetPaymAgent(tick.PartyId, tick.DealId);
    end;
		

    return 0;
END;


MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -откат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */  

  private var leg  = Tbfile( "dl_leg.dbt");

  private var que,rs1,rs9,rs,idsd,dstart,ku,price,sum0;
  SetBuff(tick, FirstDoc );

  
  if ( CommitOrRollback == 1 )
      idsd=tick.dealid;
      //execmacrofile("dl_mt.mac", "Kontr320n",idsd) ;       //SVE
      //execmacrofile("dl_kat.mac", "CHD",tick.dealid) ;     //SVE

      if ( tick.flag1 == "X" )
        execmacrofile("dl_nprol.mac", "ex99",FirstDoc) ;
      end;


      que = "select *  from ddl_leg_dbt  where t_dealid ="+idsd;
      rs1 = LnGetRecordSet(que);
      if (rs1 != null)
         while (rs1.moveNext())
           CopyRSetToFBuff(leg, rs1 ) ;
           dstart=СДАТ(leg.rec.start);
         end;
      end;
         
      if (tick.partyid == 12875)               //SVE подмена корр. схемы для БИЛЬБАО  
         var query, bankid, corschem, payments, paymentid, purpose;
         query = "select t_receiverbankid from dpmpaym_dbt where t_dockind = 102 and t_purpose = 9 and t_documentid = " + tick.dealid;      //SVE Для того чтобы найти нужную корр. схему берем код ситибанка из платежа по предоставлению средств
         bankid = LnGetRecordSet(query);
         if (bankid.MoveNext)
            query = "select t_number from dcorschem_dbt where t_fiid = " + leg.rec.pfi + " and t_corrid = " + bankid.value(0);
            corschem = LnGetRecordSet(query);
            if (corschem.MoveNext)
               query = "select t_paymentid, t_purpose from dpmpaym_dbt where t_dockind = 102 and t_documentid = " + tick.dealid + " ORDER BY t_paymentid";
               payments = LnGetRecordSet(query);
               while (payments.MoveNext)          //SVE отобрали платежи и отсортировали так чтобы они шли в порядке: предоставление средств, погашение ОД, проценты
                  paymentid = payments.value("t_paymentid");
                  purpose = payments.value("t_purpose");            
                  if (tick.dealtype == 12305)     //SVE для размещения платеж по предоставлению средств имеет исходящую корр. схему
                     if (purpose == 9)                  
                        query = "update dpmprop_dbt SET  t_corschem = " + corschem.value(0) + "  where t_DebetCredit = 1 and  t_paymentid = " + paymentid;
                     else
                        query = "update dpmprop_dbt SET  t_corschem = " + corschem.value(0) + "  where t_DebetCredit = 0 and  t_paymentid = " + paymentid;
                     end;
                  end;
                  rs9 = LnGetRecordSet(query);
               end;       
            end;
         end;
      end;

      sum0=leg.rec.principal;
      que="delete from dstd_pls_dbt where  t_id = "+idsd;
      rs9 = LnGetRecordSet(que);

      que="select count(*)  from dstd_pls_dbt where  t_id = "+idsd;
      rs9 = LnGetRecordSet(que);
      if(rs9 != null)
        if (rs9.moveNext) 
           if ( rs9.value(0) == 0 )
              ku=double("1"+substr("0000000000",1,leg.rec.point));
              price=leg.rec.price/ku;
              que = "INSERT INTO dstd_pls_dbt Values("+idsd+",'"+dstart+"',"+(price*1000000)+","+price+")";
              rs = LnGetRecordSet(que);
           end;
        end;
      end;

      que="select count(*) from ddl_genagr_dbt where t_partyid="+tick.partyid+" and t_dockind=4611 and trim(t_comment)='TELEX'";
      rs9 = LnGetRecordSet(que);
      if(rs9 != null)
        if (rs9.moveNext) 
           if ( rs9.value(0) > 0 )
              que = "update ddl_tick_dbt set t_numberpack=99, t_conftpid=0  where t_dealid="+tick.dealid;
              rs = LnGetRecordSet(que);
           end;
        end;
      end;

      if (leg.rec.duration == 1 )
        que="select count(*)  from ddl_genagr_dbt where t_partyid="+tick.partyid+"  and  t_dockind=4611  and t_kind_operation=12320 and (t_start+t_duration) >= to_date('"+СДАТ({curdate})+"')";
        rs9 = LnGetRecordSet(que);
        if(rs9 != null)
          if (rs9.moveNext) 
             if ( rs9.value(0) > 0 )
               que = "update ddl_tick_dbt set t_autoplacement='X', t_flagtypedeal=1  where t_dealid="+tick.dealid;
               rs = LnGetRecordSet(que);
             end;
          end;
        end;
      end;

  end;

  return 0;
END;

