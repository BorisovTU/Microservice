/*
$Name:        mmpprlng_j.mac
$Module:      МБ Кредиты
$Description: макрос выполнения шага "Исполнение исходящих платежей"
*/
IMPORT mmlibr, MmarkInter, OprInter, InsCarryDoc, mmpaymentcls;

/* Инициализируется бэк-офисом */
PRIVATE VAR NewDealID;   /*Номер пролонгирующей сделки*/

PRIVATE VAR
    ID_Operation = 0,
    ID_Step      = 0,
    ExecDate;

PRIVATE MACRO FindPaymIDByPurpose (DealID, purp)
    var DataSet = TRsbDataSet("SELECT pm.t_PaymentID as PaymentID FROM dpmpaym_dbt pm " +
        " WHERE pm.t_DocKind = 102 and pm.t_DocumentID = " + DealID +
            " and pm.t_Purpose = " + purp + " and pm.t_IsPlanPaym = 'X' and pm.t_PaymStatus in (1000, 0)");
    if(DataSet.MoveNext())
       return DataSet.PaymentID;
    end;
    return 0;
end;

// Выполнение шага
PRIVATE MACRO ExecuteStep(Buffer, Document, DocKind, IDOperation, IDStep)
    var
        idx = 0;
    record deal( dl_tick );
    SetBuff( deal, Document );

    ID_Operation = IDOperation;
    ID_Step      = IDStep;
    ExecDate     = {curdate};

    var Payment, NewPayment, PaymentID, 
    IP_id = TArray,
    IPtype = TArray,
    PP_id = TArray,
    PPtype = TArray;

    var deal_pd = MMFirstDoc (DL_IBCDOC, deal.DealID, true); // пролонгируемая (текущая) сделка
    var nd_pd   = MMFirstDoc (DL_IBCDOC, NewDealID,   true); // пролонгирующая сделка
    // найти платеж по погашению ОД
    PaymentID = FindPaymIDByPurpose (deal.DealID, PM_PURP_PRINC_RET);
    if (not PaymentID)
        mm_error( "Не удалось найти платеж по предоставлению средств по пролонгируемой сделке" );
        return 1;
    end;
    Payment = RsbPayment(PaymentID);
    if (deal_pd.GetLeg().Principal == nd_pd.GetLeg().Principal)
        Payment.PaymStatus = PM_CARRYED_OUT_TO_PROLONG;
        Payment.Update();
    elif (deal_pd.GetLeg().Principal > nd_pd.GetLeg().Principal)
        var MMPaym = MM_RsbPayment(MMPAYM_CREATEBYPAYMOBJ, Payment, 0, deal_pd.GetLeg().Principal - nd_pd.GetLeg().Principal, Payment.ValueDate);
        NewPayment = MMPaym.Payment;
        NewPayment.OrderAmount    = 
        NewPayment.PayerAmount    = 
        NewPayment.ReceiverAmount = 
        NewPayment.BaseAmount     = deal_pd.GetLeg().Principal - nd_pd.GetLeg().Principal;
        NewPayment.PaymStatus     = PM_READIED;
        NewPayment.Actuate();

        Payment.OrderAmount    = 
        Payment.PayerAmount    = 
        Payment.ReceiverAmount = 
        Payment.BaseAmount     = nd_pd.GetLeg().Principal;
        Payment.Actuate();
        Payment.Update();
        Payment.PaymStatus     = PM_CARRYED_OUT_TO_PROLONG;
    end;

    return 0;
END;

NameMacroFile = "mmpprlng_j.mac";
