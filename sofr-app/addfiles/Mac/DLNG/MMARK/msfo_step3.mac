/*
$Name:        msfo_step3.mac
$Module:      МБ Кредиты
$Description: макрос выполнения шага "2.4 Перенос процентов по сделкам размещения с внебаланса на баланс"
*/
/*-------------------------------------------------------------------------
  Имя файла        : msfo_step3.mac

  Описание         : макрос выполнения шага "2.4 Перенос процентов по сделкам размещения с внебаланса на баланс"

  Программист      : Терещенко Ф.С.

  Создан           : 16.11.2018
-------------------------------------------------------------------------*/

import mmlibr, MoCommon, mctplprm;

VAR count = 0;

VAR rs_cnt = RsdRecordset(
"SELECT COUNT(1) "+
 " FROM DDL_TICK_DBT d1  "+
 " JOIN DDL_LEG_DBT  d2 ON (D1.T_DEALID     = D2.T_DEALID) "+
 " JOIN DOPROPER_DBT d3 ON (D3.T_DOCUMENTID = LPAD(d1.T_DEALID, 34, '0') AND D3.T_KIND_OPERATION = D1.T_DEALTYPE AND D3.T_DOCKIND = D1.T_BOFFICEKIND)  "+
" WHERE d1.T_BOFFICEKIND IN (102, 208) AND d1.T_DEALSTATUS IN (0, 10) AND D2.T_LEGKIND = 0 AND D2.T_LEGID = 1");

rs_cnt.moveNext(); count = rs_cnt.Value(0, NULL, V_INTEGER);
InitProgress(count, "Сделок обработано...", "Открытие счетов");
count = 0;

VAR rs = RsdRecordset(
"SELECT d1.T_DEALID, d1.T_DEALCODE, d1.T_DEALGROUP, d1.T_BOFFICEKIND, d1.T_DEALTYPE, d1.T_FLAGTYPEDEAL, d1.T_PARTYID, d1.T_DEALSTATUS, d2.T_DURATION, D3.T_ID_OPERATION "+
 " FROM DDL_TICK_DBT d1  "+
 " JOIN DDL_LEG_DBT  d2 ON (D1.T_DEALID     = D2.T_DEALID) "+
 " JOIN DOPROPER_DBT d3 ON (D3.T_DOCUMENTID = LPAD(d1.T_DEALID, 34, '0') AND D3.T_KIND_OPERATION = D1.T_DEALTYPE AND D3.T_DOCKIND = D1.T_BOFFICEKIND)  "+
" WHERE d1.T_BOFFICEKIND IN (102, 208) AND d1.T_DEALSTATUS IN (0, 10) AND D2.T_LEGKIND = 0 AND D2.T_LEGID = 1");

WHILE (rs.moveNext())
   VAR DealID  = rs.Value("T_DEALID");

   VAR ObjType = 0;
   IF (rs.Value("T_BOFFICEKIND") == 102)
      ObjType = OBJTYPE_MMARKDEAL;
   ELSE
      ObjType = OBJTYPE_CREDITLN;
   END;

   // 10 - SPPI-тест
   // 1 ─ Пройден
   // 2 ─ Не пройден
   VAR DealType = 0;
   IF (rs.Value("T_DEALTYPE") == 2300)
      DealType = 1; // Привлечение
   ELIF  (rs.Value("T_DEALTYPE") == 2305)
      DealType = 2; // Размещение
   END;

   IF ((rs.Value("T_DEALSTATUS") == 10))
      Print("Сделка: " + DealID + "/" + ObjType + "/" + rs.Value("T_DEALCODE"));
      PrintLn(":"+MM_DealExecuteStep(rs.Value("T_DEALID"), "b"));
/*
      VAR ID_Operation : INTEGER = rs.Value("T_ID_OPERATION");
      VAR BranchSymbol : STRING  ="a";
      VAR BranchKind   : STRING  ="I";
      VAR ID_Step      : INTEGER = 0;
      VAR StepSymbol   : STRING  ="b";

      VAR stat = Opr_InsertAndExecuteBranch(ID_Operation, BranchSymbol, BranchKind, ID_Step, StepSymbol);
      IF (stat == 0)
         PrintLn(". Счета успешно открыты");
      ELSE
         VAR cmd = RsdCommand(RslDefCon, "SELECT T_CONTENTS FROM DBANK_MSG WHERE T_NUMBER = ?");
         cmd.AddParam("p1", RSDBP_IN); cmd.Value("p1") = stat;
         cmd.Execute();
         VAR rsm = RsdRecordset(cmd);
         rsm.MoveNext();
         PrintLn(". Ошибка открытия счета №" + stat + ": " + rsm.Value(0));
      END;
*/
   END;

   UseProgress (count = count + 1);
END;

RemProgress (count);