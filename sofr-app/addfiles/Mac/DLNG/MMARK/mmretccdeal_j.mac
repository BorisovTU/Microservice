IMPORT RsbDataSet, mmservop, mmordcr, mmordfd;

MACRO ExecuteStep(Buffer, Document)
    var DataSet = NULL, cmd, , txtflag;

    record tick(dl_tick);

    SetBuff(tick, Document);
    DL_PrepareCarryBuffer (Buffer);

    if (GetOprServDoc().rec.Flag6 == "X")
        txtflag = "= 'X'";
    else
        txtflag = "<> 'X'";
    end;

    cmd = "select ord.* from ddl_order_dbt ord, ddl_grnt_dbt grnt, ddl_tick_dbt tick "    +
          "where grnt.t_DealID = tick.t_DealID and ord.t_ContractID = grnt.t_ContractID " +
          "and tick.t_DealID = " + tick.DealID + " and ord.t_SysTypes = '–' and ord.t_Flag1 " + txtflag;
	
    DataSet = TRsbDataSet(cmd);

    while (DataSet.MoveNext)

        if ((not GetOprServDoc().rec.Flag7)and(not IsCONVERT_RECEIPT(GetOperationGroup (DataSet.Kind_Operation))))
            ;
        elif ((GetOprServDoc().rec.Flag7)and(IsCONVERT_RECEIPT(GetOperationGroup (DataSet.Kind_Operation))))
            ;
        else continue;
        end;

        if (not GetOprServDoc().rec.Flag7)
            if (IsBUY(GetOperationGroup (tick.DealType)))
                if (MM_OrdPledgeExecCarry(RevalTCCSetInledge, DataSet, tick.DealID, GetOprServDoc().rec.CommDate).ExecCarry())
                    return 1;
                else
                    continue;
                end;
            else
                if (MM_OrdPledgeExecCarry(RevalTCCGetInledge, DataSet, tick.DealID, GetOprServDoc().rec.CommDate).ExecCarry())
                    return 1;
                else
                    continue;
                end;
            end;
        else
            if (IsBUY(GetOperationGroup (tick.DealType)))
                if (MM_OrdPledgeSecurExecCarry(RevalTCCSetInledge, DataSet, tick.DealID, GetOprServDoc().rec.CommDate).ExecCarry())
                    return 1;
                else
                    continue;
                end;
            else
                if (MM_OrdPledgeSecurExecCarry(RevalTCCGetInledge, DataSet, tick.DealID, GetOprServDoc().rec.CommDate).ExecCarry())
                    return 1;
                else
                    continue;
                end;
            end;
        end;
    end;

    return 0;
END;

