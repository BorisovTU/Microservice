/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : mmoppmin.mac
  Programmer  : Korolev Sergey
  Description :
  Comment     : макрос инициализации операций залога
  Date        : 30.10.2003
└───────────────────────────────────────────────────────────────────────────*/

MACRO InitOperation( KindOpr, KindDoc, FDoc )

var
    stat = true,
    sec = TBFile("dl_secur");

    RECORD ord(dl_order);
    setbuff( ord, FDoc );

    if (KindOpr == 0)
        msgbox("Не задан вид операции.");
    end;

    if (not ord.flag1)
       msgbox("По этому договору залога не предусмотрено выполнение операции "+ KindOpr +":| флаг 'Обеспечение по договору' в панели договора залога выключен!");
       return 1;
    end;

    // проверка ДЗ, что он имеет ц.б.
    sec.KeyNum = 0;
    sec.rec.ContractKind = ord.DocKind;
    sec.rec.ContractID = ord.ContractID;

    if(GetGE(sec) AND
      (sec.rec.ContractKind == ord.DocKind) AND
      (sec.rec.ContractID == ord.ContractID))
    else
      msgbox("Договор залога не имеет предметов залога.");
      return 1;
    end;

    // проверка того, что ц.б. имеют оценочную стоимость
    while(stat)
        if(sec.rec.Cost)
           stat = Next(sec) AND
                  (sec.rec.ContractKind == ord.DocKind) AND
                  (sec.rec.ContractID == ord.ContractID);
        else
            stat = false;
            msgbox("Ц.Б. договора залога не имеют оценочной стоимости.");
            return 1;
        end;
    end;

    return 0;
END;
