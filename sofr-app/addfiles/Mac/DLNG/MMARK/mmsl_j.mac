/*
$Name: mmsl_j.mac
$Module: МБК
$Description: Макрос выполнение шага "Создание резерва"
*/
IMPORT mmlibr, mmcarry, mmlb_j, mpclb, mmadd_j, mmpaymentcls,dl_lib;

PRIVATE VAR
    ID_Operation = 0,
    ID_Step      = 0;

PRIVATE MACRO GetCorespAcc(FIID, Role)

END;

PRIVATE MACRO LimitAdjustment(deal, FirstDoc)
    // Определение суммы лимита
    var Sl = -1.0, deal_pd, Account;
    if (deal.DebtLimit > 0.0)
        Sl = deal.DebtLimit;
    end;
    if ((deal.IssuanceLimit > deal.DebtLimit) and (deal.DebtLimit > 0.0))
        Sl = deal.DebtLimit;
    elif (deal.IssuanceLimit > 0.0)
        Sl = deal.IssuanceLimit;
    end;

    // Нечего формировать
    if (Sl < 0)
        return 0;
    end;

    deal_pd = MMFirstDoc(deal.BOfficekind, deal.DealID, true);


    if (deal.numberpack == 990 )
       Sl=0;
    end;


    // Формирование проводки
    VAR carry = MM_Carry;
    carry.FIIDPayer    = deal.LimitCur;
    carry.FIIDReceiver = deal.LimitCur;
    carry.Chapter      = 3;
    carry.date_carry   = {curdate};
    carry.PrimaryDoc   = FirstDoc;  
    carry.SumReceiver  = Sl;

    if (isSale(GetOperationGroup(deal.DealType)))
    // размещение
        Account = MC_FindAndOpenCommonAccByFD(tdr_corespacc_vb, deal_pd, {curdate}, 0, MC_OPENACC_CREATE, NULL,deal.LimitCur, 
                                                   NULL, NULL, NULL, FIROLE_CORACC_PASSIVE, NULL, NULL, NULL, NULL, NULL, false, false);
        //carry.CatPayer         = tdr_corespacc_vb;
        //carry.FiRolePayer      = FIROLE_CORACC_PASSIVE;
        carry.AccountPayer     = Account;
        carry.CatReceiver      = tdr_oblP;
        carry.Ground           = MM_ground(deal.dealid,509);
// "Установка лимита по договору КЛ, размещение";
    else
        Account = MC_FindAndOpenCommonAccByFD(tdr_corespacc_vb, deal_pd, {curdate}, 0, MC_OPENACC_CREATE, NULL,deal.LimitCur, 
                                                   NULL, NULL, NULL, FIROLE_CORACC_ACTIVE, NULL, NULL, NULL, NULL, NULL, false, false);
        carry.CatPayer         = tdr_oblR;
        carry.AccountReceiver  = Account;
        //carry.CatReceiver      = tdr_corespacc_vb;
        //carry.FiRoleReceiver   = FIROLE_CORACC_ACTIVE;
        carry.Ground           = MM_ground(deal.dealid,509);
// "Установка лимита по договору КЛ, привлечение";
    end;
    if (not carry.carry())
        mm_error ("Ошибка при формировании проводки");
        return 1;
    end;
    return 0;
END;

// Выполнение шага
PRIVATE MACRO ExecuteStep(Buffer, Document, DocKind, IDOperation, IDStep)
    var
        idx = 0;
    record deal( dl_tick );

    SetBuff( deal, Document );

    ID_Operation = IDOperation;
    ID_Step      = IDStep;

    var deal_pd = MMFirstDoc (deal.BOfficeKind, deal.DealID, true);

    if (CheckExistence(LEG_LegKind_DealID_LegID, LEG_KIND_DL_TICK, deal.DealID, 1))
        mm_error( "Не найден транш сделки ", deal.DealCode );
        return 1;
    end;

    if (LimitAdjustment(deal, deal_pd))
        return 1;
    end;
    return 0;

END;

NameMacroFile = "mmsl_j.mac";
