/*
$Name:        mmrsrv_j.mac
$Module:      МБ Кредиты
$Description: Шаг: Формирование резерва по сделке
*/
/*--------------------------------------------------------------------------------------*/
/*  Имя файла        : mmrsrv_j.mac                                                     */
/*                                                                                      */
/*  Описание         : Шаг: Формирование резерва по сделке                              */
/*                                                                                      */
/*  Программист      : Куперин М.В.                                                     */
/*                                                                                      */
/*  Создан           : 13.11.2009                                                       */
/*--------------------------------------------------------------------------------------*/
IMPORT FIInter, mmservop, mmcateg, mmcarry, mmlb_j, mmcnst_j, SfInter, mmlibr, mctplprm,dl_lib,dl_plib;
/****************************************************************************************/
PRIVATE CONST
    MM_RSRV_TYPE_MMDEAL = 3;

PRIVATE CONST
    AMORT_COST_LINEAR     = 1, /* Оцениваемые по амортизированной стоимости (линейный метод) */
    AMORT_COST_EPS        = 2, /* Оцениваемые по амортизированной стоимости (метод ЭПС) */
    FAIR_VAL_PROFIT_LOSS  = 3, /* Оцениваемые по справедливой стоимости через прибыль или убыток */
    FAIR_VAL_COMPR_INCOME = 4; /* Оцениваемые по справедливой стоимости через прочий совокупный доход */

PRIVATE CONST
    MM_RSRV_ERR_NOPARM       = 11,
    MM_RSRV_ERR_BADQC        = 12,
    MM_RSRV_ERR_ZPERCENT     = 13,
    MM_RSRV_ERR_BADPERC      = 17,
    MM_RSRV_ERR_CONBQC       = 21,
    MM_RSRV_ERR_CONPERC      = 22,
    MM_RSRV_ERR_BADLEG       = 100,
    MM_RSRV_ERR_BADACTACC    = 101,
    MM_RSRV_ERR_BADCARRY     = 102,
    MM_RSRV_ERR_BADREG       = 103;

PRIVATE CONST
    RSRV_PARMS_CONTROL_NONE       = 1, /* без контроля              */
    RSRV_PARMS_CONTROL_EDIT_KKS   = 2, /* контроль и корректировка  */
    RSRV_PARMS_CONTROL_NOEDIT_KKS = 3; /* контроль без корректировки*/

PRIVATE VAR RVPStatus = 0, vari; /* статус пруденциального резерва */

/****************************************************************************************/
PRIVATE CLASS MM_COMISS_C
  var
     ComissType = 0,
     Rest       = $0,
     RestExp    = $0,
     ID         = 0,
     ПРПолн     = false;
END;

PRIVATE CLASS MM_COMISS_R
  var
     Rez        = $0,
     RezExp     = $0;
END;


PRIVATE CLASS MM_RSRVPARM
  var
      Deal_fd     = NULL,
      OprServDoc  = NULL,
      ККС         = 0,
      ПР          = 0,
      // процент резерва 100%
      RopcomFull   = false,
      RpccomFull   = false,

      penny_OD    = 0, 
      penny_perc  = 0,
      RpnODFull   = false,
      RpnPcFull   = false,
      
      // расчетная база, в валюте
      C        = 0,
      C_CHC    = 0,
      Cpc      = 0,
      Cpc_CHC  = 0,
      Cpn      = 0,
      Cкор     = 0,
      Cзатр    = 0,
      
      // комиссии, прочие доходы
      Ccom         = TArray,
      Rcom_new     = TArray,
      Rcom_old     = TArray,
      Racom_new    = TArray,

      // пруденциальный резерв
      С_об        = 0,
      С_вал       = NATCUR,
      Rnew        = 0,
      Rold        = 0,
      R_CHC_new   = 0,
      R_CHC_old   = 0,
      Rpc_new     = 0,
      Rpc_old     = 0,
      Rpc_CHC_new = 0,
      Rpc_CHC_old = 0,
      Rpn_old     = 0,
      Rpn_new     = 0,

      // оценочный резерв
      Ra_new       = 0,
      Ra_CHC_new   = 0,
      Rapc_new     = 0,
      Rapc_CHC_new = 0, 
      Rapn_new     = 0,
      RКОРккст_new = 0,
      RКОРкз_new   = 0;
END;
/****************************************************************************************/

PRIVATE MACRO PrevDlResLnk(TypeBase, Parm, RsrvAmount, RsrvAsAmount)
    VAR
        ResLnk = TRsbDataSet("select t_reserveamount, t_reserveassesamount, t_reservedate " + 
                             "from ddlreslnk_dbt " +
                             "where t_parentid = " + Parm.Deal_fd.GetTick().DealID +
                             " and t_reservedate <= " + "'" + Date(Parm.OprServDoc.rec.CommDate) + "'" +
                             " and t_typebase = " + TypeBase +
                             " and t_ismanual = '0' " +
                             " order by T_RESERVEDATE DESC, T_ID DESC");

    if (ResLnk.MoveNext())
        SetParm(2, ResLnk.ReserveAmount);
        SetParm(3, ResLnk.ReserveAssesAmount);
    end;

    return 0;
END; 

PRIVATE MACRO InsertDlResLnk(TypeBase, Parm, ПризнакКомиссии, ПризнакПросрКомиссии, ИндКомиссии)
    VAR
        reslnk = TBfile("dlreslnk.dbt"),
        PrevRsrvAmount = 0, PrevRsrvAsAmount = 0, i = 0;
        
    reslnk.clear();
    reslnk.rec.ParentID          = Parm.Deal_fd.GetTick().DealID;   // Порождающий документ
    reslnk.rec.ChildID           = Parm.OprServDoc.rec.DocumentID; // Порожденный документ
    reslnk.rec.Type              = MM_RSRV_TYPE_MMDEAL;            // Тип связи
    reslnk.rec.LnkDate           = Parm.OprServDoc.rec.CommDate;   // Дата
    reslnk.rec.QualityCategory   = Parm.ККС;                       // Категория качества
    reslnk.rec.ReservePercent    = Parm.ПР;                        // Процент резерва
    reslnk.rec.SecurityAmount    = Parm.С_об;                      // Сумма обеспечения
    reslnk.rec.SecurityCurrency  = Parm.С_вал;                     // Валюта обеспечения 
    reslnk.rec.ReserveKind       = 1;                              // Вид резерва
    reslnk.rec.ReserveDate       = Parm.OprServDoc.rec.CommDate;   // Дата расчета резерва
    reslnk.rec.Flag1             = Parm.OprServDoc.rec.Flag1;      // Валютная корректировка
    reslnk.rec.IsManual          = 0;                              // Признак пользовательской корректировки
    reslnk.rec.RiseQC            = 0;                              // Повышение ККС
    reslnk.rec.ReserveSubKind    = 0;                              //
    reslnk.rec.TypeBase          = TypeBase;                       // Тип базы расчета

    if (not ПризнакКомиссии)
        reslnk.rec.ComID    = 0;
        reslnk.rec.IsExpCom = "0";
        PrevDlResLnk(TypeBase, Parm, PrevRsrvAmount, PrevRsrvAsAmount);
        if (TypeBase == 1)
            if ((Parm.Rnew == Parm.Rold) and (Parm.Ra_new == PrevRsrvAsAmount))
                return;
            end;
            reslnk.rec.ReserveAmount      = Parm.Rnew;                      // Сумма резерва по ОД
            reslnk.rec.ReserveAssesAmount = Parm.Ra_new;
        elif (TypeBase == 2)
            if ((Parm.R_CHC_new == Parm.R_CHC_old) and (Parm.Ra_CHC_new == PrevRsrvAsAmount))
                return;
            end;
            reslnk.rec.ReserveAmount      = Parm.R_CHC_new;                 // Сумма резерва по просрченному ОД
            reslnk.rec.ReserveAssesAmount = Parm.Ra_CHC_new;
       elif (TypeBase == 3)
            if ((Parm.Rpc_new == Parm.Rpc_old) and (Parm.Rapc_new == PrevRsrvAsAmount))
                return;
            end;
            reslnk.rec.ReserveAmount      = Parm.Rpc_new;                   // Сумма резерва по %%
            reslnk.rec.ReserveAssesAmount = Parm.Rapc_new;
       elif (TypeBase == 4)
            if ((Parm.Rpc_CHC_new == Parm.Rpc_CHC_old) and (Parm.Rapc_CHC_new == PrevRsrvAsAmount))
                return;
            end;
            reslnk.rec.ReserveAmount      = Parm.Rpc_CHC_new;               // Сумма резерва по просроченным %%
            reslnk.rec.ReserveAssesAmount = Parm.Rapc_CHC_new;
       elif (TypeBase == 5)
            if ((Parm.Rpn_new == Parm.Rpn_old) and (Parm.Rapn_new == PrevRsrvAsAmount))
                return;
            end;
            reslnk.rec.ReserveAmount      = Parm.Rpn_new;                   // Сумма резерва по неустойкам (штрафов, пеней)
            reslnk.rec.ReserveAssesAmount = Parm.Rapn_new;
       end;
    // Сумма комиссий (в т.ч. прочих доходов)
    else
        reslnk.rec.ComID = Parm.Ccom[ИндКомиссии].ID;
        if (not ПризнакПросрКомиссии)
            reslnk.rec.IsExpCom           = "0";
            reslnk.rec.ReserveAmount      = Parm.Rcom_new[ИндКомиссии].Rez;
            reslnk.rec.ReserveAssesAmount = Parm.Racom_new[ИндКомиссии].Rez;
        else
            reslnk.rec.IsExpCom           = "1";
            reslnk.rec.ReserveAmount      = Parm.Rcom_new[ИндКомиссии].RezExp;
            reslnk.rec.ReserveAssesAmount = Parm.Racom_new[ИндКомиссии].RezExp;
        end;
    end;

    MM_InsertDLRESLNK(reslnk);
END;
/****************************************************************************************/
PRIVATE MACRO Проводка(ВидРезерва, Parm, ПризнакКомиссии, ПризнакПросрКомиссии, ИндКомиссии)
    VAR
        Delta = 0, Основание = "", 
        СписаниеРезерва = false,
        Категория, КатДебет, КатКредит,
        ФИРоль,
        ФИРольДебет, ФИРольКредит,
        СчетДебет, СчетКредит,
        at = MM_Carry;

    if (not ПризнакКомиссии)
       if (ВидРезерва == 1)
           Delta = Parm.Rnew - Parm.Rold;
           Основание = " по ОД";
           if (IsCLAIMSACQ(GetOperationGroup(Parm.Deal_fd.GetTick().DealType)))
              Категория = get_rmainrest_cm(Parm.OprServDoc.rec.CommDate);
           else
              Категория = tdr_rez_mainrest;
           end;
           if (Parm.Rnew == 0)
               СписаниеРезерва = true;            
           end;
           ФИРоль = FIROLE_RVPS;
       elif (ВидРезерва == 2)
           Delta = Parm.R_CHC_new - Parm.R_CHC_old;
           Основание = " по просроченному ОД";
              Категория = tdr_rez_exprest;
           if (Parm.R_CHC_new == 0)
               СписаниеРезерва = true;
           end;
           ФИРоль = FIROLE_RVPS;
       elif (ВидРезерва == 3)
           Delta = Parm.Rpc_new - Parm.Rpc_old;
           Основание = " по процентам";
           Категория = tdr_rez_perc;
           if (Parm.Rpc_new == 0)
               СписаниеРезерва = true;
           end;
           ФИРоль = FIROLE_RVP;
       elif (ВидРезерва == 4)
           Delta = Parm.Rpc_CHC_new - Parm.Rpc_CHC_old;
           Основание = " по просроченным процентам";
           Категория = tdr_rez_expperc;
           if (Parm.Rpc_CHC_new == 0)
               СписаниеРезерва = true;
           end;
           ФИРоль = FIROLE_RVP;
       elif (ВидРезерва == 5)
           Delta = Parm.Rpn_new - Parm.Rpn_old;
           Основание = " по неустойкам (штрафов, пеней)";
           Категория = tdr_rez_penny;
           if (Parm.Rpn_new == 0)
               СписаниеРезерва = true;
           end;
           ФИРоль = FIROLE_RVP;
       end;
    else
        if (Parm.Ccom[ИндКомиссии].ComissType == 1)
            Основание = " по процентным комиссиям";
        else
            Основание = " по операционным комиссиям";
        end;
        if (ПризнакПросрКомиссии)
            Delta = Parm.Rcom_new[ИндКомиссии].RezExp - Parm.Rcom_old[ИндКомиссии].RezExp;
            if (Parm.Ccom[ИндКомиссии].ComissType == 1)
                if (IsCLAIMSACQ(GetOperationGroup(Parm.Deal_fd.GetTick().DealType)))
                    Категория = get_rezothinc_cm(Parm.OprServDoc.rec.CommDate);
                else
                    Категория = tdr_rezexppccom;
                end;
            else
                Категория = tdr_rezexpopcom;
            end;
            if (Parm.Rcom_new[ИндКомиссии].RezExp == 0)
                СписаниеРезерва = true;
            end;
        else
            Delta = Parm.Rcom_new[ИндКомиссии].Rez - Parm.Rcom_old[ИндКомиссии].Rez;
            Категория = tdr_rezcom;
            if (Parm.Ccom[ИндКомиссии].ComissType == 1)
                if (IsCLAIMSACQ(GetOperationGroup(Parm.Deal_fd.GetTick().DealType)))
                    Категория = get_rezothinc_cm(Parm.OprServDoc.rec.CommDate);
                else
                    Категория = tdr_rezcom;
                end;
            else
                Категория = tdr_rezcom;
            end;
            if (Parm.Rcom_new[ИндКомиссии].Rez == 0)
                СписаниеРезерва = true;
            end;
        end;
        ФИРоль = FIROLE_RVP;
    end;

    if (СписаниеРезерва)
        Основание = "Списание резерва" + Основание;
        //if (not ПризнакКомиссии)
        //    ПолучитьОстатокСчета(Parm.Deal_fd, Категория, NULL, 1, Delta, Parm.OprServDoc.rec.CommDate, NATCUR);
        //end;
    elif (Delta > 0)
        Основание = "Создание/увеличение резерва" + Основание;
    else
        Основание = "Уменьшение резерва" + Основание;
    end;

    if (Delta > 0)
        if ((ПризнакКомиссии and (Parm.Ccom[ИндКомиссии].ComissType == 2)) or (ВидРезерва == 5))
            КатДебет = tdr_rezerve6;
        else
            КатДебет = tdr_RzrvM(Parm.Deal_fd.GetTick().TypeDoc);
        end;
        if (ПризнакКомиссии)
            ФИРольКредит = 10000 + Parm.Ccom[ИндКомиссии].ID;
        else
            ФИРольКредит = FIROLE_FIDOC;
        end;
        КатКредит    = Категория;
        ФИРольДебет  = ФИРоль;
    else
        if ((ПризнакКомиссии and (Parm.Ccom[ИндКомиссии].ComissType == 2)) or (ВидРезерва == 5))
            КатКредит = tdr_rezerve5;
        else
            КатКредит = tdr_RzrvP(Parm.Deal_fd.GetTick().TypeDoc);
        end;
        if (ПризнакКомиссии)
            ФИРольДебет = 10000 + Parm.Ccom[ИндКомиссии].ID;
        else
            ФИРольДебет = FIROLE_FIDOC;
        end;
        КатДебет     = Категория;
        ФИРольКредит = ФИРоль;
    end;

    if ((not ПризнакКомиссии)and((not СчетСделки(КатДебет, Parm.Deal_fd, СчетДебет, Parm.OprServDoc.rec.CommDate, MC_OPENACC_CREATE, NULL, NULL,ФИРольДебет)) or
        (not СчетСделки(КатКредит, Parm.Deal_fd, СчетКредит, Parm.OprServDoc.rec.CommDate, MC_OPENACC_CREATE, NULL, NULL,ФИРольКредит))))
        return 1;
    end;

    at.date_carry       = Parm.OprServDoc.rec.CommDate;
    at.PrimaryDoc       = Parm.Deal_fd;
    at.FIIDPayer        = 
    at.FIIDReceiver     = NATCUR;
    at.CatPayer         = КатДебет;
    at.CatReceiver      = КатКредит;
    at.FiRolePayer      = ФИРольДебет;
    at.FiRoleReceiver   = ФИРольКредит;
    at.SumPayer         = 
    at.SumReceiver      = abs(Delta);
    at.Chapter          = 1;
    at.Ground           = Основание;

    if (not at.carry())
        return 1; 
    end;	

    return 0;
END;

PRIVATE MACRO ПроводкаССПСД(Parm, RССПСДnew, RССПСДold)
    VAR
        Delta = 0, Основание = "", 
        СписаниеРезерва = false,
        Категория, КатДебет, КатКредит,
        ФИРольДебет, ФИРольКредит,
        СчетДебет, СчетКредит,
        at = MM_Carry;

    Delta = RССПСДnew - RССПСДold;
    Основание = " на возможные потери по сделке, оцениваемой по СС ПСД";
    Категория = tdr_assesrez;
    if (RССПСДnew == 0)
        СписаниеРезерва = true;
    end;

    if (СписаниеРезерва)
        Основание = "Списание резерва" + Основание;
        ПолучитьОстатокСчета(Parm.Deal_fd, Категория, NULL, 1, Delta, Parm.OprServDoc.rec.CommDate, NATCUR);
    elif (Delta > 0)
        Основание = "Создание/увеличение резерва" + Основание;
    else
        Основание = "Уменьшение резерва" + Основание;
    end;

    if (Delta > 0)
        КатДебет     = tdr_RzrvM(Parm.Deal_fd.GetTick().TypeDoc);
        КатКредит    = Категория;
        ФИРольДебет  = FIROLE_RVP;
        ФИРольКредит = FIROLE_FIDOC;
    else
        КатКредит    = tdr_RzrvP(Parm.Deal_fd.GetTick().TypeDoc);
        КатДебет     = Категория;
        ФИРольДебет  = FIROLE_FIDOC;
        ФИРольКредит = FIROLE_RVP;
    end;

    if ((not СчетСделки(КатДебет, Parm.Deal_fd, СчетДебет, Parm.OprServDoc.rec.CommDate, MC_OPENACC_CREATE, NULL, NULL,ФИРольДебет)) or
        (not СчетСделки(КатКредит, Parm.Deal_fd, СчетКредит, Parm.OprServDoc.rec.CommDate, MC_OPENACC_CREATE, NULL, NULL,ФИРольКредит)))
        return 1;
    end;

    at.date_carry       = Parm.OprServDoc.rec.CommDate;
    at.PrimaryDoc       = Parm.Deal_fd;
    at.FIIDPayer        = 
    at.FIIDReceiver     = NATCUR;
    at.CatPayer         = КатДебет;
    at.CatReceiver      = КатКредит;
    at.FiRolePayer      = ФИРольДебет;
    at.FiRoleReceiver   = ФИРольКредит;
    at.SumPayer         = 
    at.SumReceiver      = abs(Delta);
    at.Chapter          = 1;
    at.Ground           = Основание;

    if (not at.carry())
        return 1; 
    end;	

    return 0;
END;

PRIVATE MACRO ПроводкиШага(Parm)
    VAR stat = 0, i = 0, ДатаВвода;

    GetRegistryValue("COMMON\\МСФО\\ДАТА_ВВОДА",V_STRING, ДатаВвода, stat);
    if (not stat)
        ДатаВвода = date (ДатаВвода);
    end;

    if ((Parm.Rnew != Parm.Rold)and(Parm.OprServDoc.rec.Flag3)and(not stat))
        stat = Проводка(1, Parm, false);
    end;

    if ((Parm.R_CHC_new != Parm.R_CHC_old) and (Parm.OprServDoc.rec.Flag4)and(not stat))
        stat = Проводка(2, Parm, false);
    end;

    if ((Parm.Rpc_new != Parm.Rpc_old)and(Parm.OprServDoc.rec.Flag5)and(not stat))
        stat = Проводка(3, Parm, false);
    end;

    if ((Parm.Rpc_CHC_new != Parm.Rpc_CHC_old)and(Parm.OprServDoc.rec.Flag6)and(not stat))
        stat = Проводка(4, Parm, false);
    end;

    if ((Parm.Rpn_new != Parm.Rpn_old)and(Parm.OprServDoc.rec.Flag7)and(not stat)and(ДатаВвода <= Parm.OprServDoc.rec.CommDate))
        stat = Проводка(5, Parm, false);
    end;

    if ((Parm.OprServDoc.rec.Flag8)and(not stat))
        while (i < Parm.Rcom_new.size)
            if ((Parm.Rcom_new[i] != Parm.Rcom_old[i]) and (not stat))
                stat = Проводка(6, Parm, true, false, i);
                if (not stat)
                    stat = Проводка(6, Parm, true, true, i);
                end;
            end;
            i = i + 1;
        end;
    end;
    
    if (stat)
        SvOpSayError(Parm.Deal_fd.GetTick().DealCode, MM_RSRV_ERR_BADCARRY, "Ошибка при формировании проводки");
        return 1;
    end;

    return 0;
END;

PRIVATE MACRO ПроводкиШагаССПСД(Parm)
    VAR stat = 0, RССПСДnew = 0, RССПСДold = 0, i = 0;
    if ((Parm.OprServDoc.rec.Flag3)and(not stat))
        RССПСДnew = RССПСДnew + Parm.Rnew;
        RССПСДold = RССПСДold + Parm.Rold;
    end;

    if ((Parm.OprServDoc.rec.Flag4)and(not stat))
        RССПСДnew = RССПСДnew + Parm.R_CHC_new;
        RССПСДold = RССПСДold + Parm.R_CHC_old;
    end;

    if ((Parm.OprServDoc.rec.Flag5)and(not stat))
        RССПСДnew = RССПСДnew + Parm.Rpc_new;
        RССПСДold = RССПСДold + Parm.Rpc_old;
    end;

    if ((Parm.OprServDoc.rec.Flag6)and(not stat))
        RССПСДnew = RССПСДnew + Parm.Rpc_CHC_new;
        RССПСДold = RССПСДold + Parm.Rpc_CHC_old;
    end;

    if ((Parm.OprServDoc.rec.Flag7)and(not stat))
        RССПСДnew = RССПСДnew + Parm.Rpn_new;
        RССПСДold = RССПСДold + Parm.Rpn_old;
    end;

    if ((Parm.OprServDoc.rec.Flag8)and(not stat))
        while (i < Parm.Rcom_new.size)
            RССПСДnew = RССПСДnew + Parm.Rcom_new[i].Rez + Parm.Rcom_new[i].RezExp;
            RССПСДold = RССПСДold + Parm.Rcom_old[i].Rez + Parm.Rcom_old[i].RezExp;
            i = i + 1;
        end;
    end;

    if (RССПСДnew != RССПСДold)
        stat = ПроводкаССПСД(Parm, RССПСДnew, RССПСДold);
    end;
    
    if (stat)
        SvOpSayError(Parm.Deal_fd.GetTick().DealCode, MM_RSRV_ERR_BADCARRY, "Ошибка при формировании проводки");
        return 1;
    end;

    return 0;
END;

PRIVATE MACRO ПроводкаОцен(ВидРезерва, Parm, ПризнакКомиссии, ПризнакПросрКомиссии, ИндКомиссии)
    VAR
        СуммаПроводки = 0, КОРСчетРасходов, КОРСчетДоходов, КОРiold, КОРi, i = 0, ОставитьОснование = false, Уменьшение = false, Основание, FIRole = FIROLE_FIDOC,
        КатДебет, КатКредит,
        at = MM_Carry;

    if (not ПризнакКомиссии)
       if (ВидРезерва == 1)
          КОРi = Parm.Ra_new - Parm.Rnew;
          if (IsCLAIMSACQ(GetOperationGroup(Parm.Deal_fd.GetTick().DealType)))
             КОРСчетРасходов = get_rezadjod_cmP(Parm.OprServDoc.rec.CommDate);
             КОРСчетДоходов  = get_rezadjod_cmR(Parm.OprServDoc.rec.CommDate);
          else
             КОРСчетРасходов = tdr_rezadjodP;
             КОРСчетДоходов  = tdr_rezadjodR;
          end;
            Основание       = " по ОД без нарушения сроков оплаты до размера оценочного";
       elif (ВидРезерва == 2)
          КОРi = Parm.Ra_CHC_new - Parm.R_CHC_new;
          if (IsCLAIMSACQ(GetOperationGroup(Parm.Deal_fd.GetTick().DealType)))
             КОРСчетРасходов = get_rezadjod_cmP(Parm.OprServDoc.rec.CommDate);
             КОРСчетДоходов  = get_rezadjod_cmR(Parm.OprServDoc.rec.CommDate);
          else
             КОРСчетРасходов = tdr_rezadjexpodP;
             КОРСчетДоходов  = tdr_rezadjexpodR;
          end;
            Основание       = " по просроченному ОД до размера оценочного";
       elif (ВидРезерва == 3)
          КОРi = Parm.Rapc_new - Parm.Rpc_new;
          КОРСчетРасходов = tdr_rezadjprcP;
          КОРСчетДоходов  = tdr_rezadjprcR;
            Основание       = " по процентам без нарушения сроков оплаты до размера оценочного";
       elif (ВидРезерва == 4)
          КОРi = Parm.Rapc_CHC_new - Parm.Rpc_CHC_new;
          КОРСчетРасходов = tdr_rezadjexpprcP;
          КОРСчетДоходов  = tdr_rezadjexpprcR;
          Основание       = " по просроченным процентам до размера оценочного";
       elif (ВидРезерва == 5)
          КОРi = Parm.Rapn_new - Parm.Rpn_new;
          КОРСчетРасходов = tdr_rezadjpennyP;
          КОРСчетДоходов  = tdr_rezadjpennyR;
          Основание       = " по неустойкам (штрафам, пеням) до размера оценочного";
       elif (ВидРезерва == 7)
          КОРi = Parm.RКОРккст_new;
          if (IsCLAIMSACQ(GetOperationGroup(Parm.Deal_fd.GetTick().DealType)))
             КОРСчетРасходов = get_rezadjadj_cmP(Parm.OprServDoc.rec.CommDate);
             КОРСчетДоходов  = get_rezadjadj_cmR(Parm.OprServDoc.rec.CommDate);
          else
             КОРСчетРасходов = tdr_rezadjadjP;
             КОРСчетДоходов  = tdr_rezadjadjR;
          end;
          Основание       = "Корректировка на сумму корректировки стоимости, уменьшающая резерв по сделке до размера оценочного";
          ОставитьОснование = true;
       elif (ВидРезерва == 8)
          КОРi            = Parm.RКОРкз_new;
          if (IsCLAIMSACQ(GetOperationGroup(Parm.Deal_fd.GetTick().DealType)))
             КОРСчетРасходов = get_rezadjexp_cmP(Parm.OprServDoc.rec.CommDate);
             КОРСчетДоходов  = get_rezadjexp_cmR(Parm.OprServDoc.rec.CommDate);
         else
             КОРСчетРасходов = tdr_rezadjexpP;
             КОРСчетДоходов  = tdr_rezadjexpR;		
         end;
         Основание       = "Корректировка на сумму затрат, увеличивающая резерв по сделке до размера оценочного";	
         ОставитьОснование = true;
       end;
    else
        if (Parm.Ccom[ИндКомиссии].ComissType == 1)
            Основание = " по процентным комиссиям до размера оценочного";
        else
            Основание = " по операционным комиссиям до размера оценочного";
        end;
        FIRole = 10000 + Parm.Ccom[ИндКомиссии].ID;
        if (not ПризнакПросрКомиссии)
            КОРi = Parm.Racom_new[ИндКомиссии].Rez - Parm.Rcom_new[ИндКомиссии].Rez;
            КОРСчетРасходов = tdr_rezadjcomP;
            КОРСчетДоходов  = tdr_rezadjcomR;
        else
            КОРi = Parm.Racom_new[ИндКомиссии].RezExp - Parm.Rcom_new[ИндКомиссии].RezExp;
        end;
        if (ПризнакПросрКомиссии)
            if (Parm.Ccom[ИндКомиссии].ComissType == 1)
                КОРСчетРасходов = tdr_rezadjpccomP;
                КОРСчетДоходов  = tdr_rezadjpccomR;
            else
                КОРСчетРасходов = tdr_rezadjopcomP;
                КОРСчетДоходов  = tdr_rezadjopcomR;
            end;
        else
            if (IsCLAIMSACQ(GetOperationGroup(Parm.Deal_fd.GetTick().DealType)))
	       КОРСчетРасходов = tdr_rezadjic_cmP;
               КОРСчетДоходов  = tdr_rezadjic_cmR;
	    else
               КОРСчетРасходов = tdr_rezadjcomP;
               КОРСчетДоходов  = tdr_rezadjcomR;
            end;
         end;
    end;

    if ( КОРСчетДоходов == "-КОР_Резерв, ОД")
       КОРСчетДоходов="+КОР_Резерв, ОД3";
    end;

    if ( vari == 1 ) 
       if ( КОРСчетРасходов == "+КОР_Резерв, ОД")
          КОРСчетРасходов="+КОР_Резерв, ОД2";
       end;

       if ( КОРСчетРасходов == "-КОР_Резерв, ОД")
          КОРСчетРасходов="+КОР_Резерв, ОД2";
       end;

       if ( КОРСчетДоходов == "+КОР_Резерв, ОД")
          КОРСчетДоходов="+КОР_Резерв, ОД2";
       end;

       if ( КОРСчетДоходов == "-КОР_Резерв, ОД")
          КОРСчетДоходов="+КОР_Резерв, ОД2";
       end;

       if ( КОРСчетДоходов=="-КОР_Резерв, %")
          КОРСчетДоходов="+КОР_Резерв, %0";
       end;

       if ( КОРСчетДоходов=="+КОР_Резерв, %")
          КОРСчетДоходов="+КОР_Резерв, %0";
       end;

       if ( КОРСчетРасходов=="-КОР_Резерв, %")
          КОРСчетРасходов="+КОР_Резерв, %0";
       end;

       if ( КОРСчетРасходов=="+КОР_Резерв, %")
          КОРСчетРасходов="+КОР_Резерв, %0";
       end;
    end;
    if ( vari == 2 ) 
       if ( КОРСчетРасходов == "+КОР_Резерв, ОД")
          КОРСчетРасходов="+КОР_Резерв, ОД3";
       end;

       if ( КОРСчетРасходов == "-КОР_Резерв, ОД")
          КОРСчетРасходов="+КОР_Резерв, ОД3";
       end;

       if ( КОРСчетДоходов == "+КОР_Резерв, ОД")
          КОРСчетДоходов="+КОР_Резерв, ОД3";
       end;

       if ( КОРСчетДоходов == "-КОР_Резерв, ОД")
          КОРСчетДоходов="+КОР_Резерв, ОД3";
       end;
    end;

    КОРiold = Parm.Deal_fd.GetRestAccount(КОРСчетРасходов, Parm.OprServDoc.rec.CommDate, NATCUR, 1, FIRole, true);
    if (КОРiold == 0)
        КОРiold = Parm.Deal_fd.GetRestAccount(КОРСчетДоходов, Parm.OprServDoc.rec.CommDate, NATCUR, 1, FIRole, true);
    end;

    if (КОРi == КОРiold)
        return 0;
    elif ((КОРi > КОРiold) and (((КОРi >= 0) and (КОРiold >= 0)) or 
         ((КОРi <= 0) and (КОРiold <= 0))))

        СуммаПроводки     = КОРi - КОРiold;
        КатДебет          = tdr_rezadjP(Parm.Deal_fd.GetTick().TypeDoc);
        КатКредит         = КОРСчетДоходов;
        at.FIRoleReceiver = FIRole;
        Уменьшение        = false;
    elif ((КОРi < КОРiold) and (((КОРi >= 0) and (КОРiold >= 0)) or 
            ((КОРi <= 0) and (КОРiold <= 0))))

        СуммаПроводки     = КОРiold - КОРi;
        КатДебет          = КОРСчетРасходов;
        at.FiRolePayer    = FIRole;
        КатКредит         = tdr_rezadjR(Parm.Deal_fd.GetTick().TypeDoc);
        Уменьшение        = true;
    else
        СуммаПроводки = abs(КОРi) + abs(КОРiold);
        if (КОРiold < 0)
            КатДебет          = tdr_rezadjP(Parm.Deal_fd.GetTick().TypeDoc);
            КатКредит         = КОРСчетДоходов;
            at.FIRoleReceiver = FIRole;
            Уменьшение        = false;
        else
            КатДебет          = КОРСчетРасходов;
            КатКредит         = tdr_rezadjR(Parm.Deal_fd.GetTick().TypeDoc);
            at.FiRolePayer    = FIRole;
            Уменьшение        = true;
        end;
    end;

    if (not ОставитьОснование)
        if (Уменьшение)
            at.Ground = "Корректировка, уменьшающая резерв" + Основание;
        else
            at.Ground = "Корректировка, увеличивающая резерв" + Основание;
        end;
    else
        at.Ground = Основание;
    end;

    if ( vari == 1 ) 
       if ( КатКредит == "-КОР_Резерв, ОД")
          КатКредит="-КОР_Резерв, ОД2";
       end;
       if ( КатДебет == "-КОР_Резерв, ОД")
          КатДебет="-КОР_Резерв, ОД2";
       end;
       if ( КатКредит == "+КОР_Резерв, ОД")   //SVE 521133  03.01.2021
          КатКредит="+КОР_Резерв, ОД2";
       end;
       if ( КатДебет == "+КОР_Резерв, ОД")    //SVE 521133  03.01.2021
          КатДебет="+КОР_Резерв, ОД2";
       end;
       if ( КатКредит=="-КОР_Резерв, %")
          КатКредит="-КОР_Резерв, %0";
       end;
       if ( КатДебет=="-КОР_Резерв, %")
          КатДебет="-КОР_Резерв, %0";
       end;
       if ( КатКредит=="+КОР_Резерв, %")
          КатКредит="+КОР_Резерв, %0";
       end;
       if ( КатДебет=="+КОР_Резерв, %")
          КатДебет="+КОР_Резерв, %0";
       end;
       if ( КатКредит=="+КОР_РС, кредиты%")
          КатКредит="+РС, кредиты%0";
       end;
       if ( КатДебет=="+КОР_РС, кредиты%")
          КатДебет="+РС, кредиты%0";
       end;
       if ( КатКредит=="-КОР_РС, кредиты%")
          КатКредит="-РС, кредиты%0";
       end;
       if ( КатДебет=="-КОР_РС, кредиты%")
          КатДебет="-РС, кредиты%0";
      end;
    else
      if ( КатКредит=="+КОР_РС, кредиты%")
         КатКредит="+РС, кредиты%00";
      end;
      if ( КатДебет=="+КОР_РС, кредиты%")
         КатДебет="+РС, кредиты%00";
      end;
      if ( КатКредит=="-КОР_РС, кредиты%")
         КатКредит="-РС, кредиты%00";
      end;
      if ( КатДебет=="-КОР_РС, кредиты%")
         КатДебет="-РС, кредиты%00";
      end;
    end;

    if ( vari == 2 ) 
       if ( КатКредит == "-КОР_Резерв, ОД")
          КатКредит="-КОР_Резерв, ОД3";
       end;
       if ( КатДебет == "-КОР_Резерв, ОД")
          КатДебет="-КОР_Резерв, ОД3";
       end;
       if ( КатКредит=="+КОР_РС, Дп%")
          КатКредит="+РС, кредиты%000";
       end;
       if ( КатДебет=="+КОР_РС, Дп%")
          КатДебет="+РС, кредиты%000";
       end;
       if ( КатКредит=="-КОР_РС, Дп%")
          КатКредит="-РС, кредиты%000";
       end;
       if ( КатДебет=="-КОР_РС, Дп%")
          КатДебет="-РС, кредиты%000";
       end;
    end;

    at.Ground = at.Ground +", сделка N "+MM_tickid(Parm.Deal_fd.GetTick().DealID,"dealcode")+", "+nami(MM_tickid(Parm.Deal_fd.GetTick().DealID,"partyid"));
    at.date_carry       = Parm.OprServDoc.rec.CommDate;
    at.PrimaryDoc       = Parm.Deal_fd;
    at.FIIDPayer        = 
    at.FIIDReceiver     = NATCUR;
    at.CatPayer         = КатДебет;
    at.CatReceiver      = КатКредит;
    at.SumPayer         = 
    at.SumReceiver      = abs(СуммаПроводки);
    at.Chapter          = 1;

    if (not at.carry())
        return 1; 
    end;	

    return 0;
END;

PRIVATE MACRO ПроводкаОценССПСД(Parm)
    VAR
        КОР = 0, КОРold = 0, КОРСчетРасходов, КОРСчетДоходов, Sum, Ground, КатДебет, КатКредит,
        at = MM_Carry;

    if (Parm.OprServDoc.rec.Flag3)
        КОР = КОР + Parm.Ra_new - Parm.Rnew;
    end;
    if (Parm.OprServDoc.rec.Flag4)
        КОР = КОР + Parm.Ra_CHC_new - Parm.R_CHC_new;
    end;
    if (Parm.OprServDoc.rec.Flag5)
        КОР = КОР + Parm.Rapc_new - Parm.Rpc_new;
    end;
    if (Parm.OprServDoc.rec.Flag6)
        КОР = КОР + Parm.Rapc_CHC_new - Parm.Rpc_CHC_new;
    end;
    if (Parm.OprServDoc.rec.Flag7)
        КОР = КОР + Parm.Rapn_new - Parm.Rpn_new;
    end;
    if (Parm.OprServDoc.rec.Flag8)
        var i = 0;
        while (i < Parm.Racom_new.size)
            КОР = КОР + Parm.Racom_new[i].Rez + Parm.Racom_new[i].RezExp;
            i = i + 1;
        end;
    end;
    КОР = КОР + Parm.RКОРккст_new + Parm.RКОРкз_new;

    КОРСчетРасходов = tdr_rezadjssP;
    КОРСчетДоходов  = tdr_rezadjssR;	

    ПолучитьОстатокСчетаУчетЗнака(Parm.Deal_fd, КОРСчетРасходов, NULL, 1, КОРold, Parm.OprServDoc.rec.CommDate, NATCUR);
    if (КОРold == 0)
        ПолучитьОстатокСчетаУчетЗнака(Parm.Deal_fd, КОРСчетДоходов, NULL, 1, КОРold, Parm.OprServDoc.rec.CommDate, NATCUR);
    end;

    if (КОР == КОРold)
        return 0;
    elif ((КОР > КОРold) and (((КОР >= 0) and (КОРold >= 0)) or 
        ((КОР <= 0) and (КОРold <= 0))))

        Sum = КОР - КОРold;
        Ground    = "Корректировка, увеличивающая резерв ";
        КатДебет  = tdr_rezadjP(Parm.Deal_fd.GetTick().TypeDoc);
        КатКредит = КОРСчетДоходов;
    elif ((КОР < КОРold) and (((КОР >= 0) and (КОРold >= 0)) or 
            ((КОР <= 0) and (КОРold <= 0))))

        Sum = КОРold - КОР;
        Ground    = "Корректировка, уменьшающая резерв ";
        КатДебет  = КОРСчетРасходов;
        КатКредит = tdr_rezadjR(Parm.Deal_fd.GetTick().TypeDoc);
    else
        Sum = abs(КОР) + abs(КОРold);
        if (КОРold < 0)
            Ground    = "Корректировка, увеличивающая резерв ";
            КатДебет  = tdr_rezadjP(Parm.Deal_fd.GetTick().TypeDoc);
            КатКредит = КОРСчетДоходов;
    else
            Ground    = "Корректировка, уменьшающая резерв ";
            КатДебет  = КОРСчетРасходов;
            КатКредит = tdr_rezadjR(Parm.Deal_fd.GetTick().TypeDoc);
        end;
    end;

    if ( vari == 1 ) 
       if ( КатКредит=="+КОР_РС, кредиты%")
          КатКредит="+РС, кредиты%0";
       end;
       if ( КатДебет=="+КОР_РС, кредиты%")
          КатДебет="+РС, кредиты%0";
       end;
       if ( КатКредит=="-КОР_РС, кредиты%")
          КатКредит="-РС, кредиты%0";
       end;
       if ( КатДебет=="-КОР_РС, кредиты%")
          КатДебет="-РС, кредиты%0";
      end;
    else
      if ( КатКредит=="+КОР_РС, кредиты%")
         КатКредит="+РС, кредиты%00";
      end;
      if ( КатДебет=="+КОР_РС, кредиты%")
         КатДебет="+РС, кредиты%00";
      end;
      if ( КатКредит=="-КОР_РС, кредиты%")
         КатКредит="-РС, кредиты%00";
      end;
      if ( КатДебет=="-КОР_РС, кредиты%")
         КатДебет="-РС, кредиты%00";
      end;
    end;

    if ( vari == 2 ) 
       if ( КатКредит=="+КОР_РС, Дп%")
          КатКредит="+РС, кредиты%000";
       end;
       if ( КатДебет=="+КОР_РС, Дп%")
          КатДебет="+РС, кредиты%000";
       end;
       if ( КатКредит=="-КОР_РС, Дп%")
          КатКредит="-РС, кредиты%000";
       end;
       if ( КатДебет=="-КОР_РС, Дп%")
          КатДебет="-РС, кредиты%000";
       end;
    end;	

    at.Ground           = Ground + "по сделке, оцениваемой по СС ПСД до размера оценочного";
    at.CatPayer         = КатДебет;
    at.CatReceiver      = КатКредит;
    at.date_carry       = Parm.OprServDoc.rec.CommDate;
    at.PrimaryDoc       = Parm.Deal_fd;
    at.FIIDPayer        = 
    at.FIIDReceiver     = NATCUR;
    at.SumPayer         = 
    at.SumReceiver      = abs(Sum);
    at.Chapter          = 1;

    if (not at.carry())
        return 1; 
    end;	

    return 0;
END;

PRIVATE MACRO ПроводкиОценРез(Parm);
    VAR stat = 0, AsCategory = 0;
    // получить категорию оценки
    GetMainObjAttr(NULL, OBJTYPE_MMARKDEAL, UniID(Parm.Deal_fd.tick, OBJTYPE_MMARKDEAL), 5, AsCategory, NULL, NULL, Parm.OprServDoc.rec.CommDate);

    if (AsCategory != FAIR_VAL_COMPR_INCOME) 
        if (Parm.OprServDoc.rec.Flag3)
            stat = ПроводкаОцен(1, Parm, false);
        end;
        if ((Parm.OprServDoc.rec.Flag4)and(not stat))
            stat = ПроводкаОцен(2, Parm, false);
        end;
        if ((Parm.OprServDoc.rec.Flag5)and(not stat))
            stat = ПроводкаОцен(3, Parm, false);
        end;
        if ((Parm.OprServDoc.rec.Flag6)and(not stat))
            stat = ПроводкаОцен(4, Parm, false);
        end;
        if ((Parm.OprServDoc.rec.Flag7)and(not stat))
            stat = ПроводкаОцен(5, Parm, false);
        end;
        if ((Parm.OprServDoc.rec.Flag8)and(not stat))
            var i = 0;
            while (i < Parm.Racom_new.size)
                if (not stat)
                    stat = ПроводкаОцен(6, Parm, true, false, i);
                end;
        if (not stat)
                    stat = ПроводкаОцен(6, Parm, true, true,  i);
                end;
                i = i + 1;
            end;
        end;
        // резервы по корректировкам и затратам
        if (not stat)
            stat = ПроводкаОцен(7, Parm, false);
        end;
        if (not stat)
            stat = ПроводкаОцен(8, Parm, false);
        end;
    else
        stat = ПроводкаОценССПСД(Parm);
    end;

    return stat;
END;

/****************************************************************************************/
PRIVATE MACRO РанееСозданныйРезерв(TypeBase, Parm, LastDate, ComID, IsExpCom)
    VAR ResLnk, cmd;
    if (ValType(ComID) == V_UNDEF)
        ComId = 0;
    end;
    if (ValType(IsExpCom) == V_UNDEF)
        IsExpCom = false;
    end;

        if (ValType(LastDate) != V_UNDEF)
        LastDate = date(Parm.OprServDoc.rec.CommDate);
            SetParm(2, LastDate);
        end;

    if (TypeBase == 1)
        if (IsCLAIMSACQ(GetOperationGroup(Parm.Deal_fd.GetTick().DealType)))
            return Parm.Deal_fd.GetRestAccount(get_rmainrest_cm(Parm.OprServDoc.rec.CommDate), Parm.OprServDoc.rec.CommDate, NATCUR, 1, NULL);
        else
        return Parm.Deal_fd.GetRestAccount(tdr_rez_mainrest, Parm.OprServDoc.rec.CommDate, NATCUR, 1, NULL);
        end;
    elif (TypeBase == 2)
        return Parm.Deal_fd.GetRestAccount(tdr_rez_exprest, Parm.OprServDoc.rec.CommDate, NATCUR, 1, NULL);
    elif (TypeBase == 3)
        return Parm.Deal_fd.GetRestAccount(tdr_rez_perc, Parm.OprServDoc.rec.CommDate, NATCUR, 1, NULL);
    elif (TypeBase == 4)
        return Parm.Deal_fd.GetRestAccount(tdr_rez_expperc, Parm.OprServDoc.rec.CommDate, NATCUR, 1, NULL);
    elif (TypeBase == 5)
        return Parm.Deal_fd.GetRestAccount(tdr_rez_penny, Parm.OprServDoc.rec.CommDate, NATCUR, 1, NULL);
    elif (TypeBase == 6)
        var FIRole = 10000 + ComID, exprez_sum = $0;
        if (not IsExpCom)
            return Parm.Deal_fd.GetRestAccount(tdr_rezcom, Parm.OprServDoc.rec.CommDate, NATCUR, 1, FIRole);
        else
            exprez_sum = Parm.Deal_fd.GetRestAccount(tdr_rezexpopcom, Parm.OprServDoc.rec.CommDate, NATCUR, 1, FIRole) +
                Parm.Deal_fd.GetRestAccount(tdr_rezexppccom, Parm.OprServDoc.rec.CommDate, NATCUR, 1, FIRole);
            return exprez_sum;
        end;
    end;

    return 0;
END;    

PRIVATE MACRO ОпределитьРанееСозданныйРезерв(Parm)
    Parm.Rold        = РанееСозданныйРезерв(1, Parm);
    Parm.R_CHC_old   = РанееСозданныйРезерв(2, Parm);
    Parm.Rpc_old     = РанееСозданныйРезерв(3, Parm);
    Parm.Rpc_CHC_old = РанееСозданныйРезерв(4, Parm);
    Parm.Rpn_old     = РанееСозданныйРезерв(5, Parm);

    var query, RsbData, i = 0, sfcom  = TRecHandler("sfcomiss.dbt");
    query = "select * from ddlcomis_dbt " +
                          "where t_dockind = " + DL_IBCDOC + 
                          " and t_docid = " + Parm.Deal_fd.GetTick().DealID;
    RsbData = TRsbDataSet(query);
    while (RsbData.MoveNext)
        if(not SfGetComiss(RsbData.FeeType, RsbData.ComNumber, sfcom))
            return 1;
        end;     
        if (sfcom.rec.ReceiverID == {ourbank})
            Parm.Rcom_old[i].Rez    = РанееСозданныйРезерв(6, Parm, NULL, RsbData.ID, false);
            Parm.Rcom_old[i].RezExp = РанееСозданныйРезерв(6, Parm, NULL, RsbData.ID, true);
            i = i + 1;
        end;
    end;
    while (i < Parm.Ccom.size)
        Parm.Rcom_old[i].Rez    = РанееСозданныйРезерв(6, Parm, NULL, Parm.Ccom[i].ID, false);
        Parm.Rcom_old[i].RezExp = РанееСозданныйРезерв(6, Parm, NULL, Parm.Ccom[i].ID, true);   
        i = i + 1;
    end;

    SetParm(0, Parm);
END;

PRIVATE MACRO РасчетСуммыОбеспечения(Parm)
    VAR
        Ki = 0,
        Sum = 0,
        Ktcc = 0,
        Tcc_After = 0,
        RsbTccHist  = NULL,
        RsbSum      = NULL,
        RsbGrnt = TRsbDataSet("select decode(ord.t_SysTypes, 'Ц', fininstr.t_facevaluefi, fininstr.t_fiid) as faceFI, sec.* "
                              "from ddl_order_dbt ord, ddl_secur_dbt sec, dfininstr_dbt fininstr "
                              "where (ord.t_contractid = sec.t_generalcontract) "
                              "and(fininstr.t_fiid = sec.t_fiid) "
                              "and(sec.t_contractkind = " + DL_IBCDOC + ") "
                              "and(sec.t_contractid = " + Parm.Deal_fd.GetTick().DealID + ")");

    Parm.С_об = 0;

    while(RsbGrnt.MoveNext())
        RsbTccHist = TRsbDataSet("select * from dhistorytcc_dbt hist where "
                                  "(hist.t_DealID in (0, " + Parm.Deal_fd.GetTick().DealID + ")) "
                                  "and(hist.t_ContractID = " + RsbGrnt.GeneralContract + ") "
                                  "and(hist.t_SecurID in (0, " + RsbGrnt.NumSecInOrder + ") "
                                  "and (hist.t_DateStep <= '" + Parm.OprServDoc.rec.CommDate + "'))"
                                  "order by hist.t_DateStep desc, hist.t_ID desc");

        if (RsbTccHist.MoveNext())
            Tcc_After = RsbTccHist.Tcc_After;

            if ((RsbTccHist.DealID == 0)and(RsbTccHist.SecurID == 0)) // учет по договору
                RsbSum = TRsbDataSet("select ord.t_Cost as Sum from ddl_order_dbt ord where ord.t_ContractID = " + RsbGrnt.GeneralContract);
                RsbSum.MoveNext();
                Ktcc = RsbSum.Sum;
            elif ((RsbTccHist.DealID > 0)and(RsbTccHist.SecurID == 0))// учет по сделке
                RsbSum = TRsbDataSet("select grnt.t_Amount as Sum from ddl_grnt_dbt grnt where grnt.t_ContractID = " + RsbGrnt.GeneralContract +
                                     " and grnt.t_DealID = " + Parm.Deal_fd.GetTick().DealID);
                RsbSum.MoveNext();
                Ktcc = RsbSum.Sum;
            elif (((RsbTccHist.DealID == 0)and(RsbTccHist.SecurID > 0))or // учет по ПЗ
                  ((RsbTccHist.DealID > 0)and(RsbTccHist.SecurID > 0)))
                Ktcc = RsbGrnt.Cost;
            end;

            Sum = Tcc_After * (RsbGrnt.Cost / Ktcc);
        else
            Sum = RsbGrnt.Cost;
        end;


        if (RsbGrnt.faceFI != NATCUR)
            ConvSum(Sum, Money(Sum), Date(Parm.OprServDoc.rec.CommDate), Int(RsbGrnt.faceFI), NATCUR);
        end;

        if(RsbGrnt.QualityCategory == 1)
            Ki = 1; 
        elif (RsbGrnt.QualityCategory == 2)
            Ki = 0.5;
        else
            Ki = 0;
        end;	

        Parm.С_вал = NATCUR;
        Parm.С_об = Parm.С_об + (Sum * Ki);
    end;

    SetParm(0, Parm);
END;

PRIVATE MACRO РасчетНовойСуммыРезерва(Parm)
    VAR
        ОД = 0, Cpn_OD_new = Parm.penny_OD, Cpn_Pc_new = Parm.penny_perc,
        С_об = Parm.С_об,
        C = Parm.C, C_CHC = Parm.C_CHC,
        Cpc = Parm.Cpc, Cpc_CHC = Parm.Cpc_CHC, 
        Rpn_OD = 0, Rpn_Pc = 0,
        RestNatcur, RestExpNatcur;
	
    if (Parm.Deal_fd.GetLeg().pfi != NATCUR)
        ConvSum(C,           Parm.C,           Parm.OprServDoc.rec.CommDate, Parm.Deal_fd.GetLeg().pfi,NATCUR);
        ConvSum(C_CHC,       Parm.C_CHC,       Parm.OprServDoc.rec.CommDate, Parm.Deal_fd.GetLeg().pfi,NATCUR);
        ConvSum(Cpc,         Parm.Cpc,         Parm.OprServDoc.rec.CommDate, Parm.Deal_fd.GetLeg().pfi,NATCUR);
        ConvSum(Cpc_CHC,     Parm.Cpc_CHC,     Parm.OprServDoc.rec.CommDate, Parm.Deal_fd.GetLeg().pfi,NATCUR);
        ConvSum(Cpn_OD_new,  Parm.penny_OD,    Parm.OprServDoc.rec.CommDate, Parm.Deal_fd.GetLeg().pfi,NATCUR);
        ConvSum(Cpn_Pc_new,  Parm.penny_perc,  Parm.OprServDoc.rec.CommDate, Parm.Deal_fd.GetLeg().pfi,NATCUR);
    end;

    if (Parm.Deal_fd.GetLeg().pfi != Parm.С_вал)
        ConvSum(С_об, С_об, Parm.OprServDoc.rec.CommDate, Parm.С_вал, Parm.Deal_fd.GetLeg().pfi);
    end;

    ОД = C + C_CHC;
    if ((С_об >= ОД)or(ОД == 0))
        Parm.Rnew        = 0;
        Parm.R_CHC_new   = 0;
    else
        Parm.Rnew        = money(C       * (Parm.ПР/100) * (1 - С_об/ОД));
        Parm.R_CHC_new   = money(C_CHC   * (Parm.ПР/100) * (1 - С_об/ОД));
    end;
    if ((Cpc == 0) or (С_об >=(Cpc + ОД)))
       Parm.Rpc_new = 0;
    else 
       Parm.Rpc_new = money(Cpc * (Parm.ПР/100) * (1 - Max(0, (С_об - ОД))/Cpc));
    end;
    if ((Cpc_CHC == 0) or (С_об >=(Cpc_CHC + ОД)))
       Parm.Rpc_CHC_new = 0;
    else 
       Parm.Rpc_CHC_new = money(Cpc_CHC * (Parm.ПР/100) * (1 - Max(0, (С_об - ОД))/Cpc_CHC));
    end;
    if ((С_об >= (Cpn_OD_new + ОД + Cpc + C_CHC))or(Cpn_OD_new == 0))
        Parm.Rpn_new = 0;
    else
        Parm.Rpn_new = money(Cpn_OD_new * (Parm.ПР/100) * (1 - Max(0, (С_об - (ОД + Cpc + C_CHC)))/Cpn_OD_new));
    end;

    if (Parm.RpnODFull)
        Rpn_OD = Cpn_OD_new;
    else
        Rpn_OD = Cpn_OD_new * (Parm.ПР/100);
    end;
    if (Parm.RpnPcFull)
        Rpn_Pc = Cpn_Pc_new;
    else
        Rpn_Pc = Cpn_Pc_new * (Parm.ПР/100);
    end;
    Parm.Rpn_new = Rpn_OD + Rpn_Pc;
    // комиссии
    var i = 0;
    while (i < Parm.Ccom.size)
        if (Parm.Ccom[i].Rest != 0)
            ConvSum(RestNatcur, Parm.Ccom[i].Rest, Parm.OprServDoc.rec.CommDate, Parm.Deal_fd.GetLeg().pfi, NATCUR);
            Parm.Rcom_new[i].Rez = RestNatcur * (Parm.ПР/100);
        end;
        if (Parm.Ccom[i].RestExp != 0)
            ConvSum(RestExpNatcur, Parm.Ccom[i].RestExp, Parm.OprServDoc.rec.CommDate, Parm.Deal_fd.GetLeg().pfi, NATCUR);
            if (Parm.Ccom[i].ПРПолн)
                Parm.Rcom_new[i].RezExp = RestExpNatcur;
            else
                Parm.Rcom_new[i].RezExp = RestExpNatcur * (Parm.ПР/100);
            end;
        end;
        i = i + 1;
    end;

    Parm.Rnew        = round(Parm.Rnew,        2);
    Parm.R_CHC_new   = round(Parm.R_CHC_new,   2);
    Parm.Rpc_new     = round(Parm.Rpc_new,     2);
    Parm.Rpc_CHC_new = round(Parm.Rpc_CHC_new, 2);
    Parm.Rpn_new     = round(Parm.Rpn_new,     2);

    SetParm(0, Parm);
END;

PRIVATE MACRO СуммаОценРезерва(Parm, BaseSum)
    VAR res;
    res = MM_CalcAssesRes(Parm.Deal_fd.GetTick().BOfficeKind, Parm.Deal_fd.GetTick().DealID, BaseSum, Parm.OprServDoc.rec.CommDate, 0);
    if (res == -1)
        res = 0;
    end;
    return res;
END;

PRIVATE MACRO РасчетНовойСуммыОценРезерва(Parm)
    Parm.Ra_new       = round(СуммаОценРезерва(Parm, Parm.C),       2);
    Parm.Ra_CHC_new   = round(СуммаОценРезерва(Parm, Parm.C_CHC),   2);
    Parm.Rapc_new     = round(СуммаОценРезерва(Parm, Parm.Cpc),     2);
    Parm.Rapc_CHC_new = round(СуммаОценРезерва(Parm, Parm.Cpc_CHC), 2);
    Parm.Rapn_new     = round(СуммаОценРезерва(Parm, Parm.Cpn),     2);

    // формирование доп. корректировок
    Parm.RКОРккст_new = round(СуммаОценРезерва(Parm, Parm.Cкор),    2);
    Parm.RКОРкз_new   = round(СуммаОценРезерва(Parm, Parm.Cзатр),   2);

    var i = 0;
    while (i < Parm.Racom_new.size)
        Parm.Racom_new[i].Rez    = СуммаОценРезерва(Parm, Parm.Ccom[i].Rest);
        Parm.Racom_new[i].RezExp = СуммаОценРезерва(Parm, Parm.Ccom[i].RestExp);
        i = i + 1;
    end;

    SetParm(0, Parm);
END;


PRIVATE MACRO КонтрольПКР(Parm)
    VAR
        stat = 0, КонтрольПКР = RSRV_PARMS_CONTROL_NONE,
        НККС = 1, НПР = 0, RsbReslnk = NULL;

    GetRegistryValue("MMARK\\ОБЩИЕ\\КОНТРОЛЬ ПАРАМ. КРЕД-НОГО РИСКА", V_INTEGER, КонтрольПКР, stat);
    if(stat)
        SvOpSayError(Parm.Deal_fd.tick.DealCode, MM_RSRV_ERR_BADREG, "Ошибка при получении настроек банка");
        return 1;
    end;

    if (КонтрольПКР == RSRV_PARMS_CONTROL_NONE)
        return 0;
    else
        RsbReslnk = TRsbDataSet("select max(lnk.t_reservepercent) maxRP, t_qualitycategory maxQC "
                                 "from ddlreslnk_dbt lnk, ddl_tick_dbt tick "
                                 "where lnk.t_Type = 3 and lnk.t_parentid = tick.t_dealid and "
                                 " lnk.t_childid = -1 and tick.t_partyid = " + Parm.Deal_fd.GetTick().PartyID + 
                                 " and tick.t_BofficeKind = 102 "
                                 " group by t_qualitycategory order by t_qualitycategory desc");

        if (RsbReslnk.MoveNext()) 
            НККС = RsbReslnk.maxQC;
            НПР  = RsbReslnk.maxRP;
        end;

        if (КонтрольПКР == RSRV_PARMS_CONTROL_EDIT_KKS)
            if (Parm.ККС < НККС)
                Parm.ККС = НККС;
                SvOpSayError(Parm.Deal_fd.GetTick().DealCode, MM_RSRV_ERR_CONBQC, "Контроль наихудшей категории качества для контрагента");
            end;

            if (Parm.ПР < НПР)
                Parm.ПР = НПР;
                SvOpSayError(Parm.Deal_fd.GetTick().DealCode, MM_RSRV_ERR_CONPERC, "Контроль наихудшего процента резерва для контрагента");
            end;
        elif (КонтрольПКР == RSRV_PARMS_CONTROL_NOEDIT_KKS)
            if (Parm.ККС < НККС)
                SvOpSayError(Parm.Deal_fd.GetTick().DealCode, MM_RSRV_ERR_BADQC, "Категория качества сделки меньше наихудшей для контрагента");
                return 1;
            end;

            if (Parm.ПР < НПР)
                SvOpSayError(Parm.Deal_fd.GetTick().DealCode, MM_RSRV_ERR_BADPERC, "Процент резерва меньше наихудшего для контрагента");
                return 1;
            end;
        end;
    end;

    return 0;
END;

PRIVATE MACRO MM_CalcReserve(Parm)
    VAR 
        DataSet          = NULL,
        party           = TBfile("party.dbt", "R", 0),
        check_date      = date(0, 0, 0),
        changed         = true;

    if (IsSale(Parm.Deal_fd.GetTick().DealGroup))
       DataSet = TRsbDataSet("select t_qualitycategory, t_reservepercent " +
                           " from ddlreslnk_dbt " +
                           " where (t_type = 3) and (t_parentid = " + Parm.Deal_fd.GetTick().DealID + ")" +
                           " and (t_childid = -1) " +
                           " and (t_lnkdate <= '"+ Date(Parm.OprServDoc.rec.CommDate) + "')" +
                           " order by t_lnkdate desc, t_id desc");

       if(not DataSet.MoveNext) 
           SvOpSayError(Parm.Deal_fd.GetTick().DealCode, MM_RSRV_ERR_NOPARM, "Не заданы параметры резервирования в сделке");
           return 1;
       end;

       Parm.ККС = DataSet.QualityCategory;
       Parm.ПР = DataSet.ReservePercent;

       if (КонтрольПКР(Parm))
           return 1;
       end;
       ОпределитьРанееСозданныйРезерв(Parm);
       if ((Parm.ПР == 0)and(Parm.Rold == 0))
           if (Parm.OprServDoc.rec.AssesRes)
               RVPStatus = MM_RSRV_ERR_ZPERCENT;
               return 0;
           end;
           SvOpSayError(Parm.Deal_fd.GetTick().DealCode, MM_RSRV_ERR_ZPERCENT, "Нулевой процент резерва в сделке");
           return 1;
       end;
    else
        ОпределитьРанееСозданныйРезерв(Parm);
        Parm.ККС = 0;
        Parm.ПР  = 0;
    end;

    РасчетСуммыОбеспечения(Parm);

    if (РасчетНовойСуммыРезерва(Parm) != 0)
        return 1;
    end;

    if ((Parm.Rnew == Parm.Rold)and(Parm.R_CHC_new == Parm.R_CHC_old)and
        (Parm.Rpc_new == Parm.Rpc_old)and(Parm.Rpc_CHC_new == Parm.Rpc_CHC_old)and(Parm.Rpn_new == Parm.Rpn_old))
        var i = 0;
        while (i < Parm.Rcom_new.size)
            if ((Parm.Rcom_new[i].Rez != Parm.Rcom_old[i].Rez)or(Parm.Rcom_new[i].RezExp != Parm.Rcom_old[i].RezExp))
                changed = true;
                break;
            end;
            i = i + 1;
        end;
        if (not changed)
           if (Parm.OprServDoc.rec.AssesRes)
              RVPStatus = 1;
              return 0;
           end;
           return 1;
        end;
    end;

    SetParm(0, Parm);

    return 0;
END;

PRIVATE MACRO ПолучитьСуммуКомиссий(Parm)
    var query, RsbData, FIRole, mmcomiss  = TBfile("mmcomiss.dbt"), sfcom  = TRecHandler("sfcomiss.dbt"), comisObj, inccalcs, othinc, RestExpOld;
    query = "select * from ddlcomis_dbt " +
                          "where t_dockind = " + DL_IBCDOC + 
                          " and t_docid = " + Parm.Deal_fd.GetTick().DealID;

    RsbData = TRsbDataSet(query);
    while (RsbData.MoveNext)
        mmcomiss.rec.FeeType = RsbData.FeeType;
        mmcomiss.rec.Number  = RsbData.ComNumber;
        if (not mmcomiss.GetEQ)
            return 1;
        end;
        if(not SfGetComiss(RsbData.FeeType, RsbData.ComNumber, sfcom))
            return 1;
        end;     
        if (sfcom.rec.ReceiverID == {ourbank})
            FIRole = 10000 + RsbData.ID;
            comisObj = MM_COMISS_C;
            comisObj.ComissType = mmcomiss.rec.Type;
            comisObj.ID         = RsbData.ID;
            comisObj.Rest       = Parm.Deal_fd.GetRestAccount(tdr_comreq, Parm.OprServDoc.rec.CommDate, Parm.Deal_fd.GetLeg().pfi, 1, FIRole);
            if (comisObj.Rest == 0)
                if (IsCLAIMSACQ(GetOperationGroup(Parm.Deal_fd.GetTick().DealType)))
                    inccalcs      = Parm.Deal_fd.GetRestAccount(get_inccalcs_cm(Parm.OprServDoc.rec.CommDate), Parm.OprServDoc.rec.CommDate, Parm.Deal_fd.GetLeg().pfi, 1, FIRole);
                    othinc        = Parm.Deal_fd.GetRestAccount(get_othinc_cm(Parm.OprServDoc.rec.CommDate),   Parm.OprServDoc.rec.CommDate, Parm.Deal_fd.GetLeg().pfi, 1, FIRole);
                else
                    inccalcs      = Parm.Deal_fd.GetRestAccount(tdr_inccalcs, Parm.OprServDoc.rec.CommDate, Parm.Deal_fd.GetLeg().pfi, 1, FIRole);
                    othinc        = Parm.Deal_fd.GetRestAccount(tdr_othinc,   Parm.OprServDoc.rec.CommDate, Parm.Deal_fd.GetLeg().pfi, 1, FIRole);
                end;
                comisObj.Rest = abs(inccalcs - othinc);
            end;
            if (IsSale(Parm.Deal_fd.GetTick().DealGroup))
               if (mmcomiss.rec.Type == 1) // процентный
                   comisObj.RestExp = Parm.Deal_fd.GetRestAccount(tdr_pccomreq, Parm.OprServDoc.rec.CommDate, Parm.Deal_fd.GetLeg().pfi, 1, FIRole);
                   RestExpOld       = Parm.Deal_fd.GetRestAccount(tdr_pccomreq, Parm.OprServDoc.rec.CommDate - 31, Parm.Deal_fd.GetLeg().pfi, 1, FIRole);
               elif (mmcomiss.rec.Type == 2) // операционный
                   comisObj.RestExp = Parm.Deal_fd.GetRestAccount(tdr_opcomreq, Parm.OprServDoc.rec.CommDate, Parm.Deal_fd.GetLeg().pfi, 1, FIRole);
                   RestExpOld       = Parm.Deal_fd.GetRestAccount(tdr_opcomreq, Parm.OprServDoc.rec.CommDate - 31, Parm.Deal_fd.GetLeg().pfi, 1, FIRole);
               end;
               if ((RestExpOld != 0) and (comisObj.RestExp != 0))
                   comisObj.ПРПолн = true;
               end;
            else   
                var ComPm = "select t_paymentid, t_valuedate from dpmpaym_dbt where t_DocKind = 102 and t_DocumentID = " + Parm.Deal_fd.GetTick().DealID +
                            " and t_Purpose = 87 and t_PaymStatus = 1000 and t_SubPurpose = " + RsbData.ID;

                RsbData = TRsbDataSet(ComPm);
                if (RsbData.MoveNext)
                    if (RsbData.ValueDate < Parm.OprServDoc.rec.CommDate)
                        if (NDays(RsbData.ValueDate, Parm.OprServDoc.rec.CommDate) > 30)
                            comisObj.RestExp = comisObj.Rest;
                            comisObj.ПРПолн  = true;
                        end;
                    end;
                end;
            end;
            Parm.Ccom[Parm.Ccom.size] = comisObj;
            // заполнить остальные массивы
            Parm.Rcom_new[Parm.Rcom_new.size]   = MM_COMISS_R;
            Parm.Rcom_old[Parm.Rcom_old.size]   = MM_COMISS_R;
            Parm.Racom_new[Parm.Racom_new.size] = MM_COMISS_R;
        end;
    end;
    
    SetParm(0, Parm);
END;

PRIVATE MACRO ПолучитьРасчетнуюБазу(Parm)
    VAR penny_OD_old, penny_perc_old;
    if (IsCLAIMSACQ(GetOperationGroup(Parm.Deal_fd.GetTick().DealType)))
        ПолучитьОстатокСчета(Parm.Deal_fd, get_rights(Parm.OprServDoc.rec.CommDate), NULL, 1, Parm.C, Parm.OprServDoc.rec.CommDate, Parm.Deal_fd.GetLeg().pfi);
    else
       /* MAA: I-Support - 540365. Не были учтены остатки по счетам "ОДТФ" по сделкам "ТФ, размещение". */
       if ( Parm.Deal_fd.GetTick().DealType == 12335 )
          ПолучитьОстатокСчета(Parm.Deal_fd, tdr_mainrest_tf, NULL, 1, Parm.C,       Parm.OprServDoc.rec.CommDate, Parm.Deal_fd.GetLeg().pfi);
       else
          ПолучитьОстатокСчета(Parm.Deal_fd, tdr_mainrest,    NULL, 1, Parm.C,       Parm.OprServDoc.rec.CommDate, Parm.Deal_fd.GetLeg().pfi);
       end;
    end;
    ПолучитьОстатокСчета(Parm.Deal_fd, tdr_exprestR,    NULL, 1, Parm.C_CHC,   Parm.OprServDoc.rec.CommDate, Parm.Deal_fd.GetLeg().pfi);
    ПолучитьОстатокСчета(Parm.Deal_fd, tdr_claimR,      NULL, 1, Parm.Cpc,     Parm.OprServDoc.rec.CommDate, Parm.Deal_fd.GetLeg().pfi);
    ПолучитьОстатокСчета(Parm.Deal_fd, tdr_exppercR,    NULL, 1, Parm.Cpc_CHC, Parm.OprServDoc.rec.CommDate, Parm.Deal_fd.GetLeg().pfi);

    ПолучитьОстатокСчета(Parm.Deal_fd, tdr_penny_ODR,   NULL, 1, Parm.penny_OD,        Parm.OprServDoc.rec.CommDate, Parm.Deal_fd.GetLeg().pfi);
    ПолучитьОстатокСчета(Parm.Deal_fd, tdr_penny_ODR,   NULL, 1, penny_OD_old,     Parm.OprServDoc.rec.CommDate - 31, Parm.Deal_fd.GetLeg().pfi);
    if ((penny_OD_old != 0) and (Parm.penny_OD != 0))
        Parm.RpnODFull = true;
    end;
    ПолучитьОстатокСчета(Parm.Deal_fd, tdr_penny_percR, NULL, 1, Parm.penny_perc,  Parm.OprServDoc.rec.CommDate, Parm.Deal_fd.GetLeg().pfi);
    ПолучитьОстатокСчета(Parm.Deal_fd, tdr_penny_percR, NULL, 1, penny_perc_old,   Parm.OprServDoc.rec.CommDate - 31, Parm.Deal_fd.GetLeg().pfi);
    if ((penny_perc_old != 0) and (Parm.penny_perc != 0))
        Parm.RpnPcFull = true;
    end;
    Parm.Cpn = Parm.penny_OD + Parm.penny_perc;
	
	ПолучитьОстатокСчетаУчетЗнака(Parm.Deal_fd, tdr_adjplR, NULL, 1, Parm.Cкор, Parm.OprServDoc.rec.CommDate, NATCUR);
    if (Parm.Cкор == 0)
        ПолучитьОстатокСчетаУчетЗнака(Parm.Deal_fd, tdr_adjplP, NULL, 1, Parm.Cкор, Parm.OprServDoc.rec.CommDate, NATCUR);
    end;
	Parm.Cкор = -Parm.Cкор;
    ПолучитьОстатокСчета(Parm.Deal_fd, tdr_expenses, NULL, 1, Parm.Cзатр, Parm.OprServDoc.rec.CommDate, NATCUR);
    
    ПолучитьСуммуКомиссий(Parm);
    
    SetParm(0, Parm);
END;

PRIVATE MACRO СохранитьРезультат(Parm)
    VAR orsrv = 0, i = 0;
    if (Parm.OprServDoc.rec.Flag3)
        InsertDlResLnk(1, Parm, false);
    end;
    if (Parm.OprServDoc.rec.Flag4)
        InsertDlResLnk(2, Parm, false);
    end;
    if (Parm.OprServDoc.rec.Flag5)
        InsertDlResLnk(3, Parm, false);
    end;
    if (Parm.OprServDoc.rec.Flag6)
        InsertDlResLnk(4, Parm, false);
    end;
    if (Parm.OprServDoc.rec.Flag7)
        InsertDlResLnk(5, Parm, false);
    end;
    if (Parm.OprServDoc.rec.Flag8)
        i = 0;
        while (i < Parm.Ccom.size)
            InsertDlResLnk(6, Parm, true, false, i);
            InsertDlResLnk(6, Parm, true, true,  i);
            i = i + 1;
        end;
    end;
    // сумма оценочного резерва
    orsrv = Parm.Ra_new + Parm.Ra_CHC_new + Parm.Rapc_new + Parm.Rapc_CHC_new + Parm.Rapn_new 
        + Parm.RКОРккст_new + Parm.RКОРкз_new;
    i = 0;
    while (i < Parm.Racom_new.size)
        orsrv = orsrv + Parm.Racom_new[i].Rez + Parm.Racom_new[i].RezExp;
        i = i + 1;
    end;
    MM_ChangeNoteText(OBJTYPE_MMARKDEAL, UniID(Parm.Deal_fd.tick, OBJTYPE_MMARKDEAL), 11/*MN_CURRENT*/, Parm.OprServDoc.rec.CommDate, orsrv);
END;

PRIVATE MACRO OperGr0(pa1,pa2)
   private var que,rs5,rez;
   que="select count(*) from dacsgroupoper_dbt where t_groupid="+pa2+" and t_oper="+pa1;
   rs5 = LnGetRecordSet(que);
   if(rs5 != null)
     if (rs5.moveNext) 
        if (rs5.value(0) > 0 )
           return true;
        else
           return false;
        end;
      end;
   end;
   return false;
END; 


/****************************************************************************************/
MACRO ExecuteStep(Buffer, Document)
    VAR 
        stat  = 0,ngroup=0,new_deal_pd,ac,
        Parm  = MM_RSRVPARM,
        Error = "",
        AsCategory = 0;

    record tick (dl_tick);
    SetBuff(tick, Document);
    DL_PrepareCarryBuffer (Buffer);
    ngroup = 0;
    if (OperGr0({oper},10030)) 
       ngroup = 63;
    end;

    if ((tick.dealtype == 12335 ) and ( ngroup == 63))
       vari=1;
    else
       vari=0;
    end;

    if ((tick.dealtype == 12306 ) or ((tick.dealtype == 12305) and (tick.partyid == 343) ) ) 
      new_deal_pd = MMFirstDoc(DL_IBCDOC, tick.dealid, true);
      if(not new_deal_pd.OpenAccount("+КОР_Резерв, ОД3", ac, NULL, new_deal_pd.GetFIRoleByCategory("+КОР_Резерв, ОД3", 0), NULL, 0))
        return 1;
      end;    
      if(not new_deal_pd.OpenAccount("-КОР_Резерв, ОД3", ac, NULL, new_deal_pd.GetFIRoleByCategory("+КОР_Резерв, ОД3", 0), NULL, 0))
        return 1;
      end;
    
      if (tick.partyid == 343)  
         if(not new_deal_pd.OpenAccount("+РС, кредиты%000", ac, NULL, new_deal_pd.GetFIRoleByCategory("+РС, кредиты%000", 0), NULL, 0))
            return 1;
         end;    
         if(not new_deal_pd.OpenAccount("-РС, кредиты%000", ac, NULL, new_deal_pd.GetFIRoleByCategory("-РС, кредиты%000", 0), NULL, 0))
            return 1;
         end;    
      end;

      vari=2;
    end;

    if ((tick.dealtype == 12335 ) and (  ngroup != 63 ))
       return 1;
    end;

    if ((tick.dealtype != 12335 ) and (  ngroup == 63 ))
       return 1;
    end;

    if (CheckExistence(LEG_LegKind_DealID_LegID, LEG_KIND_DL_TICK, tick.DealID, 1))
        SvOpSayError(tick.DealCode, MM_RSRV_ERR_BADLEG, "Не найден транш сделки.");
        return 1;
    end;

    Parm.OprServDoc = GetOprServDoc();
    Parm.Deal_fd    = MMFirstDoc(DL_IBCDOC, tick.DealID, true);

    if (GetAttrID(103, tick.DealID, 2, Parm.OprServDoc.rec.CommDate) == 1)
        return 1;
    end;
    ПолучитьРасчетнуюБазу(Parm);
    // получить категорию оценки
    GetMainObjAttr(NULL, OBJTYPE_MMARKDEAL, UniID(Parm.Deal_fd.tick, OBJTYPE_MMARKDEAL), 5, AsCategory, NULL, NULL, Parm.OprServDoc.rec.CommDate);
    // формирование пруденциального резерва
        stat = MM_CalcReserve(Parm);
        if (not stat)
           УстановитьЗначениеККС(Parm.ККС);
           if (not ActAccAfterChangeParm(Parm.Deal_fd, Parm.OprServDoc.rec.CommDate, @Error))
               SvOpSayError(tick.DealCode, MM_RSRV_ERR_BADACTACC, Error);
               return 1;
           end;
        if (AsCategory != FAIR_VAL_COMPR_INCOME)
            stat = ПроводкиШага(Parm);
        else
            stat = ПроводкиШагаССПСД(Parm);
        end;
    end;
    // формирование оценочного резерва
    if ((not stat) and (Parm.OprServDoc.rec.AssesRes) and IsSale(tick.DealGroup))
        if (AsCategory != FAIR_VAL_PROFIT_LOSS)
            РасчетНовойСуммыОценРезерва(Parm);
        end;
            stat = ПроводкиОценРез(Parm);
        end;
    if (not stat)
        СохранитьРезультат(Parm);
    end;

    return stat;
END;
/****************************************************************************************/
NameMacroFile = "mmrsrv_j.mac";
