/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 5.1                                          R-Style Software Lab

  File Name   : mmpp020.mac
                                mm-МБК
                                pp-операция "+Залог МБК" (Pawn Plus) Возврат из залога
                                20-номер (соответствующий шагу)
  Операция    : +Залог МБК
  Шаг         : Возврат из залога
  Comment     :
└───────────────────────────────────────────────────────────────────────────*/
IMPORT mmordcr, mmordfi, RsbDataSet, OprInter;

MACRO ExecuteStep( Buffer, Document)
  var
      stat = 0, isRet = NULL;

  record Order("dl_order");

    SetBuff(Order, Document);

    isRet = TRsbDataSet("select tick.* from ddl_tick_dbt tick, ddl_grnt_dbt grnt "
                        "where "
                        "(grnt.t_DealID = tick.t_DealID) "
                        "and (grnt.t_ContractID = " + Order.ContractID + ") "
                        "and (tick.t_Bofficekind = " + DL_IBCDOC + ") "
                        "and(tick.t_DealStatus <> " + DL_CLOSED + ")");

    if (isRet.MoveNext())
        mm_error("Нельзя выполнить шаг, не по всем сделкам выполнен возврат обеспечения");  
        return 1;  
    end;

    if (not IsCONVERT_RECEIPT(GetOperationGroup(Order.Kind_Operation)))
        stat = MM_OrdPledgeExecCarry(SetFromPledge, Order, -1).ExecCarry();
    else
        stat = MM_OrdPledgeSecurExecCarry(SetFromPledge, Order, -1).ExecCarry();
    end;

    if (not stat)
        stat = FormingInstruction(Order, "В" );
        if (stat == 2)
            stat = 0;
            mm_error("Одна или несколько анкет собственных векселей не найдено");
        end;
    end;

    return stat;
END;


/* Макрос постобработки 
*/
MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

    if (errTrn OR (CommitOrRollback==2)) 
        /* Произошла ошибка или происходит откат */
        return;
    end;

    return 1;
END;


/* Макрос печати 
*/
MACRO PrintStepDocs (
                ID_Operation,  /* Номер экземпляра операции */
                ID_Step,       /* Номер шага операции */
                Kind_Operation,/* Вид операции */
                KindStep)      /* Вид шага операции */

    return 1;
END;
