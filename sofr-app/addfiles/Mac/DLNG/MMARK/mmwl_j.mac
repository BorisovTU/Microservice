/*
$Name: mmwl_j.mac
$Module: МБК
$Description: Макрос выполнение шага "Списание резерва"
*/
IMPORT mmlibr, mmcarry, mmlb_j, mpclb, mmadd_j, mmpaymentcls, mmlb_j,dl_lib;

PRIVATE VAR
    ID_Operation = 0,
    ID_Step      = 0;

PRIVATE MACRO WriteOffLimit(deal, FirstDoc)
    // Формирование проводки
    var Sum;
    VAR carry = MM_Carry, Account = "", deal_pd;

    deal_pd = MMFirstDoc(deal.BOfficekind, deal.DealID, true);

    carry.FIIDPayer    = deal.LimitCur;
    carry.FIIDReceiver = deal.LimitCur;
    carry.Chapter      = 3;
    carry.date_carry   = {curdate};
    carry.PrimaryDoc   = FirstDoc;  

    if (isSale(GetOperationGroup(deal.DealType)))
    // размещение
        ПолучитьОстатокСчета(FirstDoc, tdr_oblP, "", 3, Sum, {curdate}, deal.LimitCur);
        Account = MC_FindAndOpenCommonAccByFD(tdr_corespacc_vb, deal_pd, {curdate}, 0, MC_OPENACC_CREATE, NULL,deal.LimitCur, 
                                                   NULL, NULL, NULL, FIROLE_CORACC_PASSIVE, NULL, NULL, NULL, NULL, NULL, false, false);

        carry.CatPayer         = tdr_oblP;
        carry.AccountReceiver  = Account;
        //carry.CatReceiver      = tdr_corespacc_vb;
        //carry.FiRoleReceiver   = FIROLE_CORACC_PASSIVE;
        carry.Ground           =  MM_ground(deal.dealid,510);
// "Списание лимита по договору КЛ, размещение";
    else
        ПолучитьОстатокСчета(FirstDoc, tdr_oblR, "", 3, Sum, {curdate}, deal.LimitCur);
        Account = MC_FindAndOpenCommonAccByFD(tdr_corespacc_vb, deal_pd, {curdate}, 0, MC_OPENACC_CREATE, NULL,deal.LimitCur, 
                                                   NULL, NULL, NULL, FIROLE_CORACC_ACTIVE, NULL, NULL, NULL, NULL, NULL, false, false);
        carry.AccountPayer     = Account;
        //carry.CatPayer         = tdr_corespacc_vb;
        //carry.FiRolePayer      = FIROLE_CORACC_ACTIVE;
        carry.CatReceiver      = tdr_oblR;
        carry.Ground           = MM_ground(deal.dealid,510);
// "Списание лимита по договору КЛ, привлечение";
    end;
    carry.SumReceiver = Sum;
    if (not carry.carry())
        mm_error ("Ошибка при формировании проводки");
        return 1;
    end;
    return 0;
END;

// Выполнение шага
PRIVATE MACRO ExecuteStep(Buffer, Document, DocKind, IDOperation, IDStep)
    var
        idx = 0;
    record deal( dl_tick );

    SetBuff( deal, Document );

    ID_Operation = IDOperation;
    ID_Step      = IDStep;

    var deal_pd = MMFirstDoc (deal.BOfficeKind, deal.DealID, true);

    if (CheckExistence(LEG_LegKind_DealID_LegID, LEG_KIND_DL_TICK, deal.DealID, 1))
        mm_error( "Не найден транш сделки ", deal.DealCode );
        return 1;
    end;

    if (WriteOffLimit(deal, deal_pd))
        return 1;
    end;
    return 0;

END;

NameMacroFile = "mmwl_j.mac";
