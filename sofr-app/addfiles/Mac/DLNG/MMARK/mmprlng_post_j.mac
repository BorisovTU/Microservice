/*
$Name:        mmprlng_post_j.mac
$Module:      МБ Кредиты
$Description: Построобработка для операций пролонгации
*/
import RsbDataSet, globals, dl_lib;

RECORD tick(dl_tick);

MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -откат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */  
  if (errTrn) 
    /* Произошла ошибка */ 
    return;
  end;  
  if ( CommitOrRollback == 1 )
    setbuff(tick, FirstDoc);
    var Res, cmd;
    cmd = RSDCommand("SELECT DISTINCT tick.t_DealID, tick.t_DealCode, ostep.t_Symbol " +
                          "FROM doprostep_dbt ostep " +
                    "INNER JOIN doprstep_dbt step ON ostep.t_BlockID = step.t_BlockID " +
                           "AND ostep.t_Number_Step = step.t_Number_Step " +
                    "INNER JOIN doprdocs_dbt docs ON step.t_ID_Operation = docs.t_ID_Operation " +
                           "AND step.t_ID_Step = docs.t_ID_Step " +
                    "INNER JOIN doproper_dbt oper ON docs.t_ID_Operation = oper.t_ID_Operation " +
                    "INNER JOIN ddl_tick_dbt tick ON oper.t_DocumentID = tick.t_DealID " +
                         "WHERE ostep.t_Symbol IN ('l','с','j') AND docs.t_DocKind = " + tick.BOfficeKind + " AND docs.t_DocumentID = " + tick.DealID + " ");
    cmd.execute();
    Res = TRsbDataSet(cmd);
    if (Res.MoveNext)
      MM_LinkAccounts(tick.BOfficeKind, Res.DealID, tick.DealID);
    end;
  end;

  return 0;
END;
