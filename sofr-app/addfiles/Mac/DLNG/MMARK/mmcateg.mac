/*
$Name: mmcateg.mac
$Module: МБК
$Description: Процедуры получения параметров документов при работе с категориями учета в МБК           
*/
/*********************************************************************************/
/*         Автоматизированная банковская система RS-Bank v5.1                    */
/*                 Copyright (c) R-Style Software Lab 2001                       */
/*                                                                               */
/*  Имя файла        : mmcateg .mac                                              */
/*                                                                               */
/*  Описание         : Процедуры получения параметров документов при работе с    */
/*                      категориями учета в МБК                                  */
/*********************************************************************************/
IMPORT CTInter, OprInter, mmcachpt, globals, MmarkInter, mmlib, mmcnst_j, mccatacf,fx_globals,funk,fx_globals,dl_lib,dl_plib;

CONST
    MC_TYPE_USPARAMETR_DIRECTION  = 1,
    MC_TYPE_USPARAMETR_STATECONT  = 2,
    MC_TYPE_USPARAMETR_TOOLCATEG  = 3,
    MC_TYPE_USPARAMETR_OTNSEBES   = 4,
    MC_TYPE_USPARAMETR_DIRECTIONP = 5;

/*********************************************************************************/
/* базовый класс - первичные документы для работы с категориями учета            */ 
/*********************************************************************************/
CLASS MMFirstDoc(parm1, parm2, parm3)
    /*private*/ var 
        tick   = TBfile("dl_tick.dbt"),
        leg    = TBfile("dl_leg.dbt"),
        genagr = TBFile("dl_genagr.dbt"),
        contr  = TBFile("sfcontr.dbt");

    private var
        party   = CachedParty,
        CategU  = "",
        withGA  = false;
    private var 
        ParmA        = TArray(), /* массив значений параметров 
                                   Доступ только через GetParametr*/
        ParmB        = TArray(), /* массив значений пользовательских параметров 
                                   Доступ только через GetParametr*/
        FIRoleBArray = TArray(); /* массив базисных ролей ФИ */

    var
       Error = 0,       /* Номер ошибки. Используется для анализа ошибок в ф-ях категорий*/
       Kind  = 0,       /* вид первичного документа*/
       ID    = 0;       /* ID первичного документа*/

///////////////////////////////////////////////////////////////////////////////
    PRIVATE MACRO GetStartDate(_DealID, orDealID)
        var retVal   = date(0, 0, 0), 
            orleg    = TBFile("dl_leg.dbt");

        orDealID = 0;
        while (_DealID > 0)
            orDealID = _DealID;
            _DealID  = MM_DefineOriginalID(_DealID);
        end;

        if (orDealID > 0)
            orleg.rec.LegKind = LEG_KIND_DL_TICK;
            orleg.rec.DealID  = orDealID;
            orleg.rec.LegID   = 1;
            if (GetEQ(orleg))
                retVal = orleg.rec.Start;
            end;
        else
            retVal = leg.rec.Start;
        end;
        SetParm(2, orDealID);
        return retVal;
    END;

    MACRO GetTick()
        return tick.rec;
    END;

    MACRO GetLeg()
        return leg.rec;
    END;

    MACRO GetGenAgr()
        return genagr.rec;
    END;

    MACRO GetContr()
        return contr.rec;
    END;

    MACRO ReInit(_withGenAgr)
        var orDealID, ortick;
        ParmA[MC_TYPE_PARAMETR_PLACE] = {OurBank};
        ParmA[MC_TYPE_PARAMETR_ISSUER] = -1;
        ParmA[MC_TYPE_PARAMETR_CENTR]  = -1;

        if (Kind == DL_IBCDOC)  // режим по сделке/кредитной линии
            var startDate = GetStartDate(tick.rec.DealID, orDealID);
            ParmA[MC_TYPE_PARAMETR_NUMBER]      = tick.rec.DealCode;
            ParmA[MC_TYPE_PARAMETR_DEPARTMENT]  = tick.rec.Department;
            ParmA[MC_TYPE_PARAMETR_CLIENT]      = tick.rec.ClientID;
            ParmA[MC_TYPE_PARAMETR_BEGDATE]     = startDate;
            ParmA[MC_TYPE_PARAMETR_PAYCURRENCY] =
            ParmA[MC_TYPE_PARAMETR_FIID]        =
            ParmA[MC_TYPE_PARAMETR_CURRENCY]    = leg.rec.PFI;
            ParmA[MC_TYPE_PARAMETR_VALDATE]     = leg.rec.Start;
            ParmA[MC_TYPE_PARAMETR_FINDATE]     = leg.rec.Start + Int(leg.rec.Duration);
            ParmA[MC_TYPE_PARAMETR_CONTRACTOR]  =
            ParmA[MC_TYPE_PARAMETR_OWNER]       =
            ParmA[MC_TYPE_PARAMETR_PARTY]       = tick.rec.PartyID;
            ParmA[MC_TYPE_PARAMETR_DOCKIND]     = tick.rec.BOfficeKind;
            ParmA[MC_TYPE_PARAMETR_DOCID]       = tick.rec.DealID;

            if (_withGenAgr)
                ParmA[MC_TYPE_PARAMETR_CONTRACTOR]  =
                ParmA[MC_TYPE_PARAMETR_OWNER]       =
                ParmA[MC_TYPE_PARAMETR_PARTY]       = genagr.rec.PartyID;
                ParmA[MC_TYPE_PARAMETR_NUMBER]      = genagr.rec.CodeInAccount; // .Code;
                ParmA[MC_TYPE_PARAMETR_DEPARTMENT]  = genagr.rec.Department;
            end;
        elif (Kind == DL_CREDITLN)  // режим по кредитной линии
            ParmA[MC_TYPE_PARAMETR_PAYCURRENCY] =
            ParmA[MC_TYPE_PARAMETR_FIID]        =
            ParmA[MC_TYPE_PARAMETR_CURRENCY]    = tick.rec.LimitCur;
            ParmA[MC_TYPE_PARAMETR_BEGDATE]     = GetStartDate(tick.rec.DealID, orDealID);
            ParmA[MC_TYPE_PARAMETR_VALDATE]     = leg.rec.Start;
            ParmA[MC_TYPE_PARAMETR_FINDATE]     = leg.rec.Start + Int(leg.rec.Duration);
            ParmA[MC_TYPE_PARAMETR_CLIENT]      = tick.rec.PartyID;
            ParmA[MC_TYPE_PARAMETR_CONTRACTOR]  =
            ParmA[MC_TYPE_PARAMETR_OWNER]       =
            ParmA[MC_TYPE_PARAMETR_PARTY]       = tick.rec.PartyID;
            ParmA[MC_TYPE_PARAMETR_DOCKIND]     = tick.rec.BOfficeKind;
            ParmA[MC_TYPE_PARAMETR_DOCID]       = tick.rec.DealID;
            ParmA[MC_TYPE_PARAMETR_NUMBER]      = tick.rec.DealCode;
            ParmA[MC_TYPE_PARAMETR_DEPARTMENT]  = tick.rec.Department;
        elif (Kind == 209/*DL_SFCONTR*/)
            ParmA[MC_TYPE_PARAMETR_PAYCURRENCY] =
            ParmA[MC_TYPE_PARAMETR_FIID]        =
            ParmA[MC_TYPE_PARAMETR_CURRENCY]    = contr.rec.FIID;
            ParmA[MC_TYPE_PARAMETR_BEGDATE]     = contr.rec.DateBegin;
            ParmA[MC_TYPE_PARAMETR_VALDATE]     = contr.rec.DateBegin;
            ParmA[MC_TYPE_PARAMETR_FINDATE]     = contr.rec.DateClose;
            ParmA[MC_TYPE_PARAMETR_CLIENT]      = tick.rec.ClientID;
            ParmA[MC_TYPE_PARAMETR_CONTRACTOR]  =
            ParmA[MC_TYPE_PARAMETR_OWNER]       =
            ParmA[MC_TYPE_PARAMETR_PARTY]       = contr.rec.PartyID;
            ParmA[MC_TYPE_PARAMETR_DOCKIND]     = 209/*DL_SFCONTR*/;
            ParmA[MC_TYPE_PARAMETR_DOCID]       = contr.rec.ID;
            ParmA[MC_TYPE_PARAMETR_NUMBER]      = contr.rec.Number;
            ParmA[MC_TYPE_PARAMETR_DEPARTMENT]  = contr.rec.Department;           
        else // режим по ген.соглашению // пользовательские параметры заполняются руками
            ParmA[MC_TYPE_PARAMETR_PAYCURRENCY] =
            ParmA[MC_TYPE_PARAMETR_FIID]        =
            ParmA[MC_TYPE_PARAMETR_CURRENCY]    = ALLFININSTR;
            ParmA[MC_TYPE_PARAMETR_BEGDATE]     =
            ParmA[MC_TYPE_PARAMETR_VALDATE]     = genagr.rec.Start;
            ParmA[MC_TYPE_PARAMETR_FINDATE]     = genagr.rec.Start + Int(genagr.rec.Duration);
            ParmA[MC_TYPE_PARAMETR_CLIENT]      = -1;
            ParmA[MC_TYPE_PARAMETR_CONTRACTOR]  =
            ParmA[MC_TYPE_PARAMETR_OWNER]       =
            ParmA[MC_TYPE_PARAMETR_PARTY]       = genagr.rec.PartyID;
            ParmA[MC_TYPE_PARAMETR_DOCKIND]     = genagr.rec.DocKind;
            ParmA[MC_TYPE_PARAMETR_DOCID]       = genagr.rec.GenAgrID;
            ParmA[MC_TYPE_PARAMETR_NUMBER]      = genagr.rec.CodeInAccount; //.Code;
            ParmA[MC_TYPE_PARAMETR_DEPARTMENT]  = genagr.rec.Department;
        end;
    END;

    MACRO GetParametr(_ParmKind, _OperDate, _CatCode, _FIRole)
        var Parametr = ParmA[_ParmKind];

        if (Parametr == NULL)
            Parametr = -1; 
        end;

        return Parametr;
    END;

    MACRO SetParametr(_ParmKind, _Val)
       ParmA[_ParmKind] = _Val;
    END;

    MACRO GetUsParametr(_ParmKind)
        return ParmB[_ParmKind];
    END;

    MACRO SetUsParametr(_ParmKind, _Val)
       ParmB[_ParmKind] = _Val;
    END;


    /*инициализация массива ролей ФИ, в классах наследниках может переопределяться*/
    MACRO InitFIRoleBArray()
        FIRoleBArray[0] = FIROLE_FIDOC;            // Фи документа
        FIRoleBArray[1] = FIROLE_CORACC_PASSIVE;   // Фи пассивного кор. счета
        FIRoleBArray[2] = FIROLE_CORACC_ACTIVE;    // Фи активного кор. счета
        FIRoleBArray[3] = FIROLE_RVPS;             // РВПС
        FIRoleBArray[4] = FIROLE_RVP;              // РВП
        FIRoleBArray[5] = FIROLE_ODAV;             // ОД после востребования
    END;

    MACRO GetFIRoleBArray()
        return FIRoleBArray;
    END;

    MACRO GetBasisFIRole(_FIRole)
        var i = 0;

        if (_FIRole == FIROLE_UNDEF)
            return FIROLE_FIDOC;
        elif (_FIRole > 10000) // счета по ген. соглашениям ведутся в этом диапазоне
            return _FIRole;
        end;

        while (i < FIRoleBArray.Size)
            if (FIRoleBArray[i] == _FIRole)
                return _FIRole;
            end;
            i = i + 1;
        end;
        Error = 1;

        return FIROLE_UNDEF;
    END;

    /*Получить параметры шаблона*/
    MACRO GetParametrTemplate
    ( 
        _ObjectID,       /*   параметр - номер справочника                 */
        _Classificator,  /*   классификатор - номер классификатора, если он задан */
        _OperDate,       /*   дата, на которую надо вернуть характеристики*/
        _FIRole
    )         
       private macro GetParametr5000(v_FIID)
          var retval = -1;

          var query = "select t_element from dllvalues_dbt where t_list = 5000 and t_flag = ?";  
          var cmd   = DL_RSDCommand(query);         

          cmd.AddParam(v_FIID);
          var rs = cmd.Execute();
          if(rs.movenext())
             retval = rs.element;
          end;
          return retval;
       end;
        
        var
            Parametr = -1, /*По умолчанию */
            ККС = 0,rs59,qque;

        if (ValType(_OperDate) != V_DATE)
            _OperDate = {curdate};
        end;
        /*Направление - НаправлениеКред = 144*/
        if((_ObjectID == OBJTYPE_DIRECTION) AND (_Classificator == LLCLASS_DIRECTION_MM))
              // если параметр задан явно, то берем его
              if (GetUsParametr(MC_TYPE_USPARAMETR_DIRECTION) == NULL)
                  if (isSale(GetOperationGroup(tick.rec.DealType)))    
                      Parametr = 2;
                  else
                      Parametr = 1;
                  end;
              else
                  Parametr = GetUsParametr(MC_TYPE_USPARAMETR_DIRECTION)
              end;

        /*Состояние контракта - состояние контракта = 156*/             
        elif( (_ObjectID == OBJTYPE_STATECONT) AND  (_Classificator == LLCLASS_STATECONT_DEALMM)  )
              // если параметр задан явно, то берем его
              if (GetUsParametr(MC_TYPE_USPARAMETR_STATECONT) == NULL)
                  if (tick.rec.Flag1 == "X")
                      Parametr = 2;
                  else
                      Parametr = 1;
                  end;			
              else
                  Parametr = GetUsParametr(MC_TYPE_USPARAMETR_STATECONT)
              end;

        /*Вид субъекта*/
        elif (_ObjectID == OBJTYPE_KINDSUBJ)
            /*Вид субъекта - КонтрДохРасхКр*/
            if (_Classificator == LLCLASS_KINDSUBJ_KDRKR)
              Parametr = party.GetKindKDRKR(ParmA[MC_TYPE_PARAMETR_PARTY]);
            else
              Parametr = party.GetKind ( ParmA[MC_TYPE_PARAMETR_PARTY] );
            end;

        /* Категории средств, КатегСредстЗадолж = 190 */
        elif( ( _ObjectID == OBJTYPE_TOOLCATEGORY ) AND ( _Classificator == LLCLASS_TOOLCATEG_DEBTS ) )
              // если параметр задан явно, то берем его
              if (GetUsParametr(MC_TYPE_USPARAMETR_TOOLCATEG) == NULL)
                  if(Index ( tick.rec.TypeDoc, "L" ) != 0)
                    Parametr = 1;
                  elif (Index ( tick.rec.TypeDoc, "D" ) != 0)
                    Parametr = 2;
                  elif (Index ( tick.rec.TypeDoc, "U" ) != 0)
                      if ((CategU == tdr_mainrest) or (CategU == tdr_odmainrest))
                          Parametr = 3;
                      elif (CategU == tdr_exprestP)
                          Parametr = 2;
                      elif (CategU == tdr_exppercP)
                          Parametr = 2;
                      end;
                  end;  
              else
                  Parametr = GetUsParametr(MC_TYPE_USPARAMETR_TOOLCATEG)
              end;

        elif (_ObjectID==OBJTYPE_BACKOFFICE)             /*1118*/
            if (_Classificator==LLCLASS_BACKOFFICE)                   /*180*/
               return 2; /* МБК - межбанковские кредиты */
            end;			

        /*Категория заемщика - категория заемщика*/
        elif((_ObjectID == OBJTYPE_CATEGZAEM) AND (_Classificator == LLCLASS_CATEGZAEM_ZAEM))
            Parametr = 1;
		
        /*Категория заемщика - категория заемщика при списании процентов*/
        elif((_ObjectID == OBJTYPE_CATEGZAEM) AND (_Classificator == LLCLASS_CATEGZAEM_ZAEMPR))
            if(party.GetKind(ParmA[MC_TYPE_PARAMETR_PARTY]) == 1)
              Parametr = 3;
            else
              Parametr = 1;
            end;		

        /*Способ списания - Способ списания задолженности*/
        elif((_ObjectID == OBJTYPE_TYPESPIS) AND (_Classificator == LLCLASS_TYPESPIS_DOLG))
            Parametr = 2;

        /*Продукт - продукт в др. расходах*/
        elif ((_ObjectID == OBJTYPE_PRODUCT) AND (_Classificator == LLCLASS_PRODUCT_ANRAS))
                Parametr = 102;                

        /*Продукт - продукт в доходах/расходах*/
        elif ((_ObjectID == OBJTYPE_PRODUCT) AND (_Classificator == LLCLASS_PRODUCT_RKO))
                Parametr = 203;                


        elif ((_ObjectID == 5000) and (_Classificator == 5000))
	   parametr=GetParametr5000(leg.rec.pfi);

        elif ((_ObjectID == 5022) and (_Classificator == 5022))
           if ( tick.rec.Dealtype == 12335 )
	     parametr=1;
	   else
	     parametr=0;
	   end;

        elif ((_ObjectID == 5021) and (_Classificator == 5021))

	   if (leg.rec.pfi == 0 )
              parametr=0;
           else
              parametr=1;
           end;
        
        elif ((_ObjectID == 5020) and (_Classificator == 5020))           
           if (tick.rec.flag1 == "X")  //SVE 512417 02.07.20 при пролонгации длительность сделки надо считать от даты заключения первой сделки - DealDate
	      if (( leg.rec.maturity - GetStartDate(tick.rec.DealID) ) > 7 ) // 21.01.2021 MAA: iS - 520902.
                 parametr=2;
              else
                 parametr=1;
              end;                      
           else                        //SVE 509411 15.05.20 для простых сделок (не пролонгаций) определять длительность сделки будет корректнее через значение tick.rec.duration, так как дата валютирования может не совпадать с датой заключения
	      if (leg.rec.duration > 7)
                 parametr=2;
              else
                 parametr=1;
              end;
           end;


        /* Отнесение на себестоимость - 1117 */                   /* ОтнНаСебест - 172 */
        elif((_ObjectID == OBJTYPE_OTNSEBEST) AND (_Classificator == LLCLASS_OTNSEBEST_SEBEST))
              // если параметр задан явно, то берем его
              if (GetUsParametr(MC_TYPE_USPARAMETR_OTNSEBES) == NULL)
                  if (_FIRole == FIROLE_RVPS)
                      ККС = ПолучитьКатегориюКачества( tick.rec.DealID, _OperDate );
                      if(ККС > 1)
                          Parametr = 1;  /* В налогооблагаемой базе */
                      else
                          Parametr = 2;  /* Вне налогооблагаемой базы */
                      end;
      	          elif (_FIRole == FIROLE_RVP)
                      Parametr = -1;
      	          end;
              else
                  Parametr = GetUsParametr(MC_TYPE_USPARAMETR_OTNSEBES)
              end;

        /*Направление - направление выплат = 158*/
        elif((_ObjectID == OBJTYPE_DIRECTION) AND (_Classificator == LLCLASS_DIRECTION_PAYMM))
              // если параметр задан явно, то берем его
              if (GetUsParametr(MC_TYPE_USPARAMETR_DIRECTIONP) == NULL)
                  if (isSale(GetOperationGroup(tick.rec.DealType)))    
                      Parametr = 3;
                  else
                      Parametr = 4;
                  end;
              else
                  Parametr = GetUsParametr(MC_TYPE_USPARAMETR_DIRECTIONP)
              end;

        /*Вид штрафа - вид штрафа*/
        elif((_ObjectID == OBJTYPE_KINDSHTRAF) AND (_Classificator == LLCLASS_KINDSHTRAF_SHTRAF))
            Parametr = 1;

        elif (_ObjectID == OBJTYPE_SIDEBALANCE)          /*1000 - справочник сторон баланса*/
            if (_Classificator == LLCLASS_SIDEBALANCE_CORACCKIND)       // 1622 - Вид корреспондирующего счета

               if(_FIRole == FIROLE_CORACC_PASSIVE)
                  return 2;  //Пассивный
               elif(_FIRole == FIROLE_CORACC_ACTIVE)
                  return 1; // Активный2; // Пассивный
               end;
            end;

        elif ((_ObjectID == 1060) AND (_Classificator == 515))
            Parametr = 14;

        //Нацвалютный?
        elif (_Classificator = 505)
            if (Kind == 209/*DL_SFCONTR*/)
                if (contr.rec.FIID == NATCUR)
                    Parametr = 1;
                else
                    Parametr = 0;
                end;
            end;
        end;

        if(_Classificator == 126)
         qque="select count(*) from dnotetext_dbt  where t_notekind=300  and t_objecttype=3 and t_documentid = lpad("+tick.rec.partyid+",10,'0') and  RSB_Struct.GetInt(t_text)= 1 ";
          rs59 = LnGetRecordSet(qque);
          if(rs59 != null)
            if (rs59.moveNext) 
              if (int(rs59.value(0)) > 0 )
                Parametr = 3;
              end;
            end;
          end;

          if (tick.rec.partyid == 113834)
                Parametr = 2;
          end;

        end;

        if(_Classificator == 123)
          Parametr = 2;
          qque="select count(*) from dparty_dbt where t_notreSident='X' and t_partyid="+tick.rec.partyid;
          // msgbox(qque);
          rs59 = LnGetRecordSet(qque);
          if(rs59 != null)
            if (rs59.moveNext) 
              if (int(rs59.value(0)) > 0 )
                Parametr = 3;
              end;
            end;
          end;
          if (tick.rec.partyid == _BANK_RF)
                Parametr = 1;
          end;
/*
          if (tick.rec.partyid == 26)
                Parametr = 3;
          end;
*/


         qque="select count(*) from dnotetext_dbt  where t_notekind=300  and t_objecttype=3 and t_documentid = lpad("+tick.rec.partyid+",10,'0') and  RSB_Struct.GetInt(t_text)= 1 ";
          rs59 = LnGetRecordSet(qque);
          if(rs59 != null)
            if (rs59.moveNext) 
              if (int(rs59.value(0)) > 0 )
                Parametr = 3;
              end;
            end;
          end;



        end;




        return Parametr;
    end;

    /*Макрос корректировки открываемого счета. Account, accblnc, ORScheme можно менять*/
    MACRO CorrectAccount(_account_, _accblnc_, _ORScheme_, categ, templ, accdoc,  OperDate)
    //return true;
      private var jj,i,rs9,rs10,que,tran,osn;

      if (( categ.rec.Code == tdr_mainrest) or ( categ.rec.Code == tdr_claimP ) or ( categ.rec.Code == tdr_claimR ) )
         _account_.rec.nameaccount = NAMI(this.tick.rec.partyid)+" № "+this.tick.rec.dealcodets+" ОТ "+SDAT(this.tick.rec.dealdate);
          if (( this.tick.rec.partyid == _BANK_RF) and  ( (this.tick.rec.dealtype == 12300) OR (this.tick.rec.dealtype == 32300) ) and (this.tick.rec.genagrid > 0))

            que="select t_start, t_code from ddl_genagr_dbt where t_genagrid =" + this.tick.rec.genagrid;
            rs10 = LnGetRecordSet(que);
            if(rs10 != null)
              if(rs10.moveNext())
                _account_.rec.nameaccount = "ОПЕРАЦИОННЫЙ ДЕПАРТАМЕНТ БАНКА РОССИИ Договор от " + SDAT(rs10.value("t_start")) + " №" + rs10.value("t_code") + ", кредит No " +this.tick.rec.dealcode+" от "+SDAT(this.tick.rec.dealdate);
              end;
            end;

            if ( categ.rec.Code == tdr_claimP ) 
               _account_.rec.nameaccount ="Обяз-ва по %% "+ _account_.rec.nameaccount;
            end;
          else
            if ( categ.rec.Code == tdr_claimP ) 
               _account_.rec.nameaccount ="Обязательства по процентам по сделке "+ _account_.rec.nameaccount;
            elif ( categ.rec.Code == tdr_claimR )
               _account_.rec.nameaccount ="Требования по процентам по сделке "+ _account_.rec.nameaccount;
            end;
          end;
      end;
      // SVE 489998
      record partybuf("party.dbt"); 
      ПолучитьСубъекта(this.tick.rec.partyid, partybuf);
      if ( (SubStr(this.tick.rec.dealcode, 1, 1) == "R") or (SubStr(this.tick.rec.dealcode, 1, 3) == "IRU") )
         if (categ.rec.Code == tdr_claimR) //47427
            _account_.rec.nameaccount = "Начисленные проценты по предоставленным денежным средствам по рамбусу " + this.tick.rec.dealcode + 
                                        " от " + this.tick.rec.dealdate + " / " + partybuf.name;
         elif (categ.rec.Code == tdr_mainrest_tf)  //47410
            _account_.rec.nameaccount = "Требование по оплаченному рамбусу " + this.tick.rec.dealcode + " от " + this.tick.rec.dealdate + " / " + partybuf.name;
         end;
      elif ( SubStr(this.tick.rec.dealcode, 1, 3) == "ELC" )
         if (categ.rec.Code == tdr_claimR) //47427
            _account_.rec.nameaccount = "Начисленные проценты по предоставленным денежным средствам по аккредитиву " + this.tick.rec.dealcode + 
                                        " от " + this.tick.rec.dealdate + " / " + partybuf.name;
         elif (categ.rec.Code == tdr_mainrest_tf)  //47410
            _account_.rec.nameaccount = "Требование по аккредитиву " + this.tick.rec.dealcode + " от " + this.tick.rec.dealdate + " / " + partybuf.name;
         end; 
      end;
	  
	  //SVE 491648
      if (this.tick.rec.dealtype == 12301)
         if ( (categ.rec.code == tdr_odmainrest) or (categ.rec.code == tdr_odmainrest2) )
            _account_.rec.nameaccount = "Кредит, полученный в порядке расчетов по корреспондентскому счету (""овердрафт"") " + GetPartyNames(this.tick.rec.partyid, 1).value(0) + " от " + this.tick.rec.dealdate; //Указывается полное наименование субъекта
         end;
         if ( (categ.rec.Code == tdr_claimR) or (categ.rec.Code == tdr_claimP) )
            _account_.rec.nameaccount = GetPartyNames(this.tick.rec.partyid, 1).value(0) + " от " + this.tick.rec.dealdate + " (""овердрафт"")";
         end;
      end;

      if (substr(categ.rec.Code,1,18) == "-Обесп. кр., ц/б_K" )
          // T_REALTYNAME
          jj=int(substr(categ.rec.Code,19));
          i=1;

          que="select rownum, b.t_cost amount ,b.t_fiid fiid ,b.t_crdnumber transh, b.t_valuationdate da0 ,b.t_contractor partyid, T_REALTYNAME transh2  from ddl_grnt_dbt a , ddl_secur_dbt b where t_dealid="+this.tick.rec.dealID+" and b.t_contractid=a.t_contractid order by t_numsecinorder";
          rs9 = LnGetRecordSet(que);
          if(rs9 != null)
            while(rs9.moveNext())
              if (i == jj )
                tran=rs9.value("transh");
                 if ( strlen(rs9.value("transh2")) > strlen(tran) )
                   tran=rs9.value("transh2");
                 end;
                 tran=strsubst(tran,"в рамках договора","в рамках КД");
                _account_.rec.nameaccount ="Обеспечение "+nami(rs9.value("partyid"))+" "+tran+" от "+SDAT(rs9.value("da0"))+" согл. извещения от "+SDAT(this.tick.rec.dealdate)+" № "+this.tick.rec.dealcode;

                if (this.tick.rec.genagrid > 0)
                    que="select t_start, t_code from ddl_genagr_dbt where t_genagrid =" + this.tick.rec.genagrid;
                    rs10 = LnGetRecordSet(que);
                    if(rs10 != null)
                        if(rs10.moveNext())
                              _account_.rec.nameaccount = _account_.rec.nameaccount + " (ГКД №" + rs10.value("t_code")+ " от " + SDAT(rs10.value("t_start"));
                            if (this.tick.rec.partyid == _BANK_RF)
                               _account_.rec.nameaccount = _account_.rec.nameaccount + " ЦБ РФ)";
                            else
                               _account_.rec.nameaccount = _account_.rec.nameaccount + " " + nami(this.tick.rec.partyid) + ")"; 
                            end;
                        end;
                    end;
                end;
              end;
              i=i+1;
            end;
         end;

      end;


      if (( categ.rec.Code == tdr_rezadjodR) or ( categ.rec.Code == tdr_rezadjodP ) )
         _account_.rec.nameaccount = "Корректировка резервов на возможные потери. Сделка N "+this.tick.rec.dealcode+" от "+SDAT(this.tick.rec.dealdate)+" c "+nami(this.tick.rec.partyid);
      end;

      if (( categ.rec.Code == tdr_rezadjprcR) or ( categ.rec.Code == tdr_rezadjprcP ) )
         _account_.rec.nameaccount = "Корректировка резервов на возможные потери по %% . Сделка N "+this.tick.rec.dealcode+" от "+SDAT(this.tick.rec.dealdate)+" c "+nami(this.tick.rec.partyid);
      end;

      if (( categ.rec.Code == tdr_rezadjod2R) or ( categ.rec.Code == tdr_rezadjod2P ) )
         _account_.rec.nameaccount = "Корректировка резервов на возможные потери по ОД по "+this.tick.rec.dealcode+"/"+nami(this.tick.rec.partyid);
      end;

      if (( categ.rec.Code == tdr_rezadjprc0R) or ( categ.rec.Code == tdr_rezadjprc0P ) )
         _account_.rec.nameaccount = "Корректировка резервов на возможные потери по %% по "+this.tick.rec.dealcode+"/"+nami(this.tick.rec.partyid);
      end;

      if (( categ.rec.Code == tdr_oblP) or ( categ.rec.Code == tdr_oblR ) )
          _account_.rec.nameaccount ="Лимит задолженности "+ NAMI(this.tick.rec.partyid)+this.tick.rec.comment;
          if ( this.tick.rec.partyid == _BANK_RF) 
              _account_.rec.nameaccount ="Лимит задолженности ОПЕРАЦИОННЫЙ ДЕПАРТАМЕНТ БАНКА РОССИИ "+this.tick.rec.comment;
          end;
      end;



      if ( this.tick.rec. parentid > 0 )
        if (( categ.rec.Code == tdr_mainrest) or ( categ.rec.Code == tdr_claimP ) or ( categ.rec.Code == tdr_claimR )  )
          que="select t_comment from ddl_tick_dbt where t_dealid="+this.tick.rec.parentid;
          rs9 = LnGetRecordSet(que);
          if(rs9 != null)
            while(rs9.moveNext())
              osn=rs9.value(0);
              i=index(osn,"года");
              if ( i > 0 )
                 osn=substr(osn,1,i+4)+", кредит № "+this.tick.rec.dealcode+" от "+SDAT(this.tick.rec.dealdate)+" "+substr(osn,i+5);
              end;

	      _account_.rec.nameaccount = NAMI(this.tick.rec.partyid)+" "+osn;
              if ( this.tick.rec.partyid == _BANK_RF) 
               _account_.rec.nameaccount ="ОПЕРАЦИОННЫЙ ДЕПАРТАМЕНТ БАНКА РОССИИ "+osn;

              end;

              if ( categ.rec.Code == tdr_claimP ) 
                 _account_.rec.nameaccount ="Обяз-ва по %%  "+ _account_.rec.nameaccount;
              end;
            end;
          end;
        end;

      end;



      if  (categ.rec.code == tdr_47440) 
           _account_.rec.nameaccount = "Затраты по сделке по финансовым обязательствам и финансовым активам, увеличивающие процентные расходы   от " + this.tick.rec.dealdate+" № " + this.tick.rec.dealcode +  " К/агент: " + partybuf.name;
          if ( this.tick.rec. parentid > 0 )
              if ( this.tick.rec.partyid == _BANK_RF) 
               _account_.rec.nameaccount = "Затраты по сделке по финансовым обязательствам и финансовым активам, увеличивающие процентные расходы, по Договору об открытии безотзывной кредитной линии   от " + this.tick.rec.dealdate+" № " + this.tick.rec.dealcode +  " К/агент: ОПЕРАЦИОННЫЙ ДЕПАРТАМЕНТ БАНКА РОССИИ ";
              else
               _account_.rec.nameaccount = "Затраты по сделке по финансовым обязательствам и финансовым активам, увеличивающие процентные расходы, по Договору об открытии безотзывной кредитной линии   от " + this.tick.rec.dealdate+" № " + this.tick.rec.dealcode +  " К/агент: " + partybuf.name;
              end;
          end;
      end;


      if  (categ.rec.code == tdr_47442) 
           _account_.rec.nameaccount = "Расчеты по расходам по сделке по финансовым обязательствам и финансовым активам, увеличивающие процентные расходы   от " + this.tick.rec.dealdate+" № " + this.tick.rec.dealcode +  " К/агент: " + partybuf.name;
          if ( this.tick.rec. parentid > 0 )
              if ( this.tick.rec.partyid == _BANK_RF) 
               _account_.rec.nameaccount = " Расчеты по расходам по сделке по финансовым обязательствам и финансовым активам, увеличивающие процентные расходы, по Договору об открытии безотзывной кредитной линии   от " + this.tick.rec.dealdate+" № " + this.tick.rec.dealcode +  " К/агент: ОПЕРАЦИОННЫЙ ДЕПАРТАМЕНТ БАНКА РОССИИ ";
              else
               _account_.rec.nameaccount = " Расчеты по расходам по сделке по финансовым обязательствам и финансовым активам, увеличивающие процентные расходы, по Договору об открытии безотзывной кредитной линии   от " + this.tick.rec.dealdate+" № " + this.tick.rec.dealcode +  " К/агент: " + partybuf.name;
              end;
          end;
      end;


        _account_.rec.oper  = execmacrofile("role_model.mac", "GetMainOperInGroup",this.tick.rec.bofficekind,this.tick.rec.dealtype) ;


        return true;
    END;

    PRIVATE MACRO GetPeriodNumber()
        var
           per = 1;

        if ((GetParametr(MC_TYPE_PARAMETR_FINDATE) - GetParametr(MC_TYPE_PARAMETR_BEGDATE)) == 0)
            per = 1;
        end;

        if ((GetParametr(MC_TYPE_PARAMETR_FINDATE) - GetParametr(MC_TYPE_PARAMETR_BEGDATE)) == 1)
            per = 2;
        end;

        if ((GetParametr(MC_TYPE_PARAMETR_FINDATE) - GetParametr(MC_TYPE_PARAMETR_BEGDATE)) >= 2)
            per = 3;
        end;

        if ((GetParametr(MC_TYPE_PARAMETR_FINDATE) - GetParametr(MC_TYPE_PARAMETR_BEGDATE)) >= 8)
            per = 4;
        end;

        if ((GetParametr(MC_TYPE_PARAMETR_FINDATE) - GetParametr(MC_TYPE_PARAMETR_BEGDATE)) >=31)
            per = 5;
        end;

        if ((GetParametr(MC_TYPE_PARAMETR_FINDATE) - GetParametr(MC_TYPE_PARAMETR_BEGDATE)) >= 91)
            per = 6;
        end;

        if ((GetParametr(MC_TYPE_PARAMETR_FINDATE) - GetParametr(MC_TYPE_PARAMETR_BEGDATE)) >= 181)
            per = 7;
        end;

        if ((GetParametr(MC_TYPE_PARAMETR_FINDATE) - GetParametr(MC_TYPE_PARAMETR_BEGDATE)) >= 365)
            per = 8;
        end;

        if ((GetParametr(MC_TYPE_PARAMETR_FINDATE) - GetParametr(MC_TYPE_PARAMETR_BEGDATE)) >=1095)
            per = 9;
        end;

        return per;
    END;

    MACRO GetFIRoleByCategory(Categ, FIID)
        var
            FiRole = NULL, rs = NULL;

        if (((Categ == tdr_mainrest) or (Categ == tdr_odmainrest)) and
            (((Kind == DL_IBCDOC)    and
             (withGA)                and 
             (tick.rec.GenAgrID > 0) and
             (genagr.rec.AccMode == 2)) or
            (Kind == 4611)))
            FiRole = String(GetParametrTemplate(OBJTYPE_DIRECTION,    LLCLASS_DIRECTION_MM))     +
                      String(GetParametrTemplate(OBJTYPE_STATECONT,    LLCLASS_STATECONT_DEALMM)) +
                      String(GetParametrTemplate(OBJTYPE_TOOLCATEGORY, LLCLASS_TOOLCATEG_DEBTS))  +
                      String(GetPeriodNumber()) + String(FIID);

            rs = TrsbDataSet("select to_number(replace('" +FiRole + "', -1, 0)) as firole from dual");
            rs.MoveNext();
            FiRole = Int(rs.FiRole);
        end;

        return FiRole;
    END;

    PRIVATE MACRO FindAndOpenAccountEx(
    CodeCat,            // код категории
    FD,                 // первичный документ
    ActionDate,         // дата действия
    IsMass,             // признак "тихой" работы
    IsOpen,             // режим поиска/создания счёта
    AccBuf,             // буфер для найденного/открытого счёта (account.dbt)
    CurryCurrency,      // ФИ создаваемого счёта
    ORScheme,           // схема переоценки
    PairAccMode,        // режим определения парного счёта
    NumberForAcc,       // номер счёта
    FIRole,             // роль финансового инструмента
    Result,             // результат
    AccDoc,             // найденный/открытый счёт (mcaccdoc.dbt)
    DepartmentID,       // номер узла ТС
    ActivateDate,       // дата начала действия счёта
        Initiator,          // владелец счета
        ID_Operation,
        ID_Step
    )
var
        BackOutAccount = false, ChangeOpenDate  = false;
        MC_GetAccountOpenParms( CodeCat, @BackOutAccount, @ChangeOpenDate );
        BackOutAccount = true;
    BackOutAccount = 2;      //SVE 513826 002.09.2020 По просьбе банка при откате сделки откатываем открытие счета, значение 2 означает что при возникновении ошибки прервать откат шага
    return MC_FindAndOpenAccount(
        CodeCat,
        FD,
        ActionDate,
        IsMass,
        IsOpen,
        AccBuf,
        CurryCurrency,
        ORScheme,
        PairAccMode,
        NumberForAcc,
        FIRole,
        Result,
        AccDoc,
        DepartmentID,
        Initiator,
        ActivateDate,
        BackoutAccount,
            ChangeOpenDate,
            null,
            null,
            null,
            ID_Operation,
            ID_Step
    )
END;

    /* Получить счет по категории учета
       Вернет false, если ошибка или отказ от ввода счета.
       ! если не установлен NoErrMes выдаст сообщение об ошибке
    */
    PRIVATE MACRO GetAccountByCatCode
    ( 
        _CatCode,     // код категории
        FindAccount_, // здесь вернется номер счета
        /*необязательные параметры*/
        _AccCreate,   // признак верификации\открытия лицевого счета
        _NoErrMes,     // признак молчаливого выполнения - ошибку не выдаем
        _FIRole,      // роль ФИ
        AccBuf_,      // буфер для возврата информации по найденному\открытому счету
        _ActionDate,  // дата
        _FIID         // валюта
    )
       var IsMass = 0;

        FindAccount_  = "";


        if ((tick.rec.dealtype == 12306) and  (_CatCode == tdr_mainrest ))
            _CatCode=tdr_47802;
        end;

        if ((tick.rec.dealtype == 12301) and  (_CatCode == tdr_mainrest ))
            _CatCode=tdr_odmainrest;
        end;


        if (Error != 0)
            return false;
        end;

       CategU = _CatCode;

        if (((_NoErrMes == null)or(_NoErrMes == false)) and 
            (not isOprMultiExec()) 
           )
            IsMass = 0;
        else /*либо массовый режим, либо принудительно просим не орать ошибки*/
            IsMass = 1;
        end;

        if( ValType(_AccCreate) == V_UNDEF )
            _AccCreate = MC_OPENACC_CREATE;
        end;

        if( _AccCreate != 4 )
            FindAccount_ = FindAndOpenAccountEx(
                                                   _CatCode,
                                                   this,
                                                   _ActionDate,
                                                   IsMass,
                                                   _AccCreate,
                                                   AccBuf_,
                                                   _FIID,
                                                   NULL, NULL, NULL,
                                                   _FIRole
                                                  );
        else
            FindAccount_ = MC_GetAccountNumber(
                                               _CatCode, this,_ActionDate,
                                               IsMass, _FIID, _FIRole
                                              );
        end;

        if (FindAccount_ == "")
            if (IsMass == 0)
                 msgbox("Счет категории \"" + _CatCode + "\" неопределен.");
            end;  

            return false;
        end;

        SetParm(2, FindAccount_);

        return true;
    END;

    /*актуализация счета (без открытия)*/  
    MACRO ActualAccount(_CatCode, FindAccount_, _NoErrMes, _FIRole, AccBuf_, _ActionDate, _FIID)
        var retVal = true, Account = "";
        retVal = GetAccountByCatCode(_CatCode, Account, MC_OPENACC_ACT, _NoErrMes, _FIRole, AccBuf_, _ActionDate, _FIID);
        SetParm(2, Account); 
        return retVal;
    END;

    /*Актуализация с проверкой срочности*/  
    MACRO ActualCheckPeriod(_CatCode, FindAccount_, _NoErrMes, _FIRole, AccBuf_, _ActionDate, _FIID)
        var retVal = true, Account = "";
        retVal = GetAccountByCatCode(_CatCode, Account, MC_OPENACC_CHECKPERIOD, _NoErrMes, _FIRole, AccBuf_, _ActionDate, _FIID);
        SetParm(2, Account); 
        return retVal;
    END;  

    /*открытие и актуализация счета*/  
    MACRO OpenAccount(_CatCode, FindAccount_, _NoErrMes, _FIRole, AccBuf_, _ActionDate, _FIID)
        var retVal = true, Account = "";
        retVal = GetAccountByCatCode(_CatCode, Account, MC_OPENACC_CREATE, _NoErrMes, _FIRole, AccBuf_, _ActionDate, _FIID);
        SetParm(2, Account); 
        return retVal;
    END;  

    /*переоткрытие и актуализация счета - если счет нашли, его все равно пересоздать*/  
    MACRO ReOpenAccount(_CatCode, FindAccount_, _NoErrMes, _FIRole, AccBuf_, _ActionDate, _FIID)
        var retVal = true, Account = "";
        retVal = GetAccountByCatCode(_CatCode, Account, MC_OPENACC_RECREATE, _NoErrMes, _FIRole, AccBuf_, _ActionDate, _FIID);
        SetParm(2, Account); 
        return retVal;
    END;

    /*аннулирование счета по категории*/
    MACRO CloseAccount(_CatCode, _ActionDate, _FIRole, _FIID, _NoErrMes )
        var retVal = true;
        retVal = MC_FindAndCloseAccount(_CatCode, this, _ActionDate, _FIRole, _FIID);
        if ((retVal != 0)and((_NoErrMes == null)or(_NoErrMes == false)))
           msgbox("Ошибка при закрытии счета по категории ", _CatCode);
        end;

        if( retVal != 0 )
           return false; 
        else
           return true; 
        end;      
    END;

    /*проверка на существование счета*/  
    MACRO IsExistAccount(_CatCode, FindAccount_, _NoErrMes, _FIRole, AccBuf_, _ActionDate, _FIID)
        var retVal = true, Account = "";
        retVal = GetAccountByCatCode(_CatCode, Account, MC_OPENACC_CHECKEXIST, _NoErrMes, _FIRole, AccBuf_, _ActionDate, _FIID);
        SetParm(2, Account); 
        return retVal;
    END;  

    /*проверка на актуализацию счета*/  
    MACRO IsActAccount(_CatCode, FindAccount_, _NoErrMes, _FIRole, AccBuf_, _ActionDate, _FIID)
        var retVal = true, Account = "";
        retVal = GetAccountByCatCode(_CatCode, Account, MC_OPENACC_CHECKACT, _NoErrMes, _FIRole, AccBuf_, _ActionDate, _FIID);
        SetParm(2, Account); 
        return retVal;
    END;  

    /*получить - найти или сформировать номер счета (без открытия)*/  
    MACRO FindNumberAccount(_CatCode, FindAccount_, _NoErrMes, _FIRole, _FIID)
        var retVal = true, Account = "";
        retVal = GetAccountByCatCode(_CatCode, Account, 4, _NoErrMes, _FIRole, NULL, NULL, _FIID);
        SetParm(2, Account); 
        return retVal;
    END;

    MACRO GetRestAccount(_CatCode, _Date, _FIID, _Chapter, _FIRole, WithMark)
        var 
            retVal = Money(0), Account = "";

        if (ValType(WithMark) == V_UNDEF)
            WithMark = false;
        end;

        if (_FIRole == NULL)
            _FIRole = GetFIRoleByCategory(_CatCode, _FIID)
        end;


        if (IsExistAccount(_CatCode, Account, 1, _FIRole, NULL, _Date, _FIID))
            retVal = RestA(Account, _Date, NULL, _Chapter, _FIID);
        end;

        if (WithMark)
            return Money(retVal);
        end;

        return Money(abs(retVal));
    END;

// Constructor
    if ((ValType(parm1) == V_INTEGER) and
        (ValType(parm2) == V_INTEGER)   and
        (parm1 == DL_IBCDOC))
        //Конструктор из DocKind, DocID
        tick.rec.DealID = parm2;
        if (tick.GetEQ)
            leg.rec.LegKind = LEG_KIND_DL_TICK;
            leg.rec.DealID    = parm2;
            leg.rec.LegID     = 1;
            if (not leg.GetEQ)
                return NULL;
            end;
        else
            return NULL;
        end;

        if (tick.rec.GenAgrID > 0)
            genagr.rec.GenAgrID = tick.rec.GenAgrID;
            if (not genagr.GetEQ)
                return NULL;
            end;
        end;

        Kind = parm1;
        Id   = parm2;
    elif ((ValType(parm1) == V_INTEGER) and
          (ValType(parm2) == V_INTEGER) and
          (parm1 == DL_CREDITLN))
        tick.rec.DealID = parm2;
        if (tick.GetEQ)
            leg.rec.LegKind = LEG_KIND_DL_TICK;
            leg.rec.DealID    = parm2;
            leg.rec.LegID     = 1;
            if (not leg.GetEQ)
                return NULL;
            end;
        else
            return NULL;
        end;

        Kind = parm1;
        Id   = parm2;
    elif ((ValType(parm1) == V_INTEGER) and
          (ValType(parm2) == V_INTEGER)   and
          (parm1 == 4611)) // Ген. Соглашение МБК 
        //Конструктор из DocKind, DocID

         genagr.rec.GenAgrID = parm2;
         if (not genagr.GetEQ)
             return NULL;
         end;

        Kind = parm1;
        Id   = parm2;
    elif ((ValType(parm1) == V_INTEGER) and
          (ValType(parm2) == V_INTEGER) and
          (parm1 == 209/*DL_SFCONTR*/)) // Договор обслуживания ПЗО

         contr.rec.ID = parm2;
         if (not contr.GetEQ)
             return NULL;
         end;

        Kind = parm1;
        Id   = parm2;    
    else
        //Конструктор из структур, всегда в режиме сделки
        copy (tick,parm1);
        copy (leg,parm2);

        Kind = tick.rec.BofficeKind;
        Id   = tick.rec.DealID;
    end;

    if (ValType(parm3) == V_BOOL)
        withGA = parm3;
    else
        withGA = false;
    end;

    ReInit(false);
    InitFIRoleBArray();

    if ((Kind == DL_IBCDOC)     and
        (tick.rec.GenAgrID > 0) and
        (genagr.rec.AccMode == 2))
        ReInit(withGA);
    end;
END;
