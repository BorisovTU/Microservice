Import RSD; 

MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */  

  var cmd;
  record fd(dl_order); 

  if (errTrn) 
    return 1;
  end; 

  setbuff(fd, FirstDoc);

  if (CommitOrRollback == 1)
  	cmd = "insert into ddl_secur_hist_dbt " 
           "(select " + ID_Operation + ", " + ID_Step + ", "
           "  t.T_CONTRACTKIND, "
           "  t.T_CONTRACTID, "
           "  t.T_FIID, "
           "  t.T_SECURITYPROPERTIES, "
           "  t.T_QUANTITY, "
           "  t.T_VALUATIONDATE, "
           "  t.T_QUOTATION, "
           "  t.T_DISCOUNT, "
           "  t.T_COST, "
           "  t.T_GENERALCONTRACT, "
           "  t.T_USED, "
           "  t.T_QUALITYCATEGORY, "
           "  t.T_NOMINAL, "
           "  t.T_SIGNDATE, "
           "  t.T_PRIZNAK, "
           "  t.T_TCC, "
           "  t.T_NUMSECINORDER, "
           "  t.T_TYPESECUR, "
           "  t.T_CONTRACTOR, "
           "  t.T_SECURNUMBER, "  
           "  t.T_SECURID_REF, "
           "  t.T_DEPOSITORYDEPO, "  
           "  t.T_DEPOSITORYVERIFY, "    
           "  t.T_SECRESERVE "    
           " from ddl_secur_dbt t where  "
           "(t.t_contractkind = 126)and(t_contractid = " + fd.contractid + "))";
    RsdCommand(cmd).Execute;
  else
      cmd = "delete from ddl_leg_dbt leg where "
             "(leg.t_legid = 0)and(leg.t_legkind = 1)and "
             "(leg.t_dealid in ( "
             "                  select t_securityproperties as dealid from "
             "                  ( "
             "                  (select t_securityproperties from ddl_secur_dbt "
             "                  where (t_contractkind = 126)and(t_contractid = " + fd.contractid + ")) "
             "                  MINUS "
             "                  (select t_securityproperties from ddl_secur_hist_dbt "
             "                  where (t_contractkind = 126)and(t_contractid = " + fd.contractid + ") "
             "                  and(t_id_operation = " + ID_Operation + ")and(t_id_step = " + ID_Step + ")) "
             "                  )  "
             "                 ) "
             ")";
      RsdCommand(cmd).execute;

      cmd = "delete from dvsbanner_dbt vsb where "
             "(vsb.t_bcid in ( "
             "                  select t_securityproperties as dealid from "
             "                  ( "
             "                  (select t_securityproperties from ddl_secur_dbt "
             "                  where (t_contractkind = 126)and(t_contractid = " + fd.contractid + ")) "
             "                  MINUS "
             "                  (select t_securityproperties from ddl_secur_hist_dbt "
             "                  where (t_contractkind = 126)and(t_contractid = " + fd.contractid + ") "
             "                  and(t_id_operation = " + ID_Operation + ")and(t_id_step = " + ID_Step + ")) "
             "                  )  "
             "                 ) "
             ")";
      RsdCommand(cmd).execute;
  
      RsdCommand("delete from ddl_secur_dbt where (t_contractkind = 126)and(t_contractid = " + fd.contractid + ")").Execute;

      cmd = "insert into ddl_secur_dbt " 
             "(select t.T_CONTRACTKIND, "
             "  t.T_CONTRACTID, "
             "  t.T_FIID, "
             "  t.T_SECURITYPROPERTIES, "
             "  t.T_QUANTITY, "
             "  t.T_VALUATIONDATE, "
             "  t.T_QUOTATION, "
             "  t.T_DISCOUNT, "
             "  t.T_COST, "
             "  t.T_GENERALCONTRACT, "
             "  t.T_USED, "
             "  t.T_QUALITYCATEGORY, "
             "  t.T_NOMINAL, "
             "  t.T_SIGNDATE, "
             "  t.T_PRIZNAK, "
             "  t.T_TCC, "
             "  t.T_NUMSECINORDER, "
             "  t.T_TYPESECUR, "
             "  t.T_CONTRACTOR, "
             "  t.T_SECURNUMBER, "  
             "  t.T_SECURID_REF, "
             "  t.T_DEPOSITORYDEPO, "  
             "  t.T_DEPOSITORYVERIFY, "    
             "  t.T_SECRESERVE "    
             " from ddl_secur_hist_dbt t where  "
             "t_id_operation = " + ID_Operation + " and t_id_step = " + ID_Step + ")";
      RsdCommand(cmd).execute;
  
      RsdCommand("delete from ddl_secur_hist_dbt where t_id_operation = " + ID_Operation + " and t_id_step = " + ID_Step).execute;
  end;

  return 1;
END;
