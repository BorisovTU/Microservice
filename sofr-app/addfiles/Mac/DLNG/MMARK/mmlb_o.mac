/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 5.1                                          R-Style Software Lab

  File Name   : mmlb_o.mac
  Programmer  : Сабитов Р.Р.
  Description : Полезные ф-ии для МБК с ОСБ
  Comment     : 
└───────────────────────────────────────────────────────────────────────────*/
IMPORT mmlibr, globals;
VAR Date_NextPaym,Date_Close;
IMPORT PaymInter;

/* Плескачев А.Н. Такой макрос содержится в mmlibr
macro limiter (tick,pm)
    return (pm.DocKind==tick.BofficeKind) and (pm.DocumentID==tick.DealID);
end;
*/

MACRO НайтиПервыйНезакрытыйПлатеж(tick,paym)
    FILE pm ("pmpaym") key 1;

    macro filter
        return (pm.PaymStatus==PM_READIED)
    end;

    paym.PaymentID = 0;

    pm.DocKind = tick.BofficeKind;
    pm.DocumentID = tick.DealID;
    pm.Purpose = 0;
    pm.SubPurpose = 0;

    if (GetGE (pm) and limiter(tick,pm))
        if (filter)
            Copy (paym,pm);
        end;
        while (Next(pm) and limiter(tick,pm))
            if (filter and ((paym.ValueDate>pm.ValueDate) or (paym.PaymentID==0)))
                Copy (paym,pm);
            end;
        end;
    end;

    return paym.PaymentID!=0;
END;

MACRO НайтиПоследнийЗакрытыйПлатеж(tick,paym)
    FILE pm ("pmpaym") key 1;

    macro filter
        return (pm.PaymStatus==PM_FINISHED)
    end;

    paym.PaymentID = 0;

    pm.DocKind = tick.BofficeKind;
    pm.DocumentID = tick.DealID;
    pm.Purpose = 0;
    pm.SubPurpose = 0;

    if (GetGE (pm) and limiter(tick,pm))
        if (filter)
            Copy (paym,pm);
        end;
        while (Next(pm) and limiter(tick,pm))
            if (filter and ((paym.ValueDate<pm.ValueDate) or (paym.PaymentID==0)))
                Copy (paym,pm);
            end;
        end;
    end;

    return paym.PaymentID!=0;
END;

/*----------------------------------------------------------------------------
    Определить даты операции
----------------------------------------------------------------------------*/
MACRO Определить_даты_закрытия_или_следующего_платежа (tick)
    record paym (pmpaym);

    if (НайтиПервыйНезакрытыйПлатеж(tick,paym))
        Date_NextPaym = paym.ValueDate;
        Date_Close = date(0,0,0);
    else
        Date_NextPaym = date(0,0,0);

        if (НайтиПоследнийЗакрытыйПлатеж(tick,paym))
            Date_Close = paym.ValueDate+Кол_дней_ожидания_результатов;
        else
            Date_Close = {curdate};
        end;
    end;

    if (DefineOprDate(Дата_Завершение,Date_Close) AND
        DefineOprDate(Дата_ОбработкаПлатежа,Date_NextPaym))
        return true;
    end;

    return false;
END;