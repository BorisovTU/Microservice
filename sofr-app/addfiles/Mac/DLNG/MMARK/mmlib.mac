/*
$Name:        mmlib.mac
$Module:      МБ Кредиты
$Description: Функции общего употребления библиотеки МБК
*/
IMPORT RsbDataSet, DealsInter, BankInter, osfile, globals, cb_sql;

//Новое значение ККС для использования в КУ
private var  НовоеЗначениеККС: integer = 0;

/* Проверяет договор на существенные изменения 
*/
MACRO ВажнИзмДогМБК(ord_old, ord)

 if(ord_old.ContractStatus == ORDER_CONTRACT_STATUS_PREP)
    return 0;
 elif ((ord.Contractor !=ord_old.Contractor) OR
       (ord.ContractorName !=ord_old.ContractorName))
    return 1;
 else
    return 0;
 end;

END;

/* Преобразовать путь в полный */
MACRO MMCMT_processPath( p_path )

var l_str, l_p, l_path = "";

   p_path = trim( p_path );
  
   if( substr( p_path, 1, 2 ) == ".." ) /* ссылка на вышестоящий каталог */
    p_path = substr( p_path, 3 );
  
    l_str  = getCWD;    
    l_p    = strbrk( l_str, "\\" );
    while( l_p != 0 )
     l_path = l_path + substr( l_str, 1, l_p - 1 ) + "\\";
     l_str  = substr( l_str, l_p + 1 );
     l_p    = strbrk( l_str, "\\" );
    end;
    return ( substr( l_path, 1, strlen( l_path ) - 1 ) + p_path );
  
   elif( substr( p_path, 1, 1 ) == "." ) /* ссылка на текущий каталог */
    return ( getCWD + substr( p_path, 2 ) );
   end;
  
   return p_path;
END;

macro MM_SetRegistryPath(RegistryPath, Path)
    var stat = 0;
   
    GetRegistryValue(RegistryPath, V_STRING, Path, stat);
    if(stat) 
       msgbox("Не задана настройка в реестре банка:|", RegistryPath);      
    else
       SetParm(1, Path);
    end;

    return stat;
end;

// слямзил DLREPTL_GetDotFileDir из dlreptl.mac
macro MM_GetDotFileDir(dotfilename)
  var err = 0;
  var TemplsDir = "", GoalDir = "";

  var UserMacroDir = "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\USERMACRODIR";
  var MacroDir     = "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\MACRODIR";
  var DOT_PATH;

  private macro GetDir(TemplsDir, dotfilename)
    var tmpStr = "", Pos = 0;
    Pos = Index(TemplsDir, ";");
    while (Pos > 0)
      tmpStr = substr(TemplsDir, 1, Pos-1);
      TemplsDir = substr(TemplsDir, Pos+1);
      Pos = Index(TemplsDir, ";");
      if (ExistFile(tmpStr + "\\" + dotfilename))
        return tmpStr;
      end;
    end;
    if (ExistFile(TemplsDir + "\\" + dotfilename))
      return TemplsDir;
    end;
    return "";
  end;  

  if(MM_SetRegistryPath(UserMacroDir, DOT_PATH) == 0)
     GoalDir = GetDir(DOT_PATH, dotfilename);
     if (GoalDir == "")
       if(MM_SetRegistryPath(MacroDir, DOT_PATH) == 0)
          GoalDir = GetDir(DOT_PATH, dotfilename);
       end;
     end;
  end;

  if (GoalDir == "")
    msgbox( "Не найден файл-шаблон ", dotfilename, ".|Проверьте нахождение файл-шаблона по данному пути:|", GoalDir);
  end;

  return GoalDir;  
end;

/* Установка переменной, если она не определена
*/
MACRO MM_ByDefault(variable, value) 

  if (ValType(variable) == V_UNDEF) 
      setparm(0, value);
  end;

end;

/* Получить системный тип по операции по сделке
*/
PRIVATE MACRO GetSysTypes(DealType)
var
   opr = TBfile("oprkoper");

   opr.rec.Kind_Operation = DealType;
   if(opr.GetEQ())
      return opr.rec.SysTypes;
   end;

   return "";
END;


/* Это привлечение ?
*/
MACRO MM_IsDBF(DealType)
var SysTypes = GetSysTypes(DealType);

    if((Index(SysTypes, "DBF") > 0) AND (StrLen(SysTypes) == 3))
       return true;
    end;

    return false;
END;

/* Это размещение ?
*/
MACRO MM_IsDSF(DealType)
var SysTypes = GetSysTypes(DealType);

    if((Index(SysTypes, "DSF") > 0) AND (StrLen(SysTypes) == 3))
       return true;
    end;

    return false;
END;


// Отформатировать RSL-ную дату для SQL запроса
PRIVATE MACRO ToDate(d: date) : string
    if (d == date(0, 0, 0))
        return " to_date('01.01.0001', 'DD.MM.YYYY') ";
    else
        return " to_date('" + d + "', 'DD.MM.YYYY') ";
    end;
END;
    
// Категория качества сделки на дату
MACRO ПолучитьКатегориюКачества( DealID, ActionDate )
var DataSet = TRsbDataSet("SELECT t_QualityCategory " +
                  " FROM ddlreslnk_dbt " +
                  " WHERE t_Type = 3 AND t_ParentID = " + DealID + //" AND t_ChildID != -1 "+
                     " AND t_LnkDate <= "+ ToDate(ActionDate) +
                  " ORDER BY t_LnkDate DESC, t_Id DESC ");
    if (НовоеЗначениеККС > 0)
        return НовоеЗначениеККС;
	end;

    if(DataSet.MoveNext)
       return DataSet.QualityCategory;
    end;
    
    return 0;
END;

//Надежность сделки на дату
MACRO Надежность( DealID, ActionDate)
VAR ККС = 0, retval = 0, stat = 0,
КлючРеесра = "COMMON\\ПЕРЕМЕННЫЕ\\СУБЪЕКТ 3Й КАТЕГОРИИ КАЧЕСТВА",
ЗначениеКлюча = 0;

       if (НовоеЗначениеККС > 0)
	   ККС = НовоеЗначениеККС;
       else
          ККС = ПолучитьКатегориюКачества( DealID, ActionDate );
       end;
	
	if (ККС == 0)
		return 0;
	end;	
	if (ККС < 3)
	    retval = 1;
	else retval = 2;
	end;

    	GetRegistryValue(КлючРеесра, V_BOOL, ЗначениеКлюча, stat);
    
	if(stat) 
          msgbox("Не задана настройка в реестре банка:|", КлючРеесра); 
		  return -1;
    	else		     
	  if ((ККС == 3)and(ЗначениеКлюча == 1))
	    retval = 1;
	  end;
    	end;

       return retval;
END;

//для доступа к НовоеЗначениеККС
MACRO УстановитьЗначениеККС(val:integer)
	НовоеЗначениеККС = val;
END;

// Получить трехбуквенный код по FIID
MACRO MM_GetFI_ISO_Code(FIID)
VAR fininstr = Tbfile("fininstr.dbt", "R", 0);

    MM_ByDefault(FIID, 0);

    fininstr.rec.FIID = FIID;
    if(fininstr.GetEQ)
       return(fininstr.rec.Ccy);
    end;

    return "";
END;

/****************************************************************************
-1 - error, bad IDCheck or bad count parms or rsd error
 0 - good
 1 - error
*****************************************************************************/
const LEG_LegKind_DealID_LegID   = 0,
      PAYM_DealID_Purpose_Status = 1;

MACRO CheckExistence(IDCheck)
  var i = 1, 
      parm = TArray,
      Data, cmd;

  if (ValType(IDCheck) == V_UNDEF)
      return -1;
  end;

  while ( GetParm(i,parm[i-1]) and (ValType(parm[i-1]) != V_UNDEF) )
      i = i + 1;
  end;

  parm.size = parm.size - 1;

  if (IDCheck == LEG_LegKind_DealID_LegID)
      if (parm.size < 3)
          return -1;
      end;
      Data = RsdRecordset("select count(*) as countleg from ddl_leg_dbt where (t_LegKind = " + parm[0] + ")and(t_DealID = " + parm[1] + ")and(t_LegID = " + parm[2] + ")");

      if (not Data.MoveNext)
          return -1;
      end;
	  
      if (Data.value("countleg"))
          return 0;
      else
          return 1;
	  end;
  elif (IDCheck == PAYM_DealID_Purpose_Status)
      if (parm.size < 2)
          return -1;
      end;

	  cmd = "select count(*) as countpaym from dpmpaym_dbt pm " +
             "where (pm.t_DocKind = 102) and (pm.t_DocumentID = " + parm[0] +
             ") and (pm.t_Purpose = " + parm[1] + ")";
      if (parm.size > 2)
          cmd = cmd + " and (pm.t_PaymStatus in(";
          i = 2;
          while (i < parm.size)
              cmd = cmd + parm[i];
              if (i < parm.size - 1)
                  cmd = cmd + ", ";              
              end;
		  
              i = i + 1;
          end;
          cmd = cmd + "))";
      end;

      Data = RsdRecordset(cmd);

      if (not Data.MoveNext)
          return -1;
      end;

      if (Data.value("countpaym"))
          return 0;
      else
          return 1;
	  end;
  end;
END;

MACRO ПолучитьЗначениеПримечания(ObjectType, ObjectID, noteKind, nDate)
  file notetext("notetext.dbt") key 5; /*по автоинкременту*/
  var strSql : string;
  var rs : RsdRecordset;

  strSql = "SELECT t_ID FROM dnotetext_dbt " + 
           " WHERE t_ObjectType = " + ObjectType + 
           "   AND t_DocumentID = '" + ObjectID + "' " + 
           "   AND t_NoteKind = " + noteKind + " " +
           "   AND " + GetSqlDate(nDate) + " BETWEEN t_Date AND t_ValidToDate" + 
           " ORDER BY t_Date";

  rs = RsdRecordset(strSql);
  if(rs.MoveNext())
    ClearRecord(notetext);
    notetext.ID = rs.value(0);
	
    if(getEQ(notetext))
      return GetNoteValue(notetext);
    end;
  end;

  return 0;      
END;

MACRO StepIsExecute(DocID, DocKind, symb)
    VAR Res, cmd;
    cmd = RSDCommand("SELECT 1 " +
            "FROM doprstep_dbt " +
            "INNER JOIN doproper_dbt ON doproper_dbt.t_id_operation = doprstep_dbt.t_id_operation " +
            "WHERE t_documentid = ? AND doprstep_dbt.t_dockind = ? AND t_isexecute = 'X' AND t_symbol = ?");
    cmd.addParam("", RSDBP_IN, DocID);
    cmd.addParam("", RSDBP_IN, DocKind);
    cmd.addParam("", RSDBP_IN, symb );
    cmd.execute();
    Res = TRsbDataSet(cmd);
    if (Res.MoveNext)
        return true;
    end;
    return false;
END;

MACRO IsGraphPaym(DocID, DocKind, Purp)
    VAR Res, cmd;
    cmd = RSDCommand("SELECT 1 FROM dpmpaym_dbt " +
            "WHERE t_documentid = ? AND t_dockind = ? AND t_purpose = ? AND t_subpurpose > 0");
    cmd.addParam("", RSDBP_IN, DocID);
    cmd.addParam("", RSDBP_IN, DocKind);
    cmd.addParam("", RSDBP_IN, Purp);
    cmd.execute();
    Res = TRsbDataSet(cmd);
    if (Res.MoveNext)
        return true;
    end;
    return false;
END;

MACRO IsLastPurpPaym(DocID, DocKind, Purp)
    VAR Res, cmd;
    cmd = RSDCommand("SELECT NVL(count(1), 0) AS pmcount FROM dpmpaym_dbt " +
            "WHERE t_documentid = ? AND t_dockind = ? AND t_purpose = ? AND t_paymstatus != 32000");
    cmd.addParam("", RSDBP_IN, DocID);
    cmd.addParam("", RSDBP_IN, DocKind);
    cmd.addParam("", RSDBP_IN, Purp);
    cmd.execute();
    Res = TRsbDataSet(cmd);
    if (Res.MoveNext)
        if ((Res.PmCount == 0) or (Res.PmCount == 1))
            return true;
        else
            return false;
        end;
    end;
    return true;    
END;

MACRO GetDateStepBySymb(DocID, DocKind, symb, StepDate)
    VAR Res, cmd;
    cmd = RSDCommand("SELECT MAX(t_fact_date) AS sdate FROM doprstep_dbt" +
      " INNER JOIN doproper_dbt ON doproper_dbt.t_id_operation = doprstep_dbt.t_id_operation" +
      " WHERE t_documentid = ? AND doprstep_dbt.t_dockind = ? AND t_isexecute = 'X' AND t_symbol = ?");
    cmd.addParam("", RSDBP_IN, DocID);
    cmd.addParam("", RSDBP_IN, DocKind);
    cmd.addParam("", RSDBP_IN, symb );
    cmd.execute();
    Res = TRsbDataSet(cmd);
    if (Res.MoveNext)
        if (ValType(Res.sdate) == V_UNDEF)
            return false;
        end;
        SetParm(3, Res.sdate);
        return true;
    end;
    return false;
END;

MACRO GetBlockSymb(ID_Operation, ID_Step)
    VAR Res = TRsbDataSet("SELECT doproblck_dbt.t_symbol FROM doproblck_dbt INNER JOIN doprstep_dbt " + 
                          "ON doproblck_dbt.t_blockid = doprstep_dbt.t_blockid " + 
                          "AND doproblck_dbt.t_kind_operation = doprstep_dbt.t_kind_operation " + 
                          "WHERE t_id_operation = " + ID_Operation + " AND t_id_step = " + ID_Step);
    if (Res.MoveNext)
        return Res.Symbol;
    end;
    return "";
END;

MACRO GetBlockNumber(ID_Operation, ID_Step)
    VAR Res = TRsbDataSet("SELECT doproblck_dbt.t_blockid FROM doproblck_dbt INNER JOIN doprstep_dbt " + 
                          "ON doproblck_dbt.t_blockid = doprstep_dbt.t_blockid " + 
                          "AND doproblck_dbt.t_kind_operation = doprstep_dbt.t_kind_operation " + 
                          "WHERE t_id_operation = " + ID_Operation + " AND t_id_step = " + ID_Step);
    if (Res.MoveNext)
        return Res.BlockID;
    end;
    return 0;
END;

MACRO GetContrSSISettAccContr( ContractID, FIID, FeeType, FeeNumber )
  var sel, ds;
  sel = RSDCommand("select *" +
                     " from dsfssi_dbt t" +
                     " where t_ObjectType = 659" +
                       " and t_objectid = ?" +
                       " and t_fikind = 1" +
                       " and t_FIID = ?" +
                       " and (t_FeeType = ? or t_FeeType = 0)" +
                       " and (t_FeeNumber = ? or t_FeeNumber = 0)" +
                       " order by t_order desc");

  sel.addParam("", RSDBP_IN, string(ContractID:o:10));
  sel.addParam("", RSDBP_IN, FIID);
  sel.addParam("", RSDBP_IN, FeeType);
  sel.addParam("", RSDBP_IN, FeeNumber);

  ds = TRsbDataSet(sel);
  if (ds.MoveNext)
    return ds.SetAccID;
  end;

  return 0;
END;

MACRO GetRsrvPercent(DocumentID, CalcDate)
    VAR DataSet = NULL;
    DataSet = TRsbDataSet("select t_reservepercent " +
                           " from ddlreslnk_dbt " +
                           " where (t_type = 3) and (t_parentid = " + DocumentID + ")" +
                           " and (t_childid = -1) " +
                           " and (t_lnkdate <= '"+ Date(CalcDate) + "')" +
                           " order by t_lnkdate desc, t_id desc");

    if(not DataSet.MoveNext) 
        return 0;
    end;

    return DataSet.ReservePercent;
END;

MACRO GetQualityCategory(DocumentID, CalcDate)
    VAR DataSet = NULL;
    DataSet = TRsbDataSet("select t_qualitycategory " +
                           " from ddlreslnk_dbt " +
                           " where (t_type = 3) and (t_parentid = " + DocumentID + ")" +
                           " and (t_childid = -1) " +
                           " and (t_lnkdate <= '"+ Date(CalcDate) + "')" +
                           " order by t_lnkdate desc, t_id desc");

    if(not DataSet.MoveNext) 
        return 0;
    end;

    return DataSet.QualityCategory;
END;

MACRO GetPercLoss(DocumentID, CalcDate)
    VAR DataSet = NULL;
    DataSet = TRsbDataSet("select t_percloss " +
                           " from dmmhstimp_dbt " +
                           " where t_dealid = " + DocumentID +
                           " and t_date IN " +
                           " (select max(t_date) from dmmhstimp_dbt " +
                              " where t_date <= '" + Date(CalcDate) + "' and t_dealid = " + DocumentID + ")");
    if(not DataSet.MoveNext) 
        return 0;
    end;

    return DataSet.PercLoss;   

END;

MACRO GetContrSSISettAcc( FIID, FeeType, FeeNumber )
  var sel, ds;
  sel = RSDCommand("select *" +
                     " from dsfssi_dbt t" +
                     " where t_ObjectType = 650" +
                       " and t_objectid = ?" +
                       " and t_fikind = 1" +
                       " and t_FIID = ?" +
                       " and (t_FeeType = ? or t_FeeType = 0)" +
                       " and (t_FeeNumber = ? or t_FeeNumber = 0)" +
                       " order by t_order desc");

  sel.addParam("", RSDBP_IN, string(FeeType:o:5, FeeNumber:o:5));
  sel.addParam("", RSDBP_IN, FIID);
  sel.addParam("", RSDBP_IN, FeeType);
  sel.addParam("", RSDBP_IN, FeeNumber);

  ds = TRsbDataSet(sel);
  if (ds.MoveNext)
    return ds.SetAccID;
  end;

  return 0;
END;

MACRO MM_CalcRPS(ObjID, ObjN, CalcDate, ContextType)
    VAR cmd = RsdCommand(RslDefCon, "begin ? := RSO_MMARK_MSFO.CalcRPS(?, ?, ?, ?); end;");
    cmd.addParam("retval",      RSDBP_RETVAL, V_DOUBLE);
    cmd.addParam("ObjID",       RSDBP_IN); cmd.value("ObjID")       = ObjID;
    cmd.addParam("ObjN",        RSDBP_IN); cmd.value("ObjN")        = ObjN;
    cmd.addParam("CalcDate",    RSDBP_IN); cmd.value("CalcDate")    = CalcDate;
    cmd.addParam("ContextType", RSDBP_IN); cmd.value("ContextType") = ContextType;
    cmd.execute();
    return cmd.value ("retval", V_DOUBLE);
END;

MACRO MM_GetMlvlEx(ObjID, ObjN, LvlID, CalcDate, ContextType)
    VAR cmd = RsdCommand(RslDefCon, "begin ? := RSO_MMARK_MSFO.GetMlvlEx(?, ?, ?, ?, ?); end;");
    cmd.addParam("retval",      RSDBP_RETVAL, V_INTEGER);
    cmd.addParam("ObjID",       RSDBP_IN); cmd.value("ObjID")       = ObjID;
    cmd.addParam("ObjN",        RSDBP_IN); cmd.value("ObjN")        = ObjN;
    cmd.addParam("LvlID",       RSDBP_IN); cmd.value("LvlID")       = LvlID;
    cmd.addParam("CalcDate",    RSDBP_IN); cmd.value("CalcDate")    = CalcDate;
    cmd.addParam("ContextType", RSDBP_IN); cmd.value("ContextType") = ContextType;
    cmd.execute();
    return Int(cmd.value ("retval", V_INTEGER));
END;

MACRO MM_CalcEPS(ObjID, ObjN, CalcDate, ContextType)
    VAR cmd = RsdCommand(RslDefCon, "begin ? := RSO_MMARK_MSFO.CalcEPS(?, ?, ?, ?); end;");
    cmd.addParam("retval",      RSDBP_RETVAL, V_DOUBLE);
    cmd.addParam("ObjID",       RSDBP_IN); cmd.value("ObjID")       = ObjID;
    cmd.addParam("ObjN",        RSDBP_IN); cmd.value("ObjN")        = ObjN;
    cmd.addParam("CalcDate",    RSDBP_IN); cmd.value("CalcDate")    = CalcDate;
    cmd.addParam("ContextType", RSDBP_IN); cmd.value("ContextType") = ContextType;
    cmd.execute();
    return cmd.value ("retval", V_DOUBLE);
END;

MACRO MM_CalcSS(ObjID, ObjN, CalcDate, ContextType)
    VAR cmd = RsdCommand(RslDefCon, "begin ? := RSO_MMARK_MSFO.CalcSS(?, ?, ?, ?); end;");
    cmd.addParam("retval",      RSDBP_RETVAL, V_MONEY);
    cmd.addParam("ObjID",       RSDBP_IN); cmd.value("ObjID")       = ObjID;
    cmd.addParam("ObjN",        RSDBP_IN); cmd.value("ObjN")        = ObjN;
    cmd.addParam("CalcDate",    RSDBP_IN); cmd.value("CalcDate")    = CalcDate;
    cmd.addParam("ContextType", RSDBP_IN); cmd.value("ContextType") = ContextType;
    cmd.execute();
    return cmd.value ("retval", V_MONEY);
END;

MACRO MM_CalcAdjSS(ObjID, ObjN, CalcDate, ContextType)
    VAR cmd = RsdCommand(RslDefCon, "begin ? := RSO_MMARK_MSFO.CalcAdjSS(?, ?, ?, ?); end;");
    cmd.addParam("retval",      RSDBP_RETVAL, V_MONEY);
    cmd.addParam("ObjID",       RSDBP_IN); cmd.value("ObjID")       = ObjID;
    cmd.addParam("ObjN",        RSDBP_IN); cmd.value("ObjN")        = ObjN;
    cmd.addParam("CalcDate",    RSDBP_IN); cmd.value("CalcDate")    = CalcDate;
    cmd.addParam("ContextType", RSDBP_IN); cmd.value("ContextType") = ContextType;
    cmd.execute();
    return cmd.value ("retval", V_MONEY);
END;

MACRO MM_CalcAdjAS(ObjID, ObjN, CalcDate, ContextType)
    VAR cmd = RsdCommand(RslDefCon, "begin ? := RSO_MMARK_MSFO.CalcAdjAS(?, ?, ?, ?); end;");
    cmd.addParam("retval",      RSDBP_RETVAL, V_MONEY);
    cmd.addParam("ObjID",       RSDBP_IN); cmd.value("ObjID")       = ObjID;
    cmd.addParam("ObjN",        RSDBP_IN); cmd.value("ObjN")        = ObjN;
    cmd.addParam("CalcDate",    RSDBP_IN); cmd.value("CalcDate")    = CalcDate;
    cmd.addParam("ContextType", RSDBP_IN); cmd.value("ContextType") = ContextType;
    cmd.execute();
    return cmd.value ("retval", V_MONEY);
END;

MACRO MM_CalcAS(ObjID, ObjN, CalcDate, ContextType)
    VAR cmd = RsdCommand(RslDefCon, "begin ? := RSO_MMARK_MSFO.CalcAS(?, ?, ?, ?); end;");
    cmd.addParam("retval",      RSDBP_RETVAL, V_MONEY);
    cmd.addParam("ObjID",       RSDBP_IN); cmd.value("ObjID")       = ObjID;
    cmd.addParam("ObjN",        RSDBP_IN); cmd.value("ObjN")        = ObjN;
    cmd.addParam("CalcDate",    RSDBP_IN); cmd.value("CalcDate")    = CalcDate;
    cmd.addParam("ContextType", RSDBP_IN); cmd.value("ContextType") = ContextType;
    cmd.execute();
    return cmd.value ("retval", V_MONEY);
END;

MACRO MM_CalcGBV(ObjID, ObjN, CalcDate, ContextType)
    VAR cmd = RsdCommand(RslDefCon, "begin ? := RSO_MMARK_MSFO.CalcGBV(?, ?, ?, ?); end;");
    cmd.addParam("retval",      RSDBP_RETVAL, V_MONEY);
    cmd.addParam("ObjID",       RSDBP_IN); cmd.value("ObjID")       = ObjID;
    cmd.addParam("ObjN",        RSDBP_IN); cmd.value("ObjN")        = ObjN;
    cmd.addParam("CalcDate",    RSDBP_IN); cmd.value("CalcDate")    = CalcDate;
    cmd.addParam("ContextType", RSDBP_IN); cmd.value("ContextType") = ContextType;
    cmd.execute();
    return cmd.value ("retval", V_MONEY);
END;

MACRO MM_CalcCosts(ObjID, ObjN, CalcDate, ContextType, OperationID, StepID)
    VAR cmd = RsdCommand(RslDefCon, "begin ? := RSO_MMARK_MSFO.CalcCosts(?, ?, ?, ?, ?, ?); end;");
    cmd.addParam("retval",      RSDBP_RETVAL, V_MONEY);
    cmd.addParam("ObjID",       RSDBP_IN); cmd.value("ObjID")       = ObjID;
    cmd.addParam("ObjN",        RSDBP_IN); cmd.value("ObjN")        = ObjN;
    cmd.addParam("CalcDate",    RSDBP_IN); cmd.value("CalcDate")    = CalcDate;
    cmd.addParam("ContextType", RSDBP_IN); cmd.value("ContextType") = ContextType;
    cmd.addParam("OperationID", RSDBP_IN); cmd.value("OperationID") = OperationID;
    cmd.addParam("StepID",      RSDBP_IN); cmd.value("StepID")      = StepID;
    cmd.execute();
    return cmd.value ("retval", V_MONEY);
END;

MACRO MM_CalcAdjInt(ObjID, ObjN, CalcDate, ContextType)
    VAR cmd = RsdCommand(RslDefCon, "begin ? := RSO_MMARK_MSFO.CalcAdjInt(?, ?, ?, ?); end;");
    cmd.addParam("retval",      RSDBP_RETVAL, V_MONEY);
    cmd.addParam("ObjID",       RSDBP_IN); cmd.value("ObjID")       = ObjID;
    cmd.addParam("ObjN",        RSDBP_IN); cmd.value("ObjN")        = ObjN;
    cmd.addParam("CalcDate",    RSDBP_IN); cmd.value("CalcDate")    = CalcDate;
    cmd.addParam("ContextType", RSDBP_IN); cmd.value("ContextType") = ContextType;
    cmd.execute();
    return cmd.value ("retval", V_MONEY);
END;

MACRO MM_CalcDDA(ObjID, ObjN, CalcDate, ContextType, OperationID, StepID)
    VAR cmd = RsdCommand(RslDefCon, "begin ? := RSO_MMARK_MSFO.CalcDDA(?, ?, ?, ?, ?, ?); end;");
    cmd.addParam("retval",      RSDBP_RETVAL, V_MONEY);
    cmd.addParam("ObjID",       RSDBP_IN); cmd.value("ObjID")       = ObjID;
    cmd.addParam("ObjN",        RSDBP_IN); cmd.value("ObjN")        = ObjN;
    cmd.addParam("CalcDate",    RSDBP_IN); cmd.value("CalcDate")    = CalcDate;
    cmd.addParam("ContextType", RSDBP_IN); cmd.value("ContextType") = ContextType;
    cmd.addParam("OperationID", RSDBP_IN); cmd.value("OperationID") = OperationID;
    cmd.addParam("StepID",      RSDBP_IN); cmd.value("StepID")      = StepID;
    cmd.execute();
    return cmd.value ("retval", V_MONEY);
END;

MACRO MM_CalcAssesRes(ObjID, ObjN, BaseSum, CalcDate, ContextType)
    VAR cmd = RsdCommand(RslDefCon, "begin ? := RSO_MMARK_MSFO.CalcAssesRes(?, ?, ?, ?, ?); end;");
    cmd.addParam("retval",      RSDBP_RETVAL, V_MONEY);
    cmd.addParam("ObjID",       RSDBP_IN); cmd.value("ObjID")       = ObjID;
    cmd.addParam("ObjN",        RSDBP_IN); cmd.value("ObjN")        = ObjN;
    cmd.addParam("baseamount",  RSDBP_IN); cmd.value("baseamount")  = BaseSum;
    cmd.addParam("CalcDate",    RSDBP_IN); cmd.value("CalcDate")    = CalcDate;
    cmd.addParam("ContextType", RSDBP_IN); cmd.value("ContextType") = ContextType;
    cmd.execute();
    return cmd.value ("retval", V_MONEY);
END;

MACRO MM_GetMarketTest(ObjID, ObjN, CalcDate, ContextType)
    VAR cmd = RsdCommand(RslDefCon, "begin ? := RSO_MMARK_MSFO.TestMarket(?, ?, ?, ?); end;");
    cmd.addParam("retval",      RSDBP_RETVAL, V_INTEGER);
    cmd.addParam("ObjID",       RSDBP_IN); cmd.value("ObjID")       = ObjID;
    cmd.addParam("ObjN",        RSDBP_IN); cmd.value("ObjN")        = ObjN;
    cmd.addParam("CalcDate",    RSDBP_IN); cmd.value("CalcDate")    = CalcDate;
    cmd.addParam("ContextType", RSDBP_IN); cmd.value("ContextType") = ContextType;
    cmd.execute();
    return Int(cmd.value ("retval", V_INTEGER));
END;

MACRO MM_CalcFinResFA(ObjID, ObjN, CalcDate, ContextType)
    VAR cmd = RsdCommand(RslDefCon, "begin ? := RSO_MMARK_MSFO.CalcFinResFA(?, ?, ?, ?); end;");
    cmd.addParam("retval",      RSDBP_RETVAL, V_MONEY);
    cmd.addParam("ObjID",       RSDBP_IN); cmd.value("ObjID")       = ObjID;
    cmd.addParam("ObjN",        RSDBP_IN); cmd.value("ObjN")        = ObjN;
    cmd.addParam("CalcDate",    RSDBP_IN); cmd.value("CalcDate")    = CalcDate;
    cmd.addParam("ContextType", RSDBP_IN); cmd.value("ContextType") = ContextType;
    cmd.execute();
    return cmd.value ("retval", V_MONEY);
END;

MACRO MM_CalcFinResFO(ObjID, ObjN, CalcDate, ContextType)
    VAR cmd = RsdCommand(RslDefCon, "begin ? := RSO_MMARK_MSFO.CalcFinResFO(?, ?, ?, ?); end;");
    cmd.addParam("retval",      RSDBP_RETVAL, V_MONEY);
    cmd.addParam("ObjID",       RSDBP_IN); cmd.value("ObjID")       = ObjID;
    cmd.addParam("ObjN",        RSDBP_IN); cmd.value("ObjN")        = ObjN;
    cmd.addParam("CalcDate",    RSDBP_IN); cmd.value("CalcDate")    = CalcDate;
    cmd.addParam("ContextType", RSDBP_IN); cmd.value("ContextType") = ContextType;
    cmd.execute();
    return cmd.value ("retval", V_MONEY);
END;

MACRO MM_CalcOthInt(ObjID, ObjN, CalcDate, ContextType, OperationID, StepID)
    VAR cmd = RsdCommand(RslDefCon, "begin ? := RSO_MMARK_MSFO.CalcOthInt(?, ?, ?, ?, ?, ?); end;");
    cmd.addParam("retval",      RSDBP_RETVAL, V_MONEY);
    cmd.addParam("ObjID",       RSDBP_IN); cmd.value("ObjID")       = ObjID;
    cmd.addParam("ObjN",        RSDBP_IN); cmd.value("ObjN")        = ObjN;
    cmd.addParam("CalcDate",    RSDBP_IN); cmd.value("CalcDate")    = CalcDate;
    cmd.addParam("ContextType", RSDBP_IN); cmd.value("ContextType") = ContextType;
    cmd.addParam("OperationID", RSDBP_IN); cmd.value("OperationID") = OperationID;
    cmd.addParam("StepID",      RSDBP_IN); cmd.value("StepID")      = StepID;
    cmd.execute();
    return cmd.value ("retval", V_MONEY);
END;

MACRO MM_CalcOthOpInt(ObjID, ObjN, CalcDate, ContextType, OperationID, StepID)
    VAR cmd = RsdCommand(RslDefCon, "begin ? := RSO_MMARK_MSFO.CalcOthOpInt(?, ?, ?, ?, ?, ?); end;");
    cmd.addParam("retval",      RSDBP_RETVAL, V_MONEY);
    cmd.addParam("ObjID",       RSDBP_IN); cmd.value("ObjID")       = ObjID;
    cmd.addParam("ObjN",        RSDBP_IN); cmd.value("ObjN")        = ObjN;
    cmd.addParam("CalcDate",    RSDBP_IN); cmd.value("CalcDate")    = CalcDate;
    cmd.addParam("ContextType", RSDBP_IN); cmd.value("ContextType") = ContextType;
    cmd.addParam("OperationID", RSDBP_IN); cmd.value("OperationID") = OperationID;
    cmd.addParam("StepID",      RSDBP_IN); cmd.value("StepID")      = StepID;
    cmd.execute();
    return cmd.value ("retval", V_MONEY);
END;

MACRO MM_CalcPrize(ObjID, ObjN, CalcDate, ContextType, OperationID, StepID, PmAnount)
    VAR cmd = RsdCommand(RslDefCon, "begin ? := RSO_MMARK_MSFO.CalcPrize(?, ?, ?, ?, ?, ?, ?); end;");
    cmd.addParam("retval",      RSDBP_RETVAL, V_MONEY);
    cmd.addParam("ObjID",       RSDBP_IN); cmd.value("ObjID")       = ObjID;
    cmd.addParam("ObjN",        RSDBP_IN); cmd.value("ObjN")        = ObjN;
    cmd.addParam("CalcDate",    RSDBP_IN); cmd.value("CalcDate")    = CalcDate;
    cmd.addParam("ContextType", RSDBP_IN); cmd.value("ContextType") = ContextType;
    cmd.addParam("OperationID", RSDBP_IN); cmd.value("OperationID") = OperationID;
    cmd.addParam("StepID",      RSDBP_IN); cmd.value("StepID")      = StepID;
    cmd.addParam("PmAnount",    RSDBP_IN); cmd.value("PmAnount")    = PmAnount;
    cmd.execute();
    return cmd.value ("retval", V_MONEY);
END;

MACRO MM_CalcDiscount(ObjID, ObjN, CalcDate, ContextType, OperationID, StepID, PmAnount)
    VAR cmd = RsdCommand(RslDefCon, "begin ? := RSO_MMARK_MSFO.CalcDiscount(?, ?, ?, ?, ?, ?, ?); end;");
    cmd.addParam("retval",      RSDBP_RETVAL, V_MONEY);
    cmd.addParam("ObjID",       RSDBP_IN); cmd.value("ObjID")       = ObjID;
    cmd.addParam("ObjN",        RSDBP_IN); cmd.value("ObjN")        = ObjN;
    cmd.addParam("CalcDate",    RSDBP_IN); cmd.value("CalcDate")    = CalcDate;
    cmd.addParam("ContextType", RSDBP_IN); cmd.value("ContextType") = ContextType;
    cmd.addParam("OperationID", RSDBP_IN); cmd.value("OperationID") = OperationID;
    cmd.addParam("StepID",      RSDBP_IN); cmd.value("StepID")      = StepID;
    cmd.addParam("PmAnount",    RSDBP_IN); cmd.value("PmAnount")    = PmAnount;
    cmd.execute();
    return cmd.value ("retval", V_MONEY);
END;

MACRO MM_GetCalcPercent(DealID, BeginDate, EndDate)
  var strSql, rs;
  strSql = "select sum(T_SUMCALC) as SUMMA from DPRCCNTSCHED_DBT " +
                "inner join DPRCCONTRACT_DBT on DPRCCNTSCHED_DBT.T_CONTRACTID = DPRCCONTRACT_DBT.T_CONTRACTID " +
                       "and DPRCCONTRACT_DBT.T_CONTRACTTYPE = 7 and T_OBJECTTYPE = 103 " +
                "inner join DDL_TICK_DBT on DPRCCONTRACT_DBT.T_OBJECTID = DDL_TICK_DBT.T_DEALCODE " +
                     "where T_SCHEDULEKIND = 3 and t_BOFFICEKIND = 102 and T_DEALID = " + DealID + 
                      " and T_PERIODBEGINDATE >= " + GetSqlDate(BeginDate) + " and T_PERIODENDDATE <= " + GetSqlDate(EndDate);

  rs = RsdRecordset(strSql);
  if(rs.MoveNext())
    return rs.value(0);
  end;

  return 0;    
END;

MACRO MM_CalcHedgAdjAm(HedgInstrID, CalcDate, ContextType)
    VAR cmd = RsdCommand(RslDefCon, "begin ? := RSO_MMARK_MSFO.CalcHedgAdjAm(?, ?, ?); end;");
    cmd.addParam("retval",      RSDBP_RETVAL, V_MONEY);
    cmd.addParam("HedgInstrID", RSDBP_IN); cmd.value("HedgInstrID") = HedgInstrID;
    cmd.addParam("CalcDate",    RSDBP_IN); cmd.value("CalcDate")    = CalcDate;
    cmd.addParam("ContextType", RSDBP_IN); cmd.value("ContextType") = ContextType;
    cmd.execute();
    return cmd.value ("retval", V_MONEY);
END;

