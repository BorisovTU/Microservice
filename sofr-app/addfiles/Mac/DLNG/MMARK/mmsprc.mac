/*
$Name: mmsprc.mac       
$Module: МБК
$Description: Сервисная операция: Начисление процентов 
*/
IMPORT RsbDataSet, mmservop, globals, mmcateg, mmlb_j, mmcnst_j;
/****************************************************************************************/
/* Виды базисов RS-Bank */
const RS_BASIS_30360  = 1,    /* 360 дней в году, 30 в месяце */
      RS_BASIS_ACTACT = 4,    /* в году и в месяце по календарю */
      RS_BASIS_ACT360 = 2,    /* 360 дней в году, в месяце по календ. */
      RS_BASIS_ACT365 = 8,    /* в году и в месяце по календарю без учета високосности */
      RS_BASIS_31360  = 1001; /* 360 дней в году, 31 в месяце */


/*Печать ошибок**************************************************************************/
MACRO PrintReportError(_ErrorArray)
    VAR 
        idx = 0,
        cntError = _ErrorArray.Size;

    AddSvOpReportLine("  Сделки, исключенные из операции начисления процентов                                                       ");
    AddSvOpReportLine("┌────────────────────┬─────────────────────────────────────────────────────────────────────────────────────────┐");
    AddSvOpReportLine("│ № сделки           │ Причина исключения                                                                      │");
    AddSvOpReportLine("│                    │                                                                                         │");
    AddSvOpReportLine("├────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────┤");

    while (idx < cntError)
        AddSvOpReportLine("│" +
                           string(_ErrorArray[idx].ObjCode:20) + "│" + 
                           string(_ErrorArray[idx].StrErr:89)  + "│"  );
        idx = idx + 1;
    end;

    AddSvOpReportLine("└────────────────────┴─────────────────────────────────────────────────────────────────────────────────────────┘");

    return true;
END;

macro GetDaysInYear( deal_pd, year )
  if( deal_pd.GetLeg().Basis == RS_BASIS_30360 )   /* 360 дней в году, 30 в месяце */
    return 360;
  elif(deal_pd.GetLeg().Basis == RS_BASIS_ACT360)  /* 360 дней в году, в месяце по календ. */
    return 360;
  else                                   /* 360 дней в году, 31 в месяце */
    if( (mod(year, 4) == 0) AND ((mod(year,100) != 0) OR (mod(year,400) == 0 )))
     return 366;
    else
     return 365;
    end;
  end;

end;

macro WriteRec(deal_pd, DataSet1, DataSet2, DataSet3, AccBase, AccPerc, PercRest, Date1, Date2, first_rec)
  var CurYear, PeriodDaysAmount, PeriodPercAmount;
    if (DataSet3.Date1 == deal_pd.GetLeg().Start)
        PeriodDaysAmount = Date2 - Date1;
    else
        PeriodDaysAmount = Date2 - Date1 + 1;  
    end;
    datesplit(date(DataSet3.Date2), null, null, CurYear);
    PeriodPercAmount = round(abs(DataSet3.Rest)*(DataSet2.Rate/100)/GetDaysInYear(deal_pd, CurYear)*PeriodDaysAmount, 2);

    AddSvOpReportLine("├──────────────────────┼────────────────────┼──────────────────────────┼─────────────────────────┼──────────────────┼──────────────────┼─────────────┼───────────┼──────────────────┼───────────────────────┼──────────────────────┼──────────────────────────┤");
    if (first_rec)
        AddSvOpReportLine("│" + 
        String(DataSet1.DealCode:22)        + "│" +
        String(DataSet1.ShortName:20)     + "│" +
        String(AccBase:26)       + "│" +
        String(AccPerc:25)      + "│" +
        String(date(Date1):18) + "│" +
        String(date(Date2):18)    + "│" +
        String(PeriodDaysAmount:13)    + "│" +
        String(DataSet2.Rate:11)     + "│" +
        String(abs(DataSet3.Rest):18) + "│" +
        String(PeriodPercAmount:23)      + "│" +
        String(DataSet1.SumPerc:22)      + "│" +
        String(PercRest:26)      + "│");
    else
        AddSvOpReportLine("│" + 
        String("":22)        + "│" +
        String("":20)     + "│" +
        String("":26)       + "│" +
        String("":25)      + "│" +
        String(date(Date1):18) + "│" +
        String(date(Date2):18)    + "│" +
        String(PeriodDaysAmount:13)    + "│" +
        String(DataSet2.Rate:11)     + "│" +
        String(abs(DataSet3.Rest):18) + "│" +
        String(PeriodPercAmount:23)      + "│" +
        String("":22)      + "│" +
        String("":26)      + "│");
    end;

end;

MACRO PrintReport(_OprDocKind)
    VAR  DataSet1  = NULL,
         DataSet2  = NULL,
         DataSet3  = NULL,
         QueryStr1 = "", 
         QueryStr2 = "", 
         QueryStr3 = "", 
         flag     = true,
         first_rec = true,
         Year1, Year2, YearsCount, Date1, Date2,
         Date1Prev, Date2Prev, Date1PrevYear, Date1PrevIns, Date2PrevIns,
         deal_pd, AccBase = "", AccPerc = "", AccCalcBase = "", PercRest = $0;                                                                   
    
    QueryStr1 = "select tick.t_DealID, tick.t_DealCode, tick.t_PartyID, party.t_shortname, acctrn.t_Sum_Receiver as SumPerc from ddl_tick_dbt tick " + 
               "join doproper_dbt oproper on tick.t_DealID = oproper.t_DocumentID " +
               "join doprstep_dbt oprstep on oprstep.t_ID_Operation = oproper.t_ID_Operation " +
               "join dparty_dbt party on tick.t_PartyID = party.t_PartyID " +
               "join doprdocs_dbt oprdocs on oprdocs.t_ID_Operation = oprstep.t_ID_Operation and oprdocs.t_ID_Step = oprstep.t_ID_Step " +
               "join dacctrn_dbt acctrn on acctrn.t_AcctrnID = oprdocs.t_AcctrnID "
               "where oprstep.t_ServDocKind = 219 and oprstep.t_Symbol = 'н' and oprstep.t_ServDocID = " + GetOprServDoc().rec.DocumentID +
               " and oprdocs.t_DocKind = 1"; 

    // QueryStr1 = "select tick.t_DealID, tick.t_DealCode, tick.t_PartyID, party.t_shortname from ddl_tick_dbt tick " + 
    //           "join dparty_dbt party on tick.t_PartyID = party.t_PartyID " +
    //           "where tick.t_dealID = 103"; 
    
    DataSet1 = TRsbDataSet(QueryStr1);
    if (DataSet1.MoveNext())    
        
        AddSvOpReportLine("  ");
        AddSvOpReportLine("  ");                                                         
        AddSvOpReportLine("  Номер операции  " + String(GetOprServDoc().rec.CommCode:21:l) + "           Дата расчета:  " + String(Date(GetOprServDoc().rec.CommDate):10:c) + "           Дата документа:  " + String(Date(GetOprServDoc().rec.CommDate):10:c));
        if (GetOprServDoc().rec.AccrType == 2)
            AddSvOpReportLine("  Вид начисления:	Ежедневное ");
        else
            AddSvOpReportLine("  Вид начисления:	В дату платежа ");
        end;
        AddSvOpReportLine("  ");
        AddSvOpReportLine("  Результаты начисления процентов                                                       ");
        AddSvOpReportLine("┌──────────────────────┬────────────────────┬──────────────────────────┬─────────────────────────┬──────────────────┬──────────────────┬─────────────┬───────────┬──────────────────┬───────────────────────┬──────────────────────┬──────────────────────────┐");
        AddSvOpReportLine("│       № Сделки       │     Контрагент     │ Счет базы для начисления │      Счет учета         │   Дата начала    │  Дата окончания  │ Количество  │ Ставка, % │   Остаток базы   │   Сумма процентов,    │  Сумма начисленных   │  Сумма остатка счета     │"); 
        AddSvOpReportLine("│                      │                    │                          │  начисленных процентов  │  периода расчета │  периода расчета │    дней     │           │  для начисления  │     рассчитанная      │ процентов в операции │   учета начисленных      │");
        AddSvOpReportLine("│                      │                    │                          │                         │                  │                  │   периода   │           │                  │ за период постоянства │                      │ процентов после операции │");
        AddSvOpReportLine("│                      │                    │                          │                         │                  │                  │ потоянства  │           │                  │                       │                      │                          │");
        
        while (flag)
            deal_pd = MMFirstDoc(DL_IBCDOC, DataSet1.DealID, false);
            if (IsCLAIMSACQ(GetOperationGroup(deal_pd.GetTick().DealType)))
                deal_pd.FindNumberAccount(tdr_rights, AccBase, true, 0, deal_pd.GetLeg().PFI);
            else
                deal_pd.FindNumberAccount(tdr_rest(deal_pd.GetTick().FlagTypeDeal), AccBase, true, 0, deal_pd.GetLeg().PFI);
            end;

            if (IsSale(GetOperationGroup(deal_pd.GetTick().DealType)))
                deal_pd.FindNumberAccount(tdr_claimR, AccPerc, true, 0, deal_pd.GetLeg().PFI);
                PercRest = deal_pd.GetRestAccount(tdr_claimR, GetOprServDoc().rec.DocumentDate, deal_pd.GetLeg().PFI, 1);
            else
                deal_pd.FindNumberAccount(tdr_claimP, AccPerc, true, 0, deal_pd.GetLeg().PFI);
                PercRest = deal_pd.GetRestAccount(tdr_claimP, GetOprServDoc().rec.DocumentDate, deal_pd.GetLeg().PFI, 1);
            end;

            QueryStr2 = "select t_RateDate, nvl(lead(t_RateDate-1) over ( order by t_RateDate ), leg.t_Maturity) AS t_NextRateDate, t_Rate " + 
                "from ddl_tick_dbt tick " + 
                "join dprccontract_dbt contract on contract.t_ObjectID = tick.t_DealCode " +
                "join ddl_leg_dbt leg on leg.t_dealid = tick.t_dealid " +
                "join dprcrateval_dbt rate on rate.t_RateID = contract.t_RateID " +
                "where tick.t_BOfficeKind = " + DL_IBCDOC + " and tick.t_dealid = " + DataSet1.DealID +
                "and leg.t_LegKind = 0 and leg.t_LegId = 1 and contract.t_ObjectType = 103 and contract.t_ContractType = 7";
            DataSet2 = TRsbDataSet(QueryStr2);
            while (DataSet2.MoveNext())
                QueryStr3 = "select (case when (t_RestDate) < TO_DATE('" + date(DataSet2.RateDate) + "') then TO_DATE('" + date(DataSet2.RateDate) + "') else (t_RestDate + 1) end) As t_Date1, nvl(lead(t_RestDate) over ( order by t_RestDate ), TO_DATE('" + date(DataSet2.NextRateDate) + "')) AS t_Date2, t_Rest " +
                            "from drestdate_dbt restdate " +
                            "join daccount_dbt on daccount_dbt.t_AccountID = restdate.t_AccountID " +
                            "join dmcaccdoc_dbt mcaccdoc on daccount_dbt.t_Account = mcaccdoc.t_Account " +
                            "join dmccateg_dbt mccateg on mccateg.t_ID = mcaccdoc.t_CatID " +
                            "join ddl_tick_dbt tick on tick.t_DealID = mcaccdoc.t_DocID and tick.t_BOfficeKind = mcaccdoc.t_DocKind " +
                            "where tick.t_BOfficeKind = " + DL_IBCDOC + " and mcaccdoc.t_Account = " + AccBase + " and t_DealID = " + DataSet1.DealID +
                            " and t_RestDate <= TO_DATE('" + date(DataSet2.NextRateDate) + "') and (t_RestDate >= TO_DATE('" + date(DataSet2.RateDate) + "') OR t_RestDate = " +
                            "(select max(t_RestDate) " +
                            "from drestdate_dbt restdate " +
                            "join daccount_dbt on daccount_dbt.t_AccountID = restdate.t_AccountID " +
                            "join dmcaccdoc_dbt mcaccdoc on daccount_dbt.t_Account = mcaccdoc.t_Account " +
                            "join dmccateg_dbt mccateg on mccateg.t_ID = mcaccdoc.t_CatID " +
                            "join ddl_tick_dbt tick on tick.t_DealID = mcaccdoc.t_DocID and tick.t_BOfficeKind = mcaccdoc.t_DocKind " +
                            "where tick.t_BOfficeKind = " + DL_IBCDOC + " and mcaccdoc.t_Account = " + AccBase + " and t_DealID = " + DataSet1.DealID +
                            " and t_RestDate <= TO_DATE('" + date(DataSet2.NextRateDate) + "'))) ";

                DataSet3 = TRsbDataSet(QueryStr3);
                var i = 1;    
                while (DataSet3.MoveNext())  
                      
                    
                    Date1     = date(DataSet3.Date1);
                    Date2     = date(DataSet3.Date2);
                    Date1Prev = Date1;
                    Date2Prev = Date2;
                    datesplit(Date1, null, null, Year1);
                    datesplit(Date2, null, null, Year2);
                    if (Year1 != Year2)
                        YearsCount = Year2 - Year1;
                        for (var Year, 0, YearsCount)
                            datesplit(Date1Prev, null, null, Date1PrevYear);
                            if (GetDaysInYear(deal_pd, Date1PrevYear) != GetDaysInYear(deal_pd, Date1PrevYear + i))
                              Date2Prev = date(31,12,Date1PrevYear + i - 1);
                        
                              if (Date2Prev > Date2)
                                Date2Prev = Date2
                              end;   

                              WriteRec(deal_pd, DataSet1, DataSet2, DataSet3, AccBase, AccPerc, PercRest, Date1Prev, Date2Prev, first_rec);
                              if (first_rec)
                                first_rec = false;
                              end;

                              i = 1;
                              Date1Prev = Date2Prev + 1;
                            else
                              i = i + 1;
                            end;
                        end;
                        if (Date2Prev != Date2)
                            WriteRec(deal_pd, DataSet1, DataSet2, DataSet3, AccBase, AccPerc, PercRest, Date1Prev, Date2, first_rec);
                            if (first_rec)
                                first_rec = false;
                            end;
                        end;

                    else
                        WriteRec(deal_pd, DataSet1, DataSet2, DataSet3, AccBase, AccPerc, PercRest, date(DataSet3.Date1), date(DataSet3.Date2), first_rec);
                        if (first_rec)
                            first_rec = false;
                        end;                   
                    end;


                end;  
            end;

          first_rec = true;
          flag = DataSet1.MoveNext();
        end;

        AddSvOpReportLine("└──────────────────────┴────────────────────┴──────────────────────────┴─────────────────────────┴──────────────────┴──────────────────┴─────────────┴───────────┴──────────────────┴───────────────────────┴──────────────────────┴──────────────────────────┘"); 
    else
        AddSvOpReportLine("Нет обработанных сделок операцией № " + GetOprServDoc().rec.CommCode);
    end;

    return true;
END;
/****************************************************************************************/
MACRO OpFilter(_OprServDoc, _DealID)
    var Ok = true;

    record comm( dl_comm);
    SetBuff(comm, _OprServDoc);
  
  return Ok;
END;
