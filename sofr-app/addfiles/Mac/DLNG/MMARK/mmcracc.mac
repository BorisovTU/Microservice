/*
$Name:        mmcracc.mac
$Module:      МБ Кредиты
$Description: макрос выполнения шага "Открытие счетов"
*/
/*-------------------------------------------------------------------------
  Имя файла        : mmcracc.mac

  Описание         : макрос выполнения шага "Открытие счетов"

  Программист      : Куперин М.В.

  Создан           : 17.06.2008
-------------------------------------------------------------------------*/
IMPORT mmcnst_j, mmlibr, mmlb_j, mmlib, mmcateg,funk,dl_lib;

VAR Категории = TArray,
     Роли      = TArray,
     FirstDoc = NULL;

RECORD deal(dl_tick);

PRIVATE MACRO ОткрытьСчет(indx, Дата, Счет)
  var FindAccount = "";

  FirstDoc.OpenAccount(Категории[indx], FindAccount, NULL, Роли[indx], NULL, Дата, NULL);

  SetParm( 2, FindAccount );

  if (FindAccount == "")
      return false;
  end;
  
  return true;
END;

MACRO MM_acccount(par1)
  private var que,rs5,rez=0;

  que="select count(*) from daccount_dbt   where t_account ='"+par1+"'"; 
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 
        rez=int(rs5.value(0));
     end;
  end;
  return rez;
END;

PRIVATE MACRO ЗаполнитьМассивы(Категория, Роль)
  if (Роль == NULL)
      Роль = FirstDoc.GetFIRoleByCategory(Категория, FirstDoc.GetLeg().PFI)
  end;

  Категории[Категории.size] = Категория; 
  Роли[Роли.size]           = Роль;  
END;

PRIVATE MACRO FillArray(DealType, BOfficeKind)
  var acc4;
  if (BOfficeKind == DL_IBCDOC)
     if (isSale(GetOperationGroup(DealType)))
/*------------------------Категории для сделок размещения------------------------------------*/
        if (FirstDoc.GetTick().Flag1 != "X") 
           if (deal.dealtype == 12335)
              ЗаполнитьМассивы(tdr_mainrest_tf);
           elif ((deal.dealtype == 12308 ) or  (deal.dealtype == 2308 ))   
               ЗаполнитьМассивы(get_rights({curdate}));
               ЗаполнитьМассивы(tdr_nomcost);
           else
               ЗаполнитьМассивы(tdr_mainrest);
           end;
           if (deal.dealtype == 12306)
              ЗаполнитьМассивы("СЧЕТ_61212");
              ЗаполнитьМассивы("СЧЕТ_91418");
              ЗаполнитьМассивы(get_rights({curdate}));
              ЗаполнитьМассивы(tdr_nomcost);
           end;
           ЗаполнитьМассивы(tdr_claimR);
        else
           acc4 =MM_acc(deal.DealID,111);
           if (MM_acccount(acc4) == 0 )
              ЗаполнитьМассивы(tdr_mainrest);
           end;
        end;
/*
        if (FirstDoc.GetTick().Flag1 != "X")
            if  ((deal.dealtype != 12308 ) and  (deal.dealtype != 2308 ))
                ЗаполнитьМассивы(tdr_mainrest);
            end;
            ЗаполнитьМассивы(tdr_claimR);
             if (FirstDoc.GetTick().dealtype == 12306)
                ЗаполнитьМассивы("СЧЕТ_61212");
                ЗаполнитьМассивы("СЧЕТ_91418");
                ЗаполнитьМассивы(get_rights({curdate}));
                ЗаполнитьМассивы(tdr_nomcost);
             end;
        else
            acc4 =MM_acc(deal.DealID,111);
            if (MM_acccount(acc4) == 0 )
               ЗаполнитьМассивы(tdr_mainrest);
            end;
        end;
        if  (deal.dealtype == 12308 )
          ЗаполнитьМассивы(get_rights({curdate}));
          ЗаполнитьМассивы(tdr_nomcost);
        end;
*/
     else
/*------------------------Категории для сделок привлечения------------------------------------*/
        if (FirstDoc.GetTick().Flag1 != "X")
            if (deal.dealtype == 12310)
              ЗаполнитьМассивы(tdr_mainrest_tf);
            else
              ЗаполнитьМассивы(tdr_mainrest);
            end;
            ЗаполнитьМассивы(tdr_claimP);
            // ЗаполнитьМассивы("СЧЕТ_603");
        else
             acc4 =MM_acc(deal.DealID,111);
            if (MM_acccount(acc4) == 0 )
              ЗаполнитьМассивы(tdr_mainrest);
            end;
        end;
     end;
  elif (BOfficeKind == DL_CREDITLN)
     if (isSale(GetOperationGroup(DealType)))
/*------------------------Категории для кредитных линий размещения------------------------------------*/
         ЗаполнитьМассивы(tdr_oblP);
         ЗаполнитьМассивы(tdr_rezerve7);
         ЗаполнитьМассивы(tdr_rezerve8);
         ЗаполнитьМассивы(tdr_rezerve9);
     else
/*------------------------Категории для кредитных линий привлечения------------------------------------*/
         ЗаполнитьМассивы(tdr_oblR);
     end;
  end;
END;

MACRO ExecuteStep(Buffer, Document)
  var i     = 0,
      error = "";

  SetBuff( deal, Document );
  FirstDoc = MMFirstDoc(DL_IBCDOC, deal.DealID, true);  
    // return 0;


  if (CheckExistence(LEG_LegKind_DealID_LegID, LEG_KIND_DL_TICK, deal.DealID, 1))
      mm_error( "Не найден транш сделки ", deal.DealCode );
      return 1;
  end;
                
  FillArray(deal.DealType, deal.BOfficeKind); /*Заполнить массив с категориями в зависимости от направления сделки*/ 

  if (Категории.size > Роли.size)
      Роли.size = Категории.size;
  end;

  while (ValType(Категории(i)) == V_STRING)
    if (not ОткрытьСчет(i, deal.DealDate, NULL))
      mm_error("Не могу открыть счет для категории " + Категории(i)); 
      return 1;
    end;
    i = i + 1;
  end;
/*
  if (deal.BOfficeKind == DL_IBCDOC)
    УстановитьЗначениеККС(0);
    if (isSale(GetOperationGroup(deal.DealType)))
      if (not ActAccAfterChangeParm(FirstDoc, deal.DealDate, error))
        mm_error(error);
        return 1;
      end;
    end;
  end;
*/
  return 0;
END;
NameMacroFile = "mmcracc.mac";


MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -откат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */  


  private var acc,nfiid,dat;
  SetBuff(deal, FirstDoc );


  if ( CommitOrRollback == 1 )
     acc=ПРИКРЕПИТЬ2("-% к погашению",deal.dealid);
     dat=СДАТ(deal.dealdate);
     nfiid=plat_dil(deal.dealid,"102","9","fiid");
     execmacrofile("dl_kat.mac", "Ins_akat",acc,101,1,nfiid,dat) ;
  end;

END;
