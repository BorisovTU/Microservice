/*
$Name: mmrsrv.mac       
$Module: МБК
$Description: Сервисная операция: Формирование резерва  
*/
/*--------------------------------------------------------------------------------------*/
/*  Имя файла        : mmrsrv.mac                                                       */
/*                                                                                      */
/*  Описание         : Сервисная операция: Формирование резерва                         */
/*                                                                                      */
/*  Программист      : Куперин М.В.                                                     */
/*                                                                                      */
/*  Создан           : 10.11.2009                                                       */
/*--------------------------------------------------------------------------------------*/
IMPORT RsbDataSet, mmservop, globals, mmcateg, mmlb_j, mmcnst_j;
import globals, "dlcalcor_report.mac";//Simanov

/****************************************************************************************/
PRIVATE VAR
    ALG_MM_RESERVE_BASE     = 3532,
    ALG_MM_RESERVE_TYPEBASE = 3536;

/*Печать ошибок**************************************************************************/
MACRO PrintReportError(_ErrorArray)
    VAR 
        idx = 0,
        cntError = _ErrorArray.Size;

    AddSvOpReportLine("┌────────────┬────────────────────┬──────┬─────────────────────────────────────────────────────────────────────────────────────────┐");
    AddSvOpReportLine("│    Код     │    Номер сделки    │  №   │               Сообщение                                                                 │");
    AddSvOpReportLine("│  операции  │                    │ошибки│                                                                                         │");
    AddSvOpReportLine("├────────────┼────────────────────┼──────┼─────────────────────────────────────────────────────────────────────────────────────────┤");

    while (idx < cntError)
        AddSvOpReportLine("│" +
                           string(_ErrorArray[idx].OpCode:12)  + "│" + 
                           string(_ErrorArray[idx].ObjCode:20) + "│" +  
                           string(_ErrorArray[idx].NumErr:6)   + "│" +  
                           string(_ErrorArray[idx].StrErr:89)  + "│"  );
        idx = idx + 1;
    end;

    AddSvOpReportLine("└────────────┴────────────────────┴──────┴─────────────────────────────────────────────────────────────────────────────────────────┘");

    return true;
END;
/*Печать результатов работы**************************************************************/
MACRO OldReservAmount(ДатаРасчетаРезерва, DealID, TypeBase)
    VAR ResLnk = TRsbDataSet("select oldrezsum.t_reserveamount from " +
                              "(" +
                              "  select rownum as t_rownum, rez.* from" +
                              "  (" +
                              "    select t_reserveamount " +
                              "    from ddlreslnk_dbt " +
                              "    where t_parentid = " + DealID +
                              "    and t_reservedate <= " + "'" + Date(ДатаРасчетаРезерва) + "'" +
                              "    and t_typebase = " + TypeBase +
                              "    and t_ismanual = '0' " +
                              "    order by T_RESERVEDATE DESC, T_ID DESC " +
                              "  ) rez" +
                              ") oldrezsum " +
                              "where oldrezsum.t_rownum = 2");

    if (ResLnk.MoveNext())
        return ResLnk.ReserveAmount;
    else
        return 0;
    end;
END;    

MACRO PrintReport()
    VAR DataSet  = NULL,
         QueryStr = "", 
         flag     = true,
         A6 = 0, A10 = 0, A11 = 0;

    //Simanov. Отправить отчёт о начисленных резервах по почте
    var prm = CDLCalcORParm();

    prm.EndDate = {curdate};
    prm.ByMBK = true;
    prm.ByEmail = true;
    prm.IsShowReport = false;
    DL_CalcOR_Report(prm);

    QueryStr = 
               "select tick.t_dealid, dl_comm.t_commcode, reslnk.t_reservedate, tick.t_dealcode, " +
               "namealg1.t_sznamealg sznamealg1, namealg2.t_sznamealg sznamealg2, " +
               "party.t_shortname, acntrb.t_account acntrbacc, acntrez.t_account acntrezacc, " +
               "reslnk.t_qualitycategory, reslnk.t_reservepercent, leg.t_pfi, " +
               "reslnk.t_securityamount, reslnk.t_reserveamount, tick.t_dealid, reslnk.t_typebase, reslnk.t_reserveassesamount " +
               "from ddl_tick_dbt tick, ddl_leg_dbt leg, ddl_comm_dbt dl_comm, " + 
               "ddlreslnk_dbt reslnk, dnamealg_dbt namealg1, dnamealg_dbt namealg2, " +
               "dparty_dbt party, " +
               "(" +
               "select tick.t_dealid, accdoc.t_account, " +
               "decode (601, accdoc.t_catnum, 1, decode (1522, accdoc.t_catnum, 1, decode (1566, accdoc.t_catnum, 1, decode (1525, accdoc.t_catnum, 1, decode (700, accdoc.t_catnum, 2, decode (621, accdoc.t_catnum, 3, decode (611, accdoc.t_catnum, 4, decode (1328, accdoc.t_catnum, 5, decode (1330, accdoc.t_catnum, 5))))))))) numberalg " +
               "from ddl_tick_dbt tick, dmcaccdoc_dbt accdoc, dmccateg_dbt categ " +
               "where " +
               "(accdoc.t_dockind = tick.t_bofficekind)and" +
               "(accdoc.t_docid = tick.t_dealid)and" +
               "(categ.t_number = accdoc.t_catnum )and" +
               "((categ.t_code = 'ОД')or(categ.t_code = 'ОДОВ')or(categ.t_code = 'Права_требования_устар.')or(categ.t_code = 'Права_требования')or(categ.t_code = 'Треб. с н.с.')or(categ.t_code = '+% к погашению')or(categ.t_code = '+% с н.с.')or(categ.t_code = '+Штрафы за проср. %')or(categ.t_code = '+Штрафы за проср. ОД')or(categ.t_code = '+Штраф'))" +
               ") acntrb, " +
               "(" +
               "select tick.t_dealid, accdoc.t_account, categ.t_code, accdoc.t_catnum, " +
               "decode (243, accdoc.t_catnum, 1, decode (1532, accdoc.t_catnum, 1, decode (1575, accdoc.t_catnum, 1, decode (244, accdoc.t_catnum, 2, decode (1200, accdoc.t_catnum, 3, decode (1201, accdoc.t_catnum, 4, decode (1332, accdoc.t_catnum, 5))))))) numberalg " +
               "from ddl_tick_dbt tick, dmcaccdoc_dbt accdoc, dmccateg_dbt categ " +
               "where " +
               "(accdoc.t_dockind = tick.t_bofficekind)and" +
               "(accdoc.t_docid = tick.t_dealid)and" +
               "(categ.t_number = accdoc.t_catnum )and" +
               "((categ.t_code = 'Р, ссуды')or(categ.t_code = 'Р, ОД_ПТ_устар.')or(categ.t_code = 'Р, ОД_ПТ')or(categ.t_code = 'Р, ссуды с н.с.')or(categ.t_code = 'Р, %')or(categ.t_code = 'Р, % с н.с.')or(categ.t_code = 'Р, штрафы'))" +
               "union " +
               "select tick.t_dealid, accdoc.t_account, categ.t_code, accdoc.t_catnum, " +
               "decode (1575, accdoc.t_catnum, 2, decode (1532, accdoc.t_catnum, 2, decode (1575, accdoc.t_catnum, 2))) numberalg " +
               "from ddl_tick_dbt tick, dmcaccdoc_dbt accdoc, dmccateg_dbt categ " +
               "where " +
               "(accdoc.t_dockind = tick.t_bofficekind)and" +
               "(accdoc.t_docid = tick.t_dealid)and" +
               "(categ.t_number = accdoc.t_catnum )and" +
               "((categ.t_code = 'Р, ОД_ПТ_устар.')or(categ.t_code = 'Р, ОД_ПТ'))" +               
               ") acntrez " +
               "where " +
               "reslnk.t_childid = dl_comm.t_documentid " +
               "and reslnk.t_parentid = tick.t_dealid " +
               "and reslnk.t_reservekind = namealg1.t_inumberalg " +
               "and reslnk.t_typebase = namealg2.t_inumberalg " +
               "and party.t_partyid(+) = tick.t_partyid " +
               "and acntrb.t_dealid(+) = tick.t_dealid " +
               "and acntrb.numberalg(+) = namealg2.t_inumberalg " +
               "and acntrez.t_dealid(+) = tick.t_dealid " +
               "and acntrez.numberalg(+) = namealg2.t_inumberalg " +
               "and leg.t_dealid = tick.t_dealid " +
               "and leg.t_legkind = 0 " +
               "and leg.t_legid = 1 " +
               "and reslnk.t_ismanual = '0' " +
               "and namealg1.t_itypealg = " + String(ALG_MM_RESERVE_BASE) + 
               " and namealg2.t_itypealg = " + String(ALG_MM_RESERVE_TYPEBASE) +
               " and dl_comm.t_documentid = " + GetOprServDoc().rec.DocumentID;

    DataSet = TRsbDataSet(QueryStr);

    if (DataSet.MoveNext())    
        AddSvOpReportLine("  ");
        AddSvOpReportLine("  ");                                                         
        AddSvOpReportLine("  Номер операции  " + String(GetOprServDoc().rec.CommCode:21:l) + "           Дата расчета:  " + String(Date(DataSet.ReserveDate):10:c));
        AddSvOpReportLine("  Вид резерва:    Резервы по размещенным кредитам (депозитам)                          ");
        AddSvOpReportLine("  ");
        AddSvOpReportLine("  1. Результаты расчета резервов                                                       ");
        AddSvOpReportLine("┌──────────────────────────────┬────────────────────┬────────────────────┬────────────────────┬─────────────────────┬─────────────────────┬───────────┬──────────┬───────────────────────┬────────────────────────┬─────────────────────────┬─────────────────────────┬───────────────────────┬───────────────────────────┐");
        AddSvOpReportLine("│           № Сделки           │    Вид расчетной   │    Вид расчетной   │     Контрагент     │ Счет расчетной базы │     Счет резерва    │ Категория │     %    │  Расчетная база, " + {CCYNatCur} + "  │ Сумма обеспечения, " + {CCYNatCur} + " │ Расчетная сумма резерва │ Ранее созданный резерв, │  Сумма корректировки, │ Сумма оценочного резерва, │"); 
        AddSvOpReportLine("│                              │        базы        │        базы        │                    │                     │                     │ качества  │  резерва │                       │                        │           " + {CCYNatCur} + "           │           " + {CCYNatCur} + "           │           " + {CCYNatCur} + "         │             " + {CCYNatCur} + "           │");

        while (flag)
            A10 = OldReservAmount(DataSet.ReserveDate, DataSet.DealID, DataSet.TypeBase);
            A11 = DataSet.ReserveAmount - A10;
//            A6  = abs(RestA(DataSet.acntrbacc, Date(DataSet.ReserveDate)));
            ПолучитьОстатокСчета(NULL, NULL, DataSet.acntrbacc, NULL, A6, Date(DataSet.ReserveDate), DataSet.PFI);
            Конвертировать (A6, DataSet.PFI, A6, NATCUR, Date(DataSet.ReserveDate));

            AddSvOpReportLine("├──────────────────────────────┼────────────────────┼────────────────────┼────────────────────┼─────────────────────┼─────────────────────┼───────────┼──────────┼───────────────────────┼────────────────────────┼─────────────────────────┼─────────────────────────┼───────────────────────┼───────────────────────────┤");
            AddSvOpReportLine("│" + 
                               String(DataSet.DealCode:30:r)        + "│" +
                               String(DataSet.SzNameAlg1:20:c:z)    + "│" +
                               String(DataSet.SzNameAlg2:20:c:z)    + "│" +
                               String(DataSet.ShortName:20:l:z)     + "│" +
                               String(DataSet.acntrbacc:21:z)       + "│" +
                               String(DataSet.acntrezacc:21:z)      + "│" +
                               String(DataSet.QualityCategory:11:z) + "│" +
                               String(DataSet.ReservePercent:10)    + "│" +
                               String(A6:23)                        + "│" +
                               String(DataSet.SecurityAmount:24)    + "│" +
                               String(DataSet.ReserveAmount:25)     + "│" +
                               String(A10:25)                       + "│" +
                               String(A11:23)                       + "│" +
                               String(DataSet.ReserveAssesAmount:27)+ "│");

           flag = DataSet.MoveNext();
       end;

        AddSvOpReportLine("└──────────────────────────────┴────────────────────┴────────────────────┴────────────────────┴─────────────────────┴─────────────────────┴───────────┴──────────┴───────────────────────┴────────────────────────┴─────────────────────────┴─────────────────────────┴───────────────────────┴───────────────────────────┘");
    else
        AddSvOpReportLine("Нет обработанных сделок операцией № " + GetOprServDoc().rec.CommCode);
    end;

    return true;
END;
/****************************************************************************************/
MACRO OpFilter(_OprServDoc, _DealID)
    const RSRV_CATEG_NONE        = 1, /* не создавать резерв */
          RSRV_CATEG_YES         = 2; /* создавать резерв */

    var fd = MMFirstDoc(DL_IBCDOC, _DealID),
        attr_id = RSRV_CATEG_NONE,
        Ok = false, PrincPaym, sqltext = "", comis;

    record comm( dl_comm);
    SetBuff(comm, _OprServDoc);

  if( (comm.DocKind == DL_MMRESERV))  /* Формирование резерва для МБК */
        // у кредитных линий нет платежей
        if (fd.tick.rec.BofficeKind == DL_IBCDOC)
            sqltext = "select t_PaymStatus from dpmpaym_dbt" +
                    " where t_DocKind = " + DL_IBCDOC + " and t_DocumentID = " + fd.tick.rec.DealID;

            PrincPaym = TRsbDataSet(sqltext + " and t_Purpose = " + PM_PURP_PRINC + 
                            " and (t_PaymStatus >= " + PM_READY_TO_SEND +
                                "  or  t_PaymStatus = "  + PM_CLOSEDBYPROLONGATION + // Закрыт пролонгацией
                                "  or  t_PaymStatus = "  + PM_CLOSEDBYMODIFICATION + // Закрыт модификацией
                                "  or  t_PaymStatus = "  + PM_CAPITALIZED +   // Капитализирован
                                "  or  t_PaymStatus = "  + PM_REJECTED    +   // отвергнутый платеж
                                "  or  t_PaymStatus = "  + PM_CLOSED_W_M_MOVEMENT + // Закрыт без движения средств
                                ")");
            Ok = PrincPaym.MoveNext;

            // Значение категории "Создание резервов"
            if (IsSale(fd.tick.rec.DealGroup))
            if (GetMainObjAttr(NULL, OBJTYPE_MMARKDEAL, UniID(fd.tick, OBJTYPE_MMARKDEAL), 2, attr_id, NULL, NULL, comm.CommDate))
                if (attr_id == RSRV_CATEG_NONE) // "не создавать"
                    return Ok = false;
                end;
            end;
        else
                if (comm.flag8)
                    /*
                    comis = TRsbDataSet("select comis.t_id from ddlcomis_dbt comis " +
                                    "inner join dsfcomiss_dbt sfcom on sfcom.t_feetype = comis.t_feetype " +
                                           "and sfcom.t_number = comis.t_comnumber " +
                                         "where comis.t_DocKind = 102 and comis.t_docid = " + fd.tick.rec.DealID +
                                           "and sfcom.t_receiverid = " + {ourbank});*/

                    comis = TRsbDataSet("select t_paymentid from dpmpaym_dbt where t_DocKind = 102 and t_DocumentID = " + fd.tick.rec.DealID +
                                          " and t_Purpose = 87");
                    Ok = comis.MoveNext;
                else
                    return Ok = false;
                end;
            end;
        else
            Ok = true;
            if (GetMainObjAttr(NULL, OBJTYPE_CREDITLN, UniID(fd.tick, OBJTYPE_CREDITLN), 2, attr_id, NULL, NULL, comm.CommDate))
                if (attr_id == RSRV_CATEG_NONE) // "не создавать"
                    return Ok = false;
                end;
            end;
        end;

  end;

  return Ok;
END;
/****************************************************************************************/
//private macro ВалютнаяКорректировка(tick, OprDate, ККС, ПР, Rold, ВК:@variant)
//var PrevOp, ok = true;
//
//    ВК = ""; // По умолчанию операция не явл. валютной корректирокой
//
//    PrevOp = TRsbDataSet("SELECT t_QualityCategory, t_ReservePercent " +
//                  " FROM ddlreslnk_dbt " +
//                  " WHERE t_Type = 3 AND t_ParentID = " + tick.DealID + " AND t_ChildID != -1 "+
//                     " AND t_LnkDate <= "+ ToDateFromDlQuery(OprDate) +
//                  " ORDER BY t_LnkDate DESC, t_Id DESC ");
//
//    ok = PrevOp.MoveNext();
//    if(ok)
//       ok = ((PrevOp.QualityCategory == ККС) and (PrevOp.ReservePercent == ПР));
//    end;
//
//    if(ok) // Это ВК
//       if(OprServDoc.Flag1 == "X") // ВК разрешена
//          ВК = "X";
//       elif(Rold > $0) // ВК запрещена, и резерв не был списан при просрочке
//          SayReserveError( tick, 99, string("Валютная корректировка не производится") );
//          return false;
//       end;
//    end;
//
//    return true;
//end;
