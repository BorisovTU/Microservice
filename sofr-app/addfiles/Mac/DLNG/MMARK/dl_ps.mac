import InsCarryDoc, CurrInter, Проценты, MmarkInter, mmlibr, mmcarry, mmcnst_j, mmplib, dl_lib,dl_plib,funk ;
import dl_guarantee_mbk;

PRIVATE FILE leg (dl_leg);
// PRIVATE FILE pm ("pmpaym") key 1 write;
PRIVATE RECORD tick (dl_tick);

/*----------------------------------------------------------------------------
    Выполнение шага
----------------------------------------------------------------------------*/
MACRO ExecuteStep(Buffer, Document)
  var deal_pd ,acc0, acc2, acc0p, s_addground, nrate, vsum,sground,rs9,rs2,ii,nka,nfiid,que,tran,i0,nnn,bcid,avoir=0, stat, УчетПравТребования;
  var  at  = MM_Carry;
  var  atp = MM_Carry;

  SetBuff (tick,Document);
  DL_PrepareCarryBuffer (Buffer);
  leg.LegKind = LEG_KIND_DL_TICK;
  leg.DealID = tick.DealID;
  leg.LegID = 1;

  if (not GetEq(leg))
    mm_error ("Не найден транш сделки");
    return 1;
  end;

  deal_pd = MMFirstDoc(DL_IBCDOC, tick.DealID, true);
  s_addground = GetGroundAddPart(tick);
  // vsum=MM_zalog(tick.DealID);
  nfiid=0;
  avoir=0;
  que="select  b.t_cost amount, c.t_avoirkind avoirkind, c.t_fiid fiid, c.t_fi_kind  from ddl_grnt_dbt a , ddl_secur_dbt b, ddl_order_dbt o, dfininstr_dbt c where t_dealid="+tick.DealID+" and b.t_contractid=a.t_contractid and b.t_contractid=o.t_contractid and c.t_fiid=b.t_fiid and o.t_flag1 != 'X' order by t_numsecinorder";
  rs9 = LnGetRecordSet(que);
  if(rs9 != null)
    while(rs9.moveNext())
      if ( rs9.value("avoirkind") == 5 )

        avoir=5;
        nfiid=rs9.value("fiid");
        vsum=rs9.value("amount");

        que = "update dvsbanner_dbt  set t_description = 'RZ'  where t_fiid="+nfiid;
        rs2 = LnGetRecordSet(que);

        que=" select t_bcid from dvsbanner_dbt  where t_fiid="+nfiid;
        rs2 = LnGetRecordSet(que);
        if(rs2 != null)
          while(rs2.moveNext())
            bcid=rs2.value(0);
          end;
        end;
        execmacrofile("dl_note_lib.mac", "NEWNOTE", bcid, 101, vsum);
      elif (rs9.value("t_fi_kind") == 2 )
        avoir = 2;
      end;

    end;
  end;

  if ( avoir == 5 )
    if ( nfiid > 0 )
      execmacrofile("dl_va.mac", "nza",nfiid) ;
      execmacrofile("dl_va20.mac", "nnza",nfiid) ;
      msgbox("В модуле 'Учтенные векселя' зафиксирован залог по сделке !");
    end;
    return 0;
  end;

  if(not deal_pd.OpenAccount("ВнебалСчетКорресп0", acc2, NULL, deal_pd.GetFIRoleByCategory("ВнебалСчетКорресп", deal_pd.GetLeg().PFI), NULL, deal_pd.GetTick().DealDate, deal_pd.GetLeg().PFI))
    return 1;
  end;    

  ii=1;
  que="select rownum, b.t_cost amount ,b.t_fiid fiid ,b.t_crdnumber transh, b.t_valuationdate da0 ,b.t_contractor partyid, T_REALTYNAME transh2, b.t_crdsum crdsum, b.t_crdfiid crdfiid, c.t_systypes systypes from ddl_grnt_dbt a , ddl_secur_dbt b, dmm_order_dbt c, ddl_order_dbt o where b.t_contractid = c.t_contractid and b.t_contractid = o.t_contractid and t_dealid="+tick.DealID+" and b.t_contractid=a.t_contractid and o.t_flag1 != 'X' order by t_numsecinorder";
  rs9 = LnGetRecordSet(que);
  if(rs9 != null)
    while(rs9.moveNext())
      // sground="Постановка на учет выданного залога - обеспечение "+nami(rs9.value("partyid"))+" "+rs9.value("transh")+" от "+SDAT(rs9.value("da0"))+" (сделка No "+tick.dealcode+" от "+SDAT(tick.dealdate)+" "+nami(tick.partyid)+" )";

      tran=rs9.value("transh");
      if ( strlen(rs9.value("transh2")) > strlen(tran) )
        tran=rs9.value("transh2");
      end;
      tran=strsubst(tran,"в рамках договора","в рамках КД");
	  
	  i0=index(tran,"Транш");
      if (i0 <= 0 )
        tran="КД №" + tran;
      end;

      tran=strsubst(tran,"","");
      
      sground="Изв. " + deal_pd.GetTick().DealCode + " от " + deal_pd.GetTick().DealDate + " " +tran+ " от "+SDAT(rs9.value("da0"))+" "+nami(rs9.value("partyid"))+", переданный в обеспечение кредита, полученного от ";
      if (deal_pd.GetTick().PartyID == _BANK_RF)
         sground=sground + "Банка России";
      else
         sground=sground + nami(deal_pd.GetTick().PartyID);
      end;
      if (deal_pd.GetTick().GenAgrID > 0)
         sground=sground + " (ГКД №" + deal_pd.GetGenAgr().Code + " от " + SDAT(deal_pd.GetGenAgr().Start) + ")";
      end;
      sground=sground + ", распоряжение ДОФР от "+SDAT({curdate})+".";

      /*
      КД от 18.09.2014 №140200/0048 (транш № 24) ОАО "Токаревская птицефабрика",
      переданный в обеспечение кредита, полученного от Банка России (ГКД №33495004 от 09.07.2014) 25.02.2019.
      */
	  
      nka="-Обесп. кр., ц/б_K"+string(ii);
      // nfiid=rs9.value("partyid"); //ZOM 534523 6.12.21
      nfiid=rs9.value("fiid"); //ZOM 534523 6.12.21
      vsum=rs9.value("amount");

	  if (rs9.value("systypes") == "к")
		GetRegistryValue("MMARK\\ОБЩИЕ\\ОБЕСПЕЧЕНИЕ\\УЧЕТ ПРАВ ТРЕБОВАНИЯ", V_INTEGER, УчетПравТребования, stat);
		if (УчетПравТребования == 2)
			nfiid=rs9.value("crdfiid");
			vsum=rs9.value("crdsum");
		end;
	  end;

      // if(not deal_pd.OpenAccount(nka, acc0, NULL, deal_pd.GetFIRoleByCategory(nka, deal_pd.GetLeg().PFI), NULL, deal_pd.GetTick().DealDate, deal_pd.GetLeg().PFI)) 
      if(not deal_pd.OpenAccount(nka, acc0, NULL, deal_pd.GetFIRoleByCategory(nka, nfiid), NULL, deal_pd.GetTick().DealDate, nfiid)) //ZOM 534523 6.12.21
        return 1;
      end;    

      if (avoir != 2) 
         
//        at.Numb_Document = execmacrofile("fx_lib", "MakeNumber0");
        at.AccountPayer    = acc0;    
        at.AccountReceiver = acc2;
        at.FIIDPayer       = nfiid;   //SVE 534523 10.12.2021
        at.FIIDReceiver    = leg.pfi;
        at.SumPayer        = vsum;
        at.SumReceiver     = null;
        at.Chapter         = 3;
        at.Ground          = sground;
        if(not at.carry())
          msgbox("Error !");
          return false;
        end;
      end;

      ii=ii+1;
    end;
  end;

  return 0;
END;

MACRO CheckStepAction( mes:integer, Document ):integer
  var stat = 0;

  if( mes == OP_BACKOUT_STEP )
    SetBuff (tick,Document);
    if (Check_exists_guarantee_from_mbk(tick.DealID, guarantee_opersubkind_in))
      MsgBox("Нельзя откатывать шаг операции. В БОЦБ существует Перевод обеспечения, привязанный к данной сделке");
      stat = 1;
    end;
  end;
 
  return stat;
END;