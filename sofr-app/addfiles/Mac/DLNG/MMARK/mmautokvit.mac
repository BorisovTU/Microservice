/*
$Name:             mmautokvit.mac
$Module:           МБК
$Description:      Автоквитовка входящих платежей
*/
IMPORT BankInter, MMarkInter, RSD, RsbDataSet, globals, oralib, likepy;
import funk,fx_globals, "dl_mvp.mac";

PRIVATE VAR dialog_flag;
PRIVATE CONST UNSET_CHAR = "X";


CLASS KvitPair
    VAR PlanID       :integer; // ID планового платежа
    VAR DealCode     :string;  // Номер сделки, к которой относится плановый платеж
    VAR PlanDate     :date;    // Дата планового платежа
    VAR PlanAmount   :money;   // Сумма планового платежа
    VAR PlanCurrency :string;  // Цифровой код валюты планового платежа
    VAR FactID       :integer; // ID фактического платежа
    VAR FactDate     :date;    // Дата фактического платежа
    VAR FactAmount   :money;   // Сумма фактического платежа
    VAR FactCurrency :string;  // Цифровой код валюты фактического платежа
    VAR Amount       :money;   // Сквитованная сумма планового и фактического платежей
    VAR Notice       :string;  // Примечание
END;

CLASS KvitFail
    VAR PlanID       :integer; // ID планового платежа
    VAR DealCode     :string;  // Номер сделки, к которой относится плановый платеж
    VAR PlanDate     :date;    // Дата планового платежа
    VAR PlanAmount   :money;   // Сумма планового платежа
    VAR PlanCurrency :string;  // Цифровой код валюты планового платежа
    VAR Notice       :string;  // Примечание
END;


PRIVATE VAR KvitSuccessArray : TArray = TArray();
PRIVATE VAR KvitFailArray    : TArray = TArray();

MACRO ClearKvit()
    RSDCommand("TRUNCATE TABLE dmm_kvit_tmp").execute();
END;

MACRO Prnt()
    VAR cmd, RS;

    cmd = RsdCommand("select * from dmm_kvit_tmp");
    cmd.execute;
    RS = RsdRecordset(cmd);

    WHILE (RS.moveNext)
        PRINTLN("DealID: "     + RS.value("t_DealID")     + "; " +
                "PlanPaymID: " + RS.value("t_PlanPaymID") + "; " +
                "FactPaymID: " + RS.value("t_FactPaymID") + "; " +
                "KvitAmount: " + RS.value("t_KvitAmount") + "; " +
                "Auto: "       + RS.value("t_Auto")       + "; ");
    END;
    
    ClearKvit();
END;



MACRO InsKvit(DealID, PlanPaymID, FactPaymID, KvitAmount, Auto)
    var dda;
    dda={curdate};

    VAR ins = RSDCommand("INSERT INTO dmm_kvit_tmp (t_dealid, t_planpaymid, t_factpaymid, t_kvitamount, t_auto, t_valuedate) VALUES (?,?,?,?,?,?)");
    ins.addParam("", RSDBP_IN, DealID);
    ins.addParam("", RSDBP_IN, PlanPaymID);
    ins.addParam("", RSDBP_IN, FactPaymID);
    ins.addParam("", RSDBP_IN, KvitAmount);
    ins.addParam("", RSDBP_IN, Auto);
    ins.addParam("", RSDBP_IN, dda);

    ins.execute();

    //PRINTLN("DealID: " + DealID + "; PlanPaymID: " + PlanPaymID + "; FactPaymID: " + FactPaymID + "; KvitAmount: " + KvitAmount + "; Auto: " + Auto);
END;


MACRO MM_account(par1,par2)
  private var que,rs5,rez=0;

  que="select t_account from dmcaccdoc_dbt where t_dockind=102 and t_catid="+par2+" and t_docid="+par1;
  rs5 = LnGetRecordSet(que);
  if(rs5 != null)
     if (rs5.moveNext) 

        rez=rs5.value(0);
     end;
  end;
  return rez;
END;


MACRO P107()



   private var que,rs,ndealid,ntip,rs50,rs55,rs21,npaym,paym2,delta,sclient,snalog,acc1,acc2,nval,d0,baseamount, ppaymentid,fpaymentid, factsum;
   d0={curdate};
     que="select c.t_dealid,a.t_purpose purpose, c.t_dealcode dealcode,a.t_baseamount amount,e.t_shortname , a.t_paymentid paymentid, c.t_dealtype dealtype, d.t_pfi pfi   from  ddl_tick_dbt c, ddl_leg_dbt d, dparty_dbt e , dpmpaym_dbt a where c.t_dealtype !=12310 and  c.t_dealtype !=12335 and   c.t_dealstatus < 20 and  c.t_bofficekind=102 and c.t_partyid  !="+ _BANK_RF ;
     que=que+ " and d.t_dealid=c.t_dealid and d.t_legid=1  and e.t_partyid=c.t_partyid  and a.t_dockind=102 and a.t_documentid=c.t_dealid  and a.t_receiver=1 and  a.t_paymstatus< 32000 and a.t_paymstatus != 55   and a.t_valuedate='"+d0+"'  order by c.t_dealdate, c.t_dealid ";
     rs = LnGetRecordSet(que);
     if(rs != null)
        while(rs.moveNext())
          ndealid=int(rs.value(0));
          nval=int(rs.value("pfi"));
          ntip=rs.value(1);
          npaym= rs.value("paymentid");
          baseamount=rs.value("amount");
          delta=0.0;
          if ( ntip == 11)
               sclient=MM_tickid2(ndealid,"partyid");
               snalog=MM_nalog2(sclient);
               if (snalog > 0 )
                 delta=(rs.value("amount")*snalog/100);
               else
                 delta=0.0;
               end;
          end;


            if ( rs.value("purpose") == 11 ) 
        if ( rs.value("dealtype") == 12300 ) 
          acc1 =MM_account(ndealid,118);
        else
          acc1 =MM_account(ndealid,117);
        end;

            else
              acc1 =MM_account(ndealid,111);
            end;

       if ( nval > 0 )
        que="update dpmpaym_dbt set t_receiveraccount='"+acc1+"' where t_paymentid="+npaym;
        rs21 = LnGetRecordSet(que);
       end;

       que= "select b.t_paymentid,bb.t_paymentid, b.t_baseamount, bb.t_paymstatus sta, RSB_Struct.GetString(cc.t_text) account, bb.t_baseamount amount from ddl_tick_dbt a , dpmpaym_dbt b,dpmpaym_dbt bb, dnotetext_dbt cc  where a.t_dealid="+ndealid+" and b.t_dockind=102 and b.t_documentid=a.t_dealid ";
       que=que+" and b.t_paymstatus < 32000  and b.t_purpose="+ntip+" and b.t_valuedate='"+d0+"'  and bb.t_dockind=322 and bb.t_fiid=b.t_fiid ";
       que=que+" and bb.t_baseamount=b.t_baseamount-"+delta+" and substr(bb.t_receiveraccount,1,5)='47416'  and  bb.t_valuedate= b.t_valuedate ";
       que=que+"and cc.t_objecttype=501 and cc.t_notekind=101 and cc.t_documentid=lpad(bb.t_paymentid,10,'0') ";
       // msgbox(que);
       rs55 = LnGetRecordSet(que);
       if(rs55 != null)
        if (rs55.moveNext) 
          if (trim(rs55.value("account")) == acc1 )
             ppaymentid=rs55.value(0);
             fpaymentid=rs55.value(1);
             factsum = rs55.value(2);

             if ( rs55.value("sta") == 2990 )
              que="update dpmpaym_dbt set t_paymstatus=2995, t_tobackoffice='J' where t_paymentid="+fpaymentid;
              rs21 = LnGetRecordSet(que);
             end;


             // --
             que="select count(*) from dmm_kvit_tmp where  t_planpaymid="+ppaymentid+" and  t_factpaymid="+fpaymentid+" and t_kvitamount="+Money(factsum);
             rs21 = LnGetRecordSet(que);
             if(rs21 != null)
                if (rs21.moveNext) 
                   if ( rs21.value(0) == 0 )
                     InsKvit(ndealid, ppaymentid,fpaymentid, Money(factsum), UNSET_CHAR); 


                   end;
                end;
             end;
             // --



          end;


        end;
       end;

     end;
   end;

                  


END;



MACRO Pnal()

   private var que,rs,ndealid,ntip,rs50,rs55,rs21,npaym,paym2,delta,sclient,snalog,acc1,acc2,nval,d0,baseamount, ppaymentid,fpaymentid, factsum;
   d0={curdate};
     que="select c.t_dealid,a.t_purpose purpose, c.t_dealcode dealcode,a.t_baseamount amount,e.t_shortname , a.t_paymentid paymentid, c.t_dealtype dealtype, d.t_pfi pfi   from  ddl_tick_dbt c, ddl_leg_dbt d, dparty_dbt e , dpmpaym_dbt a where c.t_dealtype !=12310 and  c.t_dealtype !=12335 and   c.t_dealstatus < 20 and  c.t_bofficekind=102 ";
     que=que+ " and d.t_dealid=c.t_dealid and d.t_legid=1  and e.t_partyid=c.t_partyid  and a.t_dockind=102 and a.t_documentid=c.t_dealid  and a.t_purpose=11   and a.t_receiver=1 and  a.t_paymstatus< 32000 and a.t_paymstatus != 55   and a.t_valuedate='"+d0+"'  order by c.t_dealdate, c.t_dealid ";
     rs = LnGetRecordSet(que);
     if(rs != null)
        while(rs.moveNext())
          ndealid=int(rs.value(0));
          nval=int(rs.value("pfi"));
          ntip=rs.value(1);
          npaym= rs.value("paymentid");
          baseamount=rs.value("amount");
          delta=0.0;
          if ( ntip == 11)
               sclient=MM_tickid2(ndealid,"partyid");
               snalog=MM_nalog2(sclient);
               if (snalog > 0 )
                 delta=(rs.value("amount")*snalog/100);
               else
                 delta=0.0;
               end;
          end;


            if ( rs.value("purpose") == 11 ) 
        if ( rs.value("dealtype") == 12300 ) 
          acc1 =MM_account(ndealid,118);
        else
          acc1 =MM_account(ndealid,117);
        end;

            else
              acc1 =MM_account(ndealid,111);
            end;

       if ( nval > 0 )
        que="update dpmpaym_dbt set t_receiveraccount='"+acc1+"' where t_paymentid="+npaym;
        rs21 = LnGetRecordSet(que);
       end;

 
                          if ( delta > 0 )
       que= "select b.t_paymentid,bb.t_paymentid, b.t_baseamount, bb.t_paymstatus sta  from ddl_tick_dbt a , dpmpaym_dbt b,dpmpaym_dbt bb where a.t_dealid="+ndealid+" and b.t_dockind=102 and b.t_documentid=a.t_dealid ";
       que=que+" and b.t_paymstatus < 32000  and b.t_purpose="+ntip+" and b.t_valuedate='"+d0+"'  and bb.t_dockind=322 and bb.t_fiid=b.t_fiid ";
       que=que+" and bb.t_baseamount=b.t_baseamount-"+delta+" and bb.t_receiveraccount=b.t_receiveraccount and  bb.t_valuedate= b.t_valuedate ";

       // msgbox(que);
       rs55 = LnGetRecordSet(que);
       if(rs55 != null)
        if (rs55.moveNext) 

             ppaymentid=rs55.value(0);
             fpaymentid=rs55.value(1);
             factsum = rs55.value(2);

             if ( rs55.value("sta") == 2990 )
              que="update dpmpaym_dbt set t_paymstatus=2995, t_tobackoffice='J' where t_paymentid="+fpaymentid;
              rs21 = LnGetRecordSet(que);
             end;

             InsKvit(ndealid, ppaymentid,fpaymentid, Money(factsum), UNSET_CHAR); 

        end;
       end;
                          end;



     end;
   end;

                  


END;




MACRO Pfiid()

   private var que,rs,ndealid,ntip,rs50,rs55,rs21,npaym,paym2,delta,sclient,snalog,acc1,acc2,nval,d0,baseamount, ppaymentid,fpaymentid, factsum,vari=0,pfiid;
   d0={curdate};
     que="select c.t_dealid,a.t_purpose purpose, c.t_dealcode dealcode,a.t_fiid fiid,   a.t_baseamount amount,c.t_partyid partyid,e.t_shortname , a.t_paymentid paymentid, c.t_dealtype dealtype, d.t_pfi pfi   from  ddl_tick_dbt c, ddl_leg_dbt d, dparty_dbt e , dpmpaym_dbt a where c.t_dealtype !=12310 and  c.t_dealtype !=12335 and   c.t_dealstatus < 20 and  c.t_bofficekind=102 ";
     que=que+ " and d.t_dealid=c.t_dealid and d.t_legid=1  and e.t_partyid=c.t_partyid  and a.t_dockind=102 and a.t_documentid=c.t_dealid   and a.t_receiver=1 and a.t_fiid > 0 and  a.t_paymstatus< 32000 and a.t_paymstatus != 55   and a.t_valuedate='"+d0+"'  order by c.t_dealdate, c.t_dealid ";
     rs = LnGetRecordSet(que);
     if(rs != null)
        while(rs.moveNext())
          vari=0;
          ndealid=int(rs.value(0));
          nval=int(rs.value("pfi"));
          ntip=rs.value(1);
          npaym= rs.value("paymentid");
          baseamount=rs.value("amount");
          delta=0.0;
          sclient=rs.value("partyid");
          pfiid=rs.value("fiid");

          if ( ntip == 11)
               snalog=MM_nalog2(sclient);
               if (snalog > 0 )
                 delta=(rs.value("amount")*snalog/100);
               else
                 delta=0.0;
               end;
          end;


            if ( rs.value("purpose") == 11 ) 
        if ( rs.value("dealtype") == 12300 ) 
          acc1 =MM_account(ndealid,118);
        else
          acc1 =MM_account(ndealid,117);
        end;

            else
              acc1 =MM_account(ndealid,111);
            end;

       if ( nval > 0 )
        que="update dpmpaym_dbt set t_receiveraccount='"+acc1+"' where t_paymentid="+npaym;
        rs21 = LnGetRecordSet(que);
       end;



       que="select count(*)  from  ddl_tick_dbt c, ddl_leg_dbt d, dparty_dbt e , dpmpaym_dbt a where c.t_dealtype !=12310 and  c.t_dealtype !=12335 and   c.t_dealstatus < 20 and  c.t_bofficekind=102 ";
       que=que+ " and c.t_partyid="+sclient+" and a.t_baseamount="+rs.value("amount")+" and a.t_fiid="+pfiid; 
       que=que+ " and d.t_dealid=c.t_dealid  and d.t_legid=1  and e.t_partyid=c.t_partyid  and a.t_dockind=102 and a.t_documentid=c.t_dealid   and a.t_receiver=1 and a.t_fiid > 0 and  a.t_paymstatus< 32000 and a.t_paymstatus != 55   and a.t_valuedate='"+d0+"'";
       rs55 = LnGetRecordSet(que);
       if(rs55 != null)
        if (rs55.moveNext) 
           vari=int(rs55.value(0));
        end;
       end;


       que= "select count(*)  from ddl_tick_dbt a , dpmpaym_dbt b,dpmpaym_dbt bb where a.t_dealid="+ndealid+" and b.t_dockind=102 and b.t_documentid=a.t_dealid ";
       que=que+" and b.t_paymstatus < 32000  and b.t_purpose="+ntip+" and b.t_valuedate='"+d0+"'  and bb.t_dockind=322 and bb.t_fiid=b.t_fiid  and bb.t_payer="+sclient;
       que=que+" and bb.t_baseamount=b.t_baseamount-"+delta+" and substr(bb.t_receiveraccount,1,5)='47416'  and  bb.t_valuedate= b.t_valuedate and bb.t_tobackoffice='J' ";
       rs55 = LnGetRecordSet(que);
       if(rs55 != null)
        if (rs55.moveNext) 
           vari=vari+int(rs55.value(0));
        end;
       end;

 
                          if ( vari == 2 )
       que= "select b.t_paymentid,bb.t_paymentid, b.t_baseamount, bb.t_paymstatus sta  from ddl_tick_dbt a , dpmpaym_dbt b,dpmpaym_dbt bb where a.t_dealid="+ndealid+" and b.t_dockind=102 and b.t_documentid=a.t_dealid ";
       que=que+" and b.t_paymstatus < 32000  and b.t_purpose="+ntip+" and b.t_valuedate='"+d0+"'  and bb.t_dockind=322 and bb.t_fiid=b.t_fiid and bb.t_payer="+sclient;
       que=que+" and bb.t_baseamount=b.t_baseamount-"+delta+" and substr(bb.t_receiveraccount,1,5)='47416'  and  bb.t_valuedate= b.t_valuedate and bb.t_tobackoffice='J' ";

       // msgbox(que);
       rs55 = LnGetRecordSet(que);
       if(rs55 != null)
        if (rs55.moveNext) 

             ppaymentid=rs55.value(0);
             fpaymentid=rs55.value(1);
             factsum = rs55.value(2);

             if ( rs55.value("sta") == 2990 )
              que="update dpmpaym_dbt set t_paymstatus=2995  where t_paymentid="+fpaymentid;
              rs21 = LnGetRecordSet(que);
             end;


             // --
             que="select count(*) from dmm_kvit_tmp where  t_planpaymid="+ppaymentid+" and  t_factpaymid="+fpaymentid+" and t_kvitamount="+Money(factsum);
             rs21 = LnGetRecordSet(que);
             if(rs21 != null)
                if (rs21.moveNext) 
                   if ( rs21.value(0) == 0 )
                     InsKvit(ndealid, ppaymentid,fpaymentid, Money(factsum), UNSET_CHAR); 
                   end;
                end;
             end;
             // --

        end;
       end;
                          end;



     end;
   end;

                  


END;



MACRO Prez()

   private var que,rs,ndealid,ntip,rs50,rs55,rs21,npaym,paym2,delta,sclient,snalog,acc1,acc2,nval,d0,baseamount, ppaymentid,fpaymentid, factsum;
   d0={curdate};
     que="select c.t_dealid,a.t_purpose purpose, c.t_dealcode dealcode,a.t_baseamount amount,e.t_shortname , a.t_paymentid paymentid, c.t_dealtype dealtype, d.t_pfi pfi   from  ddl_tick_dbt c, ddl_leg_dbt d, dparty_dbt e , dpmpaym_dbt a where c.t_dealtype !=12310 and  c.t_dealtype !=12335 and   c.t_dealstatus < 20 and  c.t_bofficekind=102 ";
     que=que+ " and d.t_dealid=c.t_dealid and d.t_legid=1  and e.t_partyid=c.t_partyid  and a.t_dockind=102 and a.t_documentid=c.t_dealid  and a.t_purpose < 11   and a.t_receiver=1 and  a.t_paymstatus< 32000 and a.t_paymstatus != 55   and a.t_valuedate='"+d0+"'  order by c.t_dealdate, c.t_dealid ";
     rs = LnGetRecordSet(que);
     if(rs != null)
        while(rs.moveNext())
          ndealid=int(rs.value(0));
          nval=int(rs.value("pfi"));
          ntip=rs.value(1);
          npaym= rs.value("paymentid");
          baseamount=rs.value("amount");
          delta=0.0;
          if ( ntip == 11)
               sclient=MM_tickid2(ndealid,"partyid");
               snalog=MM_nalog2(sclient);
               if (snalog > 0 )
                 delta=(rs.value("amount")*snalog/100);
               else
                 delta=0.0;
               end;
          end;


            if ( rs.value("purpose") == 11 ) 
        if ( rs.value("dealtype") == 12300 ) 
          acc1 =MM_account(ndealid,118);
        else
          acc1 =MM_account(ndealid,117);
        end;

            else
              acc1 =MM_account(ndealid,111);
            end;

       if ( nval > 0 )
        que="update dpmpaym_dbt set t_receiveraccount='"+acc1+"' where t_paymentid="+npaym;
        rs21 = LnGetRecordSet(que);
       end;

 
       que= "select b.t_paymentid,bb.t_paymentid, b.t_baseamount, bb.t_paymstatus sta  from ddl_tick_dbt a , dpmpaym_dbt b,dpmpaym_dbt bb where a.t_dealid="+ndealid+" and b.t_dockind=102 and b.t_documentid=a.t_dealid ";
       que=que+" and b.t_paymstatus < 32000  and b.t_purpose="+ntip+" and b.t_valuedate='"+d0+"'  and bb.t_dockind=322 and bb.t_fiid=b.t_fiid ";
       que=que+" and bb.t_baseamount=b.t_baseamount-"+delta+" and bb.t_receiveraccount=b.t_receiveraccount and  bb.t_valuedate= b.t_valuedate ";

       // msgbox(que);
       rs55 = LnGetRecordSet(que);
       if(rs55 != null)
        if (rs55.moveNext) 

             ppaymentid=rs55.value(0);
             fpaymentid=rs55.value(1);
             factsum = rs55.value(2);

             if ( rs55.value("sta") == 2990 )
              que="update dpmpaym_dbt set t_paymstatus=2995, t_tobackoffice='J' where t_paymentid="+fpaymentid;
              rs21 = LnGetRecordSet(que);
             end;
             // --
             que="select count(*) from dmm_kvit_tmp where  t_planpaymid="+ppaymentid+" and  t_factpaymid="+fpaymentid+" and t_kvitamount="+Money(factsum);
             rs21 = LnGetRecordSet(que);
             if(rs21 != null)
                if (rs21.moveNext) 
                   if ( rs21.value(0) == 0 )
                     InsKvit(ndealid, ppaymentid,fpaymentid, Money(factsum), UNSET_CHAR); 
                   end;
                end;
             end;
             // --
        end;
       end;



     end;
   end;

                  


END;




MACRO GetBackOfficeName()
    VAR name : string = "";

    VAR cmd, rs;

    cmd = RsdCommand("SELECT * FROM dtypeac_dbt WHERE t_inumtype = 32 AND t_type_account = ?");

    cmd.addParam("", RSDBP_IN, StrFor(GetIdentProgram()));

    rs = RsdRecordset(cmd);

    IF(rs.MoveNext())
        name = rs.value("t_name_type");
    END;

    RETURN name;
END;

MACRO FillData()
    VAR cmd, rs, i;
    VAR SqlQuery = string("SELECT k.t_planpaymid          AS PlanID,       "
                          "       tick.t_dealcode         AS DealCode,     "
                          "       p_p.t_valuedate         AS PlanDate,     "
                          "       p_p.t_amount            AS PlanAmount,   "
                          "       NVL(fi_p.t_ccy, ' ')    AS PlanCurrency, "
                          "       k.t_factpaymid          AS FactID,       "
                          "       p_f.t_valuedate         AS FactDate,     "
                          "       p_f.t_amount            AS FactAmount,   "
                          "       NVL(fi_f.t_ccy, ' ')    AS FactCurrency, "
                          "       k.t_kvitamount          AS Amount,       "
                          "       k.t_auto                AS Auto,         "
                          "       k.t_stat                AS Stat,         "
                          "       msg.t_contents          AS Notice        "
                          "  FROM dmm_kvit_tmp k,                          "
                          "       dpmpaym_dbt p_p,                         "
                          "       dpmpaym_dbt p_f,                         "
                          "       ddl_tick_dbt tick,                       "
                          "       dfininstr_dbt fi_p,                      "
                          "       dfininstr_dbt fi_f,                      "
                          "       dbank_msg msg                            "
                          " WHERE k.t_planpaymid = p_p.t_paymentid         "
                          "   AND k.t_factpaymid = p_f.t_paymentid         "
                          "   AND fi_p.t_fiid(+) = p_p.t_fiid              "
                          "   AND fi_f.t_fiid(+) = p_f.t_fiid              "
                          "   AND k.t_dealid     = tick.t_dealid           "
                          "   AND k.t_stat(+)    = msg.t_number            ");
                          
    cmd = RsdCommand(SqlQuery);

    rs = RsdRecordset(cmd);
    WHILE(rs.MoveNext())
        IF (rs.value("Auto") == "X")
            IF (rs.value("Stat"))
                i = KvitFailArray.size;

                KvitFailArray[i] = KvitPair;

                KvitFailArray[i].PlanID       = rs.value("PlanID");
                KvitFailArray[i].DealCode     = rs.value("DealCode");
                KvitFailArray[i].PlanDate     = rs.value("PlanDate");
                KvitFailArray[i].PlanAmount   = rs.value("PlanAmount");
                KvitFailArray[i].PlanCurrency = rs.value("PlanCurrency");
                KvitFailArray[i].FactID       = rs.value("FactID");
                KvitFailArray[i].FactDate     = rs.value("FactDate");
                KvitFailArray[i].FactAmount   = rs.value("FactAmount");
                KvitFailArray[i].FactCurrency = rs.value("FactCurrency");
                KvitFailArray[i].Notice       = rs.value("Notice");
            ELSE
                i = KvitSuccessArray.size;

                KvitSuccessArray[i] = KvitPair;

                KvitSuccessArray[i].PlanID       = rs.value("PlanID");
                KvitSuccessArray[i].DealCode     = rs.value("DealCode");
                KvitSuccessArray[i].PlanDate     = rs.value("PlanDate");
                KvitSuccessArray[i].PlanAmount   = rs.value("PlanAmount");
                KvitSuccessArray[i].PlanCurrency = rs.value("PlanCurrency");
                KvitSuccessArray[i].FactID       = rs.value("FactID");
                KvitSuccessArray[i].FactDate     = rs.value("FactDate");
                KvitSuccessArray[i].FactAmount   = rs.value("FactAmount");
                KvitSuccessArray[i].FactCurrency = rs.value("FactCurrency");
                KvitSuccessArray[i].Amount       = rs.value("Amount");
            END;
        END;
    END;
END;

MACRO PrintHeaderSuccess()
[1.Сквитованные платежи];
[+-----------------------------------------------------------------+----------------------------------------------------+----------------+];
[|                   Параметры планового платежа                   |           Параметры фактического платежа           |  Сквитованная  |];
[+------------+------------+--------------+---------------+--------+------------+--------------+---------------+--------+                +];
[|  ID плат.  |  № сделки  |     Дата     |     Сумма     | Валюта |  ID плат.  |     Дата     |     Сумма     | Валюта |     сумма      |];
[+------------+------------+--------------+---------------+--------+------------+--------------+---------------+--------+----------------+];
END;

MACRO PrintMainSuccess(obj)
[| ########## | ########## | ############ | ############# | ###### | ########## | ############ | ############# | ###### | ############## |]
(   obj.PlanID:l,
    obj.DealCode:l,
    obj.PlanDate:c,
    obj.PlanAmount:r,
    obj.PlanCurrency:c,
    obj.FactID:l,
    obj.FactDate:c,
    obj.FactAmount:r,
    obj.FactCurrency:c,
    obj.Amount:r);
[+------------+------------+--------------+---------------+--------+------------+--------------+---------------+--------+----------------+];
END;

MACRO PrintHeaderPair()
[3.Несквитованные пары платежей];
[+-----------------------------------------------------------------+----------------------------------------------------+--------------------------------------------------------------------+];
[|                   Параметры планового платежа                   |           Параметры фактического платежа           |                          Примечание                                |];
[+------------+------------+--------------+---------------+--------+------------+--------------+---------------+--------+                                                                    +];
[|  ID плат.  |  № сделки  |     Дата     |     Сумма     | Валюта |  ID плат.  |     Дата     |     Сумма     | Валюта |                                                                    |];
[+------------+------------+--------------+---------------+--------+------------+--------------+---------------+--------+--------------------------------------------------------------------+];
END;

MACRO PrintMainPair(obj)
[| ########## | ########## | ############ | ############# | ###### | ########## | ############ | ############# | ###### | #                                                                  |]
(   obj.PlanID:l,
    obj.DealCode:l,
    obj.PlanDate:c,
    obj.PlanAmount:r,
    obj.PlanCurrency:c,
    obj.FactID:l,
    obj.FactDate:c,
    obj.FactAmount:r,
    obj.FactCurrency:c,
    obj.Notice:l);
[+------------+------------+--------------+---------------+--------+------------+--------------+---------------+--------+--------------------------------------------------------------------+];
END;

MACRO PrintHeaderFail()
[2.Несквитованные платежи];
[+-----------------------------------------------------------------+---------------------------------------------------------------------+];
[|                   Параметры планового платежа                   |                             Примечание                              |];
[+------------+------------+--------------+---------------+--------+                                                                     +];
[|  ID плат.  |  № сделки  |     Дата     |     Сумма     | Валюта |                                                                     |];
[+------------+------------+--------------+---------------+--------+---------------------------------------------------------------------+];
END;

MACRO PrintMainFail(obj)
[| ########## | ########## | ############ | ############# | ###### | ################################################################### |]
(   obj.PlanID:l,
    obj.DealCode:l,
    obj.PlanDate:c,
    obj.PlanAmount:r,
    obj.PlanCurrency:c,
    obj.Notice:l);
[+------------+------------+--------------+---------------+--------+---------------------------------------------------------------------+];
END;

MACRO prep()
    //dialog_flag = SetDialogFlag(0);   
    ClearKvit();

    var stat = execStoredFunc("RSI_MMARK.FillKvitTmp", V_INTEGER,
        makeArray(
            SQLParam("", 0),
            SQLParam("", 0),
            SQLParam("", {curdate}),
            SQLParam("", 0)
        )
    );

    P107();
    Pnal();
    Prez();
    Pfiid();


    //Prnt();
END;

MACRO post()
    FillData();
    
    [Протокол выполнения автоквитовки платежей.];
    [Бэк-офис: #](GetBackOfficeName():l);
    [Дата операции: #]({curdate}:l);
    PrintLn();
    IF (KvitSuccessArray.size)
        PrintHeaderSuccess();
        FOR (VAR SuccessKvit, KvitSuccessArray)
            PrintMainSuccess(SuccessKvit);
        END;
        PrintLn();
    END;

    IF (KvitFailArray.size)
        PrintHeaderPair();
        FOR (VAR FailKvit, KvitFailArray)
            PrintMainPair(FailKvit);
        END;
        PrintLn();
    END;

    ClearKvit();

    IF ((KvitSuccessArray.size == 0) AND (KvitFailArray.size == 0))
        PrintLn("Не найдены платежи для квитовки.");
    END;

    //SetDialogFlag(dialog_flag);
    //exit(1);
END;
