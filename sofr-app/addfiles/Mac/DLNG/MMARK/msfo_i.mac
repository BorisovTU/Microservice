/*
$Name:        msfo_i.mac
$Module:      МБ Кредиты
$Description: API-функции межбанковского кредитования
*/

import RsbDataSet, RSD, mmcnst_j, mmlibr, PTInter, FIInter, globals, or_exl_h, mmlb_j, mmlib, mmcateg, msfo_mmupgrdlib;

PRIVATE VAR prdClient    = TBfile ("prdclient.dbt", "W", 0);
PRIVATE VAR prdClientObj = TBfile ("prdclientobj.dbt", "W", 0);
PRIVATE VAR prdClntRole  = TBfile ("prdclntrole.dbt", "W", 0);
PRIVATE VAR tick         = TBfile ("dl_tick.dbt", "W", 0);
PRIVATE VAR prdkind_obj  = TBfile ("prdkind_obj.dbt", "W", 0);

MACRO ExecuteStep(Buffer, Document)
   record deal(dl_tick);
   SetBuff(deal, Document);

   var ExecDate = {curdate}; // Как дату передать ?

   var stat, flag, bankProductID = 0;
   
   GetRegistryValue("MMARK\\ОБЩИЕ\\БАНКОВСКИЕ_ПРОДУКТЫ",
                    V_BOOL, flag, stat);

   if (not flag)
      return 0;
   end;

   if( isSale( getOperationGroup( deal.DealType ) ) and (not stat))
      GetRegistryValue("MMARK\\ОБЩИЕ\\БАНКОВСКИЕ_ПРОДУКТЫ\\РАЗМЕЩЕНИЕ",
                    V_INTEGER, bankProductID, stat);
   else
      GetRegistryValue("MMARK\\ОБЩИЕ\\БАНКОВСКИЕ_ПРОДУКТЫ\\ПРИВЛЕЧЕНИЕ",
                    V_INTEGER, bankProductID, stat);   
   end;

   if (stat)
      mm_error("Ошибка при получении значения ключа реестра");
      return 1;
   end;

   prdkind_obj.rec.ProductKindID = 54;
   prdkind_obj.rec.ObjectProductKindID = 1;
   if (prdkind_obj.GetEQ())
      prdClientObj.rec.ObjectType = 
      prdClient.rec.ObjectType    = prdkind_obj.rec.ObjectType;
   end;

   prdClient.rec.PartyID   = deal.PartyID;
   prdClient.rec.ProductID = bankProductID;
   prdClient.rec.Branch    = deal.Department;
   prdClient.rec.ObjectID  =
   prdClient.rec.DocNumber = deal.DealCode;
   prdClient.rec.BeginDate =
   prdClient.rec.DocDate   = deal.DealDate;
   prdClient.rec.SfContrID = 0;
   prdClient.rec.IsDraft   =
   prdClient.rec.IsClosed  = "";

   if (prdClient.Insert())
      prdClntRole.rec.ClientProductID = prdClient.rec.ClientProductID;
      prdClntRole.rec.ClntProdObjID   = 0;
      prdClntRole.rec.PartyID         = deal.PartyID;
      prdClntRole.rec.Role            = 6;
      prdClntRole.rec.Use             = 4;
      prdClntRole.Insert();

   else
      mm_error("Не удалось добавить информацию о банковском продукте");
      return 1;
   end;

   tick.rec.DealID = deal.DealID;
   if (tick.GetEQ())
      tick.rec.Product = prdClntRole.rec.ClientProductID;
      if ( not tick.Update())
        mm_error("Не удалось обновить сделку");
        return 1;  
      end;
   else
      mm_error("Сделка не найдена");
      return 1;  
   end;

   prdClientObj.rec.ClientProductID = prdClntRole.rec.ClientProductID;
   prdClientObj.rec.ObjectID      =
   prdClientObj.rec.ObjectNumber  = deal.DealCode;
   prdClientObj.rec.BeginDate     = deal.DealDate;
   prdClientObj.rec.ProductKindID = 54;
   prdClientObj.rec.ObjectProductKindID = 1;

   prdClientObj.Insert();

   RETURN 0;
END;
