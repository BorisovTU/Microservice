/*-------------------------------------------------------------------------
          Автоматизированная банковская система RS-Bank v5.1
                 Copyright (c) R-Style Software Lab

  Имя файла        : mmmsetsc.mac

  Описание         : макрос выполнения шага "Оформление обеспечения?"

  Программист      : AG

  Создан           : 20.2.2003
-------------------------------------------------------------------------*/
import MMarkInter, mmlibr,funk;

private const SET_CHAR = "X";

RECORD tick("dl_tick");

MACRO GetFlagSecur( DealID )
private var que,rs01;
var grnt = TBFile("dl_grnt"), ordr = TBFile("dl_order"), stat;

/*
   grnt.KeyNum = 0;
   grnt.rec.DealID = tick.DealID;
   grnt.rec.ContractID = 0;
   stat = grnt.GetGT;
   while( stat )
       if( grnt.rec.DealID != tick.DealID )
           stat = 0;
       else
           ordr.KeyNum = 0;
           ordr.rec.ContractID = grnt.rec.ContractID;
           if( ordr.GetEQ )
               if( ordr.rec.Flag1 != SET_CHAR ) 
	           return true;
               end
           end;
           stat = grnt.next;
           if( grnt.rec.DealID != tick.DealID )
               stat = false;
           end
       end
   end;    
*/


  que="select count(*) from ddl_grnt_dbt where t_dealid="+DealID;
  rs01 = LnGetRecordSet(que);
  if(rs01 != null)
    if(rs01.moveNext) 
      if (rs01.value(0) > 0)
          return true;
      end;
    end;
  end;
   
   return false;
END;

MACRO ExecuteCaseStep(OperationKind, StepNumber, Document, DocKind)

   SetBuff( tick, Document );

   if( GetFlagSecur( tick.DealID) )
       return "60";   /* Обеспечение сделки */
   end;

   if ( tick.dealtype == 12306 )
 //    return "80";   /* Закрытие */
   end;

   if ( tick.dealtype == 12305 ) 
     return "80";   
   end;

   if ( tick.dealtype == 12300 )
     return "75";   
   end;


   return "90";   /* Закрытие */
END;

NameMacroFile = "mmsetsc.mac";


