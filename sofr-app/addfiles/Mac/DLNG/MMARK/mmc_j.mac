/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 5.1                                          R-Style Software Lab

  File Name   : mmс_o.mac
  Programmer  : Сабитов Р.Р.
  Description : Обработка платежа
  Comment     : 
  Leplin  04/05/2018 SubordDeposit LKL underconstruction   
└───────────────────────────────────────────────────────────────────────────*/
IMPORT globals,OprInter,mmcnst_j,mmlibr,dl_mm135,dl_lib,dl_mm57;

/*----------------------------------------------------------------------------
    Выполнение шага "Закрытие"
----------------------------------------------------------------------------*/
MACRO ExecuteStep(Buffer, Document)
    record tick( dl_tick );

    SetBuff( tick, Document );

    private var d_curdate={curdate},ssta=0,deal_pd,da,sta1,sta2,plid;
    FILE leg (dl_leg); 
    leg.LegKind = LEG_KIND_DL_TICK;
    leg.DealID = tick.DealID;
    leg.LegID = 1;


    if (not GetEq(leg))
        mm_error ("Не найдены параметры сделки");
        return 1;
    end;

    da=DAT(plat_zak(tick.dealid,"102","10",0,"valuedate"));

    if ( d_curdate <  da )
      msgbox("Для досрочного погашения требуется установить признак ! ");
      return 1;
    end;

    if ( tick.dealtype == 12306 )

      if (tick.NUMBERPACK == 390 )
      else
       ExStep(Buffer, Document);
       return 0;
      end;
    end;



    if ( tick.dealtype == 12300 )
//       Ex(tick.dealid,da);
       sta1=plat_zak(tick.dealid,"102","10",0,"paymstatus");
       if (( sta1 == 32000 ) or ( sta1 == 55 )) 
       else
              	  if(GetTrue(true, "Исполнен платеж по ОД ?"))
                    plid=plat_zak(tick.dealid,"102","10",0,"paymentid");
                    if(not InsertPaymentStat (plid, PM_FINISHED))
                         MsgBox("Ошибка установки статуса платежа - Закрыт.");
                    end;


              	  else
              	      return 1;
              	  end;
       end;

       sta2=plat_zak(tick.dealid,"102","11",1,"paymstatus");
       if (( sta2 == 32000 ) or ( sta2 == 55 )) 
       else
              	  if(GetTrue(true, "Исполнен платеж по %% ?"))
                    plid=plat_zak(tick.dealid,"102","11",1,"paymentid");
                    if(not InsertPaymentStat (plid, PM_FINISHED))
                       MsgBox("Ошибка установки статуса платежа - Закрыт.");
                    end;

              	  else
              	     return 1;
              	  end;
       end;




    elif (( tick.dealtype == 12305 ) or  ( tick.dealtype == 12306 ))
       sta1=plat_zak(tick.dealid,"102","10",0,"paymstatus");
       if (( sta1 == 32000 ) or ( sta1 == 55 )) 
       else
         msgbox("Не исполнен платеж ОД !");
         return 1;
       end;
       sta2=plat_zak(tick.dealid,"102","11",1,"paymstatus");
       if (( sta2 == 32000 ) or ( sta2 == 55 )) 
       else
         msgbox("Не исполнен платеж %% !");
         return 1;
       end;

    end;




    if ((Index(tick.usertypedoc, MM_USER_TYPE_SUBORDDEPOSIT) > 0 ) and (leg.Maturity > d_curdate) )  //LKL MM_USER_TYPE_SUBORDDEPOSIT - Заведен пользовательский тип сделки и определен в mmlibr.mac /* and  условие досрочного закрытия*/

	if (execmacrofile("make_note_101.mac", "makenote", tick.dealid) == 1)
		return 1;
	end;
		
    end; 
//~LKL
    //  return ssta;
    // return 0;
      return ЗакрытьСделку( tick );  //SVE
END;

NameMacroFile = "mmc_j.mac";
