/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.0                                          R-Style Software Lab
  Файл подсистемы "МБК"

  Печать отчета "Реестр сделок денежного рынка (МБК)" (RDTTMM010).
  RSForms вариант.

  CREATED : 22.08.05
  Ограничения: - предполагается, что dl_leg->Duration измеряется в днях
                 (т.е., dl_leg->Pitch == PITCH_DAYS)
└───────────────────────────────────────────────────────────────────────────*/

import RSForms, RsbObjFactory, RsbDataSet, DealsInter, dlreport;

/*{{DESIGNER_HEADERS()*/
/*DESIGNER_HEADERS()}}*/


/* Параметры настройки отчета */
PRIVATE VAR
_DealStatus = DL_UNDEFSTAT, // статус сделок для отбора
_PortfGroupID = 0, _PortfAttrID = 0, // портфель
_CategGroupID = 0, _CategAttrID = 0, // категория к.агента
_weightingR = "V",           /* Способ взвешивания при усреднении ставки */
_weightingD = "V",           /* Способ взвешивания при усреднении срока */
_header     = TRUE,          /* ?Печатать заголовок отчета */
_statistics = TRUE,          /* ?Печатать статистику */
_aggregates = TRUE,          /* ?Печатать агрегаты */
_signatures = TRUE,          /* ?Печатать подписи */
_roll       = TRUE;          /* ?Печатать реестр */

private macro MyMsg( sender, text, p1 )
  MsgBox( sender, " -> '", text, "''", p1, "'" );
//    println( sender, " -> ", text, p1 );
end;

/* ------------------------------------------------------------------------- */
PRIVATE MACRO getNameOper
   var pers = TRsbDataSet("select t_Name from dperson_dbt where t_Oper = " + {oper});

   if( pers.MoveNext )
      return pers.Name;
   end;

   return "";
END;
/* ------------------------------------------------------------------------- */

PRIVATE MACRO to_date( _date:date )            
   if( _date != Date(0,0,0) )
      return "TO_DATE( '" + string(_date) + "', 'DD.MM.YYYY' )"; 
   else
      return "TO_DATE( '" + "1.1.1" + "', 'DD.MM.YYYY' )"; 
   end;
end;


PRIVATE MACRO getObjAttrName( ObjectType, GroupID, AttrID )
   var objattr;
   
   if((ObjectType == 0) or (GroupID == 0) or (AttrID == 0))
      return "Все";
   end;
   
   objattr = TRsbDataSet("select t_Name from dobjattr_dbt " +
                            "where t_ObjectType = " + ObjectType +
                             " and t_AttrID = " + GroupID +
                             " and t_GroupID = " + AttrID);
   if( objattr.MoveNext )
      return objattr.Name;
   end;

   return "Все";
END;

PRIVATE MACRO AddPortfel(sqlfrom:@string, sqlwhere:@string)
   if((_PortfGroupID == 0) or (_PortfAttrID == 0))
      return;
   end;

   sqlfrom = sqlfrom + ", dobjatcor_dbt acor1 ";
   sqlwhere = sqlwhere + " and acor1.t_Object = tick.t_DealID " + 
                         " and acor1.t_AttrID = " + _PortfAttrID +
                         " and acor1.t_GroupID = " + _PortfGroupID +
                         " and acor1.t_ObjectType = " + OBJTYPE_MMARKDEAL +
                         " and acor1.t_ValidFromDate <= tick.t_DealDate" +
                         " and acor1.t_ValidToDate   >= tick.t_DealDate";
END;

PRIVATE MACRO AddContrCateg(sqlfrom:@string, sqlwhere:@string)
   if((_CategGroupID == 0) or (_CategAttrID == 0))
      return;
   end;

   sqlfrom = sqlfrom + ", dobjatcor_dbt acor2, dparty_dbt party ";
   sqlwhere = sqlwhere + " party.t_PartyID = tick.t_PartyID " +
                     " and acor2.t_Object = party.t_PartyID " +
                     " and acor2.t_ObjectType = " + OBJTYPE_PARTY +
                     " and acor2.t_AttrID = " + _CategAttrID +
                     " and acor2.t_GroupID = " + _CategGroupID +
                     " and acor2.t_ValidFromDate <= tick.t_DealDate" +
                     " and acor2.t_ValidToDate   >= tick.t_DealDate";
END;

PRIVATE MACRO AddDealStatus(sqlwhere:@string)
  if(_DealStatus == DL_UNDEFSTAT)
  elif(_DealStatus == DL_OPENCLOSED)
     sqlwhere = sqlwhere + " AND tick.t_DealStatus > " + DL_PREPARING;
  else
     sqlwhere = sqlwhere + " AND tick.t_DealStatus = " + _DealStatus;
  end;
END;


PRIVATE MACRO MakeQuery(fiid, dealdate)
var sqltext = "select "
                 " NVL(sum(t_Principal), 0) psum,"
                 " NVL(max(t_Principal), 0) msum,"
                 " NVL(sum(t_Cost), 0) sCost,"
                 " NVL(max(t_Price / POWER(10, t_Point)), 0) maxRate,"
                 " NVL(min(t_Price / POWER(10, t_Point)), 0) minRate, "
                 " NVL(sum(t_Principal * t_duration), 0) pr_du,"
                 " NVL(sum(t_Principal * (t_Price / POWER(10, t_Point))), 0) pr_ra,"
                 " NVL(sum(t_Principal * t_duration * (t_Price / POWER(10, t_Point))), 0) pr_du_ra, "
                 " NVL(count(tick.t_dealid), 0) num_deals ",
    sqlfrom  = " from ddl_tick_dbt tick, ddl_leg_dbt leg, doprkoper_dbt o  ",
    sqlwhere = " where t_bofficekind = 102"
                 " and tick.T_DEALID = leg.T_DEALID and t_legkind = 0"
                 " and o.t_kind_operation = tick.t_DealType"
                 " and t_pfi = " + fiid;
//    buying  = " and SubStr(o.t_systypes, 2, 1) = 'B' ", // привлечение
//    selling = " and SubStr(o.t_systypes, 2, 1) = 'S' "; // размещение
    if((ValType(dealdate) !=  V_UNDEF) AND (dealdate > date(0,0,0)))
       sqlwhere = sqlwhere + " AND t_DealDate = " + to_date(dealdate);
    end;

    AddDealStatus(@sqlwhere); // статус сделки

    AddPortfel(@sqlfrom, @sqlwhere);
    AddContrCateg(@sqlfrom, @sqlwhere);

    return sqltext + sqlfrom + sqlwhere;
END;


class (TControl)TStatisticsRepTbl(owner:object, name:string)
   InitTControl(owner,name);

    // Заполнение содержимого
    macro Fill( fiid, dealdate )
        var l_line, PutSet, CallSet,
            sqltext = MakeQuery(fiid),
            buying  = " and SubStr(o.t_systypes, 2, 1) = 'B' ", // привлечение
            selling = " and SubStr(o.t_systypes, 2, 1) = 'S' "; // размещение

        PutSet = TRsbDataSet(sqltext + selling);
        CallSet = TRsbDataSet(sqltext + buying);
    
        if(PutSet.MoveNext and CallSet.MoveNext)
    
            l_line = AddLine( "Row" );
            l_line.Line( "Row11" ).Cell( "ColGroup.ColPut" ).Value = round(PutSet.psum, 2);
            l_line.Line( "Row11" ).Cell( "ColGroup.ColCall" ).Value = round(CallSet.psum, 2);
            l_line.Line( "Row12" ).Cell( "ColGroup.ColPut" ).Value = round(PutSet.msum, 2);
            l_line.Line( "Row12" ).Cell( "ColGroup.ColCall" ).Value = round(CallSet.msum, 2);

            l_line.Line( "Row20" ).Cell( "ColGroup.ColPut" ).Value = round(PutSet.sCost, 2);
            l_line.Line( "Row20" ).Cell( "ColGroup.ColCall" ).Value = round(CallSet.sCost, 2);

            if(PutSet.psum != 0)
               l_line.Line( "Row31" ).Cell( "ColGroup.ColPut" ).Value = round(PutSet.pr_ra / PutSet.psum, 2);
            else
               l_line.Line( "Row31" ).Cell( "ColGroup.ColPut" ).Value = 0;
            end;
            if(CallSet.psum != 0)
               l_line.Line( "Row31" ).Cell( "ColGroup.ColCall" ).Value = round(CallSet.pr_ra / CallSet.psum, 2);
            else
               l_line.Line( "Row31" ).Cell( "ColGroup.ColCall" ).Value = 0;
            end;
            if(PutSet.pr_du != 0)
               l_line.Line( "Row32" ).Cell( "ColGroup.ColPut" ).Value = round(PutSet.pr_du_ra / PutSet.pr_du, 2);
            else
               l_line.Line( "Row32" ).Cell( "ColGroup.ColPut" ).Value = 0;
            end;
            if(CallSet.pr_du != 0)
               l_line.Line( "Row32" ).Cell( "ColGroup.ColCall" ).Value = round(CallSet.pr_du_ra / CallSet.pr_du, 2);
            else
               l_line.Line( "Row32" ).Cell( "ColGroup.ColCall" ).Value = 0;
            end;
            l_line.Line( "Row33" ).Cell( "ColGroup.ColPut" ).Value = round(PutSet.minRate, 2);
            l_line.Line( "Row33" ).Cell( "ColGroup.ColCall" ).Value = round(CallSet.minRate, 2);
            l_line.Line( "Row34" ).Cell( "ColGroup.ColPut" ).Value = round(PutSet.maxRate, 2);
            l_line.Line( "Row34" ).Cell( "ColGroup.ColCall" ).Value = round(CallSet.maxRate, 2);

            if(PutSet.psum != 0)
               l_line.Line( "Row41" ).Cell( "ColGroup.ColPut" ).Value = round(PutSet.pr_du / PutSet.psum, 2);
            else
               l_line.Line( "Row41" ).Cell( "ColGroup.ColPut" ).Value = 0;
            end;
            if(CallSet.psum != 0)
               l_line.Line( "Row41" ).Cell( "ColGroup.ColCall" ).Value = round(CallSet.pr_du / CallSet.psum, 2);
            else
               l_line.Line( "Row41" ).Cell( "ColGroup.ColCall" ).Value = 0;
            end;
            if(PutSet.pr_ra != 0)
               l_line.Line( "Row42" ).Cell( "ColGroup.ColPut" ).Value = round(PutSet.pr_du_ra / PutSet.pr_ra, 2);
            else
               l_line.Line( "Row42" ).Cell( "ColGroup.ColPut" ).Value = 0;
            end;
            if(CallSet.pr_ra != 0)
               l_line.Line( "Row42" ).Cell( "ColGroup.ColCall" ).Value = round(CallSet.pr_du_ra / CallSet.pr_ra, 2);
            else
               l_line.Line( "Row42" ).Cell( "ColGroup.ColCall" ).Value = 0;
            end;

            l_line.Line( "Row50" ).Cell( "ColGroup.ColPut" ).Value = PutSet.num_deals;
            l_line.Line( "Row50" ).Cell( "ColGroup.ColCall" ).Value = CallSet.num_deals;
            
        end;

//    onerror
//       MyMsg( 0, "Statistics.StatisticsTable.Fill aborted", "" );
    end;

end;


/*{{DESIGNER_CLASS_RSL_TSTATISTICS()*/
class (TForm)TStatistics(owner:object, name:string)
/*DESIGNER_CLASS_RSL()}}*/

/*{{DESIGNER_CONSTRBASE_RSL_TSTATISTICS()*/
   InitTForm(owner,name);
/*DESIGNER_CONSTRBASE_RSL()}}*/
/*{{DESIGNER_VAL_RSL_TSTATISTICS(StatisticsTable,StatisticsFIID,LabelFIID)*/
   var StatisticsTable = TStatisticsRepTbl(this, "StatisticsTable");
   var StatisticsFIID = TControl(this, "FIID");
   var LabelFIID = TControl(this, "LabelFIID");
/*DESIGNER_VAL_RSL()}}*/

/*{{DESIGNER_CMD_SET_RSL_TSTATISTICS()*/
/*DESIGNER_CMD_SET_RSL()}}*/

/*{{DESIGNER_HANDLERS_ADD_RSL_TSTATISTICS()*/
/*DESIGNER_HANDLERS_ADD_RSL()}}*/

/*{{DESIGNER_HANDLERS_RSL_TSTATISTICS()*/
/*DESIGNER_HANDLERS_RSL()}}*/

end;


/*{{DESIGNER_CLASS_RSL_TFOOTER()*/
class (TForm)TFooter(owner:object, name:string)
/*DESIGNER_CLASS_RSL()}}*/

/*{{DESIGNER_CONSTRBASE_RSL_TFOOTER()*/
   InitTForm(owner,name);
/*DESIGNER_CONSTRBASE_RSL()}}*/
/*{{DESIGNER_VAL_RSL_TFOOTER(FIO3,FIO2,FIO1)*/
   var FIO3 = TControl(this, "FIO3");
   var FIO2 = TControl(this, "FIO2");
   var FIO1 = TControl(this, "FIO1");
/*DESIGNER_VAL_RSL()}}*/

/*{{DESIGNER_CMD_SET_RSL_TFOOTER()*/
/*DESIGNER_CMD_SET_RSL()}}*/

/*{{DESIGNER_HANDLERS_ADD_RSL_TFOOTER()*/
/*DESIGNER_HANDLERS_ADD_RSL()}}*/

/*{{DESIGNER_HANDLERS_RSL_TFOOTER()*/
/*DESIGNER_HANDLERS_RSL()}}*/

end;


/*{{DESIGNER_CLASS_RSL_THEADER()*/
class (TForm)THeader(owner:object, name:string)
/*DESIGNER_CLASS_RSL()}}*/

/*{{DESIGNER_CONSTRBASE_RSL_THEADER()*/
   InitTForm(owner,name);
/*DESIGNER_CONSTRBASE_RSL()}}*/
/*{{DESIGNER_VAL_RSL_THEADER(DealDate,FIID,Category,Briefcase)*/
   var DealDate = TControl(this, "DealDate");
   var FIID = TControl(this, "FIID");
   var Category = TControl(this, "Category");
   var Briefcase = TControl(this, "Briefcase");
/*DESIGNER_VAL_RSL()}}*/

/*{{DESIGNER_CMD_SET_RSL_THEADER()*/
/*DESIGNER_CMD_SET_RSL()}}*/

/*{{DESIGNER_HANDLERS_ADD_RSL_THEADER()*/
/*DESIGNER_HANDLERS_ADD_RSL()}}*/

/*{{DESIGNER_HANDLERS_RSL_THEADER()*/
/*DESIGNER_HANDLERS_RSL()}}*/

end;


/*{{DESIGNER_CLASS_RSL_TMMTEMPL1()*/
class (TReport)TMMTEMPL1(group:TReportsGroup, FIID, _dealdate)
/*DESIGNER_CLASS_RSL()}}*/
var m_dealdate:date = _dealdate,
    m_fiid = FIID;

/*{{DESIGNER_CONSTRBASE_RSL_TMMTEMPL1()*/
   InitTReport();
/*DESIGNER_CONSTRBASE_RSL()}}*/
   setTemplate("deals2.lbr", "MMTEMPL1");

/*{{DESIGNER_VAL_RSL_TMMTEMPL1(Header,ReportTable,Footer,Statistics)*/
   var Header = THeader(this, "Header");
   var ReportTable = TControl(this, "ReportTable");
   var Footer = TFooter(this, "Footer");
   var Statistics = TStatistics(this, "Statistics");
/*DESIGNER_VAL_RSL()}}*/

/*{{DESIGNER_CMD_SET_RSL_TMMTEMPL1()*/
/*DESIGNER_CMD_SET_RSL()}}*/

/*{{DESIGNER_HANDLERS_ADD_RSL_TMMTEMPL1(Print_Template_OnLoad,Print_Template_OnGetContents)*/
   addHandler(-2147385343, R2M(this, "Print_Template_OnLoad"));
   addHandler(4, R2M(this, "Print_Template_OnGetContents"));
/*DESIGNER_HANDLERS_ADD_RSL()}}*/

   Create(group);

   var m_RmmDeal = RsbObjectFactory.GetObject("RmmDeal2");

   macro FillTable()
      var l_row, l_tbl = TReportTable(),
          filter_str = "",
          PutSet, CallSet, ok1, ok2,
          sqltext = MakeQuery(m_fiid, m_dealdate),
          buying  = " and SubStr(o.t_systypes, 2, 1) = 'B' ", // привлечение
          selling = " and SubStr(o.t_systypes, 2, 1) = 'S' "; // размещение

      if(not _aggregates)
         ReportTable.Line("SellingCost").Show = false;
         ReportTable.Line("BuyingCost").Show = false;
      end;
      PutElement(ReportTable, l_tbl);
      // Фильтр по ФИ
      filter_str = "CreditFI = " + m_fiid;
      // Фильтр по дате сделки
      if(m_dealdate > date(0,0,0))
         filter_str =  filter_str + " and DealDate = '" + m_dealdate + "'";
      end;
      // Фильтр по статусу сделки
      if(_DealStatus == DL_UNDEFSTAT)
      elif(_DealStatus == DL_OPENCLOSED)
         filter_str = filter_str + " AND DealStatus > " + DL_PREPARING;
      else
         filter_str = filter_str + " AND DealStatus = " + _DealStatus;
      end;

      // портфель
      if((_PortfGroupID != 0) and (_PortfAttrID != 0))
         filter_str = filter_str + " AND BCaseID = " + _PortfAttrID;
      end;
      // категория к.агента
      if((_CategGroupID != 0) and (_CategAttrID != 0))
         filter_str = filter_str + " AND ContragentCatID = " + _CategAttrID;
      end;

      if(filter_str != "")
         m_RmmDeal.SetFilter( filter_str );
      end;
      m_RmmDeal.AddSortFld("DealCode");
      m_RmmDeal.ApplyFilter();
      l_row = l_tbl.AddLine( "RowGroup" );
      l_row.Line("Row").BindItem.DataSource = m_RmmDeal;
      expandrowset(l_row.Line("Row"));

      PutSet = TRsbDataSet(sqltext + selling);
      CallSet = TRsbDataSet(sqltext + buying);
    
      if(PutSet.MoveNext and CallSet.MoveNext)
         l_row.Line("TotalsSell").Cell("SellingPrincipal").Value = round(PutSet.psum, 2);
         l_row.Line("TotalsBuy").Cell("BuyingPrincipal").Value = round(CallSet.psum, 2);

         l_row.Line("TotalsSell").Cell("Rate").Value = 
         l_row.Line("TotalsBuy").Cell("Rate").Value = 
         l_row.Line("TotalsSell").Cell("Duration").Value = 
         l_row.Line("TotalsBuy").Cell("Duration").Value = 0;

         if(PutSet.psum != 0)
            if( _weightingD == "V" )
               l_row.Line("TotalsSell").Cell("Duration").Value = round(PutSet.pr_du / PutSet.psum, 2);
            else
               l_row.Line("TotalsSell").Cell("Duration").Value = round(PutSet.pr_du_ra / PutSet.pr_ra, 2);
            end;
         end;
         if(CallSet.psum != 0)
            if( _weightingD == "V" )
               l_row.Line("TotalsBuy").Cell("Duration").Value = round(CallSet.pr_du / CallSet.psum, 2);
            else
               l_row.Line("TotalsBuy").Cell("Duration").Value = round(CallSet.pr_du_ra / CallSet.pr_ra, 2);
            end;
         end;

         if(PutSet.psum != 0)
            if( _weightingR == "V" )
               l_row.Line("TotalsSell").Cell("Rate").Value = round(PutSet.pr_ra / PutSet.psum, 2);
            else
               l_row.Line("TotalsSell").Cell("Rate").Value = round(PutSet.pr_du_ra / PutSet.pr_du, 2);
            end;
         end;
         if(CallSet.psum != 0)
            if( _weightingD == "V" )
               l_row.Line("TotalsBuy").Cell("Rate").Value = round(CallSet.pr_ra / CallSet.psum, 2);
            else
               l_row.Line("TotalsBuy").Cell("Rate").Value = round(CallSet.pr_du_ra / CallSet.pr_du, 2);
            end;
         end;

         if( _aggregates )

            l_row.Line("TotalsSell").Cell("SellingCost").Value = round(PutSet.sCost, 2);
            l_row.Line("TotalsBuy").Cell("BuyingCost").Value = round(CallSet.sCost, 2);

         end;

      end;

//   onerror
//      MyMsg( "TMMTEMPL1", "FillTable aborted", "" );
   end;

   macro PutAllElements()
      if(_header)
         PutElement(Header);
      end;
      if(_roll)
         FillTable();
      end;
      if(_statistics)
         PutElement(Statistics);
      end;
      if(_signatures)
         PutElement(Footer);
      end;
/*{{DESIGNER_PUT_ELEMENT_RSL_TMMTEMPL1(Header,ReportTable,Footer,Statistics)*/
/*DESIGNER_PUT_ELEMENT_RSL()}}*/
//   onerror
//      MyMsg( 0, "PutAllElements aborted", "" );
   end;

/*{{DESIGNER_HANDLERS_RSL_TMMTEMPL1(Print_Template_OnLoad,Print_Template_OnGetContents)*/
   macro Print_Template_OnLoad (Sender: Object, pbCancel: @Bool)
      if(_statistics)
         Statistics.StatisticsTable.DoInit();
      end;
      if(_roll)
         ReportTable.DoInit();
      end;
//   onerror
//      MyMsg( sender, "OnLoad aborted", "" );
   end;

   macro Print_Template_OnGetContents (Sender: Object)
      if(_header)
         if(m_dealdate > date(0,0,0))
            Header.DealDate.Text  = m_dealdate;
         end;
         Header.Briefcase.Text = getObjAttrName( OBJTYPE_MMARKDEAL, _PortfGroupID, _PortfAttrID );
         Header.FIID.Text      = DL_getCCode( m_fiid );
         Header.Category.Text  = getObjAttrName( OBJTYPE_PARTY, _CategGroupID, _CategAttrID );
      end;
      if(_signatures)
         Footer.FIO1.Value = {FIO_Boss};
         Footer.FIO3.Value = getNameOper;
      end;
      if(_statistics)
         if(_header OR _roll)
            Statistics.LabelFIID.Visible = false;
            Statistics.StatisticsFIID.Visible = false;
         else
            Statistics.StatisticsFIID.Text = DL_getCCode( m_fiid );
         end;
         Statistics.StatisticsTable.Fill( m_fiid, m_dealdate );
      end;
      PutAllElements();
//   onerror
//      MyMsg( sender, "getcontents aborted", "" );
   end;

/*DESIGNER_HANDLERS_RSL()}}*/

end;



MACRO PrintBody(grp, p_dealdate:date, p_fiid)
var MMTEMPL1,
    DataSet, ok = false,
    sqltext  = "select distinct T_PFI ",
    sqlfrom  = " from ddl_tick_dbt tick, ddl_leg_dbt leg ",
    sqlwhere = " where tick.t_bofficekind = 102 " +
                 " and tick.T_DEALID = leg.T_DEALID and leg.t_legkind = 0";

    // статус сделки
    AddDealStatus(@sqlwhere);
    // дата сделки
    if(p_dealdate > date(0,0,0))
       sqlwhere = sqlwhere + " AND tick.t_DealDate = " + to_date(p_dealdate);
    end;
    // ФИ
    if(p_fiid > -1)
       sqlwhere = sqlwhere + " AND leg.T_PFI = " + p_fiid;
    end;
    // портфель
    AddPortfel(@sqlfrom, @sqlwhere);
    // категория контрагента
    AddContrCateg(@sqlfrom, @sqlwhere);

    DataSet = TRsbDataSet(sqltext + sqlfrom + sqlwhere);
    while(DataSet.MoveNext)
       MMTEMPL1 = TMMTEMPL1(grp, DataSet.PFI, p_dealdate);
       ok = true;
    end;
    
    return ok;
END;


// Печать отчета. Параметры передаются из фильтра и панели настройки
MACRO printReportRSF( 
                   // значения, установленные в фильтре
                   p_PortfGroupID, p_PortfAttrID, 
                   p_CategGroupID, p_CategAttrID,  p_fiid,
                   // значения, установленные в панели настройки отчета
                   p_dealdate,   p_weightingR, p_weightingD, p_header,
                   p_statistics, p_aggregates, p_signatures, p_roll,
                   p_dealstatus
                    )
var grp = TReportsGroup();

   /* Установить параметры отчета по переданным значениям */
   _PortfGroupID = p_PortfGroupID;
   _PortfAttrID  = p_PortfAttrID;
   _CategGroupID = p_CategGroupID;
   _CategAttrID  = p_CategAttrID;
   _weightingR = p_weightingR;
   _weightingD = p_weightingD;
   _header     = p_header;
   _statistics = p_statistics;
   _aggregates = p_aggregates;
   _signatures = p_signatures;
   _roll       = p_roll;
   _DealStatus = p_dealstatus;

   if(PrintBody(grp, p_dealdate, p_fiid) == true)
      grp.Print( TRUE );
   else
      msgbox( "Нет данных, удовлетворяющих заданной фильтрации." );
   end;

END;
