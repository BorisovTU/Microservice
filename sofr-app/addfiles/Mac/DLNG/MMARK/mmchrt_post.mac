/*
$Name:        mmchrt_post.mac
$Module:      МБ Кредиты
$Description: Макрос постобработки шага "Изменение ставки"
*/
import RsbDataSet, globals, CTInter, OprInter, BankInter, FIInter, mmlibr, mmservop;
private const
    SET_CHAR = "X";

RECORD tick(dl_tick);
              
MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -откат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */  
   setbuff(tick, FirstDoc);
   var rs01,que,ss1,s1,rs10,jj,ss,nprpro,ss2,pa1,rs12,ss0;


  //if (errTrn) 
  //  SvOpSetErrProcObj(tick.BOfficeKind, tick.DealID, errTrn);
  //  return;
  //end;  


  if ( CommitOrRollback == 1 )
        s1=tick.dealid;
        que="select to_char(b.t_ratedate,'dd.mm.yyyy') da,b.t_rate st from doprstep_dbt a , ddl_comm_dbt b where a.t_id_operation="+ID_Operation;
        que=que+" and a.t_id_STEP="+ID_Step+" and a.t_servdockind = 218 and  a.t_servdocid = b.t_documentid and b.t_dockind=a.t_servdockind ";
        rs01 = LnGetRecordSet(que);
        if(rs01 != null)
          if (rs01.moveNext) 

              que="select t_correct from ddl_leg_dbt t where t_dealid = "+s1;
              rs10 = LnGetRecordset(que);
              if(rs10 != null)
                if (rs10.moveNext)
                   pa1=rs10.value(0);
                end;
              end;
              ss2=rs01.value("st");
              ss1=rs01.value("da");
              que="select count(*)  from dstd_pls_dbt where t_dizm ='"+ss1+"' and t_id = "+s1;
              rs10 = LnGetRecordset(que);
              if(rs10 != null)
                 if (rs10.moveNext)
                    jj=rs10.value(0);
                 end;
              end;

              ss     = string(s1);
              nprpro = ss2*1000000;

              ss0 = string(ss2*1000000);
              ss2 = (ss2-pa1);
              ss2 = trim(string(ss2:16:6));
              if ( jj == 0 )
                 que = "INSERT INTO dstd_pls_dbt Values('"+ss+"','"+ss1+"',"+ss0+","+ss2+")";
              else
                 que = "update dstd_pls_dbt SET t_stav = '"+ss0+"', t_kor_pro='"+ss2+"'  where t_dizm ='"+ss1+"' and t_id = '"+ss+"'";
              end;
              rs12 = LnGetRecordset(que);


          end;
        end;

   end;


  return 0;
END;
