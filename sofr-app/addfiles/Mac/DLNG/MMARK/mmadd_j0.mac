/*
$Name: mmadd_j0.mac
$Module: МБК
$Description: Макрос выполнения шага "Начисление процентов по сделке"
*/

IMPORT InsCarryDoc, MmarkInter, mmlibr, mmcarry, mmcnst_j, mpclb, Проценты,fx_lib,dl_lib,funk,dealInfo,dl_plib,fx_globals,dl_nplat;

  VAR da0,emes=0;


//Глобальные переменные, заполняются в сишнике
PRIVATE VAR ДатаДокументовНачисления, 
            ДатаНачисления;

//Объект для начисления процентов по сделке
//
// Передаваемые парметры:
// ДатаНачисления           - дата, на которую начисляем проценты
// ДатаДокументовНачисления - дата проводок по начислению
// Сделка                   - идентификатор сделки: может быть числовым идентификатором сделки в БД
//                            или объект MMFirstDoc (первичный документ по сделке)


CLASS MMOBJ_PcAdd(ДатаНачисления, ДатаДокументовНачисления, Сделка, ВыводитьОшибки)
  private var 
      isCheck        = false;       //флаг, отвечающий за то, что пройдена проверки или нет

  var
      PcAddGround_P  = "",         //основание проводки для сделки привлечения
      PcAddGround_NR = "",         //основание проводки для сделок с отрицательной процентной ставкой
      PcAddGround_RN = "",         //основание проводки для надежной сделки размещения
      PcAddGround_RP = "";         //основание проводки для проблемной сделки размещения

  var ID_Operation = 0,
      ID_Step      = 0,
      ZeroSumTrue  = 1,
      CorrectSum   = 0;

  private var
      prm_Quality      = 0,          // надежность сделки
      prm_CarrySum     = 0,          // сумма проводки
      prm_PercContract = NULL;       // процентный договор

  private var
      prm_PcAddDate      = {curdate}, //дата начисления
      prm_PcAddDateCarry = {curdate}, //дата проводок
      prm_FirstDoc       = NULL,       //первичный документ
      prm_ShowError       = true;       //признак вывода сообщений об ошибках

  private macro PcAdd_Error(_errStr)
      if (prm_ShowError)
          mm_error(_errStr);
      end;
  end;

  macro GetQuality()
      return prm_Quality;
  end;

  macro GetCarrySum()
      return prm_CarrySum;
  end;

  macro GetFirstDoc()
      return prm_FirstDoc;
  end;

//Основания проводок по умолчанию
  macro SetDefaultGround()
      PcAddGround_P  = "Начисление процентов по сделке МБК";
      PcAddGround_NR = "Начисление процентов по сделке МБК с отриц. ставкой";
      PcAddGround_RN = "Начисление процентов по надежной сделке МБК";
      PcAddGround_RP = "Начисление процентов по проблемной сделке МБК";
  end;

//Конструктор
  macro Init(Date, DateCarry, Deal, ShowErr)
      if (ValType(ShowErr) == V_BOOL)
          prm_ShowError = ShowErr;
      else
          prm_ShowError = true;
      end;

      if (ValType(Deal) == V_INTEGER)
          prm_FirstDoc = MMFirstDoc(DL_IBCDOC, Deal, true);
      elif (ValType(Deal) == V_GENOBJ)
          prm_FirstDoc = Deal;
      else
          PcAdd_Error("Ошибка при получении первичного документа сделки!");
          isCheck = false;
          return;
      end;

      if (ValType(Date) == V_DATE)
          prm_PcAddDate = Date;
      else
          prm_PcAddDate = {curdate};
      end;
    
      if (ValType(DateCarry) == V_DATE)
          prm_PcAddDateCarry = DateCarry;
      else
          prm_PcAddDateCarry = {curdate};
      end;
     /*
      if (IsSALE( GetOperationGroup(prm_FirstDoc.GetTick().DealType)))
          prm_Quality = Надежность(prm_FirstDoc.GetTick().DealID, prm_PcAddDate);
          if (prm_Quality == 0)
              PcAdd_Error("Не задана категория качества сделки!");
              isCheck = false;
              return;
          end;
      else
          prm_Quality = 0;
      end;
      */

      if (IsSALE( GetOperationGroup(prm_FirstDoc.GetTick().DealType)))
        prm_Quality = 1;
      end;

      if (ValType(prm_FirstDoc) == V_GENOBJ)
          prm_PercContract = MM_GetPercContractID(PC_IBC_CON, prm_FirstDoc.GetTick().DealCode);
      end;

      if ((prm_PercContract == NULL)or(prm_PercContract == 0))
          PcAdd_Error("Не найден процентный договор по сделке ", prm_FirstDoc.GetTick().DealCode);
          isCheck = false;
          return;
      end;

      SetDefaultGround();
      isCheck = true;
  end;

//Проверка перед выполнением операции начисления
  macro Check()
      var 
          CntSched = NULL;

      if (not isCheck)
          return isCheck;
      end;

      if(prm_PcAddDate > {curdate})
           PcAdd_Error("Преждевременное выполнение шага запрещено.");
        //   return false;
      end;

      if (CheckExistence(PAYM_DealID_Purpose_Status, prm_FirstDoc.GetTick().DealID, PM_PURP_PRINC, PM_FINISHED, PM_CLOSEDBYPROLONGATION, PM_CLOSED_W_M_MOVEMENT, 3010))
          PcAdd_Error("Перед начислением процентов необходимо исполнить платеж по ОД");
          return false;
      end;

      if (CheckExistence(LEG_LegKind_DealID_LegID, LEG_KIND_DL_TICK, prm_FirstDoc.GetTick().DealID, 1))
          PcAdd_Error("Не найден транш сделки ", prm_FirstDoc.GetTick().DealCode);
          return false;
      end;

      if (prm_FirstDoc.GetTick().Dealtype == 12301)
         prm_PcAddDate = prm_FirstDoc.GetLeg().Start + Int(prm_FirstDoc.GetLeg().Duration);
      end;
      if ((prm_PcAddDate < prm_FirstDoc.GetLeg().Start)or
          (prm_PcAddDate > (prm_FirstDoc.GetLeg().Start + Int(prm_FirstDoc.GetLeg().Duration))))
           PcAdd_Error("Не найден период начисления");
           return false;
      end;

      CntSched = TRsbDataSet("select t_DateReal from DPRCCNTSCHED_DBT where " +
                              "T_CONTRACTID = " + prm_PercContract + " and T_SCHEDULEKIND = 2 and T_SPECIALTYPE = 0 " +
                              "and T_DATE < TO_DATE('" + prm_PcAddDate + "') " +
                              "order by T_DATE desc");
/*
      if ((CntSched.MoveNext())and(CntSched.DateReal == date(0,0,0)))
           PcAdd_Error("Не было начисления в более ранние даты по графику начисления");
           return false;
      end;
*/
      return isCheck = true;
  end;

//Формирование проводки
  private macro Carry()
    var
        at = MM_Carry;
    var  day1,day2,ssu,prevssu,day3,basis,price,Debet,rs,sunp,que,rs5,rs51,ssu0,d0,d1,newsu,dsu,ppaymentid,accp,sumpl,std_pls_flag=false,dist_carry_sum_flag=false;

      if (not isCheck)
          //ругались раньше, так что просто выходим
          return false;
     end;

     if (( prm_FirstDoc.GetTick().partyid  == _BANK_RF ) and (prm_FirstDoc.GetTick().dealtype == 12300 ) )

            day2=DAT(MM_leg(prm_FirstDoc.GetTick().dealid,"start",1));

           if ( da0 > day2 )
               day2=da0-1;
           end;

           basis= MM_leg(prm_FirstDoc.GetTick().dealid,"basis",1);
           price= Новая_проц_ставка(prm_FirstDoc.GetTick().dealid,ДатаНачисления);

           // ssu=MM_leg(prm_FirstDoc.GetTick().dealid,"principal",1);
           
           accp =MM_acc(prm_FirstDoc.GetTick().dealid,111);


           ssu=abs(execmacrofile("calculate.mac", "RestA_", accp, ДатаНачисления, 1, prm_FirstDoc.GetLeg().PFI)) ;

           dsu=0;
           que="select count(*) from dstd_pls_dbt where t_id="+prm_FirstDoc.GetTick().dealid+"  and t_dizm > '"+day2+"' and t_dizm <= '"+ДатаНачисления+"'"; 
           rs5 = LnGetRecordSet(que);
           if(rs5 != null)
             if (rs5.moveNext) 

                if ( rs5.value(0) > 0 )
                 std_pls_flag = true;
                // ---

                  que="select t_stav/1000000  st  from dstd_pls_dbt where t_id="+prm_FirstDoc.GetTick().dealid+"  and t_dizm <= '"+day2+"' order by t_dizm desc  "; 
                  rs51 = LnGetRecordSet(que);
                  if(rs51 != null)
                    if (rs51.moveNext) 
                       day3=rs51.value(0);
                    end;

                  end;
                  que="select to_char(t_dizm,'dd.mm.yyyy') from dstd_pls_dbt where t_id="+prm_FirstDoc.GetTick().dealid+"  and t_dizm > '"+day2+"' and t_dizm <= '"+ДатаНачисления+"'"; 
                  rs51 = LnGetRecordSet(que);
                  if(rs51 != null)
                    if (rs51.moveNext) 

                      // msgbox(ssu,"-", day2,"-", date(rs51.value(0)),"-",day3);
                      dsu=round(РасчётПроцентнойСтавки(ssu, day2, date(rs51.value(0))-1,day3, basis), 2);
                      day2=date(rs51.value(0))-1;
                    end;
                 end;

                // ---
                end;
             end;
           end;


           que="select count(*) from dpmpaym_dbt d where  d.t_dockind=102 and d.t_documentid="+prm_FirstDoc.GetTick().dealid+" and d.t_purpose=10  and d.t_valuedate < '"+ДатаНачисления+"'  and d.t_valuedate >= '"+da0+"'";
           rs5 = LnGetRecordSet(que);
           if(rs5 != null)
             if (rs5.moveNext) 
                if ( rs5.value(0) > 0 )
                // ---

                  que="select d.t_baseamount amount,to_char(d.t_valuedate,'dd.mm.yyyy') valuedate  from dpmpaym_dbt d where  d.t_dockind=102 and d.t_documentid="+prm_FirstDoc.GetTick().dealid+" and d.t_purpose=10  and d.t_valuedate < '"+ДатаНачисления+"'  and d.t_valuedate >= '"+da0+"'";
                  rs51 = LnGetRecordSet(que);
                  if(rs51 != null)
                    if (rs51.moveNext) 
                      // msgbox(rs51.value("amount")," ", da0-1," ", date(rs51.value("valuedate")) );
                      day3= Новая_проц_ставка(prm_FirstDoc.GetTick().dealid,date(rs51.value("valuedate")));

                      dsu=dsu+round(РасчётПроцентнойСтавки(rs51.value("amount"), da0-1, date(rs51.value("valuedate")),day3, basis), 2);
                    end;
                 end;
                // ---
                end;
             end;
           end;

         if ((std_pls_flag) == false)
             prevssu=abs(execmacrofile("calculate.mac", "RestA_", accp, prm_FirstDoc.GetLeg().Start, 1, prm_FirstDoc.GetLeg().PFI)) ;
             if ((prevssu != ssu) and (prevssu != 0))
               dist_carry_sum_flag = true;
             end;
         end;


         if (not dist_carry_sum_flag)
           //  msgbox(ssu,"-", day2,"-", ДатаНачисления,"-",price);
           prm_CarrySum=round(РасчётПроцентнойСтавки(ssu, day2, ДатаНачисления,price, basis), 2);
           prm_CarrySum=prm_CarrySum+dsu;

           que="select t_account acc,t_fiid fiid from dmcaccdoc_dbt t where t_docid="+prm_FirstDoc.GetTick().dealid+" and (t_catid = 117 or  t_catid = 118)   and t_dockind=102 ";
           rs5 = LnGetRecordSet(que);
           if(rs5 != null)
             if (rs5.moveNext) 
               sunp=plat_dil0(prm_FirstDoc.GetTick().dealid,"102","11",ДатаНачисления,"baseamount");

               newsu=abs(execmacrofile("calculate.mac", "RestA_", rs5.value("acc"), ДатаНачисления, 1, MM_leg(prm_FirstDoc.GetTick().dealid,"pfi",1))) ;
               dsu=newsu+prm_CarrySum;

               if (abs(sunp-dsu) < 0.1 )
                  prm_CarrySum=sunp-newsu;
               end;
             end;
           end;
         end;

     else     
      d0=prm_FirstDoc.GetTick().dealdate;
      d1=DAT(MM_leg(prm_FirstDoc.GetTick().dealid,"maturity",1));
      if (prm_FirstDoc.GetTick().Dealtype == 12301)     //SVE 507960 19.05.2020 так как по сделкам овердрафт не известна сумма начисления заранее, запрашиваем ее в момент выполнения начисления
         getdouble(prm_CarrySum,"Введите сумму процентов:", 16, false, 4);
      elif ( (d1 - d0) == 1 )
         prm_CarrySum=MM_leg(prm_FirstDoc.GetTick().dealid,"cost",1);
      else
         day2=DAT(MM_leg(prm_FirstDoc.GetTick().dealid,"start",1));
         if ( da0 > day2 )
            day2=da0-1;
         end;

         basis= MM_leg(prm_FirstDoc.GetTick().dealid,"basis",1);
         price= Новая_проц_ставка(prm_FirstDoc.GetTick().dealid,ДатаНачисления);
         ssu=abs(execmacrofile("calculate.mac", "RestA_", accp, ДатаНачисления, 1, prm_FirstDoc.GetLeg().PFI)) ;
         accp =MM_acc(prm_FirstDoc.GetTick().dealid,111);

         prevssu=abs(execmacrofile("calculate.mac", "RestA_", accp, prm_FirstDoc.GetLeg().Start, 1, prm_FirstDoc.GetLeg().PFI)) ;
         if ((prevssu != ssu) and (prevssu != 0))
            dist_carry_sum_flag = true;
         end;

         if (not dist_carry_sum_flag)
            prm_CarrySum=round(РасчётПроцентнойСтавки(ssu, day2,iif(CheckIsDealTminus1_ByDealID(prm_FirstDoc.GetTick().dealid), DAT(MM_leg(prm_FirstDoc.GetTick().dealid,"maturity",1)), ДатаНачисления) /*ДатаНачисления*/,price, basis), 2);

            if (prm_FirstDoc.GetTick().dealtype != 12310 )
               que="select t_account acc,t_fiid fiid from dmcaccdoc_dbt t where t_docid="+prm_FirstDoc.GetTick().dealid+" and (t_catid = 117 or  t_catid = 118)   and t_dockind=102 ";
               rs5 = LnGetRecordSet(que);
               if (rs5 != null)
                  if (rs5.moveNext) 
                     sunp=MoneyL(plat_dil0(prm_FirstDoc.GetTick().dealid,"102","11",ДатаНачисления,"baseamount")); // ВР. MoneyL
                     newsu=abs(execmacrofile("calculate.mac", "RestA_", rs5.value("acc"), ДатаНачисления, 1, MM_leg(prm_FirstDoc.GetTick().dealid,"pfi",1))) ;
                     dsu=newsu+prm_CarrySum;
                     if (abs(sunp-dsu) < 0.1 )
                        prm_CarrySum=sunp-newsu;
                     end;
                  end;
               end;       
            end;
         end;
      end;
     end;

      at.date_carry   = prm_PcAddDateCarry;
      at.PrimaryDoc   = prm_FirstDoc;

      PcAddGround_P=mm_ground(prm_FirstDoc.GetTick().dealid,26);
      PcAddGround_NR=mm_ground(prm_FirstDoc.GetTick().dealid,26);
      PcAddGround_RN=mm_ground(prm_FirstDoc.GetTick().dealid,26);


      if( (prm_Quality == 0) and (prm_FirstDoc.GetTick().NegativeRate == "")) 
      // сделка привлечения, т.к. для сделок привлечения надежность не считается,
      // а для сделок размещения, если надежность не определена, то ругались раньше
          // at.CatPayer       = tdr_percP(prm_FirstDoc.GetTick().TypeDoc);
          at.CatPayer       = "-%, Кр0";
          at.CatReceiver    = tdr_claimP;
          at.FIIDPayer      = NATCUR;
          at.FIIDReceiver   = prm_FirstDoc.GetLeg().PFI;
          at.SumReceiver    = prm_CarrySum;
          at.Chapter        = 1;
          at.Ground         = PcAddGround_P;
      elif((prm_Quality == 0) and (prm_FirstDoc.GetTick().NegativeRate == "X"))
          VAR CarrySum;
          ConvSum(CarrySum, prm_CarrySum, prm_PcAddDateCarry, prm_FirstDoc.GetLeg().PFI, NATCUR);
          at.CatPayer       = tdr_perc3R;
          at.CatReceiver    = tdr_perc4R;
          at.FIIDPayer      = prm_FirstDoc.GetLeg().PFI;
          at.FIIDReceiver   = NATCUR;
          at.SumReceiver    = CarrySum;
          at.Chapter        = 1;
          at.Ground         = PcAddGround_NR;
      elif((prm_Quality != 0) and (prm_FirstDoc.GetTick().NegativeRate == ""))
          at.CatPayer       = tdr_claimR;

          if ( prm_FirstDoc.GetTick().partyid  == _BANK_RF )
            at.CatReceiver    =  "+%, Кр00";
          elif ( prm_FirstDoc.GetTick().dealtype  == 12335 )
            at.CatReceiver    =  "+%, Кр01";
          else
            at.CatReceiver    = tdr_percR(prm_FirstDoc.GetTick().TypeDoc);
          end;

          at.FIIDPayer      = prm_FirstDoc.GetLeg().PFI;
          at.FIIDReceiver   = NATCUR;
          at.SumPayer       = prm_CarrySum;
          at.Chapter        = 1;
          at.Ground         = PcAddGround_RN;
      elif((prm_Quality != 0) and (prm_FirstDoc.GetTick().NegativeRate == "X"))
          at.CatPayer       = tdr_perc4P;
          at.CatReceiver    = tdr_perc3P;
          at.FIIDPayer      = NATCUR;
          at.FIIDReceiver   = prm_FirstDoc.GetLeg().PFI;
          at.SumReceiver    = prm_CarrySum;
          at.Chapter        = 1;
          at.Ground         = PcAddGround_NR;
      end;

      if(not at.carry())
          PcAdd_Error("Ошибка при начислении процентов");
          return false;
      end;


      return true;
end;

//Начать операцию начисления
  macro PcAddOperation()
      var 
          CntSched = NULL, retVal = true;


      if (not Check())
          return false;
      end;

      CntSched = TRsbDataSet("select t_DateReal from DPRCCNTSCHED_DBT where " +
                              "T_CONTRACTID = " + prm_PercContract + " and T_SCHEDULEKIND = 2 and T_SPECIALTYPE = 0 " +
                              "and T_DATE >=TO_DATE('" + prm_PcAddDate + "') " +
                              "order by T_DATE");

      CntSched.MoveNext();

      if (CntSched.DateReal == date(0,0,0))
          if (not MM_CalcPerc(prm_PercContract, iif(CheckIsDealTminus1_ByDealID(prm_FirstDoc.GetTick().dealid), DAT(MM_leg(prm_FirstDoc.GetTick().dealid,"maturity",1)), prm_PcAddDate)/*prm_PcAddDate*/, 2, ID_Operation ,ID_Step, prm_FirstDoc.GetLeg().Basis, prm_CarrySum))
              PcAdd_Error("Ошибка при начислении процентов");
              return false;
          end;
      else
          prm_CarrySum = 0;
      end;

      prm_CarrySum = prm_CarrySum +CorrectSum;


      if ((ZeroSumTrue)and(prm_CarrySum == 0))
          retVal = true;
      else
          if(prm_CarrySum <= 0)
             // PcAdd_Error("Сумма начисления процентов нулевая !");
             // return false;
          end;        

          retVal = Carry();
      end;
      return retVal;
  end;

//Вызов конструктора
  Init(ДатаНачисления, ДатаДокументовНачисления, Сделка, ВыводитьОшибки);
END;

//Выполнение шага
PRIVATE MACRO ExecuteStep(Buffer, Document, DocKind, ID_Operation, ID_Step)
  //dan определение даты поиска платежей для функции PPOG 7614
  private macro get_date_for_ppog(dealid, CalcDate, PaymDate)
     var rezDate = CalcDate;
     var dl_cmd = dl_RSDCommand("select ga.t_outpmtmin1, ga.t_adjdatetype\n" +
                                "        from ddl_tick_dbt tick, ddl_genagr_dbt ga\n" + 
                                "       where ga.t_genagrid = tick.t_genagrid\n" + 
                                "         and tick.t_dealid = ?");
         dl_cmd.AddParam(dealid);
     var dl_rsd = dl_cmd.execute();
     if (dl_rsd.movenext())
       if (dl_rsd.OUTPMTMIN1 == set_char )  // установлен Т-1 на ГС
          if(dl_rsd.ADJDATETYPE == 0) 
             rezDate = PaymDate;
          elif (dl_rsd.ADJDATETYPE == 1)    //корректировка дата вперед платежа приходящегося на выходные 
             if(not IsWorkDay( PaymDate))
               rezDate = GetDateAfterWorkDays(PaymDate, 1);
             else
               rezDate = PaymDate;
             end;
          elif (dl_rsd.ADJDATETYPE == 2)    //корректировка дата назад платежа приходящегося на выходные 
             if(not IsWorkDay( PaymDate))
               rezDate = GetDateAfterWorkDays(PaymDate,-1);
             else
               rezDate = PaymDate;
             end;
          end;
       end;
     end;
     return rezDate;
  end;
  record deal(dl_tick);
  VAR PcAdd = NULL,dend,mon1,mon2,dachp,PmDateGreaterDealDate=false;


    SetBuff(deal, Document);
    DL_PrepareCarryBuffer (Buffer);
	
    ДатаДокументовНачисления={curdate};

    ДатаНачисления={curdate};
    // getdate(ДатаНачисления,"Укажите дату начисления");

    if (( plat_dil(deal.dealid,"102","9","paymstatus") ==32000 ) or (plat_dil(deal.dealid,"102","9","paymstatus") == 3010))
    else
      msgbox("Не проведен платеж ОД по сделке !");
      return 0;
    end;


    if ((deal.dealdate > ДатаНачисления ) or ((deal.dealdate == ДатаНачисления ) and (not CheckIsDealTminus1_ByDealID(deal.dealid))))
      msgbox("Начисление %% не требуется ! (начало)");
      return 0;
    end;

    dend=DAT(MM_leg(deal.dealid,"maturity",1));
    if ((dend < ДатаНачисления ) and (deal.dealtype != 12301))
	  // VVL DEF-29866 для случая, если дата окончания сделки приходится на вых. день, а дата платежа перенесена на след. рабочий
      var LastPaym = TRsbDataSet("select 1 from dpmpaym_dbt where " +
          "t_dockind= " + DL_IBCDOC + " and t_documentid= " + deal.dealid + " and t_purpose=11 and t_valuedate=" + GetSQLDate(get_date_for_ppog(deal.dealid, ДатаНачисления, dend)));

      if (LastPaym.MoveNext())
	   ДатаНачисления = dend;
          PmDateGreaterDealDate = true;
      end;
	  
      if (not PmDateGreaterDealDate )
	   msgbox("Начисление %% не требуется ! (окончание)");
	   return 0;
      end;
    end;
//dan
    if((CheckIsDealTminus1_ByDealID(deal.dealid))  and (DateAfterWorkDays({curdate} , 1) == dend) )
      ДатаДокументовНачисления = dend; 
    end;
//dan



    da0=СДАТ(ДатаНачисления);
    da0=ДАТ("01"+substr(da0,3));

    if ( PPOG_CH(deal.DealID,ДатаНачисления)  > 1 )

       dachp=ДАТ(PPOG_CH2(deal.DealID,ДатаНачисления));
       if (dachp > da0 )
          da0=dachp+1;
       end;

    end;


    dend=ДатаНачисления + 1;

    datesplit(ДатаНачисления,null,mon1,null);
    datesplit(dend,null,mon2,null);

    if ((mon2 > mon1 ) or (deal.dealtype == 12301))
       emes=1;
    else
       emes=0;
    end;

    if ( emes == 0  )
//      if ( PPOG(deal.DealID,iif(CheckIsDealTminus1_ByDealID(deal.dealid), DAT(MM_leg(deal.dealid,"maturity",1)), ДатаНачисления))  == 0 )   dan вынес определение даты для PPOG в отдельную функцию 7614
      if ( (PPOG(deal.DealID,get_date_for_ppog(deal.DealID, ДатаНачисления, DAT(MM_leg(deal.dealid,"maturity",1))))  == 0) and (not PmDateGreaterDealDate) )
        msgbox("Начисление %% не требуется ! (погашение) ");
        return 0;
      end;
    end;

    PcAdd = MMOBJ_PcAdd(ДатаНачисления, ДатаДокументовНачисления, deal.DealID, true);
    PcAdd.ID_Operation = ID_Operation;
    PcAdd.ID_Step      = ID_Step;
    PcAdd.ZeroSumTrue  = 0;

    if (not PcAdd.PcAddOperation())
        return 1;
    end;
    //SVE 507960 19.05.2020  корректируем платеж по процентам соответственно на введенную сумму из шага "Начисления процентов" для сделок Овердрафт
    var paymsum = PcAdd.GetCarrySum();                                         //Начисленная сумма процентов
    var FD = PcAdd.GetFirstDoc();                                              //первичный документ       
    if ((FD.tick.rec.dealtype == 12301) and (paymsum != 0))       
       var paym = RsbPayment(Dockind, FD.tick.rec.DealID, PM_PURP_PERCENT, 1); //Платеж по процентам        
       paym.SetPayerPI (PAYMENTS_GROUP_UNDEF, 
                        paym.PayerBankID,
                        paym.PayerBankCodeKind,
                        paym.PayerBankCode,
                        paym.PayerBankName,
                        paym.PayerBankCorrAcc,
                        paym.PayerFiid,
                        1,
                        paym.PayerAccount,
                        paym.Payer,
                        paym.PayerName,
                        paym.PayerINN,
                        paym.PayerCodeKind,
                        "");
       paym.SetReceiverPI (PAYMENTS_GROUP_UNDEF, 
                           paym.ReceiverBankID,
                           paym.ReceiverBankCodeKind,
                           paym.ReceiverBankCode,
                           paym.ReceiverBankName,
                           paym.ReceiverBankCorrAcc,
                           paym.PayerFiid,
                           1,
                           paym.PayerAccount,
                           paym.Receiver,
                           paym.ReceiverName,
                           paym.ReceiverINN,
                           paym.ReceiverCodeKind,
                           "");
       paym.PayerAmount = paymsum;                                            //Заполнили поле t_amount в dpmpaym_dbt
       paym.ReceiverAmount = paymsum;                                         //Заполнили поле t_paymamount
       paym.BaseAmount = paymsum;                                             //Заполнили поле t_baseamount
    end;                                                                      //Поля t_FutureReceiverAmount и t_FuturePAyerAmount заполняются автоматичекски при успешном заполнении предыдущих полей
    return 0;
END;

NameMacroFile = "mmadd_j.mac"; 
