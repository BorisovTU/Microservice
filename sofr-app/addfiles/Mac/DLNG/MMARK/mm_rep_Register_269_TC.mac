/*
$Name: mm_rep_Register_269_TC.mac
$Module: ŒŠ
$Description: Žâç¥â "¥£¨áâà ­ «®£®¢®£® ãç¥â  ¯® áâ. 269 Š"
*/

IMPORT RsbDataSet, "spserv.mac", "mmcateg.mac", "mmcnst_j.mac", "dltxrate.mac";

MACRO MM_GetDealsRecordSet(_kind:integer, _StartDate,_EndDate)
  var
      qStr = "", rs = NULL;

    qStr = "select " +
           " tick.t_DealID, " +
           " tick.t_DealCode,  " +
           " leg.t_Start, " +
           " (leg.t_Start + leg.t_Duration) as t_EndDate " +
           " from ddl_tick_dbt tick, ddl_leg_dbt leg " +
           " where " +
           " tick.t_BofficeKind = 102 " +
           " and tick.t_DealStatus > 0 ";

           if (_kind == 1)
               qStr = qStr + " and MMark_UTL.IsSALE(tick.t_DealGroup) > 0 "; // ¤®å®¤
           else
               qStr = qStr + " and MMark_UTL.IsBUY(tick.t_DealGroup) > 0 "; // à áå®¤
           end;

           qStr = qStr +
           " and leg.t_DealID = tick.t_DealID and leg.t_LegKind = 0 and leg.t_LegID = 1 " +
           " and TO_DATE('" + String(_StartDate) + "', 'dd.mm.yyyy') <= (leg.t_Start + leg.t_Duration) " +
           " and TO_DATE('" + String(_EndDate) + "', 'dd.mm.yyyy') >= leg.t_Start " +
           "order by tick.t_DealID";

    rs = TRsbDataSet(qStr);

    return rs;
END;

PRIVATE MACRO GetFirstParent(_DealID)
    var
      retVal = 0, isFind = true,
      qStr = "", rs = NULL;

    while (isFind)
        qStr = "select TO_NUMBER(oproper.t_DocumentID) as t_DealID" +
                " from doprdocs_dbt opdoc, doproper_dbt oproper, doprstep_dbt oprstep, doprostep_dbt oprostep " +
                " where opdoc.t_DocKind = 102 and opdoc.t_DocumentID = " + String(_DealID) + 
                " and oproper.t_ID_Operation = opdoc.t_ID_Operation" +
                " and oprstep.t_ID_Operation = opdoc.t_ID_Operation and oprstep.t_ID_Step = opdoc.t_ID_Step" +
                " and oprostep.t_BlockID = oprstep.t_BlockID and oprostep.t_Number_Step = oprstep.t_Number_Step" +
                " and oprostep.t_Symbol = 'á'";
        rs = TRsbDataSet(qStr);
        isFind = rs.MoveNext();
        if (isFind)
            _DealID = Int(rs.DealID);
            retVal  = _DealID;
        end;
    end;

    return retVal;
END;

PRIVATE MACRO GetLastChild(_DealID, _Date)
    var
      retVal = 0, isFind = true,
      qStr = "", rs = NULL;

    while (isFind)
        qStr = "select TO_NUMBER(opdoc.t_DocumentID) as t_DealID" +
                " from doprdocs_dbt opdoc, doproper_dbt oproper, doprstep_dbt oprstep, doprostep_dbt oprostep " +
                " where opdoc.t_DocKind = 102"
                " and oproper.t_ID_Operation = opdoc.t_ID_Operation and oproper.t_DocumentID = " + String(_DealID) + 
                " and oprstep.t_ID_Operation = opdoc.t_ID_Operation and oprstep.t_ID_Step = opdoc.t_ID_Step" +
                " and oprostep.t_BlockID = oprstep.t_BlockID and oprostep.t_Number_Step = oprstep.t_Number_Step" +
                " and oprostep.t_Symbol = 'á'";

        if (ValType(_Date) == V_DATE)
            qStr = qStr + " and oprstep.t_Fact_Date <= TO_DATE('" + String(_Date) + "', 'dd.mm.yyyy')"; 
        end;
	
        rs = TRsbDataSet(qStr);
        isFind = rs.MoveNext();
        if (isFind)
            _DealID = Int(rs.DealID);
            retVal  = _DealID;
        end;
    end;

    return retVal;
END;


MACRO MM_CheckDeal(_FD, _BeginDate, _EndDate)
    var
      qStr = "", rs = NULL,
      DealID_parent = 0, FD_parent = NULL,
      DealID_child = 0,  FD_child = NULL,
      contr = TRecHandler("party.dbt");

    DealID_parent = GetFirstParent(_FD.GetTick().DealID);
    DealID_child = GetLastChild(_FD.GetTick().DealID, _EndDate);

    if (DealID_parent > 0)
        FD_parent = MMFirstDoc(DL_IBCDOC, DealID_parent);
    else
        FD_parent = _FD;
    end;
    if (DealID_child > 0)
        FD_child = MMFirstDoc(DL_IBCDOC, DealID_child);
    else
        FD_child = _FD;
    end;

    if ((FD_child.GetLeg().Maturity - FD_parent.GetLeg().Start) <= 7)
        return false;
    end;

    contr.clear();
    ®«ãç¨âì‘ã¡ê¥ªâ (_FD.GetTick().PartyID, contr);

    if (_FD.GetLeg().Start > _BeginDate)
        _BeginDate = _FD.GetLeg().Start;
    end;

    if (_FD.GetLeg().Maturity < _EndDate)
        _EndDate = _FD.GetLeg().Maturity;
    end;

    qStr = "select count(1) cnt from dobjatcor_dbt t where " +
            " t.t_ObjectType = " + OBJTYPE_PARTY + " and t.t_GroupID = " + PARTY_ATTR_GROUP_KIND_INTERDEPENDENCE +
            " and t.t_Object = '" + UniID(contr, OBJTYPE_PARTY) + "'" +
            " and (t.t_ValidFromDate BETWEEN TO_DATE('" + String(_BeginDate) + "', 'dd.mm.yyyy') AND TO_DATE('" + String(_EndDate) + "', 'dd.mm.yyyy') " +
            " or t.t_ValidToDate BETWEEN TO_DATE('" + String(_BeginDate) + "', 'dd.mm.yyyy') AND TO_DATE('" + String(_EndDate) + "', 'dd.mm.yyyy') " +
            " or ((t.t_ValidFromDate < TO_DATE('" + String(_BeginDate) + "', 'dd.mm.yyyy')) and (t.t_ValidToDate > TO_DATE('" + String(_EndDate) + "', 'dd.mm.yyyy'))))";
    rs = TRsbDataSet(qStr);
    rs.MoveNext();

    return DL_IIF(rs.CNT == 0, false, true);
END;

MACRO MM_GetDealsPeriodRecordSet(_FD, _StartDatePeriod, _EndDatePeriod)
  var
      qStr = "", rs = NULL;

    qStr = "select * from " + 
           "(" +
           "    select " +
           "        per.t_DealID, " +
           "        GREATEST(" + 
           "                  LAG(per.t_datePeriod_to + 1, 1, TO_DATE('" + String(_FD.GetLeg().Start) + "', 'dd.mm.yyyy') + 1) OVER(PARTITION BY per.t_DealID ORDER BY per.t_datePeriod_to + 1), " +
           "              TO_DATE('" + String(_StartDatePeriod) + "', 'dd.mm.yyyy')) " +
           "        as t_DatePeriod_From, " + 
           "        per.t_DatePeriod_To " +
           "    from " +
           "    ( " +
           "        with t as ( " +
           "                    select  " +
           "                        TO_DATE('" + String(_StartDatePeriod) + "', 'dd.mm.yyyy') as t_Start,  " +
           "                        TO_DATE('" + String(_EndDatePeriod) + "', 'dd.mm.yyyy') as t_EndDate " +
           "                    from dual " +
           "                  ) " +
           "        select " +
           "            " + String(_FD.GetTick.DealID) + " as t_DealID, " +
           "            case when add_months(trunc(t.t_Start, 'mm'),level)>t.t_EndDate then t.t_EndDate " +
           "                 else last_day(add_months(t.t_Start,level-1)) " +
           "            end t_datePeriod_to " +
           "        from t " +
           "        connect by add_months(trunc(t.t_Start,'mm'),level-1) <= t.t_EndDate " +
           "        UNION " +
           "        select " +
           "            " + String(_FD.GetTick.DealID) + ", " +
           "            val.t_RateDate - 1 " +
           "        from dprccontract_dbt prc, dprcrate_dbt rate, dprcrateval_dbt val " +
           "        where  " +
           "            prc.t_ObjectType = 103 and prc.t_ContractType = 7 and prc.t_ObjectID = '" + _FD.GetTick().DealCode + "' " +
           "            and rate.t_RateID = prc.t_RateID " +
           "            and val.t_RateID = rate.t_RateID " +
           "        UNION " +
           "        select " +
           "            " + String(_FD.GetTick.DealID) + ", " +
           "            pm.t_ValueDate " +
           "        from dpmpaym_dbt pm  " +
           "        where  " +
           "            pm.t_DocKind = 102  " +
           "            and pm.t_DocumentID = " + String(_FD.GetTick.DealID) +
           "            and pm.t_Purpose = 11 " +
           "            and pm.t_PaymStatus = 32000 " +
           "    ) per " +
           ") periods" +
           " where periods.t_DatePeriod_To+1 >= TO_DATE('" + String(_StartDatePeriod) + "', 'dd.mm.yyyy')" +
           " and periods.t_DatePeriod_To <= TO_DATE('" + String(_EndDatePeriod) + "', 'dd.mm.yyyy')" + 
           "order by t_DatePeriod_From";

    rs = TRsbDataSet(qStr);

    return rs;
END;

CLASS CategoryPeriods(_BeginDate, _EndDate)
  var
    BeginDate = _BeginDate,
    EndDate = _EndDate;
END;

MACRO MM_GetCategoryPeriod(_FD, _StartDatePeriod, _EndDatePeriod)
  var
      qStr = "", bdStr = "", rs = NULL, bd= NULL, Periods = TArray,
      DealID_parent = 0, FD_parent = NULL,
      contr = TRecHandler("party.dbt"),
      BeginDate, EndDate, idx = 0, retVal = TArray, isFind = false, basis30 = false;

    contr.clear();
    ®«ãç¨âì‘ã¡ê¥ªâ (_FD.GetTick().PartyID,contr);

    qStr = "select * from dobjatcor_dbt t where " +
            " t.t_ObjectType = " + OBJTYPE_PARTY + " and t.t_GroupID = " + PARTY_ATTR_GROUP_KIND_INTERDEPENDENCE +
            " and t.t_Object = '" + UniID(contr, OBJTYPE_PARTY) + "'" +
            " and (t.t_ValidFromDate BETWEEN TO_DATE('" + String(_StartDatePeriod) + "', 'dd.mm.yyyy') AND TO_DATE('" + String(_EndDatePeriod) + "', 'dd.mm.yyyy') " +
            " or t.t_ValidToDate BETWEEN TO_DATE('" + String(_StartDatePeriod) + "', 'dd.mm.yyyy') AND TO_DATE('" + String(_EndDatePeriod) + "', 'dd.mm.yyyy') " +
            " or ((t.t_ValidFromDate < TO_DATE('" + String(_StartDatePeriod) + "', 'dd.mm.yyyy')) and (t.t_ValidToDate > TO_DATE('" + String(_EndDatePeriod) + "', 'dd.mm.yyyy'))))" + 
            " order by t.t_ValidFromDate, t.t_ValidToDate";

    bdStr =  "select " +
             "    case t.t_Calendar " +
             "        when 1 then 30 " +
             "        when 3 then 30 " +
             "        when 5 then 30 " +
             "        when 7 then 30 " +
             "        else 0 " +
             "    end as t_BasisDays " +
             "from " +
             "( " +
             "    select calc.t_Calendar, val.t_Rate " +
             "    from dprccontract_dbt prc, dprccalc_dbt calc, dprcrate_dbt rate, dprcrateval_dbt val " +
             "    where " +
             "    prc.t_ObjectType = 103 " +
             "    and prc.t_ContractType = 7 " +
             "    and prc.t_ObjectID = '" + _FD.GetTick().DealCode + "' " +
             "    and rate.t_RateID = prc.t_RateID " +
             "    and val.t_RateID(+) = rate.t_RateID " +
             "    and calc.t_CalcID = prc.t_CalcID " +
             "    and val.t_RateDate(+) <= TO_DATE('" + date(_StartDatePeriod) + "', 'dd.mm.yyyy') " +
             "    order by val.t_RateDate desc " +
             ") t " +
             "where rownum = 1";            
         
    rs = TRsbDataSet(qStr);
    bd = TRsbDataSet(bdStr);
    if (bd.MoveNext)
        if (bd.t_BasisDays == 30)
            basis30 = true;
        end;
    end;
    while (rs.MoveNext)
        BeginDate = date(rs.ValidFromDate);
        EndDate = date(rs.ValidToDate);

        if (_StartDatePeriod > BeginDate)
            BeginDate = _StartDatePeriod;
        end;
        if (_EndDatePeriod < EndDate)
            EndDate = _EndDatePeriod;
        end;

        if ( (basis30) and (date(EndDate) < date(31, 12, 9999)) )
            var dsEndMonth = TRsbDataSet("select to_number(to_char(TO_DATE('"+date(EndDate)+"', 'dd.mm.yyyy')+1, 'MM')) - " +
                                             " to_number(to_char(TO_DATE('"+date(EndDate)+"', 'dd.mm.yyyy'), 'MM')) monChange from dual"),
                endMonth = true;
            if (dsEndMonth.MoveNext)
                endMonth=DL_IIF(dsEndMonth.monChange == 0, false, true);
            end;
            
            if (endMonth) //ª®­¥æ ¯¥à¨®¤  á®¢¯ ¤ ¥â á ª®­æ®¬ ¬¥áïæ 
                var day = 0, mon = 0, year = 0;
                DateSplit(EndDate, day, mon, year);
                if (day == 31)
                    EndDate = date(30, mon, year);
                    if (EndDate < BeginDate)
                        continue;
                    end;
                end;
                if (mon == 2)
                    EndDate = date(30-day, mon + 1, year);
                end;
            end;
        end;
        
        if (Periods.size > 0)
            if (BeginDate > Periods[Periods.size - 1].EndDate)
                Periods[Periods.size] = CategoryPeriods(BeginDate, EndDate);
            else
                if (BeginDate < Periods[Periods.size - 1].BeginDate)
                    Periods[Periods.size - 1].BeginDate = BeginDate;
                end;
                if (EndDate > Periods[Periods.size - 1].EndDate)
                    Periods[Periods.size - 1].EndDate = EndDate;
                end;
            end;
        else
            Periods[Periods.size] = CategoryPeriods(BeginDate, EndDate);
        end;
    end;

    DealID_parent = GetFirstParent(_FD.GetTick().DealID);
    if (DealID_parent > 0)
        FD_parent = MMFirstDoc(DL_IBCDOC, DealID_parent);
    else
        FD_parent = _FD;
    end;

    qStr =   "select mmro.*" +
              "  from dmmro_dbt mmro" +
              "  where mmro.t_DealID = " + String(_FD.GetTick.DealID) +
              "  and (mmro.t_MaturityDate - TO_DATE('" + FD_parent.GetLeg().Start + "', 'dd.mm.yyyy')) > 7" + 
              "  order by t_MaturityDate";
    rs = TRsbDataSet(qStr);
    if (rs.MoveNext)
        qStr =   "select mmro.*" +
                  "  from dmmro_dbt mmro" +
                  "  where mmro.t_DealID = " + String(_FD.GetTick.DealID) +
                  "  and mmro.t_MaturityDate < TO_DATE('" + date(rs.MaturityDate) + "', 'dd.mm.yyyy')" + 
                  "  order by t_MaturityDate desc";
    else
        qStr =   "select mmro.*" +
                  "  from dmmro_dbt mmro" +
                  "  where mmro.t_DealID = " + String(_FD.GetTick.DealID) +
                  "  order by t_MaturityDate desc";
    end;

    rs = TRsbDataSet(qStr);
    if (rs.MoveNext)
        idx = 0;
        while (idx < Periods.size)
            if (Periods[idx].EndDate <= Date(rs.MaturityDate))
                idx = idx + 1;
                continue;
            end;
            if (Periods[idx].BeginDate < Date(rs.MaturityDate))
                Periods[idx].BeginDate = Date(rs.MaturityDate);
            end;
            retVal[retVal.size] = Periods[idx];

            idx = idx + 1;
        end;
    else
        retVal = Periods;
    end;

    return retVal;
END;

MACRO MM_SetCommonData(_repObj, _kind:integer, _FD, _dataStruct)
  var
      qStr = "", rs = NULL,
      DealID_parent = 0, FD_parent = NULL,
      DealID_child = 0,  FD_child = NULL;

    qStr = "select " +
           "    tick.t_DealID, " +
           "    decode(tick.t_TypeDoc, 'L', 'Šà¥¤¨â', '„¥¯®§¨â') as t_P1 ," +
           "    party.t_Name as t_P2, " +
           "    tick.t_DealCode t_P3, " +
           "    NVL(fi.t_ccy, ' ') as t_P4, " +
           "    leg.t_Duration as t_P5, " +
           "    leg.t_Start as t_P6, " +
           "    (leg.t_Start + leg.t_Duration) as t_P7, " +
           "    leg.t_Principal as t_P8, " +
           "    (select count(1) from dprccontract_dbt prc, dprcrate_dbt rate, dprcrateval_dbt val  " +
           "     where prc.T_ObjectType = 103 and prc.t_ContractType = 7 and prc.t_ObjectID = tick.t_DealCode " +
           "     and rate.t_RateID = prc.t_RateID " +
           "     and val.t_RateID = rate.t_RateID " +
           "    ) as T_P9 " +
           "from ddl_tick_dbt tick, ddl_leg_dbt leg, dparty_dbt party, dfininstr_dbt fi " +
           "where " +
           "tick.t_DealID = " + String(_FD.GetTick.DealID) +
           " and leg.t_DealID = tick.t_DealID and leg.t_LegKind = 0 and leg.t_LegID = 1 " +
           " and party.t_PartyID = tick.t_PartyID " +
           " and fi.t_FIID(+) = leg.t_PFI";

    DealID_parent = GetFirstParent(_FD.GetTick().DealID);
    DealID_child = GetLastChild(_FD.GetTick().DealID);

    if (_kind == 1) // ¤®å®¤
        rs = TRsbDataSet(qStr);
        rs.MoveNext();

        _dataStruct.P1 = rs.P1;
        _dataStruct.P2 = rs.P2;
        _dataStruct.P3 = rs.P3;
        _dataStruct.P5 = rs.P4;
        _dataStruct.P6 = rs.P5;

        if (DealID_parent > 0)
            FD_parent = MMFirstDoc(DL_IBCDOC, DealID_parent);
            _dataStruct.P7 = FD_parent.GetLeg().Start;
        else
            _dataStruct.P7 = Date(rs.P6);
        end;

        if (DealID_child > 0)
            FD_child = MMFirstDoc(DL_IBCDOC, DealID_child);
            _dataStruct.P8 = FD_child.GetLeg().Maturity;
        else
            _dataStruct.P8 = Date(rs.P7);
        end;

        _dataStruct.P9 = rs.P8;

        if (rs.P9 > 1)
            _dataStruct.P27 = "¤ ";
        else
            _dataStruct.P27 = "­¥â";
        end;
    else // à áå®¤
        rs = TRsbDataSet(qStr);
        rs.MoveNext();

        _dataStruct.P1 = rs.P1;
        _dataStruct.P2 = rs.P2;
        _dataStruct.P3 = rs.P3;
        _dataStruct.P5 = rs.P4;
        _dataStruct.P6 = rs.P5;

        if (DealID_parent > 0)
            FD_parent = MMFirstDoc(DL_IBCDOC, DealID_parent);
            _dataStruct.P7 = FD_parent.GetLeg().Start;
        else
            _dataStruct.P7 = Date(rs.P6);
        end;

        if (DealID_child > 0)
            FD_child = MMFirstDoc(DL_IBCDOC, DealID_child);
            _dataStruct.P8 = FD_child.GetLeg().Maturity;
        else
            _dataStruct.P8 = Date(rs.P7);
        end;

        _dataStruct.P9 = rs.P8;

        if (rs.P9 > 1)
            _dataStruct.P29 = "¤ ";
        else
            _dataStruct.P29 = "­¥â";
        end;
    end;

    return _dataStruct;
END;

MACRO MM_SetPeriodData(_repObj, _kind:integer, _FD, _StartPeriodDate, _EndPeriodDate, _dataStruct)
  var MainRest = "", Perc = "", PercVB = "";
  var CurMonth = "", err = "";

  var
    rsRateVal =  TRsbDataSet("select " +
                             "    case t.t_Calendar " +
                             "        when 1 then 360 " +
                             "        when 2 then 360 " +
                             "        when 5 then 360 " +
                             "        when 6 then 360 " +
                             "        else to_date('3112'||to_char(TO_DATE('" + date(_StartPeriodDate) + "', 'dd.mm.yyyy'), 'YYYY'),'DDMMYYYY') - trunc(TO_DATE('" + date(_StartPeriodDate) + "', 'dd.mm.yyyy'), 'YEAR') + 1 " +
                             "    end as t_Basis, " +
                             "    NVL(t.t_Rate, 0) as t_Rate " +
                             "from " +
                             "( " +
                             "    select calc.t_Calendar, val.t_Rate " +
                             "    from dprccontract_dbt prc, dprccalc_dbt calc, dprcrate_dbt rate, dprcrateval_dbt val " +
                             "    where " +
                             "    prc.t_ObjectType = 103 " +
                             "    and prc.t_ContractType = 7 " +
                             "    and prc.t_ObjectID = '" + _FD.GetTick().DealCode + "' " +
                             "    and rate.t_RateID = prc.t_RateID " +
                             "    and val.t_RateID(+) = rate.t_RateID " +
                             "    and calc.t_CalcID = prc.t_CalcID " +
                             "    and val.t_RateDate(+) <= TO_DATE('" + date(_StartPeriodDate) + "', 'dd.mm.yyyy') " +
                             "    order by val.t_RateDate desc " +
                             ") t " +
                             "where rownum = 1"
                            );

    DateSplit(_StartPeriodDate, NULL, CurMonth, NULL);
    _FD.IsExistAccount(tdr_rest(_FD.GetTick().FlagTypeDeal), MainRest, true, NULL, NULL, _EndPeriodDate, NULL);
        
    var rs = TRsbDataSet("select t_NotResident from dparty_dbt where t_partyid = " + _FD.GetTick().PartyID);
    rs.moveNext;
    var contrResident = DL_IIF(rs.NotResident == "X", 2, 1);
        
    if (_kind == 1) // ¤®å®¤
        _FD.IsExistAccount(tdr_claimR, Perc, true, NULL, NULL, _EndPeriodDate, NULL);
        PercVB = "";

        _dataStruct.P4 = MainRest;
        _dataStruct.P10 = DL_GetNameAlg(1005/*LIST_MONTH_IM*/, CurMonth);
        _dataStruct.P11 = int(_EndPeriodDate - _StartPeriodDate) + 1;

        _dataStruct.P12 = Double(0);
        _dataStruct.P26 = 365;
        if (rsRateVal.MoveNext)
            _dataStruct.P12 = rsRateVal.Rate;
            _dataStruct.P26 = rsRateVal.Basis;
        end;

        if ((Perc != "") and (PercVB != ""))
            _dataStruct.P13 = Perc + ", " + PercVB;
        elif (Perc != "")
            _dataStruct.P13 = Perc;
        elif (PercVB != "")
            _dataStruct.P13 = PercVB;
        else
            _dataStruct.P13 = "";
        end;

        if ( not ConvSumDbl(_dataStruct.P16, Double(1), date(_EndPeriodDate), _FD.GetLeg().PFI, natcur, false)) _dataStruct.P16 = 0; end;  
        _dataStruct.P14 = Money(_dataStruct.P9*(_dataStruct.P11/_dataStruct.P26)*(_dataStruct.P12/100)*_dataStruct.P16);
        _dataStruct.P15 = Money(_dataStruct.P9*(_dataStruct.P11/_dataStruct.P26)*(_dataStruct.P12/100));

        _dataStruct.P17 = Double(0);
        _dataStruct.P18 = Double(0);
        _dataStruct.P19 = Double(0);
        if (String(_dataStruct.P27) == "­¥â")
            DL_GetTxRate(Date(_dataStruct.P7), Int(_FD.GetLeg().PFI), Int(_dataStruct.P6), @_dataStruct.P17, @err, ‘’_269_€‡Œ…™…ˆ…, Date(_dataStruct.P7), contrResident);
            _repObj.SetErrorForIBC(err);
            _dataStruct.P19 = ReadNoteForObject(OBJTYPE_MMARKDEAL, UniID(_FD.tick, OBJTYPE_MMARKDEAL), 1, Date(_dataStruct.P7));
            if (not _dataStruct.P19)
                DL_GetTxRate_Limit(Date(_dataStruct.P7), ‘’_269_€‡Œ…™…ˆ…, Int(_FD.GetLeg().PFI), Int(_dataStruct.P6), @_dataStruct.P19, @err, Date(_dataStruct.P7), contrResident);
                _repObj.SetErrorForIBC(err);
            end;
        else
            DL_GetTxRate(date(_EndPeriodDate), Int(_FD.GetLeg().PFI), Int(_dataStruct.P6), @_dataStruct.P18, @err, ‘’_269_€‡Œ…™…ˆ…, Date(_dataStruct.P7), contrResident);
            _repObj.SetErrorForIBC(err);
            _dataStruct.P19 = ReadNoteForObject(OBJTYPE_MMARKDEAL, UniID(_FD.tick, OBJTYPE_MMARKDEAL), 1, date(_EndPeriodDate));
            if (not _dataStruct.P19)			
                DL_GetTxRate_Limit(date(_EndPeriodDate), ‘’_269_€‡Œ…™…ˆ…, Int(_FD.GetLeg().PFI), Int(_dataStruct.P6), @_dataStruct.P19, @err, Date(_dataStruct.P7), contrResident);
                _repObj.SetErrorForIBC(err);
            end;
        end;

        _dataStruct.P20 = max(Double(_dataStruct.P19), Double(_dataStruct.P12));
        _dataStruct.P21 = Money(_dataStruct.P9)*(Double(_dataStruct.P11)/Int(_dataStruct.P26))*(_dataStruct.P19/100);
        _dataStruct.P22 = Money(_dataStruct.P9)*(Double(_dataStruct.P11)/Int(_dataStruct.P26))*(_dataStruct.P19/100)*_dataStruct.P16;
        _dataStruct.P23 = Money(_dataStruct.P9)*(Double(_dataStruct.P11)/Int(_dataStruct.P26))*(_dataStruct.P20/100)*_dataStruct.P16;
        _dataStruct.P24 = Money(_dataStruct.P9)*(Double(_dataStruct.P11)/Int(_dataStruct.P26))*(_dataStruct.P20/100);
        _dataStruct.P25 = max(0, Double(_dataStruct.P23)-Double(_dataStruct.P14));
    else // à áå®¤
        _FD.IsExistAccount(tdr_claimP, Perc, true, NULL, NULL, _EndPeriodDate, NULL);

        _dataStruct.P21 = "";
        _dataStruct.P26 = "";

        _dataStruct.P4 = MainRest;
        _dataStruct.P10 = DL_GetNameAlg(1005/*LIST_MONTH_IM*/, CurMonth);
        _dataStruct.P11 = int(_EndPeriodDate - _StartPeriodDate) + 1;

        _dataStruct.P12 = Double(0);
        _dataStruct.P28 = 365;
        if (rsRateVal.MoveNext)
            _dataStruct.P12 = rsRateVal.Rate;
            _dataStruct.P28 = rsRateVal.Basis;
        end;

        _dataStruct.P13 = Perc;

        if ( not ConvSumDbl(_dataStruct.P16, Double(1), date(_EndPeriodDate), _FD.GetLeg().PFI, natcur, false)) _dataStruct.P16 = 0; end;
        _dataStruct.P14 = Money(_dataStruct.P9*(_dataStruct.P11/_dataStruct.P28)*(_dataStruct.P12/100)*_dataStruct.P16);
        _dataStruct.P15 = Money(_dataStruct.P9*(_dataStruct.P11/_dataStruct.P28)*(_dataStruct.P12/100));

        _dataStruct.P17 = Double(0);
        _dataStruct.P18 = Double(0);
        _dataStruct.P19 = Double(0);
        if (String(_dataStruct.P29) == "­¥â")
            DL_GetTxRate(Date(_dataStruct.P7), Int(_FD.GetLeg().PFI), Int(_dataStruct.P6), @_dataStruct.P17, @err, ‘’_269_ˆ‚‹…—…ˆ…, Date(_dataStruct.P7), contrResident);
            _repObj.SetErrorForIBC(err);
            _dataStruct.P19 = ReadNoteForObject(OBJTYPE_MMARKDEAL, UniID(_FD.tick, OBJTYPE_MMARKDEAL), 1, Date(_dataStruct.P7));
            if (not _dataStruct.P19)			
                DL_GetTxRate_Limit(Date(_dataStruct.P7), ‘’_269_ˆ‚‹…—…ˆ…, Int(_FD.GetLeg().PFI), Int(_dataStruct.P6), @_dataStruct.P19, @err, Date(_dataStruct.P7), contrResident);
                _repObj.SetErrorForIBC(err);
            end;
        else
            DL_GetTxRate(Date(_EndPeriodDate), Int(_FD.GetLeg().PFI), Int(_dataStruct.P6), @_dataStruct.P18, @err, ‘’_269_€‡Œ…™…ˆ…, Date(_dataStruct.P7), contrResident);
            _repObj.SetErrorForIBC(err);
            _dataStruct.P19 = ReadNoteForObject(OBJTYPE_MMARKDEAL, UniID(_FD.tick, OBJTYPE_MMARKDEAL), 1, Date(_EndPeriodDate));
            if (not _dataStruct.P19)			
                DL_GetTxRate_Limit(Date(_EndPeriodDate), ‘’_269_ˆ‚‹…—…ˆ…, Int(_FD.GetLeg().PFI), Int(_dataStruct.P6), @_dataStruct.P19, @err, Date(_dataStruct.P7), contrResident);
                _repObj.SetErrorForIBC(err);
            end;
        end;

        _dataStruct.P20 = min(Double(_dataStruct.P19), Double(_dataStruct.P12));
        _dataStruct.P22 = Money(_dataStruct.P9)*(Double(_dataStruct.P11)/Int(_dataStruct.P28))*(_dataStruct.P19/100);
        _dataStruct.P23 = Money(_dataStruct.P9)*(Double(_dataStruct.P11)/Int(_dataStruct.P28))*(_dataStruct.P19/100)*_dataStruct.P16;
        _dataStruct.P24 = Money(_dataStruct.P9)*(Double(_dataStruct.P11)/Int(_dataStruct.P28))*(_dataStruct.P20/100)*_dataStruct.P16;
        _dataStruct.P25 = Money(_dataStruct.P9)*(Double(_dataStruct.P11)/Int(_dataStruct.P28))*(_dataStruct.P20/100);
        _dataStruct.P27 = max(Money(0), (Money(_dataStruct.P24) - Money(_dataStruct.P14)));
    end;

    return _dataStruct;
END;

MACRO MM_FillNotes(_repObjXLS, _kind:integer, _FD, _DatePeriod_To)
  var
      rs_mro = TRsbDataSet("select * from dmmro_dbt t where t.t_DealID = " + Int(_FD.GetTick.DealID) + " and t.t_MaturityDate <= TO_DATE('" + date(_DatePeriod_To) + "', 'dd.mm.yyyy') order by t.t_id desc");

    if (_kind == 1) // ¤®å®¤
        if (rs_mro.MoveNext)
            _repObjXLS.Sheet.Range("T_A9").AddComment(String(Money(rs_mro.Principal)));
            _repObjXLS.Sheet.Range("T_A9").Comment.Visible = false;
        end;
    else // à áå®¤
        if (rs_mro.MoveNext)
            _repObjXLS.Sheet.Range("T_B9").AddComment(String(Money(rs_mro.Principal)));
            _repObjXLS.Sheet.Range("T_B9").Comment.Visible = false;
        end;
    end;
END;
