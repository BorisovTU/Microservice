/*
$Name:        mmtcf_j_post.mac
$Module:      МБ Кредиты
$Description: Востребование суммы долга (постобработка)
*/

import mmlibr, mmcarry, mmlb_j;

MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */
    record tick(dl_tick);
    SetBuff(tick, FirstDoc);
    if (CommitOrRollback == 1)
        var deal_pd, Account;
        deal_pd = MMFirstDoc(DL_IBCDOC, tick.DealID, true);
        deal_pd.SetParametr(MC_TYPE_PARAMETR_FINDATE, date(0, 0, 0));
        if(IsSALE(GetOperationGroup(tick.DealType)))
            deal_pd.ActualCheckPeriod(tdr_claimR, Account, NULL, deal_pd.GetFIRoleByCategory(tdr_claimR, deal_pd.GetLeg().PFI),
                                        NULL, {curdate}, deal_pd.GetLeg().PFI);
            RSDCommand("update dpmpaym_dbt set t_receiveraccount = '" + Account +
            "', t_futurereceiveraccount = '" + Account +
            "', t_paymstatus = 1000 where t_dockind = 102 and t_documentid =" + tick.DealID + 
            " and t_purpose = " + PM_PURP_PERCENT).execute();
        else
            deal_pd.ActualCheckPeriod(tdr_claimP, Account, NULL, deal_pd.GetFIRoleByCategory(tdr_claimP, deal_pd.GetLeg().PFI),
                                        NULL, {curdate}, deal_pd.GetLeg().PFI);
            RSDCommand("update dpmpaym_dbt set t_payeraccount = '" + Account +
            "', t_futurepayeraccount = '" + Account +
            "', t_paymstatus = 1000 where t_dockind = 102 and t_documentid =" + tick.DealID + 
            " and t_purpose = " + PM_PURP_PERCENT).execute();
        end;
    elif (CommitOrRollback == 2)
        RSDCommand("delete from dpmpaym_dbt where t_dockind = 102 and t_documentid =" + tick.DealID + "and t_purpose =" + PM_PURP_PERCENT).execute();
    end;
    return 0;
END;
NameMacroFile = "mmtcf_j_post.mac";