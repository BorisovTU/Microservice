/*
$Name: mmchrate.mac      
$Module: ŒŠ
$Description: ‘¥à¢¨á­ ï ®¯¥à æ¨ï: ƒàã¯¯®¢®¥ ¨§¬¥­¥­¨¥ áâ ¢®ª
*/

IMPORT RsbDataSet, mmservop, globals, mmcateg, mmlb_j, mmcnst_j, "sp_class.mac", "vaacc.mac", "mmcateg.mac", mmlib;

private const SHEET_MAIN = "à®â®ª®« 260620";

private class CRecData()
   var A01, A02, A03, A04, A05, A06, A07, A08, A09, A10,
       A11, A12, A13, A14;

   macro Clear()
      A01 = A02 = A03 = A04 = A05 = A06 = A07 = A08 = A09 = A10 =
      A11 = A12 = A13 = A14 = "";
   end;
end;

private class (DL_CReportTemplate) ChRateReport( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, OperID:INTEGER )
   private var 
   m_RS, m_IsDataExist = false,
   m_RecData:CRecData = CRecData(),
   OprServDoc,
   ProcessedObj = TArray;

   macro DataExist()
      return (m_IsDataExist or ReportHasError());
   end;

   macro PrintMode():INTEGER
      return DL_OUTREPORT_EXCEL;
   end;

   private macro PrintHeader()
      var CommDate = "„ â  ®¯¥à æ¨¨: ", RateDate = "„ â  ­ ç «  ¤¥©áâ¢¨ï ­®¢®© áâ ¢ª¨ ’: ";
      CommDate = CommDate + string(OprServDoc.rec.CommDate);
      PrintFormatString( "",
                         "N2_CommDate", CommDate
                       );
      RateDate = RateDate + string(OprServDoc.rec.RateDate);
      PrintFormatString( "",
                         "N3_RateDate", RateDate
                       );
   end;

   private macro BReport()
      SetActiveSheet( SHEET_MAIN );
      PrintHeader();

      RegisterTable( "N1_MainTable", "",
                     "N1_A01",       "N1_A02",       "N1_A03",       "N1_A04",       "N1_A05",       "N1_A06",
                     "N1_A07",       "N1_A08",       "N1_A09",       "N1_A10",       "N1_A11",       "N1_A12",
                     "N1_A13",       "N1_A14"
                   );
   end;

   private macro EReport()
      EndTable();
   end;

   private macro PrintData()
      PrintTableLine( "N1_A01",   m_RecData.A01,      null,
                      "N1_A02",   m_RecData.A02,      null,
                      "N1_A03",   m_RecData.A03,      null,
                      "N1_A04",   m_RecData.A04,      null,
                      "N1_A05",   m_RecData.A05,      null,
                      "N1_A06",   m_RecData.A06,      null,
                      "N1_A07",   m_RecData.A07,      null,
                      "N1_A08",   m_RecData.A08,      null,
                      "N1_A09",   m_RecData.A09,      null,
                      "N1_A10",   m_RecData.A10,      null,
                      "N1_A11",   m_RecData.A11,      null,
                      "N1_A12",   m_RecData.A12,      null,
                      "N1_A13",   m_RecData.A13,      null,
                      "N1_A14",   m_RecData.A14,      null
                    );
   end;

   PRIVATE MACRO PartyName(ID)
      if (ID == 0)
        return {Name_Bank};
      end;
      var party = TBfile("party");
      party.KeyNum = 0;
      party.rec.PartyID = ID;
      if( not GetEq(party) )
        return ID;
      else
        return party.rec.Name;
      end;
   END;

   private macro FillLine(DealInfo)
      m_RecData.Clear();
      var deal_pd = MMFirstDoc(DealInfo.ObjID, DealInfo.ObjN, true);

      m_RecData.A01 = deal_pd.GetGenAgr().Code;
      if (deal_pd.GetTick().ParentId > 0)
        var CredLn = TBFile("dl_tick");
        CredLn.KeyNum = 0;
        CredLn.rec.DealId = deal_pd.GetTick().ParentId;
        if (CredLn.GetEQ())
            m_RecData.A02 = CredLn.rec.DealCode;
        end;
      end;
      m_RecData.A03 = deal_pd.GetTick().DealCode;
      m_RecData.A04 = deal_pd.GetTick().DealDate;
      if (isSale(GetOperationGroup(deal_pd.GetTick().DealType)))
        m_RecData.A05 = "";
      else
        m_RecData.A05 = "";
      end;
      m_RecData.A06 = PartyName(deal_pd.GetTick().PartyID);
      m_RecData.A07 = deal_pd.GetLeg().Principal;
      m_RecData.A08 = "‘â ­¤ àâ­ ï";
      m_RecData.A09 = DealInfo.OldVal;
      m_RecData.A10 = DealInfo.NewVal;
      m_RecData.A11 = deal_pd.GetLeg().Start;
      m_RecData.A12 = deal_pd.GetLeg().Maturity;
      m_RecData.A13 = deal_pd.GetLeg().Duration;

      //m_RecData.A14 = deal_pd.GetLeg().Cost;
      m_RecData.A14 = MM_GetCalcPercent(deal_pd.GetTick().DealID, deal_pd.GetLeg().Start, deal_pd.GetLeg().Maturity);
   end;

   private macro PrintMMARK()
   
      var header = "", NRecs = 0, Current = 0, cmd;
      VAR Res = TRsbDataSet("SELECT t_docid, t_dockind, t_prevrate " +
                        "FROM dmmsvopobj_dbt " +
                        "WHERE t_svopid = " + OprServDoc.rec.DocumentID + " AND t_svopdockind = " + 218);
      while (Res.MoveNext)
         ProcessedObj[ProcessedObj.size] = ProcObj(OprServDoc.rec.CommCode, Res.DocKind, Res.DocID, OprServDoc.rec.Rate, Res.PrevRate, 0);
      end;

      for (var item, ProcessedObj)
         FillLine(item);
         PrintData();
      end;

   end;

   private macro Create()
      BReport();
      PrintMMARK();
      EReport();
   end;

   if( ValType(OperID) != V_UNDEF )
      OprServDoc = TBFile("dl_comm.dbt");
      OprServDoc.rec.DocumentID = OperID;
      OprServDoc.GetEQ();
   else
      OprServDoc = GetOprServDoc();
   end;
   initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode );
end;

/*¥ç âì ®è¨¡®ª**************************************************************************/
MACRO PrintReportError(_ErrorArray)
    VAR 
        idx = 0,
        cntError = _ErrorArray.Size;

    AddSvOpReportLine("ÚÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿");
    AddSvOpReportLine("³    Š®¤     ³    ®¬¥à á¤¥«ª¨    ³  ü   ³               ‘®®¡é¥­¨¥                                                                 ³");
    AddSvOpReportLine("³  ®¯¥à æ¨¨  ³                    ³®è¨¡ª¨³                                                                                         ³");
    AddSvOpReportLine("ÃÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´");

    while (idx < cntError)
        AddSvOpReportLine("³" +
                           string(_ErrorArray[idx].OpCode:12)  + "³" + 
                           string(_ErrorArray[idx].ObjCode:20) + "³" +  
                           string(_ErrorArray[idx].NumErr:6)   + "³" +  
                           string(_ErrorArray[idx].StrErr:89)  + "³"  );
        idx = idx + 1;
    end;

    AddSvOpReportLine("ÀÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ");

    return true;
END;


MACRO PrintReportFromOp(OpID)
   var report = ChRateReport(null, "Report_GroupChRate.xls", true, false, null, OpID);
   report.Run();

   var DataFound = report.DataExist();

   Dl_CallInsertStat(report.PrintMode());

   if(report.GetFullReportFileNames().size > 0)
      return report.GetFullReportFileNames()[0];
   else
      return "";
   end;
END;

MACRO PrintReport()
    //var DataFound = false;
    //DL_ChRate_Report(DataFound);
    PrintReportFromOp(NULL);

    return true;
END;

/****************************************************************************************/
MACRO OpFilter(_OprServDoc, _DealID)
    var fd = MMFirstDoc(DL_IBCDOC, _DealID),
        Ok = true;

    record comm( dl_comm);
    SetBuff(comm, _OprServDoc);

  return Ok;
END;

//PrintReport();
