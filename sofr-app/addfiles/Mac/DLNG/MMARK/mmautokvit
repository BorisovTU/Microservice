/*
$Name:             mmautokvit.mac
$Module:           МБК
$Description:      Автоквитовка входящих платежей
*/
IMPORT BankInter, MMarkInter, RSD, RsbDataSet, globals,fx_globals;
PRIVATE VAR dialog_flag;
        var  ddealid;

/*MACRO ins(DealID, PlanPaymID, FactPaymID, KvitAmount)
    var ins = RSDCommand("insert into dmm_kvit_tmp (t_dealid, t_planpaymid, t_factpaymid, t_kvitamount) values (?,?,?,?)");
    ins.addParam("", RSDBP_IN, DealID);
    ins.addParam("", RSDBP_IN, PlanPaymID);
    ins.addParam("", RSDBP_IN, FactPaymID);
    ins.addParam("", RSDBP_IN, KvitAmount);
    ins.execute();
END;     */

MACRO ClearKvit()
    RSDCommand("TRUNCATE TABLE dmm_kvit_tmp").execute();
END;   

MACRO InsKvit(DealID, PlanPaymID, FactPaymID, KvitAmount)
    VAR ins = RSDCommand("INSERT INTO dmm_kvit_tmp (t_dealid, t_planpaymid, t_factpaymid, t_kvitamount) VALUES (?, ?, ?, ?)");
    ins.addParam("", RSDBP_IN, DealID);
    ins.addParam("", RSDBP_IN, PlanPaymID);
    ins.addParam("", RSDBP_IN, FactPaymID);
    ins.addParam("", RSDBP_IN, KvitAmount);
    ins.execute();

    //PRINTLN("DealID: " + DealID + "; PlanPaymID: " + PlanPaymID + "; FactPaymID: " + FactPaymID + "; KvitAmount: " + KvitAmount);
END;

MACRO prep()

   private var ppaymentid,fpaymentid,factsum,da,tip,rs51,rs5,que,delta,VARI;

    RSDCommand("truncate table dmm_kvit_tmp").execute();

      ddealid=_NDEALID;
      tip=_DCODE;
      VARI=0;
      if ( tip > 100 )
        tip=tip-100;
        VARI=1;
      end;
      da=_DDATE;
      delta=_NAL;
      // delta=0;

      que= "select count(*) from ddl_tick_dbt a , dpmpaym_dbt b,dpmpaym_dbt bb where a.t_dealid="+ddealid+" and b.t_dockind=102 and b.t_documentid=a.t_dealid ";
      que=que+" and b.t_paymstatus < 32000  and b.t_purpose="+tip+" and b.t_valuedate='"+da+"'  and bb.t_dockind=322 and bb.t_fiid=b.t_fiid  and bb.t_paymstatus=2995 and bb.t_tobackoffice='J'";

      if ( VARI == 1 )
        que=que+" and bb.t_baseamount=b.t_baseamount-"+delta+" and (bb.t_PAYER=b.t_PAYER or  bb.t_PAYERBANKID=b.t_PAYER) and  bb.t_valuedate= b.t_valuedate ";
      else
        que=que+" and bb.t_baseamount=b.t_baseamount-"+delta+" and bb.t_receiveraccount=b.t_receiveraccount and  bb.t_valuedate= b.t_valuedate ";
      end;
      // msgbox(que);
      rs51 = LnGetRecordSet(que);
      if(rs51 != null)
        if (rs51.moveNext) 
          if ( rs51.value(0) > 0 )
// --
             que= "select b.t_paymentid,bb.t_paymentid, b.t_baseamount  from ddl_tick_dbt a , dpmpaym_dbt b,dpmpaym_dbt bb where a.t_dealid="+ddealid+" and b.t_dockind=102 and b.t_documentid=a.t_dealid ";
             que=que+" and b.t_paymstatus < 32000  and b.t_purpose="+tip+" and b.t_valuedate='"+da+"'  and bb.t_dockind=322 and bb.t_fiid=b.t_fiid  and bb.t_paymstatus=2995 and bb.t_tobackoffice='J'";

            if ( VARI == 1 )
             que=que+" and bb.t_baseamount=b.t_baseamount-"+delta+" and (bb.t_PAYER=b.t_PAYER or  bb.t_PAYERBANKID=b.t_PAYER) and  bb.t_valuedate= b.t_valuedate ";
            else
             que=que+" and bb.t_baseamount=b.t_baseamount-"+delta+" and bb.t_receiveraccount=b.t_receiveraccount and  bb.t_valuedate= b.t_valuedate ";
            end;

             rs5 = LnGetRecordSet(que);
             if(rs5 != null)
               if (rs5.moveNext) 
                  ppaymentid=rs5.value(0);
                  fpaymentid=rs5.value(1);
                  factsum = rs5.value(2);
                   // msgbox(factsum);
                  inskvit(ddealid, ppaymentid,fpaymentid, Money(factsum));    //vlv

               end;
             end;
//--
          end;
        end;
     end;
END;

MACRO post()
ClearKvit();
    //RSDCommand("truncate table dmm_kvit_tmp").execute();
    // println("Success");
//    SetDialogFlag(dialog_flag);
    exit(1);
END;

MACRO err(deailid, err_num)
    // println("Error: " + err_num + "; DealID: " + deailid);
END;

