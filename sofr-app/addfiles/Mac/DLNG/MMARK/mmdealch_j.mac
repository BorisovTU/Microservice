/*
$Name:        mmdealch_j.mac
$Module:      МБ Кредиты
$Description: макрос выполнения шага "Изменение условий сделки"
*/

IMPORT MmarkInter, mmlibr, "globals.mac";

PRIVATE VAR
    ID_Operation = 0,
    ID_Step      = 0,
    ExecDate;

record MMDEALCH ("mmdealch");

MACRO ExecuteStep(Buffer, Document, DocKind, IDOperation, IDStep)
    var deal_pd, OD_new = "";
    record deal( dl_tick );

    ID_Operation = IDOperation;
    ID_Step      = IDStep;

    setbuff(deal, Document);

    deal_pd = MMFirstDoc(DL_IBCDOC, deal.DealID, false);
    // получим новый счет по ОД
    deal_pd.leg.rec.Start = MMDEALCH.NewStDate;
    deal_pd.leg.rec.Maturity = MMDEALCH.NewMaturityDate;
    deal_pd.leg.rec.Duration = deal_pd.leg.rec.Maturity - deal_pd.leg.rec.Start;
    deal_pd.ReInit(false);
    deal_pd.ActualCheckPeriod(tdr_rest(deal_pd.GetTick().FlagTypeDeal), OD_new, NULL, deal_pd.GetFIRoleByCategory(tdr_rest(deal_pd.GetTick().FlagTypeDeal), deal_pd.GetLeg().PFI),
                                    NULL, MMDEALCH.ChDate, deal_pd.GetLeg().PFI);
    if (OD_new == "") 
        mm_error("Ошибка при получении счета по ОД");
        return 1; 
    end; 

    var stat = UpdateAccInPayment(deal_pd, OD_new, tdr_rest(deal_pd.GetTick().FlagTypeDeal));
    if (stat == 1)
        mm_error("Ошибка при обновлении платежей"); 
        return 1;
    elif (stat == 2)
        return 1;
    end;   

    MM_ChangeDealTermOp(MMDEALCH);

    return 0;
END;

NameMacroFile = "mmdealch_j.mac";
