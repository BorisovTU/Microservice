/*--------------------------------------------------------------------------------------*/
/*  Имя файла        : mmrevaltcc.mac                                                   */
/*                                                                                      */
/*  Описание         : Сервисная операция: Переоценка по ТСС                            */
/*                                                                                      */
/*  Программист      : Куперин М.В.                                                     */
/*                                                                                      */
/*  Создан           : 12.01.2010                                                       */
/*--------------------------------------------------------------------------------------*/
IMPORT RsbDataSet, FIInter, mmservop, globals;
///****************************************************************************************/
PRIVATE VAR
    _Errors = TArray();

/*Печать ошибок****************************************************************************/
MACRO PrintReportError(_ErrorArray)
    _Errors = _ErrorArray;
    return false;
END;
///*Печать результатов работы**************************************************************/
PRIVATE MACRO ToDate(Date)
    if (ValType(Date) == V_DATE)
        Date = String(Date:10:f);
    end;

    return Date;
END;

MACRO PrintReport()
    VAR DataSet  = NULL,
        QueryStr = "", 
        idx      = 0,
        cntError = _Errors.Size;

    if (GetOprServDoc().rec.flag7 == "")
        QueryStr = 
                   "select 'По договорам' as name, ";
    else
        QueryStr = 
                   "select 'По предметам залога' as name, ";
    end;

    QueryStr = QueryStr +
                "alg.t_sznamealg, decode(comm.t_flag6, 'X', 'Установлен', 'Не установлен') as flag6, ";

    if (GetOprServDoc().rec.ClientID > 0)
        QueryStr = QueryStr + "partcode.t_code, party.t_shortname, ";
    else
        QueryStr = QueryStr + "' ' as code, ' ' as shortname, ";
    end;

    if (GetOprServDoc().rec.Reserve != "")
        QueryStr = QueryStr + "comm.t_reserve, ";
    else
        QueryStr = QueryStr + "' ' as reserve, ";
    end;

    if (Date(GetOprServDoc().rec.BeginDate) != Date(0, 0, 0))
        QueryStr = QueryStr + "comm.t_begindate, ";
    else
        QueryStr = QueryStr + "' ' as begindate, ";
    end;

    if (GetOprServDoc().rec.AvoirKind > -1)
        QueryStr = QueryStr + "avr.t_avoirkind, avr.t_name as avrname, fininstr.t_fi_code, fininstr.t_name as fininstrname ";
    else
        QueryStr = QueryStr + "' ' as avoirkind, ' ' as avrname, ' ' as fi_code, ' ' as fininstrname ";
    end;

    QueryStr = QueryStr + "from ddl_comm_dbt comm, dnamealg_dbt alg";

    if (GetOprServDoc().rec.ClientID > 0)
        QueryStr = QueryStr + ", dparty_dbt party, dpartcode_dbt partcode";
    end;

    if (GetOprServDoc().rec.AvoirKind > -1)
        QueryStr = QueryStr + ", dfininstr_dbt fininstr, davrkinds_dbt avr";
    end;

    QueryStr = QueryStr +
                " where "
                "(comm.t_documentid = " + GetOprServDoc().rec.DocumentID + ")"
                "and(alg.t_itypealg = 2115)and(alg.t_inumberalg = comm.t_value)";

    if (GetOprServDoc().rec.ClientID > 0)
        QueryStr = QueryStr +
                    "and(party.t_partyid = comm.t_clientid)"
                    "and(partcode.t_partyid = party.t_partyid)and(partcode.t_codekind = 1)";
    end;

    if (GetOprServDoc().rec.AvoirKind > -1)
        QueryStr = QueryStr +
                    "and(avr.t_avoirkind = comm.t_avoirkind)";
    end;

    if (GetOprServDoc().rec.FIID > -1)
        QueryStr = QueryStr +
                    "and(avr.t_avoirkind = comm.t_avoirkind)";
    end;


    DataSet = TRsbDataSet(QueryStr);

    if (DataSet.MoveNext())
        AddSvOpReportLine("                                                                                                          ");
        AddSvOpReportLine("                                Протокол операции переоценки по ТСС                                       ");
        AddSvOpReportLine("                                                                                                          ");
        AddSvOpReportLine(" Дата операции: " + String(GetOprServDoc().rec.CommDate:10:l:f) + "                                       ");
        AddSvOpReportLine(" Код операции:  " + String(GetOprServDoc().rec.CommCode:30:l) + "                                         ");
        AddSvOpReportLine("                                                                                                          ");
        AddSvOpReportLine(" Параметры учета:  " + String(DataSet.Name:l:z) + "                                                      ");
        AddSvOpReportLine(" Параметры сделки: " + String(DataSet.SzNameAlg:l:z) + "                                                 ");
        AddSvOpReportLine(" Обеспечение по договору: " + String(DataSet.Flag6:l:z) + "                                              ");
        AddSvOpReportLine(" Параметры договора:                                                                                      ");
        AddSvOpReportLine("     залогодатель: " + String(DataSet.Code:l:z) + "  " + String(DataSet.ShortName:l:z) + "              ");
        AddSvOpReportLine("     номер: " + String(DataSet.Reserve:l:z) + "                                                          ");
        AddSvOpReportLine("     дата:  " + String(ToDate(Date(DataSet.BeginDate)):l:z) + "                                          ");

        if (GetOprServDoc().rec.flag7 == "X")
            AddSvOpReportLine("                                                                                                          ");
            AddSvOpReportLine(" Вид ценной бумаги: " + String(DataSet.AvoirKind:15:l:z) + "  " + String(DataSet.AvrName:l:z) + "       ");
            AddSvOpReportLine(" Код ценной бумаги: " + String(DataSet.Fi_Code:15:l:z) + "  " + String(DataSet.FininstrName:l:z) + "    ");
        end;

        AddSvOpReportLine("                                                                                                          ");

        if (GetOprServDoc().rec.flag7 == "")
            AddSvOpReportLine(" 1. Договора, исключенные из переоценки из-за отсутствия курса (блок выводится при установленном          ");
            AddSvOpReportLine(" параметре учета - по договорам)                                                                          ");
            AddSvOpReportLine("                                                                                                          ");

            idx = 0;
            while (idx < cntError)
                if (_Errors[idx].ObjCode == 1)
                    AddSvOpReportLine(_Errors[idx].StrErr);
                end;			
            end;
        else
            AddSvOpReportLine(" 1. Ценные бумаги, исключенные из переоценки из-за отсутствия курса (блок выводится при                   ");
            AddSvOpReportLine(" установленном параметре учета - по предметам залога)                                                     ");
            AddSvOpReportLine("                                                                                                          ");

            idx = 0;
            while (idx < cntError)
                if (_Errors[idx].ObjCode == 2)
                    AddSvOpReportLine(_Errors[idx].StrErr);
                end;			
            end;
        end;

        AddSvOpReportLine("                                                                                                          ");
        AddSvOpReportLine(" 2. Реестр проводок по переоценке (блок выводится, если были сформированы проводки по переоценке)          ");
        AddSvOpReportLine("                                                                                                          ");
        AddSvOpReportLine(" ┌────┬──────────────────────┬────────┬──────────────┬─────────────────────┬─────────┬─────────────┐       ");
        AddSvOpReportLine(" │ NN │     Счет дебета      │ Валюта │ Сумма дебета │    Счет кредита     │ Валюта  │Сумма кредита│       ");
        AddSvOpReportLine(" │    │                      │ дебета │              │                     │ кредита │             │       ");
        AddSvOpReportLine(" ├────┼──────────────────────┼────────┼──────────────┼─────────────────────┼─────────┼─────────────┤       ");

        idx = 0;
        QueryStr = 
                    "select arh.t_account_payer, "
                    "arh.t_fiid_payer as t_code_currency_payer, "
                    "arh.t_sum_payer as t_sum_payer, "
                    "arh.t_account_receiver, "
                    "arh.t_fiid_receiver as t_code_currency_receiver, "
                    "arh.t_sum_receiver as t_sum_receiver, "
                    "arh.t_ground "
                    "from dacctrn_dbt arh, doprdocs_dbt oprdoc "
                    "where "
//                    "((oprdoc.t_status = 1)or(oprdoc.t_status = 2))"
//                    "and"
                    "(oprdoc.t_acctrnid = arh.t_acctrnid)"
                    "and(oprdoc.t_servdockind = 184)"
                    "and(oprdoc.t_servdocid = " + GetOprServDoc().rec.DocumentID + ")";

        DataSet = TRsbDataSet(QueryStr);

        while (DataSet.MoveNext())
            if (idx > 0)
                AddSvOpReportLine(" ├────┼──────────────────────┬────────┬──────────────┬─────────────────────┬─────────┬─────────────┤       ");
            end;

            AddSvOpReportLine(" │" +
                                     String((idx + 1):4:c)                                               + "│" +
                                     String(DataSet.Account_Payer:22)                                  + "│" + 
                                     String(ПолучитьКодФинИн(Int(DataSet.Code_Currency_Payer)):8:c)    + "│" + 
                                     String(Money(DataSet.Sum_Payer):14)                               + "│" + 
                                     String(DataSet.Account_Receiver:21)                               + "│" + 
                                     String(ПолучитьКодФинИн(Int(DataSet.Code_Currency_Receiver)):9:c) + "│" + 
                                     String(Money(DataSet.Sum_Receiver):13)                            + "│       ");
            AddSvOpReportLine(" │    ├──────────────────────┴────────┴──────────────┴─────────────────────┴─────────┴─────────────┤       ");
            AddSvOpReportLine(" │    │" + String(DataSet.Ground:92) +                                                           "│       ");

            idx = idx + 1;
        end;

        if (idx > 0)
            AddSvOpReportLine(" └────┴────────────────────────────────────────────────────────────────────────────────────────────┘       ");
        else
            AddSvOpReportLine(" └────┴──────────────────────┴────────┴──────────────┴─────────────────────┴─────────┴─────────────┘       ");
        end;

        AddSvOpReportLine("                                                                                                           ");
        AddSvOpReportLine(" Операционист: " + String({oper}) + "  " + String({Name_Oper}) + "                                      ");
    else
        AddSvOpReportLine("  Ошибка при определении экземпляра номера операции.                                                       ");
    end;

    return true;
END;
/****************************************************************************************/
MACRO OpFilter(_OprServDoc, _DocID)
    return true;
END;
