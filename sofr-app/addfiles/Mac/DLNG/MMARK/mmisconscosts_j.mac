/*
$Name:        mmisconscosts_j.mac
$Module:      МБ Кредиты
$Description: макрос выполнения шага "Учитывать затраты?"
*/

IMPORT PTInter, mmlibr, mmservop;

PRIVATE MACRO НужноУчитыватьЗатраты(DocID, DocKind, DealDate, DocParty)
    var PartyCode, sel, res, ContrID = 0;
    PartyCode = ПолучитьКодСубъекта(DocParty, PTCK_CONTR);

    if (DocKind == DL_IBCDOC)
        sel = RSDCommand("select t_id from dsfcontr_dbt where t_object = ? and t_dateconc <= ?");
        sel.addParam("", RSDBP_IN, PartyCode);
        sel.addParam("", RSDBP_IN, DealDate);  
        sel.execute();
        res  = TRsbDataSet(sel);
        if (res.MoveNext())
            ContrID = res.ID;
        else
            return false;
        end;
    end;
    // шаг уже был выполнен

    if (StepIsExecute(DocID, DocKind, "я"))
        return false;
    end;

    sel = RSDCommand("select 1 from ddlcomis_dbt where t_dockind = ? and t_docid = ?");
    sel.addParam("", RSDBP_IN, DocKind);
    sel.addParam("", RSDBP_IN, DocID);    
    sel.execute();
    res  = TRsbDataSet(sel);
    if (res.MoveNext())
        return true;
    end;
/*
    sel = RSDCommand("select 1 from dsfconcom_dbt where t_sfplanid = ?");
    sel.addParam("", RSDBP_IN, ContrID);
    sel.execute();
    res  = TRsbDataSet(sel);
    if (res.MoveNext())
        return true;
    end;  
*/
    return false;
END;

/*----------------------------------------------------------------------------
    Выполнение шага
----------------------------------------------------------------------------*/
macro ExecuteCaseStep(Kind_Operation, Number_Step, primdoc, KindDoc)
    record deal (dl_tick);
    record sfcontr(sfcontr);
    
    //SetBuff(tick, primdoc);

    var OprServDoc = GetOprServDoc(), DocID, DocParty, DealDate;
    // учет прочих доходов пока не поддерживается
    if (OprServDoc.rec.ComType == 2)
        return 0;
    end;

    if (KindDoc == DL_IBCDOC)
        SetBuff( deal, primdoc );
        DocID    = deal.DealID;
        DocParty = deal.PartyID;
        DealDate = deal.DealDate;

    else
        SetBuff( sfcontr, primdoc );
        DocID   = sfcontr.ID;
    end;

    if (НужноУчитыватьЗатраты(DocID, KindDoc, DealDate, DocParty) and MM_CheckLic())
        return "920";
    end;

    return 0;
END;

NameMacroFile = "mmisconscosts_j.mac";
