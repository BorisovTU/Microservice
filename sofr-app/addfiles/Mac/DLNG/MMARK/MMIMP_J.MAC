/*
$Name:        mmimp_j.mac
$Module:      МБ Кредиты
$Description: макрос выполнения шага "Изменение параметров Обесценения"
*/
/*-------------------------------------------------------------------------
  Имя файла        : mmimp_j.mac

  Описание         : Макрос выполнения шага "Изменение параметров Обесценения"

  Программист      : Врубель В.Л.

  Создан           : 28.09.2018
-------------------------------------------------------------------------*/
IMPORT OprInter, mmcnst_j, mmlibr, mmlib, mmlb_j, mmcarry;

PRIVATE record mmhstimp("mmhstimp");  // заполняется из кода

PRIVATE VAR FirstDoc = NULL;

MACRO ExecuteStep(Buffer, Document)
   var
      stat = true, ExecDate = NULL,
      cmd = "", rs = NULL,
      ККС = 1, ПР = 0,
      GQmode = NULL, КонтрольПКР = 0,
      RiskChgMode = 0, GoodQuality = 0,
      ТребПросрочВб = 0, ТребСрочВб = 0,
      error = "", StepDate;

   record deal(dl_tick);

   SetBuff( deal, Document);

   IF (NOT MM_CheckLic())
      RETURN 1;
   END;

   FirstDoc = MMFirstDoc(deal.BOfficeKind, deal.DealID, true);

   ExecDate = {curdate};

   if (not IsSALE(deal.DealGroup))
       mm_error("Операция разрешена только для сделок размещения");
       return 1;
   end;

   cmd = "select 1 "
          "from dmmhstimp_dbt "
          "where t_dealid = " + deal.DealID + " and t_impgrade = " + mmhstimp.ImpGrade + 
          " and t_percloss = " + mmhstimp.PercLoss + " and t_date in "
          "(select max(t_date) from dmmhstimp_dbt where t_dealid = " + deal.DealID + ")";

   rs = RsdRecordset(cmd);

   if (rs.MoveNext())
       mm_error("Не было внесено никаких изменений");
       return 1;
   end;

   if (mmhstimp.Date < ExecDate)
        mm_error("Дата изменения не может быть меньше даты текущего опер. дня");
        return 1;
   end;

   if (GetDateStepBySymb(deal.DealID, deal.BOfficeKind, "И", StepDate))
       if (mmhstimp.Date <= StepDate)
            mm_error("Дата изменения должна быть больше даты исполнения шага <Изменение параметров обесценения>");
            return 1;
       end;
   end;

   if (GetDateStepBySymb(deal.DealID, deal.BOfficeKind, "ф", StepDate))
       if (mmhstimp.Date <= StepDate)
            mm_error("Дата должна быть больше даты шага <Формирование резерва>");
            return 1;
       end;
   end;

   // Вставляем запись в таблицу dlreslnk.dbt
   if (not MM_InsertMMHSTIMP(mmhstimp))
       return 1;
   end;

   return 0;
END;

NameMacroFile = "mmimp_j.mac";