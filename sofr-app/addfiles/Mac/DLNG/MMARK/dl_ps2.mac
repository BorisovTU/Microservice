import InsCarryDoc, funk,CurrInter, Проценты, MmarkInter, mmlibr, mmcarry, mmcnst_j, mmplib, dl_lib,calculate;
import dl_guarantee_mbk;

PRIVATE FILE leg (dl_leg);
// PRIVATE FILE pm ("pmpaym") key 1 write;
PRIVATE RECORD tick (dl_tick);


/*----------------------------------------------------------------------------
    Выполнение шага
----------------------------------------------------------------------------*/
MACRO ExecuteStep(Buffer, Document)
  var deal_pd ,acc0, acc2, acc0p, s_addground, nrate, vsum, vsum2,sground,que,rs4,rs5,nnka,acc9,nnn,i0,i1,rs9,nfiid;
  var  at  = MM_Carry;
  var  atp = MM_Carry;

  SetBuff (tick,Document);
  DL_PrepareCarryBuffer (Buffer);
  leg.LegKind = LEG_KIND_DL_TICK;
  leg.DealID = tick.DealID;
  leg.LegID = 1;

  if (not GetEq(leg))
    mm_error ("Не найден транш сделки");
    return 1;
  end;

  deal_pd = MMFirstDoc(DL_IBCDOC, tick.DealID, true);
  s_addground = GetGroundAddPart(tick);

  nfiid=0;
  que="select  b.t_cost amount , c.t_avoirkind avoirkind, c.t_fiid fiid, c.t_fi_kind  from ddl_grnt_dbt a , ddl_secur_dbt b, dfininstr_dbt c where t_dealid="+tick.DealID+" and b.t_contractid=a.t_contractid and c.t_fiid=b.t_fiid order by t_numsecinorder";
  rs9 = LnGetRecordSet(que);
  if(rs9 != null)
    while(rs9.moveNext())
      if ( rs9.value("avoirkind") == 5 )
        nfiid=rs9.value("fiid");
        execmacrofile("dl_va30.mac", "zfinish",nfiid) ;
        msgbox("В модуле 'Учтенные векселя' выведен залог по сделке !");
        return 0;
      elif (rs9.value("t_fi_kind") == 2 )

        //обработка действий по интеграции с БОЦБ
        //Если существует незакрытая операция перевода обеспечения с подвидом "передача", то не даём выполнить шаг
        if (Check_exists_guarantee_from_mbk(tick.DealID, guarantee_opersubkind_in, 0) or Check_exists_guarantee_from_mbk(tick.DealID, guarantee_opersubkind_in, 1)) 
          MsgBox("В подсистеме БОЦБ есть незакрытая операция перевода обеспечения вида \"передача обеспечения\", привязанная к данной сделке. Дальнейшее выполнение шагов не возможно.");
          return 1;
        else //почему тут сразу return - я не знаю

          if (start_guarantee_from_mbk(tick, guarantee_opersubkind_out)) 
            return 0;
          else
            MsgBox("Не удалось создать операцию перевода обеспечения в БОЦБ");
            return 1;
          end;
        end;
      end;
    end;

    que="select ctg.t_code from dmcaccdoc_dbt ac, dmccateg_dbt ctg where (ac.t_catnum = ctg.t_number and ctg.t_code LIKE '-Обесп. кр., ц/б_K%') and ac.t_dockind=102 and ac.t_docid="+tick.DealID; //MAA: 514764
    rs4 = LnGetRecordSet(que);
    if(rs4 != null)
      while (rs4.moveNext) 
        acc9="0";

        nnka=rs4.value(0);
        que="select a.t_account, c.t_nameaccount, a.t_currency from dmcaccdoc_dbt a, dmccateg_dbt b, daccount_dbt c where c.t_account=a.t_account and a.t_dockind=102 and a.t_docid="+tick.DealID+" and b.t_id=a.t_catid and b.t_code='"+nnka+"'";
        rs5 = LnGetRecordSet(que);
        if(rs5 != null)
          if (rs5.moveNext) 
             acc0=rs5.value(0);
			 nfiid=rs5.value(2);
             vsum=abs(RestA_(acc0, {curdate}, 3, nfiid));
             sground="Списание с учета выданного залога - "+rs5.value(1);
             nnn= rs5.value(1);
    
             i0=index(nnn,"Обеспечение");
             if (i0 > 0 )
                nnn=substr(nnn,13);
             end;

             nnn=strsubst(nnn,"","");
			 
			 sground="Списание суммы обеспечения "+nnn + ", в связи с полным погашением ссудной задолженности, по распоряжению ДОФР № от "+SDAT({curdate})+".";

            /*
            Корректировка суммы обеспечения КД от 18.09.2014 №140200/0048
            (транш № 24) ОАО "Токаревская птицефабрика",в связи с плановым полным погашением ссудной задолженности 25.02.2019.  
            */
          end;
        end;
        if ( acc0 != acc9 )
    
          if(not deal_pd.OpenAccount("ВнебалСчетКорресп0", acc2, NULL, deal_pd.GetFIRoleByCategory("ВнебалСчетКорресп", deal_pd.GetLeg().PFI), NULL, deal_pd.GetTick().DealDate, deal_pd.GetLeg().PFI))
              return 1;
          end;   
      //          at.Numb_Document = execmacrofile("fx_lib", "MakeNumber0");
          at.AccountPayer    = acc2;	  
          at.AccountReceiver = acc0;
          at.FIIDPayer       = leg.pfi;
          at.FIIDReceiver    = nfiid;
          at.SumPayer        = null;
          at.SumReceiver     = vsum;
          at.Chapter         = 3;
          at.Ground          = sground;
          if(not at.carry())
            msgbox("Error !");
            return false;
          end;
        end;
        acc9=acc0;
      end;
    end;
  end;

  return 0;
end;

MACRO CheckStepAction( mes:integer, Document ):integer
  var stat = 0;

  if( mes == OP_BACKOUT_STEP )
    SetBuff (tick,Document);
    if (Check_exists_guarantee_from_mbk(tick.DealID, guarantee_opersubkind_out))
      MsgBox("Нельзя откатывать шаг операции. В БОЦБ существует Перевод обеспечения, привязанный к данной сделке");
      stat = 1;
    end;
  end;
 
  return stat;
END;