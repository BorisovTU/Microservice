/*
$Name:        mmprmdisref_j.mac
$Module:      МБ Кредиты
$Description: макрос выполнения шага "Отражение расходов/доходов от дисконта/премии"
*/

IMPORT mmlibr, mmcarry, mmlib, mmlb_j;

PRIVATE VAR
    ID_Operation = 0,
    ID_Step      = 0;

PRIVATE VAR ExecDate;

/*----------------------------------------------------------------------------
    Выполнение шага
----------------------------------------------------------------------------*/
MACRO ExecuteStep(Buffer, Document, DocKind, IDOperation, IDStep)
   record deal( dl_tick );
   SetBuff( deal, Document );

   ID_Operation = IDOperation;
   ID_Step      = IDStep;

   ExecDate = {curdate};

   var stat = true, deal_pd, Sпрем, Sдиск, at = MM_Carry, OldVal = $0;
   deal_pd = MMFirstDoc(DL_IBCDOC, deal.DealID, true);

   at.Chapter          = 1;
   at.date_carry       = ExecDate;
   at.PrimaryDoc       = deal_pd;  

   Sпрем = MM_CalcPrize(deal_pd.GetTick().BOfficeKind, deal_pd.GetTick().DealID, ExecDate, 0);
   if (Sпрем > 0)
      at.CatPayer     = tdr_prizeexp;
      at.CatReceiver  = get_prize_cm(ExecDate);
      at.FIIDPayer    = NATCUR;
      at.FIIDReceiver = deal_pd.getLeg().PFI;
      at.SumReceiver  = Sпрем;
      at.Ground = "Отражение процентных расходов от премии";

      OldVal = ПолучитьЗначениеПримечания(OBJTYPE_MMARKDEAL, UniID(deal, OBJTYPE_MMARKDEAL), 16/*MN_PRIZE*/, ExecDate);
      MM_ChangeNoteText(OBJTYPE_MMARKDEAL, UniID(deal, OBJTYPE_MMARKDEAL), 16/*MN_PRIZE*/, ExecDate, Money(OldVal - Sпрем));
   end;
   if (stat)
      Sдиск = MM_CalcDiscount(deal_pd.GetTick().BOfficeKind, deal_pd.GetTick().DealID, ExecDate, 0);
      if (Sдиск > 0)
         at.CatPayer     = get_discount_cm(ExecDate);
         at.CatReceiver  = tdr_perc1R;
         at.FIIDPayer    = deal_pd.getLeg().PFI;
         at.FIIDReceiver = NATCUR;
         at.SumPayer     = Sдиск;
         at.Ground = "Отражение процентных доходов от дисконта";

      OldVal = ПолучитьЗначениеПримечания(OBJTYPE_MMARKDEAL, UniID(deal, OBJTYPE_MMARKDEAL), 17/*MN_DISCOUNT*/, ExecDate);
      MM_ChangeNoteText(OBJTYPE_MMARKDEAL, UniID(deal, OBJTYPE_MMARKDEAL), 17/*MN_DISCOUNT*/, ExecDate, Money(OldVal - Sдиск));
      end;
   end;
   
   if (not at.Carry())
      return 1;
   end;

   RETURN 0;
END;

NameMacroFile = "mmprmdisref.mac";