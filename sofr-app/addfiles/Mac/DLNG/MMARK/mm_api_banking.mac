/*
$Name:        mm_api_banking.mac
$Module:      МБ Кредиты
$Description: API-функции межбанковского кредитования
*/

import total, RsbDataSet, RSD;

MACRO MM_API_CheckDeals(DealID, PaySum, FIID)
    VAR query = " SELECT leg.T_PRINCIPAL AS Amount, " +
                " leg.T_PFI AS FIID, " + 
                " tick.T_REGDATE AS openDate " +
                " FROM ddl_tick_dbt tick, ddl_leg_dbt leg" + 
                " WHERE tick.t_dealid = leg.t_dealid and tick.t_dealid = ? ";

    VAR RSC = RSDCommand(query);
    RSC.addparam("", RSDBP_IN, DealID);
    VAR RS = TRSBDataSet(RSC);

    VAR stat = 0;
    RS.MoveNext;
    if (RS.FIID != FIID) return 8723; end;
    if (RS.Amount < PaySum) return 8724; end;
    if (RS.openDate > date) return 8725; end;
    return stat;
END;
