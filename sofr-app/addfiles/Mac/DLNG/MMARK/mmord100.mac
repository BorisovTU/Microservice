/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 5.1                                          R-Style Software Lab

  File Name   : mmord100.mac
                                mm-МБК
                                ord-Сопровождение соглашения о залоге
                                100-номер (соответствующий шагу)
  Операция    : СоглЗалМБК
  Шаг         : Закрытие договора
  Comment     :
└───────────────────────────────────────────────────────────────────────────*/
import mmlibr;

/*const DL_MMPAWN = 126,
      DL_IBCDOC = 102;*/
      
record Договор("dl_order");

/* Запуск шага */
MACRO ExecuteStep(docbuf, ordbuf)
var secur = TBFile("dl_secur.dbt"), stat;

    SetBuff( Договор, ordbuf );


    secur.KeyNum = 0;
    secur.rec.ContractKind = DL_MMPAWN;
    secur.rec.ContractID = Договор.ContractID;
    secur.rec.FIID = -1;
    stat = secur.GetGT;
    while( stat ) 
    	if( secur.rec.Used != 0 )
	        mm_error("Обнаружены ц/б в залоге");
            return 1;/*false;*/
    	end;
  	    stat = secur.next;
    end;

    secur.KeyNum = 0;
    secur.rec.ContractKind = DL_IBCDOC;
    secur.rec.ContractID = 0;
    secur.rec.FIID = -1;
    stat = secur.GetGT;
    while( stat ) 
          if( secur.rec.GeneralContract == Договор.ContractID ) 
         	  if( secur.rec.Used != 0 )
     	          mm_error("Обнаружены ц/б в залоге");
                  return 1;/*false;*/
        	  end
          end;	
    	  stat = secur.next;
    end;

    return 0;/*true;*/
END;


/* Макрос постобработки */
MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

var oproper = TBFile("oproper.dbt"),
    order = TBFile("dl_order.dbt","W"),
    stat;


    if (errTrn OR (CommitOrRollback==2)) 
        /* Произошла ошибка или происходит откат */
        return;
    else
     oproper.KeyNum = 0;
     oproper.rec.Id_Operation = ID_Operation;
     stat = oproper.GetEQ;
     if (stat!=0 )
        order.KeyNum = 0;
        order.rec.ContractID = int(oproper.rec.DocumentID);
        stat = order.GetEQ;
        if (stat!=0)
            order.rec.closingdate = {curdate};
            order.update;
        end;
     end;
    end;

    return 1;
END;


/* Макрос печати */
MACRO PrintStepDocs (
                ID_Operation,  /* Номер экземпляра операции */
                ID_Step,       /* Номер шага операции */
                Kind_Operation,/* Вид операции */
                KindStep)      /* Вид шага операции */

    return 1;
END;
