import InsCarryDoc, funk,CurrInter, Проценты, MmarkInter, mmlibr, mmcarry, mmcnst_j, mmplib, dl_lib,calculate ;

PRIVATE FILE leg (dl_leg);
PRIVATE RECORD tick (dl_tick);

array mass1,mas2,mas3,mas4,mass;

mass(0)="Списание залога";
mass(1)="Новый залог    ";
mass(2)="Дополнить залог";


var tran,nfiid,rs9;


/*----------------------------------------------------------------------------
    Выполнение шага
----------------------------------------------------------------------------*/
MACRO ExecuteStep(Buffer, Document)
    private var deal_pd ,acc0, acc2, acc0p, s_addground, nrate, vsum, vsum2,sground,que,rs5,rs05,nka=1,ii,nnka,acc9,nnn,i0,ij,{curadte},vari;
    var  at  = MM_Carry;
    var  atp = MM_Carry;
	var status = "";

    vari=menu(mass,"Укажите вариант","Укажите вариант");
    if (vari < 0 )
       return;
    end;


    SetBuff (tick,Document);
    DL_PrepareCarryBuffer (Buffer);
    leg.LegKind = LEG_KIND_DL_TICK;
    leg.DealID = tick.DealID;
    leg.LegID = 1;

    if (not GetEq(leg))
        mm_error ("Не найден транш сделки");
        return 1;
    end;


    deal_pd = MMFirstDoc(DL_IBCDOC, tick.DealID, true);
    s_addground = GetGroundAddPart(tick);

    que="select count(*) from dmcaccdoc_dbt where t_dockind=102 and t_docid="+tick.DealID+"   and ((t_catnum > 5091 and t_catnum < 5102)  or  (t_catnum > 5145 and t_catnum < 5161))   ";
    rs5 = LnGetRecordSet(que);
    if(rs5 != null)
      if (rs5.moveNext) 
         nka=nka+int(rs5.value(0));
      end;
   end;

                                       if (( vari == 0 ) or (vari == 2))

                              ii=1;
                              ij=0;
                              acc9="0";
                              while ( ii < nka)
    nnka="-Обесп. кр., ц/б_K"+string(ii);
    que="select a.t_account, c.t_nameaccount from dmcaccdoc_dbt a, dmccateg_dbt b, daccount_dbt c where c.t_account=a.t_account and a.t_dockind=102 and a.t_docid="+tick.DealID+" and b.t_id=a.t_catid and b.t_code='"+nnka+"'";
    rs5 = LnGetRecordSet(que);
    if(rs5 != null)
      if (rs5.moveNext) 
         acc0=rs5.value(0);
         vsum=abs(RestA_(acc0, {curdate}, 3, 0));
         nnn= rs5.value(1);
         i0=index(nnn,"Обеспечение");
         if (i0 > 0 )
            nnn=substr(nnn,13);
         end;

         nnn=strsubst(nnn,"","");
         // sground="Корректировка суммы обеспечения "+nnn+", в рамках кредитного договора №157100/0039 от 17.06.2015 (ГКД №33495004 от 09.07.2014 ЦБ РФ), по распоряжению ДОФР №   от "+SDAT({curdate})+" г.";
         sground="Корректировка суммы обеспечения "+nnn+", по распоряжению ДОФР № от "+SDAT({curdate})+".";

         mass1(ij)=acc0;
         mas2(ij)=vsum;
         mas3(ij)=sground;
         mas4(ij)= "Оценка на сумму "+string(vsum:a);
		 status = nnn+" оценка на сумму "+string(vsum:a);

         ij=ij+1;

      end;
   end;

                                ii=ii+1;
                              end;


      ij=menu(mas4,status);
       status = "";
      if ( ij <  0 )
        return  1;
      else
         acc0=mass1(ij);
         vsum=mas2(ij);
         sground=mas3(ij);
         nrate=vsum;

         getmoney(vsum,"Укажите сумму корректировки");
         if ( vsum <= 0 )
            return 1;
         end;

      end;



     if(not deal_pd.OpenAccount("ВнебалСчетКорресп0", acc2, NULL, deal_pd.GetFIRoleByCategory("ВнебалСчетКорресп", deal_pd.GetLeg().PFI), NULL, deal_pd.GetTick().DealDate, deal_pd.GetLeg().PFI))
        return 1;
     end;    

//          at.Numb_Document = execmacrofile("fx_lib", "MakeNumber0");
      if ( vari == 2 )
          at.AccountPayer    = acc0;	  
          at.AccountReceiver = acc2;
      else
          at.AccountPayer    = acc2;	  
          at.AccountReceiver = acc0;
      end;

          at.FIIDPayer       = leg.pfi;
          at.FIIDReceiver    = leg.pfi;
          at.SumPayer        = vsum;
          at.SumReceiver     = vsum;
          at.Chapter         = 3;
          at.Ground          = sground;

          if(not at.carry())
             msgbox("Error !");
             return false;
          end;

          que="select  b.t_contractid  from ddl_grnt_dbt a , ddl_secur_dbt b where rownum=1 and a.t_dealid="+tick.DealID+"  and  b.t_contractid=a.t_contractid "; 
          rs5 = LnGetRecordSet(que);
          if(rs5 != null)
            if (rs5.moveNext) 

             nka=int(rs5.value(0));
      if ( vari == 2 )
             que="update ddl_secur_dbt set t_cost=t_cost+"+vsum+" where t_contractid="+nka+" and t_cost="+nrate;
      else
             que="update ddl_secur_dbt set t_cost=t_cost-"+vsum+" where t_contractid="+nka+" and t_cost="+nrate;
      end;
             rs05 = LnGetRecordSet(que);
            end;
         end;
                                    else

    s_addground = GetGroundAddPart(tick);
    // vsum=MM_zalog(tick.DealID);
     if(not deal_pd.OpenAccount("ВнебалСчетКорресп0", acc2, NULL, deal_pd.GetFIRoleByCategory("ВнебалСчетКорресп", deal_pd.GetLeg().PFI), NULL, deal_pd.GetTick().DealDate, deal_pd.GetLeg().PFI))
        return 1;
     end;    

     ij=0;
     que="select rownum, b.t_cost amount ,b.t_fiid fiid ,b.t_crdnumber transh, b.t_signdate da0 ,b.t_contractor partyid, T_REALTYNAME transh2, b.t_securityproperties ss  from ddl_grnt_dbt a , ddl_secur_dbt b where t_dealid="+tick.DealID+" and b.t_contractid=a.t_contractid order    by t_numsecinorder";
     rs9 = LnGetRecordSet(que);
     if(rs9 != null)
       while(rs9.moveNext())
         vsum= rs9.value(1);
         mas2(ij)=rs9.value("ss");
         mas4(ij)=rs9.value("transh")+" оценка на сумму "+string(vsum:a);
         ij=ij+1;
       end;
     end;
      ij=menu(mas4,"Укажите залог для корректировки");

      if ( ij <  0 )
        return  1;
      else

        nnn=mas2(ij);
      end;


     ii=ij+1;
     que="select rownum, b.t_cost amount ,b.t_fiid fiid ,b.t_crdnumber transh, b.t_signdate da0 ,b.t_contractor partyid, T_REALTYNAME transh2  from ddl_grnt_dbt a , ddl_secur_dbt b where t_dealid="+tick.DealID+" and b.t_securityproperties="+nnn+" and   b.t_contractid=a.t_contractid order    by t_numsecinorder";
     rs9 = LnGetRecordSet(que);
     if(rs9 != null)
       while(rs9.moveNext())
        // sground="Постановка на учет выданного залога - обеспечение "+nami(rs9.value("partyid"))+" "+rs9.value("transh")+" от "+SDAT(rs9.value("da0"))+" (сделка No "+tick.dealcode+" от "+SDAT(tick.dealdate)+" "+nami(tick.partyid)+" )";

                tran=rs9.value("transh");
                 if ( strlen(rs9.value("transh2")) > strlen(tran) )
                   tran=rs9.value("transh2");
                 end;
                 tran=strsubst(tran,"в рамках договора","в рамках КД");

         i0=index(tran,"КД");
         if (i0 > 0 )
            nnn=substr(tran,i0+3);
         end;
         i0=index(tran,"в рамках");
         if (i0 > 0 )
            tran="("+trim(substr(tran,1,i0-1))+")";
         end;
         tran=strsubst(tran,"","");
        tran=nnn+" "+tran;
        sground="КД от "+SDAT(rs9.value("da0"))+" "+tran+" "+nami(rs9.value("partyid"))+", переданный в обеспечение кредита, полученного от Банка России (ГКД №33495004 от 09.07.2014) "+SDAT(tick.dealdate)+".";

       /*
       КД от 18.09.2014 №140200/0048 (транш № 24) ОАО "Токаревская птицефабрика",
       переданный в обеспечение кредита, полученного от Банка России (ГКД №33495004 от 09.07.2014) 25.02.2019.
       */

        nka="-Обесп. кр., ц/б_K"+string(ii);
        nfiid=rs9.value("partyid");
        vsum=rs9.value("amount");
        if(not deal_pd.OpenAccount(nka, acc0, NULL, deal_pd.GetFIRoleByCategory(nka, deal_pd.GetLeg().PFI), NULL, {curdate}, deal_pd.GetLeg().PFI))
         return 1;
        end;    

//        at.Numb_Document = execmacrofile("fx_lib", "MakeNumber0");
          at.AccountPayer    = acc0;	  
          at.AccountReceiver = acc2;
          at.FIIDPayer       = leg.pfi;
          at.FIIDReceiver    = leg.pfi;
          at.SumReceiver     = vsum;
          at.SumPayer        = vsum;
          at.Chapter         = 3;
          at.Ground          = sground;
          if(not at.carry())
             msgbox("Error !");
             return false;
          end;

          // ii=ii+1;
       end;
     end;

                                    end;


    return 0;
END;


