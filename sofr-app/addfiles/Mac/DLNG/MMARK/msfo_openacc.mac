/*
$Name:        msfo_openacc.mac
$Module:      МБ Кредиты
$Description: макрос выполнения шага "Открытие счетов по МСФО"
*/
/*-------------------------------------------------------------------------
  Имя файла        : msfo_openacc.mac

  Описание         : макрос выполнения шага "Открытие счетов по МСФО"

  Программист      : Терещенко Ф.С.

  Создан           : 15.11.2019
-------------------------------------------------------------------------*/
IMPORT mmcnst_j, mmlibr, mmlb_j, mmlib, mmcateg;

VAR Категории = TArray,
     Роли     = TArray,
     FirstDoc = NULL;

RECORD deal(dl_tick);

PRIVATE MACRO ОткрытьСчет(indx, Дата, Счет)
  var FindAccount = "";

  FirstDoc.OpenAccount(Категории[indx], FindAccount, NULL, Роли[indx], NULL, Дата, NULL);

  SetParm( 2, FindAccount );

  IF (FindAccount == "")
      RETURN false;
  END;
  
  RETURN true;
END;

PRIVATE MACRO КатегорияОценки(DealType, BOfficeKind)
   VAR ObjectType = 0;
   // Определяем вид объекта
   IF   (BOfficeKind == 102)
      ObjectType = 103;
   ELIF (BOfficeKind == 208)
      ObjectType = 204;
   ELSE
      RETURN 0;
   END;

   VAR cmd = RsdCommand(RslDefCon, "SELECT T_ATTRID FROM DOBJATCOR_DBT WHERE T_OBJECT = LPAD(?, 34, '0') AND T_OBJECTTYPE = ? AND T_GROUPID = 5");
   cmd.AddParam("p1", RSDBP_IN); cmd.Value("p1") = DealType;
   cmd.AddParam("p2", RSDBP_IN); cmd.Value("p2") = ObjectType;
   cmd.Execute();
   VAR rs = RsdRecordset(cmd);
   IF (rs.MoveNext())
      RETURN rs.Value(0);
   END;

   RETURN 0;
END;


PRIVATE MACRO ЗаполнитьМассивы(Категория, BOfficeKind)
   VAR cmd = RsdCommand(RslDefCon, "SELECT  * FROM DMCCATEG_DBT t1 JOIN DMCDOCCAT_DBT t2 ON (T1.T_ID = T2.T_CATID) "+
                                    " WHERE t1.T_CODE = ? AND T2.T_DOCKIND = ?");
   cmd.AddParam("p1", RSDBP_IN); cmd.Value("p1") = Категория;
   cmd.AddParam("p2", RSDBP_IN); cmd.Value("p2") = BOfficeKind;
   cmd.Execute();
   VAR rs = RsdRecordset(cmd);
   IF (rs.MoveNext())
      Категории[Категории.size] = Категория;
      Роли[Роли.size]           = FirstDoc.GetFIRoleByCategory(Категория, FirstDoc.GetLeg().PFI);
   END;
END;

// 2.2.1 Оцениваемые по амортизированной стоимости (линейный метод) - сделки размещения
PRIVATE MACRO FillArray1(DealType, BOfficeKind)
   ЗаполнитьМассивы("+ОперДох, ПредКр",          BOfficeKind);
   ЗаполнитьМассивы("+ОперДох, РазмДп",          BOfficeKind);
   ЗаполнитьМассивы("-ОперРасх, ПредКр",         BOfficeKind);
   ЗаполнитьМассивы("-ОперРасх, РазмДп",         BOfficeKind);
   ЗаполнитьМассивы("+ОперДох, ПолучКр",         BOfficeKind);
   ЗаполнитьМассивы("+ОперДох, ПривлДп",         BOfficeKind);
   ЗаполнитьМассивы("-ОперРасх, ПолучКр",        BOfficeKind);
   ЗаполнитьМассивы("-ОперРасх, ПривлДп",        BOfficeKind);
   ЗаполнитьМассивы("+Штрафы за проср. ОД",      BOfficeKind);
   ЗаполнитьМассивы("+Штрафы за проср. %",       BOfficeKind);
   ЗаполнитьМассивы("Р, штрафы",                 BOfficeKind);
   ЗаполнитьМассивы("+КОР_РС, кредиты%",         BOfficeKind);
   ЗаполнитьМассивы("-КОР_РС, кредиты%",         BOfficeKind);
   ЗаполнитьМассивы("+КОР_РС, Дп%",              BOfficeKind);
   ЗаполнитьМассивы("-КОР_РС, Дп%",              BOfficeKind);
   ЗаполнитьМассивы("+КОР_РС, д/с",              BOfficeKind);
   ЗаполнитьМассивы("-КОР_РС, д/с",              BOfficeKind);
   ЗаполнитьМассивы("-КОР_Резерв, ОД",           BOfficeKind);
   ЗаполнитьМассивы("+КОР_Резерв, ОД",           BOfficeKind);
   ЗаполнитьМассивы("-КОР_Резерв, ссуды с н.с.", BOfficeKind);
   ЗаполнитьМассивы("+КОР_Резерв, ссуды с н.с.", BOfficeKind);
   ЗаполнитьМассивы("-КОР_Резерв, % с н.с.",     BOfficeKind);
   ЗаполнитьМассивы("+КОР_Резерв, % с н.с.",     BOfficeKind);
   ЗаполнитьМассивы("-КОР_Резерв, %",            BOfficeKind);
   ЗаполнитьМассивы("+КОР_Резерв, %",            BOfficeKind);
   ЗаполнитьМассивы("-КОР_Резерв, договор",      BOfficeKind);
   ЗаполнитьМассивы("+КОР_Резерв, договор",      BOfficeKind);
   ЗаполнитьМассивы("-КОР_Резерв, штрафы",       BOfficeKind);
   ЗаполнитьМассивы("+КОР_Резерв, штрафы",       BOfficeKind);
   ЗаполнитьМассивы("+Маржа, проч.",             BOfficeKind);
   ЗаполнитьМассивы("-Маржа, проч.",             BOfficeKind);
   ЗаполнитьМассивы("Затраты",                   BOfficeKind);
   ЗаполнитьМассивы("Расчеты, затраты",          BOfficeKind);
   ЗаполнитьМассивы("-Комиссия, ПредостКр",      BOfficeKind);
   ЗаполнитьМассивы("-Комиссия, РазмДп",         BOfficeKind);
   ЗаполнитьМассивы("+НДС начисл.",              BOfficeKind);
   ЗаполнитьМассивы("-Налог",                    BOfficeKind);
END;

// 2.2.2 Оцениваемые по амортизированной стоимости (линейный метод) - сделки привлечения
PRIVATE MACRO FillArray2(DealType, BOfficeKind)
   ЗаполнитьМассивы("+ОперДох, ПредКр",          BOfficeKind);
   ЗаполнитьМассивы("+ОперДох, РазмДп",          BOfficeKind);
   ЗаполнитьМассивы("-ОперРасх, ПредКр",         BOfficeKind);
   ЗаполнитьМассивы("-ОперРасх, РазмДп",         BOfficeKind);
   ЗаполнитьМассивы("+ОперДох, ПолучКр",         BOfficeKind);
   ЗаполнитьМассивы("+ОперДох, ПривлДп",         BOfficeKind);
   ЗаполнитьМассивы("-ОперРасх, ПолучКр",        BOfficeKind);
   ЗаполнитьМассивы("-ОперРасх, ПривлДп",        BOfficeKind);
   ЗаполнитьМассивы("-Штрафы за проср. ОД",      BOfficeKind);
   ЗаполнитьМассивы("-Штрафы за проср. %",       BOfficeKind);
   ЗаполнитьМассивы("+Маржа, проч.",             BOfficeKind);
   ЗаполнитьМассивы("-Маржа, проч.",             BOfficeKind);
   ЗаполнитьМассивы("Затраты",                   BOfficeKind);
   ЗаполнитьМассивы("Расчеты, затраты",          BOfficeKind);
   ЗаполнитьМассивы("-КомРасх, ПолучКр",         BOfficeKind);
   ЗаполнитьМассивы("-КомРасх, ПривлДп",         BOfficeKind);
   ЗаполнитьМассивы("+НДС начисл.",              BOfficeKind);
   ЗаполнитьМассивы("-Налог",                    BOfficeKind);
END;

// 2.2.3 Оцениваемые по амортизированной стоимости (метод ЭПС) - сделки размещения
PRIVATE MACRO FillArray3(DealType, BOfficeKind)
   ЗаполнитьМассивы("+Корр, УМРС",               BOfficeKind);
   ЗаполнитьМассивы("-Корр, УВРС",               BOfficeKind);
   ЗаполнитьМассивы("+ОперДох, ПредКр",          BOfficeKind);
   ЗаполнитьМассивы("+ОперДох, РазмДп",          BOfficeKind);
   ЗаполнитьМассивы("-ОперРасх, ПредКр",         BOfficeKind);
   ЗаполнитьМассивы("-ОперРасх, РазмДп",         BOfficeKind);
   ЗаполнитьМассивы("+КСт, ПредКр",              BOfficeKind);
   ЗаполнитьМассивы("+КСт, РазмДп",              BOfficeKind);
   ЗаполнитьМассивы("-КСт, ПредКр",              BOfficeKind);
   ЗаполнитьМассивы("-КСт, РазмДп",              BOfficeKind);
   ЗаполнитьМассивы("+Штрафы за проср. ОД",      BOfficeKind);
   ЗаполнитьМассивы("+Штрафы за проср. %",       BOfficeKind);
   ЗаполнитьМассивы("Р, штрафы",                 BOfficeKind);
   ЗаполнитьМассивы("+КОР_РС, кредиты%",         BOfficeKind);
   ЗаполнитьМассивы("-КОР_РС, кредиты%",         BOfficeKind);
   ЗаполнитьМассивы("+КОР_РС, Дп%",              BOfficeKind);
   ЗаполнитьМассивы("-КОР_РС, Дп%",              BOfficeKind);
   ЗаполнитьМассивы("+КОР_РС РУОКХОР",           BOfficeKind);
   ЗаполнитьМассивы("-КОР_РС РУОКХОР",           BOfficeKind);
   ЗаполнитьМассивы("+КОР_РС, д/с",              BOfficeKind);
   ЗаполнитьМассивы("-КОР_РС, д/с",              BOfficeKind);
   ЗаполнитьМассивы("-КОР_Резерв, ОД",           BOfficeKind);
   ЗаполнитьМассивы("+КОР_Резерв, ОД",           BOfficeKind);
   ЗаполнитьМассивы("-КОР_Резерв, ссуды с н.с.", BOfficeKind);
   ЗаполнитьМассивы("+КОР_Резерв, ссуды с н.с.", BOfficeKind);
   ЗаполнитьМассивы("-КОР_Резерв, % с н.с.",     BOfficeKind);
   ЗаполнитьМассивы("+КОР_Резерв, % с н.с.",     BOfficeKind);
   ЗаполнитьМассивы("-КОР_Резерв, %",            BOfficeKind);
   ЗаполнитьМассивы("+КОР_Резерв, %",            BOfficeKind);
   ЗаполнитьМассивы("-КОР_Резерв, договор",      BOfficeKind);
   ЗаполнитьМассивы("+КОР_Резерв, договор",      BOfficeKind);
   ЗаполнитьМассивы("-КОР_Резерв, штрафы",       BOfficeKind);
   ЗаполнитьМассивы("+КОР_Резерв, штрафы",       BOfficeKind);
   ЗаполнитьМассивы("Оц_Резерв, ССПСД",          BOfficeKind);
   ЗаполнитьМассивы("+Маржа, проч.",             BOfficeKind);
   ЗаполнитьМассивы("-Маржа, проч.",             BOfficeKind);
   ЗаполнитьМассивы("Затраты",                   BOfficeKind);
   ЗаполнитьМассивы("Расчеты, затраты",          BOfficeKind);
   ЗаполнитьМассивы("-Комиссия, ПредостКр",      BOfficeKind);
   ЗаполнитьМассивы("-Комиссия, РазмДп",         BOfficeKind);
   ЗаполнитьМассивы("+НДС начисл.",              BOfficeKind);
   ЗаполнитьМассивы("-Налог",                    BOfficeKind);
END;

// 2.2.4 Оцениваемые по амортизированной стоимости (метод ЭПС) - сделки привлечения
PRIVATE MACRO FillArray4(DealType, BOfficeKind)
   ЗаполнитьМассивы("-Корр, УМПС",               BOfficeKind);
   ЗаполнитьМассивы("+Корр, УВПС",               BOfficeKind);
   ЗаполнитьМассивы("+ОперДох, ПолучКр",         BOfficeKind);
   ЗаполнитьМассивы("+ОперДох, ПривлДп",         BOfficeKind);
   ЗаполнитьМассивы("-ОперРасх, ПолучКр",        BOfficeKind);
   ЗаполнитьМассивы("-ОперРасх, ПривлДп",        BOfficeKind);
   ЗаполнитьМассивы("+КСт, ПолучКр",             BOfficeKind);
   ЗаполнитьМассивы("+КСт, ПривлДп",             BOfficeKind);
   ЗаполнитьМассивы("-КСт, ПолучКр",             BOfficeKind);
   ЗаполнитьМассивы("-КСт, ПривлДп",             BOfficeKind);
   ЗаполнитьМассивы("-Штрафы за проср. ОД",      BOfficeKind);
   ЗаполнитьМассивы("-Штрафы за проср. %",       BOfficeKind);
   ЗаполнитьМассивы("+Маржа, проч.",             BOfficeKind);
   ЗаполнитьМассивы("-Маржа, проч.",             BOfficeKind);
   ЗаполнитьМассивы("Затраты",                   BOfficeKind);
   ЗаполнитьМассивы("Расчеты, затраты",          BOfficeKind);
   ЗаполнитьМассивы("-КомРасх, ПолучКр",         BOfficeKind);
   ЗаполнитьМассивы("-КомРасх, ПривлДп",         BOfficeKind);
   ЗаполнитьМассивы("+НДС начисл.",              BOfficeKind);
   ЗаполнитьМассивы("-Налог",                    BOfficeKind);
END;

// 2.2.5 Оцениваемые по справедливой стоимости через прочий совокупный доход - сделки размещения
PRIVATE MACRO FillArray5(DealType, BOfficeKind)
   ЗаполнитьМассивы("+Корр, УМРС",               BOfficeKind);
   ЗаполнитьМассивы("-Корр, УВРС",               BOfficeKind);
   ЗаполнитьМассивы("+ОперДох, ПредКр",          BOfficeKind);
   ЗаполнитьМассивы("+ОперДох, РазмДп",          BOfficeKind);
   ЗаполнитьМассивы("-ОперРасх, ПредКр",         BOfficeKind);
   ЗаполнитьМассивы("-ОперРасх, РазмДп",         BOfficeKind);
   ЗаполнитьМассивы("+КСт, ПредКр",              BOfficeKind);
   ЗаполнитьМассивы("+КСт, РазмДп",              BOfficeKind);
   ЗаполнитьМассивы("-КСт, ПредКр",              BOfficeKind);
   ЗаполнитьМассивы("-КСт, РазмДп",              BOfficeKind);
   ЗаполнитьМассивы("+Штрафы за проср. ОД",      BOfficeKind);
   ЗаполнитьМассивы("+Штрафы за проср. %",       BOfficeKind);
   ЗаполнитьМассивы("Р, штрафы",                 BOfficeKind);
   ЗаполнитьМассивы("+КОР_РС, кредиты%",         BOfficeKind);
   ЗаполнитьМассивы("-КОР_РС, кредиты%",         BOfficeKind);
   ЗаполнитьМассивы("+КОР_РС, Дп%",              BOfficeKind);
   ЗаполнитьМассивы("-КОР_РС, Дп%",              BOfficeKind);
   ЗаполнитьМассивы("Оц_Резерв, ССПСД",          BOfficeKind);
   ЗаполнитьМассивы("+Маржа, проч.",             BOfficeKind);
   ЗаполнитьМассивы("-Маржа, проч.",             BOfficeKind);
   ЗаполнитьМассивы("+Переоценка, УМРС ССПСД",   BOfficeKind);
   ЗаполнитьМассивы("-Переоценка, УВРС ССПСД",   BOfficeKind);
   ЗаполнитьМассивы("+МаржаП, ПредКр",           BOfficeKind);
   ЗаполнитьМассивы("+МаржаП, РазмДп",           BOfficeKind);
   ЗаполнитьМассивы("-МаржаП, ПредКр",           BOfficeKind);
   ЗаполнитьМассивы("-МаржаП, РазмДп",           BOfficeKind);
   ЗаполнитьМассивы("+Переоценка, ФА ССПСД",     BOfficeKind);
   ЗаполнитьМассивы("-Переоценка, ФА ССПСД",     BOfficeKind);
   ЗаполнитьМассивы("Затраты",                   BOfficeKind);
   ЗаполнитьМассивы("Расчеты, затраты",          BOfficeKind);
   ЗаполнитьМассивы("-Комиссия, ПредостКр",      BOfficeKind);
   ЗаполнитьМассивы("-Комиссия, РазмДп",         BOfficeKind);
   ЗаполнитьМассивы("+НДС начисл.",              BOfficeKind);
   ЗаполнитьМассивы("-Налог",                    BOfficeKind);
END;

// 2.2.6 Оцениваемые по справедливой стоимости через прибыль или убыток - сделки размещения
PRIVATE MACRO FillArray6(DealType, BOfficeKind)
   ЗаполнитьМассивы("+Корр, УМРС",               BOfficeKind);
   ЗаполнитьМассивы("-Корр, УВРС",               BOfficeKind);
   ЗаполнитьМассивы("+ОперДох, ПредКр",          BOfficeKind);
   ЗаполнитьМассивы("+ОперДох, РазмДп",          BOfficeKind);
   ЗаполнитьМассивы("-ОперРасх, ПредКр",         BOfficeKind);
   ЗаполнитьМассивы("-ОперРасх, РазмДп",         BOfficeKind);
   ЗаполнитьМассивы("+КСт, ПредКр",              BOfficeKind);
   ЗаполнитьМассивы("+КСт, РазмДп",              BOfficeKind);
   ЗаполнитьМассивы("-КСт, ПредКр",              BOfficeKind);
   ЗаполнитьМассивы("-КСт, РазмДп",              BOfficeKind);
   ЗаполнитьМассивы("+Штрафы за проср. ОД",      BOfficeKind);
   ЗаполнитьМассивы("+Штрафы за проср. %",       BOfficeKind);
   ЗаполнитьМассивы("Р, штрафы",                 BOfficeKind);
   ЗаполнитьМассивы("+Маржа, проч.",             BOfficeKind);
   ЗаполнитьМассивы("-Маржа, проч.",             BOfficeKind);
   ЗаполнитьМассивы("+Переоценка, УМРС ССПУ",    BOfficeKind);
   ЗаполнитьМассивы("-Переоценка, УВРС ССПУ",    BOfficeKind);
   ЗаполнитьМассивы("+МаржаП, ПредКр",           BOfficeKind);
   ЗаполнитьМассивы("+МаржаП, РазмДп",           BOfficeKind);
   ЗаполнитьМассивы("-МаржаП, ПредКр",           BOfficeKind);
   ЗаполнитьМассивы("-МаржаП, РазмДп",           BOfficeKind);
   ЗаполнитьМассивы("Затраты",                   BOfficeKind);
   ЗаполнитьМассивы("Расчеты, затраты",          BOfficeKind);
   ЗаполнитьМассивы("-Комиссия, ПредостКр",      BOfficeKind);
   ЗаполнитьМассивы("-Комиссия, РазмДп",         BOfficeKind);
   ЗаполнитьМассивы("+НДС начисл.",              BOfficeKind);
   ЗаполнитьМассивы("-Налог",                    BOfficeKind);
END;

// 2.2.7 Оцениваемые по справедливой стоимости через прибыль или убыток - сделки привлечения
PRIVATE MACRO FillArray7(BOfficeKind)
   ЗаполнитьМассивы("-Корр, УМПС",               BOfficeKind);
   ЗаполнитьМассивы("+Корр, УВПС",               BOfficeKind);
   ЗаполнитьМассивы("+ОперДох, ПолучКр",         BOfficeKind);
   ЗаполнитьМассивы("+ОперДох, ПривлДп",         BOfficeKind);
   ЗаполнитьМассивы("-ОперРасх, ПолучКр",        BOfficeKind);
   ЗаполнитьМассивы("-ОперРасх, ПривлДп",        BOfficeKind);
   ЗаполнитьМассивы("+КСт, ПолучКр",             BOfficeKind);
   ЗаполнитьМассивы("+КСт, ПривлДп",             BOfficeKind);
   ЗаполнитьМассивы("-КСт, ПолучКр",             BOfficeKind);
   ЗаполнитьМассивы("-КСт, ПривлДп",             BOfficeKind);
   ЗаполнитьМассивы("-Штрафы за проср. ОД",      BOfficeKind);
   ЗаполнитьМассивы("-Штрафы за проср. %",       BOfficeKind);
   ЗаполнитьМассивы("+Маржа, проч.",             BOfficeKind);
   ЗаполнитьМассивы("-Маржа, проч.",             BOfficeKind);
   ЗаполнитьМассивы("-Переоценка, УМПС",         BOfficeKind);
   ЗаполнитьМассивы("+Переоценка, УВПС",         BOfficeKind);
   ЗаполнитьМассивы("+МаржаП, ПолучКр",          BOfficeKind);
   ЗаполнитьМассивы("+МаржаП, ПривлДп",          BOfficeKind);
   ЗаполнитьМассивы("-МаржаП, ПолучКр",          BOfficeKind);
   ЗаполнитьМассивы("-МаржаП, ПривлДп",          BOfficeKind);
   ЗаполнитьМассивы("+Переоценка, ФО",           BOfficeKind);
   ЗаполнитьМассивы("-Переоценка, ФО",           BOfficeKind);
   ЗаполнитьМассивы("Затраты",                   BOfficeKind);
   ЗаполнитьМассивы("Расчеты, затраты",          BOfficeKind);
   ЗаполнитьМассивы("-КомРасх, ПолучКр",         BOfficeKind);
   ЗаполнитьМассивы("-КомРасх, ПривлДп",         BOfficeKind);
   ЗаполнитьМассивы("+НДС начисл.",              BOfficeKind);
   ЗаполнитьМассивы("-Налог",                    BOfficeKind);
END;


MACRO ExecuteStep(Buffer, Document)
   var i     = 0,
   error = "";

   SetBuff( deal, Document );
   FirstDoc = MMFirstDoc(deal.BOfficeKind, deal.DealID, TRUE);

   IF (CheckExistence(LEG_LegKind_DealID_LegID, LEG_KIND_DL_TICK, deal.DealID, 1))
      mm_error( "Не найден транш сделки ", deal.DealCode );
      RETURN 1;
   END;

   // Заполнить массив с категориями в зависимости от направления сделки
   VAR Cat = КатегорияОценки(deal.DealType, deal.BOfficeKind);

   IF (deal.DealType == 2300) // Привлечение
      IF (Cat == 1)
         FillArray2(deal.BOfficeKind);
      ELIF (Cat == 2)
         FillArray4(deal.BOfficeKind);
      ELIF (Cat == 3)
         FillArray7(deal.BOfficeKind);
      END;

   ELIF (deal.DealType == 2305) // Размещение
      IF (Cat == 1)
         FillArray1(deal.BOfficeKind);
      ELIF (Cat == 2)
         FillArray3(deal.BOfficeKind);
      ELIF (Cat == 3)
         FillArray6(deal.BOfficeKind);
      ELIF (Cat == 4)
         FillArray5(deal.BOfficeKind);
      END;
   END;

   IF (Категории.size > Роли.size)
      Роли.size = Категории.size;
   END;

   WHILE (ValType(Категории(i)) == V_STRING)
      IF (NOT ОткрытьСчет(i, deal.DealDate, NULL))
         mm_error("Не могу открыть счет для категории " + Категории(i)); 
         RETURN 1;
      END;
      i = i + 1;
   END;

   RETURN 0;
END;
NameMacroFile = "msfo_openacc.mac";