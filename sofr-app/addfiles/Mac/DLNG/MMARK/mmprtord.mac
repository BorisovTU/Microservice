/* ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
  RS-Bank                                        R-Style Software Lab Ltd
  ” ©« ¯®¤á¨áâ¥¬ë "ŒŠ"

  ¥ç âì à á¯®àï¦¥­¨ï ¢ ¡ãå£ «â¥à¨î Œ ‘ ”.

CREATED : 15.02.00 LA
MODIFICATIONS:
NOTES:

ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ */
import DealInter;
/*                               áâà®©ª                                     */

VAR PRINT_ACCNUM = FALSE; /* …á«¨ íâ®â ¯ à ¬¥âà ãáâ ­®¢«¥­ ¢ TRUE, â® ¢ ¯®«¥
                         "­  áç¥â" ¯¥ç â ¥âáï ­®¬¥à «¨æ¥¢®£® áç¥â ,
                         ¨­ ç¥ - ª®¤ ãç áâ­¨ª  */

/* ------------------------------------------------------------------------- */
import PtInter, PaymInter;

FILE dl_leg   ( dl_leg   ); /* ’à ­è¨ á¤¥«®ª */
FILE party    ( party    ); /* Š«¨¥­âë */
FILE partcode ( partcode ); /* Š®¤ë ª«¨¥­â®¢ */
FILE fininstr ( fininstr ); /* ”¨­ ­á®¢ë¥ ¨­áâàã¬¥­âë */

FILE pers( person );

/* ------------------------------------------------------------------------- */
/* GLOBALS */
VAR g_payments = TArray; /* ¬ áá¨¢ § ¯¨á¥© ¯® ¯« â¥¦ ¬ */

RECORD g_dealrec( dl_tick ); /* § ¯¨áì ¯® á¤¥«ª¥ ¨§ ¢ë§ë¢ îé¥£® ¬ ªà®á  */

/* „ ­­ë¥ ¯® á¤¥«ª¥ */
VAR
g_DealXId    = "",
g_Dealt      = date( 0,0,0 ),
g_DDirection = "",
g_DAccType   = "",
g_TimeOnCall = "",
g_GroundKind = "";

/* ------------------------------------------------------------------------- */
/* Œ ªà®á ¤«ï ¯à¥¤¢ à¨â¥«ì­®© ¯®¤£®â®¢ª¨ ¤ ­­ëå */

/* ‘®¡à âì § ¯¨á¨ */
MACRO getRecord( p_rec )
var l_n = g_payments.Size;
    g_payments(l_n) = TrecHandler( "pmpaym" );
    copy( g_payments(l_n), p_rec );
END;

/* ......................................................................... */
/* ......................................................................... */

/* ®«ãç¨âì ­ ¨¬¥­®¢ ­¨¥ áã¡ê¥ªâ  ¯® ID */
MACRO getPartyName( p_id )
 party.PartyID = p_id;
 if( not getEQ( party ) )

  msgbox( "¥ ­ ©¤¥­ ª®­âà £¥­â ", p_id );

  return "";
 end;
 return trim( party.Name );
END;

/* ......................................................................... */

/* ®«ãç¨âì ˆŠ */
MACRO getPartyBIC( p_id )
 partcode.PartyID  = p_id;
 partcode.CodeKind = PTCK_BIC;

 if( not getEQ( partcode ) )
  return "";
 end;
 return partcode.Code;
END;

/* ......................................................................... */

/* âª®­¢¥àâ¨âì Duration ¢ ¤­¨ */
MACRO conv2days( p_duration, p_pitch )
 if( p_pitch == 1 ) /* ¤­¨ */
  return int( p_duration );
 else /* ­  íâ®â á«ãç © ¯®ª  § £«ãèª  */
  msgbox( "è¨¡ª !| ¥¢®§¬®¦­® ¢ëç¨á«¨âì %-© ¯¥à¨®¤ (áà®ª) ¢ ¤­ïå:|…¤¨­¨æ  ¨§¬¥à¥­¨ï áà®ª  - ­¥ ¤­¨.|(®« £ ¥¬ áà®ª à ¢­ë¬ 0)" );
  return 0;
 end;
END;

/* ......................................................................... */

/* ‘ª«®­¥­¨¥ ¤­¥© ¢ § ¢¨á¨¬®áâ¨ ®â ç¨á«  */
MACRO strdays( p_num )

var l_num;

 p_num = string( p_num );
 l_num = substr( p_num, strlen( p_num ) - 1, 1 );
 if( l_num == "1" )
  return "¤­¥©";
 end;

 l_num = substr( p_num, strlen( p_num ) );

 if( l_num == "1" )
  return "¤¥­ì";
 elif( ( l_num >= "2" ) and
       ( l_num <= "4" ) )
  return "¤­ï";
 end;
 return "¤­¥©";
END;

/* ......................................................................... */

/*  á¯¥ç â âì ¤«¨­­ãî áâà®çªã ¢ à ¬ª¥ - ¤«ï ¯¥ç â¨ ¤«¨­­ëå ¨¬¥­ :) */
MACRO printLongNameInFrame( p_name )
 ARRAY l_tmp;
 var l_width = 75, /* ˜¨à¨­  ¯®«ï ¢ë¢®¤ , ¢ëà ¢­¨¢ ­¨¥ ¯® «¥¢®¬ã ªà î.
                  …á«¨ ¥¥ ¨§¬¥­¨âì, ¢á¥ ®âê¥¤¥â */
     l_i;

 strsplit( p_name, l_tmp, l_width, null, 1 );
 println( "ÃÄ ¢ ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁ", mkstr( "Ä", l_width - 33 ), "´" );
 println( "³ ", l_tmp(0), mkstr( " ", l_width - strlen( l_tmp(0) ) ), " ³" );
 l_i = 1;
 while( valType( l_tmp(l_i) ) == V_STRING )
  println( "³ ", l_tmp(l_i), mkstr( " ", l_width - strlen( l_tmp(l_i) ) ), " ³" );

  l_i = l_i + 1;
 end;
 println( "À", mkstr( "Ä", l_width + 2 ), "Ù" );
END;

/* ......................................................................... */

/* ‚¥à­ãâì ¯ãáâãî áâà®ªã ¤«ï ­¥®¯à¥¤¥«¥­­®£® §­ ç¥­¨ï */
MACRO strUndef( p_str )
 if( valType( p_str ) == V_STRING )
  return p_str;
 end;
 return "";
END;

/* ......................................................................... */
MACRO getNameOper
 pers.Oper = {oper};

 if( getEQ( pers ) )
  return pers.Name;
 end;
 return "";
END;

/* ......................................................................... */

/* ¥ç âì à á¯®àï¦¥­¨ï ¤«ï ä¨ªá¨à®¢ ­­®£® ¯« â¥¦  */
MACRO printRep( p_paymrec )
 ARRAY l_tmp0, l_tmp1; /* ¤«ï ¯¥ç â¨ ¤¥­¥£ ¯à®¯¨áìî ¨ ­ §­ ç¥­¨ï ¯« â¥¦  */

var
    l_Duration,
    l_Start,
    l_Maturity,
    l_Rate,
    l_PFI,
    l_BnfAccount, l_DrAccount,
    l_BnfCaption,
    l_BnfTaxId,
    l_BnfAgentCaption,
    l_BnfAgentBIC,
    l_DrAgentCaption,
    l_DrAgentBIC,
    l_Ccy, l_ISONum;

var l_ind, l_size, l_first,
    l_purpose,
    l_i, l_width, l_str;

 /* 1: ¯®«ãç¨âì ¤ ­­ë¥ ¤«ï ¯¥ç â¨ */

 /* ’à ­è */
 dl_leg.LegKind = LEG_KIND_DL_TICK;
 dl_leg.DealID = g_dealrec.DealID;
 dl_leg.LegID  = p_paymrec.rec.LegID;
 if( not getEQ( dl_leg ) )
  msgbox( "è¨¡ª ! ¥ ­ ©¤¥­ âà ­è á ¨¤¥­â¨ä¨ª â®à®¬ ", p_paymrec.rec.LegID );
  return FALSE;
 end;

 l_Duration = conv2days( dl_leg.Duration, dl_leg.Pitch );
 l_Start    = dl_leg.Start;
 l_Maturity = dl_leg.Maturity;
 l_Rate     = dl_leg.Price;
 l_PFI      = dl_leg.PFI;

 /* ü®¬¥à  áç¥â®¢ */
 l_BnfAccount = "";
 l_DrAccount  = "";
 if( PRINT_ACCNUM ) /* ­ã¦¥­ ü áç¥â  */
  l_BnfAccount = trim( p_paymrec.rec.ReceiverAccount );
  l_DrAccount  = trim( p_paymrec.rec.PayerAccount );

 else /* ­ã¦¥­ ª®¤ ãç áâ­¨ª  */
  partcode.PartyID  = p_paymrec.rec.Receiver;
  partcode.CodeKind = 5;
  if( getEQ( partcode ) )
   l_BnfAccount = trim( partcode.Code );
  end;

  partcode.PartyID  = p_paymrec.rec.Payer;
  partcode.CodeKind = 5;
  if( getEQ( partcode ) )
   l_DrAccount  = trim( partcode.Code );
  end;
 end;

 /* „ ­­ë¥ ¯® ª«¨¥­â ¬ */
 l_BnfCaption      = getPartyName( p_paymrec.rec.Receiver ); /* ¯®«ãç â¥«ì */
 l_BnfTaxId        = trim( GetPartyINN(party.PartyID) );
 l_BnfAgentCaption = getPartyName( p_paymrec.rec.ReceiverBankID );
 l_BnfAgentBIC     = getPartyBIC ( p_paymrec.rec.ReceiverBankID );

 l_DrAgentCaption  = getPartyName( p_paymrec.rec.PayerBankID );
 l_DrAgentBIC      = getPartyBIC ( p_paymrec.rec.PayerBankID );

 /* „ ­­ë¥ ¯® ¢ «îâ¥ */
 fininstr.FIID = l_PFI;
 if( not getEQ( fininstr ) )
  msgbox( "è¨¡ª ! ¥ ­ ©¤¥­  ¢ «îâ  á ¨¤¥­â¨ä¨ª â®à®¬ ", l_PFI );
  return FALSE;
 end;
 l_Ccy    = trim( fininstr.Ccy );
 l_ISONum = fininstr.ISO_Number;

 /* 2: ¯¥ç âì */
[                    ‚ “•ƒ€‹’…ˆ Œ ‘ ”                                    ];
[                                                                               ];
[                       €‘Ÿ†…ˆ… ü                           ®â #           ]
 ( p_paymrec.rec.ValueDate:l );

 l_ind  = 0;
 l_size = g_payments.Size;

 l_first = TRUE;
 while( l_ind < l_size )

  if( ( g_payments(l_ind)                     != null ) and
      ( g_payments(l_ind).rec.LegId           == p_paymrec.rec.LegId ) and
      ( g_payments(l_ind).rec.ValueDate       == p_paymrec.rec.ValueDate ) and
      ( g_payments(l_ind).rec.FIID            == l_PFI ) and
      ( g_payments(l_ind).rec.ReceiverAccount == p_paymrec.rec.ReceiverAccount ) and
      ( g_payments(l_ind).rec.ReceiverBankID  == p_paymrec.rec.ReceiverBankId ) )

   l_purpose = "";
   if( g_payments(l_ind).rec.Purpose == PM_PURP_PRINC )
    if( index( g_dealrec.TypeDoc, "L" ) != 0 ) /* ªà¥¤¨â */
     l_purpose = "áã¬¬  ªà¥¤¨â ";
    else
     l_purpose = "áã¬¬  ¤¥¯®§¨â ";
    end;
   elif( g_payments(l_ind).rec.Purpose == PM_PURP_PRINC_RET )
    l_purpose = "¯®£ è¥­¨¥ ®á­®¢­®£® ¤®«£ ";
   elif( g_payments(l_ind).rec.Purpose == PM_PURP_PERCENT )
    l_purpose = "¯à®æ¥­âë";
   end;
 
   /* ¥ç âì ¤ ­­ëå ¯® ¯« â¥¦ã */
   if( l_first )
    l_first = FALSE;
[ÚÄ ¥à¥ç¨á«¨â¥ ÄÄÄÄÄÄÄÄÂÄÄÄÄÄÂÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄ¿]
   else
[ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÅÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄ´];
   end;

   strsplit( curtostralt( g_payments(l_ind).rec.Amount, null, null, l_ISONum ), l_tmp0, 27, null, 1 );
   strsplit( l_purpose, l_tmp1, 10, null, 1 );
[³ #################### ³ ### ³ ### ³ ########################### ³ ########## ³]
 ( g_payments(l_ind).rec.Amount:r, l_Ccy, l_ISONum, l_tmp0(0):l, l_tmp1(0):l );

   l_i = 1;
   while( ( valType( l_tmp0(l_i) ) == V_STRING ) or
          ( valType( l_tmp1(l_i) ) == V_STRING ) )
[³                      ³     ³     ³ ########################### ³ ########## ³]
    ( strUndef( l_tmp0(l_i) ):l, strUndef( l_tmp1(l_i) ):l );

    l_i = l_i + 1;
   end;
   g_payments(l_ind) = null;
  end; /* if == == == */

  l_ind = l_ind + 1;
 end;

 if( not l_first )
[ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÁÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÙ]
 end;

 l_width = 45; /* è¨à¨­  ¯®«ï ¢ë¢®¤ , ¢ëà ¢­¨¢ ­¨¥ ¯® «¥¢®¬ã ªà î */
 strsplit( l_BnfCaption, l_tmp0, l_width, null, 1 );
 println( "ÚÄ ¢ ¯®«ì§ã ¯®«ãç â¥«ï ", mkstr( "Ä", l_width - 20 ),         "¿      ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿" );
 println( "³ ", l_tmp0(0), mkstr( " ", l_width - strlen( l_tmp0(0) ) ), " ³  ˆ ³ ", l_BnfTaxId:20,  " ³" );
 l_i = 1;
 while( valType( l_tmp0(l_i) ) == V_STRING )

  l_str = "³ " + l_tmp0(l_i) + mkstr( " ", l_width - strlen( l_tmp0(l_i) ) ) + " ³";

  if( l_i == 1 )
   l_str = l_str + "      ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ";
  end;

  println( l_str );

  l_i = l_i + 1;
 end;

 l_str = "À" + mkstr( "Ä", l_width + 2 ) + "Ù";
 if( l_i == 1 )
  l_str = l_str + "      ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ";
 end;
 println( l_str );

[ÚÄ ­  áç¥â ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿];
[³ #                                ³ ˆŠ #                                    ³]
 ( l_BnfAccount:l, l_BnfAgentBIC:l );
 printLongNameInFrame( l_BnfAgentCaption );
[ÚÄ á­®¢ ­¨¥ ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿];
[³ #                                                                           ³]
 ( string( g_GroundKind, " ü ", g_DealXId, " ®â ", g_Dealt ):l );
[³ Œë #                                                                        ³]
 ( string( g_DDirection, " ", g_DAccType, " ", g_TimeOnCall, " ", l_Duration, " ", strdays( l_Duration ) ):l );
[³ #                                                                           ³]
 ( string( "á ", l_Start, " ¯® ", l_Maturity, " ¯®¤ ", l_Rate, " % £®¤®¢ëå" ):l );
[ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
 println( " ‘à¥¤áâ¢  ¯®áâ ¢¨âì á® áç¥â  Œ ‘ ” (ˆŠ ", {MFO_Bank}, ")" );
[ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿];
[³ #                                ³ ˆŠ #                                    ³]
 ( l_DrAccount:l, l_DrAgentBIC:l );
 printLongNameInFrame( l_DrAgentCaption );
[                                                                               ];
[ ãª®¢®¤¨â¥«ì     #]( {FIO_Boss}:l );
[                                                                               ];
[  ç «ì­¨ª ®â¤¥«  ®¡¥á¯¥ç¥­¨ï á¤¥«®ª “¯à ¢«¥­¨ï à¥áãàá®¢ Œ ‘ ” ];
[                                                                               ];
[ ˆá¯®«­¨â¥«ì      #]( getNameOper:l );
[                                                                               ];
[ â¬¥âª  ¡ãå£ «â¥à¨¨ ® ¯à¨¥¬¥];
[                                  ¤ â  ¨ ¢à¥¬ï ¯¥à¥¤ ç¨ ¤®ªã¬¥­â               ];
[                                                                               ];

 return TRUE;
END;

/* ......................................................................... */

/* ®ª § âì à á¯¥ç âªã */
MACRO showFile
 FILE wrkfile () TXT; /* ” ©« ¤«ï ¯¥ç â¨ ¤ ­­ëå */

var l_path = setoutput( null, true );

 if( not open( wrkfile, l_path ) )
  msgbox( "è¨¡ª  ®âªàëâ¨ï ä ©«  á à á¯¥ç âª®© à á¯®àï¦¥­¨© ", l_path );
  return;
 end;

 viewfile( wrkfile );
END;

/* ......................................................................... */

/* ¥ç âì ¢á¥å à á¯®àï¦¥­¨© */
MACRO printAll( p_dealrec )
var l_res = TRUE,
    l_i, l_n;

 if( g_payments.size == 0 )
  println( "¥â ¯« â¥¦¥© ¯® á¤¥«ª¥, ã¤®¢«¥â¢®àïîé¨å ãá«®¢¨ï¬ ä¨«ìâà ." );
  showfile;
  return TRUE;
 end;

 /* 1: ®«ãç¨âì ¤ ­­ë¥ ¯® á¤¥«ª¥ ¯« â¥¦¥© */
 copy( g_dealrec, p_dealrec );

 g_DealXId      = trim( g_dealrec.DealCode );
 g_Dealt        = g_dealrec.DealDate;

 if( isSale( getOperationGroup( g_dealrec.DealType ) ) )
  g_DDirection  = "à §¬¥é ¥¬ ";
 else
  g_DDirection  = "¯à¨¢«¥ª ¥¬";
 end;

 if( index( g_dealrec.TypeDoc, "L" ) != 0 )
  g_DAccType    = "ªà¥¤¨â ";
 else
  g_DAccType    = "¤¥¯®§¨â";
 end;

 if( index( g_dealrec.TypeDoc, "O" ) != 0 )
  g_TimeOnCall = "¤® ¢®áâà¥¡®¢ ­¨ï";
 else
  g_TimeOnCall = "­  áà®ª";
 end;

 if( ( g_dealrec.DealType == 2310 ) or
     ( g_dealrec.DealType == 2311 ) ) /* ‘¤¥«ª¨ á ‘ */
  g_GroundKind = "à¥¤«®¦¥­¨¥ ® ¯¥à¥à á¯à¥¤¥«¥­¨¨ à¥áãàá®¢";
 else
  g_GroundKind = "‘¤¥«ª ";
 end;

 /* 2: ¥ç âì à á¯®àï¦¥­¨© */
 setoutput( "mmprtord." + trim(string( {oper}:3:l:t )) );
 l_i = 0;
 l_n = g_payments.Size;
 while( l_i < l_n )
  if( valType( g_payments(l_i) ) != V_UNDEF )
   l_res = ( ( l_res ) and
             ( printRep( g_payments(l_i) ) ) );
   println( "\f" );
  end;

  l_i = l_i + 1;
 end;

 showfile;
 return l_res;
END;

/* EoF */