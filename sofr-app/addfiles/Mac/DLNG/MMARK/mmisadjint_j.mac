/*
$Name:        mmisadjint_j.mac
$Module:      МБ Кредиты
$Description: макрос выполнения шага "Корректировать процентный доход?"
*/

IMPORT PTInter, mmlibr, mmservop;

PRIVATE VAR ExecDate;

PRIVATE MACRO Установлена3СтадияОбесц(deal)
    VAR
        RsbReslnk = TRsbDataSet("select 1 from dmmhstimp_dbt where t_dealid = " + deal.DealID + " and t_impgrade = 2" +
                                 " and t_date in (select max(t_date) from dmmhstimp_dbt where t_dealid = " + deal.DealID + 
                                 " and t_impgrade = 2)");
    // по сделке установлена 3 стадия обесценения
    if (RsbReslnk.MoveNext()) 
        return true;
    end;
    return false;
END;

PRIVATE MACRO БылаУстановлена12СтадияОбесц(deal)
    VAR
        RsbReslnk = TRsbDataSet("select 1 from dmmhstimp_dbt where t_dealid = " + deal.DealID + " and (t_impgrade = 0 or t_impgrade = 1)" +
                                 " and t_date <= (select min(t_valuedate) from dpmpaym_dbt where t_dockind = " + deal.BofficeKind  + 
                                 " and t_documentid = " + deal.DealID + " and t_purpose = 10 and t_paymstatus = 32000)");

    if (RsbReslnk.MoveNext()) 
        return true;
    end;
    return false;
END;

PRIVATE MACRO КорректироватьПроцетныйДоход(deal)
    VAR flag, stat = 0, AsCategory = 0;

    GetRegistryValue("MMARK\\МСФО_ПРОЦ_ДОХ_ПО_КРЕД_ОБЕСЦЕН",
        V_BOOL, flag, stat);
    if (not flag)
        return false;
    end;
    // привлечение
    if (IsBUY(GetOperationGroup (deal.DealType)))
        return false;
    end;
    GetMainObjAttr(NULL, OBJTYPE_MMARKDEAL, UniID(deal, OBJTYPE_MMARKDEAL), 5, AsCategory, NULL, NULL, ExecDate);
    if ((AsCategory != 1) and (AsCategory != 2))
        return false;
    end;
    if (not Установлена3СтадияОбесц(deal))
        return false;
    end;
    if (not БылаУстановлена12СтадияОбесц(deal))
        return false;
    end;
    
    return true;
END;

/*----------------------------------------------------------------------------
    Выполнение шага
----------------------------------------------------------------------------*/
macro ExecuteCaseStep(Kind_Operation, Number_Step, primdoc, KindDoc)
    record deal (dl_tick);
    SetBuff( deal, primdoc );

    ExecDate     = {curdate};

    if (КорректироватьПроцетныйДоход(deal))
        return "960";
    end;

    // для блока 230507 "Начисление процентов" вызывать следующий шаг не нужно
    if (Number_Step == 955)
        return "";
    end;

    return "1000";
END;

NameMacroFile = "mmisadjint_j.mac";
