/*-------------------------------------------------------------------------
          Автоматизированная банковская система RS-Bank v5.1
                 Copyright (c) R-Style Software Lab

  Имя файла        : fxcsmove.mac

  Библиотека       : FOREX

  Описание         : Функция шага "Планировать перенос сделки по срокам?"

  Программист      : Kalashnikov Michael (KMV)

  Создан           : 3.12.2001
-------------------------------------------------------------------------*/

import InsCarryDoc, fxlb, fxtransf;

MACRO FX_DoPeriodsMoveCase(fd)
  var NewOperDate,
      NoStep,  // нет, снятие сделки с внебалансового учета
      YesStep; // да, перенос планировать
  
  if (fd.leg.rec.LegID == DL_LEGID_BASE)
     YesStep = string(FX_STEP_MOVEPERIODS);
     NoStep  = string(FX_STEP_RESETNONBALANCE);
  else
     YesStep = string(FX_STEP_MOVEPERIODS_REV);
     NoStep  = string(FX_STEP_RESETNONBALANCE_REV);
  end;

  if (fd.DealType != DL_FORWARDDEAL)
     return NoStep;
  elif(not FX_GetTransferActivateDate(fd, null, NewOperDate))
     return NoStep;
  end;

  if (not fd.Error)
      if (fd.leg.rec.LegID == DL_LEGID_BASE)
        if (not DefineOprDate(FX_OPERDATE_PERIOD, NewOperDate))
            return 1;
        end;
      else
        if (not DefineOprDate(FX_OPERDATE_PERIOD_REV, NewOperDate))
            return 1;
        end;
      end;
      return YesStep;
  elif (fd.Error == 8400)
      return NoStep;
  end;

  return 1;
END;
