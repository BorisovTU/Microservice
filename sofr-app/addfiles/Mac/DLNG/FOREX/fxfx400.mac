/*-------------------------------------------------------------------------
          Автоматизированная банковская система RS-Bank v5.1
                 Copyright (c) R-Style Software Lab

  Имя файла        : fxfx400.mac

  Библиотека       : FOREX

  Описание         : Шаг "Исполнение входящих платежей" (квитовка)

  Программист      : Kalashnikov Michael (KMV)

  Создан           : 14.1.2002
-------------------------------------------------------------------------*/
import fxstep, fxpayreq, fxorder;

record deal(dl_tick);

MACRO ExecuteStep(Buffer, Document)
  SetBuff(deal, Document );
  SetBuff(FX_Doc, Buffer );
  SetBuff(FX_mc, Buffer );

  if (not FX_ExecuteStepFunction(deal.DealID, DL_LEGID_BASE, "FX_KvitRequirement"))
    return 1;
  end;
  return 0;
END;

MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

  if (errTrn OR (CommitOrRollback==2)) 
    /* Произошла ошибка или происходит откат */
    return;
  end;

  PrintOrderInBuch( FirstDoc, ID_Operation, ID_Step,
    	            FALSE, TRUE, FALSE);  
END;

MACRO PrintStepDocs (
                ID_Operation,  /* Номер экземпляра операции */
                ID_Step,       /* Номер шага операции */
                Kind_Operation,/* Вид операции */
                KindStep)      /* Вид шага операции */

  var oproper = TBfile("oproper.dbt"),
       dl_tick = TBfile("dl_tick.dbt") ;
  RECORD tick(dl_tick);
    
  oproper.rec.ID_Operation = ID_Operation;
    
  if (not oproper.GetEq )
    msgbox( "Не найдена сделка ", ID_Operation );
    return 1;
  end;  

  ClearRecord( tick );
    
  if ( (not RestoreFromUniID(oproper.rec.DocumentID, dl_tick, OBJTYPE_CONVDEAL,oproper.rec.DocKind)) OR       
       (not GetEQ(dl_tick)) )    
    msgbox( "Не найдена сделка ");
    return 1;
  end;    

  Copy (tick, dl_tick);

  PrintOrder( ID_Operation,ID_Step,FALSE,TRUE,FALSE,tick );

  exit(1); 

END;

