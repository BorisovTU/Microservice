/*-------------------------------------------------------------------------
          Автоматизированная банковская система RS-Bank v6.0
                 Copyright (c) R-Style Software Lab

  Имя файла        : fxtransf.mac

  Библиотека       : FOREX

  Описание         : Определение дат переноса по срокам (#67444)

  Создан           : 28.11.2005
-------------------------------------------------------------------------*/

import DealsInter, dltransf, fxlb;

// Вычисляет даты в которые должен происходить перенос по срокам на внебалансе
// в ActionDate возвр. теоретическая дата переноса (без учета выходных),
//   на эту дату беруться характеристики счетов
// в ActivateDate возвр. реальная дата переноса, на которую будет спланирован шаг, 
//   открыты счета и на которую пойдут проводки (#67444)
// Если вернет false - перенос не нужен
MACRO FX_GetTransferActivateDate(fd, ActionDate, ActivateDate)
  record Period("mcperiod");
  var RegDate;  // дата валютирования

  if (fd.leg.rec.LegID == DL_LEGID_BASE)
    RegDate    = fd.GetOperDate(FX_OPERDATE_VAL);
    ActionDate = fd.GetOperDate(FX_OPERDATE_PERIOD, Period);
  else 
    RegDate    = fd.GetOperDate(FX_OPERDATE_VAL_REV);
    ActionDate = fd.GetOperDate(FX_OPERDATE_PERIOD_REV, Period);
  end;

  ActivateDate = GetTransferActivateDate( Period, ActionDate );
  if(ActivateDate == Date( 0, 0, 0 )) // Перенос по срокам не нужен
     return false;
  elif( (GetTransferMode() == TRANSFERMODE_NO) and ((RegDate - ActivateDate) < 1) )
     return false;   // снятие сделки с внебалансового учета (#57483)
  end;

  SetParm( 2, ActivateDate );
  SetParm( 1, ActionDate );

  return true;
END;

