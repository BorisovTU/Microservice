/*
$Name:        fxrsrv_j.mac
$Module:      Конверсионные операции
$Description: Шаг формирование резерва по сделке
*/
/*************************************************************************
         Автоматизированная банковская система RS-Bank v6.0
                 Copyright (c) R-Style Software Lab

  Имя файла    :  fxrsrv_j.mac
  Описание     :  Шаг формирование резерва по сделке
************************************************************************/
import FXInter, FIInter, CurrInter, fxlb, fxcarry, fxservop, "dlcarry.inc";;


private macro ПроводкиШага(tick, leg, ККС, ПР, ККС2, ПР2,OprDate:date)
var
      КатДебет,  КатКредит,
      СчетДебет, СчетКредит,
      FIRoleDebet,  FIRoleCredit,
      СуммаПроводки = $0,
      НазначениеПроводки,
      fd = FXFirstDoc(DL_FXLEG,leg.rec.ID, true),
      delta       = $0,          // Изменение резерва
      reslnk = TBfile("dlreslnk.dbt");
      //  резерв для прямой части СВОП
      if(Rnew1 != Rold1)

         delta = Rnew1 - Rold1;

		   if(Rnew1 == 0) // Списание резерва

            КатДебет  = "Резерв, договор";
            КатКредит = "+РС";

            НазначениеПроводки = "Списание резерва";
         else

            if(delta > 0) // Создание/увеличение резерва

               КатДебет  = "-РС";
               КатКредит = "Резерв, договор";
               НазначениеПроводки = "Создание/увеличение резерва";

            else // Уменьшение резерва

               КатДебет  = "Резерв, договор";
               КатКредит = "+РС";
               НазначениеПроводки = "Уменьшение резерва";

            end;

            СуммаПроводки = abs(delta);
         end;

         if ((КатДебет  == "-РС") or (КатДебет  == "+РС"))
            FIRoleDebet = FIROLE_RVP;
            FIRoleCredit = NULL;
         else
            FIRoleDebet = NULL;
            FIRoleCredit = FIROLE_RVP;
         end;

         if( not FX_GetDocAccount( КатДебет,  fd,  СчетДебет,  MC_OPENACC_CREATE,OprDate, NatCur, NULL, NULL, NULL,FIRoleDebet) or
              not FX_GetDocAccount( КатКредит, fd,  СчетКредит, MC_OPENACC_CREATE,OprDate, NatCur, NULL, NULL, NULL,FIRoleCredit) )
     	   return;
         end;


         if(Rnew1 == 0)
            // сумма на счете
            СуммаПроводки = RestA (СчетДебет, OprDate);
            if(СуммаПроводки == $0)
               return;
            end;
         end;

         if (isSwapDeal)
            if (НазначениеПроводки == "Списание резерва")
		       СуммаПроводки = СуммаПроводки - Rold2;
			end;
            НазначениеПроводки = НазначениеПроводки + " по 1-й части сделки СВОП";
         end;
         DocCarry( 0,                 
                    1,                 /*Глава*/
                    NATCUR,            /*Валюта*/
                    СчетДебет,         /*Дебет*/
                    СчетКредит,        /*Кредит*/
                    СуммаПроводки,     /*сколько*/
                    OprDate,           /*За какое число*/
                    0,                 /*CarryResult*/
                    НазначениеПроводки
                  );
      end;

      // резерв для обратной части СВОП
      if(Rnew2 != Rold2)

         delta = Rnew2 - Rold2;

		   if(Rnew2 == 0) // Списание резерва

            КатДебет  = "Резерв, договор";
            КатКредит = "+РС";

            НазначениеПроводки = "Списание резерва";
         else

            if(delta > 0) // Создание/увеличение резерва

               КатДебет  = "-РС";
               КатКредит = "Резерв, договор";
               НазначениеПроводки = "Создание/увеличение резерва";

            else // Уменьшение резерва

               КатДебет  = "Резерв, договор";
               КатКредит = "+РС";
               НазначениеПроводки = "Уменьшение резерва";

            end;

            СуммаПроводки = abs(delta);
         end;
			
         if ((КатДебет  == "-РС") or (КатДебет  == "+РС"))
            FIRoleDebet = FIROLE_RVP;
            FIRoleCredit = NULL;
         else
            FIRoleDebet = NULL;
            FIRoleCredit = FIROLE_RVP;
         end;

         if( not FX_GetDocAccount( КатДебет,  fd,  СчетДебет,  MC_OPENACC_CREATE,OprDate, NatCur, NULL, NULL, NULL,FIRoleDebet) or
              not FX_GetDocAccount( КатКредит, fd,  СчетКредит, MC_OPENACC_CREATE,OprDate, NatCur, NULL, NULL, NULL,FIRoleCredit) )
     	   return;
         end;


         if(Rnew2 == 0)
            // сумма на счете
            СуммаПроводки = RestA (СчетДебет, OprDate);
            if(СуммаПроводки == $0)
               return;
            end;
         end;
         if (НазначениеПроводки == "Списание резерва")
		    СуммаПроводки = СуммаПроводки - Rold1;
		 end;
         НазначениеПроводки = НазначениеПроводки + " по 2-й части сделки СВОП";

         DocCarry( 0,                 
                    1,                 /*Глава*/
                    NATCUR,            /*Валюта*/
                    СчетДебет,         /*Дебет*/
                    СчетКредит,        /*Кредит*/
                    СуммаПроводки,     /*сколько*/
                    OprDate,           /*За какое число*/
                    0,                 /*CarryResult*/
                    НазначениеПроводки
                  );
      end;		

	   if ((Rnew1 != Rold1) or (Rnew2 != Rold2))

		    reslnk.clear();

          reslnk.rec.ParentID             = tick.DealID;           // Порождающий документ
          reslnk.rec.ChildID              = OprServDoc.DocumentID; // Порожденный документ
          reslnk.rec.Type                 = 3;        // Тип связи
          reslnk.rec.LnkDate              = OprDate;  // Дата (???)
          reslnk.rec.QualityCategory      = ККС;      // Категория качества
          reslnk.rec.QualityCategorySwap  = ККС2;      // Категория качества
          reslnk.rec.ReservePercent       = ПР;       // Процент резерва
          reslnk.rec.ReservePercentSwap   = ПР2;       // Процент резерва
          reslnk.rec.SecurityCurrency     = NATCUR;   // Валюта обеспечения (заглушка)
          reslnk.rec.ReserveKind          = 1;        // Вид резерва
          reslnk.rec.ReserveDate          = OprDate;  // Дата расчета резерва
          reslnk.rec.ReserveAmount        = Rnew1;     // Сумма резерва
          reslnk.rec.ReserveAmountSwap    = Rnew2;     // Сумма резерва
          reslnk.rec.IsManual 		       = 0;  // Признак пользовательской корректировки
          reslnk.rec.RiseQC   		       = 0;  // Повышение ККС
          reslnk.rec.ReserveSubKind       = 0;  //
          reslnk.rec.TypeBase  		       = 1;  //

          FX_InsertDLRESLNK(reslnk);
      end;

	 
end;

macro ExecuteStep( Buffer, ticket )
var 
    leg = TBfile("dl_leg.dbt"),
    stat = 0,
    ККС, ПР, ККС2, ПР2, ВК;

    record tick ( dl_tick );

    SetBuff( tick, ticket );
    DL_PrepareCarryBuffer (Buffer);

    leg.rec.DealID = tick.DealID;
    leg.rec.LegKind = 0;
    leg.rec.LegID = 0;
    if(not leg.GetEQ)
       return 1;
    end;

    stat = FX_CalcReserve(OprServDoc, tick, @ККС, @ПР, @ККС2, @ПР2);
    if(stat == 0)
       ПроводкиШага(tick, leg, ККС, ПР, ККС2, ПР2, OprServDoc.CommDate);
    end;

    return stat;
end;
FX_NameMacroFile = "fxrsrv_j.mac";
