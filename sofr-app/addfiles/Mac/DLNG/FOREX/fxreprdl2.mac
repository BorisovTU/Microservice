/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.0                                          R-Style Software Lab
  Файл подсистемы "КО"

  Печать отчета "Реестр сделок денежного рынка (КО)"
  RSForms вариант.

  Ограничения: - в подвале выводится одна сумма, без учета валюты
               - сделать отбор сделок по валюте 
                 (хотя флаг меню DISINEMPTYSCROL эту проблему успешно решает)
               - возможно, надо учитывать фильтр скроллинга?
└───────────────────────────────────────────────────────────────────────────*/

/*{{DESIGNER_INFO /l:forex.lbr /r:FXREPDL2 /t:102*/
import RSForms;
import RsbObjFactory, RsbDataSet, globals, DealsInter, dlsole;

/*{{DESIGNER_HEADERS()*/
/*DESIGNER_HEADERS()}}*/


/* Параметры настройки отчета */
PRIVATE VAR
_DealStatus = DL_UNDEFSTAT, // статус сделок для отбора
FI_Req = -1,
FI_Liab = -1;


/*{{DESIGNER_CLASS_RSL_TSECTION1FOOTER()*/
class (TForm) TFooter (owner:object, name:string)
/*DESIGNER_CLASS_RSL()}}*/

/*{{DESIGNER_CONSTRBASE_RSL_TSECTION1FOOTER()*/
   InitTForm (owner, name);
/*DESIGNER_CONSTRBASE_RSL()}}*/
/*{{DESIGNER_VAL_RSL_TSECTION1FOOTER(Post3,Post2,Post1,FIO3,FIO2,FIO1)*/
   var Post3 = TControl (this, "Post3");
   var Post2 = TControl (this, "Post2");
   var Post1 = TControl (this, "Post1");
   var FIO3 = TControl (this, "FIO3");
   var FIO2 = TControl (this, "FIO2");
   var FIO1 = TControl (this, "FIO1");
/*DESIGNER_VAL_RSL()}}*/

/*{{DESIGNER_CMD_SET_RSL_TSECTION1FOOTER()*/
/*DESIGNER_CMD_SET_RSL()}}*/

/*{{DESIGNER_HANDLERS_ADD_RSL_TSECTION1FOOTER()*/
/*DESIGNER_HANDLERS_ADD_RSL()}}*/

/*{{DESIGNER_HANDLERS_RSL_TSECTION1FOOTER()*/
/*DESIGNER_HANDLERS_RSL()}}*/

end;


/*{{DESIGNER_CLASS_RSL_TSECTION1HEADER()*/
class (TForm) THeader (owner:object, name:string)
/*DESIGNER_CLASS_RSL()}}*/

/*{{DESIGNER_CONSTRBASE_RSL_TSECTION1HEADER()*/
   InitTForm (owner, name);
/*DESIGNER_CONSTRBASE_RSL()}}*/
/*{{DESIGNER_VAL_RSL_TSECTION1HEADER(Time,Date,BankName)*/
   var Time = TControl (this, "Time");
   var Date = TControl (this, "Date");
   var BankName = TControl (this, "BankName");
/*DESIGNER_VAL_RSL()}}*/

/*{{DESIGNER_CMD_SET_RSL_TSECTION1HEADER()*/
/*DESIGNER_CMD_SET_RSL()}}*/

/*{{DESIGNER_HANDLERS_ADD_RSL_TSECTION1HEADER()*/
/*DESIGNER_HANDLERS_ADD_RSL()}}*/

/*{{DESIGNER_HANDLERS_RSL_TSECTION1HEADER()*/
/*DESIGNER_HANDLERS_RSL()}}*/

end;


/*{{DESIGNER_CLASS_RSL_TSECTION1()*/
class (TRollSection) TSection1 (owner:object, name:string)
/*DESIGNER_CLASS_RSL()}}*/

/*{{DESIGNER_CONSTRBASE_RSL_TSECTION1()*/
   InitTRollSection (owner, name);
/*DESIGNER_CONSTRBASE_RSL()}}*/
/*{{DESIGNER_VAL_RSL_TSECTION1(Header,ReportTable,Footer)*/
   var Header = THeader (this, "Header");
   var ReportTable = TControl (this, "ReportTable");
   var Footer = TFooter (this, "Footer");
/*DESIGNER_VAL_RSL()}}*/

/*{{DESIGNER_CMD_SET_RSL_TSECTION1()*/
/*DESIGNER_CMD_SET_RSL()}}*/

/*{{DESIGNER_HANDLERS_ADD_RSL_TSECTION1(OnLoad,OnGetContents)*/
   addHandler (-2147385343, R2M(this, "OnLoad"));
   addHandler (4, R2M(this, "OnGetContents"));
/*DESIGNER_HANDLERS_ADD_RSL()}}*/
/*{{DESIGNER_HANDLERS_RSL_TSECTION1(OnLoad,OnGetContents)*/
   macro OnLoad (Sender: Object, pbCancel: @Bool)
   end;

   macro OnGetContents (Sender: Object)
   end;

/*DESIGNER_HANDLERS_RSL()}}*/

end;


/*{{DESIGNER_CLASS_RSL_TFXREPDL2()*/
class (TRollForm) TFXREPDL2 (owner:object, name:string)
/*DESIGNER_CLASS_RSL()}}*/

/*{{DESIGNER_CONSTRBASE_RSL_TFXREPDL2()*/
   InitTRollForm (owner, name);
/*DESIGNER_CONSTRBASE_RSL()}}*/
   setTemplate ("forex.lbr", "FXREPDL2");

/*{{DESIGNER_VAL_RSL_TFXREPDL2(Section1)*/
   var Section1 = TSection1 (this, "Section1");
/*DESIGNER_VAL_RSL()}}*/
   var Header = THeader (this, "Section1\\Header");
   var Footer = TFooter (this, "Section1\\Footer");

//   Create(group);

/*{{DESIGNER_CMD_SET_RSL_TFXREPDL2()*/
/*DESIGNER_CMD_SET_RSL()}}*/

/*{{DESIGNER_HANDLERS_ADD_RSL_TFXREPDL2(OnLoad,OnLoadSessionData)*/
   addHandler (-2147385343, R2M(this, "OnLoad"));
   addHandler (-2147384826, R2M(this, "OnLoadSessionData"));
/*DESIGNER_HANDLERS_ADD_RSL()}}*/

   var m_RfxDeal = RsbObjectFactory.GetObject("RfxDeal2");
   var m_tbl = TReportTable(this, "Section1\\ReportTable");

   macro FillTable()
      var filter_str = "BofficeKind = 100";

      // Фильтр по ФИ
      if(FI_Req > -1)
         if(filter_str != "") filter_str =  filter_str + " and "; end;
         filter_str = filter_str + " DemandFIID = " + FI_Req;
      end;
      if(FI_Liab > -1)
         if(filter_str != "") filter_str =  filter_str + " and "; end;
         filter_str = filter_str + " LiabFIID = " + FI_Liab;
      end;
      // Фильтр по статусу сделки
      if(_DealStatus == DL_UNDEFSTAT)
      elif(_DealStatus == DL_OPENCLOSED)
         if(filter_str != "") filter_str =  filter_str + " and "; end;
         filter_str = filter_str + " DealStatus > " + DL_PREPARING;
      else
         if(filter_str != "") filter_str =  filter_str + " and "; end;
         filter_str = filter_str + " DealStatus = " + _DealStatus;
      end;

      if(filter_str != "")
         m_RfxDeal.SetFilter( filter_str );
      end;
      m_RfxDeal.AddSortFld("DealID");
      m_RfxDeal.AddSortFld("LegID");
      m_RfxDeal.AddSortFld("LegNumber");
      m_RfxDeal.ApplyFilter();
//////////////////////////////////////////////

      var tbl_copy = TReportTable(m_tbl, 1);
      Section1.addControl(tbl_copy);

      var l_row = tbl_copy.AddLine( "Row" );
      l_row.Line("Row1").BindItem.DataSource = m_RfxDeal;
      l_row.Line("Row1").ExpandRowset();

   end;

   macro FillFooter()
      var ПодразделениеБО = 2, должностьНач = "", фиоНач = "", должностьИсп = "", фиоИсп = "";

      if( {Name_Boss} == "" )
         {Name_Boss} = "Директор банка";
      end;
      Footer.Post1.Value = {Name_Boss};
      Footer.FIO1.Value  = {FIO_Boss};

      НайтиНачальникаБО( ПодразделениеБО, @должностьНач, @фиоНач );
      Footer.Post2.Value = должностьНач;
      Footer.FIO2.Value  = фиоНач;

      НайтиИсполнителя( @должностьИсп, @фиоИсп );
      Footer.Post3.Value = должностьИсп;
      Footer.FIO3.Value  = фиоИсп;

//      PutElement(Section1.Footer);
   end; 

   macro PutAllElements()
/*{{DESIGNER_PUT_ELEMENT_RSL_TFXREPDL(Header,ReportTable,Footer)*/
      Header.BankName.Value = {Name_Bank};
      Header.Date.Value = {curdate};
      Header.Time.Value = time();

    var form1 = TControl(Header, 1);
    Section1.addControl(form1, "f1");
//      Header.PutElement();
      FillTable();
      FillFooter();
    var form2 = TControl(Footer, 1);
    Section1.addControl(form2, "f1");
//      PutElement(ReportTable);
//      PutElement(Footer);
/*DESIGNER_PUT_ELEMENT_RSL()}}*/
   end;

/*{{DESIGNER_HANDLERS_RSL_TFXREPDL2(OnLoad,OnLoadSessionData)*/
   macro OnLoad (Sender: Object, pbCancel: @Bool)
      PutAllElements();
   end;

   macro OnLoadSessionData (Sender: Object)
   end;

/*DESIGNER_HANDLERS_RSL()}}*/

end;


/*{{DESIGNER_VARIABLE(FXREPDL2)*/
//private macro RsfmMain
//  var FXREPDL2 = TFXREPDL2 (); FXREPDL2.Print (TRUE);
//end;
/*DESIGNER_VARIABLE()}}*/


PRIVATE MACRO AddDealStatus(sqlwhere:@string)
  if(_DealStatus == DL_UNDEFSTAT)
  elif(_DealStatus == DL_OPENCLOSED)
     sqlwhere = sqlwhere + " AND tick.t_DealStatus > " + DL_PREPARING;
  else
     sqlwhere = sqlwhere + " AND tick.t_DealStatus = " + _DealStatus;
  end;
END;


PRIVATE MACRO PrintBody(/*grp*/)
var FXREPDL2,
    DataSet, ok = false,
    sqltext  = "select count(*) from ddl_tick_dbt tick, ddl_leg_dbt leg ",
    sqlwhere = " where tick.t_bofficekind = 100 " +
                 " and tick.T_DEALID = leg.T_DEALID and leg.t_legkind = 0";
    // статус сделки
    AddDealStatus(@sqlwhere);
    // ФИ
/*    if(FI_Req > -1)
       if( TypeDealLeg(dlTick, dlLeg) )
          sqlwhere = sqlwhere + " AND leg.T_CFI = case when TypeDoc = 'B' and LegID = 0 then " + FI_Req;
       else
          sqlwhere = sqlwhere + " AND leg.T_PFI = " + FI_Req;
       end;
    end;
    if(FI_Liab > -1)
       if( TypeDealLeg(dlTick, dlLeg) )
          sqlwhere = sqlwhere + " AND leg.T_PFI = " + FI_Liab;
       else
          sqlwhere = sqlwhere + " AND leg.T_CFI = " + FI_Liab;
       end;
    end;*/

    DataSet = TRsbDataSet(sqltext + sqlwhere);
    if(DataSet.MoveNext)
       FXREPDL2 = TFXREPDL2(/*grp*/);
       FXREPDL2.Print(TRUE);
       ok = true;
    end;

    return ok;
END;


/* Печать отчета */
MACRO printReportRSF( FIID_Request, FIID_Liability, p_dealstatus )
//var grp = TReportsGroup();

   /* Установить параметры отчета по переданным значениям */
   FI_Req = FIID_Request;
   FI_Liab = FIID_Liability;
   _DealStatus = p_dealstatus;

   if(PrintBody(/*grp*/) == true)
//      grp.Print( TRUE );
   else
      msgbox( "Нет данных, удовлетворяющих заданной фильтрации." );
   end;

END;
