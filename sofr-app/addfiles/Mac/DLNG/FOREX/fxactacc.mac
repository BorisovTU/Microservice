/*
$Name:        fxactacc.mac
$Module:      Конверсионные операции
$Description: Актуализация счетов
*/
IMPORT fxcarry, fxlb;

MACRO FX_ActAccountsForFD(fd)
  var ComCur, ReqCur, ok, CurrencyDate,
      TranModeReq = 0, TranModeCom = 0, stat = 0, 
      AccMarzaPlus = "",
      AccMarzaMinus = "",
      AccReqD = "",
      AccReqC = "",
      AccComD = "",
      AccComC = "",
      paym = null,
      DocKind = fd.GetTick().BofficeKind,
      DocumentID = fd.GetTick().DealID,
      Purpose = "";

  fd.SetCurrency(ComCur, ReqCur);
  
  GetRegistryValue("КОНВЕРСИОННЫЕ ОПЕРАЦИИ\\ИСПОЛЬЗОВАНИЕ ТС\\ИСПОЛНЕНИЕ ОБЯЗАТЕЛЬСТВ",
                   V_INTEGER, TranModeCom, stat);

  if (not stat)
    GetRegistryValue("КОНВЕРСИОННЫЕ ОПЕРАЦИИ\\ИСПОЛЬЗОВАНИЕ ТС\\ИСПОЛНЕНИЕ ТРЕБОВАНИЙ",
                     V_INTEGER, TranModeReq, stat);
  end;
  if (stat)
    fx_error("Ошибка при получении значений реестра");
    return false;
  end;

  /*поверка даты выполнения шага*/
  if( not CorrectValueDate(CurrencyDate) )
      return false;
  end;

  if (IsMOVING(fd.GetTick().DealGroup))
      ok = FX_GetDocAccount("+КВ, РКО", fd, null, null, CurrencyDate, NatCur, NULL, NULL, NULL, NULL);
      if (ok)
        ok = FX_GetDocAccount("-КВ, РКО", fd, null, null, CurrencyDate, NatCur, NULL, NULL, NULL, NULL);
      end;
      if (ok)
          ok = FX_GetDocAccount("+Расчеты", fd, null, null, CurrencyDate, ReqCur, NULL, NULL, NULL, FIROLE_FIREQ, NULL, MC_PAIRACCMODE_MANUAL);
      end;
      if (ok)
          ok = FX_GetDocAccount("-Расчеты", fd, null, null, CurrencyDate, ComCur, NULL, NULL, NULL, FIROLE_FICOM, NULL, MC_PAIRACCMODE_MANUAL);
      end;
  else
      /*для всех сделок*/
      ok = FX_GetDocAccount("+ОТО", fd, null, null, CurrencyDate, ReqCur, NULL, NULL, NULL, FIROLE_FIREQ);  
      if (ok)
           ok = FX_GetDocAccount("-ОТО", fd, null, null, CurrencyDate, ComCur, NULL, NULL, NULL, FIROLE_FICOM);
      end;

      /*для сделок SPOT и FORWARD*/
      if (ok AND (not fd.PartyIsMarket) AND((fd.DealType == DL_SPOTDEAL) OR (fd.DealType == DL_FORWARDDEAL)))
    	 if (ok)
    	   ok = FX_GetDocAccount("Резерв, договор", fd, null, null, CurrencyDate, NatCur, NULL, NULL, NULL, FIROLE_FIREQ);
    	 end;
        if (ok)
          //ok = FX_GetDocAccount("+РС", fd, null, null, CurrencyDate, NatCur, NULL, NULL, NULL, FIROLE_RVP);
        end;
    	 if (ok)
          //ok = FX_GetDocAccount("-РС", fd, null, null, CurrencyDate, NatCur, NULL, NULL, NULL, FIROLE_RVP);
        end;
      end;

      /*для сделок SPOT*/
      if (ok AND (fd.DealType == DL_SPOTDEAL) AND
          ((fd.GetTick().DealDate != fd.GetLeg().Maturity) OR 
           (fd.GetTick().DealDate != fd.GetLeg().Expiry)))
              ok = FX_GetDocAccount("+Форвард, прочие", fd, null, null, CurrencyDate, ReqCur, NULL, NULL, NULL, FIROLE_FIREQ);
              if (ok)
                ok = FX_GetDocAccount("СчКорреспГлаваГ", fd, null, null, CurrencyDate, NatCur, NULL, NULL, NULL, FIROLE_CORACC_ACTIVE);
              end;
              if (ok)
                ok = FX_GetDocAccount("СчКорреспГлаваГ", fd, null, null, CurrencyDate, NatCur, NULL, NULL, NULL, FIROLE_CORACC_PASSIVE);
              end;
        if (ok)
          ok = FX_GetDocAccount("-Форвард, прочие", fd, null, null, CurrencyDate, ComCur, NULL, NULL, NULL, FIROLE_FICOM);
        end;
      end;
      /*для сделок FORWARD*/
      if (ok AND (fd.DealType == DL_FORWARDDEAL))
        ok = FX_GetDocAccount("+Форвард, дрейф", fd, null, null, CurrencyDate, ReqCur, NULL, NULL, NULL, fd.GetFIRoleByCategory("+Форвард, дрейф", ReqCur, FIROLE_FIREQ));
        if (ok)
          ok = FX_GetDocAccount("-Форвард, дрейф", fd, null, null, CurrencyDate, ComCur, NULL, NULL, NULL, fd.GetFIRoleByCategory("-Форвард, дрейф", ComCur, FIROLE_FICOM));
        end;
        if (ok)
          ok = FX_GetDocAccount("СчКорреспГлаваГ", fd, null, null, CurrencyDate, NatCur, NULL, NULL, NULL, FIROLE_CORACC_ACTIVE);
        end;
        if (ok)
          ok = FX_GetDocAccount("СчКорреспГлаваГ", fd, null, null, CurrencyDate, NatCur, NULL, NULL, NULL, FIROLE_CORACC_PASSIVE);
        end;
     end;

     if (ok AND (not fd.PartyIsMarket))
         if (bAND(TranModeCom, FX_TRAN_BEFOREPAYMENT))
            ok = FX_GetDocAccount("-Расчеты", fd, null, null, CurrencyDate, ComCur, NULL, NULL, NULL, FIROLE_FICOM);
         end;
    
         if (ok AND bAND(TranModeReq, FX_TRAN_BEFOREPAYMENT))
            ok = FX_GetDocAccount("+Расчеты", fd, null, null, CurrencyDate, ReqCur, NULL, NULL, NULL, FIROLE_FIREQ);
         end;
      elif (ok AND (fd.PartyIsMarket))
            ok = FX_GetDocAccount("-Биржа", fd, null, null, CurrencyDate, ComCur, NULL, NULL, NULL, FIROLE_FICOM);
         if (ok)
            ok = FX_GetDocAccount("+Биржа", fd, null, null, CurrencyDate, ReqCur, NULL, NULL, NULL, FIROLE_FIREQ);
         end;
      end;
  end;

  if (ok)
    ok = FX_GetCommitmentAccount(fd, TranModeCom, AccComD, AccComC, CurrencyDate);
    if (ok)
      Purpose = FX_GetPaymentPurpose(1, fd.GetLeg().LegID, FX_IsSale(fd.GetTick().TypeDoc));
      paym = RsbPayment( DocKind, DocumentID, Purpose, 0/*SubPurpose*/ );
      if( paym.PaymentID == 0 )
         return false;
      else
        paym.SetPayerPI (PAYMENTS_GROUP_UNDEF, 
                         paym.PayerBankID,
                         paym.PayerBankCodeKind,
                         paym.PayerBankCode,
                         paym.PayerBankName,
                         paym.PayerBankCorrAcc,
                         ComCur,
                         1,
                         AccComD,
                         paym.Payer,
                         paym.PayerName,
                         paym.PayerINN,
                         paym.PayerCodeKind,
                         "");

        paym.FuturePayerAccount = AccComD;

          if (fd.PartyIsMarket)
              paym.SetReceiverPI (PAYMENTS_GROUP_UNDEF, 
                                  paym.ReceiverBankID,
                                  paym.ReceiverBankCodeKind,
                                  paym.ReceiverBankCode,
                                  paym.ReceiverBankName,
                                  paym.ReceiverBankCorrAcc,
                                  ComCur,
                                  1,
                                  AccComC,
                                  paym.Receiver,
                                  paym.ReceiverName,
                                  paym.ReceiverINN,
                                  paym.ReceiverCodeKind,
                                  "");

              paym.FutureReceiverAccount = AccComC;
          end;
      end;
    end;
  end;

  if (ok)
    ok = FX_GetRequirementAccount(fd, TranModeReq, AccReqD, AccReqC, CurrencyDate);
    if (ok)
      Purpose = FX_GetPaymentPurpose(0, fd.GetLeg().LegID, FX_IsSale(fd.GetTick().TypeDoc));
      paym = RsbPayment( DocKind, DocumentID, Purpose, 0/*SubPurpose*/ );
      if( paym.PaymentID == 0 )
         return false;
      else
        paym.SetReceiverPI (PAYMENTS_GROUP_UNDEF, 
                            paym.ReceiverBankID,
                            paym.ReceiverBankCodeKind,
                            paym.ReceiverBankCode,
                            paym.ReceiverBankName,
                            paym.ReceiverBankCorrAcc,
                            ReqCur,
                            1,
                            AccReqC,
                            paym.Receiver,
                            paym.ReceiverName,
                            paym.ReceiverINN,
                            paym.ReceiverCodeKind,
                            "");

        paym.FutureReceiverAccount = AccReqC;

          if (fd.PartyIsMarket)
              paym.SetPayerPI (PAYMENTS_GROUP_UNDEF, 
                               paym.PayerBankID,
                               paym.PayerBankCodeKind,
                               paym.PayerBankCode,
                               paym.PayerBankName,
                               paym.PayerBankCorrAcc,
                               ReqCur,
                               1,
                               AccReqD,
                               paym.Payer,
                               paym.PayerName,
                               paym.PayerINN,
                               paym.PayerCodeKind,
                               "");

              paym.FuturePayerAccount = AccReqD;
          end;
      end;
    end;
  end;

  return ok;  
END;
