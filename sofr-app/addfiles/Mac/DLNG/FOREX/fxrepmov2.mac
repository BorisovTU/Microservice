/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.0                                          R-Style Software Lab
  Файл подсистемы "КО"

  Печать отчета "Журнал движения средств (КО)"
  RSForms вариант.

  Ограничения: - сделать "Всего" (74490)
               - доделать фильтрацию при старте
└───────────────────────────────────────────────────────────────────────────*/

import RSForms, RsbObjFactory, RsbDataSet, globals, DealsInter, dlsole, dlreport;

/*{{DESIGNER_HEADERS()*/
/*DESIGNER_HEADERS()}}*/

private var
      g_Contractor, 
      g_Kind_Operation, 
      g_minDealDate, 
      g_maxDealDate, 
      g_minValueDate, 
      g_maxValueDate, 
      g_FIID, 
      g_isSigned,
      g_sqlwhere;

PRIVATE MACRO to_date( _date:date )            
   if( _date != Date(0,0,0) )
      return "TO_DATE( '" + string(_date) + "', 'DD.MM.YYYY' )"; 
   else
      return "TO_DATE( '" + "1.1.1" + "', 'DD.MM.YYYY' )"; 
   end;
end;


/*{{DESIGNER_CLASS_RSL_TFOOTER()*/
class (TForm)TFooter(owner:object, name:string)
/*DESIGNER_CLASS_RSL()}}*/

/*{{DESIGNER_CONSTRBASE_RSL_TFOOTER()*/
   InitTForm(owner,name);
/*DESIGNER_CONSTRBASE_RSL()}}*/
/*{{DESIGNER_VAL_RSL_TFOOTER(Post3,Post2,Post1,FIO3,FIO2,FIO1)*/
   var Post3 = TControl(this, "Post3");
   var Post2 = TControl(this, "Post2");
   var Post1 = TControl(this, "Post1");
   var FIO3 = TControl(this, "FIO3");
   var FIO2 = TControl(this, "FIO2");
   var FIO1 = TControl(this, "FIO1");
/*DESIGNER_VAL_RSL()}}*/

/*{{DESIGNER_CMD_SET_RSL_TFOOTER()*/
/*DESIGNER_CMD_SET_RSL()}}*/

/*{{DESIGNER_HANDLERS_ADD_RSL_TFOOTER()*/
/*DESIGNER_HANDLERS_ADD_RSL()}}*/

/*{{DESIGNER_HANDLERS_RSL_TFOOTER()*/
/*DESIGNER_HANDLERS_RSL()}}*/

end;


/*{{DESIGNER_CLASS_RSL_THEADER2()*/
class (TForm)THeader2(owner:object, name:string)
/*DESIGNER_CLASS_RSL()}}*/

/*{{DESIGNER_CONSTRBASE_RSL_THEADER2()*/
   InitTForm(owner,name);
/*DESIGNER_CONSTRBASE_RSL()}}*/
/*{{DESIGNER_VAL_RSL_THEADER2(ValueDate,DealDate,Contractor,Category,FIID,OprKind)*/
   var ValueDate = TControl(this, "ValueDate");
   var DealDate = TControl(this, "DealDate");
   var Contractor = TControl(this, "Contractor");
   var Category = TControl(this, "Category");
   var FIID = TControl(this, "FIID");
   var OprKind = TControl(this, "OprKind");
/*DESIGNER_VAL_RSL()}}*/

/*{{DESIGNER_CMD_SET_RSL_THEADER2()*/
/*DESIGNER_CMD_SET_RSL()}}*/

/*{{DESIGNER_HANDLERS_ADD_RSL_THEADER2()*/
/*DESIGNER_HANDLERS_ADD_RSL()}}*/

/*{{DESIGNER_HANDLERS_RSL_THEADER2()*/
/*DESIGNER_HANDLERS_RSL()}}*/

end;


/*{{DESIGNER_CLASS_RSL_THEADER()*/
class (TForm)THeader(owner:object, name:string)
/*DESIGNER_CLASS_RSL()}}*/

/*{{DESIGNER_CONSTRBASE_RSL_THEADER()*/
   InitTForm(owner,name);
/*DESIGNER_CONSTRBASE_RSL()}}*/
/*{{DESIGNER_VAL_RSL_THEADER(Time,Date,BankName)*/
   var Time = TControl(this, "Time");
   var Date = TControl(this, "Date");
   var BankName = TControl(this, "BankName");
/*DESIGNER_VAL_RSL()}}*/

/*{{DESIGNER_CMD_SET_RSL_THEADER()*/
/*DESIGNER_CMD_SET_RSL()}}*/

/*{{DESIGNER_HANDLERS_ADD_RSL_THEADER()*/
/*DESIGNER_HANDLERS_ADD_RSL()}}*/

/*{{DESIGNER_HANDLERS_RSL_THEADER()*/
/*DESIGNER_HANDLERS_RSL()}}*/

end;


/*{{DESIGNER_CLASS_RSL_TFXREPDL()*/
class (TReport)TFXREPMOV(group:TReportsGroup)
/*DESIGNER_CLASS_RSL()}}*/
var        m_querystr_totals = "select "
"case when rownum < 2 then 'Всего:' else chr(1) end as ContrName, sl.* "
"from (select sum(PmPaym1.T_AMOUNT) AS DemandAmount, "
"sum(PmPaym2.T_AMOUNT) AS LiabilityAmount, "
"(select FI1.t_FI_Code from dfininstr_dbt FI1 where PmPaym1.T_FIID = FI1.T_FIID) AS DemandFICode, "
"(select FI2.t_FI_Code from dfininstr_dbt FI2 where PmPaym2.T_FIID = FI2.T_FIID) AS LiabFICode "
"FROM  DDL_LEG_DBT leg, DDL_TICK_DBT tick, DPMPAYM_DBT PmPaym1, DPMPAYM_DBT PmPaym2 "
"WHERE ( leg.T_DEALID = PmPaym1.T_DOCUMENTID AND tick.T_BOFFICEKIND = "
"PmPaym1.T_DOCKIND AND ((CASE WHEN tick.T_TYPEDOC = 'B' THEN (CASE WHEN "
"leg.T_LEGID = 1 THEN 4 ELSE 1 END) ELSE (CASE WHEN leg.T_LEGID = 1 "
"THEN 3 ELSE 2 END) END)) = PmPaym1.T_PURPOSE AND ('X') = "
"PmPaym1.T_ISPLANPAYM ) AND "
"(leg.T_DEALID = PmPaym2.T_DOCUMENTID AND tick.T_BOFFICEKIND = "
"PmPaym2.T_DOCKIND AND ((CASE WHEN tick.T_TYPEDOC = 'B' THEN (CASE WHEN "
"leg.T_LEGID = 1 THEN 3 ELSE 2 END) ELSE (CASE WHEN leg.T_LEGID = 1 "
"THEN 4 ELSE 1 END) END)) = PmPaym2.T_PURPOSE AND ('X') = "
"PmPaym2.T_ISPLANPAYM ) AND "
"tick.T_BOFFICEKIND = 100 AND "
"leg.T_DEALID = tick.T_DEALID AND "
"leg.T_LEGKIND = 0 "
"group by PmPaym1.T_FIID, PmPaym2.T_FIID) sl",
       m_totals = CreateObject( "RSDS", "TDataSet", NULL, TRUE );

/*{{DESIGNER_CONSTRBASE_RSL_TFXREPDL()*/
   InitTReport();
/*DESIGNER_CONSTRBASE_RSL()}}*/
   setTemplate("deals2.lbr", "FXREPMOV");

/*{{DESIGNER_VAL_RSL_TFXREPDL(Header,Header2,ReportTable,Totals,Footer)*/
   var Header = THeader(this, "Header");
   var Header2 = THeader2(this, "Header2");
   var ReportTable = TControl(this, "ReportTable");
   var Totals = TControl(this, "Totals");
   var Footer = TFooter(this, "Footer");
/*DESIGNER_VAL_RSL()}}*/

/*{{DESIGNER_CMD_SET_RSL_TFXREPDL()*/
/*DESIGNER_CMD_SET_RSL()}}*/

/*{{DESIGNER_HANDLERS_ADD_RSL_TFXREPDL(OnLoad,OnGetContents)*/
   addHandler(-2147385343, R2M(this, "OnLoad"));
   addHandler(4, R2M(this, "OnGetContents"));
/*DESIGNER_HANDLERS_ADD_RSL()}}*/

   Create(group);

   var m_RfxDeal = RsbObjectFactory.GetObject("RfxDeal2");

   macro FillTable()
      var l_row, l_tbl = TReportTable(),
          filter_str = "";

      PutElement(ReportTable, l_tbl);

      // Контрагент
      if(g_Contractor > -1)
         if(filter_str != "") filter_str =  filter_str + " and "; end;
         filter_str = filter_str + " PartyID = " + g_Contractor;
      end;
      // Вид операции
      if(g_Kind_Operation > -1)
         if(filter_str != "") filter_str =  filter_str + " and "; end;
         filter_str = filter_str + " DealType = " + g_Kind_Operation;
      end;
      // Дата сделки
      if(g_minDealDate != date(0,0,0))
         if(filter_str != "") filter_str =  filter_str + " and "; end;
         filter_str = filter_str + " DealDate >= '" + g_minDealDate + "'";
      end;
      if(g_maxDealDate != date(0,0,0))
         if(filter_str != "") filter_str =  filter_str + " and "; end;
         filter_str = filter_str + " DealDate <= '" + g_maxDealDate + "'";
      end;
      // Дата валютирования
      if(g_minValueDate != date(0,0,0))
         if(filter_str != "") filter_str =  filter_str + " and "; end;
         filter_str = filter_str + " DemandValueDate >= '" + g_minValueDate +
                              "' and LiabilityValueDate >= '" + g_minValueDate + "'";
      end;
      if(g_maxValueDate != date(0,0,0))
         if(filter_str != "") filter_str =  filter_str + " and "; end;
         filter_str = filter_str + " DemandValueDate <= '" + g_maxValueDate +
                              "' and LiabilityValueDate <= '" + g_maxValueDate + "'";
      end;
      if(g_FIID > -1)
         if(filter_str != "") filter_str =  filter_str + " and "; end;
         filter_str = filter_str + " DemandFIID = " + g_FIID + " and LiabFIID = " + g_FIID;
      end;

      if(filter_str != "")
         m_RfxDeal.SetFilter( filter_str );
      end;
      m_RfxDeal.AddSortFld("DealID");
      m_RfxDeal.AddSortFld("LegID");
      m_RfxDeal.AddSortFld("LegNumber");
      m_RfxDeal.ApplyFilter();
      l_row = l_tbl.AddLine( "Row" );
      l_row.Line("Row1").BindItem.DataSource = m_RfxDeal;
      expandrowset(l_row.Line("Row1"));
//      l_row.Line("Row2").BindItem.DataSource = m_totals;
//      expandrowset(l_row.Line("Row2"));

   end;

   macro FillFooter()
      var ПодразделениеБО = 2, должностьНач = "", фиоНач = "", должностьИсп = "", фиоИсп = "";

      if( {Name_Boss} == "" )
         {Name_Boss} = "Директор банка";
      end;
      Footer.Post1.Value = {Name_Boss};
      Footer.FIO1.Value  = {FIO_Boss};

      НайтиНачальникаБО( ПодразделениеБО, @должностьНач, @фиоНач );
      Footer.Post2.Value = должностьНач;
      Footer.FIO2.Value  = фиоНач;

      НайтиИсполнителя( @должностьИсп, @фиоИсп );
      Footer.Post3.Value = должностьИсп;
      Footer.FIO3.Value  = фиоИсп;

      PutElement(Footer);
   end; 

   macro FillHeader2()
      var oprkoper, minDD = "", maxDD = "", minVD = "", maxVD = "";

      if(g_minDealDate != date(0,0,0)) minDD = g_minDealDate; end;
      if(g_maxDealDate != date(0,0,0)) maxDD = g_maxDealDate; end;
      if(g_minValueDate != date(0,0,0)) minVD = g_minValueDate; end;
      if(g_maxValueDate != date(0,0,0)) maxVD = g_maxValueDate; end;
      Header2.DealDate.Text  = minDD + " / " + maxDD;
      Header2.ValueDate.Text = minVD + " / " + maxVD;
      if(g_contractor > -1)
         Header2.Contractor.Text = DL_getPartyShortName( g_contractor );
      else
         Header2.Contractor.Text = "Все";
      end;
//      Category = "";
      Header2.FIID.Text = DL_getCCode( g_fiid );
      if(g_Kind_Operation > -1)
         oprkoper = TRsbDataSet("select t_ShortName from doprkoper_dbt where t_Kind_Operation = "+g_Kind_Operation);
         if( oprkoper.MoveNext )
            Header2.OprKind.Text = oprkoper.ShortName;
		 end;
      else
         Header2.OprKind.Text = "Все";
      end;

      PutElement(Header2);
   end; 

   macro PutAllElements()
      Header.BankName.Value = {Name_Bank};
      Header.Date.Value = {curdate};
      Header.Time.Value = time();
/*{{DESIGNER_PUT_ELEMENT_RSL_TFXREPDL(Header,Header2,ReportTable,Totals,Footer)*/
      PutElement(Header);
      FillHeader2();//PutElement(Header2);
      FillTable();//PutElement(ReportTable);
//      PutElement(Totals);
      if(g_isSigned)
         FillFooter();//PutElement(Footer);
      end;
/*DESIGNER_PUT_ELEMENT_RSL()}}*/
   end;

/*{{DESIGNER_HANDLERS_RSL_TFXREPDL(OnLoad,OnGetContents)*/
   macro OnLoad (Sender: Object, pbCancel: @Bool)
      ReportTable.DoInit();
//      m_totals.Init( 1, GetIniFileValue ("rsreq.ini", "CONNSTRING"), m_querystr_totals);
//      Totals.DoInit();
   end;

   macro OnGetContents (Sender: Object)
      PutAllElements();
   end;

/*DESIGNER_HANDLERS_RSL()}}*/

end;


MACRO PrintBody(grp)
var FXREPMOV,
    DataSet, ok = false,
    sqltext  = "select count(*) from ddl_tick_dbt tick, ddl_leg_dbt leg ",
    sqlwhere = " where tick.t_bofficekind = 100 " +
                 " and tick.T_DEALID = leg.T_DEALID and leg.t_legkind = 0";
    // Контрагент
    if(g_Contractor > -1)
       sqlwhere = sqlwhere + " AND tick.T_PartyID = " + g_Contractor;
    end;
    // Вид операции
    if(g_Kind_Operation > -1)
       sqlwhere = sqlwhere + " AND tick.T_DealType = " + g_Kind_Operation;
    end;
    // Дата сделки
    if(g_minDealDate != date(0,0,0))
       sqlwhere = sqlwhere + " AND tick.T_DealDate >= " + to_date(g_minDealDate);
    end;
    if(g_maxDealDate != date(0,0,0))
       sqlwhere = sqlwhere + " AND tick.T_DealDate <= " + to_date(g_maxDealDate);
    end;
/*    if(g_FIID > -1)
       if( TypeDealLeg(dlTick, dlLeg) )
          sqlwhere = sqlwhere + " AND leg.T_CFI = case when TypeDoc = 'B' and LegID = 0 then " + FI_Req;
       else
          sqlwhere = sqlwhere + " AND leg.T_PFI = " + FI_Req;
       end;
    end;*/

    DataSet = TRsbDataSet(sqltext + sqlwhere);
    if(DataSet.MoveNext)
       FXREPMOV = TFXREPMOV(grp);
       ok = true;
    end;

    return ok;
END;


/* Печать отчета */
MACRO printReportRSF( Contractor, Kind_Operation, minDealDate, maxDealDate, minValueDate, maxValueDate, FIID, isSigned )
var grp = TReportsGroup();

   /* Установить параметры отчета по переданным значениям */
   g_Contractor = Contractor;
   g_Kind_Operation = Kind_Operation;
   g_minDealDate = minDealDate;
   g_maxDealDate = maxDealDate;
   g_minValueDate = minValueDate;
   g_maxValueDate = maxValueDate;
   g_FIID = FIID;
   g_isSigned = isSigned;

   if(PrintBody(grp) == true)
      grp.Print( TRUE );
   else
      msgbox( "Нет данных, удовлетворяющих заданной фильтрации." );
   end;

END;

/* Запрос для отбора сумм с группировкой по валютам и фильтрацией.

SELECT
 sum(PmPaym1.T_AMOUNT) AS A_DemandAmount, 
 sum(PmPaym2.T_AMOUNT) AS A_LiabilityAmount, 
-----------------------------------------------------------------------------
-- PmPaym1.T_FIID AS A_DemandFIID, 
-- PmPaym2.T_FIID AS A_LiabFIID,
-------------------------------------------------------------------
 (select FI1.t_FI_Code from dfininstr_dbt FI1 where PmPaym1.T_FIID = FI1.T_FIID) AS A_DemandFICode, 
 (select FI2.t_FI_Code from dfininstr_dbt FI2 where PmPaym2.T_FIID = FI2.T_FIID) AS A_LiabFICode 
-------------------------------------------------------------------
FROM
 DDL_LEG_DBT leg, DDL_TICK_DBT tick, DPMPAYM_DBT PmPaym1, DPMPAYM_DBT PmPaym2 
WHERE
 ( leg.T_DEALID = PmPaym1.T_DOCUMENTID AND tick.T_BOFFICEKIND = 
PmPaym1.T_DOCKIND AND ((CASE WHEN tick.T_TYPEDOC = 'B' THEN (CASE WHEN 
leg.T_LEGID = 1 THEN 4 ELSE 1 END) ELSE (CASE WHEN leg.T_LEGID = 1 
THEN 3 ELSE 2 END) END)) = PmPaym1.T_PURPOSE AND ('X') = 
PmPaym1.T_ISPLANPAYM )
AND
(leg.T_DEALID = PmPaym2.T_DOCUMENTID AND tick.T_BOFFICEKIND = 
PmPaym2.T_DOCKIND AND ((CASE WHEN tick.T_TYPEDOC = 'B' THEN (CASE WHEN 
leg.T_LEGID = 1 THEN 3 ELSE 2 END) ELSE (CASE WHEN leg.T_LEGID = 1 
THEN 4 ELSE 1 END) END)) = PmPaym2.T_PURPOSE AND ('X') = 
PmPaym2.T_ISPLANPAYM ) AND 

tick.T_PARTYID = 49 AND tick.T_DEALTYPE = 1000 AND 
tick.T_DEALDATE >= TO_DATE('17 08 2005','DD MM YYYY') AND 
tick.T_DEALDATE <= TO_DATE('17 08 2005','DD MM YYYY') AND 
----------------------------------------------------------------------
PmPaym1.T_VALUEDATE  >= TO_DATE('17 08 2005','DD MM YYYY') AND 
PmPaym2.T_VALUEDATE  >= TO_DATE('17 08 2005','DD MM YYYY') AND 
----------------------------------------------------------------------
PmPaym1.T_VALUEDATE  <= TO_DATE('17 08 2005','DD MM YYYY') AND 
PmPaym2.T_VALUEDATE  <= TO_DATE('17 08 2005','DD MM YYYY') AND 
----------------------------------------------------------------------
PmPaym1.T_FIID  = 0 AND 
PmPaym2.T_FIID  = 0 AND 
----------------------------------------------------------------------
(tick.T_BOFFICEKIND = 100 AND 
leg.T_DEALID = tick.T_DEALID AND 
leg.T_LEGKIND = 0) 
group by PmPaym1.T_FIID, PmPaym2.T_FIID
--, FI1.t_FI_Code, FI2.t_FI_Code
*/