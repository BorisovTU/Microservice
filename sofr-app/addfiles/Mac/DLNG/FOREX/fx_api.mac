/*
$Name: fx_api.mac
$Module: FOREX
$Description: API доступа к данным модуля "Конверсионные операции"
*/
IMPORT RSD;
IMPORT "ws_datafilter.mac", "dlquery.mac";
IMPORT DVInter, OprInter;

PRIVATE MACRO GetForexDealsSQLQuery_str(IsUnCompletedDealsScroll)

 var qStr = "";

    qStr = qStr + " with";
    qStr = qStr + "   DealKind as";
    qStr = qStr + "   (select t_INumberAlg as t_ID, t_SzNameAlg t_Name from dnamealg_dbt where t_ITypeAlg = 7657),";
    qStr = qStr + "   DealType as";
    qStr = qStr + "   (select t_INumberAlg as t_ID, t_SzNameAlg t_Name from dnamealg_dbt where t_ITypeAlg = 7658),";
    qStr = qStr + "   ClaimMode as";
    qStr = qStr + "   (select t_INumberAlg as t_ID, t_SzNameAlg t_Name from dnamealg_dbt where t_ITypeAlg = 7659), ";
    qStr = qStr + "   Status as";

    if(IsUnCompletedDealsScroll)
       qStr = qStr + "   (select t_INumberAlg as t_ID, t_SzNameAlg t_Name from dnamealg_dbt where t_ITypeAlg = 7664)";
    else
       qStr = qStr + "   (select t_INumberAlg as t_ID, t_SzNameAlg t_Name from dnamealg_dbt where t_ITypeAlg = 7660)";
    end;

    qStr = qStr + " select ";
    qStr = qStr + " tick.t_ID as t_DealID,";
    qStr = qStr + " tick.t_Date as t_DealDate,";
    qStr = qStr + " tick.t_Time t_DealTime,";
    qStr = qStr + " party.t_PartyID as t_ClientID,";
    qStr = qStr + " party.t_Name as t_ClientName,";
    qStr = qStr + " DealKind.t_ID as t_DealKindID,";
    qStr = qStr + " DealKind.t_Name as t_DealKind,";
    qStr = qStr + " DealType.t_ID as t_DealTypeID,";
    qStr = qStr + " DealType.t_Name as t_DealType,";
    qStr = qStr + " LEAST(leg.t_SuplDate, leg.t_PayDate) as t_ValueDate,";
    qStr = qStr + " fininstr.t_FIID as t_PFI,";
    qStr = qStr + " fininstrcontr.t_FIID as t_CFI,";
    qStr = qStr + " fininstr.t_Ccy || '/' || fininstrcontr.t_Ccy as t_CurPair,";
    qStr = qStr + " leg.t_Amount as t_Principal,";
    qStr = qStr + " decode(leg.t_IsInverse, chr(0), ";
    qStr = qStr + "        leg.t_Price, ";
    qStr = qStr + "        1 / leg.t_Price";
    qStr = qStr + " ) as t_Rate,";
    qStr = qStr + " leg.t_Cost as t_Cost, ";
    qStr = qStr + " ClaimMode.t_ID as t_ClaimModeID,";
    qStr = qStr + " ClaimMode.t_Name as t_ClaimMode,";
    qStr = qStr + " Status.t_ID as t_StatusID,";
    qStr = qStr + " Status.t_Name as t_Status";
    qStr = qStr + " from ddvndeal_dbt tick, ddvnfi_dbt leg, dparty_dbt party, dfininstr_dbt fininstr, dfininstr_dbt fininstrcontr,";
    qStr = qStr + " Status, ClaimMode, DealType, DealKind";
    qStr = qStr + " where ";
    qStr = qStr + " tick.t_Dockind = " + string(DL_DVFXDEAL) + " and tick.t_Kind in (?, ?, ?)";
    qStr = qStr + " and leg.t_DealID = tick.t_ID ";
    qStr = qStr + " and (leg.t_SuplDate = ? or leg.t_PayDate = ? )";
    qStr = qStr + " and (party.t_PartyID(+) = tick.t_Contractor)";
    qStr = qStr + " and tick.t_Contractor IN (select MD.T_PARTYID from drkclient_dbt md) ";
    qStr = qStr + " and (fininstr.t_FIID(+) = leg.t_FIID)";
    qStr = qStr + " and (fininstrcontr.t_FIID(+) = leg.t_PayFIID)";
    qStr = qStr + " and (fininstrcontr.t_FIID = ? or fininstr.t_FIID = ? )";
    qStr = qStr + " and Status.t_ID = case tick.t_State";
    qStr = qStr + "                     when 0 then 1";
    qStr = qStr + "                     when 1 then 2";
    qStr = qStr + "                     else 3";
    qStr = qStr + "                   end";
    qStr = qStr + " and ClaimMode.t_ID = case";
    qStr = qStr + "                        when tick.t_Kind = ? then 1";
    qStr = qStr + "                        when tick.t_Kind = ? then 2";
    qStr = qStr + "                        else 3  ";
    qStr = qStr + "                      end";
    qStr = qStr + " and DealType.t_ID = case RSI_RsbCalendar.getWorkDayCount(tick.t_Date, LEAST(leg.t_SuplDate, leg.t_PayDate))";
    qStr = qStr + "                       when 1 then 1";
    qStr = qStr + "                       when 2 then 2";
    qStr = qStr + "                       when 3 then 3";
    qStr = qStr + "                       when 4 then 3";
    qStr = qStr + "                       else 4";       
    qStr = qStr + "                     end";
    qStr = qStr + " and DealKind.t_ID = case tick.t_Type";
    qStr = qStr + "                       when 1 then 1";
    qStr = qStr + "                       else 2";
    qStr = qStr + "                     end";

    return qStr;
END;


PRIVATE MACRO ПолучитьСделкиФИИСиКО()
    var qStr = "";

    qStr = qStr + "	SELECT 	  ";
    qStr = qStr + "	     NDEAL.T_ID,      	  ";
    qStr = qStr + "	     NDEAL.T_DATE,	  ";
    qStr = qStr + "	     NDEAL.T_TIME,	  ";
    qStr = qStr + "	     party.t_PartyID as t_ClientID,  "; 
    qStr = qStr + "	     party.t_Name as t_ClientName,   ";
    qStr = qStr + "	     DealKind.t_ID as t_DealKindID,  ";
    qStr = qStr + "	     DealKind.t_Name as t_DealKind,  ";
    qStr = qStr + "	     DealType.t_ID as t_DealTypeID,  ";
    qStr = qStr + "	     DealType.t_Name as t_DealType,  ";
    qStr = qStr + "	     LEAST( NFI.T_EXECDATE, NFI.T_PAYDATE ) as t_ValueDate, ";
    qStr = qStr + "	     fininstr.t_FIID as t_PFI, 	    ";
    qStr = qStr + "	     fininstrcontr.t_FIID as t_CFI, ";
    qStr = qStr + "	     fininstr.t_Ccy || '/' || fininstrcontr.t_Ccy as t_CurPair, ";
    qStr = qStr + "	     NFI.T_AMOUNT as t_Principal,	  ";
    qStr = qStr + "	     decode(NFI.T_ISINVERSE , chr(0), ";
    qStr = qStr + "	            nfi.t_Cost / nfi.t_amount, ";
    qStr = qStr + "	            nfi.t_amount / nfi.t_Cost  ";
    qStr = qStr + "	             ) as t_Rate,          	   ";
    qStr = qStr + "	     NFI.t_Cost as t_Cost,	           ";
    qStr = qStr + "	     ClaimMode.t_ID as t_ClaimModeID,  ";
    qStr = qStr + "	     ClaimMode.t_Name as t_ClaimMode,  ";
    qStr = qStr + "	     Status.t_ID as t_StatusID, 	     ";
    qStr = qStr + "	     Status.t_Name as t_Status 	       ";
    qStr = qStr + "	  FROM ddvndeal_dbt ndeal, dparty_dbt party, ddvnfi_dbt nfi, dfininstr_dbt fininstr, dfininstr_dbt fininstrcontr, ";
    qStr = qStr + "	  Status, ClaimMode, DealType, DealKind ";
    qStr = qStr + "	 WHERE	  ";
    qStr = qStr + "          NDEAL.t_DocKind in(" + string(DL_DVDEALT3) + "," +string(DL_DVNDEAL)+ " )";
    qStr = qStr + "      and (NFI.T_EXECDATE = ? or NFI.T_PAYDATE  = ? ) "; /*MonitorDate, MonitorDate*/
    qStr = qStr + "	 and NFI.T_DEALID = NDEAL.T_ID	  ";
    qStr = qStr + "	 and  NFI.T_EXECTYPE = " + string(DVSETTLEMET_STATE)	 ;
    qStr = qStr + "	 AND fininstr.T_FIID(+) = NFI.T_FIID	  ";
    qStr = qStr + "	 AND fininstr.t_FI_KIND(+) = " + string(FIKIND_CURRENCY)	 ;
    qStr = qStr + "	 AND fininstrcontr.T_FIID(+) = NFI.T_PriceFIID	  ";
    qStr = qStr + "	 and (fininstrcontr.t_FIID = ? or fininstr.t_FIID = ? ) 	  ";
    qStr = qStr + "	 and (party.t_PartyID(+) = NDEAL.T_CONTRACTOR) ";
    qStr = qStr + "	 and NDEAL.T_CONTRACTOR IN (select MD2.T_PARTYID from drkclient_dbt md2) ";
    qStr = qStr + "	 AND NDEAL.T_DVKind IN (?, ?)         	  ";                /*DV_FORWARD, DV_FORWARD_T3*/
    qStr = qStr + "	 and Status.t_ID = case NDEAL.T_STATE 	  ";
    qStr = qStr + "	                         when 0 then 1 	  ";
    qStr = qStr + "	                         when 1 then 2 	  ";
    qStr = qStr + "	                         else 3 	  ";
    qStr = qStr + "	                         end	  ";
    qStr = qStr + "	 and ClaimMode.t_ID = case 	  ";
    qStr = qStr + "	                            when NDEAL.T_TYPE = ? then 1 	  ";
    qStr = qStr + "	                            when NDEAL.T_SECTOR = 'X' and NDEAL.T_TYPE = ? then 2 	  ";
    qStr = qStr + "	                            else 3   	  ";
    qStr = qStr + "	                          end	  ";
    qStr = qStr + "	                          	  ";
    qStr = qStr + "	and DealType.t_ID = case RSI_RsbCalendar.getWorkDayCount(NDEAL.T_DATE, LEAST(NFI.T_EXECDATE, NFI.T_PAYDATE)) 	  ";
    qStr = qStr + "	                           when 1 then 1 	  ";
    qStr = qStr + "	                           when 2 then 2 	  ";
    qStr = qStr + "	                           when 3 then 3 	  ";
    qStr = qStr + "	                           when 4 then 3 	  ";
    qStr = qStr + "	                           else 4 	  ";      
    qStr = qStr + "	                         end      	  ";
    qStr = qStr + "	and DealKind.t_ID = case NDEAL.t_Type	  ";
    qStr = qStr + "	                           when 1 then 1 	  ";
    qStr = qStr + "	                           else 2 	  ";
    qStr = qStr + "	                         end 	  ";

    return qStr;
END;


PRIVATE MACRO GetSQLCurPairCondition(
                                     condition : Integer,
                                     value,
                                     type : Integer
                                     ) : String
  VAR
      strSQLCond:String = "", 
      valueCount:Integer = 0;

    if (
        (ValType(value) != V_UNDEF) and
        (value.Size > 0) and
        (ValType(type) == V_INTEGER) and
        (type == FilterParameterType_UserType)
       )
        while (valueCount < value.Size)
            if (
                (ValType(value[valueCount]) != V_UNDEF) and
                (ValType(value[valueCount].PFI) == V_INTEGER) and (ValType(value[valueCount].CFI) == V_INTEGER) and
                (value[valueCount].PFI > ALLFININSTR) and (value[valueCount].CFI > ALLFININSTR)
               )
                if (strSQLCond == "")
                    strSQLCond = strSQLCond + " ( ";
                else
                    strSQLCond = strSQLCond + " OR ";
                end;

                strSQLCond = strSQLCond + " ((fininstr.t_FIID = " + value[valueCount].PFI + " and " + " fininstrcontr.t_FIID = " + value[valueCount].CFI + ") OR (fininstr.t_FIID = " + value[valueCount].CFI + " and " + " fininstrcontr.t_FIID = " + value[valueCount].PFI + ")) ";

            end;

            valueCount = valueCount + 1;
        end;

        if (strSQLCond != "")
            strSQLCond = strSQLCond + " ) ";
        end;
    end;

  return strSQLCond;
END;

PRIVATE MACRO GetSQLPartyCondition(
                                   condition : Integer,
                                   value,
                                   type : Integer
                                  ) : String
  VAR
      strSQLCond : String = GetSQLPartyConditionEx("party", "t_PartyID", condition, value, type);

    if (strSQLCond == "")
        strSQLCond = " party.t_PartyID = -1 ";
    end;

    return strSQLCond;
END;

PRIVATE MACRO GetSqlFilter(FilterConditionItems, IsPFI)
  VAR
      fp = FilterParser(FilterConditionItems),
      sql = "";

    fp.AddUserFieldCondition( 2,           @GetSQLPartyCondition );
    fp.AddFieldCondition( 3,  "DealKind",  "t_ID");
    fp.AddFieldCondition( 4,  "DealType",  "t_ID");
    fp.AddUserFieldCondition( 6,           @GetSQLCurPairCondition );
    fp.AddFieldCondition( 10, "ClaimMode", "t_ID");
    fp.AddFieldCondition( 11, "Status",    "t_ID");

    if (IsPFI)
      fp.AddFieldCondition( 0,  "NDEAL",      "t_Date");
      fp.AddFieldCondition( 1,  "NDEAL",      "t_Time");
      fp.AddFieldCondition( 5,  NULL,        "LEAST(NDEAL.T_DATE, NFI.T_EXECDATE, NFI.T_PAYDATE )");
      fp.AddFieldCondition( 7,  "NFI",       "T_AMOUNT");
      fp.AddFieldCondition( 8,  NULL,        "decode(NFI.T_ISINVERSE , chr(0), nfi.t_Cost / nfi.t_amount,  nfi.t_amount / nfi.t_Cost)");
      fp.AddFieldCondition( 9, "NFI",        "t_Cost");
    else
      fp.AddFieldCondition( 0,  "tick",      "t_Date");
      fp.AddFieldCondition( 1,  "tick",      "t_Time");
      fp.AddFieldCondition( 5,  NULL,        "LEAST(leg.t_SuplDate, leg.t_PayDate)");
      fp.AddFieldCondition( 7,  "leg",       "t_Amount");
      fp.AddFieldCondition( 8,  NULL,        "decode(leg.t_IsInverse, chr(0), leg.t_Price, 1 / leg.t_Price");
      fp.AddFieldCondition( 9, "leg",        "t_Cost");
   end;

//    fp.GetFullSQLConditionDebug( "ws_fx_api_filter_debug" );

    sql = fp.GetFullSQLCondition();
    if (sql != "")
        sql = " AND " + sql;
    end;

    return sql;
END;

PRIVATE MACRO GetSqlSort(OrderItems)
  VAR
      SortStr:string = " order by ",
      idx = 0, item = "";

    if ((OrderItems == null) or (OrderItems.Size() <= 0))
        SortStr =  SortStr + "t_DealDate desc, t_DealTime desc";
    else
        while (idx < OrderItems.size())
            if (idx != 0)
                item = ", ";
            end; 

            item = item + "t_" + OrderItems[idx].Column;
            if (OrderItems[idx].Direction == 0)
                item = item + " asc";
            else
                item = item + " desc";
            end;

            SortStr = SortStr + item;

            idx = idx + 1;
       end;
    end;

    return SortStr;
END;

PRIVATE MACRO GetForexDealsSQLQuery(pageSize,
                                    pageIndex,
                                    FilterConditionItems, 
                                    OrderItems,
                                    MonitorDate)
  var
    qStr = "", cmd = NULL, rs = NULL;

    qStr = qStr + GetForexDealsSQLQuery_str(false);
    qStr = qStr + " " + GetSqlFilter(FilterConditionItems, false);
    qStr = qStr + " UNION ALL ( ";
    qStr = qStr + ПолучитьСделкиФИИСиКО();
    qStr = qStr + " " + GetSqlFilter(FilterConditionItems, true);
    qStr = qStr + " ) ";

    if ((pageSize == 0)and(pageIndex == 0))
        ;
    else
        qStr = "select * from (" + qStr + ") where rownum between " + (pageIndex*pageSize + 1) + " and " + ((pageIndex + 1)*pageSize);
    end;

    qStr = qStr + " " + GetSqlSort(OrderItems);

    return qStr;

  OnError(er)
      return NULL;
END;

MACRO GetForexDealsRecordset(pageSize,
                             pageIndex,
                             FilterConditionItems, 
                             OrderItems,
                             MonitorDate)
  var
      qStr = "", cmd = NULL, rs = NULL;

    qStr = GetForexDealsSQLQuery(pageSize, pageIndex, FilterConditionItems, OrderItems, MonitorDate);

    if ((ValType(qStr) != V_UNDEF)and(qStr != ""))
        cmd = RSDCommand(qStr);
        cmd.NullConversion = true;
        cmd.AddParam("", RSDBP_IN, 2730);
        cmd.AddParam("", RSDBP_IN, 12000);
        cmd.AddParam("", RSDBP_IN, 13000);
        cmd.AddParam("", RSDBP_IN, MonitorDate);
        cmd.AddParam("", RSDBP_IN, MonitorDate);
        cmd.AddParam("", RSDBP_IN, NatCur);
        cmd.AddParam("", RSDBP_IN, NatCur);
        cmd.AddParam("", RSDBP_IN, 12000);
        cmd.AddParam("", RSDBP_IN, 13000);
        /*ФИИСиКО*/
        cmd.AddParam("", RSDBP_IN, MonitorDate);
        cmd.AddParam("", RSDBP_IN, MonitorDate);
        cmd.AddParam("", RSDBP_IN, NatCur);
        cmd.AddParam("", RSDBP_IN, NatCur);
        cmd.AddParam("", RSDBP_IN, DV_FORWARD);
        cmd.AddParam("", RSDBP_IN, DV_FORWARD_T3);
        cmd.AddParam("", RSDBP_IN, 12000);
        cmd.AddParam("", RSDBP_IN, 13000);

        rs = RsdRecordset(cmd);
    end;

    return rs;

  OnError(er)
      return NULL;
END;

MACRO GetForexDealsCount(FilterConditionItems, MonitorDate)
  var
      qStr = "", cmd = NULL, rs = NULL;

    qStr = GetForexDealsSQLQuery(0, 0, FilterConditionItems, NULL, MonitorDate);

    if ((ValType(qStr) != V_UNDEF)and(qStr != ""))
        qStr = "select count(1) as t_cnt from (" + qStr + ")";

        cmd = RSDCommand(qStr);
        cmd.NullConversion = true;
        cmd.AddParam("", RSDBP_IN, 2730);
        cmd.AddParam("", RSDBP_IN, 12000);
        cmd.AddParam("", RSDBP_IN, 13000);
        cmd.AddParam("", RSDBP_IN, MonitorDate);
        cmd.AddParam("", RSDBP_IN, MonitorDate);
        cmd.AddParam("", RSDBP_IN, NatCur);
        cmd.AddParam("", RSDBP_IN, NatCur);
        cmd.AddParam("", RSDBP_IN, 12000);
        cmd.AddParam("", RSDBP_IN, 13000);
        /*ФИИСиКО*/
        cmd.AddParam("", RSDBP_IN, MonitorDate);
        cmd.AddParam("", RSDBP_IN, MonitorDate);
        cmd.AddParam("", RSDBP_IN, NatCur);
        cmd.AddParam("", RSDBP_IN, NatCur);
        cmd.AddParam("", RSDBP_IN, DV_FORWARD);
        cmd.AddParam("", RSDBP_IN, DV_FORWARD_T3);
        cmd.AddParam("", RSDBP_IN, 12000);
        cmd.AddParam("", RSDBP_IN, 13000);


        rs = RsdRecordset(cmd);
        rs.MoveNext();
        return rs.Value(0, NULL, V_INTEGER);
    end;

    return 0;

  OnError(er)
      return 0;
END;

/*Функция - источник данных для скроллинга незавершенных сделок.*/
PRIVATE MACRO GetForexDealsSQLQuery2(pageSize,
                                    pageIndex,
                                    OrderItems,
                                    MonitorDate)
  var
      qStr = "", cmd = NULL, rs = NULL;

    /*Можно определить свой select для получения незавершенных сделок*/
    qStr = qStr + GetForexDealsSQLQuery_str(true);
    qStr = qStr + " UNION ALL ( ";
    qStr = qStr + ПолучитьСделкиФИИСиКО();
    qStr = qStr + " ) ";

    if ((pageSize == 0)and(pageIndex == 0))
        ;
    else
        qStr = "select * from (" + qStr + ") where rownum between " + (pageIndex*pageSize + 1) + " and " + ((pageIndex + 1)*pageSize);
    end;

    qStr = qStr + " " + GetSqlSort(OrderItems);

    return qStr;

  OnError(er)
      return NULL;
END;

MACRO GetForexDealsRecordset2(pageSize,
                             pageIndex,
                             OrderItems,
                             MonitorDate)
  var
      qStr = "", cmd = NULL, rs = NULL;

    qStr = GetForexDealsSQLQuery2(pageSize, pageIndex, OrderItems, MonitorDate);

    if ((ValType(qStr) != V_UNDEF)and(qStr != ""))
        cmd = RSDCommand(qStr);
        cmd.NullConversion = true;
        cmd.AddParam("", RSDBP_IN, 2730);
        cmd.AddParam("", RSDBP_IN, 12000);
        cmd.AddParam("", RSDBP_IN, 13000);
        cmd.AddParam("", RSDBP_IN, MonitorDate);
        cmd.AddParam("", RSDBP_IN, MonitorDate);
        cmd.AddParam("", RSDBP_IN, NatCur);
        cmd.AddParam("", RSDBP_IN, NatCur);
        cmd.AddParam("", RSDBP_IN, 12000);
        cmd.AddParam("", RSDBP_IN, 13000);
        /*ФИИСиКО*/
        cmd.AddParam("", RSDBP_IN, MonitorDate);
        cmd.AddParam("", RSDBP_IN, MonitorDate);
        cmd.AddParam("", RSDBP_IN, NatCur);
        cmd.AddParam("", RSDBP_IN, NatCur);
        cmd.AddParam("", RSDBP_IN, DV_FORWARD);
        cmd.AddParam("", RSDBP_IN, DV_FORWARD_T3);
        cmd.AddParam("", RSDBP_IN, 12000);
        cmd.AddParam("", RSDBP_IN, 13000);

        rs = RsdRecordset(cmd);
    end;

    return rs;

  OnError(er)
      return NULL;
END;

MACRO GetForexDealsCount2(MonitorDate)
  var
      qStr = "", cmd = NULL, rs = NULL;

    qStr = GetForexDealsSQLQuery2(0, 0, NULL, MonitorDate);

    if ((ValType(qStr) != V_UNDEF)and(qStr != ""))
        qStr = "select count(1) as t_cnt from (" + qStr + ")";

        cmd = RSDCommand(qStr);
        cmd.NullConversion = true;
        cmd.AddParam("", RSDBP_IN, 2730);
        cmd.AddParam("", RSDBP_IN, 12000);
        cmd.AddParam("", RSDBP_IN, 13000);
        cmd.AddParam("", RSDBP_IN, MonitorDate);
        cmd.AddParam("", RSDBP_IN, MonitorDate);
        cmd.AddParam("", RSDBP_IN, NatCur);
        cmd.AddParam("", RSDBP_IN, NatCur);
        cmd.AddParam("", RSDBP_IN, 12000);
        cmd.AddParam("", RSDBP_IN, 13000);
        /*ФИИСиКО*/
        cmd.AddParam("", RSDBP_IN, MonitorDate);
        cmd.AddParam("", RSDBP_IN, MonitorDate);
        cmd.AddParam("", RSDBP_IN, NatCur);
        cmd.AddParam("", RSDBP_IN, NatCur);
        cmd.AddParam("", RSDBP_IN, DV_FORWARD);
        cmd.AddParam("", RSDBP_IN, DV_FORWARD_T3);
        cmd.AddParam("", RSDBP_IN, 12000);
        cmd.AddParam("", RSDBP_IN, 13000);

        rs = RsdRecordset(cmd);
        rs.MoveNext();
        return rs.Value(0, NULL, V_INTEGER);
    end;

    return 0;

  OnError(er)
      return 0;
END;

/*!!! Макрос получения количества незавершенных сделок.
      Используется для работы планировщика модуля монитора дилера.
      Вызвает функцию подсчета записей скроллинга незавершенных сделок.
      Возвращает количество сделок. */
MACRO GetUncomplitedDealsCount(MonitorDate)   
   return GetForexDealsCount2(MonitorDate);
END;
