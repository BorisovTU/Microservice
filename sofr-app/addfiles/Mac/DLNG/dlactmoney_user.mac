/*
$Name: dlactmoney_user.mac
$Module: ФИСС и КО
$Description: Акты сверки наличия денежных средств
*/
/*
dlactmoney_user.mac
PNV 13/04/2022 DEF-23162 Пришлось переписать макрос, т.к. отразить 400 тыс.записей отчет не мог, ошибка "недостаточно памяти для работы программы"
Непонятно, зачем сотрудники ОВ все еще используют CMakeReport
*/
IMPORT or_rep_h, oralib, RSD, Календарь;
IMPORT "DLReport_h.mac", deposerv;

//константы - подсистемы по счетам которых выпускать отчет
PRIVATE CONST REPKIND_SEC = 1, //Ценные Бумаги
              REPKIND_DV  = 2, //Производные инструменты
              REPKIND_VA  = 3; //Учтенные векселя

CLASS (DL_CReportTemplate) DLACTMONEY_CL(obj:variant, RepBO)
  var repRestDate;
  var NeedBreak = false;
  var cmd, AccValue, BegDate, EndDate, ContrID, ClientID, ServKind, OurBank, NRecSelect, NRecData;

  var Rep, sql;
  private var iCount = 0, Num = 0;
  var Progress = CProgressBar;

  var sumFlag = 0;
  
  if(valtype(obj) != null)
     repRestDate = obj.EndDate;
     AccValue    = obj.AccValue;
     BegDate     = obj.BegDate;
     EndDate     = obj.EndDate;
     ContrID     = obj.ClientContr;
     ClientID    = obj.ClientCode;
     // KS 17.01.2020 Исковый вид обслуживания должен зависеть от галок
     //ServKind = 1;
     ServKind = "-1";
     if (RepBO != -1)
          if (RepBO == REPKIND_SEC)
              ServKind = ServKind + "," + PTSK_STOCKDL;
          elif (RepBO == REPKIND_DV)    
              if(Obj.IsUseDVDer)
                 ServKind = ServKind + "," + PTSK_DV;
              end;
              if(Obj.IsUseDVCur)
                 ServKind = ServKind + "," + PTSK_CM;
              end;
          elif (RepBO == REPKIND_VA)
              ServKind = ServKind + "," + PTSK_VEKSACC;
          end;    
     else
          if(Obj.IsUseBO)
             ServKind = ServKind + "," + PTSK_STOCKDL;
          end;
          if(Obj.IsUseVA)
             ServKind = ServKind + "," + PTSK_VEKSACC;
          end;
          if(Obj.IsUseDVDer)
             ServKind = ServKind + "," + PTSK_DV;
          end;
          if(Obj.IsUseDVCur)
             ServKind = ServKind + "," + PTSK_CM;
          end;
     end;   
     OurBank = {OurBAnk};
  else
     AccValue = -1;
     BegDate = date(01,03,2019);
     EndDate = date(18,03,2019);
     ContrID = -1;
     ClientID = -1;
     ServKind = "1";
     OurBank = 1;
  end;

  PRIVATE MACRO BeginReport()
    CreateTotalBook();     
    SetActiveSheet( "02" );
  END; 

  PRIVATE MACRO EndReport()
    if(not NeedBreak)
       SaveTotalBook();
    else
       m_ObjTemplateXLS.SheetDelete(1);
    end;
  END;
  
  PRIVATE MACRO PrintMode():INTEGER
    return DL_OUTREPORT_EXCEL;
  END; 

  MACRO CReport_DataExist()
    return not NeedBreak;
  END; 
  
  PRIVATE MACRO ПечатьШапки ()
    PrintFormatString( "", "Date1", Date); 
    PrintFormatString( "", "Date2", repRestDate); 
    //CopyAllSheetInTotalBook( NULL, false, "N1_Head1", 0 );
    
    RegisterTable( "TableLine", "",
                   "N_1",          
                   "N_2",               
                   "N_3",
                   "N_4",
                   "N_5",
                   "N_6",
                   "N_7",
                   "N_8",
                   "N_9"                 
                   );
  END;

  PRIVATE MACRO ПечатьБлокаДанных(_rs);
    var delta;
    
    while(_rs.movenext())
          delta = abs(_rs.InAccRest-_rs.BalAccRest);
          PrintTableLine(  "N_1",  _rs.name, null,
                           "N_2",  _rs.number, null, 
                           "N_3",  date(_rs.datebegin), null,
                           "N_4",  iif(valtype(_rs.account) == v_string, _rs.account, "-----"), null,
                           "N_5",  _rs.balacc, null,
                           "N_6",  _rs.InAccRest, null,
                           "N_7",  _rs.BalAccRest, null,
                           "N_8",  delta, null,
                           "N_9",  "", null
                           
                         );   
          UseProgress( Num = Num + 1 );
    end;
    RemProgress();
    EndTable();
    //CopyAllSheetInTotalBook( NULL, false, GetTableRange(), 0 );
    CopyAllSheetInTotalBook( NULL, true, NULL );
  END;

  MACRO CreateRep()
    ПечатьШапки();
    sql = null;

    begaction(100,"Сбор данных...");
    SQL = "with mSql as (SELECT  distinct sf.t_PartyID Owner, p.t_name, " +
          "                               sf.t_ID ContrID, dsf.t_number, dsf.t_datebegin, " +
          "                               acc.t_account,  " +
          "                               acc.t_Code_Currency t_Currency  " +
          "  FROM dsfcontr_dbt sf join ddlcontrmp_dbt mp on mp.t_sfcontrid = sf.t_id " +
          "    join ddlcontr_dbt dl on dl.t_dlcontrid = mp.t_dlcontrid " +
          "    join dsfcontr_dbt dsf on dl.t_sfcontrid = dsf.t_id " +
		  "    join dparty_dbt p on sf.t_PartyID = p.t_partyid  " +
          "    left join dmcaccdoc_dbt mc " +
		  "      on sf.t_partyid = mc.t_Owner and sf.t_ID = mc.t_ClientContrID " +
 		  "         and mc.t_Chapter = 21  " +
          "         AND mc.t_CatId = 349 " ; 
 if (AccValue != -1)    
     SQL = SQL +  "           AND mc.t_Currency = ? ";
 end;
 SQL = SQL +    
          "           AND mc.t_DocKind IN (101, 107, 122, 176, 159, 127, 117, 138, 155,4607, 4813, 199, 3001)  " +
          "           AND mc.t_DepartmentID = 1  " +
		  "    left join daccount_dbt acc  " +
         "          ON acc.t_Chapter = 21  " +
          "            AND acc.t_Account = mc.t_Account  " +
          "            AND acc.t_Code_Currency = mc.t_Currency  " +
          "            AND (acc.t_Close_Date = TO_DATE('01.01.0001', 'DD.MM.YYYY')  " +
          "                         OR acc.t_Close_Date >= ?)  " + //begdate
          "            AND acc.t_Open_Date <= ?  " + //enddate
 " WHERE sf.t_Department = 1  ";
 if (ContrID != -1) 
     SQL = SQL + "AND sf.t_ID = ?  ";
 end;
 if (ClientID != -1)     
      SQL = SQL + "   AND sf.t_PartyID = ? ";
 end;     
 SQL = SQL + "  AND sf.t_ServKind in (" + ServKind + ") " +
          "   AND sf.t_ContractorID = ? " +
          "   AND (sf.t_DateClose = TO_DATE('01.01.0001', 'DD.MM.YYYY') " +
          "         OR sf.t_DateClose >= ?) " +
          "   AND sf.t_DateBegin <= ?) " +
          "SELECT  mSql.*, " +
          "       mSql.t_account InAcc, " +
          "       RSI_RSB_ACCOUNT.RestAC (mSql.t_account, " +
          "                               mSql.t_currency, " +
          "                               ?, " +
          "                               21, " +
          "                               mSql.t_currency) " +
          "          InAccRest, " +
          "       s.t_account balAcc, " +
          "       RSI_RSB_ACCOUNT.RestAC (s.t_account, " +
          "                               s.t_fiid, " +
          "                               ?, " +
          "                               s.t_chapter, " +
          "                               s.t_fiid) " +
          "          BalAccRest " +
          "  FROM mSql, dsfssi_dbt ss, dsettacc_dbt s " +
          " WHERE ss.t_objecttype = 659 AND ss.t_objectid = mSql.ContrID " ;
  if (AccValue != -1)      
      SQL = SQL + " AND ss.t_fiid =   ? ";
  end;
     SQL = SQL +  "       AND s.t_fiid = " +
          "              (CASE " +
          "                  WHEN mSql.t_currency IS NOT NULL THEN mSql.t_currency " +
          "                  ELSE s.t_fiid " +
          "               END) " +
          "              AND ss.t_fiid =  " +
          "          (CASE  " +
          "              WHEN mSql.t_currency IS NOT NULL THEN mSql.t_currency  " +
          "              ELSE ss.t_fiid " + 
          "           END) " +   
          " AND s.t_settaccid = ss.t_setaccid  "+
          " and ss.t_fiid = s.t_fiid "+
          " and S.T_BANKID = 1 "+
          " and S.T_PARTYID =  mSql.owner " +
          "order by mSql.owner, mSql.Contrid "; 

    cmd = DL_RSDCommand(sql);
 if (AccValue != -1)
    cmd.AddParam(AccValue);
 end; 
    cmd.AddParam(BegDate);
    cmd.AddParam(EndDate);
 if (ContrID != -1)
    cmd.AddParam(ContrID);
 end;
 if (ClientID != -1)  
    cmd.AddParam(ClientID);
end;
    cmd.AddParam(OurBank);
    cmd.AddParam(BegDate);
    cmd.AddParam(EndDate);
    cmd.AddParam(EndDate);
    cmd.AddParam(EndDate);
    
 if (AccValue != -1) 
    cmd.AddParam(AccValue);
 end;

    begaction(100,"Сбор данных...");
    iCount = cmd.GetCount();
    if( iCount > 0 )
        InitProgress( iCount, "", "Просмотр данных по счетам клиента ");
    end;    
     
    var rs = cmd.execute();
    ПечатьБлокаДанных(rs);  
  END;  
 
  //initDL_CReportTemplate( null, "dlactmoney_user.xls");
  initDL_CReportTemplate( null, "dlactmoney_user.xls", null, null, null, true, true);
  
  PRIVATE MACRO Create()
    return CreateRep();
    RemProgress();
  END;
  
END; 