/*
$Name:        dl_report724_form.mac
$Module:      Ценные бумаги
$Description: Форма отчета "Сведения об осуществлении брокерской,
              депозитарной деятельности и деятельности по управлению ценными бумагами" (ф. 724)
*/

import "DlRepForm_h.mac", "globals.mac";

/*Номера полей в форме отчета*/
CONST PNFLD_FORM724_PERIOD         = 0,
      PNFLD_FORM724_YEAR           = 1,
      PNFLD_FORM724_ISSECUR        = 2,
      PNFLD_FORM724_ISDV           = 3,
      PNFLD_FORM724_CHAPTER        = 4,
      PNFLD_FORM724_EXCEL          = 5,
      PNFLD_FORM724_DETAIL         = 6,
      PNFLD_FORM724_DELTA          = 7;

PRIVATE CONST
  H_PERIOD               = 100,
  H_CHECKBOX_REP_1_11    = 101,
  H_CHECKBOX_REP_12      = 102,
  H_CHAPTER              = 103,  
  H_CHECKBOX_EXCEL       = 104,  
  H_CHECKBOX_DELTA       = 105,
  H_CHECKBOX_DETAIL      = 106;  

MACRO DL_FldProc_Period_724( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  VAR BeginDate, EndDate, Month, Year, BegD, EndD;

  if( Cmd == DLG_INIT ) /*Установка значения в поле*/
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        DateSplit( {curdate}, null, Month, null );
        FldRealValue = ((Month - 1)/3 + 1) + 12; /*текущий квартал (+ 12 - для NameAlg.dbt)*/
     end;     
       FldShowValue = DL_GetNameAlg( 2263, FldRealValue );

  elif( Cmd == DLG_CHANGEVALUE ) /*значение поля было изменено*/
     /*724*/

     if( pThis.ExistField(DL_PNFLD_BEGINDATE) )
        /*первый день периода*/
        if( pThis.ExistField(DL_PNFLD_YEAR) )
           Year = pThis.GetLinkedValue(DL_PNFLD_YEAR);
        else
           DateSplit( pThis.GetLinkedValue(DL_PNFLD_BEGINDATE), null, null, Year );
        end;

        Period_GetInterval( FldRealValue, Year, @BegD, @EndD );
        BeginDate = NULL;
        Period_GetInterval( FldRealValue, Year, @BeginDate, null );
        pThis.SetLinkedValue( DL_PNFLD_BEGINDATE, BeginDate );
     end;
     if( pThis.ExistField(DL_PNFLD_ENDDATE) )
        if( pThis.ExistField(DL_PNFLD_YEAR) )
           Year = pThis.GetLinkedValue(DL_PNFLD_YEAR);
        end;

        Period_GetInterval( FldRealValue, Year, @BegD, @EndD );
        EndDate = pThis.GetLinkedValue(DL_PNFLD_ENDDATE);
        /*последний день периода*/
        DateSplit( EndDate, null, null, Year );
        EndDate = NULL;
        Period_GetInterval( FldRealValue, Year, null, @EndDate );
        pThis.SetLinkedValue( DL_PNFLD_ENDDATE, EndDate );
     end;

  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
     DL_ListNA( 2263, @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY() );
  end;
  return CM_DEFAULT;
END;

MACRO DL_FldProc_Chapter( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  VAR BeginDate, EndDate, Month, Year, BegD, EndD;

  if( Cmd == DLG_INIT ) /*Установка значения в поле*/
    if( FldRealValue == null ) /*инициализация по умолчанию*/
       FldRealValue = 0;
    end; 
    FldShowValue = DL_GetNameAlg( 2274, FldRealValue );

  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
     DL_ListNA( 2274, @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY() );
  end;
  return CM_DEFAULT;
END;


PRIVATE MACRO DL_FldProc_CheckBox_Rep_1_11( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) 
        FldRealValue = "";
     end;                                                                                       
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
  elif( (Cmd == DLG_KEY) and (Key == KEY_SPACE) )
     if( FldRealValue == "X" )
        return CM_IGNORE;
     else
        FldShowValue = FldRealValue = "X";
        pThis.SetLinkedValue( H_CHECKBOX_REP_12, "" );
     end;
  end;
  return CM_DEFAULT;
END;


PRIVATE MACRO DL_FldProc_CheckBox_Rep_12( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) 
        FldRealValue = "";
     end;                                                                                       
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
  elif( (Cmd == DLG_KEY) and (Key == KEY_SPACE) )
     if( FldRealValue == "X" )
        return CM_IGNORE;
     else
        FldShowValue = FldRealValue = "X";
        pThis.SetLinkedValue( H_CHECKBOX_REP_1_11, "" );
//        DisableFields( pThis.Data(), PNFLD_701_FILIAL_CODE );
     end;
  end;
  return CM_DEFAULT;
END;


PRIVATE MACRO DL_FldProc_CheckBox_Excel( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) 
        FldRealValue = "";
     end;                                                                                       
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
  elif( (Cmd == DLG_KEY) and (Key == KEY_SPACE) )
     if( FldRealValue == "X" )
        return CM_IGNORE;
     else
        FldShowValue = FldRealValue = "X";
        //EnableFields( pThis.Data(), PNFLD_FORM724_DETAIL );
     end;
  end;
  return CM_DEFAULT;
END;


PRIVATE MACRO DL_FldProc_CheckBox_Delta( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) 
        FldRealValue = "";
     end;                                                                                       
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
  elif( (Cmd == DLG_KEY) and (Key == KEY_SPACE) )
     if( FldRealValue == "X" )
        FldShowValue = FldRealValue = "";
     else
        FldShowValue = FldRealValue = "X";
     end;
  end;
  return CM_DEFAULT;
END;



CLASS (DL_CPanel) DLReport724_Form()

  PRIVATE MACRO Init()
     VAR CurMonth, CurYear, CurQuartal, Year;
     DateSplit( {curdate}, null, @CurMonth, CurYear );

     if( CurMonth == 1 )
        Year        = CurYear - 1;
        CurQuartal = 16;
     else
        CurQuartal = (CurMonth - 1)/3 + 13; /*текущий квартал*/
     end;

     AddFieldProc( 0, PNFLD_FORM724_PERIOD,     H_PERIOD,             @DL_FldProc_Period_724,        CurQuartal, 39, 12 );
     AddFieldProc( 0, PNFLD_FORM724_YEAR,       DL_PNFLD_YEAR,        @DL_FldProc_Year,              Year );

     AddFieldProc( 0, PNFLD_FORM724_ISSECUR,    DL_PNFLD_CHECKBOX,    @DL_FldProc_CheckBox,          SET_CHAR );
     AddFieldProc( 0, PNFLD_FORM724_ISDV,       DL_PNFLD_CHECKBOX,    @DL_FldProc_CheckBox,          SET_CHAR );

     AddFieldProc( 0, PNFLD_FORM724_CHAPTER,    H_CHAPTER    ,        @DL_FldProc_Chapter,           0 );

     AddFieldProc( 0, PNFLD_FORM724_EXCEL,      H_CHECKBOX_EXCEL,     @DL_FldProc_CheckBox_Excel,    SET_CHAR );
     AddFieldProc( 0, PNFLD_FORM724_DELTA,      H_CHECKBOX_DELTA,     @DL_FldProc_CheckBox_Delta,    UNSET_CHAR );
     AddFieldProc( 0, PNFLD_FORM724_DETAIL,     DL_PNFLD_CHECKBOX,    @DL_FldProc_CheckBox,          UNSET_CHAR );

  END;

  PRIVATE MACRO Check():BOOL
     if( (this.GetFieldValue( PNFLD_FORM724_ISSECUR ) == UNSET_CHAR) and
         (this.GetFieldValue( PNFLD_FORM724_ISDV ) == UNSET_CHAR)
       )
        msgbox("Необходимо выбрать хотя бы один из модулей для формирования отчёта");
        return false;
     end;

     if( (this.GetFieldValue( PNFLD_FORM724_EXCEL ) == UNSET_CHAR) and
         (this.GetFieldValue( PNFLD_FORM724_DELTA ) == UNSET_CHAR)
       )
        msgbox("Необходимо выбрать хотя бы один из методов вывода отчёта");
        return false;
     end;

     return true;
  END;

  initDL_CPanel( "nregisteria.lbr", "DLREP724" ); 
END;
