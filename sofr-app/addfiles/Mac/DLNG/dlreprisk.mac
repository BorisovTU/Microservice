/*
$Name:        dlreprisk.mac
$Module:      Производные инструменты
$Description: отчет "Сведения о риске процентной ставки (ф.127)"
*/

import "dvreprisk_form.mac", "dv_fun.mac", "dv_categ.mac", "dv_car.mac", "spRepFun.mac", "vsbnrfd.mac", "dlvaprds.mac", "vaprdslib.mac";

PRIVATE CONST POI_MODE = TRUE;

private const RoundN = 2;   /*точность округления*/

PRIVATE CONST ФОРВАРД = 1,
              ОПЦИОН  = 2,
              ФЬЮЧЕРС = 3,
              СВОП    = 4;

PRIVATE CONST ТРЕБОВАНИЯ    = 1,
              ОБЯЗАТЕЛЬСТВА = 2;

PRIVATE CONST P3  = 0,
              P4  = 1,
              P5  = 2,
              P6  = 3,
              P7  = 4,
              P8  = 5,
              P9  = 6,
              P10 = 7,
              P11 = 8,
              P12 = 9,
              P13 = 10,
              P14 = 11,
              P15 = 12,
              P16 = 13;

PRIVATE CONST PROTOCOL_SHEET_NAME = "Протокол",
              INFO_SHEET_NAME     = "Сведения о риске";

PRIVATE CONST _1_3_             = 0,
              _1_3_1_           = 1,
              _1_3_2_           = 2,
              _1_3_2_1_         = 3,
              _1_3_3_           = 4,
              _1_4_             = 5,
              _1_5_             = 6,
              _1_6_             = 7,
              _2_1_ФЬЮЧЕРСЫ     = 8,
              _2_2_ФОРВАРДЫ     = 9,
              _2_3_ВП_СВОПЫ     = 10,
              _2_4_П_СВОПЫ      = 11,
              _2_5_ОПЦИОНЫ_PUT  = 12,
              _2_6_ОПЦИОНЫ_CALL = 13,
              _4_3_             = 14,
              _4_4_             = 15,
              _5_1_ФЬЮЧЕРСЫ     = 16,
              _5_2_ФОРВАРДЫ     = 17,
              _5_3_ВП_СВОПЫ     = 18,
              _5_4_П_СВОПЫ      = 19,
              _5_5_ОПЦИОНЫ_PUT  = 20,
              _5_6_ОПЦИОНЫ_CALL = 21,
              _4_1_2_           = 22,
              _4_2_             = 23;

PRIVATE VAR Dep_Num = TArray();
Dep_Num[_1_3_]             = "1.3";
Dep_Num[_1_3_1_]           = "1.3.1";
Dep_Num[_1_3_2_]           = "1.3.2";
Dep_Num[_1_3_2_1_]         = "1.3.2.1";
Dep_Num[_1_3_3_]           = "1.3.3";
Dep_Num[_1_4_]             = "1.4";
Dep_Num[_1_5_]             = "1.5";
Dep_Num[_1_6_]             = "1.6";
Dep_Num[_2_1_ФЬЮЧЕРСЫ]     = "2.1";
Dep_Num[_2_2_ФОРВАРДЫ]     = "2.2";
Dep_Num[_2_3_ВП_СВОПЫ]     = "2.3";
Dep_Num[_2_4_П_СВОПЫ]      = "2.4";
Dep_Num[_2_5_ОПЦИОНЫ_PUT]  = "2.5";
Dep_Num[_2_6_ОПЦИОНЫ_CALL] = "2.6";
Dep_Num[_4_1_2_]           = "4.1.2";
Dep_Num[_4_2_]             = "4.2";
Dep_Num[_4_3_]             = "4.3";
Dep_Num[_4_4_]             = "4.4";
Dep_Num[_5_1_ФЬЮЧЕРСЫ]     = "5.1";
Dep_Num[_5_2_ФОРВАРДЫ]     = "5.2";
Dep_Num[_5_3_ВП_СВОПЫ]     = "5.3";
Dep_Num[_5_4_П_СВОПЫ]      = "5.4";
Dep_Num[_5_5_ОПЦИОНЫ_PUT]  = "5.5";
Dep_Num[_5_6_ОПЦИОНЫ_CALL] = "5.6";

PRIVATE VAR Dep_Name = TArray();
Dep_Name[_1_3_]             = "Ссудная задолженность, всего, из нее:";
Dep_Name[_1_3_1_]           = "кредитных организаций";
Dep_Name[_1_3_2_]           = "юридических лиц, не являющихся кредитными организациями, всего, из них:";
Dep_Name[_1_3_2_1_]         = "ссуды в виде \"до востребования\" и \"овердрафт\"";
Dep_Name[_1_3_3_]           = "физических лиц, всего";
Dep_Name[_1_4_]             = "Вложения в долговые обязательства";
Dep_Name[_1_5_]             = "Вложения в долевые ценные бумаги";
Dep_Name[_1_6_]             = "Прочие активы";
Dep_Name[_2_1_ФЬЮЧЕРСЫ]     = "Фьючерсы";
Dep_Name[_2_2_ФОРВАРДЫ]     = "Форварды";
Dep_Name[_2_3_ВП_СВОПЫ]     = "Валютно-процентные свопы";
Dep_Name[_2_4_П_СВОПЫ]      = "Процентные свопы";
Dep_Name[_2_5_ОПЦИОНЫ_PUT]  = "Опционы \"Put\"";
Dep_Name[_2_6_ОПЦИОНЫ_CALL] = "Опционы \"Call\"";
Dep_Name[_4_1_2_]           = "Межбанковские ссуды, депозиты";
Dep_Name[_4_2_]             = "Средства клиентов, не являющихся кредитными организациями, всего, из них:";
Dep_Name[_4_3_]             = "Выпущенные долговые обязательства";
Dep_Name[_4_4_]             = "Прочие активы";
Dep_Name[_5_1_ФЬЮЧЕРСЫ]     = "Фьючерсы";
Dep_Name[_5_2_ФОРВАРДЫ]     = "Форварды";
Dep_Name[_5_3_ВП_СВОПЫ]     = "Валютно-процентные свопы";
Dep_Name[_5_4_П_СВОПЫ]      = "Процентные свопы";
Dep_Name[_5_5_ОПЦИОНЫ_PUT]  = "Опционы \"Put\"";
Dep_Name[_5_6_ОПЦИОНЫ_CALL] = "Опционы \"Call\"";

/*кол-во строк раздела для формулы суммирования*/
PRIVATE VAR Rows_Num = TArray();

PRIVATE MACRO InitRows_Num()
   Rows_Num[_1_3_]             = 0;
   Rows_Num[_1_3_1_]           = 0;
   Rows_Num[_1_3_2_]           = 0;
   Rows_Num[_1_3_2_1_]         = 0;
   Rows_Num[_1_3_3_]           = 0;
   Rows_Num[_1_4_]             = 0;
   Rows_Num[_1_5_]             = 0;
   Rows_Num[_2_1_ФЬЮЧЕРСЫ]     = 0;
   Rows_Num[_2_2_ФОРВАРДЫ]     = 0;
   Rows_Num[_2_3_ВП_СВОПЫ]     = 0;
   Rows_Num[_2_4_П_СВОПЫ]      = 0;
   Rows_Num[_2_5_ОПЦИОНЫ_PUT]  = 0;
   Rows_Num[_2_6_ОПЦИОНЫ_CALL] = 0;
   Rows_Num[_4_1_2_]           = 0;
   Rows_Num[_4_2_]             = 0;
   Rows_Num[_4_3_]             = 0;
   Rows_Num[_5_1_ФЬЮЧЕРСЫ]     = 0;
   Rows_Num[_5_2_ФОРВАРДЫ]     = 0;
   Rows_Num[_5_3_ВП_СВОПЫ]     = 0;
   Rows_Num[_5_4_П_СВОПЫ]      = 0;
   Rows_Num[_5_5_ОПЦИОНЫ_PUT]  = 0;
   Rows_Num[_5_6_ОПЦИОНЫ_CALL] = 0;
END;

/*напечатан ли заголовок раздела для протокола*/
PRIVATE VAR IsPrintItogStr = TArray();

PRIVATE MACRO InitIsPrintItogStr()
   IsPrintItogStr[_5_6_ОПЦИОНЫ_CALL] = false;
   var i = 0;
   while( i < IsPrintItogStr.size() )
      IsPrintItogStr[i] = false;
      i = i + 1;
   end;
END;

private macro ОстатокНаСчёте( Account, Code_Currency, Chapter, OnDate:Date )

  var Rest = $0.0;
  var AccBuf = TRecHandler("account");

  ClearRecord( AccBuf );

  if( DV_GetAccount( Chapter, Code_Currency, Account, AccBuf ) )
     Rest = DL_GetRestAccount( AccBuf.rec, OnDate );
  end;

  if( AccBuf.rec.Kind_Account == "А" )
     Rest = -Rest;
  end;

  return Rest;

end;

private macro ПеревестиВТысячи(Sum)
   return round(double(Sum)/1000,0);
end;

PRIVATE CLASS CProtocol( Report:OBJECT )
  VAR m_Report = Report;
  var ПечататьПротокол = m_Report.ПечататьПротокол;

  MACRO BeginReport()

     if( ПечататьПротокол )
        m_Report.SetActiveSheet( PROTOCOL_SHEET_NAME );

        m_Report.RegisterTable( "N2_MainTable", "",
                                "N2_Dep_Num",
                                "N2_Deal_Code",
                                "N2_Party_Name",
                                "N2_A3i",
                                "N2_A4i",
                                "N2_A5i",
                                "N2_A6i",
                                "N2_A7i",
                                "N2_A8i",
                                "N2_A9i",
                                "N2_A10i",
                                "N2_A11i",
                                "N2_A12i",
                                "N2_A13i",
                                "N2_A14i",
                                "N2_A15i",
                                "N2_A16i"
                           );
     end;
  END;

  MACRO EndReport()
     if( ПечататьПротокол )
        m_Report.EndTable();
     end;
  END;

  MACRO Print( Deal_Code:string, PartyID:integer, A_Sum:TArray )

     if( ПечататьПротокол )
        m_Report.PrintTableLine(
                    /* 0  */    "N2_Dep_Num",    null, null,
                    /* 1  */    "N2_Deal_Code",  Deal_Code, null,
                    /* 2  */    "N2_Party_Name", DL_getPartyShortName(PartyID), null,
                    /* 3  */    "N2_A3i",        A_Sum[P3], null,
                    /* 4  */    "N2_A4i",        A_Sum[P4], null,
                    /* 5  */    "N2_A5i",        A_Sum[P5], null,
                    /* 6  */    "N2_A6i",        A_Sum[P6], null,
                    /* 7  */    "N2_A7i",        A_Sum[P7], null,
                    /* 8  */    "N2_A8i",        A_Sum[P8], null,
                    /* 9  */    "N2_A9i",        A_Sum[P9], null,
                    /* 10 */    "N2_A10i",       A_Sum[P10],null,
                    /* 11 */    "N2_A11i",       A_Sum[P11],null,
                    /* 12 */    "N2_A12i",       A_Sum[P12],null,
                    /* 13 */    "N2_A13i",       A_Sum[P13],null,
                    /* 14 */    "N2_A14i",       A_Sum[P14],null,
                    /* 15 */    "N2_A15i",       A_Sum[P15],null,
                    /* 16 */    "N2_A16i",       A_Sum[P16],null
                    );
     end;
  END;

  MACRO PrintItogStr( RowNum:integer )
     if( ПечататьПротокол )
        m_Report.PrintTableLine(
                    /* 0  */    "N2_Dep_Num",    Dep_Num[RowNum]+" "+Dep_Name[RowNum], null,
                    /* 1  */    "N2_Deal_Code",  null, null,
                    /* 2  */    "N2_Party_Name", null, null,
                    /* 3  */    "N2_A3i",        $0, null,
                    /* 4  */    "N2_A4i",        $0, null,
                    /* 5  */    "N2_A5i",        $0, null,
                    /* 6  */    "N2_A6i",        $0, null,
                    /* 7  */    "N2_A7i",        $0, null,
                    /* 8  */    "N2_A8i",        $0, null,
                    /* 9  */    "N2_A9i",        $0, null,
                    /* 10 */    "N2_A10i",       $0, null,
                    /* 11 */    "N2_A11i",       $0, null,
                    /* 12 */    "N2_A12i",       $0, null,
                    /* 13 */    "N2_A13i",       $0, null,
                    /* 14 */    "N2_A14i",       $0, null,
                    /* 15 */    "N2_A15i",       $0, null,
                    /* 16 */    "N2_A16i",       $0, null
                    );
     end;
  END;

  /*вставляем формулы в итоговые строки*/
  MACRO ModifyItogStr()

     var i = 5;/*номер первой итоговой строки*/
     var j = 0;

     if( ПечататьПротокол )

        while( j < Rows_Num.Size() )

           if( Rows_Num[j] > 0 )//вставляем формулы, если есть строки, по которым суммировать
              m_Report.ModifyValue( i-5,"N2_A3i", m_Report.F(m_Report.FormulaSUM()+"(D"+string(i+1)+":D"+string(i+int(Rows_Num[j]))+")") );
              m_Report.ModifyValue( i-5,"N2_A4i", m_Report.F(m_Report.FormulaSUM()+"(E"+string(i+1)+":E"+string(i+int(Rows_Num[j]))+")") );
              m_Report.ModifyValue( i-5,"N2_A5i", m_Report.F(m_Report.FormulaSUM()+"(F"+string(i+1)+":F"+string(i+int(Rows_Num[j]))+")") );
              m_Report.ModifyValue( i-5,"N2_A6i", m_Report.F(m_Report.FormulaSUM()+"(G"+string(i+1)+":G"+string(i+int(Rows_Num[j]))+")") );
              m_Report.ModifyValue( i-5,"N2_A7i", m_Report.F(m_Report.FormulaSUM()+"(H"+string(i+1)+":H"+string(i+int(Rows_Num[j]))+")") );
              m_Report.ModifyValue( i-5,"N2_A8i", m_Report.F(m_Report.FormulaSUM()+"(I"+string(i+1)+":I"+string(i+int(Rows_Num[j]))+")") );
              m_Report.ModifyValue( i-5,"N2_A9i", m_Report.F(m_Report.FormulaSUM()+"(J"+string(i+1)+":J"+string(i+int(Rows_Num[j]))+")") );
              m_Report.ModifyValue( i-5,"N2_A10i",m_Report.F(m_Report.FormulaSUM()+"(K"+string(i+1)+":K"+string(i+int(Rows_Num[j]))+")") );
              m_Report.ModifyValue( i-5,"N2_A11i",m_Report.F(m_Report.FormulaSUM()+"(L"+string(i+1)+":L"+string(i+int(Rows_Num[j]))+")") );
              m_Report.ModifyValue( i-5,"N2_A12i",m_Report.F(m_Report.FormulaSUM()+"(M"+string(i+1)+":M"+string(i+int(Rows_Num[j]))+")") );
              m_Report.ModifyValue( i-5,"N2_A13i",m_Report.F(m_Report.FormulaSUM()+"(N"+string(i+1)+":N"+string(i+int(Rows_Num[j]))+")") );
              m_Report.ModifyValue( i-5,"N2_A14i",m_Report.F(m_Report.FormulaSUM()+"(O"+string(i+1)+":O"+string(i+int(Rows_Num[j]))+")") );
              m_Report.ModifyValue( i-5,"N2_A15i",m_Report.F(m_Report.FormulaSUM()+"(P"+string(i+1)+":P"+string(i+int(Rows_Num[j]))+")") );
              m_Report.ModifyValue( i-5,"N2_A16i",m_Report.F(m_Report.FormulaSUM()+"(Q"+string(i+1)+":Q"+string(i+int(Rows_Num[j]))+")") );
           end;

           if( (int(Rows_Num[j]) > 0) or IsPrintItogStr[j] )
              i = i + 1;
           end;

           i = i + int(Rows_Num[j]);

           j = j + 1;
        end;

     end;

  END;

END;

PRIVATE CLASS CInfo( Report:OBJECT )
  VAR m_Report = Report;

  MACRO BeginReport()
     VAR OurBank = TRecHandler( "party.dbt" );

     ПолучитьСубъекта( {OurBank}, OurBank );

     m_Report.SetActiveSheet( INFO_SHEET_NAME );

     m_Report.PrintFormatString( "",
                                 "N1_OKATO",      DL_GetOkatoCode( {OurBank}, m_Report.RepDate() ),
                                 "N1_OKPO",       OurBank.rec.OKPO,
                                 "N1_BANKREGNUM", ПолучитьКодСубъекта( {OurBank}, PTCK_BANKREGNUM ),
                                 "N1_H1_3",       DL_DateToStr( m_Report.RepDateNa(), true ),
                                 "N1_H4",         OurBank.rec.ShortName,
                                 "N1_H5",         DL_GetRealAddress( {OurBank} ),
                                 "N1_H6",         m_Report.КодВалюты()
                               );
  END;

  MACRO EndReport()
     m_Report.AddStandardFooter( "N1_" );
  END;

  MACRO Print()
     var i = 0;

     while( i < m_Report.A_Sum_All.Size() )
         if((i != _1_6_) and (i != _4_4_))
            m_Report.PrintFormatString( "",
                           /* 3  */    "N1_A3_"+string(i+1), ПеревестиВТысячи(m_Report.A_Sum_All[i].(P3)),
                           /* 4  */    "N1_A4_"+string(i+1), ПеревестиВТысячи(m_Report.A_Sum_All[i].(P4)),
                           /* 5  */    "N1_A5_"+string(i+1), ПеревестиВТысячи(m_Report.A_Sum_All[i].(P5)),
                           /* 6  */    "N1_A6_"+string(i+1), ПеревестиВТысячи(m_Report.A_Sum_All[i].(P6)),
                           /* 7  */    "N1_A7_"+string(i+1), ПеревестиВТысячи(m_Report.A_Sum_All[i].(P7)),
                           /* 8  */    "N1_A8_"+string(i+1), ПеревестиВТысячи(m_Report.A_Sum_All[i].(P8)),
                           /* 9  */    "N1_A9_"+string(i+1), ПеревестиВТысячи(m_Report.A_Sum_All[i].(P9)),
                           /* 10 */    "N1_A10_"+string(i+1), ПеревестиВТысячи(m_Report.A_Sum_All[i].(P10)),
                           /* 11 */    "N1_A11_"+string(i+1), ПеревестиВТысячи(m_Report.A_Sum_All[i].(P11)),
                           /* 12 */    "N1_A12_"+string(i+1), ПеревестиВТысячи(m_Report.A_Sum_All[i].(P12)),
                           /* 13 */    "N1_A13_"+string(i+1), ПеревестиВТысячи(m_Report.A_Sum_All[i].(P13)),
                           /* 14 */    "N1_A14_"+string(i+1), ПеревестиВТысячи(m_Report.A_Sum_All[i].(P14)),
                           /* 15 */    "N1_A15_"+string(i+1), ПеревестиВТысячи(m_Report.A_Sum_All[i].(P15)),
                           /* 16 */    "N1_A16_"+string(i+1), ПеревестиВТысячи(m_Report.A_Sum_All[i].(P16))
                           );
        else
            m_Report.PrintFormatString("", "N1_A16_" + string(i+1), ПеревестиВТысячи(m_Report.A_Sum_All[i].(P16)));
        end;
        i = i + 1;
     end;
  END; 

END;

CLASS (DL_CReportTemplate) DV_RepRisk_Report( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI:BOOL )
  PRIVATE var m_DealSql, m_QueryDeal, m_Deal;
  PRIVATE var УчетПоСделкамПозициям = -1, m_IsExistsData = false;
  PRIVATE VAR m_A_Sum_All = TArray();
  PRIVATE VAR m_ForReporting = false;

  PRIVATE VAR m_RepDate = ZeroDate,
              m_RepDateNa = ZeroDate,
              m_Currency = -1,
              m_ByFISSKO = "",
              m_ByVA = "",
              m_ByVBank = "",
              m_BySecur = "",
              m_Department = {OperDprt};

  /*суммы по строке*/
  PRIVATE MACRO InitA(A)
     A.Size() = 0;
     A[P3]  = $0;
     A[P4]  = $0;
     A[P5]  = $0;
     A[P6]  = $0;
     A[P7]  = $0;
     A[P8]  = $0;
     A[P9]  = $0;
     A[P10] = $0;
     A[P11] = $0;
     A[P12] = $0;
     A[P13] = $0;
     A[P14] = $0;
     A[P15] = $0;
     A[P16] = $0;
  END;

  /*суммы по строке*/
  PRIVATE MACRO InitA_Sum(A_Sum)
     InitA(A_Sum);
  END;

  /*суммы по строке*/
  PRIVATE MACRO GetA_SumArr():TArray
     var A = TArray();
     InitA(A);
     return A;
  END;

  /*суммы по строке*/
  PRIVATE MACRO InitA_Sum_All()
     m_A_Sum_All[_1_3_]             = GetA_SumArr();
     m_A_Sum_All[_1_3_1_]           = GetA_SumArr();
     m_A_Sum_All[_1_3_2_]           = GetA_SumArr();
     m_A_Sum_All[_1_3_2_1_]         = GetA_SumArr();
     m_A_Sum_All[_1_3_3_]           = GetA_SumArr();
     m_A_Sum_All[_1_4_]             = GetA_SumArr();
     m_A_Sum_All[_1_5_]             = GetA_SumArr();
     m_A_Sum_All[_1_6_]             = GetA_SumArr();
     m_A_Sum_All[_4_1_2_]           = GetA_SumArr();
     m_A_Sum_All[_4_2_]             = GetA_SumArr();
     m_A_Sum_All[_4_3_]             = GetA_SumArr();
     m_A_Sum_All[_4_4_]             = GetA_SumArr();
     m_A_Sum_All[_2_1_ФЬЮЧЕРСЫ]     = GetA_SumArr();
     m_A_Sum_All[_5_1_ФЬЮЧЕРСЫ]     = GetA_SumArr();
     m_A_Sum_All[_2_2_ФОРВАРДЫ]     = GetA_SumArr();
     m_A_Sum_All[_5_2_ФОРВАРДЫ]     = GetA_SumArr();
     m_A_Sum_All[_2_3_ВП_СВОПЫ]     = GetA_SumArr();
     m_A_Sum_All[_5_3_ВП_СВОПЫ]     = GetA_SumArr();
     m_A_Sum_All[_2_4_П_СВОПЫ]      = GetA_SumArr();
     m_A_Sum_All[_5_4_П_СВОПЫ]      = GetA_SumArr();
     m_A_Sum_All[_2_5_ОПЦИОНЫ_PUT]  = GetA_SumArr();
     m_A_Sum_All[_5_5_ОПЦИОНЫ_PUT]  = GetA_SumArr();
     m_A_Sum_All[_2_6_ОПЦИОНЫ_CALL] = GetA_SumArr();
     m_A_Sum_All[_5_6_ОПЦИОНЫ_CALL] = GetA_SumArr();
  END;

  /*суммы по строке*/
  PRIVATE MACRO PutInItog( StrNum:integer, A_Sum:TArray )
     var i = 0;
     while( i < A_Sum.size() )
        m_A_Sum_All[StrNum].(i) = m_A_Sum_All[StrNum].(i) + A_Sum[i];
        i = i + 1;
     end;

  END;

  MACRO A_Sum_All()
     return m_A_Sum_All;
  END;

  PRIVATE MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

  MACRO RepDate():Date
     return m_RepDate;
  END;

  MACRO RepDateNa():Date
     return m_RepDateNa;
  END;

  MACRO CurrIsEq(FIID:integer):bool
     if( m_Currency == -1 )
        return true;
     end;
     return (FIID==m_Currency);
  END;

  PRIVATE MACRO BeginReport()
     m_RepDate  = m_Form.GetFieldValue(PNFLD_REPRISK_REPDATE) -1;// за дату, а не на дату
     m_RepDateNa= m_Form.GetFieldValue(PNFLD_REPRISK_REPDATE);//  на дату
     m_Currency = m_Form.GetFieldValue(PNFLD_REPRISK_CURRENCY_CODE);
     m_ByFISSKO = m_Form.GetFieldValue(PNFLD_REPRISK_BYFISSKO);
     m_ByVA     = m_Form.GetFieldValue(PNFLD_REPRISK_BYVA);
     m_ByVBank  = m_Form.GetFieldValue(PNFLD_REPRISK_BYVBANK);
     m_BySecur  = m_Form.GetFieldValue(PNFLD_REPRISK_BYSECUR);
  END;


  MACRO EndReport()
     ReplaceFormulaAndCalculate();
  END;

  PRIVATE MACRO IsOptionKind_Put(StrNum)
     return ((StrNum == _2_5_ОПЦИОНЫ_PUT) or (StrNum == _5_5_ОПЦИОНЫ_PUT));
  END;

  PRIVATE MACRO IsOptionKind_Call(StrNum)
     return ((StrNum == _2_6_ОПЦИОНЫ_CALL) or (StrNum == _5_6_ОПЦИОНЫ_CALL));
  END;

  /*отбор биржевых сделок*/
  PRIVATE MACRO ОтборБиржевыхСделок( DVKind:integer, StrNum:integer )
    var NRec = 0;

    m_DealSql = DL_RSDCommand();

    m_QueryDeal = " SELECT DEAL.t_ID, DEAL.t_FIID, DEAL.t_Date, DEAL.t_Amount, DEAL.t_Bonus, DEAL.t_Price, " +
                  "        TURN.t_FairValue, DEAL.t_Execution, TURN.T_DEALCOST, DV.t_TickFIID, DV.t_Tick, DV.t_StrikeFIID " +
                  "   FROM ddvdeal_dbt DEAL, ddvdlturn_dbt TURN, dfininstr_dbt FI, doproper_dbt opr, dfideriv_dbt DV " +
                  "  WHERE TURN.t_DealID = DEAL.t_ID "+
                  "    AND TURN.t_Date = ( SELECT MAX(dlturn.t_Date) "+
                  "                          FROM ddvdlturn_dbt dlturn "+
                  "                         WHERE dlturn.t_DealID = TURN.t_DealID "+
                  "                           AND dlturn.t_Date <= ? "+
                  "                      ) "+
                  "    AND DEAL.t_Type in('B', 'S')" +
                  "    AND FI.t_FIID = DEAL.t_FIID " +
                  "    AND DV.t_FIID = DEAL.t_FIID " +
                  "    and ltrim(opr.T_DocumentID,'0') = deal.T_ID "+
                  "    and opr.T_DocKind = ? "+
                  "    and DEAL.T_STATE > 0 "+
                  "    and DEAL.t_Client = -1 "+
                  "    and DEAL.t_Department = " + m_Department +
                  "    and FI.t_AvoirKind = ? ";

    m_DealSql.addParam(RepDate());
    m_DealSql.addParam(DL_DVDEAL);
    m_DealSql.addParam(DVKind);

    if( IsOptionKind_Put(StrNum) )
       m_QueryDeal = m_QueryDeal + " and ? = DV.t_OptionType ";
       m_DealSql.addParam(OPTIONKIND_PUT);
    elif( IsOptionKind_Call(StrNum) )
       m_QueryDeal = m_QueryDeal + " and ? = DV.t_OptionType ";
       m_DealSql.addParam(OPTIONKIND_CALL);
    end;

    NRec = m_DealSql.GetCount(m_QueryDeal);
    m_Deal = m_DealSql.execute(m_QueryDeal);

    return NRec;
  END;

  /*отбор позиций по биржевым сделкам*/
  PRIVATE MACRO ОтборСделокПоПозиции( DVKind:integer, StrNum:integer )
    var NRec = 0;

    m_DealSql = DL_RSDCommand();

    m_QueryDeal =  "select pos.t_ID "+
                   "  from ddvfipos_dbt pos, dfininstr_dbt fin "+
                   " where (pos.T_closedate is null or pos.T_closedate = TO_DATE('01.01.0001','DD.MM.YYYY') or "+
                   "        pos.T_closedate > ? ) "+
                   "   and NVL((select turn.t_LongPosition - turn.t_ShortPosition " +
                   "              from ddvfiturn_dbt turn " +
                   "             where "+TurnByPosition(null,null,"pos") +
                   "               and turn.t_Date = (select max(turn.t_Date) " +
                   "                                    from ddvfiturn_dbt turn " +
                   "                                   where "+TurnByPosition(null,null,"pos") +
                   "                                     and turn.t_Date <= ? " +
                   "                                 )"+
                   "           ),0) != 0 "+
                   "   and pos.t_Client = -1 "+
                   "   and pos.t_Department = " + m_Department +
                   "   and fin.t_FIId = pos.t_FIID "+
                   "   and fin.t_AvoirKind = ?";

    m_DealSql.addParam(RepDate);
    m_DealSql.addParam(RepDate);
    m_DealSql.addParam(DVKind);

    if( IsOptionKind_Put(StrNum) )
       m_QueryDeal = m_QueryDeal + " and ? = nvl((select t_OptionType from dfideriv_dbt where t_fiid = fin.t_FIId),0) ";
       m_DealSql.addParam(OPTIONKIND_PUT);
    elif( IsOptionKind_Call(StrNum) )
       m_QueryDeal = m_QueryDeal + " and ? = nvl((select t_OptionType from dfideriv_dbt where t_fiid = fin.t_FIId),0) ";
       m_DealSql.addParam(OPTIONKIND_CALL);
    end;

    NRec = m_DealSql.GetCount(m_QueryDeal);
    m_Deal = m_DealSql.execute(m_QueryDeal);

    return NRec;
  END;

  /*отбор внебиржевых сделок*/
  PRIVATE MACRO ОтборСделокВнебиржевых( DVKind, StrNum:integer, Биржа:bool )
    var NRec = 0;

    m_DealSql = DL_RSDCommand();

    m_QueryDeal = "select NDEAL.T_ID, NDEAL.t_DVKind, NDeal.t_DocKind "+
                  "  from ddvndeal_dbt ndeal, doproper_dbt opr,  doprstep_dbt step "+
                  " where NDEAL.T_DATE <= ? "+
                  "   and ltrim(opr.T_DocumentID,'0') = ndeal.T_ID "+
                  "   and opr.T_DocKind in(?, ?) " +
                  "   and NDEAL.T_STATE > 0 "+
                  "   and (opr.t_End_Date >= ? or opr.t_End_Date = TO_DATE('01.01.0001','DD.MM.YYYY')) "+
                  "   and ndeal.T_DVKind = ? "+
                  "   and ndeal.t_Client = -1 "+
                  "   and ndeal.t_Department = " + m_Department +
                  "   and step.t_ID_Operation = opr.t_ID_Operation  "  +
                  "   and (step.t_Symbol = 'ф' OR step.t_Symbol = 'Ф') " +
                  "   and step.t_IsExecute = 'X'  " +
                  "   and step.t_Fact_Date    <=  ? ";

    m_DealSql.addParam(RepDate);
    m_DealSql.addParam(DL_DVNDEAL);
    m_DealSql.addParam(DL_DVDEALT3);
    m_DealSql.addParam(RepDate);
    m_DealSql.addParam(DVKind);
    m_DealSql.addParam(RepDate);

    if( IsOptionKind_Put(StrNum) )
       m_QueryDeal = m_QueryDeal + " and ndeal.t_OptionType = ? ";
       m_DealSql.addParam(OPTIONKIND_PUT);
    elif( IsOptionKind_Call(StrNum) )
       m_QueryDeal = m_QueryDeal + " and ndeal.t_OptionType = ? ";
       m_DealSql.addParam(OPTIONKIND_CALL);
    end;

    if( DVKind == DV_FORWARD_T3 )
       m_QueryDeal = m_QueryDeal + " and " + IIF(Биржа, "", " not ") + " EXISTS ( SELECT * " +
                                   "                                                FROM DPARTYOWN_DBT " +
                                   "                                               WHERE T_PARTYID   = ndeal.t_Contractor " +
                                   "                                                 AND T_PARTYKIND = ? " +
                                   "                                            ) ";
       m_DealSql.addParam(PTK_MARKETPLASE);
    end;

    m_QueryDeal = m_QueryDeal + "order by NDEAL.T_ID";

    NRec = m_DealSql.GetCount(m_QueryDeal);
    m_Deal = m_DealSql.execute(m_QueryDeal);

    return NRec;
  END;

  PRIVATE MACRO GetNumInterval(Delta:integer)
     var Year, K;

     DateSplit( RepDate(), null, null, Year );
     K = DL_GetDaysInYear(Year);

     if( Delta <= 30 )
        return P3;
     elif( (31 <= Delta) and (Delta <= 90) )
        return P4;
     elif( (91 <= Delta) and (Delta <= 180) )
        return P5;
     elif( (181 <= Delta) and (Delta < K) )
        return P6;
     elif( (K <= Delta) and (Delta < 2*K) )
        return P7;
     elif( (2*K <= Delta) and (Delta < 3*K) )
        return P8;
     elif( (3*K <= Delta) and (Delta < 4*K) )
        return P9;
     elif( (4*K <= Delta) and (Delta < 5*K)  )
        return P10;
     elif( (5*K <= Delta) and (Delta < 7*K)  )
        return P11;
     elif( (7*K <= Delta) and (Delta < 10*K)  )
        return P12;
     elif( (10*K <= Delta) and (Delta < 15*K)  )
        return P13;
     elif( (15*K <= Delta) and (Delta < 20*K)  )
        return P14;
     else
        return P15;
     end;
  END;

  /*для биржевых контрактов*/
  PRIVATE MACRO DvKindStrName( Dv_Kind:integer )
     var strname = "";
     if( Dv_Kind==DERIVATIVE_FUTURES )
        strname = "фьючерс";
     elif( Dv_Kind==DERIVATIVE_OPTION )
        strname = "Опцион";
     end;
     return strname;
  END;

  /*для внебиржевых сделок*/
  PRIVATE MACRO DvKindStrNameN( Dv_Kind:integer )
     var strname = "";
     if( (Dv_Kind == DV_FORWARD) or (Dv_Kind == DV_FORWARD_T3) )
        strname = "Форвард";
     elif(Dv_Kind==DV_OPTION)
        strname = "Опцион";
     elif( Dv_Kind==DV_CURSWAP )
        strname = "Валютный СВОП";
     elif(Dv_Kind==DV_PCTSWAP)
        strname = "Процентный СВОП";
     end;
     return strname;
  END;

  PRIVATE MACRO СР_Курс_НаДату( SumTo, fiidFrom:integer )
     var Type = 0, NewSum = 0.0;

     Type = ПИ_ПолучитьВидКурса(RATETYPE_AVR_PRICE);/*Средневзвешенная цена*/

     if( NOT ПолучитьКурсЗаданногоTипа( @NewSum, fiidFrom, NATCUR, Type, RepDate, true ) )
        msgbox("Не найден курс вида \""+DL_GetRateTypeName(Type)+"\" для ФИ с кодом "+ПолучитьКодФинИн(fiidFrom)+" на дату "+date_as_string(1, RepDateNa));
        SetParm( 1, 0.0 );
        return false;
     end;

     SetParm( 1, NewSum );
     return true;
  END;

  PRIVATE MACRO DV_SmartConvertSum_CB( sumTo, sumFrom, fiidFrom )
     var Type = 0, NewSum = 0.0;

     Type = ПИ_ПолучитьВидКурса(DV_RATETYPE_CBR);

     if( NOT ПолучитьКурсЗаданногоTипа( @NewSum, fiidFrom, NATCUR, Type, RepDate, true ))
        msgbox("Не найден курс вида \"КУРС ЦБ РФ\" для ФИ с кодом "+ПолучитьКодФинИн(fiidFrom)+" на дату "+date_as_string(1, RepDateNa));
        SetParm( 1, 0.0 );
        return false;
     end;

     NewSum = NewSum * double(sumFrom);

     SetParm( 1, NewSum);
     return true;
  END;

  PRIVATE MACRO GetAccRestAtNatCur(FD,AccCat,AccRole,AccFIID)
    var AccRest = $0;
    record Acc ("account");

    if( not FD.IsExistAccount( AccCat, null, true, AccRole, Acc, null, RepDate, AccFIID ) )
       return $0;
    end;

    AccRest = DL_GetRestAccount( Acc, RepDate );
    if( Acc.Kind_Account == "А" )
       AccRest = -AccRest;
    end;

    if( NOT DV_SmartConvertSum_CB( AccRest, AccRest, Acc.Code_Currency ) )
       msgbox(GetCurrencyConvertErrorMsg(Acc.Code_Currency, NATCUR, RepDate));
       return $0;
    end;

    return AccRest;
  END;

  PRIVATE MACRO GetDelta(Sba, Str, IsPUT:bool)

    var Delta;

    if( IsPUT )
       Delta = Sba - Str;
    else
       Delta = Str - Sba;
    end;

    if( Delta == 0.0 )
       return 0.5;
    elif( Delta > 0.0 )
       return 1;
    else
       return 0;
    end;

  END;

  /*в случае посделочного учета биржевых сделок*/
  PRIVATE MACRO СтрокиОпционФьючерсПоСделке( ObjReport:OBJECT, Dv_Kind:integer, RCType:integer, StrNum:integer )
    var NRec = ОтборБиржевыхСделок(Dv_Kind, StrNum);
    var Progress = TProgressBar;
    var FD;

    var AccCat = "", AccRest = $0, AccRole = FIROLE_UNDEF, AccFIID = ALLFININSTR;
    var ReqAcc:string  = ""; var ReqFIID:integer  = ALLFININSTR;  var ReqFiRole  = FIROLE_UNDEF;
    var ComAcc:string  = ""; var ComFIID:integer  = ALLFININSTR;  var ComFiRole  = FIROLE_UNDEF;
    var RowNum = 0, IntervalNum;
    VAR A_Sum = TArray(), Sba = 0.0, Str = 0.0;
    var ВЦ:integer;

    if( not IsPrintItogStr[StrNum] )
       ObjReport.PrintItogStr( StrNum );
       IsPrintItogStr[StrNum] = true;
    end;

    if( NRec > 0 )
       Progress.Init( NRec, "", "Отбор биржевых сделок по контракту вида "+DvKindStrName(Dv_Kind)+ " по состоянию на "+string(RepDateNa) );
       while( m_Deal.MoveNext() )

          InitA_Sum(A_Sum);

          FD = DVFirstDocDeal(DL_DVDEAL, SQL_ConvTypeInteger(m_Deal.ID));

          ПолучитьВнебалансовыеСчетаБирж( FD, @ReqAcc, @ReqFIID, @ReqFiRole, @ComAcc, @ComFIID, @ComFiRole );

          if( RCType == ТРЕБОВАНИЯ )
             AccRole = ReqFiRole;
             AccFIID = ReqFIID;
             AccCat  = ReqAcc;
          else
             AccRole = ComFiRole;
             AccFIID = ComFIID;
             AccCat  = ComAcc;
          end;

          if( not CurrIsEq(AccFIID) )
             Progress.Use;
             continue;
          end;

          AccRest = GetAccRestAtNatCur(FD, AccCat,AccRole,AccFIID);

          if( AccRest == $0 )
             Progress.Use;
             continue;
          end;

          if( FD.FI.rec.DrawingDate <= RepDate() )
             IntervalNum = P3;
          else
             IntervalNum = GetNumInterval(FD.FI.rec.DrawingDate - RepDate());
          end;

          if( Dv_Kind == DERIVATIVE_OPTION )
             ВЦ = ПолучитьВалютуЦеныПИ(FD);

             if( NOT DV_SmartConvertSum_CB(Sba, FD.Deal.rec.PositionCost, ВЦ) )
                Progress.Use;
                continue;
             end;

             if( not СР_Курс_НаДату(Str,FD.BaseFI().rec.FIID) )
                Progress.Use;
                continue;
             end;
             Str = Str * FD.FI().rec.FaceValue * FD.Deal.rec.Amount;

             A_Sum[IntervalNum] = money(round(AccRest * GetDelta(Sba,Str,IsOptionKind_Put(StrNum)),2));
          else
             A_Sum[IntervalNum] = AccRest;
          end;

          ObjReport.Print( FD.DealCode(), FD.GetContractorID(), A_Sum );

          PutInItog(StrNum, A_Sum);
          RowNum = RowNum + 1;

          m_IsExistsData = true;

          Progress.Use;
       end;
       Progress.Remove;
    end;

    return RowNum;

  END;

  /*отбор биржевых позиций с опционами и фьючерсами */
  PRIVATE MACRO СтрокиОпционФьючерсПоПозиции( ObjReport:OBJECT, Dv_Kind:integer, RCType:integer, StrNum:integer )
    var NRec = ОтборСделокПоПозиции(Dv_Kind, StrNum);
    var Progress = TProgressBar;
    var FD, Turn:variant;

    var AccCat = "", AccRest = $0, AccRole = FIROLE_UNDEF, AccFIID = ALLFININSTR, Rt = 0.0;
    var ReqAcc:string  = ""; var ReqFIID:integer  = ALLFININSTR;  var ReqFiRole  = FIROLE_UNDEF;
    var ComAcc:string  = ""; var ComFIID:integer  = ALLFININSTR;  var ComFiRole  = FIROLE_UNDEF;
    var RowNum = 0, IntervalNum;
    VAR A_Sum = TArray(), Sba = 0.0, Str = 0.0;

    var ВЦ:integer;

    var NN:money = $0;
    var NS:money = $0;

    if( not IsPrintItogStr[StrNum] )
       ObjReport.PrintItogStr( StrNum );
       IsPrintItogStr[StrNum] = true;
    end;

    if( NRec > 0 )

       Progress.Init( NRec, "", "Отбор позиций по контракту вида "+DvKindStrName(Dv_Kind)+ " по состоянию на "+string(RepDateNa) );
       while( m_Deal.MoveNext() )

          InitA_Sum(A_Sum);

          FD = DVFirstDocPos( DL_DVFIPOS, SQL_ConvTypeInteger(m_Deal.ID));

          ПолучитьВнебалансовыеСчетаБирж( FD, @ReqAcc, @ReqFIID, @ReqFiRole, @ComAcc, @ComFIID, @ComFiRole );

          if( RCType == ТРЕБОВАНИЯ )
             AccRole = ReqFiRole;
             AccFIID = ReqFIID;
             AccCat  = ReqAcc;
          else
             AccRole = ComFiRole;
             AccFIID = ComFIID;
             AccCat  = ComAcc;
          end;

          if( not CurrIsEq(AccFIID) )
             Progress.Use;
             continue;
          end;

          AccRest = GetAccRestAtNatCur(FD, AccCat, AccRole, AccFIID);

          if( AccRest == $0 )
             Progress.Use;
             continue;
          end;

          if( FD.FI.rec.DrawingDate <= RepDate() )
             IntervalNum = P3;
          else
             IntervalNum = GetNumInterval(FD.FI.rec.DrawingDate - RepDate());
          end;

          if( Dv_Kind == DERIVATIVE_OPTION )

             ВЦ = ПолучитьВалютуЦеныПИ(FD);

             FD.GetFITurnOnDate(@Turn,"MAX", RepDate);/*актуальные итоги по позиции на отчетную дату*/

             NN = abs(Turn.LONGPOSITION - Turn.SHORTPOSITION);
             NS = abs(Turn.LONGPOSITIONCOST - Turn.SHORTPOSITIONCOST);

             if( NOT DV_SmartConvertSum_CB(Sba, NS, ВЦ) )
                Progress.Use;
                continue;
             end;

             if( not СР_Курс_НаДату( Str, FD.BaseFI().rec.FIID ) )
                Progress.Use;
                continue;
             end;
             Str = Str * FD.FI().rec.FaceValue * NN;

             A_Sum[IntervalNum] = money(round(AccRest * GetDelta(Sba,Str,IsOptionKind_Put(StrNum)),2));
          else
             A_Sum[IntervalNum] = AccRest;
          end;

          ObjReport.Print( FD.FI.rec.FI_Code, FD.GetContractorID(), A_Sum );
          PutInItog(StrNum,A_Sum);

          m_IsExistsData = true;
          RowNum = RowNum + 1;

          Progress.Use;
       end;

       Progress.Remove;
    end;

    return RowNum;

  END;

  private macro ЧастьНаВнебалансе( pFD, ПоТребованиям:bool, AccRest:@money, AccFIID:@integer ):bool

     record reqaccdoc(mcaccdoc);
     record comaccdoc(mcaccdoc);
     record reqcateg(mccateg);
     record comcateg(mccateg);

     var ReqAcc:string = ""; var ReqFIID:integer = ALLFININSTR; var ReqFiRole = FIROLE_UNDEF;
     var ComAcc:string = ""; var ComFIID:integer = ALLFININSTR; var ComFiRole = FIROLE_UNDEF;

     ПолучитьСрочныеСчетаВнб(pFD, @ReqAcc, @ReqFIID, @ReqFiRole, @ComAcc, @ComFIID, @ComFiRole);

     if( pFD.OpenAccByGenAgr() )
        /* найдём на внебалансе ли часть? */
        if( pFD.IsPctSWAP() )
           if( pFD.БазовыеВалютыРавны() )
              if( (DV_GetStepStatusBySymbol(pFD.Deal.rec.ID, pFD.Deal.rec.DocKind, "Р", RepDate(), 272001) == SET_CHAR) or   // "Промежуточный платеж расч."
                  (DV_GetStepStatusBySymbol(pFD.Deal.rec.ID, pFD.Deal.rec.DocKind, "Р", RepDate(), 272002) == SET_CHAR) or   // "Промежуточный платеж оплата пост."
                  (DV_GetStepStatusBySymbol(pFD.Deal.rec.ID, pFD.Deal.rec.DocKind, "Р", RepDate(), 272003) == SET_CHAR) )    // "Промежуточный платеж получение пост."  
                 return false; 
              end; 
           else
              if( ((pFD.DealPart == 1) and (DV_GetStepStatusBySymbol(pFD.Deal.rec.ID, pFD.Deal.rec.DocKind, "и", RepDate()) == SET_CHAR)) or         // "Исполнение 1ч."
                  ((pFD.DealPart == 2) and (DV_GetStepStatusBySymbol(pFD.Deal.rec.ID, pFD.Deal.rec.DocKind, "И", RepDate(), 272010) == SET_CHAR)) )  // "Исполнение"
                 return false; 
              end;            
           end;            
        else
           var OffBalance:integer = DV_OPERSTATUS_OFFBALANCE_NO;
           DV_NDealGetOperStatus(pFD.ID, IIF(pFD.DealPart == 1, pFD.DV_OPERSTATUS_OFFBALANCE(), pFD.DV_OPERSTATUS_OFFBALANCE_2()), OffBalance);

           if( OffBalance != DV_OPERSTATUS_OFFBALANCE_YES )
              return false;
           end;
        end;

        var Sum:money = $0.0;
        Sum = IIF(ПоТребованиям, pFD.ReqSum(), pFD.ComSum());

        var НКР = DL_ПолучитьПоследнююСумму(pFD.Kind, pFD.ID, DLSUM_KIND_SUM_DV_NKR);
        if( pFD.IsForward() or pFD.IsOption() )
           if( pFD.IsSale_BuyPutOrSaleCall() )
              if( not ПоТребованиям )
                 Sum = Sum + НКР;
              end;
           else
              if( ПоТребованиям )
                 Sum = Sum + НКР;
              end;
           end;
        end;

        AccRest = Sum;
        AccFIID = IIF(ПоТребованиям, ReqFIID, ComFIID);
     else
        var ОстатокСчетОбяз = $0;
        var ОстатокСчетТреб = $0;

        if( not MC_FindMCCATEG(ReqAcc,reqcateg) )
           msgbox("Не найдена категория счета \""+ReqAcc+"\"");
           return false;
        end;

        if( not MC_FindMCCATEG(ComAcc,comcateg) )
           msgbox("Не найдена категория счета \""+ComAcc+"\"");
           return false;
        end;

        /*ищем актуальные на дату счета*/
        MC_FindMaxMCACCDOC(pFD.Kind, pFD.ID, reqcateg.ID, ReqFIID, RepDate(), reqaccdoc, ReqFiRole);
        MC_FindMaxMCACCDOC(pFD.Kind, pFD.ID, comcateg.ID, ComFIID, RepDate(), comaccdoc, ComFiRole);

        if( reqaccdoc.ID > 0 )
           ОстатокСчетТреб = ОстатокНаСчёте(reqaccdoc.Account,ReqFIID,reqaccdoc.Chapter,RepDate());
        end;

        if( comaccdoc.ID > 0 )
           ОстатокСчетОбяз = ОстатокНаСчёте(comaccdoc.Account,ComFIID,comaccdoc.Chapter,RepDate());
        end;

        if( (ОстатокСчетТреб == $0) and (ОстатокСчетОбяз == $0) )
           return false;
        end;

        if( ПоТребованиям )
           AccRest = ОстатокСчетТреб;
           AccFIID = ReqFIID;
        else
           AccRest = ОстатокСчетОбяз;
           AccFIID = ComFIID;
        end;
     end;

     return true;
  end;

  /*сбор данных по внебиржевым сделкам с форвардом или опционом*/
  PRIVATE MACRO СтрокиФорвардОпционВнеБирж( ObjReport:OBJECT, Dv_Kind:integer, RCType:integer, StrNum:integer, Биржа:bool )
    var NRec = ОтборСделокВнебиржевых(Dv_Kind, StrNum, Биржа);
    var Progress = TProgressBar;
    var FD;

    var AccCat = "", AccRest = $0, AccRole = FIROLE_UNDEF, AccFIID = ALLFININSTR;
    var RowNum = 0, IntervalNum;
    VAR A_Sum = TArray(), Str = 0.0, Sba = 0.0;
    var FI = ПроизводныйИнструмент();

    if( not IsPrintItogStr[StrNum] )
       ObjReport.PrintItogStr( StrNum );
       IsPrintItogStr[StrNum] = true;
    end;

    if( NRec > 0 )
       Progress.Init( NRec, "", "Отбор сделок \"Внебиржевой "+DvKindStrNameN(Dv_Kind)+"\" по состоянию на "+string(RepDateNa) );
       while( m_Deal.MoveNext() )

          InitA_Sum(A_Sum);

          FD = DVFirstDocNDeal(m_Deal.DocKind, SQL_ConvTypeInteger(m_Deal.ID));

          if( FD.IsDealExcecute(RepDate) == true )
             Progress.Use;
             continue;
          end;

          if( not ЧастьНаВнебалансе(FD, (RCType==ТРЕБОВАНИЯ), @AccRest, @AccFIID) )
             Progress.Use;
             continue;
          end;

          if( not CurrIsEq(AccFIID) )
             Progress.Use;
             continue;
          end;

          if( NOT DV_SmartConvertSum_CB(AccRest, AccRest, AccFIID) )
             msgbox(GetCurrencyConvertErrorMsg(AccFIID, NATCUR, RepDate));
             Progress.Use;
             continue;
          end;

          if( ((Dv_Kind == DV_FORWARD) or (Dv_Kind == DV_FORWARD_T3)) and ((FD.nFI_().rec.OpenDate == SET_CHAR) or (FD.nFI_().rec.ExecDate == Date(0,0,0))) )
             IntervalNum = P15;
          else
             if( FD.nFI_().rec.ExecDate > RepDate() )
                IntervalNum = GetNumInterval(FD.nFI_().rec.ExecDate - RepDate());
             else
                IntervalNum = P3;
             end;
          end;

          if( Dv_Kind == DV_OPTION )
             /*страйк для опциона для стандартных берем из анкеты опциона*/
             if( FD.nFI_BaseActiv.rec.STDFIID > 0 )
                FI.Init(FD.nFI_BaseActiv.rec.STDFIID);
                if( FI.DV.PriceUnit == 1 )/*за 1 контракт*/
                   Sba = double(FI.DV.Strike);
                else
                   Sba = double(FI.DV.Strike * FI.FI.FaceValue);
                end;
             else
                Sba = double(FD.nFI_BaseActiv.rec.Price * FD.nFI_BaseActiv.rec.Amount);
             end;

             if( NOT DV_SmartConvertSum_CB(Sba, Sba, FD.nFI_BaseActiv.rec.PriceFIID) )
                Progress.Use;
                continue;
             end;

             if( FD.Deal.rec.Forvard == SET_CHAR ) /*для опциона на форвард должны получить БА форварда*/
                if( not СР_Курс_НаДату( Str, FD.nFI_Forward.rec.FIID ) )
                   Progress.Use;
                   continue;
                end;
                Str = Str * FD.nFI_Forward.rec.Amount;
             else
                if( not СР_Курс_НаДату( Str, FD.nFI_BaseActiv.rec.FIID ) )
                   Progress.Use;
                   continue;
                end;
                Str = Str * FD.nFI_BaseActiv.rec.Amount;
             end;

             A_Sum[IntervalNum] = money(round(AccRest * GetDelta(Sba,Str,IsOptionKind_Put(StrNum)),2));
          else
             A_Sum[IntervalNum] = AccRest;
          end;

          ObjReport.Print(FD.GetDoc().rec.Code, FD.GetDoc().rec.Contractor, A_Sum);

          PutInItog(StrNum, A_Sum);

          m_IsExistsData = true;
          RowNum = RowNum + 1;

          Progress.Use;
       end;
       Progress.Remove;
    end;

    return RowNum;
  END;

  /*сбор данных по внебиржевым сделкам вида СВОП (валютный,%(процентный))*/
  PRIVATE MACRO СтрокиСВОП( ObjReport:OBJECT, Dv_Kind:integer, RCType:integer, StrNum:integer )
    var NRec = ОтборСделокВнебиржевых(Dv_Kind);
    var Progress = TProgressBar;

    var RowNum = 0, IntervalNum, P_2;
    VAR A_Sum = TArray(), IsExistsData = false;

    var ПоТребованиям = (RCType==ТРЕБОВАНИЯ);
    var ОтбиратьВПСвоп = Dl_IIF((StrNum==_2_3_ВП_СВОПЫ)or(StrNum==_5_3_ВП_СВОПЫ),true,false);

    private macro УчестьТОПоЧастиНаВнебалансе(FD_SW)

       var vSum = $0;

       if( not ЧастьНаВнебалансе(FD_SW, ПоТребованиям) )
          return false;
       end;

       IntervalNum = P3;
       if(FD_SW.DealPart == 1)
          if( FD_SW.ДатаНачала() > RepDate() )
             IntervalNum = GetNumInterval(FD_SW.ДатаНачала() - RepDate());
          end;
       else
          if( FD_SW.nFI_().rec.ExecDate > RepDate() )
             IntervalNum = GetNumInterval(FD_SW.nFI_().rec.ExecDate - RepDate());
          end;
       end;

       vSum = $0;
       /*для первой части: сумма требований и обязательств из параметров опера-ции в валюте требования/обязательств, соответственно,*/
       if( ПоТребованиям )
          if( NOT DV_SmartConvertSum_CB( vSum, FD_SW.ComSum(), FD_SW.ComSumFIID() ) )
             return false;
          end;
       else
          if( NOT DV_SmartConvertSum_CB( vSum, FD_SW.ReqSum(), FD_SW.ReqSumFIID() ) )
             return false;
          end;
       end;

       A_Sum[IntervalNum] = A_Sum[IntervalNum] + vSum;

       return true;
    end;

    private macro СуммаПлатежаНаДату(pPmgr,Side:integer)
       var vSum = $0;
       var cmd = RSDCommand("select BC.T_DEMANDSUM, BC.T_LIABILITYSUM, BC.T_PAYMENTSUM "+
                            "  from DDVNPMGRbc_dbt bc "+
                            " where BC.T_PMGRID = ? "+
                            "   and BC.T_CHANGEDATE <= ? "+
                            " order by BC.T_CHANGEDATE desc"
                           );

       cmd.addParam( "", RSDBP_IN, pPmgr.ID );
       cmd.addParam( "", RSDBP_IN, RepDate );

       var DataSet = TRsbDataSet(cmd);

       if( DataSet.MoveNext() )
          if( Side == ALG_DV_PMGR_SIDE_DEMAND )
             vSum = SQL_ConvTypeSum(DataSet.DEMANDSUM);
          else
             vSum = SQL_ConvTypeSum(DataSet.LIABILITYSUM);
          end;
       else
          if( Side == ALG_DV_PMGR_SIDE_DEMAND )
             vSum = SQL_ConvTypeSum(pPmgr.DEMAND);
          else
             vSum = SQL_ConvTypeSum(pPmgr.LIABILITY);
          end;
       end;

       return vSum;
    end;

    var FD, FD2;
    var FixSide:bool = false, Sum = $0, SumFIID = -1;
    VAR Pmgr, Query, QueryTxt;

    if( not IsPrintItogStr[StrNum] )
       ObjReport.PrintItogStr( StrNum );
       IsPrintItogStr[StrNum] = true;
    end;

    if( NRec > 0 )
       Progress.Init( NRec, "", "Отбор сделок \"Внебиржевой "+DvKindStrNameN(Dv_Kind)+"\" по состоянию на "+string(RepDateNa()) );
       while( m_Deal.MoveNext() )
          InitA_Sum(A_Sum);
          IsExistsData = false;

          FD = DVFirstDocNDeal(m_Deal.DocKind, SQL_ConvTypeInteger(m_Deal.ID));
          FD2 = DVFirstDocNDeal(m_Deal.DocKind, SQL_ConvTypeInteger(m_Deal.ID), 2);

          if( (ОтбиратьВПСвоп == true) and (FD.БазовыеВалютыРавны() != false) )
             Progress.Use;
             continue;
          end;

          if( (ОтбиратьВПСвоп != true) and (FD.БазовыеВалютыРавны() == false) )
             Progress.Use;
             continue;
          end;

          if( ПоТребованиям AND (not CurrIsEq(FD.ВалютаТребования())) )
             Progress.Use;
             continue;
          end;

          if( (not ПоТребованиям) AND (not CurrIsEq(FD.ВалютаОбязательства())) )
             Progress.Use;
             continue;
          end;

          /*проверяем, что части на внебалансе и берем Т\О по соответствующим частям*/
          if( УчестьТОПоЧастиНаВнебалансе(FD) )
             IsExistsData = true;
          end;
          if( УчестьТОПоЧастиНаВнебалансе(FD2) )
             IsExistsData = true;
          end;

          /*интервал для платежей с фиксиров ставкой*/
          if( FD.nFI_().rec.ExecDate > RepDate() )
             P_2 = GetNumInterval(FD.nFI_().rec.ExecDate - RepDate());
          else
             P_2 = P3;
          end;

          /*ищем промежут. платежи*/
          Query = DL_RSDCommand();

          QueryTxt = " SELECT * " +
                     "   FROM DV_DVNPMGR " +
                     "  WHERE t_Type     = 3 " + /* секция по таблице */
                     "    AND (t_Status = 1 or " + /* ожидается */
                     "         (t_Status = 2 and T_PAYDATE > ?) "+/*шаг исполнения платежа не выполнен на дату*/
                     "        ) " +
                     "    AND t_DealID   = ? " +
                     "    AND t_FixRate > 0";

          Query.addParam( RepDate );
          Query.addParam( FD.Deal.rec.ID );

          if( FD.ПоставочныйКонтракт() )
             QueryTxt = QueryTxt + " and t_Side = ? ";
             Query.addParam( DL_IIF(ПоТребованиям,ALG_DV_PMGR_SIDE_DEMAND,ALG_DV_PMGR_SIDE_LIABILITY) );
          end;

          Pmgr = Query.execute( QueryTxt );

          while( Pmgr.MoveNext() )
             FixSide = DV_NDealSideFix(DL_IIF(ПоТребованиям,ALG_DV_PMGR_SIDE_DEMAND,ALG_DV_PMGR_SIDE_LIABILITY), FD.Deal);

             Sum = $0;
             SumFIID = -1;

             if( ПоТребованиям )
                if( (not FD.ПоставочныйКонтракт()) or (SQL_ConvTypeInteger(Pmgr.Side) == ALG_DV_PMGR_SIDE_DEMAND) )
                   Sum = СуммаПлатежаНаДату(Pmgr,ALG_DV_PMGR_SIDE_DEMAND);
                   SumFIID = FD.ВалютаТребования();
                   IsExistsData = true;
                end;
             else
                if( (not FD.ПоставочныйКонтракт()) or (SQL_ConvTypeInteger(Pmgr.Side) == ALG_DV_PMGR_SIDE_LIABILITY) )
                   Sum = СуммаПлатежаНаДату(Pmgr,ALG_DV_PMGR_SIDE_LIABILITY);
                   SumFIID = FD.ВалютаОбязательства();
                   IsExistsData = true;
                end;
             end;

             if( FixSide )
                IntervalNum = P_2;
             else
                if( SQL_ConvTypeDate(Pmgr.FIXDATE) > RepDate() )
                   IntervalNum = GetNumInterval(SQL_ConvTypeDate(Pmgr.FIXDATE) - RepDate());
                else
                   IntervalNum = P3;
                end;
             end;

             if( NOT DV_SmartConvertSum_CB( Sum, Sum, SumFIID ) )
                Progress.Use;
                continue;
             end;

             A_Sum[IntervalNum] = A_Sum[IntervalNum] + Sum;
          end;

          var QueryFloat = " SELECT * " +
                           "   FROM DV_DVNPMGR " +
                           "  WHERE t_Type     = 3 " + /* секция по таблице */
                           "    AND (t_Status = 1 or " + /* ожидается */
                           "         (t_Status = 2 and T_PAYDATE > ?) "+/*шаг исполнения платежа не выполнен на дату*/
                           "        ) " +
                           "    AND t_DealID   = ? " +
                           "    AND t_FloatRateValue > 0" +
                           "    AND t_FixDate = (" +
                           "                        select min(t_FixDate)" +
                           "                        from DV_DVNPMGR" +
                           "                        where t_FixDate >= ?" +
                           "                              and t_Type = 3" +
                           "                              and (" +
                           "                                      t_Status = 1" +
                           "                                      or (" +
                           "                                            t_Status = 2 and t_PayDate > ?" +
                           "                                         )" +
                           "                                  )" +
                           "                              and t_DealID = ?" +
                           "                              and t_FloatRateValue > 0" +
                           "                    )";

          var SelectFloat = DL_RSDCommand(QueryFloat);
          SelectFloat.AddParam(RepDate);
          SelectFloat.AddParam(FD.Deal.rec.ID);
          SelectFloat.AddParam(RepDate);
          SelectFloat.AddParam(RepDate);
          SelectFloat.AddParam(FD.Deal.rec.ID);
          var DSFloat = SelectFloat.Execute();

          while(DSFloat.MoveNext())
            FixSide = DV_NDealSideFix(DL_IIF(ПоТребованиям,ALG_DV_PMGR_SIDE_DEMAND,ALG_DV_PMGR_SIDE_LIABILITY), FD.Deal);

             Sum = $0;
             SumFIID = -1;

             if( ПоТребованиям )
                if( (not FD.ПоставочныйКонтракт()) or (SQL_ConvTypeInteger(DSFloat.Side) == ALG_DV_PMGR_SIDE_DEMAND) )
                   Sum = СуммаПлатежаНаДату(DSFloat,ALG_DV_PMGR_SIDE_DEMAND);
                   SumFIID = FD.ВалютаТребования();
                   IsExistsData = true;
                end;
             else
                if( (not FD.ПоставочныйКонтракт()) or (SQL_ConvTypeInteger(DSFloat.Side) == ALG_DV_PMGR_SIDE_LIABILITY) )
                   Sum = СуммаПлатежаНаДату(DSFloat,ALG_DV_PMGR_SIDE_LIABILITY);
                   SumFIID = FD.ВалютаОбязательства();
                   IsExistsData = true;
                end;
             end;

             if( FixSide )
                IntervalNum = P_2;
             else
                if( SQL_ConvTypeDate(DSFloat.FIXDATE) > RepDate() )
                   IntervalNum = GetNumInterval(SQL_ConvTypeDate(DSFloat.FIXDATE) - RepDate());
                else
                   IntervalNum = P3;
                end;
             end;

             if( NOT DV_SmartConvertSum_CB( Sum, Sum, SumFIID ) )
                Progress.Use;
                continue;
             end;

             A_Sum[IntervalNum] = A_Sum[IntervalNum] + Sum;
          end;

          if( IsExistsData )
             ObjReport.Print( FD.GetDoc().rec.Code, FD.GetDoc().rec.Contractor, A_Sum );
             RowNum = RowNum + 1;
             m_IsExistsData = true;
          end;

          PutInItog(StrNum, A_Sum);

          Progress.Use;
       end;
       Progress.Remove;
    end;

    return RowNum;
  END;

  PRIVATE MACRO sqlОтборЛотов_1_4_или_1_5( StrNum )
     var AvrKindsRoot;

     if( StrNum == _1_4_ ) // 1.4 - по облигациям
        AvrKindsRoot = AVOIRISSKIND_BOND;
     else // 1.5 - все долевые ц/б: акции, паи, расписки
        AvrKindsRoot = AVOIRISSKIND_DEPOSITORY_RECEIPT + ", " + AVOIRISSKIND_INVESTMENT_SHARE + ", " + AVOIRISSKIND_SHARE;
     end;

     return " SELECT wrtsum.t_SumID, " +
            "        wrtsum.t_FIID, " +
            "        wrtsum.T_NKDAMOUNT, " +
            "        wrtsum.t_INTERESTINCOME, " +
            "        wrtsum.t_BALANCECOST, " +
            "        wrtsum.t_AMORTCOST, " +
            "        wrtsum.t_AmortCalcKind, " +
            "        wrtsum.T_DISCOUNTINCOME, " +
            "        wrtsum.t_RESERVAMOUNT, " +
            "        wrtsum.t_BONUS, " +
            "        wrtsum.t_DealCode, " +
            "        wrtsum.t_IncomeReserv as IncomeReserv, " +
            "        wrtsum.t_Portfolio, "
            "        wrtsum.t_Amount, "
            "        fin.t_FaceValueFI, " +
            "        fin.t_FaceValue, " +
            "        fin.t_Issuer, " +
            "        fin.t_AvoirKind, " +
            "        fin.t_FI_CODE, " +
            "        dl_leg.t_Cost, " +
            "        dl_leg.t_DealID, " +
            "        dl_leg.t_RelativePrice, " +
            "        dl_leg.t_Price, " +
            "        RSI_RSB_FIInstr.FI_AvrKindsGetRoot(fin.t_fi_kind, fin.t_AvoirKind) t_AvrKindsRoot, " +
            "        (case when RSI_RSB_FIInstr.FI_AvrKindsGetRoot(fin.t_fi_kind, fin.t_AvoirKind) = " + AVOIRISSKIND_BOND +
            "              then PM_COMMON.GetObjAttrValue("+OBJTYPE_AVOIRISS+", LPAD(fin.t_fiid, 10, '0'), "+OBJGROUP_AVRRISKGROUP+", "+getSqlDate(RepDate())+") " +
            "              else 0 " +
            "        end) t_AvrRiskGroup, " +
            "        (case when fin.t_AvoirKind = "+AVOIRISSKIND_PREFERENCE_SHARE+
            "              then nvl((SELECT warnts.t_DrawingDate FROM dfiwarnts_dbt warnts WHERE warnts.t_FIID = fin.t_FIID and warnts.t_DrawingDate > "+getSqlDate(RepDate())+" and warnts.t_IsPartial = CHR(0) and rownum = 1), fin.t_DrawingDate) " +
            "              else fin.t_DrawingDate " +
            "        end) t_DrawingDate, " +
            "        PM_COMMON.GetObjAttrValue(" + OBJTYPE_AVOIRISS + ", LPAD(fin.t_fiid, 10, '0'), " + OBJGROUP_SFCOM_CALCBYBO + ", "+getSqlDate(RepDate())+") as t_QualCat, " +
            "        (select nvl(sum(case when t.t_IsPartial = 'X' then 1 else 0 end),0) IsPartial " +
            "           from dfiwarnts_dbt t where t.t_FIID = wrtsum.t_FIID) IsPartial, "
            "        (select nvl(sum(case when t.t_IsPartial = 'X' then 0 else 1 end),0) IsCoupon " +
            "           from dfiwarnts_dbt t where t.t_FIID = wrtsum.t_FIID) IsCoupon "
            " FROM v_scwrthistex wrtsum, dfininstr_dbt fin, ddl_leg_dbt dl_leg" +
            " WHERE wrtsum.t_Buy_Sale = " + PM_WRITEOFF_SUM_BUY +
            "   and wrtsum.t_Date <= " + getSqlDate(RepDate()) +
            "   and wrtsum.t_Amount > 0 " +
            "   and wrtsum.t_state IN ( "+PM_WRTSUM_FORM+","+PM_WRTSUM_SALE_BPP+") " +
            "   and wrtsum.t_Department = " + m_Department +
            "   and wrtsum.t_instance = (SELECT MAX (t_instance) " +
            "                            FROM v_scwrthistex " +
            "                            WHERE t_sumid = wrtsum.t_sumid " +
            "                              AND t_changedate <= "+getSqlDate(RepDate())+" ) " +
            "   and fin.t_fiid = wrtsum.t_FIID " +
            "   and dl_leg.t_DealID = wrtsum.t_DealID " +
            "   and RSI_RSB_FIInstr.FI_AvrKindsGetRoot(fin.t_fi_kind, fin.t_AvoirKind) IN (" + AvrKindsRoot + ") " +
            "   and wrtsum.t_Portfolio in ("+KINDPORT_TRADE/*ТП*/+","+KINDPORT_SALE/*ППР*/+","+KINDPORT_CONTR/*ПКУ*/+","+KINDPORT_RETIRE/*ПУДП*/+") "
            +   IIF(m_Currency != ALLFININSTR, " and fin.t_FaceValueFI = " + m_Currency, "") +
            "   and wrtsum.t_DealID > 0 " + // !?
            " ORDER BY wrtsum.t_FIID ";
  END;

  PRIVATE MACRO GetValOfLine_1_6_or_4_4(CatCode, RepDate, Sum:@Money)
     var Query = "select sum(rsb_account.RestAC(mcaccdoc.t_account, mcaccdoc.t_currency, ?, mcaccdoc.t_chapter, 0)) as t_Sum, Count(1) as t_Count" +
                  " from dmccateg_dbt mccateg, dmcaccdoc_dbt mcaccdoc" +
                  " where mccateg.t_code = '" + CatCode + "'" +
                  "    and mccateg.t_leveltype = 1" +
                  "    and mcaccdoc.t_catid = mccateg.t_id" +
                  "    and not exists (select 1" +
                  "                     from dmccateg_dbt cat, dmctempl_dbt tpl" +
                  "                     where cat.t_id = mccateg.t_id" +
                  "                          and tpl.t_catid = cat.t_id" +
                  "                          and tpl.t_Number = mcaccdoc.t_TemplNum " +
                  "                          and (case when cat.t_class1 = 180 then tpl.t_Value1" +
                  "                                  when cat.t_class2 = 180 then tpl.t_Value2" +
                  "                                  when cat.t_class3 = 180 then tpl.t_Value3" +
                  "                                 when cat.t_class4 = 180 then tpl.t_Value4" +
                  "                                 when cat.t_class5 = 180 then tpl.t_Value5" +
                  "                                 when cat.t_class6 = 180 then tpl.t_Value6" +
                  "                                 when cat.t_class7 = 180 then tpl.t_Value7" +
                  "                                 when cat.t_class8 = 180 then tpl.t_Value8" +
                  "                               end) = 7" +
                  "                )";

     var cmd = DL_RSDCommand(Query);
     cmd.AddParam(RepDate);
     var DS = cmd.Execute();
     DS.MoveNext();
     Sum = IIF(DS.Count > 0, DS.Sum, 0);
     return DS.Count;
  END;

  PRIVATE MACRO БалансоваяСтоимостьБезНКДСВычетомРезервов(rs)
    if( rs.AmortCalcKind <= 1/*AMORTCALCKIND_LM*/ )
      var BalanceCost = rs.BalanceCost,
          NKDAmount = rs.NKDAmount,
          InterestIncome = rs.InterestIncome;
      DV_SmartConvertSum_CB(BalanceCost, BalanceCost, rs.FaceValueFI);
      DV_SmartConvertSum_CB(NKDAmount, NKDAmount, rs.FaceValueFI);
      DV_SmartConvertSum_CB(InterestIncome, InterestIncome, rs.FaceValueFI);

      return (BalanceCost - NKDAmount - InterestIncome) - rs.ReservAmount;
    elif(rs.AmortCalcKind == 2/*AMORTCALCKIND_EPS*/)
      var AmortCost = rs.AmortCost;
      DV_SmartConvertSum_CB(AmortCost, AmortCost, rs.FaceValueFI);

      return AmortCost - rs.ReservAmount;
    else
      return 0;
    end;
  END;

  PRIVATE MACRO СуммаНачисленногоДисконтногоДохода(Scviд, Pri, Rnew_ддi);
    return (Scviд - Pri - Rnew_ддi);
  END;

  PRIVATE MACRO СуммаКупонногоДоходаИЧП(rs, A_Sum, Rnew_бi, PcRate)
    var S = $0.0, Rnew_пдj = $0, SumRnew_пдj = $0, Svi = $0;
    var FiWarntsSelect, FiWarntsData, IntervalNum, IncomeRate = 100, PrevRnew_пдj = $0;
    /*по предстоящим выплатам*/
    FiWarntsSelect = DL_RSDCommand("select t.* "
                                  +"  from dfiwarnts_dbt t "
                                  +" where t.t_FIID = ? "
                                  +"   and t.t_DrawingDate > ? "
                                  +" order by t.t_IsPartial, t.t_IncomeRate"
                                  );
    
    FiWarntsSelect.AddParam(rs.FIID);
    FiWarntsSelect.AddParam(RepDate());
    FiWarntsData = FiWarntsSelect.execute();
    
    while( FiWarntsData.MoveNext() )
        if( sql_ConvTypeDate(FiWarntsData.DrawingDate) <= RepDate() )
           IntervalNum = P3; // !?
        else
           IntervalNum = GetNumInterval(sql_ConvTypeDate(FiWarntsData.DrawingDate) - RepDate());
        end;
       
        if (FiWarntsData.IsPartial == "X")
           S = rs.FaceValue * FiWarntsData.IncomeRate/MAX( 1, FiWarntsData.IncomeScale)/100.0;
           if( IncomeRate == FiWarntsData.IncomeRate/MAX( 1, FiWarntsData.IncomeScale) )
              Rnew_пдj = Rnew_бi - SumRnew_пдj;/*погрешность относим на самый большой процент*/
           else
              Rnew_пдj = Rnew_бi * FiWarntsData.IncomeRate/MAX( 1, FiWarntsData.IncomeScale)/100.0;
           end;
           SumRnew_пдj = SumRnew_пдj + Rnew_пдj;
           IncomeRate = IncomeRate - FiWarntsData.IncomeRate/MAX( 1, FiWarntsData.IncomeScale);
           Svi = rs.Amount * S - Rnew_пдj;
        else
           S = СуммаКупона(FiWarntsData.FIID, 1, SQL_ConvTypeDate(FiWarntsData.DrawingDate) );
           Rnew_пдj = S * PcRate / 100;
           Svi = rs.Amount * (S - Rnew_пдj);
        end;
        DV_SmartConvertSum_CB(Svi, Svi, rs.FaceValueFI);
       
        A_Sum[IntervalNum] = A_Sum[IntervalNum] + Svi;
    end;

  END;

  /*1.4 Вложения в долговые обязательства (по облигациям)*/
  /*1.5 Вложения в долевые ценные бумаги (все долевые ц/б: акции, паи, расписки)*/
  
  PRIVATE MACRO Строка_1_4_или_1_5( ObjReport:OBJECT, StrNum )
     var fin = TRecHandler("fininstr.dbt");
     var RowNum = 0, IntervalNum,
     Svi = $0, Pri = $0, Scvi = $0, Rnew_бi = $0, PrevFIID = -1, Nominal = 0,
     cmd, rs, Query = sqlОтборЛотов_1_4_или_1_5( StrNum ), Rдд = $0, PcRate = 0.0,
     A_Sum = TArray(),
     Progress = TProgressBar,
     NRec:integer = 0,
     Is3QualCat;

     if( not m_ForReporting )
        NRec = SQL_GetNRecs(Query);
        if( not IsPrintItogStr[StrNum] )
           ObjReport.PrintItogStr(StrNum);
           IsPrintItogStr[StrNum] = true;
        end;
     else
        NRec = 1;
     end;

     if( NRec > 0 )
        if( not m_ForReporting )
           Progress.Init(NRec, "", "Обработка лотов для строки " + Dep_Num[StrNum] + " по состоянию на " + RepDateNa());
        end;

        cmd = RSDCommand(Query);
        cmd.NullConversion = true;
        rs = TRsbDataSet(cmd);

        getRegistryValue("COMMON\\ПЕРЕМЕННЫЕ\\ДОХОДЫ 3Й КАТЕГОРИИ КАЧЕСТВА", V_BOOL, Is3QualCat, null);
        while( rs.MoveNext() )
           InitA_Sum(A_Sum);

           if( ((rs.AvrKindsRoot == AVOIRISSKIND_BOND) and (rs.AvrRiskGroup > 0)) or // облигации для которых установлено значение категории <Расчет РР. Группа риска>
               ((rs.AvrKindsRoot != AVOIRISSKIND_BOND) and (rs.IsCoupon == 0)) or // 2. Долевые ценные бумаги, за исключением привилегированных акций с заполненным списком погашения дивидендов
               ((rs.QualCat == 4) or (rs.QualCat == 5) or ((rs.QualCat == 3) and (not Is3QualCat)))
           )
              IntervalNum = P16;
           else
              if( sql_ConvTypeDate(rs.DrawingDate) <= RepDate() )
                 IntervalNum = P3; // !?
              else
                 IntervalNum = GetNumInterval(sql_ConvTypeDate(rs.DrawingDate) - RepDate());
              end;
           end;

           if( PrevFIID != rs.FIID )
              Nominal = GetFaceValue(rs.FIID, RepDate());
              PcRate = 0.0;
              if( (rs.AvrKindsRoot == AVOIRISSKIND_BOND) and (rs.IsCoupon > 0) )
                 fin.rec.fiid = rs.FIID;
                 PcRate = double(readNoteForObject( OBJTYPE_AVOIRISS, UniID( fin, OBJTYPE_AVOIRISS), NOTEKIND_RSK_PERCENT, RepDate() ));
                 if( PcRate <= 0 )
                     msgbox("Для ц/б с FIID = " + rs.FIID + " не задано примечание \"" + ИмяПримечания( OBJTYPE_AVOIRISS, NOTEKIND_RSK_PERCENT )+ "\" на дату " + string(RepDateNA()));
                     PcRate = 0.0;
                 else
                     PcRate = double(PcRate);
                 end;
              end;
              PrevFIID = rs.FIID;
           end;

           Scvi = $0;
           if( rs.AvrKindsRoot == AVOIRISSKIND_BOND )
              // Scvi = сумма ПД + ДД, не только проценты. (t_interestincome + t_discountincome), конв. из ВН в рубли
              Scvi = rs.DiscountIncome;
              if( NOT DV_SmartConvertSum_CB(Scvi, Scvi, rs.FaceValueFI) )
                 if( not m_ForReporting )
                    Progress.Use;
                 end;
                 continue;
              end;
           end;

           // Rnew_бi = это просто резерв с лота (t_reservAmount). Конвертить не надо, это уже рубли
           Rnew_бi = rs.ReservAmount;

           // Pri = можно пока оставить, но мне кажется что слагаемое лишнее. T_Bonus, конв. из ВН в рубли
           Pri = rs.Bonus;
           if( NOT DV_SmartConvertSum_CB(Pri, Pri, rs.FaceValueFI) )
              if( not m_ForReporting )
                 Progress.Use;
              end;
              continue;
           end;

           //Svi = Vi + Pri + Scvi - Rnew_бi;

           if( rs.AvrKindsRoot == AVOIRISSKIND_BOND )

              if( (rs.IsCoupon == 0) and (rs.IsPartial == 0) )
                 A_Sum[IntervalNum] = A_Sum[IntervalNum] + БалансоваяСтоимостьБезНКДСВычетомРезервов(rs);
              else
                 if((rs.IsCoupon > 0) and (rs.IsPartial == 0))
                    A_Sum[IntervalNum] = A_Sum[IntervalNum] + БалансоваяСтоимостьБезНКДСВычетомРезервов(rs);
                 end;
                 СуммаКупонногоДоходаИЧП(rs, A_Sum, Rnew_бi, PcRate);
              end;

              Rдд = $0;
              if( rs.DiscountIncome > 0 )
                 Rдд = round(rs.DiscountIncome * rs.IncomeReserv / (rs.InterestIncome + rs.DiscountIncome),2);
              end;
              A_Sum[IntervalNum] = A_Sum[IntervalNum] + СуммаНачисленногоДисконтногоДохода(Scvi, Pri, Rдд);
             
           elif(rs.AvrKindsRoot == AVOIRISSKIND_SHARE)
               A_Sum[IntervalNum] = A_Sum[IntervalNum] + БалансоваяСтоимостьБезНКДСВычетомРезервов(rs);
           end;

           var QueryContractor =  "select (case when RSB_SECUR.IsExchange(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1 and tick.t_PartyID = -1 " +
                                  "             then tick.t_MarketID " +
                                  "             else tick.t_PartyID "
                                  "        end) t_ContractorID " +
                                  " from ddl_tick_dbt tick" +
                                  " where tick.t_DealID = ?";

           var SelectContractor = DL_RSDCommand(QueryContractor);
           SelectContractor.addParam(rs.DealID);
           var DSContractor = SelectContractor.execute();

           while(DSContractor.MoveNext())
              if( not m_ForReporting )
                 ObjReport.Print(rs.DealCode, DSContractor.ContractorID, A_Sum);
              end;
           end;

           PutInItog(StrNum, A_Sum);
           RowNum = RowNum + 1;

           m_IsExistsData = true;

           if( not m_ForReporting )
              Progress.Use;
           end;
        end;
        
        if( not m_ForReporting )
           Progress.Remove;
        end;
     end;

     return RowNum;
  END;

  PRIVATE MACRO Строка_1_6_или_4_4(StrNum, ObjReport)
    var A_Sum = TArray();

    InitA_Sum(A_Sum);
    var Count = GetValOfLine_1_6_or_4_4(IIF(StrNum == _1_6_, "+ПФИ", "-ПФИ"), m_RepDate, @A_Sum[P16]);
    PutInItog(StrNum, A_Sum);
    return Count;
  END;

  PRIVATE MACRO Строка_1_3_x_x( StrNum:INTEGER )
      var query = "", cmd = null, ds = null, fd = null, progBar = TProgressBar(), RowNum = 0,
          IntervalNum = 0, НадежностьКатегории = false, КатегКачества = -1, ПроцРезерва = -1.0, ResLnkID = -1,
          BuyDate = ZeroDate, BuyID = 0, BuySum = $0, BuyFI = ALLFININSTR, ВалУч = ALLFININSTR,
          prccontract = TRecHandler("prccontract.dbt"), p = 0, Svi = $0, Vi = $0, Pri = $0, Rnew_бi = $0, Scvi = $0, Cri = $0,
          A_Sum = TArray(), Err = 0, ErrMsg = "";

      query = " WITH last_mcacc AS (SELECT "
                                    + " mcacc.t_DocID "
                                   + " ,mcacc.t_ActivateDate "
                                   + " ,mcacc.t_Chapter "
                                   + " ,mcacc.t_Account "
                                   + " ,mcacc.t_Currency "
                                + " FROM "
                                    + " dmcaccdoc_dbt mcacc "
                                + " WHERE "
                                    + " mcacc.t_CatNum = 462 " // КУ "Учтенные векселя"
                                + " AND mcacc.t_DocKind = " + DL_VSBANNER + " "
                                + " ORDER BY "
                                    + " mcacc.t_DocID ASC "
                                   + " ,mcacc.t_ActivateDate DESC) "
            + " SELECT "
                + " bnr.t_BCID "
            + " FROM "
                + " dvsbanner_dbt bnr "
            + " WHERE "
                + " RSB_BILL.GetVABnrStatusOnDate(bnr.t_BCID, " + GetSQLDate(RepDate()) + ") = " + VABANNER_STATUS_ACCOUNT + " "
            + " AND RSB_BILL.GetVABnrClientContrIDOnDate(bnr.t_BCID, " + GetSQLDate(RepDate()) + ") = 0 "
            + " AND EXISTS (SELECT "
                            + " 1 "
                        + " FROM "
                            + " last_mcacc "
                           + " ,daccount_dbt acc "
                        + " WHERE "
                            + " last_mcacc.t_DocID = bnr.t_BCID "
                        + " AND last_mcacc.t_ActivateDate <= RSB_BILL.GetVABnrLastBalanceDate(bnr.t_BCID, " + GetSQLDate(RepDate()) + ") "
                        + " AND ROWNUM = 1 "
                        + " AND acc.t_Chapter = last_mcacc.t_Chapter "
                        + " AND acc.t_Account = last_mcacc.t_Account "
                        + " AND acc.t_Code_Currency = last_mcacc.t_Currency ";

      if(StrNum == _1_3_1_)
          query = query +
                          " AND (bnr.t_BCFormKind = " + VSBANNER_FORMKIND_SIMPLE + " "
                         + " AND REGEXP_LIKE(acc.t_Balance, '51(2|3|5)1(3|5)') )"; //Банк 
      elif(StrNum == _1_3_2_)
          query = query +
                          " AND (bnr.t_BCFormKind = " + VSBANNER_FORMKIND_SIMPLE + " "
                         + " AND (REGEXP_LIKE(acc.t_Balance, '51(2|3|5)1(1|2|5)') "
                           + " OR REGEXP_LIKE(acc.t_Balance, '51(2|3|5)1(4|6)') " //Органы власти или прочий, но юрик
                          + " AND EXISTS (SELECT "
                                          + " 1 "
                                      + " FROM "
                                          + " dparty_dbt pt "
                                      + " WHERE "
                                          + " pt.t_PartyID = bnr.t_Issuer "
                                      + " AND pt.t_LegalForm = " + PTLEGF_INST + ")) )";
      elif(StrNum == _1_3_3_)
          query = query +
                          " AND (bnr.t_BCFormKind = " + VSBANNER_FORMKIND_SIMPLE + " "
                         + " AND REGEXP_LIKE(acc.t_Balance, '51(2|3|5)1(4|6)') " // Прочий, но физик
                          + " AND EXISTS (SELECT "
                                          + " 1 "
                                      + " FROM "
                                          + " dparty_dbt pt "
                                      + " WHERE "
                                          + " pt.t_PartyID = bnr.t_Issuer "
                                      + " AND pt.t_LegalForm = " + PTLEGF_PERSN + ")) ";
      end;

      query = query +
                          " ) ";

      cmd = RSDCommand(query);
      cmd.NullConversion = true;

      ds = TRsbDataSet(cmd);

      progBar.Init(SQL_GetNRecs(query), "", "Обработка сертификатов для строки " + Dep_Num[StrNum] + " по состоянию на " + RepDateNa());

      while(ds.MoveNext())
          Vi = $0;
          Pri = $0;
          Scvi = $0;
          Rnew_бi = $0;
          Svi = $0;
          InitA_Sum(A_Sum);

          fd = VSBannerFD(DL_VSBANNER, ds.BCID);
          ВалУч = fd.ОпределитьВалютуУчета();

          ОпределитьНадежностьКатегорииКачества(fd, RepDate(), @НадежностьКатегории);
          if(НадежностьКатегории)
              СрокДоПогашения(fd.GetBnr(), fd.GetLeg(), RepDate(), @p);
              IntervalNum = GetNumInterval(p);
          else
              IntervalNum = P16;
          end;

          if(VA_GetBalanceDate(ds.BCID, RepDate(), @BuyDate, @BuyID, @BuySum, @BuyFI))
              Vi = round(VA_Convert(BuySum, RepDate(), BuyFI, ВалУч), 2);
          end;

          if(ВексельПроцентный(fd.GetLeg()))
              if(not НайтиСчетПроцВекселя(prccontract, ds.BCID, NULL, VS_FINDPC_ACTUAL))
                  MsgBox("Не найден процентный договор для ц/б " + fd.GetBnr().rec.BCSeries + " №" + trim(fd.GetBnr().rec.BCNumber) );
              else
                  if(ПроцентыКНачислениюПоПДВекселя(prccontract.rec.ContractID, prccontract.rec.EndDate, Scvi))
                      Scvi = Scvi + ПолучитьСуммуПДД(ds.BCID, VA_GetLastAccountedEnrolmentID(ds.BCID), FIROLE_PERCENT, prccontract.rec.EndDate);
                      Scvi = round(VA_Convert(Scvi, RepDate(), fd.GetLeg().rec.PFI, ВалУч), 2);
                  end;
              end;
          end;

          if(УВ_НачислятьПремию() and НачальнаяПремияПоВекселю(ds.BCID, RepDate()))
              Pri = ПолучитьОстатокПремииНаДатуВУ(ds.BCID, RepDate());
          end;

          if(CalcAndCheckReserveParams(fd.GetBnr().rec, RepDate(), @КатегКачества, VARES_SUBKIND_AVR, @ПроцРезерва, @ResLnkID, @ErrMsg) != 0)
              if(ErrMsg != "")
                  MsgBox(ErrMsg);
              else
                  MsgBox("Ошибка определения категории качества и процента резерва для ц/б " + fd.GetBnr().rec.BCSeries + " №" + trim(fd.GetBnr().rec.BCNumber));
              end;
          else
              if(not VA_CalcNewReserve(fd.GetBnr().rec, RepDate(), ПроцРезерва, VARES_SUBKIND_AVR, @Rnew_бi, @ErrMsg))
                  if(ErrMsg != "")
                      MsgBox(ErrMsg);
                  else
                      MsgBox("Ошибка расчета резерва для ц/б " + fd.GetBnr().rec.BCSeries + " №" + trim(fd.GetBnr().rec.BCNumber));
                  end;
              else
                  Rnew_бi = round(VA_Convert(Rnew_бi, RepDate(), NATCUR, ВалУч), 2);
              end;
          end;

          Cri = ПолучитьКорректировкуПДДПоЭПСВУ(ds.BCID, NULL, RepDate(), "N");

          Svi = Vi + Pri + Scvi - Rnew_бi + Cri;
          A_Sum[IntervalNum] = Svi;
          PutInItog(StrNum, A_Sum);
          PutInItog(_1_3_, A_Sum);

          m_IsExistsData = true;

          RowNum = RowNum + 1;
          progBar.Use();
      end;
      progBar.Remove();

      return RowNum;
  END;

  PRIVATE MACRO Строка_1_3_x_x_Secur( StrNum:INTEGER )
    var RowNum = 0;
    var query, cmd, DataSet;
    var A_Sum = TArray();
    var IntervalNum = 0;
    var cnt = 0;
    var progBar = TProgressBar();
      
    cmd = DL_RSDCommand();

    query =   " select (CASE WHEN rq2.t_FactDate <> "+GetSQLDate(date(0,0,0))+" THEN rq2.t_FactDate ELSE rq2.t_PlanDate END) as Date2Part, "
            + "        RSB_FIInstr.ConvSum(RSI_DLRQ.GetRQAmountOnDate(rq2.t_ID, ?/*1*/), rq2.t_FIID, "+NATCUR+", ? /*2*/) as Sum2Part, "
            + "        NVL((select RSB_FIInstr.ConvSum(RSI_DLRQ.GetRQAmountOnDate(rqinc.t_ID, ?/*3*/), rqinc.t_FIID, "+NATCUR+", ? /*4*/) * (CASE WHEN rqinc.t_Kind = rq2.t_Kind THEN 1 ELSE -1 END) "
            + "               from ddlrq_dbt rqinc "
            + "              where rqinc.t_DocKind = tk.t_BOfficeKind "
            + "                and rqinc.t_DocID = tk.t_DealID "
            + "                and rqinc.t_Type = " + DLRQ_TYPE_INCREPO
            + "            ), 0) as SumPerc, "
            + "        NVL((select ABS(rsb_account.RestAC(acd.t_account, acd.t_currency, ? /*5*/, acd.t_chapter, 0))"
            + "               from dmcaccdoc_dbt acd "
            + "              where acd.t_DocKind = " + DL_SECURLEG
            + "                and acd.t_DocID IN (leg1.t_ID, leg2.t_ID) "
            + "                and acd.t_CatNum = 1436 /*+Корр, ОРепо*/ "
            + "                and acd.t_ActivateDate <= ? /*6*/ "
            + "                and (acd.t_DisablingDate = "+GetSQLDate(date(0,0,0))+" or acd.t_DisablingDate >= ? /*7*/)"
            + "                and ROWNUM = 1 "
            + "            ), 0) as PlusCorr, "
            + "        NVL((select ABS(rsb_account.RestAC(acd.t_account, acd.t_currency, ? /*8*/, acd.t_chapter, 0))"
            + "               from dmcaccdoc_dbt acd "
            + "              where acd.t_DocKind = " + DL_SECURLEG
            + "                and acd.t_DocID IN (leg1.t_ID, leg2.t_ID) "
            + "                and acd.t_CatNum = 1437 /*-Корр, ОРепо*/ "
            + "                and acd.t_ActivateDate <= ? /*9*/ "
            + "                and (acd.t_DisablingDate = "+GetSQLDate(date(0,0,0))+" or acd.t_DisablingDate >= ? /*10*/)"
            + "                and ROWNUM = 1"
            + "            ), 0) as MinusCorr, "
            + "        NVL((select ABS(rsb_account.RestAC(acd.t_account, acd.t_currency, ? /*11*/, acd.t_chapter, 0))"
            + "               from dmcaccdoc_dbt acd, dmccateg_dbt cat, dmctempl_dbt tpl "
            + "              where acd.t_DocKind = " + DL_SECURLEG
            + "                and acd.t_DocID IN (leg1.t_ID, leg2.t_ID) "
            + "                and acd.t_CatNum = 242 /*Резерв, договор*/ "
            + "                and acd.t_ActivateDate <= ? /*12*/ "
            + "                and (acd.t_DisablingDate = "+GetSQLDate(date(0,0,0))+" or acd.t_DisablingDate >= ? /*13*/) "
            + "                and cat.t_ID = acd.t_CatID "
            + "                and tpl.t_CatID = acd.t_CatID "
            + "                and tpl.t_Number = acd.t_TemplNum "
            + "                and 1 = (CASE WHEN cat.t_Class1 = "+LLCLASS_KINDRESERV_CONTR+" AND tpl.t_Value1 = "+KINDRES_REPO+" THEN 1 "
            + "                              WHEN cat.t_Class2 = "+LLCLASS_KINDRESERV_CONTR+" AND tpl.t_Value2 = "+KINDRES_REPO+" THEN 1 "
            + "                              WHEN cat.t_Class3 = "+LLCLASS_KINDRESERV_CONTR+" AND tpl.t_Value3 = "+KINDRES_REPO+" THEN 1 "
            + "                              WHEN cat.t_Class4 = "+LLCLASS_KINDRESERV_CONTR+" AND tpl.t_Value4 = "+KINDRES_REPO+" THEN 1 "
            + "                              WHEN cat.t_Class5 = "+LLCLASS_KINDRESERV_CONTR+" AND tpl.t_Value5 = "+KINDRES_REPO+" THEN 1 "
            + "                              WHEN cat.t_Class6 = "+LLCLASS_KINDRESERV_CONTR+" AND tpl.t_Value6 = "+KINDRES_REPO+" THEN 1 "
            + "                              WHEN cat.t_Class7 = "+LLCLASS_KINDRESERV_CONTR+" AND tpl.t_Value7 = "+KINDRES_REPO+" THEN 1 "
            + "                              WHEN cat.t_Class8 = "+LLCLASS_KINDRESERV_CONTR+" AND tpl.t_Value8 = "+KINDRES_REPO+" THEN 1 "
            + "                              ELSE 0 "
            + "                         END) "
            + "                and ROWNUM = 1 "
            + "            ), 0) as ResDeal, "
            + "        NVL((select ABS(rsb_account.RestAC(acd.t_account, acd.t_currency, ? /*14*/, acd.t_chapter, 0))"
            + "               from dmcaccdoc_dbt acd, dmccateg_dbt cat, dmctempl_dbt tpl "
            + "              where acd.t_DocKind = " + DL_SECURLEG
            + "                and acd.t_DocID IN (leg1.t_ID, leg2.t_ID) "
            + "                and acd.t_CatNum = 242 /*Резерв, договор*/ "
            + "                and acd.t_ActivateDate <= ? /*15*/ "
            + "                and (acd.t_DisablingDate = "+GetSQLDate(date(0,0,0))+" or acd.t_DisablingDate >= ? /*16*/) "
            + "                and cat.t_ID = acd.t_CatID "
            + "                and tpl.t_CatID = acd.t_CatID "
            + "                and tpl.t_Number = acd.t_TemplNum "
            + "                and 1 = (CASE WHEN cat.t_Class1 = "+LLCLASS_KINDRESERV_CONTR+" AND tpl.t_Value1 = "+KINDRES_RPOR+" THEN 1 "
            + "                              WHEN cat.t_Class2 = "+LLCLASS_KINDRESERV_CONTR+" AND tpl.t_Value2 = "+KINDRES_RPOR+" THEN 1 "
            + "                              WHEN cat.t_Class3 = "+LLCLASS_KINDRESERV_CONTR+" AND tpl.t_Value3 = "+KINDRES_RPOR+" THEN 1 "
            + "                              WHEN cat.t_Class4 = "+LLCLASS_KINDRESERV_CONTR+" AND tpl.t_Value4 = "+KINDRES_RPOR+" THEN 1 "
            + "                              WHEN cat.t_Class5 = "+LLCLASS_KINDRESERV_CONTR+" AND tpl.t_Value5 = "+KINDRES_RPOR+" THEN 1 "
            + "                              WHEN cat.t_Class6 = "+LLCLASS_KINDRESERV_CONTR+" AND tpl.t_Value6 = "+KINDRES_RPOR+" THEN 1 "
            + "                              WHEN cat.t_Class7 = "+LLCLASS_KINDRESERV_CONTR+" AND tpl.t_Value7 = "+KINDRES_RPOR+" THEN 1 "
            + "                              WHEN cat.t_Class8 = "+LLCLASS_KINDRESERV_CONTR+" AND tpl.t_Value8 = "+KINDRES_RPOR+" THEN 1 "
            + "                              ELSE 0 "
            + "                         END) "
            + "                and ROWNUM = 1 "
            + "            ), 0) as ResPerc "
            + "   from ddl_tick_dbt tk, ddl_leg_dbt leg1, ddl_leg_dbt leg2, ddlrq_dbt rq1, ddlrq_dbt rq2 "
            + "  where tk.t_BOfficeKind = " + DL_SECURITYDOC
            + "    and Rsb_Secur.IsRepo(Rsb_Secur.get_OperationGroupDocKind(Rsb_Secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind), tk.t_BofficeKind)) > 0 "
            + "    and Rsb_Secur.IsBuy(Rsb_Secur.get_OperationGroupDocKind(Rsb_Secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind), tk.t_BofficeKind)) > 0 "
            + "    and tk.t_ClientID = -1 "
            + "    and leg1.t_DealID = tk.t_DealID "
            + "    and leg1.t_LegKind = " + LEG_KIND_DL_TICK
            + "    and leg1.t_LegID = 0 "
            + "    and leg2.t_DealID = tk.t_DealID "
            + "    and leg2.t_LegKind = " + LEG_KIND_DL_TICK_BACK
            + "    and leg2.t_LegID = 0 "
            + "    and rq1.t_DocKind = tk.t_BOfficeKind "
            + "    and rq1.t_DocID = tk.t_DealID "
            + "    and rq1.t_Type = " + DLRQ_TYPE_PAYMENT
            + "    and rq1.t_DealPart = 1 "
            + "    and rq1.t_FactDate <> " + GetSQLDate(date(0,0,0))
            + "    and rq1.t_FactDate <= ? /*17*/ "
            + "    and rq2.t_DocKind = tk.t_BOfficeKind "
            + "    and rq2.t_DocID = tk.t_DealID "
            + "    and rq2.t_Type = " + DLRQ_TYPE_PAYMENT
            + "    and rq2.t_DealPart = 2 " 
            + "    and ? /*18*/ <= (CASE WHEN rq2.t_FactDate <> "+GetSQLDate(date(0,0,0))+" THEN rq2.t_FactDate ELSE rq2.t_PlanDate END) "
            + "    and Exists(select 1 "
            + "                 from dmcaccdoc_dbt accdoc, dmccateg_dbt cat, dmctempl_dbt tpl "
            + "                where accdoc.t_CatNum IN (603 /*+ОД*/, 1239 /*+ОД, Корзина*/) "
            + "                  and accdoc.t_DocKind = " + DL_SECURLEG
            + "                  and accdoc.t_DocID IN (leg1.t_ID, leg2.t_ID) "
            + "                  and rsb_account.RestAC(accdoc.t_account, accdoc.t_currency, ? /*19*/, accdoc.t_chapter, 0) <> 0 "
            + "                  and cat.t_ID = accdoc.t_CatID "
            + "                  and tpl.t_CatID = accdoc.t_CatID "
            + "                  and tpl.t_Number = accdoc.t_TemplNum ";

    cmd.AddParam(RepDate()); /*1*/
    cmd.AddParam(RepDate()); /*2*/
    cmd.AddParam(RepDate()); /*3*/
    cmd.AddParam(RepDate()); /*4*/
    cmd.AddParam(RepDate()); /*5*/
    cmd.AddParam(RepDate()); /*6*/
    cmd.AddParam(RepDate()); /*7*/
    cmd.AddParam(RepDate()); /*8*/
    cmd.AddParam(RepDate()); /*9*/
    cmd.AddParam(RepDate()); /*10*/
    cmd.AddParam(RepDate()); /*11*/
    cmd.AddParam(RepDate()); /*12*/
    cmd.AddParam(RepDate()); /*13*/
    cmd.AddParam(RepDate()); /*14*/
    cmd.AddParam(RepDate()); /*15*/
    cmd.AddParam(RepDate()); /*16*/
    cmd.AddParam(RepDate()); /*17*/
    cmd.AddParam(RepDate()); /*18*/
    cmd.AddParam(RepDate()); /*19*/

    if(StrNum == _1_3_1_)
      query = query + "          and 1 = (CASE WHEN cat.t_Class1 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value1 IN (1,2,3) THEN 1 "
            + "                                WHEN cat.t_Class2 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value2 IN (1,2,3) THEN 1 "
            + "                                WHEN cat.t_Class3 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value3 IN (1,2,3) THEN 1 "
            + "                                WHEN cat.t_Class4 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value4 IN (1,2,3) THEN 1 "
            + "                                WHEN cat.t_Class5 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value5 IN (1,2,3) THEN 1 "
            + "                                WHEN cat.t_Class6 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value6 IN (1,2,3) THEN 1 "
            + "                                WHEN cat.t_Class7 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value7 IN (1,2,3) THEN 1 "
            + "                                WHEN cat.t_Class8 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value8 IN (1,2,3) THEN 1 "
            + "                                ELSE 0 "
            + "                           END) ";
    elif(StrNum == _1_3_2_)        
      query = query + "          and 1 = (CASE WHEN cat.t_Class1 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value1 NOT IN (1,2,3,8,10,50,51) THEN 1 "
            + "                                WHEN cat.t_Class2 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value2 NOT IN (1,2,3,8,10,50,51) THEN 1 "
            + "                                WHEN cat.t_Class3 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value3 NOT IN (1,2,3,8,10,50,51) THEN 1 "
            + "                                WHEN cat.t_Class4 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value4 NOT IN (1,2,3,8,10,50,51) THEN 1 "
            + "                                WHEN cat.t_Class5 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value5 NOT IN (1,2,3,8,10,50,51) THEN 1 "
            + "                                WHEN cat.t_Class6 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value6 NOT IN (1,2,3,8,10,50,51) THEN 1 "
            + "                                WHEN cat.t_Class7 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value7 NOT IN (1,2,3,8,10,50,51) THEN 1 "
            + "                                WHEN cat.t_Class8 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value8 NOT IN (1,2,3,8,10,50,51) THEN 1 "
            + "                                ELSE 0 "
            + "                           END) ";
    elif(StrNum == _1_3_3_)
      query = query + "          and 1 = (CASE WHEN cat.t_Class1 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value1 IN (8,10,50,51) THEN 1 "
            + "                                WHEN cat.t_Class2 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value2 IN (8,10,50,51) THEN 1 "
            + "                                WHEN cat.t_Class3 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value3 IN (8,10,50,51) THEN 1 "
            + "                                WHEN cat.t_Class4 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value4 IN (8,10,50,51) THEN 1 "
            + "                                WHEN cat.t_Class5 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value5 IN (8,10,50,51) THEN 1 "
            + "                                WHEN cat.t_Class6 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value6 IN (8,10,50,51) THEN 1 "
            + "                                WHEN cat.t_Class7 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value7 IN (8,10,50,51) THEN 1 "
            + "                                WHEN cat.t_Class8 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value8 IN (8,10,50,51) THEN 1 "
            + "                                ELSE 0 "
            + "                           END) ";
    end;

    query = query + "              ) ";

    cnt = cmd.GetCount(query);

    if(cnt > 0)
      progBar.Init(cnt, "", "Обработка ОРЕПО для строки " + Dep_Num[StrNum] + " по состоянию на " + RepDateNa());
      
      DataSet = cmd.Execute(query);
      while(DataSet.moveNext())
        IntervalNum = 0;

        InitA_Sum(A_Sum);

        IntervalNum = GetNumInterval(date(DataSet.Date2Part) - date(RepDate()));

        A_Sum[IntervalNum] = money(DataSet.Sum2Part + DataSet.SumPerc + DataSet.PlusCorr - DataSet.MinusCorr - DataSet.ResDeal - DataSet.ResPerc);
        PutInItog(StrNum, A_Sum);
        PutInItog(_1_3_, A_Sum);

        m_IsExistsData = true;
        
        RowNum = RowNum + 1;
        progBar.Use();
      end;

      progBar.Remove();

    end;
    
    return RowNum;
  END;

  PRIVATE MACRO Строка_4_1_2_или_4_2_Secur( StrNum:INTEGER )
    var RowNum = 0;
    var query, cmd, DataSet;
    var A_Sum = TArray();
    var IntervalNum = 0;
    var cnt = 0;
    var progBar = TProgressBar();
      
    cmd = DL_RSDCommand();

    query =   " select (CASE WHEN rq2.t_FactDate <> "+GetSQLDate(date(0,0,0))+" THEN rq2.t_FactDate ELSE rq2.t_PlanDate END) as Date2Part, "
            + "        RSB_FIInstr.ConvSum(RSI_DLRQ.GetRQAmountOnDate(rq2.t_ID, ?/*1*/), rq2.t_FIID, "+NATCUR+", ? /*2*/) as Sum2Part, "
            + "        NVL((select RSB_FIInstr.ConvSum(RSI_DLRQ.GetRQAmountOnDate(rqinc.t_ID, ?/*3*/), rqinc.t_FIID, "+NATCUR+", ? /*4*/) * (CASE WHEN rqinc.t_Kind = rq2.t_Kind THEN 1 ELSE -1 END) "
            + "               from ddlrq_dbt rqinc "
            + "              where rqinc.t_DocKind = tk.t_BOfficeKind "
            + "                and rqinc.t_DocID = tk.t_DealID "
            + "                and rqinc.t_Type = " + DLRQ_TYPE_INCREPO
            + "            ), 0) as SumPerc, "
            + "        NVL((select ABS(rsb_account.RestAC(acd.t_account, acd.t_currency, ? /*5*/, acd.t_chapter, 0))"
            + "               from dmcaccdoc_dbt acd "
            + "              where acd.t_DocKind = " + DL_SECURLEG
            + "                and acd.t_DocID IN (leg1.t_ID, leg2.t_ID) "
            + "                and acd.t_CatNum = 1436 /*+Корр, ОРепо*/ "
            + "                and acd.t_ActivateDate <= ? /*6*/ "
            + "                and (acd.t_DisablingDate = "+GetSQLDate(date(0,0,0))+" or acd.t_DisablingDate >= ? /*7*/)"
            + "                and ROWNUM = 1 "
            + "            ), 0) as PlusCorr, "
            + "        NVL((select ABS(rsb_account.RestAC(acd.t_account, acd.t_currency, ? /*8*/, acd.t_chapter, 0))"
            + "               from dmcaccdoc_dbt acd "
            + "              where acd.t_DocKind = " + DL_SECURLEG
            + "                and acd.t_DocID IN (leg1.t_ID, leg2.t_ID) "
            + "                and acd.t_CatNum = 1437 /*-Корр, ОРепо*/ "
            + "                and acd.t_ActivateDate <= ? /*9*/ "
            + "                and (acd.t_DisablingDate = "+GetSQLDate(date(0,0,0))+" or acd.t_DisablingDate >= ? /*10*/)"
            + "                and ROWNUM = 1 "
            + "            ), 0) as MinusCorr "
            + "   from ddl_tick_dbt tk, ddl_leg_dbt leg1, ddl_leg_dbt leg2, ddlrq_dbt rq1, ddlrq_dbt rq2 "
            + "  where tk.t_BOfficeKind = " + DL_SECURITYDOC
            + "    and Rsb_Secur.IsRepo(Rsb_Secur.get_OperationGroupDocKind(Rsb_Secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind), tk.t_BofficeKind)) > 0 "
            + "    and Rsb_Secur.IsSale(Rsb_Secur.get_OperationGroupDocKind(Rsb_Secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind), tk.t_BofficeKind)) > 0 "
            + "    and tk.t_ClientID = -1 "
            + "    and leg1.t_DealID = tk.t_DealID "
            + "    and leg1.t_LegKind = " + LEG_KIND_DL_TICK
            + "    and leg1.t_LegID = 0 "
            + "    and leg2.t_DealID = tk.t_DealID "
            + "    and leg2.t_LegKind = " + LEG_KIND_DL_TICK_BACK
            + "    and leg2.t_LegID = 0 "
            + "    and rq1.t_DocKind = tk.t_BOfficeKind "
            + "    and rq1.t_DocID = tk.t_DealID "
            + "    and rq1.t_Type = " + DLRQ_TYPE_PAYMENT
            + "    and rq1.t_DealPart = 1 "
            + "    and rq1.t_FactDate <> " + GetSQLDate(date(0,0,0))
            + "    and rq1.t_FactDate <= ? /*11*/ "
            + "    and rq2.t_DocKind = tk.t_BOfficeKind "
            + "    and rq2.t_DocID = tk.t_DealID "
            + "    and rq2.t_Type = " + DLRQ_TYPE_PAYMENT
            + "    and rq2.t_DealPart = 2 " 
            + "    and ? /*12*/ <= (CASE WHEN rq2.t_FactDate <> "+GetSQLDate(date(0,0,0))+" THEN rq2.t_FactDate ELSE rq2.t_PlanDate END) "
            + "    and Exists(select 1 "
            + "                 from dmcaccdoc_dbt accdoc, dmccateg_dbt cat, dmctempl_dbt tpl "
            + "                where accdoc.t_CatNum IN (602 /*-ОД*/, 1243 /*-ОД, Корзина*/) "
            + "                  and accdoc.t_DocKind = " + DL_SECURLEG
            + "                  and accdoc.t_DocID IN (leg1.t_ID, leg2.t_ID) "
            + "                  and rsb_account.RestAC(accdoc.t_account, accdoc.t_currency, ? /*13*/, accdoc.t_chapter, 0) <> 0 "
            + "                  and cat.t_ID = accdoc.t_CatID "
            + "                  and tpl.t_CatID = accdoc.t_CatID "
            + "                  and tpl.t_Number = accdoc.t_TemplNum ";

    cmd.AddParam(RepDate()); /*1*/
    cmd.AddParam(RepDate()); /*2*/
    cmd.AddParam(RepDate()); /*3*/
    cmd.AddParam(RepDate()); /*4*/
    cmd.AddParam(RepDate()); /*5*/
    cmd.AddParam(RepDate()); /*6*/
    cmd.AddParam(RepDate()); /*7*/
    cmd.AddParam(RepDate()); /*8*/
    cmd.AddParam(RepDate()); /*9*/
    cmd.AddParam(RepDate()); /*10*/
    cmd.AddParam(RepDate()); /*11*/
    cmd.AddParam(RepDate()); /*12*/
    cmd.AddParam(RepDate()); /*13*/

    if(StrNum == _4_1_2_)
      query = query + "          and 1 = (CASE WHEN cat.t_Class1 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value1 IN (1,2,3) THEN 1 "
            + "                                WHEN cat.t_Class2 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value2 IN (1,2,3) THEN 1 "
            + "                                WHEN cat.t_Class3 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value3 IN (1,2,3) THEN 1 "
            + "                                WHEN cat.t_Class4 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value4 IN (1,2,3) THEN 1 "
            + "                                WHEN cat.t_Class5 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value5 IN (1,2,3) THEN 1 "
            + "                                WHEN cat.t_Class6 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value6 IN (1,2,3) THEN 1 "
            + "                                WHEN cat.t_Class7 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value7 IN (1,2,3) THEN 1 "
            + "                                WHEN cat.t_Class8 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value8 IN (1,2,3) THEN 1 "
            + "                                ELSE 0 "
            + "                           END) ";
    elif(StrNum == _4_2_)        
      query = query + "          and 1 = (CASE WHEN cat.t_Class1 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value1 NOT IN (1,2,3) THEN 1 "
            + "                                WHEN cat.t_Class2 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value2 NOT IN (1,2,3) THEN 1 "
            + "                                WHEN cat.t_Class3 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value3 NOT IN (1,2,3) THEN 1 "
            + "                                WHEN cat.t_Class4 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value4 NOT IN (1,2,3) THEN 1 "
            + "                                WHEN cat.t_Class5 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value5 NOT IN (1,2,3) THEN 1 "
            + "                                WHEN cat.t_Class6 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value6 NOT IN (1,2,3) THEN 1 "
            + "                                WHEN cat.t_Class7 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value7 NOT IN (1,2,3) THEN 1 "
            + "                                WHEN cat.t_Class8 = "+LLCLASS_KINDSUBJ_KONTRMM+" AND tpl.t_Value8 NOT IN (1,2,3) THEN 1 "
            + "                                ELSE 0 "
            + "                           END) ";
    end;

    query = query + "              ) ";

    cnt = cmd.GetCount(query);

    if(cnt > 0)
      progBar.Init(cnt, "", "Обработка ПРЕПО для строки " + Dep_Num[StrNum] + " по состоянию на " + RepDateNa());
      
      DataSet = cmd.Execute(query);
      while(DataSet.moveNext())
        IntervalNum = 0;

        InitA_Sum(A_Sum);

        IntervalNum = GetNumInterval(date(DataSet.Date2Part) - date(RepDate()));

        A_Sum[IntervalNum] = money(DataSet.Sum2Part + DataSet.SumPerc - DataSet.PlusCorr + DataSet.MinusCorr);
        PutInItog(StrNum, A_Sum);

        m_IsExistsData = true;
        
        RowNum = RowNum + 1;
        progBar.Use();
      end;

      progBar.Remove();

    end;
    
    return RowNum;
  END;

  PRIVATE MACRO Строка_4_3()
      var query = "", cmd = null, ds = null, fd = null, progBar = TProgressBar(), RowNum = 0,
          IntervalNum = 0, SaleFI = ALLFININSTR, ВалУч = ALLFININSTR, prccontract = TRecHandler("prccontract.dbt"),
          Скн = $0, ОсткБСчПр = $0, p = 0, Svi = $0, Vi = $0, Scvi = $0, Cri = $0, A_Sum = TArray();

      query = " SELECT "
                + " bnr.t_BCID "
            + " FROM "
                + " dvsbanner_dbt bnr "
            + " WHERE "
                + " bnr.t_Issuer IN (SELECT "
                                     + " dp_dep.t_PartyID "
                                 + " FROM "
                                     + " ddp_dep_dbt dp_dep) "
            + " AND (RSB_BILL.GetVSBnrStatusOnDate(bnr.t_BCID, " + GetSQLDate(RepDate()) + ") = " + VSBANNER_STATUS_SENDED + " "
            + " OR RSB_BILL.GetVSBnrStatusOnDate(bnr.t_BCID, " + GetSQLDate(RepDate()) + ") = " + VSBANNER_STATUS_PAWN + ")";

      cmd = RSDCommand(query);
      cmd.NullConversion = true;

      ds = TRsbDataSet(cmd);

      progBar.Init(SQL_GetNRecs(query), "", "Обработка сертификатов для строки " + Dep_Num[_4_3_] + " по состоянию на " + RepDateNa());

      while(ds.MoveNext())
          Vi = $0;
          Scvi = $0;
          Svi = $0;
          InitA_Sum(A_Sum);

          fd = VSBannerFD(DL_VSBANNER, ds.BCID);
          ВалУч = fd.ОпределитьВалютуУчета();

          p = DL_GetBnrPlanRepayDate(fd.GetBnr(), fd.GetLeg()) - RepDate();
          IntervalNum = GetNumInterval(p);

          DL_VS_GetLastBnrSalePrice(ds.BCID, RepDate(), @Vi, @SaleFI);
          if((Vi != $0) and (SaleFI != ALLFININSTR))
              Vi = round(VA_Convert(Vi, RepDate(), SaleFI, ВалУч), 2);
          end;

          if(ВексельПроцентный(fd.GetLeg()))
              if(not НайтиСчетПроцВекселя(prccontract, ds.BCID, null, VS_FINDPC_ACTUAL))
                  MsgBox("Не найден процентный договор для ц/б " + fd.GetBnr().rec.BCSeries + " №" + trim(fd.GetBnr().rec.BCNumber) );
              else
                  if(ПолучитьСуммуКНачисл_В(fd.GetBnr(), fd.GetLeg(), prccontract.rec.EndDate, @Скн, @ОсткБСчПр))
                      Scvi = round(VA_Convert(Скн + ОсткБСчПр, RepDate(), fd.GetLeg().rec.PFI, ВалУч), 2);
                  end;
              end;
          end;

          Cri = ПолучитьКорректировкуПДДПоЭПСВУ(ds.BCID, NULL, RepDate(), "Y");

          Svi = Vi + Scvi + Cri;
          A_Sum[IntervalNum] = Svi;
          PutInItog(_4_3_, A_Sum);

          m_IsExistsData = true;

          RowNum = RowNum + 1;
          progBar.Use();
      end;
      progBar.Remove();

      return RowNum;
  END;

  PRIVATE MACRO PrintDataProtocol( ObjReport:OBJECT )
     /*Учтенные векселя*/
     if( m_ByVA )
        Rows_Num[_1_3_1_] = Строка_1_3_x_x( _1_3_1_ );
        Rows_Num[_1_3_2_] = Строка_1_3_x_x( _1_3_2_ );
        Rows_Num[_1_3_3_] = Строка_1_3_x_x( _1_3_3_ );
     end;

     /*"Бэк-офис ценных бумаг"*/
     if( m_BySecur )
        Rows_Num[_1_3_1_] = Rows_Num[_1_3_1_] + Строка_1_3_x_x_Secur( _1_3_1_ );
        Rows_Num[_1_3_2_] = Rows_Num[_1_3_2_] + Строка_1_3_x_x_Secur( _1_3_2_ );
        Rows_Num[_1_3_3_] = Rows_Num[_1_3_3_] + Строка_1_3_x_x_Secur( _1_3_3_ );
                      
        /*1.4 Вложения в долговые обязательства*/
        Rows_Num[_1_4_] = Строка_1_4_или_1_5( ObjReport, _1_4_ );
        /*1.5 Вложения в долевые ценные бумаги*/
        Rows_Num[_1_5_] = Строка_1_4_или_1_5( ObjReport, _1_5_ );

        /*4.1.2 Межбанковские ссуды, депозиты*/
        Rows_Num[_4_1_2_] = Строка_4_1_2_или_4_2_Secur( _4_1_2_ ); 

        /*4.2 Средства клиентов, не являющихся кредитными организациями, всего, из них:*/
        Rows_Num[_4_2_] = Строка_4_1_2_или_4_2_Secur( _4_2_ );
     end;

     Rows_Num[_1_3_] = Rows_Num[_1_3_1_] + Rows_Num[_1_3_2_] + Rows_Num[_1_3_3_];

     /*по сделкам модуля "ФИССиКО"*/
     if( m_ByFISSKO )
        Rows_Num[_1_6_] = Строка_1_6_или_4_4(_1_6_, ObjReport);
        /*печатаем по биржевым*/
        /*в зависимости от натсройки: отбор по позиции*/ 
        if( УчетПоСделкамПозициям == DV_ACCEXCONTR_POS )
           /*отбор сделок по фьючерсу*/
           Rows_Num[_2_1_ФЬЮЧЕРСЫ] =                           СтрокиОпционФьючерсПоПозиции( ObjReport, DERIVATIVE_FUTURES, ТРЕБОВАНИЯ, _2_1_ФЬЮЧЕРСЫ );
           Rows_Num[_2_1_ФЬЮЧЕРСЫ] = Rows_Num[_2_1_ФЬЮЧЕРСЫ] + СтрокиФорвардОпционВнеБирж(   ObjReport, DV_FORWARD_T3,      ТРЕБОВАНИЯ, _2_1_ФЬЮЧЕРСЫ, true );
        else
           /*отбор сделок по фьючерсу*/
           Rows_Num[_2_1_ФЬЮЧЕРСЫ] =                           СтрокиОпционФьючерсПоСделке( ObjReport, DERIVATIVE_FUTURES, ТРЕБОВАНИЯ, _2_1_ФЬЮЧЕРСЫ );
           Rows_Num[_2_1_ФЬЮЧЕРСЫ] = Rows_Num[_2_1_ФЬЮЧЕРСЫ] + СтрокиФорвардОпционВнеБирж(  ObjReport, DV_FORWARD_T3,      ТРЕБОВАНИЯ, _2_1_ФЬЮЧЕРСЫ, true );
        end;

        Rows_Num[_2_2_ФОРВАРДЫ] =                           СтрокиФорвардОпционВнеБирж( ObjReport, DV_FORWARD,    ТРЕБОВАНИЯ, _2_2_ФОРВАРДЫ );
        Rows_Num[_2_2_ФОРВАРДЫ] = Rows_Num[_2_2_ФОРВАРДЫ] + СтрокиФорвардОпционВнеБирж( ObjReport, DV_FORWARD_T3, ТРЕБОВАНИЯ, _2_2_ФОРВАРДЫ, false );

        Rows_Num[_2_3_ВП_СВОПЫ] = СтрокиСВОП( ObjReport, DV_PCTSWAP, ТРЕБОВАНИЯ,    _2_3_ВП_СВОПЫ );

        Rows_Num[_2_4_П_СВОПЫ] = СтрокиСВОП( ObjReport, DV_PCTSWAP, ТРЕБОВАНИЯ,    _2_4_П_СВОПЫ );

        /*печатаем по биржевым*/
        /*в зависимости от настройки: отбор по позиции*/
        if( УчетПоСделкамПозициям == DV_ACCEXCONTR_POS )
           Rows_Num[_2_5_ОПЦИОНЫ_PUT] = СтрокиОпционФьючерсПоПозиции( ObjReport, DERIVATIVE_OPTION, ТРЕБОВАНИЯ, _2_5_ОПЦИОНЫ_PUT );
        else
           Rows_Num[_2_5_ОПЦИОНЫ_PUT] = СтрокиОпционФьючерсПоСделке( ObjReport, DERIVATIVE_OPTION, ТРЕБОВАНИЯ, _2_5_ОПЦИОНЫ_PUT );
        end;
        /*печатаем по внебиржевым опционам*/
        Rows_Num[_2_5_ОПЦИОНЫ_PUT] = Rows_Num[_2_5_ОПЦИОНЫ_PUT] + СтрокиФорвардОпционВнеБирж( ObjReport, DV_OPTION, ТРЕБОВАНИЯ, _2_5_ОПЦИОНЫ_PUT );

        /*печатаем по биржевым*/
        /*в зависимости от натсройки: отбор по позиции*/
        if( УчетПоСделкамПозициям == DV_ACCEXCONTR_POS )
           Rows_Num[_2_6_ОПЦИОНЫ_CALL] = СтрокиОпционФьючерсПоПозиции( ObjReport, DERIVATIVE_OPTION, ТРЕБОВАНИЯ, _2_6_ОПЦИОНЫ_CALL );
        else
           Rows_Num[_2_6_ОПЦИОНЫ_CALL] = СтрокиОпционФьючерсПоСделке( ObjReport,  DERIVATIVE_OPTION, ТРЕБОВАНИЯ, _2_6_ОПЦИОНЫ_CALL );
        end;
        /*печатаем по внебиржевым опционам*/
        Rows_Num[_2_6_ОПЦИОНЫ_CALL] = Rows_Num[_2_6_ОПЦИОНЫ_CALL] + СтрокиФорвардОпционВнеБирж( ObjReport, DV_OPTION, ТРЕБОВАНИЯ, _2_6_ОПЦИОНЫ_CALL );
        Rows_Num[_4_4_] = Строка_1_6_или_4_4(_4_4_, ObjReport);
     end;

     /*Собственные векселя*/
     if( m_ByVBank )
        Rows_Num[_4_3_] = Строка_4_3();
     end;

     if( m_ByFISSKO )
        /*печатаем по биржевым*/
        /*в зависимости от натсройки: отбор по позиции*/
        if( УчетПоСделкамПозициям == DV_ACCEXCONTR_POS )
           /*отбор сделок по фьючерсу*/
           Rows_Num[_5_1_ФЬЮЧЕРСЫ] =                           СтрокиОпционФьючерсПоПозиции( ObjReport, DERIVATIVE_FUTURES, ОБЯЗАТЕЛЬСТВА, _5_1_ФЬЮЧЕРСЫ );
           Rows_Num[_5_1_ФЬЮЧЕРСЫ] = Rows_Num[_5_1_ФЬЮЧЕРСЫ] + СтрокиФорвардОпционВнеБирж(   ObjReport, DV_FORWARD_T3,      ОБЯЗАТЕЛЬСТВА, _5_1_ФЬЮЧЕРСЫ, true );
        else
           /*отбор сделок по фьючерсу*/
           Rows_Num[_5_1_ФЬЮЧЕРСЫ] =                           СтрокиОпционФьючерсПоСделке( ObjReport, DERIVATIVE_FUTURES, ОБЯЗАТЕЛЬСТВА, _5_1_ФЬЮЧЕРСЫ );
           Rows_Num[_5_1_ФЬЮЧЕРСЫ] = Rows_Num[_5_1_ФЬЮЧЕРСЫ] + СтрокиФорвардОпционВнеБирж(  ObjReport, DV_FORWARD_T3,      ОБЯЗАТЕЛЬСТВА, _5_1_ФЬЮЧЕРСЫ, true );
        end;

        Rows_Num[_5_2_ФОРВАРДЫ] =                           СтрокиФорвардОпционВнеБирж( ObjReport, DV_FORWARD,    ОБЯЗАТЕЛЬСТВА, _5_2_ФОРВАРДЫ );
        Rows_Num[_5_2_ФОРВАРДЫ] = Rows_Num[_5_2_ФОРВАРДЫ] + СтрокиФорвардОпционВнеБирж( ObjReport, DV_FORWARD_T3, ОБЯЗАТЕЛЬСТВА, _5_2_ФОРВАРДЫ, false );

        Rows_Num[_5_3_ВП_СВОПЫ] = СтрокиСВОП( ObjReport, DV_PCTSWAP, ОБЯЗАТЕЛЬСТВА, _5_3_ВП_СВОПЫ );

        Rows_Num[_5_4_П_СВОПЫ] = СтрокиСВОП( ObjReport, DV_PCTSWAP, ОБЯЗАТЕЛЬСТВА, _5_4_П_СВОПЫ );

        /*печатаем по биржевым*/
        /*в зависимости от натсройки: отбор по позиции*/
        if( УчетПоСделкамПозициям == DV_ACCEXCONTR_POS )
           Rows_Num[_5_5_ОПЦИОНЫ_PUT] = СтрокиОпционФьючерсПоПозиции( ObjReport, DERIVATIVE_OPTION, ОБЯЗАТЕЛЬСТВА, _5_5_ОПЦИОНЫ_PUT );
        else
           Rows_Num[_5_5_ОПЦИОНЫ_PUT] = СтрокиОпционФьючерсПоСделке( ObjReport,  DERIVATIVE_OPTION, ОБЯЗАТЕЛЬСТВА, _5_5_ОПЦИОНЫ_PUT );
        end;
        Rows_Num[_5_5_ОПЦИОНЫ_PUT] = Rows_Num[_5_5_ОПЦИОНЫ_PUT] + СтрокиФорвардОпционВнеБирж( ObjReport, DV_OPTION, ОБЯЗАТЕЛЬСТВА, _5_5_ОПЦИОНЫ_PUT );

        /*печатаем по биржевым*/
        /*в зависимости от натсройки: отбор по позиции*/
        if( УчетПоСделкамПозициям == DV_ACCEXCONTR_POS )
           Rows_Num[_5_6_ОПЦИОНЫ_CALL] = СтрокиОпционФьючерсПоПозиции( ObjReport, DERIVATIVE_OPTION, ОБЯЗАТЕЛЬСТВА, _5_6_ОПЦИОНЫ_CALL );
        else
           Rows_Num[_5_6_ОПЦИОНЫ_CALL] = СтрокиОпционФьючерсПоСделке( ObjReport,  DERIVATIVE_OPTION, ОБЯЗАТЕЛЬСТВА, _5_6_ОПЦИОНЫ_CALL );
        end;
        Rows_Num[_5_6_ОПЦИОНЫ_CALL] = Rows_Num[_5_6_ОПЦИОНЫ_CALL] + СтрокиФорвардОпционВнеБирж( ObjReport, DV_OPTION, ОБЯЗАТЕЛЬСТВА, _5_6_ОПЦИОНЫ_CALL );
     end;
  END;

  PRIVATE MACRO PrintProtocol( ObjReport:OBJECT )
     ObjReport.BeginReport();
     PrintDataProtocol(ObjReport);
     ObjReport.EndReport();
     ObjReport.ModifyItogStr();
  END;

  PRIVATE MACRO PrintInfo( ObjReport:OBJECT )
     ObjReport.BeginReport();
     ObjReport.Print();
     ObjReport.EndReport();
  END;

  MACRO ПечататьПротокол()
      var RegVal = 0, error = 0;
      GetRegistryValue("ПРОИЗВОДНЫЕ ИНСТРУМЕНТЫ\\УЧЕТ БИРЖЕВЫХ КОНТРАКТОВ", V_INTEGER, RegVal, error);
      if(error != 0)
         msgbox("Ошибка при чтении настройки реестра \"ПРОИЗВОДНЫЕ ИНСТРУМЕНТЫ\\УЧЕТ БИРЖЕВЫХ КОНТРАКТОВ\"");
      end;
      return ((УчетПоСделкамПозициям==DV_ACCEXCONTR_DEAL) and (m_ByFISSKO) and (RegVal == 1));/*true - чтобы всегда видеть протокол*/
  END;

  PRIVATE MACRO Create()

     if((m_ByFISSKO == SET_CHAR) or (m_ByVA == SET_CHAR) or (m_ByVBank == SET_CHAR) or (m_BySecur == SET_CHAR))
         m_IsExistsData = false;

         УчетПоСделкамПозициям = УчетБиржевыхКонтрактов();

         InitIsPrintItogStr();
         InitRows_Num();
         InitA_Sum_All();

         PrintProtocol( CProtocol(this) );
         PrintInfo( CInfo(this) );
     else
        MsgBox("Необходимо выбрать хотя бы один из модулей для формирования отчёта");
     end;
  END;

  MACRO КодВалюты():string
     if( m_Currency == -1 )
        return "000";
     end;
     return DL_GetISOCode(m_Currency);
  END;

  macro GetAuditMsg():String
    private MACRO GetFI_Name(fiid)
      var ds, q;

      if (valtype(fiid) != V_UNDEF)
          q = String("select t_name from dfininstr_dbt where t_fiid = ", fiid);
          ds = TRsbDataset(q);
          if (ds.next())
              return ds.t_name;
          end;
      end;

      return "";
    END;
    
    var msg:string = "";
    var rep_date:string = "";
    var curr:string = "Все";
    var deals1:string = "";
    var deals2:string = "";
    var deals3:string = "";
    var deals4:string = "";

    rep_date = m_Form.GetFieldValue(PNFLD_REPRISK_REPDATE);

    if (m_Form.GetFieldValue(PNFLD_REPRISK_CURRENCY_NAME) != -1)
      curr = GetFI_Name(m_Form.GetFieldValue(PNFLD_REPRISK_CURRENCY_NAME));
    end;

    deals1 = IIF(m_Form.GetFieldValue(PNFLD_REPRISK_BYFISSKO) == "X",
                 "Модуля \"ФИСС и КО\"\n",
                 "");

    deals2 = IIF(m_Form.GetFieldValue(PNFLD_REPRISK_BYVA) == "X",
                 "Модуля \"Учтенные векселя\"\n",
                 "");


    deals3 = IIF(m_Form.GetFieldValue(PNFLD_REPRISK_BYVBANK) == "X",
                 "Модуля \"Векселя банка\"\n",
                 "");

    deals4 = IIF(m_Form.GetFieldValue(PNFLD_REPRISK_BYSECUR) == "X",
                 "Модуля \"Бэк-офис ценных бумаг\"\n",
                 "");

    msg = 
    "Отчет:              Сведения о риске процентной ставки (ф. 127)\n\n" +
    "Отчетная дата:      " + rep_date + "\n" +
    "Валюта:             " + curr + "\n" +
    "По сделкам:\n"  +
    deals1 + deals2 + deals3 + deals4 +
    "\n----------------------------------------\n";

    return msg;
  end;

  initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode, POI_MODE );
END;

//класс обертка для отчетности
CLASS (DV_RepRisk_Report) C_f127( pRepDate:date, pCurrency:integer, pDepartment:integer )

  /*конструктор */
  MACRO Construct( pRepDate:date, pCurrency:integer, pDepartment:integer )

     m_ForReporting = true;

     if( pRepDate != NULL )
        m_RepDate = pRepDate;
        m_RepDateNA = pRepDate+1;
     end;
     if( pCurrency != NULL )
        m_Currency = pCurrency;
     end;
     if( pDepartment != NULL )
        m_Department = pDepartment;
     end;

     m_ByFISSKO = "";
     m_ByVA     = "";
     m_ByVBank  = "";
     m_BySecur  = "X";

     InitIsPrintItogStr();
     InitRows_Num();
     InitA_Sum_All();

     PrintDataProtocol(CProtocol(this));
  END;

  initDV_RepRisk_Report(DV_REPRISK_Panel(), "Report_dvreprisk.xls", null, null, null, POI_MODE);
  this.Construct(pRepDate, pCurrency, pDepartment);
END;
/*
//комментарий для отчетности
var f = C_f127(date(31,12,2016), -1, {OperDprt});
println(f.RepDate() + "; " +
        f.КодВалюты() + "; " +
        Dep_Num[_1_4_] + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_4_].(P3)) + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_4_].(P4)) + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_4_].(P5)) + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_4_].(P6)) + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_4_].(P7)) + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_4_].(P8)) + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_4_].(P9)) + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_4_].(P10)) + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_4_].(P11)) + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_4_].(P12)) + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_4_].(P13)) + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_4_].(P14)) + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_4_].(P15)) + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_4_].(P16))
       );
println(f.RepDate() + "; " +
        f.КодВалюты() + "; " +
        Dep_Num[_1_5_] + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_5_].(P3)) + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_5_].(P4)) + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_5_].(P5)) + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_5_].(P6)) + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_5_].(P7)) + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_5_].(P8)) + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_5_].(P9)) + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_5_].(P10)) + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_5_].(P11)) + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_5_].(P12)) + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_5_].(P13)) + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_5_].(P14)) + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_5_].(P15)) + "; " +
        ПеревестиВТысячи(f.A_Sum_All[_1_5_].(P16))
       );
*/
