/*
$Name:         dl_report_ClosedAcc.mac
$Module:       
$Description:  Отчет "Закрытые счетах за период"
*/

IMPORT "DLReport_h.mac", "dl_report_ClosedAcc_Form.mac", "dl_report_log.mac", oralib, "scsrvrepfun.mac";

PRIVATE VAR ReportHeader = 
" ##############################################                                    \n" + 
"                                                                                   \n" +
"                                    Отчет о закрытых счетах (для всех модулей СОФР)\n";

PRIVATE VAR TableHeader = 
"┌────────────────────────────────┬───────────────────────────────────────────┬──────────────────────────────┬────────────────────────────┬───────────────────────────┬───────────────────────────────────────┐\n"+
"│          Номер сделки          │                Вид операции               │    Дата заключения сделки    │    Дата закрытия сделки    │    Номер лицевого счета   │      Причина ошибки при закрытии      │\n"+
"│                                │                                           │                              │                            │                           │                                       │\n"+
"├────────────────────────────────┼───────────────────────────────────────────┼──────────────────────────────┼────────────────────────────┼───────────────────────────┼───────────────────────────────────────┤";

PRIVATE VAR ReportErrors = 
" ##################################################################################\n";

PRIVATE VAR ReportExecutor = 
" ##################################################################################\n";

PRIVATE CONST Id_Sec = "S", Id_DV = "Ю", Id_VA = "N", Id_VS = "Y", Id_MBK = "J";

PRIVATE VAR
  m_BegDate:DATE,
  m_EndDate:DATE,
  m_DepartmentID:INTEGER,
  IsSec:STRING,
  IsDV:STRING,
  IsVA:STRING,
  IsVS:STRING,
  IsMBK:STRING,
  IsApostr:STRING,
  IsExcel:STRING;

PRIVATE VAR Report_ClosedAcc_Form;

PRIVATE MACRO Операционист()
  var RS = TRsbDataSet("SELECT person.t_Name " +
                       "  FROM dperson_dbt person " +
                       " WHERE person.t_Oper = " + string({oper})
                       );

  if( RS.MoveNext() )
    return RS.Name;
  end;
  return "";
END;

PRIVATE CLASS ( DL_CReportTemplate ) DL_Report_ClosedAcc( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI:BOOL )
    VAR ErrorCount;
    Var CurDate = date(), CurTime = time(),
    m_CurrSheetName = "";
    var CurLog = DL_ReportLog(ReportBIQ8582_ClosedAcc, CurDate, CurTime, m_BegDate, m_EndDate);
    
    

    PRIVATE MACRO PrintMode():INTEGER
        if (IsExcel == SET_CHAR)
          return DL_OUTREPORT_EXCEL;
        end;
        return DL_OUTREPORT_STD;
    END;

    PRIVATE MACRO PrintLine(A1, A2, A3, A4, A5, A6)
      ErrorCount = ErrorCount + 1;
      PrintTableLine( "N1_A1",  A1, null,
                      "N1_A2",  A2, null,
                      "N1_A3",  A3, null,
                      "N1_A4",  A4, null,
                      "N1_A5",  A5, null,
                      "N1_A6",  A6, null);
    END;

    PRIVATE MACRO GetDateAndPrint()
      var m_DataQuery_sel = "";
      var m_DataQuery_ins = "";
      var m_DataQuery_exec;
      var m_RS, m_DataQuery, Query;
      var m_RecsOnDate = 0;
      var result = "";
      var CurDateRep = m_BegDate;
      VAR RecordCount = 0;

      execSQL("truncate table DDL_REPORT_CLOSEDACC_TMP");

      m_DataQuery_ins =     "INSERT INTO DDL_REPORT_CLOSEDACC_TMP (T_IDENTPROG, " +
                            "           T_DEALID, " +
                            "           T_DOCKIND, " +
                            "           T_DEALCODE, " +
                            "           T_NAME, " +
                            "           T_DEALDATE, " +
                            "           T_CLOSEDDATE)";
      
      if(IsSec == SET_CHAR)
        m_DataQuery_sel = m_DataQuery_sel +
                            "   SELECT  \'" + Id_Sec + "\', " +
                            "          TICK.T_DEALID, " +
                            "          TICK.T_BOFFICEKIND, " +
                            "          tick.t_dealcode, " +
                            "          oper.t_name, " +
                            "          TICK.T_DEALDATE, " +
                            "          TICK.T_CLOSEDATE " +
                            "     FROM ddl_tick_dbt tick, DOPRKOPER_DBT oper " +
                            "    WHERE     TICK.T_BOFFICEKIND IN ( " + DL_SECURITYDOC + ", " +
                            "                                      " + DL_RETIREMENT + ", " +
                            "                                      " + DL_AVRWRT + ", " +
                            "                                      " + DL_CONVAVR + ", " +
                            "                                      " + DL_INVESTSHARE + ", " +
                            "                                      " + DL_SECUROWN + ", " +
                            "                                      " + DL_AVRWRTOWN + ", " +
                            "                                      " + DL_RETIREMENT_OWN +
                            "                                         ) " +
                            "          AND TICK.T_DEALSTATUS = 20 " +
                            "          AND TICK.T_CLOSEDATE " + IIF(m_BegDate == m_EndDate, " = ? ", "BETWEEN ? AND ? ") +
                            "          AND ( ? > 0 AND TICK.T_DEPARTMENT = ? OR ? < 0 )" +
                            "          AND OPER.T_KIND_OPERATION = TICK.T_DEALTYPE ";
      end;

      if(IsDV == SET_CHAR)
        m_DataQuery_sel = m_DataQuery_sel + IIF (m_DataQuery_sel != "", "   UNION ", "");
        m_DataQuery_sel = m_DataQuery_sel +
                            "   SELECT \'" + Id_DV + "\', " +
                            "          DVN.T_ID, " +
                            "          DVN.T_DOCKIND,"  +
                            "          DVN.T_EXTCODE, " +
                            "          oper.t_name, " +
                            "          DVN.T_DATE, " +
                            "          CASE " +
                            "             WHEN     DVNFI.T_SUPLDATE = TO_DATE ('01/01/0001', 'dd/mm/yyyy') " +
                            "                  AND DVNFI.T_PAYDATE = TO_DATE ('01/01/0001', 'dd/mm/yyyy') " +
                            "             THEN " +
                            "                DVNFI.T_EXECDATE " +
                            "             WHEN     DVNFI.T_EXECDATE >= DVNFI.T_SUPLDATE " +
                            "                  AND DVNFI.T_EXECDATE >= DVNFI.T_PAYDATE " +
                            "             THEN " +
                            "                DVNFI.T_EXECDATE " +
                            "             WHEN DVNFI.T_SUPLDATE >= DVNFI.T_PAYDATE " +
                            "             THEN " +
                            "                DVNFI.T_SUPLDATE " +
                            "             ELSE " +
                            "                DVNFI.T_PAYDATE " +
                            "          END " +
                            "     FROM ddvndeal_dbt dvn, ddvnfi_dbt dvnfi, DOPRKOPER_DBT oper " +
                            "    WHERE     DVN.T_DOCKIND IN (" + DL_DVNDEAL + ", " + DL_DVFXDEAL + ", " + DL_DVDEALT3 + ") " +
                            "          AND DVN.T_STATE = 2 " +
                            "          AND (CASE " +
                            "                  WHEN     DVNFI.T_SUPLDATE = " +
                            "                              TO_DATE ('01/01/0001', 'dd/mm/yyyy') " +
                            "                       AND DVNFI.T_PAYDATE = " +
                            "                              TO_DATE ('01/01/0001', 'dd/mm/yyyy') " +
                            "                  THEN " +
                            "                     DVNFI.T_EXECDATE " +
                            "                  WHEN     DVNFI.T_EXECDATE >= DVNFI.T_SUPLDATE " +
                            "                       AND DVNFI.T_EXECDATE >= DVNFI.T_PAYDATE " +
                            "                  THEN " +
                            "                     DVNFI.T_EXECDATE " +
                            "                  WHEN DVNFI.T_SUPLDATE >= DVNFI.T_PAYDATE " +
                            "                  THEN " +
                            "                     DVNFI.T_SUPLDATE " +
                            "                  ELSE " +
                            "                     DVNFI.T_PAYDATE " +
                            "               END) " + IIF(m_BegDate == m_EndDate, " = ? ", "BETWEEN ? AND ? ") +
                            "          AND ( ? > 0 AND DVN.T_DEPARTMENT = ? OR ? < 0 )" +
                            "          AND OPER.T_KIND_OPERATION = DVN.T_KIND " +
                            "          AND DVNFI.T_DEALID = DVN.T_ID " +
                            "          AND (DVN.T_DVKIND IN (3,4,6) AND DVNFI.T_TYPE = 2 OR DVNFI.T_TYPE >= 0 AND DVN.T_DVKIND NOT IN (3,4,6)) "
                            "   UNION " +
                            "   SELECT \'" + Id_DV + "\', " +
                            "          DV.T_ID, " +
                            "           " + DL_DVDEAL + ", " +
                            "          DV.T_EXTCODE, " +
                            "          oper.t_name, " +
                            "          DV.T_DATE, " +
                            "          TURN.T_DATE " +
                            "     FROM ddvdeal_dbt dv, DDVDLTURN_DBT turn, DOPRKOPER_DBT oper " +
                            "    WHERE     DV.T_STATE = 2 " +
                            "          AND ( ? > 0 AND DV.T_DEPARTMENT = ? OR ? < 0 )" +
                            "          AND TURN.T_DEALID = DV.T_ID " +
                            "          AND TURN.T_DATE " + IIF(m_BegDate == m_EndDate, " = ? ", "BETWEEN ? AND ? ") +
                            "          AND OPER.T_KIND_OPERATION = DV.T_KIND ";
        
      end;

      if(IsVA == SET_CHAR)
        m_DataQuery_sel = m_DataQuery_sel + IIF (m_DataQuery_sel != "", "   UNION ", "");
        m_DataQuery_sel = m_DataQuery_sel +
                            "   SELECT \'" + Id_VA + "\', " +
                            "          TICK.T_DEALID, " +
                            "          TICK.T_BOFFICEKIND, " +
                            "          tick.t_dealcode, " +
                            "          oper.t_name, " +
                            "          TICK.T_DEALDATE, " +
                            "          TICK.T_CLOSEDATE " +
                            "     FROM ddl_tick_dbt tick, DOPRKOPER_DBT oper " +
                            "    WHERE     TICK.T_BOFFICEKIND IN ( " + DL_VEKSELACCOUNTED + ", " +
                            "                                      " + DL_VAREPAY + ", " +
                            "                                      " + DL_VAPAWN + ", " +
                            "                                      " + DL_VAENWR + ") " +
                            "          AND TICK.T_DEALSTATUS = 20 " +
                            "          AND TICK.T_CLOSEDATE " + IIF(m_BegDate == m_EndDate, " = ? ", "BETWEEN ? AND ? ") +
                            "          AND ( ? > 0 AND TICK.T_DEPARTMENT = ? OR ? < 0 )" +
                            "          AND OPER.T_KIND_OPERATION = TICK.T_DEALTYPE ";
      end;

      if(IsVS == SET_CHAR)
        m_DataQuery_sel = m_DataQuery_sel + IIF (m_DataQuery_sel != "", "   UNION ", "");
        m_DataQuery_sel = m_DataQuery_sel +
                            "   SELECT \'" + Id_VS + "\', " +
                            "          ord.T_CONTRACTID, " +
                            "          ord.T_CONTRACTKIND, " +
                            "          ord.T_ORDERNUMBER, " +
                            "          oper.t_name, " +
                            "          ord.T_CREATEDATE, " +
                            "          ord.T_CLOSINGDATE " +
                            "     FROM ddl_order_dbt ord, DOPRKOPER_DBT oper " +
                            "    WHERE     ord.T_DOCKIND IN ( " + DL_VEKSELORDER + ", " +
                            "                                      " + DL_VEKSELDRAWORDER + ", " +
                            "                                      " + DL_VEKSELPAWNORDER + ", " +
                            "                                      " + DL_VSBARTERORDER + ", " +
                            "                                      " + DL_VSSTORAGEORDER + ", " +
                            "                                      " + DL_VSINTERCHANGE + ", " +
                            "                                      " + DL_VSSALE + ") " +
                            "          AND ORD.T_CONTRACTSTATUS = 20 " +
                            "          AND ord.T_CLOSINGDATE " + IIF(m_BegDate == m_EndDate, " = ? ", "BETWEEN ? AND ? ") +
                            "          AND ( ? > 0 AND ord.T_DEPARTMENT = ? OR ? < 0 )" +
                            "          AND OPER.T_KIND_OPERATION = ORD.T_KIND_OPERATION ";

        
      end;

      if(IsMBK == SET_CHAR)
        m_DataQuery_sel = m_DataQuery_sel + IIF (m_DataQuery_sel != "", "   UNION ", "");
        m_DataQuery_sel = m_DataQuery_sel +
                            "   SELECT \'" + Id_MBK + "\', " +
                            "          TICK.T_DEALID, " +
                            "          TICK.T_BOFFICEKIND, " +
                            "          tick.t_dealcode, " +
                            "          oper.t_name, " +
                            "          TICK.T_DEALDATE, " +
                            "          TICK.T_CLOSEDATE " +
                            "     FROM ddl_tick_dbt tick, DOPRKOPER_DBT oper " +
                            "    WHERE     TICK.T_BOFFICEKIND IN (102 /*DL_IBCDOC*/, 208 /*DL_CREDITLN*/) " +
                            "          AND TICK.T_DEALSTATUS = 20 " +
                            "          AND TICK.T_CLOSEDATE " + IIF(m_BegDate == m_EndDate, " = ? ", "BETWEEN ? AND ? ") +
                            "          AND ( ? > 0 AND TICK.T_DEPARTMENT = ? OR ? < 0 )" +
                            "          AND OPER.T_KIND_OPERATION = TICK.T_DEALTYPE ";

      end;
      m_DataQuery_ins = m_DataQuery_ins + m_DataQuery_sel;
      m_DataQuery_exec = RSDCommand(m_DataQuery_ins);
      if (IsSec == SET_CHAR )
        if(m_BegDate == m_EndDate)
          m_DataQuery_exec.AddParam( "", RSDBP_IN, m_BegDate);
        else
          m_DataQuery_exec.AddParam( "", RSDBP_IN, m_BegDate);
          m_DataQuery_exec.AddParam( "", RSDBP_IN, m_EndDate);
        end;
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
      end;

      if (IsDV == SET_CHAR )
      /*dvndeal*/
       if(m_BegDate == m_EndDate)
          m_DataQuery_exec.AddParam( "", RSDBP_IN, m_BegDate);
        else
          m_DataQuery_exec.AddParam( "", RSDBP_IN, m_BegDate);
          m_DataQuery_exec.AddParam( "", RSDBP_IN, m_EndDate);
        end;
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
      /*dvdeal*/
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        if(m_BegDate == m_EndDate)
          m_DataQuery_exec.AddParam( "", RSDBP_IN, m_BegDate);
        else
          m_DataQuery_exec.AddParam( "", RSDBP_IN, m_BegDate);
          m_DataQuery_exec.AddParam( "", RSDBP_IN, m_EndDate);
        end;
      end;

      if (IsVA == SET_CHAR )
        if(m_BegDate == m_EndDate)
          m_DataQuery_exec.AddParam( "", RSDBP_IN, m_BegDate);
        else
          m_DataQuery_exec.AddParam( "", RSDBP_IN, m_BegDate);
          m_DataQuery_exec.AddParam( "", RSDBP_IN, m_EndDate);
        end;
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
      end;

      if (IsVS == SET_CHAR )
        if(m_BegDate == m_EndDate)
          m_DataQuery_exec.AddParam( "", RSDBP_IN, m_BegDate);
        else
          m_DataQuery_exec.AddParam( "", RSDBP_IN, m_BegDate);
          m_DataQuery_exec.AddParam( "", RSDBP_IN, m_EndDate);
        end;
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
      end;

      if (IsMBK == SET_CHAR )
        if(m_BegDate == m_EndDate)
          m_DataQuery_exec.AddParam( "", RSDBP_IN, m_BegDate);
        else
          m_DataQuery_exec.AddParam( "", RSDBP_IN, m_BegDate);
          m_DataQuery_exec.AddParam( "", RSDBP_IN, m_EndDate);
        end;
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
      end;

      m_DataQuery_exec.execute();

      while( CurDateRep <= m_EndDate)
        if( RecordCount == 0 )
          CopyAllSheetInTotalBook( m_CurrSheetName, false, "N1_TableHeader", 0, m_CurrSheetName, true );
          RegisterTable( "N1_TableData", TableHeader,
                         "N1_A1", "N1_A2", "N1_A3", "N1_A4", "N1_A5", "N1_A6");
        end;

        if (IsSec == SET_CHAR )
          m_DataQuery = "SELECT * FROM DDL_REPORT_CLOSEDACC_TMP WHERE T_CLOSEDDATE = " + GetSQLDate(CurDateRep) + " AND T_IDENTPROG = \'" + Id_Sec + "\'";
          m_RecsOnDate = SQL_GetNRecs( m_DataQuery );
          CurLog.AddLogRow("Поиск закрытых сделок за " + ZeroInFirst(CurDateRep, true) + " в модуле \"Бэк-офис ценных бумаг\"", IIF(m_RecsOnDate > 0, "найдены", "не найдено"));
        end;

        if (IsDV == SET_CHAR )
          m_DataQuery = "SELECT * FROM DDL_REPORT_CLOSEDACC_TMP WHERE T_CLOSEDDATE = " + GetSQLDate(CurDateRep) + " AND T_IDENTPROG = \'" + Id_DV + "\'";
          m_RecsOnDate = SQL_GetNRecs( m_DataQuery );
          CurLog.AddLogRow("Поиск закрытых сделок за " + ZeroInFirst(CurDateRep, true) + " в модуле \"ФИССиКО\"", IIF(m_RecsOnDate > 0, "найдены", "не найдено"));
        end;

        if (IsVA == SET_CHAR )
          m_DataQuery = "SELECT * FROM DDL_REPORT_CLOSEDACC_TMP WHERE T_CLOSEDDATE = " + GetSQLDate(CurDateRep) + " AND T_IDENTPROG = \'" + Id_VA + "\'";
          m_RecsOnDate = SQL_GetNRecs( m_DataQuery );
          CurLog.AddLogRow("Поиск закрытых сделок за " + ZeroInFirst(CurDateRep, true) + " в модуле \"Учтенные векселя\"", IIF(m_RecsOnDate > 0, "найдены", "не найдено"));
        end;

        if (IsVS == SET_CHAR )
          m_DataQuery = "SELECT * FROM DDL_REPORT_CLOSEDACC_TMP WHERE T_CLOSEDDATE = " + GetSQLDate(CurDateRep) + " AND T_IDENTPROG = \'" + Id_VS + "\'";
          m_RecsOnDate = SQL_GetNRecs( m_DataQuery );
          CurLog.AddLogRow("Поиск закрытых сделок за " + ZeroInFirst(CurDateRep, true) + " в модуле \"Векселя банка\"", IIF(m_RecsOnDate > 0, "найдены", "не найдено"));
        end;

        if (IsMBK == SET_CHAR )
          m_DataQuery = "SELECT * FROM DDL_REPORT_CLOSEDACC_TMP WHERE T_CLOSEDDATE = " + GetSQLDate(CurDateRep) + " AND T_IDENTPROG = \'" + Id_MBK + "\'";
          m_RecsOnDate = SQL_GetNRecs( m_DataQuery );
          CurLog.AddLogRow("Поиск закрытых сделок за " + ZeroInFirst(CurDateRep, true) + " в модуле \"Межбанк. кредиты\"", IIF(m_RecsOnDate > 0, "найдены", "не найдено"));
        end;

        m_DataQuery = "  SELECT (SELECT COUNT (1) " +
                      "            FROM (SELECT * " +
                      "                    FROM DMCCATEG_DBT " +
                      "                   WHERE T_ATTRMASK = -2147483648) cat, " +
                      "                 dmcaccdoc_dbt accdoc " +
                      "           WHERE     accdoc.t_catid = cat.t_id " +
                      "                 AND ACCDOC.T_ISUSABLE = CHR (88) " +
                      "                 AND ACCDOC.T_CHAPTER IN (1, 4) " +
                      "                 AND ACCDOC.T_DOCID = closed.t_dealid " +
                      "                 AND ACCDOC.T_DOCKIND = closed.t_dockind " +
                      "                 AND ACCDOC.T_ACTIVATEDATE >= closed.T_DEALDATE)    NeedCheck, " +
                      "         closed.* " +
                      "    FROM DDL_REPORT_CLOSEDACC_TMP closed " +
                      "   WHERE closed.T_CLOSEDDATE =  " + GetSQLDate(CurDateRep) +
                      " ORDER BY NeedCheck DESC, closed.T_DEALDATE ";

        m_RS = TRsbDataSet( m_DataQuery );

        while(m_RS.MoveNext())
          if(m_RS.NeedCheck <= 0)
            CurLog.AddLogRow("Поиск открытых под сделку " + m_Rs.DealCode + " счетов", "не найдены");
          else
            var AccQuery =  "  SELECT ACC.T_ACCOUNT, " +
                            "         ABS(RSI_RSB_ACCOUNT.planrestac (ACC.T_ACCOUNT,  ACC.T_CODE_CURRENCY, ?, ACC.T_CHAPTER)) planrest, " +
                            "         ABS(rsb_account.restac (ACC.T_ACCOUNT, ACC.T_CODE_CURRENCY, ?, ACC.T_CHAPTER, ACC.T_CODE_CURRENCY)) actrest " +
                            "    FROM (SELECT * " +
                            "            FROM DMCCATEG_DBT " +
                            "           WHERE T_ATTRMASK = -2147483648) cat, " +
                            "         daccount_dbt acc, " +
                            "         dmcaccdoc_dbt accdoc " +
                            "   WHERE     accdoc.t_catid = cat.t_id " +
                            "         AND ACCDOC.T_ISUSABLE = CHR (88) " +
                            "         AND ACCDOC.T_CHAPTER IN (1,4) " +
                            "         AND ACCDOC.T_DOCID = ? " +
                            "         AND ACCDOC.T_DOCKIND = ? " +
                            "         AND ACCDOC.T_ACTIVATEDATE <= ? " +
                            "         AND ACC.T_ACCOUNT = ACCDOC.T_ACCOUNT " +
                            "         AND ACC.T_CHAPTER = ACCDOC.T_CHAPTER " +
                            "         AND ACC.T_OPEN_DATE >= ? " +
                            "         AND ACC.T_CLOSE_DATE = TO_DATE ('01/01/0001', 'dd/mm/yyyy') " +
                            "ORDER BY ACC.T_ACCOUNT ";
            var Acc_cmd = DL_RSDCommand(AccQuery);  
            Acc_cmd.AddParam(CurDateRep);
            Acc_cmd.AddParam(CurDateRep);
            Acc_cmd.AddParam(m_RS.DealID);
            Acc_cmd.AddParam(m_RS.DocKind);
            Acc_cmd.AddParam(CurDateRep);
            Acc_cmd.AddParam(SQL_ConvTypeDate(m_RS.DealDate));

            var Acc_Rs = Acc_cmd.Execute();
            var IsAccExist = false;
            while (Acc_Rs.MoveNext())
              if(not IsAccExist)
                CurLog.AddLogRow("Поиск открытых под сделку " + m_Rs.DealCode + " счетов", "найдены");
                IsAccExist = true;
              end;
              if (Acc_Rs.actrest > 0)
                PrintLine(m_RS.DealCode, m_RS.Name, SQL_ConvTypeDate(m_RS.DealDate), SQL_ConvTypeDate(m_RS.ClosedDate), Acc_Rs.Account, "Наличие фактического остатка на счете");
              elif (Acc_Rs.planrest > 0)
                PrintLine(m_RS.DealCode, m_RS.Name, SQL_ConvTypeDate(m_RS.DealDate), SQL_ConvTypeDate(m_RS.ClosedDate), Acc_Rs.Account, "Наличие планируемого остатка на счете");
              end;
            end;
            if(not IsAccExist)
              CurLog.AddLogRow("Поиск открытых под сделку " + m_Rs.DealCode + " счетов", "не найдены");
            end;
          end;
        end;
        CurDateRep = CurDateRep + 1;
        UseProgress( RecordCount = RecordCount + 1 );
      end;
    END;

    PRIVATE MACRO BeginReport( NumCopy:INTEGER )
      m_CurrSheetName = "Отчет";

      Dl_CallInsertStat( PrintMode() );

      SetActiveSheet (m_CurrSheetName);
      CreateTotalBook();

    END;

    PRIVATE MACRO Create( NumCopy:INTEGER )
        var m_NRecs = 0;
        ErrorCount = 0;
        m_NRecs = m_EndDate - m_BegDate + 1; /*+1 день, т.к. нам нужно учесть и дату начала отчета*/

        CurLog.BeginLogging();

        PrintFormatString(ReportHeader,
                     "N1_DateTime", " Закрытые счета за период _ " + ZeroInFirst(CurDate, true) + " " + ZeroInFirst(CurTime, false) ,
                     "N1_Period",   "Период проверки с  " + ZeroInFirst(m_BegDate, true) + " по " + ZeroInFirst(m_EndDate, true));
        CopyAllSheetInTotalBook(m_CurrSheetName, false, "N1_Header", 0, m_CurrSheetName);
        InitProgress( m_NRecs, "Идет формирование отчета", "Формирование отчета Закрытые счета за период " + ZeroInFirst(m_BegDate, true) + " - " + ZeroInFirst(m_EndDate, true) );
        GetDateAndPrint();
        CurLog.EndLoggingTable();
        CurLog.EndLogging();
        if ( ErrorCount > 0)
          EndTable();
          CopyAllSheetInTotalBook( m_CurrSheetName, false, GetTableRange(), 0, m_CurrSheetName, true );
          CurLog.ErrorHistoryRec();
        end;
        RemProgress();

        PrintFormatString(ReportErrors,
                     "N1_Error", "Ошибок: " + ErrorCount);
        CopyAllSheetInTotalBook( m_CurrSheetName, false, "N1_Error", 0, m_CurrSheetName, true );
        PrintFormatString(ReportExecutor,
                     "N1_Executor", "Исполнитель " + Операционист());
        CopyAllSheetInTotalBook( m_CurrSheetName, false, "N1_Executor", 0, m_CurrSheetName, true );
    END;

    PRIVATE MACRO CReport_Show( NumCopy:INTEGER )
      SetLastTotalBookName("Report_ClosedAcc_" + 
                    ПолучитьДатуВСтроке(m_BegDate) + ПолучитьДатуВСтроке(m_EndDate) + "_" + StrSubst(string(date()),".","") + StrSubst(string(time()),":",""));
      CReport_Show(NumCopy);
    end;

    PRIVATE MACRO EndReport( NumCopy:INTEGER )
      SaveTotalBook();
    END;

    initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode, UsePOI );
    
END;

MACRO RunReport()

  var stat = true;

  Report_ClosedAcc_Form = DL_Report_ClosedAcc_Form();
   
  while(stat)
    stat = Report_ClosedAcc_Form.Run();
   
     // Проверяем можем ли мы делать отчет по предоставленным данным
    if (not stat)
      break;
    else
      m_DepartmentID  = Report_ClosedAcc_Form.GetFieldValue( PNFLD_CLOSEDACC_DEPARTCODE );
      m_BegDate       = Report_ClosedAcc_Form.GetFieldValue( PNFLD_CLOSEDACC_BEGDATE );
      m_EndDate       = Report_ClosedAcc_Form.GetFieldValue( PNFLD_CLOSEDACC_ENDDATE );
      IsSec           = Report_ClosedAcc_Form.GetFieldValue( PNFLD_CLOSEDACC_SEC );
      IsDV            = Report_ClosedAcc_Form.GetFieldValue( PNFLD_CLOSEDACC_DV );
      IsVA            = Report_ClosedAcc_Form.GetFieldValue( PNFLD_CLOSEDACC_VA );
      IsVS            = Report_ClosedAcc_Form.GetFieldValue( PNFLD_CLOSEDACC_VS );
      IsMBK           = Report_ClosedAcc_Form.GetFieldValue( PNFLD_CLOSEDACC_MBK );
      IsApostr        = Report_ClosedAcc_Form.GetFieldValue( PNFLD_CLOSEDACC_ISAPOSTR );
      IsExcel         = Report_ClosedAcc_Form.GetFieldValue( PNFLD_CLOSEDACC_EXCEL );
    end;
   
    if( stat )
	  var namefiles;
      var i = 0;  
      var Report_ClosedAcc = DL_Report_ClosedAcc( null, "Report_ClosedAcc.xlsx", null, null, null, true );   
      Report_ClosedAcc.setisshowAppl(false);	  
      Report_ClosedAcc.Run();
      namefiles = Report_ClosedAcc.GetFullReportFileNames();
      Report_ClosedAcc = NULL;
      for(i, namefiles)       
        СохранениеКонтрольныхОтчетов(i, ПолучитьДатуВСтроке(m_EndDate));
        ВыгрузкаКонтрольныхОтчетов(i);
        if(IsExcel == SET_CHAR)
          //CDAOMSExcel(i,true).Show();
          var fileName, fileExt;
          var filePath = SplitFile(i, fileName, fileExt);

          if( not isStandAlone() )
            filePath = "$" + filePath;
          end;

          SC_ShowFile(filePath, fileName+fileExt, true);
        end;
      end;
    end;
  end;

END;

RunReport();
exit(1); 