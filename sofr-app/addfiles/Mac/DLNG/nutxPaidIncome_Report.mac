/*
$Name:        nutxPaidIncome_Report.mac
$Module:      Ÿ¤à® Securities
$Description: Žâç¥â "€ªâë á¢¥àª¨ ­ «¨ç¨ï ¯®¤â¢¥à¦¤ îé¨å ¤®ªã¬¥­â®¢"
$Programmer:  ¥çª «®¢ ˆ¢ ­ Š®­áâ ­â¨­®¢¨ç
$Encoding:    OEM-866
$Date:        19.03.2018
*/
IMPORT DPInter, "DLReport_h.mac", "dlmisc.mac", "nutxPaidIncome_form.mac", "dldlngfun.mac", "nutxfun.mac";

PRIVATE VAR TableHeader =
"ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\n"+
"³     Š®¤     ³    „ â      ³    ‚à¥¬ï    ³     ‚¨¤ ®¯¥à æ¨¨    ³      ‚¨¤ ”ˆ        ³       Š®¤ ”ˆ        ³         áç¥âë ¯® á¤¥«ª¥           ³      Š«¨¥­â      ³                                       ‚¨¤ à áå®¦¤¥­¨ï                                       ³   à¨ç¨­  à áå®¦¤¥­¨ï   ³\n"+
"³   ®¯¥à æ¨¨  ³ à¥£¨áâà æ¨¨ ³ à¥£¨áâà æ¨¨ ³                     ³                    ³                     ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´                  ³                                                                                             ³                         ³\n"+
"³             ³             ³             ³                     ³                    ³                     ³        ¢¨¤       ³        ü        ³                  ³                                                                                             ³                         ³\n"+
"³             ³             ³             ³                     ³                    ³                     ³                  ³                 ³                  ³                                                                                             ³                         ³\n"+
"ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´";

//ª®­áâ ­âë
 /* ‘¨áâ¥¬­ë¥ áâ âãáë á¤¥«®ª\®¯¥à æ¨© ¨á¯®«­¥­¨ï á ˆ */
  var DVDEAL_STATE_UNDEF:integer =  -1; //‘â âãá ­¥ § ¤ ­
  var DVDEAL_STATE_PREP :integer =  0;  //Ž¯¥à æ¨ï ­  íâ ¯¥ ¯®¤£®â®¢ª¨
  var DVDEAL_STATE_OPEN :integer =  1;  //Ž¯¥à æ¨ï ®âªàëâ 
  var DVDEAL_STATE_CLOSE:integer =  2;  //Ž¯¥à æ¨ï § ªàëâ 


PRIVATE CLASS (DL_CReportTemplate) DL_ULN_PaidIncome_Report

  var m_DepID, m_DepCode, m_ContrNumber:string = "";
  var m_CurrSheetName = "", m_NoData = true, m_PrintDep = false;
  var m_newSheet=true;
  PRIVATE MACRO GetDataFromFormFields()
     nutxPaidIncomDataForm.IsUseBO        = m_Form.GetFieldValue(PNFLD_PAID_INCOME_ISSECUR);
     nutxPaidIncomDataForm.IsUseDV        = m_Form.GetFieldValue(PNFLD_PAID_INCOME_ISDV);
     nutxPaidIncomDataForm.IsUseDep       = m_Form.GetFieldValue(PNFLD_PAID_INCOME_ISDEPO);
     nutxPaidIncomDataForm.BeginDate      = m_Form.GetFieldValue(PNFLD_PAID_INCOME_BEGINDATE);
     nutxPaidIncomDataForm.EndDate        = m_Form.GetFieldValue(PNFLD_PAID_INCOME_ENDDATE);
     nutxPaidIncomDataForm.ClientID       = m_Form.GetFieldValue(PNFLD_PAID_INCOME_CLIENTCODE);
     nutxPaidIncomDataForm.ContractID     = m_Form.GetFieldValue(PNFLD_PAID_INCOME_IDCONTRACT, @m_ContrNumber);
     nutxPaidIncomDataForm.KindDeal       = m_Form.GetFieldValue(PNFLD_PAID_INCOME_KINDDEAL);
     nutxPaidIncomDataForm.IsExportToExel = m_Form.GetFieldValue(PNFLD_PAID_INCOME_EXCEL);
     nutxPaidIncomDataForm.DepartmentID   =  -1;//m_Form.GetFieldValue(PNFLD_ACTINACC_DEPARTMENT);
  END;

  MACRO GetAuditMsg():String
    GetDataFromFormFields();
    var msg:string = "";
    var beginDate:date = nutxPaidIncomDataForm.BeginDate;
    var endDate:date = nutxPaidIncomDataForm.EndDate;
    var deals1:string = "";
    var deals2:string = "";
    var deals3:string = "";

    deals1 = IIF(nutxPaidIncomDataForm.IsUseBO == "X",
                 "Œ®¤ã«ï \"íª-®ä¨á æ¥­­ëå ¡ã¬ £\"\n",
                 "");

    deals2 = IIF(nutxPaidIncomDataForm.IsUseDep == "X",
                 "Œ®¤ã«ï \"„¥¯®§¨â à¨©\"\n",
                 "");
                 
    deals3 = IIF(nutxPaidIncomDataForm.IsUseDV == "X",
                 "Œ®¤ã«ï \"”ˆ‘‘¨ŠŽ\"\n",
                 "");

    msg = 
    "Žâç¥â:              €ªâ á¢¥àª¨ ­ «¨ç¨ï ¤®ªã¬¥­â®¢\n\n" +
    "Žâç¥â­ë© ¯¥à¨®¤:          á " + beginDate + " ¯® " + endDate + "\n" +
    "® á¤¥«ª ¬:\n"  +
    deals1 + deals2 + deals3 +
    "\n----------------------------------------\n";

    return msg;
  END;

  PRIVATE MACRO PrintMode():INTEGER
     if( nutxPaidIncomDataForm.IsExportToExel == SET_CHAR )
        return DL_OUTREPORT_EXCEL;
     else
        return DL_OUTREPORT_STD;
     end;
  END;

  PRIVATE MACRO BeginReport()
     GetDataFromFormFields();
     Dl_CallInsertStat(PrintMode());
     CreateTotalBook();
  END;

  PRIVATE MACRO EndReport()
     SaveTotalBook();
  END;

  PRIVATE MACRO PrintHeader()
    var Header = "„ â  ¯à®¢¥¤¥­¨ï á¢¥àª¨: # #\n"+
                 "”¨«¨ «: #\n"+
                 "€Š’ Ž Ž‚…„…ˆˆ ‘‚…Šˆ €‹ˆ—ˆŸ „ŽŠ“Œ…’Ž‚, Ž„’‚…†„€ž™ˆ• €‘—…’“ž Ž…€–ˆž ‚“\n"+
                 "¯® á®áâ®ï­¨î ­  #\n" +
                 "#\n";

    var ClientTxt:string = "";

    if( (nutxPaidIncomDataForm.ClientID > 0) and (nutxPaidIncomDataForm.ContractID > 0) )
       ClientTxt = "Š«¨¥­â " + DL_getPartyShortName(nutxPaidIncomDataForm.ClientID);
       ClientTxt = ClientTxt + " ¤®£®¢®à ü " + m_ContrNumber;
    end;

    PrintFormatString( Header,
                       "N1_H01_1", string(nutxPaidIncomDataForm.BeginDate:f),
                       "N1_H01_2", string(nutxPaidIncomDataForm.EndDate:f));                     
    CopyAllSheetInTotalBook(m_CurrSheetName, false, "N1_RepHeader", 0, m_CurrSheetName, true);
  END;

  MACRO ¥ç â âì‘âà®ªã’ ¡«¨æë( A1 , A2 , A3 , A4 , A5 , A6 , A7 , A7_1, A8, A9, A10,
                               A11, A12, A13, A14, A15, A16, A17, A18, A19, A20,
                               A21, A22, A23, A24, A25, A26, A27, A28, A29, A30,
                               A31, A32, A33, A34, A35, A36, A37, A38, A39, A40,
                               A41, A42, A43, A44, A45, A46, A47, A48, A49, A50,
                               A51, A52, A53
                                 )

     if( m_newSheet )


        m_CurrSheetName = DL_GetDepartmentNameByCode(m_DepCode);
        UseNewSheetInTotalBook();
        PrintHeader();

        RegisterTable( "N1_MainTable", TableHeader,
                       "N1_A1",
                       "N1_A2",
                       "N1_A3",
                       "N1_A4",
                       "N1_A5",
                       "N1_A6",
                       "N1_A7",
                       "N1_A7.1",
                       "N1_A8",
                       "N1_A9",
                       "N1_A10",
                       "N1_A11",
                       "N1_A12",
                       "N1_A13",
                       "N1_A14",
                       "N1_A15",
                       "N1_A16",
                       "N1_A17",
                       "N1_A18",
                       "N1_A19",
                       "N1_A20",
                       "N1_A21",
                       "N1_A22",
                       "N1_A23",
                       "N1_A24",
                       "N1_A25",
                       "N1_A26",
                       "N1_A27",
                       "N1_A28",
                       "N1_A29",
                       "N1_A30",
                       "N1_A31",
                       "N1_A32",
                       "N1_A33",
                       "N1_A34",
                       "N1_A35",
                       "N1_A36",
                       "N1_A37",
                       "N1_A38",
                       "N1_A39",
                       "N1_A40",
                       "N1_A41",
                       "N1_A42",
                       "N1_A43",
                       "N1_A44",
                       "N1_A45",
                       "N1_A46",
                       "N1_A47",
                       "N1_A48",
                       "N1_A49",
                       "N1_A50",
                       "N1_A51",
                       "N1_A52",
                       "N1_A53"
                       );

        m_newSheet = false;
     end;

     PrintTableLine( "N1_A1",  A1,  null,
                     "N1_A2",  A2,  null,
                     "N1_A3",  A3,  null,
                     "N1_A4",  A4,  null,
                     "N1_A5",  A5,  null,
                     "N1_A6",  A6,  null,
                     "N1_A7",  A7,  null,
                     "N1_A7.1",A7_1,  null,
                     "N1_A8",  A8,  null,
                     "N1_A9",  A9,  null,
                     "N1_A10", A10, null,
                     "N1_A11", A11, null,
                     "N1_A12", A12, null,
                     "N1_A13", A13, null,                     
                     "N1_A14", A14, null,
                     "N1_A15", A15, null,
                     "N1_A16", A16, null,                       
                     "N1_A17", A17, null,
                     "N1_A18", A18, null,
                     "N1_A19", A19, null,                       
                     "N1_A20", A20, null,
                     "N1_A21", A21, null,
                     "N1_A22", A22, null,
                     "N1_A23", A23, null,                     
                     "N1_A24", A24, null,
                     "N1_A25", A25, null,
                     "N1_A26", A26, null,                       
                     "N1_A27", A27, null,
                     "N1_A28", A28, null,
                     "N1_A29", A29, null,                        
                     "N1_A30", A30, null,
                     "N1_A31", A31, null,
                     "N1_A32", A32, null,
                     "N1_A33", A33, null,                     
                     "N1_A34", A34, null,
                     "N1_A35", A35, null,
                     "N1_A36", A36, null,                       
                     "N1_A37", A37, null,
                     "N1_A38", A38, null,
                     "N1_A39", A39, null,                        
                     "N1_A40", A40, null,
                     "N1_A41", A41, null,
                     "N1_A42", A42, null,
                     "N1_A43", A43, null,                     
                     "N1_A44", A44, null,
                     "N1_A45", A45, null,
                     "N1_A46", A46, null,                       
                     "N1_A47", A47, null,
                     "N1_A48", A48, null,
                     "N1_A49", A49, null,                        
                     "N1_A50", A50, null,
                     "N1_A51", A51, null,
                     "N1_A52", A52, null,
                     "N1_A53", A53, null                      
                   );
  END;        

  PRIVATE MACRO PrintMainFooter()
    var Footer = "\n\n‘®âàã¤­¨ª, ®â¢¥âáâ¢¥­­ë© § " +
                 "\n¢¥¤¥­¨¥ ¢­ãâà¥­­¥£® ãç¥â :                      # " +
                 "\n__________________                     ___________________" +
                 "\n(¤®«¦­®áâì)       (¯®¤¯¨áì)   (ä ¬¨«¨ï)\n" +
                 "\n‘®âàã¤­¨ª ‘«ã¦¡ë ¢­ãâà¥­­¥£® ª®­âà®«ï:\n" +
                 "\n________________________                     ___________________  /__________________/" +
                 "\n(¤®«¦­®áâì)        (¯®¤¯¨áì)  (ä ¬¨«¨ï)";
    PrintFormatString(Footer, "N1_F1",{Name_Oper});
    CopyAllSheetInTotalBook(m_CurrSheetName, false, "N1_Footer", 1, m_CurrSheetName, true);
  END;

  PRIVATE MACRO ¥ç â âì„ ­­ë¥()
  
 //   MACRO getBOfficeStringList()
 //      var Delim = false;
 //      var retStr = "";
 //      if( nutxPaidIncomDataForm.IsUseBO == SET_CHAR )
 //         retStr = retStr + IIF(Delim, ",", "") + string(OBJTYPE_BACKOFFICE_SP); 
 //         Delim = true;
 //      end;
 //      
 //      if( nutxPaidIncomDataForm.IsUseDV == SET_CHAR )
 //         retStr = retStr + IIF(Delim, ",", "") + string(OBJTYPE_BACKOFFICE_DV);
 //         Delim = true;
 //      end;
 //      
 //      if( nutxPaidIncomDataForm.IsUseDep == SET_CHAR )
 //         retStr = retStr + IIF(Delim, ",", "") + string(OBJTYPE_BACKOFFICE_VA);
 //         Delim = true;
 //      end;
 //      return retStr;
 //   END;
 // 
 //   MACRO ¯®«ãç¨âì‘¥«¥ªâãç­ëåŽ‚“()
 //   var Query = " SELECT CAST( dl_acc.t_Ground AS varchar2(20) ) Ground,           " +/*ª áâ ¢ áâà®ªã ¤«ï á®¢¬¥áâ¨¬®áâ¨ á® § ¯à®á®¬ ¯® Ž‚“ ¯® á¤¥«ª ¬*/
 //               "        -1              GroundKind," +//¡¥§ â¨¯  - §­ ç¨â ID
 //               "        dl_acc.t_ID,               " +
 //               "        dl_acc.t_DealID,           " +
 //               "        dl_acc.t_Code,             " +
 //               "        inacc.t_SysDate,           " +
 //               "        inacc.t_SysTime,           " +
 //               "        lvalues.t_Name OperName,   " +
 //               "        fikind.t_Name t_FIKindName," +
 //               "        fi.t_FI_Code,              " +   
 //               "        RSB_SECUR.GetDealTypeName(dl_acc.t_DealType) DealTypeName, " +
 //               "        NVL(tick.t_DealCode, chr(1)) DealCode,                     " +
 //               "        dl_acc.t_Client      Client,                               " +
 //               "        dl_acc.t_ClientContr ClientContr,                          " +
 //               "        dl_acc.t_Corrective                                        " +
 //               "   FROM ddl_acc_dbt dl_acc, ddlinacc_dbt inacc, dllvalues_dbt lvalues, dfikinds_dbt fikind, dfininstr_dbt fi, ddl_tick_dbt tick " +
 //               "  WHERE dl_acc.t_Department = ?                                                                                                 " +  
 //               "    AND dl_acc.t_Client > 0                                                                                                     " +
 //               "    AND dl_acc.t_Client = (case when ? = -1 then dl_acc.t_Client else ? end)                                                    " +
 //               "    AND dl_acc.t_ClientContr = (case when ? = -1 then dl_acc.t_ClientContr else ? end)                                          " +
 //               "    AND dl_acc.t_BOffice in("+getBOfficeStringList()+")                                                                         " +
 //               "    AND lvalues.t_List     = " + string(OBJTYPE_CALCOPKIND)                                                                       +
 //               "    AND lvalues.t_Element  = dl_acc.t_Opertype                                                                                  " +
 //               "    AND fikind.t_FI_Kind   = dl_acc.t_FIKind                                                                                    " +
 //               "    AND fi.t_FIID          = dl_acc.t_FIID                                                                                      " +
 //               "    AND tick.t_DealID   (+)= dl_acc.t_DealID                                                                                    " +
 //               "    AND inacc.t_DocumentKind = dl_acc.t_DocKind                                                                                 " +
 //               "    AND inacc.t_DocumentID = dl_acc.t_ID                                                                                        " +
 //               "    AND inacc.t_FIID       = dl_acc.t_FIID                                                                                      " +
 //               "    AND inacc.t_Opertype   = dl_acc.t_Opertype                                                                                  " +
 //               "    AND dl_acc.t_Date   >= ? "+//TO_DATE( ? ,'dd.mm.yyyy')                                                                                                   " +
 //               "    AND dl_acc.t_Date   <= ? ";//TO_DATE( ? ,'dd.mm.yyyy')                                                                                                  " ;
 //
 //       return Query;           
 //   END;
 //   MACRO ¯®«ãç¨âì‘¥«¥ªâŽ‚“¯®‘¤¥«ª ¬()
 //   var Query = " SELECT                                                                                                 " +
 //               "         inacc.t_GroundNum Ground,                                                                      " + 
 //               "         inacc.t_GroundKind GroundKind,                                                                 " +
 //               "         tick.t_DealID ID,                                                                              " + /* ¯®å®¦¥, á®¢¯ ¤ ¥â á 'ª®¤®¬ ®¯¥à æ¨¨' ¤«ï Ž‚“ ¯® ‘¤¥«ª ¬ */
 //               "         tick.t_DealID,                                                                                 " +
 //               "         trn.t_Numb_Document Code,                                                                      " +
 //               "         inacc.t_SysDate,                                                                               " +
 //               "         inacc.t_SysTime,                                                                               " +
 //               "         lvalues.t_Name OperName,                                                                       " +
 //               "         fikind.t_Name t_FIKindName,                                                                    " +
 //               "         fi.t_FI_Code,                                                                                  " +
 //               "         RSB_SECUR.GetDealTypeName(tick.t_DealType) DealTypeName,                                       " +
 //               "         NVL(tick.t_DealCode, chr(1)) DealCode,                                                         " +
 //               "         tick.t_ClientID Client,                                                                        " + 
 //               "         tick.t_ClientContrID ClientContr,                                                              " +
 //               "         chr(0) Corrective                                                                              " +
 //               "   FROM  ddlinacc_dbt  inacc,                                                                           " +
 //               "         dacctrn_dbt trn,                                                                               " + 
 //               "         ddl_tick_dbt   tick,                                                                           " +
 //               "         dllvalues_dbt lvalues,                                                                         " +
 //               "         dfikinds_dbt fikind,                                                                           " + 
 //               "         dfininstr_dbt fi                                                                               " +
 //               "  WHERE  tick.t_Department = ?                                                                          " +
 //               "         AND tick.t_ClientID      > 0                                                                   " +                        
 //               "         AND tick.t_ClientID      = (case when ? = -1 then tick.t_ClientID else ? end)                  " +                                        
 //               "         AND tick.T_CLIENTCONTRID = (case when ? = -1 then tick.T_CLIENTCONTRID else ? end)             " +                                      
 //               "         AND lvalues.t_List     = " + string(OBJTYPE_CALCOPKIND)                                          +
 //               "         AND lvalues.t_Element  = inacc.t_Opertype                                                      " +
 //               "         AND fikind.t_FI_Kind   = inacc.t_FIKind                                                        " +
 //               "         AND fi.t_FIID          = inacc.t_FIID                                                          " +
 //               "         AND inacc.t_DocumentID = tick.t_DealID                                                         " +
 //               "         AND inacc.t_Date   >= ? "+//TO_DATE( ? ,'dd.mm.yyyy')                                                                     " +
 //               "         AND inacc.t_Date   <= ? "+//TO_DATE( ? ,'dd.mm.yyyy')                                                                     " +
 //               "         AND inacc.t_Boffice in( "+getBOfficeStringList()+")                                            " +
 //               "         AND inacc.t_AcctrnID   = trn.t_AcctrnID                                                        " ;
 //        return Query;
 //   END;
 // 
 //   MACRO ¤®¡ ¢¨âì à ¬¥âàë„«ï‘¥«¥ªâãç­ëåŽ‚“( src: @RSDCommand)
 //       src.addParam("", RSDBP_IN, m_DepCode);
 //       src.addParam("", RSDBP_IN, nutxPaidIncomDataForm.ClientID);
 //       src.addParam("", RSDBP_IN, nutxPaidIncomDataForm.ClientID);
 //       src.addParam("", RSDBP_IN, nutxPaidIncomDataForm.ContractID);
 //       src.addParam("", RSDBP_IN, nutxPaidIncomDataForm.ContractID);
 //       src.addParam("", RSDBP_IN, nutxPaidIncomDataForm.BeginDate);
 //       src.addParam("", RSDBP_IN, nutxPaidIncomDataForm.EndDate);
 //   END;
 //   MACRO ¤®¡ ¢¨âì à ¬¥âàë„«ï‘¥«¥ªâŽ‚“¯®‘¤¥«ª ¬( src: @RSDCommand)
 //       src.addParam("", RSDBP_IN, m_DepCode);
 //       src.addParam("", RSDBP_IN, nutxPaidIncomDataForm.ClientID);
 //       src.addParam("", RSDBP_IN, nutxPaidIncomDataForm.ClientID);
 //       src.addParam("", RSDBP_IN, nutxPaidIncomDataForm.ContractID);
 //       src.addParam("", RSDBP_IN, nutxPaidIncomDataForm.ContractID);
 //       src.addParam("", RSDBP_IN, nutxPaidIncomDataForm.BeginDate);
 //       src.addParam("", RSDBP_IN, nutxPaidIncomDataForm.EndDate);
 //   END;
 //
 //   var Count:integer = 0, Num:integer = 0; 
 //   var A11:string = "";
 //   var sqlQuery = "";
 //
 //   sqlQuery = sqlQuery + ¯®«ãç¨âì‘¥«¥ªâãç­ëåŽ‚“();
 //   sqlQuery = sqlQuery + " UNION ALL ";    
 //   sqlQuery = sqlQuery + ¯®«ãç¨âì‘¥«¥ªâŽ‚“¯®‘¤¥«ª ¬();    
 //   sqlQuery = sqlQuery + " ORDER BY t_SysDate, Client, ClientContr ";
 //
 //   var NRecSelect = RSDCommand("select count(1) nRecs from(" + sqlQuery + ")");
 //   ¤®¡ ¢¨âì à ¬¥âàë„«ï‘¥«¥ªâãç­ëåŽ‚“(@NRecSelect);
 //   ¤®¡ ¢¨âì à ¬¥âàë„«ï‘¥«¥ªâŽ‚“¯®‘¤¥«ª ¬(@NRecSelect);
 //   NRecSelect.execute();
 //   var NRecData = TRsbDataSet(NRecSelect);
 //

 
    var Count:integer = 0, Num:integer = 1; 

    var NUTXobjKindListForSelect:String;
    //¢á¥ Plus_xx:
    NUTXobjKindListForSelect = NUTXOBJ_PLUS_25 + "," + NUTXOBJ_PLUS_10 + "," + NUTXOBJ_PLUS_11 + "," + NUTXOBJ_PLUS_13 + "," + NUTXOBJ_PLUS_27 + "," + NUTXOBJ_PLUS_01 + "," + NUTXOBJ_PLUS_15;
    
    
    MACRO ¯®«ãç¨âì‘¥«¥ªâ„«ïŽâç¥â (cmd:@DL_RSDCommand)
    
      MACRO ¯®«ãç¨âì‘¥«¥ªâ®ªã¯®ªŽ–(cmd:@DL_RSDCommand)
        var Query = "SELECT  nutxObj.*, " +
                    "        tick.t_DealID DocID, tick.t_BOfficeKind DocKind, fin_avr_part1.t_fiid FIID, -1 BaseFIID " +
                    " FROM ddl_tick_dbt tick, dnutxobj_dbt nutxObj, "+//®á­®¢ 
                    "      ddlrq_dbt dlrq_avr_part1, dfininstr_dbt fin_avr_part1 "+
                    "      WHERE tick.t_DealStatus in ("+DL_PREPARING+","+DL_READIED+")"+
                    "        and tick.t_BofficeKind = "+DL_SECURITYDOC +//á¤¥«ª  á æ/¡   
                    "        and tick.t_ClientID =  (case when ? = -1 then tick.t_ClientID else ? end)"+
                    "        and tick.t_ClientContrID = (case when ? = -1 then tick.t_ClientContrID else ? end)"+
                    "        and RSB_SECUR.DealIsRepo(tick.t_DealID) = 0 "+
                    "        and RSB_SECUR.IsBuy (RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1 "+
                    "        and EXISTS                                 "+
                    "            (                                      "+
                    "               SELECT 1 from ddlrq_dbt dlrq        "+
                    "               WHERE                               "+
                    "                   dlrq.t_DocID = tick.t_DealID    "+
                    "               AND dlrq.t_DocKind = tick.t_BofficeKind "+
                    "               AND dlrq.t_SubKind = "+DLRQ_SUBKIND_CURRENCY+//®¯« â  ¤¥­¥¦­ë¬¨ áà¥¤áâ¢ ¬¨
                    "               AND dlrq.t_State   = "+DLRQ_STATE_EXEC+
                    "               AND dlrq.t_FactDate BETWEEN ? and ? "+
                    "            )                                      "+   
                    "        and nutxObj.t_AnaliticKind1 = "+ TXOBJ_KIND1010+
                    "        and nutxObj.t_Analitic1 = tick.t_DealID    "+
                    "        and nutxObj.t_Kind in ("+ NUTXobjKindListForSelect +")"+
                    "        and dlrq_avr_part1.t_DocID = tick.t_DealID    "+
                    "        and dlrq_avr_part1.t_DocKind = tick.t_BofficeKind "+
                    "        and dlrq_avr_part1.t_SubKind = "+DLRQ_SUBKIND_AVOIRISS+
                    "        and dlrq_avr_part1.t_State   = "+DLRQ_STATE_EXEC+
                    "        and dlrq_avr_part1.t_FactDate BETWEEN ? and ? "+
                    "        and dlrq_avr_part1.t_DealPart = 1    "  +
                    "        and fin_avr_part1.t_fiid = dlrq_avr_part1.t_fiid "
                    ;

        cmd.addParam(nutxPaidIncomDataForm.ClientID);
        cmd.addParam(nutxPaidIncomDataForm.ClientID);
        cmd.addParam(nutxPaidIncomDataForm.ContractID);
        cmd.addParam(nutxPaidIncomDataForm.ContractID);
        cmd.addParam(nutxPaidIncomDataForm.BeginDate);
        cmd.addParam(nutxPaidIncomDataForm.EndDate);
        cmd.addParam(nutxPaidIncomDataForm.BeginDate);
        cmd.addParam(nutxPaidIncomDataForm.EndDate);

        return Query;      
      END;
      
      MACRO ¯®«ãç¨âì‘¥«¥ªâà®¤ ¦Ž–(cmd:@DL_RSDCommand)
        var Query = "SELECT  nutxObj.*, " +
                    "        tick.t_DealID DocID, tick.t_BOfficeKind DocKind, fin_avr_part1.t_fiid FIID, -1 BaseFIID " +
                    " FROM ddl_tick_dbt tick, dnutxobj_dbt nutxObj, "+//®á­®¢ 
                    "      ddlrq_dbt dlrq_avr_part1, dfininstr_dbt fin_avr_part1 "+
                    "      WHERE tick.t_DealStatus in ("+DL_PREPARING+","+DL_READIED+")"+
                    "        and tick.t_BofficeKind = "+DL_SECURITYDOC +//á¤¥«ª  á æ/¡             
                    "        and tick.t_ClientID =  (case when ? = -1 then tick.t_ClientID else ? end)"+ 
                    "        and tick.t_ClientContrID = (case when ? = -1 then tick.t_ClientContrID else ? end)"+
                    "        and RSB_SECUR.DealIsRepo(tick.t_DealID) = 0 "+
                    "        and RSB_SECUR.IsSale (RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1 "+
                    "        and EXISTS                                 "+
                    "            (                                      "+
                    "               SELECT 1 from ddlrq_dbt dlrq        "+
                    "               WHERE                               "+
                    "                   dlrq.t_DocID = tick.t_DealID    "+
                    "               AND dlrq.t_DocKind = tick.t_BofficeKind "+
                    "               AND dlrq.t_SubKind = "+DLRQ_SUBKIND_CURRENCY+//®¯« â  ¤¥­¥¦­ë¬¨ áà¥¤áâ¢ ¬¨
                    "               AND dlrq.t_State   = "+DLRQ_STATE_EXEC+
                    "               AND dlrq.t_FactDate BETWEEN ? and ? "+
                    "            )                                      "+   
                    "        and nutxObj.t_AnaliticKind1 = "+ TXOBJ_KIND1010+
                    "        and nutxObj.t_Analitic1 = tick.t_DealID    "+
                    "        and nutxObj.t_Kind in ("+ NUTXobjKindListForSelect +")"+
                    "        and dlrq_avr_part1.t_DocID = tick.t_DealID    "+
                    "        and dlrq_avr_part1.t_DocKind = tick.t_BofficeKind "+
                    "        and dlrq_avr_part1.t_SubKind = "+DLRQ_SUBKIND_AVOIRISS+
                    "        and dlrq_avr_part1.t_State   = "+DLRQ_STATE_EXEC+
                    "        and dlrq_avr_part1.t_FactDate BETWEEN ? and ? "+
                    "        and dlrq_avr_part1.t_DealPart = 1    "  +
                    "        and fin_avr_part1.t_fiid = dlrq_avr_part1.t_fiid "
                    ;

        cmd.addParam(nutxPaidIncomDataForm.ClientID); 
        cmd.addParam(nutxPaidIncomDataForm.ClientID); 
        cmd.addParam(nutxPaidIncomDataForm.ContractID);
        cmd.addParam(nutxPaidIncomDataForm.ContractID);        
        cmd.addParam(nutxPaidIncomDataForm.BeginDate);
        cmd.addParam(nutxPaidIncomDataForm.EndDate);
        cmd.addParam(nutxPaidIncomDataForm.BeginDate);
        cmd.addParam(nutxPaidIncomDataForm.EndDate);

        return Query;      
      END;
      
      MACRO ¯®«ãç¨âì‘¥«¥ªâ…ŽŽ–(cmd:@DL_RSDCommand)
        var Query = "SELECT  nutxObj.*, " +
                    "        tick.t_DealID DocID, tick.t_BOfficeKind DocKind, fin_avr_part1.t_fiid FIID, -1 BaseFIID " +
                    " FROM ddl_tick_dbt tick, dnutxobj_dbt nutxObj, "+//®á­®¢ 
                    "      ddlrq_dbt dlrq_avr_part1, dfininstr_dbt fin_avr_part1 "+
                    "      WHERE tick.t_DealStatus in ("+DL_PREPARING+","+DL_READIED+")"+
                    "        and tick.t_BofficeKind = "+DL_SECURITYDOC +//á¤¥«ª  á æ/¡ 
                    "        and tick.t_ClientID =  (case when ? = -1 then tick.t_ClientID else ? end)"+        
                    "        and tick.t_ClientContrID = (case when ? = -1 then tick.t_ClientContrID else ? end)"+
                    "        and RSB_SECUR.DealIsRepo(tick.t_DealID) = 1 "+
                    "        and EXISTS                                 "+
                    "            (                                      "+
                    "               SELECT 1 from ddlrq_dbt dlrq_tmp       "+
                    "               WHERE                               "+
                    "                   dlrq_tmp.t_DocID = tick.t_DealID    "+
                    "               AND dlrq_tmp.t_DocKind = tick.t_BofficeKind "+
                    "               AND dlrq_tmp.t_SubKind = "+DLRQ_SUBKIND_CURRENCY+//®¯« â  ¤¥­¥¦­ë¬¨ áà¥¤áâ¢ ¬¨
                    "               AND dlrq_tmp.t_State   = "+DLRQ_STATE_EXEC+
                    "               AND dlrq_tmp.t_FactDate BETWEEN ? and ? "+
                    "               AND dlrq_tmp.t_DealPart  = 2            "+//¤«ï à¥¯® ­ á ¨­â¥à¥áã¥â ­ «¨ç¨¥ ¢ë¯®«­¥­­®© 2 ç áâ
                    "            )                                      "+                 
                    "        and nutxObj.t_AnaliticKind1 = "+ TXOBJ_KIND1010 +
                    "        and nutxObj.t_Analitic1 = tick.t_DealID    "+
                    "        and nutxObj.t_Kind in ("+ NUTXobjKindListForSelect +")"+
                    "        and dlrq_avr_part1.t_DocID = tick.t_DealID    "+
                    "        and dlrq_avr_part1.t_DocKind = tick.t_BofficeKind "+
                    "        and dlrq_avr_part1.t_SubKind = "+DLRQ_SUBKIND_AVOIRISS+
                    "        and dlrq_avr_part1.t_State   = "+DLRQ_STATE_EXEC+
                    "        and dlrq_avr_part1.t_FactDate BETWEEN ? and ? "+
                    "        and dlrq_avr_part1.t_DealPart = 1    "  +
                    "        and fin_avr_part1.t_fiid = dlrq_avr_part1.t_fiid "
                    ;

        cmd.addParam(nutxPaidIncomDataForm.ClientID);
        cmd.addParam(nutxPaidIncomDataForm.ClientID);     
        cmd.addParam(nutxPaidIncomDataForm.ContractID);
        cmd.addParam(nutxPaidIncomDataForm.ContractID);        
        cmd.addParam(nutxPaidIncomDataForm.BeginDate);
        cmd.addParam(nutxPaidIncomDataForm.EndDate);
        cmd.addParam(nutxPaidIncomDataForm.BeginDate);
        cmd.addParam(nutxPaidIncomDataForm.EndDate);
        
        return Query;      
      END;
      
      MACRO ¯®«ãç¨âì‘¥«¥ªâ®£ è¥­¨©(cmd:@DL_RSDCommand)
        var Query = "SELECT  nutxObj.*, " +
                    "        tick.t_DealID DocID, tick.t_BOfficeKind DocKind, tick.t_PFI FIID, -1 BaseFIID " +
                    " FROM ddl_tick_dbt tick, dnutxobj_dbt nutxObj "+
                    "      WHERE tick.t_DealStatus in ("+DL_PREPARING+","+DL_READIED+")"+
                    "        and tick.t_BofficeKind IN ("+DL_RETIREMENT+", "+DL_RETIREMENT_OWN+")" +//®£ è¥­¨¥
                    "        and tick.t_ClientID =  (case when ? = -1 then tick.t_ClientID else ? end)"+        
                    "        and tick.t_ClientContrID = (case when ? = -1 then tick.t_ClientContrID else ? end)"+
                    "        and EXISTS                                 "+
                    "            (                                      "+
                    "               SELECT 1 from ddlrq_dbt dlrq_tmp       "+
                    "               WHERE                               "+
                    "                   dlrq_tmp.t_DocID = tick.t_DealID    "+
                    "               AND dlrq_tmp.t_DocKind = tick.t_BofficeKind "+
                    "               AND dlrq_tmp.t_SubKind = "+DLRQ_SUBKIND_CURRENCY+//®¯« â  ¤¥­¥¦­ë¬¨ áà¥¤áâ¢ ¬¨
                    "               AND dlrq_tmp.t_State   = "+DLRQ_STATE_EXEC+
                    "               AND dlrq_tmp.t_FactDate BETWEEN ? and ? "+
                    "               AND dlrq_tmp.t_DealPart  = 1            "+//¤«ï ¯®£ è¥­¨© â®«ìª® ®¤­  ç áâì
                    "            )                                      "+                 
                    "        and nutxObj.t_AnaliticKind1 IN ("+TXOBJ_KIND1010+", "+TXOBJ_KIND1020+")"+
                    "        and nutxObj.t_Analitic1 = tick.t_DealID    "+
                    "        and nutxObj.t_Kind in ("+ NUTXobjKindListForSelect +")";

        cmd.addParam(nutxPaidIncomDataForm.ClientID);
        cmd.addParam(nutxPaidIncomDataForm.ClientID);     
        cmd.addParam(nutxPaidIncomDataForm.ContractID);
        cmd.addParam(nutxPaidIncomDataForm.ContractID);        
        cmd.addParam(nutxPaidIncomDataForm.BeginDate);
        cmd.addParam(nutxPaidIncomDataForm.EndDate);
        
        return Query;      
      END;
      
      MACRO ¯®«ãç¨âì‘¥«¥ªâ áç¥â„®å®¤ ®–(cmd:@DL_RSDCommand)
                var Query = "SELECT  nutxObj.*, " +
                    "        crp.t_DocumentID DocID, crp.t_DocKind DocKind, fin_avr.t_fiid FIID, -1 BaseFIID " +
                    " FROM ddppmacc_dbt pmacc, ddpcorpop_dbt crp, ddppmacfi_dbt pmacfi, dnutxobj_dbt nutxObj, "+//®á­®¢ 
                    "     dfininstr_dbt fin_avr, "+
                    "     ddepoacnt_dbt acnt, dsfcontr_dbt sfcontr "
                    "      WHERE pmacc.t_State = "+DPPMAC_STATE_PAID+
                    "        and pmacc.t_HolderID =  (case when ? = -1 then pmacc.t_HolderID else ? end)"+
                    "        and acnt.t_AutoKey = pmacc.t_HolderAccID " +
                    "        and sfcontr.t_ObjectType = " + SF_DEPOACC +
                    "        and sfcontr.t_ServKind = " + PTSK_DEPOS +
                    "        and sfcontr.t_Object = acnt.t_Code " +
                    "        and sfcontr.t_PartyID = acnt.t_Owner" +
                    "        and sfcontr.t_ID = (case when ? = -1 then sfcontr.t_ID else ? end)"+
                    "        and pmacc.t_StateDate BETWEEN ? and ? " +
                    "        and crp.t_DocumentID = pmacc.t_DocumentID "+
                    "        and nutxObj.t_AnaliticKind1 = "+TXOBJ_KIND1098+
                    "        and nutxObj.t_Analitic1 = pmacc.t_DocumentID    "+
                    "        and nutxObj.t_Kind in ("+ NUTXobjKindListForSelect +")"+
                    "        and nutxObj.t_Client = pmacc.t_HolderID "+
                    "        and pmacfi.t_DocumentID = pmacc.t_DocumentID " +
                    "        and pmacfi.t_HolderAccID = pmacc.t_HolderAccID " +
                    "        and fin_avr.t_fiid = pmacfi.t_fiid "
                    ;

        cmd.addParam(nutxPaidIncomDataForm.ClientID);
        cmd.addParam(nutxPaidIncomDataForm.ClientID);     
        cmd.addParam(nutxPaidIncomDataForm.ContractID);
        cmd.addParam(nutxPaidIncomDataForm.ContractID);        
        cmd.addParam(nutxPaidIncomDataForm.BeginDate);
        cmd.addParam(nutxPaidIncomDataForm.EndDate);

        return Query;      
      END;
      
      MACRO ¯®«ãç¨âì‘¥«¥ªâ‘¤¥«ª¨”ˆ‘‘¨ŠŽ(cmd:@DL_RSDCommand)
      //tick
        var Query = "SELECT  nutxObj.*, " +
                    "        dvndeal.t_ID DocID, "+DL_DVNDEAL+" DocKind, -1 FIID, dvnfin.t_fiid BaseFIID " +
                    " FROM ddvndeal_dbt dvndeal, dnutxobj_dbt nutxObj, "+//®á­®¢ 
                    "     ddvnfi_dbt dvnfin "+
                    "      WHERE dvndeal.t_State in ("+DVDEAL_STATE_PREP+","+DVDEAL_STATE_OPEN+")"+
                    "        and dvndeal.t_Client =  (case when ? = -1 then dvndeal.t_Client else ? end)"+        
                    "        and dvndeal.t_ClientContr = (case when ? = -1 then dvndeal.t_ClientContr else ? end)"+
                    "        and nutxObj.t_AnaliticKind1 = "+TXOBJ_KIND1090+
                    "        and nutxObj.t_Analitic1 = dvndeal.t_ID     "+
                    "        and nutxObj.t_Kind in ("+ NUTXobjKindListForSelect +")"+
                    "        and dvndeal.t_Date BETWEEN ? and ? "+
                    "        and dvndeal.t_ID = dvnfin.t_dealID "+
                    "        and dvnfin.t_Type = 0 "
                    ;
                    
         cmd.addParam(nutxPaidIncomDataForm.ClientID);
         cmd.addParam(nutxPaidIncomDataForm.ClientID);     
         cmd.addParam(nutxPaidIncomDataForm.ContractID);
         cmd.addParam(nutxPaidIncomDataForm.ContractID);        
         cmd.addParam(nutxPaidIncomDataForm.BeginDate);
         cmd.addParam(nutxPaidIncomDataForm.EndDate);

         Query = Query + " UNION ALL ";
         
         Query = Query + 
                    "SELECT  nutxObj.*, " +
                    "        dvdeal.t_ID DocID, "+DL_DVDEAL+" DocKind, fininstrPFI.t_fiid FIID, fininstrPFI.t_FaceValueFI BaseFIID " +
                    " FROM ddvdeal_dbt dvdeal, dnutxobj_dbt nutxObj, "+//®á­®¢ 
                    "     dfininstr_dbt fininstrPFI "+
                    "      WHERE dvdeal.t_State in ("+DVDEAL_STATE_PREP+","+DVDEAL_STATE_OPEN+")"+
                    "        and dvdeal.t_Client =  (case when ? = -1 then dvdeal.t_Client else ? end)"+        
                    "        and dvdeal.t_ClientContr = (case when ? = -1 then dvdeal.t_ClientContr else ? end)"+
                    "        and nutxObj.t_AnaliticKind1 = "+TXOBJ_KIND1090+
                    "        and nutxObj.t_Analitic1 = dvdeal.t_ID     "+
                    "        and nutxObj.t_Kind in ("+ NUTXobjKindListForSelect +")"+
                    "        and dvdeal.t_Date BETWEEN ? and ? "+
                    "        and fininstrPFI.t_FIID = dvdeal.t_FIID "
                    ;
              
        cmd.addParam(nutxPaidIncomDataForm.ClientID);
        cmd.addParam(nutxPaidIncomDataForm.ClientID);     
        cmd.addParam(nutxPaidIncomDataForm.ContractID);
        cmd.addParam(nutxPaidIncomDataForm.ContractID);        
        cmd.addParam(nutxPaidIncomDataForm.BeginDate);
        cmd.addParam(nutxPaidIncomDataForm.EndDate);

        return Query;
      END;    
     
      var Query = "";
      
      if ( nutxPaidIncomDataForm.KindDeal == REPPAID_DKIND_BUY  )
         Query = Query + ¯®«ãç¨âì‘¥«¥ªâ®ªã¯®ªŽ–(cmd);
      end;
      if ( nutxPaidIncomDataForm.KindDeal == REPPAID_DKIND_SALE )
         Query = Query + ¯®«ãç¨âì‘¥«¥ªâà®¤ ¦Ž–(cmd);
      end;
      if ( nutxPaidIncomDataForm.KindDeal == REPPAID_DKIND_REPO )
         Query = Query + ¯®«ãç¨âì‘¥«¥ªâ…ŽŽ–(cmd);
      end;
      if ( nutxPaidIncomDataForm.KindDeal == REPPAID_DKIND_REPAY )
         Query = Query + ¯®«ãç¨âì‘¥«¥ªâ®£ è¥­¨©(cmd);
      end;
      if ( nutxPaidIncomDataForm.KindDeal == REPPAID_DKIND_INCOM )
         Query = Query + ¯®«ãç¨âì‘¥«¥ªâ áç¥â„®å®¤ ®–(cmd);
      end;
      if ( nutxPaidIncomDataForm.KindDeal == REPPAID_DKIND_DV )
         Query = Query + ¯®«ãç¨âì‘¥«¥ªâ‘¤¥«ª¨”ˆ‘‘¨ŠŽ(cmd);
      end;
      if (nutxPaidIncomDataForm.KindDeal ==  REPPAID_DKIND_ALL)
         if(nutxPaidIncomDataForm.IsUseBO == SET_CHAR)
           Query = Query + ¯®«ãç¨âì‘¥«¥ªâ®ªã¯®ªŽ–(cmd) 
                         + " UNION ALL " + ¯®«ãç¨âì‘¥«¥ªâà®¤ ¦Ž–(cmd)  
                         + " UNION ALL " + ¯®«ãç¨âì‘¥«¥ªâ…ŽŽ–(cmd)
                         + " UNION ALL " + ¯®«ãç¨âì‘¥«¥ªâ®£ è¥­¨©(cmd);
         end;
         if(nutxPaidIncomDataForm.IsUseDep == SET_CHAR)
           if(Query != "")
             Query = Query + " UNION ALL ";
           end;
           Query = Query + ¯®«ãç¨âì‘¥«¥ªâ áç¥â„®å®¤ ®–(cmd);
         end;

         if(nutxPaidIncomDataForm.IsUseDV == SET_CHAR)
           if(Query != "")
             Query = Query + " UNION ALL ";
           end;
           Query = Query + ¯®«ãç¨âì‘¥«¥ªâ‘¤¥«ª¨”ˆ‘‘¨ŠŽ(cmd);
         end;
      end;


      Query =  "SELECT  nutxKind.t_Code nutxCode,   "+
               "        qObj.t_AnaliticKind1, "+
               "        RSI_NUTX.getIncomeSymbolsNUTX( ltrim(nutxKind.t_Code,'Plus_'), qObj.DocID, qObj.DocKind, NVL(PartyIssuer.t_PartyID, "+UnknownParty+"), qObj.FIID, qObj.BaseFIID ) nutxSymbol, " +
               "        PartyUN.t_Name ClientFullName, "+
               "        NVL((SELECT t_Adress FROM dadress_dbt WHERE t_Type = "+PTADDR_LEGAL+" AND t_PartyID = PartyUN.t_PartyID), CHR(1)) JurAdress, "+
               "        country.t_FullName CountryName, country.t_CodeNUM3 CountryCodeNum,   "
               "        NVL((SELECT t_Code "+
               "               FROM dobjcode_dbt "+
               "              WHERE t_ObjectID = PartyUN.t_PartyID "+
               "                AND t_ObjectType = "+OBJTYPE_PARTY+
               "                AND t_CodeKind = "+PTCK_INN+"  ), CHR(1)) CodeINN, "+ 
               "        NVL((SELECT t_Code "+
               "               FROM dobjcode_dbt "+
               "              WHERE t_ObjectID = PartyUN.t_PartyID "+
               "                AND t_ObjectType = "+OBJTYPE_PARTY+
               "                AND t_CodeKind = "+PTCK_SWIFT+"  ), CHR(1)) CodeBIC_SWIFT, "+ 
               "        qObj.t_Sum SumPlus, fininstrPlus.t_ISO_Number FinCodeNDR, qObj.t_Date CreateDateObj, "+
               "        NVL((SELECT t_Date "+
               "               FROM dnutxobj_dbt "+
               "              WHERE t_Kind = "+NUTXOBJ_PAIDTAX+
               "                AND t_Analitickind1 = qObj.t_Analitickind1 " +
               "                AND t_Analitic1 = qObj.t_Analitic1 " +
               "                AND t_Client = qObj.t_Client "+
               "                AND (   (t_Analitickind6 = qObj.t_Analitickind6 AND t_Analitic6 = qObj.t_Analitic6) "+
               "                     OR (t_Analitickind6 = 0 AND t_Analitic6 = -1)) "+
               "                AND ROWNUM = 1" +
               "            ),"+GetSQLDate(date(0,0,0))+") PaidTaxDate, "+ 
               "        NVL((SELECT DISTINCT t_Sum "+
               "               FROM dnutxobj_dbt "+
               "              WHERE t_Kind = "+NUTXOBJ_DUETAX+
               "                AND t_Analitickind1 = qObj.t_Analitickind1 "+
               "                AND t_Analitic1 = qObj.t_Analitic1 "+
               "                AND t_Client = qObj.t_Client "+
               "                AND (   (t_Analitickind6 = qObj.t_Analitickind6 AND t_Analitic6 = qObj.t_Analitic6) "+
               "                     OR (t_Analitickind6 = 0 AND t_Analitic6 = -1)) "+
               "                AND ROWNUM = 1" +
               "            ),0 ) SumDueTax, "+
               "        RSB_FIInstr.ConvSumType(1,fininstrPlus.t_fiid,"+NATCUR+",7"/*7 - ªãàá –. ¯® å®à®è¥¬ã, ª®­áâ ­âã ¡ë*/+", qObj.t_Date) RateOfPlus_xx, "+
               "        NVL("+//ªãàá Paid
               "             (SELECT "+
               "                      RSB_FIInstr.ConvSumType(1,fininstrPaid.t_fiid,"+NATCUR+",7"/*7 - ªãàá –. ¯® å®à®è¥¬ã, ª®­áâ ­âã ¡ë*/+", qObj.t_Date)  "+
               "                FROM  dfininstr_dbt fininstrPaid, dnutxobj_dbt nutxobjPaid "+
               "               WHERE fininstrPaid.t_fiid = qObj.t_Cur "+
               "                 AND nutxobjPaid.t_Kind = "+NUTXOBJ_PAIDTAX+ 
               "                 AND nutxobjPaid.t_Analitickind1 = qObj.t_Analitickind1 "+
               "                 AND nutxobjPaid.t_Analitic1 = qObj.t_Analitic1 "+
               "                 AND nutxobjPaid.t_Client = qObj.t_Client "+
               "                 AND (   (nutxobjPaid.t_Analitickind6 = qObj.t_Analitickind6 AND nutxobjPaid.t_Analitic6 = qObj.t_Analitic6) "+
               "                     OR (nutxobjPaid.t_Analitickind6 = 0 AND nutxobjPaid.t_Analitic6 = -1)) "+
               "                 AND ROWNUM = 1" +
               "             ),0)    RateOfPaid, "+
               "        NVL("+//ª®«-¢® ¯® ªãàáã Paid
               "             (SELECT "+
               "                      RSB_FIInstr.ConvSumType(nutxobjPaid.t_Sum, fininstrPaid.t_fiid,"+NATCUR+",7"/*7 - ªãàá –. ¯® å®à®è¥¬ã, ª®­áâ ­âã ¡ë*/+", qObj.t_Date)  "+
               "                FROM  dfininstr_dbt fininstrPaid, dnutxobj_dbt nutxobjPaid "+
               "               WHERE fininstrPaid.t_fiid = qObj.t_Cur "+
               "                 AND nutxobjPaid.t_Kind = "+NUTXOBJ_PAIDTAX+ 
               "                 AND nutxobjPaid.t_Analitickind1 = qObj.t_Analitickind1 "+
               "                 AND nutxobjPaid.t_Analitic1 = qObj.t_Analitic1 "+
               "                 AND nutxobjPaid.t_Client = qObj.t_Client "+
               "                 AND (   (nutxobjPaid.t_Analitickind6 = qObj.t_Analitickind6 AND nutxobjPaid.t_Analitic6 = qObj.t_Analitic6) "+
               "                     OR (nutxobjPaid.t_Analitickind6 = 0 AND nutxobjPaid.t_Analitic6 = -1)) "+
               "                 AND ROWNUM = 1" +
               "             ),0)    SumOfPaidInNatcur, "+
               "        RSB_FIInstr.ConvSumType(qObj.t_Sum,fininstrPlus.t_fiid,"+NATCUR+",7"/*7 - ªãàá –. ¯® å®à®è¥¬ã, ª®­áâ ­âã ¡ë*/+", qObj.t_Date) Plus_xxInNatcur, "+
               "        NVL(PartyIssuer.t_Name, CHR(1)) IssuerName, "+
               "        NVL(" +
               "              (SELECT DISTINCT t_Code" +
               "               FROM dobjcode_dbt" +
               "               WHERE t_ObjectID = NVL(PartyIssuer.t_PartyID, "+UnknownParty+")" +
               "                 and t_ObjectType = "+OBJTYPE_PARTY+
               "                 and t_CodeKind = "+PTCK_INN+
               "                 and ROWNUM = 1" +
               "              ),CHR(1)" +
               "           ) IssuerCodeINN, "+ 
               "        NVL(" +
               "              (SELECT t_Code" +
               "               FROM dobjcode_dbt" +
               "               WHERE t_ObjectID = PartyClient.t_PartyID" +
               "                 and t_ObjectType = "+OBJTYPE_PARTY+
               "                 and t_CodeKind = "+PTCK_STATEREGNUM+
               "              ),CHR(1)) ClientCodeStateRegnum, "+  
               "        NVL(" +
               "              (select t_Value" +
               "               from dcontact_dbt" +
               "               where t_PartyID = PartyClient.t_PartyID" +
               "                 and t_AddressType = "+PTADDR_LEGAL+
               "                 and t_ContactKind = "+CNTK_PHONE+
               "                 and t_ContactType = "+CNTT_MOBILE+
               "                 and t_IsMain = '"+SET_CHAR+
               "'             ),CHR(1) ) ClientPhone, "+
               "        NVL(" +
               "              (SELECT 1 FROM dpartyown_dbt" +
               "               WHERE t_PartyID = NVL(PartyUN.t_PartyID, "+UnknownParty+")" +
               "                 AND T_PartyKind = "+PTK_BANK+
               "              ), 0) IsBank, " +
               "        PartyClient.t_LegalForm LegalForm, "+
               "        PartyClient.t_NotResident NotResident "+
               "  FROM ("+Query+") qObj " +
               "       left join dparty_dbt PartyIssuer on PartyIssuer.t_PartyID = RSI_RSB_FIInstr.FI_GetIssuerOnDate(qObj.FIID, qObj.t_Date ), " + 
               "       dnutxkind_dbt nutxKind, dparty_dbt PartyUN, dparty_dbt PartyClient, dcountry_dbt country, dfininstr_dbt fininstrPlus " +
               " WHERE nutxKind.t_Element = qObj.t_Kind " +
               "   AND PartyClient.t_PartyID = qObj.t_Party " +
               "   AND PartyUN.t_PartyID = qObj.t_Client " +
               "   AND country.t_CodeLAT3 = PartyClient.t_NRCountry"+
               "   AND fininstrPlus.t_fiid = qObj.t_Cur"+
               " ORDER BY nutxCode, qObj.t_Date";

               //PartyUN - ž‹
               //PartyClient - ª«¨¥­â, ®â®¡à ¦ ¥¬ë© ¢ ä®à¬¥ „

      return Query;
    END;    
    
    
 //  REPPAID_DKIND_ALL       = 0, /*‚á¥*/
 //  REPPAID_DKIND_BUY       = 1, /*®ªã¯ª */
 //  REPPAID_DKIND_SALE      = 2, /*à®¤ ¦ */
 //  REPPAID_DKIND_REPO      = 3, /*…Ž*/
 //  REPPAID_DKIND_REPAY     = 4, /*®£ è¥­¨¥*/
 //  REPPAID_DKIND_INCOM     = 5, /* áç¥â ¤®å®¤  ¯® æ/¡*/
 //  REPPAID_DKIND_DV        = 6; /*‘¤¥«ª¨ ”ˆ*/
   
    
    var sqlSelect = DL_RSDCommand();
    var sqlQuery = ¯®«ãç¨âì‘¥«¥ªâ„«ïŽâç¥â (sqlSelect);
    
    Count = sqlSelect.GetCount(sqlQuery);

    if( Count > 0 )
       var RepData = sqlSelect.Execute(sqlQuery);

       InitProgress(Count, "à®á¬®âà ‘¤¥«®ª/Ž¡ê¥ªâ®¢ „", "à®á¬®âà ‘¤¥«®ª/Ž¡ê¥ªâ®¢ „");
       while( RepData.MoveNext() )
                           ¥ç â âì‘âà®ªã’ ¡«¨æë( 
                                    Num,
                                    IIF( SQL_ConvTypeInteger(RepData.AnaliticKind1) == TXOBJ_KIND1098, "18210101050011000110", "18210101030011000110"),//ª®¤ ŠŠ   <18210101050011000110> - ¤«ï ¢ë¯« âë ¨ ¢®§¢à â  ¤¨¢¨¤¥­¤®¢,    <18210101030011000110> -¢ ®áâ «ì­ëå á«ãç ïå.                                  
                                    SubStr( SQL_ConvTypeStr(RepData.nutxCode), Index(SQL_ConvTypeStr(RepData.nutxCode),"_")+1),//xx ¨§ Plus_xx
                                    IIF( SQL_ConvTypeInteger(RepData.IsBank) ==1,   SQL_ConvTypeInteger(RepData.nutxSymbol), ""),
                                    SQL_ConvTypeStr(RepData.ClientFullName),
                                    SQL_ConvTypeStr(RepData.jurAdress),//îà  ¤à¥á 
                                    SQL_ConvTypeStr(RepData.CountryName),//áâà ­ 
                                    SQL_ConvTypeStr(RepData.CountryCodeNum),                                 
                                    SQL_ConvTypeStr(RepData.CodeINN) + IIF(RepData.CodeBIC_SWIFT," / ", "") + SQL_ConvTypeStr(RepData.CodeBIC_SWIFT),//¤«ï ¨­­/¡¨ª á¬®âà¨¬ dobjcode_dbt. ®¡¦â ©¯ = 3, ®¡¦ ª®¤ ¯® ª«¨¥­âã
                                    SQL_ConvTypeSum(RepData.SumPlus),
                                    SQL_ConvTypeSum(RepData.SumPlus),
                                    SQL_ConvTypeStr(RepData.FinCodeNDR),
                                    SQL_ConvTypeDate(RepData.CreateDateObj),
                                    SQL_ConvTypeDate(RepData.PaidTaxDate),
                                    SQL_ConvTypeDate(RepData.PaidTaxDate)+1,//áà®ª ã¯« âë ­ «®£ 
                                    SQL_ConvTypeSum(RepData.SumDueTax)/SQL_ConvTypeSum(RepData.SumPlus)*100+"%",//¯à®æ¥­â­ ï áâ ¢ª  ­ «®£ 
                                    SQL_ConvTypeSum(RepData.SumDueTax),
                                    SQL_ConvTypeSum(RepData.SumDueTax),
                                    SQL_ConvTypeSum(RepData.RateOfPlus_xx),//ªãàá æ¡ ¢ «îâë ¤®å®¤ 
                                    SQL_ConvTypeSum(RepData.RateOfPaid),//ªãàá æ¡ ¢ «îâë ­ «®£ 
                                    SQL_ConvTypeSum(RepData.SumOfPaidInNatcur),//ã¤¥à¦ ­­ë© ­ «®£ ¢ ­ æ ¢ «îâ¥
                                    SQL_ConvTypeSum(RepData.SumOfPaidInNatcur),
                                    SQL_ConvTypeSum(RepData.Plus_xxInNatcur),//áã¬¬  ¤®å®¤  ¢ ­ æ ¢ «îâ¥
                                    SQL_ConvTypeSum(RepData.SumPlus)-SQL_ConvTypeSum(RepData.SumDueTax),                                    
                                    SQL_ConvTypeStr(RepData.IssuerName),
                                    SubStr( SQL_ConvTypeStr(RepData.IssuerCodeINN), 1, Index(SQL_ConvTypeStr(RepData.IssuerCodeINN),"/")-1),//ˆ ¬¬¨â¥­â 
                                    SubStr( SQL_ConvTypeStr(RepData.IssuerCodeINN),    Index(SQL_ConvTypeStr(RepData.IssuerCodeINN),"/")+1),//Š ¬¬¨â¥­â 
                                    IIF(SQL_ConvTypeInteger(RepData.LegalForm)==1, "žà¨¤¨ç¥áª®¥ «¨æ®, ","”¨§¨ç¥áª®¥ «¨æ®, ") + IIF(SQL_ConvTypeInteger(RepData.NotResident)==SET_CHAR,"­¥à¥§¨¤¥­â-”","à¥§¨¤¥­â-”"),//A27//à¨§­ ª «¨æ , ¨¬¥îé¥£® ä ªâ¨ç¥áª®¥ ¯à ¢® ­  ¤®å®¤
                                    "",//A28//¤ â  ¤®ªã¬¥­â 
                                    "",//A29//­®¬¥à ¤®ªã¬¥­â 
                                    SQL_ConvTypeStr(RepData.CountryCodeNum),//A30//ª®¤ áâà ­ë ž‹
                                    SQL_ConvTypeStr(RepData.ClientFullName),//A31//ˆ¬ï ž‹
                                    SQL_ConvTypeStr(RepData.CountryCodeNum),//A32//ª®¤ áâà ­ë
                                    SubStr( SQL_ConvTypeStr(RepData.CodeINN), 1, Index(SQL_ConvTypeStr(RepData.CodeINN),"/")-1),//ˆ ž‹
                                    SubStr( SQL_ConvTypeStr(RepData.CodeINN),    Index(SQL_ConvTypeStr(RepData.CodeINN),"/")+1),//Š ž‹
                                    SQL_ConvTypeStr(RepData.ClientCodeStateRegnum) + IIF ( (SQL_ConvTypeStr(RepData.CodeBIC_SWIFT) != "") and (SQL_ConvTypeStr(RepData.ClientCodeStateRegnum) != ""), " / ", "" ) +  SQL_ConvTypeStr(RepData.ClientCodeStateRegnum)  ,//A35//à¥£ ­®¬¥à ¨/¨«¨ swift
                                    SQL_ConvTypeStr(RepData.jurAdress),//A36//žà €¤à¥á áâà ­ë
                                    SQL_ConvTypeStr(RepData.ClientPhone)//A37//â¥«¥ä®­ î«­ (®á­®¢­®©)
                                  ); 
          UseProgress( Num = Num + 1 );
       end;
       RemProgress();
    end;


       if( not m_newSheet )
          EndTable();
          CopyAllSheetInTotalBook(m_CurrSheetName, false, GetTableRange(), 0, m_CurrSheetName, true);
          //PrintMainFooter();
          m_NoData = false;
       end;

       


  END;


  PRIVATE MACRO Create()

    var cmd, cmdData;

    SetActiveSheet("Žâçñâ ® ¢ë¯« ç¥­­ëå ¤®å®¤ å ž‹");
    m_NoData = true;

    var Query, NRecSql, NRecSqlRsd, NRec = 0, Num = 0;

    
    //¯®ª  çâ® ¬ á«® ¬ á«ï­­®¥, ¡¥àñ¬ ­ è ¡ ­ª ¨ ¢¯¥àñ¤ ¯¥ç â âì ®âçñâë.
    //¥¦¥«¨ ¯®­ ¤®¡¨âáï ¯® ä¨«¨ « ¬ ®â¤¥«ì­® - ¯à¨¬¥à ¬®¦­® ¯®á¬®âà¥âì ¢ dlactinacc.mac
    //Query = " select * from ddp_dep_dbt order by t_code ";
    Query = " select * from ddp_dep_dbt where t_PartyID ="+ {OurBank} +" order by t_code ";

    NRecSql = RSDCommand("select count(1) NRec from ("+Query+")");
    NRecSql.execute();
    NRecSqlRsd = TRsbDataSet(NRecSql);

    if( NRecSqlRsd.MoveNext() and (NRecSqlRsd.NRec!=null) )
       NRec = int(NRecSqlRsd.NRec);
    end;

    if( NRec > 0 )
       cmd = RSDCommand(Query);
       cmd.execute();
       cmdData = TRsbDataSet(cmd);

       cmdData.Movenext(); 
          m_DepID   = cmdData.PartyID;
          m_DepCode = cmdData.Code;
           m_newSheet = true;
          ¥ç â âì„ ­­ë¥();
     end;

    if( m_NoData == true )
       PrintFormatString("#", "N1_ReportRunFalse", "¥â ¤ ­­ëå ¤«ï ä®à¬¨à®¢ ­¨ï ®âç¥â .");
       CopyAllSheetInTotalBook(null, false, "N1_ReportRunFalse", 0, null, true);
    end;
    

  END;

  initDL_CReportTemplate(PAID_INCOME_Panel(), "Report_nutxPaidIncome.xls", true);
END;
var R = DL_ULN_PaidIncome_Report();
R.Run(null, "QWERTY"/*§ âëçª  ¤«ï  ¢â®ä®à¬¨à®¢ ­¨ï «®£- ã¤¨â . ¢â®à®© ¯ à ¬¥âà … ­ã«ì*/ );
exit(1);
