/*
$Name:        dlactjournal.mac
$Module:      Ценные бумаги
$Description: Макрос печати выделенных записей из журнала актов сверки.
&Autor:       Речкалов И.К.
*/
import "DLReport_h.mac", "dlmisc.mac", "dlreport.mac";

PRIVATE CLASS (DL_CReportTemplate) CPrintScrol( BegDate:Date, EndDate:Date )
  PRIVATE VAR m_RS, m_NumRec = 0,
              m_BegDate = BegDate,
              m_EndDate = EndDate;
  PRIVATE MACRO IIF( condition, value_true, value_false )
   if( condition )
      return value_true;
   else 
      return value_false;
   end;
  END;              
  PRIVATE MACRO GetCurrentOperName( ) : string
  
  var OperName : string;

  file person("person.dbt") key 0;

  OperName = "";

  person.Oper = {Oper};
  if( GetEQ(person) )
    
    OperName = person.Name;

  end;

  return OperName;

   END;
  PRIVATE MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;
  PRIVATE MACRO GetDepNameByCurrOper():STRING
    var Query = " Select pt.t_shortname from dparty_dbt pt                              "+
                "        join ddp_dep_dbt dep on dep.t_partyId = pt.t_partyId           "+
                "        join dperson_dbt ps  on dep.t_code    = ps.t_codedepart        "+
                "                            and  ps.t_oper    = " + {oper};
    var DepName;
    var cmd = RSDCommand(Query);
        cmd.execute();
    var cmdData = TRsbDataSet(cmd);
    if( cmdData.MoveNext() )
          DepName   = cmdData.shortname;
    end;
    return DepName;
                
  END;
  PRIVATE MACRO PrintReportHead()
    var Header = 
                 "Филиал: #\n"+
                 "ЖУРНАЛ ПРОВЕДЕНИЯ СВЕРОК ВНУТРЕННЕГО УЧЕТА\n"+
                 "За период: # #\n";
    PrintFormatString(  Header,
                        //"N1_H1_1", m_DepCode,//найти, как получить имя филиала....
                        "N1_H1_1", "Филиал:" + GetDepNameByCurrOper(),
                        "N1_H2_1", m_BegDate,
                        "N1_H2_2", IIF ( m_BegDate == m_EndDate, " ", m_EndDate)
                     );              
                 
     //CopyAllSheetInTotalBook( NULL, false, "N1_RepHeader", 0 );
  END;
  PRIVATE MACRO BeginReport( NumCopy:INTEGER )
     RegisterTable("N1_MainTable", "N1_RepHeader",
                     "N1_A1"    ,
                     "N1_A2"    ,
                     "N1_A3"    ,
                     "N1_A4"    ,
                     "N1_A5"    ,
                     "N1_A6"    ,
                     "N1_A7"    );
     
     PrintReportHead();
     this.SetActiveSheet( "журнал актов сверок ВУ" );
  END;
  PRIVATE MACRO EndReport()
      var Header ="#";
    PrintFormatString(  Header,
                        "N1_F1", GetCurrentOperName()
                     );  
     EndTable();
  END;
  /*
  ** три заплаточки для перевода "дд.мм.гггг (час:мин:сек:миллисек)" и "(час:мин:сек:миллисек)"
  ** в дд.мм.гггг
  ** и час:мин:сек:
  */
  MACRO GETDATE():date
     return m_RS.DATE;
  END;
  MACRO GETREPDATE():date
     return m_RS.REPDATE;
  END;
  MACRO GETTIME():time
     return m_RS.TIME;
  END;
  MACRO ПечататьСтрокуТаблицы()
     PrintTableLine( "N1_A1"    , GETDATE(),      null,
                     "N1_A2"    , GETTIME(),      null,
                     "N1_A3"    , GETREPDATE(),   null,
                     "N1_A4"    , m_RS.OPER,      null,
                     "N1_A5"    , m_RS.REPKIND,   null,
                     "N1_A6"    , m_RS.RESULT,    null,
                     "N1_A7"    , " ",            null
                   );
  END;                                                
  PRIVATE MACRO GetNRecs()
      var dataSet = TRsbDataSet( "select count(1) nRecs from ddl_journal_tmp ");

      if( dataSet.moveNext() ) 
          return Int(dataSet.nRecs);
      end;
      return 0;
  END;
  PRIVATE MACRO Create()
  
    
    
    this.SetActiveSheet( "журнал актов сверок ВУ" );
     InitProgress( GetNRecs(), "Печать скроллинга", "Печать скроллинга" );

     m_RS = TRsbDataSet( "select * from ddl_journal_tmp order by t_date");

     while( m_RS.MoveNext() )
        ПечататьСтрокуТаблицы();

        UseProgress( m_NumRec = m_NumRec + 1 );
     end;
     //потом не плохо было бы научиться верно формировать отчёт, если есть ошибка
     //а пока что так:
     PrintFormatString("#", "N1_ReportRunFalse", " ");
     RemProgress();
  END;
  initDL_CReportTemplate( NULL, "Report_DLActJournal.xls" );
END;
MACRO PrintDlActJournal(BegDate:DATE, EndDate:DATE )
  CPrintScrol( BegDate, EndDate ).Run();
  exit( 1 );
END;

