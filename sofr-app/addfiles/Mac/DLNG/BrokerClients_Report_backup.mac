/*
$Name:        BrokerClients_Report.mac
$Module:      БО ЦБ, ФИССиКО, УВ
$Description: Отчет о клиентах на брокерском обслуживании
*/
import "DlReport_h.mac", "BrokerClients_Form", spserv, "dvserv.mac", "vaopr.mac",SfInter;

PRIVATE CONST POI_MODE = FALSE;

PRIVATE VAR ParallelLevel = 8;
PRIVATE VAR PartitionCount = 10;

PRIVATE MACRO GetSessionID():Integer
  var id:Integer = -1;
  var sql = "SELECT SYS_CONTEXT('USERENV','SESSIONID') SessionID FROM DUAL";
  var cmd = DL_RSDCommand(sql);
  var ds = cmd.execute();
  if( ds.MoveNext() )
    id = int(ds.SessionID);
  end;
  return id;
END;


PRIVATE CLASS (DL_CReportTemplate) ClBORep
  var MainIDLink = TArray(8);
  var SessionID = GetSessionID();

  // Типы задолженностей
  PRIVATE CONST ARREAR_TYPE_NOT_REPO = "По сделкам, кроме РЕПО",
                ARREAR_TYPE_REPO     = "По сделкам РЕПО";

  PRIVATE CONST SHEET_IN_OUT_CUR = "Расшифровка движения ДС",
                SHEET_IN_OUT_SEC = "Расшифровка движения ЦБ";

  PRIVATE CONST OPER_KIND_ENROL  = "Зачисление",
                OPER_KIND_WRTOFF = "Списание";

  PRIVATE MACRO PrintMode():INTEGER
    RETURN DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO GetGroupAttrNames(Group: Integer, LegalForm: @Variant, Resid: @Variant, QI: @Variant)
    LegalForm = IIF(Group / 4 == 0, "ФИЗ", "ЮР");
    Resid = IIF(Mod(Group / 2, 2) == 0, "РЕЗ", "НЕРЕЗ");
    QI = IIF(Mod(Group, 2) == 0, "КВАЛ", "НЕКВАЛ");
  END;

  PRIVATE MACRO PrintReport_7()
    var cmd, DataSet, cnt = 0, NumStr = 1;
    var ProgressIndicator = TProgressBar();
    var EndDate = m_Form.EndDate;

    SetActiveSheet( "7" );
    RegisterTable("N3_MainTable", "",
                  "N3_ID",
                  "N3_MainID",
                  "N3_CurrCode",
                  "N3_CurrRest",
                  "N3_CurrRestRub");

    cmd = DL_RSDCommand("  SELECT rest.t_MainId,                                     "
                        "         (SELECT t_ISO_Number                               "
                        "            FROM dfininstr_dbt                              "
                        "           WHERE t_FIID = rest.t_Cur)                       "
                        "            t_ISONumber,                                    "
                        "         SUM (rest.t_Rest) t_Rest,                          "
                        "         CASE rest.t_Cur                                    "
                        "            WHEN 0 THEN SUM (rest.t_Rest)                   "
                        "            ELSE RSB_FIINSTR.CONVSUM (SUM (rest.t_Rest),    "
                        "                                       rest.t_Cur, 0, ?, 4) "
                        "         END                                                "
                        "            t_RestNatCur                                    "
                        "    FROM ddlclborestac_dbt rest                             "
                        "   WHERE rest.t_SessionID = ?                               "
                        " GROUP BY rest.t_MainId, rest.t_Cur                         "
                        "   HAVING SUM (rest.t_Rest) <> 0                            "
                        " ORDER BY rest.t_MainId, rest.t_Cur                         ");

    cmd.AddParam(EndDate);
    cmd.AddParam(SessionID);

    cnt = cmd.GetCount();
    IF ( cnt > 0 )
      ProgressIndicator.init(cnt, "Вывод данных расшифровки по д/с", "Вывод данных расшифровки по д/с");
      DataSet = cmd.Execute();

      WHILE (DataSet.MoveNext())     
        PrintTableLine( "N3_ID",          NumStr,                     NULL,
                        "N3_MainID",      MainIDLink[DataSet.MainId], NULL,        
                        "N3_CurrCode",    DataSet.ISONumber,          NULL,
                        "N3_CurrRest",    DataSet.Rest,               2,
                        "N3_CurrRestRub", DataSet.RestNatCur,         2);

        NumStr = NumStr + 1;

        ProgressIndicator.Use;
      END;

      ProgressIndicator.Remove;
    END;

    EndTable();
  END;

  PRIVATE MACRO PrintReport_8()
    SetActiveSheet( "8" );
    RegisterTable("N4_MainTable", "");

    EndTable();
  END;

  PRIVATE MACRO PrintReport_9_17()
    var cmd, DataSet, cnt = 0, NumStr = 1;
    var ProgressIndicator = TProgressBar();

    SetActiveSheet( "9-17" );
    RegisterTable("N5_MainTable", "",
                  "N5_ID",
                  "N5_MainID",
                  "N5_Name",
                  "N5_CountryCode",
                  "N5_INNorTIN",
                  "N5_AvoirType",
                  "N5_IssueNumber",
                  "N5_ISIN",
                  "N5_BAID",
                  "N5_CurrCode",
                  "N5_BAKind",
                  "N5_Quantity",
                  "N5_Value");

    cmd = DL_RSDCommand(" SELECT t_MainId, "
                      + "        t_Name, "
                      + "        t_CountryCode, "
                      + "        t_INNorTIN, "
                      + "        t_AvoirType, "
                      + "        t_IssueNumber, "
                      + "        t_ISIN, "
                      + "        t_BAID, "
                      + "        t_CurrCode, "
                      + "        (CASE t_BAKind  "
                      + "            WHEN 0 THEN 'Акции' "
                      + "            WHEN 1 THEN 'Облигации' "
                      + "            WHEN 2 THEN 'Паи' "
                      + "            WHEN 3 THEN 'Иное' "
                      + "        END) t_BAKind, " 
                      + "        SUM(t_Quantity) t_Quantity, "
                      + "        SUM(t_Value) t_Value "
                      + "   FROM ddlclboavoir_dbt "
                      + "  WHERE t_SessionID = ? "
                      + " GROUP BY t_MainId, t_Name, t_CountryCode, t_INNorTIN, t_AvoirType, t_IssueNumber, t_ISIN, t_BAID, t_CurrCode, t_BAKind "
                      + " ORDER BY t_MainID ");
    cmd.AddParam(SessionID);

    cnt = cmd.GetCount();
    IF ( cnt > 0 )
      ProgressIndicator.init(cnt, "Вывод данных расшифровки по ц/б", "Вывод данных расшифровки по ц/б");
      DataSet = cmd.Execute();

      WHILE (DataSet.MoveNext())
        PrintTableLine( "N5_ID",          NumStr,                     NULL,
                        "N5_MainID",      MainIDLink[DataSet.MainID], NULL,
                        "N5_Name",        DataSet.Name,               NULL,
                        "N5_CountryCode", DataSet.CountryCode,        NULL,
                        "N5_INNorTIN",    DataSet.INNorTIN,           NULL,
                        "N5_AvoirType",   DataSet.AvoirType,          NULL,
                        "N5_IssueNumber", DataSet.IssueNumber,        NULL,
                        "N5_ISIN",        DataSet.ISIN,               NULL,
                        "N5_BAID",        DataSet.BAID,               NULL,
                        "N5_CurrCode",    DataSet.CurrCode,           NULL,
                        "N5_BAKind",      DataSet.BAKind,             NULL,
                        "N5_Quantity",    DataSet.Quantity,           IIF((DataSet.AvoirType=="SHS7") OR (DataSet.AvoirType=="SHS8"),5,0), //Для паев отображается 5 знаков после запятой
                        "N5_Value",       DataSet.Value,              2);

        NumStr = NumStr + 1;

        ProgressIndicator.Use;
      END;

      ProgressIndicator.Remove;
    END;

    EndTable();
  END;

  PRIVATE MACRO PrintReport_18()
    SetActiveSheet( "18" );
    RegisterTable("N6_MainTable", "");

    EndTable();
  END;

  PRIVATE MACRO PrintReport_20()
    SetActiveSheet( "20" );
    RegisterTable("N7_MainTable", "");

    EndTable();
  END;

  PRIVATE MACRO PrintReport_22()
    SetActiveSheet( "22" );
    RegisterTable("N8_MainTable", "");

    EndTable();
  END;

  PRIVATE MACRO PrintReport_24()
    var query, cmd, DataSet, cnt = 0, NumStr = 1;
    var ProgressIndicator = TProgressBar();

    SetActiveSheet( "24" );
    RegisterTable("N9_MainTable", "",
                  "N9_ID",
                  "N9_MainID",
                  "N9_PFIType",
                  "N9_ExtCode",
                  "N9_ExtName",
                  "N9_Name",
                  "N9_DealSide",
                  "N9_Quantity",
                  "N9_Value");

    query = " SELECT t_MainID, "
          + "        t_PFIType, "
          + "        t_ExtCode, "
          + "        t_ExtName, "
          + "        t_DealSide, "
          + "        Sum(t_Quantity) t_QuantitySum, "
          + "        Sum(t_Value) t_ValueSum" 
          + "   FROM ddlclbopfi_dbt "
          + "  WHERE t_SessionID = ? "
          + "  GROUP BY t_MainID, t_PFIType, t_GroupFIID, t_ExtCode, t_ExtName, t_DealSide " 
          + "  ORDER BY t_MainID, t_PFIType, t_ExtCode, t_ExtName, t_DealSide desc ";
    cmd = DL_RSDCommand(query);
    cmd.AddParam(SessionID);

    cnt = cmd.GetCount();
    if( cnt > 0 )
       ProgressIndicator.init(cnt, "Вывод данных расшифровки по ПФИ", "Вывод данных расшифровки по ПФИ");
       DataSet = cmd.Execute(query);
     
       while( DataSet.MoveNext() )
          PrintTableLine( "N9_ID",       NumStr,                     null,
                          "N9_MainID",   MainIDLink[DataSet.MainID], null,  
                          "N9_PFIType",  DataSet.PFIType,            null, 
                          "N9_ExtCode",  DataSet.ExtCode,            null,
                          "N9_ExtName",  DataSet.ExtName,            null,
                          "N9_Name",     "",                         null,
                          "N9_DealSide", DataSet.DealSide,           null,
                          "N9_Quantity", DataSet.QuantitySum,        0,
                          "N9_Value",    DataSet.ValueSum,           2
                        );
          NumStr = NumStr + 1;

          ProgressIndicator.Use;
       end;
     
       ProgressIndicator.Remove;
    end;

    EndTable();
  END;

  PRIVATE MACRO PrintReport_26_29()
    var query, cmd, DataSet, cnt = 0, NumStr = 1;
    var ProgressIndicator = TProgressBar();

    SetActiveSheet( "26-29" );
    RegisterTable("N10_MainTable", "",
                  "N10_ID",
                  "N10_MainID",
                  "N10_ArrearType",
                  "N10_Side",
                  "N10_WithCentralContr",
                  "N10_ContractorName",
                  "N10_ContractorINN",
                  "N10_Sum");

    query = " SELECT t_MainID, "
          + "        t_ArrearType, "
          + "        t_Side, "
          + "        t_WithCentralContr, "
          + "        t_ContractorName, "
          + "        t_ContractorINN, "
          + "        Sum(t_Value) t_ValueSum" 
          + "   FROM ddlclboarrear_dbt "
          + "  WHERE t_SessionID = ? "
          + "  GROUP BY t_MainID, t_IsDebit, t_ArrearType, t_Side, t_ContractorID, t_WithCentralContr, t_ContractorName, t_ContractorINN, "
          + "           case when t_DocKind = "+DL_DVFXDEAL+" then "+DL_DVNDEAL+" else t_DocKind end "  //Объединяем валютную секцию
          + " HAVING t_IsDebit = 'X' "      //Только дебиторская задолженность!!!
          + "  ORDER BY t_MainID, t_ArrearType, t_Side, t_WithCentralContr, t_ContractorName "; 

    cmd = DL_RSDCommand(query);
    cmd.AddParam(SessionID);

    cnt = cmd.GetCount();
    if( cnt > 0 )
       ProgressIndicator.init(cnt, "Вывод данных расшифровки по дебиторской задолженности", "Вывод данных расшифровки по дебиторской задолженности");
       DataSet = cmd.Execute(query);
     
       while( DataSet.MoveNext() )
          PrintTableLine( "N10_ID",               NumStr,                     null,
                          "N10_MainID",           MainIDLink[DataSet.MainID], null, 
                          "N10_ArrearType",       DataSet.ArrearType,         null, 
                          "N10_Side",             DataSet.Side,               null,
                          "N10_WithCentralContr", DataSet.WithCentralContr,   null,
                          "N10_ContractorName",   DataSet.ContractorName,     null,
                          "N10_ContractorINN",    DataSet.ContractorINN,      null,
                          "N10_Sum",              DataSet.ValueSum,           2
                        );
          NumStr = NumStr + 1;

          ProgressIndicator.Use;
       end;
     
       ProgressIndicator.Remove;
    end;

    EndTable();
  END;

  PRIVATE MACRO PrintReport_31_34()
    var query, cmd, DataSet, cnt = 0, NumStr = 1;
    var ProgressIndicator = TProgressBar();

    SetActiveSheet( "31-34" );
    RegisterTable("N11_MainTable", "",
                  "N11_ID",
                  "N11_MainID",
                  "N11_ArrearType",
                  "N11_Side",
                  "N11_WithCentralContr",
                  "N11_ContractorName",
                  "N11_ContractorINN",
                  "N11_Sum");

    query = " SELECT t_MainID, "
          + "        t_ArrearType, "
          + "        t_Side, "
          + "        t_WithCentralContr, "
          + "        t_ContractorName, "
          + "        t_ContractorINN, "
          + "        Sum(t_Value) t_ValueSum" 
          + "   FROM ddlclboarrear_dbt "
          + "  WHERE t_SessionID = ? "
          + "  GROUP BY t_MainID, t_IsDebit, t_ArrearType, t_Side, t_ContractorID, t_WithCentralContr, t_ContractorName, t_ContractorINN, "
          + "           case when t_DocKind = "+DL_DVFXDEAL+" then "+DL_DVNDEAL+" else t_DocKind end "  //Объединяем валютную секцию
          + " HAVING t_IsDebit <> 'X' "     //Только кредиторская задолженность!!!
          + "  ORDER BY t_MainID, t_ArrearType, t_Side, t_WithCentralContr, t_ContractorName "; 

    cmd = DL_RSDCommand(query);
    cmd.AddParam(SessionID);

    cnt = cmd.GetCount();
    if( cnt > 0 )
       ProgressIndicator.init(cnt, "Вывод данных расшифровки по кредиторской задолженности", "Вывод данных расшифровки по кредиторской задолженности");
       DataSet = cmd.Execute(query);
     
       while( DataSet.MoveNext() )
          PrintTableLine( "N11_ID",               NumStr,                     null,
                          "N11_MainID",           MainIDLink[DataSet.MainID], null, 
                          "N11_ArrearType",       DataSet.ArrearType,         null, 
                          "N11_Side",             DataSet.Side,               null,
                          "N11_WithCentralContr", DataSet.WithCentralContr,   null,
                          "N11_ContractorName",   DataSet.ContractorName,     null,
                          "N11_ContractorINN",    DataSet.ContractorINN,      null,
                          "N11_Sum",              DataSet.ValueSum,           2
                        );
          NumStr = NumStr + 1;

          ProgressIndicator.Use;
       end;
     
       ProgressIndicator.Remove;
    end;

    EndTable();
  END;

  PRIVATE MACRO PrintReport_InOutCur()
    var query, cmd, DataSet, cnt = 0, NumStr = 1;
    var ProgressIndicator = TProgressBar();

    SetActiveSheet( SHEET_IN_OUT_CUR );
    RegisterTable("N12_MainTable", "",
                  "N12_ID",
                  "N12_MainID",
                  "N12_Client",
                  "N12_OpCode",
                  "N12_OpKind",
                  "N12_Date",
                  "N12_CurrCode",
                  "N12_Sum",
                  "N12_SumRub");

    query = " SELECT t_MainId, "
          + "        t_ClientCode, "
          + "        t_OpCode, "
          + "        t_IsEnrol, "
          + "        t_Date, "
          + "        t_CurrCode, "
          + "        t_Sum, "
          + "        t_SumRub "
          + "   FROM ddlclboinoutcur_dbt "
          + "  WHERE t_SessionID = ? "
          + " ORDER BY t_MainId, t_ClientCode, t_Date ";

    cmd = DL_RSDCommand(query);
    cmd.AddParam(SessionID);

    cnt = cmd.GetCount();
    if( cnt > 0 )
       ProgressIndicator.init(cnt, "Вывод данных расшифровки по движению д/с", "Вывод данных расшифровки по движению д/с");
       DataSet = cmd.Execute(query);
     
       while( DataSet.MoveNext() )
          var OpKind = IIF(DataSet.IsEnrol == SET_CHAR, OPER_KIND_ENROL, OPER_KIND_WRTOFF);

          PrintTableLine( "N12_ID",       NumStr,                     null,
                          "N12_MainID",   MainIDLink[DataSet.MainID], null,
                          "N12_Client",   DataSet.ClientCode,         null,
                          "N12_OpCode",   DataSet.OpCode,             null,
                          "N12_OpKind",   OpKind,                     null,
                          "N12_Date",     Date(DataSet.Date),         null,
                          "N12_CurrCode", DataSet.CurrCode,           null,
                          "N12_Sum",      DataSet.Sum,                2,
                          "N12_SumRub",   DataSet.SumRub,             2);
          NumStr = NumStr + 1;

          ProgressIndicator.Use;
       end;
     
       ProgressIndicator.Remove;
    end;

    EndTable();
  END;

  PRIVATE MACRO PrintReport_InOutSec()
    var query, cmd, DataSet, cnt = 0, NumStr = 1;
    var ProgressIndicator = TProgressBar();

    SetActiveSheet( SHEET_IN_OUT_SEC );
    RegisterTable("N13_MainTable", "",
                  "N13_ID",
                  "N13_MainID",
                  "N13_Client",
                  "N13_OpCode",
                  "N13_OpKind",
                  "N13_Date",
                  "N13_AvoirName",
                  "N13_FaceValueFI",
                  "N13_ISIN",
                  "N13_AvoirType",
                  "N13_Quantity",
                  "N13_Course",
                  "N13_Cost",
                  "N13_SumRub");

    query = " SELECT t_MainId, "
          + "        t_ClientCode, "
          + "        t_OpCode, "
          + "        t_IsEnrol, "
          + "        t_Date, "
          + "        t_AvoirName, "
          + "        t_FaceValueFI, "
          + "        t_ISIN, "
          + "        t_AvoirType, "
          + "        t_Quantity, "
          + "        t_Course, "
          + "        t_Cost, "
          + "        t_SumRub "
          + "   FROM ddlclboinoutsec_dbt "
          + "  WHERE t_SessionID = ? "
          + " ORDER BY t_MainId, t_ClientCode, t_Date ";

    cmd = DL_RSDCommand(query);
    cmd.AddParam(SEssionID);

    cnt = cmd.GetCount();
    if( cnt > 0 )
       ProgressIndicator.init(cnt, "Вывод данных расшифровки по движению ц/б", "Вывод данных расшифровки по движению ц/б");
       DataSet = cmd.Execute(query);
     
       while( DataSet.MoveNext() )
          var OpKind = IIF(DataSet.IsEnrol == SET_CHAR, OPER_KIND_ENROL, OPER_KIND_WRTOFF);

          PrintTableLine( "N13_ID",          NumStr,                     null,
                          "N13_MainID",      MainIDLink[DataSet.MainID], null,
                          "N13_Client",      DataSet.ClientCode,         null,
                          "N13_OpCode",      DataSet.OpCode,             null,
                          "N13_OpKind",      OpKind,                     null,
                          "N13_Date",        Date(DataSet.Date),         null,
                          "N13_AvoirName",   DataSet.AvoirName,          null,
                          "N13_FaceValueFI", DataSet.FaceValueFI,        null,
                          "N13_ISIN",        DataSet.ISIN,               null,
                          "N13_AvoirType",   DataSet.AvoirType,          null,
                          "N13_Quantity",    DataSet.Quantity,           2,
                          "N13_Course",      DataSet.Course,             2,
                          "N13_Cost",        DataSet.Cost,               2,
                          "N13_SumRub",      DataSet.SumRub,             2);
          NumStr = NumStr + 1;

          ProgressIndicator.Use;
       end;
     
       ProgressIndicator.Remove;
    end;

    EndTable();
  END;

  PRIVATE MACRO PrintReport()
    var cmd, Group, NumStr = 1;
    var RestDS, MetalRestDS, AvrDS, PfiDS, ArrearDS, InOutCurDS, InOutSecDS;
    var AssetTotalValue = $0, DebitTotalValue = $0, KreditTotalValue = $0, InTotalValue = $0, OutTotalValue = $0;
    var ProgressIndicator = TProgressBar();

    SetActiveSheet("Req");
    PrintFormatString("",
                      "N1_T1", m_Form.EndDate + 1,
                      "N1_T2", {INN_Bank},
                      "N1_T3", {Name_Bank},
                      "N1_T4", "",
                      "N1_T5", {Name_Oper} );

    SetActiveSheet( "Data" );

    RegisterTable("N2_MainTable", ""
                  "N2_ID",
                  "N2_GrLegalForm",
                  "N2_GrQI",
                  "N2_GrResid",
                  "N2_GrStdStrategy",
                  "N2_GrIsStd",

                  "N2_AssetCurr",
                  "N2_AssetDeposit",
                  "N2_AssetSecurBond",
                  "N2_AssetSecurDepoCert",
                  "N2_AssetSecurSavingCert",
                  "N2_AssetSecurShare",
                  "N2_AssetSecurInvShare",
                  "N2_AssetSecurBill",
                  "N2_AssetSecurDepoRec",
                  "N2_AssetSecurKSU",
                  "N2_AssetSecurOther",
                  "N2_AssetRealty",
                  "N2_AssetRent",
                  "N2_AssetEstate",
                  "N2_AssetReq",
                  "N2_AssetOther",
                  "N2_AssetMetal",
                  "N2_AssetPFI",
                  "N2_AssetTotal",

                  "N2_DebitDeal",
                  "N2_DebitREPO",
                  "N2_DebitNDeal",
                  "N2_DebitOther",
                  "N2_DebitTotal",

                  "N2_KreditDeal",
                  "N2_KreditREPO",
                  "N2_KreditNDeal",
                  "N2_KreditOther",
                  "N2_KreditTotal",

                  "N2_InCurr",
                  "N2_InSecur",
                  "N2_InOther",
                  "N2_InTotal",
                  "N2_OutCurr",
                  "N2_OutSecur",
                  "N2_OutOther",
                  "N2_OutTotal");

    ProgressIndicator.init(8, "Вывод данных о группах клиентов на брокерском обслуживании", "Вывод данных о группах клиентов на брокерском обслуживании");

    FOR (Group, 0, 7)
      var legalForm, resid, qi;
      GetGroupAttrNames(Group, @legalForm, @resid, @qi);

      cmd = DL_RSDCommand(" SELECT t_MainId, ROUND (SUM (t_RestNatCur), 0) t_TotalRestNatCur "
                        + " FROM (SELECT rest.t_MainId,                                      "
                        + "              CASE rest.t_Cur                                     "
                        + "                 WHEN 0 THEN SUM (rest.t_Rest)                    "
                        + "                 ELSE RSB_FIINSTR.CONVSUM (SUM (rest.t_Rest),     "
                        + "                                           rest.t_Cur, 0, ?, 4)   "
                        + "              END                                                 "
                        + "                 t_RestNatCur                                     "
                        + "         FROM ddlclborestac_dbt rest                              "
                        + "        WHERE rest.t_SessionID = ?                                "
                        + "          AND rest.t_MainId = " + String(Group)
                        + "     GROUP BY rest.t_MainId, rest.t_Cur )                         "
                        + " GROUP BY t_MainId                                                ");
      cmd.AddParam(m_Form.EndDate);
      cmd.AddParam(SessionID);
      RestDS = cmd.Execute();
      RestDS.MoveNext();

      cmd = DL_RSDCommand(" SELECT t_MainId, ROUND (SUM (t_Rest), 0) t_TotalRest "
                        + "   FROM ddlclbometalrestac_dbt                        "
                        + "  WHERE t_SessionID = ?                               "
                        + "    AND t_MainId = " + String(Group)
                        + " GROUP BY t_MainId                                    ");
      cmd.AddParam(SessionID);
      MetalRestDS = cmd.Execute();
      MetalRestDS.MoveNext();

      cmd = DL_RSDCommand(" SELECT t_MainId, "
                        + "      ROUND (SUM (CASE "
                        + "          WHEN avr.t_AvoirType IN ('BON1', 'BON2', 'BON3', 'BON4', 'BON5', 'BON6', 'BON7', 'SN1', 'SN2', 'SN3', 'SN4') "
                        + "          THEN avr.t_Value ELSE 0 "
                        + "       END), 0) "
                        + "         t_BondValue, "
                        + "      ROUND (SUM (CASE WHEN avr.t_AvoirType IN ('DS1', 'DS2') THEN avr.t_Value ELSE 0 END), 0) t_DepoCertValue, "
                        + "      ROUND (SUM (CASE WHEN avr.t_AvoirType IN ('SS1', 'SS2') THEN avr.t_Value ELSE 0 END), 0) t_SavingCertValue, "
                        + "      ROUND (SUM (CASE "
                        + "          WHEN avr.t_AvoirType IN ('SHS1', 'SHS2', 'SHS3', 'SHS4', 'SHS5', 'SHS6') "
                        + "          THEN avr.t_Value ELSE 0 "
                        + "       END), 0) "
                        + "         t_ShareValue, "
                        + "      ROUND (SUM (CASE WHEN avr.t_AvoirType IN ('SHS7', 'SHS8') THEN avr.t_Value ELSE 0 END), 0) t_InvShareValue, "
                        + "      ROUND (SUM (CASE "
                        + "          WHEN avr.t_avoirtype IN ('BIL1', 'BIL2', 'BIL3', 'BIL4', 'BIL5', 'BIL6', 'BIL7') "
                        + "          THEN avr.t_Value ELSE 0 "
                        + "       END), 0) "
                        + "         t_BillValue, "
                        + "      ROUND (SUM (CASE WHEN avr.t_AvoirType = 'DR' THEN avr.t_Value ELSE 0 END), 0) t_DepoRecValue, "
                        + "      ROUND (SUM (CASE WHEN avr.t_avoirtype = 'KSU' THEN avr.t_Value ELSE 0 END), 0) t_KSUValue, "
                        + "      ROUND (SUM (CASE WHEN avr.t_AvoirType IN ('ISU', 'OTHER') THEN avr.t_Value ELSE 0 END), 0) t_OtherValue "
                        + " FROM ddlclboavoir_dbt avr "
                        + " WHERE avr.t_SessionID = ? "
                        + "   AND avr.t_MainId = " + String(Group)
                        + " GROUP BY avr.t_MainId " );
      cmd.AddParam(SessionID);
      AvrDS = cmd.Execute();
      AvrDS.MoveNext();

      cmd = DL_RSDCommand(" SELECT pfi.t_MainId, "
                        + "      ROUND (SUM(pfi.t_Value), 0) t_PFIValue "
                        + " FROM ddlclbopfi_dbt pfi "
                        + " WHERE pfi.t_SessionID = ? "
                        + "   AND pfi.t_MainId = " + String(Group)
                        + " GROUP BY pfi.t_MainId " );
      cmd.AddParam(SessionID);
      PfiDS = cmd.Execute();
      PfiDS.MoveNext();

      cmd = DL_RSDCommand(" SELECT arr.t_MainId, "
                        + "      ROUND (SUM (CASE WHEN arr.t_IsDebit = 'X' AND arr.t_ArrearType = '"+ARREAR_TYPE_NOT_REPO+"' AND arr.t_DocKind <> "+DL_DVNDEAL+" THEN arr.t_Value ELSE 0 END), 0) t_DebitDealValue, "
                        + "      ROUND (SUM (CASE WHEN arr.t_IsDebit = 'X' AND arr.t_ArrearType = '"+ARREAR_TYPE_REPO+"' THEN arr.t_Value ELSE 0 END), 0) t_DebitREPOValue, "
                        + "      ROUND (SUM (CASE WHEN arr.t_IsDebit = 'X' AND arr.t_ArrearType = '"+ARREAR_TYPE_NOT_REPO+"' AND arr.t_DocKind = "+DL_DVNDEAL+" THEN arr.t_Value ELSE 0 END), 0) t_DebitNDealValue, "
//                        + "      ROUND (SUM (CASE WHEN arr.t_IsDebit = 'X' AND arr.t_ArrearType = '"+ARREAR_TYPE_OTHER+"' THEN arr.t_Value ELSE 0 END), 0) t_DebitOtherValue, "
                        + "      ROUND (SUM (CASE WHEN arr.t_IsDebit <> 'X' AND arr.t_ArrearType = '"+ARREAR_TYPE_NOT_REPO+"' AND arr.t_DocKind <> "+DL_DVNDEAL+" THEN arr.t_Value ELSE 0 END), 0) t_KreditDealValue, "
                        + "      ROUND (SUM (CASE WHEN arr.t_IsDebit <> 'X' AND arr.t_ArrearType = '"+ARREAR_TYPE_REPO+"' THEN arr.t_Value ELSE 0 END), 0) t_KreditREPOValue, "
                        + "      ROUND (SUM (CASE WHEN arr.t_IsDebit <> 'X' AND arr.t_ArrearType = '"+ARREAR_TYPE_NOT_REPO+"' AND arr.t_DocKind = "+DL_DVNDEAL+" THEN arr.t_Value ELSE 0 END), 0) t_KreditNDealValue "
//                        + "      ROUND (SUM (CASE WHEN arr.t_IsDebit <> 'X' AND arr.t_ArrearType = '"+ARREAR_TYPE_OTHER+"' THEN arr.t_Value ELSE 0 END), 0) t_KreditOtherValue "
                        + " FROM ddlclboarrear_dbt arr "
                        + " WHERE arr.t_SessionID = ? "
                        + "   AND arr.t_MainId = " + String(Group)
                        + " GROUP BY arr.t_MainId " );
      cmd.AddParam(SessionID);
      ArrearDS = cmd.Execute();
      ArrearDS.MoveNext();

      cmd = DL_RSDCommand(" SELECT t_MainId, "
                         + "        ROUND (SUM (CASE WHEN t_IsEnrol = 'X' THEN t_SumRub ELSE 0 END), 0) t_InCurSum, "
                         + "        ROUND (SUM (CASE WHEN t_IsEnrol <> 'X' THEN t_SumRub ELSE 0 END), 0) t_OutCurSum "
                         + " FROM ddlclboinoutcur_dbt "
                         + " WHERE t_SessionID = ? "
                         + "   AND t_MainId = " + String(Group)
                         + " GROUP BY t_MainId " );
      cmd.AddParam(SessionID);
      InOutCurDS = cmd.Execute();
      InOutCurDS.MoveNext();

      cmd = DL_RSDCommand(" SELECT t_MainId, "
//                         + "        ROUND (SUM (CASE WHEN t_IsEnrol = 'X'  AND t_IsIssuerNotResident = 'X'  THEN t_SumRub ELSE 0 END), 0) t_InOtherSum, "
                         + "        ROUND (SUM (CASE WHEN t_IsEnrol = 'X' THEN t_SumRub ELSE 0 END), 0) t_InSecSum, "
//                         + "        ROUND (SUM (CASE WHEN t_IsEnrol <> 'X' AND t_IsIssuerNotResident = 'X'  THEN t_SumRub ELSE 0 END), 0) t_OutOtherSum, "
                         + "        ROUND (SUM (CASE WHEN t_IsEnrol <> 'X' THEN t_SumRub ELSE 0 END), 0) t_OutSecSum "
                         + " FROM ddlclboinoutsec_dbt "
                         + " WHERE t_SessionID = ? "
                         + "   AND t_MainId = " + String(Group)
                         + " GROUP BY t_MainId " );
      cmd.AddParam(SessionID);
      InOutSecDS = cmd.Execute();
      InOutSecDS.MoveNext();
    
      IF (MainIDLink[Group] != NULL)
        MainIDLink[Group] = NumStr;

        //Считаем суммы здесь, чтобы избежать расхождения из-за округления
        AssetTotalValue = NVL(RestDS.TotalRestNatCur, $0) + NVL(AvrDS.BondValue, $0) + NVL(AvrDS.DepoCertValue, $0) 
                        + NVL(AvrDS.SavingCertValue, $0) + NVL(AvrDS.ShareValue, $0) + NVL(AvrDS.InvShareValue, $0) 
                        + NVL(AvrDS.BillValue, $0) + NVL(AvrDS.DepoRecValue, $0) + NVL(AvrDS.KSUValue, $0) 
                        + NVL(AvrDS.OtherValue, $0) + NVL(MetalRestDS.TotalRest, 0) + NVL(PfiDS.PFIValue, $0);
        DebitTotalValue = NVL(ArrearDS.DebitDealValue, $0) + NVL(ArrearDS.DebitREPOValue, $0) + NVL(ArrearDS.DebitNDealValue, $0); //+ NVL(ArrearDS.DebitOtherValue, $0); 
        KreditTotalValue = NVL(ArrearDS.KreditDealValue, $0) + NVL(ArrearDS.KreditREPOValue, $0) + NVL(ArrearDS.KreditNDealValue, $0); //+ NVL(ArrearDS.KreditOtherValue, $0); 
        InTotalValue = NVL(InOutCurDS.InCurSum, 0) + NVL(InOutSecDS.InSecSum, 0); //+ NVL(InOutSecDS.InOtherSum, 0);
        OutTotalValue = NVL(InOutCurDS.OutCurSum, 0) + NVL(InOutSecDS.OutSecSum, 0); //+ NVL(InOutSecDS.OutOtherSum, 0);

        PrintTableLine( "N2_ID",                   NumStr,                               NULL,
                        "N2_GrLegalForm",          legalForm,                            NULL,
                        "N2_GrQI",                 qi,                                   NULL,
                        "N2_GrResid",              resid,                                NULL,
                        "N2_GrStdStrategy",        "",                                   NULL,
                        "N2_GrIsStd",              "",                                   NULL,
                                                                                       
                        "N2_AssetCurr",            NVL(RestDS.TotalRestNatCur, $0),      NULL,
                        "N2_AssetDeposit",         $0,                                   NULL,
                        "N2_AssetSecurBond",       NVL(AvrDS.BondValue, $0),             NULL,
                        "N2_AssetSecurDepoCert",   NVL(AvrDS.DepoCertValue, $0),         NULL,
                        "N2_AssetSecurSavingCert", NVL(AvrDS.SavingCertValue, $0),       NULL,
                        "N2_AssetSecurShare",      NVL(AvrDS.ShareValue, $0),            NULL,
                        "N2_AssetSecurInvShare",   NVL(AvrDS.InvShareValue, $0),         NULL,
                        "N2_AssetSecurBill",       NVL(AvrDS.BillValue, $0),             NULL,
                        "N2_AssetSecurDepoRec",    NVL(AvrDS.DepoRecValue, $0),          NULL,
                        "N2_AssetSecurKSU",        NVL(AvrDS.KSUValue, $0),              NULL,
                        "N2_AssetSecurOther",      NVL(AvrDS.OtherValue, $0),            NULL,
                        "N2_AssetRealty",          $0,                                   NULL,
                        "N2_AssetRent",            $0,                                   NULL,
                        "N2_AssetEstate",          $0,                                   NULL,
                        "N2_AssetReq",             $0,                                   NULL,
                        "N2_AssetOther",           $0,                                   NULL,
                        "N2_AssetMetal",           NVL(MetalRestDS.TotalRest, $0),       NULL,  
                        "N2_AssetPFI",             NVL(PfiDS.PFIValue, $0),              NULL,
                        "N2_AssetTotal",           AssetTotalValue,                      NULL,   
                                                                                         
                        "N2_DebitDeal",            NVL(ArrearDS.DebitDealValue, $0),     NULL,
                        "N2_DebitREPO",            NVL(ArrearDS.DebitREPOValue, $0),     NULL,
                        "N2_DebitNDeal",           NVL(ArrearDS.DebitNDealValue, $0),    NULL,
                        "N2_DebitOther",           $0,                                   NULL,
                        "N2_DebitTotal",           DebitTotalValue,                      NULL,
                                                                                        
                        "N2_KreditDeal",           NVL(ArrearDS.KreditDealValue, $0),    NULL,
                        "N2_KreditREPO",           NVL(ArrearDS.KreditREPOValue, $0),    NULL,
                        "N2_KreditNDeal",          NVL(ArrearDS.KreditNDealValue, $0),   NULL,
                        "N2_KreditOther",          $0,                                   NULL,
                        "N2_KreditTotal",          KreditTotalValue,                     NULL,
                                                                                        
                        "N2_InCurr",               NVL(InOutCurDS.InCurSum, $0),         NULL,
                        "N2_InSecur",              NVL(InOutSecDS.InSecSum, $0),         NULL,
                        "N2_InOther",              /*NVL(InOutSecDS.InOtherSum, $0),*/ $0, NULL,
                        "N2_InTotal",              InTotalValue,                         NULL,
                        "N2_OutCurr",              NVL(InOutCurDS.OutCurSum, $0),        NULL,
                        "N2_OutSecur",             NVL(InOutSecDS.OutSecSum, $0),        NULL,
                        "N2_OutOther",             /*NVL(InOutSecDS.OutOtherSum, $0),*/$0, NULL,
                        "N2_OutTotal",             OutTotalValue,                        NULL);
                                                                                        
        NumStr = NumStr + 1;                                                            
      END;

      ProgressIndicator.Use;                                                                              
    END;
    ProgressIndicator.Remove;

    EndTable();

    PrintReport_7();
    PrintReport_8();
    PrintReport_9_17();
    PrintReport_18();
    PrintReport_20();
    PrintReport_22();
    PrintReport_24();
    PrintReport_26_29();
    PrintReport_31_34();
    PrintReport_InOutCur();
    PrintReport_InOutSec();

  END;

  PRIVATE MACRO PrintMessages()
    var query, cmd, ds;
    query = " SELECT t_Message       "
            "   FROM darnureperr_dbt "
            "  WHERE t_SessionID = ? ";
     
    cmd = DL_RSDCommand(query);
    cmd.AddParam(SessionID);

    ds = cmd.execute();

    WHILE (ds.MoveNext())
      msgbox(ds.Message);
    END;
  END;

  PRIVATE MACRO ClearTables()
    sql_execute("DELETE FROM DDLCLBO_DBT WHERE t_SessionID = " + string(SessionID));
    sql_execute("DELETE FROM DDLCLBORESTAC_DBT WHERE t_SessionID = " + string(SessionID));
    sql_execute("DELETE FROM DDLCLBOMETALRESTAC_DBT WHERE t_SessionID = " + string(SessionID));
    sql_execute("DELETE FROM DDLCLBOAVOIR_DBT WHERE t_SessionID = " + string(SessionID));
    sql_execute("DELETE FROM DDLCLBOPFI_DBT WHERE t_SessionID = " + string(SessionID));
    sql_execute("DELETE FROM DDLCLBOARREAR_DBT WHERE t_SessionID = " + string(SessionID));
    sql_execute("DELETE FROM DDLCLBOINOUTCUR_DBT WHERE t_SessionID = " + string(SessionID));
    sql_execute("DELETE FROM DDLCLBOINOUTSEC_DBT WHERE t_SessionID = " + string(SessionID));
    sql_execute("DELETE FROM DARNUREPERR_DBT WHERE t_SessionID = " + string(SessionID));
  END;
  
  MACRO Create()
    var BeginDate = m_Form.BeginDate;
    var EndDate = m_Form.EndDate;
    var query, query2, cmd, ds;
    var PartitionNum;
    var header = "Подготовка данных для отчета о клиентах на брокерском обслуживании";

    ClearTables();
  
    query = " INSERT INTO ddlclbo_dbt (T_SESSIONID, "
          + "                          T_MAINID, "
          + "                          T_CLIENTCONTRID, "
          + "                          T_PARTYID, "
          + "                          T_SERVKIND, "
          + "                          T_CODE) "
          + " SELECT ? t_SessionID, "
          + "        (CASE pt.t_LegalForm WHEN 2 THEN 0 ELSE 1 END) * 4 + "
          + "        (CASE "
          + "            WHEN RSB_SECUR.DL_GetNotResidentForBrokClientRep (pt.t_PartyId, ?) = CHR (88) "
          + "            THEN 1 "
          + "            ELSE 0 "
          + "         END) * 2 + "
          + "        NVL ( "
          + "           (SELECT DISTINCT 0 "
          + "              FROM dv_scqinvhist QIHist "
          + "             WHERE     QIHist.t_PartyId = pt.t_PartyId "
          + "                   AND QIHist.t_State = 1 "
          + "                   AND (    QIHist.t_BegDate <= ? "
          + "                        AND (   QIHist.t_EndDate = ? "
          + "                             OR QIHist.t_EndDate >= ?))), "
          + "           1) "
          + "           t_MainID, "
          + "        sf.t_Id t_ClientContrId, "
          + "        pt.t_PartyId, "
          + "        sf.t_ServKind, "
          + "        rsb_secur.SC_GetObjCodeOnDate(3, 1, pt.t_PartyId, ?) t_Code "
          + "   FROM dparty_dbt pt, dsfcontr_dbt sf "
          + "  WHERE     pt.t_PartyId <> " +string({OurBank})
          + "        AND sf.t_PartyId = pt.t_PartyId "
          + "        AND  (   (    sf.t_ServKind IN (?, ?, ?, ?) "
          + "             AND (    sf.t_DateBegin <= ? "
          + "                 AND (   sf.t_DateClose = ? "
          + "                     OR  sf.t_DateClose >= ?))) "
          + "             OR EXISTS "
          + "                 (SELECT 1 "
          + "                    FROM ddlcontr_dbt dlcontr, "
          + "                         ddlcontrmp_dbt dlcontrmp, "
          + "                         dsfcontr_dbt subcontr "
          + "                  WHERE     dlcontr.t_SFContrId = sf.t_Id "
          + "                        AND dlcontrmp.t_DlContrId = dlcontr.t_DlContrId "
          + "                        AND dlcontrmp.t_SFContrId = subcontr.t_Id "
          + "                        AND subcontr.t_ServKind IN  (?, ?, ?, ?) "
          + "                        AND (    subcontr.t_DateBegin <= ? "
          + "                            AND (   subcontr.t_DateClose = ? "
          + "                                 OR subcontr.t_DateClose >= ?))))";

    cmd = DL_RSDCommand(query);
    cmd.AddParam(SessionID);

    cmd.AddParam(EndDate);
    cmd.AddParam(EndDate);
    cmd.AddParam(ZeroDate);
    cmd.AddParam(EndDate);

    cmd.AddParam(EndDate);

    cmd.AddParam(PTSK_STOCKDL);
    cmd.AddParam(PTSK_VEKSACC);
    cmd.AddParam(PTSK_DV);
    cmd.AddParam(PTSK_CM);

    cmd.AddParam(EndDate);
    cmd.AddParam(ZeroDate);
    cmd.AddParam(BeginDate);

    cmd.AddParam(PTSK_STOCKDL);
    cmd.AddParam(PTSK_VEKSACC);
    cmd.AddParam(PTSK_DV);
    cmd.AddParam(PTSK_CM);

    cmd.AddParam(EndDate);
    cmd.AddParam(ZeroDate);
    cmd.AddParam(BeginDate);    

    cmd.executeCMD();

    sql_execute("COMMIT;");

    query2 = " SELECT t_MainID, DENSE_RANK () OVER (ORDER BY t_MainID) t_MainIDLink "
             "   FROM ddlclbo_dbt "
             "  WHERE t_SessionID = ? "
             "  GROUP BY t_SessionID, t_MainID ";

    cmd = DL_RSDCommand(query2);
    cmd.AddParam(SessionID);
    ds = cmd.execute();

    WHILE (ds.MoveNext())
      MainIDLink(ds.MainID) = ds.MainIDLink;
    END;

    m_ProgressIndicator.Start(PartitionCount, header, header);

    FOR(PartitionNum, 1, PartitionCount)
      cmd = RSDCommand("CALL RSB_DLCLBOREP.CreateAllData(?,?,?,?,?,?)");

      cmd.addParam( "", RSDBP_IN, BeginDate );
      cmd.addParam( "", RSDBP_IN, EndDate );
      cmd.addParam( "", RSDBP_IN, SessionID );
      cmd.addParam( "", RSDBP_IN, ParallelLevel );
      cmd.addParam( "", RSDBP_IN, PartitionCount );
      cmd.addParam( "", RSDBP_IN, PartitionNum );
      cmd.execute();

      m_ProgressIndicator.Update(PartitionNum);
    END;

    m_ProgressIndicator.Stop();

    PrintReport();
    PrintMessages();
  END;

  initDL_CReportTemplate(ClBORep_Panel(), "Report_BrokerClients.xls", null, false, null, POI_MODE);
END;

ClBORep().Run;
exit(1);
