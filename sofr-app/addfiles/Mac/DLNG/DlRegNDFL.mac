/*
$Name:             DlRegNDFL.mac
$Module:           Ценные бумаги
$Description:      Отчет "Регистр НДФЛ"
*/
import "DlRegNDFL_form.mac";
import "spRepFun.mac", "RepPersonalIncomeTax.mac", dp_util, "nptxcalcfun.mac";

private var form = RegNDFL_Panel();

private macro StrDate(_date)
  var d, m, y, day, month, year;

  DateSplit(_date, d, m, y);

  if (d < 10)
    day = "0" + String(d);
  else
    day = String(d);
  end;

  if (m < 10)
    month = "0" + String(m);
  else
    month = String(m);
  end;

  year = String(y);

  return day + "." + month + "." + year;
end;

private macro DateYear(_date):string
  var d, m, y;

  DateSplit(_date, d, m, y);

  return string(y);
end;

private macro StrMaxFactDate2()
  return
  " (NVL((SELECT max(dlrq.t_FactDate) " +
  "  FROM ddlrq_dbt dlrq " + 
  "  WHERE dlrq.t_DocKind    = tick.t_BOfficeKind " +
  "      AND dlrq.t_DocID = tick.t_DealID " +
  "      AND dlrq.t_Type    IN (" + DLRQ_TYPE_DELIVERY + "," + DLRQ_TYPE_PAYMENT + ") " +
  "      AND dlrq.t_DealPart    = " + LEG_KIND_DL_TICK_BACK + 
  "      AND dlrq.t_State = " + DLRQ_STATE_EXEC +
  "      AND dlrq.t_FactDate > TO_DATE('01-01-0001','DD-MM-YYYY') " +
  "    ), TO_DATE('01-01-0001','DD-MM-YYYY')) " +
  ") ";
end;

private class (NPTXRepCalcCommon) RegNDFLRepCalc(_report_date, _investor)

  MACRO ClearData()
    ClearData();
  end;

  macro Document_Series()
    return ClientPersnIdcMain().rec.PaperSeries;
  end;

  macro Document_Number()
    return ClientPersnIdcMain().rec.PaperNumber;
  END;

  macro Header(ReferenceNumber):string
    return "РЕГИСТР НАЛОГОВОГО УЧЕТА ДОХОДОВ И НАЛОГА НА ДОХОДЫ ФИЗИЧЕСКИХ ЛИЦ ЗА " + CurrYear + " ГОД № " + ReferenceNumber;
  end;

  macro CheckClient():bool
    var query, cmd, rs;

    query = "select 1 from dnptxobj_dbt obj where " 
            + "     obj.t_client = ? "
            + " and obj.t_date between ? and ? ";

    cmd = DL_RSDCommand(query);
    cmd.addParam(ClientID);
    cmd.addParam(m_BeginDate);
    cmd.addParam(m_RepDate);
    rs = cmd.Execute();
    
    if (rs.MoveNext())
      return true;
    end;

    return false;
  end;

  InitNPTXRepCalcCommon(_report_date, _investor, true, null, null, false);
end;

private class (DL_CReportTemplate) RegNDFL_Report
  private var rep, Rg, Rd, Rk, Rs;
  private var sheet_name = "RegNDFL";

  private macro PrintMode():integer
    return DL_OUTREPORT_EXCEL;
  end;

  private macro GetNDRSum(month, NDR, iis, whereCond)
    var dayInMonth = getDaysInMonth(date(1, month, rep.CurrYear));

    return GetRubSumByClient(rep.ClientID,
                             string(NDR),
                             date(1, month, rep.CurrYear),
                             date(dayInMonth, month, rep.CurrYear),
                             null,
                             iis,
                             null,
                             whereCond);
  end;

  private macro PrintLine(cell, number : @integer, title, arr, specialItog)
    var i = 1, itog = $0;
    if( number > 0 )
      PrintFormatString( NULL, cell + "_num", number );
      number = number + 1;
    end;

    if( title != "" )
      PrintFormatString( NULL, cell + "_title", title );
    end;

    while( i <= 12 )
      PrintFormatString( NULL, cell + "_" + i, abs(arr[i]) );
      itog = itog + arr[i];
      i = i + 1;
    end;

    if( specialItog == true )
      PrintFormatString( NULL, cell + "_itog", abs(arr[12]) ); 
    else
      PrintFormatString( NULL, cell + "_itog", abs(itog) );
    end;

    CopyAllSheetInTotalBook(sheet_name, false, cell, 0, sheet_name, true);
  end;

  private macro BeginReport(NumCopy:integer)
    CreateTotalBook();
  end;

  private macro EndReport(NumCopy:integer)
    SaveTotalBook();
  end;

  private macro getTaxRates()
    if (rep.ResidenceStatus() == 1)
      Rg = 0.13;
      Rd = 0.13;
      Rk = 0.35;
      Rs = 0.09;
    else
      var party = TRecHandler("party");
      ПолучитьСубъекта(rep.ClientID, party);
      Rg = readNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 77) / 100; // Налоговая ставка для физического лица - нерезидента по общим доходам
      if((ValType(Rg) == V_UNDEF) or (Rg == null) or (Rg == "") or (Rg == 0))
        Rg = 0.3;
      end;
    end;
  end;

  private macro R1_2(ReferenceNumber)
    PrintFormatString(NULL, "N1_R1_R2");
    PrintFormatString(NULL,
                      "N1_Header",          rep.Header(ReferenceNumber),
                      "N1_1_1",             rep.OurInn(),
                      "N1_1_2",             rep.OurKpp(),
                      "N1_1_3",             rep.OurFNScode(),
                      "N1_1_4",             rep.OurName(),
                      "N1_1_5",             rep.OurOKTMO(),

                      "N1_2_1",             rep.ClientINN(),
                      "N1_2_2",             "",
                      "N1_2_3",             rep.FIO(),
                      "N1_2_4",             rep.DocumentType(),
                      "N1_2_5",             rep.DocumentNumber(),
                      "N1_2_6",             rep.DateBirth(),
                      "N1_2_7",             rep.Citizenship(),
                      "N1_2_8",             rep.Country(),
                      "N1_2_9",             rep.MailIndex(),
                      "N1_2_10",            rep.RegionCode(),
                      "N1_2_11",            rep.District(),
                      "N1_2_12",            rep.City(),
                      "N1_2_13",            rep.Town(),
                      "N1_2_14",            rep.Street(),
                      "N1_2_15",            rep.House(),
                      "N1_2_16",            rep.Building(),
                      "N1_2_17",            rep.Appartment(),
                      "N1_2_18",            rep.ResidenceStatus(),
                      "N1_2_19",            "");

    CopyAllSheetInTotalBook(sheet_name, false, "N1_R1_R2", 0, sheet_name, true);
  End;

  var plus = TArray;
  var minus = TArray;
  var rateS = 0;
  var FIRST_ROW = 29;
  //--------------------------
  var TaxCalculatedSum = $0;
  var TaxCalculated35Sum = $0;
  var TaxCalculatedRSum = $0;
  var TaxPaidSum = $0;
  var TaxPaid35Sum = $0;
  var TaxPaidRSum = $0;
  var TaxTransmittedSum = $0;
  var TaxTransmitted35Sum = $0;
  var TaxTransmittedRSum = $0;
  var TaxDueSum = $0;
  var TaxDue35Sum = $0;
  var TaxDueRSum = $0;
  var TaxToReturnDueSum = $0;
  var TaxToReturnDue35Sum = $0;
  var TaxToReturnDueRSum = $0;
  var TotalPercentSum = TArray;

  private macro PlusMinus(number : @integer, is_plus, cell, kind, NDR, is_iis, NDR_iis)
    var m = TArray;
    var i = 1;
    var itog = 0;

    while (i <= 12)
      m[i] = 0;
      m[i] = m[i] + GetNDRSum(i, NDR, is_iis);
      if (NDR_iis != null)
        m[i] = m[i] + GetNDRSum(i, NDR_iis, 1);
      end;
      if (is_plus)
        plus[i] = plus[i] + m[i];
      else
        minus[i] = minus[i] + m[i];
      end;
      itog = itog + m[i];
      i = i + 1;
    end;

    if (itog > 0)
      PrintLine(cell, @number, kind, m);
    end;
  end;

  private macro PrintCodePlus();
    PlusMinus(0, true, "N1_CodePlus", "Код 1011", TXOBJ_PLUSG_1011, 0, TXOBJ_PLUSG_1011_IIS);
    PlusMinus(0, true, "N1_CodePlus", "Код 1110", TXOBJ_PlusG_1110, 0);
    PlusMinus(0, true, "N1_CodePlus", "Код 1530", TXOBJ_PlusG_1530, 0);
    PlusMinus(0, true, "N1_CodePlus", "Код 1531", TXOBJ_PlusG_1531, 0);
    PlusMinus(0, true, "N1_CodePlus", "Код 1532", TXOBJ_PlusG_1532, 0);
    PlusMinus(0, true, "N1_CodePlus", "Код 1533", TXOBJ_PlusG_1533, 0);
    PlusMinus(0, true, "N1_CodePlus", "Код 1535", TXOBJ_PlusG_1535, 0);
    PlusMinus(0, true, "N1_CodePlus", "Код 1536", TXOBJ_PlusG_1536, 0);
    PlusMinus(0, true, "N1_CodePlus", "Код 1537", TXOBJ_PlusG_1537, 0);
    PlusMinus(0, true, "N1_CodePlus", "Код 1539", TXOBJ_PlusG_1539, 0);
    PlusMinus(0, true, "N1_CodePlus", "Код 1544", TXOBJ_PlusG_1544, 1);
    PlusMinus(0, true, "N1_CodePlus", "Код 1545", TXOBJ_PlusG_1545, 1);
    PlusMinus(0, true, "N1_CodePlus", "Код 1546", TXOBJ_PlusG_1546, 1);
    PlusMinus(0, true, "N1_CodePlus", "Код 1547", TXOBJ_PlusG_1547, 1);
    PlusMinus(0, true, "N1_CodePlus", "Код 1548", TXOBJ_PlusG_1548, 1);
    PlusMinus(0, true, "N1_CodePlus", "Код 1549", TXOBJ_PlusG_1549, 1);
    PlusMinus(0, true, "N1_CodePlus", "Код 1551", TXOBJ_PlusG_1551, 1);
    PlusMinus(0, true, "N1_CodePlus", "Код 1553", TXOBJ_PlusG_1553, 1);
    PlusMinus(0, true, "N1_CodePlus", "Код 2640", TXOBJ_PlusG_2640, 0, TXOBJ_PlusG_2640_IIS);
    PlusMinus(0, true, "N1_CodePlus", "Код 2641", TXOBJ_PlusG_2641, 0, TXOBJ_PlusG_2641_IIS);
    PlusMinus(0, true, "N1_CodePlus", "Код 2800", TXOBJ_PlusG_2800, 0);
    if (rep.ResidenceStatus() == 2)
      PlusMinus(0, true, "N1_CodePlus", "Код 3023", TXOBJ_Plus35_3023, 0);
    end;
  end;

  private macro CodeMinusLine( numRow : @integer, type, ndr1, iis, ndr_iis)
    var m = TArray;
    var i = 1, pos = 0;
    var itog = 0;

    while (i <= 12)
      m[i] = 0;
      var dayInMonth = getDaysInMonth(date(1, i, rep.CurrYear));
      m[i] = m[i] + GetNDRSum(i, ndr1, iis);
      if (ndr_iis != null)
        m[i] = m[i] + GetNDRSum(i, ndr_iis, 1);
      end;
      itog = itog + m[i];
      minus[i] = minus[i] + m[i];
      i = i + 1;
    end;
    
    if(itog > 0)
      var curRow = FIRST_ROW + numRow;

      PrintFormatString( NULL, "C" + curRow , type,
                               "E" + curRow , m[1],
                               "F" + curRow , m[2],
                               "G" + curRow , m[3],
                               "H" + curRow , m[4],
                               "I" + curRow , m[5],
                               "J" + curRow , m[6],
                               "K" + curRow , m[7],
                               "L" + curRow , m[8],
                               "M" + curRow , m[9],
                               "O" + curRow , m[10],
                               "P" + curRow , m[11],
                               "Q" + curRow , m[12],
                               "R" + curRow , itog );
      
      numRow = numRow + 1;
    end;
  end;

  private macro PrintCodeMinus218()
    var i = 1, j = 1;
    while( i < 7 )
      j = 1;
      while( j < 13 )
        PrintFormatString( NULL, "CodeMinus218" + i + "_" + j, $0 );
        j = j + 1;
      end;
      PrintFormatString( NULL, "CodeMinus218" + i + "_itog", $0 );
      i = i + 1;
    end;

    m_ObjTemplateXLS.SetMERGE("A30:B35");
    CopyAllSheetInTotalBook(sheet_name, false, "A30:R35", 0, sheet_name, true);
  end;
  
  private macro PrintCodeMinus();
    var numrow = 0;
    
    CodeMinusLine(@numrow, "Код 201", TXOBJ_MinusG_201, 0);
    CodeMinusLine(@numrow, "Код 202", TXOBJ_MinusG_202, 0);
    CodeMinusLine(@numrow, "Код 203", TXOBJ_MinusG_203, 0);
    CodeMinusLine(@numrow, "Код 205", TXOBJ_MinusG_205, 0);
    CodeMinusLine(@numrow, "Код 206", TXOBJ_MinusG_206, 0);
    CodeMinusLine(@numrow, "Код 207", TXOBJ_MinusG_207, 0);
    CodeMinusLine(@numrow, "Код 208", TXOBJ_MinusG_208, 0);
    CodeMinusLine(@numrow, "Код 209", TXOBJ_MinusG_209, 0);
    CodeMinusLine(@numrow, "Код 210", TXOBJ_MinusG_210, 0);
    CodeMinusLine(@numrow, "Код 211", TXOBJ_MinusG_211, 0);
    CodeMinusLine(@numrow, "Код 213", TXOBJ_MinusG_213, 0);
    CodeMinusLine(@numrow, "Код 214", TXOBJ_MinusG_214, 0, TXOBJ_MinusG_214_IIS);
    CodeMinusLine(@numrow, "Код 218", TXOBJ_MinusG_218, 0, TXOBJ_MinusG_218_1);
    CodeMinusLine(@numrow, "Код 219", TXOBJ_MinusG_219, 0, TXOBJ_MinusG_219_1);
    CodeMinusLine(@numrow, "Код 220", TXOBJ_MinusG_220, 0);
    CodeMinusLine(@numrow, "Код 222", TXOBJ_MinusG_222, 0);
    CodeMinusLine(@numrow, "Код 223", TXOBJ_MinusG_223, 0);
    CodeMinusLine(@numrow, "Код 224", TXOBJ_MinusG_224, 0);
    CodeMinusLine(@numrow, "Код 225", TXOBJ_MinusG_225, 1);
    CodeMinusLine(@numrow, "Код 226", TXOBJ_MinusG_226, 1);
    CodeMinusLine(@numrow, "Код 227", TXOBJ_MinusG_227, 1);
    CodeMinusLine(@numrow, "Код 228", TXOBJ_MinusG_228, 1);
    CodeMinusLine(@numrow, "Код 229", TXOBJ_MinusG_229, 1);
    CodeMinusLine(@numrow, "Код 230", TXOBJ_MinusG_230, 1);
    CodeMinusLine(@numrow, "Код 231", TXOBJ_MinusG_231, 1);
    CodeMinusLine(@numrow, "Код 233", TXOBJ_MinusG_233, 1);
    CodeMinusLine(@numrow, "Код 234", TXOBJ_MinusG_234, 1);
    CodeMinusLine(@numrow, "Код 235", TXOBJ_MinusG_235, 1);
    CodeMinusLine(@numrow, "Код 236", TXOBJ_MinusG_236, 1);
    CodeMinusLine(@numrow, "Код 239", TXOBJ_MinusG_239, 1);
    CodeMinusLine(@numrow, "Код 240", TXOBJ_MinusG_240, 1);
    CodeMinusLine(@numrow, "Код 241", TXOBJ_MinusG_241, 1);
    CodeMinusLine(@numrow, "Код 250", TXOBJ_MinusG_250, 1);
    CodeMinusLine(@numrow, "Код 251", TXOBJ_MinusG_251, 1);
    CodeMinusLine(@numrow, "Код 252", TXOBJ_MinusG_252, 1);
    CodeMinusLine(@numrow, "Код 618", TXOBJ_MinusG_618, 0);
    CodeMinusLine(@numrow, "Код 619", TXOBJ_MinusG_619, 1);

    if(numrow > 0)
      var lastRow = FIRST_ROW + numrow - 1;
      if(numrow > 1)
        m_ObjTemplateXLS.SetMerge( "A" + FIRST_ROW + ":B" + lastRow );
      end;
      CopyAllSheetInTotalBook(sheet_name, false, "A" + FIRST_ROW + ":R" + lastRow, 0, sheet_name, true);
    end
  end;

  class PercentSum
    var Percent : Integer;
    var TaxCalculatedSum : Money;
    var TaxPaidSum : Money;
    var TaxTransmittedSum : Money;
    var TaxDueSum : Money;
    var TaxToReturnDueSum : Money;
  end;
  
  macro AddPercentSumToArray(Percent, TaxCalculatedSum, TaxPaidSum, TaxTransmittedSum, TaxDueSum, TaxToReturnDueSum)
    var peSum : PercentSum;
    peSum.Percent = Percent;
    peSum.TaxCalculatedSum = TaxCalculatedSum;
    peSum.TaxPaidSum = TaxPaidSum;
    peSum.TaxTransmittedSum = TaxTransmittedSum;
    peSum.TaxDueSum = TaxDueSum;
    peSum.TaxToReturnDueSum = TaxToReturnDueSum;
    TotalPercentSum[TotalPercentSum.size] = peSum;
  end;

  private macro R3 (Param)
    var BaseTotal = TArray;
    var TaxCalculated = TArray;
    var TaxPaid = TArray;
    var TaxDue = TArray;
    var TaxToReturnDue = TArray;
    var TaxTransmited = TArray;
    var TaxReturn = TArray;
    TaxCalculatedSum = $0;
    TaxPaidSum = $0;
    TaxTransmittedSum = $0;
    TaxDueSum = $0;
    TaxToReturnDueSum = $0;

    PrintFormatString(NULL, "N1_R3");
    CopyAllSheetInTotalBook(sheet_name, false, "N1_R3", 0, sheet_name, true);

    var i = 1;
    while (i <= 12)
      plus[i] = 0;
      minus[i] = 0;
      i = i + 1;
    end;

    PrintCodePlus();
    PrintCodeMinus();

    var Positive = " obj.t_sum > 0 ";
    var Negative = " obj.t_sum < 0 ";
    var rate;

    rate = iif(rep.ResidenceStatus() == 1, 0.13, 0.3 );

    i = 1;
    while (i <= 12)
      BaseTotal[i] = plus[i] - minus[i] + iif(i == 1, 0, BaseTotal[i-1]);
      TaxCalculated[i] = (plus[i] - minus[i]) * rate - GetNDRSum(i, TXOBJ_PAIDGENERAL_0, 0);
      TaxCalculatedSum = TaxCalculatedSum + TaxCalculated[i];
      TaxPaid[i] = GetNDRSum(i, TXOBJ_PAIDMATERIAL,     0, Positive) +
                   GetNDRSum(i, TXOBJ_PAIDMATERIAL_IIS, 1, Positive) +
                   GetNDRSum(i, TXOBJ_PAIDGENERAL,      0, Positive) +
                   GetNDRSum(i, TXOBJ_PAIDGENERAL_IIS,  1, Positive) +
                   GetNDRSum(i, TXOBJ_PAIDBILL,         0, Positive);
      TaxPaidSum = TaxPaidSum + TaxPaid[i];
      TaxDue[i] = iif(TaxCalculated[i] - TaxPaid[i] > 0, TaxCalculated[i] - TaxPaid[i], $0);
      TaxDueSum = TaxDueSum + TaxDue[i];
      TaxToReturnDue[i] = iif(TaxCalculated[i] - TaxPaid[i] < 0, TaxCalculated[i] - TaxPaid[i], $0);
      TaxToReturnDueSum = TaxToReturnDueSum + TaxToReturnDue[i];
      TaxTransmited[i] = iif(TaxPaid[i] - TaxToReturnDue[i] > 0, TaxPaid[i] - TaxToReturnDue[i], $0);
      TaxTransmittedSum = TaxTransmittedSum + TaxTransmited[i];
      TaxReturn[i] = GetNDRSum(i, TXOBJ_PAIDMATERIAL,     0, Negative) +
                     GetNDRSum(i, TXOBJ_PAIDMATERIAL_IIS, 1, Negative) +
                     GetNDRSum(i, TXOBJ_PAIDGENERAL,      0, Negative) +
                     GetNDRSum(i, TXOBJ_PAIDGENERAL_IIS,  1, Negative) +
                     GetNDRSum(i, TXOBJ_PAIDBILL,         0, Negative);

      i = i + 1;
    end;

    PrintCodeMinus218();
    PrintLine("N1_NB", 0, "", BaseTotal, true);
    PrintLine("N1_NI", 0, "", TaxCalculated);
    PrintLine("N1_NU", 0, "", TaxPaid);
    PrintLine("N1_NP", 0, "", TaxDue);
    PrintLine("N1_NA", 0, "", TaxToReturnDue);
    PrintLine("N1_TT", 0, "", TaxTransmited);
    PrintLine("N1_TR", 0, "", TaxReturn);
  End;

  private macro R4 (Param)
    var DivSum = TArray;
    var TaxCalculatedD = TArray;
    var TaxPaidD = TArray;

    PrintFormatString(NULL, "N1_R4");
    CopyAllSheetInTotalBook(sheet_name, false, "N1_R4", 0, sheet_name, true);

    var i = 1, query, cmd, rs, ZeroArr = TArray;

    while (i <= 12)
      DivSum[i] = GetNDRSum(i, TXOBJ_DIV_SEC, 0);
      query = "   SELECT nvl(sum(dl_leg.t_ReceiptAmount), 0) AS ReceiptAmount  " +
              "     FROM ddl_tick_dbt dl_tick, ddl_leg_dbt dl_leg " +
              "    WHERE     dl_tick.t_BofficeKind = " + DL_RETURN_DIVIDEND + " " +
              "          AND rsb_secur.IsDividendReturnRepo ( rsb_secur.get_OperationGroup ( rsb_secur.get_OperSysTypes (dl_tick.t_DealType, dl_tick.t_BofficeKind))) = 1 " +
              "          AND dl_leg.t_DealID = dl_tick.t_DealID " +
              "          AND dl_leg.t_LegKind = 0 " +
              "          AND dl_leg.t_LegID = 0 " +
              "          AND dl_tick.t_dealdate BETWEEN ? AND ? " +
              "          AND dl_tick.t_clientid = ? " ;

      cmd = DL_RSDCommand(query);

      cmd.addParam(date(1, i, rep.CurrYear));
      cmd.addParam(date(getDaysInMonth(date(1, i, rep.CurrYear)), i, rep.CurrYear));
      cmd.addParam(rep.ClientID);
      rs = cmd.Execute();
      rs.MoveNext();

      TaxCalculatedD[i] = Money(rs.ReceiptAmount) - GetNDRSum(i, TXOBJ_DIVPAY_SEC_0, 0);
      ZeroArr[i] = $0;
      TaxPaidD[i] = GetNDRSum(i, TXOBJ_DIVPAY_SEC, 0);
      i = i + 1;
    end;

    PrintLine("N1_DivSum",           0, "", DivSum);
    PrintLine("N1_CodePlusD",        0, "", DivSum);
    PrintLine("N1_TaxCalculatedD",   0, "", TaxCalculatedD);
    PrintLine("N1_TaxPaidD",         0, "", TaxPaidD);
    PrintLine("N1_TaxDueD",          0, "", ZeroArr);
    PrintLine("N1_TaxToReturnDueD",  0, "", ZeroArr);
    PrintLine("N1_TaxToReturnDueD",  0, "", TaxPaidD);
    PrintLine("N1_TaxToReturnDueD2", 0, "", ZeroArr);
  End;

  private macro R5 (Param)
    var i = 1, ZeroArr = TArray;
    var CodePlus35 = TArray;
    var Base_35 = TArray;
    var TaxCalculated35 = TArray;
    var TaxPaid35 = TArray;
    var TaxDue35 = TArray;
    var TaxToReturnDue35 = TArray;
    TaxCalculated35Sum = $0;
    TaxPaid35Sum = $0;
    TaxTransmitted35Sum = $0;
    TaxDue35Sum = $0;
    TaxToReturnDue35Sum = $0;
    
    PrintFormatString(NULL, "N1_R5");
    CopyAllSheetInTotalBook(sheet_name, false, "N1_R5", 0, sheet_name, true);

    while (i <= 12)
      ZeroArr[i] = $0;
      CodePlus35[i] = GetNDRSum(i, TXOBJ_PLUS35_3023, 0);
      Base_35[i] = GetNDRSum(i, TXOBJ_BASE_35, 0);
      TaxCalculated35[i] = Base_35[i] * 0.35 - GetNDRSum(i, TXOBJ_DIVPAY_SEC_0, 0);
      TaxCalculated35Sum = TaxCalculated35Sum + TaxCalculated35[i];
      TaxPaid35[i] = GetNDRSum(i, TXOBJ_PAID_35, 0);
      TaxPaid35Sum = TaxPaid35Sum + TaxPaid35[i];
      TaxTransmitted35Sum = TaxTransmitted35Sum + TaxPaid35[i];
      TaxDue35[i] = iif(TaxCalculated35[i] - TaxPaid35[i] > 0, TaxCalculated35[i] - TaxPaid35[i], $0);
      TaxDue35Sum = TaxDue35Sum + TaxDue35[i];
      TaxToReturnDue35[i] = iif(TaxCalculated35[i] - TaxPaid35[i] > 0, TaxCalculated35[i] - TaxPaid35[i], $0);
      TaxToReturnDue35Sum = TaxToReturnDue35Sum + TaxToReturnDue35[i];
      i = i + 1;
    end;

    PrintLine("N1_CodePlus35",        0, "", CodePlus35);
    PrintLine("N1_CodeMinus217",      0, "", ZeroArr);
    PrintLine("N1_Base35",            0, "", Base_35);
    PrintLine("N1_TaxCalculated35",   0, "", TaxCalculated35);
    PrintLine("N1_TaxPaid35",         0, "", TaxPaid35);
    PrintLine("N1_TaxDue35",          0, "", TaxDue35);
    PrintLine("N1_TaxToReturnDue35",  0, "", TaxToReturnDue35);
    PrintLine("N1_TaxToReturnDue35",  0, "", TaxPaid35);
    PrintLine("N1_TaxToReturnDue352", 0, "", ZeroArr);
  End;

  private macro R6_CodePlusMinus(number : @integer)
    PlusMinus(@number, true, "N1_CodePlusR", "Код дохода 1011 сумма дохода", TXOBJ_PLUSG_1011, 0, TXOBJ_PLUSG_1011_IIS);
    PlusMinus(@number, true, "N1_CodePlusR", "Код дохода 1110 сумма дохода", TXOBJ_PlusG_1110, 0);
    PlusMinus(@number, true, "N1_CodePlusR", "Код дохода 1530 сумма дохода", TXOBJ_PlusG_1530, 0);
    PlusMinus(@number, true, "N1_CodePlusR", "Код дохода 1531 сумма дохода", TXOBJ_PlusG_1531, 0);
    PlusMinus(@number, true, "N1_CodePlusR", "Код дохода 1532 сумма дохода", TXOBJ_PlusG_1532, 0);
    PlusMinus(@number, true, "N1_CodePlusR", "Код дохода 1533 сумма дохода", TXOBJ_PlusG_1533, 0);
    PlusMinus(@number, true, "N1_CodePlusR", "Код дохода 1535 сумма дохода", TXOBJ_PlusG_1535, 0);
    PlusMinus(@number, true, "N1_CodePlusR", "Код дохода 1536 сумма дохода", TXOBJ_PlusG_1536, 0);
    PlusMinus(@number, true, "N1_CodePlusR", "Код дохода 1537 сумма дохода", TXOBJ_PlusG_1537, 0);
    PlusMinus(@number, true, "N1_CodePlusR", "Код дохода 1539 сумма дохода", TXOBJ_PlusG_1539, 0);
    PlusMinus(@number, true, "N1_CodePlusR", "Код дохода 1544 сумма дохода", TXOBJ_PlusG_1544, 0);
    PlusMinus(@number, true, "N1_CodePlusR", "Код дохода 1545 сумма дохода", TXOBJ_PlusG_1545, 0);
    PlusMinus(@number, true, "N1_CodePlusR", "Код дохода 1546 сумма дохода", TXOBJ_PlusG_1546, 0);
    PlusMinus(@number, true, "N1_CodePlusR", "Код дохода 1547 сумма дохода", TXOBJ_PlusG_1547, 0);
    PlusMinus(@number, true, "N1_CodePlusR", "Код дохода 1548 сумма дохода", TXOBJ_PlusG_1548, 0);
    PlusMinus(@number, true, "N1_CodePlusR", "Код дохода 1549 сумма дохода", TXOBJ_PlusG_1549, 0);
    PlusMinus(@number, true, "N1_CodePlusR", "Код дохода 1551 сумма дохода", TXOBJ_PlusG_1551, 0);
    PlusMinus(@number, true, "N1_CodePlusR", "Код дохода 1553 сумма дохода", TXOBJ_PlusG_1553, 0);
    PlusMinus(@number, true, "N1_CodePlusR", "Код дохода 2640 сумма дохода", TXOBJ_PlusG_2640, 0, TXOBJ_PlusG_2640_IIS);
    PlusMinus(@number, true, "N1_CodePlusR", "Код дохода 2641 сумма дохода", TXOBJ_PlusG_2641, 0, TXOBJ_PlusG_2641_IIS);
    PlusMinus(@number, true, "N1_CodePlusR", "Код дохода 2800 сумма дохода", TXOBJ_PlusG_2800, 0);
    if (rep.ResidenceStatus() == 2)
      PlusMinus(@number, true, "N1_CodePlusR", "Код 3023", TXOBJ_Plus35_3023, 0);
    end;
    
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 201.", TXOBJ_MinusG_201, 0);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 202.", TXOBJ_MinusG_202, 0);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 203.", TXOBJ_MinusG_203, 0);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 205.", TXOBJ_MinusG_205, 0);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 206.", TXOBJ_MinusG_206, 0);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 207.", TXOBJ_MinusG_207, 0);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 208.", TXOBJ_MinusG_208, 0);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 209.", TXOBJ_MinusG_209, 0);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 210.", TXOBJ_MinusG_210, 0);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 211.", TXOBJ_MinusG_211, 0);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 213.", TXOBJ_MinusG_213, 0);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 214.", TXOBJ_MinusG_214, 0, TXOBJ_MinusG_214_IIS);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 218.", TXOBJ_MinusG_218, 0, TXOBJ_MinusG_218_1);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 219.", TXOBJ_MinusG_219, 0, TXOBJ_MinusG_219_1);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 220.", TXOBJ_MinusG_220, 0);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 222.", TXOBJ_MinusG_222, 0);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 223.", TXOBJ_MinusG_223, 0);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 224.", TXOBJ_MinusG_224, 0);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 225.", TXOBJ_MinusG_225, 1);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 226.", TXOBJ_MinusG_226, 1);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 227.", TXOBJ_MinusG_227, 1);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 228.", TXOBJ_MinusG_228, 1);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 229.", TXOBJ_MinusG_229, 1);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 230.", TXOBJ_MinusG_230, 1);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 231.", TXOBJ_MinusG_231, 1);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 233.", TXOBJ_MinusG_233, 1);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 234.", TXOBJ_MinusG_234, 1);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 235.", TXOBJ_MinusG_235, 1);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 236.", TXOBJ_MinusG_236, 1);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 239.", TXOBJ_MinusG_239, 1);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 240.", TXOBJ_MinusG_240, 1);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 241.", TXOBJ_MinusG_241, 1);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 250.", TXOBJ_MinusG_250, 1);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 251.", TXOBJ_MinusG_251, 1);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 252.", TXOBJ_MinusG_252, 1);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 618.", TXOBJ_MinusG_618, 0);
    PlusMinus(@number, false, "N1_CodeMinusR", "Налоговые вычеты. Код 619.", TXOBJ_MinusG_619, 1);
  end;
  
  private macro R6 (Param)
    var i, number = 1, Positive = " obj.t_sum > 0 ", Negative = " obj.t_sum < 0 ";
    var BaseTotalR = TArray;
    var TaxCalculatedR = TArray;
    var TaxPaidR = TArray;
    var TaxDueR = TArray;
    var TaxToReturnDueR = TArray;
    var TaxTransmittedR = TArray;
    var TaxToReturnDueR2 = TArray;
    var CodeMinusR1itog = 0;
    var CodeMinusR2itog = 0;
    var CodeMinusR3itog = 0;
    var CodeMinusR4itog = 0;
    TaxCalculatedRSum = $0;
    TaxPaidRSum = $0;
    TaxTransmittedRSum = $0;
    TaxDueRSum = $0;
    TaxToReturnDueRSum = $0;

    if ((rep.ResidenceStatus() != 1) and (Rg == 0.3)) // Если инвестор является нерезидентом на дату и Rg = 30 %, то "RateS" = 9%, но Разделе 6 не заполняется
      rateS = 0.9;
    else
      // а) Если инвестор является резидентом на дату
      if (rep.ResidenceStatus() == 1) 
          rateS = 0.09;
          var CodePlusR = TArray;
          var CodeMinusR1 = TArray;
          var CodeMinusR2 = TArray;
          var CodeMinusR3 = TArray;
          var CodeMinusR4 = TArray;

          PrintFormatString(NULL, "N1_R6");
          PrintFormatString(NULL, "N1_R6_1", "Раздел 6. РАСЧЕТ НАЛОГА С ДОХОДОВ, ОБЛАГАЕМЫХ ПО СТАВКЕ " + Int(rateS * 100) + "%");
          CopyAllSheetInTotalBook(sheet_name, false, "N1_R6", 0, sheet_name, true);

          i = 1;
          while (i <= 12)
            CodePlusR[i] = GetNDRSum(i, TXOBJ_PLUS9_1110, 0) - GetNDRSum(i, TXOBJ_PLUS9_1110_IIS, 1);
            CodeMinusR1[i] = GetNDRSum(i, TXOBJ_MINUS9_218, 0);
            CodeMinusR2[i] = GetNDRSum(i, TXOBJ_MINUS9_219, 0);
            CodeMinusR3[i] = GetNDRSum(i, TXOBJ_MINUS9_233, 0);
            CodeMinusR4[i] = GetNDRSum(i, TXOBJ_MINUS9_234, 0);
            CodeMinusR1itog = CodeMinusR1itog + CodeMinusR1[i];
            CodeMinusR2itog = CodeMinusR2itog + CodeMinusR2[i];
            CodeMinusR3itog = CodeMinusR3itog + CodeMinusR3[i];
            CodeMinusR4itog = CodeMinusR4itog + CodeMinusR4[i];
            BaseTotalR[i] = CodePlusR[i] - CodeMinusR1[i] - CodeMinusR2[i] - CodeMinusR3[i] - CodeMinusR4[i];
            if (i != 1)
              BaseTotalR[i] = BaseTotalR[i] + BaseTotalR[i - 1];
            end;
            TaxCalculatedR[i] = (CodePlusR[i] - CodeMinusR1[i] - CodeMinusR2[i] - CodeMinusR3[i] - CodeMinusR4[i]) * rateS - GetNDRSum(i, TXOBJ_PAIDGENERAL_0, 0);
            TaxCalculatedRSum = TaxCalculatedRSum + TaxCalculatedR[i];
            TaxPaidR[i] = GetNDRSum(i, TXOBJ_PAIDSPECIAL, 0, Positive) + GetNDRSum(i, TXOBJ_PAIDSPECIAL_IIS, 1, Positive);
            TaxPaidRSum = TaxPaidRSum + TaxPaidR[i];
            i = i + 1;
          end;

          PrintLine("N1_CodePlusR",      @number, "Код дохода 1110 сумма дохода", CodePlusR);
          if( CodeMinusR1itog > 0 )
            PrintLine("N1_CodeMinusR",   @number, "Налоговые вычеты. Код 218.",   CodeMinusR1);
          end;
          if( CodeMinusR2itog > 0 )
            PrintLine("N1_CodeMinusR",   @number, "Налоговые вычеты. Код 219.",   CodeMinusR2);
          end;
          if( CodeMinusR3itog > 0 )
            PrintLine("N1_CodeMinusR",   @number, "Налоговые вычеты. Код 233.",   CodeMinusR3);
          end;
          if( CodeMinusR4itog > 0 )
            PrintLine("N1_CodeMinusR",   @number, "Налоговые вычеты. Код 234.",   CodeMinusR4);
          end;
          PrintLine("N1_BaseTotalR",     @number, "", BaseTotalR, true);
          PrintLine("N1_TaxCalculatedR", @number, "", TaxCalculatedR);
          PrintLine("N1_TaxPaidR",       @number, "", TaxPaidR);

      // б) Если инвестор является нерезидентом на дату <Т1> и Rg != 30 %
      elif ((rep.ResidenceStatus() != 1) and (Rg != 0.3)) 
          rateS = Rg;
          PrintFormatString(NULL, "N1_R6");
          PrintFormatString(NULL, "N1_R6_1", "Раздел 6. РАСЧЕТ НАЛОГА С ДОХОДОВ, ОБЛАГАЕМЫХ ПО СТАВКЕ " + Int(rateS * 100) + "%");
          CopyAllSheetInTotalBook(sheet_name, false, "N1_R6", 0, sheet_name, true);
          
          i = 1;
          while (i <= 12)
            plus[i] = 0;
            minus[i] = 0;
            i = i + 1;
          end;
          
          R6_CodePlusMinus(@number);

          i = 1;
          while (i <= 12)
            BaseTotalR[i] = plus[i] - minus[i] + iif(i == 1, 0, BaseTotalR[i-1]);
            TaxCalculatedR[i] = (plus[i] - minus[i]) * rateS - GetNDRSum(i, TXOBJ_PAIDGENERAL_0, 0);
            TaxCalculatedRSum = TaxCalculatedRSum + TaxCalculatedR[i];
            TaxPaidR[i] = GetNDRSum(i, TXOBJ_PAIDMATERIAL, 0, Positive) +
                          GetNDRSum(i, TXOBJ_PAIDMATERIAL_IIS, 1, Positive) +
                          GetNDRSum(i, TXOBJ_PAIDGENERAL, 0, Positive) +
                          GetNDRSum(i, TXOBJ_PAIDGENERAL_IIS, 1, Positive) +
                          GetNDRSum(i, TXOBJ_PAIDBILL, 0, Positive);
            TaxPaidRSum = TaxPaidRSum + TaxPaidR[i];
            i = i + 1;
          end;
          
          PrintLine("N1_BaseTotalR",     @number, "", BaseTotalR, true);
          PrintLine("N1_TaxCalculatedR", @number, "", TaxCalculatedR);
          PrintLine("N1_TaxPaidR",       @number, "", TaxPaidR);
      end;

      // Общее для а) и б)
      i = 1;
      while (i <= 12)
        TaxDueR[i] = iif(TaxCalculatedR[i] - TaxPaidR[i] > 0, TaxCalculatedR[i] - TaxPaidR[i], $0);
        TaxDueRSum = TaxDueRSum + TaxDueR[i];
        TaxToReturnDueR[i] = iif(TaxCalculatedR[i] - TaxPaidR[i] > 0, TaxCalculatedR[i] - TaxPaidR[i], $0);
        TaxToReturnDueRSum = TaxToReturnDueRSum + TaxToReturnDueR[i];
        TaxTransmittedR[i] = iif(TaxPaidR[i] - TaxToReturnDueR[i] > 0, TaxPaidR[i] - TaxToReturnDueR[i], $0);
        TaxTransmittedRSum = TaxTransmittedRSum + TaxTransmittedR[i];
        // Последний <TaxToReturnDueR>
        if (rep.ResidenceStatus() == 1)
          TaxToReturnDueR2[i] = GetNDRSum(i, TXOBJ_PAIDSPECIAL, 0, Negative) +  GetNDRSum(i, TXOBJ_PAIDSPECIAL_IIS, 1, Negative);
        elif ((rep.ResidenceStatus() != 1) and (Rg != 0.3))
          TaxToReturnDueR2[i] = GetNDRSum(i, TXOBJ_PAIDMATERIAL,     0, Negative) +
                                GetNDRSum(i, TXOBJ_PAIDMATERIAL_IIS, 1, Negative) +
                                GetNDRSum(i, TXOBJ_PAIDGENERAL,      0, Negative) +
                                GetNDRSum(i, TXOBJ_PAIDGENERAL_IIS,  1, Negative) +
                                GetNDRSum(i, TXOBJ_PAIDBILL,         0, Negative);
        end;
        i = i + 1;
      end;

      PrintLine("N1_TaxDueR",          @number, "", TaxDueR);
      PrintLine("N1_TaxToReturnDueR",  @number, "", TaxToReturnDueR);
      PrintLine("N1_TaxTransmittedR",  @number, "", TaxTransmittedR);
      PrintLine("N1_TaxToReturnDueR2", @number, "", TaxToReturnDueR2);
    end;
  End;

  private macro R7 (Param)
    PrintFormatString(NULL, "N1_R7");
    CopyAllSheetInTotalBook(sheet_name, false, "N1_R7", 0, sheet_name, true);
         
    var query, cmd, rs, cell;

    query = "   SELECT t_Client, t_Rate, t_Kind, t_Date, SUM (t_Sum) AS Sum, t_SumHold " +
            "     FROM (SELECT nptxobj.t_Client, " +
            "                  nptxobj.t_Sum, " +
            "                  nptxobj.t_Kind, " +
            "                  nptxobj.t_Date, " +
            "                  NVL(nptxpay.t_SumHold, 0) AS t_SumHold, " +
            "                  CASE " +
            "                     WHEN EXISTS " +
            "                             (SELECT 1 " +
            "                                FROM dparty_dbt party " +
            "                               WHERE     party.t_PartyID = nptxobj.t_Client " +
            "                                     AND party.t_NotResident = CHR (0)) " +
            "                     THEN " +
            "                        TO_CHAR (13) " +
            "                     ELSE " +
            "                        CASE " +
            "                           WHEN EXISTS " +
            "                                   (SELECT 1 " +
            "                                      FROM dnotetext_dbt notetext " +
            "                                     WHERE     notetext.t_ObjectType = 3 " +
            "                                           AND notetext.t_DocumentID = " +
            "                                                  LPAD (nptxobj.t_Client, " +
            "                                                        10, " +
            "                                                        '0') " +
            "                                           AND notetext.t_NoteKind = 77 " +
            "                                           AND nptxobj.t_Date BETWEEN notetext.t_Date " +
            "                                                                                 AND notetext.t_ValidToDate) " +
            "                           THEN " +
            "                              TO_CHAR (rsb_struct.getDouble ( " +
            "                                          rsi_rsb_kernel.GetNote ( " +
            "                                             3, " +
            "                                             LPAD ( " +
            "                                                nptxobj.t_Client,  " +
            "                                                10, " +
            "                                                '0'), " +
            "                                             77, " +
            "                                             nptxobj.t_Date))) " +
            "                           ELSE " +
            "                              TO_CHAR (30) " +
            "                        END  " +
            "                  END " +
            "                     AS t_Rate " +
            "             FROM dnptxobj_dbt nptxobj LEFT JOIN dnptxpayobj_dbt payobj ON payobj.t_objid = nptxobj.t_objid " +
            "                                       LEFT JOIN dnptxpay_dbt nptxpay ON payobj.t_nptxpayid = nptxpay.t_id) " +
            " GROUP BY (t_Client, t_Rate, t_Kind, t_Date, t_SumHold) " +
            "   HAVING t_Client = ? AND t_Kind = ? AND t_Date BETWEEN ? AND ?" + 
            " ORDER BY t_Rate";
    cmd = DL_RSDCommand(query);
    cmd.addParam(rep.ClientID);
    cmd.addParam(TXOBJ_DIVPAY_SEC);
    cmd.addParam(date(1,1,rep.CurrYear) - 1);
    cmd.addParam(date(31,12,rep.CurrYear));
    rs = cmd.Execute();

    TotalPercentSum.size = 0;
    AddPercentSumToArray(13, 
                         iif(rep.ResidenceStatus() == 1, TaxCalculatedSum, $0),
                         iif(rep.ResidenceStatus() == 1, TaxPaidSum, $0),
                         iif(rep.ResidenceStatus() == 1, TaxTransmittedSum, $0),
                         iif(rep.ResidenceStatus() == 1, TaxDueSum, $0),
                         iif(rep.ResidenceStatus() == 1, TaxToReturnDueSum, $0));

    AddPercentSumToArray(30, 
                         iif(rep.ResidenceStatus() != 1, TaxCalculatedSum, $0),
                         iif(rep.ResidenceStatus() != 1, TaxPaidSum, $0),
                         iif(rep.ResidenceStatus() != 1, TaxTransmittedSum, $0),
                         iif(rep.ResidenceStatus() != 1, TaxDueSum, $0),
                         iif(rep.ResidenceStatus() != 1, TaxToReturnDueSum, $0));

    AddPercentSumToArray(35, 
                         TaxCalculated35Sum,
                         TaxPaid35Sum,
                         TaxTransmitted35Sum,
                         TaxDue35Sum,
                         TaxToReturnDue35Sum);

    AddPercentSumToArray(rateS * 100, 
                         TaxCalculatedRSum,
                         TaxPaidRSum,
                         TaxTransmittedRSum,
                         TaxDueRSum,
                         TaxToReturnDueRSum);

    while (rs.MoveNext())
      if (rs.Rate == 13)
        TotalPercentSum[0].TaxCalculatedSum = TotalPercentSum[0].TaxCalculatedSum + rs.Sum;
        TotalPercentSum[0].TaxPaidSum = TotalPercentSum[0].TaxPaidSum  + rs.Sum;
        TotalPercentSum[0].TaxTransmittedSum = TotalPercentSum[0].TaxTransmittedSum + rs.SumHold;
      elif (rs.Rate == 30)
        TotalPercentSum[1].TaxCalculatedSum = TotalPercentSum[1].TaxCalculatedSum + rs.Sum;
        TotalPercentSum[1].TaxPaidSum = TotalPercentSum[1].TaxPaidSum + rs.Sum;
        TotalPercentSum[1].TaxTransmittedSum = TotalPercentSum[1].TaxTransmittedSum + rs.SumHold;
      elif (rs.Rate == 35)
        TotalPercentSum[2].TaxCalculatedSum = TotalPercentSum[2].TaxCalculatedSum + rs.Sum;
        TotalPercentSum[2].TaxPaidSum = TotalPercentSum[2].TaxPaidSum + rs.Sum;
        TotalPercentSum[2].TaxTransmittedSum = TotalPercentSum[2].TaxTransmittedSum + rs.SumHold;
      else
        AddPercentSumToArray(rs.Rate, 
                             rs.Sum,
                             rs.Sum,
                             rs.SumHold,
                             0,
                             0);
      end;
    end;
    TArray_QSort(TotalPercentSum, "Percent", 1);
    var i = 0;
    var TotalTaxCalculatedSum = $0;
    var TotalTaxPaidSum = $0;
    var TotalTaxTransmittedSum = $0;
    var TotalTaxDueSum = $0;
    var TotalTaxToReturnDueSum = $0;
    cell = "N1_R7_1";
    while (i < TotalPercentSum.size)
    PrintFormatString(NULL,
                       cell + "_0", "По ставке " + TotalPercentSum[i].Percent + "%",
                       cell + "_1", abs(TotalPercentSum[i].TaxCalculatedSum),
                       cell + "_2", abs(TotalPercentSum[i].TaxPaidSum),
                       cell + "_3", abs(TotalPercentSum[i].TaxTransmittedSum),
                       cell + "_4", abs(TotalPercentSum[i].TaxDueSum),
                       cell + "_5", abs(TotalPercentSum[i].TaxToReturnDueSum)
                );
     TotalTaxCalculatedSum  = TotalTaxCalculatedSum + TotalPercentSum[i].TaxCalculatedSum;
     TotalTaxPaidSum = TotalTaxPaidSum + TotalPercentSum[i].TaxPaidSum;
     TotalTaxTransmittedSum = TotalTaxTransmittedSum + TotalPercentSum[i].TaxTransmittedSum;
     TotalTaxDueSum = TotalTaxDueSum + TotalPercentSum[i].TaxDueSum;
     TotalTaxToReturnDueSum = TotalTaxToReturnDueSum + TotalPercentSum[i].TaxToReturnDueSum;
     CopyAllSheetInTotalBook(sheet_name, false, cell, 0, sheet_name, true);
     i = i + 1;
    end;

    cell = "N1_R7_2";
    PrintFormatString(NULL,
                       cell + "_1", abs(TotalTaxCalculatedSum),
                       cell + "_2", abs(TotalTaxPaidSum),
                       cell + "_3", abs(TotalTaxTransmittedSum),
                       cell + "_4", abs(TotalTaxDueSum),
                       cell + "_5", abs(TotalTaxToReturnDueSum)
                );
    CopyAllSheetInTotalBook(sheet_name, false, cell, 0, sheet_name, true);
  End;

  private macro R8 (Param)

  var m_Link = NPTXLink(date(1,1,rep.CurrYear), date(31,12,rep.CurrYear), 1);
  m_Link.Create();

  var query = "    SELECT NVL ( " +
              "          (SELECT NPTX6.T_DATE " +
              "             FROM dnptxpay_dbt NPTXPAY " +
              "                  INNER JOIN dnptxpayobj_dbt NPTXPAYOBJ " +
              "                     ON NPTXPAY.T_ID = NPTXPAYOBJ.T_NPTXPAYID " +
              "                  INNER JOIN dnptxobdc_dbt NPTXOBDC " +
              "                     ON NPTXOBDC.T_OBJID = NPTXPAYOBJ.T_OBJID " +
              "                  INNER JOIN dnptxop_dbt NPTXOP " +
              "                     ON NPTXOP.T_ID = NPTXOBDC.T_DOCID " +
              "                  INNER JOIN dnptx6lnk_tmp nptx6lnk " +
              "                     ON     NPTX6LNK.T_DOCID2 = NPTXOP.T_KIND_OPERATION " +
              "                        AND NPTX6LNK.T_DOCKIND2 = NPTXOP.T_DOCKIND " +
              "                  INNER JOIN dnptx6_tmp nptx6 " +
              "                     ON     NPTX6.T_DOCID = NPTX6LNK.T_DOCID1 " +
              "                        AND NPTX6.T_DOCKIND = NPTX6LNK.T_DOCKIND1), " +
              "          T_DATEHOLD) " +
              "          AS T_DATEFACT, " +
              "       T_DATEHOLD, " +
              "       T_DATEHOLD, " +
              "       T_DATEPAY, " +
              "       T_ORDERNUMBER " +
              "  FROM dnptxpay_dbt " +
              " WHERE     T_PARTYID = ? " +
              "       AND T_DATEPAY between ? and ? ";

    var cmd = DL_RSDCommand(query);
    
    cmd.addParam(rep.ClientID);
    cmd.addParam(date(1,1,rep.CurrYear) - 1);
    cmd.addParam(date(31,12,rep.CurrYear));
    var rs = cmd.Execute();
    var i = 0;
    while (rs.MoveNext())
      if (i == 0)
        PrintFormatString(NULL, "N1_R8");
        CopyAllSheetInTotalBook(sheet_name, false, "N1_R8", 0, sheet_name, true);
        i = 1;
      end;
      var cell = "N1_TaxPay";
      PrintFormatString(NULL,
                        cell + "_1", rs.DateHold,
                        cell + "_2", rs.DateHold,
                        cell + "_3", rs.DatePay,
                        cell + "_4", rs.OrderNumber);
      CopyAllSheetInTotalBook(sheet_name, false, cell, 0, sheet_name, true);
    end;
  End;

  private macro Sign (Param)
    PrintFormatString(NULL, "N1_Sign");
    CopyAllSheetInTotalBook(sheet_name, false, "N1_Sign", 0, sheet_name, true);
  End;
  
  private macro Create()
    var investor = form.GetFieldValue(PNFLD_REGNDFL_INVESTORCODE);
    var report_date = date(form.GetFieldValue(PNFLD_REGNDFL_ENDDATE));
    var start_number = form.GetFieldValue(PNFLD_REGNDFL_NUMBER);
    var count = 0, num_ready = 0;

    rep = RegNDFLRepCalc(report_date, investor);
    count = rep.Count();

    if (count > 0)
      SetActiveSheet(sheet_name);

      InitProgress(count, "Регистр НДФЛ", "Регистр НДФЛ");

      while (rep.Next())
        if (rep.CheckClient() == true)
          rep.ClearData();
          sheet_name = rep.GetCurrName();
          UseNewSheetInTotalBook();
          R1_2(start_number);
          start_number = start_number + 1;
          getTaxRates();
          if ((Rg == 0.13) or (Rg == 0.3))
            R3();
          end;
          R4();
          if (rep.ResidenceStatus() == 1)
            R5();
          end;
          R6();
          R7();
          R8();
          Sign();
        else
          count = count - 1;
        end;

        rep.m_count = rep.m_count + 1;
        UseProgress(num_ready = num_ready + 1);
      end;

      RemProgress();
    end;
    
    if (count <= 0)
      PrintFormatString(NULL, "A1",
                        "Нет данных, удовлетворяющих параметрам отчета", null);
      CopyAllSheetInTotalBook(NULL, false, "A1", 0);
    end;
  end;

  initDL_CReportTemplate(NULL, "Report_RegNDFL.xls");
end;

while (form.Run())
  RegNDFL_Report().Run();
end;

exit(1);
