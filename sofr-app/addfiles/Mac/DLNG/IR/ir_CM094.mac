/*
    $Name: ir_CM094.mac
    $Module:   Репозитарий
    $Description:  Отчет о расчете справедливой (оценочной) стоимости 
*/

import "ir_CMBase.mac";

/*DAN*/
private macro set_conract_ir(DocKind, DocID, ContractIR)
  var sql,cmd,rs;
  if(ContractIR!="")
    sql = "UPDATE ddl_repozdeal_dbt " +
          "   SET t_contract_ir = ? " +
          " WHERE     t_dockind = ? " +
          "       AND t_docid = ? " ;
    cmd = RSDCommand(sql);
    cmd.addparam("",rsdbp_in,ContractIR);
    cmd.addparam("",rsdbp_in,DocKind);
    cmd.addparam("",rsdbp_in,DocID);
    cmd.execute;
  end;
end;
/*DAN*/

private MACRO AD_Scroll( Select:STRING, Header:STRING, X:INTEGER, Y:INTEGER /*...*/):RsdRecordset

  var rs     = RsdRecordset( Select, null, RSDVAL_STATIC ),
      Column = TArray(),
      i, ColumnValue, ColumnName, ColumnWidth, NumColumns = 0;

  macro EvProc( rs, cmd, id, key )
    if( (cmd == DLG_KEY) and (key == KEY_ENTER) )
       return CM_SELECT;
    end;
    return CM_DEFAULT;
  end;
  
  /* атрибуты полей */
  macro AddColumn( ar,ind, fld, head, Width )
     ar.value( ind * 6 + 0 ) = fld;  // fieldName
     ar.value( ind * 6 + 1 ) = head; // header 
     ar.value( ind * 6 + 2 ) = Width; // width
     ar.value( ind * 6 + 3 ) = 2;    // fldType (2 = FBT)
     ar.value( ind * 6 + 4 ) = null; // decPoint
     ar.value( ind * 6 + 5 ) = 0;    // reserv
     NumColumns = NumColumns + 1;
  end;
 
  i = 4;
  while( GetParm(i, ColumnValue ) AND GetParm(i+1, ColumnName) AND GetParm(i+2, ColumnWidth) )              
     AddColumn( Column, NumColumns, ColumnValue, ColumnName, ColumnWidth );
     i = i + 3;
  end;   

  if( rs.moveNext() )
    if( RunScroll( rs, NumColumns, Column, null, @EvProc, Header, "Esc Выход F4 Поиск Enter Выбор", true, X, Y, null, 80 ) )
       return rs;
    end;
  end;

  return null;
END;

PRIVATE macro FillTradeID(DealID)
var s_sql;
var Choise;

var dl_sql = "SELECT dvn.t_code, " +
             "       dvn.t_contractor, " +
             "       p.t_shortname " +
             " FROM  ddvndeal_dbt dvn, dparty_dbt p " +
             " WHERE   " +
             "       dvn.t_id = "+DealID+" " +
             "       and p.t_partyid = dvn.t_contractor " ;


var dl_cmd = rsdcommand(dl_sql);
var dl_rs = RSDRecordset(dl_cmd, rsdval_client, rsdval_static);

while (dl_rs.movenext())
   s_sql = "select * from registered_trade where NUMBER_TRADE_SYDE1 = '"+ substr(dl_rs.value("t_code"), 5) 
          +"' or NUMBER_TRADE_SYDE2 = '" +substr(dl_rs.value("t_code"), 5) + "'";                                                                  
   
   Choise = AD_Scroll(s_sql,"Выберите соответствующую сделку из списка зарегистрированных: " + dl_rs.value("t_code") + "  " + dl_rs.value("t_shortname"), 0, 1,
                                   "DATE1", "DATE1", 10,
                                   "NUMBER_TRADE_SYDE1", "N1", 10,
                                   "NUMBER_TRADE_SYDE2", "N2", 10,
                                   "REPOZNUMBER_TRADE", "REPOZ_NUM", 20,
                                   "SYDE1", "SYDE1", 30,
                                   "SYDE2", "SYDE2", 30);

end;
  if(valtype(choise) == v_undef)
    GetString(Choise,"Введите репозит. номер сделки " + dl_rs.value("t_code") + "  " + dl_rs.value("t_shortname") + " вручную:");
     if(valtype(choise) == v_undef)
       Choise="############################";
     end;
  else 
    choise = choise.value("REPOZNUMBER_TRADE");
  end;

   if((choise != "") and (choise != "############################") and  ( MsgBoxEx("Вы хотите записать репозитарный номер " + choise + " |так же на сделку " + dl_rs.value("t_code") + "?", MB_YES + MB_NO, IND_YES) == IND_YES ))  
       set_conract_ir(199, DealID, choise); 
   end;
return choise;

end;



PRIVATE CLASS grDocAccCompositing
    var id, dealid,DocKind,grdealid;
end;

class (CMBase) CM094 ( _isRecon, _conveyerID, _ir_op : object)
  InitCMBase();

  var m_cm094grDocAccComp = TArray();
  var m_CounterParty = TArray(); /*массив субъектов контагентов*/
  var m_trades094Arr = TArray(); 
  m_isRecon     = _isRecon;
  m_conveyerID  = _conveyerID;
  m_ir_op       = _ir_op;
  m_MessageID   = REPOS_CM094;

  macro addCM94(cm, GrDealID)
    arrsize = m_cmArr.size();
    var i = 0, j = 0, k = 0;
    var flagAddCM = true, flagAddgrDAC = true;
    var cm094tmp = TRecHandler("ir_cm094.dbt");
    var GDACsize = m_cm094grDocAccComp.size();
    while(j < cm.size())
        cm094tmp.clear();
        copy( cm094tmp, cm[j]);
        i = 0;
        flagAddCM = true;
        while(i < arrsize)
            if( cm094tmp.rec.valuationDate == m_cmArr[i].rec.valuationDate)
                flagAddCM = false;
                while(k < m_cm094grDocAccComp.size())
                    if((m_cm094grDocAccComp[k].dealid == m_ir_op.rec.ID) and
                        (m_cm094grDocAccComp[k].DocKind == m_ir_op.rec.DocKind) and 
                        (m_cm094grDocAccComp[k].grdealid == GrDealID)  
                        )
                        flagAddgrDAC = false;
                    end;
                    k = k + 1;
                end;
                if(flagAddgrDAC)
                    m_cm094grDocAccComp[GDACsize] = grDocAccCompositing;
                    m_cm094grDocAccComp[GDACsize].id = i;
                    m_cm094grDocAccComp[GDACsize].dealid = m_ir_op.rec.ID;
                    m_cm094grDocAccComp[GDACsize].DocKind = m_ir_op.rec.DocKind;
                    m_cm094grDocAccComp[GDACsize].grdealid = GrDealID;
                    GDACsize = m_cm094grDocAccComp.size();
                end;
            end;
            i = i + 1;
        end;
        if(flagAddCM)
            m_cmArr[arrsize] = TRecHandler("ir_cm094.dbt");
            copy(m_cmArr[arrsize], cm094tmp);
            m_cm094grDocAccComp[GDACsize] = grDocAccCompositing;
            m_cm094grDocAccComp[GDACsize].id = arrsize;
            m_cm094grDocAccComp[GDACsize].dealid = m_ir_op.rec.ID;
            m_cm094grDocAccComp[GDACsize].DocKind = m_ir_op.rec.DocKind;
            m_cm094grDocAccComp[GDACsize].grdealid = GrDealID;
            GDACsize = m_cm094grDocAccComp.size();
            arrsize = m_cmArr.size();
        end;
        j = j + 1;
    end;
  end;

  macro addCMAll(ir_generalinf:TRecHandler,
                 TradeRepository:TRecHandler,
                 Party1:TRecHandler,
                 Party2:TRecHandler,
                 Sender:TRecHandler,
                 cm:TArray,
                 Trades:TRecHandler,
                 GrDealID:integer, 
                 TemplNum:integer,
                 DealParmForReport:variant)
    arrsize = m_GeneralInfArr.size;
    if( arrsize == 0 ) // для сводного для всей пачки один generalinf   ///// тут определяется настройкой (одна сообщение в СРС или несколько )
        m_GeneralInfArr[arrsize] = TRecHandler("ir_generalinf.dbt");
        copy(m_GeneralInfArr[arrsize], ir_generalinf);
        m_RepActionArr[arrsize] = GetReportAction( TemplNum );
        
        addRepAccGrDoc(GrDealID);
        
        arrsize = m_PartyArr.size;
        m_PartyArr[arrsize] = TRecHandler("ir_party.dbt");
        TradeRepository.rec.PartyType = "TradeRepository";
        copy(m_PartyArr[arrsize], TradeRepository);
        
        arrsize = m_PartyArr.size;
        m_PartyArr[arrsize] = TRecHandler("ir_party.dbt");
        Party1.rec.PartyType= "Party1";
        copy(m_PartyArr[arrsize], Party1);
        
        arrsize = m_PartyArr.size;
        m_PartyArr[arrsize] = TRecHandler("ir_party.dbt");
        Party2.rec.PartyType= "Party2";
        copy(m_PartyArr[arrsize], Party2);
        
        arrsize = m_PartyArr.size;
        m_PartyArr[arrsize] = TRecHandler("ir_party.dbt");
        Sender.rec.PartyType= "Sender";
        copy(m_PartyArr[arrsize], Sender);
    else
        if (ir_generalinf.rec.RStatus == 2) //На случай если по текущему последующему ошибка, то поправим статус в сводном
          if (m_GeneralInfArr.size > 0)
            m_GeneralInfArr[0].rec.RStatus = ir_generalinf.rec.RStatus;
            m_GeneralInfArr[0].rec.RStatusName = ir_generalinf.rec.RStatusName;
          end;
        end;
    end;

    arrsize = m_trades094Arr.size;
    m_trades094Arr[arrsize] = TRecHandler("ir_trades.dbt");
    copy(m_trades094Arr[arrsize], Trades);
    addCM94(cm, GrDealID);
    addcmGrDoc(GrDealID);
    
    m_RepDealParmArr[m_RepDealParmArr.size] = DealParmForReport;
  end;

  macro insertAll
    var ir_generalinfCache094 = RsbSQLInsert("ir_generalinf.dbt");
    var ir_cm094Cache = RsbSQLInsert("ir_cm094.dbt");
    var ir_trades094Cache = RsbSQLInsert("ir_trades.dbt");
    var m_ReconMsgID = 0;
    var realIDs = TArray();
    var err = 0;
    var i = 0;
    /* Вставляем СРС 094 и обновляем привязки к строке графика */
    ir_generalinfCache094.AddRecordArray(m_GeneralInfArr);
    ir_generalinfCache094.AddReturning("t_InternalMessageID", V_INTEGER);
    
    if( not ir_generalinfCache094.insert() )
        err = 1;
        RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(m_RepDealParmArr[arrsize].DealID, m_RepDealParmArr[arrsize].DealKind, "", "", "Ошибка при сохранении данных сообщения", "", 0);
    else
        ir_generalinfCache094.GetReturning(realIDs);
        i = 0;
        while( i < m_GeneralInfArr.size ) 
            m_GeneralInfArr[i].rec.InternalMessageID = realIDs[i];
            m_RepAccGrDocArr[i].rec.DocID = realIDs[i];
            
            m_PartyArr[i*4].rec.InternalMessageID   = realIDs[i];  ///////// 4??
            m_PartyArr[i*4+1].rec.InternalMessageID = realIDs[i];
            m_PartyArr[i*4+2].rec.InternalMessageID = realIDs[i];
            m_PartyArr[i*4+3].rec.InternalMessageID = realIDs[i];
            
            var l_094 = 0;
            while( l_094 < m_cmArr.size )
                m_cmArr[l_094].rec.InternalMessageID = realIDs[i];
                l_094 = l_094 + 1;
            end;
            
            l_094 = 0;
            while( l_094 < m_trades094Arr.size )
                m_trades094Arr[l_094].rec.InternalMessageID = realIDs[i];
                l_094 = l_094 + 1;
            end;
            
            m_ReconMsgID = realIDs[i];
            
            /* добавить запись в лог о вставке СРС */
            if ( not m_isRecon )
                m_RepDataArr[m_RepDataArr.size] = CIR_RepAccRepParm(
                        m_RepActionArr[i],
                        m_GeneralInfArr[i].rec.DealCode,
                        m_GeneralInfArr[i].rec.MessageType,
                        DL_GetNameAlg(ALG_GENINF_RSTATUS, m_GeneralInfArr[i].rec.RStatus),
                        m_RepDealParmArr[i].DealID, 
                        m_RepDealParmArr[i].DealKind);
            end;
            i = i + 1;
        end;
    end;

    if( (not err) and (m_cmArr.size > 0) )
        /* Вставляем cm094 */
        ir_cm094Cache.AddRecordArray(m_cmArr);
        ir_cm094Cache.AddReturning("t_id", V_INTEGER);
       
        if( not ir_cm094Cache.insert() )
            err = 1;
            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(m_RepDealParmArr.DealID, m_RepDealParmArr.DealKind, "", "", "Ошибка при сохранении данных экономических параметров", "", 0);
        else
            realIDs.size = 0;
            ir_cm094Cache.GetReturning(realIDs);
            i = 0;
            var delta094 =  m_cmGrDocArr.size;
            var numCM094 = 0;
            var iterator = 0;
            var find = false;

            while( i < delta094 )
                find = false;
                while( (iterator < m_cm094grDocAccComp.size()) and not find)
                    if((m_cm094grDocAccComp[iterator].DealID == m_cmGrDocArr[i].rec.ServDocID) and
                       (m_cm094grDocAccComp[iterator].DocKind == m_cmGrDocArr[i].rec.ServDocKind) and
                       (m_cm094grDocAccComp[iterator].GrDealID == m_cmGrDocArr[i].rec.GrDealID) )
                        find = true;
                        numCM094 = m_cm094grDocAccComp[iterator].id;
                    end;
                    iterator = iterator + 1;
                end;
                m_cmGrDocArr[i].rec.DocID = realIDs[numCM094];
                ////// вставка   REPOS_GENERALINF для 094(для стороки графика)
                m_cmGrDocArr[i+delta094] = TRecHandler("dlgrdoc.dbt");
                m_cmGrDocArr[i+delta094].Clear();
                m_cmGrDocArr[i+delta094].rec.GrDealID    = m_cmGrDocArr[i].rec.GrDealID;
                m_cmGrDocArr[i+delta094].rec.DocKind     = REPOS_GENERALINF;//вставить константу     ?4858
                m_cmGrDocArr[i+delta094].rec.ServDocKind = m_cmGrDocArr[i].rec.ServDocKind;
                m_cmGrDocArr[i+delta094].rec.ServDocID   = m_cmGrDocArr[i].rec.ServDocID;
                m_cmGrDocArr[i+delta094].rec.DocID       = m_GeneralInfArr[0].rec.InternalMessageID;
                i = i + 1;
            end;
        end;
    end;

    if( (not err) and (m_trades094Arr.size > 0) )
        /* Вставляем cm094 */
        ir_trades094Cache.AddRecordArray(m_trades094Arr);
        ir_trades094Cache.AddReturning("t_id", V_INTEGER);
       
        if( not ir_trades094Cache.insert() )
            err = 1;
            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(m_RepDealParmArr.DealID, m_RepDealParmArr.DealKind,"", "", "Ошибка при сохранении данных экономических параметров", "", 0);
        end;
    end;

    // Вставляем субъектов
    insertParty;

    // Вставляем привязки
    insertDlgrdocCache;
    return err;

  end;

  macro ЗаполнениеCM (ir_op,
                      m_cm094ArrTmp:TArray,
                      TradesTmp:@TrecHandler,
                      DataSet,
                      GenAgr,
                      first,
                      error,
                      field,
                      FD,
                      ir_generalinf:@TrecHandler,
                      i,
                      DealParmForReport)
    var stat = 0;
    var query;
    var siseCM094, sizeTrades;
    if(GenAgr.SendeRside == SENDERFRVL_BOTH_SIDES)
        ir_generalinf.rec.reportParty = "all"   
    elif(GenAgr.Side1 == 1) //наш банк
        ir_generalinf.rec.reportParty = "Party1"   
    else
        ir_generalinf.rec.reportParty = "Party2"   
    end;

    query = " select t_XMLProduct, t_XMLName as t_XMLType, t_Bulk_Report from dir_typesmessage_dbt ";
    query = query + " where t_Messagecode = 'CM094' ";
    var cmd = DL_RSDCommand();
    var data = cmd.Execute(query);
    if(data.moveNext());
        ir_generalinf.rec.XMLProduct = data.XMLProduct;
        ir_generalinf.rec.XMLType    = data.XMLType;
        ir_generalinf.rec.Bulk       = data.Bulk_Report;
        ir_generalinf.rec.DealCode   = "";
    else
        stat = 1;
        RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не найдены параметры сообщения", "CM094", GetReportAction(ir_generalinf.rec.MessageID));
    end;
/*DAN*/
query =         " select fr1.t_fairvalue as Amount1,                                                                         ";
query = query + "        fr1.t_date      dateRevFR1,                                                                         ";
query = query + "        t3.t_fairvalue  Amount,                                                                             ";
query = query + "        t3.t_date       dateRevFR                                                                           ";
query = query + "   from ddvnfrval_dbt fr1,                                                                                  ";
query = query + "        ddlgracc_dbt gracc,                                                                                 ";
query = query + "        ddlgrdeal_dbt gr,                                                                                   ";
query = query + "        (select t1.t_fairvalue, t1.t_date, t1.t_dealid                                                      ";
query = query + "           from (select *                                                                                   ";
query = query + "                   from ddvnfrval_dbt t2                                                                    ";
query = query + "                  where t2.t_dealid = " + DealParmForReport.DealID;
query = query + "                    AND TRUNC(t2.t_date, 'Month') =                                                         ";
query = query + "                        TRUNC(" + GetSQLDate(date(ir_generalinf.rec.asofdate)) + ", 'Month') ";
query = query + "                  order by t2.t_date desc) t1     						             ";
query = query + "          where rownum <= 1) t3                        						     ";
query = query + "  where t3.t_dealid = " + DealParmForReport.DealID;      
query = query + "    and fr1.t_id in                                                                                         ";
query = query + "        (select max(fr.t_id)                                                                                ";
query = query + "           FROM ddvnfrval_dbt fr, doproper_dbt opr, doprstep_dbt oprstep                                    ";
query = query + "          WHERE fr.t_date =                                                                                 ";
query = query + "                (SELECT CASE                                                                                ";
query = query + "                          WHEN (oprstep.t_servdockind = 0 AND                                               ";
query = query + "                               oprstep.t_servdocid = 0) THEN                                                ";
query = query + "                           (fr.t_date)                                                                      ";
query = query + "                          ELSE                                                                              ";
query = query + "                           (SELECT dl_com.t_commdate                                                        ";
query = query + "                              FROM DDL_COMM_DBT dl_com                                                      ";
query = query + "                             WHERE oprstep.t_servdockind = dl_com.t_dockind                                 ";
query = query + "                               AND oprstep.t_servdocid = dl_com.t_Documentid)                               ";
query = query + "                        END                                                                                 ";
query = query + "                   FROM DUAL)                                                                               ";
query = query + "            AND fr.t_dockind = opr.t_DocKind                                                                ";
query = query + "            AND fr.t_dealid = TO_NUMBER(opr.t_documentid)                                                   ";
query = query + "            AND oprstep.t_ID_Operation = opr.t_ID_Operation)                                                ";
query = query + "    and gracc.t_grdealid = gr.t_id                                                                          ";
query = query + "    and gracc.t_accnum = " + DLGR_ACCKIND_REPOSITORY;
query = query + "    and gracc.t_state = " + DLGRACC_STATE_PLAN;
query = query + "    and gr.t_id = " + DataSet.GrDealID ;


//    query = " select fr1.t_fairvalue as Amount1, fr1.t_date dateRevFR, ";
//    query = query + " (select t1.t_fairvalue from   ";
//    query = query + " (select t2.t_fairvalue from ddvnfrval_dbt t2  where t2.t_dealid = " + DealParmForReport.DealID;
//   query = query + " AND TRUNC(t2.t_date, 'Month' ) = TRUNC(" + GetSQLDate(date(ir_generalinf.rec.asofdate)) + ", 'Month')";
//    query = query + " order by t2.t_date desc) t1 where rownum <=1) Amount";
//    query = query + " from ddvnfrval_dbt fr1, ddlgracc_dbt gracc, ddlgrdeal_dbt gr  ";
//    query = query + " where fr1.t_id in (select max(fr.t_id)  ";
//    query = query + " FROM ddvnfrval_dbt fr, doproper_dbt opr, doprstep_dbt oprstep ";
//    query = query + " WHERE fr.t_date = ";
//    query = query + "   (SELECT ";
//    query = query + "     CASE ";
//    query = query + "       WHEN ( oprstep.t_servdockind = 0 ";
//    query = query + "       AND oprstep.t_servdocid      = 0) ";
//   //  query = query + "       THEN (oprstep.t_Plan_Date) ";
//    query = query + "       THEN (fr.t_date) ";
//    query = query + "       ELSE ";
//   query = query + "         (SELECT dl_com.t_commdate ";
//    query = query + "         FROM DDL_COMM_DBT dl_com ";
//    query = query + "         WHERE oprstep.t_servdockind = dl_com.t_dockind ";
//    query = query + "         AND oprstep.t_servdocid     = dl_com.t_Documentid ";
//    query = query + "         ) ";
//    query = query + "     END ";
//    query = query + "   FROM DUAL ) ";
//    query = query + " AND fr.t_dockind           = opr.t_DocKind ";
//    query = query + " AND fr.t_dealid            = TO_NUMBER (opr.t_documentid) ";
//  //    query = query + " AND oprstep.t_id_operation = gracc.t_id_operation ";
//  //    query = query + " AND oprstep.t_id_step      = gracc.t_id_step ";
//    query = query + " AND oprstep.t_ID_Operation = opr.t_ID_Operation) "; 
//    query = query + " and gracc.t_grdealid = gr.t_id ";
//            query = query + " and gracc.t_accnum = " + DLGR_ACCKIND_REPOSITORY;
//            query = query + " and gracc.t_state = " + DLGRACC_STATE_PLAN;
//    query = query + " and gr.t_id = " + DataSet.GrDealID;

        cmd = DL_RSDCommand();
        data = cmd.Execute(query);
    if(data.MoveNext())
            siseCM094 = m_cm094ArrTmp.size();
            m_cm094ArrTmp[siseCM094] = TRecHandler("ir_cm094.dbt");
            m_cm094ArrTmp[siseCM094].clear();
            m_cm094ArrTmp[siseCM094].rec.valuationMethod   = "M";
            m_cm094ArrTmp[siseCM094].rec.valuationDate     = data.dateRevFR;
            
        TradesTmp = TRecHandler("ir_trades.dbt");
        TradesTmp.clear();
        TradesTmp.rec.valuationDate = data.dateRevFR;
        if((DataSet.DocKind == DL_SECURITYDOC) and (FD.tick.rec.ParentID != 0))
            var repozdeal = TBFile("dl_repozdeal.dbt", "R", 1);
            repozdeal.Clear();
            repozdeal.rec.DocID = FD.tick.rec.ParentID;
            var cmddv = DL_RSDCommand("SELECT t_DocKind FROM ddvndeal_dbt WHERE t_ID = ?");
            cmddv.AddParam( FD.tick.rec.ParentID );
            var DataSetDV = cmddv.Execute();
            if( DataSetDV.moveNext() )
                repozdeal.rec.DocKind = DataSetDV.DocKind;
            end;
            if(repozdeal.GetEQ())
                TradesTmp.rec.TradeId = repozdeal.rec.CONTRACT_IR;
            end;
        else
            if (DataSet.CONTRACT_IR !="")
              TradesTmp.rec.TradeId = DataSet.CONTRACT_IR;
            else 
              TradesTmp.rec.TradeId =FillTradeID(DataSet.DocID);// DataSet.CONTRACT_IR;
            end;
         end;
        if( TradesTmp.rec.TradeId == "" )
            stat = 1;
            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не задан код договора, присвоенный репозитарием", "TradeId", GetReportAction(DataSet.TemplNum));
        end;
        TradesTmp.rec.Amount      = data.Amount;
        TradesTmp.rec.Currency    = NATCUR;
        TradesTmp.rec.Code_Currency = GetFICode(NATCUR, null, FICK_ISOSTRING);
        TradesTmp.rec.DealID      = DataSet.DocID;
        TradesTmp.rec.BofficeKind = DataSet.DocKind;
        //TradesTmp.rec.TemplNum    = DataSet.GrDealID;
    end;

    return stat;
  end;
end;