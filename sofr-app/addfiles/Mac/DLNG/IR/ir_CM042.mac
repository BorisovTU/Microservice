/*
    $Name: ir_CM042.mac
    $Module:   Репозитарий
    $Description:  Анкета договора купли-продажи облигации
*/

import "ir_CMBase.mac";

class (CMBase) CM042 ( _isRecon, _conveyerID, _ir_op : object)
  InitCMBase();
  
  m_isRecon     = _isRecon;
  m_conveyerID  = _conveyerID;
  m_ir_op       = _ir_op;
  m_MessageID   = REPOS_CM042;

  macro addCMAll(ir_generalinf     ,
                 TradeRepository   ,
                 Party1            ,
                 Party2            ,
                 UTIGeneratingParty,
                 Sender            ,
                 cm                ,
                 Instruments       ,
                 GrDealID          ,
                 TemplNum          ,
                 DealParmForReport )
    addGenInf(ir_generalinf, TemplNum, DealParmForReport);
    addRepAccGrDoc(GrDealID);
    addcmGrDoc(GrDealID);
    addParty(TradeRepository, Party1, Party2, UTIGeneratingParty, Sender);
    addCM(cm);
    addInstrument(Instruments);
  end;

  macro insertAll
    var err = 0;
    err = insertGeneralinf;
    if (not err)
      err = insertParty;
    end;
    if (not err)
      err = insertDlgrdocCache;
    end;
    if (not err)
      err = insertCM;
    end;
    if (not err)
      err = insertInstrument;
    end;
    return err;
  end;

  macro ЗаполнениеCM (cm : @TrecHandler, 
                      DataSet, 
                      GenAgr,
                      FD,
                      first,
                      field,
                      Instruments : @TrecHandler, 
                      DealParmForReport)
    var erFlag : bool = false;
    var bondFaceValue;
    var stat=0;
    var AvoirRec = TRecHandler("avoiriss.dbt");/*DAN */
    var FininstRec = TRecHandler("fininstr.dbt");/*DAN */ 

    //Instruments.clear();
    if( (IsBUY(FD.Group) and (GenAgr.Side1 == 1)) or
        (IsSALE(FD.Group) and (GenAgr.Side1 == 2))
        )
        cm.rec.buyerid  = IR_PARTY_KIND_PARTY1;
        cm.rec.buyer    = "Party1";
        cm.rec.sellerid = IR_PARTY_KIND_PARTY2;
        cm.rec.seller   = "Party2";
    else
        cm.rec.buyerid  = IR_PARTY_KIND_PARTY2;
        cm.rec.buyer    = "Party2";
        cm.rec.sellerid = IR_PARTY_KIND_PARTY1;
        cm.rec.seller   = "Party1";
    end;
 
    bondFaceValue = GetFaceValue(FD.fininstr.rec.FIID, FD.tick.rec.DealDate);

    cm.rec.nominalCurrencyID = FD.fininstr.rec.FaceValueFI;
    cm.rec.nominalCurrency   = GetFICode(cm.rec.nominalCurrencyID , null, FICK_ISOSTRING);
    if(not bondFaceValue)
        RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, m_MessageType, "Не задано значение номинала для индексируемой облигации на дату заключения сделки", "CollatNomAmount", GetReportAction(DataSet.TemplNum), 400 + 31);
        stat=1;
    else
        cm.rec.nominalAmount = bondFaceValue * FD.dl_leg.rec.Principal;
        cm.rec.cleanPrice = (GetRateOnDate(FD.tick.rec.DealDate, FD.fininstr.rec.FIID, FD.fininstr.rec.FaceValueFI, false, ВИД_КУРСА_ЧИСТАЯ_ЦЕНА_ОБЛИГАЦИИ(), erFlag) / bondFaceValue) * 100;
        end;
     if( erFlag == true )
         RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, m_MessageType, "Не задано значение курса вида \"" + IR_GetRateTypeName(ВИД_КУРСА_ЧИСТАЯ_ЦЕНА_ОБЛИГАЦИИ()) + "\" на дату " + date_as_string(1, FD.tick.rec.DealDate) + " для определения чистой цены облигации", "CollatNomAmount", GetReportAction(DataSet.TemplNum), 400 + 33);
         stat=1;
     end;

    cm.rec.numberofunits = FD.dl_leg.rec.Principal;

     cm.rec.accruals = (НКД(FD.fininstr.rec.FIID, 1, FD.tick.rec.DealDate) / FD.fininstr.rec.FaceValue) * 100;
     cm.rec.dirtyPrice = cm.rec.cleanPrice + cm.rec.accruals;

    if( FD.dl_leg.rec.Formula == SP_TYPE_CALC_DVP )
        cm.rec.deliverymethodid = 1; // DeliveryVersusPayment
        cm.rec.deliverymethod = DL_GetNameAlg(ALG_GENINF_SETTLMETHOD, 1);
    else
        cm.rec.deliverymethodid = 2; // FreeOfPayment
        cm.rec.deliverymethod = DL_GetNameAlg(ALG_GENINF_SETTLMETHOD, 2);
    end;
    
    cm.rec.settlmentDate = GetDealPayPlanDate( FD.dl_leg.rec );
    cm.rec.deliveryDate = GetDealSetAvPlanDate( FD.dl_leg.rec );

    Instruments.rec.FIID   = FD.fininstr.rec.FIID;
    Instruments.rec.InstrumentCode = GetAvoirissCode(FD.fininstr, m_ir_op.rec.Date);
    Instruments.rec.Instrumentname = FD.fininstr.rec.Name;

/*DAN */
    FininstRec.Clear();
    AvoirRec.Clear();
    ПолучитьФинИн(FD.fininstr.rec.FIID,FininstRec,AvoirRec);
    
   
//    Instruments.rec.InstrumentCode = FD.fininstr.rec.FI_Code;
    Instruments.rec.InstrumentCode = AvoirRec.rec.ISIN;
//    Instruments.rec.Instrumentname = FD.fininstr.rec.Name;
    Instruments.rec.Instrumentname = FininstRec.rec.Definition;
    if (Instruments.rec.Instrumentname == "")
       Instruments.rec.Instrumentname = FD.fininstr.rec.Name;
    end;
/*DAN*/
    return stat;
  end;
end;